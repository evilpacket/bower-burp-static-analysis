{
    "url": "http://localhost:9999/Schweigi/angular-gantt/demo/dist/scripts/vendor.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.name</b> and written to <b>the 'name' property of a DOM element</b> via the following statement:<ul><li>window.name = window.name.replace(NG_ENABLE_DEBUG_INFO, '');</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/Schweigi/angular-gantt/demo/dist/scripts/vendor.js",
                "path": "/Schweigi/angular-gantt/demo/dist/scripts/vendor.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9TY2h3ZWlnaS9hbmd1bGFyLWdhbnR0L2RlbW8vZGlzdC9zY3JpcHRzL3ZlbmRvci5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTQ2MjM4Mw0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vamF2YXNjcmlwdA0KRGF0ZTogVGh1LCAwNiBOb3YgMjAxNCAwNzo0NToxMSBHTVQNCkxhc3QtTW9kaWZpZWQ6IFRodSwgMDYgTm92IDIwMTQgMDc6NDU6MTAgR01UDQoNCi8qKgogKiBAbGljZW5zZSBBbmd1bGFySlMgdjEuMy4wCiAqIChjKSAyMDEwLTIwMTQgR29vZ2xlLCBJbmMuIGh0dHA6Ly9hbmd1bGFyanMub3JnCiAqIExpY2Vuc2U6IE1JVAogKi8KKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCkgeyd1c2Ugc3RyaWN0JzsKCi8qKgogKiBAZGVzY3JpcHRpb24KICoKICogVGhpcyBvYmplY3QgcHJvdmlkZXMgYSB1dGlsaXR5IGZvciBwcm9kdWNpbmcgcmljaCBFcnJvciBtZXNzYWdlcyB3aXRoaW4KICogQW5ndWxhci4gSXQgY2FuIGJlIGNhbGxlZCBhcyBmb2xsb3dzOgogKgogKiB2YXIgZXhhbXBsZU1pbkVyciA9IG1pbkVycignZXhhbXBsZScpOwogKiB0aHJvdyBleGFtcGxlTWluRXJyKCdvbmUnLCAnVGhpcyB7MH0gaXMgezF9JywgZm9vLCBiYXIpOwogKgogKiBUaGUgYWJvdmUgY3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBtaW5FcnIgaW4gdGhlIGV4YW1wbGUgbmFtZXNwYWNlLiBUaGUKICogcmVzdWx0aW5nIGVycm9yIHdpbGwgaGF2ZSBhIG5hbWVzcGFjZWQgZXJyb3IgY29kZSBvZiBleGFtcGxlLm9uZS4gIFRoZQogKiByZXN1bHRpbmcgZXJyb3Igd2lsbCByZXBsYWNlIHswfSB3aXRoIHRoZSB2YWx1ZSBvZiBmb28sIGFuZCB7MX0gd2l0aCB0aGUKICogdmFsdWUgb2YgYmFyLiBUaGUgb2JqZWN0IGlzIG5vdCByZXN0cmljdGVkIGluIHRoZSBudW1iZXIgb2YgYXJndW1lbnRzIGl0IGNhbgogKiB0YWtlLgogKgogKiBJZiBmZXdlciBhcmd1bWVudHMgYXJlIHNwZWNpZmllZCB0aGFuIG5lY2Vzc2FyeSBmb3IgaW50ZXJwb2xhdGlvbiwgdGhlIGV4dHJhCiAqIGludGVycG9sYXRpb24gbWFya2VycyB3aWxsIGJlIHByZXNlcnZlZCBpbiB0aGUgZmluYWwgc3RyaW5nLgogKgogKiBTaW5jZSBkYXRhIHdpbGwgYmUgcGFyc2VkIHN0YXRpY2FsbHkgZHVyaW5nIGEgYnVpbGQgc3RlcCwgc29tZSByZXN0cmljdGlvbnMKICogYXJlIGFwcGxpZWQgd2l0aCByZXNwZWN0IHRvIGhvdyBtaW5FcnIgaW5zdGFuY2VzIGFyZSBjcmVhdGVkIGFuZCBjYWxsZWQuCiAqIEluc3RhbmNlcyBzaG91bGQgaGF2ZSBuYW1lcyBvZiB0aGUgZm9ybSBuYW1lc3BhY2VNaW5FcnIgZm9yIGEgbWluRXJyIGNyZWF0ZWQKICogdXNpbmcgbWluRXJyKCduYW1lc3BhY2UnKSAuIEVycm9yIGNvZGVzLCBuYW1lc3BhY2VzIGFuZCB0ZW1wbGF0ZSBzdHJpbmdzCiAqIHNob3VsZCBhbGwgYmUgc3RhdGljIHN0cmluZ3MsIG5vdCB2YXJpYWJsZXMgb3IgZ2VuZXJhbCBleHByZXNzaW9ucy4KICoKICogQHBhcmFtIHtzdHJpbmd9IG1vZHVsZSBUaGUgbmFtZXNwYWNlIHRvIHVzZSBmb3IgdGhlIG5ldyBtaW5FcnIgaW5zdGFuY2UuCiAqIEBwYXJhbSB7ZnVuY3Rpb259IEVycm9yQ29uc3RydWN0b3IgQ3VzdG9tIGVycm9yIGNvbnN0cnVjdG9yIHRvIGJlIGluc3RhbnRpYXRlZCB3aGVuIHJldHVybmluZwogKiAgIGVycm9yIGZyb20gcmV0dXJuZWQgZnVuY3Rpb24sIGZvciBjYXNlcyB3aGVuIGEgcGFydGljdWxhciB0eXBlIG9mIGVycm9yIGlzIHVzZWZ1bC4KICogQHJldHVybnMge2Z1bmN0aW9uKGNvZGU6c3RyaW5nLCB0ZW1wbGF0ZTpzdHJpbmcsIC4uLnRlbXBsYXRlQXJncyk6IEVycm9yfSBtaW5FcnIgaW5zdGFuY2UKICovCgpmdW5jdGlvbiBtaW5FcnIobW9kdWxlLCBFcnJvckNvbnN0cnVjdG9yKSB7CiAgRXJyb3JDb25zdHJ1Y3RvciA9IEVycm9yQ29uc3RydWN0b3IgfHwgRXJyb3I7CiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb2RlID0gYXJndW1lbnRzWzBdLAogICAgICBwcmVmaXggPSAnWycgKyAobW9kdWxlID8gbW9kdWxlICsgJzonIDogJycpICsgY29kZSArICddICcsCiAgICAgIHRlbXBsYXRlID0gYXJndW1lbnRzWzFdLAogICAgICB0ZW1wbGF0ZUFyZ3MgPSBhcmd1bWVudHMsCiAgICAgIHN0cmluZ2lmeSA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgcmV0dXJuIG9iai50b1N0cmluZygpLnJlcGxhY2UoLyBce1tcc1xTXSokLywgJycpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iaiA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHJldHVybiAndW5kZWZpbmVkJzsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmogIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgICAgfSwKICAgICAgbWVzc2FnZSwgaTsKCiAgICBtZXNzYWdlID0gcHJlZml4ICsgdGVtcGxhdGUucmVwbGFjZSgvXHtcZCtcfS9nLCBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgdmFyIGluZGV4ID0gK21hdGNoLnNsaWNlKDEsIC0xKSwgYXJnOwoKICAgICAgaWYgKGluZGV4ICsgMiA8IHRlbXBsYXRlQXJncy5sZW5ndGgpIHsKICAgICAgICBhcmcgPSB0ZW1wbGF0ZUFyZ3NbaW5kZXggKyAyXTsKICAgICAgICBpZiAodHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgcmV0dXJuIGFyZy50b1N0cmluZygpLnJlcGxhY2UoLyA/XHtbXHNcU10qJC8sICcnKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmcgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICByZXR1cm4gJ3VuZGVmaW5lZCc7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJnICE9PSAnc3RyaW5nJykgewogICAgICAgICAgcmV0dXJuIHRvSnNvbihhcmcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnOwogICAgICB9CiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0pOwoKICAgIG1lc3NhZ2UgPSBtZXNzYWdlICsgJ1xuaHR0cDovL2Vycm9ycy5hbmd1bGFyanMub3JnLzEuMy4wLycgKwogICAgICAobW9kdWxlID8gbW9kdWxlICsgJy8nIDogJycpICsgY29kZTsKICAgIGZvciAoaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UgKyAoaSA9PSAyID8gJz8nIDogJyYnKSArICdwJyArIChpLTIpICsgJz0nICsKICAgICAgICBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5KGFyZ3VtZW50c1tpXSkpOwogICAgfQogICAgcmV0dXJuIG5ldyBFcnJvckNvbnN0cnVjdG9yKG1lc3NhZ2UpOwogIH07Cn0KCi8qIFdlIG5lZWQgdG8gdGVsbCBqc2hpbnQgd2hhdCB2YXJpYWJsZXMgYXJlIGJlaW5nIGV4cG9ydGVkICovCi8qIGdsb2JhbCBhbmd1bGFyOiB0cnVlLAogIG1zaWU6IHRydWUsCiAganFMaXRlOiB0cnVlLAogIGpRdWVyeTogdHJ1ZSwKICBzbGljZTogdHJ1ZSwKICBzcGxpY2U6IHRydWUsCiAgcHVzaDogdHJ1ZSwKICB0b1N0cmluZzogdHJ1ZSwKICBuZ01pbkVycjogdHJ1ZSwKICBhbmd1bGFyTW9kdWxlOiB0cnVlLAogIHVpZDogdHJ1ZSwKICBSRUdFWF9TVFJJTkdfUkVHRVhQOiB0cnVlLAogIFZBTElESVRZX1NUQVRFX1BST1BFUlRZOiB0cnVlLAoKICBsb3dlcmNhc2U6IHRydWUsCiAgdXBwZXJjYXNlOiB0cnVlLAogIG1hbnVhbExvd2VyY2FzZTogdHJ1ZSwKICBtYW51YWxVcHBlcmNhc2U6IHRydWUsCiAgbm9kZU5hbWVfOiB0cnVlLAogIGlzQXJyYXlMaWtlOiB0cnVlLAogIGZvckVhY2g6IHRydWUsCiAgc29ydGVkS2V5czogdHJ1ZSwKICBmb3JFYWNoU29ydGVkOiB0cnVlLAogIHJldmVyc2VQYXJhbXM6IHRydWUsCiAgbmV4dFVpZDogdHJ1ZSwKICBzZXRIYXNoS2V5OiB0cnVlLAogIGV4dGVuZDogdHJ1ZSwKICBpbnQ6IHRydWUsCiAgaW5oZXJpdDogdHJ1ZSwKICBub29wOiB0cnVlLAogIGlkZW50aXR5OiB0cnVlLAogIHZhbHVlRm46IHRydWUsCiAgaXNVbmRlZmluZWQ6IHRydWUsCiAgaXNEZWZpbmVkOiB0cnVlLAogIGlzT2JqZWN0OiB0cnVlLAogIGlzU3RyaW5nOiB0cnVlLAogIGlzTnVtYmVyOiB0cnVlLAogIGlzRGF0ZTogdHJ1ZSwKICBpc0FycmF5OiB0cnVlLAogIGlzRnVuY3Rpb246IHRydWUsCiAgaXNSZWdFeHA6IHRydWUsCiAgaXNXaW5kb3c6IHRydWUsCiAgaXNTY29wZTogdHJ1ZSwKICBpc0ZpbGU6IHRydWUsCiAgaXNCbG9iOiB0cnVlLAogIGlzQm9vbGVhbjogdHJ1ZSwKICBpc1Byb21pc2VMaWtlOiB0cnVlLAogIHRyaW06IHRydWUsCiAgaXNFbGVtZW50OiB0cnVlLAogIG1ha2VNYXA6IHRydWUsCiAgc2l6ZTogdHJ1ZSwKICBpbmNsdWRlczogdHJ1ZSwKICBhcnJheVJlbW92ZTogdHJ1ZSwKICBpc0xlYWZOb2RlOiB0cnVlLAogIGNvcHk6IHRydWUsCiAgc2hhbGxvd0NvcHk6IHRydWUsCiAgZXF1YWxzOiB0cnVlLAogIGNzcDogdHJ1ZSwKICBjb25jYXQ6IHRydWUsCiAgc2xpY2VBcmdzOiB0cnVlLAogIGJpbmQ6IHRydWUsCiAgdG9Kc29uUmVwbGFjZXI6IHRydWUsCiAgdG9Kc29uOiB0cnVlLAogIGZyb21Kc29uOiB0cnVlLAogIHN0YXJ0aW5nVGFnOiB0cnVlLAogIHRyeURlY29kZVVSSUNvbXBvbmVudDogdHJ1ZSwKICBwYXJzZUtleVZhbHVlOiB0cnVlLAogIHRvS2V5VmFsdWU6IHRydWUsCiAgZW5jb2RlVXJpU2VnbWVudDogdHJ1ZSwKICBlbmNvZGVVcmlRdWVyeTogdHJ1ZSwKICBhbmd1bGFySW5pdDogdHJ1ZSwKICBib290c3RyYXA6IHRydWUsCiAgZ2V0VGVzdGFiaWxpdHk6IHRydWUsCiAgc25ha2VfY2FzZTogdHJ1ZSwKICBiaW5kSlF1ZXJ5OiB0cnVlLAogIGFzc2VydEFyZzogdHJ1ZSwKICBhc3NlcnRBcmdGbjogdHJ1ZSwKICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eTogdHJ1ZSwKICBnZXR0ZXI6IHRydWUsCiAgZ2V0QmxvY2tOb2RlczogdHJ1ZSwKICBoYXNPd25Qcm9wZXJ0eTogdHJ1ZSwKICBjcmVhdGVNYXA6IHRydWUsCgogIE5PREVfVFlQRV9FTEVNRU5UOiB0cnVlLAogIE5PREVfVFlQRV9URVhUOiB0cnVlLAogIE5PREVfVFlQRV9DT01NRU5UOiB0cnVlLAogIE5PREVfVFlQRV9ET0NVTUVOVDogdHJ1ZSwKICBOT0RFX1RZUEVfRE9DVU1FTlRfRlJBR01FTlQ6IHRydWUsCiovCgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCi8qKgogKiBAbmdkb2MgbW9kdWxlCiAqIEBuYW1lIG5nCiAqIEBtb2R1bGUgbmcKICogQGRlc2NyaXB0aW9uCiAqCiAqICMgbmcgKGNvcmUgbW9kdWxlKQogKiBUaGUgbmcgbW9kdWxlIGlzIGxvYWRlZCBieSBkZWZhdWx0IHdoZW4gYW4gQW5ndWxhckpTIGFwcGxpY2F0aW9uIGlzIHN0YXJ0ZWQuIFRoZSBtb2R1bGUgaXRzZWxmCiAqIGNvbnRhaW5zIHRoZSBlc3NlbnRpYWwgY29tcG9uZW50cyBmb3IgYW4gQW5ndWxhckpTIGFwcGxpY2F0aW9uIHRvIGZ1bmN0aW9uLiBUaGUgdGFibGUgYmVsb3cKICogbGlzdHMgYSBoaWdoIGxldmVsIGJyZWFrZG93biBvZiBlYWNoIG9mIHRoZSBzZXJ2aWNlcy9mYWN0b3JpZXMsIGZpbHRlcnMsIGRpcmVjdGl2ZXMgYW5kIHRlc3RpbmcKICogY29tcG9uZW50cyBhdmFpbGFibGUgd2l0aGluIHRoaXMgY29yZSBtb2R1bGUuCiAqCiAqIDxkaXYgZG9jLW1vZHVsZS1jb21wb25lbnRzPSJuZyI+PC9kaXY+CiAqLwoKdmFyIFJFR0VYX1NUUklOR19SRUdFWFAgPSAvXlwvKC4rKVwvKFthLXpdKikkLzsKCi8vIFRoZSBuYW1lIG9mIGEgZm9ybSBjb250cm9sJ3MgVmFsaWRpdHlTdGF0ZSBwcm9wZXJ0eS4KLy8gVGhpcyBpcyB1c2VkIHNvIHRoYXQgaXQncyBwb3NzaWJsZSBmb3IgaW50ZXJuYWwgdGVzdHMgdG8gY3JlYXRlIG1vY2sgVmFsaWRpdHlTdGF0ZXMuCnZhciBWQUxJRElUWV9TVEFURV9QUk9QRVJUWSA9ICd2YWxpZGl0eSc7CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIubG93ZXJjYXNlCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uIENvbnZlcnRzIHRoZSBzcGVjaWZpZWQgc3RyaW5nIHRvIGxvd2VyY2FzZS4KICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgY29udmVydGVkIHRvIGxvd2VyY2FzZS4KICogQHJldHVybnMge3N0cmluZ30gTG93ZXJjYXNlZCBzdHJpbmcuCiAqLwp2YXIgbG93ZXJjYXNlID0gZnVuY3Rpb24oc3RyaW5nKXtyZXR1cm4gaXNTdHJpbmcoc3RyaW5nKSA/IHN0cmluZy50b0xvd2VyQ2FzZSgpIDogc3RyaW5nO307CnZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIudXBwZXJjYXNlCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uIENvbnZlcnRzIHRoZSBzcGVjaWZpZWQgc3RyaW5nIHRvIHVwcGVyY2FzZS4KICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgY29udmVydGVkIHRvIHVwcGVyY2FzZS4KICogQHJldHVybnMge3N0cmluZ30gVXBwZXJjYXNlZCBzdHJpbmcuCiAqLwp2YXIgdXBwZXJjYXNlID0gZnVuY3Rpb24oc3RyaW5nKXtyZXR1cm4gaXNTdHJpbmcoc3RyaW5nKSA/IHN0cmluZy50b1VwcGVyQ2FzZSgpIDogc3RyaW5nO307CgoKdmFyIG1hbnVhbExvd2VyY2FzZSA9IGZ1bmN0aW9uKHMpIHsKICAvKiBqc2hpbnQgYml0d2lzZTogZmFsc2UgKi8KICByZXR1cm4gaXNTdHJpbmcocykKICAgICAgPyBzLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKGNoKSB7cmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoY2guY2hhckNvZGVBdCgwKSB8IDMyKTt9KQogICAgICA6IHM7Cn07CnZhciBtYW51YWxVcHBlcmNhc2UgPSBmdW5jdGlvbihzKSB7CiAgLyoganNoaW50IGJpdHdpc2U6IGZhbHNlICovCiAgcmV0dXJuIGlzU3RyaW5nKHMpCiAgICAgID8gcy5yZXBsYWNlKC9bYS16XS9nLCBmdW5jdGlvbihjaCkge3JldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgJiB+MzIpO30pCiAgICAgIDogczsKfTsKCgovLyBTdHJpbmcjdG9Mb3dlckNhc2UgYW5kIFN0cmluZyN0b1VwcGVyQ2FzZSBkb24ndCBwcm9kdWNlIGNvcnJlY3QgcmVzdWx0cyBpbiBicm93c2VycyB3aXRoIFR1cmtpc2gKLy8gbG9jYWxlLCBmb3IgdGhpcyByZWFzb24gd2UgbmVlZCB0byBkZXRlY3QgdGhpcyBjYXNlIGFuZCByZWRlZmluZSBsb3dlcmNhc2UvdXBwZXJjYXNlIG1ldGhvZHMKLy8gd2l0aCBjb3JyZWN0IGJ1dCBzbG93ZXIgYWx0ZXJuYXRpdmVzLgppZiAoJ2knICE9PSAnSScudG9Mb3dlckNhc2UoKSkgewogIGxvd2VyY2FzZSA9IG1hbnVhbExvd2VyY2FzZTsKICB1cHBlcmNhc2UgPSBtYW51YWxVcHBlcmNhc2U7Cn0KCgp2YXIgLyoqIGhvbGRzIG1ham9yIHZlcnNpb24gbnVtYmVyIGZvciBJRSBvciBOYU4gZm9yIHJlYWwgYnJvd3NlcnMgKi8KICAgIG1zaWUsCiAgICBqcUxpdGUsICAgICAgICAgICAvLyBkZWxheSBiaW5kaW5nIHNpbmNlIGpRdWVyeSBjb3VsZCBiZSBsb2FkZWQgYWZ0ZXIgdXMuCiAgICBqUXVlcnksICAgICAgICAgICAvLyBkZWxheSBiaW5kaW5nCiAgICBzbGljZSAgICAgICAgICAgICA9IFtdLnNsaWNlLAogICAgc3BsaWNlICAgICAgICAgICAgPSBbXS5zcGxpY2UsCiAgICBwdXNoICAgICAgICAgICAgICA9IFtdLnB1c2gsCiAgICB0b1N0cmluZyAgICAgICAgICA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcsCiAgICBuZ01pbkVyciAgICAgICAgICA9IG1pbkVycignbmcnKSwKCiAgICAvKiogQG5hbWUgYW5ndWxhciAqLwogICAgYW5ndWxhciAgICAgICAgICAgPSB3aW5kb3cuYW5ndWxhciB8fCAod2luZG93LmFuZ3VsYXIgPSB7fSksCiAgICBhbmd1bGFyTW9kdWxlLAogICAgdWlkICAgICAgICAgICAgICAgPSAwOwoKLyoqCiAqIGRvY3VtZW50TW9kZSBpcyBhbiBJRS1vbmx5IHByb3BlcnR5CiAqIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9jYzE5Njk4OCh2PXZzLjg1KS5hc3B4CiAqLwptc2llID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwoKCi8qKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0geyp9IG9iagogKiBAcmV0dXJuIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgYG9iamAgaXMgYW4gYXJyYXkgb3IgYXJyYXktbGlrZSBvYmplY3QgKE5vZGVMaXN0LCBBcmd1bWVudHMsCiAqICAgICAgICAgICAgICAgICAgIFN0cmluZyAuLi4pCiAqLwpmdW5jdGlvbiBpc0FycmF5TGlrZShvYmopIHsKICBpZiAob2JqID09IG51bGwgfHwgaXNXaW5kb3cob2JqKSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgdmFyIGxlbmd0aCA9IG9iai5sZW5ndGg7CgogIGlmIChvYmoubm9kZVR5cGUgPT09IE5PREVfVFlQRV9FTEVNRU5UICYmIGxlbmd0aCkgewogICAgcmV0dXJuIHRydWU7CiAgfQoKICByZXR1cm4gaXNTdHJpbmcob2JqKSB8fCBpc0FycmF5KG9iaikgfHwgbGVuZ3RoID09PSAwIHx8CiAgICAgICAgIHR5cGVvZiBsZW5ndGggPT09ICdudW1iZXInICYmIGxlbmd0aCA+IDAgJiYgKGxlbmd0aCAtIDEpIGluIG9iajsKfQoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmZvckVhY2gKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogSW52b2tlcyB0aGUgYGl0ZXJhdG9yYCBmdW5jdGlvbiBvbmNlIGZvciBlYWNoIGl0ZW0gaW4gYG9iamAgY29sbGVjdGlvbiwgd2hpY2ggY2FuIGJlIGVpdGhlciBhbgogKiBvYmplY3Qgb3IgYW4gYXJyYXkuIFRoZSBgaXRlcmF0b3JgIGZ1bmN0aW9uIGlzIGludm9rZWQgd2l0aCBgaXRlcmF0b3IodmFsdWUsIGtleSwgb2JqKWAsIHdoZXJlIGB2YWx1ZWAKICogaXMgdGhlIHZhbHVlIG9mIGFuIG9iamVjdCBwcm9wZXJ0eSBvciBhbiBhcnJheSBlbGVtZW50LCBga2V5YCBpcyB0aGUgb2JqZWN0IHByb3BlcnR5IGtleSBvcgogKiBhcnJheSBlbGVtZW50IGluZGV4IGFuZCBvYmogaXMgdGhlIGBvYmpgIGl0c2VsZi4gU3BlY2lmeWluZyBhIGBjb250ZXh0YCBmb3IgdGhlIGZ1bmN0aW9uIGlzIG9wdGlvbmFsLgogKgogKiBJdCBpcyB3b3J0aCBub3RpbmcgdGhhdCBgLmZvckVhY2hgIGRvZXMgbm90IGl0ZXJhdGUgb3ZlciBpbmhlcml0ZWQgcHJvcGVydGllcyBiZWNhdXNlIGl0IGZpbHRlcnMKICogdXNpbmcgdGhlIGBoYXNPd25Qcm9wZXJ0eWAgbWV0aG9kLgogKgogICBgYGBqcwogICAgIHZhciB2YWx1ZXMgPSB7bmFtZTogJ21pc2tvJywgZ2VuZGVyOiAnbWFsZSd9OwogICAgIHZhciBsb2cgPSBbXTsKICAgICBhbmd1bGFyLmZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICB0aGlzLnB1c2goa2V5ICsgJzogJyArIHZhbHVlKTsKICAgICB9LCBsb2cpOwogICAgIGV4cGVjdChsb2cpLnRvRXF1YWwoWyduYW1lOiBtaXNrbycsICdnZW5kZXI6IG1hbGUnXSk7CiAgIGBgYAogKgogKiBAcGFyYW0ge09iamVjdHxBcnJheX0gb2JqIE9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdG9yIEl0ZXJhdG9yIGZ1bmN0aW9uLgogKiBAcGFyYW0ge09iamVjdD19IGNvbnRleHQgT2JqZWN0IHRvIGJlY29tZSBjb250ZXh0IChgdGhpc2ApIGZvciB0aGUgaXRlcmF0b3IgZnVuY3Rpb24uCiAqIEByZXR1cm5zIHtPYmplY3R8QXJyYXl9IFJlZmVyZW5jZSB0byBgb2JqYC4KICovCgpmdW5jdGlvbiBmb3JFYWNoKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICB2YXIga2V5LCBsZW5ndGg7CiAgaWYgKG9iaikgewogICAgaWYgKGlzRnVuY3Rpb24ob2JqKSkgewogICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICAvLyBOZWVkIHRvIGNoZWNrIGlmIGhhc093blByb3BlcnR5IGV4aXN0cywKICAgICAgICAvLyBhcyBvbiBJRTggdGhlIHJlc3VsdCBvZiBxdWVyeVNlbGVjdG9yQWxsIGlzIGFuIG9iamVjdCB3aXRob3V0IGEgaGFzT3duUHJvcGVydHkgZnVuY3Rpb24KICAgICAgICBpZiAoa2V5ICE9ICdwcm90b3R5cGUnICYmIGtleSAhPSAnbGVuZ3RoJyAmJiBrZXkgIT0gJ25hbWUnICYmICghb2JqLmhhc093blByb3BlcnR5IHx8IG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSkgewogICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmopOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChpc0FycmF5KG9iaikgfHwgaXNBcnJheUxpa2Uob2JqKSkgewogICAgICB2YXIgaXNQcmltaXRpdmUgPSB0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JzsKICAgICAgZm9yIChrZXkgPSAwLCBsZW5ndGggPSBvYmoubGVuZ3RoOyBrZXkgPCBsZW5ndGg7IGtleSsrKSB7CiAgICAgICAgaWYgKGlzUHJpbWl0aXZlIHx8IGtleSBpbiBvYmopIHsKICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSwgb2JqKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAob2JqLmZvckVhY2ggJiYgb2JqLmZvckVhY2ggIT09IGZvckVhY2gpIHsKICAgICAgICBvYmouZm9yRWFjaChpdGVyYXRvciwgY29udGV4dCwgb2JqKTsKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoa2V5IGluIG9iaikgewogICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmopOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICByZXR1cm4gb2JqOwp9CgpmdW5jdGlvbiBzb3J0ZWRLZXlzKG9iaikgewogIHZhciBrZXlzID0gW107CiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgIGtleXMucHVzaChrZXkpOwogICAgfQogIH0KICByZXR1cm4ga2V5cy5zb3J0KCk7Cn0KCmZ1bmN0aW9uIGZvckVhY2hTb3J0ZWQob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogIHZhciBrZXlzID0gc29ydGVkS2V5cyhvYmopOwogIGZvciAoIHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleXNbaV1dLCBrZXlzW2ldKTsKICB9CiAgcmV0dXJuIGtleXM7Cn0KCgovKioKICogd2hlbiB1c2luZyBmb3JFYWNoIHRoZSBwYXJhbXMgYXJlIHZhbHVlLCBrZXksIGJ1dCBpdCBpcyBvZnRlbiB1c2VmdWwgdG8gaGF2ZSBrZXksIHZhbHVlLgogKiBAcGFyYW0ge2Z1bmN0aW9uKHN0cmluZywgKil9IGl0ZXJhdG9yRm4KICogQHJldHVybnMge2Z1bmN0aW9uKCosIHN0cmluZyl9CiAqLwpmdW5jdGlvbiByZXZlcnNlUGFyYW1zKGl0ZXJhdG9yRm4pIHsKICByZXR1cm4gZnVuY3Rpb24odmFsdWUsIGtleSkgeyBpdGVyYXRvckZuKGtleSwgdmFsdWUpOyB9Owp9CgovKioKICogQSBjb25zaXN0ZW50IHdheSBvZiBjcmVhdGluZyB1bmlxdWUgSURzIGluIGFuZ3VsYXIuCiAqCiAqIFVzaW5nIHNpbXBsZSBudW1iZXJzIGFsbG93cyB1cyB0byBnZW5lcmF0ZSAyOC42IG1pbGxpb24gdW5pcXVlIGlkcyBwZXIgc2Vjb25kIGZvciAxMCB5ZWFycyBiZWZvcmUKICogd2UgaGl0IG51bWJlciBwcmVjaXNpb24gaXNzdWVzIGluIEphdmFTY3JpcHQuCiAqCiAqIE1hdGgucG93KDIsNTMpIC8gNjAgLyA2MCAvIDI0IC8gMzY1IC8gMTAgPSAyOC42TQogKgogKiBAcmV0dXJucyB7bnVtYmVyfSBhbiB1bmlxdWUgYWxwaGEtbnVtZXJpYyBzdHJpbmcKICovCmZ1bmN0aW9uIG5leHRVaWQoKSB7CiAgcmV0dXJuICsrdWlkOwp9CgoKLyoqCiAqIFNldCBvciBjbGVhciB0aGUgaGFzaGtleSBmb3IgYW4gb2JqZWN0LgogKiBAcGFyYW0gb2JqIG9iamVjdAogKiBAcGFyYW0gaCB0aGUgaGFzaGtleSAoIXRydXRoeSB0byBkZWxldGUgdGhlIGhhc2hrZXkpCiAqLwpmdW5jdGlvbiBzZXRIYXNoS2V5KG9iaiwgaCkgewogIGlmIChoKSB7CiAgICBvYmouJCRoYXNoS2V5ID0gaDsKICB9CiAgZWxzZSB7CiAgICBkZWxldGUgb2JqLiQkaGFzaEtleTsKICB9Cn0KCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5leHRlbmQKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRXh0ZW5kcyB0aGUgZGVzdGluYXRpb24gb2JqZWN0IGBkc3RgIGJ5IGNvcHlpbmcgb3duIGVudW1lcmFibGUgcHJvcGVydGllcyBmcm9tIHRoZSBgc3JjYCBvYmplY3QocykKICogdG8gYGRzdGAuIFlvdSBjYW4gc3BlY2lmeSBtdWx0aXBsZSBgc3JjYCBvYmplY3RzLiBJZiB5b3Ugd2FudCB0byBwcmVzZXJ2ZSBvcmlnaW5hbCBvYmplY3RzLCB5b3UgY2FuIGRvIHNvCiAqIGJ5IHBhc3NpbmcgYW4gZW1wdHkgb2JqZWN0IGFzIHRoZSB0YXJnZXQ6IGB2YXIgb2JqZWN0ID0gYW5ndWxhci5leHRlbmQoe30sIG9iamVjdDEsIG9iamVjdDIpYC4KICoKICogQHBhcmFtIHtPYmplY3R9IGRzdCBEZXN0aW5hdGlvbiBvYmplY3QuCiAqIEBwYXJhbSB7Li4uT2JqZWN0fSBzcmMgU291cmNlIG9iamVjdChzKS4KICogQHJldHVybnMge09iamVjdH0gUmVmZXJlbmNlIHRvIGBkc3RgLgogKi8KZnVuY3Rpb24gZXh0ZW5kKGRzdCkgewogIHZhciBoID0gZHN0LiQkaGFzaEtleTsKCiAgZm9yICh2YXIgaSA9IDEsIGlpID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgIHZhciBvYmogPSBhcmd1bWVudHNbaV07CiAgICBpZiAob2JqKSB7CiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqKTsKICAgICAgZm9yICh2YXIgaiA9IDAsIGpqID0ga2V5cy5sZW5ndGg7IGogPCBqajsgaisrKSB7CiAgICAgICAgdmFyIGtleSA9IGtleXNbal07CiAgICAgICAgZHN0W2tleV0gPSBvYmpba2V5XTsKICAgICAgfQogICAgfQogIH0KCiAgc2V0SGFzaEtleShkc3QsIGgpOwogIHJldHVybiBkc3Q7Cn0KCmZ1bmN0aW9uIGludChzdHIpIHsKICByZXR1cm4gcGFyc2VJbnQoc3RyLCAxMCk7Cn0KCgpmdW5jdGlvbiBpbmhlcml0KHBhcmVudCwgZXh0cmEpIHsKICByZXR1cm4gZXh0ZW5kKG5ldyAoZXh0ZW5kKGZ1bmN0aW9uKCkge30sIHtwcm90b3R5cGU6cGFyZW50fSkpKCksIGV4dHJhKTsKfQoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLm5vb3AKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQSBmdW5jdGlvbiB0aGF0IHBlcmZvcm1zIG5vIG9wZXJhdGlvbnMuIFRoaXMgZnVuY3Rpb24gY2FuIGJlIHVzZWZ1bCB3aGVuIHdyaXRpbmcgY29kZSBpbiB0aGUKICogZnVuY3Rpb25hbCBzdHlsZS4KICAgYGBganMKICAgICBmdW5jdGlvbiBmb28oY2FsbGJhY2spIHsKICAgICAgIHZhciByZXN1bHQgPSBjYWxjdWxhdGVSZXN1bHQoKTsKICAgICAgIChjYWxsYmFjayB8fCBhbmd1bGFyLm5vb3ApKHJlc3VsdCk7CiAgICAgfQogICBgYGAKICovCmZ1bmN0aW9uIG5vb3AoKSB7fQpub29wLiRpbmplY3QgPSBbXTsKCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaWRlbnRpdHkKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQSBmdW5jdGlvbiB0aGF0IHJldHVybnMgaXRzIGZpcnN0IGFyZ3VtZW50LiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWZ1bCB3aGVuIHdyaXRpbmcgY29kZSBpbiB0aGUKICogZnVuY3Rpb25hbCBzdHlsZS4KICoKICAgYGBganMKICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1lcih0cmFuc2Zvcm1hdGlvbkZuLCB2YWx1ZSkgewogICAgICAgcmV0dXJuICh0cmFuc2Zvcm1hdGlvbkZuIHx8IGFuZ3VsYXIuaWRlbnRpdHkpKHZhbHVlKTsKICAgICB9OwogICBgYGAKICovCmZ1bmN0aW9uIGlkZW50aXR5KCQpIHtyZXR1cm4gJDt9CmlkZW50aXR5LiRpbmplY3QgPSBbXTsKCgpmdW5jdGlvbiB2YWx1ZUZuKHZhbHVlKSB7cmV0dXJuIGZ1bmN0aW9uKCkge3JldHVybiB2YWx1ZTt9O30KCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc1VuZGVmaW5lZAogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIHVuZGVmaW5lZC4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgdW5kZWZpbmVkLgogKi8KZnVuY3Rpb24gaXNVbmRlZmluZWQodmFsdWUpe3JldHVybiB0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnO30KCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNEZWZpbmVkCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgZGVmaW5lZC4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgZGVmaW5lZC4KICovCmZ1bmN0aW9uIGlzRGVmaW5lZCh2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCc7fQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc09iamVjdAogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBPYmplY3RgLiBVbmxpa2UgYHR5cGVvZmAgaW4gSmF2YVNjcmlwdCwgYG51bGxgcyBhcmUgbm90CiAqIGNvbnNpZGVyZWQgdG8gYmUgb2JqZWN0cy4gTm90ZSB0aGF0IEphdmFTY3JpcHQgYXJyYXlzIGFyZSBvYmplY3RzLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhbiBgT2JqZWN0YCBidXQgbm90IGBudWxsYC4KICovCmZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKXsKICAvLyBodHRwOi8vanNwZXJmLmNvbS9pc29iamVjdDQKICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JzsKfQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc1N0cmluZwogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYFN0cmluZ2AuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYFN0cmluZ2AuCiAqLwpmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZyc7fQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc051bWJlcgogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYE51bWJlcmAuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYE51bWJlcmAuCiAqLwpmdW5jdGlvbiBpc051bWJlcih2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcic7fQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc0RhdGUKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyBpZiBhIHZhbHVlIGlzIGEgZGF0ZS4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRGF0ZWAuCiAqLwpmdW5jdGlvbiBpc0RhdGUodmFsdWUpIHsKICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IERhdGVdJzsKfQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc0FycmF5CiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYW4gYEFycmF5YC4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYW4gYEFycmF5YC4KICovCnZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheTsKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc0Z1bmN0aW9uCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBgRnVuY3Rpb25gLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBGdW5jdGlvbmAuCiAqLwpmdW5jdGlvbiBpc0Z1bmN0aW9uKHZhbHVlKXtyZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nO30KCgovKioKICogRGV0ZXJtaW5lcyBpZiBhIHZhbHVlIGlzIGEgcmVndWxhciBleHByZXNzaW9uIG9iamVjdC4KICoKICogQHByaXZhdGUKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgUmVnRXhwYC4KICovCmZ1bmN0aW9uIGlzUmVnRXhwKHZhbHVlKSB7CiAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09PSAnW29iamVjdCBSZWdFeHBdJzsKfQoKCi8qKgogKiBDaGVja3MgaWYgYG9iamAgaXMgYSB3aW5kb3cgb2JqZWN0LgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0geyp9IG9iaiBPYmplY3QgdG8gY2hlY2sKICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYG9iamAgaXMgYSB3aW5kb3cgb2JqLgogKi8KZnVuY3Rpb24gaXNXaW5kb3cob2JqKSB7CiAgcmV0dXJuIG9iaiAmJiBvYmoud2luZG93ID09PSBvYmo7Cn0KCgpmdW5jdGlvbiBpc1Njb3BlKG9iaikgewogIHJldHVybiBvYmogJiYgb2JqLiRldmFsQXN5bmMgJiYgb2JqLiR3YXRjaDsKfQoKCmZ1bmN0aW9uIGlzRmlsZShvYmopIHsKICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBGaWxlXSc7Cn0KCgpmdW5jdGlvbiBpc0Jsb2Iob2JqKSB7CiAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgQmxvYl0nOwp9CgoKZnVuY3Rpb24gaXNCb29sZWFuKHZhbHVlKSB7CiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nOwp9CgoKZnVuY3Rpb24gaXNQcm9taXNlTGlrZShvYmopIHsKICByZXR1cm4gb2JqICYmIGlzRnVuY3Rpb24ob2JqLnRoZW4pOwp9CgoKdmFyIHRyaW0gPSBmdW5jdGlvbih2YWx1ZSkgewogIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS50cmltKCkgOiB2YWx1ZTsKfTsKCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNFbGVtZW50CiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBET00gZWxlbWVudCAob3Igd3JhcHBlZCBqUXVlcnkgZWxlbWVudCkuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgRE9NIGVsZW1lbnQgKG9yIHdyYXBwZWQgalF1ZXJ5IGVsZW1lbnQpLgogKi8KZnVuY3Rpb24gaXNFbGVtZW50KG5vZGUpIHsKICByZXR1cm4gISEobm9kZSAmJgogICAgKG5vZGUubm9kZU5hbWUgIC8vIHdlIGFyZSBhIGRpcmVjdCBlbGVtZW50CiAgICB8fCAobm9kZS5wcm9wICYmIG5vZGUuYXR0ciAmJiBub2RlLmZpbmQpKSk7ICAvLyB3ZSBoYXZlIGFuIG9uIGFuZCBmaW5kIG1ldGhvZCBwYXJ0IG9mIGpRdWVyeSBBUEkKfQoKLyoqCiAqIEBwYXJhbSBzdHIgJ2tleTEsa2V5MiwuLi4nCiAqIEByZXR1cm5zIHtvYmplY3R9IGluIHRoZSBmb3JtIG9mIHtrZXkxOnRydWUsIGtleTI6dHJ1ZSwgLi4ufQogKi8KZnVuY3Rpb24gbWFrZU1hcChzdHIpIHsKICB2YXIgb2JqID0ge30sIGl0ZW1zID0gc3RyLnNwbGl0KCIsIiksIGk7CiAgZm9yICggaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKyApCiAgICBvYmpbIGl0ZW1zW2ldIF0gPSB0cnVlOwogIHJldHVybiBvYmo7Cn0KCgpmdW5jdGlvbiBub2RlTmFtZV8oZWxlbWVudCkgewogIHJldHVybiBsb3dlcmNhc2UoZWxlbWVudC5ub2RlTmFtZSB8fCBlbGVtZW50WzBdLm5vZGVOYW1lKTsKfQoKCi8qKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIGFycmF5LCB0aGUgbnVtYmVyIG9mIHByb3BlcnRpZXMgYW4gb2JqZWN0IGhhcywgb3IKICogdGhlIGxlbmd0aCBvZiBhIHN0cmluZy4KICoKICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIE9iamVjdCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogKiB7QGxpbmsgYW5ndWxhci5PYmplY3R9IGZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogKgogKiBAcGFyYW0ge09iamVjdHxBcnJheXxzdHJpbmd9IG9iaiBPYmplY3QsIGFycmF5LCBvciBzdHJpbmcgdG8gaW5zcGVjdC4KICogQHBhcmFtIHtib29sZWFufSBbb3duUHJvcHNPbmx5PWZhbHNlXSBDb3VudCBvbmx5ICJvd24iIHByb3BlcnRpZXMgaW4gYW4gb2JqZWN0CiAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBzaXplIG9mIGBvYmpgIG9yIGAwYCBpZiBgb2JqYCBpcyBuZWl0aGVyIGFuIG9iamVjdCBub3IgYW4gYXJyYXkuCiAqLwpmdW5jdGlvbiBzaXplKG9iaiwgb3duUHJvcHNPbmx5KSB7CiAgdmFyIGNvdW50ID0gMCwga2V5OwoKICBpZiAoaXNBcnJheShvYmopIHx8IGlzU3RyaW5nKG9iaikpIHsKICAgIHJldHVybiBvYmoubGVuZ3RoOwogIH0gZWxzZSBpZiAoaXNPYmplY3Qob2JqKSkgewogICAgZm9yIChrZXkgaW4gb2JqKQogICAgICBpZiAoIW93blByb3BzT25seSB8fCBvYmouaGFzT3duUHJvcGVydHkoa2V5KSkKICAgICAgICBjb3VudCsrOwogIH0KCiAgcmV0dXJuIGNvdW50Owp9CgoKZnVuY3Rpb24gaW5jbHVkZXMoYXJyYXksIG9iaikgewogIHJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGFycmF5LCBvYmopICE9IC0xOwp9CgpmdW5jdGlvbiBhcnJheVJlbW92ZShhcnJheSwgdmFsdWUpIHsKICB2YXIgaW5kZXggPSBhcnJheS5pbmRleE9mKHZhbHVlKTsKICBpZiAoaW5kZXggPj0wKQogICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTsKICByZXR1cm4gdmFsdWU7Cn0KCmZ1bmN0aW9uIGlzTGVhZk5vZGUgKG5vZGUpIHsKICBpZiAobm9kZSkgewogICAgc3dpdGNoIChub2RlTmFtZV8obm9kZSkpIHsKICAgIGNhc2UgIm9wdGlvbiI6CiAgICBjYXNlICJwcmUiOgogICAgY2FzZSAidGl0bGUiOgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuY29weQogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDcmVhdGVzIGEgZGVlcCBjb3B5IG9mIGBzb3VyY2VgLCB3aGljaCBzaG91bGQgYmUgYW4gb2JqZWN0IG9yIGFuIGFycmF5LgogKgogKiAqIElmIG5vIGRlc3RpbmF0aW9uIGlzIHN1cHBsaWVkLCBhIGNvcHkgb2YgdGhlIG9iamVjdCBvciBhcnJheSBpcyBjcmVhdGVkLgogKiAqIElmIGEgZGVzdGluYXRpb24gaXMgcHJvdmlkZWQsIGFsbCBvZiBpdHMgZWxlbWVudHMgKGZvciBhcnJheSkgb3IgcHJvcGVydGllcyAoZm9yIG9iamVjdHMpCiAqICAgYXJlIGRlbGV0ZWQgYW5kIHRoZW4gYWxsIGVsZW1lbnRzL3Byb3BlcnRpZXMgZnJvbSB0aGUgc291cmNlIGFyZSBjb3BpZWQgdG8gaXQuCiAqICogSWYgYHNvdXJjZWAgaXMgbm90IGFuIG9iamVjdCBvciBhcnJheSAoaW5jLiBgbnVsbGAgYW5kIGB1bmRlZmluZWRgKSwgYHNvdXJjZWAgaXMgcmV0dXJuZWQuCiAqICogSWYgYHNvdXJjZWAgaXMgaWRlbnRpY2FsIHRvICdkZXN0aW5hdGlvbicgYW4gZXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duLgogKgogKiBAcGFyYW0geyp9IHNvdXJjZSBUaGUgc291cmNlIHRoYXQgd2lsbCBiZSB1c2VkIHRvIG1ha2UgYSBjb3B5LgogKiAgICAgICAgICAgICAgICAgICBDYW4gYmUgYW55IHR5cGUsIGluY2x1ZGluZyBwcmltaXRpdmVzLCBgbnVsbGAsIGFuZCBgdW5kZWZpbmVkYC4KICogQHBhcmFtIHsoT2JqZWN0fEFycmF5KT19IGRlc3RpbmF0aW9uIERlc3RpbmF0aW9uIGludG8gd2hpY2ggdGhlIHNvdXJjZSBpcyBjb3BpZWQuIElmCiAqICAgICBwcm92aWRlZCwgbXVzdCBiZSBvZiB0aGUgc2FtZSB0eXBlIGFzIGBzb3VyY2VgLgogKiBAcmV0dXJucyB7Kn0gVGhlIGNvcHkgb3IgdXBkYXRlZCBgZGVzdGluYXRpb25gLCBpZiBgZGVzdGluYXRpb25gIHdhcyBzcGVjaWZpZWQuCiAqCiAqIEBleGFtcGxlCiA8ZXhhbXBsZSBtb2R1bGU9ImNvcHlFeGFtcGxlIj4KIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogPGRpdiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiA8Zm9ybSBub3ZhbGlkYXRlIGNsYXNzPSJzaW1wbGUtZm9ybSI+CiBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InVzZXIubmFtZSIgLz48YnIgLz4KIEUtbWFpbDogPGlucHV0IHR5cGU9ImVtYWlsIiBuZy1tb2RlbD0idXNlci5lbWFpbCIgLz48YnIgLz4KIEdlbmRlcjogPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0idXNlci5nZW5kZXIiIHZhbHVlPSJtYWxlIiAvPm1hbGUKIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9InVzZXIuZ2VuZGVyIiB2YWx1ZT0iZmVtYWxlIiAvPmZlbWFsZTxiciAvPgogPGJ1dHRvbiBuZy1jbGljaz0icmVzZXQoKSI+UkVTRVQ8L2J1dHRvbj4KIDxidXR0b24gbmctY2xpY2s9InVwZGF0ZSh1c2VyKSI+U0FWRTwvYnV0dG9uPgogPC9mb3JtPgogPHByZT5mb3JtID0ge3t1c2VyIHwganNvbn19PC9wcmU+CiA8cHJlPm1hc3RlciA9IHt7bWFzdGVyIHwganNvbn19PC9wcmU+CiA8L2Rpdj4KCiA8c2NyaXB0PgogIGFuZ3VsYXIubW9kdWxlKCdjb3B5RXhhbXBsZScsIFtdKQogICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgJHNjb3BlLm1hc3Rlcj0ge307CgogICAgICAkc2NvcGUudXBkYXRlID0gZnVuY3Rpb24odXNlcikgewogICAgICAgIC8vIEV4YW1wbGUgd2l0aCAxIGFyZ3VtZW50CiAgICAgICAgJHNjb3BlLm1hc3Rlcj0gYW5ndWxhci5jb3B5KHVzZXIpOwogICAgICB9OwoKICAgICAgJHNjb3BlLnJlc2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gRXhhbXBsZSB3aXRoIDIgYXJndW1lbnRzCiAgICAgICAgYW5ndWxhci5jb3B5KCRzY29wZS5tYXN0ZXIsICRzY29wZS51c2VyKTsKICAgICAgfTsKCiAgICAgICRzY29wZS5yZXNldCgpOwogICAgfV0pOwogPC9zY3JpcHQ+CiA8L2ZpbGU+CiA8L2V4YW1wbGU+CiAqLwpmdW5jdGlvbiBjb3B5KHNvdXJjZSwgZGVzdGluYXRpb24sIHN0YWNrU291cmNlLCBzdGFja0Rlc3QpIHsKICBpZiAoaXNXaW5kb3coc291cmNlKSB8fCBpc1Njb3BlKHNvdXJjZSkpIHsKICAgIHRocm93IG5nTWluRXJyKCdjcHdzJywKICAgICAgIkNhbid0IGNvcHkhIE1ha2luZyBjb3BpZXMgb2YgV2luZG93IG9yIFNjb3BlIGluc3RhbmNlcyBpcyBub3Qgc3VwcG9ydGVkLiIpOwogIH0KCiAgaWYgKCFkZXN0aW5hdGlvbikgewogICAgZGVzdGluYXRpb24gPSBzb3VyY2U7CiAgICBpZiAoc291cmNlKSB7CiAgICAgIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IGNvcHkoc291cmNlLCBbXSwgc3RhY2tTb3VyY2UsIHN0YWNrRGVzdCk7CiAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKHNvdXJjZSkpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IG5ldyBEYXRlKHNvdXJjZS5nZXRUaW1lKCkpOwogICAgICB9IGVsc2UgaWYgKGlzUmVnRXhwKHNvdXJjZSkpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IG5ldyBSZWdFeHAoc291cmNlLnNvdXJjZSwgc291cmNlLnRvU3RyaW5nKCkubWF0Y2goL1teXC9dKiQvKVswXSk7CiAgICAgICAgZGVzdGluYXRpb24ubGFzdEluZGV4ID0gc291cmNlLmxhc3RJbmRleDsKICAgICAgfSBlbHNlIGlmIChpc09iamVjdChzb3VyY2UpKSB7CiAgICAgICAgdmFyIGVtcHR5T2JqZWN0ID0gT2JqZWN0LmNyZWF0ZShPYmplY3QuZ2V0UHJvdG90eXBlT2Yoc291cmNlKSk7CiAgICAgICAgZGVzdGluYXRpb24gPSBjb3B5KHNvdXJjZSwgZW1wdHlPYmplY3QsIHN0YWNrU291cmNlLCBzdGFja0Rlc3QpOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGlmIChzb3VyY2UgPT09IGRlc3RpbmF0aW9uKSB0aHJvdyBuZ01pbkVycignY3BpJywKICAgICAgIkNhbid0IGNvcHkhIFNvdXJjZSBhbmQgZGVzdGluYXRpb24gYXJlIGlkZW50aWNhbC4iKTsKCiAgICBzdGFja1NvdXJjZSA9IHN0YWNrU291cmNlIHx8IFtdOwogICAgc3RhY2tEZXN0ID0gc3RhY2tEZXN0IHx8IFtdOwoKICAgIGlmIChpc09iamVjdChzb3VyY2UpKSB7CiAgICAgIHZhciBpbmRleCA9IHN0YWNrU291cmNlLmluZGV4T2Yoc291cmNlKTsKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIHN0YWNrRGVzdFtpbmRleF07CgogICAgICBzdGFja1NvdXJjZS5wdXNoKHNvdXJjZSk7CiAgICAgIHN0YWNrRGVzdC5wdXNoKGRlc3RpbmF0aW9uKTsKICAgIH0KCiAgICB2YXIgcmVzdWx0OwogICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICBkZXN0aW5hdGlvbi5sZW5ndGggPSAwOwogICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBzb3VyY2UubGVuZ3RoOyBpKyspIHsKICAgICAgICByZXN1bHQgPSBjb3B5KHNvdXJjZVtpXSwgbnVsbCwgc3RhY2tTb3VyY2UsIHN0YWNrRGVzdCk7CiAgICAgICAgaWYgKGlzT2JqZWN0KHNvdXJjZVtpXSkpIHsKICAgICAgICAgIHN0YWNrU291cmNlLnB1c2goc291cmNlW2ldKTsKICAgICAgICAgIHN0YWNrRGVzdC5wdXNoKHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIGRlc3RpbmF0aW9uLnB1c2gocmVzdWx0KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGggPSBkZXN0aW5hdGlvbi4kJGhhc2hLZXk7CiAgICAgIGlmIChpc0FycmF5KGRlc3RpbmF0aW9uKSkgewogICAgICAgIGRlc3RpbmF0aW9uLmxlbmd0aCA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yRWFjaChkZXN0aW5hdGlvbiwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgZGVsZXRlIGRlc3RpbmF0aW9uW2tleV07CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZm9yICggdmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICBpZihzb3VyY2UuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgcmVzdWx0ID0gY29weShzb3VyY2Vba2V5XSwgbnVsbCwgc3RhY2tTb3VyY2UsIHN0YWNrRGVzdCk7CiAgICAgICAgICBpZiAoaXNPYmplY3Qoc291cmNlW2tleV0pKSB7CiAgICAgICAgICAgIHN0YWNrU291cmNlLnB1c2goc291cmNlW2tleV0pOwogICAgICAgICAgICBzdGFja0Rlc3QucHVzaChyZXN1bHQpOwogICAgICAgICAgfQogICAgICAgICAgZGVzdGluYXRpb25ba2V5XSA9IHJlc3VsdDsKICAgICAgICB9CiAgICAgIH0KICAgICAgc2V0SGFzaEtleShkZXN0aW5hdGlvbixoKTsKICAgIH0KCiAgfQogIHJldHVybiBkZXN0aW5hdGlvbjsKfQoKLyoqCiAqIENyZWF0ZXMgYSBzaGFsbG93IGNvcHkgb2YgYW4gb2JqZWN0LCBhbiBhcnJheSBvciBhIHByaW1pdGl2ZS4KICoKICogQXNzdW1lcyB0aGF0IHRoZXJlIGFyZSBubyBwcm90byBwcm9wZXJ0aWVzIGZvciBvYmplY3RzLgogKi8KZnVuY3Rpb24gc2hhbGxvd0NvcHkoc3JjLCBkc3QpIHsKICBpZiAoaXNBcnJheShzcmMpKSB7CiAgICBkc3QgPSBkc3QgfHwgW107CgogICAgZm9yICh2YXIgaSA9IDAsIGlpID0gc3JjLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgZHN0W2ldID0gc3JjW2ldOwogICAgfQogIH0gZWxzZSBpZiAoaXNPYmplY3Qoc3JjKSkgewogICAgZHN0ID0gZHN0IHx8IHt9OwoKICAgIGZvciAodmFyIGtleSBpbiBzcmMpIHsKICAgICAgaWYgKCEoa2V5LmNoYXJBdCgwKSA9PT0gJyQnICYmIGtleS5jaGFyQXQoMSkgPT09ICckJykpIHsKICAgICAgICBkc3Rba2V5XSA9IHNyY1trZXldOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gZHN0IHx8IHNyYzsKfQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5lcXVhbHMKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyBpZiB0d28gb2JqZWN0cyBvciB0d28gdmFsdWVzIGFyZSBlcXVpdmFsZW50LiBTdXBwb3J0cyB2YWx1ZSB0eXBlcywgcmVndWxhcgogKiBleHByZXNzaW9ucywgYXJyYXlzIGFuZCBvYmplY3RzLgogKgogKiBUd28gb2JqZWN0cyBvciB2YWx1ZXMgYXJlIGNvbnNpZGVyZWQgZXF1aXZhbGVudCBpZiBhdCBsZWFzdCBvbmUgb2YgdGhlIGZvbGxvd2luZyBpcyB0cnVlOgogKgogKiAqIEJvdGggb2JqZWN0cyBvciB2YWx1ZXMgcGFzcyBgPT09YCBjb21wYXJpc29uLgogKiAqIEJvdGggb2JqZWN0cyBvciB2YWx1ZXMgYXJlIG9mIHRoZSBzYW1lIHR5cGUgYW5kIGFsbCBvZiB0aGVpciBwcm9wZXJ0aWVzIGFyZSBlcXVhbCBieQogKiAgIGNvbXBhcmluZyB0aGVtIHdpdGggYGFuZ3VsYXIuZXF1YWxzYC4KICogKiBCb3RoIHZhbHVlcyBhcmUgTmFOLiAoSW4gSmF2YVNjcmlwdCwgTmFOID09IE5hTiA9PiBmYWxzZS4gQnV0IHdlIGNvbnNpZGVyIHR3byBOYU4gYXMgZXF1YWwpCiAqICogQm90aCB2YWx1ZXMgcmVwcmVzZW50IHRoZSBzYW1lIHJlZ3VsYXIgZXhwcmVzc2lvbiAoSW4gSmF2YVNjcmlwdCwKICogICAvYWJjLyA9PSAvYWJjLyA9PiBmYWxzZS4gQnV0IHdlIGNvbnNpZGVyIHR3byByZWd1bGFyIGV4cHJlc3Npb25zIGFzIGVxdWFsIHdoZW4gdGhlaXIgdGV4dHVhbAogKiAgIHJlcHJlc2VudGF0aW9uIG1hdGNoZXMpLgogKgogKiBEdXJpbmcgYSBwcm9wZXJ0eSBjb21wYXJpc29uLCBwcm9wZXJ0aWVzIG9mIGBmdW5jdGlvbmAgdHlwZSBhbmQgcHJvcGVydGllcyB3aXRoIG5hbWVzCiAqIHRoYXQgYmVnaW4gd2l0aCBgJGAgYXJlIGlnbm9yZWQuCiAqCiAqIFNjb3BlIGFuZCBET01XaW5kb3cgb2JqZWN0cyBhcmUgYmVpbmcgY29tcGFyZWQgb25seSBieSBpZGVudGlmeSAoYD09PWApLgogKgogKiBAcGFyYW0geyp9IG8xIE9iamVjdCBvciB2YWx1ZSB0byBjb21wYXJlLgogKiBAcGFyYW0geyp9IG8yIE9iamVjdCBvciB2YWx1ZSB0byBjb21wYXJlLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBhcmd1bWVudHMgYXJlIGVxdWFsLgogKi8KZnVuY3Rpb24gZXF1YWxzKG8xLCBvMikgewogIGlmIChvMSA9PT0gbzIpIHJldHVybiB0cnVlOwogIGlmIChvMSA9PT0gbnVsbCB8fCBvMiA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogIGlmIChvMSAhPT0gbzEgJiYgbzIgIT09IG8yKSByZXR1cm4gdHJ1ZTsgLy8gTmFOID09PSBOYU4KICB2YXIgdDEgPSB0eXBlb2YgbzEsIHQyID0gdHlwZW9mIG8yLCBsZW5ndGgsIGtleSwga2V5U2V0OwogIGlmICh0MSA9PSB0MikgewogICAgaWYgKHQxID09ICdvYmplY3QnKSB7CiAgICAgIGlmIChpc0FycmF5KG8xKSkgewogICAgICAgIGlmICghaXNBcnJheShvMikpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoKGxlbmd0aCA9IG8xLmxlbmd0aCkgPT0gbzIubGVuZ3RoKSB7CiAgICAgICAgICBmb3Ioa2V5PTA7IGtleTxsZW5ndGg7IGtleSsrKSB7CiAgICAgICAgICAgIGlmICghZXF1YWxzKG8xW2tleV0sIG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKG8xKSkgewogICAgICAgIGlmICghaXNEYXRlKG8yKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIHJldHVybiBlcXVhbHMobzEuZ2V0VGltZSgpLCBvMi5nZXRUaW1lKCkpOwogICAgICB9IGVsc2UgaWYgKGlzUmVnRXhwKG8xKSAmJiBpc1JlZ0V4cChvMikpIHsKICAgICAgICByZXR1cm4gbzEudG9TdHJpbmcoKSA9PSBvMi50b1N0cmluZygpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChpc1Njb3BlKG8xKSB8fCBpc1Njb3BlKG8yKSB8fCBpc1dpbmRvdyhvMSkgfHwgaXNXaW5kb3cobzIpIHx8IGlzQXJyYXkobzIpKSByZXR1cm4gZmFsc2U7CiAgICAgICAga2V5U2V0ID0ge307CiAgICAgICAgZm9yKGtleSBpbiBvMSkgewogICAgICAgICAgaWYgKGtleS5jaGFyQXQoMCkgPT09ICckJyB8fCBpc0Z1bmN0aW9uKG8xW2tleV0pKSBjb250aW51ZTsKICAgICAgICAgIGlmICghZXF1YWxzKG8xW2tleV0sIG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICBrZXlTZXRba2V5XSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGZvcihrZXkgaW4gbzIpIHsKICAgICAgICAgIGlmICgha2V5U2V0Lmhhc093blByb3BlcnR5KGtleSkgJiYKICAgICAgICAgICAgICBrZXkuY2hhckF0KDApICE9PSAnJCcgJiYKICAgICAgICAgICAgICBvMltrZXldICE9PSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICAhaXNGdW5jdGlvbihvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn0KCnZhciBjc3AgPSBmdW5jdGlvbigpIHsKICBpZiAoaXNEZWZpbmVkKGNzcC5pc0FjdGl2ZV8pKSByZXR1cm4gY3NwLmlzQWN0aXZlXzsKCiAgdmFyIGFjdGl2ZSA9ICEhKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tuZy1jc3BdJykgfHwKICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtbmctY3NwXScpKTsKCiAgaWYgKCFhY3RpdmUpIHsKICAgIHRyeSB7CiAgICAgIC8qIGpzaGludCAtVzAzMSwgLVcwNTQgKi8KICAgICAgbmV3IEZ1bmN0aW9uKCcnKTsKICAgICAgLyoganNoaW50ICtXMDMxLCArVzA1NCAqLwogICAgfSBjYXRjaCAoZSkgewogICAgICBhY3RpdmUgPSB0cnVlOwogICAgfQogIH0KCiAgcmV0dXJuIChjc3AuaXNBY3RpdmVfID0gYWN0aXZlKTsKfTsKCgoKZnVuY3Rpb24gY29uY2F0KGFycmF5MSwgYXJyYXkyLCBpbmRleCkgewogIHJldHVybiBhcnJheTEuY29uY2F0KHNsaWNlLmNhbGwoYXJyYXkyLCBpbmRleCkpOwp9CgpmdW5jdGlvbiBzbGljZUFyZ3MoYXJncywgc3RhcnRJbmRleCkgewogIHJldHVybiBzbGljZS5jYWxsKGFyZ3MsIHN0YXJ0SW5kZXggfHwgMCk7Cn0KCgovKiBqc2hpbnQgLVcxMDEgKi8KLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmJpbmQKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogUmV0dXJucyBhIGZ1bmN0aW9uIHdoaWNoIGNhbGxzIGZ1bmN0aW9uIGBmbmAgYm91bmQgdG8gYHNlbGZgIChgc2VsZmAgYmVjb21lcyB0aGUgYHRoaXNgIGZvcgogKiBgZm5gKS4gWW91IGNhbiBzdXBwbHkgb3B0aW9uYWwgYGFyZ3NgIHRoYXQgYXJlIHByZWJvdW5kIHRvIHRoZSBmdW5jdGlvbi4gVGhpcyBmZWF0dXJlIGlzIGFsc28KICoga25vd24gYXMgW3BhcnRpYWwgYXBwbGljYXRpb25dKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUGFydGlhbF9hcHBsaWNhdGlvbiksIGFzCiAqIGRpc3Rpbmd1aXNoZWQgZnJvbSBbZnVuY3Rpb24gY3VycnlpbmddKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3VycnlpbmcjQ29udHJhc3Rfd2l0aF9wYXJ0aWFsX2Z1bmN0aW9uX2FwcGxpY2F0aW9uKS4KICoKICogQHBhcmFtIHtPYmplY3R9IHNlbGYgQ29udGV4dCB3aGljaCBgZm5gIHNob3VsZCBiZSBldmFsdWF0ZWQgaW4uCiAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gRnVuY3Rpb24gdG8gYmUgYm91bmQuCiAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBhcmd1bWVudHMgdG8gYmUgcHJlYm91bmQgdG8gdGhlIGBmbmAgZnVuY3Rpb24gY2FsbC4KICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEZ1bmN0aW9uIHRoYXQgd3JhcHMgdGhlIGBmbmAgd2l0aCBhbGwgdGhlIHNwZWNpZmllZCBiaW5kaW5ncy4KICovCi8qIGpzaGludCArVzEwMSAqLwpmdW5jdGlvbiBiaW5kKHNlbGYsIGZuKSB7CiAgdmFyIGN1cnJ5QXJncyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyID8gc2xpY2VBcmdzKGFyZ3VtZW50cywgMikgOiBbXTsKICBpZiAoaXNGdW5jdGlvbihmbikgJiYgIShmbiBpbnN0YW5jZW9mIFJlZ0V4cCkpIHsKICAgIHJldHVybiBjdXJyeUFyZ3MubGVuZ3RoCiAgICAgID8gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aAogICAgICAgICAgICA/IGZuLmFwcGx5KHNlbGYsIGN1cnJ5QXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKSkKICAgICAgICAgICAgOiBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MpOwogICAgICAgIH0KICAgICAgOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgID8gZm4uYXBwbHkoc2VsZiwgYXJndW1lbnRzKQogICAgICAgICAgICA6IGZuLmNhbGwoc2VsZik7CiAgICAgICAgfTsKICB9IGVsc2UgewogICAgLy8gaW4gSUUsIG5hdGl2ZSBtZXRob2RzIGFyZSBub3QgZnVuY3Rpb25zIHNvIHRoZXkgY2Fubm90IGJlIGJvdW5kIChub3RlOiB0aGV5IGRvbid0IG5lZWQgdG8gYmUpCiAgICByZXR1cm4gZm47CiAgfQp9CgoKZnVuY3Rpb24gdG9Kc29uUmVwbGFjZXIoa2V5LCB2YWx1ZSkgewogIHZhciB2YWwgPSB2YWx1ZTsKCiAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnICYmIGtleS5jaGFyQXQoMCkgPT09ICckJyAmJiBrZXkuY2hhckF0KDEpID09PSAnJCcpIHsKICAgIHZhbCA9IHVuZGVmaW5lZDsKICB9IGVsc2UgaWYgKGlzV2luZG93KHZhbHVlKSkgewogICAgdmFsID0gJyRXSU5ET1cnOwogIH0gZWxzZSBpZiAodmFsdWUgJiYgIGRvY3VtZW50ID09PSB2YWx1ZSkgewogICAgdmFsID0gJyRET0NVTUVOVCc7CiAgfSBlbHNlIGlmIChpc1Njb3BlKHZhbHVlKSkgewogICAgdmFsID0gJyRTQ09QRSc7CiAgfQoKICByZXR1cm4gdmFsOwp9CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLnRvSnNvbgogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTZXJpYWxpemVzIGlucHV0IGludG8gYSBKU09OLWZvcm1hdHRlZCBzdHJpbmcuIFByb3BlcnRpZXMgd2l0aCBsZWFkaW5nICQkIGNoYXJhY3RlcnMgd2lsbCBiZQogKiBzdHJpcHBlZCBzaW5jZSBhbmd1bGFyIHVzZXMgdGhpcyBub3RhdGlvbiBpbnRlcm5hbGx5LgogKgogKiBAcGFyYW0ge09iamVjdHxBcnJheXxEYXRlfHN0cmluZ3xudW1iZXJ9IG9iaiBJbnB1dCB0byBiZSBzZXJpYWxpemVkIGludG8gSlNPTi4KICogQHBhcmFtIHtib29sZWFuPX0gcHJldHR5IElmIHNldCB0byB0cnVlLCB0aGUgSlNPTiBvdXRwdXQgd2lsbCBjb250YWluIG5ld2xpbmVzIGFuZCB3aGl0ZXNwYWNlLgogKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gSlNPTi1pZmllZCBzdHJpbmcgcmVwcmVzZW50aW5nIGBvYmpgLgogKi8KZnVuY3Rpb24gdG9Kc29uKG9iaiwgcHJldHR5KSB7CiAgaWYgKHR5cGVvZiBvYmogPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdW5kZWZpbmVkOwogIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmosIHRvSnNvblJlcGxhY2VyLCBwcmV0dHkgPyAnICAnIDogbnVsbCk7Cn0KCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuZnJvbUpzb24KICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGVzZXJpYWxpemVzIGEgSlNPTiBzdHJpbmcuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBqc29uIEpTT04gc3RyaW5nIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJucyB7T2JqZWN0fEFycmF5fHN0cmluZ3xudW1iZXJ9IERlc2VyaWFsaXplZCB0aGluZ3kuCiAqLwpmdW5jdGlvbiBmcm9tSnNvbihqc29uKSB7CiAgcmV0dXJuIGlzU3RyaW5nKGpzb24pCiAgICAgID8gSlNPTi5wYXJzZShqc29uKQogICAgICA6IGpzb247Cn0KCgovKioKICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBlbGVtZW50LgogKi8KZnVuY3Rpb24gc3RhcnRpbmdUYWcoZWxlbWVudCkgewogIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCkuY2xvbmUoKTsKICB0cnkgewogICAgLy8gdHVybnMgb3V0IElFIGRvZXMgbm90IGxldCB5b3Ugc2V0IC5odG1sKCkgb24gZWxlbWVudHMgd2hpY2gKICAgIC8vIGFyZSBub3QgYWxsb3dlZCB0byBoYXZlIGNoaWxkcmVuLiBTbyB3ZSBqdXN0IGlnbm9yZSBpdC4KICAgIGVsZW1lbnQuZW1wdHkoKTsKICB9IGNhdGNoKGUpIHt9CiAgdmFyIGVsZW1IdG1sID0ganFMaXRlKCc8ZGl2PicpLmFwcGVuZChlbGVtZW50KS5odG1sKCk7CiAgdHJ5IHsKICAgIHJldHVybiBlbGVtZW50WzBdLm5vZGVUeXBlID09PSBOT0RFX1RZUEVfVEVYVCA/IGxvd2VyY2FzZShlbGVtSHRtbCkgOgogICAgICAgIGVsZW1IdG1sLgogICAgICAgICAgbWF0Y2goL14oPFtePl0rPikvKVsxXS4KICAgICAgICAgIHJlcGxhY2UoL148KFtcd1wtXSspLywgZnVuY3Rpb24obWF0Y2gsIG5vZGVOYW1lKSB7IHJldHVybiAnPCcgKyBsb3dlcmNhc2Uobm9kZU5hbWUpOyB9KTsKICB9IGNhdGNoKGUpIHsKICAgIHJldHVybiBsb3dlcmNhc2UoZWxlbUh0bWwpOwogIH0KCn0KCgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgovKioKICogVHJpZXMgdG8gZGVjb2RlIHRoZSBVUkkgY29tcG9uZW50IHdpdGhvdXQgdGhyb3dpbmcgYW4gZXhjZXB0aW9uLgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0gc3RyIHZhbHVlIHBvdGVudGlhbCBVUkkgY29tcG9uZW50IHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGNhbiBiZSBkZWNvZGVkCiAqIHdpdGggdGhlIGRlY29kZVVSSUNvbXBvbmVudCBmdW5jdGlvbi4KICovCmZ1bmN0aW9uIHRyeURlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkgewogIHRyeSB7CiAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICB9IGNhdGNoKGUpIHsKICAgIC8vIElnbm9yZSBhbnkgaW52YWxpZCB1cmkgY29tcG9uZW50CiAgfQp9CgoKLyoqCiAqIFBhcnNlcyBhbiBlc2NhcGVkIHVybCBxdWVyeSBzdHJpbmcgaW50byBrZXktdmFsdWUgcGFpcnMuCiAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZyxib29sZWFufEFycmF5Pn0KICovCmZ1bmN0aW9uIHBhcnNlS2V5VmFsdWUoLyoqc3RyaW5nKi9rZXlWYWx1ZSkgewogIHZhciBvYmogPSB7fSwga2V5X3ZhbHVlLCBrZXk7CiAgZm9yRWFjaCgoa2V5VmFsdWUgfHwgIiIpLnNwbGl0KCcmJyksIGZ1bmN0aW9uKGtleVZhbHVlKSB7CiAgICBpZiAoIGtleVZhbHVlICkgewogICAgICBrZXlfdmFsdWUgPSBrZXlWYWx1ZS5yZXBsYWNlKC9cKy9nLCclMjAnKS5zcGxpdCgnPScpOwogICAgICBrZXkgPSB0cnlEZWNvZGVVUklDb21wb25lbnQoa2V5X3ZhbHVlWzBdKTsKICAgICAgaWYgKCBpc0RlZmluZWQoa2V5KSApIHsKICAgICAgICB2YXIgdmFsID0gaXNEZWZpbmVkKGtleV92YWx1ZVsxXSkgPyB0cnlEZWNvZGVVUklDb21wb25lbnQoa2V5X3ZhbHVlWzFdKSA6IHRydWU7CiAgICAgICAgaWYgKCFoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgewogICAgICAgICAgb2JqW2tleV0gPSB2YWw7CiAgICAgICAgfSBlbHNlIGlmKGlzQXJyYXkob2JqW2tleV0pKSB7CiAgICAgICAgICBvYmpba2V5XS5wdXNoKHZhbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9ialtrZXldID0gW29ialtrZXldLHZhbF07CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CiAgcmV0dXJuIG9iajsKfQoKZnVuY3Rpb24gdG9LZXlWYWx1ZShvYmopIHsKICB2YXIgcGFydHMgPSBbXTsKICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgIGZvckVhY2godmFsdWUsIGZ1bmN0aW9uKGFycmF5VmFsdWUpIHsKICAgICAgICBwYXJ0cy5wdXNoKGVuY29kZVVyaVF1ZXJ5KGtleSwgdHJ1ZSkgKwogICAgICAgICAgICAgICAgICAgKGFycmF5VmFsdWUgPT09IHRydWUgPyAnJyA6ICc9JyArIGVuY29kZVVyaVF1ZXJ5KGFycmF5VmFsdWUsIHRydWUpKSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgIHBhcnRzLnB1c2goZW5jb2RlVXJpUXVlcnkoa2V5LCB0cnVlKSArCiAgICAgICAgICAgICAgICh2YWx1ZSA9PT0gdHJ1ZSA/ICcnIDogJz0nICsgZW5jb2RlVXJpUXVlcnkodmFsdWUsIHRydWUpKSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIHBhcnRzLmxlbmd0aCA/IHBhcnRzLmpvaW4oJyYnKSA6ICcnOwp9CgoKLyoqCiAqIFdlIG5lZWQgb3VyIGN1c3RvbSBtZXRob2QgYmVjYXVzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFnZ3Jlc3NpdmUgYW5kIGRvZXNuJ3QgZm9sbG93CiAqIGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzM5ODYudHh0IHdpdGggcmVnYXJkcyB0byB0aGUgY2hhcmFjdGVyIHNldCAocGNoYXIpIGFsbG93ZWQgaW4gcGF0aAogKiBzZWdtZW50czoKICogICAgc2VnbWVudCAgICAgICA9ICpwY2hhcgogKiAgICBwY2hhciAgICAgICAgID0gdW5yZXNlcnZlZCAvIHBjdC1lbmNvZGVkIC8gc3ViLWRlbGltcyAvICI6IiAvICJAIgogKiAgICBwY3QtZW5jb2RlZCAgID0gIiUiIEhFWERJRyBIRVhESUcKICogICAgdW5yZXNlcnZlZCAgICA9IEFMUEhBIC8gRElHSVQgLyAiLSIgLyAiLiIgLyAiXyIgLyAifiIKICogICAgc3ViLWRlbGltcyAgICA9ICIhIiAvICIkIiAvICImIiAvICInIiAvICIoIiAvICIpIgogKiAgICAgICAgICAgICAgICAgICAgIC8gIioiIC8gIisiIC8gIiwiIC8gIjsiIC8gIj0iCiAqLwpmdW5jdGlvbiBlbmNvZGVVcmlTZWdtZW50KHZhbCkgewogIHJldHVybiBlbmNvZGVVcmlRdWVyeSh2YWwsIHRydWUpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTI2L2dpLCAnJicpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTNEL2dpLCAnPScpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTJCL2dpLCAnKycpOwp9CgoKLyoqCiAqIFRoaXMgbWV0aG9kIGlzIGludGVuZGVkIGZvciBlbmNvZGluZyAqa2V5KiBvciAqdmFsdWUqIHBhcnRzIG9mIHF1ZXJ5IGNvbXBvbmVudC4gV2UgbmVlZCBhIGN1c3RvbQogKiBtZXRob2QgYmVjYXVzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFnZ3Jlc3NpdmUgYW5kIGVuY29kZXMgc3R1ZmYgdGhhdCBkb2Vzbid0IGhhdmUgdG8gYmUKICogZW5jb2RlZCBwZXIgaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzk4NjoKICogICAgcXVlcnkgICAgICAgPSAqKCBwY2hhciAvICIvIiAvICI/IiApCiAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAqICAgIHBjdC1lbmNvZGVkICAgPSAiJSIgSEVYRElHIEhFWERJRwogKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAqICAgICAgICAgICAgICAgICAgICAgLyAiKiIgLyAiKyIgLyAiLCIgLyAiOyIgLyAiPSIKICovCmZ1bmN0aW9uIGVuY29kZVVyaVF1ZXJ5KHZhbCwgcGN0RW5jb2RlU3BhY2VzKSB7CiAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTQwL2dpLCAnQCcpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTNBL2dpLCAnOicpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTI0L2csICckJykuCiAgICAgICAgICAgICByZXBsYWNlKC8lMkMvZ2ksICcsJykuCiAgICAgICAgICAgICByZXBsYWNlKC8lM0IvZ2ksICc7JykuCiAgICAgICAgICAgICByZXBsYWNlKC8lMjAvZywgKHBjdEVuY29kZVNwYWNlcyA/ICclMjAnIDogJysnKSk7Cn0KCnZhciBuZ0F0dHJQcmVmaXhlcyA9IFsnbmctJywgJ2RhdGEtbmctJywgJ25nOicsICd4LW5nLSddOwoKZnVuY3Rpb24gZ2V0TmdBdHRyaWJ1dGUoZWxlbWVudCwgbmdBdHRyKSB7CiAgdmFyIGF0dHIsIGksIGlpID0gbmdBdHRyUHJlZml4ZXMubGVuZ3RoOwogIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CiAgZm9yIChpPTA7IGk8aWk7ICsraSkgewogICAgYXR0ciA9IG5nQXR0clByZWZpeGVzW2ldICsgbmdBdHRyOwogICAgaWYgKGlzU3RyaW5nKGF0dHIgPSBlbGVtZW50LmF0dHIoYXR0cikpKSB7CiAgICAgIHJldHVybiBhdHRyOwogICAgfQogIH0KICByZXR1cm4gbnVsbDsKfQoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdBcHAKICogQG1vZHVsZSBuZwogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHthbmd1bGFyLk1vZHVsZX0gbmdBcHAgYW4gb3B0aW9uYWwgYXBwbGljYXRpb24KICogICB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlfSBuYW1lIHRvIGxvYWQuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IG5nU3RyaWN0RGkgaWYgdGhpcyBhdHRyaWJ1dGUgaXMgcHJlc2VudCBvbiB0aGUgYXBwIGVsZW1lbnQsIHRoZSBpbmplY3RvciB3aWxsIGJlCiAqICAgY3JlYXRlZCBpbiAic3RyaWN0LWRpIiBtb2RlLiBUaGlzIG1lYW5zIHRoYXQgdGhlIGFwcGxpY2F0aW9uIHdpbGwgZmFpbCB0byBpbnZva2UgZnVuY3Rpb25zIHdoaWNoCiAqICAgZG8gbm90IHVzZSBleHBsaWNpdCBmdW5jdGlvbiBhbm5vdGF0aW9uIChhbmQgYXJlIHRodXMgdW5zdWl0YWJsZSBmb3IgbWluaWZpY2F0aW9uKSwgYXMgZGVzY3JpYmVkCiAqICAgaW4ge0BsaW5rIGd1aWRlL2RpIHRoZSBEZXBlbmRlbmN5IEluamVjdGlvbiBndWlkZX0sIGFuZCB1c2VmdWwgZGVidWdnaW5nIGluZm8gd2lsbCBhc3Npc3QgaW4KICogICB0cmFja2luZyBkb3duIHRoZSByb290IG9mIHRoZXNlIGJ1Z3MuCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBVc2UgdGhpcyBkaXJlY3RpdmUgdG8gKiphdXRvLWJvb3RzdHJhcCoqIGFuIEFuZ3VsYXJKUyBhcHBsaWNhdGlvbi4gVGhlIGBuZ0FwcGAgZGlyZWN0aXZlCiAqIGRlc2lnbmF0ZXMgdGhlICoqcm9vdCBlbGVtZW50Kiogb2YgdGhlIGFwcGxpY2F0aW9uIGFuZCBpcyB0eXBpY2FsbHkgcGxhY2VkIG5lYXIgdGhlIHJvb3QgZWxlbWVudAogKiBvZiB0aGUgcGFnZSAtIGUuZy4gb24gdGhlIGA8Ym9keT5gIG9yIGA8aHRtbD5gIHRhZ3MuCiAqCiAqIE9ubHkgb25lIEFuZ3VsYXJKUyBhcHBsaWNhdGlvbiBjYW4gYmUgYXV0by1ib290c3RyYXBwZWQgcGVyIEhUTUwgZG9jdW1lbnQuIFRoZSBmaXJzdCBgbmdBcHBgCiAqIGZvdW5kIGluIHRoZSBkb2N1bWVudCB3aWxsIGJlIHVzZWQgdG8gZGVmaW5lIHRoZSByb290IGVsZW1lbnQgdG8gYXV0by1ib290c3RyYXAgYXMgYW4KICogYXBwbGljYXRpb24uIFRvIHJ1biBtdWx0aXBsZSBhcHBsaWNhdGlvbnMgaW4gYW4gSFRNTCBkb2N1bWVudCB5b3UgbXVzdCBtYW51YWxseSBib290c3RyYXAgdGhlbSB1c2luZwogKiB7QGxpbmsgYW5ndWxhci5ib290c3RyYXB9IGluc3RlYWQuIEFuZ3VsYXJKUyBhcHBsaWNhdGlvbnMgY2Fubm90IGJlIG5lc3RlZCB3aXRoaW4gZWFjaCBvdGhlci4KICoKICogWW91IGNhbiBzcGVjaWZ5IGFuICoqQW5ndWxhckpTIG1vZHVsZSoqIHRvIGJlIHVzZWQgYXMgdGhlIHJvb3QgbW9kdWxlIGZvciB0aGUgYXBwbGljYXRpb24uICBUaGlzCiAqIG1vZHVsZSB3aWxsIGJlIGxvYWRlZCBpbnRvIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3J9IHdoZW4gdGhlIGFwcGxpY2F0aW9uIGlzIGJvb3RzdHJhcHBlZCBhbmQKICogc2hvdWxkIGNvbnRhaW4gdGhlIGFwcGxpY2F0aW9uIGNvZGUgbmVlZGVkIG9yIGhhdmUgZGVwZW5kZW5jaWVzIG9uIG90aGVyIG1vZHVsZXMgdGhhdCB3aWxsCiAqIGNvbnRhaW4gdGhlIGNvZGUuIFNlZSB7QGxpbmsgYW5ndWxhci5tb2R1bGV9IGZvciBtb3JlIGluZm9ybWF0aW9uLgogKgogKiBJbiB0aGUgZXhhbXBsZSBiZWxvdyBpZiB0aGUgYG5nQXBwYCBkaXJlY3RpdmUgd2VyZSBub3QgcGxhY2VkIG9uIHRoZSBgaHRtbGAgZWxlbWVudCB0aGVuIHRoZQogKiBkb2N1bWVudCB3b3VsZCBub3QgYmUgY29tcGlsZWQsIHRoZSBgQXBwQ29udHJvbGxlcmAgd291bGQgbm90IGJlIGluc3RhbnRpYXRlZCBhbmQgdGhlIGB7eyBhK2IgfX1gCiAqIHdvdWxkIG5vdCBiZSByZXNvbHZlZCB0byBgM2AuCiAqCiAqIGBuZ0FwcGAgaXMgdGhlIGVhc2llc3QsIGFuZCBtb3N0IGNvbW1vbiwgd2F5IHRvIGJvb3RzdHJhcCBhbiBhcHBsaWNhdGlvbi4KICoKIDxleGFtcGxlIG1vZHVsZT0ibmdBcHBEZW1vIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctY29udHJvbGxlcj0ibmdBcHBEZW1vQ29udHJvbGxlciI+CiAgICAgSSBjYW4gYWRkOiB7e2F9fSArIHt7Yn19ID0gIHt7IGErYiB9fQogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICBhbmd1bGFyLm1vZHVsZSgnbmdBcHBEZW1vJywgW10pLmNvbnRyb2xsZXIoJ25nQXBwRGVtb0NvbnRyb2xsZXInLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAkc2NvcGUuYSA9IDE7CiAgICAgJHNjb3BlLmIgPSAyOwogICB9KTsKICAgPC9maWxlPgogPC9leGFtcGxlPgogKgogKiBVc2luZyBgbmdTdHJpY3REaWAsIHlvdSB3b3VsZCBzZWUgc29tZXRoaW5nIGxpa2UgdGhpczoKICoKIDxleGFtcGxlIG5nLWFwcC1pbmNsdWRlZD0idHJ1ZSI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8ZGl2IG5nLWFwcD0ibmdBcHBTdHJpY3REZW1vIiBuZy1zdHJpY3QtZGk+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9Ikdvb2RDb250cm9sbGVyMSI+CiAgICAgICAgICAgSSBjYW4gYWRkOiB7e2F9fSArIHt7Yn19ID0gIHt7IGErYiB9fQoKICAgICAgICAgICA8cD5UaGlzIHJlbmRlcnMgYmVjYXVzZSB0aGUgY29udHJvbGxlciBkb2VzIG5vdCBmYWlsIHRvCiAgICAgICAgICAgICAgaW5zdGFudGlhdGUsIGJ5IHVzaW5nIGV4cGxpY2l0IGFubm90YXRpb24gc3R5bGUgKHNlZQogICAgICAgICAgICAgIHNjcmlwdC5qcyBmb3IgZGV0YWlscykKICAgICAgICAgICA8L3A+CiAgICAgICA8L2Rpdj4KCiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9Ikdvb2RDb250cm9sbGVyMiI+CiAgICAgICAgICAgTmFtZTogPGlucHV0IG5nLW1vZGVsPSJuYW1lIj48YnIgLz4KICAgICAgICAgICBIZWxsbywge3tuYW1lfX0hCgogICAgICAgICAgIDxwPlRoaXMgcmVuZGVycyBiZWNhdXNlIHRoZSBjb250cm9sbGVyIGRvZXMgbm90IGZhaWwgdG8KICAgICAgICAgICAgICBpbnN0YW50aWF0ZSwgYnkgdXNpbmcgZXhwbGljaXQgYW5ub3RhdGlvbiBzdHlsZQogICAgICAgICAgICAgIChzZWUgc2NyaXB0LmpzIGZvciBkZXRhaWxzKQogICAgICAgICAgIDwvcD4KICAgICAgIDwvZGl2PgoKICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQmFkQ29udHJvbGxlciI+CiAgICAgICAgICAgSSBjYW4gYWRkOiB7e2F9fSArIHt7Yn19ID0gIHt7IGErYiB9fQoKICAgICAgICAgICA8cD5UaGUgY29udHJvbGxlciBjb3VsZCBub3QgYmUgaW5zdGFudGlhdGVkLCBkdWUgdG8gcmVseWluZwogICAgICAgICAgICAgIG9uIGF1dG9tYXRpYyBmdW5jdGlvbiBhbm5vdGF0aW9ucyAod2hpY2ggYXJlIGRpc2FibGVkIGluCiAgICAgICAgICAgICAgc3RyaWN0IG1vZGUpLiBBcyBzdWNoLCB0aGUgY29udGVudCBvZiB0aGlzIHNlY3Rpb24gaXMgbm90CiAgICAgICAgICAgICAgaW50ZXJwb2xhdGVkLCBhbmQgdGhlcmUgc2hvdWxkIGJlIGFuIGVycm9yIGluIHlvdXIgd2ViIGNvbnNvbGUuCiAgICAgICAgICAgPC9wPgogICAgICAgPC9kaXY+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgIGFuZ3VsYXIubW9kdWxlKCduZ0FwcFN0cmljdERlbW8nLCBbXSkKICAgICAvLyBCYWRDb250cm9sbGVyIHdpbGwgZmFpbCB0byBpbnN0YW50aWF0ZSwgZHVlIHRvIHJlbHlpbmcgb24gYXV0b21hdGljIGZ1bmN0aW9uIGFubm90YXRpb24sCiAgICAgLy8gcmF0aGVyIHRoYW4gYW4gZXhwbGljaXQgYW5ub3RhdGlvbgogICAgIC5jb250cm9sbGVyKCdCYWRDb250cm9sbGVyJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAkc2NvcGUuYSA9IDE7CiAgICAgICAkc2NvcGUuYiA9IDI7CiAgICAgfSkKICAgICAvLyBVbmxpa2UgQmFkQ29udHJvbGxlciwgR29vZENvbnRyb2xsZXIxIGFuZCBHb29kQ29udHJvbGxlcjIgd2lsbCBub3QgZmFpbCB0byBiZSBpbnN0YW50aWF0ZWQsCiAgICAgLy8gZHVlIHRvIHVzaW5nIGV4cGxpY2l0IGFubm90YXRpb25zIHVzaW5nIHRoZSBhcnJheSBzdHlsZSBhbmQgJGluamVjdCBwcm9wZXJ0eSwgcmVzcGVjdGl2ZWx5LgogICAgIC5jb250cm9sbGVyKCdHb29kQ29udHJvbGxlcjEnLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgJHNjb3BlLmEgPSAxOwogICAgICAgJHNjb3BlLmIgPSAyOwogICAgIH1dKQogICAgIC5jb250cm9sbGVyKCdHb29kQ29udHJvbGxlcjInLCBHb29kQ29udHJvbGxlcjIpOwogICAgIGZ1bmN0aW9uIEdvb2RDb250cm9sbGVyMigkc2NvcGUpIHsKICAgICAgICRzY29wZS5uYW1lID0gIldvcmxkIjsKICAgICB9CiAgICAgR29vZENvbnRyb2xsZXIyLiRpbmplY3QgPSBbJyRzY29wZSddOwogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgIGRpdltuZy1jb250cm9sbGVyXSB7CiAgICAgICBtYXJnaW4tYm90dG9tOiAxZW07CiAgICAgICAtd2Via2l0LWJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgIGJvcmRlcjogMXB4IHNvbGlkOwogICAgICAgcGFkZGluZzogLjVlbTsKICAgfQogICBkaXZbbmctY29udHJvbGxlcl49R29vZF0gewogICAgICAgYm9yZGVyLWNvbG9yOiAjZDZlOWM2OwogICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2RmZjBkODsKICAgICAgIGNvbG9yOiAjM2M3NjNkOwogICB9CiAgIGRpdltuZy1jb250cm9sbGVyXj1CYWRdIHsKICAgICAgIGJvcmRlci1jb2xvcjogI2ViY2NkMTsKICAgICAgIGJhY2tncm91bmQtY29sb3I6ICNmMmRlZGU7CiAgICAgICBjb2xvcjogI2E5NDQ0MjsKICAgICAgIG1hcmdpbi1ib3R0b206IDA7CiAgIH0KICAgPC9maWxlPgogPC9leGFtcGxlPgogKi8KZnVuY3Rpb24gYW5ndWxhckluaXQoZWxlbWVudCwgYm9vdHN0cmFwKSB7CiAgdmFyIGFwcEVsZW1lbnQsCiAgICAgIG1vZHVsZSwKICAgICAgY29uZmlnID0ge307CgogIC8vIFRoZSBlbGVtZW50IGBlbGVtZW50YCBoYXMgcHJpb3JpdHkgb3ZlciBhbnkgb3RoZXIgZWxlbWVudAogIGZvckVhY2gobmdBdHRyUHJlZml4ZXMsIGZ1bmN0aW9uKHByZWZpeCkgewogICAgdmFyIG5hbWUgPSBwcmVmaXggKyAnYXBwJzsKCiAgICBpZiAoIWFwcEVsZW1lbnQgJiYgZWxlbWVudC5oYXNBdHRyaWJ1dGUgJiYgZWxlbWVudC5oYXNBdHRyaWJ1dGUobmFtZSkpIHsKICAgICAgYXBwRWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgIG1vZHVsZSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgfQogIH0pOwogIGZvckVhY2gobmdBdHRyUHJlZml4ZXMsIGZ1bmN0aW9uKHByZWZpeCkgewogICAgdmFyIG5hbWUgPSBwcmVmaXggKyAnYXBwJzsKICAgIHZhciBjYW5kaWRhdGU7CgogICAgaWYgKCFhcHBFbGVtZW50ICYmIChjYW5kaWRhdGUgPSBlbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ1snICsgbmFtZS5yZXBsYWNlKCc6JywgJ1xcOicpICsgJ10nKSkpIHsKICAgICAgYXBwRWxlbWVudCA9IGNhbmRpZGF0ZTsKICAgICAgbW9kdWxlID0gY2FuZGlkYXRlLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgIH0KICB9KTsKICBpZiAoYXBwRWxlbWVudCkgewogICAgY29uZmlnLnN0cmljdERpID0gZ2V0TmdBdHRyaWJ1dGUoYXBwRWxlbWVudCwgInN0cmljdC1kaSIpICE9PSBudWxsOwogICAgYm9vdHN0cmFwKGFwcEVsZW1lbnQsIG1vZHVsZSA/IFttb2R1bGVdIDogW10sIGNvbmZpZyk7CiAgfQp9CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuYm9vdHN0cmFwCiAqIEBtb2R1bGUgbmcKICogQGRlc2NyaXB0aW9uCiAqIFVzZSB0aGlzIGZ1bmN0aW9uIHRvIG1hbnVhbGx5IHN0YXJ0IHVwIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAqCiAqIFNlZToge0BsaW5rIGd1aWRlL2Jvb3RzdHJhcCBCb290c3RyYXB9CiAqCiAqIE5vdGUgdGhhdCBQcm90cmFjdG9yIGJhc2VkIGVuZC10by1lbmQgdGVzdHMgY2Fubm90IHVzZSB0aGlzIGZ1bmN0aW9uIHRvIGJvb3RzdHJhcCBtYW51YWxseS4KICogVGhleSBtdXN0IHVzZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQXBwIG5nQXBwfS4KICoKICogQW5ndWxhciB3aWxsIGRldGVjdCBpZiBpdCBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgYnJvd3NlciBtb3JlIHRoYW4gb25jZSBhbmQgb25seSBhbGxvdyB0aGUKICogZmlyc3QgbG9hZGVkIHNjcmlwdCB0byBiZSBib290c3RyYXBwZWQgYW5kIHdpbGwgcmVwb3J0IGEgd2FybmluZyB0byB0aGUgYnJvd3NlciBjb25zb2xlIGZvcgogKiBlYWNoIG9mIHRoZSBzdWJzZXF1ZW50IHNjcmlwdHMuIFRoaXMgcHJldmVudHMgc3RyYW5nZSByZXN1bHRzIGluIGFwcGxpY2F0aW9ucywgd2hlcmUgb3RoZXJ3aXNlCiAqIG11bHRpcGxlIGluc3RhbmNlcyBvZiBBbmd1bGFyIHRyeSB0byB3b3JrIG9uIHRoZSBET00uCiAqCiAqIGBgYGh0bWwKICogPCFkb2N0eXBlIGh0bWw+CiAqIDxodG1sPgogKiA8Ym9keT4KICogPGRpdiBuZy1jb250cm9sbGVyPSJXZWxjb21lQ29udHJvbGxlciI+CiAqICAge3tncmVldGluZ319CiAqIDwvZGl2PgogKgogKiA8c2NyaXB0IHNyYz0iYW5ndWxhci5qcyI+PC9zY3JpcHQ+CiAqIDxzY3JpcHQ+CiAqICAgdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdkZW1vJywgW10pCiAqICAgLmNvbnRyb2xsZXIoJ1dlbGNvbWVDb250cm9sbGVyJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAqICAgICAgICRzY29wZS5ncmVldGluZyA9ICdXZWxjb21lISc7CiAqICAgfSk7CiAqICAgYW5ndWxhci5ib290c3RyYXAoZG9jdW1lbnQsIFsnZGVtbyddKTsKICogPC9zY3JpcHQ+CiAqIDwvYm9keT4KICogPC9odG1sPgogKiBgYGAKICoKICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IERPTSBlbGVtZW50IHdoaWNoIGlzIHRoZSByb290IG9mIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAqIEBwYXJhbSB7QXJyYXk8U3RyaW5nfEZ1bmN0aW9ufEFycmF5Pj19IG1vZHVsZXMgYW4gYXJyYXkgb2YgbW9kdWxlcyB0byBsb2FkIGludG8gdGhlIGFwcGxpY2F0aW9uLgogKiAgICAgRWFjaCBpdGVtIGluIHRoZSBhcnJheSBzaG91bGQgYmUgdGhlIG5hbWUgb2YgYSBwcmVkZWZpbmVkIG1vZHVsZSBvciBhIChESSBhbm5vdGF0ZWQpCiAqICAgICBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgaW52b2tlZCBieSB0aGUgaW5qZWN0b3IgYXMgYSBydW4gYmxvY2suCiAqICAgICBTZWU6IHtAbGluayBhbmd1bGFyLm1vZHVsZSBtb2R1bGVzfQogKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBhbiBvYmplY3QgZm9yIGRlZmluaW5nIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIGFwcGxpY2F0aW9uLiBUaGUKICogICAgIGZvbGxvd2luZyBrZXlzIGFyZSBzdXBwb3J0ZWQ6CiAqCiAqICAgICAtIGBzdHJpY3REaWA6IGRpc2FibGUgYXV0b21hdGljIGZ1bmN0aW9uIGFubm90YXRpb24gZm9yIHRoZSBhcHBsaWNhdGlvbi4gVGhpcyBpcyBtZWFudCB0bwogKiAgICAgICBhc3Npc3QgaW4gZmluZGluZyBidWdzIHdoaWNoIGJyZWFrIG1pbmlmaWVkIGNvZGUuCiAqCiAqIEByZXR1cm5zIHthdXRvLiRpbmplY3Rvcn0gUmV0dXJucyB0aGUgbmV3bHkgY3JlYXRlZCBpbmplY3RvciBmb3IgdGhpcyBhcHAuCiAqLwpmdW5jdGlvbiBib290c3RyYXAoZWxlbWVudCwgbW9kdWxlcywgY29uZmlnKSB7CiAgaWYgKCFpc09iamVjdChjb25maWcpKSBjb25maWcgPSB7fTsKICB2YXIgZGVmYXVsdENvbmZpZyA9IHsKICAgIHN0cmljdERpOiBmYWxzZQogIH07CiAgY29uZmlnID0gZXh0ZW5kKGRlZmF1bHRDb25maWcsIGNvbmZpZyk7CiAgdmFyIGRvQm9vdHN0cmFwID0gZnVuY3Rpb24oKSB7CiAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwoKICAgIGlmIChlbGVtZW50LmluamVjdG9yKCkpIHsKICAgICAgdmFyIHRhZyA9IChlbGVtZW50WzBdID09PSBkb2N1bWVudCkgPyAnZG9jdW1lbnQnIDogc3RhcnRpbmdUYWcoZWxlbWVudCk7CiAgICAgIC8vRW5jb2RlIGFuZ2xlIGJyYWNrZXRzIHRvIHByZXZlbnQgaW5wdXQgZnJvbSBiZWluZyBzYW5pdGl6ZWQgdG8gZW1wdHkgc3RyaW5nICM4NjgzCiAgICAgIHRocm93IG5nTWluRXJyKAogICAgICAgICAgJ2J0c3RycGQnLAogICAgICAgICAgIkFwcCBBbHJlYWR5IEJvb3RzdHJhcHBlZCB3aXRoIHRoaXMgRWxlbWVudCAnezB9JyIsCiAgICAgICAgICB0YWcucmVwbGFjZSgvPC8sJyZsdDsnKS5yZXBsYWNlKC8+LywnJmd0OycpKTsKICAgIH0KCiAgICBtb2R1bGVzID0gbW9kdWxlcyB8fCBbXTsKICAgIG1vZHVsZXMudW5zaGlmdChbJyRwcm92aWRlJywgZnVuY3Rpb24oJHByb3ZpZGUpIHsKICAgICAgJHByb3ZpZGUudmFsdWUoJyRyb290RWxlbWVudCcsIGVsZW1lbnQpOwogICAgfV0pOwoKICAgIGlmIChjb25maWcuZGVidWdJbmZvRW5hYmxlZCkgewogICAgICAvLyBQdXNoaW5nIHNvIHRoYXQgdGhpcyBvdmVycmlkZXMgYGRlYnVnSW5mb0VuYWJsZWRgIHNldHRpbmcgZGVmaW5lZCBpbiB1c2VyJ3MgYG1vZHVsZXNgLgogICAgICBtb2R1bGVzLnB1c2goWyckY29tcGlsZVByb3ZpZGVyJywgZnVuY3Rpb24oJGNvbXBpbGVQcm92aWRlcikgewogICAgICAgICRjb21waWxlUHJvdmlkZXIuZGVidWdJbmZvRW5hYmxlZCh0cnVlKTsKICAgICAgfV0pOwogICAgfQoKICAgIG1vZHVsZXMudW5zaGlmdCgnbmcnKTsKICAgIHZhciBpbmplY3RvciA9IGNyZWF0ZUluamVjdG9yKG1vZHVsZXMsIGNvbmZpZy5zdHJpY3REaSk7CiAgICBpbmplY3Rvci5pbnZva2UoWyckcm9vdFNjb3BlJywgJyRyb290RWxlbWVudCcsICckY29tcGlsZScsICckaW5qZWN0b3InLAogICAgICAgZnVuY3Rpb24gYm9vdHN0cmFwQXBwbHkoc2NvcGUsIGVsZW1lbnQsIGNvbXBpbGUsIGluamVjdG9yKSB7CiAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudC5kYXRhKCckaW5qZWN0b3InLCBpbmplY3Rvcik7CiAgICAgICAgICBjb21waWxlKGVsZW1lbnQpKHNjb3BlKTsKICAgICAgICB9KTsKICAgICAgfV0KICAgICk7CiAgICByZXR1cm4gaW5qZWN0b3I7CiAgfTsKCiAgdmFyIE5HX0VOQUJMRV9ERUJVR19JTkZPID0gL15OR19FTkFCTEVfREVCVUdfSU5GTyEvOwogIHZhciBOR19ERUZFUl9CT09UU1RSQVAgPSAvXk5HX0RFRkVSX0JPT1RTVFJBUCEvOwoKICBpZiAod2luZG93ICYmIE5HX0VOQUJMRV9ERUJVR19JTkZPLnRlc3Qod2luZG93Lm5hbWUpKSB7CiAgICBjb25maWcuZGVidWdJbmZvRW5hYmxlZCA9IHRydWU7CiAgICB3aW5kb3cubmFtZSA9IHdpbmRvdy5uYW1lLnJlcGxhY2UoTkdfRU5BQkxFX0RFQlVHX0lORk8sICcnKTsKICB9CgogIGlmICh3aW5kb3cgJiYgIU5HX0RFRkVSX0JPT1RTVFJBUC50ZXN0KHdpbmRvdy5uYW1lKSkgewogICAgcmV0dXJuIGRvQm9vdHN0cmFwKCk7CiAgfQoKICB3aW5kb3cubmFtZSA9IHdpbmRvdy5uYW1lLnJlcGxhY2UoTkdfREVGRVJfQk9PVFNUUkFQLCAnJyk7CiAgYW5ndWxhci5yZXN1bWVCb290c3RyYXAgPSBmdW5jdGlvbihleHRyYU1vZHVsZXMpIHsKICAgIGZvckVhY2goZXh0cmFNb2R1bGVzLCBmdW5jdGlvbihtb2R1bGUpIHsKICAgICAgbW9kdWxlcy5wdXNoKG1vZHVsZSk7CiAgICB9KTsKICAgIGRvQm9vdHN0cmFwKCk7CiAgfTsKfQoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLnJlbG9hZFdpdGhEZWJ1Z0luZm8KICogQG1vZHVsZSBuZwogKiBAZGVzY3JpcHRpb24KICogVXNlIHRoaXMgZnVuY3Rpb24gdG8gcmVsb2FkIHRoZSBjdXJyZW50IGFwcGxpY2F0aW9uIHdpdGggZGVidWcgaW5mb3JtYXRpb24gdHVybmVkIG9uLgogKiBUaGlzIHRha2VzIHByZWNlZGVuY2Ugb3ZlciBhIGNhbGwgdG8gYCRjb21waWxlUHJvdmlkZXIuZGVidWdJbmZvRW5hYmxlZChmYWxzZSlgLgogKgogKiBTZWUge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGVidWdJbmZvRW5hYmxlZH0gZm9yIG1vcmUuCiAqLwpmdW5jdGlvbiByZWxvYWRXaXRoRGVidWdJbmZvKCkgewogIHdpbmRvdy5uYW1lID0gJ05HX0VOQUJMRV9ERUJVR19JTkZPIScgKyB3aW5kb3cubmFtZTsKICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7Cn0KCi8qKgogKiBAbmFtZSBhbmd1bGFyLmdldFRlc3RhYmlsaXR5CiAqIEBtb2R1bGUgbmcKICogQGRlc2NyaXB0aW9uCiAqIEdldCB0aGUgdGVzdGFiaWxpdHkgc2VydmljZSBmb3IgdGhlIGluc3RhbmNlIG9mIEFuZ3VsYXIgb24gdGhlIGdpdmVuCiAqIGVsZW1lbnQuCiAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCBET00gZWxlbWVudCB3aGljaCBpcyB0aGUgcm9vdCBvZiBhbmd1bGFyIGFwcGxpY2F0aW9uLgogKi8KZnVuY3Rpb24gZ2V0VGVzdGFiaWxpdHkocm9vdEVsZW1lbnQpIHsKICByZXR1cm4gYW5ndWxhci5lbGVtZW50KHJvb3RFbGVtZW50KS5pbmplY3RvcigpLmdldCgnJCR0ZXN0YWJpbGl0eScpOwp9Cgp2YXIgU05BS0VfQ0FTRV9SRUdFWFAgPSAvW0EtWl0vZzsKZnVuY3Rpb24gc25ha2VfY2FzZShuYW1lLCBzZXBhcmF0b3IpIHsKICBzZXBhcmF0b3IgPSBzZXBhcmF0b3IgfHwgJ18nOwogIHJldHVybiBuYW1lLnJlcGxhY2UoU05BS0VfQ0FTRV9SRUdFWFAsIGZ1bmN0aW9uKGxldHRlciwgcG9zKSB7CiAgICByZXR1cm4gKHBvcyA/IHNlcGFyYXRvciA6ICcnKSArIGxldHRlci50b0xvd2VyQ2FzZSgpOwogIH0pOwp9Cgp2YXIgYmluZEpRdWVyeUZpcmVkID0gZmFsc2U7CnZhciBza2lwRGVzdHJveU9uTmV4dEpRdWVyeUNsZWFuRGF0YTsKZnVuY3Rpb24gYmluZEpRdWVyeSgpIHsKICB2YXIgb3JpZ2luYWxDbGVhbkRhdGE7CgogIGlmIChiaW5kSlF1ZXJ5RmlyZWQpIHsKICAgIHJldHVybjsKICB9CgogIC8vIGJpbmQgdG8galF1ZXJ5IGlmIHByZXNlbnQ7CiAgalF1ZXJ5ID0gd2luZG93LmpRdWVyeTsKICAvLyBVc2UgalF1ZXJ5IGlmIGl0IGV4aXN0cyB3aXRoIHByb3BlciBmdW5jdGlvbmFsaXR5LCBvdGhlcndpc2UgZGVmYXVsdCB0byB1cy4KICAvLyBBbmd1bGFyIDEuMisgcmVxdWlyZXMgalF1ZXJ5IDEuNysgZm9yIG9uKCkvb2ZmKCkgc3VwcG9ydC4KICAvLyBBbmd1bGFyIDEuMysgdGVjaG5pY2FsbHkgcmVxdWlyZXMgYXQgbGVhc3QgalF1ZXJ5IDIuMSsgYnV0IGl0IG1heSB3b3JrIHdpdGggb2xkZXIKICAvLyB2ZXJzaW9ucy4gSXQgd2lsbCBub3Qgd29yayBmb3Igc3VyZSB3aXRoIGpRdWVyeSA8MS43LCB0aG91Z2guCiAgaWYgKGpRdWVyeSAmJiBqUXVlcnkuZm4ub24pIHsKICAgIGpxTGl0ZSA9IGpRdWVyeTsKICAgIGV4dGVuZChqUXVlcnkuZm4sIHsKICAgICAgc2NvcGU6IEpRTGl0ZVByb3RvdHlwZS5zY29wZSwKICAgICAgaXNvbGF0ZVNjb3BlOiBKUUxpdGVQcm90b3R5cGUuaXNvbGF0ZVNjb3BlLAogICAgICBjb250cm9sbGVyOiBKUUxpdGVQcm90b3R5cGUuY29udHJvbGxlciwKICAgICAgaW5qZWN0b3I6IEpRTGl0ZVByb3RvdHlwZS5pbmplY3RvciwKICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlUHJvdG90eXBlLmluaGVyaXRlZERhdGEKICAgIH0pOwoKICAgIC8vIEFsbCBub2RlcyByZW1vdmVkIGZyb20gdGhlIERPTSB2aWEgdmFyaW91cyBqUXVlcnkgQVBJcyBsaWtlIC5yZW1vdmUoKQogICAgLy8gYXJlIHBhc3NlZCB0aHJvdWdoIGpRdWVyeS5jbGVhbkRhdGEuIE1vbmtleS1wYXRjaCB0aGlzIG1ldGhvZCB0byBmaXJlCiAgICAvLyB0aGUgJGRlc3Ryb3kgZXZlbnQgb24gYWxsIHJlbW92ZWQgbm9kZXMuCiAgICBvcmlnaW5hbENsZWFuRGF0YSA9IGpRdWVyeS5jbGVhbkRhdGE7CiAgICBqUXVlcnkuY2xlYW5EYXRhID0gZnVuY3Rpb24oZWxlbXMpIHsKICAgICAgdmFyIGV2ZW50czsKICAgICAgaWYgKCFza2lwRGVzdHJveU9uTmV4dEpRdWVyeUNsZWFuRGF0YSkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKyspIHsKICAgICAgICAgIGV2ZW50cyA9IGpRdWVyeS5fZGF0YShlbGVtLCAiZXZlbnRzIik7CiAgICAgICAgICBpZiAoZXZlbnRzICYmIGV2ZW50cy4kZGVzdHJveSkgewogICAgICAgICAgICBqUXVlcnkoZWxlbSkudHJpZ2dlckhhbmRsZXIoJyRkZXN0cm95Jyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHNraXBEZXN0cm95T25OZXh0SlF1ZXJ5Q2xlYW5EYXRhID0gZmFsc2U7CiAgICAgIH0KICAgICAgb3JpZ2luYWxDbGVhbkRhdGEoZWxlbXMpOwogICAgfTsKICB9IGVsc2UgewogICAganFMaXRlID0gSlFMaXRlOwogIH0KCiAgYW5ndWxhci5lbGVtZW50ID0ganFMaXRlOwoKICAvLyBQcmV2ZW50IGRvdWJsZS1wcm94eWluZy4KICBiaW5kSlF1ZXJ5RmlyZWQgPSB0cnVlOwp9CgovKioKICogdGhyb3cgZXJyb3IgaWYgdGhlIGFyZ3VtZW50IGlzIGZhbHN5LgogKi8KZnVuY3Rpb24gYXNzZXJ0QXJnKGFyZywgbmFtZSwgcmVhc29uKSB7CiAgaWYgKCFhcmcpIHsKICAgIHRocm93IG5nTWluRXJyKCdhcmVxJywgIkFyZ3VtZW50ICd7MH0nIGlzIHsxfSIsIChuYW1lIHx8ICc/JyksIChyZWFzb24gfHwgInJlcXVpcmVkIikpOwogIH0KICByZXR1cm4gYXJnOwp9CgpmdW5jdGlvbiBhc3NlcnRBcmdGbihhcmcsIG5hbWUsIGFjY2VwdEFycmF5QW5ub3RhdGlvbikgewogIGlmIChhY2NlcHRBcnJheUFubm90YXRpb24gJiYgaXNBcnJheShhcmcpKSB7CiAgICAgIGFyZyA9IGFyZ1thcmcubGVuZ3RoIC0gMV07CiAgfQoKICBhc3NlcnRBcmcoaXNGdW5jdGlvbihhcmcpLCBuYW1lLCAnbm90IGEgZnVuY3Rpb24sIGdvdCAnICsKICAgICAgKGFyZyAmJiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyA/IGFyZy5jb25zdHJ1Y3Rvci5uYW1lIHx8ICdPYmplY3QnIDogdHlwZW9mIGFyZykpOwogIHJldHVybiBhcmc7Cn0KCi8qKgogKiB0aHJvdyBlcnJvciBpZiB0aGUgbmFtZSBnaXZlbiBpcyBoYXNPd25Qcm9wZXJ0eQogKiBAcGFyYW0gIHtTdHJpbmd9IG5hbWUgICAgdGhlIG5hbWUgdG8gdGVzdAogKiBAcGFyYW0gIHtTdHJpbmd9IGNvbnRleHQgdGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIG5hbWUgaXMgdXNlZCwgc3VjaCBhcyBtb2R1bGUgb3IgZGlyZWN0aXZlCiAqLwpmdW5jdGlvbiBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCBjb250ZXh0KSB7CiAgaWYgKG5hbWUgPT09ICdoYXNPd25Qcm9wZXJ0eScpIHsKICAgIHRocm93IG5nTWluRXJyKCdiYWRuYW1lJywgImhhc093blByb3BlcnR5IGlzIG5vdCBhIHZhbGlkIHswfSBuYW1lIiwgY29udGV4dCk7CiAgfQp9CgovKioKICogUmV0dXJuIHRoZSB2YWx1ZSBhY2Nlc3NpYmxlIGZyb20gdGhlIG9iamVjdCBieSBwYXRoLiBBbnkgdW5kZWZpbmVkIHRyYXZlcnNhbHMgYXJlIGlnbm9yZWQKICogQHBhcmFtIHtPYmplY3R9IG9iaiBzdGFydGluZyBvYmplY3QKICogQHBhcmFtIHtTdHJpbmd9IHBhdGggcGF0aCB0byB0cmF2ZXJzZQogKiBAcGFyYW0ge2Jvb2xlYW59IFtiaW5kRm5Ub1Njb3BlPXRydWVdCiAqIEByZXR1cm5zIHtPYmplY3R9IHZhbHVlIGFzIGFjY2Vzc2libGUgYnkgcGF0aAogKi8KLy9UT0RPKG1pc2tvKTogdGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSByZW1vdmVkCmZ1bmN0aW9uIGdldHRlcihvYmosIHBhdGgsIGJpbmRGblRvU2NvcGUpIHsKICBpZiAoIXBhdGgpIHJldHVybiBvYmo7CiAgdmFyIGtleXMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgdmFyIGtleTsKICB2YXIgbGFzdEluc3RhbmNlID0gb2JqOwogIHZhciBsZW4gPSBrZXlzLmxlbmd0aDsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAga2V5ID0ga2V5c1tpXTsKICAgIGlmIChvYmopIHsKICAgICAgb2JqID0gKGxhc3RJbnN0YW5jZSA9IG9iailba2V5XTsKICAgIH0KICB9CiAgaWYgKCFiaW5kRm5Ub1Njb3BlICYmIGlzRnVuY3Rpb24ob2JqKSkgewogICAgcmV0dXJuIGJpbmQobGFzdEluc3RhbmNlLCBvYmopOwogIH0KICByZXR1cm4gb2JqOwp9CgovKioKICogUmV0dXJuIHRoZSBET00gc2libGluZ3MgYmV0d2VlbiB0aGUgZmlyc3QgYW5kIGxhc3Qgbm9kZSBpbiB0aGUgZ2l2ZW4gYXJyYXkuCiAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IGxpa2Ugb2JqZWN0CiAqIEByZXR1cm5zIHtqcUxpdGV9IGpxTGl0ZSBjb2xsZWN0aW9uIGNvbnRhaW5pbmcgdGhlIG5vZGVzCiAqLwpmdW5jdGlvbiBnZXRCbG9ja05vZGVzKG5vZGVzKSB7CiAgLy8gVE9ETyhwZXJmKToganVzdCBjaGVjayBpZiBhbGwgaXRlbXMgaW4gYG5vZGVzYCBhcmUgc2libGluZ3MgYW5kIGlmIHRoZXkgYXJlIHJldHVybiB0aGUgb3JpZ2luYWwKICAvLyAgICAgICAgICAgICBjb2xsZWN0aW9uLCBvdGhlcndpc2UgdXBkYXRlIHRoZSBvcmlnaW5hbCBjb2xsZWN0aW9uLgogIHZhciBub2RlID0gbm9kZXNbMF07CiAgdmFyIGVuZE5vZGUgPSBub2Rlc1tub2Rlcy5sZW5ndGggLSAxXTsKICB2YXIgYmxvY2tOb2RlcyA9IFtub2RlXTsKCiAgZG8gewogICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICBpZiAoIW5vZGUpIGJyZWFrOwogICAgYmxvY2tOb2Rlcy5wdXNoKG5vZGUpOwogIH0gd2hpbGUgKG5vZGUgIT09IGVuZE5vZGUpOwoKICByZXR1cm4ganFMaXRlKGJsb2NrTm9kZXMpOwp9CgoKLyoqCiAqIENyZWF0ZXMgYSBuZXcgb2JqZWN0IHdpdGhvdXQgYSBwcm90b3R5cGUuIFRoaXMgb2JqZWN0IGlzIHVzZWZ1bCBmb3IgbG9va3VwIHdpdGhvdXQgaGF2aW5nIHRvCiAqIGd1YXJkIGFnYWluc3QgcHJvdG90eXBpY2FsbHkgaW5oZXJpdGVkIHByb3BlcnRpZXMgdmlhIGhhc093blByb3BlcnR5LgogKgogKiBSZWxhdGVkIG1pY3JvLWJlbmNobWFya3M6CiAqIC0gaHR0cDovL2pzcGVyZi5jb20vb2JqZWN0LWNyZWF0ZTIKICogLSBodHRwOi8vanNwZXJmLmNvbS9wcm90by1tYXAtbG9va3VwLzIKICogLSBodHRwOi8vanNwZXJmLmNvbS9mb3ItaW4tdnMtb2JqZWN0LWtleXMyCiAqCiAqIEByZXR1cm5zIHtPYmplY3R9CiAqLwpmdW5jdGlvbiBjcmVhdGVNYXAoKSB7CiAgcmV0dXJuIE9iamVjdC5jcmVhdGUobnVsbCk7Cn0KCnZhciBOT0RFX1RZUEVfRUxFTUVOVCA9IDE7CnZhciBOT0RFX1RZUEVfVEVYVCA9IDM7CnZhciBOT0RFX1RZUEVfQ09NTUVOVCA9IDg7CnZhciBOT0RFX1RZUEVfRE9DVU1FTlQgPSA5Owp2YXIgTk9ERV9UWVBFX0RPQ1VNRU5UX0ZSQUdNRU5UID0gMTE7CgovKioKICogQG5nZG9jIHR5cGUKICogQG5hbWUgYW5ndWxhci5Nb2R1bGUKICogQG1vZHVsZSBuZwogKiBAZGVzY3JpcHRpb24KICoKICogSW50ZXJmYWNlIGZvciBjb25maWd1cmluZyBhbmd1bGFyIHtAbGluayBhbmd1bGFyLm1vZHVsZSBtb2R1bGVzfS4KICovCgpmdW5jdGlvbiBzZXR1cE1vZHVsZUxvYWRlcih3aW5kb3cpIHsKCiAgdmFyICRpbmplY3Rvck1pbkVyciA9IG1pbkVycignJGluamVjdG9yJyk7CiAgdmFyIG5nTWluRXJyID0gbWluRXJyKCduZycpOwoKICBmdW5jdGlvbiBlbnN1cmUob2JqLCBuYW1lLCBmYWN0b3J5KSB7CiAgICByZXR1cm4gb2JqW25hbWVdIHx8IChvYmpbbmFtZV0gPSBmYWN0b3J5KCkpOwogIH0KCiAgdmFyIGFuZ3VsYXIgPSBlbnN1cmUod2luZG93LCAnYW5ndWxhcicsIE9iamVjdCk7CgogIC8vIFdlIG5lZWQgdG8gZXhwb3NlIGBhbmd1bGFyLiQkbWluRXJyYCB0byBtb2R1bGVzIHN1Y2ggYXMgYG5nUmVzb3VyY2VgIHRoYXQgcmVmZXJlbmNlIGl0IGR1cmluZyBib290c3RyYXAKICBhbmd1bGFyLiQkbWluRXJyID0gYW5ndWxhci4kJG1pbkVyciB8fCBtaW5FcnI7CgogIHJldHVybiBlbnN1cmUoYW5ndWxhciwgJ21vZHVsZScsIGZ1bmN0aW9uKCkgewogICAgLyoqIEB0eXBlIHtPYmplY3QuPHN0cmluZywgYW5ndWxhci5Nb2R1bGU+fSAqLwogICAgdmFyIG1vZHVsZXMgPSB7fTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5tb2R1bGUKICAgICAqIEBtb2R1bGUgbmcKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFRoZSBgYW5ndWxhci5tb2R1bGVgIGlzIGEgZ2xvYmFsIHBsYWNlIGZvciBjcmVhdGluZywgcmVnaXN0ZXJpbmcgYW5kIHJldHJpZXZpbmcgQW5ndWxhcgogICAgICogbW9kdWxlcy4KICAgICAqIEFsbCBtb2R1bGVzIChhbmd1bGFyIGNvcmUgb3IgM3JkIHBhcnR5KSB0aGF0IHNob3VsZCBiZSBhdmFpbGFibGUgdG8gYW4gYXBwbGljYXRpb24gbXVzdCBiZQogICAgICogcmVnaXN0ZXJlZCB1c2luZyB0aGlzIG1lY2hhbmlzbS4KICAgICAqCiAgICAgKiBXaGVuIHBhc3NlZCB0d28gb3IgbW9yZSBhcmd1bWVudHMsIGEgbmV3IG1vZHVsZSBpcyBjcmVhdGVkLiAgSWYgcGFzc2VkIG9ubHkgb25lIGFyZ3VtZW50LCBhbgogICAgICogZXhpc3RpbmcgbW9kdWxlICh0aGUgbmFtZSBwYXNzZWQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50IHRvIGBtb2R1bGVgKSBpcyByZXRyaWV2ZWQuCiAgICAgKgogICAgICoKICAgICAqICMgTW9kdWxlCiAgICAgKgogICAgICogQSBtb2R1bGUgaXMgYSBjb2xsZWN0aW9uIG9mIHNlcnZpY2VzLCBkaXJlY3RpdmVzLCBjb250cm9sbGVycywgZmlsdGVycywgYW5kIGNvbmZpZ3VyYXRpb24gaW5mb3JtYXRpb24uCiAgICAgKiBgYW5ndWxhci5tb2R1bGVgIGlzIHVzZWQgdG8gY29uZmlndXJlIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4KICAgICAqCiAgICAgKiBgYGBqcwogICAgICogLy8gQ3JlYXRlIGEgbmV3IG1vZHVsZQogICAgICogdmFyIG15TW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ215TW9kdWxlJywgW10pOwogICAgICoKICAgICAqIC8vIHJlZ2lzdGVyIGEgbmV3IHNlcnZpY2UKICAgICAqIG15TW9kdWxlLnZhbHVlKCdhcHBOYW1lJywgJ015Q29vbEFwcCcpOwogICAgICoKICAgICAqIC8vIGNvbmZpZ3VyZSBleGlzdGluZyBzZXJ2aWNlcyBpbnNpZGUgaW5pdGlhbGl6YXRpb24gYmxvY2tzLgogICAgICogbXlNb2R1bGUuY29uZmlnKFsnJGxvY2F0aW9uUHJvdmlkZXInLCBmdW5jdGlvbigkbG9jYXRpb25Qcm92aWRlcikgewogICAgICogICAvLyBDb25maWd1cmUgZXhpc3RpbmcgcHJvdmlkZXJzCiAgICAgKiAgICRsb2NhdGlvblByb3ZpZGVyLmhhc2hQcmVmaXgoJyEnKTsKICAgICAqIH1dKTsKICAgICAqIGBgYAogICAgICoKICAgICAqIFRoZW4geW91IGNhbiBjcmVhdGUgYW4gaW5qZWN0b3IgYW5kIGxvYWQgeW91ciBtb2R1bGVzIGxpa2UgdGhpczoKICAgICAqCiAgICAgKiBgYGBqcwogICAgICogdmFyIGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcihbJ25nJywgJ215TW9kdWxlJ10pCiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBIb3dldmVyIGl0J3MgbW9yZSBsaWtlbHkgdGhhdCB5b3UnbGwganVzdCB1c2UKICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdBcHAgbmdBcHB9IG9yCiAgICAgKiB7QGxpbmsgYW5ndWxhci5ib290c3RyYXB9IHRvIHNpbXBsaWZ5IHRoaXMgcHJvY2VzcyBmb3IgeW91LgogICAgICoKICAgICAqIEBwYXJhbSB7IXN0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbW9kdWxlIHRvIGNyZWF0ZSBvciByZXRyaWV2ZS4KICAgICAqIEBwYXJhbSB7IUFycmF5LjxzdHJpbmc+PX0gcmVxdWlyZXMgSWYgc3BlY2lmaWVkIHRoZW4gbmV3IG1vZHVsZSBpcyBiZWluZyBjcmVhdGVkLiBJZgogICAgICogICAgICAgIHVuc3BlY2lmaWVkIHRoZW4gdGhlIG1vZHVsZSBpcyBiZWluZyByZXRyaWV2ZWQgZm9yIGZ1cnRoZXIgY29uZmlndXJhdGlvbi4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb249fSBjb25maWdGbiBPcHRpb25hbCBjb25maWd1cmF0aW9uIGZ1bmN0aW9uIGZvciB0aGUgbW9kdWxlLiBTYW1lIGFzCiAgICAgKiAgICAgICAge0BsaW5rIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZyBNb2R1bGUjY29uZmlnKCl9LgogICAgICogQHJldHVybnMge21vZHVsZX0gbmV3IG1vZHVsZSB3aXRoIHRoZSB7QGxpbmsgYW5ndWxhci5Nb2R1bGV9IGFwaS4KICAgICAqLwogICAgcmV0dXJuIGZ1bmN0aW9uIG1vZHVsZShuYW1lLCByZXF1aXJlcywgY29uZmlnRm4pIHsKICAgICAgdmFyIGFzc2VydE5vdEhhc093blByb3BlcnR5ID0gZnVuY3Rpb24obmFtZSwgY29udGV4dCkgewogICAgICAgIGlmIChuYW1lID09PSAnaGFzT3duUHJvcGVydHknKSB7CiAgICAgICAgICB0aHJvdyBuZ01pbkVycignYmFkbmFtZScsICdoYXNPd25Qcm9wZXJ0eSBpcyBub3QgYSB2YWxpZCB7MH0gbmFtZScsIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KG5hbWUsICdtb2R1bGUnKTsKICAgICAgaWYgKHJlcXVpcmVzICYmIG1vZHVsZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBtb2R1bGVzW25hbWVdID0gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gZW5zdXJlKG1vZHVsZXMsIG5hbWUsIGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghcmVxdWlyZXMpIHsKICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycignbm9tb2QnLCAiTW9kdWxlICd7MH0nIGlzIG5vdCBhdmFpbGFibGUhIFlvdSBlaXRoZXIgbWlzc3BlbGxlZCAiICsKICAgICAgICAgICAgICJ0aGUgbW9kdWxlIG5hbWUgb3IgZm9yZ290IHRvIGxvYWQgaXQuIElmIHJlZ2lzdGVyaW5nIGEgbW9kdWxlIGVuc3VyZSB0aGF0IHlvdSAiICsKICAgICAgICAgICAgICJzcGVjaWZ5IHRoZSBkZXBlbmRlbmNpZXMgYXMgdGhlIHNlY29uZCBhcmd1bWVudC4iLCBuYW1lKTsKICAgICAgICB9CgogICAgICAgIC8qKiBAdHlwZSB7IUFycmF5LjxBcnJheS48Kj4+fSAqLwogICAgICAgIHZhciBpbnZva2VRdWV1ZSA9IFtdOwoKICAgICAgICAvKiogQHR5cGUgeyFBcnJheS48RnVuY3Rpb24+fSAqLwogICAgICAgIHZhciBjb25maWdCbG9ja3MgPSBbXTsKCiAgICAgICAgLyoqIEB0eXBlIHshQXJyYXkuPEZ1bmN0aW9uPn0gKi8KICAgICAgICB2YXIgcnVuQmxvY2tzID0gW107CgogICAgICAgIHZhciBjb25maWcgPSBpbnZva2VMYXRlcignJGluamVjdG9yJywgJ2ludm9rZScsICdwdXNoJywgY29uZmlnQmxvY2tzKTsKCiAgICAgICAgLyoqIEB0eXBlIHthbmd1bGFyLk1vZHVsZX0gKi8KICAgICAgICB2YXIgbW9kdWxlSW5zdGFuY2UgPSB7CiAgICAgICAgICAvLyBQcml2YXRlIHN0YXRlCiAgICAgICAgICBfaW52b2tlUXVldWU6IGludm9rZVF1ZXVlLAogICAgICAgICAgX2NvbmZpZ0Jsb2NrczogY29uZmlnQmxvY2tzLAogICAgICAgICAgX3J1bkJsb2NrczogcnVuQmxvY2tzLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNyZXF1aXJlcwogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogSG9sZHMgdGhlIGxpc3Qgb2YgbW9kdWxlcyB3aGljaCB0aGUgaW5qZWN0b3Igd2lsbCBsb2FkIGJlZm9yZSB0aGUgY3VycmVudCBtb2R1bGUgaXMKICAgICAgICAgICAqIGxvYWRlZC4KICAgICAgICAgICAqLwogICAgICAgICAgcmVxdWlyZXM6IHJlcXVpcmVzLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNuYW1lCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBOYW1lIG9mIHRoZSBtb2R1bGUuCiAgICAgICAgICAgKi8KICAgICAgICAgIG5hbWU6IG5hbWUsCgoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjcHJvdmlkZXIKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJvdmlkZXJUeXBlIENvbnN0cnVjdGlvbiBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIHRoZQogICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2UuCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFNlZSB7QGxpbmsgYXV0by4kcHJvdmlkZSNwcm92aWRlciAkcHJvdmlkZS5wcm92aWRlcigpfS4KICAgICAgICAgICAqLwogICAgICAgICAgcHJvdmlkZXI6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdwcm92aWRlcicpLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmFjdG9yeQogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcm92aWRlckZ1bmN0aW9uIEZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgdGhlIHNlcnZpY2UuCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFNlZSB7QGxpbmsgYXV0by4kcHJvdmlkZSNmYWN0b3J5ICRwcm92aWRlLmZhY3RvcnkoKX0uCiAgICAgICAgICAgKi8KICAgICAgICAgIGZhY3Rvcnk6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdmYWN0b3J5JyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNzZXJ2aWNlCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY29uc3RydWN0b3IgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGluc3RhbnRpYXRlZC4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogU2VlIHtAbGluayBhdXRvLiRwcm92aWRlI3NlcnZpY2UgJHByb3ZpZGUuc2VydmljZSgpfS4KICAgICAgICAgICAqLwogICAgICAgICAgc2VydmljZTogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ3NlcnZpY2UnKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3ZhbHVlCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IFNlcnZpY2UgaW5zdGFuY2Ugb2JqZWN0LgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBTZWUge0BsaW5rIGF1dG8uJHByb3ZpZGUjdmFsdWUgJHByb3ZpZGUudmFsdWUoKX0uCiAgICAgICAgICAgKi8KICAgICAgICAgIHZhbHVlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAndmFsdWUnKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnN0YW50CiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBjb25zdGFudCBuYW1lCiAgICAgICAgICAgKiBAcGFyYW0geyp9IG9iamVjdCBDb25zdGFudCB2YWx1ZS4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogQmVjYXVzZSB0aGUgY29uc3RhbnQgYXJlIGZpeGVkLCB0aGV5IGdldCBhcHBsaWVkIGJlZm9yZSBvdGhlciBwcm92aWRlIG1ldGhvZHMuCiAgICAgICAgICAgKiBTZWUge0BsaW5rIGF1dG8uJHByb3ZpZGUjY29uc3RhbnQgJHByb3ZpZGUuY29uc3RhbnQoKX0uCiAgICAgICAgICAgKi8KICAgICAgICAgIGNvbnN0YW50OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnY29uc3RhbnQnLCAndW5zaGlmdCcpLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjYW5pbWF0aW9uCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBhbmltYXRpb24gbmFtZQogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gYW5pbWF0aW9uRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgYW4KICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogKipOT1RFKio6IGFuaW1hdGlvbnMgdGFrZSBlZmZlY3Qgb25seSBpZiB0aGUgKipuZ0FuaW1hdGUqKiBtb2R1bGUgaXMgbG9hZGVkLgogICAgICAgICAgICoKICAgICAgICAgICAqCiAgICAgICAgICAgKiBEZWZpbmVzIGFuIGFuaW1hdGlvbiBob29rIHRoYXQgY2FuIGJlIGxhdGVyIHVzZWQgd2l0aAogICAgICAgICAgICoge0BsaW5rIG5nQW5pbWF0ZS4kYW5pbWF0ZSAkYW5pbWF0ZX0gc2VydmljZSBhbmQgZGlyZWN0aXZlcyB0aGF0IHVzZSB0aGlzIHNlcnZpY2UuCiAgICAgICAgICAgKgogICAgICAgICAgICogYGBganMKICAgICAgICAgICAqIG1vZHVsZS5hbmltYXRpb24oJy5hbmltYXRpb24tbmFtZScsIGZ1bmN0aW9uKCRpbmplY3QxLCAkaW5qZWN0MikgewogICAgICAgICAgICogICByZXR1cm4gewogICAgICAgICAgICogICAgIGV2ZW50TmFtZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAqICAgICAgIC8vY29kZSB0byBydW4gdGhlIGFuaW1hdGlvbgogICAgICAgICAgICogICAgICAgLy9vbmNlIGNvbXBsZXRlLCB0aGVuIHJ1biBkb25lKCkKICAgICAgICAgICAqICAgICAgIHJldHVybiBmdW5jdGlvbiBjYW5jZWxsYXRpb25GdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgKiAgICAgICAgIC8vY29kZSB0byBjYW5jZWwgdGhlIGFuaW1hdGlvbgogICAgICAgICAgICogICAgICAgfQogICAgICAgICAgICogICAgIH0KICAgICAgICAgICAqICAgfQogICAgICAgICAgICogfSkKICAgICAgICAgICAqIGBgYAogICAgICAgICAgICoKICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGFuaW1hdGVQcm92aWRlciNyZWdpc3RlciAkYW5pbWF0ZVByb3ZpZGVyLnJlZ2lzdGVyKCl9IGFuZAogICAgICAgICAgICoge0BsaW5rIG5nQW5pbWF0ZSBuZ0FuaW1hdGUgbW9kdWxlfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAgICAgICAqLwogICAgICAgICAgYW5pbWF0aW9uOiBpbnZva2VMYXRlcignJGFuaW1hdGVQcm92aWRlcicsICdyZWdpc3RlcicpLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmlsdGVyCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBGaWx0ZXIgbmFtZS4KICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZpbHRlckZhY3RvcnkgRmFjdG9yeSBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIGZpbHRlci4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogU2VlIHtAbGluayBuZy4kZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCl9LgogICAgICAgICAgICovCiAgICAgICAgICBmaWx0ZXI6IGludm9rZUxhdGVyKCckZmlsdGVyUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnRyb2xsZXIKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdH0gbmFtZSBDb250cm9sbGVyIG5hbWUsIG9yIGFuIG9iamVjdCBtYXAgb2YgY29udHJvbGxlcnMgd2hlcmUgdGhlCiAgICAgICAgICAgKiAgICBrZXlzIGFyZSB0aGUgbmFtZXMgYW5kIHRoZSB2YWx1ZXMgYXJlIHRoZSBjb25zdHJ1Y3RvcnMuCiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25zdHJ1Y3RvciBDb250cm9sbGVyIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIgJGNvbnRyb2xsZXJQcm92aWRlci5yZWdpc3RlcigpfS4KICAgICAgICAgICAqLwogICAgICAgICAgY29udHJvbGxlcjogaW52b2tlTGF0ZXIoJyRjb250cm9sbGVyUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2RpcmVjdGl2ZQogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fSBuYW1lIERpcmVjdGl2ZSBuYW1lLCBvciBhbiBvYmplY3QgbWFwIG9mIGRpcmVjdGl2ZXMgd2hlcmUgdGhlCiAgICAgICAgICAgKiAgICBrZXlzIGFyZSB0aGUgbmFtZXMgYW5kIHRoZSB2YWx1ZXMgYXJlIHRoZSBmYWN0b3JpZXMuCiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBkaXJlY3RpdmVGYWN0b3J5IEZhY3RvcnkgZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZgogICAgICAgICAgICogZGlyZWN0aXZlcy4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogU2VlIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSAkY29tcGlsZVByb3ZpZGVyLmRpcmVjdGl2ZSgpfS4KICAgICAgICAgICAqLwogICAgICAgICAgZGlyZWN0aXZlOiBpbnZva2VMYXRlcignJGNvbXBpbGVQcm92aWRlcicsICdkaXJlY3RpdmUnKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZwogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uZmlnRm4gRXhlY3V0ZSB0aGlzIGZ1bmN0aW9uIG9uIG1vZHVsZSBsb2FkLiBVc2VmdWwgZm9yIHNlcnZpY2UKICAgICAgICAgICAqICAgIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFVzZSB0aGlzIG1ldGhvZCB0byByZWdpc3RlciB3b3JrIHdoaWNoIG5lZWRzIHRvIGJlIHBlcmZvcm1lZCBvbiBtb2R1bGUgbG9hZGluZy4KICAgICAgICAgICAqIEZvciBtb3JlIGFib3V0IGhvdyB0byBjb25maWd1cmUgc2VydmljZXMsIHNlZQogICAgICAgICAgICoge0BsaW5rIHByb3ZpZGVycyNwcm92aWRlci1yZWNpcGUgUHJvdmlkZXIgUmVjaXBlfS4KICAgICAgICAgICAqLwogICAgICAgICAgY29uZmlnOiBjb25maWcsCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNydW4KICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGluaXRpYWxpemF0aW9uRm4gRXhlY3V0ZSB0aGlzIGZ1bmN0aW9uIGFmdGVyIGluamVjdG9yIGNyZWF0aW9uLgogICAgICAgICAgICogICAgVXNlZnVsIGZvciBhcHBsaWNhdGlvbiBpbml0aWFsaXphdGlvbi4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogVXNlIHRoaXMgbWV0aG9kIHRvIHJlZ2lzdGVyIHdvcmsgd2hpY2ggc2hvdWxkIGJlIHBlcmZvcm1lZCB3aGVuIHRoZSBpbmplY3RvciBpcyBkb25lCiAgICAgICAgICAgKiBsb2FkaW5nIGFsbCBtb2R1bGVzLgogICAgICAgICAgICovCiAgICAgICAgICBydW46IGZ1bmN0aW9uKGJsb2NrKSB7CiAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKGJsb2NrKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgaWYgKGNvbmZpZ0ZuKSB7CiAgICAgICAgICBjb25maWcoY29uZmlnRm4pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICBtb2R1bGVJbnN0YW5jZTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3ZpZGVyCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nPX0gaW5zZXJ0TWV0aG9kCiAgICAgICAgICogQHJldHVybnMge2FuZ3VsYXIuTW9kdWxlfQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGludm9rZUxhdGVyKHByb3ZpZGVyLCBtZXRob2QsIGluc2VydE1ldGhvZCwgcXVldWUpIHsKICAgICAgICAgIGlmICghcXVldWUpIHF1ZXVlID0gaW52b2tlUXVldWU7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHF1ZXVlW2luc2VydE1ldGhvZCB8fCAncHVzaCddKFtwcm92aWRlciwgbWV0aG9kLCBhcmd1bWVudHNdKTsKICAgICAgICAgICAgcmV0dXJuIG1vZHVsZUluc3RhbmNlOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKICB9KTsKCn0KCi8qIGdsb2JhbCBhbmd1bGFyTW9kdWxlOiB0cnVlLAogIHZlcnNpb246IHRydWUsCgogICRMb2NhbGVQcm92aWRlciwKICAkQ29tcGlsZVByb3ZpZGVyLAoKICBodG1sQW5jaG9yRGlyZWN0aXZlLAogIGlucHV0RGlyZWN0aXZlLAogIGlucHV0RGlyZWN0aXZlLAogIGZvcm1EaXJlY3RpdmUsCiAgc2NyaXB0RGlyZWN0aXZlLAogIHNlbGVjdERpcmVjdGl2ZSwKICBzdHlsZURpcmVjdGl2ZSwKICBvcHRpb25EaXJlY3RpdmUsCiAgbmdCaW5kRGlyZWN0aXZlLAogIG5nQmluZEh0bWxEaXJlY3RpdmUsCiAgbmdCaW5kVGVtcGxhdGVEaXJlY3RpdmUsCiAgbmdDbGFzc0RpcmVjdGl2ZSwKICBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSwKICBuZ0NsYXNzT2RkRGlyZWN0aXZlLAogIG5nQ3NwRGlyZWN0aXZlLAogIG5nQ2xvYWtEaXJlY3RpdmUsCiAgbmdDb250cm9sbGVyRGlyZWN0aXZlLAogIG5nRm9ybURpcmVjdGl2ZSwKICBuZ0hpZGVEaXJlY3RpdmUsCiAgbmdJZkRpcmVjdGl2ZSwKICBuZ0luY2x1ZGVEaXJlY3RpdmUsCiAgbmdJbmNsdWRlRmlsbENvbnRlbnREaXJlY3RpdmUsCiAgbmdJbml0RGlyZWN0aXZlLAogIG5nTm9uQmluZGFibGVEaXJlY3RpdmUsCiAgbmdQbHVyYWxpemVEaXJlY3RpdmUsCiAgbmdSZXBlYXREaXJlY3RpdmUsCiAgbmdTaG93RGlyZWN0aXZlLAogIG5nU3R5bGVEaXJlY3RpdmUsCiAgbmdTd2l0Y2hEaXJlY3RpdmUsCiAgbmdTd2l0Y2hXaGVuRGlyZWN0aXZlLAogIG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSwKICBuZ09wdGlvbnNEaXJlY3RpdmUsCiAgbmdUcmFuc2NsdWRlRGlyZWN0aXZlLAogIG5nTW9kZWxEaXJlY3RpdmUsCiAgbmdMaXN0RGlyZWN0aXZlLAogIG5nQ2hhbmdlRGlyZWN0aXZlLAogIHBhdHRlcm5EaXJlY3RpdmUsCiAgcGF0dGVybkRpcmVjdGl2ZSwKICByZXF1aXJlZERpcmVjdGl2ZSwKICByZXF1aXJlZERpcmVjdGl2ZSwKICBtaW5sZW5ndGhEaXJlY3RpdmUsCiAgbWlubGVuZ3RoRGlyZWN0aXZlLAogIG1heGxlbmd0aERpcmVjdGl2ZSwKICBtYXhsZW5ndGhEaXJlY3RpdmUsCiAgbmdWYWx1ZURpcmVjdGl2ZSwKICBuZ01vZGVsT3B0aW9uc0RpcmVjdGl2ZSwKICBuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlcywKICBuZ0V2ZW50RGlyZWN0aXZlcywKCiAgJEFuY2hvclNjcm9sbFByb3ZpZGVyLAogICRBbmltYXRlUHJvdmlkZXIsCiAgJEJyb3dzZXJQcm92aWRlciwKICAkQ2FjaGVGYWN0b3J5UHJvdmlkZXIsCiAgJENvbnRyb2xsZXJQcm92aWRlciwKICAkRG9jdW1lbnRQcm92aWRlciwKICAkRXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyLAogICRGaWx0ZXJQcm92aWRlciwKICAkSW50ZXJwb2xhdGVQcm92aWRlciwKICAkSW50ZXJ2YWxQcm92aWRlciwKICAkSHR0cFByb3ZpZGVyLAogICRIdHRwQmFja2VuZFByb3ZpZGVyLAogICRMb2NhdGlvblByb3ZpZGVyLAogICRMb2dQcm92aWRlciwKICAkUGFyc2VQcm92aWRlciwKICAkUm9vdFNjb3BlUHJvdmlkZXIsCiAgJFFQcm92aWRlciwKICAkJFFQcm92aWRlciwKICAkJFNhbml0aXplVXJpUHJvdmlkZXIsCiAgJFNjZVByb3ZpZGVyLAogICRTY2VEZWxlZ2F0ZVByb3ZpZGVyLAogICRTbmlmZmVyUHJvdmlkZXIsCiAgJFRlbXBsYXRlQ2FjaGVQcm92aWRlciwKICAkVGVtcGxhdGVSZXF1ZXN0UHJvdmlkZXIsCiAgJCRUZXN0YWJpbGl0eVByb3ZpZGVyLAogICRUaW1lb3V0UHJvdmlkZXIsCiAgJCRSQUZQcm92aWRlciwKICAkJEFzeW5jQ2FsbGJhY2tQcm92aWRlciwKICAkV2luZG93UHJvdmlkZXIKKi8KCgovKioKICogQG5nZG9jIG9iamVjdAogKiBAbmFtZSBhbmd1bGFyLnZlcnNpb24KICogQG1vZHVsZSBuZwogKiBAZGVzY3JpcHRpb24KICogQW4gb2JqZWN0IHRoYXQgY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGN1cnJlbnQgQW5ndWxhckpTIHZlcnNpb24uIFRoaXMgb2JqZWN0IGhhcyB0aGUKICogZm9sbG93aW5nIHByb3BlcnRpZXM6CiAqCiAqIC0gYGZ1bGxgIOKAkyBge3N0cmluZ31gIOKAkyBGdWxsIHZlcnNpb24gc3RyaW5nLCBzdWNoIGFzICIwLjkuMTgiLgogKiAtIGBtYWpvcmAg4oCTIGB7bnVtYmVyfWAg4oCTIE1ham9yIHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIwIi4KICogLSBgbWlub3JgIOKAkyBge251bWJlcn1gIOKAkyBNaW5vciB2ZXJzaW9uIG51bWJlciwgc3VjaCBhcyAiOSIuCiAqIC0gYGRvdGAg4oCTIGB7bnVtYmVyfWAg4oCTIERvdCB2ZXJzaW9uIG51bWJlciwgc3VjaCBhcyAiMTgiLgogKiAtIGBjb2RlTmFtZWAg4oCTIGB7c3RyaW5nfWAg4oCTIENvZGUgbmFtZSBvZiB0aGUgcmVsZWFzZSwgc3VjaCBhcyAiamlnZ2xpbmctYXJtZmF0Ii4KICovCnZhciB2ZXJzaW9uID0gewogIGZ1bGw6ICcxLjMuMCcsICAgIC8vIGFsbCBvZiB0aGVzZSBwbGFjZWhvbGRlciBzdHJpbmdzIHdpbGwgYmUgcmVwbGFjZWQgYnkgZ3J1bnQncwogIG1ham9yOiAxLCAgICAvLyBwYWNrYWdlIHRhc2sKICBtaW5vcjogMywKICBkb3Q6IDAsCiAgY29kZU5hbWU6ICdzdXBlcmx1bWluYWwtbnVkZ2UnCn07CgoKZnVuY3Rpb24gcHVibGlzaEV4dGVybmFsQVBJKGFuZ3VsYXIpewogIGV4dGVuZChhbmd1bGFyLCB7CiAgICAnYm9vdHN0cmFwJzogYm9vdHN0cmFwLAogICAgJ2NvcHknOiBjb3B5LAogICAgJ2V4dGVuZCc6IGV4dGVuZCwKICAgICdlcXVhbHMnOiBlcXVhbHMsCiAgICAnZWxlbWVudCc6IGpxTGl0ZSwKICAgICdmb3JFYWNoJzogZm9yRWFjaCwKICAgICdpbmplY3Rvcic6IGNyZWF0ZUluamVjdG9yLAogICAgJ25vb3AnOiBub29wLAogICAgJ2JpbmQnOiBiaW5kLAogICAgJ3RvSnNvbic6IHRvSnNvbiwKICAgICdmcm9tSnNvbic6IGZyb21Kc29uLAogICAgJ2lkZW50aXR5JzogaWRlbnRpdHksCiAgICAnaXNVbmRlZmluZWQnOiBpc1VuZGVmaW5lZCwKICAgICdpc0RlZmluZWQnOiBpc0RlZmluZWQsCiAgICAnaXNTdHJpbmcnOiBpc1N0cmluZywKICAgICdpc0Z1bmN0aW9uJzogaXNGdW5jdGlvbiwKICAgICdpc09iamVjdCc6IGlzT2JqZWN0LAogICAgJ2lzTnVtYmVyJzogaXNOdW1iZXIsCiAgICAnaXNFbGVtZW50JzogaXNFbGVtZW50LAogICAgJ2lzQXJyYXknOiBpc0FycmF5LAogICAgJ3ZlcnNpb24nOiB2ZXJzaW9uLAogICAgJ2lzRGF0ZSc6IGlzRGF0ZSwKICAgICdsb3dlcmNhc2UnOiBsb3dlcmNhc2UsCiAgICAndXBwZXJjYXNlJzogdXBwZXJjYXNlLAogICAgJ2NhbGxiYWNrcyc6IHtjb3VudGVyOiAwfSwKICAgICdnZXRUZXN0YWJpbGl0eSc6IGdldFRlc3RhYmlsaXR5LAogICAgJyQkbWluRXJyJzogbWluRXJyLAogICAgJyQkY3NwJzogY3NwLAogICAgJ3JlbG9hZFdpdGhEZWJ1Z0luZm8nOiByZWxvYWRXaXRoRGVidWdJbmZvCiAgfSk7CgogIGFuZ3VsYXJNb2R1bGUgPSBzZXR1cE1vZHVsZUxvYWRlcih3aW5kb3cpOwogIHRyeSB7CiAgICBhbmd1bGFyTW9kdWxlKCduZ0xvY2FsZScpOwogIH0gY2F0Y2ggKGUpIHsKICAgIGFuZ3VsYXJNb2R1bGUoJ25nTG9jYWxlJywgW10pLnByb3ZpZGVyKCckbG9jYWxlJywgJExvY2FsZVByb3ZpZGVyKTsKICB9CgogIGFuZ3VsYXJNb2R1bGUoJ25nJywgWyduZ0xvY2FsZSddLCBbJyRwcm92aWRlJywKICAgIGZ1bmN0aW9uIG5nTW9kdWxlKCRwcm92aWRlKSB7CiAgICAgIC8vICQkc2FuaXRpemVVcmlQcm92aWRlciBuZWVkcyB0byBiZSBiZWZvcmUgJGNvbXBpbGVQcm92aWRlciBhcyBpdCBpcyB1c2VkIGJ5IGl0LgogICAgICAkcHJvdmlkZS5wcm92aWRlcih7CiAgICAgICAgJCRzYW5pdGl6ZVVyaTogJCRTYW5pdGl6ZVVyaVByb3ZpZGVyCiAgICAgIH0pOwogICAgICAkcHJvdmlkZS5wcm92aWRlcignJGNvbXBpbGUnLCAkQ29tcGlsZVByb3ZpZGVyKS4KICAgICAgICBkaXJlY3RpdmUoewogICAgICAgICAgICBhOiBodG1sQW5jaG9yRGlyZWN0aXZlLAogICAgICAgICAgICBpbnB1dDogaW5wdXREaXJlY3RpdmUsCiAgICAgICAgICAgIHRleHRhcmVhOiBpbnB1dERpcmVjdGl2ZSwKICAgICAgICAgICAgZm9ybTogZm9ybURpcmVjdGl2ZSwKICAgICAgICAgICAgc2NyaXB0OiBzY3JpcHREaXJlY3RpdmUsCiAgICAgICAgICAgIHNlbGVjdDogc2VsZWN0RGlyZWN0aXZlLAogICAgICAgICAgICBzdHlsZTogc3R5bGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG9wdGlvbjogb3B0aW9uRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0JpbmQ6IG5nQmluZERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdCaW5kSHRtbDogbmdCaW5kSHRtbERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdCaW5kVGVtcGxhdGU6IG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0NsYXNzOiBuZ0NsYXNzRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0NsYXNzRXZlbjogbmdDbGFzc0V2ZW5EaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQ2xhc3NPZGQ6IG5nQ2xhc3NPZGREaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQ2xvYWs6IG5nQ2xvYWtEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQ29udHJvbGxlcjogbmdDb250cm9sbGVyRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0Zvcm06IG5nRm9ybURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdIaWRlOiBuZ0hpZGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nSWY6IG5nSWZEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nSW5jbHVkZTogbmdJbmNsdWRlRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0luaXQ6IG5nSW5pdERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdOb25CaW5kYWJsZTogbmdOb25CaW5kYWJsZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdQbHVyYWxpemU6IG5nUGx1cmFsaXplRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1JlcGVhdDogbmdSZXBlYXREaXJlY3RpdmUsCiAgICAgICAgICAgIG5nU2hvdzogbmdTaG93RGlyZWN0aXZlLAogICAgICAgICAgICBuZ1N0eWxlOiBuZ1N0eWxlRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1N3aXRjaDogbmdTd2l0Y2hEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nU3dpdGNoV2hlbjogbmdTd2l0Y2hXaGVuRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1N3aXRjaERlZmF1bHQ6IG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdPcHRpb25zOiBuZ09wdGlvbnNEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nVHJhbnNjbHVkZTogbmdUcmFuc2NsdWRlRGlyZWN0aXZlLAogICAgICAgICAgICBuZ01vZGVsOiBuZ01vZGVsRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0xpc3Q6IG5nTGlzdERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdDaGFuZ2U6IG5nQ2hhbmdlRGlyZWN0aXZlLAogICAgICAgICAgICBwYXR0ZXJuOiBwYXR0ZXJuRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1BhdHRlcm46IHBhdHRlcm5EaXJlY3RpdmUsCiAgICAgICAgICAgIHJlcXVpcmVkOiByZXF1aXJlZERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdSZXF1aXJlZDogcmVxdWlyZWREaXJlY3RpdmUsCiAgICAgICAgICAgIG1pbmxlbmd0aDogbWlubGVuZ3RoRGlyZWN0aXZlLAogICAgICAgICAgICBuZ01pbmxlbmd0aDogbWlubGVuZ3RoRGlyZWN0aXZlLAogICAgICAgICAgICBtYXhsZW5ndGg6IG1heGxlbmd0aERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdNYXhsZW5ndGg6IG1heGxlbmd0aERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdWYWx1ZTogbmdWYWx1ZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdNb2RlbE9wdGlvbnM6IG5nTW9kZWxPcHRpb25zRGlyZWN0aXZlCiAgICAgICAgfSkuCiAgICAgICAgZGlyZWN0aXZlKHsKICAgICAgICAgIG5nSW5jbHVkZTogbmdJbmNsdWRlRmlsbENvbnRlbnREaXJlY3RpdmUKICAgICAgICB9KS4KICAgICAgICBkaXJlY3RpdmUobmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXMpLgogICAgICAgIGRpcmVjdGl2ZShuZ0V2ZW50RGlyZWN0aXZlcyk7CiAgICAgICRwcm92aWRlLnByb3ZpZGVyKHsKICAgICAgICAkYW5jaG9yU2Nyb2xsOiAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIsCiAgICAgICAgJGFuaW1hdGU6ICRBbmltYXRlUHJvdmlkZXIsCiAgICAgICAgJGJyb3dzZXI6ICRCcm93c2VyUHJvdmlkZXIsCiAgICAgICAgJGNhY2hlRmFjdG9yeTogJENhY2hlRmFjdG9yeVByb3ZpZGVyLAogICAgICAgICRjb250cm9sbGVyOiAkQ29udHJvbGxlclByb3ZpZGVyLAogICAgICAgICRkb2N1bWVudDogJERvY3VtZW50UHJvdmlkZXIsCiAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXI6ICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIsCiAgICAgICAgJGZpbHRlcjogJEZpbHRlclByb3ZpZGVyLAogICAgICAgICRpbnRlcnBvbGF0ZTogJEludGVycG9sYXRlUHJvdmlkZXIsCiAgICAgICAgJGludGVydmFsOiAkSW50ZXJ2YWxQcm92aWRlciwKICAgICAgICAkaHR0cDogJEh0dHBQcm92aWRlciwKICAgICAgICAkaHR0cEJhY2tlbmQ6ICRIdHRwQmFja2VuZFByb3ZpZGVyLAogICAgICAgICRsb2NhdGlvbjogJExvY2F0aW9uUHJvdmlkZXIsCiAgICAgICAgJGxvZzogJExvZ1Byb3ZpZGVyLAogICAgICAgICRwYXJzZTogJFBhcnNlUHJvdmlkZXIsCiAgICAgICAgJHJvb3RTY29wZTogJFJvb3RTY29wZVByb3ZpZGVyLAogICAgICAgICRxOiAkUVByb3ZpZGVyLAogICAgICAgICQkcTogJCRRUHJvdmlkZXIsCiAgICAgICAgJHNjZTogJFNjZVByb3ZpZGVyLAogICAgICAgICRzY2VEZWxlZ2F0ZTogJFNjZURlbGVnYXRlUHJvdmlkZXIsCiAgICAgICAgJHNuaWZmZXI6ICRTbmlmZmVyUHJvdmlkZXIsCiAgICAgICAgJHRlbXBsYXRlQ2FjaGU6ICRUZW1wbGF0ZUNhY2hlUHJvdmlkZXIsCiAgICAgICAgJHRlbXBsYXRlUmVxdWVzdDogJFRlbXBsYXRlUmVxdWVzdFByb3ZpZGVyLAogICAgICAgICQkdGVzdGFiaWxpdHk6ICQkVGVzdGFiaWxpdHlQcm92aWRlciwKICAgICAgICAkdGltZW91dDogJFRpbWVvdXRQcm92aWRlciwKICAgICAgICAkd2luZG93OiAkV2luZG93UHJvdmlkZXIsCiAgICAgICAgJCRyQUY6ICQkUkFGUHJvdmlkZXIsCiAgICAgICAgJCRhc3luY0NhbGxiYWNrIDogJCRBc3luY0NhbGxiYWNrUHJvdmlkZXIKICAgICAgfSk7CiAgICB9CiAgXSk7Cn0KCi8qIGdsb2JhbCBKUUxpdGVQcm90b3R5cGU6IHRydWUsCiAgYWRkRXZlbnRMaXN0ZW5lckZuOiB0cnVlLAogIHJlbW92ZUV2ZW50TGlzdGVuZXJGbjogdHJ1ZSwKICBCT09MRUFOX0FUVFI6IHRydWUsCiAgQUxJQVNFRF9BVFRSOiB0cnVlLAoqLwoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovL0pRTGl0ZQovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuZWxlbWVudAogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBXcmFwcyBhIHJhdyBET00gZWxlbWVudCBvciBIVE1MIHN0cmluZyBhcyBhIFtqUXVlcnldKGh0dHA6Ly9qcXVlcnkuY29tKSBlbGVtZW50LgogKgogKiBJZiBqUXVlcnkgaXMgYXZhaWxhYmxlLCBgYW5ndWxhci5lbGVtZW50YCBpcyBhbiBhbGlhcyBmb3IgdGhlCiAqIFtqUXVlcnldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9qUXVlcnkvKSBmdW5jdGlvbi4gSWYgalF1ZXJ5IGlzIG5vdCBhdmFpbGFibGUsIGBhbmd1bGFyLmVsZW1lbnRgCiAqIGRlbGVnYXRlcyB0byBBbmd1bGFyJ3MgYnVpbHQtaW4gc3Vic2V0IG9mIGpRdWVyeSwgY2FsbGVkICJqUXVlcnkgbGl0ZSIgb3IgImpxTGl0ZS4iCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXN1Y2Nlc3MiPmpxTGl0ZSBpcyBhIHRpbnksIEFQSS1jb21wYXRpYmxlIHN1YnNldCBvZiBqUXVlcnkgdGhhdCBhbGxvd3MKICogQW5ndWxhciB0byBtYW5pcHVsYXRlIHRoZSBET00gaW4gYSBjcm9zcy1icm93c2VyIGNvbXBhdGlibGUgd2F5LiAqKmpxTGl0ZSoqIGltcGxlbWVudHMgb25seSB0aGUgbW9zdAogKiBjb21tb25seSBuZWVkZWQgZnVuY3Rpb25hbGl0eSB3aXRoIHRoZSBnb2FsIG9mIGhhdmluZyBhIHZlcnkgc21hbGwgZm9vdHByaW50LjwvZGl2PgogKgogKiBUbyB1c2UgalF1ZXJ5LCBzaW1wbHkgbG9hZCBpdCBiZWZvcmUgYERPTUNvbnRlbnRMb2FkZWRgIGV2ZW50IGZpcmVkLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCI+KipOb3RlOioqIGFsbCBlbGVtZW50IHJlZmVyZW5jZXMgaW4gQW5ndWxhciBhcmUgYWx3YXlzIHdyYXBwZWQgd2l0aCBqUXVlcnkgb3IKICoganFMaXRlOyB0aGV5IGFyZSBuZXZlciByYXcgRE9NIHJlZmVyZW5jZXMuPC9kaXY+CiAqCiAqICMjIEFuZ3VsYXIncyBqcUxpdGUKICoganFMaXRlIHByb3ZpZGVzIG9ubHkgdGhlIGZvbGxvd2luZyBqUXVlcnkgbWV0aG9kczoKICoKICogLSBbYGFkZENsYXNzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYWRkQ2xhc3MvKQogKiAtIFtgYWZ0ZXIoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hZnRlci8pCiAqIC0gW2BhcHBlbmQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hcHBlbmQvKQogKiAtIFtgYXR0cigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2F0dHIvKSAtIERvZXMgbm90IHN1cHBvcnQgZnVuY3Rpb25zIGFzIHBhcmFtZXRlcnMKICogLSBbYGJpbmQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9iaW5kLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMsIHNlbGVjdG9ycyBvciBldmVudERhdGEKICogLSBbYGNoaWxkcmVuKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY2hpbGRyZW4vKSAtIERvZXMgbm90IHN1cHBvcnQgc2VsZWN0b3JzCiAqIC0gW2BjbG9uZSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2Nsb25lLykKICogLSBbYGNvbnRlbnRzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY29udGVudHMvKQogKiAtIFtgY3NzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY3NzLykgLSBPbmx5IHJldHJpZXZlcyBpbmxpbmUtc3R5bGVzLCBkb2VzIG5vdCBjYWxsIGBnZXRDb21wdXRlZFN0eWxlcygpYAogKiAtIFtgZGF0YSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2RhdGEvKQogKiAtIFtgZGV0YWNoKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZGV0YWNoLykKICogLSBbYGVtcHR5KClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZW1wdHkvKQogKiAtIFtgZXEoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9lcS8pCiAqIC0gW2BmaW5kKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZmluZC8pIC0gTGltaXRlZCB0byBsb29rdXBzIGJ5IHRhZyBuYW1lCiAqIC0gW2BoYXNDbGFzcygpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2hhc0NsYXNzLykKICogLSBbYGh0bWwoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9odG1sLykKICogLSBbYG5leHQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9uZXh0LykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogKiAtIFtgb24oKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9vbi8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzLCBzZWxlY3RvcnMgb3IgZXZlbnREYXRhCiAqIC0gW2BvZmYoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9vZmYvKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcyBvciBzZWxlY3RvcnMKICogLSBbYG9uZSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29uZS8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzIG9yIHNlbGVjdG9ycwogKiAtIFtgcGFyZW50KClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcGFyZW50LykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogKiAtIFtgcHJlcGVuZCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ByZXBlbmQvKQogKiAtIFtgcHJvcCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3Byb3AvKQogKiAtIFtgcmVhZHkoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZWFkeS8pCiAqIC0gW2ByZW1vdmUoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmUvKQogKiAtIFtgcmVtb3ZlQXR0cigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZUF0dHIvKQogKiAtIFtgcmVtb3ZlQ2xhc3MoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmVDbGFzcy8pCiAqIC0gW2ByZW1vdmVEYXRhKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlRGF0YS8pCiAqIC0gW2ByZXBsYWNlV2l0aCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlcGxhY2VXaXRoLykKICogLSBbYHRleHQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS90ZXh0LykKICogLSBbYHRvZ2dsZUNsYXNzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdG9nZ2xlQ2xhc3MvKQogKiAtIFtgdHJpZ2dlckhhbmRsZXIoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS90cmlnZ2VySGFuZGxlci8pIC0gUGFzc2VzIGEgZHVtbXkgZXZlbnQgb2JqZWN0IHRvIGhhbmRsZXJzLgogKiAtIFtgdW5iaW5kKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdW5iaW5kLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMKICogLSBbYHZhbCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ZhbC8pCiAqIC0gW2B3cmFwKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vd3JhcC8pCiAqCiAqICMjIGpRdWVyeS9qcUxpdGUgRXh0cmFzCiAqIEFuZ3VsYXIgYWxzbyBwcm92aWRlcyB0aGUgZm9sbG93aW5nIGFkZGl0aW9uYWwgbWV0aG9kcyBhbmQgZXZlbnRzIHRvIGJvdGggalF1ZXJ5IGFuZCBqcUxpdGU6CiAqCiAqICMjIyBFdmVudHMKICogLSBgJGRlc3Ryb3lgIC0gQW5ndWxhckpTIGludGVyY2VwdHMgYWxsIGpxTGl0ZS9qUXVlcnkncyBET00gZGVzdHJ1Y3Rpb24gYXBpcyBhbmQgZmlyZXMgdGhpcyBldmVudAogKiAgICBvbiBhbGwgRE9NIG5vZGVzIGJlaW5nIHJlbW92ZWQuICBUaGlzIGNhbiBiZSB1c2VkIHRvIGNsZWFuIHVwIGFueSAzcmQgcGFydHkgYmluZGluZ3MgdG8gdGhlIERPTQogKiAgICBlbGVtZW50IGJlZm9yZSBpdCBpcyByZW1vdmVkLgogKgogKiAjIyMgTWV0aG9kcwogKiAtIGBjb250cm9sbGVyKG5hbWUpYCAtIHJldHJpZXZlcyB0aGUgY29udHJvbGxlciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuIEJ5IGRlZmF1bHQKICogICByZXRyaWV2ZXMgY29udHJvbGxlciBhc3NvY2lhdGVkIHdpdGggdGhlIGBuZ0NvbnRyb2xsZXJgIGRpcmVjdGl2ZS4gSWYgYG5hbWVgIGlzIHByb3ZpZGVkIGFzCiAqICAgY2FtZWxDYXNlIGRpcmVjdGl2ZSBuYW1lLCB0aGVuIHRoZSBjb250cm9sbGVyIGZvciB0aGlzIGRpcmVjdGl2ZSB3aWxsIGJlIHJldHJpZXZlZCAoZS5nLgogKiAgIGAnbmdNb2RlbCdgKS4KICogLSBgaW5qZWN0b3IoKWAgLSByZXRyaWV2ZXMgdGhlIGluamVjdG9yIG9mIHRoZSBjdXJyZW50IGVsZW1lbnQgb3IgaXRzIHBhcmVudC4KICogLSBgc2NvcGUoKWAgLSByZXRyaWV2ZXMgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBvZiB0aGUgY3VycmVudAogKiAgIGVsZW1lbnQgb3IgaXRzIHBhcmVudC4KICogLSBgaXNvbGF0ZVNjb3BlKClgIC0gcmV0cmlldmVzIGFuIGlzb2xhdGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9IGlmIG9uZSBpcyBhdHRhY2hlZCBkaXJlY3RseSB0byB0aGUKICogICBjdXJyZW50IGVsZW1lbnQuIFRoaXMgZ2V0dGVyIHNob3VsZCBiZSB1c2VkIG9ubHkgb24gZWxlbWVudHMgdGhhdCBjb250YWluIGEgZGlyZWN0aXZlIHdoaWNoIHN0YXJ0cyBhIG5ldyBpc29sYXRlCiAqICAgc2NvcGUuIENhbGxpbmcgYHNjb3BlKClgIG9uIHRoaXMgZWxlbWVudCBhbHdheXMgcmV0dXJucyB0aGUgb3JpZ2luYWwgbm9uLWlzb2xhdGUgc2NvcGUuCiAqIC0gYGluaGVyaXRlZERhdGEoKWAgLSBzYW1lIGFzIGBkYXRhKClgLCBidXQgd2Fsa3MgdXAgdGhlIERPTSB1bnRpbCBhIHZhbHVlIGlzIGZvdW5kIG9yIHRoZSB0b3AKICogICBwYXJlbnQgZWxlbWVudCBpcyByZWFjaGVkLgogKgogKiBAcGFyYW0ge3N0cmluZ3xET01FbGVtZW50fSBlbGVtZW50IEhUTUwgc3RyaW5nIG9yIERPTUVsZW1lbnQgdG8gYmUgd3JhcHBlZCBpbnRvIGpRdWVyeS4KICogQHJldHVybnMge09iamVjdH0galF1ZXJ5IG9iamVjdC4KICovCgpKUUxpdGUuZXhwYW5kbyA9ICduZzMzOSc7Cgp2YXIganFDYWNoZSA9IEpRTGl0ZS5jYWNoZSA9IHt9LAogICAganFJZCA9IDEsCiAgICBhZGRFdmVudExpc3RlbmVyRm4gPSBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbikgewogICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsKICAgIH0sCiAgICByZW1vdmVFdmVudExpc3RlbmVyRm4gPSBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbikgewogICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsKICAgIH07CgovKgogKiAhISEgVGhpcyBpcyBhbiB1bmRvY3VtZW50ZWQgInByaXZhdGUiIGZ1bmN0aW9uICEhIQogKi8KSlFMaXRlLl9kYXRhID0gZnVuY3Rpb24obm9kZSkgewogIC8valF1ZXJ5IGFsd2F5cyByZXR1cm5zIGFuIG9iamVjdCBvbiBjYWNoZSBtaXNzCiAgcmV0dXJuIHRoaXMuY2FjaGVbbm9kZVt0aGlzLmV4cGFuZG9dXSB8fCB7fTsKfTsKCmZ1bmN0aW9uIGpxTmV4dElkKCkgeyByZXR1cm4gKytqcUlkOyB9CgoKdmFyIFNQRUNJQUxfQ0hBUlNfUkVHRVhQID0gLyhbXDpcLVxfXSsoLikpL2c7CnZhciBNT1pfSEFDS19SRUdFWFAgPSAvXm1veihbQS1aXSkvOwp2YXIgTU9VU0VfRVZFTlRfTUFQPSB7IG1vdXNlbGVhdmUgOiAibW91c2VvdXQiLCBtb3VzZWVudGVyIDogIm1vdXNlb3ZlciJ9Owp2YXIganFMaXRlTWluRXJyID0gbWluRXJyKCdqcUxpdGUnKTsKCi8qKgogKiBDb252ZXJ0cyBzbmFrZV9jYXNlIHRvIGNhbWVsQ2FzZS4KICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICogQHBhcmFtIG5hbWUgTmFtZSB0byBub3JtYWxpemUKICovCmZ1bmN0aW9uIGNhbWVsQ2FzZShuYW1lKSB7CiAgcmV0dXJuIG5hbWUuCiAgICByZXBsYWNlKFNQRUNJQUxfQ0hBUlNfUkVHRVhQLCBmdW5jdGlvbihfLCBzZXBhcmF0b3IsIGxldHRlciwgb2Zmc2V0KSB7CiAgICAgIHJldHVybiBvZmZzZXQgPyBsZXR0ZXIudG9VcHBlckNhc2UoKSA6IGxldHRlcjsKICAgIH0pLgogICAgcmVwbGFjZShNT1pfSEFDS19SRUdFWFAsICdNb3okMScpOwp9Cgp2YXIgU0lOR0xFX1RBR19SRUdFWFAgPSAvXjwoXHcrKVxzKlwvPz4oPzo8XC9cMT58KSQvOwp2YXIgSFRNTF9SRUdFWFAgPSAvPHwmIz9cdys7LzsKdmFyIFRBR19OQU1FX1JFR0VYUCA9IC88KFtcdzpdKykvOwp2YXIgWEhUTUxfVEFHX1JFR0VYUCA9IC88KD8hYXJlYXxicnxjb2x8ZW1iZWR8aHJ8aW1nfGlucHV0fGxpbmt8bWV0YXxwYXJhbSkoKFtcdzpdKylbXj5dKilcLz4vZ2k7Cgp2YXIgd3JhcE1hcCA9IHsKICAnb3B0aW9uJzogWzEsICc8c2VsZWN0IG11bHRpcGxlPSJtdWx0aXBsZSI+JywgJzwvc2VsZWN0PiddLAoKICAndGhlYWQnOiBbMSwgJzx0YWJsZT4nLCAnPC90YWJsZT4nXSwKICAnY29sJzogWzIsICc8dGFibGU+PGNvbGdyb3VwPicsICc8L2NvbGdyb3VwPjwvdGFibGU+J10sCiAgJ3RyJzogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCiAgJ3RkJzogWzMsICc8dGFibGU+PHRib2R5Pjx0cj4nLCAnPC90cj48L3Rib2R5PjwvdGFibGU+J10sCiAgJ19kZWZhdWx0JzogWzAsICIiLCAiIl0KfTsKCndyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbjsKd3JhcE1hcC50Ym9keSA9IHdyYXBNYXAudGZvb3QgPSB3cmFwTWFwLmNvbGdyb3VwID0gd3JhcE1hcC5jYXB0aW9uID0gd3JhcE1hcC50aGVhZDsKd3JhcE1hcC50aCA9IHdyYXBNYXAudGQ7CgoKZnVuY3Rpb24ganFMaXRlSXNUZXh0Tm9kZShodG1sKSB7CiAgcmV0dXJuICFIVE1MX1JFR0VYUC50ZXN0KGh0bWwpOwp9CgpmdW5jdGlvbiBqcUxpdGVBY2NlcHRzRGF0YShub2RlKSB7CiAgLy8gVGhlIHdpbmRvdyBvYmplY3QgY2FuIGFjY2VwdCBkYXRhIGJ1dCBoYXMgbm8gbm9kZVR5cGUKICAvLyBPdGhlcndpc2Ugd2UgYXJlIG9ubHkgaW50ZXJlc3RlZCBpbiBlbGVtZW50cyAoMSkgYW5kIGRvY3VtZW50cyAoOSkKICB2YXIgbm9kZVR5cGUgPSBub2RlLm5vZGVUeXBlOwogIHJldHVybiBub2RlVHlwZSA9PT0gTk9ERV9UWVBFX0VMRU1FTlQgfHwgIW5vZGVUeXBlIHx8IG5vZGVUeXBlID09PSBOT0RFX1RZUEVfRE9DVU1FTlQ7Cn0KCmZ1bmN0aW9uIGpxTGl0ZUJ1aWxkRnJhZ21lbnQoaHRtbCwgY29udGV4dCkgewogIHZhciB0bXAsIHRhZywgd3JhcCwKICAgICAgZnJhZ21lbnQgPSBjb250ZXh0LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKICAgICAgbm9kZXMgPSBbXSwgaTsKCiAgaWYgKGpxTGl0ZUlzVGV4dE5vZGUoaHRtbCkpIHsKICAgIC8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQogICAgbm9kZXMucHVzaChjb250ZXh0LmNyZWF0ZVRleHROb2RlKGh0bWwpKTsKICB9IGVsc2UgewogICAgLy8gQ29udmVydCBodG1sIGludG8gRE9NIG5vZGVzCiAgICB0bXAgPSB0bXAgfHwgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoY29udGV4dC5jcmVhdGVFbGVtZW50KCJkaXYiKSk7CiAgICB0YWcgPSAoVEFHX05BTUVfUkVHRVhQLmV4ZWMoaHRtbCkgfHwgWyIiLCAiIl0pWzFdLnRvTG93ZXJDYXNlKCk7CiAgICB3cmFwID0gd3JhcE1hcFt0YWddIHx8IHdyYXBNYXAuX2RlZmF1bHQ7CiAgICB0bXAuaW5uZXJIVE1MID0gd3JhcFsxXSArIGh0bWwucmVwbGFjZShYSFRNTF9UQUdfUkVHRVhQLCAiPCQxPjwvJDI+IikgKyB3cmFwWzJdOwoKICAgIC8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudAogICAgaSA9IHdyYXBbMF07CiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHRtcCA9IHRtcC5sYXN0Q2hpbGQ7CiAgICB9CgogICAgbm9kZXMgPSBjb25jYXQobm9kZXMsIHRtcC5jaGlsZE5vZGVzKTsKCiAgICB0bXAgPSBmcmFnbWVudC5maXJzdENoaWxkOwogICAgdG1wLnRleHRDb250ZW50ID0gIiI7CiAgfQoKICAvLyBSZW1vdmUgd3JhcHBlciBmcm9tIGZyYWdtZW50CiAgZnJhZ21lbnQudGV4dENvbnRlbnQgPSAiIjsKICBmcmFnbWVudC5pbm5lckhUTUwgPSAiIjsgLy8gQ2xlYXIgaW5uZXIgSFRNTAogIGZvckVhY2gobm9kZXMsIGZ1bmN0aW9uKG5vZGUpIHsKICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKG5vZGUpOwogIH0pOwoKICByZXR1cm4gZnJhZ21lbnQ7Cn0KCmZ1bmN0aW9uIGpxTGl0ZVBhcnNlSFRNTChodG1sLCBjb250ZXh0KSB7CiAgY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CiAgdmFyIHBhcnNlZDsKCiAgaWYgKChwYXJzZWQgPSBTSU5HTEVfVEFHX1JFR0VYUC5leGVjKGh0bWwpKSkgewogICAgcmV0dXJuIFtjb250ZXh0LmNyZWF0ZUVsZW1lbnQocGFyc2VkWzFdKV07CiAgfQoKICBpZiAoKHBhcnNlZCA9IGpxTGl0ZUJ1aWxkRnJhZ21lbnQoaHRtbCwgY29udGV4dCkpKSB7CiAgICByZXR1cm4gcGFyc2VkLmNoaWxkTm9kZXM7CiAgfQoKICByZXR1cm4gW107Cn0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwpmdW5jdGlvbiBKUUxpdGUoZWxlbWVudCkgewogIGlmIChlbGVtZW50IGluc3RhbmNlb2YgSlFMaXRlKSB7CiAgICByZXR1cm4gZWxlbWVudDsKICB9CgogIHZhciBhcmdJc1N0cmluZzsKCiAgaWYgKGlzU3RyaW5nKGVsZW1lbnQpKSB7CiAgICBlbGVtZW50ID0gdHJpbShlbGVtZW50KTsKICAgIGFyZ0lzU3RyaW5nID0gdHJ1ZTsKICB9CiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIEpRTGl0ZSkpIHsKICAgIGlmIChhcmdJc1N0cmluZyAmJiBlbGVtZW50LmNoYXJBdCgwKSAhPSAnPCcpIHsKICAgICAgdGhyb3cganFMaXRlTWluRXJyKCdub3NlbCcsICdMb29raW5nIHVwIGVsZW1lbnRzIHZpYSBzZWxlY3RvcnMgaXMgbm90IHN1cHBvcnRlZCBieSBqcUxpdGUhIFNlZTogaHR0cDovL2RvY3MuYW5ndWxhcmpzLm9yZy9hcGkvYW5ndWxhci5lbGVtZW50Jyk7CiAgICB9CiAgICByZXR1cm4gbmV3IEpRTGl0ZShlbGVtZW50KTsKICB9CgogIGlmIChhcmdJc1N0cmluZykgewogICAganFMaXRlQWRkTm9kZXModGhpcywganFMaXRlUGFyc2VIVE1MKGVsZW1lbnQpKTsKICB9IGVsc2UgewogICAganFMaXRlQWRkTm9kZXModGhpcywgZWxlbWVudCk7CiAgfQp9CgpmdW5jdGlvbiBqcUxpdGVDbG9uZShlbGVtZW50KSB7CiAgcmV0dXJuIGVsZW1lbnQuY2xvbmVOb2RlKHRydWUpOwp9CgpmdW5jdGlvbiBqcUxpdGVEZWFsb2MoZWxlbWVudCwgb25seURlc2NlbmRhbnRzKXsKICBpZiAoIW9ubHlEZXNjZW5kYW50cykganFMaXRlUmVtb3ZlRGF0YShlbGVtZW50KTsKCiAgaWYgKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCkgewogICAgdmFyIGRlc2NlbmRhbnRzID0gZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcqJyk7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGRlc2NlbmRhbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBqcUxpdGVSZW1vdmVEYXRhKGRlc2NlbmRhbnRzW2ldKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGpxTGl0ZU9mZihlbGVtZW50LCB0eXBlLCBmbiwgdW5zdXBwb3J0ZWQpIHsKICBpZiAoaXNEZWZpbmVkKHVuc3VwcG9ydGVkKSkgdGhyb3cganFMaXRlTWluRXJyKCdvZmZhcmdzJywgJ2pxTGl0ZSNvZmYoKSBkb2VzIG5vdCBzdXBwb3J0IHRoZSBgc2VsZWN0b3JgIGFyZ3VtZW50Jyk7CgogIHZhciBleHBhbmRvU3RvcmUgPSBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCk7CiAgdmFyIGV2ZW50cyA9IGV4cGFuZG9TdG9yZSAmJiBleHBhbmRvU3RvcmUuZXZlbnRzOwogIHZhciBoYW5kbGUgPSBleHBhbmRvU3RvcmUgJiYgZXhwYW5kb1N0b3JlLmhhbmRsZTsKCiAgaWYgKCFoYW5kbGUpIHJldHVybjsgLy9ubyBsaXN0ZW5lcnMgcmVnaXN0ZXJlZAoKICBpZiAoIXR5cGUpIHsKICAgIGZvciAodHlwZSBpbiBldmVudHMpIHsKICAgICAgaWYgKHR5cGUgIT09ICckZGVzdHJveScpIHsKICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgaGFuZGxlKTsKICAgICAgfQogICAgICBkZWxldGUgZXZlbnRzW3R5cGVdOwogICAgfQogIH0gZWxzZSB7CiAgICBmb3JFYWNoKHR5cGUuc3BsaXQoJyAnKSwgZnVuY3Rpb24odHlwZSkgewogICAgICBpZiAoaXNEZWZpbmVkKGZuKSkgewogICAgICAgIHZhciBsaXN0ZW5lckZucyA9IGV2ZW50c1t0eXBlXTsKICAgICAgICBhcnJheVJlbW92ZShsaXN0ZW5lckZucyB8fCBbXSwgZm4pOwogICAgICAgIGlmIChsaXN0ZW5lckZucyAmJiBsaXN0ZW5lckZucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CgogICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgaGFuZGxlKTsKICAgICAgZGVsZXRlIGV2ZW50c1t0eXBlXTsKICAgIH0pOwogIH0KfQoKZnVuY3Rpb24ganFMaXRlUmVtb3ZlRGF0YShlbGVtZW50LCBuYW1lKSB7CiAgdmFyIGV4cGFuZG9JZCA9IGVsZW1lbnQubmczMzk7CiAgdmFyIGV4cGFuZG9TdG9yZSA9IGV4cGFuZG9JZCAmJiBqcUNhY2hlW2V4cGFuZG9JZF07CgogIGlmIChleHBhbmRvU3RvcmUpIHsKICAgIGlmIChuYW1lKSB7CiAgICAgIGRlbGV0ZSBleHBhbmRvU3RvcmUuZGF0YVtuYW1lXTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChleHBhbmRvU3RvcmUuaGFuZGxlKSB7CiAgICAgIGlmIChleHBhbmRvU3RvcmUuZXZlbnRzLiRkZXN0cm95KSB7CiAgICAgICAgZXhwYW5kb1N0b3JlLmhhbmRsZSh7fSwgJyRkZXN0cm95Jyk7CiAgICAgIH0KICAgICAganFMaXRlT2ZmKGVsZW1lbnQpOwogICAgfQogICAgZGVsZXRlIGpxQ2FjaGVbZXhwYW5kb0lkXTsKICAgIGVsZW1lbnQubmczMzkgPSB1bmRlZmluZWQ7IC8vIGRvbid0IGRlbGV0ZSBET00gZXhwYW5kb3MuIElFIGFuZCBDaHJvbWUgZG9uJ3QgbGlrZSBpdAogIH0KfQoKCmZ1bmN0aW9uIGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCBjcmVhdGVJZk5lY2Vzc2FyeSkgewogIHZhciBleHBhbmRvSWQgPSBlbGVtZW50Lm5nMzM5LAogICAgICBleHBhbmRvU3RvcmUgPSBleHBhbmRvSWQgJiYganFDYWNoZVtleHBhbmRvSWRdOwoKICBpZiAoY3JlYXRlSWZOZWNlc3NhcnkgJiYgIWV4cGFuZG9TdG9yZSkgewogICAgZWxlbWVudC5uZzMzOSA9IGV4cGFuZG9JZCA9IGpxTmV4dElkKCk7CiAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF0gPSB7ZXZlbnRzOiB7fSwgZGF0YToge30sIGhhbmRsZTogdW5kZWZpbmVkfTsKICB9CgogIHJldHVybiBleHBhbmRvU3RvcmU7Cn0KCgpmdW5jdGlvbiBqcUxpdGVEYXRhKGVsZW1lbnQsIGtleSwgdmFsdWUpIHsKICBpZiAoanFMaXRlQWNjZXB0c0RhdGEoZWxlbWVudCkpIHsKCiAgICB2YXIgaXNTaW1wbGVTZXR0ZXIgPSBpc0RlZmluZWQodmFsdWUpOwogICAgdmFyIGlzU2ltcGxlR2V0dGVyID0gIWlzU2ltcGxlU2V0dGVyICYmIGtleSAmJiAhaXNPYmplY3Qoa2V5KTsKICAgIHZhciBtYXNzR2V0dGVyID0gIWtleTsKICAgIHZhciBleHBhbmRvU3RvcmUgPSBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgIWlzU2ltcGxlR2V0dGVyKTsKICAgIHZhciBkYXRhID0gZXhwYW5kb1N0b3JlICYmIGV4cGFuZG9TdG9yZS5kYXRhOwoKICAgIGlmIChpc1NpbXBsZVNldHRlcikgeyAvLyBkYXRhKCdrZXknLCB2YWx1ZSkKICAgICAgZGF0YVtrZXldID0gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICBpZiAobWFzc0dldHRlcikgeyAgLy8gZGF0YSgpCiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlzU2ltcGxlR2V0dGVyKSB7IC8vIGRhdGEoJ2tleScpCiAgICAgICAgICAvLyBkb24ndCBmb3JjZSBjcmVhdGlvbiBvZiBleHBhbmRvU3RvcmUgaWYgaXQgZG9lc24ndCBleGlzdCB5ZXQKICAgICAgICAgIHJldHVybiBkYXRhICYmIGRhdGFba2V5XTsKICAgICAgICB9IGVsc2UgeyAvLyBtYXNzLXNldHRlcjogZGF0YSh7a2V5MTogdmFsMSwga2V5MjogdmFsMn0pCiAgICAgICAgICBleHRlbmQoZGF0YSwga2V5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGpxTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgaWYgKCFlbGVtZW50LmdldEF0dHJpYnV0ZSkgcmV0dXJuIGZhbHNlOwogIHJldHVybiAoKCIgIiArIChlbGVtZW50LmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAiICIpLnJlcGxhY2UoL1tcblx0XS9nLCAiICIpLgogICAgICBpbmRleE9mKCAiICIgKyBzZWxlY3RvciArICIgIiApID4gLTEpOwp9CgpmdW5jdGlvbiBqcUxpdGVSZW1vdmVDbGFzcyhlbGVtZW50LCBjc3NDbGFzc2VzKSB7CiAgaWYgKGNzc0NsYXNzZXMgJiYgZWxlbWVudC5zZXRBdHRyaWJ1dGUpIHsKICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbihjc3NDbGFzcykgewogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnY2xhc3MnLCB0cmltKAogICAgICAgICAgKCIgIiArIChlbGVtZW50LmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAiICIpCiAgICAgICAgICAucmVwbGFjZSgvW1xuXHRdL2csICIgIikKICAgICAgICAgIC5yZXBsYWNlKCIgIiArIHRyaW0oY3NzQ2xhc3MpICsgIiAiLCAiICIpKQogICAgICApOwogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBqcUxpdGVBZGRDbGFzcyhlbGVtZW50LCBjc3NDbGFzc2VzKSB7CiAgaWYgKGNzc0NsYXNzZXMgJiYgZWxlbWVudC5zZXRBdHRyaWJ1dGUpIHsKICAgIHZhciBleGlzdGluZ0NsYXNzZXMgPSAoJyAnICsgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKSArICcgJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKTsKCiAgICBmb3JFYWNoKGNzc0NsYXNzZXMuc3BsaXQoJyAnKSwgZnVuY3Rpb24oY3NzQ2xhc3MpIHsKICAgICAgY3NzQ2xhc3MgPSB0cmltKGNzc0NsYXNzKTsKICAgICAgaWYgKGV4aXN0aW5nQ2xhc3Nlcy5pbmRleE9mKCcgJyArIGNzc0NsYXNzICsgJyAnKSA9PT0gLTEpIHsKICAgICAgICBleGlzdGluZ0NsYXNzZXMgKz0gY3NzQ2xhc3MgKyAnICc7CiAgICAgIH0KICAgIH0pOwoKICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdjbGFzcycsIHRyaW0oZXhpc3RpbmdDbGFzc2VzKSk7CiAgfQp9CgoKZnVuY3Rpb24ganFMaXRlQWRkTm9kZXMocm9vdCwgZWxlbWVudHMpIHsKICAvLyBUSElTIENPREUgSVMgVkVSWSBIT1QuIERvbid0IG1ha2UgY2hhbmdlcyB3aXRob3V0IGJlbmNobWFya2luZy4KCiAgaWYgKGVsZW1lbnRzKSB7CgogICAgLy8gaWYgYSBOb2RlICh0aGUgbW9zdCBjb21tb24gY2FzZSkKICAgIGlmIChlbGVtZW50cy5ub2RlVHlwZSkgewogICAgICByb290W3Jvb3QubGVuZ3RoKytdID0gZWxlbWVudHM7CiAgICB9IGVsc2UgewogICAgICB2YXIgbGVuZ3RoID0gZWxlbWVudHMubGVuZ3RoOwoKICAgICAgLy8gaWYgYW4gQXJyYXkgb3IgTm9kZUxpc3QgYW5kIG5vdCBhIFdpbmRvdwogICAgICBpZiAodHlwZW9mIGxlbmd0aCA9PT0gJ251bWJlcicgJiYgZWxlbWVudHMud2luZG93ICE9PSBlbGVtZW50cykgewogICAgICAgIGlmIChsZW5ndGgpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcm9vdFtyb290Lmxlbmd0aCsrXSA9IGVsZW1lbnRzW2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByb290W3Jvb3QubGVuZ3RoKytdID0gZWxlbWVudHM7CiAgICAgIH0KICAgIH0KICB9Cn0KCgpmdW5jdGlvbiBqcUxpdGVDb250cm9sbGVyKGVsZW1lbnQsIG5hbWUpIHsKICByZXR1cm4ganFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCAnJCcgKyAobmFtZSB8fCAnbmdDb250cm9sbGVyJyApICsgJ0NvbnRyb2xsZXInKTsKfQoKZnVuY3Rpb24ganFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogIC8vIGlmIGVsZW1lbnQgaXMgdGhlIGRvY3VtZW50IG9iamVjdCB3b3JrIHdpdGggdGhlIGh0bWwgZWxlbWVudCBpbnN0ZWFkCiAgLy8gdGhpcyBtYWtlcyAkKGRvY3VtZW50KS5zY29wZSgpIHBvc3NpYmxlCiAgaWYoZWxlbWVudC5ub2RlVHlwZSA9PSBOT0RFX1RZUEVfRE9DVU1FTlQpIHsKICAgIGVsZW1lbnQgPSBlbGVtZW50LmRvY3VtZW50RWxlbWVudDsKICB9CiAgdmFyIG5hbWVzID0gaXNBcnJheShuYW1lKSA/IG5hbWUgOiBbbmFtZV07CgogIHdoaWxlIChlbGVtZW50KSB7CiAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBuYW1lcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgIGlmICgodmFsdWUgPSBqcUxpdGUuZGF0YShlbGVtZW50LCBuYW1lc1tpXSkpICE9PSB1bmRlZmluZWQpIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvLyBJZiBkZWFsaW5nIHdpdGggYSBkb2N1bWVudCBmcmFnbWVudCBub2RlIHdpdGggYSBob3N0IGVsZW1lbnQsIGFuZCBubyBwYXJlbnQsIHVzZSB0aGUgaG9zdAogICAgLy8gZWxlbWVudCBhcyB0aGUgcGFyZW50LiBUaGlzIGVuYWJsZXMgZGlyZWN0aXZlcyB3aXRoaW4gYSBTaGFkb3cgRE9NIG9yIHBvbHlmaWxsZWQgU2hhZG93IERPTQogICAgLy8gdG8gbG9va3VwIHBhcmVudCBjb250cm9sbGVycy4KICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGUgfHwgKGVsZW1lbnQubm9kZVR5cGUgPT09IE5PREVfVFlQRV9ET0NVTUVOVF9GUkFHTUVOVCAmJiBlbGVtZW50Lmhvc3QpOwogIH0KfQoKZnVuY3Rpb24ganFMaXRlRW1wdHkoZWxlbWVudCkgewogIGpxTGl0ZURlYWxvYyhlbGVtZW50LCB0cnVlKTsKICB3aGlsZSAoZWxlbWVudC5maXJzdENoaWxkKSB7CiAgICBlbGVtZW50LnJlbW92ZUNoaWxkKGVsZW1lbnQuZmlyc3RDaGlsZCk7CiAgfQp9CgpmdW5jdGlvbiBqcUxpdGVSZW1vdmUoZWxlbWVudCwga2VlcERhdGEpIHsKICBpZiAoIWtlZXBEYXRhKSBqcUxpdGVEZWFsb2MoZWxlbWVudCk7CiAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICBpZiAocGFyZW50KSBwYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7Cn0KCgpmdW5jdGlvbiBqcUxpdGVEb2N1bWVudExvYWRlZChhY3Rpb24sIHdpbikgewogIHdpbiA9IHdpbiB8fCB3aW5kb3c7CiAgaWYgKHdpbi5kb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7CiAgICAvLyBGb3JjZSB0aGUgYWN0aW9uIHRvIGJlIHJ1biBhc3luYyBmb3IgY29uc2lzdGVudCBiZWhhdmlvdXIKICAgIC8vIGZyb20gdGhlIGFjdGlvbidzIHBvaW50IG9mIHZpZXcKICAgIC8vIGkuZS4gaXQgd2lsbCBkZWZpbml0ZWx5IG5vdCBiZSBpbiBhICRhcHBseQogICAgd2luLnNldFRpbWVvdXQoYWN0aW9uKTsKICB9IGVsc2UgewogICAgLy8gTm8gbmVlZCB0byB1bmJpbmQgdGhpcyBoYW5kbGVyIGFzIGxvYWQgaXMgb25seSBldmVyIGNhbGxlZCBvbmNlCiAgICBqcUxpdGUod2luKS5vbignbG9hZCcsIGFjdGlvbik7CiAgfQp9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIHdoaWNoIGFyZSBkZWNsYXJlZCBkaXJlY3RseS4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCnZhciBKUUxpdGVQcm90b3R5cGUgPSBKUUxpdGUucHJvdG90eXBlID0gewogIHJlYWR5OiBmdW5jdGlvbihmbikgewogICAgdmFyIGZpcmVkID0gZmFsc2U7CgogICAgZnVuY3Rpb24gdHJpZ2dlcigpIHsKICAgICAgaWYgKGZpcmVkKSByZXR1cm47CiAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgZm4oKTsKICAgIH0KCiAgICAvLyBjaGVjayBpZiBkb2N1bWVudCBpcyBhbHJlYWR5IGxvYWRlZAogICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScpewogICAgICBzZXRUaW1lb3V0KHRyaWdnZXIpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5vbignRE9NQ29udGVudExvYWRlZCcsIHRyaWdnZXIpOyAvLyB3b3JrcyBmb3IgbW9kZXJuIGJyb3dzZXJzIGFuZCBJRTkKICAgICAgLy8gd2UgY2FuIG5vdCB1c2UganFMaXRlIHNpbmNlIHdlIGFyZSBub3QgZG9uZSBsb2FkaW5nIGFuZCBqUXVlcnkgY291bGQgYmUgbG9hZGVkIGxhdGVyLgogICAgICAvLyBqc2hpbnQgLVcwNjQKICAgICAgSlFMaXRlKHdpbmRvdykub24oJ2xvYWQnLCB0cmlnZ2VyKTsgLy8gZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCBmb3Igb3RoZXJzCiAgICAgIC8vIGpzaGludCArVzA2NAogICAgICB0aGlzLm9uKCdET01Db250ZW50TG9hZGVkJywgdHJpZ2dlcik7CiAgICB9CiAgfSwKICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICB2YXIgdmFsdWUgPSBbXTsKICAgIGZvckVhY2godGhpcywgZnVuY3Rpb24oZSl7IHZhbHVlLnB1c2goJycgKyBlKTt9KTsKICAgIHJldHVybiAnWycgKyB2YWx1ZS5qb2luKCcsICcpICsgJ10nOwogIH0sCgogIGVxOiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gKGluZGV4ID49IDApID8ganFMaXRlKHRoaXNbaW5kZXhdKSA6IGpxTGl0ZSh0aGlzW3RoaXMubGVuZ3RoICsgaW5kZXhdKTsKICB9LAoKICBsZW5ndGg6IDAsCiAgcHVzaDogcHVzaCwKICBzb3J0OiBbXS5zb3J0LAogIHNwbGljZTogW10uc3BsaWNlCn07CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIGl0ZXJhdGluZyBnZXR0ZXIvc2V0dGVycy4KLy8gdGhlc2UgZnVuY3Rpb25zIHJldHVybiBzZWxmIG9uIHNldHRlciBhbmQKLy8gdmFsdWUgb24gZ2V0LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KdmFyIEJPT0xFQU5fQVRUUiA9IHt9Owpmb3JFYWNoKCdtdWx0aXBsZSxzZWxlY3RlZCxjaGVja2VkLGRpc2FibGVkLHJlYWRPbmx5LHJlcXVpcmVkLG9wZW4nLnNwbGl0KCcsJyksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgQk9PTEVBTl9BVFRSW2xvd2VyY2FzZSh2YWx1ZSldID0gdmFsdWU7Cn0pOwp2YXIgQk9PTEVBTl9FTEVNRU5UUyA9IHt9Owpmb3JFYWNoKCdpbnB1dCxzZWxlY3Qsb3B0aW9uLHRleHRhcmVhLGJ1dHRvbixmb3JtLGRldGFpbHMnLnNwbGl0KCcsJyksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgQk9PTEVBTl9FTEVNRU5UU1t2YWx1ZV0gPSB0cnVlOwp9KTsKdmFyIEFMSUFTRURfQVRUUiA9IHsKICAnbmdNaW5sZW5ndGgnIDogJ21pbmxlbmd0aCcsCiAgJ25nTWF4bGVuZ3RoJyA6ICdtYXhsZW5ndGgnLAogICduZ01pbicgOiAnbWluJywKICAnbmdNYXgnIDogJ21heCcsCiAgJ25nUGF0dGVybicgOiAncGF0dGVybicKfTsKCmZ1bmN0aW9uIGdldEJvb2xlYW5BdHRyTmFtZShlbGVtZW50LCBuYW1lKSB7CiAgLy8gY2hlY2sgZG9tIGxhc3Qgc2luY2Ugd2Ugd2lsbCBtb3N0IGxpa2VseSBmYWlsIG9uIG5hbWUKICB2YXIgYm9vbGVhbkF0dHIgPSBCT09MRUFOX0FUVFJbbmFtZS50b0xvd2VyQ2FzZSgpXTsKCiAgLy8gYm9vbGVhbkF0dHIgaXMgaGVyZSB0d2ljZSB0byBtaW5pbWl6ZSBET00gYWNjZXNzCiAgcmV0dXJuIGJvb2xlYW5BdHRyICYmIEJPT0xFQU5fRUxFTUVOVFNbbm9kZU5hbWVfKGVsZW1lbnQpXSAmJiBib29sZWFuQXR0cjsKfQoKZnVuY3Rpb24gZ2V0QWxpYXNlZEF0dHJOYW1lKGVsZW1lbnQsIG5hbWUpIHsKICB2YXIgbm9kZU5hbWUgPSBlbGVtZW50Lm5vZGVOYW1lOwogIHJldHVybiAobm9kZU5hbWUgPT09ICdJTlBVVCcgfHwgbm9kZU5hbWUgPT09ICdURVhUQVJFQScpICYmIEFMSUFTRURfQVRUUltuYW1lXTsKfQoKZm9yRWFjaCh7CiAgZGF0YToganFMaXRlRGF0YSwKICByZW1vdmVEYXRhOiBqcUxpdGVSZW1vdmVEYXRhCn0sIGZ1bmN0aW9uKGZuLCBuYW1lKSB7CiAgSlFMaXRlW25hbWVdID0gZm47Cn0pOwoKZm9yRWFjaCh7CiAgZGF0YToganFMaXRlRGF0YSwKICBpbmhlcml0ZWREYXRhOiBqcUxpdGVJbmhlcml0ZWREYXRhLAoKICBzY29wZTogZnVuY3Rpb24oZWxlbWVudCkgewogICAgLy8gQ2FuJ3QgdXNlIGpxTGl0ZURhdGEgaGVyZSBkaXJlY3RseSBzbyB3ZSBzdGF5IGNvbXBhdGlibGUgd2l0aCBqUXVlcnkhCiAgICByZXR1cm4ganFMaXRlLmRhdGEoZWxlbWVudCwgJyRzY29wZScpIHx8IGpxTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudC5wYXJlbnROb2RlIHx8IGVsZW1lbnQsIFsnJGlzb2xhdGVTY29wZScsICckc2NvcGUnXSk7CiAgfSwKCiAgaXNvbGF0ZVNjb3BlOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAvLyBDYW4ndCB1c2UganFMaXRlRGF0YSBoZXJlIGRpcmVjdGx5IHNvIHdlIHN0YXkgY29tcGF0aWJsZSB3aXRoIGpRdWVyeSEKICAgIHJldHVybiBqcUxpdGUuZGF0YShlbGVtZW50LCAnJGlzb2xhdGVTY29wZScpIHx8IGpxTGl0ZS5kYXRhKGVsZW1lbnQsICckaXNvbGF0ZVNjb3BlTm9UZW1wbGF0ZScpOwogIH0sCgogIGNvbnRyb2xsZXI6IGpxTGl0ZUNvbnRyb2xsZXIsCgogIGluamVjdG9yOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICByZXR1cm4ganFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCAnJGluamVjdG9yJyk7CiAgfSwKCiAgcmVtb3ZlQXR0cjogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSkgewogICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7CiAgfSwKCiAgaGFzQ2xhc3M6IGpxTGl0ZUhhc0NsYXNzLAoKICBjc3M6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7CiAgICBuYW1lID0gY2FtZWxDYXNlKG5hbWUpOwoKICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgIGVsZW1lbnQuc3R5bGVbbmFtZV0gPSB2YWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBlbGVtZW50LnN0eWxlW25hbWVdOwogICAgfQogIH0sCgogIGF0dHI6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUsIHZhbHVlKXsKICAgIHZhciBsb3dlcmNhc2VkTmFtZSA9IGxvd2VyY2FzZShuYW1lKTsKICAgIGlmIChCT09MRUFOX0FUVFJbbG93ZXJjYXNlZE5hbWVdKSB7CiAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgaWYgKCEhdmFsdWUpIHsKICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSB0cnVlOwogICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgbG93ZXJjYXNlZE5hbWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlbGVtZW50W25hbWVdID0gZmFsc2U7CiAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShsb3dlcmNhc2VkTmFtZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAoZWxlbWVudFtuYW1lXSB8fAogICAgICAgICAgICAgICAgIChlbGVtZW50LmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKG5hbWUpfHwgbm9vcCkuc3BlY2lmaWVkKQogICAgICAgICAgICAgICA/IGxvd2VyY2FzZWROYW1lCiAgICAgICAgICAgICAgIDogdW5kZWZpbmVkOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwogICAgfSBlbHNlIGlmIChlbGVtZW50LmdldEF0dHJpYnV0ZSkgewogICAgICAvLyB0aGUgZXh0cmEgYXJndW1lbnQgIjIiIGlzIHRvIGdldCB0aGUgcmlnaHQgdGhpbmcgZm9yIGEuaHJlZiBpbiBJRSwgc2VlIGpRdWVyeSBjb2RlCiAgICAgIC8vIHNvbWUgZWxlbWVudHMgKGUuZy4gRG9jdW1lbnQpIGRvbid0IGhhdmUgZ2V0IGF0dHJpYnV0ZSwgc28gcmV0dXJuIHVuZGVmaW5lZAogICAgICB2YXIgcmV0ID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUobmFtZSwgMik7CiAgICAgIC8vIG5vcm1hbGl6ZSBub24tZXhpc3RpbmcgYXR0cmlidXRlcyB0byB1bmRlZmluZWQgKGFzIGpRdWVyeSkKICAgICAgcmV0dXJuIHJldCA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IHJldDsKICAgIH0KICB9LAoKICBwcm9wOiBmdW5jdGlvbihlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgZWxlbWVudFtuYW1lXSA9IHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGVsZW1lbnRbbmFtZV07CiAgICB9CiAgfSwKCiAgdGV4dDogKGZ1bmN0aW9uKCkgewogICAgZ2V0VGV4dC4kZHYgPSAnJzsKICAgIHJldHVybiBnZXRUZXh0OwoKICAgIGZ1bmN0aW9uIGdldFRleHQoZWxlbWVudCwgdmFsdWUpIHsKICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgIHZhciBub2RlVHlwZSA9IGVsZW1lbnQubm9kZVR5cGU7CiAgICAgICAgcmV0dXJuIChub2RlVHlwZSA9PT0gTk9ERV9UWVBFX0VMRU1FTlQgfHwgbm9kZVR5cGUgPT09IE5PREVfVFlQRV9URVhUKSA/IGVsZW1lbnQudGV4dENvbnRlbnQgOiAnJzsKICAgICAgfQogICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gdmFsdWU7CiAgICB9CiAgfSkoKSwKCiAgdmFsOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICBpZiAoZWxlbWVudC5tdWx0aXBsZSAmJiBub2RlTmFtZV8oZWxlbWVudCkgPT09ICdzZWxlY3QnKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIGZvckVhY2goZWxlbWVudC5vcHRpb25zLCBmdW5jdGlvbiAob3B0aW9uKSB7CiAgICAgICAgICBpZiAob3B0aW9uLnNlbGVjdGVkKSB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKG9wdGlvbi52YWx1ZSB8fCBvcHRpb24udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5sZW5ndGggPT09IDAgPyBudWxsIDogcmVzdWx0OwogICAgICB9CiAgICAgIHJldHVybiBlbGVtZW50LnZhbHVlOwogICAgfQogICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwogIH0sCgogIGh0bWw6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlKSB7CiAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgIHJldHVybiBlbGVtZW50LmlubmVySFRNTDsKICAgIH0KICAgIGpxTGl0ZURlYWxvYyhlbGVtZW50LCB0cnVlKTsKICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gdmFsdWU7CiAgfSwKCiAgZW1wdHk6IGpxTGl0ZUVtcHR5Cn0sIGZ1bmN0aW9uKGZuLCBuYW1lKXsKICAvKioKICAgKiBQcm9wZXJ0aWVzOiB3cml0ZXMgcmV0dXJuIHNlbGVjdGlvbiwgcmVhZHMgcmV0dXJuIGZpcnN0IHZhbHVlCiAgICovCiAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKGFyZzEsIGFyZzIpIHsKICAgIHZhciBpLCBrZXk7CiAgICB2YXIgbm9kZUNvdW50ID0gdGhpcy5sZW5ndGg7CgogICAgLy8ganFMaXRlSGFzQ2xhc3MgaGFzIG9ubHkgdHdvIGFyZ3VtZW50cywgYnV0IGlzIGEgZ2V0dGVyLW9ubHkgZm4sIHNvIHdlIG5lZWQgdG8gc3BlY2lhbC1jYXNlIGl0CiAgICAvLyBpbiBhIHdheSB0aGF0IHN1cnZpdmVzIG1pbmlmaWNhdGlvbi4KICAgIC8vIGpxTGl0ZUVtcHR5IHRha2VzIG5vIGFyZ3VtZW50cyBidXQgaXMgYSBzZXR0ZXIuCiAgICBpZiAoZm4gIT09IGpxTGl0ZUVtcHR5ICYmCiAgICAgICAgKCgoZm4ubGVuZ3RoID09IDIgJiYgKGZuICE9PSBqcUxpdGVIYXNDbGFzcyAmJiBmbiAhPT0ganFMaXRlQ29udHJvbGxlcikpID8gYXJnMSA6IGFyZzIpID09PSB1bmRlZmluZWQpKSB7CiAgICAgIGlmIChpc09iamVjdChhcmcxKSkgewoKICAgICAgICAvLyB3ZSBhcmUgYSB3cml0ZSwgYnV0IHRoZSBvYmplY3QgcHJvcGVydGllcyBhcmUgdGhlIGtleS92YWx1ZXMKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZUNvdW50OyBpKyspIHsKICAgICAgICAgIGlmIChmbiA9PT0ganFMaXRlRGF0YSkgewogICAgICAgICAgICAvLyBkYXRhKCkgdGFrZXMgdGhlIHdob2xlIG9iamVjdCBpbiBqUXVlcnkKICAgICAgICAgICAgZm4odGhpc1tpXSwgYXJnMSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKGtleSBpbiBhcmcxKSB7CiAgICAgICAgICAgICAgZm4odGhpc1tpXSwga2V5LCBhcmcxW2tleV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIHJldHVybiBzZWxmIGZvciBjaGFpbmluZwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIHdlIGFyZSBhIHJlYWQsIHNvIHJlYWQgdGhlIGZpcnN0IGNoaWxkLgogICAgICAgIC8vIFRPRE86IGRvIHdlIHN0aWxsIG5lZWQgdGhpcz8KICAgICAgICB2YXIgdmFsdWUgPSBmbi4kZHY7CiAgICAgICAgLy8gT25seSBpZiB3ZSBoYXZlICRkdiBkbyB3ZSBpdGVyYXRlIG92ZXIgYWxsLCBvdGhlcndpc2UgaXQgaXMganVzdCB0aGUgZmlyc3QgZWxlbWVudC4KICAgICAgICB2YXIgamogPSAodmFsdWUgPT09IHVuZGVmaW5lZCkgPyBNYXRoLm1pbihub2RlQ291bnQsIDEpIDogbm9kZUNvdW50OwogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgamo7IGorKykgewogICAgICAgICAgdmFyIG5vZGVWYWx1ZSA9IGZuKHRoaXNbal0sIGFyZzEsIGFyZzIpOwogICAgICAgICAgdmFsdWUgPSB2YWx1ZSA/IHZhbHVlICsgbm9kZVZhbHVlIDogbm9kZVZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIHdlIGFyZSBhIHdyaXRlLCBzbyBhcHBseSB0byBhbGwgY2hpbGRyZW4KICAgICAgZm9yIChpID0gMDsgaSA8IG5vZGVDb3VudDsgaSsrKSB7CiAgICAgICAgZm4odGhpc1tpXSwgYXJnMSwgYXJnMik7CiAgICAgIH0KICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH07Cn0pOwoKZnVuY3Rpb24gY3JlYXRlRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50cykgewogIHZhciBldmVudEhhbmRsZXIgPSBmdW5jdGlvbiAoZXZlbnQsIHR5cGUpIHsKICAgIC8vIGpRdWVyeSBzcGVjaWZpYyBhcGkKICAgIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZXZlbnQuZGVmYXVsdFByZXZlbnRlZDsKICAgIH07CgogICAgdmFyIGV2ZW50Rm5zID0gZXZlbnRzW3R5cGUgfHwgZXZlbnQudHlwZV07CiAgICB2YXIgZXZlbnRGbnNMZW5ndGggPSBldmVudEZucyA/IGV2ZW50Rm5zLmxlbmd0aCA6IDA7CgogICAgaWYgKCFldmVudEZuc0xlbmd0aCkgcmV0dXJuOwoKICAgIGlmIChpc1VuZGVmaW5lZChldmVudC5pbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQpKSB7CiAgICAgIHZhciBvcmlnaW5hbFN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbiA9IGV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjsKICAgICAgZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZXZlbnQuaW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkID0gdHJ1ZTsKCiAgICAgICAgaWYgKGV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAob3JpZ2luYWxTdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24pIHsKICAgICAgICAgIG9yaWdpbmFsU3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uLmNhbGwoZXZlbnQpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KCiAgICBldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZXZlbnQuaW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkID09PSB0cnVlOwogICAgfTsKCiAgICAvLyBDb3B5IGV2ZW50IGhhbmRsZXJzIGluIGNhc2UgZXZlbnQgaGFuZGxlcnMgYXJyYXkgaXMgbW9kaWZpZWQgZHVyaW5nIGV4ZWN1dGlvbi4KICAgIGlmICgoZXZlbnRGbnNMZW5ndGggPiAxKSkgewogICAgICBldmVudEZucyA9IHNoYWxsb3dDb3B5KGV2ZW50Rm5zKTsKICAgIH0KCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50Rm5zTGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCFldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgZXZlbnRGbnNbaV0uY2FsbChlbGVtZW50LCBldmVudCk7CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyBUT0RPOiB0aGlzIGlzIGEgaGFjayBmb3IgYW5ndWxhck1vY2tzL2NsZWFyRGF0YUNhY2hlIHRoYXQgbWFrZXMgaXQgcG9zc2libGUgdG8gZGVyZWdpc3RlciBhbGwKICAvLyAgICAgICBldmVudHMgb24gYGVsZW1lbnRgCiAgZXZlbnRIYW5kbGVyLmVsZW0gPSBlbGVtZW50OwogIHJldHVybiBldmVudEhhbmRsZXI7Cn0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgaXRlcmF0aW5nIHRyYXZlcnNhbC4KLy8gVGhlc2UgZnVuY3Rpb25zIGNoYWluIHJlc3VsdHMgaW50byBhIHNpbmdsZQovLyBzZWxlY3Rvci4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCmZvckVhY2goewogIHJlbW92ZURhdGE6IGpxTGl0ZVJlbW92ZURhdGEsCgogIG9uOiBmdW5jdGlvbiBqcUxpdGVPbihlbGVtZW50LCB0eXBlLCBmbiwgdW5zdXBwb3J0ZWQpewogICAgaWYgKGlzRGVmaW5lZCh1bnN1cHBvcnRlZCkpIHRocm93IGpxTGl0ZU1pbkVycignb25hcmdzJywgJ2pxTGl0ZSNvbigpIGRvZXMgbm90IHN1cHBvcnQgdGhlIGBzZWxlY3RvcmAgb3IgYGV2ZW50RGF0YWAgcGFyYW1ldGVycycpOwoKICAgIC8vIERvIG5vdCBhZGQgZXZlbnQgaGFuZGxlcnMgdG8gbm9uLWVsZW1lbnRzIGJlY2F1c2UgdGhleSB3aWxsIG5vdCBiZSBjbGVhbmVkIHVwLgogICAgaWYgKCFqcUxpdGVBY2NlcHRzRGF0YShlbGVtZW50KSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGV4cGFuZG9TdG9yZSA9IGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCB0cnVlKTsKICAgIHZhciBldmVudHMgPSBleHBhbmRvU3RvcmUuZXZlbnRzOwogICAgdmFyIGhhbmRsZSA9IGV4cGFuZG9TdG9yZS5oYW5kbGU7CgogICAgaWYgKCFoYW5kbGUpIHsKICAgICAgaGFuZGxlID0gZXhwYW5kb1N0b3JlLmhhbmRsZSA9IGNyZWF0ZUV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudHMpOwogICAgfQoKICAgIC8vIGh0dHA6Ly9qc3BlcmYuY29tL3N0cmluZy1pbmRleG9mLXZzLXNwbGl0CiAgICB2YXIgdHlwZXMgPSB0eXBlLmluZGV4T2YoJyAnKSA+PSAwID8gdHlwZS5zcGxpdCgnICcpIDogW3R5cGVdOwogICAgdmFyIGkgPSB0eXBlcy5sZW5ndGg7CgogICAgd2hpbGUgKGktLSkgewogICAgICB0eXBlID0gdHlwZXNbaV07CiAgICAgIHZhciBldmVudEZucyA9IGV2ZW50c1t0eXBlXTsKCiAgICAgIGlmICghZXZlbnRGbnMpIHsKICAgICAgICBldmVudHNbdHlwZV0gPSBbXTsKCiAgICAgICAgaWYgKHR5cGUgPT09ICdtb3VzZWVudGVyJyB8fCB0eXBlID09PSAnbW91c2VsZWF2ZScpIHsKICAgICAgICAgIC8vIFJlZmVyIHRvIGpRdWVyeSdzIGltcGxlbWVudGF0aW9uIG9mIG1vdXNlZW50ZXIgJiBtb3VzZWxlYXZlCiAgICAgICAgICAvLyBSZWFkIGFib3V0IG1vdXNlZW50ZXIgYW5kIG1vdXNlbGVhdmU6CiAgICAgICAgICAvLyBodHRwOi8vd3d3LnF1aXJrc21vZGUub3JnL2pzL2V2ZW50c19tb3VzZS5odG1sI2xpbms4CgogICAgICAgICAganFMaXRlT24oZWxlbWVudCwgTU9VU0VfRVZFTlRfTUFQW3R5cGVdLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcywgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICAgIC8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KICAgICAgICAgICAgLy8gTkI6IE5vIHJlbGF0ZWRUYXJnZXQgaWYgdGhlIG1vdXNlIGxlZnQvZW50ZXJlZCB0aGUgYnJvd3NlciB3aW5kb3cKICAgICAgICAgICAgaWYgKCAhcmVsYXRlZCB8fCAocmVsYXRlZCAhPT0gdGFyZ2V0ICYmICF0YXJnZXQuY29udGFpbnMocmVsYXRlZCkpICl7CiAgICAgICAgICAgICAgaGFuZGxlKGV2ZW50LCB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodHlwZSAhPT0gJyRkZXN0cm95JykgewogICAgICAgICAgICBhZGRFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgaGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXZlbnRGbnMgPSBldmVudHNbdHlwZV07CiAgICAgIH0KICAgICAgZXZlbnRGbnMucHVzaChmbik7CiAgICB9CiAgfSwKCiAgb2ZmOiBqcUxpdGVPZmYsCgogIG9uZTogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHsKICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CgogICAgLy9hZGQgdGhlIGxpc3RlbmVyIHR3aWNlIHNvIHRoYXQgd2hlbiBpdCBpcyBjYWxsZWQKICAgIC8veW91IGNhbiByZW1vdmUgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uIGFuZCBzdGlsbCBiZQogICAgLy9hYmxlIHRvIGNhbGwgZWxlbWVudC5vZmYoZXYsIGZuKSBub3JtYWxseQogICAgZWxlbWVudC5vbih0eXBlLCBmdW5jdGlvbiBvbkZuKCkgewogICAgICBlbGVtZW50Lm9mZih0eXBlLCBmbik7CiAgICAgIGVsZW1lbnQub2ZmKHR5cGUsIG9uRm4pOwogICAgfSk7CiAgICBlbGVtZW50Lm9uKHR5cGUsIGZuKTsKICB9LAoKICByZXBsYWNlV2l0aDogZnVuY3Rpb24oZWxlbWVudCwgcmVwbGFjZU5vZGUpIHsKICAgIHZhciBpbmRleCwgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAganFMaXRlRGVhbG9jKGVsZW1lbnQpOwogICAgZm9yRWFjaChuZXcgSlFMaXRlKHJlcGxhY2VOb2RlKSwgZnVuY3Rpb24obm9kZSl7CiAgICAgIGlmIChpbmRleCkgewogICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZSwgaW5kZXgubmV4dFNpYmxpbmcpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobm9kZSwgZWxlbWVudCk7CiAgICAgIH0KICAgICAgaW5kZXggPSBub2RlOwogICAgfSk7CiAgfSwKCiAgY2hpbGRyZW46IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHZhciBjaGlsZHJlbiA9IFtdOwogICAgZm9yRWFjaChlbGVtZW50LmNoaWxkTm9kZXMsIGZ1bmN0aW9uKGVsZW1lbnQpewogICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gTk9ERV9UWVBFX0VMRU1FTlQpCiAgICAgICAgY2hpbGRyZW4ucHVzaChlbGVtZW50KTsKICAgIH0pOwogICAgcmV0dXJuIGNoaWxkcmVuOwogIH0sCgogIGNvbnRlbnRzOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICByZXR1cm4gZWxlbWVudC5jb250ZW50RG9jdW1lbnQgfHwgZWxlbWVudC5jaGlsZE5vZGVzIHx8IFtdOwogIH0sCgogIGFwcGVuZDogZnVuY3Rpb24oZWxlbWVudCwgbm9kZSkgewogICAgdmFyIG5vZGVUeXBlID0gZWxlbWVudC5ub2RlVHlwZTsKICAgIGlmIChub2RlVHlwZSAhPT0gTk9ERV9UWVBFX0VMRU1FTlQgJiYgbm9kZVR5cGUgIT09IE5PREVfVFlQRV9ET0NVTUVOVF9GUkFHTUVOVCkgcmV0dXJuOwoKICAgIG5vZGUgPSBuZXcgSlFMaXRlKG5vZGUpOwoKICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IG5vZGUubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICB2YXIgY2hpbGQgPSBub2RlW2ldOwogICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgIH0KICB9LAoKICBwcmVwZW5kOiBmdW5jdGlvbihlbGVtZW50LCBub2RlKSB7CiAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gTk9ERV9UWVBFX0VMRU1FTlQpIHsKICAgICAgdmFyIGluZGV4ID0gZWxlbWVudC5maXJzdENoaWxkOwogICAgICBmb3JFYWNoKG5ldyBKUUxpdGUobm9kZSksIGZ1bmN0aW9uKGNoaWxkKXsKICAgICAgICBlbGVtZW50Lmluc2VydEJlZm9yZShjaGlsZCwgaW5kZXgpOwogICAgICB9KTsKICAgIH0KICB9LAoKICB3cmFwOiBmdW5jdGlvbihlbGVtZW50LCB3cmFwTm9kZSkgewogICAgd3JhcE5vZGUgPSBqcUxpdGUod3JhcE5vZGUpLmVxKDApLmNsb25lKClbMF07CiAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgaWYgKHBhcmVudCkgewogICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKHdyYXBOb2RlLCBlbGVtZW50KTsKICAgIH0KICAgIHdyYXBOb2RlLmFwcGVuZENoaWxkKGVsZW1lbnQpOwogIH0sCgogIHJlbW92ZToganFMaXRlUmVtb3ZlLAoKICBkZXRhY2g6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIGpxTGl0ZVJlbW92ZShlbGVtZW50LCB0cnVlKTsKICB9LAoKICBhZnRlcjogZnVuY3Rpb24oZWxlbWVudCwgbmV3RWxlbWVudCkgewogICAgdmFyIGluZGV4ID0gZWxlbWVudCwgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgbmV3RWxlbWVudCA9IG5ldyBKUUxpdGUobmV3RWxlbWVudCk7CgogICAgZm9yICh2YXIgaSA9IDAsIGlpID0gbmV3RWxlbWVudC5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgIHZhciBub2RlID0gbmV3RWxlbWVudFtpXTsKICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCBpbmRleC5uZXh0U2libGluZyk7CiAgICAgIGluZGV4ID0gbm9kZTsKICAgIH0KICB9LAoKICBhZGRDbGFzczoganFMaXRlQWRkQ2xhc3MsCiAgcmVtb3ZlQ2xhc3M6IGpxTGl0ZVJlbW92ZUNsYXNzLAoKICB0b2dnbGVDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgc2VsZWN0b3IsIGNvbmRpdGlvbikgewogICAgaWYgKHNlbGVjdG9yKSB7CiAgICAgIGZvckVhY2goc2VsZWN0b3Iuc3BsaXQoJyAnKSwgZnVuY3Rpb24oY2xhc3NOYW1lKXsKICAgICAgICB2YXIgY2xhc3NDb25kaXRpb24gPSBjb25kaXRpb247CiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGNsYXNzQ29uZGl0aW9uKSkgewogICAgICAgICAgY2xhc3NDb25kaXRpb24gPSAhanFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICB9CiAgICAgICAgKGNsYXNzQ29uZGl0aW9uID8ganFMaXRlQWRkQ2xhc3MgOiBqcUxpdGVSZW1vdmVDbGFzcykoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgfSk7CiAgICB9CiAgfSwKCiAgcGFyZW50OiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IE5PREVfVFlQRV9ET0NVTUVOVF9GUkFHTUVOVCA/IHBhcmVudCA6IG51bGw7CiAgfSwKCiAgbmV4dDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nOwogIH0sCgogIGZpbmQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICBpZiAoZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSkgewogICAgICByZXR1cm4gZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShzZWxlY3Rvcik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gW107CiAgICB9CiAgfSwKCiAgY2xvbmU6IGpxTGl0ZUNsb25lLAoKICB0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24oZWxlbWVudCwgZXZlbnQsIGV4dHJhUGFyYW1ldGVycykgewoKICAgIHZhciBkdW1teUV2ZW50LCBldmVudEZuc0NvcHksIGhhbmRsZXJBcmdzOwogICAgdmFyIGV2ZW50TmFtZSA9IGV2ZW50LnR5cGUgfHwgZXZlbnQ7CiAgICB2YXIgZXhwYW5kb1N0b3JlID0ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQpOwogICAgdmFyIGV2ZW50cyA9IGV4cGFuZG9TdG9yZSAmJiBleHBhbmRvU3RvcmUuZXZlbnRzOwogICAgdmFyIGV2ZW50Rm5zID0gZXZlbnRzICYmIGV2ZW50c1tldmVudE5hbWVdOwoKICAgIGlmIChldmVudEZucykgewogICAgICAvLyBDcmVhdGUgYSBkdW1teSBldmVudCB0byBwYXNzIHRvIHRoZSBoYW5kbGVycwogICAgICBkdW1teUV2ZW50ID0gewogICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsgdGhpcy5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsgfSwKICAgICAgICBpc0RlZmF1bHRQcmV2ZW50ZWQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5kZWZhdWx0UHJldmVudGVkID09PSB0cnVlOyB9LAogICAgICAgIHN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7IHRoaXMuaW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkID0gdHJ1ZTsgfSwKICAgICAgICBpc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZDogZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzLmltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9PT0gdHJ1ZTsgfSwKICAgICAgICBzdG9wUHJvcGFnYXRpb246IG5vb3AsCiAgICAgICAgdHlwZTogZXZlbnROYW1lLAogICAgICAgIHRhcmdldDogZWxlbWVudAogICAgICB9OwoKICAgICAgLy8gSWYgYSBjdXN0b20gZXZlbnQgd2FzIHByb3ZpZGVkIHRoZW4gZXh0ZW5kIG91ciBkdW1teSBldmVudCB3aXRoIGl0CiAgICAgIGlmIChldmVudC50eXBlKSB7CiAgICAgICAgZHVtbXlFdmVudCA9IGV4dGVuZChkdW1teUV2ZW50LCBldmVudCk7CiAgICAgIH0KCiAgICAgIC8vIENvcHkgZXZlbnQgaGFuZGxlcnMgaW4gY2FzZSBldmVudCBoYW5kbGVycyBhcnJheSBpcyBtb2RpZmllZCBkdXJpbmcgZXhlY3V0aW9uLgogICAgICBldmVudEZuc0NvcHkgPSBzaGFsbG93Q29weShldmVudEZucyk7CiAgICAgIGhhbmRsZXJBcmdzID0gZXh0cmFQYXJhbWV0ZXJzID8gW2R1bW15RXZlbnRdLmNvbmNhdChleHRyYVBhcmFtZXRlcnMpIDogW2R1bW15RXZlbnRdOwoKICAgICAgZm9yRWFjaChldmVudEZuc0NvcHksIGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgaWYgKCFkdW1teUV2ZW50LmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICAgIGZuLmFwcGx5KGVsZW1lbnQsIGhhbmRsZXJBcmdzKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KfSwgZnVuY3Rpb24oZm4sIG5hbWUpewogIC8qKgogICAqIGNoYWluaW5nIGZ1bmN0aW9ucwogICAqLwogIEpRTGl0ZS5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbihhcmcxLCBhcmcyLCBhcmczKSB7CiAgICB2YXIgdmFsdWU7CgogICAgZm9yKHZhciBpID0gMCwgaWkgPSB0aGlzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgIHZhbHVlID0gZm4odGhpc1tpXSwgYXJnMSwgYXJnMiwgYXJnMyk7CiAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgIC8vIGFueSBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGEgdmFsdWUgbmVlZHMgdG8gYmUgd3JhcHBlZAogICAgICAgICAgdmFsdWUgPSBqcUxpdGUodmFsdWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBqcUxpdGVBZGROb2Rlcyh2YWx1ZSwgZm4odGhpc1tpXSwgYXJnMSwgYXJnMiwgYXJnMykpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gaXNEZWZpbmVkKHZhbHVlKSA/IHZhbHVlIDogdGhpczsKICB9OwoKICAvLyBiaW5kIGxlZ2FjeSBiaW5kL3VuYmluZCB0byBvbi9vZmYKICBKUUxpdGUucHJvdG90eXBlLmJpbmQgPSBKUUxpdGUucHJvdG90eXBlLm9uOwogIEpRTGl0ZS5wcm90b3R5cGUudW5iaW5kID0gSlFMaXRlLnByb3RvdHlwZS5vZmY7Cn0pOwoKLyoqCiAqIENvbXB1dGVzIGEgaGFzaCBvZiBhbiAnb2JqJy4KICogSGFzaCBvZiBhOgogKiAgc3RyaW5nIGlzIHN0cmluZwogKiAgbnVtYmVyIGlzIG51bWJlciBhcyBzdHJpbmcKICogIG9iamVjdCBpcyBlaXRoZXIgcmVzdWx0IG9mIGNhbGxpbmcgJCRoYXNoS2V5IGZ1bmN0aW9uIG9uIHRoZSBvYmplY3Qgb3IgdW5pcXVlbHkgZ2VuZXJhdGVkIGlkLAogKiAgICAgICAgIHRoYXQgaXMgYWxzbyBhc3NpZ25lZCB0byB0aGUgJCRoYXNoS2V5IHByb3BlcnR5IG9mIHRoZSBvYmplY3QuCiAqCiAqIEBwYXJhbSBvYmoKICogQHJldHVybnMge3N0cmluZ30gaGFzaCBzdHJpbmcgc3VjaCB0aGF0IHRoZSBzYW1lIGlucHV0IHdpbGwgaGF2ZSB0aGUgc2FtZSBoYXNoIHN0cmluZy4KICogICAgICAgICBUaGUgcmVzdWx0aW5nIHN0cmluZyBrZXkgaXMgaW4gJ3R5cGU6aGFzaEtleScgZm9ybWF0LgogKi8KZnVuY3Rpb24gaGFzaEtleShvYmosIG5leHRVaWRGbikgewogIHZhciBrZXkgPSBvYmogJiYgb2JqLiQkaGFzaEtleTsKCiAgaWYgKGtleSkgewogICAgaWYgKHR5cGVvZiBrZXkgPT09ICdmdW5jdGlvbicpIHsKICAgICAga2V5ID0gb2JqLiQkaGFzaEtleSgpOwogICAgfQogICAgcmV0dXJuIGtleTsKICB9CgogIHZhciBvYmpUeXBlID0gdHlwZW9mIG9iajsKICBpZiAob2JqVHlwZSA9PSAnZnVuY3Rpb24nIHx8IChvYmpUeXBlID09ICdvYmplY3QnICYmIG9iaiAhPT0gbnVsbCkpIHsKICAgIGtleSA9IG9iai4kJGhhc2hLZXkgPSBvYmpUeXBlICsgJzonICsgKG5leHRVaWRGbiB8fCBuZXh0VWlkKSgpOwogIH0gZWxzZSB7CiAgICBrZXkgPSBvYmpUeXBlICsgJzonICsgb2JqOwogIH0KCiAgcmV0dXJuIGtleTsKfQoKLyoqCiAqIEhhc2hNYXAgd2hpY2ggY2FuIHVzZSBvYmplY3RzIGFzIGtleXMKICovCmZ1bmN0aW9uIEhhc2hNYXAoYXJyYXksIGlzb2xhdGVkVWlkKSB7CiAgaWYgKGlzb2xhdGVkVWlkKSB7CiAgICB2YXIgdWlkID0gMDsKICAgIHRoaXMubmV4dFVpZCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gKyt1aWQ7CiAgICB9OwogIH0KICBmb3JFYWNoKGFycmF5LCB0aGlzLnB1dCwgdGhpcyk7Cn0KSGFzaE1hcC5wcm90b3R5cGUgPSB7CiAgLyoqCiAgICogU3RvcmUga2V5IHZhbHVlIHBhaXIKICAgKiBAcGFyYW0ga2V5IGtleSB0byBzdG9yZSBjYW4gYmUgYW55IHR5cGUKICAgKiBAcGFyYW0gdmFsdWUgdmFsdWUgdG8gc3RvcmUgY2FuIGJlIGFueSB0eXBlCiAgICovCiAgcHV0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICB0aGlzW2hhc2hLZXkoa2V5LCB0aGlzLm5leHRVaWQpXSA9IHZhbHVlOwogIH0sCgogIC8qKgogICAqIEBwYXJhbSBrZXkKICAgKiBAcmV0dXJucyB7T2JqZWN0fSB0aGUgdmFsdWUgZm9yIHRoZSBrZXkKICAgKi8KICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgcmV0dXJuIHRoaXNbaGFzaEtleShrZXksIHRoaXMubmV4dFVpZCldOwogIH0sCgogIC8qKgogICAqIFJlbW92ZSB0aGUga2V5L3ZhbHVlIHBhaXIKICAgKiBAcGFyYW0ga2V5CiAgICovCiAgcmVtb3ZlOiBmdW5jdGlvbihrZXkpIHsKICAgIHZhciB2YWx1ZSA9IHRoaXNba2V5ID0gaGFzaEtleShrZXksIHRoaXMubmV4dFVpZCldOwogICAgZGVsZXRlIHRoaXNba2V5XTsKICAgIHJldHVybiB2YWx1ZTsKICB9Cn07CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBtb2R1bGUgbmcKICogQG5hbWUgYW5ndWxhci5pbmplY3RvcgogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ3JlYXRlcyBhbiBpbmplY3RvciBvYmplY3QgdGhhdCBjYW4gYmUgdXNlZCBmb3IgcmV0cmlldmluZyBzZXJ2aWNlcyBhcyB3ZWxsIGFzIGZvcgogKiBkZXBlbmRlbmN5IGluamVjdGlvbiAoc2VlIHtAbGluayBndWlkZS9kaSBkZXBlbmRlbmN5IGluamVjdGlvbn0pLgogKgoKICogQHBhcmFtIHtBcnJheS48c3RyaW5nfEZ1bmN0aW9uPn0gbW9kdWxlcyBBIGxpc3Qgb2YgbW9kdWxlIGZ1bmN0aW9ucyBvciB0aGVpciBhbGlhc2VzLiBTZWUKICogICAgICAgIHtAbGluayBhbmd1bGFyLm1vZHVsZX0uIFRoZSBgbmdgIG1vZHVsZSBtdXN0IGJlIGV4cGxpY2l0bHkgYWRkZWQuCiAqIEByZXR1cm5zIHtpbmplY3Rvcn0gSW5qZWN0b3Igb2JqZWN0LiBTZWUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAqCiAqIEBleGFtcGxlCiAqIFR5cGljYWwgdXNhZ2UKICogYGBganMKICogICAvLyBjcmVhdGUgYW4gaW5qZWN0b3IKICogICB2YXIgJGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcihbJ25nJ10pOwogKgogKiAgIC8vIHVzZSB0aGUgaW5qZWN0b3IgdG8ga2ljayBvZmYgeW91ciBhcHBsaWNhdGlvbgogKiAgIC8vIHVzZSB0aGUgdHlwZSBpbmZlcmVuY2UgdG8gYXV0byBpbmplY3QgYXJndW1lbnRzLCBvciB1c2UgaW1wbGljaXQgaW5qZWN0aW9uCiAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbigkcm9vdFNjb3BlLCAkY29tcGlsZSwgJGRvY3VtZW50KSB7CiAqICAgICAkY29tcGlsZSgkZG9jdW1lbnQpKCRyb290U2NvcGUpOwogKiAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAqICAgfSk7CiAqIGBgYAogKgogKiBTb21ldGltZXMgeW91IHdhbnQgdG8gZ2V0IGFjY2VzcyB0byB0aGUgaW5qZWN0b3Igb2YgYSBjdXJyZW50bHkgcnVubmluZyBBbmd1bGFyIGFwcAogKiBmcm9tIG91dHNpZGUgQW5ndWxhci4gUGVyaGFwcywgeW91IHdhbnQgdG8gaW5qZWN0IGFuZCBjb21waWxlIHNvbWUgbWFya3VwIGFmdGVyIHRoZQogKiBhcHBsaWNhdGlvbiBoYXMgYmVlbiBib290c3RyYXBwZWQuIFlvdSBjYW4gZG8gdGhpcyB1c2luZyB0aGUgZXh0cmEgYGluamVjdG9yKClgIGFkZGVkCiAqIHRvIEpRdWVyeS9qcUxpdGUgZWxlbWVudHMuIFNlZSB7QGxpbmsgYW5ndWxhci5lbGVtZW50fS4KICoKICogKlRoaXMgaXMgZmFpcmx5IHJhcmUgYnV0IGNvdWxkIGJlIHRoZSBjYXNlIGlmIGEgdGhpcmQgcGFydHkgbGlicmFyeSBpcyBpbmplY3RpbmcgdGhlCiAqIG1hcmt1cC4qCiAqCiAqIEluIHRoZSBmb2xsb3dpbmcgZXhhbXBsZSBhIG5ldyBibG9jayBvZiBIVE1MIGNvbnRhaW5pbmcgYSBgbmctY29udHJvbGxlcmAKICogZGlyZWN0aXZlIGlzIGFkZGVkIHRvIHRoZSBlbmQgb2YgdGhlIGRvY3VtZW50IGJvZHkgYnkgSlF1ZXJ5LiBXZSB0aGVuIGNvbXBpbGUgYW5kIGxpbmsKICogaXQgaW50byB0aGUgY3VycmVudCBBbmd1bGFySlMgc2NvcGUuCiAqCiAqIGBgYGpzCiAqIHZhciAkZGl2ID0gJCgnPGRpdiBuZy1jb250cm9sbGVyPSJNeUN0cmwiPnt7Y29udGVudC5sYWJlbH19PC9kaXY+Jyk7CiAqICQoZG9jdW1lbnQuYm9keSkuYXBwZW5kKCRkaXYpOwogKgogKiBhbmd1bGFyLmVsZW1lbnQoZG9jdW1lbnQpLmluamVjdG9yKCkuaW52b2tlKGZ1bmN0aW9uKCRjb21waWxlKSB7CiAqICAgdmFyIHNjb3BlID0gYW5ndWxhci5lbGVtZW50KCRkaXYpLnNjb3BlKCk7CiAqICAgJGNvbXBpbGUoJGRpdikoc2NvcGUpOwogKiB9KTsKICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgbW9kdWxlCiAqIEBuYW1lIGF1dG8KICogQGRlc2NyaXB0aW9uCiAqCiAqIEltcGxpY2l0IG1vZHVsZSB3aGljaCBnZXRzIGF1dG9tYXRpY2FsbHkgYWRkZWQgdG8gZWFjaCB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4KICovCgp2YXIgRk5fQVJHUyA9IC9eZnVuY3Rpb25ccypbXlwoXSpcKFxzKihbXlwpXSopXCkvbTsKdmFyIEZOX0FSR19TUExJVCA9IC8sLzsKdmFyIEZOX0FSRyA9IC9eXHMqKF8/KShcUys/KVwxXHMqJC87CnZhciBTVFJJUF9DT01NRU5UUyA9IC8oKFwvXC8uKiQpfChcL1wqW1xzXFNdKj9cKlwvKSkvbWc7CnZhciAkaW5qZWN0b3JNaW5FcnIgPSBtaW5FcnIoJyRpbmplY3RvcicpOwoKZnVuY3Rpb24gYW5vbkZuKGZuKSB7CiAgLy8gRm9yIGFub255bW91cyBmdW5jdGlvbnMsIHNob3dpbmcgYXQgdGhlIHZlcnkgbGVhc3QgdGhlIGZ1bmN0aW9uIHNpZ25hdHVyZSBjYW4gaGVscCBpbgogIC8vIGRlYnVnZ2luZy4KICB2YXIgZm5UZXh0ID0gZm4udG9TdHJpbmcoKS5yZXBsYWNlKFNUUklQX0NPTU1FTlRTLCAnJyksCiAgICAgIGFyZ3MgPSBmblRleHQubWF0Y2goRk5fQVJHUyk7CiAgaWYgKGFyZ3MpIHsKICAgIHJldHVybiAnZnVuY3Rpb24oJyArIChhcmdzWzFdIHx8ICcnKS5yZXBsYWNlKC9bXHNcclxuXSsvLCAnICcpICsgJyknOwogIH0KICByZXR1cm4gJ2ZuJzsKfQoKZnVuY3Rpb24gYW5ub3RhdGUoZm4sIHN0cmljdERpLCBuYW1lKSB7CiAgdmFyICRpbmplY3QsCiAgICAgIGZuVGV4dCwKICAgICAgYXJnRGVjbCwKICAgICAgbGFzdDsKCiAgaWYgKHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgaWYgKCEoJGluamVjdCA9IGZuLiRpbmplY3QpKSB7CiAgICAgICRpbmplY3QgPSBbXTsKICAgICAgaWYgKGZuLmxlbmd0aCkgewogICAgICAgIGlmIChzdHJpY3REaSkgewogICAgICAgICAgaWYgKCFpc1N0cmluZyhuYW1lKSB8fCAhbmFtZSkgewogICAgICAgICAgICBuYW1lID0gZm4ubmFtZSB8fCBhbm9uRm4oZm4pOwogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgJGluamVjdG9yTWluRXJyKCdzdHJpY3RkaScsCiAgICAgICAgICAgICd7MH0gaXMgbm90IHVzaW5nIGV4cGxpY2l0IGFubm90YXRpb24gYW5kIGNhbm5vdCBiZSBpbnZva2VkIGluIHN0cmljdCBtb2RlJywgbmFtZSk7CiAgICAgICAgfQogICAgICAgIGZuVGV4dCA9IGZuLnRvU3RyaW5nKCkucmVwbGFjZShTVFJJUF9DT01NRU5UUywgJycpOwogICAgICAgIGFyZ0RlY2wgPSBmblRleHQubWF0Y2goRk5fQVJHUyk7CiAgICAgICAgZm9yRWFjaChhcmdEZWNsWzFdLnNwbGl0KEZOX0FSR19TUExJVCksIGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgYXJnLnJlcGxhY2UoRk5fQVJHLCBmdW5jdGlvbihhbGwsIHVuZGVyc2NvcmUsIG5hbWUpIHsKICAgICAgICAgICAgJGluamVjdC5wdXNoKG5hbWUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZm4uJGluamVjdCA9ICRpbmplY3Q7CiAgICB9CiAgfSBlbHNlIGlmIChpc0FycmF5KGZuKSkgewogICAgbGFzdCA9IGZuLmxlbmd0aCAtIDE7CiAgICBhc3NlcnRBcmdGbihmbltsYXN0XSwgJ2ZuJyk7CiAgICAkaW5qZWN0ID0gZm4uc2xpY2UoMCwgbGFzdCk7CiAgfSBlbHNlIHsKICAgIGFzc2VydEFyZ0ZuKGZuLCAnZm4nLCB0cnVlKTsKICB9CiAgcmV0dXJuICRpbmplY3Q7Cn0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRpbmplY3RvcgogKgogKiBAZGVzY3JpcHRpb24KICoKICogYCRpbmplY3RvcmAgaXMgdXNlZCB0byByZXRyaWV2ZSBvYmplY3QgaW5zdGFuY2VzIGFzIGRlZmluZWQgYnkKICoge0BsaW5rIGF1dG8uJHByb3ZpZGUgcHJvdmlkZXJ9LCBpbnN0YW50aWF0ZSB0eXBlcywgaW52b2tlIG1ldGhvZHMsCiAqIGFuZCBsb2FkIG1vZHVsZXMuCiAqCiAqIFRoZSBmb2xsb3dpbmcgYWx3YXlzIGhvbGRzIHRydWU6CiAqCiAqIGBgYGpzCiAqICAgdmFyICRpbmplY3RvciA9IGFuZ3VsYXIuaW5qZWN0b3IoKTsKICogICBleHBlY3QoJGluamVjdG9yLmdldCgnJGluamVjdG9yJykpLnRvQmUoJGluamVjdG9yKTsKICogICBleHBlY3QoJGluamVjdG9yLmludm9rZShmdW5jdGlvbigkaW5qZWN0b3IpIHsKICogICAgIHJldHVybiAkaW5qZWN0b3I7CiAqICAgfSkpLnRvQmUoJGluamVjdG9yKTsKICogYGBgCiAqCiAqICMgSW5qZWN0aW9uIEZ1bmN0aW9uIEFubm90YXRpb24KICoKICogSmF2YVNjcmlwdCBkb2VzIG5vdCBoYXZlIGFubm90YXRpb25zLCBhbmQgYW5ub3RhdGlvbnMgYXJlIG5lZWRlZCBmb3IgZGVwZW5kZW5jeSBpbmplY3Rpb24uIFRoZQogKiBmb2xsb3dpbmcgYXJlIGFsbCB2YWxpZCB3YXlzIG9mIGFubm90YXRpbmcgZnVuY3Rpb24gd2l0aCBpbmplY3Rpb24gYXJndW1lbnRzIGFuZCBhcmUgZXF1aXZhbGVudC4KICoKICogYGBganMKICogICAvLyBpbmZlcnJlZCAob25seSB3b3JrcyBpZiBjb2RlIG5vdCBtaW5pZmllZC9vYmZ1c2NhdGVkKQogKiAgICRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oc2VydmljZUEpe30pOwogKgogKiAgIC8vIGFubm90YXRlZAogKiAgIGZ1bmN0aW9uIGV4cGxpY2l0KHNlcnZpY2VBKSB7fTsKICogICBleHBsaWNpdC4kaW5qZWN0ID0gWydzZXJ2aWNlQSddOwogKiAgICRpbmplY3Rvci5pbnZva2UoZXhwbGljaXQpOwogKgogKiAgIC8vIGlubGluZQogKiAgICRpbmplY3Rvci5pbnZva2UoWydzZXJ2aWNlQScsIGZ1bmN0aW9uKHNlcnZpY2VBKXt9XSk7CiAqIGBgYAogKgogKiAjIyBJbmZlcmVuY2UKICoKICogSW4gSmF2YVNjcmlwdCBjYWxsaW5nIGB0b1N0cmluZygpYCBvbiBhIGZ1bmN0aW9uIHJldHVybnMgdGhlIGZ1bmN0aW9uIGRlZmluaXRpb24uIFRoZSBkZWZpbml0aW9uCiAqIGNhbiB0aGVuIGJlIHBhcnNlZCBhbmQgdGhlIGZ1bmN0aW9uIGFyZ3VtZW50cyBjYW4gYmUgZXh0cmFjdGVkLiAqTk9URToqIFRoaXMgZG9lcyBub3Qgd29yayB3aXRoCiAqIG1pbmlmaWNhdGlvbiwgYW5kIG9iZnVzY2F0aW9uIHRvb2xzIHNpbmNlIHRoZXNlIHRvb2xzIGNoYW5nZSB0aGUgYXJndW1lbnQgbmFtZXMuCiAqCiAqICMjIGAkaW5qZWN0YCBBbm5vdGF0aW9uCiAqIEJ5IGFkZGluZyBhbiBgJGluamVjdGAgcHJvcGVydHkgb250byBhIGZ1bmN0aW9uIHRoZSBpbmplY3Rpb24gcGFyYW1ldGVycyBjYW4gYmUgc3BlY2lmaWVkLgogKgogKiAjIyBJbmxpbmUKICogQXMgYW4gYXJyYXkgb2YgaW5qZWN0aW9uIG5hbWVzLCB3aGVyZSB0aGUgbGFzdCBpdGVtIGluIHRoZSBhcnJheSBpcyB0aGUgZnVuY3Rpb24gdG8gY2FsbC4KICovCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkaW5qZWN0b3IjZ2V0CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBSZXR1cm4gYW4gaW5zdGFuY2Ugb2YgdGhlIHNlcnZpY2UuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0byByZXRyaWV2ZS4KICogQHJldHVybiB7Kn0gVGhlIGluc3RhbmNlLgogKi8KCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRpbmplY3RvciNpbnZva2UKICoKICogQGRlc2NyaXB0aW9uCiAqIEludm9rZSB0aGUgbWV0aG9kIGFuZCBzdXBwbHkgdGhlIG1ldGhvZCBhcmd1bWVudHMgZnJvbSB0aGUgYCRpbmplY3RvcmAuCiAqCiAqIEBwYXJhbSB7IUZ1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gaW52b2tlLiBGdW5jdGlvbiBwYXJhbWV0ZXJzIGFyZSBpbmplY3RlZCBhY2NvcmRpbmcgdG8gdGhlCiAqICAge0BsaW5rIGd1aWRlL2RpICRpbmplY3QgQW5ub3RhdGlvbn0gcnVsZXMuCiAqIEBwYXJhbSB7T2JqZWN0PX0gc2VsZiBUaGUgYHRoaXNgIGZvciB0aGUgaW52b2tlZCBtZXRob2QuCiAqIEBwYXJhbSB7T2JqZWN0PX0gbG9jYWxzIE9wdGlvbmFsIG9iamVjdC4gSWYgcHJlc2V0IHRoZW4gYW55IGFyZ3VtZW50IG5hbWVzIGFyZSByZWFkIGZyb20gdGhpcwogKiAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QgZmlyc3QsIGJlZm9yZSB0aGUgYCRpbmplY3RvcmAgaXMgY29uc3VsdGVkLgogKiBAcmV0dXJucyB7Kn0gdGhlIHZhbHVlIHJldHVybmVkIGJ5IHRoZSBpbnZva2VkIGBmbmAgZnVuY3Rpb24uCiAqLwoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJGluamVjdG9yI2hhcwogKgogKiBAZGVzY3JpcHRpb24KICogQWxsb3dzIHRoZSB1c2VyIHRvIHF1ZXJ5IGlmIHRoZSBwYXJ0aWN1bGFyIHNlcnZpY2UgZXhpc3RzLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBzZXJ2aWNlIHRvIHF1ZXJ5LgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gYHRydWVgIGlmIGluamVjdG9yIGhhcyBnaXZlbiBzZXJ2aWNlLgogKi8KCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRpbmplY3RvciNpbnN0YW50aWF0ZQogKiBAZGVzY3JpcHRpb24KICogQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIEpTIHR5cGUuIFRoZSBtZXRob2QgdGFrZXMgYSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaW52b2tlcyB0aGUgbmV3CiAqIG9wZXJhdG9yLCBhbmQgc3VwcGxpZXMgYWxsIG9mIHRoZSBhcmd1bWVudHMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGFzIHNwZWNpZmllZCBieSB0aGUKICogY29uc3RydWN0b3IgYW5ub3RhdGlvbi4KICoKICogQHBhcmFtIHtGdW5jdGlvbn0gVHlwZSBBbm5vdGF0ZWQgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAqIEBwYXJhbSB7T2JqZWN0PX0gbG9jYWxzIE9wdGlvbmFsIG9iamVjdC4gSWYgcHJlc2V0IHRoZW4gYW55IGFyZ3VtZW50IG5hbWVzIGFyZSByZWFkIGZyb20gdGhpcwogKiBvYmplY3QgZmlyc3QsIGJlZm9yZSB0aGUgYCRpbmplY3RvcmAgaXMgY29uc3VsdGVkLgogKiBAcmV0dXJucyB7T2JqZWN0fSBuZXcgaW5zdGFuY2Ugb2YgYFR5cGVgLgogKi8KCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRpbmplY3RvciNhbm5vdGF0ZQogKgogKiBAZGVzY3JpcHRpb24KICogUmV0dXJucyBhbiBhcnJheSBvZiBzZXJ2aWNlIG5hbWVzIHdoaWNoIHRoZSBmdW5jdGlvbiBpcyByZXF1ZXN0aW5nIGZvciBpbmplY3Rpb24uIFRoaXMgQVBJIGlzCiAqIHVzZWQgYnkgdGhlIGluamVjdG9yIHRvIGRldGVybWluZSB3aGljaCBzZXJ2aWNlcyBuZWVkIHRvIGJlIGluamVjdGVkIGludG8gdGhlIGZ1bmN0aW9uIHdoZW4gdGhlCiAqIGZ1bmN0aW9uIGlzIGludm9rZWQuIFRoZXJlIGFyZSB0aHJlZSB3YXlzIGluIHdoaWNoIHRoZSBmdW5jdGlvbiBjYW4gYmUgYW5ub3RhdGVkIHdpdGggdGhlIG5lZWRlZAogKiBkZXBlbmRlbmNpZXMuCiAqCiAqICMgQXJndW1lbnQgbmFtZXMKICoKICogVGhlIHNpbXBsZXN0IGZvcm0gaXMgdG8gZXh0cmFjdCB0aGUgZGVwZW5kZW5jaWVzIGZyb20gdGhlIGFyZ3VtZW50cyBvZiB0aGUgZnVuY3Rpb24uIFRoaXMgaXMgZG9uZQogKiBieSBjb252ZXJ0aW5nIHRoZSBmdW5jdGlvbiBpbnRvIGEgc3RyaW5nIHVzaW5nIGB0b1N0cmluZygpYCBtZXRob2QgYW5kIGV4dHJhY3RpbmcgdGhlIGFyZ3VtZW50CiAqIG5hbWVzLgogKiBgYGBqcwogKiAgIC8vIEdpdmVuCiAqICAgZnVuY3Rpb24gTXlDb250cm9sbGVyKCRzY29wZSwgJHJvdXRlKSB7CiAqICAgICAvLyAuLi4KICogICB9CiAqCiAqICAgLy8gVGhlbgogKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZShNeUNvbnRyb2xsZXIpKS50b0VxdWFsKFsnJHNjb3BlJywgJyRyb3V0ZSddKTsKICogYGBgCiAqCiAqIFRoaXMgbWV0aG9kIGRvZXMgbm90IHdvcmsgd2l0aCBjb2RlIG1pbmlmaWNhdGlvbiAvIG9iZnVzY2F0aW9uLiBGb3IgdGhpcyByZWFzb24gdGhlIGZvbGxvd2luZwogKiBhbm5vdGF0aW9uIHN0cmF0ZWdpZXMgYXJlIHN1cHBvcnRlZC4KICoKICogIyBUaGUgYCRpbmplY3RgIHByb3BlcnR5CiAqCiAqIElmIGEgZnVuY3Rpb24gaGFzIGFuIGAkaW5qZWN0YCBwcm9wZXJ0eSBhbmQgaXRzIHZhbHVlIGlzIGFuIGFycmF5IG9mIHN0cmluZ3MsIHRoZW4gdGhlIHN0cmluZ3MKICogcmVwcmVzZW50IG5hbWVzIG9mIHNlcnZpY2VzIHRvIGJlIGluamVjdGVkIGludG8gdGhlIGZ1bmN0aW9uLgogKiBgYGBqcwogKiAgIC8vIEdpdmVuCiAqICAgdmFyIE15Q29udHJvbGxlciA9IGZ1bmN0aW9uKG9iZnVzY2F0ZWRTY29wZSwgb2JmdXNjYXRlZFJvdXRlKSB7CiAqICAgICAvLyAuLi4KICogICB9CiAqICAgLy8gRGVmaW5lIGZ1bmN0aW9uIGRlcGVuZGVuY2llcwogKiAgIE15Q29udHJvbGxlclsnJGluamVjdCddID0gWyckc2NvcGUnLCAnJHJvdXRlJ107CiAqCiAqICAgLy8gVGhlbgogKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZShNeUNvbnRyb2xsZXIpKS50b0VxdWFsKFsnJHNjb3BlJywgJyRyb3V0ZSddKTsKICogYGBgCiAqCiAqICMgVGhlIGFycmF5IG5vdGF0aW9uCiAqCiAqIEl0IGlzIG9mdGVuIGRlc2lyYWJsZSB0byBpbmxpbmUgSW5qZWN0ZWQgZnVuY3Rpb25zIGFuZCB0aGF0J3Mgd2hlbiBzZXR0aW5nIHRoZSBgJGluamVjdGAgcHJvcGVydHkKICogaXMgdmVyeSBpbmNvbnZlbmllbnQuIEluIHRoZXNlIHNpdHVhdGlvbnMgdXNpbmcgdGhlIGFycmF5IG5vdGF0aW9uIHRvIHNwZWNpZnkgdGhlIGRlcGVuZGVuY2llcyBpbgogKiBhIHdheSB0aGF0IHN1cnZpdmVzIG1pbmlmaWNhdGlvbiBpcyBhIGJldHRlciBjaG9pY2U6CiAqCiAqIGBgYGpzCiAqICAgLy8gV2Ugd2lzaCB0byB3cml0ZSB0aGlzIChub3QgbWluaWZpY2F0aW9uIC8gb2JmdXNjYXRpb24gc2FmZSkKICogICBpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJGNvbXBpbGUsICRyb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0pOwogKgogKiAgIC8vIFdlIGFyZSBmb3JjZWQgdG8gd3JpdGUgYnJlYWsgaW5saW5pbmcKICogICB2YXIgdG1wRm4gPSBmdW5jdGlvbihvYmZ1c2NhdGVkQ29tcGlsZSwgb2JmdXNjYXRlZFJvb3RTY29wZSkgewogKiAgICAgLy8gLi4uCiAqICAgfTsKICogICB0bXBGbi4kaW5qZWN0ID0gWyckY29tcGlsZScsICckcm9vdFNjb3BlJ107CiAqICAgaW5qZWN0b3IuaW52b2tlKHRtcEZuKTsKICoKICogICAvLyBUbyBiZXR0ZXIgc3VwcG9ydCBpbmxpbmUgZnVuY3Rpb24gdGhlIGlubGluZSBhbm5vdGF0aW9uIGlzIHN1cHBvcnRlZAogKiAgIGluamVjdG9yLmludm9rZShbJyRjb21waWxlJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbihvYmZDb21waWxlLCBvYmZSb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH1dKTsKICoKICogICAvLyBUaGVyZWZvcmUKICogICBleHBlY3QoaW5qZWN0b3IuYW5ub3RhdGUoCiAqICAgICAgWyckY29tcGlsZScsICckcm9vdFNjb3BlJywgZnVuY3Rpb24ob2JmdXNfJGNvbXBpbGUsIG9iZnVzXyRyb290U2NvcGUpIHt9XSkKICogICAgKS50b0VxdWFsKFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZSddKTsKICogYGBgCiAqCiAqIEBwYXJhbSB7RnVuY3Rpb258QXJyYXkuPHN0cmluZ3xGdW5jdGlvbj59IGZuIEZ1bmN0aW9uIGZvciB3aGljaCBkZXBlbmRlbnQgc2VydmljZSBuYW1lcyBuZWVkIHRvCiAqIGJlIHJldHJpZXZlZCBhcyBkZXNjcmliZWQgYWJvdmUuCiAqCiAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn0gVGhlIG5hbWVzIG9mIHRoZSBzZXJ2aWNlcyB3aGljaCB0aGUgZnVuY3Rpb24gcmVxdWlyZXMuCiAqLwoKCgoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRwcm92aWRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBUaGUge0BsaW5rIGF1dG8uJHByb3ZpZGUgJHByb3ZpZGV9IHNlcnZpY2UgaGFzIGEgbnVtYmVyIG9mIG1ldGhvZHMgZm9yIHJlZ2lzdGVyaW5nIGNvbXBvbmVudHMKICogd2l0aCB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0uIE1hbnkgb2YgdGhlc2UgZnVuY3Rpb25zIGFyZSBhbHNvIGV4cG9zZWQgb24KICoge0BsaW5rIGFuZ3VsYXIuTW9kdWxlfS4KICoKICogQW4gQW5ndWxhciAqKnNlcnZpY2UqKiBpcyBhIHNpbmdsZXRvbiBvYmplY3QgY3JlYXRlZCBieSBhICoqc2VydmljZSBmYWN0b3J5KiouICBUaGVzZSAqKnNlcnZpY2UKICogZmFjdG9yaWVzKiogYXJlIGZ1bmN0aW9ucyB3aGljaCwgaW4gdHVybiwgYXJlIGNyZWF0ZWQgYnkgYSAqKnNlcnZpY2UgcHJvdmlkZXIqKi4KICogVGhlICoqc2VydmljZSBwcm92aWRlcnMqKiBhcmUgY29uc3RydWN0b3IgZnVuY3Rpb25zLiBXaGVuIGluc3RhbnRpYXRlZCB0aGV5IG11c3QgY29udGFpbiBhCiAqIHByb3BlcnR5IGNhbGxlZCBgJGdldGAsIHdoaWNoIGhvbGRzIHRoZSAqKnNlcnZpY2UgZmFjdG9yeSoqIGZ1bmN0aW9uLgogKgogKiBXaGVuIHlvdSByZXF1ZXN0IGEgc2VydmljZSwgdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9IGlzIHJlc3BvbnNpYmxlIGZvciBmaW5kaW5nIHRoZQogKiBjb3JyZWN0ICoqc2VydmljZSBwcm92aWRlcioqLCBpbnN0YW50aWF0aW5nIGl0IGFuZCB0aGVuIGNhbGxpbmcgaXRzIGAkZ2V0YCAqKnNlcnZpY2UgZmFjdG9yeSoqCiAqIGZ1bmN0aW9uIHRvIGdldCB0aGUgaW5zdGFuY2Ugb2YgdGhlICoqc2VydmljZSoqLgogKgogKiBPZnRlbiBzZXJ2aWNlcyBoYXZlIG5vIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBhbmQgdGhlcmUgaXMgbm8gbmVlZCB0byBhZGQgbWV0aG9kcyB0byB0aGUgc2VydmljZQogKiBwcm92aWRlci4gIFRoZSBwcm92aWRlciB3aWxsIGJlIG5vIG1vcmUgdGhhbiBhIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIHdpdGggYSBgJGdldGAgcHJvcGVydHkuIEZvcgogKiB0aGVzZSBjYXNlcyB0aGUge0BsaW5rIGF1dG8uJHByb3ZpZGUgJHByb3ZpZGV9IHNlcnZpY2UgaGFzIGFkZGl0aW9uYWwgaGVscGVyIG1ldGhvZHMgdG8gcmVnaXN0ZXIKICogc2VydmljZXMgd2l0aG91dCBzcGVjaWZ5aW5nIGEgcHJvdmlkZXIuCiAqCiAqICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjcHJvdmlkZXIgcHJvdmlkZXIocHJvdmlkZXIpfSAtIHJlZ2lzdGVycyBhICoqc2VydmljZSBwcm92aWRlcioqIHdpdGggdGhlCiAqICAgICB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfQogKiAqIHtAbGluayBhdXRvLiRwcm92aWRlI2NvbnN0YW50IGNvbnN0YW50KG9iail9IC0gcmVnaXN0ZXJzIGEgdmFsdWUvb2JqZWN0IHRoYXQgY2FuIGJlIGFjY2Vzc2VkIGJ5CiAqICAgICBwcm92aWRlcnMgYW5kIHNlcnZpY2VzLgogKiAqIHtAbGluayBhdXRvLiRwcm92aWRlI3ZhbHVlIHZhbHVlKG9iail9IC0gcmVnaXN0ZXJzIGEgdmFsdWUvb2JqZWN0IHRoYXQgY2FuIG9ubHkgYmUgYWNjZXNzZWQgYnkKICogICAgIHNlcnZpY2VzLCBub3QgcHJvdmlkZXJzLgogKiAqIHtAbGluayBhdXRvLiRwcm92aWRlI2ZhY3RvcnkgZmFjdG9yeShmbil9IC0gcmVnaXN0ZXJzIGEgc2VydmljZSAqKmZhY3RvcnkgZnVuY3Rpb24qKiwgYGZuYCwKICogICAgIHRoYXQgd2lsbCBiZSB3cmFwcGVkIGluIGEgKipzZXJ2aWNlIHByb3ZpZGVyKiogb2JqZWN0LCB3aG9zZSBgJGdldGAgcHJvcGVydHkgd2lsbCBjb250YWluIHRoZQogKiAgICAgZ2l2ZW4gZmFjdG9yeSBmdW5jdGlvbi4KICogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNzZXJ2aWNlIHNlcnZpY2UoY2xhc3MpfSAtIHJlZ2lzdGVycyBhICoqY29uc3RydWN0b3IgZnVuY3Rpb24qKiwgYGNsYXNzYAogKiAgICAgdGhhdCB3aWxsIGJlIHdyYXBwZWQgaW4gYSAqKnNlcnZpY2UgcHJvdmlkZXIqKiBvYmplY3QsIHdob3NlIGAkZ2V0YCBwcm9wZXJ0eSB3aWxsIGluc3RhbnRpYXRlCiAqICAgICAgYSBuZXcgb2JqZWN0IHVzaW5nIHRoZSBnaXZlbiBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICoKICogU2VlIHRoZSBpbmRpdmlkdWFsIG1ldGhvZHMgZm9yIG1vcmUgaW5mb3JtYXRpb24gYW5kIGV4YW1wbGVzLgogKi8KCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRwcm92aWRlI3Byb3ZpZGVyCiAqIEBkZXNjcmlwdGlvbgogKgogKiBSZWdpc3RlciBhICoqcHJvdmlkZXIgZnVuY3Rpb24qKiB3aXRoIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4gUHJvdmlkZXIgZnVuY3Rpb25zCiAqIGFyZSBjb25zdHJ1Y3RvciBmdW5jdGlvbnMsIHdob3NlIGluc3RhbmNlcyBhcmUgcmVzcG9uc2libGUgZm9yICJwcm92aWRpbmciIGEgZmFjdG9yeSBmb3IgYQogKiBzZXJ2aWNlLgogKgogKiBTZXJ2aWNlIHByb3ZpZGVyIG5hbWVzIHN0YXJ0IHdpdGggdGhlIG5hbWUgb2YgdGhlIHNlcnZpY2UgdGhleSBwcm92aWRlIGZvbGxvd2VkIGJ5IGBQcm92aWRlcmAuCiAqIEZvciBleGFtcGxlLCB0aGUge0BsaW5rIG5nLiRsb2cgJGxvZ30gc2VydmljZSBoYXMgYSBwcm92aWRlciBjYWxsZWQKICoge0BsaW5rIG5nLiRsb2dQcm92aWRlciAkbG9nUHJvdmlkZXJ9LgogKgogKiBTZXJ2aWNlIHByb3ZpZGVyIG9iamVjdHMgY2FuIGhhdmUgYWRkaXRpb25hbCBtZXRob2RzIHdoaWNoIGFsbG93IGNvbmZpZ3VyYXRpb24gb2YgdGhlIHByb3ZpZGVyCiAqIGFuZCBpdHMgc2VydmljZS4gSW1wb3J0YW50bHksIHlvdSBjYW4gY29uZmlndXJlIHdoYXQga2luZCBvZiBzZXJ2aWNlIGlzIGNyZWF0ZWQgYnkgdGhlIGAkZ2V0YAogKiBtZXRob2QsIG9yIGhvdyB0aGF0IHNlcnZpY2Ugd2lsbCBhY3QuIEZvciBleGFtcGxlLCB0aGUge0BsaW5rIG5nLiRsb2dQcm92aWRlciAkbG9nUHJvdmlkZXJ9IGhhcyBhCiAqIG1ldGhvZCB7QGxpbmsgbmcuJGxvZ1Byb3ZpZGVyI2RlYnVnRW5hYmxlZCBkZWJ1Z0VuYWJsZWR9CiAqIHdoaWNoIGxldHMgeW91IHNwZWNpZnkgd2hldGhlciB0aGUge0BsaW5rIG5nLiRsb2cgJGxvZ30gc2VydmljZSB3aWxsIGxvZyBkZWJ1ZyBtZXNzYWdlcyB0byB0aGUKICogY29uc29sZSBvciBub3QuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4gTk9URTogdGhlIHByb3ZpZGVyIHdpbGwgYmUgYXZhaWxhYmxlIHVuZGVyIGBuYW1lICsKICAgICAgICAgICAgICAgICAgICAgICAgJ1Byb3ZpZGVyJ2Aga2V5LgogKiBAcGFyYW0geyhPYmplY3R8ZnVuY3Rpb24oKSl9IHByb3ZpZGVyIElmIHRoZSBwcm92aWRlciBpczoKICoKICogICAtIGBPYmplY3RgOiB0aGVuIGl0IHNob3VsZCBoYXZlIGEgYCRnZXRgIG1ldGhvZC4gVGhlIGAkZ2V0YCBtZXRob2Qgd2lsbCBiZSBpbnZva2VkIHVzaW5nCiAqICAgICB7QGxpbmsgYXV0by4kaW5qZWN0b3IjaW52b2tlICRpbmplY3Rvci5pbnZva2UoKX0gd2hlbiBhbiBpbnN0YW5jZSBuZWVkcyB0byBiZSBjcmVhdGVkLgogKiAgIC0gYENvbnN0cnVjdG9yYDogYSBuZXcgaW5zdGFuY2Ugb2YgdGhlIHByb3ZpZGVyIHdpbGwgYmUgY3JlYXRlZCB1c2luZwogKiAgICAge0BsaW5rIGF1dG8uJGluamVjdG9yI2luc3RhbnRpYXRlICRpbmplY3Rvci5pbnN0YW50aWF0ZSgpfSwgdGhlbiB0cmVhdGVkIGFzIGBvYmplY3RgLgogKgogKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCgogKiBAZXhhbXBsZQogKgogKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgc2hvd3MgaG93IHRvIGNyZWF0ZSBhIHNpbXBsZSBldmVudCB0cmFja2luZyBzZXJ2aWNlIGFuZCByZWdpc3RlciBpdCB1c2luZwogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNwcm92aWRlciAkcHJvdmlkZS5wcm92aWRlcigpfS4KICoKICogYGBganMKICogIC8vIERlZmluZSB0aGUgZXZlbnRUcmFja2VyIHByb3ZpZGVyCiAqICBmdW5jdGlvbiBFdmVudFRyYWNrZXJQcm92aWRlcigpIHsKICogICAgdmFyIHRyYWNraW5nVXJsID0gJy90cmFjayc7CiAqCiAqICAgIC8vIEEgcHJvdmlkZXIgbWV0aG9kIGZvciBjb25maWd1cmluZyB3aGVyZSB0aGUgdHJhY2tlZCBldmVudHMgc2hvdWxkIGJlZW4gc2F2ZWQKICogICAgdGhpcy5zZXRUcmFja2luZ1VybCA9IGZ1bmN0aW9uKHVybCkgewogKiAgICAgIHRyYWNraW5nVXJsID0gdXJsOwogKiAgICB9OwogKgogKiAgICAvLyBUaGUgc2VydmljZSBmYWN0b3J5IGZ1bmN0aW9uCiAqICAgIHRoaXMuJGdldCA9IFsnJGh0dHAnLCBmdW5jdGlvbigkaHR0cCkgewogKiAgICAgIHZhciB0cmFja2VkRXZlbnRzID0ge307CiAqICAgICAgcmV0dXJuIHsKICogICAgICAgIC8vIENhbGwgdGhpcyB0byB0cmFjayBhbiBldmVudAogKiAgICAgICAgZXZlbnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAqICAgICAgICAgIHZhciBjb3VudCA9IHRyYWNrZWRFdmVudHNbZXZlbnRdIHx8IDA7CiAqICAgICAgICAgIGNvdW50ICs9IDE7CiAqICAgICAgICAgIHRyYWNrZWRFdmVudHNbZXZlbnRdID0gY291bnQ7CiAqICAgICAgICAgIHJldHVybiBjb3VudDsKICogICAgICAgIH0sCiAqICAgICAgICAvLyBDYWxsIHRoaXMgdG8gc2F2ZSB0aGUgdHJhY2tlZCBldmVudHMgdG8gdGhlIHRyYWNraW5nVXJsCiAqICAgICAgICBzYXZlOiBmdW5jdGlvbigpIHsKICogICAgICAgICAgJGh0dHAucG9zdCh0cmFja2luZ1VybCwgdHJhY2tlZEV2ZW50cyk7CiAqICAgICAgICB9CiAqICAgICAgfTsKICogICAgfV07CiAqICB9CiAqCiAqICBkZXNjcmliZSgnZXZlbnRUcmFja2VyJywgZnVuY3Rpb24oKSB7CiAqICAgIHZhciBwb3N0U3B5OwogKgogKiAgICBiZWZvcmVFYWNoKG1vZHVsZShmdW5jdGlvbigkcHJvdmlkZSkgewogKiAgICAgIC8vIFJlZ2lzdGVyIHRoZSBldmVudFRyYWNrZXIgcHJvdmlkZXIKICogICAgICAkcHJvdmlkZS5wcm92aWRlcignZXZlbnRUcmFja2VyJywgRXZlbnRUcmFja2VyUHJvdmlkZXIpOwogKiAgICB9KSk7CiAqCiAqICAgIGJlZm9yZUVhY2gobW9kdWxlKGZ1bmN0aW9uKGV2ZW50VHJhY2tlclByb3ZpZGVyKSB7CiAqICAgICAgLy8gQ29uZmlndXJlIGV2ZW50VHJhY2tlciBwcm92aWRlcgogKiAgICAgIGV2ZW50VHJhY2tlclByb3ZpZGVyLnNldFRyYWNraW5nVXJsKCcvY3VzdG9tLXRyYWNrJyk7CiAqICAgIH0pKTsKICoKICogICAgaXQoJ3RyYWNrcyBldmVudHMnLCBpbmplY3QoZnVuY3Rpb24oZXZlbnRUcmFja2VyKSB7CiAqICAgICAgZXhwZWN0KGV2ZW50VHJhY2tlci5ldmVudCgnbG9naW4nKSkudG9FcXVhbCgxKTsKICogICAgICBleHBlY3QoZXZlbnRUcmFja2VyLmV2ZW50KCdsb2dpbicpKS50b0VxdWFsKDIpOwogKiAgICB9KSk7CiAqCiAqICAgIGl0KCdzYXZlcyB0byB0aGUgdHJhY2tpbmcgdXJsJywgaW5qZWN0KGZ1bmN0aW9uKGV2ZW50VHJhY2tlciwgJGh0dHApIHsKICogICAgICBwb3N0U3B5ID0gc3B5T24oJGh0dHAsICdwb3N0Jyk7CiAqICAgICAgZXZlbnRUcmFja2VyLmV2ZW50KCdsb2dpbicpOwogKiAgICAgIGV2ZW50VHJhY2tlci5zYXZlKCk7CiAqICAgICAgZXhwZWN0KHBvc3RTcHkpLnRvSGF2ZUJlZW5DYWxsZWQoKTsKICogICAgICBleHBlY3QocG9zdFNweS5tb3N0UmVjZW50Q2FsbC5hcmdzWzBdKS5ub3QudG9FcXVhbCgnL3RyYWNrJyk7CiAqICAgICAgZXhwZWN0KHBvc3RTcHkubW9zdFJlY2VudENhbGwuYXJnc1swXSkudG9FcXVhbCgnL2N1c3RvbS10cmFjaycpOwogKiAgICAgIGV4cGVjdChwb3N0U3B5Lm1vc3RSZWNlbnRDYWxsLmFyZ3NbMV0pLnRvRXF1YWwoeyAnbG9naW4nOiAxIH0pOwogKiAgICB9KSk7CiAqICB9KTsKICogYGBgCiAqLwoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJHByb3ZpZGUjZmFjdG9yeQogKiBAZGVzY3JpcHRpb24KICoKICogUmVnaXN0ZXIgYSAqKnNlcnZpY2UgZmFjdG9yeSoqLCB3aGljaCB3aWxsIGJlIGNhbGxlZCB0byByZXR1cm4gdGhlIHNlcnZpY2UgaW5zdGFuY2UuCiAqIFRoaXMgaXMgc2hvcnQgZm9yIHJlZ2lzdGVyaW5nIGEgc2VydmljZSB3aGVyZSBpdHMgcHJvdmlkZXIgY29uc2lzdHMgb2Ygb25seSBhIGAkZ2V0YCBwcm9wZXJ0eSwKICogd2hpY2ggaXMgdGhlIGdpdmVuIHNlcnZpY2UgZmFjdG9yeSBmdW5jdGlvbi4KICogWW91IHNob3VsZCB1c2Uge0BsaW5rIGF1dG8uJHByb3ZpZGUjZmFjdG9yeSAkcHJvdmlkZS5mYWN0b3J5KGdldEZuKX0gaWYgeW91IGRvIG5vdCBuZWVkIHRvCiAqIGNvbmZpZ3VyZSB5b3VyIHNlcnZpY2UgaW4gYSBwcm92aWRlci4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLgogKiBAcGFyYW0ge2Z1bmN0aW9uKCl9ICRnZXRGbiBUaGUgJGdldEZuIGZvciB0aGUgaW5zdGFuY2UgY3JlYXRpb24uIEludGVybmFsbHkgdGhpcyBpcyBhIHNob3J0IGhhbmQKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGAkcHJvdmlkZS5wcm92aWRlcihuYW1lLCB7JGdldDogJGdldEZufSlgLgogKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAqCiAqIEBleGFtcGxlCiAqIEhlcmUgaXMgYW4gZXhhbXBsZSBvZiByZWdpc3RlcmluZyBhIHNlcnZpY2UKICogYGBganMKICogICAkcHJvdmlkZS5mYWN0b3J5KCdwaW5nJywgWyckaHR0cCcsIGZ1bmN0aW9uKCRodHRwKSB7CiAqICAgICByZXR1cm4gZnVuY3Rpb24gcGluZygpIHsKICogICAgICAgcmV0dXJuICRodHRwLnNlbmQoJy9waW5nJyk7CiAqICAgICB9OwogKiAgIH1dKTsKICogYGBgCiAqIFlvdSB3b3VsZCB0aGVuIGluamVjdCBhbmQgdXNlIHRoaXMgc2VydmljZSBsaWtlIHRoaXM6CiAqIGBgYGpzCiAqICAgc29tZU1vZHVsZS5jb250cm9sbGVyKCdDdHJsJywgWydwaW5nJywgZnVuY3Rpb24ocGluZykgewogKiAgICAgcGluZygpOwogKiAgIH1dKTsKICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRwcm92aWRlI3NlcnZpY2UKICogQGRlc2NyaXB0aW9uCiAqCiAqIFJlZ2lzdGVyIGEgKipzZXJ2aWNlIGNvbnN0cnVjdG9yKiosIHdoaWNoIHdpbGwgYmUgaW52b2tlZCB3aXRoIGBuZXdgIHRvIGNyZWF0ZSB0aGUgc2VydmljZQogKiBpbnN0YW5jZS4KICogVGhpcyBpcyBzaG9ydCBmb3IgcmVnaXN0ZXJpbmcgYSBzZXJ2aWNlIHdoZXJlIGl0cyBwcm92aWRlcidzIGAkZ2V0YCBwcm9wZXJ0eSBpcyB0aGUgc2VydmljZQogKiBjb25zdHJ1Y3RvciBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgdXNlZCB0byBpbnN0YW50aWF0ZSB0aGUgc2VydmljZSBpbnN0YW5jZS4KICoKICogWW91IHNob3VsZCB1c2Uge0BsaW5rIGF1dG8uJHByb3ZpZGUjc2VydmljZSAkcHJvdmlkZS5zZXJ2aWNlKGNsYXNzKX0gaWYgeW91IGRlZmluZSB5b3VyIHNlcnZpY2UKICogYXMgYSB0eXBlL2NsYXNzLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuCiAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY2xhc3MgKGNvbnN0cnVjdG9yIGZ1bmN0aW9uKSB0aGF0IHdpbGwgYmUgaW5zdGFudGlhdGVkLgogKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAqCiAqIEBleGFtcGxlCiAqIEhlcmUgaXMgYW4gZXhhbXBsZSBvZiByZWdpc3RlcmluZyBhIHNlcnZpY2UgdXNpbmcKICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjc2VydmljZSAkcHJvdmlkZS5zZXJ2aWNlKGNsYXNzKX0uCiAqIGBgYGpzCiAqICAgdmFyIFBpbmcgPSBmdW5jdGlvbigkaHR0cCkgewogKiAgICAgdGhpcy4kaHR0cCA9ICRodHRwOwogKiAgIH07CiAqCiAqICAgUGluZy4kaW5qZWN0ID0gWyckaHR0cCddOwogKgogKiAgIFBpbmcucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbigpIHsKICogICAgIHJldHVybiB0aGlzLiRodHRwLmdldCgnL3BpbmcnKTsKICogICB9OwogKiAgICRwcm92aWRlLnNlcnZpY2UoJ3BpbmcnLCBQaW5nKTsKICogYGBgCiAqIFlvdSB3b3VsZCB0aGVuIGluamVjdCBhbmQgdXNlIHRoaXMgc2VydmljZSBsaWtlIHRoaXM6CiAqIGBgYGpzCiAqICAgc29tZU1vZHVsZS5jb250cm9sbGVyKCdDdHJsJywgWydwaW5nJywgZnVuY3Rpb24ocGluZykgewogKiAgICAgcGluZy5zZW5kKCk7CiAqICAgfV0pOwogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJHByb3ZpZGUjdmFsdWUKICogQGRlc2NyaXB0aW9uCiAqCiAqIFJlZ2lzdGVyIGEgKip2YWx1ZSBzZXJ2aWNlKiogd2l0aCB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0sIHN1Y2ggYXMgYSBzdHJpbmcsIGEKICogbnVtYmVyLCBhbiBhcnJheSwgYW4gb2JqZWN0IG9yIGEgZnVuY3Rpb24uICBUaGlzIGlzIHNob3J0IGZvciByZWdpc3RlcmluZyBhIHNlcnZpY2Ugd2hlcmUgaXRzCiAqIHByb3ZpZGVyJ3MgYCRnZXRgIHByb3BlcnR5IGlzIGEgZmFjdG9yeSBmdW5jdGlvbiB0aGF0IHRha2VzIG5vIGFyZ3VtZW50cyBhbmQgcmV0dXJucyB0aGUgKip2YWx1ZQogKiBzZXJ2aWNlKiouCiAqCiAqIFZhbHVlIHNlcnZpY2VzIGFyZSBzaW1pbGFyIHRvIGNvbnN0YW50IHNlcnZpY2VzLCBleGNlcHQgdGhhdCB0aGV5IGNhbm5vdCBiZSBpbmplY3RlZCBpbnRvIGEKICogbW9kdWxlIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gKHNlZSB7QGxpbmsgYW5ndWxhci5Nb2R1bGUjY29uZmlnfSkgYnV0IHRoZXkgY2FuIGJlIG92ZXJyaWRkZW4gYnkKICogYW4gQW5ndWxhcgogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNkZWNvcmF0b3IgZGVjb3JhdG9yfS4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLgogKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZS4KICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogKgogKiBAZXhhbXBsZQogKiBIZXJlIGFyZSBzb21lIGV4YW1wbGVzIG9mIGNyZWF0aW5nIHZhbHVlIHNlcnZpY2VzLgogKiBgYGBqcwogKiAgICRwcm92aWRlLnZhbHVlKCdBRE1JTl9VU0VSJywgJ2FkbWluJyk7CiAqCiAqICAgJHByb3ZpZGUudmFsdWUoJ1JvbGVMb29rdXAnLCB7IGFkbWluOiAwLCB3cml0ZXI6IDEsIHJlYWRlcjogMiB9KTsKICoKICogICAkcHJvdmlkZS52YWx1ZSgnaGFsZk9mJywgZnVuY3Rpb24odmFsdWUpIHsKICogICAgIHJldHVybiB2YWx1ZSAvIDI7CiAqICAgfSk7CiAqIGBgYAogKi8KCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkcHJvdmlkZSNjb25zdGFudAogKiBAZGVzY3JpcHRpb24KICoKICogUmVnaXN0ZXIgYSAqKmNvbnN0YW50IHNlcnZpY2UqKiwgc3VjaCBhcyBhIHN0cmluZywgYSBudW1iZXIsIGFuIGFycmF5LCBhbiBvYmplY3Qgb3IgYSBmdW5jdGlvbiwKICogd2l0aCB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0uIFVubGlrZSB7QGxpbmsgYXV0by4kcHJvdmlkZSN2YWx1ZSB2YWx1ZX0gaXQgY2FuIGJlCiAqIGluamVjdGVkIGludG8gYSBtb2R1bGUgY29uZmlndXJhdGlvbiBmdW5jdGlvbiAoc2VlIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb25maWd9KSBhbmQgaXQgY2Fubm90CiAqIGJlIG92ZXJyaWRkZW4gYnkgYW4gQW5ndWxhciB7QGxpbmsgYXV0by4kcHJvdmlkZSNkZWNvcmF0b3IgZGVjb3JhdG9yfS4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGNvbnN0YW50LgogKiBAcGFyYW0geyp9IHZhbHVlIFRoZSBjb25zdGFudCB2YWx1ZS4KICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBpbnN0YW5jZQogKgogKiBAZXhhbXBsZQogKiBIZXJlIGEgc29tZSBleGFtcGxlcyBvZiBjcmVhdGluZyBjb25zdGFudHM6CiAqIGBgYGpzCiAqICAgJHByb3ZpZGUuY29uc3RhbnQoJ1NIQVJEX0hFSUdIVCcsIDMwNik7CiAqCiAqICAgJHByb3ZpZGUuY29uc3RhbnQoJ01ZX0NPTE9VUlMnLCBbJ3JlZCcsICdibHVlJywgJ2dyZXknXSk7CiAqCiAqICAgJHByb3ZpZGUuY29uc3RhbnQoJ2RvdWJsZScsIGZ1bmN0aW9uKHZhbHVlKSB7CiAqICAgICByZXR1cm4gdmFsdWUgKiAyOwogKiAgIH0pOwogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJHByb3ZpZGUjZGVjb3JhdG9yCiAqIEBkZXNjcmlwdGlvbgogKgogKiBSZWdpc3RlciBhICoqc2VydmljZSBkZWNvcmF0b3IqKiB3aXRoIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4gQSBzZXJ2aWNlIGRlY29yYXRvcgogKiBpbnRlcmNlcHRzIHRoZSBjcmVhdGlvbiBvZiBhIHNlcnZpY2UsIGFsbG93aW5nIGl0IHRvIG92ZXJyaWRlIG9yIG1vZGlmeSB0aGUgYmVoYXZpb3VyIG9mIHRoZQogKiBzZXJ2aWNlLiBUaGUgb2JqZWN0IHJldHVybmVkIGJ5IHRoZSBkZWNvcmF0b3IgbWF5IGJlIHRoZSBvcmlnaW5hbCBzZXJ2aWNlLCBvciBhIG5ldyBzZXJ2aWNlCiAqIG9iamVjdCB3aGljaCByZXBsYWNlcyBvciB3cmFwcyBhbmQgZGVsZWdhdGVzIHRvIHRoZSBvcmlnaW5hbCBzZXJ2aWNlLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgc2VydmljZSB0byBkZWNvcmF0ZS4KICogQHBhcmFtIHtmdW5jdGlvbigpfSBkZWNvcmF0b3IgVGhpcyBmdW5jdGlvbiB3aWxsIGJlIGludm9rZWQgd2hlbiB0aGUgc2VydmljZSBuZWVkcyB0byBiZQogKiAgICBpbnN0YW50aWF0ZWQgYW5kIHNob3VsZCByZXR1cm4gdGhlIGRlY29yYXRlZCBzZXJ2aWNlIGluc3RhbmNlLiBUaGUgZnVuY3Rpb24gaXMgY2FsbGVkIHVzaW5nCiAqICAgIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IjaW52b2tlIGluamVjdG9yLmludm9rZX0gbWV0aG9kIGFuZCBpcyB0aGVyZWZvcmUgZnVsbHkgaW5qZWN0YWJsZS4KICogICAgTG9jYWwgaW5qZWN0aW9uIGFyZ3VtZW50czoKICoKICogICAgKiBgJGRlbGVnYXRlYCAtIFRoZSBvcmlnaW5hbCBzZXJ2aWNlIGluc3RhbmNlLCB3aGljaCBjYW4gYmUgbW9ua2V5IHBhdGNoZWQsIGNvbmZpZ3VyZWQsCiAqICAgICAgZGVjb3JhdGVkIG9yIGRlbGVnYXRlZCB0by4KICoKICogQGV4YW1wbGUKICogSGVyZSB3ZSBkZWNvcmF0ZSB0aGUge0BsaW5rIG5nLiRsb2cgJGxvZ30gc2VydmljZSB0byBjb252ZXJ0IHdhcm5pbmdzIHRvIGVycm9ycyBieSBpbnRlcmNlcHRpbmcKICogY2FsbHMgdG8ge0BsaW5rIG5nLiRsb2cjZXJyb3IgJGxvZy53YXJuKCl9LgogKiBgYGBqcwogKiAgICRwcm92aWRlLmRlY29yYXRvcignJGxvZycsIFsnJGRlbGVnYXRlJywgZnVuY3Rpb24oJGRlbGVnYXRlKSB7CiAqICAgICAkZGVsZWdhdGUud2FybiA9ICRkZWxlZ2F0ZS5lcnJvcjsKICogICAgIHJldHVybiAkZGVsZWdhdGU7CiAqICAgfV0pOwogKiBgYGAKICovCgoKZnVuY3Rpb24gY3JlYXRlSW5qZWN0b3IobW9kdWxlc1RvTG9hZCwgc3RyaWN0RGkpIHsKICBzdHJpY3REaSA9IChzdHJpY3REaSA9PT0gdHJ1ZSk7CiAgdmFyIElOU1RBTlRJQVRJTkcgPSB7fSwKICAgICAgcHJvdmlkZXJTdWZmaXggPSAnUHJvdmlkZXInLAogICAgICBwYXRoID0gW10sCiAgICAgIGxvYWRlZE1vZHVsZXMgPSBuZXcgSGFzaE1hcChbXSwgdHJ1ZSksCiAgICAgIHByb3ZpZGVyQ2FjaGUgPSB7CiAgICAgICAgJHByb3ZpZGU6IHsKICAgICAgICAgICAgcHJvdmlkZXI6IHN1cHBvcnRPYmplY3QocHJvdmlkZXIpLAogICAgICAgICAgICBmYWN0b3J5OiBzdXBwb3J0T2JqZWN0KGZhY3RvcnkpLAogICAgICAgICAgICBzZXJ2aWNlOiBzdXBwb3J0T2JqZWN0KHNlcnZpY2UpLAogICAgICAgICAgICB2YWx1ZTogc3VwcG9ydE9iamVjdCh2YWx1ZSksCiAgICAgICAgICAgIGNvbnN0YW50OiBzdXBwb3J0T2JqZWN0KGNvbnN0YW50KSwKICAgICAgICAgICAgZGVjb3JhdG9yOiBkZWNvcmF0b3IKICAgICAgICAgIH0KICAgICAgfSwKICAgICAgcHJvdmlkZXJJbmplY3RvciA9IChwcm92aWRlckNhY2hlLiRpbmplY3RvciA9CiAgICAgICAgICBjcmVhdGVJbnRlcm5hbEluamVjdG9yKHByb3ZpZGVyQ2FjaGUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ3VucHInLCAiVW5rbm93biBwcm92aWRlcjogezB9IiwgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgfSkpLAogICAgICBpbnN0YW5jZUNhY2hlID0ge30sCiAgICAgIGluc3RhbmNlSW5qZWN0b3IgPSAoaW5zdGFuY2VDYWNoZS4kaW5qZWN0b3IgPQogICAgICAgICAgY3JlYXRlSW50ZXJuYWxJbmplY3RvcihpbnN0YW5jZUNhY2hlLCBmdW5jdGlvbihzZXJ2aWNlbmFtZSkgewogICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChzZXJ2aWNlbmFtZSArIHByb3ZpZGVyU3VmZml4KTsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKHByb3ZpZGVyLiRnZXQsIHByb3ZpZGVyLCB1bmRlZmluZWQsIHNlcnZpY2VuYW1lKTsKICAgICAgICAgIH0pKTsKCgogIGZvckVhY2gobG9hZE1vZHVsZXMobW9kdWxlc1RvTG9hZCksIGZ1bmN0aW9uKGZuKSB7IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGZuIHx8IG5vb3ApOyB9KTsKCiAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3I7CgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIC8vICRwcm92aWRlcgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICBmdW5jdGlvbiBzdXBwb3J0T2JqZWN0KGRlbGVnYXRlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICBpZiAoaXNPYmplY3Qoa2V5KSkgewogICAgICAgIGZvckVhY2goa2V5LCByZXZlcnNlUGFyYW1zKGRlbGVnYXRlKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGRlbGVnYXRlKGtleSwgdmFsdWUpOwogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gcHJvdmlkZXIobmFtZSwgcHJvdmlkZXJfKSB7CiAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCAnc2VydmljZScpOwogICAgaWYgKGlzRnVuY3Rpb24ocHJvdmlkZXJfKSB8fCBpc0FycmF5KHByb3ZpZGVyXykpIHsKICAgICAgcHJvdmlkZXJfID0gcHJvdmlkZXJJbmplY3Rvci5pbnN0YW50aWF0ZShwcm92aWRlcl8pOwogICAgfQogICAgaWYgKCFwcm92aWRlcl8uJGdldCkgewogICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ3BnZXQnLCAiUHJvdmlkZXIgJ3swfScgbXVzdCBkZWZpbmUgJGdldCBmYWN0b3J5IG1ldGhvZC4iLCBuYW1lKTsKICAgIH0KICAgIHJldHVybiBwcm92aWRlckNhY2hlW25hbWUgKyBwcm92aWRlclN1ZmZpeF0gPSBwcm92aWRlcl87CiAgfQoKICBmdW5jdGlvbiBlbmZvcmNlUmV0dXJuVmFsdWUobmFtZSwgZmFjdG9yeSkgewogICAgcmV0dXJuIGZ1bmN0aW9uIGVuZm9yY2VkUmV0dXJuVmFsdWUoKSB7CiAgICAgIHZhciByZXN1bHQgPSBpbnN0YW5jZUluamVjdG9yLmludm9rZShmYWN0b3J5LCB0aGlzLCB1bmRlZmluZWQsIG5hbWUpOwogICAgICBpZiAoaXNVbmRlZmluZWQocmVzdWx0KSkgewogICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycigndW5kZWYnLCAiUHJvdmlkZXIgJ3swfScgbXVzdCByZXR1cm4gYSB2YWx1ZSBmcm9tICRnZXQgZmFjdG9yeSBtZXRob2QuIiwgbmFtZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBmYWN0b3J5KG5hbWUsIGZhY3RvcnlGbiwgZW5mb3JjZSkgewogICAgcmV0dXJuIHByb3ZpZGVyKG5hbWUsIHsKICAgICAgJGdldDogZW5mb3JjZSAhPT0gZmFsc2UgPyBlbmZvcmNlUmV0dXJuVmFsdWUobmFtZSwgZmFjdG9yeUZuKSA6IGZhY3RvcnlGbgogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBzZXJ2aWNlKG5hbWUsIGNvbnN0cnVjdG9yKSB7CiAgICByZXR1cm4gZmFjdG9yeShuYW1lLCBbJyRpbmplY3RvcicsIGZ1bmN0aW9uKCRpbmplY3RvcikgewogICAgICByZXR1cm4gJGluamVjdG9yLmluc3RhbnRpYXRlKGNvbnN0cnVjdG9yKTsKICAgIH1dKTsKICB9CgogIGZ1bmN0aW9uIHZhbHVlKG5hbWUsIHZhbCkgeyByZXR1cm4gZmFjdG9yeShuYW1lLCB2YWx1ZUZuKHZhbCksIGZhbHNlKTsgfQoKICBmdW5jdGlvbiBjb25zdGFudChuYW1lLCB2YWx1ZSkgewogICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkobmFtZSwgJ2NvbnN0YW50Jyk7CiAgICBwcm92aWRlckNhY2hlW25hbWVdID0gdmFsdWU7CiAgICBpbnN0YW5jZUNhY2hlW25hbWVdID0gdmFsdWU7CiAgfQoKICBmdW5jdGlvbiBkZWNvcmF0b3Ioc2VydmljZU5hbWUsIGRlY29yRm4pIHsKICAgIHZhciBvcmlnUHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChzZXJ2aWNlTmFtZSArIHByb3ZpZGVyU3VmZml4KSwKICAgICAgICBvcmlnJGdldCA9IG9yaWdQcm92aWRlci4kZ2V0OwoKICAgIG9yaWdQcm92aWRlci4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvcmlnSW5zdGFuY2UgPSBpbnN0YW5jZUluamVjdG9yLmludm9rZShvcmlnJGdldCwgb3JpZ1Byb3ZpZGVyKTsKICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGRlY29yRm4sIG51bGwsIHskZGVsZWdhdGU6IG9yaWdJbnN0YW5jZX0pOwogICAgfTsKICB9CgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIC8vIE1vZHVsZSBMb2FkaW5nCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgZnVuY3Rpb24gbG9hZE1vZHVsZXMobW9kdWxlc1RvTG9hZCl7CiAgICB2YXIgcnVuQmxvY2tzID0gW10sIG1vZHVsZUZuOwogICAgZm9yRWFjaChtb2R1bGVzVG9Mb2FkLCBmdW5jdGlvbihtb2R1bGUpIHsKICAgICAgaWYgKGxvYWRlZE1vZHVsZXMuZ2V0KG1vZHVsZSkpIHJldHVybjsKICAgICAgbG9hZGVkTW9kdWxlcy5wdXQobW9kdWxlLCB0cnVlKTsKCiAgICAgIGZ1bmN0aW9uIHJ1bkludm9rZVF1ZXVlKHF1ZXVlKSB7CiAgICAgICAgdmFyIGksIGlpOwogICAgICAgIGZvcihpID0gMCwgaWkgPSBxdWV1ZS5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICB2YXIgaW52b2tlQXJncyA9IHF1ZXVlW2ldLAogICAgICAgICAgICAgIHByb3ZpZGVyID0gcHJvdmlkZXJJbmplY3Rvci5nZXQoaW52b2tlQXJnc1swXSk7CgogICAgICAgICAgcHJvdmlkZXJbaW52b2tlQXJnc1sxXV0uYXBwbHkocHJvdmlkZXIsIGludm9rZUFyZ3NbMl0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdHJ5IHsKICAgICAgICBpZiAoaXNTdHJpbmcobW9kdWxlKSkgewogICAgICAgICAgbW9kdWxlRm4gPSBhbmd1bGFyTW9kdWxlKG1vZHVsZSk7CiAgICAgICAgICBydW5CbG9ja3MgPSBydW5CbG9ja3MuY29uY2F0KGxvYWRNb2R1bGVzKG1vZHVsZUZuLnJlcXVpcmVzKSkuY29uY2F0KG1vZHVsZUZuLl9ydW5CbG9ja3MpOwogICAgICAgICAgcnVuSW52b2tlUXVldWUobW9kdWxlRm4uX2ludm9rZVF1ZXVlKTsKICAgICAgICAgIHJ1bkludm9rZVF1ZXVlKG1vZHVsZUZuLl9jb25maWdCbG9ja3MpOwogICAgICAgIH0gZWxzZSBpZiAoaXNGdW5jdGlvbihtb2R1bGUpKSB7CiAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKHByb3ZpZGVySW5qZWN0b3IuaW52b2tlKG1vZHVsZSkpOwogICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShtb2R1bGUpKSB7CiAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKHByb3ZpZGVySW5qZWN0b3IuaW52b2tlKG1vZHVsZSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhc3NlcnRBcmdGbihtb2R1bGUsICdtb2R1bGUnKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAoaXNBcnJheShtb2R1bGUpKSB7CiAgICAgICAgICBtb2R1bGUgPSBtb2R1bGVbbW9kdWxlLmxlbmd0aCAtIDFdOwogICAgICAgIH0KICAgICAgICBpZiAoZS5tZXNzYWdlICYmIGUuc3RhY2sgJiYgZS5zdGFjay5pbmRleE9mKGUubWVzc2FnZSkgPT0gLTEpIHsKICAgICAgICAgIC8vIFNhZmFyaSAmIEZGJ3Mgc3RhY2sgdHJhY2VzIGRvbid0IGNvbnRhaW4gZXJyb3IubWVzc2FnZSBjb250ZW50CiAgICAgICAgICAvLyB1bmxpa2UgdGhvc2Ugb2YgQ2hyb21lIGFuZCBJRQogICAgICAgICAgLy8gU28gaWYgc3RhY2sgZG9lc24ndCBjb250YWluIG1lc3NhZ2UsIHdlIGNyZWF0ZSBhIG5ldyBzdHJpbmcgdGhhdCBjb250YWlucyBib3RoLgogICAgICAgICAgLy8gU2luY2UgZXJyb3Iuc3RhY2sgaXMgcmVhZC1vbmx5IGluIFNhZmFyaSwgSSdtIG92ZXJyaWRpbmcgZSBhbmQgbm90IGUuc3RhY2sgaGVyZS4KICAgICAgICAgIC8qIGpzaGludCAtVzAyMiAqLwogICAgICAgICAgZSA9IGUubWVzc2FnZSArICdcbicgKyBlLnN0YWNrOwogICAgICAgIH0KICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ21vZHVsZXJyJywgIkZhaWxlZCB0byBpbnN0YW50aWF0ZSBtb2R1bGUgezB9IGR1ZSB0bzpcbnsxfSIsCiAgICAgICAgICAgICAgICAgIG1vZHVsZSwgZS5zdGFjayB8fCBlLm1lc3NhZ2UgfHwgZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJ1bkJsb2NrczsKICB9CgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIC8vIGludGVybmFsIEluamVjdG9yCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogIGZ1bmN0aW9uIGNyZWF0ZUludGVybmFsSW5qZWN0b3IoY2FjaGUsIGZhY3RvcnkpIHsKCiAgICBmdW5jdGlvbiBnZXRTZXJ2aWNlKHNlcnZpY2VOYW1lKSB7CiAgICAgIGlmIChjYWNoZS5oYXNPd25Qcm9wZXJ0eShzZXJ2aWNlTmFtZSkpIHsKICAgICAgICBpZiAoY2FjaGVbc2VydmljZU5hbWVdID09PSBJTlNUQU5USUFUSU5HKSB7CiAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ2NkZXAnLCAnQ2lyY3VsYXIgZGVwZW5kZW5jeSBmb3VuZDogezB9JywKICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlTmFtZSArICcgPC0gJyArIHBhdGguam9pbignIDwtICcpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhY2hlW3NlcnZpY2VOYW1lXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0cnkgewogICAgICAgICAgcGF0aC51bnNoaWZ0KHNlcnZpY2VOYW1lKTsKICAgICAgICAgIGNhY2hlW3NlcnZpY2VOYW1lXSA9IElOU1RBTlRJQVRJTkc7CiAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdID0gZmFjdG9yeShzZXJ2aWNlTmFtZSk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBpZiAoY2FjaGVbc2VydmljZU5hbWVdID09PSBJTlNUQU5USUFUSU5HKSB7CiAgICAgICAgICAgIGRlbGV0ZSBjYWNoZVtzZXJ2aWNlTmFtZV07CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIHBhdGguc2hpZnQoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpbnZva2UoZm4sIHNlbGYsIGxvY2Fscywgc2VydmljZU5hbWUpIHsKICAgICAgaWYgKHR5cGVvZiBsb2NhbHMgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgc2VydmljZU5hbWUgPSBsb2NhbHM7CiAgICAgICAgbG9jYWxzID0gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIGFyZ3MgPSBbXSwKICAgICAgICAgICRpbmplY3QgPSBhbm5vdGF0ZShmbiwgc3RyaWN0RGksIHNlcnZpY2VOYW1lKSwKICAgICAgICAgIGxlbmd0aCwgaSwKICAgICAgICAgIGtleTsKCiAgICAgIGZvcihpID0gMCwgbGVuZ3RoID0gJGluamVjdC5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGtleSA9ICRpbmplY3RbaV07CiAgICAgICAgaWYgKHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ2l0a24nLAogICAgICAgICAgICAgICAgICAnSW5jb3JyZWN0IGluamVjdGlvbiB0b2tlbiEgRXhwZWN0ZWQgc2VydmljZSBuYW1lIGFzIHN0cmluZywgZ290IHswfScsIGtleSk7CiAgICAgICAgfQogICAgICAgIGFyZ3MucHVzaCgKICAgICAgICAgIGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5KQogICAgICAgICAgPyBsb2NhbHNba2V5XQogICAgICAgICAgOiBnZXRTZXJ2aWNlKGtleSkKICAgICAgICApOwogICAgICB9CiAgICAgIGlmIChpc0FycmF5KGZuKSkgewogICAgICAgIGZuID0gZm5bbGVuZ3RoXTsKICAgICAgfQoKICAgICAgLy8gaHR0cDovL2pzcGVyZi5jb20vYW5ndWxhcmpzLWludm9rZS1hcHBseS12cy1zd2l0Y2gKICAgICAgLy8gIzUzODgKICAgICAgcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgfQoKICAgIGZ1bmN0aW9uIGluc3RhbnRpYXRlKFR5cGUsIGxvY2Fscywgc2VydmljZU5hbWUpIHsKICAgICAgdmFyIENvbnN0cnVjdG9yID0gZnVuY3Rpb24oKSB7fSwKICAgICAgICAgIGluc3RhbmNlLCByZXR1cm5lZFZhbHVlOwoKICAgICAgLy8gQ2hlY2sgaWYgVHlwZSBpcyBhbm5vdGF0ZWQgYW5kIHVzZSBqdXN0IHRoZSBnaXZlbiBmdW5jdGlvbiBhdCBuLTEgYXMgcGFyYW1ldGVyCiAgICAgIC8vIGUuZy4gc29tZU1vZHVsZS5mYWN0b3J5KCdncmVldGVyJywgWyckd2luZG93JywgZnVuY3Rpb24ocmVuYW1lZCR3aW5kb3cpIHt9XSk7CiAgICAgIENvbnN0cnVjdG9yLnByb3RvdHlwZSA9IChpc0FycmF5KFR5cGUpID8gVHlwZVtUeXBlLmxlbmd0aCAtIDFdIDogVHlwZSkucHJvdG90eXBlOwogICAgICBpbnN0YW5jZSA9IG5ldyBDb25zdHJ1Y3RvcigpOwogICAgICByZXR1cm5lZFZhbHVlID0gaW52b2tlKFR5cGUsIGluc3RhbmNlLCBsb2NhbHMsIHNlcnZpY2VOYW1lKTsKCiAgICAgIHJldHVybiBpc09iamVjdChyZXR1cm5lZFZhbHVlKSB8fCBpc0Z1bmN0aW9uKHJldHVybmVkVmFsdWUpID8gcmV0dXJuZWRWYWx1ZSA6IGluc3RhbmNlOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGludm9rZTogaW52b2tlLAogICAgICBpbnN0YW50aWF0ZTogaW5zdGFudGlhdGUsCiAgICAgIGdldDogZ2V0U2VydmljZSwKICAgICAgYW5ub3RhdGU6IGFubm90YXRlLAogICAgICBoYXM6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICByZXR1cm4gcHJvdmlkZXJDYWNoZS5oYXNPd25Qcm9wZXJ0eShuYW1lICsgcHJvdmlkZXJTdWZmaXgpIHx8IGNhY2hlLmhhc093blByb3BlcnR5KG5hbWUpOwogICAgICB9CiAgICB9OwogIH0KfQoKY3JlYXRlSW5qZWN0b3IuJCRhbm5vdGF0ZSA9IGFubm90YXRlOwoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkYW5jaG9yU2Nyb2xsUHJvdmlkZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIFVzZSBgJGFuY2hvclNjcm9sbFByb3ZpZGVyYCB0byBkaXNhYmxlIGF1dG9tYXRpYyBzY3JvbGxpbmcgd2hlbmV2ZXIKICoge0BsaW5rIG5nLiRsb2NhdGlvbiNoYXNoICRsb2NhdGlvbi5oYXNoKCl9IGNoYW5nZXMuCiAqLwpmdW5jdGlvbiAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIoKSB7CgogIHZhciBhdXRvU2Nyb2xsaW5nRW5hYmxlZCA9IHRydWU7CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkYW5jaG9yU2Nyb2xsUHJvdmlkZXIjZGlzYWJsZUF1dG9TY3JvbGxpbmcKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEJ5IGRlZmF1bHQsIHtAbGluayBuZy4kYW5jaG9yU2Nyb2xsICRhbmNob3JTY3JvbGwoKX0gd2lsbCBhdXRvbWF0aWNhbGx5IHdpbGwgZGV0ZWN0IGNoYW5nZXMgdG8KICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uI2hhc2ggJGxvY2F0aW9uLmhhc2goKX0gYW5kIHNjcm9sbCB0byB0aGUgZWxlbWVudCBtYXRjaGluZyB0aGUgbmV3IGhhc2guPGJyIC8+CiAgICogVXNlIHRoaXMgbWV0aG9kIHRvIGRpc2FibGUgYXV0b21hdGljIHNjcm9sbGluZy4KICAgKgogICAqIElmIGF1dG9tYXRpYyBzY3JvbGxpbmcgaXMgZGlzYWJsZWQsIG9uZSBtdXN0IGV4cGxpY2l0bHkgY2FsbAogICAqIHtAbGluayBuZy4kYW5jaG9yU2Nyb2xsICRhbmNob3JTY3JvbGwoKX0gaW4gb3JkZXIgdG8gc2Nyb2xsIHRvIHRoZSBlbGVtZW50IHJlbGF0ZWQgdG8gdGhlCiAgICogY3VycmVudCBoYXNoLgogICAqLwogIHRoaXMuZGlzYWJsZUF1dG9TY3JvbGxpbmcgPSBmdW5jdGlvbigpIHsKICAgIGF1dG9TY3JvbGxpbmdFbmFibGVkID0gZmFsc2U7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkYW5jaG9yU2Nyb2xsCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAqIEByZXF1aXJlcyAkbG9jYXRpb24KICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogV2hlbiBjYWxsZWQsIGl0IGNoZWNrcyB0aGUgY3VycmVudCB2YWx1ZSBvZiB7QGxpbmsgbmcuJGxvY2F0aW9uI2hhc2ggJGxvY2F0aW9uLmhhc2goKX0gYW5kCiAgICogc2Nyb2xscyB0byB0aGUgcmVsYXRlZCBlbGVtZW50LCBhY2NvcmRpbmcgdG8gdGhlIHJ1bGVzIHNwZWNpZmllZCBpbiB0aGUKICAgKiBbSHRtbDUgc3BlY10oaHR0cDovL2Rldi53My5vcmcvaHRtbDUvc3BlYy9PdmVydmlldy5odG1sI3RoZS1pbmRpY2F0ZWQtcGFydC1vZi10aGUtZG9jdW1lbnQpLgogICAqCiAgICogSXQgYWxzbyB3YXRjaGVzIHRoZSB7QGxpbmsgbmcuJGxvY2F0aW9uI2hhc2ggJGxvY2F0aW9uLmhhc2goKX0gYW5kIGF1dG9tYXRpY2FsbHkgc2Nyb2xscyB0bwogICAqIG1hdGNoIGFueSBhbmNob3Igd2hlbmV2ZXIgaXQgY2hhbmdlcy4gVGhpcyBjYW4gYmUgZGlzYWJsZWQgYnkgY2FsbGluZwogICAqIHtAbGluayBuZy4kYW5jaG9yU2Nyb2xsUHJvdmlkZXIjZGlzYWJsZUF1dG9TY3JvbGxpbmcgJGFuY2hvclNjcm9sbFByb3ZpZGVyLmRpc2FibGVBdXRvU2Nyb2xsaW5nKCl9LgogICAqCiAgICogQWRkaXRpb25hbGx5LCB5b3UgY2FuIHVzZSBpdHMge0BsaW5rIG5nLiRhbmNob3JTY3JvbGwjeU9mZnNldCB5T2Zmc2V0fSBwcm9wZXJ0eSB0byBzcGVjaWZ5IGEKICAgKiB2ZXJ0aWNhbCBzY3JvbGwtb2Zmc2V0IChlaXRoZXIgZml4ZWQgb3IgZHluYW1pYykuCiAgICoKICAgKiBAcHJvcGVydHkgeyhudW1iZXJ8ZnVuY3Rpb258anFMaXRlKX0geU9mZnNldAogICAqIElmIHNldCwgc3BlY2lmaWVzIGEgdmVydGljYWwgc2Nyb2xsLW9mZnNldC4gVGhpcyBpcyBvZnRlbiB1c2VmdWwgd2hlbiB0aGVyZSBhcmUgZml4ZWQKICAgKiBwb3NpdGlvbmVkIGVsZW1lbnRzIGF0IHRoZSB0b3Agb2YgdGhlIHBhZ2UsIHN1Y2ggYXMgbmF2YmFycywgaGVhZGVycyBldGMuCiAgICoKICAgKiBgeU9mZnNldGAgY2FuIGJlIHNwZWNpZmllZCBpbiB2YXJpb3VzIHdheXM6CiAgICogLSAqKm51bWJlcioqOiBBIGZpeGVkIG51bWJlciBvZiBwaXhlbHMgdG8gYmUgdXNlZCBhcyBvZmZzZXQuPGJyIC8+PGJyIC8+CiAgICogLSAqKmZ1bmN0aW9uKio6IEEgZ2V0dGVyIGZ1bmN0aW9uIGNhbGxlZCBldmVyeXRpbWUgYCRhbmNob3JTY3JvbGwoKWAgaXMgZXhlY3V0ZWQuIE11c3QgcmV0dXJuCiAgICogICBhIG51bWJlciByZXByZXNlbnRpbmcgdGhlIG9mZnNldCAoaW4gcGl4ZWxzKS48YnIgLz48YnIgLz4KICAgKiAtICoqanFMaXRlKio6IEEganFMaXRlL2pRdWVyeSBlbGVtZW50IHRvIGJlIHVzZWQgZm9yIHNwZWNpZnlpbmcgdGhlIG9mZnNldC4gVGhlIGRpc3RhbmNlIGZyb20KICAgKiAgIHRoZSB0b3Agb2YgdGhlIHBhZ2UgdG8gdGhlIGVsZW1lbnQncyBib3R0b20gd2lsbCBiZSB1c2VkIGFzIG9mZnNldC48YnIgLz4KICAgKiAgICoqTm90ZSoqOiBUaGUgZWxlbWVudCB3aWxsIGJlIHRha2VuIGludG8gYWNjb3VudCBvbmx5IGFzIGxvbmcgYXMgaXRzIGBwb3NpdGlvbmAgaXMgc2V0IHRvCiAgICogICBgZml4ZWRgLiBUaGlzIG9wdGlvbiBpcyB1c2VmdWwsIHdoZW4gZGVhbGluZyB3aXRoIHJlc3BvbnNpdmUgbmF2YmFycy9oZWFkZXJzIHRoYXQgYWRqdXN0CiAgICogICB0aGVpciBoZWlnaHQgYW5kL29yIHBvc2l0aW9uaW5nIGFjY29yZGluZyB0byB0aGUgdmlld3BvcnQncyBzaXplLgogICAqCiAgICogPGJyIC8+CiAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAgICogSW4gb3JkZXIgZm9yIGB5T2Zmc2V0YCB0byB3b3JrIHByb3Blcmx5LCBzY3JvbGxpbmcgc2hvdWxkIHRha2UgcGxhY2Ugb24gdGhlIGRvY3VtZW50J3Mgcm9vdCBhbmQKICAgKiBub3Qgc29tZSBjaGlsZCBlbGVtZW50LgogICAqIDwvZGl2PgogICAqCiAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZSBtb2R1bGU9ImFuY2hvclNjcm9sbEV4YW1wbGUiPgogICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgIDxkaXYgaWQ9InNjcm9sbEFyZWEiIG5nLWNvbnRyb2xsZXI9IlNjcm9sbENvbnRyb2xsZXIiPgogICAgICAgICAgIDxhIG5nLWNsaWNrPSJnb3RvQm90dG9tKCkiPkdvIHRvIGJvdHRvbTwvYT4KICAgICAgICAgICA8YSBpZD0iYm90dG9tIj48L2E+IFlvdSdyZSBhdCB0aGUgYm90dG9tIQogICAgICAgICA8L2Rpdj4KICAgICAgIDwvZmlsZT4KICAgICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCdhbmNob3JTY3JvbGxFeGFtcGxlJywgW10pCiAgICAgICAgICAgLmNvbnRyb2xsZXIoJ1Njcm9sbENvbnRyb2xsZXInLCBbJyRzY29wZScsICckbG9jYXRpb24nLCAnJGFuY2hvclNjcm9sbCcsCiAgICAgICAgICAgICBmdW5jdGlvbiAoJHNjb3BlLCAkbG9jYXRpb24sICRhbmNob3JTY3JvbGwpIHsKICAgICAgICAgICAgICAgJHNjb3BlLmdvdG9Cb3R0b20gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAvLyBzZXQgdGhlIGxvY2F0aW9uLmhhc2ggdG8gdGhlIGlkIG9mCiAgICAgICAgICAgICAgICAgLy8gdGhlIGVsZW1lbnQgeW91IHdpc2ggdG8gc2Nyb2xsIHRvLgogICAgICAgICAgICAgICAgICRsb2NhdGlvbi5oYXNoKCdib3R0b20nKTsKCiAgICAgICAgICAgICAgICAgLy8gY2FsbCAkYW5jaG9yU2Nyb2xsKCkKICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsKCk7CiAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICB9XSk7CiAgICAgICA8L2ZpbGU+CiAgICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgICAjc2Nyb2xsQXJlYSB7CiAgICAgICAgICAgaGVpZ2h0OiAyODBweDsKICAgICAgICAgICBvdmVyZmxvdzogYXV0bzsKICAgICAgICAgfQoKICAgICAgICAgI2JvdHRvbSB7CiAgICAgICAgICAgZGlzcGxheTogYmxvY2s7CiAgICAgICAgICAgbWFyZ2luLXRvcDogMjAwMHB4OwogICAgICAgICB9CiAgICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAqCiAgICogPGhyIC8+CiAgICogVGhlIGV4YW1wbGUgYmVsb3cgaWxsdXN0cmF0ZXMgdGhlIHVzZSBvZiBhIHZlcnRpY2FsIHNjcm9sbC1vZmZzZXQgKHNwZWNpZmllZCBhcyBhIGZpeGVkIHZhbHVlKS4KICAgKiBTZWUge0BsaW5rIG5nLiRhbmNob3JTY3JvbGwjeU9mZnNldCAkYW5jaG9yU2Nyb2xsLnlPZmZzZXR9IGZvciBtb3JlIGRldGFpbHMuCiAgICoKICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlIG1vZHVsZT0iYW5jaG9yU2Nyb2xsT2Zmc2V0RXhhbXBsZSI+CiAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgPGRpdiBjbGFzcz0iZml4ZWQtaGVhZGVyIiBuZy1jb250cm9sbGVyPSJoZWFkZXJDdHJsIj4KICAgICAgICAgICA8YSBocmVmPSIiIG5nLWNsaWNrPSJnb3RvQW5jaG9yKHgpIiBuZy1yZXBlYXQ9InggaW4gWzEsMiwzLDQsNV0iPgogICAgICAgICAgICAgR28gdG8gYW5jaG9yIHt7eH19CiAgICAgICAgICAgPC9hPgogICAgICAgICA8L2Rpdj4KICAgICAgICAgPGRpdiBpZD0iYW5jaG9ye3t4fX0iIGNsYXNzPSJhbmNob3IiIG5nLXJlcGVhdD0ieCBpbiBbMSwyLDMsNCw1XSI+CiAgICAgICAgICAgQW5jaG9yIHt7eH19IG9mIDUKICAgICAgICAgPC9kaXY+CiAgICAgICA8L2ZpbGU+CiAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICBhbmd1bGFyLm1vZHVsZSgnYW5jaG9yU2Nyb2xsT2Zmc2V0RXhhbXBsZScsIFtdKQogICAgICAgICAgIC5ydW4oWyckYW5jaG9yU2Nyb2xsJywgZnVuY3Rpb24oJGFuY2hvclNjcm9sbCkgewogICAgICAgICAgICAgJGFuY2hvclNjcm9sbC55T2Zmc2V0ID0gNTA7ICAgLy8gYWx3YXlzIHNjcm9sbCBieSA1MCBleHRyYSBwaXhlbHMKICAgICAgICAgICB9XSkKICAgICAgICAgICAuY29udHJvbGxlcignaGVhZGVyQ3RybCcsIFsnJGFuY2hvclNjcm9sbCcsICckbG9jYXRpb24nLCAnJHNjb3BlJywKICAgICAgICAgICAgIGZ1bmN0aW9uICgkYW5jaG9yU2Nyb2xsLCAkbG9jYXRpb24sICRzY29wZSkgewogICAgICAgICAgICAgICAkc2NvcGUuZ290b0FuY2hvciA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICAgICAgICAgICB2YXIgbmV3SGFzaCA9ICdhbmNob3InICsgeDsKICAgICAgICAgICAgICAgICBpZiAoJGxvY2F0aW9uLmhhc2goKSAhPT0gbmV3SGFzaCkgewogICAgICAgICAgICAgICAgICAgLy8gc2V0IHRoZSAkbG9jYXRpb24uaGFzaCB0byBgbmV3SGFzaGAgYW5kCiAgICAgICAgICAgICAgICAgICAvLyAkYW5jaG9yU2Nyb2xsIHdpbGwgYXV0b21hdGljYWxseSBzY3JvbGwgdG8gaXQKICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5oYXNoKCdhbmNob3InICsgeCk7CiAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgIC8vIGNhbGwgJGFuY2hvclNjcm9sbCgpIGV4cGxpY2l0bHksCiAgICAgICAgICAgICAgICAgICAvLyBzaW5jZSAkbG9jYXRpb24uaGFzaCBoYXNuJ3QgY2hhbmdlZAogICAgICAgICAgICAgICAgICAgJGFuY2hvclNjcm9sbCgpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgIH0KICAgICAgICAgICBdKTsKICAgICAgIDwvZmlsZT4KICAgICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgICAgIGJvZHkgewogICAgICAgICAgIHBhZGRpbmctdG9wOiA1MHB4OwogICAgICAgICB9CgogICAgICAgICAuYW5jaG9yIHsKICAgICAgICAgICBib3JkZXI6IDJweCBkYXNoZWQgRGFya09yY2hpZDsKICAgICAgICAgICBwYWRkaW5nOiAxMHB4IDEwcHggMjAwcHggMTBweDsKICAgICAgICAgfQoKICAgICAgICAgLmZpeGVkLWhlYWRlciB7CiAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAwLCAwLCAwLjIpOwogICAgICAgICAgIGhlaWdodDogNTBweDsKICAgICAgICAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICAgICAgICAgdG9wOiAwOyBsZWZ0OiAwOyByaWdodDogMDsKICAgICAgICAgfQoKICAgICAgICAgLmZpeGVkLWhlYWRlciA+IGEgewogICAgICAgICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgICAgICAgICBtYXJnaW46IDVweCAxNXB4OwogICAgICAgICB9CiAgICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAqLwogIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckbG9jYXRpb24nLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKCR3aW5kb3csICRsb2NhdGlvbiwgJHJvb3RTY29wZSkgewogICAgdmFyIGRvY3VtZW50ID0gJHdpbmRvdy5kb2N1bWVudDsKICAgIHZhciBzY3JvbGxTY2hlZHVsZWQgPSBmYWxzZTsKCiAgICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IGZpcnN0IGFuY2hvciBmcm9tIGEgTm9kZUxpc3QKICAgIC8vICh1c2luZyBgQXJyYXkjc29tZSgpYCBpbnN0ZWFkIG9mIGBhbmd1bGFyI2ZvckVhY2goKWAgc2luY2UgaXQncyBtb3JlIHBlcmZvcm1hbnQKICAgIC8vICBhbmQgd29ya2luZyBpbiBhbGwgc3VwcG9ydGVkIGJyb3dzZXJzLikKICAgIGZ1bmN0aW9uIGdldEZpcnN0QW5jaG9yKGxpc3QpIHsKICAgICAgdmFyIHJlc3VsdCA9IG51bGw7CiAgICAgIEFycmF5LnByb3RvdHlwZS5zb21lLmNhbGwobGlzdCwgZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIGlmIChub2RlTmFtZV8oZWxlbWVudCkgPT09ICdhJykgewogICAgICAgICAgcmVzdWx0ID0gZWxlbWVudDsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0WU9mZnNldCgpIHsKCiAgICAgIHZhciBvZmZzZXQgPSBzY3JvbGwueU9mZnNldDsKCiAgICAgIGlmIChpc0Z1bmN0aW9uKG9mZnNldCkpIHsKICAgICAgICBvZmZzZXQgPSBvZmZzZXQoKTsKICAgICAgfSBlbHNlIGlmIChpc0VsZW1lbnQob2Zmc2V0KSkgewogICAgICAgIHZhciBlbGVtID0gb2Zmc2V0WzBdOwogICAgICAgIHZhciBzdHlsZSA9ICR3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtKTsKICAgICAgICBpZiAoc3R5bGUucG9zaXRpb24gIT09ICdmaXhlZCcpIHsKICAgICAgICAgIG9mZnNldCA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9mZnNldCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICghaXNOdW1iZXIob2Zmc2V0KSkgewogICAgICAgIG9mZnNldCA9IDA7CiAgICAgIH0KCiAgICAgIHJldHVybiBvZmZzZXQ7CiAgICB9CgogICAgZnVuY3Rpb24gc2Nyb2xsVG8oZWxlbSkgewogICAgICBpZiAoZWxlbSkgewogICAgICAgIGVsZW0uc2Nyb2xsSW50b1ZpZXcoKTsKCiAgICAgICAgdmFyIG9mZnNldCA9IGdldFlPZmZzZXQoKTsKCiAgICAgICAgaWYgKG9mZnNldCkgewogICAgICAgICAgLy8gYG9mZnNldGAgaXMgdGhlIG51bWJlciBvZiBwaXhlbHMgd2Ugc2hvdWxkIHNjcm9sbCBVUCBpbiBvcmRlciB0byBhbGlnbiBgZWxlbWAgcHJvcGVybHkuCiAgICAgICAgICAvLyBUaGlzIGlzIHRydWUgT05MWSBpZiB0aGUgY2FsbCB0byBgZWxlbS5zY3JvbGxJbnRvVmlldygpYCBpbml0aWFsbHkgYWxpZ25zIGBlbGVtYCBhdCB0aGUKICAgICAgICAgIC8vIHRvcCBvZiB0aGUgdmlld3BvcnQuCiAgICAgICAgICAvLwogICAgICAgICAgLy8gSUYgdGhlIG51bWJlciBvZiBwaXhlbHMgZnJvbSB0aGUgdG9wIG9mIGBlbGVtYCB0byB0aGUgZW5kIG9mIHRoZSBwYWdlJ3MgY29udGVudCBpcyBsZXNzCiAgICAgICAgICAvLyB0aGFuIHRoZSBoZWlnaHQgb2YgdGhlIHZpZXdwb3J0LCB0aGVuIGBlbGVtLnNjcm9sbEludG9WaWV3KClgIHdpbGwgYWxpZ24gdGhlIGBlbGVtYCBzb21lCiAgICAgICAgICAvLyB3YXkgZG93biB0aGUgcGFnZS4KICAgICAgICAgIC8vCiAgICAgICAgICAvLyBUaGlzIGlzIG9mdGVuIHRoZSBjYXNlIGZvciBlbGVtZW50cyBuZWFyIHRoZSBib3R0b20gb2YgdGhlIHBhZ2UuCiAgICAgICAgICAvLwogICAgICAgICAgLy8gSW4gc3VjaCBjYXNlcyB3ZSBkbyBub3QgbmVlZCB0byBzY3JvbGwgdGhlIHdob2xlIGBvZmZzZXRgIHVwLCBqdXN0IHRoZSBkaWZmZXJlbmNlIGJldHdlZW4KICAgICAgICAgIC8vIHRoZSB0b3Agb2YgdGhlIGVsZW1lbnQgYW5kIHRoZSBvZmZzZXQsIHdoaWNoIGlzIGVub3VnaCB0byBhbGlnbiB0aGUgdG9wIG9mIGBlbGVtYCBhdCB0aGUKICAgICAgICAgIC8vIGRlc2lyZWQgcG9zaXRpb24uCiAgICAgICAgICB2YXIgZWxlbVRvcCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wOwogICAgICAgICAgJHdpbmRvdy5zY3JvbGxCeSgwLCBlbGVtVG9wIC0gb2Zmc2V0KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgJHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHNjcm9sbCgpIHsKICAgICAgdmFyIGhhc2ggPSAkbG9jYXRpb24uaGFzaCgpLCBlbG07CgogICAgICAvLyBlbXB0eSBoYXNoLCBzY3JvbGwgdG8gdGhlIHRvcCBvZiB0aGUgcGFnZQogICAgICBpZiAoIWhhc2gpIHNjcm9sbFRvKG51bGwpOwoKICAgICAgLy8gZWxlbWVudCB3aXRoIGdpdmVuIGlkCiAgICAgIGVsc2UgaWYgKChlbG0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChoYXNoKSkpIHNjcm9sbFRvKGVsbSk7CgogICAgICAvLyBmaXJzdCBhbmNob3Igd2l0aCBnaXZlbiBuYW1lIDotRAogICAgICBlbHNlIGlmICgoZWxtID0gZ2V0Rmlyc3RBbmNob3IoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUoaGFzaCkpKSkgc2Nyb2xsVG8oZWxtKTsKCiAgICAgIC8vIG5vIGVsZW1lbnQgYW5kIGhhc2ggPT0gJ3RvcCcsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgIGVsc2UgaWYgKGhhc2ggPT09ICd0b3AnKSBzY3JvbGxUbyhudWxsKTsKICAgIH0KCiAgICAvLyBkb2VzIG5vdCBzY3JvbGwgd2hlbiB1c2VyIGNsaWNrcyBvbiBhbmNob3IgbGluayB0aGF0IGlzIGN1cnJlbnRseSBvbgogICAgLy8gKG5vIHVybCBjaGFuZ2UsIG5vICRsb2NhdGlvbi5oYXNoKCkgY2hhbmdlKSwgYnJvd3NlciBuYXRpdmUgZG9lcyBzY3JvbGwKICAgIGlmIChhdXRvU2Nyb2xsaW5nRW5hYmxlZCkgewogICAgICAkcm9vdFNjb3BlLiR3YXRjaChmdW5jdGlvbiBhdXRvU2Nyb2xsV2F0Y2goKSB7cmV0dXJuICRsb2NhdGlvbi5oYXNoKCk7fSwKICAgICAgICBmdW5jdGlvbiBhdXRvU2Nyb2xsV2F0Y2hBY3Rpb24obmV3VmFsLCBvbGRWYWwpIHsKICAgICAgICAgIC8vIHNraXAgdGhlIGluaXRpYWwgc2Nyb2xsIGlmICRsb2NhdGlvbi5oYXNoIGlzIGVtcHR5CiAgICAgICAgICBpZiAobmV3VmFsID09PSBvbGRWYWwgJiYgbmV3VmFsID09PSAnJykgcmV0dXJuOwoKICAgICAgICAgIGpxTGl0ZURvY3VtZW50TG9hZGVkKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoc2Nyb2xsKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiBzY3JvbGw7CiAgfV07Cn0KCnZhciAkYW5pbWF0ZU1pbkVyciA9IG1pbkVycignJGFuaW1hdGUnKTsKCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJGFuaW1hdGVQcm92aWRlcgogKgogKiBAZGVzY3JpcHRpb24KICogRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiAkYW5pbWF0ZSB0aGF0IGRvZXNuJ3QgcGVyZm9ybSBhbnkgYW5pbWF0aW9ucywgaW5zdGVhZCBqdXN0CiAqIHN5bmNocm9ub3VzbHkgcGVyZm9ybXMgRE9NCiAqIHVwZGF0ZXMgYW5kIGNhbGxzIGRvbmUoKSBjYWxsYmFja3MuCiAqCiAqIEluIG9yZGVyIHRvIGVuYWJsZSBhbmltYXRpb25zIHRoZSBuZ0FuaW1hdGUgbW9kdWxlIGhhcyB0byBiZSBsb2FkZWQuCiAqCiAqIFRvIHNlZSB0aGUgZnVuY3Rpb25hbCBpbXBsZW1lbnRhdGlvbiBjaGVjayBvdXQgc3JjL25nQW5pbWF0ZS9hbmltYXRlLmpzCiAqLwp2YXIgJEFuaW1hdGVQcm92aWRlciA9IFsnJHByb3ZpZGUnLCBmdW5jdGlvbigkcHJvdmlkZSkgewoKCiAgdGhpcy4kJHNlbGVjdG9ycyA9IHt9OwoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRhbmltYXRlUHJvdmlkZXIjcmVnaXN0ZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJlZ2lzdGVycyBhIG5ldyBpbmplY3RhYmxlIGFuaW1hdGlvbiBmYWN0b3J5IGZ1bmN0aW9uLiBUaGUgZmFjdG9yeSBmdW5jdGlvbiBwcm9kdWNlcyB0aGUKICAgKiBhbmltYXRpb24gb2JqZWN0IHdoaWNoIGNvbnRhaW5zIGNhbGxiYWNrIGZ1bmN0aW9ucyBmb3IgZWFjaCBldmVudCB0aGF0IGlzIGV4cGVjdGVkIHRvIGJlCiAgICogYW5pbWF0ZWQuCiAgICoKICAgKiAgICogYGV2ZW50Rm5gOiBgZnVuY3Rpb24oRWxlbWVudCwgZG9uZUZ1bmN0aW9uKWAgVGhlIGVsZW1lbnQgdG8gYW5pbWF0ZSwgdGhlIGBkb25lRnVuY3Rpb25gCiAgICogICBtdXN0IGJlIGNhbGxlZCBvbmNlIHRoZSBlbGVtZW50IGFuaW1hdGlvbiBpcyBjb21wbGV0ZS4gSWYgYSBmdW5jdGlvbiBpcyByZXR1cm5lZCB0aGVuIHRoZQogICAqICAgYW5pbWF0aW9uIHNlcnZpY2Ugd2lsbCB1c2UgdGhpcyBmdW5jdGlvbiB0byBjYW5jZWwgdGhlIGFuaW1hdGlvbiB3aGVuZXZlciBhIGNhbmNlbCBldmVudCBpcwogICAqICAgdHJpZ2dlcmVkLgogICAqCiAgICoKICAgKiBgYGBqcwogICAqICAgcmV0dXJuIHsKICAgICAqICAgICBldmVudEZuIDogZnVuY3Rpb24oZWxlbWVudCwgZG9uZSkgewogICAgICogICAgICAgLy9jb2RlIHRvIHJ1biB0aGUgYW5pbWF0aW9uCiAgICAgKiAgICAgICAvL29uY2UgY29tcGxldGUsIHRoZW4gcnVuIGRvbmUoKQogICAgICogICAgICAgcmV0dXJuIGZ1bmN0aW9uIGNhbmNlbGxhdGlvbkZ1bmN0aW9uKCkgewogICAgICogICAgICAgICAvL2NvZGUgdG8gY2FuY2VsIHRoZSBhbmltYXRpb24KICAgICAqICAgICAgIH0KICAgICAqICAgICB9CiAgICAgKiAgIH0KICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBhbmltYXRpb24uCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZmFjdG9yeSBUaGUgZmFjdG9yeSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgZXhlY3V0ZWQgdG8gcmV0dXJuIHRoZSBhbmltYXRpb24KICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdC4KICAgKi8KICB0aGlzLnJlZ2lzdGVyID0gZnVuY3Rpb24obmFtZSwgZmFjdG9yeSkgewogICAgdmFyIGtleSA9IG5hbWUgKyAnLWFuaW1hdGlvbic7CiAgICBpZiAobmFtZSAmJiBuYW1lLmNoYXJBdCgwKSAhPSAnLicpIHRocm93ICRhbmltYXRlTWluRXJyKCdub3Rjc2VsJywKICAgICAgICAiRXhwZWN0aW5nIGNsYXNzIHNlbGVjdG9yIHN0YXJ0aW5nIHdpdGggJy4nIGdvdCAnezB9Jy4iLCBuYW1lKTsKICAgIHRoaXMuJCRzZWxlY3RvcnNbbmFtZS5zdWJzdHIoMSldID0ga2V5OwogICAgJHByb3ZpZGUuZmFjdG9yeShrZXksIGZhY3RvcnkpOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkYW5pbWF0ZVByb3ZpZGVyI2NsYXNzTmFtZUZpbHRlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cyBhbmQvb3IgcmV0dXJucyB0aGUgQ1NTIGNsYXNzIHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIGNoZWNrZWQgd2hlbiBwZXJmb3JtaW5nCiAgICogYW4gYW5pbWF0aW9uLiBVcG9uIGJvb3RzdHJhcCB0aGUgY2xhc3NOYW1lRmlsdGVyIHZhbHVlIGlzIG5vdCBzZXQgYXQgYWxsIGFuZCB3aWxsCiAgICogdGhlcmVmb3JlIGVuYWJsZSAkYW5pbWF0ZSB0byBhdHRlbXB0IHRvIHBlcmZvcm0gYW4gYW5pbWF0aW9uIG9uIGFueSBlbGVtZW50LgogICAqIFdoZW4gc2V0dGluZyB0aGUgY2xhc3NOYW1lRmlsdGVyIHZhbHVlLCBhbmltYXRpb25zIHdpbGwgb25seSBiZSBwZXJmb3JtZWQgb24gZWxlbWVudHMKICAgKiB0aGF0IHN1Y2Nlc3NmdWxseSBtYXRjaCB0aGUgZmlsdGVyIGV4cHJlc3Npb24uIFRoaXMgaW4gdHVybiBjYW4gYm9vc3QgcGVyZm9ybWFuY2UKICAgKiBmb3IgbG93LXBvd2VyZWQgZGV2aWNlcyBhcyB3ZWxsIGFzIGFwcGxpY2F0aW9ucyBjb250YWluaW5nIGEgbG90IG9mIHN0cnVjdHVyYWwgb3BlcmF0aW9ucy4KICAgKiBAcGFyYW0ge1JlZ0V4cD19IGV4cHJlc3Npb24gVGhlIGNsYXNzTmFtZSBleHByZXNzaW9uIHdoaWNoIHdpbGwgYmUgY2hlY2tlZCBhZ2FpbnN0IGFsbCBhbmltYXRpb25zCiAgICogQHJldHVybiB7UmVnRXhwfSBUaGUgY3VycmVudCBDU1MgY2xhc3NOYW1lIGV4cHJlc3Npb24gdmFsdWUuIElmIG51bGwgdGhlbiB0aGVyZSBpcyBubyBleHByZXNzaW9uIHZhbHVlCiAgICovCiAgdGhpcy5jbGFzc05hbWVGaWx0ZXIgPSBmdW5jdGlvbihleHByZXNzaW9uKSB7CiAgICBpZihhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgIHRoaXMuJCRjbGFzc05hbWVGaWx0ZXIgPSAoZXhwcmVzc2lvbiBpbnN0YW5jZW9mIFJlZ0V4cCkgPyBleHByZXNzaW9uIDogbnVsbDsKICAgIH0KICAgIHJldHVybiB0aGlzLiQkY2xhc3NOYW1lRmlsdGVyOwogIH07CgogIHRoaXMuJGdldCA9IFsnJCRxJywgJyQkYXN5bmNDYWxsYmFjaycsICckcm9vdFNjb3BlJywgZnVuY3Rpb24oJCRxLCAkJGFzeW5jQ2FsbGJhY2ssICRyb290U2NvcGUpIHsKCiAgICB2YXIgY3VycmVudERlZmVyOwoKICAgIGZ1bmN0aW9uIHJ1bkFuaW1hdGlvblBvc3REaWdlc3QoZm4pIHsKICAgICAgdmFyIGNhbmNlbEZuLCBkZWZlciA9ICQkcS5kZWZlcigpOwogICAgICBkZWZlci5wcm9taXNlLiQkY2FuY2VsRm4gPSBmdW5jdGlvbiBuZ0FuaW1hdGVNYXliZUNhbmNlbCgpIHsKICAgICAgICBjYW5jZWxGbiAmJiBjYW5jZWxGbigpOwogICAgICB9OwoKICAgICAgJHJvb3RTY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24gbmdBbmltYXRlUG9zdERpZ2VzdCgpIHsKICAgICAgICBjYW5jZWxGbiA9IGZuKGZ1bmN0aW9uIG5nQW5pbWF0ZU5vdGlmeUNvbXBsZXRlKCkgewogICAgICAgICAgZGVmZXIucmVzb2x2ZSgpOwogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlc29sdmVFbGVtZW50Q2xhc3NlcyhlbGVtZW50LCBjbGFzc2VzKSB7CiAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdOwoKICAgICAgdmFyIGhhc0NsYXNzZXMgPSBjcmVhdGVNYXAoKTsKICAgICAgZm9yRWFjaCgoZWxlbWVudC5hdHRyKCdjbGFzcycpIHx8ICcnKS5zcGxpdCgvXHMrLyksIGZ1bmN0aW9uKGNsYXNzTmFtZSkgewogICAgICAgIGhhc0NsYXNzZXNbY2xhc3NOYW1lXSA9IHRydWU7CiAgICAgIH0pOwoKICAgICAgZm9yRWFjaChjbGFzc2VzLCBmdW5jdGlvbihzdGF0dXMsIGNsYXNzTmFtZSkgewogICAgICAgIHZhciBoYXNDbGFzcyA9IGhhc0NsYXNzZXNbY2xhc3NOYW1lXTsKCiAgICAgICAgLy8gSWYgdGhlIG1vc3QgcmVjZW50IGNsYXNzIG1hbmlwdWxhdGlvbiAodmlhICRhbmltYXRlKSB3YXMgdG8gcmVtb3ZlIHRoZSBjbGFzcywgYW5kIHRoZQogICAgICAgIC8vIGVsZW1lbnQgY3VycmVudGx5IGhhcyB0aGUgY2xhc3MsIHRoZSBjbGFzcyBpcyBzY2hlZHVsZWQgZm9yIHJlbW92YWwuIE90aGVyd2lzZSwgaWYKICAgICAgICAvLyB0aGUgbW9zdCByZWNlbnQgY2xhc3MgbWFuaXB1bGF0aW9uICh2aWEgJGFuaW1hdGUpIHdhcyB0byBhZGQgdGhlIGNsYXNzLCBhbmQgdGhlCiAgICAgICAgLy8gZWxlbWVudCBkb2VzIG5vdCBjdXJyZW50bHkgaGF2ZSB0aGUgY2xhc3MsIHRoZSBjbGFzcyBpcyBzY2hlZHVsZWQgdG8gYmUgYWRkZWQuCiAgICAgICAgaWYgKHN0YXR1cyA9PT0gZmFsc2UgJiYgaGFzQ2xhc3MpIHsKICAgICAgICAgIHRvUmVtb3ZlLnB1c2goY2xhc3NOYW1lKTsKICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gdHJ1ZSAmJiAhaGFzQ2xhc3MpIHsKICAgICAgICAgIHRvQWRkLnB1c2goY2xhc3NOYW1lKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmV0dXJuICh0b0FkZC5sZW5ndGggKyB0b1JlbW92ZS5sZW5ndGgpID4gMCAmJgogICAgICAgIFt0b0FkZC5sZW5ndGggPyB0b0FkZCA6IG51bGwsIHRvUmVtb3ZlLmxlbmd0aCA/IHRvUmVtb3ZlIDogbnVsbF07CiAgICB9CgogICAgZnVuY3Rpb24gY2FjaGVkQ2xhc3NNYW5pcHVsYXRpb24oY2FjaGUsIGNsYXNzZXMsIG9wKSB7CiAgICAgIGZvciAodmFyIGk9MCwgaWkgPSBjbGFzc2VzLmxlbmd0aDsgaSA8IGlpOyArK2kpIHsKICAgICAgICB2YXIgY2xhc3NOYW1lID0gY2xhc3Nlc1tpXTsKICAgICAgICBjYWNoZVtjbGFzc05hbWVdID0gb3A7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhc3luY1Byb21pc2UoKSB7CiAgICAgIC8vIG9ubHkgc2VydmUgb25lIGluc3RhbmNlIG9mIGEgcHJvbWlzZSBpbiBvcmRlciB0byBzYXZlIENQVSBjeWNsZXMKICAgICAgaWYgKCFjdXJyZW50RGVmZXIpIHsKICAgICAgICBjdXJyZW50RGVmZXIgPSAkJHEuZGVmZXIoKTsKICAgICAgICAkJGFzeW5jQ2FsbGJhY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICBjdXJyZW50RGVmZXIucmVzb2x2ZSgpOwogICAgICAgICAgY3VycmVudERlZmVyID0gbnVsbDsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gY3VycmVudERlZmVyLnByb21pc2U7CiAgICB9CgogICAgZnVuY3Rpb24gYXBwbHlTdHlsZXMoZWxlbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoYW5ndWxhci5pc09iamVjdChvcHRpb25zKSkgewogICAgICAgIHZhciBzdHlsZXMgPSBleHRlbmQob3B0aW9ucy5mcm9tIHx8IHt9LCBvcHRpb25zLnRvIHx8IHt9KTsKICAgICAgICBlbGVtZW50LmNzcyhzdHlsZXMpOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKgogICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAqIEBuYW1lICRhbmltYXRlCiAgICAgKiBAZGVzY3JpcHRpb24gVGhlICRhbmltYXRlIHNlcnZpY2UgcHJvdmlkZXMgcnVkaW1lbnRhcnkgRE9NIG1hbmlwdWxhdGlvbiBmdW5jdGlvbnMgdG8KICAgICAqIGluc2VydCwgcmVtb3ZlIGFuZCBtb3ZlIGVsZW1lbnRzIHdpdGhpbiB0aGUgRE9NLCBhcyB3ZWxsIGFzIGFkZGluZyBhbmQgcmVtb3ZpbmcgY2xhc3Nlcy4KICAgICAqIFRoaXMgc2VydmljZSBpcyB0aGUgY29yZSBzZXJ2aWNlIHVzZWQgYnkgdGhlIG5nQW5pbWF0ZSAkYW5pbWF0b3Igc2VydmljZSB3aGljaCBwcm92aWRlcwogICAgICogaGlnaC1sZXZlbCBhbmltYXRpb24gaG9va3MgZm9yIENTUyBhbmQgSmF2YVNjcmlwdC4KICAgICAqCiAgICAgKiAkYW5pbWF0ZSBpcyBhdmFpbGFibGUgaW4gdGhlIEFuZ3VsYXJKUyBjb3JlLCBob3dldmVyLCB0aGUgbmdBbmltYXRlIG1vZHVsZSBtdXN0IGJlIGluY2x1ZGVkCiAgICAgKiB0byBlbmFibGUgZnVsbCBvdXQgYW5pbWF0aW9uIHN1cHBvcnQuIE90aGVyd2lzZSwgJGFuaW1hdGUgd2lsbCBvbmx5IHBlcmZvcm0gc2ltcGxlIERPTQogICAgICogbWFuaXB1bGF0aW9uIG9wZXJhdGlvbnMuCiAgICAgKgogICAgICogVG8gbGVhcm4gbW9yZSBhYm91dCBlbmFibGluZyBhbmltYXRpb24gc3VwcG9ydCwgY2xpY2sgaGVyZSB0byB2aXNpdCB0aGUge0BsaW5rIG5nQW5pbWF0ZQogICAgICogbmdBbmltYXRlIG1vZHVsZSBwYWdlfSBhcyB3ZWxsIGFzIHRoZSB7QGxpbmsgbmdBbmltYXRlLiRhbmltYXRlIG5nQW5pbWF0ZSAkYW5pbWF0ZSBzZXJ2aWNlCiAgICAgKiBwYWdlfS4KICAgICAqLwogICAgcmV0dXJuIHsKICAgICAgYW5pbWF0ZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGZyb20sIHRvKSB7CiAgICAgICAgYXBwbHlTdHlsZXMoZWxlbWVudCwgeyBmcm9tOiBmcm9tLCB0bzogdG8gfSk7CiAgICAgICAgcmV0dXJuIGFzeW5jUHJvbWlzZSgpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGFuaW1hdGUjZW50ZXIKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICogQGRlc2NyaXB0aW9uIEluc2VydHMgdGhlIGVsZW1lbnQgaW50byB0aGUgRE9NIGVpdGhlciBhZnRlciB0aGUgYGFmdGVyYCBlbGVtZW50IG9yCiAgICAgICAqIGFzIHRoZSBmaXJzdCBjaGlsZCB3aXRoaW4gdGhlIGBwYXJlbnRgIGVsZW1lbnQuIFdoZW4gdGhlIGZ1bmN0aW9uIGlzIGNhbGxlZCBhIHByb21pc2UKICAgICAgICogaXMgcmV0dXJuZWQgdGhhdCB3aWxsIGJlIHJlc29sdmVkIGF0IGEgbGF0ZXIgdGltZS4KICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgYmUgaW5zZXJ0ZWQgaW50byB0aGUgRE9NCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gcGFyZW50IHRoZSBwYXJlbnQgZWxlbWVudCB3aGljaCB3aWxsIGFwcGVuZCB0aGUgZWxlbWVudCBhcwogICAgICAgKiAgIGEgY2hpbGQgKGlmIHRoZSBhZnRlciBlbGVtZW50IGlzIG5vdCBwcmVzZW50KQogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGFmdGVyIHRoZSBzaWJsaW5nIGVsZW1lbnQgd2hpY2ggd2lsbCBhcHBlbmQgdGhlIGVsZW1lbnQKICAgICAgICogICBhZnRlciBpdHNlbGYKICAgICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIGFuIG9wdGlvbmFsIGNvbGxlY3Rpb24gb2Ygc3R5bGVzIHRoYXQgd2lsbCBiZSBhcHBsaWVkIHRvIHRoZSBlbGVtZW50LgogICAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSB0aGUgYW5pbWF0aW9uIGNhbGxiYWNrIHByb21pc2UKICAgICAgICovCiAgICAgIGVudGVyIDogZnVuY3Rpb24oZWxlbWVudCwgcGFyZW50LCBhZnRlciwgb3B0aW9ucykgewogICAgICAgIGFwcGx5U3R5bGVzKGVsZW1lbnQsIG9wdGlvbnMpOwogICAgICAgIGFmdGVyID8gYWZ0ZXIuYWZ0ZXIoZWxlbWVudCkKICAgICAgICAgICAgICA6IHBhcmVudC5wcmVwZW5kKGVsZW1lbnQpOwogICAgICAgIHJldHVybiBhc3luY1Byb21pc2UoKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRhbmltYXRlI2xlYXZlCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqIEBkZXNjcmlwdGlvbiBSZW1vdmVzIHRoZSBlbGVtZW50IGZyb20gdGhlIERPTS4gV2hlbiB0aGUgZnVuY3Rpb24gaXMgY2FsbGVkIGEgcHJvbWlzZQogICAgICAgKiBpcyByZXR1cm5lZCB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgYXQgYSBsYXRlciB0aW1lLgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIERPTQogICAgICAgKiBAcGFyYW0ge29iamVjdD19IG9wdGlvbnMgYW4gb3B0aW9uYWwgY29sbGVjdGlvbiBvZiBvcHRpb25zIHRoYXQgd2lsbCBiZSBhcHBsaWVkIHRvIHRoZSBlbGVtZW50LgogICAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSB0aGUgYW5pbWF0aW9uIGNhbGxiYWNrIHByb21pc2UKICAgICAgICovCiAgICAgIGxlYXZlIDogZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucykgewogICAgICAgIGVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgcmV0dXJuIGFzeW5jUHJvbWlzZSgpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGFuaW1hdGUjbW92ZQogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKiBAZGVzY3JpcHRpb24gTW92ZXMgdGhlIHBvc2l0aW9uIG9mIHRoZSBwcm92aWRlZCBlbGVtZW50IHdpdGhpbiB0aGUgRE9NIHRvIGJlIHBsYWNlZAogICAgICAgKiBlaXRoZXIgYWZ0ZXIgdGhlIGBhZnRlcmAgZWxlbWVudCBvciBpbnNpZGUgb2YgdGhlIGBwYXJlbnRgIGVsZW1lbnQuIFdoZW4gdGhlIGZ1bmN0aW9uCiAgICAgICAqIGlzIGNhbGxlZCBhIHByb21pc2UgaXMgcmV0dXJuZWQgdGhhdCB3aWxsIGJlIHJlc29sdmVkIGF0IGEgbGF0ZXIgdGltZS4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgYmUgbW92ZWQgYXJvdW5kIHdpdGhpbiB0aGUKICAgICAgICogICBET00KICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBwYXJlbnQgdGhlIHBhcmVudCBlbGVtZW50IHdoZXJlIHRoZSBlbGVtZW50IHdpbGwgYmUKICAgICAgICogICBpbnNlcnRlZCBpbnRvIChpZiB0aGUgYWZ0ZXIgZWxlbWVudCBpcyBub3QgcHJlc2VudCkKICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBhZnRlciB0aGUgc2libGluZyBlbGVtZW50IHdoZXJlIHRoZSBlbGVtZW50IHdpbGwgYmUKICAgICAgICogICBwb3NpdGlvbmVkIG5leHQgdG8KICAgICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIGFuIG9wdGlvbmFsIGNvbGxlY3Rpb24gb2Ygb3B0aW9ucyB0aGF0IHdpbGwgYmUgYXBwbGllZCB0byB0aGUgZWxlbWVudC4KICAgICAgICogQHJldHVybiB7UHJvbWlzZX0gdGhlIGFuaW1hdGlvbiBjYWxsYmFjayBwcm9taXNlCiAgICAgICAqLwogICAgICBtb3ZlIDogZnVuY3Rpb24oZWxlbWVudCwgcGFyZW50LCBhZnRlciwgb3B0aW9ucykgewogICAgICAgIC8vIERvIG5vdCByZW1vdmUgZWxlbWVudCBiZWZvcmUgaW5zZXJ0LiBSZW1vdmluZyB3aWxsIGNhdXNlIGRhdGEgYXNzb2NpYXRlZCB3aXRoIHRoZQogICAgICAgIC8vIGVsZW1lbnQgdG8gYmUgZHJvcHBlZC4gSW5zZXJ0IHdpbGwgaW1wbGljaXRseSBkbyB0aGUgcmVtb3ZlLgogICAgICAgIHJldHVybiB0aGlzLmVudGVyKGVsZW1lbnQsIHBhcmVudCwgYWZ0ZXIsIG9wdGlvbnMpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGFuaW1hdGUjYWRkQ2xhc3MKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICogQGRlc2NyaXB0aW9uIEFkZHMgdGhlIHByb3ZpZGVkIGNsYXNzTmFtZSBDU1MgY2xhc3MgdmFsdWUgdG8gdGhlIHByb3ZpZGVkIGVsZW1lbnQuCiAgICAgICAqIFdoZW4gdGhlIGZ1bmN0aW9uIGlzIGNhbGxlZCBhIHByb21pc2UgaXMgcmV0dXJuZWQgdGhhdCB3aWxsIGJlIHJlc29sdmVkIGF0IGEgbGF0ZXIgdGltZS4KICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgaGF2ZSB0aGUgY2xhc3NOYW1lIHZhbHVlCiAgICAgICAqICAgYWRkZWQgdG8gaXQKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzTmFtZSB0aGUgQ1NTIGNsYXNzIHdoaWNoIHdpbGwgYmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQKICAgICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIGFuIG9wdGlvbmFsIGNvbGxlY3Rpb24gb2Ygb3B0aW9ucyB0aGF0IHdpbGwgYmUgYXBwbGllZCB0byB0aGUgZWxlbWVudC4KICAgICAgICogQHJldHVybiB7UHJvbWlzZX0gdGhlIGFuaW1hdGlvbiBjYWxsYmFjayBwcm9taXNlCiAgICAgICAqLwogICAgICBhZGRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgb3B0aW9ucykgewogICAgICAgIHJldHVybiB0aGlzLnNldENsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSwgW10sIG9wdGlvbnMpOwogICAgICB9LAoKICAgICAgJCRhZGRDbGFzc0ltbWVkaWF0ZWx5IDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBvcHRpb25zKSB7CiAgICAgICAgZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KTsKICAgICAgICBjbGFzc05hbWUgPSAhaXNTdHJpbmcoY2xhc3NOYW1lKQogICAgICAgICAgICAgICAgICAgICAgICA/IChpc0FycmF5KGNsYXNzTmFtZSkgPyBjbGFzc05hbWUuam9pbignICcpIDogJycpCiAgICAgICAgICAgICAgICAgICAgICAgIDogY2xhc3NOYW1lOwogICAgICAgIGZvckVhY2goZWxlbWVudCwgZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgIGpxTGl0ZUFkZENsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgfSk7CiAgICAgICAgYXBwbHlTdHlsZXMoZWxlbWVudCwgb3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIGFzeW5jUHJvbWlzZSgpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGFuaW1hdGUjcmVtb3ZlQ2xhc3MKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICogQGRlc2NyaXB0aW9uIFJlbW92ZXMgdGhlIHByb3ZpZGVkIGNsYXNzTmFtZSBDU1MgY2xhc3MgdmFsdWUgZnJvbSB0aGUgcHJvdmlkZWQgZWxlbWVudC4KICAgICAgICogV2hlbiB0aGUgZnVuY3Rpb24gaXMgY2FsbGVkIGEgcHJvbWlzZSBpcyByZXR1cm5lZCB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgYXQgYSBsYXRlciB0aW1lLgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBoYXZlIHRoZSBjbGFzc05hbWUgdmFsdWUKICAgICAgICogICByZW1vdmVkIGZyb20gaXQKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzTmFtZSB0aGUgQ1NTIGNsYXNzIHdoaWNoIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50CiAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBhbiBvcHRpb25hbCBjb2xsZWN0aW9uIG9mIG9wdGlvbnMgdGhhdCB3aWxsIGJlIGFwcGxpZWQgdG8gdGhlIGVsZW1lbnQuCiAgICAgICAqIEByZXR1cm4ge1Byb21pc2V9IHRoZSBhbmltYXRpb24gY2FsbGJhY2sgcHJvbWlzZQogICAgICAgKi8KICAgICAgcmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRDbGFzcyhlbGVtZW50LCBbXSwgY2xhc3NOYW1lLCBvcHRpb25zKTsKICAgICAgfSwKCiAgICAgICQkcmVtb3ZlQ2xhc3NJbW1lZGlhdGVseSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgb3B0aW9ucykgewogICAgICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CiAgICAgICAgY2xhc3NOYW1lID0gIWlzU3RyaW5nKGNsYXNzTmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgPyAoaXNBcnJheShjbGFzc05hbWUpID8gY2xhc3NOYW1lLmpvaW4oJyAnKSA6ICcnKQogICAgICAgICAgICAgICAgICAgICAgICA6IGNsYXNzTmFtZTsKICAgICAgICBmb3JFYWNoKGVsZW1lbnQsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICBqcUxpdGVSZW1vdmVDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgIH0pOwogICAgICAgIGFwcGx5U3R5bGVzKGVsZW1lbnQsIG9wdGlvbnMpOwogICAgICAgIHJldHVybiBhc3luY1Byb21pc2UoKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRhbmltYXRlI3NldENsYXNzCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqIEBkZXNjcmlwdGlvbiBBZGRzIGFuZC9vciByZW1vdmVzIHRoZSBnaXZlbiBDU1MgY2xhc3NlcyB0byBhbmQgZnJvbSB0aGUgZWxlbWVudC4KICAgICAgICogV2hlbiB0aGUgZnVuY3Rpb24gaXMgY2FsbGVkIGEgcHJvbWlzZSBpcyByZXR1cm5lZCB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgYXQgYSBsYXRlciB0aW1lLgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBoYXZlIGl0cyBDU1MgY2xhc3NlcyBjaGFuZ2VkCiAgICAgICAqICAgcmVtb3ZlZCBmcm9tIGl0CiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBhZGQgdGhlIENTUyBjbGFzc2VzIHdoaWNoIHdpbGwgYmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHJlbW92ZSB0aGUgQ1NTIGNsYXNzIHdoaWNoIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50CiAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBhbiBvcHRpb25hbCBjb2xsZWN0aW9uIG9mIG9wdGlvbnMgdGhhdCB3aWxsIGJlIGFwcGxpZWQgdG8gdGhlIGVsZW1lbnQuCiAgICAgICAqIEByZXR1cm4ge1Byb21pc2V9IHRoZSBhbmltYXRpb24gY2FsbGJhY2sgcHJvbWlzZQogICAgICAgKi8KICAgICAgc2V0Q2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBhZGQsIHJlbW92ZSwgb3B0aW9ucykgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB2YXIgU1RPUkFHRV9LRVkgPSAnJCRhbmltYXRlQ2xhc3Nlcyc7CiAgICAgICAgdmFyIGNyZWF0ZWRDYWNoZSA9IGZhbHNlOwogICAgICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CgogICAgICAgIHZhciBjYWNoZSA9IGVsZW1lbnQuZGF0YShTVE9SQUdFX0tFWSk7CiAgICAgICAgaWYgKCFjYWNoZSkgewogICAgICAgICAgY2FjaGUgPSB7CiAgICAgICAgICAgIGNsYXNzZXM6IHt9LAogICAgICAgICAgICBvcHRpb25zIDogb3B0aW9ucwogICAgICAgICAgfTsKICAgICAgICAgIGNyZWF0ZWRDYWNoZSA9IHRydWU7CiAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zICYmIGNhY2hlLm9wdGlvbnMpIHsKICAgICAgICAgIGNhY2hlLm9wdGlvbnMgPSBhbmd1bGFyLmV4dGVuZChjYWNoZS5vcHRpb25zIHx8IHt9LCBvcHRpb25zKTsKICAgICAgICB9CgogICAgICAgIHZhciBjbGFzc2VzID0gY2FjaGUuY2xhc3NlczsKCiAgICAgICAgYWRkID0gaXNBcnJheShhZGQpID8gYWRkIDogYWRkLnNwbGl0KCcgJyk7CiAgICAgICAgcmVtb3ZlID0gaXNBcnJheShyZW1vdmUpID8gcmVtb3ZlIDogcmVtb3ZlLnNwbGl0KCcgJyk7CiAgICAgICAgY2FjaGVkQ2xhc3NNYW5pcHVsYXRpb24oY2xhc3NlcywgYWRkLCB0cnVlKTsKICAgICAgICBjYWNoZWRDbGFzc01hbmlwdWxhdGlvbihjbGFzc2VzLCByZW1vdmUsIGZhbHNlKTsKCiAgICAgICAgaWYgKGNyZWF0ZWRDYWNoZSkgewogICAgICAgICAgY2FjaGUucHJvbWlzZSA9IHJ1bkFuaW1hdGlvblBvc3REaWdlc3QoZnVuY3Rpb24oZG9uZSkgewogICAgICAgICAgICB2YXIgY2FjaGUgPSBlbGVtZW50LmRhdGEoU1RPUkFHRV9LRVkpOwogICAgICAgICAgICBlbGVtZW50LnJlbW92ZURhdGEoU1RPUkFHRV9LRVkpOwoKICAgICAgICAgICAgLy8gaW4gdGhlIGV2ZW50IHRoYXQgdGhlIGVsZW1lbnQgaXMgcmVtb3ZlZCBiZWZvcmUgcG9zdERpZ2VzdAogICAgICAgICAgICAvLyBpcyBydW4gdGhlbiB0aGUgY2FjaGUgd2lsbCBiZSB1bmRlZmluZWQgYW5kIHRoZXJlIHdpbGwgYmUKICAgICAgICAgICAgLy8gbm8gbmVlZCBhbnltb3JlIHRvIGFkZCBvciByZW1vdmUgYW5kIG9mIHRoZSBlbGVtZW50IGNsYXNzZXMKICAgICAgICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgICAgICAgdmFyIGNsYXNzZXMgPSByZXNvbHZlRWxlbWVudENsYXNzZXMoZWxlbWVudCwgY2FjaGUuY2xhc3Nlcyk7CiAgICAgICAgICAgICAgaWYgKGNsYXNzZXMpIHsKICAgICAgICAgICAgICAgIHNlbGYuJCRzZXRDbGFzc0ltbWVkaWF0ZWx5KGVsZW1lbnQsIGNsYXNzZXNbMF0sIGNsYXNzZXNbMV0sIGNhY2hlLm9wdGlvbnMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgICBlbGVtZW50LmRhdGEoU1RPUkFHRV9LRVksIGNhY2hlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBjYWNoZS5wcm9taXNlOwogICAgICB9LAoKICAgICAgJCRzZXRDbGFzc0ltbWVkaWF0ZWx5IDogZnVuY3Rpb24oZWxlbWVudCwgYWRkLCByZW1vdmUsIG9wdGlvbnMpIHsKICAgICAgICBhZGQgJiYgdGhpcy4kJGFkZENsYXNzSW1tZWRpYXRlbHkoZWxlbWVudCwgYWRkKTsKICAgICAgICByZW1vdmUgJiYgdGhpcy4kJHJlbW92ZUNsYXNzSW1tZWRpYXRlbHkoZWxlbWVudCwgcmVtb3ZlKTsKICAgICAgICBhcHBseVN0eWxlcyhlbGVtZW50LCBvcHRpb25zKTsKICAgICAgICByZXR1cm4gYXN5bmNQcm9taXNlKCk7CiAgICAgIH0sCgogICAgICBlbmFibGVkIDogbm9vcCwKICAgICAgY2FuY2VsIDogbm9vcAogICAgfTsKICB9XTsKfV07CgpmdW5jdGlvbiAkJEFzeW5jQ2FsbGJhY2tQcm92aWRlcigpewogIHRoaXMuJGdldCA9IFsnJCRyQUYnLCAnJHRpbWVvdXQnLCBmdW5jdGlvbigkJHJBRiwgJHRpbWVvdXQpIHsKICAgIHJldHVybiAkJHJBRi5zdXBwb3J0ZWQKICAgICAgPyBmdW5jdGlvbihmbikgeyByZXR1cm4gJCRyQUYoZm4pOyB9CiAgICAgIDogZnVuY3Rpb24oZm4pIHsKICAgICAgICByZXR1cm4gJHRpbWVvdXQoZm4sIDAsIGZhbHNlKTsKICAgICAgfTsKICB9XTsKfQoKLyogZ2xvYmFsIHN0cmlwSGFzaDogdHJ1ZSAqLwoKLyoqCiAqICEgVGhpcyBpcyBhIHByaXZhdGUgdW5kb2N1bWVudGVkIHNlcnZpY2UgIQogKgogKiBAbmFtZSAkYnJvd3NlcgogKiBAcmVxdWlyZXMgJGxvZwogKiBAZGVzY3JpcHRpb24KICogVGhpcyBvYmplY3QgaGFzIHR3byBnb2FsczoKICoKICogLSBoaWRlIGFsbCB0aGUgZ2xvYmFsIHN0YXRlIGluIHRoZSBicm93c2VyIGNhdXNlZCBieSB0aGUgd2luZG93IG9iamVjdAogKiAtIGFic3RyYWN0IGF3YXkgYWxsIHRoZSBicm93c2VyIHNwZWNpZmljIGZlYXR1cmVzIGFuZCBpbmNvbnNpc3RlbmNpZXMKICoKICogRm9yIHRlc3RzIHdlIHByb3ZpZGUge0BsaW5rIG5nTW9jay4kYnJvd3NlciBtb2NrIGltcGxlbWVudGF0aW9ufSBvZiB0aGUgYCRicm93c2VyYAogKiBzZXJ2aWNlLCB3aGljaCBjYW4gYmUgdXNlZCBmb3IgY29udmVuaWVudCB0ZXN0aW5nIG9mIHRoZSBhcHBsaWNhdGlvbiB3aXRob3V0IHRoZSBpbnRlcmFjdGlvbiB3aXRoCiAqIHRoZSByZWFsIGJyb3dzZXIgYXBpcy4KICovCi8qKgogKiBAcGFyYW0ge29iamVjdH0gd2luZG93IFRoZSBnbG9iYWwgd2luZG93IG9iamVjdC4KICogQHBhcmFtIHtvYmplY3R9IGRvY3VtZW50IGpRdWVyeSB3cmFwcGVkIGRvY3VtZW50LgogKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IFhIUiBYTUxIdHRwUmVxdWVzdCBjb25zdHJ1Y3Rvci4KICogQHBhcmFtIHtvYmplY3R9ICRsb2cgY29uc29sZS5sb2cgb3IgYW4gb2JqZWN0IHdpdGggdGhlIHNhbWUgaW50ZXJmYWNlLgogKiBAcGFyYW0ge29iamVjdH0gJHNuaWZmZXIgJHNuaWZmZXIgc2VydmljZQogKi8KZnVuY3Rpb24gQnJvd3Nlcih3aW5kb3csIGRvY3VtZW50LCAkbG9nLCAkc25pZmZlcikgewogIHZhciBzZWxmID0gdGhpcywKICAgICAgcmF3RG9jdW1lbnQgPSBkb2N1bWVudFswXSwKICAgICAgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCiAgICAgIGhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeSwKICAgICAgc2V0VGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0LAogICAgICBjbGVhclRpbWVvdXQgPSB3aW5kb3cuY2xlYXJUaW1lb3V0LAogICAgICBwZW5kaW5nRGVmZXJJZHMgPSB7fTsKCiAgc2VsZi5pc01vY2sgPSBmYWxzZTsKCiAgdmFyIG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID0gMDsKICB2YXIgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzID0gW107CgogIC8vIFRPRE8odm9qdGEpOiByZW1vdmUgdGhpcyB0ZW1wb3JhcnkgYXBpCiAgc2VsZi4kJGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0ID0gY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Q7CiAgc2VsZi4kJGluY091dHN0YW5kaW5nUmVxdWVzdENvdW50ID0gZnVuY3Rpb24oKSB7IG91dHN0YW5kaW5nUmVxdWVzdENvdW50Kys7IH07CgogIC8qKgogICAqIEV4ZWN1dGVzIHRoZSBgZm5gIGZ1bmN0aW9uKHN1cHBvcnRzIGN1cnJ5aW5nKSBhbmQgZGVjcmVtZW50cyB0aGUgYG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrc2AKICAgKiBjb3VudGVyLiBJZiB0aGUgY291bnRlciByZWFjaGVzIDAsIGFsbCB0aGUgYG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrc2AgYXJlIGV4ZWN1dGVkLgogICAqLwogIGZ1bmN0aW9uIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGZuKSB7CiAgICB0cnkgewogICAgICBmbi5hcHBseShudWxsLCBzbGljZUFyZ3MoYXJndW1lbnRzLCAxKSk7CiAgICB9IGZpbmFsbHkgewogICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudC0tOwogICAgICBpZiAob3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPT09IDApIHsKICAgICAgICB3aGlsZShvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucG9wKCkoKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgJGxvZy5lcnJvcihlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIC8qKgogICAqIEBwcml2YXRlCiAgICogTm90ZTogdGhpcyBtZXRob2QgaXMgdXNlZCBvbmx5IGJ5IHNjZW5hcmlvIHJ1bm5lcgogICAqIFRPRE8odm9qdGEpOiBwcmVmaXggdGhpcyBtZXRob2Qgd2l0aCAkJCA/CiAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBjYWxsYmFjayBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW4gbm8gb3V0c3RhbmRpbmcgcmVxdWVzdAogICAqLwogIHNlbGYubm90aWZ5V2hlbk5vT3V0c3RhbmRpbmdSZXF1ZXN0cyA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAvLyBmb3JjZSBicm93c2VyIHRvIGV4ZWN1dGUgYWxsIHBvbGxGbnMgLSB0aGlzIGlzIG5lZWRlZCBzbyB0aGF0IGNvb2tpZXMgYW5kIG90aGVyIHBvbGxlcnMgZmlyZQogICAgLy8gYXQgc29tZSBkZXRlcm1pbmlzdGljIHRpbWUgaW4gcmVzcGVjdCB0byB0aGUgdGVzdCBydW5uZXIncyBhY3Rpb25zLiBMZWF2aW5nIHRoaW5ncyB1cCB0byB0aGUKICAgIC8vIHJlZ3VsYXIgcG9sbGVyIHdvdWxkIHJlc3VsdCBpbiBmbGFreSB0ZXN0cy4KICAgIGZvckVhY2gocG9sbEZucywgZnVuY3Rpb24ocG9sbEZuKXsgcG9sbEZuKCk7IH0pOwoKICAgIGlmIChvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9PT0gMCkgewogICAgICBjYWxsYmFjaygpOwogICAgfSBlbHNlIHsKICAgICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwogICAgfQogIH07CgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgLy8gUG9sbCBXYXRjaGVyIEFQSQogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgdmFyIHBvbGxGbnMgPSBbXSwKICAgICAgcG9sbFRpbWVvdXQ7CgogIC8qKgogICAqIEBuYW1lICRicm93c2VyI2FkZFBvbGxGbgogICAqCiAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBQb2xsIGZ1bmN0aW9uIHRvIGFkZAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQWRkcyBhIGZ1bmN0aW9uIHRvIHRoZSBsaXN0IG9mIGZ1bmN0aW9ucyB0aGF0IHBvbGxlciBwZXJpb2RpY2FsbHkgZXhlY3V0ZXMsCiAgICogYW5kIHN0YXJ0cyBwb2xsaW5nIGlmIG5vdCBzdGFydGVkIHlldC4KICAgKgogICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSB0aGUgYWRkZWQgZnVuY3Rpb24KICAgKi8KICBzZWxmLmFkZFBvbGxGbiA9IGZ1bmN0aW9uKGZuKSB7CiAgICBpZiAoaXNVbmRlZmluZWQocG9sbFRpbWVvdXQpKSBzdGFydFBvbGxlcigxMDAsIHNldFRpbWVvdXQpOwogICAgcG9sbEZucy5wdXNoKGZuKTsKICAgIHJldHVybiBmbjsKICB9OwoKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW50ZXJ2YWwgSG93IG9mdGVuIHNob3VsZCBicm93c2VyIGNhbGwgcG9sbCBmdW5jdGlvbnMgKG1zKQogICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gc2V0VGltZW91dCBSZWZlcmVuY2UgdG8gYSByZWFsIG9yIGZha2UgYHNldFRpbWVvdXRgIGZ1bmN0aW9uLgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ29uZmlndXJlcyB0aGUgcG9sbGVyIHRvIHJ1biBpbiB0aGUgc3BlY2lmaWVkIGludGVydmFscywgdXNpbmcgdGhlIHNwZWNpZmllZAogICAqIHNldFRpbWVvdXQgZm4gYW5kIGtpY2tzIGl0IG9mZi4KICAgKi8KICBmdW5jdGlvbiBzdGFydFBvbGxlcihpbnRlcnZhbCwgc2V0VGltZW91dCkgewogICAgKGZ1bmN0aW9uIGNoZWNrKCkgewogICAgICBmb3JFYWNoKHBvbGxGbnMsIGZ1bmN0aW9uKHBvbGxGbil7IHBvbGxGbigpOyB9KTsKICAgICAgcG9sbFRpbWVvdXQgPSBzZXRUaW1lb3V0KGNoZWNrLCBpbnRlcnZhbCk7CiAgICB9KSgpOwogIH0KCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBVUkwgQVBJCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgdmFyIGNhY2hlZFN0YXRlLCBsYXN0SGlzdG9yeVN0YXRlLAogICAgICBsYXN0QnJvd3NlclVybCA9IGxvY2F0aW9uLmhyZWYsCiAgICAgIGJhc2VFbGVtZW50ID0gZG9jdW1lbnQuZmluZCgnYmFzZScpLAogICAgICByZWxvYWRMb2NhdGlvbiA9IG51bGw7CgogIGNhY2hlU3RhdGUoKTsKICBsYXN0SGlzdG9yeVN0YXRlID0gY2FjaGVkU3RhdGU7CgogIC8qKgogICAqIEBuYW1lICRicm93c2VyI3VybAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogR0VUVEVSOgogICAqIFdpdGhvdXQgYW55IGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBqdXN0IHJldHVybnMgY3VycmVudCB2YWx1ZSBvZiBsb2NhdGlvbi5ocmVmLgogICAqCiAgICogU0VUVEVSOgogICAqIFdpdGggYXQgbGVhc3Qgb25lIGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBzZXRzIHVybCB0byBuZXcgdmFsdWUuCiAgICogSWYgaHRtbDUgaGlzdG9yeSBhcGkgc3VwcG9ydGVkLCBwdXNoU3RhdGUvcmVwbGFjZVN0YXRlIGlzIHVzZWQsIG90aGVyd2lzZQogICAqIGxvY2F0aW9uLmhyZWYvbG9jYXRpb24ucmVwbGFjZSBpcyB1c2VkLgogICAqIFJldHVybnMgaXRzIG93biBpbnN0YW5jZSB0byBhbGxvdyBjaGFpbmluZwogICAqCiAgICogTk9URTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbiBzZXJ2aWNlfSB0byBjaGFuZ2UgdXJsLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBOZXcgdXJsICh3aGVuIHVzZWQgYXMgc2V0dGVyKQogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHJlcGxhY2UgU2hvdWxkIG5ldyB1cmwgcmVwbGFjZSBjdXJyZW50IGhpc3RvcnkgcmVjb3JkPwogICAqIEBwYXJhbSB7b2JqZWN0PX0gc3RhdGUgb2JqZWN0IHRvIHVzZSB3aXRoIHB1c2hTdGF0ZS9yZXBsYWNlU3RhdGUKICAgKi8KICBzZWxmLnVybCA9IGZ1bmN0aW9uKHVybCwgcmVwbGFjZSwgc3RhdGUpIHsKICAgIC8vIEluIG1vZGVybiBicm93c2VycyBgaGlzdG9yeS5zdGF0ZWAgaXMgYG51bGxgIGJ5IGRlZmF1bHQ7IHRyZWF0aW5nIGl0IHNlcGFyYXRlbHkKICAgIC8vIGZyb20gYHVuZGVmaW5lZGAgd291bGQgY2F1c2UgYCRicm93c2VyLnVybCgnL2ZvbycpYCB0byBjaGFuZ2UgYGhpc3Rvcnkuc3RhdGVgCiAgICAvLyB0byB1bmRlZmluZWQgdmlhIGBwdXNoU3RhdGVgLiBJbnN0ZWFkLCBsZXQncyBjaGFuZ2UgYHVuZGVmaW5lZGAgdG8gYG51bGxgIGhlcmUuCiAgICBpZiAoaXNVbmRlZmluZWQoc3RhdGUpKSB7CiAgICAgIHN0YXRlID0gbnVsbDsKICAgIH0KCiAgICAvLyBBbmRyb2lkIEJyb3dzZXIgQkZDYWNoZSBjYXVzZXMgbG9jYXRpb24sIGhpc3RvcnkgcmVmZXJlbmNlIHRvIGJlY29tZSBzdGFsZS4KICAgIGlmIChsb2NhdGlvbiAhPT0gd2luZG93LmxvY2F0aW9uKSBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKICAgIGlmIChoaXN0b3J5ICE9PSB3aW5kb3cuaGlzdG9yeSkgaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwoKICAgIC8vIHNldHRlcgogICAgaWYgKHVybCkgewogICAgICB2YXIgc2FtZVN0YXRlID0gbGFzdEhpc3RvcnlTdGF0ZSA9PT0gc3RhdGU7CgogICAgICAvLyBEb24ndCBjaGFuZ2UgYW55dGhpbmcgaWYgcHJldmlvdXMgYW5kIGN1cnJlbnQgVVJMcyBhbmQgc3RhdGVzIG1hdGNoLiBUaGlzIGFsc28gcHJldmVudHMKICAgICAgLy8gSUU8MTAgZnJvbSBnZXR0aW5nIGludG8gcmVkaXJlY3QgbG9vcCB3aGVuIGluIExvY2F0aW9uSGFzaGJhbmdJbkh0bWw1VXJsIG1vZGUuCiAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2NvbW1pdC9mZmIyNzAxCiAgICAgIGlmIChsYXN0QnJvd3NlclVybCA9PT0gdXJsICYmICghJHNuaWZmZXIuaGlzdG9yeSB8fCBzYW1lU3RhdGUpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBzYW1lQmFzZSA9IGxhc3RCcm93c2VyVXJsICYmIHN0cmlwSGFzaChsYXN0QnJvd3NlclVybCkgPT09IHN0cmlwSGFzaCh1cmwpOwogICAgICBsYXN0QnJvd3NlclVybCA9IHVybDsKICAgICAgbGFzdEhpc3RvcnlTdGF0ZSA9IHN0YXRlOwogICAgICAvLyBEb24ndCB1c2UgaGlzdG9yeSBBUEkgaWYgb25seSB0aGUgaGFzaCBjaGFuZ2VkCiAgICAgIC8vIGR1ZSB0byBhIGJ1ZyBpbiBJRTEwL0lFMTEgd2hpY2ggbGVhZHMKICAgICAgLy8gdG8gbm90IGZpcmluZyBhIGBoYXNoY2hhbmdlYCBub3IgYHBvcHN0YXRlYCBldmVudAogICAgICAvLyBpbiBzb21lIGNhc2VzIChzZWUgIzkxNDMpLgogICAgICBpZiAoJHNuaWZmZXIuaGlzdG9yeSAmJiAoIXNhbWVCYXNlIHx8ICFzYW1lU3RhdGUpKSB7CiAgICAgICAgaGlzdG9yeVtyZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oc3RhdGUsICcnLCB1cmwpOwogICAgICAgIGNhY2hlU3RhdGUoKTsKICAgICAgICAvLyBEbyB0aGUgYXNzaWdubWVudCBhZ2FpbiBzbyB0aGF0IHRob3NlIHR3byB2YXJpYWJsZXMgYXJlIHJlZmVyZW50aWFsbHkgaWRlbnRpY2FsLgogICAgICAgIGxhc3RIaXN0b3J5U3RhdGUgPSBjYWNoZWRTdGF0ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoIXNhbWVCYXNlKSB7CiAgICAgICAgICByZWxvYWRMb2NhdGlvbiA9IHVybDsKICAgICAgICB9CiAgICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICAgIGxvY2F0aW9uLnJlcGxhY2UodXJsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbG9jYXRpb24uaHJlZiA9IHVybDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHNlbGY7CiAgICAvLyBnZXR0ZXIKICAgIH0gZWxzZSB7CiAgICAgIC8vIC0gcmVsb2FkTG9jYXRpb24gaXMgbmVlZGVkIGFzIGJyb3dzZXJzIGRvbid0IGFsbG93IHRvIHJlYWQgb3V0CiAgICAgIC8vICAgdGhlIG5ldyBsb2NhdGlvbi5ocmVmIGlmIGEgcmVsb2FkIGhhcHBlbmVkLgogICAgICAvLyAtIHRoZSByZXBsYWNlbWVudCBpcyBhIHdvcmthcm91bmQgZm9yIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTQwNzE3MgogICAgICByZXR1cm4gcmVsb2FkTG9jYXRpb24gfHwgbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8lMjcvZywiJyIpOwogICAgfQogIH07CgogIC8qKgogICAqIEBuYW1lICRicm93c2VyI3N0YXRlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIG1ldGhvZCBpcyBhIGdldHRlci4KICAgKgogICAqIFJldHVybiBoaXN0b3J5LnN0YXRlIG9yIG51bGwgaWYgaGlzdG9yeS5zdGF0ZSBpcyB1bmRlZmluZWQuCiAgICoKICAgKiBAcmV0dXJucyB7b2JqZWN0fSBzdGF0ZQogICAqLwogIHNlbGYuc3RhdGUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjYWNoZWRTdGF0ZTsKICB9OwoKICB2YXIgdXJsQ2hhbmdlTGlzdGVuZXJzID0gW10sCiAgICAgIHVybENoYW5nZUluaXQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gY2FjaGVTdGF0ZUFuZEZpcmVVcmxDaGFuZ2UoKSB7CiAgICBjYWNoZVN0YXRlKCk7CiAgICBmaXJlVXJsQ2hhbmdlKCk7CiAgfQoKICAvLyBUaGlzIHZhcmlhYmxlIHNob3VsZCBiZSB1c2VkICpvbmx5KiBpbnNpZGUgdGhlIGNhY2hlU3RhdGUgZnVuY3Rpb24uCiAgdmFyIGxhc3RDYWNoZWRTdGF0ZSA9IG51bGw7CiAgZnVuY3Rpb24gY2FjaGVTdGF0ZSgpIHsKICAgIC8vIFRoaXMgc2hvdWxkIGJlIHRoZSBvbmx5IHBsYWNlIGluICRicm93c2VyIHdoZXJlIGBoaXN0b3J5LnN0YXRlYCBpcyByZWFkLgogICAgY2FjaGVkU3RhdGUgPSB3aW5kb3cuaGlzdG9yeS5zdGF0ZTsKICAgIGNhY2hlZFN0YXRlID0gaXNVbmRlZmluZWQoY2FjaGVkU3RhdGUpID8gbnVsbCA6IGNhY2hlZFN0YXRlOwoKICAgIC8vIFByZXZlbnQgY2FsbGJhY2tzIGZvIGZpcmUgdHdpY2UgaWYgYm90aCBoYXNoY2hhbmdlICYgcG9wc3RhdGUgd2VyZSBmaXJlZC4KICAgIGlmIChlcXVhbHMoY2FjaGVkU3RhdGUsIGxhc3RDYWNoZWRTdGF0ZSkpIHsKICAgICAgY2FjaGVkU3RhdGUgPSBsYXN0Q2FjaGVkU3RhdGU7CiAgICB9CiAgICBsYXN0Q2FjaGVkU3RhdGUgPSBjYWNoZWRTdGF0ZTsKICB9CgogIGZ1bmN0aW9uIGZpcmVVcmxDaGFuZ2UoKSB7CiAgICBpZiAobGFzdEJyb3dzZXJVcmwgPT09IHNlbGYudXJsKCkgJiYgbGFzdEhpc3RvcnlTdGF0ZSA9PT0gY2FjaGVkU3RhdGUpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGxhc3RCcm93c2VyVXJsID0gc2VsZi51cmwoKTsKICAgIGxhc3RIaXN0b3J5U3RhdGUgPSBjYWNoZWRTdGF0ZTsKICAgIGZvckVhY2godXJsQ2hhbmdlTGlzdGVuZXJzLCBmdW5jdGlvbihsaXN0ZW5lcikgewogICAgICBsaXN0ZW5lcihzZWxmLnVybCgpLCBjYWNoZWRTdGF0ZSk7CiAgICB9KTsKICB9CgogIC8qKgogICAqIEBuYW1lICRicm93c2VyI29uVXJsQ2hhbmdlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZWdpc3RlciBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkLCB3aGVuIHVybCBjaGFuZ2VzLgogICAqCiAgICogSXQncyBvbmx5IGNhbGxlZCB3aGVuIHRoZSB1cmwgaXMgY2hhbmdlZCBmcm9tIG91dHNpZGUgb2YgYW5ndWxhcjoKICAgKiAtIHVzZXIgdHlwZXMgZGlmZmVyZW50IHVybCBpbnRvIGFkZHJlc3MgYmFyCiAgICogLSB1c2VyIGNsaWNrcyBvbiBoaXN0b3J5IChmb3J3YXJkL2JhY2spIGJ1dHRvbgogICAqIC0gdXNlciBjbGlja3Mgb24gYSBsaW5rCiAgICoKICAgKiBJdCdzIG5vdCBjYWxsZWQgd2hlbiB1cmwgaXMgY2hhbmdlZCBieSAkYnJvd3Nlci51cmwoKSBtZXRob2QKICAgKgogICAqIFRoZSBsaXN0ZW5lciBnZXRzIGNhbGxlZCB3aXRoIG5ldyB1cmwgYXMgcGFyYW1ldGVyLgogICAqCiAgICogTk9URTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbiBzZXJ2aWNlfSB0byBtb25pdG9yIHVybCBjaGFuZ2VzIGluIGFuZ3VsYXIgYXBwcy4KICAgKgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nKX0gbGlzdGVuZXIgTGlzdGVuZXIgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdXJsIGNoYW5nZXMuCiAgICogQHJldHVybiB7ZnVuY3Rpb24oc3RyaW5nKX0gUmV0dXJucyB0aGUgcmVnaXN0ZXJlZCBsaXN0ZW5lciBmbiAtIGhhbmR5IGlmIHRoZSBmbiBpcyBhbm9ueW1vdXMuCiAgICovCiAgc2VsZi5vblVybENoYW5nZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAvLyBUT0RPKHZvanRhKTogcmVmYWN0b3IgdG8gdXNlIG5vZGUncyBzeW50YXggZm9yIGV2ZW50cwogICAgaWYgKCF1cmxDaGFuZ2VJbml0KSB7CiAgICAgIC8vIFdlIGxpc3RlbiBvbiBib3RoIChoYXNoY2hhbmdlL3BvcHN0YXRlKSB3aGVuIGF2YWlsYWJsZSwgYXMgc29tZSBicm93c2VycyAoZS5nLiBPcGVyYSkKICAgICAgLy8gZG9uJ3QgZmlyZSBwb3BzdGF0ZSB3aGVuIHVzZXIgY2hhbmdlIHRoZSBhZGRyZXNzIGJhciBhbmQgZG9uJ3QgZmlyZSBoYXNoY2hhbmdlIHdoZW4gdXJsCiAgICAgIC8vIGNoYW5nZWQgYnkgcHVzaC9yZXBsYWNlU3RhdGUKCiAgICAgIC8vIGh0bWw1IGhpc3RvcnkgYXBpIC0gcG9wc3RhdGUgZXZlbnQKICAgICAgaWYgKCRzbmlmZmVyLmhpc3RvcnkpIGpxTGl0ZSh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIGNhY2hlU3RhdGVBbmRGaXJlVXJsQ2hhbmdlKTsKICAgICAgLy8gaGFzaGNoYW5nZSBldmVudAogICAgICBqcUxpdGUod2luZG93KS5vbignaGFzaGNoYW5nZScsIGNhY2hlU3RhdGVBbmRGaXJlVXJsQ2hhbmdlKTsKCiAgICAgIHVybENoYW5nZUluaXQgPSB0cnVlOwogICAgfQoKICAgIHVybENoYW5nZUxpc3RlbmVycy5wdXNoKGNhbGxiYWNrKTsKICAgIHJldHVybiBjYWxsYmFjazsKICB9OwoKICAvKioKICAgKiBDaGVja3Mgd2hldGhlciB0aGUgdXJsIGhhcyBjaGFuZ2VkIG91dHNpZGUgb2YgQW5ndWxhci4KICAgKiBOZWVkcyB0byBiZSBleHBvcnRlZCB0byBiZSBhYmxlIHRvIGNoZWNrIGZvciBjaGFuZ2VzIHRoYXQgaGF2ZSBiZWVuIGRvbmUgaW4gc3luYywKICAgKiBhcyBoYXNoY2hhbmdlL3BvcHN0YXRlIGV2ZW50cyBmaXJlIGluIGFzeW5jLgogICAqLwogIHNlbGYuJCRjaGVja1VybENoYW5nZSA9IGZpcmVVcmxDaGFuZ2U7CgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgLy8gTWlzYyBBUEkKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAvKioKICAgKiBAbmFtZSAkYnJvd3NlciNiYXNlSHJlZgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmV0dXJucyBjdXJyZW50IDxiYXNlIGhyZWY+CiAgICogKGFsd2F5cyByZWxhdGl2ZSAtIHdpdGhvdXQgZG9tYWluKQogICAqCiAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGN1cnJlbnQgYmFzZSBocmVmCiAgICovCiAgc2VsZi5iYXNlSHJlZiA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGhyZWYgPSBiYXNlRWxlbWVudC5hdHRyKCdocmVmJyk7CiAgICByZXR1cm4gaHJlZiA/IGhyZWYucmVwbGFjZSgvXihodHRwcz9cOik/XC9cL1teXC9dKi8sICcnKSA6ICcnOwogIH07CgogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgLy8gQ29va2llcyBBUEkKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIHZhciBsYXN0Q29va2llcyA9IHt9OwogIHZhciBsYXN0Q29va2llU3RyaW5nID0gJyc7CiAgdmFyIGNvb2tpZVBhdGggPSBzZWxmLmJhc2VIcmVmKCk7CgogIGZ1bmN0aW9uIHNhZmVEZWNvZGVVUklDb21wb25lbnQoc3RyKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHN0cik7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHJldHVybiBzdHI7CiAgICB9CiAgfQoKICAvKioKICAgKiBAbmFtZSAkYnJvd3NlciNjb29raWVzCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgQ29va2llIG5hbWUKICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIENvb2tpZSB2YWx1ZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGNvb2tpZXMgbWV0aG9kIHByb3ZpZGVzIGEgJ3ByaXZhdGUnIGxvdyBsZXZlbCBhY2Nlc3MgdG8gYnJvd3NlciBjb29raWVzLgogICAqIEl0IGlzIG5vdCBtZWFudCB0byBiZSB1c2VkIGRpcmVjdGx5LCB1c2UgdGhlICRjb29raWUgc2VydmljZSBpbnN0ZWFkLgogICAqCiAgICogVGhlIHJldHVybiB2YWx1ZXMgdmFyeSBkZXBlbmRpbmcgb24gdGhlIGFyZ3VtZW50cyB0aGF0IHRoZSBtZXRob2Qgd2FzIGNhbGxlZCB3aXRoIGFzIGZvbGxvd3M6CiAgICoKICAgKiAtIGNvb2tpZXMoKSAtPiBoYXNoIG9mIGFsbCBjb29raWVzLCB0aGlzIGlzIE5PVCBhIGNvcHkgb2YgdGhlIGludGVybmFsIHN0YXRlLCBzbyBkbyBub3QgbW9kaWZ5CiAgICogICBpdAogICAqIC0gY29va2llcyhuYW1lLCB2YWx1ZSkgLT4gc2V0IG5hbWUgdG8gdmFsdWUsIGlmIHZhbHVlIGlzIHVuZGVmaW5lZCBkZWxldGUgdGhlIGNvb2tpZQogICAqIC0gY29va2llcyhuYW1lKSAtPiB0aGUgc2FtZSBhcyAobmFtZSwgdW5kZWZpbmVkKSA9PSBERUxFVEVTIChubyBvbmUgY2FsbHMgaXQgcmlnaHQgbm93IHRoYXQKICAgKiAgIHdheSkKICAgKgogICAqIEByZXR1cm5zIHtPYmplY3R9IEhhc2ggb2YgYWxsIGNvb2tpZXMgKGlmIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIpCiAgICovCiAgc2VsZi5jb29raWVzID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgIHZhciBjb29raWVMZW5ndGgsIGNvb2tpZUFycmF5LCBjb29raWUsIGksIGluZGV4OwoKICAgIGlmIChuYW1lKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmF3RG9jdW1lbnQuY29va2llID0gZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpICsgIj07cGF0aD0iICsgY29va2llUGF0aCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIjtleHBpcmVzPVRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UIjsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICBjb29raWVMZW5ndGggPSAocmF3RG9jdW1lbnQuY29va2llID0gZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJztwYXRoPScgKyBjb29raWVQYXRoKS5sZW5ndGggKyAxOwoKICAgICAgICAgIC8vIHBlciBodHRwOi8vd3d3LmlldGYub3JnL3JmYy9yZmMyMTA5LnR4dCBicm93c2VyIG11c3QgYWxsb3cgYXQgbWluaW11bToKICAgICAgICAgIC8vIC0gMzAwIGNvb2tpZXMKICAgICAgICAgIC8vIC0gMjAgY29va2llcyBwZXIgdW5pcXVlIGRvbWFpbgogICAgICAgICAgLy8gLSA0MDk2IGJ5dGVzIHBlciBjb29raWUKICAgICAgICAgIGlmIChjb29raWVMZW5ndGggPiA0MDk2KSB7CiAgICAgICAgICAgICRsb2cud2FybigiQ29va2llICciKyBuYW1lICsKICAgICAgICAgICAgICAiJyBwb3NzaWJseSBub3Qgc2V0IG9yIG92ZXJmbG93ZWQgYmVjYXVzZSBpdCB3YXMgdG9vIGxhcmdlICgiKwogICAgICAgICAgICAgIGNvb2tpZUxlbmd0aCArICIgPiA0MDk2IGJ5dGVzKSEiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChyYXdEb2N1bWVudC5jb29raWUgIT09IGxhc3RDb29raWVTdHJpbmcpIHsKICAgICAgICBsYXN0Q29va2llU3RyaW5nID0gcmF3RG9jdW1lbnQuY29va2llOwogICAgICAgIGNvb2tpZUFycmF5ID0gbGFzdENvb2tpZVN0cmluZy5zcGxpdCgiOyAiKTsKICAgICAgICBsYXN0Q29va2llcyA9IHt9OwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29va2llQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvb2tpZSA9IGNvb2tpZUFycmF5W2ldOwogICAgICAgICAgaW5kZXggPSBjb29raWUuaW5kZXhPZignPScpOwogICAgICAgICAgaWYgKGluZGV4ID4gMCkgeyAvL2lnbm9yZSBuYW1lbGVzcyBjb29raWVzCiAgICAgICAgICAgIG5hbWUgPSBzYWZlRGVjb2RlVVJJQ29tcG9uZW50KGNvb2tpZS5zdWJzdHJpbmcoMCwgaW5kZXgpKTsKICAgICAgICAgICAgLy8gdGhlIGZpcnN0IHZhbHVlIHRoYXQgaXMgc2VlbiBmb3IgYSBjb29raWUgaXMgdGhlIG1vc3QKICAgICAgICAgICAgLy8gc3BlY2lmaWMgb25lLiAgdmFsdWVzIGZvciB0aGUgc2FtZSBjb29raWUgbmFtZSB0aGF0CiAgICAgICAgICAgIC8vIGZvbGxvdyBhcmUgZm9yIGxlc3Mgc3BlY2lmaWMgcGF0aHMuCiAgICAgICAgICAgIGlmIChsYXN0Q29va2llc1tuYW1lXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgbGFzdENvb2tpZXNbbmFtZV0gPSBzYWZlRGVjb2RlVVJJQ29tcG9uZW50KGNvb2tpZS5zdWJzdHJpbmcoaW5kZXggKyAxKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGxhc3RDb29raWVzOwogICAgfQogIH07CgoKICAvKioKICAgKiBAbmFtZSAkYnJvd3NlciNkZWZlcgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvJ3MgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWZlcnJlZC4KICAgKiBAcGFyYW0ge251bWJlcj19IFtkZWxheT0wXSBvZiBtaWxsaXNlY29uZHMgdG8gZGVmZXIgdGhlIGZ1bmN0aW9uIGV4ZWN1dGlvbi4KICAgKiBAcmV0dXJucyB7Kn0gRGVmZXJJZCB0aGF0IGNhbiBiZSB1c2VkIHRvIGNhbmNlbCB0aGUgdGFzayB2aWEgYCRicm93c2VyLmRlZmVyLmNhbmNlbCgpYC4KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEV4ZWN1dGVzIGEgZm4gYXN5bmNocm9ub3VzbHkgdmlhIGBzZXRUaW1lb3V0KGZuLCBkZWxheSlgLgogICAqCiAgICogVW5saWtlIHdoZW4gY2FsbGluZyBgc2V0VGltZW91dGAgZGlyZWN0bHksIGluIHRlc3QgdGhpcyBmdW5jdGlvbiBpcyBtb2NrZWQgYW5kIGluc3RlYWQgb2YgdXNpbmcKICAgKiBgc2V0VGltZW91dGAgaW4gdGVzdHMsIHRoZSBmbnMgYXJlIHF1ZXVlZCBpbiBhbiBhcnJheSwgd2hpY2ggY2FuIGJlIHByb2dyYW1tYXRpY2FsbHkgZmx1c2hlZAogICAqIHZpYSBgJGJyb3dzZXIuZGVmZXIuZmx1c2goKWAuCiAgICoKICAgKi8KICBzZWxmLmRlZmVyID0gZnVuY3Rpb24oZm4sIGRlbGF5KSB7CiAgICB2YXIgdGltZW91dElkOwogICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQrKzsKICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXTsKICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoZm4pOwogICAgfSwgZGVsYXkgfHwgMCk7CiAgICBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXSA9IHRydWU7CiAgICByZXR1cm4gdGltZW91dElkOwogIH07CgoKICAvKioKICAgKiBAbmFtZSAkYnJvd3NlciNkZWZlci5jYW5jZWwKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENhbmNlbHMgYSBkZWZlcnJlZCB0YXNrIGlkZW50aWZpZWQgd2l0aCBgZGVmZXJJZGAuCiAgICoKICAgKiBAcGFyYW0geyp9IGRlZmVySWQgVG9rZW4gcmV0dXJuZWQgYnkgdGhlIGAkYnJvd3Nlci5kZWZlcmAgZnVuY3Rpb24uCiAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB0YXNrIGhhc24ndCBleGVjdXRlZCB5ZXQgYW5kIHdhcyBzdWNjZXNzZnVsbHkKICAgKiAgICAgICAgICAgICAgICAgICAgY2FuY2VsZWQuCiAgICovCiAgc2VsZi5kZWZlci5jYW5jZWwgPSBmdW5jdGlvbihkZWZlcklkKSB7CiAgICBpZiAocGVuZGluZ0RlZmVySWRzW2RlZmVySWRdKSB7CiAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbZGVmZXJJZF07CiAgICAgIGNsZWFyVGltZW91dChkZWZlcklkKTsKICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Qobm9vcCk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07Cgp9CgpmdW5jdGlvbiAkQnJvd3NlclByb3ZpZGVyKCl7CiAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgJyRsb2cnLCAnJHNuaWZmZXInLCAnJGRvY3VtZW50JywKICAgICAgZnVuY3Rpb24oICR3aW5kb3csICAgJGxvZywgICAkc25pZmZlciwgICAkZG9jdW1lbnQpewogICAgICAgIHJldHVybiBuZXcgQnJvd3Nlcigkd2luZG93LCAkZG9jdW1lbnQsICRsb2csICRzbmlmZmVyKTsKICAgICAgfV07Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkY2FjaGVGYWN0b3J5CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBGYWN0b3J5IHRoYXQgY29uc3RydWN0cyB7QGxpbmsgJGNhY2hlRmFjdG9yeS5DYWNoZSBDYWNoZX0gb2JqZWN0cyBhbmQgZ2l2ZXMgYWNjZXNzIHRvCiAqIHRoZW0uCiAqCiAqIGBgYGpzCiAqCiAqICB2YXIgY2FjaGUgPSAkY2FjaGVGYWN0b3J5KCdjYWNoZUlkJyk7CiAqICBleHBlY3QoJGNhY2hlRmFjdG9yeS5nZXQoJ2NhY2hlSWQnKSkudG9CZShjYWNoZSk7CiAqICBleHBlY3QoJGNhY2hlRmFjdG9yeS5nZXQoJ25vU3VjaENhY2hlSWQnKSkubm90LnRvQmVEZWZpbmVkKCk7CiAqCiAqICBjYWNoZS5wdXQoImtleSIsICJ2YWx1ZSIpOwogKiAgY2FjaGUucHV0KCJhbm90aGVyIGtleSIsICJhbm90aGVyIHZhbHVlIik7CiAqCiAqICAvLyBXZSd2ZSBzcGVjaWZpZWQgbm8gb3B0aW9ucyBvbiBjcmVhdGlvbgogKiAgZXhwZWN0KGNhY2hlLmluZm8oKSkudG9FcXVhbCh7aWQ6ICdjYWNoZUlkJywgc2l6ZTogMn0pOwogKgogKiBgYGAKICoKICoKICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlSWQgTmFtZSBvciBpZCBvZiB0aGUgbmV3bHkgY3JlYXRlZCBjYWNoZS4KICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIE9wdGlvbnMgb2JqZWN0IHRoYXQgc3BlY2lmaWVzIHRoZSBjYWNoZSBiZWhhdmlvci4gUHJvcGVydGllczoKICoKICogICAtIGB7bnVtYmVyPX1gIGBjYXBhY2l0eWAg4oCUIHR1cm5zIHRoZSBjYWNoZSBpbnRvIExSVSBjYWNoZS4KICoKICogQHJldHVybnMge29iamVjdH0gTmV3bHkgY3JlYXRlZCBjYWNoZSBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHNldCBvZiBtZXRob2RzOgogKgogKiAtIGB7b2JqZWN0fWAgYGluZm8oKWAg4oCUIFJldHVybnMgaWQsIHNpemUsIGFuZCBvcHRpb25zIG9mIGNhY2hlLgogKiAtIGB7eyp9fWAgYHB1dCh7c3RyaW5nfSBrZXksIHsqfSB2YWx1ZSlgIOKAlCBQdXRzIGEgbmV3IGtleS12YWx1ZSBwYWlyIGludG8gdGhlIGNhY2hlIGFuZCByZXR1cm5zCiAqICAgaXQuCiAqIC0gYHt7Kn19YCBgZ2V0KHtzdHJpbmd9IGtleSlgIOKAlCBSZXR1cm5zIGNhY2hlZCB2YWx1ZSBmb3IgYGtleWAgb3IgdW5kZWZpbmVkIGZvciBjYWNoZSBtaXNzLgogKiAtIGB7dm9pZH1gIGByZW1vdmUoe3N0cmluZ30ga2V5KWAg4oCUIFJlbW92ZXMgYSBrZXktdmFsdWUgcGFpciBmcm9tIHRoZSBjYWNoZS4KICogLSBge3ZvaWR9YCBgcmVtb3ZlQWxsKClgIOKAlCBSZW1vdmVzIGFsbCBjYWNoZWQgdmFsdWVzLgogKiAtIGB7dm9pZH1gIGBkZXN0cm95KClgIOKAlCBSZW1vdmVzIHJlZmVyZW5jZXMgdG8gdGhpcyBjYWNoZSBmcm9tICRjYWNoZUZhY3RvcnkuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0iY2FjaGVFeGFtcGxlQXBwIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ2FjaGVDb250cm9sbGVyIj4KICAgICAgICAgPGlucHV0IG5nLW1vZGVsPSJuZXdDYWNoZUtleSIgcGxhY2Vob2xkZXI9IktleSI+CiAgICAgICAgIDxpbnB1dCBuZy1tb2RlbD0ibmV3Q2FjaGVWYWx1ZSIgcGxhY2Vob2xkZXI9IlZhbHVlIj4KICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0icHV0KG5ld0NhY2hlS2V5LCBuZXdDYWNoZVZhbHVlKSI+Q2FjaGU8L2J1dHRvbj4KCiAgICAgICAgIDxwIG5nLWlmPSJrZXlzLmxlbmd0aCI+Q2FjaGVkIFZhbHVlczwvcD4KICAgICAgICAgPGRpdiBuZy1yZXBlYXQ9ImtleSBpbiBrZXlzIj4KICAgICAgICAgICA8c3BhbiBuZy1iaW5kPSJrZXkiPjwvc3Bhbj4KICAgICAgICAgICA8c3Bhbj46IDwvc3Bhbj4KICAgICAgICAgICA8YiBuZy1iaW5kPSJjYWNoZS5nZXQoa2V5KSI+PC9iPgogICAgICAgICA8L2Rpdj4KCiAgICAgICAgIDxwPkNhY2hlIEluZm88L3A+CiAgICAgICAgIDxkaXYgbmctcmVwZWF0PSIoa2V5LCB2YWx1ZSkgaW4gY2FjaGUuaW5mbygpIj4KICAgICAgICAgICA8c3BhbiBuZy1iaW5kPSJrZXkiPjwvc3Bhbj4KICAgICAgICAgICA8c3Bhbj46IDwvc3Bhbj4KICAgICAgICAgICA8YiBuZy1iaW5kPSJ2YWx1ZSI+PC9iPgogICAgICAgICA8L2Rpdj4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgYW5ndWxhci5tb2R1bGUoJ2NhY2hlRXhhbXBsZUFwcCcsIFtdKS4KICAgICAgICAgY29udHJvbGxlcignQ2FjaGVDb250cm9sbGVyJywgWyckc2NvcGUnLCAnJGNhY2hlRmFjdG9yeScsIGZ1bmN0aW9uKCRzY29wZSwgJGNhY2hlRmFjdG9yeSkgewogICAgICAgICAgICRzY29wZS5rZXlzID0gW107CiAgICAgICAgICAgJHNjb3BlLmNhY2hlID0gJGNhY2hlRmFjdG9yeSgnY2FjaGVJZCcpOwogICAgICAgICAgICRzY29wZS5wdXQgPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICBpZiAoJHNjb3BlLmNhY2hlLmdldChrZXkpID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgJHNjb3BlLmtleXMucHVzaChrZXkpOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgJHNjb3BlLmNhY2hlLnB1dChrZXksIHZhbHVlID09PSB1bmRlZmluZWQgPyBudWxsIDogdmFsdWUpOwogICAgICAgICAgIH07CiAgICAgICAgIH1dKTsKICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgIHAgewogICAgICAgICBtYXJnaW46IDEwcHggMCAzcHg7CiAgICAgICB9CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwpmdW5jdGlvbiAkQ2FjaGVGYWN0b3J5UHJvdmlkZXIoKSB7CgogIHRoaXMuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGNhY2hlcyA9IHt9OwoKICAgIGZ1bmN0aW9uIGNhY2hlRmFjdG9yeShjYWNoZUlkLCBvcHRpb25zKSB7CiAgICAgIGlmIChjYWNoZUlkIGluIGNhY2hlcykgewogICAgICAgIHRocm93IG1pbkVycignJGNhY2hlRmFjdG9yeScpKCdpaWQnLCAiQ2FjaGVJZCAnezB9JyBpcyBhbHJlYWR5IHRha2VuISIsIGNhY2hlSWQpOwogICAgICB9CgogICAgICB2YXIgc2l6ZSA9IDAsCiAgICAgICAgICBzdGF0cyA9IGV4dGVuZCh7fSwgb3B0aW9ucywge2lkOiBjYWNoZUlkfSksCiAgICAgICAgICBkYXRhID0ge30sCiAgICAgICAgICBjYXBhY2l0eSA9IChvcHRpb25zICYmIG9wdGlvbnMuY2FwYWNpdHkpIHx8IE51bWJlci5NQVhfVkFMVUUsCiAgICAgICAgICBscnVIYXNoID0ge30sCiAgICAgICAgICBmcmVzaEVuZCA9IG51bGwsCiAgICAgICAgICBzdGFsZUVuZCA9IG51bGw7CgogICAgICAvKioKICAgICAgICogQG5nZG9jIHR5cGUKICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZQogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogQSBjYWNoZSBvYmplY3QgdXNlZCB0byBzdG9yZSBhbmQgcmV0cmlldmUgZGF0YSwgcHJpbWFyaWx5IHVzZWQgYnkKICAgICAgICoge0BsaW5rICRodHRwICRodHRwfSBhbmQgdGhlIHtAbGluayBuZy5kaXJlY3RpdmU6c2NyaXB0IHNjcmlwdH0gZGlyZWN0aXZlIHRvIGNhY2hlCiAgICAgICAqIHRlbXBsYXRlcyBhbmQgb3RoZXIgZGF0YS4KICAgICAgICoKICAgICAgICogYGBganMKICAgICAgICogIGFuZ3VsYXIubW9kdWxlKCdzdXBlckNhY2hlJykKICAgICAgICogICAgLmZhY3RvcnkoJ3N1cGVyQ2FjaGUnLCBbJyRjYWNoZUZhY3RvcnknLCBmdW5jdGlvbigkY2FjaGVGYWN0b3J5KSB7CiAgICAgICAqICAgICAgcmV0dXJuICRjYWNoZUZhY3RvcnkoJ3N1cGVyLWNhY2hlJyk7CiAgICAgICAqICAgIH1dKTsKICAgICAgICogYGBgCiAgICAgICAqCiAgICAgICAqIEV4YW1wbGUgdGVzdDoKICAgICAgICoKICAgICAgICogYGBganMKICAgICAgICogIGl0KCdzaG91bGQgYmVoYXZlIGxpa2UgYSBjYWNoZScsIGluamVjdChmdW5jdGlvbihzdXBlckNhY2hlKSB7CiAgICAgICAqICAgIHN1cGVyQ2FjaGUucHV0KCdrZXknLCAndmFsdWUnKTsKICAgICAgICogICAgc3VwZXJDYWNoZS5wdXQoJ2Fub3RoZXIga2V5JywgJ2Fub3RoZXIgdmFsdWUnKTsKICAgICAgICoKICAgICAgICogICAgZXhwZWN0KHN1cGVyQ2FjaGUuaW5mbygpKS50b0VxdWFsKHsKICAgICAgICogICAgICBpZDogJ3N1cGVyLWNhY2hlJywKICAgICAgICogICAgICBzaXplOiAyCiAgICAgICAqICAgIH0pOwogICAgICAgKgogICAgICAgKiAgICBzdXBlckNhY2hlLnJlbW92ZSgnYW5vdGhlciBrZXknKTsKICAgICAgICogICAgZXhwZWN0KHN1cGVyQ2FjaGUuZ2V0KCdhbm90aGVyIGtleScpKS50b0JlVW5kZWZpbmVkKCk7CiAgICAgICAqCiAgICAgICAqICAgIHN1cGVyQ2FjaGUucmVtb3ZlQWxsKCk7CiAgICAgICAqICAgIGV4cGVjdChzdXBlckNhY2hlLmluZm8oKSkudG9FcXVhbCh7CiAgICAgICAqICAgICAgaWQ6ICdzdXBlci1jYWNoZScsCiAgICAgICAqICAgICAgc2l6ZTogMAogICAgICAgKiAgICB9KTsKICAgICAgICogIH0pKTsKICAgICAgICogYGBgCiAgICAgICAqLwogICAgICByZXR1cm4gY2FjaGVzW2NhY2hlSWRdID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZSNwdXQKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogSW5zZXJ0cyBhIG5hbWVkIGVudHJ5IGludG8gdGhlIHtAbGluayAkY2FjaGVGYWN0b3J5LkNhY2hlIENhY2hlfSBvYmplY3QgdG8gYmUKICAgICAgICAgKiByZXRyaWV2ZWQgbGF0ZXIsIGFuZCBpbmNyZW1lbnRpbmcgdGhlIHNpemUgb2YgdGhlIGNhY2hlIGlmIHRoZSBrZXkgd2FzIG5vdCBhbHJlYWR5CiAgICAgICAgICogcHJlc2VudCBpbiB0aGUgY2FjaGUuIElmIGJlaGF2aW5nIGxpa2UgYW4gTFJVIGNhY2hlLCBpdCB3aWxsIGFsc28gcmVtb3ZlIHN0YWxlCiAgICAgICAgICogZW50cmllcyBmcm9tIHRoZSBzZXQuCiAgICAgICAgICoKICAgICAgICAgKiBJdCB3aWxsIG5vdCBpbnNlcnQgdW5kZWZpbmVkIHZhbHVlcyBpbnRvIHRoZSBjYWNoZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgdGhlIGtleSB1bmRlciB3aGljaCB0aGUgY2FjaGVkIGRhdGEgaXMgc3RvcmVkLgogICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgdGhlIHZhbHVlIHRvIHN0b3JlIGFsb25nc2lkZSB0aGUga2V5LiBJZiBpdCBpcyB1bmRlZmluZWQsIHRoZSBrZXkKICAgICAgICAgKiAgICB3aWxsIG5vdCBiZSBzdG9yZWQuCiAgICAgICAgICogQHJldHVybnMgeyp9IHRoZSB2YWx1ZSBzdG9yZWQuCiAgICAgICAgICovCiAgICAgICAgcHV0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICBpZiAoY2FwYWNpdHkgPCBOdW1iZXIuTUFYX1ZBTFVFKSB7CiAgICAgICAgICAgIHZhciBscnVFbnRyeSA9IGxydUhhc2hba2V5XSB8fCAobHJ1SGFzaFtrZXldID0ge2tleToga2V5fSk7CgogICAgICAgICAgICByZWZyZXNoKGxydUVudHJ5KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSByZXR1cm47CiAgICAgICAgICBpZiAoIShrZXkgaW4gZGF0YSkpIHNpemUrKzsKICAgICAgICAgIGRhdGFba2V5XSA9IHZhbHVlOwoKICAgICAgICAgIGlmIChzaXplID4gY2FwYWNpdHkpIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmUoc3RhbGVFbmQua2V5KTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUjZ2V0CiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJldHJpZXZlcyBuYW1lZCBkYXRhIHN0b3JlZCBpbiB0aGUge0BsaW5rICRjYWNoZUZhY3RvcnkuQ2FjaGUgQ2FjaGV9IG9iamVjdC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgdGhlIGtleSBvZiB0aGUgZGF0YSB0byBiZSByZXRyaWV2ZWQKICAgICAgICAgKiBAcmV0dXJucyB7Kn0gdGhlIHZhbHVlIHN0b3JlZC4KICAgICAgICAgKi8KICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgaWYgKGNhcGFjaXR5IDwgTnVtYmVyLk1BWF9WQUxVRSkgewogICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICByZWZyZXNoKGxydUVudHJ5KTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZGF0YVtrZXldOwogICAgICAgIH0sCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZSNyZW1vdmUKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogUmVtb3ZlcyBhbiBlbnRyeSBmcm9tIHRoZSB7QGxpbmsgJGNhY2hlRmFjdG9yeS5DYWNoZSBDYWNoZX0gb2JqZWN0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSB0aGUga2V5IG9mIHRoZSBlbnRyeSB0byBiZSByZW1vdmVkCiAgICAgICAgICovCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGlmIChjYXBhY2l0eSA8IE51bWJlci5NQVhfVkFMVUUpIHsKICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldOwoKICAgICAgICAgICAgaWYgKCFscnVFbnRyeSkgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKGxydUVudHJ5ID09IGZyZXNoRW5kKSBmcmVzaEVuZCA9IGxydUVudHJ5LnA7CiAgICAgICAgICAgIGlmIChscnVFbnRyeSA9PSBzdGFsZUVuZCkgc3RhbGVFbmQgPSBscnVFbnRyeS5uOwogICAgICAgICAgICBsaW5rKGxydUVudHJ5Lm4sbHJ1RW50cnkucCk7CgogICAgICAgICAgICBkZWxldGUgbHJ1SGFzaFtrZXldOwogICAgICAgICAgfQoKICAgICAgICAgIGRlbGV0ZSBkYXRhW2tleV07CiAgICAgICAgICBzaXplLS07CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5LkNhY2hlI3JlbW92ZUFsbAogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDbGVhcnMgdGhlIGNhY2hlIG9iamVjdCBvZiBhbnkgZW50cmllcy4KICAgICAgICAgKi8KICAgICAgICByZW1vdmVBbGw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgZGF0YSA9IHt9OwogICAgICAgICAgc2l6ZSA9IDA7CiAgICAgICAgICBscnVIYXNoID0ge307CiAgICAgICAgICBmcmVzaEVuZCA9IHN0YWxlRW5kID0gbnVsbDsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUjZGVzdHJveQogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBEZXN0cm95cyB0aGUge0BsaW5rICRjYWNoZUZhY3RvcnkuQ2FjaGUgQ2FjaGV9IG9iamVjdCBlbnRpcmVseSwKICAgICAgICAgKiByZW1vdmluZyBpdCBmcm9tIHRoZSB7QGxpbmsgJGNhY2hlRmFjdG9yeSAkY2FjaGVGYWN0b3J5fSBzZXQuCiAgICAgICAgICovCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICBkYXRhID0gbnVsbDsKICAgICAgICAgIHN0YXRzID0gbnVsbDsKICAgICAgICAgIGxydUhhc2ggPSBudWxsOwogICAgICAgICAgZGVsZXRlIGNhY2hlc1tjYWNoZUlkXTsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUjaW5mbwogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZXRyaWV2ZSBpbmZvcm1hdGlvbiByZWdhcmRpbmcgYSBwYXJ0aWN1bGFyIHtAbGluayAkY2FjaGVGYWN0b3J5LkNhY2hlIENhY2hlfS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtvYmplY3R9IGFuIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczoKICAgICAgICAgKiAgIDx1bD4KICAgICAgICAgKiAgICAgPGxpPioqaWQqKjogdGhlIGlkIG9mIHRoZSBjYWNoZSBpbnN0YW5jZTwvbGk+CiAgICAgICAgICogICAgIDxsaT4qKnNpemUqKjogdGhlIG51bWJlciBvZiBlbnRyaWVzIGtlcHQgaW4gdGhlIGNhY2hlIGluc3RhbmNlPC9saT4KICAgICAgICAgKiAgICAgPGxpPioqLi4uKio6IGFueSBhZGRpdGlvbmFsIHByb3BlcnRpZXMgZnJvbSB0aGUgb3B0aW9ucyBvYmplY3Qgd2hlbiBjcmVhdGluZyB0aGUKICAgICAgICAgKiAgICAgICBjYWNoZS48L2xpPgogICAgICAgICAqICAgPC91bD4KICAgICAgICAgKi8KICAgICAgICBpbmZvOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBleHRlbmQoe30sIHN0YXRzLCB7c2l6ZTogc2l6ZX0pOwogICAgICAgIH0KICAgICAgfTsKCgogICAgICAvKioKICAgICAgICogbWFrZXMgdGhlIGBlbnRyeWAgdGhlIGZyZXNoRW5kIG9mIHRoZSBMUlUgbGlua2VkIGxpc3QKICAgICAgICovCiAgICAgIGZ1bmN0aW9uIHJlZnJlc2goZW50cnkpIHsKICAgICAgICBpZiAoZW50cnkgIT0gZnJlc2hFbmQpIHsKICAgICAgICAgIGlmICghc3RhbGVFbmQpIHsKICAgICAgICAgICAgc3RhbGVFbmQgPSBlbnRyeTsKICAgICAgICAgIH0gZWxzZSBpZiAoc3RhbGVFbmQgPT0gZW50cnkpIHsKICAgICAgICAgICAgc3RhbGVFbmQgPSBlbnRyeS5uOwogICAgICAgICAgfQoKICAgICAgICAgIGxpbmsoZW50cnkubiwgZW50cnkucCk7CiAgICAgICAgICBsaW5rKGVudHJ5LCBmcmVzaEVuZCk7CiAgICAgICAgICBmcmVzaEVuZCA9IGVudHJ5OwogICAgICAgICAgZnJlc2hFbmQubiA9IG51bGw7CiAgICAgICAgfQogICAgICB9CgoKICAgICAgLyoqCiAgICAgICAqIGJpZGlyZWN0aW9uYWxseSBsaW5rcyB0d28gZW50cmllcyBvZiB0aGUgTFJVIGxpbmtlZCBsaXN0CiAgICAgICAqLwogICAgICBmdW5jdGlvbiBsaW5rKG5leHRFbnRyeSwgcHJldkVudHJ5KSB7CiAgICAgICAgaWYgKG5leHRFbnRyeSAhPSBwcmV2RW50cnkpIHsKICAgICAgICAgIGlmIChuZXh0RW50cnkpIG5leHRFbnRyeS5wID0gcHJldkVudHJ5OyAvL3Agc3RhbmRzIGZvciBwcmV2aW91cywgJ3ByZXYnIGRpZG4ndCBtaW5pZnkKICAgICAgICAgIGlmIChwcmV2RW50cnkpIHByZXZFbnRyeS5uID0gbmV4dEVudHJ5OyAvL24gc3RhbmRzIGZvciBuZXh0LCAnbmV4dCcgZGlkbid0IG1pbmlmeQogICAgICAgIH0KICAgICAgfQogICAgfQoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRjYWNoZUZhY3RvcnkjaW5mbwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogR2V0IGluZm9ybWF0aW9uIGFib3V0IGFsbCB0aGUgY2FjaGVzIHRoYXQgaGF2ZSBiZWVuIGNyZWF0ZWQKICAgKgogICAqIEByZXR1cm5zIHtPYmplY3R9IC0ga2V5LXZhbHVlIG1hcCBvZiBgY2FjaGVJZGAgdG8gdGhlIHJlc3VsdCBvZiBjYWxsaW5nIGBjYWNoZSNpbmZvYAogICAqLwogICAgY2FjaGVGYWN0b3J5LmluZm8gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGluZm8gPSB7fTsKICAgICAgZm9yRWFjaChjYWNoZXMsIGZ1bmN0aW9uKGNhY2hlLCBjYWNoZUlkKSB7CiAgICAgICAgaW5mb1tjYWNoZUlkXSA9IGNhY2hlLmluZm8oKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBpbmZvOwogICAgfTsKCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5I2dldAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogR2V0IGFjY2VzcyB0byBhIGNhY2hlIG9iamVjdCBieSB0aGUgYGNhY2hlSWRgIHVzZWQgd2hlbiBpdCB3YXMgY3JlYXRlZC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZUlkIE5hbWUgb3IgaWQgb2YgYSBjYWNoZSB0byBhY2Nlc3MuCiAgICogQHJldHVybnMge29iamVjdH0gQ2FjaGUgb2JqZWN0IGlkZW50aWZpZWQgYnkgdGhlIGNhY2hlSWQgb3IgdW5kZWZpbmVkIGlmIG5vIHN1Y2ggY2FjaGUuCiAgICovCiAgICBjYWNoZUZhY3RvcnkuZ2V0ID0gZnVuY3Rpb24oY2FjaGVJZCkgewogICAgICByZXR1cm4gY2FjaGVzW2NhY2hlSWRdOwogICAgfTsKCgogICAgcmV0dXJuIGNhY2hlRmFjdG9yeTsKICB9Owp9CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHRlbXBsYXRlQ2FjaGUKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBmaXJzdCB0aW1lIGEgdGVtcGxhdGUgaXMgdXNlZCwgaXQgaXMgbG9hZGVkIGluIHRoZSB0ZW1wbGF0ZSBjYWNoZSBmb3IgcXVpY2sgcmV0cmlldmFsLiBZb3UKICogY2FuIGxvYWQgdGVtcGxhdGVzIGRpcmVjdGx5IGludG8gdGhlIGNhY2hlIGluIGEgYHNjcmlwdGAgdGFnLCBvciBieSBjb25zdW1pbmcgdGhlCiAqIGAkdGVtcGxhdGVDYWNoZWAgc2VydmljZSBkaXJlY3RseS4KICoKICogQWRkaW5nIHZpYSB0aGUgYHNjcmlwdGAgdGFnOgogKgogKiBgYGBodG1sCiAqICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGVJZC5odG1sIj4KICogICAgIDxwPlRoaXMgaXMgdGhlIGNvbnRlbnQgb2YgdGhlIHRlbXBsYXRlPC9wPgogKiAgIDwvc2NyaXB0PgogKiBgYGAKICoKICogKipOb3RlOioqIHRoZSBgc2NyaXB0YCB0YWcgY29udGFpbmluZyB0aGUgdGVtcGxhdGUgZG9lcyBub3QgbmVlZCB0byBiZSBpbmNsdWRlZCBpbiB0aGUgYGhlYWRgIG9mCiAqIHRoZSBkb2N1bWVudCwgYnV0IGl0IG11c3QgYmUgYmVsb3cgdGhlIGBuZy1hcHBgIGRlZmluaXRpb24uCiAqCiAqIEFkZGluZyB2aWEgdGhlICR0ZW1wbGF0ZUNhY2hlIHNlcnZpY2U6CiAqCiAqIGBgYGpzCiAqIHZhciBteUFwcCA9IGFuZ3VsYXIubW9kdWxlKCdteUFwcCcsIFtdKTsKICogbXlBcHAucnVuKGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CiAqICAgJHRlbXBsYXRlQ2FjaGUucHV0KCd0ZW1wbGF0ZUlkLmh0bWwnLCAnVGhpcyBpcyB0aGUgY29udGVudCBvZiB0aGUgdGVtcGxhdGUnKTsKICogfSk7CiAqIGBgYAogKgogKiBUbyByZXRyaWV2ZSB0aGUgdGVtcGxhdGUgbGF0ZXIsIHNpbXBseSB1c2UgaXQgaW4geW91ciBIVE1MOgogKiBgYGBodG1sCiAqIDxkaXYgbmctaW5jbHVkZT0iICd0ZW1wbGF0ZUlkLmh0bWwnICI+PC9kaXY+CiAqIGBgYAogKgogKiBvciBnZXQgaXQgdmlhIEphdmFzY3JpcHQ6CiAqIGBgYGpzCiAqICR0ZW1wbGF0ZUNhY2hlLmdldCgndGVtcGxhdGVJZC5odG1sJykKICogYGBgCiAqCiAqIFNlZSB7QGxpbmsgbmcuJGNhY2hlRmFjdG9yeSAkY2FjaGVGYWN0b3J5fS4KICoKICovCmZ1bmN0aW9uICRUZW1wbGF0ZUNhY2hlUHJvdmlkZXIoKSB7CiAgdGhpcy4kZ2V0ID0gWyckY2FjaGVGYWN0b3J5JywgZnVuY3Rpb24oJGNhY2hlRmFjdG9yeSkgewogICAgcmV0dXJuICRjYWNoZUZhY3RvcnkoJ3RlbXBsYXRlcycpOwogIH1dOwp9CgovKiAhIFZBUklBQkxFL0ZVTkNUSU9OIE5BTUlORyBDT05WRU5USU9OUyBUSEFUIEFQUExZIFRPIFRISVMgRklMRSEKICoKICogRE9NLXJlbGF0ZWQgdmFyaWFibGVzOgogKgogKiAtICJub2RlIiAtIERPTSBOb2RlCiAqIC0gImVsZW1lbnQiIC0gRE9NIEVsZW1lbnQgb3IgTm9kZQogKiAtICIkbm9kZSIgb3IgIiRlbGVtZW50IiAtIGpxTGl0ZS13cmFwcGVkIG5vZGUgb3IgZWxlbWVudAogKgogKgogKiBDb21waWxlciByZWxhdGVkIHN0dWZmOgogKgogKiAtICJsaW5rRm4iIC0gbGlua2luZyBmbiBvZiBhIHNpbmdsZSBkaXJlY3RpdmUKICogLSAibm9kZUxpbmtGbiIgLSBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBhIHBhcnRpY3VsYXIgbm9kZQogKiAtICJjaGlsZExpbmtGbiIgLSAgZnVuY3Rpb24gdGhhdCBhZ2dyZWdhdGVzIGFsbCBsaW5raW5nIGZucyBmb3IgY2hpbGQgbm9kZXMgb2YgYSBwYXJ0aWN1bGFyIG5vZGUKICogLSAiY29tcG9zaXRlTGlua0ZuIiAtIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGEgY29tcGlsYXRpb24gcm9vdCAobm9kZUxpc3QpCiAqLwoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkY29tcGlsZQogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ29tcGlsZXMgYW4gSFRNTCBzdHJpbmcgb3IgRE9NIGludG8gYSB0ZW1wbGF0ZSBhbmQgcHJvZHVjZXMgYSB0ZW1wbGF0ZSBmdW5jdGlvbiwgd2hpY2gKICogY2FuIHRoZW4gYmUgdXNlZCB0byBsaW5rIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIGBzY29wZWB9IGFuZCB0aGUgdGVtcGxhdGUgdG9nZXRoZXIuCiAqCiAqIFRoZSBjb21waWxhdGlvbiBpcyBhIHByb2Nlc3Mgb2Ygd2Fsa2luZyB0aGUgRE9NIHRyZWUgYW5kIG1hdGNoaW5nIERPTSBlbGVtZW50cyB0bwogKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30uCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKk5vdGU6KiogVGhpcyBkb2N1bWVudCBpcyBhbiBpbi1kZXB0aCByZWZlcmVuY2Ugb2YgYWxsIGRpcmVjdGl2ZSBvcHRpb25zLgogKiBGb3IgYSBnZW50bGUgaW50cm9kdWN0aW9uIHRvIGRpcmVjdGl2ZXMgd2l0aCBleGFtcGxlcyBvZiBjb21tb24gdXNlIGNhc2VzLAogKiBzZWUgdGhlIHtAbGluayBndWlkZS9kaXJlY3RpdmUgZGlyZWN0aXZlIGd1aWRlfS4KICogPC9kaXY+CiAqCiAqICMjIENvbXByZWhlbnNpdmUgRGlyZWN0aXZlIEFQSQogKgogKiBUaGVyZSBhcmUgbWFueSBkaWZmZXJlbnQgb3B0aW9ucyBmb3IgYSBkaXJlY3RpdmUuCiAqCiAqIFRoZSBkaWZmZXJlbmNlIHJlc2lkZXMgaW4gdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZmFjdG9yeSBmdW5jdGlvbi4KICogWW91IGNhbiBlaXRoZXIgcmV0dXJuIGEgIkRpcmVjdGl2ZSBEZWZpbml0aW9uIE9iamVjdCIgKHNlZSBiZWxvdykgdGhhdCBkZWZpbmVzIHRoZSBkaXJlY3RpdmUgcHJvcGVydGllcywKICogb3IganVzdCB0aGUgYHBvc3RMaW5rYCBmdW5jdGlvbiAoYWxsIG90aGVyIHByb3BlcnRpZXMgd2lsbCBoYXZlIHRoZSBkZWZhdWx0IHZhbHVlcykuCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXN1Y2Nlc3MiPgogKiAqKkJlc3QgUHJhY3RpY2U6KiogSXQncyByZWNvbW1lbmRlZCB0byB1c2UgdGhlICJkaXJlY3RpdmUgZGVmaW5pdGlvbiBvYmplY3QiIGZvcm0uCiAqIDwvZGl2PgogKgogKiBIZXJlJ3MgYW4gZXhhbXBsZSBkaXJlY3RpdmUgZGVjbGFyZWQgd2l0aCBhIERpcmVjdGl2ZSBEZWZpbml0aW9uIE9iamVjdDoKICoKICogYGBganMKICogICB2YXIgbXlNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSguLi4pOwogKgogKiAgIG15TW9kdWxlLmRpcmVjdGl2ZSgnZGlyZWN0aXZlTmFtZScsIGZ1bmN0aW9uIGZhY3RvcnkoaW5qZWN0YWJsZXMpIHsKICogICAgIHZhciBkaXJlY3RpdmVEZWZpbml0aW9uT2JqZWN0ID0gewogKiAgICAgICBwcmlvcml0eTogMCwKICogICAgICAgdGVtcGxhdGU6ICc8ZGl2PjwvZGl2PicsIC8vIG9yIC8vIGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsgLi4uIH0sCiAqICAgICAgIC8vIG9yCiAqICAgICAgIC8vIHRlbXBsYXRlVXJsOiAnZGlyZWN0aXZlLmh0bWwnLCAvLyBvciAvLyBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7IC4uLiB9LAogKiAgICAgICB0cmFuc2NsdWRlOiBmYWxzZSwKICogICAgICAgcmVzdHJpY3Q6ICdBJywKICogICAgICAgdGVtcGxhdGVOYW1lc3BhY2U6ICdodG1sJywKICogICAgICAgc2NvcGU6IGZhbHNlLAogKiAgICAgICBjb250cm9sbGVyOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsICR0cmFuc2NsdWRlLCBvdGhlckluamVjdGFibGVzKSB7IC4uLiB9LAogKiAgICAgICBjb250cm9sbGVyQXM6ICdzdHJpbmdBbGlhcycsCiAqICAgICAgIHJlcXVpcmU6ICdzaWJsaW5nRGlyZWN0aXZlTmFtZScsIC8vIG9yIC8vIFsnXnBhcmVudERpcmVjdGl2ZU5hbWUnLCAnP29wdGlvbmFsRGlyZWN0aXZlTmFtZScsICc/Xm9wdGlvbmFsUGFyZW50J10sCiAqICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIGNvbXBpbGUodEVsZW1lbnQsIHRBdHRycywgdHJhbnNjbHVkZSkgewogKiAgICAgICAgIHJldHVybiB7CiAqICAgICAgICAgICBwcmU6IGZ1bmN0aW9uIHByZUxpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMsIGNvbnRyb2xsZXIpIHsgLi4uIH0sCiAqICAgICAgICAgICBwb3N0OiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycywgY29udHJvbGxlcikgeyAuLi4gfQogKiAgICAgICAgIH0KICogICAgICAgICAvLyBvcgogKiAgICAgICAgIC8vIHJldHVybiBmdW5jdGlvbiBwb3N0TGluayggLi4uICkgeyAuLi4gfQogKiAgICAgICB9LAogKiAgICAgICAvLyBvcgogKiAgICAgICAvLyBsaW5rOiB7CiAqICAgICAgIC8vICBwcmU6IGZ1bmN0aW9uIHByZUxpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMsIGNvbnRyb2xsZXIpIHsgLi4uIH0sCiAqICAgICAgIC8vICBwb3N0OiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycywgY29udHJvbGxlcikgeyAuLi4gfQogKiAgICAgICAvLyB9CiAqICAgICAgIC8vIG9yCiAqICAgICAgIC8vIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKCAuLi4gKSB7IC4uLiB9CiAqICAgICB9OwogKiAgICAgcmV0dXJuIGRpcmVjdGl2ZURlZmluaXRpb25PYmplY3Q7CiAqICAgfSk7CiAqIGBgYAogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlOioqIEFueSB1bnNwZWNpZmllZCBvcHRpb25zIHdpbGwgdXNlIHRoZSBkZWZhdWx0IHZhbHVlLiBZb3UgY2FuIHNlZSB0aGUgZGVmYXVsdCB2YWx1ZXMgYmVsb3cuCiAqIDwvZGl2PgogKgogKiBUaGVyZWZvcmUgdGhlIGFib3ZlIGNhbiBiZSBzaW1wbGlmaWVkIGFzOgogKgogKiBgYGBqcwogKiAgIHZhciBteU1vZHVsZSA9IGFuZ3VsYXIubW9kdWxlKC4uLik7CiAqCiAqICAgbXlNb2R1bGUuZGlyZWN0aXZlKCdkaXJlY3RpdmVOYW1lJywgZnVuY3Rpb24gZmFjdG9yeShpbmplY3RhYmxlcykgewogKiAgICAgdmFyIGRpcmVjdGl2ZURlZmluaXRpb25PYmplY3QgPSB7CiAqICAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzKSB7IC4uLiB9CiAqICAgICB9OwogKiAgICAgcmV0dXJuIGRpcmVjdGl2ZURlZmluaXRpb25PYmplY3Q7CiAqICAgICAvLyBvcgogKiAgICAgLy8gcmV0dXJuIGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzKSB7IC4uLiB9CiAqICAgfSk7CiAqIGBgYAogKgogKgogKgogKiAjIyMgRGlyZWN0aXZlIERlZmluaXRpb24gT2JqZWN0CiAqCiAqIFRoZSBkaXJlY3RpdmUgZGVmaW5pdGlvbiBvYmplY3QgcHJvdmlkZXMgaW5zdHJ1Y3Rpb25zIHRvIHRoZSB7QGxpbmsgbmcuJGNvbXBpbGUKICogY29tcGlsZXJ9LiBUaGUgYXR0cmlidXRlcyBhcmU6CiAqCiAqICMjIyMgYG11bHRpRWxlbWVudGAKICogV2hlbiB0aGlzIHByb3BlcnR5IGlzIHNldCB0byB0cnVlLCB0aGUgSFRNTCBjb21waWxlciB3aWxsIGNvbGxlY3QgRE9NIG5vZGVzIGJldHdlZW4KICogbm9kZXMgd2l0aCB0aGUgYXR0cmlidXRlcyBgZGlyZWN0aXZlLW5hbWUtc3RhcnRgIGFuZCBgZGlyZWN0aXZlLW5hbWUtZW5kYCwgYW5kIGdyb3VwIHRoZW0KICogdG9nZXRoZXIgYXMgdGhlIGRpcmVjdGl2ZSBlbGVtZW50cy4gSXQgaXMgcmVjb21lbmRlZCB0aGF0IHRoaXMgZmVhdHVyZSBiZSB1c2VkIG9uIGRpcmVjdGl2ZXMKICogd2hpY2ggYXJlIG5vdCBzdHJpY3RseSBiZWhhdmlvdXJhbCAoc3VjaCBhcyB7QGxpbmsgbmdDbGlja30pLCBhbmQgd2hpY2gKICogZG8gbm90IG1hbmlwdWxhdGUgb3IgcmVwbGFjZSBjaGlsZCBub2RlcyAoc3VjaCBhcyB7QGxpbmsgbmdJbmNsdWRlfSkuCiAqCiAqICMjIyMgYHByaW9yaXR5YAogKiBXaGVuIHRoZXJlIGFyZSBtdWx0aXBsZSBkaXJlY3RpdmVzIGRlZmluZWQgb24gYSBzaW5nbGUgRE9NIGVsZW1lbnQsIHNvbWV0aW1lcyBpdAogKiBpcyBuZWNlc3NhcnkgdG8gc3BlY2lmeSB0aGUgb3JkZXIgaW4gd2hpY2ggdGhlIGRpcmVjdGl2ZXMgYXJlIGFwcGxpZWQuIFRoZSBgcHJpb3JpdHlgIGlzIHVzZWQKICogdG8gc29ydCB0aGUgZGlyZWN0aXZlcyBiZWZvcmUgdGhlaXIgYGNvbXBpbGVgIGZ1bmN0aW9ucyBnZXQgY2FsbGVkLiBQcmlvcml0eSBpcyBkZWZpbmVkIGFzIGEKICogbnVtYmVyLiBEaXJlY3RpdmVzIHdpdGggZ3JlYXRlciBudW1lcmljYWwgYHByaW9yaXR5YCBhcmUgY29tcGlsZWQgZmlyc3QuIFByZS1saW5rIGZ1bmN0aW9ucwogKiBhcmUgYWxzbyBydW4gaW4gcHJpb3JpdHkgb3JkZXIsIGJ1dCBwb3N0LWxpbmsgZnVuY3Rpb25zIGFyZSBydW4gaW4gcmV2ZXJzZSBvcmRlci4gVGhlIG9yZGVyCiAqIG9mIGRpcmVjdGl2ZXMgd2l0aCB0aGUgc2FtZSBwcmlvcml0eSBpcyB1bmRlZmluZWQuIFRoZSBkZWZhdWx0IHByaW9yaXR5IGlzIGAwYC4KICoKICogIyMjIyBgdGVybWluYWxgCiAqIElmIHNldCB0byB0cnVlIHRoZW4gdGhlIGN1cnJlbnQgYHByaW9yaXR5YCB3aWxsIGJlIHRoZSBsYXN0IHNldCBvZiBkaXJlY3RpdmVzCiAqIHdoaWNoIHdpbGwgZXhlY3V0ZSAoYW55IGRpcmVjdGl2ZXMgYXQgdGhlIGN1cnJlbnQgcHJpb3JpdHkgd2lsbCBzdGlsbCBleGVjdXRlCiAqIGFzIHRoZSBvcmRlciBvZiBleGVjdXRpb24gb24gc2FtZSBgcHJpb3JpdHlgIGlzIHVuZGVmaW5lZCkuIE5vdGUgdGhhdCBleHByZXNzaW9ucwogKiBhbmQgb3RoZXIgZGlyZWN0aXZlcyB1c2VkIGluIHRoZSBkaXJlY3RpdmUncyB0ZW1wbGF0ZSB3aWxsIGFsc28gYmUgZXhjbHVkZWQgZnJvbSBleGVjdXRpb24uCiAqCiAqICMjIyMgYHNjb3BlYAogKiAqKklmIHNldCB0byBgdHJ1ZWAsKiogdGhlbiBhIG5ldyBzY29wZSB3aWxsIGJlIGNyZWF0ZWQgZm9yIHRoaXMgZGlyZWN0aXZlLiBJZiBtdWx0aXBsZSBkaXJlY3RpdmVzIG9uIHRoZQogKiBzYW1lIGVsZW1lbnQgcmVxdWVzdCBhIG5ldyBzY29wZSwgb25seSBvbmUgbmV3IHNjb3BlIGlzIGNyZWF0ZWQuIFRoZSBuZXcgc2NvcGUgcnVsZSBkb2VzIG5vdAogKiBhcHBseSBmb3IgdGhlIHJvb3Qgb2YgdGhlIHRlbXBsYXRlIHNpbmNlIHRoZSByb290IG9mIHRoZSB0ZW1wbGF0ZSBhbHdheXMgZ2V0cyBhIG5ldyBzY29wZS4KICoKICogKipJZiBzZXQgdG8gYHt9YCAob2JqZWN0IGhhc2gpLCoqIHRoZW4gYSBuZXcgImlzb2xhdGUiIHNjb3BlIGlzIGNyZWF0ZWQuIFRoZSAnaXNvbGF0ZScgc2NvcGUgZGlmZmVycyBmcm9tCiAqIG5vcm1hbCBzY29wZSBpbiB0aGF0IGl0IGRvZXMgbm90IHByb3RvdHlwaWNhbGx5IGluaGVyaXQgZnJvbSB0aGUgcGFyZW50IHNjb3BlLiBUaGlzIGlzIHVzZWZ1bAogKiB3aGVuIGNyZWF0aW5nIHJldXNhYmxlIGNvbXBvbmVudHMsIHdoaWNoIHNob3VsZCBub3QgYWNjaWRlbnRhbGx5IHJlYWQgb3IgbW9kaWZ5IGRhdGEgaW4gdGhlCiAqIHBhcmVudCBzY29wZS4KICoKICogVGhlICdpc29sYXRlJyBzY29wZSB0YWtlcyBhbiBvYmplY3QgaGFzaCB3aGljaCBkZWZpbmVzIGEgc2V0IG9mIGxvY2FsIHNjb3BlIHByb3BlcnRpZXMKICogZGVyaXZlZCBmcm9tIHRoZSBwYXJlbnQgc2NvcGUuIFRoZXNlIGxvY2FsIHByb3BlcnRpZXMgYXJlIHVzZWZ1bCBmb3IgYWxpYXNpbmcgdmFsdWVzIGZvcgogKiB0ZW1wbGF0ZXMuIExvY2FscyBkZWZpbml0aW9uIGlzIGEgaGFzaCBvZiBsb2NhbCBzY29wZSBwcm9wZXJ0eSB0byBpdHMgc291cmNlOgogKgogKiAqIGBAYCBvciBgQGF0dHJgIC0gYmluZCBhIGxvY2FsIHNjb3BlIHByb3BlcnR5IHRvIHRoZSB2YWx1ZSBvZiBET00gYXR0cmlidXRlLiBUaGUgcmVzdWx0IGlzCiAqICAgYWx3YXlzIGEgc3RyaW5nIHNpbmNlIERPTSBhdHRyaWJ1dGVzIGFyZSBzdHJpbmdzLiBJZiBubyBgYXR0cmAgbmFtZSBpcyBzcGVjaWZpZWQgIHRoZW4gdGhlCiAqICAgYXR0cmlidXRlIG5hbWUgaXMgYXNzdW1lZCB0byBiZSB0aGUgc2FtZSBhcyB0aGUgbG9jYWwgbmFtZS4KICogICBHaXZlbiBgPHdpZGdldCBteS1hdHRyPSJoZWxsbyB7e25hbWV9fSI+YCBhbmQgd2lkZ2V0IGRlZmluaXRpb24KICogICBvZiBgc2NvcGU6IHsgbG9jYWxOYW1lOidAbXlBdHRyJyB9YCwgdGhlbiB3aWRnZXQgc2NvcGUgcHJvcGVydHkgYGxvY2FsTmFtZWAgd2lsbCByZWZsZWN0CiAqICAgdGhlIGludGVycG9sYXRlZCB2YWx1ZSBvZiBgaGVsbG8ge3tuYW1lfX1gLiBBcyB0aGUgYG5hbWVgIGF0dHJpYnV0ZSBjaGFuZ2VzIHNvIHdpbGwgdGhlCiAqICAgYGxvY2FsTmFtZWAgcHJvcGVydHkgb24gdGhlIHdpZGdldCBzY29wZS4gVGhlIGBuYW1lYCBpcyByZWFkIGZyb20gdGhlIHBhcmVudCBzY29wZSAobm90CiAqICAgY29tcG9uZW50IHNjb3BlKS4KICoKICogKiBgPWAgb3IgYD1hdHRyYCAtIHNldCB1cCBiaS1kaXJlY3Rpb25hbCBiaW5kaW5nIGJldHdlZW4gYSBsb2NhbCBzY29wZSBwcm9wZXJ0eSBhbmQgdGhlCiAqICAgcGFyZW50IHNjb3BlIHByb3BlcnR5IG9mIG5hbWUgZGVmaW5lZCB2aWEgdGhlIHZhbHVlIG9mIHRoZSBgYXR0cmAgYXR0cmlidXRlLiBJZiBubyBgYXR0cmAKICogICBuYW1lIGlzIHNwZWNpZmllZCB0aGVuIHRoZSBhdHRyaWJ1dGUgbmFtZSBpcyBhc3N1bWVkIHRvIGJlIHRoZSBzYW1lIGFzIHRoZSBsb2NhbCBuYW1lLgogKiAgIEdpdmVuIGA8d2lkZ2V0IG15LWF0dHI9InBhcmVudE1vZGVsIj5gIGFuZCB3aWRnZXQgZGVmaW5pdGlvbiBvZgogKiAgIGBzY29wZTogeyBsb2NhbE1vZGVsOic9bXlBdHRyJyB9YCwgdGhlbiB3aWRnZXQgc2NvcGUgcHJvcGVydHkgYGxvY2FsTW9kZWxgIHdpbGwgcmVmbGVjdCB0aGUKICogICB2YWx1ZSBvZiBgcGFyZW50TW9kZWxgIG9uIHRoZSBwYXJlbnQgc2NvcGUuIEFueSBjaGFuZ2VzIHRvIGBwYXJlbnRNb2RlbGAgd2lsbCBiZSByZWZsZWN0ZWQKICogICBpbiBgbG9jYWxNb2RlbGAgYW5kIGFueSBjaGFuZ2VzIGluIGBsb2NhbE1vZGVsYCB3aWxsIHJlZmxlY3QgaW4gYHBhcmVudE1vZGVsYC4gSWYgdGhlIHBhcmVudAogKiAgIHNjb3BlIHByb3BlcnR5IGRvZXNuJ3QgZXhpc3QsIGl0IHdpbGwgdGhyb3cgYSBOT05fQVNTSUdOQUJMRV9NT0RFTF9FWFBSRVNTSU9OIGV4Y2VwdGlvbi4gWW91CiAqICAgY2FuIGF2b2lkIHRoaXMgYmVoYXZpb3IgdXNpbmcgYD0/YCBvciBgPT9hdHRyYCBpbiBvcmRlciB0byBmbGFnIHRoZSBwcm9wZXJ0eSBhcyBvcHRpb25hbC4KICoKICogKiBgJmAgb3IgYCZhdHRyYCAtIHByb3ZpZGVzIGEgd2F5IHRvIGV4ZWN1dGUgYW4gZXhwcmVzc2lvbiBpbiB0aGUgY29udGV4dCBvZiB0aGUgcGFyZW50IHNjb3BlLgogKiAgIElmIG5vIGBhdHRyYCBuYW1lIGlzIHNwZWNpZmllZCB0aGVuIHRoZSBhdHRyaWJ1dGUgbmFtZSBpcyBhc3N1bWVkIHRvIGJlIHRoZSBzYW1lIGFzIHRoZQogKiAgIGxvY2FsIG5hbWUuIEdpdmVuIGA8d2lkZ2V0IG15LWF0dHI9ImNvdW50ID0gY291bnQgKyB2YWx1ZSI+YCBhbmQgd2lkZ2V0IGRlZmluaXRpb24gb2YKICogICBgc2NvcGU6IHsgbG9jYWxGbjonJm15QXR0cicgfWAsIHRoZW4gaXNvbGF0ZSBzY29wZSBwcm9wZXJ0eSBgbG9jYWxGbmAgd2lsbCBwb2ludCB0bwogKiAgIGEgZnVuY3Rpb24gd3JhcHBlciBmb3IgdGhlIGBjb3VudCA9IGNvdW50ICsgdmFsdWVgIGV4cHJlc3Npb24uIE9mdGVuIGl0J3MgZGVzaXJhYmxlIHRvCiAqICAgcGFzcyBkYXRhIGZyb20gdGhlIGlzb2xhdGVkIHNjb3BlIHZpYSBhbiBleHByZXNzaW9uIHRvIHRoZSBwYXJlbnQgc2NvcGUsIHRoaXMgY2FuIGJlCiAqICAgZG9uZSBieSBwYXNzaW5nIGEgbWFwIG9mIGxvY2FsIHZhcmlhYmxlIG5hbWVzIGFuZCB2YWx1ZXMgaW50byB0aGUgZXhwcmVzc2lvbiB3cmFwcGVyIGZuLgogKiAgIEZvciBleGFtcGxlLCBpZiB0aGUgZXhwcmVzc2lvbiBpcyBgaW5jcmVtZW50KGFtb3VudClgIHRoZW4gd2UgY2FuIHNwZWNpZnkgdGhlIGFtb3VudCB2YWx1ZQogKiAgIGJ5IGNhbGxpbmcgdGhlIGBsb2NhbEZuYCBhcyBgbG9jYWxGbih7YW1vdW50OiAyMn0pYC4KICoKICoKICogIyMjIyBgYmluZFRvQ29udHJvbGxlcmAKICogV2hlbiBhbiBpc29sYXRlIHNjb3BlIGlzIHVzZWQgZm9yIGEgY29tcG9uZW50IChzZWUgYWJvdmUpLCBhbmQgYGNvbnRyb2xsZXJBc2AgaXMgdXNlZCwgYGJpbmRUb0NvbnRyb2xsZXJgIHdpbGwKICogYWxsb3cgYSBjb21wb25lbnQgdG8gaGF2ZSBpdHMgcHJvcGVydGllcyBib3VuZCB0byB0aGUgY29udHJvbGxlciwgcmF0aGVyIHRoYW4gdG8gc2NvcGUuIFdoZW4gdGhlIGNvbnRyb2xsZXIKICogaXMgaW5zdGFudGlhdGVkLCB0aGUgaW5pdGlhbCB2YWx1ZXMgb2YgdGhlIGlzb2xhdGUgc2NvcGUgYmluZGluZ3MgYXJlIGFscmVhZHkgYXZhaWxhYmxlLgogKgogKiAjIyMjIGBjb250cm9sbGVyYAogKiBDb250cm9sbGVyIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLiBUaGUgY29udHJvbGxlciBpcyBpbnN0YW50aWF0ZWQgYmVmb3JlIHRoZQogKiBwcmUtbGlua2luZyBwaGFzZSBhbmQgaXQgaXMgc2hhcmVkIHdpdGggb3RoZXIgZGlyZWN0aXZlcyAoc2VlCiAqIGByZXF1aXJlYCBhdHRyaWJ1dGUpLiBUaGlzIGFsbG93cyB0aGUgZGlyZWN0aXZlcyB0byBjb21tdW5pY2F0ZSB3aXRoIGVhY2ggb3RoZXIgYW5kIGF1Z21lbnQKICogZWFjaCBvdGhlcidzIGJlaGF2aW9yLiBUaGUgY29udHJvbGxlciBpcyBpbmplY3RhYmxlIChhbmQgc3VwcG9ydHMgYnJhY2tldCBub3RhdGlvbikgd2l0aCB0aGUgZm9sbG93aW5nIGxvY2FsczoKICoKICogKiBgJHNjb3BlYCAtIEN1cnJlbnQgc2NvcGUgYXNzb2NpYXRlZCB3aXRoIHRoZSBlbGVtZW50CiAqICogYCRlbGVtZW50YCAtIEN1cnJlbnQgZWxlbWVudAogKiAqIGAkYXR0cnNgIC0gQ3VycmVudCBhdHRyaWJ1dGVzIG9iamVjdCBmb3IgdGhlIGVsZW1lbnQKICogKiBgJHRyYW5zY2x1ZGVgIC0gQSB0cmFuc2NsdWRlIGxpbmtpbmcgZnVuY3Rpb24gcHJlLWJvdW5kIHRvIHRoZSBjb3JyZWN0IHRyYW5zY2x1c2lvbiBzY29wZToKICogICBgZnVuY3Rpb24oW3Njb3BlXSwgY2xvbmVMaW5raW5nRm4sIGZ1dHVyZVBhcmVudEVsZW1lbnQpYC4KICogICAgKiBgc2NvcGVgOiBvcHRpb25hbCBhcmd1bWVudCB0byBvdmVycmlkZSB0aGUgc2NvcGUuCiAqICAgICogYGNsb25lTGlua2luZ0ZuYDogb3B0aW9uYWwgYXJndW1lbnQgdG8gY3JlYXRlIGNsb25lcyBvZiB0aGUgb3JpZ2luYWwgdHJhbnNjbHVkZWQgY29udGVudC4KICogICAgKiBgZnV0dXJlUGFyZW50RWxlbWVudGA6CiAqICAgICAgICAqIGRlZmluZXMgdGhlIHBhcmVudCB0byB3aGljaCB0aGUgYGNsb25lTGlua2luZ0ZuYCB3aWxsIGFkZCB0aGUgY2xvbmVkIGVsZW1lbnRzLgogKiAgICAgICAgKiBkZWZhdWx0OiBgJGVsZW1lbnQucGFyZW50KClgIHJlc3AuIGAkZWxlbWVudGAgZm9yIGB0cmFuc2NsdWRlOidlbGVtZW50J2AgcmVzcC4gYHRyYW5zY2x1ZGU6dHJ1ZWAuCiAqICAgICAgICAqIG9ubHkgbmVlZGVkIGZvciB0cmFuc2NsdWRlcyB0aGF0IGFyZSBhbGxvd2VkIHRvIGNvbnRhaW4gbm9uIGh0bWwgZWxlbWVudHMgKGUuZy4gU1ZHIGVsZW1lbnRzKQogKiAgICAgICAgICBhbmQgd2hlbiB0aGUgYGNsb25lTGlua2luRm5gIGlzIHBhc3NlZCwKICogICAgICAgICAgYXMgdGhvc2UgZWxlbWVudHMgbmVlZCB0byBjcmVhdGVkIGFuZCBjbG9uZWQgaW4gYSBzcGVjaWFsIHdheSB3aGVuIHRoZXkgYXJlIGRlZmluZWQgb3V0c2lkZSB0aGVpcgogKiAgICAgICAgICB1c3VhbCBjb250YWluZXJzIChlLmcuIGxpa2UgYDxzdmc+YCkuCiAqICAgICAgICAqIFNlZSBhbHNvIHRoZSBgZGlyZWN0aXZlLnRlbXBsYXRlTmFtZXNwYWNlYCBwcm9wZXJ0eS4KICoKICoKICogIyMjIyBgcmVxdWlyZWAKICogUmVxdWlyZSBhbm90aGVyIGRpcmVjdGl2ZSBhbmQgaW5qZWN0IGl0cyBjb250cm9sbGVyIGFzIHRoZSBmb3VydGggYXJndW1lbnQgdG8gdGhlIGxpbmtpbmcgZnVuY3Rpb24uIFRoZQogKiBgcmVxdWlyZWAgdGFrZXMgYSBzdHJpbmcgbmFtZSAob3IgYXJyYXkgb2Ygc3RyaW5ncykgb2YgdGhlIGRpcmVjdGl2ZShzKSB0byBwYXNzIGluLiBJZiBhbiBhcnJheSBpcyB1c2VkLCB0aGUKICogaW5qZWN0ZWQgYXJndW1lbnQgd2lsbCBiZSBhbiBhcnJheSBpbiBjb3JyZXNwb25kaW5nIG9yZGVyLiBJZiBubyBzdWNoIGRpcmVjdGl2ZSBjYW4gYmUKICogZm91bmQsIG9yIGlmIHRoZSBkaXJlY3RpdmUgZG9lcyBub3QgaGF2ZSBhIGNvbnRyb2xsZXIsIHRoZW4gYW4gZXJyb3IgaXMgcmFpc2VkLiBUaGUgbmFtZSBjYW4gYmUgcHJlZml4ZWQgd2l0aDoKICoKICogKiAobm8gcHJlZml4KSAtIExvY2F0ZSB0aGUgcmVxdWlyZWQgY29udHJvbGxlciBvbiB0aGUgY3VycmVudCBlbGVtZW50LiBUaHJvdyBhbiBlcnJvciBpZiBub3QgZm91bmQuCiAqICogYD9gIC0gQXR0ZW1wdCB0byBsb2NhdGUgdGhlIHJlcXVpcmVkIGNvbnRyb2xsZXIgb3IgcGFzcyBgbnVsbGAgdG8gdGhlIGBsaW5rYCBmbiBpZiBub3QgZm91bmQuCiAqICogYF5gIC0gTG9jYXRlIHRoZSByZXF1aXJlZCBjb250cm9sbGVyIGJ5IHNlYXJjaGluZyB0aGUgZWxlbWVudCBhbmQgaXRzIHBhcmVudHMuIFRocm93IGFuIGVycm9yIGlmIG5vdCBmb3VuZC4KICogKiBgXl5gIC0gTG9jYXRlIHRoZSByZXF1aXJlZCBjb250cm9sbGVyIGJ5IHNlYXJjaGluZyB0aGUgZWxlbWVudCdzIHBhcmVudHMuIFRocm93IGFuIGVycm9yIGlmIG5vdCBmb3VuZC4KICogKiBgP15gIC0gQXR0ZW1wdCB0byBsb2NhdGUgdGhlIHJlcXVpcmVkIGNvbnRyb2xsZXIgYnkgc2VhcmNoaW5nIHRoZSBlbGVtZW50IGFuZCBpdHMgcGFyZW50cyBvciBwYXNzCiAqICAgYG51bGxgIHRvIHRoZSBgbGlua2AgZm4gaWYgbm90IGZvdW5kLgogKiAqIGA/Xl5gIC0gQXR0ZW1wdCB0byBsb2NhdGUgdGhlIHJlcXVpcmVkIGNvbnRyb2xsZXIgYnkgc2VhcmNoaW5nIHRoZSBlbGVtZW50J3MgcGFyZW50cywgb3IgcGFzcwogKiAgIGBudWxsYCB0byB0aGUgYGxpbmtgIGZuIGlmIG5vdCBmb3VuZC4KICoKICoKICogIyMjIyBgY29udHJvbGxlckFzYAogKiBDb250cm9sbGVyIGFsaWFzIGF0IHRoZSBkaXJlY3RpdmUgc2NvcGUuIEFuIGFsaWFzIGZvciB0aGUgY29udHJvbGxlciBzbyBpdAogKiBjYW4gYmUgcmVmZXJlbmNlZCBhdCB0aGUgZGlyZWN0aXZlIHRlbXBsYXRlLiBUaGUgZGlyZWN0aXZlIG5lZWRzIHRvIGRlZmluZSBhIHNjb3BlIGZvciB0aGlzCiAqIGNvbmZpZ3VyYXRpb24gdG8gYmUgdXNlZC4gVXNlZnVsIGluIHRoZSBjYXNlIHdoZW4gZGlyZWN0aXZlIGlzIHVzZWQgYXMgY29tcG9uZW50LgogKgogKgogKiAjIyMjIGByZXN0cmljdGAKICogU3RyaW5nIG9mIHN1YnNldCBvZiBgRUFDTWAgd2hpY2ggcmVzdHJpY3RzIHRoZSBkaXJlY3RpdmUgdG8gYSBzcGVjaWZpYyBkaXJlY3RpdmUKICogZGVjbGFyYXRpb24gc3R5bGUuIElmIG9taXR0ZWQsIHRoZSBkZWZhdWx0cyAoZWxlbWVudHMgYW5kIGF0dHJpYnV0ZXMpIGFyZSB1c2VkLgogKgogKiAqIGBFYCAtIEVsZW1lbnQgbmFtZSAoZGVmYXVsdCk6IGA8bXktZGlyZWN0aXZlPjwvbXktZGlyZWN0aXZlPmAKICogKiBgQWAgLSBBdHRyaWJ1dGUgKGRlZmF1bHQpOiBgPGRpdiBteS1kaXJlY3RpdmU9ImV4cCI+PC9kaXY+YAogKiAqIGBDYCAtIENsYXNzOiBgPGRpdiBjbGFzcz0ibXktZGlyZWN0aXZlOiBleHA7Ij48L2Rpdj5gCiAqICogYE1gIC0gQ29tbWVudDogYDwhLS0gZGlyZWN0aXZlOiBteS1kaXJlY3RpdmUgZXhwIC0tPmAKICoKICoKICogIyMjIyBgdGVtcGxhdGVOYW1lc3BhY2VgCiAqIFN0cmluZyByZXByZXNlbnRpbmcgdGhlIGRvY3VtZW50IHR5cGUgdXNlZCBieSB0aGUgbWFya3VwIGluIHRoZSB0ZW1wbGF0ZS4KICogQW5ndWxhckpTIG5lZWRzIHRoaXMgaW5mb3JtYXRpb24gYXMgdGhvc2UgZWxlbWVudHMgbmVlZCB0byBiZSBjcmVhdGVkIGFuZCBjbG9uZWQKICogaW4gYSBzcGVjaWFsIHdheSB3aGVuIHRoZXkgYXJlIGRlZmluZWQgb3V0c2lkZSB0aGVpciB1c3VhbCBjb250YWluZXJzIGxpa2UgYDxzdmc+YCBhbmQgYDxtYXRoPmAuCiAqCiAqICogYGh0bWxgIC0gQWxsIHJvb3Qgbm9kZXMgaW4gdGhlIHRlbXBsYXRlIGFyZSBIVE1MLiBSb290IG5vZGVzIG1heSBhbHNvIGJlCiAqICAgdG9wLWxldmVsIGVsZW1lbnRzIHN1Y2ggYXMgYDxzdmc+YCBvciBgPG1hdGg+YC4KICogKiBgc3ZnYCAtIFRoZSByb290IG5vZGVzIGluIHRoZSB0ZW1wbGF0ZSBhcmUgU1ZHIGVsZW1lbnRzIChleGNsdWRpbmcgYDxtYXRoPmApLgogKiAqIGBtYXRoYCAtIFRoZSByb290IG5vZGVzIGluIHRoZSB0ZW1wbGF0ZSBhcmUgTWF0aE1MIGVsZW1lbnRzIChleGNsdWRpbmcgYDxzdmc+YCkuCiAqCiAqIElmIG5vIGB0ZW1wbGF0ZU5hbWVzcGFjZWAgaXMgc3BlY2lmaWVkLCB0aGVuIHRoZSBuYW1lc3BhY2UgaXMgY29uc2lkZXJlZCB0byBiZSBgaHRtbGAuCiAqCiAqICMjIyMgYHRlbXBsYXRlYAogKiBIVE1MIG1hcmt1cCB0aGF0IG1heToKICogKiBSZXBsYWNlIHRoZSBjb250ZW50cyBvZiB0aGUgZGlyZWN0aXZlJ3MgZWxlbWVudCAoZGVmYXVsdCkuCiAqICogUmVwbGFjZSB0aGUgZGlyZWN0aXZlJ3MgZWxlbWVudCBpdHNlbGYgKGlmIGByZXBsYWNlYCBpcyB0cnVlIC0gREVQUkVDQVRFRCkuCiAqICogV3JhcCB0aGUgY29udGVudHMgb2YgdGhlIGRpcmVjdGl2ZSdzIGVsZW1lbnQgKGlmIGB0cmFuc2NsdWRlYCBpcyB0cnVlKS4KICoKICogVmFsdWUgbWF5IGJlOgogKgogKiAqIEEgc3RyaW5nLiBGb3IgZXhhbXBsZSBgPGRpdiByZWQtb24taG92ZXI+e3tkZWxldGVfc3RyfX08L2Rpdj5gLgogKiAqIEEgZnVuY3Rpb24gd2hpY2ggdGFrZXMgdHdvIGFyZ3VtZW50cyBgdEVsZW1lbnRgIGFuZCBgdEF0dHJzYCAoZGVzY3JpYmVkIGluIHRoZSBgY29tcGlsZWAKICogICBmdW5jdGlvbiBhcGkgYmVsb3cpIGFuZCByZXR1cm5zIGEgc3RyaW5nIHZhbHVlLgogKgogKgogKiAjIyMjIGB0ZW1wbGF0ZVVybGAKICogVGhpcyBpcyBzaW1pbGFyIHRvIGB0ZW1wbGF0ZWAgYnV0IHRoZSB0ZW1wbGF0ZSBpcyBsb2FkZWQgZnJvbSB0aGUgc3BlY2lmaWVkIFVSTCwgYXN5bmNocm9ub3VzbHkuCiAqCiAqIEJlY2F1c2UgdGVtcGxhdGUgbG9hZGluZyBpcyBhc3luY2hyb25vdXMgdGhlIGNvbXBpbGVyIHdpbGwgc3VzcGVuZCBjb21waWxhdGlvbiBvZiBkaXJlY3RpdmVzIG9uIHRoYXQgZWxlbWVudAogKiBmb3IgbGF0ZXIgd2hlbiB0aGUgdGVtcGxhdGUgaGFzIGJlZW4gcmVzb2x2ZWQuICBJbiB0aGUgbWVhbnRpbWUgaXQgd2lsbCBjb250aW51ZSB0byBjb21waWxlIGFuZCBsaW5rCiAqIHNpYmxpbmcgYW5kIHBhcmVudCBlbGVtZW50cyBhcyB0aG91Z2ggdGhpcyBlbGVtZW50IGhhZCBub3QgY29udGFpbmVkIGFueSBkaXJlY3RpdmVzLgogKgogKiBUaGUgY29tcGlsZXIgZG9lcyBub3Qgc3VzcGVuZCB0aGUgZW50aXJlIGNvbXBpbGF0aW9uIHRvIHdhaXQgZm9yIHRlbXBsYXRlcyB0byBiZSBsb2FkZWQgYmVjYXVzZSB0aGlzCiAqIHdvdWxkIHJlc3VsdCBpbiB0aGUgd2hvbGUgYXBwICJzdGFsbGluZyIgdW50aWwgYWxsIHRlbXBsYXRlcyBhcmUgbG9hZGVkIGFzeW5jaHJvbm91c2x5IC0gZXZlbiBpbiB0aGUKICogY2FzZSB3aGVuIG9ubHkgb25lIGRlZXBseSBuZXN0ZWQgZGlyZWN0aXZlIGhhcyBgdGVtcGxhdGVVcmxgLgogKgogKiBUZW1wbGF0ZSBsb2FkaW5nIGlzIGFzeW5jaHJvbm91cyBldmVuIGlmIHRoZSB0ZW1wbGF0ZSBoYXMgYmVlbiBwcmVsb2FkZWQgaW50byB0aGUge0BsaW5rICR0ZW1wbGF0ZUNhY2hlfQogKgogKiBZb3UgY2FuIHNwZWNpZnkgYHRlbXBsYXRlVXJsYCBhcyBhIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIFVSTCBvciBhcyBhIGZ1bmN0aW9uIHdoaWNoIHRha2VzIHR3bwogKiBhcmd1bWVudHMgYHRFbGVtZW50YCBhbmQgYHRBdHRyc2AgKGRlc2NyaWJlZCBpbiB0aGUgYGNvbXBpbGVgIGZ1bmN0aW9uIGFwaSBiZWxvdykgYW5kIHJldHVybnMKICogYSBzdHJpbmcgdmFsdWUgcmVwcmVzZW50aW5nIHRoZSB1cmwuICBJbiBlaXRoZXIgY2FzZSwgdGhlIHRlbXBsYXRlIFVSTCBpcyBwYXNzZWQgdGhyb3VnaCB7QGxpbmsKICogJHNjZSNnZXRUcnVzdGVkUmVzb3VyY2VVcmwgJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmx9LgogKgogKgogKiAjIyMjIGByZXBsYWNlYCAoWypERVBSRUNBVEVEKiFdLCB3aWxsIGJlIHJlbW92ZWQgaW4gbmV4dCBtYWpvciByZWxlYXNlIC0gaS5lLiB2Mi4wKQogKiBzcGVjaWZ5IHdoYXQgdGhlIHRlbXBsYXRlIHNob3VsZCByZXBsYWNlLiBEZWZhdWx0cyB0byBgZmFsc2VgLgogKgogKiAqIGB0cnVlYCAtIHRoZSB0ZW1wbGF0ZSB3aWxsIHJlcGxhY2UgdGhlIGRpcmVjdGl2ZSdzIGVsZW1lbnQuCiAqICogYGZhbHNlYCAtIHRoZSB0ZW1wbGF0ZSB3aWxsIHJlcGxhY2UgdGhlIGNvbnRlbnRzIG9mIHRoZSBkaXJlY3RpdmUncyBlbGVtZW50LgogKgogKiBUaGUgcmVwbGFjZW1lbnQgcHJvY2VzcyBtaWdyYXRlcyBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgLyBjbGFzc2VzIGZyb20gdGhlIG9sZCBlbGVtZW50IHRvIHRoZSBuZXcKICogb25lLiBTZWUgdGhlIHtAbGluayBndWlkZS9kaXJlY3RpdmUjdGVtcGxhdGUtZXhwYW5kaW5nLWRpcmVjdGl2ZQogKiBEaXJlY3RpdmVzIEd1aWRlfSBmb3IgYW4gZXhhbXBsZS4KICoKICogVGhlcmUgYXJlIHZlcnkgZmV3IHNjZW5hcmlvcyB3aGVyZSBlbGVtZW50IHJlcGxhY2VtZW50IGlzIHJlcXVpcmVkIGZvciB0aGUgYXBwbGljYXRpb24gZnVuY3Rpb24sCiAqIHRoZSBtYWluIG9uZSBiZWluZyByZXVzYWJsZSBjdXN0b20gY29tcG9uZW50cyB0aGF0IGFyZSB1c2VkIHdpdGhpbiBTVkcgY29udGV4dHMKICogKGJlY2F1c2UgU1ZHIGRvZXNuJ3Qgd29yayB3aXRoIGN1c3RvbSBlbGVtZW50cyBpbiB0aGUgRE9NIHRyZWUpLgogKgogKiAjIyMjIGB0cmFuc2NsdWRlYAogKiBFeHRyYWN0IHRoZSBjb250ZW50cyBvZiB0aGUgZWxlbWVudCB3aGVyZSB0aGUgZGlyZWN0aXZlIGFwcGVhcnMgYW5kIG1ha2UgaXQgYXZhaWxhYmxlIHRvIHRoZSBkaXJlY3RpdmUuCiAqIFRoZSBjb250ZW50cyBhcmUgY29tcGlsZWQgYW5kIHByb3ZpZGVkIHRvIHRoZSBkaXJlY3RpdmUgYXMgYSAqKnRyYW5zY2x1c2lvbiBmdW5jdGlvbioqLiBTZWUgdGhlCiAqIHtAbGluayAkY29tcGlsZSN0cmFuc2NsdXNpb24gVHJhbnNjbHVzaW9ufSBzZWN0aW9uIGJlbG93LgogKgogKiBUaGVyZSBhcmUgdHdvIGtpbmRzIG9mIHRyYW5zY2x1c2lvbiBkZXBlbmRpbmcgdXBvbiB3aGV0aGVyIHlvdSB3YW50IHRvIHRyYW5zY2x1ZGUganVzdCB0aGUgY29udGVudHMgb2YgdGhlCiAqIGRpcmVjdGl2ZSdzIGVsZW1lbnQgb3IgdGhlIGVudGlyZSBlbGVtZW50OgogKgogKiAqIGB0cnVlYCAtIHRyYW5zY2x1ZGUgdGhlIGNvbnRlbnQgKGkuZS4gdGhlIGNoaWxkIG5vZGVzKSBvZiB0aGUgZGlyZWN0aXZlJ3MgZWxlbWVudC4KICogKiBgJ2VsZW1lbnQnYCAtIHRyYW5zY2x1ZGUgdGhlIHdob2xlIG9mIHRoZSBkaXJlY3RpdmUncyBlbGVtZW50IGluY2x1ZGluZyBhbnkgZGlyZWN0aXZlcyBvbiB0aGlzCiAqICAgZWxlbWVudCB0aGF0IGRlZmluZWQgYXQgYSBsb3dlciBwcmlvcml0eSB0aGFuIHRoaXMgZGlyZWN0aXZlLiBXaGVuIHVzZWQsIHRoZSBgdGVtcGxhdGVgCiAqICAgcHJvcGVydHkgaXMgaWdub3JlZC4KICoKICoKICogIyMjIyBgY29tcGlsZWAKICoKICogYGBganMKICogICBmdW5jdGlvbiBjb21waWxlKHRFbGVtZW50LCB0QXR0cnMsIHRyYW5zY2x1ZGUpIHsgLi4uIH0KICogYGBgCiAqCiAqIFRoZSBjb21waWxlIGZ1bmN0aW9uIGRlYWxzIHdpdGggdHJhbnNmb3JtaW5nIHRoZSB0ZW1wbGF0ZSBET00uIFNpbmNlIG1vc3QgZGlyZWN0aXZlcyBkbyBub3QgZG8KICogdGVtcGxhdGUgdHJhbnNmb3JtYXRpb24sIGl0IGlzIG5vdCB1c2VkIG9mdGVuLiBUaGUgY29tcGlsZSBmdW5jdGlvbiB0YWtlcyB0aGUgZm9sbG93aW5nIGFyZ3VtZW50czoKICoKICogICAqIGB0RWxlbWVudGAgLSB0ZW1wbGF0ZSBlbGVtZW50IC0gVGhlIGVsZW1lbnQgd2hlcmUgdGhlIGRpcmVjdGl2ZSBoYXMgYmVlbiBkZWNsYXJlZC4gSXQgaXMKICogICAgIHNhZmUgdG8gZG8gdGVtcGxhdGUgdHJhbnNmb3JtYXRpb24gb24gdGhlIGVsZW1lbnQgYW5kIGNoaWxkIGVsZW1lbnRzIG9ubHkuCiAqCiAqICAgKiBgdEF0dHJzYCAtIHRlbXBsYXRlIGF0dHJpYnV0ZXMgLSBOb3JtYWxpemVkIGxpc3Qgb2YgYXR0cmlidXRlcyBkZWNsYXJlZCBvbiB0aGlzIGVsZW1lbnQgc2hhcmVkCiAqICAgICBiZXR3ZWVuIGFsbCBkaXJlY3RpdmUgY29tcGlsZSBmdW5jdGlvbnMuCiAqCiAqICAgKiBgdHJhbnNjbHVkZWAgLSAgWypERVBSRUNBVEVEKiFdIEEgdHJhbnNjbHVkZSBsaW5raW5nIGZ1bmN0aW9uOiBgZnVuY3Rpb24oc2NvcGUsIGNsb25lTGlua2luZ0ZuKWAKICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAqICoqTm90ZToqKiBUaGUgdGVtcGxhdGUgaW5zdGFuY2UgYW5kIHRoZSBsaW5rIGluc3RhbmNlIG1heSBiZSBkaWZmZXJlbnQgb2JqZWN0cyBpZiB0aGUgdGVtcGxhdGUgaGFzCiAqIGJlZW4gY2xvbmVkLiBGb3IgdGhpcyByZWFzb24gaXQgaXMgKipub3QqKiBzYWZlIHRvIGRvIGFueXRoaW5nIG90aGVyIHRoYW4gRE9NIHRyYW5zZm9ybWF0aW9ucyB0aGF0CiAqIGFwcGx5IHRvIGFsbCBjbG9uZWQgRE9NIG5vZGVzIHdpdGhpbiB0aGUgY29tcGlsZSBmdW5jdGlvbi4gU3BlY2lmaWNhbGx5LCBET00gbGlzdGVuZXIgcmVnaXN0cmF0aW9uCiAqIHNob3VsZCBiZSBkb25lIGluIGEgbGlua2luZyBmdW5jdGlvbiByYXRoZXIgdGhhbiBpbiBhIGNvbXBpbGUgZnVuY3Rpb24uCiAqIDwvZGl2PgoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAqICoqTm90ZToqKiBUaGUgY29tcGlsZSBmdW5jdGlvbiBjYW5ub3QgaGFuZGxlIGRpcmVjdGl2ZXMgdGhhdCByZWN1cnNpdmVseSB1c2UgdGhlbXNlbHZlcyBpbiB0aGVpcgogKiBvd24gdGVtcGxhdGVzIG9yIGNvbXBpbGUgZnVuY3Rpb25zLiBDb21waWxpbmcgdGhlc2UgZGlyZWN0aXZlcyByZXN1bHRzIGluIGFuIGluZmluaXRlIGxvb3AgYW5kIGEKICogc3RhY2sgb3ZlcmZsb3cgZXJyb3JzLgogKgogKiBUaGlzIGNhbiBiZSBhdm9pZGVkIGJ5IG1hbnVhbGx5IHVzaW5nICRjb21waWxlIGluIHRoZSBwb3N0TGluayBmdW5jdGlvbiB0byBpbXBlcmF0aXZlbHkgY29tcGlsZQogKiBhIGRpcmVjdGl2ZSdzIHRlbXBsYXRlIGluc3RlYWQgb2YgcmVseWluZyBvbiBhdXRvbWF0aWMgdGVtcGxhdGUgY29tcGlsYXRpb24gdmlhIGB0ZW1wbGF0ZWAgb3IKICogYHRlbXBsYXRlVXJsYCBkZWNsYXJhdGlvbiBvciBtYW51YWwgY29tcGlsYXRpb24gaW5zaWRlIHRoZSBjb21waWxlIGZ1bmN0aW9uLgogKiA8L2Rpdj4KICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtZXJyb3IiPgogKiAqKk5vdGU6KiogVGhlIGB0cmFuc2NsdWRlYCBmdW5jdGlvbiB0aGF0IGlzIHBhc3NlZCB0byB0aGUgY29tcGlsZSBmdW5jdGlvbiBpcyBkZXByZWNhdGVkLCBhcyBpdAogKiAgIGUuZy4gZG9lcyBub3Qga25vdyBhYm91dCB0aGUgcmlnaHQgb3V0ZXIgc2NvcGUuIFBsZWFzZSB1c2UgdGhlIHRyYW5zY2x1ZGUgZnVuY3Rpb24gdGhhdCBpcyBwYXNzZWQKICogICB0byB0aGUgbGluayBmdW5jdGlvbiBpbnN0ZWFkLgogKiA8L2Rpdj4KCiAqIEEgY29tcGlsZSBmdW5jdGlvbiBjYW4gaGF2ZSBhIHJldHVybiB2YWx1ZSB3aGljaCBjYW4gYmUgZWl0aGVyIGEgZnVuY3Rpb24gb3IgYW4gb2JqZWN0LgogKgogKiAqIHJldHVybmluZyBhIChwb3N0LWxpbmspIGZ1bmN0aW9uIC0gaXMgZXF1aXZhbGVudCB0byByZWdpc3RlcmluZyB0aGUgbGlua2luZyBmdW5jdGlvbiB2aWEgdGhlCiAqICAgYGxpbmtgIHByb3BlcnR5IG9mIHRoZSBjb25maWcgb2JqZWN0IHdoZW4gdGhlIGNvbXBpbGUgZnVuY3Rpb24gaXMgZW1wdHkuCiAqCiAqICogcmV0dXJuaW5nIGFuIG9iamVjdCB3aXRoIGZ1bmN0aW9uKHMpIHJlZ2lzdGVyZWQgdmlhIGBwcmVgIGFuZCBgcG9zdGAgcHJvcGVydGllcyAtIGFsbG93cyB5b3UgdG8KICogICBjb250cm9sIHdoZW4gYSBsaW5raW5nIGZ1bmN0aW9uIHNob3VsZCBiZSBjYWxsZWQgZHVyaW5nIHRoZSBsaW5raW5nIHBoYXNlLiBTZWUgaW5mbyBhYm91dAogKiAgIHByZS1saW5raW5nIGFuZCBwb3N0LWxpbmtpbmcgZnVuY3Rpb25zIGJlbG93LgogKgogKgogKiAjIyMjIGBsaW5rYAogKiBUaGlzIHByb3BlcnR5IGlzIHVzZWQgb25seSBpZiB0aGUgYGNvbXBpbGVgIHByb3BlcnR5IGlzIG5vdCBkZWZpbmVkLgogKgogKiBgYGBqcwogKiAgIGZ1bmN0aW9uIGxpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMsIGNvbnRyb2xsZXIsIHRyYW5zY2x1ZGVGbikgeyAuLi4gfQogKiBgYGAKICoKICogVGhlIGxpbmsgZnVuY3Rpb24gaXMgcmVzcG9uc2libGUgZm9yIHJlZ2lzdGVyaW5nIERPTSBsaXN0ZW5lcnMgYXMgd2VsbCBhcyB1cGRhdGluZyB0aGUgRE9NLiBJdCBpcwogKiBleGVjdXRlZCBhZnRlciB0aGUgdGVtcGxhdGUgaGFzIGJlZW4gY2xvbmVkLiBUaGlzIGlzIHdoZXJlIG1vc3Qgb2YgdGhlIGRpcmVjdGl2ZSBsb2dpYyB3aWxsIGJlCiAqIHB1dC4KICoKICogICAqIGBzY29wZWAgLSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBTY29wZX0gLSBUaGUgc2NvcGUgdG8gYmUgdXNlZCBieSB0aGUKICogICAgIGRpcmVjdGl2ZSBmb3IgcmVnaXN0ZXJpbmcge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXN9LgogKgogKiAgICogYGlFbGVtZW50YCAtIGluc3RhbmNlIGVsZW1lbnQgLSBUaGUgZWxlbWVudCB3aGVyZSB0aGUgZGlyZWN0aXZlIGlzIHRvIGJlIHVzZWQuIEl0IGlzIHNhZmUgdG8KICogICAgIG1hbmlwdWxhdGUgdGhlIGNoaWxkcmVuIG9mIHRoZSBlbGVtZW50IG9ubHkgaW4gYHBvc3RMaW5rYCBmdW5jdGlvbiBzaW5jZSB0aGUgY2hpbGRyZW4gaGF2ZQogKiAgICAgYWxyZWFkeSBiZWVuIGxpbmtlZC4KICoKICogICAqIGBpQXR0cnNgIC0gaW5zdGFuY2UgYXR0cmlidXRlcyAtIE5vcm1hbGl6ZWQgbGlzdCBvZiBhdHRyaWJ1dGVzIGRlY2xhcmVkIG9uIHRoaXMgZWxlbWVudCBzaGFyZWQKICogICAgIGJldHdlZW4gYWxsIGRpcmVjdGl2ZSBsaW5raW5nIGZ1bmN0aW9ucy4KICoKICogICAqIGBjb250cm9sbGVyYCAtIGEgY29udHJvbGxlciBpbnN0YW5jZSAtIEEgY29udHJvbGxlciBpbnN0YW5jZSBpZiBhdCBsZWFzdCBvbmUgZGlyZWN0aXZlIG9uIHRoZQogKiAgICAgZWxlbWVudCBkZWZpbmVzIGEgY29udHJvbGxlci4gVGhlIGNvbnRyb2xsZXIgaXMgc2hhcmVkIGFtb25nIGFsbCB0aGUgZGlyZWN0aXZlcywgd2hpY2ggYWxsb3dzCiAqICAgICB0aGUgZGlyZWN0aXZlcyB0byB1c2UgdGhlIGNvbnRyb2xsZXJzIGFzIGEgY29tbXVuaWNhdGlvbiBjaGFubmVsLgogKgogKiAgICogYHRyYW5zY2x1ZGVGbmAgLSBBIHRyYW5zY2x1ZGUgbGlua2luZyBmdW5jdGlvbiBwcmUtYm91bmQgdG8gdGhlIGNvcnJlY3QgdHJhbnNjbHVzaW9uIHNjb3BlLgogKiAgICAgVGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgYCR0cmFuc2NsdWRlYAogKiAgICAgcGFyYW1ldGVyIG9mIGRpcmVjdGl2ZSBjb250cm9sbGVycywgc2VlIHRoZXJlIGZvciBkZXRhaWxzLgogKiAgICAgYGZ1bmN0aW9uKFtzY29wZV0sIGNsb25lTGlua2luZ0ZuLCBmdXR1cmVQYXJlbnRFbGVtZW50KWAuCiAqCiAqICMjIyMgUHJlLWxpbmtpbmcgZnVuY3Rpb24KICoKICogRXhlY3V0ZWQgYmVmb3JlIHRoZSBjaGlsZCBlbGVtZW50cyBhcmUgbGlua2VkLiBOb3Qgc2FmZSB0byBkbyBET00gdHJhbnNmb3JtYXRpb24gc2luY2UgdGhlCiAqIGNvbXBpbGVyIGxpbmtpbmcgZnVuY3Rpb24gd2lsbCBmYWlsIHRvIGxvY2F0ZSB0aGUgY29ycmVjdCBlbGVtZW50cyBmb3IgbGlua2luZy4KICoKICogIyMjIyBQb3N0LWxpbmtpbmcgZnVuY3Rpb24KICoKICogRXhlY3V0ZWQgYWZ0ZXIgdGhlIGNoaWxkIGVsZW1lbnRzIGFyZSBsaW5rZWQuCiAqCiAqIE5vdGUgdGhhdCBjaGlsZCBlbGVtZW50cyB0aGF0IGNvbnRhaW4gYHRlbXBsYXRlVXJsYCBkaXJlY3RpdmVzIHdpbGwgbm90IGhhdmUgYmVlbiBjb21waWxlZAogKiBhbmQgbGlua2VkIHNpbmNlIHRoZXkgYXJlIHdhaXRpbmcgZm9yIHRoZWlyIHRlbXBsYXRlIHRvIGxvYWQgYXN5bmNocm9ub3VzbHkgYW5kIHRoZWlyIG93bgogKiBjb21waWxhdGlvbiBhbmQgbGlua2luZyBoYXMgYmVlbiBzdXNwZW5kZWQgdW50aWwgdGhhdCBvY2N1cnMuCiAqCiAqIEl0IGlzIHNhZmUgdG8gZG8gRE9NIHRyYW5zZm9ybWF0aW9uIGluIHRoZSBwb3N0LWxpbmtpbmcgZnVuY3Rpb24gb24gZWxlbWVudHMgdGhhdCBhcmUgbm90IHdhaXRpbmcKICogZm9yIHRoZWlyIGFzeW5jIHRlbXBsYXRlcyB0byBiZSByZXNvbHZlZC4KICoKICoKICogIyMjIFRyYW5zY2x1c2lvbgogKgogKiBUcmFuc2NsdXNpb24gaXMgdGhlIHByb2Nlc3Mgb2YgZXh0cmFjdGluZyBhIGNvbGxlY3Rpb24gb2YgRE9NIGVsZW1lbnQgZnJvbSBvbmUgcGFydCBvZiB0aGUgRE9NIGFuZAogKiBjb3B5aW5nIHRoZW0gdG8gYW5vdGhlciBwYXJ0IG9mIHRoZSBET00sIHdoaWxlIG1haW50YWluaW5nIHRoZWlyIGNvbm5lY3Rpb24gdG8gdGhlIG9yaWdpbmFsIEFuZ3VsYXJKUwogKiBzY29wZSBmcm9tIHdoZXJlIHRoZXkgd2VyZSB0YWtlbi4KICoKICogVHJhbnNjbHVzaW9uIGlzIHVzZWQgKG9mdGVuIHdpdGgge0BsaW5rIG5nVHJhbnNjbHVkZX0pIHRvIGluc2VydCB0aGUKICogb3JpZ2luYWwgY29udGVudHMgb2YgYSBkaXJlY3RpdmUncyBlbGVtZW50IGludG8gYSBzcGVjaWZpZWQgcGxhY2UgaW4gdGhlIHRlbXBsYXRlIG9mIHRoZSBkaXJlY3RpdmUuCiAqIFRoZSBiZW5lZml0IG9mIHRyYW5zY2x1c2lvbiwgb3ZlciBzaW1wbHkgbW92aW5nIHRoZSBET00gZWxlbWVudHMgbWFudWFsbHksIGlzIHRoYXQgdGhlIHRyYW5zY2x1ZGVkCiAqIGNvbnRlbnQgaGFzIGFjY2VzcyB0byB0aGUgcHJvcGVydGllcyBvbiB0aGUgc2NvcGUgZnJvbSB3aGljaCBpdCB3YXMgdGFrZW4sIGV2ZW4gaWYgdGhlIGRpcmVjdGl2ZQogKiBoYXMgaXNvbGF0ZWQgc2NvcGUuCiAqIFNlZSB0aGUge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSNjcmVhdGluZy1hLWRpcmVjdGl2ZS10aGF0LXdyYXBzLW90aGVyLWVsZW1lbnRzIERpcmVjdGl2ZXMgR3VpZGV9LgogKgogKiBUaGlzIG1ha2VzIGl0IHBvc3NpYmxlIGZvciB0aGUgd2lkZ2V0IHRvIGhhdmUgcHJpdmF0ZSBzdGF0ZSBmb3IgaXRzIHRlbXBsYXRlLCB3aGlsZSB0aGUgdHJhbnNjbHVkZWQKICogY29udGVudCBoYXMgYWNjZXNzIHRvIGl0cyBvcmlnaW5hdGluZyBzY29wZS4KICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAqICoqTm90ZToqKiBXaGVuIHRlc3RpbmcgYW4gZWxlbWVudCB0cmFuc2NsdWRlIGRpcmVjdGl2ZSB5b3UgbXVzdCBub3QgcGxhY2UgdGhlIGRpcmVjdGl2ZSBhdCB0aGUgcm9vdCBvZiB0aGUKICogRE9NIGZyYWdtZW50IHRoYXQgaXMgYmVpbmcgY29tcGlsZWQuIFNlZSB7QGxpbmsgZ3VpZGUvdW5pdC10ZXN0aW5nI3Rlc3RpbmctdHJhbnNjbHVzaW9uLWRpcmVjdGl2ZXMKICogVGVzdGluZyBUcmFuc2NsdXNpb24gRGlyZWN0aXZlc30uCiAqIDwvZGl2PgogKgogKiAjIyMjIFRyYW5zY2x1c2lvbiBGdW5jdGlvbnMKICoKICogV2hlbiBhIGRpcmVjdGl2ZSByZXF1ZXN0cyB0cmFuc2NsdXNpb24sIHRoZSBjb21waWxlciBleHRyYWN0cyBpdHMgY29udGVudHMgYW5kIHByb3ZpZGVzIGEgKip0cmFuc2NsdXNpb24KICogZnVuY3Rpb24qKiB0byB0aGUgZGlyZWN0aXZlJ3MgYGxpbmtgIGZ1bmN0aW9uIGFuZCBgY29udHJvbGxlcmAuIFRoaXMgdHJhbnNjbHVzaW9uIGZ1bmN0aW9uIGlzIGEgc3BlY2lhbAogKiAqKmxpbmtpbmcgZnVuY3Rpb24qKiB0aGF0IHdpbGwgcmV0dXJuIHRoZSBjb21waWxlZCBjb250ZW50cyBsaW5rZWQgdG8gYSBuZXcgdHJhbnNjbHVzaW9uIHNjb3BlLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1pbmZvIj4KICogSWYgeW91IGFyZSBqdXN0IHVzaW5nIHtAbGluayBuZ1RyYW5zY2x1ZGV9IHRoZW4geW91IGRvbid0IG5lZWQgdG8gd29ycnkgYWJvdXQgdGhpcyBmdW5jdGlvbiwgc2luY2UKICogbmdUcmFuc2NsdWRlIHdpbGwgZGVhbCB3aXRoIGl0IGZvciB1cy4KICogPC9kaXY+CiAqCiAqIElmIHlvdSB3YW50IHRvIG1hbnVhbGx5IGNvbnRyb2wgdGhlIGluc2VydGlvbiBhbmQgcmVtb3ZhbCBvZiB0aGUgdHJhbnNjbHVkZWQgY29udGVudCBpbiB5b3VyIGRpcmVjdGl2ZQogKiB0aGVuIHlvdSBtdXN0IHVzZSB0aGlzIHRyYW5zY2x1ZGUgZnVuY3Rpb24uIFdoZW4geW91IGNhbGwgYSB0cmFuc2NsdWRlIGZ1bmN0aW9uIGl0IHJldHVybnMgYSBhIGpxTGl0ZS9KUXVlcnkKICogb2JqZWN0IHRoYXQgY29udGFpbnMgdGhlIGNvbXBpbGVkIERPTSwgd2hpY2ggaXMgbGlua2VkIHRvIHRoZSBjb3JyZWN0IHRyYW5zY2x1c2lvbiBzY29wZS4KICoKICogV2hlbiB5b3UgY2FsbCBhIHRyYW5zY2x1c2lvbiBmdW5jdGlvbiB5b3UgY2FuIHBhc3MgaW4gYSAqKmNsb25lIGF0dGFjaCBmdW5jdGlvbioqLiBUaGlzIGZ1bmN0aW9uIGFjY2VwdHMKICogdHdvIHBhcmFtZXRlcnMsIGBmdW5jdGlvbihjbG9uZSwgc2NvcGUpIHsgLi4uIH1gLCB3aGVyZSB0aGUgYGNsb25lYCBpcyBhIGZyZXNoIGNvbXBpbGVkIGNvcHkgb2YgeW91ciB0cmFuc2NsdWRlZAogKiBjb250ZW50IGFuZCB0aGUgYHNjb3BlYCBpcyB0aGUgbmV3bHkgY3JlYXRlZCB0cmFuc2NsdXNpb24gc2NvcGUsIHRvIHdoaWNoIHRoZSBjbG9uZSBpcyBib3VuZC4KICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtaW5mbyI+CiAqICoqQmVzdCBQcmFjdGljZSoqOiBBbHdheXMgcHJvdmlkZSBhIGBjbG9uZUZuYCAoY2xvbmUgYXR0YWNoIGZ1bmN0aW9uKSB3aGVuIHlvdSBjYWxsIGEgdHJhbnNsdWRlIGZ1bmN0aW9uCiAqIHNpbmNlIHlvdSB0aGVuIGdldCBhIGZyZXNoIGNsb25lIG9mIHRoZSBvcmlnaW5hbCBET00gYW5kIGFsc28gaGF2ZSBhY2Nlc3MgdG8gdGhlIG5ldyB0cmFuc2NsdXNpb24gc2NvcGUuCiAqIDwvZGl2PgogKgogKiBJdCBpcyBub3JtYWwgcHJhY3RpY2UgdG8gYXR0YWNoIHlvdXIgdHJhbnNjbHVkZWQgY29udGVudCAoYGNsb25lYCkgdG8gdGhlIERPTSBpbnNpZGUgeW91ciAqKmNsb25lCiAqIGF0dGFjaCBmdW5jdGlvbioqOgogKgogKiBgYGBqcwogKiB2YXIgdHJhbnNjbHVkZWRDb250ZW50LCB0cmFuc2NsdXNpb25TY29wZTsKICoKICogJHRyYW5zY2x1ZGUoZnVuY3Rpb24oY2xvbmUsIHNjb3BlKSB7CiAqICAgZWxlbWVudC5hcHBlbmQoY2xvbmUpOwogKiAgIHRyYW5zY2x1ZGVkQ29udGVudCA9IGNsb25lOwogKiAgIHRyYW5zY2x1c2lvblNjb3BlID0gc2NvcGU7CiAqIH0pOwogKiBgYGAKICoKICogTGF0ZXIsIGlmIHlvdSB3YW50IHRvIHJlbW92ZSB0aGUgdHJhbnNjbHVkZWQgY29udGVudCBmcm9tIHlvdXIgRE9NIHRoZW4geW91IHNob3VsZCBhbHNvIGRlc3Ryb3kgdGhlCiAqIGFzc29jaWF0ZWQgdHJhbnNjbHVzaW9uIHNjb3BlOgogKgogKiBgYGBqcwogKiB0cmFuc2NsdWRlZENvbnRlbnQucmVtb3ZlKCk7CiAqIHRyYW5zY2x1c2lvblNjb3BlLiRkZXN0cm95KCk7CiAqIGBgYAogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1pbmZvIj4KICogKipCZXN0IFByYWN0aWNlKio6IGlmIHlvdSBpbnRlbmQgdG8gYWRkIGFuZCByZW1vdmUgdHJhbnNjbHVkZWQgY29udGVudCBtYW51YWxseSBpbiB5b3VyIGRpcmVjdGl2ZQogKiAoYnkgY2FsbGluZyB0aGUgdHJhbnNjbHVkZSBmdW5jdGlvbiB0byBnZXQgdGhlIERPTSBhbmQgYW5kIGNhbGxpbmcgYGVsZW1lbnQucmVtb3ZlKClgIHRvIHJlbW92ZSBpdCksCiAqIHRoZW4geW91IGFyZSBhbHNvIHJlc3BvbnNpYmxlIGZvciBjYWxsaW5nIGAkZGVzdHJveWAgb24gdGhlIHRyYW5zY2x1c2lvbiBzY29wZS4KICogPC9kaXY+CiAqCiAqIFRoZSBidWlsdC1pbiBET00gbWFuaXB1bGF0aW9uIGRpcmVjdGl2ZXMsIHN1Y2ggYXMge0BsaW5rIG5nSWZ9LCB7QGxpbmsgbmdTd2l0Y2h9IGFuZCB7QGxpbmsgbmdSZXBlYXR9CiAqIGF1dG9tYXRpY2FsbHkgZGVzdHJveSB0aGVpciB0cmFuc2x1ZGVkIGNsb25lcyBhcyBuZWNlc3Nhcnkgc28geW91IGRvIG5vdCBuZWVkIHRvIHdvcnJ5IGFib3V0IHRoaXMgaWYKICogeW91IGFyZSBzaW1wbHkgdXNpbmcge0BsaW5rIG5nVHJhbnNjbHVkZX0gdG8gaW5qZWN0IHRoZSB0cmFuc2NsdXNpb24gaW50byB5b3VyIGRpcmVjdGl2ZS4KICoKICoKICogIyMjIyBUcmFuc2NsdXNpb24gU2NvcGVzCiAqCiAqIFdoZW4geW91IGNhbGwgYSB0cmFuc2NsdWRlIGZ1bmN0aW9uIGl0IHJldHVybnMgYSBET00gZnJhZ21lbnQgdGhhdCBpcyBwcmUtYm91bmQgdG8gYSAqKnRyYW5zY2x1c2lvbgogKiBzY29wZSoqLiBUaGlzIHNjb3BlIGlzIHNwZWNpYWwsIGluIHRoYXQgaXQgaXMgYSBjaGlsZCBvZiB0aGUgZGlyZWN0aXZlJ3Mgc2NvcGUgKGFuZCBzbyBnZXRzIGRlc3Ryb3llZAogKiB3aGVuIHRoZSBkaXJlY3RpdmUncyBzY29wZSBnZXRzIGRlc3Ryb3llZCkgYnV0IGl0IGluaGVyaXRzIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBzY29wZSBmcm9tIHdoaWNoIGl0CiAqIHdhcyB0YWtlbi4KICoKICogRm9yIGV4YW1wbGUgY29uc2lkZXIgYSBkaXJlY3RpdmUgdGhhdCB1c2VzIHRyYW5zY2x1c2lvbiBhbmQgaXNvbGF0ZWQgc2NvcGUuIFRoZSBET00gaGllcmFyY2h5IG1pZ2h0IGxvb2sKICogbGlrZSB0aGlzOgogKgogKiBgYGBodG1sCiAqIDxkaXYgbmctYXBwPgogKiAgIDxkaXYgaXNvbGF0ZT4KICogICAgIDxkaXYgdHJhbnNjbHVzaW9uPgogKiAgICAgPC9kaXY+CiAqICAgPC9kaXY+CiAqIDwvZGl2PgogKiBgYGAKICoKICogVGhlIGAkcGFyZW50YCBzY29wZSBoaWVyYXJjaHkgd2lsbCBsb29rIGxpa2UgdGhpczoKICoKICogYGBgCiAqIC0gJHJvb3RTY29wZQogKiAgIC0gaXNvbGF0ZQogKiAgICAgLSB0cmFuc2NsdXNpb24KICogYGBgCiAqCiAqIGJ1dCB0aGUgc2NvcGVzIHdpbGwgaW5oZXJpdCBwcm90b3R5cGljYWxseSBmcm9tIGRpZmZlcmVudCBzY29wZXMgdG8gdGhlaXIgYCRwYXJlbnRgLgogKgogKiBgYGAKICogLSAkcm9vdFNjb3BlCiAqICAgLSB0cmFuc2NsdXNpb24KICogLSBpc29sYXRlCiAqIGBgYAogKgogKgogKiAjIyMgQXR0cmlidXRlcwogKgogKiBUaGUge0BsaW5rIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIEF0dHJpYnV0ZXN9IG9iamVjdCAtIHBhc3NlZCBhcyBhIHBhcmFtZXRlciBpbiB0aGUKICogYGxpbmsoKWAgb3IgYGNvbXBpbGUoKWAgZnVuY3Rpb25zLiBJdCBoYXMgYSB2YXJpZXR5IG9mIHVzZXMuCiAqCiAqIGFjY2Vzc2luZyAqTm9ybWFsaXplZCBhdHRyaWJ1dGUgbmFtZXM6KgogKiBEaXJlY3RpdmVzIGxpa2UgJ25nQmluZCcgY2FuIGJlIGV4cHJlc3NlZCBpbiBtYW55IHdheXM6ICduZzpiaW5kJywgYGRhdGEtbmctYmluZGAsIG9yICd4LW5nLWJpbmQnLgogKiB0aGUgYXR0cmlidXRlcyBvYmplY3QgYWxsb3dzIGZvciBub3JtYWxpemVkIGFjY2VzcyB0bwogKiAgIHRoZSBhdHRyaWJ1dGVzLgogKgogKiAqICpEaXJlY3RpdmUgaW50ZXItY29tbXVuaWNhdGlvbjoqIEFsbCBkaXJlY3RpdmVzIHNoYXJlIHRoZSBzYW1lIGluc3RhbmNlIG9mIHRoZSBhdHRyaWJ1dGVzCiAqICAgb2JqZWN0IHdoaWNoIGFsbG93cyB0aGUgZGlyZWN0aXZlcyB0byB1c2UgdGhlIGF0dHJpYnV0ZXMgb2JqZWN0IGFzIGludGVyIGRpcmVjdGl2ZQogKiAgIGNvbW11bmljYXRpb24uCiAqCiAqICogKlN1cHBvcnRzIGludGVycG9sYXRpb246KiBJbnRlcnBvbGF0aW9uIGF0dHJpYnV0ZXMgYXJlIGFzc2lnbmVkIHRvIHRoZSBhdHRyaWJ1dGUgb2JqZWN0CiAqICAgYWxsb3dpbmcgb3RoZXIgZGlyZWN0aXZlcyB0byByZWFkIHRoZSBpbnRlcnBvbGF0ZWQgdmFsdWUuCiAqCiAqICogKk9ic2VydmluZyBpbnRlcnBvbGF0ZWQgYXR0cmlidXRlczoqIFVzZSBgJG9ic2VydmVgIHRvIG9ic2VydmUgdGhlIHZhbHVlIGNoYW5nZXMgb2YgYXR0cmlidXRlcwogKiAgIHRoYXQgY29udGFpbiBpbnRlcnBvbGF0aW9uIChlLmcuIGBzcmM9Int7YmFyfX0iYCkuIE5vdCBvbmx5IGlzIHRoaXMgdmVyeSBlZmZpY2llbnQgYnV0IGl0J3MgYWxzbwogKiAgIHRoZSBvbmx5IHdheSB0byBlYXNpbHkgZ2V0IHRoZSBhY3R1YWwgdmFsdWUgYmVjYXVzZSBkdXJpbmcgdGhlIGxpbmtpbmcgcGhhc2UgdGhlIGludGVycG9sYXRpb24KICogICBoYXNuJ3QgYmVlbiBldmFsdWF0ZWQgeWV0IGFuZCBzbyB0aGUgdmFsdWUgaXMgYXQgdGhpcyB0aW1lIHNldCB0byBgdW5kZWZpbmVkYC4KICoKICogYGBganMKICogZnVuY3Rpb24gbGlua2luZ0ZuKHNjb3BlLCBlbG0sIGF0dHJzLCBjdHJsKSB7CiAqICAgLy8gZ2V0IHRoZSBhdHRyaWJ1dGUgdmFsdWUKICogICBjb25zb2xlLmxvZyhhdHRycy5uZ01vZGVsKTsKICoKICogICAvLyBjaGFuZ2UgdGhlIGF0dHJpYnV0ZQogKiAgIGF0dHJzLiRzZXQoJ25nTW9kZWwnLCAnbmV3IHZhbHVlJyk7CiAqCiAqICAgLy8gb2JzZXJ2ZSBjaGFuZ2VzIHRvIGludGVycG9sYXRlZCBhdHRyaWJ1dGUKICogICBhdHRycy4kb2JzZXJ2ZSgnbmdNb2RlbCcsIGZ1bmN0aW9uKHZhbHVlKSB7CiAqICAgICBjb25zb2xlLmxvZygnbmdNb2RlbCBoYXMgY2hhbmdlZCB2YWx1ZSB0byAnICsgdmFsdWUpOwogKiAgIH0pOwogKiB9CiAqIGBgYAogKgogKiAjIyBFeGFtcGxlCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKk5vdGUqKjogVHlwaWNhbGx5IGRpcmVjdGl2ZXMgYXJlIHJlZ2lzdGVyZWQgd2l0aCBgbW9kdWxlLmRpcmVjdGl2ZWAuIFRoZSBleGFtcGxlIGJlbG93IGlzCiAqIHRvIGlsbHVzdHJhdGUgaG93IGAkY29tcGlsZWAgd29ya3MuCiAqIDwvZGl2PgogKgogPGV4YW1wbGUgbW9kdWxlPSJjb21waWxlRXhhbXBsZSI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgPHNjcmlwdD4KICAgICAgYW5ndWxhci5tb2R1bGUoJ2NvbXBpbGVFeGFtcGxlJywgW10sIGZ1bmN0aW9uKCRjb21waWxlUHJvdmlkZXIpIHsKICAgICAgICAvLyBjb25maWd1cmUgbmV3ICdjb21waWxlJyBkaXJlY3RpdmUgYnkgcGFzc2luZyBhIGRpcmVjdGl2ZQogICAgICAgIC8vIGZhY3RvcnkgZnVuY3Rpb24uIFRoZSBmYWN0b3J5IGZ1bmN0aW9uIGluamVjdHMgdGhlICckY29tcGlsZScKICAgICAgICAkY29tcGlsZVByb3ZpZGVyLmRpcmVjdGl2ZSgnY29tcGlsZScsIGZ1bmN0aW9uKCRjb21waWxlKSB7CiAgICAgICAgICAvLyBkaXJlY3RpdmUgZmFjdG9yeSBjcmVhdGVzIGEgbGluayBmdW5jdGlvbgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICBzY29wZS4kd2F0Y2goCiAgICAgICAgICAgICAgZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICAgICAgICAgICAvLyB3YXRjaCB0aGUgJ2NvbXBpbGUnIGV4cHJlc3Npb24gZm9yIGNoYW5nZXMKICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS4kZXZhbChhdHRycy5jb21waWxlKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZSAnY29tcGlsZScgZXhwcmVzc2lvbiBjaGFuZ2VzCiAgICAgICAgICAgICAgICAvLyBhc3NpZ24gaXQgaW50byB0aGUgY3VycmVudCBET00KICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCh2YWx1ZSk7CgogICAgICAgICAgICAgICAgLy8gY29tcGlsZSB0aGUgbmV3IERPTSBhbmQgbGluayBpdCB0byB0aGUgY3VycmVudAogICAgICAgICAgICAgICAgLy8gc2NvcGUuCiAgICAgICAgICAgICAgICAvLyBOT1RFOiB3ZSBvbmx5IGNvbXBpbGUgLmNoaWxkTm9kZXMgc28gdGhhdAogICAgICAgICAgICAgICAgLy8gd2UgZG9uJ3QgZ2V0IGludG8gaW5maW5pdGUgbG9vcCBjb21waWxpbmcgb3Vyc2VsdmVzCiAgICAgICAgICAgICAgICAkY29tcGlsZShlbGVtZW50LmNvbnRlbnRzKCkpKHNjb3BlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgICB9OwogICAgICAgIH0pOwogICAgICB9KQogICAgICAuY29udHJvbGxlcignR3JlZXRlckNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICRzY29wZS5uYW1lID0gJ0FuZ3VsYXInOwogICAgICAgICRzY29wZS5odG1sID0gJ0hlbGxvIHt7bmFtZX19JzsKICAgICAgfV0pOwogICAgPC9zY3JpcHQ+CiAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkdyZWV0ZXJDb250cm9sbGVyIj4KICAgICAgPGlucHV0IG5nLW1vZGVsPSJuYW1lIj4gPGJyPgogICAgICA8dGV4dGFyZWEgbmctbW9kZWw9Imh0bWwiPjwvdGV4dGFyZWE+IDxicj4KICAgICAgPGRpdiBjb21waWxlPSJodG1sIj48L2Rpdj4KICAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgIGl0KCdzaG91bGQgYXV0byBjb21waWxlJywgZnVuY3Rpb24oKSB7CiAgICAgICB2YXIgdGV4dGFyZWEgPSAkKCd0ZXh0YXJlYScpOwogICAgICAgdmFyIG91dHB1dCA9ICQoJ2Rpdltjb21waWxlXScpOwogICAgICAgLy8gVGhlIGluaXRpYWwgc3RhdGUgcmVhZHMgJ0hlbGxvIEFuZ3VsYXInLgogICAgICAgZXhwZWN0KG91dHB1dC5nZXRUZXh0KCkpLnRvQmUoJ0hlbGxvIEFuZ3VsYXInKTsKICAgICAgIHRleHRhcmVhLmNsZWFyKCk7CiAgICAgICB0ZXh0YXJlYS5zZW5kS2V5cygne3tuYW1lfX0hJyk7CiAgICAgICBleHBlY3Qob3V0cHV0LmdldFRleHQoKSkudG9CZSgnQW5ndWxhciEnKTsKICAgICB9KTsKICAgPC9maWxlPgogPC9leGFtcGxlPgoKICoKICoKICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBFbGVtZW50IG9yIEhUTUwgc3RyaW5nIHRvIGNvbXBpbGUgaW50byBhIHRlbXBsYXRlIGZ1bmN0aW9uLgogKiBAcGFyYW0ge2Z1bmN0aW9uKGFuZ3VsYXIuU2NvcGUsIGNsb25lQXR0YWNoRm49KX0gdHJhbnNjbHVkZSBmdW5jdGlvbiBhdmFpbGFibGUgdG8gZGlyZWN0aXZlcy4KICogQHBhcmFtIHtudW1iZXJ9IG1heFByaW9yaXR5IG9ubHkgYXBwbHkgZGlyZWN0aXZlcyBsb3dlciB0aGFuIGdpdmVuIHByaW9yaXR5IChPbmx5IGVmZmVjdHMgdGhlCiAqICAgICAgICAgICAgICAgICByb290IGVsZW1lbnQocyksIG5vdCB0aGVpciBjaGlsZHJlbikKICogQHJldHVybnMge2Z1bmN0aW9uKHNjb3BlLCBjbG9uZUF0dGFjaEZuPSl9IGEgbGluayBmdW5jdGlvbiB3aGljaCBpcyB1c2VkIHRvIGJpbmQgdGVtcGxhdGUKICogKGEgRE9NIGVsZW1lbnQvdHJlZSkgdG8gYSBzY29wZS4gV2hlcmU6CiAqCiAqICAqIGBzY29wZWAgLSBBIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIFNjb3BlfSB0byBiaW5kIHRvLgogKiAgKiBgY2xvbmVBdHRhY2hGbmAgLSBJZiBgY2xvbmVBdHRhY2hGbmAgaXMgcHJvdmlkZWQsIHRoZW4gdGhlIGxpbmsgZnVuY3Rpb24gd2lsbCBjbG9uZSB0aGUKICogIGB0ZW1wbGF0ZWAgYW5kIGNhbGwgdGhlIGBjbG9uZUF0dGFjaEZuYCBmdW5jdGlvbiBhbGxvd2luZyB0aGUgY2FsbGVyIHRvIGF0dGFjaCB0aGUKICogIGNsb25lZCBlbGVtZW50cyB0byB0aGUgRE9NIGRvY3VtZW50IGF0IHRoZSBhcHByb3ByaWF0ZSBwbGFjZS4gVGhlIGBjbG9uZUF0dGFjaEZuYCBpcwogKiAgY2FsbGVkIGFzOiA8YnI+IGBjbG9uZUF0dGFjaEZuKGNsb25lZEVsZW1lbnQsIHNjb3BlKWAgd2hlcmU6CiAqCiAqICAgICAgKiBgY2xvbmVkRWxlbWVudGAgLSBpcyBhIGNsb25lIG9mIHRoZSBvcmlnaW5hbCBgZWxlbWVudGAgcGFzc2VkIGludG8gdGhlIGNvbXBpbGVyLgogKiAgICAgICogYHNjb3BlYCAtIGlzIHRoZSBjdXJyZW50IHNjb3BlIHdpdGggd2hpY2ggdGhlIGxpbmtpbmcgZnVuY3Rpb24gaXMgd29ya2luZyB3aXRoLgogKgogKiBDYWxsaW5nIHRoZSBsaW5raW5nIGZ1bmN0aW9uIHJldHVybnMgdGhlIGVsZW1lbnQgb2YgdGhlIHRlbXBsYXRlLiBJdCBpcyBlaXRoZXIgdGhlIG9yaWdpbmFsCiAqIGVsZW1lbnQgcGFzc2VkIGluLCBvciB0aGUgY2xvbmUgb2YgdGhlIGVsZW1lbnQgaWYgdGhlIGBjbG9uZUF0dGFjaEZuYCBpcyBwcm92aWRlZC4KICoKICogQWZ0ZXIgbGlua2luZyB0aGUgdmlldyBpcyBub3QgdXBkYXRlZCB1bnRpbCBhZnRlciBhIGNhbGwgdG8gJGRpZ2VzdCB3aGljaCB0eXBpY2FsbHkgaXMgZG9uZSBieQogKiBBbmd1bGFyIGF1dG9tYXRpY2FsbHkuCiAqCiAqIElmIHlvdSBuZWVkIGFjY2VzcyB0byB0aGUgYm91bmQgdmlldywgdGhlcmUgYXJlIHR3byB3YXlzIHRvIGRvIGl0OgogKgogKiAtIElmIHlvdSBhcmUgbm90IGFza2luZyB0aGUgbGlua2luZyBmdW5jdGlvbiB0byBjbG9uZSB0aGUgdGVtcGxhdGUsIGNyZWF0ZSB0aGUgRE9NIGVsZW1lbnQocykKICogICBiZWZvcmUgeW91IHNlbmQgdGhlbSB0byB0aGUgY29tcGlsZXIgYW5kIGtlZXAgdGhpcyByZWZlcmVuY2UgYXJvdW5kLgogKiAgIGBgYGpzCiAqICAgICB2YXIgZWxlbWVudCA9ICRjb21waWxlKCc8cD57e3RvdGFsfX08L3A+Jykoc2NvcGUpOwogKiAgIGBgYAogKgogKiAtIGlmIG9uIHRoZSBvdGhlciBoYW5kLCB5b3UgbmVlZCB0aGUgZWxlbWVudCB0byBiZSBjbG9uZWQsIHRoZSB2aWV3IHJlZmVyZW5jZSBmcm9tIHRoZSBvcmlnaW5hbAogKiAgIGV4YW1wbGUgd291bGQgbm90IHBvaW50IHRvIHRoZSBjbG9uZSwgYnV0IHJhdGhlciB0byB0aGUgb3JpZ2luYWwgdGVtcGxhdGUgdGhhdCB3YXMgY2xvbmVkLiBJbgogKiAgIHRoaXMgY2FzZSwgeW91IGNhbiBhY2Nlc3MgdGhlIGNsb25lIHZpYSB0aGUgY2xvbmVBdHRhY2hGbjoKICogICBgYGBqcwogKiAgICAgdmFyIHRlbXBsYXRlRWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudCgnPHA+e3t0b3RhbH19PC9wPicpLAogKiAgICAgICAgIHNjb3BlID0gLi4uLjsKICoKICogICAgIHZhciBjbG9uZWRFbGVtZW50ID0gJGNvbXBpbGUodGVtcGxhdGVFbGVtZW50KShzY29wZSwgZnVuY3Rpb24oY2xvbmVkRWxlbWVudCwgc2NvcGUpIHsKICogICAgICAgLy9hdHRhY2ggdGhlIGNsb25lIHRvIERPTSBkb2N1bWVudCBhdCB0aGUgcmlnaHQgcGxhY2UKICogICAgIH0pOwogKgogKiAgICAgLy9ub3cgd2UgaGF2ZSByZWZlcmVuY2UgdG8gdGhlIGNsb25lZCBET00gdmlhIGBjbG9uZWRFbGVtZW50YAogKiAgIGBgYAogKgogKgogKiBGb3IgaW5mb3JtYXRpb24gb24gaG93IHRoZSBjb21waWxlciB3b3Jrcywgc2VlIHRoZQogKiB7QGxpbmsgZ3VpZGUvY29tcGlsZXIgQW5ndWxhciBIVE1MIENvbXBpbGVyfSBzZWN0aW9uIG9mIHRoZSBEZXZlbG9wZXIgR3VpZGUuCiAqLwoKdmFyICRjb21waWxlTWluRXJyID0gbWluRXJyKCckY29tcGlsZScpOwoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkY29tcGlsZVByb3ZpZGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKi8KJENvbXBpbGVQcm92aWRlci4kaW5qZWN0ID0gWyckcHJvdmlkZScsICckJHNhbml0aXplVXJpUHJvdmlkZXInXTsKZnVuY3Rpb24gJENvbXBpbGVQcm92aWRlcigkcHJvdmlkZSwgJCRzYW5pdGl6ZVVyaVByb3ZpZGVyKSB7CiAgdmFyIGhhc0RpcmVjdGl2ZXMgPSB7fSwKICAgICAgU3VmZml4ID0gJ0RpcmVjdGl2ZScsCiAgICAgIENPTU1FTlRfRElSRUNUSVZFX1JFR0VYUCA9IC9eXHMqZGlyZWN0aXZlXDpccyooW1xkXHdfXC1dKylccysoLiopJC8sCiAgICAgIENMQVNTX0RJUkVDVElWRV9SRUdFWFAgPSAvKChbXGRcd19cLV0rKSg/Olw6KFteO10rKSk/Oz8pLywKICAgICAgQUxMX09SX05PVEhJTkdfQVRUUlMgPSBtYWtlTWFwKCduZ1NyYyxuZ1NyY3NldCxzcmMsc3Jjc2V0JyksCiAgICAgIFJFUVVJUkVfUFJFRklYX1JFR0VYUCA9IC9eKD86KFxeXF4/KT8oXD8pPyhcXlxePyk/KT8vOwoKICAvLyBSZWY6IGh0dHA6Ly9kZXZlbG9wZXJzLndoYXR3Zy5vcmcvd2ViYXBwYXBpcy5odG1sI2V2ZW50LWhhbmRsZXItaWRsLWF0dHJpYnV0ZXMKICAvLyBUaGUgYXNzdW1wdGlvbiBpcyB0aGF0IGZ1dHVyZSBET00gZXZlbnQgYXR0cmlidXRlIG5hbWVzIHdpbGwgYmVnaW4gd2l0aAogIC8vICdvbicgYW5kIGJlIGNvbXBvc2VkIG9mIG9ubHkgRW5nbGlzaCBsZXR0ZXJzLgogIHZhciBFVkVOVF9IQU5ETEVSX0FUVFJfUkVHRVhQID0gL14ob25bYS16XSt8Zm9ybWFjdGlvbikkLzsKCiAgZnVuY3Rpb24gcGFyc2VJc29sYXRlQmluZGluZ3Moc2NvcGUsIGRpcmVjdGl2ZU5hbWUpIHsKICAgIHZhciBMT0NBTF9SRUdFWFAgPSAvXlxzKihbQD0mXSkoXD8/KVxzKihcdyopXHMqJC87CgogICAgdmFyIGJpbmRpbmdzID0ge307CgogICAgZm9yRWFjaChzY29wZSwgZnVuY3Rpb24oZGVmaW5pdGlvbiwgc2NvcGVOYW1lKSB7CiAgICAgIHZhciBtYXRjaCA9IGRlZmluaXRpb24ubWF0Y2goTE9DQUxfUkVHRVhQKTsKCiAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycignaXNjcCcsCiAgICAgICAgICAgICJJbnZhbGlkIGlzb2xhdGUgc2NvcGUgZGVmaW5pdGlvbiBmb3IgZGlyZWN0aXZlICd7MH0nLiIgKwogICAgICAgICAgICAiIERlZmluaXRpb246IHsuLi4gezF9OiAnezJ9JyAuLi59IiwKICAgICAgICAgICAgZGlyZWN0aXZlTmFtZSwgc2NvcGVOYW1lLCBkZWZpbml0aW9uKTsKICAgICAgfQoKICAgICAgYmluZGluZ3Nbc2NvcGVOYW1lXSA9IHsKICAgICAgICBhdHRyTmFtZTogbWF0Y2hbM10gfHwgc2NvcGVOYW1lLAogICAgICAgIG1vZGU6IG1hdGNoWzFdLAogICAgICAgIG9wdGlvbmFsOiBtYXRjaFsyXSA9PT0gJz8nCiAgICAgIH07CiAgICB9KTsKCiAgICByZXR1cm4gYmluZGluZ3M7CiAgfQoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmVnaXN0ZXIgYSBuZXcgZGlyZWN0aXZlIHdpdGggdGhlIGNvbXBpbGVyLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fSBuYW1lIE5hbWUgb2YgdGhlIGRpcmVjdGl2ZSBpbiBjYW1lbC1jYXNlIChpLmUuIDxjb2RlPm5nQmluZDwvY29kZT4gd2hpY2gKICAgKiAgICB3aWxsIG1hdGNoIGFzIDxjb2RlPm5nLWJpbmQ8L2NvZGU+KSwgb3IgYW4gb2JqZWN0IG1hcCBvZiBkaXJlY3RpdmVzIHdoZXJlIHRoZSBrZXlzIGFyZSB0aGUKICAgKiAgICBuYW1lcyBhbmQgdGhlIHZhbHVlcyBhcmUgdGhlIGZhY3Rvcmllcy4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufEFycmF5fSBkaXJlY3RpdmVGYWN0b3J5IEFuIGluamVjdGFibGUgZGlyZWN0aXZlIGZhY3RvcnkgZnVuY3Rpb24uIFNlZQogICAqICAgIHtAbGluayBndWlkZS9kaXJlY3RpdmV9IGZvciBtb3JlIGluZm8uCiAgICogQHJldHVybnMge25nLiRjb21waWxlUHJvdmlkZXJ9IFNlbGYgZm9yIGNoYWluaW5nLgogICAqLwogICB0aGlzLmRpcmVjdGl2ZSA9IGZ1bmN0aW9uIHJlZ2lzdGVyRGlyZWN0aXZlKG5hbWUsIGRpcmVjdGl2ZUZhY3RvcnkpIHsKICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KG5hbWUsICdkaXJlY3RpdmUnKTsKICAgIGlmIChpc1N0cmluZyhuYW1lKSkgewogICAgICBhc3NlcnRBcmcoZGlyZWN0aXZlRmFjdG9yeSwgJ2RpcmVjdGl2ZUZhY3RvcnknKTsKICAgICAgaWYgKCFoYXNEaXJlY3RpdmVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgaGFzRGlyZWN0aXZlc1tuYW1lXSA9IFtdOwogICAgICAgICRwcm92aWRlLmZhY3RvcnkobmFtZSArIFN1ZmZpeCwgWyckaW5qZWN0b3InLCAnJGV4Y2VwdGlvbkhhbmRsZXInLAogICAgICAgICAgZnVuY3Rpb24oJGluamVjdG9yLCAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgICAgICAgICB2YXIgZGlyZWN0aXZlcyA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKGhhc0RpcmVjdGl2ZXNbbmFtZV0sIGZ1bmN0aW9uKGRpcmVjdGl2ZUZhY3RvcnksIGluZGV4KSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHZhciBkaXJlY3RpdmUgPSAkaW5qZWN0b3IuaW52b2tlKGRpcmVjdGl2ZUZhY3RvcnkpOwogICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oZGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgICBkaXJlY3RpdmUgPSB7IGNvbXBpbGU6IHZhbHVlRm4oZGlyZWN0aXZlKSB9OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghZGlyZWN0aXZlLmNvbXBpbGUgJiYgZGlyZWN0aXZlLmxpbmspIHsKICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLmNvbXBpbGUgPSB2YWx1ZUZuKGRpcmVjdGl2ZS5saW5rKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5wcmlvcml0eSA9IGRpcmVjdGl2ZS5wcmlvcml0eSB8fCAwOwogICAgICAgICAgICAgICAgZGlyZWN0aXZlLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgICAgICBkaXJlY3RpdmUubmFtZSA9IGRpcmVjdGl2ZS5uYW1lIHx8IG5hbWU7CiAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlIHx8IChkaXJlY3RpdmUuY29udHJvbGxlciAmJiBkaXJlY3RpdmUubmFtZSk7CiAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVzdHJpY3QgPSBkaXJlY3RpdmUucmVzdHJpY3QgfHwgJ0VBJzsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChkaXJlY3RpdmUuc2NvcGUpKSB7CiAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS4kJGlzb2xhdGVCaW5kaW5ncyA9IHBhcnNlSXNvbGF0ZUJpbmRpbmdzKGRpcmVjdGl2ZS5zY29wZSwgZGlyZWN0aXZlLm5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlyZWN0aXZlcy5wdXNoKGRpcmVjdGl2ZSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGRpcmVjdGl2ZXM7CiAgICAgICAgICB9XSk7CiAgICAgIH0KICAgICAgaGFzRGlyZWN0aXZlc1tuYW1lXS5wdXNoKGRpcmVjdGl2ZUZhY3RvcnkpOwogICAgfSBlbHNlIHsKICAgICAgZm9yRWFjaChuYW1lLCByZXZlcnNlUGFyYW1zKHJlZ2lzdGVyRGlyZWN0aXZlKSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRjb21waWxlUHJvdmlkZXIjYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmV0cmlldmVzIG9yIG92ZXJyaWRlcyB0aGUgZGVmYXVsdCByZWd1bGFyIGV4cHJlc3Npb24gdGhhdCBpcyB1c2VkIGZvciB3aGl0ZWxpc3Rpbmcgb2Ygc2FmZQogICAqIHVybHMgZHVyaW5nIGFbaHJlZl0gc2FuaXRpemF0aW9uLgogICAqCiAgICogVGhlIHNhbml0aXphdGlvbiBpcyBhIHNlY3VyaXR5IG1lYXN1cmUgYWltZWQgYXQgcHJldmVudCBYU1MgYXR0YWNrcyB2aWEgaHRtbCBsaW5rcy4KICAgKgogICAqIEFueSB1cmwgYWJvdXQgdG8gYmUgYXNzaWduZWQgdG8gYVtocmVmXSB2aWEgZGF0YS1iaW5kaW5nIGlzIGZpcnN0IG5vcm1hbGl6ZWQgYW5kIHR1cm5lZCBpbnRvCiAgICogYW4gYWJzb2x1dGUgdXJsLiBBZnRlcndhcmRzLCB0aGUgdXJsIGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgYGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0YAogICAqIHJlZ3VsYXIgZXhwcmVzc2lvbi4gSWYgYSBtYXRjaCBpcyBmb3VuZCwgdGhlIG9yaWdpbmFsIHVybCBpcyB3cml0dGVuIGludG8gdGhlIGRvbS4gT3RoZXJ3aXNlLAogICAqIHRoZSBhYnNvbHV0ZSB1cmwgaXMgcHJlZml4ZWQgd2l0aCBgJ3Vuc2FmZTonYCBzdHJpbmcgYW5kIG9ubHkgdGhlbiBpcyBpdCB3cml0dGVuIGludG8gdGhlIERPTS4KICAgKgogICAqIEBwYXJhbSB7UmVnRXhwPX0gcmVnZXhwIE5ldyByZWdleHAgdG8gd2hpdGVsaXN0IHVybHMgd2l0aC4KICAgKiBAcmV0dXJucyB7UmVnRXhwfG5nLiRjb21waWxlUHJvdmlkZXJ9IEN1cnJlbnQgUmVnRXhwIGlmIGNhbGxlZCB3aXRob3V0IHZhbHVlIG9yIHNlbGYgZm9yCiAgICogICAgY2hhaW5pbmcgb3RoZXJ3aXNlLgogICAqLwogIHRoaXMuYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSBmdW5jdGlvbihyZWdleHApIHsKICAgIGlmIChpc0RlZmluZWQocmVnZXhwKSkgewogICAgICAkJHNhbml0aXplVXJpUHJvdmlkZXIuYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QocmVnZXhwKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gJCRzYW5pdGl6ZVVyaVByb3ZpZGVyLmFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0KCk7CiAgICB9CiAgfTsKCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkY29tcGlsZVByb3ZpZGVyI2ltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdAogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZXRyaWV2ZXMgb3Igb3ZlcnJpZGVzIHRoZSBkZWZhdWx0IHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgZm9yIHdoaXRlbGlzdGluZyBvZiBzYWZlCiAgICogdXJscyBkdXJpbmcgaW1nW3NyY10gc2FuaXRpemF0aW9uLgogICAqCiAgICogVGhlIHNhbml0aXphdGlvbiBpcyBhIHNlY3VyaXR5IG1lYXN1cmUgYWltZWQgYXQgcHJldmVudCBYU1MgYXR0YWNrcyB2aWEgaHRtbCBsaW5rcy4KICAgKgogICAqIEFueSB1cmwgYWJvdXQgdG8gYmUgYXNzaWduZWQgdG8gaW1nW3NyY10gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50bwogICAqIGFuIGFic29sdXRlIHVybC4gQWZ0ZXJ3YXJkcywgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3RgCiAgICogcmVndWxhciBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kLCB0aGUgb3JpZ2luYWwgdXJsIGlzIHdyaXR0ZW4gaW50byB0aGUgZG9tLiBPdGhlcndpc2UsCiAgICogdGhlIGFic29sdXRlIHVybCBpcyBwcmVmaXhlZCB3aXRoIGAndW5zYWZlOidgIHN0cmluZyBhbmQgb25seSB0aGVuIGlzIGl0IHdyaXR0ZW4gaW50byB0aGUgRE9NLgogICAqCiAgICogQHBhcmFtIHtSZWdFeHA9fSByZWdleHAgTmV3IHJlZ2V4cCB0byB3aGl0ZWxpc3QgdXJscyB3aXRoLgogICAqIEByZXR1cm5zIHtSZWdFeHB8bmcuJGNvbXBpbGVQcm92aWRlcn0gQ3VycmVudCBSZWdFeHAgaWYgY2FsbGVkIHdpdGhvdXQgdmFsdWUgb3Igc2VsZiBmb3IKICAgKiAgICBjaGFpbmluZyBvdGhlcndpc2UuCiAgICovCiAgdGhpcy5pbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSBmdW5jdGlvbihyZWdleHApIHsKICAgIGlmIChpc0RlZmluZWQocmVnZXhwKSkgewogICAgICAkJHNhbml0aXplVXJpUHJvdmlkZXIuaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0KHJlZ2V4cCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICQkc2FuaXRpemVVcmlQcm92aWRlci5pbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QoKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgICRjb21waWxlUHJvdmlkZXIjZGVidWdJbmZvRW5hYmxlZAogICAqCiAgICogQHBhcmFtIHtib29sZWFuPX0gZW5hYmxlZCB1cGRhdGUgdGhlIGRlYnVnSW5mb0VuYWJsZWQgc3RhdGUgaWYgcHJvdmlkZWQsIG90aGVyd2lzZSBqdXN0IHJldHVybiB0aGUKICAgKiBjdXJyZW50IGRlYnVnSW5mb0VuYWJsZWQgc3RhdGUKICAgKiBAcmV0dXJucyB7Kn0gY3VycmVudCB2YWx1ZSBpZiB1c2VkIGFzIGdldHRlciBvciBpdHNlbGYgKGNoYWluaW5nKSBpZiB1c2VkIGFzIHNldHRlcgogICAqCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENhbGwgdGhpcyBtZXRob2QgdG8gZW5hYmxlL2Rpc2FibGUgdmFyaW91cyBkZWJ1ZyBydW50aW1lIGluZm9ybWF0aW9uIGluIHRoZSBjb21waWxlciBzdWNoIGFzIGFkZGluZwogICAqIGJpbmRpbmcgaW5mb3JtYXRpb24gYW5kIGEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50IHNjb3BlIG9uIHRvIERPTSBlbGVtZW50cy4KICAgKiBJZiBlbmFibGVkLCB0aGUgY29tcGlsZXIgd2lsbCBhZGQgdGhlIGZvbGxvd2luZyB0byBET00gZWxlbWVudHMgdGhhdCBoYXZlIGJlZW4gYm91bmQgdG8gdGhlIHNjb3BlCiAgICogKiBgbmctYmluZGluZ2AgQ1NTIGNsYXNzCiAgICogKiBgJGJpbmRpbmdgIGRhdGEgcHJvcGVydHkgY29udGFpbmluZyBhbiBhcnJheSBvZiB0aGUgYmluZGluZyBleHByZXNzaW9ucwogICAqCiAgICogWW91IG1heSB3YW50IHRvIHVzZSB0aGlzIGluIHByb2R1Y3Rpb24gZm9yIGEgc2lnbmlmaWNhbnQgcGVyZm9ybWFuY2UgYm9vc3QuIFNlZQogICAqIHtAbGluayBndWlkZS9wcm9kdWN0aW9uI2Rpc2FibGluZy1kZWJ1Zy1kYXRhIERpc2FibGluZyBEZWJ1ZyBEYXRhfSBmb3IgbW9yZS4KICAgKgogICAqIFRoZSBkZWZhdWx0IHZhbHVlIGlzIHRydWUuCiAgICovCiAgdmFyIGRlYnVnSW5mb0VuYWJsZWQgPSB0cnVlOwogIHRoaXMuZGVidWdJbmZvRW5hYmxlZCA9IGZ1bmN0aW9uKGVuYWJsZWQpIHsKICAgIGlmKGlzRGVmaW5lZChlbmFibGVkKSkgewogICAgICBkZWJ1Z0luZm9FbmFibGVkID0gZW5hYmxlZDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICByZXR1cm4gZGVidWdJbmZvRW5hYmxlZDsKICB9OwoKICB0aGlzLiRnZXQgPSBbCiAgICAgICAgICAgICckaW5qZWN0b3InLCAnJGludGVycG9sYXRlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyR0ZW1wbGF0ZVJlcXVlc3QnLCAnJHBhcnNlJywKICAgICAgICAgICAgJyRjb250cm9sbGVyJywgJyRyb290U2NvcGUnLCAnJGRvY3VtZW50JywgJyRzY2UnLCAnJGFuaW1hdGUnLCAnJCRzYW5pdGl6ZVVyaScsCiAgICBmdW5jdGlvbigkaW5qZWN0b3IsICAgJGludGVycG9sYXRlLCAgICRleGNlcHRpb25IYW5kbGVyLCAgICR0ZW1wbGF0ZVJlcXVlc3QsICAgJHBhcnNlLAogICAgICAgICAgICAgJGNvbnRyb2xsZXIsICAgJHJvb3RTY29wZSwgICAkZG9jdW1lbnQsICAgJHNjZSwgICAkYW5pbWF0ZSwgICAkJHNhbml0aXplVXJpKSB7CgogICAgdmFyIEF0dHJpYnV0ZXMgPSBmdW5jdGlvbihlbGVtZW50LCBhdHRyaWJ1dGVzVG9Db3B5KSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzVG9Db3B5KSB7CiAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhhdHRyaWJ1dGVzVG9Db3B5KTsKICAgICAgICB2YXIgaSwgbCwga2V5OwoKICAgICAgICBmb3IgKGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIGtleSA9IGtleXNbaV07CiAgICAgICAgICB0aGlzW2tleV0gPSBhdHRyaWJ1dGVzVG9Db3B5W2tleV07CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuJGF0dHIgPSB7fTsKICAgICAgfQoKICAgICAgdGhpcy4kJGVsZW1lbnQgPSBlbGVtZW50OwogICAgfTsKCiAgICBBdHRyaWJ1dGVzLnByb3RvdHlwZSA9IHsKICAgICAgJG5vcm1hbGl6ZTogZGlyZWN0aXZlTm9ybWFsaXplLAoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRhZGRDbGFzcwogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogQWRkcyB0aGUgQ1NTIGNsYXNzIHZhbHVlIHNwZWNpZmllZCBieSB0aGUgY2xhc3NWYWwgcGFyYW1ldGVyIHRvIHRoZSBlbGVtZW50LiBJZiBhbmltYXRpb25zCiAgICAgICAqIGFyZSBlbmFibGVkIHRoZW4gYW4gYW5pbWF0aW9uIHdpbGwgYmUgdHJpZ2dlcmVkIGZvciB0aGUgY2xhc3MgYWRkaXRpb24uCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc1ZhbCBUaGUgY2xhc3NOYW1lIHZhbHVlIHRoYXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgKi8KICAgICAgJGFkZENsYXNzIDogZnVuY3Rpb24oY2xhc3NWYWwpIHsKICAgICAgICBpZihjbGFzc1ZhbCAmJiBjbGFzc1ZhbC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAkYW5pbWF0ZS5hZGRDbGFzcyh0aGlzLiQkZWxlbWVudCwgY2xhc3NWYWwpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRyZW1vdmVDbGFzcwogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogUmVtb3ZlcyB0aGUgQ1NTIGNsYXNzIHZhbHVlIHNwZWNpZmllZCBieSB0aGUgY2xhc3NWYWwgcGFyYW1ldGVyIGZyb20gdGhlIGVsZW1lbnQuIElmCiAgICAgICAqIGFuaW1hdGlvbnMgYXJlIGVuYWJsZWQgdGhlbiBhbiBhbmltYXRpb24gd2lsbCBiZSB0cmlnZ2VyZWQgZm9yIHRoZSBjbGFzcyByZW1vdmFsLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NWYWwgVGhlIGNsYXNzTmFtZSB2YWx1ZSB0aGF0IHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50CiAgICAgICAqLwogICAgICAkcmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihjbGFzc1ZhbCkgewogICAgICAgIGlmKGNsYXNzVmFsICYmIGNsYXNzVmFsLmxlbmd0aCA+IDApIHsKICAgICAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKHRoaXMuJCRlbGVtZW50LCBjbGFzc1ZhbCk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJHVwZGF0ZUNsYXNzCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBBZGRzIGFuZCByZW1vdmVzIHRoZSBhcHByb3ByaWF0ZSBDU1MgY2xhc3MgdmFsdWVzIHRvIHRoZSBlbGVtZW50IGJhc2VkIG9uIHRoZSBkaWZmZXJlbmNlCiAgICAgICAqIGJldHdlZW4gdGhlIG5ldyBhbmQgb2xkIENTUyBjbGFzcyB2YWx1ZXMgKHNwZWNpZmllZCBhcyBuZXdDbGFzc2VzIGFuZCBvbGRDbGFzc2VzKS4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5ld0NsYXNzZXMgVGhlIGN1cnJlbnQgQ1NTIGNsYXNzTmFtZSB2YWx1ZQogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gb2xkQ2xhc3NlcyBUaGUgZm9ybWVyIENTUyBjbGFzc05hbWUgdmFsdWUKICAgICAgICovCiAgICAgICR1cGRhdGVDbGFzcyA6IGZ1bmN0aW9uKG5ld0NsYXNzZXMsIG9sZENsYXNzZXMpIHsKICAgICAgICB2YXIgdG9BZGQgPSB0b2tlbkRpZmZlcmVuY2UobmV3Q2xhc3Nlcywgb2xkQ2xhc3Nlcyk7CiAgICAgICAgaWYgKHRvQWRkICYmIHRvQWRkLmxlbmd0aCkgewogICAgICAgICAgJGFuaW1hdGUuYWRkQ2xhc3ModGhpcy4kJGVsZW1lbnQsIHRvQWRkKTsKICAgICAgICB9CgogICAgICAgIHZhciB0b1JlbW92ZSA9IHRva2VuRGlmZmVyZW5jZShvbGRDbGFzc2VzLCBuZXdDbGFzc2VzKTsKICAgICAgICBpZiAodG9SZW1vdmUgJiYgdG9SZW1vdmUubGVuZ3RoKSB7CiAgICAgICAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcyh0aGlzLiQkZWxlbWVudCwgdG9SZW1vdmUpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBTZXQgYSBub3JtYWxpemVkIGF0dHJpYnV0ZSBvbiB0aGUgZWxlbWVudCBpbiBhIHdheSBzdWNoIHRoYXQgYWxsIGRpcmVjdGl2ZXMKICAgICAgICogY2FuIHNoYXJlIHRoZSBhdHRyaWJ1dGUuIFRoaXMgZnVuY3Rpb24gcHJvcGVybHkgaGFuZGxlcyBib29sZWFuIGF0dHJpYnV0ZXMuCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgTm9ybWFsaXplZCBrZXkuIChpZSBuZ0F0dHJpYnV0ZSkKICAgICAgICogQHBhcmFtIHtzdHJpbmd8Ym9vbGVhbn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNldC4gSWYgYG51bGxgIGF0dHJpYnV0ZSB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHdyaXRlQXR0ciBJZiBmYWxzZSwgZG9lcyBub3Qgd3JpdGUgdGhlIHZhbHVlIHRvIERPTSBlbGVtZW50IGF0dHJpYnV0ZS4KICAgICAgICogICAgIERlZmF1bHRzIHRvIHRydWUuCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gYXR0ck5hbWUgT3B0aW9uYWwgbm9uZSBub3JtYWxpemVkIG5hbWUuIERlZmF1bHRzIHRvIGtleS4KICAgICAgICovCiAgICAgICRzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUsIHdyaXRlQXR0ciwgYXR0ck5hbWUpIHsKICAgICAgICAvLyBUT0RPOiBkZWNpZGUgd2hldGhlciBvciBub3QgdG8gdGhyb3cgYW4gZXJyb3IgaWYgImNsYXNzIgogICAgICAgIC8vaXMgc2V0IHRocm91Z2ggdGhpcyBmdW5jdGlvbiBzaW5jZSBpdCBtYXkgY2F1c2UgJHVwZGF0ZUNsYXNzIHRvCiAgICAgICAgLy9iZWNvbWUgdW5zdGFibGUuCgogICAgICAgIHZhciBub2RlID0gdGhpcy4kJGVsZW1lbnRbMF0sCiAgICAgICAgICAgIGJvb2xlYW5LZXkgPSBnZXRCb29sZWFuQXR0ck5hbWUobm9kZSwga2V5KSwKICAgICAgICAgICAgYWxpYXNlZEtleSA9IGdldEFsaWFzZWRBdHRyTmFtZShub2RlLCBrZXkpLAogICAgICAgICAgICBvYnNlcnZlciA9IGtleSwKICAgICAgICAgICAgbm9ybWFsaXplZFZhbCwKICAgICAgICAgICAgbm9kZU5hbWU7CgogICAgICAgIGlmIChib29sZWFuS2V5KSB7CiAgICAgICAgICB0aGlzLiQkZWxlbWVudC5wcm9wKGtleSwgdmFsdWUpOwogICAgICAgICAgYXR0ck5hbWUgPSBib29sZWFuS2V5OwogICAgICAgIH0gZWxzZSBpZihhbGlhc2VkS2V5KSB7CiAgICAgICAgICB0aGlzW2FsaWFzZWRLZXldID0gdmFsdWU7CiAgICAgICAgICBvYnNlcnZlciA9IGFsaWFzZWRLZXk7CiAgICAgICAgfQoKICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZTsKCiAgICAgICAgLy8gdHJhbnNsYXRlIG5vcm1hbGl6ZWQga2V5IHRvIGFjdHVhbCBrZXkKICAgICAgICBpZiAoYXR0ck5hbWUpIHsKICAgICAgICAgIHRoaXMuJGF0dHJba2V5XSA9IGF0dHJOYW1lOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhdHRyTmFtZSA9IHRoaXMuJGF0dHJba2V5XTsKICAgICAgICAgIGlmICghYXR0ck5hbWUpIHsKICAgICAgICAgICAgdGhpcy4kYXR0cltrZXldID0gYXR0ck5hbWUgPSBzbmFrZV9jYXNlKGtleSwgJy0nKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIG5vZGVOYW1lID0gbm9kZU5hbWVfKHRoaXMuJCRlbGVtZW50KTsKCiAgICAgICAgaWYgKChub2RlTmFtZSA9PT0gJ2EnICYmIGtleSA9PT0gJ2hyZWYnKSB8fAogICAgICAgICAgICAobm9kZU5hbWUgPT09ICdpbWcnICYmIGtleSA9PT0gJ3NyYycpKSB7CiAgICAgICAgICAvLyBzYW5pdGl6ZSBhW2hyZWZdIGFuZCBpbWdbc3JjXSB2YWx1ZXMKICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlID0gJCRzYW5pdGl6ZVVyaSh2YWx1ZSwga2V5ID09PSAnc3JjJyk7CiAgICAgICAgfSBlbHNlIGlmIChub2RlTmFtZSA9PT0gJ2ltZycgJiYga2V5ID09PSAnc3Jjc2V0JykgewogICAgICAgICAgLy8gc2FuaXRpemUgaW1nW3NyY3NldF0gdmFsdWVzCiAgICAgICAgICB2YXIgcmVzdWx0ID0gIiI7CgogICAgICAgICAgLy8gZmlyc3QgY2hlY2sgaWYgdGhlcmUgYXJlIHNwYWNlcyBiZWNhdXNlIGl0J3Mgbm90IHRoZSBzYW1lIHBhdHRlcm4KICAgICAgICAgIHZhciB0cmltbWVkU3Jjc2V0ID0gdHJpbSh2YWx1ZSk7CiAgICAgICAgICAvLyAgICAgICAgICAgICAgICAoICAgOTk5eCAgICx8ICAgOTk5dyAgICx8ICAgLHwsICAgKQogICAgICAgICAgdmFyIHNyY1BhdHRlcm4gPSAvKFxzK1xkK3hccyosfFxzK1xkK3dccyosfFxzKyx8LFxzKykvOwogICAgICAgICAgdmFyIHBhdHRlcm4gPSAvXHMvLnRlc3QodHJpbW1lZFNyY3NldCkgPyBzcmNQYXR0ZXJuIDogLygsKS87CgogICAgICAgICAgLy8gc3BsaXQgc3Jjc2V0IGludG8gdHVwbGUgb2YgdXJpIGFuZCBkZXNjcmlwdG9yIGV4Y2VwdCBmb3IgdGhlIGxhc3QgaXRlbQogICAgICAgICAgdmFyIHJhd1VyaXMgPSB0cmltbWVkU3Jjc2V0LnNwbGl0KHBhdHRlcm4pOwoKICAgICAgICAgIC8vIGZvciBlYWNoIHR1cGxlcwogICAgICAgICAgdmFyIG5iclVyaXNXaXRoMnBhcnRzID0gTWF0aC5mbG9vcihyYXdVcmlzLmxlbmd0aCAvIDIpOwogICAgICAgICAgZm9yICh2YXIgaT0wOyBpPG5iclVyaXNXaXRoMnBhcnRzOyBpKyspIHsKICAgICAgICAgICAgdmFyIGlubmVySWR4ID0gaSoyOwogICAgICAgICAgICAvLyBzYW5pdGl6ZSB0aGUgdXJpCiAgICAgICAgICAgIHJlc3VsdCArPSAkJHNhbml0aXplVXJpKHRyaW0oIHJhd1VyaXNbaW5uZXJJZHhdKSwgdHJ1ZSk7CiAgICAgICAgICAgIC8vIGFkZCB0aGUgZGVzY3JpcHRvcgogICAgICAgICAgICByZXN1bHQgKz0gKCAiICIgKyB0cmltKHJhd1VyaXNbaW5uZXJJZHgrMV0pKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBzcGxpdCB0aGUgbGFzdCBpdGVtIGludG8gdXJpIGFuZCBkZXNjcmlwdG9yCiAgICAgICAgICB2YXIgbGFzdFR1cGxlID0gdHJpbShyYXdVcmlzW2kqMl0pLnNwbGl0KC9ccy8pOwoKICAgICAgICAgIC8vIHNhbml0aXplIHRoZSBsYXN0IHVyaQogICAgICAgICAgcmVzdWx0ICs9ICQkc2FuaXRpemVVcmkodHJpbShsYXN0VHVwbGVbMF0pLCB0cnVlKTsKCiAgICAgICAgICAvLyBhbmQgYWRkIHRoZSBsYXN0IGRlc2NyaXB0b3IgaWYgYW55CiAgICAgICAgICBpZiggbGFzdFR1cGxlLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICByZXN1bHQgKz0gKCIgIiArIHRyaW0obGFzdFR1cGxlWzFdKSk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZSA9IHJlc3VsdDsKICAgICAgICB9CgogICAgICAgIGlmICh3cml0ZUF0dHIgIT09IGZhbHNlKSB7CiAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aGlzLiQkZWxlbWVudC5yZW1vdmVBdHRyKGF0dHJOYW1lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50LmF0dHIoYXR0ck5hbWUsIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIGZpcmUgb2JzZXJ2ZXJzCiAgICAgICAgdmFyICQkb2JzZXJ2ZXJzID0gdGhpcy4kJG9ic2VydmVyczsKICAgICAgICAkJG9ic2VydmVycyAmJiBmb3JFYWNoKCQkb2JzZXJ2ZXJzW29ic2VydmVyXSwgZnVuY3Rpb24oZm4pIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGZuKHZhbHVlKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJG9ic2VydmUKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIE9ic2VydmVzIGFuIGludGVycG9sYXRlZCBhdHRyaWJ1dGUuCiAgICAgICAqCiAgICAgICAqIFRoZSBvYnNlcnZlciBmdW5jdGlvbiB3aWxsIGJlIGludm9rZWQgb25jZSBkdXJpbmcgdGhlIG5leHQgYCRkaWdlc3RgIGZvbGxvd2luZwogICAgICAgKiBjb21waWxhdGlvbi4gVGhlIG9ic2VydmVyIGlzIHRoZW4gaW52b2tlZCB3aGVuZXZlciB0aGUgaW50ZXJwb2xhdGVkIHZhbHVlCiAgICAgICAqIGNoYW5nZXMuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgTm9ybWFsaXplZCBrZXkuIChpZSBuZ0F0dHJpYnV0ZSkgLgogICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGludGVycG9sYXRlZFZhbHVlKX0gZm4gRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlcgogICAgICAgICAgICAgICAgdGhlIGludGVycG9sYXRlZCB2YWx1ZSBvZiB0aGUgYXR0cmlidXRlIGNoYW5nZXMuCiAgICAgICAqICAgICAgICBTZWUgdGhlIHtAbGluayBndWlkZS9kaXJlY3RpdmUjdGV4dC1hbmQtYXR0cmlidXRlLWJpbmRpbmdzIERpcmVjdGl2ZXN9IGd1aWRlIGZvciBtb3JlIGluZm8uCiAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBSZXR1cm5zIGEgZGVyZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIHRoaXMgb2JzZXJ2ZXIuCiAgICAgICAqLwogICAgICAkb2JzZXJ2ZTogZnVuY3Rpb24oa2V5LCBmbikgewogICAgICAgIHZhciBhdHRycyA9IHRoaXMsCiAgICAgICAgICAgICQkb2JzZXJ2ZXJzID0gKGF0dHJzLiQkb2JzZXJ2ZXJzIHx8IChhdHRycy4kJG9ic2VydmVycyA9IGNyZWF0ZU1hcCgpKSksCiAgICAgICAgICAgIGxpc3RlbmVycyA9ICgkJG9ic2VydmVyc1trZXldIHx8ICgkJG9ic2VydmVyc1trZXldID0gW10pKTsKCiAgICAgICAgbGlzdGVuZXJzLnB1c2goZm4pOwogICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICghbGlzdGVuZXJzLiQkaW50ZXIpIHsKICAgICAgICAgICAgLy8gbm8gb25lIHJlZ2lzdGVyZWQgYXR0cmlidXRlIGludGVycG9sYXRpb24gZnVuY3Rpb24sIHNvIGxldHMgY2FsbCBpdCBtYW51YWxseQogICAgICAgICAgICBmbihhdHRyc1trZXldKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgYXJyYXlSZW1vdmUobGlzdGVuZXJzLCBmbik7CiAgICAgICAgfTsKICAgICAgfQogICAgfTsKCgogICAgZnVuY3Rpb24gc2FmZUFkZENsYXNzKCRlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgdHJ5IHsKICAgICAgICAkZWxlbWVudC5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAvLyBpZ25vcmUsIHNpbmNlIGl0IG1lYW5zIHRoYXQgd2UgYXJlIHRyeWluZyB0byBzZXQgY2xhc3Mgb24KICAgICAgICAvLyBTVkcgZWxlbWVudCwgd2hlcmUgY2xhc3MgbmFtZSBpcyByZWFkLW9ubHkuCiAgICAgIH0KICAgIH0KCgogICAgdmFyIHN0YXJ0U3ltYm9sID0gJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sKCksCiAgICAgICAgZW5kU3ltYm9sID0gJGludGVycG9sYXRlLmVuZFN5bWJvbCgpLAogICAgICAgIGRlbm9ybWFsaXplVGVtcGxhdGUgPSAoc3RhcnRTeW1ib2wgPT0gJ3t7JyB8fCBlbmRTeW1ib2wgID09ICd9fScpCiAgICAgICAgICAgID8gaWRlbnRpdHkKICAgICAgICAgICAgOiBmdW5jdGlvbiBkZW5vcm1hbGl6ZVRlbXBsYXRlKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlLnJlcGxhY2UoL1x7XHsvZywgc3RhcnRTeW1ib2wpLnJlcGxhY2UoL319L2csIGVuZFN5bWJvbCk7CiAgICAgICAgfSwKICAgICAgICBOR19BVFRSX0JJTkRJTkcgPSAvXm5nQXR0cltBLVpdLzsKCiAgICBjb21waWxlLiQkYWRkQmluZGluZ0luZm8gPSBkZWJ1Z0luZm9FbmFibGVkID8gZnVuY3Rpb24gJCRhZGRCaW5kaW5nSW5mbygkZWxlbWVudCwgYmluZGluZykgewogICAgICB2YXIgYmluZGluZ3MgPSAkZWxlbWVudC5kYXRhKCckYmluZGluZycpIHx8IFtdOwoKICAgICAgaWYgKGlzQXJyYXkoYmluZGluZykpIHsKICAgICAgICBiaW5kaW5ncyA9IGJpbmRpbmdzLmNvbmNhdChiaW5kaW5nKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBiaW5kaW5ncy5wdXNoKGJpbmRpbmcpOwogICAgICB9CgogICAgICAkZWxlbWVudC5kYXRhKCckYmluZGluZycsIGJpbmRpbmdzKTsKICAgIH0gOiBub29wOwoKICAgIGNvbXBpbGUuJCRhZGRCaW5kaW5nQ2xhc3MgPSBkZWJ1Z0luZm9FbmFibGVkID8gZnVuY3Rpb24gJCRhZGRCaW5kaW5nQ2xhc3MoJGVsZW1lbnQpIHsKICAgICAgc2FmZUFkZENsYXNzKCRlbGVtZW50LCAnbmctYmluZGluZycpOwogICAgfSA6IG5vb3A7CgogICAgY29tcGlsZS4kJGFkZFNjb3BlSW5mbyA9IGRlYnVnSW5mb0VuYWJsZWQgPyBmdW5jdGlvbiAkJGFkZFNjb3BlSW5mbygkZWxlbWVudCwgc2NvcGUsIGlzb2xhdGVkLCBub1RlbXBsYXRlKSB7CiAgICAgIHZhciBkYXRhTmFtZSA9IGlzb2xhdGVkID8gKG5vVGVtcGxhdGUgPyAnJGlzb2xhdGVTY29wZU5vVGVtcGxhdGUnIDogJyRpc29sYXRlU2NvcGUnKSA6ICckc2NvcGUnOwogICAgICAkZWxlbWVudC5kYXRhKGRhdGFOYW1lLCBzY29wZSk7CiAgICB9IDogbm9vcDsKCiAgICBjb21waWxlLiQkYWRkU2NvcGVDbGFzcyA9IGRlYnVnSW5mb0VuYWJsZWQgPyBmdW5jdGlvbiAkJGFkZFNjb3BlQ2xhc3MoJGVsZW1lbnQsIGlzb2xhdGVkKSB7CiAgICAgIHNhZmVBZGRDbGFzcygkZWxlbWVudCwgaXNvbGF0ZWQgPyAnbmctaXNvbGF0ZS1zY29wZScgOiAnbmctc2NvcGUnKTsKICAgIH0gOiBub29wOwoKICAgIHJldHVybiBjb21waWxlOwoKICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiAgICBmdW5jdGlvbiBjb21waWxlKCRjb21waWxlTm9kZXMsIHRyYW5zY2x1ZGVGbiwgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dCkgewogICAgICBpZiAoISgkY29tcGlsZU5vZGVzIGluc3RhbmNlb2YganFMaXRlKSkgewogICAgICAgIC8vIGpxdWVyeSBhbHdheXMgcmV3cmFwcywgd2hlcmVhcyB3ZSBuZWVkIHRvIHByZXNlcnZlIHRoZSBvcmlnaW5hbCBzZWxlY3RvciBzbyB0aGF0IHdlIGNhbgogICAgICAgIC8vIG1vZGlmeSBpdC4KICAgICAgICAkY29tcGlsZU5vZGVzID0ganFMaXRlKCRjb21waWxlTm9kZXMpOwogICAgICB9CiAgICAgIC8vIFdlIGNhbiBub3QgY29tcGlsZSB0b3AgbGV2ZWwgdGV4dCBlbGVtZW50cyBzaW5jZSB0ZXh0IG5vZGVzIGNhbiBiZSBtZXJnZWQgYW5kIHdlIHdpbGwKICAgICAgLy8gbm90IGJlIGFibGUgdG8gYXR0YWNoIHNjb3BlIGRhdGEgdG8gdGhlbSwgc28gd2Ugd2lsbCB3cmFwIHRoZW0gaW4gPHNwYW4+CiAgICAgIGZvckVhY2goJGNvbXBpbGVOb2RlcywgZnVuY3Rpb24obm9kZSwgaW5kZXgpewogICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09IE5PREVfVFlQRV9URVhUICYmIG5vZGUubm9kZVZhbHVlLm1hdGNoKC9cUysvKSAvKiBub24tZW1wdHkgKi8gKSB7CiAgICAgICAgICAkY29tcGlsZU5vZGVzW2luZGV4XSA9IGpxTGl0ZShub2RlKS53cmFwKCc8c3Bhbj48L3NwYW4+JykucGFyZW50KClbMF07CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdmFyIGNvbXBvc2l0ZUxpbmtGbiA9CiAgICAgICAgICAgICAgY29tcGlsZU5vZGVzKCRjb21waWxlTm9kZXMsIHRyYW5zY2x1ZGVGbiwgJGNvbXBpbGVOb2RlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSwgcHJldmlvdXNDb21waWxlQ29udGV4dCk7CiAgICAgIGNvbXBpbGUuJCRhZGRTY29wZUNsYXNzKCRjb21waWxlTm9kZXMpOwogICAgICB2YXIgbmFtZXNwYWNlID0gbnVsbDsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIHB1YmxpY0xpbmtGbihzY29wZSwgY2xvbmVDb25uZWN0Rm4sIHRyYW5zY2x1ZGVDb250cm9sbGVycywgcGFyZW50Qm91bmRUcmFuc2NsdWRlRm4sIGZ1dHVyZVBhcmVudEVsZW1lbnQpewogICAgICAgIGFzc2VydEFyZyhzY29wZSwgJ3Njb3BlJyk7CiAgICAgICAgaWYgKCFuYW1lc3BhY2UpIHsKICAgICAgICAgIG5hbWVzcGFjZSA9IGRldGVjdE5hbWVzcGFjZUZvckNoaWxkRWxlbWVudHMoZnV0dXJlUGFyZW50RWxlbWVudCk7CiAgICAgICAgfQogICAgICAgIHZhciAkbGlua05vZGU7CiAgICAgICAgaWYgKG5hbWVzcGFjZSAhPT0gJ2h0bWwnKSB7CiAgICAgICAgICAvLyBXaGVuIHVzaW5nIGEgZGlyZWN0aXZlIHdpdGggcmVwbGFjZTp0cnVlIGFuZCB0ZW1wbGF0ZVVybCB0aGUgJGNvbXBpbGVOb2RlcwogICAgICAgICAgLy8gKG9yIGEgY2hpbGQgZWxlbWVudCBpbnNpZGUgb2YgdGhlbSkKICAgICAgICAgIC8vIG1pZ2h0IGNoYW5nZSwgc28gd2UgbmVlZCB0byByZWNyZWF0ZSB0aGUgbmFtZXNwYWNlIGFkYXB0ZWQgY29tcGlsZU5vZGVzCiAgICAgICAgICAvLyBmb3IgY2FsbCB0byB0aGUgbGluayBmdW5jdGlvbi4KICAgICAgICAgIC8vIE5vdGU6IFRoaXMgd2lsbCBhbHJlYWR5IGNsb25lIHRoZSBub2Rlcy4uLgogICAgICAgICAgJGxpbmtOb2RlID0ganFMaXRlKAogICAgICAgICAgICB3cmFwVGVtcGxhdGUobmFtZXNwYWNlLCBqcUxpdGUoJzxkaXY+JykuYXBwZW5kKCRjb21waWxlTm9kZXMpLmh0bWwoKSkKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChjbG9uZUNvbm5lY3RGbikgewogICAgICAgICAgLy8gaW1wb3J0YW50ISE6IHdlIG11c3QgY2FsbCBvdXIganFMaXRlLmNsb25lKCkgc2luY2UgdGhlIGpRdWVyeSBvbmUgaXMgdHJ5aW5nIHRvIGJlIHNtYXJ0CiAgICAgICAgICAvLyBhbmQgc29tZXRpbWVzIGNoYW5nZXMgdGhlIHN0cnVjdHVyZSBvZiB0aGUgRE9NLgogICAgICAgICAgJGxpbmtOb2RlID0gSlFMaXRlUHJvdG90eXBlLmNsb25lLmNhbGwoJGNvbXBpbGVOb2Rlcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICRsaW5rTm9kZSA9ICRjb21waWxlTm9kZXM7CiAgICAgICAgfQoKICAgICAgICBpZiAodHJhbnNjbHVkZUNvbnRyb2xsZXJzKSB7CiAgICAgICAgICBmb3IgKHZhciBjb250cm9sbGVyTmFtZSBpbiB0cmFuc2NsdWRlQ29udHJvbGxlcnMpIHsKICAgICAgICAgICAgJGxpbmtOb2RlLmRhdGEoJyQnICsgY29udHJvbGxlck5hbWUgKyAnQ29udHJvbGxlcicsIHRyYW5zY2x1ZGVDb250cm9sbGVyc1tjb250cm9sbGVyTmFtZV0uaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY29tcGlsZS4kJGFkZFNjb3BlSW5mbygkbGlua05vZGUsIHNjb3BlKTsKCiAgICAgICAgaWYgKGNsb25lQ29ubmVjdEZuKSBjbG9uZUNvbm5lY3RGbigkbGlua05vZGUsIHNjb3BlKTsKICAgICAgICBpZiAoY29tcG9zaXRlTGlua0ZuKSBjb21wb3NpdGVMaW5rRm4oc2NvcGUsICRsaW5rTm9kZSwgJGxpbmtOb2RlLCBwYXJlbnRCb3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgcmV0dXJuICRsaW5rTm9kZTsKICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBkZXRlY3ROYW1lc3BhY2VGb3JDaGlsZEVsZW1lbnRzKHBhcmVudEVsZW1lbnQpIHsKICAgICAgLy8gVE9ETzogTWFrZSB0aGlzIGRldGVjdCBNYXRoTUwgYXMgd2VsbC4uLgogICAgICB2YXIgbm9kZSA9IHBhcmVudEVsZW1lbnQgJiYgcGFyZW50RWxlbWVudFswXTsKICAgICAgaWYgKCFub2RlKSB7CiAgICAgICAgcmV0dXJuICdodG1sJzsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbm9kZU5hbWVfKG5vZGUpICE9PSAnZm9yZWlnbm9iamVjdCcgJiYgbm9kZS50b1N0cmluZygpLm1hdGNoKC9TVkcvKSA/ICdzdmcnOiAnaHRtbCc7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIENvbXBpbGUgZnVuY3Rpb24gbWF0Y2hlcyBlYWNoIG5vZGUgaW4gbm9kZUxpc3QgYWdhaW5zdCB0aGUgZGlyZWN0aXZlcy4gT25jZSBhbGwgZGlyZWN0aXZlcwogICAgICogZm9yIGEgcGFydGljdWxhciBub2RlIGFyZSBjb2xsZWN0ZWQgdGhlaXIgY29tcGlsZSBmdW5jdGlvbnMgYXJlIGV4ZWN1dGVkLiBUaGUgY29tcGlsZQogICAgICogZnVuY3Rpb25zIHJldHVybiB2YWx1ZXMgLSB0aGUgbGlua2luZyBmdW5jdGlvbnMgLSBhcmUgY29tYmluZWQgaW50byBhIGNvbXBvc2l0ZSBsaW5raW5nCiAgICAgKiBmdW5jdGlvbiwgd2hpY2ggaXMgdGhlIGEgbGlua2luZyBmdW5jdGlvbiBmb3IgdGhlIG5vZGUuCiAgICAgKgogICAgICogQHBhcmFtIHtOb2RlTGlzdH0gbm9kZUxpc3QgYW4gYXJyYXkgb2Ygbm9kZXMgb3IgTm9kZUxpc3QgdG8gY29tcGlsZQogICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlLCBjbG9uZUF0dGFjaEZuPSl9IHRyYW5zY2x1ZGVGbiBBIGxpbmtpbmcgZnVuY3Rpb24sIHdoZXJlIHRoZQogICAgICogICAgICAgIHNjb3BlIGFyZ3VtZW50IGlzIGF1dG8tZ2VuZXJhdGVkIHRvIHRoZSBuZXcgY2hpbGQgb2YgdGhlIHRyYW5zY2x1ZGVkIHBhcmVudCBzY29wZS4KICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudD19ICRyb290RWxlbWVudCBJZiB0aGUgbm9kZUxpc3QgaXMgdGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGF0aW9uIHRyZWUgdGhlbgogICAgICogICAgICAgIHRoZSByb290RWxlbWVudCBtdXN0IGJlIHNldCB0aGUganFMaXRlIGNvbGxlY3Rpb24gb2YgdGhlIGNvbXBpbGUgcm9vdC4gVGhpcyBpcwogICAgICogICAgICAgIG5lZWRlZCBzbyB0aGF0IHRoZSBqcUxpdGUgY29sbGVjdGlvbiBpdGVtcyBjYW4gYmUgcmVwbGFjZWQgd2l0aCB3aWRnZXRzLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBtYXhQcmlvcml0eSBNYXggZGlyZWN0aXZlIHByaW9yaXR5LgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBBIGNvbXBvc2l0ZSBsaW5raW5nIGZ1bmN0aW9uIG9mIGFsbCBvZiB0aGUgbWF0Y2hlZCBkaXJlY3RpdmVzIG9yIG51bGwuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbXBpbGVOb2Rlcyhub2RlTGlzdCwgdHJhbnNjbHVkZUZuLCAkcm9vdEVsZW1lbnQsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0NvbXBpbGVDb250ZXh0KSB7CiAgICAgIHZhciBsaW5rRm5zID0gW10sCiAgICAgICAgICBhdHRycywgZGlyZWN0aXZlcywgbm9kZUxpbmtGbiwgY2hpbGROb2RlcywgY2hpbGRMaW5rRm4sIGxpbmtGbkZvdW5kLCBub2RlTGlua0ZuRm91bmQ7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGVMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgYXR0cnMgPSBuZXcgQXR0cmlidXRlcygpOwoKICAgICAgICAvLyB3ZSBtdXN0IGFsd2F5cyByZWZlciB0byBub2RlTGlzdFtpXSBzaW5jZSB0aGUgbm9kZXMgY2FuIGJlIHJlcGxhY2VkIHVuZGVybmVhdGggdXMuCiAgICAgICAgZGlyZWN0aXZlcyA9IGNvbGxlY3REaXJlY3RpdmVzKG5vZGVMaXN0W2ldLCBbXSwgYXR0cnMsIGkgPT09IDAgPyBtYXhQcmlvcml0eSA6IHVuZGVmaW5lZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlnbm9yZURpcmVjdGl2ZSk7CgogICAgICAgIG5vZGVMaW5rRm4gPSAoZGlyZWN0aXZlcy5sZW5ndGgpCiAgICAgICAgICAgID8gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIG5vZGVMaXN0W2ldLCBhdHRycywgdHJhbnNjbHVkZUZuLCAkcm9vdEVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCwgW10sIFtdLCBwcmV2aW91c0NvbXBpbGVDb250ZXh0KQogICAgICAgICAgICA6IG51bGw7CgogICAgICAgIGlmIChub2RlTGlua0ZuICYmIG5vZGVMaW5rRm4uc2NvcGUpIHsKICAgICAgICAgIGNvbXBpbGUuJCRhZGRTY29wZUNsYXNzKGF0dHJzLiQkZWxlbWVudCk7CiAgICAgICAgfQoKICAgICAgICBjaGlsZExpbmtGbiA9IChub2RlTGlua0ZuICYmIG5vZGVMaW5rRm4udGVybWluYWwgfHwKICAgICAgICAgICAgICAgICAgICAgICEoY2hpbGROb2RlcyA9IG5vZGVMaXN0W2ldLmNoaWxkTm9kZXMpIHx8CiAgICAgICAgICAgICAgICAgICAgICAhY2hpbGROb2Rlcy5sZW5ndGgpCiAgICAgICAgICAgID8gbnVsbAogICAgICAgICAgICA6IGNvbXBpbGVOb2RlcyhjaGlsZE5vZGVzLAogICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4gPyAoCiAgICAgICAgICAgICAgICAgIChub2RlTGlua0ZuLnRyYW5zY2x1ZGVPblRoaXNFbGVtZW50IHx8ICFub2RlTGlua0ZuLnRlbXBsYXRlT25UaGlzRWxlbWVudCkKICAgICAgICAgICAgICAgICAgICAgJiYgbm9kZUxpbmtGbi50cmFuc2NsdWRlKSA6IHRyYW5zY2x1ZGVGbik7CgogICAgICAgIGlmIChub2RlTGlua0ZuIHx8IGNoaWxkTGlua0ZuKSB7CiAgICAgICAgICBsaW5rRm5zLnB1c2goaSwgbm9kZUxpbmtGbiwgY2hpbGRMaW5rRm4pOwogICAgICAgICAgbGlua0ZuRm91bmQgPSB0cnVlOwogICAgICAgICAgbm9kZUxpbmtGbkZvdW5kID0gbm9kZUxpbmtGbkZvdW5kIHx8IG5vZGVMaW5rRm47CiAgICAgICAgfQoKICAgICAgICAvL3VzZSB0aGUgcHJldmlvdXMgY29udGV4dCBvbmx5IGZvciB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGUgdmlydHVhbCBncm91cAogICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQgPSBudWxsOwogICAgICB9CgogICAgICAvLyByZXR1cm4gYSBsaW5raW5nIGZ1bmN0aW9uIGlmIHdlIGhhdmUgZm91bmQgYW55dGhpbmcsIG51bGwgb3RoZXJ3aXNlCiAgICAgIHJldHVybiBsaW5rRm5Gb3VuZCA/IGNvbXBvc2l0ZUxpbmtGbiA6IG51bGw7CgogICAgICBmdW5jdGlvbiBjb21wb3NpdGVMaW5rRm4oc2NvcGUsIG5vZGVMaXN0LCAkcm9vdEVsZW1lbnQsIHBhcmVudEJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgdmFyIG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuLCBub2RlLCBjaGlsZFNjb3BlLCBpLCBpaSwgaWR4LCBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuOwogICAgICAgIHZhciBzdGFibGVOb2RlTGlzdDsKCgogICAgICAgIGlmIChub2RlTGlua0ZuRm91bmQpIHsKICAgICAgICAgIC8vIGNvcHkgbm9kZUxpc3Qgc28gdGhhdCBpZiBhIG5vZGVMaW5rRm4gcmVtb3ZlcyBvciBhZGRzIGFuIGVsZW1lbnQgYXQgdGhpcyBET00gbGV2ZWwgb3VyCiAgICAgICAgICAvLyBvZmZzZXRzIGRvbid0IGdldCBzY3Jld2VkIHVwCiAgICAgICAgICB2YXIgbm9kZUxpc3RMZW5ndGggPSBub2RlTGlzdC5sZW5ndGg7CiAgICAgICAgICBzdGFibGVOb2RlTGlzdCA9IG5ldyBBcnJheShub2RlTGlzdExlbmd0aCk7CgogICAgICAgICAgLy8gY3JlYXRlIGEgc3BhcnNlIGFycmF5IGJ5IG9ubHkgY29weWluZyB0aGUgZWxlbWVudHMgd2hpY2ggaGF2ZSBhIGxpbmtGbgogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxpbmtGbnMubGVuZ3RoOyBpKz0zKSB7CiAgICAgICAgICAgIGlkeCA9IGxpbmtGbnNbaV07CiAgICAgICAgICAgIHN0YWJsZU5vZGVMaXN0W2lkeF0gPSBub2RlTGlzdFtpZHhdOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdGFibGVOb2RlTGlzdCA9IG5vZGVMaXN0OwogICAgICAgIH0KCiAgICAgICAgZm9yKGkgPSAwLCBpaSA9IGxpbmtGbnMubGVuZ3RoOyBpIDwgaWk7KSB7CiAgICAgICAgICBub2RlID0gc3RhYmxlTm9kZUxpc3RbbGlua0Zuc1tpKytdXTsKICAgICAgICAgIG5vZGVMaW5rRm4gPSBsaW5rRm5zW2krK107CiAgICAgICAgICBjaGlsZExpbmtGbiA9IGxpbmtGbnNbaSsrXTsKCiAgICAgICAgICBpZiAobm9kZUxpbmtGbikgewogICAgICAgICAgICBpZiAobm9kZUxpbmtGbi5zY29wZSkgewogICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgY29tcGlsZS4kJGFkZFNjb3BlSW5mbyhqcUxpdGUobm9kZSksIGNoaWxkU2NvcGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBzY29wZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCBub2RlTGlua0ZuLnRyYW5zY2x1ZGVPblRoaXNFbGVtZW50ICkgewogICAgICAgICAgICAgIGNoaWxkQm91bmRUcmFuc2NsdWRlRm4gPSBjcmVhdGVCb3VuZFRyYW5zY2x1ZGVGbigKICAgICAgICAgICAgICAgICAgc2NvcGUsIG5vZGVMaW5rRm4udHJhbnNjbHVkZSwgcGFyZW50Qm91bmRUcmFuc2NsdWRlRm4sCiAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4uZWxlbWVudFRyYW5zY2x1ZGVPblRoaXNFbGVtZW50KTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoIW5vZGVMaW5rRm4udGVtcGxhdGVPblRoaXNFbGVtZW50ICYmIHBhcmVudEJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgY2hpbGRCb3VuZFRyYW5zY2x1ZGVGbiA9IHBhcmVudEJvdW5kVHJhbnNjbHVkZUZuOwoKICAgICAgICAgICAgfSBlbHNlIGlmICghcGFyZW50Qm91bmRUcmFuc2NsdWRlRm4gJiYgdHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgY2hpbGRCb3VuZFRyYW5zY2x1ZGVGbiA9IGNyZWF0ZUJvdW5kVHJhbnNjbHVkZUZuKHNjb3BlLCB0cmFuc2NsdWRlRm4pOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgY2hpbGRTY29wZSwgbm9kZSwgJHJvb3RFbGVtZW50LCBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuKTsKCiAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkTGlua0ZuKSB7CiAgICAgICAgICAgIGNoaWxkTGlua0ZuKHNjb3BlLCBub2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgcGFyZW50Qm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUJvdW5kVHJhbnNjbHVkZUZuKHNjb3BlLCB0cmFuc2NsdWRlRm4sIHByZXZpb3VzQm91bmRUcmFuc2NsdWRlRm4sIGVsZW1lbnRUcmFuc2NsdXNpb24pIHsKCiAgICAgIHZhciBib3VuZFRyYW5zY2x1ZGVGbiA9IGZ1bmN0aW9uKHRyYW5zY2x1ZGVkU2NvcGUsIGNsb25lRm4sIGNvbnRyb2xsZXJzLCBmdXR1cmVQYXJlbnRFbGVtZW50LCBjb250YWluaW5nU2NvcGUpIHsKCiAgICAgICAgaWYgKCF0cmFuc2NsdWRlZFNjb3BlKSB7CiAgICAgICAgICB0cmFuc2NsdWRlZFNjb3BlID0gc2NvcGUuJG5ldyhmYWxzZSwgY29udGFpbmluZ1Njb3BlKTsKICAgICAgICAgIHRyYW5zY2x1ZGVkU2NvcGUuJCR0cmFuc2NsdWRlZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJhbnNjbHVkZUZuKHRyYW5zY2x1ZGVkU2NvcGUsIGNsb25lRm4sIGNvbnRyb2xsZXJzLCBwcmV2aW91c0JvdW5kVHJhbnNjbHVkZUZuLCBmdXR1cmVQYXJlbnRFbGVtZW50KTsKICAgICAgfTsKCiAgICAgIHJldHVybiBib3VuZFRyYW5zY2x1ZGVGbjsKICAgIH0KCiAgICAvKioKICAgICAqIExvb2tzIGZvciBkaXJlY3RpdmVzIG9uIHRoZSBnaXZlbiBub2RlIGFuZCBhZGRzIHRoZW0gdG8gdGhlIGRpcmVjdGl2ZSBjb2xsZWN0aW9uIHdoaWNoIGlzCiAgICAgKiBzb3J0ZWQuCiAgICAgKgogICAgICogQHBhcmFtIG5vZGUgTm9kZSB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0gZGlyZWN0aXZlcyBBbiBhcnJheSB0byB3aGljaCB0aGUgZGlyZWN0aXZlcyBhcmUgYWRkZWQgdG8uIFRoaXMgYXJyYXkgaXMgc29ydGVkIGJlZm9yZQogICAgICogICAgICAgIHRoZSBmdW5jdGlvbiByZXR1cm5zLgogICAgICogQHBhcmFtIGF0dHJzIFRoZSBzaGFyZWQgYXR0cnMgb2JqZWN0IHdoaWNoIGlzIHVzZWQgdG8gcG9wdWxhdGUgdGhlIG5vcm1hbGl6ZWQgYXR0cmlidXRlcy4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbWF4UHJpb3JpdHkgTWF4IGRpcmVjdGl2ZSBwcmlvcml0eS4KICAgICAqLwogICAgZnVuY3Rpb24gY29sbGVjdERpcmVjdGl2ZXMobm9kZSwgZGlyZWN0aXZlcywgYXR0cnMsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpIHsKICAgICAgdmFyIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZSwKICAgICAgICAgIGF0dHJzTWFwID0gYXR0cnMuJGF0dHIsCiAgICAgICAgICBtYXRjaCwKICAgICAgICAgIGNsYXNzTmFtZTsKCiAgICAgIHN3aXRjaChub2RlVHlwZSkgewogICAgICAgIGNhc2UgTk9ERV9UWVBFX0VMRU1FTlQ6IC8qIEVsZW1lbnQgKi8KICAgICAgICAgIC8vIHVzZSB0aGUgbm9kZSBuYW1lOiA8ZGlyZWN0aXZlPgogICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsCiAgICAgICAgICAgICAgZGlyZWN0aXZlTm9ybWFsaXplKG5vZGVOYW1lXyhub2RlKSksICdFJywgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSk7CgogICAgICAgICAgLy8gaXRlcmF0ZSBvdmVyIHRoZSBhdHRyaWJ1dGVzCiAgICAgICAgICBmb3IgKHZhciBhdHRyLCBuYW1lLCBuTmFtZSwgbmdBdHRyTmFtZSwgdmFsdWUsIGlzTmdBdHRyLCBuQXR0cnMgPSBub2RlLmF0dHJpYnV0ZXMsCiAgICAgICAgICAgICAgICAgICBqID0gMCwgamogPSBuQXR0cnMgJiYgbkF0dHJzLmxlbmd0aDsgaiA8IGpqOyBqKyspIHsKICAgICAgICAgICAgdmFyIGF0dHJTdGFydE5hbWUgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIGF0dHJFbmROYW1lID0gZmFsc2U7CgogICAgICAgICAgICBhdHRyID0gbkF0dHJzW2pdOwogICAgICAgICAgICBuYW1lID0gYXR0ci5uYW1lOwogICAgICAgICAgICB2YWx1ZSA9IHRyaW0oYXR0ci52YWx1ZSk7CgogICAgICAgICAgICAvLyBzdXBwb3J0IG5nQXR0ciBhdHRyaWJ1dGUgYmluZGluZwogICAgICAgICAgICBuZ0F0dHJOYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUpOwogICAgICAgICAgICBpZiAoaXNOZ0F0dHIgPSBOR19BVFRSX0JJTkRJTkcudGVzdChuZ0F0dHJOYW1lKSkgewogICAgICAgICAgICAgIG5hbWUgPSBzbmFrZV9jYXNlKG5nQXR0ck5hbWUuc3Vic3RyKDYpLCAnLScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZGlyZWN0aXZlTk5hbWUgPSBuZ0F0dHJOYW1lLnJlcGxhY2UoLyhTdGFydHxFbmQpJC8sICcnKTsKICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZUlzTXVsdGlFbGVtZW50KGRpcmVjdGl2ZU5OYW1lKSkgewogICAgICAgICAgICAgIGlmIChuZ0F0dHJOYW1lID09PSBkaXJlY3RpdmVOTmFtZSArICdTdGFydCcpIHsKICAgICAgICAgICAgICAgIGF0dHJTdGFydE5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgYXR0ckVuZE5hbWUgPSBuYW1lLnN1YnN0cigwLCBuYW1lLmxlbmd0aCAtIDUpICsgJ2VuZCc7CiAgICAgICAgICAgICAgICBuYW1lID0gbmFtZS5zdWJzdHIoMCwgbmFtZS5sZW5ndGggLSA2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgIGF0dHJzTWFwW25OYW1lXSA9IG5hbWU7CiAgICAgICAgICAgIGlmIChpc05nQXR0ciB8fCAhYXR0cnMuaGFzT3duUHJvcGVydHkobk5hbWUpKSB7CiAgICAgICAgICAgICAgICBhdHRyc1tuTmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIGlmIChnZXRCb29sZWFuQXR0ck5hbWUobm9kZSwgbk5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRydWU7IC8vIHByZXNlbmNlIG1lYW5zIHRydWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBhZGRBdHRySW50ZXJwb2xhdGVEaXJlY3RpdmUobm9kZSwgZGlyZWN0aXZlcywgdmFsdWUsIG5OYW1lLCBpc05nQXR0cik7CiAgICAgICAgICAgIGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLCBuTmFtZSwgJ0EnLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlLCBhdHRyU3RhcnROYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJFbmROYW1lKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyB1c2UgY2xhc3MgYXMgZGlyZWN0aXZlCiAgICAgICAgICBjbGFzc05hbWUgPSBub2RlLmNsYXNzTmFtZTsKICAgICAgICAgIGlmIChpc1N0cmluZyhjbGFzc05hbWUpICYmIGNsYXNzTmFtZSAhPT0gJycpIHsKICAgICAgICAgICAgd2hpbGUgKG1hdGNoID0gQ0xBU1NfRElSRUNUSVZFX1JFR0VYUC5leGVjKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgICBuTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZShtYXRjaFsyXSk7CiAgICAgICAgICAgICAgaWYgKGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLCBuTmFtZSwgJ0MnLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFszXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZS5zdWJzdHIobWF0Y2guaW5kZXggKyBtYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIE5PREVfVFlQRV9URVhUOiAvKiBUZXh0IE5vZGUgKi8KICAgICAgICAgIGFkZFRleHRJbnRlcnBvbGF0ZURpcmVjdGl2ZShkaXJlY3RpdmVzLCBub2RlLm5vZGVWYWx1ZSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIE5PREVfVFlQRV9DT01NRU5UOiAvKiBDb21tZW50ICovCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBtYXRjaCA9IENPTU1FTlRfRElSRUNUSVZFX1JFR0VYUC5leGVjKG5vZGUubm9kZVZhbHVlKTsKICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMV0pOwogICAgICAgICAgICAgIGlmIChhZGREaXJlY3RpdmUoZGlyZWN0aXZlcywgbk5hbWUsICdNJywgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSkpIHsKICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRyaW0obWF0Y2hbMl0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyB0dXJucyBvdXQgdGhhdCB1bmRlciBzb21lIGNpcmN1bXN0YW5jZXMgSUU5IHRocm93cyBlcnJvcnMgd2hlbiBvbmUgYXR0ZW1wdHMgdG8gcmVhZAogICAgICAgICAgICAvLyBjb21tZW50J3Mgbm9kZSB2YWx1ZS4KICAgICAgICAgICAgLy8gSnVzdCBpZ25vcmUgaXQgYW5kIGNvbnRpbnVlLiAoQ2FuJ3Qgc2VlbSB0byByZXByb2R1Y2UgaW4gdGVzdCBjYXNlLikKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBkaXJlY3RpdmVzLnNvcnQoYnlQcmlvcml0eSk7CiAgICAgIHJldHVybiBkaXJlY3RpdmVzOwogICAgfQoKICAgIC8qKgogICAgICogR2l2ZW4gYSBub2RlIHdpdGggYW4gZGlyZWN0aXZlLXN0YXJ0IGl0IGNvbGxlY3RzIGFsbCBvZiB0aGUgc2libGluZ3MgdW50aWwgaXQgZmluZHMKICAgICAqIGRpcmVjdGl2ZS1lbmQuCiAgICAgKiBAcGFyYW0gbm9kZQogICAgICogQHBhcmFtIGF0dHJTdGFydAogICAgICogQHBhcmFtIGF0dHJFbmQKICAgICAqIEByZXR1cm5zIHsqfQogICAgICovCiAgICBmdW5jdGlvbiBncm91cFNjYW4obm9kZSwgYXR0clN0YXJ0LCBhdHRyRW5kKSB7CiAgICAgIHZhciBub2RlcyA9IFtdOwogICAgICB2YXIgZGVwdGggPSAwOwogICAgICBpZiAoYXR0clN0YXJ0ICYmIG5vZGUuaGFzQXR0cmlidXRlICYmIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJTdGFydCkpIHsKICAgICAgICB2YXIgc3RhcnROb2RlID0gbm9kZTsKICAgICAgICBkbyB7CiAgICAgICAgICBpZiAoIW5vZGUpIHsKICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ3V0ZXJkaXInLAogICAgICAgICAgICAgICAgICAgICAgIlVudGVybWluYXRlZCBhdHRyaWJ1dGUsIGZvdW5kICd7MH0nIGJ1dCBubyBtYXRjaGluZyAnezF9JyBmb3VuZC4iLAogICAgICAgICAgICAgICAgICAgICAgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09IE5PREVfVFlQRV9FTEVNRU5UKSB7CiAgICAgICAgICAgIGlmIChub2RlLmhhc0F0dHJpYnV0ZShhdHRyU3RhcnQpKSBkZXB0aCsrOwogICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0ckVuZCkpIGRlcHRoLS07CiAgICAgICAgICB9CiAgICAgICAgICBub2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgfSB3aGlsZSAoZGVwdGggPiAwKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBub2Rlcy5wdXNoKG5vZGUpOwogICAgICB9CgogICAgICByZXR1cm4ganFMaXRlKG5vZGVzKTsKICAgIH0KCiAgICAvKioKICAgICAqIFdyYXBwZXIgZm9yIGxpbmtpbmcgZnVuY3Rpb24gd2hpY2ggY29udmVydHMgbm9ybWFsIGxpbmtpbmcgZnVuY3Rpb24gaW50byBhIGdyb3VwZWQKICAgICAqIGxpbmtpbmcgZnVuY3Rpb24uCiAgICAgKiBAcGFyYW0gbGlua0ZuCiAgICAgKiBAcGFyYW0gYXR0clN0YXJ0CiAgICAgKiBAcGFyYW0gYXR0ckVuZAogICAgICogQHJldHVybnMge0Z1bmN0aW9ufQogICAgICovCiAgICBmdW5jdGlvbiBncm91cEVsZW1lbnRzTGlua0ZuV3JhcHBlcihsaW5rRm4sIGF0dHJTdGFydCwgYXR0ckVuZCkgewogICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjb250cm9sbGVycywgdHJhbnNjbHVkZUZuKSB7CiAgICAgICAgZWxlbWVudCA9IGdyb3VwU2NhbihlbGVtZW50WzBdLCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgIHJldHVybiBsaW5rRm4oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjb250cm9sbGVycywgdHJhbnNjbHVkZUZuKTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIE9uY2UgdGhlIGRpcmVjdGl2ZXMgaGF2ZSBiZWVuIGNvbGxlY3RlZCwgdGhlaXIgY29tcGlsZSBmdW5jdGlvbnMgYXJlIGV4ZWN1dGVkLiBUaGlzIG1ldGhvZAogICAgICogaXMgcmVzcG9uc2libGUgZm9yIGlubGluaW5nIGRpcmVjdGl2ZSB0ZW1wbGF0ZXMgYXMgd2VsbCBhcyB0ZXJtaW5hdGluZyB0aGUgYXBwbGljYXRpb24KICAgICAqIG9mIHRoZSBkaXJlY3RpdmVzIGlmIHRoZSB0ZXJtaW5hbCBkaXJlY3RpdmUgaGFzIGJlZW4gcmVhY2hlZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBkaXJlY3RpdmVzIEFycmF5IG9mIGNvbGxlY3RlZCBkaXJlY3RpdmVzIHRvIGV4ZWN1dGUgdGhlaXIgY29tcGlsZSBmdW5jdGlvbi4KICAgICAqICAgICAgICB0aGlzIG5lZWRzIHRvIGJlIHByZS1zb3J0ZWQgYnkgcHJpb3JpdHkgb3JkZXIuCiAgICAgKiBAcGFyYW0ge05vZGV9IGNvbXBpbGVOb2RlIFRoZSByYXcgRE9NIG5vZGUgdG8gYXBwbHkgdGhlIGNvbXBpbGUgZnVuY3Rpb25zIHRvCiAgICAgKiBAcGFyYW0ge09iamVjdH0gdGVtcGxhdGVBdHRycyBUaGUgc2hhcmVkIGF0dHJpYnV0ZSBmdW5jdGlvbgogICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlLCBjbG9uZUF0dGFjaEZuPSl9IHRyYW5zY2x1ZGVGbiBBIGxpbmtpbmcgZnVuY3Rpb24sIHdoZXJlIHRoZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlIGFyZ3VtZW50IGlzIGF1dG8tZ2VuZXJhdGVkIHRvIHRoZSBuZXcKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCBvZiB0aGUgdHJhbnNjbHVkZWQgcGFyZW50IHNjb3BlLgogICAgICogQHBhcmFtIHtKUUxpdGV9IGpxQ29sbGVjdGlvbiBJZiB3ZSBhcmUgd29ya2luZyBvbiB0aGUgcm9vdCBvZiB0aGUgY29tcGlsZSB0cmVlIHRoZW4gdGhpcwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmd1bWVudCBoYXMgdGhlIHJvb3QganFMaXRlIGFycmF5IHNvIHRoYXQgd2UgY2FuIHJlcGxhY2Ugbm9kZXMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb24gaXQuCiAgICAgKiBAcGFyYW0ge09iamVjdD19IG9yaWdpbmFsUmVwbGFjZURpcmVjdGl2ZSBBbiBvcHRpb25hbCBkaXJlY3RpdmUgdGhhdCB3aWxsIGJlIGlnbm9yZWQgd2hlbgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsaW5nIHRoZSB0cmFuc2NsdXNpb24uCiAgICAgKiBAcGFyYW0ge0FycmF5LjxGdW5jdGlvbj59IHByZUxpbmtGbnMKICAgICAqIEBwYXJhbSB7QXJyYXkuPEZ1bmN0aW9uPn0gcG9zdExpbmtGbnMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwcmV2aW91c0NvbXBpbGVDb250ZXh0IENvbnRleHQgdXNlZCBmb3IgcHJldmlvdXMgY29tcGlsYXRpb24gb2YgdGhlIGN1cnJlbnQKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUKICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gbGlua0ZuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFwcGx5RGlyZWN0aXZlc1RvTm9kZShkaXJlY3RpdmVzLCBjb21waWxlTm9kZSwgdGVtcGxhdGVBdHRycywgdHJhbnNjbHVkZUZuLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpxQ29sbGVjdGlvbiwgb3JpZ2luYWxSZXBsYWNlRGlyZWN0aXZlLCBwcmVMaW5rRm5zLCBwb3N0TGlua0ZucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0NvbXBpbGVDb250ZXh0KSB7CiAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQgPSBwcmV2aW91c0NvbXBpbGVDb250ZXh0IHx8IHt9OwoKICAgICAgdmFyIHRlcm1pbmFsUHJpb3JpdHkgPSAtTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICAgIG5ld1Njb3BlRGlyZWN0aXZlLAogICAgICAgICAgY29udHJvbGxlckRpcmVjdGl2ZXMgPSBwcmV2aW91c0NvbXBpbGVDb250ZXh0LmNvbnRyb2xsZXJEaXJlY3RpdmVzLAogICAgICAgICAgY29udHJvbGxlcnMsCiAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPSBwcmV2aW91c0NvbXBpbGVDb250ZXh0Lm5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSwKICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID0gcHJldmlvdXNDb21waWxlQ29udGV4dC50ZW1wbGF0ZURpcmVjdGl2ZSwKICAgICAgICAgIG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUgPSBwcmV2aW91c0NvbXBpbGVDb250ZXh0Lm5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICBoYXNUcmFuc2NsdWRlRGlyZWN0aXZlID0gZmFsc2UsCiAgICAgICAgICBoYXNUZW1wbGF0ZSA9IGZhbHNlLAogICAgICAgICAgaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUgPSBwcmV2aW91c0NvbXBpbGVDb250ZXh0Lmhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlLAogICAgICAgICAgJGNvbXBpbGVOb2RlID0gdGVtcGxhdGVBdHRycy4kJGVsZW1lbnQgPSBqcUxpdGUoY29tcGlsZU5vZGUpLAogICAgICAgICAgZGlyZWN0aXZlLAogICAgICAgICAgZGlyZWN0aXZlTmFtZSwKICAgICAgICAgICR0ZW1wbGF0ZSwKICAgICAgICAgIHJlcGxhY2VEaXJlY3RpdmUgPSBvcmlnaW5hbFJlcGxhY2VEaXJlY3RpdmUsCiAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IHRyYW5zY2x1ZGVGbiwKICAgICAgICAgIGxpbmtGbiwKICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlOwoKICAgICAgLy8gZXhlY3V0ZXMgYWxsIGRpcmVjdGl2ZXMgb24gdGhlIGN1cnJlbnQgZWxlbWVudAogICAgICBmb3IodmFyIGkgPSAwLCBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgdmFyIGF0dHJTdGFydCA9IGRpcmVjdGl2ZS4kJHN0YXJ0OwogICAgICAgIHZhciBhdHRyRW5kID0gZGlyZWN0aXZlLiQkZW5kOwoKICAgICAgICAvLyBjb2xsZWN0IG11bHRpYmxvY2sgc2VjdGlvbnMKICAgICAgICBpZiAoYXR0clN0YXJ0KSB7CiAgICAgICAgICAkY29tcGlsZU5vZGUgPSBncm91cFNjYW4oY29tcGlsZU5vZGUsIGF0dHJTdGFydCwgYXR0ckVuZCk7CiAgICAgICAgfQogICAgICAgICR0ZW1wbGF0ZSA9IHVuZGVmaW5lZDsKCiAgICAgICAgaWYgKHRlcm1pbmFsUHJpb3JpdHkgPiBkaXJlY3RpdmUucHJpb3JpdHkpIHsKICAgICAgICAgIGJyZWFrOyAvLyBwcmV2ZW50IGZ1cnRoZXIgcHJvY2Vzc2luZyBvZiBkaXJlY3RpdmVzCiAgICAgICAgfQoKICAgICAgICBpZiAoZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUuc2NvcGUpIHsKCiAgICAgICAgICAvLyBza2lwIHRoZSBjaGVjayBmb3IgZGlyZWN0aXZlcyB3aXRoIGFzeW5jIHRlbXBsYXRlcywgd2UnbGwgY2hlY2sgdGhlIGRlcml2ZWQgc3luYwogICAgICAgICAgLy8gZGlyZWN0aXZlIHdoZW4gdGhlIHRlbXBsYXRlIGFycml2ZXMKICAgICAgICAgIGlmICghZGlyZWN0aXZlLnRlbXBsYXRlVXJsKSB7CiAgICAgICAgICAgIGlmIChpc09iamVjdChkaXJlY3RpdmVWYWx1ZSkpIHsKICAgICAgICAgICAgICAvLyBUaGlzIGRpcmVjdGl2ZSBpcyB0cnlpbmcgdG8gYWRkIGFuIGlzb2xhdGVkIHNjb3BlLgogICAgICAgICAgICAgIC8vIENoZWNrIHRoYXQgdGhlcmUgaXMgbm8gc2NvcGUgb2YgYW55IGtpbmQgYWxyZWFkeQogICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCduZXcvaXNvbGF0ZWQgc2NvcGUnLCBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgfHwgbmV3U2NvcGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBUaGlzIGRpcmVjdGl2ZSBpcyB0cnlpbmcgdG8gYWRkIGEgY2hpbGQgc2NvcGUuCiAgICAgICAgICAgICAgLy8gQ2hlY2sgdGhhdCB0aGVyZSBpcyBubyBpc29sYXRlZCBzY29wZSBhbHJlYWR5CiAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ25ldy9pc29sYXRlZCBzY29wZScsIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSwgZGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBuZXdTY29wZURpcmVjdGl2ZSA9IG5ld1Njb3BlRGlyZWN0aXZlIHx8IGRpcmVjdGl2ZTsKICAgICAgICB9CgogICAgICAgIGRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmUubmFtZTsKCiAgICAgICAgaWYgKCFkaXJlY3RpdmUudGVtcGxhdGVVcmwgJiYgZGlyZWN0aXZlLmNvbnRyb2xsZXIpIHsKICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLmNvbnRyb2xsZXI7CiAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcyA9IGNvbnRyb2xsZXJEaXJlY3RpdmVzIHx8IHt9OwogICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoIiciICsgZGlyZWN0aXZlTmFtZSArICInIGNvbnRyb2xsZXIiLAogICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSA9IGRpcmVjdGl2ZTsKICAgICAgICB9CgogICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS50cmFuc2NsdWRlKSB7CiAgICAgICAgICBoYXNUcmFuc2NsdWRlRGlyZWN0aXZlID0gdHJ1ZTsKCiAgICAgICAgICAvLyBTcGVjaWFsIGNhc2UgbmdJZiBhbmQgbmdSZXBlYXQgc28gdGhhdCB3ZSBkb24ndCBjb21wbGFpbiBhYm91dCBkdXBsaWNhdGUgdHJhbnNjbHVzaW9uLgogICAgICAgICAgLy8gVGhpcyBvcHRpb24gc2hvdWxkIG9ubHkgYmUgdXNlZCBieSBkaXJlY3RpdmVzIHRoYXQga25vdyBob3cgdG8gc2FmZWx5IGhhbmRsZSBlbGVtZW50IHRyYW5zY2x1c2lvbiwKICAgICAgICAgIC8vIHdoZXJlIHRoZSB0cmFuc2NsdWRlZCBub2RlcyBhcmUgYWRkZWQgb3IgcmVwbGFjZWQgYWZ0ZXIgbGlua2luZy4KICAgICAgICAgIGlmICghZGlyZWN0aXZlLiQkdGxiKSB7CiAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0cmFuc2NsdXNpb24nLCBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgIG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID09ICdlbGVtZW50JykgewogICAgICAgICAgICBoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgIHRlcm1pbmFsUHJpb3JpdHkgPSBkaXJlY3RpdmUucHJpb3JpdHk7CiAgICAgICAgICAgICR0ZW1wbGF0ZSA9ICRjb21waWxlTm9kZTsKICAgICAgICAgICAgJGNvbXBpbGVOb2RlID0gdGVtcGxhdGVBdHRycy4kJGVsZW1lbnQgPQogICAgICAgICAgICAgICAganFMaXRlKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJyAnICsgZGlyZWN0aXZlTmFtZSArICc6ICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVBdHRyc1tkaXJlY3RpdmVOYW1lXSArICcgJykpOwogICAgICAgICAgICBjb21waWxlTm9kZSA9ICRjb21waWxlTm9kZVswXTsKICAgICAgICAgICAgcmVwbGFjZVdpdGgoanFDb2xsZWN0aW9uLCBzbGljZUFyZ3MoJHRlbXBsYXRlKSwgY29tcGlsZU5vZGUpOwoKICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSBjb21waWxlKCR0ZW1wbGF0ZSwgdHJhbnNjbHVkZUZuLCB0ZXJtaW5hbFByaW9yaXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZURpcmVjdGl2ZSAmJiByZXBsYWNlRGlyZWN0aXZlLm5hbWUsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgcGFzcyBpbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBjb250cm9sbGVyRGlyZWN0aXZlcyAtIG90aGVyd2lzZSB3ZSdsbCBjcmVhdGUgZHVwbGljYXRlcyBjb250cm9sbGVycwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAtIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSBvciB0ZW1wbGF0ZURpcmVjdGl2ZSAtIGNvbWJpbmluZyB0ZW1wbGF0ZXMgd2l0aAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgIGVsZW1lbnQgdHJhbnNjbHVzaW9uIGRvZXNuJ3QgbWFrZSBzZW5zZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgbmVlZCBvbmx5IG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUgc28gdGhhdCB3ZSBwcmV2ZW50IHB1dHRpbmcgdHJhbnNjbHVzaW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9uIHRoZSBzYW1lIGVsZW1lbnQgbW9yZSB0aGFuIG9uY2UuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmU6IG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJHRlbXBsYXRlID0ganFMaXRlKGpxTGl0ZUNsb25lKGNvbXBpbGVOb2RlKSkuY29udGVudHMoKTsKICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmVtcHR5KCk7IC8vIGNsZWFyIGNvbnRlbnRzCiAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gY29tcGlsZSgkdGVtcGxhdGUsIHRyYW5zY2x1ZGVGbik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoZGlyZWN0aXZlLnRlbXBsYXRlKSB7CiAgICAgICAgICBoYXNUZW1wbGF0ZSA9IHRydWU7CiAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgndGVtcGxhdGUnLCB0ZW1wbGF0ZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CgogICAgICAgICAgZGlyZWN0aXZlVmFsdWUgPSAoaXNGdW5jdGlvbihkaXJlY3RpdmUudGVtcGxhdGUpKQogICAgICAgICAgICAgID8gZGlyZWN0aXZlLnRlbXBsYXRlKCRjb21waWxlTm9kZSwgdGVtcGxhdGVBdHRycykKICAgICAgICAgICAgICA6IGRpcmVjdGl2ZS50ZW1wbGF0ZTsKCiAgICAgICAgICBkaXJlY3RpdmVWYWx1ZSA9IGRlbm9ybWFsaXplVGVtcGxhdGUoZGlyZWN0aXZlVmFsdWUpOwoKICAgICAgICAgIGlmIChkaXJlY3RpdmUucmVwbGFjZSkgewogICAgICAgICAgICByZXBsYWNlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICBpZiAoanFMaXRlSXNUZXh0Tm9kZShkaXJlY3RpdmVWYWx1ZSkpIHsKICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBbXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAkdGVtcGxhdGUgPSByZW1vdmVDb21tZW50cyh3cmFwVGVtcGxhdGUoZGlyZWN0aXZlLnRlbXBsYXRlTmFtZXNwYWNlLCB0cmltKGRpcmVjdGl2ZVZhbHVlKSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJHRlbXBsYXRlWzBdOwoKICAgICAgICAgICAgaWYgKCR0ZW1wbGF0ZS5sZW5ndGggIT0gMSB8fCBjb21waWxlTm9kZS5ub2RlVHlwZSAhPT0gTk9ERV9UWVBFX0VMRU1FTlQpIHsKICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycigndHBscnQnLAogICAgICAgICAgICAgICAgICAiVGVtcGxhdGUgZm9yIGRpcmVjdGl2ZSAnezB9JyBtdXN0IGhhdmUgZXhhY3RseSBvbmUgcm9vdCBlbGVtZW50LiB7MX0iLAogICAgICAgICAgICAgICAgICBkaXJlY3RpdmVOYW1lLCAnJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlcGxhY2VXaXRoKGpxQ29sbGVjdGlvbiwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CgogICAgICAgICAgICB2YXIgbmV3VGVtcGxhdGVBdHRycyA9IHskYXR0cjoge319OwoKICAgICAgICAgICAgLy8gY29tYmluZSBkaXJlY3RpdmVzIGZyb20gdGhlIG9yaWdpbmFsIG5vZGUgYW5kIGZyb20gdGhlIHRlbXBsYXRlOgogICAgICAgICAgICAvLyAtIHRha2UgdGhlIGFycmF5IG9mIGRpcmVjdGl2ZXMgZm9yIHRoaXMgZWxlbWVudAogICAgICAgICAgICAvLyAtIHNwbGl0IGl0IGludG8gdHdvIHBhcnRzLCB0aG9zZSB0aGF0IGFscmVhZHkgYXBwbGllZCAocHJvY2Vzc2VkKSBhbmQgdGhvc2UgdGhhdCB3ZXJlbid0ICh1bnByb2Nlc3NlZCkKICAgICAgICAgICAgLy8gLSBjb2xsZWN0IGRpcmVjdGl2ZXMgZnJvbSB0aGUgdGVtcGxhdGUgYW5kIHNvcnQgdGhlbSBieSBwcmlvcml0eQogICAgICAgICAgICAvLyAtIGNvbWJpbmUgZGlyZWN0aXZlcyBhczogcHJvY2Vzc2VkICsgdGVtcGxhdGUgKyB1bnByb2Nlc3NlZAogICAgICAgICAgICB2YXIgdGVtcGxhdGVEaXJlY3RpdmVzID0gY29sbGVjdERpcmVjdGl2ZXMoY29tcGlsZU5vZGUsIFtdLCBuZXdUZW1wbGF0ZUF0dHJzKTsKICAgICAgICAgICAgdmFyIHVucHJvY2Vzc2VkRGlyZWN0aXZlcyA9IGRpcmVjdGl2ZXMuc3BsaWNlKGkgKyAxLCBkaXJlY3RpdmVzLmxlbmd0aCAtIChpICsgMSkpOwoKICAgICAgICAgICAgaWYgKG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSkgewogICAgICAgICAgICAgIG1hcmtEaXJlY3RpdmVzQXNJc29sYXRlKHRlbXBsYXRlRGlyZWN0aXZlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlyZWN0aXZlcyA9IGRpcmVjdGl2ZXMuY29uY2F0KHRlbXBsYXRlRGlyZWN0aXZlcykuY29uY2F0KHVucHJvY2Vzc2VkRGlyZWN0aXZlcyk7CiAgICAgICAgICAgIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKHRlbXBsYXRlQXR0cnMsIG5ld1RlbXBsYXRlQXR0cnMpOwoKICAgICAgICAgICAgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICRjb21waWxlTm9kZS5odG1sKGRpcmVjdGl2ZVZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChkaXJlY3RpdmUudGVtcGxhdGVVcmwpIHsKICAgICAgICAgIGhhc1RlbXBsYXRlID0gdHJ1ZTsKICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0ZW1wbGF0ZScsIHRlbXBsYXRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKCiAgICAgICAgICBpZiAoZGlyZWN0aXZlLnJlcGxhY2UpIHsKICAgICAgICAgICAgcmVwbGFjZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBub2RlTGlua0ZuID0gY29tcGlsZVRlbXBsYXRlVXJsKGRpcmVjdGl2ZXMuc3BsaWNlKGksIGRpcmVjdGl2ZXMubGVuZ3RoIC0gaSksICRjb21waWxlTm9kZSwKICAgICAgICAgICAgICB0ZW1wbGF0ZUF0dHJzLCBqcUNvbGxlY3Rpb24sIGhhc1RyYW5zY2x1ZGVEaXJlY3RpdmUgJiYgY2hpbGRUcmFuc2NsdWRlRm4sIHByZUxpbmtGbnMsIHBvc3RMaW5rRm5zLCB7CiAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlczogY29udHJvbGxlckRpcmVjdGl2ZXMsCiAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmU6IG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlOiB0ZW1wbGF0ZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgIG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmU6IG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUKICAgICAgICAgICAgICB9KTsKICAgICAgICAgIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7CiAgICAgICAgfSBlbHNlIGlmIChkaXJlY3RpdmUuY29tcGlsZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbGlua0ZuID0gZGlyZWN0aXZlLmNvbXBpbGUoJGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCBjaGlsZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGxpbmtGbikpIHsKICAgICAgICAgICAgICBhZGRMaW5rRm5zKG51bGwsIGxpbmtGbiwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChsaW5rRm4pIHsKICAgICAgICAgICAgICBhZGRMaW5rRm5zKGxpbmtGbi5wcmUsIGxpbmtGbi5wb3N0LCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUsIHN0YXJ0aW5nVGFnKCRjb21waWxlTm9kZSkpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGRpcmVjdGl2ZS50ZXJtaW5hbCkgewogICAgICAgICAgbm9kZUxpbmtGbi50ZXJtaW5hbCA9IHRydWU7CiAgICAgICAgICB0ZXJtaW5hbFByaW9yaXR5ID0gTWF0aC5tYXgodGVybWluYWxQcmlvcml0eSwgZGlyZWN0aXZlLnByaW9yaXR5KTsKICAgICAgICB9CgogICAgICB9CgogICAgICBub2RlTGlua0ZuLnNjb3BlID0gbmV3U2NvcGVEaXJlY3RpdmUgJiYgbmV3U2NvcGVEaXJlY3RpdmUuc2NvcGUgPT09IHRydWU7CiAgICAgIG5vZGVMaW5rRm4udHJhbnNjbHVkZU9uVGhpc0VsZW1lbnQgPSBoYXNUcmFuc2NsdWRlRGlyZWN0aXZlOwogICAgICBub2RlTGlua0ZuLmVsZW1lbnRUcmFuc2NsdWRlT25UaGlzRWxlbWVudCA9IGhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlOwogICAgICBub2RlTGlua0ZuLnRlbXBsYXRlT25UaGlzRWxlbWVudCA9IGhhc1RlbXBsYXRlOwogICAgICBub2RlTGlua0ZuLnRyYW5zY2x1ZGUgPSBjaGlsZFRyYW5zY2x1ZGVGbjsKCiAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQuaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUgPSBoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZTsKCiAgICAgIC8vIG1pZ2h0IGJlIG5vcm1hbCBvciBkZWxheWVkIG5vZGVMaW5rRm4gZGVwZW5kaW5nIG9uIGlmIHRlbXBsYXRlVXJsIGlzIHByZXNlbnQKICAgICAgcmV0dXJuIG5vZGVMaW5rRm47CgogICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgZnVuY3Rpb24gYWRkTGlua0ZucyhwcmUsIHBvc3QsIGF0dHJTdGFydCwgYXR0ckVuZCkgewogICAgICAgIGlmIChwcmUpIHsKICAgICAgICAgIGlmIChhdHRyU3RhcnQpIHByZSA9IGdyb3VwRWxlbWVudHNMaW5rRm5XcmFwcGVyKHByZSwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgIHByZS5yZXF1aXJlID0gZGlyZWN0aXZlLnJlcXVpcmU7CiAgICAgICAgICBwcmUuZGlyZWN0aXZlTmFtZSA9IGRpcmVjdGl2ZU5hbWU7CiAgICAgICAgICBpZiAobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlID09PSBkaXJlY3RpdmUgfHwgZGlyZWN0aXZlLiQkaXNvbGF0ZVNjb3BlKSB7CiAgICAgICAgICAgIHByZSA9IGNsb25lQW5kQW5ub3RhdGVGbihwcmUsIHtpc29sYXRlU2NvcGU6IHRydWV9KTsKICAgICAgICAgIH0KICAgICAgICAgIHByZUxpbmtGbnMucHVzaChwcmUpOwogICAgICAgIH0KICAgICAgICBpZiAocG9zdCkgewogICAgICAgICAgaWYgKGF0dHJTdGFydCkgcG9zdCA9IGdyb3VwRWxlbWVudHNMaW5rRm5XcmFwcGVyKHBvc3QsIGF0dHJTdGFydCwgYXR0ckVuZCk7CiAgICAgICAgICBwb3N0LnJlcXVpcmUgPSBkaXJlY3RpdmUucmVxdWlyZTsKICAgICAgICAgIHBvc3QuZGlyZWN0aXZlTmFtZSA9IGRpcmVjdGl2ZU5hbWU7CiAgICAgICAgICBpZiAobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlID09PSBkaXJlY3RpdmUgfHwgZGlyZWN0aXZlLiQkaXNvbGF0ZVNjb3BlKSB7CiAgICAgICAgICAgIHBvc3QgPSBjbG9uZUFuZEFubm90YXRlRm4ocG9zdCwge2lzb2xhdGVTY29wZTogdHJ1ZX0pOwogICAgICAgICAgfQogICAgICAgICAgcG9zdExpbmtGbnMucHVzaChwb3N0KTsKICAgICAgICB9CiAgICAgIH0KCgogICAgICBmdW5jdGlvbiBnZXRDb250cm9sbGVycyhkaXJlY3RpdmVOYW1lLCByZXF1aXJlLCAkZWxlbWVudCwgZWxlbWVudENvbnRyb2xsZXJzKSB7CiAgICAgICAgdmFyIHZhbHVlLCByZXRyaWV2YWxNZXRob2QgPSAnZGF0YScsIG9wdGlvbmFsID0gZmFsc2U7CiAgICAgICAgdmFyICRzZWFyY2hFbGVtZW50ID0gJGVsZW1lbnQ7CiAgICAgICAgdmFyIG1hdGNoOwogICAgICAgIGlmIChpc1N0cmluZyhyZXF1aXJlKSkgewogICAgICAgICAgbWF0Y2ggPSByZXF1aXJlLm1hdGNoKFJFUVVJUkVfUFJFRklYX1JFR0VYUCk7CiAgICAgICAgICByZXF1aXJlID0gcmVxdWlyZS5zdWJzdHJpbmcobWF0Y2hbMF0ubGVuZ3RoKTsKCiAgICAgICAgICBpZiAobWF0Y2hbM10pIHsKICAgICAgICAgICAgaWYgKG1hdGNoWzFdKSBtYXRjaFszXSA9IG51bGw7CiAgICAgICAgICAgIGVsc2UgbWF0Y2hbMV0gPSBtYXRjaFszXTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtYXRjaFsxXSA9PT0gJ14nKSB7CiAgICAgICAgICAgIHJldHJpZXZhbE1ldGhvZCA9ICdpbmhlcml0ZWREYXRhJzsKICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2hbMV0gPT09ICdeXicpIHsKICAgICAgICAgICAgcmV0cmlldmFsTWV0aG9kID0gJ2luaGVyaXRlZERhdGEnOwogICAgICAgICAgICAkc2VhcmNoRWxlbWVudCA9ICRlbGVtZW50LnBhcmVudCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1hdGNoWzJdID09PSAnPycpIHsKICAgICAgICAgICAgb3B0aW9uYWwgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIHZhbHVlID0gbnVsbDsKCiAgICAgICAgICBpZiAoZWxlbWVudENvbnRyb2xsZXJzICYmIHJldHJpZXZhbE1ldGhvZCA9PT0gJ2RhdGEnKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9IGVsZW1lbnRDb250cm9sbGVyc1tyZXF1aXJlXSkgewogICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhbHVlID0gdmFsdWUgfHwgJHNlYXJjaEVsZW1lbnRbcmV0cmlldmFsTWV0aG9kXSgnJCcgKyByZXF1aXJlICsgJ0NvbnRyb2xsZXInKTsKCiAgICAgICAgICBpZiAoIXZhbHVlICYmICFvcHRpb25hbCkgewogICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycignY3RyZXEnLAogICAgICAgICAgICAgICAgIkNvbnRyb2xsZXIgJ3swfScsIHJlcXVpcmVkIGJ5IGRpcmVjdGl2ZSAnezF9JywgY2FuJ3QgYmUgZm91bmQhIiwKICAgICAgICAgICAgICAgIHJlcXVpcmUsIGRpcmVjdGl2ZU5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShyZXF1aXJlKSkgewogICAgICAgICAgdmFsdWUgPSBbXTsKICAgICAgICAgIGZvckVhY2gocmVxdWlyZSwgZnVuY3Rpb24ocmVxdWlyZSkgewogICAgICAgICAgICB2YWx1ZS5wdXNoKGdldENvbnRyb2xsZXJzKGRpcmVjdGl2ZU5hbWUsIHJlcXVpcmUsICRlbGVtZW50LCBlbGVtZW50Q29udHJvbGxlcnMpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KCgogICAgICBmdW5jdGlvbiBub2RlTGlua0ZuKGNoaWxkTGlua0ZuLCBzY29wZSwgbGlua05vZGUsICRyb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICB2YXIgaSwgaWksIGxpbmtGbiwgY29udHJvbGxlciwgaXNvbGF0ZVNjb3BlLCBlbGVtZW50Q29udHJvbGxlcnMsIHRyYW5zY2x1ZGVGbiwgJGVsZW1lbnQsCiAgICAgICAgICAgIGF0dHJzOwoKICAgICAgICBpZiAoY29tcGlsZU5vZGUgPT09IGxpbmtOb2RlKSB7CiAgICAgICAgICBhdHRycyA9IHRlbXBsYXRlQXR0cnM7CiAgICAgICAgICAkZWxlbWVudCA9IHRlbXBsYXRlQXR0cnMuJCRlbGVtZW50OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAkZWxlbWVudCA9IGpxTGl0ZShsaW5rTm9kZSk7CiAgICAgICAgICBhdHRycyA9IG5ldyBBdHRyaWJ1dGVzKCRlbGVtZW50LCB0ZW1wbGF0ZUF0dHJzKTsKICAgICAgICB9CgogICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUpIHsKICAgICAgICAgIGlzb2xhdGVTY29wZSA9IHNjb3BlLiRuZXcodHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICB0cmFuc2NsdWRlRm4gPSBib3VuZFRyYW5zY2x1ZGVGbiAmJiBjb250cm9sbGVyc0JvdW5kVHJhbnNjbHVkZTsKICAgICAgICBpZiAoY29udHJvbGxlckRpcmVjdGl2ZXMpIHsKICAgICAgICAgIC8vIFRPRE86IG1lcmdlIGBjb250cm9sbGVyc2AgYW5kIGBlbGVtZW50Q29udHJvbGxlcnNgIGludG8gc2luZ2xlIG9iamVjdC4KICAgICAgICAgIGNvbnRyb2xsZXJzID0ge307CiAgICAgICAgICBlbGVtZW50Q29udHJvbGxlcnMgPSB7fTsKICAgICAgICAgIGZvckVhY2goY29udHJvbGxlckRpcmVjdGl2ZXMsIGZ1bmN0aW9uKGRpcmVjdGl2ZSkgewogICAgICAgICAgICB2YXIgbG9jYWxzID0gewogICAgICAgICAgICAgICRzY29wZTogZGlyZWN0aXZlID09PSBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgfHwgZGlyZWN0aXZlLiQkaXNvbGF0ZVNjb3BlID8gaXNvbGF0ZVNjb3BlIDogc2NvcGUsCiAgICAgICAgICAgICAgJGVsZW1lbnQ6ICRlbGVtZW50LAogICAgICAgICAgICAgICRhdHRyczogYXR0cnMsCiAgICAgICAgICAgICAgJHRyYW5zY2x1ZGU6IHRyYW5zY2x1ZGVGbgogICAgICAgICAgICB9LCBjb250cm9sbGVySW5zdGFuY2U7CgogICAgICAgICAgICBjb250cm9sbGVyID0gZGlyZWN0aXZlLmNvbnRyb2xsZXI7CiAgICAgICAgICAgIGlmIChjb250cm9sbGVyID09ICdAJykgewogICAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBhdHRyc1tkaXJlY3RpdmUubmFtZV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRyb2xsZXJJbnN0YW5jZSA9ICRjb250cm9sbGVyKGNvbnRyb2xsZXIsIGxvY2FscywgdHJ1ZSwgZGlyZWN0aXZlLmNvbnRyb2xsZXJBcyk7CgogICAgICAgICAgICAvLyBGb3IgZGlyZWN0aXZlcyB3aXRoIGVsZW1lbnQgdHJhbnNjbHVzaW9uIHRoZSBlbGVtZW50IGlzIGEgY29tbWVudCwKICAgICAgICAgICAgLy8gYnV0IGpRdWVyeSAuZGF0YSBkb2Vzbid0IHN1cHBvcnQgYXR0YWNoaW5nIGRhdGEgdG8gY29tbWVudCBub2RlcyBhcyBpdCdzIGhhcmQgdG8KICAgICAgICAgICAgLy8gY2xlYW4gdXAgKGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzgzMzUpLgogICAgICAgICAgICAvLyBJbnN0ZWFkLCB3ZSBzYXZlIHRoZSBjb250cm9sbGVycyBmb3IgdGhlIGVsZW1lbnQgaW4gYSBsb2NhbCBoYXNoIGFuZCBhdHRhY2ggdG8gLmRhdGEKICAgICAgICAgICAgLy8gbGF0ZXIsIG9uY2Ugd2UgaGF2ZSB0aGUgYWN0dWFsIGVsZW1lbnQuCiAgICAgICAgICAgIGVsZW1lbnRDb250cm9sbGVyc1tkaXJlY3RpdmUubmFtZV0gPSBjb250cm9sbGVySW5zdGFuY2U7CiAgICAgICAgICAgIGlmICghaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAkZWxlbWVudC5kYXRhKCckJyArIGRpcmVjdGl2ZS5uYW1lICsgJ0NvbnRyb2xsZXInLCBjb250cm9sbGVySW5zdGFuY2UuaW5zdGFuY2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb250cm9sbGVyc1tkaXJlY3RpdmUubmFtZV0gPSBjb250cm9sbGVySW5zdGFuY2U7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUpIHsKICAgICAgICAgIHZhciBMT0NBTF9SRUdFWFAgPSAvXlxzKihbQD0mXSkoXD8/KVxzKihcdyopXHMqJC87CgogICAgICAgICAgY29tcGlsZS4kJGFkZFNjb3BlSW5mbygkZWxlbWVudCwgaXNvbGF0ZVNjb3BlLCB0cnVlLCAhKHRlbXBsYXRlRGlyZWN0aXZlICYmICh0ZW1wbGF0ZURpcmVjdGl2ZSA9PT0gbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlIHx8CiAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPT09IG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS4kJG9yaWdpbmFsRGlyZWN0aXZlKSkpOwogICAgICAgICAgY29tcGlsZS4kJGFkZFNjb3BlQ2xhc3MoJGVsZW1lbnQsIHRydWUpOwoKICAgICAgICAgIHZhciBpc29sYXRlU2NvcGVDb250cm9sbGVyID0gY29udHJvbGxlcnMgJiYgY29udHJvbGxlcnNbbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWVdOwogICAgICAgICAgdmFyIGlzb2xhdGVCaW5kaW5nQ29udGV4dCA9IGlzb2xhdGVTY29wZTsKICAgICAgICAgIGlmIChpc29sYXRlU2NvcGVDb250cm9sbGVyICYmIGlzb2xhdGVTY29wZUNvbnRyb2xsZXIuaWRlbnRpZmllciAmJgogICAgICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS5iaW5kVG9Db250cm9sbGVyID09PSB0cnVlKSB7CiAgICAgICAgICAgIGlzb2xhdGVCaW5kaW5nQ29udGV4dCA9IGlzb2xhdGVTY29wZUNvbnRyb2xsZXIuaW5zdGFuY2U7CiAgICAgICAgICB9CgogICAgICAgICAgZm9yRWFjaChpc29sYXRlU2NvcGUuJCRpc29sYXRlQmluZGluZ3MgPSBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUuJCRpc29sYXRlQmluZGluZ3MsIGZ1bmN0aW9uKGRlZmluaXRpb24sIHNjb3BlTmFtZSkgewogICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSBkZWZpbml0aW9uLmF0dHJOYW1lLAogICAgICAgICAgICAgICAgb3B0aW9uYWwgPSBkZWZpbml0aW9uLm9wdGlvbmFsLAogICAgICAgICAgICAgICAgbW9kZSA9IGRlZmluaXRpb24ubW9kZSwgLy8gQCwgPSwgb3IgJgogICAgICAgICAgICAgICAgbGFzdFZhbHVlLAogICAgICAgICAgICAgICAgcGFyZW50R2V0LCBwYXJlbnRTZXQsIGNvbXBhcmU7CgogICAgICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKCiAgICAgICAgICAgICAgY2FzZSAnQCc6CiAgICAgICAgICAgICAgICBhdHRycy4kb2JzZXJ2ZShhdHRyTmFtZSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgaXNvbGF0ZUJpbmRpbmdDb250ZXh0W3Njb3BlTmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYXR0cnMuJCRvYnNlcnZlcnNbYXR0ck5hbWVdLiQkc2NvcGUgPSBzY29wZTsKICAgICAgICAgICAgICAgIGlmKCBhdHRyc1thdHRyTmFtZV0gKSB7CiAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBhdHRyaWJ1dGUgaGFzIGJlZW4gcHJvdmlkZWQgdGhlbiB3ZSB0cmlnZ2VyIGFuIGludGVycG9sYXRpb24gdG8gZW5zdXJlCiAgICAgICAgICAgICAgICAgIC8vIHRoZSB2YWx1ZSBpcyB0aGVyZSBmb3IgdXNlIGluIHRoZSBsaW5rIGZuCiAgICAgICAgICAgICAgICAgIGlzb2xhdGVCaW5kaW5nQ29udGV4dFtzY29wZU5hbWVdID0gJGludGVycG9sYXRlKGF0dHJzW2F0dHJOYW1lXSkoc2NvcGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgJz0nOgogICAgICAgICAgICAgICAgaWYgKG9wdGlvbmFsICYmICFhdHRyc1thdHRyTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFyZW50R2V0ID0gJHBhcnNlKGF0dHJzW2F0dHJOYW1lXSk7CiAgICAgICAgICAgICAgICBpZiAocGFyZW50R2V0LmxpdGVyYWwpIHsKICAgICAgICAgICAgICAgICAgY29tcGFyZSA9IGVxdWFsczsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbXBhcmUgPSBmdW5jdGlvbihhLGIpIHsgcmV0dXJuIGEgPT09IGIgfHwgKGEgIT09IGEgJiYgYiAhPT0gYik7IH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJlbnRTZXQgPSBwYXJlbnRHZXQuYXNzaWduIHx8IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAvLyByZXNldCB0aGUgY2hhbmdlLCBvciB3ZSB3aWxsIHRocm93IHRoaXMgZXhjZXB0aW9uIG9uIGV2ZXJ5ICRkaWdlc3QKICAgICAgICAgICAgICAgICAgbGFzdFZhbHVlID0gaXNvbGF0ZUJpbmRpbmdDb250ZXh0W3Njb3BlTmFtZV0gPSBwYXJlbnRHZXQoc2NvcGUpOwogICAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycignbm9uYXNzaWduJywKICAgICAgICAgICAgICAgICAgICAgICJFeHByZXNzaW9uICd7MH0nIHVzZWQgd2l0aCBkaXJlY3RpdmUgJ3sxfScgaXMgbm9uLWFzc2lnbmFibGUhIiwKICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW2F0dHJOYW1lXSwgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWUpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IGlzb2xhdGVCaW5kaW5nQ29udGV4dFtzY29wZU5hbWVdID0gcGFyZW50R2V0KHNjb3BlKTsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnRWYWx1ZVdhdGNoID0gZnVuY3Rpb24gcGFyZW50VmFsdWVXYXRjaChwYXJlbnRWYWx1ZSkgewogICAgICAgICAgICAgICAgICBpZiAoIWNvbXBhcmUocGFyZW50VmFsdWUsIGlzb2xhdGVCaW5kaW5nQ29udGV4dFtzY29wZU5hbWVdKSkgewogICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBvdXQgb2Ygc3luYyBhbmQgbmVlZCB0byBjb3B5CiAgICAgICAgICAgICAgICAgICAgaWYgKCFjb21wYXJlKHBhcmVudFZhbHVlLCBsYXN0VmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBwYXJlbnQgY2hhbmdlZCBhbmQgaXQgaGFzIHByZWNlZGVuY2UKICAgICAgICAgICAgICAgICAgICAgIGlzb2xhdGVCaW5kaW5nQ29udGV4dFtzY29wZU5hbWVdID0gcGFyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBwYXJlbnQgY2FuIGJlIGFzc2lnbmVkIHRoZW4gZG8gc28KICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFNldChzY29wZSwgcGFyZW50VmFsdWUgPSBpc29sYXRlQmluZGluZ0NvbnRleHRbc2NvcGVOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBsYXN0VmFsdWUgPSBwYXJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBwYXJlbnRWYWx1ZVdhdGNoLiRzdGF0ZWZ1bCA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgdW53YXRjaCA9IHNjb3BlLiR3YXRjaCgkcGFyc2UoYXR0cnNbYXR0ck5hbWVdLCBwYXJlbnRWYWx1ZVdhdGNoKSwgbnVsbCwgcGFyZW50R2V0LmxpdGVyYWwpOwogICAgICAgICAgICAgICAgaXNvbGF0ZVNjb3BlLiRvbignJGRlc3Ryb3knLCB1bndhdGNoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlICcmJzoKICAgICAgICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgaXNvbGF0ZUJpbmRpbmdDb250ZXh0W3Njb3BlTmFtZV0gPSBmdW5jdGlvbihsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudEdldChzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChjb250cm9sbGVycykgewogICAgICAgICAgZm9yRWFjaChjb250cm9sbGVycywgZnVuY3Rpb24oY29udHJvbGxlcikgewogICAgICAgICAgICBjb250cm9sbGVyKCk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGNvbnRyb2xsZXJzID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIC8vIFBSRUxJTktJTkcKICAgICAgICBmb3IoaSA9IDAsIGlpID0gcHJlTGlua0Zucy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICBsaW5rRm4gPSBwcmVMaW5rRm5zW2ldOwogICAgICAgICAgaW52b2tlTGlua0ZuKGxpbmtGbiwKICAgICAgICAgICAgICBsaW5rRm4uaXNvbGF0ZVNjb3BlID8gaXNvbGF0ZVNjb3BlIDogc2NvcGUsCiAgICAgICAgICAgICAgJGVsZW1lbnQsCiAgICAgICAgICAgICAgYXR0cnMsCiAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLmRpcmVjdGl2ZU5hbWUsIGxpbmtGbi5yZXF1aXJlLCAkZWxlbWVudCwgZWxlbWVudENvbnRyb2xsZXJzKSwKICAgICAgICAgICAgICB0cmFuc2NsdWRlRm4KICAgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICAvLyBSRUNVUlNJT04KICAgICAgICAvLyBXZSBvbmx5IHBhc3MgdGhlIGlzb2xhdGUgc2NvcGUsIGlmIHRoZSBpc29sYXRlIGRpcmVjdGl2ZSBoYXMgYSB0ZW1wbGF0ZSwKICAgICAgICAvLyBvdGhlcndpc2UgdGhlIGNoaWxkIGVsZW1lbnRzIGRvIG5vdCBiZWxvbmcgdG8gdGhlIGlzb2xhdGUgZGlyZWN0aXZlLgogICAgICAgIHZhciBzY29wZVRvQ2hpbGQgPSBzY29wZTsKICAgICAgICBpZiAobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlICYmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUudGVtcGxhdGUgfHwgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLnRlbXBsYXRlVXJsID09PSBudWxsKSkgewogICAgICAgICAgc2NvcGVUb0NoaWxkID0gaXNvbGF0ZVNjb3BlOwogICAgICAgIH0KICAgICAgICBjaGlsZExpbmtGbiAmJiBjaGlsZExpbmtGbihzY29wZVRvQ2hpbGQsIGxpbmtOb2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwoKICAgICAgICAvLyBQT1NUTElOS0lORwogICAgICAgIGZvcihpID0gcG9zdExpbmtGbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgIGxpbmtGbiA9IHBvc3RMaW5rRm5zW2ldOwogICAgICAgICAgaW52b2tlTGlua0ZuKGxpbmtGbiwKICAgICAgICAgICAgICBsaW5rRm4uaXNvbGF0ZVNjb3BlID8gaXNvbGF0ZVNjb3BlIDogc2NvcGUsCiAgICAgICAgICAgICAgJGVsZW1lbnQsCiAgICAgICAgICAgICAgYXR0cnMsCiAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLmRpcmVjdGl2ZU5hbWUsIGxpbmtGbi5yZXF1aXJlLCAkZWxlbWVudCwgZWxlbWVudENvbnRyb2xsZXJzKSwKICAgICAgICAgICAgICB0cmFuc2NsdWRlRm4KICAgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICAvLyBUaGlzIGlzIHRoZSBmdW5jdGlvbiB0aGF0IGlzIGluamVjdGVkIGFzIGAkdHJhbnNjbHVkZWAuCiAgICAgICAgLy8gTm90ZTogYWxsIGFyZ3VtZW50cyBhcmUgb3B0aW9uYWwhCiAgICAgICAgZnVuY3Rpb24gY29udHJvbGxlcnNCb3VuZFRyYW5zY2x1ZGUoc2NvcGUsIGNsb25lQXR0YWNoRm4sIGZ1dHVyZVBhcmVudEVsZW1lbnQpIHsKICAgICAgICAgIHZhciB0cmFuc2NsdWRlQ29udHJvbGxlcnM7CgogICAgICAgICAgLy8gTm8gc2NvcGUgcGFzc2VkIGluOgogICAgICAgICAgaWYgKCFpc1Njb3BlKHNjb3BlKSkgewogICAgICAgICAgICBmdXR1cmVQYXJlbnRFbGVtZW50ID0gY2xvbmVBdHRhY2hGbjsKICAgICAgICAgICAgY2xvbmVBdHRhY2hGbiA9IHNjb3BlOwogICAgICAgICAgICBzY29wZSA9IHVuZGVmaW5lZDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgdHJhbnNjbHVkZUNvbnRyb2xsZXJzID0gZWxlbWVudENvbnRyb2xsZXJzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFmdXR1cmVQYXJlbnRFbGVtZW50KSB7CiAgICAgICAgICAgIGZ1dHVyZVBhcmVudEVsZW1lbnQgPSBoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSA/ICRlbGVtZW50LnBhcmVudCgpIDogJGVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYm91bmRUcmFuc2NsdWRlRm4oc2NvcGUsIGNsb25lQXR0YWNoRm4sIHRyYW5zY2x1ZGVDb250cm9sbGVycywgZnV0dXJlUGFyZW50RWxlbWVudCwgc2NvcGVUb0NoaWxkKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBtYXJrRGlyZWN0aXZlc0FzSXNvbGF0ZShkaXJlY3RpdmVzKSB7CiAgICAgIC8vIG1hcmsgYWxsIGRpcmVjdGl2ZXMgYXMgbmVlZGluZyBpc29sYXRlIHNjb3BlLgogICAgICBmb3IgKHZhciBqID0gMCwgamogPSBkaXJlY3RpdmVzLmxlbmd0aDsgaiA8IGpqOyBqKyspIHsKICAgICAgICBkaXJlY3RpdmVzW2pdID0gaW5oZXJpdChkaXJlY3RpdmVzW2pdLCB7JCRpc29sYXRlU2NvcGU6IHRydWV9KTsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogbG9va3MgdXAgdGhlIGRpcmVjdGl2ZSBhbmQgZGVjb3JhdGVzIGl0IHdpdGggZXhjZXB0aW9uIGhhbmRsaW5nIGFuZCBwcm9wZXIgcGFyYW1ldGVycy4gV2UKICAgICAqIGNhbGwgdGhpcyB0aGUgYm91bmREaXJlY3RpdmUuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgbmFtZSBvZiB0aGUgZGlyZWN0aXZlIHRvIGxvb2sgdXAuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbG9jYXRpb24gVGhlIGRpcmVjdGl2ZSBtdXN0IGJlIGZvdW5kIGluIHNwZWNpZmljIGZvcm1hdC4KICAgICAqICAgU3RyaW5nIGNvbnRhaW5pbmcgYW55IG9mIHRoZXNlcyBjaGFyYWN0ZXJzOgogICAgICoKICAgICAqICAgKiBgRWA6IGVsZW1lbnQgbmFtZQogICAgICogICAqIGBBJzogYXR0cmlidXRlCiAgICAgKiAgICogYENgOiBjbGFzcwogICAgICogICAqIGBNYDogY29tbWVudAogICAgICogQHJldHVybnMge2Jvb2xlYW59IHRydWUgaWYgZGlyZWN0aXZlIHdhcyBhZGRlZC4KICAgICAqLwogICAgZnVuY3Rpb24gYWRkRGlyZWN0aXZlKHREaXJlY3RpdmVzLCBuYW1lLCBsb2NhdGlvbiwgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSwgc3RhcnRBdHRyTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRBdHRyTmFtZSkgewogICAgICBpZiAobmFtZSA9PT0gaWdub3JlRGlyZWN0aXZlKSByZXR1cm4gbnVsbDsKICAgICAgdmFyIG1hdGNoID0gbnVsbDsKICAgICAgaWYgKGhhc0RpcmVjdGl2ZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBmb3IodmFyIGRpcmVjdGl2ZSwgZGlyZWN0aXZlcyA9ICRpbmplY3Rvci5nZXQobmFtZSArIFN1ZmZpeCksCiAgICAgICAgICAgIGkgPSAwLCBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOyBpPGlpOyBpKyspIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICAgIGlmICggKG1heFByaW9yaXR5ID09PSB1bmRlZmluZWQgfHwgbWF4UHJpb3JpdHkgPiBkaXJlY3RpdmUucHJpb3JpdHkpICYmCiAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlc3RyaWN0LmluZGV4T2YobG9jYXRpb24pICE9IC0xKSB7CiAgICAgICAgICAgICAgaWYgKHN0YXJ0QXR0ck5hbWUpIHsKICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGluaGVyaXQoZGlyZWN0aXZlLCB7JCRzdGFydDogc3RhcnRBdHRyTmFtZSwgJCRlbmQ6IGVuZEF0dHJOYW1lfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHREaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICBtYXRjaCA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaChlKSB7ICRleGNlcHRpb25IYW5kbGVyKGUpOyB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBsb29rcyB1cCB0aGUgZGlyZWN0aXZlIGFuZCByZXR1cm5zIHRydWUgaWYgaXQgaXMgYSBtdWx0aS1lbGVtZW50IGRpcmVjdGl2ZSwKICAgICAqIGFuZCB0aGVyZWZvcmUgcmVxdWlyZXMgRE9NIG5vZGVzIGJldHdlZW4gLXN0YXJ0IGFuZCAtZW5kIG1hcmtlcnMgdG8gYmUgZ3JvdXBlZAogICAgICogdG9nZXRoZXIuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgbmFtZSBvZiB0aGUgZGlyZWN0aXZlIHRvIGxvb2sgdXAuCiAgICAgKiBAcmV0dXJucyB0cnVlIGlmIGRpcmVjdGl2ZSB3YXMgcmVnaXN0ZXJlZCBhcyBtdWx0aS1lbGVtZW50LgogICAgICovCiAgICBmdW5jdGlvbiBkaXJlY3RpdmVJc011bHRpRWxlbWVudChuYW1lKSB7CiAgICAgIGlmIChoYXNEaXJlY3RpdmVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgZm9yKHZhciBkaXJlY3RpdmUsIGRpcmVjdGl2ZXMgPSAkaW5qZWN0b3IuZ2V0KG5hbWUgKyBTdWZmaXgpLAogICAgICAgICAgICBpID0gMCwgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsgaTxpaTsgaSsrKSB7CiAgICAgICAgICBkaXJlY3RpdmUgPSBkaXJlY3RpdmVzW2ldOwogICAgICAgICAgaWYgKGRpcmVjdGl2ZS5tdWx0aUVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFdoZW4gdGhlIGVsZW1lbnQgaXMgcmVwbGFjZWQgd2l0aCBIVE1MIHRlbXBsYXRlIHRoZW4gdGhlIG5ldyBhdHRyaWJ1dGVzCiAgICAgKiBvbiB0aGUgdGVtcGxhdGUgbmVlZCB0byBiZSBtZXJnZWQgd2l0aCB0aGUgZXhpc3RpbmcgYXR0cmlidXRlcyBpbiB0aGUgRE9NLgogICAgICogVGhlIGRlc2lyZWQgZWZmZWN0IGlzIHRvIGhhdmUgYm90aCBvZiB0aGUgYXR0cmlidXRlcyBwcmVzZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkc3QgZGVzdGluYXRpb24gYXR0cmlidXRlcyAob3JpZ2luYWwgRE9NKQogICAgICogQHBhcmFtIHtvYmplY3R9IHNyYyBzb3VyY2UgYXR0cmlidXRlcyAoZnJvbSB0aGUgZGlyZWN0aXZlIHRlbXBsYXRlKQogICAgICovCiAgICBmdW5jdGlvbiBtZXJnZVRlbXBsYXRlQXR0cmlidXRlcyhkc3QsIHNyYykgewogICAgICB2YXIgc3JjQXR0ciA9IHNyYy4kYXR0ciwKICAgICAgICAgIGRzdEF0dHIgPSBkc3QuJGF0dHIsCiAgICAgICAgICAkZWxlbWVudCA9IGRzdC4kJGVsZW1lbnQ7CgogICAgICAvLyByZWFwcGx5IHRoZSBvbGQgYXR0cmlidXRlcyB0byB0aGUgbmV3IGVsZW1lbnQKICAgICAgZm9yRWFjaChkc3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICBpZiAoa2V5LmNoYXJBdCgwKSAhPSAnJCcpIHsKICAgICAgICAgIGlmIChzcmNba2V5XSAmJiBzcmNba2V5XSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgdmFsdWUgKz0gKGtleSA9PT0gJ3N0eWxlJyA/ICc7JyA6ICcgJykgKyBzcmNba2V5XTsKICAgICAgICAgIH0KICAgICAgICAgIGRzdC4kc2V0KGtleSwgdmFsdWUsIHRydWUsIHNyY0F0dHJba2V5XSk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIC8vIGNvcHkgdGhlIG5ldyBhdHRyaWJ1dGVzIG9uIHRoZSBvbGQgYXR0cnMgb2JqZWN0CiAgICAgIGZvckVhY2goc3JjLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgaWYgKGtleSA9PSAnY2xhc3MnKSB7CiAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGVsZW1lbnQsIHZhbHVlKTsKICAgICAgICAgIGRzdFsnY2xhc3MnXSA9IChkc3RbJ2NsYXNzJ10gPyBkc3RbJ2NsYXNzJ10gKyAnICcgOiAnJykgKyB2YWx1ZTsKICAgICAgICB9IGVsc2UgaWYgKGtleSA9PSAnc3R5bGUnKSB7CiAgICAgICAgICAkZWxlbWVudC5hdHRyKCdzdHlsZScsICRlbGVtZW50LmF0dHIoJ3N0eWxlJykgKyAnOycgKyB2YWx1ZSk7CiAgICAgICAgICBkc3RbJ3N0eWxlJ10gPSAoZHN0WydzdHlsZSddID8gZHN0WydzdHlsZSddICsgJzsnIDogJycpICsgdmFsdWU7CiAgICAgICAgICAvLyBgZHN0YCB3aWxsIG5ldmVyIGNvbnRhaW4gaGFzT3duUHJvcGVydHkgYXMgRE9NIHBhcnNlciB3b24ndCBsZXQgaXQuCiAgICAgICAgICAvLyBZb3Ugd2lsbCBnZXQgYW4gIkludmFsaWRDaGFyYWN0ZXJFcnJvcjogRE9NIEV4Y2VwdGlvbiA1IiBlcnJvciBpZiB5b3UKICAgICAgICAgIC8vIGhhdmUgYW4gYXR0cmlidXRlIGxpa2UgImhhcy1vd24tcHJvcGVydHkiIG9yICJkYXRhLWhhcy1vd24tcHJvcGVydHkiLCBldGMuCiAgICAgICAgfSBlbHNlIGlmIChrZXkuY2hhckF0KDApICE9ICckJyAmJiAhZHN0Lmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgIGRzdFtrZXldID0gdmFsdWU7CiAgICAgICAgICBkc3RBdHRyW2tleV0gPSBzcmNBdHRyW2tleV07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCgogICAgZnVuY3Rpb24gY29tcGlsZVRlbXBsYXRlVXJsKGRpcmVjdGl2ZXMsICRjb21waWxlTm9kZSwgdEF0dHJzLAogICAgICAgICRyb290RWxlbWVudCwgY2hpbGRUcmFuc2NsdWRlRm4sIHByZUxpbmtGbnMsIHBvc3RMaW5rRm5zLCBwcmV2aW91c0NvbXBpbGVDb250ZXh0KSB7CiAgICAgIHZhciBsaW5rUXVldWUgPSBbXSwKICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuLAogICAgICAgICAgYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLAogICAgICAgICAgYmVmb3JlVGVtcGxhdGVDb21waWxlTm9kZSA9ICRjb21waWxlTm9kZVswXSwKICAgICAgICAgIG9yaWdBc3luY0RpcmVjdGl2ZSA9IGRpcmVjdGl2ZXMuc2hpZnQoKSwKICAgICAgICAgIC8vIFRoZSBmYWN0IHRoYXQgd2UgaGF2ZSB0byBjb3B5IGFuZCBwYXRjaCB0aGUgZGlyZWN0aXZlIHNlZW1zIHdyb25nIQogICAgICAgICAgZGVyaXZlZFN5bmNEaXJlY3RpdmUgPSBleHRlbmQoe30sIG9yaWdBc3luY0RpcmVjdGl2ZSwgewogICAgICAgICAgICB0ZW1wbGF0ZVVybDogbnVsbCwgdHJhbnNjbHVkZTogbnVsbCwgcmVwbGFjZTogbnVsbCwgJCRvcmlnaW5hbERpcmVjdGl2ZTogb3JpZ0FzeW5jRGlyZWN0aXZlCiAgICAgICAgICB9KSwKICAgICAgICAgIHRlbXBsYXRlVXJsID0gKGlzRnVuY3Rpb24ob3JpZ0FzeW5jRGlyZWN0aXZlLnRlbXBsYXRlVXJsKSkKICAgICAgICAgICAgICA/IG9yaWdBc3luY0RpcmVjdGl2ZS50ZW1wbGF0ZVVybCgkY29tcGlsZU5vZGUsIHRBdHRycykKICAgICAgICAgICAgICA6IG9yaWdBc3luY0RpcmVjdGl2ZS50ZW1wbGF0ZVVybCwKICAgICAgICAgIHRlbXBsYXRlTmFtZXNwYWNlID0gb3JpZ0FzeW5jRGlyZWN0aXZlLnRlbXBsYXRlTmFtZXNwYWNlOwoKICAgICAgJGNvbXBpbGVOb2RlLmVtcHR5KCk7CgogICAgICAkdGVtcGxhdGVSZXF1ZXN0KCRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsKHRlbXBsYXRlVXJsKSkKICAgICAgICAudGhlbihmdW5jdGlvbihjb250ZW50KSB7CiAgICAgICAgICB2YXIgY29tcGlsZU5vZGUsIHRlbXBUZW1wbGF0ZUF0dHJzLCAkdGVtcGxhdGUsIGNoaWxkQm91bmRUcmFuc2NsdWRlRm47CgogICAgICAgICAgY29udGVudCA9IGRlbm9ybWFsaXplVGVtcGxhdGUoY29udGVudCk7CgogICAgICAgICAgaWYgKG9yaWdBc3luY0RpcmVjdGl2ZS5yZXBsYWNlKSB7CiAgICAgICAgICAgIGlmIChqcUxpdGVJc1RleHROb2RlKGNvbnRlbnQpKSB7CiAgICAgICAgICAgICAgJHRlbXBsYXRlID0gW107CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgJHRlbXBsYXRlID0gcmVtb3ZlQ29tbWVudHMod3JhcFRlbXBsYXRlKHRlbXBsYXRlTmFtZXNwYWNlLCB0cmltKGNvbnRlbnQpKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGlsZU5vZGUgPSAkdGVtcGxhdGVbMF07CgogICAgICAgICAgICBpZiAoJHRlbXBsYXRlLmxlbmd0aCAhPSAxIHx8IGNvbXBpbGVOb2RlLm5vZGVUeXBlICE9PSBOT0RFX1RZUEVfRUxFTUVOVCkgewogICAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCd0cGxydCcsCiAgICAgICAgICAgICAgICAgICJUZW1wbGF0ZSBmb3IgZGlyZWN0aXZlICd7MH0nIG11c3QgaGF2ZSBleGFjdGx5IG9uZSByb290IGVsZW1lbnQuIHsxfSIsCiAgICAgICAgICAgICAgICAgIG9yaWdBc3luY0RpcmVjdGl2ZS5uYW1lLCB0ZW1wbGF0ZVVybCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRlbXBUZW1wbGF0ZUF0dHJzID0geyRhdHRyOiB7fX07CiAgICAgICAgICAgIHJlcGxhY2VXaXRoKCRyb290RWxlbWVudCwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURpcmVjdGl2ZXMgPSBjb2xsZWN0RGlyZWN0aXZlcyhjb21waWxlTm9kZSwgW10sIHRlbXBUZW1wbGF0ZUF0dHJzKTsKCiAgICAgICAgICAgIGlmIChpc09iamVjdChvcmlnQXN5bmNEaXJlY3RpdmUuc2NvcGUpKSB7CiAgICAgICAgICAgICAgbWFya0RpcmVjdGl2ZXNBc0lzb2xhdGUodGVtcGxhdGVEaXJlY3RpdmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXJlY3RpdmVzID0gdGVtcGxhdGVEaXJlY3RpdmVzLmNvbmNhdChkaXJlY3RpdmVzKTsKICAgICAgICAgICAgbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXModEF0dHJzLCB0ZW1wVGVtcGxhdGVBdHRycyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb21waWxlTm9kZSA9IGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGU7CiAgICAgICAgICAgICRjb21waWxlTm9kZS5odG1sKGNvbnRlbnQpOwogICAgICAgICAgfQoKICAgICAgICAgIGRpcmVjdGl2ZXMudW5zaGlmdChkZXJpdmVkU3luY0RpcmVjdGl2ZSk7CgogICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4gPSBhcHBseURpcmVjdGl2ZXNUb05vZGUoZGlyZWN0aXZlcywgY29tcGlsZU5vZGUsIHRBdHRycywKICAgICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiwgJGNvbXBpbGVOb2RlLCBvcmlnQXN5bmNEaXJlY3RpdmUsIHByZUxpbmtGbnMsIHBvc3RMaW5rRm5zLAogICAgICAgICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpOwogICAgICAgICAgZm9yRWFjaCgkcm9vdEVsZW1lbnQsIGZ1bmN0aW9uKG5vZGUsIGkpIHsKICAgICAgICAgICAgaWYgKG5vZGUgPT0gY29tcGlsZU5vZGUpIHsKICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbaV0gPSAkY29tcGlsZU5vZGVbMF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuID0gY29tcGlsZU5vZGVzKCRjb21waWxlTm9kZVswXS5jaGlsZE5vZGVzLCBjaGlsZFRyYW5zY2x1ZGVGbik7CgogICAgICAgICAgd2hpbGUobGlua1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICB2YXIgc2NvcGUgPSBsaW5rUXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgIGJlZm9yZVRlbXBsYXRlTGlua05vZGUgPSBsaW5rUXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgIGxpbmtSb290RWxlbWVudCA9IGxpbmtRdWV1ZS5zaGlmdCgpLAogICAgICAgICAgICAgICAgYm91bmRUcmFuc2NsdWRlRm4gPSBsaW5rUXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgIGxpbmtOb2RlID0gJGNvbXBpbGVOb2RlWzBdOwoKICAgICAgICAgICAgaWYgKHNjb3BlLiQkZGVzdHJveWVkKSBjb250aW51ZTsKCiAgICAgICAgICAgIGlmIChiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlICE9PSBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlKSB7CiAgICAgICAgICAgICAgdmFyIG9sZENsYXNzZXMgPSBiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlLmNsYXNzTmFtZTsKCiAgICAgICAgICAgICAgaWYgKCEocHJldmlvdXNDb21waWxlQ29udGV4dC5oYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSAmJgogICAgICAgICAgICAgICAgICBvcmlnQXN5bmNEaXJlY3RpdmUucmVwbGFjZSkpIHsKICAgICAgICAgICAgICAgIC8vIGl0IHdhcyBjbG9uZWQgdGhlcmVmb3JlIHdlIGhhdmUgdG8gY2xvbmUgYXMgd2VsbC4KICAgICAgICAgICAgICAgIGxpbmtOb2RlID0ganFMaXRlQ2xvbmUoY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXBsYWNlV2l0aChsaW5rUm9vdEVsZW1lbnQsIGpxTGl0ZShiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlKSwgbGlua05vZGUpOwoKICAgICAgICAgICAgICAvLyBDb3B5IGluIENTUyBjbGFzc2VzIGZyb20gb3JpZ2luYWwgbm9kZQogICAgICAgICAgICAgIHNhZmVBZGRDbGFzcyhqcUxpdGUobGlua05vZGUpLCBvbGRDbGFzc2VzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4udHJhbnNjbHVkZU9uVGhpc0VsZW1lbnQpIHsKICAgICAgICAgICAgICBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuID0gY3JlYXRlQm91bmRUcmFuc2NsdWRlRm4oc2NvcGUsIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuLnRyYW5zY2x1ZGUsIGJvdW5kVHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuID0gYm91bmRUcmFuc2NsdWRlRm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4oYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLCBzY29wZSwgbGlua05vZGUsICRyb290RWxlbWVudCwKICAgICAgICAgICAgICBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuKTsKICAgICAgICAgIH0KICAgICAgICAgIGxpbmtRdWV1ZSA9IG51bGw7CiAgICAgICAgfSk7CgogICAgICByZXR1cm4gZnVuY3Rpb24gZGVsYXllZE5vZGVMaW5rRm4oaWdub3JlQ2hpbGRMaW5rRm4sIHNjb3BlLCBub2RlLCByb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICB2YXIgY2hpbGRCb3VuZFRyYW5zY2x1ZGVGbiA9IGJvdW5kVHJhbnNjbHVkZUZuOwogICAgICAgIGlmIChzY29wZS4kJGRlc3Ryb3llZCkgcmV0dXJuOwogICAgICAgIGlmIChsaW5rUXVldWUpIHsKICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKHNjb3BlKTsKICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKG5vZGUpOwogICAgICAgICAgbGlua1F1ZXVlLnB1c2gocm9vdEVsZW1lbnQpOwogICAgICAgICAgbGlua1F1ZXVlLnB1c2goY2hpbGRCb3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChhZnRlclRlbXBsYXRlTm9kZUxpbmtGbi50cmFuc2NsdWRlT25UaGlzRWxlbWVudCkgewogICAgICAgICAgICBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuID0gY3JlYXRlQm91bmRUcmFuc2NsdWRlRm4oc2NvcGUsIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuLnRyYW5zY2x1ZGUsIGJvdW5kVHJhbnNjbHVkZUZuKTsKICAgICAgICAgIH0KICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuKGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwgc2NvcGUsIG5vZGUsIHJvb3RFbGVtZW50LCBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CgoKICAgIC8qKgogICAgICogU29ydGluZyBmdW5jdGlvbiBmb3IgYm91bmQgZGlyZWN0aXZlcy4KICAgICAqLwogICAgZnVuY3Rpb24gYnlQcmlvcml0eShhLCBiKSB7CiAgICAgIHZhciBkaWZmID0gYi5wcmlvcml0eSAtIGEucHJpb3JpdHk7CiAgICAgIGlmIChkaWZmICE9PSAwKSByZXR1cm4gZGlmZjsKICAgICAgaWYgKGEubmFtZSAhPT0gYi5uYW1lKSByZXR1cm4gKGEubmFtZSA8IGIubmFtZSkgPyAtMSA6IDE7CiAgICAgIHJldHVybiBhLmluZGV4IC0gYi5pbmRleDsKICAgIH0KCgogICAgZnVuY3Rpb24gYXNzZXJ0Tm9EdXBsaWNhdGUod2hhdCwgcHJldmlvdXNEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgZWxlbWVudCkgewogICAgICBpZiAocHJldmlvdXNEaXJlY3RpdmUpIHsKICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycignbXVsdGlkaXInLCAnTXVsdGlwbGUgZGlyZWN0aXZlcyBbezB9LCB7MX1dIGFza2luZyBmb3IgezJ9IG9uOiB7M30nLAogICAgICAgICAgICBwcmV2aW91c0RpcmVjdGl2ZS5uYW1lLCBkaXJlY3RpdmUubmFtZSwgd2hhdCwgc3RhcnRpbmdUYWcoZWxlbWVudCkpOwogICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIGFkZFRleHRJbnRlcnBvbGF0ZURpcmVjdGl2ZShkaXJlY3RpdmVzLCB0ZXh0KSB7CiAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKHRleHQsIHRydWUpOwogICAgICBpZiAoaW50ZXJwb2xhdGVGbikgewogICAgICAgIGRpcmVjdGl2ZXMucHVzaCh7CiAgICAgICAgICBwcmlvcml0eTogMCwKICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIHRleHRJbnRlcnBvbGF0ZUNvbXBpbGVGbih0ZW1wbGF0ZU5vZGUpIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlTm9kZVBhcmVudCA9IHRlbXBsYXRlTm9kZS5wYXJlbnQoKSwKICAgICAgICAgICAgICAgIGhhc0NvbXBpbGVQYXJlbnQgPSAhIXRlbXBsYXRlTm9kZVBhcmVudC5sZW5ndGg7CgogICAgICAgICAgICAvLyBXaGVuIHRyYW5zY2x1ZGluZyBhIHRlbXBsYXRlIHRoYXQgaGFzIGJpbmRpbmdzIGluIHRoZSByb290CiAgICAgICAgICAgIC8vIHdlIGRvbid0IGhhdmUgYSBwYXJlbnQgYW5kIHRodXMgbmVlZCB0byBhZGQgdGhlIGNsYXNzIGR1cmluZyBsaW5raW5nIGZuLgogICAgICAgICAgICBpZiAoaGFzQ29tcGlsZVBhcmVudCkgY29tcGlsZS4kJGFkZEJpbmRpbmdDbGFzcyh0ZW1wbGF0ZU5vZGVQYXJlbnQpOwoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHRleHRJbnRlcnBvbGF0ZUxpbmtGbihzY29wZSwgbm9kZSkgewogICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBub2RlLnBhcmVudCgpOwogICAgICAgICAgICAgIGlmICghaGFzQ29tcGlsZVBhcmVudCkgY29tcGlsZS4kJGFkZEJpbmRpbmdDbGFzcyhwYXJlbnQpOwogICAgICAgICAgICAgIGNvbXBpbGUuJCRhZGRCaW5kaW5nSW5mbyhwYXJlbnQsIGludGVycG9sYXRlRm4uZXhwcmVzc2lvbnMpOwogICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZUZuV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIG5vZGVbMF0ubm9kZVZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gd3JhcFRlbXBsYXRlKHR5cGUsIHRlbXBsYXRlKSB7CiAgICAgIHR5cGUgPSBsb3dlcmNhc2UodHlwZSB8fCAnaHRtbCcpOwogICAgICBzd2l0Y2godHlwZSkgewogICAgICBjYXNlICdzdmcnOgogICAgICBjYXNlICdtYXRoJzoKICAgICAgICB2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIHdyYXBwZXIuaW5uZXJIVE1MID0gJzwnK3R5cGUrJz4nK3RlbXBsYXRlKyc8LycrdHlwZSsnPic7CiAgICAgICAgcmV0dXJuIHdyYXBwZXIuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgICAgfQogICAgfQoKCiAgICBmdW5jdGlvbiBnZXRUcnVzdGVkQ29udGV4dChub2RlLCBhdHRyTm9ybWFsaXplZE5hbWUpIHsKICAgICAgaWYgKGF0dHJOb3JtYWxpemVkTmFtZSA9PSAic3JjZG9jIikgewogICAgICAgIHJldHVybiAkc2NlLkhUTUw7CiAgICAgIH0KICAgICAgdmFyIHRhZyA9IG5vZGVOYW1lXyhub2RlKTsKICAgICAgLy8gbWFjdGlvblt4bGluazpocmVmXSBjYW4gc291cmNlIFNWRy4gIEl0J3Mgbm90IGxpbWl0ZWQgdG8gPG1hY3Rpb24+LgogICAgICBpZiAoYXR0ck5vcm1hbGl6ZWROYW1lID09ICJ4bGlua0hyZWYiIHx8CiAgICAgICAgICAodGFnID09ICJmb3JtIiAmJiBhdHRyTm9ybWFsaXplZE5hbWUgPT0gImFjdGlvbiIpIHx8CiAgICAgICAgICAodGFnICE9ICJpbWciICYmIChhdHRyTm9ybWFsaXplZE5hbWUgPT0gInNyYyIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJOb3JtYWxpemVkTmFtZSA9PSAibmdTcmMiKSkpIHsKICAgICAgICByZXR1cm4gJHNjZS5SRVNPVVJDRV9VUkw7CiAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gYWRkQXR0ckludGVycG9sYXRlRGlyZWN0aXZlKG5vZGUsIGRpcmVjdGl2ZXMsIHZhbHVlLCBuYW1lLCBhbGxPck5vdGhpbmcpIHsKICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUodmFsdWUsIHRydWUpOwoKICAgICAgLy8gbm8gaW50ZXJwb2xhdGlvbiBmb3VuZCAtPiBpZ25vcmUKICAgICAgaWYgKCFpbnRlcnBvbGF0ZUZuKSByZXR1cm47CgoKICAgICAgaWYgKG5hbWUgPT09ICJtdWx0aXBsZSIgJiYgbm9kZU5hbWVfKG5vZGUpID09PSAic2VsZWN0IikgewogICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCJzZWxtdWx0aSIsCiAgICAgICAgICAgICJCaW5kaW5nIHRvIHRoZSAnbXVsdGlwbGUnIGF0dHJpYnV0ZSBpcyBub3Qgc3VwcG9ydGVkLiBFbGVtZW50OiB7MH0iLAogICAgICAgICAgICBzdGFydGluZ1RhZyhub2RlKSk7CiAgICAgIH0KCiAgICAgIGRpcmVjdGl2ZXMucHVzaCh7CiAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICBjb21waWxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwcmU6IGZ1bmN0aW9uIGF0dHJJbnRlcnBvbGF0ZVByZUxpbmtGbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgdmFyICQkb2JzZXJ2ZXJzID0gKGF0dHIuJCRvYnNlcnZlcnMgfHwgKGF0dHIuJCRvYnNlcnZlcnMgPSB7fSkpOwoKICAgICAgICAgICAgICAgIGlmIChFVkVOVF9IQU5ETEVSX0FUVFJfUkVHRVhQLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ25vZG9tZXZlbnRzJywKICAgICAgICAgICAgICAgICAgICAgICJJbnRlcnBvbGF0aW9ucyBmb3IgSFRNTCBET00gZXZlbnQgYXR0cmlidXRlcyBhcmUgZGlzYWxsb3dlZC4gIFBsZWFzZSB1c2UgdGhlICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICJuZy0gdmVyc2lvbnMgKHN1Y2ggYXMgbmctY2xpY2sgaW5zdGVhZCBvZiBvbmNsaWNrKSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIElmIHRoZSBhdHRyaWJ1dGUgd2FzIHJlbW92ZWQsIHRoZW4gd2UgYXJlIGRvbmUKICAgICAgICAgICAgICAgIGlmICghYXR0cltuYW1lXSkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBpbnRlcnBvbGF0ZSBhZ2FpbiwgaW4gY2FzZSB0aGUgYXR0cmlidXRlIHZhbHVlIGhhcyBiZWVuIHVwZGF0ZWQKICAgICAgICAgICAgICAgIC8vIChlLmcuIGJ5IGFub3RoZXIgZGlyZWN0aXZlJ3MgY29tcGlsZSBmdW5jdGlvbikKICAgICAgICAgICAgICAgIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUoYXR0cltuYW1lXSwgdHJ1ZSwgZ2V0VHJ1c3RlZENvbnRleHQobm9kZSwgbmFtZSksCiAgICAgICAgICAgICAgICAgICAgQUxMX09SX05PVEhJTkdfQVRUUlNbbmFtZV0gfHwgYWxsT3JOb3RoaW5nKTsKCiAgICAgICAgICAgICAgICAvLyBpZiBhdHRyaWJ1dGUgd2FzIHVwZGF0ZWQgc28gdGhhdCB0aGVyZSBpcyBubyBpbnRlcnBvbGF0aW9uIGdvaW5nIG9uIHdlIGRvbid0IHdhbnQgdG8KICAgICAgICAgICAgICAgIC8vIHJlZ2lzdGVyIGFueSBvYnNlcnZlcnMKICAgICAgICAgICAgICAgIGlmICghaW50ZXJwb2xhdGVGbikgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIGluaXRpYWxpemUgYXR0ciBvYmplY3Qgc28gdGhhdCBpdCdzIHJlYWR5IGluIGNhc2Ugd2UgbmVlZCB0aGUgdmFsdWUgZm9yIGlzb2xhdGUKICAgICAgICAgICAgICAgIC8vIHNjb3BlIGluaXRpYWxpemF0aW9uLCBvdGhlcndpc2UgdGhlIHZhbHVlIHdvdWxkIG5vdCBiZSBhdmFpbGFibGUgZnJvbSBpc29sYXRlCiAgICAgICAgICAgICAgICAvLyBkaXJlY3RpdmUncyBsaW5raW5nIGZuIGR1cmluZyBsaW5raW5nIHBoYXNlCiAgICAgICAgICAgICAgICBhdHRyW25hbWVdID0gaW50ZXJwb2xhdGVGbihzY29wZSk7CgogICAgICAgICAgICAgICAgKCQkb2JzZXJ2ZXJzW25hbWVdIHx8ICgkJG9ic2VydmVyc1tuYW1lXSA9IFtdKSkuJCRpbnRlciA9IHRydWU7CiAgICAgICAgICAgICAgICAoYXR0ci4kJG9ic2VydmVycyAmJiBhdHRyLiQkb2JzZXJ2ZXJzW25hbWVdLiQkc2NvcGUgfHwgc2NvcGUpLgogICAgICAgICAgICAgICAgICAkd2F0Y2goaW50ZXJwb2xhdGVGbiwgZnVuY3Rpb24gaW50ZXJwb2xhdGVGbldhdGNoQWN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIC8vc3BlY2lhbCBjYXNlIGZvciBjbGFzcyBhdHRyaWJ1dGUgYWRkaXRpb24gKyByZW1vdmFsCiAgICAgICAgICAgICAgICAgICAgLy9zbyB0aGF0IGNsYXNzIGNoYW5nZXMgY2FuIHRhcCBpbnRvIHRoZSBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICAvL2hvb2tzIHByb3ZpZGVkIGJ5IHRoZSAkYW5pbWF0ZSBzZXJ2aWNlLiBCZSBzdXJlIHRvCiAgICAgICAgICAgICAgICAgICAgLy9za2lwIGFuaW1hdGlvbnMgd2hlbiB0aGUgZmlyc3QgZGlnZXN0IG9jY3VycyAod2hlbgogICAgICAgICAgICAgICAgICAgIC8vYm90aCB0aGUgbmV3IGFuZCB0aGUgb2xkIHZhbHVlcyBhcmUgdGhlIHNhbWUpIHNpbmNlCiAgICAgICAgICAgICAgICAgICAgLy90aGUgQ1NTIGNsYXNzZXMgYXJlIHRoZSBub24taW50ZXJwb2xhdGVkIHZhbHVlcwogICAgICAgICAgICAgICAgICAgIGlmKG5hbWUgPT09ICdjbGFzcycgJiYgbmV3VmFsdWUgIT0gb2xkVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHVwZGF0ZUNsYXNzKG5ld1ZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldChuYW1lLCBuZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKCiAgICAvKioKICAgICAqIFRoaXMgaXMgYSBzcGVjaWFsIGpxTGl0ZS5yZXBsYWNlV2l0aCwgd2hpY2ggY2FuIHJlcGxhY2UgaXRlbXMgd2hpY2gKICAgICAqIGhhdmUgbm8gcGFyZW50cywgcHJvdmlkZWQgdGhhdCB0aGUgY29udGFpbmluZyBqcUxpdGUgY29sbGVjdGlvbiBpcyBwcm92aWRlZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0pxTGl0ZT19ICRyb290RWxlbWVudCBUaGUgcm9vdCBvZiB0aGUgY29tcGlsZSB0cmVlLiBVc2VkIHNvIHRoYXQgd2UgY2FuIHJlcGxhY2Ugbm9kZXMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluIHRoZSByb290IG9mIHRoZSB0cmVlLgogICAgICogQHBhcmFtIHtKcUxpdGV9IGVsZW1lbnRzVG9SZW1vdmUgVGhlIGpxTGl0ZSBlbGVtZW50IHdoaWNoIHdlIGFyZSBnb2luZyB0byByZXBsYWNlLiBXZSBrZWVwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgc2hlbGwsIGJ1dCByZXBsYWNlIGl0cyBET00gbm9kZSByZWZlcmVuY2UuCiAgICAgKiBAcGFyYW0ge05vZGV9IG5ld05vZGUgVGhlIG5ldyBET00gbm9kZS4KICAgICAqLwogICAgZnVuY3Rpb24gcmVwbGFjZVdpdGgoJHJvb3RFbGVtZW50LCBlbGVtZW50c1RvUmVtb3ZlLCBuZXdOb2RlKSB7CiAgICAgIHZhciBmaXJzdEVsZW1lbnRUb1JlbW92ZSA9IGVsZW1lbnRzVG9SZW1vdmVbMF0sCiAgICAgICAgICByZW1vdmVDb3VudCA9IGVsZW1lbnRzVG9SZW1vdmUubGVuZ3RoLAogICAgICAgICAgcGFyZW50ID0gZmlyc3RFbGVtZW50VG9SZW1vdmUucGFyZW50Tm9kZSwKICAgICAgICAgIGksIGlpOwoKICAgICAgaWYgKCRyb290RWxlbWVudCkgewogICAgICAgIGZvcihpID0gMCwgaWkgPSAkcm9vdEVsZW1lbnQubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgaWYgKCRyb290RWxlbWVudFtpXSA9PSBmaXJzdEVsZW1lbnRUb1JlbW92ZSkgewogICAgICAgICAgICAkcm9vdEVsZW1lbnRbaSsrXSA9IG5ld05vZGU7CiAgICAgICAgICAgIGZvciAodmFyIGogPSBpLCBqMiA9IGogKyByZW1vdmVDb3VudCAtIDEsCiAgICAgICAgICAgICAgICAgICAgIGpqID0gJHJvb3RFbGVtZW50Lmxlbmd0aDsKICAgICAgICAgICAgICAgICBqIDwgamo7IGorKywgajIrKykgewogICAgICAgICAgICAgIGlmIChqMiA8IGpqKSB7CiAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbal0gPSAkcm9vdEVsZW1lbnRbajJdOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGUgJHJvb3RFbGVtZW50W2pdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAkcm9vdEVsZW1lbnQubGVuZ3RoIC09IHJlbW92ZUNvdW50IC0gMTsKCiAgICAgICAgICAgIC8vIElmIHRoZSByZXBsYWNlZCBlbGVtZW50IGlzIGFsc28gdGhlIGpRdWVyeSAuY29udGV4dCB0aGVuIHJlcGxhY2UgaXQKICAgICAgICAgICAgLy8gLmNvbnRleHQgaXMgYSBkZXByZWNhdGVkIGpRdWVyeSBhcGksIHNvIHdlIHNob3VsZCBzZXQgaXQgb25seSB3aGVuIGpRdWVyeSBzZXQgaXQKICAgICAgICAgICAgLy8gaHR0cDovL2FwaS5qcXVlcnkuY29tL2NvbnRleHQvCiAgICAgICAgICAgIGlmICgkcm9vdEVsZW1lbnQuY29udGV4dCA9PT0gZmlyc3RFbGVtZW50VG9SZW1vdmUpIHsKICAgICAgICAgICAgICAkcm9vdEVsZW1lbnQuY29udGV4dCA9IG5ld05vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZChuZXdOb2RlLCBmaXJzdEVsZW1lbnRUb1JlbW92ZSk7CiAgICAgIH0KCiAgICAgIC8vIFRPRE8ocGVyZik6IHdoYXQncyB0aGlzIGRvY3VtZW50IGZyYWdtZW50IGZvcj8gaXMgaXQgbmVlZGVkPyBjYW4gd2UgYXQgbGVhc3QgcmV1c2UgaXQ/CiAgICAgIHZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZmlyc3RFbGVtZW50VG9SZW1vdmUpOwoKICAgICAgLy8gQ29weSBvdmVyIHVzZXIgZGF0YSAodGhhdCBpbmNsdWRlcyBBbmd1bGFyJ3MgJHNjb3BlIGV0Yy4pLiBEb24ndCBjb3B5IHByaXZhdGUKICAgICAgLy8gZGF0YSBoZXJlIGJlY2F1c2UgdGhlcmUncyBubyBwdWJsaWMgaW50ZXJmYWNlIGluIGpRdWVyeSB0byBkbyB0aGF0IGFuZCBjb3B5aW5nIG92ZXIKICAgICAgLy8gZXZlbnQgbGlzdGVuZXJzICh3aGljaCBpcyB0aGUgbWFpbiB1c2Ugb2YgcHJpdmF0ZSBkYXRhKSB3b3VsZG4ndCB3b3JrIGFueXdheS4KICAgICAganFMaXRlKG5ld05vZGUpLmRhdGEoanFMaXRlKGZpcnN0RWxlbWVudFRvUmVtb3ZlKS5kYXRhKCkpOwoKICAgICAgLy8gUmVtb3ZlIGRhdGEgb2YgdGhlIHJlcGxhY2VkIGVsZW1lbnQuIFdlIGNhbm5vdCBqdXN0IGNhbGwgLnJlbW92ZSgpCiAgICAgIC8vIG9uIHRoZSBlbGVtZW50IGl0IHNpbmNlIHRoYXQgd291bGQgZGVhbGxvY2F0ZSBzY29wZSB0aGF0IGlzIG5lZWRlZAogICAgICAvLyBmb3IgdGhlIG5ldyBub2RlLiBJbnN0ZWFkLCByZW1vdmUgdGhlIGRhdGEgIm1hbnVhbGx5Ii4KICAgICAgaWYgKCFqUXVlcnkpIHsKICAgICAgICBkZWxldGUganFMaXRlLmNhY2hlW2ZpcnN0RWxlbWVudFRvUmVtb3ZlW2pxTGl0ZS5leHBhbmRvXV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8galF1ZXJ5IDIueCBkb2Vzbid0IGV4cG9zZSB0aGUgZGF0YSBzdG9yYWdlLiBVc2UgalF1ZXJ5LmNsZWFuRGF0YSB0byBjbGVhbiB1cCBhZnRlcgogICAgICAgIC8vIHRoZSByZXBsYWNlZCBlbGVtZW50LiBUaGUgY2xlYW5EYXRhIHZlcnNpb24gbW9ua2V5LXBhdGNoZWQgYnkgQW5ndWxhciB3b3VsZCBjYXVzZQogICAgICAgIC8vIHRoZSBzY29wZSB0byBiZSB0cmFzaGVkIGFuZCB3ZSBkbyBuZWVkIHRoZSB2ZXJ5IHNhbWUgc2NvcGUgdG8gd29yayB3aXRoIHRoZSBuZXcKICAgICAgICAvLyBlbGVtZW50LiBIb3dldmVyLCB3ZSBjYW5ub3QganVzdCBjYWNoZSB0aGUgbm9uLXBhdGNoZWQgdmVyc2lvbiBhbmQgdXNlIGl0IGhlcmUgYXMKICAgICAgICAvLyB0aGF0IHdvdWxkIGJyZWFrIGlmIGFub3RoZXIgbGlicmFyeSBwYXRjaGVzIHRoZSBtZXRob2QgYWZ0ZXIgQW5ndWxhciBkb2VzIChvbmUKICAgICAgICAvLyBleGFtcGxlIGlzIGpRdWVyeSBVSSkuIEluc3RlYWQsIHNldCBhIGZsYWcgaW5kaWNhdGluZyBzY29wZSBkZXN0cm95aW5nIHNob3VsZCBiZQogICAgICAgIC8vIHNraXBwZWQgdGhpcyBvbmUgdGltZS4KICAgICAgICBza2lwRGVzdHJveU9uTmV4dEpRdWVyeUNsZWFuRGF0YSA9IHRydWU7CiAgICAgICAgalF1ZXJ5LmNsZWFuRGF0YShbZmlyc3RFbGVtZW50VG9SZW1vdmVdKTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgayA9IDEsIGtrID0gZWxlbWVudHNUb1JlbW92ZS5sZW5ndGg7IGsgPCBrazsgaysrKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBlbGVtZW50c1RvUmVtb3ZlW2tdOwogICAgICAgIGpxTGl0ZShlbGVtZW50KS5yZW1vdmUoKTsgLy8gbXVzdCBkbyB0aGlzIHdheSB0byBjbGVhbiB1cCBleHBhbmRvCiAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgZGVsZXRlIGVsZW1lbnRzVG9SZW1vdmVba107CiAgICAgIH0KCiAgICAgIGVsZW1lbnRzVG9SZW1vdmVbMF0gPSBuZXdOb2RlOwogICAgICBlbGVtZW50c1RvUmVtb3ZlLmxlbmd0aCA9IDE7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGNsb25lQW5kQW5ub3RhdGVGbihmbiwgYW5ub3RhdGlvbikgewogICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uKCkgeyByZXR1cm4gZm4uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsgfSwgZm4sIGFubm90YXRpb24pOwogICAgfQoKCiAgICBmdW5jdGlvbiBpbnZva2VMaW5rRm4obGlua0ZuLCBzY29wZSwgJGVsZW1lbnQsIGF0dHJzLCBjb250cm9sbGVycywgdHJhbnNjbHVkZUZuKSB7CiAgICAgIHRyeSB7CiAgICAgICAgbGlua0ZuKHNjb3BlLCAkZWxlbWVudCwgYXR0cnMsIGNvbnRyb2xsZXJzLCB0cmFuc2NsdWRlRm4pOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgICB9CiAgICB9CiAgfV07Cn0KCnZhciBQUkVGSVhfUkVHRVhQID0gL14oeFtcOlwtX118ZGF0YVtcOlwtX10pL2k7Ci8qKgogKiBDb252ZXJ0cyBhbGwgYWNjZXB0ZWQgZGlyZWN0aXZlcyBmb3JtYXQgaW50byBwcm9wZXIgZGlyZWN0aXZlIG5hbWUuCiAqIEFsbCBvZiB0aGVzZSB3aWxsIGJlY29tZSAnbXlEaXJlY3RpdmUnOgogKiAgIG15OkRpcmVjdGl2ZQogKiAgIG15LWRpcmVjdGl2ZQogKiAgIHgtbXktZGlyZWN0aXZlCiAqICAgZGF0YS1teTpkaXJlY3RpdmUKICoKICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICogQHBhcmFtIG5hbWUgTmFtZSB0byBub3JtYWxpemUKICovCmZ1bmN0aW9uIGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lKSB7CiAgcmV0dXJuIGNhbWVsQ2FzZShuYW1lLnJlcGxhY2UoUFJFRklYX1JFR0VYUCwgJycpKTsKfQoKLyoqCiAqIEBuZ2RvYyB0eXBlCiAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIHNoYXJlZCBvYmplY3QgYmV0d2VlbiBkaXJlY3RpdmUgY29tcGlsZSAvIGxpbmtpbmcgZnVuY3Rpb25zIHdoaWNoIGNvbnRhaW5zIG5vcm1hbGl6ZWQgRE9NCiAqIGVsZW1lbnQgYXR0cmlidXRlcy4gVGhlIHZhbHVlcyByZWZsZWN0IGN1cnJlbnQgYmluZGluZyBzdGF0ZSBge3sgfX1gLiBUaGUgbm9ybWFsaXphdGlvbiBpcwogKiBuZWVkZWQgc2luY2UgYWxsIG9mIHRoZXNlIGFyZSB0cmVhdGVkIGFzIGVxdWl2YWxlbnQgaW4gQW5ndWxhcjoKICoKICogYGBgCiAqICAgIDxzcGFuIG5nOmJpbmQ9ImEiIG5nLWJpbmQ9ImEiIGRhdGEtbmctYmluZD0iYSIgeC1uZy1iaW5kPSJhIj4KICogYGBgCiAqLwoKLyoqCiAqIEBuZ2RvYyBwcm9wZXJ0eQogKiBAbmFtZSAkY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkYXR0cgogKgogKiBAZGVzY3JpcHRpb24KICogQSBtYXAgb2YgRE9NIGVsZW1lbnQgYXR0cmlidXRlIG5hbWVzIHRvIHRoZSBub3JtYWxpemVkIG5hbWUuIFRoaXMgaXMKICogbmVlZGVkIHRvIGRvIHJldmVyc2UgbG9va3VwIGZyb20gbm9ybWFsaXplZCBuYW1lIGJhY2sgdG8gYWN0dWFsIG5hbWUuCiAqLwoKCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRzZXQKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIFNldCBET00gZWxlbWVudCBhdHRyaWJ1dGUgdmFsdWUuCiAqCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5vcm1hbGl6ZWQgZWxlbWVudCBhdHRyaWJ1dGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gbW9kaWZ5LiBUaGUgbmFtZSBpcwogKiAgICAgICAgICByZXZlcnNlLXRyYW5zbGF0ZWQgdXNpbmcgdGhlIHtAbGluayBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkYXR0ciAkYXR0cn0KICogICAgICAgICAgcHJvcGVydHkgdG8gdGhlIG9yaWdpbmFsIG5hbWUuCiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSB0byBzZXQgdGhlIGF0dHJpYnV0ZSB0by4gVGhlIHZhbHVlIGNhbiBiZSBhbiBpbnRlcnBvbGF0ZWQgc3RyaW5nLgogKi8KCgoKLyoqCiAqIENsb3N1cmUgY29tcGlsZXIgdHlwZSBpbmZvcm1hdGlvbgogKi8KCmZ1bmN0aW9uIG5vZGVzZXRMaW5raW5nRm4oCiAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAvKiBOb2RlTGlzdCAqLyBub2RlTGlzdCwKICAvKiBFbGVtZW50ICovIHJvb3RFbGVtZW50LAogIC8qIGZ1bmN0aW9uKEZ1bmN0aW9uKSAqLyBib3VuZFRyYW5zY2x1ZGVGbgope30KCmZ1bmN0aW9uIGRpcmVjdGl2ZUxpbmtpbmdGbigKICAvKiBub2Rlc2V0TGlua2luZ0ZuICovIG5vZGVzZXRMaW5raW5nRm4sCiAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAvKiBOb2RlICovIG5vZGUsCiAgLyogRWxlbWVudCAqLyByb290RWxlbWVudCwKICAvKiBmdW5jdGlvbihGdW5jdGlvbikgKi8gYm91bmRUcmFuc2NsdWRlRm4KKXt9CgpmdW5jdGlvbiB0b2tlbkRpZmZlcmVuY2Uoc3RyMSwgc3RyMikgewogIHZhciB2YWx1ZXMgPSAnJywKICAgICAgdG9rZW5zMSA9IHN0cjEuc3BsaXQoL1xzKy8pLAogICAgICB0b2tlbnMyID0gc3RyMi5zcGxpdCgvXHMrLyk7CgogIG91dGVyOgogIGZvcih2YXIgaSA9IDA7IGkgPCB0b2tlbnMxLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgdG9rZW4gPSB0b2tlbnMxW2ldOwogICAgZm9yKHZhciBqID0gMDsgaiA8IHRva2VuczIubGVuZ3RoOyBqKyspIHsKICAgICAgaWYodG9rZW4gPT0gdG9rZW5zMltqXSkgY29udGludWUgb3V0ZXI7CiAgICB9CiAgICB2YWx1ZXMgKz0gKHZhbHVlcy5sZW5ndGggPiAwID8gJyAnIDogJycpICsgdG9rZW47CiAgfQogIHJldHVybiB2YWx1ZXM7Cn0KCmZ1bmN0aW9uIHJlbW92ZUNvbW1lbnRzKGpxTm9kZXMpIHsKICBqcU5vZGVzID0ganFMaXRlKGpxTm9kZXMpOwogIHZhciBpID0ganFOb2Rlcy5sZW5ndGg7CgogIGlmIChpIDw9IDEpIHsKICAgIHJldHVybiBqcU5vZGVzOwogIH0KCiAgd2hpbGUgKGktLSkgewogICAgdmFyIG5vZGUgPSBqcU5vZGVzW2ldOwogICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IE5PREVfVFlQRV9DT01NRU5UKSB7CiAgICAgIHNwbGljZS5jYWxsKGpxTm9kZXMsIGksIDEpOwogICAgfQogIH0KICByZXR1cm4ganFOb2RlczsKfQoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkY29udHJvbGxlclByb3ZpZGVyCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUge0BsaW5rIG5nLiRjb250cm9sbGVyICRjb250cm9sbGVyIHNlcnZpY2V9IGlzIHVzZWQgYnkgQW5ndWxhciB0byBjcmVhdGUgbmV3CiAqIGNvbnRyb2xsZXJzLgogKgogKiBUaGlzIHByb3ZpZGVyIGFsbG93cyBjb250cm9sbGVyIHJlZ2lzdHJhdGlvbiB2aWEgdGhlCiAqIHtAbGluayBuZy4kY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyIHJlZ2lzdGVyfSBtZXRob2QuCiAqLwpmdW5jdGlvbiAkQ29udHJvbGxlclByb3ZpZGVyKCkgewogIHZhciBjb250cm9sbGVycyA9IHt9LAogICAgICBnbG9iYWxzID0gZmFsc2UsCiAgICAgIENOVFJMX1JFRyA9IC9eKFxTKykoXHMrYXNccysoXHcrKSk/JC87CgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGNvbnRyb2xsZXJQcm92aWRlciNyZWdpc3RlcgogICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdH0gbmFtZSBDb250cm9sbGVyIG5hbWUsIG9yIGFuIG9iamVjdCBtYXAgb2YgY29udHJvbGxlcnMgd2hlcmUgdGhlIGtleXMgYXJlCiAgICogICAgdGhlIG5hbWVzIGFuZCB0aGUgdmFsdWVzIGFyZSB0aGUgY29uc3RydWN0b3JzLgogICAqIEBwYXJhbSB7RnVuY3Rpb258QXJyYXl9IGNvbnN0cnVjdG9yIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZm4gKG9wdGlvbmFsbHkgZGVjb3JhdGVkIHdpdGggREkKICAgKiAgICBhbm5vdGF0aW9ucyBpbiB0aGUgYXJyYXkgbm90YXRpb24pLgogICAqLwogIHRoaXMucmVnaXN0ZXIgPSBmdW5jdGlvbihuYW1lLCBjb25zdHJ1Y3RvcikgewogICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkobmFtZSwgJ2NvbnRyb2xsZXInKTsKICAgIGlmIChpc09iamVjdChuYW1lKSkgewogICAgICBleHRlbmQoY29udHJvbGxlcnMsIG5hbWUpOwogICAgfSBlbHNlIHsKICAgICAgY29udHJvbGxlcnNbbmFtZV0gPSBjb25zdHJ1Y3RvcjsKICAgIH0KICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGNvbnRyb2xsZXJQcm92aWRlciNhbGxvd0dsb2JhbHMKICAgKiBAZGVzY3JpcHRpb24gSWYgY2FsbGVkLCBhbGxvd3MgYCRjb250cm9sbGVyYCB0byBmaW5kIGNvbnRyb2xsZXIgY29uc3RydWN0b3JzIG9uIGB3aW5kb3dgCiAgICovCiAgdGhpcy5hbGxvd0dsb2JhbHMgPSBmdW5jdGlvbigpIHsKICAgIGdsb2JhbHMgPSB0cnVlOwogIH07CgoKICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsICckd2luZG93JywgZnVuY3Rpb24oJGluamVjdG9yLCAkd2luZG93KSB7CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQG5hbWUgJGNvbnRyb2xsZXIKICAgICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgICAqCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufHN0cmluZ30gY29uc3RydWN0b3IgSWYgY2FsbGVkIHdpdGggYSBmdW5jdGlvbiB0aGVuIGl0J3MgY29uc2lkZXJlZCB0byBiZSB0aGUKICAgICAqICAgIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgZnVuY3Rpb24uIE90aGVyd2lzZSBpdCdzIGNvbnNpZGVyZWQgdG8gYmUgYSBzdHJpbmcgd2hpY2ggaXMgdXNlZAogICAgICogICAgdG8gcmV0cmlldmUgdGhlIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgdXNpbmcgdGhlIGZvbGxvd2luZyBzdGVwczoKICAgICAqCiAgICAgKiAgICAqIGNoZWNrIGlmIGEgY29udHJvbGxlciB3aXRoIGdpdmVuIG5hbWUgaXMgcmVnaXN0ZXJlZCB2aWEgYCRjb250cm9sbGVyUHJvdmlkZXJgCiAgICAgKiAgICAqIGNoZWNrIGlmIGV2YWx1YXRpbmcgdGhlIHN0cmluZyBvbiB0aGUgY3VycmVudCBzY29wZSByZXR1cm5zIGEgY29uc3RydWN0b3IKICAgICAqICAgICogaWYgJGNvbnRyb2xsZXJQcm92aWRlciNhbGxvd0dsb2JhbHMsIGNoZWNrIGB3aW5kb3dbY29uc3RydWN0b3JdYCBvbiB0aGUgZ2xvYmFsCiAgICAgKiAgICAgIGB3aW5kb3dgIG9iamVjdCAobm90IHJlY29tbWVuZGVkKQogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBsb2NhbHMgSW5qZWN0aW9uIGxvY2FscyBmb3IgQ29udHJvbGxlci4KICAgICAqIEByZXR1cm4ge09iamVjdH0gSW5zdGFuY2Ugb2YgZ2l2ZW4gY29udHJvbGxlci4KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIGAkY29udHJvbGxlcmAgc2VydmljZSBpcyByZXNwb25zaWJsZSBmb3IgaW5zdGFudGlhdGluZyBjb250cm9sbGVycy4KICAgICAqCiAgICAgKiBJdCdzIGp1c3QgYSBzaW1wbGUgY2FsbCB0byB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfSwgYnV0IGV4dHJhY3RlZCBpbnRvCiAgICAgKiBhIHNlcnZpY2UsIHNvIHRoYXQgb25lIGNhbiBvdmVycmlkZSB0aGlzIHNlcnZpY2Ugd2l0aCBbQkMgdmVyc2lvbl0oaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vMTY0OTc4OCkuCiAgICAgKi8KICAgIHJldHVybiBmdW5jdGlvbihleHByZXNzaW9uLCBsb2NhbHMsIGxhdGVyLCBpZGVudCkgewogICAgICAvLyBQUklWQVRFIEFQSToKICAgICAgLy8gICBwYXJhbSBgbGF0ZXJgIC0tLSBpbmRpY2F0ZXMgdGhhdCB0aGUgY29udHJvbGxlcidzIGNvbnN0cnVjdG9yIGlzIGludm9rZWQgYXQgYSBsYXRlciB0aW1lLgogICAgICAvLyAgICAgICAgICAgICAgICAgICAgIElmIHRydWUsICRjb250cm9sbGVyIHdpbGwgYWxsb2NhdGUgdGhlIG9iamVjdCB3aXRoIHRoZSBjb3JyZWN0CiAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgcHJvdG90eXBlIGNoYWluLCBidXQgd2lsbCBub3QgaW52b2tlIHRoZSBjb250cm9sbGVyIHVudGlsIGEgcmV0dXJuZWQKICAgICAgLy8gICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayBpcyBpbnZva2VkLgogICAgICAvLyAgIHBhcmFtIGBpZGVudGAgLS0tIEFuIG9wdGlvbmFsIGxhYmVsIHdoaWNoIG92ZXJyaWRlcyB0aGUgbGFiZWwgcGFyc2VkIGZyb20gdGhlIGNvbnRyb2xsZXIKICAgICAgLy8gICAgICAgICAgICAgICAgICAgICBleHByZXNzaW9uLCBpZiBhbnkuCiAgICAgIHZhciBpbnN0YW5jZSwgbWF0Y2gsIGNvbnN0cnVjdG9yLCBpZGVudGlmaWVyOwogICAgICBsYXRlciA9IGxhdGVyID09PSB0cnVlOwogICAgICBpZiAoaWRlbnQgJiYgaXNTdHJpbmcoaWRlbnQpKSB7CiAgICAgICAgaWRlbnRpZmllciA9IGlkZW50OwogICAgICB9CgogICAgICBpZihpc1N0cmluZyhleHByZXNzaW9uKSkgewogICAgICAgIG1hdGNoID0gZXhwcmVzc2lvbi5tYXRjaChDTlRSTF9SRUcpLAogICAgICAgIGNvbnN0cnVjdG9yID0gbWF0Y2hbMV0sCiAgICAgICAgaWRlbnRpZmllciA9IGlkZW50aWZpZXIgfHwgbWF0Y2hbM107CiAgICAgICAgZXhwcmVzc2lvbiA9IGNvbnRyb2xsZXJzLmhhc093blByb3BlcnR5KGNvbnN0cnVjdG9yKQogICAgICAgICAgICA/IGNvbnRyb2xsZXJzW2NvbnN0cnVjdG9yXQogICAgICAgICAgICA6IGdldHRlcihsb2NhbHMuJHNjb3BlLCBjb25zdHJ1Y3RvciwgdHJ1ZSkgfHwKICAgICAgICAgICAgICAgIChnbG9iYWxzID8gZ2V0dGVyKCR3aW5kb3csIGNvbnN0cnVjdG9yLCB0cnVlKSA6IHVuZGVmaW5lZCk7CgogICAgICAgIGFzc2VydEFyZ0ZuKGV4cHJlc3Npb24sIGNvbnN0cnVjdG9yLCB0cnVlKTsKICAgICAgfQoKICAgICAgaWYgKGxhdGVyKSB7CiAgICAgICAgLy8gSW5zdGFudGlhdGUgY29udHJvbGxlciBsYXRlcjoKICAgICAgICAvLyBUaGlzIG1hY2hpbmVyeSBpcyB1c2VkIHRvIGNyZWF0ZSBhbiBpbnN0YW5jZSBvZiB0aGUgb2JqZWN0IGJlZm9yZSBjYWxsaW5nIHRoZQogICAgICAgIC8vIGNvbnRyb2xsZXIncyBjb25zdHJ1Y3RvciBpdHNlbGYuCiAgICAgICAgLy8KICAgICAgICAvLyBUaGlzIGFsbG93cyBwcm9wZXJ0aWVzIHRvIGJlIGFkZGVkIHRvIHRoZSBjb250cm9sbGVyIGJlZm9yZSB0aGUgY29uc3RydWN0b3IgaXMKICAgICAgICAvLyBpbnZva2VkLiBQcmltYXJpbHksIHRoaXMgaXMgdXNlZCBmb3IgaXNvbGF0ZSBzY29wZSBiaW5kaW5ncyBpbiAkY29tcGlsZS4KICAgICAgICAvLwogICAgICAgIC8vIFRoaXMgZmVhdHVyZSBpcyBub3QgaW50ZW5kZWQgZm9yIHVzZSBieSBhcHBsaWNhdGlvbnMsIGFuZCBpcyB0aHVzIG5vdCBkb2N1bWVudGVkCiAgICAgICAgLy8gcHVibGljbHkuCiAgICAgICAgdmFyIENvbnN0cnVjdG9yID0gZnVuY3Rpb24oKSB7fTsKICAgICAgICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAoaXNBcnJheShleHByZXNzaW9uKSA/CiAgICAgICAgICBleHByZXNzaW9uW2V4cHJlc3Npb24ubGVuZ3RoIC0gMV0gOiBleHByZXNzaW9uKS5wcm90b3R5cGU7CiAgICAgICAgaW5zdGFuY2UgPSBuZXcgQ29uc3RydWN0b3IoKTsKCiAgICAgICAgaWYgKGlkZW50aWZpZXIpIHsKICAgICAgICAgIGFkZElkZW50aWZpZXIobG9jYWxzLCBpZGVudGlmaWVyLCBpbnN0YW5jZSwgY29uc3RydWN0b3IgfHwgZXhwcmVzc2lvbi5uYW1lKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAkaW5qZWN0b3IuaW52b2tlKGV4cHJlc3Npb24sIGluc3RhbmNlLCBsb2NhbHMsIGNvbnN0cnVjdG9yKTsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9LCB7CiAgICAgICAgICBpbnN0YW5jZTogaW5zdGFuY2UsCiAgICAgICAgICBpZGVudGlmaWVyOiBpZGVudGlmaWVyCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGluc3RhbmNlID0gJGluamVjdG9yLmluc3RhbnRpYXRlKGV4cHJlc3Npb24sIGxvY2FscywgY29uc3RydWN0b3IpOwoKICAgICAgaWYgKGlkZW50aWZpZXIpIHsKICAgICAgICBhZGRJZGVudGlmaWVyKGxvY2FscywgaWRlbnRpZmllciwgaW5zdGFuY2UsIGNvbnN0cnVjdG9yIHx8IGV4cHJlc3Npb24ubmFtZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgIH07CgogICAgZnVuY3Rpb24gYWRkSWRlbnRpZmllcihsb2NhbHMsIGlkZW50aWZpZXIsIGluc3RhbmNlLCBuYW1lKSB7CiAgICAgIGlmICghKGxvY2FscyAmJiBpc09iamVjdChsb2NhbHMuJHNjb3BlKSkpIHsKICAgICAgICB0aHJvdyBtaW5FcnIoJyRjb250cm9sbGVyJykoJ25vc2NwJywKICAgICAgICAgICJDYW5ub3QgZXhwb3J0IGNvbnRyb2xsZXIgJ3swfScgYXMgJ3sxfSchIE5vICRzY29wZSBvYmplY3QgcHJvdmlkZWQgdmlhIGBsb2NhbHNgLiIsCiAgICAgICAgICBuYW1lLCBpZGVudGlmaWVyKTsKICAgICAgfQoKICAgICAgbG9jYWxzLiRzY29wZVtpZGVudGlmaWVyXSA9IGluc3RhbmNlOwogICAgfQogIH1dOwp9CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGRvY3VtZW50CiAqIEByZXF1aXJlcyAkd2luZG93CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIHtAbGluayBhbmd1bGFyLmVsZW1lbnQgalF1ZXJ5IG9yIGpxTGl0ZX0gd3JhcHBlciBmb3IgdGhlIGJyb3dzZXIncyBgd2luZG93LmRvY3VtZW50YCBvYmplY3QuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0iZG9jdW1lbnRFeGFtcGxlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgICA8cD4kZG9jdW1lbnQgdGl0bGU6IDxiIG5nLWJpbmQ9InRpdGxlIj48L2I+PC9wPgogICAgICAgICA8cD53aW5kb3cuZG9jdW1lbnQgdGl0bGU6IDxiIG5nLWJpbmQ9IndpbmRvd1RpdGxlIj48L2I+PC9wPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgICBhbmd1bGFyLm1vZHVsZSgnZG9jdW1lbnRFeGFtcGxlJywgW10pCiAgICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgJyRkb2N1bWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGRvY3VtZW50KSB7CiAgICAgICAgICAgJHNjb3BlLnRpdGxlID0gJGRvY3VtZW50WzBdLnRpdGxlOwogICAgICAgICAgICRzY29wZS53aW5kb3dUaXRsZSA9IGFuZ3VsYXIuZWxlbWVudCh3aW5kb3cuZG9jdW1lbnQpWzBdLnRpdGxlOwogICAgICAgICB9XSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwpmdW5jdGlvbiAkRG9jdW1lbnRQcm92aWRlcigpewogIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsIGZ1bmN0aW9uKHdpbmRvdyl7CiAgICByZXR1cm4ganFMaXRlKHdpbmRvdy5kb2N1bWVudCk7CiAgfV07Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkZXhjZXB0aW9uSGFuZGxlcgogKiBAcmVxdWlyZXMgbmcuJGxvZwogKgogKiBAZGVzY3JpcHRpb24KICogQW55IHVuY2F1Z2h0IGV4Y2VwdGlvbiBpbiBhbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRlbGVnYXRlZCB0byB0aGlzIHNlcnZpY2UuCiAqIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIHNpbXBseSBkZWxlZ2F0ZXMgdG8gYCRsb2cuZXJyb3JgIHdoaWNoIGxvZ3MgaXQgaW50bwogKiB0aGUgYnJvd3NlciBjb25zb2xlLgogKgogKiBJbiB1bml0IHRlc3RzLCBpZiBgYW5ndWxhci1tb2Nrcy5qc2AgaXMgbG9hZGVkLCB0aGlzIHNlcnZpY2UgaXMgb3ZlcnJpZGRlbiBieQogKiB7QGxpbmsgbmdNb2NrLiRleGNlcHRpb25IYW5kbGVyIG1vY2sgJGV4Y2VwdGlvbkhhbmRsZXJ9IHdoaWNoIGFpZHMgaW4gdGVzdGluZy4KICoKICogIyMgRXhhbXBsZToKICoKICogYGBganMKICogICBhbmd1bGFyLm1vZHVsZSgnZXhjZXB0aW9uT3ZlcnJpZGUnLCBbXSkuZmFjdG9yeSgnJGV4Y2VwdGlvbkhhbmRsZXInLCBmdW5jdGlvbiAoKSB7CiAqICAgICByZXR1cm4gZnVuY3Rpb24gKGV4Y2VwdGlvbiwgY2F1c2UpIHsKICogICAgICAgZXhjZXB0aW9uLm1lc3NhZ2UgKz0gJyAoY2F1c2VkIGJ5ICInICsgY2F1c2UgKyAnIiknOwogKiAgICAgICB0aHJvdyBleGNlcHRpb247CiAqICAgICB9OwogKiAgIH0pOwogKiBgYGAKICoKICogVGhpcyBleGFtcGxlIHdpbGwgb3ZlcnJpZGUgdGhlIG5vcm1hbCBhY3Rpb24gb2YgYCRleGNlcHRpb25IYW5kbGVyYCwgdG8gbWFrZSBhbmd1bGFyCiAqIGV4Y2VwdGlvbnMgZmFpbCBoYXJkIHdoZW4gdGhleSBoYXBwZW4sIGluc3RlYWQgb2YganVzdCBsb2dnaW5nIHRvIHRoZSBjb25zb2xlLgogKgogKiA8aHIgLz4KICogTm90ZSwgdGhhdCBjb2RlIGV4ZWN1dGVkIGluIGV2ZW50LWxpc3RlbmVycyAoZXZlbiB0aG9zZSByZWdpc3RlcmVkIHVzaW5nIGpxTGl0ZSdzIGBvbmAvYGJpbmRgCiAqIG1ldGhvZHMpIGRvZXMgbm90IGRlbGVnYXRlIGV4Y2VwdGlvbnMgdG8gdGhlIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0KICogKHVubGVzcyBleGVjdXRlZCBkdXJpbmcgYSBkaWdlc3QpLgogKgogKiBJZiB5b3Ugd2lzaCwgeW91IGNhbiBtYW51YWxseSBkZWxlZ2F0ZSBleGNlcHRpb25zLCBlLmcuCiAqIGB0cnkgeyAuLi4gfSBjYXRjaChlKSB7ICRleGNlcHRpb25IYW5kbGVyKGUpOyB9YAogKgogKiBAcGFyYW0ge0Vycm9yfSBleGNlcHRpb24gRXhjZXB0aW9uIGFzc29jaWF0ZWQgd2l0aCB0aGUgZXJyb3IuCiAqIEBwYXJhbSB7c3RyaW5nPX0gY2F1c2Ugb3B0aW9uYWwgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGNvbnRleHQgaW4gd2hpY2gKICogICAgICAgdGhlIGVycm9yIHdhcyB0aHJvd24uCiAqCiAqLwpmdW5jdGlvbiAkRXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyKCkgewogIHRoaXMuJGdldCA9IFsnJGxvZycsIGZ1bmN0aW9uKCRsb2cpIHsKICAgIHJldHVybiBmdW5jdGlvbihleGNlcHRpb24sIGNhdXNlKSB7CiAgICAgICRsb2cuZXJyb3IuYXBwbHkoJGxvZywgYXJndW1lbnRzKTsKICAgIH07CiAgfV07Cn0KCi8qKgogKiBQYXJzZSBoZWFkZXJzIGludG8ga2V5IHZhbHVlIG9iamVjdAogKgogKiBAcGFyYW0ge3N0cmluZ30gaGVhZGVycyBSYXcgaGVhZGVycyBhcyBhIHN0cmluZwogKiBAcmV0dXJucyB7T2JqZWN0fSBQYXJzZWQgaGVhZGVycyBhcyBrZXkgdmFsdWUgb2JqZWN0CiAqLwpmdW5jdGlvbiBwYXJzZUhlYWRlcnMoaGVhZGVycykgewogIHZhciBwYXJzZWQgPSB7fSwga2V5LCB2YWwsIGk7CgogIGlmICghaGVhZGVycykgcmV0dXJuIHBhcnNlZDsKCiAgZm9yRWFjaChoZWFkZXJzLnNwbGl0KCdcbicpLCBmdW5jdGlvbihsaW5lKSB7CiAgICBpID0gbGluZS5pbmRleE9mKCc6Jyk7CiAgICBrZXkgPSBsb3dlcmNhc2UodHJpbShsaW5lLnN1YnN0cigwLCBpKSkpOwogICAgdmFsID0gdHJpbShsaW5lLnN1YnN0cihpICsgMSkpOwoKICAgIGlmIChrZXkpIHsKICAgICAgcGFyc2VkW2tleV0gPSBwYXJzZWRba2V5XSA/IHBhcnNlZFtrZXldICsgJywgJyArIHZhbCA6IHZhbDsKICAgIH0KICB9KTsKCiAgcmV0dXJuIHBhcnNlZDsKfQoKCi8qKgogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBwcm92aWRlcyBhY2Nlc3MgdG8gcGFyc2VkIGhlYWRlcnMuCiAqCiAqIEhlYWRlcnMgYXJlIGxhenkgcGFyc2VkIHdoZW4gZmlyc3QgcmVxdWVzdGVkLgogKiBAc2VlIHBhcnNlSGVhZGVycwogKgogKiBAcGFyYW0geyhzdHJpbmd8T2JqZWN0KX0gaGVhZGVycyBIZWFkZXJzIHRvIHByb3ZpZGUgYWNjZXNzIHRvLgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oc3RyaW5nPSl9IFJldHVybnMgYSBnZXR0ZXIgZnVuY3Rpb24gd2hpY2ggaWYgY2FsbGVkIHdpdGg6CiAqCiAqICAgLSBpZiBjYWxsZWQgd2l0aCBzaW5nbGUgYW4gYXJndW1lbnQgcmV0dXJucyBhIHNpbmdsZSBoZWFkZXIgdmFsdWUgb3IgbnVsbAogKiAgIC0gaWYgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzIHJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIGhlYWRlcnMuCiAqLwpmdW5jdGlvbiBoZWFkZXJzR2V0dGVyKGhlYWRlcnMpIHsKICB2YXIgaGVhZGVyc09iaiA9IGlzT2JqZWN0KGhlYWRlcnMpID8gaGVhZGVycyA6IHVuZGVmaW5lZDsKCiAgcmV0dXJuIGZ1bmN0aW9uKG5hbWUpIHsKICAgIGlmICghaGVhZGVyc09iaikgaGVhZGVyc09iaiA9ICBwYXJzZUhlYWRlcnMoaGVhZGVycyk7CgogICAgaWYgKG5hbWUpIHsKICAgICAgcmV0dXJuIGhlYWRlcnNPYmpbbG93ZXJjYXNlKG5hbWUpXSB8fCBudWxsOwogICAgfQoKICAgIHJldHVybiBoZWFkZXJzT2JqOwogIH07Cn0KCgovKioKICogQ2hhaW4gYWxsIGdpdmVuIGZ1bmN0aW9ucwogKgogKiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgZm9yIGJvdGggcmVxdWVzdCBhbmQgcmVzcG9uc2UgdHJhbnNmb3JtaW5nCiAqCiAqIEBwYXJhbSB7Kn0gZGF0YSBEYXRhIHRvIHRyYW5zZm9ybS4KICogQHBhcmFtIHtmdW5jdGlvbihzdHJpbmc9KX0gaGVhZGVycyBIdHRwIGhlYWRlcnMgZ2V0dGVyIGZuLgogKiBAcGFyYW0geyhGdW5jdGlvbnxBcnJheS48RnVuY3Rpb24+KX0gZm5zIEZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIGZ1bmN0aW9ucy4KICogQHJldHVybnMgeyp9IFRyYW5zZm9ybWVkIGRhdGEuCiAqLwpmdW5jdGlvbiB0cmFuc2Zvcm1EYXRhKGRhdGEsIGhlYWRlcnMsIGZucykgewogIGlmIChpc0Z1bmN0aW9uKGZucykpCiAgICByZXR1cm4gZm5zKGRhdGEsIGhlYWRlcnMpOwoKICBmb3JFYWNoKGZucywgZnVuY3Rpb24oZm4pIHsKICAgIGRhdGEgPSBmbihkYXRhLCBoZWFkZXJzKTsKICB9KTsKCiAgcmV0dXJuIGRhdGE7Cn0KCgpmdW5jdGlvbiBpc1N1Y2Nlc3Moc3RhdHVzKSB7CiAgcmV0dXJuIDIwMCA8PSBzdGF0dXMgJiYgc3RhdHVzIDwgMzAwOwp9CgoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkaHR0cFByb3ZpZGVyCiAqIEBkZXNjcmlwdGlvbgogKiBVc2UgYCRodHRwUHJvdmlkZXJgIHRvIGNoYW5nZSB0aGUgZGVmYXVsdCBiZWhhdmlvciBvZiB0aGUge0BsaW5rIG5nLiRodHRwICRodHRwfSBzZXJ2aWNlLgogKiAqLwpmdW5jdGlvbiAkSHR0cFByb3ZpZGVyKCkgewogIHZhciBKU09OX1NUQVJUID0gL15ccyooXFt8XHtbXlx7XSkvLAogICAgICBKU09OX0VORCA9IC9bXH1cXV1ccyokLywKICAgICAgUFJPVEVDVElPTl9QUkVGSVggPSAvXlwpXF1cfScsP1xuLywKICAgICAgQVBQTElDQVRJT05fSlNPTiA9ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgQ09OVEVOVF9UWVBFX0FQUExJQ0FUSU9OX0pTT04gPSB7J0NvbnRlbnQtVHlwZSc6IEFQUExJQ0FUSU9OX0pTT04gKyAnO2NoYXJzZXQ9dXRmLTgnfTsKCiAgLyoqCiAgICogQG5nZG9jIHByb3BlcnR5CiAgICogQG5hbWUgJGh0dHBQcm92aWRlciNkZWZhdWx0cwogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogT2JqZWN0IGNvbnRhaW5pbmcgZGVmYXVsdCB2YWx1ZXMgZm9yIGFsbCB7QGxpbmsgbmcuJGh0dHAgJGh0dHB9IHJlcXVlc3RzLgogICAqCiAgICogLSAqKmBkZWZhdWx0cy54c3JmQ29va2llTmFtZWAqKiAtIHtzdHJpbmd9IC0gTmFtZSBvZiBjb29raWUgY29udGFpbmluZyB0aGUgWFNSRiB0b2tlbi4KICAgKiBEZWZhdWx0cyB2YWx1ZSBpcyBgJ1hTUkYtVE9LRU4nYC4KICAgKgogICAqIC0gKipgZGVmYXVsdHMueHNyZkhlYWRlck5hbWVgKiogLSB7c3RyaW5nfSAtIE5hbWUgb2YgSFRUUCBoZWFkZXIgdG8gcG9wdWxhdGUgd2l0aCB0aGUKICAgKiBYU1JGIHRva2VuLiBEZWZhdWx0cyB2YWx1ZSBpcyBgJ1gtWFNSRi1UT0tFTidgLgogICAqCiAgICogLSAqKmBkZWZhdWx0cy5oZWFkZXJzYCoqIC0ge09iamVjdH0gLSBEZWZhdWx0IGhlYWRlcnMgZm9yIGFsbCAkaHR0cCByZXF1ZXN0cy4KICAgKiBSZWZlciB0byB7QGxpbmsgbmcuJGh0dHAjc2V0dGluZy1odHRwLWhlYWRlcnMgJGh0dHB9IGZvciBkb2N1bWVudGF0aW9uIG9uCiAgICogc2V0dGluZyBkZWZhdWx0IGhlYWRlcnMuCiAgICogICAgIC0gKipgZGVmYXVsdHMuaGVhZGVycy5jb21tb25gKioKICAgKiAgICAgLSAqKmBkZWZhdWx0cy5oZWFkZXJzLnBvc3RgKioKICAgKiAgICAgLSAqKmBkZWZhdWx0cy5oZWFkZXJzLnB1dGAqKgogICAqICAgICAtICoqYGRlZmF1bHRzLmhlYWRlcnMucGF0Y2hgKioKICAgKiovCiAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgIC8vIHRyYW5zZm9ybSBpbmNvbWluZyByZXNwb25zZSBkYXRhCiAgICB0cmFuc2Zvcm1SZXNwb25zZTogW2Z1bmN0aW9uIGRlZmF1bHRIdHRwUmVzcG9uc2VUcmFuc2Zvcm0oZGF0YSwgaGVhZGVycykgewogICAgICBpZiAoaXNTdHJpbmcoZGF0YSkpIHsKICAgICAgICAvLyBzdHJpcCBqc29uIHZ1bG5lcmFiaWxpdHkgcHJvdGVjdGlvbiBwcmVmaXgKICAgICAgICBkYXRhID0gZGF0YS5yZXBsYWNlKFBST1RFQ1RJT05fUFJFRklYLCAnJyk7CiAgICAgICAgdmFyIGNvbnRlbnRUeXBlID0gaGVhZGVycygnQ29udGVudC1UeXBlJyk7CiAgICAgICAgaWYgKChjb250ZW50VHlwZSAmJiBjb250ZW50VHlwZS5pbmRleE9mKEFQUExJQ0FUSU9OX0pTT04pID09PSAwKSB8fAogICAgICAgICAgICAoSlNPTl9TVEFSVC50ZXN0KGRhdGEpICYmIEpTT05fRU5ELnRlc3QoZGF0YSkpKSB7CiAgICAgICAgICBkYXRhID0gZnJvbUpzb24oZGF0YSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBkYXRhOwogICAgfV0sCgogICAgLy8gdHJhbnNmb3JtIG91dGdvaW5nIHJlcXVlc3QgZGF0YQogICAgdHJhbnNmb3JtUmVxdWVzdDogW2Z1bmN0aW9uKGQpIHsKICAgICAgcmV0dXJuIGlzT2JqZWN0KGQpICYmICFpc0ZpbGUoZCkgJiYgIWlzQmxvYihkKSA/IHRvSnNvbihkKSA6IGQ7CiAgICB9XSwKCiAgICAvLyBkZWZhdWx0IGhlYWRlcnMKICAgIGhlYWRlcnM6IHsKICAgICAgY29tbW9uOiB7CiAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L3BsYWluLCAqLyonCiAgICAgIH0sCiAgICAgIHBvc3Q6ICAgc2hhbGxvd0NvcHkoQ09OVEVOVF9UWVBFX0FQUExJQ0FUSU9OX0pTT04pLAogICAgICBwdXQ6ICAgIHNoYWxsb3dDb3B5KENPTlRFTlRfVFlQRV9BUFBMSUNBVElPTl9KU09OKSwKICAgICAgcGF0Y2g6ICBzaGFsbG93Q29weShDT05URU5UX1RZUEVfQVBQTElDQVRJT05fSlNPTikKICAgIH0sCgogICAgeHNyZkNvb2tpZU5hbWU6ICdYU1JGLVRPS0VOJywKICAgIHhzcmZIZWFkZXJOYW1lOiAnWC1YU1JGLVRPS0VOJwogIH07CgogIHZhciB1c2VBcHBseUFzeW5jID0gZmFsc2U7CiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRodHRwUHJvdmlkZXIjdXNlQXBwbHlBc3luYwogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogQ29uZmlndXJlICRodHRwIHNlcnZpY2UgdG8gY29tYmluZSBwcm9jZXNzaW5nIG9mIG11bHRpcGxlIGh0dHAgcmVzcG9uc2VzIHJlY2VpdmVkIGF0IGFyb3VuZAogICAqIHRoZSBzYW1lIHRpbWUgdmlhIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRhcHBseUFzeW5jICRyb290U2NvcGUuJGFwcGx5QXN5bmN9LiBUaGlzIGNhbiByZXN1bHQgaW4KICAgKiBzaWduaWZpY2FudCBwZXJmb3JtYW5jZSBpbXByb3ZlbWVudCBmb3IgYmlnZ2VyIGFwcGxpY2F0aW9ucyB0aGF0IG1ha2UgbWFueSBIVFRQIHJlcXVlc3RzCiAgICogY29uY3VycmVudGx5IChjb21tb24gZHVyaW5nIGFwcGxpY2F0aW9uIGJvb3RzdHJhcCkuCiAgICoKICAgKiBEZWZhdWx0cyB0byBmYWxzZS4gSWYgbm8gdmFsdWUgaXMgc3BlY2lmZWQsIHJldHVybnMgdGhlIGN1cnJlbnQgY29uZmlndXJlZCB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHZhbHVlIElmIHRydWUsIHdoZW4gcmVxdWVzdHMgYXJlIGxvYWRlZCwgdGhleSB3aWxsIHNjaGVkdWxlIGEgZGVmZXJyZWQKICAgKiAgICAiYXBwbHkiIG9uIHRoZSBuZXh0IHRpY2ssIGdpdmluZyB0aW1lIGZvciBzdWJzZXF1ZW50IHJlcXVlc3RzIGluIGEgcm91Z2hseSB+MTBtcyB3aW5kb3cKICAgKiAgICB0byBsb2FkIGFuZCBzaGFyZSB0aGUgc2FtZSBkaWdlc3QgY3ljbGUuCiAgICoKICAgKiBAcmV0dXJucyB7Ym9vbGVhbnxPYmplY3R9IElmIGEgdmFsdWUgaXMgc3BlY2lmaWVkLCByZXR1cm5zIHRoZSAkaHR0cFByb3ZpZGVyIGZvciBjaGFpbmluZy4KICAgKiAgICBvdGhlcndpc2UsIHJldHVybnMgdGhlIGN1cnJlbnQgY29uZmlndXJlZCB2YWx1ZS4KICAgKiovCiAgdGhpcy51c2VBcHBseUFzeW5jID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgIHVzZUFwcGx5QXN5bmMgPSAhIXZhbHVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHJldHVybiB1c2VBcHBseUFzeW5jOwogIH07CgogIC8qKgogICAqIEFyZSBvcmRlcmVkIGJ5IHJlcXVlc3QsIGkuZS4gdGhleSBhcmUgYXBwbGllZCBpbiB0aGUgc2FtZSBvcmRlciBhcyB0aGUKICAgKiBhcnJheSwgb24gcmVxdWVzdCwgYnV0IHJldmVyc2Ugb3JkZXIsIG9uIHJlc3BvbnNlLgogICAqLwogIHZhciBpbnRlcmNlcHRvckZhY3RvcmllcyA9IHRoaXMuaW50ZXJjZXB0b3JzID0gW107CgogIHRoaXMuJGdldCA9IFsnJGh0dHBCYWNrZW5kJywgJyRicm93c2VyJywgJyRjYWNoZUZhY3RvcnknLCAnJHJvb3RTY29wZScsICckcScsICckaW5qZWN0b3InLAogICAgICBmdW5jdGlvbigkaHR0cEJhY2tlbmQsICRicm93c2VyLCAkY2FjaGVGYWN0b3J5LCAkcm9vdFNjb3BlLCAkcSwgJGluamVjdG9yKSB7CgogICAgdmFyIGRlZmF1bHRDYWNoZSA9ICRjYWNoZUZhY3RvcnkoJyRodHRwJyk7CgogICAgLyoqCiAgICAgKiBJbnRlcmNlcHRvcnMgc3RvcmVkIGluIHJldmVyc2Ugb3JkZXIuIElubmVyIGludGVyY2VwdG9ycyBiZWZvcmUgb3V0ZXIgaW50ZXJjZXB0b3JzLgogICAgICogVGhlIHJldmVyc2FsIGlzIG5lZWRlZCBzbyB0aGF0IHdlIGNhbiBidWlsZCB1cCB0aGUgaW50ZXJjZXB0aW9uIGNoYWluIGFyb3VuZCB0aGUKICAgICAqIHNlcnZlciByZXF1ZXN0LgogICAgICovCiAgICB2YXIgcmV2ZXJzZWRJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICBmb3JFYWNoKGludGVyY2VwdG9yRmFjdG9yaWVzLCBmdW5jdGlvbihpbnRlcmNlcHRvckZhY3RvcnkpIHsKICAgICAgcmV2ZXJzZWRJbnRlcmNlcHRvcnMudW5zaGlmdChpc1N0cmluZyhpbnRlcmNlcHRvckZhY3RvcnkpCiAgICAgICAgICA/ICRpbmplY3Rvci5nZXQoaW50ZXJjZXB0b3JGYWN0b3J5KSA6ICRpbmplY3Rvci5pbnZva2UoaW50ZXJjZXB0b3JGYWN0b3J5KSk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICogQG5hbWUgJGh0dHAKICAgICAqIEByZXF1aXJlcyBuZy4kaHR0cEJhY2tlbmQKICAgICAqIEByZXF1aXJlcyAkY2FjaGVGYWN0b3J5CiAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICogQHJlcXVpcmVzICRxCiAgICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYCRodHRwYCBzZXJ2aWNlIGlzIGEgY29yZSBBbmd1bGFyIHNlcnZpY2UgdGhhdCBmYWNpbGl0YXRlcyBjb21tdW5pY2F0aW9uIHdpdGggdGhlIHJlbW90ZQogICAgICogSFRUUCBzZXJ2ZXJzIHZpYSB0aGUgYnJvd3NlcidzIFtYTUxIdHRwUmVxdWVzdF0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4veG1saHR0cHJlcXVlc3QpCiAgICAgKiBvYmplY3Qgb3IgdmlhIFtKU09OUF0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9KU09OUCkuCiAgICAgKgogICAgICogRm9yIHVuaXQgdGVzdGluZyBhcHBsaWNhdGlvbnMgdGhhdCB1c2UgYCRodHRwYCBzZXJ2aWNlLCBzZWUKICAgICAqIHtAbGluayBuZ01vY2suJGh0dHBCYWNrZW5kICRodHRwQmFja2VuZCBtb2NrfS4KICAgICAqCiAgICAgKiBGb3IgYSBoaWdoZXIgbGV2ZWwgb2YgYWJzdHJhY3Rpb24sIHBsZWFzZSBjaGVjayBvdXQgdGhlIHtAbGluayBuZ1Jlc291cmNlLiRyZXNvdXJjZQogICAgICogJHJlc291cmNlfSBzZXJ2aWNlLgogICAgICoKICAgICAqIFRoZSAkaHR0cCBBUEkgaXMgYmFzZWQgb24gdGhlIHtAbGluayBuZy4kcSBkZWZlcnJlZC9wcm9taXNlIEFQSXN9IGV4cG9zZWQgYnkKICAgICAqIHRoZSAkcSBzZXJ2aWNlLiBXaGlsZSBmb3Igc2ltcGxlIHVzYWdlIHBhdHRlcm5zIHRoaXMgZG9lc24ndCBtYXR0ZXIgbXVjaCwgZm9yIGFkdmFuY2VkIHVzYWdlCiAgICAgKiBpdCBpcyBpbXBvcnRhbnQgdG8gZmFtaWxpYXJpemUgeW91cnNlbGYgd2l0aCB0aGVzZSBBUElzIGFuZCB0aGUgZ3VhcmFudGVlcyB0aGV5IHByb3ZpZGUuCiAgICAgKgogICAgICoKICAgICAqICMjIEdlbmVyYWwgdXNhZ2UKICAgICAqIFRoZSBgJGh0dHBgIHNlcnZpY2UgaXMgYSBmdW5jdGlvbiB3aGljaCB0YWtlcyBhIHNpbmdsZSBhcmd1bWVudCDigJQgYSBjb25maWd1cmF0aW9uIG9iamVjdCDigJQKICAgICAqIHRoYXQgaXMgdXNlZCB0byBnZW5lcmF0ZSBhbiBIVFRQIHJlcXVlc3QgYW5kIHJldHVybnMgIGEge0BsaW5rIG5nLiRxIHByb21pc2V9CiAgICAgKiB3aXRoIHR3byAkaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuCiAgICAgKgogICAgICogYGBganMKICAgICAqICAgLy8gU2ltcGxlIEdFVCByZXF1ZXN0IGV4YW1wbGUgOgogICAgICogICAkaHR0cC5nZXQoJy9zb21lVXJsJykuCiAgICAgKiAgICAgc3VjY2VzcyhmdW5jdGlvbihkYXRhLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICogICAgICAgLy8gdGhpcyBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBhc3luY2hyb25vdXNseQogICAgICogICAgICAgLy8gd2hlbiB0aGUgcmVzcG9uc2UgaXMgYXZhaWxhYmxlCiAgICAgKiAgICAgfSkuCiAgICAgKiAgICAgZXJyb3IoZnVuY3Rpb24oZGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAqICAgICAgIC8vIGNhbGxlZCBhc3luY2hyb25vdXNseSBpZiBhbiBlcnJvciBvY2N1cnMKICAgICAqICAgICAgIC8vIG9yIHNlcnZlciByZXR1cm5zIHJlc3BvbnNlIHdpdGggYW4gZXJyb3Igc3RhdHVzLgogICAgICogICAgIH0pOwogICAgICogYGBgCiAgICAgKgogICAgICogYGBganMKICAgICAqICAgLy8gU2ltcGxlIFBPU1QgcmVxdWVzdCBleGFtcGxlIChwYXNzaW5nIGRhdGEpIDoKICAgICAqICAgJGh0dHAucG9zdCgnL3NvbWVVcmwnLCB7bXNnOidoZWxsbyB3b3JkISd9KS4KICAgICAqICAgICBzdWNjZXNzKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7CiAgICAgKiAgICAgICAvLyB0aGlzIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGFzeW5jaHJvbm91c2x5CiAgICAgKiAgICAgICAvLyB3aGVuIHRoZSByZXNwb25zZSBpcyBhdmFpbGFibGUKICAgICAqICAgICB9KS4KICAgICAqICAgICBlcnJvcihmdW5jdGlvbihkYXRhLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICogICAgICAgLy8gY2FsbGVkIGFzeW5jaHJvbm91c2x5IGlmIGFuIGVycm9yIG9jY3VycwogICAgICogICAgICAgLy8gb3Igc2VydmVyIHJldHVybnMgcmVzcG9uc2Ugd2l0aCBhbiBlcnJvciBzdGF0dXMuCiAgICAgKiAgICAgfSk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKgogICAgICogU2luY2UgdGhlIHJldHVybmVkIHZhbHVlIG9mIGNhbGxpbmcgdGhlICRodHRwIGZ1bmN0aW9uIGlzIGEgYHByb21pc2VgLCB5b3UgY2FuIGFsc28gdXNlCiAgICAgKiB0aGUgYHRoZW5gIG1ldGhvZCB0byByZWdpc3RlciBjYWxsYmFja3MsIGFuZCB0aGVzZSBjYWxsYmFja3Mgd2lsbCByZWNlaXZlIGEgc2luZ2xlIGFyZ3VtZW50IOKAkwogICAgICogYW4gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcmVzcG9uc2UuIFNlZSB0aGUgQVBJIHNpZ25hdHVyZSBhbmQgdHlwZSBpbmZvIGJlbG93IGZvciBtb3JlCiAgICAgKiBkZXRhaWxzLgogICAgICoKICAgICAqIEEgcmVzcG9uc2Ugc3RhdHVzIGNvZGUgYmV0d2VlbiAyMDAgYW5kIDI5OSBpcyBjb25zaWRlcmVkIGEgc3VjY2VzcyBzdGF0dXMgYW5kCiAgICAgKiB3aWxsIHJlc3VsdCBpbiB0aGUgc3VjY2VzcyBjYWxsYmFjayBiZWluZyBjYWxsZWQuIE5vdGUgdGhhdCBpZiB0aGUgcmVzcG9uc2UgaXMgYSByZWRpcmVjdCwKICAgICAqIFhNTEh0dHBSZXF1ZXN0IHdpbGwgdHJhbnNwYXJlbnRseSBmb2xsb3cgaXQsIG1lYW5pbmcgdGhhdCB0aGUgZXJyb3IgY2FsbGJhY2sgd2lsbCBub3QgYmUKICAgICAqIGNhbGxlZCBmb3Igc3VjaCByZXNwb25zZXMuCiAgICAgKgogICAgICogIyMgV3JpdGluZyBVbml0IFRlc3RzIHRoYXQgdXNlICRodHRwCiAgICAgKiBXaGVuIHVuaXQgdGVzdGluZyAodXNpbmcge0BsaW5rIG5nTW9jayBuZ01vY2t9KSwgaXQgaXMgbmVjZXNzYXJ5IHRvIGNhbGwKICAgICAqIHtAbGluayBuZ01vY2suJGh0dHBCYWNrZW5kI2ZsdXNoICRodHRwQmFja2VuZC5mbHVzaCgpfSB0byBmbHVzaCBlYWNoIHBlbmRpbmcKICAgICAqIHJlcXVlc3QgdXNpbmcgdHJhaW5lZCByZXNwb25zZXMuCiAgICAgKgogICAgICogYGBgCiAgICAgKiAkaHR0cEJhY2tlbmQuZXhwZWN0R0VUKC4uLik7CiAgICAgKiAkaHR0cC5nZXQoLi4uKTsKICAgICAqICRodHRwQmFja2VuZC5mbHVzaCgpOwogICAgICogYGBgCiAgICAgKgogICAgICogIyMgU2hvcnRjdXQgbWV0aG9kcwogICAgICoKICAgICAqIFNob3J0Y3V0IG1ldGhvZHMgYXJlIGFsc28gYXZhaWxhYmxlLiBBbGwgc2hvcnRjdXQgbWV0aG9kcyByZXF1aXJlIHBhc3NpbmcgaW4gdGhlIFVSTCwgYW5kCiAgICAgKiByZXF1ZXN0IGRhdGEgbXVzdCBiZSBwYXNzZWQgaW4gZm9yIFBPU1QvUFVUIHJlcXVlc3RzLgogICAgICoKICAgICAqIGBgYGpzCiAgICAgKiAgICRodHRwLmdldCgnL3NvbWVVcmwnKS5zdWNjZXNzKHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgKiAgICRodHRwLnBvc3QoJy9zb21lVXJsJywgZGF0YSkuc3VjY2VzcyhzdWNjZXNzQ2FsbGJhY2spOwogICAgICogYGBgCiAgICAgKgogICAgICogQ29tcGxldGUgbGlzdCBvZiBzaG9ydGN1dCBtZXRob2RzOgogICAgICoKICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2dldCAkaHR0cC5nZXR9CiAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNoZWFkICRodHRwLmhlYWR9CiAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNwb3N0ICRodHRwLnBvc3R9CiAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNwdXQgJGh0dHAucHV0fQogICAgICogLSB7QGxpbmsgbmcuJGh0dHAjZGVsZXRlICRodHRwLmRlbGV0ZX0KICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2pzb25wICRodHRwLmpzb25wfQogICAgICogLSB7QGxpbmsgbmcuJGh0dHAjcGF0Y2ggJGh0dHAucGF0Y2h9CiAgICAgKgogICAgICoKICAgICAqICMjIFNldHRpbmcgSFRUUCBIZWFkZXJzCiAgICAgKgogICAgICogVGhlICRodHRwIHNlcnZpY2Ugd2lsbCBhdXRvbWF0aWNhbGx5IGFkZCBjZXJ0YWluIEhUVFAgaGVhZGVycyB0byBhbGwgcmVxdWVzdHMuIFRoZXNlIGRlZmF1bHRzCiAgICAgKiBjYW4gYmUgZnVsbHkgY29uZmlndXJlZCBieSBhY2Nlc3NpbmcgdGhlIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnNgIGNvbmZpZ3VyYXRpb24KICAgICAqIG9iamVjdCwgd2hpY2ggY3VycmVudGx5IGNvbnRhaW5zIHRoaXMgZGVmYXVsdCBjb25maWd1cmF0aW9uOgogICAgICoKICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5jb21tb25gIChoZWFkZXJzIHRoYXQgYXJlIGNvbW1vbiBmb3IgYWxsIHJlcXVlc3RzKToKICAgICAqICAgLSBgQWNjZXB0OiBhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L3BsYWluLCAqIC8gKmAKICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5wb3N0YDogKGhlYWRlciBkZWZhdWx0cyBmb3IgUE9TVCByZXF1ZXN0cykKICAgICAqICAgLSBgQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uYAogICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLnB1dGAgKGhlYWRlciBkZWZhdWx0cyBmb3IgUFVUIHJlcXVlc3RzKQogICAgICogICAtIGBDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb25gCiAgICAgKgogICAgICogVG8gYWRkIG9yIG92ZXJ3cml0ZSB0aGVzZSBkZWZhdWx0cywgc2ltcGx5IGFkZCBvciByZW1vdmUgYSBwcm9wZXJ0eSBmcm9tIHRoZXNlIGNvbmZpZ3VyYXRpb24KICAgICAqIG9iamVjdHMuIFRvIGFkZCBoZWFkZXJzIGZvciBhbiBIVFRQIG1ldGhvZCBvdGhlciB0aGFuIFBPU1Qgb3IgUFVULCBzaW1wbHkgYWRkIGEgbmV3IG9iamVjdAogICAgICogd2l0aCB0aGUgbG93ZXJjYXNlZCBIVFRQIG1ldGhvZCBuYW1lIGFzIHRoZSBrZXksIGUuZy4KICAgICAqIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMuZ2V0ID0geyAnTXktSGVhZGVyJyA6ICd2YWx1ZScgfS4KICAgICAqCiAgICAgKiBUaGUgZGVmYXVsdHMgY2FuIGFsc28gYmUgc2V0IGF0IHJ1bnRpbWUgdmlhIHRoZSBgJGh0dHAuZGVmYXVsdHNgIG9iamVjdCBpbiB0aGUgc2FtZQogICAgICogZmFzaGlvbi4gRm9yIGV4YW1wbGU6CiAgICAgKgogICAgICogYGBgCiAgICAgKiBtb2R1bGUucnVuKGZ1bmN0aW9uKCRodHRwKSB7CiAgICAgKiAgICRodHRwLmRlZmF1bHRzLmhlYWRlcnMuY29tbW9uLkF1dGhvcml6YXRpb24gPSAnQmFzaWMgWW1WbGNEcGliMjl3JwogICAgICogfSk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBJbiBhZGRpdGlvbiwgeW91IGNhbiBzdXBwbHkgYSBgaGVhZGVyc2AgcHJvcGVydHkgaW4gdGhlIGNvbmZpZyBvYmplY3QgcGFzc2VkIHdoZW4KICAgICAqIGNhbGxpbmcgYCRodHRwKGNvbmZpZylgLCB3aGljaCBvdmVycmlkZXMgdGhlIGRlZmF1bHRzIHdpdGhvdXQgY2hhbmdpbmcgdGhlbSBnbG9iYWxseS4KICAgICAqCiAgICAgKgogICAgICogIyMgVHJhbnNmb3JtaW5nIFJlcXVlc3RzIGFuZCBSZXNwb25zZXMKICAgICAqCiAgICAgKiBCb3RoIHJlcXVlc3RzIGFuZCByZXNwb25zZXMgY2FuIGJlIHRyYW5zZm9ybWVkIHVzaW5nIHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9uczogYHRyYW5zZm9ybVJlcXVlc3RgCiAgICAgKiBhbmQgYHRyYW5zZm9ybVJlc3BvbnNlYC4gVGhlc2UgcHJvcGVydGllcyBjYW4gYmUgYSBzaW5nbGUgZnVuY3Rpb24gdGhhdCByZXR1cm5zCiAgICAgKiB0aGUgdHJhbnNmb3JtZWQgdmFsdWUgKGB7ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcilgKSBvciBhbiBhcnJheSBvZiBzdWNoIHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9ucywKICAgICAqIHdoaWNoIGFsbG93cyB5b3UgdG8gYHB1c2hgIG9yIGB1bnNoaWZ0YCBhIG5ldyB0cmFuc2Zvcm1hdGlvbiBmdW5jdGlvbiBpbnRvIHRoZSB0cmFuc2Zvcm1hdGlvbiBjaGFpbi4KICAgICAqCiAgICAgKiAjIyMgRGVmYXVsdCBUcmFuc2Zvcm1hdGlvbnMKICAgICAqCiAgICAgKiBUaGUgYCRodHRwUHJvdmlkZXJgIHByb3ZpZGVyIGFuZCBgJGh0dHBgIHNlcnZpY2UgZXhwb3NlIGBkZWZhdWx0cy50cmFuc2Zvcm1SZXF1ZXN0YCBhbmQKICAgICAqIGBkZWZhdWx0cy50cmFuc2Zvcm1SZXNwb25zZWAgcHJvcGVydGllcy4gSWYgYSByZXF1ZXN0IGRvZXMgbm90IHByb3ZpZGUgaXRzIG93biB0cmFuc2Zvcm1hdGlvbnMKICAgICAqIHRoZW4gdGhlc2Ugd2lsbCBiZSBhcHBsaWVkLgogICAgICoKICAgICAqIFlvdSBjYW4gYXVnbWVudCBvciByZXBsYWNlIHRoZSBkZWZhdWx0IHRyYW5zZm9ybWF0aW9ucyBieSBtb2RpZnlpbmcgdGhlc2UgcHJvcGVydGllcyBieSBhZGRpbmcgdG8gb3IKICAgICAqIHJlcGxhY2luZyB0aGUgYXJyYXkuCiAgICAgKgogICAgICogQW5ndWxhciBwcm92aWRlcyB0aGUgZm9sbG93aW5nIGRlZmF1bHQgdHJhbnNmb3JtYXRpb25zOgogICAgICoKICAgICAqIFJlcXVlc3QgdHJhbnNmb3JtYXRpb25zIChgJGh0dHBQcm92aWRlci5kZWZhdWx0cy50cmFuc2Zvcm1SZXF1ZXN0YCBhbmQgYCRodHRwLmRlZmF1bHRzLnRyYW5zZm9ybVJlcXVlc3RgKToKICAgICAqCiAgICAgKiAtIElmIHRoZSBgZGF0YWAgcHJvcGVydHkgb2YgdGhlIHJlcXVlc3QgY29uZmlndXJhdGlvbiBvYmplY3QgY29udGFpbnMgYW4gb2JqZWN0LCBzZXJpYWxpemUgaXQKICAgICAqICAgaW50byBKU09OIGZvcm1hdC4KICAgICAqCiAgICAgKiBSZXNwb25zZSB0cmFuc2Zvcm1hdGlvbnMgKGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLnRyYW5zZm9ybVJlc3BvbnNlYCBhbmQgYCRodHRwLmRlZmF1bHRzLnRyYW5zZm9ybVJlc3BvbnNlYCk6CiAgICAgKgogICAgICogIC0gSWYgWFNSRiBwcmVmaXggaXMgZGV0ZWN0ZWQsIHN0cmlwIGl0IChzZWUgU2VjdXJpdHkgQ29uc2lkZXJhdGlvbnMgc2VjdGlvbiBiZWxvdykuCiAgICAgKiAgLSBJZiBKU09OIHJlc3BvbnNlIGlzIGRldGVjdGVkLCBkZXNlcmlhbGl6ZSBpdCB1c2luZyBhIEpTT04gcGFyc2VyLgogICAgICoKICAgICAqCiAgICAgKiAjIyMgT3ZlcnJpZGluZyB0aGUgRGVmYXVsdCBUcmFuc2Zvcm1hdGlvbnMgUGVyIFJlcXVlc3QKICAgICAqCiAgICAgKiBJZiB5b3Ugd2lzaCBvdmVycmlkZSB0aGUgcmVxdWVzdC9yZXNwb25zZSB0cmFuc2Zvcm1hdGlvbnMgb25seSBmb3IgYSBzaW5nbGUgcmVxdWVzdCB0aGVuIHByb3ZpZGUKICAgICAqIGB0cmFuc2Zvcm1SZXF1ZXN0YCBhbmQvb3IgYHRyYW5zZm9ybVJlc3BvbnNlYCBwcm9wZXJ0aWVzIG9uIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdCBwYXNzZWQKICAgICAqIGludG8gYCRodHRwYC4KICAgICAqCiAgICAgKiBOb3RlIHRoYXQgaWYgeW91IHByb3ZpZGUgdGhlc2UgcHJvcGVydGllcyBvbiB0aGUgY29uZmlnIG9iamVjdCB0aGUgZGVmYXVsdCB0cmFuc2Zvcm1hdGlvbnMgd2lsbCBiZQogICAgICogb3ZlcndyaXR0ZW4uIElmIHlvdSB3aXNoIHRvIGF1Z21lbnQgdGhlIGRlZmF1bHQgdHJhbnNmb3JtYXRpb25zIHRoZW4geW91IG11c3QgaW5jbHVkZSB0aGVtIGluIHlvdXIKICAgICAqIGxvY2FsIHRyYW5zZm9ybWF0aW9uIGFycmF5LgogICAgICoKICAgICAqIFRoZSBmb2xsb3dpbmcgY29kZSBkZW1vbnN0cmF0ZXMgYWRkaW5nIGEgbmV3IHJlc3BvbnNlIHRyYW5zZm9ybWF0aW9uIHRvIGJlIHJ1biBhZnRlciB0aGUgZGVmYXVsdCByZXNwb25zZQogICAgICogdHJhbnNmb3JtYXRpb25zIGhhdmUgYmVlbiBydW4uCiAgICAgKgogICAgICogYGBganMKICAgICAqIGZ1bmN0aW9uIGFwcGVuZFRyYW5zZm9ybShkZWZhdWx0cywgdHJhbnNmb3JtKSB7CiAgICAgKgogICAgICogICAvLyBXZSBjYW4ndCBndWFyYW50ZWUgdGhhdCB0aGUgZGVmYXVsdCB0cmFuc2Zvcm1hdGlvbiBpcyBhbiBhcnJheQogICAgICogICBkZWZhdWx0cyA9IGFuZ3VsYXIuaXNBcnJheShkZWZhdWx0cykgPyBkZWZhdWx0cyA6IFtkZWZhdWx0c107CiAgICAgKgogICAgICogICAvLyBBcHBlbmQgdGhlIG5ldyB0cmFuc2Zvcm1hdGlvbiB0byB0aGUgZGVmYXVsdHMKICAgICAqICAgcmV0dXJuIGRlZmF1bHRzLmNvbmNhdCh0cmFuc2Zvcm0pOwogICAgICogfQogICAgICoKICAgICAqICRodHRwKHsKICAgICAqICAgdXJsOiAnLi4uJywKICAgICAqICAgbWV0aG9kOiAnR0VUJywKICAgICAqICAgdHJhbnNmb3JtUmVzcG9uc2U6IGFwcGVuZFRyYW5zZm9ybSgkaHR0cC5kZWZhdWx0cy50cmFuc2Zvcm1SZXNwb25zZSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAqICAgICByZXR1cm4gZG9UcmFuc2Zvcm0odmFsdWUpOwogICAgICogICB9KQogICAgICogfSk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKgogICAgICogIyMgQ2FjaGluZwogICAgICoKICAgICAqIFRvIGVuYWJsZSBjYWNoaW5nLCBzZXQgdGhlIHJlcXVlc3QgY29uZmlndXJhdGlvbiBgY2FjaGVgIHByb3BlcnR5IHRvIGB0cnVlYCAodG8gdXNlIGRlZmF1bHQKICAgICAqIGNhY2hlKSBvciB0byBhIGN1c3RvbSBjYWNoZSBvYmplY3QgKGJ1aWx0IHdpdGgge0BsaW5rIG5nLiRjYWNoZUZhY3RvcnkgYCRjYWNoZUZhY3RvcnlgfSkuCiAgICAgKiBXaGVuIHRoZSBjYWNoZSBpcyBlbmFibGVkLCBgJGh0dHBgIHN0b3JlcyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyIGluIHRoZSBzcGVjaWZpZWQKICAgICAqIGNhY2hlLiBUaGUgbmV4dCB0aW1lIHRoZSBzYW1lIHJlcXVlc3QgaXMgbWFkZSwgdGhlIHJlc3BvbnNlIGlzIHNlcnZlZCBmcm9tIHRoZSBjYWNoZSB3aXRob3V0CiAgICAgKiBzZW5kaW5nIGEgcmVxdWVzdCB0byB0aGUgc2VydmVyLgogICAgICoKICAgICAqIE5vdGUgdGhhdCBldmVuIGlmIHRoZSByZXNwb25zZSBpcyBzZXJ2ZWQgZnJvbSBjYWNoZSwgZGVsaXZlcnkgb2YgdGhlIGRhdGEgaXMgYXN5bmNocm9ub3VzIGluCiAgICAgKiB0aGUgc2FtZSB3YXkgdGhhdCByZWFsIHJlcXVlc3RzIGFyZS4KICAgICAqCiAgICAgKiBJZiB0aGVyZSBhcmUgbXVsdGlwbGUgR0VUIHJlcXVlc3RzIGZvciB0aGUgc2FtZSBVUkwgdGhhdCBzaG91bGQgYmUgY2FjaGVkIHVzaW5nIHRoZSBzYW1lCiAgICAgKiBjYWNoZSwgYnV0IHRoZSBjYWNoZSBpcyBub3QgcG9wdWxhdGVkIHlldCwgb25seSBvbmUgcmVxdWVzdCB0byB0aGUgc2VydmVyIHdpbGwgYmUgbWFkZSBhbmQKICAgICAqIHRoZSByZW1haW5pbmcgcmVxdWVzdHMgd2lsbCBiZSBmdWxmaWxsZWQgdXNpbmcgdGhlIHJlc3BvbnNlIGZyb20gdGhlIGZpcnN0IHJlcXVlc3QuCiAgICAgKgogICAgICogWW91IGNhbiBjaGFuZ2UgdGhlIGRlZmF1bHQgY2FjaGUgdG8gYSBuZXcgb2JqZWN0IChidWlsdCB3aXRoCiAgICAgKiB7QGxpbmsgbmcuJGNhY2hlRmFjdG9yeSBgJGNhY2hlRmFjdG9yeWB9KSBieSB1cGRhdGluZyB0aGUKICAgICAqIHtAbGluayBuZy4kaHR0cCNkZWZhdWx0cyBgJGh0dHAuZGVmYXVsdHMuY2FjaGVgfSBwcm9wZXJ0eS4gQWxsIHJlcXVlc3RzIHdobyBzZXQKICAgICAqIHRoZWlyIGBjYWNoZWAgcHJvcGVydHkgdG8gYHRydWVgIHdpbGwgbm93IHVzZSB0aGlzIGNhY2hlIG9iamVjdC4KICAgICAqCiAgICAgKiBJZiB5b3Ugc2V0IHRoZSBkZWZhdWx0IGNhY2hlIHRvIGBmYWxzZWAgdGhlbiBvbmx5IHJlcXVlc3RzIHRoYXQgc3BlY2lmeSB0aGVpciBvd24gY3VzdG9tCiAgICAgKiBjYWNoZSBvYmplY3Qgd2lsbCBiZSBjYWNoZWQuCiAgICAgKgogICAgICogIyMgSW50ZXJjZXB0b3JzCiAgICAgKgogICAgICogQmVmb3JlIHlvdSBzdGFydCBjcmVhdGluZyBpbnRlcmNlcHRvcnMsIGJlIHN1cmUgdG8gdW5kZXJzdGFuZCB0aGUKICAgICAqIHtAbGluayBuZy4kcSAkcSBhbmQgZGVmZXJyZWQvcHJvbWlzZSBBUElzfS4KICAgICAqCiAgICAgKiBGb3IgcHVycG9zZXMgb2YgZ2xvYmFsIGVycm9yIGhhbmRsaW5nLCBhdXRoZW50aWNhdGlvbiwgb3IgYW55IGtpbmQgb2Ygc3luY2hyb25vdXMgb3IKICAgICAqIGFzeW5jaHJvbm91cyBwcmUtcHJvY2Vzc2luZyBvZiByZXF1ZXN0IG9yIHBvc3Rwcm9jZXNzaW5nIG9mIHJlc3BvbnNlcywgaXQgaXMgZGVzaXJhYmxlIHRvIGJlCiAgICAgKiBhYmxlIHRvIGludGVyY2VwdCByZXF1ZXN0cyBiZWZvcmUgdGhleSBhcmUgaGFuZGVkIHRvIHRoZSBzZXJ2ZXIgYW5kCiAgICAgKiByZXNwb25zZXMgYmVmb3JlIHRoZXkgYXJlIGhhbmRlZCBvdmVyIHRvIHRoZSBhcHBsaWNhdGlvbiBjb2RlIHRoYXQKICAgICAqIGluaXRpYXRlZCB0aGVzZSByZXF1ZXN0cy4gVGhlIGludGVyY2VwdG9ycyBsZXZlcmFnZSB0aGUge0BsaW5rIG5nLiRxCiAgICAgKiBwcm9taXNlIEFQSXN9IHRvIGZ1bGZpbGwgdGhpcyBuZWVkIGZvciBib3RoIHN5bmNocm9ub3VzIGFuZCBhc3luY2hyb25vdXMgcHJlLXByb2Nlc3NpbmcuCiAgICAgKgogICAgICogVGhlIGludGVyY2VwdG9ycyBhcmUgc2VydmljZSBmYWN0b3JpZXMgdGhhdCBhcmUgcmVnaXN0ZXJlZCB3aXRoIHRoZSBgJGh0dHBQcm92aWRlcmAgYnkKICAgICAqIGFkZGluZyB0aGVtIHRvIHRoZSBgJGh0dHBQcm92aWRlci5pbnRlcmNlcHRvcnNgIGFycmF5LiBUaGUgZmFjdG9yeSBpcyBjYWxsZWQgYW5kCiAgICAgKiBpbmplY3RlZCB3aXRoIGRlcGVuZGVuY2llcyAoaWYgc3BlY2lmaWVkKSBhbmQgcmV0dXJucyB0aGUgaW50ZXJjZXB0b3IuCiAgICAgKgogICAgICogVGhlcmUgYXJlIHR3byBraW5kcyBvZiBpbnRlcmNlcHRvcnMgKGFuZCB0d28ga2luZHMgb2YgcmVqZWN0aW9uIGludGVyY2VwdG9ycyk6CiAgICAgKgogICAgICogICAqIGByZXF1ZXN0YDogaW50ZXJjZXB0b3JzIGdldCBjYWxsZWQgd2l0aCBhIGh0dHAgYGNvbmZpZ2Agb2JqZWN0LiBUaGUgZnVuY3Rpb24gaXMgZnJlZSB0bwogICAgICogICAgIG1vZGlmeSB0aGUgYGNvbmZpZ2Agb2JqZWN0IG9yIGNyZWF0ZSBhIG5ldyBvbmUuIFRoZSBmdW5jdGlvbiBuZWVkcyB0byByZXR1cm4gdGhlIGBjb25maWdgCiAgICAgKiAgICAgb2JqZWN0IGRpcmVjdGx5LCBvciBhIHByb21pc2UgY29udGFpbmluZyB0aGUgYGNvbmZpZ2Agb3IgYSBuZXcgYGNvbmZpZ2Agb2JqZWN0LgogICAgICogICAqIGByZXF1ZXN0RXJyb3JgOiBpbnRlcmNlcHRvciBnZXRzIGNhbGxlZCB3aGVuIGEgcHJldmlvdXMgaW50ZXJjZXB0b3IgdGhyZXcgYW4gZXJyb3Igb3IKICAgICAqICAgICByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLgogICAgICogICAqIGByZXNwb25zZWA6IGludGVyY2VwdG9ycyBnZXQgY2FsbGVkIHdpdGggaHR0cCBgcmVzcG9uc2VgIG9iamVjdC4gVGhlIGZ1bmN0aW9uIGlzIGZyZWUgdG8KICAgICAqICAgICBtb2RpZnkgdGhlIGByZXNwb25zZWAgb2JqZWN0IG9yIGNyZWF0ZSBhIG5ldyBvbmUuIFRoZSBmdW5jdGlvbiBuZWVkcyB0byByZXR1cm4gdGhlIGByZXNwb25zZWAKICAgICAqICAgICBvYmplY3QgZGlyZWN0bHksIG9yIGFzIGEgcHJvbWlzZSBjb250YWluaW5nIHRoZSBgcmVzcG9uc2VgIG9yIGEgbmV3IGByZXNwb25zZWAgb2JqZWN0LgogICAgICogICAqIGByZXNwb25zZUVycm9yYDogaW50ZXJjZXB0b3IgZ2V0cyBjYWxsZWQgd2hlbiBhIHByZXZpb3VzIGludGVyY2VwdG9yIHRocmV3IGFuIGVycm9yIG9yCiAgICAgKiAgICAgcmVzb2x2ZWQgd2l0aCBhIHJlamVjdGlvbi4KICAgICAqCiAgICAgKgogICAgICogYGBganMKICAgICAqICAgLy8gcmVnaXN0ZXIgdGhlIGludGVyY2VwdG9yIGFzIGEgc2VydmljZQogICAgICogICAkcHJvdmlkZS5mYWN0b3J5KCdteUh0dHBJbnRlcmNlcHRvcicsIGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAqICAgICByZXR1cm4gewogICAgICogICAgICAgLy8gb3B0aW9uYWwgbWV0aG9kCiAgICAgKiAgICAgICAncmVxdWVzdCc6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gc3VjY2VzcwogICAgICogICAgICAgICByZXR1cm4gY29uZmlnOwogICAgICogICAgICAgfSwKICAgICAqCiAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAqICAgICAgJ3JlcXVlc3RFcnJvcic6IGZ1bmN0aW9uKHJlamVjdGlvbikgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gZXJyb3IKICAgICAqICAgICAgICAgaWYgKGNhblJlY292ZXIocmVqZWN0aW9uKSkgewogICAgICogICAgICAgICAgIHJldHVybiByZXNwb25zZU9yTmV3UHJvbWlzZQogICAgICogICAgICAgICB9CiAgICAgKiAgICAgICAgIHJldHVybiAkcS5yZWplY3QocmVqZWN0aW9uKTsKICAgICAqICAgICAgIH0sCiAgICAgKgogICAgICoKICAgICAqCiAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAqICAgICAgICdyZXNwb25zZSc6IGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBzdWNjZXNzCiAgICAgKiAgICAgICAgIHJldHVybiByZXNwb25zZTsKICAgICAqICAgICAgIH0sCiAgICAgKgogICAgICogICAgICAgLy8gb3B0aW9uYWwgbWV0aG9kCiAgICAgKiAgICAgICdyZXNwb25zZUVycm9yJzogZnVuY3Rpb24ocmVqZWN0aW9uKSB7CiAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBlcnJvcgogICAgICogICAgICAgICBpZiAoY2FuUmVjb3ZlcihyZWplY3Rpb24pKSB7CiAgICAgKiAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT3JOZXdQcm9taXNlCiAgICAgKiAgICAgICAgIH0KICAgICAqICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZWplY3Rpb24pOwogICAgICogICAgICAgfQogICAgICogICAgIH07CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqICAgJGh0dHBQcm92aWRlci5pbnRlcmNlcHRvcnMucHVzaCgnbXlIdHRwSW50ZXJjZXB0b3InKTsKICAgICAqCiAgICAgKgogICAgICogICAvLyBhbHRlcm5hdGl2ZWx5LCByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgdmlhIGFuIGFub255bW91cyBmYWN0b3J5CiAgICAgKiAgICRodHRwUHJvdmlkZXIuaW50ZXJjZXB0b3JzLnB1c2goZnVuY3Rpb24oJHEsIGRlcGVuZGVuY3kxLCBkZXBlbmRlbmN5MikgewogICAgICogICAgIHJldHVybiB7CiAgICAgKiAgICAgICdyZXF1ZXN0JzogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgKiAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlCiAgICAgKiAgICAgICB9LAogICAgICoKICAgICAqICAgICAgICdyZXNwb25zZSc6IGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgKiAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlCiAgICAgKiAgICAgICB9CiAgICAgKiAgICAgfTsKICAgICAqICAgfSk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiAjIyBTZWN1cml0eSBDb25zaWRlcmF0aW9ucwogICAgICoKICAgICAqIFdoZW4gZGVzaWduaW5nIHdlYiBhcHBsaWNhdGlvbnMsIGNvbnNpZGVyIHNlY3VyaXR5IHRocmVhdHMgZnJvbToKICAgICAqCiAgICAgKiAtIFtKU09OIHZ1bG5lcmFiaWxpdHldKGh0dHA6Ly9oYWFja2VkLmNvbS9hcmNoaXZlLzIwMDgvMTEvMjAvYW5hdG9teS1vZi1hLXN1YnRsZS1qc29uLXZ1bG5lcmFiaWxpdHkuYXNweCkKICAgICAqIC0gW1hTUkZdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkpCiAgICAgKgogICAgICogQm90aCBzZXJ2ZXIgYW5kIHRoZSBjbGllbnQgbXVzdCBjb29wZXJhdGUgaW4gb3JkZXIgdG8gZWxpbWluYXRlIHRoZXNlIHRocmVhdHMuIEFuZ3VsYXIgY29tZXMKICAgICAqIHByZS1jb25maWd1cmVkIHdpdGggc3RyYXRlZ2llcyB0aGF0IGFkZHJlc3MgdGhlc2UgaXNzdWVzLCBidXQgZm9yIHRoaXMgdG8gd29yayBiYWNrZW5kIHNlcnZlcgogICAgICogY29vcGVyYXRpb24gaXMgcmVxdWlyZWQuCiAgICAgKgogICAgICogIyMjIEpTT04gVnVsbmVyYWJpbGl0eSBQcm90ZWN0aW9uCiAgICAgKgogICAgICogQSBbSlNPTiB2dWxuZXJhYmlsaXR5XShodHRwOi8vaGFhY2tlZC5jb20vYXJjaGl2ZS8yMDA4LzExLzIwL2FuYXRvbXktb2YtYS1zdWJ0bGUtanNvbi12dWxuZXJhYmlsaXR5LmFzcHgpCiAgICAgKiBhbGxvd3MgdGhpcmQgcGFydHkgd2Vic2l0ZSB0byB0dXJuIHlvdXIgSlNPTiByZXNvdXJjZSBVUkwgaW50bwogICAgICogW0pTT05QXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0pTT05QKSByZXF1ZXN0IHVuZGVyIHNvbWUgY29uZGl0aW9ucy4gVG8KICAgICAqIGNvdW50ZXIgdGhpcyB5b3VyIHNlcnZlciBjYW4gcHJlZml4IGFsbCBKU09OIHJlcXVlc3RzIHdpdGggZm9sbG93aW5nIHN0cmluZyBgIildfScsXG4iYC4KICAgICAqIEFuZ3VsYXIgd2lsbCBhdXRvbWF0aWNhbGx5IHN0cmlwIHRoZSBwcmVmaXggYmVmb3JlIHByb2Nlc3NpbmcgaXQgYXMgSlNPTi4KICAgICAqCiAgICAgKiBGb3IgZXhhbXBsZSBpZiB5b3VyIHNlcnZlciBuZWVkcyB0byByZXR1cm46CiAgICAgKiBgYGBqcwogICAgICogWydvbmUnLCd0d28nXQogICAgICogYGBgCiAgICAgKgogICAgICogd2hpY2ggaXMgdnVsbmVyYWJsZSB0byBhdHRhY2ssIHlvdXIgc2VydmVyIGNhbiByZXR1cm46CiAgICAgKiBgYGBqcwogICAgICogKV19JywKICAgICAqIFsnb25lJywndHdvJ10KICAgICAqIGBgYAogICAgICoKICAgICAqIEFuZ3VsYXIgd2lsbCBzdHJpcCB0aGUgcHJlZml4LCBiZWZvcmUgcHJvY2Vzc2luZyB0aGUgSlNPTi4KICAgICAqCiAgICAgKgogICAgICogIyMjIENyb3NzIFNpdGUgUmVxdWVzdCBGb3JnZXJ5IChYU1JGKSBQcm90ZWN0aW9uCiAgICAgKgogICAgICogW1hTUkZdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkpIGlzIGEgdGVjaG5pcXVlIGJ5IHdoaWNoCiAgICAgKiBhbiB1bmF1dGhvcml6ZWQgc2l0ZSBjYW4gZ2FpbiB5b3VyIHVzZXIncyBwcml2YXRlIGRhdGEuIEFuZ3VsYXIgcHJvdmlkZXMgYSBtZWNoYW5pc20KICAgICAqIHRvIGNvdW50ZXIgWFNSRi4gV2hlbiBwZXJmb3JtaW5nIFhIUiByZXF1ZXN0cywgdGhlICRodHRwIHNlcnZpY2UgcmVhZHMgYSB0b2tlbiBmcm9tIGEgY29va2llCiAgICAgKiAoYnkgZGVmYXVsdCwgYFhTUkYtVE9LRU5gKSBhbmQgc2V0cyBpdCBhcyBhbiBIVFRQIGhlYWRlciAoYFgtWFNSRi1UT0tFTmApLiBTaW5jZSBvbmx5CiAgICAgKiBKYXZhU2NyaXB0IHRoYXQgcnVucyBvbiB5b3VyIGRvbWFpbiBjb3VsZCByZWFkIHRoZSBjb29raWUsIHlvdXIgc2VydmVyIGNhbiBiZSBhc3N1cmVkIHRoYXQKICAgICAqIHRoZSBYSFIgY2FtZSBmcm9tIEphdmFTY3JpcHQgcnVubmluZyBvbiB5b3VyIGRvbWFpbi4gVGhlIGhlYWRlciB3aWxsIG5vdCBiZSBzZXQgZm9yCiAgICAgKiBjcm9zcy1kb21haW4gcmVxdWVzdHMuCiAgICAgKgogICAgICogVG8gdGFrZSBhZHZhbnRhZ2Ugb2YgdGhpcywgeW91ciBzZXJ2ZXIgbmVlZHMgdG8gc2V0IGEgdG9rZW4gaW4gYSBKYXZhU2NyaXB0IHJlYWRhYmxlIHNlc3Npb24KICAgICAqIGNvb2tpZSBjYWxsZWQgYFhTUkYtVE9LRU5gIG9uIHRoZSBmaXJzdCBIVFRQIEdFVCByZXF1ZXN0LiBPbiBzdWJzZXF1ZW50IFhIUiByZXF1ZXN0cyB0aGUKICAgICAqIHNlcnZlciBjYW4gdmVyaWZ5IHRoYXQgdGhlIGNvb2tpZSBtYXRjaGVzIGBYLVhTUkYtVE9LRU5gIEhUVFAgaGVhZGVyLCBhbmQgdGhlcmVmb3JlIGJlIHN1cmUKICAgICAqIHRoYXQgb25seSBKYXZhU2NyaXB0IHJ1bm5pbmcgb24geW91ciBkb21haW4gY291bGQgaGF2ZSBzZW50IHRoZSByZXF1ZXN0LiBUaGUgdG9rZW4gbXVzdCBiZQogICAgICogdW5pcXVlIGZvciBlYWNoIHVzZXIgYW5kIG11c3QgYmUgdmVyaWZpYWJsZSBieSB0aGUgc2VydmVyICh0byBwcmV2ZW50IHRoZSBKYXZhU2NyaXB0IGZyb20KICAgICAqIG1ha2luZyB1cCBpdHMgb3duIHRva2VucykuIFdlIHJlY29tbWVuZCB0aGF0IHRoZSB0b2tlbiBpcyBhIGRpZ2VzdCBvZiB5b3VyIHNpdGUncwogICAgICogYXV0aGVudGljYXRpb24gY29va2llIHdpdGggYSBbc2FsdF0oaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU2FsdF8oY3J5cHRvZ3JhcGh5JiM0MTspCiAgICAgKiBmb3IgYWRkZWQgc2VjdXJpdHkuCiAgICAgKgogICAgICogVGhlIG5hbWUgb2YgdGhlIGhlYWRlcnMgY2FuIGJlIHNwZWNpZmllZCB1c2luZyB0aGUgeHNyZkhlYWRlck5hbWUgYW5kIHhzcmZDb29raWVOYW1lCiAgICAgKiBwcm9wZXJ0aWVzIG9mIGVpdGhlciAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzIGF0IGNvbmZpZy10aW1lLCAkaHR0cC5kZWZhdWx0cyBhdCBydW4tdGltZSwKICAgICAqIG9yIHRoZSBwZXItcmVxdWVzdCBjb25maWcgb2JqZWN0LgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge29iamVjdH0gY29uZmlnIE9iamVjdCBkZXNjcmliaW5nIHRoZSByZXF1ZXN0IHRvIGJlIG1hZGUgYW5kIGhvdyBpdCBzaG91bGQgYmUKICAgICAqICAgIHByb2Nlc3NlZC4gVGhlIG9iamVjdCBoYXMgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgKgogICAgICogICAgLSAqKm1ldGhvZCoqIOKAkyBge3N0cmluZ31gIOKAkyBIVFRQIG1ldGhvZCAoZS5nLiAnR0VUJywgJ1BPU1QnLCBldGMpCiAgICAgKiAgICAtICoqdXJsKiog4oCTIGB7c3RyaW5nfWAg4oCTIEFic29sdXRlIG9yIHJlbGF0aXZlIFVSTCBvZiB0aGUgcmVzb3VyY2UgdGhhdCBpcyBiZWluZyByZXF1ZXN0ZWQuCiAgICAgKiAgICAtICoqcGFyYW1zKiog4oCTIGB7T2JqZWN0LjxzdHJpbmd8T2JqZWN0Pn1gIOKAkyBNYXAgb2Ygc3RyaW5ncyBvciBvYmplY3RzIHdoaWNoIHdpbGwgYmUgdHVybmVkCiAgICAgKiAgICAgIHRvIGA/a2V5MT12YWx1ZTEma2V5Mj12YWx1ZTJgIGFmdGVyIHRoZSB1cmwuIElmIHRoZSB2YWx1ZSBpcyBub3QgYSBzdHJpbmcsIGl0IHdpbGwgYmUKICAgICAqICAgICAgSlNPTmlmaWVkLgogICAgICogICAgLSAqKmRhdGEqKiDigJMgYHtzdHJpbmd8T2JqZWN0fWAg4oCTIERhdGEgdG8gYmUgc2VudCBhcyB0aGUgcmVxdWVzdCBtZXNzYWdlIGRhdGEuCiAgICAgKiAgICAtICoqaGVhZGVycyoqIOKAkyBge09iamVjdH1gIOKAkyBNYXAgb2Ygc3RyaW5ncyBvciBmdW5jdGlvbnMgd2hpY2ggcmV0dXJuIHN0cmluZ3MgcmVwcmVzZW50aW5nCiAgICAgKiAgICAgIEhUVFAgaGVhZGVycyB0byBzZW5kIHRvIHRoZSBzZXJ2ZXIuIElmIHRoZSByZXR1cm4gdmFsdWUgb2YgYSBmdW5jdGlvbiBpcyBudWxsLCB0aGUKICAgICAqICAgICAgaGVhZGVyIHdpbGwgbm90IGJlIHNlbnQuCiAgICAgKiAgICAtICoqeHNyZkhlYWRlck5hbWUqKiDigJMgYHtzdHJpbmd9YCDigJMgTmFtZSBvZiBIVFRQIGhlYWRlciB0byBwb3B1bGF0ZSB3aXRoIHRoZSBYU1JGIHRva2VuLgogICAgICogICAgLSAqKnhzcmZDb29raWVOYW1lKiog4oCTIGB7c3RyaW5nfWAg4oCTIE5hbWUgb2YgY29va2llIGNvbnRhaW5pbmcgdGhlIFhTUkYgdG9rZW4uCiAgICAgKiAgICAtICoqdHJhbnNmb3JtUmVxdWVzdCoqIOKAkwogICAgICogICAgICBge2Z1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpfEFycmF5LjxmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKT59YCDigJMKICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgKiAgICAgIHJlcXVlc3QgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICogICAgICBTZWUge0BsaW5rICNvdmVycmlkaW5nLXRoZS1kZWZhdWx0LXRyYW5zZm9ybWF0aW9ucy1wZXItcmVxdWVzdCBPdmVycmlkaW5nIHRoZSBEZWZhdWx0IFRyYW5zZm9ybWF0aW9uc30KICAgICAqICAgIC0gKip0cmFuc2Zvcm1SZXNwb25zZSoqIOKAkwogICAgICogICAgICBge2Z1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpfEFycmF5LjxmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKT59YCDigJMKICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgKiAgICAgIHJlc3BvbnNlIGJvZHkgYW5kIGhlYWRlcnMgYW5kIHJldHVybnMgaXRzIHRyYW5zZm9ybWVkICh0eXBpY2FsbHkgZGVzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICogICAgICBTZWUge0BsaW5rICNvdmVycmlkaW5nLXRoZS1kZWZhdWx0LXRyYW5zZm9ybWF0aW9ucy1wZXItcmVxdWVzdCBPdmVycmlkaW5nIHRoZSBEZWZhdWx0IFRyYW5zZm9ybWF0aW9uc30KICAgICAqICAgIC0gKipjYWNoZSoqIOKAkyBge2Jvb2xlYW58Q2FjaGV9YCDigJMgSWYgdHJ1ZSwgYSBkZWZhdWx0ICRodHRwIGNhY2hlIHdpbGwgYmUgdXNlZCB0byBjYWNoZSB0aGUKICAgICAqICAgICAgR0VUIHJlcXVlc3QsIG90aGVyd2lzZSBpZiBhIGNhY2hlIGluc3RhbmNlIGJ1aWx0IHdpdGgKICAgICAqICAgICAge0BsaW5rIG5nLiRjYWNoZUZhY3RvcnkgJGNhY2hlRmFjdG9yeX0sIHRoaXMgY2FjaGUgd2lsbCBiZSB1c2VkIGZvcgogICAgICogICAgICBjYWNoaW5nLgogICAgICogICAgLSAqKnRpbWVvdXQqKiDigJMgYHtudW1iZXJ8UHJvbWlzZX1gIOKAkyB0aW1lb3V0IGluIG1pbGxpc2Vjb25kcywgb3Ige0BsaW5rIG5nLiRxIHByb21pc2V9CiAgICAgKiAgICAgIHRoYXQgc2hvdWxkIGFib3J0IHRoZSByZXF1ZXN0IHdoZW4gcmVzb2x2ZWQuCiAgICAgKiAgICAtICoqd2l0aENyZWRlbnRpYWxzKiogLSBge2Jvb2xlYW59YCAtIHdoZXRoZXIgdG8gc2V0IHRoZSBgd2l0aENyZWRlbnRpYWxzYCBmbGFnIG9uIHRoZQogICAgICogICAgICBYSFIgb2JqZWN0LiBTZWUgW3JlcXVlc3RzIHdpdGggY3JlZGVudGlhbHNdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2RvY3MvV2ViL0hUVFAvQWNjZXNzX2NvbnRyb2xfQ09SUyNSZXF1ZXN0c193aXRoX2NyZWRlbnRpYWxzKQogICAgICogICAgICBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAqICAgIC0gKipyZXNwb25zZVR5cGUqKiAtIGB7c3RyaW5nfWAgLSBzZWUKICAgICAqICAgICAgW3JlcXVlc3RUeXBlXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS9YTUxIdHRwUmVxdWVzdCNyZXNwb25zZVR5cGUpLgogICAgICoKICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gUmV0dXJucyBhIHtAbGluayBuZy4kcSBwcm9taXNlfSBvYmplY3Qgd2l0aCB0aGUKICAgICAqICAgc3RhbmRhcmQgYHRoZW5gIG1ldGhvZCBhbmQgdHdvIGh0dHAgc3BlY2lmaWMgbWV0aG9kczogYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgLiBUaGUgYHRoZW5gCiAgICAgKiAgIG1ldGhvZCB0YWtlcyB0d28gYXJndW1lbnRzIGEgc3VjY2VzcyBhbmQgYW4gZXJyb3IgY2FsbGJhY2sgd2hpY2ggd2lsbCBiZSBjYWxsZWQgd2l0aCBhCiAgICAgKiAgIHJlc3BvbnNlIG9iamVjdC4gVGhlIGBzdWNjZXNzYCBhbmQgYGVycm9yYCBtZXRob2RzIHRha2UgYSBzaW5nbGUgYXJndW1lbnQgLSBhIGZ1bmN0aW9uIHRoYXQKICAgICAqICAgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgcmVxdWVzdCBzdWNjZWVkcyBvciBmYWlscyByZXNwZWN0aXZlbHkuIFRoZSBhcmd1bWVudHMgcGFzc2VkIGludG8KICAgICAqICAgdGhlc2UgZnVuY3Rpb25zIGFyZSBkZXN0cnVjdHVyZWQgcmVwcmVzZW50YXRpb24gb2YgdGhlIHJlc3BvbnNlIG9iamVjdCBwYXNzZWQgaW50byB0aGUKICAgICAqICAgYHRoZW5gIG1ldGhvZC4gVGhlIHJlc3BvbnNlIG9iamVjdCBoYXMgdGhlc2UgcHJvcGVydGllczoKICAgICAqCiAgICAgKiAgIC0gKipkYXRhKiog4oCTIGB7c3RyaW5nfE9iamVjdH1gIOKAkyBUaGUgcmVzcG9uc2UgYm9keSB0cmFuc2Zvcm1lZCB3aXRoIHRoZSB0cmFuc2Zvcm0KICAgICAqICAgICBmdW5jdGlvbnMuCiAgICAgKiAgIC0gKipzdGF0dXMqKiDigJMgYHtudW1iZXJ9YCDigJMgSFRUUCBzdGF0dXMgY29kZSBvZiB0aGUgcmVzcG9uc2UuCiAgICAgKiAgIC0gKipoZWFkZXJzKiog4oCTIGB7ZnVuY3Rpb24oW2hlYWRlck5hbWVdKX1gIOKAkyBIZWFkZXIgZ2V0dGVyIGZ1bmN0aW9uLgogICAgICogICAtICoqY29uZmlnKiog4oCTIGB7T2JqZWN0fWAg4oCTIFRoZSBjb25maWd1cmF0aW9uIG9iamVjdCB0aGF0IHdhcyB1c2VkIHRvIGdlbmVyYXRlIHRoZSByZXF1ZXN0LgogICAgICogICAtICoqc3RhdHVzVGV4dCoqIOKAkyBge3N0cmluZ31gIOKAkyBIVFRQIHN0YXR1cyB0ZXh0IG9mIHRoZSByZXNwb25zZS4KICAgICAqCiAgICAgKiBAcHJvcGVydHkge0FycmF5LjxPYmplY3Q+fSBwZW5kaW5nUmVxdWVzdHMgQXJyYXkgb2YgY29uZmlnIG9iamVjdHMgZm9yIGN1cnJlbnRseSBwZW5kaW5nCiAgICAgKiAgIHJlcXVlc3RzLiBUaGlzIGlzIHByaW1hcmlseSBtZWFudCB0byBiZSB1c2VkIGZvciBkZWJ1Z2dpbmcgcHVycG9zZXMuCiAgICAgKgogICAgICoKICAgICAqIEBleGFtcGxlCjxleGFtcGxlIG1vZHVsZT0iaHR0cEV4YW1wbGUiPgo8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkZldGNoQ29udHJvbGxlciI+CiAgICA8c2VsZWN0IG5nLW1vZGVsPSJtZXRob2QiPgogICAgICA8b3B0aW9uPkdFVDwvb3B0aW9uPgogICAgICA8b3B0aW9uPkpTT05QPC9vcHRpb24+CiAgICA8L3NlbGVjdD4KICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idXJsIiBzaXplPSI4MCIvPgogICAgPGJ1dHRvbiBpZD0iZmV0Y2hidG4iIG5nLWNsaWNrPSJmZXRjaCgpIj5mZXRjaDwvYnV0dG9uPjxicj4KICAgIDxidXR0b24gaWQ9InNhbXBsZWdldGJ0biIgbmctY2xpY2s9InVwZGF0ZU1vZGVsKCdHRVQnLCAnaHR0cC1oZWxsby5odG1sJykiPlNhbXBsZSBHRVQ8L2J1dHRvbj4KICAgIDxidXR0b24gaWQ9InNhbXBsZWpzb25wYnRuIgogICAgICBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywKICAgICAgICAgICAgICAgICAgICAnaHR0cHM6Ly9hbmd1bGFyanMub3JnL2dyZWV0LnBocD9jYWxsYmFjaz1KU09OX0NBTExCQUNLJm5hbWU9U3VwZXIlMjBIZXJvJykiPgogICAgICBTYW1wbGUgSlNPTlAKICAgIDwvYnV0dG9uPgogICAgPGJ1dHRvbiBpZD0iaW52YWxpZGpzb25wYnRuIgogICAgICBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywgJ2h0dHBzOi8vYW5ndWxhcmpzLm9yZy9kb2VzbnRleGlzdCZjYWxsYmFjaz1KU09OX0NBTExCQUNLJykiPgogICAgICAgIEludmFsaWQgSlNPTlAKICAgICAgPC9idXR0b24+CiAgICA8cHJlPmh0dHAgc3RhdHVzIGNvZGU6IHt7c3RhdHVzfX08L3ByZT4KICAgIDxwcmU+aHR0cCByZXNwb25zZSBkYXRhOiB7e2RhdGF9fTwvcHJlPgogIDwvZGl2Pgo8L2ZpbGU+CjxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgYW5ndWxhci5tb2R1bGUoJ2h0dHBFeGFtcGxlJywgW10pCiAgICAuY29udHJvbGxlcignRmV0Y2hDb250cm9sbGVyJywgWyckc2NvcGUnLCAnJGh0dHAnLCAnJHRlbXBsYXRlQ2FjaGUnLAogICAgICBmdW5jdGlvbigkc2NvcGUsICRodHRwLCAkdGVtcGxhdGVDYWNoZSkgewogICAgICAgICRzY29wZS5tZXRob2QgPSAnR0VUJzsKICAgICAgICAkc2NvcGUudXJsID0gJ2h0dHAtaGVsbG8uaHRtbCc7CgogICAgICAgICRzY29wZS5mZXRjaCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgJHNjb3BlLmNvZGUgPSBudWxsOwogICAgICAgICAgJHNjb3BlLnJlc3BvbnNlID0gbnVsbDsKCiAgICAgICAgICAkaHR0cCh7bWV0aG9kOiAkc2NvcGUubWV0aG9kLCB1cmw6ICRzY29wZS51cmwsIGNhY2hlOiAkdGVtcGxhdGVDYWNoZX0pLgogICAgICAgICAgICBzdWNjZXNzKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cykgewogICAgICAgICAgICAgICRzY29wZS5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgICAgICAgJHNjb3BlLmRhdGEgPSBkYXRhOwogICAgICAgICAgICB9KS4KICAgICAgICAgICAgZXJyb3IoZnVuY3Rpb24oZGF0YSwgc3RhdHVzKSB7CiAgICAgICAgICAgICAgJHNjb3BlLmRhdGEgPSBkYXRhIHx8ICJSZXF1ZXN0IGZhaWxlZCI7CiAgICAgICAgICAgICAgJHNjb3BlLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgICRzY29wZS51cGRhdGVNb2RlbCA9IGZ1bmN0aW9uKG1ldGhvZCwgdXJsKSB7CiAgICAgICAgICAkc2NvcGUubWV0aG9kID0gbWV0aG9kOwogICAgICAgICAgJHNjb3BlLnVybCA9IHVybDsKICAgICAgICB9OwogICAgICB9XSk7CjwvZmlsZT4KPGZpbGUgbmFtZT0iaHR0cC1oZWxsby5odG1sIj4KICBIZWxsbywgJGh0dHAhCjwvZmlsZT4KPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgdmFyIHN0YXR1cyA9IGVsZW1lbnQoYnkuYmluZGluZygnc3RhdHVzJykpOwogIHZhciBkYXRhID0gZWxlbWVudChieS5iaW5kaW5nKCdkYXRhJykpOwogIHZhciBmZXRjaEJ0biA9IGVsZW1lbnQoYnkuaWQoJ2ZldGNoYnRuJykpOwogIHZhciBzYW1wbGVHZXRCdG4gPSBlbGVtZW50KGJ5LmlkKCdzYW1wbGVnZXRidG4nKSk7CiAgdmFyIHNhbXBsZUpzb25wQnRuID0gZWxlbWVudChieS5pZCgnc2FtcGxlanNvbnBidG4nKSk7CiAgdmFyIGludmFsaWRKc29ucEJ0biA9IGVsZW1lbnQoYnkuaWQoJ2ludmFsaWRqc29ucGJ0bicpKTsKCiAgaXQoJ3Nob3VsZCBtYWtlIGFuIHhociBHRVQgcmVxdWVzdCcsIGZ1bmN0aW9uKCkgewogICAgc2FtcGxlR2V0QnRuLmNsaWNrKCk7CiAgICBmZXRjaEJ0bi5jbGljaygpOwogICAgZXhwZWN0KHN0YXR1cy5nZXRUZXh0KCkpLnRvTWF0Y2goJzIwMCcpOwogICAgZXhwZWN0KGRhdGEuZ2V0VGV4dCgpKS50b01hdGNoKC9IZWxsbywgXCRodHRwIS8pOwogIH0pOwoKLy8gQ29tbWVudGVkIG91dCBkdWUgdG8gZmxha2VzLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvOTE4NQovLyBpdCgnc2hvdWxkIG1ha2UgYSBKU09OUCByZXF1ZXN0IHRvIGFuZ3VsYXJqcy5vcmcnLCBmdW5jdGlvbigpIHsKLy8gICBzYW1wbGVKc29ucEJ0bi5jbGljaygpOwovLyAgIGZldGNoQnRuLmNsaWNrKCk7Ci8vICAgZXhwZWN0KHN0YXR1cy5nZXRUZXh0KCkpLnRvTWF0Y2goJzIwMCcpOwovLyAgIGV4cGVjdChkYXRhLmdldFRleHQoKSkudG9NYXRjaCgvU3VwZXIgSGVybyEvKTsKLy8gfSk7CgogIGl0KCdzaG91bGQgbWFrZSBKU09OUCByZXF1ZXN0IHRvIGludmFsaWQgVVJMIGFuZCBpbnZva2UgdGhlIGVycm9yIGhhbmRsZXInLAogICAgICBmdW5jdGlvbigpIHsKICAgIGludmFsaWRKc29ucEJ0bi5jbGljaygpOwogICAgZmV0Y2hCdG4uY2xpY2soKTsKICAgIGV4cGVjdChzdGF0dXMuZ2V0VGV4dCgpKS50b01hdGNoKCcwJyk7CiAgICBleHBlY3QoZGF0YS5nZXRUZXh0KCkpLnRvTWF0Y2goJ1JlcXVlc3QgZmFpbGVkJyk7CiAgfSk7CjwvZmlsZT4KPC9leGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiAkaHR0cChyZXF1ZXN0Q29uZmlnKSB7CiAgICAgIHZhciBjb25maWcgPSB7CiAgICAgICAgbWV0aG9kOiAnZ2V0JywKICAgICAgICB0cmFuc2Zvcm1SZXF1ZXN0OiBkZWZhdWx0cy50cmFuc2Zvcm1SZXF1ZXN0LAogICAgICAgIHRyYW5zZm9ybVJlc3BvbnNlOiBkZWZhdWx0cy50cmFuc2Zvcm1SZXNwb25zZQogICAgICB9OwogICAgICB2YXIgaGVhZGVycyA9IG1lcmdlSGVhZGVycyhyZXF1ZXN0Q29uZmlnKTsKCiAgICAgIGV4dGVuZChjb25maWcsIHJlcXVlc3RDb25maWcpOwogICAgICBjb25maWcuaGVhZGVycyA9IGhlYWRlcnM7CiAgICAgIGNvbmZpZy5tZXRob2QgPSB1cHBlcmNhc2UoY29uZmlnLm1ldGhvZCk7CgogICAgICB2YXIgc2VydmVyUmVxdWVzdCA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgIGhlYWRlcnMgPSBjb25maWcuaGVhZGVyczsKICAgICAgICB2YXIgcmVxRGF0YSA9IHRyYW5zZm9ybURhdGEoY29uZmlnLmRhdGEsIGhlYWRlcnNHZXR0ZXIoaGVhZGVycyksIGNvbmZpZy50cmFuc2Zvcm1SZXF1ZXN0KTsKCiAgICAgICAgLy8gc3RyaXAgY29udGVudC10eXBlIGlmIGRhdGEgaXMgdW5kZWZpbmVkCiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHJlcURhdGEpKSB7CiAgICAgICAgICBmb3JFYWNoKGhlYWRlcnMsIGZ1bmN0aW9uKHZhbHVlLCBoZWFkZXIpIHsKICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShoZWFkZXIpID09PSAnY29udGVudC10eXBlJykgewogICAgICAgICAgICAgICAgZGVsZXRlIGhlYWRlcnNbaGVhZGVyXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZmlnLndpdGhDcmVkZW50aWFscykgJiYgIWlzVW5kZWZpbmVkKGRlZmF1bHRzLndpdGhDcmVkZW50aWFscykpIHsKICAgICAgICAgIGNvbmZpZy53aXRoQ3JlZGVudGlhbHMgPSBkZWZhdWx0cy53aXRoQ3JlZGVudGlhbHM7CiAgICAgICAgfQoKICAgICAgICAvLyBzZW5kIHJlcXVlc3QKICAgICAgICByZXR1cm4gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIGhlYWRlcnMpLnRoZW4odHJhbnNmb3JtUmVzcG9uc2UsIHRyYW5zZm9ybVJlc3BvbnNlKTsKICAgICAgfTsKCiAgICAgIHZhciBjaGFpbiA9IFtzZXJ2ZXJSZXF1ZXN0LCB1bmRlZmluZWRdOwogICAgICB2YXIgcHJvbWlzZSA9ICRxLndoZW4oY29uZmlnKTsKCiAgICAgIC8vIGFwcGx5IGludGVyY2VwdG9ycwogICAgICBmb3JFYWNoKHJldmVyc2VkSW50ZXJjZXB0b3JzLCBmdW5jdGlvbihpbnRlcmNlcHRvcikgewogICAgICAgIGlmIChpbnRlcmNlcHRvci5yZXF1ZXN0IHx8IGludGVyY2VwdG9yLnJlcXVlc3RFcnJvcikgewogICAgICAgICAgY2hhaW4udW5zaGlmdChpbnRlcmNlcHRvci5yZXF1ZXN0LCBpbnRlcmNlcHRvci5yZXF1ZXN0RXJyb3IpOwogICAgICAgIH0KICAgICAgICBpZiAoaW50ZXJjZXB0b3IucmVzcG9uc2UgfHwgaW50ZXJjZXB0b3IucmVzcG9uc2VFcnJvcikgewogICAgICAgICAgY2hhaW4ucHVzaChpbnRlcmNlcHRvci5yZXNwb25zZSwgaW50ZXJjZXB0b3IucmVzcG9uc2VFcnJvcik7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHdoaWxlKGNoYWluLmxlbmd0aCkgewogICAgICAgIHZhciB0aGVuRm4gPSBjaGFpbi5zaGlmdCgpOwogICAgICAgIHZhciByZWplY3RGbiA9IGNoYWluLnNoaWZ0KCk7CgogICAgICAgIHByb21pc2UgPSBwcm9taXNlLnRoZW4odGhlbkZuLCByZWplY3RGbik7CiAgICAgIH0KCiAgICAgIHByb21pc2Uuc3VjY2VzcyA9IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICBmbihyZXNwb25zZS5kYXRhLCByZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLmhlYWRlcnMsIGNvbmZpZyk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgIH07CgogICAgICBwcm9taXNlLmVycm9yID0gZnVuY3Rpb24oZm4pIHsKICAgICAgICBwcm9taXNlLnRoZW4obnVsbCwgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgIGZuKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgfTsKCiAgICAgIHJldHVybiBwcm9taXNlOwoKICAgICAgZnVuY3Rpb24gdHJhbnNmb3JtUmVzcG9uc2UocmVzcG9uc2UpIHsKICAgICAgICAvLyBtYWtlIGEgY29weSBzaW5jZSB0aGUgcmVzcG9uc2UgbXVzdCBiZSBjYWNoZWFibGUKICAgICAgICB2YXIgcmVzcCA9IGV4dGVuZCh7fSwgcmVzcG9uc2UpOwogICAgICAgIGlmICghcmVzcG9uc2UuZGF0YSkgewogICAgICAgICAgcmVzcC5kYXRhID0gcmVzcG9uc2UuZGF0YTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzcC5kYXRhID0gdHJhbnNmb3JtRGF0YShyZXNwb25zZS5kYXRhLCByZXNwb25zZS5oZWFkZXJzLCBjb25maWcudHJhbnNmb3JtUmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKGlzU3VjY2VzcyhyZXNwb25zZS5zdGF0dXMpKQogICAgICAgICAgPyByZXNwCiAgICAgICAgICA6ICRxLnJlamVjdChyZXNwKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gbWVyZ2VIZWFkZXJzKGNvbmZpZykgewogICAgICAgIHZhciBkZWZIZWFkZXJzID0gZGVmYXVsdHMuaGVhZGVycywKICAgICAgICAgICAgcmVxSGVhZGVycyA9IGV4dGVuZCh7fSwgY29uZmlnLmhlYWRlcnMpLAogICAgICAgICAgICBkZWZIZWFkZXJOYW1lLCBsb3dlcmNhc2VEZWZIZWFkZXJOYW1lLCByZXFIZWFkZXJOYW1lOwoKICAgICAgICBkZWZIZWFkZXJzID0gZXh0ZW5kKHt9LCBkZWZIZWFkZXJzLmNvbW1vbiwgZGVmSGVhZGVyc1tsb3dlcmNhc2UoY29uZmlnLm1ldGhvZCldKTsKCiAgICAgICAgLy8gdXNpbmcgZm9yLWluIGluc3RlYWQgb2YgZm9yRWFjaCB0byBhdm9pZCB1bmVjZXNzYXJ5IGl0ZXJhdGlvbiBhZnRlciBoZWFkZXIgaGFzIGJlZW4gZm91bmQKICAgICAgICBkZWZhdWx0SGVhZGVyc0l0ZXJhdGlvbjoKICAgICAgICBmb3IgKGRlZkhlYWRlck5hbWUgaW4gZGVmSGVhZGVycykgewogICAgICAgICAgbG93ZXJjYXNlRGVmSGVhZGVyTmFtZSA9IGxvd2VyY2FzZShkZWZIZWFkZXJOYW1lKTsKCiAgICAgICAgICBmb3IgKHJlcUhlYWRlck5hbWUgaW4gcmVxSGVhZGVycykgewogICAgICAgICAgICBpZiAobG93ZXJjYXNlKHJlcUhlYWRlck5hbWUpID09PSBsb3dlcmNhc2VEZWZIZWFkZXJOYW1lKSB7CiAgICAgICAgICAgICAgY29udGludWUgZGVmYXVsdEhlYWRlcnNJdGVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXFIZWFkZXJzW2RlZkhlYWRlck5hbWVdID0gZGVmSGVhZGVyc1tkZWZIZWFkZXJOYW1lXTsKICAgICAgICB9CgogICAgICAgIC8vIGV4ZWN1dGUgaWYgaGVhZGVyIHZhbHVlIGlzIGEgZnVuY3Rpb24gZm9yIG1lcmdlZCBoZWFkZXJzCiAgICAgICAgZXhlY0hlYWRlcnMocmVxSGVhZGVycyk7CiAgICAgICAgcmV0dXJuIHJlcUhlYWRlcnM7CgogICAgICAgIGZ1bmN0aW9uIGV4ZWNIZWFkZXJzKGhlYWRlcnMpIHsKICAgICAgICAgIHZhciBoZWFkZXJDb250ZW50OwoKICAgICAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24oaGVhZGVyRm4sIGhlYWRlcikgewogICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihoZWFkZXJGbikpIHsKICAgICAgICAgICAgICBoZWFkZXJDb250ZW50ID0gaGVhZGVyRm4oKTsKICAgICAgICAgICAgICBpZiAoaGVhZGVyQ29udGVudCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBoZWFkZXJzW2hlYWRlcl0gPSBoZWFkZXJDb250ZW50OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGUgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgJGh0dHAucGVuZGluZ1JlcXVlc3RzID0gW107CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaHR0cCNnZXQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBHRVRgIHJlcXVlc3QuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGh0dHAjZGVsZXRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgREVMRVRFYCByZXF1ZXN0LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRodHRwI2hlYWQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBIRUFEYCByZXF1ZXN0LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRodHRwI2pzb25wCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgSlNPTlBgIHJlcXVlc3QuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIFRoZSBuYW1lIG9mIHRoZSBjYWxsYmFjayBzaG91bGQgYmUgdGhlIHN0cmluZyBgSlNPTl9DQUxMQkFDS2AuCiAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgKi8KICAgIGNyZWF0ZVNob3J0TWV0aG9kcygnZ2V0JywgJ2RlbGV0ZScsICdoZWFkJywgJ2pzb25wJyk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaHR0cCNwb3N0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgUE9TVGAgcmVxdWVzdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICogQHBhcmFtIHsqfSBkYXRhIFJlcXVlc3QgY29udGVudAogICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaHR0cCNwdXQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBQVVRgIHJlcXVlc3QuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBSZXF1ZXN0IGNvbnRlbnQKICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAqLwoKICAgICAvKioKICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICogQG5hbWUgJGh0dHAjcGF0Y2gKICAgICAgKgogICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBQQVRDSGAgcmVxdWVzdC4KICAgICAgKgogICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICogQHBhcmFtIHsqfSBkYXRhIFJlcXVlc3QgY29udGVudAogICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICovCiAgICBjcmVhdGVTaG9ydE1ldGhvZHNXaXRoRGF0YSgncG9zdCcsICdwdXQnLCAncGF0Y2gnKTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICogQG5hbWUgJGh0dHAjZGVmYXVsdHMKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJ1bnRpbWUgZXF1aXZhbGVudCBvZiB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHNgIHByb3BlcnR5LiBBbGxvd3MgY29uZmlndXJhdGlvbiBvZgogICAgICAgICAqIGRlZmF1bHQgaGVhZGVycywgd2l0aENyZWRlbnRpYWxzIGFzIHdlbGwgYXMgcmVxdWVzdCBhbmQgcmVzcG9uc2UgdHJhbnNmb3JtYXRpb25zLgogICAgICAgICAqCiAgICAgICAgICogU2VlICJTZXR0aW5nIEhUVFAgSGVhZGVycyIgYW5kICJUcmFuc2Zvcm1pbmcgUmVxdWVzdHMgYW5kIFJlc3BvbnNlcyIgc2VjdGlvbnMgYWJvdmUuCiAgICAgICAgICovCiAgICAkaHR0cC5kZWZhdWx0cyA9IGRlZmF1bHRzOwoKCiAgICByZXR1cm4gJGh0dHA7CgoKICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kcyhuYW1lcykgewogICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24obmFtZSkgewogICAgICAgICRodHRwW25hbWVdID0gZnVuY3Rpb24odXJsLCBjb25maWcpIHsKICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgIG1ldGhvZDogbmFtZSwKICAgICAgICAgICAgdXJsOiB1cmwKICAgICAgICAgIH0pKTsKICAgICAgICB9OwogICAgICB9KTsKICAgIH0KCgogICAgZnVuY3Rpb24gY3JlYXRlU2hvcnRNZXRob2RzV2l0aERhdGEobmFtZSkgewogICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24obmFtZSkgewogICAgICAgICRodHRwW25hbWVdID0gZnVuY3Rpb24odXJsLCBkYXRhLCBjb25maWcpIHsKICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgIG1ldGhvZDogbmFtZSwKICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgIH0pKTsKICAgICAgICB9OwogICAgICB9KTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBNYWtlcyB0aGUgcmVxdWVzdC4KICAgICAqCiAgICAgKiAhISEgQUNDRVNTRVMgQ0xPU1VSRSBWQVJTOgogICAgICogJGh0dHBCYWNrZW5kLCBkZWZhdWx0cywgJGxvZywgJHJvb3RTY29wZSwgZGVmYXVsdENhY2hlLCAkaHR0cC5wZW5kaW5nUmVxdWVzdHMKICAgICAqLwogICAgZnVuY3Rpb24gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIHJlcUhlYWRlcnMpIHsKICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKSwKICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgY2FjaGUsCiAgICAgICAgICBjYWNoZWRSZXNwLAogICAgICAgICAgdXJsID0gYnVpbGRVcmwoY29uZmlnLnVybCwgY29uZmlnLnBhcmFtcyk7CgogICAgICAkaHR0cC5wZW5kaW5nUmVxdWVzdHMucHVzaChjb25maWcpOwogICAgICBwcm9taXNlLnRoZW4ocmVtb3ZlUGVuZGluZ1JlcSwgcmVtb3ZlUGVuZGluZ1JlcSk7CgoKICAgICAgaWYgKChjb25maWcuY2FjaGUgfHwgZGVmYXVsdHMuY2FjaGUpICYmIGNvbmZpZy5jYWNoZSAhPT0gZmFsc2UgJiYKICAgICAgICAgIChjb25maWcubWV0aG9kID09PSAnR0VUJyB8fCBjb25maWcubWV0aG9kID09PSAnSlNPTlAnKSkgewogICAgICAgIGNhY2hlID0gaXNPYmplY3QoY29uZmlnLmNhY2hlKSA/IGNvbmZpZy5jYWNoZQogICAgICAgICAgICAgIDogaXNPYmplY3QoZGVmYXVsdHMuY2FjaGUpID8gZGVmYXVsdHMuY2FjaGUKICAgICAgICAgICAgICA6IGRlZmF1bHRDYWNoZTsKICAgICAgfQoKICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgY2FjaGVkUmVzcCA9IGNhY2hlLmdldCh1cmwpOwogICAgICAgIGlmIChpc0RlZmluZWQoY2FjaGVkUmVzcCkpIHsKICAgICAgICAgIGlmIChpc1Byb21pc2VMaWtlKGNhY2hlZFJlc3ApKSB7CiAgICAgICAgICAgIC8vIGNhY2hlZCByZXF1ZXN0IGhhcyBhbHJlYWR5IGJlZW4gc2VudCwgYnV0IHRoZXJlIGlzIG5vIHJlc3BvbnNlIHlldAogICAgICAgICAgICBjYWNoZWRSZXNwLnRoZW4ocmVtb3ZlUGVuZGluZ1JlcSwgcmVtb3ZlUGVuZGluZ1JlcSk7CiAgICAgICAgICAgIHJldHVybiBjYWNoZWRSZXNwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gc2VydmluZyBmcm9tIGNhY2hlCiAgICAgICAgICAgIGlmIChpc0FycmF5KGNhY2hlZFJlc3ApKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZVByb21pc2UoY2FjaGVkUmVzcFsxXSwgY2FjaGVkUmVzcFswXSwgc2hhbGxvd0NvcHkoY2FjaGVkUmVzcFsyXSksIGNhY2hlZFJlc3BbM10pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc29sdmVQcm9taXNlKGNhY2hlZFJlc3AsIDIwMCwge30sICdPSycpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIHB1dCB0aGUgcHJvbWlzZSBmb3IgdGhlIG5vbi10cmFuc2Zvcm1lZCByZXNwb25zZSBpbnRvIGNhY2hlIGFzIGEgcGxhY2Vob2xkZXIKICAgICAgICAgIGNhY2hlLnB1dCh1cmwsIHByb21pc2UpOwogICAgICAgIH0KICAgICAgfQoKCiAgICAgIC8vIGlmIHdlIHdvbid0IGhhdmUgdGhlIHJlc3BvbnNlIGluIGNhY2hlLCBzZXQgdGhlIHhzcmYgaGVhZGVycyBhbmQKICAgICAgLy8gc2VuZCB0aGUgcmVxdWVzdCB0byB0aGUgYmFja2VuZAogICAgICBpZiAoaXNVbmRlZmluZWQoY2FjaGVkUmVzcCkpIHsKICAgICAgICB2YXIgeHNyZlZhbHVlID0gdXJsSXNTYW1lT3JpZ2luKGNvbmZpZy51cmwpCiAgICAgICAgICAgID8gJGJyb3dzZXIuY29va2llcygpW2NvbmZpZy54c3JmQ29va2llTmFtZSB8fCBkZWZhdWx0cy54c3JmQ29va2llTmFtZV0KICAgICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgICAgaWYgKHhzcmZWYWx1ZSkgewogICAgICAgICAgcmVxSGVhZGVyc1soY29uZmlnLnhzcmZIZWFkZXJOYW1lIHx8IGRlZmF1bHRzLnhzcmZIZWFkZXJOYW1lKV0gPSB4c3JmVmFsdWU7CiAgICAgICAgfQoKICAgICAgICAkaHR0cEJhY2tlbmQoY29uZmlnLm1ldGhvZCwgdXJsLCByZXFEYXRhLCBkb25lLCByZXFIZWFkZXJzLCBjb25maWcudGltZW91dCwKICAgICAgICAgICAgY29uZmlnLndpdGhDcmVkZW50aWFscywgY29uZmlnLnJlc3BvbnNlVHlwZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwcm9taXNlOwoKCiAgICAgIC8qKgogICAgICAgKiBDYWxsYmFjayByZWdpc3RlcmVkIHRvICRodHRwQmFja2VuZCgpOgogICAgICAgKiAgLSBjYWNoZXMgdGhlIHJlc3BvbnNlIGlmIGRlc2lyZWQKICAgICAgICogIC0gcmVzb2x2ZXMgdGhlIHJhdyAkaHR0cCBwcm9taXNlCiAgICAgICAqICAtIGNhbGxzICRhcHBseQogICAgICAgKi8KICAgICAgZnVuY3Rpb24gZG9uZShzdGF0dXMsIHJlc3BvbnNlLCBoZWFkZXJzU3RyaW5nLCBzdGF0dXNUZXh0KSB7CiAgICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgICBpZiAoaXNTdWNjZXNzKHN0YXR1cykpIHsKICAgICAgICAgICAgY2FjaGUucHV0KHVybCwgW3N0YXR1cywgcmVzcG9uc2UsIHBhcnNlSGVhZGVycyhoZWFkZXJzU3RyaW5nKSwgc3RhdHVzVGV4dF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gcmVtb3ZlIHByb21pc2UgZnJvbSB0aGUgY2FjaGUKICAgICAgICAgICAgY2FjaGUucmVtb3ZlKHVybCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZXNvbHZlSHR0cFByb21pc2UoKSB7CiAgICAgICAgICByZXNvbHZlUHJvbWlzZShyZXNwb25zZSwgc3RhdHVzLCBoZWFkZXJzU3RyaW5nLCBzdGF0dXNUZXh0KTsKICAgICAgICB9CgogICAgICAgIGlmICh1c2VBcHBseUFzeW5jKSB7CiAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseUFzeW5jKHJlc29sdmVIdHRwUHJvbWlzZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc29sdmVIdHRwUHJvbWlzZSgpOwogICAgICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UpICRyb290U2NvcGUuJGFwcGx5KCk7CiAgICAgICAgfQogICAgICB9CgoKICAgICAgLyoqCiAgICAgICAqIFJlc29sdmVzIHRoZSByYXcgJGh0dHAgcHJvbWlzZS4KICAgICAgICovCiAgICAgIGZ1bmN0aW9uIHJlc29sdmVQcm9taXNlKHJlc3BvbnNlLCBzdGF0dXMsIGhlYWRlcnMsIHN0YXR1c1RleHQpIHsKICAgICAgICAvLyBub3JtYWxpemUgaW50ZXJuYWwgc3RhdHVzZXMgdG8gMAogICAgICAgIHN0YXR1cyA9IE1hdGgubWF4KHN0YXR1cywgMCk7CgogICAgICAgIChpc1N1Y2Nlc3Moc3RhdHVzKSA/IGRlZmVycmVkLnJlc29sdmUgOiBkZWZlcnJlZC5yZWplY3QpKHsKICAgICAgICAgIGRhdGE6IHJlc3BvbnNlLAogICAgICAgICAgc3RhdHVzOiBzdGF0dXMsCiAgICAgICAgICBoZWFkZXJzOiBoZWFkZXJzR2V0dGVyKGhlYWRlcnMpLAogICAgICAgICAgY29uZmlnOiBjb25maWcsCiAgICAgICAgICBzdGF0dXNUZXh0IDogc3RhdHVzVGV4dAogICAgICAgIH0pOwogICAgICB9CgoKICAgICAgZnVuY3Rpb24gcmVtb3ZlUGVuZGluZ1JlcSgpIHsKICAgICAgICB2YXIgaWR4ID0gJGh0dHAucGVuZGluZ1JlcXVlc3RzLmluZGV4T2YoY29uZmlnKTsKICAgICAgICBpZiAoaWR4ICE9PSAtMSkgJGh0dHAucGVuZGluZ1JlcXVlc3RzLnNwbGljZShpZHgsIDEpOwogICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIGJ1aWxkVXJsKHVybCwgcGFyYW1zKSB7CiAgICAgIGlmICghcGFyYW1zKSByZXR1cm4gdXJsOwogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgZm9yRWFjaFNvcnRlZChwYXJhbXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgaXNVbmRlZmluZWQodmFsdWUpKSByZXR1cm47CiAgICAgICAgaWYgKCFpc0FycmF5KHZhbHVlKSkgdmFsdWUgPSBbdmFsdWVdOwoKICAgICAgICBmb3JFYWNoKHZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICBpZiAoaXNPYmplY3QodikpIHsKICAgICAgICAgICAgaWYgKGlzRGF0ZSh2KSl7CiAgICAgICAgICAgICAgdiA9IHYudG9JU09TdHJpbmcoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2ID0gdG9Kc29uKHYpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwYXJ0cy5wdXNoKGVuY29kZVVyaVF1ZXJ5KGtleSkgKyAnPScgKwogICAgICAgICAgICAgICAgICAgICBlbmNvZGVVcmlRdWVyeSh2KSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICBpZihwYXJ0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgdXJsICs9ICgodXJsLmluZGV4T2YoJz8nKSA9PSAtMSkgPyAnPycgOiAnJicpICsgcGFydHMuam9pbignJicpOwogICAgICB9CiAgICAgIHJldHVybiB1cmw7CiAgICB9CiAgfV07Cn0KCmZ1bmN0aW9uIGNyZWF0ZVhocigpIHsKICAgIHJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCk7Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkaHR0cEJhY2tlbmQKICogQHJlcXVpcmVzICR3aW5kb3cKICogQHJlcXVpcmVzICRkb2N1bWVudAogKgogKiBAZGVzY3JpcHRpb24KICogSFRUUCBiYWNrZW5kIHVzZWQgYnkgdGhlIHtAbGluayBuZy4kaHR0cCBzZXJ2aWNlfSB0aGF0IGRlbGVnYXRlcyB0bwogKiBYTUxIdHRwUmVxdWVzdCBvYmplY3Qgb3IgSlNPTlAgYW5kIGRlYWxzIHdpdGggYnJvd3NlciBpbmNvbXBhdGliaWxpdGllcy4KICoKICogWW91IHNob3VsZCBuZXZlciBuZWVkIHRvIHVzZSB0aGlzIHNlcnZpY2UgZGlyZWN0bHksIGluc3RlYWQgdXNlIHRoZSBoaWdoZXItbGV2ZWwgYWJzdHJhY3Rpb25zOgogKiB7QGxpbmsgbmcuJGh0dHAgJGh0dHB9IG9yIHtAbGluayBuZ1Jlc291cmNlLiRyZXNvdXJjZSAkcmVzb3VyY2V9LgogKgogKiBEdXJpbmcgdGVzdGluZyB0aGlzIGltcGxlbWVudGF0aW9uIGlzIHN3YXBwZWQgd2l0aCB7QGxpbmsgbmdNb2NrLiRodHRwQmFja2VuZCBtb2NrCiAqICRodHRwQmFja2VuZH0gd2hpY2ggY2FuIGJlIHRyYWluZWQgd2l0aCByZXNwb25zZXMuCiAqLwpmdW5jdGlvbiAkSHR0cEJhY2tlbmRQcm92aWRlcigpIHsKICB0aGlzLiRnZXQgPSBbJyRicm93c2VyJywgJyR3aW5kb3cnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24oJGJyb3dzZXIsICR3aW5kb3csICRkb2N1bWVudCkgewogICAgcmV0dXJuIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBjcmVhdGVYaHIsICRicm93c2VyLmRlZmVyLCAkd2luZG93LmFuZ3VsYXIuY2FsbGJhY2tzLCAkZG9jdW1lbnRbMF0pOwogIH1dOwp9CgpmdW5jdGlvbiBjcmVhdGVIdHRwQmFja2VuZCgkYnJvd3NlciwgY3JlYXRlWGhyLCAkYnJvd3NlckRlZmVyLCBjYWxsYmFja3MsIHJhd0RvY3VtZW50KSB7CiAgLy8gVE9ETyh2b2p0YSk6IGZpeCB0aGUgc2lnbmF0dXJlCiAgcmV0dXJuIGZ1bmN0aW9uKG1ldGhvZCwgdXJsLCBwb3N0LCBjYWxsYmFjaywgaGVhZGVycywgdGltZW91dCwgd2l0aENyZWRlbnRpYWxzLCByZXNwb25zZVR5cGUpIHsKICAgICRicm93c2VyLiQkaW5jT3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQoKTsKICAgIHVybCA9IHVybCB8fCAkYnJvd3Nlci51cmwoKTsKCiAgICBpZiAobG93ZXJjYXNlKG1ldGhvZCkgPT0gJ2pzb25wJykgewogICAgICB2YXIgY2FsbGJhY2tJZCA9ICdfJyArIChjYWxsYmFja3MuY291bnRlcisrKS50b1N0cmluZygzNik7CiAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICBjYWxsYmFja3NbY2FsbGJhY2tJZF0uZGF0YSA9IGRhdGE7CiAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmNhbGxlZCA9IHRydWU7CiAgICAgIH07CgogICAgICB2YXIganNvbnBEb25lID0ganNvbnBSZXEodXJsLnJlcGxhY2UoJ0pTT05fQ0FMTEJBQ0snLCAnYW5ndWxhci5jYWxsYmFja3MuJyArIGNhbGxiYWNrSWQpLAogICAgICAgICAgY2FsbGJhY2tJZCwgZnVuY3Rpb24oc3RhdHVzLCB0ZXh0KSB7CiAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLCBzdGF0dXMsIGNhbGxiYWNrc1tjYWxsYmFja0lkXS5kYXRhLCAiIiwgdGV4dCk7CiAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdID0gbm9vcDsKICAgICAgfSk7CiAgICB9IGVsc2UgewoKICAgICAgdmFyIHhociA9IGNyZWF0ZVhocigpOwoKICAgICAgeGhyLm9wZW4obWV0aG9kLCB1cmwsIHRydWUpOwogICAgICBmb3JFYWNoKGhlYWRlcnMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgeGhyLm9ubG9hZCA9IGZ1bmN0aW9uIHJlcXVlc3RMb2FkZWQoKSB7CiAgICAgICAgdmFyIHN0YXR1c1RleHQgPSB4aHIuc3RhdHVzVGV4dCB8fCAnJzsKCiAgICAgICAgLy8gcmVzcG9uc2VUZXh0IGlzIHRoZSBvbGQtc2Nob29sIHdheSBvZiByZXRyaWV2aW5nIHJlc3BvbnNlIChzdXBwb3J0ZWQgYnkgSUU4ICYgOSkKICAgICAgICAvLyByZXNwb25zZS9yZXNwb25zZVR5cGUgcHJvcGVydGllcyB3ZXJlIGludHJvZHVjZWQgaW4gWEhSIExldmVsMiBzcGVjIChzdXBwb3J0ZWQgYnkgSUUxMCkKICAgICAgICB2YXIgcmVzcG9uc2UgPSAoJ3Jlc3BvbnNlJyBpbiB4aHIpID8geGhyLnJlc3BvbnNlIDogeGhyLnJlc3BvbnNlVGV4dDsKCiAgICAgICAgLy8gbm9ybWFsaXplIElFOSBidWcgKGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzE0NTApCiAgICAgICAgdmFyIHN0YXR1cyA9IHhoci5zdGF0dXMgPT09IDEyMjMgPyAyMDQgOiB4aHIuc3RhdHVzOwoKICAgICAgICAvLyBmaXggc3RhdHVzIGNvZGUgd2hlbiBpdCBpcyAwICgwIHN0YXR1cyBpcyB1bmRvY3VtZW50ZWQpLgogICAgICAgIC8vIE9jY3VycyB3aGVuIGFjY2Vzc2luZyBmaWxlIHJlc291cmNlcyBvciBvbiBBbmRyb2lkIDQuMSBzdG9jayBicm93c2VyCiAgICAgICAgLy8gd2hpbGUgcmV0cmlldmluZyBmaWxlcyBmcm9tIGFwcGxpY2F0aW9uIGNhY2hlLgogICAgICAgIGlmIChzdGF0dXMgPT09IDApIHsKICAgICAgICAgIHN0YXR1cyA9IHJlc3BvbnNlID8gMjAwIDogdXJsUmVzb2x2ZSh1cmwpLnByb3RvY29sID09ICdmaWxlJyA/IDQwNCA6IDA7CiAgICAgICAgfQoKICAgICAgICBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssCiAgICAgICAgICAgIHN0YXR1cywKICAgICAgICAgICAgcmVzcG9uc2UsCiAgICAgICAgICAgIHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKSwKICAgICAgICAgICAgc3RhdHVzVGV4dCk7CiAgICAgIH07CgogICAgICB2YXIgcmVxdWVzdEVycm9yID0gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIFRoZSByZXNwb25zZSBpcyBhbHdheXMgZW1wdHkKICAgICAgICAvLyBTZWUgaHR0cHM6Ly94aHIuc3BlYy53aGF0d2cub3JnLyNyZXF1ZXN0LWVycm9yLXN0ZXBzIGFuZCBodHRwczovL2ZldGNoLnNwZWMud2hhdHdnLm9yZy8jY29uY2VwdC1uZXR3b3JrLWVycm9yCiAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLCAtMSwgbnVsbCwgbnVsbCwgJycpOwogICAgICB9OwoKICAgICAgeGhyLm9uZXJyb3IgPSByZXF1ZXN0RXJyb3I7CiAgICAgIHhoci5vbmFib3J0ID0gcmVxdWVzdEVycm9yOwoKICAgICAgaWYgKHdpdGhDcmVkZW50aWFscykgewogICAgICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwogICAgICB9CgogICAgICBpZiAocmVzcG9uc2VUeXBlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHhoci5yZXNwb25zZVR5cGUgPSByZXNwb25zZVR5cGU7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgLy8gV2ViS2l0IGFkZGVkIHN1cHBvcnQgZm9yIHRoZSBqc29uIHJlc3BvbnNlVHlwZSB2YWx1ZSBvbiAwOS8wMy8yMDEzCiAgICAgICAgICAvLyBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NzM2NDguIFZlcnNpb25zIG9mIFNhZmFyaSBwcmlvciB0byA3IGFyZQogICAgICAgICAgLy8ga25vd24gdG8gdGhyb3cgd2hlbiBzZXR0aW5nIHRoZSB2YWx1ZSAianNvbiIgYXMgdGhlIHJlc3BvbnNlIHR5cGUuIE90aGVyIG9sZGVyCiAgICAgICAgICAvLyBicm93c2VycyBpbXBsZW1lbnRpbmcgdGhlIHJlc3BvbnNlVHlwZQogICAgICAgICAgLy8KICAgICAgICAgIC8vIFRoZSBqc29uIHJlc3BvbnNlIHR5cGUgY2FuIGJlIGlnbm9yZWQgaWYgbm90IHN1cHBvcnRlZCwgYmVjYXVzZSBKU09OIHBheWxvYWRzIGFyZQogICAgICAgICAgLy8gcGFyc2VkIG9uIHRoZSBjbGllbnQtc2lkZSByZWdhcmRsZXNzLgogICAgICAgICAgaWYgKHJlc3BvbnNlVHlwZSAhPT0gJ2pzb24nKSB7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB4aHIuc2VuZChwb3N0IHx8IG51bGwpOwogICAgfQoKICAgIGlmICh0aW1lb3V0ID4gMCkgewogICAgICB2YXIgdGltZW91dElkID0gJGJyb3dzZXJEZWZlcih0aW1lb3V0UmVxdWVzdCwgdGltZW91dCk7CiAgICB9IGVsc2UgaWYgKGlzUHJvbWlzZUxpa2UodGltZW91dCkpIHsKICAgICAgdGltZW91dC50aGVuKHRpbWVvdXRSZXF1ZXN0KTsKICAgIH0KCgogICAgZnVuY3Rpb24gdGltZW91dFJlcXVlc3QoKSB7CiAgICAgIGpzb25wRG9uZSAmJiBqc29ucERvbmUoKTsKICAgICAgeGhyICYmIHhoci5hYm9ydCgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgc3RhdHVzLCByZXNwb25zZSwgaGVhZGVyc1N0cmluZywgc3RhdHVzVGV4dCkgewogICAgICAvLyBjYW5jZWwgdGltZW91dCBhbmQgc3Vic2VxdWVudCB0aW1lb3V0IHByb21pc2UgcmVzb2x1dGlvbgogICAgICB0aW1lb3V0SWQgJiYgJGJyb3dzZXJEZWZlci5jYW5jZWwodGltZW91dElkKTsKICAgICAganNvbnBEb25lID0geGhyID0gbnVsbDsKCiAgICAgIGNhbGxiYWNrKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcsIHN0YXR1c1RleHQpOwogICAgICAkYnJvd3Nlci4kJGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KG5vb3ApOwogICAgfQogIH07CgogIGZ1bmN0aW9uIGpzb25wUmVxKHVybCwgY2FsbGJhY2tJZCwgZG9uZSkgewogICAgLy8gd2UgY2FuJ3QgdXNlIGpRdWVyeS9qcUxpdGUgaGVyZSBiZWNhdXNlIGpRdWVyeSBkb2VzIGNyYXp5IHNoaXQgd2l0aCBzY3JpcHQgZWxlbWVudHMsIGUuZy46CiAgICAvLyAtIGZldGNoZXMgbG9jYWwgc2NyaXB0cyB2aWEgWEhSIGFuZCBldmFscyB0aGVtCiAgICAvLyAtIGFkZHMgYW5kIGltbWVkaWF0ZWx5IHJlbW92ZXMgc2NyaXB0IGVsZW1lbnRzIGZyb20gdGhlIGRvY3VtZW50CiAgICB2YXIgc2NyaXB0ID0gcmF3RG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0JyksIGNhbGxiYWNrID0gbnVsbDsKICAgIHNjcmlwdC50eXBlID0gInRleHQvamF2YXNjcmlwdCI7CiAgICBzY3JpcHQuc3JjID0gdXJsOwogICAgc2NyaXB0LmFzeW5jID0gdHJ1ZTsKCiAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihzY3JpcHQsICJsb2FkIiwgY2FsbGJhY2spOwogICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oc2NyaXB0LCAiZXJyb3IiLCBjYWxsYmFjayk7CiAgICAgIHJhd0RvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgc2NyaXB0ID0gbnVsbDsKICAgICAgdmFyIHN0YXR1cyA9IC0xOwogICAgICB2YXIgdGV4dCA9ICJ1bmtub3duIjsKCiAgICAgIGlmIChldmVudCkgewogICAgICAgIGlmIChldmVudC50eXBlID09PSAibG9hZCIgJiYgIWNhbGxiYWNrc1tjYWxsYmFja0lkXS5jYWxsZWQpIHsKICAgICAgICAgIGV2ZW50ID0geyB0eXBlOiAiZXJyb3IiIH07CiAgICAgICAgfQogICAgICAgIHRleHQgPSBldmVudC50eXBlOwogICAgICAgIHN0YXR1cyA9IGV2ZW50LnR5cGUgPT09ICJlcnJvciIgPyA0MDQgOiAyMDA7CiAgICAgIH0KCiAgICAgIGlmIChkb25lKSB7CiAgICAgICAgZG9uZShzdGF0dXMsIHRleHQpOwogICAgICB9CiAgICB9OwoKICAgIGFkZEV2ZW50TGlzdGVuZXJGbihzY3JpcHQsICJsb2FkIiwgY2FsbGJhY2spOwogICAgYWRkRXZlbnRMaXN0ZW5lckZuKHNjcmlwdCwgImVycm9yIiwgY2FsbGJhY2spOwogICAgcmF3RG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpOwogICAgcmV0dXJuIGNhbGxiYWNrOwogIH0KfQoKdmFyICRpbnRlcnBvbGF0ZU1pbkVyciA9IG1pbkVycignJGludGVycG9sYXRlJyk7CgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRpbnRlcnBvbGF0ZVByb3ZpZGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBVc2VkIGZvciBjb25maWd1cmluZyB0aGUgaW50ZXJwb2xhdGlvbiBtYXJrdXAuIERlZmF1bHRzIHRvIGB7e2AgYW5kIGB9fWAuCiAqCiAqIEBleGFtcGxlCjxleGFtcGxlIG1vZHVsZT0iY3VzdG9tSW50ZXJwb2xhdGlvbkFwcCI+CjxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgo8c2NyaXB0PgogIHZhciBjdXN0b21JbnRlcnBvbGF0aW9uQXBwID0gYW5ndWxhci5tb2R1bGUoJ2N1c3RvbUludGVycG9sYXRpb25BcHAnLCBbXSk7CgogIGN1c3RvbUludGVycG9sYXRpb25BcHAuY29uZmlnKGZ1bmN0aW9uKCRpbnRlcnBvbGF0ZVByb3ZpZGVyKSB7CiAgICAkaW50ZXJwb2xhdGVQcm92aWRlci5zdGFydFN5bWJvbCgnLy8nKTsKICAgICRpbnRlcnBvbGF0ZVByb3ZpZGVyLmVuZFN5bWJvbCgnLy8nKTsKICB9KTsKCgogIGN1c3RvbUludGVycG9sYXRpb25BcHAuY29udHJvbGxlcignRGVtb0NvbnRyb2xsZXInLCBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5sYWJlbCA9ICJUaGlzIGJpbmRpbmcgaXMgYnJvdWdodCB5b3UgYnkgLy8gaW50ZXJwb2xhdGlvbiBzeW1ib2xzLiI7CiAgfSk7Cjwvc2NyaXB0Pgo8ZGl2IG5nLWFwcD0iQXBwIiBuZy1jb250cm9sbGVyPSJEZW1vQ29udHJvbGxlciBhcyBkZW1vIj4KICAgIC8vZGVtby5sYWJlbC8vCjwvZGl2Pgo8L2ZpbGU+CjxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogIGl0KCdzaG91bGQgaW50ZXJwb2xhdGUgYmluZGluZyB3aXRoIGN1c3RvbSBzeW1ib2xzJywgZnVuY3Rpb24oKSB7CiAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdkZW1vLmxhYmVsJykpLmdldFRleHQoKSkudG9CZSgnVGhpcyBiaW5kaW5nIGlzIGJyb3VnaHQgeW91IGJ5IC8vIGludGVycG9sYXRpb24gc3ltYm9scy4nKTsKICB9KTsKPC9maWxlPgo8L2V4YW1wbGU+CiAqLwpmdW5jdGlvbiAkSW50ZXJwb2xhdGVQcm92aWRlcigpIHsKICB2YXIgc3RhcnRTeW1ib2wgPSAne3snOwogIHZhciBlbmRTeW1ib2wgPSAnfX0nOwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2wKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTeW1ib2wgdG8gZGVub3RlIHN0YXJ0IG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB7e2AuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIG5ldyB2YWx1ZSB0byBzZXQgdGhlIHN0YXJ0aW5nIHN5bWJvbCB0by4KICAgKiBAcmV0dXJucyB7c3RyaW5nfHNlbGZ9IFJldHVybnMgdGhlIHN5bWJvbCB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMgc2V0dGVyLgogICAqLwogIHRoaXMuc3RhcnRTeW1ib2wgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICBpZiAodmFsdWUpIHsKICAgICAgc3RhcnRTeW1ib2wgPSB2YWx1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gc3RhcnRTeW1ib2w7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpbnRlcnBvbGF0ZVByb3ZpZGVyI2VuZFN5bWJvbAogICAqIEBkZXNjcmlwdGlvbgogICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIGVuZCBvZiBleHByZXNzaW9uIGluIHRoZSBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBEZWZhdWx0cyB0byBgfX1gLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSB2YWx1ZSBuZXcgdmFsdWUgdG8gc2V0IHRoZSBlbmRpbmcgc3ltYm9sIHRvLgogICAqIEByZXR1cm5zIHtzdHJpbmd8c2VsZn0gUmV0dXJucyB0aGUgc3ltYm9sIHdoZW4gdXNlZCBhcyBnZXR0ZXIgYW5kIHNlbGYgaWYgdXNlZCBhcyBzZXR0ZXIuCiAgICovCiAgdGhpcy5lbmRTeW1ib2wgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICBpZiAodmFsdWUpIHsKICAgICAgZW5kU3ltYm9sID0gdmFsdWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGVuZFN5bWJvbDsKICAgIH0KICB9OwoKCiAgdGhpcy4kZ2V0ID0gWyckcGFyc2UnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJHNjZScsIGZ1bmN0aW9uKCRwYXJzZSwgJGV4Y2VwdGlvbkhhbmRsZXIsICRzY2UpIHsKICAgIHZhciBzdGFydFN5bWJvbExlbmd0aCA9IHN0YXJ0U3ltYm9sLmxlbmd0aCwKICAgICAgICBlbmRTeW1ib2xMZW5ndGggPSBlbmRTeW1ib2wubGVuZ3RoLAogICAgICAgIGVzY2FwZWRTdGFydFJlZ2V4cCA9IG5ldyBSZWdFeHAoc3RhcnRTeW1ib2wucmVwbGFjZSgvLi9nLCBlc2NhcGUpLCAnZycpLAogICAgICAgIGVzY2FwZWRFbmRSZWdleHAgPSBuZXcgUmVnRXhwKGVuZFN5bWJvbC5yZXBsYWNlKC8uL2csIGVzY2FwZSksICdnJyk7CgogICAgZnVuY3Rpb24gZXNjYXBlKGNoKSB7CiAgICAgIHJldHVybiAnXFxcXFxcJyArIGNoOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAqIEBuYW1lICRpbnRlcnBvbGF0ZQogICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAcmVxdWlyZXMgJHBhcnNlCiAgICAgKiBAcmVxdWlyZXMgJHNjZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIENvbXBpbGVzIGEgc3RyaW5nIHdpdGggbWFya3VwIGludG8gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4gVGhpcyBzZXJ2aWNlIGlzIHVzZWQgYnkgdGhlCiAgICAgKiBIVE1MIHtAbGluayBuZy4kY29tcGlsZSAkY29tcGlsZX0gc2VydmljZSBmb3IgZGF0YSBiaW5kaW5nLiBTZWUKICAgICAqIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciAkaW50ZXJwb2xhdGVQcm92aWRlcn0gZm9yIGNvbmZpZ3VyaW5nIHRoZQogICAgICogaW50ZXJwb2xhdGlvbiBtYXJrdXAuCiAgICAgKgogICAgICoKICAgICAqIGBgYGpzCiAgICAgKiAgIHZhciAkaW50ZXJwb2xhdGUgPSAuLi47IC8vIGluamVjdGVkCiAgICAgKiAgIHZhciBleHAgPSAkaW50ZXJwb2xhdGUoJ0hlbGxvIHt7bmFtZSB8IHVwcGVyY2FzZX19IScpOwogICAgICogICBleHBlY3QoZXhwKHtuYW1lOidBbmd1bGFyJ30pLnRvRXF1YWwoJ0hlbGxvIEFOR1VMQVIhJyk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBgJGludGVycG9sYXRlYCB0YWtlcyBhbiBvcHRpb25hbCBmb3VydGggYXJndW1lbnQsIGBhbGxPck5vdGhpbmdgLiBJZiBgYWxsT3JOb3RoaW5nYCBpcwogICAgICogYHRydWVgLCB0aGUgaW50ZXJwb2xhdGlvbiBmdW5jdGlvbiB3aWxsIHJldHVybiBgdW5kZWZpbmVkYCB1bmxlc3MgYWxsIGVtYmVkZGVkIGV4cHJlc3Npb25zCiAgICAgKiBldmFsdWF0ZSB0byBhIHZhbHVlIG90aGVyIHRoYW4gYHVuZGVmaW5lZGAuCiAgICAgKgogICAgICogYGBganMKICAgICAqICAgdmFyICRpbnRlcnBvbGF0ZSA9IC4uLjsgLy8gaW5qZWN0ZWQKICAgICAqICAgdmFyIGNvbnRleHQgPSB7Z3JlZXRpbmc6ICdIZWxsbycsIG5hbWU6IHVuZGVmaW5lZCB9OwogICAgICoKICAgICAqICAgLy8gZGVmYXVsdCAiZm9yZ2l2aW5nIiBtb2RlCiAgICAgKiAgIHZhciBleHAgPSAkaW50ZXJwb2xhdGUoJ3t7Z3JlZXRpbmd9fSB7e25hbWV9fSEnKTsKICAgICAqICAgZXhwZWN0KGV4cChjb250ZXh0KSkudG9FcXVhbCgnSGVsbG8gIScpOwogICAgICoKICAgICAqICAgLy8gImFsbE9yTm90aGluZyIgbW9kZQogICAgICogICBleHAgPSAkaW50ZXJwb2xhdGUoJ3t7Z3JlZXRpbmd9fSB7e25hbWV9fSEnLCBmYWxzZSwgbnVsbCwgdHJ1ZSk7CiAgICAgKiAgIGV4cGVjdChleHAoY29udGV4dCkpLnRvQmVVbmRlZmluZWQoKTsKICAgICAqICAgY29udGV4dC5uYW1lID0gJ0FuZ3VsYXInOwogICAgICogICBleHBlY3QoZXhwKGNvbnRleHQpKS50b0VxdWFsKCdIZWxsbyBBbmd1bGFyIScpOwogICAgICogYGBgCiAgICAgKgogICAgICogYGFsbE9yTm90aGluZ2AgaXMgdXNlZnVsIGZvciBpbnRlcnBvbGF0aW5nIFVSTHMuIGBuZ1NyY2AgYW5kIGBuZ1NyY3NldGAgdXNlIHRoaXMgYmVoYXZpb3IuCiAgICAgKgogICAgICogIyMjI0VzY2FwZWQgSW50ZXJwb2xhdGlvbgogICAgICogJGludGVycG9sYXRlIHByb3ZpZGVzIGEgbWVjaGFuaXNtIGZvciBlc2NhcGluZyBpbnRlcnBvbGF0aW9uIG1hcmtlcnMuIFN0YXJ0IGFuZCBlbmQgbWFya2VycwogICAgICogY2FuIGJlIGVzY2FwZWQgYnkgcHJlY2VkaW5nIGVhY2ggb2YgdGhlaXIgY2hhcmFjdGVycyB3aXRoIGEgUkVWRVJTRSBTT0xJRFVTIFUrMDA1QyAoYmFja3NsYXNoKS4KICAgICAqIEl0IHdpbGwgYmUgcmVuZGVyZWQgYXMgYSByZWd1bGFyIHN0YXJ0L2VuZCBtYXJrZXIsIGFuZCB3aWxsIG5vdCBiZSBpbnRlcnByZXRlZCBhcyBhbiBleHByZXNzaW9uCiAgICAgKiBvciBiaW5kaW5nLgogICAgICoKICAgICAqIFRoaXMgZW5hYmxlcyB3ZWItc2VydmVycyB0byBwcmV2ZW50IHNjcmlwdCBpbmplY3Rpb24gYXR0YWNrcyBhbmQgZGVmYWNpbmcgYXR0YWNrcywgdG8gc29tZQogICAgICogZGVncmVlLCB3aGlsZSBhbHNvIGVuYWJsaW5nIGNvZGUgZXhhbXBsZXMgdG8gd29yayB3aXRob3V0IHJlbHlpbmcgb24gdGhlCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nTm9uQmluZGFibGUgbmdOb25CaW5kYWJsZX0gZGlyZWN0aXZlLgogICAgICoKICAgICAqICoqRm9yIHNlY3VyaXR5IHB1cnBvc2VzLCBpdCBpcyBzdHJvbmdseSBlbmNvdXJhZ2VkIHRoYXQgd2ViIHNlcnZlcnMgZXNjYXBlIHVzZXItc3VwcGxpZWQgZGF0YSwKICAgICAqIHJlcGxhY2luZyBhbmdsZSBicmFja2V0cyAoJmx0OywgJmd0Oykgd2l0aCAmYW1wO2x0OyBhbmQgJmFtcDtndDsgcmVzcGVjdGl2ZWx5LCBhbmQgcmVwbGFjaW5nIGFsbAogICAgICogaW50ZXJwb2xhdGlvbiBzdGFydC9lbmQgbWFya2VycyB3aXRoIHRoZWlyIGVzY2FwZWQgY291bnRlcnBhcnRzLioqCiAgICAgKgogICAgICogRXNjYXBlZCBpbnRlcnBvbGF0aW9uIG1hcmtlcnMgYXJlIG9ubHkgcmVwbGFjZWQgd2l0aCB0aGUgYWN0dWFsIGludGVycG9sYXRpb24gbWFya2VycyBpbiByZW5kZXJlZAogICAgICogb3V0cHV0IHdoZW4gdGhlICRpbnRlcnBvbGF0ZSBzZXJ2aWNlIHByb2Nlc3NlcyB0aGUgdGV4dC4gU28sIGZvciBIVE1MIGVsZW1lbnRzIGludGVycG9sYXRlZAogICAgICogYnkge0BsaW5rIG5nLiRjb21waWxlICRjb21waWxlfSwgb3Igb3RoZXJ3aXNlIGludGVycG9sYXRlZCB3aXRoIHRoZSBgbXVzdEhhdmVFeHByZXNzaW9uYCBwYXJhbWV0ZXIKICAgICAqIHNldCB0byBgdHJ1ZWAsIHRoZSBpbnRlcnBvbGF0ZWQgdGV4dCBtdXN0IGNvbnRhaW4gYW4gdW5lc2NhcGVkIGludGVycG9sYXRpb24gZXhwcmVzc2lvbi4gQXMgc3VjaCwKICAgICAqIHRoaXMgaXMgdHlwaWNhbGx5IHVzZWZ1bCBvbmx5IHdoZW4gdXNlci1kYXRhIGlzIHVzZWQgaW4gcmVuZGVyaW5nIGEgdGVtcGxhdGUgZnJvbSB0aGUgc2VydmVyLCBvcgogICAgICogd2hlbiBvdGhlcndpc2UgdW50cnVzdGVkIGRhdGEgaXMgdXNlZCBieSBhIGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKiA8ZXhhbXBsZT4KICAgICAqICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAqICAgIDxkaXYgbmctaW5pdD0idXNlcm5hbWU9J0EgdXNlciciPgogICAgICogICAgICA8cCBuZy1pbml0PSJhcHB0aXRsZT0nRXNjYXBpbmcgZGVtbyciPnt7YXBwdGl0bGV9fTogXHtceyB1c2VybmFtZSA9ICJkZWZhY2VkIHZhbHVlIjsgXH1cfQogICAgICogICAgICAgIDwvcD4KICAgICAqICAgICAgPHA+PHN0cm9uZz57e3VzZXJuYW1lfX08L3N0cm9uZz4gYXR0ZW1wdHMgdG8gaW5qZWN0IGNvZGUgd2hpY2ggd2lsbCBkZWZhY2UgdGhlCiAgICAgKiAgICAgICAgYXBwbGljYXRpb24sIGJ1dCBmYWlscyB0byBhY2NvbXBsaXNoIHRoZWlyIHRhc2ssIGJlY2F1c2UgdGhlIHNlcnZlciBoYXMgY29ycmVjdGx5CiAgICAgKiAgICAgICAgZXNjYXBlZCB0aGUgaW50ZXJwb2xhdGlvbiBzdGFydC9lbmQgbWFya2VycyB3aXRoIFJFVkVSU0UgU09MSURVUyBVKzAwNUMgKGJhY2tzbGFzaCkKICAgICAqICAgICAgICBjaGFyYWN0ZXJzLjwvcD4KICAgICAqICAgICAgPHA+SW5zdGVhZCwgdGhlIHJlc3VsdCBvZiB0aGUgYXR0ZW1wdGVkIHNjcmlwdCBpbmplY3Rpb24gaXMgdmlzaWJsZSwgYW5kIGNhbiBiZSByZW1vdmVkCiAgICAgKiAgICAgICAgZnJvbSB0aGUgZGF0YWJhc2UgYnkgYW4gYWRtaW5pc3RyYXRvci48L3A+CiAgICAgKiAgICA8L2Rpdj4KICAgICAqICA8L2ZpbGU+CiAgICAgKiA8L2V4YW1wbGU+CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQgVGhlIHRleHQgd2l0aCBtYXJrdXAgdG8gaW50ZXJwb2xhdGUuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBtdXN0SGF2ZUV4cHJlc3Npb24gaWYgc2V0IHRvIHRydWUgdGhlbiB0aGUgaW50ZXJwb2xhdGlvbiBzdHJpbmcgbXVzdCBoYXZlCiAgICAgKiAgICBlbWJlZGRlZCBleHByZXNzaW9uIGluIG9yZGVyIHRvIHJldHVybiBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLiBTdHJpbmdzIHdpdGggbm8KICAgICAqICAgIGVtYmVkZGVkIGV4cHJlc3Npb24gd2lsbCByZXR1cm4gbnVsbCBmb3IgdGhlIGludGVycG9sYXRpb24gZnVuY3Rpb24uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHRydXN0ZWRDb250ZXh0IHdoZW4gcHJvdmlkZWQsIHRoZSByZXR1cm5lZCBmdW5jdGlvbiBwYXNzZXMgdGhlIGludGVycG9sYXRlZAogICAgICogICAgcmVzdWx0IHRocm91Z2gge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWQoaW50ZXJwb2xhdGVkUmVzdWx0LAogICAgICogICAgdHJ1c3RlZENvbnRleHQpfSBiZWZvcmUgcmV0dXJuaW5nIGl0LiAgUmVmZXIgdG8gdGhlIHtAbGluayBuZy4kc2NlICRzY2V9IHNlcnZpY2UgdGhhdAogICAgICogICAgcHJvdmlkZXMgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgZm9yIGRldGFpbHMuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBhbGxPck5vdGhpbmcgaWYgYHRydWVgLCB0aGVuIHRoZSByZXR1cm5lZCBmdW5jdGlvbiByZXR1cm5zIHVuZGVmaW5lZAogICAgICogICAgdW5sZXNzIGFsbCBlbWJlZGRlZCBleHByZXNzaW9ucyBldmFsdWF0ZSB0byBhIHZhbHVlIG90aGVyIHRoYW4gYHVuZGVmaW5lZGAuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCl9IGFuIGludGVycG9sYXRpb24gZnVuY3Rpb24gd2hpY2ggaXMgdXNlZCB0byBjb21wdXRlIHRoZQogICAgICogICAgaW50ZXJwb2xhdGVkIHN0cmluZy4gVGhlIGZ1bmN0aW9uIGhhcyB0aGVzZSBwYXJhbWV0ZXJzOgogICAgICoKICAgICAqIC0gYGNvbnRleHRgOiBldmFsdWF0aW9uIGNvbnRleHQgZm9yIGFsbCBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgaW50ZXJwb2xhdGVkIHRleHQKICAgICAqLwogICAgZnVuY3Rpb24gJGludGVycG9sYXRlKHRleHQsIG11c3RIYXZlRXhwcmVzc2lvbiwgdHJ1c3RlZENvbnRleHQsIGFsbE9yTm90aGluZykgewogICAgICBhbGxPck5vdGhpbmcgPSAhIWFsbE9yTm90aGluZzsKICAgICAgdmFyIHN0YXJ0SW5kZXgsCiAgICAgICAgICBlbmRJbmRleCwKICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgIGV4cHJlc3Npb25zID0gW10sCiAgICAgICAgICBwYXJzZUZucyA9IFtdLAogICAgICAgICAgdGV4dExlbmd0aCA9IHRleHQubGVuZ3RoLAogICAgICAgICAgZXhwLAogICAgICAgICAgY29uY2F0ID0gW10sCiAgICAgICAgICBleHByZXNzaW9uUG9zaXRpb25zID0gW107CgogICAgICB3aGlsZShpbmRleCA8IHRleHRMZW5ndGgpIHsKICAgICAgICBpZiAoICgoc3RhcnRJbmRleCA9IHRleHQuaW5kZXhPZihzdGFydFN5bWJvbCwgaW5kZXgpKSAhPSAtMSkgJiYKICAgICAgICAgICAgICgoZW5kSW5kZXggPSB0ZXh0LmluZGV4T2YoZW5kU3ltYm9sLCBzdGFydEluZGV4ICsgc3RhcnRTeW1ib2xMZW5ndGgpKSAhPSAtMSkgKSB7CiAgICAgICAgICBpZiAoaW5kZXggIT09IHN0YXJ0SW5kZXgpIHsKICAgICAgICAgICAgY29uY2F0LnB1c2godW5lc2NhcGVUZXh0KHRleHQuc3Vic3RyaW5nKGluZGV4LCBzdGFydEluZGV4KSkpOwogICAgICAgICAgfQogICAgICAgICAgZXhwID0gdGV4dC5zdWJzdHJpbmcoc3RhcnRJbmRleCArIHN0YXJ0U3ltYm9sTGVuZ3RoLCBlbmRJbmRleCk7CiAgICAgICAgICBleHByZXNzaW9ucy5wdXNoKGV4cCk7CiAgICAgICAgICBwYXJzZUZucy5wdXNoKCRwYXJzZShleHAsIHBhcnNlU3RyaW5naWZ5SW50ZXJjZXB0b3IpKTsKICAgICAgICAgIGluZGV4ID0gZW5kSW5kZXggKyBlbmRTeW1ib2xMZW5ndGg7CiAgICAgICAgICBleHByZXNzaW9uUG9zaXRpb25zLnB1c2goY29uY2F0Lmxlbmd0aCk7CiAgICAgICAgICBjb25jYXQucHVzaCgnJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIHdlIGRpZCBub3QgZmluZCBhbiBpbnRlcnBvbGF0aW9uLCBzbyB3ZSBoYXZlIHRvIGFkZCB0aGUgcmVtYWluZGVyIHRvIHRoZSBzZXBhcmF0b3JzIGFycmF5CiAgICAgICAgICBpZiAoaW5kZXggIT09IHRleHRMZW5ndGgpIHsKICAgICAgICAgICAgY29uY2F0LnB1c2godW5lc2NhcGVUZXh0KHRleHQuc3Vic3RyaW5nKGluZGV4KSkpOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBDb25jYXRlbmF0aW5nIGV4cHJlc3Npb25zIG1ha2VzIGl0IGhhcmQgdG8gcmVhc29uIGFib3V0IHdoZXRoZXIgc29tZSBjb21iaW5hdGlvbiBvZgogICAgICAvLyBjb25jYXRlbmF0ZWQgdmFsdWVzIGFyZSB1bnNhZmUgdG8gdXNlIGFuZCBjb3VsZCBlYXNpbHkgbGVhZCB0byBYU1MuICBCeSByZXF1aXJpbmcgdGhhdCBhCiAgICAgIC8vIHNpbmdsZSBleHByZXNzaW9uIGJlIHVzZWQgZm9yIGlmcmFtZVtzcmNdLCBvYmplY3Rbc3JjXSwgZXRjLiwgd2UgZW5zdXJlIHRoYXQgdGhlIHZhbHVlCiAgICAgIC8vIHRoYXQncyB1c2VkIGlzIGFzc2lnbmVkIG9yIGNvbnN0cnVjdGVkIGJ5IHNvbWUgSlMgY29kZSBzb21ld2hlcmUgdGhhdCBpcyBtb3JlIHRlc3RhYmxlIG9yCiAgICAgIC8vIG1ha2UgaXQgb2J2aW91cyB0aGF0IHlvdSBib3VuZCB0aGUgdmFsdWUgdG8gc29tZSB1c2VyIGNvbnRyb2xsZWQgdmFsdWUuICBUaGlzIGhlbHBzIHJlZHVjZQogICAgICAvLyB0aGUgbG9hZCB3aGVuIGF1ZGl0aW5nIGZvciBYU1MgaXNzdWVzLgogICAgICBpZiAodHJ1c3RlZENvbnRleHQgJiYgY29uY2F0Lmxlbmd0aCA+IDEpIHsKICAgICAgICAgIHRocm93ICRpbnRlcnBvbGF0ZU1pbkVycignbm9jb25jYXQnLAogICAgICAgICAgICAgICJFcnJvciB3aGlsZSBpbnRlcnBvbGF0aW5nOiB7MH1cblN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIGRpc2FsbG93cyAiICsKICAgICAgICAgICAgICAiaW50ZXJwb2xhdGlvbnMgdGhhdCBjb25jYXRlbmF0ZSBtdWx0aXBsZSBleHByZXNzaW9ucyB3aGVuIGEgdHJ1c3RlZCB2YWx1ZSBpcyAiICsKICAgICAgICAgICAgICAicmVxdWlyZWQuICBTZWUgaHR0cDovL2RvY3MuYW5ndWxhcmpzLm9yZy9hcGkvbmcuJHNjZSIsIHRleHQpOwogICAgICB9CgogICAgICBpZiAoIW11c3RIYXZlRXhwcmVzc2lvbiB8fCBleHByZXNzaW9ucy5sZW5ndGgpIHsKICAgICAgICB2YXIgY29tcHV0ZSA9IGZ1bmN0aW9uKHZhbHVlcykgewogICAgICAgICAgZm9yKHZhciBpID0gMCwgaWkgPSBleHByZXNzaW9ucy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgIGlmIChhbGxPck5vdGhpbmcgJiYgaXNVbmRlZmluZWQodmFsdWVzW2ldKSkgcmV0dXJuOwogICAgICAgICAgICBjb25jYXRbZXhwcmVzc2lvblBvc2l0aW9uc1tpXV0gPSB2YWx1ZXNbaV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uY2F0LmpvaW4oJycpOwogICAgICAgIH07CgogICAgICAgIHZhciBnZXRWYWx1ZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgcmV0dXJuIHRydXN0ZWRDb250ZXh0ID8KICAgICAgICAgICAgJHNjZS5nZXRUcnVzdGVkKHRydXN0ZWRDb250ZXh0LCB2YWx1ZSkgOgogICAgICAgICAgICAkc2NlLnZhbHVlT2YodmFsdWUpOwogICAgICAgIH07CgogICAgICAgIHZhciBzdHJpbmdpZnkgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7IC8vIG51bGwgfHwgdW5kZWZpbmVkCiAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgICAgICAgdmFsdWUgPSAnJyArIHZhbHVlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHZhbHVlID0gdG9Kc29uKHZhbHVlKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiBpbnRlcnBvbGF0aW9uRm4oY29udGV4dCkgewogICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgIHZhciBpaSA9IGV4cHJlc3Npb25zLmxlbmd0aDsKICAgICAgICAgICAgdmFyIHZhbHVlcyA9IG5ldyBBcnJheShpaSk7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGZvciAoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgdmFsdWVzW2ldID0gcGFyc2VGbnNbaV0oY29udGV4dCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gY29tcHV0ZSh2YWx1ZXMpOwogICAgICAgICAgICB9IGNhdGNoKGVycikgewogICAgICAgICAgICAgIHZhciBuZXdFcnIgPSAkaW50ZXJwb2xhdGVNaW5FcnIoJ2ludGVycicsICJDYW4ndCBpbnRlcnBvbGF0ZTogezB9XG57MX0iLCB0ZXh0LAogICAgICAgICAgICAgICAgICBlcnIudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIobmV3RXJyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0sIHsKICAgICAgICAgIC8vIGFsbCBvZiB0aGVzZSBwcm9wZXJ0aWVzIGFyZSB1bmRvY3VtZW50ZWQgZm9yIG5vdwogICAgICAgICAgZXhwOiB0ZXh0LCAvL2p1c3QgZm9yIGNvbXBhdGliaWxpdHkgd2l0aCByZWd1bGFyIHdhdGNoZXJzIGNyZWF0ZWQgdmlhICR3YXRjaAogICAgICAgICAgZXhwcmVzc2lvbnM6IGV4cHJlc3Npb25zLAogICAgICAgICAgJCR3YXRjaERlbGVnYXRlOiBmdW5jdGlvbiAoc2NvcGUsIGxpc3RlbmVyLCBvYmplY3RFcXVhbGl0eSkgewogICAgICAgICAgICB2YXIgbGFzdFZhbHVlOwogICAgICAgICAgICByZXR1cm4gc2NvcGUuJHdhdGNoR3JvdXAocGFyc2VGbnMsIGZ1bmN0aW9uIGludGVycG9sYXRlRm5XYXRjaGVyKHZhbHVlcywgb2xkVmFsdWVzKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJWYWx1ZSA9IGNvbXB1dGUodmFsdWVzKTsKICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihsaXN0ZW5lcikpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVyLmNhbGwodGhpcywgY3VyclZhbHVlLCB2YWx1ZXMgIT09IG9sZFZhbHVlcyA/IGxhc3RWYWx1ZSA6IGN1cnJWYWx1ZSwgc2NvcGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBjdXJyVmFsdWU7CiAgICAgICAgICAgIH0sIG9iamVjdEVxdWFsaXR5KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gdW5lc2NhcGVUZXh0KHRleHQpIHsKICAgICAgICByZXR1cm4gdGV4dC5yZXBsYWNlKGVzY2FwZWRTdGFydFJlZ2V4cCwgc3RhcnRTeW1ib2wpLgogICAgICAgICAgcmVwbGFjZShlc2NhcGVkRW5kUmVnZXhwLCBlbmRTeW1ib2wpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwYXJzZVN0cmluZ2lmeUludGVyY2VwdG9yKHZhbHVlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBzdHJpbmdpZnkoZ2V0VmFsdWUodmFsdWUpKTsKICAgICAgICB9IGNhdGNoKGVycikgewogICAgICAgICAgdmFyIG5ld0VyciA9ICRpbnRlcnBvbGF0ZU1pbkVycignaW50ZXJyJywgIkNhbid0IGludGVycG9sYXRlOiB7MH1cbnsxfSIsIHRleHQsCiAgICAgICAgICAgIGVyci50b1N0cmluZygpKTsKICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKG5ld0Vycik7CiAgICAgICAgfQogICAgICB9CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGludGVycG9sYXRlI3N0YXJ0U3ltYm9sCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIHN0YXJ0IG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB7e2AuCiAgICAgKgogICAgICogVXNlIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNzdGFydFN5bWJvbCBgJGludGVycG9sYXRlUHJvdmlkZXIuc3RhcnRTeW1ib2xgfSB0byBjaGFuZ2UKICAgICAqIHRoZSBzeW1ib2wuCiAgICAgKgogICAgICogQHJldHVybnMge3N0cmluZ30gc3RhcnQgc3ltYm9sLgogICAgICovCiAgICAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2wgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHN0YXJ0U3ltYm9sOwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW50ZXJwb2xhdGUjZW5kU3ltYm9sCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIGVuZCBvZiBleHByZXNzaW9uIGluIHRoZSBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBEZWZhdWx0cyB0byBgfX1gLgogICAgICoKICAgICAqIFVzZSB7QGxpbmsgbmcuJGludGVycG9sYXRlUHJvdmlkZXIjZW5kU3ltYm9sIGAkaW50ZXJwb2xhdGVQcm92aWRlci5lbmRTeW1ib2xgfSB0byBjaGFuZ2UKICAgICAqIHRoZSBzeW1ib2wuCiAgICAgKgogICAgICogQHJldHVybnMge3N0cmluZ30gZW5kIHN5bWJvbC4KICAgICAqLwogICAgJGludGVycG9sYXRlLmVuZFN5bWJvbCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZW5kU3ltYm9sOwogICAgfTsKCiAgICByZXR1cm4gJGludGVycG9sYXRlOwogIH1dOwp9CgpmdW5jdGlvbiAkSW50ZXJ2YWxQcm92aWRlcigpIHsKICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJHdpbmRvdycsICckcScsICckJHEnLAogICAgICAgZnVuY3Rpb24oJHJvb3RTY29wZSwgICAkd2luZG93LCAgICRxLCAgICQkcSkgewogICAgdmFyIGludGVydmFscyA9IHt9OwoKCiAgICAgLyoqCiAgICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAgKiBAbmFtZSAkaW50ZXJ2YWwKICAgICAgKgogICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAqIEFuZ3VsYXIncyB3cmFwcGVyIGZvciBgd2luZG93LnNldEludGVydmFsYC4gVGhlIGBmbmAgZnVuY3Rpb24gaXMgZXhlY3V0ZWQgZXZlcnkgYGRlbGF5YAogICAgICAqIG1pbGxpc2Vjb25kcy4KICAgICAgKgogICAgICAqIFRoZSByZXR1cm4gdmFsdWUgb2YgcmVnaXN0ZXJpbmcgYW4gaW50ZXJ2YWwgZnVuY3Rpb24gaXMgYSBwcm9taXNlLiBUaGlzIHByb21pc2Ugd2lsbCBiZQogICAgICAqIG5vdGlmaWVkIHVwb24gZWFjaCB0aWNrIG9mIHRoZSBpbnRlcnZhbCwgYW5kIHdpbGwgYmUgcmVzb2x2ZWQgYWZ0ZXIgYGNvdW50YCBpdGVyYXRpb25zLCBvcgogICAgICAqIHJ1biBpbmRlZmluaXRlbHkgaWYgYGNvdW50YCBpcyBub3QgZGVmaW5lZC4gVGhlIHZhbHVlIG9mIHRoZSBub3RpZmljYXRpb24gd2lsbCBiZSB0aGUKICAgICAgKiBudW1iZXIgb2YgaXRlcmF0aW9ucyB0aGF0IGhhdmUgcnVuLgogICAgICAqIFRvIGNhbmNlbCBhbiBpbnRlcnZhbCwgY2FsbCBgJGludGVydmFsLmNhbmNlbChwcm9taXNlKWAuCiAgICAgICoKICAgICAgKiBJbiB0ZXN0cyB5b3UgY2FuIHVzZSB7QGxpbmsgbmdNb2NrLiRpbnRlcnZhbCNmbHVzaCBgJGludGVydmFsLmZsdXNoKG1pbGxpcylgfSB0bwogICAgICAqIG1vdmUgZm9yd2FyZCBieSBgbWlsbGlzYCBtaWxsaXNlY29uZHMgYW5kIHRyaWdnZXIgYW55IGZ1bmN0aW9ucyBzY2hlZHVsZWQgdG8gcnVuIGluIHRoYXQKICAgICAgKiB0aW1lLgogICAgICAqCiAgICAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAgICAgICogKipOb3RlKio6IEludGVydmFscyBjcmVhdGVkIGJ5IHRoaXMgc2VydmljZSBtdXN0IGJlIGV4cGxpY2l0bHkgZGVzdHJveWVkIHdoZW4geW91IGFyZSBmaW5pc2hlZAogICAgICAqIHdpdGggdGhlbS4gIEluIHBhcnRpY3VsYXIgdGhleSBhcmUgbm90IGF1dG9tYXRpY2FsbHkgZGVzdHJveWVkIHdoZW4gYSBjb250cm9sbGVyJ3Mgc2NvcGUgb3IgYQogICAgICAqIGRpcmVjdGl2ZSdzIGVsZW1lbnQgYXJlIGRlc3Ryb3llZC4KICAgICAgKiBZb3Ugc2hvdWxkIHRha2UgdGhpcyBpbnRvIGNvbnNpZGVyYXRpb24gYW5kIG1ha2Ugc3VyZSB0byBhbHdheXMgY2FuY2VsIHRoZSBpbnRlcnZhbCBhdCB0aGUKICAgICAgKiBhcHByb3ByaWF0ZSBtb21lbnQuICBTZWUgdGhlIGV4YW1wbGUgYmVsb3cgZm9yIG1vcmUgZGV0YWlscyBvbiBob3cgYW5kIHdoZW4gdG8gZG8gdGhpcy4KICAgICAgKiA8L2Rpdj4KICAgICAgKgogICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiB0aGF0IHNob3VsZCBiZSBjYWxsZWQgcmVwZWF0ZWRseS4KICAgICAgKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgTnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBiZXR3ZWVuIGVhY2ggZnVuY3Rpb24gY2FsbC4KICAgICAgKiBAcGFyYW0ge251bWJlcj19IFtjb3VudD0wXSBOdW1iZXIgb2YgdGltZXMgdG8gcmVwZWF0LiBJZiBub3Qgc2V0LCBvciAwLCB3aWxsIHJlcGVhdAogICAgICAqICAgaW5kZWZpbml0ZWx5LgogICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtpbnZva2VBcHBseT10cnVlXSBJZiBzZXQgdG8gYGZhbHNlYCBza2lwcyBtb2RlbCBkaXJ0eSBjaGVja2luZywgb3RoZXJ3aXNlCiAgICAgICogICB3aWxsIGludm9rZSBgZm5gIHdpdGhpbiB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseX0gYmxvY2suCiAgICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB3aGljaCB3aWxsIGJlIG5vdGlmaWVkIG9uIGVhY2ggaXRlcmF0aW9uLgogICAgICAqCiAgICAgICogQGV4YW1wbGUKICAgICAgKiA8ZXhhbXBsZSBtb2R1bGU9ImludGVydmFsRXhhbXBsZSI+CiAgICAgICogPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICogICA8c2NyaXB0PgogICAgICAqICAgICBhbmd1bGFyLm1vZHVsZSgnaW50ZXJ2YWxFeGFtcGxlJywgW10pCiAgICAgICogICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCAnJGludGVydmFsJywKICAgICAgKiAgICAgICAgIGZ1bmN0aW9uKCRzY29wZSwgJGludGVydmFsKSB7CiAgICAgICogICAgICAgICAgICRzY29wZS5mb3JtYXQgPSAnTS9kL3l5IGg6bW06c3MgYSc7CiAgICAgICogICAgICAgICAgICRzY29wZS5ibG9vZF8xID0gMTAwOwogICAgICAqICAgICAgICAgICAkc2NvcGUuYmxvb2RfMiA9IDEyMDsKICAgICAgKgogICAgICAqICAgICAgICAgICB2YXIgc3RvcDsKICAgICAgKiAgICAgICAgICAgJHNjb3BlLmZpZ2h0ID0gZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgICAgLy8gRG9uJ3Qgc3RhcnQgYSBuZXcgZmlnaHQgaWYgd2UgYXJlIGFscmVhZHkgZmlnaHRpbmcKICAgICAgKiAgICAgICAgICAgICBpZiAoIGFuZ3VsYXIuaXNEZWZpbmVkKHN0b3ApICkgcmV0dXJuOwogICAgICAqCiAgICAgICogICAgICAgICAgIHN0b3AgPSAkaW50ZXJ2YWwoZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgICAgaWYgKCRzY29wZS5ibG9vZF8xID4gMCAmJiAkc2NvcGUuYmxvb2RfMiA+IDApIHsKICAgICAgKiAgICAgICAgICAgICAgICRzY29wZS5ibG9vZF8xID0gJHNjb3BlLmJsb29kXzEgLSAzOwogICAgICAqICAgICAgICAgICAgICAgJHNjb3BlLmJsb29kXzIgPSAkc2NvcGUuYmxvb2RfMiAtIDQ7CiAgICAgICogICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgKiAgICAgICAgICAgICAgICRzY29wZS5zdG9wRmlnaHQoKTsKICAgICAgKiAgICAgICAgICAgICB9CiAgICAgICogICAgICAgICAgIH0sIDEwMCk7CiAgICAgICogICAgICAgICB9OwogICAgICAqCiAgICAgICogICAgICAgICAkc2NvcGUuc3RvcEZpZ2h0ID0gZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgIGlmIChhbmd1bGFyLmlzRGVmaW5lZChzdG9wKSkgewogICAgICAqICAgICAgICAgICAgICRpbnRlcnZhbC5jYW5jZWwoc3RvcCk7CiAgICAgICogICAgICAgICAgICAgc3RvcCA9IHVuZGVmaW5lZDsKICAgICAgKiAgICAgICAgICAgfQogICAgICAqICAgICAgICAgfTsKICAgICAgKgogICAgICAqICAgICAgICAgJHNjb3BlLnJlc2V0RmlnaHQgPSBmdW5jdGlvbigpIHsKICAgICAgKiAgICAgICAgICAgJHNjb3BlLmJsb29kXzEgPSAxMDA7CiAgICAgICogICAgICAgICAgICRzY29wZS5ibG9vZF8yID0gMTIwOwogICAgICAqICAgICAgICAgfTsKICAgICAgKgogICAgICAqICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgKiAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGludGVydmFsIGlzIGRlc3Ryb3llZCB0b28KICAgICAgKiAgICAgICAgICAgJHNjb3BlLnN0b3BGaWdodCgpOwogICAgICAqICAgICAgICAgfSk7CiAgICAgICogICAgICAgfV0pCiAgICAgICogICAgICAgLy8gUmVnaXN0ZXIgdGhlICdteUN1cnJlbnRUaW1lJyBkaXJlY3RpdmUgZmFjdG9yeSBtZXRob2QuCiAgICAgICogICAgICAgLy8gV2UgaW5qZWN0ICRpbnRlcnZhbCBhbmQgZGF0ZUZpbHRlciBzZXJ2aWNlIHNpbmNlIHRoZSBmYWN0b3J5IG1ldGhvZCBpcyBESS4KICAgICAgKiAgICAgICAuZGlyZWN0aXZlKCdteUN1cnJlbnRUaW1lJywgWyckaW50ZXJ2YWwnLCAnZGF0ZUZpbHRlcicsCiAgICAgICogICAgICAgICBmdW5jdGlvbigkaW50ZXJ2YWwsIGRhdGVGaWx0ZXIpIHsKICAgICAgKiAgICAgICAgICAgLy8gcmV0dXJuIHRoZSBkaXJlY3RpdmUgbGluayBmdW5jdGlvbi4gKGNvbXBpbGUgZnVuY3Rpb24gbm90IG5lZWRlZCkKICAgICAgKiAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAqICAgICAgICAgICAgIHZhciBmb3JtYXQsICAvLyBkYXRlIGZvcm1hdAogICAgICAqICAgICAgICAgICAgICAgICBzdG9wVGltZTsgLy8gc28gdGhhdCB3ZSBjYW4gY2FuY2VsIHRoZSB0aW1lIHVwZGF0ZXMKICAgICAgKgogICAgICAqICAgICAgICAgICAgIC8vIHVzZWQgdG8gdXBkYXRlIHRoZSBVSQogICAgICAqICAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVRpbWUoKSB7CiAgICAgICogICAgICAgICAgICAgICBlbGVtZW50LnRleHQoZGF0ZUZpbHRlcihuZXcgRGF0ZSgpLCBmb3JtYXQpKTsKICAgICAgKiAgICAgICAgICAgICB9CiAgICAgICoKICAgICAgKiAgICAgICAgICAgICAvLyB3YXRjaCB0aGUgZXhwcmVzc2lvbiwgYW5kIHVwZGF0ZSB0aGUgVUkgb24gY2hhbmdlLgogICAgICAqICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRycy5teUN1cnJlbnRUaW1lLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAqICAgICAgICAgICAgICAgZm9ybWF0ID0gdmFsdWU7CiAgICAgICogICAgICAgICAgICAgICB1cGRhdGVUaW1lKCk7CiAgICAgICogICAgICAgICAgICAgfSk7CiAgICAgICoKICAgICAgKiAgICAgICAgICAgICBzdG9wVGltZSA9ICRpbnRlcnZhbCh1cGRhdGVUaW1lLCAxMDAwKTsKICAgICAgKgogICAgICAqICAgICAgICAgICAgIC8vIGxpc3RlbiBvbiBET00gZGVzdHJveSAocmVtb3ZhbCkgZXZlbnQsIGFuZCBjYW5jZWwgdGhlIG5leHQgVUkgdXBkYXRlCiAgICAgICogICAgICAgICAgICAgLy8gdG8gcHJldmVudCB1cGRhdGluZyB0aW1lIGFmdGVyIHRoZSBET00gZWxlbWVudCB3YXMgcmVtb3ZlZC4KICAgICAgKiAgICAgICAgICAgICBlbGVtZW50Lm9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAqICAgICAgICAgICAgICAgJGludGVydmFsLmNhbmNlbChzdG9wVGltZSk7CiAgICAgICogICAgICAgICAgICAgfSk7CiAgICAgICogICAgICAgICAgIH0KICAgICAgKiAgICAgICAgIH1dKTsKICAgICAgKiAgIDwvc2NyaXB0PgogICAgICAqCiAgICAgICogICA8ZGl2PgogICAgICAqICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgKiAgICAgICBEYXRlIGZvcm1hdDogPGlucHV0IG5nLW1vZGVsPSJmb3JtYXQiPiA8aHIvPgogICAgICAqICAgICAgIEN1cnJlbnQgdGltZSBpczogPHNwYW4gbXktY3VycmVudC10aW1lPSJmb3JtYXQiPjwvc3Bhbj4KICAgICAgKiAgICAgICA8aHIvPgogICAgICAqICAgICAgIEJsb29kIDEgOiA8Zm9udCBjb2xvcj0ncmVkJz57e2Jsb29kXzF9fTwvZm9udD4KICAgICAgKiAgICAgICBCbG9vZCAyIDogPGZvbnQgY29sb3I9J3JlZCc+e3tibG9vZF8yfX08L2ZvbnQ+CiAgICAgICogICAgICAgPGJ1dHRvbiB0eXBlPSJidXR0b24iIGRhdGEtbmctY2xpY2s9ImZpZ2h0KCkiPkZpZ2h0PC9idXR0b24+CiAgICAgICogICAgICAgPGJ1dHRvbiB0eXBlPSJidXR0b24iIGRhdGEtbmctY2xpY2s9InN0b3BGaWdodCgpIj5TdG9wRmlnaHQ8L2J1dHRvbj4KICAgICAgKiAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgZGF0YS1uZy1jbGljaz0icmVzZXRGaWdodCgpIj5yZXNldEZpZ2h0PC9idXR0b24+CiAgICAgICogICAgIDwvZGl2PgogICAgICAqICAgPC9kaXY+CiAgICAgICoKICAgICAgKiA8L2ZpbGU+CiAgICAgICogPC9leGFtcGxlPgogICAgICAqLwogICAgZnVuY3Rpb24gaW50ZXJ2YWwoZm4sIGRlbGF5LCBjb3VudCwgaW52b2tlQXBwbHkpIHsKICAgICAgdmFyIHNldEludGVydmFsID0gJHdpbmRvdy5zZXRJbnRlcnZhbCwKICAgICAgICAgIGNsZWFySW50ZXJ2YWwgPSAkd2luZG93LmNsZWFySW50ZXJ2YWwsCiAgICAgICAgICBpdGVyYXRpb24gPSAwLAogICAgICAgICAgc2tpcEFwcGx5ID0gKGlzRGVmaW5lZChpbnZva2VBcHBseSkgJiYgIWludm9rZUFwcGx5KSwKICAgICAgICAgIGRlZmVycmVkID0gKHNraXBBcHBseSA/ICQkcSA6ICRxKS5kZWZlcigpLAogICAgICAgICAgcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2U7CgogICAgICBjb3VudCA9IGlzRGVmaW5lZChjb3VudCkgPyBjb3VudCA6IDA7CgogICAgICBwcm9taXNlLnRoZW4obnVsbCwgbnVsbCwgZm4pOwoKICAgICAgcHJvbWlzZS4kJGludGVydmFsSWQgPSBzZXRJbnRlcnZhbChmdW5jdGlvbiB0aWNrKCkgewogICAgICAgIGRlZmVycmVkLm5vdGlmeShpdGVyYXRpb24rKyk7CgogICAgICAgIGlmIChjb3VudCA+IDAgJiYgaXRlcmF0aW9uID49IGNvdW50KSB7CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGl0ZXJhdGlvbik7CiAgICAgICAgICBjbGVhckludGVydmFsKHByb21pc2UuJCRpbnRlcnZhbElkKTsKICAgICAgICAgIGRlbGV0ZSBpbnRlcnZhbHNbcHJvbWlzZS4kJGludGVydmFsSWRdOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFza2lwQXBwbHkpICRyb290U2NvcGUuJGFwcGx5KCk7CgogICAgICB9LCBkZWxheSk7CgogICAgICBpbnRlcnZhbHNbcHJvbWlzZS4kJGludGVydmFsSWRdID0gZGVmZXJyZWQ7CgogICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KCgogICAgIC8qKgogICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgKiBAbmFtZSAkaW50ZXJ2YWwjY2FuY2VsCiAgICAgICoKICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgKiBDYW5jZWxzIGEgdGFzayBhc3NvY2lhdGVkIHdpdGggdGhlIGBwcm9taXNlYC4KICAgICAgKgogICAgICAqIEBwYXJhbSB7cHJvbWlzZX0gcHJvbWlzZSByZXR1cm5lZCBieSB0aGUgYCRpbnRlcnZhbGAgZnVuY3Rpb24uCiAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB0YXNrIHdhcyBzdWNjZXNzZnVsbHkgY2FuY2VsZWQuCiAgICAgICovCiAgICBpbnRlcnZhbC5jYW5jZWwgPSBmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgIGlmIChwcm9taXNlICYmIHByb21pc2UuJCRpbnRlcnZhbElkIGluIGludGVydmFscykgewogICAgICAgIGludGVydmFsc1twcm9taXNlLiQkaW50ZXJ2YWxJZF0ucmVqZWN0KCdjYW5jZWxlZCcpOwogICAgICAgICR3aW5kb3cuY2xlYXJJbnRlcnZhbChwcm9taXNlLiQkaW50ZXJ2YWxJZCk7CiAgICAgICAgZGVsZXRlIGludGVydmFsc1twcm9taXNlLiQkaW50ZXJ2YWxJZF07CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICByZXR1cm4gaW50ZXJ2YWw7CiAgfV07Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkbG9jYWxlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiAkbG9jYWxlIHNlcnZpY2UgcHJvdmlkZXMgbG9jYWxpemF0aW9uIHJ1bGVzIGZvciB2YXJpb3VzIEFuZ3VsYXIgY29tcG9uZW50cy4gQXMgb2YgcmlnaHQgbm93IHRoZQogKiBvbmx5IHB1YmxpYyBhcGkgaXM6CiAqCiAqICogYGlkYCDigJMgYHtzdHJpbmd9YCDigJMgbG9jYWxlIGlkIGZvcm1hdHRlZCBhcyBgbGFuZ3VhZ2VJZC1jb3VudHJ5SWRgIChlLmcuIGBlbi11c2ApCiAqLwpmdW5jdGlvbiAkTG9jYWxlUHJvdmlkZXIoKXsKICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIGlkOiAnZW4tdXMnLAoKICAgICAgTlVNQkVSX0ZPUk1BVFM6IHsKICAgICAgICBERUNJTUFMX1NFUDogJy4nLAogICAgICAgIEdST1VQX1NFUDogJywnLAogICAgICAgIFBBVFRFUk5TOiBbCiAgICAgICAgICB7IC8vIERlY2ltYWwgUGF0dGVybgogICAgICAgICAgICBtaW5JbnQ6IDEsCiAgICAgICAgICAgIG1pbkZyYWM6IDAsCiAgICAgICAgICAgIG1heEZyYWM6IDMsCiAgICAgICAgICAgIHBvc1ByZTogJycsCiAgICAgICAgICAgIHBvc1N1ZjogJycsCiAgICAgICAgICAgIG5lZ1ByZTogJy0nLAogICAgICAgICAgICBuZWdTdWY6ICcnLAogICAgICAgICAgICBnU2l6ZTogMywKICAgICAgICAgICAgbGdTaXplOiAzCiAgICAgICAgICB9LHsgLy9DdXJyZW5jeSBQYXR0ZXJuCiAgICAgICAgICAgIG1pbkludDogMSwKICAgICAgICAgICAgbWluRnJhYzogMiwKICAgICAgICAgICAgbWF4RnJhYzogMiwKICAgICAgICAgICAgcG9zUHJlOiAnXHUwMEE0JywKICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgbmVnUHJlOiAnKFx1MDBBNCcsCiAgICAgICAgICAgIG5lZ1N1ZjogJyknLAogICAgICAgICAgICBnU2l6ZTogMywKICAgICAgICAgICAgbGdTaXplOiAzCiAgICAgICAgICB9CiAgICAgICAgXSwKICAgICAgICBDVVJSRU5DWV9TWU06ICckJwogICAgICB9LAoKICAgICAgREFURVRJTUVfRk9STUFUUzogewogICAgICAgIE1PTlRIOgogICAgICAgICAgICAnSmFudWFyeSxGZWJydWFyeSxNYXJjaCxBcHJpbCxNYXksSnVuZSxKdWx5LEF1Z3VzdCxTZXB0ZW1iZXIsT2N0b2JlcixOb3ZlbWJlcixEZWNlbWJlcicKICAgICAgICAgICAgLnNwbGl0KCcsJyksCiAgICAgICAgU0hPUlRNT05USDogICdKYW4sRmViLE1hcixBcHIsTWF5LEp1bixKdWwsQXVnLFNlcCxPY3QsTm92LERlYycuc3BsaXQoJywnKSwKICAgICAgICBEQVk6ICdTdW5kYXksTW9uZGF5LFR1ZXNkYXksV2VkbmVzZGF5LFRodXJzZGF5LEZyaWRheSxTYXR1cmRheScuc3BsaXQoJywnKSwKICAgICAgICBTSE9SVERBWTogJ1N1bixNb24sVHVlLFdlZCxUaHUsRnJpLFNhdCcuc3BsaXQoJywnKSwKICAgICAgICBBTVBNUzogWydBTScsJ1BNJ10sCiAgICAgICAgbWVkaXVtOiAnTU1NIGQsIHkgaDptbTpzcyBhJywKICAgICAgICBzaG9ydDogJ00vZC95eSBoOm1tIGEnLAogICAgICAgIGZ1bGxEYXRlOiAnRUVFRSwgTU1NTSBkLCB5JywKICAgICAgICBsb25nRGF0ZTogJ01NTU0gZCwgeScsCiAgICAgICAgbWVkaXVtRGF0ZTogJ01NTSBkLCB5JywKICAgICAgICBzaG9ydERhdGU6ICdNL2QveXknLAogICAgICAgIG1lZGl1bVRpbWU6ICdoOm1tOnNzIGEnLAogICAgICAgIHNob3J0VGltZTogJ2g6bW0gYScKICAgICAgfSwKCiAgICAgIHBsdXJhbENhdDogZnVuY3Rpb24obnVtKSB7CiAgICAgICAgaWYgKG51bSA9PT0gMSkgewogICAgICAgICAgcmV0dXJuICdvbmUnOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJ290aGVyJzsKICAgICAgfQogICAgfTsKICB9Owp9Cgp2YXIgUEFUSF9NQVRDSCA9IC9eKFteXD8jXSopKFw/KFteI10qKSk/KCMoLiopKT8kLywKICAgIERFRkFVTFRfUE9SVFMgPSB7J2h0dHAnOiA4MCwgJ2h0dHBzJzogNDQzLCAnZnRwJzogMjF9Owp2YXIgJGxvY2F0aW9uTWluRXJyID0gbWluRXJyKCckbG9jYXRpb24nKTsKCgovKioKICogRW5jb2RlIHBhdGggdXNpbmcgZW5jb2RlVXJpU2VnbWVudCwgaWdub3JpbmcgZm9yd2FyZCBzbGFzaGVzCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFBhdGggdG8gZW5jb2RlCiAqIEByZXR1cm5zIHtzdHJpbmd9CiAqLwpmdW5jdGlvbiBlbmNvZGVQYXRoKHBhdGgpIHsKICB2YXIgc2VnbWVudHMgPSBwYXRoLnNwbGl0KCcvJyksCiAgICAgIGkgPSBzZWdtZW50cy5sZW5ndGg7CgogIHdoaWxlIChpLS0pIHsKICAgIHNlZ21lbnRzW2ldID0gZW5jb2RlVXJpU2VnbWVudChzZWdtZW50c1tpXSk7CiAgfQoKICByZXR1cm4gc2VnbWVudHMuam9pbignLycpOwp9CgpmdW5jdGlvbiBwYXJzZUFic29sdXRlVXJsKGFic29sdXRlVXJsLCBsb2NhdGlvbk9iaiwgYXBwQmFzZSkgewogIHZhciBwYXJzZWRVcmwgPSB1cmxSZXNvbHZlKGFic29sdXRlVXJsLCBhcHBCYXNlKTsKCiAgbG9jYXRpb25PYmouJCRwcm90b2NvbCA9IHBhcnNlZFVybC5wcm90b2NvbDsKICBsb2NhdGlvbk9iai4kJGhvc3QgPSBwYXJzZWRVcmwuaG9zdG5hbWU7CiAgbG9jYXRpb25PYmouJCRwb3J0ID0gaW50KHBhcnNlZFVybC5wb3J0KSB8fCBERUZBVUxUX1BPUlRTW3BhcnNlZFVybC5wcm90b2NvbF0gfHwgbnVsbDsKfQoKCmZ1bmN0aW9uIHBhcnNlQXBwVXJsKHJlbGF0aXZlVXJsLCBsb2NhdGlvbk9iaiwgYXBwQmFzZSkgewogIHZhciBwcmVmaXhlZCA9IChyZWxhdGl2ZVVybC5jaGFyQXQoMCkgIT09ICcvJyk7CiAgaWYgKHByZWZpeGVkKSB7CiAgICByZWxhdGl2ZVVybCA9ICcvJyArIHJlbGF0aXZlVXJsOwogIH0KICB2YXIgbWF0Y2ggPSB1cmxSZXNvbHZlKHJlbGF0aXZlVXJsLCBhcHBCYXNlKTsKICBsb2NhdGlvbk9iai4kJHBhdGggPSBkZWNvZGVVUklDb21wb25lbnQocHJlZml4ZWQgJiYgbWF0Y2gucGF0aG5hbWUuY2hhckF0KDApID09PSAnLycgPwogICAgICBtYXRjaC5wYXRobmFtZS5zdWJzdHJpbmcoMSkgOiBtYXRjaC5wYXRobmFtZSk7CiAgbG9jYXRpb25PYmouJCRzZWFyY2ggPSBwYXJzZUtleVZhbHVlKG1hdGNoLnNlYXJjaCk7CiAgbG9jYXRpb25PYmouJCRoYXNoID0gZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoLmhhc2gpOwoKICAvLyBtYWtlIHN1cmUgcGF0aCBzdGFydHMgd2l0aCAnLyc7CiAgaWYgKGxvY2F0aW9uT2JqLiQkcGF0aCAmJiBsb2NhdGlvbk9iai4kJHBhdGguY2hhckF0KDApICE9ICcvJykgewogICAgbG9jYXRpb25PYmouJCRwYXRoID0gJy8nICsgbG9jYXRpb25PYmouJCRwYXRoOwogIH0KfQoKCi8qKgogKgogKiBAcGFyYW0ge3N0cmluZ30gYmVnaW4KICogQHBhcmFtIHtzdHJpbmd9IHdob2xlCiAqIEByZXR1cm5zIHtzdHJpbmd9IHJldHVybnMgdGV4dCBmcm9tIHdob2xlIGFmdGVyIGJlZ2luIG9yIHVuZGVmaW5lZCBpZiBpdCBkb2VzIG5vdCBiZWdpbiB3aXRoCiAqICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkIHN0cmluZy4KICovCmZ1bmN0aW9uIGJlZ2luc1dpdGgoYmVnaW4sIHdob2xlKSB7CiAgaWYgKHdob2xlLmluZGV4T2YoYmVnaW4pID09PSAwKSB7CiAgICByZXR1cm4gd2hvbGUuc3Vic3RyKGJlZ2luLmxlbmd0aCk7CiAgfQp9CgoKZnVuY3Rpb24gc3RyaXBIYXNoKHVybCkgewogIHZhciBpbmRleCA9IHVybC5pbmRleE9mKCcjJyk7CiAgcmV0dXJuIGluZGV4ID09IC0xID8gdXJsIDogdXJsLnN1YnN0cigwLCBpbmRleCk7Cn0KCgpmdW5jdGlvbiBzdHJpcEZpbGUodXJsKSB7CiAgcmV0dXJuIHVybC5zdWJzdHIoMCwgc3RyaXBIYXNoKHVybCkubGFzdEluZGV4T2YoJy8nKSArIDEpOwp9CgovKiByZXR1cm4gdGhlIHNlcnZlciBvbmx5IChzY2hlbWU6Ly9ob3N0OnBvcnQpICovCmZ1bmN0aW9uIHNlcnZlckJhc2UodXJsKSB7CiAgcmV0dXJuIHVybC5zdWJzdHJpbmcoMCwgdXJsLmluZGV4T2YoJy8nLCB1cmwuaW5kZXhPZignLy8nKSArIDIpKTsKfQoKCi8qKgogKiBMb2NhdGlvbkh0bWw1VXJsIHJlcHJlc2VudHMgYW4gdXJsCiAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBIVE1MNSBtb2RlIGlzIGVuYWJsZWQgYW5kIHN1cHBvcnRlZAogKgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHtzdHJpbmd9IGFwcEJhc2UgYXBwbGljYXRpb24gYmFzZSBVUkwKICogQHBhcmFtIHtzdHJpbmd9IGJhc2VQcmVmaXggdXJsIHBhdGggcHJlZml4CiAqLwpmdW5jdGlvbiBMb2NhdGlvbkh0bWw1VXJsKGFwcEJhc2UsIGJhc2VQcmVmaXgpIHsKICB0aGlzLiQkaHRtbDUgPSB0cnVlOwogIGJhc2VQcmVmaXggPSBiYXNlUHJlZml4IHx8ICcnOwogIHZhciBhcHBCYXNlTm9GaWxlID0gc3RyaXBGaWxlKGFwcEJhc2UpOwogIHBhcnNlQWJzb2x1dGVVcmwoYXBwQmFzZSwgdGhpcywgYXBwQmFzZSk7CgoKICAvKioKICAgKiBQYXJzZSBnaXZlbiBodG1sNSAocmVndWxhcikgdXJsIHN0cmluZyBpbnRvIHByb3BlcnRpZXMKICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3QWJzb2x1dGVVcmwgSFRNTDUgdXJsCiAgICogQHByaXZhdGUKICAgKi8KICB0aGlzLiQkcGFyc2UgPSBmdW5jdGlvbih1cmwpIHsKICAgIHZhciBwYXRoVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlTm9GaWxlLCB1cmwpOwogICAgaWYgKCFpc1N0cmluZyhwYXRoVXJsKSkgewogICAgICB0aHJvdyAkbG9jYXRpb25NaW5FcnIoJ2lwdGhwcmZ4JywgJ0ludmFsaWQgdXJsICJ7MH0iLCBtaXNzaW5nIHBhdGggcHJlZml4ICJ7MX0iLicsIHVybCwKICAgICAgICAgIGFwcEJhc2VOb0ZpbGUpOwogICAgfQoKICAgIHBhcnNlQXBwVXJsKHBhdGhVcmwsIHRoaXMsIGFwcEJhc2UpOwoKICAgIGlmICghdGhpcy4kJHBhdGgpIHsKICAgICAgdGhpcy4kJHBhdGggPSAnLyc7CiAgICB9CgogICAgdGhpcy4kJGNvbXBvc2UoKTsKICB9OwoKICAvKioKICAgKiBDb21wb3NlIHVybCBhbmQgdXBkYXRlIGBhYnNVcmxgIHByb3BlcnR5CiAgICogQHByaXZhdGUKICAgKi8KICB0aGlzLiQkY29tcG9zZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlYXJjaCA9IHRvS2V5VmFsdWUodGhpcy4kJHNlYXJjaCksCiAgICAgICAgaGFzaCA9IHRoaXMuJCRoYXNoID8gJyMnICsgZW5jb2RlVXJpU2VnbWVudCh0aGlzLiQkaGFzaCkgOiAnJzsKCiAgICB0aGlzLiQkdXJsID0gZW5jb2RlUGF0aCh0aGlzLiQkcGF0aCkgKyAoc2VhcmNoID8gJz8nICsgc2VhcmNoIDogJycpICsgaGFzaDsKICAgIHRoaXMuJCRhYnNVcmwgPSBhcHBCYXNlTm9GaWxlICsgdGhpcy4kJHVybC5zdWJzdHIoMSk7IC8vIGZpcnN0IGNoYXIgaXMgYWx3YXlzICcvJwogIH07CgogIHRoaXMuJCRwYXJzZUxpbmtVcmwgPSBmdW5jdGlvbih1cmwsIHJlbEhyZWYpIHsKICAgIGlmIChyZWxIcmVmICYmIHJlbEhyZWZbMF0gPT09ICcjJykgewogICAgICAvLyBzcGVjaWFsIGNhc2UgZm9yIGxpbmtzIHRvIGhhc2ggZnJhZ21lbnRzOgogICAgICAvLyBrZWVwIHRoZSBvbGQgdXJsIGFuZCBvbmx5IHJlcGxhY2UgdGhlIGhhc2ggZnJhZ21lbnQKICAgICAgdGhpcy5oYXNoKHJlbEhyZWYuc2xpY2UoMSkpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHZhciBhcHBVcmwsIHByZXZBcHBVcmw7CiAgICB2YXIgcmV3cml0dGVuVXJsOwoKICAgIGlmICggKGFwcFVybCA9IGJlZ2luc1dpdGgoYXBwQmFzZSwgdXJsKSkgIT09IHVuZGVmaW5lZCApIHsKICAgICAgcHJldkFwcFVybCA9IGFwcFVybDsKICAgICAgaWYgKCAoYXBwVXJsID0gYmVnaW5zV2l0aChiYXNlUHJlZml4LCBhcHBVcmwpKSAhPT0gdW5kZWZpbmVkICkgewogICAgICAgIHJld3JpdHRlblVybCA9IGFwcEJhc2VOb0ZpbGUgKyAoYmVnaW5zV2l0aCgnLycsIGFwcFVybCkgfHwgYXBwVXJsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXdyaXR0ZW5VcmwgPSBhcHBCYXNlICsgcHJldkFwcFVybDsKICAgICAgfQogICAgfSBlbHNlIGlmICggKGFwcFVybCA9IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKSkgIT09IHVuZGVmaW5lZCApIHsKICAgICAgcmV3cml0dGVuVXJsID0gYXBwQmFzZU5vRmlsZSArIGFwcFVybDsKICAgIH0gZWxzZSBpZiAoYXBwQmFzZU5vRmlsZSA9PSB1cmwgKyAnLycpIHsKICAgICAgcmV3cml0dGVuVXJsID0gYXBwQmFzZU5vRmlsZTsKICAgIH0KICAgIGlmIChyZXdyaXR0ZW5VcmwpIHsKICAgICAgdGhpcy4kJHBhcnNlKHJld3JpdHRlblVybCk7CiAgICB9CiAgICByZXR1cm4gISFyZXdyaXR0ZW5Vcmw7CiAgfTsKfQoKCi8qKgogKiBMb2NhdGlvbkhhc2hiYW5nVXJsIHJlcHJlc2VudHMgdXJsCiAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBkZXZlbG9wZXIgZG9lc24ndCBvcHQgaW50byBodG1sNSBtb2RlLgogKiBJdCBhbHNvIHNlcnZlcyBhcyB0aGUgYmFzZSBjbGFzcyBmb3IgaHRtbDUgbW9kZSBmYWxsYmFjayBvbiBsZWdhY3kgYnJvd3NlcnMuCiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge3N0cmluZ30gYXBwQmFzZSBhcHBsaWNhdGlvbiBiYXNlIFVSTAogKiBAcGFyYW0ge3N0cmluZ30gaGFzaFByZWZpeCBoYXNoYmFuZyBwcmVmaXgKICovCmZ1bmN0aW9uIExvY2F0aW9uSGFzaGJhbmdVcmwoYXBwQmFzZSwgaGFzaFByZWZpeCkgewogIHZhciBhcHBCYXNlTm9GaWxlID0gc3RyaXBGaWxlKGFwcEJhc2UpOwoKICBwYXJzZUFic29sdXRlVXJsKGFwcEJhc2UsIHRoaXMsIGFwcEJhc2UpOwoKCiAgLyoqCiAgICogUGFyc2UgZ2l2ZW4gaGFzaGJhbmcgdXJsIGludG8gcHJvcGVydGllcwogICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgSGFzaGJhbmcgdXJsCiAgICogQHByaXZhdGUKICAgKi8KICB0aGlzLiQkcGFyc2UgPSBmdW5jdGlvbih1cmwpIHsKICAgIHZhciB3aXRob3V0QmFzZVVybCA9IGJlZ2luc1dpdGgoYXBwQmFzZSwgdXJsKSB8fCBiZWdpbnNXaXRoKGFwcEJhc2VOb0ZpbGUsIHVybCk7CiAgICB2YXIgd2l0aG91dEhhc2hVcmwgPSB3aXRob3V0QmFzZVVybC5jaGFyQXQoMCkgPT0gJyMnCiAgICAgICAgPyBiZWdpbnNXaXRoKGhhc2hQcmVmaXgsIHdpdGhvdXRCYXNlVXJsKQogICAgICAgIDogKHRoaXMuJCRodG1sNSkKICAgICAgICAgID8gd2l0aG91dEJhc2VVcmwKICAgICAgICAgIDogJyc7CgogICAgaWYgKCFpc1N0cmluZyh3aXRob3V0SGFzaFVybCkpIHsKICAgICAgdGhyb3cgJGxvY2F0aW9uTWluRXJyKCdpaHNocHJmeCcsICdJbnZhbGlkIHVybCAiezB9IiwgbWlzc2luZyBoYXNoIHByZWZpeCAiezF9Ii4nLCB1cmwsCiAgICAgICAgICBoYXNoUHJlZml4KTsKICAgIH0KICAgIHBhcnNlQXBwVXJsKHdpdGhvdXRIYXNoVXJsLCB0aGlzLCBhcHBCYXNlKTsKCiAgICB0aGlzLiQkcGF0aCA9IHJlbW92ZVdpbmRvd3NEcml2ZU5hbWUodGhpcy4kJHBhdGgsIHdpdGhvdXRIYXNoVXJsLCBhcHBCYXNlKTsKCiAgICB0aGlzLiQkY29tcG9zZSgpOwoKICAgIC8qCiAgICAgKiBJbiBXaW5kb3dzLCBvbiBhbiBhbmNob3Igbm9kZSBvbiBkb2N1bWVudHMgbG9hZGVkIGZyb20KICAgICAqIHRoZSBmaWxlc3lzdGVtLCB0aGUgYnJvd3NlciB3aWxsIHJldHVybiBhIHBhdGhuYW1lCiAgICAgKiBwcmVmaXhlZCB3aXRoIHRoZSBkcml2ZSBuYW1lICgnL0M6L3BhdGgnKSB3aGVuIGEKICAgICAqIHBhdGhuYW1lIHdpdGhvdXQgYSBkcml2ZSBpcyBzZXQ6CiAgICAgKiAgKiBhLnNldEF0dHJpYnV0ZSgnaHJlZicsICcvZm9vJykKICAgICAqICAgKiBhLnBhdGhuYW1lID09PSAnL0M6L2ZvbycgLy90cnVlCiAgICAgKgogICAgICogSW5zaWRlIG9mIEFuZ3VsYXIsIHdlJ3JlIGFsd2F5cyB1c2luZyBwYXRobmFtZXMgdGhhdAogICAgICogZG8gbm90IGluY2x1ZGUgZHJpdmUgbmFtZXMgZm9yIHJvdXRpbmcuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlbW92ZVdpbmRvd3NEcml2ZU5hbWUgKHBhdGgsIHVybCwgYmFzZSkgewogICAgICAvKgogICAgICBNYXRjaGVzIHBhdGhzIGZvciBmaWxlIHByb3RvY29sIG9uIHdpbmRvd3MsCiAgICAgIHN1Y2ggYXMgL0M6L2Zvby9iYXIsIGFuZCBjYXB0dXJlcyBvbmx5IC9mb28vYmFyLgogICAgICAqLwogICAgICB2YXIgd2luZG93c0ZpbGVQYXRoRXhwID0gL15cL1tBLVpdOihcLy4qKS87CgogICAgICB2YXIgZmlyc3RQYXRoU2VnbWVudE1hdGNoOwoKICAgICAgLy9HZXQgdGhlIHJlbGF0aXZlIHBhdGggZnJvbSB0aGUgaW5wdXQgVVJMLgogICAgICBpZiAodXJsLmluZGV4T2YoYmFzZSkgPT09IDApIHsKICAgICAgICB1cmwgPSB1cmwucmVwbGFjZShiYXNlLCAnJyk7CiAgICAgIH0KCiAgICAgIC8vIFRoZSBpbnB1dCBVUkwgaW50ZW50aW9uYWxseSBjb250YWlucyBhIGZpcnN0IHBhdGggc2VnbWVudCB0aGF0IGVuZHMgd2l0aCBhIGNvbG9uLgogICAgICBpZiAod2luZG93c0ZpbGVQYXRoRXhwLmV4ZWModXJsKSkgewogICAgICAgIHJldHVybiBwYXRoOwogICAgICB9CgogICAgICBmaXJzdFBhdGhTZWdtZW50TWF0Y2ggPSB3aW5kb3dzRmlsZVBhdGhFeHAuZXhlYyhwYXRoKTsKICAgICAgcmV0dXJuIGZpcnN0UGF0aFNlZ21lbnRNYXRjaCA/IGZpcnN0UGF0aFNlZ21lbnRNYXRjaFsxXSA6IHBhdGg7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQ29tcG9zZSBoYXNoYmFuZyB1cmwgYW5kIHVwZGF0ZSBgYWJzVXJsYCBwcm9wZXJ0eQogICAqIEBwcml2YXRlCiAgICovCiAgdGhpcy4kJGNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWFyY2ggPSB0b0tleVZhbHVlKHRoaXMuJCRzZWFyY2gpLAogICAgICAgIGhhc2ggPSB0aGlzLiQkaGFzaCA/ICcjJyArIGVuY29kZVVyaVNlZ21lbnQodGhpcy4kJGhhc2gpIDogJyc7CgogICAgdGhpcy4kJHVybCA9IGVuY29kZVBhdGgodGhpcy4kJHBhdGgpICsgKHNlYXJjaCA/ICc/JyArIHNlYXJjaCA6ICcnKSArIGhhc2g7CiAgICB0aGlzLiQkYWJzVXJsID0gYXBwQmFzZSArICh0aGlzLiQkdXJsID8gaGFzaFByZWZpeCArIHRoaXMuJCR1cmwgOiAnJyk7CiAgfTsKCiAgdGhpcy4kJHBhcnNlTGlua1VybCA9IGZ1bmN0aW9uKHVybCwgcmVsSHJlZikgewogICAgaWYoc3RyaXBIYXNoKGFwcEJhc2UpID09IHN0cmlwSGFzaCh1cmwpKSB7CiAgICAgIHRoaXMuJCRwYXJzZSh1cmwpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9Owp9CgoKLyoqCiAqIExvY2F0aW9uSGFzaGJhbmdVcmwgcmVwcmVzZW50cyB1cmwKICogVGhpcyBvYmplY3QgaXMgZXhwb3NlZCBhcyAkbG9jYXRpb24gc2VydmljZSB3aGVuIGh0bWw1IGhpc3RvcnkgYXBpIGlzIGVuYWJsZWQgYnV0IHRoZSBicm93c2VyCiAqIGRvZXMgbm90IHN1cHBvcnQgaXQuCiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge3N0cmluZ30gYXBwQmFzZSBhcHBsaWNhdGlvbiBiYXNlIFVSTAogKiBAcGFyYW0ge3N0cmluZ30gaGFzaFByZWZpeCBoYXNoYmFuZyBwcmVmaXgKICovCmZ1bmN0aW9uIExvY2F0aW9uSGFzaGJhbmdJbkh0bWw1VXJsKGFwcEJhc2UsIGhhc2hQcmVmaXgpIHsKICB0aGlzLiQkaHRtbDUgPSB0cnVlOwogIExvY2F0aW9uSGFzaGJhbmdVcmwuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgdmFyIGFwcEJhc2VOb0ZpbGUgPSBzdHJpcEZpbGUoYXBwQmFzZSk7CgogIHRoaXMuJCRwYXJzZUxpbmtVcmwgPSBmdW5jdGlvbih1cmwsIHJlbEhyZWYpIHsKICAgIGlmIChyZWxIcmVmICYmIHJlbEhyZWZbMF0gPT09ICcjJykgewogICAgICAvLyBzcGVjaWFsIGNhc2UgZm9yIGxpbmtzIHRvIGhhc2ggZnJhZ21lbnRzOgogICAgICAvLyBrZWVwIHRoZSBvbGQgdXJsIGFuZCBvbmx5IHJlcGxhY2UgdGhlIGhhc2ggZnJhZ21lbnQKICAgICAgdGhpcy5oYXNoKHJlbEhyZWYuc2xpY2UoMSkpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICB2YXIgcmV3cml0dGVuVXJsOwogICAgdmFyIGFwcFVybDsKCiAgICBpZiAoIGFwcEJhc2UgPT0gc3RyaXBIYXNoKHVybCkgKSB7CiAgICAgIHJld3JpdHRlblVybCA9IHVybDsKICAgIH0gZWxzZSBpZiAoIChhcHBVcmwgPSBiZWdpbnNXaXRoKGFwcEJhc2VOb0ZpbGUsIHVybCkpICkgewogICAgICByZXdyaXR0ZW5VcmwgPSBhcHBCYXNlICsgaGFzaFByZWZpeCArIGFwcFVybDsKICAgIH0gZWxzZSBpZiAoIGFwcEJhc2VOb0ZpbGUgPT09IHVybCArICcvJykgewogICAgICByZXdyaXR0ZW5VcmwgPSBhcHBCYXNlTm9GaWxlOwogICAgfQogICAgaWYgKHJld3JpdHRlblVybCkgewogICAgICB0aGlzLiQkcGFyc2UocmV3cml0dGVuVXJsKTsKICAgIH0KICAgIHJldHVybiAhIXJld3JpdHRlblVybDsKICB9OwoKICB0aGlzLiQkY29tcG9zZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlYXJjaCA9IHRvS2V5VmFsdWUodGhpcy4kJHNlYXJjaCksCiAgICAgICAgaGFzaCA9IHRoaXMuJCRoYXNoID8gJyMnICsgZW5jb2RlVXJpU2VnbWVudCh0aGlzLiQkaGFzaCkgOiAnJzsKCiAgICB0aGlzLiQkdXJsID0gZW5jb2RlUGF0aCh0aGlzLiQkcGF0aCkgKyAoc2VhcmNoID8gJz8nICsgc2VhcmNoIDogJycpICsgaGFzaDsKICAgIC8vIGluY2x1ZGUgaGFzaFByZWZpeCBpbiAkJGFic1VybCB3aGVuICQkdXJsIGlzIGVtcHR5IHNvIElFOCAmIDkgZG8gbm90IHJlbG9hZCBwYWdlIGJlY2F1c2Ugb2YgcmVtb3ZhbCBvZiAnIycKICAgIHRoaXMuJCRhYnNVcmwgPSBhcHBCYXNlICsgaGFzaFByZWZpeCArIHRoaXMuJCR1cmw7CiAgfTsKCn0KCgp2YXIgbG9jYXRpb25Qcm90b3R5cGUgPSB7CgogIC8qKgogICAqIEFyZSB3ZSBpbiBodG1sNSBtb2RlPwogICAqIEBwcml2YXRlCiAgICovCiAgJCRodG1sNTogZmFsc2UsCgogIC8qKgogICAqIEhhcyBhbnkgY2hhbmdlIGJlZW4gcmVwbGFjaW5nPwogICAqIEBwcml2YXRlCiAgICovCiAgJCRyZXBsYWNlOiBmYWxzZSwKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2NhdGlvbiNhYnNVcmwKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAqCiAgICogUmV0dXJuIGZ1bGwgdXJsIHJlcHJlc2VudGF0aW9uIHdpdGggYWxsIHNlZ21lbnRzIGVuY29kZWQgYWNjb3JkaW5nIHRvIHJ1bGVzIHNwZWNpZmllZCBpbgogICAqIFtSRkMgMzk4Nl0oaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMzk4Ni50eHQpLgogICAqCiAgICogQHJldHVybiB7c3RyaW5nfSBmdWxsIHVybAogICAqLwogIGFic1VybDogbG9jYXRpb25HZXR0ZXIoJyQkYWJzVXJsJyksCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkbG9jYXRpb24jdXJsCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICoKICAgKiBSZXR1cm4gdXJsIChlLmcuIGAvcGF0aD9hPWIjaGFzaGApIHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgKgogICAqIENoYW5nZSBwYXRoLCBzZWFyY2ggYW5kIGhhc2gsIHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IHVybCBOZXcgdXJsIHdpdGhvdXQgYmFzZSBwcmVmaXggKGUuZy4gYC9wYXRoP2E9YiNoYXNoYCkKICAgKiBAcmV0dXJuIHtzdHJpbmd9IHVybAogICAqLwogIHVybDogZnVuY3Rpb24odXJsKSB7CiAgICBpZiAoaXNVbmRlZmluZWQodXJsKSkKICAgICAgcmV0dXJuIHRoaXMuJCR1cmw7CgogICAgdmFyIG1hdGNoID0gUEFUSF9NQVRDSC5leGVjKHVybCk7CiAgICBpZiAobWF0Y2hbMV0pIHRoaXMucGF0aChkZWNvZGVVUklDb21wb25lbnQobWF0Y2hbMV0pKTsKICAgIGlmIChtYXRjaFsyXSB8fCBtYXRjaFsxXSkgdGhpcy5zZWFyY2gobWF0Y2hbM10gfHwgJycpOwogICAgdGhpcy5oYXNoKG1hdGNoWzVdIHx8ICcnKTsKCiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI3Byb3RvY29sCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgKgogICAqIFJldHVybiBwcm90b2NvbCBvZiBjdXJyZW50IHVybC4KICAgKgogICAqIEByZXR1cm4ge3N0cmluZ30gcHJvdG9jb2wgb2YgY3VycmVudCB1cmwKICAgKi8KICBwcm90b2NvbDogbG9jYXRpb25HZXR0ZXIoJyQkcHJvdG9jb2wnKSwKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2NhdGlvbiNob3N0CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgKgogICAqIFJldHVybiBob3N0IG9mIGN1cnJlbnQgdXJsLgogICAqCiAgICogQHJldHVybiB7c3RyaW5nfSBob3N0IG9mIGN1cnJlbnQgdXJsLgogICAqLwogIGhvc3Q6IGxvY2F0aW9uR2V0dGVyKCckJGhvc3QnKSwKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2NhdGlvbiNwb3J0CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgKgogICAqIFJldHVybiBwb3J0IG9mIGN1cnJlbnQgdXJsLgogICAqCiAgICogQHJldHVybiB7TnVtYmVyfSBwb3J0CiAgICovCiAgcG9ydDogbG9jYXRpb25HZXR0ZXIoJyQkcG9ydCcpLAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI3BhdGgKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgKgogICAqIFJldHVybiBwYXRoIG9mIGN1cnJlbnQgdXJsIHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgKgogICAqIENoYW5nZSBwYXRoIHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICoKICAgKiBOb3RlOiBQYXRoIHNob3VsZCBhbHdheXMgYmVnaW4gd2l0aCBmb3J3YXJkIHNsYXNoICgvKSwgdGhpcyBtZXRob2Qgd2lsbCBhZGQgdGhlIGZvcndhcmQgc2xhc2gKICAgKiBpZiBpdCBpcyBtaXNzaW5nLgogICAqCiAgICogQHBhcmFtIHsoc3RyaW5nfG51bWJlcik9fSBwYXRoIE5ldyBwYXRoCiAgICogQHJldHVybiB7c3RyaW5nfSBwYXRoCiAgICovCiAgcGF0aDogbG9jYXRpb25HZXR0ZXJTZXR0ZXIoJyQkcGF0aCcsIGZ1bmN0aW9uKHBhdGgpIHsKICAgIHBhdGggPSBwYXRoICE9PSBudWxsID8gcGF0aC50b1N0cmluZygpIDogJyc7CiAgICByZXR1cm4gcGF0aC5jaGFyQXQoMCkgPT0gJy8nID8gcGF0aCA6ICcvJyArIHBhdGg7CiAgfSksCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkbG9jYXRpb24jc2VhcmNoCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICoKICAgKiBSZXR1cm4gc2VhcmNoIHBhcnQgKGFzIG9iamVjdCkgb2YgY3VycmVudCB1cmwgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAqCiAgICogQ2hhbmdlIHNlYXJjaCBwYXJ0IHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICoKICAgKgogICAqIGBgYGpzCiAgICogLy8gZ2l2ZW4gdXJsIGh0dHA6Ly9leGFtcGxlLmNvbS8jL3NvbWUvcGF0aD9mb289YmFyJmJhej14b3hvCiAgICogdmFyIHNlYXJjaE9iamVjdCA9ICRsb2NhdGlvbi5zZWFyY2goKTsKICAgKiAvLyA9PiB7Zm9vOiAnYmFyJywgYmF6OiAneG94byd9CiAgICoKICAgKgogICAqIC8vIHNldCBmb28gdG8gJ3lpcGVlJwogICAqICRsb2NhdGlvbi5zZWFyY2goJ2ZvbycsICd5aXBlZScpOwogICAqIC8vID0+ICRsb2NhdGlvbgogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0LjxzdHJpbmc+fE9iamVjdC48QXJyYXkuPHN0cmluZz4+fSBzZWFyY2ggTmV3IHNlYXJjaCBwYXJhbXMgLSBzdHJpbmcgb3IKICAgKiBoYXNoIG9iamVjdC4KICAgKgogICAqIFdoZW4gY2FsbGVkIHdpdGggYSBzaW5nbGUgYXJndW1lbnQgdGhlIG1ldGhvZCBhY3RzIGFzIGEgc2V0dGVyLCBzZXR0aW5nIHRoZSBgc2VhcmNoYCBjb21wb25lbnQKICAgKiBvZiBgJGxvY2F0aW9uYCB0byB0aGUgc3BlY2lmaWVkIHZhbHVlLgogICAqCiAgICogSWYgdGhlIGFyZ3VtZW50IGlzIGEgaGFzaCBvYmplY3QgY29udGFpbmluZyBhbiBhcnJheSBvZiB2YWx1ZXMsIHRoZXNlIHZhbHVlcyB3aWxsIGJlIGVuY29kZWQKICAgKiBhcyBkdXBsaWNhdGUgc2VhcmNoIHBhcmFtZXRlcnMgaW4gdGhlIHVybC4KICAgKgogICAqIEBwYXJhbSB7KHN0cmluZ3xOdW1iZXJ8QXJyYXk8c3RyaW5nPnxib29sZWFuKT19IHBhcmFtVmFsdWUgSWYgYHNlYXJjaGAgaXMgYSBzdHJpbmcgb3IgbnVtYmVyLCB0aGVuIGBwYXJhbVZhbHVlYAogICAqIHdpbGwgb3ZlcnJpZGUgb25seSBhIHNpbmdsZSBzZWFyY2ggcHJvcGVydHkuCiAgICoKICAgKiBJZiBgcGFyYW1WYWx1ZWAgaXMgYW4gYXJyYXksIGl0IHdpbGwgb3ZlcnJpZGUgdGhlIHByb3BlcnR5IG9mIHRoZSBgc2VhcmNoYCBjb21wb25lbnQgb2YKICAgKiBgJGxvY2F0aW9uYCBzcGVjaWZpZWQgdmlhIHRoZSBmaXJzdCBhcmd1bWVudC4KICAgKgogICAqIElmIGBwYXJhbVZhbHVlYCBpcyBgbnVsbGAsIHRoZSBwcm9wZXJ0eSBzcGVjaWZpZWQgdmlhIHRoZSBmaXJzdCBhcmd1bWVudCB3aWxsIGJlIGRlbGV0ZWQuCiAgICoKICAgKiBJZiBgcGFyYW1WYWx1ZWAgaXMgYHRydWVgLCB0aGUgcHJvcGVydHkgc3BlY2lmaWVkIHZpYSB0aGUgZmlyc3QgYXJndW1lbnQgd2lsbCBiZSBhZGRlZCB3aXRoIG5vCiAgICogdmFsdWUgbm9yIHRyYWlsaW5nIGVxdWFsIHNpZ24uCiAgICoKICAgKiBAcmV0dXJuIHtPYmplY3R9IElmIGNhbGxlZCB3aXRoIG5vIGFyZ3VtZW50cyByZXR1cm5zIHRoZSBwYXJzZWQgYHNlYXJjaGAgb2JqZWN0LiBJZiBjYWxsZWQgd2l0aAogICAqIG9uZSBvciBtb3JlIGFyZ3VtZW50cyByZXR1cm5zIGAkbG9jYXRpb25gIG9iamVjdCBpdHNlbGYuCiAgICovCiAgc2VhcmNoOiBmdW5jdGlvbihzZWFyY2gsIHBhcmFtVmFsdWUpIHsKICAgIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuIHRoaXMuJCRzZWFyY2g7CiAgICAgIGNhc2UgMToKICAgICAgICBpZiAoaXNTdHJpbmcoc2VhcmNoKSB8fCBpc051bWJlcihzZWFyY2gpKSB7CiAgICAgICAgICBzZWFyY2ggPSBzZWFyY2gudG9TdHJpbmcoKTsKICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBwYXJzZUtleVZhbHVlKHNlYXJjaCk7CiAgICAgICAgfSBlbHNlIGlmIChpc09iamVjdChzZWFyY2gpKSB7CiAgICAgICAgICBzZWFyY2ggPSBjb3B5KHNlYXJjaCwge30pOwogICAgICAgICAgLy8gcmVtb3ZlIG9iamVjdCB1bmRlZmluZWQgb3IgbnVsbCBwcm9wZXJ0aWVzCiAgICAgICAgICBmb3JFYWNoKHNlYXJjaCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgZGVsZXRlIHNlYXJjaFtrZXldOwogICAgICAgICAgfSk7CgogICAgICAgICAgdGhpcy4kJHNlYXJjaCA9IHNlYXJjaDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgJGxvY2F0aW9uTWluRXJyKCdpc3JjaGFyZycsCiAgICAgICAgICAgICAgJ1RoZSBmaXJzdCBhcmd1bWVudCBvZiB0aGUgYCRsb2NhdGlvbiNzZWFyY2goKWAgY2FsbCBtdXN0IGJlIGEgc3RyaW5nIG9yIGFuIG9iamVjdC4nKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHBhcmFtVmFsdWUpIHx8IHBhcmFtVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLiQkc2VhcmNoW3NlYXJjaF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuJCRzZWFyY2hbc2VhcmNoXSA9IHBhcmFtVmFsdWU7CiAgICAgICAgfQogICAgfQoKICAgIHRoaXMuJCRjb21wb3NlKCk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI2hhc2gKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgKgogICAqIFJldHVybiBoYXNoIGZyYWdtZW50IHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgKgogICAqIENoYW5nZSBoYXNoIGZyYWdtZW50IHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICoKICAgKiBAcGFyYW0geyhzdHJpbmd8bnVtYmVyKT19IGhhc2ggTmV3IGhhc2ggZnJhZ21lbnQKICAgKiBAcmV0dXJuIHtzdHJpbmd9IGhhc2gKICAgKi8KICBoYXNoOiBsb2NhdGlvbkdldHRlclNldHRlcignJCRoYXNoJywgZnVuY3Rpb24oaGFzaCkgewogICAgcmV0dXJuIGhhc2ggIT09IG51bGwgPyBoYXNoLnRvU3RyaW5nKCkgOiAnJzsKICB9KSwKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2NhdGlvbiNyZXBsYWNlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBJZiBjYWxsZWQsIGFsbCBjaGFuZ2VzIHRvICRsb2NhdGlvbiBkdXJpbmcgY3VycmVudCBgJGRpZ2VzdGAgd2lsbCBiZSByZXBsYWNpbmcgY3VycmVudCBoaXN0b3J5CiAgICogcmVjb3JkLCBpbnN0ZWFkIG9mIGFkZGluZyBuZXcgb25lLgogICAqLwogIHJlcGxhY2U6IGZ1bmN0aW9uKCkgewogICAgdGhpcy4kJHJlcGxhY2UgPSB0cnVlOwogICAgcmV0dXJuIHRoaXM7CiAgfQp9OwoKZm9yRWFjaChbTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmwsIExvY2F0aW9uSGFzaGJhbmdVcmwsIExvY2F0aW9uSHRtbDVVcmxdLCBmdW5jdGlvbiAoTG9jYXRpb24pIHsKICBMb2NhdGlvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGxvY2F0aW9uUHJvdG90eXBlKTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2NhdGlvbiNzdGF0ZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAqCiAgICogUmV0dXJuIHRoZSBoaXN0b3J5IHN0YXRlIG9iamVjdCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICoKICAgKiBDaGFuZ2UgdGhlIGhpc3Rvcnkgc3RhdGUgb2JqZWN0IHdoZW4gY2FsbGVkIHdpdGggb25lIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAqIFRoZSBzdGF0ZSBvYmplY3QgaXMgbGF0ZXIgcGFzc2VkIHRvIGBwdXNoU3RhdGVgIG9yIGByZXBsYWNlU3RhdGVgLgogICAqCiAgICogTk9URTogVGhpcyBtZXRob2QgaXMgc3VwcG9ydGVkIG9ubHkgaW4gSFRNTDUgbW9kZSBhbmQgb25seSBpbiBicm93c2VycyBzdXBwb3J0aW5nCiAgICogdGhlIEhUTUw1IEhpc3RvcnkgQVBJIChpLmUuIG1ldGhvZHMgYHB1c2hTdGF0ZWAgYW5kIGByZXBsYWNlU3RhdGVgKS4gSWYgeW91IG5lZWQgdG8gc3VwcG9ydAogICAqIG9sZGVyIGJyb3dzZXJzIChsaWtlIElFOSBvciBBbmRyb2lkIDwgNC4wKSwgZG9uJ3QgdXNlIHRoaXMgbWV0aG9kLgogICAqCiAgICogQHBhcmFtIHtvYmplY3Q9fSBzdGF0ZSBTdGF0ZSBvYmplY3QgZm9yIHB1c2hTdGF0ZSBvciByZXBsYWNlU3RhdGUKICAgKiBAcmV0dXJuIHtvYmplY3R9IHN0YXRlCiAgICovCiAgTG9jYXRpb24ucHJvdG90eXBlLnN0YXRlID0gZnVuY3Rpb24oc3RhdGUpIHsKICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkKICAgICAgcmV0dXJuIHRoaXMuJCRzdGF0ZTsKCiAgICBpZiAoTG9jYXRpb24gIT09IExvY2F0aW9uSHRtbDVVcmwgfHwgIXRoaXMuJCRodG1sNSkgewogICAgICB0aHJvdyAkbG9jYXRpb25NaW5FcnIoJ25vc3RhdGUnLCAnSGlzdG9yeSBBUEkgc3RhdGUgc3VwcG9ydCBpcyBhdmFpbGFibGUgb25seSAnICsKICAgICAgICAnaW4gSFRNTDUgbW9kZSBhbmQgb25seSBpbiBicm93c2VycyBzdXBwb3J0aW5nIEhUTUw1IEhpc3RvcnkgQVBJJyk7CiAgICB9CiAgICAvLyBUaGUgdXNlciBtaWdodCBtb2RpZnkgYHN0YXRlT2JqZWN0YCBhZnRlciBpbnZva2luZyBgJGxvY2F0aW9uLnN0YXRlKHN0YXRlT2JqZWN0KWAKICAgIC8vIGJ1dCB3ZSdyZSBjaGFuZ2luZyB0aGUgJCRzdGF0ZSByZWZlcmVuY2UgdG8gJGJyb3dzZXIuc3RhdGUoKSBkdXJpbmcgdGhlICRkaWdlc3QKICAgIC8vIHNvIHRoZSBtb2RpZmljYXRpb24gd2luZG93IGlzIG5hcnJvdy4KICAgIHRoaXMuJCRzdGF0ZSA9IGlzVW5kZWZpbmVkKHN0YXRlKSA/IG51bGwgOiBzdGF0ZTsKCiAgICByZXR1cm4gdGhpczsKICB9Owp9KTsKCgpmdW5jdGlvbiBsb2NhdGlvbkdldHRlcihwcm9wZXJ0eSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzW3Byb3BlcnR5XTsKICB9Owp9CgoKZnVuY3Rpb24gbG9jYXRpb25HZXR0ZXJTZXR0ZXIocHJvcGVydHksIHByZXByb2Nlc3MpIHsKICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpCiAgICAgIHJldHVybiB0aGlzW3Byb3BlcnR5XTsKCiAgICB0aGlzW3Byb3BlcnR5XSA9IHByZXByb2Nlc3ModmFsdWUpOwogICAgdGhpcy4kJGNvbXBvc2UoKTsKCiAgICByZXR1cm4gdGhpczsKICB9Owp9CgoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRsb2NhdGlvbgogKgogKiBAcmVxdWlyZXMgJHJvb3RFbGVtZW50CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgJGxvY2F0aW9uIHNlcnZpY2UgcGFyc2VzIHRoZSBVUkwgaW4gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIgKGJhc2VkIG9uIHRoZQogKiBbd2luZG93LmxvY2F0aW9uXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi93aW5kb3cubG9jYXRpb24pKSBhbmQgbWFrZXMgdGhlIFVSTAogKiBhdmFpbGFibGUgdG8geW91ciBhcHBsaWNhdGlvbi4gQ2hhbmdlcyB0byB0aGUgVVJMIGluIHRoZSBhZGRyZXNzIGJhciBhcmUgcmVmbGVjdGVkIGludG8KICogJGxvY2F0aW9uIHNlcnZpY2UgYW5kIGNoYW5nZXMgdG8gJGxvY2F0aW9uIGFyZSByZWZsZWN0ZWQgaW50byB0aGUgYnJvd3NlciBhZGRyZXNzIGJhci4KICoKICogKipUaGUgJGxvY2F0aW9uIHNlcnZpY2U6KioKICoKICogLSBFeHBvc2VzIHRoZSBjdXJyZW50IFVSTCBpbiB0aGUgYnJvd3NlciBhZGRyZXNzIGJhciwgc28geW91IGNhbgogKiAgIC0gV2F0Y2ggYW5kIG9ic2VydmUgdGhlIFVSTC4KICogICAtIENoYW5nZSB0aGUgVVJMLgogKiAtIFN5bmNocm9uaXplcyB0aGUgVVJMIHdpdGggdGhlIGJyb3dzZXIgd2hlbiB0aGUgdXNlcgogKiAgIC0gQ2hhbmdlcyB0aGUgYWRkcmVzcyBiYXIuCiAqICAgLSBDbGlja3MgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gKG9yIGNsaWNrcyBhIEhpc3RvcnkgbGluaykuCiAqICAgLSBDbGlja3Mgb24gYSBsaW5rLgogKiAtIFJlcHJlc2VudHMgdGhlIFVSTCBvYmplY3QgYXMgYSBzZXQgb2YgbWV0aG9kcyAocHJvdG9jb2wsIGhvc3QsIHBvcnQsIHBhdGgsIHNlYXJjaCwgaGFzaCkuCiAqCiAqIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSB7QGxpbmsgZ3VpZGUvJGxvY2F0aW9uIERldmVsb3BlciBHdWlkZTogVXNpbmcgJGxvY2F0aW9ufQogKi8KCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJGxvY2F0aW9uUHJvdmlkZXIKICogQGRlc2NyaXB0aW9uCiAqIFVzZSB0aGUgYCRsb2NhdGlvblByb3ZpZGVyYCB0byBjb25maWd1cmUgaG93IHRoZSBhcHBsaWNhdGlvbiBkZWVwIGxpbmtpbmcgcGF0aHMgYXJlIHN0b3JlZC4KICovCmZ1bmN0aW9uICRMb2NhdGlvblByb3ZpZGVyKCl7CiAgdmFyIGhhc2hQcmVmaXggPSAnJywKICAgICAgaHRtbDVNb2RlID0gewogICAgICAgIGVuYWJsZWQ6IGZhbHNlLAogICAgICAgIHJlcXVpcmVCYXNlOiB0cnVlLAogICAgICAgIHJld3JpdGVMaW5rczogdHJ1ZQogICAgICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uUHJvdmlkZXIjaGFzaFByZWZpeAogICAqIEBkZXNjcmlwdGlvbgogICAqIEBwYXJhbSB7c3RyaW5nPX0gcHJlZml4IFByZWZpeCBmb3IgaGFzaCBwYXJ0IChjb250YWluaW5nIHBhdGggYW5kIHNlYXJjaCkKICAgKiBAcmV0dXJucyB7Kn0gY3VycmVudCB2YWx1ZSBpZiB1c2VkIGFzIGdldHRlciBvciBpdHNlbGYgKGNoYWluaW5nKSBpZiB1c2VkIGFzIHNldHRlcgogICAqLwogIHRoaXMuaGFzaFByZWZpeCA9IGZ1bmN0aW9uKHByZWZpeCkgewogICAgaWYgKGlzRGVmaW5lZChwcmVmaXgpKSB7CiAgICAgIGhhc2hQcmVmaXggPSBwcmVmaXg7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGhhc2hQcmVmaXg7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2NhdGlvblByb3ZpZGVyI2h0bWw1TW9kZQogICAqIEBkZXNjcmlwdGlvbgogICAqIEBwYXJhbSB7KGJvb2xlYW58T2JqZWN0KT19IG1vZGUgSWYgYm9vbGVhbiwgc2V0cyBgaHRtbDVNb2RlLmVuYWJsZWRgIHRvIHZhbHVlLgogICAqICAgSWYgb2JqZWN0LCBzZXRzIGBlbmFibGVkYCwgYHJlcXVpcmVCYXNlYCBhbmQgYHJld3JpdGVMaW5rc2AgdG8gcmVzcGVjdGl2ZSB2YWx1ZXMuIFN1cHBvcnRlZAogICAqICAgcHJvcGVydGllczoKICAgKiAgIC0gKiplbmFibGVkKiog4oCTIGB7Ym9vbGVhbn1gIOKAkyAoZGVmYXVsdDogZmFsc2UpIElmIHRydWUsIHdpbGwgcmVseSBvbiBgaGlzdG9yeS5wdXNoU3RhdGVgIHRvCiAgICogICAgIGNoYW5nZSB1cmxzIHdoZXJlIHN1cHBvcnRlZC4gV2lsbCBmYWxsIGJhY2sgdG8gaGFzaC1wcmVmaXhlZCBwYXRocyBpbiBicm93c2VycyB0aGF0IGRvIG5vdAogICAqICAgICBzdXBwb3J0IGBwdXNoU3RhdGVgLgogICAqICAgLSAqKnJlcXVpcmVCYXNlKiogLSBge2Jvb2xlYW59YCAtIChkZWZhdWx0OiBgdHJ1ZWApIFdoZW4gaHRtbDVNb2RlIGlzIGVuYWJsZWQsIHNwZWNpZmllcwogICAqICAgICB3aGV0aGVyIG9yIG5vdCBhIDxiYXNlPiB0YWcgaXMgcmVxdWlyZWQgdG8gYmUgcHJlc2VudC4gSWYgYGVuYWJsZWRgIGFuZCBgcmVxdWlyZUJhc2VgIGFyZQogICAqICAgICB0cnVlLCBhbmQgYSBiYXNlIHRhZyBpcyBub3QgcHJlc2VudCwgYW4gZXJyb3Igd2lsbCBiZSB0aHJvd24gd2hlbiBgJGxvY2F0aW9uYCBpcyBpbmplY3RlZC4KICAgKiAgICAgU2VlIHRoZSB7QGxpbmsgZ3VpZGUvJGxvY2F0aW9uICRsb2NhdGlvbiBndWlkZSBmb3IgbW9yZSBpbmZvcm1hdGlvbn0KICAgKiAgIC0gKipyZXdyaXRlTGlua3MqKiAtIGB7Ym9vbGVhbn1gIC0gKGRlZmF1bHQ6IGB0cnVlYCkgV2hlbiBodG1sNU1vZGUgaXMgZW5hYmxlZCwKICAgKiAgICAgZW5hYmxlcy9kaXNhYmxlcyB1cmwgcmV3cml0aW5nIGZvciByZWxhdGl2ZSBsaW5rcy4KICAgKgogICAqIEByZXR1cm5zIHtPYmplY3R9IGh0bWw1TW9kZSBvYmplY3QgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgKi8KICB0aGlzLmh0bWw1TW9kZSA9IGZ1bmN0aW9uKG1vZGUpIHsKICAgIGlmIChpc0Jvb2xlYW4obW9kZSkpIHsKICAgICAgaHRtbDVNb2RlLmVuYWJsZWQgPSBtb2RlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSBpZiAoaXNPYmplY3QobW9kZSkpIHsKCiAgICAgIGlmIChpc0Jvb2xlYW4obW9kZS5lbmFibGVkKSkgewogICAgICAgIGh0bWw1TW9kZS5lbmFibGVkID0gbW9kZS5lbmFibGVkOwogICAgICB9CgogICAgICBpZiAoaXNCb29sZWFuKG1vZGUucmVxdWlyZUJhc2UpKSB7CiAgICAgICAgaHRtbDVNb2RlLnJlcXVpcmVCYXNlID0gbW9kZS5yZXF1aXJlQmFzZTsKICAgICAgfQoKICAgICAgaWYgKGlzQm9vbGVhbihtb2RlLnJld3JpdGVMaW5rcykpIHsKICAgICAgICBodG1sNU1vZGUucmV3cml0ZUxpbmtzID0gbW9kZS5yZXdyaXRlTGlua3M7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGh0bWw1TW9kZTsKICAgIH0KICB9OwoKICAvKioKICAgKiBAbmdkb2MgZXZlbnQKICAgKiBAbmFtZSAkbG9jYXRpb24jJGxvY2F0aW9uQ2hhbmdlU3RhcnQKICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICogQGRlc2NyaXB0aW9uCiAgICogQnJvYWRjYXN0ZWQgYmVmb3JlIGEgVVJMIHdpbGwgY2hhbmdlLgogICAqCiAgICogVGhpcyBjaGFuZ2UgY2FuIGJlIHByZXZlbnRlZCBieSBjYWxsaW5nCiAgICogYHByZXZlbnREZWZhdWx0YCBtZXRob2Qgb2YgdGhlIGV2ZW50LiBTZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufSBmb3IgbW9yZQogICAqIGRldGFpbHMgYWJvdXQgZXZlbnQgb2JqZWN0LiBVcG9uIHN1Y2Nlc3NmdWwgY2hhbmdlCiAgICoge0BsaW5rIG5nLiRsb2NhdGlvbiMkbG9jYXRpb25DaGFuZ2VTdWNjZXNzICRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3N9IGlzIGZpcmVkLgogICAqCiAgICogVGhlIGBuZXdTdGF0ZWAgYW5kIGBvbGRTdGF0ZWAgcGFyYW1ldGVycyBtYXkgYmUgZGVmaW5lZCBvbmx5IGluIEhUTUw1IG1vZGUgYW5kIHdoZW4KICAgKiB0aGUgYnJvd3NlciBzdXBwb3J0cyB0aGUgSFRNTDUgSGlzdG9yeSBBUEkuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gYW5ndWxhckV2ZW50IFN5bnRoZXRpYyBldmVudCBvYmplY3QuCiAgICogQHBhcmFtIHtzdHJpbmd9IG5ld1VybCBOZXcgVVJMCiAgICogQHBhcmFtIHtzdHJpbmc9fSBvbGRVcmwgVVJMIHRoYXQgd2FzIGJlZm9yZSBpdCB3YXMgY2hhbmdlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5ld1N0YXRlIE5ldyBoaXN0b3J5IHN0YXRlIG9iamVjdAogICAqIEBwYXJhbSB7c3RyaW5nPX0gb2xkU3RhdGUgSGlzdG9yeSBzdGF0ZSBvYmplY3QgdGhhdCB3YXMgYmVmb3JlIGl0IHdhcyBjaGFuZ2VkLgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgZXZlbnQKICAgKiBAbmFtZSAkbG9jYXRpb24jJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcwogICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgKiBAZGVzY3JpcHRpb24KICAgKiBCcm9hZGNhc3RlZCBhZnRlciBhIFVSTCB3YXMgY2hhbmdlZC4KICAgKgogICAqIFRoZSBgbmV3U3RhdGVgIGFuZCBgb2xkU3RhdGVgIHBhcmFtZXRlcnMgbWF5IGJlIGRlZmluZWQgb25seSBpbiBIVE1MNSBtb2RlIGFuZCB3aGVuCiAgICogdGhlIGJyb3dzZXIgc3VwcG9ydHMgdGhlIEhUTUw1IEhpc3RvcnkgQVBJLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGFuZ3VsYXJFdmVudCBTeW50aGV0aWMgZXZlbnQgb2JqZWN0LgogICAqIEBwYXJhbSB7c3RyaW5nfSBuZXdVcmwgTmV3IFVSTAogICAqIEBwYXJhbSB7c3RyaW5nPX0gb2xkVXJsIFVSTCB0aGF0IHdhcyBiZWZvcmUgaXQgd2FzIGNoYW5nZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZXdTdGF0ZSBOZXcgaGlzdG9yeSBzdGF0ZSBvYmplY3QKICAgKiBAcGFyYW0ge3N0cmluZz19IG9sZFN0YXRlIEhpc3Rvcnkgc3RhdGUgb2JqZWN0IHRoYXQgd2FzIGJlZm9yZSBpdCB3YXMgY2hhbmdlZC4KICAgKi8KCiAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRicm93c2VyJywgJyRzbmlmZmVyJywgJyRyb290RWxlbWVudCcsCiAgICAgIGZ1bmN0aW9uKCAkcm9vdFNjb3BlLCAgICRicm93c2VyLCAgICRzbmlmZmVyLCAgICRyb290RWxlbWVudCkgewogICAgdmFyICRsb2NhdGlvbiwKICAgICAgICBMb2NhdGlvbk1vZGUsCiAgICAgICAgYmFzZUhyZWYgPSAkYnJvd3Nlci5iYXNlSHJlZigpLCAvLyBpZiBiYXNlW2hyZWZdIGlzIHVuZGVmaW5lZCwgaXQgZGVmYXVsdHMgdG8gJycKICAgICAgICBpbml0aWFsVXJsID0gJGJyb3dzZXIudXJsKCksCiAgICAgICAgYXBwQmFzZTsKCiAgICBpZiAoaHRtbDVNb2RlLmVuYWJsZWQpIHsKICAgICAgaWYgKCFiYXNlSHJlZiAmJiBodG1sNU1vZGUucmVxdWlyZUJhc2UpIHsKICAgICAgICB0aHJvdyAkbG9jYXRpb25NaW5FcnIoJ25vYmFzZScsCiAgICAgICAgICAiJGxvY2F0aW9uIGluIEhUTUw1IG1vZGUgcmVxdWlyZXMgYSA8YmFzZT4gdGFnIHRvIGJlIHByZXNlbnQhIik7CiAgICAgIH0KICAgICAgYXBwQmFzZSA9IHNlcnZlckJhc2UoaW5pdGlhbFVybCkgKyAoYmFzZUhyZWYgfHwgJy8nKTsKICAgICAgTG9jYXRpb25Nb2RlID0gJHNuaWZmZXIuaGlzdG9yeSA/IExvY2F0aW9uSHRtbDVVcmwgOiBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybDsKICAgIH0gZWxzZSB7CiAgICAgIGFwcEJhc2UgPSBzdHJpcEhhc2goaW5pdGlhbFVybCk7CiAgICAgIExvY2F0aW9uTW9kZSA9IExvY2F0aW9uSGFzaGJhbmdVcmw7CiAgICB9CiAgICAkbG9jYXRpb24gPSBuZXcgTG9jYXRpb25Nb2RlKGFwcEJhc2UsICcjJyArIGhhc2hQcmVmaXgpOwogICAgJGxvY2F0aW9uLiQkcGFyc2VMaW5rVXJsKGluaXRpYWxVcmwsIGluaXRpYWxVcmwpOwoKICAgICRsb2NhdGlvbi4kJHN0YXRlID0gJGJyb3dzZXIuc3RhdGUoKTsKCiAgICB2YXIgSUdOT1JFX1VSSV9SRUdFWFAgPSAvXlxzKihqYXZhc2NyaXB0fG1haWx0byk6L2k7CgogICAgZnVuY3Rpb24gc2V0QnJvd3NlclVybFdpdGhGYWxsYmFjayh1cmwsIHJlcGxhY2UsIHN0YXRlKSB7CiAgICAgIHZhciBvbGRVcmwgPSAkbG9jYXRpb24udXJsKCk7CiAgICAgIHZhciBvbGRTdGF0ZSA9ICRsb2NhdGlvbi4kJHN0YXRlOwogICAgICB0cnkgewogICAgICAgICRicm93c2VyLnVybCh1cmwsIHJlcGxhY2UsIHN0YXRlKTsKCiAgICAgICAgLy8gTWFrZSBzdXJlICRsb2NhdGlvbi5zdGF0ZSgpIHJldHVybnMgcmVmZXJlbnRpYWxseSBpZGVudGljYWwgKG5vdCBqdXN0IGRlZXBseSBlcXVhbCkKICAgICAgICAvLyBzdGF0ZSBvYmplY3Q7IHRoaXMgbWFrZXMgcG9zc2libGUgcXVpY2sgY2hlY2tpbmcgaWYgdGhlIHN0YXRlIGNoYW5nZWQgaW4gdGhlIGRpZ2VzdAogICAgICAgIC8vIGxvb3AuIENoZWNraW5nIGRlZXAgZXF1YWxpdHkgd291bGQgYmUgdG9vIGV4cGVuc2l2ZS4KICAgICAgICAkbG9jYXRpb24uJCRzdGF0ZSA9ICRicm93c2VyLnN0YXRlKCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAvLyBSZXN0b3JlIG9sZCB2YWx1ZXMgaWYgcHVzaFN0YXRlIGZhaWxzCiAgICAgICAgJGxvY2F0aW9uLnVybChvbGRVcmwpOwogICAgICAgICRsb2NhdGlvbi4kJHN0YXRlID0gb2xkU3RhdGU7CgogICAgICAgIHRocm93IGU7CiAgICAgIH0KICAgIH0KCiAgICAkcm9vdEVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgLy8gVE9ETyh2b2p0YSk6IHJld3JpdGUgbGluayB3aGVuIG9wZW5pbmcgaW4gbmV3IHRhYi93aW5kb3cgKGluIGxlZ2FjeSBicm93c2VyKQogICAgICAvLyBjdXJyZW50bHkgd2Ugb3BlbiBuaWNlIHVybCBsaW5rIGFuZCByZWRpcmVjdCB0aGVuCgogICAgICBpZiAoIWh0bWw1TW9kZS5yZXdyaXRlTGlua3MgfHwgZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5IHx8IGV2ZW50LndoaWNoID09IDIpIHJldHVybjsKCiAgICAgIHZhciBlbG0gPSBqcUxpdGUoZXZlbnQudGFyZ2V0KTsKCiAgICAgIC8vIHRyYXZlcnNlIHRoZSBET00gdXAgdG8gZmluZCBmaXJzdCBBIHRhZwogICAgICB3aGlsZSAobm9kZU5hbWVfKGVsbVswXSkgIT09ICdhJykgewogICAgICAgIC8vIGlnbm9yZSByZXdyaXRpbmcgaWYgbm8gQSB0YWcgKHJlYWNoZWQgcm9vdCBlbGVtZW50LCBvciBubyBwYXJlbnQgLSByZW1vdmVkIGZyb20gZG9jdW1lbnQpCiAgICAgICAgaWYgKGVsbVswXSA9PT0gJHJvb3RFbGVtZW50WzBdIHx8ICEoZWxtID0gZWxtLnBhcmVudCgpKVswXSkgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgYWJzSHJlZiA9IGVsbS5wcm9wKCdocmVmJyk7CiAgICAgIC8vIGdldCB0aGUgYWN0dWFsIGhyZWYgYXR0cmlidXRlIC0gc2VlCiAgICAgIC8vIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9kZDM0NzE0OCh2PXZzLjg1KS5hc3B4CiAgICAgIHZhciByZWxIcmVmID0gZWxtLmF0dHIoJ2hyZWYnKSB8fCBlbG0uYXR0cigneGxpbms6aHJlZicpOwoKICAgICAgaWYgKGlzT2JqZWN0KGFic0hyZWYpICYmIGFic0hyZWYudG9TdHJpbmcoKSA9PT0gJ1tvYmplY3QgU1ZHQW5pbWF0ZWRTdHJpbmddJykgewogICAgICAgIC8vIFNWR0FuaW1hdGVkU3RyaW5nLmFuaW1WYWwgc2hvdWxkIGJlIGlkZW50aWNhbCB0byBTVkdBbmltYXRlZFN0cmluZy5iYXNlVmFsLCB1bmxlc3MgZHVyaW5nCiAgICAgICAgLy8gYW4gYW5pbWF0aW9uLgogICAgICAgIGFic0hyZWYgPSB1cmxSZXNvbHZlKGFic0hyZWYuYW5pbVZhbCkuaHJlZjsKICAgICAgfQoKICAgICAgLy8gSWdub3JlIHdoZW4gdXJsIGlzIHN0YXJ0ZWQgd2l0aCBqYXZhc2NyaXB0OiBvciBtYWlsdG86CiAgICAgIGlmIChJR05PUkVfVVJJX1JFR0VYUC50ZXN0KGFic0hyZWYpKSByZXR1cm47CgogICAgICBpZiAoYWJzSHJlZiAmJiAhZWxtLmF0dHIoJ3RhcmdldCcpICYmICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgewogICAgICAgIGlmICgkbG9jYXRpb24uJCRwYXJzZUxpbmtVcmwoYWJzSHJlZiwgcmVsSHJlZikpIHsKICAgICAgICAgIC8vIFdlIGRvIGEgcHJldmVudERlZmF1bHQgZm9yIGFsbCB1cmxzIHRoYXQgYXJlIHBhcnQgb2YgdGhlIGFuZ3VsYXIgYXBwbGljYXRpb24sCiAgICAgICAgICAvLyBpbiBodG1sNW1vZGUgYW5kIGFsc28gd2l0aG91dCwgc28gdGhhdCB3ZSBhcmUgYWJsZSB0byBhYm9ydCBuYXZpZ2F0aW9uIHdpdGhvdXQKICAgICAgICAgIC8vIGdldHRpbmcgZG91YmxlIGVudHJpZXMgaW4gdGhlIGxvY2F0aW9uIGhpc3RvcnkuCiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgLy8gdXBkYXRlIGxvY2F0aW9uIG1hbnVhbGx5CiAgICAgICAgICBpZiAoJGxvY2F0aW9uLmFic1VybCgpICE9ICRicm93c2VyLnVybCgpKSB7CiAgICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5KCk7CiAgICAgICAgICAgIC8vIGhhY2sgdG8gd29yayBhcm91bmQgRkY2IGJ1ZyA2ODQyMDggd2hlbiBzY2VuYXJpbyBydW5uZXIgY2xpY2tzIG9uIGxpbmtzCiAgICAgICAgICAgIHdpbmRvdy5hbmd1bGFyWydmZi02ODQyMDgtcHJldmVudERlZmF1bHQnXSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCgogICAgLy8gcmV3cml0ZSBoYXNoYmFuZyB1cmwgPD4gaHRtbDUgdXJsCiAgICBpZiAoJGxvY2F0aW9uLmFic1VybCgpICE9IGluaXRpYWxVcmwpIHsKICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSwgdHJ1ZSk7CiAgICB9CgogICAgdmFyIGluaXRpYWxpemluZyA9IHRydWU7CgogICAgLy8gdXBkYXRlICRsb2NhdGlvbiB3aGVuICRicm93c2VyIHVybCBjaGFuZ2VzCiAgICAkYnJvd3Nlci5vblVybENoYW5nZShmdW5jdGlvbihuZXdVcmwsIG5ld1N0YXRlKSB7CiAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbigpIHsKICAgICAgICB2YXIgb2xkVXJsID0gJGxvY2F0aW9uLmFic1VybCgpOwogICAgICAgIHZhciBvbGRTdGF0ZSA9ICRsb2NhdGlvbi4kJHN0YXRlOwoKICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShuZXdVcmwpOwogICAgICAgICRsb2NhdGlvbi4kJHN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgaWYgKCRyb290U2NvcGUuJGJyb2FkY2FzdCgnJGxvY2F0aW9uQ2hhbmdlU3RhcnQnLCBuZXdVcmwsIG9sZFVybCwKICAgICAgICAgICAgbmV3U3RhdGUsIG9sZFN0YXRlKS5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShvbGRVcmwpOwogICAgICAgICAgJGxvY2F0aW9uLiQkc3RhdGUgPSBvbGRTdGF0ZTsKICAgICAgICAgIHNldEJyb3dzZXJVcmxXaXRoRmFsbGJhY2sob2xkVXJsLCBmYWxzZSwgb2xkU3RhdGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpbml0aWFsaXppbmcgPSBmYWxzZTsKICAgICAgICAgIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsLCBvbGRTdGF0ZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UpICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgfSk7CgogICAgLy8gdXBkYXRlIGJyb3dzZXIKICAgICRyb290U2NvcGUuJHdhdGNoKGZ1bmN0aW9uICRsb2NhdGlvbldhdGNoKCkgewogICAgICB2YXIgb2xkVXJsID0gJGJyb3dzZXIudXJsKCk7CiAgICAgIHZhciBvbGRTdGF0ZSA9ICRicm93c2VyLnN0YXRlKCk7CiAgICAgIHZhciBjdXJyZW50UmVwbGFjZSA9ICRsb2NhdGlvbi4kJHJlcGxhY2U7CiAgICAgIHZhciB1cmxPclN0YXRlQ2hhbmdlZCA9IG9sZFVybCAhPT0gJGxvY2F0aW9uLmFic1VybCgpIHx8CiAgICAgICAgKCRsb2NhdGlvbi4kJGh0bWw1ICYmICRzbmlmZmVyLmhpc3RvcnkgJiYgb2xkU3RhdGUgIT09ICRsb2NhdGlvbi4kJHN0YXRlKTsKCiAgICAgIGlmIChpbml0aWFsaXppbmcgfHwgdXJsT3JTdGF0ZUNoYW5nZWQpIHsKICAgICAgICBpbml0aWFsaXppbmcgPSBmYWxzZTsKCiAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKCRyb290U2NvcGUuJGJyb2FkY2FzdCgnJGxvY2F0aW9uQ2hhbmdlU3RhcnQnLCAkbG9jYXRpb24uYWJzVXJsKCksIG9sZFVybCwKICAgICAgICAgICAgICAkbG9jYXRpb24uJCRzdGF0ZSwgb2xkU3RhdGUpLmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2Uob2xkVXJsKTsKICAgICAgICAgICAgJGxvY2F0aW9uLiQkc3RhdGUgPSBvbGRTdGF0ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh1cmxPclN0YXRlQ2hhbmdlZCkgewogICAgICAgICAgICAgIHNldEJyb3dzZXJVcmxXaXRoRmFsbGJhY2soJGxvY2F0aW9uLmFic1VybCgpLCBjdXJyZW50UmVwbGFjZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZFN0YXRlID09PSAkbG9jYXRpb24uJCRzdGF0ZSA/IG51bGwgOiAkbG9jYXRpb24uJCRzdGF0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWZ0ZXJMb2NhdGlvbkNoYW5nZShvbGRVcmwsIG9sZFN0YXRlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgJGxvY2F0aW9uLiQkcmVwbGFjZSA9IGZhbHNlOwoKICAgICAgLy8gd2UgZG9uJ3QgbmVlZCB0byByZXR1cm4gYW55dGhpbmcgYmVjYXVzZSAkZXZhbEFzeW5jIHdpbGwgbWFrZSB0aGUgZGlnZXN0IGxvb3AgZGlydHkgd2hlbgogICAgICAvLyB0aGVyZSBpcyBhIGNoYW5nZQogICAgfSk7CgogICAgcmV0dXJuICRsb2NhdGlvbjsKCiAgICBmdW5jdGlvbiBhZnRlckxvY2F0aW9uQ2hhbmdlKG9sZFVybCwgb2xkU3RhdGUpIHsKICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdWNjZXNzJywgJGxvY2F0aW9uLmFic1VybCgpLCBvbGRVcmwsCiAgICAgICAgJGxvY2F0aW9uLiQkc3RhdGUsIG9sZFN0YXRlKTsKICAgIH0KfV07Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkbG9nCiAqIEByZXF1aXJlcyAkd2luZG93CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTaW1wbGUgc2VydmljZSBmb3IgbG9nZ2luZy4gRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBzYWZlbHkgd3JpdGVzIHRoZSBtZXNzYWdlCiAqIGludG8gdGhlIGJyb3dzZXIncyBjb25zb2xlIChpZiBwcmVzZW50KS4KICoKICogVGhlIG1haW4gcHVycG9zZSBvZiB0aGlzIHNlcnZpY2UgaXMgdG8gc2ltcGxpZnkgZGVidWdnaW5nIGFuZCB0cm91Ymxlc2hvb3RpbmcuCiAqCiAqIFRoZSBkZWZhdWx0IGlzIHRvIGxvZyBgZGVidWdgIG1lc3NhZ2VzLiBZb3UgY2FuIHVzZQogKiB7QGxpbmsgbmcuJGxvZ1Byb3ZpZGVyIG5nLiRsb2dQcm92aWRlciNkZWJ1Z0VuYWJsZWR9IHRvIGNoYW5nZSB0aGlzLgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9ImxvZ0V4YW1wbGUiPgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgICBhbmd1bGFyLm1vZHVsZSgnbG9nRXhhbXBsZScsIFtdKQogICAgICAgICAuY29udHJvbGxlcignTG9nQ29udHJvbGxlcicsIFsnJHNjb3BlJywgJyRsb2cnLCBmdW5jdGlvbigkc2NvcGUsICRsb2cpIHsKICAgICAgICAgICAkc2NvcGUuJGxvZyA9ICRsb2c7CiAgICAgICAgICAgJHNjb3BlLm1lc3NhZ2UgPSAnSGVsbG8gV29ybGQhJzsKICAgICAgICAgfV0pOwogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iTG9nQ29udHJvbGxlciI+CiAgICAgICAgIDxwPlJlbG9hZCB0aGlzIHBhZ2Ugd2l0aCBvcGVuIGNvbnNvbGUsIGVudGVyIHRleHQgYW5kIGhpdCB0aGUgbG9nIGJ1dHRvbi4uLjwvcD4KICAgICAgICAgTWVzc2FnZToKICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJtZXNzYWdlIi8+CiAgICAgICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cubG9nKG1lc3NhZ2UpIj5sb2c8L2J1dHRvbj4KICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJGxvZy53YXJuKG1lc3NhZ2UpIj53YXJuPC9idXR0b24+CiAgICAgICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cuaW5mbyhtZXNzYWdlKSI+aW5mbzwvYnV0dG9uPgogICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmVycm9yKG1lc3NhZ2UpIj5lcnJvcjwvYnV0dG9uPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkbG9nUHJvdmlkZXIKICogQGRlc2NyaXB0aW9uCiAqIFVzZSB0aGUgYCRsb2dQcm92aWRlcmAgdG8gY29uZmlndXJlIGhvdyB0aGUgYXBwbGljYXRpb24gbG9ncyBtZXNzYWdlcwogKi8KZnVuY3Rpb24gJExvZ1Byb3ZpZGVyKCl7CiAgdmFyIGRlYnVnID0gdHJ1ZSwKICAgICAgc2VsZiA9IHRoaXM7CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkbG9nUHJvdmlkZXIjZGVidWdFbmFibGVkCiAgICogQGRlc2NyaXB0aW9uCiAgICogQHBhcmFtIHtib29sZWFuPX0gZmxhZyBlbmFibGUgb3IgZGlzYWJsZSBkZWJ1ZyBsZXZlbCBtZXNzYWdlcwogICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICovCiAgdGhpcy5kZWJ1Z0VuYWJsZWQgPSBmdW5jdGlvbihmbGFnKSB7CiAgICBpZiAoaXNEZWZpbmVkKGZsYWcpKSB7CiAgICAgIGRlYnVnID0gZmxhZzsKICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGRlYnVnOwogICAgfQogIH07CgogIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsIGZ1bmN0aW9uKCR3aW5kb3cpewogICAgcmV0dXJuIHsKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGxvZyNsb2cKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFdyaXRlIGEgbG9nIG1lc3NhZ2UKICAgICAgICovCiAgICAgIGxvZzogY29uc29sZUxvZygnbG9nJyksCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkbG9nI2luZm8KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFdyaXRlIGFuIGluZm9ybWF0aW9uIG1lc3NhZ2UKICAgICAgICovCiAgICAgIGluZm86IGNvbnNvbGVMb2coJ2luZm8nKSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRsb2cjd2FybgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogV3JpdGUgYSB3YXJuaW5nIG1lc3NhZ2UKICAgICAgICovCiAgICAgIHdhcm46IGNvbnNvbGVMb2coJ3dhcm4nKSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRsb2cjZXJyb3IKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFdyaXRlIGFuIGVycm9yIG1lc3NhZ2UKICAgICAgICovCiAgICAgIGVycm9yOiBjb25zb2xlTG9nKCdlcnJvcicpLAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGxvZyNkZWJ1ZwogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogV3JpdGUgYSBkZWJ1ZyBtZXNzYWdlCiAgICAgICAqLwogICAgICBkZWJ1ZzogKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZm4gPSBjb25zb2xlTG9nKCdkZWJ1ZycpOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoZGVidWcpIHsKICAgICAgICAgICAgZm4uYXBwbHkoc2VsZiwgYXJndW1lbnRzKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9KCkpCiAgICB9OwoKICAgIGZ1bmN0aW9uIGZvcm1hdEVycm9yKGFyZykgewogICAgICBpZiAoYXJnIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICBpZiAoYXJnLnN0YWNrKSB7CiAgICAgICAgICBhcmcgPSAoYXJnLm1lc3NhZ2UgJiYgYXJnLnN0YWNrLmluZGV4T2YoYXJnLm1lc3NhZ2UpID09PSAtMSkKICAgICAgICAgICAgICA/ICdFcnJvcjogJyArIGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zdGFjawogICAgICAgICAgICAgIDogYXJnLnN0YWNrOwogICAgICAgIH0gZWxzZSBpZiAoYXJnLnNvdXJjZVVSTCkgewogICAgICAgICAgYXJnID0gYXJnLm1lc3NhZ2UgKyAnXG4nICsgYXJnLnNvdXJjZVVSTCArICc6JyArIGFyZy5saW5lOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYXJnOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbnNvbGVMb2codHlwZSkgewogICAgICB2YXIgY29uc29sZSA9ICR3aW5kb3cuY29uc29sZSB8fCB7fSwKICAgICAgICAgIGxvZ0ZuID0gY29uc29sZVt0eXBlXSB8fCBjb25zb2xlLmxvZyB8fCBub29wLAogICAgICAgICAgaGFzQXBwbHkgPSBmYWxzZTsKCiAgICAgIC8vIE5vdGU6IHJlYWRpbmcgbG9nRm4uYXBwbHkgdGhyb3dzIGFuIGVycm9yIGluIElFMTEgaW4gSUU4IGRvY3VtZW50IG1vZGUuCiAgICAgIC8vIFRoZSByZWFzb24gYmVoaW5kIHRoaXMgaXMgdGhhdCBjb25zb2xlLmxvZyBoYXMgdHlwZSAib2JqZWN0IiBpbiBJRTguLi4KICAgICAgdHJ5IHsKICAgICAgICBoYXNBcHBseSA9ICEhbG9nRm4uYXBwbHk7CiAgICAgIH0gY2F0Y2ggKGUpIHt9CgogICAgICBpZiAoaGFzQXBwbHkpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgICBhcmdzLnB1c2goZm9ybWF0RXJyb3IoYXJnKSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBsb2dGbi5hcHBseShjb25zb2xlLCBhcmdzKTsKICAgICAgICB9OwogICAgICB9CgogICAgICAvLyB3ZSBhcmUgSUUgd2hpY2ggZWl0aGVyIGRvZXNuJ3QgaGF2ZSB3aW5kb3cuY29uc29sZSA9PiB0aGlzIGlzIG5vb3AgYW5kIHdlIGRvIG5vdGhpbmcsCiAgICAgIC8vIG9yIHdlIGFyZSBJRSB3aGVyZSBjb25zb2xlLmxvZyBkb2Vzbid0IGhhdmUgYXBwbHkgc28gd2UgbG9nIGF0IGxlYXN0IGZpcnN0IDIgYXJncwogICAgICByZXR1cm4gZnVuY3Rpb24oYXJnMSwgYXJnMikgewogICAgICAgIGxvZ0ZuKGFyZzEsIGFyZzIgPT0gbnVsbCA/ICcnIDogYXJnMik7CiAgICAgIH07CiAgICB9CiAgfV07Cn0KCnZhciAkcGFyc2VNaW5FcnIgPSBtaW5FcnIoJyRwYXJzZScpOwoKLy8gU2FuZGJveGluZyBBbmd1bGFyIEV4cHJlc3Npb25zCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyBBbmd1bGFyIGV4cHJlc3Npb25zIGFyZSBnZW5lcmFsbHkgY29uc2lkZXJlZCBzYWZlIGJlY2F1c2UgdGhlc2UgZXhwcmVzc2lvbnMgb25seSBoYXZlIGRpcmVjdAovLyBhY2Nlc3MgdG8gJHNjb3BlIGFuZCBsb2NhbHMuIEhvd2V2ZXIsIG9uZSBjYW4gb2J0YWluIHRoZSBhYmlsaXR5IHRvIGV4ZWN1dGUgYXJiaXRyYXJ5IEpTIGNvZGUgYnkKLy8gb2J0YWluaW5nIGEgcmVmZXJlbmNlIHRvIG5hdGl2ZSBKUyBmdW5jdGlvbnMgc3VjaCBhcyB0aGUgRnVuY3Rpb24gY29uc3RydWN0b3IuCi8vCi8vIEFzIGFuIGV4YW1wbGUsIGNvbnNpZGVyIHRoZSBmb2xsb3dpbmcgQW5ndWxhciBleHByZXNzaW9uOgovLwovLyAgIHt9LnRvU3RyaW5nLmNvbnN0cnVjdG9yKCdhbGVydCgiZXZpbCBKUyBjb2RlIiknKQovLwovLyBUaGlzIHNhbmRib3hpbmcgdGVjaG5pcXVlIGlzIG5vdCBwZXJmZWN0IGFuZCBkb2Vzbid0IGFpbSB0byBiZS4gVGhlIGdvYWwgaXMgdG8gcHJldmVudCBleHBsb2l0cwovLyBhZ2FpbnN0IHRoZSBleHByZXNzaW9uIGxhbmd1YWdlLCBidXQgbm90IHRvIHByZXZlbnQgZXhwbG9pdHMgdGhhdCB3ZXJlIGVuYWJsZWQgYnkgZXhwb3NpbmcKLy8gc2Vuc2l0aXZlIEphdmFTY3JpcHQgb3IgYnJvd3NlciBhcGlzIG9uIFNjb3BlLiBFeHBvc2luZyBzdWNoIG9iamVjdHMgb24gYSBTY29wZSBpcyBuZXZlciBhIGdvb2QKLy8gcHJhY3RpY2UgYW5kIHRoZXJlZm9yZSB3ZSBhcmUgbm90IGV2ZW4gdHJ5aW5nIHRvIHByb3RlY3QgYWdhaW5zdCBpbnRlcmFjdGlvbiB3aXRoIGFuIG9iamVjdAovLyBleHBsaWNpdGx5IGV4cG9zZWQgaW4gdGhpcyB3YXkuCi8vCi8vIEluIGdlbmVyYWwsIGl0IGlzIG5vdCBwb3NzaWJsZSB0byBhY2Nlc3MgYSBXaW5kb3cgb2JqZWN0IGZyb20gYW4gYW5ndWxhciBleHByZXNzaW9uIHVubGVzcyBhCi8vIHdpbmRvdyBvciBzb21lIERPTSBvYmplY3QgdGhhdCBoYXMgYSByZWZlcmVuY2UgdG8gd2luZG93IGlzIHB1Ymxpc2hlZCBvbnRvIGEgU2NvcGUuCi8vIFNpbWlsYXJseSB3ZSBwcmV2ZW50IGludm9jYXRpb25zIG9mIGZ1bmN0aW9uIGtub3duIHRvIGJlIGRhbmdlcm91cywgYXMgd2VsbCBhcyBhc3NpZ25tZW50cyB0bwovLyBuYXRpdmUgb2JqZWN0cy4KCgpmdW5jdGlvbiBlbnN1cmVTYWZlTWVtYmVyTmFtZShuYW1lLCBmdWxsRXhwcmVzc2lvbikgewogIGlmIChuYW1lID09PSAiX19kZWZpbmVHZXR0ZXJfXyIgfHwgbmFtZSA9PT0gIl9fZGVmaW5lU2V0dGVyX18iCiAgICAgIHx8IG5hbWUgPT09ICJfX2xvb2t1cEdldHRlcl9fIiB8fCBuYW1lID09PSAiX19sb29rdXBTZXR0ZXJfXyIKICAgICAgfHwgbmFtZSA9PT0gIl9fcHJvdG9fXyIpIHsKICAgIHRocm93ICRwYXJzZU1pbkVycignaXNlY2ZsZCcsCiAgICAgICAgJ0F0dGVtcHRpbmcgdG8gYWNjZXNzIGEgZGlzYWxsb3dlZCBmaWVsZCBpbiBBbmd1bGFyIGV4cHJlc3Npb25zISAnCiAgICAgICAgKydFeHByZXNzaW9uOiB7MH0nLCBmdWxsRXhwcmVzc2lvbik7CiAgfQogIHJldHVybiBuYW1lOwp9CgpmdW5jdGlvbiBlbnN1cmVTYWZlT2JqZWN0KG9iaiwgZnVsbEV4cHJlc3Npb24pIHsKICAvLyBuaWZ0eSBjaGVjayBpZiBvYmogaXMgRnVuY3Rpb24gdGhhdCBpcyBmYXN0IGFuZCB3b3JrcyBhY3Jvc3MgaWZyYW1lcyBhbmQgb3RoZXIgY29udGV4dHMKICBpZiAob2JqKSB7CiAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBvYmopIHsKICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdpc2VjZm4nLAogICAgICAgICAgJ1JlZmVyZW5jaW5nIEZ1bmN0aW9uIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGlzYWxsb3dlZCEgRXhwcmVzc2lvbjogezB9JywKICAgICAgICAgIGZ1bGxFeHByZXNzaW9uKTsKICAgIH0gZWxzZSBpZiAoLy8gaXNXaW5kb3cob2JqKQogICAgICAgIG9iai53aW5kb3cgPT09IG9iaikgewogICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ2lzZWN3aW5kb3cnLAogICAgICAgICAgJ1JlZmVyZW5jaW5nIHRoZSBXaW5kb3cgaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLAogICAgICAgICAgZnVsbEV4cHJlc3Npb24pOwogICAgfSBlbHNlIGlmICgvLyBpc0VsZW1lbnQob2JqKQogICAgICAgIG9iai5jaGlsZHJlbiAmJiAob2JqLm5vZGVOYW1lIHx8IChvYmoucHJvcCAmJiBvYmouYXR0ciAmJiBvYmouZmluZCkpKSB7CiAgICAgIHRocm93ICRwYXJzZU1pbkVycignaXNlY2RvbScsCiAgICAgICAgICAnUmVmZXJlbmNpbmcgRE9NIG5vZGVzIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGlzYWxsb3dlZCEgRXhwcmVzc2lvbjogezB9JywKICAgICAgICAgIGZ1bGxFeHByZXNzaW9uKTsKICAgIH0gZWxzZSBpZiAoLy8gYmxvY2sgT2JqZWN0IHNvIHRoYXQgd2UgY2FuJ3QgZ2V0IGhvbGQgb2YgZGFuZ2Vyb3VzIE9iamVjdC4qIG1ldGhvZHMKICAgICAgICBvYmogPT09IE9iamVjdCkgewogICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ2lzZWNvYmonLAogICAgICAgICAgJ1JlZmVyZW5jaW5nIE9iamVjdCBpbiBBbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRpc2FsbG93ZWQhIEV4cHJlc3Npb246IHswfScsCiAgICAgICAgICBmdWxsRXhwcmVzc2lvbik7CiAgICB9CiAgfQogIHJldHVybiBvYmo7Cn0KCnZhciBDQUxMID0gRnVuY3Rpb24ucHJvdG90eXBlLmNhbGw7CnZhciBBUFBMWSA9IEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseTsKdmFyIEJJTkQgPSBGdW5jdGlvbi5wcm90b3R5cGUuYmluZDsKCmZ1bmN0aW9uIGVuc3VyZVNhZmVGdW5jdGlvbihvYmosIGZ1bGxFeHByZXNzaW9uKSB7CiAgaWYgKG9iaikgewogICAgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gb2JqKSB7CiAgICAgIHRocm93ICRwYXJzZU1pbkVycignaXNlY2ZuJywKICAgICAgICAnUmVmZXJlbmNpbmcgRnVuY3Rpb24gaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLAogICAgICAgIGZ1bGxFeHByZXNzaW9uKTsKICAgIH0gZWxzZSBpZiAob2JqID09PSBDQUxMIHx8IG9iaiA9PT0gQVBQTFkgfHwgb2JqID09PSBCSU5EKSB7CiAgICAgIHRocm93ICRwYXJzZU1pbkVycignaXNlY2ZmJywKICAgICAgICAnUmVmZXJlbmNpbmcgY2FsbCwgYXBwbHkgb3IgYmluZCBpbiBBbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRpc2FsbG93ZWQhIEV4cHJlc3Npb246IHswfScsCiAgICAgICAgZnVsbEV4cHJlc3Npb24pOwogICAgfQogIH0KfQoKLy9LZXl3b3JkIGNvbnN0YW50cwp2YXIgQ09OU1RBTlRTID0gY3JlYXRlTWFwKCk7CmZvckVhY2goewogICdudWxsJzogZnVuY3Rpb24oKSB7IHJldHVybiBudWxsOyB9LAogICd0cnVlJzogZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlOyB9LAogICdmYWxzZSc6IGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH0sCiAgJ3VuZGVmaW5lZCc6IGZ1bmN0aW9uKCkge30KfSwgZnVuY3Rpb24oY29uc3RhbnRHZXR0ZXIsIG5hbWUpIHsKICBjb25zdGFudEdldHRlci5jb25zdGFudCA9IGNvbnN0YW50R2V0dGVyLmxpdGVyYWwgPSBjb25zdGFudEdldHRlci5zaGFyZWRHZXR0ZXIgPSB0cnVlOwogIENPTlNUQU5UU1tuYW1lXSA9IGNvbnN0YW50R2V0dGVyOwp9KTsKCi8vTm90IHF1aXRlIGEgY29uc3RhbnQsIGJ1dCBjYW4gYmUgbGV4L3BhcnNlZCB0aGUgc2FtZQpDT05TVEFOVFNbJ3RoaXMnXSA9IGZ1bmN0aW9uKHNlbGYpIHsgcmV0dXJuIHNlbGY7IH07CkNPTlNUQU5UU1sndGhpcyddLnNoYXJlZEdldHRlciA9IHRydWU7CgoKLy9PcGVyYXRvcnMgLSB3aWxsIGJlIHdyYXBwZWQgYnkgYmluYXJ5Rm4vdW5hcnlGbi9hc3NpZ25tZW50L2ZpbHRlcgp2YXIgT1BFUkFUT1JTID0gZXh0ZW5kKGNyZWF0ZU1hcCgpLCB7CiAgICAnKyc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpewogICAgICBhPWEoc2VsZiwgbG9jYWxzKTsgYj1iKHNlbGYsIGxvY2Fscyk7CiAgICAgIGlmIChpc0RlZmluZWQoYSkpIHsKICAgICAgICBpZiAoaXNEZWZpbmVkKGIpKSB7CiAgICAgICAgICByZXR1cm4gYSArIGI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhOwogICAgICB9CiAgICAgIHJldHVybiBpc0RlZmluZWQoYik/Yjp1bmRlZmluZWQ7fSwKICAgICctJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7CiAgICAgICAgICBhPWEoc2VsZiwgbG9jYWxzKTsgYj1iKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICByZXR1cm4gKGlzRGVmaW5lZChhKT9hOjApLShpc0RlZmluZWQoYik/YjowKTsKICAgICAgICB9LAogICAgJyonOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpKmIoc2VsZiwgbG9jYWxzKTt9LAogICAgJy8nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpL2Ioc2VsZiwgbG9jYWxzKTt9LAogICAgJyUnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpJWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJz09PSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLCBiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPT09YihzZWxmLCBsb2NhbHMpO30sCiAgICAnIT09JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsIGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykhPT1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICc9PSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2Fscyk9PWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJyE9JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKSE9YihzZWxmLCBsb2NhbHMpO30sCiAgICAnPCc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2Fscyk8YihzZWxmLCBsb2NhbHMpO30sCiAgICAnPic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2Fscyk+YihzZWxmLCBsb2NhbHMpO30sCiAgICAnPD0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPD1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICc+PSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2Fscyk+PWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJyYmJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKSYmYihzZWxmLCBsb2NhbHMpO30sCiAgICAnfHwnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpfHxiKHNlbGYsIGxvY2Fscyk7fSwKICAgICchJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEpe3JldHVybiAhYShzZWxmLCBsb2NhbHMpO30sCgogICAgLy9Ub2tlbml6ZWQgYXMgb3BlcmF0b3JzIGJ1dCBwYXJzZWQgYXMgYXNzaWdubWVudC9maWx0ZXJzCiAgICAnPSc6dHJ1ZSwKICAgICd8Jzp0cnVlCn0pOwp2YXIgRVNDQVBFID0geyJuIjoiXG4iLCAiZiI6IlxmIiwgInIiOiJcciIsICJ0IjoiXHQiLCAidiI6Ilx2IiwgIiciOiInIiwgJyInOiciJ307CgoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCgovKioKICogQGNvbnN0cnVjdG9yCiAqLwp2YXIgTGV4ZXIgPSBmdW5jdGlvbiAob3B0aW9ucykgewogIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7Cn07CgpMZXhlci5wcm90b3R5cGUgPSB7CiAgY29uc3RydWN0b3I6IExleGVyLAoKICBsZXg6IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICB0aGlzLnRleHQgPSB0ZXh0OwogICAgdGhpcy5pbmRleCA9IDA7CiAgICB0aGlzLmNoID0gdW5kZWZpbmVkOwogICAgdGhpcy50b2tlbnMgPSBbXTsKCiAgICB3aGlsZSAodGhpcy5pbmRleCA8IHRoaXMudGV4dC5sZW5ndGgpIHsKICAgICAgdGhpcy5jaCA9IHRoaXMudGV4dC5jaGFyQXQodGhpcy5pbmRleCk7CiAgICAgIGlmICh0aGlzLmlzKCciXCcnKSkgewogICAgICAgIHRoaXMucmVhZFN0cmluZyh0aGlzLmNoKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTnVtYmVyKHRoaXMuY2gpIHx8IHRoaXMuaXMoJy4nKSAmJiB0aGlzLmlzTnVtYmVyKHRoaXMucGVlaygpKSkgewogICAgICAgIHRoaXMucmVhZE51bWJlcigpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuaXNJZGVudCh0aGlzLmNoKSkgewogICAgICAgIHRoaXMucmVhZElkZW50KCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pcygnKCl7fVtdLiw7Oj8nKSkgewogICAgICAgIHRoaXMudG9rZW5zLnB1c2goewogICAgICAgICAgaW5kZXg6IHRoaXMuaW5kZXgsCiAgICAgICAgICB0ZXh0OiB0aGlzLmNoCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICB9IGVsc2UgaWYgKHRoaXMuaXNXaGl0ZXNwYWNlKHRoaXMuY2gpKSB7CiAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBjaDIgPSB0aGlzLmNoICsgdGhpcy5wZWVrKCk7CiAgICAgICAgdmFyIGNoMyA9IGNoMiArIHRoaXMucGVlaygyKTsKICAgICAgICB2YXIgZm4gPSBPUEVSQVRPUlNbdGhpcy5jaF07CiAgICAgICAgdmFyIGZuMiA9IE9QRVJBVE9SU1tjaDJdOwogICAgICAgIHZhciBmbjMgPSBPUEVSQVRPUlNbY2gzXTsKICAgICAgICBpZiAoZm4zKSB7CiAgICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHtpbmRleDogdGhpcy5pbmRleCwgdGV4dDogY2gzLCBmbjogZm4zfSk7CiAgICAgICAgICB0aGlzLmluZGV4ICs9IDM7CiAgICAgICAgfSBlbHNlIGlmIChmbjIpIHsKICAgICAgICAgIHRoaXMudG9rZW5zLnB1c2goe2luZGV4OiB0aGlzLmluZGV4LCB0ZXh0OiBjaDIsIGZuOiBmbjJ9KTsKICAgICAgICAgIHRoaXMuaW5kZXggKz0gMjsKICAgICAgICB9IGVsc2UgaWYgKGZuKSB7CiAgICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgICAgICAgaW5kZXg6IHRoaXMuaW5kZXgsCiAgICAgICAgICAgIHRleHQ6IHRoaXMuY2gsCiAgICAgICAgICAgIGZuOiBmbgogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLmluZGV4ICs9IDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMudGhyb3dFcnJvcignVW5leHBlY3RlZCBuZXh0IGNoYXJhY3RlciAnLCB0aGlzLmluZGV4LCB0aGlzLmluZGV4ICsgMSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpcy50b2tlbnM7CiAgfSwKCiAgaXM6IGZ1bmN0aW9uKGNoYXJzKSB7CiAgICByZXR1cm4gY2hhcnMuaW5kZXhPZih0aGlzLmNoKSAhPT0gLTE7CiAgfSwKCiAgcGVlazogZnVuY3Rpb24oaSkgewogICAgdmFyIG51bSA9IGkgfHwgMTsKICAgIHJldHVybiAodGhpcy5pbmRleCArIG51bSA8IHRoaXMudGV4dC5sZW5ndGgpID8gdGhpcy50ZXh0LmNoYXJBdCh0aGlzLmluZGV4ICsgbnVtKSA6IGZhbHNlOwogIH0sCgogIGlzTnVtYmVyOiBmdW5jdGlvbihjaCkgewogICAgcmV0dXJuICgnMCcgPD0gY2ggJiYgY2ggPD0gJzknKTsKICB9LAoKICBpc1doaXRlc3BhY2U6IGZ1bmN0aW9uKGNoKSB7CiAgICAvLyBJRSB0cmVhdHMgbm9uLWJyZWFraW5nIHNwYWNlIGFzIFx1MDBBMAogICAgcmV0dXJuIChjaCA9PT0gJyAnIHx8IGNoID09PSAnXHInIHx8IGNoID09PSAnXHQnIHx8CiAgICAgICAgICAgIGNoID09PSAnXG4nIHx8IGNoID09PSAnXHYnIHx8IGNoID09PSAnXHUwMEEwJyk7CiAgfSwKCiAgaXNJZGVudDogZnVuY3Rpb24oY2gpIHsKICAgIHJldHVybiAoJ2EnIDw9IGNoICYmIGNoIDw9ICd6JyB8fAogICAgICAgICAgICAnQScgPD0gY2ggJiYgY2ggPD0gJ1onIHx8CiAgICAgICAgICAgICdfJyA9PT0gY2ggfHwgY2ggPT09ICckJyk7CiAgfSwKCiAgaXNFeHBPcGVyYXRvcjogZnVuY3Rpb24oY2gpIHsKICAgIHJldHVybiAoY2ggPT09ICctJyB8fCBjaCA9PT0gJysnIHx8IHRoaXMuaXNOdW1iZXIoY2gpKTsKICB9LAoKICB0aHJvd0Vycm9yOiBmdW5jdGlvbihlcnJvciwgc3RhcnQsIGVuZCkgewogICAgZW5kID0gZW5kIHx8IHRoaXMuaW5kZXg7CiAgICB2YXIgY29sU3RyID0gKGlzRGVmaW5lZChzdGFydCkKICAgICAgICAgICAgPyAncyAnICsgc3RhcnQgKyAgJy0nICsgdGhpcy5pbmRleCArICcgWycgKyB0aGlzLnRleHQuc3Vic3RyaW5nKHN0YXJ0LCBlbmQpICsgJ10nCiAgICAgICAgICAgIDogJyAnICsgZW5kKTsKICAgIHRocm93ICRwYXJzZU1pbkVycignbGV4ZXJyJywgJ0xleGVyIEVycm9yOiB7MH0gYXQgY29sdW1uezF9IGluIGV4cHJlc3Npb24gW3syfV0uJywKICAgICAgICBlcnJvciwgY29sU3RyLCB0aGlzLnRleHQpOwogIH0sCgogIHJlYWROdW1iZXI6IGZ1bmN0aW9uKCkgewogICAgdmFyIG51bWJlciA9ICcnOwogICAgdmFyIHN0YXJ0ID0gdGhpcy5pbmRleDsKICAgIHdoaWxlICh0aGlzLmluZGV4IDwgdGhpcy50ZXh0Lmxlbmd0aCkgewogICAgICB2YXIgY2ggPSBsb3dlcmNhc2UodGhpcy50ZXh0LmNoYXJBdCh0aGlzLmluZGV4KSk7CiAgICAgIGlmIChjaCA9PSAnLicgfHwgdGhpcy5pc051bWJlcihjaCkpIHsKICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHBlZWtDaCA9IHRoaXMucGVlaygpOwogICAgICAgIGlmIChjaCA9PSAnZScgJiYgdGhpcy5pc0V4cE9wZXJhdG9yKHBlZWtDaCkpIHsKICAgICAgICAgIG51bWJlciArPSBjaDsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNFeHBPcGVyYXRvcihjaCkgJiYKICAgICAgICAgICAgcGVla0NoICYmIHRoaXMuaXNOdW1iZXIocGVla0NoKSAmJgogICAgICAgICAgICBudW1iZXIuY2hhckF0KG51bWJlci5sZW5ndGggLSAxKSA9PSAnZScpIHsKICAgICAgICAgIG51bWJlciArPSBjaDsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNFeHBPcGVyYXRvcihjaCkgJiYKICAgICAgICAgICAgKCFwZWVrQ2ggfHwgIXRoaXMuaXNOdW1iZXIocGVla0NoKSkgJiYKICAgICAgICAgICAgbnVtYmVyLmNoYXJBdChudW1iZXIubGVuZ3RoIC0gMSkgPT0gJ2UnKSB7CiAgICAgICAgICB0aGlzLnRocm93RXJyb3IoJ0ludmFsaWQgZXhwb25lbnQnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuaW5kZXgrKzsKICAgIH0KICAgIG51bWJlciA9IDEgKiBudW1iZXI7CiAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgaW5kZXg6IHN0YXJ0LAogICAgICB0ZXh0OiBudW1iZXIsCiAgICAgIGNvbnN0YW50OiB0cnVlLAogICAgICBmbjogZnVuY3Rpb24oKSB7IHJldHVybiBudW1iZXI7IH0KICAgIH0pOwogIH0sCgogIHJlYWRJZGVudDogZnVuY3Rpb24oKSB7CiAgICB2YXIgZXhwcmVzc2lvbiA9IHRoaXMudGV4dDsKCiAgICB2YXIgaWRlbnQgPSAnJzsKICAgIHZhciBzdGFydCA9IHRoaXMuaW5kZXg7CgogICAgdmFyIGxhc3REb3QsIHBlZWtJbmRleCwgbWV0aG9kTmFtZSwgY2g7CgogICAgd2hpbGUgKHRoaXMuaW5kZXggPCB0aGlzLnRleHQubGVuZ3RoKSB7CiAgICAgIGNoID0gdGhpcy50ZXh0LmNoYXJBdCh0aGlzLmluZGV4KTsKICAgICAgaWYgKGNoID09PSAnLicgfHwgdGhpcy5pc0lkZW50KGNoKSB8fCB0aGlzLmlzTnVtYmVyKGNoKSkgewogICAgICAgIGlmIChjaCA9PT0gJy4nKSBsYXN0RG90ID0gdGhpcy5pbmRleDsKICAgICAgICBpZGVudCArPSBjaDsKICAgICAgfSBlbHNlIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICB0aGlzLmluZGV4Kys7CiAgICB9CgogICAgLy9jaGVjayBpZiB0aGUgaWRlbnRpZmllciBlbmRzIHdpdGggLiBhbmQgaWYgc28gbW92ZSBiYWNrIG9uZSBjaGFyCiAgICBpZiAobGFzdERvdCAmJiBpZGVudFtpZGVudC5sZW5ndGggLSAxXSA9PT0gJy4nKSB7CiAgICAgIHRoaXMuaW5kZXgtLTsKICAgICAgaWRlbnQgPSBpZGVudC5zbGljZSgwLCAtMSk7CiAgICAgIGxhc3REb3QgPSBpZGVudC5sYXN0SW5kZXhPZignLicpOwogICAgICBpZiAobGFzdERvdCA9PT0gLTEpIHsKICAgICAgICBsYXN0RG90ID0gdW5kZWZpbmVkOwogICAgICB9CiAgICB9CgogICAgLy9jaGVjayBpZiB0aGlzIGlzIG5vdCBhIG1ldGhvZCBpbnZvY2F0aW9uIGFuZCBpZiBpdCBpcyBiYWNrIG91dCB0byBsYXN0IGRvdAogICAgaWYgKGxhc3REb3QpIHsKICAgICAgcGVla0luZGV4ID0gdGhpcy5pbmRleDsKICAgICAgd2hpbGUgKHBlZWtJbmRleCA8IHRoaXMudGV4dC5sZW5ndGgpIHsKICAgICAgICBjaCA9IHRoaXMudGV4dC5jaGFyQXQocGVla0luZGV4KTsKICAgICAgICBpZiAoY2ggPT09ICcoJykgewogICAgICAgICAgbWV0aG9kTmFtZSA9IGlkZW50LnN1YnN0cihsYXN0RG90IC0gc3RhcnQgKyAxKTsKICAgICAgICAgIGlkZW50ID0gaWRlbnQuc3Vic3RyKDAsIGxhc3REb3QgLSBzdGFydCk7CiAgICAgICAgICB0aGlzLmluZGV4ID0gcGVla0luZGV4OwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgIHBlZWtJbmRleCsrOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgaW5kZXg6IHN0YXJ0LAogICAgICB0ZXh0OiBpZGVudCwKICAgICAgZm46IENPTlNUQU5UU1tpZGVudF0gfHwgZ2V0dGVyRm4oaWRlbnQsIHRoaXMub3B0aW9ucywgZXhwcmVzc2lvbikKICAgIH0pOwoKICAgIGlmIChtZXRob2ROYW1lKSB7CiAgICAgIHRoaXMudG9rZW5zLnB1c2goewogICAgICAgIGluZGV4OiBsYXN0RG90LAogICAgICAgIHRleHQ6ICcuJwogICAgICB9KTsKICAgICAgdGhpcy50b2tlbnMucHVzaCh7CiAgICAgICAgaW5kZXg6IGxhc3REb3QgKyAxLAogICAgICAgIHRleHQ6IG1ldGhvZE5hbWUKICAgICAgfSk7CiAgICB9CiAgfSwKCiAgcmVhZFN0cmluZzogZnVuY3Rpb24ocXVvdGUpIHsKICAgIHZhciBzdGFydCA9IHRoaXMuaW5kZXg7CiAgICB0aGlzLmluZGV4Kys7CiAgICB2YXIgc3RyaW5nID0gJyc7CiAgICB2YXIgcmF3U3RyaW5nID0gcXVvdGU7CiAgICB2YXIgZXNjYXBlID0gZmFsc2U7CiAgICB3aGlsZSAodGhpcy5pbmRleCA8IHRoaXMudGV4dC5sZW5ndGgpIHsKICAgICAgdmFyIGNoID0gdGhpcy50ZXh0LmNoYXJBdCh0aGlzLmluZGV4KTsKICAgICAgcmF3U3RyaW5nICs9IGNoOwogICAgICBpZiAoZXNjYXBlKSB7CiAgICAgICAgaWYgKGNoID09PSAndScpIHsKICAgICAgICAgIHZhciBoZXggPSB0aGlzLnRleHQuc3Vic3RyaW5nKHRoaXMuaW5kZXggKyAxLCB0aGlzLmluZGV4ICsgNSk7CiAgICAgICAgICBpZiAoIWhleC5tYXRjaCgvW1xkYS1mXXs0fS9pKSkKICAgICAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdJbnZhbGlkIHVuaWNvZGUgZXNjYXBlIFtcXHUnICsgaGV4ICsgJ10nKTsKICAgICAgICAgIHRoaXMuaW5kZXggKz0gNDsKICAgICAgICAgIHN0cmluZyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KGhleCwgMTYpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHJlcCA9IEVTQ0FQRVtjaF07CiAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcgKyAocmVwIHx8IGNoKTsKICAgICAgICB9CiAgICAgICAgZXNjYXBlID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoY2ggPT09ICdcXCcpIHsKICAgICAgICBlc2NhcGUgPSB0cnVlOwogICAgICB9IGVsc2UgaWYgKGNoID09PSBxdW90ZSkgewogICAgICAgIHRoaXMuaW5kZXgrKzsKICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgICAgIGluZGV4OiBzdGFydCwKICAgICAgICAgIHRleHQ6IHJhd1N0cmluZywKICAgICAgICAgIHN0cmluZzogc3RyaW5nLAogICAgICAgICAgY29uc3RhbnQ6IHRydWUsCiAgICAgICAgICBmbjogZnVuY3Rpb24oKSB7IHJldHVybiBzdHJpbmc7IH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RyaW5nICs9IGNoOwogICAgICB9CiAgICAgIHRoaXMuaW5kZXgrKzsKICAgIH0KICAgIHRoaXMudGhyb3dFcnJvcignVW50ZXJtaW5hdGVkIHF1b3RlJywgc3RhcnQpOwogIH0KfTsKCgpmdW5jdGlvbiBpc0NvbnN0YW50KGV4cCkgewogIHJldHVybiBleHAuY29uc3RhbnQ7Cn0KCi8qKgogKiBAY29uc3RydWN0b3IKICovCnZhciBQYXJzZXIgPSBmdW5jdGlvbiAobGV4ZXIsICRmaWx0ZXIsIG9wdGlvbnMpIHsKICB0aGlzLmxleGVyID0gbGV4ZXI7CiAgdGhpcy4kZmlsdGVyID0gJGZpbHRlcjsKICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwp9OwoKUGFyc2VyLlpFUk8gPSBleHRlbmQoZnVuY3Rpb24gKCkgewogIHJldHVybiAwOwp9LCB7CiAgc2hhcmVkR2V0dGVyOiB0cnVlLAogIGNvbnN0YW50OiB0cnVlCn0pOwoKUGFyc2VyLnByb3RvdHlwZSA9IHsKICBjb25zdHJ1Y3RvcjogUGFyc2VyLAoKICBwYXJzZTogZnVuY3Rpb24gKHRleHQpIHsKICAgIHRoaXMudGV4dCA9IHRleHQ7CiAgICB0aGlzLnRva2VucyA9IHRoaXMubGV4ZXIubGV4KHRleHQpOwoKICAgIHZhciB2YWx1ZSA9IHRoaXMuc3RhdGVtZW50cygpOwoKICAgIGlmICh0aGlzLnRva2Vucy5sZW5ndGggIT09IDApIHsKICAgICAgdGhpcy50aHJvd0Vycm9yKCdpcyBhbiB1bmV4cGVjdGVkIHRva2VuJywgdGhpcy50b2tlbnNbMF0pOwogICAgfQoKICAgIHZhbHVlLmxpdGVyYWwgPSAhIXZhbHVlLmxpdGVyYWw7CiAgICB2YWx1ZS5jb25zdGFudCA9ICEhdmFsdWUuY29uc3RhbnQ7CgogICAgcmV0dXJuIHZhbHVlOwogIH0sCgogIHByaW1hcnk6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBwcmltYXJ5OwogICAgaWYgKHRoaXMuZXhwZWN0KCcoJykpIHsKICAgICAgcHJpbWFyeSA9IHRoaXMuZmlsdGVyQ2hhaW4oKTsKICAgICAgdGhpcy5jb25zdW1lKCcpJyk7CiAgICB9IGVsc2UgaWYgKHRoaXMuZXhwZWN0KCdbJykpIHsKICAgICAgcHJpbWFyeSA9IHRoaXMuYXJyYXlEZWNsYXJhdGlvbigpOwogICAgfSBlbHNlIGlmICh0aGlzLmV4cGVjdCgneycpKSB7CiAgICAgIHByaW1hcnkgPSB0aGlzLm9iamVjdCgpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIHRva2VuID0gdGhpcy5leHBlY3QoKTsKICAgICAgcHJpbWFyeSA9IHRva2VuLmZuOwogICAgICBpZiAoIXByaW1hcnkpIHsKICAgICAgICB0aGlzLnRocm93RXJyb3IoJ25vdCBhIHByaW1hcnkgZXhwcmVzc2lvbicsIHRva2VuKTsKICAgICAgfQogICAgICBpZiAodG9rZW4uY29uc3RhbnQpIHsKICAgICAgICBwcmltYXJ5LmNvbnN0YW50ID0gdHJ1ZTsKICAgICAgICBwcmltYXJ5LmxpdGVyYWwgPSB0cnVlOwogICAgICB9CiAgICB9CgogICAgdmFyIG5leHQsIGNvbnRleHQ7CiAgICB3aGlsZSAoKG5leHQgPSB0aGlzLmV4cGVjdCgnKCcsICdbJywgJy4nKSkpIHsKICAgICAgaWYgKG5leHQudGV4dCA9PT0gJygnKSB7CiAgICAgICAgcHJpbWFyeSA9IHRoaXMuZnVuY3Rpb25DYWxsKHByaW1hcnksIGNvbnRleHQpOwogICAgICAgIGNvbnRleHQgPSBudWxsOwogICAgICB9IGVsc2UgaWYgKG5leHQudGV4dCA9PT0gJ1snKSB7CiAgICAgICAgY29udGV4dCA9IHByaW1hcnk7CiAgICAgICAgcHJpbWFyeSA9IHRoaXMub2JqZWN0SW5kZXgocHJpbWFyeSk7CiAgICAgIH0gZWxzZSBpZiAobmV4dC50ZXh0ID09PSAnLicpIHsKICAgICAgICBjb250ZXh0ID0gcHJpbWFyeTsKICAgICAgICBwcmltYXJ5ID0gdGhpcy5maWVsZEFjY2VzcyhwcmltYXJ5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRocm93RXJyb3IoJ0lNUE9TU0lCTEUnKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHByaW1hcnk7CiAgfSwKCiAgdGhyb3dFcnJvcjogZnVuY3Rpb24obXNnLCB0b2tlbikgewogICAgdGhyb3cgJHBhcnNlTWluRXJyKCdzeW50YXgnLAogICAgICAgICdTeW50YXggRXJyb3I6IFRva2VuIFwnezB9XCcgezF9IGF0IGNvbHVtbiB7Mn0gb2YgdGhlIGV4cHJlc3Npb24gW3szfV0gc3RhcnRpbmcgYXQgW3s0fV0uJywKICAgICAgICAgIHRva2VuLnRleHQsIG1zZywgKHRva2VuLmluZGV4ICsgMSksIHRoaXMudGV4dCwgdGhpcy50ZXh0LnN1YnN0cmluZyh0b2tlbi5pbmRleCkpOwogIH0sCgogIHBlZWtUb2tlbjogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy50b2tlbnMubGVuZ3RoID09PSAwKQogICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ3Vlb2UnLCAnVW5leHBlY3RlZCBlbmQgb2YgZXhwcmVzc2lvbjogezB9JywgdGhpcy50ZXh0KTsKICAgIHJldHVybiB0aGlzLnRva2Vuc1swXTsKICB9LAoKICBwZWVrOiBmdW5jdGlvbihlMSwgZTIsIGUzLCBlNCkgewogICAgaWYgKHRoaXMudG9rZW5zLmxlbmd0aCA+IDApIHsKICAgICAgdmFyIHRva2VuID0gdGhpcy50b2tlbnNbMF07CiAgICAgIHZhciB0ID0gdG9rZW4udGV4dDsKICAgICAgaWYgKHQgPT09IGUxIHx8IHQgPT09IGUyIHx8IHQgPT09IGUzIHx8IHQgPT09IGU0IHx8CiAgICAgICAgICAoIWUxICYmICFlMiAmJiAhZTMgJiYgIWU0KSkgewogICAgICAgIHJldHVybiB0b2tlbjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0sCgogIGV4cGVjdDogZnVuY3Rpb24oZTEsIGUyLCBlMywgZTQpewogICAgdmFyIHRva2VuID0gdGhpcy5wZWVrKGUxLCBlMiwgZTMsIGU0KTsKICAgIGlmICh0b2tlbikgewogICAgICB0aGlzLnRva2Vucy5zaGlmdCgpOwogICAgICByZXR1cm4gdG9rZW47CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfSwKCiAgY29uc3VtZTogZnVuY3Rpb24oZTEpewogICAgaWYgKCF0aGlzLmV4cGVjdChlMSkpIHsKICAgICAgdGhpcy50aHJvd0Vycm9yKCdpcyB1bmV4cGVjdGVkLCBleHBlY3RpbmcgWycgKyBlMSArICddJywgdGhpcy5wZWVrKCkpOwogICAgfQogIH0sCgogIHVuYXJ5Rm46IGZ1bmN0aW9uKGZuLCByaWdodCkgewogICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAkcGFyc2VVbmFyeUZuKHNlbGYsIGxvY2FscykgewogICAgICByZXR1cm4gZm4oc2VsZiwgbG9jYWxzLCByaWdodCk7CiAgICB9LCB7CiAgICAgIGNvbnN0YW50OnJpZ2h0LmNvbnN0YW50LAogICAgICBpbnB1dHM6IFtyaWdodF0KICAgIH0pOwogIH0sCgogIGJpbmFyeUZuOiBmdW5jdGlvbihsZWZ0LCBmbiwgcmlnaHQsIGlzQnJhbmNoaW5nKSB7CiAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uICRwYXJzZUJpbmFyeUZuKHNlbGYsIGxvY2FscykgewogICAgICByZXR1cm4gZm4oc2VsZiwgbG9jYWxzLCBsZWZ0LCByaWdodCk7CiAgICB9LCB7CiAgICAgIGNvbnN0YW50OiBsZWZ0LmNvbnN0YW50ICYmIHJpZ2h0LmNvbnN0YW50LAogICAgICBpbnB1dHM6ICFpc0JyYW5jaGluZyAmJiBbbGVmdCwgcmlnaHRdCiAgICB9KTsKICB9LAoKICBzdGF0ZW1lbnRzOiBmdW5jdGlvbigpIHsKICAgIHZhciBzdGF0ZW1lbnRzID0gW107CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAodGhpcy50b2tlbnMubGVuZ3RoID4gMCAmJiAhdGhpcy5wZWVrKCd9JywgJyknLCAnOycsICddJykpCiAgICAgICAgc3RhdGVtZW50cy5wdXNoKHRoaXMuZmlsdGVyQ2hhaW4oKSk7CiAgICAgIGlmICghdGhpcy5leHBlY3QoJzsnKSkgewogICAgICAgIC8vIG9wdGltaXplIGZvciB0aGUgY29tbW9uIGNhc2Ugd2hlcmUgdGhlcmUgaXMgb25seSBvbmUgc3RhdGVtZW50LgogICAgICAgIC8vIFRPRE8oc2l6ZSk6IG1heWJlIHdlIHNob3VsZCBub3Qgc3VwcG9ydCBtdWx0aXBsZSBzdGF0ZW1lbnRzPwogICAgICAgIHJldHVybiAoc3RhdGVtZW50cy5sZW5ndGggPT09IDEpCiAgICAgICAgICAgID8gc3RhdGVtZW50c1swXQogICAgICAgICAgICA6IGZ1bmN0aW9uICRwYXJzZVN0YXRlbWVudHMoc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWU7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBzdGF0ZW1lbnRzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFsdWUgPSBzdGF0ZW1lbnRzW2ldKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgfTsKICAgICAgfQogICAgfQogIH0sCgogIGZpbHRlckNoYWluOiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy5leHByZXNzaW9uKCk7CiAgICB2YXIgdG9rZW47CiAgICB3aGlsZSAoKHRva2VuID0gdGhpcy5leHBlY3QoJ3wnKSkpIHsKICAgICAgbGVmdCA9IHRoaXMuZmlsdGVyKGxlZnQpOwogICAgfQogICAgcmV0dXJuIGxlZnQ7CiAgfSwKCiAgZmlsdGVyOiBmdW5jdGlvbihpbnB1dEZuKSB7CiAgICB2YXIgdG9rZW4gPSB0aGlzLmV4cGVjdCgpOwogICAgdmFyIGZuID0gdGhpcy4kZmlsdGVyKHRva2VuLnRleHQpOwogICAgdmFyIGFyZ3NGbjsKICAgIHZhciBhcmdzOwoKICAgIGlmICh0aGlzLnBlZWsoJzonKSkgewogICAgICBhcmdzRm4gPSBbXTsKICAgICAgYXJncyA9IFtdOyAvLyB3ZSBjYW4gc2FmZWx5IHJldXNlIHRoZSBhcnJheQogICAgICB3aGlsZSAodGhpcy5leHBlY3QoJzonKSkgewogICAgICAgIGFyZ3NGbi5wdXNoKHRoaXMuZXhwcmVzc2lvbigpKTsKICAgICAgfQogICAgfQoKICAgIHZhciBpbnB1dHMgPSBbaW5wdXRGbl0uY29uY2F0KGFyZ3NGbiB8fCBbXSk7CgogICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAkcGFyc2VGaWx0ZXIoc2VsZiwgbG9jYWxzKSB7CiAgICAgIHZhciBpbnB1dCA9IGlucHV0Rm4oc2VsZiwgbG9jYWxzKTsKICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICBhcmdzWzBdID0gaW5wdXQ7CgogICAgICAgIHZhciBpID0gYXJnc0ZuLmxlbmd0aDsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICBhcmdzW2kgKyAxXSA9IGFyZ3NGbltpXShzZWxmLCBsb2NhbHMpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHVuZGVmaW5lZCwgYXJncyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBmbihpbnB1dCk7CiAgICB9LCB7CiAgICAgIGNvbnN0YW50OiAhZm4uJHN0YXRlZnVsICYmIGlucHV0cy5ldmVyeShpc0NvbnN0YW50KSwKICAgICAgaW5wdXRzOiAhZm4uJHN0YXRlZnVsICYmIGlucHV0cwogICAgfSk7CiAgfSwKCiAgZXhwcmVzc2lvbjogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5hc3NpZ25tZW50KCk7CiAgfSwKCiAgYXNzaWdubWVudDogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVmdCA9IHRoaXMudGVybmFyeSgpOwogICAgdmFyIHJpZ2h0OwogICAgdmFyIHRva2VuOwogICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCc9JykpKSB7CiAgICAgIGlmICghbGVmdC5hc3NpZ24pIHsKICAgICAgICB0aGlzLnRocm93RXJyb3IoJ2ltcGxpZXMgYXNzaWdubWVudCBidXQgWycgKwogICAgICAgICAgICB0aGlzLnRleHQuc3Vic3RyaW5nKDAsIHRva2VuLmluZGV4KSArICddIGNhbiBub3QgYmUgYXNzaWduZWQgdG8nLCB0b2tlbik7CiAgICAgIH0KICAgICAgcmlnaHQgPSB0aGlzLnRlcm5hcnkoKTsKICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAkcGFyc2VBc3NpZ25tZW50KHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICByZXR1cm4gbGVmdC5hc3NpZ24oc2NvcGUsIHJpZ2h0KHNjb3BlLCBsb2NhbHMpLCBsb2NhbHMpOwogICAgICB9LCB7CiAgICAgICAgaW5wdXRzOiBbbGVmdCwgcmlnaHRdCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGxlZnQ7CiAgfSwKCiAgdGVybmFyeTogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVmdCA9IHRoaXMubG9naWNhbE9SKCk7CiAgICB2YXIgbWlkZGxlOwogICAgdmFyIHRva2VuOwogICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCc/JykpKSB7CiAgICAgIG1pZGRsZSA9IHRoaXMuYXNzaWdubWVudCgpOwogICAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJzonKSkpIHsKICAgICAgICB2YXIgcmlnaHQgPSB0aGlzLmFzc2lnbm1lbnQoKTsKCiAgICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAkcGFyc2VUZXJuYXJ5KHNlbGYsIGxvY2Fscyl7CiAgICAgICAgICByZXR1cm4gbGVmdChzZWxmLCBsb2NhbHMpID8gbWlkZGxlKHNlbGYsIGxvY2FscykgOiByaWdodChzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sIHsKICAgICAgICAgIGNvbnN0YW50OiBsZWZ0LmNvbnN0YW50ICYmIG1pZGRsZS5jb25zdGFudCAmJiByaWdodC5jb25zdGFudAogICAgICAgIH0pOwoKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRocm93RXJyb3IoJ2V4cGVjdGVkIDonLCB0b2tlbik7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbGVmdDsKICB9LAoKICBsb2dpY2FsT1I6IGZ1bmN0aW9uKCkgewogICAgdmFyIGxlZnQgPSB0aGlzLmxvZ2ljYWxBTkQoKTsKICAgIHZhciB0b2tlbjsKICAgIHdoaWxlICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnfHwnKSkpIHsKICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMubG9naWNhbEFORCgpLCB0cnVlKTsKICAgIH0KICAgIHJldHVybiBsZWZ0OwogIH0sCgogIGxvZ2ljYWxBTkQ6IGZ1bmN0aW9uKCkgewogICAgdmFyIGxlZnQgPSB0aGlzLmVxdWFsaXR5KCk7CiAgICB2YXIgdG9rZW47CiAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJyYmJykpKSB7CiAgICAgIGxlZnQgPSB0aGlzLmJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCB0aGlzLmxvZ2ljYWxBTkQoKSwgdHJ1ZSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9LAoKICBlcXVhbGl0eTogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVmdCA9IHRoaXMucmVsYXRpb25hbCgpOwogICAgdmFyIHRva2VuOwogICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCc9PScsJyE9JywnPT09JywnIT09JykpKSB7CiAgICAgIGxlZnQgPSB0aGlzLmJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCB0aGlzLmVxdWFsaXR5KCkpOwogICAgfQogICAgcmV0dXJuIGxlZnQ7CiAgfSwKCiAgcmVsYXRpb25hbDogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVmdCA9IHRoaXMuYWRkaXRpdmUoKTsKICAgIHZhciB0b2tlbjsKICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnPCcsICc+JywgJzw9JywgJz49JykpKSB7CiAgICAgIGxlZnQgPSB0aGlzLmJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCB0aGlzLnJlbGF0aW9uYWwoKSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9LAoKICBhZGRpdGl2ZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVmdCA9IHRoaXMubXVsdGlwbGljYXRpdmUoKTsKICAgIHZhciB0b2tlbjsKICAgIHdoaWxlICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnKycsJy0nKSkpIHsKICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMubXVsdGlwbGljYXRpdmUoKSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9LAoKICBtdWx0aXBsaWNhdGl2ZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVmdCA9IHRoaXMudW5hcnkoKTsKICAgIHZhciB0b2tlbjsKICAgIHdoaWxlICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnKicsJy8nLCclJykpKSB7CiAgICAgIGxlZnQgPSB0aGlzLmJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCB0aGlzLnVuYXJ5KCkpOwogICAgfQogICAgcmV0dXJuIGxlZnQ7CiAgfSwKCiAgdW5hcnk6IGZ1bmN0aW9uKCkgewogICAgdmFyIHRva2VuOwogICAgaWYgKHRoaXMuZXhwZWN0KCcrJykpIHsKICAgICAgcmV0dXJuIHRoaXMucHJpbWFyeSgpOwogICAgfSBlbHNlIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnLScpKSkgewogICAgICByZXR1cm4gdGhpcy5iaW5hcnlGbihQYXJzZXIuWkVSTywgdG9rZW4uZm4sIHRoaXMudW5hcnkoKSk7CiAgICB9IGVsc2UgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCchJykpKSB7CiAgICAgIHJldHVybiB0aGlzLnVuYXJ5Rm4odG9rZW4uZm4sIHRoaXMudW5hcnkoKSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5wcmltYXJ5KCk7CiAgICB9CiAgfSwKCiAgZmllbGRBY2Nlc3M6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgdmFyIGV4cHJlc3Npb24gPSB0aGlzLnRleHQ7CiAgICB2YXIgZmllbGQgPSB0aGlzLmV4cGVjdCgpLnRleHQ7CiAgICB2YXIgZ2V0dGVyID0gZ2V0dGVyRm4oZmllbGQsIHRoaXMub3B0aW9ucywgZXhwcmVzc2lvbik7CgogICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAkcGFyc2VGaWVsZEFjY2VzcyhzY29wZSwgbG9jYWxzLCBzZWxmKSB7CiAgICAgIHJldHVybiBnZXR0ZXIoc2VsZiB8fCBvYmplY3Qoc2NvcGUsIGxvY2FscykpOwogICAgfSwgewogICAgICBhc3NpZ246IGZ1bmN0aW9uKHNjb3BlLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgdmFyIG8gPSBvYmplY3Qoc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgaWYgKCFvKSBvYmplY3QuYXNzaWduKHNjb3BlLCBvID0ge30pOwogICAgICAgIHJldHVybiBzZXR0ZXIobywgZmllbGQsIHZhbHVlLCBleHByZXNzaW9uKTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgb2JqZWN0SW5kZXg6IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGV4cHJlc3Npb24gPSB0aGlzLnRleHQ7CgogICAgdmFyIGluZGV4Rm4gPSB0aGlzLmV4cHJlc3Npb24oKTsKICAgIHRoaXMuY29uc3VtZSgnXScpOwoKICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gJHBhcnNlT2JqZWN0SW5kZXgoc2VsZiwgbG9jYWxzKSB7CiAgICAgIHZhciBvID0gb2JqKHNlbGYsIGxvY2FscyksCiAgICAgICAgICBpID0gaW5kZXhGbihzZWxmLCBsb2NhbHMpLAogICAgICAgICAgdjsKCiAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGksIGV4cHJlc3Npb24pOwogICAgICBpZiAoIW8pIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIHYgPSBlbnN1cmVTYWZlT2JqZWN0KG9baV0sIGV4cHJlc3Npb24pOwogICAgICByZXR1cm4gdjsKICAgIH0sIHsKICAgICAgYXNzaWduOiBmdW5jdGlvbihzZWxmLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgdmFyIGtleSA9IGVuc3VyZVNhZmVNZW1iZXJOYW1lKGluZGV4Rm4oc2VsZiwgbG9jYWxzKSwgZXhwcmVzc2lvbik7CiAgICAgICAgLy8gcHJldmVudCBvdmVyd3JpdGluZyBvZiBGdW5jdGlvbi5jb25zdHJ1Y3RvciB3aGljaCB3b3VsZCBicmVhayBlbnN1cmVTYWZlT2JqZWN0IGNoZWNrCiAgICAgICAgdmFyIG8gPSBlbnN1cmVTYWZlT2JqZWN0KG9iaihzZWxmLCBsb2NhbHMpLCBleHByZXNzaW9uKTsKICAgICAgICBpZiAoIW8pIG9iai5hc3NpZ24oc2VsZiwgbyA9IHt9KTsKICAgICAgICByZXR1cm4gb1trZXldID0gdmFsdWU7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIGZ1bmN0aW9uQ2FsbDogZnVuY3Rpb24oZm5HZXR0ZXIsIGNvbnRleHRHZXR0ZXIpIHsKICAgIHZhciBhcmdzRm4gPSBbXTsKICAgIGlmICh0aGlzLnBlZWtUb2tlbigpLnRleHQgIT09ICcpJykgewogICAgICBkbyB7CiAgICAgICAgYXJnc0ZuLnB1c2godGhpcy5leHByZXNzaW9uKCkpOwogICAgICB9IHdoaWxlICh0aGlzLmV4cGVjdCgnLCcpKTsKICAgIH0KICAgIHRoaXMuY29uc3VtZSgnKScpOwoKICAgIHZhciBleHByZXNzaW9uVGV4dCA9IHRoaXMudGV4dDsKICAgIC8vIHdlIGNhbiBzYWZlbHkgcmV1c2UgdGhlIGFycmF5IGFjcm9zcyBpbnZvY2F0aW9ucwogICAgdmFyIGFyZ3MgPSBhcmdzRm4ubGVuZ3RoID8gW10gOiBudWxsOwoKICAgIHJldHVybiBmdW5jdGlvbiAkcGFyc2VGdW5jdGlvbkNhbGwoc2NvcGUsIGxvY2FscykgewogICAgICB2YXIgY29udGV4dCA9IGNvbnRleHRHZXR0ZXIgPyBjb250ZXh0R2V0dGVyKHNjb3BlLCBsb2NhbHMpIDogc2NvcGU7CiAgICAgIHZhciBmbiA9IGZuR2V0dGVyKHNjb3BlLCBsb2NhbHMsIGNvbnRleHQpIHx8IG5vb3A7CgogICAgICBpZiAoYXJncykgewogICAgICAgIHZhciBpID0gYXJnc0ZuLmxlbmd0aDsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICBhcmdzW2ldID0gZW5zdXJlU2FmZU9iamVjdChhcmdzRm5baV0oc2NvcGUsIGxvY2FscyksIGV4cHJlc3Npb25UZXh0KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGVuc3VyZVNhZmVPYmplY3QoY29udGV4dCwgZXhwcmVzc2lvblRleHQpOwogICAgICBlbnN1cmVTYWZlRnVuY3Rpb24oZm4sIGV4cHJlc3Npb25UZXh0KTsKCiAgICAgIC8vIElFIHN0dXBpZGl0eSEgKElFIGRvZXNuJ3QgaGF2ZSBhcHBseSBmb3Igc29tZSBuYXRpdmUgZnVuY3Rpb25zKQogICAgICB2YXIgdiA9IGZuLmFwcGx5CiAgICAgICAgICAgID8gZm4uYXBwbHkoY29udGV4dCwgYXJncykKICAgICAgICAgICAgOiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdKTsKCiAgICAgIHJldHVybiBlbnN1cmVTYWZlT2JqZWN0KHYsIGV4cHJlc3Npb25UZXh0KTsKICAgIH07CiAgfSwKCiAgLy8gVGhpcyBpcyB1c2VkIHdpdGgganNvbiBhcnJheSBkZWNsYXJhdGlvbgogIGFycmF5RGVjbGFyYXRpb246IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlbGVtZW50Rm5zID0gW107CiAgICBpZiAodGhpcy5wZWVrVG9rZW4oKS50ZXh0ICE9PSAnXScpIHsKICAgICAgZG8gewogICAgICAgIGlmICh0aGlzLnBlZWsoJ10nKSkgewogICAgICAgICAgLy8gU3VwcG9ydCB0cmFpbGluZyBjb21tYXMgcGVyIEVTNS4xLgogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHZhciBlbGVtZW50Rm4gPSB0aGlzLmV4cHJlc3Npb24oKTsKICAgICAgICBlbGVtZW50Rm5zLnB1c2goZWxlbWVudEZuKTsKICAgICAgfSB3aGlsZSAodGhpcy5leHBlY3QoJywnKSk7CiAgICB9CiAgICB0aGlzLmNvbnN1bWUoJ10nKTsKCiAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uICRwYXJzZUFycmF5TGl0ZXJhbChzZWxmLCBsb2NhbHMpIHsKICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGVsZW1lbnRGbnMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgIGFycmF5LnB1c2goZWxlbWVudEZuc1tpXShzZWxmLCBsb2NhbHMpKTsKICAgICAgfQogICAgICByZXR1cm4gYXJyYXk7CiAgICB9LCB7CiAgICAgIGxpdGVyYWw6IHRydWUsCiAgICAgIGNvbnN0YW50OiBlbGVtZW50Rm5zLmV2ZXJ5KGlzQ29uc3RhbnQpLAogICAgICBpbnB1dHM6IGVsZW1lbnRGbnMKICAgIH0pOwogIH0sCgogIG9iamVjdDogZnVuY3Rpb24gKCkgewogICAgdmFyIGtleXMgPSBbXSwgdmFsdWVGbnMgPSBbXTsKICAgIGlmICh0aGlzLnBlZWtUb2tlbigpLnRleHQgIT09ICd9JykgewogICAgICBkbyB7CiAgICAgICAgaWYgKHRoaXMucGVlaygnfScpKSB7CiAgICAgICAgICAvLyBTdXBwb3J0IHRyYWlsaW5nIGNvbW1hcyBwZXIgRVM1LjEuCiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgdmFyIHRva2VuID0gdGhpcy5leHBlY3QoKTsKICAgICAgICBrZXlzLnB1c2godG9rZW4uc3RyaW5nIHx8IHRva2VuLnRleHQpOwogICAgICAgIHRoaXMuY29uc3VtZSgnOicpOwogICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuZXhwcmVzc2lvbigpOwogICAgICAgIHZhbHVlRm5zLnB1c2godmFsdWUpOwogICAgICB9IHdoaWxlICh0aGlzLmV4cGVjdCgnLCcpKTsKICAgIH0KICAgIHRoaXMuY29uc3VtZSgnfScpOwoKICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gJHBhcnNlT2JqZWN0TGl0ZXJhbChzZWxmLCBsb2NhbHMpIHsKICAgICAgdmFyIG9iamVjdCA9IHt9OwogICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSB2YWx1ZUZucy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgb2JqZWN0W2tleXNbaV1dID0gdmFsdWVGbnNbaV0oc2VsZiwgbG9jYWxzKTsKICAgICAgfQogICAgICByZXR1cm4gb2JqZWN0OwogICAgfSwgewogICAgICBsaXRlcmFsOiB0cnVlLAogICAgICBjb25zdGFudDogdmFsdWVGbnMuZXZlcnkoaXNDb25zdGFudCksCiAgICAgIGlucHV0czogdmFsdWVGbnMKICAgIH0pOwogIH0KfTsKCgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBQYXJzZXIgaGVscGVyIGZ1bmN0aW9ucwovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKZnVuY3Rpb24gc2V0dGVyKG9iaiwgcGF0aCwgc2V0VmFsdWUsIGZ1bGxFeHApIHsKICBlbnN1cmVTYWZlT2JqZWN0KG9iaiwgZnVsbEV4cCk7CgogIHZhciBlbGVtZW50ID0gcGF0aC5zcGxpdCgnLicpLCBrZXk7CiAgZm9yICh2YXIgaSA9IDA7IGVsZW1lbnQubGVuZ3RoID4gMTsgaSsrKSB7CiAgICBrZXkgPSBlbnN1cmVTYWZlTWVtYmVyTmFtZShlbGVtZW50LnNoaWZ0KCksIGZ1bGxFeHApOwogICAgdmFyIHByb3BlcnR5T2JqID0gZW5zdXJlU2FmZU9iamVjdChvYmpba2V5XSwgZnVsbEV4cCk7CiAgICBpZiAoIXByb3BlcnR5T2JqKSB7CiAgICAgIHByb3BlcnR5T2JqID0ge307CiAgICAgIG9ialtrZXldID0gcHJvcGVydHlPYmo7CiAgICB9CiAgICBvYmogPSBwcm9wZXJ0eU9iajsKICB9CiAga2V5ID0gZW5zdXJlU2FmZU1lbWJlck5hbWUoZWxlbWVudC5zaGlmdCgpLCBmdWxsRXhwKTsKICBlbnN1cmVTYWZlT2JqZWN0KG9ialtrZXldLCBmdWxsRXhwKTsKICBvYmpba2V5XSA9IHNldFZhbHVlOwogIHJldHVybiBzZXRWYWx1ZTsKfQoKdmFyIGdldHRlckZuQ2FjaGUgPSBjcmVhdGVNYXAoKTsKCi8qKgogKiBJbXBsZW1lbnRhdGlvbiBvZiB0aGUgIkJsYWNrIEhvbGUiIHZhcmlhbnQgZnJvbToKICogLSBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyanMtcGFyc2UtZ2V0dGVyLzQKICogLSBodHRwOi8vanNwZXJmLmNvbS9wYXRoLWV2YWx1YXRpb24tc2ltcGxpZmllZC83CiAqLwpmdW5jdGlvbiBjc3BTYWZlR2V0dGVyRm4oa2V5MCwga2V5MSwga2V5Miwga2V5Mywga2V5NCwgZnVsbEV4cCkgewogIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTAsIGZ1bGxFeHApOwogIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTEsIGZ1bGxFeHApOwogIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTIsIGZ1bGxFeHApOwogIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTMsIGZ1bGxFeHApOwogIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTQsIGZ1bGxFeHApOwoKICByZXR1cm4gZnVuY3Rpb24gY3NwU2FmZUdldHRlcihzY29wZSwgbG9jYWxzKSB7CiAgICB2YXIgcGF0aFZhbCA9IChsb2NhbHMgJiYgbG9jYWxzLmhhc093blByb3BlcnR5KGtleTApKSA/IGxvY2FscyA6IHNjb3BlOwoKICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiBwYXRoVmFsOwogICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5MF07CgogICAgaWYgKCFrZXkxKSByZXR1cm4gcGF0aFZhbDsKICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkxXTsKCiAgICBpZiAoIWtleTIpIHJldHVybiBwYXRoVmFsOwogICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTJdOwoKICAgIGlmICgha2V5MykgcmV0dXJuIHBhdGhWYWw7CiAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5M107CgogICAgaWYgKCFrZXk0KSByZXR1cm4gcGF0aFZhbDsKICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXk0XTsKCiAgICByZXR1cm4gcGF0aFZhbDsKICB9Owp9CgpmdW5jdGlvbiBnZXR0ZXJGbihwYXRoLCBvcHRpb25zLCBmdWxsRXhwKSB7CiAgdmFyIGZuID0gZ2V0dGVyRm5DYWNoZVtwYXRoXTsKCiAgaWYgKGZuKSByZXR1cm4gZm47CgogIHZhciBwYXRoS2V5cyA9IHBhdGguc3BsaXQoJy4nKSwKICAgICAgcGF0aEtleXNMZW5ndGggPSBwYXRoS2V5cy5sZW5ndGg7CgogIC8vIGh0dHA6Ly9qc3BlcmYuY29tL2FuZ3VsYXJqcy1wYXJzZS1nZXR0ZXIvNgogIGlmIChvcHRpb25zLmNzcCkgewogICAgaWYgKHBhdGhLZXlzTGVuZ3RoIDwgNikgewogICAgICBmbiA9IGNzcFNhZmVHZXR0ZXJGbihwYXRoS2V5c1swXSwgcGF0aEtleXNbMV0sIHBhdGhLZXlzWzJdLCBwYXRoS2V5c1szXSwgcGF0aEtleXNbNF0sIGZ1bGxFeHApOwogICAgfSBlbHNlIHsKICAgICAgZm4gPSBmdW5jdGlvbiBjc3BTYWZlR2V0dGVyKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICB2YXIgaSA9IDAsIHZhbDsKICAgICAgICBkbyB7CiAgICAgICAgICB2YWwgPSBjc3BTYWZlR2V0dGVyRm4ocGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoS2V5c1tpKytdLCBmdWxsRXhwKShzY29wZSwgbG9jYWxzKTsKCiAgICAgICAgICBsb2NhbHMgPSB1bmRlZmluZWQ7IC8vIGNsZWFyIGFmdGVyIGZpcnN0IGl0ZXJhdGlvbgogICAgICAgICAgc2NvcGUgPSB2YWw7CiAgICAgICAgfSB3aGlsZSAoaSA8IHBhdGhLZXlzTGVuZ3RoKTsKICAgICAgICByZXR1cm4gdmFsOwogICAgICB9OwogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgY29kZSA9ICcnOwogICAgZm9yRWFjaChwYXRoS2V5cywgZnVuY3Rpb24oa2V5LCBpbmRleCkgewogICAgICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXksIGZ1bGxFeHApOwogICAgICBjb2RlICs9ICdpZihzID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7XG4nICsKICAgICAgICAgICAgICAncz0nKyAoaW5kZXgKICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIHNpbXBseSBkZXJlZmVyZW5jZSAncycgb24gYW55IC5kb3Qgbm90YXRpb24KICAgICAgICAgICAgICAgICAgICAgID8gJ3MnCiAgICAgICAgICAgICAgICAgICAgICAvLyBidXQgaWYgd2UgYXJlIGZpcnN0IHRoZW4gd2UgY2hlY2sgbG9jYWxzIGZpcnN0LCBhbmQgaWYgc28gcmVhZCBpdCBmaXJzdAogICAgICAgICAgICAgICAgICAgICAgOiAnKChsJiZsLmhhc093blByb3BlcnR5KCInICsga2V5ICsgJyIpKT9sOnMpJykgKyAnLicgKyBrZXkgKyAnO1xuJzsKICAgIH0pOwogICAgY29kZSArPSAncmV0dXJuIHM7JzsKCiAgICAvKiBqc2hpbnQgLVcwNTQgKi8KICAgIHZhciBldmFsZWRGbkdldHRlciA9IG5ldyBGdW5jdGlvbigncycsICdsJywgY29kZSk7IC8vIHM9c2NvcGUsIGw9bG9jYWxzCiAgICAvKiBqc2hpbnQgK1cwNTQgKi8KICAgIGV2YWxlZEZuR2V0dGVyLnRvU3RyaW5nID0gdmFsdWVGbihjb2RlKTsKCiAgICBmbiA9IGV2YWxlZEZuR2V0dGVyOwogIH0KCiAgZm4uc2hhcmVkR2V0dGVyID0gdHJ1ZTsKICBmbi5hc3NpZ24gPSBmdW5jdGlvbihzZWxmLCB2YWx1ZSkgewogICAgcmV0dXJuIHNldHRlcihzZWxmLCBwYXRoLCB2YWx1ZSwgcGF0aCk7CiAgfTsKICBnZXR0ZXJGbkNhY2hlW3BhdGhdID0gZm47CiAgcmV0dXJuIGZuOwp9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRwYXJzZQogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICoKICogQ29udmVydHMgQW5ndWxhciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpbnRvIGEgZnVuY3Rpb24uCiAqCiAqIGBgYGpzCiAqICAgdmFyIGdldHRlciA9ICRwYXJzZSgndXNlci5uYW1lJyk7CiAqICAgdmFyIHNldHRlciA9IGdldHRlci5hc3NpZ247CiAqICAgdmFyIGNvbnRleHQgPSB7dXNlcjp7bmFtZTonYW5ndWxhcid9fTsKICogICB2YXIgbG9jYWxzID0ge3VzZXI6e25hbWU6J2xvY2FsJ319OwogKgogKiAgIGV4cGVjdChnZXR0ZXIoY29udGV4dCkpLnRvRXF1YWwoJ2FuZ3VsYXInKTsKICogICBzZXR0ZXIoY29udGV4dCwgJ25ld1ZhbHVlJyk7CiAqICAgZXhwZWN0KGNvbnRleHQudXNlci5uYW1lKS50b0VxdWFsKCduZXdWYWx1ZScpOwogKiAgIGV4cGVjdChnZXR0ZXIoY29udGV4dCwgbG9jYWxzKSkudG9FcXVhbCgnbG9jYWwnKTsKICogYGBgCiAqCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAqCiAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICogICAgICBgY29udGV4dGAuCiAqCiAqICAgIFRoZSByZXR1cm5lZCBmdW5jdGlvbiBhbHNvIGhhcyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAqICAgICAgKiBgbGl0ZXJhbGAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB3aGV0aGVyIHRoZSBleHByZXNzaW9uJ3MgdG9wLWxldmVsIG5vZGUgaXMgYSBKYXZhU2NyaXB0CiAqICAgICAgICBsaXRlcmFsLgogKiAgICAgICogYGNvbnN0YW50YCDigJMgYHtib29sZWFufWAg4oCTIHdoZXRoZXIgdGhlIGV4cHJlc3Npb24gaXMgbWFkZSBlbnRpcmVseSBvZiBKYXZhU2NyaXB0CiAqICAgICAgICBjb25zdGFudCBsaXRlcmFscy4KICogICAgICAqIGBhc3NpZ25gIOKAkyBgez9mdW5jdGlvbihjb250ZXh0LCB2YWx1ZSl9YCDigJMgaWYgdGhlIGV4cHJlc3Npb24gaXMgYXNzaWduYWJsZSwgdGhpcyB3aWxsIGJlCiAqICAgICAgICBzZXQgdG8gYSBmdW5jdGlvbiB0byBjaGFuZ2UgaXRzIHZhbHVlIG9uIHRoZSBnaXZlbiBjb250ZXh0LgogKgogKi8KCgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRwYXJzZVByb3ZpZGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBgJHBhcnNlUHJvdmlkZXJgIGNhbiBiZSB1c2VkIGZvciBjb25maWd1cmluZyB0aGUgZGVmYXVsdCBiZWhhdmlvciBvZiB0aGUge0BsaW5rIG5nLiRwYXJzZSAkcGFyc2V9CiAqICBzZXJ2aWNlLgogKi8KZnVuY3Rpb24gJFBhcnNlUHJvdmlkZXIoKSB7CiAgdmFyIGNhY2hlID0gY3JlYXRlTWFwKCk7CgogIHZhciAkcGFyc2VPcHRpb25zID0gewogICAgY3NwOiBmYWxzZQogIH07CgoKICB0aGlzLiRnZXQgPSBbJyRmaWx0ZXInLCAnJHNuaWZmZXInLCBmdW5jdGlvbigkZmlsdGVyLCAkc25pZmZlcikgewogICAgJHBhcnNlT3B0aW9ucy5jc3AgPSAkc25pZmZlci5jc3A7CgogICAgZnVuY3Rpb24gd3JhcFNoYXJlZEV4cHJlc3Npb24oZXhwKSB7CiAgICAgIHZhciB3cmFwcGVkID0gZXhwOwoKICAgICAgaWYgKGV4cC5zaGFyZWRHZXR0ZXIpIHsKICAgICAgICB3cmFwcGVkID0gZnVuY3Rpb24gJHBhcnNlV3JhcHBlcihzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgIHJldHVybiBleHAoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9OwogICAgICAgIHdyYXBwZWQubGl0ZXJhbCA9IGV4cC5saXRlcmFsOwogICAgICAgIHdyYXBwZWQuY29uc3RhbnQgPSBleHAuY29uc3RhbnQ7CiAgICAgICAgd3JhcHBlZC5hc3NpZ24gPSBleHAuYXNzaWduOwogICAgICB9CgogICAgICByZXR1cm4gd3JhcHBlZDsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gJHBhcnNlKGV4cCwgaW50ZXJjZXB0b3JGbikgewogICAgICB2YXIgcGFyc2VkRXhwcmVzc2lvbiwgb25lVGltZSwgY2FjaGVLZXk7CgogICAgICBzd2l0Y2ggKHR5cGVvZiBleHApIHsKICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgY2FjaGVLZXkgPSBleHAgPSBleHAudHJpbSgpOwoKICAgICAgICAgIHBhcnNlZEV4cHJlc3Npb24gPSBjYWNoZVtjYWNoZUtleV07CgogICAgICAgICAgaWYgKCFwYXJzZWRFeHByZXNzaW9uKSB7CiAgICAgICAgICAgIGlmIChleHAuY2hhckF0KDApID09PSAnOicgJiYgZXhwLmNoYXJBdCgxKSA9PT0gJzonKSB7CiAgICAgICAgICAgICAgb25lVGltZSA9IHRydWU7CiAgICAgICAgICAgICAgZXhwID0gZXhwLnN1YnN0cmluZygyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGxleGVyID0gbmV3IExleGVyKCRwYXJzZU9wdGlvbnMpOwogICAgICAgICAgICB2YXIgcGFyc2VyID0gbmV3IFBhcnNlcihsZXhlciwgJGZpbHRlciwgJHBhcnNlT3B0aW9ucyk7CiAgICAgICAgICAgIHBhcnNlZEV4cHJlc3Npb24gPSBwYXJzZXIucGFyc2UoZXhwKTsKCiAgICAgICAgICAgIGlmIChwYXJzZWRFeHByZXNzaW9uLmNvbnN0YW50KSB7CiAgICAgICAgICAgICAgcGFyc2VkRXhwcmVzc2lvbi4kJHdhdGNoRGVsZWdhdGUgPSBjb25zdGFudFdhdGNoRGVsZWdhdGU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAob25lVGltZSkgewogICAgICAgICAgICAgIC8vb25lVGltZSBpcyBub3QgcGFydCBvZiB0aGUgZXhwIHBhc3NlZCB0byB0aGUgUGFyc2VyIHNvIHdlIG1heSBoYXZlIHRvCiAgICAgICAgICAgICAgLy93cmFwIHRoZSBwYXJzZWRFeHByZXNzaW9uIGJlZm9yZSBhZGRpbmcgYSAkJHdhdGNoRGVsZWdhdGUKICAgICAgICAgICAgICBwYXJzZWRFeHByZXNzaW9uID0gd3JhcFNoYXJlZEV4cHJlc3Npb24ocGFyc2VkRXhwcmVzc2lvbik7CiAgICAgICAgICAgICAgcGFyc2VkRXhwcmVzc2lvbi4kJHdhdGNoRGVsZWdhdGUgPSBwYXJzZWRFeHByZXNzaW9uLmxpdGVyYWwgPwogICAgICAgICAgICAgICAgb25lVGltZUxpdGVyYWxXYXRjaERlbGVnYXRlIDogb25lVGltZVdhdGNoRGVsZWdhdGU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocGFyc2VkRXhwcmVzc2lvbi5pbnB1dHMpIHsKICAgICAgICAgICAgICBwYXJzZWRFeHByZXNzaW9uLiQkd2F0Y2hEZWxlZ2F0ZSA9IGlucHV0c1dhdGNoRGVsZWdhdGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNhY2hlW2NhY2hlS2V5XSA9IHBhcnNlZEV4cHJlc3Npb247CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYWRkSW50ZXJjZXB0b3IocGFyc2VkRXhwcmVzc2lvbiwgaW50ZXJjZXB0b3JGbik7CgogICAgICAgIGNhc2UgJ2Z1bmN0aW9uJzoKICAgICAgICAgIHJldHVybiBhZGRJbnRlcmNlcHRvcihleHAsIGludGVyY2VwdG9yRm4pOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIGFkZEludGVyY2VwdG9yKG5vb3AsIGludGVyY2VwdG9yRm4pOwogICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIGNvbGxlY3RFeHByZXNzaW9uSW5wdXRzKGlucHV0cywgbGlzdCkgewogICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBpbnB1dHMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgIHZhciBpbnB1dCA9IGlucHV0c1tpXTsKICAgICAgICBpZiAoIWlucHV0LmNvbnN0YW50KSB7CiAgICAgICAgICBpZiAoaW5wdXQuaW5wdXRzKSB7CiAgICAgICAgICAgIGNvbGxlY3RFeHByZXNzaW9uSW5wdXRzKGlucHV0LmlucHV0cywgbGlzdCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGxpc3QuaW5kZXhPZihpbnB1dCkgPT09IC0xKSB7IC8vIFRPRE8ocGVyZikgY2FuIHdlIGRvIGJldHRlcj8KICAgICAgICAgICAgbGlzdC5wdXNoKGlucHV0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBsaXN0OwogICAgfQoKICAgIGZ1bmN0aW9uIGV4cHJlc3Npb25JbnB1dERpcnR5Q2hlY2sobmV3VmFsdWUsIG9sZFZhbHVlT2ZWYWx1ZSkgewoKICAgICAgaWYgKG5ld1ZhbHVlID09IG51bGwgfHwgb2xkVmFsdWVPZlZhbHVlID09IG51bGwpIHsgLy8gbnVsbC91bmRlZmluZWQKICAgICAgICByZXR1cm4gbmV3VmFsdWUgPT09IG9sZFZhbHVlT2ZWYWx1ZTsKICAgICAgfQoKICAgICAgaWYgKHR5cGVvZiBuZXdWYWx1ZSA9PT0gJ29iamVjdCcpIHsKCiAgICAgICAgLy8gYXR0ZW1wdCB0byBjb252ZXJ0IHRoZSB2YWx1ZSB0byBhIHByaW1pdGl2ZSB0eXBlCiAgICAgICAgLy8gVE9ETyhkb2NzKTogYWRkIGEgbm90ZSB0byBkb2NzIHRoYXQgYnkgaW1wbGVtZW50aW5nIHZhbHVlT2YgZXZlbiBvYmplY3RzIGFuZCBhcnJheXMgY2FuCiAgICAgICAgLy8gICAgICAgICAgICAgYmUgY2hlYXBseSBkaXJ0eS1jaGVja2VkCiAgICAgICAgbmV3VmFsdWUgPSBuZXdWYWx1ZS52YWx1ZU9mKCk7CgogICAgICAgIGlmICh0eXBlb2YgbmV3VmFsdWUgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAvLyBvYmplY3RzL2FycmF5cyBhcmUgbm90IHN1cHBvcnRlZCAtIGRlZXAtd2F0Y2hpbmcgdGhlbSB3b3VsZCBiZSB0b28gZXhwZW5zaXZlCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICAvLyBmYWxsLXRocm91Z2ggdG8gdGhlIHByaW1pdGl2ZSBlcXVhbGl0eSBjaGVjawogICAgICB9CgogICAgICAvL1ByaW1pdGl2ZSBvciBOYU4KICAgICAgcmV0dXJuIG5ld1ZhbHVlID09PSBvbGRWYWx1ZU9mVmFsdWUgfHwgKG5ld1ZhbHVlICE9PSBuZXdWYWx1ZSAmJiBvbGRWYWx1ZU9mVmFsdWUgIT09IG9sZFZhbHVlT2ZWYWx1ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gaW5wdXRzV2F0Y2hEZWxlZ2F0ZShzY29wZSwgbGlzdGVuZXIsIG9iamVjdEVxdWFsaXR5LCBwYXJzZWRFeHByZXNzaW9uKSB7CiAgICAgIHZhciBpbnB1dEV4cHJlc3Npb25zID0gcGFyc2VkRXhwcmVzc2lvbi4kJGlucHV0cyB8fAogICAgICAgICAgICAgICAgICAgIChwYXJzZWRFeHByZXNzaW9uLiQkaW5wdXRzID0gY29sbGVjdEV4cHJlc3Npb25JbnB1dHMocGFyc2VkRXhwcmVzc2lvbi5pbnB1dHMsIFtdKSk7CgogICAgICB2YXIgbGFzdFJlc3VsdDsKCiAgICAgIGlmIChpbnB1dEV4cHJlc3Npb25zLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHZhciBvbGRJbnB1dFZhbHVlID0gZXhwcmVzc2lvbklucHV0RGlydHlDaGVjazsgLy8gaW5pdCB0byBzb21ldGhpbmcgdW5pcXVlIHNvIHRoYXQgZXF1YWxzIGNoZWNrIGZhaWxzCiAgICAgICAgaW5wdXRFeHByZXNzaW9ucyA9IGlucHV0RXhwcmVzc2lvbnNbMF07CiAgICAgICAgcmV0dXJuIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBleHByZXNzaW9uSW5wdXRXYXRjaChzY29wZSkgewogICAgICAgICAgdmFyIG5ld0lucHV0VmFsdWUgPSBpbnB1dEV4cHJlc3Npb25zKHNjb3BlKTsKICAgICAgICAgIGlmICghZXhwcmVzc2lvbklucHV0RGlydHlDaGVjayhuZXdJbnB1dFZhbHVlLCBvbGRJbnB1dFZhbHVlKSkgewogICAgICAgICAgICBsYXN0UmVzdWx0ID0gcGFyc2VkRXhwcmVzc2lvbihzY29wZSk7CiAgICAgICAgICAgIG9sZElucHV0VmFsdWUgPSBuZXdJbnB1dFZhbHVlICYmIG5ld0lucHV0VmFsdWUudmFsdWVPZigpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhc3RSZXN1bHQ7CiAgICAgICAgfSwgbGlzdGVuZXIsIG9iamVjdEVxdWFsaXR5KTsKICAgICAgfQoKICAgICAgdmFyIG9sZElucHV0VmFsdWVPZlZhbHVlcyA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBpbnB1dEV4cHJlc3Npb25zLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICBvbGRJbnB1dFZhbHVlT2ZWYWx1ZXNbaV0gPSBleHByZXNzaW9uSW5wdXREaXJ0eUNoZWNrOyAvLyBpbml0IHRvIHNvbWV0aGluZyB1bmlxdWUgc28gdGhhdCBlcXVhbHMgY2hlY2sgZmFpbHMKICAgICAgfQoKICAgICAgcmV0dXJuIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBleHByZXNzaW9uSW5wdXRzV2F0Y2goc2NvcGUpIHsKICAgICAgICB2YXIgY2hhbmdlZCA9IGZhbHNlOwoKICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBpbnB1dEV4cHJlc3Npb25zLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgIHZhciBuZXdJbnB1dFZhbHVlID0gaW5wdXRFeHByZXNzaW9uc1tpXShzY29wZSk7CiAgICAgICAgICBpZiAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9ICFleHByZXNzaW9uSW5wdXREaXJ0eUNoZWNrKG5ld0lucHV0VmFsdWUsIG9sZElucHV0VmFsdWVPZlZhbHVlc1tpXSkpKSB7CiAgICAgICAgICAgIG9sZElucHV0VmFsdWVPZlZhbHVlc1tpXSA9IG5ld0lucHV0VmFsdWUgJiYgbmV3SW5wdXRWYWx1ZS52YWx1ZU9mKCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoY2hhbmdlZCkgewogICAgICAgICAgbGFzdFJlc3VsdCA9IHBhcnNlZEV4cHJlc3Npb24oc2NvcGUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGxhc3RSZXN1bHQ7CiAgICAgIH0sIGxpc3RlbmVyLCBvYmplY3RFcXVhbGl0eSk7CiAgICB9CgogICAgZnVuY3Rpb24gb25lVGltZVdhdGNoRGVsZWdhdGUoc2NvcGUsIGxpc3RlbmVyLCBvYmplY3RFcXVhbGl0eSwgcGFyc2VkRXhwcmVzc2lvbikgewogICAgICB2YXIgdW53YXRjaCwgbGFzdFZhbHVlOwogICAgICByZXR1cm4gdW53YXRjaCA9IHNjb3BlLiR3YXRjaChmdW5jdGlvbiBvbmVUaW1lV2F0Y2goc2NvcGUpIHsKICAgICAgICByZXR1cm4gcGFyc2VkRXhwcmVzc2lvbihzY29wZSk7CiAgICAgIH0sIGZ1bmN0aW9uIG9uZVRpbWVMaXN0ZW5lcih2YWx1ZSwgb2xkLCBzY29wZSkgewogICAgICAgIGxhc3RWYWx1ZSA9IHZhbHVlOwogICAgICAgIGlmIChpc0Z1bmN0aW9uKGxpc3RlbmVyKSkgewogICAgICAgICAgbGlzdGVuZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgIHNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQobGFzdFZhbHVlKSkgewogICAgICAgICAgICAgIHVud2F0Y2goKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9LCBvYmplY3RFcXVhbGl0eSk7CiAgICB9CgogICAgZnVuY3Rpb24gb25lVGltZUxpdGVyYWxXYXRjaERlbGVnYXRlKHNjb3BlLCBsaXN0ZW5lciwgb2JqZWN0RXF1YWxpdHksIHBhcnNlZEV4cHJlc3Npb24pIHsKICAgICAgdmFyIHVud2F0Y2gsIGxhc3RWYWx1ZTsKICAgICAgcmV0dXJuIHVud2F0Y2ggPSBzY29wZS4kd2F0Y2goZnVuY3Rpb24gb25lVGltZVdhdGNoKHNjb3BlKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlZEV4cHJlc3Npb24oc2NvcGUpOwogICAgICB9LCBmdW5jdGlvbiBvbmVUaW1lTGlzdGVuZXIodmFsdWUsIG9sZCwgc2NvcGUpIHsKICAgICAgICBsYXN0VmFsdWUgPSB2YWx1ZTsKICAgICAgICBpZiAoaXNGdW5jdGlvbihsaXN0ZW5lcikpIHsKICAgICAgICAgIGxpc3RlbmVyLmNhbGwodGhpcywgdmFsdWUsIG9sZCwgc2NvcGUpOwogICAgICAgIH0KICAgICAgICBpZiAoaXNBbGxEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgc2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYoaXNBbGxEZWZpbmVkKGxhc3RWYWx1ZSkpIHVud2F0Y2goKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSwgb2JqZWN0RXF1YWxpdHkpOwoKICAgICAgZnVuY3Rpb24gaXNBbGxEZWZpbmVkKHZhbHVlKSB7CiAgICAgICAgdmFyIGFsbERlZmluZWQgPSB0cnVlOwogICAgICAgIGZvckVhY2godmFsdWUsIGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgIGlmICghaXNEZWZpbmVkKHZhbCkpIGFsbERlZmluZWQgPSBmYWxzZTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gYWxsRGVmaW5lZDsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNvbnN0YW50V2F0Y2hEZWxlZ2F0ZShzY29wZSwgbGlzdGVuZXIsIG9iamVjdEVxdWFsaXR5LCBwYXJzZWRFeHByZXNzaW9uKSB7CiAgICAgIHZhciB1bndhdGNoOwogICAgICByZXR1cm4gdW53YXRjaCA9IHNjb3BlLiR3YXRjaChmdW5jdGlvbiBjb25zdGFudFdhdGNoKHNjb3BlKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlZEV4cHJlc3Npb24oc2NvcGUpOwogICAgICB9LCBmdW5jdGlvbiBjb25zdGFudExpc3RlbmVyKHZhbHVlLCBvbGQsIHNjb3BlKSB7CiAgICAgICAgaWYgKGlzRnVuY3Rpb24obGlzdGVuZXIpKSB7CiAgICAgICAgICBsaXN0ZW5lci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICB1bndhdGNoKCk7CiAgICAgIH0sIG9iamVjdEVxdWFsaXR5KTsKICAgIH0KCiAgICBmdW5jdGlvbiBhZGRJbnRlcmNlcHRvcihwYXJzZWRFeHByZXNzaW9uLCBpbnRlcmNlcHRvckZuKSB7CiAgICAgIGlmICghaW50ZXJjZXB0b3JGbikgcmV0dXJuIHBhcnNlZEV4cHJlc3Npb247CgogICAgICB2YXIgZm4gPSBmdW5jdGlvbiBpbnRlcmNlcHRlZEV4cHJlc3Npb24oc2NvcGUsIGxvY2FscykgewogICAgICAgIHZhciB2YWx1ZSA9IHBhcnNlZEV4cHJlc3Npb24oc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgdmFyIHJlc3VsdCA9IGludGVyY2VwdG9yRm4odmFsdWUsIHNjb3BlLCBsb2NhbHMpOwogICAgICAgIC8vIHdlIG9ubHkgcmV0dXJuIHRoZSBpbnRlcmNlcHRvcidzIHJlc3VsdCBpZiB0aGUKICAgICAgICAvLyBpbml0aWFsIHZhbHVlIGlzIGRlZmluZWQgKGZvciBiaW5kLW9uY2UpCiAgICAgICAgcmV0dXJuIGlzRGVmaW5lZCh2YWx1ZSkgPyByZXN1bHQgOiB2YWx1ZTsKICAgICAgfTsKCiAgICAgIC8vIFByb3BhZ2F0ZSAkJHdhdGNoRGVsZWdhdGVzIG90aGVyIHRoZW4gaW5wdXRzV2F0Y2hEZWxlZ2F0ZQogICAgICBpZiAocGFyc2VkRXhwcmVzc2lvbi4kJHdhdGNoRGVsZWdhdGUgJiYKICAgICAgICAgIHBhcnNlZEV4cHJlc3Npb24uJCR3YXRjaERlbGVnYXRlICE9PSBpbnB1dHNXYXRjaERlbGVnYXRlKSB7CiAgICAgICAgZm4uJCR3YXRjaERlbGVnYXRlID0gcGFyc2VkRXhwcmVzc2lvbi4kJHdhdGNoRGVsZWdhdGU7CiAgICAgIH0gZWxzZSBpZiAoIWludGVyY2VwdG9yRm4uJHN0YXRlZnVsKSB7CiAgICAgICAgLy8gSWYgdGhlcmUgaXMgYW4gaW50ZXJjZXB0b3IsIGJ1dCBubyB3YXRjaERlbGVnYXRlIHRoZW4gdHJlYXQgdGhlIGludGVyY2VwdG9yIGxpa2UKICAgICAgICAvLyB3ZSB0cmVhdCBmaWx0ZXJzIC0gaXQgaXMgYXNzdW1lZCB0byBiZSBhIHB1cmUgZnVuY3Rpb24gdW5sZXNzIGZsYWdnZWQgd2l0aCAkc3RhdGVmdWwKICAgICAgICBmbi4kJHdhdGNoRGVsZWdhdGUgPSBpbnB1dHNXYXRjaERlbGVnYXRlOwogICAgICAgIGZuLmlucHV0cyA9IFtwYXJzZWRFeHByZXNzaW9uXTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZuOwogICAgfQogIH1dOwp9CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHEKICogQHJlcXVpcmVzICRyb290U2NvcGUKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgcHJvbWlzZS9kZWZlcnJlZCBpbXBsZW1lbnRhdGlvbiBpbnNwaXJlZCBieSBbS3JpcyBLb3dhbCdzIFFdKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcSkuCiAqCiAqICRxIGNhbiBiZSB1c2VkIGluIHR3byBmYXNoaW9ucyAtLS0gb25lIHdoaWNoIGlzIG1vcmUgc2ltaWxhciB0byBLcmlzIEtvd2FsJ3MgUSBvciBqUXVlcnkncyBEZWZlcnJlZAogKiBpbXBsZW1lbnRhdGlvbnMsIGFuZCB0aGUgb3RoZXIgd2hpY2ggcmVzZW1ibGVzIEVTNiBwcm9taXNlcyB0byBzb21lIGRlZ3JlZS4KICoKICogIyAkcSBjb25zdHJ1Y3RvcgogKgogKiBUaGUgc3RyZWFtbGluZWQgRVM2IHN0eWxlIHByb21pc2UgaXMgZXNzZW50aWFsbHkganVzdCB1c2luZyAkcSBhcyBhIGNvbnN0cnVjdG9yIHdoaWNoIHRha2VzIGEgYHJlc29sdmVyYAogKiBmdW5jdGlvbiBhcyB0aGUgZmlyc3QgYXJndW1lbnQuIFRoaXMgaXMgc2ltaWxhciB0byB0aGUgbmF0aXZlIFByb21pc2UgaW1wbGVtZW50YXRpb24gZnJvbSBFUzYgSGFybW9ueSwKICogc2VlIFtNRE5dKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL1Byb21pc2UpLgogKgogKiBXaGlsZSB0aGUgY29uc3RydWN0b3Itc3R5bGUgdXNlIGlzIHN1cHBvcnRlZCwgbm90IGFsbCBvZiB0aGUgc3VwcG9ydGluZyBtZXRob2RzIGZyb20gRVM2IEhhcm1vbnkgcHJvbWlzZXMgYXJlCiAqIGF2YWlsYWJsZSB5ZXQuCiAqCiAqIEl0IGNhbiBiZSB1c2VkIGxpa2Ugc286CiAqCiAqIGBgYGpzCiAqICAgLy8gZm9yIHRoZSBwdXJwb3NlIG9mIHRoaXMgZXhhbXBsZSBsZXQncyBhc3N1bWUgdGhhdCB2YXJpYWJsZXMgYCRxYCBhbmQgYG9rVG9HcmVldGAKICogICAvLyBhcmUgYXZhaWxhYmxlIGluIHRoZSBjdXJyZW50IGxleGljYWwgc2NvcGUgKHRoZXkgY291bGQgaGF2ZSBiZWVuIGluamVjdGVkIG9yIHBhc3NlZCBpbikuCiAqCiAqICAgZnVuY3Rpb24gYXN5bmNHcmVldChuYW1lKSB7CiAqICAgICAvLyBwZXJmb3JtIHNvbWUgYXN5bmNocm9ub3VzIG9wZXJhdGlvbiwgcmVzb2x2ZSBvciByZWplY3QgdGhlIHByb21pc2Ugd2hlbiBhcHByb3ByaWF0ZS4KICogICAgIHJldHVybiAkcShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICogICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICogICAgICAgICBpZiAob2tUb0dyZWV0KG5hbWUpKSB7CiAqICAgICAgICAgICByZXNvbHZlKCdIZWxsbywgJyArIG5hbWUgKyAnIScpOwogKiAgICAgICAgIH0gZWxzZSB7CiAqICAgICAgICAgICByZWplY3QoJ0dyZWV0aW5nICcgKyBuYW1lICsgJyBpcyBub3QgYWxsb3dlZC4nKTsKICogICAgICAgICB9CiAqICAgICAgIH0sIDEwMDApOwogKiAgICAgfSk7CiAqICAgfQogKgogKiAgIHZhciBwcm9taXNlID0gYXN5bmNHcmVldCgnUm9iaW4gSG9vZCcpOwogKiAgIHByb21pc2UudGhlbihmdW5jdGlvbihncmVldGluZykgewogKiAgICAgYWxlcnQoJ1N1Y2Nlc3M6ICcgKyBncmVldGluZyk7CiAqICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAqICAgICBhbGVydCgnRmFpbGVkOiAnICsgcmVhc29uKTsKICogICB9KTsKICogYGBgCiAqCiAqIE5vdGU6IHByb2dyZXNzL25vdGlmeSBjYWxsYmFja3MgYXJlIG5vdCBjdXJyZW50bHkgc3VwcG9ydGVkIHZpYSB0aGUgRVM2LXN0eWxlIGludGVyZmFjZS4KICoKICogSG93ZXZlciwgdGhlIG1vcmUgdHJhZGl0aW9uYWwgQ29tbW9uSlMtc3R5bGUgdXNhZ2UgaXMgc3RpbGwgYXZhaWxhYmxlLCBhbmQgZG9jdW1lbnRlZCBiZWxvdy4KICoKICogW1RoZSBDb21tb25KUyBQcm9taXNlIHByb3Bvc2FsXShodHRwOi8vd2lraS5jb21tb25qcy5vcmcvd2lraS9Qcm9taXNlcykgZGVzY3JpYmVzIGEgcHJvbWlzZSBhcyBhbgogKiBpbnRlcmZhY2UgZm9yIGludGVyYWN0aW5nIHdpdGggYW4gb2JqZWN0IHRoYXQgcmVwcmVzZW50cyB0aGUgcmVzdWx0IG9mIGFuIGFjdGlvbiB0aGF0IGlzCiAqIHBlcmZvcm1lZCBhc3luY2hyb25vdXNseSwgYW5kIG1heSBvciBtYXkgbm90IGJlIGZpbmlzaGVkIGF0IGFueSBnaXZlbiBwb2ludCBpbiB0aW1lLgogKgogKiBGcm9tIHRoZSBwZXJzcGVjdGl2ZSBvZiBkZWFsaW5nIHdpdGggZXJyb3IgaGFuZGxpbmcsIGRlZmVycmVkIGFuZCBwcm9taXNlIEFQSXMgYXJlIHRvCiAqIGFzeW5jaHJvbm91cyBwcm9ncmFtbWluZyB3aGF0IGB0cnlgLCBgY2F0Y2hgIGFuZCBgdGhyb3dgIGtleXdvcmRzIGFyZSB0byBzeW5jaHJvbm91cyBwcm9ncmFtbWluZy4KICoKICogYGBganMKICogICAvLyBmb3IgdGhlIHB1cnBvc2Ugb2YgdGhpcyBleGFtcGxlIGxldCdzIGFzc3VtZSB0aGF0IHZhcmlhYmxlcyBgJHFgIGFuZCBgb2tUb0dyZWV0YAogKiAgIC8vIGFyZSBhdmFpbGFibGUgaW4gdGhlIGN1cnJlbnQgbGV4aWNhbCBzY29wZSAodGhleSBjb3VsZCBoYXZlIGJlZW4gaW5qZWN0ZWQgb3IgcGFzc2VkIGluKS4KICoKICogICBmdW5jdGlvbiBhc3luY0dyZWV0KG5hbWUpIHsKICogICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7CiAqCiAqICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogKiAgICAgICBkZWZlcnJlZC5ub3RpZnkoJ0Fib3V0IHRvIGdyZWV0ICcgKyBuYW1lICsgJy4nKTsKICoKICogICAgICAgaWYgKG9rVG9HcmVldChuYW1lKSkgewogKiAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoJ0hlbGxvLCAnICsgbmFtZSArICchJyk7CiAqICAgICAgIH0gZWxzZSB7CiAqICAgICAgICAgZGVmZXJyZWQucmVqZWN0KCdHcmVldGluZyAnICsgbmFtZSArICcgaXMgbm90IGFsbG93ZWQuJyk7CiAqICAgICAgIH0KICogICAgIH0sIDEwMDApOwogKgogKiAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAqICAgfQogKgogKiAgIHZhciBwcm9taXNlID0gYXN5bmNHcmVldCgnUm9iaW4gSG9vZCcpOwogKiAgIHByb21pc2UudGhlbihmdW5jdGlvbihncmVldGluZykgewogKiAgICAgYWxlcnQoJ1N1Y2Nlc3M6ICcgKyBncmVldGluZyk7CiAqICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAqICAgICBhbGVydCgnRmFpbGVkOiAnICsgcmVhc29uKTsKICogICB9LCBmdW5jdGlvbih1cGRhdGUpIHsKICogICAgIGFsZXJ0KCdHb3Qgbm90aWZpY2F0aW9uOiAnICsgdXBkYXRlKTsKICogICB9KTsKICogYGBgCiAqCiAqIEF0IGZpcnN0IGl0IG1pZ2h0IG5vdCBiZSBvYnZpb3VzIHdoeSB0aGlzIGV4dHJhIGNvbXBsZXhpdHkgaXMgd29ydGggdGhlIHRyb3VibGUuIFRoZSBwYXlvZmYKICogY29tZXMgaW4gdGhlIHdheSBvZiBndWFyYW50ZWVzIHRoYXQgcHJvbWlzZSBhbmQgZGVmZXJyZWQgQVBJcyBtYWtlLCBzZWUKICogaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC91bmNvbW1vbmpzL2Jsb2IvbWFzdGVyL3Byb21pc2VzL3NwZWNpZmljYXRpb24ubWQuCiAqCiAqIEFkZGl0aW9uYWxseSB0aGUgcHJvbWlzZSBhcGkgYWxsb3dzIGZvciBjb21wb3NpdGlvbiB0aGF0IGlzIHZlcnkgaGFyZCB0byBkbyB3aXRoIHRoZQogKiB0cmFkaXRpb25hbCBjYWxsYmFjayAoW0NQU10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Db250aW51YXRpb24tcGFzc2luZ19zdHlsZSkpIGFwcHJvYWNoLgogKiBGb3IgbW9yZSBvbiB0aGlzIHBsZWFzZSBzZWUgdGhlIFtRIGRvY3VtZW50YXRpb25dKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcSkgZXNwZWNpYWxseSB0aGUKICogc2VjdGlvbiBvbiBzZXJpYWwgb3IgcGFyYWxsZWwgam9pbmluZyBvZiBwcm9taXNlcy4KICoKICogIyBUaGUgRGVmZXJyZWQgQVBJCiAqCiAqIEEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkIGlzIGNvbnN0cnVjdGVkIGJ5IGNhbGxpbmcgYCRxLmRlZmVyKClgLgogKgogKiBUaGUgcHVycG9zZSBvZiB0aGUgZGVmZXJyZWQgb2JqZWN0IGlzIHRvIGV4cG9zZSB0aGUgYXNzb2NpYXRlZCBQcm9taXNlIGluc3RhbmNlIGFzIHdlbGwgYXMgQVBJcwogKiB0aGF0IGNhbiBiZSB1c2VkIGZvciBzaWduYWxpbmcgdGhlIHN1Y2Nlc3NmdWwgb3IgdW5zdWNjZXNzZnVsIGNvbXBsZXRpb24sIGFzIHdlbGwgYXMgdGhlIHN0YXR1cwogKiBvZiB0aGUgdGFzay4KICoKICogKipNZXRob2RzKioKICoKICogLSBgcmVzb2x2ZSh2YWx1ZSlgIOKAkyByZXNvbHZlcyB0aGUgZGVyaXZlZCBwcm9taXNlIHdpdGggdGhlIGB2YWx1ZWAuIElmIHRoZSB2YWx1ZSBpcyBhIHJlamVjdGlvbgogKiAgIGNvbnN0cnVjdGVkIHZpYSBgJHEucmVqZWN0YCwgdGhlIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCBpbnN0ZWFkLgogKiAtIGByZWplY3QocmVhc29uKWAg4oCTIHJlamVjdHMgdGhlIGRlcml2ZWQgcHJvbWlzZSB3aXRoIHRoZSBgcmVhc29uYC4gVGhpcyBpcyBlcXVpdmFsZW50IHRvCiAqICAgcmVzb2x2aW5nIGl0IHdpdGggYSByZWplY3Rpb24gY29uc3RydWN0ZWQgdmlhIGAkcS5yZWplY3RgLgogKiAtIGBub3RpZnkodmFsdWUpYCAtIHByb3ZpZGVzIHVwZGF0ZXMgb24gdGhlIHN0YXR1cyBvZiB0aGUgcHJvbWlzZSdzIGV4ZWN1dGlvbi4gVGhpcyBtYXkgYmUgY2FsbGVkCiAqICAgbXVsdGlwbGUgdGltZXMgYmVmb3JlIHRoZSBwcm9taXNlIGlzIGVpdGhlciByZXNvbHZlZCBvciByZWplY3RlZC4KICoKICogKipQcm9wZXJ0aWVzKioKICoKICogLSBwcm9taXNlIOKAkyBge1Byb21pc2V9YCDigJMgcHJvbWlzZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoaXMgZGVmZXJyZWQuCiAqCiAqCiAqICMgVGhlIFByb21pc2UgQVBJCiAqCiAqIEEgbmV3IHByb21pc2UgaW5zdGFuY2UgaXMgY3JlYXRlZCB3aGVuIGEgZGVmZXJyZWQgaW5zdGFuY2UgaXMgY3JlYXRlZCBhbmQgY2FuIGJlIHJldHJpZXZlZCBieQogKiBjYWxsaW5nIGBkZWZlcnJlZC5wcm9taXNlYC4KICoKICogVGhlIHB1cnBvc2Ugb2YgdGhlIHByb21pc2Ugb2JqZWN0IGlzIHRvIGFsbG93IGZvciBpbnRlcmVzdGVkIHBhcnRpZXMgdG8gZ2V0IGFjY2VzcyB0byB0aGUgcmVzdWx0CiAqIG9mIHRoZSBkZWZlcnJlZCB0YXNrIHdoZW4gaXQgY29tcGxldGVzLgogKgogKiAqKk1ldGhvZHMqKgogKgogKiAtIGB0aGVuKHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjaywgbm90aWZ5Q2FsbGJhY2spYCDigJMgcmVnYXJkbGVzcyBvZiB3aGVuIHRoZSBwcm9taXNlIHdhcyBvcgogKiAgIHdpbGwgYmUgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQsIGB0aGVuYCBjYWxscyBvbmUgb2YgdGhlIHN1Y2Nlc3Mgb3IgZXJyb3IgY2FsbGJhY2tzIGFzeW5jaHJvbm91c2x5CiAqICAgYXMgc29vbiBhcyB0aGUgcmVzdWx0IGlzIGF2YWlsYWJsZS4gVGhlIGNhbGxiYWNrcyBhcmUgY2FsbGVkIHdpdGggYSBzaW5nbGUgYXJndW1lbnQ6IHRoZSByZXN1bHQKICogICBvciByZWplY3Rpb24gcmVhc29uLiBBZGRpdGlvbmFsbHksIHRoZSBub3RpZnkgY2FsbGJhY2sgbWF5IGJlIGNhbGxlZCB6ZXJvIG9yIG1vcmUgdGltZXMgdG8KICogICBwcm92aWRlIGEgcHJvZ3Jlc3MgaW5kaWNhdGlvbiwgYmVmb3JlIHRoZSBwcm9taXNlIGlzIHJlc29sdmVkIG9yIHJlamVjdGVkLgogKgogKiAgIFRoaXMgbWV0aG9kICpyZXR1cm5zIGEgbmV3IHByb21pc2UqIHdoaWNoIGlzIHJlc29sdmVkIG9yIHJlamVjdGVkIHZpYSB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZQogKiAgIGBzdWNjZXNzQ2FsbGJhY2tgLCBgZXJyb3JDYWxsYmFja2AuIEl0IGFsc28gbm90aWZpZXMgdmlhIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlCiAqICAgYG5vdGlmeUNhbGxiYWNrYCBtZXRob2QuIFRoZSBwcm9taXNlIGNhbm5vdCBiZSByZXNvbHZlZCBvciByZWplY3RlZCBmcm9tIHRoZSBub3RpZnlDYWxsYmFjawogKiAgIG1ldGhvZC4KICoKICogLSBgY2F0Y2goZXJyb3JDYWxsYmFjaylgIOKAkyBzaG9ydGhhbmQgZm9yIGBwcm9taXNlLnRoZW4obnVsbCwgZXJyb3JDYWxsYmFjaylgCiAqCiAqIC0gYGZpbmFsbHkoY2FsbGJhY2spYCDigJMgYWxsb3dzIHlvdSB0byBvYnNlcnZlIGVpdGhlciB0aGUgZnVsZmlsbG1lbnQgb3IgcmVqZWN0aW9uIG9mIGEgcHJvbWlzZSwKICogICBidXQgdG8gZG8gc28gd2l0aG91dCBtb2RpZnlpbmcgdGhlIGZpbmFsIHZhbHVlLiBUaGlzIGlzIHVzZWZ1bCB0byByZWxlYXNlIHJlc291cmNlcyBvciBkbyBzb21lCiAqICAgY2xlYW4tdXAgdGhhdCBuZWVkcyB0byBiZSBkb25lIHdoZXRoZXIgdGhlIHByb21pc2Ugd2FzIHJlamVjdGVkIG9yIHJlc29sdmVkLiBTZWUgdGhlIFtmdWxsCiAqICAgc3BlY2lmaWNhdGlvbl0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xL3dpa2kvQVBJLVJlZmVyZW5jZSNwcm9taXNlZmluYWxseWNhbGxiYWNrKSBmb3IKICogICBtb3JlIGluZm9ybWF0aW9uLgogKgogKiAgIEJlY2F1c2UgYGZpbmFsbHlgIGlzIGEgcmVzZXJ2ZWQgd29yZCBpbiBKYXZhU2NyaXB0IGFuZCByZXNlcnZlZCBrZXl3b3JkcyBhcmUgbm90IHN1cHBvcnRlZCBhcwogKiAgIHByb3BlcnR5IG5hbWVzIGJ5IEVTMywgeW91J2xsIG5lZWQgdG8gaW52b2tlIHRoZSBtZXRob2QgbGlrZSBgcHJvbWlzZVsnZmluYWxseSddKGNhbGxiYWNrKWAgdG8KICogICBtYWtlIHlvdXIgY29kZSBJRTggYW5kIEFuZHJvaWQgMi54IGNvbXBhdGlibGUuCiAqCiAqICMgQ2hhaW5pbmcgcHJvbWlzZXMKICoKICogQmVjYXVzZSBjYWxsaW5nIHRoZSBgdGhlbmAgbWV0aG9kIG9mIGEgcHJvbWlzZSByZXR1cm5zIGEgbmV3IGRlcml2ZWQgcHJvbWlzZSwgaXQgaXMgZWFzaWx5CiAqIHBvc3NpYmxlIHRvIGNyZWF0ZSBhIGNoYWluIG9mIHByb21pc2VzOgogKgogKiBgYGBqcwogKiAgIHByb21pc2VCID0gcHJvbWlzZUEudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICogICAgIHJldHVybiByZXN1bHQgKyAxOwogKiAgIH0pOwogKgogKiAgIC8vIHByb21pc2VCIHdpbGwgYmUgcmVzb2x2ZWQgaW1tZWRpYXRlbHkgYWZ0ZXIgcHJvbWlzZUEgaXMgcmVzb2x2ZWQgYW5kIGl0cyB2YWx1ZQogKiAgIC8vIHdpbGwgYmUgdGhlIHJlc3VsdCBvZiBwcm9taXNlQSBpbmNyZW1lbnRlZCBieSAxCiAqIGBgYAogKgogKiBJdCBpcyBwb3NzaWJsZSB0byBjcmVhdGUgY2hhaW5zIG9mIGFueSBsZW5ndGggYW5kIHNpbmNlIGEgcHJvbWlzZSBjYW4gYmUgcmVzb2x2ZWQgd2l0aCBhbm90aGVyCiAqIHByb21pc2UgKHdoaWNoIHdpbGwgZGVmZXIgaXRzIHJlc29sdXRpb24gZnVydGhlciksIGl0IGlzIHBvc3NpYmxlIHRvIHBhdXNlL2RlZmVyIHJlc29sdXRpb24gb2YKICogdGhlIHByb21pc2VzIGF0IGFueSBwb2ludCBpbiB0aGUgY2hhaW4uIFRoaXMgbWFrZXMgaXQgcG9zc2libGUgdG8gaW1wbGVtZW50IHBvd2VyZnVsIEFQSXMgbGlrZQogKiAkaHR0cCdzIHJlc3BvbnNlIGludGVyY2VwdG9ycy4KICoKICoKICogIyBEaWZmZXJlbmNlcyBiZXR3ZWVuIEtyaXMgS293YWwncyBRIGFuZCAkcQogKgogKiAgVGhlcmUgYXJlIHR3byBtYWluIGRpZmZlcmVuY2VzOgogKgogKiAtICRxIGlzIGludGVncmF0ZWQgd2l0aCB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGV9IFNjb3BlIG1vZGVsIG9ic2VydmF0aW9uCiAqICAgbWVjaGFuaXNtIGluIGFuZ3VsYXIsIHdoaWNoIG1lYW5zIGZhc3RlciBwcm9wYWdhdGlvbiBvZiByZXNvbHV0aW9uIG9yIHJlamVjdGlvbiBpbnRvIHlvdXIKICogICBtb2RlbHMgYW5kIGF2b2lkaW5nIHVubmVjZXNzYXJ5IGJyb3dzZXIgcmVwYWludHMsIHdoaWNoIHdvdWxkIHJlc3VsdCBpbiBmbGlja2VyaW5nIFVJLgogKiAtIFEgaGFzIG1hbnkgbW9yZSBmZWF0dXJlcyB0aGFuICRxLCBidXQgdGhhdCBjb21lcyBhdCBhIGNvc3Qgb2YgYnl0ZXMuICRxIGlzIHRpbnksIGJ1dCBjb250YWlucwogKiAgIGFsbCB0aGUgaW1wb3J0YW50IGZ1bmN0aW9uYWxpdHkgbmVlZGVkIGZvciBjb21tb24gYXN5bmMgdGFza3MuCiAqCiAqICAjIFRlc3RpbmcKICoKICogIGBgYGpzCiAqICAgIGl0KCdzaG91bGQgc2ltdWxhdGUgcHJvbWlzZScsIGluamVjdChmdW5jdGlvbigkcSwgJHJvb3RTY29wZSkgewogKiAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7CiAqICAgICAgdmFyIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlOwogKiAgICAgIHZhciByZXNvbHZlZFZhbHVlOwogKgogKiAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSkgeyByZXNvbHZlZFZhbHVlID0gdmFsdWU7IH0pOwogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0JlVW5kZWZpbmVkKCk7CiAqCiAqICAgICAgLy8gU2ltdWxhdGUgcmVzb2x2aW5nIG9mIHByb21pc2UKICogICAgICBkZWZlcnJlZC5yZXNvbHZlKDEyMyk7CiAqICAgICAgLy8gTm90ZSB0aGF0IHRoZSAndGhlbicgZnVuY3Rpb24gZG9lcyBub3QgZ2V0IGNhbGxlZCBzeW5jaHJvbm91c2x5LgogKiAgICAgIC8vIFRoaXMgaXMgYmVjYXVzZSB3ZSB3YW50IHRoZSBwcm9taXNlIEFQSSB0byBhbHdheXMgYmUgYXN5bmMsIHdoZXRoZXIgb3Igbm90CiAqICAgICAgLy8gaXQgZ290IGNhbGxlZCBzeW5jaHJvbm91c2x5IG9yIGFzeW5jaHJvbm91c2x5LgogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0JlVW5kZWZpbmVkKCk7CiAqCiAqICAgICAgLy8gUHJvcGFnYXRlIHByb21pc2UgcmVzb2x1dGlvbiB0byAndGhlbicgZnVuY3Rpb25zIHVzaW5nICRhcHBseSgpLgogKiAgICAgICRyb290U2NvcGUuJGFwcGx5KCk7CiAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvRXF1YWwoMTIzKTsKICogICAgfSkpOwogKiAgYGBgCiAqCiAqIEBwYXJhbSB7ZnVuY3Rpb24oZnVuY3Rpb24sIGZ1bmN0aW9uKX0gcmVzb2x2ZXIgRnVuY3Rpb24gd2hpY2ggaXMgcmVzcG9uc2libGUgZm9yIHJlc29sdmluZyBvcgogKiAgIHJlamVjdGluZyB0aGUgbmV3bHkgY3JlYXRlZCBwcm9taXNlLiBUaGUgZmlyc3QgcGFyYW1ldGVyIGlzIGEgZnVuY3Rpb24gd2hpY2ggcmVzb2x2ZXMgdGhlCiAqICAgcHJvbWlzZSwgdGhlIHNlY29uZCBwYXJhbWV0ZXIgaXMgYSBmdW5jdGlvbiB3aGljaCByZWplY3RzIHRoZSBwcm9taXNlLgogKgogKiBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIG5ld2x5IGNyZWF0ZWQgcHJvbWlzZS4KICovCmZ1bmN0aW9uICRRUHJvdmlkZXIoKSB7CgogIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckZXhjZXB0aW9uSGFuZGxlcicsIGZ1bmN0aW9uKCRyb290U2NvcGUsICRleGNlcHRpb25IYW5kbGVyKSB7CiAgICByZXR1cm4gcUZhY3RvcnkoZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGNhbGxiYWNrKTsKICAgIH0sICRleGNlcHRpb25IYW5kbGVyKTsKICB9XTsKfQoKZnVuY3Rpb24gJCRRUHJvdmlkZXIoKSB7CiAgdGhpcy4kZ2V0ID0gWyckYnJvd3NlcicsICckZXhjZXB0aW9uSGFuZGxlcicsIGZ1bmN0aW9uKCRicm93c2VyLCAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgcmV0dXJuIHFGYWN0b3J5KGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICRicm93c2VyLmRlZmVyKGNhbGxiYWNrKTsKICAgIH0sICRleGNlcHRpb25IYW5kbGVyKTsKICB9XTsKfQoKLyoqCiAqIENvbnN0cnVjdHMgYSBwcm9taXNlIG1hbmFnZXIuCiAqCiAqIEBwYXJhbSB7ZnVuY3Rpb24oZnVuY3Rpb24pfSBuZXh0VGljayBGdW5jdGlvbiBmb3IgZXhlY3V0aW5nIGZ1bmN0aW9ucyBpbiB0aGUgbmV4dCB0dXJuLgogKiBAcGFyYW0ge2Z1bmN0aW9uKC4uLiopfSBleGNlcHRpb25IYW5kbGVyIEZ1bmN0aW9uIGludG8gd2hpY2ggdW5leHBlY3RlZCBleGNlcHRpb25zIGFyZSBwYXNzZWQgZm9yCiAqICAgICBkZWJ1Z2dpbmcgcHVycG9zZXMuCiAqIEByZXR1cm5zIHtvYmplY3R9IFByb21pc2UgbWFuYWdlci4KICovCmZ1bmN0aW9uIHFGYWN0b3J5KG5leHRUaWNrLCBleGNlcHRpb25IYW5kbGVyKSB7CiAgdmFyICRxTWluRXJyID0gbWluRXJyKCckcScsIFR5cGVFcnJvcik7CiAgZnVuY3Rpb24gY2FsbE9uY2Uoc2VsZiwgcmVzb2x2ZUZuLCByZWplY3RGbikgewogICAgdmFyIGNhbGxlZCA9IGZhbHNlOwogICAgZnVuY3Rpb24gd3JhcChmbikgewogICAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAoY2FsbGVkKSByZXR1cm47CiAgICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgICBmbi5jYWxsKHNlbGYsIHZhbHVlKTsKICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gW3dyYXAocmVzb2x2ZUZuKSwgd3JhcChyZWplY3RGbildOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIG5nLiRxI2RlZmVyCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSBgRGVmZXJyZWRgIG9iamVjdCB3aGljaCByZXByZXNlbnRzIGEgdGFzayB3aGljaCB3aWxsIGZpbmlzaCBpbiB0aGUgZnV0dXJlLgogICAqCiAgICogQHJldHVybnMge0RlZmVycmVkfSBSZXR1cm5zIGEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkLgogICAqLwogIHZhciBkZWZlciA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBEZWZlcnJlZCgpOwogIH07CgogIGZ1bmN0aW9uIFByb21pc2UoKSB7CiAgICB0aGlzLiQkc3RhdGUgPSB7IHN0YXR1czogMCB9OwogIH0KCiAgUHJvbWlzZS5wcm90b3R5cGUgPSB7CiAgICB0aGVuOiBmdW5jdGlvbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgcHJvZ3Jlc3NCYWNrKSB7CiAgICAgIHZhciByZXN1bHQgPSBuZXcgRGVmZXJyZWQoKTsKCiAgICAgIHRoaXMuJCRzdGF0ZS5wZW5kaW5nID0gdGhpcy4kJHN0YXRlLnBlbmRpbmcgfHwgW107CiAgICAgIHRoaXMuJCRzdGF0ZS5wZW5kaW5nLnB1c2goW3Jlc3VsdCwgb25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIHByb2dyZXNzQmFja10pOwogICAgICBpZiAodGhpcy4kJHN0YXRlLnN0YXR1cyA+IDApIHNjaGVkdWxlUHJvY2Vzc1F1ZXVlKHRoaXMuJCRzdGF0ZSk7CgogICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICB9LAoKICAgICJjYXRjaCI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLnRoZW4obnVsbCwgY2FsbGJhY2spOwogICAgfSwKCiAgICAiZmluYWxseSI6IGZ1bmN0aW9uKGNhbGxiYWNrLCBwcm9ncmVzc0JhY2spIHsKICAgICAgcmV0dXJuIHRoaXMudGhlbihmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBoYW5kbGVDYWxsYmFjayh2YWx1ZSwgdHJ1ZSwgY2FsbGJhY2spOwogICAgICB9LCBmdW5jdGlvbihlcnJvcikgewogICAgICAgIHJldHVybiBoYW5kbGVDYWxsYmFjayhlcnJvciwgZmFsc2UsIGNhbGxiYWNrKTsKICAgICAgfSwgcHJvZ3Jlc3NCYWNrKTsKICAgIH0KICB9OwoKICAvL0Zhc3RlciwgbW9yZSBiYXNpYyB0aGFuIGFuZ3VsYXIuYmluZCBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyLWJpbmQtdnMtY3VzdG9tLXZzLW5hdGl2ZQogIGZ1bmN0aW9uIHNpbXBsZUJpbmQoY29udGV4dCwgZm4pIHsKICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgICBmbi5jYWxsKGNvbnRleHQsIHZhbHVlKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBwcm9jZXNzUXVldWUoc3RhdGUpIHsKICAgIHZhciBmbiwgcHJvbWlzZSwgcGVuZGluZzsKCiAgICBwZW5kaW5nID0gc3RhdGUucGVuZGluZzsKICAgIHN0YXRlLnByb2Nlc3NTY2hlZHVsZWQgPSBmYWxzZTsKICAgIHN0YXRlLnBlbmRpbmcgPSB1bmRlZmluZWQ7CiAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBwZW5kaW5nLmxlbmd0aDsgaSA8IGlpOyArK2kpIHsKICAgICAgcHJvbWlzZSA9IHBlbmRpbmdbaV1bMF07CiAgICAgIGZuID0gcGVuZGluZ1tpXVtzdGF0ZS5zdGF0dXNdOwogICAgICB0cnkgewogICAgICAgIGlmIChpc0Z1bmN0aW9uKGZuKSkgewogICAgICAgICAgcHJvbWlzZS5yZXNvbHZlKGZuKHN0YXRlLnZhbHVlKSk7CiAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS5zdGF0dXMgPT09IDEpIHsKICAgICAgICAgIHByb21pc2UucmVzb2x2ZShzdGF0ZS52YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHByb21pc2UucmVqZWN0KHN0YXRlLnZhbHVlKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIHByb21pc2UucmVqZWN0KGUpOwogICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHNjaGVkdWxlUHJvY2Vzc1F1ZXVlKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUucHJvY2Vzc1NjaGVkdWxlZCB8fCAhc3RhdGUucGVuZGluZykgcmV0dXJuOwogICAgc3RhdGUucHJvY2Vzc1NjaGVkdWxlZCA9IHRydWU7CiAgICBuZXh0VGljayhmdW5jdGlvbigpIHsgcHJvY2Vzc1F1ZXVlKHN0YXRlKTsgfSk7CiAgfQoKICBmdW5jdGlvbiBEZWZlcnJlZCgpIHsKICAgIHRoaXMucHJvbWlzZSA9IG5ldyBQcm9taXNlKCk7CiAgICAvL05lY2Vzc2FyeSB0byBzdXBwb3J0IHVuYm91bmQgZXhlY3V0aW9uIDovCiAgICB0aGlzLnJlc29sdmUgPSBzaW1wbGVCaW5kKHRoaXMsIHRoaXMucmVzb2x2ZSk7CiAgICB0aGlzLnJlamVjdCA9IHNpbXBsZUJpbmQodGhpcywgdGhpcy5yZWplY3QpOwogICAgdGhpcy5ub3RpZnkgPSBzaW1wbGVCaW5kKHRoaXMsIHRoaXMubm90aWZ5KTsKICB9CgogIERlZmVycmVkLnByb3RvdHlwZSA9IHsKICAgIHJlc29sdmU6IGZ1bmN0aW9uKHZhbCkgewogICAgICBpZiAodGhpcy5wcm9taXNlLiQkc3RhdGUuc3RhdHVzKSByZXR1cm47CiAgICAgIGlmICh2YWwgPT09IHRoaXMucHJvbWlzZSkgewogICAgICAgIHRoaXMuJCRyZWplY3QoJHFNaW5FcnIoCiAgICAgICAgICAncWN5Y2xlJywKICAgICAgICAgICJFeHBlY3RlZCBwcm9taXNlIHRvIGJlIHJlc29sdmVkIHdpdGggdmFsdWUgb3RoZXIgdGhhbiBpdHNlbGYgJ3swfSciLAogICAgICAgICAgdmFsKSk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgdGhpcy4kJHJlc29sdmUodmFsKTsKICAgICAgfQoKICAgIH0sCgogICAgJCRyZXNvbHZlOiBmdW5jdGlvbih2YWwpIHsKICAgICAgdmFyIHRoZW4sIGZuczsKCiAgICAgIGZucyA9IGNhbGxPbmNlKHRoaXMsIHRoaXMuJCRyZXNvbHZlLCB0aGlzLiQkcmVqZWN0KTsKICAgICAgdHJ5IHsKICAgICAgICBpZiAoKGlzT2JqZWN0KHZhbCkgfHwgaXNGdW5jdGlvbih2YWwpKSkgdGhlbiA9IHZhbCAmJiB2YWwudGhlbjsKICAgICAgICBpZiAoaXNGdW5jdGlvbih0aGVuKSkgewogICAgICAgICAgdGhpcy5wcm9taXNlLiQkc3RhdGUuc3RhdHVzID0gLTE7CiAgICAgICAgICB0aGVuLmNhbGwodmFsLCBmbnNbMF0sIGZuc1sxXSwgdGhpcy5ub3RpZnkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnByb21pc2UuJCRzdGF0ZS52YWx1ZSA9IHZhbDsKICAgICAgICAgIHRoaXMucHJvbWlzZS4kJHN0YXRlLnN0YXR1cyA9IDE7CiAgICAgICAgICBzY2hlZHVsZVByb2Nlc3NRdWV1ZSh0aGlzLnByb21pc2UuJCRzdGF0ZSk7CiAgICAgICAgfQogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICBmbnNbMV0oZSk7CiAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgfQogICAgfSwKCiAgICByZWplY3Q6IGZ1bmN0aW9uKHJlYXNvbikgewogICAgICBpZiAodGhpcy5wcm9taXNlLiQkc3RhdGUuc3RhdHVzKSByZXR1cm47CiAgICAgIHRoaXMuJCRyZWplY3QocmVhc29uKTsKICAgIH0sCgogICAgJCRyZWplY3Q6IGZ1bmN0aW9uKHJlYXNvbikgewogICAgICB0aGlzLnByb21pc2UuJCRzdGF0ZS52YWx1ZSA9IHJlYXNvbjsKICAgICAgdGhpcy5wcm9taXNlLiQkc3RhdGUuc3RhdHVzID0gMjsKICAgICAgc2NoZWR1bGVQcm9jZXNzUXVldWUodGhpcy5wcm9taXNlLiQkc3RhdGUpOwogICAgfSwKCiAgICBub3RpZnk6IGZ1bmN0aW9uKHByb2dyZXNzKSB7CiAgICAgIHZhciBjYWxsYmFja3MgPSB0aGlzLnByb21pc2UuJCRzdGF0ZS5wZW5kaW5nOwoKICAgICAgaWYgKCh0aGlzLnByb21pc2UuJCRzdGF0ZS5zdGF0dXMgPD0gMCkgJiYgY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICBuZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBjYWxsYmFjaywgcmVzdWx0OwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gY2FsbGJhY2tzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgcmVzdWx0ID0gY2FsbGJhY2tzW2ldWzBdOwogICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrc1tpXVszXTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXN1bHQubm90aWZ5KGlzRnVuY3Rpb24oY2FsbGJhY2spID8gY2FsbGJhY2socHJvZ3Jlc3MpIDogcHJvZ3Jlc3MpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJHEjcmVqZWN0CiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSBwcm9taXNlIHRoYXQgaXMgcmVzb2x2ZWQgYXMgcmVqZWN0ZWQgd2l0aCB0aGUgc3BlY2lmaWVkIGByZWFzb25gLiBUaGlzIGFwaSBzaG91bGQgYmUKICAgKiB1c2VkIHRvIGZvcndhcmQgcmVqZWN0aW9uIGluIGEgY2hhaW4gb2YgcHJvbWlzZXMuIElmIHlvdSBhcmUgZGVhbGluZyB3aXRoIHRoZSBsYXN0IHByb21pc2UgaW4KICAgKiBhIHByb21pc2UgY2hhaW4sIHlvdSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IGl0LgogICAqCiAgICogV2hlbiBjb21wYXJpbmcgZGVmZXJyZWRzL3Byb21pc2VzIHRvIHRoZSBmYW1pbGlhciBiZWhhdmlvciBvZiB0cnkvY2F0Y2gvdGhyb3csIHRoaW5rIG9mCiAgICogYHJlamVjdGAgYXMgdGhlIGB0aHJvd2Aga2V5d29yZCBpbiBKYXZhU2NyaXB0LiBUaGlzIGFsc28gbWVhbnMgdGhhdCBpZiB5b3UgImNhdGNoIiBhbiBlcnJvciB2aWEKICAgKiBhIHByb21pc2UgZXJyb3IgY2FsbGJhY2sgYW5kIHlvdSB3YW50IHRvIGZvcndhcmQgdGhlIGVycm9yIHRvIHRoZSBwcm9taXNlIGRlcml2ZWQgZnJvbSB0aGUKICAgKiBjdXJyZW50IHByb21pc2UsIHlvdSBoYXZlIHRvICJyZXRocm93IiB0aGUgZXJyb3IgYnkgcmV0dXJuaW5nIGEgcmVqZWN0aW9uIGNvbnN0cnVjdGVkIHZpYQogICAqIGByZWplY3RgLgogICAqCiAgICogYGBganMKICAgKiAgIHByb21pc2VCID0gcHJvbWlzZUEudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICAgKiAgICAgLy8gc3VjY2VzczogZG8gc29tZXRoaW5nIGFuZCByZXNvbHZlIHByb21pc2VCCiAgICogICAgIC8vICAgICAgICAgIHdpdGggdGhlIG9sZCBvciBhIG5ldyByZXN1bHQKICAgKiAgICAgcmV0dXJuIHJlc3VsdDsKICAgKiAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAqICAgICAvLyBlcnJvcjogaGFuZGxlIHRoZSBlcnJvciBpZiBwb3NzaWJsZSBhbmQKICAgKiAgICAgLy8gICAgICAgIHJlc29sdmUgcHJvbWlzZUIgd2l0aCBuZXdQcm9taXNlT3JWYWx1ZSwKICAgKiAgICAgLy8gICAgICAgIG90aGVyd2lzZSBmb3J3YXJkIHRoZSByZWplY3Rpb24gdG8gcHJvbWlzZUIKICAgKiAgICAgaWYgKGNhbkhhbmRsZShyZWFzb24pKSB7CiAgICogICAgICAvLyBoYW5kbGUgdGhlIGVycm9yIGFuZCByZWNvdmVyCiAgICogICAgICByZXR1cm4gbmV3UHJvbWlzZU9yVmFsdWU7CiAgICogICAgIH0KICAgKiAgICAgcmV0dXJuICRxLnJlamVjdChyZWFzb24pOwogICAqICAgfSk7CiAgICogYGBgCiAgICoKICAgKiBAcGFyYW0geyp9IHJlYXNvbiBDb25zdGFudCwgbWVzc2FnZSwgZXhjZXB0aW9uIG9yIGFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJlamVjdGlvbiByZWFzb24uCiAgICogQHJldHVybnMge1Byb21pc2V9IFJldHVybnMgYSBwcm9taXNlIHRoYXQgd2FzIGFscmVhZHkgcmVzb2x2ZWQgYXMgcmVqZWN0ZWQgd2l0aCB0aGUgYHJlYXNvbmAuCiAgICovCiAgdmFyIHJlamVjdCA9IGZ1bmN0aW9uKHJlYXNvbikgewogICAgdmFyIHJlc3VsdCA9IG5ldyBEZWZlcnJlZCgpOwogICAgcmVzdWx0LnJlamVjdChyZWFzb24pOwogICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogIH07CgogIHZhciBtYWtlUHJvbWlzZSA9IGZ1bmN0aW9uIG1ha2VQcm9taXNlKHZhbHVlLCByZXNvbHZlZCkgewogICAgdmFyIHJlc3VsdCA9IG5ldyBEZWZlcnJlZCgpOwogICAgaWYgKHJlc29sdmVkKSB7CiAgICAgIHJlc3VsdC5yZXNvbHZlKHZhbHVlKTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdC5yZWplY3QodmFsdWUpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogIH07CgogIHZhciBoYW5kbGVDYWxsYmFjayA9IGZ1bmN0aW9uIGhhbmRsZUNhbGxiYWNrKHZhbHVlLCBpc1Jlc29sdmVkLCBjYWxsYmFjaykgewogICAgdmFyIGNhbGxiYWNrT3V0cHV0ID0gbnVsbDsKICAgIHRyeSB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKGNhbGxiYWNrKSkgY2FsbGJhY2tPdXRwdXQgPSBjYWxsYmFjaygpOwogICAgfSBjYXRjaChlKSB7CiAgICAgIHJldHVybiBtYWtlUHJvbWlzZShlLCBmYWxzZSk7CiAgICB9CiAgICBpZiAoaXNQcm9taXNlTGlrZShjYWxsYmFja091dHB1dCkpIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrT3V0cHV0LnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG1ha2VQcm9taXNlKHZhbHVlLCBpc1Jlc29sdmVkKTsKICAgICAgfSwgZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICByZXR1cm4gbWFrZVByb21pc2UoZXJyb3IsIGZhbHNlKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbWFrZVByb21pc2UodmFsdWUsIGlzUmVzb2x2ZWQpOwogICAgfQogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkcSN3aGVuCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFdyYXBzIGFuIG9iamVjdCB0aGF0IG1pZ2h0IGJlIGEgdmFsdWUgb3IgYSAoM3JkIHBhcnR5KSB0aGVuLWFibGUgcHJvbWlzZSBpbnRvIGEgJHEgcHJvbWlzZS4KICAgKiBUaGlzIGlzIHVzZWZ1bCB3aGVuIHlvdSBhcmUgZGVhbGluZyB3aXRoIGFuIG9iamVjdCB0aGF0IG1pZ2h0IG9yIG1pZ2h0IG5vdCBiZSBhIHByb21pc2UsIG9yIGlmCiAgICogdGhlIHByb21pc2UgY29tZXMgZnJvbSBhIHNvdXJjZSB0aGF0IGNhbid0IGJlIHRydXN0ZWQuCiAgICoKICAgKiBAcGFyYW0geyp9IHZhbHVlIFZhbHVlIG9yIGEgcHJvbWlzZQogICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgcHJvbWlzZSBvZiB0aGUgcGFzc2VkIHZhbHVlIG9yIHByb21pc2UKICAgKi8KCgogIHZhciB3aGVuID0gZnVuY3Rpb24odmFsdWUsIGNhbGxiYWNrLCBlcnJiYWNrLCBwcm9ncmVzc0JhY2spIHsKICAgIHZhciByZXN1bHQgPSBuZXcgRGVmZXJyZWQoKTsKICAgIHJlc3VsdC5yZXNvbHZlKHZhbHVlKTsKICAgIHJldHVybiByZXN1bHQucHJvbWlzZS50aGVuKGNhbGxiYWNrLCBlcnJiYWNrLCBwcm9ncmVzc0JhY2spOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkcSNhbGwKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ29tYmluZXMgbXVsdGlwbGUgcHJvbWlzZXMgaW50byBhIHNpbmdsZSBwcm9taXNlIHRoYXQgaXMgcmVzb2x2ZWQgd2hlbiBhbGwgb2YgdGhlIGlucHV0CiAgICogcHJvbWlzZXMgYXJlIHJlc29sdmVkLgogICAqCiAgICogQHBhcmFtIHtBcnJheS48UHJvbWlzZT58T2JqZWN0LjxQcm9taXNlPn0gcHJvbWlzZXMgQW4gYXJyYXkgb3IgaGFzaCBvZiBwcm9taXNlcy4KICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHNpbmdsZSBwcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aXRoIGFuIGFycmF5L2hhc2ggb2YgdmFsdWVzLAogICAqICAgZWFjaCB2YWx1ZSBjb3JyZXNwb25kaW5nIHRvIHRoZSBwcm9taXNlIGF0IHRoZSBzYW1lIGluZGV4L2tleSBpbiB0aGUgYHByb21pc2VzYCBhcnJheS9oYXNoLgogICAqICAgSWYgYW55IG9mIHRoZSBwcm9taXNlcyBpcyByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLCB0aGlzIHJlc3VsdGluZyBwcm9taXNlIHdpbGwgYmUgcmVqZWN0ZWQKICAgKiAgIHdpdGggdGhlIHNhbWUgcmVqZWN0aW9uIHZhbHVlLgogICAqLwoKICBmdW5jdGlvbiBhbGwocHJvbWlzZXMpIHsKICAgIHZhciBkZWZlcnJlZCA9IG5ldyBEZWZlcnJlZCgpLAogICAgICAgIGNvdW50ZXIgPSAwLAogICAgICAgIHJlc3VsdHMgPSBpc0FycmF5KHByb21pc2VzKSA/IFtdIDoge307CgogICAgZm9yRWFjaChwcm9taXNlcywgZnVuY3Rpb24ocHJvbWlzZSwga2V5KSB7CiAgICAgIGNvdW50ZXIrKzsKICAgICAgd2hlbihwcm9taXNlKS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKHJlc3VsdHMuaGFzT3duUHJvcGVydHkoa2V5KSkgcmV0dXJuOwogICAgICAgIHJlc3VsdHNba2V5XSA9IHZhbHVlOwogICAgICAgIGlmICghKC0tY291bnRlcikpIGRlZmVycmVkLnJlc29sdmUocmVzdWx0cyk7CiAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgIGlmIChyZXN1bHRzLmhhc093blByb3BlcnR5KGtleSkpIHJldHVybjsKICAgICAgICBkZWZlcnJlZC5yZWplY3QocmVhc29uKTsKICAgICAgfSk7CiAgICB9KTsKCiAgICBpZiAoY291bnRlciA9PT0gMCkgewogICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlc3VsdHMpOwogICAgfQoKICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlOwogIH0KCiAgdmFyICRRID0gZnVuY3Rpb24gUShyZXNvbHZlcikgewogICAgaWYgKCFpc0Z1bmN0aW9uKHJlc29sdmVyKSkgewogICAgICB0aHJvdyAkcU1pbkVycignbm9yc2x2cicsICJFeHBlY3RlZCByZXNvbHZlckZuLCBnb3QgJ3swfSciLCByZXNvbHZlcik7CiAgICB9CgogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFEpKSB7CiAgICAgIC8vIE1vcmUgdXNlZnVsIHdoZW4gJFEgaXMgdGhlIFByb21pc2UgaXRzZWxmLgogICAgICByZXR1cm4gbmV3IFEocmVzb2x2ZXIpOwogICAgfQoKICAgIHZhciBkZWZlcnJlZCA9IG5ldyBEZWZlcnJlZCgpOwoKICAgIGZ1bmN0aW9uIHJlc29sdmVGbih2YWx1ZSkgewogICAgICBkZWZlcnJlZC5yZXNvbHZlKHZhbHVlKTsKICAgIH0KCiAgICBmdW5jdGlvbiByZWplY3RGbihyZWFzb24pIHsKICAgICAgZGVmZXJyZWQucmVqZWN0KHJlYXNvbik7CiAgICB9CgogICAgcmVzb2x2ZXIocmVzb2x2ZUZuLCByZWplY3RGbik7CgogICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgfTsKCiAgJFEuZGVmZXIgPSBkZWZlcjsKICAkUS5yZWplY3QgPSByZWplY3Q7CiAgJFEud2hlbiA9IHdoZW47CiAgJFEuYWxsID0gYWxsOwoKICByZXR1cm4gJFE7Cn0KCmZ1bmN0aW9uICQkUkFGUHJvdmlkZXIoKXsgLy9yQUYKICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJHRpbWVvdXQnLCBmdW5jdGlvbigkd2luZG93LCAkdGltZW91dCkgewogICAgdmFyIHJlcXVlc3RBbmltYXRpb25GcmFtZSA9ICR3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZTsKCiAgICB2YXIgY2FuY2VsQW5pbWF0aW9uRnJhbWUgPSAkd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93LndlYmtpdENhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93Lm1vekNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93LndlYmtpdENhbmNlbFJlcXVlc3RBbmltYXRpb25GcmFtZTsKCiAgICB2YXIgcmFmU3VwcG9ydGVkID0gISFyZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CiAgICB2YXIgcmFmID0gcmFmU3VwcG9ydGVkCiAgICAgID8gZnVuY3Rpb24oZm4pIHsKICAgICAgICAgIHZhciBpZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShmbik7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKGlkKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICA6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICB2YXIgdGltZXIgPSAkdGltZW91dChmbiwgMTYuNjYsIGZhbHNlKTsgLy8gMTAwMCAvIDYwID0gMTYuNjY2CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICR0aW1lb3V0LmNhbmNlbCh0aW1lcik7CiAgICAgICAgICB9OwogICAgICAgIH07CgogICAgcmFmLnN1cHBvcnRlZCA9IHJhZlN1cHBvcnRlZDsKCiAgICByZXR1cm4gcmFmOwogIH1dOwp9CgovKioKICogREVTSUdOIE5PVEVTCiAqCiAqIFRoZSBkZXNpZ24gZGVjaXNpb25zIGJlaGluZCB0aGUgc2NvcGUgYXJlIGhlYXZpbHkgZmF2b3JlZCBmb3Igc3BlZWQgYW5kIG1lbW9yeSBjb25zdW1wdGlvbi4KICoKICogVGhlIHR5cGljYWwgdXNlIG9mIHNjb3BlIGlzIHRvIHdhdGNoIHRoZSBleHByZXNzaW9ucywgd2hpY2ggbW9zdCBvZiB0aGUgdGltZSByZXR1cm4gdGhlIHNhbWUKICogdmFsdWUgYXMgbGFzdCB0aW1lIHNvIHdlIG9wdGltaXplIHRoZSBvcGVyYXRpb24uCiAqCiAqIENsb3N1cmVzIGNvbnN0cnVjdGlvbiBpcyBleHBlbnNpdmUgaW4gdGVybXMgb2Ygc3BlZWQgYXMgd2VsbCBhcyBtZW1vcnk6CiAqICAgLSBObyBjbG9zdXJlcywgaW5zdGVhZCB1c2UgcHJvdG90eXBpY2FsIGluaGVyaXRhbmNlIGZvciBBUEkKICogICAtIEludGVybmFsIHN0YXRlIG5lZWRzIHRvIGJlIHN0b3JlZCBvbiBzY29wZSBkaXJlY3RseSwgd2hpY2ggbWVhbnMgdGhhdCBwcml2YXRlIHN0YXRlIGlzCiAqICAgICBleHBvc2VkIGFzICQkX19fXyBwcm9wZXJ0aWVzCiAqCiAqIExvb3Agb3BlcmF0aW9ucyBhcmUgb3B0aW1pemVkIGJ5IHVzaW5nIHdoaWxlKGNvdW50LS0pIHsgLi4uIH0KICogICAtIHRoaXMgbWVhbnMgdGhhdCBpbiBvcmRlciB0byBrZWVwIHRoZSBzYW1lIG9yZGVyIG9mIGV4ZWN1dGlvbiBhcyBhZGRpdGlvbiB3ZSBoYXZlIHRvIGFkZAogKiAgICAgaXRlbXMgdG8gdGhlIGFycmF5IGF0IHRoZSBiZWdpbm5pbmcgKHVuc2hpZnQpIGluc3RlYWQgb2YgYXQgdGhlIGVuZCAocHVzaCkKICoKICogQ2hpbGQgc2NvcGVzIGFyZSBjcmVhdGVkIGFuZCByZW1vdmVkIG9mdGVuCiAqICAgLSBVc2luZyBhbiBhcnJheSB3b3VsZCBiZSBzbG93IHNpbmNlIGluc2VydHMgaW4gbWlkZGxlIGFyZSBleHBlbnNpdmUgc28gd2UgdXNlIGxpbmtlZCBsaXN0CiAqCiAqIFRoZXJlIGFyZSBmZXcgd2F0Y2hlcyB0aGVuIGEgbG90IG9mIG9ic2VydmVycy4gVGhpcyBpcyB3aHkgeW91IGRvbid0IHdhbnQgdGhlIG9ic2VydmVyIHRvIGJlCiAqIGltcGxlbWVudGVkIGluIHRoZSBzYW1lIHdheSBhcyB3YXRjaC4gV2F0Y2ggcmVxdWlyZXMgcmV0dXJuIG9mIGluaXRpYWxpemF0aW9uIGZ1bmN0aW9uIHdoaWNoCiAqIGFyZSBleHBlbnNpdmUgdG8gY29uc3RydWN0LgogKi8KCgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRyb290U2NvcGVQcm92aWRlcgogKiBAZGVzY3JpcHRpb24KICoKICogUHJvdmlkZXIgZm9yIHRoZSAkcm9vdFNjb3BlIHNlcnZpY2UuCiAqLwoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJHJvb3RTY29wZVByb3ZpZGVyI2RpZ2VzdFR0bAogKiBAZGVzY3JpcHRpb24KICoKICogU2V0cyB0aGUgbnVtYmVyIG9mIGAkZGlnZXN0YCBpdGVyYXRpb25zIHRoZSBzY29wZSBzaG91bGQgYXR0ZW1wdCB0byBleGVjdXRlIGJlZm9yZSBnaXZpbmcgdXAgYW5kCiAqIGFzc3VtaW5nIHRoYXQgdGhlIG1vZGVsIGlzIHVuc3RhYmxlLgogKgogKiBUaGUgY3VycmVudCBkZWZhdWx0IGlzIDEwIGl0ZXJhdGlvbnMuCiAqCiAqIEluIGNvbXBsZXggYXBwbGljYXRpb25zIGl0J3MgcG9zc2libGUgdGhhdCB0aGUgZGVwZW5kZW5jaWVzIGJldHdlZW4gYCR3YXRjaGBzIHdpbGwgcmVzdWx0IGluCiAqIHNldmVyYWwgZGlnZXN0IGl0ZXJhdGlvbnMuIEhvd2V2ZXIgaWYgYW4gYXBwbGljYXRpb24gbmVlZHMgbW9yZSB0aGFuIHRoZSBkZWZhdWx0IDEwIGRpZ2VzdAogKiBpdGVyYXRpb25zIGZvciBpdHMgbW9kZWwgdG8gc3RhYmlsaXplIHRoZW4geW91IHNob3VsZCBpbnZlc3RpZ2F0ZSB3aGF0IGlzIGNhdXNpbmcgdGhlIG1vZGVsIHRvCiAqIGNvbnRpbnVvdXNseSBjaGFuZ2UgZHVyaW5nIHRoZSBkaWdlc3QuCiAqCiAqIEluY3JlYXNpbmcgdGhlIFRUTCBjb3VsZCBoYXZlIHBlcmZvcm1hbmNlIGltcGxpY2F0aW9ucywgc28geW91IHNob3VsZCBub3QgY2hhbmdlIGl0IHdpdGhvdXQKICogcHJvcGVyIGp1c3RpZmljYXRpb24uCiAqCiAqIEBwYXJhbSB7bnVtYmVyfSBsaW1pdCBUaGUgbnVtYmVyIG9mIGRpZ2VzdCBpdGVyYXRpb25zLgogKi8KCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHJvb3RTY29wZQogKiBAZGVzY3JpcHRpb24KICoKICogRXZlcnkgYXBwbGljYXRpb24gaGFzIGEgc2luZ2xlIHJvb3Qge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9LgogKiBBbGwgb3RoZXIgc2NvcGVzIGFyZSBkZXNjZW5kYW50IHNjb3BlcyBvZiB0aGUgcm9vdCBzY29wZS4gU2NvcGVzIHByb3ZpZGUgc2VwYXJhdGlvbgogKiBiZXR3ZWVuIHRoZSBtb2RlbCBhbmQgdGhlIHZpZXcsIHZpYSBhIG1lY2hhbmlzbSBmb3Igd2F0Y2hpbmcgdGhlIG1vZGVsIGZvciBjaGFuZ2VzLgogKiBUaGV5IGFsc28gcHJvdmlkZSBhbiBldmVudCBlbWlzc2lvbi9icm9hZGNhc3QgYW5kIHN1YnNjcmlwdGlvbiBmYWNpbGl0eS4gU2VlIHRoZQogKiB7QGxpbmsgZ3VpZGUvc2NvcGUgZGV2ZWxvcGVyIGd1aWRlIG9uIHNjb3Blc30uCiAqLwpmdW5jdGlvbiAkUm9vdFNjb3BlUHJvdmlkZXIoKXsKICB2YXIgVFRMID0gMTA7CiAgdmFyICRyb290U2NvcGVNaW5FcnIgPSBtaW5FcnIoJyRyb290U2NvcGUnKTsKICB2YXIgbGFzdERpcnR5V2F0Y2ggPSBudWxsOwogIHZhciBhcHBseUFzeW5jSWQgPSBudWxsOwoKICB0aGlzLmRpZ2VzdFR0bCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICBUVEwgPSB2YWx1ZTsKICAgIH0KICAgIHJldHVybiBUVEw7CiAgfTsKCiAgdGhpcy4kZ2V0ID0gWyckaW5qZWN0b3InLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJHBhcnNlJywgJyRicm93c2VyJywKICAgICAgZnVuY3Rpb24oICRpbmplY3RvciwgICAkZXhjZXB0aW9uSGFuZGxlciwgICAkcGFyc2UsICAgJGJyb3dzZXIpIHsKCiAgICAvKioKICAgICAqIEBuZ2RvYyB0eXBlCiAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHJvb3Qgc2NvcGUgY2FuIGJlIHJldHJpZXZlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUgJHJvb3RTY29wZX0ga2V5IGZyb20gdGhlCiAgICAgKiB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4gQ2hpbGQgc2NvcGVzIGFyZSBjcmVhdGVkIHVzaW5nIHRoZQogICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG5ldyAkbmV3KCl9IG1ldGhvZC4gKE1vc3Qgc2NvcGVzIGFyZSBjcmVhdGVkIGF1dG9tYXRpY2FsbHkgd2hlbgogICAgICogY29tcGlsZWQgSFRNTCB0ZW1wbGF0ZSBpcyBleGVjdXRlZC4pCiAgICAgKgogICAgICogSGVyZSBpcyBhIHNpbXBsZSBzY29wZSBzbmlwcGV0IHRvIHNob3cgaG93IHlvdSBjYW4gaW50ZXJhY3Qgd2l0aCB0aGUgc2NvcGUuCiAgICAgKiBgYGBodG1sCiAgICAgKiA8ZmlsZSBzcmM9Ii4vdGVzdC9uZy9yb290U2NvcGVTcGVjLmpzIiB0YWc9ImRvY3MxIiAvPgogICAgICogYGBgCiAgICAgKgogICAgICogIyBJbmhlcml0YW5jZQogICAgICogQSBzY29wZSBjYW4gaW5oZXJpdCBmcm9tIGEgcGFyZW50IHNjb3BlLCBhcyBpbiB0aGlzIGV4YW1wbGU6CiAgICAgKiBgYGBqcwogICAgICAgICB2YXIgcGFyZW50ID0gJHJvb3RTY29wZTsKICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LiRuZXcoKTsKCiAgICAgICAgIHBhcmVudC5zYWx1dGF0aW9uID0gIkhlbGxvIjsKICAgICAgICAgY2hpbGQubmFtZSA9ICJXb3JsZCI7CiAgICAgICAgIGV4cGVjdChjaGlsZC5zYWx1dGF0aW9uKS50b0VxdWFsKCdIZWxsbycpOwoKICAgICAgICAgY2hpbGQuc2FsdXRhdGlvbiA9ICJXZWxjb21lIjsKICAgICAgICAgZXhwZWN0KGNoaWxkLnNhbHV0YXRpb24pLnRvRXF1YWwoJ1dlbGNvbWUnKTsKICAgICAgICAgZXhwZWN0KHBhcmVudC5zYWx1dGF0aW9uKS50b0VxdWFsKCdIZWxsbycpOwogICAgICogYGBgCiAgICAgKgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIGZ1bmN0aW9uKCk+PX0gcHJvdmlkZXJzIE1hcCBvZiBzZXJ2aWNlIGZhY3Rvcnkgd2hpY2ggbmVlZCB0byBiZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlZCBmb3IgdGhlIGN1cnJlbnQgc2NvcGUuIERlZmF1bHRzIHRvIHtAbGluayBuZ30uCiAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCAqPj19IGluc3RhbmNlQ2FjaGUgUHJvdmlkZXMgcHJlLWluc3RhbnRpYXRlZCBzZXJ2aWNlcyB3aGljaCBzaG91bGQKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwZW5kL292ZXJyaWRlIHNlcnZpY2VzIHByb3ZpZGVkIGJ5IGBwcm92aWRlcnNgLiBUaGlzIGlzIGhhbmR5CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoZW4gdW5pdC10ZXN0aW5nIGFuZCBoYXZpbmcgdGhlIG5lZWQgdG8gb3ZlcnJpZGUgYSBkZWZhdWx0CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2UuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBOZXdseSBjcmVhdGVkIHNjb3BlLgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gU2NvcGUoKSB7CiAgICAgIHRoaXMuJGlkID0gbmV4dFVpZCgpOwogICAgICB0aGlzLiQkcGhhc2UgPSB0aGlzLiRwYXJlbnQgPSB0aGlzLiQkd2F0Y2hlcnMgPQogICAgICAgICAgICAgICAgICAgICB0aGlzLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmcgPQogICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRIZWFkID0gdGhpcy4kJGNoaWxkVGFpbCA9IG51bGw7CiAgICAgIHRoaXMuJHJvb3QgPSB0aGlzOwogICAgICB0aGlzLiQkZGVzdHJveWVkID0gZmFsc2U7CiAgICAgIHRoaXMuJCRsaXN0ZW5lcnMgPSB7fTsKICAgICAgdGhpcy4kJGxpc3RlbmVyQ291bnQgPSB7fTsKICAgICAgdGhpcy4kJGlzb2xhdGVCaW5kaW5ncyA9IG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGlkCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVbmlxdWUgc2NvcGUgSUQgKG1vbm90b25pY2FsbHkgaW5jcmVhc2luZykgdXNlZnVsIGZvciBkZWJ1Z2dpbmcuCiAgICAgKi8KCiAgICAgLyoqCiAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkcGFyZW50CiAgICAgICoKICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgKiBSZWZlcmVuY2UgdG8gdGhlIHBhcmVudCBzY29wZS4KICAgICAgKi8KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkcm9vdAogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogUmVmZXJlbmNlIHRvIHRoZSByb290IHNjb3BlLgogICAgICAgKi8KCiAgICBTY29wZS5wcm90b3R5cGUgPSB7CiAgICAgIGNvbnN0cnVjdG9yOiBTY29wZSwKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkbmV3CiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBDcmVhdGVzIGEgbmV3IGNoaWxkIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfS4KICAgICAgICoKICAgICAgICogVGhlIHBhcmVudCBzY29wZSB3aWxsIHByb3BhZ2F0ZSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGV2ZW50LgogICAgICAgKiBUaGUgc2NvcGUgY2FuIGJlIHJlbW92ZWQgZnJvbSB0aGUgc2NvcGUgaGllcmFyY2h5IHVzaW5nIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95ICRkZXN0cm95KCl9LgogICAgICAgKgogICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveSAkZGVzdHJveSgpfSBtdXN0IGJlIGNhbGxlZCBvbiBhIHNjb3BlIHdoZW4gaXQgaXMKICAgICAgICogZGVzaXJlZCBmb3IgdGhlIHNjb3BlIGFuZCBpdHMgY2hpbGQgc2NvcGVzIHRvIGJlIHBlcm1hbmVudGx5IGRldGFjaGVkIGZyb20gdGhlIHBhcmVudCBhbmQKICAgICAgICogdGh1cyBzdG9wIHBhcnRpY2lwYXRpbmcgaW4gbW9kZWwgY2hhbmdlIGRldGVjdGlvbiBhbmQgbGlzdGVuZXIgbm90aWZpY2F0aW9uIGJ5IGludm9raW5nLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzb2xhdGUgSWYgdHJ1ZSwgdGhlbiB0aGUgc2NvcGUgZG9lcyBub3QgcHJvdG90eXBpY2FsbHkgaW5oZXJpdCBmcm9tIHRoZQogICAgICAgKiAgICAgICAgIHBhcmVudCBzY29wZS4gVGhlIHNjb3BlIGlzIGlzb2xhdGVkLCBhcyBpdCBjYW4gbm90IHNlZSBwYXJlbnQgc2NvcGUgcHJvcGVydGllcy4KICAgICAgICogICAgICAgICBXaGVuIGNyZWF0aW5nIHdpZGdldHMsIGl0IGlzIHVzZWZ1bCBmb3IgdGhlIHdpZGdldCB0byBub3QgYWNjaWRlbnRhbGx5IHJlYWQgcGFyZW50CiAgICAgICAqICAgICAgICAgc3RhdGUuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7U2NvcGV9IFtwYXJlbnQ9dGhpc10gVGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIGBTY29wZWB9IHRoYXQgd2lsbCBiZSB0aGUgYCRwYXJlbnRgCiAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2YgdGhlIG5ld2x5IGNyZWF0ZWQgc2NvcGUuIERlZmF1bHRzIHRvIGB0aGlzYCBzY29wZSBpZiBub3QgcHJvdmlkZWQuCiAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBpcyB1c2VkIHdoZW4gY3JlYXRpbmcgYSB0cmFuc2NsdWRlIHNjb3BlIHRvIGNvcnJlY3RseSBwbGFjZSBpdAogICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluIHRoZSBzY29wZSBoaWVyYXJjaHkgd2hpbGUgbWFpbnRhaW5pbmcgdGhlIGNvcnJlY3QgcHJvdG90eXBpY2FsCiAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5oZXJpdGFuY2UuCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXdseSBjcmVhdGVkIGNoaWxkIHNjb3BlLgogICAgICAgKgogICAgICAgKi8KICAgICAgJG5ldzogZnVuY3Rpb24oaXNvbGF0ZSwgcGFyZW50KSB7CiAgICAgICAgdmFyIGNoaWxkOwoKICAgICAgICBwYXJlbnQgPSBwYXJlbnQgfHwgdGhpczsKCiAgICAgICAgaWYgKGlzb2xhdGUpIHsKICAgICAgICAgIGNoaWxkID0gbmV3IFNjb3BlKCk7CiAgICAgICAgICBjaGlsZC4kcm9vdCA9IHRoaXMuJHJvb3Q7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIE9ubHkgY3JlYXRlIGEgY2hpbGQgc2NvcGUgY2xhc3MgaWYgc29tZWJvZHkgYXNrcyBmb3Igb25lLAogICAgICAgICAgLy8gYnV0IGNhY2hlIGl0IHRvIGFsbG93IHRoZSBWTSB0byBvcHRpbWl6ZSBsb29rdXBzLgogICAgICAgICAgaWYgKCF0aGlzLiQkQ2hpbGRTY29wZSkgewogICAgICAgICAgICB0aGlzLiQkQ2hpbGRTY29wZSA9IGZ1bmN0aW9uIENoaWxkU2NvcGUoKSB7CiAgICAgICAgICAgICAgdGhpcy4kJHdhdGNoZXJzID0gdGhpcy4kJG5leHRTaWJsaW5nID0KICAgICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkSGVhZCA9IHRoaXMuJCRjaGlsZFRhaWwgPSBudWxsOwogICAgICAgICAgICAgIHRoaXMuJCRsaXN0ZW5lcnMgPSB7fTsKICAgICAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJDb3VudCA9IHt9OwogICAgICAgICAgICAgIHRoaXMuJGlkID0gbmV4dFVpZCgpOwogICAgICAgICAgICAgIHRoaXMuJCRDaGlsZFNjb3BlID0gbnVsbDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy4kJENoaWxkU2NvcGUucHJvdG90eXBlID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGNoaWxkID0gbmV3IHRoaXMuJCRDaGlsZFNjb3BlKCk7CiAgICAgICAgfQogICAgICAgIGNoaWxkLiRwYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgY2hpbGQuJCRwcmV2U2libGluZyA9IHBhcmVudC4kJGNoaWxkVGFpbDsKICAgICAgICBpZiAocGFyZW50LiQkY2hpbGRIZWFkKSB7CiAgICAgICAgICBwYXJlbnQuJCRjaGlsZFRhaWwuJCRuZXh0U2libGluZyA9IGNoaWxkOwogICAgICAgICAgcGFyZW50LiQkY2hpbGRUYWlsID0gY2hpbGQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBhcmVudC4kJGNoaWxkSGVhZCA9IHBhcmVudC4kJGNoaWxkVGFpbCA9IGNoaWxkOwogICAgICAgIH0KCiAgICAgICAgLy8gV2hlbiB0aGUgbmV3IHNjb3BlIGlzIG5vdCBpc29sYXRlZCBvciB3ZSBpbmhlcml0IGZyb20gYHRoaXNgLCBhbmQKICAgICAgICAvLyB0aGUgcGFyZW50IHNjb3BlIGlzIGRlc3Ryb3llZCwgdGhlIHByb3BlcnR5IGAkJGRlc3Ryb3llZGAgaXMgaW5oZXJpdGVkCiAgICAgICAgLy8gcHJvdG90eXBpY2FsbHkuIEluIGFsbCBvdGhlciBjYXNlcywgdGhpcyBwcm9wZXJ0eSBuZWVkcyB0byBiZSBzZXQKICAgICAgICAvLyB3aGVuIHRoZSBwYXJlbnQgc2NvcGUgaXMgZGVzdHJveWVkLgogICAgICAgIC8vIFRoZSBsaXN0ZW5lciBuZWVkcyB0byBiZSBhZGRlZCBhZnRlciB0aGUgcGFyZW50IGlzIHNldAogICAgICAgIGlmIChpc29sYXRlIHx8IHBhcmVudCAhPSB0aGlzKSBjaGlsZC4kb24oJyRkZXN0cm95JywgZGVzdHJveUNoaWxkKTsKCiAgICAgICAgcmV0dXJuIGNoaWxkOwoKICAgICAgICBmdW5jdGlvbiBkZXN0cm95Q2hpbGQoKSB7CiAgICAgICAgICBjaGlsZC4kJGRlc3Ryb3llZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkd2F0Y2gKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFJlZ2lzdGVycyBhIGBsaXN0ZW5lcmAgY2FsbGJhY2sgdG8gYmUgZXhlY3V0ZWQgd2hlbmV2ZXIgdGhlIGB3YXRjaEV4cHJlc3Npb25gIGNoYW5nZXMuCiAgICAgICAqCiAgICAgICAqIC0gVGhlIGB3YXRjaEV4cHJlc3Npb25gIGlzIGNhbGxlZCBvbiBldmVyeSBjYWxsIHRvIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QKICAgICAgICogICAkZGlnZXN0KCl9IGFuZCBzaG91bGQgcmV0dXJuIHRoZSB2YWx1ZSB0aGF0IHdpbGwgYmUgd2F0Y2hlZC4gKFNpbmNlCiAgICAgICAqICAge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IHJlcnVucyB3aGVuIGl0IGRldGVjdHMgY2hhbmdlcyB0aGUKICAgICAgICogICBgd2F0Y2hFeHByZXNzaW9uYCBjYW4gZXhlY3V0ZSBtdWx0aXBsZSB0aW1lcyBwZXIKICAgICAgICogICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gYW5kIHNob3VsZCBiZSBpZGVtcG90ZW50LikKICAgICAgICogLSBUaGUgYGxpc3RlbmVyYCBpcyBjYWxsZWQgb25seSB3aGVuIHRoZSB2YWx1ZSBmcm9tIHRoZSBjdXJyZW50IGB3YXRjaEV4cHJlc3Npb25gIGFuZCB0aGUKICAgICAgICogICBwcmV2aW91cyBjYWxsIHRvIGB3YXRjaEV4cHJlc3Npb25gIGFyZSBub3QgZXF1YWwgKHdpdGggdGhlIGV4Y2VwdGlvbiBvZiB0aGUgaW5pdGlhbCBydW4sCiAgICAgICAqICAgc2VlIGJlbG93KS4gSW5lcXVhbGl0eSBpcyBkZXRlcm1pbmVkIGFjY29yZGluZyB0byByZWZlcmVuY2UgaW5lcXVhbGl0eSwKICAgICAgICogICBbc3RyaWN0IGNvbXBhcmlzb25dKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL09wZXJhdG9ycy9Db21wYXJpc29uX09wZXJhdG9ycykKICAgICAgICogICAgdmlhIHRoZSBgIT09YCBKYXZhc2NyaXB0IG9wZXJhdG9yLCB1bmxlc3MgYG9iamVjdEVxdWFsaXR5ID09IHRydWVgCiAgICAgICAqICAgKHNlZSBuZXh0IHBvaW50KQogICAgICAgKiAtIFdoZW4gYG9iamVjdEVxdWFsaXR5ID09IHRydWVgLCBpbmVxdWFsaXR5IG9mIHRoZSBgd2F0Y2hFeHByZXNzaW9uYCBpcyBkZXRlcm1pbmVkCiAgICAgICAqICAgYWNjb3JkaW5nIHRvIHRoZSB7QGxpbmsgYW5ndWxhci5lcXVhbHN9IGZ1bmN0aW9uLiBUbyBzYXZlIHRoZSB2YWx1ZSBvZiB0aGUgb2JqZWN0IGZvcgogICAgICAgKiAgIGxhdGVyIGNvbXBhcmlzb24sIHRoZSB7QGxpbmsgYW5ndWxhci5jb3B5fSBmdW5jdGlvbiBpcyB1c2VkLiBUaGlzIHRoZXJlZm9yZSBtZWFucyB0aGF0CiAgICAgICAqICAgd2F0Y2hpbmcgY29tcGxleCBvYmplY3RzIHdpbGwgaGF2ZSBhZHZlcnNlIG1lbW9yeSBhbmQgcGVyZm9ybWFuY2UgaW1wbGljYXRpb25zLgogICAgICAgKiAtIFRoZSB3YXRjaCBgbGlzdGVuZXJgIG1heSBjaGFuZ2UgdGhlIG1vZGVsLCB3aGljaCBtYXkgdHJpZ2dlciBvdGhlciBgbGlzdGVuZXJgcyB0byBmaXJlLgogICAgICAgKiAgIFRoaXMgaXMgYWNoaWV2ZWQgYnkgcmVydW5uaW5nIHRoZSB3YXRjaGVycyB1bnRpbCBubyBjaGFuZ2VzIGFyZSBkZXRlY3RlZC4gVGhlIHJlcnVuCiAgICAgICAqICAgaXRlcmF0aW9uIGxpbWl0IGlzIDEwIHRvIHByZXZlbnQgYW4gaW5maW5pdGUgbG9vcCBkZWFkbG9jay4KICAgICAgICoKICAgICAgICoKICAgICAgICogSWYgeW91IHdhbnQgdG8gYmUgbm90aWZpZWQgd2hlbmV2ZXIge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0fSBpcyBjYWxsZWQsCiAgICAgICAqIHlvdSBjYW4gcmVnaXN0ZXIgYSBgd2F0Y2hFeHByZXNzaW9uYCBmdW5jdGlvbiB3aXRoIG5vIGBsaXN0ZW5lcmAuIChTaW5jZSBgd2F0Y2hFeHByZXNzaW9uYAogICAgICAgKiBjYW4gZXhlY3V0ZSBtdWx0aXBsZSB0aW1lcyBwZXIge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0fSBjeWNsZSB3aGVuIGEKICAgICAgICogY2hhbmdlIGlzIGRldGVjdGVkLCBiZSBwcmVwYXJlZCBmb3IgbXVsdGlwbGUgY2FsbHMgdG8geW91ciBsaXN0ZW5lci4pCiAgICAgICAqCiAgICAgICAqIEFmdGVyIGEgd2F0Y2hlciBpcyByZWdpc3RlcmVkIHdpdGggdGhlIHNjb3BlLCB0aGUgYGxpc3RlbmVyYCBmbiBpcyBjYWxsZWQgYXN5bmNocm9ub3VzbHkKICAgICAgICogKHZpYSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbEFzeW5jICRldmFsQXN5bmN9KSB0byBpbml0aWFsaXplIHRoZQogICAgICAgKiB3YXRjaGVyLiBJbiByYXJlIGNhc2VzLCB0aGlzIGlzIHVuZGVzaXJhYmxlIGJlY2F1c2UgdGhlIGxpc3RlbmVyIGlzIGNhbGxlZCB3aGVuIHRoZSByZXN1bHQKICAgICAgICogb2YgYHdhdGNoRXhwcmVzc2lvbmAgZGlkbid0IGNoYW5nZS4gVG8gZGV0ZWN0IHRoaXMgc2NlbmFyaW8gd2l0aGluIHRoZSBgbGlzdGVuZXJgIGZuLCB5b3UKICAgICAgICogY2FuIGNvbXBhcmUgdGhlIGBuZXdWYWxgIGFuZCBgb2xkVmFsYC4gSWYgdGhlc2UgdHdvIHZhbHVlcyBhcmUgaWRlbnRpY2FsIChgPT09YCkgdGhlbiB0aGUKICAgICAgICogbGlzdGVuZXIgd2FzIGNhbGxlZCBkdWUgdG8gaW5pdGlhbGl6YXRpb24uCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqICMgRXhhbXBsZQogICAgICAgKiBgYGBqcwogICAgICAgICAgIC8vIGxldCdzIGFzc3VtZSB0aGF0IHNjb3BlIHdhcyBkZXBlbmRlbmN5IGluamVjdGVkIGFzIHRoZSAkcm9vdFNjb3BlCiAgICAgICAgICAgdmFyIHNjb3BlID0gJHJvb3RTY29wZTsKICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICBzY29wZS5jb3VudGVyID0gMDsKCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICBzY29wZS5jb3VudGVyID0gc2NvcGUuY291bnRlciArIDE7CiAgICAgICAgICAgfSk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAvLyB0aGUgbGlzdGVuZXIgaXMgYWx3YXlzIGNhbGxlZCBkdXJpbmcgdGhlIGZpcnN0ICRkaWdlc3QgbG9vcCBhZnRlciBpdCB3YXMgcmVnaXN0ZXJlZAogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwoKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgLy8gYnV0IG5vdyBpdCB3aWxsIG5vdCBiZSBjYWxsZWQgdW5sZXNzIHRoZSB2YWx1ZSBjaGFuZ2VzCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMSk7CgogICAgICAgICAgIHNjb3BlLm5hbWUgPSAnYWRhbSc7CiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDIpOwoKCgogICAgICAgICAgIC8vIFVzaW5nIGEgZnVuY3Rpb24gYXMgYSB3YXRjaEV4cHJlc3Npb24KICAgICAgICAgICB2YXIgZm9vZDsKICAgICAgICAgICBzY29wZS5mb29kQ291bnRlciA9IDA7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmZvb2RDb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgIHNjb3BlLiR3YXRjaCgKICAgICAgICAgICAgIC8vIFRoaXMgZnVuY3Rpb24gcmV0dXJucyB0aGUgdmFsdWUgYmVpbmcgd2F0Y2hlZC4gSXQgaXMgY2FsbGVkIGZvciBlYWNoIHR1cm4gb2YgdGhlICRkaWdlc3QgbG9vcAogICAgICAgICAgICAgZnVuY3Rpb24oKSB7IHJldHVybiBmb29kOyB9LAogICAgICAgICAgICAgLy8gVGhpcyBpcyB0aGUgY2hhbmdlIGxpc3RlbmVyLCBjYWxsZWQgd2hlbiB0aGUgdmFsdWUgcmV0dXJuZWQgZnJvbSB0aGUgYWJvdmUgZnVuY3Rpb24gY2hhbmdlcwogICAgICAgICAgICAgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICAgIGlmICggbmV3VmFsdWUgIT09IG9sZFZhbHVlICkgewogICAgICAgICAgICAgICAgIC8vIE9ubHkgaW5jcmVtZW50IHRoZSBjb3VudGVyIGlmIHRoZSB2YWx1ZSBjaGFuZ2VkCiAgICAgICAgICAgICAgICAgc2NvcGUuZm9vZENvdW50ZXIgPSBzY29wZS5mb29kQ291bnRlciArIDE7CiAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgIH0KICAgICAgICAgICApOwogICAgICAgICAgIC8vIE5vIGRpZ2VzdCBoYXMgYmVlbiBydW4gc28gdGhlIGNvdW50ZXIgd2lsbCBiZSB6ZXJvCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmZvb2RDb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAvLyBSdW4gdGhlIGRpZ2VzdCBidXQgc2luY2UgZm9vZCBoYXMgbm90IGNoYW5nZWQgY291bnQgd2lsbCBzdGlsbCBiZSB6ZXJvCiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIGV4cGVjdChzY29wZS5mb29kQ291bnRlcikudG9FcXVhbCgwKTsKCiAgICAgICAgICAgLy8gVXBkYXRlIGZvb2QgYW5kIHJ1biBkaWdlc3QuICBOb3cgdGhlIGNvdW50ZXIgd2lsbCBpbmNyZW1lbnQKICAgICAgICAgICBmb29kID0gJ2NoZWVzZWJ1cmdlcic7CiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIGV4cGVjdChzY29wZS5mb29kQ291bnRlcikudG9FcXVhbCgxKTsKCiAgICAgICAqIGBgYAogICAgICAgKgogICAgICAgKgogICAgICAgKgogICAgICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfHN0cmluZyl9IHdhdGNoRXhwcmVzc2lvbiBFeHByZXNzaW9uIHRoYXQgaXMgZXZhbHVhdGVkIG9uIGVhY2gKICAgICAgICogICAge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0fSBjeWNsZS4gQSBjaGFuZ2UgaW4gdGhlIHJldHVybiB2YWx1ZSB0cmlnZ2VycwogICAgICAgKiAgICBhIGNhbGwgdG8gdGhlIGBsaXN0ZW5lcmAuCiAgICAgICAqCiAgICAgICAqICAgIC0gYHN0cmluZ2A6IEV2YWx1YXRlZCBhcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufQogICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBjYWxsZWQgd2l0aCBjdXJyZW50IGBzY29wZWAgYXMgYSBwYXJhbWV0ZXIuCiAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24obmV3VmFsLCBvbGRWYWwsIHNjb3BlKX0gbGlzdGVuZXIgQ2FsbGJhY2sgY2FsbGVkIHdoZW5ldmVyIHRoZSB2YWx1ZQogICAgICAgKiAgICBvZiBgd2F0Y2hFeHByZXNzaW9uYCBjaGFuZ2VzLgogICAgICAgKgogICAgICAgKiAgICAtIGBuZXdWYWxgIGNvbnRhaW5zIHRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBgd2F0Y2hFeHByZXNzaW9uYAogICAgICAgKiAgICAtIGBvbGRWYWxgIGNvbnRhaW5zIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYHdhdGNoRXhwcmVzc2lvbmAKICAgICAgICogICAgLSBgc2NvcGVgIHJlZmVycyB0byB0aGUgY3VycmVudCBzY29wZQogICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvYmplY3RFcXVhbGl0eSBDb21wYXJlIGZvciBvYmplY3QgZXF1YWxpdHkgdXNpbmcge0BsaW5rIGFuZ3VsYXIuZXF1YWxzfSBpbnN0ZWFkIG9mCiAgICAgICAqICAgICBjb21wYXJpbmcgZm9yIHJlZmVyZW5jZSBlcXVhbGl0eS4KICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4KICAgICAgICovCiAgICAgICR3YXRjaDogZnVuY3Rpb24od2F0Y2hFeHAsIGxpc3RlbmVyLCBvYmplY3RFcXVhbGl0eSkgewogICAgICAgIHZhciBnZXQgPSAkcGFyc2Uod2F0Y2hFeHApOwoKICAgICAgICBpZiAoZ2V0LiQkd2F0Y2hEZWxlZ2F0ZSkgewogICAgICAgICAgcmV0dXJuIGdldC4kJHdhdGNoRGVsZWdhdGUodGhpcywgbGlzdGVuZXIsIG9iamVjdEVxdWFsaXR5LCBnZXQpOwogICAgICAgIH0KICAgICAgICB2YXIgc2NvcGUgPSB0aGlzLAogICAgICAgICAgICBhcnJheSA9IHNjb3BlLiQkd2F0Y2hlcnMsCiAgICAgICAgICAgIHdhdGNoZXIgPSB7CiAgICAgICAgICAgICAgZm46IGxpc3RlbmVyLAogICAgICAgICAgICAgIGxhc3Q6IGluaXRXYXRjaFZhbCwKICAgICAgICAgICAgICBnZXQ6IGdldCwKICAgICAgICAgICAgICBleHA6IHdhdGNoRXhwLAogICAgICAgICAgICAgIGVxOiAhIW9iamVjdEVxdWFsaXR5CiAgICAgICAgICAgIH07CgogICAgICAgIGxhc3REaXJ0eVdhdGNoID0gbnVsbDsKCiAgICAgICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkgewogICAgICAgICAgd2F0Y2hlci5mbiA9IG5vb3A7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWFycmF5KSB7CiAgICAgICAgICBhcnJheSA9IHNjb3BlLiQkd2F0Y2hlcnMgPSBbXTsKICAgICAgICB9CiAgICAgICAgLy8gd2UgdXNlIHVuc2hpZnQgc2luY2Ugd2UgdXNlIGEgd2hpbGUgbG9vcCBpbiAkZGlnZXN0IGZvciBzcGVlZC4KICAgICAgICAvLyB0aGUgd2hpbGUgbG9vcCByZWFkcyBpbiByZXZlcnNlIG9yZGVyLgogICAgICAgIGFycmF5LnVuc2hpZnQod2F0Y2hlcik7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiBkZXJlZ2lzdGVyV2F0Y2goKSB7CiAgICAgICAgICBhcnJheVJlbW92ZShhcnJheSwgd2F0Y2hlcik7CiAgICAgICAgICBsYXN0RGlydHlXYXRjaCA9IG51bGw7CiAgICAgICAgfTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJHdhdGNoR3JvdXAKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEEgdmFyaWFudCBvZiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggJHdhdGNoKCl9IHdoZXJlIGl0IHdhdGNoZXMgYW4gYXJyYXkgb2YgYHdhdGNoRXhwcmVzc2lvbnNgLgogICAgICAgKiBJZiBhbnkgb25lIGV4cHJlc3Npb24gaW4gdGhlIGNvbGxlY3Rpb24gY2hhbmdlcyB0aGUgYGxpc3RlbmVyYCBpcyBleGVjdXRlZC4KICAgICAgICoKICAgICAgICogLSBUaGUgaXRlbXMgaW4gdGhlIGB3YXRjaEV4cHJlc3Npb25zYCBhcnJheSBhcmUgb2JzZXJ2ZWQgdmlhIHN0YW5kYXJkICR3YXRjaCBvcGVyYXRpb24gYW5kIGFyZSBleGFtaW5lZCBvbiBldmVyeQogICAgICAgKiAgIGNhbGwgdG8gJGRpZ2VzdCgpIHRvIHNlZSBpZiBhbnkgaXRlbXMgY2hhbmdlcy4KICAgICAgICogLSBUaGUgYGxpc3RlbmVyYCBpcyBjYWxsZWQgd2hlbmV2ZXIgYW55IGV4cHJlc3Npb24gaW4gdGhlIGB3YXRjaEV4cHJlc3Npb25zYCBhcnJheSBjaGFuZ2VzLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmd8RnVuY3Rpb24oc2NvcGUpPn0gd2F0Y2hFeHByZXNzaW9ucyBBcnJheSBvZiBleHByZXNzaW9ucyB0aGF0IHdpbGwgYmUgaW5kaXZpZHVhbGx5CiAgICAgICAqIHdhdGNoZWQgdXNpbmcge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoICR3YXRjaCgpfQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKG5ld1ZhbHVlcywgb2xkVmFsdWVzLCBzY29wZSl9IGxpc3RlbmVyIENhbGxiYWNrIGNhbGxlZCB3aGVuZXZlciB0aGUgcmV0dXJuIHZhbHVlIG9mIGFueQogICAgICAgKiAgICBleHByZXNzaW9uIGluIGB3YXRjaEV4cHJlc3Npb25zYCBjaGFuZ2VzCiAgICAgICAqICAgIFRoZSBgbmV3VmFsdWVzYCBhcnJheSBjb250YWlucyB0aGUgY3VycmVudCB2YWx1ZXMgb2YgdGhlIGB3YXRjaEV4cHJlc3Npb25zYCwgd2l0aCB0aGUgaW5kZXhlcyBtYXRjaGluZwogICAgICAgKiAgICB0aG9zZSBvZiBgd2F0Y2hFeHByZXNzaW9uYAogICAgICAgKiAgICBhbmQgdGhlIGBvbGRWYWx1ZXNgIGFycmF5IGNvbnRhaW5zIHRoZSBwcmV2aW91cyB2YWx1ZXMgb2YgdGhlIGB3YXRjaEV4cHJlc3Npb25zYCwgd2l0aCB0aGUgaW5kZXhlcyBtYXRjaGluZwogICAgICAgKiAgICB0aG9zZSBvZiBgd2F0Y2hFeHByZXNzaW9uYAogICAgICAgKiAgICBUaGUgYHNjb3BlYCByZWZlcnMgdG8gdGhlIGN1cnJlbnQgc2NvcGUuCiAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBSZXR1cm5zIGEgZGUtcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGZvciBhbGwgbGlzdGVuZXJzLgogICAgICAgKi8KICAgICAgJHdhdGNoR3JvdXA6IGZ1bmN0aW9uKHdhdGNoRXhwcmVzc2lvbnMsIGxpc3RlbmVyKSB7CiAgICAgICAgdmFyIG9sZFZhbHVlcyA9IG5ldyBBcnJheSh3YXRjaEV4cHJlc3Npb25zLmxlbmd0aCk7CiAgICAgICAgdmFyIG5ld1ZhbHVlcyA9IG5ldyBBcnJheSh3YXRjaEV4cHJlc3Npb25zLmxlbmd0aCk7CiAgICAgICAgdmFyIGRlcmVnaXN0ZXJGbnMgPSBbXTsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgdmFyIGNoYW5nZVJlYWN0aW9uU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgdmFyIGZpcnN0UnVuID0gdHJ1ZTsKCiAgICAgICAgaWYgKCF3YXRjaEV4cHJlc3Npb25zLmxlbmd0aCkgewogICAgICAgICAgLy8gTm8gZXhwcmVzc2lvbnMgbWVhbnMgd2UgY2FsbCB0aGUgbGlzdGVuZXIgQVNBUAogICAgICAgICAgdmFyIHNob3VsZENhbGwgPSB0cnVlOwogICAgICAgICAgc2VsZi4kZXZhbEFzeW5jKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENhbGwpIGxpc3RlbmVyKG5ld1ZhbHVlcywgbmV3VmFsdWVzLCBzZWxmKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGRlcmVnaXN0ZXJXYXRjaEdyb3VwKCkgewogICAgICAgICAgICBzaG91bGRDYWxsID0gZmFsc2U7CiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgaWYgKHdhdGNoRXhwcmVzc2lvbnMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAvLyBTcGVjaWFsIGNhc2Ugc2l6ZSBvZiBvbmUKICAgICAgICAgIHJldHVybiB0aGlzLiR3YXRjaCh3YXRjaEV4cHJlc3Npb25zWzBdLCBmdW5jdGlvbiB3YXRjaEdyb3VwQWN0aW9uKHZhbHVlLCBvbGRWYWx1ZSwgc2NvcGUpIHsKICAgICAgICAgICAgbmV3VmFsdWVzWzBdID0gdmFsdWU7CiAgICAgICAgICAgIG9sZFZhbHVlc1swXSA9IG9sZFZhbHVlOwogICAgICAgICAgICBsaXN0ZW5lcihuZXdWYWx1ZXMsICh2YWx1ZSA9PT0gb2xkVmFsdWUpID8gbmV3VmFsdWVzIDogb2xkVmFsdWVzLCBzY29wZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGZvckVhY2god2F0Y2hFeHByZXNzaW9ucywgZnVuY3Rpb24gKGV4cHIsIGkpIHsKICAgICAgICAgIHZhciB1bndhdGNoRm4gPSBzZWxmLiR3YXRjaChleHByLCBmdW5jdGlvbiB3YXRjaEdyb3VwU3ViQWN0aW9uKHZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICBuZXdWYWx1ZXNbaV0gPSB2YWx1ZTsKICAgICAgICAgICAgb2xkVmFsdWVzW2ldID0gb2xkVmFsdWU7CiAgICAgICAgICAgIGlmICghY2hhbmdlUmVhY3Rpb25TY2hlZHVsZWQpIHsKICAgICAgICAgICAgICBjaGFuZ2VSZWFjdGlvblNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgc2VsZi4kZXZhbEFzeW5jKHdhdGNoR3JvdXBBY3Rpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGRlcmVnaXN0ZXJGbnMucHVzaCh1bndhdGNoRm4pOwogICAgICAgIH0pOwoKICAgICAgICBmdW5jdGlvbiB3YXRjaEdyb3VwQWN0aW9uKCkgewogICAgICAgICAgY2hhbmdlUmVhY3Rpb25TY2hlZHVsZWQgPSBmYWxzZTsKCiAgICAgICAgICBpZiAoZmlyc3RSdW4pIHsKICAgICAgICAgICAgZmlyc3RSdW4gPSBmYWxzZTsKICAgICAgICAgICAgbGlzdGVuZXIobmV3VmFsdWVzLCBuZXdWYWx1ZXMsIHNlbGYpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlzdGVuZXIobmV3VmFsdWVzLCBvbGRWYWx1ZXMsIHNlbGYpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGRlcmVnaXN0ZXJXYXRjaEdyb3VwKCkgewogICAgICAgICAgd2hpbGUgKGRlcmVnaXN0ZXJGbnMubGVuZ3RoKSB7CiAgICAgICAgICAgIGRlcmVnaXN0ZXJGbnMuc2hpZnQoKSgpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkd2F0Y2hDb2xsZWN0aW9uCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBTaGFsbG93IHdhdGNoZXMgdGhlIHByb3BlcnRpZXMgb2YgYW4gb2JqZWN0IGFuZCBmaXJlcyB3aGVuZXZlciBhbnkgb2YgdGhlIHByb3BlcnRpZXMgY2hhbmdlCiAgICAgICAqIChmb3IgYXJyYXlzLCB0aGlzIGltcGxpZXMgd2F0Y2hpbmcgdGhlIGFycmF5IGl0ZW1zOyBmb3Igb2JqZWN0IG1hcHMsIHRoaXMgaW1wbGllcyB3YXRjaGluZwogICAgICAgKiB0aGUgcHJvcGVydGllcykuIElmIGEgY2hhbmdlIGlzIGRldGVjdGVkLCB0aGUgYGxpc3RlbmVyYCBjYWxsYmFjayBpcyBmaXJlZC4KICAgICAgICoKICAgICAgICogLSBUaGUgYG9iamAgY29sbGVjdGlvbiBpcyBvYnNlcnZlZCB2aWEgc3RhbmRhcmQgJHdhdGNoIG9wZXJhdGlvbiBhbmQgaXMgZXhhbWluZWQgb24gZXZlcnkKICAgICAgICogICBjYWxsIHRvICRkaWdlc3QoKSB0byBzZWUgaWYgYW55IGl0ZW1zIGhhdmUgYmVlbiBhZGRlZCwgcmVtb3ZlZCwgb3IgbW92ZWQuCiAgICAgICAqIC0gVGhlIGBsaXN0ZW5lcmAgaXMgY2FsbGVkIHdoZW5ldmVyIGFueXRoaW5nIHdpdGhpbiB0aGUgYG9iamAgaGFzIGNoYW5nZWQuIEV4YW1wbGVzIGluY2x1ZGUKICAgICAgICogICBhZGRpbmcsIHJlbW92aW5nLCBhbmQgbW92aW5nIGl0ZW1zIGJlbG9uZ2luZyB0byBhbiBvYmplY3Qgb3IgYXJyYXkuCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqICMgRXhhbXBsZQogICAgICAgKiBgYGBqcwogICAgICAgICAgJHNjb3BlLm5hbWVzID0gWydpZ29yJywgJ21hdGlhcycsICdtaXNrbycsICdqYW1lcyddOwogICAgICAgICAgJHNjb3BlLmRhdGFDb3VudCA9IDQ7CgogICAgICAgICAgJHNjb3BlLiR3YXRjaENvbGxlY3Rpb24oJ25hbWVzJywgZnVuY3Rpb24obmV3TmFtZXMsIG9sZE5hbWVzKSB7CiAgICAgICAgICAgICRzY29wZS5kYXRhQ291bnQgPSBuZXdOYW1lcy5sZW5ndGg7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBleHBlY3QoJHNjb3BlLmRhdGFDb3VudCkudG9FcXVhbCg0KTsKICAgICAgICAgICRzY29wZS4kZGlnZXN0KCk7CgogICAgICAgICAgLy9zdGlsbCBhdCA0IC4uLiBubyBjaGFuZ2VzCiAgICAgICAgICBleHBlY3QoJHNjb3BlLmRhdGFDb3VudCkudG9FcXVhbCg0KTsKCiAgICAgICAgICAkc2NvcGUubmFtZXMucG9wKCk7CiAgICAgICAgICAkc2NvcGUuJGRpZ2VzdCgpOwoKICAgICAgICAgIC8vbm93IHRoZXJlJ3MgYmVlbiBhIGNoYW5nZQogICAgICAgICAgZXhwZWN0KCRzY29wZS5kYXRhQ291bnQpLnRvRXF1YWwoMyk7CiAgICAgICAqIGBgYAogICAgICAgKgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ3xmdW5jdGlvbihzY29wZSl9IG9iaiBFdmFsdWF0ZWQgYXMge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uIFRoZQogICAgICAgKiAgICBleHByZXNzaW9uIHZhbHVlIHNob3VsZCBldmFsdWF0ZSB0byBhbiBvYmplY3Qgb3IgYW4gYXJyYXkgd2hpY2ggaXMgb2JzZXJ2ZWQgb24gZWFjaAogICAgICAgKiAgICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGN5Y2xlLiBBbnkgc2hhbGxvdyBjaGFuZ2Ugd2l0aGluIHRoZQogICAgICAgKiAgICBjb2xsZWN0aW9uIHdpbGwgdHJpZ2dlciBhIGNhbGwgdG8gdGhlIGBsaXN0ZW5lcmAuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24obmV3Q29sbGVjdGlvbiwgb2xkQ29sbGVjdGlvbiwgc2NvcGUpfSBsaXN0ZW5lciBhIGNhbGxiYWNrIGZ1bmN0aW9uIGNhbGxlZAogICAgICAgKiAgICB3aGVuIGEgY2hhbmdlIGlzIGRldGVjdGVkLgogICAgICAgKiAgICAtIFRoZSBgbmV3Q29sbGVjdGlvbmAgb2JqZWN0IGlzIHRoZSBuZXdseSBtb2RpZmllZCBkYXRhIG9idGFpbmVkIGZyb20gdGhlIGBvYmpgIGV4cHJlc3Npb24KICAgICAgICogICAgLSBUaGUgYG9sZENvbGxlY3Rpb25gIG9iamVjdCBpcyBhIGNvcHkgb2YgdGhlIGZvcm1lciBjb2xsZWN0aW9uIGRhdGEuCiAgICAgICAqICAgICAgRHVlIHRvIHBlcmZvcm1hbmNlIGNvbnNpZGVyYXRpb25zLCB0aGVgb2xkQ29sbGVjdGlvbmAgdmFsdWUgaXMgY29tcHV0ZWQgb25seSBpZiB0aGUKICAgICAgICogICAgICBgbGlzdGVuZXJgIGZ1bmN0aW9uIGRlY2xhcmVzIHR3byBvciBtb3JlIGFyZ3VtZW50cy4KICAgICAgICogICAgLSBUaGUgYHNjb3BlYCBhcmd1bWVudCByZWZlcnMgdG8gdGhlIGN1cnJlbnQgc2NvcGUuCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBSZXR1cm5zIGEgZGUtcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGZvciB0aGlzIGxpc3RlbmVyLiBXaGVuIHRoZQogICAgICAgKiAgICBkZS1yZWdpc3RyYXRpb24gZnVuY3Rpb24gaXMgZXhlY3V0ZWQsIHRoZSBpbnRlcm5hbCB3YXRjaCBvcGVyYXRpb24gaXMgdGVybWluYXRlZC4KICAgICAgICovCiAgICAgICR3YXRjaENvbGxlY3Rpb246IGZ1bmN0aW9uKG9iaiwgbGlzdGVuZXIpIHsKICAgICAgICAkd2F0Y2hDb2xsZWN0aW9uSW50ZXJjZXB0b3IuJHN0YXRlZnVsID0gdHJ1ZTsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIC8vIHRoZSBjdXJyZW50IHZhbHVlLCB1cGRhdGVkIG9uIGVhY2ggZGlydHktY2hlY2sgcnVuCiAgICAgICAgdmFyIG5ld1ZhbHVlOwogICAgICAgIC8vIGEgc2hhbGxvdyBjb3B5IG9mIHRoZSBuZXdWYWx1ZSBmcm9tIHRoZSBsYXN0IGRpcnR5LWNoZWNrIHJ1biwKICAgICAgICAvLyB1cGRhdGVkIHRvIG1hdGNoIG5ld1ZhbHVlIGR1cmluZyBkaXJ0eS1jaGVjayBydW4KICAgICAgICB2YXIgb2xkVmFsdWU7CiAgICAgICAgLy8gYSBzaGFsbG93IGNvcHkgb2YgdGhlIG5ld1ZhbHVlIGZyb20gd2hlbiB0aGUgbGFzdCBjaGFuZ2UgaGFwcGVuZWQKICAgICAgICB2YXIgdmVyeU9sZFZhbHVlOwogICAgICAgIC8vIG9ubHkgdHJhY2sgdmVyeU9sZFZhbHVlIGlmIHRoZSBsaXN0ZW5lciBpcyBhc2tpbmcgZm9yIGl0CiAgICAgICAgdmFyIHRyYWNrVmVyeU9sZFZhbHVlID0gKGxpc3RlbmVyLmxlbmd0aCA+IDEpOwogICAgICAgIHZhciBjaGFuZ2VEZXRlY3RlZCA9IDA7CiAgICAgICAgdmFyIGNoYW5nZURldGVjdG9yID0gJHBhcnNlKG9iaiwgJHdhdGNoQ29sbGVjdGlvbkludGVyY2VwdG9yKTsKICAgICAgICB2YXIgaW50ZXJuYWxBcnJheSA9IFtdOwogICAgICAgIHZhciBpbnRlcm5hbE9iamVjdCA9IHt9OwogICAgICAgIHZhciBpbml0UnVuID0gdHJ1ZTsKICAgICAgICB2YXIgb2xkTGVuZ3RoID0gMDsKCiAgICAgICAgZnVuY3Rpb24gJHdhdGNoQ29sbGVjdGlvbkludGVyY2VwdG9yKF92YWx1ZSkgewogICAgICAgICAgbmV3VmFsdWUgPSBfdmFsdWU7CiAgICAgICAgICB2YXIgbmV3TGVuZ3RoLCBrZXksIGJvdGhOYU4sIG5ld0l0ZW0sIG9sZEl0ZW07CgogICAgICAgICAgaWYgKCFpc09iamVjdChuZXdWYWx1ZSkpIHsgLy8gaWYgcHJpbWl0aXZlCiAgICAgICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICBvbGRWYWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheUxpa2UobmV3VmFsdWUpKSB7CiAgICAgICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gaW50ZXJuYWxBcnJheSkgewogICAgICAgICAgICAgIC8vIHdlIGFyZSB0cmFuc2l0aW9uaW5nIGZyb20gc29tZXRoaW5nIHdoaWNoIHdhcyBub3QgYW4gYXJyYXkgaW50byBhcnJheS4KICAgICAgICAgICAgICBvbGRWYWx1ZSA9IGludGVybmFsQXJyYXk7CiAgICAgICAgICAgICAgb2xkTGVuZ3RoID0gb2xkVmFsdWUubGVuZ3RoID0gMDsKICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdMZW5ndGggPSBuZXdWYWx1ZS5sZW5ndGg7CgogICAgICAgICAgICBpZiAob2xkTGVuZ3RoICE9PSBuZXdMZW5ndGgpIHsKICAgICAgICAgICAgICAvLyBpZiBsZW5ndGhzIGRvIG5vdCBtYXRjaCB3ZSBuZWVkIHRvIHRyaWdnZXIgY2hhbmdlIG5vdGlmaWNhdGlvbgogICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgICAgb2xkVmFsdWUubGVuZ3RoID0gb2xkTGVuZ3RoID0gbmV3TGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGNvcHkgdGhlIGl0ZW1zIHRvIG9sZFZhbHVlIGFuZCBsb29rIGZvciBjaGFuZ2VzLgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld0xlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgb2xkSXRlbSA9IG9sZFZhbHVlW2ldOwogICAgICAgICAgICAgIG5ld0l0ZW0gPSBuZXdWYWx1ZVtpXTsKCiAgICAgICAgICAgICAgYm90aE5hTiA9IChvbGRJdGVtICE9PSBvbGRJdGVtKSAmJiAobmV3SXRlbSAhPT0gbmV3SXRlbSk7CiAgICAgICAgICAgICAgaWYgKCFib3RoTmFOICYmIChvbGRJdGVtICE9PSBuZXdJdGVtKSkgewogICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgIG9sZFZhbHVlW2ldID0gbmV3SXRlbTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gaW50ZXJuYWxPYmplY3QpIHsKICAgICAgICAgICAgICAvLyB3ZSBhcmUgdHJhbnNpdGlvbmluZyBmcm9tIHNvbWV0aGluZyB3aGljaCB3YXMgbm90IGFuIG9iamVjdCBpbnRvIG9iamVjdC4KICAgICAgICAgICAgICBvbGRWYWx1ZSA9IGludGVybmFsT2JqZWN0ID0ge307CiAgICAgICAgICAgICAgb2xkTGVuZ3RoID0gMDsKICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGNvcHkgdGhlIGl0ZW1zIHRvIG9sZFZhbHVlIGFuZCBsb29rIGZvciBjaGFuZ2VzLgogICAgICAgICAgICBuZXdMZW5ndGggPSAwOwogICAgICAgICAgICBmb3IgKGtleSBpbiBuZXdWYWx1ZSkgewogICAgICAgICAgICAgIGlmIChuZXdWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICBuZXdMZW5ndGgrKzsKICAgICAgICAgICAgICAgIG5ld0l0ZW0gPSBuZXdWYWx1ZVtrZXldOwogICAgICAgICAgICAgICAgb2xkSXRlbSA9IG9sZFZhbHVlW2tleV07CgogICAgICAgICAgICAgICAgaWYgKGtleSBpbiBvbGRWYWx1ZSkgewogICAgICAgICAgICAgICAgICBib3RoTmFOID0gKG9sZEl0ZW0gIT09IG9sZEl0ZW0pICYmIChuZXdJdGVtICE9PSBuZXdJdGVtKTsKICAgICAgICAgICAgICAgICAgaWYgKCFib3RoTmFOICYmIChvbGRJdGVtICE9PSBuZXdJdGVtKSkgewogICAgICAgICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWVba2V5XSA9IG5ld0l0ZW07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG9sZExlbmd0aCsrOwogICAgICAgICAgICAgICAgICBvbGRWYWx1ZVtrZXldID0gbmV3SXRlbTsKICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9sZExlbmd0aCA+IG5ld0xlbmd0aCkgewogICAgICAgICAgICAgIC8vIHdlIHVzZWQgdG8gaGF2ZSBtb3JlIGtleXMsIG5lZWQgdG8gZmluZCB0aGVtIGFuZCBkZXN0cm95IHRoZW0uCiAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICBmb3Ioa2V5IGluIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoIW5ld1ZhbHVlLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgb2xkTGVuZ3RoLS07CiAgICAgICAgICAgICAgICAgIGRlbGV0ZSBvbGRWYWx1ZVtrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNoYW5nZURldGVjdGVkOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gJHdhdGNoQ29sbGVjdGlvbkFjdGlvbigpIHsKICAgICAgICAgIGlmIChpbml0UnVuKSB7CiAgICAgICAgICAgIGluaXRSdW4gPSBmYWxzZTsKICAgICAgICAgICAgbGlzdGVuZXIobmV3VmFsdWUsIG5ld1ZhbHVlLCBzZWxmKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpc3RlbmVyKG5ld1ZhbHVlLCB2ZXJ5T2xkVmFsdWUsIHNlbGYpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIG1ha2UgYSBjb3B5IGZvciB0aGUgbmV4dCB0aW1lIGEgY29sbGVjdGlvbiBpcyBjaGFuZ2VkCiAgICAgICAgICBpZiAodHJhY2tWZXJ5T2xkVmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFpc09iamVjdChuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICAvL3ByaW1pdGl2ZQogICAgICAgICAgICAgIHZlcnlPbGRWYWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXlMaWtlKG5ld1ZhbHVlKSkgewogICAgICAgICAgICAgIHZlcnlPbGRWYWx1ZSA9IG5ldyBBcnJheShuZXdWYWx1ZS5sZW5ndGgpOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3VmFsdWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZlcnlPbGRWYWx1ZVtpXSA9IG5ld1ZhbHVlW2ldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsgLy8gaWYgb2JqZWN0CiAgICAgICAgICAgICAgdmVyeU9sZFZhbHVlID0ge307CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChuZXdWYWx1ZSwga2V5KSkgewogICAgICAgICAgICAgICAgICB2ZXJ5T2xkVmFsdWVba2V5XSA9IG5ld1ZhbHVlW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy4kd2F0Y2goY2hhbmdlRGV0ZWN0b3IsICR3YXRjaENvbGxlY3Rpb25BY3Rpb24pOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0CiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBQcm9jZXNzZXMgYWxsIG9mIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2hlcnN9IG9mIHRoZSBjdXJyZW50IHNjb3BlIGFuZAogICAgICAgKiBpdHMgY2hpbGRyZW4uIEJlY2F1c2UgYSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2hlcn0ncyBsaXN0ZW5lciBjYW4gY2hhbmdlCiAgICAgICAqIHRoZSBtb2RlbCwgdGhlIGAkZGlnZXN0KClgIGtlZXBzIGNhbGxpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30KICAgICAgICogdW50aWwgbm8gbW9yZSBsaXN0ZW5lcnMgYXJlIGZpcmluZy4gVGhpcyBtZWFucyB0aGF0IGl0IGlzIHBvc3NpYmxlIHRvIGdldCBpbnRvIGFuIGluZmluaXRlCiAgICAgICAqIGxvb3AuIFRoaXMgZnVuY3Rpb24gd2lsbCB0aHJvdyBgJ01heGltdW0gaXRlcmF0aW9uIGxpbWl0IGV4Y2VlZGVkLidgIGlmIHRoZSBudW1iZXIgb2YKICAgICAgICogaXRlcmF0aW9ucyBleGNlZWRzIDEwLgogICAgICAgKgogICAgICAgKiBVc3VhbGx5LCB5b3UgZG9uJ3QgY2FsbCBgJGRpZ2VzdCgpYCBkaXJlY3RseSBpbgogICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ29udHJvbGxlciBjb250cm9sbGVyc30gb3IgaW4KICAgICAgICoge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlIGRpcmVjdGl2ZXN9LgogICAgICAgKiBJbnN0ZWFkLCB5b3Ugc2hvdWxkIGNhbGwge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseSgpfSAodHlwaWNhbGx5IGZyb20gd2l0aGluCiAgICAgICAqIGEge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlIGRpcmVjdGl2ZX0pLCB3aGljaCB3aWxsIGZvcmNlIGEgYCRkaWdlc3QoKWAuCiAgICAgICAqCiAgICAgICAqIElmIHlvdSB3YW50IHRvIGJlIG5vdGlmaWVkIHdoZW5ldmVyIGAkZGlnZXN0KClgIGlzIGNhbGxlZCwKICAgICAgICogeW91IGNhbiByZWdpc3RlciBhIGB3YXRjaEV4cHJlc3Npb25gIGZ1bmN0aW9uIHdpdGgKICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoICR3YXRjaCgpfSB3aXRoIG5vIGBsaXN0ZW5lcmAuCiAgICAgICAqCiAgICAgICAqIEluIHVuaXQgdGVzdHMsIHlvdSBtYXkgbmVlZCB0byBjYWxsIGAkZGlnZXN0KClgIHRvIHNpbXVsYXRlIHRoZSBzY29wZSBsaWZlIGN5Y2xlLgogICAgICAgKgogICAgICAgKiAjIEV4YW1wbGUKICAgICAgICogYGBganMKICAgICAgICAgICB2YXIgc2NvcGUgPSAuLi47CiAgICAgICAgICAgc2NvcGUubmFtZSA9ICdtaXNrbyc7CiAgICAgICAgICAgc2NvcGUuY291bnRlciA9IDA7CgogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgIHNjb3BlLiR3YXRjaCgnbmFtZScsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICAgc2NvcGUuY291bnRlciA9IHNjb3BlLmNvdW50ZXIgKyAxOwogICAgICAgICAgIH0pOwogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgLy8gdGhlIGxpc3RlbmVyIGlzIGFsd2F5cyBjYWxsZWQgZHVyaW5nIHRoZSBmaXJzdCAkZGlnZXN0IGxvb3AgYWZ0ZXIgaXQgd2FzIHJlZ2lzdGVyZWQKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKCiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIC8vIGJ1dCBub3cgaXQgd2lsbCBub3QgYmUgY2FsbGVkIHVubGVzcyB0aGUgdmFsdWUgY2hhbmdlcwogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwoKICAgICAgICAgICBzY29wZS5uYW1lID0gJ2FkYW0nOwogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgyKTsKICAgICAgICogYGBgCiAgICAgICAqCiAgICAgICAqLwogICAgICAkZGlnZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgd2F0Y2gsIHZhbHVlLCBsYXN0LAogICAgICAgICAgICB3YXRjaGVycywKICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICBkaXJ0eSwgdHRsID0gVFRMLAogICAgICAgICAgICBuZXh0LCBjdXJyZW50LCB0YXJnZXQgPSB0aGlzLAogICAgICAgICAgICB3YXRjaExvZyA9IFtdLAogICAgICAgICAgICBsb2dJZHgsIGxvZ01zZywgYXN5bmNUYXNrOwoKICAgICAgICBiZWdpblBoYXNlKCckZGlnZXN0Jyk7CiAgICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgdG8gYnJvd3NlciB1cmwgdGhhdCBoYXBwZW5lZCBpbiBzeW5jIGJlZm9yZSB0aGUgY2FsbCB0byAkZGlnZXN0CiAgICAgICAgJGJyb3dzZXIuJCRjaGVja1VybENoYW5nZSgpOwoKICAgICAgICBpZiAodGhpcyA9PT0gJHJvb3RTY29wZSAmJiBhcHBseUFzeW5jSWQgIT09IG51bGwpIHsKICAgICAgICAgIC8vIElmIHRoaXMgaXMgdGhlIHJvb3Qgc2NvcGUsIGFuZCAkYXBwbHlBc3luYyBoYXMgc2NoZWR1bGVkIGEgZGVmZXJyZWQgJGFwcGx5KCksIHRoZW4KICAgICAgICAgIC8vIGNhbmNlbCB0aGUgc2NoZWR1bGVkICRhcHBseSBhbmQgZmx1c2ggdGhlIHF1ZXVlIG9mIGV4cHJlc3Npb25zIHRvIGJlIGV2YWx1YXRlZC4KICAgICAgICAgICRicm93c2VyLmRlZmVyLmNhbmNlbChhcHBseUFzeW5jSWQpOwogICAgICAgICAgZmx1c2hBcHBseUFzeW5jKCk7CiAgICAgICAgfQoKICAgICAgICBsYXN0RGlydHlXYXRjaCA9IG51bGw7CgogICAgICAgIGRvIHsgLy8gIndoaWxlIGRpcnR5IiBsb29wCiAgICAgICAgICBkaXJ0eSA9IGZhbHNlOwogICAgICAgICAgY3VycmVudCA9IHRhcmdldDsKCiAgICAgICAgICB3aGlsZShhc3luY1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGFzeW5jVGFzayA9IGFzeW5jUXVldWUuc2hpZnQoKTsKICAgICAgICAgICAgICBhc3luY1Rhc2suc2NvcGUuJGV2YWwoYXN5bmNUYXNrLmV4cHJlc3Npb24pOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdERpcnR5V2F0Y2ggPSBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIHRyYXZlcnNlU2NvcGVzTG9vcDoKICAgICAgICAgIGRvIHsgLy8gInRyYXZlcnNlIHRoZSBzY29wZXMiIGxvb3AKICAgICAgICAgICAgaWYgKCh3YXRjaGVycyA9IGN1cnJlbnQuJCR3YXRjaGVycykpIHsKICAgICAgICAgICAgICAvLyBwcm9jZXNzIG91ciB3YXRjaGVzCiAgICAgICAgICAgICAgbGVuZ3RoID0gd2F0Y2hlcnMubGVuZ3RoOwogICAgICAgICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgd2F0Y2ggPSB3YXRjaGVyc1tsZW5ndGhdOwogICAgICAgICAgICAgICAgICAvLyBNb3N0IGNvbW1vbiB3YXRjaGVzIGFyZSBvbiBwcmltaXRpdmVzLCBpbiB3aGljaCBjYXNlIHdlIGNhbiBzaG9ydAogICAgICAgICAgICAgICAgICAvLyBjaXJjdWl0IGl0IHdpdGggPT09IG9wZXJhdG9yLCBvbmx5IHdoZW4gPT09IGZhaWxzIGRvIHdlIHVzZSAuZXF1YWxzCiAgICAgICAgICAgICAgICAgIGlmICh3YXRjaCkgewogICAgICAgICAgICAgICAgICAgIGlmICgodmFsdWUgPSB3YXRjaC5nZXQoY3VycmVudCkpICE9PSAobGFzdCA9IHdhdGNoLmxhc3QpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICEod2F0Y2guZXEKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZXF1YWxzKHZhbHVlLCBsYXN0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyAmJiB0eXBlb2YgbGFzdCA9PT0gJ251bWJlcicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIGlzTmFOKHZhbHVlKSAmJiBpc05hTihsYXN0KSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBsYXN0RGlydHlXYXRjaCA9IHdhdGNoOwogICAgICAgICAgICAgICAgICAgICAgd2F0Y2gubGFzdCA9IHdhdGNoLmVxID8gY29weSh2YWx1ZSwgbnVsbCkgOiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgIHdhdGNoLmZuKHZhbHVlLCAoKGxhc3QgPT09IGluaXRXYXRjaFZhbCkgPyB2YWx1ZSA6IGxhc3QpLCBjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgICAgIGlmICh0dGwgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0lkeCA9IDQgLSB0dGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghd2F0Y2hMb2dbbG9nSWR4XSkgd2F0Y2hMb2dbbG9nSWR4XSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBsb2dNc2cgPSAoaXNGdW5jdGlvbih3YXRjaC5leHApKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAnZm46ICcgKyAod2F0Y2guZXhwLm5hbWUgfHwgd2F0Y2guZXhwLnRvU3RyaW5nKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHdhdGNoLmV4cDsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nTXNnICs9ICc7IG5ld1ZhbDogJyArIHRvSnNvbih2YWx1ZSkgKyAnOyBvbGRWYWw6ICcgKyB0b0pzb24obGFzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoTG9nW2xvZ0lkeF0ucHVzaChsb2dNc2cpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAod2F0Y2ggPT09IGxhc3REaXJ0eVdhdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgbW9zdCByZWNlbnRseSBkaXJ0eSB3YXRjaGVyIGlzIG5vdyBjbGVhbiwgc2hvcnQgY2lyY3VpdCBzaW5jZSB0aGUgcmVtYWluaW5nIHdhdGNoZXJzCiAgICAgICAgICAgICAgICAgICAgICAvLyBoYXZlIGFscmVhZHkgYmVlbiB0ZXN0ZWQuCiAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgdHJhdmVyc2VTY29wZXNMb29wOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEluc2FuaXR5IFdhcm5pbmc6IHNjb3BlIGRlcHRoLWZpcnN0IHRyYXZlcnNhbAogICAgICAgICAgICAvLyB5ZXMsIHRoaXMgY29kZSBpcyBhIGJpdCBjcmF6eSwgYnV0IGl0IHdvcmtzIGFuZCB3ZSBoYXZlIHRlc3RzIHRvIHByb3ZlIGl0IQogICAgICAgICAgICAvLyB0aGlzIHBpZWNlIHNob3VsZCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgdHJhdmVyc2FsIGluICRicm9hZGNhc3QKICAgICAgICAgICAgaWYgKCEobmV4dCA9IChjdXJyZW50LiQkY2hpbGRIZWFkIHx8CiAgICAgICAgICAgICAgICAoY3VycmVudCAhPT0gdGFyZ2V0ICYmIGN1cnJlbnQuJCRuZXh0U2libGluZykpKSkgewogICAgICAgICAgICAgIHdoaWxlKGN1cnJlbnQgIT09IHRhcmdldCAmJiAhKG5leHQgPSBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC4kcGFyZW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAoKGN1cnJlbnQgPSBuZXh0KSk7CgogICAgICAgICAgLy8gYGJyZWFrIHRyYXZlcnNlU2NvcGVzTG9vcDtgIHRha2VzIHVzIHRvIGhlcmUKCiAgICAgICAgICBpZigoZGlydHkgfHwgYXN5bmNRdWV1ZS5sZW5ndGgpICYmICEodHRsLS0pKSB7CiAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgdGhyb3cgJHJvb3RTY29wZU1pbkVycignaW5mZGlnJywKICAgICAgICAgICAgICAgICd7MH0gJGRpZ2VzdCgpIGl0ZXJhdGlvbnMgcmVhY2hlZC4gQWJvcnRpbmchXG4nICsKICAgICAgICAgICAgICAgICdXYXRjaGVycyBmaXJlZCBpbiB0aGUgbGFzdCA1IGl0ZXJhdGlvbnM6IHsxfScsCiAgICAgICAgICAgICAgICBUVEwsIHRvSnNvbih3YXRjaExvZykpOwogICAgICAgICAgfQoKICAgICAgICB9IHdoaWxlIChkaXJ0eSB8fCBhc3luY1F1ZXVlLmxlbmd0aCk7CgogICAgICAgIGNsZWFyUGhhc2UoKTsKCiAgICAgICAgd2hpbGUocG9zdERpZ2VzdFF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcG9zdERpZ2VzdFF1ZXVlLnNoaWZ0KCkoKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveQogICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiBzY29wZSBiZWluZyBkZXN0cm95ZWQKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEJyb2FkY2FzdGVkIHdoZW4gYSBzY29wZSBhbmQgaXRzIGNoaWxkcmVuIGFyZSBiZWluZyBkZXN0cm95ZWQuCiAgICAgICAqCiAgICAgICAqIE5vdGUgdGhhdCwgaW4gQW5ndWxhckpTLCB0aGVyZSBpcyBhbHNvIGEgYCRkZXN0cm95YCBqUXVlcnkgZXZlbnQsIHdoaWNoIGNhbiBiZSB1c2VkIHRvCiAgICAgICAqIGNsZWFuIHVwIERPTSBiaW5kaW5ncyBiZWZvcmUgYW4gZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTS4KICAgICAgICovCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95CiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBSZW1vdmVzIHRoZSBjdXJyZW50IHNjb3BlIChhbmQgYWxsIG9mIGl0cyBjaGlsZHJlbikgZnJvbSB0aGUgcGFyZW50IHNjb3BlLiBSZW1vdmFsIGltcGxpZXMKICAgICAgICogdGhhdCBjYWxscyB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gd2lsbCBubyBsb25nZXIKICAgICAgICogcHJvcGFnYXRlIHRvIHRoZSBjdXJyZW50IHNjb3BlIGFuZCBpdHMgY2hpbGRyZW4uIFJlbW92YWwgYWxzbyBpbXBsaWVzIHRoYXQgdGhlIGN1cnJlbnQKICAgICAgICogc2NvcGUgaXMgZWxpZ2libGUgZm9yIGdhcmJhZ2UgY29sbGVjdGlvbi4KICAgICAgICoKICAgICAgICogVGhlIGAkZGVzdHJveSgpYCBpcyB1c3VhbGx5IHVzZWQgYnkgZGlyZWN0aXZlcyBzdWNoIGFzCiAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9IGZvciBtYW5hZ2luZyB0aGUKICAgICAgICogdW5yb2xsaW5nIG9mIHRoZSBsb29wLgogICAgICAgKgogICAgICAgKiBKdXN0IGJlZm9yZSBhIHNjb3BlIGlzIGRlc3Ryb3llZCwgYSBgJGRlc3Ryb3lgIGV2ZW50IGlzIGJyb2FkY2FzdGVkIG9uIHRoaXMgc2NvcGUuCiAgICAgICAqIEFwcGxpY2F0aW9uIGNvZGUgY2FuIHJlZ2lzdGVyIGEgYCRkZXN0cm95YCBldmVudCBoYW5kbGVyIHRoYXQgd2lsbCBnaXZlIGl0IGEgY2hhbmNlIHRvCiAgICAgICAqIHBlcmZvcm0gYW55IG5lY2Vzc2FyeSBjbGVhbnVwLgogICAgICAgKgogICAgICAgKiBOb3RlIHRoYXQsIGluIEFuZ3VsYXJKUywgdGhlcmUgaXMgYWxzbyBhIGAkZGVzdHJveWAgalF1ZXJ5IGV2ZW50LCB3aGljaCBjYW4gYmUgdXNlZCB0bwogICAgICAgKiBjbGVhbiB1cCBET00gYmluZGluZ3MgYmVmb3JlIGFuIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBET00uCiAgICAgICAqLwogICAgICAkZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gd2UgY2FuJ3QgZGVzdHJveSB0aGUgcm9vdCBzY29wZSBvciBhIHNjb3BlIHRoYXQgaGFzIGJlZW4gYWxyZWFkeSBkZXN0cm95ZWQKICAgICAgICBpZiAodGhpcy4kJGRlc3Ryb3llZCkgcmV0dXJuOwogICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLiRwYXJlbnQ7CgogICAgICAgIHRoaXMuJGJyb2FkY2FzdCgnJGRlc3Ryb3knKTsKICAgICAgICB0aGlzLiQkZGVzdHJveWVkID0gdHJ1ZTsKICAgICAgICBpZiAodGhpcyA9PT0gJHJvb3RTY29wZSkgcmV0dXJuOwoKICAgICAgICBmb3IgKHZhciBldmVudE5hbWUgaW4gdGhpcy4kJGxpc3RlbmVyQ291bnQpIHsKICAgICAgICAgIGRlY3JlbWVudExpc3RlbmVyQ291bnQodGhpcywgdGhpcy4kJGxpc3RlbmVyQ291bnRbZXZlbnROYW1lXSwgZXZlbnROYW1lKTsKICAgICAgICB9CgogICAgICAgIC8vIHNldmVyIGFsbCB0aGUgcmVmZXJlbmNlcyB0byBwYXJlbnQgc2NvcGVzIChhZnRlciB0aGlzIGNsZWFudXAsIHRoZSBjdXJyZW50IHNjb3BlIHNob3VsZAogICAgICAgIC8vIG5vdCBiZSByZXRhaW5lZCBieSBhbnkgb2Ygb3VyIHJlZmVyZW5jZXMgYW5kIHNob3VsZCBiZSBlbGlnaWJsZSBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uKQogICAgICAgIGlmIChwYXJlbnQuJCRjaGlsZEhlYWQgPT0gdGhpcykgcGFyZW50LiQkY2hpbGRIZWFkID0gdGhpcy4kJG5leHRTaWJsaW5nOwogICAgICAgIGlmIChwYXJlbnQuJCRjaGlsZFRhaWwgPT0gdGhpcykgcGFyZW50LiQkY2hpbGRUYWlsID0gdGhpcy4kJHByZXZTaWJsaW5nOwogICAgICAgIGlmICh0aGlzLiQkcHJldlNpYmxpbmcpIHRoaXMuJCRwcmV2U2libGluZy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJG5leHRTaWJsaW5nOwogICAgICAgIGlmICh0aGlzLiQkbmV4dFNpYmxpbmcpIHRoaXMuJCRuZXh0U2libGluZy4kJHByZXZTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nOwoKICAgICAgICAvLyBEaXNhYmxlIGxpc3RlbmVycywgd2F0Y2hlcnMgYW5kIGFwcGx5L2RpZ2VzdCBtZXRob2RzCiAgICAgICAgdGhpcy4kZGVzdHJveSA9IHRoaXMuJGRpZ2VzdCA9IHRoaXMuJGFwcGx5ID0gdGhpcy4kZXZhbEFzeW5jID0gdGhpcy4kYXBwbHlBc3luYyA9IG5vb3A7CiAgICAgICAgdGhpcy4kb24gPSB0aGlzLiR3YXRjaCA9IHRoaXMuJHdhdGNoR3JvdXAgPSBmdW5jdGlvbigpIHsgcmV0dXJuIG5vb3A7IH07CiAgICAgICAgdGhpcy4kJGxpc3RlbmVycyA9IHt9OwoKICAgICAgICAvLyBBbGwgb2YgdGhlIGNvZGUgYmVsb3cgaXMgYm9ndXMgY29kZSB0aGF0IHdvcmtzIGFyb3VuZCBWOCdzIG1lbW9yeSBsZWFrIHZpYSBvcHRpbWl6ZWQgY29kZQogICAgICAgIC8vIGFuZCBpbmxpbmUgY2FjaGVzLgogICAgICAgIC8vCiAgICAgICAgLy8gc2VlOgogICAgICAgIC8vIC0gaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTIwNzMjYzI2CiAgICAgICAgLy8gLSBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy82Nzk0I2lzc3VlY29tbWVudC0zODY0ODkwOQogICAgICAgIC8vIC0gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvMTMxMyNpc3N1ZWNvbW1lbnQtMTAzNzg0NTEKCiAgICAgICAgdGhpcy4kcGFyZW50ID0gdGhpcy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nID0gdGhpcy4kJGNoaWxkSGVhZCA9CiAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwgPSB0aGlzLiRyb290ID0gdGhpcy4kJHdhdGNoZXJzID0gbnVsbDsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGV2YWwKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEV4ZWN1dGVzIHRoZSBgZXhwcmVzc2lvbmAgb24gdGhlIGN1cnJlbnQgc2NvcGUgYW5kIHJldHVybnMgdGhlIHJlc3VsdC4gQW55IGV4Y2VwdGlvbnMgaW4KICAgICAgICogdGhlIGV4cHJlc3Npb24gYXJlIHByb3BhZ2F0ZWQgKHVuY2F1Z2h0KS4gVGhpcyBpcyB1c2VmdWwgd2hlbiBldmFsdWF0aW5nIEFuZ3VsYXIKICAgICAgICogZXhwcmVzc2lvbnMuCiAgICAgICAqCiAgICAgICAqICMgRXhhbXBsZQogICAgICAgKiBgYGBqcwogICAgICAgICAgIHZhciBzY29wZSA9IG5nLiRyb290U2NvcGUuU2NvcGUoKTsKICAgICAgICAgICBzY29wZS5hID0gMTsKICAgICAgICAgICBzY29wZS5iID0gMjsKCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKCdhK2InKSkudG9FcXVhbCgzKTsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuJGV2YWwoZnVuY3Rpb24oc2NvcGUpeyByZXR1cm4gc2NvcGUuYSArIHNjb3BlLmI7IH0pKS50b0VxdWFsKDMpOwogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwcmVzc2lvbiBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAqCiAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4gIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBleGVjdXRlIHRoZSBmdW5jdGlvbiB3aXRoIHRoZSBjdXJyZW50IGBzY29wZWAgcGFyYW1ldGVyLgogICAgICAgKgogICAgICAgKiBAcGFyYW0geyhvYmplY3QpPX0gbG9jYWxzIExvY2FsIHZhcmlhYmxlcyBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4gc2NvcGUuCiAgICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmVzdWx0IG9mIGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24uCiAgICAgICAqLwogICAgICAkZXZhbDogZnVuY3Rpb24oZXhwciwgbG9jYWxzKSB7CiAgICAgICAgcmV0dXJuICRwYXJzZShleHByKSh0aGlzLCBsb2NhbHMpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZXZhbEFzeW5jCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBFeGVjdXRlcyB0aGUgZXhwcmVzc2lvbiBvbiB0aGUgY3VycmVudCBzY29wZSBhdCBhIGxhdGVyIHBvaW50IGluIHRpbWUuCiAgICAgICAqCiAgICAgICAqIFRoZSBgJGV2YWxBc3luY2AgbWFrZXMgbm8gZ3VhcmFudGVlcyBhcyB0byB3aGVuIHRoZSBgZXhwcmVzc2lvbmAgd2lsbCBiZSBleGVjdXRlZCwgb25seQogICAgICAgKiB0aGF0OgogICAgICAgKgogICAgICAgKiAgIC0gaXQgd2lsbCBleGVjdXRlIGFmdGVyIHRoZSBmdW5jdGlvbiB0aGF0IHNjaGVkdWxlZCB0aGUgZXZhbHVhdGlvbiAocHJlZmVyYWJseSBiZWZvcmUgRE9NCiAgICAgICAqICAgICByZW5kZXJpbmcpLgogICAgICAgKiAgIC0gYXQgbGVhc3Qgb25lIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCBjeWNsZX0gd2lsbCBiZSBwZXJmb3JtZWQgYWZ0ZXIKICAgICAgICogICAgIGBleHByZXNzaW9uYCBleGVjdXRpb24uCiAgICAgICAqCiAgICAgICAqIEFueSBleGNlcHRpb25zIGZyb20gdGhlIGV4ZWN1dGlvbiBvZiB0aGUgZXhwcmVzc2lvbiBhcmUgZm9yd2FyZGVkIHRvIHRoZQogICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAqCiAgICAgICAqIF9fTm90ZTpfXyBpZiB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBvdXRzaWRlIG9mIGEgYCRkaWdlc3RgIGN5Y2xlLCBhIG5ldyBgJGRpZ2VzdGAgY3ljbGUKICAgICAgICogd2lsbCBiZSBzY2hlZHVsZWQuIEhvd2V2ZXIsIGl0IGlzIGVuY291cmFnZWQgdG8gYWx3YXlzIGNhbGwgY29kZSB0aGF0IGNoYW5nZXMgdGhlIG1vZGVsCiAgICAgICAqIGZyb20gd2l0aGluIGFuIGAkYXBwbHlgIGNhbGwuIFRoYXQgaW5jbHVkZXMgY29kZSBldmFsdWF0ZWQgdmlhIGAkZXZhbEFzeW5jYC4KICAgICAgICoKICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwcmVzc2lvbiBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAqCiAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uCiAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAqCiAgICAgICAqLwogICAgICAkZXZhbEFzeW5jOiBmdW5jdGlvbihleHByKSB7CiAgICAgICAgLy8gaWYgd2UgYXJlIG91dHNpZGUgb2YgYW4gJGRpZ2VzdCBsb29wIGFuZCB0aGlzIGlzIHRoZSBmaXJzdCB0aW1lIHdlIGFyZSBzY2hlZHVsaW5nIGFzeW5jCiAgICAgICAgLy8gdGFzayBhbHNvIHNjaGVkdWxlIGFzeW5jIGF1dG8tZmx1c2gKICAgICAgICBpZiAoISRyb290U2NvcGUuJCRwaGFzZSAmJiAhYXN5bmNRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoYXN5bmNRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBhc3luY1F1ZXVlLnB1c2goe3Njb3BlOiB0aGlzLCBleHByZXNzaW9uOiBleHByfSk7CiAgICAgIH0sCgogICAgICAkJHBvc3REaWdlc3QgOiBmdW5jdGlvbihmbikgewogICAgICAgIHBvc3REaWdlc3RRdWV1ZS5wdXNoKGZuKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGFwcGx5CiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBgJGFwcGx5KClgIGlzIHVzZWQgdG8gZXhlY3V0ZSBhbiBleHByZXNzaW9uIGluIGFuZ3VsYXIgZnJvbSBvdXRzaWRlIG9mIHRoZSBhbmd1bGFyCiAgICAgICAqIGZyYW1ld29yay4gKEZvciBleGFtcGxlIGZyb20gYnJvd3NlciBET00gZXZlbnRzLCBzZXRUaW1lb3V0LCBYSFIgb3IgdGhpcmQgcGFydHkgbGlicmFyaWVzKS4KICAgICAgICogQmVjYXVzZSB3ZSBhcmUgY2FsbGluZyBpbnRvIHRoZSBhbmd1bGFyIGZyYW1ld29yayB3ZSBuZWVkIHRvIHBlcmZvcm0gcHJvcGVyIHNjb3BlIGxpZmUKICAgICAgICogY3ljbGUgb2Yge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyIGV4Y2VwdGlvbiBoYW5kbGluZ30sCiAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgZXhlY3V0aW5nIHdhdGNoZXN9LgogICAgICAgKgogICAgICAgKiAjIyBMaWZlIGN5Y2xlCiAgICAgICAqCiAgICAgICAqICMgUHNldWRvLUNvZGUgb2YgYCRhcHBseSgpYAogICAgICAgKiBgYGBqcwogICAgICAgICAgIGZ1bmN0aW9uICRhcHBseShleHByKSB7CiAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICByZXR1cm4gJGV2YWwoZXhwcik7CiAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgJHJvb3QuJGRpZ2VzdCgpOwogICAgICAgICAgICAgfQogICAgICAgICAgIH0KICAgICAgICogYGBgCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqIFNjb3BlJ3MgYCRhcHBseSgpYCBtZXRob2QgdHJhbnNpdGlvbnMgdGhyb3VnaCB0aGUgZm9sbG93aW5nIHN0YWdlczoKICAgICAgICoKICAgICAgICogMS4gVGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIGV4ZWN1dGVkIHVzaW5nIHRoZQogICAgICAgKiAgICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbCAkZXZhbCgpfSBtZXRob2QuCiAgICAgICAqIDIuIEFueSBleGNlcHRpb25zIGZyb20gdGhlIGV4ZWN1dGlvbiBvZiB0aGUgZXhwcmVzc2lvbiBhcmUgZm9yd2FyZGVkIHRvIHRoZQogICAgICAgKiAgICB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAqIDMuIFRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2h9IGxpc3RlbmVycyBhcmUgZmlyZWQgaW1tZWRpYXRlbHkgYWZ0ZXIgdGhlCiAgICAgICAqICAgIGV4cHJlc3Npb24gd2FzIGV4ZWN1dGVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gbWV0aG9kLgogICAgICAgKgogICAgICAgKgogICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHAgQW4gYW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkLgogICAgICAgKgogICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBleGVjdXRlIHRoZSBmdW5jdGlvbiB3aXRoIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmVzdWx0IG9mIGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24uCiAgICAgICAqLwogICAgICAkYXBwbHk6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgICB0cnkgewogICAgICAgICAgYmVnaW5QaGFzZSgnJGFwcGx5Jyk7CiAgICAgICAgICByZXR1cm4gdGhpcy4kZXZhbChleHByKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGFwcGx5QXN5bmMKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNjaGVkdWxlIHRoZSBpbnZva2F0aW9uIG9mICRhcHBseSB0byBvY2N1ciBhdCBhIGxhdGVyIHRpbWUuIFRoZSBhY3R1YWwgdGltZSBkaWZmZXJlbmNlCiAgICAgICAqIHZhcmllcyBhY3Jvc3MgYnJvd3NlcnMsIGJ1dCBpcyB0eXBpY2FsbHkgYXJvdW5kIH4xMCBtaWxsaXNlY29uZHMuCiAgICAgICAqCiAgICAgICAqIFRoaXMgY2FuIGJlIHVzZWQgdG8gcXVldWUgdXAgbXVsdGlwbGUgZXhwcmVzc2lvbnMgd2hpY2ggbmVlZCB0byBiZSBldmFsdWF0ZWQgaW4gdGhlIHNhbWUKICAgICAgICogZGlnZXN0LgogICAgICAgKgogICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHAgQW4gYW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkLgogICAgICAgKgogICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBleGVjdXRlIHRoZSBmdW5jdGlvbiB3aXRoIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAqLwogICAgICAkYXBwbHlBc3luYzogZnVuY3Rpb24oZXhwcikgewogICAgICAgIHZhciBzY29wZSA9IHRoaXM7CiAgICAgICAgZXhwciAmJiBhcHBseUFzeW5jUXVldWUucHVzaCgkYXBwbHlBc3luY0V4cHJlc3Npb24pOwogICAgICAgIHNjaGVkdWxlQXBwbHlBc3luYygpOwoKICAgICAgICBmdW5jdGlvbiAkYXBwbHlBc3luY0V4cHJlc3Npb24oKSB7CiAgICAgICAgICBzY29wZS4kZXZhbChleHByKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRvbgogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogTGlzdGVucyBvbiBldmVudHMgb2YgYSBnaXZlbiB0eXBlLiBTZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGVtaXQgJGVtaXR9IGZvcgogICAgICAgKiBkaXNjdXNzaW9uIG9mIGV2ZW50IGxpZmUgY3ljbGUuCiAgICAgICAqCiAgICAgICAqIFRoZSBldmVudCBsaXN0ZW5lciBmdW5jdGlvbiBmb3JtYXQgaXM6IGBmdW5jdGlvbihldmVudCwgYXJncy4uLilgLiBUaGUgYGV2ZW50YCBvYmplY3QKICAgICAgICogcGFzc2VkIGludG8gdGhlIGxpc3RlbmVyIGhhcyB0aGUgZm9sbG93aW5nIGF0dHJpYnV0ZXM6CiAgICAgICAqCiAgICAgICAqICAgLSBgdGFyZ2V0U2NvcGVgIC0gYHtTY29wZX1gOiB0aGUgc2NvcGUgb24gd2hpY2ggdGhlIGV2ZW50IHdhcyBgJGVtaXRgLWVkIG9yCiAgICAgICAqICAgICBgJGJyb2FkY2FzdGAtZWQuCiAgICAgICAqICAgLSBgY3VycmVudFNjb3BlYCAtIGB7U2NvcGV9YDogdGhlIHNjb3BlIHRoYXQgaXMgY3VycmVudGx5IGhhbmRsaW5nIHRoZSBldmVudC4gT25jZSB0aGUKICAgICAgICogICAgIGV2ZW50IHByb3BhZ2F0ZXMgdGhyb3VnaCB0aGUgc2NvcGUgaGllcmFyY2h5LCB0aGlzIHByb3BlcnR5IGlzIHNldCB0byBudWxsLgogICAgICAgKiAgIC0gYG5hbWVgIC0gYHtzdHJpbmd9YDogbmFtZSBvZiB0aGUgZXZlbnQuCiAgICAgICAqICAgLSBgc3RvcFByb3BhZ2F0aW9uYCAtIGB7ZnVuY3Rpb249fWA6IGNhbGxpbmcgYHN0b3BQcm9wYWdhdGlvbmAgZnVuY3Rpb24gd2lsbCBjYW5jZWwKICAgICAgICogICAgIGZ1cnRoZXIgZXZlbnQgcHJvcGFnYXRpb24gKGF2YWlsYWJsZSBvbmx5IGZvciBldmVudHMgdGhhdCB3ZXJlIGAkZW1pdGAtZWQpLgogICAgICAgKiAgIC0gYHByZXZlbnREZWZhdWx0YCAtIGB7ZnVuY3Rpb259YDogY2FsbGluZyBgcHJldmVudERlZmF1bHRgIHNldHMgYGRlZmF1bHRQcmV2ZW50ZWRgIGZsYWcKICAgICAgICogICAgIHRvIHRydWUuCiAgICAgICAqICAgLSBgZGVmYXVsdFByZXZlbnRlZGAgLSBge2Jvb2xlYW59YDogdHJ1ZSBpZiBgcHJldmVudERlZmF1bHRgIHdhcyBjYWxsZWQuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEV2ZW50IG5hbWUgdG8gbGlzdGVuIG9uLgogICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50LCAuLi5hcmdzKX0gbGlzdGVuZXIgRnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBldmVudCBpcyBlbWl0dGVkLgogICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gUmV0dXJucyBhIGRlcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGZvciB0aGlzIGxpc3RlbmVyLgogICAgICAgKi8KICAgICAgJG9uOiBmdW5jdGlvbihuYW1lLCBsaXN0ZW5lcikgewogICAgICAgIHZhciBuYW1lZExpc3RlbmVycyA9IHRoaXMuJCRsaXN0ZW5lcnNbbmFtZV07CiAgICAgICAgaWYgKCFuYW1lZExpc3RlbmVycykgewogICAgICAgICAgdGhpcy4kJGxpc3RlbmVyc1tuYW1lXSA9IG5hbWVkTGlzdGVuZXJzID0gW107CiAgICAgICAgfQogICAgICAgIG5hbWVkTGlzdGVuZXJzLnB1c2gobGlzdGVuZXIpOwoKICAgICAgICB2YXIgY3VycmVudCA9IHRoaXM7CiAgICAgICAgZG8gewogICAgICAgICAgaWYgKCFjdXJyZW50LiQkbGlzdGVuZXJDb3VudFtuYW1lXSkgewogICAgICAgICAgICBjdXJyZW50LiQkbGlzdGVuZXJDb3VudFtuYW1lXSA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50LiQkbGlzdGVuZXJDb3VudFtuYW1lXSsrOwogICAgICAgIH0gd2hpbGUgKChjdXJyZW50ID0gY3VycmVudC4kcGFyZW50KSk7CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICBuYW1lZExpc3RlbmVyc1tuYW1lZExpc3RlbmVycy5pbmRleE9mKGxpc3RlbmVyKV0gPSBudWxsOwogICAgICAgICAgZGVjcmVtZW50TGlzdGVuZXJDb3VudChzZWxmLCAxLCBuYW1lKTsKICAgICAgICB9OwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGVtaXQKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIERpc3BhdGNoZXMgYW4gZXZlbnQgYG5hbWVgIHVwd2FyZHMgdGhyb3VnaCB0aGUgc2NvcGUgaGllcmFyY2h5IG5vdGlmeWluZyB0aGUKICAgICAgICogcmVnaXN0ZXJlZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGxpc3RlbmVycy4KICAgICAgICoKICAgICAgICogVGhlIGV2ZW50IGxpZmUgY3ljbGUgc3RhcnRzIGF0IHRoZSBzY29wZSBvbiB3aGljaCBgJGVtaXRgIHdhcyBjYWxsZWQuIEFsbAogICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSBsaXN0ZW5pbmcgZm9yIGBuYW1lYCBldmVudCBvbiB0aGlzIHNjb3BlIGdldAogICAgICAgKiBub3RpZmllZC4gQWZ0ZXJ3YXJkcywgdGhlIGV2ZW50IHRyYXZlcnNlcyB1cHdhcmRzIHRvd2FyZCB0aGUgcm9vdCBzY29wZSBhbmQgY2FsbHMgYWxsCiAgICAgICAqIHJlZ2lzdGVyZWQgbGlzdGVuZXJzIGFsb25nIHRoZSB3YXkuIFRoZSBldmVudCB3aWxsIHN0b3AgcHJvcGFnYXRpbmcgaWYgb25lIG9mIHRoZSBsaXN0ZW5lcnMKICAgICAgICogY2FuY2VscyBpdC4KICAgICAgICoKICAgICAgICogQW55IGV4Y2VwdGlvbiBlbWl0dGVkIGZyb20gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IHdpbGwgYmUgcGFzc2VkCiAgICAgICAqIG9udG8gdGhlIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBlbWl0LgogICAgICAgKiBAcGFyYW0gey4uLip9IGFyZ3MgT3B0aW9uYWwgb25lIG9yIG1vcmUgYXJndW1lbnRzIHdoaWNoIHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICAgICogQHJldHVybiB7T2JqZWN0fSBFdmVudCBvYmplY3QgKHNlZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259KS4KICAgICAgICovCiAgICAgICRlbWl0OiBmdW5jdGlvbihuYW1lLCBhcmdzKSB7CiAgICAgICAgdmFyIGVtcHR5ID0gW10sCiAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzLAogICAgICAgICAgICBzY29wZSA9IHRoaXMsCiAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbiA9IGZhbHNlLAogICAgICAgICAgICBldmVudCA9IHsKICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgIHRhcmdldFNjb3BlOiBzY29wZSwKICAgICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkge3N0b3BQcm9wYWdhdGlvbiA9IHRydWU7fSwKICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQ6IGZhbHNlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGxpc3RlbmVyQXJncyA9IGNvbmNhdChbZXZlbnRdLCBhcmd1bWVudHMsIDEpLAogICAgICAgICAgICBpLCBsZW5ndGg7CgogICAgICAgIGRvIHsKICAgICAgICAgIG5hbWVkTGlzdGVuZXJzID0gc2NvcGUuJCRsaXN0ZW5lcnNbbmFtZV0gfHwgZW1wdHk7CiAgICAgICAgICBldmVudC5jdXJyZW50U2NvcGUgPSBzY29wZTsKICAgICAgICAgIGZvciAoaT0wLCBsZW5ndGg9bmFtZWRMaXN0ZW5lcnMubGVuZ3RoOyBpPGxlbmd0aDsgaSsrKSB7CgogICAgICAgICAgICAvLyBpZiBsaXN0ZW5lcnMgd2VyZSBkZXJlZ2lzdGVyZWQsIGRlZnJhZ21lbnQgdGhlIGFycmF5CiAgICAgICAgICAgIGlmICghbmFtZWRMaXN0ZW5lcnNbaV0pIHsKICAgICAgICAgICAgICBuYW1lZExpc3RlbmVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgIGxlbmd0aC0tOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgLy9hbGxvdyBhbGwgbGlzdGVuZXJzIGF0dGFjaGVkIHRvIHRoZSBjdXJyZW50IHNjb3BlIHRvIHJ1bgogICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzW2ldLmFwcGx5KG51bGwsIGxpc3RlbmVyQXJncyk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy9pZiBhbnkgbGlzdGVuZXIgb24gdGhlIGN1cnJlbnQgc2NvcGUgc3RvcHMgcHJvcGFnYXRpb24sIHByZXZlbnQgYnViYmxpbmcKICAgICAgICAgIGlmIChzdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgZXZlbnQuY3VycmVudFNjb3BlID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICAgICAgfQogICAgICAgICAgLy90cmF2ZXJzZSB1cHdhcmRzCiAgICAgICAgICBzY29wZSA9IHNjb3BlLiRwYXJlbnQ7CiAgICAgICAgfSB3aGlsZSAoc2NvcGUpOwoKICAgICAgICBldmVudC5jdXJyZW50U2NvcGUgPSBudWxsOwoKICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkYnJvYWRjYXN0CiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBEaXNwYXRjaGVzIGFuIGV2ZW50IGBuYW1lYCBkb3dud2FyZHMgdG8gYWxsIGNoaWxkIHNjb3BlcyAoYW5kIHRoZWlyIGNoaWxkcmVuKSBub3RpZnlpbmcgdGhlCiAgICAgICAqIHJlZ2lzdGVyZWQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufSBsaXN0ZW5lcnMuCiAgICAgICAqCiAgICAgICAqIFRoZSBldmVudCBsaWZlIGN5Y2xlIHN0YXJ0cyBhdCB0aGUgc2NvcGUgb24gd2hpY2ggYCRicm9hZGNhc3RgIHdhcyBjYWxsZWQuIEFsbAogICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSBsaXN0ZW5pbmcgZm9yIGBuYW1lYCBldmVudCBvbiB0aGlzIHNjb3BlIGdldAogICAgICAgKiBub3RpZmllZC4gQWZ0ZXJ3YXJkcywgdGhlIGV2ZW50IHByb3BhZ2F0ZXMgdG8gYWxsIGRpcmVjdCBhbmQgaW5kaXJlY3Qgc2NvcGVzIG9mIHRoZSBjdXJyZW50CiAgICAgICAqIHNjb3BlIGFuZCBjYWxscyBhbGwgcmVnaXN0ZXJlZCBsaXN0ZW5lcnMgYWxvbmcgdGhlIHdheS4gVGhlIGV2ZW50IGNhbm5vdCBiZSBjYW5jZWxlZC4KICAgICAgICoKICAgICAgICogQW55IGV4Y2VwdGlvbiBlbWl0dGVkIGZyb20gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IHdpbGwgYmUgcGFzc2VkCiAgICAgICAqIG9udG8gdGhlIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBicm9hZGNhc3QuCiAgICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBvbmUgb3IgbW9yZSBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEV2ZW50IG9iamVjdCwgc2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0KICAgICAgICovCiAgICAgICRicm9hZGNhc3Q6IGZ1bmN0aW9uKG5hbWUsIGFyZ3MpIHsKICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcywKICAgICAgICAgICAgY3VycmVudCA9IHRhcmdldCwKICAgICAgICAgICAgbmV4dCA9IHRhcmdldCwKICAgICAgICAgICAgZXZlbnQgPSB7CiAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICB0YXJnZXRTY29wZTogdGFyZ2V0LAogICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgfTsKCiAgICAgICAgaWYgKCF0YXJnZXQuJCRsaXN0ZW5lckNvdW50W25hbWVdKSByZXR1cm4gZXZlbnQ7CgogICAgICAgIHZhciBsaXN0ZW5lckFyZ3MgPSBjb25jYXQoW2V2ZW50XSwgYXJndW1lbnRzLCAxKSwKICAgICAgICAgICAgbGlzdGVuZXJzLCBpLCBsZW5ndGg7CgogICAgICAgIC8vZG93biB3aGlsZSB5b3UgY2FuLCB0aGVuIHVwIGFuZCBuZXh0IHNpYmxpbmcgb3IgdXAgYW5kIG5leHQgc2libGluZyB1bnRpbCBiYWNrIGF0IHJvb3QKICAgICAgICB3aGlsZSAoKGN1cnJlbnQgPSBuZXh0KSkgewogICAgICAgICAgZXZlbnQuY3VycmVudFNjb3BlID0gY3VycmVudDsKICAgICAgICAgIGxpc3RlbmVycyA9IGN1cnJlbnQuJCRsaXN0ZW5lcnNbbmFtZV0gfHwgW107CiAgICAgICAgICBmb3IgKGk9MCwgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsgaTxsZW5ndGg7IGkrKykgewogICAgICAgICAgICAvLyBpZiBsaXN0ZW5lcnMgd2VyZSBkZXJlZ2lzdGVyZWQsIGRlZnJhZ21lbnQgdGhlIGFycmF5CiAgICAgICAgICAgIGlmICghbGlzdGVuZXJzW2ldKSB7CiAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgbGVuZ3RoLS07CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmFwcGx5KG51bGwsIGxpc3RlbmVyQXJncyk7CiAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gSW5zYW5pdHkgV2FybmluZzogc2NvcGUgZGVwdGgtZmlyc3QgdHJhdmVyc2FsCiAgICAgICAgICAvLyB5ZXMsIHRoaXMgY29kZSBpcyBhIGJpdCBjcmF6eSwgYnV0IGl0IHdvcmtzIGFuZCB3ZSBoYXZlIHRlc3RzIHRvIHByb3ZlIGl0IQogICAgICAgICAgLy8gdGhpcyBwaWVjZSBzaG91bGQgYmUga2VwdCBpbiBzeW5jIHdpdGggdGhlIHRyYXZlcnNhbCBpbiAkZGlnZXN0CiAgICAgICAgICAvLyAodGhvdWdoIGl0IGRpZmZlcnMgZHVlIHRvIGhhdmluZyB0aGUgZXh0cmEgY2hlY2sgZm9yICQkbGlzdGVuZXJDb3VudCkKICAgICAgICAgIGlmICghKG5leHQgPSAoKGN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdICYmIGN1cnJlbnQuJCRjaGlsZEhlYWQpIHx8CiAgICAgICAgICAgICAgKGN1cnJlbnQgIT09IHRhcmdldCAmJiBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSkpIHsKICAgICAgICAgICAgd2hpbGUoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC4kcGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBldmVudC5jdXJyZW50U2NvcGUgPSBudWxsOwogICAgICAgIHJldHVybiBldmVudDsKICAgICAgfQogICAgfTsKCiAgICB2YXIgJHJvb3RTY29wZSA9IG5ldyBTY29wZSgpOwoKICAgIC8vVGhlIGludGVybmFsIHF1ZXVlcy4gRXhwb3NlIHRoZW0gb24gdGhlICRyb290U2NvcGUgZm9yIGRlYnVnZ2luZy90ZXN0aW5nIHB1cnBvc2VzLgogICAgdmFyIGFzeW5jUXVldWUgPSAkcm9vdFNjb3BlLiQkYXN5bmNRdWV1ZSA9IFtdOwogICAgdmFyIHBvc3REaWdlc3RRdWV1ZSA9ICRyb290U2NvcGUuJCRwb3N0RGlnZXN0UXVldWUgPSBbXTsKICAgIHZhciBhcHBseUFzeW5jUXVldWUgPSAkcm9vdFNjb3BlLiQkYXBwbHlBc3luY1F1ZXVlID0gW107CgogICAgcmV0dXJuICRyb290U2NvcGU7CgoKICAgIGZ1bmN0aW9uIGJlZ2luUGhhc2UocGhhc2UpIHsKICAgICAgaWYgKCRyb290U2NvcGUuJCRwaGFzZSkgewogICAgICAgIHRocm93ICRyb290U2NvcGVNaW5FcnIoJ2lucHJvZycsICd7MH0gYWxyZWFkeSBpbiBwcm9ncmVzcycsICRyb290U2NvcGUuJCRwaGFzZSk7CiAgICAgIH0KCiAgICAgICRyb290U2NvcGUuJCRwaGFzZSA9IHBoYXNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsZWFyUGhhc2UoKSB7CiAgICAgICRyb290U2NvcGUuJCRwaGFzZSA9IG51bGw7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGRlY3JlbWVudExpc3RlbmVyQ291bnQoY3VycmVudCwgY291bnQsIG5hbWUpIHsKICAgICAgZG8gewogICAgICAgIGN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdIC09IGNvdW50OwoKICAgICAgICBpZiAoY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV0gPT09IDApIHsKICAgICAgICAgIGRlbGV0ZSBjdXJyZW50LiQkbGlzdGVuZXJDb3VudFtuYW1lXTsKICAgICAgICB9CiAgICAgIH0gd2hpbGUgKChjdXJyZW50ID0gY3VycmVudC4kcGFyZW50KSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBmdW5jdGlvbiB1c2VkIGFzIGFuIGluaXRpYWwgdmFsdWUgZm9yIHdhdGNoZXJzLgogICAgICogYmVjYXVzZSBpdCdzIHVuaXF1ZSB3ZSBjYW4gZWFzaWx5IHRlbGwgaXQgYXBhcnQgZnJvbSBvdGhlciB2YWx1ZXMKICAgICAqLwogICAgZnVuY3Rpb24gaW5pdFdhdGNoVmFsKCkge30KCiAgICBmdW5jdGlvbiBmbHVzaEFwcGx5QXN5bmMoKSB7CiAgICAgIHdoaWxlIChhcHBseUFzeW5jUXVldWUubGVuZ3RoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGFwcGx5QXN5bmNRdWV1ZS5zaGlmdCgpKCk7CiAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYXBwbHlBc3luY0lkID0gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBzY2hlZHVsZUFwcGx5QXN5bmMoKSB7CiAgICAgIGlmIChhcHBseUFzeW5jSWQgPT09IG51bGwpIHsKICAgICAgICBhcHBseUFzeW5jSWQgPSAkYnJvd3Nlci5kZWZlcihmdW5jdGlvbigpIHsKICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5KGZsdXNoQXBwbHlBc3luYyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9XTsKfQoKLyoqCiAqIEBkZXNjcmlwdGlvbgogKiBQcml2YXRlIHNlcnZpY2UgdG8gc2FuaXRpemUgdXJpcyBmb3IgbGlua3MgYW5kIGltYWdlcy4gVXNlZCBieSAkY29tcGlsZSBhbmQgJHNhbml0aXplLgogKi8KZnVuY3Rpb24gJCRTYW5pdGl6ZVVyaVByb3ZpZGVyKCkgewogIHZhciBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCA9IC9eXHMqKGh0dHBzP3xmdHB8bWFpbHRvfHRlbHxmaWxlKTovLAogICAgaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gL15ccyooKGh0dHBzP3xmdHB8ZmlsZXxibG9iKTp8ZGF0YTppbWFnZVwvKS87CgogIC8qKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJldHJpZXZlcyBvciBvdmVycmlkZXMgdGhlIGRlZmF1bHQgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgdXNlZCBmb3Igd2hpdGVsaXN0aW5nIG9mIHNhZmUKICAgKiB1cmxzIGR1cmluZyBhW2hyZWZdIHNhbml0aXphdGlvbi4KICAgKgogICAqIFRoZSBzYW5pdGl6YXRpb24gaXMgYSBzZWN1cml0eSBtZWFzdXJlIGFpbWVkIGF0IHByZXZlbnQgWFNTIGF0dGFja3MgdmlhIGh0bWwgbGlua3MuCiAgICoKICAgKiBBbnkgdXJsIGFib3V0IHRvIGJlIGFzc2lnbmVkIHRvIGFbaHJlZl0gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50bwogICAqIGFuIGFic29sdXRlIHVybC4gQWZ0ZXJ3YXJkcywgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdGAKICAgKiByZWd1bGFyIGV4cHJlc3Npb24uIElmIGEgbWF0Y2ggaXMgZm91bmQsIHRoZSBvcmlnaW5hbCB1cmwgaXMgd3JpdHRlbiBpbnRvIHRoZSBkb20uIE90aGVyd2lzZSwKICAgKiB0aGUgYWJzb2x1dGUgdXJsIGlzIHByZWZpeGVkIHdpdGggYCd1bnNhZmU6J2Agc3RyaW5nIGFuZCBvbmx5IHRoZW4gaXMgaXQgd3JpdHRlbiBpbnRvIHRoZSBET00uCiAgICoKICAgKiBAcGFyYW0ge1JlZ0V4cD19IHJlZ2V4cCBOZXcgcmVnZXhwIHRvIHdoaXRlbGlzdCB1cmxzIHdpdGguCiAgICogQHJldHVybnMge1JlZ0V4cHxuZy4kY29tcGlsZVByb3ZpZGVyfSBDdXJyZW50IFJlZ0V4cCBpZiBjYWxsZWQgd2l0aG91dCB2YWx1ZSBvciBzZWxmIGZvcgogICAqICAgIGNoYWluaW5nIG90aGVyd2lzZS4KICAgKi8KICB0aGlzLmFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gZnVuY3Rpb24ocmVnZXhwKSB7CiAgICBpZiAoaXNEZWZpbmVkKHJlZ2V4cCkpIHsKICAgICAgYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSByZWdleHA7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgcmV0dXJuIGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0OwogIH07CgoKICAvKioKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZXRyaWV2ZXMgb3Igb3ZlcnJpZGVzIHRoZSBkZWZhdWx0IHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgZm9yIHdoaXRlbGlzdGluZyBvZiBzYWZlCiAgICogdXJscyBkdXJpbmcgaW1nW3NyY10gc2FuaXRpemF0aW9uLgogICAqCiAgICogVGhlIHNhbml0aXphdGlvbiBpcyBhIHNlY3VyaXR5IG1lYXN1cmUgYWltZWQgYXQgcHJldmVudCBYU1MgYXR0YWNrcyB2aWEgaHRtbCBsaW5rcy4KICAgKgogICAqIEFueSB1cmwgYWJvdXQgdG8gYmUgYXNzaWduZWQgdG8gaW1nW3NyY10gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50bwogICAqIGFuIGFic29sdXRlIHVybC4gQWZ0ZXJ3YXJkcywgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3RgCiAgICogcmVndWxhciBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kLCB0aGUgb3JpZ2luYWwgdXJsIGlzIHdyaXR0ZW4gaW50byB0aGUgZG9tLiBPdGhlcndpc2UsCiAgICogdGhlIGFic29sdXRlIHVybCBpcyBwcmVmaXhlZCB3aXRoIGAndW5zYWZlOidgIHN0cmluZyBhbmQgb25seSB0aGVuIGlzIGl0IHdyaXR0ZW4gaW50byB0aGUgRE9NLgogICAqCiAgICogQHBhcmFtIHtSZWdFeHA9fSByZWdleHAgTmV3IHJlZ2V4cCB0byB3aGl0ZWxpc3QgdXJscyB3aXRoLgogICAqIEByZXR1cm5zIHtSZWdFeHB8bmcuJGNvbXBpbGVQcm92aWRlcn0gQ3VycmVudCBSZWdFeHAgaWYgY2FsbGVkIHdpdGhvdXQgdmFsdWUgb3Igc2VsZiBmb3IKICAgKiAgICBjaGFpbmluZyBvdGhlcndpc2UuCiAgICovCiAgdGhpcy5pbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSBmdW5jdGlvbihyZWdleHApIHsKICAgIGlmIChpc0RlZmluZWQocmVnZXhwKSkgewogICAgICBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSByZWdleHA7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgcmV0dXJuIGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdDsKICB9OwoKICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBmdW5jdGlvbiBzYW5pdGl6ZVVyaSh1cmksIGlzSW1hZ2UpIHsKICAgICAgdmFyIHJlZ2V4ID0gaXNJbWFnZSA/IGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCA6IGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0OwogICAgICB2YXIgbm9ybWFsaXplZFZhbDsKICAgICAgbm9ybWFsaXplZFZhbCA9IHVybFJlc29sdmUodXJpKS5ocmVmOwogICAgICBpZiAobm9ybWFsaXplZFZhbCAhPT0gJycgJiYgIW5vcm1hbGl6ZWRWYWwubWF0Y2gocmVnZXgpKSB7CiAgICAgICAgcmV0dXJuICd1bnNhZmU6Jytub3JtYWxpemVkVmFsOwogICAgICB9CiAgICAgIHJldHVybiB1cmk7CiAgICB9OwogIH07Cn0KCnZhciAkc2NlTWluRXJyID0gbWluRXJyKCckc2NlJyk7Cgp2YXIgU0NFX0NPTlRFWFRTID0gewogIEhUTUw6ICdodG1sJywKICBDU1M6ICdjc3MnLAogIFVSTDogJ3VybCcsCiAgLy8gUkVTT1VSQ0VfVVJMIGlzIGEgc3VidHlwZSBvZiBVUkwgdXNlZCBpbiBjb250ZXh0cyB3aGVyZSBhIHByaXZpbGVnZWQgcmVzb3VyY2UgaXMgc291cmNlZCBmcm9tIGEKICAvLyB1cmwuICAoZS5nLiBuZy1pbmNsdWRlLCBzY3JpcHQgc3JjLCB0ZW1wbGF0ZVVybCkKICBSRVNPVVJDRV9VUkw6ICdyZXNvdXJjZVVybCcsCiAgSlM6ICdqcycKfTsKCi8vIEhlbHBlciBmdW5jdGlvbnMgZm9sbG93LgoKLy8gQ29waWVkIGZyb206Ci8vIGh0dHA6Ly9kb2NzLmNsb3N1cmUtbGlicmFyeS5nb29nbGVjb2RlLmNvbS9naXQvY2xvc3VyZV9nb29nX3N0cmluZ19zdHJpbmcuanMuc291cmNlLmh0bWwjbGluZTk2MgovLyBQcmVyZXE6IHMgaXMgYSBzdHJpbmcuCmZ1bmN0aW9uIGVzY2FwZUZvclJlZ2V4cChzKSB7CiAgcmV0dXJuIHMucmVwbGFjZSgvKFstKClcW1xde30rPyouJFxefCw6IzwhXFxdKS9nLCAnXFwkMScpLgogICAgICAgICAgIHJlcGxhY2UoL1x4MDgvZywgJ1xceDA4Jyk7Cn0KCgpmdW5jdGlvbiBhZGp1c3RNYXRjaGVyKG1hdGNoZXIpIHsKICBpZiAobWF0Y2hlciA9PT0gJ3NlbGYnKSB7CiAgICByZXR1cm4gbWF0Y2hlcjsKICB9IGVsc2UgaWYgKGlzU3RyaW5nKG1hdGNoZXIpKSB7CiAgICAvLyBTdHJpbmdzIG1hdGNoIGV4YWN0bHkgZXhjZXB0IGZvciAyIHdpbGRjYXJkcyAtICcqJyBhbmQgJyoqJy4KICAgIC8vICcqJyBtYXRjaGVzIGFueSBjaGFyYWN0ZXIgZXhjZXB0IHRob3NlIGZyb20gdGhlIHNldCAnOi8uPyYnLgogICAgLy8gJyoqJyBtYXRjaGVzIGFueSBjaGFyYWN0ZXIgKGxpa2UgLiogaW4gYSBSZWdFeHApLgogICAgLy8gTW9yZSB0aGFuIDIgKidzIHJhaXNlcyBhbiBlcnJvciBhcyBpdCdzIGlsbCBkZWZpbmVkLgogICAgaWYgKG1hdGNoZXIuaW5kZXhPZignKioqJykgPiAtMSkgewogICAgICB0aHJvdyAkc2NlTWluRXJyKCdpd2NhcmQnLAogICAgICAgICAgJ0lsbGVnYWwgc2VxdWVuY2UgKioqIGluIHN0cmluZyBtYXRjaGVyLiAgU3RyaW5nOiB7MH0nLCBtYXRjaGVyKTsKICAgIH0KICAgIG1hdGNoZXIgPSBlc2NhcGVGb3JSZWdleHAobWF0Y2hlcikuCiAgICAgICAgICAgICAgICAgIHJlcGxhY2UoJ1xcKlxcKicsICcuKicpLgogICAgICAgICAgICAgICAgICByZXBsYWNlKCdcXConLCAnW146Ly4/JjtdKicpOwogICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgbWF0Y2hlciArICckJyk7CiAgfSBlbHNlIGlmIChpc1JlZ0V4cChtYXRjaGVyKSkgewogICAgLy8gVGhlIG9ubHkgb3RoZXIgdHlwZSBvZiBtYXRjaGVyIGFsbG93ZWQgaXMgYSBSZWdleHAuCiAgICAvLyBNYXRjaCBlbnRpcmUgVVJMIC8gZGlzYWxsb3cgcGFydGlhbCBtYXRjaGVzLgogICAgLy8gRmxhZ3MgYXJlIHJlc2V0IChpLmUuIG5vIGdsb2JhbCwgaWdub3JlQ2FzZSBvciBtdWx0aWxpbmUpCiAgICByZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyBtYXRjaGVyLnNvdXJjZSArICckJyk7CiAgfSBlbHNlIHsKICAgIHRocm93ICRzY2VNaW5FcnIoJ2ltYXRjaGVyJywKICAgICAgICAnTWF0Y2hlcnMgbWF5IG9ubHkgYmUgInNlbGYiLCBzdHJpbmcgcGF0dGVybnMgb3IgUmVnRXhwIG9iamVjdHMnKTsKICB9Cn0KCgpmdW5jdGlvbiBhZGp1c3RNYXRjaGVycyhtYXRjaGVycykgewogIHZhciBhZGp1c3RlZE1hdGNoZXJzID0gW107CiAgaWYgKGlzRGVmaW5lZChtYXRjaGVycykpIHsKICAgIGZvckVhY2gobWF0Y2hlcnMsIGZ1bmN0aW9uKG1hdGNoZXIpIHsKICAgICAgYWRqdXN0ZWRNYXRjaGVycy5wdXNoKGFkanVzdE1hdGNoZXIobWF0Y2hlcikpOwogICAgfSk7CiAgfQogIHJldHVybiBhZGp1c3RlZE1hdGNoZXJzOwp9CgoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRzY2VEZWxlZ2F0ZQogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICoKICogYCRzY2VEZWxlZ2F0ZWAgaXMgYSBzZXJ2aWNlIHRoYXQgaXMgdXNlZCBieSB0aGUgYCRzY2VgIHNlcnZpY2UgdG8gcHJvdmlkZSB7QGxpbmsgbmcuJHNjZSBTdHJpY3QKICogQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKX0gc2VydmljZXMgdG8gQW5ndWxhckpTLgogKgogKiBUeXBpY2FsbHksIHlvdSB3b3VsZCBjb25maWd1cmUgb3Igb3ZlcnJpZGUgdGhlIHtAbGluayBuZy4kc2NlRGVsZWdhdGUgJHNjZURlbGVnYXRlfSBpbnN0ZWFkIG9mCiAqIHRoZSBgJHNjZWAgc2VydmljZSB0byBjdXN0b21pemUgdGhlIHdheSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyB3b3JrcyBpbiBBbmd1bGFySlMuICBUaGlzIGlzCiAqIGJlY2F1c2UsIHdoaWxlIHRoZSBgJHNjZWAgcHJvdmlkZXMgbnVtZXJvdXMgc2hvcnRoYW5kIG1ldGhvZHMsIGV0Yy4sIHlvdSByZWFsbHkgb25seSBuZWVkIHRvCiAqIG92ZXJyaWRlIDMgY29yZSBmdW5jdGlvbnMgKGB0cnVzdEFzYCwgYGdldFRydXN0ZWRgIGFuZCBgdmFsdWVPZmApIHRvIHJlcGxhY2UgdGhlIHdheSB0aGluZ3MKICogd29yayBiZWNhdXNlIGAkc2NlYCBkZWxlZ2F0ZXMgdG8gYCRzY2VEZWxlZ2F0ZWAgZm9yIHRoZXNlIG9wZXJhdGlvbnMuCiAqCiAqIFJlZmVyIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciAkc2NlRGVsZWdhdGVQcm92aWRlcn0gdG8gY29uZmlndXJlIHRoaXMgc2VydmljZS4KICoKICogVGhlIGRlZmF1bHQgaW5zdGFuY2Ugb2YgYCRzY2VEZWxlZ2F0ZWAgc2hvdWxkIHdvcmsgb3V0IG9mIHRoZSBib3ggd2l0aCBsaXR0bGUgcGFpbi4gIFdoaWxlIHlvdQogKiBjYW4gb3ZlcnJpZGUgaXQgY29tcGxldGVseSB0byBjaGFuZ2UgdGhlIGJlaGF2aW9yIG9mIGAkc2NlYCwgdGhlIGNvbW1vbiBjYXNlIHdvdWxkCiAqIGludm9sdmUgY29uZmlndXJpbmcgdGhlIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciAkc2NlRGVsZWdhdGVQcm92aWRlcn0gaW5zdGVhZCBieSBzZXR0aW5nCiAqIHlvdXIgb3duIHdoaXRlbGlzdHMgYW5kIGJsYWNrbGlzdHMgZm9yIHRydXN0aW5nIFVSTHMgdXNlZCBmb3IgbG9hZGluZyBBbmd1bGFySlMgcmVzb3VyY2VzIHN1Y2ggYXMKICogdGVtcGxhdGVzLiAgUmVmZXIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0CiAqICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsV2hpdGVsaXN0fSBhbmQge0BsaW5rCiAqIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0ICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsQmxhY2tsaXN0fQogKi8KCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJHNjZURlbGVnYXRlUHJvdmlkZXIKICogQGRlc2NyaXB0aW9uCiAqCiAqIFRoZSBgJHNjZURlbGVnYXRlUHJvdmlkZXJgIHByb3ZpZGVyIGFsbG93cyBkZXZlbG9wZXJzIHRvIGNvbmZpZ3VyZSB0aGUge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZQogKiAkc2NlRGVsZWdhdGV9IHNlcnZpY2UuICBUaGlzIGFsbG93cyBvbmUgdG8gZ2V0L3NldCB0aGUgd2hpdGVsaXN0cyBhbmQgYmxhY2tsaXN0cyB1c2VkIHRvIGVuc3VyZQogKiB0aGF0IHRoZSBVUkxzIHVzZWQgZm9yIHNvdXJjaW5nIEFuZ3VsYXIgdGVtcGxhdGVzIGFyZSBzYWZlLiAgUmVmZXIge0BsaW5rCiAqIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0ICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsV2hpdGVsaXN0fSBhbmQKICoge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0ICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsQmxhY2tsaXN0fQogKgogKiBGb3IgdGhlIGdlbmVyYWwgZGV0YWlscyBhYm91dCB0aGlzIHNlcnZpY2UgaW4gQW5ndWxhciwgcmVhZCB0aGUgbWFpbiBwYWdlIGZvciB7QGxpbmsgbmcuJHNjZQogKiBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKX0uCiAqCiAqICoqRXhhbXBsZSoqOiAgQ29uc2lkZXIgdGhlIGZvbGxvd2luZyBjYXNlLiA8YSBuYW1lPSJleGFtcGxlIj48L2E+CiAqCiAqIC0geW91ciBhcHAgaXMgaG9zdGVkIGF0IHVybCBgaHR0cDovL215YXBwLmV4YW1wbGUuY29tL2AKICogLSBidXQgc29tZSBvZiB5b3VyIHRlbXBsYXRlcyBhcmUgaG9zdGVkIG9uIG90aGVyIGRvbWFpbnMgeW91IGNvbnRyb2wgc3VjaCBhcwogKiAgIGBodHRwOi8vc3J2MDEuYXNzZXRzLmV4YW1wbGUuY29tL2AswqAgYGh0dHA6Ly9zcnYwMi5hc3NldHMuZXhhbXBsZS5jb20vYCwgZXRjLgogKiAtIGFuZCB5b3UgaGF2ZSBhbiBvcGVuIHJlZGlyZWN0IGF0IGBodHRwOi8vbXlhcHAuZXhhbXBsZS5jb20vY2xpY2tUaHJ1Py4uLmAuCiAqCiAqIEhlcmUgaXMgd2hhdCBhIHNlY3VyZSBjb25maWd1cmF0aW9uIGZvciB0aGlzIHNjZW5hcmlvIG1pZ2h0IGxvb2sgbGlrZToKICoKICogYGBgCiAqICBhbmd1bGFyLm1vZHVsZSgnbXlBcHAnLCBbXSkuY29uZmlnKGZ1bmN0aW9uKCRzY2VEZWxlZ2F0ZVByb3ZpZGVyKSB7CiAqICAgICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsV2hpdGVsaXN0KFsKICogICAgICAvLyBBbGxvdyBzYW1lIG9yaWdpbiByZXNvdXJjZSBsb2Fkcy4KICogICAgICAnc2VsZicsCiAqICAgICAgLy8gQWxsb3cgbG9hZGluZyBmcm9tIG91ciBhc3NldHMgZG9tYWluLiAgTm90aWNlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gKiBhbmQgKiouCiAqICAgICAgJ2h0dHA6Ly9zcnYqLmFzc2V0cy5leGFtcGxlLmNvbS8qKicKICogICAgXSk7CiAqCiAqICAgIC8vIFRoZSBibGFja2xpc3Qgb3ZlcnJpZGVzIHRoZSB3aGl0ZWxpc3Qgc28gdGhlIG9wZW4gcmVkaXJlY3QgaGVyZSBpcyBibG9ja2VkLgogKiAgICAkc2NlRGVsZWdhdGVQcm92aWRlci5yZXNvdXJjZVVybEJsYWNrbGlzdChbCiAqICAgICAgJ2h0dHA6Ly9teWFwcC5leGFtcGxlLmNvbS9jbGlja1RocnUqKicKICogICAgXSk7CiAqICB9KTsKICogYGBgCiAqLwoKZnVuY3Rpb24gJFNjZURlbGVnYXRlUHJvdmlkZXIoKSB7CiAgdGhpcy5TQ0VfQ09OVEVYVFMgPSBTQ0VfQ09OVEVYVFM7CgogIC8vIFJlc291cmNlIFVSTHMgY2FuIGFsc28gYmUgdHJ1c3RlZCBieSBwb2xpY3kuCiAgdmFyIHJlc291cmNlVXJsV2hpdGVsaXN0ID0gWydzZWxmJ10sCiAgICAgIHJlc291cmNlVXJsQmxhY2tsaXN0ID0gW107CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdAogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PX0gd2hpdGVsaXN0IFdoZW4gcHJvdmlkZWQsIHJlcGxhY2VzIHRoZSByZXNvdXJjZVVybFdoaXRlbGlzdCB3aXRoIHRoZSB2YWx1ZQogICAqICAgICBwcm92aWRlZC4gIFRoaXMgbXVzdCBiZSBhbiBhcnJheSBvciBudWxsLiAgQSBzbmFwc2hvdCBvZiB0aGlzIGFycmF5IGlzIHVzZWQgc28gZnVydGhlcgogICAqICAgICBjaGFuZ2VzIHRvIHRoZSBhcnJheSBhcmUgaWdub3JlZC4KICAgKgogICAqICAgICBGb2xsb3cge0BsaW5rIG5nLiRzY2UjcmVzb3VyY2VVcmxQYXR0ZXJuSXRlbSB0aGlzIGxpbmt9IGZvciBhIGRlc2NyaXB0aW9uIG9mIHRoZSBpdGVtcwogICAqICAgICBhbGxvd2VkIGluIHRoaXMgYXJyYXkuCiAgICoKICAgKiAgICAgTm90ZTogKiphbiBlbXB0eSB3aGl0ZWxpc3QgYXJyYXkgd2lsbCBibG9jayBhbGwgVVJMcyoqIQogICAqCiAgICogQHJldHVybiB7QXJyYXl9IHRoZSBjdXJyZW50bHkgc2V0IHdoaXRlbGlzdCBhcnJheS4KICAgKgogICAqIFRoZSAqKmRlZmF1bHQgdmFsdWUqKiB3aGVuIG5vIHdoaXRlbGlzdCBoYXMgYmVlbiBleHBsaWNpdGx5IHNldCBpcyBgWydzZWxmJ11gIGFsbG93aW5nIG9ubHkKICAgKiBzYW1lIG9yaWdpbiByZXNvdXJjZSByZXF1ZXN0cy4KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNldHMvR2V0cyB0aGUgd2hpdGVsaXN0IG9mIHRydXN0ZWQgcmVzb3VyY2UgVVJMcy4KICAgKi8KICB0aGlzLnJlc291cmNlVXJsV2hpdGVsaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICByZXNvdXJjZVVybFdoaXRlbGlzdCA9IGFkanVzdE1hdGNoZXJzKHZhbHVlKTsKICAgIH0KICAgIHJldHVybiByZXNvdXJjZVVybFdoaXRlbGlzdDsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQHBhcmFtIHtBcnJheT19IGJsYWNrbGlzdCBXaGVuIHByb3ZpZGVkLCByZXBsYWNlcyB0aGUgcmVzb3VyY2VVcmxCbGFja2xpc3Qgd2l0aCB0aGUgdmFsdWUKICAgKiAgICAgcHJvdmlkZWQuICBUaGlzIG11c3QgYmUgYW4gYXJyYXkgb3IgbnVsbC4gIEEgc25hcHNob3Qgb2YgdGhpcyBhcnJheSBpcyB1c2VkIHNvIGZ1cnRoZXIKICAgKiAgICAgY2hhbmdlcyB0byB0aGUgYXJyYXkgYXJlIGlnbm9yZWQuCiAgICoKICAgKiAgICAgRm9sbG93IHtAbGluayBuZy4kc2NlI3Jlc291cmNlVXJsUGF0dGVybkl0ZW0gdGhpcyBsaW5rfSBmb3IgYSBkZXNjcmlwdGlvbiBvZiB0aGUgaXRlbXMKICAgKiAgICAgYWxsb3dlZCBpbiB0aGlzIGFycmF5LgogICAqCiAgICogICAgIFRoZSB0eXBpY2FsIHVzYWdlIGZvciB0aGUgYmxhY2tsaXN0IGlzIHRvICoqYmxvY2sKICAgKiAgICAgW29wZW4gcmVkaXJlY3RzXShodHRwOi8vY3dlLm1pdHJlLm9yZy9kYXRhL2RlZmluaXRpb25zLzYwMS5odG1sKSoqIHNlcnZlZCBieSB5b3VyIGRvbWFpbiBhcwogICAqICAgICB0aGVzZSB3b3VsZCBvdGhlcndpc2UgYmUgdHJ1c3RlZCBidXQgYWN0dWFsbHkgcmV0dXJuIGNvbnRlbnQgZnJvbSB0aGUgcmVkaXJlY3RlZCBkb21haW4uCiAgICoKICAgKiAgICAgRmluYWxseSwgKip0aGUgYmxhY2tsaXN0IG92ZXJyaWRlcyB0aGUgd2hpdGVsaXN0KiogYW5kIGhhcyB0aGUgZmluYWwgc2F5LgogICAqCiAgICogQHJldHVybiB7QXJyYXl9IHRoZSBjdXJyZW50bHkgc2V0IGJsYWNrbGlzdCBhcnJheS4KICAgKgogICAqIFRoZSAqKmRlZmF1bHQgdmFsdWUqKiB3aGVuIG5vIHdoaXRlbGlzdCBoYXMgYmVlbiBleHBsaWNpdGx5IHNldCBpcyB0aGUgZW1wdHkgYXJyYXkgKGkuZS4gdGhlcmUKICAgKiBpcyBubyBibGFja2xpc3QuKQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cy9HZXRzIHRoZSBibGFja2xpc3Qgb2YgdHJ1c3RlZCByZXNvdXJjZSBVUkxzLgogICAqLwoKICB0aGlzLnJlc291cmNlVXJsQmxhY2tsaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICByZXNvdXJjZVVybEJsYWNrbGlzdCA9IGFkanVzdE1hdGNoZXJzKHZhbHVlKTsKICAgIH0KICAgIHJldHVybiByZXNvdXJjZVVybEJsYWNrbGlzdDsKICB9OwoKICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsIGZ1bmN0aW9uKCRpbmplY3RvcikgewoKICAgIHZhciBodG1sU2FuaXRpemVyID0gZnVuY3Rpb24gaHRtbFNhbml0aXplcihodG1sKSB7CiAgICAgIHRocm93ICRzY2VNaW5FcnIoJ3Vuc2FmZScsICdBdHRlbXB0aW5nIHRvIHVzZSBhbiB1bnNhZmUgdmFsdWUgaW4gYSBzYWZlIGNvbnRleHQuJyk7CiAgICB9OwoKICAgIGlmICgkaW5qZWN0b3IuaGFzKCckc2FuaXRpemUnKSkgewogICAgICBodG1sU2FuaXRpemVyID0gJGluamVjdG9yLmdldCgnJHNhbml0aXplJyk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIG1hdGNoVXJsKG1hdGNoZXIsIHBhcnNlZFVybCkgewogICAgICBpZiAobWF0Y2hlciA9PT0gJ3NlbGYnKSB7CiAgICAgICAgcmV0dXJuIHVybElzU2FtZU9yaWdpbihwYXJzZWRVcmwpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGRlZmluaXRlbHkgYSByZWdleC4gIFNlZSBhZGp1c3RNYXRjaGVycygpCiAgICAgICAgcmV0dXJuICEhbWF0Y2hlci5leGVjKHBhcnNlZFVybC5ocmVmKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGlzUmVzb3VyY2VVcmxBbGxvd2VkQnlQb2xpY3kodXJsKSB7CiAgICAgIHZhciBwYXJzZWRVcmwgPSB1cmxSZXNvbHZlKHVybC50b1N0cmluZygpKTsKICAgICAgdmFyIGksIG4sIGFsbG93ZWQgPSBmYWxzZTsKICAgICAgLy8gRW5zdXJlIHRoYXQgYXQgbGVhc3Qgb25lIGl0ZW0gZnJvbSB0aGUgd2hpdGVsaXN0IGFsbG93cyB0aGlzIHVybC4KICAgICAgZm9yIChpID0gMCwgbiA9IHJlc291cmNlVXJsV2hpdGVsaXN0Lmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICAgIGlmIChtYXRjaFVybChyZXNvdXJjZVVybFdoaXRlbGlzdFtpXSwgcGFyc2VkVXJsKSkgewogICAgICAgICAgYWxsb3dlZCA9IHRydWU7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGFsbG93ZWQpIHsKICAgICAgICAvLyBFbnN1cmUgdGhhdCBubyBpdGVtIGZyb20gdGhlIGJsYWNrbGlzdCBibG9ja2VkIHRoaXMgdXJsLgogICAgICAgIGZvciAoaSA9IDAsIG4gPSByZXNvdXJjZVVybEJsYWNrbGlzdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgICAgIGlmIChtYXRjaFVybChyZXNvdXJjZVVybEJsYWNrbGlzdFtpXSwgcGFyc2VkVXJsKSkgewogICAgICAgICAgICBhbGxvd2VkID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYWxsb3dlZDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZW5lcmF0ZUhvbGRlclR5cGUoQmFzZSkgewogICAgICB2YXIgaG9sZGVyVHlwZSA9IGZ1bmN0aW9uIFRydXN0ZWRWYWx1ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlKSB7CiAgICAgICAgdGhpcy4kJHVud3JhcFRydXN0ZWRWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHRydXN0ZWRWYWx1ZTsKICAgICAgICB9OwogICAgICB9OwogICAgICBpZiAoQmFzZSkgewogICAgICAgIGhvbGRlclR5cGUucHJvdG90eXBlID0gbmV3IEJhc2UoKTsKICAgICAgfQogICAgICBob2xkZXJUeXBlLnByb3RvdHlwZS52YWx1ZU9mID0gZnVuY3Rpb24gc2NlVmFsdWVPZigpIHsKICAgICAgICByZXR1cm4gdGhpcy4kJHVud3JhcFRydXN0ZWRWYWx1ZSgpOwogICAgICB9OwogICAgICBob2xkZXJUeXBlLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uIHNjZVRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLiQkdW53cmFwVHJ1c3RlZFZhbHVlKCkudG9TdHJpbmcoKTsKICAgICAgfTsKICAgICAgcmV0dXJuIGhvbGRlclR5cGU7CiAgICB9CgogICAgdmFyIHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UgPSBnZW5lcmF0ZUhvbGRlclR5cGUoKSwKICAgICAgICBieVR5cGUgPSB7fTsKCiAgICBieVR5cGVbU0NFX0NPTlRFWFRTLkhUTUxdID0gZ2VuZXJhdGVIb2xkZXJUeXBlKHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UpOwogICAgYnlUeXBlW1NDRV9DT05URVhUUy5DU1NdID0gZ2VuZXJhdGVIb2xkZXJUeXBlKHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UpOwogICAgYnlUeXBlW1NDRV9DT05URVhUUy5VUkxdID0gZ2VuZXJhdGVIb2xkZXJUeXBlKHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UpOwogICAgYnlUeXBlW1NDRV9DT05URVhUUy5KU10gPSBnZW5lcmF0ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSk7CiAgICBieVR5cGVbU0NFX0NPTlRFWFRTLlJFU09VUkNFX1VSTF0gPSBnZW5lcmF0ZUhvbGRlclR5cGUoYnlUeXBlW1NDRV9DT05URVhUUy5VUkxdKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2VEZWxlZ2F0ZSN0cnVzdEFzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGFuIG9iamVjdCB0aGF0IGlzIHRydXN0ZWQgYnkgYW5ndWxhciBmb3IgdXNlIGluIHNwZWNpZmllZCBzdHJpY3QKICAgICAqIGNvbnRleHR1YWwgZXNjYXBpbmcgY29udGV4dHMgKHN1Y2ggYXMgbmctYmluZC1odG1sLCBuZy1pbmNsdWRlLCBhbnkgc3JjCiAgICAgKiBhdHRyaWJ1dGUgaW50ZXJwb2xhdGlvbiwgYW55IGRvbSBldmVudCBiaW5kaW5nIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uCiAgICAgKiBzdWNoIGFzIGZvciBvbmNsaWNrLCAgZXRjLikgdGhhdCB1c2VzIHRoZSBwcm92aWRlZCB2YWx1ZS4KICAgICAqIFNlZSB7QGxpbmsgbmcuJHNjZSAkc2NlfSBmb3IgZW5hYmxpbmcgc3RyaWN0IGNvbnRleHR1YWwgZXNjYXBpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgY29udGV4dCBpbiB3aGljaCB0aGlzIHZhbHVlIGlzIHNhZmUgZm9yIHVzZS4gIGUuZy4gdXJsLAogICAgICogICByZXNvdXJjZVVybCwgaHRtbCwganMgYW5kIGNzcy4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRoYXQgdGhhdCBzaG91bGQgYmUgY29uc2lkZXJlZCB0cnVzdGVkL3NhZmUuCiAgICAgKiBAcmV0dXJucyB7Kn0gQSB2YWx1ZSB0aGF0IGNhbiBiZSB1c2VkIHRvIHN0YW5kIGluIGZvciB0aGUgcHJvdmlkZWQgYHZhbHVlYCBpbiBwbGFjZXMKICAgICAqIHdoZXJlIEFuZ3VsYXIgZXhwZWN0cyBhICRzY2UudHJ1c3RBcygpIHJldHVybiB2YWx1ZS4KICAgICAqLwogICAgZnVuY3Rpb24gdHJ1c3RBcyh0eXBlLCB0cnVzdGVkVmFsdWUpIHsKICAgICAgdmFyIENvbnN0cnVjdG9yID0gKGJ5VHlwZS5oYXNPd25Qcm9wZXJ0eSh0eXBlKSA/IGJ5VHlwZVt0eXBlXSA6IG51bGwpOwogICAgICBpZiAoIUNvbnN0cnVjdG9yKSB7CiAgICAgICAgdGhyb3cgJHNjZU1pbkVycignaWNvbnRleHQnLAogICAgICAgICAgICAnQXR0ZW1wdGVkIHRvIHRydXN0IGEgdmFsdWUgaW4gaW52YWxpZCBjb250ZXh0LiBDb250ZXh0OiB7MH07IFZhbHVlOiB7MX0nLAogICAgICAgICAgICB0eXBlLCB0cnVzdGVkVmFsdWUpOwogICAgICB9CiAgICAgIGlmICh0cnVzdGVkVmFsdWUgPT09IG51bGwgfHwgdHJ1c3RlZFZhbHVlID09PSB1bmRlZmluZWQgfHwgdHJ1c3RlZFZhbHVlID09PSAnJykgewogICAgICAgIHJldHVybiB0cnVzdGVkVmFsdWU7CiAgICAgIH0KICAgICAgLy8gQWxsIHRoZSBjdXJyZW50IGNvbnRleHRzIGluIFNDRV9DT05URVhUUyBoYXBwZW4gdG8gYmUgc3RyaW5ncy4gIEluIG9yZGVyIHRvIGF2b2lkIHRydXN0aW5nCiAgICAgIC8vIG11dGFibGUgb2JqZWN0cywgd2UgZW5zdXJlIGhlcmUgdGhhdCB0aGUgdmFsdWUgcGFzc2VkIGluIGlzIGFjdHVhbGx5IGEgc3RyaW5nLgogICAgICBpZiAodHlwZW9mIHRydXN0ZWRWYWx1ZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICB0aHJvdyAkc2NlTWluRXJyKCdpdHlwZScsCiAgICAgICAgICAgICdBdHRlbXB0ZWQgdG8gdHJ1c3QgYSBub24tc3RyaW5nIHZhbHVlIGluIGEgY29udGVudCByZXF1aXJpbmcgYSBzdHJpbmc6IENvbnRleHQ6IHswfScsCiAgICAgICAgICAgIHR5cGUpOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgQ29uc3RydWN0b3IodHJ1c3RlZFZhbHVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2VEZWxlZ2F0ZSN2YWx1ZU9mCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBJZiB0aGUgcGFzc2VkIHBhcmFtZXRlciBoYWQgYmVlbiByZXR1cm5lZCBieSBhIHByaW9yIGNhbGwgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzCiAgICAgKiBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSwgcmV0dXJucyB0aGUgdmFsdWUgdGhhdCBoYWQgYmVlbiBwYXNzZWQgdG8ge0BsaW5rCiAgICAgKiBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfS4KICAgICAqCiAgICAgKiBJZiB0aGUgcGFzc2VkIHBhcmFtZXRlciBpcyBub3QgYSB2YWx1ZSB0aGF0IGhhZCBiZWVuIHJldHVybmVkIGJ5IHtAbGluawogICAgICogbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0sIHJldHVybnMgaXQgYXMtaXMuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgcmVzdWx0IG9mIGEgcHJpb3Ige0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9CiAgICAgKiAgICAgIGNhbGwgb3IgYW55dGhpbmcgZWxzZS4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgYHZhbHVlYCB0aGF0IHdhcyBvcmlnaW5hbGx5IHByb3ZpZGVkIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcwogICAgICogICAgIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9IGlmIGB2YWx1ZWAgaXMgdGhlIHJlc3VsdCBvZiBzdWNoIGEgY2FsbC4gIE90aGVyd2lzZSwgcmV0dXJucwogICAgICogICAgIGB2YWx1ZWAgdW5jaGFuZ2VkLgogICAgICovCiAgICBmdW5jdGlvbiB2YWx1ZU9mKG1heWJlVHJ1c3RlZCkgewogICAgICBpZiAobWF5YmVUcnVzdGVkIGluc3RhbmNlb2YgdHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSkgewogICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQuJCR1bndyYXBUcnVzdGVkVmFsdWUoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbWF5YmVUcnVzdGVkOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGFrZXMgdGhlIHJlc3VsdCBvZiBhIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSBjYWxsIGFuZAogICAgICogcmV0dXJucyB0aGUgb3JpZ2luYWxseSBzdXBwbGllZCB2YWx1ZSBpZiB0aGUgcXVlcmllZCBjb250ZXh0IHR5cGUgaXMgYSBzdXBlcnR5cGUgb2YgdGhlCiAgICAgKiBjcmVhdGVkIHR5cGUuICBJZiB0aGlzIGNvbmRpdGlvbiBpc24ndCBzYXRpc2ZpZWQsIHRocm93cyBhbiBleGNlcHRpb24uCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgY29udGV4dCBpbiB3aGljaCB0aGlzIHZhbHVlIGlzIHRvIGJlIHVzZWQuCiAgICAgKiBAcGFyYW0geyp9IG1heWJlVHJ1c3RlZCBUaGUgcmVzdWx0IG9mIGEgcHJpb3Ige0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzCiAgICAgKiAgICAgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gY2FsbC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgdmFsdWUgdGhlIHdhcyBvcmlnaW5hbGx5IHByb3ZpZGVkIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcwogICAgICogICAgIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9IGlmIHZhbGlkIGluIHRoaXMgY29udGV4dC4gIE90aGVyd2lzZSwgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gZ2V0VHJ1c3RlZCh0eXBlLCBtYXliZVRydXN0ZWQpIHsKICAgICAgaWYgKG1heWJlVHJ1c3RlZCA9PT0gbnVsbCB8fCBtYXliZVRydXN0ZWQgPT09IHVuZGVmaW5lZCB8fCBtYXliZVRydXN0ZWQgPT09ICcnKSB7CiAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZDsKICAgICAgfQogICAgICB2YXIgY29uc3RydWN0b3IgPSAoYnlUeXBlLmhhc093blByb3BlcnR5KHR5cGUpID8gYnlUeXBlW3R5cGVdIDogbnVsbCk7CiAgICAgIGlmIChjb25zdHJ1Y3RvciAmJiBtYXliZVRydXN0ZWQgaW5zdGFuY2VvZiBjb25zdHJ1Y3RvcikgewogICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQuJCR1bndyYXBUcnVzdGVkVmFsdWUoKTsKICAgICAgfQogICAgICAvLyBJZiB3ZSBnZXQgaGVyZSwgdGhlbiB3ZSBtYXkgb25seSB0YWtlIG9uZSBvZiB0d28gYWN0aW9ucy4KICAgICAgLy8gMS4gc2FuaXRpemUgdGhlIHZhbHVlIGZvciB0aGUgcmVxdWVzdGVkIHR5cGUsIG9yCiAgICAgIC8vIDIuIHRocm93IGFuIGV4Y2VwdGlvbi4KICAgICAgaWYgKHR5cGUgPT09IFNDRV9DT05URVhUUy5SRVNPVVJDRV9VUkwpIHsKICAgICAgICBpZiAoaXNSZXNvdXJjZVVybEFsbG93ZWRCeVBvbGljeShtYXliZVRydXN0ZWQpKSB7CiAgICAgICAgICByZXR1cm4gbWF5YmVUcnVzdGVkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyAkc2NlTWluRXJyKCdpbnNlY3VybCcsCiAgICAgICAgICAgICAgJ0Jsb2NrZWQgbG9hZGluZyByZXNvdXJjZSBmcm9tIHVybCBub3QgYWxsb3dlZCBieSAkc2NlRGVsZWdhdGUgcG9saWN5LiAgVVJMOiB7MH0nLAogICAgICAgICAgICAgIG1heWJlVHJ1c3RlZC50b1N0cmluZygpKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gU0NFX0NPTlRFWFRTLkhUTUwpIHsKICAgICAgICByZXR1cm4gaHRtbFNhbml0aXplcihtYXliZVRydXN0ZWQpOwogICAgICB9CiAgICAgIHRocm93ICRzY2VNaW5FcnIoJ3Vuc2FmZScsICdBdHRlbXB0aW5nIHRvIHVzZSBhbiB1bnNhZmUgdmFsdWUgaW4gYSBzYWZlIGNvbnRleHQuJyk7CiAgICB9CgogICAgcmV0dXJuIHsgdHJ1c3RBczogdHJ1c3RBcywKICAgICAgICAgICAgIGdldFRydXN0ZWQ6IGdldFRydXN0ZWQsCiAgICAgICAgICAgICB2YWx1ZU9mOiB2YWx1ZU9mIH07CiAgfV07Cn0KCgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRzY2VQcm92aWRlcgogKiBAZGVzY3JpcHRpb24KICoKICogVGhlICRzY2VQcm92aWRlciBwcm92aWRlciBhbGxvd3MgZGV2ZWxvcGVycyB0byBjb25maWd1cmUgdGhlIHtAbGluayBuZy4kc2NlICRzY2V9IHNlcnZpY2UuCiAqIC0gICBlbmFibGUvZGlzYWJsZSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKSBpbiBhIG1vZHVsZQogKiAtICAgb3ZlcnJpZGUgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gd2l0aCBhIGN1c3RvbSBkZWxlZ2F0ZQogKgogKiBSZWFkIG1vcmUgYWJvdXQge0BsaW5rIG5nLiRzY2UgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgKFNDRSl9LgogKi8KCi8qIGpzaGludCBtYXhsZW46IGZhbHNlKi8KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkc2NlCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBgJHNjZWAgaXMgYSBzZXJ2aWNlIHRoYXQgcHJvdmlkZXMgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgc2VydmljZXMgdG8gQW5ndWxhckpTLgogKgogKiAjIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nCiAqCiAqIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpIGlzIGEgbW9kZSBpbiB3aGljaCBBbmd1bGFySlMgcmVxdWlyZXMgYmluZGluZ3MgaW4gY2VydGFpbgogKiBjb250ZXh0cyB0byByZXN1bHQgaW4gYSB2YWx1ZSB0aGF0IGlzIG1hcmtlZCBhcyBzYWZlIHRvIHVzZSBmb3IgdGhhdCBjb250ZXh0LiAgT25lIGV4YW1wbGUgb2YKICogc3VjaCBhIGNvbnRleHQgaXMgYmluZGluZyBhcmJpdHJhcnkgaHRtbCBjb250cm9sbGVkIGJ5IHRoZSB1c2VyIHZpYSBgbmctYmluZC1odG1sYC4gIFdlIHJlZmVyCiAqIHRvIHRoZXNlIGNvbnRleHRzIGFzIHByaXZpbGVnZWQgb3IgU0NFIGNvbnRleHRzLgogKgogKiBBcyBvZiB2ZXJzaW9uIDEuMiwgQW5ndWxhciBzaGlwcyB3aXRoIFNDRSBlbmFibGVkIGJ5IGRlZmF1bHQuCiAqCiAqIE5vdGU6ICBXaGVuIGVuYWJsZWQgKHRoZSBkZWZhdWx0KSwgSUU8MTEgaW4gcXVpcmtzIG1vZGUgaXMgbm90IHN1cHBvcnRlZC4gIEluIHRoaXMgbW9kZSwgSUU8MTEgYWxsb3cKICogb25lIHRvIGV4ZWN1dGUgYXJiaXRyYXJ5IGphdmFzY3JpcHQgYnkgdGhlIHVzZSBvZiB0aGUgZXhwcmVzc2lvbigpIHN5bnRheC4gIFJlZmVyCiAqIDxodHRwOi8vYmxvZ3MubXNkbi5jb20vYi9pZS9hcmNoaXZlLzIwMDgvMTAvMTYvZW5kaW5nLWV4cHJlc3Npb25zLmFzcHg+IHRvIGxlYXJuIG1vcmUgYWJvdXQgdGhlbS4KICogWW91IGNhbiBlbnN1cmUgeW91ciBkb2N1bWVudCBpcyBpbiBzdGFuZGFyZHMgbW9kZSBhbmQgbm90IHF1aXJrcyBtb2RlIGJ5IGFkZGluZyBgPCFkb2N0eXBlIGh0bWw+YAogKiB0byB0aGUgdG9wIG9mIHlvdXIgSFRNTCBkb2N1bWVudC4KICoKICogU0NFIGFzc2lzdHMgaW4gd3JpdGluZyBjb2RlIGluIHdheSB0aGF0IChhKSBpcyBzZWN1cmUgYnkgZGVmYXVsdCBhbmQgKGIpIG1ha2VzIGF1ZGl0aW5nIGZvcgogKiBzZWN1cml0eSB2dWxuZXJhYmlsaXRpZXMgc3VjaCBhcyBYU1MsIGNsaWNramFja2luZywgZXRjLiBhIGxvdCBlYXNpZXIuCiAqCiAqIEhlcmUncyBhbiBleGFtcGxlIG9mIGEgYmluZGluZyBpbiBhIHByaXZpbGVnZWQgY29udGV4dDoKICoKICogYGBgCiAqIDxpbnB1dCBuZy1tb2RlbD0idXNlckh0bWwiPgogKiA8ZGl2IG5nLWJpbmQtaHRtbD0idXNlckh0bWwiPjwvZGl2PgogKiBgYGAKICoKICogTm90aWNlIHRoYXQgYG5nLWJpbmQtaHRtbGAgaXMgYm91bmQgdG8gYHVzZXJIdG1sYCBjb250cm9sbGVkIGJ5IHRoZSB1c2VyLiAgV2l0aCBTQ0UKICogZGlzYWJsZWQsIHRoaXMgYXBwbGljYXRpb24gYWxsb3dzIHRoZSB1c2VyIHRvIHJlbmRlciBhcmJpdHJhcnkgSFRNTCBpbnRvIHRoZSBESVYuCiAqIEluIGEgbW9yZSByZWFsaXN0aWMgZXhhbXBsZSwgb25lIG1heSBiZSByZW5kZXJpbmcgdXNlciBjb21tZW50cywgYmxvZyBhcnRpY2xlcywgZXRjLiB2aWEKICogYmluZGluZ3MuICAoSFRNTCBpcyBqdXN0IG9uZSBleGFtcGxlIG9mIGEgY29udGV4dCB3aGVyZSByZW5kZXJpbmcgdXNlciBjb250cm9sbGVkIGlucHV0IGNyZWF0ZXMKICogc2VjdXJpdHkgdnVsbmVyYWJpbGl0aWVzLikKICoKICogRm9yIHRoZSBjYXNlIG9mIEhUTUwsIHlvdSBtaWdodCB1c2UgYSBsaWJyYXJ5LCBlaXRoZXIgb24gdGhlIGNsaWVudCBzaWRlLCBvciBvbiB0aGUgc2VydmVyIHNpZGUsCiAqIHRvIHNhbml0aXplIHVuc2FmZSBIVE1MIGJlZm9yZSBiaW5kaW5nIHRvIHRoZSB2YWx1ZSBhbmQgcmVuZGVyaW5nIGl0IGluIHRoZSBkb2N1bWVudC4KICoKICogSG93IHdvdWxkIHlvdSBlbnN1cmUgdGhhdCBldmVyeSBwbGFjZSB0aGF0IHVzZWQgdGhlc2UgdHlwZXMgb2YgYmluZGluZ3Mgd2FzIGJvdW5kIHRvIGEgdmFsdWUgdGhhdAogKiB3YXMgc2FuaXRpemVkIGJ5IHlvdXIgbGlicmFyeSAob3IgcmV0dXJuZWQgYXMgc2FmZSBmb3IgcmVuZGVyaW5nIGJ5IHlvdXIgc2VydmVyPykgIEhvdyBjYW4geW91CiAqIGVuc3VyZSB0aGF0IHlvdSBkaWRuJ3QgYWNjaWRlbnRhbGx5IGRlbGV0ZSB0aGUgbGluZSB0aGF0IHNhbml0aXplZCB0aGUgdmFsdWUsIG9yIHJlbmFtZWQgc29tZQogKiBwcm9wZXJ0aWVzL2ZpZWxkcyBhbmQgZm9yZ290IHRvIHVwZGF0ZSB0aGUgYmluZGluZyB0byB0aGUgc2FuaXRpemVkIHZhbHVlPwogKgogKiBUbyBiZSBzZWN1cmUgYnkgZGVmYXVsdCwgeW91IHdhbnQgdG8gZW5zdXJlIHRoYXQgYW55IHN1Y2ggYmluZGluZ3MgYXJlIGRpc2FsbG93ZWQgdW5sZXNzIHlvdSBjYW4KICogZGV0ZXJtaW5lIHRoYXQgc29tZXRoaW5nIGV4cGxpY2l0bHkgc2F5cyBpdCdzIHNhZmUgdG8gdXNlIGEgdmFsdWUgZm9yIGJpbmRpbmcgaW4gdGhhdAogKiBjb250ZXh0LiAgWW91IGNhbiB0aGVuIGF1ZGl0IHlvdXIgY29kZSAoYSBzaW1wbGUgZ3JlcCB3b3VsZCBkbykgdG8gZW5zdXJlIHRoYXQgdGhpcyBpcyBvbmx5IGRvbmUKICogZm9yIHRob3NlIHZhbHVlcyB0aGF0IHlvdSBjYW4gZWFzaWx5IHRlbGwgYXJlIHNhZmUgLSBiZWNhdXNlIHRoZXkgd2VyZSByZWNlaXZlZCBmcm9tIHlvdXIgc2VydmVyLAogKiBzYW5pdGl6ZWQgYnkgeW91ciBsaWJyYXJ5LCBldGMuICBZb3UgY2FuIG9yZ2FuaXplIHlvdXIgY29kZWJhc2UgdG8gaGVscCB3aXRoIHRoaXMgLSBwZXJoYXBzCiAqIGFsbG93aW5nIG9ubHkgdGhlIGZpbGVzIGluIGEgc3BlY2lmaWMgZGlyZWN0b3J5IHRvIGRvIHRoaXMuICBFbnN1cmluZyB0aGF0IHRoZSBpbnRlcm5hbCBBUEkKICogZXhwb3NlZCBieSB0aGF0IGNvZGUgZG9lc24ndCBtYXJrdXAgYXJiaXRyYXJ5IHZhbHVlcyBhcyBzYWZlIHRoZW4gYmVjb21lcyBhIG1vcmUgbWFuYWdlYWJsZSB0YXNrLgogKgogKiBJbiB0aGUgY2FzZSBvZiBBbmd1bGFySlMnIFNDRSBzZXJ2aWNlLCBvbmUgdXNlcyB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzICRzY2UudHJ1c3RBc30KICogKGFuZCBzaG9ydGhhbmQgbWV0aG9kcyBzdWNoIGFzIHtAbGluayBuZy4kc2NlI3RydXN0QXNIdG1sICRzY2UudHJ1c3RBc0h0bWx9LCBldGMuKSB0bwogKiBvYnRhaW4gdmFsdWVzIHRoYXQgd2lsbCBiZSBhY2NlcHRlZCBieSBTQ0UgLyBwcml2aWxlZ2VkIGNvbnRleHRzLgogKgogKgogKiAjIyBIb3cgZG9lcyBpdCB3b3JrPwogKgogKiBJbiBwcml2aWxlZ2VkIGNvbnRleHRzLCBkaXJlY3RpdmVzIGFuZCBjb2RlIHdpbGwgYmluZCB0byB0aGUgcmVzdWx0IG9mIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWQKICogJHNjZS5nZXRUcnVzdGVkKGNvbnRleHQsIHZhbHVlKX0gcmF0aGVyIHRoYW4gdG8gdGhlIHZhbHVlIGRpcmVjdGx5LiAgRGlyZWN0aXZlcyB1c2Uge0BsaW5rCiAqIG5nLiRzY2UjcGFyc2VBcyAkc2NlLnBhcnNlQXN9IHJhdGhlciB0aGFuIGAkcGFyc2VgIHRvIHdhdGNoIGF0dHJpYnV0ZSBiaW5kaW5ncywgd2hpY2ggcGVyZm9ybXMgdGhlCiAqIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWQgJHNjZS5nZXRUcnVzdGVkfSBiZWhpbmQgdGhlIHNjZW5lcyBvbiBub24tY29uc3RhbnQgbGl0ZXJhbHMuCiAqCiAqIEFzIGFuIGV4YW1wbGUsIHtAbGluayBuZy5kaXJlY3RpdmU6bmdCaW5kSHRtbCBuZ0JpbmRIdG1sfSB1c2VzIHtAbGluawogKiBuZy4kc2NlI3BhcnNlQXNIdG1sICRzY2UucGFyc2VBc0h0bWwoYmluZGluZyBleHByZXNzaW9uKX0uICBIZXJlJ3MgdGhlIGFjdHVhbCBjb2RlIChzbGlnaHRseQogKiBzaW1wbGlmaWVkKToKICoKICogYGBgCiAqIHZhciBuZ0JpbmRIdG1sRGlyZWN0aXZlID0gWyckc2NlJywgZnVuY3Rpb24oJHNjZSkgewogKiAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogKiAgICAgc2NvcGUuJHdhdGNoKCRzY2UucGFyc2VBc0h0bWwoYXR0ci5uZ0JpbmRIdG1sKSwgZnVuY3Rpb24odmFsdWUpIHsKICogICAgICAgZWxlbWVudC5odG1sKHZhbHVlIHx8ICcnKTsKICogICAgIH0pOwogKiAgIH07CiAqIH1dOwogKiBgYGAKICoKICogIyMgSW1wYWN0IG9uIGxvYWRpbmcgdGVtcGxhdGVzCiAqCiAqIFRoaXMgYXBwbGllcyBib3RoIHRvIHRoZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSBgbmctaW5jbHVkZWB9IGRpcmVjdGl2ZSBhcyB3ZWxsIGFzCiAqIGB0ZW1wbGF0ZVVybGAncyBzcGVjaWZpZWQgYnkge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4KICoKICogQnkgZGVmYXVsdCwgQW5ndWxhciBvbmx5IGxvYWRzIHRlbXBsYXRlcyBmcm9tIHRoZSBzYW1lIGRvbWFpbiBhbmQgcHJvdG9jb2wgYXMgdGhlIGFwcGxpY2F0aW9uCiAqIGRvY3VtZW50LiAgVGhpcyBpcyBkb25lIGJ5IGNhbGxpbmcge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAqICRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsfSBvbiB0aGUgdGVtcGxhdGUgVVJMLiAgVG8gbG9hZCB0ZW1wbGF0ZXMgZnJvbSBvdGhlciBkb21haW5zIGFuZC9vcgogKiBwcm90b2NvbHMsIHlvdSBtYXkgZWl0aGVyIGVpdGhlciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3Qgd2hpdGVsaXN0CiAqIHRoZW19IG9yIHtAbGluayBuZy4kc2NlI3RydXN0QXNSZXNvdXJjZVVybCB3cmFwIGl0fSBpbnRvIGEgdHJ1c3RlZCB2YWx1ZS4KICoKICogKlBsZWFzZSBub3RlKjoKICogVGhlIGJyb3dzZXIncwogKiBbU2FtZSBPcmlnaW4gUG9saWN5XShodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Jyb3dzZXJzZWMvd2lraS9QYXJ0MiNTYW1lLW9yaWdpbl9wb2xpY3lfZm9yX1hNTEh0dHBSZXF1ZXN0KQogKiBhbmQgW0Nyb3NzLU9yaWdpbiBSZXNvdXJjZSBTaGFyaW5nIChDT1JTKV0oaHR0cDovL3d3dy53My5vcmcvVFIvY29ycy8pCiAqIHBvbGljeSBhcHBseSBpbiBhZGRpdGlvbiB0byB0aGlzIGFuZCBtYXkgZnVydGhlciByZXN0cmljdCB3aGV0aGVyIHRoZSB0ZW1wbGF0ZSBpcyBzdWNjZXNzZnVsbHkKICogbG9hZGVkLiAgVGhpcyBtZWFucyB0aGF0IHdpdGhvdXQgdGhlIHJpZ2h0IENPUlMgcG9saWN5LCBsb2FkaW5nIHRlbXBsYXRlcyBmcm9tIGEgZGlmZmVyZW50IGRvbWFpbgogKiB3b24ndCB3b3JrIG9uIGFsbCBicm93c2Vycy4gIEFsc28sIGxvYWRpbmcgdGVtcGxhdGVzIGZyb20gYGZpbGU6Ly9gIFVSTCBkb2VzIG5vdCB3b3JrIG9uIHNvbWUKICogYnJvd3NlcnMuCiAqCiAqICMjIFRoaXMgZmVlbHMgbGlrZSB0b28gbXVjaCBvdmVyaGVhZAogKgogKiBJdCdzIGltcG9ydGFudCB0byByZW1lbWJlciB0aGF0IFNDRSBvbmx5IGFwcGxpZXMgdG8gaW50ZXJwb2xhdGlvbiBleHByZXNzaW9ucy4KICoKICogSWYgeW91ciBleHByZXNzaW9ucyBhcmUgY29uc3RhbnQgbGl0ZXJhbHMsIHRoZXkncmUgYXV0b21hdGljYWxseSB0cnVzdGVkIGFuZCB5b3UgZG9uJ3QgbmVlZCB0bwogKiBjYWxsIGAkc2NlLnRydXN0QXNgIG9uIHRoZW0gKHJlbWVtYmVyIHRvIGluY2x1ZGUgdGhlIGBuZ1Nhbml0aXplYCBtb2R1bGUpIChlLmcuCiAqIGA8ZGl2IG5nLWJpbmQtaHRtbD0iJzxiPmltcGxpY2l0bHkgdHJ1c3RlZDwvYj4nIj48L2Rpdj5gKSBqdXN0IHdvcmtzLgogKgogKiBBZGRpdGlvbmFsbHksIGBhW2hyZWZdYCBhbmQgYGltZ1tzcmNdYCBhdXRvbWF0aWNhbGx5IHNhbml0aXplIHRoZWlyIFVSTHMgYW5kIGRvIG5vdCBwYXNzIHRoZW0KICogdGhyb3VnaCB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkICRzY2UuZ2V0VHJ1c3RlZH0uICBTQ0UgZG9lc24ndCBwbGF5IGEgcm9sZSBoZXJlLgogKgogKiBUaGUgaW5jbHVkZWQge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSAkc2NlRGVsZWdhdGV9IGNvbWVzIHdpdGggc2FuZSBkZWZhdWx0cyB0byBhbGxvdyB5b3UgdG8gbG9hZAogKiB0ZW1wbGF0ZXMgaW4gYG5nLWluY2x1ZGVgIGZyb20geW91ciBhcHBsaWNhdGlvbidzIGRvbWFpbiB3aXRob3V0IGhhdmluZyB0byBldmVuIGtub3cgYWJvdXQgU0NFLgogKiBJdCBibG9ja3MgbG9hZGluZyB0ZW1wbGF0ZXMgZnJvbSBvdGhlciBkb21haW5zIG9yIGxvYWRpbmcgdGVtcGxhdGVzIG92ZXIgaHR0cCBmcm9tIGFuIGh0dHBzCiAqIHNlcnZlZCBkb2N1bWVudC4gIFlvdSBjYW4gY2hhbmdlIHRoZXNlIGJ5IHNldHRpbmcgeW91ciBvd24gY3VzdG9tIHtAbGluawogKiBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdCB3aGl0ZWxpc3RzfSBhbmQge0BsaW5rCiAqIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0IGJsYWNrbGlzdHN9IGZvciBtYXRjaGluZyBzdWNoIFVSTHMuCiAqCiAqIFRoaXMgc2lnbmlmaWNhbnRseSByZWR1Y2VzIHRoZSBvdmVyaGVhZC4gIEl0IGlzIGZhciBlYXNpZXIgdG8gcGF5IHRoZSBzbWFsbCBvdmVyaGVhZCBhbmQgaGF2ZSBhbgogKiBhcHBsaWNhdGlvbiB0aGF0J3Mgc2VjdXJlIGFuZCBjYW4gYmUgYXVkaXRlZCB0byB2ZXJpZnkgdGhhdCB3aXRoIG11Y2ggbW9yZSBlYXNlIHRoYW4gYm9sdGluZwogKiBzZWN1cml0eSBvbnRvIGFuIGFwcGxpY2F0aW9uIGxhdGVyLgogKgogKiA8YSBuYW1lPSJjb250ZXh0cyI+PC9hPgogKiAjIyBXaGF0IHRydXN0ZWQgY29udGV4dCB0eXBlcyBhcmUgc3VwcG9ydGVkPwogKgogKiB8IENvbnRleHQgICAgICAgICAgICAgfCBOb3RlcyAgICAgICAgICB8CiAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLXwKICogfCBgJHNjZS5IVE1MYCAgICAgICAgIHwgRm9yIEhUTUwgdGhhdCdzIHNhZmUgdG8gc291cmNlIGludG8gdGhlIGFwcGxpY2F0aW9uLiAgVGhlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdCaW5kSHRtbCBuZ0JpbmRIdG1sfSBkaXJlY3RpdmUgdXNlcyB0aGlzIGNvbnRleHQgZm9yIGJpbmRpbmdzLiBJZiBhbiB1bnNhZmUgdmFsdWUgaXMgZW5jb3VudGVyZWQgYW5kIHRoZSB7QGxpbmsgbmdTYW5pdGl6ZSAkc2FuaXRpemV9IG1vZHVsZSBpcyBwcmVzZW50IHRoaXMgd2lsbCBzYW5pdGl6ZSB0aGUgdmFsdWUgaW5zdGVhZCBvZiB0aHJvd2luZyBhbiBlcnJvci4gfAogKiB8IGAkc2NlLkNTU2AgICAgICAgICAgfCBGb3IgQ1NTIHRoYXQncyBzYWZlIHRvIHNvdXJjZSBpbnRvIHRoZSBhcHBsaWNhdGlvbi4gIEN1cnJlbnRseSB1bnVzZWQuICBGZWVsIGZyZWUgdG8gdXNlIGl0IGluIHlvdXIgb3duIGRpcmVjdGl2ZXMuIHwKICogfCBgJHNjZS5VUkxgICAgICAgICAgIHwgRm9yIFVSTHMgdGhhdCBhcmUgc2FmZSB0byBmb2xsb3cgYXMgbGlua3MuICBDdXJyZW50bHkgdW51c2VkIChgPGEgaHJlZj1gIGFuZCBgPGltZyBzcmM9YCBzYW5pdGl6ZSB0aGVpciB1cmxzIGFuZCBkb24ndCBjb25zdGl0dXRlIGFuIFNDRSBjb250ZXh0LiB8CiAqIHwgYCRzY2UuUkVTT1VSQ0VfVVJMYCB8IEZvciBVUkxzIHRoYXQgYXJlIG5vdCBvbmx5IHNhZmUgdG8gZm9sbG93IGFzIGxpbmtzLCBidXQgd2hvc2UgY29udGVudHMgYXJlIGFsc28gc2FmZSB0byBpbmNsdWRlIGluIHlvdXIgYXBwbGljYXRpb24uICBFeGFtcGxlcyBpbmNsdWRlIGBuZy1pbmNsdWRlYCwgYHNyY2AgLyBgbmdTcmNgIGJpbmRpbmdzIGZvciB0YWdzIG90aGVyIHRoYW4gYElNR2AgKGUuZy4gYElGUkFNRWAsIGBPQkpFQ1RgLCBldGMuKSAgPGJyPjxicj5Ob3RlIHRoYXQgYCRzY2UuUkVTT1VSQ0VfVVJMYCBtYWtlcyBhIHN0cm9uZ2VyIHN0YXRlbWVudCBhYm91dCB0aGUgVVJMIHRoYW4gYCRzY2UuVVJMYCBkb2VzIGFuZCB0aGVyZWZvcmUgY29udGV4dHMgcmVxdWlyaW5nIHZhbHVlcyB0cnVzdGVkIGZvciBgJHNjZS5SRVNPVVJDRV9VUkxgIGNhbiBiZSB1c2VkIGFueXdoZXJlIHRoYXQgdmFsdWVzIHRydXN0ZWQgZm9yIGAkc2NlLlVSTGAgYXJlIHJlcXVpcmVkLiB8CiAqIHwgYCRzY2UuSlNgICAgICAgICAgICB8IEZvciBKYXZhU2NyaXB0IHRoYXQgaXMgc2FmZSB0byBleGVjdXRlIGluIHlvdXIgYXBwbGljYXRpb24ncyBjb250ZXh0LiAgQ3VycmVudGx5IHVudXNlZC4gIEZlZWwgZnJlZSB0byB1c2UgaXQgaW4geW91ciBvd24gZGlyZWN0aXZlcy4gfAogKgogKiAjIyBGb3JtYXQgb2YgaXRlbXMgaW4ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0IHJlc291cmNlVXJsV2hpdGVsaXN0fS97QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QgQmxhY2tsaXN0fSA8YSBuYW1lPSJyZXNvdXJjZVVybFBhdHRlcm5JdGVtIj48L2E+CiAqCiAqICBFYWNoIGVsZW1lbnQgaW4gdGhlc2UgYXJyYXlzIG11c3QgYmUgb25lIG9mIHRoZSBmb2xsb3dpbmc6CiAqCiAqICAtICoqJ3NlbGYnKioKICogICAgLSBUaGUgc3BlY2lhbCAqKnN0cmluZyoqLCBgJ3NlbGYnYCwgY2FuIGJlIHVzZWQgdG8gbWF0Y2ggYWdhaW5zdCBhbGwgVVJMcyBvZiB0aGUgKipzYW1lCiAqICAgICAgZG9tYWluKiogYXMgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVzaW5nIHRoZSAqKnNhbWUgcHJvdG9jb2wqKi4KICogIC0gKipTdHJpbmcqKiAoZXhjZXB0IHRoZSBzcGVjaWFsIHZhbHVlIGAnc2VsZidgKQogKiAgICAtIFRoZSBzdHJpbmcgaXMgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBmdWxsICpub3JtYWxpemVkIC8gYWJzb2x1dGUgVVJMKiBvZiB0aGUgcmVzb3VyY2UKICogICAgICBiZWluZyB0ZXN0ZWQgKHN1YnN0cmluZyBtYXRjaGVzIGFyZSBub3QgZ29vZCBlbm91Z2guKQogKiAgICAtIFRoZXJlIGFyZSBleGFjdGx5ICoqdHdvIHdpbGRjYXJkIHNlcXVlbmNlcyoqIC0gYCpgIGFuZCBgKipgLiAgQWxsIG90aGVyIGNoYXJhY3RlcnMKICogICAgICBtYXRjaCB0aGVtc2VsdmVzLgogKiAgICAtIGAqYDogbWF0Y2hlcyB6ZXJvIG9yIG1vcmUgb2NjdXJyZW5jZXMgb2YgYW55IGNoYXJhY3RlciBvdGhlciB0aGFuIG9uZSBvZiB0aGUgZm9sbG93aW5nIDYKICogICAgICBjaGFyYWN0ZXJzOiAnYDpgJywgJ2AvYCcsICdgLmAnLCAnYD9gJywgJ2AmYCcgYW5kICc7Jy4gIEl0J3MgYSB1c2VmdWwgd2lsZGNhcmQgZm9yIHVzZQogKiAgICAgIGluIGEgd2hpdGVsaXN0LgogKiAgICAtIGAqKmA6IG1hdGNoZXMgemVybyBvciBtb3JlIG9jY3VycmVuY2VzIG9mICphbnkqIGNoYXJhY3Rlci4gIEFzIHN1Y2gsIGl0J3Mgbm90CiAqICAgICAgbm90IGFwcHJvcHJpYXRlIHRvIHVzZSBpbiBmb3IgYSBzY2hlbWUsIGRvbWFpbiwgZXRjLiBhcyBpdCB3b3VsZCBtYXRjaCB0b28gbXVjaC4gIChlLmcuCiAqICAgICAgaHR0cDovLyoqLmV4YW1wbGUuY29tLyB3b3VsZCBtYXRjaCBodHRwOi8vZXZpbC5jb20vP2lnbm9yZT0uZXhhbXBsZS5jb20vIGFuZCB0aGF0IG1pZ2h0CiAqICAgICAgbm90IGhhdmUgYmVlbiB0aGUgaW50ZW50aW9uLikgIEl0cyB1c2FnZSBhdCB0aGUgdmVyeSBlbmQgb2YgdGhlIHBhdGggaXMgb2suICAoZS5nLgogKiAgICAgIGh0dHA6Ly9mb28uZXhhbXBsZS5jb20vdGVtcGxhdGVzLyoqKS4KICogIC0gKipSZWdFeHAqKiAoKnNlZSBjYXZlYXQgYmVsb3cqKQogKiAgICAtICpDYXZlYXQqOiAgV2hpbGUgcmVndWxhciBleHByZXNzaW9ucyBhcmUgcG93ZXJmdWwgYW5kIG9mZmVyIGdyZWF0IGZsZXhpYmlsaXR5LCAgdGhlaXIgc3ludGF4CiAqICAgICAgKGFuZCBhbGwgdGhlIGluZXZpdGFibGUgZXNjYXBpbmcpIG1ha2VzIHRoZW0gKmhhcmRlciB0byBtYWludGFpbiouICBJdCdzIGVhc3kgdG8KICogICAgICBhY2NpZGVudGFsbHkgaW50cm9kdWNlIGEgYnVnIHdoZW4gb25lIHVwZGF0ZXMgYSBjb21wbGV4IGV4cHJlc3Npb24gKGltaG8sIGFsbCByZWdleGVzIHNob3VsZAogKiAgICAgIGhhdmUgZ29vZCB0ZXN0IGNvdmVyYWdlLikuICBGb3IgaW5zdGFuY2UsIHRoZSB1c2Ugb2YgYC5gIGluIHRoZSByZWdleCBpcyBjb3JyZWN0IG9ubHkgaW4gYQogKiAgICAgIHNtYWxsIG51bWJlciBvZiBjYXNlcy4gIEEgYC5gIGNoYXJhY3RlciBpbiB0aGUgcmVnZXggdXNlZCB3aGVuIG1hdGNoaW5nIHRoZSBzY2hlbWUgb3IgYQogKiAgICAgIHN1YmRvbWFpbiBjb3VsZCBiZSBtYXRjaGVkIGFnYWluc3QgYSBgOmAgb3IgbGl0ZXJhbCBgLmAgdGhhdCB3YXMgbGlrZWx5IG5vdCBpbnRlbmRlZC4gICBJdAogKiAgICAgIGlzIGhpZ2hseSByZWNvbW1lbmRlZCB0byB1c2UgdGhlIHN0cmluZyBwYXR0ZXJucyBhbmQgb25seSBmYWxsIGJhY2sgdG8gcmVndWxhciBleHByZXNzaW9ucwogKiAgICAgIGlmIHRoZXkgYXMgYSBsYXN0IHJlc29ydC4KICogICAgLSBUaGUgcmVndWxhciBleHByZXNzaW9uIG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgUmVnRXhwIChpLmUuIG5vdCBhIHN0cmluZy4pICBJdCBpcwogKiAgICAgIG1hdGNoZWQgYWdhaW5zdCB0aGUgKiplbnRpcmUqKiAqbm9ybWFsaXplZCAvIGFic29sdXRlIFVSTCogb2YgdGhlIHJlc291cmNlIGJlaW5nIHRlc3RlZAogKiAgICAgIChldmVuIHdoZW4gdGhlIFJlZ0V4cCBkaWQgbm90IGhhdmUgdGhlIGBeYCBhbmQgYCRgIGNvZGVzLikgIEluIGFkZGl0aW9uLCBhbnkgZmxhZ3MKICogICAgICBwcmVzZW50IG9uIHRoZSBSZWdFeHAgKHN1Y2ggYXMgbXVsdGlsaW5lLCBnbG9iYWwsIGlnbm9yZUNhc2UpIGFyZSBpZ25vcmVkLgogKiAgICAtIElmIHlvdSBhcmUgZ2VuZXJhdGluZyB5b3VyIEphdmFTY3JpcHQgZnJvbSBzb21lIG90aGVyIHRlbXBsYXRpbmcgZW5naW5lIChub3QKICogICAgICByZWNvbW1lbmRlZCwgZS5nLiBpbiBpc3N1ZSBbIzQwMDZdKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvaXNzdWVzLzQwMDYpKSwKICogICAgICByZW1lbWJlciB0byBlc2NhcGUgeW91ciByZWd1bGFyIGV4cHJlc3Npb24gKGFuZCBiZSBhd2FyZSB0aGF0IHlvdSBtaWdodCBuZWVkIG1vcmUgdGhhbgogKiAgICAgIG9uZSBsZXZlbCBvZiBlc2NhcGluZyBkZXBlbmRpbmcgb24geW91ciB0ZW1wbGF0aW5nIGVuZ2luZSBhbmQgdGhlIHdheSB5b3UgaW50ZXJwb2xhdGVkCiAqICAgICAgdGhlIHZhbHVlLikgIERvIG1ha2UgdXNlIG9mIHlvdXIgcGxhdGZvcm0ncyBlc2NhcGluZyBtZWNoYW5pc20gYXMgaXQgbWlnaHQgYmUgZ29vZAogKiAgICAgIGVub3VnaCBiZWZvcmUgY29kaW5nIHlvdXIgb3duLiAgZS5nLiBSdWJ5IGhhcwogKiAgICAgIFtSZWdleHAuZXNjYXBlKHN0cildKGh0dHA6Ly93d3cucnVieS1kb2Mub3JnL2NvcmUtMi4wLjAvUmVnZXhwLmh0bWwjbWV0aG9kLWMtZXNjYXBlKQogKiAgICAgIGFuZCBQeXRob24gaGFzIFtyZS5lc2NhcGVdKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9yZS5odG1sI3JlLmVzY2FwZSkuCiAqICAgICAgSmF2YXNjcmlwdCBsYWNrcyBhIHNpbWlsYXIgYnVpbHQgaW4gZnVuY3Rpb24gZm9yIGVzY2FwaW5nLiAgVGFrZSBhIGxvb2sgYXQgR29vZ2xlCiAqICAgICAgQ2xvc3VyZSBsaWJyYXJ5J3MgW2dvb2cuc3RyaW5nLnJlZ0V4cEVzY2FwZShzKV0oCiAqICAgICAgaHR0cDovL2RvY3MuY2xvc3VyZS1saWJyYXJ5Lmdvb2dsZWNvZGUuY29tL2dpdC9jbG9zdXJlX2dvb2dfc3RyaW5nX3N0cmluZy5qcy5zb3VyY2UuaHRtbCNsaW5lOTYyKS4KICoKICogUmVmZXIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyICRzY2VEZWxlZ2F0ZVByb3ZpZGVyfSBmb3IgYW4gZXhhbXBsZS4KICoKICogIyMgU2hvdyBtZSBhbiBleGFtcGxlIHVzaW5nIFNDRS4KICoKICogPGV4YW1wbGUgbW9kdWxlPSJteVNjZUFwcCIgZGVwcz0iYW5ndWxhci1zYW5pdGl6ZS5qcyI+CiAqIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogKiAgIDxkaXYgbmctY29udHJvbGxlcj0iQXBwQ29udHJvbGxlciBhcyBteUN0cmwiPgogKiAgICAgPGkgbmctYmluZC1odG1sPSJteUN0cmwuZXhwbGljaXRseVRydXN0ZWRIdG1sIiBpZD0iZXhwbGljaXRseVRydXN0ZWRIdG1sIj48L2k+PGJyPjxicj4KICogICAgIDxiPlVzZXIgY29tbWVudHM8L2I+PGJyPgogKiAgICAgQnkgZGVmYXVsdCwgSFRNTCB0aGF0IGlzbid0IGV4cGxpY2l0bHkgdHJ1c3RlZCAoZS5nLiBBbGljZSdzIGNvbW1lbnQpIGlzIHNhbml0aXplZCB3aGVuCiAqICAgICAkc2FuaXRpemUgaXMgYXZhaWxhYmxlLiAgSWYgJHNhbml0aXplIGlzbid0IGF2YWlsYWJsZSwgdGhpcyByZXN1bHRzIGluIGFuIGVycm9yIGluc3RlYWQgb2YgYW4KICogICAgIGV4cGxvaXQuCiAqICAgICA8ZGl2IGNsYXNzPSJ3ZWxsIj4KICogICAgICAgPGRpdiBuZy1yZXBlYXQ9InVzZXJDb21tZW50IGluIG15Q3RybC51c2VyQ29tbWVudHMiPgogKiAgICAgICAgIDxiPnt7dXNlckNvbW1lbnQubmFtZX19PC9iPjoKICogICAgICAgICA8c3BhbiBuZy1iaW5kLWh0bWw9InVzZXJDb21tZW50Lmh0bWxDb21tZW50IiBjbGFzcz0iaHRtbENvbW1lbnQiPjwvc3Bhbj4KICogICAgICAgICA8YnI+CiAqICAgICAgIDwvZGl2PgogKiAgICAgPC9kaXY+CiAqICAgPC9kaXY+CiAqIDwvZmlsZT4KICoKICogPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICogICBhbmd1bGFyLm1vZHVsZSgnbXlTY2VBcHAnLCBbJ25nU2FuaXRpemUnXSkKICogICAgIC5jb250cm9sbGVyKCdBcHBDb250cm9sbGVyJywgWyckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckc2NlJywKICogICAgICAgZnVuY3Rpb24oJGh0dHAsICR0ZW1wbGF0ZUNhY2hlLCAkc2NlKSB7CiAqICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogKiAgICAgICAgICRodHRwLmdldCgidGVzdF9kYXRhLmpzb24iLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuc3VjY2VzcyhmdW5jdGlvbih1c2VyQ29tbWVudHMpIHsKICogICAgICAgICAgIHNlbGYudXNlckNvbW1lbnRzID0gdXNlckNvbW1lbnRzOwogKiAgICAgICAgIH0pOwogKiAgICAgICAgIHNlbGYuZXhwbGljaXRseVRydXN0ZWRIdG1sID0gJHNjZS50cnVzdEFzSHRtbCgKICogICAgICAgICAgICAgJzxzcGFuIG9ubW91c2VvdmVyPSJ0aGlzLnRleHRDb250ZW50PSZxdW90O0V4cGxpY2l0bHkgdHJ1c3RlZCBIVE1MIGJ5cGFzc2VzICcgKwogKiAgICAgICAgICAgICAnc2FuaXRpemF0aW9uLiZxdW90OyI+SG92ZXIgb3ZlciB0aGlzIHRleHQuPC9zcGFuPicpOwogKiAgICAgICB9XSk7CiAqIDwvZmlsZT4KICoKICogPGZpbGUgbmFtZT0idGVzdF9kYXRhLmpzb24iPgogKiBbCiAqICAgeyAibmFtZSI6ICJBbGljZSIsCiAqICAgICAiaHRtbENvbW1lbnQiOgogKiAgICAgICAgICI8c3BhbiBvbm1vdXNlb3Zlcj0ndGhpcy50ZXh0Q29udGVudD1cIlBXTjNEIVwiJz5JcyA8aT5hbnlvbmU8L2k+IHJlYWRpbmcgdGhpcz88L3NwYW4+IgogKiAgIH0sCiAqICAgeyAibmFtZSI6ICJCb2IiLAogKiAgICAgImh0bWxDb21tZW50IjogIjxpPlllcyE8L2k+ICBBbSBJIHRoZSBvbmx5IG90aGVyIG9uZT8iCiAqICAgfQogKiBdCiAqIDwvZmlsZT4KICoKICogPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAqICAgZGVzY3JpYmUoJ1NDRSBkb2MgZGVtbycsIGZ1bmN0aW9uKCkgewogKiAgICAgaXQoJ3Nob3VsZCBzYW5pdGl6ZSB1bnRydXN0ZWQgdmFsdWVzJywgZnVuY3Rpb24oKSB7CiAqICAgICAgIGV4cGVjdChlbGVtZW50LmFsbChieS5jc3MoJy5odG1sQ29tbWVudCcpKS5maXJzdCgpLmdldElubmVySHRtbCgpKQogKiAgICAgICAgICAgLnRvQmUoJzxzcGFuPklzIDxpPmFueW9uZTwvaT4gcmVhZGluZyB0aGlzPzwvc3Bhbj4nKTsKICogICAgIH0pOwogKgogKiAgICAgaXQoJ3Nob3VsZCBOT1Qgc2FuaXRpemUgZXhwbGljaXRseSB0cnVzdGVkIHZhbHVlcycsIGZ1bmN0aW9uKCkgewogKiAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnZXhwbGljaXRseVRydXN0ZWRIdG1sJykpLmdldElubmVySHRtbCgpKS50b0JlKAogKiAgICAgICAgICAgJzxzcGFuIG9ubW91c2VvdmVyPSJ0aGlzLnRleHRDb250ZW50PSZxdW90O0V4cGxpY2l0bHkgdHJ1c3RlZCBIVE1MIGJ5cGFzc2VzICcgKwogKiAgICAgICAgICAgJ3Nhbml0aXphdGlvbi4mcXVvdDsiPkhvdmVyIG92ZXIgdGhpcyB0ZXh0Ljwvc3Bhbj4nKTsKICogICAgIH0pOwogKiAgIH0pOwogKiA8L2ZpbGU+CiAqIDwvZXhhbXBsZT4KICoKICoKICoKICogIyMgQ2FuIEkgZGlzYWJsZSBTQ0UgY29tcGxldGVseT8KICoKICogWWVzLCB5b3UgY2FuLiAgSG93ZXZlciwgdGhpcyBpcyBzdHJvbmdseSBkaXNjb3VyYWdlZC4gIFNDRSBnaXZlcyB5b3UgYSBsb3Qgb2Ygc2VjdXJpdHkgYmVuZWZpdHMKICogZm9yIGxpdHRsZSBjb2Rpbmcgb3ZlcmhlYWQuICBJdCB3aWxsIGJlIG11Y2ggaGFyZGVyIHRvIHRha2UgYW4gU0NFIGRpc2FibGVkIGFwcGxpY2F0aW9uIGFuZAogKiBlaXRoZXIgc2VjdXJlIGl0IG9uIHlvdXIgb3duIG9yIGVuYWJsZSBTQ0UgYXQgYSBsYXRlciBzdGFnZS4gIEl0IG1pZ2h0IG1ha2Ugc2Vuc2UgdG8gZGlzYWJsZSBTQ0UKICogZm9yIGNhc2VzIHdoZXJlIHlvdSBoYXZlIGEgbG90IG9mIGV4aXN0aW5nIGNvZGUgdGhhdCB3YXMgd3JpdHRlbiBiZWZvcmUgU0NFIHdhcyBpbnRyb2R1Y2VkIGFuZAogKiB5b3UncmUgbWlncmF0aW5nIHRoZW0gYSBtb2R1bGUgYXQgYSB0aW1lLgogKgogKiBUaGF0IHNhaWQsIGhlcmUncyBob3cgeW91IGNhbiBjb21wbGV0ZWx5IGRpc2FibGUgU0NFOgogKgogKiBgYGAKICogYW5ndWxhci5tb2R1bGUoJ215QXBwV2l0aFNjZURpc2FibGVkbXlBcHAnLCBbXSkuY29uZmlnKGZ1bmN0aW9uKCRzY2VQcm92aWRlcikgewogKiAgIC8vIENvbXBsZXRlbHkgZGlzYWJsZSBTQ0UuICBGb3IgZGVtb25zdHJhdGlvbiBwdXJwb3NlcyBvbmx5IQogKiAgIC8vIERvIG5vdCB1c2UgaW4gbmV3IHByb2plY3RzLgogKiAgICRzY2VQcm92aWRlci5lbmFibGVkKGZhbHNlKTsKICogfSk7CiAqIGBgYAogKgogKi8KLyoganNoaW50IG1heGxlbjogMTAwICovCgpmdW5jdGlvbiAkU2NlUHJvdmlkZXIoKSB7CiAgdmFyIGVuYWJsZWQgPSB0cnVlOwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJHNjZVByb3ZpZGVyI2VuYWJsZWQKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQHBhcmFtIHtib29sZWFuPX0gdmFsdWUgSWYgcHJvdmlkZWQsIHRoZW4gZW5hYmxlcy9kaXNhYmxlcyBTQ0UuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZiBTQ0UgaXMgZW5hYmxlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRW5hYmxlcy9kaXNhYmxlcyBTQ0UgYW5kIHJldHVybnMgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICovCiAgdGhpcy5lbmFibGVkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICBlbmFibGVkID0gISF2YWx1ZTsKICAgIH0KICAgIHJldHVybiBlbmFibGVkOwogIH07CgoKICAvKiBEZXNpZ24gbm90ZXMgb24gdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gZm9yIFNDRS4KICAgKgogICAqIFRoZSBBUEkgY29udHJhY3QgZm9yIHRoZSBTQ0UgZGVsZWdhdGUKICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogVGhlIFNDRSBkZWxlZ2F0ZSBvYmplY3QgbXVzdCBwcm92aWRlIHRoZSBmb2xsb3dpbmcgMyBtZXRob2RzOgogICAqCiAgICogLSB0cnVzdEFzKGNvbnRleHRFbnVtLCB2YWx1ZSkKICAgKiAgICAgVGhpcyBtZXRob2QgaXMgdXNlZCB0byB0ZWxsIHRoZSBTQ0Ugc2VydmljZSB0aGF0IHRoZSBwcm92aWRlZCB2YWx1ZSBpcyBPSyB0byB1c2UgaW4gdGhlCiAgICogICAgIGNvbnRleHRzIHNwZWNpZmllZCBieSBjb250ZXh0RW51bS4gIEl0IG11c3QgcmV0dXJuIGFuIG9iamVjdCB0aGF0IHdpbGwgYmUgYWNjZXB0ZWQgYnkKICAgKiAgICAgZ2V0VHJ1c3RlZCgpIGZvciBhIGNvbXBhdGlibGUgY29udGV4dEVudW0gYW5kIHJldHVybiB0aGlzIHZhbHVlLgogICAqCiAgICogLSB2YWx1ZU9mKHZhbHVlKQogICAqICAgICBGb3IgdmFsdWVzIHRoYXQgd2VyZSBub3QgcHJvZHVjZWQgYnkgdHJ1c3RBcygpLCByZXR1cm4gdGhlbSBhcyBpcy4gIEZvciB2YWx1ZXMgdGhhdCB3ZXJlCiAgICogICAgIHByb2R1Y2VkIGJ5IHRydXN0QXMoKSwgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIGlucHV0IHZhbHVlIHRvIHRydXN0QXMuICBCYXNpY2FsbHksIGlmCiAgICogICAgIHRydXN0QXMgaXMgd3JhcHBpbmcgdGhlIGdpdmVuIHZhbHVlcyBpbnRvIHNvbWUgdHlwZSwgdGhpcyBvcGVyYXRpb24gdW53cmFwcyBpdCB3aGVuIGdpdmVuCiAgICogICAgIHN1Y2ggYSB2YWx1ZS4KICAgKgogICAqIC0gZ2V0VHJ1c3RlZChjb250ZXh0RW51bSwgdmFsdWUpCiAgICogICAgIFRoaXMgZnVuY3Rpb24gc2hvdWxkIHJldHVybiB0aGUgYSB2YWx1ZSB0aGF0IGlzIHNhZmUgdG8gdXNlIGluIHRoZSBjb250ZXh0IHNwZWNpZmllZCBieQogICAqICAgICBjb250ZXh0RW51bSBvciB0aHJvdyBhbmQgZXhjZXB0aW9uIG90aGVyd2lzZS4KICAgKgogICAqIE5PVEU6IFRoaXMgY29udHJhY3QgZGVsaWJlcmF0ZWx5IGRvZXMgTk9UIHN0YXRlIHRoYXQgdmFsdWVzIHJldHVybmVkIGJ5IHRydXN0QXMoKSBtdXN0IGJlCiAgICogb3BhcXVlIG9yIHdyYXBwZWQgaW4gc29tZSBob2xkZXIgb2JqZWN0LiAgVGhhdCBoYXBwZW5zIHRvIGJlIGFuIGltcGxlbWVudGF0aW9uIGRldGFpbC4gIEZvcgogICAqIGluc3RhbmNlLCBhbiBpbXBsZW1lbnRhdGlvbiBjb3VsZCBtYWludGFpbiBhIHJlZ2lzdHJ5IG9mIGFsbCB0cnVzdGVkIG9iamVjdHMgYnkgY29udGV4dC4gIEluCiAgICogc3VjaCBhIGNhc2UsIHRydXN0QXMoKSB3b3VsZCByZXR1cm4gdGhlIHNhbWUgb2JqZWN0IHRoYXQgd2FzIHBhc3NlZCBpbi4gIGdldFRydXN0ZWQoKSB3b3VsZAogICAqIHJldHVybiB0aGUgc2FtZSBvYmplY3QgcGFzc2VkIGluIGlmIGl0IHdhcyBmb3VuZCBpbiB0aGUgcmVnaXN0cnkgdW5kZXIgYSBjb21wYXRpYmxlIGNvbnRleHQgb3IKICAgKiB0aHJvdyBhbiBleGNlcHRpb24gb3RoZXJ3aXNlLiAgQW4gaW1wbGVtZW50YXRpb24gbWlnaHQgb25seSB3cmFwIHZhbHVlcyBzb21lIG9mIHRoZSB0aW1lIGJhc2VkCiAgICogb24gc29tZSBjcml0ZXJpYS4gIGdldFRydXN0ZWQoKSBtaWdodCByZXR1cm4gYSB2YWx1ZSBhbmQgbm90IHRocm93IGFuIGV4Y2VwdGlvbiBmb3Igc3BlY2lhbAogICAqIGNvbnN0YW50cyBvciBvYmplY3RzIGV2ZW4gaWYgbm90IHdyYXBwZWQuICBBbGwgc3VjaCBpbXBsZW1lbnRhdGlvbnMgZnVsZmlsbCB0aGlzIGNvbnRyYWN0LgogICAqCiAgICoKICAgKiBBIG5vdGUgb24gdGhlIGluaGVyaXRhbmNlIG1vZGVsIGZvciBTQ0UgY29udGV4dHMKICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJJ3ZlIHVzZWQgaW5oZXJpdGFuY2UgYW5kIG1hZGUgUkVTT1VSQ0VfVVJMIHdyYXBwZWQgdHlwZXMgYSBzdWJ0eXBlIG9mIFVSTCB3cmFwcGVkIHR5cGVzLiAgVGhpcwogICAqIGlzIHB1cmVseSBhbiBpbXBsZW1lbnRhdGlvbiBkZXRhaWxzLgogICAqCiAgICogVGhlIGNvbnRyYWN0IGlzIHNpbXBseSB0aGlzOgogICAqCiAgICogICAgIGdldFRydXN0ZWQoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKSBzdWNjZWVkaW5nIGltcGxpZXMgdGhhdCBnZXRUcnVzdGVkKCRzY2UuVVJMLCB2YWx1ZSkKICAgKiAgICAgd2lsbCBhbHNvIHN1Y2NlZWQuCiAgICoKICAgKiBJbmhlcml0YW5jZSBoYXBwZW5zIHRvIGNhcHR1cmUgdGhpcyBpbiBhIG5hdHVyYWwgd2F5LiAgSW4gc29tZSBmdXR1cmUsIHdlCiAgICogbWF5IG5vdCB1c2UgaW5oZXJpdGFuY2UgYW55bW9yZS4gIFRoYXQgaXMgT0sgYmVjYXVzZSBubyBjb2RlIG91dHNpZGUgb2YKICAgKiBzY2UuanMgYW5kIHNjZVNwZWNzLmpzIHdvdWxkIG5lZWQgdG8gYmUgYXdhcmUgb2YgdGhpcyBkZXRhaWwuCiAgICovCgogIHRoaXMuJGdldCA9IFsnJGRvY3VtZW50JywgJyRwYXJzZScsICckc2NlRGVsZWdhdGUnLCBmdW5jdGlvbigKICAgICAgICAgICAgICAgICRkb2N1bWVudCwgICAkcGFyc2UsICAgJHNjZURlbGVnYXRlKSB7CiAgICAvLyBQcmVyZXE6IEVuc3VyZSB0aGF0IHdlJ3JlIG5vdCBydW5uaW5nIGluIElFPDExIHF1aXJrcyBtb2RlLiAgSW4gdGhhdCBtb2RlLCBJRSA8IDExIGFsbG93CiAgICAvLyB0aGUgImV4cHJlc3Npb24oamF2YXNjcmlwdCBleHByZXNzaW9uKSIgc3ludGF4IHdoaWNoIGlzIGluc2VjdXJlLgogICAgaWYgKGVuYWJsZWQgJiYgJGRvY3VtZW50WzBdLmRvY3VtZW50TW9kZSA8IDgpIHsKICAgICAgdGhyb3cgJHNjZU1pbkVycignaWVxdWlya3MnLAogICAgICAgICdTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyBkb2VzIG5vdCBzdXBwb3J0IEludGVybmV0IEV4cGxvcmVyIHZlcnNpb24gPCAxMSBpbiBxdWlya3MgJyArCiAgICAgICAgJ21vZGUuICBZb3UgY2FuIGZpeCB0aGlzIGJ5IGFkZGluZyB0aGUgdGV4dCA8IWRvY3R5cGUgaHRtbD4gdG8gdGhlIHRvcCBvZiB5b3VyIEhUTUwgJyArCiAgICAgICAgJ2RvY3VtZW50LiAgU2VlIGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nLiRzY2UgZm9yIG1vcmUgaW5mb3JtYXRpb24uJyk7CiAgICB9CgogICAgdmFyIHNjZSA9IHNoYWxsb3dDb3B5KFNDRV9DT05URVhUUyk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI2lzRW5hYmxlZAogICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAcmV0dXJuIHtCb29sZWFufSB0cnVlIGlmIFNDRSBpcyBlbmFibGVkLCBmYWxzZSBvdGhlcndpc2UuICBJZiB5b3Ugd2FudCB0byBzZXQgdGhlIHZhbHVlLCB5b3UKICAgICAqIGhhdmUgdG8gZG8gaXQgYXQgbW9kdWxlIGNvbmZpZyB0aW1lIG9uIHtAbGluayBuZy4kc2NlUHJvdmlkZXIgJHNjZVByb3ZpZGVyfS4KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJldHVybnMgYSBib29sZWFuIGluZGljYXRpbmcgaWYgU0NFIGlzIGVuYWJsZWQuCiAgICAgKi8KICAgIHNjZS5pc0VuYWJsZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBlbmFibGVkOwogICAgfTsKICAgIHNjZS50cnVzdEFzID0gJHNjZURlbGVnYXRlLnRydXN0QXM7CiAgICBzY2UuZ2V0VHJ1c3RlZCA9ICRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkOwogICAgc2NlLnZhbHVlT2YgPSAkc2NlRGVsZWdhdGUudmFsdWVPZjsKCiAgICBpZiAoIWVuYWJsZWQpIHsKICAgICAgc2NlLnRydXN0QXMgPSBzY2UuZ2V0VHJ1c3RlZCA9IGZ1bmN0aW9uKHR5cGUsIHZhbHVlKSB7IHJldHVybiB2YWx1ZTsgfTsKICAgICAgc2NlLnZhbHVlT2YgPSBpZGVudGl0eTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjcGFyc2VBcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ29udmVydHMgQW5ndWxhciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpbnRvIGEgZnVuY3Rpb24uICBUaGlzIGlzIGxpa2Uge0BsaW5rCiAgICAgKiBuZy4kcGFyc2UgJHBhcnNlfSBhbmQgaXMgaWRlbnRpY2FsIHdoZW4gdGhlIGV4cHJlc3Npb24gaXMgYSBsaXRlcmFsIGNvbnN0YW50LiAgT3RoZXJ3aXNlLCBpdAogICAgICogd3JhcHMgdGhlIGV4cHJlc3Npb24gaW4gYSBjYWxsIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWQgJHNjZS5nZXRUcnVzdGVkKCp0eXBlKiwKICAgICAqICpyZXN1bHQqKX0KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBTQ0UgY29udGV4dCBpbiB3aGljaCB0aGlzIHJlc3VsdCB3aWxsIGJlIHVzZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAqCiAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICovCiAgICBzY2UucGFyc2VBcyA9IGZ1bmN0aW9uIHNjZVBhcnNlQXModHlwZSwgZXhwcikgewogICAgICB2YXIgcGFyc2VkID0gJHBhcnNlKGV4cHIpOwogICAgICBpZiAocGFyc2VkLmxpdGVyYWwgJiYgcGFyc2VkLmNvbnN0YW50KSB7CiAgICAgICAgcmV0dXJuIHBhcnNlZDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gJHBhcnNlKGV4cHIsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgcmV0dXJuIHNjZS5nZXRUcnVzdGVkKHR5cGUsIHZhbHVlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGVsZWdhdGVzIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfS4gIEFzIHN1Y2gsCiAgICAgKiByZXR1cm5zIGFuIG9iamVjdCB0aGF0IGlzIHRydXN0ZWQgYnkgYW5ndWxhciBmb3IgdXNlIGluIHNwZWNpZmllZCBzdHJpY3QgY29udGV4dHVhbAogICAgICogZXNjYXBpbmcgY29udGV4dHMgKHN1Y2ggYXMgbmctYmluZC1odG1sLCBuZy1pbmNsdWRlLCBhbnkgc3JjIGF0dHJpYnV0ZQogICAgICogaW50ZXJwb2xhdGlvbiwgYW55IGRvbSBldmVudCBiaW5kaW5nIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uIHN1Y2ggYXMgZm9yIG9uY2xpY2ssICBldGMuKQogICAgICogdGhhdCB1c2VzIHRoZSBwcm92aWRlZCB2YWx1ZS4gIFNlZSAqIHtAbGluayBuZy4kc2NlICRzY2V9IGZvciBlbmFibGluZyBzdHJpY3QgY29udGV4dHVhbAogICAgICogZXNjYXBpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgY29udGV4dCBpbiB3aGljaCB0aGlzIHZhbHVlIGlzIHNhZmUgZm9yIHVzZS4gIGUuZy4gdXJsLAogICAgICogICByZXNvdXJjZV91cmwsIGh0bWwsIGpzIGFuZCBjc3MuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0aGF0IHRoYXQgc2hvdWxkIGJlIGNvbnNpZGVyZWQgdHJ1c3RlZC9zYWZlLgogICAgICogQHJldHVybnMgeyp9IEEgdmFsdWUgdGhhdCBjYW4gYmUgdXNlZCB0byBzdGFuZCBpbiBmb3IgdGhlIHByb3ZpZGVkIGB2YWx1ZWAgaW4gcGxhY2VzCiAgICAgKiB3aGVyZSBBbmd1bGFyIGV4cGVjdHMgYSAkc2NlLnRydXN0QXMoKSByZXR1cm4gdmFsdWUuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBc0h0bWwKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS50cnVzdEFzSHRtbCh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5IVE1MLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHRydXN0QXMuCiAgICAgKiBAcmV0dXJucyB7Kn0gQW4gb2JqZWN0IHRoYXQgY2FuIGJlIHBhc3NlZCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkSHRtbAogICAgICogICAgICRzY2UuZ2V0VHJ1c3RlZEh0bWwodmFsdWUpfSB0byBvYnRhaW4gdGhlIG9yaWdpbmFsIHZhbHVlLiAgKHByaXZpbGVnZWQgZGlyZWN0aXZlcwogICAgICogICAgIG9ubHkgYWNjZXB0IGV4cHJlc3Npb25zIHRoYXQgYXJlIGVpdGhlciBsaXRlcmFsIGNvbnN0YW50cyBvciBhcmUgdGhlCiAgICAgKiAgICAgcmV0dXJuIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBc1VybAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnRydXN0QXNVcmwodmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzKCRzY2UuVVJMLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHRydXN0QXMuCiAgICAgKiBAcmV0dXJucyB7Kn0gQW4gb2JqZWN0IHRoYXQgY2FuIGJlIHBhc3NlZCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkVXJsCiAgICAgKiAgICAgJHNjZS5nZXRUcnVzdGVkVXJsKHZhbHVlKX0gdG8gb2J0YWluIHRoZSBvcmlnaW5hbCB2YWx1ZS4gIChwcml2aWxlZ2VkIGRpcmVjdGl2ZXMKICAgICAqICAgICBvbmx5IGFjY2VwdCBleHByZXNzaW9ucyB0aGF0IGFyZSBlaXRoZXIgbGl0ZXJhbCBjb25zdGFudHMgb3IgYXJlIHRoZQogICAgICogICAgIHJldHVybiB2YWx1ZSBvZiB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzICRzY2UudHJ1c3RBc30uKQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI3RydXN0QXNSZXNvdXJjZVVybAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnRydXN0QXNSZXNvdXJjZVVybCh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gdHJ1c3RBcy4KICAgICAqIEByZXR1cm5zIHsqfSBBbiBvYmplY3QgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRSZXNvdXJjZVVybAogICAgICogICAgICRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsKHZhbHVlKX0gdG8gb2J0YWluIHRoZSBvcmlnaW5hbCB2YWx1ZS4gIChwcml2aWxlZ2VkIGRpcmVjdGl2ZXMKICAgICAqICAgICBvbmx5IGFjY2VwdCBleHByZXNzaW9ucyB0aGF0IGFyZSBlaXRoZXIgbGl0ZXJhbCBjb25zdGFudHMgb3IgYXJlIHRoZSByZXR1cm4KICAgICAqICAgICB2YWx1ZSBvZiB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzICRzY2UudHJ1c3RBc30uKQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI3RydXN0QXNKcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnRydXN0QXNKcyh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5KUywgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB0cnVzdEFzLgogICAgICogQHJldHVybnMgeyp9IEFuIG9iamVjdCB0aGF0IGNhbiBiZSBwYXNzZWQgdG8ge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZEpzCiAgICAgKiAgICAgJHNjZS5nZXRUcnVzdGVkSnModmFsdWUpfSB0byBvYnRhaW4gdGhlIG9yaWdpbmFsIHZhbHVlLiAgKHByaXZpbGVnZWQgZGlyZWN0aXZlcwogICAgICogICAgIG9ubHkgYWNjZXB0IGV4cHJlc3Npb25zIHRoYXQgYXJlIGVpdGhlciBsaXRlcmFsIGNvbnN0YW50cyBvciBhcmUgdGhlCiAgICAgKiAgICAgcmV0dXJuIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGVsZWdhdGVzIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWRgfS4gIEFzIHN1Y2gsCiAgICAgKiB0YWtlcyB0aGUgcmVzdWx0IG9mIGEge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyBgJHNjZS50cnVzdEFzYH0oKSBjYWxsIGFuZCByZXR1cm5zIHRoZQogICAgICogb3JpZ2luYWxseSBzdXBwbGllZCB2YWx1ZSBpZiB0aGUgcXVlcmllZCBjb250ZXh0IHR5cGUgaXMgYSBzdXBlcnR5cGUgb2YgdGhlIGNyZWF0ZWQgdHlwZS4KICAgICAqIElmIHRoaXMgY29uZGl0aW9uIGlzbid0IHNhdGlzZmllZCwgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgdG8gYmUgdXNlZC4KICAgICAqIEBwYXJhbSB7Kn0gbWF5YmVUcnVzdGVkIFRoZSByZXN1bHQgb2YgYSBwcmlvciB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzIGAkc2NlLnRydXN0QXNgfQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgY2FsbC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgdmFsdWUgdGhlIHdhcyBvcmlnaW5hbGx5IHByb3ZpZGVkIHRvCiAgICAgKiAgICAgICAgICAgICAge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyBgJHNjZS50cnVzdEFzYH0gaWYgdmFsaWQgaW4gdGhpcyBjb250ZXh0LgogICAgICogICAgICAgICAgICAgIE90aGVyd2lzZSwgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkSHRtbAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRIdG1sKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLkhUTUwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkc2NlLmdldFRydXN0ZWQoJHNjZS5IVE1MLCB2YWx1ZSlgCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZENzcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRDc3ModmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkKCRzY2UuQ1NTLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHBhc3MgdG8gYCRzY2UuZ2V0VHJ1c3RlZGAuCiAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJldHVybiB2YWx1ZSBvZiBgJHNjZS5nZXRUcnVzdGVkKCRzY2UuQ1NTLCB2YWx1ZSlgCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZFVybAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRVcmwodmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkKCRzY2UuVVJMLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHBhc3MgdG8gYCRzY2UuZ2V0VHJ1c3RlZGAuCiAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJldHVybiB2YWx1ZSBvZiBgJHNjZS5nZXRUcnVzdGVkKCRzY2UuVVJMLCB2YWx1ZSlgCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBwYXNzIHRvIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZGAuCiAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJldHVybiB2YWx1ZSBvZiBgJHNjZS5nZXRUcnVzdGVkKCRzY2UuUkVTT1VSQ0VfVVJMLCB2YWx1ZSlgCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZEpzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZEpzKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLkpTLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHBhc3MgdG8gYCRzY2UuZ2V0VHJ1c3RlZGAuCiAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJldHVybiB2YWx1ZSBvZiBgJHNjZS5nZXRUcnVzdGVkKCRzY2UuSlMsIHZhbHVlKWAKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNwYXJzZUFzSHRtbAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNIdG1sKGV4cHJlc3Npb24gc3RyaW5nKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2UjcGFyc2VBcyBgJHNjZS5wYXJzZUFzKCRzY2UuSFRNTCwgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAqCiAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI3BhcnNlQXNDc3MKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzQ3NzKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2UjcGFyc2VBcyBgJHNjZS5wYXJzZUFzKCRzY2UuQ1NTLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICoKICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICogICAgICBgY29udGV4dGAuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjcGFyc2VBc1VybAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNVcmwodmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZSNwYXJzZUFzIGAkc2NlLnBhcnNlQXMoJHNjZS5VUkwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNwYXJzZUFzUmVzb3VyY2VVcmwKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzUmVzb3VyY2VVcmwodmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZSNwYXJzZUFzIGAkc2NlLnBhcnNlQXMoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNwYXJzZUFzSnMKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzSnModmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZSNwYXJzZUFzIGAkc2NlLnBhcnNlQXMoJHNjZS5KUywgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAqCiAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICovCgogICAgLy8gU2hvcnRoYW5kIGRlbGVnYXRpb25zLgogICAgdmFyIHBhcnNlID0gc2NlLnBhcnNlQXMsCiAgICAgICAgZ2V0VHJ1c3RlZCA9IHNjZS5nZXRUcnVzdGVkLAogICAgICAgIHRydXN0QXMgPSBzY2UudHJ1c3RBczsKCiAgICBmb3JFYWNoKFNDRV9DT05URVhUUywgZnVuY3Rpb24gKGVudW1WYWx1ZSwgbmFtZSkgewogICAgICB2YXIgbE5hbWUgPSBsb3dlcmNhc2UobmFtZSk7CiAgICAgIHNjZVtjYW1lbENhc2UoInBhcnNlX2FzXyIgKyBsTmFtZSldID0gZnVuY3Rpb24gKGV4cHIpIHsKICAgICAgICByZXR1cm4gcGFyc2UoZW51bVZhbHVlLCBleHByKTsKICAgICAgfTsKICAgICAgc2NlW2NhbWVsQ2FzZSgiZ2V0X3RydXN0ZWRfIiArIGxOYW1lKV0gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICByZXR1cm4gZ2V0VHJ1c3RlZChlbnVtVmFsdWUsIHZhbHVlKTsKICAgICAgfTsKICAgICAgc2NlW2NhbWVsQ2FzZSgidHJ1c3RfYXNfIiArIGxOYW1lKV0gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHJ1c3RBcyhlbnVtVmFsdWUsIHZhbHVlKTsKICAgICAgfTsKICAgIH0pOwoKICAgIHJldHVybiBzY2U7CiAgfV07Cn0KCi8qKgogKiAhISEgVGhpcyBpcyBhbiB1bmRvY3VtZW50ZWQgInByaXZhdGUiIHNlcnZpY2UgISEhCiAqCiAqIEBuYW1lICRzbmlmZmVyCiAqIEByZXF1aXJlcyAkd2luZG93CiAqIEByZXF1aXJlcyAkZG9jdW1lbnQKICoKICogQHByb3BlcnR5IHtib29sZWFufSBoaXN0b3J5IERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCBodG1sNSBoaXN0b3J5IGFwaSA/CiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdHJhbnNpdGlvbnMgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IENTUyB0cmFuc2l0aW9uIGV2ZW50cyA/CiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYW5pbWF0aW9ucyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgQ1NTIGFuaW1hdGlvbiBldmVudHMgPwogKgogKiBAZGVzY3JpcHRpb24KICogVGhpcyBpcyB2ZXJ5IHNpbXBsZSBpbXBsZW1lbnRhdGlvbiBvZiB0ZXN0aW5nIGJyb3dzZXIncyBmZWF0dXJlcy4KICovCmZ1bmN0aW9uICRTbmlmZmVyUHJvdmlkZXIoKSB7CiAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgJyRkb2N1bWVudCcsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCkgewogICAgdmFyIGV2ZW50U3VwcG9ydCA9IHt9LAogICAgICAgIGFuZHJvaWQgPQogICAgICAgICAgaW50KCgvYW5kcm9pZCAoXGQrKS8uZXhlYyhsb3dlcmNhc2UoKCR3aW5kb3cubmF2aWdhdG9yIHx8IHt9KS51c2VyQWdlbnQpKSB8fCBbXSlbMV0pLAogICAgICAgIGJveGVlID0gL0JveGVlL2kudGVzdCgoJHdpbmRvdy5uYXZpZ2F0b3IgfHwge30pLnVzZXJBZ2VudCksCiAgICAgICAgZG9jdW1lbnQgPSAkZG9jdW1lbnRbMF0gfHwge30sCiAgICAgICAgdmVuZG9yUHJlZml4LAogICAgICAgIHZlbmRvclJlZ2V4ID0gL14oTW96fHdlYmtpdHxPfG1zKSg/PVtBLVpdKS8sCiAgICAgICAgYm9keVN0eWxlID0gZG9jdW1lbnQuYm9keSAmJiBkb2N1bWVudC5ib2R5LnN0eWxlLAogICAgICAgIHRyYW5zaXRpb25zID0gZmFsc2UsCiAgICAgICAgYW5pbWF0aW9ucyA9IGZhbHNlLAogICAgICAgIG1hdGNoOwoKICAgIGlmIChib2R5U3R5bGUpIHsKICAgICAgZm9yKHZhciBwcm9wIGluIGJvZHlTdHlsZSkgewogICAgICAgIGlmKG1hdGNoID0gdmVuZG9yUmVnZXguZXhlYyhwcm9wKSkgewogICAgICAgICAgdmVuZG9yUHJlZml4ID0gbWF0Y2hbMF07CiAgICAgICAgICB2ZW5kb3JQcmVmaXggPSB2ZW5kb3JQcmVmaXguc3Vic3RyKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyB2ZW5kb3JQcmVmaXguc3Vic3RyKDEpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZighdmVuZG9yUHJlZml4KSB7CiAgICAgICAgdmVuZG9yUHJlZml4ID0gKCdXZWJraXRPcGFjaXR5JyBpbiBib2R5U3R5bGUpICYmICd3ZWJraXQnOwogICAgICB9CgogICAgICB0cmFuc2l0aW9ucyA9ICEhKCgndHJhbnNpdGlvbicgaW4gYm9keVN0eWxlKSB8fCAodmVuZG9yUHJlZml4ICsgJ1RyYW5zaXRpb24nIGluIGJvZHlTdHlsZSkpOwogICAgICBhbmltYXRpb25zICA9ICEhKCgnYW5pbWF0aW9uJyBpbiBib2R5U3R5bGUpIHx8ICh2ZW5kb3JQcmVmaXggKyAnQW5pbWF0aW9uJyBpbiBib2R5U3R5bGUpKTsKCiAgICAgIGlmIChhbmRyb2lkICYmICghdHJhbnNpdGlvbnN8fCFhbmltYXRpb25zKSkgewogICAgICAgIHRyYW5zaXRpb25zID0gaXNTdHJpbmcoZG9jdW1lbnQuYm9keS5zdHlsZS53ZWJraXRUcmFuc2l0aW9uKTsKICAgICAgICBhbmltYXRpb25zID0gaXNTdHJpbmcoZG9jdW1lbnQuYm9keS5zdHlsZS53ZWJraXRBbmltYXRpb24pOwogICAgICB9CiAgICB9CgoKICAgIHJldHVybiB7CiAgICAgIC8vIEFuZHJvaWQgaGFzIGhpc3RvcnkucHVzaFN0YXRlLCBidXQgaXQgZG9lcyBub3QgdXBkYXRlIGxvY2F0aW9uIGNvcnJlY3RseQogICAgICAvLyBzbyBsZXQncyBub3QgdXNlIHRoZSBoaXN0b3J5IEFQSSBhdCBhbGwuCiAgICAgIC8vIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC9hbmRyb2lkL2lzc3Vlcy9kZXRhaWw/aWQ9MTc0NzEKICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvOTA0CgogICAgICAvLyBvbGRlciB3ZWJraXQgYnJvd3NlciAoNTMzLjkpIG9uIEJveGVlIGJveCBoYXMgZXhhY3RseSB0aGUgc2FtZSBwcm9ibGVtIGFzIEFuZHJvaWQgaGFzCiAgICAgIC8vIHNvIGxldCdzIG5vdCB1c2UgdGhlIGhpc3RvcnkgQVBJIGFsc28KICAgICAgLy8gV2UgYXJlIHB1cnBvc2VmdWxseSB1c2luZyBgIShhbmRyb2lkIDwgNClgIHRvIGNvdmVyIHRoZSBjYXNlIHdoZW4gYGFuZHJvaWRgIGlzIHVuZGVmaW5lZAogICAgICAvLyBqc2hpbnQgLVcwMTgKICAgICAgaGlzdG9yeTogISEoJHdpbmRvdy5oaXN0b3J5ICYmICR3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUgJiYgIShhbmRyb2lkIDwgNCkgJiYgIWJveGVlKSwKICAgICAgLy8ganNoaW50ICtXMDE4CiAgICAgIGhhc0V2ZW50OiBmdW5jdGlvbihldmVudCkgewogICAgICAgIC8vIElFOSBpbXBsZW1lbnRzICdpbnB1dCcgZXZlbnQgaXQncyBzbyBmdWJhcmVkIHRoYXQgd2UgcmF0aGVyIHByZXRlbmQgdGhhdCBpdCBkb2Vzbid0IGhhdmUKICAgICAgICAvLyBpdC4gSW4gcGFydGljdWxhciB0aGUgZXZlbnQgaXMgbm90IGZpcmVkIHdoZW4gYmFja3NwYWNlIG9yIGRlbGV0ZSBrZXkgYXJlIHByZXNzZWQgb3IKICAgICAgICAvLyB3aGVuIGN1dCBvcGVyYXRpb24gaXMgcGVyZm9ybWVkLgogICAgICAgIGlmIChldmVudCA9PSAnaW5wdXQnICYmIG1zaWUgPT0gOSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICBpZiAoaXNVbmRlZmluZWQoZXZlbnRTdXBwb3J0W2V2ZW50XSkpIHsKICAgICAgICAgIHZhciBkaXZFbG0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgIGV2ZW50U3VwcG9ydFtldmVudF0gPSAnb24nICsgZXZlbnQgaW4gZGl2RWxtOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGV2ZW50U3VwcG9ydFtldmVudF07CiAgICAgIH0sCiAgICAgIGNzcDogY3NwKCksCiAgICAgIHZlbmRvclByZWZpeDogdmVuZG9yUHJlZml4LAogICAgICB0cmFuc2l0aW9ucyA6IHRyYW5zaXRpb25zLAogICAgICBhbmltYXRpb25zIDogYW5pbWF0aW9ucywKICAgICAgYW5kcm9pZDogYW5kcm9pZAogICAgfTsKICB9XTsKfQoKdmFyICRjb21waWxlTWluRXJyID0gbWluRXJyKCckY29tcGlsZScpOwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICR0ZW1wbGF0ZVJlcXVlc3QKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgJHRlbXBsYXRlUmVxdWVzdGAgc2VydmljZSBkb3dubG9hZHMgdGhlIHByb3ZpZGVkIHRlbXBsYXRlIHVzaW5nIGAkaHR0cGAgYW5kLCB1cG9uIHN1Y2Nlc3MsCiAqIHN0b3JlcyB0aGUgY29udGVudHMgaW5zaWRlIG9mIGAkdGVtcGxhdGVDYWNoZWAuIElmIHRoZSBIVFRQIHJlcXVlc3QgZmFpbHMgb3IgdGhlIHJlc3BvbnNlIGRhdGEKICogb2YgdGhlIEhUVFAgcmVxdWVzdCBpcyBlbXB0eSB0aGVuIGEgYCRjb21waWxlYCBlcnJvciB3aWxsIGJlIHRocm93biAodGhlIGV4Y2VwdGlvbiBjYW4gYmUgdGh3YXJ0ZWQKICogYnkgc2V0dGluZyB0aGUgMm5kIHBhcmFtZXRlciBvZiB0aGUgZnVuY3Rpb24gdG8gdHJ1ZSkuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSB0cGwgVGhlIEhUVFAgcmVxdWVzdCB0ZW1wbGF0ZSBVUkwKICogQHBhcmFtIHtib29sZWFuPX0gaWdub3JlUmVxdWVzdEVycm9yIFdoZXRoZXIgb3Igbm90IHRvIGlnbm9yZSB0aGUgZXhjZXB0aW9uIHdoZW4gdGhlIHJlcXVlc3QgZmFpbHMgb3IgdGhlIHRlbXBsYXRlIGlzIGVtcHR5CiAqCiAqIEByZXR1cm4ge1Byb21pc2V9IHRoZSBIVFRQIFByb21pc2UgZm9yIHRoZSBnaXZlbi4KICoKICogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsUGVuZGluZ1JlcXVlc3RzIHRvdGFsIGFtb3VudCBvZiBwZW5kaW5nIHRlbXBsYXRlIHJlcXVlc3RzIGJlaW5nIGRvd25sb2FkZWQuCiAqLwpmdW5jdGlvbiAkVGVtcGxhdGVSZXF1ZXN0UHJvdmlkZXIoKSB7CiAgdGhpcy4kZ2V0ID0gWyckdGVtcGxhdGVDYWNoZScsICckaHR0cCcsICckcScsIGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlLCAkaHR0cCwgJHEpIHsKICAgIGZ1bmN0aW9uIGhhbmRsZVJlcXVlc3RGbih0cGwsIGlnbm9yZVJlcXVlc3RFcnJvcikgewogICAgICB2YXIgc2VsZiA9IGhhbmRsZVJlcXVlc3RGbjsKICAgICAgc2VsZi50b3RhbFBlbmRpbmdSZXF1ZXN0cysrOwoKICAgICAgcmV0dXJuICRodHRwLmdldCh0cGwsIHsgY2FjaGUgOiAkdGVtcGxhdGVDYWNoZSB9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICB2YXIgaHRtbCA9IHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICBpZighaHRtbCB8fCBodG1sLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gaGFuZGxlRXJyb3IoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBzZWxmLnRvdGFsUGVuZGluZ1JlcXVlc3RzLS07CiAgICAgICAgICAkdGVtcGxhdGVDYWNoZS5wdXQodHBsLCBodG1sKTsKICAgICAgICAgIHJldHVybiBodG1sOwogICAgICAgIH0sIGhhbmRsZUVycm9yKTsKCiAgICAgIGZ1bmN0aW9uIGhhbmRsZUVycm9yKCkgewogICAgICAgIHNlbGYudG90YWxQZW5kaW5nUmVxdWVzdHMtLTsKICAgICAgICBpZiAoIWlnbm9yZVJlcXVlc3RFcnJvcikgewogICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ3RwbG9hZCcsICdGYWlsZWQgdG8gbG9hZCB0ZW1wbGF0ZTogezB9JywgdHBsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICRxLnJlamVjdCgpOwogICAgICB9CiAgICB9CgogICAgaGFuZGxlUmVxdWVzdEZuLnRvdGFsUGVuZGluZ1JlcXVlc3RzID0gMDsKCiAgICByZXR1cm4gaGFuZGxlUmVxdWVzdEZuOwogIH1dOwp9CgpmdW5jdGlvbiAkJFRlc3RhYmlsaXR5UHJvdmlkZXIoKSB7CiAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRicm93c2VyJywgJyRsb2NhdGlvbicsCiAgICAgICBmdW5jdGlvbigkcm9vdFNjb3BlLCAgICRicm93c2VyLCAgICRsb2NhdGlvbikgewoKICAgIC8qKgogICAgICogQG5hbWUgJHRlc3RhYmlsaXR5CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgcHJpdmF0ZSAkJHRlc3RhYmlsaXR5IHNlcnZpY2UgcHJvdmlkZXMgYSBjb2xsZWN0aW9uIG9mIG1ldGhvZHMgZm9yIHVzZSB3aGVuIGRlYnVnZ2luZwogICAgICogb3IgYnkgYXV0b21hdGVkIHRlc3QgYW5kIGRlYnVnZ2luZyB0b29scy4KICAgICAqLwogICAgdmFyIHRlc3RhYmlsaXR5ID0ge307CgogICAgLyoqCiAgICAgKiBAbmFtZSAkJHRlc3RhYmlsaXR5I2ZpbmRCaW5kaW5ncwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJucyBhbiBhcnJheSBvZiBlbGVtZW50cyB0aGF0IGFyZSBib3VuZCAodmlhIG5nLWJpbmQgb3Ige3t9fSkKICAgICAqIHRvIGV4cHJlc3Npb25zIG1hdGNoaW5nIHRoZSBpbnB1dC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgVGhlIGVsZW1lbnQgcm9vdCB0byBzZWFyY2ggZnJvbS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFRoZSBiaW5kaW5nIGV4cHJlc3Npb24gdG8gbWF0Y2guCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IG9wdF9leGFjdE1hdGNoIElmIHRydWUsIG9ubHkgcmV0dXJucyBleGFjdCBtYXRjaGVzCiAgICAgKiAgICAgZm9yIHRoZSBleHByZXNzaW9uLiBGaWx0ZXJzIGFuZCB3aGl0ZXNwYWNlIGFyZSBpZ25vcmVkLgogICAgICovCiAgICB0ZXN0YWJpbGl0eS5maW5kQmluZGluZ3MgPSBmdW5jdGlvbihlbGVtZW50LCBleHByZXNzaW9uLCBvcHRfZXhhY3RNYXRjaCkgewogICAgICB2YXIgYmluZGluZ3MgPSBlbGVtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ25nLWJpbmRpbmcnKTsKICAgICAgdmFyIG1hdGNoZXMgPSBbXTsKICAgICAgZm9yRWFjaChiaW5kaW5ncywgZnVuY3Rpb24oYmluZGluZykgewogICAgICAgIHZhciBkYXRhQmluZGluZyA9IGFuZ3VsYXIuZWxlbWVudChiaW5kaW5nKS5kYXRhKCckYmluZGluZycpOwogICAgICAgIGlmIChkYXRhQmluZGluZykgewogICAgICAgICAgZm9yRWFjaChkYXRhQmluZGluZywgZnVuY3Rpb24oYmluZGluZ05hbWUpIHsKICAgICAgICAgICAgaWYgKG9wdF9leGFjdE1hdGNoKSB7CiAgICAgICAgICAgICAgdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKCcoXnxcXHMpJyArIGV4cHJlc3Npb24gKyAnKFxcc3xcXHx8JCknKTsKICAgICAgICAgICAgICBpZiAobWF0Y2hlci50ZXN0KGJpbmRpbmdOYW1lKSkgewogICAgICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKGJpbmRpbmcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoYmluZGluZ05hbWUuaW5kZXhPZihleHByZXNzaW9uKSAhPSAtMSkgewogICAgICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKGJpbmRpbmcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIG1hdGNoZXM7CiAgICB9OwoKICAgIC8qKgogICAgICogQG5hbWUgJCR0ZXN0YWJpbGl0eSNmaW5kTW9kZWxzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGFuIGFycmF5IG9mIGVsZW1lbnRzIHRoYXQgYXJlIHR3by13YXkgZm91bmQgdmlhIG5nLW1vZGVsIHRvCiAgICAgKiBleHByZXNzaW9ucyBtYXRjaGluZyB0aGUgaW5wdXQuCiAgICAgKgogICAgICogQHBhcmFtIHtFbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHJvb3QgdG8gc2VhcmNoIGZyb20uCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBUaGUgbW9kZWwgZXhwcmVzc2lvbiB0byBtYXRjaC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3B0X2V4YWN0TWF0Y2ggSWYgdHJ1ZSwgb25seSByZXR1cm5zIGV4YWN0IG1hdGNoZXMKICAgICAqICAgICBmb3IgdGhlIGV4cHJlc3Npb24uCiAgICAgKi8KICAgIHRlc3RhYmlsaXR5LmZpbmRNb2RlbHMgPSBmdW5jdGlvbihlbGVtZW50LCBleHByZXNzaW9uLCBvcHRfZXhhY3RNYXRjaCkgewogICAgICB2YXIgcHJlZml4ZXMgPSBbJ25nLScsICdkYXRhLW5nLScsICduZ1xcOiddOwogICAgICBmb3IgKHZhciBwID0gMDsgcCA8IHByZWZpeGVzLmxlbmd0aDsgKytwKSB7CiAgICAgICAgdmFyIGF0dHJpYnV0ZUVxdWFscyA9IG9wdF9leGFjdE1hdGNoID8gJz0nIDogJyo9JzsKICAgICAgICB2YXIgc2VsZWN0b3IgPSAnWycgKyBwcmVmaXhlc1twXSArICdtb2RlbCcgKyBhdHRyaWJ1dGVFcXVhbHMgKyAnIicgKyBleHByZXNzaW9uICsgJyJdJzsKICAgICAgICB2YXIgZWxlbWVudHMgPSBlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpOwogICAgICAgIGlmIChlbGVtZW50cy5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybiBlbGVtZW50czsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSAkJHRlc3RhYmlsaXR5I2dldExvY2F0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGN1dCBmb3IgZ2V0dGluZyB0aGUgbG9jYXRpb24gaW4gYSBicm93c2VyIGFnbm9zdGljIHdheS4gUmV0dXJucwogICAgICogICAgIHRoZSBwYXRoLCBzZWFyY2gsIGFuZCBoYXNoLiAoZS5nLiAvcGF0aD9hPWIjaGFzaCkKICAgICAqLwogICAgdGVzdGFiaWxpdHkuZ2V0TG9jYXRpb24gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICRsb2NhdGlvbi51cmwoKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSAkJHRlc3RhYmlsaXR5I3NldExvY2F0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGN1dCBmb3IgbmF2aWdhdGluZyB0byBhIGxvY2F0aW9uIHdpdGhvdXQgZG9pbmcgYSBmdWxsIHBhZ2UgcmVsb2FkLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIGxvY2F0aW9uIHVybCAocGF0aCwgc2VhcmNoIGFuZCBoYXNoLAogICAgICogICAgIGUuZy4gL3BhdGg/YT1iI2hhc2gpIHRvIGdvIHRvLgogICAgICovCiAgICB0ZXN0YWJpbGl0eS5zZXRMb2NhdGlvbiA9IGZ1bmN0aW9uKHVybCkgewogICAgICBpZiAodXJsICE9PSAkbG9jYXRpb24udXJsKCkpIHsKICAgICAgICAkbG9jYXRpb24udXJsKHVybCk7CiAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSAkJHRlc3RhYmlsaXR5I3doZW5TdGFibGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENhbGxzIHRoZSBjYWxsYmFjayB3aGVuICR0aW1lb3V0IGFuZCAkaHR0cCByZXF1ZXN0cyBhcmUgY29tcGxldGVkLgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrCiAgICAgKi8KICAgIHRlc3RhYmlsaXR5LndoZW5TdGFibGUgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAkYnJvd3Nlci5ub3RpZnlXaGVuTm9PdXRzdGFuZGluZ1JlcXVlc3RzKGNhbGxiYWNrKTsKICAgIH07CgogICAgcmV0dXJuIHRlc3RhYmlsaXR5OwogIH1dOwp9CgpmdW5jdGlvbiAkVGltZW91dFByb3ZpZGVyKCkgewogIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckYnJvd3NlcicsICckcScsICckJHEnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLAogICAgICAgZnVuY3Rpb24oJHJvb3RTY29wZSwgICAkYnJvd3NlciwgICAkcSwgICAkJHEsICAgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgIHZhciBkZWZlcnJlZHMgPSB7fTsKCgogICAgIC8qKgogICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgICogQG5hbWUgJHRpbWVvdXQKICAgICAgKgogICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAqIEFuZ3VsYXIncyB3cmFwcGVyIGZvciBgd2luZG93LnNldFRpbWVvdXRgLiBUaGUgYGZuYCBmdW5jdGlvbiBpcyB3cmFwcGVkIGludG8gYSB0cnkvY2F0Y2gKICAgICAgKiBibG9jayBhbmQgZGVsZWdhdGVzIGFueSBleGNlcHRpb25zIHRvCiAgICAgICoge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAqCiAgICAgICogVGhlIHJldHVybiB2YWx1ZSBvZiByZWdpc3RlcmluZyBhIHRpbWVvdXQgZnVuY3Rpb24gaXMgYSBwcm9taXNlLCB3aGljaCB3aWxsIGJlIHJlc29sdmVkIHdoZW4KICAgICAgKiB0aGUgdGltZW91dCBpcyByZWFjaGVkIGFuZCB0aGUgdGltZW91dCBmdW5jdGlvbiBpcyBleGVjdXRlZC4KICAgICAgKgogICAgICAqIFRvIGNhbmNlbCBhIHRpbWVvdXQgcmVxdWVzdCwgY2FsbCBgJHRpbWVvdXQuY2FuY2VsKHByb21pc2UpYC4KICAgICAgKgogICAgICAqIEluIHRlc3RzIHlvdSBjYW4gdXNlIHtAbGluayBuZ01vY2suJHRpbWVvdXQgYCR0aW1lb3V0LmZsdXNoKClgfSB0bwogICAgICAqIHN5bmNocm9ub3VzbHkgZmx1c2ggdGhlIHF1ZXVlIG9mIGRlZmVycmVkIGZ1bmN0aW9ucy4KICAgICAgKgogICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvc2UgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWxheWVkLgogICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIERlbGF5IGluIG1pbGxpc2Vjb25kcy4KICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBbaW52b2tlQXBwbHk9dHJ1ZV0gSWYgc2V0IHRvIGBmYWxzZWAgc2tpcHMgbW9kZWwgZGlydHkgY2hlY2tpbmcsIG90aGVyd2lzZQogICAgICAqICAgd2lsbCBpbnZva2UgYGZuYCB3aXRoaW4gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRhcHBseSAkYXBwbHl9IGJsb2NrLgogICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBQcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aGVuIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQuIFRoZSB2YWx1ZSB0aGlzCiAgICAgICogICBwcm9taXNlIHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCBpcyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBgZm5gIGZ1bmN0aW9uLgogICAgICAqCiAgICAgICovCiAgICBmdW5jdGlvbiB0aW1lb3V0KGZuLCBkZWxheSwgaW52b2tlQXBwbHkpIHsKICAgICAgdmFyIHNraXBBcHBseSA9IChpc0RlZmluZWQoaW52b2tlQXBwbHkpICYmICFpbnZva2VBcHBseSksCiAgICAgICAgICBkZWZlcnJlZCA9IChza2lwQXBwbHkgPyAkJHEgOiAkcSkuZGVmZXIoKSwKICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgdGltZW91dElkOwoKICAgICAgdGltZW91dElkID0gJGJyb3dzZXIuZGVmZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZm4oKSk7CiAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7CiAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICB9CiAgICAgICAgZmluYWxseSB7CiAgICAgICAgICBkZWxldGUgZGVmZXJyZWRzW3Byb21pc2UuJCR0aW1lb3V0SWRdOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFza2lwQXBwbHkpICRyb290U2NvcGUuJGFwcGx5KCk7CiAgICAgIH0sIGRlbGF5KTsKCiAgICAgIHByb21pc2UuJCR0aW1lb3V0SWQgPSB0aW1lb3V0SWQ7CiAgICAgIGRlZmVycmVkc1t0aW1lb3V0SWRdID0gZGVmZXJyZWQ7CgogICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KCgogICAgIC8qKgogICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgKiBAbmFtZSAkdGltZW91dCNjYW5jZWwKICAgICAgKgogICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAqIENhbmNlbHMgYSB0YXNrIGFzc29jaWF0ZWQgd2l0aCB0aGUgYHByb21pc2VgLiBBcyBhIHJlc3VsdCBvZiB0aGlzLCB0aGUgcHJvbWlzZSB3aWxsIGJlCiAgICAgICogcmVzb2x2ZWQgd2l0aCBhIHJlamVjdGlvbi4KICAgICAgKgogICAgICAqIEBwYXJhbSB7UHJvbWlzZT19IHByb21pc2UgUHJvbWlzZSByZXR1cm5lZCBieSB0aGUgYCR0aW1lb3V0YCBmdW5jdGlvbi4KICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHRhc2sgaGFzbid0IGV4ZWN1dGVkIHlldCBhbmQgd2FzIHN1Y2Nlc3NmdWxseQogICAgICAqICAgY2FuY2VsZWQuCiAgICAgICovCiAgICB0aW1lb3V0LmNhbmNlbCA9IGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAgaWYgKHByb21pc2UgJiYgcHJvbWlzZS4kJHRpbWVvdXRJZCBpbiBkZWZlcnJlZHMpIHsKICAgICAgICBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF0ucmVqZWN0KCdjYW5jZWxlZCcpOwogICAgICAgIGRlbGV0ZSBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF07CiAgICAgICAgcmV0dXJuICRicm93c2VyLmRlZmVyLmNhbmNlbChwcm9taXNlLiQkdGltZW91dElkKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIHJldHVybiB0aW1lb3V0OwogIH1dOwp9CgovLyBOT1RFOiAgVGhlIHVzYWdlIG9mIHdpbmRvdyBhbmQgZG9jdW1lbnQgaW5zdGVhZCBvZiAkd2luZG93IGFuZCAkZG9jdW1lbnQgaGVyZSBpcwovLyBkZWxpYmVyYXRlLiAgVGhpcyBzZXJ2aWNlIGRlcGVuZHMgb24gdGhlIHNwZWNpZmljIGJlaGF2aW9yIG9mIGFuY2hvciBub2RlcyBjcmVhdGVkIGJ5IHRoZQovLyBicm93c2VyIChyZXNvbHZpbmcgYW5kIHBhcnNpbmcgVVJMcykgdGhhdCBpcyB1bmxpa2VseSB0byBiZSBwcm92aWRlZCBieSBtb2NrIG9iamVjdHMgYW5kCi8vIGNhdXNlIHVzIHRvIGJyZWFrIHRlc3RzLiAgSW4gYWRkaXRpb24sIHdoZW4gdGhlIGJyb3dzZXIgcmVzb2x2ZXMgYSBVUkwgZm9yIFhIUiwgaXQKLy8gZG9lc24ndCBrbm93IGFib3V0IG1vY2tlZCBsb2NhdGlvbnMgYW5kIHJlc29sdmVzIFVSTHMgdG8gdGhlIHJlYWwgZG9jdW1lbnQgLSB3aGljaCBpcwovLyBleGFjdGx5IHRoZSBiZWhhdmlvciBuZWVkZWQgaGVyZS4gIFRoZXJlIGlzIGxpdHRsZSB2YWx1ZSBpcyBtb2NraW5nIHRoZXNlIG91dCBmb3IgdGhpcwovLyBzZXJ2aWNlLgp2YXIgdXJsUGFyc2luZ05vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CnZhciBvcmlnaW5VcmwgPSB1cmxSZXNvbHZlKHdpbmRvdy5sb2NhdGlvbi5ocmVmLCB0cnVlKTsKCgovKioKICoKICogSW1wbGVtZW50YXRpb24gTm90ZXMgZm9yIG5vbi1JRSBicm93c2VycwogKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAqIEFzc2lnbmluZyBhIFVSTCB0byB0aGUgaHJlZiBwcm9wZXJ0eSBvZiBhbiBhbmNob3IgRE9NIG5vZGUsIGV2ZW4gb25lIGF0dGFjaGVkIHRvIHRoZSBET00sCiAqIHJlc3VsdHMgYm90aCBpbiB0aGUgbm9ybWFsaXppbmcgYW5kIHBhcnNpbmcgb2YgdGhlIFVSTC4gIE5vcm1hbGl6aW5nIG1lYW5zIHRoYXQgYSByZWxhdGl2ZQogKiBVUkwgd2lsbCBiZSByZXNvbHZlZCBpbnRvIGFuIGFic29sdXRlIFVSTCBpbiB0aGUgY29udGV4dCBvZiB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQuCiAqIFBhcnNpbmcgbWVhbnMgdGhhdCB0aGUgYW5jaG9yIG5vZGUncyBob3N0LCBob3N0bmFtZSwgcHJvdG9jb2wsIHBvcnQsIHBhdGhuYW1lIGFuZCByZWxhdGVkCiAqIHByb3BlcnRpZXMgYXJlIGFsbCBwb3B1bGF0ZWQgdG8gcmVmbGVjdCB0aGUgbm9ybWFsaXplZCBVUkwuICBUaGlzIGFwcHJvYWNoIGhhcyB3aWRlCiAqIGNvbXBhdGliaWxpdHkgLSBTYWZhcmkgMSssIE1vemlsbGEgMSssIE9wZXJhIDcrLGUgZXRjLiAgU2VlCiAqIGh0dHA6Ly93d3cuYXB0YW5hLmNvbS9yZWZlcmVuY2UvaHRtbC9hcGkvSFRNTEFuY2hvckVsZW1lbnQuaHRtbAogKgogKiBJbXBsZW1lbnRhdGlvbiBOb3RlcyBmb3IgSUUKICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAqIElFID49IDggYW5kIDw9IDEwIG5vcm1hbGl6ZXMgdGhlIFVSTCB3aGVuIGFzc2lnbmVkIHRvIHRoZSBhbmNob3Igbm9kZSBzaW1pbGFyIHRvIHRoZSBvdGhlcgogKiBicm93c2Vycy4gIEhvd2V2ZXIsIHRoZSBwYXJzZWQgY29tcG9uZW50cyB3aWxsIG5vdCBiZSBzZXQgaWYgdGhlIFVSTCBhc3NpZ25lZCBkaWQgbm90IHNwZWNpZnkKICogdGhlbS4gIChlLmcuIGlmIHlvdSBhc3NpZ24gYS5ocmVmID0gImZvbyIsIHRoZW4gYS5wcm90b2NvbCwgYS5ob3N0LCBldGMuIHdpbGwgYmUgZW1wdHkuKSAgV2UKICogd29yayBhcm91bmQgdGhhdCBieSBwZXJmb3JtaW5nIHRoZSBwYXJzaW5nIGluIGEgMm5kIHN0ZXAgYnkgdGFraW5nIGEgcHJldmlvdXNseSBub3JtYWxpemVkCiAqIFVSTCAoZS5nLiBieSBhc3NpZ25pbmcgdG8gYS5ocmVmKSBhbmQgYXNzaWduaW5nIGl0IGEuaHJlZiBhZ2Fpbi4gIFRoaXMgY29ycmVjdGx5IHBvcHVsYXRlcyB0aGUKICogcHJvcGVydGllcyBzdWNoIGFzIHByb3RvY29sLCBob3N0bmFtZSwgcG9ydCwgZXRjLgogKgogKiBJRTcgZG9lcyBub3Qgbm9ybWFsaXplIHRoZSBVUkwgd2hlbiBhc3NpZ25lZCB0byBhbiBhbmNob3Igbm9kZS4gIChBcHBhcmVudGx5LCBpdCBkb2VzLCBpZiBvbmUKICogdXNlcyB0aGUgaW5uZXIgSFRNTCBhcHByb2FjaCB0byBhc3NpZ24gdGhlIFVSTCBhcyBwYXJ0IG9mIGFuIEhUTUwgc25pcHBldCAtCiAqIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzQ3MjcyOSkgIEhvd2V2ZXIsIHNldHRpbmcgaW1nW3NyY10gZG9lcyBub3JtYWxpemUgdGhlIFVSTC4KICogVW5mb3J0dW5hdGVseSwgc2V0dGluZyBpbWdbc3JjXSB0byBzb21ldGhpbmcgbGlrZSAiamF2YXNjcmlwdDpmb28iIG9uIElFIHRocm93cyBhbiBleGNlcHRpb24uCiAqIFNpbmNlIHRoZSBwcmltYXJ5IHVzYWdlIGZvciBub3JtYWxpemluZyBVUkxzIGlzIHRvIHNhbml0aXplIHN1Y2ggVVJMcywgd2UgY2FuJ3QgdXNlIHRoYXQKICogbWV0aG9kIGFuZCBJRSA8IDggaXMgdW5zdXBwb3J0ZWQuCiAqCiAqIFJlZmVyZW5jZXM6CiAqICAgaHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvSFRNTEFuY2hvckVsZW1lbnQKICogICBodHRwOi8vd3d3LmFwdGFuYS5jb20vcmVmZXJlbmNlL2h0bWwvYXBpL0hUTUxBbmNob3JFbGVtZW50Lmh0bWwKICogICBodHRwOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jdXJsdXRpbHMKICogICBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL3B1bGwvMjkwMgogKiAgIGh0dHA6Ly9qYW1lcy5wYWRvbHNleS5jb20vamF2YXNjcmlwdC9wYXJzaW5nLXVybHMtd2l0aC10aGUtZG9tLwogKgogKiBAa2luZCBmdW5jdGlvbgogKiBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSBVUkwgdG8gYmUgcGFyc2VkLgogKiBAZGVzY3JpcHRpb24gTm9ybWFsaXplcyBhbmQgcGFyc2VzIGEgVVJMLgogKiBAcmV0dXJucyB7b2JqZWN0fSBSZXR1cm5zIHRoZSBub3JtYWxpemVkIFVSTCBhcyBhIGRpY3Rpb25hcnkuCiAqCiAqICAgfCBtZW1iZXIgbmFtZSAgIHwgRGVzY3JpcHRpb24gICAgfAogKiAgIHwtLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLXwKICogICB8IGhyZWYgICAgICAgICAgfCBBIG5vcm1hbGl6ZWQgdmVyc2lvbiBvZiB0aGUgcHJvdmlkZWQgVVJMIGlmIGl0IHdhcyBub3QgYW4gYWJzb2x1dGUgVVJMIHwKICogICB8IHByb3RvY29sICAgICAgfCBUaGUgcHJvdG9jb2wgaW5jbHVkaW5nIHRoZSB0cmFpbGluZyBjb2xvbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogICB8IGhvc3QgICAgICAgICAgfCBUaGUgaG9zdCBhbmQgcG9ydCAoaWYgdGhlIHBvcnQgaXMgbm9uLWRlZmF1bHQpIG9mIHRoZSBub3JtYWxpemVkVXJsICAgIHwKICogICB8IHNlYXJjaCAgICAgICAgfCBUaGUgc2VhcmNoIHBhcmFtcywgbWludXMgdGhlIHF1ZXN0aW9uIG1hcmsgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogICB8IGhhc2ggICAgICAgICAgfCBUaGUgaGFzaCBzdHJpbmcsIG1pbnVzIHRoZSBoYXNoIHN5bWJvbAogKiAgIHwgaG9zdG5hbWUgICAgICB8IFRoZSBob3N0bmFtZQogKiAgIHwgcG9ydCAgICAgICAgICB8IFRoZSBwb3J0LCB3aXRob3V0ICI6IgogKiAgIHwgcGF0aG5hbWUgICAgICB8IFRoZSBwYXRobmFtZSwgYmVnaW5uaW5nIHdpdGggIi8iCiAqCiAqLwpmdW5jdGlvbiB1cmxSZXNvbHZlKHVybCwgYmFzZSkgewogIHZhciBocmVmID0gdXJsOwoKICBpZiAobXNpZSkgewogICAgLy8gTm9ybWFsaXplIGJlZm9yZSBwYXJzZS4gIFJlZmVyIEltcGxlbWVudGF0aW9uIE5vdGVzIG9uIHdoeSB0aGlzIGlzCiAgICAvLyBkb25lIGluIHR3byBzdGVwcyBvbiBJRS4KICAgIHVybFBhcnNpbmdOb2RlLnNldEF0dHJpYnV0ZSgiaHJlZiIsIGhyZWYpOwogICAgaHJlZiA9IHVybFBhcnNpbmdOb2RlLmhyZWY7CiAgfQoKICB1cmxQYXJzaW5nTm9kZS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBocmVmKTsKCiAgLy8gdXJsUGFyc2luZ05vZGUgcHJvdmlkZXMgdGhlIFVybFV0aWxzIGludGVyZmFjZSAtIGh0dHA6Ly91cmwuc3BlYy53aGF0d2cub3JnLyN1cmx1dGlscwogIHJldHVybiB7CiAgICBocmVmOiB1cmxQYXJzaW5nTm9kZS5ocmVmLAogICAgcHJvdG9jb2w6IHVybFBhcnNpbmdOb2RlLnByb3RvY29sID8gdXJsUGFyc2luZ05vZGUucHJvdG9jb2wucmVwbGFjZSgvOiQvLCAnJykgOiAnJywKICAgIGhvc3Q6IHVybFBhcnNpbmdOb2RlLmhvc3QsCiAgICBzZWFyY2g6IHVybFBhcnNpbmdOb2RlLnNlYXJjaCA/IHVybFBhcnNpbmdOb2RlLnNlYXJjaC5yZXBsYWNlKC9eXD8vLCAnJykgOiAnJywKICAgIGhhc2g6IHVybFBhcnNpbmdOb2RlLmhhc2ggPyB1cmxQYXJzaW5nTm9kZS5oYXNoLnJlcGxhY2UoL14jLywgJycpIDogJycsCiAgICBob3N0bmFtZTogdXJsUGFyc2luZ05vZGUuaG9zdG5hbWUsCiAgICBwb3J0OiB1cmxQYXJzaW5nTm9kZS5wb3J0LAogICAgcGF0aG5hbWU6ICh1cmxQYXJzaW5nTm9kZS5wYXRobmFtZS5jaGFyQXQoMCkgPT09ICcvJykKICAgICAgPyB1cmxQYXJzaW5nTm9kZS5wYXRobmFtZQogICAgICA6ICcvJyArIHVybFBhcnNpbmdOb2RlLnBhdGhuYW1lCiAgfTsKfQoKLyoqCiAqIFBhcnNlIGEgcmVxdWVzdCBVUkwgYW5kIGRldGVybWluZSB3aGV0aGVyIHRoaXMgaXMgYSBzYW1lLW9yaWdpbiByZXF1ZXN0IGFzIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudC4KICoKICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSByZXF1ZXN0VXJsIFRoZSB1cmwgb2YgdGhlIHJlcXVlc3QgYXMgYSBzdHJpbmcgdGhhdCB3aWxsIGJlIHJlc29sdmVkCiAqIG9yIGEgcGFyc2VkIFVSTCBvYmplY3QuCiAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSByZXF1ZXN0IGlzIGZvciB0aGUgc2FtZSBvcmlnaW4gYXMgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50LgogKi8KZnVuY3Rpb24gdXJsSXNTYW1lT3JpZ2luKHJlcXVlc3RVcmwpIHsKICB2YXIgcGFyc2VkID0gKGlzU3RyaW5nKHJlcXVlc3RVcmwpKSA/IHVybFJlc29sdmUocmVxdWVzdFVybCkgOiByZXF1ZXN0VXJsOwogIHJldHVybiAocGFyc2VkLnByb3RvY29sID09PSBvcmlnaW5VcmwucHJvdG9jb2wgJiYKICAgICAgICAgIHBhcnNlZC5ob3N0ID09PSBvcmlnaW5VcmwuaG9zdCk7Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkd2luZG93CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIHJlZmVyZW5jZSB0byB0aGUgYnJvd3NlcidzIGB3aW5kb3dgIG9iamVjdC4gV2hpbGUgYHdpbmRvd2AKICogaXMgZ2xvYmFsbHkgYXZhaWxhYmxlIGluIEphdmFTY3JpcHQsIGl0IGNhdXNlcyB0ZXN0YWJpbGl0eSBwcm9ibGVtcywgYmVjYXVzZQogKiBpdCBpcyBhIGdsb2JhbCB2YXJpYWJsZS4gSW4gYW5ndWxhciB3ZSBhbHdheXMgcmVmZXIgdG8gaXQgdGhyb3VnaCB0aGUKICogYCR3aW5kb3dgIHNlcnZpY2UsIHNvIGl0IG1heSBiZSBvdmVycmlkZGVuLCByZW1vdmVkIG9yIG1vY2tlZCBmb3IgdGVzdGluZy4KICoKICogRXhwcmVzc2lvbnMsIGxpa2UgdGhlIG9uZSBkZWZpbmVkIGZvciB0aGUgYG5nQ2xpY2tgIGRpcmVjdGl2ZSBpbiB0aGUgZXhhbXBsZQogKiBiZWxvdywgYXJlIGV2YWx1YXRlZCB3aXRoIHJlc3BlY3QgdG8gdGhlIGN1cnJlbnQgc2NvcGUuICBUaGVyZWZvcmUsIHRoZXJlIGlzCiAqIG5vIHJpc2sgb2YgaW5hZHZlcnRlbnRseSBjb2RpbmcgaW4gYSBkZXBlbmRlbmN5IG9uIGEgZ2xvYmFsIHZhbHVlIGluIHN1Y2ggYW4KICogZXhwcmVzc2lvbi4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJ3aW5kb3dFeGFtcGxlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCd3aW5kb3dFeGFtcGxlJywgW10pCiAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCAnJHdpbmRvdycsIGZ1bmN0aW9uICgkc2NvcGUsICR3aW5kb3cpIHsKICAgICAgICAgICAgICRzY29wZS5ncmVldGluZyA9ICdIZWxsbywgV29ybGQhJzsKICAgICAgICAgICAgICRzY29wZS5kb0dyZWV0aW5nID0gZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICAgICAgICAgICAgICAgJHdpbmRvdy5hbGVydChncmVldGluZyk7CiAgICAgICAgICAgICB9OwogICAgICAgICAgIH1dKTsKICAgICAgIDwvc2NyaXB0PgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0iZ3JlZXRpbmciIC8+CiAgICAgICAgIDxidXR0b24gbmctY2xpY2s9ImRvR3JlZXRpbmcoZ3JlZXRpbmcpIj5BTEVSVDwvYnV0dG9uPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICBpdCgnc2hvdWxkIGRpc3BsYXkgdGhlIGdyZWV0aW5nIGluIHRoZSBpbnB1dCBib3gnLCBmdW5jdGlvbigpIHsKICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2dyZWV0aW5nJykpLnNlbmRLZXlzKCdIZWxsbywgRTJFIFRlc3RzJyk7CiAgICAgICAvLyBJZiB3ZSBjbGljayB0aGUgYnV0dG9uIGl0IHdpbGwgYmxvY2sgdGhlIHRlc3QgcnVubmVyCiAgICAgICAvLyBlbGVtZW50KCc6YnV0dG9uJykuY2xpY2soKTsKICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwpmdW5jdGlvbiAkV2luZG93UHJvdmlkZXIoKXsKICB0aGlzLiRnZXQgPSB2YWx1ZUZuKHdpbmRvdyk7Cn0KCi8qIGdsb2JhbCBjdXJyZW5jeUZpbHRlcjogdHJ1ZSwKIGRhdGVGaWx0ZXI6IHRydWUsCiBmaWx0ZXJGaWx0ZXI6IHRydWUsCiBqc29uRmlsdGVyOiB0cnVlLAogbGltaXRUb0ZpbHRlcjogdHJ1ZSwKIGxvd2VyY2FzZUZpbHRlcjogdHJ1ZSwKIG51bWJlckZpbHRlcjogdHJ1ZSwKIG9yZGVyQnlGaWx0ZXI6IHRydWUsCiB1cHBlcmNhc2VGaWx0ZXI6IHRydWUsCiAqLwoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkZmlsdGVyUHJvdmlkZXIKICogQGRlc2NyaXB0aW9uCiAqCiAqIEZpbHRlcnMgYXJlIGp1c3QgZnVuY3Rpb25zIHdoaWNoIHRyYW5zZm9ybSBpbnB1dCB0byBhbiBvdXRwdXQuIEhvd2V2ZXIgZmlsdGVycyBuZWVkIHRvIGJlCiAqIERlcGVuZGVuY3kgSW5qZWN0ZWQuIFRvIGFjaGlldmUgdGhpcyBhIGZpbHRlciBkZWZpbml0aW9uIGNvbnNpc3RzIG9mIGEgZmFjdG9yeSBmdW5jdGlvbiB3aGljaCBpcwogKiBhbm5vdGF0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgYW5kIGlzIHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyBhIGZpbHRlciBmdW5jdGlvbi4KICoKICogYGBganMKICogICAvLyBGaWx0ZXIgcmVnaXN0cmF0aW9uCiAqICAgZnVuY3Rpb24gTXlNb2R1bGUoJHByb3ZpZGUsICRmaWx0ZXJQcm92aWRlcikgewogKiAgICAgLy8gY3JlYXRlIGEgc2VydmljZSB0byBkZW1vbnN0cmF0ZSBpbmplY3Rpb24gKG5vdCBhbHdheXMgbmVlZGVkKQogKiAgICAgJHByb3ZpZGUudmFsdWUoJ2dyZWV0JywgZnVuY3Rpb24obmFtZSl7CiAqICAgICAgIHJldHVybiAnSGVsbG8gJyArIG5hbWUgKyAnISc7CiAqICAgICB9KTsKICoKICogICAgIC8vIHJlZ2lzdGVyIGEgZmlsdGVyIGZhY3Rvcnkgd2hpY2ggdXNlcyB0aGUKICogICAgIC8vIGdyZWV0IHNlcnZpY2UgdG8gZGVtb25zdHJhdGUgREkuCiAqICAgICAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoJ2dyZWV0JywgZnVuY3Rpb24oZ3JlZXQpewogKiAgICAgICAvLyByZXR1cm4gdGhlIGZpbHRlciBmdW5jdGlvbiB3aGljaCB1c2VzIHRoZSBncmVldCBzZXJ2aWNlCiAqICAgICAgIC8vIHRvIGdlbmVyYXRlIHNhbHV0YXRpb24KICogICAgICAgcmV0dXJuIGZ1bmN0aW9uKHRleHQpIHsKICogICAgICAgICAvLyBmaWx0ZXJzIG5lZWQgdG8gYmUgZm9yZ2l2aW5nIHNvIGNoZWNrIGlucHV0IHZhbGlkaXR5CiAqICAgICAgICAgcmV0dXJuIHRleHQgJiYgZ3JlZXQodGV4dCkgfHwgdGV4dDsKICogICAgICAgfTsKICogICAgIH0pOwogKiAgIH0KICogYGBgCiAqCiAqIFRoZSBmaWx0ZXIgZnVuY3Rpb24gaXMgcmVnaXN0ZXJlZCB3aXRoIHRoZSBgJGluamVjdG9yYCB1bmRlciB0aGUgZmlsdGVyIG5hbWUgc3VmZml4IHdpdGgKICogYEZpbHRlcmAuCiAqCiAqIGBgYGpzCiAqICAgaXQoJ3Nob3VsZCBiZSB0aGUgc2FtZSBpbnN0YW5jZScsIGluamVjdCgKICogICAgIGZ1bmN0aW9uKCRmaWx0ZXJQcm92aWRlcikgewogKiAgICAgICAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoJ3JldmVyc2UnLCBmdW5jdGlvbigpewogKiAgICAgICAgIHJldHVybiAuLi47CiAqICAgICAgIH0pOwogKiAgICAgfSwKICogICAgIGZ1bmN0aW9uKCRmaWx0ZXIsIHJldmVyc2VGaWx0ZXIpIHsKICogICAgICAgZXhwZWN0KCRmaWx0ZXIoJ3JldmVyc2UnKSkudG9CZShyZXZlcnNlRmlsdGVyKTsKICogICAgIH0pOwogKiBgYGAKICoKICoKICogRm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgaG93IGFuZ3VsYXIgZmlsdGVycyB3b3JrLCBhbmQgaG93IHRvIGNyZWF0ZSB5b3VyIG93biBmaWx0ZXJzLCBzZWUKICoge0BsaW5rIGd1aWRlL2ZpbHRlciBGaWx0ZXJzfSBpbiB0aGUgQW5ndWxhciBEZXZlbG9wZXIgR3VpZGUuCiAqLwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRmaWx0ZXIKICogQGtpbmQgZnVuY3Rpb24KICogQGRlc2NyaXB0aW9uCiAqIEZpbHRlcnMgYXJlIHVzZWQgZm9yIGZvcm1hdHRpbmcgZGF0YSBkaXNwbGF5ZWQgdG8gdGhlIHVzZXIuCiAqCiAqIFRoZSBnZW5lcmFsIHN5bnRheCBpbiB0ZW1wbGF0ZXMgaXMgYXMgZm9sbG93czoKICoKICogICAgICAgICB7eyBleHByZXNzaW9uIFt8IGZpbHRlcl9uYW1lWzpwYXJhbWV0ZXJfdmFsdWVdIC4uLiBdIH19CiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGZpbHRlciBmdW5jdGlvbiB0byByZXRyaWV2ZQogKiBAcmV0dXJuIHtGdW5jdGlvbn0gdGhlIGZpbHRlciBmdW5jdGlvbgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBuYW1lPSIkZmlsdGVyIiBtb2R1bGU9ImZpbHRlckV4YW1wbGUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJNYWluQ3RybCI+CiAgICAgICAgPGgzPnt7IG9yaWdpbmFsVGV4dCB9fTwvaDM+CiAgICAgICAgPGgzPnt7IGZpbHRlcmVkVGV4dCB9fTwvaDM+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgIGFuZ3VsYXIubW9kdWxlKCdmaWx0ZXJFeGFtcGxlJywgW10pCiAgICAgIC5jb250cm9sbGVyKCdNYWluQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSwgJGZpbHRlcikgewogICAgICAgICRzY29wZS5vcmlnaW5hbFRleHQgPSAnaGVsbG8nOwogICAgICAgICRzY29wZS5maWx0ZXJlZFRleHQgPSAkZmlsdGVyKCd1cHBlcmNhc2UnKSgkc2NvcGUub3JpZ2luYWxUZXh0KTsKICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgKi8KJEZpbHRlclByb3ZpZGVyLiRpbmplY3QgPSBbJyRwcm92aWRlJ107CmZ1bmN0aW9uICRGaWx0ZXJQcm92aWRlcigkcHJvdmlkZSkgewogIHZhciBzdWZmaXggPSAnRmlsdGVyJzsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRmaWx0ZXJQcm92aWRlciNyZWdpc3RlcgogICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdH0gbmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXIgZnVuY3Rpb24sIG9yIGFuIG9iamVjdCBtYXAgb2YgZmlsdGVycyB3aGVyZQogICAqICAgIHRoZSBrZXlzIGFyZSB0aGUgZmlsdGVyIG5hbWVzIGFuZCB0aGUgdmFsdWVzIGFyZSB0aGUgZmlsdGVyIGZhY3Rvcmllcy4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZWdpc3RlcmVkIGZpbHRlciBpbnN0YW5jZSwgb3IgaWYgYSBtYXAgb2YgZmlsdGVycyB3YXMgcHJvdmlkZWQgdGhlbiBhIG1hcAogICAqICAgIG9mIHRoZSByZWdpc3RlcmVkIGZpbHRlciBpbnN0YW5jZXMuCiAgICovCiAgZnVuY3Rpb24gcmVnaXN0ZXIobmFtZSwgZmFjdG9yeSkgewogICAgaWYoaXNPYmplY3QobmFtZSkpIHsKICAgICAgdmFyIGZpbHRlcnMgPSB7fTsKICAgICAgZm9yRWFjaChuYW1lLCBmdW5jdGlvbihmaWx0ZXIsIGtleSkgewogICAgICAgIGZpbHRlcnNba2V5XSA9IHJlZ2lzdGVyKGtleSwgZmlsdGVyKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBmaWx0ZXJzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICRwcm92aWRlLmZhY3RvcnkobmFtZSArIHN1ZmZpeCwgZmFjdG9yeSk7CiAgICB9CiAgfQogIHRoaXMucmVnaXN0ZXIgPSByZWdpc3RlcjsKCiAgdGhpcy4kZ2V0ID0gWyckaW5qZWN0b3InLCBmdW5jdGlvbigkaW5qZWN0b3IpIHsKICAgIHJldHVybiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHJldHVybiAkaW5qZWN0b3IuZ2V0KG5hbWUgKyBzdWZmaXgpOwogICAgfTsKICB9XTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAvKiBnbG9iYWwKICAgIGN1cnJlbmN5RmlsdGVyOiBmYWxzZSwKICAgIGRhdGVGaWx0ZXI6IGZhbHNlLAogICAgZmlsdGVyRmlsdGVyOiBmYWxzZSwKICAgIGpzb25GaWx0ZXI6IGZhbHNlLAogICAgbGltaXRUb0ZpbHRlcjogZmFsc2UsCiAgICBsb3dlcmNhc2VGaWx0ZXI6IGZhbHNlLAogICAgbnVtYmVyRmlsdGVyOiBmYWxzZSwKICAgIG9yZGVyQnlGaWx0ZXI6IGZhbHNlLAogICAgdXBwZXJjYXNlRmlsdGVyOiBmYWxzZSwKICAqLwoKICByZWdpc3RlcignY3VycmVuY3knLCBjdXJyZW5jeUZpbHRlcik7CiAgcmVnaXN0ZXIoJ2RhdGUnLCBkYXRlRmlsdGVyKTsKICByZWdpc3RlcignZmlsdGVyJywgZmlsdGVyRmlsdGVyKTsKICByZWdpc3RlcignanNvbicsIGpzb25GaWx0ZXIpOwogIHJlZ2lzdGVyKCdsaW1pdFRvJywgbGltaXRUb0ZpbHRlcik7CiAgcmVnaXN0ZXIoJ2xvd2VyY2FzZScsIGxvd2VyY2FzZUZpbHRlcik7CiAgcmVnaXN0ZXIoJ251bWJlcicsIG51bWJlckZpbHRlcik7CiAgcmVnaXN0ZXIoJ29yZGVyQnknLCBvcmRlckJ5RmlsdGVyKTsKICByZWdpc3RlcigndXBwZXJjYXNlJywgdXBwZXJjYXNlRmlsdGVyKTsKfQoKLyoqCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgZmlsdGVyCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTZWxlY3RzIGEgc3Vic2V0IG9mIGl0ZW1zIGZyb20gYGFycmF5YCBhbmQgcmV0dXJucyBpdCBhcyBhIG5ldyBhcnJheS4KICoKICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIHNvdXJjZSBhcnJheS4KICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fGZ1bmN0aW9uKCl9IGV4cHJlc3Npb24gVGhlIHByZWRpY2F0ZSB0byBiZSB1c2VkIGZvciBzZWxlY3RpbmcgaXRlbXMgZnJvbQogKiAgIGBhcnJheWAuCiAqCiAqICAgQ2FuIGJlIG9uZSBvZjoKICoKICogICAtIGBzdHJpbmdgOiBUaGUgc3RyaW5nIGlzIGV2YWx1YXRlZCBhcyBhbiBleHByZXNzaW9uIGFuZCB0aGUgcmVzdWx0aW5nIHZhbHVlIGlzIHVzZWQgZm9yIHN1YnN0cmluZyBtYXRjaCBhZ2FpbnN0CiAqICAgICB0aGUgY29udGVudHMgb2YgdGhlIGBhcnJheWAuIEFsbCBzdHJpbmdzIG9yIG9iamVjdHMgd2l0aCBzdHJpbmcgcHJvcGVydGllcyBpbiBgYXJyYXlgIHRoYXQgY29udGFpbiB0aGlzIHN0cmluZwogKiAgICAgd2lsbCBiZSByZXR1cm5lZC4gVGhlIHByZWRpY2F0ZSBjYW4gYmUgbmVnYXRlZCBieSBwcmVmaXhpbmcgdGhlIHN0cmluZyB3aXRoIGAhYC4KICoKICogICAtIGBPYmplY3RgOiBBIHBhdHRlcm4gb2JqZWN0IGNhbiBiZSB1c2VkIHRvIGZpbHRlciBzcGVjaWZpYyBwcm9wZXJ0aWVzIG9uIG9iamVjdHMgY29udGFpbmVkCiAqICAgICBieSBgYXJyYXlgLiBGb3IgZXhhbXBsZSBge25hbWU6Ik0iLCBwaG9uZToiMSJ9YCBwcmVkaWNhdGUgd2lsbCByZXR1cm4gYW4gYXJyYXkgb2YgaXRlbXMKICogICAgIHdoaWNoIGhhdmUgcHJvcGVydHkgYG5hbWVgIGNvbnRhaW5pbmcgIk0iIGFuZCBwcm9wZXJ0eSBgcGhvbmVgIGNvbnRhaW5pbmcgIjEiLiBBIHNwZWNpYWwKICogICAgIHByb3BlcnR5IG5hbWUgYCRgIGNhbiBiZSB1c2VkIChhcyBpbiBgeyQ6InRleHQifWApIHRvIGFjY2VwdCBhIG1hdGNoIGFnYWluc3QgYW55CiAqICAgICBwcm9wZXJ0eSBvZiB0aGUgb2JqZWN0LiBUaGF0J3MgZXF1aXZhbGVudCB0byB0aGUgc2ltcGxlIHN1YnN0cmluZyBtYXRjaCB3aXRoIGEgYHN0cmluZ2AKICogICAgIGFzIGRlc2NyaWJlZCBhYm92ZS4gVGhlIHByZWRpY2F0ZSBjYW4gYmUgbmVnYXRlZCBieSBwcmVmaXhpbmcgdGhlIHN0cmluZyB3aXRoIGAhYC4KICogICAgIEZvciBFeGFtcGxlIGB7bmFtZTogIiFNIn1gIHByZWRpY2F0ZSB3aWxsIHJldHVybiBhbiBhcnJheSBvZiBpdGVtcyB3aGljaCBoYXZlIHByb3BlcnR5IGBuYW1lYAogKiAgICAgbm90IGNvbnRhaW5pbmcgIk0iLgogKgogKiAgIC0gYGZ1bmN0aW9uKHZhbHVlLCBpbmRleClgOiBBIHByZWRpY2F0ZSBmdW5jdGlvbiBjYW4gYmUgdXNlZCB0byB3cml0ZSBhcmJpdHJhcnkgZmlsdGVycy4gVGhlCiAqICAgICBmdW5jdGlvbiBpcyBjYWxsZWQgZm9yIGVhY2ggZWxlbWVudCBvZiBgYXJyYXlgLiBUaGUgZmluYWwgcmVzdWx0IGlzIGFuIGFycmF5IG9mIHRob3NlCiAqICAgICBlbGVtZW50cyB0aGF0IHRoZSBwcmVkaWNhdGUgcmV0dXJuZWQgdHJ1ZSBmb3IuCiAqCiAqIEBwYXJhbSB7ZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCl8dHJ1ZXx1bmRlZmluZWR9IGNvbXBhcmF0b3IgQ29tcGFyYXRvciB3aGljaCBpcyB1c2VkIGluCiAqICAgICBkZXRlcm1pbmluZyBpZiB0aGUgZXhwZWN0ZWQgdmFsdWUgKGZyb20gdGhlIGZpbHRlciBleHByZXNzaW9uKSBhbmQgYWN0dWFsIHZhbHVlIChmcm9tCiAqICAgICB0aGUgb2JqZWN0IGluIHRoZSBhcnJheSkgc2hvdWxkIGJlIGNvbnNpZGVyZWQgYSBtYXRjaC4KICoKICogICBDYW4gYmUgb25lIG9mOgogKgogKiAgIC0gYGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQpYDoKICogICAgIFRoZSBmdW5jdGlvbiB3aWxsIGJlIGdpdmVuIHRoZSBvYmplY3QgdmFsdWUgYW5kIHRoZSBwcmVkaWNhdGUgdmFsdWUgdG8gY29tcGFyZSBhbmQKICogICAgIHNob3VsZCByZXR1cm4gdHJ1ZSBpZiB0aGUgaXRlbSBzaG91bGQgYmUgaW5jbHVkZWQgaW4gZmlsdGVyZWQgcmVzdWx0LgogKgogKiAgIC0gYHRydWVgOiBBIHNob3J0aGFuZCBmb3IgYGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQpIHsgcmV0dXJuIGFuZ3VsYXIuZXF1YWxzKGV4cGVjdGVkLCBhY3R1YWwpfWAuCiAqICAgICB0aGlzIGlzIGVzc2VudGlhbGx5IHN0cmljdCBjb21wYXJpc29uIG9mIGV4cGVjdGVkIGFuZCBhY3R1YWwuCiAqCiAqICAgLSBgZmFsc2V8dW5kZWZpbmVkYDogQSBzaG9ydCBoYW5kIGZvciBhIGZ1bmN0aW9uIHdoaWNoIHdpbGwgbG9vayBmb3IgYSBzdWJzdHJpbmcgbWF0Y2ggaW4gY2FzZQogKiAgICAgaW5zZW5zaXRpdmUgd2F5LgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxkaXYgbmctaW5pdD0iZnJpZW5kcyA9IFt7bmFtZTonSm9obicsIHBob25lOic1NTUtMTI3Nid9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidNYXJ5JywgcGhvbmU6JzgwMC1CSUctTUFSWSd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidNaWtlJywgcGhvbmU6JzU1NS00MzIxJ30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge25hbWU6J0FkYW0nLCBwaG9uZTonNTU1LTU2NzgnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonSnVsaWUnLCBwaG9uZTonNTU1LTg3NjUnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonSnVsaWV0dGUnLCBwaG9uZTonNTU1LTU2NzgnfV0iPjwvZGl2PgoKICAgICAgIFNlYXJjaDogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2hUZXh0Ij4KICAgICAgIDx0YWJsZSBpZD0ic2VhcmNoVGV4dFJlc3VsdHMiPgogICAgICAgICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgICAgICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMgfCBmaWx0ZXI6c2VhcmNoVGV4dCI+CiAgICAgICAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgICAgICAgPHRkPnt7ZnJpZW5kLnBob25lfX08L3RkPgogICAgICAgICA8L3RyPgogICAgICAgPC90YWJsZT4KICAgICAgIDxocj4KICAgICAgIEFueTogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2guJCI+IDxicj4KICAgICAgIE5hbWUgb25seSA8aW5wdXQgbmctbW9kZWw9InNlYXJjaC5uYW1lIj48YnI+CiAgICAgICBQaG9uZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLnBob25lIj48YnI+CiAgICAgICBFcXVhbGl0eSA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJzdHJpY3QiPjxicj4KICAgICAgIDx0YWJsZSBpZD0ic2VhcmNoT2JqUmVzdWx0cyI+CiAgICAgICAgIDx0cj48dGg+TmFtZTwvdGg+PHRoPlBob25lPC90aD48L3RyPgogICAgICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmRPYmogaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2g6c3RyaWN0Ij4KICAgICAgICAgICA8dGQ+e3tmcmllbmRPYmoubmFtZX19PC90ZD4KICAgICAgICAgICA8dGQ+e3tmcmllbmRPYmoucGhvbmV9fTwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICA8L3RhYmxlPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIHZhciBleHBlY3RGcmllbmROYW1lcyA9IGZ1bmN0aW9uKGV4cGVjdGVkTmFtZXMsIGtleSkgewogICAgICAgICBlbGVtZW50LmFsbChieS5yZXBlYXRlcihrZXkgKyAnIGluIGZyaWVuZHMnKS5jb2x1bW4oa2V5ICsgJy5uYW1lJykpLnRoZW4oZnVuY3Rpb24oYXJyKSB7CiAgICAgICAgICAgYXJyLmZvckVhY2goZnVuY3Rpb24od2QsIGkpIHsKICAgICAgICAgICAgIGV4cGVjdCh3ZC5nZXRUZXh0KCkpLnRvTWF0Y2goZXhwZWN0ZWROYW1lc1tpXSk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIH0pOwogICAgICAgfTsKCiAgICAgICBpdCgnc2hvdWxkIHNlYXJjaCBhY3Jvc3MgYWxsIGZpZWxkcyB3aGVuIGZpbHRlcmluZyB3aXRoIGEgc3RyaW5nJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBzZWFyY2hUZXh0ID0gZWxlbWVudChieS5tb2RlbCgnc2VhcmNoVGV4dCcpKTsKICAgICAgICAgc2VhcmNoVGV4dC5jbGVhcigpOwogICAgICAgICBzZWFyY2hUZXh0LnNlbmRLZXlzKCdtJyk7CiAgICAgICAgIGV4cGVjdEZyaWVuZE5hbWVzKFsnTWFyeScsICdNaWtlJywgJ0FkYW0nXSwgJ2ZyaWVuZCcpOwoKICAgICAgICAgc2VhcmNoVGV4dC5jbGVhcigpOwogICAgICAgICBzZWFyY2hUZXh0LnNlbmRLZXlzKCc3NicpOwogICAgICAgICBleHBlY3RGcmllbmROYW1lcyhbJ0pvaG4nLCAnSnVsaWUnXSwgJ2ZyaWVuZCcpOwogICAgICAgfSk7CgogICAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggaW4gc3BlY2lmaWMgZmllbGRzIHdoZW4gZmlsdGVyaW5nIHdpdGggYSBwcmVkaWNhdGUgb2JqZWN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBzZWFyY2hBbnkgPSBlbGVtZW50KGJ5Lm1vZGVsKCdzZWFyY2guJCcpKTsKICAgICAgICAgc2VhcmNoQW55LmNsZWFyKCk7CiAgICAgICAgIHNlYXJjaEFueS5zZW5kS2V5cygnaScpOwogICAgICAgICBleHBlY3RGcmllbmROYW1lcyhbJ01hcnknLCAnTWlrZScsICdKdWxpZScsICdKdWxpZXR0ZSddLCAnZnJpZW5kT2JqJyk7CiAgICAgICB9KTsKICAgICAgIGl0KCdzaG91bGQgdXNlIGEgZXF1YWwgY29tcGFyaXNvbiB3aGVuIGNvbXBhcmF0b3IgaXMgdHJ1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICB2YXIgc2VhcmNoTmFtZSA9IGVsZW1lbnQoYnkubW9kZWwoJ3NlYXJjaC5uYW1lJykpOwogICAgICAgICB2YXIgc3RyaWN0ID0gZWxlbWVudChieS5tb2RlbCgnc3RyaWN0JykpOwogICAgICAgICBzZWFyY2hOYW1lLmNsZWFyKCk7CiAgICAgICAgIHNlYXJjaE5hbWUuc2VuZEtleXMoJ0p1bGllJyk7CiAgICAgICAgIHN0cmljdC5jbGljaygpOwogICAgICAgICBleHBlY3RGcmllbmROYW1lcyhbJ0p1bGllJ10sICdmcmllbmRPYmonKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KZnVuY3Rpb24gZmlsdGVyRmlsdGVyKCkgewogIHJldHVybiBmdW5jdGlvbihhcnJheSwgZXhwcmVzc2lvbiwgY29tcGFyYXRvcikgewogICAgaWYgKCFpc0FycmF5KGFycmF5KSkgcmV0dXJuIGFycmF5OwoKICAgIHZhciBjb21wYXJhdG9yVHlwZSA9IHR5cGVvZihjb21wYXJhdG9yKSwKICAgICAgICBwcmVkaWNhdGVzID0gW107CgogICAgcHJlZGljYXRlcy5jaGVjayA9IGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHByZWRpY2F0ZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICBpZighcHJlZGljYXRlc1tqXSh2YWx1ZSwgaW5kZXgpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfTsKCiAgICBpZiAoY29tcGFyYXRvclR5cGUgIT09ICdmdW5jdGlvbicpIHsKICAgICAgaWYgKGNvbXBhcmF0b3JUeXBlID09PSAnYm9vbGVhbicgJiYgY29tcGFyYXRvcikgewogICAgICAgIGNvbXBhcmF0b3IgPSBmdW5jdGlvbihvYmosIHRleHQpIHsKICAgICAgICAgIHJldHVybiBhbmd1bGFyLmVxdWFscyhvYmosIHRleHQpOwogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29tcGFyYXRvciA9IGZ1bmN0aW9uKG9iaiwgdGV4dCkgewogICAgICAgICAgaWYgKG9iaiAmJiB0ZXh0ICYmIHR5cGVvZiBvYmogPT09ICdvYmplY3QnICYmIHR5cGVvZiB0ZXh0ID09PSAnb2JqZWN0JykgewogICAgICAgICAgICBmb3IgKHZhciBvYmpLZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgaWYgKG9iaktleS5jaGFyQXQoMCkgIT09ICckJyAmJiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgb2JqS2V5KSAmJgogICAgICAgICAgICAgICAgICBjb21wYXJhdG9yKG9ialtvYmpLZXldLCB0ZXh0W29iaktleV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdGV4dCA9ICgnJyt0ZXh0KS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuICgnJytvYmopLnRvTG93ZXJDYXNlKCkuaW5kZXhPZih0ZXh0KSA+IC0xOwogICAgICAgIH07CiAgICAgIH0KICAgIH0KCiAgICB2YXIgc2VhcmNoID0gZnVuY3Rpb24ob2JqLCB0ZXh0KXsKICAgICAgaWYgKHR5cGVvZiB0ZXh0ID09PSAnc3RyaW5nJyAmJiB0ZXh0LmNoYXJBdCgwKSA9PT0gJyEnKSB7CiAgICAgICAgcmV0dXJuICFzZWFyY2gob2JqLCB0ZXh0LnN1YnN0cigxKSk7CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlb2Ygb2JqKSB7CiAgICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgY2FzZSAnbnVtYmVyJzoKICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgcmV0dXJuIGNvbXBhcmF0b3Iob2JqLCB0ZXh0KTsKICAgICAgICBjYXNlICdvYmplY3QnOgogICAgICAgICAgc3dpdGNoICh0eXBlb2YgdGV4dCkgewogICAgICAgICAgICBjYXNlICdvYmplY3QnOgogICAgICAgICAgICAgIHJldHVybiBjb21wYXJhdG9yKG9iaiwgdGV4dCk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgZm9yICggdmFyIG9iaktleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgIGlmIChvYmpLZXkuY2hhckF0KDApICE9PSAnJCcgJiYgc2VhcmNoKG9ialtvYmpLZXldLCB0ZXh0KSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgY2FzZSAnYXJyYXknOgogICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgb2JqLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChzZWFyY2gob2JqW2ldLCB0ZXh0KSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfTsKICAgIHN3aXRjaCAodHlwZW9mIGV4cHJlc3Npb24pIHsKICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgLy8gU2V0IHVwIGV4cHJlc3Npb24gb2JqZWN0IGFuZCBmYWxsIHRocm91Z2gKICAgICAgICBleHByZXNzaW9uID0geyQ6ZXhwcmVzc2lvbn07CiAgICAgICAgLy8ganNoaW50IC1XMDg2CiAgICAgIGNhc2UgJ29iamVjdCc6CiAgICAgICAgLy8ganNoaW50ICtXMDg2CiAgICAgICAgZm9yICh2YXIga2V5IGluIGV4cHJlc3Npb24pIHsKICAgICAgICAgIChmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZXhwcmVzc2lvbltwYXRoXSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKICAgICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaChwYXRoID09ICckJyA/IHZhbHVlIDogKHZhbHVlICYmIHZhbHVlW3BhdGhdKSwgZXhwcmVzc2lvbltwYXRoXSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkoa2V5KTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ2Z1bmN0aW9uJzoKICAgICAgICBwcmVkaWNhdGVzLnB1c2goZXhwcmVzc2lvbik7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgfQogICAgdmFyIGZpbHRlcmVkID0gW107CiAgICBmb3IgKCB2YXIgaiA9IDA7IGogPCBhcnJheS5sZW5ndGg7IGorKykgewogICAgICB2YXIgdmFsdWUgPSBhcnJheVtqXTsKICAgICAgaWYgKHByZWRpY2F0ZXMuY2hlY2sodmFsdWUsIGopKSB7CiAgICAgICAgZmlsdGVyZWQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmaWx0ZXJlZDsKICB9Owp9CgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBjdXJyZW5jeQogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRm9ybWF0cyBhIG51bWJlciBhcyBhIGN1cnJlbmN5IChpZSAkMSwyMzQuNTYpLiBXaGVuIG5vIGN1cnJlbmN5IHN5bWJvbCBpcyBwcm92aWRlZCwgZGVmYXVsdAogKiBzeW1ib2wgZm9yIGN1cnJlbnQgbG9jYWxlIGlzIHVzZWQuCiAqCiAqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgSW5wdXQgdG8gZmlsdGVyLgogKiBAcGFyYW0ge3N0cmluZz19IHN5bWJvbCBDdXJyZW5jeSBzeW1ib2wgb3IgaWRlbnRpZmllciB0byBiZSBkaXNwbGF5ZWQuCiAqIEBwYXJhbSB7bnVtYmVyPX0gZnJhY3Rpb25TaXplIE51bWJlciBvZiBkZWNpbWFsIHBsYWNlcyB0byByb3VuZCB0aGUgYW1vdW50IHRvLgogKiBAcmV0dXJucyB7c3RyaW5nfSBGb3JtYXR0ZWQgbnVtYmVyLgogKgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9ImN1cnJlbmN5RXhhbXBsZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBhbmd1bGFyLm1vZHVsZSgnY3VycmVuY3lFeGFtcGxlJywgW10pCiAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS5hbW91bnQgPSAxMjM0LjU2OwogICAgICAgICAgIH1dKTsKICAgICAgIDwvc2NyaXB0PgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIG5nLW1vZGVsPSJhbW91bnQiPiA8YnI+CiAgICAgICAgIGRlZmF1bHQgY3VycmVuY3kgc3ltYm9sICgkKTogPHNwYW4gaWQ9ImN1cnJlbmN5LWRlZmF1bHQiPnt7YW1vdW50IHwgY3VycmVuY3l9fTwvc3Bhbj48YnI+CiAgICAgICAgIGN1c3RvbSBjdXJyZW5jeSBpZGVudGlmaWVyIChVU0QkKTogPHNwYW4gaWQ9ImN1cnJlbmN5LWN1c3RvbSI+e3thbW91bnQgfCBjdXJyZW5jeToiVVNEJCJ9fTwvc3Bhbj4KICAgICAgICAgbm8gZnJhY3Rpb25zICgwKTogPHNwYW4gaWQ9ImN1cnJlbmN5LW5vLWZyYWN0aW9ucyI+e3thbW91bnQgfCBjdXJyZW5jeToiVVNEJCI6MH19PC9zcGFuPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBpbml0IHdpdGggMTIzNC41NicsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnY3VycmVuY3ktZGVmYXVsdCcpKS5nZXRUZXh0KCkpLnRvQmUoJyQxLDIzNC41NicpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnY3VycmVuY3ktY3VzdG9tJykpLmdldFRleHQoKSkudG9CZSgnVVNEJDEsMjM0LjU2Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdjdXJyZW5jeS1uby1mcmFjdGlvbnMnKSkuZ2V0VGV4dCgpKS50b0JlKCdVU0QkMSwyMzUnKTsKICAgICAgIH0pOwogICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgaWYgKGJyb3dzZXIucGFyYW1zLmJyb3dzZXIgPT0gJ3NhZmFyaScpIHsKICAgICAgICAgICAvLyBTYWZhcmkgZG9lcyBub3QgdW5kZXJzdGFuZCB0aGUgbWludXMga2V5LiBTZWUKICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9wcm90cmFjdG9yL2lzc3Vlcy80ODEKICAgICAgICAgICByZXR1cm47CiAgICAgICAgIH0KICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnYW1vdW50JykpLmNsZWFyKCk7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2Ftb3VudCcpKS5zZW5kS2V5cygnLTEyMzQnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2N1cnJlbmN5LWRlZmF1bHQnKSkuZ2V0VGV4dCgpKS50b0JlKCcoJDEsMjM0LjAwKScpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnY3VycmVuY3ktY3VzdG9tJykpLmdldFRleHQoKSkudG9CZSgnKFVTRCQxLDIzNC4wMCknKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2N1cnJlbmN5LW5vLWZyYWN0aW9ucycpKS5nZXRUZXh0KCkpLnRvQmUoJyhVU0QkMSwyMzQpJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmN1cnJlbmN5RmlsdGVyLiRpbmplY3QgPSBbJyRsb2NhbGUnXTsKZnVuY3Rpb24gY3VycmVuY3lGaWx0ZXIoJGxvY2FsZSkgewogIHZhciBmb3JtYXRzID0gJGxvY2FsZS5OVU1CRVJfRk9STUFUUzsKICByZXR1cm4gZnVuY3Rpb24oYW1vdW50LCBjdXJyZW5jeVN5bWJvbCwgZnJhY3Rpb25TaXplKXsKICAgIGlmIChpc1VuZGVmaW5lZChjdXJyZW5jeVN5bWJvbCkpIHsKICAgICAgY3VycmVuY3lTeW1ib2wgPSBmb3JtYXRzLkNVUlJFTkNZX1NZTTsKICAgIH0KCiAgICBpZiAoaXNVbmRlZmluZWQoZnJhY3Rpb25TaXplKSkgewogICAgICAvLyBUT0RPOiByZWFkIHRoZSBkZWZhdWx0IHZhbHVlIGZyb20gdGhlIGxvY2FsZSBmaWxlCiAgICAgIGZyYWN0aW9uU2l6ZSA9IDI7CiAgICB9CgogICAgLy8gaWYgbnVsbCBvciB1bmRlZmluZWQgcGFzcyBpdCB0aHJvdWdoCiAgICByZXR1cm4gKGFtb3VudCA9PSBudWxsKQogICAgICAgID8gYW1vdW50CiAgICAgICAgOiBmb3JtYXROdW1iZXIoYW1vdW50LCBmb3JtYXRzLlBBVFRFUk5TWzFdLCBmb3JtYXRzLkdST1VQX1NFUCwgZm9ybWF0cy5ERUNJTUFMX1NFUCwgZnJhY3Rpb25TaXplKS4KICAgICAgICAgICAgcmVwbGFjZSgvXHUwMEE0L2csIGN1cnJlbmN5U3ltYm9sKTsKICB9Owp9CgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBudW1iZXIKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIEZvcm1hdHMgYSBudW1iZXIgYXMgdGV4dC4KICoKICogSWYgdGhlIGlucHV0IGlzIG5vdCBhIG51bWJlciBhbiBlbXB0eSBzdHJpbmcgaXMgcmV0dXJuZWQuCiAqCiAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ30gbnVtYmVyIE51bWJlciB0byBmb3JtYXQuCiAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmcpPX0gZnJhY3Rpb25TaXplIE51bWJlciBvZiBkZWNpbWFsIHBsYWNlcyB0byByb3VuZCB0aGUgbnVtYmVyIHRvLgogKiBJZiB0aGlzIGlzIG5vdCBwcm92aWRlZCB0aGVuIHRoZSBmcmFjdGlvbiBzaXplIGlzIGNvbXB1dGVkIGZyb20gdGhlIGN1cnJlbnQgbG9jYWxlJ3MgbnVtYmVyCiAqIGZvcm1hdHRpbmcgcGF0dGVybi4gSW4gdGhlIGNhc2Ugb2YgdGhlIGRlZmF1bHQgbG9jYWxlLCBpdCB3aWxsIGJlIDMuCiAqIEByZXR1cm5zIHtzdHJpbmd9IE51bWJlciByb3VuZGVkIHRvIGRlY2ltYWxQbGFjZXMgYW5kIHBsYWNlcyBhIOKAnCzigJ0gYWZ0ZXIgZWFjaCB0aGlyZCBkaWdpdC4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJudW1iZXJGaWx0ZXJFeGFtcGxlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCdudW1iZXJGaWx0ZXJFeGFtcGxlJywgW10pCiAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS52YWwgPSAxMjM0LjU2Nzg5OwogICAgICAgICAgIH1dKTsKICAgICAgIDwvc2NyaXB0PgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICAgIEVudGVyIG51bWJlcjogPGlucHV0IG5nLW1vZGVsPSd2YWwnPjxicj4KICAgICAgICAgRGVmYXVsdCBmb3JtYXR0aW5nOiA8c3BhbiBpZD0nbnVtYmVyLWRlZmF1bHQnPnt7dmFsIHwgbnVtYmVyfX08L3NwYW4+PGJyPgogICAgICAgICBObyBmcmFjdGlvbnM6IDxzcGFuPnt7dmFsIHwgbnVtYmVyOjB9fTwvc3Bhbj48YnI+CiAgICAgICAgIE5lZ2F0aXZlIG51bWJlcjogPHNwYW4+e3stdmFsIHwgbnVtYmVyOjR9fTwvc3Bhbj4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgZm9ybWF0IG51bWJlcnMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ251bWJlci1kZWZhdWx0JykpLmdldFRleHQoKSkudG9CZSgnMSwyMzQuNTY4Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3ZhbCB8IG51bWJlcjowJykpLmdldFRleHQoKSkudG9CZSgnMSwyMzUnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnLXZhbCB8IG51bWJlcjo0JykpLmdldFRleHQoKSkudG9CZSgnLTEsMjM0LjU2NzknKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgdXBkYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3ZhbCcpKS5jbGVhcigpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCd2YWwnKSkuc2VuZEtleXMoJzMzNzQuMzMzJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdudW1iZXItZGVmYXVsdCcpKS5nZXRUZXh0KCkpLnRvQmUoJzMsMzc0LjMzMycpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd2YWwgfCBudW1iZXI6MCcpKS5nZXRUZXh0KCkpLnRvQmUoJzMsMzc0Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS5nZXRUZXh0KCkpLnRvQmUoJy0zLDM3NC4zMzMwJyk7CiAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCgpudW1iZXJGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwpmdW5jdGlvbiBudW1iZXJGaWx0ZXIoJGxvY2FsZSkgewogIHZhciBmb3JtYXRzID0gJGxvY2FsZS5OVU1CRVJfRk9STUFUUzsKICByZXR1cm4gZnVuY3Rpb24obnVtYmVyLCBmcmFjdGlvblNpemUpIHsKCiAgICAvLyBpZiBudWxsIG9yIHVuZGVmaW5lZCBwYXNzIGl0IHRocm91Z2gKICAgIHJldHVybiAobnVtYmVyID09IG51bGwpCiAgICAgICAgPyBudW1iZXIKICAgICAgICA6IGZvcm1hdE51bWJlcihudW1iZXIsIGZvcm1hdHMuUEFUVEVSTlNbMF0sIGZvcm1hdHMuR1JPVVBfU0VQLCBmb3JtYXRzLkRFQ0lNQUxfU0VQLAogICAgICAgICAgICAgICAgICAgICAgIGZyYWN0aW9uU2l6ZSk7CiAgfTsKfQoKdmFyIERFQ0lNQUxfU0VQID0gJy4nOwpmdW5jdGlvbiBmb3JtYXROdW1iZXIobnVtYmVyLCBwYXR0ZXJuLCBncm91cFNlcCwgZGVjaW1hbFNlcCwgZnJhY3Rpb25TaXplKSB7CiAgaWYgKCFpc0Zpbml0ZShudW1iZXIpIHx8IGlzT2JqZWN0KG51bWJlcikpIHJldHVybiAnJzsKCiAgdmFyIGlzTmVnYXRpdmUgPSBudW1iZXIgPCAwOwogIG51bWJlciA9IE1hdGguYWJzKG51bWJlcik7CiAgdmFyIG51bVN0ciA9IG51bWJlciArICcnLAogICAgICBmb3JtYXRlZFRleHQgPSAnJywKICAgICAgcGFydHMgPSBbXTsKCiAgdmFyIGhhc0V4cG9uZW50ID0gZmFsc2U7CiAgaWYgKG51bVN0ci5pbmRleE9mKCdlJykgIT09IC0xKSB7CiAgICB2YXIgbWF0Y2ggPSBudW1TdHIubWF0Y2goLyhbXGRcLl0rKWUoLT8pKFxkKykvKTsKICAgIGlmIChtYXRjaCAmJiBtYXRjaFsyXSA9PSAnLScgJiYgbWF0Y2hbM10gPiBmcmFjdGlvblNpemUgKyAxKSB7CiAgICAgIG51bVN0ciA9ICcwJzsKICAgICAgbnVtYmVyID0gMDsKICAgIH0gZWxzZSB7CiAgICAgIGZvcm1hdGVkVGV4dCA9IG51bVN0cjsKICAgICAgaGFzRXhwb25lbnQgPSB0cnVlOwogICAgfQogIH0KCiAgaWYgKCFoYXNFeHBvbmVudCkgewogICAgdmFyIGZyYWN0aW9uTGVuID0gKG51bVN0ci5zcGxpdChERUNJTUFMX1NFUClbMV0gfHwgJycpLmxlbmd0aDsKCiAgICAvLyBkZXRlcm1pbmUgZnJhY3Rpb25TaXplIGlmIGl0IGlzIG5vdCBzcGVjaWZpZWQKICAgIGlmIChpc1VuZGVmaW5lZChmcmFjdGlvblNpemUpKSB7CiAgICAgIGZyYWN0aW9uU2l6ZSA9IE1hdGgubWluKE1hdGgubWF4KHBhdHRlcm4ubWluRnJhYywgZnJhY3Rpb25MZW4pLCBwYXR0ZXJuLm1heEZyYWMpOwogICAgfQoKICAgIC8vIHNhZmVseSByb3VuZCBudW1iZXJzIGluIEpTIHdpdGhvdXQgaGl0dGluZyBpbXByZWNpc2lvbnMgb2YgZmxvYXRpbmctcG9pbnQgYXJpdGhtZXRpY3MKICAgIC8vIGluc3BpcmVkIGJ5OgogICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvTWF0aC9yb3VuZAogICAgbnVtYmVyID0gKyhNYXRoLnJvdW5kKCsobnVtYmVyLnRvU3RyaW5nKCkgKyAnZScgKyBmcmFjdGlvblNpemUpKS50b1N0cmluZygpICsgJ2UnICsgLWZyYWN0aW9uU2l6ZSk7CgogICAgaWYgKG51bWJlciA9PT0gMCkgewogICAgICBpc05lZ2F0aXZlID0gZmFsc2U7CiAgICB9CgogICAgdmFyIGZyYWN0aW9uID0gKCcnICsgbnVtYmVyKS5zcGxpdChERUNJTUFMX1NFUCk7CiAgICB2YXIgd2hvbGUgPSBmcmFjdGlvblswXTsKICAgIGZyYWN0aW9uID0gZnJhY3Rpb25bMV0gfHwgJyc7CgogICAgdmFyIGksIHBvcyA9IDAsCiAgICAgICAgbGdyb3VwID0gcGF0dGVybi5sZ1NpemUsCiAgICAgICAgZ3JvdXAgPSBwYXR0ZXJuLmdTaXplOwoKICAgIGlmICh3aG9sZS5sZW5ndGggPj0gKGxncm91cCArIGdyb3VwKSkgewogICAgICBwb3MgPSB3aG9sZS5sZW5ndGggLSBsZ3JvdXA7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBwb3M7IGkrKykgewogICAgICAgIGlmICgocG9zIC0gaSklZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IGdyb3VwU2VwOwogICAgICAgIH0KICAgICAgICBmb3JtYXRlZFRleHQgKz0gd2hvbGUuY2hhckF0KGkpOwogICAgICB9CiAgICB9CgogICAgZm9yIChpID0gcG9zOyBpIDwgd2hvbGUubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCh3aG9sZS5sZW5ndGggLSBpKSVsZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgfQogICAgICBmb3JtYXRlZFRleHQgKz0gd2hvbGUuY2hhckF0KGkpOwogICAgfQoKICAgIC8vIGZvcm1hdCBmcmFjdGlvbiBwYXJ0LgogICAgd2hpbGUoZnJhY3Rpb24ubGVuZ3RoIDwgZnJhY3Rpb25TaXplKSB7CiAgICAgIGZyYWN0aW9uICs9ICcwJzsKICAgIH0KCiAgICBpZiAoZnJhY3Rpb25TaXplICYmIGZyYWN0aW9uU2l6ZSAhPT0gIjAiKSBmb3JtYXRlZFRleHQgKz0gZGVjaW1hbFNlcCArIGZyYWN0aW9uLnN1YnN0cigwLCBmcmFjdGlvblNpemUpOwogIH0gZWxzZSB7CgogICAgaWYgKGZyYWN0aW9uU2l6ZSA+IDAgJiYgbnVtYmVyID4gLTEgJiYgbnVtYmVyIDwgMSkgewogICAgICBmb3JtYXRlZFRleHQgPSBudW1iZXIudG9GaXhlZChmcmFjdGlvblNpemUpOwogICAgfQogIH0KCiAgcGFydHMucHVzaChpc05lZ2F0aXZlID8gcGF0dGVybi5uZWdQcmUgOiBwYXR0ZXJuLnBvc1ByZSk7CiAgcGFydHMucHVzaChmb3JtYXRlZFRleHQpOwogIHBhcnRzLnB1c2goaXNOZWdhdGl2ZSA/IHBhdHRlcm4ubmVnU3VmIDogcGF0dGVybi5wb3NTdWYpOwogIHJldHVybiBwYXJ0cy5qb2luKCcnKTsKfQoKZnVuY3Rpb24gcGFkTnVtYmVyKG51bSwgZGlnaXRzLCB0cmltKSB7CiAgdmFyIG5lZyA9ICcnOwogIGlmIChudW0gPCAwKSB7CiAgICBuZWcgPSAgJy0nOwogICAgbnVtID0gLW51bTsKICB9CiAgbnVtID0gJycgKyBudW07CiAgd2hpbGUobnVtLmxlbmd0aCA8IGRpZ2l0cykgbnVtID0gJzAnICsgbnVtOwogIGlmICh0cmltKQogICAgbnVtID0gbnVtLnN1YnN0cihudW0ubGVuZ3RoIC0gZGlnaXRzKTsKICByZXR1cm4gbmVnICsgbnVtOwp9CgoKZnVuY3Rpb24gZGF0ZUdldHRlcihuYW1lLCBzaXplLCBvZmZzZXQsIHRyaW0pIHsKICBvZmZzZXQgPSBvZmZzZXQgfHwgMDsKICByZXR1cm4gZnVuY3Rpb24oZGF0ZSkgewogICAgdmFyIHZhbHVlID0gZGF0ZVsnZ2V0JyArIG5hbWVdKCk7CiAgICBpZiAob2Zmc2V0ID4gMCB8fCB2YWx1ZSA+IC1vZmZzZXQpCiAgICAgIHZhbHVlICs9IG9mZnNldDsKICAgIGlmICh2YWx1ZSA9PT0gMCAmJiBvZmZzZXQgPT0gLTEyICkgdmFsdWUgPSAxMjsKICAgIHJldHVybiBwYWROdW1iZXIodmFsdWUsIHNpemUsIHRyaW0pOwogIH07Cn0KCmZ1bmN0aW9uIGRhdGVTdHJHZXR0ZXIobmFtZSwgc2hvcnRGb3JtKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGRhdGUsIGZvcm1hdHMpIHsKICAgIHZhciB2YWx1ZSA9IGRhdGVbJ2dldCcgKyBuYW1lXSgpOwogICAgdmFyIGdldCA9IHVwcGVyY2FzZShzaG9ydEZvcm0gPyAoJ1NIT1JUJyArIG5hbWUpIDogbmFtZSk7CgogICAgcmV0dXJuIGZvcm1hdHNbZ2V0XVt2YWx1ZV07CiAgfTsKfQoKZnVuY3Rpb24gdGltZVpvbmVHZXR0ZXIoZGF0ZSkgewogIHZhciB6b25lID0gLTEgKiBkYXRlLmdldFRpbWV6b25lT2Zmc2V0KCk7CiAgdmFyIHBhZGRlZFpvbmUgPSAoem9uZSA+PSAwKSA/ICIrIiA6ICIiOwoKICBwYWRkZWRab25lICs9IHBhZE51bWJlcihNYXRoW3pvbmUgPiAwID8gJ2Zsb29yJyA6ICdjZWlsJ10oem9uZSAvIDYwKSwgMikgKwogICAgICAgICAgICAgICAgcGFkTnVtYmVyKE1hdGguYWJzKHpvbmUgJSA2MCksIDIpOwoKICByZXR1cm4gcGFkZGVkWm9uZTsKfQoKZnVuY3Rpb24gZ2V0Rmlyc3RUaHVyc2RheU9mWWVhcih5ZWFyKSB7CiAgICAvLyAwID0gaW5kZXggb2YgSmFudWFyeQogICAgdmFyIGRheU9mV2Vla09uRmlyc3QgPSAobmV3IERhdGUoeWVhciwgMCwgMSkpLmdldERheSgpOwogICAgLy8gNCA9IGluZGV4IG9mIFRodXJzZGF5ICgrMSB0byBhY2NvdW50IGZvciAxc3QgPSA1KQogICAgLy8gMTEgPSBpbmRleCBvZiAqbmV4dCogVGh1cnNkYXkgKCsxIGFjY291bnQgZm9yIDFzdCA9IDEyKQogICAgcmV0dXJuIG5ldyBEYXRlKHllYXIsIDAsICgoZGF5T2ZXZWVrT25GaXJzdCA8PSA0KSA/IDUgOiAxMikgLSBkYXlPZldlZWtPbkZpcnN0KTsKfQoKZnVuY3Rpb24gZ2V0VGh1cnNkYXlUaGlzV2VlayhkYXRldGltZSkgewogICAgcmV0dXJuIG5ldyBEYXRlKGRhdGV0aW1lLmdldEZ1bGxZZWFyKCksIGRhdGV0aW1lLmdldE1vbnRoKCksCiAgICAgIC8vIDQgPSBpbmRleCBvZiBUaHVyc2RheQogICAgICBkYXRldGltZS5nZXREYXRlKCkgKyAoNCAtIGRhdGV0aW1lLmdldERheSgpKSk7Cn0KCmZ1bmN0aW9uIHdlZWtHZXR0ZXIoc2l6ZSkgewogICByZXR1cm4gZnVuY3Rpb24oZGF0ZSkgewogICAgICB2YXIgZmlyc3RUaHVycyA9IGdldEZpcnN0VGh1cnNkYXlPZlllYXIoZGF0ZS5nZXRGdWxsWWVhcigpKSwKICAgICAgICAgdGhpc1RodXJzID0gZ2V0VGh1cnNkYXlUaGlzV2VlayhkYXRlKTsKCiAgICAgIHZhciBkaWZmID0gK3RoaXNUaHVycyAtICtmaXJzdFRodXJzLAogICAgICAgICByZXN1bHQgPSAxICsgTWF0aC5yb3VuZChkaWZmIC8gNi4wNDhlOCk7IC8vIDYuMDQ4ZTggbXMgcGVyIHdlZWsKCiAgICAgIHJldHVybiBwYWROdW1iZXIocmVzdWx0LCBzaXplKTsKICAgfTsKfQoKZnVuY3Rpb24gYW1wbUdldHRlcihkYXRlLCBmb3JtYXRzKSB7CiAgcmV0dXJuIGRhdGUuZ2V0SG91cnMoKSA8IDEyID8gZm9ybWF0cy5BTVBNU1swXSA6IGZvcm1hdHMuQU1QTVNbMV07Cn0KCnZhciBEQVRFX0ZPUk1BVFMgPSB7CiAgeXl5eTogZGF0ZUdldHRlcignRnVsbFllYXInLCA0KSwKICAgIHl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDIsIDAsIHRydWUpLAogICAgIHk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMSksCiAgTU1NTTogZGF0ZVN0ckdldHRlcignTW9udGgnKSwKICAgTU1NOiBkYXRlU3RyR2V0dGVyKCdNb250aCcsIHRydWUpLAogICAgTU06IGRhdGVHZXR0ZXIoJ01vbnRoJywgMiwgMSksCiAgICAgTTogZGF0ZUdldHRlcignTW9udGgnLCAxLCAxKSwKICAgIGRkOiBkYXRlR2V0dGVyKCdEYXRlJywgMiksCiAgICAgZDogZGF0ZUdldHRlcignRGF0ZScsIDEpLAogICAgSEg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMiksCiAgICAgSDogZGF0ZUdldHRlcignSG91cnMnLCAxKSwKICAgIGhoOiBkYXRlR2V0dGVyKCdIb3VycycsIDIsIC0xMiksCiAgICAgaDogZGF0ZUdldHRlcignSG91cnMnLCAxLCAtMTIpLAogICAgbW06IGRhdGVHZXR0ZXIoJ01pbnV0ZXMnLCAyKSwKICAgICBtOiBkYXRlR2V0dGVyKCdNaW51dGVzJywgMSksCiAgICBzczogZGF0ZUdldHRlcignU2Vjb25kcycsIDIpLAogICAgIHM6IGRhdGVHZXR0ZXIoJ1NlY29uZHMnLCAxKSwKICAgICAvLyB3aGlsZSBJU08gODYwMSByZXF1aXJlcyBmcmFjdGlvbnMgdG8gYmUgcHJlZml4ZWQgd2l0aCBgLmAgb3IgYCxgCiAgICAgLy8gd2UgY2FuIGJlIGp1c3Qgc2FmZWx5IHJlbHkgb24gdXNpbmcgYHNzc2Agc2luY2Ugd2UgY3VycmVudGx5IGRvbid0IHN1cHBvcnQgc2luZ2xlIG9yIHR3byBkaWdpdCBmcmFjdGlvbnMKICAgc3NzOiBkYXRlR2V0dGVyKCdNaWxsaXNlY29uZHMnLCAzKSwKICBFRUVFOiBkYXRlU3RyR2V0dGVyKCdEYXknKSwKICAgRUVFOiBkYXRlU3RyR2V0dGVyKCdEYXknLCB0cnVlKSwKICAgICBhOiBhbXBtR2V0dGVyLAogICAgIFo6IHRpbWVab25lR2V0dGVyLAogICAgd3c6IHdlZWtHZXR0ZXIoMiksCiAgICAgdzogd2Vla0dldHRlcigxKQp9OwoKdmFyIERBVEVfRk9STUFUU19TUExJVCA9IC8oKD86W155TWRIaG1zYVpFdyddKyl8KD86Jyg/OlteJ118JycpKicpfCg/OkUrfHkrfE0rfGQrfEgrfGgrfG0rfHMrfGF8Wnx3KykpKC4qKS8sCiAgICBOVU1CRVJfU1RSSU5HID0gL15cLT9cZCskLzsKCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGRhdGUKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqICAgRm9ybWF0cyBgZGF0ZWAgdG8gYSBzdHJpbmcgYmFzZWQgb24gdGhlIHJlcXVlc3RlZCBgZm9ybWF0YC4KICoKICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGJlIGNvbXBvc2VkIG9mIHRoZSBmb2xsb3dpbmcgZWxlbWVudHM6CiAqCiAqICAgKiBgJ3l5eXknYDogNCBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyIChlLmcuIEFEIDEgPT4gMDAwMSwgQUQgMjAxMCA9PiAyMDEwKQogKiAgICogYCd5eSdgOiAyIGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIsIHBhZGRlZCAoMDAtOTkpLiAoZS5nLiBBRCAyMDAxID0+IDAxLCBBRCAyMDEwID0+IDEwKQogKiAgICogYCd5J2A6IDEgZGlnaXQgcmVwcmVzZW50YXRpb24gb2YgeWVhciwgZS5nLiAoQUQgMSA9PiAxLCBBRCAxOTkgPT4gMTk5KQogKiAgICogYCdNTU1NJ2A6IE1vbnRoIGluIHllYXIgKEphbnVhcnktRGVjZW1iZXIpCiAqICAgKiBgJ01NTSdgOiBNb250aCBpbiB5ZWFyIChKYW4tRGVjKQogKiAgICogYCdNTSdgOiBNb250aCBpbiB5ZWFyLCBwYWRkZWQgKDAxLTEyKQogKiAgICogYCdNJ2A6IE1vbnRoIGluIHllYXIgKDEtMTIpCiAqICAgKiBgJ2RkJ2A6IERheSBpbiBtb250aCwgcGFkZGVkICgwMS0zMSkKICogICAqIGAnZCdgOiBEYXkgaW4gbW9udGggKDEtMzEpCiAqICAgKiBgJ0VFRUUnYDogRGF5IGluIFdlZWssKFN1bmRheS1TYXR1cmRheSkKICogICAqIGAnRUVFJ2A6IERheSBpbiBXZWVrLCAoU3VuLVNhdCkKICogICAqIGAnSEgnYDogSG91ciBpbiBkYXksIHBhZGRlZCAoMDAtMjMpCiAqICAgKiBgJ0gnYDogSG91ciBpbiBkYXkgKDAtMjMpCiAqICAgKiBgJ2hoJ2A6IEhvdXIgaW4gQU0vUE0sIHBhZGRlZCAoMDEtMTIpCiAqICAgKiBgJ2gnYDogSG91ciBpbiBBTS9QTSwgKDEtMTIpCiAqICAgKiBgJ21tJ2A6IE1pbnV0ZSBpbiBob3VyLCBwYWRkZWQgKDAwLTU5KQogKiAgICogYCdtJ2A6IE1pbnV0ZSBpbiBob3VyICgwLTU5KQogKiAgICogYCdzcydgOiBTZWNvbmQgaW4gbWludXRlLCBwYWRkZWQgKDAwLTU5KQogKiAgICogYCdzJ2A6IFNlY29uZCBpbiBtaW51dGUgKDAtNTkpCiAqICAgKiBgJy5zc3MnIG9yICcsc3NzJ2A6IE1pbGxpc2Vjb25kIGluIHNlY29uZCwgcGFkZGVkICgwMDAtOTk5KQogKiAgICogYCdhJ2A6IEFNL1BNIG1hcmtlcgogKiAgICogYCdaJ2A6IDQgZGlnaXQgKCtzaWduKSByZXByZXNlbnRhdGlvbiBvZiB0aGUgdGltZXpvbmUgb2Zmc2V0ICgtMTIwMC0rMTIwMCkKICogICAqIGAnd3cnYDogSVNPLTg2MDEgd2VlayBvZiB5ZWFyICgwMC01MykKICogICAqIGAndydgOiBJU08tODYwMSB3ZWVrIG9mIHllYXIgKDAtNTMpCiAqCiAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBhbHNvIGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nIHByZWRlZmluZWQKICogICB7QGxpbmsgZ3VpZGUvaTE4biBsb2NhbGl6YWJsZSBmb3JtYXRzfToKICoKICogICAqIGAnbWVkaXVtJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSBoOm1tOnNzIGEnYCBmb3IgZW5fVVMgbG9jYWxlCiAqICAgICAoZS5nLiBTZXAgMywgMjAxMCAxMjowNTowOCBQTSkKICogICAqIGAnc2hvcnQnYDogZXF1aXZhbGVudCB0byBgJ00vZC95eSBoOm1tIGEnYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiA5LzMvMTAgMTI6MDUgUE0pCiAqICAgKiBgJ2Z1bGxEYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdFRUVFLCBNTU1NIGQsIHknYCBmb3IgZW5fVVMgIGxvY2FsZQogKiAgICAgKGUuZy4gRnJpZGF5LCBTZXB0ZW1iZXIgMywgMjAxMCkKICogICAqIGAnbG9uZ0RhdGUnYDogZXF1aXZhbGVudCB0byBgJ01NTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIFNlcHRlbWJlciAzLCAyMDEwKQogKiAgICogYCdtZWRpdW1EYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIFNlcCAzLCAyMDEwKQogKiAgICogYCdzaG9ydERhdGUnYDogZXF1aXZhbGVudCB0byBgJ00vZC95eSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gOS8zLzEwKQogKiAgICogYCdtZWRpdW1UaW1lJ2A6IGVxdWl2YWxlbnQgdG8gYCdoOm1tOnNzIGEnYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDEyOjA1OjA4IFBNKQogKiAgICogYCdzaG9ydFRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW0gYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDUgUE0pCiAqCiAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBjb250YWluIGxpdGVyYWwgdmFsdWVzLiBUaGVzZSBuZWVkIHRvIGJlIGVzY2FwZWQgYnkgc3Vycm91bmRpbmcgd2l0aCBzaW5nbGUgcXVvdGVzIChlLmcuCiAqICAgYCJoICdpbiB0aGUgbW9ybmluZyciYCkuIEluIG9yZGVyIHRvIG91dHB1dCBhIHNpbmdsZSBxdW90ZSwgZXNjYXBlIGl0IC0gaS5lLiwgdHdvIHNpbmdsZSBxdW90ZXMgaW4gYSBzZXF1ZW5jZQogKiAgIChlLmcuIGAiaCAnbycnY2xvY2snImApLgogKgogKiBAcGFyYW0geyhEYXRlfG51bWJlcnxzdHJpbmcpfSBkYXRlIERhdGUgdG8gZm9ybWF0IGVpdGhlciBhcyBEYXRlIG9iamVjdCwgbWlsbGlzZWNvbmRzIChzdHJpbmcgb3IKICogICAgbnVtYmVyKSBvciB2YXJpb3VzIElTTyA4NjAxIGRhdGV0aW1lIHN0cmluZyBmb3JtYXRzIChlLmcuIHl5eXktTU0tZGRUSEg6bW06c3Muc3NzWiBhbmQgaXRzCiAqICAgIHNob3J0ZXIgdmVyc2lvbnMgbGlrZSB5eXl5LU1NLWRkVEhIOm1tWiwgeXl5eS1NTS1kZCBvciB5eXl5TU1kZFRISG1tc3NaKS4gSWYgbm8gdGltZXpvbmUgaXMKICogICAgc3BlY2lmaWVkIGluIHRoZSBzdHJpbmcgaW5wdXQsIHRoZSB0aW1lIGlzIGNvbnNpZGVyZWQgdG8gYmUgaW4gdGhlIGxvY2FsIHRpbWV6b25lLgogKiBAcGFyYW0ge3N0cmluZz19IGZvcm1hdCBGb3JtYXR0aW5nIHJ1bGVzIChzZWUgRGVzY3JpcHRpb24pLiBJZiBub3Qgc3BlY2lmaWVkLAogKiAgICBgbWVkaXVtRGF0ZWAgaXMgdXNlZC4KICogQHBhcmFtIHtzdHJpbmc9fSB0aW1lem9uZSBUaW1lem9uZSB0byBiZSB1c2VkIGZvciBmb3JtYXR0aW5nLiBSaWdodCBub3csIG9ubHkgYCdVVEMnYCBpcyBzdXBwb3J0ZWQuCiAqICAgIElmIG5vdCBzcGVjaWZpZWQsIHRoZSB0aW1lem9uZSBvZiB0aGUgYnJvd3NlciB3aWxsIGJlIHVzZWQuCiAqIEByZXR1cm5zIHtzdHJpbmd9IEZvcm1hdHRlZCBzdHJpbmcgb3IgdGhlIGlucHV0IGlmIGlucHV0IGlzIG5vdCByZWNvZ25pemVkIGFzIGRhdGUvbWlsbGlzLgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nfX08L3NwYW4+OgogICAgICAgICAgIDxzcGFuPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSd9fTwvc3Bhbj48YnI+CiAgICAgICA8c3BhbiBuZy1ub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJ319PC9zcGFuPjoKICAgICAgICAgIDxzcGFuPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWid9fTwvc3Bhbj48YnI+CiAgICAgICA8c3BhbiBuZy1ub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJ319PC9zcGFuPjoKICAgICAgICAgIDxzcGFuPnt7JzEyODgzMjM2MjMwMDYnIHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJ319PC9zcGFuPjxicj4KICAgICAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOiJNTS9kZC95eXl5ICdhdCcgaDptbWEifX08L3NwYW4+OgogICAgICAgICAgPHNwYW4+e3snMTI4ODMyMzYyMzAwNicgfCBkYXRlOiJNTS9kZC95eXl5ICdhdCcgaDptbWEifX08L3NwYW4+PGJyPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgZm9ybWF0IGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygiMTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSciKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgdG9NYXRjaCgvT2N0IDJcZCwgMjAxMCBcZHsxLDJ9OlxkezJ9OlxkezJ9IChBTXxQTSkvKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygiMTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWiciKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgdG9NYXRjaCgvMjAxMFwtMTBcLTJcZCBcZHsyfTpcZHsyfTpcZHsyfSAoXC18XCspP1xkezR9Lyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoIicxMjg4MzIzNjIzMDA2JyB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSciKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgdG9NYXRjaCgvMTBcLzJcZFwvMjAxMCBAIFxkezEsMn06XGR7Mn0oQU18UE0pLyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoIicxMjg4MzIzNjIzMDA2JyB8IGRhdGU6XCJNTS9kZC95eXl5ICdhdCcgaDptbWFcIiIpKS5nZXRUZXh0KCkpLgogICAgICAgICAgICB0b01hdGNoKC8xMFwvMlxkXC8yMDEwIGF0IFxkezEsMn06XGR7Mn0oQU18UE0pLyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmRhdGVGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwpmdW5jdGlvbiBkYXRlRmlsdGVyKCRsb2NhbGUpIHsKCgogIHZhciBSX0lTTzg2MDFfU1RSID0gL14oXGR7NH0pLT8oXGRcZCktPyhcZFxkKSg/OlQoXGRcZCkoPzo6PyhcZFxkKSg/Ojo/KFxkXGQpKD86XC4oXGQrKSk/KT8pPyhafChbKy1dKShcZFxkKTo/KFxkXGQpKT8pPyQvOwogICAgICAgICAgICAgICAgICAgICAvLyAxICAgICAgICAyICAgICAgIDMgICAgICAgICA0ICAgICAgICAgIDUgICAgICAgICAgNiAgICAgICAgICA3ICAgICAgICAgIDggIDkgICAgIDEwICAgICAgMTEKICBmdW5jdGlvbiBqc29uU3RyaW5nVG9EYXRlKHN0cmluZykgewogICAgdmFyIG1hdGNoOwogICAgaWYgKG1hdGNoID0gc3RyaW5nLm1hdGNoKFJfSVNPODYwMV9TVFIpKSB7CiAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoMCksCiAgICAgICAgICB0ekhvdXIgPSAwLAogICAgICAgICAgdHpNaW4gID0gMCwKICAgICAgICAgIGRhdGVTZXR0ZXIgPSBtYXRjaFs4XSA/IGRhdGUuc2V0VVRDRnVsbFllYXIgOiBkYXRlLnNldEZ1bGxZZWFyLAogICAgICAgICAgdGltZVNldHRlciA9IG1hdGNoWzhdID8gZGF0ZS5zZXRVVENIb3VycyA6IGRhdGUuc2V0SG91cnM7CgogICAgICBpZiAobWF0Y2hbOV0pIHsKICAgICAgICB0ekhvdXIgPSBpbnQobWF0Y2hbOV0gKyBtYXRjaFsxMF0pOwogICAgICAgIHR6TWluID0gaW50KG1hdGNoWzldICsgbWF0Y2hbMTFdKTsKICAgICAgfQogICAgICBkYXRlU2V0dGVyLmNhbGwoZGF0ZSwgaW50KG1hdGNoWzFdKSwgaW50KG1hdGNoWzJdKSAtIDEsIGludChtYXRjaFszXSkpOwogICAgICB2YXIgaCA9IGludChtYXRjaFs0XXx8MCkgLSB0ekhvdXI7CiAgICAgIHZhciBtID0gaW50KG1hdGNoWzVdfHwwKSAtIHR6TWluOwogICAgICB2YXIgcyA9IGludChtYXRjaFs2XXx8MCk7CiAgICAgIHZhciBtcyA9IE1hdGgucm91bmQocGFyc2VGbG9hdCgnMC4nICsgKG1hdGNoWzddfHwwKSkgKiAxMDAwKTsKICAgICAgdGltZVNldHRlci5jYWxsKGRhdGUsIGgsIG0sIHMsIG1zKTsKICAgICAgcmV0dXJuIGRhdGU7CiAgICB9CiAgICByZXR1cm4gc3RyaW5nOwogIH0KCgogIHJldHVybiBmdW5jdGlvbihkYXRlLCBmb3JtYXQsIHRpbWV6b25lKSB7CiAgICB2YXIgdGV4dCA9ICcnLAogICAgICAgIHBhcnRzID0gW10sCiAgICAgICAgZm4sIG1hdGNoOwoKICAgIGZvcm1hdCA9IGZvcm1hdCB8fCAnbWVkaXVtRGF0ZSc7CiAgICBmb3JtYXQgPSAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFNbZm9ybWF0XSB8fCBmb3JtYXQ7CiAgICBpZiAoaXNTdHJpbmcoZGF0ZSkpIHsKICAgICAgZGF0ZSA9IE5VTUJFUl9TVFJJTkcudGVzdChkYXRlKSA/IGludChkYXRlKSA6IGpzb25TdHJpbmdUb0RhdGUoZGF0ZSk7CiAgICB9CgogICAgaWYgKGlzTnVtYmVyKGRhdGUpKSB7CiAgICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlKTsKICAgIH0KCiAgICBpZiAoIWlzRGF0ZShkYXRlKSkgewogICAgICByZXR1cm4gZGF0ZTsKICAgIH0KCiAgICB3aGlsZShmb3JtYXQpIHsKICAgICAgbWF0Y2ggPSBEQVRFX0ZPUk1BVFNfU1BMSVQuZXhlYyhmb3JtYXQpOwogICAgICBpZiAobWF0Y2gpIHsKICAgICAgICBwYXJ0cyA9IGNvbmNhdChwYXJ0cywgbWF0Y2gsIDEpOwogICAgICAgIGZvcm1hdCA9IHBhcnRzLnBvcCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcnRzLnB1c2goZm9ybWF0KTsKICAgICAgICBmb3JtYXQgPSBudWxsOwogICAgICB9CiAgICB9CgogICAgaWYgKHRpbWV6b25lICYmIHRpbWV6b25lID09PSAnVVRDJykgewogICAgICBkYXRlID0gbmV3IERhdGUoZGF0ZS5nZXRUaW1lKCkpOwogICAgICBkYXRlLnNldE1pbnV0ZXMoZGF0ZS5nZXRNaW51dGVzKCkgKyBkYXRlLmdldFRpbWV6b25lT2Zmc2V0KCkpOwogICAgfQogICAgZm9yRWFjaChwYXJ0cywgZnVuY3Rpb24odmFsdWUpewogICAgICBmbiA9IERBVEVfRk9STUFUU1t2YWx1ZV07CiAgICAgIHRleHQgKz0gZm4gPyBmbihkYXRlLCAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFMpCiAgICAgICAgICAgICAgICAgOiB2YWx1ZS5yZXBsYWNlKC8oXid8JyQpL2csICcnKS5yZXBsYWNlKC8nJy9nLCAiJyIpOwogICAgfSk7CgogICAgcmV0dXJuIHRleHQ7CiAgfTsKfQoKCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGpzb24KICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqICAgQWxsb3dzIHlvdSB0byBjb252ZXJ0IGEgSmF2YVNjcmlwdCBvYmplY3QgaW50byBKU09OIHN0cmluZy4KICoKICogICBUaGlzIGZpbHRlciBpcyBtb3N0bHkgdXNlZnVsIGZvciBkZWJ1Z2dpbmcuIFdoZW4gdXNpbmcgdGhlIGRvdWJsZSBjdXJseSB7e3ZhbHVlfX0gbm90YXRpb24KICogICB0aGUgYmluZGluZyBpcyBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBKU09OLgogKgogKiBAcGFyYW0geyp9IG9iamVjdCBBbnkgSmF2YVNjcmlwdCBvYmplY3QgKGluY2x1ZGluZyBhcnJheXMgYW5kIHByaW1pdGl2ZSB0eXBlcykgdG8gZmlsdGVyLgogKiBAcmV0dXJucyB7c3RyaW5nfSBKU09OIHN0cmluZy4KICoKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8cHJlPnt7IHsnbmFtZSc6J3ZhbHVlJ30gfCBqc29uIH19PC9wcmU+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBqc29uaWZ5IGZpbHRlcmVkIG9iamVjdHMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygieyduYW1lJzondmFsdWUnfSIpKS5nZXRUZXh0KCkpLnRvTWF0Y2goL1x7XG4gICJuYW1lIjogPyJ2YWx1ZSJcbn0vKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKgogKi8KZnVuY3Rpb24ganNvbkZpbHRlcigpIHsKICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICByZXR1cm4gdG9Kc29uKG9iamVjdCwgdHJ1ZSk7CiAgfTsKfQoKCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGxvd2VyY2FzZQogKiBAa2luZCBmdW5jdGlvbgogKiBAZGVzY3JpcHRpb24KICogQ29udmVydHMgc3RyaW5nIHRvIGxvd2VyY2FzZS4KICogQHNlZSBhbmd1bGFyLmxvd2VyY2FzZQogKi8KdmFyIGxvd2VyY2FzZUZpbHRlciA9IHZhbHVlRm4obG93ZXJjYXNlKTsKCgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSB1cHBlcmNhc2UKICogQGtpbmQgZnVuY3Rpb24KICogQGRlc2NyaXB0aW9uCiAqIENvbnZlcnRzIHN0cmluZyB0byB1cHBlcmNhc2UuCiAqIEBzZWUgYW5ndWxhci51cHBlcmNhc2UKICovCnZhciB1cHBlcmNhc2VGaWx0ZXIgPSB2YWx1ZUZuKHVwcGVyY2FzZSk7CgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBsaW1pdFRvCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDcmVhdGVzIGEgbmV3IGFycmF5IG9yIHN0cmluZyBjb250YWluaW5nIG9ubHkgYSBzcGVjaWZpZWQgbnVtYmVyIG9mIGVsZW1lbnRzLiBUaGUgZWxlbWVudHMKICogYXJlIHRha2VuIGZyb20gZWl0aGVyIHRoZSBiZWdpbm5pbmcgb3IgdGhlIGVuZCBvZiB0aGUgc291cmNlIGFycmF5LCBzdHJpbmcgb3IgbnVtYmVyLCBhcyBzcGVjaWZpZWQgYnkKICogdGhlIHZhbHVlIGFuZCBzaWduIChwb3NpdGl2ZSBvciBuZWdhdGl2ZSkgb2YgYGxpbWl0YC4gSWYgYSBudW1iZXIgaXMgdXNlZCBhcyBpbnB1dCwgaXQgaXMKICogY29udmVydGVkIHRvIGEgc3RyaW5nLgogKgogKiBAcGFyYW0ge0FycmF5fHN0cmluZ3xudW1iZXJ9IGlucHV0IFNvdXJjZSBhcnJheSwgc3RyaW5nIG9yIG51bWJlciB0byBiZSBsaW1pdGVkLgogKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGxpbWl0IFRoZSBsZW5ndGggb2YgdGhlIHJldHVybmVkIGFycmF5IG9yIHN0cmluZy4gSWYgdGhlIGBsaW1pdGAgbnVtYmVyCiAqICAgICBpcyBwb3NpdGl2ZSwgYGxpbWl0YCBudW1iZXIgb2YgaXRlbXMgZnJvbSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBzb3VyY2UgYXJyYXkvc3RyaW5nIGFyZSBjb3BpZWQuCiAqICAgICBJZiB0aGUgbnVtYmVyIGlzIG5lZ2F0aXZlLCBgbGltaXRgIG51bWJlciAgb2YgaXRlbXMgZnJvbSB0aGUgZW5kIG9mIHRoZSBzb3VyY2UgYXJyYXkvc3RyaW5nCiAqICAgICBhcmUgY29waWVkLiBUaGUgYGxpbWl0YCB3aWxsIGJlIHRyaW1tZWQgaWYgaXQgZXhjZWVkcyBgYXJyYXkubGVuZ3RoYAogKiBAcmV0dXJucyB7QXJyYXl8c3RyaW5nfSBBIG5ldyBzdWItYXJyYXkgb3Igc3Vic3RyaW5nIG9mIGxlbmd0aCBgbGltaXRgIG9yIGxlc3MgaWYgaW5wdXQgYXJyYXkKICogICAgIGhhZCBsZXNzIHRoYW4gYGxpbWl0YCBlbGVtZW50cy4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJsaW1pdFRvRXhhbXBsZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBhbmd1bGFyLm1vZHVsZSgnbGltaXRUb0V4YW1wbGUnLCBbXSkKICAgICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLm51bWJlcnMgPSBbMSwyLDMsNCw1LDYsNyw4LDldOwogICAgICAgICAgICAgJHNjb3BlLmxldHRlcnMgPSAiYWJjZGVmZ2hpIjsKICAgICAgICAgICAgICRzY29wZS5sb25nTnVtYmVyID0gMjM0NTQzMjM0MjsKICAgICAgICAgICAgICRzY29wZS5udW1MaW1pdCA9IDM7CiAgICAgICAgICAgICAkc2NvcGUubGV0dGVyTGltaXQgPSAzOwogICAgICAgICAgICAgJHNjb3BlLmxvbmdOdW1iZXJMaW1pdCA9IDM7CiAgICAgICAgICAgfV0pOwogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgTGltaXQge3tudW1iZXJzfX0gdG86IDxpbnB1dCB0eXBlPSJudW1iZXIiIHN0ZXA9IjEiIG5nLW1vZGVsPSJudW1MaW1pdCI+CiAgICAgICAgIDxwPk91dHB1dCBudW1iZXJzOiB7eyBudW1iZXJzIHwgbGltaXRUbzpudW1MaW1pdCB9fTwvcD4KICAgICAgICAgTGltaXQge3tsZXR0ZXJzfX0gdG86IDxpbnB1dCB0eXBlPSJudW1iZXIiIHN0ZXA9IjEiIG5nLW1vZGVsPSJsZXR0ZXJMaW1pdCI+CiAgICAgICAgIDxwPk91dHB1dCBsZXR0ZXJzOiB7eyBsZXR0ZXJzIHwgbGltaXRUbzpsZXR0ZXJMaW1pdCB9fTwvcD4KICAgICAgICAgTGltaXQge3tsb25nTnVtYmVyfX0gdG86IDxpbnB1dCB0eXBlPSJudW1iZXIiIHN0ZXA9IjEiIG5nLW1vZGVsPSJsb25nTnVtYmVyTGltaXQiPgogICAgICAgICA8cD5PdXRwdXQgbG9uZyBudW1iZXI6IHt7IGxvbmdOdW1iZXIgfCBsaW1pdFRvOmxvbmdOdW1iZXJMaW1pdCB9fTwvcD4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIHZhciBudW1MaW1pdElucHV0ID0gZWxlbWVudChieS5tb2RlbCgnbnVtTGltaXQnKSk7CiAgICAgICB2YXIgbGV0dGVyTGltaXRJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ2xldHRlckxpbWl0JykpOwogICAgICAgdmFyIGxvbmdOdW1iZXJMaW1pdElucHV0ID0gZWxlbWVudChieS5tb2RlbCgnbG9uZ051bWJlckxpbWl0JykpOwogICAgICAgdmFyIGxpbWl0ZWROdW1iZXJzID0gZWxlbWVudChieS5iaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpudW1MaW1pdCcpKTsKICAgICAgIHZhciBsaW1pdGVkTGV0dGVycyA9IGVsZW1lbnQoYnkuYmluZGluZygnbGV0dGVycyB8IGxpbWl0VG86bGV0dGVyTGltaXQnKSk7CiAgICAgICB2YXIgbGltaXRlZExvbmdOdW1iZXIgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ2xvbmdOdW1iZXIgfCBsaW1pdFRvOmxvbmdOdW1iZXJMaW1pdCcpKTsKCiAgICAgICBpdCgnc2hvdWxkIGxpbWl0IHRoZSBudW1iZXIgYXJyYXkgdG8gZmlyc3QgdGhyZWUgaXRlbXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KG51bUxpbWl0SW5wdXQuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0JlKCczJyk7CiAgICAgICAgIGV4cGVjdChsZXR0ZXJMaW1pdElucHV0LmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9CZSgnMycpOwogICAgICAgICBleHBlY3QobG9uZ051bWJlckxpbWl0SW5wdXQuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0JlKCczJyk7CiAgICAgICAgIGV4cGVjdChsaW1pdGVkTnVtYmVycy5nZXRUZXh0KCkpLnRvRXF1YWwoJ091dHB1dCBudW1iZXJzOiBbMSwyLDNdJyk7CiAgICAgICAgIGV4cGVjdChsaW1pdGVkTGV0dGVycy5nZXRUZXh0KCkpLnRvRXF1YWwoJ091dHB1dCBsZXR0ZXJzOiBhYmMnKTsKICAgICAgICAgZXhwZWN0KGxpbWl0ZWRMb25nTnVtYmVyLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IGxvbmcgbnVtYmVyOiAyMzQnKTsKICAgICAgIH0pOwoKICAgICAgIC8vIFRoZXJlIGlzIGEgYnVnIGluIHNhZmFyaSBhbmQgcHJvdHJhY3RvciB0aGF0IGRvZXNuJ3QgbGlrZSB0aGUgbWludXMga2V5CiAgICAgICAvLyBpdCgnc2hvdWxkIHVwZGF0ZSB0aGUgb3V0cHV0IHdoZW4gLTMgaXMgZW50ZXJlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgLy8gICBudW1MaW1pdElucHV0LmNsZWFyKCk7CiAgICAgICAvLyAgIG51bUxpbWl0SW5wdXQuc2VuZEtleXMoJy0zJyk7CiAgICAgICAvLyAgIGxldHRlckxpbWl0SW5wdXQuY2xlYXIoKTsKICAgICAgIC8vICAgbGV0dGVyTGltaXRJbnB1dC5zZW5kS2V5cygnLTMnKTsKICAgICAgIC8vICAgbG9uZ051bWJlckxpbWl0SW5wdXQuY2xlYXIoKTsKICAgICAgIC8vICAgbG9uZ051bWJlckxpbWl0SW5wdXQuc2VuZEtleXMoJy0zJyk7CiAgICAgICAvLyAgIGV4cGVjdChsaW1pdGVkTnVtYmVycy5nZXRUZXh0KCkpLnRvRXF1YWwoJ091dHB1dCBudW1iZXJzOiBbNyw4LDldJyk7CiAgICAgICAvLyAgIGV4cGVjdChsaW1pdGVkTGV0dGVycy5nZXRUZXh0KCkpLnRvRXF1YWwoJ091dHB1dCBsZXR0ZXJzOiBnaGknKTsKICAgICAgIC8vICAgZXhwZWN0KGxpbWl0ZWRMb25nTnVtYmVyLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IGxvbmcgbnVtYmVyOiAzNDInKTsKICAgICAgIC8vIH0pOwoKICAgICAgIGl0KCdzaG91bGQgbm90IGV4Y2VlZCB0aGUgbWF4aW11bSBzaXplIG9mIGlucHV0IGFycmF5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIG51bUxpbWl0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgbnVtTGltaXRJbnB1dC5zZW5kS2V5cygnMTAwJyk7CiAgICAgICAgIGxldHRlckxpbWl0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgbGV0dGVyTGltaXRJbnB1dC5zZW5kS2V5cygnMTAwJyk7CiAgICAgICAgIGxvbmdOdW1iZXJMaW1pdElucHV0LmNsZWFyKCk7CiAgICAgICAgIGxvbmdOdW1iZXJMaW1pdElucHV0LnNlbmRLZXlzKCcxMDAnKTsKICAgICAgICAgZXhwZWN0KGxpbWl0ZWROdW1iZXJzLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IG51bWJlcnM6IFsxLDIsMyw0LDUsNiw3LDgsOV0nKTsKICAgICAgICAgZXhwZWN0KGxpbWl0ZWRMZXR0ZXJzLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IGxldHRlcnM6IGFiY2RlZmdoaScpOwogICAgICAgICBleHBlY3QobGltaXRlZExvbmdOdW1iZXIuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbG9uZyBudW1iZXI6IDIzNDU0MzIzNDInKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgoqLwpmdW5jdGlvbiBsaW1pdFRvRmlsdGVyKCl7CiAgcmV0dXJuIGZ1bmN0aW9uKGlucHV0LCBsaW1pdCkgewogICAgaWYgKGlzTnVtYmVyKGlucHV0KSkgaW5wdXQgPSBpbnB1dC50b1N0cmluZygpOwogICAgaWYgKCFpc0FycmF5KGlucHV0KSAmJiAhaXNTdHJpbmcoaW5wdXQpKSByZXR1cm4gaW5wdXQ7CgogICAgaWYgKE1hdGguYWJzKE51bWJlcihsaW1pdCkpID09PSBJbmZpbml0eSkgewogICAgICBsaW1pdCA9IE51bWJlcihsaW1pdCk7CiAgICB9IGVsc2UgewogICAgICBsaW1pdCA9IGludChsaW1pdCk7CiAgICB9CgogICAgaWYgKGlzU3RyaW5nKGlucHV0KSkgewogICAgICAvL05hTiBjaGVjayBvbiBsaW1pdAogICAgICBpZiAobGltaXQpIHsKICAgICAgICByZXR1cm4gbGltaXQgPj0gMCA/IGlucHV0LnNsaWNlKDAsIGxpbWl0KSA6IGlucHV0LnNsaWNlKGxpbWl0LCBpbnB1dC5sZW5ndGgpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAiIjsKICAgICAgfQogICAgfQoKICAgIHZhciBvdXQgPSBbXSwKICAgICAgaSwgbjsKCiAgICAvLyBpZiBhYnMobGltaXQpIGV4Y2VlZHMgbWF4aW11bSBsZW5ndGgsIHRyaW0gaXQKICAgIGlmIChsaW1pdCA+IGlucHV0Lmxlbmd0aCkKICAgICAgbGltaXQgPSBpbnB1dC5sZW5ndGg7CiAgICBlbHNlIGlmIChsaW1pdCA8IC1pbnB1dC5sZW5ndGgpCiAgICAgIGxpbWl0ID0gLWlucHV0Lmxlbmd0aDsKCiAgICBpZiAobGltaXQgPiAwKSB7CiAgICAgIGkgPSAwOwogICAgICBuID0gbGltaXQ7CiAgICB9IGVsc2UgewogICAgICBpID0gaW5wdXQubGVuZ3RoICsgbGltaXQ7CiAgICAgIG4gPSBpbnB1dC5sZW5ndGg7CiAgICB9CgogICAgZm9yICg7IGk8bjsgaSsrKSB7CiAgICAgIG91dC5wdXNoKGlucHV0W2ldKTsKICAgIH0KCiAgICByZXR1cm4gb3V0OwogIH07Cn0KCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIG9yZGVyQnkKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIE9yZGVycyBhIHNwZWNpZmllZCBgYXJyYXlgIGJ5IHRoZSBgZXhwcmVzc2lvbmAgcHJlZGljYXRlLiBJdCBpcyBvcmRlcmVkIGFscGhhYmV0aWNhbGx5CiAqIGZvciBzdHJpbmdzIGFuZCBudW1lcmljYWxseSBmb3IgbnVtYmVycy4gTm90ZTogaWYgeW91IG5vdGljZSBudW1iZXJzIGFyZSBub3QgYmVpbmcgc29ydGVkCiAqIGNvcnJlY3RseSwgbWFrZSBzdXJlIHRoZXkgYXJlIGFjdHVhbGx5IGJlaW5nIHNhdmVkIGFzIG51bWJlcnMgYW5kIG5vdCBzdHJpbmdzLgogKgogKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc29ydC4KICogQHBhcmFtIHtmdW5jdGlvbigqKXxzdHJpbmd8QXJyYXkuPChmdW5jdGlvbigqKXxzdHJpbmcpPj19IGV4cHJlc3Npb24gQSBwcmVkaWNhdGUgdG8gYmUKICogICAgdXNlZCBieSB0aGUgY29tcGFyYXRvciB0byBkZXRlcm1pbmUgdGhlIG9yZGVyIG9mIGVsZW1lbnRzLgogKgogKiAgICBDYW4gYmUgb25lIG9mOgogKgogKiAgICAtIGBmdW5jdGlvbmA6IEdldHRlciBmdW5jdGlvbi4gVGhlIHJlc3VsdCBvZiB0aGlzIGZ1bmN0aW9uIHdpbGwgYmUgc29ydGVkIHVzaW5nIHRoZQogKiAgICAgIGA8YCwgYD1gLCBgPmAgb3BlcmF0b3IuCiAqICAgIC0gYHN0cmluZ2A6IEFuIEFuZ3VsYXIgZXhwcmVzc2lvbi4gVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gaXMgdXNlZCB0byBjb21wYXJlIGVsZW1lbnRzCiAqICAgICAgKGZvciBleGFtcGxlIGBuYW1lYCB0byBzb3J0IGJ5IGEgcHJvcGVydHkgY2FsbGVkIGBuYW1lYCBvciBgbmFtZS5zdWJzdHIoMCwgMylgIHRvIHNvcnQgYnkKICogICAgICAzIGZpcnN0IGNoYXJhY3RlcnMgb2YgYSBwcm9wZXJ0eSBjYWxsZWQgYG5hbWVgKS4gVGhlIHJlc3VsdCBvZiBhIGNvbnN0YW50IGV4cHJlc3Npb24KICogICAgICBpcyBpbnRlcnByZXRlZCBhcyBhIHByb3BlcnR5IG5hbWUgdG8gYmUgdXNlZCBpbiBjb21wYXJpc29ucyAoZm9yIGV4YW1wbGUgYCJzcGVjaWFsIG5hbWUiYAogKiAgICAgIHRvIHNvcnQgb2JqZWN0IGJ5IHRoZSB2YWx1ZSBvZiB0aGVpciBgc3BlY2lhbCBuYW1lYCBwcm9wZXJ0eSkuIEFuIGV4cHJlc3Npb24gY2FuIGJlCiAqICAgICAgb3B0aW9uYWxseSBwcmVmaXhlZCB3aXRoIGArYCBvciBgLWAgdG8gY29udHJvbCBhc2NlbmRpbmcgb3IgZGVzY2VuZGluZyBzb3J0IG9yZGVyCiAqICAgICAgKGZvciBleGFtcGxlLCBgK25hbWVgIG9yIGAtbmFtZWApLiBJZiBubyBwcm9wZXJ0eSBpcyBwcm92aWRlZCwgKGUuZy4gYCcrJ2ApIHRoZW4gdGhlIGFycmF5CiAqICAgICAgZWxlbWVudCBpdHNlbGYgaXMgdXNlZCB0byBjb21wYXJlIHdoZXJlIHNvcnRpbmcuCiAqICAgIC0gYEFycmF5YDogQW4gYXJyYXkgb2YgZnVuY3Rpb24gb3Igc3RyaW5nIHByZWRpY2F0ZXMuIFRoZSBmaXJzdCBwcmVkaWNhdGUgaW4gdGhlIGFycmF5CiAqICAgICAgaXMgdXNlZCBmb3Igc29ydGluZywgYnV0IHdoZW4gdHdvIGl0ZW1zIGFyZSBlcXVpdmFsZW50LCB0aGUgbmV4dCBwcmVkaWNhdGUgaXMgdXNlZC4KICoKICogICAgSWYgdGhlIHByZWRpY2F0ZSBpcyBtaXNzaW5nIG9yIGVtcHR5IHRoZW4gaXQgZGVmYXVsdHMgdG8gYCcrJ2AuCiAqCiAqIEBwYXJhbSB7Ym9vbGVhbj19IHJldmVyc2UgUmV2ZXJzZSB0aGUgb3JkZXIgb2YgdGhlIGFycmF5LgogKiBAcmV0dXJucyB7QXJyYXl9IFNvcnRlZCBjb3B5IG9mIHRoZSBzb3VyY2UgYXJyYXkuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0ib3JkZXJCeUV4YW1wbGUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ29yZGVyQnlFeGFtcGxlJywgW10pCiAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS5mcmllbmRzID0KICAgICAgICAgICAgICAgICBbe25hbWU6J0pvaG4nLCBwaG9uZTonNTU1LTEyMTInLCBhZ2U6MTB9LAogICAgICAgICAgICAgICAgICB7bmFtZTonTWFyeScsIHBob25lOic1NTUtOTg3NicsIGFnZToxOX0sCiAgICAgICAgICAgICAgICAgIHtuYW1lOidNaWtlJywgcGhvbmU6JzU1NS00MzIxJywgYWdlOjIxfSwKICAgICAgICAgICAgICAgICAge25hbWU6J0FkYW0nLCBwaG9uZTonNTU1LTU2NzgnLCBhZ2U6MzV9LAogICAgICAgICAgICAgICAgICB7bmFtZTonSnVsaWUnLCBwaG9uZTonNTU1LTg3NjUnLCBhZ2U6Mjl9XTsKICAgICAgICAgICAgICRzY29wZS5wcmVkaWNhdGUgPSAnLWFnZSc7CiAgICAgICAgICAgfV0pOwogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgPHByZT5Tb3J0aW5nIHByZWRpY2F0ZSA9IHt7cHJlZGljYXRlfX07IHJldmVyc2UgPSB7e3JldmVyc2V9fTwvcHJlPgogICAgICAgICA8aHIvPgogICAgICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZT0nJyI+dW5zb3J0ZWQ8L2E+IF0KICAgICAgICAgPHRhYmxlIGNsYXNzPSJmcmllbmQiPgogICAgICAgICAgIDx0cj4KICAgICAgICAgICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAnbmFtZSc7IHJldmVyc2U9ZmFsc2UiPk5hbWU8L2E+CiAgICAgICAgICAgICAgICAgKDxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICctbmFtZSc7IHJldmVyc2U9ZmFsc2UiPl48L2E+KTwvdGg+CiAgICAgICAgICAgICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlID0gJ3Bob25lJzsgcmV2ZXJzZT0hcmV2ZXJzZSI+UGhvbmUgTnVtYmVyPC9hPjwvdGg+CiAgICAgICAgICAgICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlID0gJ2FnZSc7IHJldmVyc2U9IXJldmVyc2UiPkFnZTwvYT48L3RoPgogICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMgfCBvcmRlckJ5OnByZWRpY2F0ZTpyZXZlcnNlIj4KICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLnBob25lfX08L3RkPgogICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLmFnZX19PC90ZD4KICAgICAgICAgICA8L3RyPgogICAgICAgICA8L3RhYmxlPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqCiAqIEl0J3MgYWxzbyBwb3NzaWJsZSB0byBjYWxsIHRoZSBvcmRlckJ5IGZpbHRlciBtYW51YWxseSwgYnkgaW5qZWN0aW5nIGAkZmlsdGVyYCwgcmV0cmlldmluZyB0aGUKICogZmlsdGVyIHJvdXRpbmUgd2l0aCBgJGZpbHRlcignb3JkZXJCeScpYCwgYW5kIGNhbGxpbmcgdGhlIHJldHVybmVkIGZpbHRlciByb3V0aW5lIHdpdGggdGhlCiAqIGRlc2lyZWQgcGFyYW1ldGVycy4KICoKICogRXhhbXBsZToKICoKICogQGV4YW1wbGUKICA8ZXhhbXBsZSBtb2R1bGU9Im9yZGVyQnlFeGFtcGxlIj4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICA8dGFibGUgY2xhc3M9ImZyaWVuZCI+CiAgICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJyZXZlcnNlPWZhbHNlO29yZGVyKCduYW1lJywgZmFsc2UpIj5OYW1lPC9hPgogICAgICAgICAgICAgICg8YSBocmVmPSIiIG5nLWNsaWNrPSJvcmRlcignLW5hbWUnLGZhbHNlKSI+XjwvYT4pPC90aD4KICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InJldmVyc2U9IXJldmVyc2U7b3JkZXIoJ3Bob25lJywgcmV2ZXJzZSkiPlBob25lIE51bWJlcjwvYT48L3RoPgogICAgICAgICAgICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icmV2ZXJzZT0hcmV2ZXJzZTtvcmRlcignYWdlJyxyZXZlcnNlKSI+QWdlPC9hPjwvdGg+CiAgICAgICAgICA8L3RyPgogICAgICAgICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMiPgogICAgICAgICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLnBob25lfX08L3RkPgogICAgICAgICAgICA8dGQ+e3tmcmllbmQuYWdlfX08L3RkPgogICAgICAgICAgPC90cj4KICAgICAgICA8L3RhYmxlPgogICAgICA8L2Rpdj4KICAgIDwvZmlsZT4KCiAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICBhbmd1bGFyLm1vZHVsZSgnb3JkZXJCeUV4YW1wbGUnLCBbXSkKICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsICckZmlsdGVyJywgZnVuY3Rpb24oJHNjb3BlLCAkZmlsdGVyKSB7CiAgICAgICAgICB2YXIgb3JkZXJCeSA9ICRmaWx0ZXIoJ29yZGVyQnknKTsKICAgICAgICAgICRzY29wZS5mcmllbmRzID0gWwogICAgICAgICAgICB7IG5hbWU6ICdKb2huJywgICAgcGhvbmU6ICc1NTUtMTIxMicsICAgIGFnZTogMTAgfSwKICAgICAgICAgICAgeyBuYW1lOiAnTWFyeScsICAgIHBob25lOiAnNTU1LTk4NzYnLCAgICBhZ2U6IDE5IH0sCiAgICAgICAgICAgIHsgbmFtZTogJ01pa2UnLCAgICBwaG9uZTogJzU1NS00MzIxJywgICAgYWdlOiAyMSB9LAogICAgICAgICAgICB7IG5hbWU6ICdBZGFtJywgICAgcGhvbmU6ICc1NTUtNTY3OCcsICAgIGFnZTogMzUgfSwKICAgICAgICAgICAgeyBuYW1lOiAnSnVsaWUnLCAgIHBob25lOiAnNTU1LTg3NjUnLCAgICBhZ2U6IDI5IH0KICAgICAgICAgIF07CiAgICAgICAgICAkc2NvcGUub3JkZXIgPSBmdW5jdGlvbihwcmVkaWNhdGUsIHJldmVyc2UpIHsKICAgICAgICAgICAgJHNjb3BlLmZyaWVuZHMgPSBvcmRlckJ5KCRzY29wZS5mcmllbmRzLCBwcmVkaWNhdGUsIHJldmVyc2UpOwogICAgICAgICAgfTsKICAgICAgICAgICRzY29wZS5vcmRlcignLWFnZScsZmFsc2UpOwogICAgICAgIH1dKTsKICAgIDwvZmlsZT4KPC9leGFtcGxlPgogKi8Kb3JkZXJCeUZpbHRlci4kaW5qZWN0ID0gWyckcGFyc2UnXTsKZnVuY3Rpb24gb3JkZXJCeUZpbHRlcigkcGFyc2UpewogIHJldHVybiBmdW5jdGlvbihhcnJheSwgc29ydFByZWRpY2F0ZSwgcmV2ZXJzZU9yZGVyKSB7CiAgICBpZiAoIShpc0FycmF5TGlrZShhcnJheSkpKSByZXR1cm4gYXJyYXk7CiAgICBzb3J0UHJlZGljYXRlID0gaXNBcnJheShzb3J0UHJlZGljYXRlKSA/IHNvcnRQcmVkaWNhdGU6IFtzb3J0UHJlZGljYXRlXTsKICAgIGlmIChzb3J0UHJlZGljYXRlLmxlbmd0aCA9PT0gMCkgeyBzb3J0UHJlZGljYXRlID0gWycrJ107IH0KICAgIHNvcnRQcmVkaWNhdGUgPSBzb3J0UHJlZGljYXRlLm1hcChmdW5jdGlvbihwcmVkaWNhdGUpewogICAgICB2YXIgZGVzY2VuZGluZyA9IGZhbHNlLCBnZXQgPSBwcmVkaWNhdGUgfHwgaWRlbnRpdHk7CiAgICAgIGlmIChpc1N0cmluZyhwcmVkaWNhdGUpKSB7CiAgICAgICAgaWYgKChwcmVkaWNhdGUuY2hhckF0KDApID09ICcrJyB8fCBwcmVkaWNhdGUuY2hhckF0KDApID09ICctJykpIHsKICAgICAgICAgIGRlc2NlbmRpbmcgPSBwcmVkaWNhdGUuY2hhckF0KDApID09ICctJzsKICAgICAgICAgIHByZWRpY2F0ZSA9IHByZWRpY2F0ZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgfQogICAgICAgIGlmICggcHJlZGljYXRlID09PSAnJyApIHsKICAgICAgICAgIC8vIEVmZmVjdGl2ZWx5IG5vIHByZWRpY2F0ZSB3YXMgcGFzc2VkIHNvIHdlIGNvbXBhcmUgaWRlbnRpdHkKICAgICAgICAgIHJldHVybiByZXZlcnNlQ29tcGFyYXRvcihmdW5jdGlvbihhLGIpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmUoYSwgYik7CiAgICAgICAgICB9LCBkZXNjZW5kaW5nKTsKICAgICAgICB9CiAgICAgICAgZ2V0ID0gJHBhcnNlKHByZWRpY2F0ZSk7CiAgICAgICAgaWYgKGdldC5jb25zdGFudCkgewogICAgICAgICAgdmFyIGtleSA9IGdldCgpOwogICAgICAgICAgcmV0dXJuIHJldmVyc2VDb21wYXJhdG9yKGZ1bmN0aW9uKGEsYikgewogICAgICAgICAgICByZXR1cm4gY29tcGFyZShhW2tleV0sIGJba2V5XSk7CiAgICAgICAgICB9LCBkZXNjZW5kaW5nKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJldmVyc2VDb21wYXJhdG9yKGZ1bmN0aW9uKGEsYil7CiAgICAgICAgcmV0dXJuIGNvbXBhcmUoZ2V0KGEpLGdldChiKSk7CiAgICAgIH0sIGRlc2NlbmRpbmcpOwogICAgfSk7CiAgICB2YXIgYXJyYXlDb3B5ID0gW107CiAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgeyBhcnJheUNvcHkucHVzaChhcnJheVtpXSk7IH0KICAgIHJldHVybiBhcnJheUNvcHkuc29ydChyZXZlcnNlQ29tcGFyYXRvcihjb21wYXJhdG9yLCByZXZlcnNlT3JkZXIpKTsKCiAgICBmdW5jdGlvbiBjb21wYXJhdG9yKG8xLCBvMil7CiAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHNvcnRQcmVkaWNhdGUubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgY29tcCA9IHNvcnRQcmVkaWNhdGVbaV0obzEsIG8yKTsKICAgICAgICBpZiAoY29tcCAhPT0gMCkgcmV0dXJuIGNvbXA7CiAgICAgIH0KICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICBmdW5jdGlvbiByZXZlcnNlQ29tcGFyYXRvcihjb21wLCBkZXNjZW5kaW5nKSB7CiAgICAgIHJldHVybiBkZXNjZW5kaW5nCiAgICAgICAgICA/IGZ1bmN0aW9uKGEsYil7cmV0dXJuIGNvbXAoYixhKTt9CiAgICAgICAgICA6IGNvbXA7CiAgICB9CiAgICBmdW5jdGlvbiBjb21wYXJlKHYxLCB2Mil7CiAgICAgIHZhciB0MSA9IHR5cGVvZiB2MTsKICAgICAgdmFyIHQyID0gdHlwZW9mIHYyOwogICAgICBpZiAodDEgPT0gdDIpIHsKICAgICAgICBpZiAoaXNEYXRlKHYxKSAmJiBpc0RhdGUodjIpKSB7CiAgICAgICAgICB2MSA9IHYxLnZhbHVlT2YoKTsKICAgICAgICAgIHYyID0gdjIudmFsdWVPZigpOwogICAgICAgIH0KICAgICAgICBpZiAodDEgPT0gInN0cmluZyIpIHsKICAgICAgICAgICB2MSA9IHYxLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgdjIgPSB2Mi50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0KICAgICAgICBpZiAodjEgPT09IHYyKSByZXR1cm4gMDsKICAgICAgICByZXR1cm4gdjEgPCB2MiA/IC0xIDogMTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdDEgPCB0MiA/IC0xIDogMTsKICAgICAgfQogICAgfQogIH07Cn0KCmZ1bmN0aW9uIG5nRGlyZWN0aXZlKGRpcmVjdGl2ZSkgewogIGlmIChpc0Z1bmN0aW9uKGRpcmVjdGl2ZSkpIHsKICAgIGRpcmVjdGl2ZSA9IHsKICAgICAgbGluazogZGlyZWN0aXZlCiAgICB9OwogIH0KICBkaXJlY3RpdmUucmVzdHJpY3QgPSBkaXJlY3RpdmUucmVzdHJpY3QgfHwgJ0FDJzsKICByZXR1cm4gdmFsdWVGbihkaXJlY3RpdmUpOwp9CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBhCiAqIEByZXN0cmljdCBFCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBNb2RpZmllcyB0aGUgZGVmYXVsdCBiZWhhdmlvciBvZiB0aGUgaHRtbCBBIHRhZyBzbyB0aGF0IHRoZSBkZWZhdWx0IGFjdGlvbiBpcyBwcmV2ZW50ZWQgd2hlbgogKiB0aGUgaHJlZiBhdHRyaWJ1dGUgaXMgZW1wdHkuCiAqCiAqIFRoaXMgY2hhbmdlIHBlcm1pdHMgdGhlIGVhc3kgY3JlYXRpb24gb2YgYWN0aW9uIGxpbmtzIHdpdGggdGhlIGBuZ0NsaWNrYCBkaXJlY3RpdmUKICogd2l0aG91dCBjaGFuZ2luZyB0aGUgbG9jYXRpb24gb3IgY2F1c2luZyBwYWdlIHJlbG9hZHMsIGUuZy46CiAqIGA8YSBocmVmPSIiIG5nLWNsaWNrPSJsaXN0LmFkZEl0ZW0oKSI+QWRkIEl0ZW08L2E+YAogKi8KdmFyIGh0bWxBbmNob3JEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICByZXN0cmljdDogJ0UnLAogIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgIGlmICghYXR0ci5ocmVmICYmICFhdHRyLnhsaW5rSHJlZiAmJiAhYXR0ci5uYW1lKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCkgewogICAgICAgIC8vIFNWR0FFbGVtZW50IGRvZXMgbm90IHVzZSB0aGUgaHJlZiBhdHRyaWJ1dGUsIGJ1dCByYXRoZXIgdGhlICd4bGlua0hyZWYnIGF0dHJpYnV0ZS4KICAgICAgICB2YXIgaHJlZiA9IHRvU3RyaW5nLmNhbGwoZWxlbWVudC5wcm9wKCdocmVmJykpID09PSAnW29iamVjdCBTVkdBbmltYXRlZFN0cmluZ10nID8KICAgICAgICAgICAgICAgICAgICd4bGluazpocmVmJyA6ICdocmVmJzsKICAgICAgICBlbGVtZW50Lm9uKCdjbGljaycsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICAgIC8vIGlmIHdlIGhhdmUgbm8gaHJlZiB1cmwsIHRoZW4gZG9uJ3QgbmF2aWdhdGUgYW55d2hlcmUuCiAgICAgICAgICBpZiAoIWVsZW1lbnQuYXR0cihocmVmKSkgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9OwogICAgfQogIH0KfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0hyZWYKICogQHJlc3RyaWN0IEEKICogQHByaW9yaXR5IDk5CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBVc2luZyBBbmd1bGFyIG1hcmt1cCBsaWtlIGB7e2hhc2h9fWAgaW4gYW4gaHJlZiBhdHRyaWJ1dGUgd2lsbAogKiBtYWtlIHRoZSBsaW5rIGdvIHRvIHRoZSB3cm9uZyBVUkwgaWYgdGhlIHVzZXIgY2xpY2tzIGl0IGJlZm9yZQogKiBBbmd1bGFyIGhhcyBhIGNoYW5jZSB0byByZXBsYWNlIHRoZSBge3toYXNofX1gIG1hcmt1cCB3aXRoIGl0cwogKiB2YWx1ZS4gVW50aWwgQW5ndWxhciByZXBsYWNlcyB0aGUgbWFya3VwIHRoZSBsaW5rIHdpbGwgYmUgYnJva2VuCiAqIGFuZCB3aWxsIG1vc3QgbGlrZWx5IHJldHVybiBhIDQwNCBlcnJvci4KICoKICogVGhlIGBuZ0hyZWZgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtLgogKgogKiBUaGUgd3Jvbmcgd2F5IHRvIHdyaXRlIGl0OgogKiBgYGBodG1sCiAqIDxhIGhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSI+bGluazE8L2E+CiAqIGBgYAogKgogKiBUaGUgY29ycmVjdCB3YXkgdG8gd3JpdGUgaXQ6CiAqIGBgYGh0bWwKICogPGEgbmctaHJlZj0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ij5saW5rMTwvYT4KICogYGBgCiAqCiAqIEBlbGVtZW50IEEKICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdIcmVmIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICoKICogQGV4YW1wbGUKICogVGhpcyBleGFtcGxlIHNob3dzIHZhcmlvdXMgY29tYmluYXRpb25zIG9mIGBocmVmYCwgYG5nLWhyZWZgIGFuZCBgbmctY2xpY2tgIGF0dHJpYnV0ZXMKICogaW4gbGlua3MgYW5kIHRoZWlyIGRpZmZlcmVudCBiZWhhdmlvcnM6CiAgICA8ZXhhbXBsZT4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPGlucHV0IG5nLW1vZGVsPSJ2YWx1ZSIgLz48YnIgLz4KICAgICAgICA8YSBpZD0ibGluay0xIiBocmVmIG5nLWNsaWNrPSJ2YWx1ZSA9IDEiPmxpbmsgMTwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay0yIiBocmVmPSIiIG5nLWNsaWNrPSJ2YWx1ZSA9IDIiPmxpbmsgMjwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay0zIiBuZy1ocmVmPSIve3snMTIzJ319Ij5saW5rIDM8L2E+IChsaW5rLCByZWxvYWQhKTxiciAvPgogICAgICAgIDxhIGlkPSJsaW5rLTQiIGhyZWY9IiIgbmFtZT0ieHgiIG5nLWNsaWNrPSJ2YWx1ZSA9IDQiPmFuY2hvcjwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay01IiBuYW1lPSJ4eHgiIG5nLWNsaWNrPSJ2YWx1ZSA9IDUiPmFuY2hvcjwvYT4gKG5vIGxpbmspPGJyIC8+CiAgICAgICAgPGEgaWQ9ImxpbmstNiIgbmctaHJlZj0ie3t2YWx1ZX19Ij5saW5rPC9hPiAobGluaywgY2hhbmdlIGxvY2F0aW9uKQogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIGhyZWYgd2l0aG91dCB2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudChieS5pZCgnbGluay0xJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0VxdWFsKCcxJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay0xJykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b0JlKCcnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiBlbXB0eSBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ2xpbmstMicpKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9FcXVhbCgnMicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2xpbmstMicpKS5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSkudG9CZSgnJyk7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBhbmQgY2hhbmdlIHVybCB3aGVuIG5nLWhyZWYgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay0zJykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b01hdGNoKC9cLzEyMyQvKTsKCiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTMnKSkuY2xpY2soKTsKCiAgICAgICAgICAvLyBBdCB0aGlzIHBvaW50LCB3ZSBuYXZpZ2F0ZSBhd2F5IGZyb20gYW4gQW5ndWxhciBwYWdlLCBzbyB3ZSBuZWVkCiAgICAgICAgICAvLyB0byB1c2UgYnJvd3Nlci5kcml2ZXIgdG8gZ2V0IHRoZSBiYXNlIHdlYmRyaXZlci4KCiAgICAgICAgICBicm93c2VyLndhaXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBicm93c2VyLmRyaXZlci5nZXRDdXJyZW50VXJsKCkudGhlbihmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgICByZXR1cm4gdXJsLm1hdGNoKC9cLzEyMyQvKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LCA1MDAwLCAncGFnZSBzaG91bGQgbmF2aWdhdGUgdG8gLzEyMycpOwogICAgICAgIH0pOwoKICAgICAgICB4aXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiBlbXB0eSBzdHJpbmcgYW5kIG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTQnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvRXF1YWwoJzQnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTQnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvQmUoJycpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBubyBocmVmIGJ1dCBuYW1lIHNwZWNpZmllZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudChieS5pZCgnbGluay01JykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0VxdWFsKCc1Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay01JykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b0JlKG51bGwpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIG9ubHkgY2hhbmdlIHVybCB3aGVuIG9ubHkgbmctaHJlZicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuY2xlYXIoKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpLnNlbmRLZXlzKCc2Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay02JykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b01hdGNoKC9cLzYkLyk7CgogICAgICAgICAgZWxlbWVudChieS5pZCgnbGluay02JykpLmNsaWNrKCk7CgogICAgICAgICAgLy8gQXQgdGhpcyBwb2ludCwgd2UgbmF2aWdhdGUgYXdheSBmcm9tIGFuIEFuZ3VsYXIgcGFnZSwgc28gd2UgbmVlZAogICAgICAgICAgLy8gdG8gdXNlIGJyb3dzZXIuZHJpdmVyIHRvIGdldCB0aGUgYmFzZSB3ZWJkcml2ZXIuCiAgICAgICAgICBicm93c2VyLndhaXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBicm93c2VyLmRyaXZlci5nZXRDdXJyZW50VXJsKCkudGhlbihmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgICByZXR1cm4gdXJsLm1hdGNoKC9cLzYkLyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwgNTAwMCwgJ3BhZ2Ugc2hvdWxkIG5hdmlnYXRlIHRvIC82Jyk7CiAgICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1NyYwogKiBAcmVzdHJpY3QgQQogKiBAcHJpb3JpdHkgOTkKICoKICogQGRlc2NyaXB0aW9uCiAqIFVzaW5nIEFuZ3VsYXIgbWFya3VwIGxpa2UgYHt7aGFzaH19YCBpbiBhIGBzcmNgIGF0dHJpYnV0ZSBkb2Vzbid0CiAqIHdvcmsgcmlnaHQ6IFRoZSBicm93c2VyIHdpbGwgZmV0Y2ggZnJvbSB0aGUgVVJMIHdpdGggdGhlIGxpdGVyYWwKICogdGV4dCBge3toYXNofX1gIHVudGlsIEFuZ3VsYXIgcmVwbGFjZXMgdGhlIGV4cHJlc3Npb24gaW5zaWRlCiAqIGB7e2hhc2h9fWAuIFRoZSBgbmdTcmNgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtLgogKgogKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogKiBgYGBodG1sCiAqIDxpbWcgc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICogYGBgCiAqCiAqIFRoZSBjb3JyZWN0IHdheSB0byB3cml0ZSBpdDoKICogYGBgaHRtbAogKiA8aW1nIG5nLXNyYz0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAqIGBgYAogKgogKiBAZWxlbWVudCBJTUcKICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdTcmMgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogKi8KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nU3Jjc2V0CiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSA5OQogKgogKiBAZGVzY3JpcHRpb24KICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSBge3toYXNofX1gIGluIGEgYHNyY3NldGAgYXR0cmlidXRlIGRvZXNuJ3QKICogd29yayByaWdodDogVGhlIGJyb3dzZXIgd2lsbCBmZXRjaCBmcm9tIHRoZSBVUkwgd2l0aCB0aGUgbGl0ZXJhbAogKiB0ZXh0IGB7e2hhc2h9fWAgdW50aWwgQW5ndWxhciByZXBsYWNlcyB0aGUgZXhwcmVzc2lvbiBpbnNpZGUKICogYHt7aGFzaH19YC4gVGhlIGBuZ1NyY3NldGAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0uCiAqCiAqIFRoZSBidWdneSB3YXkgdG8gd3JpdGUgaXQ6CiAqIGBgYGh0bWwKICogPGltZyBzcmNzZXQ9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSAyeCIvPgogKiBgYGAKICoKICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogKiBgYGBodG1sCiAqIDxpbWcgbmctc3Jjc2V0PSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0gMngiLz4KICogYGBgCiAqCiAqIEBlbGVtZW50IElNRwogKiBAcGFyYW0ge3RlbXBsYXRlfSBuZ1NyY3NldCBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluIGB7e319YCBtYXJrdXAuCiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdEaXNhYmxlZAogKiBAcmVzdHJpY3QgQQogKiBAcHJpb3JpdHkgMTAwCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBXZSBzaG91bGRuJ3QgZG8gdGhpcywgYmVjYXVzZSBpdCB3aWxsIG1ha2UgdGhlIGJ1dHRvbiBlbmFibGVkIG9uIENocm9tZS9GaXJlZm94IGJ1dCBub3Qgb24gSUU4IGFuZCBvbGRlciBJRXM6CiAqIGBgYGh0bWwKICogPGRpdiBuZy1pbml0PSJzY29wZSA9IHsgaXNEaXNhYmxlZDogZmFsc2UgfSI+CiAqICA8YnV0dG9uIGRpc2FibGVkPSJ7e3Njb3BlLmlzRGlzYWJsZWR9fSI+RGlzYWJsZWQ8L2J1dHRvbj4KICogPC9kaXY+CiAqIGBgYAogKgogKiBUaGUgSFRNTCBzcGVjaWZpY2F0aW9uIGRvZXMgbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHZhbHVlcyBvZiBib29sZWFuIGF0dHJpYnV0ZXMKICogc3VjaCBhcyBkaXNhYmxlZC4gKFRoZWlyIHByZXNlbmNlIG1lYW5zIHRydWUgYW5kIHRoZWlyIGFic2VuY2UgbWVhbnMgZmFsc2UuKQogKiBJZiB3ZSBwdXQgYW4gQW5ndWxhciBpbnRlcnBvbGF0aW9uIGV4cHJlc3Npb24gaW50byBzdWNoIGFuIGF0dHJpYnV0ZSB0aGVuIHRoZQogKiBiaW5kaW5nIGluZm9ybWF0aW9uIHdvdWxkIGJlIGxvc3Qgd2hlbiB0aGUgYnJvd3NlciByZW1vdmVzIHRoZSBhdHRyaWJ1dGUuCiAqIFRoZSBgbmdEaXNhYmxlZGAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0gZm9yIHRoZSBgZGlzYWJsZWRgIGF0dHJpYnV0ZS4KICogVGhpcyBjb21wbGVtZW50YXJ5IGRpcmVjdGl2ZSBpcyBub3QgcmVtb3ZlZCBieSB0aGUgYnJvd3NlciBhbmQgc28gcHJvdmlkZXMKICogYSBwZXJtYW5lbnQgcmVsaWFibGUgcGxhY2UgdG8gc3RvcmUgdGhlIGJpbmRpbmcgaW5mb3JtYXRpb24uCiAqCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZT4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgQ2xpY2sgbWUgdG8gdG9nZ2xlOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgICAgIDxidXR0b24gbmctbW9kZWw9ImJ1dHRvbiIgbmctZGlzYWJsZWQ9ImNoZWNrZWQiPkJ1dHRvbjwvYnV0dG9uPgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIGl0KCdzaG91bGQgdG9nZ2xlIGJ1dHRvbicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCdidXR0b24nKSkuZ2V0QXR0cmlidXRlKCdkaXNhYmxlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2NoZWNrZWQnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnYnV0dG9uJykpLmdldEF0dHJpYnV0ZSgnZGlzYWJsZWQnKSkudG9CZVRydXRoeSgpOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAqCiAqIEBlbGVtZW50IElOUFVUCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdEaXNhYmxlZCBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5LAogKiAgICAgdGhlbiBzcGVjaWFsIGF0dHJpYnV0ZSAiZGlzYWJsZWQiIHdpbGwgYmUgc2V0IG9uIHRoZSBlbGVtZW50CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQ2hlY2tlZAogKiBAcmVzdHJpY3QgQQogKiBAcHJpb3JpdHkgMTAwCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgSFRNTCBzcGVjaWZpY2F0aW9uIGRvZXMgbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHZhbHVlcyBvZiBib29sZWFuIGF0dHJpYnV0ZXMKICogc3VjaCBhcyBjaGVja2VkLiAoVGhlaXIgcHJlc2VuY2UgbWVhbnMgdHJ1ZSBhbmQgdGhlaXIgYWJzZW5jZSBtZWFucyBmYWxzZS4pCiAqIElmIHdlIHB1dCBhbiBBbmd1bGFyIGludGVycG9sYXRpb24gZXhwcmVzc2lvbiBpbnRvIHN1Y2ggYW4gYXR0cmlidXRlIHRoZW4gdGhlCiAqIGJpbmRpbmcgaW5mb3JtYXRpb24gd291bGQgYmUgbG9zdCB3aGVuIHRoZSBicm93c2VyIHJlbW92ZXMgdGhlIGF0dHJpYnV0ZS4KICogVGhlIGBuZ0NoZWNrZWRgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtIGZvciB0aGUgYGNoZWNrZWRgIGF0dHJpYnV0ZS4KICogVGhpcyBjb21wbGVtZW50YXJ5IGRpcmVjdGl2ZSBpcyBub3QgcmVtb3ZlZCBieSB0aGUgYnJvd3NlciBhbmQgc28gcHJvdmlkZXMKICogYSBwZXJtYW5lbnQgcmVsaWFibGUgcGxhY2UgdG8gc3RvcmUgdGhlIGJpbmRpbmcgaW5mb3JtYXRpb24uCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZT4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgQ2hlY2sgbWUgdG8gY2hlY2sgYm90aDogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ibWFzdGVyIj48YnIvPgogICAgICAgIDxpbnB1dCBpZD0iY2hlY2tTbGF2ZSIgdHlwZT0iY2hlY2tib3giIG5nLWNoZWNrZWQ9Im1hc3RlciI+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBib3RoIGNoZWNrQm94ZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdjaGVja1NsYXZlJykpLmdldEF0dHJpYnV0ZSgnY2hlY2tlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ21hc3RlcicpKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2NoZWNrU2xhdmUnKSkuZ2V0QXR0cmlidXRlKCdjaGVja2VkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKgogKiBAZWxlbWVudCBJTlBVVAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2hlY2tlZCBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5LAogKiAgICAgdGhlbiBzcGVjaWFsIGF0dHJpYnV0ZSAiY2hlY2tlZCIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdSZWFkb25seQogKiBAcmVzdHJpY3QgQQogKiBAcHJpb3JpdHkgMTAwCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgSFRNTCBzcGVjaWZpY2F0aW9uIGRvZXMgbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHZhbHVlcyBvZiBib29sZWFuIGF0dHJpYnV0ZXMKICogc3VjaCBhcyByZWFkb25seS4gKFRoZWlyIHByZXNlbmNlIG1lYW5zIHRydWUgYW5kIHRoZWlyIGFic2VuY2UgbWVhbnMgZmFsc2UuKQogKiBJZiB3ZSBwdXQgYW4gQW5ndWxhciBpbnRlcnBvbGF0aW9uIGV4cHJlc3Npb24gaW50byBzdWNoIGFuIGF0dHJpYnV0ZSB0aGVuIHRoZQogKiBiaW5kaW5nIGluZm9ybWF0aW9uIHdvdWxkIGJlIGxvc3Qgd2hlbiB0aGUgYnJvd3NlciByZW1vdmVzIHRoZSBhdHRyaWJ1dGUuCiAqIFRoZSBgbmdSZWFkb25seWAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0gZm9yIHRoZSBgcmVhZG9ubHlgIGF0dHJpYnV0ZS4KICogVGhpcyBjb21wbGVtZW50YXJ5IGRpcmVjdGl2ZSBpcyBub3QgcmVtb3ZlZCBieSB0aGUgYnJvd3NlciBhbmQgc28gcHJvdmlkZXMKICogYSBwZXJtYW5lbnQgcmVsaWFibGUgcGxhY2UgdG8gc3RvcmUgdGhlIGJpbmRpbmcgaW5mb3JtYXRpb24uCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZT4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgQ2hlY2sgbWUgdG8gbWFrZSB0ZXh0IHJlYWRvbmx5OiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1yZWFkb25seT0iY2hlY2tlZCIgdmFsdWU9IkknbSBBbmd1bGFyIi8+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgcmVhZG9ubHkgYXR0cicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCdbdHlwZT0idGV4dCJdJykpLmdldEF0dHJpYnV0ZSgncmVhZG9ubHknKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdjaGVja2VkJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJ1t0eXBlPSJ0ZXh0Il0nKSkuZ2V0QXR0cmlidXRlKCdyZWFkb25seScpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICoKICogQGVsZW1lbnQgSU5QVVQKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1JlYWRvbmx5IElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHksCiAqICAgICB0aGVuIHNwZWNpYWwgYXR0cmlidXRlICJyZWFkb25seSIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdTZWxlY3RlZAogKiBAcmVzdHJpY3QgQQogKiBAcHJpb3JpdHkgMTAwCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgSFRNTCBzcGVjaWZpY2F0aW9uIGRvZXMgbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHZhbHVlcyBvZiBib29sZWFuIGF0dHJpYnV0ZXMKICogc3VjaCBhcyBzZWxlY3RlZC4gKFRoZWlyIHByZXNlbmNlIG1lYW5zIHRydWUgYW5kIHRoZWlyIGFic2VuY2UgbWVhbnMgZmFsc2UuKQogKiBJZiB3ZSBwdXQgYW4gQW5ndWxhciBpbnRlcnBvbGF0aW9uIGV4cHJlc3Npb24gaW50byBzdWNoIGFuIGF0dHJpYnV0ZSB0aGVuIHRoZQogKiBiaW5kaW5nIGluZm9ybWF0aW9uIHdvdWxkIGJlIGxvc3Qgd2hlbiB0aGUgYnJvd3NlciByZW1vdmVzIHRoZSBhdHRyaWJ1dGUuCiAqIFRoZSBgbmdTZWxlY3RlZGAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0gZm9yIHRoZSBgc2VsZWN0ZWRgIGF0dHJpYnV0ZS4KICogVGhpcyBjb21wbGVtZW50YXJ5IGRpcmVjdGl2ZSBpcyBub3QgcmVtb3ZlZCBieSB0aGUgYnJvd3NlciBhbmQgc28gcHJvdmlkZXMKICogYSBwZXJtYW5lbnQgcmVsaWFibGUgcGxhY2UgdG8gc3RvcmUgdGhlIGJpbmRpbmcgaW5mb3JtYXRpb24uCiAqCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZT4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgQ2hlY2sgbWUgdG8gc2VsZWN0OiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJzZWxlY3RlZCI+PGJyLz4KICAgICAgICA8c2VsZWN0PgogICAgICAgICAgPG9wdGlvbj5IZWxsbyE8L29wdGlvbj4KICAgICAgICAgIDxvcHRpb24gaWQ9ImdyZWV0IiBuZy1zZWxlY3RlZD0ic2VsZWN0ZWQiPkdyZWV0aW5ncyE8L29wdGlvbj4KICAgICAgICA8L3NlbGVjdD4KICAgICAgPC9maWxlPgogICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICBpdCgnc2hvdWxkIHNlbGVjdCBHcmVldGluZ3MhJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnZ3JlZXQnKSkuZ2V0QXR0cmlidXRlKCdzZWxlY3RlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3NlbGVjdGVkJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnZ3JlZXQnKSkuZ2V0QXR0cmlidXRlKCdzZWxlY3RlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICoKICogQGVsZW1lbnQgT1BUSU9OCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTZWxlY3RlZCBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5LAogKiAgICAgdGhlbiBzcGVjaWFsIGF0dHJpYnV0ZSAic2VsZWN0ZWQiIHdpbGwgYmUgc2V0IG9uIHRoZSBlbGVtZW50CiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdPcGVuCiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSAxMDAKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBIVE1MIHNwZWNpZmljYXRpb24gZG9lcyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgdmFsdWVzIG9mIGJvb2xlYW4gYXR0cmlidXRlcwogKiBzdWNoIGFzIG9wZW4uIChUaGVpciBwcmVzZW5jZSBtZWFucyB0cnVlIGFuZCB0aGVpciBhYnNlbmNlIG1lYW5zIGZhbHNlLikKICogSWYgd2UgcHV0IGFuIEFuZ3VsYXIgaW50ZXJwb2xhdGlvbiBleHByZXNzaW9uIGludG8gc3VjaCBhbiBhdHRyaWJ1dGUgdGhlbiB0aGUKICogYmluZGluZyBpbmZvcm1hdGlvbiB3b3VsZCBiZSBsb3N0IHdoZW4gdGhlIGJyb3dzZXIgcmVtb3ZlcyB0aGUgYXR0cmlidXRlLgogKiBUaGUgYG5nT3BlbmAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0gZm9yIHRoZSBgb3BlbmAgYXR0cmlidXRlLgogKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogKiBhIHBlcm1hbmVudCByZWxpYWJsZSBwbGFjZSB0byBzdG9yZSB0aGUgYmluZGluZyBpbmZvcm1hdGlvbi4KICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICBDaGVjayBtZSBjaGVjayBtdWx0aXBsZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ib3BlbiI+PGJyLz4KICAgICAgICAgPGRldGFpbHMgaWQ9ImRldGFpbHMiIG5nLW9wZW49Im9wZW4iPgogICAgICAgICAgICA8c3VtbWFyeT5TaG93L0hpZGUgbWU8L3N1bW1hcnk+CiAgICAgICAgIDwvZGV0YWlscz4KICAgICAgIDwvZmlsZT4KICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICBpdCgnc2hvdWxkIHRvZ2dsZSBvcGVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2RldGFpbHMnKSkuZ2V0QXR0cmlidXRlKCdvcGVuJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ29wZW4nKSkuY2xpY2soKTsKICAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnZGV0YWlscycpKS5nZXRBdHRyaWJ1dGUoJ29wZW4nKSkudG9CZVRydXRoeSgpOwogICAgICAgICB9KTsKICAgICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAqCiAqIEBlbGVtZW50IERFVEFJTFMKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ09wZW4gSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSwKICogICAgIHRoZW4gc3BlY2lhbCBhdHRyaWJ1dGUgIm9wZW4iIHdpbGwgYmUgc2V0IG9uIHRoZSBlbGVtZW50CiAqLwoKdmFyIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzID0ge307CgoKLy8gYm9vbGVhbiBhdHRycyBhcmUgZXZhbHVhdGVkCmZvckVhY2goQk9PTEVBTl9BVFRSLCBmdW5jdGlvbihwcm9wTmFtZSwgYXR0ck5hbWUpIHsKICAvLyBiaW5kaW5nIHRvIG11bHRpcGxlIGlzIG5vdCBzdXBwb3J0ZWQKICBpZiAocHJvcE5hbWUgPT0gIm11bHRpcGxlIikgcmV0dXJuOwoKICB2YXIgbm9ybWFsaXplZCA9IGRpcmVjdGl2ZU5vcm1hbGl6ZSgnbmctJyArIGF0dHJOYW1lKTsKICBuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlc1tub3JtYWxpemVkXSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICBzY29wZS4kd2F0Y2goYXR0cltub3JtYWxpemVkXSwgZnVuY3Rpb24gbmdCb29sZWFuQXR0cldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBhdHRyLiRzZXQoYXR0ck5hbWUsICEhdmFsdWUpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwogIH07Cn0pOwoKLy8gYWxpYXNlZCBpbnB1dCBhdHRycyBhcmUgZXZhbHVhdGVkCmZvckVhY2goQUxJQVNFRF9BVFRSLCBmdW5jdGlvbihodG1sQXR0ciwgbmdBdHRyKSB7CiAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbmdBdHRyXSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAvL3NwZWNpYWwgY2FzZSBuZ1BhdHRlcm4gd2hlbiBhIGxpdGVyYWwgcmVndWxhciBleHByZXNzaW9uIHZhbHVlCiAgICAgICAgLy9pcyB1c2VkIGFzIHRoZSBleHByZXNzaW9uICh0aGlzIHdheSB3ZSBkb24ndCBoYXZlIHRvIHdhdGNoIGFueXRoaW5nKS4KICAgICAgICBpZiAobmdBdHRyID09PSAibmdQYXR0ZXJuIiAmJiBhdHRyLm5nUGF0dGVybi5jaGFyQXQoMCkgPT0gIi8iKSB7CiAgICAgICAgICB2YXIgbWF0Y2ggPSBhdHRyLm5nUGF0dGVybi5tYXRjaChSRUdFWF9TVFJJTkdfUkVHRVhQKTsKICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICBhdHRyLiRzZXQoIm5nUGF0dGVybiIsIG5ldyBSZWdFeHAobWF0Y2hbMV0sIG1hdGNoWzJdKSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyW25nQXR0cl0sIGZ1bmN0aW9uIG5nQXR0ckFsaWFzV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGF0dHIuJHNldChuZ0F0dHIsIHZhbHVlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICB9Owp9KTsKCi8vIG5nLXNyYywgbmctc3Jjc2V0LCBuZy1ocmVmIGFyZSBpbnRlcnBvbGF0ZWQKZm9yRWFjaChbJ3NyYycsICdzcmNzZXQnLCAnaHJlZiddLCBmdW5jdGlvbihhdHRyTmFtZSkgewogIHZhciBub3JtYWxpemVkID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgYXR0ck5hbWUpOwogIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzW25vcm1hbGl6ZWRdID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICBwcmlvcml0eTogOTksIC8vIGl0IG5lZWRzIHRvIHJ1biBhZnRlciB0aGUgYXR0cmlidXRlcyBhcmUgaW50ZXJwb2xhdGVkCiAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgdmFyIHByb3BOYW1lID0gYXR0ck5hbWUsCiAgICAgICAgICAgIG5hbWUgPSBhdHRyTmFtZTsKCiAgICAgICAgaWYgKGF0dHJOYW1lID09PSAnaHJlZicgJiYKICAgICAgICAgICAgdG9TdHJpbmcuY2FsbChlbGVtZW50LnByb3AoJ2hyZWYnKSkgPT09ICdbb2JqZWN0IFNWR0FuaW1hdGVkU3RyaW5nXScpIHsKICAgICAgICAgIG5hbWUgPSAneGxpbmtIcmVmJzsKICAgICAgICAgIGF0dHIuJGF0dHJbbmFtZV0gPSAneGxpbms6aHJlZic7CiAgICAgICAgICBwcm9wTmFtZSA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBhdHRyLiRvYnNlcnZlKG5vcm1hbGl6ZWQsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgICAgIGlmIChhdHRyTmFtZSA9PT0gJ2hyZWYnKSB7CiAgICAgICAgICAgICAgYXR0ci4kc2V0KG5hbWUsIG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBhdHRyLiRzZXQobmFtZSwgdmFsdWUpOwoKICAgICAgICAgIC8vIG9uIElFLCBpZiAibmc6c3JjIiBkaXJlY3RpdmUgZGVjbGFyYXRpb24gaXMgdXNlZCBhbmQgInNyYyIgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QKICAgICAgICAgIC8vIHRoZW4gY2FsbGluZyBlbGVtZW50LnNldEF0dHJpYnV0ZSgnc3JjJywgJ2ZvbycpIGRvZXNuJ3QgZG8gYW55dGhpbmcsIHNvIHdlIG5lZWQKICAgICAgICAgIC8vIHRvIHNldCB0aGUgcHJvcGVydHkgYXMgd2VsbCB0byBhY2hpZXZlIHRoZSBkZXNpcmVkIGVmZmVjdC4KICAgICAgICAgIC8vIHdlIHVzZSBhdHRyW2F0dHJOYW1lXSB2YWx1ZSBzaW5jZSAkc2V0IGNhbiBzYW5pdGl6ZSB0aGUgdXJsLgogICAgICAgICAgaWYgKG1zaWUgJiYgcHJvcE5hbWUpIGVsZW1lbnQucHJvcChwcm9wTmFtZSwgYXR0cltuYW1lXSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgfTsKfSk7CgovKiBnbG9iYWwgLW51bGxGb3JtQ3RybCwgLVNVQk1JVFRFRF9DTEFTUywgYWRkU2V0VmFsaWRpdHlNZXRob2Q6IHRydWUKICovCnZhciBudWxsRm9ybUN0cmwgPSB7CiAgJGFkZENvbnRyb2w6IG5vb3AsCiAgJCRyZW5hbWVDb250cm9sOiBudWxsRm9ybVJlbmFtZUNvbnRyb2wsCiAgJHJlbW92ZUNvbnRyb2w6IG5vb3AsCiAgJHNldFZhbGlkaXR5OiBub29wLAogICRzZXREaXJ0eTogbm9vcCwKICAkc2V0UHJpc3RpbmU6IG5vb3AsCiAgJHNldFN1Ym1pdHRlZDogbm9vcAp9LApTVUJNSVRURURfQ0xBU1MgPSAnbmctc3VibWl0dGVkJzsKCmZ1bmN0aW9uIG51bGxGb3JtUmVuYW1lQ29udHJvbChjb250cm9sLCBuYW1lKSB7CiAgY29udHJvbC4kbmFtZSA9IG5hbWU7Cn0KCi8qKgogKiBAbmdkb2MgdHlwZQogKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyCiAqCiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHByaXN0aW5lIFRydWUgaWYgdXNlciBoYXMgbm90IGludGVyYWN0ZWQgd2l0aCB0aGUgZm9ybSB5ZXQuCiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGRpcnR5IFRydWUgaWYgdXNlciBoYXMgYWxyZWFkeSBpbnRlcmFjdGVkIHdpdGggdGhlIGZvcm0uCiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHZhbGlkIFRydWUgaWYgYWxsIG9mIHRoZSBjb250YWluaW5nIGZvcm1zIGFuZCBjb250cm9scyBhcmUgdmFsaWQuCiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGludmFsaWQgVHJ1ZSBpZiBhdCBsZWFzdCBvbmUgY29udGFpbmluZyBjb250cm9sIG9yIGZvcm0gaXMgaW52YWxpZC4KICogQHByb3BlcnR5IHtib29sZWFufSAkc3VibWl0dGVkIFRydWUgaWYgdXNlciBoYXMgc3VibWl0dGVkIHRoZSBmb3JtIGV2ZW4gaWYgaXRzIGludmFsaWQuCiAqCiAqIEBwcm9wZXJ0eSB7T2JqZWN0fSAkZXJyb3IgSXMgYW4gb2JqZWN0IGhhc2gsIGNvbnRhaW5pbmcgcmVmZXJlbmNlcyB0byBjb250cm9scyBvcgogKiAgZm9ybXMgd2l0aCBmYWlsaW5nIHZhbGlkYXRvcnMsIHdoZXJlOgogKgogKiAgLSBrZXlzIGFyZSB2YWxpZGF0aW9uIHRva2VucyAoZXJyb3IgbmFtZXMpLAogKiAgLSB2YWx1ZXMgYXJlIGFycmF5cyBvZiBjb250cm9scyBvciBmb3JtcyB0aGF0IGhhdmUgYSBmYWlsaW5nIHZhbGlkYXRvciBmb3IgZ2l2ZW4gZXJyb3IgbmFtZS4KICoKICogIEJ1aWx0LWluIHZhbGlkYXRpb24gdG9rZW5zOgogKgogKiAgLSBgZW1haWxgCiAqICAtIGBtYXhgCiAqICAtIGBtYXhsZW5ndGhgCiAqICAtIGBtaW5gCiAqICAtIGBtaW5sZW5ndGhgCiAqICAtIGBudW1iZXJgCiAqICAtIGBwYXR0ZXJuYAogKiAgLSBgcmVxdWlyZWRgCiAqICAtIGB1cmxgCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBgRm9ybUNvbnRyb2xsZXJgIGtlZXBzIHRyYWNrIG9mIGFsbCBpdHMgY29udHJvbHMgYW5kIG5lc3RlZCBmb3JtcyBhcyB3ZWxsIGFzIHRoZSBzdGF0ZSBvZiB0aGVtLAogKiBzdWNoIGFzIGJlaW5nIHZhbGlkL2ludmFsaWQgb3IgZGlydHkvcHJpc3RpbmUuCiAqCiAqIEVhY2gge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtIGZvcm19IGRpcmVjdGl2ZSBjcmVhdGVzIGFuIGluc3RhbmNlCiAqIG9mIGBGb3JtQ29udHJvbGxlcmAuCiAqCiAqLwovL2Fza3MgZm9yICRzY29wZSB0byBmb29sIHRoZSBCQyBjb250cm9sbGVyIG1vZHVsZQpGb3JtQ29udHJvbGxlci4kaW5qZWN0ID0gWyckZWxlbWVudCcsICckYXR0cnMnLCAnJHNjb3BlJywgJyRhbmltYXRlJywgJyRpbnRlcnBvbGF0ZSddOwpmdW5jdGlvbiBGb3JtQ29udHJvbGxlcihlbGVtZW50LCBhdHRycywgJHNjb3BlLCAkYW5pbWF0ZSwgJGludGVycG9sYXRlKSB7CiAgdmFyIGZvcm0gPSB0aGlzLAogICAgICBjb250cm9scyA9IFtdOwoKICB2YXIgcGFyZW50Rm9ybSA9IGZvcm0uJCRwYXJlbnRGb3JtID0gZWxlbWVudC5wYXJlbnQoKS5jb250cm9sbGVyKCdmb3JtJykgfHwgbnVsbEZvcm1DdHJsOwoKICAvLyBpbml0IHN0YXRlCiAgZm9ybS4kZXJyb3IgPSB7fTsKICBmb3JtLiQkc3VjY2VzcyA9IHt9OwogIGZvcm0uJHBlbmRpbmcgPSB1bmRlZmluZWQ7CiAgZm9ybS4kbmFtZSA9ICRpbnRlcnBvbGF0ZShhdHRycy5uYW1lIHx8IGF0dHJzLm5nRm9ybSB8fCAnJykoJHNjb3BlKTsKICBmb3JtLiRkaXJ0eSA9IGZhbHNlOwogIGZvcm0uJHByaXN0aW5lID0gdHJ1ZTsKICBmb3JtLiR2YWxpZCA9IHRydWU7CiAgZm9ybS4kaW52YWxpZCA9IGZhbHNlOwogIGZvcm0uJHN1Ym1pdHRlZCA9IGZhbHNlOwoKICBwYXJlbnRGb3JtLiRhZGRDb250cm9sKGZvcm0pOwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgZm9ybS5Gb3JtQ29udHJvbGxlciMkcm9sbGJhY2tWaWV3VmFsdWUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJvbGxiYWNrIGFsbCBmb3JtIGNvbnRyb2xzIHBlbmRpbmcgdXBkYXRlcyB0byB0aGUgYCRtb2RlbFZhbHVlYC4KICAgKgogICAqIFVwZGF0ZXMgbWF5IGJlIHBlbmRpbmcgYnkgYSBkZWJvdW5jZWQgZXZlbnQgb3IgYmVjYXVzZSB0aGUgaW5wdXQgaXMgd2FpdGluZyBmb3IgYSBzb21lIGZ1dHVyZQogICAqIGV2ZW50IGRlZmluZWQgaW4gYG5nLW1vZGVsLW9wdGlvbnNgLiBUaGlzIG1ldGhvZCBpcyB0eXBpY2FsbHkgbmVlZGVkIGJ5IHRoZSByZXNldCBidXR0b24gb2YKICAgKiBhIGZvcm0gdGhhdCB1c2VzIGBuZy1tb2RlbC1vcHRpb25zYCB0byBwZW5kIHVwZGF0ZXMuCiAgICovCiAgZm9ybS4kcm9sbGJhY2tWaWV3VmFsdWUgPSBmdW5jdGlvbigpIHsKICAgIGZvckVhY2goY29udHJvbHMsIGZ1bmN0aW9uKGNvbnRyb2wpIHsKICAgICAgY29udHJvbC4kcm9sbGJhY2tWaWV3VmFsdWUoKTsKICAgIH0pOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRjb21taXRWaWV3VmFsdWUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENvbW1pdCBhbGwgZm9ybSBjb250cm9scyBwZW5kaW5nIHVwZGF0ZXMgdG8gdGhlIGAkbW9kZWxWYWx1ZWAuCiAgICoKICAgKiBVcGRhdGVzIG1heSBiZSBwZW5kaW5nIGJ5IGEgZGVib3VuY2VkIGV2ZW50IG9yIGJlY2F1c2UgdGhlIGlucHV0IGlzIHdhaXRpbmcgZm9yIGEgc29tZSBmdXR1cmUKICAgKiBldmVudCBkZWZpbmVkIGluIGBuZy1tb2RlbC1vcHRpb25zYC4gVGhpcyBtZXRob2QgaXMgcmFyZWx5IG5lZWRlZCBhcyBgTmdNb2RlbENvbnRyb2xsZXJgCiAgICogdXN1YWxseSBoYW5kbGVzIGNhbGxpbmcgdGhpcyBpbiByZXNwb25zZSB0byBpbnB1dCBldmVudHMuCiAgICovCiAgZm9ybS4kY29tbWl0Vmlld1ZhbHVlID0gZnVuY3Rpb24oKSB7CiAgICBmb3JFYWNoKGNvbnRyb2xzLCBmdW5jdGlvbihjb250cm9sKSB7CiAgICAgIGNvbnRyb2wuJGNvbW1pdFZpZXdWYWx1ZSgpOwogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJGFkZENvbnRyb2wKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJlZ2lzdGVyIGEgY29udHJvbCB3aXRoIHRoZSBmb3JtLgogICAqCiAgICogSW5wdXQgZWxlbWVudHMgdXNpbmcgbmdNb2RlbENvbnRyb2xsZXIgZG8gdGhpcyBhdXRvbWF0aWNhbGx5IHdoZW4gdGhleSBhcmUgbGlua2VkLgogICAqLwogIGZvcm0uJGFkZENvbnRyb2wgPSBmdW5jdGlvbihjb250cm9sKSB7CiAgICAvLyBCcmVha2luZyBjaGFuZ2UgLSBiZWZvcmUsIGlucHV0cyB3aG9zZSBuYW1lIHdhcyAiaGFzT3duUHJvcGVydHkiIHdlcmUgcXVpZXRseSBpZ25vcmVkCiAgICAvLyBhbmQgbm90IGFkZGVkIHRvIHRoZSBzY29wZS4gIE5vdyB3ZSB0aHJvdyBhbiBlcnJvci4KICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KGNvbnRyb2wuJG5hbWUsICdpbnB1dCcpOwogICAgY29udHJvbHMucHVzaChjb250cm9sKTsKCiAgICBpZiAoY29udHJvbC4kbmFtZSkgewogICAgICBmb3JtW2NvbnRyb2wuJG5hbWVdID0gY29udHJvbDsKICAgIH0KICB9OwoKICAvLyBQcml2YXRlIEFQSTogcmVuYW1lIGEgZm9ybSBjb250cm9sCiAgZm9ybS4kJHJlbmFtZUNvbnRyb2wgPSBmdW5jdGlvbihjb250cm9sLCBuZXdOYW1lKSB7CiAgICB2YXIgb2xkTmFtZSA9IGNvbnRyb2wuJG5hbWU7CgogICAgaWYgKGZvcm1bb2xkTmFtZV0gPT09IGNvbnRyb2wpIHsKICAgICAgZGVsZXRlIGZvcm1bb2xkTmFtZV07CiAgICB9CiAgICBmb3JtW25ld05hbWVdID0gY29udHJvbDsKICAgIGNvbnRyb2wuJG5hbWUgPSBuZXdOYW1lOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRyZW1vdmVDb250cm9sCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZXJlZ2lzdGVyIGEgY29udHJvbCBmcm9tIHRoZSBmb3JtLgogICAqCiAgICogSW5wdXQgZWxlbWVudHMgdXNpbmcgbmdNb2RlbENvbnRyb2xsZXIgZG8gdGhpcyBhdXRvbWF0aWNhbGx5IHdoZW4gdGhleSBhcmUgZGVzdHJveWVkLgogICAqLwogIGZvcm0uJHJlbW92ZUNvbnRyb2wgPSBmdW5jdGlvbihjb250cm9sKSB7CiAgICBpZiAoY29udHJvbC4kbmFtZSAmJiBmb3JtW2NvbnRyb2wuJG5hbWVdID09PSBjb250cm9sKSB7CiAgICAgIGRlbGV0ZSBmb3JtW2NvbnRyb2wuJG5hbWVdOwogICAgfQogICAgZm9yRWFjaChmb3JtLiRwZW5kaW5nLCBmdW5jdGlvbih2YWx1ZSwgbmFtZSkgewogICAgICBmb3JtLiRzZXRWYWxpZGl0eShuYW1lLCBudWxsLCBjb250cm9sKTsKICAgIH0pOwogICAgZm9yRWFjaChmb3JtLiRlcnJvciwgZnVuY3Rpb24odmFsdWUsIG5hbWUpIHsKICAgICAgZm9ybS4kc2V0VmFsaWRpdHkobmFtZSwgbnVsbCwgY29udHJvbCk7CiAgICB9KTsKCiAgICBhcnJheVJlbW92ZShjb250cm9scywgY29udHJvbCk7CiAgfTsKCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRzZXRWYWxpZGl0eQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cyB0aGUgdmFsaWRpdHkgb2YgYSBmb3JtIGNvbnRyb2wuCiAgICoKICAgKiBUaGlzIG1ldGhvZCB3aWxsIGFsc28gcHJvcGFnYXRlIHRvIHBhcmVudCBmb3Jtcy4KICAgKi8KICBhZGRTZXRWYWxpZGl0eU1ldGhvZCh7CiAgICBjdHJsOiB0aGlzLAogICAgJGVsZW1lbnQ6IGVsZW1lbnQsCiAgICBzZXQ6IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHksIGNvbnRyb2wpIHsKICAgICAgdmFyIGxpc3QgPSBvYmplY3RbcHJvcGVydHldOwogICAgICBpZiAoIWxpc3QpIHsKICAgICAgICBvYmplY3RbcHJvcGVydHldID0gW2NvbnRyb2xdOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBpbmRleCA9IGxpc3QuaW5kZXhPZihjb250cm9sKTsKICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7CiAgICAgICAgICBsaXN0LnB1c2goY29udHJvbCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgdW5zZXQ6IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHksIGNvbnRyb2wpIHsKICAgICAgdmFyIGxpc3QgPSBvYmplY3RbcHJvcGVydHldOwogICAgICBpZiAoIWxpc3QpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgYXJyYXlSZW1vdmUobGlzdCwgY29udHJvbCk7CiAgICAgIGlmIChsaXN0Lmxlbmd0aCA9PT0gMCkgewogICAgICAgIGRlbGV0ZSBvYmplY3RbcHJvcGVydHldOwogICAgICB9CiAgICB9LAogICAgcGFyZW50Rm9ybTogcGFyZW50Rm9ybSwKICAgICRhbmltYXRlOiAkYW5pbWF0ZQogIH0pOwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgZm9ybS5Gb3JtQ29udHJvbGxlciMkc2V0RGlydHkKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNldHMgdGhlIGZvcm0gdG8gYSBkaXJ0eSBzdGF0ZS4KICAgKgogICAqIFRoaXMgbWV0aG9kIGNhbiBiZSBjYWxsZWQgdG8gYWRkIHRoZSAnbmctZGlydHknIGNsYXNzIGFuZCBzZXQgdGhlIGZvcm0gdG8gYSBkaXJ0eQogICAqIHN0YXRlIChuZy1kaXJ0eSBjbGFzcykuIFRoaXMgbWV0aG9kIHdpbGwgYWxzbyBwcm9wYWdhdGUgdG8gcGFyZW50IGZvcm1zLgogICAqLwogIGZvcm0uJHNldERpcnR5ID0gZnVuY3Rpb24oKSB7CiAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCBQUklTVElORV9DTEFTUyk7CiAgICAkYW5pbWF0ZS5hZGRDbGFzcyhlbGVtZW50LCBESVJUWV9DTEFTUyk7CiAgICBmb3JtLiRkaXJ0eSA9IHRydWU7CiAgICBmb3JtLiRwcmlzdGluZSA9IGZhbHNlOwogICAgcGFyZW50Rm9ybS4kc2V0RGlydHkoKTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgZm9ybS5Gb3JtQ29udHJvbGxlciMkc2V0UHJpc3RpbmUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNldHMgdGhlIGZvcm0gdG8gaXRzIHByaXN0aW5lIHN0YXRlLgogICAqCiAgICogVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB0byByZW1vdmUgdGhlICduZy1kaXJ0eScgY2xhc3MgYW5kIHNldCB0aGUgZm9ybSB0byBpdHMgcHJpc3RpbmUKICAgKiBzdGF0ZSAobmctcHJpc3RpbmUgY2xhc3MpLiBUaGlzIG1ldGhvZCB3aWxsIGFsc28gcHJvcGFnYXRlIHRvIGFsbCB0aGUgY29udHJvbHMgY29udGFpbmVkCiAgICogaW4gdGhpcyBmb3JtLgogICAqCiAgICogU2V0dGluZyBhIGZvcm0gYmFjayB0byBhIHByaXN0aW5lIHN0YXRlIGlzIG9mdGVuIHVzZWZ1bCB3aGVuIHdlIHdhbnQgdG8gJ3JldXNlJyBhIGZvcm0gYWZ0ZXIKICAgKiBzYXZpbmcgb3IgcmVzZXR0aW5nIGl0LgogICAqLwogIGZvcm0uJHNldFByaXN0aW5lID0gZnVuY3Rpb24gKCkgewogICAgJGFuaW1hdGUuc2V0Q2xhc3MoZWxlbWVudCwgUFJJU1RJTkVfQ0xBU1MsIERJUlRZX0NMQVNTICsgJyAnICsgU1VCTUlUVEVEX0NMQVNTKTsKICAgIGZvcm0uJGRpcnR5ID0gZmFsc2U7CiAgICBmb3JtLiRwcmlzdGluZSA9IHRydWU7CiAgICBmb3JtLiRzdWJtaXR0ZWQgPSBmYWxzZTsKICAgIGZvckVhY2goY29udHJvbHMsIGZ1bmN0aW9uKGNvbnRyb2wpIHsKICAgICAgY29udHJvbC4kc2V0UHJpc3RpbmUoKTsKICAgIH0pOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRzZXRVbnRvdWNoZWQKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNldHMgdGhlIGZvcm0gdG8gaXRzIHVudG91Y2hlZCBzdGF0ZS4KICAgKgogICAqIFRoaXMgbWV0aG9kIGNhbiBiZSBjYWxsZWQgdG8gcmVtb3ZlIHRoZSAnbmctdG91Y2hlZCcgY2xhc3MgYW5kIHNldCB0aGUgZm9ybSBjb250cm9scyB0byB0aGVpcgogICAqIHVudG91Y2hlZCBzdGF0ZSAobmctdW50b3VjaGVkIGNsYXNzKS4KICAgKgogICAqIFNldHRpbmcgYSBmb3JtIGNvbnRyb2xzIGJhY2sgdG8gdGhlaXIgdW50b3VjaGVkIHN0YXRlIGlzIG9mdGVuIHVzZWZ1bCB3aGVuIHNldHRpbmcgdGhlIGZvcm0KICAgKiBiYWNrIHRvIGl0cyBwcmlzdGluZSBzdGF0ZS4KICAgKi8KICBmb3JtLiRzZXRVbnRvdWNoZWQgPSBmdW5jdGlvbiAoKSB7CiAgICBmb3JFYWNoKGNvbnRyb2xzLCBmdW5jdGlvbihjb250cm9sKSB7CiAgICAgIGNvbnRyb2wuJHNldFVudG91Y2hlZCgpOwogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJHNldFN1Ym1pdHRlZAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cyB0aGUgZm9ybSB0byBpdHMgc3VibWl0dGVkIHN0YXRlLgogICAqLwogIGZvcm0uJHNldFN1Ym1pdHRlZCA9IGZ1bmN0aW9uICgpIHsKICAgICRhbmltYXRlLmFkZENsYXNzKGVsZW1lbnQsIFNVQk1JVFRFRF9DTEFTUyk7CiAgICBmb3JtLiRzdWJtaXR0ZWQgPSB0cnVlOwogICAgcGFyZW50Rm9ybS4kc2V0U3VibWl0dGVkKCk7CiAgfTsKfQoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdGb3JtCiAqIEByZXN0cmljdCBFQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIE5lc3RhYmxlIGFsaWFzIG9mIHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBgZm9ybWB9IGRpcmVjdGl2ZS4gSFRNTAogKiBkb2VzIG5vdCBhbGxvdyBuZXN0aW5nIG9mIGZvcm0gZWxlbWVudHMuIEl0IGlzIHVzZWZ1bCB0byBuZXN0IGZvcm1zLCBmb3IgZXhhbXBsZSBpZiB0aGUgdmFsaWRpdHkgb2YgYQogKiBzdWItZ3JvdXAgb2YgY29udHJvbHMgbmVlZHMgdG8gYmUgZGV0ZXJtaW5lZC4KICoKICogTm90ZTogdGhlIHB1cnBvc2Ugb2YgYG5nRm9ybWAgaXMgdG8gZ3JvdXAgY29udHJvbHMsCiAqIGJ1dCBub3QgdG8gYmUgYSByZXBsYWNlbWVudCBmb3IgdGhlIGA8Zm9ybT5gIHRhZyB3aXRoIGFsbCBvZiBpdHMgY2FwYWJpbGl0aWVzCiAqIChlLmcuIHBvc3RpbmcgdG8gdGhlIHNlcnZlciwgLi4uKS4KICoKICogQHBhcmFtIHtzdHJpbmc9fSBuZ0Zvcm18bmFtZSBOYW1lIG9mIHRoZSBmb3JtLiBJZiBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgd2lsbCBiZSBwdWJsaXNoZWQgaW50bwogKiAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRlZCBzY29wZSwgdW5kZXIgdGhpcyBuYW1lLgogKgogKi8KCiAvKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmb3JtCiAqIEByZXN0cmljdCBFCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEaXJlY3RpdmUgdGhhdCBpbnN0YW50aWF0ZXMKICoge0BsaW5rIGZvcm0uRm9ybUNvbnRyb2xsZXIgRm9ybUNvbnRyb2xsZXJ9LgogKgogKiBJZiB0aGUgYG5hbWVgIGF0dHJpYnV0ZSBpcyBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgaXMgcHVibGlzaGVkIG9udG8gdGhlIGN1cnJlbnQgc2NvcGUgdW5kZXIKICogdGhpcyBuYW1lLgogKgogKiAjIEFsaWFzOiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nRm9ybSBgbmdGb3JtYH0KICoKICogSW4gQW5ndWxhciBmb3JtcyBjYW4gYmUgbmVzdGVkLiBUaGlzIG1lYW5zIHRoYXQgdGhlIG91dGVyIGZvcm0gaXMgdmFsaWQgd2hlbiBhbGwgb2YgdGhlIGNoaWxkCiAqIGZvcm1zIGFyZSB2YWxpZCBhcyB3ZWxsLiBIb3dldmVyLCBicm93c2VycyBkbyBub3QgYWxsb3cgbmVzdGluZyBvZiBgPGZvcm0+YCBlbGVtZW50cywgc28KICogQW5ndWxhciBwcm92aWRlcyB0aGUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Zvcm0gYG5nRm9ybWB9IGRpcmVjdGl2ZSB3aGljaCBiZWhhdmVzIGlkZW50aWNhbGx5IHRvCiAqIGA8Zm9ybT5gIGJ1dCBjYW4gYmUgbmVzdGVkLiAgVGhpcyBhbGxvd3MgeW91IHRvIGhhdmUgbmVzdGVkIGZvcm1zLCB3aGljaCBpcyB2ZXJ5IHVzZWZ1bCB3aGVuCiAqIHVzaW5nIEFuZ3VsYXIgdmFsaWRhdGlvbiBkaXJlY3RpdmVzIGluIGZvcm1zIHRoYXQgYXJlIGR5bmFtaWNhbGx5IGdlbmVyYXRlZCB1c2luZyB0aGUKICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBgbmdSZXBlYXRgfSBkaXJlY3RpdmUuIFNpbmNlIHlvdSBjYW5ub3QgZHluYW1pY2FsbHkgZ2VuZXJhdGUgdGhlIGBuYW1lYAogKiBhdHRyaWJ1dGUgb2YgaW5wdXQgZWxlbWVudHMgdXNpbmcgaW50ZXJwb2xhdGlvbiwgeW91IGhhdmUgdG8gd3JhcCBlYWNoIHNldCBvZiByZXBlYXRlZCBpbnB1dHMgaW4gYW4KICogYG5nRm9ybWAgZGlyZWN0aXZlIGFuZCBuZXN0IHRoZXNlIGluIGFuIG91dGVyIGBmb3JtYCBlbGVtZW50LgogKgogKgogKiAjIENTUyBjbGFzc2VzCiAqICAtIGBuZy12YWxpZGAgaXMgc2V0IGlmIHRoZSBmb3JtIGlzIHZhbGlkLgogKiAgLSBgbmctaW52YWxpZGAgaXMgc2V0IGlmIHRoZSBmb3JtIGlzIGludmFsaWQuCiAqICAtIGBuZy1wcmlzdGluZWAgaXMgc2V0IGlmIHRoZSBmb3JtIGlzIHByaXN0aW5lLgogKiAgLSBgbmctZGlydHlgIGlzIHNldCBpZiB0aGUgZm9ybSBpcyBkaXJ0eS4KICogIC0gYG5nLXN1Ym1pdHRlZGAgaXMgc2V0IGlmIHRoZSBmb3JtIHdhcyBzdWJtaXR0ZWQuCiAqCiAqIEtlZXAgaW4gbWluZCB0aGF0IG5nQW5pbWF0ZSBjYW4gZGV0ZWN0IGVhY2ggb2YgdGhlc2UgY2xhc3NlcyB3aGVuIGFkZGVkIGFuZCByZW1vdmVkLgogKgogKgogKiAjIFN1Ym1pdHRpbmcgYSBmb3JtIGFuZCBwcmV2ZW50aW5nIHRoZSBkZWZhdWx0IGFjdGlvbgogKgogKiBTaW5jZSB0aGUgcm9sZSBvZiBmb3JtcyBpbiBjbGllbnQtc2lkZSBBbmd1bGFyIGFwcGxpY2F0aW9ucyBpcyBkaWZmZXJlbnQgdGhhbiBpbiBjbGFzc2ljYWwKICogcm91bmR0cmlwIGFwcHMsIGl0IGlzIGRlc2lyYWJsZSBmb3IgdGhlIGJyb3dzZXIgbm90IHRvIHRyYW5zbGF0ZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGludG8gYSBmdWxsCiAqIHBhZ2UgcmVsb2FkIHRoYXQgc2VuZHMgdGhlIGRhdGEgdG8gdGhlIHNlcnZlci4gSW5zdGVhZCBzb21lIGphdmFzY3JpcHQgbG9naWMgc2hvdWxkIGJlIHRyaWdnZXJlZAogKiB0byBoYW5kbGUgdGhlIGZvcm0gc3VibWlzc2lvbiBpbiBhbiBhcHBsaWNhdGlvbi1zcGVjaWZpYyB3YXkuCiAqCiAqIEZvciB0aGlzIHJlYXNvbiwgQW5ndWxhciBwcmV2ZW50cyB0aGUgZGVmYXVsdCBhY3Rpb24gKGZvcm0gc3VibWlzc2lvbiB0byB0aGUgc2VydmVyKSB1bmxlc3MgdGhlCiAqIGA8Zm9ybT5gIGVsZW1lbnQgaGFzIGFuIGBhY3Rpb25gIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCiAqCiAqIFlvdSBjYW4gdXNlIG9uZSBvZiB0aGUgZm9sbG93aW5nIHR3byB3YXlzIHRvIHNwZWNpZnkgd2hhdCBqYXZhc2NyaXB0IG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIHdoZW4KICogYSBmb3JtIGlzIHN1Ym1pdHRlZDoKICoKICogLSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nU3VibWl0IG5nU3VibWl0fSBkaXJlY3RpdmUgb24gdGhlIGZvcm0gZWxlbWVudAogKiAtIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfSBkaXJlY3RpdmUgb24gdGhlIGZpcnN0CiAgKiAgYnV0dG9uIG9yIGlucHV0IGZpZWxkIG9mIHR5cGUgc3VibWl0IChpbnB1dFt0eXBlPXN1Ym1pdF0pCiAqCiAqIFRvIHByZXZlbnQgZG91YmxlIGV4ZWN1dGlvbiBvZiB0aGUgaGFuZGxlciwgdXNlIG9ubHkgb25lIG9mIHRoZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nU3VibWl0IG5nU3VibWl0fQogKiBvciB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30gZGlyZWN0aXZlcy4KICogVGhpcyBpcyBiZWNhdXNlIG9mIHRoZSBmb2xsb3dpbmcgZm9ybSBzdWJtaXNzaW9uIHJ1bGVzIGluIHRoZSBIVE1MIHNwZWNpZmljYXRpb246CiAqCiAqIC0gSWYgYSBmb3JtIGhhcyBvbmx5IG9uZSBpbnB1dCBmaWVsZCB0aGVuIGhpdHRpbmcgZW50ZXIgaW4gdGhpcyBmaWVsZCB0cmlnZ2VycyBmb3JtIHN1Ym1pdAogKiAoYG5nU3VibWl0YCkKICogLSBpZiBhIGZvcm0gaGFzIDIrIGlucHV0IGZpZWxkcyBhbmQgbm8gYnV0dG9ucyBvciBpbnB1dFt0eXBlPXN1Ym1pdF0gdGhlbiBoaXR0aW5nIGVudGVyCiAqIGRvZXNuJ3QgdHJpZ2dlciBzdWJtaXQKICogLSBpZiBhIGZvcm0gaGFzIG9uZSBvciBtb3JlIGlucHV0IGZpZWxkcyBhbmQgb25lIG9yIG1vcmUgYnV0dG9ucyBvciBpbnB1dFt0eXBlPXN1Ym1pdF0gdGhlbgogKiBoaXR0aW5nIGVudGVyIGluIGFueSBvZiB0aGUgaW5wdXQgZmllbGRzIHdpbGwgdHJpZ2dlciB0aGUgY2xpY2sgaGFuZGxlciBvbiB0aGUgKmZpcnN0KiBidXR0b24gb3IKICogaW5wdXRbdHlwZT1zdWJtaXRdIChgbmdDbGlja2ApICphbmQqIGEgc3VibWl0IGhhbmRsZXIgb24gdGhlIGVuY2xvc2luZyBmb3JtIChgbmdTdWJtaXRgKQogKgogKiBBbnkgcGVuZGluZyBgbmdNb2RlbE9wdGlvbnNgIGNoYW5nZXMgd2lsbCB0YWtlIHBsYWNlIGltbWVkaWF0ZWx5IHdoZW4gYW4gZW5jbG9zaW5nIGZvcm0gaXMKICogc3VibWl0dGVkLiBOb3RlIHRoYXQgYG5nQ2xpY2tgIGV2ZW50cyB3aWxsIG9jY3VyIGJlZm9yZSB0aGUgbW9kZWwgaXMgdXBkYXRlZC4gVXNlIGBuZ1N1Ym1pdGAKICogdG8gaGF2ZSBhY2Nlc3MgdG8gdGhlIHVwZGF0ZWQgbW9kZWwuCiAqCiAqICMjIEFuaW1hdGlvbiBIb29rcwogKgogKiBBbmltYXRpb25zIGluIG5nRm9ybSBhcmUgdHJpZ2dlcmVkIHdoZW4gYW55IG9mIHRoZSBhc3NvY2lhdGVkIENTUyBjbGFzc2VzIGFyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KICogVGhlc2UgY2xhc3NlcyBhcmU6IGAubmctcHJpc3RpbmVgLCBgLm5nLWRpcnR5YCwgYC5uZy1pbnZhbGlkYCBhbmQgYC5uZy12YWxpZGAgYXMgd2VsbCBhcyBhbnkKICogb3RoZXIgdmFsaWRhdGlvbnMgdGhhdCBhcmUgcGVyZm9ybWVkIHdpdGhpbiB0aGUgZm9ybS4gQW5pbWF0aW9ucyBpbiBuZ0Zvcm0gYXJlIHNpbWlsYXIgdG8gaG93CiAqIHRoZXkgd29yayBpbiBuZ0NsYXNzIGFuZCBhbmltYXRpb25zIGNhbiBiZSBob29rZWQgaW50byB1c2luZyBDU1MgdHJhbnNpdGlvbnMsIGtleWZyYW1lcyBhcyB3ZWxsCiAqIGFzIEpTIGFuaW1hdGlvbnMuCiAqCiAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzaG93cyBhIHNpbXBsZSB3YXkgdG8gdXRpbGl6ZSBDU1MgdHJhbnNpdGlvbnMgdG8gc3R5bGUgYSBmb3JtIGVsZW1lbnQKICogdGhhdCBoYXMgYmVlbiByZW5kZXJlZCBhcyBpbnZhbGlkIGFmdGVyIGl0IGhhcyBiZWVuIHZhbGlkYXRlZDoKICoKICogPHByZT4KICogLy9iZSBzdXJlIHRvIGluY2x1ZGUgbmdBbmltYXRlIGFzIGEgbW9kdWxlIHRvIGhvb2sgaW50byBtb3JlCiAqIC8vYWR2YW5jZWQgYW5pbWF0aW9ucwogKiAubXktZm9ybSB7CiAqICAgdHJhbnNpdGlvbjowLjVzIGxpbmVhciBhbGw7CiAqICAgYmFja2dyb3VuZDogd2hpdGU7CiAqIH0KICogLm15LWZvcm0ubmctaW52YWxpZCB7CiAqICAgYmFja2dyb3VuZDogcmVkOwogKiAgIGNvbG9yOndoaXRlOwogKiB9CiAqIDwvcHJlPgogKgogKiBAZXhhbXBsZQogICAgPGV4YW1wbGUgZGVwcz0iYW5ndWxhci1hbmltYXRlLmpzIiBhbmltYXRpb25zPSJ0cnVlIiBmaXhCYXNlPSJ0cnVlIiBtb2R1bGU9ImZvcm1FeGFtcGxlIj4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBhbmd1bGFyLm1vZHVsZSgnZm9ybUV4YW1wbGUnLCBbXSkKICAgICAgICAgICAuY29udHJvbGxlcignRm9ybUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnVzZXJUeXBlID0gJ2d1ZXN0JzsKICAgICAgICAgICB9XSk7CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxzdHlsZT4KICAgICAgICAubXktZm9ybSB7CiAgICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICAgICAgICB9CiAgICAgICAgLm15LWZvcm0ubmctaW52YWxpZCB7CiAgICAgICAgICBiYWNrZ3JvdW5kOiByZWQ7CiAgICAgICAgfQogICAgICAgPC9zdHlsZT4KICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iRm9ybUNvbnRyb2xsZXIiIGNsYXNzPSJteS1mb3JtIj4KICAgICAgICAgdXNlclR5cGU6IDxpbnB1dCBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InVzZXJUeXBlIiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj5SZXF1aXJlZCE8L3NwYW4+PGJyPgogICAgICAgICA8dHQ+dXNlclR5cGUgPSB7e3VzZXJUeXBlfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgICAgICAgPC9mb3JtPgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHVzZXJUeXBlID0gZWxlbWVudChieS5iaW5kaW5nKCd1c2VyVHlwZScpKTsKICAgICAgICAgIHZhciB2YWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKTsKCiAgICAgICAgICBleHBlY3QodXNlclR5cGUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2d1ZXN0Jyk7CiAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdXNlclR5cGUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3VzZXJUeXBlJykpOwogICAgICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgICAgICAgdmFyIHVzZXJJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3VzZXJUeXBlJykpOwoKICAgICAgICAgIHVzZXJJbnB1dC5jbGVhcigpOwogICAgICAgICAgdXNlcklucHV0LnNlbmRLZXlzKCcnKTsKCiAgICAgICAgICBleHBlY3QodXNlclR5cGUuZ2V0VGV4dCgpKS50b0VxdWFsKCd1c2VyVHlwZSA9Jyk7CiAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICoKICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIE5hbWUgb2YgdGhlIGZvcm0uIElmIHNwZWNpZmllZCwgdGhlIGZvcm0gY29udHJvbGxlciB3aWxsIGJlIHB1Ymxpc2hlZCBpbnRvCiAqICAgICAgICAgICAgICAgICAgICAgICByZWxhdGVkIHNjb3BlLCB1bmRlciB0aGlzIG5hbWUuCiAqLwp2YXIgZm9ybURpcmVjdGl2ZUZhY3RvcnkgPSBmdW5jdGlvbihpc05nRm9ybSkgewogIHJldHVybiBbJyR0aW1lb3V0JywgZnVuY3Rpb24oJHRpbWVvdXQpIHsKICAgIHZhciBmb3JtRGlyZWN0aXZlID0gewogICAgICBuYW1lOiAnZm9ybScsCiAgICAgIHJlc3RyaWN0OiBpc05nRm9ybSA/ICdFQUMnIDogJ0UnLAogICAgICBjb250cm9sbGVyOiBGb3JtQ29udHJvbGxlciwKICAgICAgY29tcGlsZTogZnVuY3Rpb24gbmdGb3JtQ29tcGlsZShmb3JtRWxlbWVudCkgewogICAgICAgIC8vIFNldHVwIGluaXRpYWwgc3RhdGUgb2YgdGhlIGNvbnRyb2wKICAgICAgICBmb3JtRWxlbWVudC5hZGRDbGFzcyhQUklTVElORV9DTEFTUykuYWRkQ2xhc3MoVkFMSURfQ0xBU1MpOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgcHJlOiBmdW5jdGlvbiBuZ0Zvcm1QcmVMaW5rKHNjb3BlLCBmb3JtRWxlbWVudCwgYXR0ciwgY29udHJvbGxlcikgewogICAgICAgICAgICAvLyBpZiBgYWN0aW9uYCBhdHRyIGlzIG5vdCBwcmVzZW50IG9uIHRoZSBmb3JtLCBwcmV2ZW50IHRoZSBkZWZhdWx0IGFjdGlvbiAoc3VibWlzc2lvbikKICAgICAgICAgICAgaWYgKCEoJ2FjdGlvbicgaW4gYXR0cikpIHsKICAgICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UganEgZXZlbnRzIGJlY2F1c2UgaWYgYSBmb3JtIGlzIGRlc3Ryb3llZCBkdXJpbmcgc3VibWlzc2lvbiB0aGUgZGVmYXVsdAogICAgICAgICAgICAgIC8vIGFjdGlvbiBpcyBub3QgcHJldmVudGVkLiBzZWUgIzEyMzgKICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgIC8vIElFIDkgaXMgbm90IGFmZmVjdGVkIGJlY2F1c2UgaXQgZG9lc24ndCBmaXJlIGEgc3VibWl0IGV2ZW50IGFuZCB0cnkgdG8gZG8gYSBmdWxsCiAgICAgICAgICAgICAgLy8gcGFnZSByZWxvYWQgaWYgdGhlIGZvcm0gd2FzIGRlc3Ryb3llZCBieSBzdWJtaXNzaW9uIG9mIHRoZSBmb3JtIHZpYSBhIGNsaWNrIGhhbmRsZXIKICAgICAgICAgICAgICAvLyBvbiBhIGJ1dHRvbiBpbiB0aGUgZm9ybS4gTG9va3MgbGlrZSBhbiBJRTkgc3BlY2lmaWMgYnVnLgogICAgICAgICAgICAgIHZhciBoYW5kbGVGb3JtU3VibWlzc2lvbiA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIuJGNvbW1pdFZpZXdWYWx1ZSgpOwogICAgICAgICAgICAgICAgICBjb250cm9sbGVyLiRzZXRTdWJtaXR0ZWQoKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0CiAgICAgICAgICAgICAgICAgID8gZXZlbnQucHJldmVudERlZmF1bHQoKQogICAgICAgICAgICAgICAgICA6IGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7IC8vIElFCiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuKGZvcm1FbGVtZW50WzBdLCAnc3VibWl0JywgaGFuZGxlRm9ybVN1Ym1pc3Npb24pOwoKICAgICAgICAgICAgICAvLyB1bnJlZ2lzdGVyIHRoZSBwcmV2ZW50RGVmYXVsdCBsaXN0ZW5lciBzbyB0aGF0IHdlIGRvbid0IG5vdCBsZWFrIG1lbW9yeSBidXQgaW4gYQogICAgICAgICAgICAgIC8vIHdheSB0aGF0IHdpbGwgYWNoaWV2ZSB0aGUgcHJldmVudGlvbiBvZiB0aGUgZGVmYXVsdCBhY3Rpb24uCiAgICAgICAgICAgICAgZm9ybUVsZW1lbnQub24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKGZvcm1FbGVtZW50WzBdLCAnc3VibWl0JywgaGFuZGxlRm9ybVN1Ym1pc3Npb24pOwogICAgICAgICAgICAgICAgfSwgMCwgZmFsc2UpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcGFyZW50Rm9ybUN0cmwgPSBjb250cm9sbGVyLiQkcGFyZW50Rm9ybSwKICAgICAgICAgICAgICAgIGFsaWFzID0gY29udHJvbGxlci4kbmFtZTsKCiAgICAgICAgICAgIGlmIChhbGlhcykgewogICAgICAgICAgICAgIHNldHRlcihzY29wZSwgYWxpYXMsIGNvbnRyb2xsZXIsIGFsaWFzKTsKICAgICAgICAgICAgICBhdHRyLiRvYnNlcnZlKGF0dHIubmFtZSA/ICduYW1lJyA6ICduZ0Zvcm0nLCBmdW5jdGlvbihuZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKGFsaWFzID09PSBuZXdWYWx1ZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgc2V0dGVyKHNjb3BlLCBhbGlhcywgdW5kZWZpbmVkLCBhbGlhcyk7CiAgICAgICAgICAgICAgICBhbGlhcyA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgICAgc2V0dGVyKHNjb3BlLCBhbGlhcywgY29udHJvbGxlciwgYWxpYXMpOwogICAgICAgICAgICAgICAgcGFyZW50Rm9ybUN0cmwuJCRyZW5hbWVDb250cm9sKGNvbnRyb2xsZXIsIGFsaWFzKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3JtRWxlbWVudC5vbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBwYXJlbnRGb3JtQ3RybC4kcmVtb3ZlQ29udHJvbChjb250cm9sbGVyKTsKICAgICAgICAgICAgICBpZiAoYWxpYXMpIHsKICAgICAgICAgICAgICAgIHNldHRlcihzY29wZSwgYWxpYXMsIHVuZGVmaW5lZCwgYWxpYXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBleHRlbmQoY29udHJvbGxlciwgbnVsbEZvcm1DdHJsKTsgLy9zdG9wIHByb3BhZ2F0aW5nIGNoaWxkIGRlc3RydWN0aW9uIGhhbmRsZXJzIHVwd2FyZHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gZm9ybURpcmVjdGl2ZTsKICB9XTsKfTsKCnZhciBmb3JtRGlyZWN0aXZlID0gZm9ybURpcmVjdGl2ZUZhY3RvcnkoKTsKdmFyIG5nRm9ybURpcmVjdGl2ZSA9IGZvcm1EaXJlY3RpdmVGYWN0b3J5KHRydWUpOwoKLyogZ2xvYmFsIFZBTElEX0NMQVNTOiB0cnVlLAogIElOVkFMSURfQ0xBU1M6IHRydWUsCiAgUFJJU1RJTkVfQ0xBU1M6IHRydWUsCiAgRElSVFlfQ0xBU1M6IHRydWUsCiAgVU5UT1VDSEVEX0NMQVNTOiB0cnVlLAogIFRPVUNIRURfQ0xBU1M6IHRydWUsCiovCgovLyBSZWdleCBjb2RlIGlzIG9idGFpbmVkIGZyb20gU086IGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzMxNDMwNzAvamF2YXNjcmlwdC1yZWdleC1pc28tZGF0ZXRpbWUjYW5zd2VyLTMxNDMyMzEKdmFyIElTT19EQVRFX1JFR0VYUCA9IC9cZHs0fS1bMDFdXGQtWzAtM11cZFRbMC0yXVxkOlswLTVdXGQ6WzAtNV1cZFwuXGQrKFsrLV1bMC0yXVxkOlswLTVdXGR8WikvOwp2YXIgVVJMX1JFR0VYUCA9IC9eKGZ0cHxodHRwfGh0dHBzKTpcL1wvKFx3Kzp7MCwxfVx3KkApPyhcUyspKDpbMC05XSspPyhcL3xcLyhbXHcjITouPys9JiVAIVwtXC9dKSk/JC87CnZhciBFTUFJTF9SRUdFWFAgPSAvXlthLXowLTkhIyQlJicqK1wvPT9eX2B7fH1+Li1dK0BbYS16MC05XShbYS16MC05LV0qW2EtejAtOV0pPyhcLlthLXowLTldKFthLXowLTktXSpbYS16MC05XSk/KSokL2k7CnZhciBOVU1CRVJfUkVHRVhQID0gL15ccyooXC18XCspPyhcZCt8KFxkKihcLlxkKikpKVxzKiQvOwp2YXIgREFURV9SRUdFWFAgPSAvXihcZHs0fSktKFxkezJ9KS0oXGR7Mn0pJC87CnZhciBEQVRFVElNRUxPQ0FMX1JFR0VYUCA9IC9eKFxkezR9KS0oXGRcZCktKFxkXGQpVChcZFxkKTooXGRcZCkoPzo6KFxkXGQpKFwuXGR7MSwzfSk/KT8kLzsKdmFyIFdFRUtfUkVHRVhQID0gL14oXGR7NH0pLVcoXGRcZCkkLzsKdmFyIE1PTlRIX1JFR0VYUCA9IC9eKFxkezR9KS0oXGRcZCkkLzsKdmFyIFRJTUVfUkVHRVhQID0gL14oXGRcZCk6KFxkXGQpKD86OihcZFxkKShcLlxkezEsM30pPyk/JC87CnZhciBERUZBVUxUX1JFR0VYUCA9IC8oXHMrfF4pZGVmYXVsdChccyt8JCkvOwoKdmFyICRuZ01vZGVsTWluRXJyID0gbmV3IG1pbkVycignbmdNb2RlbCcpOwoKdmFyIGlucHV0VHlwZSA9IHsKCiAgLyoqCiAgICogQG5nZG9jIGlucHV0CiAgICogQG5hbWUgaW5wdXRbdGV4dF0KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFN0YW5kYXJkIEhUTUwgdGV4dCBpbnB1dCB3aXRoIGFuZ3VsYXIgZGF0YSBiaW5kaW5nLCBpbmhlcml0ZWQgYnkgbW9zdCBvZiB0aGUgYGlucHV0YCBlbGVtZW50cy4KICAgKgogICAqICpOT1RFKiBOb3QgZXZlcnkgZmVhdHVyZSBvZmZlcmVkIGlzIGF2YWlsYWJsZSBmb3IgYWxsIGlucHV0IHR5cGVzLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAqICAgIG1pbmxlbmd0aC4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICogICAgbWF4bGVuZ3RoLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtuZ1RyaW09dHJ1ZV0gSWYgc2V0IHRvIGZhbHNlIEFuZ3VsYXIgd2lsbCBub3QgYXV0b21hdGljYWxseSB0cmltIHRoZSBpbnB1dC4KICAgKiAgICBUaGlzIHBhcmFtZXRlciBpcyBpZ25vcmVkIGZvciBpbnB1dFt0eXBlPXBhc3N3b3JkXSBjb250cm9scywgd2hpY2ggd2lsbCBuZXZlciB0cmltIHRoZQogICAqICAgIGlucHV0LgogICAqCiAgICogQGV4YW1wbGUKICAgICAgPGV4YW1wbGUgbmFtZT0idGV4dC1pbnB1dC1kaXJlY3RpdmUiIG1vZHVsZT0idGV4dElucHV0RXhhbXBsZSI+CiAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ3RleHRJbnB1dEV4YW1wbGUnLCBbXSkKICAgICAgICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ2d1ZXN0JzsKICAgICAgICAgICAgICAgJHNjb3BlLndvcmQgPSAvXlxzKlx3KlxzKiQvOwogICAgICAgICAgICAgfV0pOwogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICAgICAgU2luZ2xlIHdvcmQ6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZy1wYXR0ZXJuPSJ3b3JkIiByZXF1aXJlZCBuZy10cmltPSJmYWxzZSI+CiAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucGF0dGVybiI+CiAgICAgICAgICAgICBTaW5nbGUgd29yZCBvbmx5ITwvc3Bhbj4KCiAgICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICAgdmFyIHRleHQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3RleHQnKSk7CiAgICAgICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd0ZXh0JykpOwoKICAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QodGV4dC5nZXRUZXh0KCkpLnRvQ29udGFpbignZ3Vlc3QnKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0VxdWFsKCd0ZXh0ID0nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG11bHRpIHdvcmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJ2hlbGxvIHdvcmxkJyk7CgogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgIDwvZXhhbXBsZT4KICAgKi8KICAndGV4dCc6IHRleHRJbnB1dFR5cGUsCgogICAgLyoqCiAgICAgKiBAbmdkb2MgaW5wdXQKICAgICAqIEBuYW1lIGlucHV0W2RhdGVdCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBJbnB1dCB3aXRoIGRhdGUgdmFsaWRhdGlvbiBhbmQgdHJhbnNmb3JtYXRpb24uIEluIGJyb3dzZXJzIHRoYXQgZG8gbm90IHlldCBzdXBwb3J0CiAgICAgKiB0aGUgSFRNTDUgZGF0ZSBpbnB1dCwgYSB0ZXh0IGVsZW1lbnQgd2lsbCBiZSB1c2VkLiBJbiB0aGF0IGNhc2UsIHRleHQgbXVzdCBiZSBlbnRlcmVkIGluIGEgdmFsaWQgSVNPLTg2MDEKICAgICAqIGRhdGUgZm9ybWF0ICh5eXl5LU1NLWRkKSwgZm9yIGV4YW1wbGU6IGAyMDA5LTAxLTA2YC4gU2luY2UgbWFueQogICAgICogbW9kZXJuIGJyb3dzZXJzIGRvIG5vdCB5ZXQgc3VwcG9ydCB0aGlzIGlucHV0IHR5cGUsIGl0IGlzIGltcG9ydGFudCB0byBwcm92aWRlIGN1ZXMgdG8gdXNlcnMgb24gdGhlCiAgICAgKiBleHBlY3RlZCBpbnB1dCBmb3JtYXQgdmlhIGEgcGxhY2Vob2xkZXIgb3IgbGFiZWwuIFRoZSBtb2RlbCBtdXN0IGFsd2F5cyBiZSBhIERhdGUgb2JqZWN0LgogICAgICoKICAgICAqIFRoZSB0aW1lem9uZSB0byBiZSB1c2VkIHRvIHJlYWQvd3JpdGUgdGhlIGBEYXRlYCBpbnN0YW5jZSBpbiB0aGUgbW9kZWwgY2FuIGJlIGRlZmluZWQgdXNpbmcKICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbE9wdGlvbnMgbmdNb2RlbE9wdGlvbnN9LiBCeSBkZWZhdWx0LCB0aGlzIGlzIHRoZSB0aW1lem9uZSBvZiB0aGUgYnJvd3Nlci4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG1pbiBTZXRzIHRoZSBgbWluYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBsZXNzIHRoYW4gYG1pbmAuIFRoaXMgbXVzdCBiZSBhCiAgICAgKiB2YWxpZCBJU08gZGF0ZSBzdHJpbmcgKHl5eXktTU0tZGQpLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBtYXggU2V0cyB0aGUgYG1heGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGVudGVyZWQgaXMgZ3JlYXRlciB0aGFuIGBtYXhgLiBUaGlzIG11c3QgYmUKICAgICAqIGEgdmFsaWQgSVNPIGRhdGUgc3RyaW5nICh5eXl5LU1NLWRkKS4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGUgbmFtZT0iZGF0ZS1pbnB1dC1kaXJlY3RpdmUiIG1vZHVsZT0iZGF0ZUlucHV0RXhhbXBsZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ2RhdGVJbnB1dEV4YW1wbGUnLCBbXSkKICAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0RhdGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgICAkc2NvcGUudmFsdWUgPSBuZXcgRGF0ZSgyMDEzLCA5LCAyMik7CiAgICAgICAgICAgIH1dKTsKICAgICAgIDwvc2NyaXB0PgogICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJEYXRlQ29udHJvbGxlciBhcyBkYXRlQ3RybCI+CiAgICAgICAgICBQaWNrIGEgZGF0ZSBpbiAyMDEzOgogICAgICAgICAgPGlucHV0IHR5cGU9ImRhdGUiIGlkPSJleGFtcGxlSW5wdXQiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idmFsdWUiCiAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9Inl5eXktTU0tZGQiIG1pbj0iMjAxMy0wMS0wMSIgbWF4PSIyMDEzLTEyLTMxIiByZXF1aXJlZCAvPgogICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IuZGF0ZSI+CiAgICAgICAgICAgICAgTm90IGEgdmFsaWQgZGF0ZSE8L3NwYW4+CiAgICAgICAgICAgPHR0PnZhbHVlID0ge3t2YWx1ZSB8IGRhdGU6ICJ5eXl5LU1NLWRkIn19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICAgIDwvZm9ybT4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgdmFyIHZhbHVlID0gZWxlbWVudChieS5iaW5kaW5nKCd2YWx1ZSB8IGRhdGU6ICJ5eXl5LU1NLWRkIicpKTsKICAgICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgICAgdmFyIGlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSk7CgogICAgICAgIC8vIGN1cnJlbnRseSBwcm90cmFjdG9yL3dlYmRyaXZlciBkb2VzIG5vdCBzdXBwb3J0CiAgICAgICAgLy8gc2VuZGluZyBrZXlzIHRvIGFsbCBrbm93biBIVE1MNSBpbnB1dCBjb250cm9scwogICAgICAgIC8vIGZvciB2YXJpb3VzIGJyb3dzZXJzIChzZWUgaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvcHJvdHJhY3Rvci9pc3N1ZXMvNTYyKS4KICAgICAgICBmdW5jdGlvbiBzZXRJbnB1dCh2YWwpIHsKICAgICAgICAgIC8vIHNldCB0aGUgdmFsdWUgb2YgdGhlIGVsZW1lbnQgYW5kIGZvcmNlIHZhbGlkYXRpb24uCiAgICAgICAgICB2YXIgc2NyID0gInZhciBpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXhhbXBsZUlucHV0Jyk7ICIgKwogICAgICAgICAgImlwdC52YWx1ZSA9ICciICsgdmFsICsgIic7IiArCiAgICAgICAgICAiYW5ndWxhci5lbGVtZW50KGlwdCkuc2NvcGUoKS4kYXBwbHkoZnVuY3Rpb24ocykgeyBzLm15Rm9ybVtpcHQubmFtZV0uJHNldFZpZXdWYWx1ZSgnIiArIHZhbCArICInKTsgfSk7IjsKICAgICAgICAgIGJyb3dzZXIuZXhlY3V0ZVNjcmlwdChzY3IpOwogICAgICAgIH0KCiAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJzIwMTMtMTAtMjInKTsKICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignbXlGb3JtLmlucHV0LiR2YWxpZCA9IHRydWUnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZXRJbnB1dCgnJyk7CiAgICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0VxdWFsKCd2YWx1ZSA9Jyk7CiAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ215Rm9ybS5pbnB1dC4kdmFsaWQgPSBmYWxzZScpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgb3ZlciBtYXgnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHNldElucHV0KCcyMDE1LTAxLTAxJyk7CiAgICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJycpOwogICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdteUZvcm0uaW5wdXQuJHZhbGlkID0gZmFsc2UnKTsKICAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCiAgJ2RhdGUnOiBjcmVhdGVEYXRlSW5wdXRUeXBlKCdkYXRlJywgREFURV9SRUdFWFAsCiAgICAgICAgIGNyZWF0ZURhdGVQYXJzZXIoREFURV9SRUdFWFAsIFsneXl5eScsICdNTScsICdkZCddKSwKICAgICAgICAgJ3l5eXktTU0tZGQnKSwKCiAgIC8qKgogICAgKiBAbmdkb2MgaW5wdXQKICAgICogQG5hbWUgaW5wdXRbZGF0ZVRpbWVMb2NhbF0KICAgICoKICAgICogQGRlc2NyaXB0aW9uCiAgICAqIElucHV0IHdpdGggZGF0ZXRpbWUgdmFsaWRhdGlvbiBhbmQgdHJhbnNmb3JtYXRpb24uIEluIGJyb3dzZXJzIHRoYXQgZG8gbm90IHlldCBzdXBwb3J0CiAgICAqIHRoZSBIVE1MNSBkYXRlIGlucHV0LCBhIHRleHQgZWxlbWVudCB3aWxsIGJlIHVzZWQuIEluIHRoYXQgY2FzZSwgdGhlIHRleHQgbXVzdCBiZSBlbnRlcmVkIGluIGEgdmFsaWQgSVNPLTg2MDEKICAgICogbG9jYWwgZGF0ZXRpbWUgZm9ybWF0ICh5eXl5LU1NLWRkVEhIOm1tOnNzKSwgZm9yIGV4YW1wbGU6IGAyMDEwLTEyLTI4VDE0OjU3OjAwYC4gVGhlIG1vZGVsIG11c3QgYmUgYSBEYXRlIG9iamVjdC4KICAgICoKICAgICogVGhlIHRpbWV6b25lIHRvIGJlIHVzZWQgdG8gcmVhZC93cml0ZSB0aGUgYERhdGVgIGluc3RhbmNlIGluIHRoZSBtb2RlbCBjYW4gYmUgZGVmaW5lZCB1c2luZwogICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nTW9kZWxPcHRpb25zIG5nTW9kZWxPcHRpb25zfS4gQnkgZGVmYXVsdCwgdGhpcyBpcyB0aGUgdGltZXpvbmUgb2YgdGhlIGJyb3dzZXIuCiAgICAqCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgKiBAcGFyYW0ge3N0cmluZz19IG1pbiBTZXRzIHRoZSBgbWluYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBsZXNzIHRoYW4gYG1pbmAuIFRoaXMgbXVzdCBiZSBhCiAgICAqIHZhbGlkIElTTyBkYXRldGltZSBmb3JtYXQgKHl5eXktTU0tZGRUSEg6bW06c3MpLgogICAgKiBAcGFyYW0ge3N0cmluZz19IG1heCBTZXRzIHRoZSBgbWF4YCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBncmVhdGVyIHRoYW4gYG1heGAuIFRoaXMgbXVzdCBiZQogICAgKiBhIHZhbGlkIElTTyBkYXRldGltZSBmb3JtYXQgKHl5eXktTU0tZGRUSEg6bW06c3MpLgogICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAqCiAgICAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZSBuYW1lPSJkYXRldGltZWxvY2FsLWlucHV0LWRpcmVjdGl2ZSIgbW9kdWxlPSJkYXRlRXhhbXBsZSI+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPHNjcmlwdD4KICAgICAgICBhbmd1bGFyLm1vZHVsZSgnZGF0ZUV4YW1wbGUnLCBbXSkKICAgICAgICAgIC5jb250cm9sbGVyKCdEYXRlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAgICRzY29wZS52YWx1ZSA9IG5ldyBEYXRlKDIwMTAsIDExLCAyOCwgMTQsIDU3KTsKICAgICAgICAgIH1dKTsKICAgICAgPC9zY3JpcHQ+CiAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iRGF0ZUNvbnRyb2xsZXIgYXMgZGF0ZUN0cmwiPgogICAgICAgIFBpY2sgYSBkYXRlIGJldHdlZW4gaW4gMjAxMzoKICAgICAgICA8aW5wdXQgdHlwZT0iZGF0ZXRpbWUtbG9jYWwiIGlkPSJleGFtcGxlSW5wdXQiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idmFsdWUiCiAgICAgICAgICAgIHBsYWNlaG9sZGVyPSJ5eXl5LU1NLWRkVEhIOm1tOnNzIiBtaW49IjIwMDEtMDEtMDFUMDA6MDA6MDAiIG1heD0iMjAxMy0xMi0zMVQwMDowMDowMCIgcmVxdWlyZWQgLz4KICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLmRhdGV0aW1lbG9jYWwiPgogICAgICAgICAgICBOb3QgYSB2YWxpZCBkYXRlITwvc3Bhbj4KICAgICAgICA8dHQ+dmFsdWUgPSB7e3ZhbHVlIHwgZGF0ZTogInl5eXktTU0tZGRUSEg6bW06c3MifX08L3R0Pjxici8+CiAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICA8L2Zvcm0+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgdmFyIHZhbHVlID0gZWxlbWVudChieS5iaW5kaW5nKCd2YWx1ZSB8IGRhdGU6ICJ5eXl5LU1NLWRkVEhIOm1tOnNzIicpKTsKICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKTsKCiAgICAgIC8vIGN1cnJlbnRseSBwcm90cmFjdG9yL3dlYmRyaXZlciBkb2VzIG5vdCBzdXBwb3J0CiAgICAgIC8vIHNlbmRpbmcga2V5cyB0byBhbGwga25vd24gSFRNTDUgaW5wdXQgY29udHJvbHMKICAgICAgLy8gZm9yIHZhcmlvdXMgYnJvd3NlcnMgKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL3Byb3RyYWN0b3IvaXNzdWVzLzU2MikuCiAgICAgIGZ1bmN0aW9uIHNldElucHV0KHZhbCkgewogICAgICAgIC8vIHNldCB0aGUgdmFsdWUgb2YgdGhlIGVsZW1lbnQgYW5kIGZvcmNlIHZhbGlkYXRpb24uCiAgICAgICAgdmFyIHNjciA9ICJ2YXIgaXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4YW1wbGVJbnB1dCcpOyAiICsKICAgICAgICAiaXB0LnZhbHVlID0gJyIgKyB2YWwgKyAiJzsiICsKICAgICAgICAiYW5ndWxhci5lbGVtZW50KGlwdCkuc2NvcGUoKS4kYXBwbHkoZnVuY3Rpb24ocykgeyBzLm15Rm9ybVtpcHQubmFtZV0uJHNldFZpZXdWYWx1ZSgnIiArIHZhbCArICInKTsgfSk7IjsKICAgICAgICBicm93c2VyLmV4ZWN1dGVTY3JpcHQoc2NyKTsKICAgICAgfQoKICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9Db250YWluKCcyMDEwLTEyLTI4VDE0OjU3OjAwJyk7CiAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdteUZvcm0uaW5wdXQuJHZhbGlkID0gdHJ1ZScpOwogICAgICB9KTsKCiAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgIHNldElucHV0KCcnKTsKICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0VxdWFsKCd2YWx1ZSA9Jyk7CiAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdteUZvcm0uaW5wdXQuJHZhbGlkID0gZmFsc2UnKTsKICAgICAgfSk7CgogICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgb3ZlciBtYXgnLCBmdW5jdGlvbigpIHsKICAgICAgICBzZXRJbnB1dCgnMjAxNS0wMS0wMVQyMzo1OTowMCcpOwogICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvQ29udGFpbignJyk7CiAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdteUZvcm0uaW5wdXQuJHZhbGlkID0gZmFsc2UnKTsKICAgICAgfSk7CiAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAgICAqLwogICdkYXRldGltZS1sb2NhbCc6IGNyZWF0ZURhdGVJbnB1dFR5cGUoJ2RhdGV0aW1lbG9jYWwnLCBEQVRFVElNRUxPQ0FMX1JFR0VYUCwKICAgICAgY3JlYXRlRGF0ZVBhcnNlcihEQVRFVElNRUxPQ0FMX1JFR0VYUCwgWyd5eXl5JywgJ01NJywgJ2RkJywgJ0hIJywgJ21tJywgJ3NzJywgJ3NzcyddKSwKICAgICAgJ3l5eXktTU0tZGRUSEg6bW06c3Muc3NzJyksCgogIC8qKgogICAqIEBuZ2RvYyBpbnB1dAogICAqIEBuYW1lIGlucHV0W3RpbWVdCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBJbnB1dCB3aXRoIHRpbWUgdmFsaWRhdGlvbiBhbmQgdHJhbnNmb3JtYXRpb24uIEluIGJyb3dzZXJzIHRoYXQgZG8gbm90IHlldCBzdXBwb3J0CiAgICogdGhlIEhUTUw1IGRhdGUgaW5wdXQsIGEgdGV4dCBlbGVtZW50IHdpbGwgYmUgdXNlZC4gSW4gdGhhdCBjYXNlLCB0aGUgdGV4dCBtdXN0IGJlIGVudGVyZWQgaW4gYSB2YWxpZCBJU08tODYwMQogICAqIGxvY2FsIHRpbWUgZm9ybWF0IChISDptbTpzcyksIGZvciBleGFtcGxlOiBgMTQ6NTc6MDBgLiBNb2RlbCBtdXN0IGJlIGEgRGF0ZSBvYmplY3QuIFRoaXMgYmluZGluZyB3aWxsIGFsd2F5cyBvdXRwdXQgYQogICAqIERhdGUgb2JqZWN0IHRvIHRoZSBtb2RlbCBvZiBKYW51YXJ5IDEsIDE5NzAsIG9yIGxvY2FsIGRhdGUgYG5ldyBEYXRlKDE5NzAsIDAsIDEsIEhILCBtbSwgc3MpYC4KICAgKgogICAqIFRoZSB0aW1lem9uZSB0byBiZSB1c2VkIHRvIHJlYWQvd3JpdGUgdGhlIGBEYXRlYCBpbnN0YW5jZSBpbiB0aGUgbW9kZWwgY2FuIGJlIGRlZmluZWQgdXNpbmcKICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nTW9kZWxPcHRpb25zIG5nTW9kZWxPcHRpb25zfS4gQnkgZGVmYXVsdCwgdGhpcyBpcyB0aGUgdGltZXpvbmUgb2YgdGhlIGJyb3dzZXIuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbWluIFNldHMgdGhlIGBtaW5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGxlc3MgdGhhbiBgbWluYC4gVGhpcyBtdXN0IGJlIGEKICAgKiB2YWxpZCBJU08gdGltZSBmb3JtYXQgKEhIOm1tOnNzKS4KICAgKiBAcGFyYW0ge3N0cmluZz19IG1heCBTZXRzIHRoZSBgbWF4YCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBncmVhdGVyIHRoYW4gYG1heGAuIFRoaXMgbXVzdCBiZSBhCiAgICogdmFsaWQgSVNPIHRpbWUgZm9ybWF0IChISDptbTpzcykuCiAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG5hbWU9InRpbWUtaW5wdXQtZGlyZWN0aXZlIiBtb2R1bGU9InRpbWVFeGFtcGxlIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPHNjcmlwdD4KICAgICAgYW5ndWxhci5tb2R1bGUoJ3RpbWVFeGFtcGxlJywgW10pCiAgICAgICAgLmNvbnRyb2xsZXIoJ0RhdGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICRzY29wZS52YWx1ZSA9IG5ldyBEYXRlKDE5NzAsIDAsIDEsIDE0LCA1NywgMCk7CiAgICAgICAgfV0pOwogICAgIDwvc2NyaXB0PgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iRGF0ZUNvbnRyb2xsZXIgYXMgZGF0ZUN0cmwiPgogICAgICAgIFBpY2sgYSBiZXR3ZWVuIDhhbSBhbmQgNXBtOgogICAgICAgIDxpbnB1dCB0eXBlPSJ0aW1lIiBpZD0iZXhhbXBsZUlucHV0IiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InZhbHVlIgogICAgICAgICAgICBwbGFjZWhvbGRlcj0iSEg6bW06c3MiIG1pbj0iMDg6MDA6MDAiIG1heD0iMTc6MDA6MDAiIHJlcXVpcmVkIC8+CiAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci50aW1lIj4KICAgICAgICAgICAgTm90IGEgdmFsaWQgZGF0ZSE8L3NwYW4+CiAgICAgICAgPHR0PnZhbHVlID0ge3t2YWx1ZSB8IGRhdGU6ICJISDptbTpzcyJ9fTwvdHQ+PGJyLz4KICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgPC9mb3JtPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICB2YXIgdmFsdWUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3ZhbHVlIHwgZGF0ZTogIkhIOm1tOnNzIicpKTsKICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKTsKCiAgICAgIC8vIGN1cnJlbnRseSBwcm90cmFjdG9yL3dlYmRyaXZlciBkb2VzIG5vdCBzdXBwb3J0CiAgICAgIC8vIHNlbmRpbmcga2V5cyB0byBhbGwga25vd24gSFRNTDUgaW5wdXQgY29udHJvbHMKICAgICAgLy8gZm9yIHZhcmlvdXMgYnJvd3NlcnMgKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL3Byb3RyYWN0b3IvaXNzdWVzLzU2MikuCiAgICAgIGZ1bmN0aW9uIHNldElucHV0KHZhbCkgewogICAgICAgIC8vIHNldCB0aGUgdmFsdWUgb2YgdGhlIGVsZW1lbnQgYW5kIGZvcmNlIHZhbGlkYXRpb24uCiAgICAgICAgdmFyIHNjciA9ICJ2YXIgaXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4YW1wbGVJbnB1dCcpOyAiICsKICAgICAgICAiaXB0LnZhbHVlID0gJyIgKyB2YWwgKyAiJzsiICsKICAgICAgICAiYW5ndWxhci5lbGVtZW50KGlwdCkuc2NvcGUoKS4kYXBwbHkoZnVuY3Rpb24ocykgeyBzLm15Rm9ybVtpcHQubmFtZV0uJHNldFZpZXdWYWx1ZSgnIiArIHZhbCArICInKTsgfSk7IjsKICAgICAgICBicm93c2VyLmV4ZWN1dGVTY3JpcHQoc2NyKTsKICAgICAgfQoKICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9Db250YWluKCcxNDo1NzowMCcpOwogICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignbXlGb3JtLmlucHV0LiR2YWxpZCA9IHRydWUnKTsKICAgICAgfSk7CgogICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICBzZXRJbnB1dCgnJyk7CiAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9FcXVhbCgndmFsdWUgPScpOwogICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignbXlGb3JtLmlucHV0LiR2YWxpZCA9IGZhbHNlJyk7CiAgICAgIH0pOwoKICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG92ZXIgbWF4JywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2V0SW5wdXQoJzIzOjU5OjAwJyk7CiAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9Db250YWluKCcnKTsKICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ215Rm9ybS5pbnB1dC4kdmFsaWQgPSBmYWxzZScpOwogICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgJ3RpbWUnOiBjcmVhdGVEYXRlSW5wdXRUeXBlKCd0aW1lJywgVElNRV9SRUdFWFAsCiAgICAgIGNyZWF0ZURhdGVQYXJzZXIoVElNRV9SRUdFWFAsIFsnSEgnLCAnbW0nLCAnc3MnLCAnc3NzJ10pLAogICAgICdISDptbTpzcy5zc3MnKSwKCiAgIC8qKgogICAgKiBAbmdkb2MgaW5wdXQKICAgICogQG5hbWUgaW5wdXRbd2Vla10KICAgICoKICAgICogQGRlc2NyaXB0aW9uCiAgICAqIElucHV0IHdpdGggd2Vlay1vZi10aGUteWVhciB2YWxpZGF0aW9uIGFuZCB0cmFuc2Zvcm1hdGlvbiB0byBEYXRlLiBJbiBicm93c2VycyB0aGF0IGRvIG5vdCB5ZXQgc3VwcG9ydAogICAgKiB0aGUgSFRNTDUgd2VlayBpbnB1dCwgYSB0ZXh0IGVsZW1lbnQgd2lsbCBiZSB1c2VkLiBJbiB0aGF0IGNhc2UsIHRoZSB0ZXh0IG11c3QgYmUgZW50ZXJlZCBpbiBhIHZhbGlkIElTTy04NjAxCiAgICAqIHdlZWsgZm9ybWF0ICh5eXl5LVcjIyksIGZvciBleGFtcGxlOiBgMjAxMy1XMDJgLiBUaGUgbW9kZWwgbXVzdCBhbHdheXMgYmUgYSBEYXRlIG9iamVjdC4KICAgICoKICAgICogVGhlIHRpbWV6b25lIHRvIGJlIHVzZWQgdG8gcmVhZC93cml0ZSB0aGUgYERhdGVgIGluc3RhbmNlIGluIHRoZSBtb2RlbCBjYW4gYmUgZGVmaW5lZCB1c2luZwogICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nTW9kZWxPcHRpb25zIG5nTW9kZWxPcHRpb25zfS4gQnkgZGVmYXVsdCwgdGhpcyBpcyB0aGUgdGltZXpvbmUgb2YgdGhlIGJyb3dzZXIuCiAgICAqCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgKiBAcGFyYW0ge3N0cmluZz19IG1pbiBTZXRzIHRoZSBgbWluYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBsZXNzIHRoYW4gYG1pbmAuIFRoaXMgbXVzdCBiZSBhCiAgICAqIHZhbGlkIElTTyB3ZWVrIGZvcm1hdCAoeXl5eS1XIyMpLgogICAgKiBAcGFyYW0ge3N0cmluZz19IG1heCBTZXRzIHRoZSBgbWF4YCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBncmVhdGVyIHRoYW4gYG1heGAuIFRoaXMgbXVzdCBiZQogICAgKiBhIHZhbGlkIElTTyB3ZWVrIGZvcm1hdCAoeXl5eS1XIyMpLgogICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAqCiAgICAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZSBuYW1lPSJ3ZWVrLWlucHV0LWRpcmVjdGl2ZSIgbW9kdWxlPSJ3ZWVrRXhhbXBsZSI+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPHNjcmlwdD4KICAgICAgYW5ndWxhci5tb2R1bGUoJ3dlZWtFeGFtcGxlJywgW10pCiAgICAgICAgLmNvbnRyb2xsZXIoJ0RhdGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICRzY29wZS52YWx1ZSA9IG5ldyBEYXRlKDIwMTMsIDAsIDMpOwogICAgICAgIH1dKTsKICAgICAgPC9zY3JpcHQ+CiAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iRGF0ZUNvbnRyb2xsZXIgYXMgZGF0ZUN0cmwiPgogICAgICAgIFBpY2sgYSBkYXRlIGJldHdlZW4gaW4gMjAxMzoKICAgICAgICA8aW5wdXQgaWQ9ImV4YW1wbGVJbnB1dCIgdHlwZT0id2VlayIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ2YWx1ZSIKICAgICAgICAgICAgcGxhY2Vob2xkZXI9IllZWVktVyMjIiBtaW49IjIwMTItVzMyIiBtYXg9IjIwMTMtVzUyIiByZXF1aXJlZCAvPgogICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3Iud2VlayI+CiAgICAgICAgICAgIE5vdCBhIHZhbGlkIGRhdGUhPC9zcGFuPgogICAgICAgIDx0dD52YWx1ZSA9IHt7dmFsdWUgfCBkYXRlOiAieXl5eS1Xd3cifX08L3R0Pjxici8+CiAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICA8L2Zvcm0+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgdmFyIHZhbHVlID0gZWxlbWVudChieS5iaW5kaW5nKCd2YWx1ZSB8IGRhdGU6ICJ5eXl5LVd3dyInKSk7CiAgICAgIHZhciB2YWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKTsKICAgICAgdmFyIGlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSk7CgogICAgICAvLyBjdXJyZW50bHkgcHJvdHJhY3Rvci93ZWJkcml2ZXIgZG9lcyBub3Qgc3VwcG9ydAogICAgICAvLyBzZW5kaW5nIGtleXMgdG8gYWxsIGtub3duIEhUTUw1IGlucHV0IGNvbnRyb2xzCiAgICAgIC8vIGZvciB2YXJpb3VzIGJyb3dzZXJzIChodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9wcm90cmFjdG9yL2lzc3Vlcy81NjIpLgogICAgICBmdW5jdGlvbiBzZXRJbnB1dCh2YWwpIHsKICAgICAgICAvLyBzZXQgdGhlIHZhbHVlIG9mIHRoZSBlbGVtZW50IGFuZCBmb3JjZSB2YWxpZGF0aW9uLgogICAgICAgIHZhciBzY3IgPSAidmFyIGlwdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdleGFtcGxlSW5wdXQnKTsgIiArCiAgICAgICAgImlwdC52YWx1ZSA9ICciICsgdmFsICsgIic7IiArCiAgICAgICAgImFuZ3VsYXIuZWxlbWVudChpcHQpLnNjb3BlKCkuJGFwcGx5KGZ1bmN0aW9uKHMpIHsgcy5teUZvcm1baXB0Lm5hbWVdLiRzZXRWaWV3VmFsdWUoJyIgKyB2YWwgKyAiJyk7IH0pOyI7CiAgICAgICAgYnJvd3Nlci5leGVjdXRlU2NyaXB0KHNjcik7CiAgICAgIH0KCiAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvQ29udGFpbignMjAxMy1XMDEnKTsKICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ215Rm9ybS5pbnB1dC4kdmFsaWQgPSB0cnVlJyk7CiAgICAgIH0pOwoKICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2V0SW5wdXQoJycpOwogICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvRXF1YWwoJ3ZhbHVlID0nKTsKICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ215Rm9ybS5pbnB1dC4kdmFsaWQgPSBmYWxzZScpOwogICAgICB9KTsKCiAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBvdmVyIG1heCcsIGZ1bmN0aW9uKCkgewogICAgICAgIHNldElucHV0KCcyMDE1LVcwMScpOwogICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvQ29udGFpbignJyk7CiAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdteUZvcm0uaW5wdXQuJHZhbGlkID0gZmFsc2UnKTsKICAgICAgfSk7CiAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAgICAqLwogICd3ZWVrJzogY3JlYXRlRGF0ZUlucHV0VHlwZSgnd2VlaycsIFdFRUtfUkVHRVhQLCB3ZWVrUGFyc2VyLCAneXl5eS1Xd3cnKSwKCiAgLyoqCiAgICogQG5nZG9jIGlucHV0CiAgICogQG5hbWUgaW5wdXRbbW9udGhdCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBJbnB1dCB3aXRoIG1vbnRoIHZhbGlkYXRpb24gYW5kIHRyYW5zZm9ybWF0aW9uLiBJbiBicm93c2VycyB0aGF0IGRvIG5vdCB5ZXQgc3VwcG9ydAogICAqIHRoZSBIVE1MNSBtb250aCBpbnB1dCwgYSB0ZXh0IGVsZW1lbnQgd2lsbCBiZSB1c2VkLiBJbiB0aGF0IGNhc2UsIHRoZSB0ZXh0IG11c3QgYmUgZW50ZXJlZCBpbiBhIHZhbGlkIElTTy04NjAxCiAgICogbW9udGggZm9ybWF0ICh5eXl5LU1NKSwgZm9yIGV4YW1wbGU6IGAyMDA5LTAxYC4gVGhlIG1vZGVsIG11c3QgYWx3YXlzIGJlIGEgRGF0ZSBvYmplY3QuIEluIHRoZSBldmVudCB0aGUgbW9kZWwgaXMKICAgKiBub3Qgc2V0IHRvIHRoZSBmaXJzdCBvZiB0aGUgbW9udGgsIHRoZSBmaXJzdCBvZiB0aGF0IG1vZGVsJ3MgbW9udGggaXMgYXNzdW1lZC4KICAgKgogICAqIFRoZSB0aW1lem9uZSB0byBiZSB1c2VkIHRvIHJlYWQvd3JpdGUgdGhlIGBEYXRlYCBpbnN0YW5jZSBpbiB0aGUgbW9kZWwgY2FuIGJlIGRlZmluZWQgdXNpbmcKICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nTW9kZWxPcHRpb25zIG5nTW9kZWxPcHRpb25zfS4gQnkgZGVmYXVsdCwgdGhpcyBpcyB0aGUgdGltZXpvbmUgb2YgdGhlIGJyb3dzZXIuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbWluIFNldHMgdGhlIGBtaW5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGxlc3MgdGhhbiBgbWluYC4gVGhpcyBtdXN0IGJlCiAgICogYSB2YWxpZCBJU08gbW9udGggZm9ybWF0ICh5eXl5LU1NKS4KICAgKiBAcGFyYW0ge3N0cmluZz19IG1heCBTZXRzIHRoZSBgbWF4YCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBncmVhdGVyIHRoYW4gYG1heGAuIFRoaXMgbXVzdAogICAqIGJlIGEgdmFsaWQgSVNPIG1vbnRoIGZvcm1hdCAoeXl5eS1NTSkuCiAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG5hbWU9Im1vbnRoLWlucHV0LWRpcmVjdGl2ZSIgbW9kdWxlPSJtb250aEV4YW1wbGUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8c2NyaXB0PgogICAgICBhbmd1bGFyLm1vZHVsZSgnbW9udGhFeGFtcGxlJywgW10pCiAgICAgICAgLmNvbnRyb2xsZXIoJ0RhdGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICRzY29wZS52YWx1ZSA9IG5ldyBEYXRlKDIwMTMsIDksIDEpOwogICAgICAgIH1dKTsKICAgICA8L3NjcmlwdD4KICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkRhdGVDb250cm9sbGVyIGFzIGRhdGVDdHJsIj4KICAgICAgIFBpY2sgYSBtb250aCBpbnQgMjAxMzoKICAgICAgIDxpbnB1dCBpZD0iZXhhbXBsZUlucHV0IiB0eXBlPSJtb250aCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ2YWx1ZSIKICAgICAgICAgIHBsYWNlaG9sZGVyPSJ5eXl5LU1NIiBtaW49IjIwMTMtMDEiIG1heD0iMjAxMy0xMiIgcmVxdWlyZWQgLz4KICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IubW9udGgiPgogICAgICAgICAgTm90IGEgdmFsaWQgbW9udGghPC9zcGFuPgogICAgICAgPHR0PnZhbHVlID0ge3t2YWx1ZSB8IGRhdGU6ICJ5eXl5LU1NIn19PC90dD48YnIvPgogICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgIDwvZm9ybT4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgdmFyIHZhbHVlID0gZWxlbWVudChieS5iaW5kaW5nKCd2YWx1ZSB8IGRhdGU6ICJ5eXl5LU1NIicpKTsKICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKTsKCiAgICAgIC8vIGN1cnJlbnRseSBwcm90cmFjdG9yL3dlYmRyaXZlciBkb2VzIG5vdCBzdXBwb3J0CiAgICAgIC8vIHNlbmRpbmcga2V5cyB0byBhbGwga25vd24gSFRNTDUgaW5wdXQgY29udHJvbHMKICAgICAgLy8gZm9yIHZhcmlvdXMgYnJvd3NlcnMgKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL3Byb3RyYWN0b3IvaXNzdWVzLzU2MikuCiAgICAgIGZ1bmN0aW9uIHNldElucHV0KHZhbCkgewogICAgICAgIC8vIHNldCB0aGUgdmFsdWUgb2YgdGhlIGVsZW1lbnQgYW5kIGZvcmNlIHZhbGlkYXRpb24uCiAgICAgICAgdmFyIHNjciA9ICJ2YXIgaXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4YW1wbGVJbnB1dCcpOyAiICsKICAgICAgICAiaXB0LnZhbHVlID0gJyIgKyB2YWwgKyAiJzsiICsKICAgICAgICAiYW5ndWxhci5lbGVtZW50KGlwdCkuc2NvcGUoKS4kYXBwbHkoZnVuY3Rpb24ocykgeyBzLm15Rm9ybVtpcHQubmFtZV0uJHNldFZpZXdWYWx1ZSgnIiArIHZhbCArICInKTsgfSk7IjsKICAgICAgICBicm93c2VyLmV4ZWN1dGVTY3JpcHQoc2NyKTsKICAgICAgfQoKICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9Db250YWluKCcyMDEzLTEwJyk7CiAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdteUZvcm0uaW5wdXQuJHZhbGlkID0gdHJ1ZScpOwogICAgICB9KTsKCiAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgIHNldElucHV0KCcnKTsKICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0VxdWFsKCd2YWx1ZSA9Jyk7CiAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdteUZvcm0uaW5wdXQuJHZhbGlkID0gZmFsc2UnKTsKICAgICAgfSk7CgogICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgb3ZlciBtYXgnLCBmdW5jdGlvbigpIHsKICAgICAgICBzZXRJbnB1dCgnMjAxNS0wMScpOwogICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvQ29udGFpbignJyk7CiAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdteUZvcm0uaW5wdXQuJHZhbGlkID0gZmFsc2UnKTsKICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogICdtb250aCc6IGNyZWF0ZURhdGVJbnB1dFR5cGUoJ21vbnRoJywgTU9OVEhfUkVHRVhQLAogICAgIGNyZWF0ZURhdGVQYXJzZXIoTU9OVEhfUkVHRVhQLCBbJ3l5eXknLCAnTU0nXSksCiAgICAgJ3l5eXktTU0nKSwKCiAgLyoqCiAgICogQG5nZG9jIGlucHV0CiAgICogQG5hbWUgaW5wdXRbbnVtYmVyXQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGV4dCBpbnB1dCB3aXRoIG51bWJlciB2YWxpZGF0aW9uIGFuZCB0cmFuc2Zvcm1hdGlvbi4gU2V0cyB0aGUgYG51bWJlcmAgdmFsaWRhdGlvbgogICAqIGVycm9yIGlmIG5vdCBhIHZhbGlkIG51bWJlci4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBtaW4gU2V0cyB0aGUgYG1pbmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGVudGVyZWQgaXMgbGVzcyB0aGFuIGBtaW5gLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbWF4IFNldHMgdGhlIGBtYXhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGdyZWF0ZXIgdGhhbiBgbWF4YC4KICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAqICAgIG1pbmxlbmd0aC4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICogICAgbWF4bGVuZ3RoLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAqCiAgICogQGV4YW1wbGUKICAgICAgPGV4YW1wbGUgbmFtZT0ibnVtYmVyLWlucHV0LWRpcmVjdGl2ZSIgbW9kdWxlPSJudW1iZXJFeGFtcGxlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICBhbmd1bGFyLm1vZHVsZSgnbnVtYmVyRXhhbXBsZScsIFtdKQogICAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLnZhbHVlID0gMTI7CiAgICAgICAgICAgICB9XSk7CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgICBOdW1iZXI6IDxpbnB1dCB0eXBlPSJudW1iZXIiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idmFsdWUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgbWluPSIwIiBtYXg9Ijk5IiByZXF1aXJlZD4KICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5udW1iZXIiPgogICAgICAgICAgICAgTm90IHZhbGlkIG51bWJlciE8L3NwYW4+CiAgICAgICAgICAgPHR0PnZhbHVlID0ge3t2YWx1ZX19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICAgICAgIDwvZm9ybT4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgICB2YXIgdmFsdWUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3ZhbHVlJykpOwogICAgICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgICAgICAgdmFyIGlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvQ29udGFpbignMTInKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJycpOwogICAgICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0VxdWFsKCd2YWx1ZSA9Jyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBvdmVyIG1heCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygnMTIzJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvRXF1YWwoJ3ZhbHVlID0nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgICovCiAgJ251bWJlcic6IG51bWJlcklucHV0VHlwZSwKCgogIC8qKgogICAqIEBuZ2RvYyBpbnB1dAogICAqIEBuYW1lIGlucHV0W3VybF0KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRleHQgaW5wdXQgd2l0aCBVUkwgdmFsaWRhdGlvbi4gU2V0cyB0aGUgYHVybGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIGNvbnRlbnQgaXMgbm90IGEKICAgKiB2YWxpZCBVUkwuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICogICAgbWlubGVuZ3RoLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgKiAgICBtYXhsZW5ndGguCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICoKICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBuYW1lPSJ1cmwtaW5wdXQtZGlyZWN0aXZlIiBtb2R1bGU9InVybEV4YW1wbGUiPgogICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICA8c2NyaXB0PgogICAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCd1cmxFeGFtcGxlJywgW10pCiAgICAgICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdodHRwOi8vZ29vZ2xlLmNvbSc7CiAgICAgICAgICAgICB9XSk7CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgICBVUkw6IDxpbnB1dCB0eXBlPSJ1cmwiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idGV4dCIgcmVxdWlyZWQ+CiAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IudXJsIj4KICAgICAgICAgICAgIE5vdCB2YWxpZCB1cmwhPC9zcGFuPgogICAgICAgICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnVybCA9IHt7ISFteUZvcm0uJGVycm9yLnVybH19PC90dD48YnIvPgogICAgICAgICAgPC9mb3JtPgogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICAgIHZhciB0ZXh0ID0gZWxlbWVudChieS5iaW5kaW5nKCd0ZXh0JykpOwogICAgICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgICAgICAgdmFyIGlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndGV4dCcpKTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2h0dHA6Ly9nb29nbGUuY29tJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0LmNsZWFyKCk7CiAgICAgICAgICAgIGlucHV0LnNlbmRLZXlzKCcnKTsKCiAgICAgICAgICAgIGV4cGVjdCh0ZXh0LmdldFRleHQoKSkudG9FcXVhbCgndGV4dCA9Jyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBub3QgdXJsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0LmNsZWFyKCk7CiAgICAgICAgICAgIGlucHV0LnNlbmRLZXlzKCdib3gnKTsKCiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgIDwvZmlsZT4KICAgICAgPC9leGFtcGxlPgogICAqLwogICd1cmwnOiB1cmxJbnB1dFR5cGUsCgoKICAvKioKICAgKiBAbmdkb2MgaW5wdXQKICAgKiBAbmFtZSBpbnB1dFtlbWFpbF0KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRleHQgaW5wdXQgd2l0aCBlbWFpbCB2YWxpZGF0aW9uLiBTZXRzIHRoZSBgZW1haWxgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIG5vdCBhIHZhbGlkIGVtYWlsCiAgICogYWRkcmVzcy4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgKiAgICBtaW5sZW5ndGguCiAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAqICAgIG1heGxlbmd0aC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgKgogICAqIEBleGFtcGxlCiAgICAgIDxleGFtcGxlIG5hbWU9ImVtYWlsLWlucHV0LWRpcmVjdGl2ZSIgbW9kdWxlPSJlbWFpbEV4YW1wbGUiPgogICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICA8c2NyaXB0PgogICAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCdlbWFpbEV4YW1wbGUnLCBbXSkKICAgICAgICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ21lQGV4YW1wbGUuY29tJzsKICAgICAgICAgICAgIH1dKTsKICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICAgICAgICBFbWFpbDogPGlucHV0IHR5cGU9ImVtYWlsIiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiIHJlcXVpcmVkPgogICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLmVtYWlsIj4KICAgICAgICAgICAgICAgTm90IHZhbGlkIGVtYWlsITwvc3Bhbj4KICAgICAgICAgICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5lbWFpbCA9IHt7ISFteUZvcm0uJGVycm9yLmVtYWlsfX08L3R0Pjxici8+CiAgICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgICB2YXIgdGV4dCA9IGVsZW1lbnQoYnkuYmluZGluZygndGV4dCcpKTsKICAgICAgICAgIHZhciB2YWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKTsKICAgICAgICAgIHZhciBpbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3RleHQnKSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdCh0ZXh0LmdldFRleHQoKSkudG9Db250YWluKCdtZUBleGFtcGxlLmNvbScpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygnJyk7CiAgICAgICAgICAgIGV4cGVjdCh0ZXh0LmdldFRleHQoKSkudG9FcXVhbCgndGV4dCA9Jyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBub3QgZW1haWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJ3h4eCcpOwoKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgICovCiAgJ2VtYWlsJzogZW1haWxJbnB1dFR5cGUsCgoKICAvKioKICAgKiBAbmdkb2MgaW5wdXQKICAgKiBAbmFtZSBpbnB1dFtyYWRpb10KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEhUTUwgcmFkaW8gYnV0dG9uLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIHNlbGVjdGVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAqIEBwYXJhbSB7c3RyaW5nfSBuZ1ZhbHVlIEFuZ3VsYXIgZXhwcmVzc2lvbiB3aGljaCBzZXRzIHRoZSB2YWx1ZSB0byB3aGljaCB0aGUgZXhwcmVzc2lvbiBzaG91bGQKICAgKiAgICBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgKgogICAqIEBleGFtcGxlCiAgICAgIDxleGFtcGxlIG5hbWU9InJhZGlvLWlucHV0LWRpcmVjdGl2ZSIgbW9kdWxlPSJyYWRpb0V4YW1wbGUiPgogICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICA8c2NyaXB0PgogICAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCdyYWRpb0V4YW1wbGUnLCBbXSkKICAgICAgICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAgICAgICRzY29wZS5jb2xvciA9ICdibHVlJzsKICAgICAgICAgICAgICAgJHNjb3BlLnNwZWNpYWxWYWx1ZSA9IHsKICAgICAgICAgICAgICAgICAiaWQiOiAiMTIzNDUiLAogICAgICAgICAgICAgICAgICJ2YWx1ZSI6ICJncmVlbiIKICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgIH1dKTsKICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiB2YWx1ZT0icmVkIj4gIFJlZCA8YnIvPgogICAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiBuZy12YWx1ZT0ic3BlY2lhbFZhbHVlIj4gR3JlZW4gPGJyLz4KICAgICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJjb2xvciIgdmFsdWU9ImJsdWUiPiBCbHVlIDxici8+CiAgICAgICAgICAgPHR0PmNvbG9yID0ge3tjb2xvciB8IGpzb259fTwvdHQ+PGJyLz4KICAgICAgICAgIDwvZm9ybT4KICAgICAgICAgIE5vdGUgdGhhdCBgbmctdmFsdWU9InNwZWNpYWxWYWx1ZSJgIHNldHMgcmFkaW8gaXRlbSdzIHZhbHVlIHRvIGJlIHRoZSB2YWx1ZSBvZiBgJHNjb3BlLnNwZWNpYWxWYWx1ZWAuCiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2Ugc3RhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGNvbG9yID0gZWxlbWVudChieS5iaW5kaW5nKCdjb2xvcicpKTsKCiAgICAgICAgICAgIGV4cGVjdChjb2xvci5nZXRUZXh0KCkpLnRvQ29udGFpbignYmx1ZScpOwoKICAgICAgICAgICAgZWxlbWVudC5hbGwoYnkubW9kZWwoJ2NvbG9yJykpLmdldCgwKS5jbGljaygpOwoKICAgICAgICAgICAgZXhwZWN0KGNvbG9yLmdldFRleHQoKSkudG9Db250YWluKCdyZWQnKTsKICAgICAgICAgIH0pOwogICAgICAgIDwvZmlsZT4KICAgICAgPC9leGFtcGxlPgogICAqLwogICdyYWRpbyc6IHJhZGlvSW5wdXRUeXBlLAoKCiAgLyoqCiAgICogQG5nZG9jIGlucHV0CiAgICogQG5hbWUgaW5wdXRbY2hlY2tib3hdCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBIVE1MIGNoZWNrYm94LgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgKiBAcGFyYW0ge2V4cHJlc3Npb249fSBuZ1RydWVWYWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIHNlbGVjdGVkLgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG5nRmFsc2VWYWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIG5vdCBzZWxlY3RlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAqCiAgICogQGV4YW1wbGUKICAgICAgPGV4YW1wbGUgbmFtZT0iY2hlY2tib3gtaW5wdXQtZGlyZWN0aXZlIiBtb2R1bGU9ImNoZWNrYm94RXhhbXBsZSI+CiAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ2NoZWNrYm94RXhhbXBsZScsIFtdKQogICAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLnZhbHVlMSA9IHRydWU7CiAgICAgICAgICAgICAgICRzY29wZS52YWx1ZTIgPSAnWUVTJwogICAgICAgICAgICAgfV0pOwogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICAgICAgVmFsdWUxOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJ2YWx1ZTEiPiA8YnIvPgogICAgICAgICAgIFZhbHVlMjogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0idmFsdWUyIgogICAgICAgICAgICAgICAgICAgICAgICAgIG5nLXRydWUtdmFsdWU9IidZRVMnIiBuZy1mYWxzZS12YWx1ZT0iJ05PJyI+IDxici8+CiAgICAgICAgICAgPHR0PnZhbHVlMSA9IHt7dmFsdWUxfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0PnZhbHVlMiA9IHt7dmFsdWUyfX08L3R0Pjxici8+CiAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2Ugc3RhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlMSA9IGVsZW1lbnQoYnkuYmluZGluZygndmFsdWUxJykpOwogICAgICAgICAgICB2YXIgdmFsdWUyID0gZWxlbWVudChieS5iaW5kaW5nKCd2YWx1ZTInKSk7CgogICAgICAgICAgICBleHBlY3QodmFsdWUxLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZTIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ1lFUycpOwoKICAgICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsdWUxJykpLmNsaWNrKCk7CiAgICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlMicpKS5jbGljaygpOwoKICAgICAgICAgICAgZXhwZWN0KHZhbHVlMS5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgICAgZXhwZWN0KHZhbHVlMi5nZXRUZXh0KCkpLnRvQ29udGFpbignTk8nKTsKICAgICAgICAgIH0pOwogICAgICAgIDwvZmlsZT4KICAgICAgPC9leGFtcGxlPgogICAqLwogICdjaGVja2JveCc6IGNoZWNrYm94SW5wdXRUeXBlLAoKICAnaGlkZGVuJzogbm9vcCwKICAnYnV0dG9uJzogbm9vcCwKICAnc3VibWl0Jzogbm9vcCwKICAncmVzZXQnOiBub29wLAogICdmaWxlJzogbm9vcAp9OwoKZnVuY3Rpb24gdGVzdEZsYWdzKHZhbGlkaXR5LCBmbGFncykgewogIHZhciBpLCBmbGFnOwogIGlmIChmbGFncykgewogICAgZm9yIChpPTA7IGk8ZmxhZ3MubGVuZ3RoOyArK2kpIHsKICAgICAgZmxhZyA9IGZsYWdzW2ldOwogICAgICBpZiAodmFsaWRpdHlbZmxhZ10pIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIHN0cmluZ0Jhc2VkSW5wdXRUeXBlKGN0cmwpIHsKICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiBjdHJsLiRpc0VtcHR5KHZhbHVlKSA/IHZhbHVlIDogdmFsdWUudG9TdHJpbmcoKTsKICB9KTsKfQoKZnVuY3Rpb24gdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgYmFzZUlucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKICBzdHJpbmdCYXNlZElucHV0VHlwZShjdHJsKTsKfQoKZnVuY3Rpb24gYmFzZUlucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgdmFyIHZhbGlkaXR5ID0gZWxlbWVudC5wcm9wKFZBTElESVRZX1NUQVRFX1BST1BFUlRZKTsKICB2YXIgcGxhY2Vob2xkZXIgPSBlbGVtZW50WzBdLnBsYWNlaG9sZGVyLCBub2V2ZW50ID0ge307CiAgdmFyIHR5cGUgPSBsb3dlcmNhc2UoZWxlbWVudFswXS50eXBlKTsKCiAgLy8gSW4gY29tcG9zaXRpb24gbW9kZSwgdXNlcnMgYXJlIHN0aWxsIGlucHV0aW5nIGludGVybWVkaWF0ZSB0ZXh0IGJ1ZmZlciwKICAvLyBob2xkIHRoZSBsaXN0ZW5lciB1bnRpbCBjb21wb3NpdGlvbiBpcyBkb25lLgogIC8vIE1vcmUgYWJvdXQgY29tcG9zaXRpb24gZXZlbnRzOiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvQ29tcG9zaXRpb25FdmVudAogIGlmICghJHNuaWZmZXIuYW5kcm9pZCkgewogICAgdmFyIGNvbXBvc2luZyA9IGZhbHNlOwoKICAgIGVsZW1lbnQub24oJ2NvbXBvc2l0aW9uc3RhcnQnLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgIGNvbXBvc2luZyA9IHRydWU7CiAgICB9KTsKCiAgICBlbGVtZW50Lm9uKCdjb21wb3NpdGlvbmVuZCcsIGZ1bmN0aW9uKCkgewogICAgICBjb21wb3NpbmcgPSBmYWxzZTsKICAgICAgbGlzdGVuZXIoKTsKICAgIH0pOwogIH0KCiAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24oZXYpIHsKICAgIGlmIChjb21wb3NpbmcpIHJldHVybjsKICAgIHZhciB2YWx1ZSA9IGVsZW1lbnQudmFsKCksCiAgICAgICAgZXZlbnQgPSBldiAmJiBldi50eXBlOwoKICAgIC8vIElFICgxMSBhbmQgdW5kZXIpIHNlZW0gdG8gZW1pdCBhbiAnaW5wdXQnIGV2ZW50IGlmIHRoZSBwbGFjZWhvbGRlciB2YWx1ZSBjaGFuZ2VzLgogICAgLy8gV2UgZG9uJ3Qgd2FudCB0byBkaXJ0eSB0aGUgdmFsdWUgd2hlbiB0aGlzIGhhcHBlbnMsIHNvIHdlIGFib3J0IGhlcmUuIFVuZm9ydHVuYXRlbHksCiAgICAvLyBJRSBhbHNvIHNlbmRzIGlucHV0IGV2ZW50cyBmb3Igb3RoZXIgbm9uLWlucHV0LXJlbGF0ZWQgdGhpbmdzLCAoc3VjaCBhcyBmb2N1c2luZyBvbiBhCiAgICAvLyBmb3JtIGNvbnRyb2wpLCBzbyB0aGlzIGNoYW5nZSBpcyBub3QgZW50aXJlbHkgZW5vdWdoIHRvIHNvbHZlIHRoaXMuCiAgICBpZiAobXNpZSAmJiAoZXYgfHwgbm9ldmVudCkudHlwZSA9PT0gJ2lucHV0JyAmJiBlbGVtZW50WzBdLnBsYWNlaG9sZGVyICE9PSBwbGFjZWhvbGRlcikgewogICAgICBwbGFjZWhvbGRlciA9IGVsZW1lbnRbMF0ucGxhY2Vob2xkZXI7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBCeSBkZWZhdWx0IHdlIHdpbGwgdHJpbSB0aGUgdmFsdWUKICAgIC8vIElmIHRoZSBhdHRyaWJ1dGUgbmctdHJpbSBleGlzdHMgd2Ugd2lsbCBhdm9pZCB0cmltbWluZwogICAgLy8gSWYgaW5wdXQgdHlwZSBpcyAncGFzc3dvcmQnLCB0aGUgdmFsdWUgaXMgbmV2ZXIgdHJpbW1lZAogICAgaWYgKHR5cGUgIT09ICdwYXNzd29yZCcgJiYgKCFhdHRyLm5nVHJpbSB8fCBhdHRyLm5nVHJpbSAhPT0gJ2ZhbHNlJykpIHsKICAgICAgdmFsdWUgPSB0cmltKHZhbHVlKTsKICAgIH0KCiAgICAvLyBJZiBhIGNvbnRyb2wgaXMgc3VmZmVyaW5nIGZyb20gYmFkIGlucHV0IChkdWUgdG8gbmF0aXZlIHZhbGlkYXRvcnMpLCBicm93c2VycyBkaXNjYXJkIGl0cwogICAgLy8gdmFsdWUsIHNvIGl0IG1heSBiZSBuZWNlc3NhcnkgdG8gcmV2YWxpZGF0ZSAoYnkgY2FsbGluZyAkc2V0Vmlld1ZhbHVlIGFnYWluKSBldmVuIGlmIHRoZQogICAgLy8gY29udHJvbCdzIHZhbHVlIGlzIHRoZSBzYW1lIGVtcHR5IHZhbHVlIHR3aWNlIGluIGEgcm93LgogICAgaWYgKGN0cmwuJHZpZXdWYWx1ZSAhPT0gdmFsdWUgfHwgKHZhbHVlID09PSAnJyAmJiBjdHJsLiQkaGFzTmF0aXZlVmFsaWRhdG9ycykpIHsKICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlLCBldmVudCk7CiAgICB9CiAgfTsKCiAgLy8gaWYgdGhlIGJyb3dzZXIgZG9lcyBzdXBwb3J0ICJpbnB1dCIgZXZlbnQsIHdlIGFyZSBmaW5lIC0gZXhjZXB0IG9uIElFOSB3aGljaCBkb2Vzbid0IGZpcmUgdGhlCiAgLy8gaW5wdXQgZXZlbnQgb24gYmFja3NwYWNlLCBkZWxldGUgb3IgY3V0CiAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdpbnB1dCcpKSB7CiAgICBlbGVtZW50Lm9uKCdpbnB1dCcsIGxpc3RlbmVyKTsKICB9IGVsc2UgewogICAgdmFyIHRpbWVvdXQ7CgogICAgdmFyIGRlZmVyTGlzdGVuZXIgPSBmdW5jdGlvbihldikgewogICAgICBpZiAoIXRpbWVvdXQpIHsKICAgICAgICB0aW1lb3V0ID0gJGJyb3dzZXIuZGVmZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICBsaXN0ZW5lcihldik7CiAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICBlbGVtZW50Lm9uKCdrZXlkb3duJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgdmFyIGtleSA9IGV2ZW50LmtleUNvZGU7CgogICAgICAvLyBpZ25vcmUKICAgICAgLy8gICAgY29tbWFuZCAgICAgICAgICAgIG1vZGlmaWVycyAgICAgICAgICAgICAgICAgICBhcnJvd3MKICAgICAgaWYgKGtleSA9PT0gOTEgfHwgKDE1IDwga2V5ICYmIGtleSA8IDE5KSB8fCAoMzcgPD0ga2V5ICYmIGtleSA8PSA0MCkpIHJldHVybjsKCiAgICAgIGRlZmVyTGlzdGVuZXIoZXZlbnQpOwogICAgfSk7CgogICAgLy8gaWYgdXNlciBtb2RpZmllcyBpbnB1dCB2YWx1ZSB1c2luZyBjb250ZXh0IG1lbnUgaW4gSUUsIHdlIG5lZWQgInBhc3RlIiBhbmQgImN1dCIgZXZlbnRzIHRvIGNhdGNoIGl0CiAgICBpZiAoJHNuaWZmZXIuaGFzRXZlbnQoJ3Bhc3RlJykpIHsKICAgICAgZWxlbWVudC5vbigncGFzdGUgY3V0JywgZGVmZXJMaXN0ZW5lcik7CiAgICB9CiAgfQoKICAvLyBpZiB1c2VyIHBhc3RlIGludG8gaW5wdXQgdXNpbmcgbW91c2Ugb24gb2xkZXIgYnJvd3NlcgogIC8vIG9yIGZvcm0gYXV0b2NvbXBsZXRlIG9uIG5ld2VyIGJyb3dzZXIsIHdlIG5lZWQgImNoYW5nZSIgZXZlbnQgdG8gY2F0Y2ggaXQKICBlbGVtZW50Lm9uKCdjaGFuZ2UnLCBsaXN0ZW5lcik7CgogIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgZWxlbWVudC52YWwoY3RybC4kaXNFbXB0eShjdHJsLiRtb2RlbFZhbHVlKSA/ICcnIDogY3RybC4kdmlld1ZhbHVlKTsKICB9Owp9CgpmdW5jdGlvbiB3ZWVrUGFyc2VyKGlzb1dlZWssIGV4aXN0aW5nRGF0ZSkgewogIGlmIChpc0RhdGUoaXNvV2VlaykpIHsKICAgIHJldHVybiBpc29XZWVrOwogIH0KCiAgaWYgKGlzU3RyaW5nKGlzb1dlZWspKSB7CiAgICBXRUVLX1JFR0VYUC5sYXN0SW5kZXggPSAwOwogICAgdmFyIHBhcnRzID0gV0VFS19SRUdFWFAuZXhlYyhpc29XZWVrKTsKICAgIGlmIChwYXJ0cykgewogICAgICB2YXIgeWVhciA9ICtwYXJ0c1sxXSwKICAgICAgICAgIHdlZWsgPSArcGFydHNbMl0sCiAgICAgICAgICBob3VycyA9IDAsCiAgICAgICAgICBtaW51dGVzID0gMCwKICAgICAgICAgIHNlY29uZHMgPSAwLAogICAgICAgICAgbWlsbGlzZWNvbmRzID0gMCwKICAgICAgICAgIGZpcnN0VGh1cnMgPSBnZXRGaXJzdFRodXJzZGF5T2ZZZWFyKHllYXIpLAogICAgICAgICAgYWRkRGF5cyA9ICh3ZWVrIC0gMSkgKiA3OwoKICAgICAgaWYgKGV4aXN0aW5nRGF0ZSkgewogICAgICAgIGhvdXJzID0gZXhpc3RpbmdEYXRlLmdldEhvdXJzKCk7CiAgICAgICAgbWludXRlcyA9IGV4aXN0aW5nRGF0ZS5nZXRNaW51dGVzKCk7CiAgICAgICAgc2Vjb25kcyA9IGV4aXN0aW5nRGF0ZS5nZXRTZWNvbmRzKCk7CiAgICAgICAgbWlsbGlzZWNvbmRzID0gZXhpc3RpbmdEYXRlLmdldE1pbGxpc2Vjb25kcygpOwogICAgICB9CgogICAgICByZXR1cm4gbmV3IERhdGUoeWVhciwgMCwgZmlyc3RUaHVycy5nZXREYXRlKCkgKyBhZGREYXlzLCBob3VycywgbWludXRlcywgc2Vjb25kcywgbWlsbGlzZWNvbmRzKTsKICAgIH0KICB9CgogIHJldHVybiBOYU47Cn0KCmZ1bmN0aW9uIGNyZWF0ZURhdGVQYXJzZXIocmVnZXhwLCBtYXBwaW5nKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGlzbywgZGF0ZSkgewogICAgdmFyIHBhcnRzLCBtYXA7CgogICAgaWYgKGlzRGF0ZShpc28pKSB7CiAgICAgIHJldHVybiBpc287CiAgICB9CgogICAgaWYgKGlzU3RyaW5nKGlzbykpIHsKICAgICAgLy8gV2hlbiBhIGRhdGUgaXMgSlNPTidpZmllZCB0byB3cmFwcyBpdHNlbGYgaW5zaWRlIG9mIGFuIGV4dHJhCiAgICAgIC8vIHNldCBvZiBkb3VibGUgcXVvdGVzLiBUaGlzIG1ha2VzIHRoZSBkYXRlIHBhcnNpbmcgY29kZSB1bmFibGUKICAgICAgLy8gdG8gbWF0Y2ggdGhlIGRhdGUgc3RyaW5nIGFuZCBwYXJzZSBpdCBhcyBhIGRhdGUuCiAgICAgIGlmIChpc28uY2hhckF0KDApID09ICciJyAmJiBpc28uY2hhckF0KGlzby5sZW5ndGgtMSkgPT0gJyInKSB7CiAgICAgICAgaXNvID0gaXNvLnN1YnN0cmluZygxLCBpc28ubGVuZ3RoLTEpOwogICAgICB9CiAgICAgIGlmIChJU09fREFURV9SRUdFWFAudGVzdChpc28pKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGlzbyk7CiAgICAgIH0KICAgICAgcmVnZXhwLmxhc3RJbmRleCA9IDA7CiAgICAgIHBhcnRzID0gcmVnZXhwLmV4ZWMoaXNvKTsKCiAgICAgIGlmIChwYXJ0cykgewogICAgICAgIHBhcnRzLnNoaWZ0KCk7CiAgICAgICAgaWYgKGRhdGUpIHsKICAgICAgICAgIG1hcCA9IHsKICAgICAgICAgICAgeXl5eTogZGF0ZS5nZXRGdWxsWWVhcigpLAogICAgICAgICAgICBNTTogZGF0ZS5nZXRNb250aCgpICsgMSwKICAgICAgICAgICAgZGQ6IGRhdGUuZ2V0RGF0ZSgpLAogICAgICAgICAgICBISDogZGF0ZS5nZXRIb3VycygpLAogICAgICAgICAgICBtbTogZGF0ZS5nZXRNaW51dGVzKCksCiAgICAgICAgICAgIHNzOiBkYXRlLmdldFNlY29uZHMoKSwKICAgICAgICAgICAgc3NzOiBkYXRlLmdldE1pbGxpc2Vjb25kcygpIC8gMTAwMAogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWFwID0geyB5eXl5OiAxOTcwLCBNTTogMSwgZGQ6IDEsIEhIOiAwLCBtbTogMCwgc3M6IDAsIHNzczogMCB9OwogICAgICAgIH0KCiAgICAgICAgZm9yRWFjaChwYXJ0cywgZnVuY3Rpb24ocGFydCwgaW5kZXgpIHsKICAgICAgICAgIGlmIChpbmRleCA8IG1hcHBpbmcubGVuZ3RoKSB7CiAgICAgICAgICAgIG1hcFttYXBwaW5nW2luZGV4XV0gPSArcGFydDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbmV3IERhdGUobWFwLnl5eXksIG1hcC5NTSAtIDEsIG1hcC5kZCwgbWFwLkhILCBtYXAubW0sIG1hcC5zcyB8fCAwLCBtYXAuc3NzICogMTAwMCB8fCAwKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBOYU47CiAgfTsKfQoKZnVuY3Rpb24gY3JlYXRlRGF0ZUlucHV0VHlwZSh0eXBlLCByZWdleHAsIHBhcnNlRGF0ZSwgZm9ybWF0KSB7CiAgcmV0dXJuIGZ1bmN0aW9uIGR5bmFtaWNEYXRlSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIsICRmaWx0ZXIpIHsKICAgIGJhZElucHV0Q2hlY2tlcihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCk7CiAgICBiYXNlSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwogICAgdmFyIHRpbWV6b25lID0gY3RybCAmJiBjdHJsLiRvcHRpb25zICYmIGN0cmwuJG9wdGlvbnMudGltZXpvbmU7CiAgICB2YXIgcHJldmlvdXNEYXRlOwoKICAgIGN0cmwuJCRwYXJzZXJOYW1lID0gdHlwZTsKICAgIGN0cmwuJHBhcnNlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoY3RybC4kaXNFbXB0eSh2YWx1ZSkpIHJldHVybiBudWxsOwogICAgICBpZiAocmVnZXhwLnRlc3QodmFsdWUpKSB7CiAgICAgICAgLy8gTm90ZTogV2UgY2Fubm90IHJlYWQgY3RybC4kbW9kZWxWYWx1ZSwgYXMgdGhlcmUgbWlnaHQgYmUgYSBkaWZmZXJlbnQKICAgICAgICAvLyBwYXJzZXIvZm9ybWF0dGVyIGluIHRoZSBwcm9jZXNzaW5nIGNoYWluIHNvIHRoYXQgdGhlIG1vZGVsCiAgICAgICAgLy8gY29udGFpbnMgc29tZSBkaWZmZXJlbnQgZGF0YSBmb3JtYXQhCiAgICAgICAgdmFyIHBhcnNlZERhdGUgPSBwYXJzZURhdGUodmFsdWUsIHByZXZpb3VzRGF0ZSk7CiAgICAgICAgaWYgKHRpbWV6b25lID09PSAnVVRDJykgewogICAgICAgICAgcGFyc2VkRGF0ZS5zZXRNaW51dGVzKHBhcnNlZERhdGUuZ2V0TWludXRlcygpIC0gcGFyc2VkRGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhcnNlZERhdGU7CiAgICAgIH0KICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0pOwoKICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoIWN0cmwuJGlzRW1wdHkodmFsdWUpKSB7CiAgICAgICAgaWYgKCFpc0RhdGUodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyAkbmdNb2RlbE1pbkVycignZGF0ZWZtdCcsICdFeHBlY3RlZCBgezB9YCB0byBiZSBhIGRhdGUnLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHByZXZpb3VzRGF0ZSA9IHZhbHVlOwogICAgICAgIGlmIChwcmV2aW91c0RhdGUgJiYgdGltZXpvbmUgPT09ICdVVEMnKSB7CiAgICAgICAgICB2YXIgdGltZXpvbmVPZmZzZXQgPSA2MDAwMCAqIHByZXZpb3VzRGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpOwogICAgICAgICAgcHJldmlvdXNEYXRlID0gbmV3IERhdGUocHJldmlvdXNEYXRlLmdldFRpbWUoKSArIHRpbWV6b25lT2Zmc2V0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICRmaWx0ZXIoJ2RhdGUnKSh2YWx1ZSwgZm9ybWF0LCB0aW1lem9uZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHJldmlvdXNEYXRlID0gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gJyc7CiAgICB9KTsKCiAgICBpZiAoaXNEZWZpbmVkKGF0dHIubWluKSB8fCBhdHRyLm5nTWluKSB7CiAgICAgIHZhciBtaW5WYWw7CiAgICAgIGN0cmwuJHZhbGlkYXRvcnMubWluID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgaXNVbmRlZmluZWQobWluVmFsKSB8fCBwYXJzZURhdGUodmFsdWUpID49IG1pblZhbDsKICAgICAgfTsKICAgICAgYXR0ci4kb2JzZXJ2ZSgnbWluJywgZnVuY3Rpb24odmFsKSB7CiAgICAgICAgbWluVmFsID0gcGFyc2VPYnNlcnZlZERhdGVWYWx1ZSh2YWwpOwogICAgICAgIGN0cmwuJHZhbGlkYXRlKCk7CiAgICAgIH0pOwogICAgfQoKICAgIGlmIChpc0RlZmluZWQoYXR0ci5tYXgpIHx8IGF0dHIubmdNYXgpIHsKICAgICAgdmFyIG1heFZhbDsKICAgICAgY3RybC4kdmFsaWRhdG9ycy5tYXggPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBjdHJsLiRpc0VtcHR5KHZhbHVlKSB8fCBpc1VuZGVmaW5lZChtYXhWYWwpIHx8IHBhcnNlRGF0ZSh2YWx1ZSkgPD0gbWF4VmFsOwogICAgICB9OwogICAgICBhdHRyLiRvYnNlcnZlKCdtYXgnLCBmdW5jdGlvbih2YWwpIHsKICAgICAgICBtYXhWYWwgPSBwYXJzZU9ic2VydmVkRGF0ZVZhbHVlKHZhbCk7CiAgICAgICAgY3RybC4kdmFsaWRhdGUoKTsKICAgICAgfSk7CiAgICB9CiAgICAvLyBPdmVycmlkZSB0aGUgc3RhbmRhcmQgJGlzRW1wdHkgdG8gZGV0ZWN0IGludmFsaWQgZGF0ZXMgYXMgd2VsbAogICAgY3RybC4kaXNFbXB0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIC8vIEludmFsaWQgRGF0ZTogZ2V0VGltZSgpIHJldHVybnMgTmFOCiAgICAgIHJldHVybiAhdmFsdWUgfHwgKHZhbHVlLmdldFRpbWUgJiYgdmFsdWUuZ2V0VGltZSgpICE9PSB2YWx1ZS5nZXRUaW1lKCkpOwogICAgfTsKCiAgICBmdW5jdGlvbiBwYXJzZU9ic2VydmVkRGF0ZVZhbHVlKHZhbCkgewogICAgICByZXR1cm4gaXNEZWZpbmVkKHZhbCkgPyAoaXNEYXRlKHZhbCkgPyB2YWwgOiBwYXJzZURhdGUodmFsKSkgOiB1bmRlZmluZWQ7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gYmFkSW5wdXRDaGVja2VyKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgdmFyIG5vZGUgPSBlbGVtZW50WzBdOwogIHZhciBuYXRpdmVWYWxpZGF0aW9uID0gY3RybC4kJGhhc05hdGl2ZVZhbGlkYXRvcnMgPSBpc09iamVjdChub2RlLnZhbGlkaXR5KTsKICBpZiAobmF0aXZlVmFsaWRhdGlvbikgewogICAgY3RybC4kcGFyc2Vycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciB2YWxpZGl0eSA9IGVsZW1lbnQucHJvcChWQUxJRElUWV9TVEFURV9QUk9QRVJUWSkgfHwge307CiAgICAgIC8vIERldGVjdCBidWcgaW4gRkYzNSBmb3IgaW5wdXRbZW1haWxdIChodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD0xMDY0NDMwKToKICAgICAgLy8gLSBhbHNvIHNldHMgdmFsaWRpdHkuYmFkSW5wdXQgKHNob3VsZCBvbmx5IGJlIHZhbGlkaXR5LnR5cGVNaXNtYXRjaCkuCiAgICAgIC8vIC0gc2VlIGh0dHA6Ly93d3cud2hhdHdnLm9yZy9zcGVjcy93ZWItYXBwcy9jdXJyZW50LXdvcmsvbXVsdGlwYWdlL2Zvcm1zLmh0bWwjZS1tYWlsLXN0YXRlLSh0eXBlPWVtYWlsKQogICAgICAvLyAtIGNhbiBpZ25vcmUgdGhpcyBjYXNlIGFzIHdlIGNhbiBzdGlsbCByZWFkIG91dCB0aGUgZXJyb25lb3VzIGVtYWlsLi4uCiAgICAgIHJldHVybiB2YWxpZGl0eS5iYWRJbnB1dCAmJiAhdmFsaWRpdHkudHlwZU1pc21hdGNoID8gdW5kZWZpbmVkIDogdmFsdWU7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIG51bWJlcklucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgYmFkSW5wdXRDaGVja2VyKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKTsKICBiYXNlSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICBjdHJsLiQkcGFyc2VyTmFtZSA9ICdudW1iZXInOwogIGN0cmwuJHBhcnNlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKGN0cmwuJGlzRW1wdHkodmFsdWUpKSAgICAgIHJldHVybiBudWxsOwogICAgaWYgKE5VTUJFUl9SRUdFWFAudGVzdCh2YWx1ZSkpIHJldHVybiBwYXJzZUZsb2F0KHZhbHVlKTsKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfSk7CgogIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKCFjdHJsLiRpc0VtcHR5KHZhbHVlKSkgewogICAgICBpZiAoIWlzTnVtYmVyKHZhbHVlKSkgewogICAgICAgIHRocm93ICRuZ01vZGVsTWluRXJyKCdudW1mbXQnLCAnRXhwZWN0ZWQgYHswfWAgdG8gYmUgYSBudW1iZXInLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgdmFsdWUgPSB2YWx1ZS50b1N0cmluZygpOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0pOwoKICBpZiAoYXR0ci5taW4gfHwgYXR0ci5uZ01pbikgewogICAgdmFyIG1pblZhbDsKICAgIGN0cmwuJHZhbGlkYXRvcnMubWluID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IGlzVW5kZWZpbmVkKG1pblZhbCkgfHwgdmFsdWUgPj0gbWluVmFsOwogICAgfTsKCiAgICBhdHRyLiRvYnNlcnZlKCdtaW4nLCBmdW5jdGlvbih2YWwpIHsKICAgICAgaWYgKGlzRGVmaW5lZCh2YWwpICYmICFpc051bWJlcih2YWwpKSB7CiAgICAgICAgdmFsID0gcGFyc2VGbG9hdCh2YWwsIDEwKTsKICAgICAgfQogICAgICBtaW5WYWwgPSBpc051bWJlcih2YWwpICYmICFpc05hTih2YWwpID8gdmFsIDogdW5kZWZpbmVkOwogICAgICAvLyBUT0RPKG1hdHNrbyk6IGltcGxlbWVudCB2YWxpZGF0ZUxhdGVyIHRvIHJlZHVjZSBudW1iZXIgb2YgdmFsaWRhdGlvbnMKICAgICAgY3RybC4kdmFsaWRhdGUoKTsKICAgIH0pOwogIH0KCiAgaWYgKGF0dHIubWF4IHx8IGF0dHIubmdNYXgpIHsKICAgIHZhciBtYXhWYWw7CiAgICBjdHJsLiR2YWxpZGF0b3JzLm1heCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBjdHJsLiRpc0VtcHR5KHZhbHVlKSB8fCBpc1VuZGVmaW5lZChtYXhWYWwpIHx8IHZhbHVlIDw9IG1heFZhbDsKICAgIH07CgogICAgYXR0ci4kb2JzZXJ2ZSgnbWF4JywgZnVuY3Rpb24odmFsKSB7CiAgICAgIGlmIChpc0RlZmluZWQodmFsKSAmJiAhaXNOdW1iZXIodmFsKSkgewogICAgICAgIHZhbCA9IHBhcnNlRmxvYXQodmFsLCAxMCk7CiAgICAgIH0KICAgICAgbWF4VmFsID0gaXNOdW1iZXIodmFsKSAmJiAhaXNOYU4odmFsKSA/IHZhbCA6IHVuZGVmaW5lZDsKICAgICAgLy8gVE9ETyhtYXRza28pOiBpbXBsZW1lbnQgdmFsaWRhdGVMYXRlciB0byByZWR1Y2UgbnVtYmVyIG9mIHZhbGlkYXRpb25zCiAgICAgIGN0cmwuJHZhbGlkYXRlKCk7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIHVybElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgLy8gTm90ZTogbm8gYmFkSW5wdXRDaGVja2VyIGhlcmUgYnkgcHVycG9zZSBhcyBgdXJsYCBpcyBvbmx5IGEgdmFsaWRhdGlvbgogIC8vIGluIGJyb3dzZXJzLCBpLmUuIHdlIGNhbiBhbHdheXMgcmVhZCBvdXQgaW5wdXQudmFsdWUgZXZlbiBpZiBpdCBpcyBub3QgdmFsaWQhCiAgYmFzZUlucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKICBzdHJpbmdCYXNlZElucHV0VHlwZShjdHJsKTsKCiAgY3RybC4kJHBhcnNlck5hbWUgPSAndXJsJzsKICBjdHJsLiR2YWxpZGF0b3JzLnVybCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgVVJMX1JFR0VYUC50ZXN0KHZhbHVlKTsKICB9Owp9CgpmdW5jdGlvbiBlbWFpbElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgLy8gTm90ZTogbm8gYmFkSW5wdXRDaGVja2VyIGhlcmUgYnkgcHVycG9zZSBhcyBgdXJsYCBpcyBvbmx5IGEgdmFsaWRhdGlvbgogIC8vIGluIGJyb3dzZXJzLCBpLmUuIHdlIGNhbiBhbHdheXMgcmVhZCBvdXQgaW5wdXQudmFsdWUgZXZlbiBpZiBpdCBpcyBub3QgdmFsaWQhCiAgYmFzZUlucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKICBzdHJpbmdCYXNlZElucHV0VHlwZShjdHJsKTsKCiAgY3RybC4kJHBhcnNlck5hbWUgPSAnZW1haWwnOwogIGN0cmwuJHZhbGlkYXRvcnMuZW1haWwgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IEVNQUlMX1JFR0VYUC50ZXN0KHZhbHVlKTsKICB9Owp9CgpmdW5jdGlvbiByYWRpb0lucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogIC8vIG1ha2UgdGhlIG5hbWUgdW5pcXVlLCBpZiBub3QgZGVmaW5lZAogIGlmIChpc1VuZGVmaW5lZChhdHRyLm5hbWUpKSB7CiAgICBlbGVtZW50LmF0dHIoJ25hbWUnLCBuZXh0VWlkKCkpOwogIH0KCiAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24oZXYpIHsKICAgIGlmIChlbGVtZW50WzBdLmNoZWNrZWQpIHsKICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGF0dHIudmFsdWUsIGV2ICYmIGV2LnR5cGUpOwogICAgfQogIH07CgogIGVsZW1lbnQub24oJ2NsaWNrJywgbGlzdGVuZXIpOwoKICBjdHJsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgIHZhciB2YWx1ZSA9IGF0dHIudmFsdWU7CiAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSAodmFsdWUgPT0gY3RybC4kdmlld1ZhbHVlKTsKICB9OwoKICBhdHRyLiRvYnNlcnZlKCd2YWx1ZScsIGN0cmwuJHJlbmRlcik7Cn0KCmZ1bmN0aW9uIHBhcnNlQ29uc3RhbnRFeHByKCRwYXJzZSwgY29udGV4dCwgbmFtZSwgZXhwcmVzc2lvbiwgZmFsbGJhY2spIHsKICB2YXIgcGFyc2VGbjsKICBpZiAoaXNEZWZpbmVkKGV4cHJlc3Npb24pKSB7CiAgICBwYXJzZUZuID0gJHBhcnNlKGV4cHJlc3Npb24pOwogICAgaWYgKCFwYXJzZUZuLmNvbnN0YW50KSB7CiAgICAgIHRocm93IG1pbkVycignbmdNb2RlbCcpKCdjb25zdGV4cHInLCAnRXhwZWN0ZWQgY29uc3RhbnQgZXhwcmVzc2lvbiBmb3IgYHswfWAsIGJ1dCBzYXcgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2B7MX1gLicsIG5hbWUsIGV4cHJlc3Npb24pOwogICAgfQogICAgcmV0dXJuIHBhcnNlRm4oY29udGV4dCk7CiAgfQogIHJldHVybiBmYWxsYmFjazsKfQoKZnVuY3Rpb24gY2hlY2tib3hJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlciwgJGZpbHRlciwgJHBhcnNlKSB7CiAgdmFyIHRydWVWYWx1ZSA9IHBhcnNlQ29uc3RhbnRFeHByKCRwYXJzZSwgc2NvcGUsICduZ1RydWVWYWx1ZScsIGF0dHIubmdUcnVlVmFsdWUsIHRydWUpOwogIHZhciBmYWxzZVZhbHVlID0gcGFyc2VDb25zdGFudEV4cHIoJHBhcnNlLCBzY29wZSwgJ25nRmFsc2VWYWx1ZScsIGF0dHIubmdGYWxzZVZhbHVlLCBmYWxzZSk7CgogIHZhciBsaXN0ZW5lciA9IGZ1bmN0aW9uKGV2KSB7CiAgICBjdHJsLiRzZXRWaWV3VmFsdWUoZWxlbWVudFswXS5jaGVja2VkLCBldiAmJiBldi50eXBlKTsKICB9OwoKICBlbGVtZW50Lm9uKCdjbGljaycsIGxpc3RlbmVyKTsKCiAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSBjdHJsLiR2aWV3VmFsdWU7CiAgfTsKCiAgLy8gT3ZlcnJpZGUgdGhlIHN0YW5kYXJkIGAkaXNFbXB0eWAgYmVjYXVzZSBhbiBlbXB0eSBjaGVja2JveCBpcyBuZXZlciBlcXVhbCB0byB0aGUgdHJ1ZVZhbHVlCiAgY3RybC4kaXNFbXB0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgIT09IHRydWVWYWx1ZTsKICB9OwoKICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiBlcXVhbHModmFsdWUsIHRydWVWYWx1ZSk7CiAgfSk7CgogIGN0cmwuJHBhcnNlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID8gdHJ1ZVZhbHVlIDogZmFsc2VWYWx1ZTsKICB9KTsKfQoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIHRleHRhcmVhCiAqIEByZXN0cmljdCBFCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBIVE1MIHRleHRhcmVhIGVsZW1lbnQgY29udHJvbCB3aXRoIGFuZ3VsYXIgZGF0YS1iaW5kaW5nLiBUaGUgZGF0YS1iaW5kaW5nIGFuZCB2YWxpZGF0aW9uCiAqIHByb3BlcnRpZXMgb2YgdGhpcyBlbGVtZW50IGFyZSBleGFjdGx5IHRoZSBzYW1lIGFzIHRob3NlIG9mIHRoZQogKiB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0IGVsZW1lbnR9LgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAqICAgIG1pbmxlbmd0aC4KICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogKiAgICBtYXhsZW5ndGguCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICogQHBhcmFtIHtib29sZWFuPX0gW25nVHJpbT10cnVlXSBJZiBzZXQgdG8gZmFsc2UgQW5ndWxhciB3aWxsIG5vdCBhdXRvbWF0aWNhbGx5IHRyaW0gdGhlIGlucHV0LgogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBpbnB1dAogKiBAcmVzdHJpY3QgRQogKgogKiBAZGVzY3JpcHRpb24KICogSFRNTCBpbnB1dCBlbGVtZW50IGNvbnRyb2wgd2l0aCBhbmd1bGFyIGRhdGEtYmluZGluZy4gSW5wdXQgY29udHJvbCBmb2xsb3dzIEhUTUw1IGlucHV0IHR5cGVzCiAqIGFuZCBwb2x5ZmlsbHMgdGhlIEhUTUw1IHZhbGlkYXRpb24gYmVoYXZpb3IgZm9yIG9sZGVyIGJyb3dzZXJzLgogKgogKiAqTk9URSogTm90IGV2ZXJ5IGZlYXR1cmUgb2ZmZXJlZCBpcyBhdmFpbGFibGUgZm9yIGFsbCBpbnB1dCB0eXBlcy4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICogQHBhcmFtIHtib29sZWFuPX0gbmdSZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGlmIHNldCB0byB0cnVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAqICAgIG1pbmxlbmd0aC4KICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogKiAgICBtYXhsZW5ndGguCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICogQHBhcmFtIHtib29sZWFuPX0gW25nVHJpbT10cnVlXSBJZiBzZXQgdG8gZmFsc2UgQW5ndWxhciB3aWxsIG5vdCBhdXRvbWF0aWNhbGx5IHRyaW0gdGhlIGlucHV0LgogKiAgICBUaGlzIHBhcmFtZXRlciBpcyBpZ25vcmVkIGZvciBpbnB1dFt0eXBlPXBhc3N3b3JkXSBjb250cm9scywgd2hpY2ggd2lsbCBuZXZlciB0cmltIHRoZQogKiAgICBpbnB1dC4KICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlIG5hbWU9ImlucHV0LWRpcmVjdGl2ZSIgbW9kdWxlPSJpbnB1dEV4YW1wbGUiPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICBhbmd1bGFyLm1vZHVsZSgnaW5wdXRFeGFtcGxlJywgW10pCiAgICAgICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAgICAgJHNjb3BlLnVzZXIgPSB7bmFtZTogJ2d1ZXN0JywgbGFzdDogJ3Zpc2l0b3InfTsKICAgICAgICAgICAgfV0pOwogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIj4KICAgICAgICAgICBVc2VyIG5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ1c2VyTmFtZSIgbmctbW9kZWw9InVzZXIubmFtZSIgcmVxdWlyZWQ+CiAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0udXNlck5hbWUuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj48YnI+CiAgICAgICAgICAgTGFzdCBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ibGFzdE5hbWUiIG5nLW1vZGVsPSJ1c2VyLmxhc3QiCiAgICAgICAgICAgICBuZy1taW5sZW5ndGg9IjMiIG5nLW1heGxlbmd0aD0iMTAiPgogICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxhc3ROYW1lLiRlcnJvci5taW5sZW5ndGgiPgogICAgICAgICAgICAgVG9vIHNob3J0ITwvc3Bhbj4KICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5sYXN0TmFtZS4kZXJyb3IubWF4bGVuZ3RoIj4KICAgICAgICAgICAgIFRvbyBsb25nITwvc3Bhbj48YnI+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPGhyPgogICAgICAgICA8dHQ+dXNlciA9IHt7dXNlcn19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLnVzZXJOYW1lLiR2YWxpZCA9IHt7bXlGb3JtLnVzZXJOYW1lLiR2YWxpZH19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0udXNlck5hbWUuJGVycm9yID0ge3tteUZvcm0udXNlck5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS5sYXN0TmFtZS4kdmFsaWQgPSB7e215Rm9ybS5sYXN0TmFtZS4kdmFsaWR9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLmxhc3ROYW1lLiRlcnJvciA9IHt7bXlGb3JtLmxhc3ROYW1lLiRlcnJvcn19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLm1pbmxlbmd0aCA9IHt7ISFteUZvcm0uJGVycm9yLm1pbmxlbmd0aH19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLm1heGxlbmd0aCA9IHt7ISFteUZvcm0uJGVycm9yLm1heGxlbmd0aH19PC90dD48YnI+CiAgICAgICA8L2Rpdj4KICAgICAgPC9maWxlPgogICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICB2YXIgdXNlciA9IGVsZW1lbnQoYnkuZXhhY3RCaW5kaW5nKCd1c2VyJykpOwogICAgICAgIHZhciB1c2VyTmFtZVZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0udXNlck5hbWUuJHZhbGlkJykpOwogICAgICAgIHZhciBsYXN0TmFtZVZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJHZhbGlkJykpOwogICAgICAgIHZhciBsYXN0TmFtZUVycm9yID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJGVycm9yJykpOwogICAgICAgIHZhciBmb3JtVmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS4kdmFsaWQnKSk7CiAgICAgICAgdmFyIHVzZXJOYW1lSW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd1c2VyLm5hbWUnKSk7CiAgICAgICAgdmFyIHVzZXJMYXN0SW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd1c2VyLmxhc3QnKSk7CgogICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KHVzZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3sibmFtZSI6Imd1ZXN0IiwibGFzdCI6InZpc2l0b3IifScpOwogICAgICAgICAgZXhwZWN0KHVzZXJOYW1lVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIGV4cGVjdChmb3JtVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5IHdoZW4gcmVxdWlyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHVzZXJOYW1lSW5wdXQuY2xlYXIoKTsKICAgICAgICAgIHVzZXJOYW1lSW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyLmdldFRleHQoKSkudG9Db250YWluKCd7Imxhc3QiOiJ2aXNpdG9yIn0nKTsKICAgICAgICAgIGV4cGVjdCh1c2VyTmFtZVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGZvcm1WYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBiZSB2YWxpZCBpZiBlbXB0eSB3aGVuIG1pbiBsZW5ndGggaXMgc2V0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB1c2VyTGFzdElucHV0LmNsZWFyKCk7CiAgICAgICAgICB1c2VyTGFzdElucHV0LnNlbmRLZXlzKCcnKTsKCiAgICAgICAgICBleHBlY3QodXNlci5nZXRUZXh0KCkpLnRvQ29udGFpbigneyJuYW1lIjoiZ3Vlc3QiLCJsYXN0IjoiIn0nKTsKICAgICAgICAgIGV4cGVjdChsYXN0TmFtZVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICBleHBlY3QoZm9ybVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBsZXNzIHRoYW4gcmVxdWlyZWQgbWluIGxlbmd0aCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdXNlckxhc3RJbnB1dC5jbGVhcigpOwogICAgICAgICAgdXNlckxhc3RJbnB1dC5zZW5kS2V5cygneHgnKTsKCiAgICAgICAgICBleHBlY3QodXNlci5nZXRUZXh0KCkpLnRvQ29udGFpbigneyJuYW1lIjoiZ3Vlc3QifScpOwogICAgICAgICAgZXhwZWN0KGxhc3ROYW1lVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QobGFzdE5hbWVFcnJvci5nZXRUZXh0KCkpLnRvQ29udGFpbignbWlubGVuZ3RoJyk7CiAgICAgICAgICBleHBlY3QoZm9ybVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbG9uZ2VyIHRoYW4gbWF4IGxlbmd0aCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdXNlckxhc3RJbnB1dC5jbGVhcigpOwogICAgICAgICAgdXNlckxhc3RJbnB1dC5zZW5kS2V5cygnc29tZSByaWRpY3Vsb3VzbHkgbG9uZyBuYW1lJyk7CgogICAgICAgICAgZXhwZWN0KHVzZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3sibmFtZSI6Imd1ZXN0In0nKTsKICAgICAgICAgIGV4cGVjdChsYXN0TmFtZVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGxhc3ROYW1lRXJyb3IuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ21heGxlbmd0aCcpOwogICAgICAgICAgZXhwZWN0KGZvcm1WYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KdmFyIGlucHV0RGlyZWN0aXZlID0gWyckYnJvd3NlcicsICckc25pZmZlcicsICckZmlsdGVyJywgJyRwYXJzZScsCiAgICBmdW5jdGlvbigkYnJvd3NlciwgJHNuaWZmZXIsICRmaWx0ZXIsICRwYXJzZSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgcmVxdWlyZTogWyc/bmdNb2RlbCddLAogICAgbGluazogewogICAgICBwcmU6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJscykgewogICAgICAgIGlmIChjdHJsc1swXSkgewogICAgICAgICAgKGlucHV0VHlwZVtsb3dlcmNhc2UoYXR0ci50eXBlKV0gfHwgaW5wdXRUeXBlLnRleHQpKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsc1swXSwgJHNuaWZmZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIsICRmaWx0ZXIsICRwYXJzZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKfV07Cgp2YXIgVkFMSURfQ0xBU1MgPSAnbmctdmFsaWQnLAogICAgSU5WQUxJRF9DTEFTUyA9ICduZy1pbnZhbGlkJywKICAgIFBSSVNUSU5FX0NMQVNTID0gJ25nLXByaXN0aW5lJywKICAgIERJUlRZX0NMQVNTID0gJ25nLWRpcnR5JywKICAgIFVOVE9VQ0hFRF9DTEFTUyA9ICduZy11bnRvdWNoZWQnLAogICAgVE9VQ0hFRF9DTEFTUyA9ICduZy10b3VjaGVkJywKICAgIFBFTkRJTkdfQ0xBU1MgPSAnbmctcGVuZGluZyc7CgovKioKICogQG5nZG9jIHR5cGUKICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogKgogKiBAcHJvcGVydHkge3N0cmluZ30gJHZpZXdWYWx1ZSBBY3R1YWwgc3RyaW5nIHZhbHVlIGluIHRoZSB2aWV3LgogKiBAcHJvcGVydHkgeyp9ICRtb2RlbFZhbHVlIFRoZSB2YWx1ZSBpbiB0aGUgbW9kZWwsIHRoYXQgdGhlIGNvbnRyb2wgaXMgYm91bmQgdG8uCiAqIEBwcm9wZXJ0eSB7QXJyYXkuPEZ1bmN0aW9uPn0gJHBhcnNlcnMgQXJyYXkgb2YgZnVuY3Rpb25zIHRvIGV4ZWN1dGUsIGFzIGEgcGlwZWxpbmUsIHdoZW5ldmVyCiAgICAgICB0aGUgY29udHJvbCByZWFkcyB2YWx1ZSBmcm9tIHRoZSBET00uICBFYWNoIGZ1bmN0aW9uIGlzIGNhbGxlZCwgaW4gdHVybiwgcGFzc2luZyB0aGUgdmFsdWUKICAgICAgIHRocm91Z2ggdG8gdGhlIG5leHQuIFRoZSBsYXN0IHJldHVybiB2YWx1ZSBpcyB1c2VkIHRvIHBvcHVsYXRlIHRoZSBtb2RlbC4KICAgICAgIFVzZWQgdG8gc2FuaXRpemUgLyBjb252ZXJ0IHRoZSB2YWx1ZSBhcyB3ZWxsIGFzIHZhbGlkYXRpb24uIEZvciB2YWxpZGF0aW9uLAogICAgICAgdGhlIHBhcnNlcnMgc2hvdWxkIHVwZGF0ZSB0aGUgdmFsaWRpdHkgc3RhdGUgdXNpbmcKICAgICAgIHtAbGluayBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRWYWxpZGl0eSAkc2V0VmFsaWRpdHkoKX0sCiAgICAgICBhbmQgcmV0dXJuIGB1bmRlZmluZWRgIGZvciBpbnZhbGlkIHZhbHVlcy4KCiAqCiAqIEBwcm9wZXJ0eSB7QXJyYXkuPEZ1bmN0aW9uPn0gJGZvcm1hdHRlcnMgQXJyYXkgb2YgZnVuY3Rpb25zIHRvIGV4ZWN1dGUsIGFzIGEgcGlwZWxpbmUsIHdoZW5ldmVyCiAgICAgICB0aGUgbW9kZWwgdmFsdWUgY2hhbmdlcy4gRWFjaCBmdW5jdGlvbiBpcyBjYWxsZWQsIGluIHR1cm4sIHBhc3NpbmcgdGhlIHZhbHVlIHRocm91Z2ggdG8gdGhlCiAgICAgICBuZXh0LiBVc2VkIHRvIGZvcm1hdCAvIGNvbnZlcnQgdmFsdWVzIGZvciBkaXNwbGF5IGluIHRoZSBjb250cm9sIGFuZCB2YWxpZGF0aW9uLgogKiBgYGBqcwogKiBmdW5jdGlvbiBmb3JtYXR0ZXIodmFsdWUpIHsKICogICBpZiAodmFsdWUpIHsKICogICAgIHJldHVybiB2YWx1ZS50b1VwcGVyQ2FzZSgpOwogKiAgIH0KICogfQogKiBuZ01vZGVsLiRmb3JtYXR0ZXJzLnB1c2goZm9ybWF0dGVyKTsKICogYGBgCiAqCiAqIEBwcm9wZXJ0eSB7T2JqZWN0LjxzdHJpbmcsIGZ1bmN0aW9uPn0gJHZhbGlkYXRvcnMgQSBjb2xsZWN0aW9uIG9mIHZhbGlkYXRvcnMgdGhhdCBhcmUgYXBwbGllZAogKiAgICAgIHdoZW5ldmVyIHRoZSBtb2RlbCB2YWx1ZSBjaGFuZ2VzLiBUaGUga2V5IHZhbHVlIHdpdGhpbiB0aGUgb2JqZWN0IHJlZmVycyB0byB0aGUgbmFtZSBvZiB0aGUKICogICAgICB2YWxpZGF0b3Igd2hpbGUgdGhlIGZ1bmN0aW9uIHJlZmVycyB0byB0aGUgdmFsaWRhdGlvbiBvcGVyYXRpb24uIFRoZSB2YWxpZGF0aW9uIG9wZXJhdGlvbiBpcwogKiAgICAgIHByb3ZpZGVkIHdpdGggdGhlIG1vZGVsIHZhbHVlIGFzIGFuIGFyZ3VtZW50IGFuZCBtdXN0IHJldHVybiBhIHRydWUgb3IgZmFsc2UgdmFsdWUgZGVwZW5kaW5nCiAqICAgICAgb24gdGhlIHJlc3BvbnNlIG9mIHRoYXQgdmFsaWRhdGlvbi4KICoKICogYGBganMKICogbmdNb2RlbC4kdmFsaWRhdG9ycy52YWxpZENoYXJhY3RlcnMgPSBmdW5jdGlvbihtb2RlbFZhbHVlLCB2aWV3VmFsdWUpIHsKICogICB2YXIgdmFsdWUgPSBtb2RlbFZhbHVlIHx8IHZpZXdWYWx1ZTsKICogICByZXR1cm4gL1swLTldKy8udGVzdCh2YWx1ZSkgJiYKICogICAgICAgICAgL1thLXpdKy8udGVzdCh2YWx1ZSkgJiYKICogICAgICAgICAgL1tBLVpdKy8udGVzdCh2YWx1ZSkgJiYKICogICAgICAgICAgL1xXKy8udGVzdCh2YWx1ZSk7CiAqIH07CiAqIGBgYAogKgogKiBAcHJvcGVydHkge09iamVjdC48c3RyaW5nLCBmdW5jdGlvbj59ICRhc3luY1ZhbGlkYXRvcnMgQSBjb2xsZWN0aW9uIG9mIHZhbGlkYXRpb25zIHRoYXQgYXJlIGV4cGVjdGVkIHRvCiAqICAgICAgcGVyZm9ybSBhbiBhc3luY2hyb25vdXMgdmFsaWRhdGlvbiAoZS5nLiBhIEhUVFAgcmVxdWVzdCkuIFRoZSB2YWxpZGF0aW9uIGZ1bmN0aW9uIHRoYXQgaXMgcHJvdmlkZWQKICogICAgICBpcyBleHBlY3RlZCB0byByZXR1cm4gYSBwcm9taXNlIHdoZW4gaXQgaXMgcnVuIGR1cmluZyB0aGUgbW9kZWwgdmFsaWRhdGlvbiBwcm9jZXNzLiBPbmNlIHRoZSBwcm9taXNlCiAqICAgICAgaXMgZGVsaXZlcmVkIHRoZW4gdGhlIHZhbGlkYXRpb24gc3RhdHVzIHdpbGwgYmUgc2V0IHRvIHRydWUgd2hlbiBmdWxmaWxsZWQgYW5kIGZhbHNlIHdoZW4gcmVqZWN0ZWQuCiAqICAgICAgV2hlbiB0aGUgYXN5bmNocm9ub3VzIHZhbGlkYXRvcnMgYXJlIHRyaWdnZXJlZCwgZWFjaCBvZiB0aGUgdmFsaWRhdG9ycyB3aWxsIHJ1biBpbiBwYXJhbGxlbCBhbmQgdGhlIG1vZGVsCiAqICAgICAgdmFsdWUgd2lsbCBvbmx5IGJlIHVwZGF0ZWQgb25jZSBhbGwgdmFsaWRhdG9ycyBoYXZlIGJlZW4gZnVsZmlsbGVkLiBBbHNvLCBrZWVwIGluIG1pbmQgdGhhdCBhbGwKICogICAgICBhc3luY2hyb25vdXMgdmFsaWRhdG9ycyB3aWxsIG9ubHkgcnVuIG9uY2UgYWxsIHN5bmNocm9ub3VzIHZhbGlkYXRvcnMgaGF2ZSBwYXNzZWQuCiAqCiAqIFBsZWFzZSBub3RlIHRoYXQgaWYgJGh0dHAgaXMgdXNlZCB0aGVuIGl0IGlzIGltcG9ydGFudCB0aGF0IHRoZSBzZXJ2ZXIgcmV0dXJucyBhIHN1Y2Nlc3MgSFRUUCByZXNwb25zZSBjb2RlCiAqIGluIG9yZGVyIHRvIGZ1bGZpbGwgdGhlIHZhbGlkYXRpb24gYW5kIGEgc3RhdHVzIGxldmVsIG9mIGA0eHhgIGluIG9yZGVyIHRvIHJlamVjdCB0aGUgdmFsaWRhdGlvbi4KICoKICogYGBganMKICogbmdNb2RlbC4kYXN5bmNWYWxpZGF0b3JzLnVuaXF1ZVVzZXJuYW1lID0gZnVuY3Rpb24obW9kZWxWYWx1ZSwgdmlld1ZhbHVlKSB7CiAqICAgdmFyIHZhbHVlID0gbW9kZWxWYWx1ZSB8fCB2aWV3VmFsdWU7CiAqCiAqICAgLy8gTG9va3VwIHVzZXIgYnkgdXNlcm5hbWUKICogICByZXR1cm4gJGh0dHAuZ2V0KCcvYXBpL3VzZXJzLycgKyB2YWx1ZSkuCiAqICAgICAgdGhlbihmdW5jdGlvbiByZXNvbHZlZCgpIHsKICogICAgICAgIC8vdXNlcm5hbWUgZXhpc3RzLCB0aGlzIG1lYW5zIHZhbGlkYXRpb24gZmFpbHMKICogICAgICAgIHJldHVybiAkcS5yZWplY3QoJ2V4aXN0cycpOwogKiAgICAgIH0sIGZ1bmN0aW9uIHJlamVjdGVkKCkgewogKiAgICAgICAgLy91c2VybmFtZSBkb2VzIG5vdCBleGlzdCwgdGhlcmVmb3JlIHRoaXMgdmFsaWRhdGlvbiBwYXNzZXMKICogICAgICAgIHJldHVybiB0cnVlOwogKiAgICAgIH0pOwogKiB9OwogKiBgYGAKICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHZhbGlkYXRvci4KICogQHBhcmFtIHtGdW5jdGlvbn0gdmFsaWRhdGlvbkZuIFRoZSB2YWxpZGF0aW9uIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBydW4uCiAqCiAqIEBwcm9wZXJ0eSB7QXJyYXkuPEZ1bmN0aW9uPn0gJHZpZXdDaGFuZ2VMaXN0ZW5lcnMgQXJyYXkgb2YgZnVuY3Rpb25zIHRvIGV4ZWN1dGUgd2hlbmV2ZXIgdGhlCiAqICAgICB2aWV3IHZhbHVlIGhhcyBjaGFuZ2VkLiBJdCBpcyBjYWxsZWQgd2l0aCBubyBhcmd1bWVudHMsIGFuZCBpdHMgcmV0dXJuIHZhbHVlIGlzIGlnbm9yZWQuCiAqICAgICBUaGlzIGNhbiBiZSB1c2VkIGluIHBsYWNlIG9mIGFkZGl0aW9uYWwgJHdhdGNoZXMgYWdhaW5zdCB0aGUgbW9kZWwgdmFsdWUuCiAqCiAqIEBwcm9wZXJ0eSB7T2JqZWN0fSAkZXJyb3IgQW4gb2JqZWN0IGhhc2ggd2l0aCBhbGwgZmFpbGluZyB2YWxpZGF0b3IgaWRzIGFzIGtleXMuCiAqIEBwcm9wZXJ0eSB7T2JqZWN0fSAkcGVuZGluZyBBbiBvYmplY3QgaGFzaCB3aXRoIGFsbCBwZW5kaW5nIHZhbGlkYXRvciBpZHMgYXMga2V5cy4KICoKICogQHByb3BlcnR5IHtib29sZWFufSAkdW50b3VjaGVkIFRydWUgaWYgY29udHJvbCBoYXMgbm90IGxvc3QgZm9jdXMgeWV0LgogKiBAcHJvcGVydHkge2Jvb2xlYW59ICR0b3VjaGVkIFRydWUgaWYgY29udHJvbCBoYXMgbG9zdCBmb2N1cy4KICogQHByb3BlcnR5IHtib29sZWFufSAkcHJpc3RpbmUgVHJ1ZSBpZiB1c2VyIGhhcyBub3QgaW50ZXJhY3RlZCB3aXRoIHRoZSBjb250cm9sIHlldC4KICogQHByb3BlcnR5IHtib29sZWFufSAkZGlydHkgVHJ1ZSBpZiB1c2VyIGhhcyBhbHJlYWR5IGludGVyYWN0ZWQgd2l0aCB0aGUgY29udHJvbC4KICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiB0aGVyZSBpcyBubyBlcnJvci4KICogQHByb3BlcnR5IHtib29sZWFufSAkaW52YWxpZCBUcnVlIGlmIGF0IGxlYXN0IG9uZSBlcnJvciBvbiB0aGUgY29udHJvbC4KICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIGBOZ01vZGVsQ29udHJvbGxlcmAgcHJvdmlkZXMgQVBJIGZvciB0aGUgYG5nLW1vZGVsYCBkaXJlY3RpdmUuIFRoZSBjb250cm9sbGVyIGNvbnRhaW5zCiAqIHNlcnZpY2VzIGZvciBkYXRhLWJpbmRpbmcsIHZhbGlkYXRpb24sIENTUyB1cGRhdGVzLCBhbmQgdmFsdWUgZm9ybWF0dGluZyBhbmQgcGFyc2luZy4gSXQKICogcHVycG9zZWZ1bGx5IGRvZXMgbm90IGNvbnRhaW4gYW55IGxvZ2ljIHdoaWNoIGRlYWxzIHdpdGggRE9NIHJlbmRlcmluZyBvciBsaXN0ZW5pbmcgdG8KICogRE9NIGV2ZW50cy4gU3VjaCBET00gcmVsYXRlZCBsb2dpYyBzaG91bGQgYmUgcHJvdmlkZWQgYnkgb3RoZXIgZGlyZWN0aXZlcyB3aGljaCBtYWtlIHVzZSBvZgogKiBgTmdNb2RlbENvbnRyb2xsZXJgIGZvciBkYXRhLWJpbmRpbmcuCiAqCiAqICMjIEN1c3RvbSBDb250cm9sIEV4YW1wbGUKICogVGhpcyBleGFtcGxlIHNob3dzIGhvdyB0byB1c2UgYE5nTW9kZWxDb250cm9sbGVyYCB3aXRoIGEgY3VzdG9tIGNvbnRyb2wgdG8gYWNoaWV2ZQogKiBkYXRhLWJpbmRpbmcuIE5vdGljZSBob3cgZGlmZmVyZW50IGRpcmVjdGl2ZXMgKGBjb250ZW50ZWRpdGFibGVgLCBgbmctbW9kZWxgLCBhbmQgYHJlcXVpcmVkYCkKICogY29sbGFib3JhdGUgdG9nZXRoZXIgdG8gYWNoaWV2ZSB0aGUgZGVzaXJlZCByZXN1bHQuCiAqCiAqIE5vdGUgdGhhdCBgY29udGVudGVkaXRhYmxlYCBpcyBhbiBIVE1MNSBhdHRyaWJ1dGUsIHdoaWNoIHRlbGxzIHRoZSBicm93c2VyIHRvIGxldCB0aGUgZWxlbWVudAogKiBjb250ZW50cyBiZSBlZGl0ZWQgaW4gcGxhY2UgYnkgdGhlIHVzZXIuICBUaGlzIHdpbGwgbm90IHdvcmsgb24gb2xkZXIgYnJvd3NlcnMuCiAqCiAqIFdlIGFyZSB1c2luZyB0aGUge0BsaW5rIG5nLnNlcnZpY2U6JHNjZSAkc2NlfSBzZXJ2aWNlIGhlcmUgYW5kIGluY2x1ZGUgdGhlIHtAbGluayBuZ1Nhbml0aXplICRzYW5pdGl6ZX0KICogbW9kdWxlIHRvIGF1dG9tYXRpY2FsbHkgcmVtb3ZlICJiYWQiIGNvbnRlbnQgbGlrZSBpbmxpbmUgZXZlbnQgbGlzdGVuZXIgKGUuZy4gYDxzcGFuIG9uY2xpY2s9Ii4uLiI+YCkuCiAqIEhvd2V2ZXIsIGFzIHdlIGFyZSB1c2luZyBgJHNjZWAgdGhlIG1vZGVsIGNhbiBzdGlsbCBkZWNpZGUgdG8gdG8gcHJvdmlkZSB1bnNhZmUgY29udGVudCBpZiBpdCBtYXJrcwogKiB0aGF0IGNvbnRlbnQgdXNpbmcgdGhlIGAkc2NlYCBzZXJ2aWNlLgogKgogKiA8ZXhhbXBsZSBuYW1lPSJOZ01vZGVsQ29udHJvbGxlciIgbW9kdWxlPSJjdXN0b21Db250cm9sIiBkZXBzPSJhbmd1bGFyLXNhbml0aXplLmpzIj4KICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgIFtjb250ZW50ZWRpdGFibGVdIHsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCBibGFjazsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB3aGl0ZTsKICAgICAgICBtaW4taGVpZ2h0OiAyMHB4OwogICAgICB9CgogICAgICAubmctaW52YWxpZCB7CiAgICAgICAgYm9yZGVyOiAxcHggc29saWQgcmVkOwogICAgICB9CgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgYW5ndWxhci5tb2R1bGUoJ2N1c3RvbUNvbnRyb2wnLCBbJ25nU2FuaXRpemUnXSkuCiAgICAgICAgZGlyZWN0aXZlKCdjb250ZW50ZWRpdGFibGUnLCBbJyRzY2UnLCBmdW5jdGlvbigkc2NlKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0EnLCAvLyBvbmx5IGFjdGl2YXRlIG9uIGVsZW1lbnQgYXR0cmlidXRlCiAgICAgICAgICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsIC8vIGdldCBhIGhvbGQgb2YgTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBuZ01vZGVsKSB7CiAgICAgICAgICAgICAgaWYgKCFuZ01vZGVsKSByZXR1cm47IC8vIGRvIG5vdGhpbmcgaWYgbm8gbmctbW9kZWwKCiAgICAgICAgICAgICAgLy8gU3BlY2lmeSBob3cgVUkgc2hvdWxkIGJlIHVwZGF0ZWQKICAgICAgICAgICAgICBuZ01vZGVsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCgkc2NlLmdldFRydXN0ZWRIdG1sKG5nTW9kZWwuJHZpZXdWYWx1ZSB8fCAnJykpOwogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIC8vIExpc3RlbiBmb3IgY2hhbmdlIGV2ZW50cyB0byBlbmFibGUgYmluZGluZwogICAgICAgICAgICAgIGVsZW1lbnQub24oJ2JsdXIga2V5dXAgY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkocmVhZCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmVhZCgpOyAvLyBpbml0aWFsaXplCgogICAgICAgICAgICAgIC8vIFdyaXRlIGRhdGEgdG8gdGhlIG1vZGVsCiAgICAgICAgICAgICAgZnVuY3Rpb24gcmVhZCgpIHsKICAgICAgICAgICAgICAgIHZhciBodG1sID0gZWxlbWVudC5odG1sKCk7CiAgICAgICAgICAgICAgICAvLyBXaGVuIHdlIGNsZWFyIHRoZSBjb250ZW50IGVkaXRhYmxlIHRoZSBicm93c2VyIGxlYXZlcyBhIDxicj4gYmVoaW5kCiAgICAgICAgICAgICAgICAvLyBJZiBzdHJpcC1iciBhdHRyaWJ1dGUgaXMgcHJvdmlkZWQgdGhlbiB3ZSBzdHJpcCB0aGlzIG91dAogICAgICAgICAgICAgICAgaWYgKCBhdHRycy5zdHJpcEJyICYmIGh0bWwgPT0gJzxicj4nICkgewogICAgICAgICAgICAgICAgICBodG1sID0gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZ01vZGVsLiRzZXRWaWV3VmFsdWUoaHRtbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH1dKTsKICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iPgogICAgICAgPGRpdiBjb250ZW50ZWRpdGFibGUKICAgICAgICAgICAgbmFtZT0ibXlXaWRnZXQiIG5nLW1vZGVsPSJ1c2VyQ29udGVudCIKICAgICAgICAgICAgc3RyaXAtYnI9InRydWUiCiAgICAgICAgICAgIHJlcXVpcmVkPkNoYW5nZSBtZSE8L2Rpdj4KICAgICAgICA8c3BhbiBuZy1zaG93PSJteUZvcm0ubXlXaWRnZXQuJGVycm9yLnJlcXVpcmVkIj5SZXF1aXJlZCE8L3NwYW4+CiAgICAgICA8aHI+CiAgICAgICA8dGV4dGFyZWEgbmctbW9kZWw9InVzZXJDb250ZW50Ij48L3RleHRhcmVhPgogICAgICA8L2Zvcm0+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgIGl0KCdzaG91bGQgZGF0YS1iaW5kIGFuZCBiZWNvbWUgaW52YWxpZCcsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoYnJvd3Nlci5wYXJhbXMuYnJvd3NlciA9PSAnc2FmYXJpJyB8fCBicm93c2VyLnBhcmFtcy5icm93c2VyID09ICdmaXJlZm94JykgewogICAgICAgIC8vIFNhZmFyaURyaXZlciBjYW4ndCBoYW5kbGUgY29udGVudGVkaXRhYmxlCiAgICAgICAgLy8gYW5kIEZpcmVmb3ggZHJpdmVyIGNhbid0IGNsZWFyIGNvbnRlbnRlZGl0YWJsZXMgdmVyeSB3ZWxsCiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBjb250ZW50RWRpdGFibGUgPSBlbGVtZW50KGJ5LmNzcygnW2NvbnRlbnRlZGl0YWJsZV0nKSk7CiAgICAgIHZhciBjb250ZW50ID0gJ0NoYW5nZSBtZSEnOwoKICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS5nZXRUZXh0KCkpLnRvRXF1YWwoY29udGVudCk7CgogICAgICBjb250ZW50RWRpdGFibGUuY2xlYXIoKTsKICAgICAgY29udGVudEVkaXRhYmxlLnNlbmRLZXlzKHByb3RyYWN0b3IuS2V5LkJBQ0tfU1BBQ0UpOwogICAgICBleHBlY3QoY29udGVudEVkaXRhYmxlLmdldFRleHQoKSkudG9FcXVhbCgnJyk7CiAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS50b01hdGNoKC9uZy1pbnZhbGlkLXJlcXVpcmVkLyk7CiAgICB9KTsKICAgIDwvZmlsZT4KICogPC9leGFtcGxlPgogKgogKgogKi8KdmFyIE5nTW9kZWxDb250cm9sbGVyID0gWyckc2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJGF0dHJzJywgJyRlbGVtZW50JywgJyRwYXJzZScsICckYW5pbWF0ZScsICckdGltZW91dCcsICckcm9vdFNjb3BlJywgJyRxJywgJyRpbnRlcnBvbGF0ZScsCiAgICBmdW5jdGlvbigkc2NvcGUsICRleGNlcHRpb25IYW5kbGVyLCAkYXR0ciwgJGVsZW1lbnQsICRwYXJzZSwgJGFuaW1hdGUsICR0aW1lb3V0LCAkcm9vdFNjb3BlLCAkcSwgJGludGVycG9sYXRlKSB7CiAgdGhpcy4kdmlld1ZhbHVlID0gTnVtYmVyLk5hTjsKICB0aGlzLiRtb2RlbFZhbHVlID0gTnVtYmVyLk5hTjsKICB0aGlzLiR2YWxpZGF0b3JzID0ge307CiAgdGhpcy4kYXN5bmNWYWxpZGF0b3JzID0ge307CiAgdGhpcy4kcGFyc2VycyA9IFtdOwogIHRoaXMuJGZvcm1hdHRlcnMgPSBbXTsKICB0aGlzLiR2aWV3Q2hhbmdlTGlzdGVuZXJzID0gW107CiAgdGhpcy4kdW50b3VjaGVkID0gdHJ1ZTsKICB0aGlzLiR0b3VjaGVkID0gZmFsc2U7CiAgdGhpcy4kcHJpc3RpbmUgPSB0cnVlOwogIHRoaXMuJGRpcnR5ID0gZmFsc2U7CiAgdGhpcy4kdmFsaWQgPSB0cnVlOwogIHRoaXMuJGludmFsaWQgPSBmYWxzZTsKICB0aGlzLiRlcnJvciA9IHt9OyAvLyBrZWVwIGludmFsaWQga2V5cyBoZXJlCiAgdGhpcy4kJHN1Y2Nlc3MgPSB7fTsgLy8ga2VlcCB2YWxpZCBrZXlzIGhlcmUKICB0aGlzLiRwZW5kaW5nID0gdW5kZWZpbmVkOyAvLyBrZWVwIHBlbmRpbmcga2V5cyBoZXJlCiAgdGhpcy4kbmFtZSA9ICRpbnRlcnBvbGF0ZSgkYXR0ci5uYW1lIHx8ICcnLCBmYWxzZSkoJHNjb3BlKTsKCgogIHZhciBwYXJzZWROZ01vZGVsID0gJHBhcnNlKCRhdHRyLm5nTW9kZWwpLAogICAgICBwZW5kaW5nRGVib3VuY2UgPSBudWxsLAogICAgICBjdHJsID0gdGhpczsKCiAgdmFyIG5nTW9kZWxHZXQgPSBmdW5jdGlvbiBuZ01vZGVsR2V0KCkgewogICAgdmFyIG1vZGVsVmFsdWUgPSBwYXJzZWROZ01vZGVsKCRzY29wZSk7CiAgICBpZiAoY3RybC4kb3B0aW9ucyAmJiBjdHJsLiRvcHRpb25zLmdldHRlclNldHRlciAmJiBpc0Z1bmN0aW9uKG1vZGVsVmFsdWUpKSB7CiAgICAgIG1vZGVsVmFsdWUgPSBtb2RlbFZhbHVlKCk7CiAgICB9CiAgICByZXR1cm4gbW9kZWxWYWx1ZTsKICB9OwoKICB2YXIgbmdNb2RlbFNldCA9IGZ1bmN0aW9uIG5nTW9kZWxTZXQobmV3VmFsdWUpIHsKICAgIHZhciBnZXR0ZXJTZXR0ZXI7CiAgICBpZiAoY3RybC4kb3B0aW9ucyAmJiBjdHJsLiRvcHRpb25zLmdldHRlclNldHRlciAmJgogICAgICAgIGlzRnVuY3Rpb24oZ2V0dGVyU2V0dGVyID0gcGFyc2VkTmdNb2RlbCgkc2NvcGUpKSkgewoKICAgICAgZ2V0dGVyU2V0dGVyKGN0cmwuJG1vZGVsVmFsdWUpOwogICAgfSBlbHNlIHsKICAgICAgcGFyc2VkTmdNb2RlbC5hc3NpZ24oJHNjb3BlLCBjdHJsLiRtb2RlbFZhbHVlKTsKICAgIH0KICB9OwoKICB0aGlzLiQkc2V0T3B0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIGN0cmwuJG9wdGlvbnMgPSBvcHRpb25zOwoKICAgIGlmICghcGFyc2VkTmdNb2RlbC5hc3NpZ24gJiYgKCFvcHRpb25zIHx8ICFvcHRpb25zLmdldHRlclNldHRlcikpIHsKICAgICAgdGhyb3cgJG5nTW9kZWxNaW5FcnIoJ25vbmFzc2lnbicsICJFeHByZXNzaW9uICd7MH0nIGlzIG5vbi1hc3NpZ25hYmxlLiBFbGVtZW50OiB7MX0iLAogICAgICAgICAgJGF0dHIubmdNb2RlbCwgc3RhcnRpbmdUYWcoJGVsZW1lbnQpKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkcmVuZGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYWxsZWQgd2hlbiB0aGUgdmlldyBuZWVkcyB0byBiZSB1cGRhdGVkLiBJdCBpcyBleHBlY3RlZCB0aGF0IHRoZSB1c2VyIG9mIHRoZSBuZy1tb2RlbAogICAqIGRpcmVjdGl2ZSB3aWxsIGltcGxlbWVudCB0aGlzIG1ldGhvZC4KICAgKgogICAqIFRoZSBgJHJlbmRlcigpYCBtZXRob2QgaXMgaW52b2tlZCBpbiB0aGUgZm9sbG93aW5nIHNpdHVhdGlvbnM6CiAgICoKICAgKiAqIGAkcm9sbGJhY2tWaWV3VmFsdWUoKWAgaXMgY2FsbGVkLiAgSWYgd2UgYXJlIHJvbGxpbmcgYmFjayB0aGUgdmlldyB2YWx1ZSB0byB0aGUgbGFzdAogICAqICAgY29tbWl0dGVkIHZhbHVlIHRoZW4gYCRyZW5kZXIoKWAgaXMgY2FsbGVkIHRvIHVwZGF0ZSB0aGUgaW5wdXQgY29udHJvbC4KICAgKiAqIFRoZSB2YWx1ZSByZWZlcmVuY2VkIGJ5IGBuZy1tb2RlbGAgaXMgY2hhbmdlZCBwcm9ncmFtbWF0aWNhbGx5IGFuZCBib3RoIHRoZSBgJG1vZGVsVmFsdWVgIGFuZAogICAqICAgdGhlIGAkdmlld1ZhbHVlYCBhcmUgZGlmZmVyZW50IHRvIGxhc3QgdGltZS4KICAgKgogICAqIFNpbmNlIGBuZy1tb2RlbGAgZG9lcyBub3QgZG8gYSBkZWVwIHdhdGNoLCBgJHJlbmRlcigpYCBpcyBvbmx5IGludm9rZWQgaWYgdGhlIHZhbHVlcyBvZgogICAqIGAkbW9kZWxWYWx1ZWAgYW5kIGAkdmlld1ZhbHVlYCBhcmUgYWN0dWFsbHkgZGlmZmVyZW50IHRvIHRoZWlyIHByZXZpb3VzIHZhbHVlLiBJZiBgJG1vZGVsVmFsdWVgCiAgICogb3IgYCR2aWV3VmFsdWVgIGFyZSBvYmplY3RzIChyYXRoZXIgdGhhbiBhIHN0cmluZyBvciBudW1iZXIpIHRoZW4gYCRyZW5kZXIoKWAgd2lsbCBub3QgYmUKICAgKiBpbnZva2VkIGlmIHlvdSBvbmx5IGNoYW5nZSBhIHByb3BlcnR5IG9uIHRoZSBvYmplY3RzLgogICAqLwogIHRoaXMuJHJlbmRlciA9IG5vb3A7CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRpc0VtcHR5CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIGlzIGNhbGxlZCB3aGVuIHdlIG5lZWQgdG8gZGV0ZXJtaW5lIGlmIHRoZSB2YWx1ZSBvZiB0aGUgaW5wdXQgaXMgZW1wdHkuCiAgICoKICAgKiBGb3IgaW5zdGFuY2UsIHRoZSByZXF1aXJlZCBkaXJlY3RpdmUgZG9lcyB0aGlzIHRvIHdvcmsgb3V0IGlmIHRoZSBpbnB1dCBoYXMgZGF0YSBvciBub3QuCiAgICogVGhlIGRlZmF1bHQgYCRpc0VtcHR5YCBmdW5jdGlvbiBjaGVja3Mgd2hldGhlciB0aGUgdmFsdWUgaXMgYHVuZGVmaW5lZGAsIGAnJ2AsIGBudWxsYCBvciBgTmFOYC4KICAgKgogICAqIFlvdSBjYW4gb3ZlcnJpZGUgdGhpcyBmb3IgaW5wdXQgZGlyZWN0aXZlcyB3aG9zZSBjb25jZXB0IG9mIGJlaW5nIGVtcHR5IGlzIGRpZmZlcmVudCB0byB0aGUKICAgKiBkZWZhdWx0LiBUaGUgYGNoZWNrYm94SW5wdXRUeXBlYCBkaXJlY3RpdmUgZG9lcyB0aGlzIGJlY2F1c2UgaW4gaXRzIGNhc2UgYSB2YWx1ZSBvZiBgZmFsc2VgCiAgICogaW1wbGllcyBlbXB0eS4KICAgKgogICAqIEBwYXJhbSB7Kn0gdmFsdWUgTW9kZWwgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBlbXB0eS4KICAgKi8KICB0aGlzLiRpc0VtcHR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiBpc1VuZGVmaW5lZCh2YWx1ZSkgfHwgdmFsdWUgPT09ICcnIHx8IHZhbHVlID09PSBudWxsIHx8IHZhbHVlICE9PSB2YWx1ZTsKICB9OwoKICB2YXIgcGFyZW50Rm9ybSA9ICRlbGVtZW50LmluaGVyaXRlZERhdGEoJyRmb3JtQ29udHJvbGxlcicpIHx8IG51bGxGb3JtQ3RybCwKICAgICAgY3VycmVudFZhbGlkYXRpb25SdW5JZCA9IDA7CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRWYWxpZGl0eQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2hhbmdlIHRoZSB2YWxpZGl0eSBzdGF0ZSwgYW5kIG5vdGlmaWVzIHRoZSBmb3JtLgogICAqCiAgICogVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB3aXRoaW4gJHBhcnNlcnMvJGZvcm1hdHRlcnMuIEhvd2V2ZXIsIGlmIHBvc3NpYmxlLCBwbGVhc2UgdXNlIHRoZQogICAqICAgICAgICBgbmdNb2RlbC4kdmFsaWRhdG9yc2AgcGlwZWxpbmUgd2hpY2ggaXMgZGVzaWduZWQgdG8gY2FsbCB0aGlzIG1ldGhvZCBhdXRvbWF0aWNhbGx5LgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbGlkYXRpb25FcnJvcktleSBOYW1lIG9mIHRoZSB2YWxpZGF0b3IuIHRoZSBgdmFsaWRhdGlvbkVycm9yS2V5YCB3aWxsIGFzc2lnbgogICAqICAgICAgICB0byBgJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV1gIGFuZCBgJHBlbmRpbmdbdmFsaWRhdGlvbkVycm9yS2V5XWAKICAgKiAgICAgICAgc28gdGhhdCBpdCBpcyBhdmFpbGFibGUgZm9yIGRhdGEtYmluZGluZy4KICAgKiAgICAgICAgVGhlIGB2YWxpZGF0aW9uRXJyb3JLZXlgIHNob3VsZCBiZSBpbiBjYW1lbENhc2UgYW5kIHdpbGwgZ2V0IGNvbnZlcnRlZCBpbnRvIGRhc2gtY2FzZQogICAqICAgICAgICBmb3IgY2xhc3MgbmFtZS4gRXhhbXBsZTogYG15RXJyb3JgIHdpbGwgcmVzdWx0IGluIGBuZy12YWxpZC1teS1lcnJvcmAgYW5kIGBuZy1pbnZhbGlkLW15LWVycm9yYAogICAqICAgICAgICBjbGFzcyBhbmQgY2FuIGJlIGJvdW5kIHRvIGFzICBge3tzb21lRm9ybS5zb21lQ29udHJvbC4kZXJyb3IubXlFcnJvcn19YCAuCiAgICogQHBhcmFtIHtib29sZWFufSBpc1ZhbGlkIFdoZXRoZXIgdGhlIGN1cnJlbnQgc3RhdGUgaXMgdmFsaWQgKHRydWUpLCBpbnZhbGlkIChmYWxzZSksIHBlbmRpbmcgKHVuZGVmaW5lZCksCiAgICogICAgICAgICAgICAgICAgICAgICAgICAgIG9yIHNraXBwZWQgKG51bGwpLgogICAqLwogIGFkZFNldFZhbGlkaXR5TWV0aG9kKHsKICAgIGN0cmw6IHRoaXMsCiAgICAkZWxlbWVudDogJGVsZW1lbnQsCiAgICBzZXQ6IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsKICAgICAgb2JqZWN0W3Byb3BlcnR5XSA9IHRydWU7CiAgICB9LAogICAgdW5zZXQ6IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsKICAgICAgZGVsZXRlIG9iamVjdFtwcm9wZXJ0eV07CiAgICB9LAogICAgcGFyZW50Rm9ybTogcGFyZW50Rm9ybSwKICAgICRhbmltYXRlOiAkYW5pbWF0ZQogIH0pOwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0UHJpc3RpbmUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNldHMgdGhlIGNvbnRyb2wgdG8gaXRzIHByaXN0aW5lIHN0YXRlLgogICAqCiAgICogVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB0byByZW1vdmUgdGhlICduZy1kaXJ0eScgY2xhc3MgYW5kIHNldCB0aGUgY29udHJvbCB0byBpdHMgcHJpc3RpbmUKICAgKiBzdGF0ZSAobmctcHJpc3RpbmUgY2xhc3MpLiBBIG1vZGVsIGlzIGNvbnNpZGVyZWQgdG8gYmUgcHJpc3RpbmUgd2hlbiB0aGUgbW9kZWwgaGFzIG5vdCBiZWVuIGNoYW5nZWQKICAgKiBmcm9tIHdoZW4gZmlyc3QgY29tcGlsZWQgd2l0aGluIHRoZW4gZm9ybS4KICAgKi8KICB0aGlzLiRzZXRQcmlzdGluZSA9IGZ1bmN0aW9uICgpIHsKICAgIGN0cmwuJGRpcnR5ID0gZmFsc2U7CiAgICBjdHJsLiRwcmlzdGluZSA9IHRydWU7CiAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcygkZWxlbWVudCwgRElSVFlfQ0xBU1MpOwogICAgJGFuaW1hdGUuYWRkQ2xhc3MoJGVsZW1lbnQsIFBSSVNUSU5FX0NMQVNTKTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0VW50b3VjaGVkCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXRzIHRoZSBjb250cm9sIHRvIGl0cyB1bnRvdWNoZWQgc3RhdGUuCiAgICoKICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIHJlbW92ZSB0aGUgJ25nLXRvdWNoZWQnIGNsYXNzIGFuZCBzZXQgdGhlIGNvbnRyb2wgdG8gaXRzCiAgICogdW50b3VjaGVkIHN0YXRlIChuZy11bnRvdWNoZWQgY2xhc3MpLiBVcG9uIGNvbXBpbGF0aW9uLCBhIG1vZGVsIGlzIHNldCBhcyB1bnRvdWNoZWQKICAgKiBieSBkZWZhdWx0LCBob3dldmVyIHRoaXMgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gcmVzdG9yZSB0aGF0IHN0YXRlIGlmIHRoZSBtb2RlbCBoYXMKICAgKiBhbHJlYWR5IGJlZW4gdG91Y2hlZCBieSB0aGUgdXNlci4KICAgKi8KICB0aGlzLiRzZXRVbnRvdWNoZWQgPSBmdW5jdGlvbigpIHsKICAgIGN0cmwuJHRvdWNoZWQgPSBmYWxzZTsKICAgIGN0cmwuJHVudG91Y2hlZCA9IHRydWU7CiAgICAkYW5pbWF0ZS5zZXRDbGFzcygkZWxlbWVudCwgVU5UT1VDSEVEX0NMQVNTLCBUT1VDSEVEX0NMQVNTKTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0VG91Y2hlZAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cyB0aGUgY29udHJvbCB0byBpdHMgdG91Y2hlZCBzdGF0ZS4KICAgKgogICAqIFRoaXMgbWV0aG9kIGNhbiBiZSBjYWxsZWQgdG8gcmVtb3ZlIHRoZSAnbmctdW50b3VjaGVkJyBjbGFzcyBhbmQgc2V0IHRoZSBjb250cm9sIHRvIGl0cwogICAqIHRvdWNoZWQgc3RhdGUgKG5nLXRvdWNoZWQgY2xhc3MpLiBBIG1vZGVsIGlzIGNvbnNpZGVyZWQgdG8gYmUgdG91Y2hlZCB3aGVuIHRoZSB1c2VyIGhhcwogICAqIGZpcnN0IGludGVyYWN0ZWQgKGZvY3Vzc2VkKSBvbiB0aGUgbW9kZWwgaW5wdXQgZWxlbWVudCBhbmQgdGhlbiBzaGlmdGVkIGZvY3VzIGF3YXkgKGJsdXJyZWQpCiAgICogZnJvbSB0aGUgaW5wdXQgZWxlbWVudC4KICAgKi8KICB0aGlzLiRzZXRUb3VjaGVkID0gZnVuY3Rpb24oKSB7CiAgICBjdHJsLiR0b3VjaGVkID0gdHJ1ZTsKICAgIGN0cmwuJHVudG91Y2hlZCA9IGZhbHNlOwogICAgJGFuaW1hdGUuc2V0Q2xhc3MoJGVsZW1lbnQsIFRPVUNIRURfQ0xBU1MsIFVOVE9VQ0hFRF9DTEFTUyk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHJvbGxiYWNrVmlld1ZhbHVlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYW5jZWwgYW4gdXBkYXRlIGFuZCByZXNldCB0aGUgaW5wdXQgZWxlbWVudCdzIHZhbHVlIHRvIHByZXZlbnQgYW4gdXBkYXRlIHRvIHRoZSBgJG1vZGVsVmFsdWVgLAogICAqIHdoaWNoIG1heSBiZSBjYXVzZWQgYnkgYSBwZW5kaW5nIGRlYm91bmNlZCBldmVudCBvciBiZWNhdXNlIHRoZSBpbnB1dCBpcyB3YWl0aW5nIGZvciBhIHNvbWUKICAgKiBmdXR1cmUgZXZlbnQuCiAgICoKICAgKiBJZiB5b3UgaGF2ZSBhbiBpbnB1dCB0aGF0IHVzZXMgYG5nLW1vZGVsLW9wdGlvbnNgIHRvIHNldCB1cCBkZWJvdW5jZWQgZXZlbnRzIG9yIGV2ZW50cyBzdWNoCiAgICogYXMgYmx1ciB5b3UgY2FuIGhhdmUgYSBzaXR1YXRpb24gd2hlcmUgdGhlcmUgaXMgYSBwZXJpb2Qgd2hlbiB0aGUgYCR2aWV3VmFsdWVgCiAgICogaXMgb3V0IG9mIHN5bmNoIHdpdGggdGhlIG5nTW9kZWwncyBgJG1vZGVsVmFsdWVgLgogICAqCiAgICogSW4gdGhpcyBjYXNlLCB5b3UgY2FuIHJ1biBpbnRvIGRpZmZpY3VsdGllcyBpZiB5b3UgdHJ5IHRvIHVwZGF0ZSB0aGUgbmdNb2RlbCdzIGAkbW9kZWxWYWx1ZWAKICAgKiBwcm9ncmFtbWF0aWNhbGx5IGJlZm9yZSB0aGVzZSBkZWJvdW5jZWQvZnV0dXJlIGV2ZW50cyBoYXZlIHJlc29sdmVkL29jY3VycmVkLCBiZWNhdXNlIEFuZ3VsYXIncwogICAqIGRpcnR5IGNoZWNraW5nIG1lY2hhbmlzbSBpcyBub3QgYWJsZSB0byB0ZWxsIHdoZXRoZXIgdGhlIG1vZGVsIGhhcyBhY3R1YWxseSBjaGFuZ2VkIG9yIG5vdC4KICAgKgogICAqIFRoZSBgJHJvbGxiYWNrVmlld1ZhbHVlKClgIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIGJlZm9yZSBwcm9ncmFtbWF0aWNhbGx5IGNoYW5naW5nIHRoZSBtb2RlbCBvZiBhbgogICAqIGlucHV0IHdoaWNoIG1heSBoYXZlIHN1Y2ggZXZlbnRzIHBlbmRpbmcuIFRoaXMgaXMgaW1wb3J0YW50IGluIG9yZGVyIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZQogICAqIGlucHV0IGZpZWxkIHdpbGwgYmUgdXBkYXRlZCB3aXRoIHRoZSBuZXcgbW9kZWwgdmFsdWUgYW5kIGFueSBwZW5kaW5nIG9wZXJhdGlvbnMgYXJlIGNhbmNlbGxlZC4KICAgKgogICAqIDxleGFtcGxlIG5hbWU9Im5nLW1vZGVsLWNhbmNlbC11cGRhdGUiIG1vZHVsZT0iY2FuY2VsLXVwZGF0ZS1leGFtcGxlIj4KICAgKiAgIDxmaWxlIG5hbWU9ImFwcC5qcyI+CiAgICogICAgIGFuZ3VsYXIubW9kdWxlKCdjYW5jZWwtdXBkYXRlLWV4YW1wbGUnLCBbXSkKICAgKgogICAqICAgICAuY29udHJvbGxlcignQ2FuY2VsVXBkYXRlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICogICAgICAgJHNjb3BlLnJlc2V0V2l0aENhbmNlbCA9IGZ1bmN0aW9uIChlKSB7CiAgICogICAgICAgICBpZiAoZS5rZXlDb2RlID09IDI3KSB7CiAgICogICAgICAgICAgICRzY29wZS5teUZvcm0ubXlJbnB1dDEuJHJvbGxiYWNrVmlld1ZhbHVlKCk7CiAgICogICAgICAgICAgICRzY29wZS5teVZhbHVlID0gJyc7CiAgICogICAgICAgICB9CiAgICogICAgICAgfTsKICAgKiAgICAgICAkc2NvcGUucmVzZXRXaXRob3V0Q2FuY2VsID0gZnVuY3Rpb24gKGUpIHsKICAgKiAgICAgICAgIGlmIChlLmtleUNvZGUgPT0gMjcpIHsKICAgKiAgICAgICAgICAgJHNjb3BlLm15VmFsdWUgPSAnJzsKICAgKiAgICAgICAgIH0KICAgKiAgICAgICB9OwogICAqICAgICB9XSk7CiAgICogICA8L2ZpbGU+CiAgICogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgKiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDYW5jZWxVcGRhdGVDb250cm9sbGVyIj4KICAgKiAgICAgICA8cD5UcnkgdHlwaW5nIHNvbWV0aGluZyBpbiBlYWNoIGlucHV0LiAgU2VlIHRoYXQgdGhlIG1vZGVsIG9ubHkgdXBkYXRlcyB3aGVuIHlvdQogICAqICAgICAgICAgIGJsdXIgb2ZmIHRoZSBpbnB1dC4KICAgKiAgICAgICAgPC9wPgogICAqICAgICAgICA8cD5Ob3cgc2VlIHdoYXQgaGFwcGVucyBpZiB5b3Ugc3RhcnQgdHlwaW5nIHRoZW4gcHJlc3MgdGhlIEVzY2FwZSBrZXk8L3A+CiAgICoKICAgKiAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLW1vZGVsLW9wdGlvbnM9InsgdXBkYXRlT246ICdibHVyJyB9Ij4KICAgKiAgICAgICAgIDxwPldpdGggJHJvbGxiYWNrVmlld1ZhbHVlKCk8L3A+CiAgICogICAgICAgICA8aW5wdXQgbmFtZT0ibXlJbnB1dDEiIG5nLW1vZGVsPSJteVZhbHVlIiBuZy1rZXlkb3duPSJyZXNldFdpdGhDYW5jZWwoJGV2ZW50KSI+PGJyLz4KICAgKiAgICAgICAgIG15VmFsdWU6ICJ7eyBteVZhbHVlIH19IgogICAqCiAgICogICAgICAgICA8cD5XaXRob3V0ICRyb2xsYmFja1ZpZXdWYWx1ZSgpPC9wPgogICAqICAgICAgICAgPGlucHV0IG5hbWU9Im15SW5wdXQyIiBuZy1tb2RlbD0ibXlWYWx1ZSIgbmcta2V5ZG93bj0icmVzZXRXaXRob3V0Q2FuY2VsKCRldmVudCkiPjxici8+CiAgICogICAgICAgICBteVZhbHVlOiAie3sgbXlWYWx1ZSB9fSIKICAgKiAgICAgICA8L2Zvcm0+CiAgICogICAgIDwvZGl2PgogICAqICAgPC9maWxlPgogICAqIDwvZXhhbXBsZT4KICAgKi8KICB0aGlzLiRyb2xsYmFja1ZpZXdWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgJHRpbWVvdXQuY2FuY2VsKHBlbmRpbmdEZWJvdW5jZSk7CiAgICBjdHJsLiR2aWV3VmFsdWUgPSBjdHJsLiQkbGFzdENvbW1pdHRlZFZpZXdWYWx1ZTsKICAgIGN0cmwuJHJlbmRlcigpOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyR2YWxpZGF0ZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUnVucyBlYWNoIG9mIHRoZSByZWdpc3RlcmVkIHZhbGlkYXRvcnMgKGZpcnN0IHN5bmNocm9ub3VzIHZhbGlkYXRvcnMgYW5kIHRoZW4gYXN5bmNocm9ub3VzIHZhbGlkYXRvcnMpLgogICAqLwogIHRoaXMuJHZhbGlkYXRlID0gZnVuY3Rpb24oKSB7CiAgICAvLyBpZ25vcmUgJHZhbGlkYXRlIGJlZm9yZSBtb2RlbCBpcyBpbml0aWFsaXplZAogICAgaWYgKGlzTnVtYmVyKGN0cmwuJG1vZGVsVmFsdWUpICYmIGlzTmFOKGN0cmwuJG1vZGVsVmFsdWUpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuJCRwYXJzZUFuZFZhbGlkYXRlKCk7CiAgfTsKCiAgdGhpcy4kJHJ1blZhbGlkYXRvcnMgPSBmdW5jdGlvbihwYXJzZVZhbGlkLCBtb2RlbFZhbHVlLCB2aWV3VmFsdWUsIGRvbmVDYWxsYmFjaykgewogICAgY3VycmVudFZhbGlkYXRpb25SdW5JZCsrOwogICAgdmFyIGxvY2FsVmFsaWRhdGlvblJ1bklkID0gY3VycmVudFZhbGlkYXRpb25SdW5JZDsKCiAgICAvLyBjaGVjayBwYXJzZXIgZXJyb3IKICAgIGlmICghcHJvY2Vzc1BhcnNlRXJyb3JzKHBhcnNlVmFsaWQpKSB7CiAgICAgIHZhbGlkYXRpb25Eb25lKGZhbHNlKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCFwcm9jZXNzU3luY1ZhbGlkYXRvcnMoKSkgewogICAgICB2YWxpZGF0aW9uRG9uZShmYWxzZSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHByb2Nlc3NBc3luY1ZhbGlkYXRvcnMoKTsKCiAgICBmdW5jdGlvbiBwcm9jZXNzUGFyc2VFcnJvcnMocGFyc2VWYWxpZCkgewogICAgICB2YXIgZXJyb3JLZXkgPSBjdHJsLiQkcGFyc2VyTmFtZSB8fCAncGFyc2UnOwogICAgICBpZiAocGFyc2VWYWxpZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgc2V0VmFsaWRpdHkoZXJyb3JLZXksIG51bGwpOwogICAgICB9IGVsc2UgewogICAgICAgIHNldFZhbGlkaXR5KGVycm9yS2V5LCBwYXJzZVZhbGlkKTsKICAgICAgICBpZiAoIXBhcnNlVmFsaWQpIHsKICAgICAgICAgIGZvckVhY2goY3RybC4kdmFsaWRhdG9ycywgZnVuY3Rpb24odiwgbmFtZSkgewogICAgICAgICAgICBzZXRWYWxpZGl0eShuYW1lLCBudWxsKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZm9yRWFjaChjdHJsLiRhc3luY1ZhbGlkYXRvcnMsIGZ1bmN0aW9uKHYsIG5hbWUpIHsKICAgICAgICAgICAgc2V0VmFsaWRpdHkobmFtZSwgbnVsbCk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gcHJvY2Vzc1N5bmNWYWxpZGF0b3JzKCkgewogICAgICB2YXIgc3luY1ZhbGlkYXRvcnNWYWxpZCA9IHRydWU7CiAgICAgIGZvckVhY2goY3RybC4kdmFsaWRhdG9ycywgZnVuY3Rpb24odmFsaWRhdG9yLCBuYW1lKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHZhbGlkYXRvcihtb2RlbFZhbHVlLCB2aWV3VmFsdWUpOwogICAgICAgIHN5bmNWYWxpZGF0b3JzVmFsaWQgPSBzeW5jVmFsaWRhdG9yc1ZhbGlkICYmIHJlc3VsdDsKICAgICAgICBzZXRWYWxpZGl0eShuYW1lLCByZXN1bHQpOwogICAgICB9KTsKICAgICAgaWYgKCFzeW5jVmFsaWRhdG9yc1ZhbGlkKSB7CiAgICAgICAgZm9yRWFjaChjdHJsLiRhc3luY1ZhbGlkYXRvcnMsIGZ1bmN0aW9uKHYsIG5hbWUpIHsKICAgICAgICAgIHNldFZhbGlkaXR5KG5hbWUsIG51bGwpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBwcm9jZXNzQXN5bmNWYWxpZGF0b3JzKCkgewogICAgICB2YXIgdmFsaWRhdG9yUHJvbWlzZXMgPSBbXTsKICAgICAgdmFyIGFsbFZhbGlkID0gdHJ1ZTsKICAgICAgZm9yRWFjaChjdHJsLiRhc3luY1ZhbGlkYXRvcnMsIGZ1bmN0aW9uKHZhbGlkYXRvciwgbmFtZSkgewogICAgICAgIHZhciBwcm9taXNlID0gdmFsaWRhdG9yKG1vZGVsVmFsdWUsIHZpZXdWYWx1ZSk7CiAgICAgICAgaWYgKCFpc1Byb21pc2VMaWtlKHByb21pc2UpKSB7CiAgICAgICAgICB0aHJvdyAkbmdNb2RlbE1pbkVycigiJGFzeW5jVmFsaWRhdG9ycyIsCiAgICAgICAgICAgICJFeHBlY3RlZCBhc3luY2hyb25vdXMgdmFsaWRhdG9yIHRvIHJldHVybiBhIHByb21pc2UgYnV0IGdvdCAnezB9JyBpbnN0ZWFkLiIsIHByb21pc2UpOwogICAgICAgIH0KICAgICAgICBzZXRWYWxpZGl0eShuYW1lLCB1bmRlZmluZWQpOwogICAgICAgIHZhbGlkYXRvclByb21pc2VzLnB1c2gocHJvbWlzZS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgc2V0VmFsaWRpdHkobmFtZSwgdHJ1ZSk7CiAgICAgICAgfSwgZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgIGFsbFZhbGlkID0gZmFsc2U7CiAgICAgICAgICBzZXRWYWxpZGl0eShuYW1lLCBmYWxzZSk7CiAgICAgICAgfSkpOwogICAgICB9KTsKICAgICAgaWYgKCF2YWxpZGF0b3JQcm9taXNlcy5sZW5ndGgpIHsKICAgICAgICB2YWxpZGF0aW9uRG9uZSh0cnVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAkcS5hbGwodmFsaWRhdG9yUHJvbWlzZXMpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YWxpZGF0aW9uRG9uZShhbGxWYWxpZCk7CiAgICAgICAgfSwgbm9vcCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzZXRWYWxpZGl0eShuYW1lLCBpc1ZhbGlkKSB7CiAgICAgIGlmIChsb2NhbFZhbGlkYXRpb25SdW5JZCA9PT0gY3VycmVudFZhbGlkYXRpb25SdW5JZCkgewogICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KG5hbWUsIGlzVmFsaWQpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdmFsaWRhdGlvbkRvbmUoYWxsVmFsaWQpIHsKICAgICAgaWYgKGxvY2FsVmFsaWRhdGlvblJ1bklkID09PSBjdXJyZW50VmFsaWRhdGlvblJ1bklkKSB7CgogICAgICAgIGRvbmVDYWxsYmFjayhhbGxWYWxpZCk7CiAgICAgIH0KICAgIH0KICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkY29tbWl0Vmlld1ZhbHVlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDb21taXQgYSBwZW5kaW5nIHVwZGF0ZSB0byB0aGUgYCRtb2RlbFZhbHVlYC4KICAgKgogICAqIFVwZGF0ZXMgbWF5IGJlIHBlbmRpbmcgYnkgYSBkZWJvdW5jZWQgZXZlbnQgb3IgYmVjYXVzZSB0aGUgaW5wdXQgaXMgd2FpdGluZyBmb3IgYSBzb21lIGZ1dHVyZQogICAqIGV2ZW50IGRlZmluZWQgaW4gYG5nLW1vZGVsLW9wdGlvbnNgLiB0aGlzIG1ldGhvZCBpcyByYXJlbHkgbmVlZGVkIGFzIGBOZ01vZGVsQ29udHJvbGxlcmAKICAgKiB1c3VhbGx5IGhhbmRsZXMgY2FsbGluZyB0aGlzIGluIHJlc3BvbnNlIHRvIGlucHV0IGV2ZW50cy4KICAgKi8KICB0aGlzLiRjb21taXRWaWV3VmFsdWUgPSBmdW5jdGlvbigpIHsKICAgIHZhciB2aWV3VmFsdWUgPSBjdHJsLiR2aWV3VmFsdWU7CgogICAgJHRpbWVvdXQuY2FuY2VsKHBlbmRpbmdEZWJvdW5jZSk7CgogICAgLy8gSWYgdGhlIHZpZXcgdmFsdWUgaGFzIG5vdCBjaGFuZ2VkIHRoZW4gd2Ugc2hvdWxkIGp1c3QgZXhpdCwgZXhjZXB0IGluIHRoZSBjYXNlIHdoZXJlIHRoZXJlIGlzCiAgICAvLyBhIG5hdGl2ZSB2YWxpZGF0b3Igb24gdGhlIGVsZW1lbnQuIEluIHRoaXMgY2FzZSB0aGUgdmFsaWRhdGlvbiBzdGF0ZSBtYXkgaGF2ZSBjaGFuZ2VkIGV2ZW4gdGhvdWdoCiAgICAvLyB0aGUgdmlld1ZhbHVlIGhhcyBzdGF5ZWQgZW1wdHkuCiAgICBpZiAoY3RybC4kJGxhc3RDb21taXR0ZWRWaWV3VmFsdWUgPT09IHZpZXdWYWx1ZSAmJiAodmlld1ZhbHVlICE9PSAnJyB8fCAhY3RybC4kJGhhc05hdGl2ZVZhbGlkYXRvcnMpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGN0cmwuJCRsYXN0Q29tbWl0dGVkVmlld1ZhbHVlID0gdmlld1ZhbHVlOwoKICAgIC8vIGNoYW5nZSB0byBkaXJ0eQogICAgaWYgKGN0cmwuJHByaXN0aW5lKSB7CiAgICAgIGN0cmwuJGRpcnR5ID0gdHJ1ZTsKICAgICAgY3RybC4kcHJpc3RpbmUgPSBmYWxzZTsKICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3MoJGVsZW1lbnQsIFBSSVNUSU5FX0NMQVNTKTsKICAgICAgJGFuaW1hdGUuYWRkQ2xhc3MoJGVsZW1lbnQsIERJUlRZX0NMQVNTKTsKICAgICAgcGFyZW50Rm9ybS4kc2V0RGlydHkoKTsKICAgIH0KICAgIHRoaXMuJCRwYXJzZUFuZFZhbGlkYXRlKCk7CiAgfTsKCiAgdGhpcy4kJHBhcnNlQW5kVmFsaWRhdGUgPSBmdW5jdGlvbigpIHsKICAgIHZhciB2aWV3VmFsdWUgPSBjdHJsLiQkbGFzdENvbW1pdHRlZFZpZXdWYWx1ZTsKICAgIHZhciBtb2RlbFZhbHVlID0gdmlld1ZhbHVlOwogICAgdmFyIHBhcnNlclZhbGlkID0gaXNVbmRlZmluZWQobW9kZWxWYWx1ZSkgPyB1bmRlZmluZWQgOiB0cnVlOwoKICAgIGlmIChwYXJzZXJWYWxpZCkgewogICAgICBmb3IodmFyIGkgPSAwOyBpIDwgY3RybC4kcGFyc2Vycy5sZW5ndGg7IGkrKykgewogICAgICAgIG1vZGVsVmFsdWUgPSBjdHJsLiRwYXJzZXJzW2ldKG1vZGVsVmFsdWUpOwogICAgICAgIGlmIChpc1VuZGVmaW5lZChtb2RlbFZhbHVlKSkgewogICAgICAgICAgcGFyc2VyVmFsaWQgPSBmYWxzZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKGlzTnVtYmVyKGN0cmwuJG1vZGVsVmFsdWUpICYmIGlzTmFOKGN0cmwuJG1vZGVsVmFsdWUpKSB7CiAgICAgIC8vIGN0cmwuJG1vZGVsVmFsdWUgaGFzIG5vdCBiZWVuIHRvdWNoZWQgeWV0Li4uCiAgICAgIGN0cmwuJG1vZGVsVmFsdWUgPSBuZ01vZGVsR2V0KCk7CiAgICB9CiAgICB2YXIgcHJldk1vZGVsVmFsdWUgPSBjdHJsLiRtb2RlbFZhbHVlOwogICAgdmFyIGFsbG93SW52YWxpZCA9IGN0cmwuJG9wdGlvbnMgJiYgY3RybC4kb3B0aW9ucy5hbGxvd0ludmFsaWQ7CiAgICBpZiAoYWxsb3dJbnZhbGlkKSB7CiAgICAgIGN0cmwuJG1vZGVsVmFsdWUgPSBtb2RlbFZhbHVlOwogICAgICB3cml0ZVRvTW9kZWxJZk5lZWRlZCgpOwogICAgfQogICAgY3RybC4kJHJ1blZhbGlkYXRvcnMocGFyc2VyVmFsaWQsIG1vZGVsVmFsdWUsIHZpZXdWYWx1ZSwgZnVuY3Rpb24oYWxsVmFsaWQpIHsKICAgICAgaWYgKCFhbGxvd0ludmFsaWQpIHsKICAgICAgICAvLyBOb3RlOiBEb24ndCBjaGVjayBjdHJsLiR2YWxpZCBoZXJlLCBhcyB3ZSBjb3VsZCBoYXZlCiAgICAgICAgLy8gZXh0ZXJuYWwgdmFsaWRhdG9ycyAoZS5nLiBjYWxjdWxhdGVkIG9uIHRoZSBzZXJ2ZXIpLAogICAgICAgIC8vIHRoYXQganVzdCBjYWxsICRzZXRWYWxpZGl0eSBhbmQgbmVlZCB0aGUgbW9kZWwgdmFsdWUKICAgICAgICAvLyB0byBjYWxjdWxhdGUgdGhlaXIgdmFsaWRpdHkuCiAgICAgICAgY3RybC4kbW9kZWxWYWx1ZSA9IGFsbFZhbGlkID8gbW9kZWxWYWx1ZSA6IHVuZGVmaW5lZDsKICAgICAgICB3cml0ZVRvTW9kZWxJZk5lZWRlZCgpOwogICAgICB9CiAgICB9KTsKCiAgICBmdW5jdGlvbiB3cml0ZVRvTW9kZWxJZk5lZWRlZCgpIHsKICAgICAgaWYgKGN0cmwuJG1vZGVsVmFsdWUgIT09IHByZXZNb2RlbFZhbHVlKSB7CiAgICAgICAgY3RybC4kJHdyaXRlTW9kZWxUb1Njb3BlKCk7CiAgICAgIH0KICAgIH0KICB9OwoKICB0aGlzLiQkd3JpdGVNb2RlbFRvU2NvcGUgPSBmdW5jdGlvbigpIHsKICAgIG5nTW9kZWxTZXQoY3RybC4kbW9kZWxWYWx1ZSk7CiAgICBmb3JFYWNoKGN0cmwuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMsIGZ1bmN0aW9uKGxpc3RlbmVyKSB7CiAgICAgIHRyeSB7CiAgICAgICAgbGlzdGVuZXIoKTsKICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRWaWV3VmFsdWUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFVwZGF0ZSB0aGUgdmlldyB2YWx1ZS4KICAgKgogICAqIFRoaXMgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgd2hlbiBhbiBpbnB1dCBkaXJlY3RpdmUgd2FudCB0byBjaGFuZ2UgdGhlIHZpZXcgdmFsdWU7IHR5cGljYWxseSwKICAgKiB0aGlzIGlzIGRvbmUgZnJvbSB3aXRoaW4gYSBET00gZXZlbnQgaGFuZGxlci4KICAgKgogICAqIEZvciBleGFtcGxlIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQgaW5wdXR9IGNhbGxzIGl0IHdoZW4gdGhlIHZhbHVlIG9mIHRoZSBpbnB1dCBjaGFuZ2VzIGFuZAogICAqIHtAbGluayBuZy5kaXJlY3RpdmU6c2VsZWN0IHNlbGVjdH0gY2FsbHMgaXQgd2hlbiBhbiBvcHRpb24gaXMgc2VsZWN0ZWQuCiAgICoKICAgKiBJZiB0aGUgbmV3IGB2YWx1ZWAgaXMgYW4gb2JqZWN0IChyYXRoZXIgdGhhbiBhIHN0cmluZyBvciBhIG51bWJlciksIHdlIHNob3VsZCBtYWtlIGEgY29weSBvZiB0aGUKICAgKiBvYmplY3QgYmVmb3JlIHBhc3NpbmcgaXQgdG8gYCRzZXRWaWV3VmFsdWVgLiAgVGhpcyBpcyBiZWNhdXNlIGBuZ01vZGVsYCBkb2VzIG5vdCBwZXJmb3JtIGEgZGVlcAogICAqIHdhdGNoIG9mIG9iamVjdHMsIGl0IG9ubHkgbG9va3MgZm9yIGEgY2hhbmdlIG9mIGlkZW50aXR5LiBJZiB5b3Ugb25seSBjaGFuZ2UgdGhlIHByb3BlcnR5IG9mCiAgICogdGhlIG9iamVjdCB0aGVuIG5nTW9kZWwgd2lsbCBub3QgcmVhbGlzZSB0aGF0IHRoZSBvYmplY3QgaGFzIGNoYW5nZWQgYW5kIHdpbGwgbm90IGludm9rZSB0aGUKICAgKiBgJHBhcnNlcnNgIGFuZCBgJHZhbGlkYXRvcnNgIHBpcGVsaW5lcy4KICAgKgogICAqIEZvciB0aGlzIHJlYXNvbiwgeW91IHNob3VsZCBub3QgY2hhbmdlIHByb3BlcnRpZXMgb2YgdGhlIGNvcHkgb25jZSBpdCBoYXMgYmVlbiBwYXNzZWQgdG8KICAgKiBgJHNldFZpZXdWYWx1ZWAuIE90aGVyd2lzZSB5b3UgbWF5IGNhdXNlIHRoZSBtb2RlbCB2YWx1ZSBvbiB0aGUgc2NvcGUgdG8gY2hhbmdlIGluY29ycmVjdGx5LgogICAqCiAgICogV2hlbiB0aGlzIG1ldGhvZCBpcyBjYWxsZWQsIHRoZSBuZXcgYHZhbHVlYCB3aWxsIGJlIHN0YWdlZCBmb3IgY29tbWl0dGluZyB0aHJvdWdoIHRoZSBgJHBhcnNlcnNgCiAgICogYW5kIGAkdmFsaWRhdG9yc2AgcGlwZWxpbmVzLiBJZiB0aGVyZSBhcmUgbm8gc3BlY2lhbCB7QGxpbmsgbmdNb2RlbE9wdGlvbnN9IHNwZWNpZmllZCB0aGVuIHRoZSBzdGFnZWQKICAgKiB2YWx1ZSBzZW50IGRpcmVjdGx5IGZvciBwcm9jZXNzaW5nLCBmaW5hbGx5IHRvIGJlIGFwcGxpZWQgdG8gYCRtb2RlbFZhbHVlYCBhbmQgdGhlbiB0aGUKICAgKiAqKmV4cHJlc3Npb24qKiBzcGVjaWZpZWQgaW4gdGhlIGBuZy1tb2RlbGAgYXR0cmlidXRlLgogICAqCiAgICogTGFzdGx5LCBhbGwgdGhlIHJlZ2lzdGVyZWQgY2hhbmdlIGxpc3RlbmVycywgaW4gdGhlIGAkdmlld0NoYW5nZUxpc3RlbmVyc2AgbGlzdCwgYXJlIGNhbGxlZC4KICAgKgogICAqIEluIGNhc2UgdGhlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbE9wdGlvbnMgbmdNb2RlbE9wdGlvbnN9IGRpcmVjdGl2ZSBpcyB1c2VkIHdpdGggYHVwZGF0ZU9uYAogICAqIGFuZCB0aGUgYGRlZmF1bHRgIHRyaWdnZXIgaXMgbm90IGxpc3RlZCwgYWxsIHRob3NlIGFjdGlvbnMgd2lsbCByZW1haW4gcGVuZGluZyB1bnRpbCBvbmUgb2YgdGhlCiAgICogYHVwZGF0ZU9uYCBldmVudHMgaXMgdHJpZ2dlcmVkIG9uIHRoZSBET00gZWxlbWVudC4KICAgKiBBbGwgdGhlc2UgYWN0aW9ucyB3aWxsIGJlIGRlYm91bmNlZCBpZiB0aGUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ01vZGVsT3B0aW9ucyBuZ01vZGVsT3B0aW9uc30KICAgKiBkaXJlY3RpdmUgaXMgdXNlZCB3aXRoIGEgY3VzdG9tIGRlYm91bmNlIGZvciB0aGlzIHBhcnRpY3VsYXIgZXZlbnQuCiAgICoKICAgKiBOb3RlIHRoYXQgY2FsbGluZyB0aGlzIGZ1bmN0aW9uIGRvZXMgbm90IHRyaWdnZXIgYSBgJGRpZ2VzdGAuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgVmFsdWUgZnJvbSB0aGUgdmlldy4KICAgKiBAcGFyYW0ge3N0cmluZ30gdHJpZ2dlciBFdmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdXBkYXRlLgogICAqLwogIHRoaXMuJHNldFZpZXdWYWx1ZSA9IGZ1bmN0aW9uKHZhbHVlLCB0cmlnZ2VyKSB7CiAgICBjdHJsLiR2aWV3VmFsdWUgPSB2YWx1ZTsKICAgIGlmICghY3RybC4kb3B0aW9ucyB8fCBjdHJsLiRvcHRpb25zLnVwZGF0ZU9uRGVmYXVsdCkgewogICAgICBjdHJsLiQkZGVib3VuY2VWaWV3VmFsdWVDb21taXQodHJpZ2dlcik7CiAgICB9CiAgfTsKCiAgdGhpcy4kJGRlYm91bmNlVmlld1ZhbHVlQ29tbWl0ID0gZnVuY3Rpb24odHJpZ2dlcikgewogICAgdmFyIGRlYm91bmNlRGVsYXkgPSAwLAogICAgICAgIG9wdGlvbnMgPSBjdHJsLiRvcHRpb25zLAogICAgICAgIGRlYm91bmNlOwoKICAgIGlmIChvcHRpb25zICYmIGlzRGVmaW5lZChvcHRpb25zLmRlYm91bmNlKSkgewogICAgICBkZWJvdW5jZSA9IG9wdGlvbnMuZGVib3VuY2U7CiAgICAgIGlmIChpc051bWJlcihkZWJvdW5jZSkpIHsKICAgICAgICBkZWJvdW5jZURlbGF5ID0gZGVib3VuY2U7CiAgICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIoZGVib3VuY2VbdHJpZ2dlcl0pKSB7CiAgICAgICAgZGVib3VuY2VEZWxheSA9IGRlYm91bmNlW3RyaWdnZXJdOwogICAgICB9IGVsc2UgaWYgKGlzTnVtYmVyKGRlYm91bmNlWydkZWZhdWx0J10pKSB7CiAgICAgICAgZGVib3VuY2VEZWxheSA9IGRlYm91bmNlWydkZWZhdWx0J107CiAgICAgIH0KICAgIH0KCiAgICAkdGltZW91dC5jYW5jZWwocGVuZGluZ0RlYm91bmNlKTsKICAgIGlmIChkZWJvdW5jZURlbGF5KSB7CiAgICAgIHBlbmRpbmdEZWJvdW5jZSA9ICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGN0cmwuJGNvbW1pdFZpZXdWYWx1ZSgpOwogICAgICB9LCBkZWJvdW5jZURlbGF5KTsKICAgIH0gZWxzZSBpZiAoJHJvb3RTY29wZS4kJHBoYXNlKSB7CiAgICAgIGN0cmwuJGNvbW1pdFZpZXdWYWx1ZSgpOwogICAgfSBlbHNlIHsKICAgICAgJHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICBjdHJsLiRjb21taXRWaWV3VmFsdWUoKTsKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgLy8gbW9kZWwgLT4gdmFsdWUKICAvLyBOb3RlOiB3ZSBjYW5ub3QgdXNlIGEgbm9ybWFsIHNjb3BlLiR3YXRjaCBhcyB3ZSB3YW50IHRvIGRldGVjdCB0aGUgZm9sbG93aW5nOgogIC8vIDEuIHNjb3BlIHZhbHVlIGlzICdhJwogIC8vIDIuIHVzZXIgZW50ZXJzICdiJwogIC8vIDMuIG5nLWNoYW5nZSBraWNrcyBpbiBhbmQgcmV2ZXJ0cyBzY29wZSB2YWx1ZSB0byAnYScKICAvLyAgICAtPiBzY29wZSB2YWx1ZSBkaWQgbm90IGNoYW5nZSBzaW5jZSB0aGUgbGFzdCBkaWdlc3QgYXMKICAvLyAgICAgICBuZy1jaGFuZ2UgZXhlY3V0ZXMgaW4gYXBwbHkgcGhhc2UKICAvLyA0LiB2aWV3IHNob3VsZCBiZSBjaGFuZ2VkIGJhY2sgdG8gJ2EnCiAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbiBuZ01vZGVsV2F0Y2goKSB7CiAgICB2YXIgbW9kZWxWYWx1ZSA9IG5nTW9kZWxHZXQoKTsKCiAgICAvLyBpZiBzY29wZSBtb2RlbCB2YWx1ZSBhbmQgbmdNb2RlbCB2YWx1ZSBhcmUgb3V0IG9mIHN5bmMKICAgIC8vIFRPRE8ocGVyZik6IHdoeSBub3QgbW92ZSB0aGlzIHRvIHRoZSBhY3Rpb24gZm4/CiAgICBpZiAobW9kZWxWYWx1ZSAhPT0gY3RybC4kbW9kZWxWYWx1ZSkgewogICAgICBjdHJsLiRtb2RlbFZhbHVlID0gbW9kZWxWYWx1ZTsKCiAgICAgIHZhciBmb3JtYXR0ZXJzID0gY3RybC4kZm9ybWF0dGVycywKICAgICAgICAgIGlkeCA9IGZvcm1hdHRlcnMubGVuZ3RoOwoKICAgICAgdmFyIHZpZXdWYWx1ZSA9IG1vZGVsVmFsdWU7CiAgICAgIHdoaWxlKGlkeC0tKSB7CiAgICAgICAgdmlld1ZhbHVlID0gZm9ybWF0dGVyc1tpZHhdKHZpZXdWYWx1ZSk7CiAgICAgIH0KICAgICAgaWYgKGN0cmwuJHZpZXdWYWx1ZSAhPT0gdmlld1ZhbHVlKSB7CiAgICAgICAgY3RybC4kdmlld1ZhbHVlID0gY3RybC4kJGxhc3RDb21taXR0ZWRWaWV3VmFsdWUgPSB2aWV3VmFsdWU7CiAgICAgICAgY3RybC4kcmVuZGVyKCk7CgogICAgICAgIGN0cmwuJCRydW5WYWxpZGF0b3JzKHVuZGVmaW5lZCwgbW9kZWxWYWx1ZSwgdmlld1ZhbHVlLCBub29wKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBtb2RlbFZhbHVlOwogIH0pOwp9XTsKCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ01vZGVsCiAqCiAqIEBlbGVtZW50IGlucHV0CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nTW9kZWxgIGRpcmVjdGl2ZSBiaW5kcyBhbiBgaW5wdXRgLGBzZWxlY3RgLCBgdGV4dGFyZWFgIChvciBjdXN0b20gZm9ybSBjb250cm9sKSB0byBhCiAqIHByb3BlcnR5IG9uIHRoZSBzY29wZSB1c2luZyB7QGxpbmsgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciBOZ01vZGVsQ29udHJvbGxlcn0sCiAqIHdoaWNoIGlzIGNyZWF0ZWQgYW5kIGV4cG9zZWQgYnkgdGhpcyBkaXJlY3RpdmUuCiAqCiAqIGBuZ01vZGVsYCBpcyByZXNwb25zaWJsZSBmb3I6CiAqCiAqIC0gQmluZGluZyB0aGUgdmlldyBpbnRvIHRoZSBtb2RlbCwgd2hpY2ggb3RoZXIgZGlyZWN0aXZlcyBzdWNoIGFzIGBpbnB1dGAsIGB0ZXh0YXJlYWAgb3IgYHNlbGVjdGAKICogICByZXF1aXJlLgogKiAtIFByb3ZpZGluZyB2YWxpZGF0aW9uIGJlaGF2aW9yIChpLmUuIHJlcXVpcmVkLCBudW1iZXIsIGVtYWlsLCB1cmwpLgogKiAtIEtlZXBpbmcgdGhlIHN0YXRlIG9mIHRoZSBjb250cm9sICh2YWxpZC9pbnZhbGlkLCBkaXJ0eS9wcmlzdGluZSwgdG91Y2hlZC91bnRvdWNoZWQsIHZhbGlkYXRpb24gZXJyb3JzKS4KICogLSBTZXR0aW5nIHJlbGF0ZWQgY3NzIGNsYXNzZXMgb24gdGhlIGVsZW1lbnQgKGBuZy12YWxpZGAsIGBuZy1pbnZhbGlkYCwgYG5nLWRpcnR5YCwgYG5nLXByaXN0aW5lYCwgYG5nLXRvdWNoZWRgLCBgbmctdW50b3VjaGVkYCkgaW5jbHVkaW5nIGFuaW1hdGlvbnMuCiAqIC0gUmVnaXN0ZXJpbmcgdGhlIGNvbnRyb2wgd2l0aCBpdHMgcGFyZW50IHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBmb3JtfS4KICoKICogTm90ZTogYG5nTW9kZWxgIHdpbGwgdHJ5IHRvIGJpbmQgdG8gdGhlIHByb3BlcnR5IGdpdmVuIGJ5IGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24gb24gdGhlCiAqIGN1cnJlbnQgc2NvcGUuIElmIHRoZSBwcm9wZXJ0eSBkb2Vzbid0IGFscmVhZHkgZXhpc3Qgb24gdGhpcyBzY29wZSwgaXQgd2lsbCBiZSBjcmVhdGVkCiAqIGltcGxpY2l0bHkgYW5kIGFkZGVkIHRvIHRoZSBzY29wZS4KICoKICogRm9yIGJlc3QgcHJhY3RpY2VzIG9uIHVzaW5nIGBuZ01vZGVsYCwgc2VlOgogKgogKiAgLSBbaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy93aWtpL1VuZGVyc3RhbmRpbmctU2NvcGVzXQogKgogKiBGb3IgYmFzaWMgZXhhbXBsZXMsIGhvdyB0byB1c2UgYG5nTW9kZWxgLCBzZWU6CiAqCiAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQgaW5wdXR9CiAqICAgIC0ge0BsaW5rIGlucHV0W3RleHRdIHRleHR9CiAqICAgIC0ge0BsaW5rIGlucHV0W2NoZWNrYm94XSBjaGVja2JveH0KICogICAgLSB7QGxpbmsgaW5wdXRbcmFkaW9dIHJhZGlvfQogKiAgICAtIHtAbGluayBpbnB1dFtudW1iZXJdIG51bWJlcn0KICogICAgLSB7QGxpbmsgaW5wdXRbZW1haWxdIGVtYWlsfQogKiAgICAtIHtAbGluayBpbnB1dFt1cmxdIHVybH0KICogICAgLSB7QGxpbmsgaW5wdXRbZGF0ZV0gZGF0ZX0KICogICAgLSB7QGxpbmsgaW5wdXRbZGF0ZVRpbWVMb2NhbF0gZGF0ZVRpbWVMb2NhbH0KICogICAgLSB7QGxpbmsgaW5wdXRbdGltZV0gdGltZX0KICogICAgLSB7QGxpbmsgaW5wdXRbbW9udGhdIG1vbnRofQogKiAgICAtIHtAbGluayBpbnB1dFt3ZWVrXSB3ZWVrfQogKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOnNlbGVjdCBzZWxlY3R9CiAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6dGV4dGFyZWEgdGV4dGFyZWF9CiAqCiAqICMgQ1NTIGNsYXNzZXMKICogVGhlIGZvbGxvd2luZyBDU1MgY2xhc3NlcyBhcmUgYWRkZWQgYW5kIHJlbW92ZWQgb24gdGhlIGFzc29jaWF0ZWQgaW5wdXQvc2VsZWN0L3RleHRhcmVhIGVsZW1lbnQKICogZGVwZW5kaW5nIG9uIHRoZSB2YWxpZGl0eSBvZiB0aGUgbW9kZWwuCiAqCiAqICAtIGBuZy12YWxpZGAgaXMgc2V0IGlmIHRoZSBtb2RlbCBpcyB2YWxpZC4KICogIC0gYG5nLWludmFsaWRgIGlzIHNldCBpZiB0aGUgbW9kZWwgaXMgaW52YWxpZC4KICogIC0gYG5nLXByaXN0aW5lYCBpcyBzZXQgaWYgdGhlIG1vZGVsIGlzIHByaXN0aW5lLgogKiAgLSBgbmctZGlydHlgIGlzIHNldCBpZiB0aGUgbW9kZWwgaXMgZGlydHkuCiAqCiAqIEtlZXAgaW4gbWluZCB0aGF0IG5nQW5pbWF0ZSBjYW4gZGV0ZWN0IGVhY2ggb2YgdGhlc2UgY2xhc3NlcyB3aGVuIGFkZGVkIGFuZCByZW1vdmVkLgogKgogKiAjIyBBbmltYXRpb24gSG9va3MKICoKICogQW5pbWF0aW9ucyB3aXRoaW4gbW9kZWxzIGFyZSB0cmlnZ2VyZWQgd2hlbiBhbnkgb2YgdGhlIGFzc29jaWF0ZWQgQ1NTIGNsYXNzZXMgYXJlIGFkZGVkIGFuZCByZW1vdmVkCiAqIG9uIHRoZSBpbnB1dCBlbGVtZW50IHdoaWNoIGlzIGF0dGFjaGVkIHRvIHRoZSBtb2RlbC4gVGhlc2UgY2xhc3NlcyBhcmU6IGAubmctcHJpc3RpbmVgLCBgLm5nLWRpcnR5YCwKICogYC5uZy1pbnZhbGlkYCBhbmQgYC5uZy12YWxpZGAgYXMgd2VsbCBhcyBhbnkgb3RoZXIgdmFsaWRhdGlvbnMgdGhhdCBhcmUgcGVyZm9ybWVkIG9uIHRoZSBtb2RlbCBpdHNlbGYuCiAqIFRoZSBhbmltYXRpb25zIHRoYXQgYXJlIHRyaWdnZXJlZCB3aXRoaW4gbmdNb2RlbCBhcmUgc2ltaWxhciB0byBob3cgdGhleSB3b3JrIGluIG5nQ2xhc3MgYW5kCiAqIGFuaW1hdGlvbnMgY2FuIGJlIGhvb2tlZCBpbnRvIHVzaW5nIENTUyB0cmFuc2l0aW9ucywga2V5ZnJhbWVzIGFzIHdlbGwgYXMgSlMgYW5pbWF0aW9ucy4KICoKICogVGhlIGZvbGxvd2luZyBleGFtcGxlIHNob3dzIGEgc2ltcGxlIHdheSB0byB1dGlsaXplIENTUyB0cmFuc2l0aW9ucyB0byBzdHlsZSBhbiBpbnB1dCBlbGVtZW50CiAqIHRoYXQgaGFzIGJlZW4gcmVuZGVyZWQgYXMgaW52YWxpZCBhZnRlciBpdCBoYXMgYmVlbiB2YWxpZGF0ZWQ6CiAqCiAqIDxwcmU+CiAqIC8vYmUgc3VyZSB0byBpbmNsdWRlIG5nQW5pbWF0ZSBhcyBhIG1vZHVsZSB0byBob29rIGludG8gbW9yZQogKiAvL2FkdmFuY2VkIGFuaW1hdGlvbnMKICogLm15LWlucHV0IHsKICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICogfQogKiAubXktaW5wdXQubmctaW52YWxpZCB7CiAqICAgYmFja2dyb3VuZDogcmVkOwogKiAgIGNvbG9yOndoaXRlOwogKiB9CiAqIDwvcHJlPgogKgogKiBAZXhhbXBsZQogKiA8ZXhhbXBsZSBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiIGZpeEJhc2U9InRydWUiIG1vZHVsZT0iaW5wdXRFeGFtcGxlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgYW5ndWxhci5tb2R1bGUoJ2lucHV0RXhhbXBsZScsIFtdKQogICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLnZhbCA9ICcxJzsKICAgICAgICAgIH1dKTsKICAgICAgIDwvc2NyaXB0PgogICAgICAgPHN0eWxlPgogICAgICAgICAubXktaW5wdXQgewogICAgICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICAgdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7CiAgICAgICAgIH0KICAgICAgICAgLm15LWlucHV0Lm5nLWludmFsaWQgewogICAgICAgICAgIGNvbG9yOndoaXRlOwogICAgICAgICAgIGJhY2tncm91bmQ6IHJlZDsKICAgICAgICAgfQogICAgICAgPC9zdHlsZT4KICAgICAgIFVwZGF0ZSBpbnB1dCB0byBzZWUgdHJhbnNpdGlvbnMgd2hlbiB2YWxpZC9pbnZhbGlkLgogICAgICAgSW50ZWdlciBpcyBhIHZhbGlkIHZhbHVlLgogICAgICAgPGZvcm0gbmFtZT0idGVzdEZvcm0iIG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgPGlucHV0IG5nLW1vZGVsPSJ2YWwiIG5nLXBhdHRlcm49Ii9eXGQrJC8iIG5hbWU9ImFuaW0iIGNsYXNzPSJteS1pbnB1dCIgLz4KICAgICAgIDwvZm9ybT4KICAgICA8L2ZpbGU+CiAqIDwvZXhhbXBsZT4KICoKICogIyMgQmluZGluZyB0byBhIGdldHRlci9zZXR0ZXIKICoKICogU29tZXRpbWVzIGl0J3MgaGVscGZ1bCB0byBiaW5kIGBuZ01vZGVsYCB0byBhIGdldHRlci9zZXR0ZXIgZnVuY3Rpb24uICBBIGdldHRlci9zZXR0ZXIgaXMgYQogKiBmdW5jdGlvbiB0aGF0IHJldHVybnMgYSByZXByZXNlbnRhdGlvbiBvZiB0aGUgbW9kZWwgd2hlbiBjYWxsZWQgd2l0aCB6ZXJvIGFyZ3VtZW50cywgYW5kIHNldHMKICogdGhlIGludGVybmFsIHN0YXRlIG9mIGEgbW9kZWwgd2hlbiBjYWxsZWQgd2l0aCBhbiBhcmd1bWVudC4gSXQncyBzb21ldGltZXMgdXNlZnVsIHRvIHVzZSB0aGlzCiAqIGZvciBtb2RlbHMgdGhhdCBoYXZlIGFuIGludGVybmFsIHJlcHJlc2VudGF0aW9uIHRoYXQncyBkaWZmZXJlbnQgdGhhbiB3aGF0IHRoZSBtb2RlbCBleHBvc2VzCiAqIHRvIHRoZSB2aWV3LgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1zdWNjZXNzIj4KICogKipCZXN0IFByYWN0aWNlOioqIEl0J3MgYmVzdCB0byBrZWVwIGdldHRlcnMgZmFzdCBiZWNhdXNlIEFuZ3VsYXIgaXMgbGlrZWx5IHRvIGNhbGwgdGhlbSBtb3JlCiAqIGZyZXF1ZW50bHkgdGhhbiBvdGhlciBwYXJ0cyBvZiB5b3VyIGNvZGUuCiAqIDwvZGl2PgogKgogKiBZb3UgdXNlIHRoaXMgYmVoYXZpb3IgYnkgYWRkaW5nIGBuZy1tb2RlbC1vcHRpb25zPSJ7IGdldHRlclNldHRlcjogdHJ1ZSB9ImAgdG8gYW4gZWxlbWVudCB0aGF0CiAqIGhhcyBgbmctbW9kZWxgIGF0dGFjaGVkIHRvIGl0LiBZb3UgY2FuIGFsc28gYWRkIGBuZy1tb2RlbC1vcHRpb25zPSJ7IGdldHRlclNldHRlcjogdHJ1ZSB9ImAgdG8KICogYSBgPGZvcm0+YCwgd2hpY2ggd2lsbCBlbmFibGUgdGhpcyBiZWhhdmlvciBmb3IgYWxsIGA8aW5wdXQ+YHMgd2l0aGluIGl0LiBTZWUKICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ01vZGVsT3B0aW9ucyBgbmdNb2RlbE9wdGlvbnNgfSBmb3IgbW9yZS4KICoKICogVGhlIGZvbGxvd2luZyBleGFtcGxlIHNob3dzIGhvdyB0byB1c2UgYG5nTW9kZWxgIHdpdGggYSBnZXR0ZXIvc2V0dGVyOgogKgogKiBAZXhhbXBsZQogKiA8ZXhhbXBsZSBuYW1lPSJuZ01vZGVsLWdldHRlci1zZXR0ZXIiIG1vZHVsZT0iZ2V0dGVyU2V0dGVyRXhhbXBsZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgPGZvcm0gbmFtZT0idXNlckZvcm0iPgogICAgICAgICAgIE5hbWU6CiAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InVzZXJOYW1lIgogICAgICAgICAgICAgICAgICBuZy1tb2RlbD0idXNlci5uYW1lIgogICAgICAgICAgICAgICAgICBuZy1tb2RlbC1vcHRpb25zPSJ7IGdldHRlclNldHRlcjogdHJ1ZSB9IiAvPgogICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDxwcmU+dXNlci5uYW1lID0gPHNwYW4gbmctYmluZD0idXNlci5uYW1lKCkiPjwvc3Bhbj48L3ByZT4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJhcHAuanMiPgogICAgICAgYW5ndWxhci5tb2R1bGUoJ2dldHRlclNldHRlckV4YW1wbGUnLCBbXSkKICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICB2YXIgX25hbWUgPSAnQnJpYW4nOwogICAgICAgICAgICRzY29wZS51c2VyID0gewogICAgICAgICAgICAgbmFtZTogZnVuY3Rpb24gKG5ld05hbWUpIHsKICAgICAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKG5ld05hbWUpKSB7CiAgICAgICAgICAgICAgICAgX25hbWUgPSBuZXdOYW1lOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIHJldHVybiBfbmFtZTsKICAgICAgICAgICAgIH0KICAgICAgICAgICB9OwogICAgICAgICB9XSk7CiAgICAgPC9maWxlPgogKiA8L2V4YW1wbGU+CiAqLwp2YXIgbmdNb2RlbERpcmVjdGl2ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgcmVxdWlyZTogWyduZ01vZGVsJywgJ14/Zm9ybScsICdeP25nTW9kZWxPcHRpb25zJ10sCiAgICBjb250cm9sbGVyOiBOZ01vZGVsQ29udHJvbGxlciwKICAgIC8vIFByZWxpbmsgbmVlZHMgdG8gcnVuIGJlZm9yZSBhbnkgaW5wdXQgZGlyZWN0aXZlCiAgICAvLyBzbyB0aGF0IHdlIGNhbiBzZXQgdGhlIE5nTW9kZWxPcHRpb25zIGluIE5nTW9kZWxDb250cm9sbGVyCiAgICAvLyBiZWZvcmUgYW55b25lIGVsc2UgdXNlcyBpdC4KICAgIHByaW9yaXR5OiAxLAogICAgY29tcGlsZTogZnVuY3Rpb24gbmdNb2RlbENvbXBpbGUoZWxlbWVudCkgewogICAgICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpLmFkZENsYXNzKFVOVE9VQ0hFRF9DTEFTUykuYWRkQ2xhc3MoVkFMSURfQ0xBU1MpOwoKICAgICAgcmV0dXJuIHsKICAgICAgICBwcmU6IGZ1bmN0aW9uIG5nTW9kZWxQcmVMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJscykgewogICAgICAgICAgdmFyIG1vZGVsQ3RybCA9IGN0cmxzWzBdLAogICAgICAgICAgICAgIGZvcm1DdHJsID0gY3RybHNbMV0gfHwgbnVsbEZvcm1DdHJsOwoKICAgICAgICAgIG1vZGVsQ3RybC4kJHNldE9wdGlvbnMoY3RybHNbMl0gJiYgY3RybHNbMl0uJG9wdGlvbnMpOwoKICAgICAgICAgIC8vIG5vdGlmeSBvdGhlcnMsIGVzcGVjaWFsbHkgcGFyZW50IGZvcm1zCiAgICAgICAgICBmb3JtQ3RybC4kYWRkQ29udHJvbChtb2RlbEN0cmwpOwoKICAgICAgICAgIGF0dHIuJG9ic2VydmUoJ25hbWUnLCBmdW5jdGlvbihuZXdWYWx1ZSkgewogICAgICAgICAgICBpZiAobW9kZWxDdHJsLiRuYW1lICE9PSBuZXdWYWx1ZSkgewogICAgICAgICAgICAgIGZvcm1DdHJsLiQkcmVuYW1lQ29udHJvbChtb2RlbEN0cmwsIG5ld1ZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmb3JtQ3RybC4kcmVtb3ZlQ29udHJvbChtb2RlbEN0cmwpOwogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBwb3N0OiBmdW5jdGlvbiBuZ01vZGVsUG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmxzKSB7CiAgICAgICAgICB2YXIgbW9kZWxDdHJsID0gY3RybHNbMF07CiAgICAgICAgICBpZiAobW9kZWxDdHJsLiRvcHRpb25zICYmIG1vZGVsQ3RybC4kb3B0aW9ucy51cGRhdGVPbikgewogICAgICAgICAgICBlbGVtZW50Lm9uKG1vZGVsQ3RybC4kb3B0aW9ucy51cGRhdGVPbiwgZnVuY3Rpb24oZXYpIHsKICAgICAgICAgICAgICBtb2RlbEN0cmwuJCRkZWJvdW5jZVZpZXdWYWx1ZUNvbW1pdChldiAmJiBldi50eXBlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgZWxlbWVudC5vbignYmx1cicsIGZ1bmN0aW9uKGV2KSB7CiAgICAgICAgICAgIGlmIChtb2RlbEN0cmwuJHRvdWNoZWQpIHJldHVybjsKCiAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBtb2RlbEN0cmwuJHNldFRvdWNoZWQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfTsKfTsKCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0NoYW5nZQogKgogKiBAZGVzY3JpcHRpb24KICogRXZhbHVhdGUgdGhlIGdpdmVuIGV4cHJlc3Npb24gd2hlbiB0aGUgdXNlciBjaGFuZ2VzIHRoZSBpbnB1dC4KICogVGhlIGV4cHJlc3Npb24gaXMgZXZhbHVhdGVkIGltbWVkaWF0ZWx5LCB1bmxpa2UgdGhlIEphdmFTY3JpcHQgb25jaGFuZ2UgZXZlbnQKICogd2hpY2ggb25seSB0cmlnZ2VycyBhdCB0aGUgZW5kIG9mIGEgY2hhbmdlICh1c3VhbGx5LCB3aGVuIHRoZSB1c2VyIGxlYXZlcyB0aGUKICogZm9ybSBlbGVtZW50IG9yIHByZXNzZXMgdGhlIHJldHVybiBrZXkpLgogKgogKiBUaGUgYG5nQ2hhbmdlYCBleHByZXNzaW9uIGlzIG9ubHkgZXZhbHVhdGVkIHdoZW4gYSBjaGFuZ2UgaW4gdGhlIGlucHV0IHZhbHVlIGNhdXNlcwogKiBhIG5ldyB2YWx1ZSB0byBiZSBjb21taXR0ZWQgdG8gdGhlIG1vZGVsLgogKgogKiBJdCB3aWxsIG5vdCBiZSBldmFsdWF0ZWQ6CiAqICogaWYgdGhlIHZhbHVlIHJldHVybmVkIGZyb20gdGhlIGAkcGFyc2Vyc2AgdHJhbnNmb3JtYXRpb24gcGlwZWxpbmUgaGFzIG5vdCBjaGFuZ2VkCiAqICogaWYgdGhlIGlucHV0IGhhcyBjb250aW51ZWQgdG8gYmUgaW52YWxpZCBzaW5jZSB0aGUgbW9kZWwgd2lsbCBzdGF5IGBudWxsYAogKiAqIGlmIHRoZSBtb2RlbCBpcyBjaGFuZ2VkIHByb2dyYW1tYXRpY2FsbHkgYW5kIG5vdCBieSBhIGNoYW5nZSB0byB0aGUgaW5wdXQgdmFsdWUKICoKICoKICogTm90ZSwgdGhpcyBkaXJlY3RpdmUgcmVxdWlyZXMgYG5nTW9kZWxgIHRvIGJlIHByZXNlbnQuCiAqCiAqIEBlbGVtZW50IGlucHV0CiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDaGFuZ2Uge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbiBjaGFuZ2UKICogaW4gaW5wdXQgdmFsdWUuCiAqCiAqIEBleGFtcGxlCiAqIDxleGFtcGxlIG5hbWU9Im5nQ2hhbmdlLWRpcmVjdGl2ZSIgbW9kdWxlPSJjaGFuZ2VFeGFtcGxlIj4KICogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICogICAgIDxzY3JpcHQ+CiAqICAgICAgIGFuZ3VsYXIubW9kdWxlKCdjaGFuZ2VFeGFtcGxlJywgW10pCiAqICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICogICAgICAgICAgICRzY29wZS5jb3VudGVyID0gMDsKICogICAgICAgICAgICRzY29wZS5jaGFuZ2UgPSBmdW5jdGlvbigpIHsKICogICAgICAgICAgICAgJHNjb3BlLmNvdW50ZXIrKzsKICogICAgICAgICAgIH07CiAqICAgICAgICAgfV0pOwogKiAgICAgPC9zY3JpcHQ+CiAqICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICogICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY29uZmlybWVkIiBuZy1jaGFuZ2U9ImNoYW5nZSgpIiBpZD0ibmctY2hhbmdlLWV4YW1wbGUxIiAvPgogKiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjb25maXJtZWQiIGlkPSJuZy1jaGFuZ2UtZXhhbXBsZTIiIC8+CiAqICAgICAgIDxsYWJlbCBmb3I9Im5nLWNoYW5nZS1leGFtcGxlMiI+Q29uZmlybWVkPC9sYWJlbD48YnIgLz4KICogICAgICAgPHR0PmRlYnVnID0ge3tjb25maXJtZWR9fTwvdHQ+PGJyLz4KICogICAgICAgPHR0PmNvdW50ZXIgPSB7e2NvdW50ZXJ9fTwvdHQ+PGJyLz4KICogICAgIDwvZGl2PgogKiAgIDwvZmlsZT4KICogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICogICAgIHZhciBjb3VudGVyID0gZWxlbWVudChieS5iaW5kaW5nKCdjb3VudGVyJykpOwogKiAgICAgdmFyIGRlYnVnID0gZWxlbWVudChieS5iaW5kaW5nKCdjb25maXJtZWQnKSk7CiAqCiAqICAgICBpdCgnc2hvdWxkIGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gdmlldycsIGZ1bmN0aW9uKCkgewogKiAgICAgICBleHBlY3QoY291bnRlci5nZXRUZXh0KCkpLnRvQ29udGFpbignMCcpOwogKgogKiAgICAgICBlbGVtZW50KGJ5LmlkKCduZy1jaGFuZ2UtZXhhbXBsZTEnKSkuY2xpY2soKTsKICoKICogICAgICAgZXhwZWN0KGNvdW50ZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJzEnKTsKICogICAgICAgZXhwZWN0KGRlYnVnLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAqICAgICB9KTsKICoKICogICAgIGl0KCdzaG91bGQgbm90IGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gbW9kZWwnLCBmdW5jdGlvbigpIHsKICogICAgICAgZWxlbWVudChieS5pZCgnbmctY2hhbmdlLWV4YW1wbGUyJykpLmNsaWNrKCk7CgogKiAgICAgICBleHBlY3QoY291bnRlci5nZXRUZXh0KCkpLnRvQ29udGFpbignMCcpOwogKiAgICAgICBleHBlY3QoZGVidWcuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICogICAgIH0pOwogKiAgIDwvZmlsZT4KICogPC9leGFtcGxlPgogKi8KdmFyIG5nQ2hhbmdlRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgcmVzdHJpY3Q6ICdBJywKICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgIGN0cmwuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMucHVzaChmdW5jdGlvbigpIHsKICAgICAgc2NvcGUuJGV2YWwoYXR0ci5uZ0NoYW5nZSk7CiAgICB9KTsKICB9Cn0pOwoKCnZhciByZXF1aXJlZERpcmVjdGl2ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbG0sIGF0dHIsIGN0cmwpIHsKICAgICAgaWYgKCFjdHJsKSByZXR1cm47CiAgICAgIGF0dHIucmVxdWlyZWQgPSB0cnVlOyAvLyBmb3JjZSB0cnV0aHkgaW4gY2FzZSB3ZSBhcmUgb24gbm9uIGlucHV0IGVsZW1lbnQKCiAgICAgIGN0cmwuJHZhbGlkYXRvcnMucmVxdWlyZWQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiAhYXR0ci5yZXF1aXJlZCB8fCAhY3RybC4kaXNFbXB0eSh2YWx1ZSk7CiAgICAgIH07CgogICAgICBhdHRyLiRvYnNlcnZlKCdyZXF1aXJlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgIGN0cmwuJHZhbGlkYXRlKCk7CiAgICAgIH0pOwogICAgfQogIH07Cn07CgoKdmFyIHBhdHRlcm5EaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdBJywKICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxtLCBhdHRyLCBjdHJsKSB7CiAgICAgIGlmICghY3RybCkgcmV0dXJuOwoKICAgICAgdmFyIHJlZ2V4cCwgcGF0dGVybkV4cCA9IGF0dHIubmdQYXR0ZXJuIHx8IGF0dHIucGF0dGVybjsKICAgICAgYXR0ci4kb2JzZXJ2ZSgncGF0dGVybicsIGZ1bmN0aW9uKHJlZ2V4KSB7CiAgICAgICAgaWYgKGlzU3RyaW5nKHJlZ2V4KSAmJiByZWdleC5sZW5ndGggPiAwKSB7CiAgICAgICAgICByZWdleCA9IG5ldyBSZWdFeHAocmVnZXgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHJlZ2V4ICYmICFyZWdleC50ZXN0KSB7CiAgICAgICAgICB0aHJvdyBtaW5FcnIoJ25nUGF0dGVybicpKCdub3JlZ2V4cCcsCiAgICAgICAgICAgICdFeHBlY3RlZCB7MH0gdG8gYmUgYSBSZWdFeHAgYnV0IHdhcyB7MX0uIEVsZW1lbnQ6IHsyfScsIHBhdHRlcm5FeHAsCiAgICAgICAgICAgIHJlZ2V4LCBzdGFydGluZ1RhZyhlbG0pKTsKICAgICAgICB9CgogICAgICAgIHJlZ2V4cCA9IHJlZ2V4IHx8IHVuZGVmaW5lZDsKICAgICAgICBjdHJsLiR2YWxpZGF0ZSgpOwogICAgICB9KTsKCiAgICAgIGN0cmwuJHZhbGlkYXRvcnMucGF0dGVybiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IGlzVW5kZWZpbmVkKHJlZ2V4cCkgfHwgcmVnZXhwLnRlc3QodmFsdWUpOwogICAgICB9OwogICAgfQogIH07Cn07CgoKdmFyIG1heGxlbmd0aERpcmVjdGl2ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbG0sIGF0dHIsIGN0cmwpIHsKICAgICAgaWYgKCFjdHJsKSByZXR1cm47CgogICAgICB2YXIgbWF4bGVuZ3RoID0gMDsKICAgICAgYXR0ci4kb2JzZXJ2ZSgnbWF4bGVuZ3RoJywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBtYXhsZW5ndGggPSBpbnQodmFsdWUpIHx8IDA7CiAgICAgICAgY3RybC4kdmFsaWRhdGUoKTsKICAgICAgfSk7CiAgICAgIGN0cmwuJHZhbGlkYXRvcnMubWF4bGVuZ3RoID0gZnVuY3Rpb24obW9kZWxWYWx1ZSwgdmlld1ZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGN0cmwuJGlzRW1wdHkobW9kZWxWYWx1ZSkgfHwgdmlld1ZhbHVlLmxlbmd0aCA8PSBtYXhsZW5ndGg7CiAgICAgIH07CiAgICB9CiAgfTsKfTsKCnZhciBtaW5sZW5ndGhEaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdBJywKICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxtLCBhdHRyLCBjdHJsKSB7CiAgICAgIGlmICghY3RybCkgcmV0dXJuOwoKICAgICAgdmFyIG1pbmxlbmd0aCA9IDA7CiAgICAgIGF0dHIuJG9ic2VydmUoJ21pbmxlbmd0aCcsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgbWlubGVuZ3RoID0gaW50KHZhbHVlKSB8fCAwOwogICAgICAgIGN0cmwuJHZhbGlkYXRlKCk7CiAgICAgIH0pOwogICAgICBjdHJsLiR2YWxpZGF0b3JzLm1pbmxlbmd0aCA9IGZ1bmN0aW9uKG1vZGVsVmFsdWUsIHZpZXdWYWx1ZSkgewogICAgICAgIHJldHVybiBjdHJsLiRpc0VtcHR5KG1vZGVsVmFsdWUpIHx8IHZpZXdWYWx1ZS5sZW5ndGggPj0gbWlubGVuZ3RoOwogICAgICB9OwogICAgfQogIH07Cn07CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdMaXN0CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUZXh0IGlucHV0IHRoYXQgY29udmVydHMgYmV0d2VlbiBhIGRlbGltaXRlZCBzdHJpbmcgYW5kIGFuIGFycmF5IG9mIHN0cmluZ3MuIFRoZSBkZWZhdWx0CiAqIGRlbGltaXRlciBpcyBhIGNvbW1hIGZvbGxvd2VkIGJ5IGEgc3BhY2UgLSBlcXVpdmFsZW50IHRvIGBuZy1saXN0PSIsICJgLiBZb3UgY2FuIHNwZWNpZnkgYSBjdXN0b20KICogZGVsaW1pdGVyIGFzIHRoZSB2YWx1ZSBvZiB0aGUgYG5nTGlzdGAgYXR0cmlidXRlIC0gZm9yIGV4YW1wbGUsIGBuZy1saXN0PSIgfCAiYC4KICoKICogVGhlIGJlaGF2aW91ciBvZiB0aGUgZGlyZWN0aXZlIGlzIGFmZmVjdGVkIGJ5IHRoZSB1c2Ugb2YgdGhlIGBuZ1RyaW1gIGF0dHJpYnV0ZS4KICogKiBJZiBgbmdUcmltYCBpcyBzZXQgdG8gYCJmYWxzZSJgIHRoZW4gd2hpdGVzcGFjZSBhcm91bmQgYm90aCB0aGUgc2VwYXJhdG9yIGFuZCBlYWNoCiAqICAgbGlzdCBpdGVtIGlzIHJlc3BlY3RlZC4gVGhpcyBpbXBsaWVzIHRoYXQgdGhlIHVzZXIgb2YgdGhlIGRpcmVjdGl2ZSBpcyByZXNwb25zaWJsZSBmb3IKICogICBkZWFsaW5nIHdpdGggd2hpdGVzcGFjZSBidXQgYWxzbyBhbGxvd3MgeW91IHRvIHVzZSB3aGl0ZXNwYWNlIGFzIGEgZGVsaW1pdGVyLCBzdWNoIGFzIGEKICogICB0YWIgb3IgbmV3bGluZSBjaGFyYWN0ZXIuCiAqICogT3RoZXJ3aXNlIHdoaXRlc3BhY2UgYXJvdW5kIHRoZSBkZWxpbWl0ZXIgaXMgaWdub3JlZCB3aGVuIHNwbGl0dGluZyAoYWx0aG91Z2ggaXQgaXMgcmVzcGVjdGVkCiAqICAgd2hlbiBqb2luaW5nIHRoZSBsaXN0IGl0ZW1zIGJhY2sgdG9nZXRoZXIpIGFuZCB3aGl0ZXNwYWNlIGFyb3VuZCBlYWNoIGxpc3QgaXRlbSBpcyBzdHJpcHBlZAogKiAgIGJlZm9yZSBpdCBpcyBhZGRlZCB0byB0aGUgbW9kZWwuCiAqCiAqICMjIyBFeGFtcGxlIHdpdGggVmFsaWRhdGlvbgogKgogKiA8ZXhhbXBsZSBuYW1lPSJuZ0xpc3QtZGlyZWN0aXZlIiBtb2R1bGU9Imxpc3RFeGFtcGxlIj4KICogICA8ZmlsZSBuYW1lPSJhcHAuanMiPgogKiAgICAgIGFuZ3VsYXIubW9kdWxlKCdsaXN0RXhhbXBsZScsIFtdKQogKiAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICogICAgICAgICAgJHNjb3BlLm5hbWVzID0gWydtb3JwaGV1cycsICduZW8nLCAndHJpbml0eSddOwogKiAgICAgICAgfV0pOwogKiAgIDwvZmlsZT4KICogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICogICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAqICAgICAgTGlzdDogPGlucHV0IG5hbWU9Im5hbWVzSW5wdXQiIG5nLW1vZGVsPSJuYW1lcyIgbmctbGlzdCByZXF1aXJlZD4KICogICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5uYW1lc0lucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAqICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAqICAgICAgPGJyPgogKiAgICAgIDx0dD5uYW1lcyA9IHt7bmFtZXN9fTwvdHQ+PGJyLz4KICogICAgICA8dHQ+bXlGb3JtLm5hbWVzSW5wdXQuJHZhbGlkID0ge3tteUZvcm0ubmFtZXNJbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICogICAgICA8dHQ+bXlGb3JtLm5hbWVzSW5wdXQuJGVycm9yID0ge3tteUZvcm0ubmFtZXNJbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICogICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogKiAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICogICAgIDwvZm9ybT4KICogICA8L2ZpbGU+CiAqICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAqICAgICB2YXIgbGlzdElucHV0ID0gZWxlbWVudChieS5tb2RlbCgnbmFtZXMnKSk7CiAqICAgICB2YXIgbmFtZXMgPSBlbGVtZW50KGJ5LmV4YWN0QmluZGluZygnbmFtZXMnKSk7CiAqICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCcpKTsKICogICAgIHZhciBlcnJvciA9IGVsZW1lbnQoYnkuY3NzKCdzcGFuLmVycm9yJykpOwogKgogKiAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAqICAgICAgIGV4cGVjdChuYW1lcy5nZXRUZXh0KCkpLnRvQ29udGFpbignWyJtb3JwaGV1cyIsIm5lbyIsInRyaW5pdHkiXScpOwogKiAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICogICAgICAgZXhwZWN0KGVycm9yLmdldENzc1ZhbHVlKCdkaXNwbGF5JykpLnRvQmUoJ25vbmUnKTsKICogICAgIH0pOwogKgogKiAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAqICAgICAgIGxpc3RJbnB1dC5jbGVhcigpOwogKiAgICAgICBsaXN0SW5wdXQuc2VuZEtleXMoJycpOwogKgogKiAgICAgICBleHBlY3QobmFtZXMuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJycpOwogKiAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAqICAgICAgIGV4cGVjdChlcnJvci5nZXRDc3NWYWx1ZSgnZGlzcGxheScpKS5ub3QudG9CZSgnbm9uZScpOwogKiAgICAgfSk7CiAqICAgPC9maWxlPgogKiA8L2V4YW1wbGU+CiAqCiAqICMjIyBFeGFtcGxlIC0gc3BsaXR0aW5nIG9uIHdoaXRlc3BhY2UKICogPGV4YW1wbGUgbmFtZT0ibmdMaXN0LWRpcmVjdGl2ZS1uZXdsaW5lcyI+CiAqICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAqICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0ibGlzdCIgbmctbGlzdD0iJiMxMDsiIG5nLXRyaW09ImZhbHNlIj48L3RleHRhcmVhPgogKiAgICA8cHJlPnt7IGxpc3QgfCBqc29uIH19PC9wcmU+CiAqICAgPC9maWxlPgogKiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogKiAgICAgaXQoInNob3VsZCBzcGxpdCB0aGUgdGV4dCBieSBuZXdsaW5lcyIsIGZ1bmN0aW9uKCkgewogKiAgICAgICB2YXIgbGlzdElucHV0ID0gZWxlbWVudChieS5tb2RlbCgnbGlzdCcpKTsKICogICAgICAgdmFyIG91dHB1dCA9IGVsZW1lbnQoYnkuYmluZGluZygnbGlzdCB8IGpzb24nKSk7CiAqICAgICAgIGxpc3RJbnB1dC5zZW5kS2V5cygnYWJjXG5kZWZcbmdoaScpOwogKiAgICAgICBleHBlY3Qob3V0cHV0LmdldFRleHQoKSkudG9Db250YWluKCdbXG4gICJhYmMiLFxuICAiZGVmIixcbiAgImdoaSJcbl0nKTsKICogICAgIH0pOwogKiAgIDwvZmlsZT4KICogPC9leGFtcGxlPgogKgogKiBAZWxlbWVudCBpbnB1dAogKiBAcGFyYW0ge3N0cmluZz19IG5nTGlzdCBvcHRpb25hbCBkZWxpbWl0ZXIgdGhhdCBzaG91bGQgYmUgdXNlZCB0byBzcGxpdCB0aGUgdmFsdWUuCiAqLwp2YXIgbmdMaXN0RGlyZWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnQScsCiAgICBwcmlvcml0eTogMTAwLAogICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgLy8gV2Ugd2FudCB0byBjb250cm9sIHdoaXRlc3BhY2UgdHJpbW1pbmcgc28gd2UgdXNlIHRoaXMgY29udm9sdXRlZCBhcHByb2FjaAogICAgICAvLyB0byBhY2Nlc3MgdGhlIG5nTGlzdCBhdHRyaWJ1dGUsIHdoaWNoIGRvZXNuJ3QgcHJlLXRyaW0gdGhlIGF0dHJpYnV0ZQogICAgICB2YXIgbmdMaXN0ID0gZWxlbWVudC5hdHRyKGF0dHIuJGF0dHIubmdMaXN0KSB8fCAnLCAnOwogICAgICB2YXIgdHJpbVZhbHVlcyA9IGF0dHIubmdUcmltICE9PSAnZmFsc2UnOwogICAgICB2YXIgc2VwYXJhdG9yID0gdHJpbVZhbHVlcyA/IHRyaW0obmdMaXN0KSA6IG5nTGlzdDsKCiAgICAgIHZhciBwYXJzZSA9IGZ1bmN0aW9uKHZpZXdWYWx1ZSkgewogICAgICAgIC8vIElmIHRoZSB2aWV3VmFsdWUgaXMgaW52YWxpZCAoc2F5IHJlcXVpcmVkIGJ1dCBlbXB0eSkgaXQgd2lsbCBiZSBgdW5kZWZpbmVkYAogICAgICAgIGlmIChpc1VuZGVmaW5lZCh2aWV3VmFsdWUpKSByZXR1cm47CgogICAgICAgIHZhciBsaXN0ID0gW107CgogICAgICAgIGlmICh2aWV3VmFsdWUpIHsKICAgICAgICAgIGZvckVhY2godmlld1ZhbHVlLnNwbGl0KHNlcGFyYXRvciksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgbGlzdC5wdXNoKHRyaW1WYWx1ZXMgPyB0cmltKHZhbHVlKSA6IHZhbHVlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGxpc3Q7CiAgICAgIH07CgogICAgICBjdHJsLiRwYXJzZXJzLnB1c2gocGFyc2UpOwogICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZS5qb2luKG5nTGlzdCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICB9KTsKCiAgICAgIC8vIE92ZXJyaWRlIHRoZSBzdGFuZGFyZCAkaXNFbXB0eSBiZWNhdXNlIGFuIGVtcHR5IGFycmF5IG1lYW5zIHRoZSBpbnB1dCBpcyBlbXB0eS4KICAgICAgY3RybC4kaXNFbXB0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuICF2YWx1ZSB8fCAhdmFsdWUubGVuZ3RoOwogICAgICB9OwogICAgfQogIH07Cn07CgoKdmFyIENPTlNUQU5UX1ZBTFVFX1JFR0VYUCA9IC9eKHRydWV8ZmFsc2V8XGQrKSQvOwovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1ZhbHVlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBCaW5kcyB0aGUgZ2l2ZW4gZXhwcmVzc2lvbiB0byB0aGUgdmFsdWUgb2YgYGlucHV0W3NlbGVjdF1gIG9yIGBpbnB1dFtyYWRpb11gLCBzbwogKiB0aGF0IHdoZW4gdGhlIGVsZW1lbnQgaXMgc2VsZWN0ZWQsIHRoZSBgbmdNb2RlbGAgb2YgdGhhdCBlbGVtZW50IGlzIHNldCB0byB0aGUKICogYm91bmQgdmFsdWUuCiAqCiAqIGBuZ1ZhbHVlYCBpcyB1c2VmdWwgd2hlbiBkeW5hbWljYWxseSBnZW5lcmF0aW5nIGxpc3RzIG9mIHJhZGlvIGJ1dHRvbnMgdXNpbmcgYG5nLXJlcGVhdGAsIGFzCiAqIHNob3duIGJlbG93LgogKgogKiBAZWxlbWVudCBpbnB1dAogKiBAcGFyYW0ge3N0cmluZz19IG5nVmFsdWUgYW5ndWxhciBleHByZXNzaW9uLCB3aG9zZSB2YWx1ZSB3aWxsIGJlIGJvdW5kIHRvIHRoZSBgdmFsdWVgIGF0dHJpYnV0ZQogKiAgIG9mIHRoZSBgaW5wdXRgIGVsZW1lbnQKICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlIG5hbWU9Im5nVmFsdWUtZGlyZWN0aXZlIiBtb2R1bGU9InZhbHVlRXhhbXBsZSI+CiAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCd2YWx1ZUV4YW1wbGUnLCBbXSkKICAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgICAkc2NvcGUubmFtZXMgPSBbJ3BpenphJywgJ3VuaWNvcm5zJywgJ3JvYm90cyddOwogICAgICAgICAgICAgICRzY29wZS5teSA9IHsgZmF2b3JpdGU6ICd1bmljb3JucycgfTsKICAgICAgICAgICAgfV0pOwogICAgICAgPC9zY3JpcHQ+CiAgICAgICAgPGZvcm0gbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgICAgPGgyPldoaWNoIGlzIHlvdXIgZmF2b3JpdGU/PC9oMj4KICAgICAgICAgICAgPGxhYmVsIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyIgZm9yPSJ7e25hbWV9fSI+CiAgICAgICAgICAgICAge3tuYW1lfX0KICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iCiAgICAgICAgICAgICAgICAgICAgIG5nLW1vZGVsPSJteS5mYXZvcml0ZSIKICAgICAgICAgICAgICAgICAgICAgbmctdmFsdWU9Im5hbWUiCiAgICAgICAgICAgICAgICAgICAgIGlkPSJ7e25hbWV9fSIKICAgICAgICAgICAgICAgICAgICAgbmFtZT0iZmF2b3JpdGUiPgogICAgICAgICAgICA8L2xhYmVsPgogICAgICAgICAgPGRpdj5Zb3UgY2hvc2Uge3tteS5mYXZvcml0ZX19PC9kaXY+CiAgICAgICAgPC9mb3JtPgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIHZhciBmYXZvcml0ZSA9IGVsZW1lbnQoYnkuYmluZGluZygnbXkuZmF2b3JpdGUnKSk7CgogICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGZhdm9yaXRlLmdldFRleHQoKSkudG9Db250YWluKCd1bmljb3JucycpOwogICAgICAgIH0pOwogICAgICAgIGl0KCdzaG91bGQgYmluZCB0aGUgdmFsdWVzIHRvIHRoZSBpbnB1dHMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQuYWxsKGJ5Lm1vZGVsKCdteS5mYXZvcml0ZScpKS5nZXQoMCkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChmYXZvcml0ZS5nZXRUZXh0KCkpLnRvQ29udGFpbigncGl6emEnKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KdmFyIG5nVmFsdWVEaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdBJywKICAgIHByaW9yaXR5OiAxMDAsCiAgICBjb21waWxlOiBmdW5jdGlvbih0cGwsIHRwbEF0dHIpIHsKICAgICAgaWYgKENPTlNUQU5UX1ZBTFVFX1JFR0VYUC50ZXN0KHRwbEF0dHIubmdWYWx1ZSkpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gbmdWYWx1ZUNvbnN0YW50TGluayhzY29wZSwgZWxtLCBhdHRyKSB7CiAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgc2NvcGUuJGV2YWwoYXR0ci5uZ1ZhbHVlKSk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gbmdWYWx1ZUxpbmsoc2NvcGUsIGVsbSwgYXR0cikgewogICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdWYWx1ZSwgZnVuY3Rpb24gdmFsdWVXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgdmFsdWUpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgfQogICAgfQogIH07Cn07CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ01vZGVsT3B0aW9ucwogKgogKiBAZGVzY3JpcHRpb24KICogQWxsb3dzIHR1bmluZyBob3cgbW9kZWwgdXBkYXRlcyBhcmUgZG9uZS4gVXNpbmcgYG5nTW9kZWxPcHRpb25zYCB5b3UgY2FuIHNwZWNpZnkgYSBjdXN0b20gbGlzdCBvZgogKiBldmVudHMgdGhhdCB3aWxsIHRyaWdnZXIgYSBtb2RlbCB1cGRhdGUgYW5kL29yIGEgZGVib3VuY2luZyBkZWxheSBzbyB0aGF0IHRoZSBhY3R1YWwgdXBkYXRlIG9ubHkKICogdGFrZXMgcGxhY2Ugd2hlbiBhIHRpbWVyIGV4cGlyZXM7IHRoaXMgdGltZXIgd2lsbCBiZSByZXNldCBhZnRlciBhbm90aGVyIGNoYW5nZSB0YWtlcyBwbGFjZS4KICoKICogR2l2ZW4gdGhlIG5hdHVyZSBvZiBgbmdNb2RlbE9wdGlvbnNgLCB0aGUgdmFsdWUgZGlzcGxheWVkIGluc2lkZSBpbnB1dCBmaWVsZHMgaW4gdGhlIHZpZXcgbWlnaHQKICogYmUgZGlmZmVyZW50IHRoYW4gdGhlIHZhbHVlIGluIHRoZSBhY3R1YWwgbW9kZWwuIFRoaXMgbWVhbnMgdGhhdCBpZiB5b3UgdXBkYXRlIHRoZSBtb2RlbCB5b3UKICogc2hvdWxkIGFsc28gaW52b2tlIHtAbGluayBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIGAkcm9sbGJhY2tWaWV3VmFsdWVgfSBvbiB0aGUgcmVsZXZhbnQgaW5wdXQgZmllbGQgaW4KICogb3JkZXIgdG8gbWFrZSBzdXJlIGl0IGlzIHN5bmNocm9uaXplZCB3aXRoIHRoZSBtb2RlbCBhbmQgdGhhdCBhbnkgZGVib3VuY2VkIGFjdGlvbiBpcyBjYW5jZWxlZC4KICoKICogVGhlIGVhc2llc3Qgd2F5IHRvIHJlZmVyZW5jZSB0aGUgY29udHJvbCdzIHtAbGluayBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIGAkcm9sbGJhY2tWaWV3VmFsdWVgfQogKiBtZXRob2QgaXMgYnkgbWFraW5nIHN1cmUgdGhlIGlucHV0IGlzIHBsYWNlZCBpbnNpZGUgYSBmb3JtIHRoYXQgaGFzIGEgYG5hbWVgIGF0dHJpYnV0ZS4gVGhpcyBpcwogKiBpbXBvcnRhbnQgYmVjYXVzZSBgZm9ybWAgY29udHJvbGxlcnMgYXJlIHB1Ymxpc2hlZCB0byB0aGUgcmVsYXRlZCBzY29wZSB1bmRlciB0aGUgbmFtZSBpbiB0aGVpcgogKiBgbmFtZWAgYXR0cmlidXRlLgogKgogKiBBbnkgcGVuZGluZyBjaGFuZ2VzIHdpbGwgdGFrZSBwbGFjZSBpbW1lZGlhdGVseSB3aGVuIGFuIGVuY2xvc2luZyBmb3JtIGlzIHN1Ym1pdHRlZCB2aWEgdGhlCiAqIGBzdWJtaXRgIGV2ZW50LiBOb3RlIHRoYXQgYG5nQ2xpY2tgIGV2ZW50cyB3aWxsIG9jY3VyIGJlZm9yZSB0aGUgbW9kZWwgaXMgdXBkYXRlZC4gVXNlIGBuZ1N1Ym1pdGAKICogdG8gaGF2ZSBhY2Nlc3MgdG8gdGhlIHVwZGF0ZWQgbW9kZWwuCiAqCiAqIGBuZ01vZGVsT3B0aW9uc2AgaGFzIGFuIGVmZmVjdCBvbiB0aGUgZWxlbWVudCBpdCdzIGRlY2xhcmVkIG9uIGFuZCBpdHMgZGVzY2VuZGFudHMuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBuZ01vZGVsT3B0aW9ucyBvcHRpb25zIHRvIGFwcGx5IHRvIHRoZSBjdXJyZW50IG1vZGVsLiBWYWxpZCBrZXlzIGFyZToKICogICAtIGB1cGRhdGVPbmA6IHN0cmluZyBzcGVjaWZ5aW5nIHdoaWNoIGV2ZW50IHNob3VsZCBiZSB0aGUgaW5wdXQgYm91bmQgdG8uIFlvdSBjYW4gc2V0IHNldmVyYWwKICogICAgIGV2ZW50cyB1c2luZyBhbiBzcGFjZSBkZWxpbWl0ZWQgbGlzdC4gVGhlcmUgaXMgYSBzcGVjaWFsIGV2ZW50IGNhbGxlZCBgZGVmYXVsdGAgdGhhdAogKiAgICAgbWF0Y2hlcyB0aGUgZGVmYXVsdCBldmVudHMgYmVsb25naW5nIG9mIHRoZSBjb250cm9sLgogKiAgIC0gYGRlYm91bmNlYDogaW50ZWdlciB2YWx1ZSB3aGljaCBjb250YWlucyB0aGUgZGVib3VuY2UgbW9kZWwgdXBkYXRlIHZhbHVlIGluIG1pbGxpc2Vjb25kcy4gQQogKiAgICAgdmFsdWUgb2YgMCB0cmlnZ2VycyBhbiBpbW1lZGlhdGUgdXBkYXRlLiBJZiBhbiBvYmplY3QgaXMgc3VwcGxpZWQgaW5zdGVhZCwgeW91IGNhbiBzcGVjaWZ5IGEKICogICAgIGN1c3RvbSB2YWx1ZSBmb3IgZWFjaCBldmVudC4gRm9yIGV4YW1wbGU6CiAqICAgICBgbmctbW9kZWwtb3B0aW9ucz0ieyB1cGRhdGVPbjogJ2RlZmF1bHQgYmx1cicsIGRlYm91bmNlOiB7J2RlZmF1bHQnOiA1MDAsICdibHVyJzogMH0gfSJgCiAqICAgLSBgYWxsb3dJbnZhbGlkYDogYm9vbGVhbiB2YWx1ZSB3aGljaCBpbmRpY2F0ZXMgdGhhdCB0aGUgbW9kZWwgY2FuIGJlIHNldCB3aXRoIHZhbHVlcyB0aGF0IGRpZAogKiAgICAgbm90IHZhbGlkYXRlIGNvcnJlY3RseSBpbnN0ZWFkIG9mIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIHNldHRpbmcgdGhlIG1vZGVsIHRvIHVuZGVmaW5lZC4KICogICAtIGBnZXR0ZXJTZXR0ZXJgOiBib29sZWFuIHZhbHVlIHdoaWNoIGRldGVybWluZXMgd2hldGhlciBvciBub3QgdG8gdHJlYXQgZnVuY3Rpb25zIGJvdW5kIHRvCiAgICAgICBgbmdNb2RlbGAgYXMgZ2V0dGVycy9zZXR0ZXJzLgogKiAgIC0gYHRpbWV6b25lYDogRGVmaW5lcyB0aGUgdGltZXpvbmUgdG8gYmUgdXNlZCB0byByZWFkL3dyaXRlIHRoZSBgRGF0ZWAgaW5zdGFuY2UgaW4gdGhlIG1vZGVsIGZvcgogKiAgICAgYDxpbnB1dCB0eXBlPSJkYXRlIj5gLCBgPGlucHV0IHR5cGU9InRpbWUiPmAsIC4uLiAuIFJpZ2h0IG5vdywgdGhlIG9ubHkgc3VwcG9ydGVkIHZhbHVlIGlzIGAnVVRDJ2AsCiAqICAgICBvdGhlcndpc2UgdGhlIGRlZmF1bHQgdGltZXpvbmUgb2YgdGhlIGJyb3dzZXIgd2lsbCBiZSB1c2VkLgogKgogKiBAZXhhbXBsZQoKICBUaGUgZm9sbG93aW5nIGV4YW1wbGUgc2hvd3MgaG93IHRvIG92ZXJyaWRlIGltbWVkaWF0ZSB1cGRhdGVzLiBDaGFuZ2VzIG9uIHRoZSBpbnB1dHMgd2l0aGluIHRoZQogIGZvcm0gd2lsbCB1cGRhdGUgdGhlIG1vZGVsIG9ubHkgd2hlbiB0aGUgY29udHJvbCBsb3NlcyBmb2N1cyAoYmx1ciBldmVudCkuIElmIGBlc2NhcGVgIGtleSBpcwogIHByZXNzZWQgd2hpbGUgdGhlIGlucHV0IGZpZWxkIGlzIGZvY3VzZWQsIHRoZSB2YWx1ZSBpcyByZXNldCB0byB0aGUgdmFsdWUgaW4gdGhlIGN1cnJlbnQgbW9kZWwuCgogIDxleGFtcGxlIG5hbWU9Im5nTW9kZWxPcHRpb25zLWRpcmVjdGl2ZS1ibHVyIiBtb2R1bGU9Im9wdGlvbnNFeGFtcGxlIj4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICA8Zm9ybSBuYW1lPSJ1c2VyRm9ybSI+CiAgICAgICAgICBOYW1lOgogICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InVzZXJOYW1lIgogICAgICAgICAgICAgICAgIG5nLW1vZGVsPSJ1c2VyLm5hbWUiCiAgICAgICAgICAgICAgICAgbmctbW9kZWwtb3B0aW9ucz0ieyB1cGRhdGVPbjogJ2JsdXInIH0iCiAgICAgICAgICAgICAgICAgbmcta2V5dXA9ImNhbmNlbCgkZXZlbnQpIiAvPjxiciAvPgoKICAgICAgICAgIE90aGVyIGRhdGE6CiAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InVzZXIuZGF0YSIgLz48YnIgLz4KICAgICAgICA8L2Zvcm0+CiAgICAgICAgPHByZT51c2VyLm5hbWUgPSA8c3BhbiBuZy1iaW5kPSJ1c2VyLm5hbWUiPjwvc3Bhbj48L3ByZT4KICAgICAgPC9kaXY+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJhcHAuanMiPgogICAgICBhbmd1bGFyLm1vZHVsZSgnb3B0aW9uc0V4YW1wbGUnLCBbXSkKICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLnVzZXIgPSB7IG5hbWU6ICdzYXknLCBkYXRhOiAnJyB9OwoKICAgICAgICAgICRzY29wZS5jYW5jZWwgPSBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBpZiAoZS5rZXlDb2RlID09IDI3KSB7CiAgICAgICAgICAgICAgJHNjb3BlLnVzZXJGb3JtLnVzZXJOYW1lLiRyb2xsYmFja1ZpZXdWYWx1ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH1dKTsKICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICB2YXIgbW9kZWwgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3VzZXIubmFtZScpKTsKICAgICAgdmFyIGlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndXNlci5uYW1lJykpOwogICAgICB2YXIgb3RoZXIgPSBlbGVtZW50KGJ5Lm1vZGVsKCd1c2VyLmRhdGEnKSk7CgogICAgICBpdCgnc2hvdWxkIGFsbG93IGN1c3RvbSBldmVudHMnLCBmdW5jdGlvbigpIHsKICAgICAgICBpbnB1dC5zZW5kS2V5cygnIGhlbGxvJyk7CiAgICAgICAgaW5wdXQuY2xpY2soKTsKICAgICAgICBleHBlY3QobW9kZWwuZ2V0VGV4dCgpKS50b0VxdWFsKCdzYXknKTsKICAgICAgICBvdGhlci5jbGljaygpOwogICAgICAgIGV4cGVjdChtb2RlbC5nZXRUZXh0KCkpLnRvRXF1YWwoJ3NheSBoZWxsbycpOwogICAgICB9KTsKCiAgICAgIGl0KCdzaG91bGQgJHJvbGxiYWNrVmlld1ZhbHVlIHdoZW4gbW9kZWwgY2hhbmdlcycsIGZ1bmN0aW9uKCkgewogICAgICAgIGlucHV0LnNlbmRLZXlzKCcgaGVsbG8nKTsKICAgICAgICBleHBlY3QoaW5wdXQuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0VxdWFsKCdzYXkgaGVsbG8nKTsKICAgICAgICBpbnB1dC5zZW5kS2V5cyhwcm90cmFjdG9yLktleS5FU0NBUEUpOwogICAgICAgIGV4cGVjdChpbnB1dC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvRXF1YWwoJ3NheScpOwogICAgICAgIG90aGVyLmNsaWNrKCk7CiAgICAgICAgZXhwZWN0KG1vZGVsLmdldFRleHQoKSkudG9FcXVhbCgnc2F5Jyk7CiAgICAgIH0pOwogICAgPC9maWxlPgogIDwvZXhhbXBsZT4KCiAgVGhpcyBvbmUgc2hvd3MgaG93IHRvIGRlYm91bmNlIG1vZGVsIGNoYW5nZXMuIE1vZGVsIHdpbGwgYmUgdXBkYXRlZCBvbmx5IDEgc2VjIGFmdGVyIGxhc3QgY2hhbmdlLgogIElmIHRoZSBgQ2xlYXJgIGJ1dHRvbiBpcyBwcmVzc2VkLCBhbnkgZGVib3VuY2VkIGFjdGlvbiBpcyBjYW5jZWxlZCBhbmQgdGhlIHZhbHVlIGJlY29tZXMgZW1wdHkuCgogIDxleGFtcGxlIG5hbWU9Im5nTW9kZWxPcHRpb25zLWRpcmVjdGl2ZS1kZWJvdW5jZSIgbW9kdWxlPSJvcHRpb25zRXhhbXBsZSI+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICAgPGZvcm0gbmFtZT0idXNlckZvcm0iPgogICAgICAgICAgTmFtZToKICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ1c2VyTmFtZSIKICAgICAgICAgICAgICAgICBuZy1tb2RlbD0idXNlci5uYW1lIgogICAgICAgICAgICAgICAgIG5nLW1vZGVsLW9wdGlvbnM9InsgZGVib3VuY2U6IDEwMDAgfSIgLz4KICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9InVzZXJGb3JtLnVzZXJOYW1lLiRyb2xsYmFja1ZpZXdWYWx1ZSgpOyB1c2VyLm5hbWU9JyciPkNsZWFyPC9idXR0b24+PGJyIC8+CiAgICAgICAgPC9mb3JtPgogICAgICAgIDxwcmU+dXNlci5uYW1lID0gPHNwYW4gbmctYmluZD0idXNlci5uYW1lIj48L3NwYW4+PC9wcmU+CiAgICAgIDwvZGl2PgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iYXBwLmpzIj4KICAgICAgYW5ndWxhci5tb2R1bGUoJ29wdGlvbnNFeGFtcGxlJywgW10pCiAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICRzY29wZS51c2VyID0geyBuYW1lOiAnc2F5JyB9OwogICAgICAgIH1dKTsKICAgIDwvZmlsZT4KICA8L2V4YW1wbGU+CgogIFRoaXMgb25lIHNob3dzIGhvdyB0byBiaW5kIHRvIGdldHRlci9zZXR0ZXJzOgoKICA8ZXhhbXBsZSBuYW1lPSJuZ01vZGVsT3B0aW9ucy1kaXJlY3RpdmUtZ2V0dGVyLXNldHRlciIgbW9kdWxlPSJnZXR0ZXJTZXR0ZXJFeGFtcGxlIj4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICA8Zm9ybSBuYW1lPSJ1c2VyRm9ybSI+CiAgICAgICAgICBOYW1lOgogICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InVzZXJOYW1lIgogICAgICAgICAgICAgICAgIG5nLW1vZGVsPSJ1c2VyLm5hbWUiCiAgICAgICAgICAgICAgICAgbmctbW9kZWwtb3B0aW9ucz0ieyBnZXR0ZXJTZXR0ZXI6IHRydWUgfSIgLz4KICAgICAgICA8L2Zvcm0+CiAgICAgICAgPHByZT51c2VyLm5hbWUgPSA8c3BhbiBuZy1iaW5kPSJ1c2VyLm5hbWUoKSI+PC9zcGFuPjwvcHJlPgogICAgICA8L2Rpdj4KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImFwcC5qcyI+CiAgICAgIGFuZ3VsYXIubW9kdWxlKCdnZXR0ZXJTZXR0ZXJFeGFtcGxlJywgW10pCiAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgIHZhciBfbmFtZSA9ICdCcmlhbic7CiAgICAgICAgICAkc2NvcGUudXNlciA9IHsKICAgICAgICAgICAgbmFtZTogZnVuY3Rpb24gKG5ld05hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gYW5ndWxhci5pc0RlZmluZWQobmV3TmFtZSkgPyAoX25hbWUgPSBuZXdOYW1lKSA6IF9uYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH1dKTsKICAgIDwvZmlsZT4KICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdNb2RlbE9wdGlvbnNEaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdBJywKICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRhdHRycycsIGZ1bmN0aW9uKCRzY29wZSwgJGF0dHJzKSB7CiAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgdGhpcy4kb3B0aW9ucyA9ICRzY29wZS4kZXZhbCgkYXR0cnMubmdNb2RlbE9wdGlvbnMpOwogICAgICAvLyBBbGxvdyBhZGRpbmcvb3ZlcnJpZGluZyBib3VuZCBldmVudHMKICAgICAgaWYgKHRoaXMuJG9wdGlvbnMudXBkYXRlT24gIT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuJG9wdGlvbnMudXBkYXRlT25EZWZhdWx0ID0gZmFsc2U7CiAgICAgICAgLy8gZXh0cmFjdCAiZGVmYXVsdCIgcHNldWRvLWV2ZW50IGZyb20gbGlzdCBvZiBldmVudHMgdGhhdCBjYW4gdHJpZ2dlciBhIG1vZGVsIHVwZGF0ZQogICAgICAgIHRoaXMuJG9wdGlvbnMudXBkYXRlT24gPSB0cmltKHRoaXMuJG9wdGlvbnMudXBkYXRlT24ucmVwbGFjZShERUZBVUxUX1JFR0VYUCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGF0LiRvcHRpb25zLnVwZGF0ZU9uRGVmYXVsdCA9IHRydWU7CiAgICAgICAgICByZXR1cm4gJyAnOwogICAgICAgIH0pKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiRvcHRpb25zLnVwZGF0ZU9uRGVmYXVsdCA9IHRydWU7CiAgICAgIH0KICAgIH1dCiAgfTsKfTsKCi8vIGhlbHBlciBtZXRob2RzCmZ1bmN0aW9uIGFkZFNldFZhbGlkaXR5TWV0aG9kKGNvbnRleHQpIHsKICB2YXIgY3RybCA9IGNvbnRleHQuY3RybCwKICAgICAgJGVsZW1lbnQgPSBjb250ZXh0LiRlbGVtZW50LAogICAgICBjbGFzc0NhY2hlID0ge30sCiAgICAgIHNldCA9IGNvbnRleHQuc2V0LAogICAgICB1bnNldCA9IGNvbnRleHQudW5zZXQsCiAgICAgIHBhcmVudEZvcm0gPSBjb250ZXh0LnBhcmVudEZvcm0sCiAgICAgICRhbmltYXRlID0gY29udGV4dC4kYW5pbWF0ZTsKCiAgY2xhc3NDYWNoZVtJTlZBTElEX0NMQVNTXSA9ICEoY2xhc3NDYWNoZVtWQUxJRF9DTEFTU10gPSAkZWxlbWVudC5oYXNDbGFzcyhWQUxJRF9DTEFTUykpOwoKICBjdHJsLiRzZXRWYWxpZGl0eSA9IHNldFZhbGlkaXR5OwoKICBmdW5jdGlvbiBzZXRWYWxpZGl0eSh2YWxpZGF0aW9uRXJyb3JLZXksIHN0YXRlLCBvcHRpb25zKSB7CiAgICBpZiAoc3RhdGUgPT09IHVuZGVmaW5lZCkgewogICAgICBjcmVhdGVBbmRTZXQoJyRwZW5kaW5nJywgdmFsaWRhdGlvbkVycm9yS2V5LCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHVuc2V0QW5kQ2xlYW51cCgnJHBlbmRpbmcnLCB2YWxpZGF0aW9uRXJyb3JLZXksIG9wdGlvbnMpOwogICAgfQogICAgaWYgKCFpc0Jvb2xlYW4oc3RhdGUpKSB7CiAgICAgIHVuc2V0KGN0cmwuJGVycm9yLCB2YWxpZGF0aW9uRXJyb3JLZXksIG9wdGlvbnMpOwogICAgICB1bnNldChjdHJsLiQkc3VjY2VzcywgdmFsaWRhdGlvbkVycm9yS2V5LCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChzdGF0ZSkgewogICAgICAgIHVuc2V0KGN0cmwuJGVycm9yLCB2YWxpZGF0aW9uRXJyb3JLZXksIG9wdGlvbnMpOwogICAgICAgIHNldChjdHJsLiQkc3VjY2VzcywgdmFsaWRhdGlvbkVycm9yS2V5LCBvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXQoY3RybC4kZXJyb3IsIHZhbGlkYXRpb25FcnJvcktleSwgb3B0aW9ucyk7CiAgICAgICAgdW5zZXQoY3RybC4kJHN1Y2Nlc3MsIHZhbGlkYXRpb25FcnJvcktleSwgb3B0aW9ucyk7CiAgICAgIH0KICAgIH0KICAgIGlmIChjdHJsLiRwZW5kaW5nKSB7CiAgICAgIGNhY2hlZFRvZ2dsZUNsYXNzKFBFTkRJTkdfQ0xBU1MsIHRydWUpOwogICAgICBjdHJsLiR2YWxpZCA9IGN0cmwuJGludmFsaWQgPSB1bmRlZmluZWQ7CiAgICAgIHRvZ2dsZVZhbGlkYXRpb25Dc3MoJycsIG51bGwpOwogICAgfSBlbHNlIHsKICAgICAgY2FjaGVkVG9nZ2xlQ2xhc3MoUEVORElOR19DTEFTUywgZmFsc2UpOwogICAgICBjdHJsLiR2YWxpZCA9IGlzT2JqZWN0RW1wdHkoY3RybC4kZXJyb3IpOwogICAgICBjdHJsLiRpbnZhbGlkID0gIWN0cmwuJHZhbGlkOwogICAgICB0b2dnbGVWYWxpZGF0aW9uQ3NzKCcnLCBjdHJsLiR2YWxpZCk7CiAgICB9CgogICAgLy8gcmUtcmVhZCB0aGUgc3RhdGUgYXMgdGhlIHNldC91bnNldCBtZXRob2RzIGNvdWxkIGhhdmUKICAgIC8vIGNvbWJpbmVkIHN0YXRlIGluIGN0cmwuJGVycm9yW3ZhbGlkYXRpb25FcnJvcl0gKHVzZWQgZm9yIGZvcm1zKSwKICAgIC8vIHdoZXJlIHNldHRpbmcvdW5zZXR0aW5nIG9ubHkgaW5jcmVtZW50cy9kZWNyZW1lbnRzIHRoZSB2YWx1ZSwKICAgIC8vIGFuZCBkb2VzIG5vdCByZXBsYWNlIGl0LgogICAgdmFyIGNvbWJpbmVkU3RhdGU7CiAgICBpZiAoY3RybC4kcGVuZGluZyAmJiBjdHJsLiRwZW5kaW5nW3ZhbGlkYXRpb25FcnJvcktleV0pIHsKICAgICAgY29tYmluZWRTdGF0ZSA9IHVuZGVmaW5lZDsKICAgIH0gZWxzZSBpZiAoY3RybC4kZXJyb3JbdmFsaWRhdGlvbkVycm9yS2V5XSkgewogICAgICBjb21iaW5lZFN0YXRlID0gZmFsc2U7CiAgICB9IGVsc2UgaWYgKGN0cmwuJCRzdWNjZXNzW3ZhbGlkYXRpb25FcnJvcktleV0pIHsKICAgICAgY29tYmluZWRTdGF0ZSA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICBjb21iaW5lZFN0YXRlID0gbnVsbDsKICAgIH0KICAgIHRvZ2dsZVZhbGlkYXRpb25Dc3ModmFsaWRhdGlvbkVycm9yS2V5LCBjb21iaW5lZFN0YXRlKTsKICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25FcnJvcktleSwgY29tYmluZWRTdGF0ZSwgY3RybCk7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVBbmRTZXQobmFtZSwgdmFsdWUsIG9wdGlvbnMpIHsKICAgIGlmICghY3RybFtuYW1lXSkgewogICAgICBjdHJsW25hbWVdID0ge307CiAgICB9CiAgICBzZXQoY3RybFtuYW1lXSwgdmFsdWUsIG9wdGlvbnMpOwogIH0KCiAgZnVuY3Rpb24gdW5zZXRBbmRDbGVhbnVwKG5hbWUsIHZhbHVlLCBvcHRpb25zKSB7CiAgICBpZiAoY3RybFtuYW1lXSkgewogICAgICB1bnNldChjdHJsW25hbWVdLCB2YWx1ZSwgb3B0aW9ucyk7CiAgICB9CiAgICBpZiAoaXNPYmplY3RFbXB0eShjdHJsW25hbWVdKSkgewogICAgICBjdHJsW25hbWVdID0gdW5kZWZpbmVkOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2FjaGVkVG9nZ2xlQ2xhc3MoY2xhc3NOYW1lLCBzd2l0Y2hWYWx1ZSkgewogICAgaWYgKHN3aXRjaFZhbHVlICYmICFjbGFzc0NhY2hlW2NsYXNzTmFtZV0pIHsKICAgICAgJGFuaW1hdGUuYWRkQ2xhc3MoJGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgIGNsYXNzQ2FjaGVbY2xhc3NOYW1lXSA9IHRydWU7CiAgICB9IGVsc2UgaWYgKCFzd2l0Y2hWYWx1ZSAmJiBjbGFzc0NhY2hlW2NsYXNzTmFtZV0pIHsKICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3MoJGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgIGNsYXNzQ2FjaGVbY2xhc3NOYW1lXSA9IGZhbHNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdG9nZ2xlVmFsaWRhdGlvbkNzcyh2YWxpZGF0aW9uRXJyb3JLZXksIGlzVmFsaWQpIHsKICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CgogICAgY2FjaGVkVG9nZ2xlQ2xhc3MoVkFMSURfQ0xBU1MgKyB2YWxpZGF0aW9uRXJyb3JLZXksIGlzVmFsaWQgPT09IHRydWUpOwogICAgY2FjaGVkVG9nZ2xlQ2xhc3MoSU5WQUxJRF9DTEFTUyArIHZhbGlkYXRpb25FcnJvcktleSwgaXNWYWxpZCA9PT0gZmFsc2UpOwogIH0KfQoKZnVuY3Rpb24gaXNPYmplY3RFbXB0eShvYmopIHsKICBpZiAob2JqKSB7CiAgICBmb3IgKHZhciBwcm9wIGluIG9iaikgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIHJldHVybiB0cnVlOwp9CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0JpbmQKICogQHJlc3RyaWN0IEFDCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nQmluZGAgYXR0cmlidXRlIHRlbGxzIEFuZ3VsYXIgdG8gcmVwbGFjZSB0aGUgdGV4dCBjb250ZW50IG9mIHRoZSBzcGVjaWZpZWQgSFRNTCBlbGVtZW50CiAqIHdpdGggdGhlIHZhbHVlIG9mIGEgZ2l2ZW4gZXhwcmVzc2lvbiwgYW5kIHRvIHVwZGF0ZSB0aGUgdGV4dCBjb250ZW50IHdoZW4gdGhlIHZhbHVlIG9mIHRoYXQKICogZXhwcmVzc2lvbiBjaGFuZ2VzLgogKgogKiBUeXBpY2FsbHksIHlvdSBkb24ndCB1c2UgYG5nQmluZGAgZGlyZWN0bHksIGJ1dCBpbnN0ZWFkIHlvdSB1c2UgdGhlIGRvdWJsZSBjdXJseSBtYXJrdXAgbGlrZQogKiBge3sgZXhwcmVzc2lvbiB9fWAgd2hpY2ggaXMgc2ltaWxhciBidXQgbGVzcyB2ZXJib3NlLgogKgogKiBJdCBpcyBwcmVmZXJhYmxlIHRvIHVzZSBgbmdCaW5kYCBpbnN0ZWFkIG9mIGB7eyBleHByZXNzaW9uIH19YCBpZiBhIHRlbXBsYXRlIGlzIG1vbWVudGFyaWx5CiAqIGRpc3BsYXllZCBieSB0aGUgYnJvd3NlciBpbiBpdHMgcmF3IHN0YXRlIGJlZm9yZSBBbmd1bGFyIGNvbXBpbGVzIGl0LiBTaW5jZSBgbmdCaW5kYCBpcyBhbgogKiBlbGVtZW50IGF0dHJpYnV0ZSwgaXQgbWFrZXMgdGhlIGJpbmRpbmdzIGludmlzaWJsZSB0byB0aGUgdXNlciB3aGlsZSB0aGUgcGFnZSBpcyBsb2FkaW5nLgogKgogKiBBbiBhbHRlcm5hdGl2ZSBzb2x1dGlvbiB0byB0aGlzIHByb2JsZW0gd291bGQgYmUgdXNpbmcgdGhlCiAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbG9hayBuZ0Nsb2FrfSBkaXJlY3RpdmUuCiAqCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmluZCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZS4KICoKICogQGV4YW1wbGUKICogRW50ZXIgYSBuYW1lIGluIHRoZSBMaXZlIFByZXZpZXcgdGV4dCBib3g7IHRoZSBncmVldGluZyBiZWxvdyB0aGUgdGV4dCBib3ggY2hhbmdlcyBpbnN0YW50bHkuCiAgIDxleGFtcGxlIG1vZHVsZT0iYmluZEV4YW1wbGUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ2JpbmRFeGFtcGxlJywgW10pCiAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS5uYW1lID0gJ1doaXJsZWQnOwogICAgICAgICAgIH1dKTsKICAgICAgIDwvc2NyaXB0PgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICAgIEVudGVyIG5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibmFtZSI+PGJyPgogICAgICAgICBIZWxsbyA8c3BhbiBuZy1iaW5kPSJuYW1lIj48L3NwYW4+IQogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1iaW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBuYW1lSW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCduYW1lJykpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnbmFtZScpKS5nZXRUZXh0KCkpLnRvQmUoJ1doaXJsZWQnKTsKICAgICAgICAgbmFtZUlucHV0LmNsZWFyKCk7CiAgICAgICAgIG5hbWVJbnB1dC5zZW5kS2V5cygnd29ybGQnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnbmFtZScpKS5nZXRUZXh0KCkpLnRvQmUoJ3dvcmxkJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCnZhciBuZ0JpbmREaXJlY3RpdmUgPSBbJyRjb21waWxlJywgZnVuY3Rpb24oJGNvbXBpbGUpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdBQycsCiAgICBjb21waWxlOiBmdW5jdGlvbiBuZ0JpbmRDb21waWxlKHRlbXBsYXRlRWxlbWVudCkgewogICAgICAkY29tcGlsZS4kJGFkZEJpbmRpbmdDbGFzcyh0ZW1wbGF0ZUVsZW1lbnQpOwogICAgICByZXR1cm4gZnVuY3Rpb24gbmdCaW5kTGluayhzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICRjb21waWxlLiQkYWRkQmluZGluZ0luZm8oZWxlbWVudCwgYXR0ci5uZ0JpbmQpOwogICAgICAgIGVsZW1lbnQgPSBlbGVtZW50WzBdOwogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZCwgZnVuY3Rpb24gbmdCaW5kV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGVsZW1lbnQudGV4dENvbnRlbnQgPSB2YWx1ZSA9PT0gdW5kZWZpbmVkID8gJycgOiB2YWx1ZTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0KICB9Owp9XTsKCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0JpbmRUZW1wbGF0ZQogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0JpbmRUZW1wbGF0ZWAgZGlyZWN0aXZlIHNwZWNpZmllcyB0aGF0IHRoZSBlbGVtZW50CiAqIHRleHQgY29udGVudCBzaG91bGQgYmUgcmVwbGFjZWQgd2l0aCB0aGUgaW50ZXJwb2xhdGlvbiBvZiB0aGUgdGVtcGxhdGUKICogaW4gdGhlIGBuZ0JpbmRUZW1wbGF0ZWAgYXR0cmlidXRlLgogKiBVbmxpa2UgYG5nQmluZGAsIHRoZSBgbmdCaW5kVGVtcGxhdGVgIGNhbiBjb250YWluIG11bHRpcGxlIGB7e2AgYH19YAogKiBleHByZXNzaW9ucy4gVGhpcyBkaXJlY3RpdmUgaXMgbmVlZGVkIHNpbmNlIHNvbWUgSFRNTCBlbGVtZW50cwogKiAoc3VjaCBhcyBUSVRMRSBhbmQgT1BUSU9OKSBjYW5ub3QgY29udGFpbiBTUEFOIGVsZW1lbnRzLgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtzdHJpbmd9IG5nQmluZFRlbXBsYXRlIHRlbXBsYXRlIG9mIGZvcm0KICogICA8dHQ+e3s8L3R0PiA8dHQ+ZXhwcmVzc2lvbjwvdHQ+IDx0dD59fTwvdHQ+IHRvIGV2YWwuCiAqCiAqIEBleGFtcGxlCiAqIFRyeSBpdCBoZXJlOiBlbnRlciB0ZXh0IGluIHRleHQgYm94IGFuZCB3YXRjaCB0aGUgZ3JlZXRpbmcgY2hhbmdlLgogICA8ZXhhbXBsZSBtb2R1bGU9ImJpbmRFeGFtcGxlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCdiaW5kRXhhbXBsZScsIFtdKQogICAgICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24gKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnNhbHV0YXRpb24gPSAnSGVsbG8nOwogICAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAnV29ybGQnOwogICAgICAgICAgIH1dKTsKICAgICAgIDwvc2NyaXB0PgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICAgU2FsdXRhdGlvbjogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzYWx1dGF0aW9uIj48YnI+CiAgICAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIj48YnI+CiAgICAgICAgPHByZSBuZy1iaW5kLXRlbXBsYXRlPSJ7e3NhbHV0YXRpb259fSB7e25hbWV9fSEiPjwvcHJlPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1iaW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBzYWx1dGF0aW9uRWxlbSA9IGVsZW1lbnQoYnkuYmluZGluZygnc2FsdXRhdGlvbicpKTsKICAgICAgICAgdmFyIHNhbHV0YXRpb25JbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3NhbHV0YXRpb24nKSk7CiAgICAgICAgIHZhciBuYW1lSW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCduYW1lJykpOwoKICAgICAgICAgZXhwZWN0KHNhbHV0YXRpb25FbGVtLmdldFRleHQoKSkudG9CZSgnSGVsbG8gV29ybGQhJyk7CgogICAgICAgICBzYWx1dGF0aW9uSW5wdXQuY2xlYXIoKTsKICAgICAgICAgc2FsdXRhdGlvbklucHV0LnNlbmRLZXlzKCdHcmVldGluZ3MnKTsKICAgICAgICAgbmFtZUlucHV0LmNsZWFyKCk7CiAgICAgICAgIG5hbWVJbnB1dC5zZW5kS2V5cygndXNlcicpOwoKICAgICAgICAgZXhwZWN0KHNhbHV0YXRpb25FbGVtLmdldFRleHQoKSkudG9CZSgnR3JlZXRpbmdzIHVzZXIhJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCnZhciBuZ0JpbmRUZW1wbGF0ZURpcmVjdGl2ZSA9IFsnJGludGVycG9sYXRlJywgJyRjb21waWxlJywgZnVuY3Rpb24oJGludGVycG9sYXRlLCAkY29tcGlsZSkgewogIHJldHVybiB7CiAgICBjb21waWxlOiBmdW5jdGlvbiBuZ0JpbmRUZW1wbGF0ZUNvbXBpbGUodGVtcGxhdGVFbGVtZW50KSB7CiAgICAgICRjb21waWxlLiQkYWRkQmluZGluZ0NsYXNzKHRlbXBsYXRlRWxlbWVudCk7CiAgICAgIHJldHVybiBmdW5jdGlvbiBuZ0JpbmRUZW1wbGF0ZUxpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShlbGVtZW50LmF0dHIoYXR0ci4kYXR0ci5uZ0JpbmRUZW1wbGF0ZSkpOwogICAgICAgICRjb21waWxlLiQkYWRkQmluZGluZ0luZm8oZWxlbWVudCwgaW50ZXJwb2xhdGVGbi5leHByZXNzaW9ucyk7CiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnRbMF07CiAgICAgICAgYXR0ci4kb2JzZXJ2ZSgnbmdCaW5kVGVtcGxhdGUnLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgZWxlbWVudC50ZXh0Q29udGVudCA9IHZhbHVlID09PSB1bmRlZmluZWQgPyAnJyA6IHZhbHVlOwogICAgICAgIH0pOwogICAgICB9OwogICAgfQogIH07Cn1dOwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQmluZEh0bWwKICoKICogQGRlc2NyaXB0aW9uCiAqIENyZWF0ZXMgYSBiaW5kaW5nIHRoYXQgd2lsbCBpbm5lckhUTUwgdGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBgZXhwcmVzc2lvbmAgaW50byB0aGUgY3VycmVudAogKiBlbGVtZW50IGluIGEgc2VjdXJlIHdheS4gIEJ5IGRlZmF1bHQsIHRoZSBpbm5lckhUTUwtZWQgY29udGVudCB3aWxsIGJlIHNhbml0aXplZCB1c2luZyB0aGUge0BsaW5rCiAqIG5nU2FuaXRpemUuJHNhbml0aXplICRzYW5pdGl6ZX0gc2VydmljZS4gIFRvIHV0aWxpemUgdGhpcyBmdW5jdGlvbmFsaXR5LCBlbnN1cmUgdGhhdCBgJHNhbml0aXplYAogKiBpcyBhdmFpbGFibGUsIGZvciBleGFtcGxlLCBieSBpbmNsdWRpbmcge0BsaW5rIG5nU2FuaXRpemV9IGluIHlvdXIgbW9kdWxlJ3MgZGVwZW5kZW5jaWVzIChub3QgaW4KICogY29yZSBBbmd1bGFyKS4gSW4gb3JkZXIgdG8gdXNlIHtAbGluayBuZ1Nhbml0aXplfSBpbiB5b3VyIG1vZHVsZSdzIGRlcGVuZGVuY2llcywgeW91IG5lZWQgdG8KICogaW5jbHVkZSAiYW5ndWxhci1zYW5pdGl6ZS5qcyIgaW4geW91ciBhcHBsaWNhdGlvbi4KICoKICogWW91IG1heSBhbHNvIGJ5cGFzcyBzYW5pdGl6YXRpb24gZm9yIHZhbHVlcyB5b3Uga25vdyBhcmUgc2FmZS4gVG8gZG8gc28sIGJpbmQgdG8KICogYW4gZXhwbGljaXRseSB0cnVzdGVkIHZhbHVlIHZpYSB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzSHRtbCAkc2NlLnRydXN0QXNIdG1sfS4gIFNlZSB0aGUgZXhhbXBsZQogKiB1bmRlciB7QGxpbmsgbmcuJHNjZSNzaG93LW1lLWFuLWV4YW1wbGUtdXNpbmctc2NlLSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKX0uCiAqCiAqIE5vdGU6IElmIGEgYCRzYW5pdGl6ZWAgc2VydmljZSBpcyB1bmF2YWlsYWJsZSBhbmQgdGhlIGJvdW5kIHZhbHVlIGlzbid0IGV4cGxpY2l0bHkgdHJ1c3RlZCwgeW91CiAqIHdpbGwgaGF2ZSBhbiBleGNlcHRpb24gKGluc3RlYWQgb2YgYW4gZXhwbG9pdC4pCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmluZEh0bWwge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUuCiAqCiAqIEBleGFtcGxlCgogICA8ZXhhbXBsZSBtb2R1bGU9ImJpbmRIdG1sRXhhbXBsZSIgZGVwcz0iYW5ndWxhci1zYW5pdGl6ZS5qcyI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICA8cCBuZy1iaW5kLWh0bWw9Im15SFRNTCI+PC9wPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgoKICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgYW5ndWxhci5tb2R1bGUoJ2JpbmRIdG1sRXhhbXBsZScsIFsnbmdTYW5pdGl6ZSddKQogICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5teUhUTUwgPQogICAgICAgICAgICAgICdJIGFtIGFuIDxjb2RlPkhUTUw8L2NvZGU+c3RyaW5nIHdpdGggJyArCiAgICAgICAgICAgICAgJzxhIGhyZWY9IiMiPmxpbmtzITwvYT4gYW5kIG90aGVyIDxlbT5zdHVmZjwvZW0+JzsKICAgICAgICAgfV0pOwogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWJpbmQtaHRtbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdteUhUTUwnKSkuZ2V0VGV4dCgpKS50b0JlKAogICAgICAgICAgICAgJ0kgYW0gYW4gSFRNTHN0cmluZyB3aXRoIGxpbmtzISBhbmQgb3RoZXIgc3R1ZmYnKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KdmFyIG5nQmluZEh0bWxEaXJlY3RpdmUgPSBbJyRzY2UnLCAnJHBhcnNlJywgJyRjb21waWxlJywgZnVuY3Rpb24oJHNjZSwgJHBhcnNlLCAkY29tcGlsZSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgY29tcGlsZTogZnVuY3Rpb24gbmdCaW5kSHRtbENvbXBpbGUodEVsZW1lbnQsIHRBdHRycykgewogICAgICB2YXIgbmdCaW5kSHRtbEdldHRlciA9ICRwYXJzZSh0QXR0cnMubmdCaW5kSHRtbCk7CiAgICAgIHZhciBuZ0JpbmRIdG1sV2F0Y2ggPSAkcGFyc2UodEF0dHJzLm5nQmluZEh0bWwsIGZ1bmN0aW9uIGdldFN0cmluZ1ZhbHVlKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuICh2YWx1ZSB8fCAnJykudG9TdHJpbmcoKTsKICAgICAgfSk7CiAgICAgICRjb21waWxlLiQkYWRkQmluZGluZ0NsYXNzKHRFbGVtZW50KTsKCiAgICAgIHJldHVybiBmdW5jdGlvbiBuZ0JpbmRIdG1sTGluayhzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICRjb21waWxlLiQkYWRkQmluZGluZ0luZm8oZWxlbWVudCwgYXR0ci5uZ0JpbmRIdG1sKTsKCiAgICAgICAgc2NvcGUuJHdhdGNoKG5nQmluZEh0bWxXYXRjaCwgZnVuY3Rpb24gbmdCaW5kSHRtbFdhdGNoQWN0aW9uKCkgewogICAgICAgICAgLy8gd2UgcmUtZXZhbHVhdGUgdGhlIGV4cHIgYmVjYXVzZSB3ZSB3YW50IGEgVHJ1c3RlZFZhbHVlSG9sZGVyVHlwZQogICAgICAgICAgLy8gZm9yICRzY2UsIG5vdCBhIHN0cmluZwogICAgICAgICAgZWxlbWVudC5odG1sKCRzY2UuZ2V0VHJ1c3RlZEh0bWwobmdCaW5kSHRtbEdldHRlcihzY29wZSkpIHx8ICcnKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0KICB9Owp9XTsKCmZ1bmN0aW9uIGNsYXNzRGlyZWN0aXZlKG5hbWUsIHNlbGVjdG9yKSB7CiAgbmFtZSA9ICduZ0NsYXNzJyArIG5hbWU7CiAgcmV0dXJuIFsnJGFuaW1hdGUnLCBmdW5jdGlvbigkYW5pbWF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdBQycsCiAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgdmFyIG9sZFZhbDsKCiAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHJbbmFtZV0sIG5nQ2xhc3NXYXRjaEFjdGlvbiwgdHJ1ZSk7CgogICAgICAgIGF0dHIuJG9ic2VydmUoJ2NsYXNzJywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIG5nQ2xhc3NXYXRjaEFjdGlvbihzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgfSk7CgoKICAgICAgICBpZiAobmFtZSAhPT0gJ25nQ2xhc3MnKSB7CiAgICAgICAgICBzY29wZS4kd2F0Y2goJyRpbmRleCcsIGZ1bmN0aW9uKCRpbmRleCwgb2xkJGluZGV4KSB7CiAgICAgICAgICAgIC8vIGpzaGludCBiaXR3aXNlOiBmYWxzZQogICAgICAgICAgICB2YXIgbW9kID0gJGluZGV4ICYgMTsKICAgICAgICAgICAgaWYgKG1vZCAhPT0gKG9sZCRpbmRleCAmIDEpKSB7CiAgICAgICAgICAgICAgdmFyIGNsYXNzZXMgPSBhcnJheUNsYXNzZXMoc2NvcGUuJGV2YWwoYXR0cltuYW1lXSkpOwogICAgICAgICAgICAgIG1vZCA9PT0gc2VsZWN0b3IgPwogICAgICAgICAgICAgICAgYWRkQ2xhc3NlcyhjbGFzc2VzKSA6CiAgICAgICAgICAgICAgICByZW1vdmVDbGFzc2VzKGNsYXNzZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGFkZENsYXNzZXMoY2xhc3NlcykgewogICAgICAgICAgdmFyIG5ld0NsYXNzZXMgPSBkaWdlc3RDbGFzc0NvdW50cyhjbGFzc2VzLCAxKTsKICAgICAgICAgIGF0dHIuJGFkZENsYXNzKG5ld0NsYXNzZXMpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlQ2xhc3NlcyhjbGFzc2VzKSB7CiAgICAgICAgICB2YXIgbmV3Q2xhc3NlcyA9IGRpZ2VzdENsYXNzQ291bnRzKGNsYXNzZXMsIC0xKTsKICAgICAgICAgIGF0dHIuJHJlbW92ZUNsYXNzKG5ld0NsYXNzZXMpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZGlnZXN0Q2xhc3NDb3VudHMgKGNsYXNzZXMsIGNvdW50KSB7CiAgICAgICAgICB2YXIgY2xhc3NDb3VudHMgPSBlbGVtZW50LmRhdGEoJyRjbGFzc0NvdW50cycpIHx8IHt9OwogICAgICAgICAgdmFyIGNsYXNzZXNUb1VwZGF0ZSA9IFtdOwogICAgICAgICAgZm9yRWFjaChjbGFzc2VzLCBmdW5jdGlvbiAoY2xhc3NOYW1lKSB7CiAgICAgICAgICAgIGlmIChjb3VudCA+IDAgfHwgY2xhc3NDb3VudHNbY2xhc3NOYW1lXSkgewogICAgICAgICAgICAgIGNsYXNzQ291bnRzW2NsYXNzTmFtZV0gPSAoY2xhc3NDb3VudHNbY2xhc3NOYW1lXSB8fCAwKSArIGNvdW50OwogICAgICAgICAgICAgIGlmIChjbGFzc0NvdW50c1tjbGFzc05hbWVdID09PSArKGNvdW50ID4gMCkpIHsKICAgICAgICAgICAgICAgIGNsYXNzZXNUb1VwZGF0ZS5wdXNoKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGVsZW1lbnQuZGF0YSgnJGNsYXNzQ291bnRzJywgY2xhc3NDb3VudHMpOwogICAgICAgICAgcmV0dXJuIGNsYXNzZXNUb1VwZGF0ZS5qb2luKCcgJyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1cGRhdGVDbGFzc2VzIChvbGRDbGFzc2VzLCBuZXdDbGFzc2VzKSB7CiAgICAgICAgICB2YXIgdG9BZGQgPSBhcnJheURpZmZlcmVuY2UobmV3Q2xhc3Nlcywgb2xkQ2xhc3Nlcyk7CiAgICAgICAgICB2YXIgdG9SZW1vdmUgPSBhcnJheURpZmZlcmVuY2Uob2xkQ2xhc3NlcywgbmV3Q2xhc3Nlcyk7CiAgICAgICAgICB0b0FkZCA9IGRpZ2VzdENsYXNzQ291bnRzKHRvQWRkLCAxKTsKICAgICAgICAgIHRvUmVtb3ZlID0gZGlnZXN0Q2xhc3NDb3VudHModG9SZW1vdmUsIC0xKTsKICAgICAgICAgIGlmICh0b0FkZCAmJiB0b0FkZC5sZW5ndGgpIHsKICAgICAgICAgICAgJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgdG9BZGQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRvUmVtb3ZlICYmIHRvUmVtb3ZlLmxlbmd0aCkgewogICAgICAgICAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCB0b1JlbW92ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBuZ0NsYXNzV2F0Y2hBY3Rpb24obmV3VmFsKSB7CiAgICAgICAgICBpZiAoc2VsZWN0b3IgPT09IHRydWUgfHwgc2NvcGUuJGluZGV4ICUgMiA9PT0gc2VsZWN0b3IpIHsKICAgICAgICAgICAgdmFyIG5ld0NsYXNzZXMgPSBhcnJheUNsYXNzZXMobmV3VmFsIHx8IFtdKTsKICAgICAgICAgICAgaWYgKCFvbGRWYWwpIHsKICAgICAgICAgICAgICBhZGRDbGFzc2VzKG5ld0NsYXNzZXMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCFlcXVhbHMobmV3VmFsLG9sZFZhbCkpIHsKICAgICAgICAgICAgICB2YXIgb2xkQ2xhc3NlcyA9IGFycmF5Q2xhc3NlcyhvbGRWYWwpOwogICAgICAgICAgICAgIHVwZGF0ZUNsYXNzZXMob2xkQ2xhc3NlcywgbmV3Q2xhc3Nlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG9sZFZhbCA9IHNoYWxsb3dDb3B5KG5ld1ZhbCk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIGFycmF5RGlmZmVyZW5jZSh0b2tlbnMxLCB0b2tlbnMyKSB7CiAgICAgIHZhciB2YWx1ZXMgPSBbXTsKCiAgICAgIG91dGVyOgogICAgICBmb3IodmFyIGkgPSAwOyBpIDwgdG9rZW5zMS5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciB0b2tlbiA9IHRva2VuczFbaV07CiAgICAgICAgZm9yKHZhciBqID0gMDsgaiA8IHRva2VuczIubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmKHRva2VuID09IHRva2VuczJbal0pIGNvbnRpbnVlIG91dGVyOwogICAgICAgIH0KICAgICAgICB2YWx1ZXMucHVzaCh0b2tlbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0KCiAgICBmdW5jdGlvbiBhcnJheUNsYXNzZXMgKGNsYXNzVmFsKSB7CiAgICAgIGlmIChpc0FycmF5KGNsYXNzVmFsKSkgewogICAgICAgIHJldHVybiBjbGFzc1ZhbDsKICAgICAgfSBlbHNlIGlmIChpc1N0cmluZyhjbGFzc1ZhbCkpIHsKICAgICAgICByZXR1cm4gY2xhc3NWYWwuc3BsaXQoJyAnKTsKICAgICAgfSBlbHNlIGlmIChpc09iamVjdChjbGFzc1ZhbCkpIHsKICAgICAgICB2YXIgY2xhc3NlcyA9IFtdLCBpID0gMDsKICAgICAgICBmb3JFYWNoKGNsYXNzVmFsLCBmdW5jdGlvbih2LCBrKSB7CiAgICAgICAgICBpZiAodikgewogICAgICAgICAgICBjbGFzc2VzID0gY2xhc3Nlcy5jb25jYXQoay5zcGxpdCgnICcpKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gY2xhc3NlczsKICAgICAgfQogICAgICByZXR1cm4gY2xhc3NWYWw7CiAgICB9CiAgfV07Cn0KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQ2xhc3MKICogQHJlc3RyaWN0IEFDCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nQ2xhc3NgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIGR5bmFtaWNhbGx5IHNldCBDU1MgY2xhc3NlcyBvbiBhbiBIVE1MIGVsZW1lbnQgYnkgZGF0YWJpbmRpbmcKICogYW4gZXhwcmVzc2lvbiB0aGF0IHJlcHJlc2VudHMgYWxsIGNsYXNzZXMgdG8gYmUgYWRkZWQuCiAqCiAqIFRoZSBkaXJlY3RpdmUgb3BlcmF0ZXMgaW4gdGhyZWUgZGlmZmVyZW50IHdheXMsIGRlcGVuZGluZyBvbiB3aGljaCBvZiB0aHJlZSB0eXBlcyB0aGUgZXhwcmVzc2lvbgogKiBldmFsdWF0ZXMgdG86CiAqCiAqIDEuIElmIHRoZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhIHN0cmluZywgdGhlIHN0cmluZyBzaG91bGQgYmUgb25lIG9yIG1vcmUgc3BhY2UtZGVsaW1pdGVkIGNsYXNzCiAqIG5hbWVzLgogKgogKiAyLiBJZiB0aGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYW4gYXJyYXksIGVhY2ggZWxlbWVudCBvZiB0aGUgYXJyYXkgc2hvdWxkIGJlIGEgc3RyaW5nIHRoYXQgaXMKICogb25lIG9yIG1vcmUgc3BhY2UtZGVsaW1pdGVkIGNsYXNzIG5hbWVzLgogKgogKiAzLiBJZiB0aGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYW4gb2JqZWN0LCB0aGVuIGZvciBlYWNoIGtleS12YWx1ZSBwYWlyIG9mIHRoZQogKiBvYmplY3Qgd2l0aCBhIHRydXRoeSB2YWx1ZSB0aGUgY29ycmVzcG9uZGluZyBrZXkgaXMgdXNlZCBhcyBhIGNsYXNzIG5hbWUuCiAqCiAqIFRoZSBkaXJlY3RpdmUgd29uJ3QgYWRkIGR1cGxpY2F0ZSBjbGFzc2VzIGlmIGEgcGFydGljdWxhciBjbGFzcyB3YXMgYWxyZWFkeSBzZXQuCiAqCiAqIFdoZW4gdGhlIGV4cHJlc3Npb24gY2hhbmdlcywgdGhlIHByZXZpb3VzbHkgYWRkZWQgY2xhc3NlcyBhcmUgcmVtb3ZlZCBhbmQgb25seSB0aGVuIHRoZQogKiBuZXcgY2xhc3NlcyBhcmUgYWRkZWQuCiAqCiAqIEBhbmltYXRpb25zCiAqIGFkZCAtIGhhcHBlbnMganVzdCBiZWZvcmUgdGhlIGNsYXNzIGlzIGFwcGxpZWQgdG8gdGhlIGVsZW1lbnQKICogcmVtb3ZlIC0gaGFwcGVucyBqdXN0IGJlZm9yZSB0aGUgY2xhc3MgaXMgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50CiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xhc3Mge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gVGhlIHJlc3VsdAogKiAgIG9mIHRoZSBldmFsdWF0aW9uIGNhbiBiZSBhIHN0cmluZyByZXByZXNlbnRpbmcgc3BhY2UgZGVsaW1pdGVkIGNsYXNzCiAqICAgbmFtZXMsIGFuIGFycmF5LCBvciBhIG1hcCBvZiBjbGFzcyBuYW1lcyB0byBib29sZWFuIHZhbHVlcy4gSW4gdGhlIGNhc2Ugb2YgYSBtYXAsIHRoZQogKiAgIG5hbWVzIG9mIHRoZSBwcm9wZXJ0aWVzIHdob3NlIHZhbHVlcyBhcmUgdHJ1dGh5IHdpbGwgYmUgYWRkZWQgYXMgY3NzIGNsYXNzZXMgdG8gdGhlCiAqICAgZWxlbWVudC4KICoKICogQGV4YW1wbGUgRXhhbXBsZSB0aGF0IGRlbW9uc3RyYXRlcyBiYXNpYyBiaW5kaW5ncyB2aWEgbmdDbGFzcyBkaXJlY3RpdmUuCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHAgbmctY2xhc3M9IntzdHJpa2U6IGRlbGV0ZWQsIGJvbGQ6IGltcG9ydGFudCwgcmVkOiBlcnJvcn0iPk1hcCBTeW50YXggRXhhbXBsZTwvcD4KICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImRlbGV0ZWQiPiBkZWxldGVkIChhcHBseSAic3RyaWtlIiBjbGFzcyk8YnI+CiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJpbXBvcnRhbnQiPiBpbXBvcnRhbnQgKGFwcGx5ICJib2xkIiBjbGFzcyk8YnI+CiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJlcnJvciI+IGVycm9yIChhcHBseSAicmVkIiBjbGFzcykKICAgICAgIDxocj4KICAgICAgIDxwIG5nLWNsYXNzPSJzdHlsZSI+VXNpbmcgU3RyaW5nIFN5bnRheDwvcD4KICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ic3R5bGUiIHBsYWNlaG9sZGVyPSJUeXBlOiBib2xkIHN0cmlrZSByZWQiPgogICAgICAgPGhyPgogICAgICAgPHAgbmctY2xhc3M9IltzdHlsZTEsIHN0eWxlMiwgc3R5bGUzXSI+VXNpbmcgQXJyYXkgU3ludGF4PC9wPgogICAgICAgPGlucHV0IG5nLW1vZGVsPSJzdHlsZTEiIHBsYWNlaG9sZGVyPSJUeXBlOiBib2xkLCBzdHJpa2Ugb3IgcmVkIj48YnI+CiAgICAgICA8aW5wdXQgbmctbW9kZWw9InN0eWxlMiIgcGxhY2Vob2xkZXI9IlR5cGU6IGJvbGQsIHN0cmlrZSBvciByZWQiPjxicj4KICAgICAgIDxpbnB1dCBuZy1tb2RlbD0ic3R5bGUzIiBwbGFjZWhvbGRlcj0iVHlwZTogYm9sZCwgc3RyaWtlIG9yIHJlZCI+PGJyPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgLnN0cmlrZSB7CiAgICAgICAgIHRleHQtZGVjb3JhdGlvbjogbGluZS10aHJvdWdoOwogICAgICAgfQogICAgICAgLmJvbGQgewogICAgICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICAgfQogICAgICAgLnJlZCB7CiAgICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICB2YXIgcHMgPSBlbGVtZW50LmFsbChieS5jc3MoJ3AnKSk7CgogICAgICAgaXQoJ3Nob3VsZCBsZXQgeW91IHRvZ2dsZSB0aGUgY2xhc3MnLCBmdW5jdGlvbigpIHsKCiAgICAgICAgIGV4cGVjdChwcy5maXJzdCgpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkubm90LnRvTWF0Y2goL2JvbGQvKTsKICAgICAgICAgZXhwZWN0KHBzLmZpcnN0KCkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS5ub3QudG9NYXRjaCgvcmVkLyk7CgogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdpbXBvcnRhbnQnKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KHBzLmZpcnN0KCkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS50b01hdGNoKC9ib2xkLyk7CgogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdlcnJvcicpKS5jbGljaygpOwogICAgICAgICBleHBlY3QocHMuZmlyc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvTWF0Y2goL3JlZC8pOwogICAgICAgfSk7CgogICAgICAgaXQoJ3Nob3VsZCBsZXQgeW91IHRvZ2dsZSBzdHJpbmcgZXhhbXBsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QocHMuZ2V0KDEpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkudG9CZSgnJyk7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3N0eWxlJykpLmNsZWFyKCk7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3N0eWxlJykpLnNlbmRLZXlzKCdyZWQnKTsKICAgICAgICAgZXhwZWN0KHBzLmdldCgxKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvQmUoJ3JlZCcpOwogICAgICAgfSk7CgogICAgICAgaXQoJ2FycmF5IGV4YW1wbGUgc2hvdWxkIGhhdmUgMyBjbGFzc2VzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChwcy5sYXN0KCkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS50b0JlKCcnKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc3R5bGUxJykpLnNlbmRLZXlzKCdib2xkJyk7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3N0eWxlMicpKS5zZW5kS2V5cygnc3RyaWtlJyk7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3N0eWxlMycpKS5zZW5kS2V5cygncmVkJyk7CiAgICAgICAgIGV4cGVjdChwcy5sYXN0KCkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS50b0JlKCdib2xkIHN0cmlrZSByZWQnKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgoKICAgIyMgQW5pbWF0aW9ucwoKICAgVGhlIGV4YW1wbGUgYmVsb3cgZGVtb25zdHJhdGVzIGhvdyB0byBwZXJmb3JtIGFuaW1hdGlvbnMgdXNpbmcgbmdDbGFzcy4KCiAgIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8aW5wdXQgaWQ9InNldGJ0biIgdHlwZT0iYnV0dG9uIiB2YWx1ZT0ic2V0IiBuZy1jbGljaz0ibXlWYXI9J215LWNsYXNzJyI+CiAgICAgIDxpbnB1dCBpZD0iY2xlYXJidG4iIHR5cGU9ImJ1dHRvbiIgdmFsdWU9ImNsZWFyIiBuZy1jbGljaz0ibXlWYXI9JyciPgogICAgICA8YnI+CiAgICAgIDxzcGFuIGNsYXNzPSJiYXNlLWNsYXNzIiBuZy1jbGFzcz0ibXlWYXIiPlNhbXBsZSBUZXh0PC9zcGFuPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgLmJhc2UtY2xhc3MgewogICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgICAgdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgfQoKICAgICAgIC5iYXNlLWNsYXNzLm15LWNsYXNzIHsKICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgICAgZm9udC1zaXplOjNlbTsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWNsYXNzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnLmJhc2UtY2xhc3MnKSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS5ub3QuCiAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKCiAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ3NldGJ0bicpKS5jbGljaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcuYmFzZS1jbGFzcycpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLgogICAgICAgICAgIHRvTWF0Y2goL215LWNsYXNzLyk7CgogICAgICAgICBlbGVtZW50KGJ5LmlkKCdjbGVhcmJ0bicpKS5jbGljaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcuYmFzZS1jbGFzcycpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLm5vdC4KICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CgoKICAgIyMgbmdDbGFzcyBhbmQgcHJlLWV4aXN0aW5nIENTUzMgVHJhbnNpdGlvbnMvQW5pbWF0aW9ucwogICBUaGUgbmdDbGFzcyBkaXJlY3RpdmUgc3RpbGwgc3VwcG9ydHMgQ1NTMyBUcmFuc2l0aW9ucy9BbmltYXRpb25zIGV2ZW4gaWYgdGhleSBkbyBub3QgZm9sbG93IHRoZSBuZ0FuaW1hdGUgQ1NTIG5hbWluZyBzdHJ1Y3R1cmUuCiAgIFVwb24gYW5pbWF0aW9uIG5nQW5pbWF0ZSB3aWxsIGFwcGx5IHN1cHBsZW1lbnRhcnkgQ1NTIGNsYXNzZXMgdG8gdHJhY2sgdGhlIHN0YXJ0IGFuZCBlbmQgb2YgYW4gYW5pbWF0aW9uLCBidXQgdGhpcyB3aWxsIG5vdCBoaW5kZXIKICAgYW55IHByZS1leGlzdGluZyBDU1MgdHJhbnNpdGlvbnMgYWxyZWFkeSBvbiB0aGUgZWxlbWVudC4gVG8gZ2V0IGFuIGlkZWEgb2Ygd2hhdCBoYXBwZW5zIGR1cmluZyBhIGNsYXNzLWJhc2VkIGFuaW1hdGlvbiwgYmUgc3VyZQogICB0byB2aWV3IHRoZSBzdGVwIGJ5IHN0ZXAgZGV0YWlscyBvZiB7QGxpbmsgbmcuJGFuaW1hdGUjYWRkQ2xhc3MgJGFuaW1hdGUuYWRkQ2xhc3N9IGFuZAogICB7QGxpbmsgbmcuJGFuaW1hdGUjcmVtb3ZlQ2xhc3MgJGFuaW1hdGUucmVtb3ZlQ2xhc3N9LgogKi8KdmFyIG5nQ2xhc3NEaXJlY3RpdmUgPSBjbGFzc0RpcmVjdGl2ZSgnJywgdHJ1ZSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0NsYXNzT2RkCiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0NsYXNzT2RkYCBhbmQgYG5nQ2xhc3NFdmVuYCBkaXJlY3RpdmVzIHdvcmsgZXhhY3RseSBhcwogKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xhc3MgbmdDbGFzc30sIGV4Y2VwdCB0aGV5IHdvcmsgaW4KICogY29uanVuY3Rpb24gd2l0aCBgbmdSZXBlYXRgIGFuZCB0YWtlIGVmZmVjdCBvbmx5IG9uIG9kZCAoZXZlbikgcm93cy4KICoKICogVGhpcyBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgb25seSB3aXRoaW4gdGhlIHNjb3BlIG9mIGFuCiAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9LgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzT2RkIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZSByZXN1bHQKICogICBvZiB0aGUgZXZhbHVhdGlvbiBjYW4gYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHNwYWNlIGRlbGltaXRlZCBjbGFzcyBuYW1lcyBvciBhbiBhcnJheS4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPG9sIG5nLWluaXQ9Im5hbWVzPVsnSm9obicsICdNYXJ5JywgJ0NhdGUnLCAnU3V6J10iPgogICAgICAgICAgPGxpIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgICAgICAgPHNwYW4gbmctY2xhc3Mtb2RkPSInb2RkJyIgbmctY2xhc3MtZXZlbj0iJ2V2ZW4nIj4KICAgICAgICAgICAgIHt7bmFtZX19CiAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgPC9saT4KICAgICAgICA8L29sPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgLm9kZCB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgICAgICAuZXZlbiB7CiAgICAgICAgIGNvbG9yOiBibHVlOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3Mtb2RkIGFuZCBuZy1jbGFzcy1ldmVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LnJlcGVhdGVyKCduYW1lIGluIG5hbWVzJykucm93KDApLmNvbHVtbignbmFtZScpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLgogICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5yZXBlYXRlcignbmFtZSBpbiBuYW1lcycpLnJvdygxKS5jb2x1bW4oJ25hbWUnKSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS4KICAgICAgICAgICB0b01hdGNoKC9ldmVuLyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCnZhciBuZ0NsYXNzT2RkRGlyZWN0aXZlID0gY2xhc3NEaXJlY3RpdmUoJ09kZCcsIDApOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDbGFzc0V2ZW4KICogQHJlc3RyaWN0IEFDCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nQ2xhc3NPZGRgIGFuZCBgbmdDbGFzc0V2ZW5gIGRpcmVjdGl2ZXMgd29yayBleGFjdGx5IGFzCiAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGFzcyBuZ0NsYXNzfSwgZXhjZXB0IHRoZXkgd29yayBpbgogKiBjb25qdW5jdGlvbiB3aXRoIGBuZ1JlcGVhdGAgYW5kIHRha2UgZWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogKgogKiBUaGlzIGRpcmVjdGl2ZSBjYW4gYmUgYXBwbGllZCBvbmx5IHdpdGhpbiB0aGUgc2NvcGUgb2YgYW4KICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0uCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xhc3NFdmVuIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZQogKiAgIHJlc3VsdCBvZiB0aGUgZXZhbHVhdGlvbiBjYW4gYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHNwYWNlIGRlbGltaXRlZCBjbGFzcyBuYW1lcyBvciBhbiBhcnJheS4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPG9sIG5nLWluaXQ9Im5hbWVzPVsnSm9obicsICdNYXJ5JywgJ0NhdGUnLCAnU3V6J10iPgogICAgICAgICAgPGxpIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgICAgICAgPHNwYW4gbmctY2xhc3Mtb2RkPSInb2RkJyIgbmctY2xhc3MtZXZlbj0iJ2V2ZW4nIj4KICAgICAgICAgICAgIHt7bmFtZX19ICZuYnNwOyAmbmJzcDsgJm5ic3A7CiAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgPC9saT4KICAgICAgICA8L29sPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgLm9kZCB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgICAgICAuZXZlbiB7CiAgICAgICAgIGNvbG9yOiBibHVlOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3Mtb2RkIGFuZCBuZy1jbGFzcy1ldmVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LnJlcGVhdGVyKCduYW1lIGluIG5hbWVzJykucm93KDApLmNvbHVtbignbmFtZScpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLgogICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5yZXBlYXRlcignbmFtZSBpbiBuYW1lcycpLnJvdygxKS5jb2x1bW4oJ25hbWUnKSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS4KICAgICAgICAgICB0b01hdGNoKC9ldmVuLyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCnZhciBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCdFdmVuJywgMSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0Nsb2FrCiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgaXMgdXNlZCB0byBwcmV2ZW50IHRoZSBBbmd1bGFyIGh0bWwgdGVtcGxhdGUgZnJvbSBiZWluZyBicmllZmx5CiAqIGRpc3BsYXllZCBieSB0aGUgYnJvd3NlciBpbiBpdHMgcmF3ICh1bmNvbXBpbGVkKSBmb3JtIHdoaWxlIHlvdXIgYXBwbGljYXRpb24gaXMgbG9hZGluZy4gVXNlIHRoaXMKICogZGlyZWN0aXZlIHRvIGF2b2lkIHRoZSB1bmRlc2lyYWJsZSBmbGlja2VyIGVmZmVjdCBjYXVzZWQgYnkgdGhlIGh0bWwgdGVtcGxhdGUgZGlzcGxheS4KICoKICogVGhlIGRpcmVjdGl2ZSBjYW4gYmUgYXBwbGllZCB0byB0aGUgYDxib2R5PmAgZWxlbWVudCwgYnV0IHRoZSBwcmVmZXJyZWQgdXNhZ2UgaXMgdG8gYXBwbHkKICogbXVsdGlwbGUgYG5nQ2xvYWtgIGRpcmVjdGl2ZXMgdG8gc21hbGwgcG9ydGlvbnMgb2YgdGhlIHBhZ2UgdG8gcGVybWl0IHByb2dyZXNzaXZlIHJlbmRlcmluZwogKiBvZiB0aGUgYnJvd3NlciB2aWV3LgogKgogKiBgbmdDbG9ha2Agd29ya3MgaW4gY29vcGVyYXRpb24gd2l0aCB0aGUgZm9sbG93aW5nIGNzcyBydWxlIGVtYmVkZGVkIHdpdGhpbiBgYW5ndWxhci5qc2AgYW5kCiAqIGBhbmd1bGFyLm1pbi5qc2AuCiAqIEZvciBDU1AgbW9kZSBwbGVhc2UgYWRkIGBhbmd1bGFyLWNzcC5jc3NgIHRvIHlvdXIgaHRtbCBmaWxlIChzZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NzcCBuZ0NzcH0pLgogKgogKiBgYGBjc3MKICogW25nXDpjbG9ha10sIFtuZy1jbG9ha10sIFtkYXRhLW5nLWNsb2FrXSwgW3gtbmctY2xvYWtdLCAubmctY2xvYWssIC54LW5nLWNsb2FrIHsKICogICBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7CiAqIH0KICogYGBgCiAqCiAqIFdoZW4gdGhpcyBjc3MgcnVsZSBpcyBsb2FkZWQgYnkgdGhlIGJyb3dzZXIsIGFsbCBodG1sIGVsZW1lbnRzIChpbmNsdWRpbmcgdGhlaXIgY2hpbGRyZW4pIHRoYXQKICogYXJlIHRhZ2dlZCB3aXRoIHRoZSBgbmdDbG9ha2AgZGlyZWN0aXZlIGFyZSBoaWRkZW4uIFdoZW4gQW5ndWxhciBlbmNvdW50ZXJzIHRoaXMgZGlyZWN0aXZlCiAqIGR1cmluZyB0aGUgY29tcGlsYXRpb24gb2YgdGhlIHRlbXBsYXRlIGl0IGRlbGV0ZXMgdGhlIGBuZ0Nsb2FrYCBlbGVtZW50IGF0dHJpYnV0ZSwgbWFraW5nCiAqIHRoZSBjb21waWxlZCBlbGVtZW50IHZpc2libGUuCiAqCiAqIEZvciB0aGUgYmVzdCByZXN1bHQsIHRoZSBgYW5ndWxhci5qc2Agc2NyaXB0IG11c3QgYmUgbG9hZGVkIGluIHRoZSBoZWFkIHNlY3Rpb24gb2YgdGhlIGh0bWwKICogZG9jdW1lbnQ7IGFsdGVybmF0aXZlbHksIHRoZSBjc3MgcnVsZSBhYm92ZSBtdXN0IGJlIGluY2x1ZGVkIGluIHRoZSBleHRlcm5hbCBzdHlsZXNoZWV0IG9mIHRoZQogKiBhcHBsaWNhdGlvbi4KICoKICogTGVnYWN5IGJyb3dzZXJzLCBsaWtlIElFNywgZG8gbm90IHByb3ZpZGUgYXR0cmlidXRlIHNlbGVjdG9yIHN1cHBvcnQgKGFkZGVkIGluIENTUyAyLjEpIHNvIHRoZXkKICogY2Fubm90IG1hdGNoIHRoZSBgW25nXDpjbG9ha11gIHNlbGVjdG9yLiBUbyB3b3JrIGFyb3VuZCB0aGlzIGxpbWl0YXRpb24sIHlvdSBtdXN0IGFkZCB0aGUgY3NzCiAqIGNsYXNzIGBuZy1jbG9ha2AgaW4gYWRkaXRpb24gdG8gdGhlIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgYXMgc2hvd24gaW4gdGhlIGV4YW1wbGUgYmVsb3cuCiAqCiAqIEBlbGVtZW50IEFOWQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICA8ZGl2IGlkPSJ0ZW1wbGF0ZTEiIG5nLWNsb2FrPnt7ICdoZWxsbycgfX08L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJ0ZW1wbGF0ZTIiIG5nLWNsb2FrIGNsYXNzPSJuZy1jbG9hayI+e3sgJ2hlbGxvIElFNycgfX08L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIHJlbW92ZSB0aGUgdGVtcGxhdGUgZGlyZWN0aXZlIGFuZCBjc3MgY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KCQoJyN0ZW1wbGF0ZTEnKS5nZXRBdHRyaWJ1dGUoJ25nLWNsb2FrJykpLgogICAgICAgICAgIHRvQmVOdWxsKCk7CiAgICAgICAgIGV4cGVjdCgkKCcjdGVtcGxhdGUyJykuZ2V0QXR0cmlidXRlKCduZy1jbG9haycpKS4KICAgICAgICAgICB0b0JlTnVsbCgpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqCiAqLwp2YXIgbmdDbG9ha0RpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICBhdHRyLiRzZXQoJ25nQ2xvYWsnLCB1bmRlZmluZWQpOwogICAgZWxlbWVudC5yZW1vdmVDbGFzcygnbmctY2xvYWsnKTsKICB9Cn0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDb250cm9sbGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nQ29udHJvbGxlcmAgZGlyZWN0aXZlIGF0dGFjaGVzIGEgY29udHJvbGxlciBjbGFzcyB0byB0aGUgdmlldy4gVGhpcyBpcyBhIGtleSBhc3BlY3Qgb2YgaG93IGFuZ3VsYXIKICogc3VwcG9ydHMgdGhlIHByaW5jaXBsZXMgYmVoaW5kIHRoZSBNb2RlbC1WaWV3LUNvbnRyb2xsZXIgZGVzaWduIHBhdHRlcm4uCiAqCiAqIE1WQyBjb21wb25lbnRzIGluIGFuZ3VsYXI6CiAqCiAqICogTW9kZWwg4oCUIE1vZGVscyBhcmUgdGhlIHByb3BlcnRpZXMgb2YgYSBzY29wZTsgc2NvcGVzIGFyZSBhdHRhY2hlZCB0byB0aGUgRE9NIHdoZXJlIHNjb3BlIHByb3BlcnRpZXMKICogICBhcmUgYWNjZXNzZWQgdGhyb3VnaCBiaW5kaW5ncy4KICogKiBWaWV3IOKAlCBUaGUgdGVtcGxhdGUgKEhUTUwgd2l0aCBkYXRhIGJpbmRpbmdzKSB0aGF0IGlzIHJlbmRlcmVkIGludG8gdGhlIFZpZXcuCiAqICogQ29udHJvbGxlciDigJQgVGhlIGBuZ0NvbnRyb2xsZXJgIGRpcmVjdGl2ZSBzcGVjaWZpZXMgYSBDb250cm9sbGVyIGNsYXNzOyB0aGUgY2xhc3MgY29udGFpbnMgYnVzaW5lc3MKICogICBsb2dpYyBiZWhpbmQgdGhlIGFwcGxpY2F0aW9uIHRvIGRlY29yYXRlIHRoZSBzY29wZSB3aXRoIGZ1bmN0aW9ucyBhbmQgdmFsdWVzCiAqCiAqIE5vdGUgdGhhdCB5b3UgY2FuIGFsc28gYXR0YWNoIGNvbnRyb2xsZXJzIHRvIHRoZSBET00gYnkgZGVjbGFyaW5nIGl0IGluIGEgcm91dGUgZGVmaW5pdGlvbgogKiB2aWEgdGhlIHtAbGluayBuZ1JvdXRlLiRyb3V0ZSAkcm91dGV9IHNlcnZpY2UuIEEgY29tbW9uIG1pc3Rha2UgaXMgdG8gZGVjbGFyZSB0aGUgY29udHJvbGxlcgogKiBhZ2FpbiB1c2luZyBgbmctY29udHJvbGxlcmAgaW4gdGhlIHRlbXBsYXRlIGl0c2VsZi4gIFRoaXMgd2lsbCBjYXVzZSB0aGUgY29udHJvbGxlciB0byBiZSBhdHRhY2hlZAogKiBhbmQgZXhlY3V0ZWQgdHdpY2UuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAc2NvcGUKICogQHByaW9yaXR5IDUwMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ29udHJvbGxlciBOYW1lIG9mIGEgY29uc3RydWN0b3IgZnVuY3Rpb24gcmVnaXN0ZXJlZCB3aXRoIHRoZSBjdXJyZW50CiAqIHtAbGluayBuZy4kY29udHJvbGxlclByb3ZpZGVyICRjb250cm9sbGVyUHJvdmlkZXJ9IG9yIGFuIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259CiAqIHRoYXQgb24gdGhlIGN1cnJlbnQgc2NvcGUgZXZhbHVhdGVzIHRvIGEgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAqCiAqIFRoZSBjb250cm9sbGVyIGluc3RhbmNlIGNhbiBiZSBwdWJsaXNoZWQgaW50byBhIHNjb3BlIHByb3BlcnR5IGJ5IHNwZWNpZnlpbmcKICogYG5nLWNvbnRyb2xsZXI9ImFzIHByb3BlcnR5TmFtZSJgLgogKgogKiBJZiB0aGUgY3VycmVudCBgJGNvbnRyb2xsZXJQcm92aWRlcmAgaXMgY29uZmlndXJlZCB0byB1c2UgZ2xvYmFscyAodmlhCiAqIHtAbGluayBuZy4kY29udHJvbGxlclByb3ZpZGVyI2FsbG93R2xvYmFscyBgJGNvbnRyb2xsZXJQcm92aWRlci5hbGxvd0dsb2JhbHMoKWAgfSksIHRoaXMgbWF5CiAqIGFsc28gYmUgdGhlIG5hbWUgb2YgYSBnbG9iYWxseSBhY2Nlc3NpYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIChub3QgcmVjb21tZW5kZWQpLgogKgogKiBAZXhhbXBsZQogKiBIZXJlIGlzIGEgc2ltcGxlIGZvcm0gZm9yIGVkaXRpbmcgdXNlciBjb250YWN0IGluZm9ybWF0aW9uLiBBZGRpbmcsIHJlbW92aW5nLCBjbGVhcmluZywgYW5kCiAqIGdyZWV0aW5nIGFyZSBtZXRob2RzIGRlY2xhcmVkIG9uIHRoZSBjb250cm9sbGVyIChzZWUgc291cmNlIHRhYikuIFRoZXNlIG1ldGhvZHMgY2FuCiAqIGVhc2lseSBiZSBjYWxsZWQgZnJvbSB0aGUgYW5ndWxhciBtYXJrdXAuIEFueSBjaGFuZ2VzIHRvIHRoZSBkYXRhIGFyZSBhdXRvbWF0aWNhbGx5IHJlZmxlY3RlZAogKiBpbiB0aGUgVmlldyB3aXRob3V0IHRoZSBuZWVkIGZvciBhIG1hbnVhbCB1cGRhdGUuCiAqCiAqIFR3byBkaWZmZXJlbnQgZGVjbGFyYXRpb24gc3R5bGVzIGFyZSBpbmNsdWRlZCBiZWxvdzoKICoKICogKiBvbmUgYmluZHMgbWV0aG9kcyBhbmQgcHJvcGVydGllcyBkaXJlY3RseSBvbnRvIHRoZSBjb250cm9sbGVyIHVzaW5nIGB0aGlzYDoKICogYG5nLWNvbnRyb2xsZXI9IlNldHRpbmdzQ29udHJvbGxlcjEgYXMgc2V0dGluZ3MiYAogKiAqIG9uZSBpbmplY3RzIGAkc2NvcGVgIGludG8gdGhlIGNvbnRyb2xsZXI6CiAqIGBuZy1jb250cm9sbGVyPSJTZXR0aW5nc0NvbnRyb2xsZXIyImAKICoKICogVGhlIHNlY29uZCBvcHRpb24gaXMgbW9yZSBjb21tb24gaW4gdGhlIEFuZ3VsYXIgY29tbXVuaXR5LCBhbmQgaXMgZ2VuZXJhbGx5IHVzZWQgaW4gYm9pbGVycGxhdGVzCiAqIGFuZCBpbiB0aGlzIGd1aWRlLiBIb3dldmVyLCB0aGVyZSBhcmUgYWR2YW50YWdlcyB0byBiaW5kaW5nIHByb3BlcnRpZXMgZGlyZWN0bHkgdG8gdGhlIGNvbnRyb2xsZXIKICogYW5kIGF2b2lkaW5nIHNjb3BlLgogKgogKiAqIFVzaW5nIGBjb250cm9sbGVyIGFzYCBtYWtlcyBpdCBvYnZpb3VzIHdoaWNoIGNvbnRyb2xsZXIgeW91IGFyZSBhY2Nlc3NpbmcgaW4gdGhlIHRlbXBsYXRlIHdoZW4KICogbXVsdGlwbGUgY29udHJvbGxlcnMgYXBwbHkgdG8gYW4gZWxlbWVudC4KICogKiBJZiB5b3UgYXJlIHdyaXRpbmcgeW91ciBjb250cm9sbGVycyBhcyBjbGFzc2VzIHlvdSBoYXZlIGVhc2llciBhY2Nlc3MgdG8gdGhlIHByb3BlcnRpZXMgYW5kCiAqIG1ldGhvZHMsIHdoaWNoIHdpbGwgYXBwZWFyIG9uIHRoZSBzY29wZSwgZnJvbSBpbnNpZGUgdGhlIGNvbnRyb2xsZXIgY29kZS4KICogKiBTaW5jZSB0aGVyZSBpcyBhbHdheXMgYSBgLmAgaW4gdGhlIGJpbmRpbmdzLCB5b3UgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCBwcm90b3R5cGFsCiAqIGluaGVyaXRhbmNlIG1hc2tpbmcgcHJpbWl0aXZlcy4KICoKICogVGhpcyBleGFtcGxlIGRlbW9uc3RyYXRlcyB0aGUgYGNvbnRyb2xsZXIgYXNgIHN5bnRheC4KICoKICogPGV4YW1wbGUgbmFtZT0ibmdDb250cm9sbGVyQXMiIG1vZHVsZT0iY29udHJvbGxlckFzRXhhbXBsZSI+CiAqICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAqICAgIDxkaXYgaWQ9ImN0cmwtYXMtZXhtcGwiIG5nLWNvbnRyb2xsZXI9IlNldHRpbmdzQ29udHJvbGxlcjEgYXMgc2V0dGluZ3MiPgogKiAgICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ic2V0dGluZ3MubmFtZSIvPgogKiAgICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0ic2V0dGluZ3MuZ3JlZXQoKSI+Z3JlZXQ8L2E+IF08YnIvPgogKiAgICAgIENvbnRhY3Q6CiAqICAgICAgPHVsPgogKiAgICAgICAgPGxpIG5nLXJlcGVhdD0iY29udGFjdCBpbiBzZXR0aW5ncy5jb250YWN0cyI+CiAqICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbnRhY3QudHlwZSI+CiAqICAgICAgICAgICAgIDxvcHRpb24+cGhvbmU8L29wdGlvbj4KICogICAgICAgICAgICAgPG9wdGlvbj5lbWFpbDwvb3B0aW9uPgogKiAgICAgICAgICA8L3NlbGVjdD4KICogICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJjb250YWN0LnZhbHVlIi8+CiAqICAgICAgICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0ic2V0dGluZ3MuY2xlYXJDb250YWN0KGNvbnRhY3QpIj5jbGVhcjwvYT4KICogICAgICAgICAgfCA8YSBocmVmPSIiIG5nLWNsaWNrPSJzZXR0aW5ncy5yZW1vdmVDb250YWN0KGNvbnRhY3QpIj5YPC9hPiBdCiAqICAgICAgICA8L2xpPgogKiAgICAgICAgPGxpPlsgPGEgaHJlZj0iIiBuZy1jbGljaz0ic2V0dGluZ3MuYWRkQ29udGFjdCgpIj5hZGQ8L2E+IF08L2xpPgogKiAgICAgPC91bD4KICogICAgPC9kaXY+CiAqICAgPC9maWxlPgogKiAgIDxmaWxlIG5hbWU9ImFwcC5qcyI+CiAqICAgIGFuZ3VsYXIubW9kdWxlKCdjb250cm9sbGVyQXNFeGFtcGxlJywgW10pCiAqICAgICAgLmNvbnRyb2xsZXIoJ1NldHRpbmdzQ29udHJvbGxlcjEnLCBTZXR0aW5nc0NvbnRyb2xsZXIxKTsKICoKICogICAgZnVuY3Rpb24gU2V0dGluZ3NDb250cm9sbGVyMSgpIHsKICogICAgICB0aGlzLm5hbWUgPSAiSm9obiBTbWl0aCI7CiAqICAgICAgdGhpcy5jb250YWN0cyA9IFsKICogICAgICAgIHt0eXBlOiAncGhvbmUnLCB2YWx1ZTogJzQwOCA1NTUgMTIxMid9LAogKiAgICAgICAge3R5cGU6ICdlbWFpbCcsIHZhbHVlOiAnam9obi5zbWl0aEBleGFtcGxlLm9yZyd9IF07CiAqICAgIH0KICoKICogICAgU2V0dGluZ3NDb250cm9sbGVyMS5wcm90b3R5cGUuZ3JlZXQgPSBmdW5jdGlvbigpIHsKICogICAgICBhbGVydCh0aGlzLm5hbWUpOwogKiAgICB9OwogKgogKiAgICBTZXR0aW5nc0NvbnRyb2xsZXIxLnByb3RvdHlwZS5hZGRDb250YWN0ID0gZnVuY3Rpb24oKSB7CiAqICAgICAgdGhpcy5jb250YWN0cy5wdXNoKHt0eXBlOiAnZW1haWwnLCB2YWx1ZTogJ3lvdXJuYW1lQGV4YW1wbGUub3JnJ30pOwogKiAgICB9OwogKgogKiAgICBTZXR0aW5nc0NvbnRyb2xsZXIxLnByb3RvdHlwZS5yZW1vdmVDb250YWN0ID0gZnVuY3Rpb24oY29udGFjdFRvUmVtb3ZlKSB7CiAqICAgICB2YXIgaW5kZXggPSB0aGlzLmNvbnRhY3RzLmluZGV4T2YoY29udGFjdFRvUmVtb3ZlKTsKICogICAgICB0aGlzLmNvbnRhY3RzLnNwbGljZShpbmRleCwgMSk7CiAqICAgIH07CiAqCiAqICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLmNsZWFyQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3QpIHsKICogICAgICBjb250YWN0LnR5cGUgPSAncGhvbmUnOwogKiAgICAgIGNvbnRhY3QudmFsdWUgPSAnJzsKICogICAgfTsKICogICA8L2ZpbGU+CiAqICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAqICAgICBpdCgnc2hvdWxkIGNoZWNrIGNvbnRyb2xsZXIgYXMnLCBmdW5jdGlvbigpIHsKICogICAgICAgdmFyIGNvbnRhaW5lciA9IGVsZW1lbnQoYnkuaWQoJ2N0cmwtYXMtZXhtcGwnKSk7CiAqICAgICAgICAgZXhwZWN0KGNvbnRhaW5lci5lbGVtZW50KGJ5Lm1vZGVsKCdzZXR0aW5ncy5uYW1lJykpCiAqICAgICAgICAgICAuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0JlKCdKb2huIFNtaXRoJyk7CiAqCiAqICAgICAgIHZhciBmaXJzdFJlcGVhdCA9CiAqICAgICAgICAgICBjb250YWluZXIuZWxlbWVudChieS5yZXBlYXRlcignY29udGFjdCBpbiBzZXR0aW5ncy5jb250YWN0cycpLnJvdygwKSk7CiAqICAgICAgIHZhciBzZWNvbmRSZXBlYXQgPQogKiAgICAgICAgICAgY29udGFpbmVyLmVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gc2V0dGluZ3MuY29udGFjdHMnKS5yb3coMSkpOwogKgogKiAgICAgICBleHBlY3QoZmlyc3RSZXBlYXQuZWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgICAudG9CZSgnNDA4IDU1NSAxMjEyJyk7CiAqCiAqICAgICAgIGV4cGVjdChzZWNvbmRSZXBlYXQuZWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgICAudG9CZSgnam9obi5zbWl0aEBleGFtcGxlLm9yZycpOwogKgogKiAgICAgICBmaXJzdFJlcGVhdC5lbGVtZW50KGJ5LmxpbmtUZXh0KCdjbGVhcicpKS5jbGljaygpOwogKgogKiAgICAgICBleHBlY3QoZmlyc3RSZXBlYXQuZWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgICAudG9CZSgnJyk7CiAqCiAqICAgICAgIGNvbnRhaW5lci5lbGVtZW50KGJ5LmxpbmtUZXh0KCdhZGQnKSkuY2xpY2soKTsKICoKICogICAgICAgZXhwZWN0KGNvbnRhaW5lci5lbGVtZW50KGJ5LnJlcGVhdGVyKCdjb250YWN0IGluIHNldHRpbmdzLmNvbnRhY3RzJykucm93KDIpKQogKiAgICAgICAgICAgLmVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkKICogICAgICAgICAgIC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgICAudG9CZSgneW91cm5hbWVAZXhhbXBsZS5vcmcnKTsKICogICAgIH0pOwogKiAgIDwvZmlsZT4KICogPC9leGFtcGxlPgogKgogKiBUaGlzIGV4YW1wbGUgZGVtb25zdHJhdGVzIHRoZSAiYXR0YWNoIHRvIGAkc2NvcGVgIiBzdHlsZSBvZiBjb250cm9sbGVyLgogKgogKiA8ZXhhbXBsZSBuYW1lPSJuZ0NvbnRyb2xsZXIiIG1vZHVsZT0iY29udHJvbGxlckV4YW1wbGUiPgogKiAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAqICAgPGRpdiBpZD0iY3RybC1leG1wbCIgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyMiI+CiAqICAgICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiLz4KICogICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0iZ3JlZXQoKSI+Z3JlZXQ8L2E+IF08YnIvPgogKiAgICAgQ29udGFjdDoKICogICAgIDx1bD4KICogICAgICAgPGxpIG5nLXJlcGVhdD0iY29udGFjdCBpbiBjb250YWN0cyI+CiAqICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29udGFjdC50eXBlIj4KICogICAgICAgICAgICA8b3B0aW9uPnBob25lPC9vcHRpb24+CiAqICAgICAgICAgICAgPG9wdGlvbj5lbWFpbDwvb3B0aW9uPgogKiAgICAgICAgIDwvc2VsZWN0PgogKiAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0iY29udGFjdC52YWx1ZSIvPgogKiAgICAgICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0iY2xlYXJDb250YWN0KGNvbnRhY3QpIj5jbGVhcjwvYT4KICogICAgICAgICB8IDxhIGhyZWY9IiIgbmctY2xpY2s9InJlbW92ZUNvbnRhY3QoY29udGFjdCkiPlg8L2E+IF0KICogICAgICAgPC9saT4KICogICAgICAgPGxpPlsgPGEgaHJlZj0iIiBuZy1jbGljaz0iYWRkQ29udGFjdCgpIj5hZGQ8L2E+IF08L2xpPgogKiAgICA8L3VsPgogKiAgIDwvZGl2PgogKiAgPC9maWxlPgogKiAgPGZpbGUgbmFtZT0iYXBwLmpzIj4KICogICBhbmd1bGFyLm1vZHVsZSgnY29udHJvbGxlckV4YW1wbGUnLCBbXSkKICogICAgIC5jb250cm9sbGVyKCdTZXR0aW5nc0NvbnRyb2xsZXIyJywgWyckc2NvcGUnLCBTZXR0aW5nc0NvbnRyb2xsZXIyXSk7CiAqCiAqICAgZnVuY3Rpb24gU2V0dGluZ3NDb250cm9sbGVyMigkc2NvcGUpIHsKICogICAgICRzY29wZS5uYW1lID0gIkpvaG4gU21pdGgiOwogKiAgICAgJHNjb3BlLmNvbnRhY3RzID0gWwogKiAgICAgICB7dHlwZToncGhvbmUnLCB2YWx1ZTonNDA4IDU1NSAxMjEyJ30sCiAqICAgICAgIHt0eXBlOidlbWFpbCcsIHZhbHVlOidqb2huLnNtaXRoQGV4YW1wbGUub3JnJ30gXTsKICoKICogICAgICRzY29wZS5ncmVldCA9IGZ1bmN0aW9uKCkgewogKiAgICAgICBhbGVydCgkc2NvcGUubmFtZSk7CiAqICAgICB9OwogKgogKiAgICAgJHNjb3BlLmFkZENvbnRhY3QgPSBmdW5jdGlvbigpIHsKICogICAgICAgJHNjb3BlLmNvbnRhY3RzLnB1c2goe3R5cGU6J2VtYWlsJywgdmFsdWU6J3lvdXJuYW1lQGV4YW1wbGUub3JnJ30pOwogKiAgICAgfTsKICoKICogICAgICRzY29wZS5yZW1vdmVDb250YWN0ID0gZnVuY3Rpb24oY29udGFjdFRvUmVtb3ZlKSB7CiAqICAgICAgIHZhciBpbmRleCA9ICRzY29wZS5jb250YWN0cy5pbmRleE9mKGNvbnRhY3RUb1JlbW92ZSk7CiAqICAgICAgICRzY29wZS5jb250YWN0cy5zcGxpY2UoaW5kZXgsIDEpOwogKiAgICAgfTsKICoKICogICAgICRzY29wZS5jbGVhckNvbnRhY3QgPSBmdW5jdGlvbihjb250YWN0KSB7CiAqICAgICAgIGNvbnRhY3QudHlwZSA9ICdwaG9uZSc7CiAqICAgICAgIGNvbnRhY3QudmFsdWUgPSAnJzsKICogICAgIH07CiAqICAgfQogKiAgPC9maWxlPgogKiAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAqICAgIGl0KCdzaG91bGQgY2hlY2sgY29udHJvbGxlcicsIGZ1bmN0aW9uKCkgewogKiAgICAgIHZhciBjb250YWluZXIgPSBlbGVtZW50KGJ5LmlkKCdjdHJsLWV4bXBsJykpOwogKgogKiAgICAgIGV4cGVjdChjb250YWluZXIuZWxlbWVudChieS5tb2RlbCgnbmFtZScpKQogKiAgICAgICAgICAuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0JlKCdKb2huIFNtaXRoJyk7CiAqCiAqICAgICAgdmFyIGZpcnN0UmVwZWF0ID0KICogICAgICAgICAgY29udGFpbmVyLmVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gY29udGFjdHMnKS5yb3coMCkpOwogKiAgICAgIHZhciBzZWNvbmRSZXBlYXQgPQogKiAgICAgICAgICBjb250YWluZXIuZWxlbWVudChieS5yZXBlYXRlcignY29udGFjdCBpbiBjb250YWN0cycpLnJvdygxKSk7CiAqCiAqICAgICAgZXhwZWN0KGZpcnN0UmVwZWF0LmVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogKiAgICAgICAgICAudG9CZSgnNDA4IDU1NSAxMjEyJyk7CiAqICAgICAgZXhwZWN0KHNlY29uZFJlcGVhdC5lbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICogICAgICAgICAgLnRvQmUoJ2pvaG4uc21pdGhAZXhhbXBsZS5vcmcnKTsKICoKICogICAgICBmaXJzdFJlcGVhdC5lbGVtZW50KGJ5LmxpbmtUZXh0KCdjbGVhcicpKS5jbGljaygpOwogKgogKiAgICAgIGV4cGVjdChmaXJzdFJlcGVhdC5lbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICogICAgICAgICAgLnRvQmUoJycpOwogKgogKiAgICAgIGNvbnRhaW5lci5lbGVtZW50KGJ5LmxpbmtUZXh0KCdhZGQnKSkuY2xpY2soKTsKICoKICogICAgICBleHBlY3QoY29udGFpbmVyLmVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gY29udGFjdHMnKS5yb3coMikpCiAqICAgICAgICAgIC5lbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpCiAqICAgICAgICAgIC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgIC50b0JlKCd5b3VybmFtZUBleGFtcGxlLm9yZycpOwogKiAgICB9KTsKICogIDwvZmlsZT4KICo8L2V4YW1wbGU+CgogKi8KdmFyIG5nQ29udHJvbGxlckRpcmVjdGl2ZSA9IFtmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdBJywKICAgIHNjb3BlOiB0cnVlLAogICAgY29udHJvbGxlcjogJ0AnLAogICAgcHJpb3JpdHk6IDUwMAogIH07Cn1dOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDc3AKICoKICogQGVsZW1lbnQgaHRtbAogKiBAZGVzY3JpcHRpb24KICogRW5hYmxlcyBbQ1NQIChDb250ZW50IFNlY3VyaXR5IFBvbGljeSldKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL1NlY3VyaXR5L0NTUCkgc3VwcG9ydC4KICoKICogVGhpcyBpcyBuZWNlc3Nhcnkgd2hlbiBkZXZlbG9waW5nIHRoaW5ncyBsaWtlIEdvb2dsZSBDaHJvbWUgRXh0ZW5zaW9ucyBvciBVbml2ZXJzYWwgV2luZG93cyBBcHBzLgogKgogKiBDU1AgZm9yYmlkcyBhcHBzIHRvIHVzZSBgZXZhbGAgb3IgYEZ1bmN0aW9uKHN0cmluZylgIGdlbmVyYXRlZCBmdW5jdGlvbnMgKGFtb25nIG90aGVyIHRoaW5ncykuCiAqIEZvciBBbmd1bGFyIHRvIGJlIENTUCBjb21wYXRpYmxlIHRoZXJlIGFyZSBvbmx5IHR3byB0aGluZ3MgdGhhdCB3ZSBuZWVkIHRvIGRvIGRpZmZlcmVudGx5OgogKgogKiAtIGRvbid0IHVzZSBgRnVuY3Rpb25gIGNvbnN0cnVjdG9yIHRvIGdlbmVyYXRlIG9wdGltaXplZCB2YWx1ZSBnZXR0ZXJzCiAqIC0gZG9uJ3QgaW5qZWN0IGN1c3RvbSBzdHlsZXNoZWV0IGludG8gdGhlIGRvY3VtZW50CiAqCiAqIEFuZ3VsYXJKUyB1c2VzIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIGFzIGEgc3BlZWQgb3B0aW1pemF0aW9uLiBBcHBseWluZyB0aGUgYG5nQ3NwYAogKiBkaXJlY3RpdmUgd2lsbCBjYXVzZSBBbmd1bGFyIHRvIHVzZSBDU1AgY29tcGF0aWJpbGl0eSBtb2RlLiBXaGVuIHRoaXMgbW9kZSBpcyBvbiBBbmd1bGFySlMgd2lsbAogKiBldmFsdWF0ZSBhbGwgZXhwcmVzc2lvbnMgdXAgdG8gMzAlIHNsb3dlciB0aGFuIGluIG5vbi1DU1AgbW9kZSwgYnV0IG5vIHNlY3VyaXR5IHZpb2xhdGlvbnMgd2lsbAogKiBiZSByYWlzZWQuCiAqCiAqIENTUCBmb3JiaWRzIEphdmFTY3JpcHQgdG8gaW5saW5lIHN0eWxlc2hlZXQgcnVsZXMuIEluIG5vbiBDU1AgbW9kZSBBbmd1bGFyIGF1dG9tYXRpY2FsbHkKICogaW5jbHVkZXMgc29tZSBDU1MgcnVsZXMgKGUuZy4ge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Nsb2FrIG5nQ2xvYWt9KS4KICogVG8gbWFrZSB0aG9zZSBkaXJlY3RpdmVzIHdvcmsgaW4gQ1NQIG1vZGUsIGluY2x1ZGUgdGhlIGBhbmd1bGFyLWNzcC5jc3NgIG1hbnVhbGx5LgogKgogKiBBbmd1bGFyIHRyaWVzIHRvIGF1dG9kZXRlY3QgaWYgQ1NQIGlzIGFjdGl2ZSBhbmQgYXV0b21hdGljYWxseSB0dXJuIG9uIHRoZSBDU1Atc2FmZSBtb2RlLiBUaGlzCiAqIGF1dG9kZXRlY3Rpb24gaG93ZXZlciB0cmlnZ2VycyBhIENTUCBlcnJvciB0byBiZSBsb2dnZWQgaW4gdGhlIGNvbnNvbGU6CiAqCiAqIGBgYAogKiBSZWZ1c2VkIHRvIGV2YWx1YXRlIGEgc3RyaW5nIGFzIEphdmFTY3JpcHQgYmVjYXVzZSAndW5zYWZlLWV2YWwnIGlzIG5vdCBhbiBhbGxvd2VkIHNvdXJjZSBvZgogKiBzY3JpcHQgaW4gdGhlIGZvbGxvd2luZyBDb250ZW50IFNlY3VyaXR5IFBvbGljeSBkaXJlY3RpdmU6ICJkZWZhdWx0LXNyYyAnc2VsZiciLiBOb3RlIHRoYXQKICogJ3NjcmlwdC1zcmMnIHdhcyBub3QgZXhwbGljaXRseSBzZXQsIHNvICdkZWZhdWx0LXNyYycgaXMgdXNlZCBhcyBhIGZhbGxiYWNrLgogKiBgYGAKICoKICogVGhpcyBlcnJvciBpcyBoYXJtbGVzcyBidXQgYW5ub3lpbmcuIFRvIHByZXZlbnQgdGhlIGVycm9yIGZyb20gc2hvd2luZyB1cCwgcHV0IHRoZSBgbmdDc3BgCiAqIGRpcmVjdGl2ZSBvbiB0aGUgcm9vdCBlbGVtZW50IG9mIHRoZSBhcHBsaWNhdGlvbiBvciBvbiB0aGUgYGFuZ3VsYXIuanNgIHNjcmlwdCB0YWcsIHdoaWNoZXZlcgogKiBhcHBlYXJzIGZpcnN0IGluIHRoZSBodG1sIGRvY3VtZW50LgogKgogKiAqTm90ZTogVGhpcyBkaXJlY3RpdmUgaXMgb25seSBhdmFpbGFibGUgaW4gdGhlIGBuZy1jc3BgIGFuZCBgZGF0YS1uZy1jc3BgIGF0dHJpYnV0ZSBmb3JtLioKICoKICogQGV4YW1wbGUKICogVGhpcyBleGFtcGxlIHNob3dzIGhvdyB0byBhcHBseSB0aGUgYG5nQ3NwYCBkaXJlY3RpdmUgdG8gdGhlIGBodG1sYCB0YWcuCiAgIGBgYGh0bWwKICAgICA8IWRvY3R5cGUgaHRtbD4KICAgICA8aHRtbCBuZy1hcHAgbmctY3NwPgogICAgIC4uLgogICAgIC4uLgogICAgIDwvaHRtbD4KICAgYGBgCiAgKiBAZXhhbXBsZQogICAgICAvLyBOb3RlOiB0aGUgc3VmZml4IGAuY3NwYCBpbiB0aGUgZXhhbXBsZSBuYW1lIHRyaWdnZXJzCiAgICAgIC8vIGNzcCBtb2RlIGluIG91ciBodHRwIHNlcnZlciEKICAgICAgPGV4YW1wbGUgbmFtZT0iZXhhbXBsZS5jc3AiIG1vZHVsZT0iY3NwRXhhbXBsZSIgbmctY3NwPSJ0cnVlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iTWFpbkNvbnRyb2xsZXIgYXMgY3RybCI+CiAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iY3RybC5pbmMoKSIgaWQ9ImluYyI+SW5jcmVtZW50PC9idXR0b24+CiAgICAgICAgICAgICAgPHNwYW4gaWQ9ImNvdW50ZXIiPgogICAgICAgICAgICAgICAge3tjdHJsLmNvdW50ZXJ9fQogICAgICAgICAgICAgIDwvc3Bhbj4KICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9ImN0cmwuZXZpbCgpIiBpZD0iZXZpbCI+RXZpbDwvYnV0dG9uPgogICAgICAgICAgICAgIDxzcGFuIGlkPSJldmlsRXJyb3IiPgogICAgICAgICAgICAgICAge3tjdHJsLmV2aWxFcnJvcn19CiAgICAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCdjc3BFeGFtcGxlJywgW10pCiAgICAgICAgICAgICAuY29udHJvbGxlcignTWFpbkNvbnRyb2xsZXInLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoaXMuY291bnRlciA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLmluYyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aGlzLmNvdW50ZXIrKzsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aGlzLmV2aWwgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgLy8ganNoaW50IGV2aWw6dHJ1ZQogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGV2YWwoJzErMicpOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmlsRXJyb3IgPSBlLm1lc3NhZ2U7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICAgdmFyIHV0aWwsIHdlYmRyaXZlcjsKCiAgICAgICAgICB2YXIgaW5jQnRuID0gZWxlbWVudChieS5pZCgnaW5jJykpOwogICAgICAgICAgdmFyIGNvdW50ZXIgPSBlbGVtZW50KGJ5LmlkKCdjb3VudGVyJykpOwogICAgICAgICAgdmFyIGV2aWxCdG4gPSBlbGVtZW50KGJ5LmlkKCdldmlsJykpOwogICAgICAgICAgdmFyIGV2aWxFcnJvciA9IGVsZW1lbnQoYnkuaWQoJ2V2aWxFcnJvcicpKTsKCiAgICAgICAgICBmdW5jdGlvbiBnZXRBbmRDbGVhclNldmVyZUVycm9ycygpIHsKICAgICAgICAgICAgcmV0dXJuIGJyb3dzZXIubWFuYWdlKCkubG9ncygpLmdldCgnYnJvd3NlcicpLnRoZW4oZnVuY3Rpb24oYnJvd3NlckxvZykgewogICAgICAgICAgICAgIHJldHVybiBicm93c2VyTG9nLmZpbHRlcihmdW5jdGlvbihsb2dFbnRyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxvZ0VudHJ5LmxldmVsLnZhbHVlID4gd2ViZHJpdmVyLmxvZ2dpbmcuTGV2ZWwuV0FSTklORy52YWx1ZTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gY2xlYXJFcnJvcnMoKSB7CiAgICAgICAgICAgIGdldEFuZENsZWFyU2V2ZXJlRXJyb3JzKCk7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gZXhwZWN0Tm9FcnJvcnMoKSB7CiAgICAgICAgICAgIGdldEFuZENsZWFyU2V2ZXJlRXJyb3JzKCkudGhlbihmdW5jdGlvbihmaWx0ZXJlZExvZykgewogICAgICAgICAgICAgIGV4cGVjdChmaWx0ZXJlZExvZy5sZW5ndGgpLnRvRXF1YWwoMCk7CiAgICAgICAgICAgICAgaWYgKGZpbHRlcmVkTG9nLmxlbmd0aCkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2Jyb3dzZXIgY29uc29sZSBlcnJvcnM6ICcgKyB1dGlsLmluc3BlY3QoZmlsdGVyZWRMb2cpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGV4cGVjdEVycm9yKHJlZ2V4KSB7CiAgICAgICAgICAgIGdldEFuZENsZWFyU2V2ZXJlRXJyb3JzKCkudGhlbihmdW5jdGlvbihmaWx0ZXJlZExvZykgewogICAgICAgICAgICAgIHZhciBmb3VuZCA9IGZhbHNlOwogICAgICAgICAgICAgIGZpbHRlcmVkTG9nLmZvckVhY2goZnVuY3Rpb24obG9nKSB7CiAgICAgICAgICAgICAgICBpZiAobG9nLm1lc3NhZ2UubWF0Y2gocmVnZXgpKSB7CiAgICAgICAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAoIWZvdW5kKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2V4cGVjdGVkIGFuIGVycm9yIHRoYXQgbWF0Y2hlcyAnICsgcmVnZXgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgYmVmb3JlRWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTsKICAgICAgICAgICAgd2ViZHJpdmVyID0gcmVxdWlyZSgncHJvdHJhY3Rvci9ub2RlX21vZHVsZXMvc2VsZW5pdW0td2ViZHJpdmVyJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICAvLyBGb3Igbm93LCB3ZSBvbmx5IHRlc3Qgb24gQ2hyb21lLAogICAgICAgICAgLy8gYXMgU2FmYXJpIGRvZXMgbm90IGxvYWQgdGhlIHBhZ2Ugd2l0aCBQcm90cmFjdG9yJ3MgaW5qZWN0ZWQgc2NyaXB0cywKICAgICAgICAgIC8vIGFuZCBGaXJlZm94IHdlYmRyaXZlciBhbHdheXMgZGlzYWJsZXMgY29udGVudCBzZWN1cml0eSBwb2xpY3kgKCM2MzU4KQogICAgICAgICAgaWYgKGJyb3dzZXIucGFyYW1zLmJyb3dzZXIgIT09ICdjaHJvbWUnKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBpdCgnc2hvdWxkIG5vdCByZXBvcnQgZXJyb3JzIHdoZW4gdGhlIHBhZ2UgaXMgbG9hZGVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIGNsZWFyIGVycm9ycyBzbyB3ZSBhcmUgbm90IGRlcGVuZGVudCBvbiBwcmV2aW91cyB0ZXN0cwogICAgICAgICAgICBjbGVhckVycm9ycygpOwogICAgICAgICAgICAvLyBOZWVkIHRvIHJlbG9hZCB0aGUgcGFnZSBhcyB0aGUgcGFnZSBpcyBhbHJlYWR5IGxvYWRlZCB3aGVuCiAgICAgICAgICAgIC8vIHdlIGNvbWUgaGVyZQogICAgICAgICAgICBicm93c2VyLmRyaXZlci5nZXRDdXJyZW50VXJsKCkudGhlbihmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgICBicm93c2VyLmdldCh1cmwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZXhwZWN0Tm9FcnJvcnMoKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGl0KCdzaG91bGQgZXZhbHVhdGUgZXhwcmVzc2lvbnMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGNvdW50ZXIuZ2V0VGV4dCgpKS50b0VxdWFsKCcwJyk7CiAgICAgICAgICAgIGluY0J0bi5jbGljaygpOwogICAgICAgICAgICBleHBlY3QoY291bnRlci5nZXRUZXh0KCkpLnRvRXF1YWwoJzEnKTsKICAgICAgICAgICAgZXhwZWN0Tm9FcnJvcnMoKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGl0KCdzaG91bGQgdGhyb3cgYW5kIHJlcG9ydCBhbiBlcnJvciB3aGVuIHVzaW5nICJldmFsIicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBldmlsQnRuLmNsaWNrKCk7CiAgICAgICAgICAgIGV4cGVjdChldmlsRXJyb3IuZ2V0VGV4dCgpKS50b01hdGNoKC9Db250ZW50IFNlY3VyaXR5IFBvbGljeS8pOwogICAgICAgICAgICBleHBlY3RFcnJvcigvQ29udGVudCBTZWN1cml0eSBQb2xpY3kvKTsKICAgICAgICAgIH0pOwogICAgICAgIDwvZmlsZT4KICAgICAgPC9leGFtcGxlPgogICovCgovLyBuZ0NzcCBpcyBub3QgaW1wbGVtZW50ZWQgYXMgYSBwcm9wZXIgZGlyZWN0aXZlIGFueSBtb3JlLCBiZWNhdXNlIHdlIG5lZWQgaXQgYmUgcHJvY2Vzc2VkIHdoaWxlIHdlCi8vIGJvb3RzdHJhcCB0aGUgc3lzdGVtIChiZWZvcmUgJHBhcnNlIGlzIGluc3RhbnRpYXRlZCksIGZvciB0aGlzIHJlYXNvbiB3ZSBqdXN0IGhhdmUKLy8gdGhlIGNzcC5pc0FjdGl2ZSgpIGZuIHRoYXQgbG9va3MgZm9yIG5nLWNzcCBhdHRyaWJ1dGUgYW55d2hlcmUgaW4gdGhlIGN1cnJlbnQgZG9jCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0NsaWNrCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgbmdDbGljayBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciB3aGVuCiAqIGFuIGVsZW1lbnQgaXMgY2xpY2tlZC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGljayB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIGNsaWNrLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxidXR0b24gbmctY2xpY2s9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAgICBJbmNyZW1lbnQKICAgICAgPC9idXR0b24+CiAgICAgIDxzcGFuPgogICAgICAgIGNvdW50OiB7e2NvdW50fX0KICAgICAgPC9zcGFuPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnY291bnQnKSkuZ2V0VGV4dCgpKS50b01hdGNoKCcwJyk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCdidXR0b24nKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnY291bnQnKSkuZ2V0VGV4dCgpKS50b01hdGNoKCcxJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCi8qCiAqIEEgZGlyZWN0aXZlIHRoYXQgYWxsb3dzIGNyZWF0aW9uIG9mIGN1c3RvbSBvbmNsaWNrIGhhbmRsZXJzIHRoYXQgYXJlIGRlZmluZWQgYXMgYW5ndWxhcgogKiBleHByZXNzaW9ucyBhbmQgYXJlIGNvbXBpbGVkIGFuZCBleGVjdXRlZCB3aXRoaW4gdGhlIGN1cnJlbnQgc2NvcGUuCiAqCiAqIEV2ZW50cyB0aGF0IGFyZSBoYW5kbGVkIHZpYSB0aGVzZSBoYW5kbGVyIGFyZSBhbHdheXMgY29uZmlndXJlZCBub3QgdG8gcHJvcGFnYXRlIGZ1cnRoZXIuCiAqLwp2YXIgbmdFdmVudERpcmVjdGl2ZXMgPSB7fTsKCi8vIEZvciBldmVudHMgdGhhdCBtaWdodCBmaXJlIHN5bmNocm9ub3VzbHkgZHVyaW5nIERPTSBtYW5pcHVsYXRpb24KLy8gd2UgbmVlZCB0byBleGVjdXRlIHRoZWlyIGV2ZW50IGhhbmRsZXJzIGFzeW5jaHJvbm91c2x5IHVzaW5nICRldmFsQXN5bmMsCi8vIHNvIHRoYXQgdGhleSBhcmUgbm90IGV4ZWN1dGVkIGluIGFuIGluY29uc2lzdGVudCBzdGF0ZS4KdmFyIGZvcmNlQXN5bmNFdmVudHMgPSB7CiAgJ2JsdXInOiB0cnVlLAogICdmb2N1cyc6IHRydWUKfTsKZm9yRWFjaCgKICAnY2xpY2sgZGJsY2xpY2sgbW91c2Vkb3duIG1vdXNldXAgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlbW92ZSBtb3VzZWVudGVyIG1vdXNlbGVhdmUga2V5ZG93biBrZXl1cCBrZXlwcmVzcyBzdWJtaXQgZm9jdXMgYmx1ciBjb3B5IGN1dCBwYXN0ZScuc3BsaXQoJyAnKSwKICBmdW5jdGlvbihldmVudE5hbWUpIHsKICAgIHZhciBkaXJlY3RpdmVOYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgZXZlbnROYW1lKTsKICAgIG5nRXZlbnREaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdID0gWyckcGFyc2UnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKCRwYXJzZSwgJHJvb3RTY29wZSkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oJGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIHZhciBmbiA9ICRwYXJzZShhdHRyW2RpcmVjdGl2ZU5hbWVdKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBuZ0V2ZW50SGFuZGxlcihzY29wZSwgZWxlbWVudCkgewogICAgICAgICAgICBlbGVtZW50Lm9uKGV2ZW50TmFtZSwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZuKHNjb3BlLCB7JGV2ZW50OmV2ZW50fSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBpZiAoZm9yY2VBc3luY0V2ZW50c1tldmVudE5hbWVdICYmICRyb290U2NvcGUuJCRwaGFzZSkgewogICAgICAgICAgICAgICAgc2NvcGUuJGV2YWxBc3luYyhjYWxsYmFjayk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShjYWxsYmFjayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9OwogICAgfV07CiAgfQopOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdEYmxjbGljawogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0RibGNsaWNrYCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBhIGRibGNsaWNrIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0RibGNsaWNrIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogYSBkYmxjbGljay4gKFRoZSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGJ1dHRvbiBuZy1kYmxjbGljaz0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgIEluY3JlbWVudCAob24gZG91YmxlIGNsaWNrKQogICAgICA8L2J1dHRvbj4KICAgICAgY291bnQ6IHt7Y291bnR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ01vdXNlZG93bgogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIG5nTW91c2Vkb3duIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlZG93biBldmVudC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWRvd24ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBtb3VzZWRvd24uICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGJ1dHRvbiBuZy1tb3VzZWRvd249ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAgICBJbmNyZW1lbnQgKG9uIG1vdXNlIGRvd24pCiAgICAgIDwvYnV0dG9uPgogICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nTW91c2V1cAogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2V1cCBldmVudC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZXVwIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogbW91c2V1cC4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8YnV0dG9uIG5nLW1vdXNldXA9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAgICBJbmNyZW1lbnQgKG9uIG1vdXNlIHVwKQogICAgICA8L2J1dHRvbj4KICAgICAgY291bnQ6IHt7Y291bnR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nTW91c2VvdmVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZW92ZXIgZXZlbnQuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2VvdmVyIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogbW91c2VvdmVyLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxidXR0b24gbmctbW91c2VvdmVyPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgICAgICAgSW5jcmVtZW50ICh3aGVuIG1vdXNlIGlzIG92ZXIpCiAgICAgIDwvYnV0dG9uPgogICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nTW91c2VlbnRlcgogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VlbnRlciBldmVudC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWVudGVyIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogbW91c2VlbnRlci4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8YnV0dG9uIG5nLW1vdXNlZW50ZXI9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAgICBJbmNyZW1lbnQgKHdoZW4gbW91c2UgZW50ZXJzKQogICAgICA8L2J1dHRvbj4KICAgICAgY291bnQ6IHt7Y291bnR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ01vdXNlbGVhdmUKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlbGVhdmUgZXZlbnQuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2VsZWF2ZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIG1vdXNlbGVhdmUuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGJ1dHRvbiBuZy1tb3VzZWxlYXZlPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgICAgICAgSW5jcmVtZW50ICh3aGVuIG1vdXNlIGxlYXZlcykKICAgICAgPC9idXR0b24+CiAgICAgIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdNb3VzZW1vdmUKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlbW92ZSBldmVudC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZW1vdmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBtb3VzZW1vdmUuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGJ1dHRvbiBuZy1tb3VzZW1vdmU9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAgICBJbmNyZW1lbnQgKHdoZW4gbW91c2UgbW92ZXMpCiAgICAgIDwvYnV0dG9uPgogICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nS2V5ZG93bgogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24ga2V5ZG93biBldmVudC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdLZXlkb3duIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICoga2V5ZG93bi4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGAgYW5kIGNhbiBiZSBpbnRlcnJvZ2F0ZWQgZm9yIGtleUNvZGUsIGFsdEtleSwgZXRjLikKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxpbnB1dCBuZy1rZXlkb3duPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgICAgIGtleSBkb3duIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdLZXl1cAogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24ga2V5dXAgZXZlbnQuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nS2V5dXAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBrZXl1cC4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGAgYW5kIGNhbiBiZSBpbnRlcnJvZ2F0ZWQgZm9yIGtleUNvZGUsIGFsdEtleSwgZXRjLikKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8cD5UeXBpbmcgaW4gdGhlIGlucHV0IGJveCBiZWxvdyB1cGRhdGVzIHRoZSBrZXkgY291bnQ8L3A+CiAgICAgICA8aW5wdXQgbmcta2V5dXA9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4ga2V5IHVwIGNvdW50OiB7e2NvdW50fX0KCiAgICAgICA8cD5UeXBpbmcgaW4gdGhlIGlucHV0IGJveCBiZWxvdyB1cGRhdGVzIHRoZSBrZXljb2RlPC9wPgogICAgICAgPGlucHV0IG5nLWtleXVwPSJldmVudD0kZXZlbnQiPgogICAgICAgPHA+ZXZlbnQga2V5Q29kZToge3sgZXZlbnQua2V5Q29kZSB9fTwvcD4KICAgICAgIDxwPmV2ZW50IGFsdEtleToge3sgZXZlbnQuYWx0S2V5IH19PC9wPgogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0tleXByZXNzCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBrZXlwcmVzcyBldmVudC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdLZXlwcmVzcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIGtleXByZXNzLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfQogKiBhbmQgY2FuIGJlIGludGVycm9nYXRlZCBmb3Iga2V5Q29kZSwgYWx0S2V5LCBldGMuKQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGlucHV0IG5nLWtleXByZXNzPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgICAgIGtleSBwcmVzcyBjb3VudDoge3tjb3VudH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nU3VibWl0CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBFbmFibGVzIGJpbmRpbmcgYW5ndWxhciBleHByZXNzaW9ucyB0byBvbnN1Ym1pdCBldmVudHMuCiAqCiAqIEFkZGl0aW9uYWxseSBpdCBwcmV2ZW50cyB0aGUgZGVmYXVsdCBhY3Rpb24gKHdoaWNoIGZvciBmb3JtIG1lYW5zIHNlbmRpbmcgdGhlIHJlcXVlc3QgdG8gdGhlCiAqIHNlcnZlciBhbmQgcmVsb2FkaW5nIHRoZSBjdXJyZW50IHBhZ2UpLCBidXQgb25seSBpZiB0aGUgZm9ybSBkb2VzIG5vdCBjb250YWluIGBhY3Rpb25gLAogKiBgZGF0YS1hY3Rpb25gLCBvciBgeC1hY3Rpb25gIGF0dHJpYnV0ZXMuCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKldhcm5pbmc6KiogQmUgY2FyZWZ1bCBub3QgdG8gY2F1c2UgImRvdWJsZS1zdWJtaXNzaW9uIiBieSB1c2luZyBib3RoIHRoZSBgbmdDbGlja2AgYW5kCiAqIGBuZ1N1Ym1pdGAgaGFuZGxlcnMgdG9nZXRoZXIuIFNlZSB0aGUKICoge0BsaW5rIGZvcm0jc3VibWl0dGluZy1hLWZvcm0tYW5kLXByZXZlbnRpbmctdGhlLWRlZmF1bHQtYWN0aW9uIGBmb3JtYCBkaXJlY3RpdmUgZG9jdW1lbnRhdGlvbn0KICogZm9yIGEgZGV0YWlsZWQgZGlzY3Vzc2lvbiBvZiB3aGVuIGBuZ1N1Ym1pdGAgbWF5IGJlIHRyaWdnZXJlZC4KICogPC9kaXY+CiAqCiAqIEBlbGVtZW50IGZvcm0KICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1N1Ym1pdCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLgogKiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJzdWJtaXRFeGFtcGxlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPHNjcmlwdD4KICAgICAgICBhbmd1bGFyLm1vZHVsZSgnc3VibWl0RXhhbXBsZScsIFtdKQogICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLmxpc3QgPSBbXTsKICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnaGVsbG8nOwogICAgICAgICAgICAkc2NvcGUuc3VibWl0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKCRzY29wZS50ZXh0KSB7CiAgICAgICAgICAgICAgICAkc2NvcGUubGlzdC5wdXNoKHRoaXMudGV4dCk7CiAgICAgICAgICAgICAgICAkc2NvcGUudGV4dCA9ICcnOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH1dKTsKICAgICAgPC9zY3JpcHQ+CiAgICAgIDxmb3JtIG5nLXN1Ym1pdD0ic3VibWl0KCkiIG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICBFbnRlciB0ZXh0IGFuZCBoaXQgZW50ZXI6CiAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJ0ZXh0IiBuYW1lPSJ0ZXh0IiAvPgogICAgICAgIDxpbnB1dCB0eXBlPSJzdWJtaXQiIGlkPSJzdWJtaXQiIHZhbHVlPSJTdWJtaXQiIC8+CiAgICAgICAgPHByZT5saXN0PXt7bGlzdH19PC9wcmU+CiAgICAgIDwvZm9ybT4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXN1Ym1pdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdsaXN0JykpLmdldFRleHQoKSkudG9CZSgnbGlzdD1bXScpOwogICAgICAgICBlbGVtZW50KGJ5LmNzcygnI3N1Ym1pdCcpKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdsaXN0JykpLmdldFRleHQoKSkudG9Db250YWluKCdoZWxsbycpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5tb2RlbCgndGV4dCcpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvQmUoJycpOwogICAgICAgfSk7CiAgICAgICBpdCgnc2hvdWxkIGlnbm9yZSBlbXB0eSBzdHJpbmdzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2xpc3QnKSkuZ2V0VGV4dCgpKS50b0JlKCdsaXN0PVtdJyk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCcjc3VibWl0JykpLmNsaWNrKCk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCcjc3VibWl0JykpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2xpc3QnKSkuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2hlbGxvJyk7CiAgICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdGb2N1cwogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gZm9jdXMgZXZlbnQuCiAqCiAqIE5vdGU6IEFzIHRoZSBgZm9jdXNgIGV2ZW50IGlzIGV4ZWN1dGVkIHN5bmNocm9ub3VzbHkgd2hlbiBjYWxsaW5nIGBpbnB1dC5mb2N1cygpYAogKiBBbmd1bGFySlMgZXhlY3V0ZXMgdGhlIGV4cHJlc3Npb24gdXNpbmcgYHNjb3BlLiRldmFsQXN5bmNgIGlmIHRoZSBldmVudCBpcyBmaXJlZAogKiBkdXJpbmcgYW4gYCRhcHBseWAgdG8gZW5zdXJlIGEgY29uc2lzdGVudCBzdGF0ZS4KICoKICogQGVsZW1lbnQgd2luZG93LCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nRm9jdXMge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBmb2N1cy4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0JsdXIKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGJsdXIgZXZlbnQuCiAqCiAqIEEgW2JsdXIgZXZlbnRdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0V2ZW50cy9ibHVyKSBmaXJlcyB3aGVuCiAqIGFuIGVsZW1lbnQgaGFzIGxvc3QgZm9jdXMuCiAqCiAqIE5vdGU6IEFzIHRoZSBgYmx1cmAgZXZlbnQgaXMgZXhlY3V0ZWQgc3luY2hyb25vdXNseSBhbHNvIGR1cmluZyBET00gbWFuaXB1bGF0aW9ucwogKiAoZS5nLiByZW1vdmluZyBhIGZvY3Vzc2VkIGlucHV0KSwKICogQW5ndWxhckpTIGV4ZWN1dGVzIHRoZSBleHByZXNzaW9uIHVzaW5nIGBzY29wZS4kZXZhbEFzeW5jYCBpZiB0aGUgZXZlbnQgaXMgZmlyZWQKICogZHVyaW5nIGFuIGAkYXBwbHlgIHRvIGVuc3VyZSBhIGNvbnNpc3RlbnQgc3RhdGUuCiAqCiAqIEBlbGVtZW50IHdpbmRvdywgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIGEKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0JsdXIge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBibHVyLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogKi8KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQ29weQogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gY29weSBldmVudC4KICoKICogQGVsZW1lbnQgd2luZG93LCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ29weSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIGNvcHkuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGlucHV0IG5nLWNvcHk9ImNvcGllZD10cnVlIiBuZy1pbml0PSJjb3BpZWQ9ZmFsc2U7IHZhbHVlPSdjb3B5IG1lJyIgbmctbW9kZWw9InZhbHVlIj4KICAgICAgY29waWVkOiB7e2NvcGllZH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDdXQKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGN1dCBldmVudC4KICoKICogQGVsZW1lbnQgd2luZG93LCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ3V0IHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogY3V0LiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxpbnB1dCBuZy1jdXQ9ImN1dD10cnVlIiBuZy1pbml0PSJjdXQ9ZmFsc2U7IHZhbHVlPSdjdXQgbWUnIiBuZy1tb2RlbD0idmFsdWUiPgogICAgICBjdXQ6IHt7Y3V0fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1Bhc3RlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBwYXN0ZSBldmVudC4KICoKICogQGVsZW1lbnQgd2luZG93LCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nUGFzdGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBwYXN0ZS4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8aW5wdXQgbmctcGFzdGU9InBhc3RlPXRydWUiIG5nLWluaXQ9InBhc3RlPWZhbHNlIiBwbGFjZWhvbGRlcj0ncGFzdGUgaGVyZSc+CiAgICAgIHBhc3RlZDoge3twYXN0ZX19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdJZgogKiBAcmVzdHJpY3QgQQogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0lmYCBkaXJlY3RpdmUgcmVtb3ZlcyBvciByZWNyZWF0ZXMgYSBwb3J0aW9uIG9mIHRoZSBET00gdHJlZSBiYXNlZCBvbiBhbgogKiB7ZXhwcmVzc2lvbn0uIElmIHRoZSBleHByZXNzaW9uIGFzc2lnbmVkIHRvIGBuZ0lmYCBldmFsdWF0ZXMgdG8gYSBmYWxzZQogKiB2YWx1ZSB0aGVuIHRoZSBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NLCBvdGhlcndpc2UgYSBjbG9uZSBvZiB0aGUKICogZWxlbWVudCBpcyByZWluc2VydGVkIGludG8gdGhlIERPTS4KICoKICogYG5nSWZgIGRpZmZlcnMgZnJvbSBgbmdTaG93YCBhbmQgYG5nSGlkZWAgaW4gdGhhdCBgbmdJZmAgY29tcGxldGVseSByZW1vdmVzIGFuZCByZWNyZWF0ZXMgdGhlCiAqIGVsZW1lbnQgaW4gdGhlIERPTSByYXRoZXIgdGhhbiBjaGFuZ2luZyBpdHMgdmlzaWJpbGl0eSB2aWEgdGhlIGBkaXNwbGF5YCBjc3MgcHJvcGVydHkuICBBIGNvbW1vbgogKiBjYXNlIHdoZW4gdGhpcyBkaWZmZXJlbmNlIGlzIHNpZ25pZmljYW50IGlzIHdoZW4gdXNpbmcgY3NzIHNlbGVjdG9ycyB0aGF0IHJlbHkgb24gYW4gZWxlbWVudCdzCiAqIHBvc2l0aW9uIHdpdGhpbiB0aGUgRE9NLCBzdWNoIGFzIHRoZSBgOmZpcnN0LWNoaWxkYCBvciBgOmxhc3QtY2hpbGRgIHBzZXVkby1jbGFzc2VzLgogKgogKiBOb3RlIHRoYXQgd2hlbiBhbiBlbGVtZW50IGlzIHJlbW92ZWQgdXNpbmcgYG5nSWZgIGl0cyBzY29wZSBpcyBkZXN0cm95ZWQgYW5kIGEgbmV3IHNjb3BlCiAqIGlzIGNyZWF0ZWQgd2hlbiB0aGUgZWxlbWVudCBpcyByZXN0b3JlZC4gIFRoZSBzY29wZSBjcmVhdGVkIHdpdGhpbiBgbmdJZmAgaW5oZXJpdHMgZnJvbQogKiBpdHMgcGFyZW50IHNjb3BlIHVzaW5nCiAqIFtwcm90b3R5cGFsIGluaGVyaXRhbmNlXShodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL3dpa2kvVW5kZXJzdGFuZGluZy1TY29wZXMjamF2YXNjcmlwdC1wcm90b3R5cGFsLWluaGVyaXRhbmNlKS4KICogQW4gaW1wb3J0YW50IGltcGxpY2F0aW9uIG9mIHRoaXMgaXMgaWYgYG5nTW9kZWxgIGlzIHVzZWQgd2l0aGluIGBuZ0lmYCB0byBiaW5kIHRvCiAqIGEgamF2YXNjcmlwdCBwcmltaXRpdmUgZGVmaW5lZCBpbiB0aGUgcGFyZW50IHNjb3BlLiBJbiB0aGlzIGNhc2UgYW55IG1vZGlmaWNhdGlvbnMgbWFkZSB0byB0aGUKICogdmFyaWFibGUgd2l0aGluIHRoZSBjaGlsZCBzY29wZSB3aWxsIG92ZXJyaWRlIChoaWRlKSB0aGUgdmFsdWUgaW4gdGhlIHBhcmVudCBzY29wZS4KICoKICogQWxzbywgYG5nSWZgIHJlY3JlYXRlcyBlbGVtZW50cyB1c2luZyB0aGVpciBjb21waWxlZCBzdGF0ZS4gQW4gZXhhbXBsZSBvZiB0aGlzIGJlaGF2aW9yCiAqIGlzIGlmIGFuIGVsZW1lbnQncyBjbGFzcyBhdHRyaWJ1dGUgaXMgZGlyZWN0bHkgbW9kaWZpZWQgYWZ0ZXIgaXQncyBjb21waWxlZCwgdXNpbmcgc29tZXRoaW5nIGxpa2UKICogalF1ZXJ5J3MgYC5hZGRDbGFzcygpYCBtZXRob2QsIGFuZCB0aGUgZWxlbWVudCBpcyBsYXRlciByZW1vdmVkLiBXaGVuIGBuZ0lmYCByZWNyZWF0ZXMgdGhlIGVsZW1lbnQKICogdGhlIGFkZGVkIGNsYXNzIHdpbGwgYmUgbG9zdCBiZWNhdXNlIHRoZSBvcmlnaW5hbCBjb21waWxlZCBzdGF0ZSBpcyB1c2VkIHRvIHJlZ2VuZXJhdGUgdGhlIGVsZW1lbnQuCiAqCiAqIEFkZGl0aW9uYWxseSwgeW91IGNhbiBwcm92aWRlIGFuaW1hdGlvbnMgdmlhIHRoZSBgbmdBbmltYXRlYCBtb2R1bGUgdG8gYW5pbWF0ZSB0aGUgYGVudGVyYAogKiBhbmQgYGxlYXZlYCBlZmZlY3RzLgogKgogKiBAYW5pbWF0aW9ucwogKiBlbnRlciAtIGhhcHBlbnMganVzdCBhZnRlciB0aGUgYG5nSWZgIGNvbnRlbnRzIGNoYW5nZSBhbmQgYSBuZXcgRE9NIGVsZW1lbnQgaXMgY3JlYXRlZCBhbmQgaW5qZWN0ZWQgaW50byB0aGUgYG5nSWZgIGNvbnRhaW5lcgogKiBsZWF2ZSAtIGhhcHBlbnMganVzdCBiZWZvcmUgdGhlIGBuZ0lmYCBjb250ZW50cyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBET00KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBzY29wZQogKiBAcHJpb3JpdHkgNjAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdJZiBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgZmFsc3kgdGhlbgogKiAgICAgdGhlIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBET00gdHJlZS4gSWYgaXQgaXMgdHJ1dGh5IGEgY29weSBvZiB0aGUgY29tcGlsZWQKICogICAgIGVsZW1lbnQgaXMgYWRkZWQgdG8gdGhlIERPTSB0cmVlLgogKgogKiBAZXhhbXBsZQogIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIENsaWNrIG1lOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIiBuZy1pbml0PSJjaGVja2VkPXRydWUiIC8+PGJyLz4KICAgICAgU2hvdyB3aGVuIGNoZWNrZWQ6CiAgICAgIDxzcGFuIG5nLWlmPSJjaGVja2VkIiBjbGFzcz0iYW5pbWF0ZS1pZiI+CiAgICAgICAgVGhpcyBpcyByZW1vdmVkIHdoZW4gdGhlIGNoZWNrYm94IGlzIHVuY2hlY2tlZC4KICAgICAgPC9zcGFuPgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAgICAuYW5pbWF0ZS1pZiB7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtaWYubmctZW50ZXIsIC5hbmltYXRlLWlmLm5nLWxlYXZlIHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgICB0cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgIH0KCiAgICAgIC5hbmltYXRlLWlmLm5nLWVudGVyLAogICAgICAuYW5pbWF0ZS1pZi5uZy1sZWF2ZS5uZy1sZWF2ZS1hY3RpdmUgewogICAgICAgIG9wYWNpdHk6MDsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtaWYubmctbGVhdmUsCiAgICAgIC5hbmltYXRlLWlmLm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7CiAgICAgICAgb3BhY2l0eToxOwogICAgICB9CiAgICA8L2ZpbGU+CiAgPC9leGFtcGxlPgogKi8KdmFyIG5nSWZEaXJlY3RpdmUgPSBbJyRhbmltYXRlJywgZnVuY3Rpb24oJGFuaW1hdGUpIHsKICByZXR1cm4gewogICAgbXVsdGlFbGVtZW50OiB0cnVlLAogICAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogICAgcHJpb3JpdHk6IDYwMCwKICAgIHRlcm1pbmFsOiB0cnVlLAogICAgcmVzdHJpY3Q6ICdBJywKICAgICQkdGxiOiB0cnVlLAogICAgbGluazogZnVuY3Rpb24gKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBjdHJsLCAkdHJhbnNjbHVkZSkgewogICAgICAgIHZhciBibG9jaywgY2hpbGRTY29wZSwgcHJldmlvdXNFbGVtZW50czsKICAgICAgICAkc2NvcGUuJHdhdGNoKCRhdHRyLm5nSWYsIGZ1bmN0aW9uIG5nSWZXYXRjaEFjdGlvbih2YWx1ZSkgewoKICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoIWNoaWxkU2NvcGUpIHsKICAgICAgICAgICAgICAkdHJhbnNjbHVkZShmdW5jdGlvbiAoY2xvbmUsIG5ld1Njb3BlKSB7CiAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gbmV3U2NvcGU7CiAgICAgICAgICAgICAgICBjbG9uZVtjbG9uZS5sZW5ndGgrK10gPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KCcgZW5kIG5nSWY6ICcgKyAkYXR0ci5uZ0lmICsgJyAnKTsKICAgICAgICAgICAgICAgIC8vIE5vdGU6IFdlIG9ubHkgbmVlZCB0aGUgZmlyc3QvbGFzdCBub2RlIG9mIHRoZSBjbG9uZWQgbm9kZXMuCiAgICAgICAgICAgICAgICAvLyBIb3dldmVyLCB3ZSBuZWVkIHRvIGtlZXAgdGhlIHJlZmVyZW5jZSB0byB0aGUganFsaXRlIHdyYXBwZXIgYXMgaXQgbWlnaHQgYmUgY2hhbmdlZCBsYXRlcgogICAgICAgICAgICAgICAgLy8gYnkgYSBkaXJlY3RpdmUgd2l0aCB0ZW1wbGF0ZVVybCB3aGVuIGl0cyB0ZW1wbGF0ZSBhcnJpdmVzLgogICAgICAgICAgICAgICAgYmxvY2sgPSB7CiAgICAgICAgICAgICAgICAgIGNsb25lOiBjbG9uZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGNsb25lLCAkZWxlbWVudC5wYXJlbnQoKSwgJGVsZW1lbnQpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAocHJldmlvdXNFbGVtZW50cykgewogICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudHMucmVtb3ZlKCk7CiAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50cyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoaWxkU2NvcGUpIHsKICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGJsb2NrKSB7CiAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50cyA9IGdldEJsb2NrTm9kZXMoYmxvY2suY2xvbmUpOwogICAgICAgICAgICAgICRhbmltYXRlLmxlYXZlKHByZXZpb3VzRWxlbWVudHMpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzID0gbnVsbDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBibG9jayA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICB9Owp9XTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nSW5jbHVkZQogKiBAcmVzdHJpY3QgRUNBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBGZXRjaGVzLCBjb21waWxlcyBhbmQgaW5jbHVkZXMgYW4gZXh0ZXJuYWwgSFRNTCBmcmFnbWVudC4KICoKICogQnkgZGVmYXVsdCwgdGhlIHRlbXBsYXRlIFVSTCBpcyByZXN0cmljdGVkIHRvIHRoZSBzYW1lIGRvbWFpbiBhbmQgcHJvdG9jb2wgYXMgdGhlCiAqIGFwcGxpY2F0aW9uIGRvY3VtZW50LiBUaGlzIGlzIGRvbmUgYnkgY2FsbGluZyB7QGxpbmsgJHNjZSNnZXRUcnVzdGVkUmVzb3VyY2VVcmwKICogJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmx9IG9uIGl0LiBUbyBsb2FkIHRlbXBsYXRlcyBmcm9tIG90aGVyIGRvbWFpbnMgb3IgcHJvdG9jb2xzCiAqIHlvdSBtYXkgZWl0aGVyIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdCB3aGl0ZWxpc3QgdGhlbX0gb3IKICoge0BsaW5rICRzY2UjdHJ1c3RBc1Jlc291cmNlVXJsIHdyYXAgdGhlbX0gYXMgdHJ1c3RlZCB2YWx1ZXMuIFJlZmVyIHRvIEFuZ3VsYXIncyB7QGxpbmsKICogbmcuJHNjZSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZ30uCiAqCiAqIEluIGFkZGl0aW9uLCB0aGUgYnJvd3NlcidzCiAqIFtTYW1lIE9yaWdpbiBQb2xpY3ldKGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvYnJvd3NlcnNlYy93aWtpL1BhcnQyI1NhbWUtb3JpZ2luX3BvbGljeV9mb3JfWE1MSHR0cFJlcXVlc3QpCiAqIGFuZCBbQ3Jvc3MtT3JpZ2luIFJlc291cmNlIFNoYXJpbmcgKENPUlMpXShodHRwOi8vd3d3LnczLm9yZy9UUi9jb3JzLykKICogcG9saWN5IG1heSBmdXJ0aGVyIHJlc3RyaWN0IHdoZXRoZXIgdGhlIHRlbXBsYXRlIGlzIHN1Y2Nlc3NmdWxseSBsb2FkZWQuCiAqIEZvciBleGFtcGxlLCBgbmdJbmNsdWRlYCB3b24ndCB3b3JrIGZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMgb24gYWxsIGJyb3dzZXJzIGFuZCBmb3IgYGZpbGU6Ly9gCiAqIGFjY2VzcyBvbiBzb21lIGJyb3dzZXJzLgogKgogKiBAYW5pbWF0aW9ucwogKiBlbnRlciAtIGFuaW1hdGlvbiBpcyB1c2VkIHRvIGJyaW5nIG5ldyBjb250ZW50IGludG8gdGhlIGJyb3dzZXIuCiAqIGxlYXZlIC0gYW5pbWF0aW9uIGlzIHVzZWQgdG8gYW5pbWF0ZSBleGlzdGluZyBjb250ZW50IGF3YXkuCiAqCiAqIFRoZSBlbnRlciBhbmQgbGVhdmUgYW5pbWF0aW9uIG9jY3VyIGNvbmN1cnJlbnRseS4KICoKICogQHNjb3BlCiAqIEBwcmlvcml0eSA0MDAKICoKICogQHBhcmFtIHtzdHJpbmd9IG5nSW5jbHVkZXxzcmMgYW5ndWxhciBleHByZXNzaW9uIGV2YWx1YXRpbmcgdG8gVVJMLiBJZiB0aGUgc291cmNlIGlzIGEgc3RyaW5nIGNvbnN0YW50LAogKiAgICAgICAgICAgICAgICAgbWFrZSBzdXJlIHlvdSB3cmFwIGl0IGluICoqc2luZ2xlKiogcXVvdGVzLCBlLmcuIGBzcmM9IidteVBhcnRpYWxUZW1wbGF0ZS5odG1sJyJgLgogKiBAcGFyYW0ge3N0cmluZz19IG9ubG9hZCBFeHByZXNzaW9uIHRvIGV2YWx1YXRlIHdoZW4gYSBuZXcgcGFydGlhbCBpcyBsb2FkZWQuCiAqCiAqIEBwYXJhbSB7c3RyaW5nPX0gYXV0b3Njcm9sbCBXaGV0aGVyIGBuZ0luY2x1ZGVgIHNob3VsZCBjYWxsIHtAbGluayBuZy4kYW5jaG9yU2Nyb2xsCiAqICAgICAgICAgICAgICAgICAgJGFuY2hvclNjcm9sbH0gdG8gc2Nyb2xsIHRoZSB2aWV3cG9ydCBhZnRlciB0aGUgY29udGVudCBpcyBsb2FkZWQuCiAqCiAqICAgICAgICAgICAgICAgICAgLSBJZiB0aGUgYXR0cmlidXRlIGlzIG5vdCBzZXQsIGRpc2FibGUgc2Nyb2xsaW5nLgogKiAgICAgICAgICAgICAgICAgIC0gSWYgdGhlIGF0dHJpYnV0ZSBpcyBzZXQgd2l0aG91dCB2YWx1ZSwgZW5hYmxlIHNjcm9sbGluZy4KICogICAgICAgICAgICAgICAgICAtIE90aGVyd2lzZSBlbmFibGUgc2Nyb2xsaW5nIG9ubHkgaWYgdGhlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydXRoeSB2YWx1ZS4KICoKICogQGV4YW1wbGUKICA8ZXhhbXBsZSBtb2R1bGU9ImluY2x1ZGVFeGFtcGxlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJ0ZW1wbGF0ZSIgbmctb3B0aW9ucz0idC5uYW1lIGZvciB0IGluIHRlbXBsYXRlcyI+CiAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj4oYmxhbmspPC9vcHRpb24+CiAgICAgICA8L3NlbGVjdD4KICAgICAgIHVybCBvZiB0aGUgdGVtcGxhdGU6IDx0dD57e3RlbXBsYXRlLnVybH19PC90dD4KICAgICAgIDxoci8+CiAgICAgICA8ZGl2IGNsYXNzPSJzbGlkZS1hbmltYXRlLWNvbnRhaW5lciI+CiAgICAgICAgIDxkaXYgY2xhc3M9InNsaWRlLWFuaW1hdGUiIG5nLWluY2x1ZGU9InRlbXBsYXRlLnVybCI+PC9kaXY+CiAgICAgICA8L2Rpdj4KICAgICA8L2Rpdj4KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgIGFuZ3VsYXIubW9kdWxlKCdpbmNsdWRlRXhhbXBsZScsIFsnbmdBbmltYXRlJ10pCiAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICRzY29wZS50ZW1wbGF0ZXMgPQogICAgICAgICAgICBbIHsgbmFtZTogJ3RlbXBsYXRlMS5odG1sJywgdXJsOiAndGVtcGxhdGUxLmh0bWwnfSwKICAgICAgICAgICAgICB7IG5hbWU6ICd0ZW1wbGF0ZTIuaHRtbCcsIHVybDogJ3RlbXBsYXRlMi5odG1sJ30gXTsKICAgICAgICAgICRzY29wZS50ZW1wbGF0ZSA9ICRzY29wZS50ZW1wbGF0ZXNbMF07CiAgICAgICAgfV0pOwogICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InRlbXBsYXRlMS5odG1sIj4KICAgICAgQ29udGVudCBvZiB0ZW1wbGF0ZTEuaHRtbAogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0idGVtcGxhdGUyLmh0bWwiPgogICAgICBDb250ZW50IG9mIHRlbXBsYXRlMi5odG1sCiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgIC5zbGlkZS1hbmltYXRlLWNvbnRhaW5lciB7CiAgICAgICAgcG9zaXRpb246cmVsYXRpdmU7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGhlaWdodDo0MHB4OwogICAgICAgIG92ZXJmbG93OmhpZGRlbjsKICAgICAgfQoKICAgICAgLnNsaWRlLWFuaW1hdGUgewogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgfQoKICAgICAgLnNsaWRlLWFuaW1hdGUubmctZW50ZXIsIC5zbGlkZS1hbmltYXRlLm5nLWxlYXZlIHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgICB0cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CgogICAgICAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgICAgIHRvcDowOwogICAgICAgIGxlZnQ6MDsKICAgICAgICByaWdodDowOwogICAgICAgIGJvdHRvbTowOwogICAgICAgIGRpc3BsYXk6YmxvY2s7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICB9CgogICAgICAuc2xpZGUtYW5pbWF0ZS5uZy1lbnRlciB7CiAgICAgICAgdG9wOi01MHB4OwogICAgICB9CiAgICAgIC5zbGlkZS1hbmltYXRlLm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7CiAgICAgICAgdG9wOjA7CiAgICAgIH0KCiAgICAgIC5zbGlkZS1hbmltYXRlLm5nLWxlYXZlIHsKICAgICAgICB0b3A6MDsKICAgICAgfQogICAgICAuc2xpZGUtYW5pbWF0ZS5uZy1sZWF2ZS5uZy1sZWF2ZS1hY3RpdmUgewogICAgICAgIHRvcDo1MHB4OwogICAgICB9CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgdmFyIHRlbXBsYXRlU2VsZWN0ID0gZWxlbWVudChieS5tb2RlbCgndGVtcGxhdGUnKSk7CiAgICAgIHZhciBpbmNsdWRlRWxlbSA9IGVsZW1lbnQoYnkuY3NzKCdbbmctaW5jbHVkZV0nKSk7CgogICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUxLmh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3QoaW5jbHVkZUVsZW0uZ2V0VGV4dCgpKS50b01hdGNoKC9Db250ZW50IG9mIHRlbXBsYXRlMS5odG1sLyk7CiAgICAgIH0pOwoKICAgICAgaXQoJ3Nob3VsZCBsb2FkIHRlbXBsYXRlMi5odG1sJywgZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGJyb3dzZXIucGFyYW1zLmJyb3dzZXIgPT0gJ2ZpcmVmb3gnKSB7CiAgICAgICAgICAvLyBGaXJlZm94IGNhbid0IGhhbmRsZSB1c2luZyBzZWxlY3RzCiAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvcHJvdHJhY3Rvci9pc3N1ZXMvNDgwCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlU2VsZWN0LmNsaWNrKCk7CiAgICAgICAgdGVtcGxhdGVTZWxlY3QuYWxsKGJ5LmNzcygnb3B0aW9uJykpLmdldCgyKS5jbGljaygpOwogICAgICAgIGV4cGVjdChpbmNsdWRlRWxlbS5nZXRUZXh0KCkpLnRvTWF0Y2goL0NvbnRlbnQgb2YgdGVtcGxhdGUyLmh0bWwvKTsKICAgICAgfSk7CgogICAgICBpdCgnc2hvdWxkIGNoYW5nZSB0byBibGFuaycsIGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChicm93c2VyLnBhcmFtcy5icm93c2VyID09ICdmaXJlZm94JykgewogICAgICAgICAgLy8gRmlyZWZveCBjYW4ndCBoYW5kbGUgdXNpbmcgc2VsZWN0cwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0ZW1wbGF0ZVNlbGVjdC5jbGljaygpOwogICAgICAgIHRlbXBsYXRlU2VsZWN0LmFsbChieS5jc3MoJ29wdGlvbicpKS5nZXQoMCkuY2xpY2soKTsKICAgICAgICBleHBlY3QoaW5jbHVkZUVsZW0uaXNQcmVzZW50KCkpLnRvQmUoZmFsc2UpOwogICAgICB9KTsKICAgIDwvZmlsZT4KICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZXZlbnQKICogQG5hbWUgbmdJbmNsdWRlIyRpbmNsdWRlQ29udGVudFJlcXVlc3RlZAogKiBAZXZlbnRUeXBlIGVtaXQgb24gdGhlIHNjb3BlIG5nSW5jbHVkZSB3YXMgZGVjbGFyZWQgaW4KICogQGRlc2NyaXB0aW9uCiAqIEVtaXR0ZWQgZXZlcnkgdGltZSB0aGUgbmdJbmNsdWRlIGNvbnRlbnQgaXMgcmVxdWVzdGVkLgogKgogKiBAcGFyYW0ge09iamVjdH0gYW5ndWxhckV2ZW50IFN5bnRoZXRpYyBldmVudCBvYmplY3QuCiAqIEBwYXJhbSB7U3RyaW5nfSBzcmMgVVJMIG9mIGNvbnRlbnQgdG8gbG9hZC4KICovCgoKLyoqCiAqIEBuZ2RvYyBldmVudAogKiBAbmFtZSBuZ0luY2x1ZGUjJGluY2x1ZGVDb250ZW50TG9hZGVkCiAqIEBldmVudFR5cGUgZW1pdCBvbiB0aGUgY3VycmVudCBuZ0luY2x1ZGUgc2NvcGUKICogQGRlc2NyaXB0aW9uCiAqIEVtaXR0ZWQgZXZlcnkgdGltZSB0aGUgbmdJbmNsdWRlIGNvbnRlbnQgaXMgcmVsb2FkZWQuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBhbmd1bGFyRXZlbnQgU3ludGhldGljIGV2ZW50IG9iamVjdC4KICogQHBhcmFtIHtTdHJpbmd9IHNyYyBVUkwgb2YgY29udGVudCB0byBsb2FkLgogKi8KCgovKioKICogQG5nZG9jIGV2ZW50CiAqIEBuYW1lIG5nSW5jbHVkZSMkaW5jbHVkZUNvbnRlbnRFcnJvcgogKiBAZXZlbnRUeXBlIGVtaXQgb24gdGhlIHNjb3BlIG5nSW5jbHVkZSB3YXMgZGVjbGFyZWQgaW4KICogQGRlc2NyaXB0aW9uCiAqIEVtaXR0ZWQgd2hlbiBhIHRlbXBsYXRlIEhUVFAgcmVxdWVzdCB5aWVsZHMgYW4gZXJyb25vdXMgcmVzcG9uc2UgKHN0YXR1cyA8IDIwMCB8fCBzdGF0dXMgPiAyOTkpCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBhbmd1bGFyRXZlbnQgU3ludGhldGljIGV2ZW50IG9iamVjdC4KICogQHBhcmFtIHtTdHJpbmd9IHNyYyBVUkwgb2YgY29udGVudCB0byBsb2FkLgogKi8KdmFyIG5nSW5jbHVkZURpcmVjdGl2ZSA9IFsnJHRlbXBsYXRlUmVxdWVzdCcsICckYW5jaG9yU2Nyb2xsJywgJyRhbmltYXRlJywgJyRzY2UnLAogICAgICAgICAgICAgICAgICBmdW5jdGlvbigkdGVtcGxhdGVSZXF1ZXN0LCAgICRhbmNob3JTY3JvbGwsICAgJGFuaW1hdGUsICAgJHNjZSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0VDQScsCiAgICBwcmlvcml0eTogNDAwLAogICAgdGVybWluYWw6IHRydWUsCiAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICBjb250cm9sbGVyOiBhbmd1bGFyLm5vb3AsCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgIHZhciBzcmNFeHAgPSBhdHRyLm5nSW5jbHVkZSB8fCBhdHRyLnNyYywKICAgICAgICAgIG9ubG9hZEV4cCA9IGF0dHIub25sb2FkIHx8ICcnLAogICAgICAgICAgYXV0b1Njcm9sbEV4cCA9IGF0dHIuYXV0b3Njcm9sbDsKCiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBjdHJsLCAkdHJhbnNjbHVkZSkgewogICAgICAgIHZhciBjaGFuZ2VDb3VudGVyID0gMCwKICAgICAgICAgICAgY3VycmVudFNjb3BlLAogICAgICAgICAgICBwcmV2aW91c0VsZW1lbnQsCiAgICAgICAgICAgIGN1cnJlbnRFbGVtZW50OwoKICAgICAgICB2YXIgY2xlYW51cExhc3RJbmNsdWRlQ29udGVudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYocHJldmlvdXNFbGVtZW50KSB7CiAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmKGN1cnJlbnRTY29wZSkgewogICAgICAgICAgICBjdXJyZW50U2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgY3VycmVudFNjb3BlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmKGN1cnJlbnRFbGVtZW50KSB7CiAgICAgICAgICAgICRhbmltYXRlLmxlYXZlKGN1cnJlbnRFbGVtZW50KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBwcmV2aW91c0VsZW1lbnQgPSBjdXJyZW50RWxlbWVudDsKICAgICAgICAgICAgY3VycmVudEVsZW1lbnQgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHNjb3BlLiR3YXRjaCgkc2NlLnBhcnNlQXNSZXNvdXJjZVVybChzcmNFeHApLCBmdW5jdGlvbiBuZ0luY2x1ZGVXYXRjaEFjdGlvbihzcmMpIHsKICAgICAgICAgIHZhciBhZnRlckFuaW1hdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKGF1dG9TY3JvbGxFeHApICYmICghYXV0b1Njcm9sbEV4cCB8fCBzY29wZS4kZXZhbChhdXRvU2Nyb2xsRXhwKSkpIHsKICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgdGhpc0NoYW5nZUlkID0gKytjaGFuZ2VDb3VudGVyOwoKICAgICAgICAgIGlmIChzcmMpIHsKICAgICAgICAgICAgLy9zZXQgdGhlIDJuZCBwYXJhbSB0byB0cnVlIHRvIGlnbm9yZSB0aGUgdGVtcGxhdGUgcmVxdWVzdCBlcnJvciBzbyB0aGF0IHRoZSBpbm5lcgogICAgICAgICAgICAvL2NvbnRlbnRzIGFuZCBzY29wZSBjYW4gYmUgY2xlYW5lZCB1cC4KICAgICAgICAgICAgJHRlbXBsYXRlUmVxdWVzdChzcmMsIHRydWUpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICBpZiAodGhpc0NoYW5nZUlkICE9PSBjaGFuZ2VDb3VudGVyKSByZXR1cm47CiAgICAgICAgICAgICAgdmFyIG5ld1Njb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgIGN0cmwudGVtcGxhdGUgPSByZXNwb25zZTsKCiAgICAgICAgICAgICAgLy8gTm90ZTogVGhpcyB3aWxsIGFsc28gbGluayBhbGwgY2hpbGRyZW4gb2YgbmctaW5jbHVkZSB0aGF0IHdlcmUgY29udGFpbmVkIGluIHRoZSBvcmlnaW5hbAogICAgICAgICAgICAgIC8vIGh0bWwuIElmIHRoYXQgY29udGVudCBjb250YWlucyBjb250cm9sbGVycywgLi4uIHRoZXkgY291bGQgcG9sbHV0ZS9jaGFuZ2UgdGhlIHNjb3BlLgogICAgICAgICAgICAgIC8vIEhvd2V2ZXIsIHVzaW5nIG5nLWluY2x1ZGUgb24gYW4gZWxlbWVudCB3aXRoIGFkZGl0aW9uYWwgY29udGVudCBkb2VzIG5vdCBtYWtlIHNlbnNlLi4uCiAgICAgICAgICAgICAgLy8gTm90ZTogV2UgY2FuJ3QgcmVtb3ZlIHRoZW0gaW4gdGhlIGNsb25lQXR0Y2hGbiBvZiAkdHJhbnNjbHVkZSBhcyB0aGF0CiAgICAgICAgICAgICAgLy8gZnVuY3Rpb24gaXMgY2FsbGVkIGJlZm9yZSBsaW5raW5nIHRoZSBjb250ZW50LCB3aGljaCB3b3VsZCBhcHBseSBjaGlsZAogICAgICAgICAgICAgIC8vIGRpcmVjdGl2ZXMgdG8gbm9uIGV4aXN0aW5nIGVsZW1lbnRzLgogICAgICAgICAgICAgIHZhciBjbG9uZSA9ICR0cmFuc2NsdWRlKG5ld1Njb3BlLCBmdW5jdGlvbihjbG9uZSkgewogICAgICAgICAgICAgICAgY2xlYW51cExhc3RJbmNsdWRlQ29udGVudCgpOwogICAgICAgICAgICAgICAgJGFuaW1hdGUuZW50ZXIoY2xvbmUsIG51bGwsICRlbGVtZW50KS50aGVuKGFmdGVyQW5pbWF0aW9uKTsKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY3VycmVudFNjb3BlID0gbmV3U2NvcGU7CiAgICAgICAgICAgICAgY3VycmVudEVsZW1lbnQgPSBjbG9uZTsKCiAgICAgICAgICAgICAgY3VycmVudFNjb3BlLiRlbWl0KCckaW5jbHVkZUNvbnRlbnRMb2FkZWQnLCBzcmMpOwogICAgICAgICAgICAgIHNjb3BlLiRldmFsKG9ubG9hZEV4cCk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmICh0aGlzQ2hhbmdlSWQgPT09IGNoYW5nZUNvdW50ZXIpIHsKICAgICAgICAgICAgICAgIGNsZWFudXBMYXN0SW5jbHVkZUNvbnRlbnQoKTsKICAgICAgICAgICAgICAgIHNjb3BlLiRlbWl0KCckaW5jbHVkZUNvbnRlbnRFcnJvcicsIHNyYyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2NvcGUuJGVtaXQoJyRpbmNsdWRlQ29udGVudFJlcXVlc3RlZCcsIHNyYyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjbGVhbnVwTGFzdEluY2x1ZGVDb250ZW50KCk7CiAgICAgICAgICAgIGN0cmwudGVtcGxhdGUgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9OwogICAgfQogIH07Cn1dOwoKLy8gVGhpcyBkaXJlY3RpdmUgaXMgY2FsbGVkIGR1cmluZyB0aGUgJHRyYW5zY2x1ZGUgY2FsbCBvZiB0aGUgZmlyc3QgYG5nSW5jbHVkZWAgZGlyZWN0aXZlLgovLyBJdCB3aWxsIHJlcGxhY2UgYW5kIGNvbXBpbGUgdGhlIGNvbnRlbnQgb2YgdGhlIGVsZW1lbnQgd2l0aCB0aGUgbG9hZGVkIHRlbXBsYXRlLgovLyBXZSBuZWVkIHRoaXMgZGlyZWN0aXZlIHNvIHRoYXQgdGhlIGVsZW1lbnQgY29udGVudCBpcyBhbHJlYWR5IGZpbGxlZCB3aGVuCi8vIHRoZSBsaW5rIGZ1bmN0aW9uIG9mIGFub3RoZXIgZGlyZWN0aXZlIG9uIHRoZSBzYW1lIGVsZW1lbnQgYXMgbmdJbmNsdWRlCi8vIGlzIGNhbGxlZC4KdmFyIG5nSW5jbHVkZUZpbGxDb250ZW50RGlyZWN0aXZlID0gWyckY29tcGlsZScsCiAgZnVuY3Rpb24oJGNvbXBpbGUpIHsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRUNBJywKICAgICAgcHJpb3JpdHk6IC00MDAsCiAgICAgIHJlcXVpcmU6ICduZ0luY2x1ZGUnLAogICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBjdHJsKSB7CiAgICAgICAgaWYgKC9TVkcvLnRlc3QoJGVsZW1lbnRbMF0udG9TdHJpbmcoKSkpIHsKICAgICAgICAgIC8vIFdlYktpdDogaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTEzNTY5OCAtLS0gU1ZHIGVsZW1lbnRzIGRvIG5vdAogICAgICAgICAgLy8gc3VwcG9ydCBpbm5lckhUTUwsIHNvIGRldGVjdCB0aGlzIGhlcmUgYW5kIHRyeSB0byBnZW5lcmF0ZSB0aGUgY29udGVudHMKICAgICAgICAgIC8vIHNwZWNpYWxseS4KICAgICAgICAgICRlbGVtZW50LmVtcHR5KCk7CiAgICAgICAgICAkY29tcGlsZShqcUxpdGVCdWlsZEZyYWdtZW50KGN0cmwudGVtcGxhdGUsIGRvY3VtZW50KS5jaGlsZE5vZGVzKShzY29wZSwKICAgICAgICAgICAgICBmdW5jdGlvbiBuYW1lc3BhY2VBZGFwdGVkQ2xvbmUoY2xvbmUpIHsKICAgICAgICAgICAgJGVsZW1lbnQuYXBwZW5kKGNsb25lKTsKICAgICAgICAgIH0sIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCAkZWxlbWVudCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAkZWxlbWVudC5odG1sKGN0cmwudGVtcGxhdGUpOwogICAgICAgICRjb21waWxlKCRlbGVtZW50LmNvbnRlbnRzKCkpKHNjb3BlKTsKICAgICAgfQogICAgfTsKICB9XTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nSW5pdAogKiBAcmVzdHJpY3QgQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdJbml0YCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBldmFsdWF0ZSBhbiBleHByZXNzaW9uIGluIHRoZQogKiBjdXJyZW50IHNjb3BlLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1lcnJvciI+CiAqIFRoZSBvbmx5IGFwcHJvcHJpYXRlIHVzZSBvZiBgbmdJbml0YCBpcyBmb3IgYWxpYXNpbmcgc3BlY2lhbCBwcm9wZXJ0aWVzIG9mCiAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgYG5nUmVwZWF0YH0sIGFzIHNlZW4gaW4gdGhlIGRlbW8gYmVsb3cuIEJlc2lkZXMgdGhpcyBjYXNlLCB5b3UKICogc2hvdWxkIHVzZSB7QGxpbmsgZ3VpZGUvY29udHJvbGxlciBjb250cm9sbGVyc30gcmF0aGVyIHRoYW4gYG5nSW5pdGAKICogdG8gaW5pdGlhbGl6ZSB2YWx1ZXMgb24gYSBzY29wZS4KICogPC9kaXY+CiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKk5vdGUqKjogSWYgeW91IGhhdmUgYXNzaWdubWVudCBpbiBgbmdJbml0YCBhbG9uZyB3aXRoIHtAbGluayBuZy4kZmlsdGVyIGAkZmlsdGVyYH0sIG1ha2UKICogc3VyZSB5b3UgaGF2ZSBwYXJlbnRoZXNpcyBmb3IgY29ycmVjdCBwcmVjZWRlbmNlOgogKiA8cHJlIGNsYXNzPSJwcmV0dHlwcmludCI+CiAqICAgPGRpdiBuZy1pbml0PSJ0ZXN0MSA9IChkYXRhIHwgb3JkZXJCeTonbmFtZScpIj48L2Rpdj4KICogPC9wcmU+CiAqIDwvZGl2PgogKgogKiBAcHJpb3JpdHkgNDUwCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nSW5pdCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9ImluaXRFeGFtcGxlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgICBhbmd1bGFyLm1vZHVsZSgnaW5pdEV4YW1wbGUnLCBbXSkKICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICRzY29wZS5saXN0ID0gW1snYScsICdiJ10sIFsnYycsICdkJ11dOwogICAgICAgfV0pOwogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgPGRpdiBuZy1yZXBlYXQ9ImlubmVyTGlzdCBpbiBsaXN0IiBuZy1pbml0PSJvdXRlckluZGV4ID0gJGluZGV4Ij4KICAgICAgIDxkaXYgbmctcmVwZWF0PSJ2YWx1ZSBpbiBpbm5lckxpc3QiIG5nLWluaXQ9ImlubmVySW5kZXggPSAkaW5kZXgiPgogICAgICAgICAgPHNwYW4gY2xhc3M9ImV4YW1wbGUtaW5pdCI+bGlzdFsge3tvdXRlckluZGV4fX0gXVsge3tpbm5lckluZGV4fX0gXSA9IHt7dmFsdWV9fTs8L3NwYW4+CiAgICAgICA8L2Rpdj4KICAgICA8L2Rpdj4KICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBhbGlhcyBpbmRleCBwb3NpdGlvbnMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgdmFyIGVsZW1lbnRzID0gZWxlbWVudC5hbGwoYnkuY3NzKCcuZXhhbXBsZS1pbml0JykpOwogICAgICAgICBleHBlY3QoZWxlbWVudHMuZ2V0KDApLmdldFRleHQoKSkudG9CZSgnbGlzdFsgMCBdWyAwIF0gPSBhOycpOwogICAgICAgICBleHBlY3QoZWxlbWVudHMuZ2V0KDEpLmdldFRleHQoKSkudG9CZSgnbGlzdFsgMCBdWyAxIF0gPSBiOycpOwogICAgICAgICBleHBlY3QoZWxlbWVudHMuZ2V0KDIpLmdldFRleHQoKSkudG9CZSgnbGlzdFsgMSBdWyAwIF0gPSBjOycpOwogICAgICAgICBleHBlY3QoZWxlbWVudHMuZ2V0KDMpLmdldFRleHQoKSkudG9CZSgnbGlzdFsgMSBdWyAxIF0gPSBkOycpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdJbml0RGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogIHByaW9yaXR5OiA0NTAsCiAgY29tcGlsZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICBwcmU6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgIHNjb3BlLiRldmFsKGF0dHJzLm5nSW5pdCk7CiAgICAgIH0KICAgIH07CiAgfQp9KTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nTm9uQmluZGFibGUKICogQHJlc3RyaWN0IEFDCiAqIEBwcmlvcml0eSAxMDAwCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nTm9uQmluZGFibGVgIGRpcmVjdGl2ZSB0ZWxscyBBbmd1bGFyIG5vdCB0byBjb21waWxlIG9yIGJpbmQgdGhlIGNvbnRlbnRzIG9mIHRoZSBjdXJyZW50CiAqIERPTSBlbGVtZW50LiBUaGlzIGlzIHVzZWZ1bCBpZiB0aGUgZWxlbWVudCBjb250YWlucyB3aGF0IGFwcGVhcnMgdG8gYmUgQW5ndWxhciBkaXJlY3RpdmVzIGFuZAogKiBiaW5kaW5ncyBidXQgd2hpY2ggc2hvdWxkIGJlIGlnbm9yZWQgYnkgQW5ndWxhci4gVGhpcyBjb3VsZCBiZSB0aGUgY2FzZSBpZiB5b3UgaGF2ZSBhIHNpdGUgdGhhdAogKiBkaXNwbGF5cyBzbmlwcGV0cyBvZiBjb2RlLCBmb3IgaW5zdGFuY2UuCiAqCiAqIEBlbGVtZW50IEFOWQogKgogKiBAZXhhbXBsZQogKiBJbiB0aGlzIGV4YW1wbGUgdGhlcmUgYXJlIHR3byBsb2NhdGlvbnMgd2hlcmUgYSBzaW1wbGUgaW50ZXJwb2xhdGlvbiBiaW5kaW5nIChge3t9fWApIGlzIHByZXNlbnQsCiAqIGJ1dCB0aGUgb25lIHdyYXBwZWQgaW4gYG5nTm9uQmluZGFibGVgIGlzIGxlZnQgYWxvbmUuCiAqCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZT4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPGRpdj5Ob3JtYWw6IHt7MSArIDJ9fTwvZGl2PgogICAgICAgIDxkaXYgbmctbm9uLWJpbmRhYmxlPklnbm9yZWQ6IHt7MSArIDJ9fTwvZGl2PgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1ub24tYmluZGFibGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnMSArIDInKSkuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJzMnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQuYWxsKGJ5LmNzcygnZGl2JykpLmxhc3QoKS5nZXRUZXh0KCkpLnRvTWF0Y2goLzEgXCsgMi8pOwogICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICovCnZhciBuZ05vbkJpbmRhYmxlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoeyB0ZXJtaW5hbDogdHJ1ZSwgcHJpb3JpdHk6IDEwMDAgfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1BsdXJhbGl6ZQogKiBAcmVzdHJpY3QgRUEKICoKICogQGRlc2NyaXB0aW9uCiAqIGBuZ1BsdXJhbGl6ZWAgaXMgYSBkaXJlY3RpdmUgdGhhdCBkaXNwbGF5cyBtZXNzYWdlcyBhY2NvcmRpbmcgdG8gZW4tVVMgbG9jYWxpemF0aW9uIHJ1bGVzLgogKiBUaGVzZSBydWxlcyBhcmUgYnVuZGxlZCB3aXRoIGFuZ3VsYXIuanMsIGJ1dCBjYW4gYmUgb3ZlcnJpZGRlbgogKiAoc2VlIHtAbGluayBndWlkZS9pMThuIEFuZ3VsYXIgaTE4bn0gZGV2IGd1aWRlKS4gWW91IGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZSBkaXJlY3RpdmUKICogYnkgc3BlY2lmeWluZyB0aGUgbWFwcGluZ3MgYmV0d2VlbgogKiBbcGx1cmFsIGNhdGVnb3JpZXNdKGh0dHA6Ly91bmljb2RlLm9yZy9yZXBvcy9jbGRyLXRtcC90cnVuay9kaWZmL3N1cHBsZW1lbnRhbC9sYW5ndWFnZV9wbHVyYWxfcnVsZXMuaHRtbCkKICogYW5kIHRoZSBzdHJpbmdzIHRvIGJlIGRpc3BsYXllZC4KICoKICogIyBQbHVyYWwgY2F0ZWdvcmllcyBhbmQgZXhwbGljaXQgbnVtYmVyIHJ1bGVzCiAqIFRoZXJlIGFyZSB0d28KICogW3BsdXJhbCBjYXRlZ29yaWVzXShodHRwOi8vdW5pY29kZS5vcmcvcmVwb3MvY2xkci10bXAvdHJ1bmsvZGlmZi9zdXBwbGVtZW50YWwvbGFuZ3VhZ2VfcGx1cmFsX3J1bGVzLmh0bWwpCiAqIGluIEFuZ3VsYXIncyBkZWZhdWx0IGVuLVVTIGxvY2FsZTogIm9uZSIgYW5kICJvdGhlciIuCiAqCiAqIFdoaWxlIGEgcGx1cmFsIGNhdGVnb3J5IG1heSBtYXRjaCBtYW55IG51bWJlcnMgKGZvciBleGFtcGxlLCBpbiBlbi1VUyBsb2NhbGUsICJvdGhlciIgY2FuIG1hdGNoCiAqIGFueSBudW1iZXIgdGhhdCBpcyBub3QgMSksIGFuIGV4cGxpY2l0IG51bWJlciBydWxlIGNhbiBvbmx5IG1hdGNoIG9uZSBudW1iZXIuIEZvciBleGFtcGxlLCB0aGUKICogZXhwbGljaXQgbnVtYmVyIHJ1bGUgZm9yICIzIiBtYXRjaGVzIHRoZSBudW1iZXIgMy4gVGhlcmUgYXJlIGV4YW1wbGVzIG9mIHBsdXJhbCBjYXRlZ29yaWVzCiAqIGFuZCBleHBsaWNpdCBudW1iZXIgcnVsZXMgdGhyb3VnaG91dCB0aGUgcmVzdCBvZiB0aGlzIGRvY3VtZW50YXRpb24uCiAqCiAqICMgQ29uZmlndXJpbmcgbmdQbHVyYWxpemUKICogWW91IGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZSBieSBwcm92aWRpbmcgMiBhdHRyaWJ1dGVzOiBgY291bnRgIGFuZCBgd2hlbmAuCiAqIFlvdSBjYW4gYWxzbyBwcm92aWRlIGFuIG9wdGlvbmFsIGF0dHJpYnV0ZSwgYG9mZnNldGAuCiAqCiAqIFRoZSB2YWx1ZSBvZiB0aGUgYGNvdW50YCBhdHRyaWJ1dGUgY2FuIGJlIGVpdGhlciBhIHN0cmluZyBvciBhbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbgogKiBBbmd1bGFyIGV4cHJlc3Npb259OyB0aGVzZSBhcmUgZXZhbHVhdGVkIG9uIHRoZSBjdXJyZW50IHNjb3BlIGZvciBpdHMgYm91bmQgdmFsdWUuCiAqCiAqIFRoZSBgd2hlbmAgYXR0cmlidXRlIHNwZWNpZmllcyB0aGUgbWFwcGluZ3MgYmV0d2VlbiBwbHVyYWwgY2F0ZWdvcmllcyBhbmQgdGhlIGFjdHVhbAogKiBzdHJpbmcgdG8gYmUgZGlzcGxheWVkLiBUaGUgdmFsdWUgb2YgdGhlIGF0dHJpYnV0ZSBzaG91bGQgYmUgYSBKU09OIG9iamVjdC4KICoKICogVGhlIGZvbGxvd2luZyBleGFtcGxlIHNob3dzIGhvdyB0byBjb25maWd1cmUgbmdQbHVyYWxpemU6CiAqCiAqIGBgYGh0bWwKICogPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiCiAgICAgICAgICAgICAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAnMSBwZXJzb24gaXMgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne30gcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICogPC9uZy1wbHVyYWxpemU+CiAqYGBgCiAqCiAqIEluIHRoZSBleGFtcGxlLCBgIjA6IE5vYm9keSBpcyB2aWV3aW5nLiJgIGlzIGFuIGV4cGxpY2l0IG51bWJlciBydWxlLiBJZiB5b3UgZGlkIG5vdAogKiBzcGVjaWZ5IHRoaXMgcnVsZSwgMCB3b3VsZCBiZSBtYXRjaGVkIHRvIHRoZSAib3RoZXIiIGNhdGVnb3J5IGFuZCAiMCBwZW9wbGUgYXJlIHZpZXdpbmciCiAqIHdvdWxkIGJlIHNob3duIGluc3RlYWQgb2YgIk5vYm9keSBpcyB2aWV3aW5nIi4gWW91IGNhbiBzcGVjaWZ5IGFuIGV4cGxpY2l0IG51bWJlciBydWxlIGZvcgogKiBvdGhlciBudW1iZXJzLCBmb3IgZXhhbXBsZSAxMiwgc28gdGhhdCBpbnN0ZWFkIG9mIHNob3dpbmcgIjEyIHBlb3BsZSBhcmUgdmlld2luZyIsIHlvdSBjYW4KICogc2hvdyAiYSBkb3plbiBwZW9wbGUgYXJlIHZpZXdpbmciLgogKgogKiBZb3UgY2FuIHVzZSBhIHNldCBvZiBjbG9zZWQgYnJhY2VzIChge31gKSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgbnVtYmVyIHRoYXQgeW91IHdhbnQgc3Vic3RpdHV0ZWQKICogaW50byBwbHVyYWxpemVkIHN0cmluZ3MuIEluIHRoZSBwcmV2aW91cyBleGFtcGxlLCBBbmd1bGFyIHdpbGwgcmVwbGFjZSBge31gIHdpdGgKICogPHNwYW4gbmctbm9uLWJpbmRhYmxlPmB7e3BlcnNvbkNvdW50fX1gPC9zcGFuPi4gVGhlIGNsb3NlZCBicmFjZXMgYHt9YCBpcyBhIHBsYWNlaG9sZGVyCiAqIGZvciA8c3BhbiBuZy1ub24tYmluZGFibGU+e3tudW1iZXJFeHByZXNzaW9ufX08L3NwYW4+LgogKgogKiAjIENvbmZpZ3VyaW5nIG5nUGx1cmFsaXplIHdpdGggb2Zmc2V0CiAqIFRoZSBgb2Zmc2V0YCBhdHRyaWJ1dGUgYWxsb3dzIGZ1cnRoZXIgY3VzdG9taXphdGlvbiBvZiBwbHVyYWxpemVkIHRleHQsIHdoaWNoIGNhbiByZXN1bHQgaW4KICogYSBiZXR0ZXIgdXNlciBleHBlcmllbmNlLiBGb3IgZXhhbXBsZSwgaW5zdGVhZCBvZiB0aGUgbWVzc2FnZSAiNCBwZW9wbGUgYXJlIHZpZXdpbmcgdGhpcyBkb2N1bWVudCIsCiAqIHlvdSBtaWdodCBkaXNwbGF5ICJKb2huLCBLYXRlIGFuZCAyIG90aGVycyBhcmUgdmlld2luZyB0aGlzIGRvY3VtZW50Ii4KICogVGhlIG9mZnNldCBhdHRyaWJ1dGUgYWxsb3dzIHlvdSB0byBvZmZzZXQgYSBudW1iZXIgYnkgYW55IGRlc2lyZWQgdmFsdWUuCiAqIExldCdzIHRha2UgYSBsb29rIGF0IGFuIGV4YW1wbGU6CiAqCiAqIGBgYGh0bWwKICogPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiIG9mZnNldD0yCiAqICAgICAgICAgICAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICcxJzogJ3t7cGVyc29uMX19IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJzInOiAne3twZXJzb24xfX0gYW5kIHt7cGVyc29uMn19IGFyZSB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIHt9IG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nfSI+CiAqIDwvbmctcGx1cmFsaXplPgogKiBgYGAKICoKICogTm90aWNlIHRoYXQgd2UgYXJlIHN0aWxsIHVzaW5nIHR3byBwbHVyYWwgY2F0ZWdvcmllcyhvbmUsIG90aGVyKSwgYnV0IHdlIGFkZGVkCiAqIHRocmVlIGV4cGxpY2l0IG51bWJlciBydWxlcyAwLCAxIGFuZCAyLgogKiBXaGVuIG9uZSBwZXJzb24sIHBlcmhhcHMgSm9obiwgdmlld3MgdGhlIGRvY3VtZW50LCAiSm9obiBpcyB2aWV3aW5nIiB3aWxsIGJlIHNob3duLgogKiBXaGVuIHRocmVlIHBlb3BsZSB2aWV3IHRoZSBkb2N1bWVudCwgbm8gZXhwbGljaXQgbnVtYmVyIHJ1bGUgaXMgZm91bmQsIHNvCiAqIGFuIG9mZnNldCBvZiAyIGlzIHRha2VuIG9mZiAzLCBhbmQgQW5ndWxhciB1c2VzIDEgdG8gZGVjaWRlIHRoZSBwbHVyYWwgY2F0ZWdvcnkuCiAqIEluIHRoaXMgY2FzZSwgcGx1cmFsIGNhdGVnb3J5ICdvbmUnIGlzIG1hdGNoZWQgYW5kICJKb2huLCBNYXJ5IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nIgogKiBpcyBzaG93bi4KICoKICogTm90ZSB0aGF0IHdoZW4geW91IHNwZWNpZnkgb2Zmc2V0cywgeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yCiAqIG51bWJlcnMgZnJvbSAwIHVwIHRvIGFuZCBpbmNsdWRpbmcgdGhlIG9mZnNldC4gSWYgeW91IHVzZSBhbiBvZmZzZXQgb2YgMywgZm9yIGV4YW1wbGUsCiAqIHlvdSBtdXN0IHByb3ZpZGUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIGZvciAwLCAxLCAyIGFuZCAzLiBZb3UgbXVzdCBhbHNvIHByb3ZpZGUgcGx1cmFsIHN0cmluZ3MgZm9yCiAqIHBsdXJhbCBjYXRlZ29yaWVzICJvbmUiIGFuZCAib3RoZXIiLgogKgogKiBAcGFyYW0ge3N0cmluZ3xleHByZXNzaW9ufSBjb3VudCBUaGUgdmFyaWFibGUgdG8gYmUgYm91bmQgdG8uCiAqIEBwYXJhbSB7c3RyaW5nfSB3aGVuIFRoZSBtYXBwaW5nIGJldHdlZW4gcGx1cmFsIGNhdGVnb3J5IHRvIGl0cyBjb3JyZXNwb25kaW5nIHN0cmluZ3MuCiAqIEBwYXJhbSB7bnVtYmVyPX0gb2Zmc2V0IE9mZnNldCB0byBkZWR1Y3QgZnJvbSB0aGUgdG90YWwgbnVtYmVyLgogKgogKiBAZXhhbXBsZQogICAgPGV4YW1wbGUgbW9kdWxlPSJwbHVyYWxpemVFeGFtcGxlIj4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPHNjcmlwdD4KICAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCdwbHVyYWxpemVFeGFtcGxlJywgW10pCiAgICAgICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAgICAgJHNjb3BlLnBlcnNvbjEgPSAnSWdvcic7CiAgICAgICAgICAgICAgJHNjb3BlLnBlcnNvbjIgPSAnTWlza28nOwogICAgICAgICAgICAgICRzY29wZS5wZXJzb25Db3VudCA9IDE7CiAgICAgICAgICAgIH1dKTsKICAgICAgICA8L3NjcmlwdD4KICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgIFBlcnNvbiAxOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uMSIgdmFsdWU9Iklnb3IiIC8+PGJyLz4KICAgICAgICAgIFBlcnNvbiAyOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uMiIgdmFsdWU9Ik1pc2tvIiAvPjxici8+CiAgICAgICAgICBOdW1iZXIgb2YgUGVvcGxlOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uQ291bnQiIHZhbHVlPSIxIiAvPjxici8+CgogICAgICAgICAgPCEtLS0gRXhhbXBsZSB3aXRoIHNpbXBsZSBwbHVyYWxpemF0aW9uIHJ1bGVzIGZvciBlbiBsb2NhbGUgLS0tPgogICAgICAgICAgV2l0aG91dCBPZmZzZXQ6CiAgICAgICAgICA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIKICAgICAgICAgICAgICAgICAgICAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJzEgcGVyc29uIGlzIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgICAgICAgPC9uZy1wbHVyYWxpemU+PGJyPgoKICAgICAgICAgIDwhLS0tIEV4YW1wbGUgd2l0aCBvZmZzZXQgLS0tPgogICAgICAgICAgV2l0aCBPZmZzZXQoMik6CiAgICAgICAgICA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIgb2Zmc2V0PTIKICAgICAgICAgICAgICAgICAgICAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMSc6ICd7e3BlcnNvbjF9fSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMic6ICd7e3BlcnNvbjF9fSBhbmQge3twZXJzb24yfX0gYXJlIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCB7fSBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgICAgICAgPC9uZy1wbHVyYWxpemU+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCBzaG93IGNvcnJlY3QgcGx1cmFsaXplZCBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB3aXRob3V0T2Zmc2V0ID0gZWxlbWVudC5hbGwoYnkuY3NzKCduZy1wbHVyYWxpemUnKSkuZ2V0KDApOwogICAgICAgICAgdmFyIHdpdGhPZmZzZXQgPSBlbGVtZW50LmFsbChieS5jc3MoJ25nLXBsdXJhbGl6ZScpKS5nZXQoMSk7CiAgICAgICAgICB2YXIgY291bnRJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3BlcnNvbkNvdW50JykpOwoKICAgICAgICAgIGV4cGVjdCh3aXRob3V0T2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnMSBwZXJzb24gaXMgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdCh3aXRoT2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnSWdvciBpcyB2aWV3aW5nLicpOwoKICAgICAgICAgIGNvdW50SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIGNvdW50SW5wdXQuc2VuZEtleXMoJzAnKTsKCiAgICAgICAgICBleHBlY3Qod2l0aG91dE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJ05vYm9keSBpcyB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdOb2JvZHkgaXMgdmlld2luZy4nKTsKCiAgICAgICAgICBjb3VudElucHV0LmNsZWFyKCk7CiAgICAgICAgICBjb3VudElucHV0LnNlbmRLZXlzKCcyJyk7CgogICAgICAgICAgZXhwZWN0KHdpdGhvdXRPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCcyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdCh3aXRoT2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnSWdvciBhbmQgTWlza28gYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgY291bnRJbnB1dC5jbGVhcigpOwogICAgICAgICAgY291bnRJbnB1dC5zZW5kS2V5cygnMycpOwoKICAgICAgICAgIGV4cGVjdCh3aXRob3V0T2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnMyBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3Qod2l0aE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJ0lnb3IsIE1pc2tvIGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicpOwoKICAgICAgICAgIGNvdW50SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIGNvdW50SW5wdXQuc2VuZEtleXMoJzQnKTsKCiAgICAgICAgICBleHBlY3Qod2l0aG91dE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJzQgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdJZ29yLCBNaXNrbyBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgfSk7CiAgICAgICAgaXQoJ3Nob3VsZCBzaG93IGRhdGEtYm91bmQgbmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB3aXRoT2Zmc2V0ID0gZWxlbWVudC5hbGwoYnkuY3NzKCduZy1wbHVyYWxpemUnKSkuZ2V0KDEpOwogICAgICAgICAgdmFyIHBlcnNvbkNvdW50ID0gZWxlbWVudChieS5tb2RlbCgncGVyc29uQ291bnQnKSk7CiAgICAgICAgICB2YXIgcGVyc29uMSA9IGVsZW1lbnQoYnkubW9kZWwoJ3BlcnNvbjEnKSk7CiAgICAgICAgICB2YXIgcGVyc29uMiA9IGVsZW1lbnQoYnkubW9kZWwoJ3BlcnNvbjInKSk7CiAgICAgICAgICBwZXJzb25Db3VudC5jbGVhcigpOwogICAgICAgICAgcGVyc29uQ291bnQuc2VuZEtleXMoJzQnKTsKICAgICAgICAgIHBlcnNvbjEuY2xlYXIoKTsKICAgICAgICAgIHBlcnNvbjEuc2VuZEtleXMoJ0RpJyk7CiAgICAgICAgICBwZXJzb24yLmNsZWFyKCk7CiAgICAgICAgICBwZXJzb24yLnNlbmRLZXlzKCdWb2p0YScpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdEaSwgVm9qdGEgYW5kIDIgb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdQbHVyYWxpemVEaXJlY3RpdmUgPSBbJyRsb2NhbGUnLCAnJGludGVycG9sYXRlJywgZnVuY3Rpb24oJGxvY2FsZSwgJGludGVycG9sYXRlKSB7CiAgdmFyIEJSQUNFID0gL3t9L2c7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRUEnLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgdmFyIG51bWJlckV4cCA9IGF0dHIuY291bnQsCiAgICAgICAgICB3aGVuRXhwID0gYXR0ci4kYXR0ci53aGVuICYmIGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLndoZW4pLCAvLyB3ZSBoYXZlIHt7fX0gaW4gYXR0cnMKICAgICAgICAgIG9mZnNldCA9IGF0dHIub2Zmc2V0IHx8IDAsCiAgICAgICAgICB3aGVucyA9IHNjb3BlLiRldmFsKHdoZW5FeHApIHx8IHt9LAogICAgICAgICAgd2hlbnNFeHBGbnMgPSB7fSwKICAgICAgICAgIHN0YXJ0U3ltYm9sID0gJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sKCksCiAgICAgICAgICBlbmRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sKCksCiAgICAgICAgICBpc1doZW4gPSAvXndoZW4oTWludXMpPyguKykkLzsKCiAgICAgIGZvckVhY2goYXR0ciwgZnVuY3Rpb24oZXhwcmVzc2lvbiwgYXR0cmlidXRlTmFtZSkgewogICAgICAgIGlmIChpc1doZW4udGVzdChhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgd2hlbnNbbG93ZXJjYXNlKGF0dHJpYnV0ZU5hbWUucmVwbGFjZSgnd2hlbicsICcnKS5yZXBsYWNlKCdNaW51cycsICctJykpXSA9CiAgICAgICAgICAgIGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyW2F0dHJpYnV0ZU5hbWVdKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBmb3JFYWNoKHdoZW5zLCBmdW5jdGlvbihleHByZXNzaW9uLCBrZXkpIHsKICAgICAgICB3aGVuc0V4cEZuc1trZXldID0KICAgICAgICAgICRpbnRlcnBvbGF0ZShleHByZXNzaW9uLnJlcGxhY2UoQlJBQ0UsIHN0YXJ0U3ltYm9sICsgbnVtYmVyRXhwICsgJy0nICsKICAgICAgICAgICAgb2Zmc2V0ICsgZW5kU3ltYm9sKSk7CiAgICAgIH0pOwoKICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIG5nUGx1cmFsaXplV2F0Y2goKSB7CiAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VGbG9hdChzY29wZS4kZXZhbChudW1iZXJFeHApKTsKCiAgICAgICAgaWYgKCFpc05hTih2YWx1ZSkpIHsKICAgICAgICAgIC8vaWYgZXhwbGljaXQgbnVtYmVyIHJ1bGUgc3VjaCBhcyAxLCAyLCAzLi4uIGlzIGRlZmluZWQsIGp1c3QgdXNlIGl0LiBPdGhlcndpc2UsCiAgICAgICAgICAvL2NoZWNrIGl0IGFnYWluc3QgcGx1cmFsaXphdGlvbiBydWxlcyBpbiAkbG9jYWxlIHNlcnZpY2UKICAgICAgICAgIGlmICghKHZhbHVlIGluIHdoZW5zKSkgdmFsdWUgPSAkbG9jYWxlLnBsdXJhbENhdCh2YWx1ZSAtIG9mZnNldCk7CiAgICAgICAgICAgcmV0dXJuIHdoZW5zRXhwRm5zW3ZhbHVlXShzY29wZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICB9CiAgICAgIH0sIGZ1bmN0aW9uIG5nUGx1cmFsaXplV2F0Y2hBY3Rpb24obmV3VmFsKSB7CiAgICAgICAgZWxlbWVudC50ZXh0KG5ld1ZhbCk7CiAgICAgIH0pOwogICAgfQogIH07Cn1dOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdSZXBlYXQKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdSZXBlYXRgIGRpcmVjdGl2ZSBpbnN0YW50aWF0ZXMgYSB0ZW1wbGF0ZSBvbmNlIHBlciBpdGVtIGZyb20gYSBjb2xsZWN0aW9uLiBFYWNoIHRlbXBsYXRlCiAqIGluc3RhbmNlIGdldHMgaXRzIG93biBzY29wZSwgd2hlcmUgdGhlIGdpdmVuIGxvb3AgdmFyaWFibGUgaXMgc2V0IHRvIHRoZSBjdXJyZW50IGNvbGxlY3Rpb24gaXRlbSwKICogYW5kIGAkaW5kZXhgIGlzIHNldCB0byB0aGUgaXRlbSBpbmRleCBvciBrZXkuCiAqCiAqIFNwZWNpYWwgcHJvcGVydGllcyBhcmUgZXhwb3NlZCBvbiB0aGUgbG9jYWwgc2NvcGUgb2YgZWFjaCB0ZW1wbGF0ZSBpbnN0YW5jZSwgaW5jbHVkaW5nOgogKgogKiB8IFZhcmlhYmxlICB8IFR5cGUgICAgICAgICAgICB8IERldGFpbHMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwtLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICogfCBgJGluZGV4YCAgfCB7QHR5cGUgbnVtYmVyfSAgfCBpdGVyYXRvciBvZmZzZXQgb2YgdGhlIHJlcGVhdGVkIGVsZW1lbnQgKDAuLmxlbmd0aC0xKSAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8IGAkZmlyc3RgICB8IHtAdHlwZSBib29sZWFufSB8IHRydWUgaWYgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaXMgZmlyc3QgaW4gdGhlIGl0ZXJhdG9yLiAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwgYCRtaWRkbGVgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBiZXR3ZWVuIHRoZSBmaXJzdCBhbmQgbGFzdCBpbiB0aGUgaXRlcmF0b3IuIHwKICogfCBgJGxhc3RgICAgfCB7QHR5cGUgYm9vbGVhbn0gfCB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGxhc3QgaW4gdGhlIGl0ZXJhdG9yLiAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8IGAkZXZlbmAgICB8IHtAdHlwZSBib29sZWFufSB8IHRydWUgaWYgdGhlIGl0ZXJhdG9yIHBvc2l0aW9uIGAkaW5kZXhgIGlzIGV2ZW4gKG90aGVyd2lzZSBmYWxzZSkuICAgICAgICAgICB8CiAqIHwgYCRvZGRgICAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgaXRlcmF0b3IgcG9zaXRpb24gYCRpbmRleGAgaXMgb2RkIChvdGhlcndpc2UgZmFsc2UpLiAgICAgICAgICAgIHwKICoKICogQ3JlYXRpbmcgYWxpYXNlcyBmb3IgdGhlc2UgcHJvcGVydGllcyBpcyBwb3NzaWJsZSB3aXRoIHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbml0IGBuZ0luaXRgfS4KICogVGhpcyBtYXkgYmUgdXNlZnVsIHdoZW4sIGZvciBpbnN0YW5jZSwgbmVzdGluZyBuZ1JlcGVhdHMuCiAqCiAqICMgU3BlY2lhbCByZXBlYXQgc3RhcnQgYW5kIGVuZCBwb2ludHMKICogVG8gcmVwZWF0IGEgc2VyaWVzIG9mIGVsZW1lbnRzIGluc3RlYWQgb2YganVzdCBvbmUgcGFyZW50IGVsZW1lbnQsIG5nUmVwZWF0IChhcyB3ZWxsIGFzIG90aGVyIG5nIGRpcmVjdGl2ZXMpIHN1cHBvcnRzIGV4dGVuZGluZwogKiB0aGUgcmFuZ2Ugb2YgdGhlIHJlcGVhdGVyIGJ5IGRlZmluaW5nIGV4cGxpY2l0IHN0YXJ0IGFuZCBlbmQgcG9pbnRzIGJ5IHVzaW5nICoqbmctcmVwZWF0LXN0YXJ0KiogYW5kICoqbmctcmVwZWF0LWVuZCoqIHJlc3BlY3RpdmVseS4KICogVGhlICoqbmctcmVwZWF0LXN0YXJ0KiogZGlyZWN0aXZlIHdvcmtzIHRoZSBzYW1lIGFzICoqbmctcmVwZWF0KiosIGJ1dCB3aWxsIHJlcGVhdCBhbGwgdGhlIEhUTUwgY29kZSAoaW5jbHVkaW5nIHRoZSB0YWcgaXQncyBkZWZpbmVkIG9uKQogKiB1cCB0byBhbmQgaW5jbHVkaW5nIHRoZSBlbmRpbmcgSFRNTCB0YWcgd2hlcmUgKipuZy1yZXBlYXQtZW5kKiogaXMgcGxhY2VkLgogKgogKiBUaGUgZXhhbXBsZSBiZWxvdyBtYWtlcyB1c2Ugb2YgdGhpcyBmZWF0dXJlOgogKiBgYGBodG1sCiAqICAgPGhlYWRlciBuZy1yZXBlYXQtc3RhcnQ9Iml0ZW0gaW4gaXRlbXMiPgogKiAgICAgSGVhZGVyIHt7IGl0ZW0gfX0KICogICA8L2hlYWRlcj4KICogICA8ZGl2IGNsYXNzPSJib2R5Ij4KICogICAgIEJvZHkge3sgaXRlbSB9fQogKiAgIDwvZGl2PgogKiAgIDxmb290ZXIgbmctcmVwZWF0LWVuZD4KICogICAgIEZvb3RlciB7eyBpdGVtIH19CiAqICAgPC9mb290ZXI+CiAqIGBgYAogKgogKiBBbmQgd2l0aCBhbiBpbnB1dCBvZiB7QHR5cGUgWydBJywnQiddfSBmb3IgdGhlIGl0ZW1zIHZhcmlhYmxlIGluIHRoZSBleGFtcGxlIGFib3ZlLCB0aGUgb3V0cHV0IHdpbGwgZXZhbHVhdGUgdG86CiAqIGBgYGh0bWwKICogICA8aGVhZGVyPgogKiAgICAgSGVhZGVyIEEKICogICA8L2hlYWRlcj4KICogICA8ZGl2IGNsYXNzPSJib2R5Ij4KICogICAgIEJvZHkgQQogKiAgIDwvZGl2PgogKiAgIDxmb290ZXI+CiAqICAgICBGb290ZXIgQQogKiAgIDwvZm9vdGVyPgogKiAgIDxoZWFkZXI+CiAqICAgICBIZWFkZXIgQgogKiAgIDwvaGVhZGVyPgogKiAgIDxkaXYgY2xhc3M9ImJvZHkiPgogKiAgICAgQm9keSBCCiAqICAgPC9kaXY+CiAqICAgPGZvb3Rlcj4KICogICAgIEZvb3RlciBCCiAqICAgPC9mb290ZXI+CiAqIGBgYAogKgogKiBUaGUgY3VzdG9tIHN0YXJ0IGFuZCBlbmQgcG9pbnRzIGZvciBuZ1JlcGVhdCBhbHNvIHN1cHBvcnQgYWxsIG90aGVyIEhUTUwgZGlyZWN0aXZlIHN5bnRheCBmbGF2b3JzIHByb3ZpZGVkIGluIEFuZ3VsYXJKUyAoc3VjaAogKiBhcyAqKmRhdGEtbmctcmVwZWF0LXN0YXJ0KiosICoqeC1uZy1yZXBlYXQtc3RhcnQqKiBhbmQgKipuZzpyZXBlYXQtc3RhcnQqKikuCiAqCiAqIEBhbmltYXRpb25zCiAqICoqLmVudGVyKiogLSB3aGVuIGEgbmV3IGl0ZW0gaXMgYWRkZWQgdG8gdGhlIGxpc3Qgb3Igd2hlbiBhbiBpdGVtIGlzIHJldmVhbGVkIGFmdGVyIGEgZmlsdGVyCiAqCiAqICoqLmxlYXZlKiogLSB3aGVuIGFuIGl0ZW0gaXMgcmVtb3ZlZCBmcm9tIHRoZSBsaXN0IG9yIHdoZW4gYW4gaXRlbSBpcyBmaWx0ZXJlZCBvdXQKICoKICogKioubW92ZSoqIC0gd2hlbiBhbiBhZGphY2VudCBpdGVtIGlzIGZpbHRlcmVkIG91dCBjYXVzaW5nIGEgcmVvcmRlciBvciB3aGVuIHRoZSBpdGVtIGNvbnRlbnRzIGFyZSByZW9yZGVyZWQKICoKICogQGVsZW1lbnQgQU5ZCiAqIEBzY29wZQogKiBAcHJpb3JpdHkgMTAwMAogKiBAcGFyYW0ge3JlcGVhdF9leHByZXNzaW9ufSBuZ1JlcGVhdCBUaGUgZXhwcmVzc2lvbiBpbmRpY2F0aW5nIGhvdyB0byBlbnVtZXJhdGUgYSBjb2xsZWN0aW9uLiBUaGVzZQogKiAgIGZvcm1hdHMgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQ6CiAqCiAqICAgKiBgdmFyaWFibGUgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIHZhcmlhYmxlIGlzIHRoZSB1c2VyIGRlZmluZWQgbG9vcCB2YXJpYWJsZSBhbmQgYGV4cHJlc3Npb25gCiAqICAgICBpcyBhIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICoKICogICAgIEZvciBleGFtcGxlOiBgYWxidW0gaW4gYXJ0aXN0LmFsYnVtc2AuCiAqCiAqICAgKiBgKGtleSwgdmFsdWUpIGluIGV4cHJlc3Npb25gIOKAkyB3aGVyZSBga2V5YCBhbmQgYHZhbHVlYCBjYW4gYmUgYW55IHVzZXIgZGVmaW5lZCBpZGVudGlmaWVycywKICogICAgIGFuZCBgZXhwcmVzc2lvbmAgaXMgdGhlIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICoKICogICAgIEZvciBleGFtcGxlOiBgKG5hbWUsIGFnZSkgaW4geydhZGFtJzoxMCwgJ2FtYWxpZSc6MTJ9YC4KICoKICogICAqIGB2YXJpYWJsZSBpbiBleHByZXNzaW9uIHRyYWNrIGJ5IHRyYWNraW5nX2V4cHJlc3Npb25gIOKAkyBZb3UgY2FuIGFsc28gcHJvdmlkZSBhbiBvcHRpb25hbCB0cmFja2luZyBmdW5jdGlvbgogKiAgICAgd2hpY2ggY2FuIGJlIHVzZWQgdG8gYXNzb2NpYXRlIHRoZSBvYmplY3RzIGluIHRoZSBjb2xsZWN0aW9uIHdpdGggdGhlIERPTSBlbGVtZW50cy4gSWYgbm8gdHJhY2tpbmcgZnVuY3Rpb24KICogICAgIGlzIHNwZWNpZmllZCB0aGUgbmctcmVwZWF0IGFzc29jaWF0ZXMgZWxlbWVudHMgYnkgaWRlbnRpdHkgaW4gdGhlIGNvbGxlY3Rpb24uIEl0IGlzIGFuIGVycm9yIHRvIGhhdmUKICogICAgIG1vcmUgdGhhbiBvbmUgdHJhY2tpbmcgZnVuY3Rpb24gdG8gcmVzb2x2ZSB0byB0aGUgc2FtZSBrZXkuIChUaGlzIHdvdWxkIG1lYW4gdGhhdCB0d28gZGlzdGluY3Qgb2JqZWN0cyBhcmUKICogICAgIG1hcHBlZCB0byB0aGUgc2FtZSBET00gZWxlbWVudCwgd2hpY2ggaXMgbm90IHBvc3NpYmxlLikgIEZpbHRlcnMgc2hvdWxkIGJlIGFwcGxpZWQgdG8gdGhlIGV4cHJlc3Npb24sCiAqICAgICBiZWZvcmUgc3BlY2lmeWluZyBhIHRyYWNraW5nIGV4cHJlc3Npb24uCiAqCiAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXNgIGlzIGVxdWl2YWxlbnQgdG8gYGl0ZW0gaW4gaXRlbXMgdHJhY2sgYnkgJGlkKGl0ZW0pYC4gVGhpcyBpbXBsaWVzIHRoYXQgdGhlIERPTSBlbGVtZW50cwogKiAgICAgd2lsbCBiZSBhc3NvY2lhdGVkIGJ5IGl0ZW0gaWRlbnRpdHkgaW4gdGhlIGFycmF5LgogKgogKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zIHRyYWNrIGJ5ICRpZChpdGVtKWAuIEEgYnVpbHQgaW4gYCRpZCgpYCBmdW5jdGlvbiBjYW4gYmUgdXNlZCB0byBhc3NpZ24gYSB1bmlxdWUKICogICAgIGAkJGhhc2hLZXlgIHByb3BlcnR5IHRvIGVhY2ggaXRlbSBpbiB0aGUgYXJyYXkuIFRoaXMgcHJvcGVydHkgaXMgdGhlbiB1c2VkIGFzIGEga2V5IHRvIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnRzCiAqICAgICB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIGl0ZW0gaW4gdGhlIGFycmF5IGJ5IGlkZW50aXR5LiBNb3ZpbmcgdGhlIHNhbWUgb2JqZWN0IGluIGFycmF5IHdvdWxkIG1vdmUgdGhlIERPTQogKiAgICAgZWxlbWVudCBpbiB0aGUgc2FtZSB3YXkgaW4gdGhlIERPTS4KICoKICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSBpdGVtLmlkYCBpcyBhIHR5cGljYWwgcGF0dGVybiB3aGVuIHRoZSBpdGVtcyBjb21lIGZyb20gdGhlIGRhdGFiYXNlLiBJbiB0aGlzCiAqICAgICBjYXNlIHRoZSBvYmplY3QgaWRlbnRpdHkgZG9lcyBub3QgbWF0dGVyLiBUd28gb2JqZWN0cyBhcmUgY29uc2lkZXJlZCBlcXVpdmFsZW50IGFzIGxvbmcgYXMgdGhlaXIgYGlkYAogKiAgICAgcHJvcGVydHkgaXMgc2FtZS4KICoKICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB8IGZpbHRlcjpzZWFyY2hUZXh0IHRyYWNrIGJ5IGl0ZW0uaWRgIGlzIGEgcGF0dGVybiB0aGF0IG1pZ2h0IGJlIHVzZWQgdG8gYXBwbHkgYSBmaWx0ZXIKICogICAgIHRvIGl0ZW1zIGluIGNvbmp1bmN0aW9uIHdpdGggYSB0cmFja2luZyBleHByZXNzaW9uLgogKgogKiAgICogYHZhcmlhYmxlIGluIGV4cHJlc3Npb24gYXMgYWxpYXNfZXhwcmVzc2lvbmAg4oCTIFlvdSBjYW4gYWxzbyBwcm92aWRlIGFuIG9wdGlvbmFsIGFsaWFzIGV4cHJlc3Npb24gd2hpY2ggd2lsbCB0aGVuIHN0b3JlIHRoZQogKiAgICAgaW50ZXJtZWRpYXRlIHJlc3VsdHMgb2YgdGhlIHJlcGVhdGVyIGFmdGVyIHRoZSBmaWx0ZXJzIGhhdmUgYmVlbiBhcHBsaWVkLiBUeXBpY2FsbHkgdGhpcyBpcyB1c2VkIHRvIHJlbmRlciBhIHNwZWNpYWwgbWVzc2FnZQogKiAgICAgd2hlbiBhIGZpbHRlciBpcyBhY3RpdmUgb24gdGhlIHJlcGVhdGVyLCBidXQgdGhlIGZpbHRlcmVkIHJlc3VsdCBzZXQgaXMgZW1wdHkuCiAqCiAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXMgfCBmaWx0ZXI6eCBhcyByZXN1bHRzYCB3aWxsIHN0b3JlIHRoZSBmcmFnbWVudCBvZiB0aGUgcmVwZWF0ZWQgaXRlbXMgYXMgYHJlc3VsdHNgLCBidXQgb25seSBhZnRlcgogKiAgICAgdGhlIGl0ZW1zIGhhdmUgYmVlbiBwcm9jZXNzZWQgdGhyb3VnaCB0aGUgZmlsdGVyLgogKgogKiBAZXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgaW5pdGlhbGl6ZXMgdGhlIHNjb3BlIHRvIGEgbGlzdCBvZiBuYW1lcyBhbmQKICogdGhlbiB1c2VzIGBuZ1JlcGVhdGAgdG8gZGlzcGxheSBldmVyeSBwZXJzb246CiAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGRpdiBuZy1pbml0PSJmcmllbmRzID0gWwogICAgICAgIHtuYW1lOidKb2huJywgYWdlOjI1LCBnZW5kZXI6J2JveSd9LAogICAgICAgIHtuYW1lOidKZXNzaWUnLCBhZ2U6MzAsIGdlbmRlcjonZ2lybCd9LAogICAgICAgIHtuYW1lOidKb2hhbm5hJywgYWdlOjI4LCBnZW5kZXI6J2dpcmwnfSwKICAgICAgICB7bmFtZTonSm95JywgYWdlOjE1LCBnZW5kZXI6J2dpcmwnfSwKICAgICAgICB7bmFtZTonTWFyeScsIGFnZToyOCwgZ2VuZGVyOidnaXJsJ30sCiAgICAgICAge25hbWU6J1BldGVyJywgYWdlOjk1LCBnZW5kZXI6J2JveSd9LAogICAgICAgIHtuYW1lOidTZWJhc3RpYW4nLCBhZ2U6NTAsIGdlbmRlcjonYm95J30sCiAgICAgICAge25hbWU6J0VyaWthJywgYWdlOjI3LCBnZW5kZXI6J2dpcmwnfSwKICAgICAgICB7bmFtZTonUGF0cmljaycsIGFnZTo0MCwgZ2VuZGVyOidib3knfSwKICAgICAgICB7bmFtZTonU2FtYW50aGEnLCBhZ2U6NjAsIGdlbmRlcjonZ2lybCd9CiAgICAgIF0iPgogICAgICAgIEkgaGF2ZSB7e2ZyaWVuZHMubGVuZ3RofX0gZnJpZW5kcy4gVGhleSBhcmU6CiAgICAgICAgPGlucHV0IHR5cGU9InNlYXJjaCIgbmctbW9kZWw9InEiIHBsYWNlaG9sZGVyPSJmaWx0ZXIgZnJpZW5kcy4uLiIgLz4KICAgICAgICA8dWwgY2xhc3M9ImV4YW1wbGUtYW5pbWF0ZS1jb250YWluZXIiPgogICAgICAgICAgPGxpIGNsYXNzPSJhbmltYXRlLXJlcGVhdCIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpxIGFzIHJlc3VsdHMiPgogICAgICAgICAgICBbe3skaW5kZXggKyAxfX1dIHt7ZnJpZW5kLm5hbWV9fSB3aG8gaXMge3tmcmllbmQuYWdlfX0geWVhcnMgb2xkLgogICAgICAgICAgPC9saT4KICAgICAgICAgIDxsaSBjbGFzcz0iYW5pbWF0ZS1yZXBlYXQiIG5nLWlmPSJyZXN1bHRzLmxlbmd0aCA9PSAwIj4KICAgICAgICAgICAgPHN0cm9uZz5ObyByZXN1bHRzIGZvdW5kLi4uPC9zdHJvbmc+CiAgICAgICAgICA8L2xpPgogICAgICAgIDwvdWw+CiAgICAgIDwvZGl2PgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAgICAuZXhhbXBsZS1hbmltYXRlLWNvbnRhaW5lciB7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGxpc3Qtc3R5bGU6bm9uZTsKICAgICAgICBtYXJnaW46MDsKICAgICAgICBwYWRkaW5nOjAgMTBweDsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtcmVwZWF0IHsKICAgICAgICBsaW5lLWhlaWdodDo0MHB4OwogICAgICAgIGxpc3Qtc3R5bGU6bm9uZTsKICAgICAgICBib3gtc2l6aW5nOmJvcmRlci1ib3g7CiAgICAgIH0KCiAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1tb3ZlLAogICAgICAuYW5pbWF0ZS1yZXBlYXQubmctZW50ZXIsCiAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1sZWF2ZSB7CiAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICB0cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWxlYXZlLm5nLWxlYXZlLWFjdGl2ZSwKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLW1vdmUsCiAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1lbnRlciB7CiAgICAgICAgb3BhY2l0eTowOwogICAgICAgIG1heC1oZWlnaHQ6MDsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWxlYXZlLAogICAgICAuYW5pbWF0ZS1yZXBlYXQubmctbW92ZS5uZy1tb3ZlLWFjdGl2ZSwKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7CiAgICAgICAgb3BhY2l0eToxOwogICAgICAgIG1heC1oZWlnaHQ6NDBweDsKICAgICAgfQogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgIHZhciBmcmllbmRzID0gZWxlbWVudC5hbGwoYnkucmVwZWF0ZXIoJ2ZyaWVuZCBpbiBmcmllbmRzJykpOwoKICAgICAgaXQoJ3Nob3VsZCByZW5kZXIgaW5pdGlhbCBkYXRhIHNldCcsIGZ1bmN0aW9uKCkgewogICAgICAgIGV4cGVjdChmcmllbmRzLmNvdW50KCkpLnRvQmUoMTApOwogICAgICAgIGV4cGVjdChmcmllbmRzLmdldCgwKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1sxXSBKb2huIHdobyBpcyAyNSB5ZWFycyBvbGQuJyk7CiAgICAgICAgZXhwZWN0KGZyaWVuZHMuZ2V0KDEpLmdldFRleHQoKSkudG9FcXVhbCgnWzJdIEplc3NpZSB3aG8gaXMgMzAgeWVhcnMgb2xkLicpOwogICAgICAgIGV4cGVjdChmcmllbmRzLmxhc3QoKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1sxMF0gU2FtYW50aGEgd2hvIGlzIDYwIHllYXJzIG9sZC4nKTsKICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdmcmllbmRzLmxlbmd0aCcpKS5nZXRUZXh0KCkpCiAgICAgICAgICAgIC50b01hdGNoKCJJIGhhdmUgMTAgZnJpZW5kcy4gVGhleSBhcmU6Iik7CiAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgdXBkYXRlIHJlcGVhdGVyIHdoZW4gZmlsdGVyIHByZWRpY2F0ZSBjaGFuZ2VzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChmcmllbmRzLmNvdW50KCkpLnRvQmUoMTApOwoKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgncScpKS5zZW5kS2V5cygnbWEnKTsKCiAgICAgICAgIGV4cGVjdChmcmllbmRzLmNvdW50KCkpLnRvQmUoMik7CiAgICAgICAgIGV4cGVjdChmcmllbmRzLmdldCgwKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1sxXSBNYXJ5IHdobyBpcyAyOCB5ZWFycyBvbGQuJyk7CiAgICAgICAgIGV4cGVjdChmcmllbmRzLmxhc3QoKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1syXSBTYW1hbnRoYSB3aG8gaXMgNjAgeWVhcnMgb2xkLicpOwogICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICovCnZhciBuZ1JlcGVhdERpcmVjdGl2ZSA9IFsnJHBhcnNlJywgJyRhbmltYXRlJywgZnVuY3Rpb24oJHBhcnNlLCAkYW5pbWF0ZSkgewogIHZhciBOR19SRU1PVkVEID0gJyQkTkdfUkVNT1ZFRCc7CiAgdmFyIG5nUmVwZWF0TWluRXJyID0gbWluRXJyKCduZ1JlcGVhdCcpOwoKICB2YXIgdXBkYXRlU2NvcGUgPSBmdW5jdGlvbihzY29wZSwgaW5kZXgsIHZhbHVlSWRlbnRpZmllciwgdmFsdWUsIGtleUlkZW50aWZpZXIsIGtleSwgYXJyYXlMZW5ndGgpIHsKICAgIC8vIFRPRE8ocGVyZik6IGdlbmVyYXRlIHNldHRlcnMgdG8gc2hhdmUgb2ZmIH40MG1zIG9yIDEtMS41JQogICAgc2NvcGVbdmFsdWVJZGVudGlmaWVyXSA9IHZhbHVlOwogICAgaWYgKGtleUlkZW50aWZpZXIpIHNjb3BlW2tleUlkZW50aWZpZXJdID0ga2V5OwogICAgc2NvcGUuJGluZGV4ID0gaW5kZXg7CiAgICBzY29wZS4kZmlyc3QgPSAoaW5kZXggPT09IDApOwogICAgc2NvcGUuJGxhc3QgPSAoaW5kZXggPT09IChhcnJheUxlbmd0aCAtIDEpKTsKICAgIHNjb3BlLiRtaWRkbGUgPSAhKHNjb3BlLiRmaXJzdCB8fCBzY29wZS4kbGFzdCk7CiAgICAvLyBqc2hpbnQgYml0d2lzZTogZmFsc2UKICAgIHNjb3BlLiRvZGQgPSAhKHNjb3BlLiRldmVuID0gKGluZGV4JjEpID09PSAwKTsKICAgIC8vIGpzaGludCBiaXR3aXNlOiB0cnVlCiAgfTsKCiAgdmFyIGdldEJsb2NrU3RhcnQgPSBmdW5jdGlvbihibG9jaykgewogICAgcmV0dXJuIGJsb2NrLmNsb25lWzBdOwogIH07CgogIHZhciBnZXRCbG9ja0VuZCA9IGZ1bmN0aW9uKGJsb2NrKSB7CiAgICByZXR1cm4gYmxvY2suY2xvbmVbYmxvY2suY2xvbmUubGVuZ3RoIC0gMV07CiAgfTsKCgogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgbXVsdGlFbGVtZW50OiB0cnVlLAogICAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogICAgcHJpb3JpdHk6IDEwMDAsCiAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICQkdGxiOiB0cnVlLAogICAgY29tcGlsZTogZnVuY3Rpb24gbmdSZXBlYXRDb21waWxlKCRlbGVtZW50LCAkYXR0cikgewogICAgICB2YXIgZXhwcmVzc2lvbiA9ICRhdHRyLm5nUmVwZWF0OwogICAgICB2YXIgbmdSZXBlYXRFbmRDb21tZW50ID0gZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgnIGVuZCBuZ1JlcGVhdDogJyArIGV4cHJlc3Npb24gKyAnICcpOwoKICAgICAgdmFyIG1hdGNoID0gZXhwcmVzc2lvbi5tYXRjaCgvXlxzKihbXHNcU10rPylccytpblxzKyhbXHNcU10rPykoPzpccythc1xzKyhbXHNcU10rPykpPyg/OlxzK3RyYWNrXHMrYnlccysoW1xzXFNdKz8pKT9ccyokLyk7CgogICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgdGhyb3cgbmdSZXBlYXRNaW5FcnIoJ2lleHAnLCAiRXhwZWN0ZWQgZXhwcmVzc2lvbiBpbiBmb3JtIG9mICdfaXRlbV8gaW4gX2NvbGxlY3Rpb25fWyB0cmFjayBieSBfaWRfXScgYnV0IGdvdCAnezB9Jy4iLAogICAgICAgICAgICBleHByZXNzaW9uKTsKICAgICAgfQoKICAgICAgdmFyIGxocyA9IG1hdGNoWzFdOwogICAgICB2YXIgcmhzID0gbWF0Y2hbMl07CiAgICAgIHZhciBhbGlhc0FzID0gbWF0Y2hbM107CiAgICAgIHZhciB0cmFja0J5RXhwID0gbWF0Y2hbNF07CgogICAgICBtYXRjaCA9IGxocy5tYXRjaCgvXig/OihbXCRcd10rKXxcKChbXCRcd10rKVxzKixccyooW1wkXHddKylcKSkkLyk7CgogICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgdGhyb3cgbmdSZXBlYXRNaW5FcnIoJ2lpZGV4cCcsICInX2l0ZW1fJyBpbiAnX2l0ZW1fIGluIF9jb2xsZWN0aW9uXycgc2hvdWxkIGJlIGFuIGlkZW50aWZpZXIgb3IgJyhfa2V5XywgX3ZhbHVlXyknIGV4cHJlc3Npb24sIGJ1dCBnb3QgJ3swfScuIiwKICAgICAgICAgICAgbGhzKTsKICAgICAgfQogICAgICB2YXIgdmFsdWVJZGVudGlmaWVyID0gbWF0Y2hbM10gfHwgbWF0Y2hbMV07CiAgICAgIHZhciBrZXlJZGVudGlmaWVyID0gbWF0Y2hbMl07CgogICAgICBpZiAoYWxpYXNBcyAmJiAoIS9eWyRhLXpBLVpfXVskYS16QS1aMC05X10qJC8udGVzdChhbGlhc0FzKSB8fAogICAgICAgICAgL14obnVsbHx1bmRlZmluZWR8dGhpc3xcJGluZGV4fFwkZmlyc3R8XCRtaWRkbGV8XCRsYXN0fFwkZXZlbnxcJG9kZHxcJHBhcmVudCkkLy50ZXN0KGFsaWFzQXMpKSkgewogICAgICAgIHRocm93IG5nUmVwZWF0TWluRXJyKCdiYWRpZGVudCcsICJhbGlhcyAnezB9JyBpcyBpbnZhbGlkIC0tLSBtdXN0IGJlIGEgdmFsaWQgSlMgaWRlbnRpZmllciB3aGljaCBpcyBub3QgYSByZXNlcnZlZCBuYW1lLiIsCiAgICAgICAgICBhbGlhc0FzKTsKICAgICAgfQoKICAgICAgdmFyIHRyYWNrQnlFeHBHZXR0ZXIsIHRyYWNrQnlJZEV4cEZuLCB0cmFja0J5SWRBcnJheUZuLCB0cmFja0J5SWRPYmpGbjsKICAgICAgdmFyIGhhc2hGbkxvY2FscyA9IHskaWQ6IGhhc2hLZXl9OwoKICAgICAgaWYgKHRyYWNrQnlFeHApIHsKICAgICAgICB0cmFja0J5RXhwR2V0dGVyID0gJHBhcnNlKHRyYWNrQnlFeHApOwogICAgICB9IGVsc2UgewogICAgICAgIHRyYWNrQnlJZEFycmF5Rm4gPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgcmV0dXJuIGhhc2hLZXkodmFsdWUpOwogICAgICAgIH07CiAgICAgICAgdHJhY2tCeUlkT2JqRm4gPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJldHVybiBmdW5jdGlvbiBuZ1JlcGVhdExpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmwsICR0cmFuc2NsdWRlKSB7CgogICAgICAgIGlmICh0cmFja0J5RXhwR2V0dGVyKSB7CiAgICAgICAgICB0cmFja0J5SWRFeHBGbiA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgIC8vIGFzc2lnbiBrZXksIHZhbHVlLCBhbmQgJGluZGV4IHRvIHRoZSBsb2NhbHMgc28gdGhhdCB0aGV5IGNhbiBiZSB1c2VkIGluIGhhc2ggZnVuY3Rpb25zCiAgICAgICAgICAgIGlmIChrZXlJZGVudGlmaWVyKSBoYXNoRm5Mb2NhbHNba2V5SWRlbnRpZmllcl0gPSBrZXk7CiAgICAgICAgICAgIGhhc2hGbkxvY2Fsc1t2YWx1ZUlkZW50aWZpZXJdID0gdmFsdWU7CiAgICAgICAgICAgIGhhc2hGbkxvY2Fscy4kaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgcmV0dXJuIHRyYWNrQnlFeHBHZXR0ZXIoJHNjb3BlLCBoYXNoRm5Mb2NhbHMpOwogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIC8vIFN0b3JlIGEgbGlzdCBvZiBlbGVtZW50cyBmcm9tIHByZXZpb3VzIHJ1bi4gVGhpcyBpcyBhIGhhc2ggd2hlcmUga2V5IGlzIHRoZSBpdGVtIGZyb20gdGhlCiAgICAgICAgLy8gaXRlcmF0b3IsIGFuZCB0aGUgdmFsdWUgaXMgb2JqZWN0cyB3aXRoIGZvbGxvd2luZyBwcm9wZXJ0aWVzLgogICAgICAgIC8vICAgLSBzY29wZTogYm91bmQgc2NvcGUKICAgICAgICAvLyAgIC0gZWxlbWVudDogcHJldmlvdXMgZWxlbWVudC4KICAgICAgICAvLyAgIC0gaW5kZXg6IHBvc2l0aW9uCiAgICAgICAgLy8KICAgICAgICAvLyBXZSBhcmUgdXNpbmcgbm8tcHJvdG8gb2JqZWN0IHNvIHRoYXQgd2UgZG9uJ3QgbmVlZCB0byBndWFyZCBhZ2FpbnN0IGluaGVyaXRlZCBwcm9wcyB2aWEKICAgICAgICAvLyBoYXNPd25Qcm9wZXJ0eS4KICAgICAgICB2YXIgbGFzdEJsb2NrTWFwID0gY3JlYXRlTWFwKCk7CgogICAgICAgIC8vd2F0Y2ggcHJvcHMKICAgICAgICAkc2NvcGUuJHdhdGNoQ29sbGVjdGlvbihyaHMsIGZ1bmN0aW9uIG5nUmVwZWF0QWN0aW9uKGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHZhciBpbmRleCwgbGVuZ3RoLAogICAgICAgICAgICAgIHByZXZpb3VzTm9kZSA9ICRlbGVtZW50WzBdLCAgICAgLy8gbm9kZSB0aGF0IGNsb25lZCBub2RlcyBzaG91bGQgYmUgaW5zZXJ0ZWQgYWZ0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluaXRpYWxpemVkIHRvIHRoZSBjb21tZW50IG5vZGUgYW5jaG9yCiAgICAgICAgICAgICAgbmV4dE5vZGUsCiAgICAgICAgICAgICAgLy8gU2FtZSBhcyBsYXN0QmxvY2tNYXAgYnV0IGl0IGhhcyB0aGUgY3VycmVudCBzdGF0ZS4gSXQgd2lsbCBiZWNvbWUgdGhlCiAgICAgICAgICAgICAgLy8gbGFzdEJsb2NrTWFwIG9uIHRoZSBuZXh0IGl0ZXJhdGlvbi4KICAgICAgICAgICAgICBuZXh0QmxvY2tNYXAgPSBjcmVhdGVNYXAoKSwKICAgICAgICAgICAgICBjb2xsZWN0aW9uTGVuZ3RoLAogICAgICAgICAgICAgIGtleSwgdmFsdWUsIC8vIGtleS92YWx1ZSBvZiBpdGVyYXRpb24KICAgICAgICAgICAgICB0cmFja0J5SWQsCiAgICAgICAgICAgICAgdHJhY2tCeUlkRm4sCiAgICAgICAgICAgICAgY29sbGVjdGlvbktleXMsCiAgICAgICAgICAgICAgYmxvY2ssICAgICAgIC8vIGxhc3Qgb2JqZWN0IGluZm9ybWF0aW9uIHtzY29wZSwgZWxlbWVudCwgaWR9CiAgICAgICAgICAgICAgbmV4dEJsb2NrT3JkZXIsCiAgICAgICAgICAgICAgZWxlbWVudHNUb1JlbW92ZTsKCiAgICAgICAgICBpZiAoYWxpYXNBcykgewogICAgICAgICAgICAkc2NvcGVbYWxpYXNBc10gPSBjb2xsZWN0aW9uOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChpc0FycmF5TGlrZShjb2xsZWN0aW9uKSkgewogICAgICAgICAgICBjb2xsZWN0aW9uS2V5cyA9IGNvbGxlY3Rpb247CiAgICAgICAgICAgIHRyYWNrQnlJZEZuID0gdHJhY2tCeUlkRXhwRm4gfHwgdHJhY2tCeUlkQXJyYXlGbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRyYWNrQnlJZEZuID0gdHJhY2tCeUlkRXhwRm4gfHwgdHJhY2tCeUlkT2JqRm47CiAgICAgICAgICAgIC8vIGlmIG9iamVjdCwgZXh0cmFjdCBrZXlzLCBzb3J0IHRoZW0gYW5kIHVzZSB0byBkZXRlcm1pbmUgb3JkZXIgb2YgaXRlcmF0aW9uIG92ZXIgb2JqIHByb3BzCiAgICAgICAgICAgIGNvbGxlY3Rpb25LZXlzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGl0ZW1LZXkgaW4gY29sbGVjdGlvbikgewogICAgICAgICAgICAgIGlmIChjb2xsZWN0aW9uLmhhc093blByb3BlcnR5KGl0ZW1LZXkpICYmIGl0ZW1LZXkuY2hhckF0KDApICE9ICckJykgewogICAgICAgICAgICAgICAgY29sbGVjdGlvbktleXMucHVzaChpdGVtS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29sbGVjdGlvbktleXMuc29ydCgpOwogICAgICAgICAgfQoKICAgICAgICAgIGNvbGxlY3Rpb25MZW5ndGggPSBjb2xsZWN0aW9uS2V5cy5sZW5ndGg7CiAgICAgICAgICBuZXh0QmxvY2tPcmRlciA9IG5ldyBBcnJheShjb2xsZWN0aW9uTGVuZ3RoKTsKCiAgICAgICAgICAvLyBsb2NhdGUgZXhpc3RpbmcgaXRlbXMKICAgICAgICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGNvbGxlY3Rpb25MZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAga2V5ID0gKGNvbGxlY3Rpb24gPT09IGNvbGxlY3Rpb25LZXlzKSA/IGluZGV4IDogY29sbGVjdGlvbktleXNbaW5kZXhdOwogICAgICAgICAgICB2YWx1ZSA9IGNvbGxlY3Rpb25ba2V5XTsKICAgICAgICAgICAgdHJhY2tCeUlkID0gdHJhY2tCeUlkRm4oa2V5LCB2YWx1ZSwgaW5kZXgpOwogICAgICAgICAgICBpZiAobGFzdEJsb2NrTWFwW3RyYWNrQnlJZF0pIHsKICAgICAgICAgICAgICAvLyBmb3VuZCBwcmV2aW91c2x5IHNlZW4gYmxvY2sKICAgICAgICAgICAgICBibG9jayA9IGxhc3RCbG9ja01hcFt0cmFja0J5SWRdOwogICAgICAgICAgICAgIGRlbGV0ZSBsYXN0QmxvY2tNYXBbdHJhY2tCeUlkXTsKICAgICAgICAgICAgICBuZXh0QmxvY2tNYXBbdHJhY2tCeUlkXSA9IGJsb2NrOwogICAgICAgICAgICAgIG5leHRCbG9ja09yZGVyW2luZGV4XSA9IGJsb2NrOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRCbG9ja01hcFt0cmFja0J5SWRdKSB7CiAgICAgICAgICAgICAgLy8gaWYgY29sbGlzaW9uIGRldGVjdGVkLiByZXN0b3JlIGxhc3RCbG9ja01hcCBhbmQgdGhyb3cgYW4gZXJyb3IKICAgICAgICAgICAgICBmb3JFYWNoKG5leHRCbG9ja09yZGVyLCBmdW5jdGlvbiAoYmxvY2spIHsKICAgICAgICAgICAgICAgIGlmIChibG9jayAmJiBibG9jay5zY29wZSkgbGFzdEJsb2NrTWFwW2Jsb2NrLmlkXSA9IGJsb2NrOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHRocm93IG5nUmVwZWF0TWluRXJyKCdkdXBlcycsCiAgICAgICAgICAgICAgICAgICJEdXBsaWNhdGVzIGluIGEgcmVwZWF0ZXIgYXJlIG5vdCBhbGxvd2VkLiBVc2UgJ3RyYWNrIGJ5JyBleHByZXNzaW9uIHRvIHNwZWNpZnkgdW5pcXVlIGtleXMuIFJlcGVhdGVyOiB7MH0sIER1cGxpY2F0ZSBrZXk6IHsxfSwgRHVwbGljYXRlIHZhbHVlOiB7Mn0iLAogICAgICAgICAgICAgICAgICBleHByZXNzaW9uLCB0cmFja0J5SWQsIHRvSnNvbih2YWx1ZSkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIG5ldyBuZXZlciBiZWZvcmUgc2VlbiBibG9jawogICAgICAgICAgICAgIG5leHRCbG9ja09yZGVyW2luZGV4XSA9IHtpZDogdHJhY2tCeUlkLCBzY29wZTogdW5kZWZpbmVkLCBjbG9uZTogdW5kZWZpbmVkfTsKICAgICAgICAgICAgICBuZXh0QmxvY2tNYXBbdHJhY2tCeUlkXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyByZW1vdmUgbGVmdG92ZXIgaXRlbXMKICAgICAgICAgIGZvciAodmFyIGJsb2NrS2V5IGluIGxhc3RCbG9ja01hcCkgewogICAgICAgICAgICBibG9jayA9IGxhc3RCbG9ja01hcFtibG9ja0tleV07CiAgICAgICAgICAgIGVsZW1lbnRzVG9SZW1vdmUgPSBnZXRCbG9ja05vZGVzKGJsb2NrLmNsb25lKTsKICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoZWxlbWVudHNUb1JlbW92ZSk7CiAgICAgICAgICAgIGlmIChlbGVtZW50c1RvUmVtb3ZlWzBdLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAvLyBpZiB0aGUgZWxlbWVudCB3YXMgbm90IHJlbW92ZWQgeWV0IGJlY2F1c2Ugb2YgcGVuZGluZyBhbmltYXRpb24sIG1hcmsgaXQgYXMgZGVsZXRlZAogICAgICAgICAgICAgIC8vIHNvIHRoYXQgd2UgY2FuIGlnbm9yZSBpdCBsYXRlcgogICAgICAgICAgICAgIGZvciAoaW5kZXggPSAwLCBsZW5ndGggPSBlbGVtZW50c1RvUmVtb3ZlLmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgIGVsZW1lbnRzVG9SZW1vdmVbaW5kZXhdW05HX1JFTU9WRURdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYmxvY2suc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyB3ZSBhcmUgbm90IHVzaW5nIGZvckVhY2ggZm9yIHBlcmYgcmVhc29ucyAodHJ5aW5nIHRvIGF2b2lkICNjYWxsKQogICAgICAgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgY29sbGVjdGlvbkxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICBrZXkgPSAoY29sbGVjdGlvbiA9PT0gY29sbGVjdGlvbktleXMpID8gaW5kZXggOiBjb2xsZWN0aW9uS2V5c1tpbmRleF07CiAgICAgICAgICAgIHZhbHVlID0gY29sbGVjdGlvbltrZXldOwogICAgICAgICAgICBibG9jayA9IG5leHRCbG9ja09yZGVyW2luZGV4XTsKCiAgICAgICAgICAgIGlmIChibG9jay5zY29wZSkgewogICAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgYWxyZWFkeSBzZWVuIHRoaXMgb2JqZWN0LCB0aGVuIHdlIG5lZWQgdG8gcmV1c2UgdGhlCiAgICAgICAgICAgICAgLy8gYXNzb2NpYXRlZCBzY29wZS9lbGVtZW50CgogICAgICAgICAgICAgIG5leHROb2RlID0gcHJldmlvdXNOb2RlOwoKICAgICAgICAgICAgICAvLyBza2lwIG5vZGVzIHRoYXQgYXJlIGFscmVhZHkgcGVuZGluZyByZW1vdmFsIHZpYSBsZWF2ZSBhbmltYXRpb24KICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBuZXh0Tm9kZSA9IG5leHROb2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgIH0gd2hpbGUgKG5leHROb2RlICYmIG5leHROb2RlW05HX1JFTU9WRURdKTsKCiAgICAgICAgICAgICAgaWYgKGdldEJsb2NrU3RhcnQoYmxvY2spICE9IG5leHROb2RlKSB7CiAgICAgICAgICAgICAgICAvLyBleGlzdGluZyBpdGVtIHdoaWNoIGdvdCBtb3ZlZAogICAgICAgICAgICAgICAgJGFuaW1hdGUubW92ZShnZXRCbG9ja05vZGVzKGJsb2NrLmNsb25lKSwgbnVsbCwganFMaXRlKHByZXZpb3VzTm9kZSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c05vZGUgPSBnZXRCbG9ja0VuZChibG9jayk7CiAgICAgICAgICAgICAgdXBkYXRlU2NvcGUoYmxvY2suc2NvcGUsIGluZGV4LCB2YWx1ZUlkZW50aWZpZXIsIHZhbHVlLCBrZXlJZGVudGlmaWVyLCBrZXksIGNvbGxlY3Rpb25MZW5ndGgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIG5ldyBpdGVtIHdoaWNoIHdlIGRvbid0IGtub3cgYWJvdXQKICAgICAgICAgICAgICAkdHJhbnNjbHVkZShmdW5jdGlvbiBuZ1JlcGVhdFRyYW5zY2x1ZGUoY2xvbmUsIHNjb3BlKSB7CiAgICAgICAgICAgICAgICBibG9jay5zY29wZSA9IHNjb3BlOwogICAgICAgICAgICAgICAgLy8gaHR0cDovL2pzcGVyZi5jb20vY2xvbmUtdnMtY3JlYXRlY29tbWVudAogICAgICAgICAgICAgICAgdmFyIGVuZE5vZGUgPSBuZ1JlcGVhdEVuZENvbW1lbnQuY2xvbmVOb2RlKGZhbHNlKTsKICAgICAgICAgICAgICAgIGNsb25lW2Nsb25lLmxlbmd0aCsrXSA9IGVuZE5vZGU7CgogICAgICAgICAgICAgICAgLy8gVE9ETyhwZXJmKTogc3VwcG9ydCBuYWtlZCBwcmV2aW91c05vZGUgaW4gYGVudGVyYCB0byBhdm9pZCBjcmVhdGlvbiBvZiBqcUxpdGUgd3JhcHBlcj8KICAgICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGNsb25lLCBudWxsLCBqcUxpdGUocHJldmlvdXNOb2RlKSk7CiAgICAgICAgICAgICAgICBwcmV2aW91c05vZGUgPSBlbmROb2RlOwogICAgICAgICAgICAgICAgLy8gTm90ZTogV2Ugb25seSBuZWVkIHRoZSBmaXJzdC9sYXN0IG5vZGUgb2YgdGhlIGNsb25lZCBub2Rlcy4KICAgICAgICAgICAgICAgIC8vIEhvd2V2ZXIsIHdlIG5lZWQgdG8ga2VlcCB0aGUgcmVmZXJlbmNlIHRvIHRoZSBqcWxpdGUgd3JhcHBlciBhcyBpdCBtaWdodCBiZSBjaGFuZ2VkIGxhdGVyCiAgICAgICAgICAgICAgICAvLyBieSBhIGRpcmVjdGl2ZSB3aXRoIHRlbXBsYXRlVXJsIHdoZW4gaXRzIHRlbXBsYXRlIGFycml2ZXMuCiAgICAgICAgICAgICAgICBibG9jay5jbG9uZSA9IGNsb25lOwogICAgICAgICAgICAgICAgbmV4dEJsb2NrTWFwW2Jsb2NrLmlkXSA9IGJsb2NrOwogICAgICAgICAgICAgICAgdXBkYXRlU2NvcGUoYmxvY2suc2NvcGUsIGluZGV4LCB2YWx1ZUlkZW50aWZpZXIsIHZhbHVlLCBrZXlJZGVudGlmaWVyLCBrZXksIGNvbGxlY3Rpb25MZW5ndGgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBsYXN0QmxvY2tNYXAgPSBuZXh0QmxvY2tNYXA7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9CiAgfTsKfV07Cgp2YXIgTkdfSElERV9DTEFTUyA9ICduZy1oaWRlJzsKdmFyIE5HX0hJREVfSU5fUFJPR1JFU1NfQ0xBU1MgPSAnbmctaGlkZS1hbmltYXRlJzsKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdTaG93CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nU2hvd2AgZGlyZWN0aXZlIHNob3dzIG9yIGhpZGVzIHRoZSBnaXZlbiBIVE1MIGVsZW1lbnQgYmFzZWQgb24gdGhlIGV4cHJlc3Npb24KICogcHJvdmlkZWQgdG8gdGhlIGBuZ1Nob3dgIGF0dHJpYnV0ZS4gVGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIGJ5IHJlbW92aW5nIG9yIGFkZGluZwogKiB0aGUgYC5uZy1oaWRlYCBDU1MgY2xhc3Mgb250byB0aGUgZWxlbWVudC4gVGhlIGAubmctaGlkZWAgQ1NTIGNsYXNzIGlzIHByZWRlZmluZWQKICogaW4gQW5ndWxhckpTIGFuZCBzZXRzIHRoZSBkaXNwbGF5IHN0eWxlIHRvIG5vbmUgKHVzaW5nIGFuICFpbXBvcnRhbnQgZmxhZykuCiAqIEZvciBDU1AgbW9kZSBwbGVhc2UgYWRkIGBhbmd1bGFyLWNzcC5jc3NgIHRvIHlvdXIgaHRtbCBmaWxlIChzZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NzcCBuZ0NzcH0pLgogKgogKiBgYGBodG1sCiAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyB0cnV0aHkgKGVsZW1lbnQgaXMgdmlzaWJsZSkgLS0+CiAqIDxkaXYgbmctc2hvdz0ibXlWYWx1ZSI+PC9kaXY+CiAqCiAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyBmYWxzeSAoZWxlbWVudCBpcyBoaWRkZW4pIC0tPgogKiA8ZGl2IG5nLXNob3c9Im15VmFsdWUiIGNsYXNzPSJuZy1oaWRlIj48L2Rpdj4KICogYGBgCiAqCiAqIFdoZW4gdGhlIGBuZ1Nob3dgIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgZmFsc3kgdmFsdWUgdGhlbiB0aGUgYC5uZy1oaWRlYCBDU1MgY2xhc3MgaXMgYWRkZWQgdG8gdGhlIGNsYXNzCiAqIGF0dHJpYnV0ZSBvbiB0aGUgZWxlbWVudCBjYXVzaW5nIGl0IHRvIGJlY29tZSBoaWRkZW4uIFdoZW4gdHJ1dGh5LCB0aGUgYC5uZy1oaWRlYCBDU1MgY2xhc3MgaXMgcmVtb3ZlZAogKiBmcm9tIHRoZSBlbGVtZW50IGNhdXNpbmcgdGhlIGVsZW1lbnQgbm90IHRvIGFwcGVhciBoaWRkZW4uCiAqCiAqICMjIFdoeSBpcyAhaW1wb3J0YW50IHVzZWQ/CiAqCiAqIFlvdSBtYXkgYmUgd29uZGVyaW5nIHdoeSAhaW1wb3J0YW50IGlzIHVzZWQgZm9yIHRoZSBgLm5nLWhpZGVgIENTUyBjbGFzcy4gVGhpcyBpcyBiZWNhdXNlIHRoZSBgLm5nLWhpZGVgIHNlbGVjdG9yCiAqIGNhbiBiZSBlYXNpbHkgb3ZlcnJpZGRlbiBieSBoZWF2aWVyIHNlbGVjdG9ycy4gRm9yIGV4YW1wbGUsIHNvbWV0aGluZyBhcyBzaW1wbGUKICogYXMgY2hhbmdpbmcgdGhlIGRpc3BsYXkgc3R5bGUgb24gYSBIVE1MIGxpc3QgaXRlbSB3b3VsZCBtYWtlIGhpZGRlbiBlbGVtZW50cyBhcHBlYXIgdmlzaWJsZS4KICogVGhpcyBhbHNvIGJlY29tZXMgYSBiaWdnZXIgaXNzdWUgd2hlbiBkZWFsaW5nIHdpdGggQ1NTIGZyYW1ld29ya3MuCiAqCiAqIEJ5IHVzaW5nICFpbXBvcnRhbnQsIHRoZSBzaG93IGFuZCBoaWRlIGJlaGF2aW9yIHdpbGwgd29yayBhcyBleHBlY3RlZCBkZXNwaXRlIGFueSBjbGFzaCBiZXR3ZWVuIENTUyBzZWxlY3RvcgogKiBzcGVjaWZpY2l0eSAod2hlbiAhaW1wb3J0YW50IGlzbid0IHVzZWQgd2l0aCBhbnkgY29uZmxpY3Rpbmcgc3R5bGVzKS4gSWYgYSBkZXZlbG9wZXIgY2hvb3NlcyB0byBvdmVycmlkZSB0aGUKICogc3R5bGluZyB0byBjaGFuZ2UgaG93IHRvIGhpZGUgYW4gZWxlbWVudCB0aGVuIGl0IGlzIGp1c3QgYSBtYXR0ZXIgb2YgdXNpbmcgIWltcG9ydGFudCBpbiB0aGVpciBvd24gQ1NTIGNvZGUuCiAqCiAqICMjIyBPdmVycmlkaW5nIGAubmctaGlkZWAKICoKICogQnkgZGVmYXVsdCwgdGhlIGAubmctaGlkZWAgY2xhc3Mgd2lsbCBzdHlsZSB0aGUgZWxlbWVudCB3aXRoIGBkaXNwbGF5Om5vbmUhaW1wb3J0YW50YC4gSWYgeW91IHdpc2ggdG8gY2hhbmdlCiAqIHRoZSBoaWRlIGJlaGF2aW9yIHdpdGggbmdTaG93L25nSGlkZSB0aGVuIHRoaXMgY2FuIGJlIGFjaGlldmVkIGJ5IHJlc3RhdGluZyB0aGUgc3R5bGVzIGZvciB0aGUgYC5uZy1oaWRlYAogKiBjbGFzcyBpbiBDU1M6CiAqCiAqIGBgYGNzcwogKiAubmctaGlkZSB7CiAqICAgLyYjNDI7IHRoaXMgaXMganVzdCBhbm90aGVyIGZvcm0gb2YgaGlkaW5nIGFuIGVsZW1lbnQgJiM0MjsvCiAqICAgZGlzcGxheTpibG9jayFpbXBvcnRhbnQ7CiAqICAgcG9zaXRpb246YWJzb2x1dGU7CiAqICAgdG9wOi05OTk5cHg7CiAqICAgbGVmdDotOTk5OXB4OwogKiB9CiAqIGBgYAogKgogKiBCeSBkZWZhdWx0IHlvdSBkb24ndCBuZWVkIHRvIG92ZXJyaWRlIGluIENTUyBhbnl0aGluZyBhbmQgdGhlIGFuaW1hdGlvbnMgd2lsbCB3b3JrIGFyb3VuZCB0aGUgZGlzcGxheSBzdHlsZS4KICoKICogIyMgQSBub3RlIGFib3V0IGFuaW1hdGlvbnMgd2l0aCBgbmdTaG93YAogKgogKiBBbmltYXRpb25zIGluIG5nU2hvdy9uZ0hpZGUgd29yayB3aXRoIHRoZSBzaG93IGFuZCBoaWRlIGV2ZW50cyB0aGF0IGFyZSB0cmlnZ2VyZWQgd2hlbiB0aGUgZGlyZWN0aXZlIGV4cHJlc3Npb24KICogaXMgdHJ1ZSBhbmQgZmFsc2UuIFRoaXMgc3lzdGVtIHdvcmtzIGxpa2UgdGhlIGFuaW1hdGlvbiBzeXN0ZW0gcHJlc2VudCB3aXRoIG5nQ2xhc3MgZXhjZXB0IHRoYXQKICogeW91IG11c3QgYWxzbyBpbmNsdWRlIHRoZSAhaW1wb3J0YW50IGZsYWcgdG8gb3ZlcnJpZGUgdGhlIGRpc3BsYXkgcHJvcGVydHkKICogc28gdGhhdCB5b3UgY2FuIHBlcmZvcm0gYW4gYW5pbWF0aW9uIHdoZW4gdGhlIGVsZW1lbnQgaXMgaGlkZGVuIGR1cmluZyB0aGUgdGltZSBvZiB0aGUgYW5pbWF0aW9uLgogKgogKiBgYGBjc3MKICogLy8KICogLy9hIHdvcmtpbmcgZXhhbXBsZSBjYW4gYmUgZm91bmQgYXQgdGhlIGJvdHRvbSBvZiB0aGlzIHBhZ2UKICogLy8KICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQsIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlIHsKICogICAvJiM0MjsgdGhpcyBpcyByZXF1aXJlZCBhcyBvZiAxLjN4IHRvIHByb3Blcmx5CiAqICAgICAgYXBwbHkgYWxsIHN0eWxpbmcgaW4gYSBzaG93L2hpZGUgYW5pbWF0aW9uICYjNDI7LwogKiAgIHRyYW5zaXRpb246MHMgbGluZWFyIGFsbDsKICogfQogKgogKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZC1hY3RpdmUsCiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlLWFjdGl2ZSB7CiAqICAgLyYjNDI7IHRoZSB0cmFuc2l0aW9uIGlzIGRlZmluZWQgaW4gdGhlIGFjdGl2ZSBjbGFzcyAmIzQyOy8KICogICB0cmFuc2l0aW9uOjFzIGxpbmVhciBhbGw7CiAqIH0KICoKICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQgeyAuLi4gfQogKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZC5uZy1oaWRlLWFkZC1hY3RpdmUgeyAuLi4gfQogKiAubXktZWxlbWVudC5uZy1oaWRlLXJlbW92ZSB7IC4uLiB9CiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlLm5nLWhpZGUtcmVtb3ZlLWFjdGl2ZSB7IC4uLiB9CiAqIGBgYAogKgogKiBLZWVwIGluIG1pbmQgdGhhdCwgYXMgb2YgQW5ndWxhckpTIHZlcnNpb24gMS4zLjAtYmV0YS4xMSwgdGhlcmUgaXMgbm8gbmVlZCB0byBjaGFuZ2UgdGhlIGRpc3BsYXkKICogcHJvcGVydHkgdG8gYmxvY2sgZHVyaW5nIGFuaW1hdGlvbiBzdGF0ZXMtLW5nQW5pbWF0ZSB3aWxsIGhhbmRsZSB0aGUgc3R5bGUgdG9nZ2xpbmcgYXV0b21hdGljYWxseSBmb3IgeW91LgogKgogKiBAYW5pbWF0aW9ucwogKiBhZGRDbGFzczogYC5uZy1oaWRlYCAtIGhhcHBlbnMgYWZ0ZXIgdGhlIGBuZ1Nob3dgIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgdHJ1dGh5IHZhbHVlIGFuZCB0aGUganVzdCBiZWZvcmUgY29udGVudHMgYXJlIHNldCB0byB2aXNpYmxlCiAqIHJlbW92ZUNsYXNzOiBgLm5nLWhpZGVgIC0gaGFwcGVucyBhZnRlciB0aGUgYG5nU2hvd2AgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSBub24gdHJ1dGh5IHZhbHVlIGFuZCBqdXN0IGJlZm9yZSB0aGUgY29udGVudHMgYXJlIHNldCB0byBoaWRkZW4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTaG93IElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHkKICogICAgIHRoZW4gdGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIHJlc3BlY3RpdmVseS4KICoKICogQGV4YW1wbGUKICA8ZXhhbXBsZSBtb2R1bGU9Im5nQW5pbWF0ZSIgZGVwcz0iYW5ndWxhci1hbmltYXRlLmpzIiBhbmltYXRpb25zPSJ0cnVlIj4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICAgPGRpdj4KICAgICAgICBTaG93OgogICAgICAgIDxkaXYgY2xhc3M9ImNoZWNrLWVsZW1lbnQgYW5pbWF0ZS1zaG93IiBuZy1zaG93PSJjaGVja2VkIj4KICAgICAgICAgIDxzcGFuIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLXRodW1icy11cCI+PC9zcGFuPiBJIHNob3cgdXAgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuCiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2PgogICAgICAgIEhpZGU6CiAgICAgICAgPGRpdiBjbGFzcz0iY2hlY2stZWxlbWVudCBhbmltYXRlLXNob3ciIG5nLWhpZGU9ImNoZWNrZWQiPgogICAgICAgICAgPHNwYW4gY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24tdGh1bWJzLWRvd24iPjwvc3Bhbj4gSSBoaWRlIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImdseXBoaWNvbnMuY3NzIj4KICAgICAgQGltcG9ydCB1cmwoLy9uZXRkbmEuYm9vdHN0cmFwY2RuLmNvbS9ib290c3RyYXAvMy4wLjAvY3NzL2Jvb3RzdHJhcC1nbHlwaGljb25zLmNzcyk7CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgIC5hbmltYXRlLXNob3cgewogICAgICAgIGxpbmUtaGVpZ2h0OjIwcHg7CiAgICAgICAgb3BhY2l0eToxOwogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgIH0KCiAgICAgIC5hbmltYXRlLXNob3cubmctaGlkZS1hZGQubmctaGlkZS1hZGQtYWN0aXZlLAogICAgICAuYW5pbWF0ZS1zaG93Lm5nLWhpZGUtcmVtb3ZlLm5nLWhpZGUtcmVtb3ZlLWFjdGl2ZSB7CiAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICB0cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtc2hvdy5uZy1oaWRlIHsKICAgICAgICBsaW5lLWhlaWdodDowOwogICAgICAgIG9wYWNpdHk6MDsKICAgICAgICBwYWRkaW5nOjAgMTBweDsKICAgICAgfQoKICAgICAgLmNoZWNrLWVsZW1lbnQgewogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgIH0KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICB2YXIgdGh1bWJzVXAgPSBlbGVtZW50KGJ5LmNzcygnc3Bhbi5nbHlwaGljb24tdGh1bWJzLXVwJykpOwogICAgICB2YXIgdGh1bWJzRG93biA9IGVsZW1lbnQoYnkuY3NzKCdzcGFuLmdseXBoaWNvbi10aHVtYnMtZG93bicpKTsKCiAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctc2hvdyAvIG5nLWhpZGUnLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3QodGh1bWJzVXAuaXNEaXNwbGF5ZWQoKSkudG9CZUZhbHN5KCk7CiAgICAgICAgZXhwZWN0KHRodW1ic0Rvd24uaXNEaXNwbGF5ZWQoKSkudG9CZVRydXRoeSgpOwoKICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdjaGVja2VkJykpLmNsaWNrKCk7CgogICAgICAgIGV4cGVjdCh0aHVtYnNVcC5pc0Rpc3BsYXllZCgpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgZXhwZWN0KHRodW1ic0Rvd24uaXNEaXNwbGF5ZWQoKSkudG9CZUZhbHN5KCk7CiAgICAgIH0pOwogICAgPC9maWxlPgogIDwvZXhhbXBsZT4KICovCnZhciBuZ1Nob3dEaXJlY3RpdmUgPSBbJyRhbmltYXRlJywgZnVuY3Rpb24oJGFuaW1hdGUpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdBJywKICAgIG11bHRpRWxlbWVudDogdHJ1ZSwKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nU2hvdywgZnVuY3Rpb24gbmdTaG93V2F0Y2hBY3Rpb24odmFsdWUpewogICAgICAgIC8vIHdlJ3JlIGFkZGluZyBhIHRlbXBvcmFyeSwgYW5pbWF0aW9uLXNwZWNpZmljIGNsYXNzIGZvciBuZy1oaWRlIHNpbmNlIHRoaXMgd2F5CiAgICAgICAgLy8gd2UgY2FuIGNvbnRyb2wgd2hlbiB0aGUgZWxlbWVudCBpcyBhY3R1YWxseSBkaXNwbGF5ZWQgb24gc2NyZWVuIHdpdGhvdXQgaGF2aW5nCiAgICAgICAgLy8gdG8gaGF2ZSBhIGdsb2JhbC9ncmVlZHkgQ1NTIHNlbGVjdG9yIHRoYXQgYnJlYWtzIHdoZW4gb3RoZXIgYW5pbWF0aW9ucyBhcmUgcnVuLgogICAgICAgIC8vIFJlYWQ6IGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvaXNzdWVzLzkxMDMjaXNzdWVjb21tZW50LTU4MzM1ODQ1CiAgICAgICAgJGFuaW1hdGVbdmFsdWUgPyAncmVtb3ZlQ2xhc3MnIDogJ2FkZENsYXNzJ10oZWxlbWVudCwgTkdfSElERV9DTEFTUywgewogICAgICAgICAgdGVtcENsYXNzZXMgOiBOR19ISURFX0lOX1BST0dSRVNTX0NMQVNTCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH07Cn1dOwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nSGlkZQogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0hpZGVgIGRpcmVjdGl2ZSBzaG93cyBvciBoaWRlcyB0aGUgZ2l2ZW4gSFRNTCBlbGVtZW50IGJhc2VkIG9uIHRoZSBleHByZXNzaW9uCiAqIHByb3ZpZGVkIHRvIHRoZSBgbmdIaWRlYCBhdHRyaWJ1dGUuIFRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiBieSByZW1vdmluZyBvciBhZGRpbmcKICogdGhlIGBuZy1oaWRlYCBDU1MgY2xhc3Mgb250byB0aGUgZWxlbWVudC4gVGhlIGAubmctaGlkZWAgQ1NTIGNsYXNzIGlzIHByZWRlZmluZWQKICogaW4gQW5ndWxhckpTIGFuZCBzZXRzIHRoZSBkaXNwbGF5IHN0eWxlIHRvIG5vbmUgKHVzaW5nIGFuICFpbXBvcnRhbnQgZmxhZykuCiAqIEZvciBDU1AgbW9kZSBwbGVhc2UgYWRkIGBhbmd1bGFyLWNzcC5jc3NgIHRvIHlvdXIgaHRtbCBmaWxlIChzZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NzcCBuZ0NzcH0pLgogKgogKiBgYGBodG1sCiAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyB0cnV0aHkgKGVsZW1lbnQgaXMgaGlkZGVuKSAtLT4KICogPGRpdiBuZy1oaWRlPSJteVZhbHVlIiBjbGFzcz0ibmctaGlkZSI+PC9kaXY+CiAqCiAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyBmYWxzeSAoZWxlbWVudCBpcyB2aXNpYmxlKSAtLT4KICogPGRpdiBuZy1oaWRlPSJteVZhbHVlIj48L2Rpdj4KICogYGBgCiAqCiAqIFdoZW4gdGhlIGBuZ0hpZGVgIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgdHJ1dGh5IHZhbHVlIHRoZW4gdGhlIGAubmctaGlkZWAgQ1NTIGNsYXNzIGlzIGFkZGVkIHRvIHRoZSBjbGFzcwogKiBhdHRyaWJ1dGUgb24gdGhlIGVsZW1lbnQgY2F1c2luZyBpdCB0byBiZWNvbWUgaGlkZGVuLiBXaGVuIGZhbHN5LCB0aGUgYC5uZy1oaWRlYCBDU1MgY2xhc3MgaXMgcmVtb3ZlZAogKiBmcm9tIHRoZSBlbGVtZW50IGNhdXNpbmcgdGhlIGVsZW1lbnQgbm90IHRvIGFwcGVhciBoaWRkZW4uCiAqCiAqICMjIFdoeSBpcyAhaW1wb3J0YW50IHVzZWQ/CiAqCiAqIFlvdSBtYXkgYmUgd29uZGVyaW5nIHdoeSAhaW1wb3J0YW50IGlzIHVzZWQgZm9yIHRoZSBgLm5nLWhpZGVgIENTUyBjbGFzcy4gVGhpcyBpcyBiZWNhdXNlIHRoZSBgLm5nLWhpZGVgIHNlbGVjdG9yCiAqIGNhbiBiZSBlYXNpbHkgb3ZlcnJpZGRlbiBieSBoZWF2aWVyIHNlbGVjdG9ycy4gRm9yIGV4YW1wbGUsIHNvbWV0aGluZyBhcyBzaW1wbGUKICogYXMgY2hhbmdpbmcgdGhlIGRpc3BsYXkgc3R5bGUgb24gYSBIVE1MIGxpc3QgaXRlbSB3b3VsZCBtYWtlIGhpZGRlbiBlbGVtZW50cyBhcHBlYXIgdmlzaWJsZS4KICogVGhpcyBhbHNvIGJlY29tZXMgYSBiaWdnZXIgaXNzdWUgd2hlbiBkZWFsaW5nIHdpdGggQ1NTIGZyYW1ld29ya3MuCiAqCiAqIEJ5IHVzaW5nICFpbXBvcnRhbnQsIHRoZSBzaG93IGFuZCBoaWRlIGJlaGF2aW9yIHdpbGwgd29yayBhcyBleHBlY3RlZCBkZXNwaXRlIGFueSBjbGFzaCBiZXR3ZWVuIENTUyBzZWxlY3RvcgogKiBzcGVjaWZpY2l0eSAod2hlbiAhaW1wb3J0YW50IGlzbid0IHVzZWQgd2l0aCBhbnkgY29uZmxpY3Rpbmcgc3R5bGVzKS4gSWYgYSBkZXZlbG9wZXIgY2hvb3NlcyB0byBvdmVycmlkZSB0aGUKICogc3R5bGluZyB0byBjaGFuZ2UgaG93IHRvIGhpZGUgYW4gZWxlbWVudCB0aGVuIGl0IGlzIGp1c3QgYSBtYXR0ZXIgb2YgdXNpbmcgIWltcG9ydGFudCBpbiB0aGVpciBvd24gQ1NTIGNvZGUuCiAqCiAqICMjIyBPdmVycmlkaW5nIGAubmctaGlkZWAKICoKICogQnkgZGVmYXVsdCwgdGhlIGAubmctaGlkZWAgY2xhc3Mgd2lsbCBzdHlsZSB0aGUgZWxlbWVudCB3aXRoIGBkaXNwbGF5Om5vbmUhaW1wb3J0YW50YC4gSWYgeW91IHdpc2ggdG8gY2hhbmdlCiAqIHRoZSBoaWRlIGJlaGF2aW9yIHdpdGggbmdTaG93L25nSGlkZSB0aGVuIHRoaXMgY2FuIGJlIGFjaGlldmVkIGJ5IHJlc3RhdGluZyB0aGUgc3R5bGVzIGZvciB0aGUgYC5uZy1oaWRlYAogKiBjbGFzcyBpbiBDU1M6CiAqCiAqIGBgYGNzcwogKiAubmctaGlkZSB7CiAqICAgLyYjNDI7IHRoaXMgaXMganVzdCBhbm90aGVyIGZvcm0gb2YgaGlkaW5nIGFuIGVsZW1lbnQgJiM0MjsvCiAqICAgZGlzcGxheTpibG9jayFpbXBvcnRhbnQ7CiAqICAgcG9zaXRpb246YWJzb2x1dGU7CiAqICAgdG9wOi05OTk5cHg7CiAqICAgbGVmdDotOTk5OXB4OwogKiB9CiAqIGBgYAogKgogKiBCeSBkZWZhdWx0IHlvdSBkb24ndCBuZWVkIHRvIG92ZXJyaWRlIGluIENTUyBhbnl0aGluZyBhbmQgdGhlIGFuaW1hdGlvbnMgd2lsbCB3b3JrIGFyb3VuZCB0aGUgZGlzcGxheSBzdHlsZS4KICoKICogIyMgQSBub3RlIGFib3V0IGFuaW1hdGlvbnMgd2l0aCBgbmdIaWRlYAogKgogKiBBbmltYXRpb25zIGluIG5nU2hvdy9uZ0hpZGUgd29yayB3aXRoIHRoZSBzaG93IGFuZCBoaWRlIGV2ZW50cyB0aGF0IGFyZSB0cmlnZ2VyZWQgd2hlbiB0aGUgZGlyZWN0aXZlIGV4cHJlc3Npb24KICogaXMgdHJ1ZSBhbmQgZmFsc2UuIFRoaXMgc3lzdGVtIHdvcmtzIGxpa2UgdGhlIGFuaW1hdGlvbiBzeXN0ZW0gcHJlc2VudCB3aXRoIG5nQ2xhc3MsIGV4Y2VwdCB0aGF0IHRoZSBgLm5nLWhpZGVgCiAqIENTUyBjbGFzcyBpcyBhZGRlZCBhbmQgcmVtb3ZlZCBmb3IgeW91IGluc3RlYWQgb2YgeW91ciBvd24gQ1NTIGNsYXNzLgogKgogKiBgYGBjc3MKICogLy8KICogLy9hIHdvcmtpbmcgZXhhbXBsZSBjYW4gYmUgZm91bmQgYXQgdGhlIGJvdHRvbSBvZiB0aGlzIHBhZ2UKICogLy8KICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQsIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlIHsKICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogfQogKgogKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCB7IC4uLiB9CiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkLm5nLWhpZGUtYWRkLWFjdGl2ZSB7IC4uLiB9CiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlIHsgLi4uIH0KICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUubmctaGlkZS1yZW1vdmUtYWN0aXZlIHsgLi4uIH0KICogYGBgCiAqCiAqIEtlZXAgaW4gbWluZCB0aGF0LCBhcyBvZiBBbmd1bGFySlMgdmVyc2lvbiAxLjMuMC1iZXRhLjExLCB0aGVyZSBpcyBubyBuZWVkIHRvIGNoYW5nZSB0aGUgZGlzcGxheQogKiBwcm9wZXJ0eSB0byBibG9jayBkdXJpbmcgYW5pbWF0aW9uIHN0YXRlcy0tbmdBbmltYXRlIHdpbGwgaGFuZGxlIHRoZSBzdHlsZSB0b2dnbGluZyBhdXRvbWF0aWNhbGx5IGZvciB5b3UuCiAqCiAqIEBhbmltYXRpb25zCiAqIHJlbW92ZUNsYXNzOiBgLm5nLWhpZGVgIC0gaGFwcGVucyBhZnRlciB0aGUgYG5nSGlkZWAgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSB0cnV0aHkgdmFsdWUgYW5kIGp1c3QgYmVmb3JlIHRoZSBjb250ZW50cyBhcmUgc2V0IHRvIGhpZGRlbgogKiBhZGRDbGFzczogYC5uZy1oaWRlYCAtIGhhcHBlbnMgYWZ0ZXIgdGhlIGBuZ0hpZGVgIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgbm9uIHRydXRoeSB2YWx1ZSBhbmQganVzdCBiZWZvcmUgdGhlIGNvbnRlbnRzIGFyZSBzZXQgdG8gdmlzaWJsZQogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0hpZGUgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSB0aGVuCiAqICAgICB0aGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gcmVzcGVjdGl2ZWx5LgogKgogKiBAZXhhbXBsZQogIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIENsaWNrIG1lOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgICA8ZGl2PgogICAgICAgIFNob3c6CiAgICAgICAgPGRpdiBjbGFzcz0iY2hlY2stZWxlbWVudCBhbmltYXRlLWhpZGUiIG5nLXNob3c9ImNoZWNrZWQiPgogICAgICAgICAgPHNwYW4gY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24tdGh1bWJzLXVwIj48L3NwYW4+IEkgc2hvdyB1cCB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXY+CiAgICAgICAgSGlkZToKICAgICAgICA8ZGl2IGNsYXNzPSJjaGVjay1lbGVtZW50IGFuaW1hdGUtaGlkZSIgbmctaGlkZT0iY2hlY2tlZCI+CiAgICAgICAgICA8c3BhbiBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi10aHVtYnMtZG93biI+PC9zcGFuPiBJIGhpZGUgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuCiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iZ2x5cGhpY29ucy5jc3MiPgogICAgICBAaW1wb3J0IHVybCgvL25ldGRuYS5ib290c3RyYXBjZG4uY29tL2Jvb3RzdHJhcC8zLjAuMC9jc3MvYm9vdHN0cmFwLWdseXBoaWNvbnMuY3NzKTsKICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImFuaW1hdGlvbnMuY3NzIj4KICAgICAgLmFuaW1hdGUtaGlkZSB7CiAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICB0cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICBsaW5lLWhlaWdodDoyMHB4OwogICAgICAgIG9wYWNpdHk6MTsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgYm9yZGVyOjFweCBzb2xpZCBibGFjazsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICB9CgogICAgICAuYW5pbWF0ZS1oaWRlLm5nLWhpZGUgewogICAgICAgIGxpbmUtaGVpZ2h0OjA7CiAgICAgICAgb3BhY2l0eTowOwogICAgICAgIHBhZGRpbmc6MCAxMHB4OwogICAgICB9CgogICAgICAuY2hlY2stZWxlbWVudCB7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgfQogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgIHZhciB0aHVtYnNVcCA9IGVsZW1lbnQoYnkuY3NzKCdzcGFuLmdseXBoaWNvbi10aHVtYnMtdXAnKSk7CiAgICAgIHZhciB0aHVtYnNEb3duID0gZWxlbWVudChieS5jc3MoJ3NwYW4uZ2x5cGhpY29uLXRodW1icy1kb3duJykpOwoKICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zaG93IC8gbmctaGlkZScsIGZ1bmN0aW9uKCkgewogICAgICAgIGV4cGVjdCh0aHVtYnNVcC5pc0Rpc3BsYXllZCgpKS50b0JlRmFsc3koKTsKICAgICAgICBleHBlY3QodGh1bWJzRG93bi5pc0Rpc3BsYXllZCgpKS50b0JlVHJ1dGh5KCk7CgogICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2NoZWNrZWQnKSkuY2xpY2soKTsKCiAgICAgICAgZXhwZWN0KHRodW1ic1VwLmlzRGlzcGxheWVkKCkpLnRvQmVUcnV0aHkoKTsKICAgICAgICBleHBlY3QodGh1bWJzRG93bi5pc0Rpc3BsYXllZCgpKS50b0JlRmFsc3koKTsKICAgICAgfSk7CiAgICA8L2ZpbGU+CiAgPC9leGFtcGxlPgogKi8KdmFyIG5nSGlkZURpcmVjdGl2ZSA9IFsnJGFuaW1hdGUnLCBmdW5jdGlvbigkYW5pbWF0ZSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgbXVsdGlFbGVtZW50OiB0cnVlLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdIaWRlLCBmdW5jdGlvbiBuZ0hpZGVXYXRjaEFjdGlvbih2YWx1ZSl7CiAgICAgICAgLy8gVGhlIGNvbW1lbnQgaW5zaWRlIG9mIHRoZSBuZ1Nob3dEaXJlY3RpdmUgZXhwbGFpbnMgd2h5IHdlIGFkZCBhbmQKICAgICAgICAvLyByZW1vdmUgYSB0ZW1wb3JhcnkgY2xhc3MgZm9yIHRoZSBzaG93L2hpZGUgYW5pbWF0aW9uCiAgICAgICAgJGFuaW1hdGVbdmFsdWUgPyAnYWRkQ2xhc3MnIDogJ3JlbW92ZUNsYXNzJ10oZWxlbWVudCxOR19ISURFX0NMQVNTLCB7CiAgICAgICAgICB0ZW1wQ2xhc3NlcyA6IE5HX0hJREVfSU5fUFJPR1JFU1NfQ0xBU1MKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfTsKfV07CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1N0eWxlCiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ1N0eWxlYCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzZXQgQ1NTIHN0eWxlIG9uIGFuIEhUTUwgZWxlbWVudCBjb25kaXRpb25hbGx5LgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1N0eWxlCiAqCiAqIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHdoaWNoIGV2YWxzIHRvIGFuCiAqIG9iamVjdCB3aG9zZSBrZXlzIGFyZSBDU1Mgc3R5bGUgbmFtZXMgYW5kIHZhbHVlcyBhcmUgY29ycmVzcG9uZGluZyB2YWx1ZXMgZm9yIHRob3NlIENTUwogKiBrZXlzLgogKgogKiBTaW5jZSBzb21lIENTUyBzdHlsZSBuYW1lcyBhcmUgbm90IHZhbGlkIGtleXMgZm9yIGFuIG9iamVjdCwgdGhleSBtdXN0IGJlIHF1b3RlZC4KICogU2VlIHRoZSAnYmFja2dyb3VuZC1jb2xvcicgc3R5bGUgaW4gdGhlIGV4YW1wbGUgYmVsb3cuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQgY29sb3IiIG5nLWNsaWNrPSJteVN0eWxlPXtjb2xvcjoncmVkJ30iPgogICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQgYmFja2dyb3VuZCIgbmctY2xpY2s9Im15U3R5bGU9eydiYWNrZ3JvdW5kLWNvbG9yJzonYmx1ZSd9Ij4KICAgICAgICA8aW5wdXQgdHlwZT0iYnV0dG9uIiB2YWx1ZT0iY2xlYXIiIG5nLWNsaWNrPSJteVN0eWxlPXt9Ij4KICAgICAgICA8YnIvPgogICAgICAgIDxzcGFuIG5nLXN0eWxlPSJteVN0eWxlIj5TYW1wbGUgVGV4dDwvc3Bhbj4KICAgICAgICA8cHJlPm15U3R5bGU9e3tteVN0eWxlfX08L3ByZT4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgIHNwYW4gewogICAgICAgICBjb2xvcjogYmxhY2s7CiAgICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgdmFyIGNvbG9yU3BhbiA9IGVsZW1lbnQoYnkuY3NzKCdzcGFuJykpOwoKICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctc3R5bGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGNvbG9yU3Bhbi5nZXRDc3NWYWx1ZSgnY29sb3InKSkudG9CZSgncmdiYSgwLCAwLCAwLCAxKScpOwogICAgICAgICBlbGVtZW50KGJ5LmNzcygnaW5wdXRbdmFsdWU9XCdzZXQgY29sb3JcJ10nKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGNvbG9yU3Bhbi5nZXRDc3NWYWx1ZSgnY29sb3InKSkudG9CZSgncmdiYSgyNTUsIDAsIDAsIDEpJyk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCdpbnB1dFt2YWx1ZT1jbGVhcl0nKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGNvbG9yU3Bhbi5nZXRDc3NWYWx1ZSgnY29sb3InKSkudG9CZSgncmdiYSgwLCAwLCAwLCAxKScpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdTdHlsZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgc2NvcGUuJHdhdGNoKGF0dHIubmdTdHlsZSwgZnVuY3Rpb24gbmdTdHlsZVdhdGNoQWN0aW9uKG5ld1N0eWxlcywgb2xkU3R5bGVzKSB7CiAgICBpZiAob2xkU3R5bGVzICYmIChuZXdTdHlsZXMgIT09IG9sZFN0eWxlcykpIHsKICAgICAgZm9yRWFjaChvbGRTdHlsZXMsIGZ1bmN0aW9uKHZhbCwgc3R5bGUpIHsgZWxlbWVudC5jc3Moc3R5bGUsICcnKTt9KTsKICAgIH0KICAgIGlmIChuZXdTdHlsZXMpIGVsZW1lbnQuY3NzKG5ld1N0eWxlcyk7CiAgfSwgdHJ1ZSk7Cn0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdTd2l0Y2gKICogQHJlc3RyaWN0IEVBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nU3dpdGNoYCBkaXJlY3RpdmUgaXMgdXNlZCB0byBjb25kaXRpb25hbGx5IHN3YXAgRE9NIHN0cnVjdHVyZSBvbiB5b3VyIHRlbXBsYXRlIGJhc2VkIG9uIGEgc2NvcGUgZXhwcmVzc2lvbi4KICogRWxlbWVudHMgd2l0aGluIGBuZ1N3aXRjaGAgYnV0IHdpdGhvdXQgYG5nU3dpdGNoV2hlbmAgb3IgYG5nU3dpdGNoRGVmYXVsdGAgZGlyZWN0aXZlcyB3aWxsIGJlIHByZXNlcnZlZCBhdCB0aGUgbG9jYXRpb24KICogYXMgc3BlY2lmaWVkIGluIHRoZSB0ZW1wbGF0ZS4KICoKICogVGhlIGRpcmVjdGl2ZSBpdHNlbGYgd29ya3Mgc2ltaWxhciB0byBuZ0luY2x1ZGUsIGhvd2V2ZXIsIGluc3RlYWQgb2YgZG93bmxvYWRpbmcgdGVtcGxhdGUgY29kZSAob3IgbG9hZGluZyBpdAogKiBmcm9tIHRoZSB0ZW1wbGF0ZSBjYWNoZSksIGBuZ1N3aXRjaGAgc2ltcGx5IGNob29zZXMgb25lIG9mIHRoZSBuZXN0ZWQgZWxlbWVudHMgYW5kIG1ha2VzIGl0IHZpc2libGUgYmFzZWQgb24gd2hpY2ggZWxlbWVudAogKiBtYXRjaGVzIHRoZSB2YWx1ZSBvYnRhaW5lZCBmcm9tIHRoZSBldmFsdWF0ZWQgZXhwcmVzc2lvbi4gSW4gb3RoZXIgd29yZHMsIHlvdSBkZWZpbmUgYSBjb250YWluZXIgZWxlbWVudAogKiAod2hlcmUgeW91IHBsYWNlIHRoZSBkaXJlY3RpdmUpLCBwbGFjZSBhbiBleHByZXNzaW9uIG9uIHRoZSAqKmBvbj0iLi4uImAgYXR0cmlidXRlKioKICogKG9yIHRoZSAqKmBuZy1zd2l0Y2g9Ii4uLiJgIGF0dHJpYnV0ZSoqKSwgZGVmaW5lIGFueSBpbm5lciBlbGVtZW50cyBpbnNpZGUgb2YgdGhlIGRpcmVjdGl2ZSBhbmQgcGxhY2UKICogYSB3aGVuIGF0dHJpYnV0ZSBwZXIgZWxlbWVudC4gVGhlIHdoZW4gYXR0cmlidXRlIGlzIHVzZWQgdG8gaW5mb3JtIG5nU3dpdGNoIHdoaWNoIGVsZW1lbnQgdG8gZGlzcGxheSB3aGVuIHRoZSBvbgogKiBleHByZXNzaW9uIGlzIGV2YWx1YXRlZC4gSWYgYSBtYXRjaGluZyBleHByZXNzaW9uIGlzIG5vdCBmb3VuZCB2aWEgYSB3aGVuIGF0dHJpYnV0ZSB0aGVuIGFuIGVsZW1lbnQgd2l0aCB0aGUgZGVmYXVsdAogKiBhdHRyaWJ1dGUgaXMgZGlzcGxheWVkLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1pbmZvIj4KICogQmUgYXdhcmUgdGhhdCB0aGUgYXR0cmlidXRlIHZhbHVlcyB0byBtYXRjaCBhZ2FpbnN0IGNhbm5vdCBiZSBleHByZXNzaW9ucy4gVGhleSBhcmUgaW50ZXJwcmV0ZWQKICogYXMgbGl0ZXJhbCBzdHJpbmcgdmFsdWVzIHRvIG1hdGNoIGFnYWluc3QuCiAqIEZvciBleGFtcGxlLCAqKmBuZy1zd2l0Y2gtd2hlbj0ic29tZVZhbCJgKiogd2lsbCBtYXRjaCBhZ2FpbnN0IHRoZSBzdHJpbmcgYCJzb21lVmFsImAgbm90IGFnYWluc3QgdGhlCiAqIHZhbHVlIG9mIHRoZSBleHByZXNzaW9uIGAkc2NvcGUuc29tZVZhbGAuCiAqIDwvZGl2PgoKICogQGFuaW1hdGlvbnMKICogZW50ZXIgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ1N3aXRjaCBjb250ZW50cyBjaGFuZ2UgYW5kIHRoZSBtYXRjaGVkIGNoaWxkIGVsZW1lbnQgaXMgcGxhY2VkIGluc2lkZSB0aGUgY29udGFpbmVyCiAqIGxlYXZlIC0gaGFwcGVucyBqdXN0IGFmdGVyIHRoZSBuZ1N3aXRjaCBjb250ZW50cyBjaGFuZ2UgYW5kIGp1c3QgYmVmb3JlIHRoZSBmb3JtZXIgY29udGVudHMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgRE9NCiAqCiAqIEB1c2FnZQogKgogKiBgYGAKICogPEFOWSBuZy1zd2l0Y2g9ImV4cHJlc3Npb24iPgogKiAgIDxBTlkgbmctc3dpdGNoLXdoZW49Im1hdGNoVmFsdWUxIj4uLi48L0FOWT4KICogICA8QU5ZIG5nLXN3aXRjaC13aGVuPSJtYXRjaFZhbHVlMiI+Li4uPC9BTlk+CiAqICAgPEFOWSBuZy1zd2l0Y2gtZGVmYXVsdD4uLi48L0FOWT4KICogPC9BTlk+CiAqIGBgYAogKgogKgogKiBAc2NvcGUKICogQHByaW9yaXR5IDEyMDAKICogQHBhcmFtIHsqfSBuZ1N3aXRjaHxvbiBleHByZXNzaW9uIHRvIG1hdGNoIGFnYWluc3QgPHR0Pm5nLXN3aXRjaC13aGVuPC90dD4uCiAqIE9uIGNoaWxkIGVsZW1lbnRzIGFkZDoKICoKICogKiBgbmdTd2l0Y2hXaGVuYDogdGhlIGNhc2Ugc3RhdGVtZW50IHRvIG1hdGNoIGFnYWluc3QuIElmIG1hdGNoIHRoZW4gdGhpcwogKiAgIGNhc2Ugd2lsbCBiZSBkaXNwbGF5ZWQuIElmIHRoZSBzYW1lIG1hdGNoIGFwcGVhcnMgbXVsdGlwbGUgdGltZXMsIGFsbCB0aGUKICogICBlbGVtZW50cyB3aWxsIGJlIGRpc3BsYXllZC4KICogKiBgbmdTd2l0Y2hEZWZhdWx0YDogdGhlIGRlZmF1bHQgY2FzZSB3aGVuIG5vIG90aGVyIGNhc2UgbWF0Y2guIElmIHRoZXJlCiAqICAgYXJlIG11bHRpcGxlIGRlZmF1bHQgY2FzZXMsIGFsbCBvZiB0aGVtIHdpbGwgYmUgZGlzcGxheWVkIHdoZW4gbm8gb3RoZXIKICogICBjYXNlIG1hdGNoLgogKgogKgogKiBAZXhhbXBsZQogIDxleGFtcGxlIG1vZHVsZT0ic3dpdGNoRXhhbXBsZSIgZGVwcz0iYW5ndWxhci1hbmltYXRlLmpzIiBhbmltYXRpb25zPSJ0cnVlIj4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJzZWxlY3Rpb24iIG5nLW9wdGlvbnM9Iml0ZW0gZm9yIGl0ZW0gaW4gaXRlbXMiPgogICAgICAgIDwvc2VsZWN0PgogICAgICAgIDx0dD5zZWxlY3Rpb249e3tzZWxlY3Rpb259fTwvdHQ+CiAgICAgICAgPGhyLz4KICAgICAgICA8ZGl2IGNsYXNzPSJhbmltYXRlLXN3aXRjaC1jb250YWluZXIiCiAgICAgICAgICBuZy1zd2l0Y2ggb249InNlbGVjdGlvbiI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFuaW1hdGUtc3dpdGNoIiBuZy1zd2l0Y2gtd2hlbj0ic2V0dGluZ3MiPlNldHRpbmdzIERpdjwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJhbmltYXRlLXN3aXRjaCIgbmctc3dpdGNoLXdoZW49ImhvbWUiPkhvbWUgU3BhbjwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJhbmltYXRlLXN3aXRjaCIgbmctc3dpdGNoLWRlZmF1bHQ+ZGVmYXVsdDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgIGFuZ3VsYXIubW9kdWxlKCdzd2l0Y2hFeGFtcGxlJywgWyduZ0FuaW1hdGUnXSkKICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLml0ZW1zID0gWydzZXR0aW5ncycsICdob21lJywgJ290aGVyJ107CiAgICAgICAgICAkc2NvcGUuc2VsZWN0aW9uID0gJHNjb3BlLml0ZW1zWzBdOwogICAgICAgIH1dKTsKICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImFuaW1hdGlvbnMuY3NzIj4KICAgICAgLmFuaW1hdGUtc3dpdGNoLWNvbnRhaW5lciB7CiAgICAgICAgcG9zaXRpb246cmVsYXRpdmU7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGhlaWdodDo0MHB4OwogICAgICAgIG92ZXJmbG93OmhpZGRlbjsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtc3dpdGNoIHsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgIH0KCiAgICAgIC5hbmltYXRlLXN3aXRjaC5uZy1hbmltYXRlIHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgICB0cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CgogICAgICAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgICAgIHRvcDowOwogICAgICAgIGxlZnQ6MDsKICAgICAgICByaWdodDowOwogICAgICAgIGJvdHRvbTowOwogICAgICB9CgogICAgICAuYW5pbWF0ZS1zd2l0Y2gubmctbGVhdmUubmctbGVhdmUtYWN0aXZlLAogICAgICAuYW5pbWF0ZS1zd2l0Y2gubmctZW50ZXIgewogICAgICAgIHRvcDotNTBweDsKICAgICAgfQogICAgICAuYW5pbWF0ZS1zd2l0Y2gubmctbGVhdmUsCiAgICAgIC5hbmltYXRlLXN3aXRjaC5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogICAgICAgIHRvcDowOwogICAgICB9CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgdmFyIHN3aXRjaEVsZW0gPSBlbGVtZW50KGJ5LmNzcygnW25nLXN3aXRjaF0nKSk7CiAgICAgIHZhciBzZWxlY3QgPSBlbGVtZW50KGJ5Lm1vZGVsKCdzZWxlY3Rpb24nKSk7CgogICAgICBpdCgnc2hvdWxkIHN0YXJ0IGluIHNldHRpbmdzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KHN3aXRjaEVsZW0uZ2V0VGV4dCgpKS50b01hdGNoKC9TZXR0aW5ncyBEaXYvKTsKICAgICAgfSk7CiAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGhvbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICBzZWxlY3QuYWxsKGJ5LmNzcygnb3B0aW9uJykpLmdldCgxKS5jbGljaygpOwogICAgICAgIGV4cGVjdChzd2l0Y2hFbGVtLmdldFRleHQoKSkudG9NYXRjaCgvSG9tZSBTcGFuLyk7CiAgICAgIH0pOwogICAgICBpdCgnc2hvdWxkIHNlbGVjdCBkZWZhdWx0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZWN0LmFsbChieS5jc3MoJ29wdGlvbicpKS5nZXQoMikuY2xpY2soKTsKICAgICAgICBleHBlY3Qoc3dpdGNoRWxlbS5nZXRUZXh0KCkpLnRvTWF0Y2goL2RlZmF1bHQvKTsKICAgICAgfSk7CiAgICA8L2ZpbGU+CiAgPC9leGFtcGxlPgogKi8KdmFyIG5nU3dpdGNoRGlyZWN0aXZlID0gWyckYW5pbWF0ZScsIGZ1bmN0aW9uKCRhbmltYXRlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRUEnLAogICAgcmVxdWlyZTogJ25nU3dpdGNoJywKCiAgICAvLyBhc2tzIGZvciAkc2NvcGUgdG8gZm9vbCB0aGUgQkMgY29udHJvbGxlciBtb2R1bGUKICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgZnVuY3Rpb24gbmdTd2l0Y2hDb250cm9sbGVyKCkgewogICAgIHRoaXMuY2FzZXMgPSB7fTsKICAgIH1dLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIG5nU3dpdGNoQ29udHJvbGxlcikgewogICAgICB2YXIgd2F0Y2hFeHByID0gYXR0ci5uZ1N3aXRjaCB8fCBhdHRyLm9uLAogICAgICAgICAgc2VsZWN0ZWRUcmFuc2NsdWRlcyA9IFtdLAogICAgICAgICAgc2VsZWN0ZWRFbGVtZW50cyA9IFtdLAogICAgICAgICAgcHJldmlvdXNMZWF2ZUFuaW1hdGlvbnMgPSBbXSwKICAgICAgICAgIHNlbGVjdGVkU2NvcGVzID0gW107CgogICAgICB2YXIgc3BsaWNlRmFjdG9yeSA9IGZ1bmN0aW9uKGFycmF5LCBpbmRleCkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgeyBhcnJheS5zcGxpY2UoaW5kZXgsIDEpOyB9OwogICAgICB9OwoKICAgICAgc2NvcGUuJHdhdGNoKHdhdGNoRXhwciwgZnVuY3Rpb24gbmdTd2l0Y2hXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgIHZhciBpLCBpaTsKICAgICAgICBmb3IgKGkgPSAwLCBpaSA9IHByZXZpb3VzTGVhdmVBbmltYXRpb25zLmxlbmd0aDsgaSA8IGlpOyArK2kpIHsKICAgICAgICAgICRhbmltYXRlLmNhbmNlbChwcmV2aW91c0xlYXZlQW5pbWF0aW9uc1tpXSk7CiAgICAgICAgfQogICAgICAgIHByZXZpb3VzTGVhdmVBbmltYXRpb25zLmxlbmd0aCA9IDA7CgogICAgICAgIGZvciAoaSA9IDAsIGlpID0gc2VsZWN0ZWRTY29wZXMubGVuZ3RoOyBpIDwgaWk7ICsraSkgewogICAgICAgICAgdmFyIHNlbGVjdGVkID0gZ2V0QmxvY2tOb2RlcyhzZWxlY3RlZEVsZW1lbnRzW2ldLmNsb25lKTsKICAgICAgICAgIHNlbGVjdGVkU2NvcGVzW2ldLiRkZXN0cm95KCk7CiAgICAgICAgICB2YXIgcHJvbWlzZSA9IHByZXZpb3VzTGVhdmVBbmltYXRpb25zW2ldID0gJGFuaW1hdGUubGVhdmUoc2VsZWN0ZWQpOwogICAgICAgICAgcHJvbWlzZS50aGVuKHNwbGljZUZhY3RvcnkocHJldmlvdXNMZWF2ZUFuaW1hdGlvbnMsIGkpKTsKICAgICAgICB9CgogICAgICAgIHNlbGVjdGVkRWxlbWVudHMubGVuZ3RoID0gMDsKICAgICAgICBzZWxlY3RlZFNjb3Blcy5sZW5ndGggPSAwOwoKICAgICAgICBpZiAoKHNlbGVjdGVkVHJhbnNjbHVkZXMgPSBuZ1N3aXRjaENvbnRyb2xsZXIuY2FzZXNbJyEnICsgdmFsdWVdIHx8IG5nU3dpdGNoQ29udHJvbGxlci5jYXNlc1snPyddKSkgewogICAgICAgICAgZm9yRWFjaChzZWxlY3RlZFRyYW5zY2x1ZGVzLCBmdW5jdGlvbihzZWxlY3RlZFRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgc2VsZWN0ZWRUcmFuc2NsdWRlLnRyYW5zY2x1ZGUoZnVuY3Rpb24oY2FzZUVsZW1lbnQsIHNlbGVjdGVkU2NvcGUpIHsKICAgICAgICAgICAgICBzZWxlY3RlZFNjb3Blcy5wdXNoKHNlbGVjdGVkU2NvcGUpOwogICAgICAgICAgICAgIHZhciBhbmNob3IgPSBzZWxlY3RlZFRyYW5zY2x1ZGUuZWxlbWVudDsKICAgICAgICAgICAgICBjYXNlRWxlbWVudFtjYXNlRWxlbWVudC5sZW5ndGgrK10gPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KCcgZW5kIG5nU3dpdGNoV2hlbjogJyk7CiAgICAgICAgICAgICAgdmFyIGJsb2NrID0geyBjbG9uZTogY2FzZUVsZW1lbnQgfTsKCiAgICAgICAgICAgICAgc2VsZWN0ZWRFbGVtZW50cy5wdXNoKGJsb2NrKTsKICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjYXNlRWxlbWVudCwgYW5jaG9yLnBhcmVudCgpLCBhbmNob3IpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKfV07Cgp2YXIgbmdTd2l0Y2hXaGVuRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICBwcmlvcml0eTogMTIwMCwKICByZXF1aXJlOiAnXm5nU3dpdGNoJywKICBtdWx0aUVsZW1lbnQ6IHRydWUsCiAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjdHJsLCAkdHJhbnNjbHVkZSkgewogICAgY3RybC5jYXNlc1snIScgKyBhdHRycy5uZ1N3aXRjaFdoZW5dID0gKGN0cmwuY2FzZXNbJyEnICsgYXR0cnMubmdTd2l0Y2hXaGVuXSB8fCBbXSk7CiAgICBjdHJsLmNhc2VzWychJyArIGF0dHJzLm5nU3dpdGNoV2hlbl0ucHVzaCh7IHRyYW5zY2x1ZGU6ICR0cmFuc2NsdWRlLCBlbGVtZW50OiBlbGVtZW50IH0pOwogIH0KfSk7Cgp2YXIgbmdTd2l0Y2hEZWZhdWx0RGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICBwcmlvcml0eTogMTIwMCwKICByZXF1aXJlOiAnXm5nU3dpdGNoJywKICBtdWx0aUVsZW1lbnQ6IHRydWUsCiAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICR0cmFuc2NsdWRlKSB7CiAgICBjdHJsLmNhc2VzWyc/J10gPSAoY3RybC5jYXNlc1snPyddIHx8IFtdKTsKICAgIGN0cmwuY2FzZXNbJz8nXS5wdXNoKHsgdHJhbnNjbHVkZTogJHRyYW5zY2x1ZGUsIGVsZW1lbnQ6IGVsZW1lbnQgfSk7CiAgIH0KfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1RyYW5zY2x1ZGUKICogQHJlc3RyaWN0IEVBQwogKgogKiBAZGVzY3JpcHRpb24KICogRGlyZWN0aXZlIHRoYXQgbWFya3MgdGhlIGluc2VydGlvbiBwb2ludCBmb3IgdGhlIHRyYW5zY2x1ZGVkIERPTSBvZiB0aGUgbmVhcmVzdCBwYXJlbnQgZGlyZWN0aXZlIHRoYXQgdXNlcyB0cmFuc2NsdXNpb24uCiAqCiAqIEFueSBleGlzdGluZyBjb250ZW50IG9mIHRoZSBlbGVtZW50IHRoYXQgdGhpcyBkaXJlY3RpdmUgaXMgcGxhY2VkIG9uIHdpbGwgYmUgcmVtb3ZlZCBiZWZvcmUgdGhlIHRyYW5zY2x1ZGVkIGNvbnRlbnQgaXMgaW5zZXJ0ZWQuCiAqCiAqIEBlbGVtZW50IEFOWQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9InRyYW5zY2x1ZGVFeGFtcGxlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCd0cmFuc2NsdWRlRXhhbXBsZScsIFtdKQogICAgICAgICAgLmRpcmVjdGl2ZSgncGFuZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgICAgICAgICBzY29wZTogeyB0aXRsZTonQCcgfSwKICAgICAgICAgICAgICAgdGVtcGxhdGU6ICc8ZGl2IHN0eWxlPSJib3JkZXI6IDFweCBzb2xpZCBibGFjazsiPicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjogZ3JheSI+e3t0aXRsZX19PC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICc8bmctdHJhbnNjbHVkZT48L25nLXRyYW5zY2x1ZGU+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JwogICAgICAgICAgICAgfTsKICAgICAgICAgfSkKICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudGl0bGUgPSAnTG9yZW0gSXBzdW0nOwogICAgICAgICAgICRzY29wZS50ZXh0ID0gJ05lcXVlIHBvcnJvIHF1aXNxdWFtIGVzdCBxdWkgZG9sb3JlbSBpcHN1bSBxdWlhIGRvbG9yLi4uJzsKICAgICAgICAgfV0pOwogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgPGlucHV0IG5nLW1vZGVsPSJ0aXRsZSI+PGJyPgogICAgICAgICA8dGV4dGFyZWEgbmctbW9kZWw9InRleHQiPjwvdGV4dGFyZWE+IDxici8+CiAgICAgICAgIDxwYW5lIHRpdGxlPSJ7e3RpdGxlfX0iPnt7dGV4dH19PC9wYW5lPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIGl0KCdzaG91bGQgaGF2ZSB0cmFuc2NsdWRlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHRpdGxlRWxlbWVudCA9IGVsZW1lbnQoYnkubW9kZWwoJ3RpdGxlJykpOwogICAgICAgICAgdGl0bGVFbGVtZW50LmNsZWFyKCk7CiAgICAgICAgICB0aXRsZUVsZW1lbnQuc2VuZEtleXMoJ1RJVExFJyk7CiAgICAgICAgICB2YXIgdGV4dEVsZW1lbnQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd0ZXh0JykpOwogICAgICAgICAgdGV4dEVsZW1lbnQuY2xlYXIoKTsKICAgICAgICAgIHRleHRFbGVtZW50LnNlbmRLZXlzKCdURVhUJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd0aXRsZScpKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1RJVExFJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd0ZXh0JykpLmdldFRleHQoKSkudG9FcXVhbCgnVEVYVCcpOwogICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKgogKi8KdmFyIG5nVHJhbnNjbHVkZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICByZXN0cmljdDogJ0VBQycsCiAgbGluazogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzLCBjb250cm9sbGVyLCAkdHJhbnNjbHVkZSkgewogICAgaWYgKCEkdHJhbnNjbHVkZSkgewogICAgICB0aHJvdyBtaW5FcnIoJ25nVHJhbnNjbHVkZScpKCdvcnBoYW4nLAogICAgICAgJ0lsbGVnYWwgdXNlIG9mIG5nVHJhbnNjbHVkZSBkaXJlY3RpdmUgaW4gdGhlIHRlbXBsYXRlISAnICsKICAgICAgICdObyBwYXJlbnQgZGlyZWN0aXZlIHRoYXQgcmVxdWlyZXMgYSB0cmFuc2NsdXNpb24gZm91bmQuICcgKwogICAgICAgJ0VsZW1lbnQ6IHswfScsCiAgICAgICBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgfQoKICAgICR0cmFuc2NsdWRlKGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICRlbGVtZW50LmVtcHR5KCk7CiAgICAgICRlbGVtZW50LmFwcGVuZChjbG9uZSk7CiAgICB9KTsKICB9Cn0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgc2NyaXB0CiAqIEByZXN0cmljdCBFCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBMb2FkIHRoZSBjb250ZW50IG9mIGEgYDxzY3JpcHQ+YCBlbGVtZW50IGludG8ge0BsaW5rIG5nLiR0ZW1wbGF0ZUNhY2hlIGAkdGVtcGxhdGVDYWNoZWB9LCBzbyB0aGF0IHRoZQogKiB0ZW1wbGF0ZSBjYW4gYmUgdXNlZCBieSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSBgbmdJbmNsdWRlYH0sCiAqIHtAbGluayBuZ1JvdXRlLmRpcmVjdGl2ZTpuZ1ZpZXcgYG5nVmlld2B9LCBvciB7QGxpbmsgZ3VpZGUvZGlyZWN0aXZlIGRpcmVjdGl2ZXN9LiBUaGUgdHlwZSBvZiB0aGUKICogYDxzY3JpcHQ+YCBlbGVtZW50IG11c3QgYmUgc3BlY2lmaWVkIGFzIGB0ZXh0L25nLXRlbXBsYXRlYCwgYW5kIGEgY2FjaGUgbmFtZSBmb3IgdGhlIHRlbXBsYXRlIG11c3QgYmUKICogYXNzaWduZWQgdGhyb3VnaCB0aGUgZWxlbWVudCdzIGBpZGAsIHdoaWNoIGNhbiB0aGVuIGJlIHVzZWQgYXMgYSBkaXJlY3RpdmUncyBgdGVtcGxhdGVVcmxgLgogKgogKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBNdXN0IGJlIHNldCB0byBgJ3RleHQvbmctdGVtcGxhdGUnYC4KICogQHBhcmFtIHtzdHJpbmd9IGlkIENhY2hlIG5hbWUgb2YgdGhlIHRlbXBsYXRlLgogKgogKiBAZXhhbXBsZQogIDxleGFtcGxlPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9Ii90cGwuaHRtbCI+CiAgICAgICAgQ29udGVudCBvZiB0aGUgdGVtcGxhdGUuCiAgICAgIDwvc2NyaXB0PgoKICAgICAgPGEgbmctY2xpY2s9ImN1cnJlbnRUcGw9Jy90cGwuaHRtbCciIGlkPSJ0cGwtbGluayI+TG9hZCBpbmxpbmVkIHRlbXBsYXRlPC9hPgogICAgICA8ZGl2IGlkPSJ0cGwtY29udGVudCIgbmctaW5jbHVkZSBzcmM9ImN1cnJlbnRUcGwiPjwvZGl2PgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZSBkZWZpbmVkIGluc2lkZSBzY3JpcHQgdGFnJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZWxlbWVudChieS5jc3MoJyN0cGwtbGluaycpKS5jbGljaygpOwogICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnI3RwbC1jb250ZW50JykpLmdldFRleHQoKSkudG9NYXRjaCgvQ29udGVudCBvZiB0aGUgdGVtcGxhdGUvKTsKICAgICAgfSk7CiAgICA8L2ZpbGU+CiAgPC9leGFtcGxlPgogKi8KdmFyIHNjcmlwdERpcmVjdGl2ZSA9IFsnJHRlbXBsYXRlQ2FjaGUnLCBmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgdGVybWluYWw6IHRydWUsCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgIGlmIChhdHRyLnR5cGUgPT0gJ3RleHQvbmctdGVtcGxhdGUnKSB7CiAgICAgICAgdmFyIHRlbXBsYXRlVXJsID0gYXR0ci5pZCwKICAgICAgICAgICAgLy8gSUUgaXMgbm90IGNvbnNpc3RlbnQsIGluIHNjcmlwdHMgd2UgaGF2ZSB0byByZWFkIC50ZXh0IGJ1dCBpbiBvdGhlciBub2RlcyB3ZSBoYXZlIHRvIHJlYWQgLnRleHRDb250ZW50CiAgICAgICAgICAgIHRleHQgPSBlbGVtZW50WzBdLnRleHQ7CgogICAgICAgICR0ZW1wbGF0ZUNhY2hlLnB1dCh0ZW1wbGF0ZVVybCwgdGV4dCk7CiAgICAgIH0KICAgIH0KICB9Owp9XTsKCnZhciBuZ09wdGlvbnNNaW5FcnIgPSBtaW5FcnIoJ25nT3B0aW9ucycpOwovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBzZWxlY3QKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIEhUTUwgYFNFTEVDVGAgZWxlbWVudCB3aXRoIGFuZ3VsYXIgZGF0YS1iaW5kaW5nLgogKgogKiAjIGBuZ09wdGlvbnNgCiAqCiAqIFRoZSBgbmdPcHRpb25zYCBhdHRyaWJ1dGUgY2FuIGJlIHVzZWQgdG8gZHluYW1pY2FsbHkgZ2VuZXJhdGUgYSBsaXN0IG9mIGA8b3B0aW9uPmAKICogZWxlbWVudHMgZm9yIHRoZSBgPHNlbGVjdD5gIGVsZW1lbnQgdXNpbmcgdGhlIGFycmF5IG9yIG9iamVjdCBvYnRhaW5lZCBieSBldmFsdWF0aW5nIHRoZQogKiBgbmdPcHRpb25zYCBjb21wcmVoZW5zaW9uX2V4cHJlc3Npb24uCiAqCiAqIFdoZW4gYW4gaXRlbSBpbiB0aGUgYDxzZWxlY3Q+YCBtZW51IGlzIHNlbGVjdGVkLCB0aGUgYXJyYXkgZWxlbWVudCBvciBvYmplY3QgcHJvcGVydHkKICogcmVwcmVzZW50ZWQgYnkgdGhlIHNlbGVjdGVkIG9wdGlvbiB3aWxsIGJlIGJvdW5kIHRvIHRoZSBtb2RlbCBpZGVudGlmaWVkIGJ5IHRoZSBgbmdNb2RlbGAKICogZGlyZWN0aXZlLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlOioqIGBuZ01vZGVsYCBjb21wYXJlcyBieSByZWZlcmVuY2UsIG5vdCB2YWx1ZS4gVGhpcyBpcyBpbXBvcnRhbnQgd2hlbiBiaW5kaW5nIHRvIGFuCiAqIGFycmF5IG9mIG9iamVjdHMuIFNlZSBhbiBleGFtcGxlIFtpbiB0aGlzIGpzZmlkZGxlXShodHRwOi8vanNmaWRkbGUubmV0L3FXelRiLykuCiAqIDwvZGl2PgogKgogKiBPcHRpb25hbGx5LCBhIHNpbmdsZSBoYXJkLWNvZGVkIGA8b3B0aW9uPmAgZWxlbWVudCwgd2l0aCB0aGUgdmFsdWUgc2V0IHRvIGFuIGVtcHR5IHN0cmluZywgY2FuCiAqIGJlIG5lc3RlZCBpbnRvIHRoZSBgPHNlbGVjdD5gIGVsZW1lbnQuIFRoaXMgZWxlbWVudCB3aWxsIHRoZW4gcmVwcmVzZW50IHRoZSBgbnVsbGAgb3IgIm5vdCBzZWxlY3RlZCIKICogb3B0aW9uLiBTZWUgZXhhbXBsZSBiZWxvdyBmb3IgZGVtb25zdHJhdGlvbi4KICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAqICoqTm90ZToqKiBgbmdPcHRpb25zYCBwcm92aWRlcyBhbiBpdGVyYXRvciBmYWNpbGl0eSBmb3IgdGhlIGA8b3B0aW9uPmAgZWxlbWVudCB3aGljaCBzaG91bGQgYmUgdXNlZCBpbnN0ZWFkCiAqIG9mIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9IHdoZW4geW91IHdhbnQgdGhlCiAqIGBzZWxlY3RgIG1vZGVsIHRvIGJlIGJvdW5kIHRvIGEgbm9uLXN0cmluZyB2YWx1ZS4gVGhpcyBpcyBiZWNhdXNlIGFuIG9wdGlvbiBlbGVtZW50IGNhbiBvbmx5CiAqIGJlIGJvdW5kIHRvIHN0cmluZyB2YWx1ZXMgYXQgcHJlc2VudC4KICogPC9kaXY+CiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LWluZm8iPgogKiAqKk5vdGU6KiogVXNpbmcgYHNlbGVjdCBhc2Agd2lsbCBiaW5kIHRoZSByZXN1bHQgb2YgdGhlIGBzZWxlY3QgYXNgIGV4cHJlc3Npb24gdG8gdGhlIG1vZGVsLCBidXQKICogdGhlIHZhbHVlIG9mIHRoZSBgPHNlbGVjdD5gIGFuZCBgPG9wdGlvbj5gIGh0bWwgZWxlbWVudHMgd2lsbCBiZSBlaXRoZXIgdGhlIGluZGV4IChmb3IgYXJyYXkgZGF0YSBzb3VyY2VzKQogKiBvciBwcm9wZXJ0eSBuYW1lIChmb3Igb2JqZWN0IGRhdGEgc291cmNlcykgb2YgdGhlIHZhbHVlIHdpdGhpbiB0aGUgY29sbGVjdGlvbi4KICogPC9kaXY+CiAqCiAqICoqTm90ZToqKiBVc2luZyBgc2VsZWN0IGFzYCB0b2dldGhlciB3aXRoIGB0cmFja2V4cHJgIGlzIG5vdCByZWNvbW1lbmRlZC4KICogUmVhc29uaW5nOgogKiAtIEV4YW1wbGU6ICZsdDtzZWxlY3Qgbmctb3B0aW9ucz0iaXRlbS5zdWJJdGVtIGFzIGl0ZW0ubGFiZWwgZm9yIGl0ZW0gaW4gdmFsdWVzIHRyYWNrIGJ5IGl0ZW0uaWQiIG5nLW1vZGVsPSJzZWxlY3RlZCImZ3Q7CiAqICAgdmFsdWVzOiBbe2lkOiAxLCBsYWJlbDogJ2FMYWJlbCcsIHN1Ykl0ZW06IHtuYW1lOiAnYVN1Ykl0ZW0nfX0sIHtpZDogMiwgbGFiZWw6ICdiTGFiZWwnLCBzdWJJdGVtOiB7bmFtZTogJ2JTdWJJdGVtJ319XSwKICogICAkc2NvcGUuc2VsZWN0ZWQgPSB7bmFtZTogJ2FTdWJJdGVtJ307CiAqIC0gdHJhY2sgYnkgaXMgYWx3YXlzIGFwcGxpZWQgdG8gYHZhbHVlYCwgd2l0aCB0aGUgcHVycG9zZSBvZiBwcmVzZXJ2aW5nIHRoZSBzZWxlY3Rpb24sCiAqICAgKHRvIGBpdGVtYCBpbiB0aGlzIGNhc2UpCiAqIC0gdG8gY2FsY3VsYXRlIHdoZXRoZXIgYW4gaXRlbSBpcyBzZWxlY3RlZCB3ZSBkbyB0aGUgZm9sbG93aW5nOgogKiAgIDEuIGFwcGx5IGB0cmFjayBieWAgdG8gdGhlIHZhbHVlcyBpbiB0aGUgYXJyYXksIGUuZy4KICogICAgICBJbiB0aGUgZXhhbXBsZTogWzEsMl0KICogICAyLiBhcHBseSBgdHJhY2sgYnlgIHRvIHRoZSBhbHJlYWR5IHNlbGVjdGVkIHZhbHVlIGluIGBuZ01vZGVsYDoKICogICAgICBJbiB0aGUgZXhhbXBsZTogdGhpcyBpcyBub3QgcG9zc2libGUsIGFzIGB0cmFjayBieWAgcmVmZXJzIHRvIGBpdGVtLmlkYCwgYnV0IHRoZSBzZWxlY3RlZAogKiAgICAgIHZhbHVlIGZyb20gYG5nTW9kZWxgIGlzIGB7bmFtZTogYVN1Ykl0ZW19YC4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgVGhlIGNvbnRyb2wgaXMgY29uc2lkZXJlZCB2YWxpZCBvbmx5IGlmIHZhbHVlIGlzIGVudGVyZWQuCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICogQHBhcmFtIHtjb21wcmVoZW5zaW9uX2V4cHJlc3Npb249fSBuZ09wdGlvbnMgaW4gb25lIG9mIHRoZSBmb2xsb3dpbmcgZm9ybXM6CiAqCiAqICAgKiBmb3IgYXJyYXkgZGF0YSBzb3VyY2VzOgogKiAgICAgKiBgbGFiZWxgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAqICAgICAqIGBsYWJlbGAgICoqYGdyb3VwIGJ5YCoqIGBncm91cGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGdyb3VwIGJ5YCoqIGBncm91cGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YCAqKmB0cmFjayBieWAqKiBgdHJhY2tleHByYAogKiAgICogZm9yIG9iamVjdCBkYXRhIHNvdXJjZXM6CiAqICAgICAqIGBsYWJlbGAgKipgZm9yIChgKipga2V5YCAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZm9yIChgKipga2V5YCAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAqICAgICAqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3IgKGAqKmBrZXlgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGdyb3VwIGJ5YCoqIGBncm91cGAKICogICAgICAgICAqKmBmb3JgIGAoYCoqYGtleWAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAqCiAqIFdoZXJlOgogKgogKiAgICogYGFycmF5YCAvIGBvYmplY3RgOiBhbiBleHByZXNzaW9uIHdoaWNoIGV2YWx1YXRlcyB0byBhbiBhcnJheSAvIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAqICAgKiBgdmFsdWVgOiBsb2NhbCB2YXJpYWJsZSB3aGljaCB3aWxsIHJlZmVyIHRvIGVhY2ggaXRlbSBpbiB0aGUgYGFycmF5YCBvciBlYWNoIHByb3BlcnR5IHZhbHVlCiAqICAgICAgb2YgYG9iamVjdGAgZHVyaW5nIGl0ZXJhdGlvbi4KICogICAqIGBrZXlgOiBsb2NhbCB2YXJpYWJsZSB3aGljaCB3aWxsIHJlZmVyIHRvIGEgcHJvcGVydHkgbmFtZSBpbiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogKiAgICogYGxhYmVsYDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSB0aGUgbGFiZWwgZm9yIGA8b3B0aW9uPmAgZWxlbWVudC4gVGhlCiAqICAgICBgZXhwcmVzc2lvbmAgd2lsbCBtb3N0IGxpa2VseSByZWZlciB0byB0aGUgYHZhbHVlYCB2YXJpYWJsZSAoZS5nLiBgdmFsdWUucHJvcGVydHlOYW1lYCkuCiAqICAgKiBgc2VsZWN0YDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSBib3VuZCB0byB0aGUgbW9kZWwgb2YgdGhlIHBhcmVudCBgPHNlbGVjdD5gCiAqICAgICAgZWxlbWVudC4gSWYgbm90IHNwZWNpZmllZCwgYHNlbGVjdGAgZXhwcmVzc2lvbiB3aWxsIGRlZmF1bHQgdG8gYHZhbHVlYC4KICogICAqIGBncm91cGA6IFRoZSByZXN1bHQgb2YgdGhpcyBleHByZXNzaW9uIHdpbGwgYmUgdXNlZCB0byBncm91cCBvcHRpb25zIHVzaW5nIHRoZSBgPG9wdGdyb3VwPmAKICogICAgICBET00gZWxlbWVudC4KICogICAqIGB0cmFja2V4cHJgOiBVc2VkIHdoZW4gd29ya2luZyB3aXRoIGFuIGFycmF5IG9mIG9iamVjdHMuIFRoZSByZXN1bHQgb2YgdGhpcyBleHByZXNzaW9uIHdpbGwgYmUKICogICAgICB1c2VkIHRvIGlkZW50aWZ5IHRoZSBvYmplY3RzIGluIHRoZSBhcnJheS4gVGhlIGB0cmFja2V4cHJgIHdpbGwgbW9zdCBsaWtlbHkgcmVmZXIgdG8gdGhlCiAqICAgICBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4gV2l0aCB0aGlzIHRoZSBzZWxlY3Rpb24gaXMgcHJlc2VydmVkCiAqICAgICAgZXZlbiB3aGVuIHRoZSBvcHRpb25zIGFyZSByZWNyZWF0ZWQgKGUuZy4gcmVsb2FkZWQgZnJvbSB0aGUgc2VydmVyKS4KICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlIG1vZHVsZT0ic2VsZWN0RXhhbXBsZSI+CiAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgIDxzY3JpcHQ+CiAgICAgICAgYW5ndWxhci5tb2R1bGUoJ3NlbGVjdEV4YW1wbGUnLCBbXSkKICAgICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAgICRzY29wZS5jb2xvcnMgPSBbCiAgICAgICAgICAgICAge25hbWU6J2JsYWNrJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAgICB7bmFtZTond2hpdGUnLCBzaGFkZTonbGlnaHQnfSwKICAgICAgICAgICAgICB7bmFtZToncmVkJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAgICB7bmFtZTonYmx1ZScsIHNoYWRlOidkYXJrJ30sCiAgICAgICAgICAgICAge25hbWU6J3llbGxvdycsIHNoYWRlOidsaWdodCd9CiAgICAgICAgICAgIF07CiAgICAgICAgICAgICRzY29wZS5teUNvbG9yID0gJHNjb3BlLmNvbG9yc1syXTsgLy8gcmVkCiAgICAgICAgICB9XSk7CiAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICAgICA8dWw+CiAgICAgICAgICAgIDxsaSBuZy1yZXBlYXQ9ImNvbG9yIGluIGNvbG9ycyI+CiAgICAgICAgICAgICAgTmFtZTogPGlucHV0IG5nLW1vZGVsPSJjb2xvci5uYW1lIj4KICAgICAgICAgICAgICBbPGEgaHJlZiBuZy1jbGljaz0iY29sb3JzLnNwbGljZSgkaW5kZXgsIDEpIj5YPC9hPl0KICAgICAgICAgICAgPC9saT4KICAgICAgICAgICAgPGxpPgogICAgICAgICAgICAgIFs8YSBocmVmIG5nLWNsaWNrPSJjb2xvcnMucHVzaCh7fSkiPmFkZDwvYT5dCiAgICAgICAgICAgIDwvbGk+CiAgICAgICAgICA8L3VsPgogICAgICAgICAgPGhyLz4KICAgICAgICAgIENvbG9yIChudWxsIG5vdCBhbGxvd2VkKToKICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9Im15Q29sb3IiIG5nLW9wdGlvbnM9ImNvbG9yLm5hbWUgZm9yIGNvbG9yIGluIGNvbG9ycyI+PC9zZWxlY3Q+PGJyPgoKICAgICAgICAgIENvbG9yIChudWxsIGFsbG93ZWQpOgogICAgICAgICAgPHNwYW4gIGNsYXNzPSJudWxsYWJsZSI+CiAgICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9Im15Q29sb3IiIG5nLW9wdGlvbnM9ImNvbG9yLm5hbWUgZm9yIGNvbG9yIGluIGNvbG9ycyI+CiAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj4tLSBjaG9vc2UgY29sb3IgLS08L29wdGlvbj4KICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICA8L3NwYW4+PGJyLz4KCiAgICAgICAgICBDb2xvciBncm91cGVkIGJ5IHNoYWRlOgogICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0ibXlDb2xvciIgbmctb3B0aW9ucz0iY29sb3IubmFtZSBncm91cCBieSBjb2xvci5zaGFkZSBmb3IgY29sb3IgaW4gY29sb3JzIj4KICAgICAgICAgIDwvc2VsZWN0Pjxici8+CgoKICAgICAgICAgIFNlbGVjdCA8YSBocmVmIG5nLWNsaWNrPSJteUNvbG9yID0geyBuYW1lOidub3QgaW4gbGlzdCcsIHNoYWRlOiAnb3RoZXInIH0iPmJvZ3VzPC9hPi48YnI+CiAgICAgICAgICA8aHIvPgogICAgICAgICAgQ3VycmVudGx5IHNlbGVjdGVkOiB7eyB7c2VsZWN0ZWRfY29sb3I6bXlDb2xvcn0gfX0KICAgICAgICAgIDxkaXYgc3R5bGU9ImJvcmRlcjpzb2xpZCAxcHggYmxhY2s7IGhlaWdodDoyMHB4IgogICAgICAgICAgICAgICBuZy1zdHlsZT0ieydiYWNrZ3JvdW5kLWNvbG9yJzpteUNvbG9yLm5hbWV9Ij4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLW9wdGlvbnMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6bXlDb2xvcn0nKSkuZ2V0VGV4dCgpKS50b01hdGNoKCdyZWQnKTsKICAgICAgICAgICBlbGVtZW50LmFsbChieS5tb2RlbCgnbXlDb2xvcicpKS5maXJzdCgpLmNsaWNrKCk7CiAgICAgICAgICAgZWxlbWVudC5hbGwoYnkuY3NzKCdzZWxlY3RbbmctbW9kZWw9Im15Q29sb3IiXSBvcHRpb24nKSkuZmlyc3QoKS5jbGljaygpOwogICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3tzZWxlY3RlZF9jb2xvcjpteUNvbG9yfScpKS5nZXRUZXh0KCkpLnRvTWF0Y2goJ2JsYWNrJyk7CiAgICAgICAgICAgZWxlbWVudChieS5jc3MoJy5udWxsYWJsZSBzZWxlY3RbbmctbW9kZWw9Im15Q29sb3IiXScpKS5jbGljaygpOwogICAgICAgICAgIGVsZW1lbnQuYWxsKGJ5LmNzcygnLm51bGxhYmxlIHNlbGVjdFtuZy1tb2RlbD0ibXlDb2xvciJdIG9wdGlvbicpKS5maXJzdCgpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygne3NlbGVjdGVkX2NvbG9yOm15Q29sb3J9JykpLmdldFRleHQoKSkudG9NYXRjaCgnbnVsbCcpOwogICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KCnZhciBuZ09wdGlvbnNEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICByZXN0cmljdDogJ0EnLAogIHRlcm1pbmFsOiB0cnVlCn0pOwoKLy8ganNoaW50IG1heGxlbjogZmFsc2UKdmFyIHNlbGVjdERpcmVjdGl2ZSA9IFsnJGNvbXBpbGUnLCAnJHBhcnNlJywgZnVuY3Rpb24oJGNvbXBpbGUsICAgJHBhcnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAvLzAwMDAxMTExMTExMTExMDAwMDAwMDAwMDAyMjIyMjIyMjIyMDAwMDAwMDAwMDAwMDAwMDAwMDAwMzMzMzMzMzMzMzAwMDAwMDAwMDAwMDAwNDQ0NDQ0NDQ0NDQ0NDQ0MDAwMDAwMDAwNTU1NTU1NTU1NTU1NTU1MDAwMDAwMDY2NjY2NjY2NjY2NjY2NjAwMDAwMDAwMDAwMDAwMDc3Nzc3Nzc3NzcwMDAwMDAwMDAwMDAwMDAwMDAwODg4ODg4ODg4OAogIHZhciBOR19PUFRJT05TX1JFR0VYUCA9IC9eXHMqKFtcc1xTXSs/KSg/OlxzK2FzXHMrKFtcc1xTXSs/KSk/KD86XHMrZ3JvdXBccytieVxzKyhbXHNcU10rPykpP1xzK2ZvclxzKyg/OihbXCRcd11bXCRcd10qKXwoPzpcKFxzKihbXCRcd11bXCRcd10qKVxzKixccyooW1wkXHddW1wkXHddKilccypcKSkpXHMraW5ccysoW1xzXFNdKz8pKD86XHMrdHJhY2tccytieVxzKyhbXHNcU10rPykpPyQvLAogICAgICBudWxsTW9kZWxDdHJsID0geyRzZXRWaWV3VmFsdWU6IG5vb3B9OwovLyBqc2hpbnQgbWF4bGVuOiAxMDAKCiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXF1aXJlOiBbJ3NlbGVjdCcsICc/bmdNb2RlbCddLAogICAgY29udHJvbGxlcjogWyckZWxlbWVudCcsICckc2NvcGUnLCAnJGF0dHJzJywgZnVuY3Rpb24oJGVsZW1lbnQsICRzY29wZSwgJGF0dHJzKSB7CiAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgIG9wdGlvbnNNYXAgPSB7fSwKICAgICAgICAgIG5nTW9kZWxDdHJsID0gbnVsbE1vZGVsQ3RybCwKICAgICAgICAgIG51bGxPcHRpb24sCiAgICAgICAgICB1bmtub3duT3B0aW9uOwoKCiAgICAgIHNlbGYuZGF0YWJvdW5kID0gJGF0dHJzLm5nTW9kZWw7CgoKICAgICAgc2VsZi5pbml0ID0gZnVuY3Rpb24obmdNb2RlbEN0cmxfLCBudWxsT3B0aW9uXywgdW5rbm93bk9wdGlvbl8pIHsKICAgICAgICBuZ01vZGVsQ3RybCA9IG5nTW9kZWxDdHJsXzsKICAgICAgICBudWxsT3B0aW9uID0gbnVsbE9wdGlvbl87CiAgICAgICAgdW5rbm93bk9wdGlvbiA9IHVua25vd25PcHRpb25fOwogICAgICB9OwoKCiAgICAgIHNlbGYuYWRkT3B0aW9uID0gZnVuY3Rpb24odmFsdWUsIGVsZW1lbnQpIHsKICAgICAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eSh2YWx1ZSwgJyJvcHRpb24gdmFsdWUiJyk7CiAgICAgICAgb3B0aW9uc01hcFt2YWx1ZV0gPSB0cnVlOwoKICAgICAgICBpZiAobmdNb2RlbEN0cmwuJHZpZXdWYWx1ZSA9PSB2YWx1ZSkgewogICAgICAgICAgJGVsZW1lbnQudmFsKHZhbHVlKTsKICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgIH0KICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9MzgxNDU5CiAgICAgICAgLy8gQWRkaW5nIGFuIDxvcHRpb24gc2VsZWN0ZWQ9InNlbGVjdGVkIj4gZWxlbWVudCB0byBhIDxzZWxlY3QgcmVxdWlyZWQ9InJlcXVpcmVkIj4gc2hvdWxkCiAgICAgICAgLy8gYXV0b21hdGljYWxseSBzZWxlY3QgdGhlIG5ldyBlbGVtZW50CiAgICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudFswXS5oYXNBdHRyaWJ1dGUoJ3NlbGVjdGVkJykpIHsKICAgICAgICAgIGVsZW1lbnRbMF0uc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfTsKCgogICAgICBzZWxmLnJlbW92ZU9wdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKHRoaXMuaGFzT3B0aW9uKHZhbHVlKSkgewogICAgICAgICAgZGVsZXRlIG9wdGlvbnNNYXBbdmFsdWVdOwogICAgICAgICAgaWYgKG5nTW9kZWxDdHJsLiR2aWV3VmFsdWUgPT0gdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJVbmtub3duT3B0aW9uKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CgoKICAgICAgc2VsZi5yZW5kZXJVbmtub3duT3B0aW9uID0gZnVuY3Rpb24odmFsKSB7CiAgICAgICAgdmFyIHVua25vd25WYWwgPSAnPyAnICsgaGFzaEtleSh2YWwpICsgJyA/JzsKICAgICAgICB1bmtub3duT3B0aW9uLnZhbCh1bmtub3duVmFsKTsKICAgICAgICAkZWxlbWVudC5wcmVwZW5kKHVua25vd25PcHRpb24pOwogICAgICAgICRlbGVtZW50LnZhbCh1bmtub3duVmFsKTsKICAgICAgICB1bmtub3duT3B0aW9uLnByb3AoJ3NlbGVjdGVkJywgdHJ1ZSk7IC8vIG5lZWRlZCBmb3IgSUUKICAgICAgfTsKCgogICAgICBzZWxmLmhhc09wdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIG9wdGlvbnNNYXAuaGFzT3duUHJvcGVydHkodmFsdWUpOwogICAgICB9OwoKICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAvLyBkaXNhYmxlIHVua25vd24gb3B0aW9uIHNvIHRoYXQgd2UgZG9uJ3QgZG8gd29yayB3aGVuIHRoZSB3aG9sZSBzZWxlY3QgaXMgYmVpbmcgZGVzdHJveWVkCiAgICAgICAgc2VsZi5yZW5kZXJVbmtub3duT3B0aW9uID0gbm9vcDsKICAgICAgfSk7CiAgICB9XSwKCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybHMpIHsKICAgICAgLy8gaWYgbmdNb2RlbCBpcyBub3QgZGVmaW5lZCwgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZwogICAgICBpZiAoIWN0cmxzWzFdKSByZXR1cm47CgogICAgICB2YXIgc2VsZWN0Q3RybCA9IGN0cmxzWzBdLAogICAgICAgICAgbmdNb2RlbEN0cmwgPSBjdHJsc1sxXSwKICAgICAgICAgIG11bHRpcGxlID0gYXR0ci5tdWx0aXBsZSwKICAgICAgICAgIG9wdGlvbnNFeHAgPSBhdHRyLm5nT3B0aW9ucywKICAgICAgICAgIG51bGxPcHRpb24gPSBmYWxzZSwgLy8gaWYgZmFsc2UsIHVzZXIgd2lsbCBub3QgYmUgYWJsZSB0byBzZWxlY3QgaXQgKHVzZWQgYnkgbmdPcHRpb25zKQogICAgICAgICAgZW1wdHlPcHRpb24sCiAgICAgICAgICByZW5kZXJTY2hlZHVsZWQgPSBmYWxzZSwKICAgICAgICAgIC8vIHdlIGNhbid0IGp1c3QganFMaXRlKCc8b3B0aW9uPicpIHNpbmNlIGpxTGl0ZSBpcyBub3Qgc21hcnQgZW5vdWdoCiAgICAgICAgICAvLyB0byBjcmVhdGUgaXQgaW4gPHNlbGVjdD4gYW5kIElFIGJhcmZzIG90aGVyd2lzZS4KICAgICAgICAgIG9wdGlvblRlbXBsYXRlID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpKSwKICAgICAgICAgIG9wdEdyb3VwVGVtcGxhdGUgPWpxTGl0ZShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRncm91cCcpKSwKICAgICAgICAgIHVua25vd25PcHRpb24gPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpOwoKICAgICAgLy8gZmluZCAibnVsbCIgb3B0aW9uCiAgICAgIGZvcih2YXIgaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZHJlbigpLCBpaSA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICBpZiAoY2hpbGRyZW5baV0udmFsdWUgPT09ICcnKSB7CiAgICAgICAgICBlbXB0eU9wdGlvbiA9IG51bGxPcHRpb24gPSBjaGlsZHJlbi5lcShpKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgc2VsZWN0Q3RybC5pbml0KG5nTW9kZWxDdHJsLCBudWxsT3B0aW9uLCB1bmtub3duT3B0aW9uKTsKCiAgICAgIC8vIHJlcXVpcmVkIHZhbGlkYXRvcgogICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICBuZ01vZGVsQ3RybC4kaXNFbXB0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIXZhbHVlIHx8IHZhbHVlLmxlbmd0aCA9PT0gMDsKICAgICAgICB9OwogICAgICB9CgogICAgICBpZiAob3B0aW9uc0V4cCkgc2V0dXBBc09wdGlvbnMoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsKTsKICAgICAgZWxzZSBpZiAobXVsdGlwbGUpIHNldHVwQXNNdWx0aXBsZShzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwpOwogICAgICBlbHNlIHNldHVwQXNTaW5nbGUoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKTsKCgogICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgoKCiAgICAgIGZ1bmN0aW9uIHNldHVwQXNTaW5nbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKSB7CiAgICAgICAgbmdNb2RlbEN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHZpZXdWYWx1ZSA9IG5nTW9kZWxDdHJsLiR2aWV3VmFsdWU7CgogICAgICAgICAgaWYgKHNlbGVjdEN0cmwuaGFzT3B0aW9uKHZpZXdWYWx1ZSkpIHsKICAgICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQudmFsKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgIGlmICh2aWV3VmFsdWUgPT09ICcnKSBlbXB0eU9wdGlvbi5wcm9wKCdzZWxlY3RlZCcsIHRydWUpOyAvLyB0byBtYWtlIElFOSBoYXBweQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZpZXdWYWx1ZSkgJiYgZW1wdHlPcHRpb24pIHsKICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnZhbCgnJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW5kZXJVbmtub3duT3B0aW9uKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBzZWxlY3RFbGVtZW50Lm9uKCdjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRzZXRWaWV3VmFsdWUoc2VsZWN0RWxlbWVudC52YWwoKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gc2V0dXBBc011bHRpcGxlKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBjdHJsKSB7CiAgICAgICAgdmFyIGxhc3RWaWV3OwogICAgICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGl0ZW1zID0gbmV3IEhhc2hNYXAoY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgIGZvckVhY2goc2VsZWN0RWxlbWVudC5maW5kKCdvcHRpb24nKSwgZnVuY3Rpb24ob3B0aW9uKSB7CiAgICAgICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IGlzRGVmaW5lZChpdGVtcy5nZXQob3B0aW9uLnZhbHVlKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICAvLyB3ZSBoYXZlIHRvIGRvIGl0IG9uIGVhY2ggd2F0Y2ggc2luY2UgbmdNb2RlbCB3YXRjaGVzIHJlZmVyZW5jZSwgYnV0CiAgICAgICAgLy8gd2UgbmVlZCB0byB3b3JrIG9mIGFuIGFycmF5LCBzbyB3ZSBuZWVkIHRvIHNlZSBpZiBhbnl0aGluZyB3YXMgaW5zZXJ0ZWQvcmVtb3ZlZAogICAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBzZWxlY3RNdWx0aXBsZVdhdGNoKCkgewogICAgICAgICAgaWYgKCFlcXVhbHMobGFzdFZpZXcsIGN0cmwuJHZpZXdWYWx1ZSkpIHsKICAgICAgICAgICAgbGFzdFZpZXcgPSBzaGFsbG93Q29weShjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICBjdHJsLiRyZW5kZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgc2VsZWN0RWxlbWVudC5vbignY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uKG9wdGlvbikgewogICAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgIGFycmF5LnB1c2gob3B0aW9uLnZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUoYXJyYXkpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHNldHVwQXNPcHRpb25zKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBjdHJsKSB7CiAgICAgICAgdmFyIG1hdGNoOwoKICAgICAgICBpZiAoIShtYXRjaCA9IG9wdGlvbnNFeHAubWF0Y2goTkdfT1BUSU9OU19SRUdFWFApKSkgewogICAgICAgICAgdGhyb3cgbmdPcHRpb25zTWluRXJyKCdpZXhwJywKICAgICAgICAgICAgIkV4cGVjdGVkIGV4cHJlc3Npb24gaW4gZm9ybSBvZiAiICsKICAgICAgICAgICAgIidfc2VsZWN0XyAoYXMgX2xhYmVsXyk/IGZvciAoX2tleV8sKT9fdmFsdWVfIGluIF9jb2xsZWN0aW9uXyciICsKICAgICAgICAgICAgIiBidXQgZ290ICd7MH0nLiBFbGVtZW50OiB7MX0iLAogICAgICAgICAgICBvcHRpb25zRXhwLCBzdGFydGluZ1RhZyhzZWxlY3RFbGVtZW50KSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgZGlzcGxheUZuID0gJHBhcnNlKG1hdGNoWzJdIHx8IG1hdGNoWzFdKSwKICAgICAgICAgICAgdmFsdWVOYW1lID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNl0sCiAgICAgICAgICAgIHNlbGVjdEFzID0gLyBhcyAvLnRlc3QobWF0Y2hbMF0pICYmIG1hdGNoWzFdLAogICAgICAgICAgICBzZWxlY3RBc0ZuID0gc2VsZWN0QXMgPyAkcGFyc2Uoc2VsZWN0QXMpIDogbnVsbCwKICAgICAgICAgICAga2V5TmFtZSA9IG1hdGNoWzVdLAogICAgICAgICAgICBncm91cEJ5Rm4gPSAkcGFyc2UobWF0Y2hbM10gfHwgJycpLAogICAgICAgICAgICB2YWx1ZUZuID0gJHBhcnNlKG1hdGNoWzJdID8gbWF0Y2hbMV0gOiB2YWx1ZU5hbWUpLAogICAgICAgICAgICB2YWx1ZXNGbiA9ICRwYXJzZShtYXRjaFs3XSksCiAgICAgICAgICAgIHRyYWNrID0gbWF0Y2hbOF0sCiAgICAgICAgICAgIHRyYWNrRm4gPSB0cmFjayA/ICRwYXJzZShtYXRjaFs4XSkgOiBudWxsLAogICAgICAgICAgICAvLyBUaGlzIGlzIGFuIGFycmF5IG9mIGFycmF5IG9mIGV4aXN0aW5nIG9wdGlvbiBncm91cHMgaW4gRE9NLgogICAgICAgICAgICAvLyBXZSB0cnkgdG8gcmV1c2UgdGhlc2UgaWYgcG9zc2libGUKICAgICAgICAgICAgLy8gLSBvcHRpb25Hcm91cHNDYWNoZVswXSBpcyB0aGUgb3B0aW9ucyB3aXRoIG5vIG9wdGlvbiBncm91cAogICAgICAgICAgICAvLyAtIG9wdGlvbkdyb3Vwc0NhY2hlWz9dWzBdIGlzIHRoZSBwYXJlbnQ6IGVpdGhlciB0aGUgU0VMRUNUIG9yIE9QVEdST1VQIGVsZW1lbnQKICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUgPSBbW3tlbGVtZW50OiBzZWxlY3RFbGVtZW50LCBsYWJlbDonJ31dXSwKICAgICAgICAgICAgLy9yZS11c2FibGUgb2JqZWN0IHRvIHJlcHJlc2VudCBvcHRpb24ncyBsb2NhbHMKICAgICAgICAgICAgbG9jYWxzID0ge307CgogICAgICAgIGlmIChudWxsT3B0aW9uKSB7CiAgICAgICAgICAvLyBjb21waWxlIHRoZSBlbGVtZW50IHNpbmNlIHRoZXJlIG1pZ2h0IGJlIGJpbmRpbmdzIGluIGl0CiAgICAgICAgICAkY29tcGlsZShudWxsT3B0aW9uKShzY29wZSk7CgogICAgICAgICAgLy8gcmVtb3ZlIHRoZSBjbGFzcywgd2hpY2ggaXMgYWRkZWQgYXV0b21hdGljYWxseSBiZWNhdXNlIHdlIHJlY29tcGlsZSB0aGUgZWxlbWVudCBhbmQgaXQKICAgICAgICAgIC8vIGJlY29tZXMgdGhlIGNvbXBpbGF0aW9uIHJvb3QKICAgICAgICAgIG51bGxPcHRpb24ucmVtb3ZlQ2xhc3MoJ25nLXNjb3BlJyk7CgogICAgICAgICAgLy8gd2UgbmVlZCB0byByZW1vdmUgaXQgYmVmb3JlIGNhbGxpbmcgc2VsZWN0RWxlbWVudC5lbXB0eSgpIGJlY2F1c2Ugb3RoZXJ3aXNlIElFIHdpbGwKICAgICAgICAgIC8vIHJlbW92ZSB0aGUgbGFiZWwgZnJvbSB0aGUgZWxlbWVudC4gd3RmPwogICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmUoKTsKICAgICAgICB9CgogICAgICAgIC8vIGNsZWFyIGNvbnRlbnRzLCB3ZSdsbCBhZGQgd2hhdCdzIG5lZWRlZCBiYXNlZCBvbiB0aGUgbW9kZWwKICAgICAgICBzZWxlY3RFbGVtZW50LmVtcHR5KCk7CgogICAgICAgIHNlbGVjdEVsZW1lbnQub24oJ2NoYW5nZScsIHNlbGVjdGlvbkNoYW5nZWQpOwoKICAgICAgICBjdHJsLiRyZW5kZXIgPSByZW5kZXI7CgogICAgICAgIHNjb3BlLiR3YXRjaENvbGxlY3Rpb24odmFsdWVzRm4sIHNjaGVkdWxlUmVuZGVyaW5nKTsKICAgICAgICBzY29wZS4kd2F0Y2hDb2xsZWN0aW9uKGdldExhYmVscywgc2NoZWR1bGVSZW5kZXJpbmcpOwoKICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgIHNjb3BlLiR3YXRjaENvbGxlY3Rpb24oZnVuY3Rpb24oKSB7IHJldHVybiBjdHJsLiRtb2RlbFZhbHVlOyB9LCBzY2hlZHVsZVJlbmRlcmluZyk7CiAgICAgICAgfQoKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCiAgICAgICAgZnVuY3Rpb24gY2FsbEV4cHJlc3Npb24oZXhwckZuLCBrZXksIHZhbHVlKSB7CiAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IHZhbHVlOwogICAgICAgICAgaWYgKGtleU5hbWUpIGxvY2Fsc1trZXlOYW1lXSA9IGtleTsKICAgICAgICAgIHJldHVybiBleHByRm4oc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzZWxlY3Rpb25DaGFuZ2VkKCkgewogICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgb3B0aW9uR3JvdXAsCiAgICAgICAgICAgICAgICBjb2xsZWN0aW9uID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAgICAgICAga2V5LCB2YWx1ZSwgb3B0aW9uRWxlbWVudCwgaW5kZXgsIGdyb3VwSW5kZXgsIGxlbmd0aCwgZ3JvdXBMZW5ndGgsIHRyYWNrSW5kZXg7CiAgICAgICAgICAgIHZhciB2aWV3VmFsdWU7CiAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgIHZpZXdWYWx1ZSA9IFtdOwogICAgICAgICAgICAgIGZvckVhY2goc2VsZWN0RWxlbWVudC52YWwoKSwgZnVuY3Rpb24oc2VsZWN0ZWRLZXkpIHsKICAgICAgICAgICAgICAgIHZpZXdWYWx1ZS5wdXNoKGdldFZpZXdWYWx1ZShzZWxlY3RlZEtleSwgY29sbGVjdGlvbltzZWxlY3RlZEtleV0pKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgc2VsZWN0ZWRLZXkgPSBzZWxlY3RFbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgIHZpZXdWYWx1ZSA9IGdldFZpZXdWYWx1ZShzZWxlY3RlZEtleSwgY29sbGVjdGlvbltzZWxlY3RlZEtleV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZSh2aWV3VmFsdWUpOwogICAgICAgICAgICByZW5kZXIoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0Vmlld1ZhbHVlKGtleSwgdmFsdWUpIHsKICAgICAgICAgIGlmIChrZXkgPT09ICc/JykgewogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICcnKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHZpZXdWYWx1ZUZuID0gc2VsZWN0QXNGbiA/IHNlbGVjdEFzRm4gOiB2YWx1ZUZuOwogICAgICAgICAgICByZXR1cm4gY2FsbEV4cHJlc3Npb24odmlld1ZhbHVlRm4sIGtleSwgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0TGFiZWxzKCkgewogICAgICAgICAgdmFyIHZhbHVlcyA9IHZhbHVlc0ZuKHNjb3BlKTsKICAgICAgICAgIHZhciB0b0Rpc3BsYXk7CiAgICAgICAgICBpZiAodmFsdWVzICYmIGlzQXJyYXkodmFsdWVzKSkgewogICAgICAgICAgICB0b0Rpc3BsYXkgPSBuZXcgQXJyYXkodmFsdWVzLmxlbmd0aCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IHZhbHVlcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgdG9EaXNwbGF5W2ldID0gY2FsbEV4cHJlc3Npb24oZGlzcGxheUZuLCBpLCB2YWx1ZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0b0Rpc3BsYXk7CiAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlcykgewogICAgICAgICAgICAvLyBUT0RPOiBBZGQgYSB0ZXN0IGZvciB0aGlzIGNhc2UKICAgICAgICAgICAgdG9EaXNwbGF5ID0ge307CiAgICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gdmFsdWVzKSB7CiAgICAgICAgICAgICAgaWYgKHZhbHVlcy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgICAgICAgdG9EaXNwbGF5W3Byb3BdID0gY2FsbEV4cHJlc3Npb24oZGlzcGxheUZuLCBwcm9wLCB2YWx1ZXNbcHJvcF0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRvRGlzcGxheTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUlzU2VsZWN0ZWRGbih2aWV3VmFsdWUpIHsKICAgICAgICAgIHZhciBzZWxlY3RlZFNldDsKICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICBpZiAodHJhY2tGbiAmJiBpc0FycmF5KHZpZXdWYWx1ZSkpIHsKCiAgICAgICAgICAgICAgc2VsZWN0ZWRTZXQgPSBuZXcgSGFzaE1hcChbXSk7CiAgICAgICAgICAgICAgZm9yICh2YXIgdHJhY2tJbmRleCA9IDA7IHRyYWNrSW5kZXggPCB2aWV3VmFsdWUubGVuZ3RoOyB0cmFja0luZGV4KyspIHsKICAgICAgICAgICAgICAgIC8vIHRyYWNraW5nIGJ5IGtleQogICAgICAgICAgICAgICAgc2VsZWN0ZWRTZXQucHV0KGNhbGxFeHByZXNzaW9uKHRyYWNrRm4sIG51bGwsIHZpZXdWYWx1ZVt0cmFja0luZGV4XSksIHRydWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IG5ldyBIYXNoTWFwKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodHJhY2tGbikgewogICAgICAgICAgICB2aWV3VmFsdWUgPSBjYWxsRXhwcmVzc2lvbih0cmFja0ZuLCBudWxsLCB2aWV3VmFsdWUpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBpc1NlbGVjdGVkKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGNvbXBhcmVWYWx1ZUZuOwogICAgICAgICAgICBpZiAodHJhY2tGbikgewogICAgICAgICAgICAgIGNvbXBhcmVWYWx1ZUZuID0gdHJhY2tGbjsKICAgICAgICAgICAgfSBlbHNlIGlmIChzZWxlY3RBc0ZuKSB7CiAgICAgICAgICAgICAgY29tcGFyZVZhbHVlRm4gPSBzZWxlY3RBc0ZuOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbXBhcmVWYWx1ZUZuID0gdmFsdWVGbjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGlzRGVmaW5lZChzZWxlY3RlZFNldC5yZW1vdmUoY2FsbEV4cHJlc3Npb24oY29tcGFyZVZhbHVlRm4sIGtleSwgdmFsdWUpKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZpZXdWYWx1ZSA9PSBjYWxsRXhwcmVzc2lvbihjb21wYXJlVmFsdWVGbiwga2V5LCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVJlbmRlcmluZygpIHsKICAgICAgICAgIGlmICghcmVuZGVyU2NoZWR1bGVkKSB7CiAgICAgICAgICAgIHNjb3BlLiQkcG9zdERpZ2VzdChyZW5kZXIpOwogICAgICAgICAgICByZW5kZXJTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQSBuZXcgbGFiZWxNYXAgaXMgY3JlYXRlZCB3aXRoIGVhY2ggcmVuZGVyLgogICAgICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIGZvciBlYWNoIGV4aXN0aW5nIG9wdGlvbiB3aXRoIGFkZGVkPWZhbHNlLAogICAgICAgICAqIGFuZCBlYWNoIG5ldyBvcHRpb24gd2l0aCBhZGRlZD10cnVlLgogICAgICAgICAqIC0gTGFiZWxzIHRoYXQgYXJlIHBhc3NlZCB0byB0aGlzIG1ldGhvZCB0d2ljZSwKICAgICAgICAgKiAob25jZSB3aXRoIGFkZGVkPXRydWUgYW5kIG9uY2Ugd2l0aCBhZGRlZD1mYWxzZSkgd2lsbCBlbmQgdXAgd2l0aCBhIHZhbHVlIG9mIDAsIGFuZAogICAgICAgICAqIHdpbGwgY2F1c2Ugbm8gY2hhbmdlIHRvIGhhcHBlbiB0byB0aGUgY29ycmVzcG9uZGluZyBvcHRpb24uCiAgICAgICAgICogLSBMYWJlbHMgdGhhdCBhcmUgcGFzc2VkIHRvIHRoaXMgbWV0aG9kIG9ubHkgb25jZSB3aXRoIGFkZGVkPWZhbHNlIHdpbGwgZW5kIHVwIHdpdGggYQogICAgICAgICAqIHZhbHVlIG9mIC0xIGFuZCB3aWxsIGV2ZW50dWFsbHkgYmUgcGFzc2VkIHRvIHNlbGVjdEN0cmwucmVtb3ZlT3B0aW9uKCkKICAgICAgICAgKiAtIExhYmVscyB0aGF0IGFyZSBwYXNzZWQgdG8gdGhpcyBtZXRob2Qgb25seSBvbmNlIHdpdGggYWRkZWQ9dHJ1ZSB3aWxsIGVuZCB1cCB3aXRoIGEKICAgICAgICAgKiB2YWx1ZSBvZiAxIGFuZCB3aWxsIGV2ZW50dWFsbHkgYmUgcGFzc2VkIHRvIHNlbGVjdEN0cmwuYWRkT3B0aW9uKCkKICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUxhYmVsTWFwKGxhYmVsTWFwLCBsYWJlbCwgYWRkZWQpIHsKICAgICAgICAgIGxhYmVsTWFwW2xhYmVsXSA9IGxhYmVsTWFwW2xhYmVsXSB8fCAwOwogICAgICAgICAgbGFiZWxNYXBbbGFiZWxdICs9IChhZGRlZCA/IDEgOiAtMSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgICByZW5kZXJTY2hlZHVsZWQgPSBmYWxzZTsKCiAgICAgICAgICAvLyBUZW1wb3JhcnkgbG9jYXRpb24gZm9yIHRoZSBvcHRpb24gZ3JvdXBzIGJlZm9yZSB3ZSByZW5kZXIgdGhlbQogICAgICAgICAgdmFyIG9wdGlvbkdyb3VwcyA9IHsnJzpbXX0sCiAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcyA9IFsnJ10sCiAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lLAogICAgICAgICAgICAgIG9wdGlvbkdyb3VwLAogICAgICAgICAgICAgIG9wdGlvbiwKICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCwgZXhpc3RpbmdPcHRpb25zLCBleGlzdGluZ09wdGlvbiwKICAgICAgICAgICAgICB2aWV3VmFsdWUgPSBjdHJsLiR2aWV3VmFsdWUsCiAgICAgICAgICAgICAgdmFsdWVzID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAgICAgIGtleXMgPSBrZXlOYW1lID8gc29ydGVkS2V5cyh2YWx1ZXMpIDogdmFsdWVzLAogICAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICBncm91cExlbmd0aCwgbGVuZ3RoLAogICAgICAgICAgICAgIGdyb3VwSW5kZXgsIGluZGV4LAogICAgICAgICAgICAgIGxhYmVsTWFwID0ge30sCiAgICAgICAgICAgICAgc2VsZWN0ZWQsCiAgICAgICAgICAgICAgaXNTZWxlY3RlZCA9IGNyZWF0ZUlzU2VsZWN0ZWRGbih2aWV3VmFsdWUpLAogICAgICAgICAgICAgIGFueVNlbGVjdGVkID0gZmFsc2UsCiAgICAgICAgICAgICAgbGFzdEVsZW1lbnQsCiAgICAgICAgICAgICAgZWxlbWVudCwKICAgICAgICAgICAgICBsYWJlbDsKCiAgICAgICAgICAvLyBXZSBub3cgYnVpbGQgdXAgdGhlIGxpc3Qgb2Ygb3B0aW9ucyB3ZSBuZWVkICh3ZSBtZXJnZSBsYXRlcikKICAgICAgICAgIGZvciAoaW5kZXggPSAwOyBsZW5ndGggPSBrZXlzLmxlbmd0aCwgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAga2V5ID0gaW5kZXg7CiAgICAgICAgICAgIGlmIChrZXlOYW1lKSB7CiAgICAgICAgICAgICAga2V5ID0ga2V5c1tpbmRleF07CiAgICAgICAgICAgICAgaWYgKCBrZXkuY2hhckF0KDApID09PSAnJCcgKSBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YWx1ZSA9IHZhbHVlc1trZXldOwoKICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lID0gY2FsbEV4cHJlc3Npb24oZ3JvdXBCeUZuLCBrZXksIHZhbHVlKSB8fCAnJzsKICAgICAgICAgICAgaWYgKCEob3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXSkpIHsKICAgICAgICAgICAgICBvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdID0gW107CiAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcy5wdXNoKG9wdGlvbkdyb3VwTmFtZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlbGVjdGVkID0gaXNTZWxlY3RlZChrZXksIHZhbHVlKTsKICAgICAgICAgICAgYW55U2VsZWN0ZWQgPSBhbnlTZWxlY3RlZCB8fCBzZWxlY3RlZDsKCiAgICAgICAgICAgIGxhYmVsID0gY2FsbEV4cHJlc3Npb24oZGlzcGxheUZuLCBrZXksIHZhbHVlKTsgLy8gd2hhdCB3aWxsIGJlIHNlZW4gYnkgdGhlIHVzZXIKCiAgICAgICAgICAgIC8vIGRvaW5nIGRpc3BsYXlGbihzY29wZSwgbG9jYWxzKSB8fCAnJyBvdmVyd3JpdGVzIHplcm8gdmFsdWVzCiAgICAgICAgICAgIGxhYmVsID0gaXNEZWZpbmVkKGxhYmVsKSA/IGxhYmVsIDogJyc7CiAgICAgICAgICAgIG9wdGlvbkdyb3VwLnB1c2goewogICAgICAgICAgICAgIC8vIGVpdGhlciB0aGUgaW5kZXggaW50byBhcnJheSBvciBrZXkgZnJvbSBvYmplY3QKICAgICAgICAgICAgICBpZDogKGtleU5hbWUgPyBrZXlzW2luZGV4XSA6IGluZGV4KSwKICAgICAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHNlbGVjdGVkICAgICAgICAgICAgICAgICAgIC8vIGRldGVybWluZSBpZiB3ZSBzaG91bGQgYmUgc2VsZWN0ZWQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIW11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmIChudWxsT3B0aW9uIHx8IHZpZXdWYWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIC8vIGluc2VydCBudWxsIG9wdGlvbiBpZiB3ZSBoYXZlIGEgcGxhY2Vob2xkZXIsIG9yIHRoZSBtb2RlbCBpcyBudWxsCiAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzWycnXS51bnNoaWZ0KHtpZDonJywgbGFiZWw6JycsIHNlbGVjdGVkOiFhbnlTZWxlY3RlZH0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKCFhbnlTZWxlY3RlZCkgewogICAgICAgICAgICAgIC8vIG9wdGlvbiBjb3VsZCBub3QgYmUgZm91bmQsIHdlIGhhdmUgdG8gaW5zZXJ0IHRoZSB1bmRlZmluZWQgaXRlbQogICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc1snJ10udW5zaGlmdCh7aWQ6Jz8nLCBsYWJlbDonJywgc2VsZWN0ZWQ6dHJ1ZX0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gTm93IHdlIG5lZWQgdG8gdXBkYXRlIHRoZSBsaXN0IG9mIERPTSBub2RlcyB0byBtYXRjaCB0aGUgb3B0aW9uR3JvdXBzIHdlIGNvbXB1dGVkIGFib3ZlCiAgICAgICAgICBmb3IgKGdyb3VwSW5kZXggPSAwLCBncm91cExlbmd0aCA9IG9wdGlvbkdyb3VwTmFtZXMubGVuZ3RoOwogICAgICAgICAgICAgICBncm91cEluZGV4IDwgZ3JvdXBMZW5ndGg7CiAgICAgICAgICAgICAgIGdyb3VwSW5kZXgrKykgewogICAgICAgICAgICAvLyBjdXJyZW50IG9wdGlvbiBncm91cCBuYW1lIG9yICcnIGlmIG5vIGdyb3VwCiAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZSA9IG9wdGlvbkdyb3VwTmFtZXNbZ3JvdXBJbmRleF07CgogICAgICAgICAgICAvLyBsaXN0IG9mIG9wdGlvbnMgZm9yIHRoYXQgZ3JvdXAuIChmaXJzdCBpdGVtIGhhcyB0aGUgcGFyZW50KQogICAgICAgICAgICBvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdOwoKICAgICAgICAgICAgaWYgKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA8PSBncm91cEluZGV4KSB7CiAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBncm93IHRoZSBvcHRpb25Hcm91cHMKICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCA9IHsKICAgICAgICAgICAgICAgIGVsZW1lbnQ6IG9wdEdyb3VwVGVtcGxhdGUuY2xvbmUoKS5hdHRyKCdsYWJlbCcsIG9wdGlvbkdyb3VwTmFtZSksCiAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uR3JvdXAubGFiZWwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucyA9IFtleGlzdGluZ1BhcmVudF07CiAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUucHVzaChleGlzdGluZ09wdGlvbnMpOwogICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuYXBwZW5kKGV4aXN0aW5nUGFyZW50LmVsZW1lbnQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucyA9IG9wdGlvbkdyb3Vwc0NhY2hlW2dyb3VwSW5kZXhdOwogICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50ID0gZXhpc3RpbmdPcHRpb25zWzBdOyAgLy8gZWl0aGVyIFNFTEVDVCAobm8gZ3JvdXApIG9yIE9QVEdST1VQIGVsZW1lbnQKCiAgICAgICAgICAgICAgLy8gdXBkYXRlIHRoZSBPUFRHUk9VUCBsYWJlbCBpZiBub3QgdGhlIHNhbWUuCiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUGFyZW50LmxhYmVsICE9IG9wdGlvbkdyb3VwTmFtZSkgewogICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQuZWxlbWVudC5hdHRyKCdsYWJlbCcsIGV4aXN0aW5nUGFyZW50LmxhYmVsID0gb3B0aW9uR3JvdXBOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gbnVsbDsgIC8vIHN0YXJ0IGF0IHRoZSBiZWdpbm5pbmcKICAgICAgICAgICAgZm9yKGluZGV4ID0gMCwgbGVuZ3RoID0gb3B0aW9uR3JvdXAubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbkdyb3VwW2luZGV4XTsKICAgICAgICAgICAgICBpZiAoKGV4aXN0aW5nT3B0aW9uID0gZXhpc3RpbmdPcHRpb25zW2luZGV4KzFdKSkgewogICAgICAgICAgICAgICAgLy8gcmV1c2UgZWxlbWVudHMKICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gZXhpc3RpbmdPcHRpb24uZWxlbWVudDsKICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ09wdGlvbi5sYWJlbCAhPT0gb3B0aW9uLmxhYmVsKSB7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZUxhYmVsTWFwKGxhYmVsTWFwLCBleGlzdGluZ09wdGlvbi5sYWJlbCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICB1cGRhdGVMYWJlbE1hcChsYWJlbE1hcCwgb3B0aW9uLmxhYmVsLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQudGV4dChleGlzdGluZ09wdGlvbi5sYWJlbCA9IG9wdGlvbi5sYWJlbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24uaWQgIT09IG9wdGlvbi5pZCkgewogICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC52YWwoZXhpc3RpbmdPcHRpb24uaWQgPSBvcHRpb24uaWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnKSBwcm92aWRlZCBieSBqUXVlcnkgaGFzIHNpZGUtZWZmZWN0cwogICAgICAgICAgICAgICAgaWYgKGxhc3RFbGVtZW50WzBdLnNlbGVjdGVkICE9PSBvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnLCAoZXhpc3RpbmdPcHRpb24uc2VsZWN0ZWQgPSBvcHRpb24uc2VsZWN0ZWQpKTsKICAgICAgICAgICAgICAgICAgaWYgKG1zaWUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTZWUgIzc2OTIKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgc2VsZWN0ZWQgaXRlbSB3b3VsZG4ndCB2aXN1YWxseSB1cGRhdGUgb24gSUUgd2l0aG91dCB0aGlzLgogICAgICAgICAgICAgICAgICAgIC8vIFRlc3RlZCBvbiBXaW43OiBJRTksIElFMTAgYW5kIElFMTEuIEZ1dHVyZSBJRXMgc2hvdWxkIGJlIHRlc3RlZCBhcyB3ZWxsCiAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnLCBleGlzdGluZ09wdGlvbi5zZWxlY3RlZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gZ3JvdyBlbGVtZW50cwoKICAgICAgICAgICAgICAgIC8vIGlmIGl0J3MgYSBudWxsIG9wdGlvbgogICAgICAgICAgICAgICAgaWYgKG9wdGlvbi5pZCA9PT0gJycgJiYgbnVsbE9wdGlvbikgewogICAgICAgICAgICAgICAgICAvLyBwdXQgYmFjayB0aGUgcHJlLWNvbXBpbGVkIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgZWxlbWVudCA9IG51bGxPcHRpb247CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAvLyBqUXVlcnkodjEuNC4yKSBCdWc6IFdlIHNob3VsZCBiZSBhYmxlIHRvIGNoYWluIHRoZSBtZXRob2QgY2FsbHMsIGJ1dAogICAgICAgICAgICAgICAgICAvLyBpbiB0aGlzIHZlcnNpb24gb2YgalF1ZXJ5IG9uIHNvbWUgYnJvd3NlciB0aGUgLnRleHQoKSByZXR1cm5zIGEgc3RyaW5nCiAgICAgICAgICAgICAgICAgIC8vIHJhdGhlciB0aGVuIHRoZSBlbGVtZW50LgogICAgICAgICAgICAgICAgICAoZWxlbWVudCA9IG9wdGlvblRlbXBsYXRlLmNsb25lKCkpCiAgICAgICAgICAgICAgICAgICAgICAudmFsKG9wdGlvbi5pZCkKICAgICAgICAgICAgICAgICAgICAgIC5wcm9wKCdzZWxlY3RlZCcsIG9wdGlvbi5zZWxlY3RlZCkKICAgICAgICAgICAgICAgICAgICAgIC5hdHRyKCdzZWxlY3RlZCcsIG9wdGlvbi5zZWxlY3RlZCkKICAgICAgICAgICAgICAgICAgICAgIC50ZXh0KG9wdGlvbi5sYWJlbCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zLnB1c2goZXhpc3RpbmdPcHRpb24gPSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogZWxlbWVudCwKICAgICAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIGlkOiBvcHRpb24uaWQsCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IG9wdGlvbi5zZWxlY3RlZAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB1cGRhdGVMYWJlbE1hcChsYWJlbE1hcCwgb3B0aW9uLmxhYmVsLCB0cnVlKTsKICAgICAgICAgICAgICAgIGlmIChsYXN0RWxlbWVudCkgewogICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC5hZnRlcihlbGVtZW50KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXBwZW5kKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyByZW1vdmUgYW55IGV4Y2Vzc2l2ZSBPUFRJT05zIGluIGEgZ3JvdXAKICAgICAgICAgICAgaW5kZXgrKzsgLy8gaW5jcmVtZW50IHNpbmNlIHRoZSBleGlzdGluZ09wdGlvbnNbMF0gaXMgcGFyZW50IGVsZW1lbnQgbm90IE9QVElPTgogICAgICAgICAgICB3aGlsZShleGlzdGluZ09wdGlvbnMubGVuZ3RoID4gaW5kZXgpIHsKICAgICAgICAgICAgICBvcHRpb24gPSBleGlzdGluZ09wdGlvbnMucG9wKCk7CiAgICAgICAgICAgICAgdXBkYXRlTGFiZWxNYXAobGFiZWxNYXAsIG9wdGlvbi5sYWJlbCwgZmFsc2UpOwogICAgICAgICAgICAgIG9wdGlvbi5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvckVhY2gobGFiZWxNYXAsIGZ1bmN0aW9uIChjb3VudCwgbGFiZWwpIHsKICAgICAgICAgICAgICBpZiAoY291bnQgPiAwKSB7CiAgICAgICAgICAgICAgICBzZWxlY3RDdHJsLmFkZE9wdGlvbihsYWJlbCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb3VudCA8IDApIHsKICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwucmVtb3ZlT3B0aW9uKGxhYmVsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgLy8gcmVtb3ZlIGFueSBleGNlc3NpdmUgT1BUR1JPVVBzIGZyb20gc2VsZWN0CiAgICAgICAgICB3aGlsZShvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGggPiBncm91cEluZGV4KSB7CiAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlLnBvcCgpWzBdLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKfV07Cgp2YXIgb3B0aW9uRGlyZWN0aXZlID0gWyckaW50ZXJwb2xhdGUnLCBmdW5jdGlvbigkaW50ZXJwb2xhdGUpIHsKICB2YXIgbnVsbFNlbGVjdEN0cmwgPSB7CiAgICBhZGRPcHRpb246IG5vb3AsCiAgICByZW1vdmVPcHRpb246IG5vb3AKICB9OwoKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHByaW9yaXR5OiAxMDAsCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgIGlmIChpc1VuZGVmaW5lZChhdHRyLnZhbHVlKSkgewogICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGVsZW1lbnQudGV4dCgpLCB0cnVlKTsKICAgICAgICBpZiAoIWludGVycG9sYXRlRm4pIHsKICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBlbGVtZW50LnRleHQoKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgdmFyIHNlbGVjdEN0cmxOYW1lID0gJyRzZWxlY3RDb250cm9sbGVyJywKICAgICAgICAgICAgcGFyZW50ID0gZWxlbWVudC5wYXJlbnQoKSwKICAgICAgICAgICAgc2VsZWN0Q3RybCA9IHBhcmVudC5kYXRhKHNlbGVjdEN0cmxOYW1lKSB8fAogICAgICAgICAgICAgIHBhcmVudC5wYXJlbnQoKS5kYXRhKHNlbGVjdEN0cmxOYW1lKTsgLy8gaW4gY2FzZSB3ZSBhcmUgaW4gb3B0Z3JvdXAKCiAgICAgICAgaWYgKCFzZWxlY3RDdHJsIHx8ICFzZWxlY3RDdHJsLmRhdGFib3VuZCkgewogICAgICAgICAgc2VsZWN0Q3RybCA9IG51bGxTZWxlY3RDdHJsOwogICAgICAgIH0KCiAgICAgICAgaWYgKGludGVycG9sYXRlRm4pIHsKICAgICAgICAgIHNjb3BlLiR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZVdhdGNoQWN0aW9uKG5ld1ZhbCwgb2xkVmFsKSB7CiAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBuZXdWYWwpOwogICAgICAgICAgICBpZiAob2xkVmFsICE9PSBuZXdWYWwpIHsKICAgICAgICAgICAgICBzZWxlY3RDdHJsLnJlbW92ZU9wdGlvbihvbGRWYWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKG5ld1ZhbCwgZWxlbWVudCk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZWN0Q3RybC5hZGRPcHRpb24oYXR0ci52YWx1ZSwgZWxlbWVudCk7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50Lm9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24oYXR0ci52YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9CiAgfTsKfV07Cgp2YXIgc3R5bGVEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICByZXN0cmljdDogJ0UnLAogIHRlcm1pbmFsOiBmYWxzZQp9KTsKCiAgaWYgKHdpbmRvdy5hbmd1bGFyLmJvb3RzdHJhcCkgewogICAgLy9Bbmd1bGFySlMgaXMgYWxyZWFkeSBsb2FkZWQsIHNvIHdlIGNhbiByZXR1cm4gaGVyZS4uLgogICAgY29uc29sZS5sb2coJ1dBUk5JTkc6IFRyaWVkIHRvIGxvYWQgYW5ndWxhciBtb3JlIHRoYW4gb25jZS4nKTsKICAgIHJldHVybjsKICB9CgogIC8vdHJ5IHRvIGJpbmQgdG8ganF1ZXJ5IG5vdyBzbyB0aGF0IG9uZSBjYW4gd3JpdGUganFMaXRlKGRvY3VtZW50KS5yZWFkeSgpCiAgLy9idXQgd2Ugd2lsbCByZWJpbmQgb24gYm9vdHN0cmFwIGFnYWluLgogIGJpbmRKUXVlcnkoKTsKCiAgcHVibGlzaEV4dGVybmFsQVBJKGFuZ3VsYXIpOwoKICBqcUxpdGUoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCkgewogICAgYW5ndWxhckluaXQoZG9jdW1lbnQsIGJvb3RzdHJhcCk7CiAgfSk7Cgp9KSh3aW5kb3csIGRvY3VtZW50KTsKCiF3aW5kb3cuYW5ndWxhci4kJGNzcCgpICYmIHdpbmRvdy5hbmd1bGFyLmVsZW1lbnQoZG9jdW1lbnQpLmZpbmQoJ2hlYWQnKS5wcmVwZW5kKCc8c3R5bGUgdHlwZT0idGV4dC9jc3MiPkBjaGFyc2V0ICJVVEYtOCI7W25nXFw6Y2xvYWtdLFtuZy1jbG9ha10sW2RhdGEtbmctY2xvYWtdLFt4LW5nLWNsb2FrXSwubmctY2xvYWssLngtbmctY2xvYWssLm5nLWhpZGU6bm90KC5uZy1oaWRlLWFuaW1hdGUpe2Rpc3BsYXk6bm9uZSAhaW1wb3J0YW50O31uZ1xcOmZvcm17ZGlzcGxheTpibG9jazt9PC9zdHlsZT4nKTsKLyoqCiAqIEBsaWNlbnNlIEFuZ3VsYXJKUyB2MS4zLjAKICogKGMpIDIwMTAtMjAxNCBHb29nbGUsIEluYy4gaHR0cDovL2FuZ3VsYXJqcy5vcmcKICogTGljZW5zZTogTUlUCiAqLwooZnVuY3Rpb24od2luZG93LCBhbmd1bGFyLCB1bmRlZmluZWQpIHsndXNlIHN0cmljdCc7CgovKiBqc2hpbnQgbWF4bGVuOiBmYWxzZSAqLwoKLyoqCiAqIEBuZ2RvYyBtb2R1bGUKICogQG5hbWUgbmdBbmltYXRlCiAqIEBkZXNjcmlwdGlvbgogKgogKiBUaGUgYG5nQW5pbWF0ZWAgbW9kdWxlIHByb3ZpZGVzIHN1cHBvcnQgZm9yIEphdmFTY3JpcHQsIENTUzMgdHJhbnNpdGlvbiBhbmQgQ1NTMyBrZXlmcmFtZSBhbmltYXRpb24gaG9va3Mgd2l0aGluIGV4aXN0aW5nIGNvcmUgYW5kIGN1c3RvbSBkaXJlY3RpdmVzLgogKgogKiA8ZGl2IGRvYy1tb2R1bGUtY29tcG9uZW50cz0ibmdBbmltYXRlIj48L2Rpdj4KICoKICogIyBVc2FnZQogKgogKiBUbyBzZWUgYW5pbWF0aW9ucyBpbiBhY3Rpb24sIGFsbCB0aGF0IGlzIHJlcXVpcmVkIGlzIHRvIGRlZmluZSB0aGUgYXBwcm9wcmlhdGUgQ1NTIGNsYXNzZXMKICogb3IgdG8gcmVnaXN0ZXIgYSBKYXZhU2NyaXB0IGFuaW1hdGlvbiB2aWEgdGhlIG15TW9kdWxlLmFuaW1hdGlvbigpIGZ1bmN0aW9uLiBUaGUgZGlyZWN0aXZlcyB0aGF0IHN1cHBvcnQgYW5pbWF0aW9uIGF1dG9tYXRpY2FsbHkgYXJlOgogKiBgbmdSZXBlYXRgLCBgbmdJbmNsdWRlYCwgYG5nSWZgLCBgbmdTd2l0Y2hgLCBgbmdTaG93YCwgYG5nSGlkZWAsIGBuZ1ZpZXdgIGFuZCBgbmdDbGFzc2AuIEN1c3RvbSBkaXJlY3RpdmVzIGNhbiB0YWtlIGFkdmFudGFnZSBvZiBhbmltYXRpb24KICogYnkgdXNpbmcgdGhlIGAkYW5pbWF0ZWAgc2VydmljZS4KICoKICogQmVsb3cgaXMgYSBtb3JlIGRldGFpbGVkIGJyZWFrZG93biBvZiB0aGUgc3VwcG9ydGVkIGFuaW1hdGlvbiBldmVudHMgcHJvdmlkZWQgYnkgcHJlLWV4aXN0aW5nIG5nIGRpcmVjdGl2ZXM6CiAqCiAqIHwgRGlyZWN0aXZlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBTdXBwb3J0ZWQgQW5pbWF0aW9ucyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0I2FuaW1hdGlvbnMgbmdSZXBlYXR9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGVudGVyLCBsZWF2ZSBhbmQgbW92ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwge0BsaW5rIG5nUm91dGUuZGlyZWN0aXZlOm5nVmlldyNhbmltYXRpb25zIG5nVmlld30gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBlbnRlciBhbmQgbGVhdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlI2FuaW1hdGlvbnMgbmdJbmNsdWRlfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgZW50ZXIgYW5kIGxlYXZlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nU3dpdGNoI2FuaW1hdGlvbnMgbmdTd2l0Y2h9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGVudGVyIGFuZCBsZWF2ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0lmI2FuaW1hdGlvbnMgbmdJZn0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBlbnRlciBhbmQgbGVhdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGFzcyNhbmltYXRpb25zIG5nQ2xhc3N9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgYWRkIGFuZCByZW1vdmUgKHRoZSBDU1MgY2xhc3MoZXMpIHByZXNlbnQpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nU2hvdyNhbmltYXRpb25zIG5nU2hvd30gJiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSGlkZSNhbmltYXRpb25zIG5nSGlkZX0gICAgICAgICAgICB8IGFkZCBhbmQgcmVtb3ZlICh0aGUgbmctaGlkZSBjbGFzcyB2YWx1ZSkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtI2FuaW1hdGlvbi1ob29rcyBmb3JtfSAmIHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbCNhbmltYXRpb24taG9va3MgbmdNb2RlbH0gICAgfCBhZGQgYW5kIHJlbW92ZSAoZGlydHksIHByaXN0aW5lLCB2YWxpZCwgaW52YWxpZCAmIGFsbCBvdGhlciB2YWxpZGF0aW9ucykgfAogKiB8IHtAbGluayBtb2R1bGU6bmdNZXNzYWdlcyNhbmltYXRpb25zIG5nTWVzc2FnZXN9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgYWRkIGFuZCByZW1vdmUgKG5nLWFjdGl2ZSAmIG5nLWluYWN0aXZlKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogfCB7QGxpbmsgbW9kdWxlOm5nTWVzc2FnZXMjYW5pbWF0aW9ucyBuZ01lc3NhZ2V9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGVudGVyIGFuZCBsZWF2ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqCiAqIFlvdSBjYW4gZmluZCBvdXQgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBhbmltYXRpb25zIHVwb24gdmlzaXRpbmcgZWFjaCBkaXJlY3RpdmUgcGFnZS4KICoKICogQmVsb3cgaXMgYW4gZXhhbXBsZSBvZiBob3cgdG8gYXBwbHkgYW5pbWF0aW9ucyB0byBhIGRpcmVjdGl2ZSB0aGF0IHN1cHBvcnRzIGFuaW1hdGlvbiBob29rczoKICoKICogYGBgaHRtbAogKiA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgogKiAuc2xpZGUubmctZW50ZXIsIC5zbGlkZS5uZy1sZWF2ZSB7CiAqICAgLXdlYmtpdC10cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogfQogKgogKiAuc2xpZGUubmctZW50ZXIgeyB9ICAgICAgICAvJiM0Mjsgc3RhcnRpbmcgYW5pbWF0aW9ucyBmb3IgZW50ZXIgJiM0MjsvCiAqIC5zbGlkZS5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgeyB9IC8mIzQyOyB0ZXJtaW5hbCBhbmltYXRpb25zIGZvciBlbnRlciAmIzQyOy8KICogLnNsaWRlLm5nLWxlYXZlIHsgfSAgICAgICAgLyYjNDI7IHN0YXJ0aW5nIGFuaW1hdGlvbnMgZm9yIGxlYXZlICYjNDI7LwogKiAuc2xpZGUubmctbGVhdmUubmctbGVhdmUtYWN0aXZlIHsgfSAvJiM0MjsgdGVybWluYWwgYW5pbWF0aW9ucyBmb3IgbGVhdmUgJiM0MjsvCiAqIDwvc3R5bGU+CiAqCiAqIDwhLS0KICogdGhlIGFuaW1hdGUgc2VydmljZSB3aWxsIGF1dG9tYXRpY2FsbHkgYWRkIC5uZy1lbnRlciBhbmQgLm5nLWxlYXZlIHRvIHRoZSBlbGVtZW50CiAqIHRvIHRyaWdnZXIgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbnMKICogLS0+CiAqIDxBTlkgY2xhc3M9InNsaWRlIiBuZy1pbmNsdWRlPSIuLi4iPjwvQU5ZPgogKiBgYGAKICoKICogS2VlcCBpbiBtaW5kIHRoYXQsIGJ5IGRlZmF1bHQsIGlmIGFuIGFuaW1hdGlvbiBpcyBydW5uaW5nLCBhbnkgY2hpbGQgZWxlbWVudHMgY2Fubm90IGJlIGFuaW1hdGVkCiAqIHVudGlsIHRoZSBwYXJlbnQgZWxlbWVudCdzIGFuaW1hdGlvbiBoYXMgY29tcGxldGVkLiBUaGlzIGJsb2NraW5nIGZlYXR1cmUgY2FuIGJlIG92ZXJyaWRkZW4gYnkKICogcGxhY2luZyB0aGUgYG5nLWFuaW1hdGUtY2hpbGRyZW5gIGF0dHJpYnV0ZSBvbiBhIHBhcmVudCBjb250YWluZXIgdGFnLgogKgogKiBgYGBodG1sCiAqIDxkaXYgY2xhc3M9InNsaWRlLWFuaW1hdGlvbiIgbmctaWY9Im9uIiBuZy1hbmltYXRlLWNoaWxkcmVuPgogKiAgIDxkaXYgY2xhc3M9ImZhZGUtYW5pbWF0aW9uIiBuZy1pZj0ib24iPgogKiAgICAgPGRpdiBjbGFzcz0iZXhwbG9kZS1hbmltYXRpb24iIG5nLWlmPSJvbiI+CiAqICAgICAgICAuLi4KICogICAgIDwvZGl2PgogKiAgIDwvZGl2PgogKiA8L2Rpdj4KICogYGBgCiAqCiAqIFdoZW4gdGhlIGBvbmAgZXhwcmVzc2lvbiB2YWx1ZSBjaGFuZ2VzIGFuZCBhbiBhbmltYXRpb24gaXMgdHJpZ2dlcmVkIHRoZW4gZWFjaCBvZiB0aGUgZWxlbWVudHMgd2l0aGluCiAqIHdpbGwgYWxsIGFuaW1hdGUgd2l0aG91dCB0aGUgYmxvY2sgYmVpbmcgYXBwbGllZCB0byBjaGlsZCBlbGVtZW50cy4KICoKICogIyMgQXJlIGFuaW1hdGlvbnMgcnVuIHdoZW4gdGhlIGFwcGxpY2F0aW9uIHN0YXJ0cz8KICogTm8gdGhleSBhcmUgbm90LiBXaGVuIGFuIGFwcGxpY2F0aW9uIGlzIGJvb3RzdHJhcHBlZCBBbmd1bGFyIHdpbGwgZGlzYWJsZSBhbmltYXRpb25zIGZyb20gcnVubmluZyB0byBhdm9pZAogKiBhIGZyZW56eSBvZiBhbmltYXRpb25zIGZyb20gYmVpbmcgdHJpZ2dlcmVkIGFzIHNvb24gYXMgdGhlIGJyb3dzZXIgaGFzIHJlbmRlcmVkIHRoZSBzY3JlZW4uIEZvciB0aGlzIHRvIHdvcmssCiAqIEFuZ3VsYXIgd2lsbCB3YWl0IGZvciB0d28gZGlnZXN0IGN5Y2xlcyB1bnRpbCBlbmFibGluZyBhbmltYXRpb25zLiBGcm9tIHRoZXJlIG9uLCBhbnkgYW5pbWF0aW9uLXRyaWdnZXJpbmcKICogbGF5b3V0IGNoYW5nZXMgaW4gdGhlIGFwcGxpY2F0aW9uIHdpbGwgdHJpZ2dlciBhbmltYXRpb25zIGFzIG5vcm1hbC4KICoKICogSW4gYWRkaXRpb24sIHVwb24gYm9vdHN0cmFwLCBpZiB0aGUgcm91dGluZyBzeXN0ZW0gb3IgYW55IGRpcmVjdGl2ZXMgb3IgbG9hZCByZW1vdGUgZGF0YSAodmlhICRodHRwKSB0aGVuIEFuZ3VsYXIKICogd2lsbCBhdXRvbWF0aWNhbGx5IGV4dGVuZCB0aGUgd2FpdCB0aW1lIHRvIGVuYWJsZSBhbmltYXRpb25zIG9uY2UgKiphbGwqKiBvZiB0aGUgb3V0Ym91bmQgSFRUUCByZXF1ZXN0cwogKiBhcmUgY29tcGxldGUuCiAqCiAqICMjIENTUy1kZWZpbmVkIEFuaW1hdGlvbnMKICogVGhlIGFuaW1hdGUgc2VydmljZSB3aWxsIGF1dG9tYXRpY2FsbHkgYXBwbHkgdHdvIENTUyBjbGFzc2VzIHRvIHRoZSBhbmltYXRlZCBlbGVtZW50IGFuZCB0aGVzZSB0d28gQ1NTIGNsYXNzZXMKICogYXJlIGRlc2lnbmVkIHRvIGNvbnRhaW4gdGhlIHN0YXJ0IGFuZCBlbmQgQ1NTIHN0eWxpbmcuIEJvdGggQ1NTIHRyYW5zaXRpb25zIGFuZCBrZXlmcmFtZSBhbmltYXRpb25zIGFyZSBzdXBwb3J0ZWQKICogYW5kIGNhbiBiZSB1c2VkIHRvIHBsYXkgYWxvbmcgd2l0aCB0aGlzIG5hbWluZyBzdHJ1Y3R1cmUuCiAqCiAqIFRoZSBmb2xsb3dpbmcgY29kZSBiZWxvdyBkZW1vbnN0cmF0ZXMgaG93IHRvIHBlcmZvcm0gYW5pbWF0aW9ucyB1c2luZyAqKkNTUyB0cmFuc2l0aW9ucyoqIHdpdGggQW5ndWxhcjoKICoKICogYGBgaHRtbAogKiA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgogKiAvJiM0MjsKICogIFRoZSBhbmltYXRlIGNsYXNzIGlzIGFwYXJ0IG9mIHRoZSBlbGVtZW50IGFuZCB0aGUgbmctZW50ZXIgY2xhc3MKICogIGlzIGF0dGFjaGVkIHRvIHRoZSBlbGVtZW50IG9uY2UgdGhlIGVudGVyIGFuaW1hdGlvbiBldmVudCBpcyB0cmlnZ2VyZWQKICogJiM0MjsvCiAqIC5yZXZlYWwtYW5pbWF0aW9uLm5nLWVudGVyIHsKICogIC13ZWJraXQtdHJhbnNpdGlvbjogMXMgbGluZWFyIGFsbDsgLyYjNDI7IFNhZmFyaS9DaHJvbWUgJiM0MjsvCiAqICB0cmFuc2l0aW9uOiAxcyBsaW5lYXIgYWxsOyAvJiM0MjsgQWxsIG90aGVyIG1vZGVybiBicm93c2VycyBhbmQgSUUxMCsgJiM0MjsvCiAqCiAqICAvJiM0MjsgVGhlIGFuaW1hdGlvbiBwcmVwYXJhdGlvbiBjb2RlICYjNDI7LwogKiAgb3BhY2l0eTogMDsKICogfQogKgogKiAvJiM0MjsKICogIEtlZXAgaW4gbWluZCB0aGF0IHlvdSB3YW50IHRvIGNvbWJpbmUgYm90aCBDU1MKICogIGNsYXNzZXMgdG9nZXRoZXIgdG8gYXZvaWQgYW55IENTUy1zcGVjaWZpY2l0eQogKiAgY29uZmxpY3RzCiAqICYjNDI7LwogKiAucmV2ZWFsLWFuaW1hdGlvbi5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogKiAgLyYjNDI7IFRoZSBhbmltYXRpb24gY29kZSBpdHNlbGYgJiM0MjsvCiAqICBvcGFjaXR5OiAxOwogKiB9CiAqIDwvc3R5bGU+CiAqCiAqIDxkaXYgY2xhc3M9InZpZXctY29udGFpbmVyIj4KICogICA8ZGl2IG5nLXZpZXcgY2xhc3M9InJldmVhbC1hbmltYXRpb24iPjwvZGl2PgogKiA8L2Rpdj4KICogYGBgCiAqCiAqIFRoZSBmb2xsb3dpbmcgY29kZSBiZWxvdyBkZW1vbnN0cmF0ZXMgaG93IHRvIHBlcmZvcm0gYW5pbWF0aW9ucyB1c2luZyAqKkNTUyBhbmltYXRpb25zKiogd2l0aCBBbmd1bGFyOgogKgogKiBgYGBodG1sCiAqIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAqIC5yZXZlYWwtYW5pbWF0aW9uLm5nLWVudGVyIHsKICogICAtd2Via2l0LWFuaW1hdGlvbjogZW50ZXJfc2VxdWVuY2UgMXMgbGluZWFyOyAvJiM0MjsgU2FmYXJpL0Nocm9tZSAmIzQyOy8KICogICBhbmltYXRpb246IGVudGVyX3NlcXVlbmNlIDFzIGxpbmVhcjsgLyYjNDI7IElFMTArIGFuZCBGdXR1cmUgQnJvd3NlcnMgJiM0MjsvCiAqIH0KICogQC13ZWJraXQta2V5ZnJhbWVzIGVudGVyX3NlcXVlbmNlIHsKICogICBmcm9tIHsgb3BhY2l0eTowOyB9CiAqICAgdG8geyBvcGFjaXR5OjE7IH0KICogfQogKiBAa2V5ZnJhbWVzIGVudGVyX3NlcXVlbmNlIHsKICogICBmcm9tIHsgb3BhY2l0eTowOyB9CiAqICAgdG8geyBvcGFjaXR5OjE7IH0KICogfQogKiA8L3N0eWxlPgogKgogKiA8ZGl2IGNsYXNzPSJ2aWV3LWNvbnRhaW5lciI+CiAqICAgPGRpdiBuZy12aWV3IGNsYXNzPSJyZXZlYWwtYW5pbWF0aW9uIj48L2Rpdj4KICogPC9kaXY+CiAqIGBgYAogKgogKiBCb3RoIENTUzMgYW5pbWF0aW9ucyBhbmQgdHJhbnNpdGlvbnMgY2FuIGJlIHVzZWQgdG9nZXRoZXIgYW5kIHRoZSBhbmltYXRlIHNlcnZpY2Ugd2lsbCBmaWd1cmUgb3V0IHRoZSBjb3JyZWN0IGR1cmF0aW9uIGFuZCBkZWxheSB0aW1pbmcuCiAqCiAqIFVwb24gRE9NIG11dGF0aW9uLCB0aGUgZXZlbnQgY2xhc3MgaXMgYWRkZWQgZmlyc3QgKHNvbWV0aGluZyBsaWtlIGBuZy1lbnRlcmApLCB0aGVuIHRoZSBicm93c2VyIHByZXBhcmVzIGl0c2VsZiB0byBhZGQKICogdGhlIGFjdGl2ZSBjbGFzcyAoaW4gdGhpcyBjYXNlIGBuZy1lbnRlci1hY3RpdmVgKSB3aGljaCB0aGVuIHRyaWdnZXJzIHRoZSBhbmltYXRpb24uIFRoZSBhbmltYXRpb24gbW9kdWxlIHdpbGwgYXV0b21hdGljYWxseQogKiBkZXRlY3QgdGhlIENTUyBjb2RlIHRvIGRldGVybWluZSB3aGVuIHRoZSBhbmltYXRpb24gZW5kcy4gT25jZSB0aGUgYW5pbWF0aW9uIGlzIG92ZXIgdGhlbiBib3RoIENTUyBjbGFzc2VzIHdpbGwgYmUKICogcmVtb3ZlZCBmcm9tIHRoZSBET00uIElmIGEgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IENTUyB0cmFuc2l0aW9ucyBvciBDU1MgYW5pbWF0aW9ucyB0aGVuIHRoZSBhbmltYXRpb24gd2lsbCBzdGFydCBhbmQgZW5kCiAqIGltbWVkaWF0ZWx5IHJlc3VsdGluZyBpbiBhIERPTSBlbGVtZW50IHRoYXQgaXMgYXQgaXRzIGZpbmFsIHN0YXRlLiBUaGlzIGZpbmFsIHN0YXRlIGlzIHdoZW4gdGhlIERPTSBlbGVtZW50CiAqIGhhcyBubyBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24gY2xhc3NlcyBhcHBsaWVkIHRvIGl0LgogKgogKiAjIyMgU3RydWN0dXJhbCB0cmFuc2l0aW9uIGFuaW1hdGlvbnMKICoKICogU3RydWN0dXJhbCB0cmFuc2l0aW9ucyAoc3VjaCBhcyBlbnRlciwgbGVhdmUgYW5kIG1vdmUpIHdpbGwgYWx3YXlzIGFwcGx5IGEgYDBzIG5vbmVgIHRyYW5zaXRpb24KICogdmFsdWUgdG8gZm9yY2UgdGhlIGJyb3dzZXIgaW50byByZW5kZXJpbmcgdGhlIHN0eWxlcyBkZWZpbmVkIGluIHRoZSBzZXR1cCAoLm5nLWVudGVyLCAubmctbGVhdmUKICogb3IgLm5nLW1vdmUpIGNsYXNzLiBUaGlzIG1lYW5zIHRoYXQgYW55IGFjdGl2ZSB0cmFuc2l0aW9uIGFuaW1hdGlvbnMgb3BlcmF0aW5nIG9uIHRoZSBlbGVtZW50CiAqIHdpbGwgYmUgY3V0IG9mZiB0byBtYWtlIHdheSBmb3IgdGhlIGVudGVyLCBsZWF2ZSBvciBtb3ZlIGFuaW1hdGlvbi4KICoKICogIyMjIENsYXNzLWJhc2VkIHRyYW5zaXRpb24gYW5pbWF0aW9ucwogKgogKiBDbGFzcy1iYXNlZCB0cmFuc2l0aW9ucyByZWZlciB0byB0cmFuc2l0aW9uIGFuaW1hdGlvbnMgdGhhdCBhcmUgdHJpZ2dlcmVkIHdoZW4gYSBDU1MgY2xhc3MgaXMKICogYWRkZWQgdG8gb3IgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50ICh2aWEgYCRhbmltYXRlLmFkZENsYXNzYCwgYCRhbmltYXRlLnJlbW92ZUNsYXNzYCwKICogYCRhbmltYXRlLnNldENsYXNzYCwgb3IgYnkgZGlyZWN0aXZlcyBzdWNoIGFzIGBuZ0NsYXNzYCwgYG5nTW9kZWxgIGFuZCBgZm9ybWApLgogKiBUaGV5IGFyZSBkaWZmZXJlbnQgd2hlbiBjb21wYXJlZCB0byBzdHJ1Y3R1cmFsIGFuaW1hdGlvbnMgc2luY2UgdGhleSAqKmRvIG5vdCBjYW5jZWwgZXhpc3RpbmcKICogYW5pbWF0aW9ucyoqIG5vciBkbyB0aGV5ICoqYmxvY2sgc3VjY2Vzc2l2ZSB0cmFuc2l0aW9ucyoqIGZyb20gcmVuZGVyaW5nIG9uIHRoZSBzYW1lIGVsZW1lbnQuCiAqIFRoaXMgZGlzdGluY3Rpb24gYWxsb3dzIGZvciAqKm11bHRpcGxlIGNsYXNzLWJhc2VkIHRyYW5zaXRpb25zKiogdG8gYmUgcGVyZm9ybWVkIG9uIHRoZSBzYW1lIGVsZW1lbnQuCiAqCiAqIEluIGFkZGl0aW9uIHRvIG5nQW5pbWF0ZSBzdXBwb3J0aW5nIHRoZSBkZWZhdWx0IChuYXR1cmFsKSBmdW5jdGlvbmFsaXR5IG9mIGNsYXNzLWJhc2VkIHRyYW5zaXRpb24KICogYW5pbWF0aW9ucywgbmdBbmltYXRlIGFsc28gZGVjb3JhdGVzIHRoZSBlbGVtZW50IHdpdGggc3RhcnRpbmcgYW5kIGVuZGluZyBDU1MgY2xhc3NlcyB0byBhaWQgdGhlCiAqIGRldmVsb3BlciBpbiBmdXJ0aGVyIHN0eWxpbmcgdGhlIGVsZW1lbnQgdGhyb3VnaG91dCB0aGUgdHJhbnNpdGlvbiBhbmltYXRpb24uIEVhcmxpZXIgdmVyc2lvbnMKICogb2YgbmdBbmltYXRlIG1heSBoYXZlIGNhdXNlZCBuYXR1cmFsIENTUyB0cmFuc2l0aW9ucyB0byBicmVhayBhbmQgbm90IHJlbmRlciBwcm9wZXJseSBkdWUgdG8KICogJGFuaW1hdGUgdGVtcG9yYXJpbHkgYmxvY2tpbmcgdHJhbnNpdGlvbnMgdXNpbmcgYDBzIG5vbmVgIGluIG9yZGVyIHRvIGFsbG93IHRoZSBzZXR1cCBDU1MgY2xhc3MKICogKHRoZSBgLWFkZGAgb3IgYC1yZW1vdmVgIGNsYXNzKSB0byBiZSBhcHBsaWVkIHdpdGhvdXQgdHJpZ2dlcmluZyBhbiBhbmltYXRpb24uIEhvd2V2ZXIsIGFzIG9mCiAqICoqdmVyc2lvbiAxLjMqKiwgdGhpcyB3b3JrYXJvdW5kIGhhcyBiZWVuIHJlbW92ZWQgd2l0aCBuZ0FuaW1hdGUgYW5kIGFsbCBub24tbmdBbmltYXRlIENTUwogKiBjbGFzcyB0cmFuc2l0aW9ucyBhcmUgY29tcGF0aWJsZSB3aXRoIG5nQW5pbWF0ZS4KICoKICogVGhlcmUgaXMsIGhvd2V2ZXIsIG9uZSBzcGVjaWFsIGNhc2Ugd2hlbiBkZWFsaW5nIHdpdGggY2xhc3MtYmFzZWQgdHJhbnNpdGlvbnMgaW4gbmdBbmltYXRlLgogKiBXaGVuIHJlbmRlcmluZyBjbGFzcy1iYXNlZCB0cmFuc2l0aW9ucyB0aGF0IG1ha2UgdXNlIG9mIHRoZSBzZXR1cCBhbmQgYWN0aXZlIENTUyBjbGFzc2VzCiAqIChlLmcuIGAuZmFkZS1hZGRgIGFuZCBgLmZhZGUtYWRkLWFjdGl2ZWAgZm9yIHdoZW4gYC5mYWRlYCBpcyBhZGRlZCkgYmUgc3VyZSB0byBkZWZpbmUKICogdGhlIHRyYW5zaXRpb24gdmFsdWUgKipvbiB0aGUgYWN0aXZlIENTUyBjbGFzcyoqIGFuZCBub3QgdGhlIHNldHVwIGNsYXNzLgogKgogKiBgYGBjc3MKICogLmZhZGUtYWRkIHsKICogICAvJiM0MjsgcmVtZW1iZXIgdG8gcGxhY2UgYSAwcyB0cmFuc2l0aW9uIGhlcmUKICogICAgICB0byBlbnN1cmUgdGhhdCB0aGUgc3R5bGVzIGFyZSBhcHBsaWVkIGluc3RhbnRseQogKiAgICAgIGV2ZW4gaWYgdGhlIGVsZW1lbnQgYWxyZWFkeSBoYXMgYSB0cmFuc2l0aW9uIHN0eWxlICYjNDI7LwogKiAgIHRyYW5zaXRpb246MHMgbGluZWFyIGFsbDsKICoKICogICAvJiM0Mjsgc3RhcnRpbmcgQ1NTIHN0eWxlcyAmIzQyOy8KICogICBvcGFjaXR5OjE7CiAqIH0KICogLmZhZGUtYWRkLmZhZGUtYWRkLWFjdGl2ZSB7CiAqICAgLyYjNDI7IHRoaXMgd2lsbCBiZSB0aGUgbGVuZ3RoIG9mIHRoZSBhbmltYXRpb24gJiM0MjsvCiAqICAgdHJhbnNpdGlvbjoxcyBsaW5lYXIgYWxsOwogKiAgIG9wYWNpdHk6MDsKICogfQogKiBgYGAKICoKICogVGhlIHNldHVwIENTUyBjbGFzcyAoaW4gdGhpcyBjYXNlIGAuZmFkZS1hZGRgKSBhbHNvIGhhcyBhIHRyYW5zaXRpb24gc3R5bGUgcHJvcGVydHksIGhvd2V2ZXIsIGl0CiAqIGhhcyBhIGR1cmF0aW9uIG9mIHplcm8uIFRoaXMgbWF5IG5vdCBiZSByZXF1aXJlZCwgaG93ZXZlciwgaW5jYXNlIHRoZSBicm93c2VyIGlzIHVuYWJsZSB0byByZW5kZXIKICogdGhlIHN0eWxpbmcgcHJlc2VudCBpbiB0aGlzIENTUyBjbGFzcyBpbnN0YW50bHkgdGhlbiBpdCBjb3VsZCBiZSB0aGF0IHRoZSBicm93c2VyIGlzIGF0dGVtcHRpbmcKICogdG8gcGVyZm9ybSBhbiB1bm5lY2Vzc2FyeSB0cmFuc2l0aW9uLgogKgogKiBUaGlzIHdvcmthcm91bmQsIGhvd2V2ZXIsIGRvZXMgbm90IGFwcGx5IHRvICBzdGFuZGFyZCBjbGFzcy1iYXNlZCB0cmFuc2l0aW9ucyB0aGF0IGFyZSByZW5kZXJlZAogKiB3aGVuIGEgQ1NTIGNsYXNzIGNvbnRhaW5pbmcgYSB0cmFuc2l0aW9uIGlzIGFwcGxpZWQgdG8gYW4gZWxlbWVudDoKICoKICogYGBgY3NzCiAqIC5mYWRlIHsKICogICAvJiM0MjsgdGhpcyB3b3JrcyBhcyBleHBlY3RlZCAmIzQyOy8KICogICB0cmFuc2l0aW9uOjFzIGxpbmVhciBhbGw7CiAqICAgb3BhY2l0eTowOwogKiB9CiAqIGBgYAogKgogKiBQbGVhc2Uga2VlcCB0aGlzIGluIG1pbmQgd2hlbiBjb2RpbmcgdGhlIENTUyBtYXJrdXAgdGhhdCB3aWxsIGJlIHVzZWQgd2l0aGluIGNsYXNzLWJhc2VkIHRyYW5zaXRpb25zLgogKiBBbHNvLCB0cnkgbm90IHRvIG1peCB0aGUgdHdvIGNsYXNzLWJhc2VkIGFuaW1hdGlvbiBmbGF2b3JzIHRvZ2V0aGVyIHNpbmNlIHRoZSBDU1MgY29kZSBtYXkgYmVjb21lCiAqIG92ZXJseSBjb21wbGV4LgogKgogKiAjIyMgQ1NTIFN0YWdnZXJpbmcgQW5pbWF0aW9ucwogKiBBIFN0YWdnZXJpbmcgYW5pbWF0aW9uIGlzIGEgY29sbGVjdGlvbiBvZiBhbmltYXRpb25zIHRoYXQgYXJlIGlzc3VlZCB3aXRoIGEgc2xpZ2h0IGRlbGF5IGluIGJldHdlZW4gZWFjaCBzdWNjZXNzaXZlIG9wZXJhdGlvbiByZXN1bHRpbmcgaW4gYQogKiBjdXJ0YWluLWxpa2UgZWZmZWN0LiBUaGUgbmdBbmltYXRlIG1vZHVsZSAodmVyc2lvbnMgPj0xLjIpIHN1cHBvcnRzIHN0YWdnZXJpbmcgYW5pbWF0aW9ucyBhbmQgdGhlIHN0YWdnZXIgZWZmZWN0IGNhbiBiZQogKiBwZXJmb3JtZWQgYnkgY3JlYXRpbmcgYSAqKm5nLUVWRU5ULXN0YWdnZXIqKiBDU1MgY2xhc3MgYW5kIGF0dGFjaGluZyB0aGF0IGNsYXNzIHRvIHRoZSBiYXNlIENTUyBjbGFzcyB1c2VkIGZvcgogKiB0aGUgYW5pbWF0aW9uLiBUaGUgc3R5bGUgcHJvcGVydHkgZXhwZWN0ZWQgd2l0aGluIHRoZSBzdGFnZ2VyIGNsYXNzIGNhbiBlaXRoZXIgYmUgYSAqKnRyYW5zaXRpb24tZGVsYXkqKiBvciBhbgogKiAqKmFuaW1hdGlvbi1kZWxheSoqIHByb3BlcnR5IChvciBib3RoIGlmIHlvdXIgYW5pbWF0aW9uIGNvbnRhaW5zIGJvdGggdHJhbnNpdGlvbnMgYW5kIGtleWZyYW1lIGFuaW1hdGlvbnMpLgogKgogKiBgYGBjc3MKICogLm15LWFuaW1hdGlvbi5uZy1lbnRlciB7CiAqICAgLyYjNDI7IHN0YW5kYXJkIHRyYW5zaXRpb24gY29kZSAmIzQyOy8KICogICAtd2Via2l0LXRyYW5zaXRpb246IDFzIGxpbmVhciBhbGw7CiAqICAgdHJhbnNpdGlvbjogMXMgbGluZWFyIGFsbDsKICogICBvcGFjaXR5OjA7CiAqIH0KICogLm15LWFuaW1hdGlvbi5uZy1lbnRlci1zdGFnZ2VyIHsKICogICAvJiM0MjsgdGhpcyB3aWxsIGhhdmUgYSAxMDBtcyBkZWxheSBiZXR3ZWVuIGVhY2ggc3VjY2Vzc2l2ZSBsZWF2ZSBhbmltYXRpb24gJiM0MjsvCiAqICAgLXdlYmtpdC10cmFuc2l0aW9uLWRlbGF5OiAwLjFzOwogKiAgIHRyYW5zaXRpb24tZGVsYXk6IDAuMXM7CiAqCiAqICAgLyYjNDI7IGluIGNhc2UgdGhlIHN0YWdnZXIgZG9lc24ndCB3b3JrIHRoZW4gdGhlc2UgdHdvIHZhbHVlcwogKiAgICBtdXN0IGJlIHNldCB0byAwIHRvIGF2b2lkIGFuIGFjY2lkZW50YWwgQ1NTIGluaGVyaXRhbmNlICYjNDI7LwogKiAgIC13ZWJraXQtdHJhbnNpdGlvbi1kdXJhdGlvbjogMHM7CiAqICAgdHJhbnNpdGlvbi1kdXJhdGlvbjogMHM7CiAqIH0KICogLm15LWFuaW1hdGlvbi5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogKiAgIC8mIzQyOyBzdGFuZGFyZCB0cmFuc2l0aW9uIHN0eWxlcyAmIzQyOy8KICogICBvcGFjaXR5OjE7CiAqIH0KICogYGBgCiAqCiAqIFN0YWdnZXJpbmcgYW5pbWF0aW9ucyB3b3JrIGJ5IGRlZmF1bHQgaW4gbmdSZXBlYXQgKHNvIGxvbmcgYXMgdGhlIENTUyBjbGFzcyBpcyBkZWZpbmVkKS4gT3V0c2lkZSBvZiBuZ1JlcGVhdCwgdG8gdXNlIHN0YWdnZXJpbmcgYW5pbWF0aW9ucwogKiBvbiB5b3VyIG93biwgdGhleSBjYW4gYmUgdHJpZ2dlcmVkIGJ5IGZpcmluZyBtdWx0aXBsZSBjYWxscyB0byB0aGUgc2FtZSBldmVudCBvbiAkYW5pbWF0ZS4gSG93ZXZlciwgdGhlIHJlc3RyaWN0aW9ucyBzdXJyb3VuZGluZyB0aGlzCiAqIGFyZSB0aGF0IGVhY2ggb2YgdGhlIGVsZW1lbnRzIG11c3QgaGF2ZSB0aGUgc2FtZSBDU1MgY2xhc3NOYW1lIHZhbHVlIGFzIHdlbGwgYXMgdGhlIHNhbWUgcGFyZW50IGVsZW1lbnQuIEEgc3RhZ2dlciBvcGVyYXRpb24KICogd2lsbCBhbHNvIGJlIHJlc2V0IGlmIG1vcmUgdGhhbiAxMG1zIGhhcyBwYXNzZWQgYWZ0ZXIgdGhlIGxhc3QgYW5pbWF0aW9uIGhhcyBiZWVuIGZpcmVkLgogKgogKiBUaGUgZm9sbG93aW5nIGNvZGUgd2lsbCBpc3N1ZSB0aGUgKipuZy1sZWF2ZS1zdGFnZ2VyKiogZXZlbnQgb24gdGhlIGVsZW1lbnQgcHJvdmlkZWQ6CiAqCiAqIGBgYGpzCiAqIHZhciBraWRzID0gcGFyZW50LmNoaWxkcmVuKCk7CiAqCiAqICRhbmltYXRlLmxlYXZlKGtpZHNbMF0pOyAvL3N0YWdnZXIgaW5kZXg9MAogKiAkYW5pbWF0ZS5sZWF2ZShraWRzWzFdKTsgLy9zdGFnZ2VyIGluZGV4PTEKICogJGFuaW1hdGUubGVhdmUoa2lkc1syXSk7IC8vc3RhZ2dlciBpbmRleD0yCiAqICRhbmltYXRlLmxlYXZlKGtpZHNbM10pOyAvL3N0YWdnZXIgaW5kZXg9MwogKiAkYW5pbWF0ZS5sZWF2ZShraWRzWzRdKTsgLy9zdGFnZ2VyIGluZGV4PTQKICoKICogJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAqICAgLy9zdGFnZ2VyIGhhcyByZXNldCBpdHNlbGYKICogICAkYW5pbWF0ZS5sZWF2ZShraWRzWzVdKTsgLy9zdGFnZ2VyIGluZGV4PTAKICogICAkYW5pbWF0ZS5sZWF2ZShraWRzWzZdKTsgLy9zdGFnZ2VyIGluZGV4PTEKICogfSwgMTAwLCBmYWxzZSk7CiAqIGBgYAogKgogKiBTdGFnZ2VyIGFuaW1hdGlvbnMgYXJlIGN1cnJlbnRseSBvbmx5IHN1cHBvcnRlZCB3aXRoaW4gQ1NTLWRlZmluZWQgYW5pbWF0aW9ucy4KICoKICogIyMgSmF2YVNjcmlwdC1kZWZpbmVkIEFuaW1hdGlvbnMKICogSW4gdGhlIGV2ZW50IHRoYXQgeW91IGRvIG5vdCB3YW50IHRvIHVzZSBDU1MzIHRyYW5zaXRpb25zIG9yIENTUzMgYW5pbWF0aW9ucyBvciBpZiB5b3Ugd2lzaCB0byBvZmZlciBhbmltYXRpb25zIG9uIGJyb3dzZXJzIHRoYXQgZG8gbm90CiAqIHlldCBzdXBwb3J0IENTUyB0cmFuc2l0aW9ucy9hbmltYXRpb25zLCB0aGVuIHlvdSBjYW4gbWFrZSB1c2Ugb2YgSmF2YVNjcmlwdCBhbmltYXRpb25zIGRlZmluZWQgaW5zaWRlIG9mIHlvdXIgQW5ndWxhckpTIG1vZHVsZS4KICoKICogYGBganMKICogLy8hYW5ub3RhdGU9IllvdXJBcHAiIFlvdXIgQW5ndWxhckpTIE1vZHVsZXxSZXBsYWNlIHRoaXMgb3IgbmdNb2R1bGUgd2l0aCB0aGUgbW9kdWxlIHRoYXQgeW91IHVzZWQgdG8gZGVmaW5lIHlvdXIgYXBwbGljYXRpb24uCiAqIHZhciBuZ01vZHVsZSA9IGFuZ3VsYXIubW9kdWxlKCdZb3VyQXBwJywgWyduZ0FuaW1hdGUnXSk7CiAqIG5nTW9kdWxlLmFuaW1hdGlvbignLm15LWNyYXp5LWFuaW1hdGlvbicsIGZ1bmN0aW9uKCkgewogKiAgIHJldHVybiB7CiAqICAgICBlbnRlcjogZnVuY3Rpb24oZWxlbWVudCwgZG9uZSkgewogKiAgICAgICAvL3J1biB0aGUgYW5pbWF0aW9uIGhlcmUgYW5kIGNhbGwgZG9uZSB3aGVuIHRoZSBhbmltYXRpb24gaXMgY29tcGxldGUKICogICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbmNlbGxlZCkgewogKiAgICAgICAgIC8vdGhpcyAob3B0aW9uYWwpIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIGFuaW1hdGlvbgogKiAgICAgICAgIC8vY29tcGxldGVzIG9yIHdoZW4gdGhlIGFuaW1hdGlvbiBpcyBjYW5jZWxsZWQgKHRoZSBjYW5jZWxsZWQKICogICAgICAgICAvL2ZsYWcgd2lsbCBiZSBzZXQgdG8gdHJ1ZSBpZiBjYW5jZWxsZWQpLgogKiAgICAgICB9OwogKiAgICAgfSwKICogICAgIGxlYXZlOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7IH0sCiAqICAgICBtb3ZlOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7IH0sCiAqCiAqICAgICAvL2FuaW1hdGlvbiB0aGF0IGNhbiBiZSB0cmlnZ2VyZWQgYmVmb3JlIHRoZSBjbGFzcyBpcyBhZGRlZAogKiAgICAgYmVmb3JlQWRkQ2xhc3M6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZSkgeyB9LAogKgogKiAgICAgLy9hbmltYXRpb24gdGhhdCBjYW4gYmUgdHJpZ2dlcmVkIGFmdGVyIHRoZSBjbGFzcyBpcyBhZGRlZAogKiAgICAgYWRkQ2xhc3M6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZSkgeyB9LAogKgogKiAgICAgLy9hbmltYXRpb24gdGhhdCBjYW4gYmUgdHJpZ2dlcmVkIGJlZm9yZSB0aGUgY2xhc3MgaXMgcmVtb3ZlZAogKiAgICAgYmVmb3JlUmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZSkgeyB9LAogKgogKiAgICAgLy9hbmltYXRpb24gdGhhdCBjYW4gYmUgdHJpZ2dlcmVkIGFmdGVyIHRoZSBjbGFzcyBpcyByZW1vdmVkCiAqICAgICByZW1vdmVDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7IH0KICogICB9OwogKiB9KTsKICogYGBgCiAqCiAqIEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zIGFyZSBjcmVhdGVkIHdpdGggYSBDU1MtbGlrZSBjbGFzcyBzZWxlY3RvciBhbmQgYSBjb2xsZWN0aW9uIG9mIGV2ZW50cyB3aGljaCBhcmUgc2V0IHRvIHJ1bgogKiBhIGphdmFzY3JpcHQgY2FsbGJhY2sgZnVuY3Rpb24uIFdoZW4gYW4gYW5pbWF0aW9uIGlzIHRyaWdnZXJlZCwgJGFuaW1hdGUgd2lsbCBsb29rIGZvciBhIG1hdGNoaW5nIGFuaW1hdGlvbiB3aGljaCBmaXRzCiAqIHRoZSBlbGVtZW50J3MgQ1NTIGNsYXNzIGF0dHJpYnV0ZSB2YWx1ZSBhbmQgdGhlbiBydW4gdGhlIG1hdGNoaW5nIGFuaW1hdGlvbiBldmVudCBmdW5jdGlvbiAoaWYgZm91bmQpLgogKiBJbiBvdGhlciB3b3JkcywgaWYgdGhlIENTUyBjbGFzc2VzIHByZXNlbnQgb24gdGhlIGFuaW1hdGVkIGVsZW1lbnQgbWF0Y2ggYW55IG9mIHRoZSBKYXZhU2NyaXB0IGFuaW1hdGlvbnMgdGhlbiB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gd2lsbAogKiBiZSBleGVjdXRlZC4gSXQgc2hvdWxkIGJlIGFsc28gbm90ZWQgdGhhdCBvbmx5IHNpbXBsZSwgc2luZ2xlIGNsYXNzIHNlbGVjdG9ycyBhcmUgYWxsb3dlZCAoY29tcG91bmQgY2xhc3Mgc2VsZWN0b3JzIGFyZSBub3Qgc3VwcG9ydGVkKS4KICoKICogV2l0aGluIGEgSmF2YVNjcmlwdCBhbmltYXRpb24sIGFuIG9iamVjdCBjb250YWluaW5nIHZhcmlvdXMgZXZlbnQgY2FsbGJhY2sgYW5pbWF0aW9uIGZ1bmN0aW9ucyBpcyBleHBlY3RlZCB0byBiZSByZXR1cm5lZC4KICogQXMgZXhwbGFpbmVkIGFib3ZlLCB0aGVzZSBjYWxsYmFja3MgYXJlIHRyaWdnZXJlZCBiYXNlZCBvbiB0aGUgYW5pbWF0aW9uIGV2ZW50LiBUaGVyZWZvcmUgaWYgYW4gZW50ZXIgYW5pbWF0aW9uIGlzIHJ1biwKICogYW5kIHRoZSBKYXZhU2NyaXB0IGFuaW1hdGlvbiBpcyBmb3VuZCwgdGhlbiB0aGUgZW50ZXIgY2FsbGJhY2sgd2lsbCBoYW5kbGUgdGhhdCBhbmltYXRpb24gKGluIGFkZGl0aW9uIHRvIHRoZSBDU1Mga2V5ZnJhbWUgYW5pbWF0aW9uCiAqIG9yIHRyYW5zaXRpb24gY29kZSB0aGF0IGlzIGRlZmluZWQgdmlhIGEgc3R5bGVzaGVldCkuCiAqCiAqCiAqICMjIyBBcHBseWluZyBEaXJlY3RpdmUtc3BlY2lmaWMgU3R5bGVzIHRvIGFuIEFuaW1hdGlvbgogKiBJbiBzb21lIGNhc2VzIGEgZGlyZWN0aXZlIG9yIHNlcnZpY2UgbWF5IHdhbnQgdG8gcHJvdmlkZSBgJGFuaW1hdGVgIHdpdGggZXh0cmEgZGV0YWlscyB0aGF0IHRoZSBhbmltYXRpb24gd2lsbAogKiBpbmNsdWRlIGludG8gaXRzIGFuaW1hdGlvbi4gTGV0J3Mgc2F5IGZvciBleGFtcGxlIHdlIHdhbnRlZCB0byByZW5kZXIgYW4gYW5pbWF0aW9uIHRoYXQgYW5pbWF0ZXMgYW4gZWxlbWVudAogKiB0b3dhcmRzIHRoZSBtb3VzZSBjb29yZGluYXRlcyBhcyB0byB3aGVyZSB0aGUgdXNlciBjbGlja2VkIGxhc3QuIEJ5IGNvbGxlY3RpbmcgdGhlIFgvWSBjb29yZGluYXRlcyBvZiB0aGUgY2xpY2sKICogKHZpYSB0aGUgZXZlbnQgcGFyYW1ldGVyKSB3ZSBjYW4gc2V0IHRoZSBgdG9wYCBhbmQgYGxlZnRgIHN0eWxlcyBpbnRvIGFuIG9iamVjdCBhbmQgcGFzcyB0aGF0IGludG8gb3VyIGZ1bmN0aW9uCiAqIGNhbGwgdG8gYCRhbmltYXRlLmFkZENsYXNzYC4KICoKICogYGBganMKICogY2FudmFzLm9uKCdjbGljaycsIGZ1bmN0aW9uKGUpIHsKICogICAkYW5pbWF0ZS5hZGRDbGFzcyhlbGVtZW50LCAnb24nLCB7CiAqICAgICB0bzogewogKiAgICAgICBsZWZ0IDogZS5jbGllbnQueCArICdweCcsCiAqICAgICAgIHRvcCA6IGUuY2xpZW50LnkgKyAncHgnCiAqICAgICB9CiAqICAgfSk6CiAqIH0pOwogKiBgYGAKICoKICogTm93IHdoZW4gdGhlIGFuaW1hdGlvbiBydW5zLCBhbmQgYSB0cmFuc2l0aW9uIG9yIGtleWZyYW1lIGFuaW1hdGlvbiBpcyBwaWNrZWQgdXAsIHRoZW4gdGhlIGFuaW1hdGlvbiBpdHNlbGYgd2lsbAogKiBhbHNvIGluY2x1ZGUgYW5kIHRyYW5zaXRpb24gdGhlIHN0eWxpbmcgb2YgdGhlIGBsZWZ0YCBhbmQgYHRvcGAgcHJvcGVydGllcyBpbnRvIGl0cyBydW5uaW5nIGFuaW1hdGlvbi4gSWYgd2Ugd2FudAogKiB0byBwcm92aWRlIHNvbWUgc3RhcnRpbmcgYW5pbWF0aW9uIHZhbHVlcyB0aGVuIHdlIGNhbiBkbyBzbyBieSBwbGFjaW5nIHRoZSBzdGFydGluZyBhbmltYXRpb25zIHN0eWxlcyBpbnRvIGFuIG9iamVjdAogKiBjYWxsZWQgYGZyb21gIGluIHRoZSBzYW1lIG9iamVjdCBhcyB0aGUgYHRvYCBhbmltYXRpb25zLgogKgogKiBgYGBqcwogKiBjYW52YXMub24oJ2NsaWNrJywgZnVuY3Rpb24oZSkgewogKiAgICRhbmltYXRlLmFkZENsYXNzKGVsZW1lbnQsICdvbicsIHsKICogICAgIGZyb206IHsKICogICAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogKiAgICAgICAgbGVmdDogJzBweCcsCiAqICAgICAgICB0b3A6ICcwcHgnCiAqICAgICB9LAogKiAgICAgdG86IHsKICogICAgICAgbGVmdCA6IGUuY2xpZW50LnggKyAncHgnLAogKiAgICAgICB0b3AgOiBlLmNsaWVudC55ICsgJ3B4JwogKiAgICAgfQogKiAgIH0pOgogKiB9KTsKICogYGBgCiAqCiAqIE9uY2UgdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZSBvciBjYW5jZWxsZWQgdGhlbiB0aGUgdW5pb24gb2YgYm90aCB0aGUgYmVmb3JlIGFuZCBhZnRlciBzdHlsZXMgYXJlIGFwcGxpZWQgdG8gdGhlCiAqIGVsZW1lbnQuIElmIGBuZ0FuaW1hdGVgIGlzIG5vdCBwcmVzZW50IHRoZW4gdGhlIHN0eWxlcyB3aWxsIGJlIGFwcGxpZWQgaW1tZWRpYXRlbHkuCiAqCiAqLwoKYW5ndWxhci5tb2R1bGUoJ25nQW5pbWF0ZScsIFsnbmcnXSkKCiAgLyoqCiAgICogQG5nZG9jIHByb3ZpZGVyCiAgICogQG5hbWUgJGFuaW1hdGVQcm92aWRlcgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogVGhlIGAkYW5pbWF0ZVByb3ZpZGVyYCBhbGxvd3MgZGV2ZWxvcGVycyB0byByZWdpc3RlciBKYXZhU2NyaXB0IGFuaW1hdGlvbiBldmVudCBoYW5kbGVycyBkaXJlY3RseSBpbnNpZGUgb2YgYSBtb2R1bGUuCiAgICogV2hlbiBhbiBhbmltYXRpb24gaXMgdHJpZ2dlcmVkLCB0aGUgJGFuaW1hdGUgc2VydmljZSB3aWxsIHF1ZXJ5IHRoZSAkYW5pbWF0ZSBzZXJ2aWNlIHRvIGZpbmQgYW55IGFuaW1hdGlvbnMgdGhhdCBtYXRjaAogICAqIHRoZSBwcm92aWRlZCBuYW1lIHZhbHVlLgogICAqCiAgICogUmVxdWlyZXMgdGhlIHtAbGluayBuZ0FuaW1hdGUgYG5nQW5pbWF0ZWB9IG1vZHVsZSB0byBiZSBpbnN0YWxsZWQuCiAgICoKICAgKiBQbGVhc2UgdmlzaXQgdGhlIHtAbGluayBuZ0FuaW1hdGUgYG5nQW5pbWF0ZWB9IG1vZHVsZSBvdmVydmlldyBwYWdlIGxlYXJuIG1vcmUgYWJvdXQgaG93IHRvIHVzZSBhbmltYXRpb25zIGluIHlvdXIgYXBwbGljYXRpb24uCiAgICoKICAgKi8KICAuZGlyZWN0aXZlKCduZ0FuaW1hdGVDaGlsZHJlbicsIGZ1bmN0aW9uKCkgewogICAgdmFyIE5HX0FOSU1BVEVfQ0hJTERSRU4gPSAnJCRuZ0FuaW1hdGVDaGlsZHJlbic7CiAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgIHZhciB2YWwgPSBhdHRycy5uZ0FuaW1hdGVDaGlsZHJlbjsKICAgICAgaWYgKGFuZ3VsYXIuaXNTdHJpbmcodmFsKSAmJiB2YWwubGVuZ3RoID09PSAwKSB7IC8vZW1wdHkgYXR0cmlidXRlCiAgICAgICAgZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ0hJTERSRU4sIHRydWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHNjb3BlLiR3YXRjaCh2YWwsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9DSElMRFJFTiwgISF2YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgfSkKCiAgLy90aGlzIHByaXZhdGUgc2VydmljZSBpcyBvbmx5IHVzZWQgd2l0aGluIENTUy1lbmFibGVkIGFuaW1hdGlvbnMKICAvL0lFOCArIElFOSBkbyBub3Qgc3VwcG9ydCByQUYgbmF0aXZlbHksIGJ1dCB0aGF0IGlzIGZpbmUgc2luY2UgdGhleQogIC8vYWxzbyBkb24ndCBzdXBwb3J0IHRyYW5zaXRpb25zIGFuZCBrZXlmcmFtZXMgd2hpY2ggbWVhbnMgdGhhdCB0aGUgY29kZQogIC8vYmVsb3cgd2lsbCBuZXZlciBiZSB1c2VkIGJ5IHRoZSB0d28gYnJvd3NlcnMuCiAgLmZhY3RvcnkoJyQkYW5pbWF0ZVJlZmxvdycsIFsnJCRyQUYnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24oJCRyQUYsICRkb2N1bWVudCkgewogICAgdmFyIGJvZCA9ICRkb2N1bWVudFswXS5ib2R5OwogICAgcmV0dXJuIGZ1bmN0aW9uKGZuKSB7CiAgICAgIC8vdGhlIHJldHVybmVkIGZ1bmN0aW9uIGFjdHMgYXMgdGhlIGNhbmNlbGxhdGlvbiBmdW5jdGlvbgogICAgICByZXR1cm4gJCRyQUYoZnVuY3Rpb24oKSB7CiAgICAgICAgLy90aGUgbGluZSBiZWxvdyB3aWxsIGZvcmNlIHRoZSBicm93c2VyIHRvIHBlcmZvcm0gYSByZXBhaW50CiAgICAgICAgLy9zbyB0aGF0IGFsbCB0aGUgYW5pbWF0ZWQgZWxlbWVudHMgd2l0aGluIHRoZSBhbmltYXRpb24gZnJhbWUKICAgICAgICAvL3dpbGwgYmUgcHJvcGVybHkgdXBkYXRlZCBhbmQgZHJhd24gb24gc2NyZWVuLiBUaGlzIGlzCiAgICAgICAgLy9yZXF1aXJlZCB0byBwZXJmb3JtIG11bHRpLWNsYXNzIENTUyBiYXNlZCBhbmltYXRpb25zIHdpdGgKICAgICAgICAvL0ZpcmVmb3guIERPIE5PVCBSRU1PVkUgVEhJUyBMSU5FLgogICAgICAgIHZhciBhID0gYm9kLm9mZnNldFdpZHRoICsgMTsKICAgICAgICBmbigpOwogICAgICB9KTsKICAgIH07CiAgfV0pCgogIC5jb25maWcoWyckcHJvdmlkZScsICckYW5pbWF0ZVByb3ZpZGVyJywgZnVuY3Rpb24oJHByb3ZpZGUsICRhbmltYXRlUHJvdmlkZXIpIHsKICAgIHZhciBub29wID0gYW5ndWxhci5ub29wOwogICAgdmFyIGZvckVhY2ggPSBhbmd1bGFyLmZvckVhY2g7CiAgICB2YXIgc2VsZWN0b3JzID0gJGFuaW1hdGVQcm92aWRlci4kJHNlbGVjdG9yczsKICAgIHZhciBpc0FycmF5ID0gYW5ndWxhci5pc0FycmF5OwogICAgdmFyIGlzU3RyaW5nID0gYW5ndWxhci5pc1N0cmluZzsKICAgIHZhciBpc09iamVjdCA9IGFuZ3VsYXIuaXNPYmplY3Q7CgogICAgdmFyIEVMRU1FTlRfTk9ERSA9IDE7CiAgICB2YXIgTkdfQU5JTUFURV9TVEFURSA9ICckJG5nQW5pbWF0ZVN0YXRlJzsKICAgIHZhciBOR19BTklNQVRFX0NISUxEUkVOID0gJyQkbmdBbmltYXRlQ2hpbGRyZW4nOwogICAgdmFyIE5HX0FOSU1BVEVfQ0xBU1NfTkFNRSA9ICduZy1hbmltYXRlJzsKICAgIHZhciByb290QW5pbWF0ZVN0YXRlID0ge3J1bm5pbmc6IHRydWV9OwoKICAgIGZ1bmN0aW9uIGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KSB7CiAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBlbGVtZW50Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGVsbSA9IGVsZW1lbnRbaV07CiAgICAgICAgaWYgKGVsbS5ub2RlVHlwZSA9PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgIHJldHVybiBlbG07CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcHJlcGFyZUVsZW1lbnQoZWxlbWVudCkgewogICAgICByZXR1cm4gZWxlbWVudCAmJiBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICB9CgogICAgZnVuY3Rpb24gc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpIHsKICAgICAgcmV0dXJuIGFuZ3VsYXIuZWxlbWVudChleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzTWF0Y2hpbmdFbGVtZW50KGVsbTEsIGVsbTIpIHsKICAgICAgcmV0dXJuIGV4dHJhY3RFbGVtZW50Tm9kZShlbG0xKSA9PSBleHRyYWN0RWxlbWVudE5vZGUoZWxtMik7CiAgICB9CgogICAgJHByb3ZpZGUuZGVjb3JhdG9yKCckYW5pbWF0ZScsCiAgICAgICAgWyckZGVsZWdhdGUnLCAnJCRxJywgJyRpbmplY3RvcicsICckc25pZmZlcicsICckcm9vdEVsZW1lbnQnLCAnJCRhc3luY0NhbGxiYWNrJywgJyRyb290U2NvcGUnLCAnJGRvY3VtZW50JywgJyR0ZW1wbGF0ZVJlcXVlc3QnLAogZnVuY3Rpb24oJGRlbGVnYXRlLCAgICQkcSwgICAkaW5qZWN0b3IsICAgJHNuaWZmZXIsICAgJHJvb3RFbGVtZW50LCAgICQkYXN5bmNDYWxsYmFjaywgICAkcm9vdFNjb3BlLCAgICRkb2N1bWVudCwgICAkdGVtcGxhdGVSZXF1ZXN0KSB7CgogICAgICAkcm9vdEVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFLCByb290QW5pbWF0ZVN0YXRlKTsKCiAgICAgIC8vIFdhaXQgdW50aWwgYWxsIGRpcmVjdGl2ZSBhbmQgcm91dGUtcmVsYXRlZCB0ZW1wbGF0ZXMgYXJlIGRvd25sb2FkZWQgYW5kCiAgICAgIC8vIGNvbXBpbGVkLiBUaGUgJHRlbXBsYXRlUmVxdWVzdC50b3RhbFBlbmRpbmdSZXF1ZXN0cyB2YXJpYWJsZSBrZWVwcyB0cmFjayBvZgogICAgICAvLyBhbGwgb2YgdGhlIHJlbW90ZSB0ZW1wbGF0ZXMgYmVpbmcgY3VycmVudGx5IGRvd25sb2FkZWQuIElmIHRoZXJlIGFyZSBubwogICAgICAvLyB0ZW1wbGF0ZXMgY3VycmVudGx5IGRvd25sb2FkaW5nIHRoZW4gdGhlIHdhdGNoZXIgd2lsbCBzdGlsbCBmaXJlIGFueXdheS4KICAgICAgdmFyIGRlcmVnaXN0ZXJXYXRjaCA9ICRyb290U2NvcGUuJHdhdGNoKAogICAgICAgIGZ1bmN0aW9uKCkgeyByZXR1cm4gJHRlbXBsYXRlUmVxdWVzdC50b3RhbFBlbmRpbmdSZXF1ZXN0czsgfSwKICAgICAgICBmdW5jdGlvbih2YWwsIG9sZFZhbCkgewogICAgICAgICAgaWYgKHZhbCAhPT0gMCkgcmV0dXJuOwogICAgICAgICAgZGVyZWdpc3RlcldhdGNoKCk7CgogICAgICAgICAgLy8gTm93IHRoYXQgYWxsIHRlbXBsYXRlcyBoYXZlIGJlZW4gZG93bmxvYWRlZCwgJGFuaW1hdGUgd2lsbCB3YWl0IHVudGlsCiAgICAgICAgICAvLyB0aGUgcG9zdCBkaWdlc3QgcXVldWUgaXMgZW1wdHkgYmVmb3JlIGVuYWJsaW5nIGFuaW1hdGlvbnMuIEJ5IGhhdmluZyB0d28KICAgICAgICAgIC8vIGNhbGxzIHRvICRwb3N0RGlnZXN0IGNhbGxzIHdlIGNhbiBlbnN1cmUgdGhhdCB0aGUgZmxhZyBpcyBlbmFibGVkIGF0IHRoZQogICAgICAgICAgLy8gdmVyeSBlbmQgb2YgdGhlIHBvc3QgZGlnZXN0IHF1ZXVlLiBTaW5jZSBhbGwgb2YgdGhlIGFuaW1hdGlvbnMgaW4gJGFuaW1hdGUKICAgICAgICAgIC8vIHVzZSAkcG9zdERpZ2VzdCwgaXQncyBpbXBvcnRhbnQgdGhhdCB0aGUgY29kZSBiZWxvdyBleGVjdXRlcyBhdCB0aGUgZW5kLgogICAgICAgICAgLy8gVGhpcyBiYXNpY2FsbHkgbWVhbnMgdGhhdCB0aGUgcGFnZSBpcyBmdWxseSBkb3dubG9hZGVkIGFuZCBjb21waWxlZCBiZWZvcmUKICAgICAgICAgIC8vIGFueSBhbmltYXRpb25zIGFyZSB0cmlnZ2VyZWQuCiAgICAgICAgICAkcm9vdFNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHJvb3RTY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcm9vdEFuaW1hdGVTdGF0ZS5ydW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICApOwoKICAgICAgdmFyIGdsb2JhbEFuaW1hdGlvbkNvdW50ZXIgPSAwOwogICAgICB2YXIgY2xhc3NOYW1lRmlsdGVyID0gJGFuaW1hdGVQcm92aWRlci5jbGFzc05hbWVGaWx0ZXIoKTsKICAgICAgdmFyIGlzQW5pbWF0YWJsZUNsYXNzTmFtZSA9ICFjbGFzc05hbWVGaWx0ZXIKICAgICAgICAgICAgICA/IGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfQogICAgICAgICAgICAgIDogZnVuY3Rpb24oY2xhc3NOYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2xhc3NOYW1lRmlsdGVyLnRlc3QoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB9OwoKICAgICAgZnVuY3Rpb24gY2xhc3NCYXNlZEFuaW1hdGlvbnNCbG9ja2VkKGVsZW1lbnQsIHNldHRlcikgewogICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpIHx8IHt9OwogICAgICAgIGlmIChzZXR0ZXIpIHsKICAgICAgICAgIGRhdGEucnVubmluZyA9IHRydWU7CiAgICAgICAgICBkYXRhLnN0cnVjdHVyYWwgPSB0cnVlOwogICAgICAgICAgZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUsIGRhdGEpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGF0YS5kaXNhYmxlZCB8fCAoZGF0YS5ydW5uaW5nICYmIGRhdGEuc3RydWN0dXJhbCk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHJ1bkFuaW1hdGlvblBvc3REaWdlc3QoZm4pIHsKICAgICAgICB2YXIgY2FuY2VsRm4sIGRlZmVyID0gJCRxLmRlZmVyKCk7CiAgICAgICAgZGVmZXIucHJvbWlzZS4kJGNhbmNlbEZuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBjYW5jZWxGbiAmJiBjYW5jZWxGbigpOwogICAgICAgIH07CiAgICAgICAgJHJvb3RTY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICBjYW5jZWxGbiA9IGZuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkZWZlci5yZXNvbHZlKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcGFyc2VBbmltYXRlT3B0aW9ucyhvcHRpb25zKSB7CiAgICAgICAgLy8gc29tZSBwbHVnaW4gY29kZSBtYXkgc3RpbGwgYmUgcGFzc2luZyBpbiB0aGUgY2FsbGJhY2sKICAgICAgICAvLyBmdW5jdGlvbiBhcyB0aGUgbGFzdCBwYXJhbSBmb3IgdGhlICRhbmltYXRlIG1ldGhvZHMgc28KICAgICAgICAvLyBpdCdzIGJlc3QgdG8gb25seSBhbGxvdyBzdHJpbmcgb3IgYXJyYXkgdmFsdWVzIGZvciBub3cKICAgICAgICBpZiAoaXNPYmplY3Qob3B0aW9ucykpIHsKICAgICAgICAgIGlmIChvcHRpb25zLnRlbXBDbGFzc2VzICYmIGlzU3RyaW5nKG9wdGlvbnMudGVtcENsYXNzZXMpKSB7CiAgICAgICAgICAgIG9wdGlvbnMudGVtcENsYXNzZXMgPSBvcHRpb25zLnRlbXBDbGFzc2VzLnNwbGl0KC9ccysvKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBvcHRpb25zOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gcmVzb2x2ZUVsZW1lbnRDbGFzc2VzKGVsZW1lbnQsIGNhY2hlLCBydW5uaW5nQW5pbWF0aW9ucykgewogICAgICAgIHJ1bm5pbmdBbmltYXRpb25zID0gcnVubmluZ0FuaW1hdGlvbnMgfHwge307CgogICAgICAgIHZhciBsb29rdXAgPSB7fTsKICAgICAgICBmb3JFYWNoKHJ1bm5pbmdBbmltYXRpb25zLCBmdW5jdGlvbihkYXRhLCBzZWxlY3RvcikgewogICAgICAgICAgZm9yRWFjaChzZWxlY3Rvci5zcGxpdCgnICcpLCBmdW5jdGlvbihzKSB7CiAgICAgICAgICAgIGxvb2t1cFtzXT1kYXRhOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIHZhciBoYXNDbGFzc2VzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICBmb3JFYWNoKChlbGVtZW50LmF0dHIoJ2NsYXNzJykgfHwgJycpLnNwbGl0KC9ccysvKSwgZnVuY3Rpb24oY2xhc3NOYW1lKSB7CiAgICAgICAgICBoYXNDbGFzc2VzW2NsYXNzTmFtZV0gPSB0cnVlOwogICAgICAgIH0pOwoKICAgICAgICB2YXIgdG9BZGQgPSBbXSwgdG9SZW1vdmUgPSBbXTsKICAgICAgICBmb3JFYWNoKGNhY2hlLmNsYXNzZXMsIGZ1bmN0aW9uKHN0YXR1cywgY2xhc3NOYW1lKSB7CiAgICAgICAgICB2YXIgaGFzQ2xhc3MgPSBoYXNDbGFzc2VzW2NsYXNzTmFtZV07CiAgICAgICAgICB2YXIgbWF0Y2hpbmdBbmltYXRpb24gPSBsb29rdXBbY2xhc3NOYW1lXSB8fCB7fTsKCiAgICAgICAgICAvLyBXaGVuIGFkZENsYXNzIGFuZCByZW1vdmVDbGFzcyBpcyBjYWxsZWQgdGhlbiAkYW5pbWF0ZSB3aWxsIGNoZWNrIHRvCiAgICAgICAgICAvLyBzZWUgaWYgYWRkQ2xhc3MgYW5kIHJlbW92ZUNsYXNzIGNhbmNlbCBlYWNoIG90aGVyIG91dC4gV2hlbiB0aGVyZSBhcmUKICAgICAgICAgIC8vIG1vcmUgY2FsbHMgdG8gcmVtb3ZlQ2xhc3MgdGhhbiBhZGRDbGFzcyB0aGVuIHRoZSBjb3VudCBmYWxscyBiZWxvdyAwCiAgICAgICAgICAvLyBhbmQgdGhlbiB0aGUgcmVtb3ZlQ2xhc3MgYW5pbWF0aW9uIHdpbGwgYmUgYWxsb3dlZC4gT3RoZXJ3aXNlIGlmIHRoZQogICAgICAgICAgLy8gY291bnQgaXMgYWJvdmUgMCB0aGVuIHRoYXQgbWVhbnMgYW4gYWRkQ2xhc3MgYW5pbWF0aW9uIHdpbGwgY29tbWVuY2UuCiAgICAgICAgICAvLyBPbmNlIGFuIGFuaW1hdGlvbiBpcyBhbGxvd2VkIHRoZW4gdGhlIGNvZGUgd2lsbCBhbHNvIGNoZWNrIHRvIHNlZSBpZgogICAgICAgICAgLy8gdGhlcmUgZXhpc3RzIGFueSBvbi1nb2luZyBhbmltYXRpb24gdGhhdCBpcyBhbHJlYWR5IGFkZGluZyBvciByZW12b2luZwogICAgICAgICAgLy8gdGhlIG1hdGNoaW5nIENTUyBjbGFzcy4KICAgICAgICAgIGlmIChzdGF0dXMgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIC8vZG9lcyBpdCBoYXZlIHRoZSBjbGFzcyBvciB3aWxsIGl0IGhhdmUgdGhlIGNsYXNzCiAgICAgICAgICAgIGlmIChoYXNDbGFzcyB8fCBtYXRjaGluZ0FuaW1hdGlvbi5ldmVudCA9PSAnYWRkQ2xhc3MnKSB7CiAgICAgICAgICAgICAgdG9SZW1vdmUucHVzaChjbGFzc05hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gdHJ1ZSkgewogICAgICAgICAgICAvL2lzIHRoZSBjbGFzcyBtaXNzaW5nIG9yIHdpbGwgaXQgYmUgcmVtb3ZlZD8KICAgICAgICAgICAgaWYgKCFoYXNDbGFzcyB8fCBtYXRjaGluZ0FuaW1hdGlvbi5ldmVudCA9PSAncmVtb3ZlQ2xhc3MnKSB7CiAgICAgICAgICAgICAgdG9BZGQucHVzaChjbGFzc05hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiAodG9BZGQubGVuZ3RoICsgdG9SZW1vdmUubGVuZ3RoKSA+IDAgJiYgW3RvQWRkLmpvaW4oJyAnKSwgdG9SZW1vdmUuam9pbignICcpXTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gbG9va3VwKG5hbWUpIHsKICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgdmFyIG1hdGNoZXMgPSBbXSwKICAgICAgICAgICAgICBmbGFnTWFwID0ge30sCiAgICAgICAgICAgICAgY2xhc3NlcyA9IG5hbWUuc3Vic3RyKDEpLnNwbGl0KCcuJyk7CgogICAgICAgICAgLy90aGUgZW1wdHkgc3RyaW5nIHZhbHVlIGlzIHRoZSBkZWZhdWx0IGFuaW1hdGlvbgogICAgICAgICAgLy9vcGVyYXRpb24gd2hpY2ggcGVyZm9ybXMgQ1NTIHRyYW5zaXRpb24gYW5kIGtleWZyYW1lCiAgICAgICAgICAvL2FuaW1hdGlvbnMgc25pZmZpbmcuIFRoaXMgaXMgYWx3YXlzIGluY2x1ZGVkIGZvciBlYWNoCiAgICAgICAgICAvL2VsZW1lbnQgYW5pbWF0aW9uIHByb2NlZHVyZSBpZiB0aGUgYnJvd3NlciBzdXBwb3J0cwogICAgICAgICAgLy90cmFuc2l0aW9ucyBhbmQvb3Iga2V5ZnJhbWUgYW5pbWF0aW9ucy4gVGhlIGRlZmF1bHQKICAgICAgICAgIC8vYW5pbWF0aW9uIGlzIGFkZGVkIHRvIHRoZSB0b3Agb2YgdGhlIGxpc3QgdG8gcHJldmVudAogICAgICAgICAgLy9hbnkgcHJldmlvdXMgYW5pbWF0aW9ucyBmcm9tIGFmZmVjdGluZyB0aGUgZWxlbWVudCBzdHlsaW5nCiAgICAgICAgICAvL3ByaW9yIHRvIHRoZSBlbGVtZW50IGJlaW5nIGFuaW1hdGVkLgogICAgICAgICAgaWYgKCRzbmlmZmVyLnRyYW5zaXRpb25zIHx8ICRzbmlmZmVyLmFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKCRpbmplY3Rvci5nZXQoc2VsZWN0b3JzWycnXSkpOwogICAgICAgICAgfQoKICAgICAgICAgIGZvcih2YXIgaT0wOyBpIDwgY2xhc3Nlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIga2xhc3MgPSBjbGFzc2VzW2ldLAogICAgICAgICAgICAgICAgc2VsZWN0b3JGYWN0b3J5TmFtZSA9IHNlbGVjdG9yc1trbGFzc107CiAgICAgICAgICAgIGlmIChzZWxlY3RvckZhY3RvcnlOYW1lICYmICFmbGFnTWFwW2tsYXNzXSkgewogICAgICAgICAgICAgIG1hdGNoZXMucHVzaCgkaW5qZWN0b3IuZ2V0KHNlbGVjdG9yRmFjdG9yeU5hbWUpKTsKICAgICAgICAgICAgICBmbGFnTWFwW2tsYXNzXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaGVzOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gYW5pbWF0aW9uUnVubmVyKGVsZW1lbnQsIGFuaW1hdGlvbkV2ZW50LCBjbGFzc05hbWUsIG9wdGlvbnMpIHsKICAgICAgICAvL3RyYW5zY2x1ZGVkIGRpcmVjdGl2ZXMgbWF5IHNvbWV0aW1lcyBmaXJlIGFuIGFuaW1hdGlvbiB1c2luZyBvbmx5IGNvbW1lbnQgbm9kZXMKICAgICAgICAvL2Jlc3QgdG8gY2F0Y2ggdGhpcyBlYXJseSBvbiB0byBwcmV2ZW50IGFueSBhbmltYXRpb24gb3BlcmF0aW9ucyBmcm9tIG9jY3VycmluZwogICAgICAgIHZhciBub2RlID0gZWxlbWVudFswXTsKICAgICAgICBpZiAoIW5vZGUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zLnRvID0gb3B0aW9ucy50byB8fCB7fTsKICAgICAgICAgIG9wdGlvbnMuZnJvbSA9IG9wdGlvbnMuZnJvbSB8fCB7fTsKICAgICAgICB9CgogICAgICAgIHZhciBjbGFzc05hbWVBZGQ7CiAgICAgICAgdmFyIGNsYXNzTmFtZVJlbW92ZTsKICAgICAgICBpZiAoaXNBcnJheShjbGFzc05hbWUpKSB7CiAgICAgICAgICBjbGFzc05hbWVBZGQgPSBjbGFzc05hbWVbMF07CiAgICAgICAgICBjbGFzc05hbWVSZW1vdmUgPSBjbGFzc05hbWVbMV07CiAgICAgICAgICBpZiAoIWNsYXNzTmFtZUFkZCkgewogICAgICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWVSZW1vdmU7CiAgICAgICAgICAgIGFuaW1hdGlvbkV2ZW50ID0gJ3JlbW92ZUNsYXNzJzsKICAgICAgICAgIH0gZWxzZSBpZiAoIWNsYXNzTmFtZVJlbW92ZSkgewogICAgICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWVBZGQ7CiAgICAgICAgICAgIGFuaW1hdGlvbkV2ZW50ID0gJ2FkZENsYXNzJzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZUFkZCArICcgJyArIGNsYXNzTmFtZVJlbW92ZTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBpc1NldENsYXNzT3BlcmF0aW9uID0gYW5pbWF0aW9uRXZlbnQgPT0gJ3NldENsYXNzJzsKICAgICAgICB2YXIgaXNDbGFzc0Jhc2VkID0gaXNTZXRDbGFzc09wZXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICB8fCBhbmltYXRpb25FdmVudCA9PSAnYWRkQ2xhc3MnCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHx8IGFuaW1hdGlvbkV2ZW50ID09ICdyZW1vdmVDbGFzcycKICAgICAgICAgICAgICAgICAgICAgICAgICAgfHwgYW5pbWF0aW9uRXZlbnQgPT0gJ2FuaW1hdGUnOwoKICAgICAgICB2YXIgY3VycmVudENsYXNzTmFtZSA9IGVsZW1lbnQuYXR0cignY2xhc3MnKTsKICAgICAgICB2YXIgY2xhc3NlcyA9IGN1cnJlbnRDbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWU7CiAgICAgICAgaWYgKCFpc0FuaW1hdGFibGVDbGFzc05hbWUoY2xhc3NlcykpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBiZWZvcmVDb21wbGV0ZSA9IG5vb3AsCiAgICAgICAgICAgIGJlZm9yZUNhbmNlbCA9IFtdLAogICAgICAgICAgICBiZWZvcmUgPSBbXSwKICAgICAgICAgICAgYWZ0ZXJDb21wbGV0ZSA9IG5vb3AsCiAgICAgICAgICAgIGFmdGVyQ2FuY2VsID0gW10sCiAgICAgICAgICAgIGFmdGVyID0gW107CgogICAgICAgIHZhciBhbmltYXRpb25Mb29rdXAgPSAoJyAnICsgY2xhc3NlcykucmVwbGFjZSgvXHMrL2csJy4nKTsKICAgICAgICBmb3JFYWNoKGxvb2t1cChhbmltYXRpb25Mb29rdXApLCBmdW5jdGlvbihhbmltYXRpb25GYWN0b3J5KSB7CiAgICAgICAgICB2YXIgY3JlYXRlZCA9IHJlZ2lzdGVyQW5pbWF0aW9uKGFuaW1hdGlvbkZhY3RvcnksIGFuaW1hdGlvbkV2ZW50KTsKICAgICAgICAgIGlmICghY3JlYXRlZCAmJiBpc1NldENsYXNzT3BlcmF0aW9uKSB7CiAgICAgICAgICAgIHJlZ2lzdGVyQW5pbWF0aW9uKGFuaW1hdGlvbkZhY3RvcnksICdhZGRDbGFzcycpOwogICAgICAgICAgICByZWdpc3RlckFuaW1hdGlvbihhbmltYXRpb25GYWN0b3J5LCAncmVtb3ZlQ2xhc3MnKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJBbmltYXRpb24oYW5pbWF0aW9uRmFjdG9yeSwgZXZlbnQpIHsKICAgICAgICAgIHZhciBhZnRlckZuID0gYW5pbWF0aW9uRmFjdG9yeVtldmVudF07CiAgICAgICAgICB2YXIgYmVmb3JlRm4gPSBhbmltYXRpb25GYWN0b3J5WydiZWZvcmUnICsgZXZlbnQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBldmVudC5zdWJzdHIoMSldOwogICAgICAgICAgaWYgKGFmdGVyRm4gfHwgYmVmb3JlRm4pIHsKICAgICAgICAgICAgaWYgKGV2ZW50ID09ICdsZWF2ZScpIHsKICAgICAgICAgICAgICBiZWZvcmVGbiA9IGFmdGVyRm47CiAgICAgICAgICAgICAgLy93aGVuIHNldCBhcyBudWxsIHRoZW4gYW5pbWF0aW9uIGtub3dzIHRvIHNraXAgdGhpcyBwaGFzZQogICAgICAgICAgICAgIGFmdGVyRm4gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFmdGVyLnB1c2goewogICAgICAgICAgICAgIGV2ZW50IDogZXZlbnQsIGZuIDogYWZ0ZXJGbgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYmVmb3JlLnB1c2goewogICAgICAgICAgICAgIGV2ZW50IDogZXZlbnQsIGZuIDogYmVmb3JlRm4KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcnVuKGZucywgY2FuY2VsbGF0aW9ucywgYWxsQ29tcGxldGVGbikgewogICAgICAgICAgdmFyIGFuaW1hdGlvbnMgPSBbXTsKICAgICAgICAgIGZvckVhY2goZm5zLCBmdW5jdGlvbihhbmltYXRpb24pIHsKICAgICAgICAgICAgYW5pbWF0aW9uLmZuICYmIGFuaW1hdGlvbnMucHVzaChhbmltYXRpb24pOwogICAgICAgICAgfSk7CgogICAgICAgICAgdmFyIGNvdW50ID0gMDsKICAgICAgICAgIGZ1bmN0aW9uIGFmdGVyQW5pbWF0aW9uQ29tcGxldGUoaW5kZXgpIHsKICAgICAgICAgICAgaWYgKGNhbmNlbGxhdGlvbnMpIHsKICAgICAgICAgICAgICAoY2FuY2VsbGF0aW9uc1tpbmRleF0gfHwgbm9vcCkoKTsKICAgICAgICAgICAgICBpZiAoKytjb3VudCA8IGFuaW1hdGlvbnMubGVuZ3RoKSByZXR1cm47CiAgICAgICAgICAgICAgY2FuY2VsbGF0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWxsQ29tcGxldGVGbigpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vVGhlIGNvZGUgYmVsb3cgYWRkcyBkaXJlY3RseSB0byB0aGUgYXJyYXkgaW4gb3JkZXIgdG8gd29yayB3aXRoCiAgICAgICAgICAvL2JvdGggc3luYyBhbmQgYXN5bmMgYW5pbWF0aW9ucy4gU3luYyBhbmltYXRpb25zIGFyZSB3aGVuIHRoZSBkb25lKCkKICAgICAgICAgIC8vb3BlcmF0aW9uIGlzIGNhbGxlZCByaWdodCBhd2F5LiBETyBOT1QgUkVGQUNUT1IhCiAgICAgICAgICBmb3JFYWNoKGFuaW1hdGlvbnMsIGZ1bmN0aW9uKGFuaW1hdGlvbiwgaW5kZXgpIHsKICAgICAgICAgICAgdmFyIHByb2dyZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgYWZ0ZXJBbmltYXRpb25Db21wbGV0ZShpbmRleCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHN3aXRjaChhbmltYXRpb24uZXZlbnQpIHsKICAgICAgICAgICAgICBjYXNlICdzZXRDbGFzcyc6CiAgICAgICAgICAgICAgICBjYW5jZWxsYXRpb25zLnB1c2goYW5pbWF0aW9uLmZuKGVsZW1lbnQsIGNsYXNzTmFtZUFkZCwgY2xhc3NOYW1lUmVtb3ZlLCBwcm9ncmVzcywgb3B0aW9ucykpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnYW5pbWF0ZSc6CiAgICAgICAgICAgICAgICBjYW5jZWxsYXRpb25zLnB1c2goYW5pbWF0aW9uLmZuKGVsZW1lbnQsIGNsYXNzTmFtZSwgb3B0aW9ucy5mcm9tLCBvcHRpb25zLnRvLCBwcm9ncmVzcykpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnYWRkQ2xhc3MnOgogICAgICAgICAgICAgICAgY2FuY2VsbGF0aW9ucy5wdXNoKGFuaW1hdGlvbi5mbihlbGVtZW50LCBjbGFzc05hbWVBZGQgfHwgY2xhc3NOYW1lLCAgICAgcHJvZ3Jlc3MsIG9wdGlvbnMpKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ3JlbW92ZUNsYXNzJzoKICAgICAgICAgICAgICAgIGNhbmNlbGxhdGlvbnMucHVzaChhbmltYXRpb24uZm4oZWxlbWVudCwgY2xhc3NOYW1lUmVtb3ZlIHx8IGNsYXNzTmFtZSwgIHByb2dyZXNzLCBvcHRpb25zKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgY2FuY2VsbGF0aW9ucy5wdXNoKGFuaW1hdGlvbi5mbihlbGVtZW50LCBwcm9ncmVzcywgb3B0aW9ucykpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIGlmIChjYW5jZWxsYXRpb25zICYmIGNhbmNlbGxhdGlvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGFsbENvbXBsZXRlRm4oKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBub2RlIDogbm9kZSwKICAgICAgICAgIGV2ZW50IDogYW5pbWF0aW9uRXZlbnQsCiAgICAgICAgICBjbGFzc05hbWUgOiBjbGFzc05hbWUsCiAgICAgICAgICBpc0NsYXNzQmFzZWQgOiBpc0NsYXNzQmFzZWQsCiAgICAgICAgICBpc1NldENsYXNzT3BlcmF0aW9uIDogaXNTZXRDbGFzc09wZXJhdGlvbiwKICAgICAgICAgIGFwcGx5U3R5bGVzIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChvcHRpb25zKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5jc3MoYW5ndWxhci5leHRlbmQob3B0aW9ucy5mcm9tIHx8IHt9LCBvcHRpb25zLnRvIHx8IHt9KSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBiZWZvcmUgOiBmdW5jdGlvbihhbGxDb21wbGV0ZUZuKSB7CiAgICAgICAgICAgIGJlZm9yZUNvbXBsZXRlID0gYWxsQ29tcGxldGVGbjsKICAgICAgICAgICAgcnVuKGJlZm9yZSwgYmVmb3JlQ2FuY2VsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBiZWZvcmVDb21wbGV0ZSA9IG5vb3A7CiAgICAgICAgICAgICAgYWxsQ29tcGxldGVGbigpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBhZnRlciA6IGZ1bmN0aW9uKGFsbENvbXBsZXRlRm4pIHsKICAgICAgICAgICAgYWZ0ZXJDb21wbGV0ZSA9IGFsbENvbXBsZXRlRm47CiAgICAgICAgICAgIHJ1bihhZnRlciwgYWZ0ZXJDYW5jZWwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGFmdGVyQ29tcGxldGUgPSBub29wOwogICAgICAgICAgICAgIGFsbENvbXBsZXRlRm4oKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgY2FuY2VsIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChiZWZvcmVDYW5jZWwpIHsKICAgICAgICAgICAgICBmb3JFYWNoKGJlZm9yZUNhbmNlbCwgZnVuY3Rpb24oY2FuY2VsRm4pIHsKICAgICAgICAgICAgICAgIChjYW5jZWxGbiB8fCBub29wKSh0cnVlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBiZWZvcmVDb21wbGV0ZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWZ0ZXJDYW5jZWwpIHsKICAgICAgICAgICAgICBmb3JFYWNoKGFmdGVyQ2FuY2VsLCBmdW5jdGlvbihjYW5jZWxGbikgewogICAgICAgICAgICAgICAgKGNhbmNlbEZuIHx8IG5vb3ApKHRydWUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGFmdGVyQ29tcGxldGUodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CgogICAgICAvKioKICAgICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAgICogQG5hbWUgJGFuaW1hdGUKICAgICAgICogQGtpbmQgb2JqZWN0CiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBUaGUgYCRhbmltYXRlYCBzZXJ2aWNlIHByb3ZpZGVzIGFuaW1hdGlvbiBkZXRlY3Rpb24gc3VwcG9ydCB3aGlsZSBwZXJmb3JtaW5nIERPTSBvcGVyYXRpb25zIChlbnRlciwgbGVhdmUgYW5kIG1vdmUpIGFzIHdlbGwgYXMgZHVyaW5nIGFkZENsYXNzIGFuZCByZW1vdmVDbGFzcyBvcGVyYXRpb25zLgogICAgICAgKiBXaGVuIGFueSBvZiB0aGVzZSBvcGVyYXRpb25zIGFyZSBydW4sIHRoZSAkYW5pbWF0ZSBzZXJ2aWNlCiAgICAgICAqIHdpbGwgZXhhbWluZSBhbnkgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgKHdoaWNoIGFyZSBkZWZpbmVkIGJ5IHVzaW5nIHRoZSAkYW5pbWF0ZVByb3ZpZGVyIHByb3ZpZGVyIG9iamVjdCkKICAgICAgICogYXMgd2VsbCBhcyBhbnkgQ1NTLWRlZmluZWQgYW5pbWF0aW9ucyBhZ2FpbnN0IHRoZSBDU1MgY2xhc3NlcyBwcmVzZW50IG9uIHRoZSBlbGVtZW50IG9uY2UgdGhlIERPTSBvcGVyYXRpb24gaXMgcnVuLgogICAgICAgKgogICAgICAgKiBUaGUgYCRhbmltYXRlYCBzZXJ2aWNlIGlzIHVzZWQgYmVoaW5kIHRoZSBzY2VuZXMgd2l0aCBwcmUtZXhpc3RpbmcgZGlyZWN0aXZlcyBhbmQgYW5pbWF0aW9uIHdpdGggdGhlc2UgZGlyZWN0aXZlcwogICAgICAgKiB3aWxsIHdvcmsgb3V0IG9mIHRoZSBib3ggd2l0aG91dCBhbnkgZXh0cmEgY29uZmlndXJhdGlvbi4KICAgICAgICoKICAgICAgICogUmVxdWlyZXMgdGhlIHtAbGluayBuZ0FuaW1hdGUgYG5nQW5pbWF0ZWB9IG1vZHVsZSB0byBiZSBpbnN0YWxsZWQuCiAgICAgICAqCiAgICAgICAqIFBsZWFzZSB2aXNpdCB0aGUge0BsaW5rIG5nQW5pbWF0ZSBgbmdBbmltYXRlYH0gbW9kdWxlIG92ZXJ2aWV3IHBhZ2UgbGVhcm4gbW9yZSBhYm91dCBob3cgdG8gdXNlIGFuaW1hdGlvbnMgaW4geW91ciBhcHBsaWNhdGlvbi4KICAgICAgICogIyMgQ2FsbGJhY2sgUHJvbWlzZXMKICAgICAgICogV2l0aCBBbmd1bGFySlMgMS4zLCBlYWNoIG9mIHRoZSBhbmltYXRpb24gbWV0aG9kcywgb24gdGhlIGAkYW5pbWF0ZWAgc2VydmljZSwgcmV0dXJuIGEgcHJvbWlzZSB3aGVuIGNhbGxlZC4gVGhlCiAgICAgICAqIHByb21pc2UgaXRzZWxmIGlzIHRoZW4gcmVzb2x2ZWQgb25jZSB0aGUgYW5pbWF0aW9uIGhhcyBjb21wbGV0ZWQgaXRzZWxmLCBoYXMgYmVlbiBjYW5jZWxsZWQgb3IgaGFzIGJlZW4KICAgICAgICogc2tpcHBlZCBkdWUgdG8gYW5pbWF0aW9ucyBiZWluZyBkaXNhYmxlZC4gKE5vdGUgdGhhdCBldmVuIGlmIHRoZSBhbmltYXRpb24gaXMgY2FuY2VsbGVkIGl0IHdpbGwgc3RpbGwKICAgICAgICogY2FsbCB0aGUgcmVzb2x2ZSBmdW5jdGlvbiBvZiB0aGUgYW5pbWF0aW9uLikKICAgICAgICoKICAgICAgICogYGBganMKICAgICAgICogJGFuaW1hdGUuZW50ZXIoZWxlbWVudCwgY29udGFpbmVyKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgKiAgIC8vLi4udGhpcyBpcyBjYWxsZWQgb25jZSB0aGUgYW5pbWF0aW9uIGlzIGNvbXBsZXRlLi4uCiAgICAgICAqIH0pOwogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICogQWxzbyBub3RlIHRoYXQsIGR1ZSB0byB0aGUgbmF0dXJlIG9mIHRoZSBjYWxsYmFjayBwcm9taXNlLCBpZiBhbnkgQW5ndWxhci1zcGVjaWZpYyBjb2RlIChsaWtlIGNoYW5naW5nIHRoZSBzY29wZSwKICAgICAgICogbG9jYXRpb24gb2YgdGhlIHBhZ2UsIGV0Yy4uLikgaXMgZXhlY3V0ZWQgd2l0aGluIHRoZSBjYWxsYmFjayBwcm9taXNlIHRoZW4gYmUgc3VyZSB0byB3cmFwIHRoZSBjb2RlIHVzaW5nCiAgICAgICAqIGAkc2NvcGUuJGFwcGx5KC4uLilgOwogICAgICAgKgogICAgICAgKiBgYGBqcwogICAgICAgKiAkYW5pbWF0ZS5sZWF2ZShlbGVtZW50KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgKiAgICRzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAqICAgICAkbG9jYXRpb24ucGF0aCgnL25ldy1wYWdlJyk7CiAgICAgICAqICAgfSk7CiAgICAgICAqIH0pOwogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICogQW4gYW5pbWF0aW9uIGNhbiBhbHNvIGJlIGNhbmNlbGxlZCBieSBjYWxsaW5nIHRoZSBgJGFuaW1hdGUuY2FuY2VsKHByb21pc2UpYCBtZXRob2Qgd2l0aCB0aGUgcHJvdmlkZWQKICAgICAgICogcHJvbWlzZSB0aGF0IHdhcyByZXR1cm5lZCB3aGVuIHRoZSBhbmltYXRpb24gd2FzIHN0YXJ0ZWQuCiAgICAgICAqCiAgICAgICAqIGBgYGpzCiAgICAgICAqIHZhciBwcm9taXNlID0gJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgJ3N1cGVyLWxvbmctYW5pbWF0aW9uJykudGhlbihmdW5jdGlvbigpIHsKICAgICAgICogICAvL3RoaXMgd2lsbCBzdGlsbCBiZSBjYWxsZWQgZXZlbiBpZiBjYW5jZWxsZWQKICAgICAgICogfSk7CiAgICAgICAqCiAgICAgICAqIGVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAqICAgLy90b29vIGxhenkgdG8gd2FpdCBmb3IgdGhlIGFuaW1hdGlvbiB0byBlbmQKICAgICAgICogICAkYW5pbWF0ZS5jYW5jZWwocHJvbWlzZSk7CiAgICAgICAqIH0pOwogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICogKEtlZXAgaW4gbWluZCB0aGF0IHRoZSBwcm9taXNlIGNhbmNlbGxhdGlvbiBpcyB1bmlxdWUgdG8gYCRhbmltYXRlYCBzaW5jZSBwcm9taXNlcyBpbgogICAgICAgKiBnZW5lcmFsIGNhbm5vdCBiZSBjYW5jZWxsZWQuKQogICAgICAgKgogICAgICAgKi8KICAgICAgcmV0dXJuIHsKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjYW5pbWF0ZQogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBQZXJmb3JtcyBhbiBpbmxpbmUgYW5pbWF0aW9uIG9uIHRoZSBlbGVtZW50IHdoaWNoIGFwcGxpZXMgdGhlIHByb3ZpZGVkIGB0b2AgYW5kIGBmcm9tYCBDU1Mgc3R5bGVzIHRvIHRoZSBlbGVtZW50LgogICAgICAgICAqIElmIGFueSBkZXRlY3RlZCBDU1MgdHJhbnNpdGlvbiwga2V5ZnJhbWUgb3IgSmF2YVNjcmlwdCBtYXRjaGVzIHRoZSBwcm92aWRlZCBgY2xhc3NOYW1lYCB2YWx1ZSB0aGVuIHRoZSBhbmltYXRpb24KICAgICAgICAgKiB3aWxsIHRha2Ugb24gdGhlIHByb3ZpZGVkIHN0eWxlcy4gRm9yIGV4YW1wbGUsIGlmIGEgdHJhbnNpdGlvbiBhbmltYXRpb24gaXMgc2V0IGZvciB0aGUgZ2l2ZW4gY2xhc3NOYW1lIHRoZW4gdGhlCiAgICAgICAgICogcHJvdmlkZWQgYGZyb21gIGFuZCBgdG9gIHN0eWxlcyB3aWxsIGJlIGFwcGxpZWQgYWxvbmdzaWRlIHRoZSBnaXZlbiB0cmFuc2l0aW9uLiBJZiBhIEphdmFTY3JpcHQgYW5pbWF0aW9uIGlzCiAgICAgICAgICogZGV0ZWN0ZWQgdGhlbiB0aGUgcHJvdmlkZWQgc3R5bGVzIHdpbGwgYmUgZ2l2ZW4gaW4gYXMgZnVuY3Rpb24gcGFyYW10ZXJzLgogICAgICAgICAqCiAgICAgICAgICogYGBganMKICAgICAgICAgKiBuZ01vZHVsZS5hbmltYXRpb24oJy5teS1pbmxpbmUtYW5pbWF0aW9uJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICogICByZXR1cm4gewogICAgICAgICAqICAgICBhbmltYXRlIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBmcm9tLCB0bywgZG9uZSkgewogICAgICAgICAqICAgICAgIC8vc3R5bGVzCiAgICAgICAgICogICAgIH0KICAgICAgICAgKiAgIH0KICAgICAgICAgKiB9KTsKICAgICAgICAgKiBgYGAKICAgICAgICAgKgogICAgICAgICAqIEJlbG93IGlzIGEgYnJlYWtkb3duIG9mIGVhY2ggc3RlcCB0aGF0IG9jY3VycyBkdXJpbmcgdGhlIGBhbmltYXRlYCBhbmltYXRpb246CiAgICAgICAgICoKICAgICAgICAgKiB8IEFuaW1hdGlvbiBTdGVwICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgV2hhdCB0aGUgZWxlbWVudCBjbGFzcyBhdHRyaWJ1dGUgbG9va3MgbGlrZSAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICAgICAqIHwgMS4gJGFuaW1hdGUuYW5pbWF0ZSguLi4pIGlzIGNhbGxlZCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDIuICRhbmltYXRlIHdhaXRzIGZvciB0aGUgbmV4dCBkaWdlc3QgdG8gc3RhcnQgdGhlIGFuaW1hdGlvbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIiAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAzLiAkYW5pbWF0ZSBydW5zIHRoZSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyBkZXRlY3RlZCBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSIgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNC4gdGhlIGNsYXNzTmFtZSBjbGFzcyB2YWx1ZSBpcyBhZGRlZCB0byB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgY2xhc3NOYW1lIiAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDUuICRhbmltYXRlIHNjYW5zIHRoZSBlbGVtZW50IHN0eWxlcyB0byBnZXQgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBkdXJhdGlvbiBhbmQgZGVsYXkgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIGNsYXNzTmFtZSIgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA2LiAkYW5pbWF0ZSBibG9ja3MgYWxsIENTUyB0cmFuc2l0aW9ucyBvbiB0aGUgZWxlbWVudCB0byBlbnN1cmUgdGhlIC5jbGFzc05hbWUgY2xhc3Mgc3R5bGluZyBpcyBhcHBsaWVkIHJpZ2h0IGF3YXl8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBjbGFzc05hbWUiICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNy4gJGFuaW1hdGUgYXBwbGllcyB0aGUgcHJvdmlkZWQgY29sbGVjdGlvbiBvZiBgZnJvbWAgQ1NTIHN0eWxlcyB0byB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgY2xhc3NOYW1lIiAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDguICRhbmltYXRlIHdhaXRzIGZvciBhIHNpbmdsZSBhbmltYXRpb24gZnJhbWUgKHRoaXMgcGVyZm9ybXMgYSByZWZsb3cpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIGNsYXNzTmFtZSIgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA5LiAkYW5pbWF0ZSByZW1vdmVzIHRoZSBDU1MgdHJhbnNpdGlvbiBibG9jayBwbGFjZWQgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBjbGFzc05hbWUiICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMTAuIHRoZSBjbGFzc05hbWUtYWN0aXZlIGNsYXNzIGlzIGFkZGVkICh0aGlzIHRyaWdnZXJzIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24pICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgY2xhc3NOYW1lIGNsYXNzTmFtZS1hY3RpdmUiIHwKICAgICAgICAgKiB8IDExLiAkYW5pbWF0ZSBhcHBsaWVzIHRoZSBjb2xsZWN0aW9uIG9mIGB0b2AgQ1NTIHN0eWxlcyB0byB0aGUgZWxlbWVudCB3aGljaCBhcmUgdGhlbiBoYW5kbGVkIGJ5IHRoZSB0cmFuc2l0aW9uICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIGNsYXNzTmFtZSBjbGFzc05hbWUtYWN0aXZlIiB8CiAgICAgICAgICogfCAxMi4gJGFuaW1hdGUgd2FpdHMgZm9yIHRoZSBhbmltYXRpb24gdG8gY29tcGxldGUgKHZpYSBldmVudHMgYW5kIHRpbWVvdXQpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBjbGFzc05hbWUgY2xhc3NOYW1lLWFjdGl2ZSIgfAogICAgICAgICAqIHwgMTMuIFRoZSBhbmltYXRpb24gZW5kcyBhbmQgYWxsIGdlbmVyYXRlZCBDU1MgY2xhc3NlcyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDE0LiBUaGUgcmV0dXJuZWQgcHJvbWlzZSBpcyByZXNvbHZlZC4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgZW50ZXIgYW5pbWF0aW9uCiAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGZyb20gYSBjb2xsZWN0aW9uIG9mIENTUyBzdHlsZXMgdGhhdCB3aWxsIGJlIGFwcGxpZWQgdG8gdGhlIGVsZW1lbnQgYXQgdGhlIHN0YXJ0IG9mIHRoZSBhbmltYXRpb24KICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gdG8gYSBjb2xsZWN0aW9uIG9mIENTUyBzdHlsZXMgdGhhdCB0aGUgZWxlbWVudCB3aWxsIGFuaW1hdGUgdG93YXJkcwogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gY2xhc3NOYW1lIGFuIG9wdGlvbmFsIENTUyBjbGFzcyB0aGF0IHdpbGwgYmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uICh0aGUgZGVmYXVsdCBjbGFzcyBpcyBgbmctaW5saW5lLWFuaW1hdGVgKQogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBhbiBvcHRpb25hbCBjb2xsZWN0aW9uIG9mIG9wdGlvbnMgdGhhdCB3aWxsIGJlIHBpY2tlZCB1cCBieSB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uCiAgICAgICAgICogQHJldHVybiB7UHJvbWlzZX0gdGhlIGFuaW1hdGlvbiBjYWxsYmFjayBwcm9taXNlCiAgICAgICAgKi8KICAgICAgICBhbmltYXRlIDogZnVuY3Rpb24oZWxlbWVudCwgZnJvbSwgdG8sIGNsYXNzTmFtZSwgb3B0aW9ucykgewogICAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICduZy1pbmxpbmUtYW5pbWF0ZSc7CiAgICAgICAgICBvcHRpb25zID0gcGFyc2VBbmltYXRlT3B0aW9ucyhvcHRpb25zKSB8fCB7fTsKICAgICAgICAgIG9wdGlvbnMuZnJvbSA9IHRvID8gZnJvbSA6IG51bGw7CiAgICAgICAgICBvcHRpb25zLnRvICAgPSB0byA/IHRvIDogZnJvbTsKCiAgICAgICAgICByZXR1cm4gcnVuQW5pbWF0aW9uUG9zdERpZ2VzdChmdW5jdGlvbihkb25lKSB7CiAgICAgICAgICAgIHJldHVybiBwZXJmb3JtQW5pbWF0aW9uKCdhbmltYXRlJywgY2xhc3NOYW1lLCBzdHJpcENvbW1lbnRzRnJvbUVsZW1lbnQoZWxlbWVudCksIG51bGwsIG51bGwsIG5vb3AsIG9wdGlvbnMsIGRvbmUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI2VudGVyCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEFwcGVuZHMgdGhlIGVsZW1lbnQgdG8gdGhlIHBhcmVudEVsZW1lbnQgZWxlbWVudCB0aGF0IHJlc2lkZXMgaW4gdGhlIGRvY3VtZW50IGFuZCB0aGVuIHJ1bnMgdGhlIGVudGVyIGFuaW1hdGlvbi4gT25jZQogICAgICAgICAqIHRoZSBhbmltYXRpb24gaXMgc3RhcnRlZCwgdGhlIGZvbGxvd2luZyBDU1MgY2xhc3NlcyB3aWxsIGJlIHByZXNlbnQgb24gdGhlIGVsZW1lbnQgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogQmVsb3cgaXMgYSBicmVha2Rvd24gb2YgZWFjaCBzdGVwIHRoYXQgb2NjdXJzIGR1cmluZyBlbnRlciBhbmltYXRpb246CiAgICAgICAgICoKICAgICAgICAgKiB8IEFuaW1hdGlvbiBTdGVwICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgV2hhdCB0aGUgZWxlbWVudCBjbGFzcyBhdHRyaWJ1dGUgbG9va3MgbGlrZSAgICAgICAgICAgICAgfAogICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgICAgICogfCAxLiAkYW5pbWF0ZS5lbnRlciguLi4pIGlzIGNhbGxlZCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDIuIGVsZW1lbnQgaXMgaW5zZXJ0ZWQgaW50byB0aGUgcGFyZW50RWxlbWVudCBlbGVtZW50IG9yIGJlc2lkZSB0aGUgYWZ0ZXJFbGVtZW50IGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMy4gJGFuaW1hdGUgd2FpdHMgZm9yIHRoZSBuZXh0IGRpZ2VzdCB0byBzdGFydCB0aGUgYW5pbWF0aW9uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUiICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA0LiAkYW5pbWF0ZSBydW5zIHRoZSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyBkZXRlY3RlZCBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSIgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDUuIHRoZSAubmctZW50ZXIgY2xhc3MgaXMgYWRkZWQgdG8gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWVudGVyIiAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNi4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctZW50ZXIiICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA3LiAkYW5pbWF0ZSBibG9ja3MgYWxsIENTUyB0cmFuc2l0aW9ucyBvbiB0aGUgZWxlbWVudCB0byBlbnN1cmUgdGhlIC5uZy1lbnRlciBjbGFzcyBzdHlsaW5nIGlzIGFwcGxpZWQgcmlnaHQgYXdheSB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1lbnRlciIgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDguICRhbmltYXRlIHdhaXRzIGZvciBhIHNpbmdsZSBhbmltYXRpb24gZnJhbWUgKHRoaXMgcGVyZm9ybXMgYSByZWZsb3cpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWVudGVyIiAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgOS4gJGFuaW1hdGUgcmVtb3ZlcyB0aGUgQ1NTIHRyYW5zaXRpb24gYmxvY2sgcGxhY2VkIG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctZW50ZXIiICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAxMC4gdGhlIC5uZy1lbnRlci1hY3RpdmUgY2xhc3MgaXMgYWRkZWQgKHRoaXMgdHJpZ2dlcnMgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbikgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1lbnRlciBuZy1lbnRlci1hY3RpdmUiIHwKICAgICAgICAgKiB8IDExLiAkYW5pbWF0ZSB3YWl0cyBmb3IgdGhlIGFuaW1hdGlvbiB0byBjb21wbGV0ZSAodmlhIGV2ZW50cyBhbmQgdGltZW91dCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWVudGVyIG5nLWVudGVyLWFjdGl2ZSIgfAogICAgICAgICAqIHwgMTIuIFRoZSBhbmltYXRpb24gZW5kcyBhbmQgYWxsIGdlbmVyYXRlZCBDU1MgY2xhc3NlcyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAxMy4gVGhlIHJldHVybmVkIHByb21pc2UgaXMgcmVzb2x2ZWQuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgdGhlIGZvY3VzIG9mIHRoZSBlbnRlciBhbmltYXRpb24KICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IHBhcmVudEVsZW1lbnQgdGhlIHBhcmVudCBlbGVtZW50IG9mIHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIGVudGVyIGFuaW1hdGlvbgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gYWZ0ZXJFbGVtZW50IHRoZSBzaWJsaW5nIGVsZW1lbnQgKHdoaWNoIGlzIHRoZSBwcmV2aW91cyBlbGVtZW50KSBvZiB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgdGhlIGZvY3VzIG9mIHRoZSBlbnRlciBhbmltYXRpb24KICAgICAgICAgKiBAcGFyYW0ge29iamVjdD19IG9wdGlvbnMgYW4gb3B0aW9uYWwgY29sbGVjdGlvbiBvZiBvcHRpb25zIHRoYXQgd2lsbCBiZSBwaWNrZWQgdXAgYnkgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbgogICAgICAgICAqIEByZXR1cm4ge1Byb21pc2V9IHRoZSBhbmltYXRpb24gY2FsbGJhY2sgcHJvbWlzZQogICAgICAgICovCiAgICAgICAgZW50ZXIgOiBmdW5jdGlvbihlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQsIG9wdGlvbnMpIHsKICAgICAgICAgIG9wdGlvbnMgPSBwYXJzZUFuaW1hdGVPcHRpb25zKG9wdGlvbnMpOwogICAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgICAgICAgIHBhcmVudEVsZW1lbnQgPSBwcmVwYXJlRWxlbWVudChwYXJlbnRFbGVtZW50KTsKICAgICAgICAgIGFmdGVyRWxlbWVudCA9IHByZXBhcmVFbGVtZW50KGFmdGVyRWxlbWVudCk7CgogICAgICAgICAgY2xhc3NCYXNlZEFuaW1hdGlvbnNCbG9ja2VkKGVsZW1lbnQsIHRydWUpOwogICAgICAgICAgJGRlbGVnYXRlLmVudGVyKGVsZW1lbnQsIHBhcmVudEVsZW1lbnQsIGFmdGVyRWxlbWVudCk7CiAgICAgICAgICByZXR1cm4gcnVuQW5pbWF0aW9uUG9zdERpZ2VzdChmdW5jdGlvbihkb25lKSB7CiAgICAgICAgICAgIHJldHVybiBwZXJmb3JtQW5pbWF0aW9uKCdlbnRlcicsICduZy1lbnRlcicsIHN0cmlwQ29tbWVudHNGcm9tRWxlbWVudChlbGVtZW50KSwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50LCBub29wLCBvcHRpb25zLCBkb25lKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNsZWF2ZQogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSdW5zIHRoZSBsZWF2ZSBhbmltYXRpb24gb3BlcmF0aW9uIGFuZCwgdXBvbiBjb21wbGV0aW9uLCByZW1vdmVzIHRoZSBlbGVtZW50IGZyb20gdGhlIERPTS4gT25jZQogICAgICAgICAqIHRoZSBhbmltYXRpb24gaXMgc3RhcnRlZCwgdGhlIGZvbGxvd2luZyBDU1MgY2xhc3NlcyB3aWxsIGJlIGFkZGVkIGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIGFuaW1hdGlvbjoKICAgICAgICAgKgogICAgICAgICAqIEJlbG93IGlzIGEgYnJlYWtkb3duIG9mIGVhY2ggc3RlcCB0aGF0IG9jY3VycyBkdXJpbmcgbGVhdmUgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogfCBBbmltYXRpb24gU3RlcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IFdoYXQgdGhlIGVsZW1lbnQgY2xhc3MgYXR0cmlidXRlIGxvb2tzIGxpa2UgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICAgICAqIHwgMS4gJGFuaW1hdGUubGVhdmUoLi4uKSBpcyBjYWxsZWQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAyLiAkYW5pbWF0ZSBydW5zIHRoZSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyBkZXRlY3RlZCBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSIgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDMuICRhbmltYXRlIHdhaXRzIGZvciB0aGUgbmV4dCBkaWdlc3QgdG8gc3RhcnQgdGhlIGFuaW1hdGlvbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIiAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNC4gdGhlIC5uZy1sZWF2ZSBjbGFzcyBpcyBhZGRlZCB0byB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbGVhdmUiICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA1LiAkYW5pbWF0ZSBzY2FucyB0aGUgZWxlbWVudCBzdHlsZXMgdG8gZ2V0IHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24gZHVyYXRpb24gYW5kIGRlbGF5ICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1sZWF2ZSIgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDYuICRhbmltYXRlIGJsb2NrcyBhbGwgQ1NTIHRyYW5zaXRpb25zIG9uIHRoZSBlbGVtZW50IHRvIGVuc3VyZSB0aGUgLm5nLWxlYXZlIGNsYXNzIHN0eWxpbmcgaXMgYXBwbGllZCByaWdodCBhd2F5IHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWxlYXZl4oCdICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA3LiAkYW5pbWF0ZSB3YWl0cyBmb3IgYSBzaW5nbGUgYW5pbWF0aW9uIGZyYW1lICh0aGlzIHBlcmZvcm1zIGEgcmVmbG93KSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1sZWF2ZSIgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDguICRhbmltYXRlIHJlbW92ZXMgdGhlIENTUyB0cmFuc2l0aW9uIGJsb2NrIHBsYWNlZCBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWxlYXZl4oCdICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA5LiB0aGUgLm5nLWxlYXZlLWFjdGl2ZSBjbGFzcyBpcyBhZGRlZCAodGhpcyB0cmlnZ2VycyB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1sZWF2ZSBuZy1sZWF2ZS1hY3RpdmUiIHwKICAgICAgICAgKiB8IDEwLiAkYW5pbWF0ZSB3YWl0cyBmb3IgdGhlIGFuaW1hdGlvbiB0byBjb21wbGV0ZSAodmlhIGV2ZW50cyBhbmQgdGltZW91dCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWxlYXZlIG5nLWxlYXZlLWFjdGl2ZSIgfAogICAgICAgICAqIHwgMTEuIFRoZSBhbmltYXRpb24gZW5kcyBhbmQgYWxsIGdlbmVyYXRlZCBDU1MgY2xhc3NlcyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAxMi4gVGhlIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBET00gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IC4uLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDEzLiBUaGUgcmV0dXJuZWQgcHJvbWlzZSBpcyByZXNvbHZlZC4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgLi4uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIGxlYXZlIGFuaW1hdGlvbgogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBhbiBvcHRpb25hbCBjb2xsZWN0aW9uIG9mIHN0eWxlcyB0aGF0IHdpbGwgYmUgcGlja2VkIHVwIGJ5IHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24KICAgICAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSB0aGUgYW5pbWF0aW9uIGNhbGxiYWNrIHByb21pc2UKICAgICAgICAqLwogICAgICAgIGxlYXZlIDogZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucykgewogICAgICAgICAgb3B0aW9ucyA9IHBhcnNlQW5pbWF0ZU9wdGlvbnMob3B0aW9ucyk7CiAgICAgICAgICBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpOwoKICAgICAgICAgIGNhbmNlbENoaWxkQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICAgIGNsYXNzQmFzZWRBbmltYXRpb25zQmxvY2tlZChlbGVtZW50LCB0cnVlKTsKICAgICAgICAgIHJldHVybiBydW5BbmltYXRpb25Qb3N0RGlnZXN0KGZ1bmN0aW9uKGRvbmUpIHsKICAgICAgICAgICAgcmV0dXJuIHBlcmZvcm1BbmltYXRpb24oJ2xlYXZlJywgJ25nLWxlYXZlJywgc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpLCBudWxsLCBudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAkZGVsZWdhdGUubGVhdmUoZWxlbWVudCk7CiAgICAgICAgICAgIH0sIG9wdGlvbnMsIGRvbmUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI21vdmUKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogRmlyZXMgdGhlIG1vdmUgRE9NIG9wZXJhdGlvbi4gSnVzdCBiZWZvcmUgdGhlIGFuaW1hdGlvbiBzdGFydHMsIHRoZSBhbmltYXRlIHNlcnZpY2Ugd2lsbCBlaXRoZXIgYXBwZW5kIGl0IGludG8gdGhlIHBhcmVudEVsZW1lbnQgY29udGFpbmVyIG9yCiAgICAgICAgICogYWRkIHRoZSBlbGVtZW50IGRpcmVjdGx5IGFmdGVyIHRoZSBhZnRlckVsZW1lbnQgZWxlbWVudCBpZiBwcmVzZW50LiBUaGVuIHRoZSBtb3ZlIGFuaW1hdGlvbiB3aWxsIGJlIHJ1bi4gT25jZQogICAgICAgICAqIHRoZSBhbmltYXRpb24gaXMgc3RhcnRlZCwgdGhlIGZvbGxvd2luZyBDU1MgY2xhc3NlcyB3aWxsIGJlIGFkZGVkIGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIGFuaW1hdGlvbjoKICAgICAgICAgKgogICAgICAgICAqIEJlbG93IGlzIGEgYnJlYWtkb3duIG9mIGVhY2ggc3RlcCB0aGF0IG9jY3VycyBkdXJpbmcgbW92ZSBhbmltYXRpb246CiAgICAgICAgICoKICAgICAgICAgKiB8IEFuaW1hdGlvbiBTdGVwICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBXaGF0IHRoZSBlbGVtZW50IGNsYXNzIGF0dHJpYnV0ZSBsb29rcyBsaWtlICAgICAgICAgICAgfAogICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgICAgICogfCAxLiAkYW5pbWF0ZS5tb3ZlKC4uLikgaXMgY2FsbGVkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDIuIGVsZW1lbnQgaXMgbW92ZWQgaW50byB0aGUgcGFyZW50RWxlbWVudCBlbGVtZW50IG9yIGJlc2lkZSB0aGUgYWZ0ZXJFbGVtZW50IGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMy4gJGFuaW1hdGUgd2FpdHMgZm9yIHRoZSBuZXh0IGRpZ2VzdCB0byBzdGFydCB0aGUgYW5pbWF0aW9uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA0LiAkYW5pbWF0ZSBydW5zIHRoZSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyBkZXRlY3RlZCBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDUuIHRoZSAubmctbW92ZSBjbGFzcyBpcyBhZGRlZCB0byB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbW92ZSIgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNi4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1tb3ZlIiAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA3LiAkYW5pbWF0ZSBibG9ja3MgYWxsIENTUyB0cmFuc2l0aW9ucyBvbiB0aGUgZWxlbWVudCB0byBlbnN1cmUgdGhlIC5uZy1tb3ZlIGNsYXNzIHN0eWxpbmcgaXMgYXBwbGllZCByaWdodCBhd2F5IHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLW1vdmXigJ0gICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgOC4gJGFuaW1hdGUgd2FpdHMgZm9yIGEgc2luZ2xlIGFuaW1hdGlvbiBmcmFtZSAodGhpcyBwZXJmb3JtcyBhIHJlZmxvdykgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1tb3ZlIiAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA5LiAkYW5pbWF0ZSByZW1vdmVzIHRoZSBDU1MgdHJhbnNpdGlvbiBibG9jayBwbGFjZWQgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLW1vdmXigJ0gICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMTAuIHRoZSAubmctbW92ZS1hY3RpdmUgY2xhc3MgaXMgYWRkZWQgKHRoaXMgdHJpZ2dlcnMgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbikgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1tb3ZlIG5nLW1vdmUtYWN0aXZlIiB8CiAgICAgICAgICogfCAxMS4gJGFuaW1hdGUgd2FpdHMgZm9yIHRoZSBhbmltYXRpb24gdG8gY29tcGxldGUgKHZpYSBldmVudHMgYW5kIHRpbWVvdXQpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLW1vdmUgbmctbW92ZS1hY3RpdmUiIHwKICAgICAgICAgKiB8IDEyLiBUaGUgYW5pbWF0aW9uIGVuZHMgYW5kIGFsbCBnZW5lcmF0ZWQgQ1NTIGNsYXNzZXMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMTMuIFRoZSByZXR1cm5lZCBwcm9taXNlIGlzIHJlc29sdmVkLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgbW92ZSBhbmltYXRpb24KICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IHBhcmVudEVsZW1lbnQgdGhlIHBhcmVudEVsZW1lbnQgZWxlbWVudCBvZiB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgdGhlIGZvY3VzIG9mIHRoZSBtb3ZlIGFuaW1hdGlvbgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gYWZ0ZXJFbGVtZW50IHRoZSBzaWJsaW5nIGVsZW1lbnQgKHdoaWNoIGlzIHRoZSBwcmV2aW91cyBlbGVtZW50KSBvZiB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgdGhlIGZvY3VzIG9mIHRoZSBtb3ZlIGFuaW1hdGlvbgogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBhbiBvcHRpb25hbCBjb2xsZWN0aW9uIG9mIHN0eWxlcyB0aGF0IHdpbGwgYmUgcGlja2VkIHVwIGJ5IHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24KICAgICAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSB0aGUgYW5pbWF0aW9uIGNhbGxiYWNrIHByb21pc2UKICAgICAgICAqLwogICAgICAgIG1vdmUgOiBmdW5jdGlvbihlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQsIG9wdGlvbnMpIHsKICAgICAgICAgIG9wdGlvbnMgPSBwYXJzZUFuaW1hdGVPcHRpb25zKG9wdGlvbnMpOwogICAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgICAgICAgIHBhcmVudEVsZW1lbnQgPSBwcmVwYXJlRWxlbWVudChwYXJlbnRFbGVtZW50KTsKICAgICAgICAgIGFmdGVyRWxlbWVudCA9IHByZXBhcmVFbGVtZW50KGFmdGVyRWxlbWVudCk7CgogICAgICAgICAgY2FuY2VsQ2hpbGRBbmltYXRpb25zKGVsZW1lbnQpOwogICAgICAgICAgY2xhc3NCYXNlZEFuaW1hdGlvbnNCbG9ja2VkKGVsZW1lbnQsIHRydWUpOwogICAgICAgICAgJGRlbGVnYXRlLm1vdmUoZWxlbWVudCwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50KTsKICAgICAgICAgIHJldHVybiBydW5BbmltYXRpb25Qb3N0RGlnZXN0KGZ1bmN0aW9uKGRvbmUpIHsKICAgICAgICAgICAgcmV0dXJuIHBlcmZvcm1BbmltYXRpb24oJ21vdmUnLCAnbmctbW92ZScsIHN0cmlwQ29tbWVudHNGcm9tRWxlbWVudChlbGVtZW50KSwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50LCBub29wLCBvcHRpb25zLCBkb25lKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNhZGRDbGFzcwogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVHJpZ2dlcnMgYSBjdXN0b20gYW5pbWF0aW9uIGV2ZW50IGJhc2VkIG9mZiB0aGUgY2xhc3NOYW1lIHZhcmlhYmxlIGFuZCB0aGVuIGF0dGFjaGVzIHRoZSBjbGFzc05hbWUgdmFsdWUgdG8gdGhlIGVsZW1lbnQgYXMgYSBDU1MgY2xhc3MuCiAgICAgICAgICogVW5saWtlIHRoZSBvdGhlciBhbmltYXRpb24gbWV0aG9kcywgdGhlIGFuaW1hdGUgc2VydmljZSB3aWxsIHN1ZmZpeCB0aGUgY2xhc3NOYW1lIHZhbHVlIHdpdGgge0B0eXBlIC1hZGR9IGluIG9yZGVyIHRvIHByb3ZpZGUKICAgICAgICAgKiB0aGUgYW5pbWF0ZSBzZXJ2aWNlIHRoZSBzZXR1cCBhbmQgYWN0aXZlIENTUyBjbGFzc2VzIGluIG9yZGVyIHRvIHRyaWdnZXIgdGhlIGFuaW1hdGlvbiAodGhpcyB3aWxsIGJlIHNraXBwZWQgaWYgbm8gQ1NTIHRyYW5zaXRpb25zCiAgICAgICAgICogb3Iga2V5ZnJhbWVzIGFyZSBkZWZpbmVkIG9uIHRoZSAtYWRkLWFjdGl2ZSBvciBiYXNlIENTUyBjbGFzcykuCiAgICAgICAgICoKICAgICAgICAgKiBCZWxvdyBpcyBhIGJyZWFrZG93biBvZiBlYWNoIHN0ZXAgdGhhdCBvY2N1cnMgZHVyaW5nIGFkZENsYXNzIGFuaW1hdGlvbjoKICAgICAgICAgKgogICAgICAgICAqIHwgQW5pbWF0aW9uIFN0ZXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBXaGF0IHRoZSBlbGVtZW50IGNsYXNzIGF0dHJpYnV0ZSBsb29rcyBsaWtlICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgICAgICogfCAxLiAkYW5pbWF0ZS5hZGRDbGFzcyhlbGVtZW50LCAnc3VwZXInKSBpcyBjYWxsZWQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMi4gJGFuaW1hdGUgcnVucyB0aGUgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgZGV0ZWN0ZWQgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDMuIHRoZSAuc3VwZXItYWRkIGNsYXNzIGlzIGFkZGVkIHRvIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIHN1cGVyLWFkZCIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA0LiAkYW5pbWF0ZSB3YWl0cyBmb3IgYSBzaW5nbGUgYW5pbWF0aW9uIGZyYW1lICh0aGlzIHBlcmZvcm1zIGEgcmVmbG93KSAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBzdXBlci1hZGQiICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNS4gdGhlIC5zdXBlciBhbmQgLnN1cGVyLWFkZC1hY3RpdmUgY2xhc3NlcyBhcmUgYWRkZWQgKHRoaXMgdHJpZ2dlcnMgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbikgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgc3VwZXIgc3VwZXItYWRkIHN1cGVyLWFkZC1hY3RpdmUiIHwKICAgICAgICAgKiB8IDYuICRhbmltYXRlIHNjYW5zIHRoZSBlbGVtZW50IHN0eWxlcyB0byBnZXQgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBkdXJhdGlvbiBhbmQgZGVsYXkgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIHN1cGVyLWFkZCIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA3LiAkYW5pbWF0ZSB3YWl0cyBmb3IgdGhlIGFuaW1hdGlvbiB0byBjb21wbGV0ZSAodmlhIGV2ZW50cyBhbmQgdGltZW91dCkgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgc3VwZXItYWRkIHN1cGVyLWFkZC1hY3RpdmUiICAgICAgICAgICAgfAogICAgICAgICAqIHwgOC4gVGhlIGFuaW1hdGlvbiBlbmRzIGFuZCBhbGwgZ2VuZXJhdGVkIENTUyBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIHN1cGVyIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDkuIFRoZSBzdXBlciBjbGFzcyBpcyBrZXB0IG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAxMC4gVGhlIHJldHVybmVkIHByb21pc2UgaXMgcmVzb2x2ZWQuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSBhbmltYXRlZAogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc05hbWUgdGhlIENTUyBjbGFzcyB0aGF0IHdpbGwgYmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQgYW5kIHRoZW4gYW5pbWF0ZWQKICAgICAgICAgKiBAcGFyYW0ge29iamVjdD19IG9wdGlvbnMgYW4gb3B0aW9uYWwgY29sbGVjdGlvbiBvZiBzdHlsZXMgdGhhdCB3aWxsIGJlIHBpY2tlZCB1cCBieSB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uCiAgICAgICAgICogQHJldHVybiB7UHJvbWlzZX0gdGhlIGFuaW1hdGlvbiBjYWxsYmFjayBwcm9taXNlCiAgICAgICAgKi8KICAgICAgICBhZGRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgb3B0aW9ucykgewogICAgICAgICAgcmV0dXJuIHRoaXMuc2V0Q2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lLCBbXSwgb3B0aW9ucyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI3JlbW92ZUNsYXNzCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUcmlnZ2VycyBhIGN1c3RvbSBhbmltYXRpb24gZXZlbnQgYmFzZWQgb2ZmIHRoZSBjbGFzc05hbWUgdmFyaWFibGUgYW5kIHRoZW4gcmVtb3ZlcyB0aGUgQ1NTIGNsYXNzIHByb3ZpZGVkIGJ5IHRoZSBjbGFzc05hbWUgdmFsdWUKICAgICAgICAgKiBmcm9tIHRoZSBlbGVtZW50LiBVbmxpa2UgdGhlIG90aGVyIGFuaW1hdGlvbiBtZXRob2RzLCB0aGUgYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgc3VmZml4IHRoZSBjbGFzc05hbWUgdmFsdWUgd2l0aCB7QHR5cGUgLXJlbW92ZX0gaW4KICAgICAgICAgKiBvcmRlciB0byBwcm92aWRlIHRoZSBhbmltYXRlIHNlcnZpY2UgdGhlIHNldHVwIGFuZCBhY3RpdmUgQ1NTIGNsYXNzZXMgaW4gb3JkZXIgdG8gdHJpZ2dlciB0aGUgYW5pbWF0aW9uICh0aGlzIHdpbGwgYmUgc2tpcHBlZCBpZgogICAgICAgICAqIG5vIENTUyB0cmFuc2l0aW9ucyBvciBrZXlmcmFtZXMgYXJlIGRlZmluZWQgb24gdGhlIC1yZW1vdmUgb3IgYmFzZSBDU1MgY2xhc3NlcykuCiAgICAgICAgICoKICAgICAgICAgKiBCZWxvdyBpcyBhIGJyZWFrZG93biBvZiBlYWNoIHN0ZXAgdGhhdCBvY2N1cnMgZHVyaW5nIHJlbW92ZUNsYXNzIGFuaW1hdGlvbjoKICAgICAgICAgKgogICAgICAgICAqIHwgQW5pbWF0aW9uIFN0ZXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IFdoYXQgdGhlIGVsZW1lbnQgY2xhc3MgYXR0cmlidXRlIGxvb2tzIGxpa2UgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICAgICAqIHwgMS4gJGFuaW1hdGUucmVtb3ZlQ2xhc3MoZWxlbWVudCwgJ3N1cGVyJykgaXMgY2FsbGVkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMi4gJGFuaW1hdGUgcnVucyB0aGUgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgZGV0ZWN0ZWQgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgbmctYW5pbWF0ZSIgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMy4gdGhlIC5zdXBlci1yZW1vdmUgY2xhc3MgaXMgYWRkZWQgdG8gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgbmctYW5pbWF0ZSBzdXBlci1yZW1vdmUiICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNC4gJGFuaW1hdGUgd2FpdHMgZm9yIGEgc2luZ2xlIGFuaW1hdGlvbiBmcmFtZSAodGhpcyBwZXJmb3JtcyBhIHJlZmxvdykgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgbmctYW5pbWF0ZSBzdXBlci1yZW1vdmUiICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNS4gdGhlIC5zdXBlci1yZW1vdmUtYWN0aXZlIGNsYXNzZXMgYXJlIGFkZGVkIGFuZCAuc3VwZXIgaXMgcmVtb3ZlZCAodGhpcyB0cmlnZ2VycyB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uKSB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBzdXBlci1yZW1vdmUgc3VwZXItcmVtb3ZlLWFjdGl2ZSIgfAogICAgICAgICAqIHwgNi4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgbmctYW5pbWF0ZSBzdXBlci1yZW1vdmUiICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNy4gJGFuaW1hdGUgd2FpdHMgZm9yIHRoZSBhbmltYXRpb24gdG8gY29tcGxldGUgKHZpYSBldmVudHMgYW5kIHRpbWVvdXQpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBzdXBlci1yZW1vdmUgc3VwZXItcmVtb3ZlLWFjdGl2ZSIgfAogICAgICAgICAqIHwgOC4gVGhlIGFuaW1hdGlvbiBlbmRzIGFuZCBhbGwgZ2VuZXJhdGVkIENTUyBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgOS4gVGhlIHJldHVybmVkIHByb21pc2UgaXMgcmVzb2x2ZWQuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIGFuaW1hdGVkCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzTmFtZSB0aGUgQ1NTIGNsYXNzIHRoYXQgd2lsbCBiZSBhbmltYXRlZCBhbmQgdGhlbiByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICAgKiBAcGFyYW0ge29iamVjdD19IG9wdGlvbnMgYW4gb3B0aW9uYWwgY29sbGVjdGlvbiBvZiBzdHlsZXMgdGhhdCB3aWxsIGJlIHBpY2tlZCB1cCBieSB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uCiAgICAgICAgICogQHJldHVybiB7UHJvbWlzZX0gdGhlIGFuaW1hdGlvbiBjYWxsYmFjayBwcm9taXNlCiAgICAgICAgKi8KICAgICAgICByZW1vdmVDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgb3B0aW9ucykgewogICAgICAgICAgcmV0dXJuIHRoaXMuc2V0Q2xhc3MoZWxlbWVudCwgW10sIGNsYXNzTmFtZSwgb3B0aW9ucyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICoKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjc2V0Q2xhc3MKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbiBBZGRzIGFuZC9vciByZW1vdmVzIHRoZSBnaXZlbiBDU1MgY2xhc3NlcyB0byBhbmQgZnJvbSB0aGUgZWxlbWVudC4KICAgICAgICAgKiBPbmNlIGNvbXBsZXRlLCB0aGUgZG9uZSgpIGNhbGxiYWNrIHdpbGwgYmUgZmlyZWQgKGlmIHByb3ZpZGVkKS4KICAgICAgICAgKgogICAgICAgICAqIHwgQW5pbWF0aW9uIFN0ZXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgV2hhdCB0aGUgZWxlbWVudCBjbGFzcyBhdHRyaWJ1dGUgbG9va3MgbGlrZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgICAgICogfCAxLiAkYW5pbWF0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCDigJhvbuKAmSwg4oCYb2Zm4oCZKSBpcyBjYWxsZWQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgb2Zm4oCdICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDIuICRhbmltYXRlIHJ1bnMgdGhlIEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zIGRldGVjdGVkIG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgbmctYW5pbWF0ZSBvZmbigJ0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDMuIHRoZSAub24tYWRkIGFuZCAub2ZmLXJlbW92ZSBjbGFzc2VzIGFyZSBhZGRlZCB0byB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBvbi1hZGQgb2ZmLXJlbW92ZSBvZmbigJ0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDQuICRhbmltYXRlIHdhaXRzIGZvciBhIHNpbmdsZSBhbmltYXRpb24gZnJhbWUgKHRoaXMgcGVyZm9ybXMgYSByZWZsb3cpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBvbi1hZGQgb2ZmLXJlbW92ZSBvZmbigJ0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDUuIHRoZSAub24sIC5vbi1hZGQtYWN0aXZlIGFuZCAub2ZmLXJlbW92ZS1hY3RpdmUgY2xhc3NlcyBhcmUgYWRkZWQgYW5kIC5vZmYgaXMgcmVtb3ZlZCAodGhpcyB0cmlnZ2VycyB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uKSB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBvbiBvbi1hZGQgb24tYWRkLWFjdGl2ZSBvZmYtcmVtb3ZlIG9mZi1yZW1vdmUtYWN0aXZl4oCdIHwKICAgICAgICAgKiB8IDYuICRhbmltYXRlIHNjYW5zIHRoZSBlbGVtZW50IHN0eWxlcyB0byBnZXQgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBkdXJhdGlvbiBhbmQgZGVsYXkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBvbiBvbi1hZGQgb24tYWRkLWFjdGl2ZSBvZmYtcmVtb3ZlIG9mZi1yZW1vdmUtYWN0aXZlIiB8CiAgICAgICAgICogfCA3LiAkYW5pbWF0ZSB3YWl0cyBmb3IgdGhlIGFuaW1hdGlvbiB0byBjb21wbGV0ZSAodmlhIGV2ZW50cyBhbmQgdGltZW91dCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgb24gb24tYWRkIG9uLWFkZC1hY3RpdmUgb2ZmLXJlbW92ZSBvZmYtcmVtb3ZlLWFjdGl2ZSIgfAogICAgICAgICAqIHwgOC4gVGhlIGFuaW1hdGlvbiBlbmRzIGFuZCBhbGwgZ2VuZXJhdGVkIENTUyBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBvbiIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDkuIFRoZSByZXR1cm5lZCBwcm9taXNlIGlzIHJlc29sdmVkLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBoYXZlIGl0cyBDU1MgY2xhc3NlcyBjaGFuZ2VkCiAgICAgICAgICogICByZW1vdmVkIGZyb20gaXQKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gYWRkIHRoZSBDU1MgY2xhc3NlcyB3aGljaCB3aWxsIGJlIGFkZGVkIHRvIHRoZSBlbGVtZW50CiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHJlbW92ZSB0aGUgQ1NTIGNsYXNzIHdoaWNoIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50CiAgICAgICAgICogICBDU1MgY2xhc3NlcyBoYXZlIGJlZW4gc2V0IG9uIHRoZSBlbGVtZW50CiAgICAgICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIGFuIG9wdGlvbmFsIGNvbGxlY3Rpb24gb2Ygc3R5bGVzIHRoYXQgd2lsbCBiZSBwaWNrZWQgdXAgYnkgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbgogICAgICAgICAqIEByZXR1cm4ge1Byb21pc2V9IHRoZSBhbmltYXRpb24gY2FsbGJhY2sgcHJvbWlzZQogICAgICAgICAqLwogICAgICAgIHNldENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgYWRkLCByZW1vdmUsIG9wdGlvbnMpIHsKICAgICAgICAgIG9wdGlvbnMgPSBwYXJzZUFuaW1hdGVPcHRpb25zKG9wdGlvbnMpOwoKICAgICAgICAgIHZhciBTVE9SQUdFX0tFWSA9ICckJGFuaW1hdGVDbGFzc2VzJzsKICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICBlbGVtZW50ID0gc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpOwoKICAgICAgICAgIGlmIChjbGFzc0Jhc2VkQW5pbWF0aW9uc0Jsb2NrZWQoZWxlbWVudCkpIHsKICAgICAgICAgICAgcmV0dXJuICRkZWxlZ2F0ZS4kJHNldENsYXNzSW1tZWRpYXRlbHkoZWxlbWVudCwgYWRkLCByZW1vdmUsIG9wdGlvbnMpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIHdlJ3JlIHVzaW5nIGEgY29tYmluZWQgYXJyYXkgZm9yIGJvdGggdGhlIGFkZCBhbmQgcmVtb3ZlCiAgICAgICAgICAvLyBvcGVyYXRpb25zIHNpbmNlIHRoZSBPUkRFUiBPRiBhZGRDbGFzcyBhbmQgcmVtb3ZlQ2xhc3MgbWF0dGVycwogICAgICAgICAgdmFyIGNsYXNzZXMsIGNhY2hlID0gZWxlbWVudC5kYXRhKFNUT1JBR0VfS0VZKTsKICAgICAgICAgIHZhciBoYXNDYWNoZSA9ICEhY2FjaGU7CiAgICAgICAgICBpZiAoIWNhY2hlKSB7CiAgICAgICAgICAgIGNhY2hlID0ge307CiAgICAgICAgICAgIGNhY2hlLmNsYXNzZXMgPSB7fTsKICAgICAgICAgIH0KICAgICAgICAgIGNsYXNzZXMgPSBjYWNoZS5jbGFzc2VzOwoKICAgICAgICAgIGFkZCA9IGlzQXJyYXkoYWRkKSA/IGFkZCA6IGFkZC5zcGxpdCgnICcpOwogICAgICAgICAgZm9yRWFjaChhZGQsIGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgaWYgKGMgJiYgYy5sZW5ndGgpIHsKICAgICAgICAgICAgICBjbGFzc2VzW2NdID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgcmVtb3ZlID0gaXNBcnJheShyZW1vdmUpID8gcmVtb3ZlIDogcmVtb3ZlLnNwbGl0KCcgJyk7CiAgICAgICAgICBmb3JFYWNoKHJlbW92ZSwgZnVuY3Rpb24oYykgewogICAgICAgICAgICBpZiAoYyAmJiBjLmxlbmd0aCkgewogICAgICAgICAgICAgIGNsYXNzZXNbY10gPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgaWYgKGhhc0NhY2hlKSB7CiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIGNhY2hlLm9wdGlvbnMpIHsKICAgICAgICAgICAgICBjYWNoZS5vcHRpb25zID0gYW5ndWxhci5leHRlbmQoY2FjaGUub3B0aW9ucyB8fCB7fSwgb3B0aW9ucyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vdGhlIGRpZ2VzdCBjeWNsZSB3aWxsIGNvbWJpbmUgYWxsIHRoZSBhbmltYXRpb25zIGludG8gb25lIGZ1bmN0aW9uCiAgICAgICAgICAgIHJldHVybiBjYWNoZS5wcm9taXNlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbWVudC5kYXRhKFNUT1JBR0VfS0VZLCBjYWNoZSA9IHsKICAgICAgICAgICAgICBjbGFzc2VzIDogY2xhc3NlcywKICAgICAgICAgICAgICBvcHRpb25zIDogb3B0aW9ucwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gY2FjaGUucHJvbWlzZSA9IHJ1bkFuaW1hdGlvblBvc3REaWdlc3QoZnVuY3Rpb24oZG9uZSkgewogICAgICAgICAgICB2YXIgcGFyZW50RWxlbWVudCA9IGVsZW1lbnQucGFyZW50KCk7CiAgICAgICAgICAgIHZhciBlbGVtZW50Tm9kZSA9IGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KTsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBlbGVtZW50Tm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAvLyBUT0RPKG1hdHNrbyk6IG1vdmUgdGhpcyBjb2RlIGludG8gdGhlIGFuaW1hdGlvbnNEaXNhYmxlZCgpIGZ1bmN0aW9uIG9uY2UgIzgwOTIgaXMgZml4ZWQKICAgICAgICAgICAgaWYgKCFwYXJlbnROb2RlIHx8IHBhcmVudE5vZGVbJyQkTkdfUkVNT1ZFRCddIHx8IGVsZW1lbnROb2RlWyckJE5HX1JFTU9WRUQnXSkgewogICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBjYWNoZSA9IGVsZW1lbnQuZGF0YShTVE9SQUdFX0tFWSk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRGF0YShTVE9SQUdFX0tFWSk7CgogICAgICAgICAgICB2YXIgc3RhdGUgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSkgfHwge307CiAgICAgICAgICAgIHZhciBjbGFzc2VzID0gcmVzb2x2ZUVsZW1lbnRDbGFzc2VzKGVsZW1lbnQsIGNhY2hlLCBzdGF0ZS5hY3RpdmUpOwogICAgICAgICAgICByZXR1cm4gIWNsYXNzZXMKICAgICAgICAgICAgICA/IGRvbmUoKQogICAgICAgICAgICAgIDogcGVyZm9ybUFuaW1hdGlvbignc2V0Q2xhc3MnLCBjbGFzc2VzLCBlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNsYXNzZXNbMF0pICRkZWxlZ2F0ZS4kJGFkZENsYXNzSW1tZWRpYXRlbHkoZWxlbWVudCwgY2xhc3Nlc1swXSk7CiAgICAgICAgICAgICAgICAgIGlmIChjbGFzc2VzWzFdKSAkZGVsZWdhdGUuJCRyZW1vdmVDbGFzc0ltbWVkaWF0ZWx5KGVsZW1lbnQsIGNsYXNzZXNbMV0pOwogICAgICAgICAgICAgICAgfSwgY2FjaGUub3B0aW9ucywgZG9uZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjY2FuY2VsCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7UHJvbWlzZX0gYW5pbWF0aW9uUHJvbWlzZSBUaGUgYW5pbWF0aW9uIHByb21pc2UgdGhhdCBpcyByZXR1cm5lZCB3aGVuIGFuIGFuaW1hdGlvbiBpcyBzdGFydGVkLgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ2FuY2VscyB0aGUgcHJvdmlkZWQgYW5pbWF0aW9uLgogICAgICAgICovCiAgICAgICAgY2FuY2VsIDogZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICAgICAgcHJvbWlzZS4kJGNhbmNlbEZuKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI2VuYWJsZWQKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gdmFsdWUgSWYgcHJvdmlkZWQgdGhlbiBzZXQgdGhlIGFuaW1hdGlvbiBvbiBvciBvZmYuCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50PX0gZWxlbWVudCBJZiBwcm92aWRlZCB0aGVuIHRoZSBlbGVtZW50IHdpbGwgYmUgdXNlZCB0byByZXByZXNlbnQgdGhlIGVuYWJsZS9kaXNhYmxlIG9wZXJhdGlvbgogICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEN1cnJlbnQgYW5pbWF0aW9uIHN0YXRlLgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogR2xvYmFsbHkgZW5hYmxlcy9kaXNhYmxlcyBhbmltYXRpb25zLgogICAgICAgICAqCiAgICAgICAgKi8KICAgICAgICBlbmFibGVkIDogZnVuY3Rpb24odmFsdWUsIGVsZW1lbnQpIHsKICAgICAgICAgIHN3aXRjaChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpIHx8IHt9OwogICAgICAgICAgICAgICAgZGF0YS5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSwgZGF0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICByb290QW5pbWF0ZVN0YXRlLmRpc2FibGVkID0gIXZhbHVlOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdmFsdWUgPSAhcm9vdEFuaW1hdGVTdGF0ZS5kaXNhYmxlZDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gISF2YWx1ZTsKICAgICAgICAgfQogICAgICB9OwoKICAgICAgLyoKICAgICAgICBhbGwgYW5pbWF0aW9ucyBjYWxsIHRoaXMgc2hhcmVkIGFuaW1hdGlvbiB0cmlnZ2VyaW5nIGZ1bmN0aW9uIGludGVybmFsbHkuCiAgICAgICAgVGhlIGFuaW1hdGlvbkV2ZW50IHZhcmlhYmxlIHJlZmVycyB0byB0aGUgSmF2YVNjcmlwdCBhbmltYXRpb24gZXZlbnQgdGhhdCB3aWxsIGJlIHRyaWdnZXJlZAogICAgICAgIGFuZCB0aGUgY2xhc3NOYW1lIHZhbHVlIGlzIHRoZSBuYW1lIG9mIHRoZSBhbmltYXRpb24gdGhhdCB3aWxsIGJlIGFwcGxpZWQgd2l0aGluIHRoZQogICAgICAgIENTUyBjb2RlLiBFbGVtZW50LCBwYXJlbnRFbGVtZW50IGFuZCBhZnRlckVsZW1lbnQgYXJlIHByb3ZpZGVkIERPTSBlbGVtZW50cyBmb3IgdGhlIGFuaW1hdGlvbgogICAgICAgIGFuZCB0aGUgb25Db21wbGV0ZSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIG9uY2UgdGhlIGFuaW1hdGlvbiBpcyBmdWxseSBjb21wbGV0ZS4KICAgICAgKi8KICAgICAgZnVuY3Rpb24gcGVyZm9ybUFuaW1hdGlvbihhbmltYXRpb25FdmVudCwgY2xhc3NOYW1lLCBlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQsIGRvbU9wZXJhdGlvbiwgb3B0aW9ucywgZG9uZUNhbGxiYWNrKSB7CiAgICAgICAgdmFyIG5vb3BDYW5jZWwgPSBub29wOwogICAgICAgIHZhciBydW5uZXIgPSBhbmltYXRpb25SdW5uZXIoZWxlbWVudCwgYW5pbWF0aW9uRXZlbnQsIGNsYXNzTmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKCFydW5uZXIpIHsKICAgICAgICAgIGZpcmVET01PcGVyYXRpb24oKTsKICAgICAgICAgIGZpcmVCZWZvcmVDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICBmaXJlQWZ0ZXJDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICBjbG9zZUFuaW1hdGlvbigpOwogICAgICAgICAgcmV0dXJuIG5vb3BDYW5jZWw7CiAgICAgICAgfQoKICAgICAgICBhbmltYXRpb25FdmVudCA9IHJ1bm5lci5ldmVudDsKICAgICAgICBjbGFzc05hbWUgPSBydW5uZXIuY2xhc3NOYW1lOwogICAgICAgIHZhciBlbGVtZW50RXZlbnRzID0gYW5ndWxhci5lbGVtZW50Ll9kYXRhKHJ1bm5lci5ub2RlKTsKICAgICAgICBlbGVtZW50RXZlbnRzID0gZWxlbWVudEV2ZW50cyAmJiBlbGVtZW50RXZlbnRzLmV2ZW50czsKCiAgICAgICAgaWYgKCFwYXJlbnRFbGVtZW50KSB7CiAgICAgICAgICBwYXJlbnRFbGVtZW50ID0gYWZ0ZXJFbGVtZW50ID8gYWZ0ZXJFbGVtZW50LnBhcmVudCgpIDogZWxlbWVudC5wYXJlbnQoKTsKICAgICAgICB9CgogICAgICAgIC8vc2tpcCB0aGUgYW5pbWF0aW9uIGlmIGFuaW1hdGlvbnMgYXJlIGRpc2FibGVkLCBhIHBhcmVudCBpcyBhbHJlYWR5IGJlaW5nIGFuaW1hdGVkLAogICAgICAgIC8vdGhlIGVsZW1lbnQgaXMgbm90IGN1cnJlbnRseSBhdHRhY2hlZCB0byB0aGUgZG9jdW1lbnQgYm9keSBvciB0aGVuIGNvbXBsZXRlbHkgY2xvc2UKICAgICAgICAvL3RoZSBhbmltYXRpb24gaWYgYW55IG1hdGNoaW5nIGFuaW1hdGlvbnMgYXJlIG5vdCBmb3VuZCBhdCBhbGwuCiAgICAgICAgLy9OT1RFOiBJRTggKyBJRTkgc2hvdWxkIGNsb3NlIHByb3Blcmx5IChydW4gY2xvc2VBbmltYXRpb24oKSkgaW4gY2FzZSBhbiBhbmltYXRpb24gd2FzIGZvdW5kLgogICAgICAgIGlmIChhbmltYXRpb25zRGlzYWJsZWQoZWxlbWVudCwgcGFyZW50RWxlbWVudCkpIHsKICAgICAgICAgIGZpcmVET01PcGVyYXRpb24oKTsKICAgICAgICAgIGZpcmVCZWZvcmVDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICBmaXJlQWZ0ZXJDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICBjbG9zZUFuaW1hdGlvbigpOwogICAgICAgICAgcmV0dXJuIG5vb3BDYW5jZWw7CiAgICAgICAgfQoKICAgICAgICB2YXIgbmdBbmltYXRlU3RhdGUgID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpIHx8IHt9OwogICAgICAgIHZhciBydW5uaW5nQW5pbWF0aW9ucyAgICAgPSBuZ0FuaW1hdGVTdGF0ZS5hY3RpdmUgfHwge307CiAgICAgICAgdmFyIHRvdGFsQWN0aXZlQW5pbWF0aW9ucyA9IG5nQW5pbWF0ZVN0YXRlLnRvdGFsQWN0aXZlIHx8IDA7CiAgICAgICAgdmFyIGxhc3RBbmltYXRpb24gICAgICAgICA9IG5nQW5pbWF0ZVN0YXRlLmxhc3Q7CiAgICAgICAgdmFyIHNraXBBbmltYXRpb24gPSBmYWxzZTsKCiAgICAgICAgaWYgKHRvdGFsQWN0aXZlQW5pbWF0aW9ucyA+IDApIHsKICAgICAgICAgIHZhciBhbmltYXRpb25zVG9DYW5jZWwgPSBbXTsKICAgICAgICAgIGlmICghcnVubmVyLmlzQ2xhc3NCYXNlZCkgewogICAgICAgICAgICBpZiAoYW5pbWF0aW9uRXZlbnQgPT0gJ2xlYXZlJyAmJiBydW5uaW5nQW5pbWF0aW9uc1snbmctbGVhdmUnXSkgewogICAgICAgICAgICAgIHNraXBBbmltYXRpb24gPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vY2FuY2VsIGFsbCBhbmltYXRpb25zIHdoZW4gYSBzdHJ1Y3R1cmFsIGFuaW1hdGlvbiB0YWtlcyBwbGFjZQogICAgICAgICAgICAgIGZvcih2YXIga2xhc3MgaW4gcnVubmluZ0FuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIGFuaW1hdGlvbnNUb0NhbmNlbC5wdXNoKHJ1bm5pbmdBbmltYXRpb25zW2tsYXNzXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5nQW5pbWF0ZVN0YXRlID0ge307CiAgICAgICAgICAgICAgY2xlYW51cChlbGVtZW50LCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChsYXN0QW5pbWF0aW9uLmV2ZW50ID09ICdzZXRDbGFzcycpIHsKICAgICAgICAgICAgYW5pbWF0aW9uc1RvQ2FuY2VsLnB1c2gobGFzdEFuaW1hdGlvbik7CiAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKHJ1bm5pbmdBbmltYXRpb25zW2NsYXNzTmFtZV0pIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBydW5uaW5nQW5pbWF0aW9uc1tjbGFzc05hbWVdOwogICAgICAgICAgICBpZiAoY3VycmVudC5ldmVudCA9PSBhbmltYXRpb25FdmVudCkgewogICAgICAgICAgICAgIHNraXBBbmltYXRpb24gPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGFuaW1hdGlvbnNUb0NhbmNlbC5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmIChhbmltYXRpb25zVG9DYW5jZWwubGVuZ3RoID4gMCkgewogICAgICAgICAgICBmb3JFYWNoKGFuaW1hdGlvbnNUb0NhbmNlbCwgZnVuY3Rpb24ob3BlcmF0aW9uKSB7CiAgICAgICAgICAgICAgb3BlcmF0aW9uLmNhbmNlbCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChydW5uZXIuaXNDbGFzc0Jhc2VkCiAgICAgICAgICAgICYmICFydW5uZXIuaXNTZXRDbGFzc09wZXJhdGlvbgogICAgICAgICAgICAmJiBhbmltYXRpb25FdmVudCAhPSAnYW5pbWF0ZScKICAgICAgICAgICAgJiYgIXNraXBBbmltYXRpb24pIHsKICAgICAgICAgIHNraXBBbmltYXRpb24gPSAoYW5pbWF0aW9uRXZlbnQgPT0gJ2FkZENsYXNzJykgPT0gZWxlbWVudC5oYXNDbGFzcyhjbGFzc05hbWUpOyAvL29wcG9zaXRlIG9mIFhPUgogICAgICAgIH0KCiAgICAgICAgaWYgKHNraXBBbmltYXRpb24pIHsKICAgICAgICAgIGZpcmVET01PcGVyYXRpb24oKTsKICAgICAgICAgIGZpcmVCZWZvcmVDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICBmaXJlQWZ0ZXJDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICBmaXJlRG9uZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIHJldHVybiBub29wQ2FuY2VsOwogICAgICAgIH0KCiAgICAgICAgcnVubmluZ0FuaW1hdGlvbnMgICAgID0gbmdBbmltYXRlU3RhdGUuYWN0aXZlIHx8IHt9OwogICAgICAgIHRvdGFsQWN0aXZlQW5pbWF0aW9ucyA9IG5nQW5pbWF0ZVN0YXRlLnRvdGFsQWN0aXZlIHx8IDA7CgogICAgICAgIGlmIChhbmltYXRpb25FdmVudCA9PSAnbGVhdmUnKSB7CiAgICAgICAgICAvL3RoZXJlJ3Mgbm8gbmVlZCB0byBldmVyIHJlbW92ZSB0aGUgbGlzdGVuZXIgc2luY2UgdGhlIGVsZW1lbnQKICAgICAgICAgIC8vd2lsbCBiZSByZW1vdmVkIChkZXN0cm95ZWQpIGFmdGVyIHRoZSBsZWF2ZSBhbmltYXRpb24gZW5kcyBvcgogICAgICAgICAgLy9pcyBjYW5jZWxsZWQgbWlkd2F5CiAgICAgICAgICBlbGVtZW50Lm9uZSgnJGRlc3Ryb3knLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KHRoaXMpOwogICAgICAgICAgICB2YXIgc3RhdGUgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSk7CiAgICAgICAgICAgIGlmIChzdGF0ZSkgewogICAgICAgICAgICAgIHZhciBhY3RpdmVMZWF2ZUFuaW1hdGlvbiA9IHN0YXRlLmFjdGl2ZVsnbmctbGVhdmUnXTsKICAgICAgICAgICAgICBpZiAoYWN0aXZlTGVhdmVBbmltYXRpb24pIHsKICAgICAgICAgICAgICAgIGFjdGl2ZUxlYXZlQW5pbWF0aW9uLmNhbmNlbCgpOwogICAgICAgICAgICAgICAgY2xlYW51cChlbGVtZW50LCAnbmctbGVhdmUnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy90aGUgbmctYW5pbWF0ZSBjbGFzcyBkb2VzIG5vdGhpbmcsIGJ1dCBpdCdzIGhlcmUgdG8gYWxsb3cgZm9yCiAgICAgICAgLy9wYXJlbnQgYW5pbWF0aW9ucyB0byBmaW5kIGFuZCBjYW5jZWwgY2hpbGQgYW5pbWF0aW9ucyB3aGVuIG5lZWRlZAogICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoTkdfQU5JTUFURV9DTEFTU19OQU1FKTsKICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnRlbXBDbGFzc2VzKSB7CiAgICAgICAgICBmb3JFYWNoKG9wdGlvbnMudGVtcENsYXNzZXMsIGZ1bmN0aW9uKGNsYXNzTmFtZSkgewogICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHZhciBsb2NhbEFuaW1hdGlvbkNvdW50ID0gZ2xvYmFsQW5pbWF0aW9uQ291bnRlcisrOwogICAgICAgIHRvdGFsQWN0aXZlQW5pbWF0aW9ucysrOwogICAgICAgIHJ1bm5pbmdBbmltYXRpb25zW2NsYXNzTmFtZV0gPSBydW5uZXI7CgogICAgICAgIGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFLCB7CiAgICAgICAgICBsYXN0IDogcnVubmVyLAogICAgICAgICAgYWN0aXZlIDogcnVubmluZ0FuaW1hdGlvbnMsCiAgICAgICAgICBpbmRleCA6IGxvY2FsQW5pbWF0aW9uQ291bnQsCiAgICAgICAgICB0b3RhbEFjdGl2ZSA6IHRvdGFsQWN0aXZlQW5pbWF0aW9ucwogICAgICAgIH0pOwoKICAgICAgICAvL2ZpcnN0IHdlIHJ1biB0aGUgYmVmb3JlIGFuaW1hdGlvbnMgYW5kIHdoZW4gYWxsIG9mIHRob3NlIGFyZSBjb21wbGV0ZQogICAgICAgIC8vdGhlbiB3ZSBwZXJmb3JtIHRoZSBET00gb3BlcmF0aW9uIGFuZCBydW4gdGhlIG5leHQgc2V0IG9mIGFuaW1hdGlvbnMKICAgICAgICBmaXJlQmVmb3JlQ2FsbGJhY2tBc3luYygpOwogICAgICAgIHJ1bm5lci5iZWZvcmUoZnVuY3Rpb24oY2FuY2VsbGVkKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKTsKICAgICAgICAgIGNhbmNlbGxlZCA9IGNhbmNlbGxlZCB8fAogICAgICAgICAgICAgICAgICAgICAgICAhZGF0YSB8fCAhZGF0YS5hY3RpdmVbY2xhc3NOYW1lXSB8fAogICAgICAgICAgICAgICAgICAgICAgICAocnVubmVyLmlzQ2xhc3NCYXNlZCAmJiBkYXRhLmFjdGl2ZVtjbGFzc05hbWVdLmV2ZW50ICE9IGFuaW1hdGlvbkV2ZW50KTsKCiAgICAgICAgICBmaXJlRE9NT3BlcmF0aW9uKCk7CiAgICAgICAgICBpZiAoY2FuY2VsbGVkID09PSB0cnVlKSB7CiAgICAgICAgICAgIGNsb3NlQW5pbWF0aW9uKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmaXJlQWZ0ZXJDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICAgIHJ1bm5lci5hZnRlcihjbG9zZUFuaW1hdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBydW5uZXIuY2FuY2VsOwoKICAgICAgICBmdW5jdGlvbiBmaXJlRE9NQ2FsbGJhY2soYW5pbWF0aW9uUGhhc2UpIHsKICAgICAgICAgIHZhciBldmVudE5hbWUgPSAnJGFuaW1hdGU6JyArIGFuaW1hdGlvblBoYXNlOwogICAgICAgICAgaWYgKGVsZW1lbnRFdmVudHMgJiYgZWxlbWVudEV2ZW50c1tldmVudE5hbWVdICYmIGVsZW1lbnRFdmVudHNbZXZlbnROYW1lXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICQkYXN5bmNDYWxsYmFjayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBlbGVtZW50LnRyaWdnZXJIYW5kbGVyKGV2ZW50TmFtZSwgewogICAgICAgICAgICAgICAgZXZlbnQgOiBhbmltYXRpb25FdmVudCwKICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA6IGNsYXNzTmFtZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZpcmVCZWZvcmVDYWxsYmFja0FzeW5jKCkgewogICAgICAgICAgZmlyZURPTUNhbGxiYWNrKCdiZWZvcmUnKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKSB7CiAgICAgICAgICBmaXJlRE9NQ2FsbGJhY2soJ2FmdGVyJyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmaXJlRG9uZUNhbGxiYWNrQXN5bmMoKSB7CiAgICAgICAgICBmaXJlRE9NQ2FsbGJhY2soJ2Nsb3NlJyk7CiAgICAgICAgICBkb25lQ2FsbGJhY2soKTsKICAgICAgICB9CgogICAgICAgIC8vaXQgaXMgbGVzcyBjb21wbGljYXRlZCB0byB1c2UgYSBmbGFnIHRoYW4gbWFuYWdpbmcgYW5kIGNhbmNlbGluZwogICAgICAgIC8vdGltZW91dHMgY29udGFpbmluZyBtdWx0aXBsZSBjYWxsYmFja3MuCiAgICAgICAgZnVuY3Rpb24gZmlyZURPTU9wZXJhdGlvbigpIHsKICAgICAgICAgIGlmICghZmlyZURPTU9wZXJhdGlvbi5oYXNCZWVuUnVuKSB7CiAgICAgICAgICAgIGZpcmVET01PcGVyYXRpb24uaGFzQmVlblJ1biA9IHRydWU7CiAgICAgICAgICAgIGRvbU9wZXJhdGlvbigpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2xvc2VBbmltYXRpb24oKSB7CiAgICAgICAgICBpZiAoIWNsb3NlQW5pbWF0aW9uLmhhc0JlZW5SdW4pIHsKICAgICAgICAgICAgaWYgKHJ1bm5lcikgeyAvL3RoZSBydW5uZXIgZG9lc24ndCBleGlzdCBpZiBpdCBmYWlscyB0byBpbnN0YW50aWF0ZQogICAgICAgICAgICAgIHJ1bm5lci5hcHBseVN0eWxlcygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjbG9zZUFuaW1hdGlvbi5oYXNCZWVuUnVuID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy50ZW1wQ2xhc3NlcykgewogICAgICAgICAgICAgIGZvckVhY2gob3B0aW9ucy50ZW1wQ2xhc3NlcywgZnVuY3Rpb24oY2xhc3NOYW1lKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpOwogICAgICAgICAgICBpZiAoZGF0YSkgewoKICAgICAgICAgICAgICAvKiBvbmx5IHN0cnVjdHVyYWwgYW5pbWF0aW9ucyB3YWl0IGZvciByZWZsb3cgYmVmb3JlIHJlbW92aW5nIGFuCiAgICAgICAgICAgICAgICAgYW5pbWF0aW9uLCBidXQgY2xhc3MtYmFzZWQgYW5pbWF0aW9ucyBkb24ndC4gQW4gZXhhbXBsZSBvZiB0aGlzCiAgICAgICAgICAgICAgICAgZmFpbGluZyB3b3VsZCBiZSB3aGVuIGEgcGFyZW50IEhUTUwgdGFnIGhhcyBhIG5nLWNsYXNzIGF0dHJpYnV0ZQogICAgICAgICAgICAgICAgIGNhdXNpbmcgQUxMIGRpcmVjdGl2ZXMgYmVsb3cgdG8gc2tpcCBhbmltYXRpb25zIGR1cmluZyB0aGUgZGlnZXN0ICovCiAgICAgICAgICAgICAgaWYgKHJ1bm5lciAmJiBydW5uZXIuaXNDbGFzc0Jhc2VkKSB7CiAgICAgICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICQkYXN5bmNDYWxsYmFjayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSkgfHwge307CiAgICAgICAgICAgICAgICAgIGlmIChsb2NhbEFuaW1hdGlvbkNvdW50ID09IGRhdGEuaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uRXZlbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFLCBkYXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmlyZURvbmVDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBjYW5jZWxDaGlsZEFuaW1hdGlvbnMoZWxlbWVudCkgewogICAgICAgIHZhciBub2RlID0gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpOwogICAgICAgIGlmIChub2RlKSB7CiAgICAgICAgICB2YXIgbm9kZXMgPSBhbmd1bGFyLmlzRnVuY3Rpb24obm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKSA/CiAgICAgICAgICAgIG5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShOR19BTklNQVRFX0NMQVNTX05BTUUpIDoKICAgICAgICAgICAgbm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIE5HX0FOSU1BVEVfQ0xBU1NfTkFNRSk7CiAgICAgICAgICBmb3JFYWNoKG5vZGVzLCBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpOwogICAgICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLmFjdGl2ZSkgewogICAgICAgICAgICAgIGZvckVhY2goZGF0YS5hY3RpdmUsIGZ1bmN0aW9uKHJ1bm5lcikgewogICAgICAgICAgICAgICAgcnVubmVyLmNhbmNlbCgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNsZWFudXAoZWxlbWVudCwgY2xhc3NOYW1lKSB7CiAgICAgICAgaWYgKGlzTWF0Y2hpbmdFbGVtZW50KGVsZW1lbnQsICRyb290RWxlbWVudCkpIHsKICAgICAgICAgIGlmICghcm9vdEFuaW1hdGVTdGF0ZS5kaXNhYmxlZCkgewogICAgICAgICAgICByb290QW5pbWF0ZVN0YXRlLnJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgICAgcm9vdEFuaW1hdGVTdGF0ZS5zdHJ1Y3R1cmFsID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChjbGFzc05hbWUpIHsKICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpIHx8IHt9OwoKICAgICAgICAgIHZhciByZW1vdmVBbmltYXRpb25zID0gY2xhc3NOYW1lID09PSB0cnVlOwogICAgICAgICAgaWYgKCFyZW1vdmVBbmltYXRpb25zICYmIGRhdGEuYWN0aXZlICYmIGRhdGEuYWN0aXZlW2NsYXNzTmFtZV0pIHsKICAgICAgICAgICAgZGF0YS50b3RhbEFjdGl2ZS0tOwogICAgICAgICAgICBkZWxldGUgZGF0YS5hY3RpdmVbY2xhc3NOYW1lXTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAocmVtb3ZlQW5pbWF0aW9ucyB8fCAhZGF0YS50b3RhbEFjdGl2ZSkgewogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKE5HX0FOSU1BVEVfQ0xBU1NfTkFNRSk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRGF0YShOR19BTklNQVRFX1NUQVRFKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFuaW1hdGlvbnNEaXNhYmxlZChlbGVtZW50LCBwYXJlbnRFbGVtZW50KSB7CiAgICAgICAgaWYgKHJvb3RBbmltYXRlU3RhdGUuZGlzYWJsZWQpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzTWF0Y2hpbmdFbGVtZW50KGVsZW1lbnQsICRyb290RWxlbWVudCkpIHsKICAgICAgICAgIHJldHVybiByb290QW5pbWF0ZVN0YXRlLnJ1bm5pbmc7CiAgICAgICAgfQoKICAgICAgICB2YXIgYWxsb3dDaGlsZEFuaW1hdGlvbnMsIHBhcmVudFJ1bm5pbmdBbmltYXRpb24sIGhhc1BhcmVudDsKICAgICAgICBkbyB7CiAgICAgICAgICAvL3RoZSBlbGVtZW50IGRpZCBub3QgcmVhY2ggdGhlIHJvb3QgZWxlbWVudCB3aGljaCBtZWFucyB0aGF0IGl0CiAgICAgICAgICAvL2lzIG5vdCBhcGFydCBvZiB0aGUgRE9NLiBUaGVyZWZvcmUgdGhlcmUgaXMgbm8gcmVhc29uIHRvIGRvCiAgICAgICAgICAvL2FueSBhbmltYXRpb25zIG9uIGl0CiAgICAgICAgICBpZiAocGFyZW50RWxlbWVudC5sZW5ndGggPT09IDApIGJyZWFrOwoKICAgICAgICAgIHZhciBpc1Jvb3QgPSBpc01hdGNoaW5nRWxlbWVudChwYXJlbnRFbGVtZW50LCAkcm9vdEVsZW1lbnQpOwogICAgICAgICAgdmFyIHN0YXRlID0gaXNSb290ID8gcm9vdEFuaW1hdGVTdGF0ZSA6IChwYXJlbnRFbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSkgfHwge30pOwogICAgICAgICAgaWYgKHN0YXRlLmRpc2FibGVkKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIC8vbm8gbWF0dGVyIHdoYXQsIGZvciBhbiBhbmltYXRpb24gdG8gd29yayBpdCBtdXN0IHJlYWNoIHRoZSByb290IGVsZW1lbnQKICAgICAgICAgIC8vdGhpcyBpbXBsaWVzIHRoYXQgdGhlIGVsZW1lbnQgaXMgYXR0YWNoZWQgdG8gdGhlIERPTSB3aGVuIHRoZSBhbmltYXRpb24gaXMgcnVuCiAgICAgICAgICBpZiAoaXNSb290KSB7CiAgICAgICAgICAgIGhhc1BhcmVudCA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgLy9vbmNlIGEgZmxhZyBpcyBmb3VuZCB0aGF0IGlzIHN0cmljdGx5IGZhbHNlIHRoZW4gZXZlcnl0aGluZyBiZWZvcmUKICAgICAgICAgIC8vaXQgd2lsbCBiZSBkaXNjYXJkZWQgYW5kIGFsbCBjaGlsZCBhbmltYXRpb25zIHdpbGwgYmUgcmVzdHJpY3RlZAogICAgICAgICAgaWYgKGFsbG93Q2hpbGRBbmltYXRpb25zICE9PSBmYWxzZSkgewogICAgICAgICAgICB2YXIgYW5pbWF0ZUNoaWxkcmVuRmxhZyA9IHBhcmVudEVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NISUxEUkVOKTsKICAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKGFuaW1hdGVDaGlsZHJlbkZsYWcpKSB7CiAgICAgICAgICAgICAgYWxsb3dDaGlsZEFuaW1hdGlvbnMgPSBhbmltYXRlQ2hpbGRyZW5GbGFnOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcGFyZW50UnVubmluZ0FuaW1hdGlvbiA9IHBhcmVudFJ1bm5pbmdBbmltYXRpb24gfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5ydW5uaW5nIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHN0YXRlLmxhc3QgJiYgIXN0YXRlLmxhc3QuaXNDbGFzc0Jhc2VkKTsKICAgICAgICB9CiAgICAgICAgd2hpbGUocGFyZW50RWxlbWVudCA9IHBhcmVudEVsZW1lbnQucGFyZW50KCkpOwoKICAgICAgICByZXR1cm4gIWhhc1BhcmVudCB8fCAoIWFsbG93Q2hpbGRBbmltYXRpb25zICYmIHBhcmVudFJ1bm5pbmdBbmltYXRpb24pOwogICAgICB9CiAgICB9XSk7CgogICAgJGFuaW1hdGVQcm92aWRlci5yZWdpc3RlcignJywgWyckd2luZG93JywgJyRzbmlmZmVyJywgJyR0aW1lb3V0JywgJyQkYW5pbWF0ZVJlZmxvdycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCR3aW5kb3csICAgJHNuaWZmZXIsICAgJHRpbWVvdXQsICAgJCRhbmltYXRlUmVmbG93KSB7CiAgICAgIC8vIERldGVjdCBwcm9wZXIgdHJhbnNpdGlvbmVuZC9hbmltYXRpb25lbmQgZXZlbnQgbmFtZXMuCiAgICAgIHZhciBDU1NfUFJFRklYID0gJycsIFRSQU5TSVRJT05fUFJPUCwgVFJBTlNJVElPTkVORF9FVkVOVCwgQU5JTUFUSU9OX1BST1AsIEFOSU1BVElPTkVORF9FVkVOVDsKCiAgICAgIC8vIElmIHVucHJlZml4ZWQgZXZlbnRzIGFyZSBub3Qgc3VwcG9ydGVkIGJ1dCB3ZWJraXQtcHJlZml4ZWQgYXJlLCB1c2UgdGhlIGxhdHRlci4KICAgICAgLy8gT3RoZXJ3aXNlLCBqdXN0IHVzZSBXM0MgbmFtZXMsIGJyb3dzZXJzIG5vdCBzdXBwb3J0aW5nIHRoZW0gYXQgYWxsIHdpbGwganVzdCBpZ25vcmUgdGhlbS4KICAgICAgLy8gTm90ZTogQ2hyb21lIGltcGxlbWVudHMgYHdpbmRvdy5vbndlYmtpdGFuaW1hdGlvbmVuZGAgYW5kIGRvZXNuJ3QgaW1wbGVtZW50IGB3aW5kb3cub25hbmltYXRpb25lbmRgCiAgICAgIC8vIGJ1dCBhdCB0aGUgc2FtZSB0aW1lIGRpc3BhdGNoZXMgdGhlIGBhbmltYXRpb25lbmRgIGV2ZW50IGFuZCBub3QgYHdlYmtpdEFuaW1hdGlvbkVuZGAuCiAgICAgIC8vIFJlZ2lzdGVyIGJvdGggZXZlbnRzIGluIGNhc2UgYHdpbmRvdy5vbmFuaW1hdGlvbmVuZGAgaXMgbm90IHN1cHBvcnRlZCBiZWNhdXNlIG9mIHRoYXQsCiAgICAgIC8vIGRvIHRoZSBzYW1lIGZvciBgdHJhbnNpdGlvbmVuZGAgYXMgU2FmYXJpIGlzIGxpa2VseSB0byBleGhpYml0IHNpbWlsYXIgYmVoYXZpb3IuCiAgICAgIC8vIEFsc28sIHRoZSBvbmx5IG1vZGVybiBicm93c2VyIHRoYXQgdXNlcyB2ZW5kb3IgcHJlZml4ZXMgZm9yIHRyYW5zaXRpb25zL2tleWZyYW1lcyBpcyB3ZWJraXQKICAgICAgLy8gdGhlcmVmb3JlIHRoZXJlIGlzIG5vIHJlYXNvbiB0byB0ZXN0IGFueW1vcmUgZm9yIG90aGVyIHZlbmRvciBwcmVmaXhlczogaHR0cDovL2Nhbml1c2UuY29tLyNzZWFyY2g9dHJhbnNpdGlvbgogICAgICBpZiAod2luZG93Lm9udHJhbnNpdGlvbmVuZCA9PT0gdW5kZWZpbmVkICYmIHdpbmRvdy5vbndlYmtpdHRyYW5zaXRpb25lbmQgIT09IHVuZGVmaW5lZCkgewogICAgICAgIENTU19QUkVGSVggPSAnLXdlYmtpdC0nOwogICAgICAgIFRSQU5TSVRJT05fUFJPUCA9ICdXZWJraXRUcmFuc2l0aW9uJzsKICAgICAgICBUUkFOU0lUSU9ORU5EX0VWRU5UID0gJ3dlYmtpdFRyYW5zaXRpb25FbmQgdHJhbnNpdGlvbmVuZCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgVFJBTlNJVElPTl9QUk9QID0gJ3RyYW5zaXRpb24nOwogICAgICAgIFRSQU5TSVRJT05FTkRfRVZFTlQgPSAndHJhbnNpdGlvbmVuZCc7CiAgICAgIH0KCiAgICAgIGlmICh3aW5kb3cub25hbmltYXRpb25lbmQgPT09IHVuZGVmaW5lZCAmJiB3aW5kb3cub253ZWJraXRhbmltYXRpb25lbmQgIT09IHVuZGVmaW5lZCkgewogICAgICAgIENTU19QUkVGSVggPSAnLXdlYmtpdC0nOwogICAgICAgIEFOSU1BVElPTl9QUk9QID0gJ1dlYmtpdEFuaW1hdGlvbic7CiAgICAgICAgQU5JTUFUSU9ORU5EX0VWRU5UID0gJ3dlYmtpdEFuaW1hdGlvbkVuZCBhbmltYXRpb25lbmQnOwogICAgICB9IGVsc2UgewogICAgICAgIEFOSU1BVElPTl9QUk9QID0gJ2FuaW1hdGlvbic7CiAgICAgICAgQU5JTUFUSU9ORU5EX0VWRU5UID0gJ2FuaW1hdGlvbmVuZCc7CiAgICAgIH0KCiAgICAgIHZhciBEVVJBVElPTl9LRVkgPSAnRHVyYXRpb24nOwogICAgICB2YXIgUFJPUEVSVFlfS0VZID0gJ1Byb3BlcnR5JzsKICAgICAgdmFyIERFTEFZX0tFWSA9ICdEZWxheSc7CiAgICAgIHZhciBBTklNQVRJT05fSVRFUkFUSU9OX0NPVU5UX0tFWSA9ICdJdGVyYXRpb25Db3VudCc7CiAgICAgIHZhciBBTklNQVRJT05fUExBWVNUQVRFX0tFWSA9ICdQbGF5U3RhdGUnOwogICAgICB2YXIgTkdfQU5JTUFURV9QQVJFTlRfS0VZID0gJyQkbmdBbmltYXRlS2V5JzsKICAgICAgdmFyIE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZID0gJyQkbmdBbmltYXRlQ1NTM0RhdGEnOwogICAgICB2YXIgRUxBUFNFRF9USU1FX01BWF9ERUNJTUFMX1BMQUNFUyA9IDM7CiAgICAgIHZhciBDTE9TSU5HX1RJTUVfQlVGRkVSID0gMS41OwogICAgICB2YXIgT05FX1NFQ09ORCA9IDEwMDA7CgogICAgICB2YXIgbG9va3VwQ2FjaGUgPSB7fTsKICAgICAgdmFyIHBhcmVudENvdW50ZXIgPSAwOwogICAgICB2YXIgYW5pbWF0aW9uUmVmbG93UXVldWUgPSBbXTsKICAgICAgdmFyIGNhbmNlbEFuaW1hdGlvblJlZmxvdzsKICAgICAgZnVuY3Rpb24gY2xlYXJDYWNoZUFmdGVyUmVmbG93KCkgewogICAgICAgIGlmICghY2FuY2VsQW5pbWF0aW9uUmVmbG93KSB7CiAgICAgICAgICBjYW5jZWxBbmltYXRpb25SZWZsb3cgPSAkJGFuaW1hdGVSZWZsb3coZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGFuaW1hdGlvblJlZmxvd1F1ZXVlID0gW107CiAgICAgICAgICAgIGNhbmNlbEFuaW1hdGlvblJlZmxvdyA9IG51bGw7CiAgICAgICAgICAgIGxvb2t1cENhY2hlID0ge307CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFmdGVyUmVmbG93KGVsZW1lbnQsIGNhbGxiYWNrKSB7CiAgICAgICAgaWYgKGNhbmNlbEFuaW1hdGlvblJlZmxvdykgewogICAgICAgICAgY2FuY2VsQW5pbWF0aW9uUmVmbG93KCk7CiAgICAgICAgfQogICAgICAgIGFuaW1hdGlvblJlZmxvd1F1ZXVlLnB1c2goY2FsbGJhY2spOwogICAgICAgIGNhbmNlbEFuaW1hdGlvblJlZmxvdyA9ICQkYW5pbWF0ZVJlZmxvdyhmdW5jdGlvbigpIHsKICAgICAgICAgIGZvckVhY2goYW5pbWF0aW9uUmVmbG93UXVldWUsIGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBhbmltYXRpb25SZWZsb3dRdWV1ZSA9IFtdOwogICAgICAgICAgY2FuY2VsQW5pbWF0aW9uUmVmbG93ID0gbnVsbDsKICAgICAgICAgIGxvb2t1cENhY2hlID0ge307CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHZhciBjbG9zaW5nVGltZXIgPSBudWxsOwogICAgICB2YXIgY2xvc2luZ1RpbWVzdGFtcCA9IDA7CiAgICAgIHZhciBhbmltYXRpb25FbGVtZW50UXVldWUgPSBbXTsKICAgICAgZnVuY3Rpb24gYW5pbWF0aW9uQ2xvc2VIYW5kbGVyKGVsZW1lbnQsIHRvdGFsVGltZSkgewogICAgICAgIHZhciBub2RlID0gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpOwogICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQobm9kZSk7CgogICAgICAgIC8vdGhpcyBpdGVtIHdpbGwgYmUgZ2FyYmFnZSBjb2xsZWN0ZWQgYnkgdGhlIGNsb3NpbmcKICAgICAgICAvL2FuaW1hdGlvbiB0aW1lb3V0CiAgICAgICAgYW5pbWF0aW9uRWxlbWVudFF1ZXVlLnB1c2goZWxlbWVudCk7CgogICAgICAgIC8vYnV0IGl0IG1heSBub3QgbmVlZCB0byBjYW5jZWwgb3V0IHRoZSBleGlzdGluZyB0aW1lb3V0CiAgICAgICAgLy9pZiB0aGUgdGltZXN0YW1wIGlzIGxlc3MgdGhhbiB0aGUgcHJldmlvdXMgb25lCiAgICAgICAgdmFyIGZ1dHVyZVRpbWVzdGFtcCA9IERhdGUubm93KCkgKyB0b3RhbFRpbWU7CiAgICAgICAgaWYgKGZ1dHVyZVRpbWVzdGFtcCA8PSBjbG9zaW5nVGltZXN0YW1wKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAkdGltZW91dC5jYW5jZWwoY2xvc2luZ1RpbWVyKTsKCiAgICAgICAgY2xvc2luZ1RpbWVzdGFtcCA9IGZ1dHVyZVRpbWVzdGFtcDsKICAgICAgICBjbG9zaW5nVGltZXIgPSAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIGNsb3NlQWxsQW5pbWF0aW9ucyhhbmltYXRpb25FbGVtZW50UXVldWUpOwogICAgICAgICAgYW5pbWF0aW9uRWxlbWVudFF1ZXVlID0gW107CiAgICAgICAgfSwgdG90YWxUaW1lLCBmYWxzZSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNsb3NlQWxsQW5pbWF0aW9ucyhlbGVtZW50cykgewogICAgICAgIGZvckVhY2goZWxlbWVudHMsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgIHZhciBlbGVtZW50RGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSk7CiAgICAgICAgICBpZiAoZWxlbWVudERhdGEpIHsKICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50RGF0YS5jbG9zZUFuaW1hdGlvbkZucywgZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0RWxlbWVudEFuaW1hdGlvbkRldGFpbHMoZWxlbWVudCwgY2FjaGVLZXkpIHsKICAgICAgICB2YXIgZGF0YSA9IGNhY2hlS2V5ID8gbG9va3VwQ2FjaGVbY2FjaGVLZXldIDogbnVsbDsKICAgICAgICBpZiAoIWRhdGEpIHsKICAgICAgICAgIHZhciB0cmFuc2l0aW9uRHVyYXRpb24gPSAwOwogICAgICAgICAgdmFyIHRyYW5zaXRpb25EZWxheSA9IDA7CiAgICAgICAgICB2YXIgYW5pbWF0aW9uRHVyYXRpb24gPSAwOwogICAgICAgICAgdmFyIGFuaW1hdGlvbkRlbGF5ID0gMDsKCiAgICAgICAgICAvL3dlIHdhbnQgYWxsIHRoZSBzdHlsZXMgZGVmaW5lZCBiZWZvcmUgYW5kIGFmdGVyCiAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGVsZW1lbnRTdHlsZXMgPSAkd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCkgfHwge307CgogICAgICAgICAgICAgIHZhciB0cmFuc2l0aW9uRHVyYXRpb25TdHlsZSA9IGVsZW1lbnRTdHlsZXNbVFJBTlNJVElPTl9QUk9QICsgRFVSQVRJT05fS0VZXTsKICAgICAgICAgICAgICB0cmFuc2l0aW9uRHVyYXRpb24gPSBNYXRoLm1heChwYXJzZU1heFRpbWUodHJhbnNpdGlvbkR1cmF0aW9uU3R5bGUpLCB0cmFuc2l0aW9uRHVyYXRpb24pOwoKICAgICAgICAgICAgICB2YXIgdHJhbnNpdGlvbkRlbGF5U3R5bGUgPSBlbGVtZW50U3R5bGVzW1RSQU5TSVRJT05fUFJPUCArIERFTEFZX0tFWV07CiAgICAgICAgICAgICAgdHJhbnNpdGlvbkRlbGF5ICA9IE1hdGgubWF4KHBhcnNlTWF4VGltZSh0cmFuc2l0aW9uRGVsYXlTdHlsZSksIHRyYW5zaXRpb25EZWxheSk7CgogICAgICAgICAgICAgIHZhciBhbmltYXRpb25EZWxheVN0eWxlID0gZWxlbWVudFN0eWxlc1tBTklNQVRJT05fUFJPUCArIERFTEFZX0tFWV07CiAgICAgICAgICAgICAgYW5pbWF0aW9uRGVsYXkgICA9IE1hdGgubWF4KHBhcnNlTWF4VGltZShlbGVtZW50U3R5bGVzW0FOSU1BVElPTl9QUk9QICsgREVMQVlfS0VZXSksIGFuaW1hdGlvbkRlbGF5KTsKCiAgICAgICAgICAgICAgdmFyIGFEdXJhdGlvbiAgPSBwYXJzZU1heFRpbWUoZWxlbWVudFN0eWxlc1tBTklNQVRJT05fUFJPUCArIERVUkFUSU9OX0tFWV0pOwoKICAgICAgICAgICAgICBpZiAoYUR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgICAgYUR1cmF0aW9uICo9IHBhcnNlSW50KGVsZW1lbnRTdHlsZXNbQU5JTUFUSU9OX1BST1AgKyBBTklNQVRJT05fSVRFUkFUSU9OX0NPVU5UX0tFWV0sIDEwKSB8fCAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhbmltYXRpb25EdXJhdGlvbiA9IE1hdGgubWF4KGFEdXJhdGlvbiwgYW5pbWF0aW9uRHVyYXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGRhdGEgPSB7CiAgICAgICAgICAgIHRvdGFsIDogMCwKICAgICAgICAgICAgdHJhbnNpdGlvbkRlbGF5OiB0cmFuc2l0aW9uRGVsYXksCiAgICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvbjogdHJhbnNpdGlvbkR1cmF0aW9uLAogICAgICAgICAgICBhbmltYXRpb25EZWxheTogYW5pbWF0aW9uRGVsYXksCiAgICAgICAgICAgIGFuaW1hdGlvbkR1cmF0aW9uOiBhbmltYXRpb25EdXJhdGlvbgogICAgICAgICAgfTsKICAgICAgICAgIGlmIChjYWNoZUtleSkgewogICAgICAgICAgICBsb29rdXBDYWNoZVtjYWNoZUtleV0gPSBkYXRhOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcGFyc2VNYXhUaW1lKHN0cikgewogICAgICAgIHZhciBtYXhWYWx1ZSA9IDA7CiAgICAgICAgdmFyIHZhbHVlcyA9IGlzU3RyaW5nKHN0cikgPwogICAgICAgICAgc3RyLnNwbGl0KC9ccyosXHMqLykgOgogICAgICAgICAgW107CiAgICAgICAgZm9yRWFjaCh2YWx1ZXMsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBtYXhWYWx1ZSA9IE1hdGgubWF4KHBhcnNlRmxvYXQodmFsdWUpIHx8IDAsIG1heFZhbHVlKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbWF4VmFsdWU7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGdldENhY2hlS2V5KGVsZW1lbnQpIHsKICAgICAgICB2YXIgcGFyZW50RWxlbWVudCA9IGVsZW1lbnQucGFyZW50KCk7CiAgICAgICAgdmFyIHBhcmVudElEID0gcGFyZW50RWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfUEFSRU5UX0tFWSk7CiAgICAgICAgaWYgKCFwYXJlbnRJRCkgewogICAgICAgICAgcGFyZW50RWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfUEFSRU5UX0tFWSwgKytwYXJlbnRDb3VudGVyKTsKICAgICAgICAgIHBhcmVudElEID0gcGFyZW50Q291bnRlcjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhcmVudElEICsgJy0nICsgZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYW5pbWF0ZVNldHVwKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIHN0eWxlcykgewogICAgICAgIHZhciBzdHJ1Y3R1cmFsID0gWyduZy1lbnRlcicsJ25nLWxlYXZlJywnbmctbW92ZSddLmluZGV4T2YoY2xhc3NOYW1lKSA+PSAwOwoKICAgICAgICB2YXIgY2FjaGVLZXkgPSBnZXRDYWNoZUtleShlbGVtZW50KTsKICAgICAgICB2YXIgZXZlbnRDYWNoZUtleSA9IGNhY2hlS2V5ICsgJyAnICsgY2xhc3NOYW1lOwogICAgICAgIHZhciBpdGVtSW5kZXggPSBsb29rdXBDYWNoZVtldmVudENhY2hlS2V5XSA/ICsrbG9va3VwQ2FjaGVbZXZlbnRDYWNoZUtleV0udG90YWwgOiAwOwoKICAgICAgICB2YXIgc3RhZ2dlciA9IHt9OwogICAgICAgIGlmIChpdGVtSW5kZXggPiAwKSB7CiAgICAgICAgICB2YXIgc3RhZ2dlckNsYXNzTmFtZSA9IGNsYXNzTmFtZSArICctc3RhZ2dlcic7CiAgICAgICAgICB2YXIgc3RhZ2dlckNhY2hlS2V5ID0gY2FjaGVLZXkgKyAnICcgKyBzdGFnZ2VyQ2xhc3NOYW1lOwogICAgICAgICAgdmFyIGFwcGx5Q2xhc3NlcyA9ICFsb29rdXBDYWNoZVtzdGFnZ2VyQ2FjaGVLZXldOwoKICAgICAgICAgIGFwcGx5Q2xhc3NlcyAmJiBlbGVtZW50LmFkZENsYXNzKHN0YWdnZXJDbGFzc05hbWUpOwoKICAgICAgICAgIHN0YWdnZXIgPSBnZXRFbGVtZW50QW5pbWF0aW9uRGV0YWlscyhlbGVtZW50LCBzdGFnZ2VyQ2FjaGVLZXkpOwoKICAgICAgICAgIGFwcGx5Q2xhc3NlcyAmJiBlbGVtZW50LnJlbW92ZUNsYXNzKHN0YWdnZXJDbGFzc05hbWUpOwogICAgICAgIH0KCiAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhjbGFzc05hbWUpOwoKICAgICAgICB2YXIgZm9ybWVyRGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSkgfHwge307CiAgICAgICAgdmFyIHRpbWluZ3MgPSBnZXRFbGVtZW50QW5pbWF0aW9uRGV0YWlscyhlbGVtZW50LCBldmVudENhY2hlS2V5KTsKICAgICAgICB2YXIgdHJhbnNpdGlvbkR1cmF0aW9uID0gdGltaW5ncy50cmFuc2l0aW9uRHVyYXRpb247CiAgICAgICAgdmFyIGFuaW1hdGlvbkR1cmF0aW9uID0gdGltaW5ncy5hbmltYXRpb25EdXJhdGlvbjsKCiAgICAgICAgaWYgKHN0cnVjdHVyYWwgJiYgdHJhbnNpdGlvbkR1cmF0aW9uID09PSAwICYmIGFuaW1hdGlvbkR1cmF0aW9uID09PSAwKSB7CiAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB2YXIgYmxvY2tUcmFuc2l0aW9uID0gc3R5bGVzIHx8IChzdHJ1Y3R1cmFsICYmIHRyYW5zaXRpb25EdXJhdGlvbiA+IDApOwogICAgICAgIHZhciBibG9ja0FuaW1hdGlvbiA9IGFuaW1hdGlvbkR1cmF0aW9uID4gMCAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWdnZXIuYW5pbWF0aW9uRGVsYXkgPiAwICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhZ2dlci5hbmltYXRpb25EdXJhdGlvbiA9PT0gMDsKCiAgICAgICAgdmFyIGNsb3NlQW5pbWF0aW9uRm5zID0gZm9ybWVyRGF0YS5jbG9zZUFuaW1hdGlvbkZucyB8fCBbXTsKICAgICAgICBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9DU1NfREFUQV9LRVksIHsKICAgICAgICAgIHN0YWdnZXIgOiBzdGFnZ2VyLAogICAgICAgICAgY2FjaGVLZXkgOiBldmVudENhY2hlS2V5LAogICAgICAgICAgcnVubmluZyA6IGZvcm1lckRhdGEucnVubmluZyB8fCAwLAogICAgICAgICAgaXRlbUluZGV4IDogaXRlbUluZGV4LAogICAgICAgICAgYmxvY2tUcmFuc2l0aW9uIDogYmxvY2tUcmFuc2l0aW9uLAogICAgICAgICAgY2xvc2VBbmltYXRpb25GbnMgOiBjbG9zZUFuaW1hdGlvbkZucwogICAgICAgIH0pOwoKICAgICAgICB2YXIgbm9kZSA9IGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KTsKCiAgICAgICAgaWYgKGJsb2NrVHJhbnNpdGlvbikgewogICAgICAgICAgYmxvY2tUcmFuc2l0aW9ucyhub2RlLCB0cnVlKTsKICAgICAgICAgIGlmIChzdHlsZXMpIHsKICAgICAgICAgICAgZWxlbWVudC5jc3Moc3R5bGVzKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChibG9ja0FuaW1hdGlvbikgewogICAgICAgICAgYmxvY2tBbmltYXRpb25zKG5vZGUsIHRydWUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFuaW1hdGVSdW4oYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgYWN0aXZlQW5pbWF0aW9uQ29tcGxldGUsIHN0eWxlcykgewogICAgICAgIHZhciBub2RlID0gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpOwogICAgICAgIHZhciBlbGVtZW50RGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSk7CiAgICAgICAgaWYgKG5vZGUuZ2V0QXR0cmlidXRlKCdjbGFzcycpLmluZGV4T2YoY2xhc3NOYW1lKSA9PSAtMSB8fCAhZWxlbWVudERhdGEpIHsKICAgICAgICAgIGFjdGl2ZUFuaW1hdGlvbkNvbXBsZXRlKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgYWN0aXZlQ2xhc3NOYW1lID0gJyc7CiAgICAgICAgdmFyIHBlbmRpbmdDbGFzc05hbWUgPSAnJzsKICAgICAgICBmb3JFYWNoKGNsYXNzTmFtZS5zcGxpdCgnICcpLCBmdW5jdGlvbihrbGFzcywgaSkgewogICAgICAgICAgdmFyIHByZWZpeCA9IChpID4gMCA/ICcgJyA6ICcnKSArIGtsYXNzOwogICAgICAgICAgYWN0aXZlQ2xhc3NOYW1lICs9IHByZWZpeCArICctYWN0aXZlJzsKICAgICAgICAgIHBlbmRpbmdDbGFzc05hbWUgKz0gcHJlZml4ICsgJy1wZW5kaW5nJzsKICAgICAgICB9KTsKCiAgICAgICAgdmFyIHN0eWxlID0gJyc7CiAgICAgICAgdmFyIGFwcGxpZWRTdHlsZXMgPSBbXTsKICAgICAgICB2YXIgaXRlbUluZGV4ID0gZWxlbWVudERhdGEuaXRlbUluZGV4OwogICAgICAgIHZhciBzdGFnZ2VyID0gZWxlbWVudERhdGEuc3RhZ2dlcjsKICAgICAgICB2YXIgc3RhZ2dlclRpbWUgPSAwOwogICAgICAgIGlmIChpdGVtSW5kZXggPiAwKSB7CiAgICAgICAgICB2YXIgdHJhbnNpdGlvblN0YWdnZXJEZWxheSA9IDA7CiAgICAgICAgICBpZiAoc3RhZ2dlci50cmFuc2l0aW9uRGVsYXkgPiAwICYmIHN0YWdnZXIudHJhbnNpdGlvbkR1cmF0aW9uID09PSAwKSB7CiAgICAgICAgICAgIHRyYW5zaXRpb25TdGFnZ2VyRGVsYXkgPSBzdGFnZ2VyLnRyYW5zaXRpb25EZWxheSAqIGl0ZW1JbmRleDsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgYW5pbWF0aW9uU3RhZ2dlckRlbGF5ID0gMDsKICAgICAgICAgIGlmIChzdGFnZ2VyLmFuaW1hdGlvbkRlbGF5ID4gMCAmJiBzdGFnZ2VyLmFuaW1hdGlvbkR1cmF0aW9uID09PSAwKSB7CiAgICAgICAgICAgIGFuaW1hdGlvblN0YWdnZXJEZWxheSA9IHN0YWdnZXIuYW5pbWF0aW9uRGVsYXkgKiBpdGVtSW5kZXg7CiAgICAgICAgICAgIGFwcGxpZWRTdHlsZXMucHVzaChDU1NfUFJFRklYICsgJ2FuaW1hdGlvbi1wbGF5LXN0YXRlJyk7CiAgICAgICAgICB9CgogICAgICAgICAgc3RhZ2dlclRpbWUgPSBNYXRoLnJvdW5kKE1hdGgubWF4KHRyYW5zaXRpb25TdGFnZ2VyRGVsYXksIGFuaW1hdGlvblN0YWdnZXJEZWxheSkgKiAxMDApIC8gMTAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFzdGFnZ2VyVGltZSkgewogICAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhhY3RpdmVDbGFzc05hbWUpOwogICAgICAgICAgaWYgKGVsZW1lbnREYXRhLmJsb2NrVHJhbnNpdGlvbikgewogICAgICAgICAgICBibG9ja1RyYW5zaXRpb25zKG5vZGUsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBldmVudENhY2hlS2V5ID0gZWxlbWVudERhdGEuY2FjaGVLZXkgKyAnICcgKyBhY3RpdmVDbGFzc05hbWU7CiAgICAgICAgdmFyIHRpbWluZ3MgPSBnZXRFbGVtZW50QW5pbWF0aW9uRGV0YWlscyhlbGVtZW50LCBldmVudENhY2hlS2V5KTsKICAgICAgICB2YXIgbWF4RHVyYXRpb24gPSBNYXRoLm1heCh0aW1pbmdzLnRyYW5zaXRpb25EdXJhdGlvbiwgdGltaW5ncy5hbmltYXRpb25EdXJhdGlvbik7CiAgICAgICAgaWYgKG1heER1cmF0aW9uID09PSAwKSB7CiAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKGFjdGl2ZUNsYXNzTmFtZSk7CiAgICAgICAgICBhbmltYXRlQ2xvc2UoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgIGFjdGl2ZUFuaW1hdGlvbkNvbXBsZXRlKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoIXN0YWdnZXJUaW1lICYmIHN0eWxlcykgewogICAgICAgICAgaWYgKCF0aW1pbmdzLnRyYW5zaXRpb25EdXJhdGlvbikgewogICAgICAgICAgICBlbGVtZW50LmNzcygndHJhbnNpdGlvbicsIHRpbWluZ3MuYW5pbWF0aW9uRHVyYXRpb24gKyAncyBsaW5lYXIgYWxsJyk7CiAgICAgICAgICAgIGFwcGxpZWRTdHlsZXMucHVzaCgndHJhbnNpdGlvbicpOwogICAgICAgICAgfQogICAgICAgICAgZWxlbWVudC5jc3Moc3R5bGVzKTsKICAgICAgICB9CgogICAgICAgIHZhciBtYXhEZWxheSA9IE1hdGgubWF4KHRpbWluZ3MudHJhbnNpdGlvbkRlbGF5LCB0aW1pbmdzLmFuaW1hdGlvbkRlbGF5KTsKICAgICAgICB2YXIgbWF4RGVsYXlUaW1lID0gbWF4RGVsYXkgKiBPTkVfU0VDT05EOwoKICAgICAgICBpZiAoYXBwbGllZFN0eWxlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAvL3RoZSBlbGVtZW50IGJlaW5nIGFuaW1hdGVkIG1heSBzb21ldGltZXMgY29udGFpbiBjb21tZW50IG5vZGVzIGluCiAgICAgICAgICAvL3RoZSBqcUxpdGUgb2JqZWN0LCBzbyB3ZSdyZSBzYWZlIHRvIHVzZSBhIHNpbmdsZSB2YXJpYWJsZSB0byBob3VzZQogICAgICAgICAgLy90aGUgc3R5bGVzIHNpbmNlIHRoZXJlIGlzIGFsd2F5cyBvbmx5IG9uZSBlbGVtZW50IGJlaW5nIGFuaW1hdGVkCiAgICAgICAgICB2YXIgb2xkU3R5bGUgPSBub2RlLmdldEF0dHJpYnV0ZSgnc3R5bGUnKSB8fCAnJzsKICAgICAgICAgIGlmIChvbGRTdHlsZS5jaGFyQXQob2xkU3R5bGUubGVuZ3RoLTEpICE9PSAnOycpIHsKICAgICAgICAgICAgb2xkU3R5bGUgKz0gJzsnOwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgb2xkU3R5bGUgKyAnICcgKyBzdHlsZSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICB2YXIgY3NzM0FuaW1hdGlvbkV2ZW50cyA9IEFOSU1BVElPTkVORF9FVkVOVCArICcgJyArIFRSQU5TSVRJT05FTkRfRVZFTlQ7CiAgICAgICAgdmFyIGFuaW1hdGlvblRpbWUgICAgID0gKG1heERlbGF5ICsgbWF4RHVyYXRpb24pICogQ0xPU0lOR19USU1FX0JVRkZFUjsKICAgICAgICB2YXIgdG90YWxUaW1lICAgICAgICAgPSAoc3RhZ2dlclRpbWUgKyBhbmltYXRpb25UaW1lKSAqIE9ORV9TRUNPTkQ7CgogICAgICAgIHZhciBzdGFnZ2VyVGltZW91dDsKICAgICAgICBpZiAoc3RhZ2dlclRpbWUgPiAwKSB7CiAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKHBlbmRpbmdDbGFzc05hbWUpOwogICAgICAgICAgc3RhZ2dlclRpbWVvdXQgPSAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgc3RhZ2dlclRpbWVvdXQgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHRpbWluZ3MudHJhbnNpdGlvbkR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgIGJsb2NrVHJhbnNpdGlvbnMobm9kZSwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aW1pbmdzLmFuaW1hdGlvbkR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgIGJsb2NrQW5pbWF0aW9ucyhub2RlLCBmYWxzZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoYWN0aXZlQ2xhc3NOYW1lKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhwZW5kaW5nQ2xhc3NOYW1lKTsKCiAgICAgICAgICAgIGlmIChzdHlsZXMpIHsKICAgICAgICAgICAgICBpZiAodGltaW5ncy50cmFuc2l0aW9uRHVyYXRpb24gPT09IDApIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuY3NzKCd0cmFuc2l0aW9uJywgdGltaW5ncy5hbmltYXRpb25EdXJhdGlvbiArICdzIGxpbmVhciBhbGwnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxlbWVudC5jc3Moc3R5bGVzKTsKICAgICAgICAgICAgICBhcHBsaWVkU3R5bGVzLnB1c2goJ3RyYW5zaXRpb24nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgc3RhZ2dlclRpbWUgKiBPTkVfU0VDT05ELCBmYWxzZSk7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50Lm9uKGNzczNBbmltYXRpb25FdmVudHMsIG9uQW5pbWF0aW9uUHJvZ3Jlc3MpOwogICAgICAgIGVsZW1lbnREYXRhLmNsb3NlQW5pbWF0aW9uRm5zLnB1c2goZnVuY3Rpb24oKSB7CiAgICAgICAgICBvbkVuZCgpOwogICAgICAgICAgYWN0aXZlQW5pbWF0aW9uQ29tcGxldGUoKTsKICAgICAgICB9KTsKCiAgICAgICAgZWxlbWVudERhdGEucnVubmluZysrOwogICAgICAgIGFuaW1hdGlvbkNsb3NlSGFuZGxlcihlbGVtZW50LCB0b3RhbFRpbWUpOwogICAgICAgIHJldHVybiBvbkVuZDsKCiAgICAgICAgLy8gVGhpcyB3aWxsIGF1dG9tYXRpY2FsbHkgYmUgY2FsbGVkIGJ5ICRhbmltYXRlIHNvCiAgICAgICAgLy8gdGhlcmUgaXMgbm8gbmVlZCB0byBhdHRhY2ggdGhpcyBpbnRlcm5hbGx5IHRvIHRoZQogICAgICAgIC8vIHRpbWVvdXQgZG9uZSBtZXRob2QuCiAgICAgICAgZnVuY3Rpb24gb25FbmQoKSB7CiAgICAgICAgICBlbGVtZW50Lm9mZihjc3MzQW5pbWF0aW9uRXZlbnRzLCBvbkFuaW1hdGlvblByb2dyZXNzKTsKICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoYWN0aXZlQ2xhc3NOYW1lKTsKICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MocGVuZGluZ0NsYXNzTmFtZSk7CiAgICAgICAgICBpZiAoc3RhZ2dlclRpbWVvdXQpIHsKICAgICAgICAgICAgJHRpbWVvdXQuY2FuY2VsKHN0YWdnZXJUaW1lb3V0KTsKICAgICAgICAgIH0KICAgICAgICAgIGFuaW1hdGVDbG9zZShlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgdmFyIG5vZGUgPSBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCk7CiAgICAgICAgICBmb3IgKHZhciBpIGluIGFwcGxpZWRTdHlsZXMpIHsKICAgICAgICAgICAgbm9kZS5zdHlsZS5yZW1vdmVQcm9wZXJ0eShhcHBsaWVkU3R5bGVzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG9uQW5pbWF0aW9uUHJvZ3Jlc3MoZXZlbnQpIHsKICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgdmFyIGV2ID0gZXZlbnQub3JpZ2luYWxFdmVudCB8fCBldmVudDsKICAgICAgICAgIHZhciB0aW1lU3RhbXAgPSBldi4kbWFudWFsVGltZVN0YW1wIHx8IGV2LnRpbWVTdGFtcCB8fCBEYXRlLm5vdygpOwoKICAgICAgICAgIC8qIEZpcmVmb3ggKG9yIHBvc3NpYmx5IGp1c3QgR2Vja28pIGxpa2VzIHRvIG5vdCByb3VuZCB2YWx1ZXMgdXAKICAgICAgICAgICAqIHdoZW4gYSBtcyBtZWFzdXJlbWVudCBpcyB1c2VkIGZvciB0aGUgYW5pbWF0aW9uICovCiAgICAgICAgICB2YXIgZWxhcHNlZFRpbWUgPSBwYXJzZUZsb2F0KGV2LmVsYXBzZWRUaW1lLnRvRml4ZWQoRUxBUFNFRF9USU1FX01BWF9ERUNJTUFMX1BMQUNFUykpOwoKICAgICAgICAgIC8qICRtYW51YWxUaW1lU3RhbXAgaXMgYSBtb2NrZWQgdGltZVN0YW1wIHZhbHVlIHdoaWNoIGlzIHNldAogICAgICAgICAgICogd2l0aGluIGJyb3dzZXJUcmlnZ2VyKCkuIFRoaXMgaXMgb25seSBoZXJlIHNvIHRoYXQgdGVzdHMgY2FuCiAgICAgICAgICAgKiBtb2NrIGFuaW1hdGlvbnMgcHJvcGVybHkuIFJlYWwgZXZlbnRzIGZhbGxiYWNrIHRvIGV2ZW50LnRpbWVTdGFtcCwKICAgICAgICAgICAqIG9yLCBpZiB0aGV5IGRvbid0LCB0aGVuIGEgdGltZVN0YW1wIGlzIGF1dG9tYXRpY2FsbHkgY3JlYXRlZCBmb3IgdGhlbS4KICAgICAgICAgICAqIFdlJ3JlIGNoZWNraW5nIHRvIHNlZSBpZiB0aGUgdGltZVN0YW1wIHN1cnBhc3NlcyB0aGUgZXhwZWN0ZWQgZGVsYXksCiAgICAgICAgICAgKiBidXQgd2UncmUgdXNpbmcgZWxhcHNlZFRpbWUgaW5zdGVhZCBvZiB0aGUgdGltZVN0YW1wIG9uIHRoZSAybmQKICAgICAgICAgICAqIHByZS1jb25kaXRpb24gc2luY2UgYW5pbWF0aW9ucyBzb21ldGltZXMgY2xvc2Ugb2ZmIGVhcmx5ICovCiAgICAgICAgICBpZiAoTWF0aC5tYXgodGltZVN0YW1wIC0gc3RhcnRUaW1lLCAwKSA+PSBtYXhEZWxheVRpbWUgJiYgZWxhcHNlZFRpbWUgPj0gbWF4RHVyYXRpb24pIHsKICAgICAgICAgICAgYWN0aXZlQW5pbWF0aW9uQ29tcGxldGUoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGJsb2NrVHJhbnNpdGlvbnMobm9kZSwgYm9vbCkgewogICAgICAgIG5vZGUuc3R5bGVbVFJBTlNJVElPTl9QUk9QICsgUFJPUEVSVFlfS0VZXSA9IGJvb2wgPyAnbm9uZScgOiAnJzsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYmxvY2tBbmltYXRpb25zKG5vZGUsIGJvb2wpIHsKICAgICAgICBub2RlLnN0eWxlW0FOSU1BVElPTl9QUk9QICsgQU5JTUFUSU9OX1BMQVlTVEFURV9LRVldID0gYm9vbCA/ICdwYXVzZWQnIDogJyc7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFuaW1hdGVCZWZvcmUoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgc3R5bGVzKSB7CiAgICAgICAgaWYgKGFuaW1hdGVTZXR1cChhbmltYXRpb25FdmVudCwgZWxlbWVudCwgY2xhc3NOYW1lLCBzdHlsZXMpKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oY2FuY2VsbGVkKSB7CiAgICAgICAgICAgIGNhbmNlbGxlZCAmJiBhbmltYXRlQ2xvc2UoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBhbmltYXRlQWZ0ZXIoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgYWZ0ZXJBbmltYXRpb25Db21wbGV0ZSwgc3R5bGVzKSB7CiAgICAgICAgaWYgKGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSkpIHsKICAgICAgICAgIHJldHVybiBhbmltYXRlUnVuKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGFmdGVyQW5pbWF0aW9uQ29tcGxldGUsIHN0eWxlcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFuaW1hdGVDbG9zZShlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgYWZ0ZXJBbmltYXRpb25Db21wbGV0ZSgpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gYW5pbWF0ZShhbmltYXRpb25FdmVudCwgZWxlbWVudCwgY2xhc3NOYW1lLCBhbmltYXRpb25Db21wbGV0ZSwgb3B0aW9ucykgewogICAgICAgIC8vSWYgdGhlIGFuaW1hdGVTZXR1cCBmdW5jdGlvbiBkb2Vzbid0IGJvdGhlciByZXR1cm5pbmcgYQogICAgICAgIC8vY2FuY2VsbGF0aW9uIGZ1bmN0aW9uIHRoZW4gaXQgbWVhbnMgdGhhdCB0aGVyZSBpcyBubyBhbmltYXRpb24KICAgICAgICAvL3RvIHBlcmZvcm0gYXQgYWxsCiAgICAgICAgdmFyIHByZVJlZmxvd0NhbmNlbGxhdGlvbiA9IGFuaW1hdGVCZWZvcmUoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgb3B0aW9ucy5mcm9tKTsKICAgICAgICBpZiAoIXByZVJlZmxvd0NhbmNlbGxhdGlvbikgewogICAgICAgICAgY2xlYXJDYWNoZUFmdGVyUmVmbG93KCk7CiAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZSgpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy9UaGVyZSBhcmUgdHdvIGNhbmNlbGxhdGlvbiBmdW5jdGlvbnM6IG9uZSBpcyBiZWZvcmUgdGhlIGZpcnN0CiAgICAgICAgLy9yZWZsb3cgYW5pbWF0aW9uIGFuZCB0aGUgc2Vjb25kIGlzIGR1cmluZyB0aGUgYWN0aXZlIHN0YXRlCiAgICAgICAgLy9hbmltYXRpb24uIFRoZSBmaXJzdCBmdW5jdGlvbiB3aWxsIHRha2UgY2FyZSBvZiByZW1vdmluZyB0aGUKICAgICAgICAvL2RhdGEgZnJvbSB0aGUgZWxlbWVudCB3aGljaCB3aWxsIG5vdCBtYWtlIHRoZSAybmQgYW5pbWF0aW9uCiAgICAgICAgLy9oYXBwZW4gaW4gdGhlIGZpcnN0IHBsYWNlCiAgICAgICAgdmFyIGNhbmNlbCA9IHByZVJlZmxvd0NhbmNlbGxhdGlvbjsKICAgICAgICBhZnRlclJlZmxvdyhlbGVtZW50LCBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vb25jZSB0aGUgcmVmbG93IGlzIGNvbXBsZXRlIHRoZW4gd2UgcG9pbnQgY2FuY2VsIHRvCiAgICAgICAgICAvL3RoZSBuZXcgY2FuY2VsbGF0aW9uIGZ1bmN0aW9uIHdoaWNoIHdpbGwgcmVtb3ZlIGFsbCBvZiB0aGUKICAgICAgICAgIC8vYW5pbWF0aW9uIHByb3BlcnRpZXMgZnJvbSB0aGUgYWN0aXZlIGFuaW1hdGlvbgogICAgICAgICAgY2FuY2VsID0gYW5pbWF0ZUFmdGVyKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlLCBvcHRpb25zLnRvKTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbmNlbGxlZCkgewogICAgICAgICAgKGNhbmNlbCB8fCBub29wKShjYW5jZWxsZWQpOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFuaW1hdGVDbG9zZShlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9DU1NfREFUQV9LRVkpOwogICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5ydW5uaW5nKSB7CiAgICAgICAgICAgIGRhdGEucnVubmluZy0tOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFkYXRhLnJ1bm5pbmcgfHwgZGF0YS5ydW5uaW5nID09PSAwKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGFuaW1hdGUgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGZyb20sIHRvLCBhbmltYXRpb25Db21wbGV0ZWQsIG9wdGlvbnMpIHsKICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgb3B0aW9ucy5mcm9tID0gZnJvbTsKICAgICAgICAgIG9wdGlvbnMudG8gPSB0bzsKICAgICAgICAgIHJldHVybiBhbmltYXRlKCdhbmltYXRlJywgZWxlbWVudCwgY2xhc3NOYW1lLCBhbmltYXRpb25Db21wbGV0ZWQsIG9wdGlvbnMpOwogICAgICAgIH0sCgogICAgICAgIGVudGVyIDogZnVuY3Rpb24oZWxlbWVudCwgYW5pbWF0aW9uQ29tcGxldGVkLCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgIHJldHVybiBhbmltYXRlKCdlbnRlcicsIGVsZW1lbnQsICduZy1lbnRlcicsIGFuaW1hdGlvbkNvbXBsZXRlZCwgb3B0aW9ucyk7CiAgICAgICAgfSwKCiAgICAgICAgbGVhdmUgOiBmdW5jdGlvbihlbGVtZW50LCBhbmltYXRpb25Db21wbGV0ZWQsIG9wdGlvbnMpIHsKICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgcmV0dXJuIGFuaW1hdGUoJ2xlYXZlJywgZWxlbWVudCwgJ25nLWxlYXZlJywgYW5pbWF0aW9uQ29tcGxldGVkLCBvcHRpb25zKTsKICAgICAgICB9LAoKICAgICAgICBtb3ZlIDogZnVuY3Rpb24oZWxlbWVudCwgYW5pbWF0aW9uQ29tcGxldGVkLCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgIHJldHVybiBhbmltYXRlKCdtb3ZlJywgZWxlbWVudCwgJ25nLW1vdmUnLCBhbmltYXRpb25Db21wbGV0ZWQsIG9wdGlvbnMpOwogICAgICAgIH0sCgogICAgICAgIGJlZm9yZVNldENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgYWRkLCByZW1vdmUsIGFuaW1hdGlvbkNvbXBsZXRlZCwgb3B0aW9ucykgewogICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gc3VmZml4Q2xhc3NlcyhyZW1vdmUsICctcmVtb3ZlJykgKyAnICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgIHN1ZmZpeENsYXNzZXMoYWRkLCAnLWFkZCcpOwogICAgICAgICAgdmFyIGNhbmNlbGxhdGlvbk1ldGhvZCA9IGFuaW1hdGVCZWZvcmUoJ3NldENsYXNzJywgZWxlbWVudCwgY2xhc3NOYW1lLCBvcHRpb25zLmZyb20pOwogICAgICAgICAgaWYgKGNhbmNlbGxhdGlvbk1ldGhvZCkgewogICAgICAgICAgICBhZnRlclJlZmxvdyhlbGVtZW50LCBhbmltYXRpb25Db21wbGV0ZWQpOwogICAgICAgICAgICByZXR1cm4gY2FuY2VsbGF0aW9uTWV0aG9kOwogICAgICAgICAgfQogICAgICAgICAgY2xlYXJDYWNoZUFmdGVyUmVmbG93KCk7CiAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZWQoKTsKICAgICAgICB9LAoKICAgICAgICBiZWZvcmVBZGRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGVkLCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgIHZhciBjYW5jZWxsYXRpb25NZXRob2QgPSBhbmltYXRlQmVmb3JlKCdhZGRDbGFzcycsIGVsZW1lbnQsIHN1ZmZpeENsYXNzZXMoY2xhc3NOYW1lLCAnLWFkZCcpLCBvcHRpb25zLmZyb20pOwogICAgICAgICAgaWYgKGNhbmNlbGxhdGlvbk1ldGhvZCkgewogICAgICAgICAgICBhZnRlclJlZmxvdyhlbGVtZW50LCBhbmltYXRpb25Db21wbGV0ZWQpOwogICAgICAgICAgICByZXR1cm4gY2FuY2VsbGF0aW9uTWV0aG9kOwogICAgICAgICAgfQogICAgICAgICAgY2xlYXJDYWNoZUFmdGVyUmVmbG93KCk7CiAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZWQoKTsKICAgICAgICB9LAoKICAgICAgICBiZWZvcmVSZW1vdmVDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGVkLCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgIHZhciBjYW5jZWxsYXRpb25NZXRob2QgPSBhbmltYXRlQmVmb3JlKCdyZW1vdmVDbGFzcycsIGVsZW1lbnQsIHN1ZmZpeENsYXNzZXMoY2xhc3NOYW1lLCAnLXJlbW92ZScpLCBvcHRpb25zLmZyb20pOwogICAgICAgICAgaWYgKGNhbmNlbGxhdGlvbk1ldGhvZCkgewogICAgICAgICAgICBhZnRlclJlZmxvdyhlbGVtZW50LCBhbmltYXRpb25Db21wbGV0ZWQpOwogICAgICAgICAgICByZXR1cm4gY2FuY2VsbGF0aW9uTWV0aG9kOwogICAgICAgICAgfQogICAgICAgICAgY2xlYXJDYWNoZUFmdGVyUmVmbG93KCk7CiAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZWQoKTsKICAgICAgICB9LAoKICAgICAgICBzZXRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGFkZCwgcmVtb3ZlLCBhbmltYXRpb25Db21wbGV0ZWQsIG9wdGlvbnMpIHsKICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgcmVtb3ZlID0gc3VmZml4Q2xhc3NlcyhyZW1vdmUsICctcmVtb3ZlJyk7CiAgICAgICAgICBhZGQgPSBzdWZmaXhDbGFzc2VzKGFkZCwgJy1hZGQnKTsKICAgICAgICAgIHZhciBjbGFzc05hbWUgPSByZW1vdmUgKyAnICcgKyBhZGQ7CiAgICAgICAgICByZXR1cm4gYW5pbWF0ZUFmdGVyKCdzZXRDbGFzcycsIGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGVkLCBvcHRpb25zLnRvKTsKICAgICAgICB9LAoKICAgICAgICBhZGRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGVkLCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgIHJldHVybiBhbmltYXRlQWZ0ZXIoJ2FkZENsYXNzJywgZWxlbWVudCwgc3VmZml4Q2xhc3NlcyhjbGFzc05hbWUsICctYWRkJyksIGFuaW1hdGlvbkNvbXBsZXRlZCwgb3B0aW9ucy50byk7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlZCwgb3B0aW9ucykgewogICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICByZXR1cm4gYW5pbWF0ZUFmdGVyKCdyZW1vdmVDbGFzcycsIGVsZW1lbnQsIHN1ZmZpeENsYXNzZXMoY2xhc3NOYW1lLCAnLXJlbW92ZScpLCBhbmltYXRpb25Db21wbGV0ZWQsIG9wdGlvbnMudG8pOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIHN1ZmZpeENsYXNzZXMoY2xhc3Nlcywgc3VmZml4KSB7CiAgICAgICAgdmFyIGNsYXNzTmFtZSA9ICcnOwogICAgICAgIGNsYXNzZXMgPSBpc0FycmF5KGNsYXNzZXMpID8gY2xhc3NlcyA6IGNsYXNzZXMuc3BsaXQoL1xzKy8pOwogICAgICAgIGZvckVhY2goY2xhc3NlcywgZnVuY3Rpb24oa2xhc3MsIGkpIHsKICAgICAgICAgIGlmIChrbGFzcyAmJiBrbGFzcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNsYXNzTmFtZSArPSAoaSA+IDAgPyAnICcgOiAnJykgKyBrbGFzcyArIHN1ZmZpeDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gY2xhc3NOYW1lOwogICAgICB9CiAgICB9XSk7CiAgfV0pOwoKCn0pKHdpbmRvdywgd2luZG93LmFuZ3VsYXIpOwoKLyoqCiAqIGFuZ3VsYXItc3RyYXAKICogQHZlcnNpb24gdjIuMS4yIC0gMjAxNC0xMC0xOQogKiBAbGluayBodHRwOi8vbWdjcmVhLmdpdGh1Yi5pby9hbmd1bGFyLXN0cmFwCiAqIEBhdXRob3IgT2xpdmllciBMb3V2aWduZXMgKG9saXZpZXJAbWctY3JlYS5jb20pCiAqIEBsaWNlbnNlIE1JVCBMaWNlbnNlLCBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL01JVAogKi8KKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCkgewondXNlIHN0cmljdCc7Ci8vIFNvdXJjZTogbW9kdWxlLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcCcsIFsKICAnbWdjcmVhLm5nU3RyYXAubW9kYWwnLAogICdtZ2NyZWEubmdTdHJhcC5hc2lkZScsCiAgJ21nY3JlYS5uZ1N0cmFwLmFsZXJ0JywKICAnbWdjcmVhLm5nU3RyYXAuYnV0dG9uJywKICAnbWdjcmVhLm5nU3RyYXAuc2VsZWN0JywKICAnbWdjcmVhLm5nU3RyYXAuZGF0ZXBpY2tlcicsCiAgJ21nY3JlYS5uZ1N0cmFwLnRpbWVwaWNrZXInLAogICdtZ2NyZWEubmdTdHJhcC5uYXZiYXInLAogICdtZ2NyZWEubmdTdHJhcC50b29sdGlwJywKICAnbWdjcmVhLm5nU3RyYXAucG9wb3ZlcicsCiAgJ21nY3JlYS5uZ1N0cmFwLmRyb3Bkb3duJywKICAnbWdjcmVhLm5nU3RyYXAudHlwZWFoZWFkJywKICAnbWdjcmVhLm5nU3RyYXAuc2Nyb2xsc3B5JywKICAnbWdjcmVhLm5nU3RyYXAuYWZmaXgnLAogICdtZ2NyZWEubmdTdHJhcC50YWInLAogICdtZ2NyZWEubmdTdHJhcC5jb2xsYXBzZScKXSk7CgovLyBTb3VyY2U6IGFsZXJ0LmpzCi8vIEBCVUc6IGZvbGxvd2luZyBzbmlwcGV0IHdvbid0IGNvbXBpbGUgY29ycmVjdGx5Ci8vIEBUT0RPOiBzdWJtaXQgaXNzdWUgdG8gY29yZQovLyAnPHNwYW4gbmctaWY9InRpdGxlIj48c3Ryb25nIG5nLWJpbmQ9InRpdGxlIj48L3N0cm9uZz4mbmJzcDs8L3NwYW4+PHNwYW4gbmctYmluZC1odG1sPSJjb250ZW50Ij48L3NwYW4+JyArCgphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAuYWxlcnQnLCBbJ21nY3JlYS5uZ1N0cmFwLm1vZGFsJ10pCgogIC5wcm92aWRlcignJGFsZXJ0JywgZnVuY3Rpb24oKSB7CgogICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgYW5pbWF0aW9uOiAnYW0tZmFkZScsCiAgICAgIHByZWZpeENsYXNzOiAnYWxlcnQnLAogICAgICBwcmVmaXhFdmVudDogJ2FsZXJ0JywKICAgICAgcGxhY2VtZW50OiBudWxsLAogICAgICB0ZW1wbGF0ZTogJ2FsZXJ0L2FsZXJ0LnRwbC5odG1sJywKICAgICAgY29udGFpbmVyOiBmYWxzZSwKICAgICAgZWxlbWVudDogbnVsbCwKICAgICAgYmFja2Ryb3A6IGZhbHNlLAogICAgICBrZXlib2FyZDogdHJ1ZSwKICAgICAgc2hvdzogdHJ1ZSwKICAgICAgLy8gU3BlY2lmaWMgb3B0aW9ucwogICAgICBkdXJhdGlvbjogZmFsc2UsCiAgICAgIHR5cGU6IGZhbHNlLAogICAgICBkaXNtaXNzYWJsZTogdHJ1ZQogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBbIiRtb2RhbCIsICIkdGltZW91dCIsIGZ1bmN0aW9uKCRtb2RhbCwgJHRpbWVvdXQpIHsKCiAgICAgIGZ1bmN0aW9uIEFsZXJ0RmFjdG9yeShjb25maWcpIHsKCiAgICAgICAgdmFyICRhbGVydCA9IHt9OwoKICAgICAgICAvLyBDb21tb24gdmFycwogICAgICAgIHZhciBvcHRpb25zID0gYW5ndWxhci5leHRlbmQoe30sIGRlZmF1bHRzLCBjb25maWcpOwoKICAgICAgICAkYWxlcnQgPSAkbW9kYWwob3B0aW9ucyk7CgogICAgICAgIC8vIFN1cHBvcnQgc2NvcGUgYXMgc3RyaW5nIG9wdGlvbnMgWy8qdGl0bGUsIGNvbnRlbnQsICovIHR5cGUsIGRpc21pc3NhYmxlXQogICAgICAgICRhbGVydC4kc2NvcGUuZGlzbWlzc2FibGUgPSAhIW9wdGlvbnMuZGlzbWlzc2FibGU7CiAgICAgICAgaWYob3B0aW9ucy50eXBlKSB7CiAgICAgICAgICAkYWxlcnQuJHNjb3BlLnR5cGUgPSBvcHRpb25zLnR5cGU7CiAgICAgICAgfQoKICAgICAgICAvLyBTdXBwb3J0IGF1dG8tY2xvc2UgZHVyYXRpb24KICAgICAgICB2YXIgc2hvdyA9ICRhbGVydC5zaG93OwogICAgICAgIGlmKG9wdGlvbnMuZHVyYXRpb24pIHsKICAgICAgICAgICRhbGVydC5zaG93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNob3coKTsKICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgJGFsZXJ0LmhpZGUoKTsKICAgICAgICAgICAgfSwgb3B0aW9ucy5kdXJhdGlvbiAqIDEwMDApOwogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkYWxlcnQ7CgogICAgICB9CgogICAgICByZXR1cm4gQWxlcnRGYWN0b3J5OwoKICAgIH1dOwoKICB9KQoKICAuZGlyZWN0aXZlKCdic0FsZXJ0JywgWyIkd2luZG93IiwgIiRzY2UiLCAiJGFsZXJ0IiwgZnVuY3Rpb24oJHdpbmRvdywgJHNjZSwgJGFsZXJ0KSB7CgogICAgdmFyIHJlcXVlc3RBbmltYXRpb25GcmFtZSA9ICR3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8ICR3aW5kb3cuc2V0VGltZW91dDsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0VBQycsCiAgICAgIHNjb3BlOiB0cnVlLAogICAgICBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgZWxlbWVudCwgYXR0ciwgdHJhbnNjbHVzaW9uKSB7CgogICAgICAgIC8vIERpcmVjdGl2ZSBvcHRpb25zCiAgICAgICAgdmFyIG9wdGlvbnMgPSB7c2NvcGU6IHNjb3BlLCBlbGVtZW50OiBlbGVtZW50LCBzaG93OiBmYWxzZX07CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsndGVtcGxhdGUnLCAncGxhY2VtZW50JywgJ2tleWJvYXJkJywgJ2h0bWwnLCAnY29udGFpbmVyJywgJ2FuaW1hdGlvbicsICdkdXJhdGlvbicsICdkaXNtaXNzYWJsZSddLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNEZWZpbmVkKGF0dHJba2V5XSkpIG9wdGlvbnNba2V5XSA9IGF0dHJba2V5XTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gU3VwcG9ydCBzY29wZSBhcyBkYXRhLWF0dHJzCiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsndGl0bGUnLCAnY29udGVudCcsICd0eXBlJ10sIGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgYXR0cltrZXldICYmIGF0dHIuJG9ic2VydmUoa2V5LCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgc2NvcGVba2V5XSA9ICRzY2UudHJ1c3RBc0h0bWwobmV3VmFsdWUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIFN1cHBvcnQgc2NvcGUgYXMgYW4gb2JqZWN0CiAgICAgICAgYXR0ci5ic0FsZXJ0ICYmIHNjb3BlLiR3YXRjaChhdHRyLmJzQWxlcnQsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgaWYoYW5ndWxhci5pc09iamVjdChuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgYW5ndWxhci5leHRlbmQoc2NvcGUsIG5ld1ZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNjb3BlLmNvbnRlbnQgPSBuZXdWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9LCB0cnVlKTsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSBhbGVydAogICAgICAgIHZhciBhbGVydCA9ICRhbGVydChvcHRpb25zKTsKCiAgICAgICAgLy8gVHJpZ2dlcgogICAgICAgIGVsZW1lbnQub24oYXR0ci50cmlnZ2VyIHx8ICdjbGljaycsIGFsZXJ0LnRvZ2dsZSk7CgogICAgICAgIC8vIEdhcmJhZ2UgY29sbGVjdGlvbgogICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChhbGVydCkgYWxlcnQuZGVzdHJveSgpOwogICAgICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICAgICAgICBhbGVydCA9IG51bGw7CiAgICAgICAgfSk7CgogICAgICB9CiAgICB9OwoKICB9XSk7CgovLyBTb3VyY2U6IGFmZml4LmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5hZmZpeCcsIFsnbWdjcmVhLm5nU3RyYXAuaGVscGVycy5kaW1lbnNpb25zJywgJ21nY3JlYS5uZ1N0cmFwLmhlbHBlcnMuZGVib3VuY2UnXSkKCiAgLnByb3ZpZGVyKCckYWZmaXgnLCBmdW5jdGlvbigpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICBvZmZzZXRUb3A6ICdhdXRvJwogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBbIiR3aW5kb3ciLCAiZGVib3VuY2UiLCAiZGltZW5zaW9ucyIsIGZ1bmN0aW9uKCR3aW5kb3csIGRlYm91bmNlLCBkaW1lbnNpb25zKSB7CgogICAgICB2YXIgYm9keUVsID0gYW5ndWxhci5lbGVtZW50KCR3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgIHZhciB3aW5kb3dFbCA9IGFuZ3VsYXIuZWxlbWVudCgkd2luZG93KTsKCiAgICAgIGZ1bmN0aW9uIEFmZml4RmFjdG9yeShlbGVtZW50LCBjb25maWcpIHsKCiAgICAgICAgdmFyICRhZmZpeCA9IHt9OwoKICAgICAgICAvLyBDb21tb24gdmFycwogICAgICAgIHZhciBvcHRpb25zID0gYW5ndWxhci5leHRlbmQoe30sIGRlZmF1bHRzLCBjb25maWcpOwogICAgICAgIHZhciB0YXJnZXRFbCA9IG9wdGlvbnMudGFyZ2V0OwoKICAgICAgICAvLyBJbml0aWFsIHByaXZhdGUgdmFycwogICAgICAgIHZhciByZXNldCA9ICdhZmZpeCBhZmZpeC10b3AgYWZmaXgtYm90dG9tJywKICAgICAgICAgICAgaW5pdGlhbEFmZml4VG9wID0gMCwKICAgICAgICAgICAgaW5pdGlhbE9mZnNldFRvcCA9IDAsCiAgICAgICAgICAgIG9mZnNldFRvcCA9IDAsCiAgICAgICAgICAgIG9mZnNldEJvdHRvbSA9IDAsCiAgICAgICAgICAgIGFmZml4ZWQgPSBudWxsLAogICAgICAgICAgICB1bnBpbiA9IG51bGw7CgogICAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudCgpOwogICAgICAgIC8vIE9wdGlvbnM6IGN1c3RvbSBwYXJlbnQKICAgICAgICBpZiAob3B0aW9ucy5vZmZzZXRQYXJlbnQpIHsKICAgICAgICAgIGlmIChvcHRpb25zLm9mZnNldFBhcmVudC5tYXRjaCgvXlxkKyQvKSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IChvcHRpb25zLm9mZnNldFBhcmVudCAqIDEpIC0gMTsgaSsrKSB7CiAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcGFyZW50ID0gYW5ndWxhci5lbGVtZW50KG9wdGlvbnMub2Zmc2V0UGFyZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgICRhZmZpeC5pbml0ID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgJGFmZml4LiRwYXJzZU9mZnNldHMoKTsKICAgICAgICAgIGluaXRpYWxPZmZzZXRUb3AgPSBkaW1lbnNpb25zLm9mZnNldChlbGVtZW50WzBdKS50b3AgKyBpbml0aWFsQWZmaXhUb3A7CgogICAgICAgICAgLy8gQmluZCBldmVudHMKICAgICAgICAgIHRhcmdldEVsLm9uKCdzY3JvbGwnLCAkYWZmaXguY2hlY2tQb3NpdGlvbik7CiAgICAgICAgICB0YXJnZXRFbC5vbignY2xpY2snLCAkYWZmaXguY2hlY2tQb3NpdGlvbldpdGhFdmVudExvb3ApOwogICAgICAgICAgd2luZG93RWwub24oJ3Jlc2l6ZScsICRhZmZpeC4kZGVib3VuY2VkT25SZXNpemUpOwoKICAgICAgICAgIC8vIEJvdGggb2YgdGhlc2UgY2hlY2tQb3NpdGlvbigpIGNhbGxzIGFyZSBuZWNlc3NhcnkgZm9yIHRoZSBjYXNlIHdoZXJlCiAgICAgICAgICAvLyB0aGUgdXNlciBoaXRzIHJlZnJlc2ggYWZ0ZXIgc2Nyb2xsaW5nIHRvIHRoZSBib3R0b20gb2YgdGhlIHBhZ2UuCiAgICAgICAgICAkYWZmaXguY2hlY2tQb3NpdGlvbigpOwogICAgICAgICAgJGFmZml4LmNoZWNrUG9zaXRpb25XaXRoRXZlbnRMb29wKCk7CgogICAgICAgIH07CgogICAgICAgICRhZmZpeC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgLy8gVW5iaW5kIGV2ZW50cwogICAgICAgICAgdGFyZ2V0RWwub2ZmKCdzY3JvbGwnLCAkYWZmaXguY2hlY2tQb3NpdGlvbik7CiAgICAgICAgICB0YXJnZXRFbC5vZmYoJ2NsaWNrJywgJGFmZml4LmNoZWNrUG9zaXRpb25XaXRoRXZlbnRMb29wKTsKICAgICAgICAgIHdpbmRvd0VsLm9mZigncmVzaXplJywgJGFmZml4LiRkZWJvdW5jZWRPblJlc2l6ZSk7CgogICAgICAgIH07CgogICAgICAgICRhZmZpeC5jaGVja1Bvc2l0aW9uV2l0aEV2ZW50TG9vcCA9IGZ1bmN0aW9uKCkgewoKICAgICAgICAgIHNldFRpbWVvdXQoJGFmZml4LmNoZWNrUG9zaXRpb24sIDEpOwoKICAgICAgICB9OwoKICAgICAgICAkYWZmaXguY2hlY2tQb3NpdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gaWYgKCF0aGlzLiRlbGVtZW50LmlzKCc6dmlzaWJsZScpKSByZXR1cm4KCiAgICAgICAgICB2YXIgc2Nyb2xsVG9wID0gZ2V0U2Nyb2xsVG9wKCk7CiAgICAgICAgICB2YXIgcG9zaXRpb24gPSBkaW1lbnNpb25zLm9mZnNldChlbGVtZW50WzBdKTsKICAgICAgICAgIHZhciBlbGVtZW50SGVpZ2h0ID0gZGltZW5zaW9ucy5oZWlnaHQoZWxlbWVudFswXSk7CgogICAgICAgICAgLy8gR2V0IHJlcXVpcmVkIGFmZml4IGNsYXNzIGFjY29yZGluZyB0byBwb3NpdGlvbgogICAgICAgICAgdmFyIGFmZml4ID0gZ2V0UmVxdWlyZWRBZmZpeENsYXNzKHVucGluLCBwb3NpdGlvbiwgZWxlbWVudEhlaWdodCk7CgogICAgICAgICAgLy8gRGlkIGFmZml4IHN0YXR1cyBjaGFuZ2VkIHRoaXMgbGFzdCBjaGVjaz8KICAgICAgICAgIGlmKGFmZml4ZWQgPT09IGFmZml4KSByZXR1cm47CiAgICAgICAgICBhZmZpeGVkID0gYWZmaXg7CgogICAgICAgICAgLy8gQWRkIHByb3BlciBhZmZpeCBjbGFzcwogICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhyZXNldCkuYWRkQ2xhc3MoJ2FmZml4JyArICgoYWZmaXggIT09ICdtaWRkbGUnKSA/ICctJyArIGFmZml4IDogJycpKTsKCiAgICAgICAgICBpZihhZmZpeCA9PT0gJ3RvcCcpIHsKICAgICAgICAgICAgdW5waW4gPSBudWxsOwogICAgICAgICAgICBlbGVtZW50LmNzcygncG9zaXRpb24nLCAob3B0aW9ucy5vZmZzZXRQYXJlbnQpID8gJycgOiAncmVsYXRpdmUnKTsKICAgICAgICAgICAgZWxlbWVudC5jc3MoJ3RvcCcsICcnKTsKICAgICAgICAgIH0gZWxzZSBpZihhZmZpeCA9PT0gJ2JvdHRvbScpIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMub2Zmc2V0VW5waW4pIHsKICAgICAgICAgICAgICB1bnBpbiA9IC0ob3B0aW9ucy5vZmZzZXRVbnBpbiAqIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSB1bnBpbiB0aHJlc2hvbGQgd2hlbiBhZmZpeGVkIHRvIGJvdHRvbS4KICAgICAgICAgICAgICAvLyBIb3BlZnVsbHkgdGhlIGJyb3dzZXIgc2Nyb2xscyBwaXhlbCBieSBwaXhlbC4KICAgICAgICAgICAgICB1bnBpbiA9IHBvc2l0aW9uLnRvcCAtIHNjcm9sbFRvcDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50LmNzcygncG9zaXRpb24nLCAob3B0aW9ucy5vZmZzZXRQYXJlbnQpID8gJycgOiAncmVsYXRpdmUnKTsKICAgICAgICAgICAgZWxlbWVudC5jc3MoJ3RvcCcsIChvcHRpb25zLm9mZnNldFBhcmVudCkgPyAnJyA6ICgoYm9keUVsWzBdLm9mZnNldEhlaWdodCAtIG9mZnNldEJvdHRvbSAtIGVsZW1lbnRIZWlnaHQgLSBpbml0aWFsT2Zmc2V0VG9wKSArICdweCcpKTsKICAgICAgICAgIH0gZWxzZSB7IC8vIGFmZml4ID09PSAnbWlkZGxlJwogICAgICAgICAgICB1bnBpbiA9IG51bGw7CiAgICAgICAgICAgIGVsZW1lbnQuY3NzKCdwb3NpdGlvbicsICdmaXhlZCcpOwogICAgICAgICAgICBlbGVtZW50LmNzcygndG9wJywgaW5pdGlhbEFmZml4VG9wICsgJ3B4Jyk7CiAgICAgICAgICB9CgogICAgICAgIH07CgogICAgICAgICRhZmZpeC4kb25SZXNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICRhZmZpeC4kcGFyc2VPZmZzZXRzKCk7CiAgICAgICAgICAkYWZmaXguY2hlY2tQb3NpdGlvbigpOwogICAgICAgIH07CiAgICAgICAgJGFmZml4LiRkZWJvdW5jZWRPblJlc2l6ZSA9IGRlYm91bmNlKCRhZmZpeC4kb25SZXNpemUsIDUwKTsKCiAgICAgICAgJGFmZml4LiRwYXJzZU9mZnNldHMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBpbml0aWFsUG9zaXRpb24gPSBlbGVtZW50LmNzcygncG9zaXRpb24nKTsKICAgICAgICAgIC8vIFJlc2V0IHBvc2l0aW9uIHRvIGNhbGN1bGF0ZSBjb3JyZWN0IG9mZnNldFRvcAogICAgICAgICAgZWxlbWVudC5jc3MoJ3Bvc2l0aW9uJywgKG9wdGlvbnMub2Zmc2V0UGFyZW50KSA/ICcnIDogJ3JlbGF0aXZlJyk7CgogICAgICAgICAgaWYob3B0aW9ucy5vZmZzZXRUb3ApIHsKICAgICAgICAgICAgaWYob3B0aW9ucy5vZmZzZXRUb3AgPT09ICdhdXRvJykgewogICAgICAgICAgICAgIG9wdGlvbnMub2Zmc2V0VG9wID0gJyswJzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLm9mZnNldFRvcC5tYXRjaCgvXlstK11cZCskLykpIHsKICAgICAgICAgICAgICBpbml0aWFsQWZmaXhUb3AgPSAtIG9wdGlvbnMub2Zmc2V0VG9wICogMTsKICAgICAgICAgICAgICBpZihvcHRpb25zLm9mZnNldFBhcmVudCkgewogICAgICAgICAgICAgICAgb2Zmc2V0VG9wID0gZGltZW5zaW9ucy5vZmZzZXQocGFyZW50WzBdKS50b3AgKyAob3B0aW9ucy5vZmZzZXRUb3AgKiAxKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBvZmZzZXRUb3AgPSBkaW1lbnNpb25zLm9mZnNldChlbGVtZW50WzBdKS50b3AgLSBkaW1lbnNpb25zLmNzcyhlbGVtZW50WzBdLCAnbWFyZ2luVG9wJywgdHJ1ZSkgKyAob3B0aW9ucy5vZmZzZXRUb3AgKiAxKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgb2Zmc2V0VG9wID0gb3B0aW9ucy5vZmZzZXRUb3AgKiAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYob3B0aW9ucy5vZmZzZXRCb3R0b20pIHsKICAgICAgICAgICAgaWYob3B0aW9ucy5vZmZzZXRQYXJlbnQgJiYgb3B0aW9ucy5vZmZzZXRCb3R0b20ubWF0Y2goL15bLStdXGQrJC8pKSB7CiAgICAgICAgICAgICAgLy8gYWRkIDEgcGl4ZWwgZHVlIHRvIHJvdW5kaW5nIHByb2JsZW1zLi4uCiAgICAgICAgICAgICAgb2Zmc2V0Qm90dG9tID0gZ2V0U2Nyb2xsSGVpZ2h0KCkgLSAoZGltZW5zaW9ucy5vZmZzZXQocGFyZW50WzBdKS50b3AgKyBkaW1lbnNpb25zLmhlaWdodChwYXJlbnRbMF0pKSArIChvcHRpb25zLm9mZnNldEJvdHRvbSAqIDEpICsgMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBvZmZzZXRCb3R0b20gPSBvcHRpb25zLm9mZnNldEJvdHRvbSAqIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBCcmluZyBiYWNrIHRoZSBlbGVtZW50J3MgcG9zaXRpb24gYWZ0ZXIgY2FsY3VsYXRpb25zCiAgICAgICAgICBlbGVtZW50LmNzcygncG9zaXRpb24nLCBpbml0aWFsUG9zaXRpb24pOwogICAgICAgIH07CgogICAgICAgIC8vIFByaXZhdGUgbWV0aG9kcwoKICAgICAgICBmdW5jdGlvbiBnZXRSZXF1aXJlZEFmZml4Q2xhc3ModW5waW4sIHBvc2l0aW9uLCBlbGVtZW50SGVpZ2h0KSB7CgogICAgICAgICAgdmFyIHNjcm9sbFRvcCA9IGdldFNjcm9sbFRvcCgpOwogICAgICAgICAgdmFyIHNjcm9sbEhlaWdodCA9IGdldFNjcm9sbEhlaWdodCgpOwoKICAgICAgICAgIGlmKHNjcm9sbFRvcCA8PSBvZmZzZXRUb3ApIHsKICAgICAgICAgICAgcmV0dXJuICd0b3AnOwogICAgICAgICAgfSBlbHNlIGlmKHVucGluICE9PSBudWxsICYmIChzY3JvbGxUb3AgKyB1bnBpbiA8PSBwb3NpdGlvbi50b3ApKSB7CiAgICAgICAgICAgIHJldHVybiAnbWlkZGxlJzsKICAgICAgICAgIH0gZWxzZSBpZihvZmZzZXRCb3R0b20gIT09IG51bGwgJiYgKHBvc2l0aW9uLnRvcCArIGVsZW1lbnRIZWlnaHQgKyBpbml0aWFsQWZmaXhUb3AgPj0gc2Nyb2xsSGVpZ2h0IC0gb2Zmc2V0Qm90dG9tKSkgewogICAgICAgICAgICByZXR1cm4gJ2JvdHRvbSc7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gJ21pZGRsZSc7CiAgICAgICAgICB9CgogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0U2Nyb2xsVG9wKCkgewogICAgICAgICAgcmV0dXJuIHRhcmdldEVsWzBdID09PSAkd2luZG93ID8gJHdpbmRvdy5wYWdlWU9mZnNldCA6IHRhcmdldEVsWzBdLnNjcm9sbFRvcDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldFNjcm9sbEhlaWdodCgpIHsKICAgICAgICAgIHJldHVybiB0YXJnZXRFbFswXSA9PT0gJHdpbmRvdyA/ICR3aW5kb3cuZG9jdW1lbnQuYm9keS5zY3JvbGxIZWlnaHQgOiB0YXJnZXRFbFswXS5zY3JvbGxIZWlnaHQ7CiAgICAgICAgfQoKICAgICAgICAkYWZmaXguaW5pdCgpOwogICAgICAgIHJldHVybiAkYWZmaXg7CgogICAgICB9CgogICAgICByZXR1cm4gQWZmaXhGYWN0b3J5OwoKICAgIH1dOwoKICB9KQoKICAuZGlyZWN0aXZlKCdic0FmZml4JywgWyIkYWZmaXgiLCAiJHdpbmRvdyIsIGZ1bmN0aW9uKCRhZmZpeCwgJHdpbmRvdykgewoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRUFDJywKICAgICAgcmVxdWlyZTogJ14/YnNBZmZpeFRhcmdldCcsCiAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBhZmZpeFRhcmdldCkgewoKICAgICAgICB2YXIgb3B0aW9ucyA9IHtzY29wZTogc2NvcGUsIG9mZnNldFRvcDogJ2F1dG8nLCB0YXJnZXQ6IGFmZml4VGFyZ2V0ID8gYWZmaXhUYXJnZXQuJGVsZW1lbnQgOiBhbmd1bGFyLmVsZW1lbnQoJHdpbmRvdyl9OwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ29mZnNldFRvcCcsICdvZmZzZXRCb3R0b20nLCAnb2Zmc2V0UGFyZW50JywgJ29mZnNldFVucGluJ10sIGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgaWYoYW5ndWxhci5pc0RlZmluZWQoYXR0cltrZXldKSkgb3B0aW9uc1trZXldID0gYXR0cltrZXldOwogICAgICAgIH0pOwoKICAgICAgICB2YXIgYWZmaXggPSAkYWZmaXgoZWxlbWVudCwgb3B0aW9ucyk7CiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgYWZmaXggJiYgYWZmaXguZGVzdHJveSgpOwogICAgICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICAgICAgICBhZmZpeCA9IG51bGw7CiAgICAgICAgfSk7CgogICAgICB9CiAgICB9OwoKICB9XSkKCiAgLmRpcmVjdGl2ZSgnYnNBZmZpeFRhcmdldCcsIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgY29udHJvbGxlcjogWyIkZWxlbWVudCIsIGZ1bmN0aW9uKCRlbGVtZW50KSB7CiAgICAgICAgdGhpcy4kZWxlbWVudCA9ICRlbGVtZW50OwogICAgICB9XQogICAgfTsKICB9KTsKCi8vIFNvdXJjZTogYXNpZGUuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLmFzaWRlJywgWydtZ2NyZWEubmdTdHJhcC5tb2RhbCddKQoKICAucHJvdmlkZXIoJyRhc2lkZScsIGZ1bmN0aW9uKCkgewoKICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgIGFuaW1hdGlvbjogJ2FtLWZhZGUtYW5kLXNsaWRlLXJpZ2h0JywKICAgICAgcHJlZml4Q2xhc3M6ICdhc2lkZScsCiAgICAgIHByZWZpeEV2ZW50OiAnYXNpZGUnLAogICAgICBwbGFjZW1lbnQ6ICdyaWdodCcsCiAgICAgIHRlbXBsYXRlOiAnYXNpZGUvYXNpZGUudHBsLmh0bWwnLAogICAgICBjb250ZW50VGVtcGxhdGU6IGZhbHNlLAogICAgICBjb250YWluZXI6IGZhbHNlLAogICAgICBlbGVtZW50OiBudWxsLAogICAgICBiYWNrZHJvcDogdHJ1ZSwKICAgICAga2V5Ym9hcmQ6IHRydWUsCiAgICAgIGh0bWw6IGZhbHNlLAogICAgICBzaG93OiB0cnVlCiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsiJG1vZGFsIiwgZnVuY3Rpb24oJG1vZGFsKSB7CgogICAgICBmdW5jdGlvbiBBc2lkZUZhY3RvcnkoY29uZmlnKSB7CgogICAgICAgIHZhciAkYXNpZGUgPSB7fTsKCiAgICAgICAgLy8gQ29tbW9uIHZhcnMKICAgICAgICB2YXIgb3B0aW9ucyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBkZWZhdWx0cywgY29uZmlnKTsKCiAgICAgICAgJGFzaWRlID0gJG1vZGFsKG9wdGlvbnMpOwoKICAgICAgICByZXR1cm4gJGFzaWRlOwoKICAgICAgfQoKICAgICAgcmV0dXJuIEFzaWRlRmFjdG9yeTsKCiAgICB9XTsKCiAgfSkKCiAgLmRpcmVjdGl2ZSgnYnNBc2lkZScsIFsiJHdpbmRvdyIsICIkc2NlIiwgIiRhc2lkZSIsIGZ1bmN0aW9uKCR3aW5kb3csICRzY2UsICRhc2lkZSkgewoKICAgIHZhciByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSAkd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCAkd2luZG93LnNldFRpbWVvdXQ7CgogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFQUMnLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIHRyYW5zY2x1c2lvbikgewogICAgICAgIC8vIERpcmVjdGl2ZSBvcHRpb25zCiAgICAgICAgdmFyIG9wdGlvbnMgPSB7c2NvcGU6IHNjb3BlLCBlbGVtZW50OiBlbGVtZW50LCBzaG93OiBmYWxzZX07CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsndGVtcGxhdGUnLCAnY29udGVudFRlbXBsYXRlJywgJ3BsYWNlbWVudCcsICdiYWNrZHJvcCcsICdrZXlib2FyZCcsICdodG1sJywgJ2NvbnRhaW5lcicsICdhbmltYXRpb24nXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzRGVmaW5lZChhdHRyW2tleV0pKSBvcHRpb25zW2tleV0gPSBhdHRyW2tleV07CiAgICAgICAgfSk7CgogICAgICAgIC8vIFN1cHBvcnQgc2NvcGUgYXMgZGF0YS1hdHRycwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ3RpdGxlJywgJ2NvbnRlbnQnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBhdHRyW2tleV0gJiYgYXR0ci4kb2JzZXJ2ZShrZXksIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICBzY29wZVtrZXldID0gJHNjZS50cnVzdEFzSHRtbChuZXdWYWx1ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gU3VwcG9ydCBzY29wZSBhcyBhbiBvYmplY3QKICAgICAgICBhdHRyLmJzQXNpZGUgJiYgc2NvcGUuJHdhdGNoKGF0dHIuYnNBc2lkZSwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzT2JqZWN0KG5ld1ZhbHVlKSkgewogICAgICAgICAgICBhbmd1bGFyLmV4dGVuZChzY29wZSwgbmV3VmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2NvcGUuY29udGVudCA9IG5ld1ZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0sIHRydWUpOwoKICAgICAgICAvLyBJbml0aWFsaXplIGFzaWRlCiAgICAgICAgdmFyIGFzaWRlID0gJGFzaWRlKG9wdGlvbnMpOwoKICAgICAgICAvLyBUcmlnZ2VyCiAgICAgICAgZWxlbWVudC5vbihhdHRyLnRyaWdnZXIgfHwgJ2NsaWNrJywgYXNpZGUudG9nZ2xlKTsKCiAgICAgICAgLy8gR2FyYmFnZSBjb2xsZWN0aW9uCiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKGFzaWRlKSBhc2lkZS5kZXN0cm95KCk7CiAgICAgICAgICBvcHRpb25zID0gbnVsbDsKICAgICAgICAgIGFzaWRlID0gbnVsbDsKICAgICAgICB9KTsKCiAgICAgIH0KICAgIH07CgogIH1dKTsKCi8vIFNvdXJjZTogYnV0dG9uLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5idXR0b24nLCBbXSkKCiAgLnByb3ZpZGVyKCckYnV0dG9uJywgZnVuY3Rpb24oKSB7CgogICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgYWN0aXZlQ2xhc3M6J2FjdGl2ZScsCiAgICAgIHRvZ2dsZUV2ZW50OidjbGljaycKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7ZGVmYXVsdHM6IGRlZmF1bHRzfTsKICAgIH07CgogIH0pCgogIC5kaXJlY3RpdmUoJ2JzQ2hlY2tib3hHcm91cCcsIGZ1bmN0aW9uKCkgewoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgIHJlcXVpcmU6ICduZ01vZGVsJywKICAgICAgY29tcGlsZTogZnVuY3Rpb24gcG9zdExpbmsoZWxlbWVudCwgYXR0cikgewogICAgICAgIGVsZW1lbnQuYXR0cignZGF0YS10b2dnbGUnLCAnYnV0dG9ucycpOwogICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cignbmctbW9kZWwnKTsKICAgICAgICB2YXIgY2hpbGRyZW4gPSBlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3JBbGwoJ2lucHV0W3R5cGU9ImNoZWNrYm94Il0nKTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICB2YXIgY2hpbGRFbCA9IGFuZ3VsYXIuZWxlbWVudChjaGlsZCk7CiAgICAgICAgICBjaGlsZEVsLmF0dHIoJ2JzLWNoZWNrYm94JywgJycpOwogICAgICAgICAgY2hpbGRFbC5hdHRyKCduZy1tb2RlbCcsIGF0dHIubmdNb2RlbCArICcuJyArIGNoaWxkRWwuYXR0cigndmFsdWUnKSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICB9OwoKICB9KQoKICAuZGlyZWN0aXZlKCdic0NoZWNrYm94JywgWyIkYnV0dG9uIiwgIiQkckFGIiwgZnVuY3Rpb24oJGJ1dHRvbiwgJCRyQUYpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSAkYnV0dG9uLmRlZmF1bHRzOwogICAgdmFyIGNvbnN0YW50VmFsdWVSZWdFeHAgPSAvXih0cnVlfGZhbHNlfFxkKykkLzsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0EnLAogICAgICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjb250cm9sbGVyKSB7CgogICAgICAgIHZhciBvcHRpb25zID0gZGVmYXVsdHM7CgogICAgICAgIC8vIFN1cHBvcnQgbGFiZWwgPiBpbnB1dFt0eXBlPSJjaGVja2JveCJdCiAgICAgICAgdmFyIGlzSW5wdXQgPSBlbGVtZW50WzBdLm5vZGVOYW1lID09PSAnSU5QVVQnOwogICAgICAgIHZhciBhY3RpdmVFbGVtZW50ID0gaXNJbnB1dCA/IGVsZW1lbnQucGFyZW50KCkgOiBlbGVtZW50OwoKICAgICAgICB2YXIgdHJ1ZVZhbHVlID0gYW5ndWxhci5pc0RlZmluZWQoYXR0ci50cnVlVmFsdWUpID8gYXR0ci50cnVlVmFsdWUgOiB0cnVlOwogICAgICAgIGlmKGNvbnN0YW50VmFsdWVSZWdFeHAudGVzdChhdHRyLnRydWVWYWx1ZSkpIHsKICAgICAgICAgIHRydWVWYWx1ZSA9IHNjb3BlLiRldmFsKGF0dHIudHJ1ZVZhbHVlKTsKICAgICAgICB9CiAgICAgICAgdmFyIGZhbHNlVmFsdWUgPSBhbmd1bGFyLmlzRGVmaW5lZChhdHRyLmZhbHNlVmFsdWUpID8gYXR0ci5mYWxzZVZhbHVlIDogZmFsc2U7CiAgICAgICAgaWYoY29uc3RhbnRWYWx1ZVJlZ0V4cC50ZXN0KGF0dHIuZmFsc2VWYWx1ZSkpIHsKICAgICAgICAgIGZhbHNlVmFsdWUgPSBzY29wZS4kZXZhbChhdHRyLmZhbHNlVmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgLy8gUGFyc2UgZXhvdGljIHZhbHVlcwogICAgICAgIHZhciBoYXNFeG90aWNWYWx1ZXMgPSB0eXBlb2YgdHJ1ZVZhbHVlICE9PSAnYm9vbGVhbicgfHwgdHlwZW9mIGZhbHNlVmFsdWUgIT09ICdib29sZWFuJzsKICAgICAgICBpZihoYXNFeG90aWNWYWx1ZXMpIHsKICAgICAgICAgIGNvbnRyb2xsZXIuJHBhcnNlcnMucHVzaChmdW5jdGlvbih2aWV3VmFsdWUpIHsKICAgICAgICAgICAgLy8gY29uc29sZS53YXJuKCckcGFyc2VyJywgZWxlbWVudC5hdHRyKCduZy1tb2RlbCcpLCAndmlld1ZhbHVlJywgdmlld1ZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHZpZXdWYWx1ZSA/IHRydWVWYWx1ZSA6IGZhbHNlVmFsdWU7CiAgICAgICAgICB9KTsKICAgICAgICAgIC8vIG1vZGVsVmFsdWUgLT4gJGZvcm1hdHRlcnMgLT4gdmlld1ZhbHVlCiAgICAgICAgICBjb250cm9sbGVyLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24obW9kZWxWYWx1ZSkgewogICAgICAgICAgICAgLy8gY29uc29sZS53YXJuKCckZm9ybWF0dGVyKCIlcyIpOiBtb2RlbFZhbHVlPSVvICglbyknLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksIG1vZGVsVmFsdWUsIHR5cGVvZiBtb2RlbFZhbHVlKTsKICAgICAgICAgICAgIHJldHVybiBhbmd1bGFyLmVxdWFscyhtb2RlbFZhbHVlLCB0cnVlVmFsdWUpOwogICAgICAgICAgfSk7CiAgICAgICAgICAvLyBGaXggcmVuZGVyaW5nIGZvciBleG90aWMgdmFsdWVzCiAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ01vZGVsLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgY29udHJvbGxlci4kcmVuZGVyKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIG1vZGVsIC0+IHZpZXcKICAgICAgICBjb250cm9sbGVyLiRyZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRyZW5kZXInLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksICdjb250cm9sbGVyLiRtb2RlbFZhbHVlJywgdHlwZW9mIGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUsIGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUsICdjb250cm9sbGVyLiR2aWV3VmFsdWUnLCB0eXBlb2YgY29udHJvbGxlci4kdmlld1ZhbHVlLCBjb250cm9sbGVyLiR2aWV3VmFsdWUpOwogICAgICAgICAgdmFyIGlzQWN0aXZlID0gYW5ndWxhci5lcXVhbHMoY29udHJvbGxlci4kbW9kZWxWYWx1ZSwgdHJ1ZVZhbHVlKTsKICAgICAgICAgICQkckFGKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZihpc0lucHV0KSBlbGVtZW50WzBdLmNoZWNrZWQgPSBpc0FjdGl2ZTsKICAgICAgICAgICAgYWN0aXZlRWxlbWVudC50b2dnbGVDbGFzcyhvcHRpb25zLmFjdGl2ZUNsYXNzLCBpc0FjdGl2ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICAvLyB2aWV3IC0+IG1vZGVsCiAgICAgICAgZWxlbWVudC5iaW5kKG9wdGlvbnMudG9nZ2xlRXZlbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy8gY29uc29sZS53YXJuKCchY2xpY2snLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksICdjb250cm9sbGVyLiR2aWV3VmFsdWUnLCB0eXBlb2YgY29udHJvbGxlci4kdmlld1ZhbHVlLCBjb250cm9sbGVyLiR2aWV3VmFsdWUsICdjb250cm9sbGVyLiRtb2RlbFZhbHVlJywgdHlwZW9mIGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUsIGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUpOwogICAgICAgICAgICBpZighaXNJbnB1dCkgewogICAgICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZpZXdWYWx1ZSghYWN0aXZlRWxlbWVudC5oYXNDbGFzcygnYWN0aXZlJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFoYXNFeG90aWNWYWx1ZXMpIHsKICAgICAgICAgICAgICBjb250cm9sbGVyLiRyZW5kZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICB9CgogICAgfTsKCiAgfV0pCgogIC5kaXJlY3RpdmUoJ2JzUmFkaW9Hcm91cCcsIGZ1bmN0aW9uKCkgewoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgIHJlcXVpcmU6ICduZ01vZGVsJywKICAgICAgY29tcGlsZTogZnVuY3Rpb24gcG9zdExpbmsoZWxlbWVudCwgYXR0cikgewogICAgICAgIGVsZW1lbnQuYXR0cignZGF0YS10b2dnbGUnLCAnYnV0dG9ucycpOwogICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cignbmctbW9kZWwnKTsKICAgICAgICB2YXIgY2hpbGRyZW4gPSBlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3JBbGwoJ2lucHV0W3R5cGU9InJhZGlvIl0nKTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoY2hpbGQpLmF0dHIoJ2JzLXJhZGlvJywgJycpOwogICAgICAgICAgYW5ndWxhci5lbGVtZW50KGNoaWxkKS5hdHRyKCduZy1tb2RlbCcsIGF0dHIubmdNb2RlbCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICB9OwoKICB9KQoKICAuZGlyZWN0aXZlKCdic1JhZGlvJywgWyIkYnV0dG9uIiwgIiQkckFGIiwgZnVuY3Rpb24oJGJ1dHRvbiwgJCRyQUYpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSAkYnV0dG9uLmRlZmF1bHRzOwogICAgdmFyIGNvbnN0YW50VmFsdWVSZWdFeHAgPSAvXih0cnVlfGZhbHNlfFxkKykkLzsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0EnLAogICAgICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjb250cm9sbGVyKSB7CgogICAgICAgIHZhciBvcHRpb25zID0gZGVmYXVsdHM7CgogICAgICAgIC8vIFN1cHBvcnQgYGxhYmVsID4gaW5wdXRbdHlwZT0icmFkaW8iXWAgbWFya3VwCiAgICAgICAgdmFyIGlzSW5wdXQgPSBlbGVtZW50WzBdLm5vZGVOYW1lID09PSAnSU5QVVQnOwogICAgICAgIHZhciBhY3RpdmVFbGVtZW50ID0gaXNJbnB1dCA/IGVsZW1lbnQucGFyZW50KCkgOiBlbGVtZW50OwoKICAgICAgICB2YXIgdmFsdWUgPSBjb25zdGFudFZhbHVlUmVnRXhwLnRlc3QoYXR0ci52YWx1ZSkgPyBzY29wZS4kZXZhbChhdHRyLnZhbHVlKSA6IGF0dHIudmFsdWU7CgogICAgICAgIC8vIG1vZGVsIC0+IHZpZXcKICAgICAgICBjb250cm9sbGVyLiRyZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRyZW5kZXInLCBlbGVtZW50LmF0dHIoJ3ZhbHVlJyksICdjb250cm9sbGVyLiRtb2RlbFZhbHVlJywgdHlwZW9mIGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUsIGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUsICdjb250cm9sbGVyLiR2aWV3VmFsdWUnLCB0eXBlb2YgY29udHJvbGxlci4kdmlld1ZhbHVlLCBjb250cm9sbGVyLiR2aWV3VmFsdWUpOwogICAgICAgICAgdmFyIGlzQWN0aXZlID0gYW5ndWxhci5lcXVhbHMoY29udHJvbGxlci4kbW9kZWxWYWx1ZSwgdmFsdWUpOwogICAgICAgICAgJCRyQUYoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKGlzSW5wdXQpIGVsZW1lbnRbMF0uY2hlY2tlZCA9IGlzQWN0aXZlOwogICAgICAgICAgICBhY3RpdmVFbGVtZW50LnRvZ2dsZUNsYXNzKG9wdGlvbnMuYWN0aXZlQ2xhc3MsIGlzQWN0aXZlKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIC8vIHZpZXcgLT4gbW9kZWwKICAgICAgICBlbGVtZW50LmJpbmQob3B0aW9ucy50b2dnbGVFdmVudCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyFjbGljaycsIGVsZW1lbnQuYXR0cigndmFsdWUnKSwgJ2NvbnRyb2xsZXIuJHZpZXdWYWx1ZScsIHR5cGVvZiBjb250cm9sbGVyLiR2aWV3VmFsdWUsIGNvbnRyb2xsZXIuJHZpZXdWYWx1ZSwgJ2NvbnRyb2xsZXIuJG1vZGVsVmFsdWUnLCB0eXBlb2YgY29udHJvbGxlci4kbW9kZWxWYWx1ZSwgY29udHJvbGxlci4kbW9kZWxWYWx1ZSk7CiAgICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZpZXdWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIGNvbnRyb2xsZXIuJHJlbmRlcigpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICB9CgogICAgfTsKCiAgfV0pOwoKLy8gU291cmNlOiBjb2xsYXBzZS5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAuY29sbGFwc2UnLCBbXSkKCiAgLnByb3ZpZGVyKCckY29sbGFwc2UnLCBmdW5jdGlvbigpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICBhbmltYXRpb246ICdhbS1jb2xsYXBzZScsCiAgICAgIGRpc2FsbG93VG9nZ2xlOiBmYWxzZSwKICAgICAgYWN0aXZlQ2xhc3M6ICdpbicsCiAgICAgIHN0YXJ0Q29sbGFwc2VkOiBmYWxzZQogICAgfTsKCiAgICB2YXIgY29udHJvbGxlciA9IHRoaXMuY29udHJvbGxlciA9IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAvLyBBdHRyaWJ1dGVzIG9wdGlvbnMKICAgICAgc2VsZi4kb3B0aW9ucyA9IGFuZ3VsYXIuY29weShkZWZhdWx0cyk7CiAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ2FuaW1hdGlvbicsICdkaXNhbGxvd1RvZ2dsZScsICdhY3RpdmVDbGFzcycsICdzdGFydENvbGxhcHNlZCddLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgaWYoYW5ndWxhci5pc0RlZmluZWQoJGF0dHJzW2tleV0pKSBzZWxmLiRvcHRpb25zW2tleV0gPSAkYXR0cnNba2V5XTsKICAgICAgfSk7CgogICAgICBzZWxmLiR0b2dnbGVzID0gW107CiAgICAgIHNlbGYuJHRhcmdldHMgPSBbXTsKCiAgICAgIHNlbGYuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMgPSBbXTsKCiAgICAgIHNlbGYuJHJlZ2lzdGVyVG9nZ2xlID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHNlbGYuJHRvZ2dsZXMucHVzaChlbGVtZW50KTsKICAgICAgfTsKICAgICAgc2VsZi4kcmVnaXN0ZXJUYXJnZXQgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgc2VsZi4kdGFyZ2V0cy5wdXNoKGVsZW1lbnQpOwogICAgICB9OwoKICAgICAgc2VsZi4kdGFyZ2V0cy4kYWN0aXZlID0gIXNlbGYuJG9wdGlvbnMuc3RhcnRDb2xsYXBzZWQgPyAwIDogLTE7CiAgICAgIHNlbGYuJHNldEFjdGl2ZSA9ICRzY29wZS4kc2V0QWN0aXZlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZighc2VsZi4kb3B0aW9ucy5kaXNhbGxvd1RvZ2dsZSkgewogICAgICAgICAgc2VsZi4kdGFyZ2V0cy4kYWN0aXZlID0gc2VsZi4kdGFyZ2V0cy4kYWN0aXZlID09PSB2YWx1ZSA/IC0xIDogdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYuJHRhcmdldHMuJGFjdGl2ZSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICBzZWxmLiR2aWV3Q2hhbmdlTGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24oZm4pIHsKICAgICAgICAgIGZuKCk7CiAgICAgICAgfSk7CiAgICAgIH07CgogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyICRjb2xsYXBzZSA9IHt9OwogICAgICAkY29sbGFwc2UuZGVmYXVsdHMgPSBkZWZhdWx0czsKICAgICAgJGNvbGxhcHNlLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyOwogICAgICByZXR1cm4gJGNvbGxhcHNlOwogICAgfTsKCiAgfSkKCiAgLmRpcmVjdGl2ZSgnYnNDb2xsYXBzZScsIFsiJHdpbmRvdyIsICIkYW5pbWF0ZSIsICIkY29sbGFwc2UiLCBmdW5jdGlvbigkd2luZG93LCAkYW5pbWF0ZSwgJGNvbGxhcHNlKSB7CgogICAgdmFyIGRlZmF1bHRzID0gJGNvbGxhcHNlLmRlZmF1bHRzOwoKICAgIHJldHVybiB7CiAgICAgIHJlcXVpcmU6IFsnP25nTW9kZWwnLCAnYnNDb2xsYXBzZSddLAogICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsICckYXR0cnMnLCAkY29sbGFwc2UuY29udHJvbGxlcl0sCiAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcnMpIHsKCiAgICAgICAgdmFyIG5nTW9kZWxDdHJsID0gY29udHJvbGxlcnNbMF07CiAgICAgICAgdmFyIGJzQ29sbGFwc2VDdHJsID0gY29udHJvbGxlcnNbMV07CgogICAgICAgIGlmKG5nTW9kZWxDdHJsKSB7CgogICAgICAgICAgLy8gVXBkYXRlIHRoZSBtb2RlbFZhbHVlIGZvbGxvd2luZwogICAgICAgICAgYnNDb2xsYXBzZUN0cmwuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMucHVzaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHNldFZpZXdWYWx1ZShic0NvbGxhcHNlQ3RybC4kdGFyZ2V0cy4kYWN0aXZlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIG1vZGVsVmFsdWUgLT4gJGZvcm1hdHRlcnMgLT4gdmlld1ZhbHVlCiAgICAgICAgICBuZ01vZGVsQ3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uKG1vZGVsVmFsdWUpIHsKICAgICAgICAgICAgLy8gY29uc29sZS53YXJuKCckZm9ybWF0dGVyKCIlcyIpOiBtb2RlbFZhbHVlPSVvICglbyknLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksIG1vZGVsVmFsdWUsIHR5cGVvZiBtb2RlbFZhbHVlKTsKICAgICAgICAgICAgaWYgKGJzQ29sbGFwc2VDdHJsLiR0YXJnZXRzLiRhY3RpdmUgIT09IG1vZGVsVmFsdWUgKiAxKSB7CiAgICAgICAgICAgICAgYnNDb2xsYXBzZUN0cmwuJHNldEFjdGl2ZShtb2RlbFZhbHVlICogMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1vZGVsVmFsdWU7CiAgICAgICAgICB9KTsKCiAgICAgICAgfQoKICAgICAgfQogICAgfTsKCiAgfV0pCgogIC5kaXJlY3RpdmUoJ2JzQ29sbGFwc2VUb2dnbGUnLCBmdW5jdGlvbigpIHsKCiAgICByZXR1cm4gewogICAgICByZXF1aXJlOiBbJ14/bmdNb2RlbCcsICdeYnNDb2xsYXBzZSddLAogICAgICBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgZWxlbWVudCwgYXR0cnMsIGNvbnRyb2xsZXJzKSB7CgogICAgICAgIHZhciBuZ01vZGVsQ3RybCA9IGNvbnRyb2xsZXJzWzBdOwogICAgICAgIHZhciBic0NvbGxhcHNlQ3RybCA9IGNvbnRyb2xsZXJzWzFdOwoKICAgICAgICAvLyBBZGQgYmFzZSBhdHRyCiAgICAgICAgZWxlbWVudC5hdHRyKCdkYXRhLXRvZ2dsZScsICdjb2xsYXBzZScpOwoKICAgICAgICAvLyBQdXNoIHBhbmUgdG8gcGFyZW50IGJzQ29sbGFwc2UgY29udHJvbGxlcgogICAgICAgIGJzQ29sbGFwc2VDdHJsLiRyZWdpc3RlclRvZ2dsZShlbGVtZW50KTsKICAgICAgICBlbGVtZW50Lm9uKCdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGluZGV4ID0gYXR0cnMuYnNDb2xsYXBzZVRvZ2dsZSB8fCBic0NvbGxhcHNlQ3RybC4kdG9nZ2xlcy5pbmRleE9mKGVsZW1lbnQpOwogICAgICAgICAgYnNDb2xsYXBzZUN0cmwuJHNldEFjdGl2ZShpbmRleCAqIDEpOwogICAgICAgICAgc2NvcGUuJGFwcGx5KCk7CiAgICAgICAgfSk7CgogICAgICB9CiAgICB9OwoKICB9KQoKICAuZGlyZWN0aXZlKCdic0NvbGxhcHNlVGFyZ2V0JywgWyIkYW5pbWF0ZSIsIGZ1bmN0aW9uKCRhbmltYXRlKSB7CgogICAgcmV0dXJuIHsKICAgICAgcmVxdWlyZTogWydeP25nTW9kZWwnLCAnXmJzQ29sbGFwc2UnXSwKICAgICAgLy8gc2NvcGU6IHRydWUsCiAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcnMpIHsKCiAgICAgICAgdmFyIG5nTW9kZWxDdHJsID0gY29udHJvbGxlcnNbMF07CiAgICAgICAgdmFyIGJzQ29sbGFwc2VDdHJsID0gY29udHJvbGxlcnNbMV07CgogICAgICAgIC8vIEFkZCBiYXNlIGNsYXNzCiAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnY29sbGFwc2UnKTsKCiAgICAgICAgLy8gQWRkIGFuaW1hdGlvbiBjbGFzcwogICAgICAgIGlmKGJzQ29sbGFwc2VDdHJsLiRvcHRpb25zLmFuaW1hdGlvbikgewogICAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhic0NvbGxhcHNlQ3RybC4kb3B0aW9ucy5hbmltYXRpb24pOwogICAgICAgIH0KCiAgICAgICAgLy8gUHVzaCBwYW5lIHRvIHBhcmVudCBic0NvbGxhcHNlIGNvbnRyb2xsZXIKICAgICAgICBic0NvbGxhcHNlQ3RybC4kcmVnaXN0ZXJUYXJnZXQoZWxlbWVudCk7CgogICAgICAgIGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGJzQ29sbGFwc2VDdHJsLiR0YXJnZXRzLmluZGV4T2YoZWxlbWVudCk7CiAgICAgICAgICB2YXIgYWN0aXZlID0gYnNDb2xsYXBzZUN0cmwuJHRhcmdldHMuJGFjdGl2ZTsKICAgICAgICAgICRhbmltYXRlW2luZGV4ID09PSBhY3RpdmUgPyAnYWRkQ2xhc3MnIDogJ3JlbW92ZUNsYXNzJ10oZWxlbWVudCwgYnNDb2xsYXBzZUN0cmwuJG9wdGlvbnMuYWN0aXZlQ2xhc3MpOwogICAgICAgIH0KCiAgICAgICAgYnNDb2xsYXBzZUN0cmwuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMucHVzaChmdW5jdGlvbigpIHsKICAgICAgICAgIHJlbmRlcigpOwogICAgICAgIH0pOwogICAgICAgIHJlbmRlcigpOwoKICAgICAgfQogICAgfTsKCiAgfV0pOwoKLy8gU291cmNlOiBkYXRlcGlja2VyLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5kYXRlcGlja2VyJywgWydtZ2NyZWEubmdTdHJhcC5oZWxwZXJzLmRhdGVQYXJzZXInLCAnbWdjcmVhLm5nU3RyYXAudG9vbHRpcCddKQoKICAucHJvdmlkZXIoJyRkYXRlcGlja2VyJywgZnVuY3Rpb24oKSB7CgogICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgYW5pbWF0aW9uOiAnYW0tZmFkZScsCiAgICAgIHByZWZpeENsYXNzOiAnZGF0ZXBpY2tlcicsCiAgICAgIHBsYWNlbWVudDogJ2JvdHRvbS1sZWZ0JywKICAgICAgdGVtcGxhdGU6ICdkYXRlcGlja2VyL2RhdGVwaWNrZXIudHBsLmh0bWwnLAogICAgICB0cmlnZ2VyOiAnZm9jdXMnLAogICAgICBjb250YWluZXI6IGZhbHNlLAogICAgICBrZXlib2FyZDogdHJ1ZSwKICAgICAgaHRtbDogZmFsc2UsCiAgICAgIGRlbGF5OiAwLAogICAgICAvLyBsYW5nOiAkbG9jYWxlLmlkLAogICAgICB1c2VOYXRpdmU6IGZhbHNlLAogICAgICBkYXRlVHlwZTogJ2RhdGUnLAogICAgICBkYXRlRm9ybWF0OiAnc2hvcnREYXRlJywKICAgICAgbW9kZWxEYXRlRm9ybWF0OiBudWxsLAogICAgICBkYXlGb3JtYXQ6ICdkZCcsCiAgICAgIHN0cmljdEZvcm1hdDogZmFsc2UsCiAgICAgIGF1dG9jbG9zZTogZmFsc2UsCiAgICAgIG1pbkRhdGU6IC1JbmZpbml0eSwKICAgICAgbWF4RGF0ZTogK0luZmluaXR5LAogICAgICBzdGFydFZpZXc6IDAsCiAgICAgIG1pblZpZXc6IDAsCiAgICAgIHN0YXJ0V2VlazogMCwKICAgICAgZGF5c09mV2Vla0Rpc2FibGVkOiAnJywKICAgICAgaWNvbkxlZnQ6ICdnbHlwaGljb24gZ2x5cGhpY29uLWNoZXZyb24tbGVmdCcsCiAgICAgIGljb25SaWdodDogJ2dseXBoaWNvbiBnbHlwaGljb24tY2hldnJvbi1yaWdodCcKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gWyIkd2luZG93IiwgIiRkb2N1bWVudCIsICIkcm9vdFNjb3BlIiwgIiRzY2UiLCAiJGxvY2FsZSIsICJkYXRlRmlsdGVyIiwgImRhdGVwaWNrZXJWaWV3cyIsICIkdG9vbHRpcCIsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgJHJvb3RTY29wZSwgJHNjZSwgJGxvY2FsZSwgZGF0ZUZpbHRlciwgZGF0ZXBpY2tlclZpZXdzLCAkdG9vbHRpcCkgewoKICAgICAgdmFyIGJvZHlFbCA9IGFuZ3VsYXIuZWxlbWVudCgkd2luZG93LmRvY3VtZW50LmJvZHkpOwogICAgICB2YXIgaXNOYXRpdmUgPSAvKGlwKGF8bylkfGlwaG9uZXxhbmRyb2lkKS9pZy50ZXN0KCR3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudCk7CiAgICAgIHZhciBpc1RvdWNoID0gKCdjcmVhdGVUb3VjaCcgaW4gJHdpbmRvdy5kb2N1bWVudCkgJiYgaXNOYXRpdmU7CiAgICAgIGlmKCFkZWZhdWx0cy5sYW5nKSBkZWZhdWx0cy5sYW5nID0gJGxvY2FsZS5pZDsKCiAgICAgIGZ1bmN0aW9uIERhdGVwaWNrZXJGYWN0b3J5KGVsZW1lbnQsIGNvbnRyb2xsZXIsIGNvbmZpZykgewoKICAgICAgICB2YXIgJGRhdGVwaWNrZXIgPSAkdG9vbHRpcChlbGVtZW50LCBhbmd1bGFyLmV4dGVuZCh7fSwgZGVmYXVsdHMsIGNvbmZpZykpOwogICAgICAgIHZhciBwYXJlbnRTY29wZSA9IGNvbmZpZy5zY29wZTsKICAgICAgICB2YXIgb3B0aW9ucyA9ICRkYXRlcGlja2VyLiRvcHRpb25zOwogICAgICAgIHZhciBzY29wZSA9ICRkYXRlcGlja2VyLiRzY29wZTsKICAgICAgICBpZihvcHRpb25zLnN0YXJ0Vmlldykgb3B0aW9ucy5zdGFydFZpZXcgLT0gb3B0aW9ucy5taW5WaWV3OwoKICAgICAgICAvLyBWaWV3IHZhcnMKCiAgICAgICAgdmFyIHBpY2tlclZpZXdzID0gZGF0ZXBpY2tlclZpZXdzKCRkYXRlcGlja2VyKTsKICAgICAgICAkZGF0ZXBpY2tlci4kdmlld3MgPSBwaWNrZXJWaWV3cy52aWV3czsKICAgICAgICB2YXIgdmlld0RhdGUgPSBwaWNrZXJWaWV3cy52aWV3RGF0ZTsKICAgICAgICBzY29wZS4kbW9kZSA9IG9wdGlvbnMuc3RhcnRWaWV3OwogICAgICAgIHNjb3BlLiRpY29uTGVmdCA9IG9wdGlvbnMuaWNvbkxlZnQ7CiAgICAgICAgc2NvcGUuJGljb25SaWdodCA9IG9wdGlvbnMuaWNvblJpZ2h0OwogICAgICAgIHZhciAkcGlja2VyID0gJGRhdGVwaWNrZXIuJHZpZXdzW3Njb3BlLiRtb2RlXTsKCiAgICAgICAgLy8gU2NvcGUgbWV0aG9kcwoKICAgICAgICBzY29wZS4kc2VsZWN0ID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgJGRhdGVwaWNrZXIuc2VsZWN0KGRhdGUpOwogICAgICAgIH07CiAgICAgICAgc2NvcGUuJHNlbGVjdFBhbmUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgJGRhdGVwaWNrZXIuJHNlbGVjdFBhbmUodmFsdWUpOwogICAgICAgIH07CiAgICAgICAgc2NvcGUuJHRvZ2dsZU1vZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICRkYXRlcGlja2VyLnNldE1vZGUoKHNjb3BlLiRtb2RlICsgMSkgJSAkZGF0ZXBpY2tlci4kdmlld3MubGVuZ3RoKTsKICAgICAgICB9OwoKICAgICAgICAvLyBQdWJsaWMgbWV0aG9kcwoKICAgICAgICAkZGF0ZXBpY2tlci51cGRhdGUgPSBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRkYXRlcGlja2VyLnVwZGF0ZSgpIG5ld1ZhbHVlPSVvJywgZGF0ZSk7CiAgICAgICAgICBpZihhbmd1bGFyLmlzRGF0ZShkYXRlKSAmJiAhaXNOYU4oZGF0ZS5nZXRUaW1lKCkpKSB7CiAgICAgICAgICAgICRkYXRlcGlja2VyLiRkYXRlID0gZGF0ZTsKICAgICAgICAgICAgJHBpY2tlci51cGRhdGUuY2FsbCgkcGlja2VyLCBkYXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIEJ1aWxkIG9ubHkgaWYgcHJpc3RpbmUKICAgICAgICAgICRkYXRlcGlja2VyLiRidWlsZCh0cnVlKTsKICAgICAgICB9OwoKICAgICAgICAkZGF0ZXBpY2tlci51cGRhdGVEaXNhYmxlZERhdGVzID0gZnVuY3Rpb24oZGF0ZVJhbmdlcykgewogICAgICAgICAgb3B0aW9ucy5kaXNhYmxlZERhdGVSYW5nZXMgPSBkYXRlUmFuZ2VzOwogICAgICAgICAgZm9yKHZhciBpID0gMCwgbCA9IHNjb3BlLnJvd3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChzY29wZS5yb3dzW2ldLCAkZGF0ZXBpY2tlci4kc2V0RGlzYWJsZWRFbCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgJGRhdGVwaWNrZXIuc2VsZWN0ID0gZnVuY3Rpb24oZGF0ZSwga2VlcCkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCckZGF0ZXBpY2tlci5zZWxlY3QnLCBkYXRlLCBzY29wZS4kbW9kZSk7CiAgICAgICAgICBpZighYW5ndWxhci5pc0RhdGUoY29udHJvbGxlci4kZGF0ZVZhbHVlKSkgY29udHJvbGxlci4kZGF0ZVZhbHVlID0gbmV3IERhdGUoZGF0ZSk7CiAgICAgICAgICBpZighc2NvcGUuJG1vZGUgfHwga2VlcCkgewogICAgICAgICAgICBjb250cm9sbGVyLiRzZXRWaWV3VmFsdWUoYW5ndWxhci5jb3B5KGRhdGUpKTsKICAgICAgICAgICAgY29udHJvbGxlci4kcmVuZGVyKCk7CiAgICAgICAgICAgIGlmKG9wdGlvbnMuYXV0b2Nsb3NlICYmICFrZWVwKSB7CiAgICAgICAgICAgICAgJGRhdGVwaWNrZXIuaGlkZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYW5ndWxhci5leHRlbmQodmlld0RhdGUsIHt5ZWFyOiBkYXRlLmdldEZ1bGxZZWFyKCksIG1vbnRoOiBkYXRlLmdldE1vbnRoKCksIGRhdGU6IGRhdGUuZ2V0RGF0ZSgpfSk7CiAgICAgICAgICAgICRkYXRlcGlja2VyLnNldE1vZGUoc2NvcGUuJG1vZGUgLSAxKTsKICAgICAgICAgICAgJGRhdGVwaWNrZXIuJGJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgJGRhdGVwaWNrZXIuc2V0TW9kZSA9IGZ1bmN0aW9uKG1vZGUpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2FybignJGRhdGVwaWNrZXIuc2V0TW9kZScsIG1vZGUpOwogICAgICAgICAgc2NvcGUuJG1vZGUgPSBtb2RlOwogICAgICAgICAgJHBpY2tlciA9ICRkYXRlcGlja2VyLiR2aWV3c1tzY29wZS4kbW9kZV07CiAgICAgICAgICAkZGF0ZXBpY2tlci4kYnVpbGQoKTsKICAgICAgICB9OwoKICAgICAgICAvLyBQcm90ZWN0ZWQgbWV0aG9kcwoKICAgICAgICAkZGF0ZXBpY2tlci4kYnVpbGQgPSBmdW5jdGlvbihwcmlzdGluZSkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCckZGF0ZXBpY2tlci4kYnVpbGQoKSB2aWV3RGF0ZT0lbycsIHZpZXdEYXRlKTsKICAgICAgICAgIGlmKHByaXN0aW5lID09PSB0cnVlICYmICRwaWNrZXIuYnVpbHQpIHJldHVybjsKICAgICAgICAgIGlmKHByaXN0aW5lID09PSBmYWxzZSAmJiAhJHBpY2tlci5idWlsdCkgcmV0dXJuOwogICAgICAgICAgJHBpY2tlci5idWlsZC5jYWxsKCRwaWNrZXIpOwogICAgICAgIH07CgogICAgICAgICRkYXRlcGlja2VyLiR1cGRhdGVTZWxlY3RlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgZm9yKHZhciBpID0gMCwgbCA9IHNjb3BlLnJvd3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChzY29wZS5yb3dzW2ldLCB1cGRhdGVTZWxlY3RlZCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgJGRhdGVwaWNrZXIuJGlzU2VsZWN0ZWQgPSBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICByZXR1cm4gJHBpY2tlci5pc1NlbGVjdGVkKGRhdGUpOwogICAgICAgIH07CgogICAgICAgICRkYXRlcGlja2VyLiRzZXREaXNhYmxlZEVsID0gZnVuY3Rpb24oZWwpIHsKICAgICAgICAgIGVsLmRpc2FibGVkID0gJHBpY2tlci5pc0Rpc2FibGVkKGVsLmRhdGUpOwogICAgICAgIH07CgogICAgICAgICRkYXRlcGlja2VyLiRzZWxlY3RQYW5lID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHZhciBzdGVwcyA9ICRwaWNrZXIuc3RlcHM7CiAgICAgICAgICB2YXIgdGFyZ2V0RGF0ZSA9IG5ldyBEYXRlKERhdGUuVVRDKHZpZXdEYXRlLnllYXIgKyAoKHN0ZXBzLnllYXIgfHwgMCkgKiB2YWx1ZSksIHZpZXdEYXRlLm1vbnRoICsgKChzdGVwcy5tb250aCB8fCAwKSAqIHZhbHVlKSwgdmlld0RhdGUuZGF0ZSArICgoc3RlcHMuZGF5IHx8IDApICogdmFsdWUpKSk7CiAgICAgICAgICBhbmd1bGFyLmV4dGVuZCh2aWV3RGF0ZSwge3llYXI6IHRhcmdldERhdGUuZ2V0VVRDRnVsbFllYXIoKSwgbW9udGg6IHRhcmdldERhdGUuZ2V0VVRDTW9udGgoKSwgZGF0ZTogdGFyZ2V0RGF0ZS5nZXRVVENEYXRlKCl9KTsKICAgICAgICAgICRkYXRlcGlja2VyLiRidWlsZCgpOwogICAgICAgIH07CgogICAgICAgICRkYXRlcGlja2VyLiRvbk1vdXNlRG93biA9IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgLy8gUHJldmVudCBibHVyIG9uIG1vdXNlZG93biBvbiAuZHJvcGRvd24tbWVudQogICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAvLyBFbXVsYXRlIGNsaWNrIGZvciBtb2JpbGUgZGV2aWNlcwogICAgICAgICAgaWYoaXNUb3VjaCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0RWwgPSBhbmd1bGFyLmVsZW1lbnQoZXZ0LnRhcmdldCk7CiAgICAgICAgICAgIGlmKHRhcmdldEVsWzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdidXR0b24nKSB7CiAgICAgICAgICAgICAgdGFyZ2V0RWwgPSB0YXJnZXRFbC5wYXJlbnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YXJnZXRFbC50cmlnZ2VySGFuZGxlcignY2xpY2snKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAkZGF0ZXBpY2tlci4kb25LZXlEb3duID0gZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICBpZiAoIS8oMzh8Mzd8Mzl8NDB8MTMpLy50ZXN0KGV2dC5rZXlDb2RlKSB8fCBldnQuc2hpZnRLZXkgfHwgZXZ0LmFsdEtleSkgcmV0dXJuOwogICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CgogICAgICAgICAgaWYoZXZ0LmtleUNvZGUgPT09IDEzKSB7CiAgICAgICAgICAgIGlmKCFzY29wZS4kbW9kZSkgewogICAgICAgICAgICAgIHJldHVybiAkZGF0ZXBpY2tlci5oaWRlKHRydWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7ICRkYXRlcGlja2VyLnNldE1vZGUoc2NvcGUuJG1vZGUgLSAxKTsgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBOYXZpZ2F0ZSB3aXRoIGtleWJvYXJkCiAgICAgICAgICAkcGlja2VyLm9uS2V5RG93bihldnQpOwogICAgICAgICAgcGFyZW50U2NvcGUuJGRpZ2VzdCgpOwogICAgICAgIH07CgogICAgICAgIC8vIFByaXZhdGUKCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU2VsZWN0ZWQoZWwpIHsKICAgICAgICAgIGVsLnNlbGVjdGVkID0gJGRhdGVwaWNrZXIuJGlzU2VsZWN0ZWQoZWwuZGF0ZSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmb2N1c0VsZW1lbnQoKSB7CiAgICAgICAgICBlbGVtZW50WzBdLmZvY3VzKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBPdmVycmlkZXMKCiAgICAgICAgdmFyIF9pbml0ID0gJGRhdGVwaWNrZXIuaW5pdDsKICAgICAgICAkZGF0ZXBpY2tlci5pbml0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZihpc05hdGl2ZSAmJiBvcHRpb25zLnVzZU5hdGl2ZSkgewogICAgICAgICAgICBlbGVtZW50LnByb3AoJ3R5cGUnLCAnZGF0ZScpOwogICAgICAgICAgICBlbGVtZW50LmNzcygnLXdlYmtpdC1hcHBlYXJhbmNlJywgJ3RleHRmaWVsZCcpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9IGVsc2UgaWYoaXNUb3VjaCkgewogICAgICAgICAgICBlbGVtZW50LnByb3AoJ3R5cGUnLCAndGV4dCcpOwogICAgICAgICAgICBlbGVtZW50LmF0dHIoJ3JlYWRvbmx5JywgJ3RydWUnKTsKICAgICAgICAgICAgZWxlbWVudC5vbignY2xpY2snLCBmb2N1c0VsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgX2luaXQoKTsKICAgICAgICB9OwoKICAgICAgICB2YXIgX2Rlc3Ryb3kgPSAkZGF0ZXBpY2tlci5kZXN0cm95OwogICAgICAgICRkYXRlcGlja2VyLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmKGlzTmF0aXZlICYmIG9wdGlvbnMudXNlTmF0aXZlKSB7CiAgICAgICAgICAgIGVsZW1lbnQub2ZmKCdjbGljaycsIGZvY3VzRWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICBfZGVzdHJveSgpOwogICAgICAgIH07CgogICAgICAgIHZhciBfc2hvdyA9ICRkYXRlcGlja2VyLnNob3c7CiAgICAgICAgJGRhdGVwaWNrZXIuc2hvdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgX3Nob3coKTsKICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRkYXRlcGlja2VyLiRlbGVtZW50Lm9uKGlzVG91Y2ggPyAndG91Y2hzdGFydCcgOiAnbW91c2Vkb3duJywgJGRhdGVwaWNrZXIuJG9uTW91c2VEb3duKTsKICAgICAgICAgICAgaWYob3B0aW9ucy5rZXlib2FyZCkgewogICAgICAgICAgICAgIGVsZW1lbnQub24oJ2tleWRvd24nLCAkZGF0ZXBpY2tlci4kb25LZXlEb3duKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIF9oaWRlID0gJGRhdGVwaWNrZXIuaGlkZTsKICAgICAgICAkZGF0ZXBpY2tlci5oaWRlID0gZnVuY3Rpb24oYmx1cikgewogICAgICAgICAgaWYoISRkYXRlcGlja2VyLiRpc1Nob3duKSByZXR1cm47CiAgICAgICAgICAkZGF0ZXBpY2tlci4kZWxlbWVudC5vZmYoaXNUb3VjaCA/ICd0b3VjaHN0YXJ0JyA6ICdtb3VzZWRvd24nLCAkZGF0ZXBpY2tlci4kb25Nb3VzZURvd24pOwogICAgICAgICAgaWYob3B0aW9ucy5rZXlib2FyZCkgewogICAgICAgICAgICBlbGVtZW50Lm9mZigna2V5ZG93bicsICRkYXRlcGlja2VyLiRvbktleURvd24pOwogICAgICAgICAgfQogICAgICAgICAgX2hpZGUoYmx1cik7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuICRkYXRlcGlja2VyOwoKICAgICAgfQoKICAgICAgRGF0ZXBpY2tlckZhY3RvcnkuZGVmYXVsdHMgPSBkZWZhdWx0czsKICAgICAgcmV0dXJuIERhdGVwaWNrZXJGYWN0b3J5OwoKICAgIH1dOwoKICB9KQoKICAuZGlyZWN0aXZlKCdic0RhdGVwaWNrZXInLCBbIiR3aW5kb3ciLCAiJHBhcnNlIiwgIiRxIiwgIiRsb2NhbGUiLCAiZGF0ZUZpbHRlciIsICIkZGF0ZXBpY2tlciIsICIkZGF0ZVBhcnNlciIsICIkdGltZW91dCIsIGZ1bmN0aW9uKCR3aW5kb3csICRwYXJzZSwgJHEsICRsb2NhbGUsIGRhdGVGaWx0ZXIsICRkYXRlcGlja2VyLCAkZGF0ZVBhcnNlciwgJHRpbWVvdXQpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSAkZGF0ZXBpY2tlci5kZWZhdWx0czsKICAgIHZhciBpc05hdGl2ZSA9IC8oaXAoYXxvKWR8aXBob25lfGFuZHJvaWQpL2lnLnRlc3QoJHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50KTsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0VBQycsCiAgICAgIHJlcXVpcmU6ICduZ01vZGVsJywKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGNvbnRyb2xsZXIpIHsKCiAgICAgICAgLy8gRGlyZWN0aXZlIG9wdGlvbnMKICAgICAgICB2YXIgb3B0aW9ucyA9IHtzY29wZTogc2NvcGUsIGNvbnRyb2xsZXI6IGNvbnRyb2xsZXJ9OwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ3BsYWNlbWVudCcsICdjb250YWluZXInLCAnZGVsYXknLCAndHJpZ2dlcicsICdrZXlib2FyZCcsICdodG1sJywgJ2FuaW1hdGlvbicsICd0ZW1wbGF0ZScsICdhdXRvY2xvc2UnLCAnZGF0ZVR5cGUnLCAnZGF0ZUZvcm1hdCcsICdtb2RlbERhdGVGb3JtYXQnLCAnZGF5Rm9ybWF0JywgJ3N0cmljdEZvcm1hdCcsICdzdGFydFdlZWsnLCAnc3RhcnREYXRlJywgJ3VzZU5hdGl2ZScsICdsYW5nJywgJ3N0YXJ0VmlldycsICdtaW5WaWV3JywgJ2ljb25MZWZ0JywgJ2ljb25SaWdodCcsICdkYXlzT2ZXZWVrRGlzYWJsZWQnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzRGVmaW5lZChhdHRyW2tleV0pKSBvcHRpb25zW2tleV0gPSBhdHRyW2tleV07CiAgICAgICAgfSk7CgogICAgICAgIC8vIFZpc2liaWxpdHkgYmluZGluZyBzdXBwb3J0CiAgICAgICAgYXR0ci5ic1Nob3cgJiYgc2NvcGUuJHdhdGNoKGF0dHIuYnNTaG93LCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgIGlmKCFkYXRlcGlja2VyIHx8ICFhbmd1bGFyLmlzRGVmaW5lZChuZXdWYWx1ZSkpIHJldHVybjsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNTdHJpbmcobmV3VmFsdWUpKSBuZXdWYWx1ZSA9ICEhbmV3VmFsdWUubWF0Y2goL3RydWV8LD8oZGF0ZXBpY2tlciksPy9pKTsKICAgICAgICAgIG5ld1ZhbHVlID09PSB0cnVlID8gZGF0ZXBpY2tlci5zaG93KCkgOiBkYXRlcGlja2VyLmhpZGUoKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSBkYXRlcGlja2VyCiAgICAgICAgdmFyIGRhdGVwaWNrZXIgPSAkZGF0ZXBpY2tlcihlbGVtZW50LCBjb250cm9sbGVyLCBvcHRpb25zKTsKICAgICAgICBvcHRpb25zID0gZGF0ZXBpY2tlci4kb3B0aW9uczsKICAgICAgICAvLyBTZXQgZXhwZWN0ZWQgaU9TIGZvcm1hdAogICAgICAgIGlmKGlzTmF0aXZlICYmIG9wdGlvbnMudXNlTmF0aXZlKSBvcHRpb25zLmRhdGVGb3JtYXQgPSAneXl5eS1NTS1kZCc7CgogICAgICAgIC8vIEluaXRpYWxpemUgcGFyc2VyCiAgICAgICAgdmFyIGRhdGVQYXJzZXIgPSAkZGF0ZVBhcnNlcih7Zm9ybWF0OiBvcHRpb25zLmRhdGVGb3JtYXQsIGxhbmc6IG9wdGlvbnMubGFuZywgc3RyaWN0OiBvcHRpb25zLnN0cmljdEZvcm1hdH0pOwoKICAgICAgICAvLyBPYnNlcnZlIGF0dHJpYnV0ZXMgZm9yIGNoYW5nZXMKICAgICAgICBhbmd1bGFyLmZvckVhY2goWydtaW5EYXRlJywgJ21heERhdGUnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJ2F0dHIuJG9ic2VydmUoJXMpJywga2V5LCBhdHRyW2tleV0pOwogICAgICAgICAgYW5ndWxhci5pc0RlZmluZWQoYXR0cltrZXldKSAmJiBhdHRyLiRvYnNlcnZlKGtleSwgZnVuY3Rpb24obmV3VmFsdWUpIHsKICAgICAgICAgICAgLy8gY29uc29sZS53YXJuKCdhdHRyLiRvYnNlcnZlKCVzKT0lbycsIGtleSwgbmV3VmFsdWUpOwogICAgICAgICAgICBkYXRlcGlja2VyLiRvcHRpb25zW2tleV0gPSBkYXRlUGFyc2VyLmdldERhdGVGb3JBdHRyaWJ1dGUoa2V5LCBuZXdWYWx1ZSk7CiAgICAgICAgICAgIC8vIEJ1aWxkIG9ubHkgaWYgZGlydHkKICAgICAgICAgICAgIWlzTmFOKGRhdGVwaWNrZXIuJG9wdGlvbnNba2V5XSkgJiYgZGF0ZXBpY2tlci4kYnVpbGQoZmFsc2UpOwogICAgICAgICAgICB2YWxpZGF0ZUFnYWluc3RNaW5NYXhEYXRlKGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gV2F0Y2ggbW9kZWwgZm9yIGNoYW5nZXMKICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ01vZGVsLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgIGRhdGVwaWNrZXIudXBkYXRlKGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSk7CiAgICAgICAgfSwgdHJ1ZSk7CgogICAgICAgIC8vIE5vcm1hbGl6ZSB1bmRlZmluZWQvbnVsbC9lbXB0eSBhcnJheSwKICAgICAgICAvLyBzbyB0aGF0IHdlIGRvbid0IHRyZWF0IGNoYW5naW5nIGZyb20gdW5kZWZpbmVkLT5udWxsIGFzIGEgY2hhbmdlLgogICAgICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZURhdGVSYW5nZXMocmFuZ2VzKSB7CiAgICAgICAgICBpZiAoIXJhbmdlcyB8fCAhcmFuZ2VzLmxlbmd0aCkgcmV0dXJuIG51bGw7CiAgICAgICAgICByZXR1cm4gcmFuZ2VzOwogICAgICAgIH0KCiAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKGF0dHIuZGlzYWJsZWREYXRlcykpIHsKICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLmRpc2FibGVkRGF0ZXMsIGZ1bmN0aW9uKGRpc2FibGVkUmFuZ2VzLCBwcmV2aW91c1ZhbHVlKSB7CiAgICAgICAgICAgIGRpc2FibGVkUmFuZ2VzID0gbm9ybWFsaXplRGF0ZVJhbmdlcyhkaXNhYmxlZFJhbmdlcyk7CiAgICAgICAgICAgIHByZXZpb3VzVmFsdWUgPSBub3JtYWxpemVEYXRlUmFuZ2VzKHByZXZpb3VzVmFsdWUpOwoKICAgICAgICAgICAgaWYgKGRpc2FibGVkUmFuZ2VzKSB7CiAgICAgICAgICAgICAgZGF0ZXBpY2tlci51cGRhdGVEaXNhYmxlZERhdGVzKGRpc2FibGVkUmFuZ2VzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUFnYWluc3RNaW5NYXhEYXRlKHBhcnNlZERhdGUpIHsKICAgICAgICAgIGlmICghYW5ndWxhci5pc0RhdGUocGFyc2VkRGF0ZSkpIHJldHVybjsKICAgICAgICAgIHZhciBpc01pblZhbGlkID0gaXNOYU4oZGF0ZXBpY2tlci4kb3B0aW9ucy5taW5EYXRlKSB8fCBwYXJzZWREYXRlLmdldFRpbWUoKSA+PSBkYXRlcGlja2VyLiRvcHRpb25zLm1pbkRhdGU7CiAgICAgICAgICB2YXIgaXNNYXhWYWxpZCA9IGlzTmFOKGRhdGVwaWNrZXIuJG9wdGlvbnMubWF4RGF0ZSkgfHwgcGFyc2VkRGF0ZS5nZXRUaW1lKCkgPD0gZGF0ZXBpY2tlci4kb3B0aW9ucy5tYXhEYXRlOwogICAgICAgICAgdmFyIGlzVmFsaWQgPSBpc01pblZhbGlkICYmIGlzTWF4VmFsaWQ7CiAgICAgICAgICBjb250cm9sbGVyLiRzZXRWYWxpZGl0eSgnZGF0ZScsIGlzVmFsaWQpOwogICAgICAgICAgY29udHJvbGxlci4kc2V0VmFsaWRpdHkoJ21pbicsIGlzTWluVmFsaWQpOwogICAgICAgICAgY29udHJvbGxlci4kc2V0VmFsaWRpdHkoJ21heCcsIGlzTWF4VmFsaWQpOwogICAgICAgICAgLy8gT25seSB1cGRhdGUgdGhlIG1vZGVsIHdoZW4gd2UgaGF2ZSBhIHZhbGlkIGRhdGUKICAgICAgICAgIGlmKGlzVmFsaWQpIGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSA9IHBhcnNlZERhdGU7CiAgICAgICAgfQoKICAgICAgICAvLyB2aWV3VmFsdWUgLT4gJHBhcnNlcnMgLT4gbW9kZWxWYWx1ZQogICAgICAgIGNvbnRyb2xsZXIuJHBhcnNlcnMudW5zaGlmdChmdW5jdGlvbih2aWV3VmFsdWUpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2FybignJHBhcnNlcigiJXMiKTogdmlld1ZhbHVlPSVvJywgZWxlbWVudC5hdHRyKCduZy1tb2RlbCcpLCB2aWV3VmFsdWUpOwogICAgICAgICAgLy8gTnVsbCB2YWx1ZXMgc2hvdWxkIGNvcnJlY3RseSByZXNldCB0aGUgbW9kZWwgdmFsdWUgJiB2YWxpZGl0eQogICAgICAgICAgaWYoIXZpZXdWYWx1ZSkgewogICAgICAgICAgICBjb250cm9sbGVyLiRzZXRWYWxpZGl0eSgnZGF0ZScsIHRydWUpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGFyc2VkRGF0ZSA9IGRhdGVQYXJzZXIucGFyc2Uodmlld1ZhbHVlLCBjb250cm9sbGVyLiRkYXRlVmFsdWUpOwogICAgICAgICAgaWYoIXBhcnNlZERhdGUgfHwgaXNOYU4ocGFyc2VkRGF0ZS5nZXRUaW1lKCkpKSB7CiAgICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZhbGlkaXR5KCdkYXRlJywgZmFsc2UpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWxpZGF0ZUFnYWluc3RNaW5NYXhEYXRlKHBhcnNlZERhdGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYob3B0aW9ucy5kYXRlVHlwZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGVGaWx0ZXIocGFyc2VkRGF0ZSwgb3B0aW9ucy5tb2RlbERhdGVGb3JtYXQgfHwgb3B0aW9ucy5kYXRlRm9ybWF0KTsKICAgICAgICAgIH0gZWxzZSBpZihvcHRpb25zLmRhdGVUeXBlID09PSAnbnVtYmVyJykgewogICAgICAgICAgICByZXR1cm4gY29udHJvbGxlci4kZGF0ZVZhbHVlLmdldFRpbWUoKTsKICAgICAgICAgIH0gZWxzZSBpZihvcHRpb25zLmRhdGVUeXBlID09PSAnaXNvJykgewogICAgICAgICAgICByZXR1cm4gY29udHJvbGxlci4kZGF0ZVZhbHVlLnRvSVNPU3RyaW5nKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbmV3IERhdGUoY29udHJvbGxlci4kZGF0ZVZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgLy8gbW9kZWxWYWx1ZSAtPiAkZm9ybWF0dGVycyAtPiB2aWV3VmFsdWUKICAgICAgICBjb250cm9sbGVyLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24obW9kZWxWYWx1ZSkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCckZm9ybWF0dGVyKCIlcyIpOiBtb2RlbFZhbHVlPSVvICglbyknLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksIG1vZGVsVmFsdWUsIHR5cGVvZiBtb2RlbFZhbHVlKTsKICAgICAgICAgIHZhciBkYXRlOwogICAgICAgICAgaWYoYW5ndWxhci5pc1VuZGVmaW5lZChtb2RlbFZhbHVlKSB8fCBtb2RlbFZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgIGRhdGUgPSBOYU47CiAgICAgICAgICB9IGVsc2UgaWYoYW5ndWxhci5pc0RhdGUobW9kZWxWYWx1ZSkpIHsKICAgICAgICAgICAgZGF0ZSA9IG1vZGVsVmFsdWU7CiAgICAgICAgICB9IGVsc2UgaWYob3B0aW9ucy5kYXRlVHlwZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgZGF0ZSA9IGRhdGVQYXJzZXIucGFyc2UobW9kZWxWYWx1ZSwgbnVsbCwgb3B0aW9ucy5tb2RlbERhdGVGb3JtYXQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGF0ZSA9IG5ldyBEYXRlKG1vZGVsVmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgLy8gU2V0dXAgZGVmYXVsdCB2YWx1ZT8KICAgICAgICAgIC8vIGlmKGlzTmFOKGRhdGUuZ2V0VGltZSgpKSkgewogICAgICAgICAgLy8gICB2YXIgdG9kYXkgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgLy8gICBkYXRlID0gbmV3IERhdGUodG9kYXkuZ2V0RnVsbFllYXIoKSwgdG9kYXkuZ2V0TW9udGgoKSwgdG9kYXkuZ2V0RGF0ZSgpLCAwLCAwLCAwLCAwKTsKICAgICAgICAgIC8vIH0KICAgICAgICAgIGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSA9IGRhdGU7CiAgICAgICAgICByZXR1cm4gY29udHJvbGxlci4kZGF0ZVZhbHVlOwogICAgICAgIH0pOwoKICAgICAgICAvLyB2aWV3VmFsdWUgLT4gZWxlbWVudAogICAgICAgIGNvbnRyb2xsZXIuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCckcmVuZGVyKCIlcyIpOiB2aWV3VmFsdWU9JW8nLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksIGNvbnRyb2xsZXIuJHZpZXdWYWx1ZSk7CiAgICAgICAgICBlbGVtZW50LnZhbCghY29udHJvbGxlci4kZGF0ZVZhbHVlIHx8IGlzTmFOKGNvbnRyb2xsZXIuJGRhdGVWYWx1ZS5nZXRUaW1lKCkpID8gJycgOiBkYXRlRmlsdGVyKGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSwgb3B0aW9ucy5kYXRlRm9ybWF0KSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gR2FyYmFnZSBjb2xsZWN0aW9uCiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYoZGF0ZXBpY2tlcikgZGF0ZXBpY2tlci5kZXN0cm95KCk7CiAgICAgICAgICBvcHRpb25zID0gbnVsbDsKICAgICAgICAgIGRhdGVwaWNrZXIgPSBudWxsOwogICAgICAgIH0pOwoKICAgICAgfQogICAgfTsKCiAgfV0pCgogIC5wcm92aWRlcignZGF0ZXBpY2tlclZpZXdzJywgZnVuY3Rpb24oKSB7CgogICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgZGF5Rm9ybWF0OiAnZGQnLAogICAgICBkYXlTcGxpdDogNwogICAgfTsKCiAgICAvLyBTcGxpdCBhcnJheSBpbnRvIHNtYWxsZXIgYXJyYXlzCiAgICBmdW5jdGlvbiBzcGxpdChhcnIsIHNpemUpIHsKICAgICAgdmFyIGFycmF5cyA9IFtdOwogICAgICB3aGlsZShhcnIubGVuZ3RoID4gMCkgewogICAgICAgIGFycmF5cy5wdXNoKGFyci5zcGxpY2UoMCwgc2l6ZSkpOwogICAgICB9CiAgICAgIHJldHVybiBhcnJheXM7CiAgICB9CgogICAgLy8gTW9kdWx1cyBvcGVyYXRvcgogICAgZnVuY3Rpb24gbW9kKG4sIG0pIHsKICAgICAgcmV0dXJuICgobiAlIG0pICsgbSkgJSBtOwogICAgfQoKICAgIHRoaXMuJGdldCA9IFsiJGxvY2FsZSIsICIkc2NlIiwgImRhdGVGaWx0ZXIiLCAiJGRhdGVQYXJzZXIiLCBmdW5jdGlvbigkbG9jYWxlLCAkc2NlLCBkYXRlRmlsdGVyLCAkZGF0ZVBhcnNlcikgewoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHBpY2tlcikgewoKICAgICAgICB2YXIgc2NvcGUgPSBwaWNrZXIuJHNjb3BlOwogICAgICAgIHZhciBvcHRpb25zID0gcGlja2VyLiRvcHRpb25zOwogICAgICAgIHZhciBkYXRlUGFyc2VyID0gJGRhdGVQYXJzZXIoKTsKCiAgICAgICAgdmFyIHdlZWtEYXlzTWluID0gJGxvY2FsZS5EQVRFVElNRV9GT1JNQVRTLlNIT1JUREFZOwogICAgICAgIHZhciB3ZWVrRGF5c0xhYmVscyA9IHdlZWtEYXlzTWluLnNsaWNlKG9wdGlvbnMuc3RhcnRXZWVrKS5jb25jYXQod2Vla0RheXNNaW4uc2xpY2UoMCwgb3B0aW9ucy5zdGFydFdlZWspKTsKICAgICAgICB2YXIgd2Vla0RheXNMYWJlbHNIdG1sID0gJHNjZS50cnVzdEFzSHRtbCgnPHRoIGNsYXNzPSJkb3cgdGV4dC1jZW50ZXIiPicgKyB3ZWVrRGF5c0xhYmVscy5qb2luKCc8L3RoPjx0aCBjbGFzcz0iZG93IHRleHQtY2VudGVyIj4nKSArICc8L3RoPicpOwoKICAgICAgICB2YXIgc3RhcnREYXRlID0gcGlja2VyLiRkYXRlIHx8IChvcHRpb25zLnN0YXJ0RGF0ZSA/IGRhdGVQYXJzZXIuZ2V0RGF0ZUZvckF0dHJpYnV0ZSgnc3RhcnREYXRlJywgb3B0aW9ucy5zdGFydERhdGUpIDogbmV3IERhdGUoKSk7CiAgICAgICAgdmFyIHZpZXdEYXRlID0ge3llYXI6IHN0YXJ0RGF0ZS5nZXRGdWxsWWVhcigpLCBtb250aDogc3RhcnREYXRlLmdldE1vbnRoKCksIGRhdGU6IHN0YXJ0RGF0ZS5nZXREYXRlKCl9OwogICAgICAgIHZhciB0aW1lem9uZU9mZnNldCA9IHN0YXJ0RGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpICogNmU0OwoKICAgICAgICB2YXIgdmlld3MgPSBbewogICAgICAgICAgICBmb3JtYXQ6IG9wdGlvbnMuZGF5Rm9ybWF0LAogICAgICAgICAgICBzcGxpdDogNywKICAgICAgICAgICAgc3RlcHM6IHsgbW9udGg6IDEgfSwKICAgICAgICAgICAgdXBkYXRlOiBmdW5jdGlvbihkYXRlLCBmb3JjZSkgewogICAgICAgICAgICAgIGlmKCF0aGlzLmJ1aWx0IHx8IGZvcmNlIHx8IGRhdGUuZ2V0RnVsbFllYXIoKSAhPT0gdmlld0RhdGUueWVhciB8fCBkYXRlLmdldE1vbnRoKCkgIT09IHZpZXdEYXRlLm1vbnRoKSB7CiAgICAgICAgICAgICAgICBhbmd1bGFyLmV4dGVuZCh2aWV3RGF0ZSwge3llYXI6IHBpY2tlci4kZGF0ZS5nZXRGdWxsWWVhcigpLCBtb250aDogcGlja2VyLiRkYXRlLmdldE1vbnRoKCksIGRhdGU6IHBpY2tlci4kZGF0ZS5nZXREYXRlKCl9KTsKICAgICAgICAgICAgICAgIHBpY2tlci4kYnVpbGQoKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYoZGF0ZS5nZXREYXRlKCkgIT09IHZpZXdEYXRlLmRhdGUpIHsKICAgICAgICAgICAgICAgIHZpZXdEYXRlLmRhdGUgPSBwaWNrZXIuJGRhdGUuZ2V0RGF0ZSgpOwogICAgICAgICAgICAgICAgcGlja2VyLiR1cGRhdGVTZWxlY3RlZCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgYnVpbGQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBmaXJzdERheU9mTW9udGggPSBuZXcgRGF0ZSh2aWV3RGF0ZS55ZWFyLCB2aWV3RGF0ZS5tb250aCwgMSksIGZpcnN0RGF5T2ZNb250aE9mZnNldCA9IGZpcnN0RGF5T2ZNb250aC5nZXRUaW1lem9uZU9mZnNldCgpOwogICAgICAgICAgICAgIHZhciBmaXJzdERhdGUgPSBuZXcgRGF0ZSgrZmlyc3REYXlPZk1vbnRoIC0gbW9kKGZpcnN0RGF5T2ZNb250aC5nZXREYXkoKSAtIG9wdGlvbnMuc3RhcnRXZWVrLCA3KSAqIDg2NGU1KSwgZmlyc3REYXRlT2Zmc2V0ID0gZmlyc3REYXRlLmdldFRpbWV6b25lT2Zmc2V0KCk7CiAgICAgICAgICAgICAgdmFyIHRvZGF5ID0gbmV3IERhdGUoKS50b0RhdGVTdHJpbmcoKTsKICAgICAgICAgICAgICAvLyBIYW5kbGUgZGF5bGlnaHQgdGltZSBzd2l0Y2gKICAgICAgICAgICAgICBpZihmaXJzdERhdGVPZmZzZXQgIT09IGZpcnN0RGF5T2ZNb250aE9mZnNldCkgZmlyc3REYXRlID0gbmV3IERhdGUoK2ZpcnN0RGF0ZSArIChmaXJzdERhdGVPZmZzZXQgLSBmaXJzdERheU9mTW9udGhPZmZzZXQpICogNjBlMyk7CiAgICAgICAgICAgICAgdmFyIGRheXMgPSBbXSwgZGF5OwogICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCA0MjsgaSsrKSB7IC8vIDwgNyAqIDYKICAgICAgICAgICAgICAgIGRheSA9IG5ldyBEYXRlKGZpcnN0RGF0ZS5nZXRGdWxsWWVhcigpLCBmaXJzdERhdGUuZ2V0TW9udGgoKSwgZmlyc3REYXRlLmdldERhdGUoKSArIGkpOwogICAgICAgICAgICAgICAgZGF5cy5wdXNoKHtkYXRlOiBkYXksIGlzVG9kYXk6IGRheS50b0RhdGVTdHJpbmcoKSA9PT0gdG9kYXksIGxhYmVsOiBkYXRlRmlsdGVyKGRheSwgdGhpcy5mb3JtYXQpLCBzZWxlY3RlZDogcGlja2VyLiRkYXRlICYmIHRoaXMuaXNTZWxlY3RlZChkYXkpLCBtdXRlZDogZGF5LmdldE1vbnRoKCkgIT09IHZpZXdEYXRlLm1vbnRoLCBkaXNhYmxlZDogdGhpcy5pc0Rpc2FibGVkKGRheSl9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NvcGUudGl0bGUgPSBkYXRlRmlsdGVyKGZpcnN0RGF5T2ZNb250aCwgJ01NTU0geXl5eScpOwogICAgICAgICAgICAgIHNjb3BlLnNob3dMYWJlbHMgPSB0cnVlOwogICAgICAgICAgICAgIHNjb3BlLmxhYmVscyA9IHdlZWtEYXlzTGFiZWxzSHRtbDsKICAgICAgICAgICAgICBzY29wZS5yb3dzID0gc3BsaXQoZGF5cywgdGhpcy5zcGxpdCk7CiAgICAgICAgICAgICAgdGhpcy5idWlsdCA9IHRydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzU2VsZWN0ZWQ6IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcGlja2VyLiRkYXRlICYmIGRhdGUuZ2V0RnVsbFllYXIoKSA9PT0gcGlja2VyLiRkYXRlLmdldEZ1bGxZZWFyKCkgJiYgZGF0ZS5nZXRNb250aCgpID09PSBwaWNrZXIuJGRhdGUuZ2V0TW9udGgoKSAmJiBkYXRlLmdldERhdGUoKSA9PT0gcGlja2VyLiRkYXRlLmdldERhdGUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNEaXNhYmxlZDogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgIHZhciB0aW1lID0gZGF0ZS5nZXRUaW1lKCk7CgogICAgICAgICAgICAgIC8vIERpc2FibGVkIGJlY2F1c2Ugb2YgbWluL21heCBkYXRlLgogICAgICAgICAgICAgIGlmICh0aW1lIDwgb3B0aW9ucy5taW5EYXRlIHx8IHRpbWUgPiBvcHRpb25zLm1heERhdGUpIHJldHVybiB0cnVlOwoKICAgICAgICAgICAgICAvLyBEaXNhYmxlZCBkdWUgdG8gYmVpbmcgYSBkaXNhYmxlZCBkYXkgb2YgdGhlIHdlZWsKICAgICAgICAgICAgICBpZiAob3B0aW9ucy5kYXlzT2ZXZWVrRGlzYWJsZWQuaW5kZXhPZihkYXRlLmdldERheSgpKSAhPT0gLTEpIHJldHVybiB0cnVlOwoKICAgICAgICAgICAgICAvLyBEaXNhYmxlZCBiZWNhdXNlIG9mIGRpc2FibGVkIGRhdGUgcmFuZ2UuCiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZGlzYWJsZWREYXRlUmFuZ2VzKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9wdGlvbnMuZGlzYWJsZWREYXRlUmFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0aW1lID49IG9wdGlvbnMuZGlzYWJsZWREYXRlUmFuZ2VzW2ldLnN0YXJ0ICYmIHRpbWUgPD0gb3B0aW9ucy5kaXNhYmxlZERhdGVSYW5nZXNbaV0uZW5kKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25LZXlEb3duOiBmdW5jdGlvbihldnQpIHsKICAgICAgICAgICAgICB2YXIgYWN0dWFsVGltZSA9IHBpY2tlci4kZGF0ZS5nZXRUaW1lKCk7CiAgICAgICAgICAgICAgdmFyIG5ld0RhdGU7CgogICAgICAgICAgICAgIGlmKGV2dC5rZXlDb2RlID09PSAzNykgbmV3RGF0ZSA9IG5ldyBEYXRlKGFjdHVhbFRpbWUgLSAxICogODY0ZTUpOwogICAgICAgICAgICAgIGVsc2UgaWYoZXZ0LmtleUNvZGUgPT09IDM4KSBuZXdEYXRlID0gbmV3IERhdGUoYWN0dWFsVGltZSAtIDcgKiA4NjRlNSk7CiAgICAgICAgICAgICAgZWxzZSBpZihldnQua2V5Q29kZSA9PT0gMzkpIG5ld0RhdGUgPSBuZXcgRGF0ZShhY3R1YWxUaW1lICsgMSAqIDg2NGU1KTsKICAgICAgICAgICAgICBlbHNlIGlmKGV2dC5rZXlDb2RlID09PSA0MCkgbmV3RGF0ZSA9IG5ldyBEYXRlKGFjdHVhbFRpbWUgKyA3ICogODY0ZTUpOwoKICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNEaXNhYmxlZChuZXdEYXRlKSkgcGlja2VyLnNlbGVjdChuZXdEYXRlLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgewogICAgICAgICAgICBuYW1lOiAnbW9udGgnLAogICAgICAgICAgICBmb3JtYXQ6ICdNTU0nLAogICAgICAgICAgICBzcGxpdDogNCwKICAgICAgICAgICAgc3RlcHM6IHsgeWVhcjogMSB9LAogICAgICAgICAgICB1cGRhdGU6IGZ1bmN0aW9uKGRhdGUsIGZvcmNlKSB7CiAgICAgICAgICAgICAgaWYoIXRoaXMuYnVpbHQgfHwgZGF0ZS5nZXRGdWxsWWVhcigpICE9PSB2aWV3RGF0ZS55ZWFyKSB7CiAgICAgICAgICAgICAgICBhbmd1bGFyLmV4dGVuZCh2aWV3RGF0ZSwge3llYXI6IHBpY2tlci4kZGF0ZS5nZXRGdWxsWWVhcigpLCBtb250aDogcGlja2VyLiRkYXRlLmdldE1vbnRoKCksIGRhdGU6IHBpY2tlci4kZGF0ZS5nZXREYXRlKCl9KTsKICAgICAgICAgICAgICAgIHBpY2tlci4kYnVpbGQoKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYoZGF0ZS5nZXRNb250aCgpICE9PSB2aWV3RGF0ZS5tb250aCkgewogICAgICAgICAgICAgICAgYW5ndWxhci5leHRlbmQodmlld0RhdGUsIHttb250aDogcGlja2VyLiRkYXRlLmdldE1vbnRoKCksIGRhdGU6IHBpY2tlci4kZGF0ZS5nZXREYXRlKCl9KTsKICAgICAgICAgICAgICAgIHBpY2tlci4kdXBkYXRlU2VsZWN0ZWQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJ1aWxkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgZmlyc3RNb250aCA9IG5ldyBEYXRlKHZpZXdEYXRlLnllYXIsIDAsIDEpOwogICAgICAgICAgICAgIHZhciBtb250aHMgPSBbXSwgbW9udGg7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAxMjsgaSsrKSB7CiAgICAgICAgICAgICAgICBtb250aCA9IG5ldyBEYXRlKHZpZXdEYXRlLnllYXIsIGksIDEpOwogICAgICAgICAgICAgICAgbW9udGhzLnB1c2goe2RhdGU6IG1vbnRoLCBsYWJlbDogZGF0ZUZpbHRlcihtb250aCwgdGhpcy5mb3JtYXQpLCBzZWxlY3RlZDogcGlja2VyLiRpc1NlbGVjdGVkKG1vbnRoKSwgZGlzYWJsZWQ6IHRoaXMuaXNEaXNhYmxlZChtb250aCl9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NvcGUudGl0bGUgPSBkYXRlRmlsdGVyKG1vbnRoLCAneXl5eScpOwogICAgICAgICAgICAgIHNjb3BlLnNob3dMYWJlbHMgPSBmYWxzZTsKICAgICAgICAgICAgICBzY29wZS5yb3dzID0gc3BsaXQobW9udGhzLCB0aGlzLnNwbGl0KTsKICAgICAgICAgICAgICB0aGlzLmJ1aWx0ID0gdHJ1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNTZWxlY3RlZDogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgIHJldHVybiBwaWNrZXIuJGRhdGUgJiYgZGF0ZS5nZXRGdWxsWWVhcigpID09PSBwaWNrZXIuJGRhdGUuZ2V0RnVsbFllYXIoKSAmJiBkYXRlLmdldE1vbnRoKCkgPT09IHBpY2tlci4kZGF0ZS5nZXRNb250aCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc0Rpc2FibGVkOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgdmFyIGxhc3REYXRlID0gK25ldyBEYXRlKGRhdGUuZ2V0RnVsbFllYXIoKSwgZGF0ZS5nZXRNb250aCgpICsgMSwgMCk7CiAgICAgICAgICAgICAgcmV0dXJuIGxhc3REYXRlIDwgb3B0aW9ucy5taW5EYXRlIHx8IGRhdGUuZ2V0VGltZSgpID4gb3B0aW9ucy5tYXhEYXRlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvbktleURvd246IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgICAgIHZhciBhY3R1YWxNb250aCA9IHBpY2tlci4kZGF0ZS5nZXRNb250aCgpOwogICAgICAgICAgICAgIHZhciBuZXdEYXRlID0gbmV3IERhdGUocGlja2VyLiRkYXRlKTsKCiAgICAgICAgICAgICAgaWYoZXZ0LmtleUNvZGUgPT09IDM3KSBuZXdEYXRlLnNldE1vbnRoKGFjdHVhbE1vbnRoIC0gMSk7CiAgICAgICAgICAgICAgZWxzZSBpZihldnQua2V5Q29kZSA9PT0gMzgpIG5ld0RhdGUuc2V0TW9udGgoYWN0dWFsTW9udGggLSA0KTsKICAgICAgICAgICAgICBlbHNlIGlmKGV2dC5rZXlDb2RlID09PSAzOSkgbmV3RGF0ZS5zZXRNb250aChhY3R1YWxNb250aCArIDEpOwogICAgICAgICAgICAgIGVsc2UgaWYoZXZ0LmtleUNvZGUgPT09IDQwKSBuZXdEYXRlLnNldE1vbnRoKGFjdHVhbE1vbnRoICsgNCk7CgogICAgICAgICAgICAgIGlmICghdGhpcy5pc0Rpc2FibGVkKG5ld0RhdGUpKSBwaWNrZXIuc2VsZWN0KG5ld0RhdGUsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCB7CiAgICAgICAgICAgIG5hbWU6ICd5ZWFyJywKICAgICAgICAgICAgZm9ybWF0OiAneXl5eScsCiAgICAgICAgICAgIHNwbGl0OiA0LAogICAgICAgICAgICBzdGVwczogeyB5ZWFyOiAxMiB9LAogICAgICAgICAgICB1cGRhdGU6IGZ1bmN0aW9uKGRhdGUsIGZvcmNlKSB7CiAgICAgICAgICAgICAgaWYoIXRoaXMuYnVpbHQgfHwgZm9yY2UgfHwgcGFyc2VJbnQoZGF0ZS5nZXRGdWxsWWVhcigpLzIwLCAxMCkgIT09IHBhcnNlSW50KHZpZXdEYXRlLnllYXIvMjAsIDEwKSkgewogICAgICAgICAgICAgICAgYW5ndWxhci5leHRlbmQodmlld0RhdGUsIHt5ZWFyOiBwaWNrZXIuJGRhdGUuZ2V0RnVsbFllYXIoKSwgbW9udGg6IHBpY2tlci4kZGF0ZS5nZXRNb250aCgpLCBkYXRlOiBwaWNrZXIuJGRhdGUuZ2V0RGF0ZSgpfSk7CiAgICAgICAgICAgICAgICBwaWNrZXIuJGJ1aWxkKCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmKGRhdGUuZ2V0RnVsbFllYXIoKSAhPT0gdmlld0RhdGUueWVhcikgewogICAgICAgICAgICAgICAgYW5ndWxhci5leHRlbmQodmlld0RhdGUsIHt5ZWFyOiBwaWNrZXIuJGRhdGUuZ2V0RnVsbFllYXIoKSwgbW9udGg6IHBpY2tlci4kZGF0ZS5nZXRNb250aCgpLCBkYXRlOiBwaWNrZXIuJGRhdGUuZ2V0RGF0ZSgpfSk7CiAgICAgICAgICAgICAgICBwaWNrZXIuJHVwZGF0ZVNlbGVjdGVkKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBidWlsZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0WWVhciA9IHZpZXdEYXRlLnllYXIgLSB2aWV3RGF0ZS55ZWFyICUgKHRoaXMuc3BsaXQgKiAzKTsKICAgICAgICAgICAgICB2YXIgeWVhcnMgPSBbXSwgeWVhcjsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDEyOyBpKyspIHsKICAgICAgICAgICAgICAgIHllYXIgPSBuZXcgRGF0ZShmaXJzdFllYXIgKyBpLCAwLCAxKTsKICAgICAgICAgICAgICAgIHllYXJzLnB1c2goe2RhdGU6IHllYXIsIGxhYmVsOiBkYXRlRmlsdGVyKHllYXIsIHRoaXMuZm9ybWF0KSwgc2VsZWN0ZWQ6IHBpY2tlci4kaXNTZWxlY3RlZCh5ZWFyKSwgZGlzYWJsZWQ6IHRoaXMuaXNEaXNhYmxlZCh5ZWFyKX0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzY29wZS50aXRsZSA9IHllYXJzWzBdLmxhYmVsICsgJy0nICsgeWVhcnNbeWVhcnMubGVuZ3RoIC0gMV0ubGFiZWw7CiAgICAgICAgICAgICAgc2NvcGUuc2hvd0xhYmVscyA9IGZhbHNlOwogICAgICAgICAgICAgIHNjb3BlLnJvd3MgPSBzcGxpdCh5ZWFycywgdGhpcy5zcGxpdCk7CiAgICAgICAgICAgICAgdGhpcy5idWlsdCA9IHRydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzU2VsZWN0ZWQ6IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcGlja2VyLiRkYXRlICYmIGRhdGUuZ2V0RnVsbFllYXIoKSA9PT0gcGlja2VyLiRkYXRlLmdldEZ1bGxZZWFyKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzRGlzYWJsZWQ6IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgICAgICB2YXIgbGFzdERhdGUgPSArbmV3IERhdGUoZGF0ZS5nZXRGdWxsWWVhcigpICsgMSwgMCwgMCk7CiAgICAgICAgICAgICAgcmV0dXJuIGxhc3REYXRlIDwgb3B0aW9ucy5taW5EYXRlIHx8IGRhdGUuZ2V0VGltZSgpID4gb3B0aW9ucy5tYXhEYXRlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvbktleURvd246IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgICAgIHZhciBhY3R1YWxZZWFyID0gcGlja2VyLiRkYXRlLmdldEZ1bGxZZWFyKCksCiAgICAgICAgICAgICAgICAgIG5ld0RhdGUgPSBuZXcgRGF0ZShwaWNrZXIuJGRhdGUpOwoKICAgICAgICAgICAgICBpZihldnQua2V5Q29kZSA9PT0gMzcpIG5ld0RhdGUuc2V0WWVhcihhY3R1YWxZZWFyIC0gMSk7CiAgICAgICAgICAgICAgZWxzZSBpZihldnQua2V5Q29kZSA9PT0gMzgpIG5ld0RhdGUuc2V0WWVhcihhY3R1YWxZZWFyIC0gNCk7CiAgICAgICAgICAgICAgZWxzZSBpZihldnQua2V5Q29kZSA9PT0gMzkpIG5ld0RhdGUuc2V0WWVhcihhY3R1YWxZZWFyICsgMSk7CiAgICAgICAgICAgICAgZWxzZSBpZihldnQua2V5Q29kZSA9PT0gNDApIG5ld0RhdGUuc2V0WWVhcihhY3R1YWxZZWFyICsgNCk7CgogICAgICAgICAgICAgIGlmICghdGhpcy5pc0Rpc2FibGVkKG5ld0RhdGUpKSBwaWNrZXIuc2VsZWN0KG5ld0RhdGUsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9XTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHZpZXdzOiBvcHRpb25zLm1pblZpZXcgPyBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh2aWV3cywgb3B0aW9ucy5taW5WaWV3KSA6IHZpZXdzLAogICAgICAgICAgdmlld0RhdGU6IHZpZXdEYXRlCiAgICAgICAgfTsKCiAgICAgIH07CgogICAgfV07CgogIH0pOwoKLy8gU291cmNlOiBkYXRlLXBhcnNlci5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAuaGVscGVycy5kYXRlUGFyc2VyJywgW10pCgoucHJvdmlkZXIoJyRkYXRlUGFyc2VyJywgWyIkbG9jYWxlUHJvdmlkZXIiLCBmdW5jdGlvbigkbG9jYWxlUHJvdmlkZXIpIHsKCiAgLy8gZGVmaW5lIGEgY3VzdG9tIFBhcnNlRGF0ZSBvYmplY3QgdG8gdXNlIGluc3RlYWQgb2YgbmF0aXZlIERhdGUgCiAgLy8gdG8gYXZvaWQgZGF0ZSB2YWx1ZXMgd3JhcHBpbmcgd2hlbiBzZXR0aW5nIGRhdGUgY29tcG9uZW50IHZhbHVlcwogIGZ1bmN0aW9uIFBhcnNlRGF0ZSgpIHsKICAgIHRoaXMueWVhciA9IDE5NzA7CiAgICB0aGlzLm1vbnRoID0gMDsKICAgIHRoaXMuZGF5ID0gMTsKICAgIHRoaXMuaG91cnMgPSAwOwogICAgdGhpcy5taW51dGVzID0gMDsKICAgIHRoaXMuc2Vjb25kcyA9IDA7CiAgICB0aGlzLm1pbGxpc2Vjb25kcyA9IDA7CiAgfQoKICBQYXJzZURhdGUucHJvdG90eXBlLnNldE1pbGxpc2Vjb25kcyA9IGZ1bmN0aW9uKHZhbHVlKSB7IHRoaXMubWlsbGlzZWNvbmRzID0gdmFsdWU7IH07CiAgUGFyc2VEYXRlLnByb3RvdHlwZS5zZXRTZWNvbmRzID0gZnVuY3Rpb24odmFsdWUpIHsgdGhpcy5zZWNvbmRzID0gdmFsdWU7IH07CiAgUGFyc2VEYXRlLnByb3RvdHlwZS5zZXRNaW51dGVzID0gZnVuY3Rpb24odmFsdWUpIHsgdGhpcy5taW51dGVzID0gdmFsdWU7IH07CiAgUGFyc2VEYXRlLnByb3RvdHlwZS5zZXRIb3VycyA9IGZ1bmN0aW9uKHZhbHVlKSB7IHRoaXMuaG91cnMgPSB2YWx1ZTsgfTsKICBQYXJzZURhdGUucHJvdG90eXBlLmdldEhvdXJzID0gZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzLmhvdXJzOyB9OwogIFBhcnNlRGF0ZS5wcm90b3R5cGUuc2V0RGF0ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7IHRoaXMuZGF5ID0gdmFsdWU7IH07CiAgUGFyc2VEYXRlLnByb3RvdHlwZS5zZXRNb250aCA9IGZ1bmN0aW9uKHZhbHVlKSB7IHRoaXMubW9udGggPSB2YWx1ZTsgfTsKICBQYXJzZURhdGUucHJvdG90eXBlLnNldEZ1bGxZZWFyID0gZnVuY3Rpb24odmFsdWUpIHsgdGhpcy55ZWFyID0gdmFsdWU7IH07CiAgUGFyc2VEYXRlLnByb3RvdHlwZS5mcm9tRGF0ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB0aGlzLnllYXIgPSB2YWx1ZS5nZXRGdWxsWWVhcigpOwogICAgdGhpcy5tb250aCA9IHZhbHVlLmdldE1vbnRoKCk7CiAgICB0aGlzLmRheSA9IHZhbHVlLmdldERhdGUoKTsKICAgIHRoaXMuaG91cnMgPSB2YWx1ZS5nZXRIb3VycygpOwogICAgdGhpcy5taW51dGVzID0gdmFsdWUuZ2V0TWludXRlcygpOwogICAgdGhpcy5zZWNvbmRzID0gdmFsdWUuZ2V0U2Vjb25kcygpOwogICAgdGhpcy5taWxsaXNlY29uZHMgPSB2YWx1ZS5nZXRNaWxsaXNlY29uZHMoKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIFBhcnNlRGF0ZS5wcm90b3R5cGUudG9EYXRlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IERhdGUodGhpcy55ZWFyLCB0aGlzLm1vbnRoLCB0aGlzLmRheSwgdGhpcy5ob3VycywgdGhpcy5taW51dGVzLCB0aGlzLnNlY29uZHMsIHRoaXMubWlsbGlzZWNvbmRzKTsKICB9OwoKICB2YXIgcHJvdG8gPSBQYXJzZURhdGUucHJvdG90eXBlOwoKICBmdW5jdGlvbiBub29wKCkgewogIH0KCiAgZnVuY3Rpb24gaXNOdW1lcmljKG4pIHsKICAgIHJldHVybiAhaXNOYU4ocGFyc2VGbG9hdChuKSkgJiYgaXNGaW5pdGUobik7CiAgfQoKICBmdW5jdGlvbiBpbmRleE9mQ2FzZUluc2Vuc2l0aXZlKGFycmF5LCB2YWx1ZSkgewogICAgdmFyIGxlbiA9IGFycmF5Lmxlbmd0aCwgc3RyPXZhbHVlLnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKTsKICAgIGZvciAodmFyIGk9MDsgaTxsZW47IGkrKykgewogICAgICBpZiAoYXJyYXlbaV0udG9Mb3dlckNhc2UoKSA9PT0gc3RyKSB7IHJldHVybiBpOyB9CiAgICB9CiAgICByZXR1cm4gLTE7IC8vIFJldHVybiAtMSBwZXIgdGhlICJBcnJheS5pbmRleE9mKCkiIG1ldGhvZC4gICAgCiAgfQoKICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgZm9ybWF0OiAnc2hvcnREYXRlJywKICAgIHN0cmljdDogZmFsc2UKICB9OwoKICB0aGlzLiRnZXQgPSBbIiRsb2NhbGUiLCAiZGF0ZUZpbHRlciIsIGZ1bmN0aW9uKCRsb2NhbGUsIGRhdGVGaWx0ZXIpIHsKCiAgICB2YXIgRGF0ZVBhcnNlckZhY3RvcnkgPSBmdW5jdGlvbihjb25maWcpIHsKCiAgICAgIHZhciBvcHRpb25zID0gYW5ndWxhci5leHRlbmQoe30sIGRlZmF1bHRzLCBjb25maWcpOwoKICAgICAgdmFyICRkYXRlUGFyc2VyID0ge307CgogICAgICB2YXIgcmVnRXhwTWFwID0gewogICAgICAgICdzc3MnICAgOiAnWzAtOV17M30nLAogICAgICAgICdzcycgICAgOiAnWzAtNV1bMC05XScsCiAgICAgICAgJ3MnICAgICA6IG9wdGlvbnMuc3RyaWN0ID8gJ1sxLTVdP1swLTldJyA6ICdbMC05XXxbMC01XVswLTldJywKICAgICAgICAnbW0nICAgIDogJ1swLTVdWzAtOV0nLAogICAgICAgICdtJyAgICAgOiBvcHRpb25zLnN0cmljdCA/ICdbMS01XT9bMC05XScgOiAnWzAtOV18WzAtNV1bMC05XScsCiAgICAgICAgJ0hIJyAgICA6ICdbMDFdWzAtOV18MlswLTNdJywKICAgICAgICAnSCcgICAgIDogb3B0aW9ucy5zdHJpY3QgPyAnMT9bMC05XXwyWzAtM10nIDogJ1swMV0/WzAtOV18MlswLTNdJywKICAgICAgICAnaGgnICAgIDogJ1swXVsxLTldfFsxXVswMTJdJywKICAgICAgICAnaCcgICAgIDogb3B0aW9ucy5zdHJpY3QgPyAnWzEtOV18MVswMTJdJyA6ICcwP1sxLTldfDFbMDEyXScsCiAgICAgICAgJ2EnICAgICA6ICdBTXxQTScsCiAgICAgICAgJ0VFRUUnICA6ICRsb2NhbGUuREFURVRJTUVfRk9STUFUUy5EQVkuam9pbignfCcpLAogICAgICAgICdFRUUnICAgOiAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFMuU0hPUlREQVkuam9pbignfCcpLAogICAgICAgICdkZCcgICAgOiAnMFsxLTldfFsxMl1bMC05XXwzWzAxXScsCiAgICAgICAgJ2QnICAgICA6IG9wdGlvbnMuc3RyaWN0ID8gJ1sxLTldfFsxLTJdWzAtOV18M1swMV0nIDogJzA/WzEtOV18WzEtMl1bMC05XXwzWzAxXScsCiAgICAgICAgJ01NTU0nICA6ICRsb2NhbGUuREFURVRJTUVfRk9STUFUUy5NT05USC5qb2luKCd8JyksCiAgICAgICAgJ01NTScgICA6ICRsb2NhbGUuREFURVRJTUVfRk9STUFUUy5TSE9SVE1PTlRILmpvaW4oJ3wnKSwKICAgICAgICAnTU0nICAgIDogJzBbMS05XXwxWzAxMl0nLAogICAgICAgICdNJyAgICAgOiBvcHRpb25zLnN0cmljdCA/ICdbMS05XXwxWzAxMl0nIDogJzA/WzEtOV18MVswMTJdJywKICAgICAgICAneXl5eScgIDogJ1sxXXsxfVswLTldezN9fFsyXXsxfVswLTldezN9JywKICAgICAgICAneXknICAgIDogJ1swLTldezJ9JywKICAgICAgICAneScgICAgIDogb3B0aW9ucy5zdHJpY3QgPyAnLT8oMHxbMS05XVswLTldezAsM30pJyA6ICctPzAqWzAtOV17MSw0fScsCiAgICAgIH07CgogICAgICB2YXIgc2V0Rm5NYXAgPSB7CiAgICAgICAgJ3NzcycgICA6IHByb3RvLnNldE1pbGxpc2Vjb25kcywKICAgICAgICAnc3MnICAgIDogcHJvdG8uc2V0U2Vjb25kcywKICAgICAgICAncycgICAgIDogcHJvdG8uc2V0U2Vjb25kcywKICAgICAgICAnbW0nICAgIDogcHJvdG8uc2V0TWludXRlcywKICAgICAgICAnbScgICAgIDogcHJvdG8uc2V0TWludXRlcywKICAgICAgICAnSEgnICAgIDogcHJvdG8uc2V0SG91cnMsCiAgICAgICAgJ0gnICAgICA6IHByb3RvLnNldEhvdXJzLAogICAgICAgICdoaCcgICAgOiBwcm90by5zZXRIb3VycywKICAgICAgICAnaCcgICAgIDogcHJvdG8uc2V0SG91cnMsCiAgICAgICAgJ0VFRUUnICA6IG5vb3AsCiAgICAgICAgJ0VFRScgICA6IG5vb3AsCiAgICAgICAgJ2RkJyAgICA6IHByb3RvLnNldERhdGUsCiAgICAgICAgJ2QnICAgICA6IHByb3RvLnNldERhdGUsCiAgICAgICAgJ2EnICAgICA6IGZ1bmN0aW9uKHZhbHVlKSB7IHZhciBob3VycyA9IHRoaXMuZ2V0SG91cnMoKSAlIDEyOyByZXR1cm4gdGhpcy5zZXRIb3Vycyh2YWx1ZS5tYXRjaCgvcG0vaSkgPyBob3VycyArIDEyIDogaG91cnMpOyB9LAogICAgICAgICdNTU1NJyAgOiBmdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdGhpcy5zZXRNb250aChpbmRleE9mQ2FzZUluc2Vuc2l0aXZlKCRsb2NhbGUuREFURVRJTUVfRk9STUFUUy5NT05USCwgdmFsdWUpKTsgfSwKICAgICAgICAnTU1NJyAgIDogZnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIHRoaXMuc2V0TW9udGgoaW5kZXhPZkNhc2VJbnNlbnNpdGl2ZSgkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFMuU0hPUlRNT05USCwgdmFsdWUpKTsgfSwKICAgICAgICAnTU0nICAgIDogZnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIHRoaXMuc2V0TW9udGgoMSAqIHZhbHVlIC0gMSk7IH0sCiAgICAgICAgJ00nICAgICA6IGZ1bmN0aW9uKHZhbHVlKSB7IHJldHVybiB0aGlzLnNldE1vbnRoKDEgKiB2YWx1ZSAtIDEpOyB9LAogICAgICAgICd5eXl5JyAgOiBwcm90by5zZXRGdWxsWWVhciwKICAgICAgICAneXknICAgIDogZnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIHRoaXMuc2V0RnVsbFllYXIoMjAwMCArIDEgKiB2YWx1ZSk7IH0sCiAgICAgICAgJ3knICAgICA6IHByb3RvLnNldEZ1bGxZZWFyCiAgICAgIH07CgogICAgICB2YXIgcmVnZXgsIHNldE1hcDsKCiAgICAgICRkYXRlUGFyc2VyLmluaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAkZGF0ZVBhcnNlci4kZm9ybWF0ID0gJGxvY2FsZS5EQVRFVElNRV9GT1JNQVRTW29wdGlvbnMuZm9ybWF0XSB8fCBvcHRpb25zLmZvcm1hdDsKICAgICAgICByZWdleCA9IHJlZ0V4cEZvckZvcm1hdCgkZGF0ZVBhcnNlci4kZm9ybWF0KTsKICAgICAgICBzZXRNYXAgPSBzZXRNYXBGb3JGb3JtYXQoJGRhdGVQYXJzZXIuJGZvcm1hdCk7CiAgICAgIH07CgogICAgICAkZGF0ZVBhcnNlci5pc1ZhbGlkID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgIGlmKGFuZ3VsYXIuaXNEYXRlKGRhdGUpKSByZXR1cm4gIWlzTmFOKGRhdGUuZ2V0VGltZSgpKTsKICAgICAgICByZXR1cm4gcmVnZXgudGVzdChkYXRlKTsKICAgICAgfTsKCiAgICAgICRkYXRlUGFyc2VyLnBhcnNlID0gZnVuY3Rpb24odmFsdWUsIGJhc2VEYXRlLCBmb3JtYXQpIHsKICAgICAgICBpZihhbmd1bGFyLmlzRGF0ZSh2YWx1ZSkpIHZhbHVlID0gZGF0ZUZpbHRlcih2YWx1ZSwgZm9ybWF0IHx8ICRkYXRlUGFyc2VyLiRmb3JtYXQpOwogICAgICAgIHZhciBmb3JtYXRSZWdleCA9IGZvcm1hdCA/IHJlZ0V4cEZvckZvcm1hdChmb3JtYXQpIDogcmVnZXg7CiAgICAgICAgdmFyIGZvcm1hdFNldE1hcCA9IGZvcm1hdCA/IHNldE1hcEZvckZvcm1hdChmb3JtYXQpIDogc2V0TWFwOwogICAgICAgIHZhciBtYXRjaGVzID0gZm9ybWF0UmVnZXguZXhlYyh2YWx1ZSk7CiAgICAgICAgaWYoIW1hdGNoZXMpIHJldHVybiBmYWxzZTsKICAgICAgICAvLyB1c2UgY3VzdG9tIFBhcnNlRGF0ZSBvYmplY3QgdG8gc2V0IHBhcnNlZCB2YWx1ZXMKICAgICAgICB2YXIgZGF0ZSA9IGJhc2VEYXRlICYmICFpc05hTihiYXNlRGF0ZS5nZXRUaW1lKCkpID8gbmV3IFBhcnNlRGF0ZSgpLmZyb21EYXRlKGJhc2VEYXRlKSA6IG5ldyBQYXJzZURhdGUoKS5mcm9tRGF0ZShuZXcgRGF0ZSgxOTcwLCAwLCAxLCAwKSk7CiAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IG1hdGNoZXMubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICBmb3JtYXRTZXRNYXBbaV0gJiYgZm9ybWF0U2V0TWFwW2ldLmNhbGwoZGF0ZSwgbWF0Y2hlc1tpKzFdKTsKICAgICAgICB9CiAgICAgICAgLy8gY29udmVydCBiYWNrIHRvIG5hdGl2ZSBEYXRlIG9iamVjdAogICAgICAgIHJldHVybiBkYXRlLnRvRGF0ZSgpOwogICAgICB9OwoKICAgICAgJGRhdGVQYXJzZXIuZ2V0RGF0ZUZvckF0dHJpYnV0ZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICB2YXIgZGF0ZTsKCiAgICAgICAgaWYodmFsdWUgPT09ICd0b2RheScpIHsKICAgICAgICAgIHZhciB0b2RheSA9IG5ldyBEYXRlKCk7CiAgICAgICAgICBkYXRlID0gbmV3IERhdGUodG9kYXkuZ2V0RnVsbFllYXIoKSwgdG9kYXkuZ2V0TW9udGgoKSwgdG9kYXkuZ2V0RGF0ZSgpICsgKGtleSA9PT0gJ21heERhdGUnID8gMSA6IDApLCAwLCAwLCAwLCAoa2V5ID09PSAnbWluRGF0ZScgPyAwIDogLTEpKTsKICAgICAgICB9IGVsc2UgaWYoYW5ndWxhci5pc1N0cmluZyh2YWx1ZSkgJiYgdmFsdWUubWF0Y2goL14iLisiJC8pKSB7IC8vIFN1cHBvcnQge3sgZGF0ZU9iaiB9fQogICAgICAgICAgZGF0ZSA9IG5ldyBEYXRlKHZhbHVlLnN1YnN0cigxLCB2YWx1ZS5sZW5ndGggLSAyKSk7CiAgICAgICAgfSBlbHNlIGlmKGlzTnVtZXJpYyh2YWx1ZSkpIHsKICAgICAgICAgIGRhdGUgPSBuZXcgRGF0ZShwYXJzZUludCh2YWx1ZSwgMTApKTsKICAgICAgICB9IGVsc2UgaWYgKGFuZ3VsYXIuaXNTdHJpbmcodmFsdWUpICYmIDAgPT09IHZhbHVlLmxlbmd0aCkgeyAvLyBSZXNldCBkYXRlCiAgICAgICAgICBkYXRlID0ga2V5ID09PSAnbWluRGF0ZScgPyAtSW5maW5pdHkgOiArSW5maW5pdHk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRhdGUgPSBuZXcgRGF0ZSh2YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZGF0ZTsKICAgICAgfTsKCiAgICAgICRkYXRlUGFyc2VyLmdldFRpbWVGb3JBdHRyaWJ1dGUgPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgdmFyIHRpbWU7CgogICAgICAgIGlmKHZhbHVlID09PSAnbm93JykgewogICAgICAgICAgdGltZSA9IG5ldyBEYXRlKCkuc2V0RnVsbFllYXIoMTk3MCwgMCwgMSk7CiAgICAgICAgfSBlbHNlIGlmKGFuZ3VsYXIuaXNTdHJpbmcodmFsdWUpICYmIHZhbHVlLm1hdGNoKC9eIi4rIiQvKSkgewogICAgICAgICAgdGltZSA9IG5ldyBEYXRlKHZhbHVlLnN1YnN0cigxLCB2YWx1ZS5sZW5ndGggLSAyKSkuc2V0RnVsbFllYXIoMTk3MCwgMCwgMSk7CiAgICAgICAgfSBlbHNlIGlmKGlzTnVtZXJpYyh2YWx1ZSkpIHsKICAgICAgICAgIHRpbWUgPSBuZXcgRGF0ZShwYXJzZUludCh2YWx1ZSwgMTApKS5zZXRGdWxsWWVhcigxOTcwLCAwLCAxKTsKICAgICAgICB9IGVsc2UgaWYgKGFuZ3VsYXIuaXNTdHJpbmcodmFsdWUpICYmIDAgPT09IHZhbHVlLmxlbmd0aCkgeyAvLyBSZXNldCB0aW1lCiAgICAgICAgICB0aW1lID0ga2V5ID09PSAnbWluVGltZScgPyAtSW5maW5pdHkgOiArSW5maW5pdHk7CiAgICAgICAgfSBlbHNlIHsgCiAgICAgICAgICB0aW1lID0gJGRhdGVQYXJzZXIucGFyc2UodmFsdWUsIG5ldyBEYXRlKDE5NzAsIDAsIDEsIDApKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aW1lOwogICAgICB9OwoKICAgICAgLy8gUHJpdmF0ZSBmdW5jdGlvbnMKCiAgICAgIGZ1bmN0aW9uIHNldE1hcEZvckZvcm1hdChmb3JtYXQpIHsKICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHNldEZuTWFwKSwgaTsKICAgICAgICB2YXIgbWFwID0gW10sIHNvcnRlZE1hcCA9IFtdOwogICAgICAgIC8vIE1hcCB0byBzZXRGbgogICAgICAgIHZhciBjbG9uZWRGb3JtYXQgPSBmb3JtYXQ7CiAgICAgICAgZm9yKGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYoZm9ybWF0LnNwbGl0KGtleXNbaV0pLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0gY2xvbmVkRm9ybWF0LnNlYXJjaChrZXlzW2ldKTsKICAgICAgICAgICAgZm9ybWF0ID0gZm9ybWF0LnNwbGl0KGtleXNbaV0pLmpvaW4oJycpOwogICAgICAgICAgICBpZihzZXRGbk1hcFtrZXlzW2ldXSkgewogICAgICAgICAgICAgIG1hcFtpbmRleF0gPSBzZXRGbk1hcFtrZXlzW2ldXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBTb3J0IHJlc3VsdCBtYXAKICAgICAgICBhbmd1bGFyLmZvckVhY2gobWFwLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAvLyBjb25kaXRpb25hbCByZXF1aXJlZCBzaW5jZSBhbmd1bGFyLmZvckVhY2ggYnJva2UgYXJvdW5kIHYxLjIuMjEKICAgICAgICAgIC8vIHJlbGF0ZWQgcHI6IGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvcHVsbC84NTI1CiAgICAgICAgICBpZih2KSBzb3J0ZWRNYXAucHVzaCh2KTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gc29ydGVkTWFwOwogICAgICB9CgogICAgICBmdW5jdGlvbiBlc2NhcGVSZXNlcnZlZFN5bWJvbHModGV4dCkgewogICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UoL1wvL2csICdbXFwvXScpLnJlcGxhY2UoJy8tL2cnLCAnWy1dJykucmVwbGFjZSgvXC4vZywgJ1suXScpLnJlcGxhY2UoL1xccy9nLCAnW1xcc10nKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcmVnRXhwRm9yRm9ybWF0KGZvcm1hdCkgewogICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMocmVnRXhwTWFwKSwgaTsKCiAgICAgICAgdmFyIHJlID0gZm9ybWF0OwogICAgICAgIC8vIEFic3RyYWN0IHJlcGxhY2VzIHRvIGF2b2lkIGNvbGxpc2lvbnMKICAgICAgICBmb3IoaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZSA9IHJlLnNwbGl0KGtleXNbaV0pLmpvaW4oJyR7JyArIGkgKyAnfScpOwogICAgICAgIH0KICAgICAgICAvLyBSZXBsYWNlIGFic3RyYWN0ZWQgdmFsdWVzCiAgICAgICAgZm9yKGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgcmUgPSByZS5zcGxpdCgnJHsnICsgaSArICd9Jykuam9pbignKCcgKyByZWdFeHBNYXBba2V5c1tpXV0gKyAnKScpOwogICAgICAgIH0KICAgICAgICBmb3JtYXQgPSBlc2NhcGVSZXNlcnZlZFN5bWJvbHMoZm9ybWF0KTsKCiAgICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcmUgKyAnJCcsIFsnaSddKTsKICAgICAgfQoKICAgICAgJGRhdGVQYXJzZXIuaW5pdCgpOwogICAgICByZXR1cm4gJGRhdGVQYXJzZXI7CgogICAgfTsKCiAgICByZXR1cm4gRGF0ZVBhcnNlckZhY3Rvcnk7CgogIH1dOwoKfV0pOwoKLy8gU291cmNlOiBkZWJvdW5jZS5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAuaGVscGVycy5kZWJvdW5jZScsIFtdKQoKLy8gQHNvdXJjZSBqYXNoa2VuYXMvdW5kZXJzY29yZQovLyBAdXJsIGh0dHBzOi8vZ2l0aHViLmNvbS9qYXNoa2VuYXMvdW5kZXJzY29yZS9ibG9iLzEuNS4yL3VuZGVyc2NvcmUuanMjTDY5MwouZmFjdG9yeSgnZGVib3VuY2UnLCBbIiR0aW1lb3V0IiwgZnVuY3Rpb24oJHRpbWVvdXQpIHsKICByZXR1cm4gZnVuY3Rpb24oZnVuYywgd2FpdCwgaW1tZWRpYXRlKSB7CiAgICB2YXIgdGltZW91dCA9IG51bGw7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBjb250ZXh0ID0gdGhpcywKICAgICAgICBhcmdzID0gYXJndW1lbnRzLAogICAgICAgIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgIGlmKHRpbWVvdXQpIHsKICAgICAgICAkdGltZW91dC5jYW5jZWwodGltZW91dCk7CiAgICAgIH0KICAgICAgdGltZW91dCA9ICR0aW1lb3V0KGZ1bmN0aW9uIGxhdGVyKCkgewogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIGlmKCFpbW1lZGlhdGUpIHsKICAgICAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfQogICAgICB9LCB3YWl0LCBmYWxzZSk7CiAgICAgIGlmKGNhbGxOb3cpIHsKICAgICAgICBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICB9CiAgICAgIHJldHVybiB0aW1lb3V0OwogICAgfTsKICB9Owp9XSkKCgovLyBAc291cmNlIGphc2hrZW5hcy91bmRlcnNjb3JlCi8vIEB1cmwgaHR0cHM6Ly9naXRodWIuY29tL2phc2hrZW5hcy91bmRlcnNjb3JlL2Jsb2IvMS41LjIvdW5kZXJzY29yZS5qcyNMNjYxCi5mYWN0b3J5KCd0aHJvdHRsZScsIFsiJHRpbWVvdXQiLCBmdW5jdGlvbigkdGltZW91dCkgewogIHJldHVybiBmdW5jdGlvbihmdW5jLCB3YWl0LCBvcHRpb25zKSB7CiAgICB2YXIgdGltZW91dCA9IG51bGw7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgY29udGV4dCA9IHRoaXMsCiAgICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgaWYoIXRpbWVvdXQpIHsKICAgICAgICBpZihvcHRpb25zLmxlYWRpbmcgIT09IGZhbHNlKSB7CiAgICAgICAgICBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIH0KICAgICAgICB0aW1lb3V0ID0gJHRpbWVvdXQoZnVuY3Rpb24gbGF0ZXIoKSB7CiAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgIGlmKG9wdGlvbnMudHJhaWxpbmcgIT09IGZhbHNlKSB7CiAgICAgICAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfSwgd2FpdCwgZmFsc2UpOwogICAgICB9CiAgICB9OwogIH07Cn1dKTsKCi8vIFNvdXJjZTogZGltZW5zaW9ucy5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAuaGVscGVycy5kaW1lbnNpb25zJywgW10pCgogIC5mYWN0b3J5KCdkaW1lbnNpb25zJywgWyIkZG9jdW1lbnQiLCAiJHdpbmRvdyIsIGZ1bmN0aW9uKCRkb2N1bWVudCwgJHdpbmRvdykgewoKICAgIHZhciBqcUxpdGUgPSBhbmd1bGFyLmVsZW1lbnQ7CiAgICB2YXIgZm4gPSB7fTsKCiAgICAvKioKICAgICAqIFRlc3QgdGhlIGVsZW1lbnQgbm9kZU5hbWUKICAgICAqIEBwYXJhbSBlbGVtZW50CiAgICAgKiBAcGFyYW0gbmFtZQogICAgICovCiAgICB2YXIgbm9kZU5hbWUgPSBmbi5ub2RlTmFtZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQubm9kZU5hbWUgJiYgZWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICB9OwoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgZWxlbWVudCBjb21wdXRlZCBzdHlsZQogICAgICogQHBhcmFtIGVsZW1lbnQKICAgICAqIEBwYXJhbSBwcm9wCiAgICAgKiBAcGFyYW0gZXh0cmEKICAgICAqLwogICAgZm4uY3NzID0gZnVuY3Rpb24oZWxlbWVudCwgcHJvcCwgZXh0cmEpIHsKICAgICAgdmFyIHZhbHVlOwogICAgICBpZiAoZWxlbWVudC5jdXJyZW50U3R5bGUpIHsgLy9JRQogICAgICAgIHZhbHVlID0gZWxlbWVudC5jdXJyZW50U3R5bGVbcHJvcF07CiAgICAgIH0gZWxzZSBpZiAod2luZG93LmdldENvbXB1dGVkU3R5bGUpIHsKICAgICAgICB2YWx1ZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQpW3Byb3BdOwogICAgICB9IGVsc2UgewogICAgICAgIHZhbHVlID0gZWxlbWVudC5zdHlsZVtwcm9wXTsKICAgICAgfQogICAgICByZXR1cm4gZXh0cmEgPT09IHRydWUgPyBwYXJzZUZsb2F0KHZhbHVlKSB8fCAwIDogdmFsdWU7CiAgICB9OwoKICAgIC8qKgogICAgICogUHJvdmlkZXMgcmVhZC1vbmx5IGVxdWl2YWxlbnQgb2YgalF1ZXJ5J3Mgb2Zmc2V0IGZ1bmN0aW9uOgogICAgICogQHJlcXVpcmVkLWJ5IGJvb3RzdHJhcC10b29sdGlwLCBib290c3RyYXAtYWZmaXgKICAgICAqIEB1cmwgaHR0cDovL2FwaS5qcXVlcnkuY29tL29mZnNldC8KICAgICAqIEBwYXJhbSBlbGVtZW50CiAgICAgKi8KICAgIGZuLm9mZnNldCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgdmFyIGJveFJlY3QgPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICB2YXIgZG9jRWxlbWVudCA9IGVsZW1lbnQub3duZXJEb2N1bWVudDsKICAgICAgcmV0dXJuIHsKICAgICAgICB3aWR0aDogYm94UmVjdC53aWR0aCB8fCBlbGVtZW50Lm9mZnNldFdpZHRoLAogICAgICAgIGhlaWdodDogYm94UmVjdC5oZWlnaHQgfHwgZWxlbWVudC5vZmZzZXRIZWlnaHQsCiAgICAgICAgdG9wOiBib3hSZWN0LnRvcCArICh3aW5kb3cucGFnZVlPZmZzZXQgfHwgZG9jRWxlbWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wKSAtIChkb2NFbGVtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRUb3AgfHwgMCksCiAgICAgICAgbGVmdDogYm94UmVjdC5sZWZ0ICsgKHdpbmRvdy5wYWdlWE9mZnNldCB8fCBkb2NFbGVtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0KSAtIChkb2NFbGVtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRMZWZ0IHx8IDApCiAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogUHJvdmlkZXMgcmVhZC1vbmx5IGVxdWl2YWxlbnQgb2YgalF1ZXJ5J3MgcG9zaXRpb24gZnVuY3Rpb24KICAgICAqIEByZXF1aXJlZC1ieSBib290c3RyYXAtdG9vbHRpcCwgYm9vdHN0cmFwLWFmZml4CiAgICAgKiBAdXJsIGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9vZmZzZXQvCiAgICAgKiBAcGFyYW0gZWxlbWVudAogICAgICovCiAgICBmbi5wb3NpdGlvbiA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKCiAgICAgIHZhciBvZmZzZXRQYXJlbnRSZWN0ID0ge3RvcDogMCwgbGVmdDogMH0sCiAgICAgICAgICBvZmZzZXRQYXJlbnRFbGVtZW50LAogICAgICAgICAgb2Zmc2V0OwoKICAgICAgLy8gRml4ZWQgZWxlbWVudHMgYXJlIG9mZnNldCBmcm9tIHdpbmRvdyAocGFyZW50T2Zmc2V0ID0ge3RvcDowLCBsZWZ0OiAwfSwgYmVjYXVzZSBpdCBpcyBpdCdzIG9ubHkgb2Zmc2V0IHBhcmVudAogICAgICBpZiAoZm4uY3NzKGVsZW1lbnQsICdwb3NpdGlvbicpID09PSAnZml4ZWQnKSB7CgogICAgICAgIC8vIFdlIGFzc3VtZSB0aGF0IGdldEJvdW5kaW5nQ2xpZW50UmVjdCBpcyBhdmFpbGFibGUgd2hlbiBjb21wdXRlZCBwb3NpdGlvbiBpcyBmaXhlZAogICAgICAgIG9mZnNldCA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CgogICAgICB9IGVsc2UgewoKICAgICAgICAvLyBHZXQgKnJlYWwqIG9mZnNldFBhcmVudEVsZW1lbnQKICAgICAgICBvZmZzZXRQYXJlbnRFbGVtZW50ID0gb2Zmc2V0UGFyZW50KGVsZW1lbnQpOwogICAgICAgIG9mZnNldCA9IGZuLm9mZnNldChlbGVtZW50KTsKCiAgICAgICAgLy8gR2V0IGNvcnJlY3Qgb2Zmc2V0cwogICAgICAgIG9mZnNldCA9IGZuLm9mZnNldChlbGVtZW50KTsKICAgICAgICBpZiAoIW5vZGVOYW1lKG9mZnNldFBhcmVudEVsZW1lbnQsICdodG1sJykpIHsKICAgICAgICAgIG9mZnNldFBhcmVudFJlY3QgPSBmbi5vZmZzZXQob2Zmc2V0UGFyZW50RWxlbWVudCk7CiAgICAgICAgfQoKICAgICAgICAvLyBBZGQgb2Zmc2V0UGFyZW50IGJvcmRlcnMKICAgICAgICBvZmZzZXRQYXJlbnRSZWN0LnRvcCArPSBmbi5jc3Mob2Zmc2V0UGFyZW50RWxlbWVudCwgJ2JvcmRlclRvcFdpZHRoJywgdHJ1ZSk7CiAgICAgICAgb2Zmc2V0UGFyZW50UmVjdC5sZWZ0ICs9IGZuLmNzcyhvZmZzZXRQYXJlbnRFbGVtZW50LCAnYm9yZGVyTGVmdFdpZHRoJywgdHJ1ZSk7CiAgICAgIH0KCiAgICAgIC8vIFN1YnRyYWN0IHBhcmVudCBvZmZzZXRzIGFuZCBlbGVtZW50IG1hcmdpbnMKICAgICAgcmV0dXJuIHsKICAgICAgICB3aWR0aDogZWxlbWVudC5vZmZzZXRXaWR0aCwKICAgICAgICBoZWlnaHQ6IGVsZW1lbnQub2Zmc2V0SGVpZ2h0LAogICAgICAgIHRvcDogb2Zmc2V0LnRvcCAtIG9mZnNldFBhcmVudFJlY3QudG9wIC0gZm4uY3NzKGVsZW1lbnQsICdtYXJnaW5Ub3AnLCB0cnVlKSwKICAgICAgICBsZWZ0OiBvZmZzZXQubGVmdCAtIG9mZnNldFBhcmVudFJlY3QubGVmdCAtIGZuLmNzcyhlbGVtZW50LCAnbWFyZ2luTGVmdCcsIHRydWUpCiAgICAgIH07CgogICAgfTsKCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIGNsb3Nlc3QsIG5vbi1zdGF0aWNhbGx5IHBvc2l0aW9uZWQgb2Zmc2V0UGFyZW50IG9mIGEgZ2l2ZW4gZWxlbWVudAogICAgICogQHJlcXVpcmVkLWJ5IGZuLnBvc2l0aW9uCiAgICAgKiBAcGFyYW0gZWxlbWVudAogICAgICovCiAgICB2YXIgb2Zmc2V0UGFyZW50ID0gZnVuY3Rpb24gb2Zmc2V0UGFyZW50RWxlbWVudChlbGVtZW50KSB7CiAgICAgIHZhciBkb2NFbGVtZW50ID0gZWxlbWVudC5vd25lckRvY3VtZW50OwogICAgICB2YXIgb2Zmc2V0UGFyZW50ID0gZWxlbWVudC5vZmZzZXRQYXJlbnQgfHwgZG9jRWxlbWVudDsKICAgICAgaWYobm9kZU5hbWUob2Zmc2V0UGFyZW50LCAnI2RvY3VtZW50JykpIHJldHVybiBkb2NFbGVtZW50LmRvY3VtZW50RWxlbWVudDsKICAgICAgd2hpbGUob2Zmc2V0UGFyZW50ICYmICFub2RlTmFtZShvZmZzZXRQYXJlbnQsICdodG1sJykgJiYgZm4uY3NzKG9mZnNldFBhcmVudCwgJ3Bvc2l0aW9uJykgPT09ICdzdGF0aWMnKSB7CiAgICAgICAgb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50Lm9mZnNldFBhcmVudDsKICAgICAgfQogICAgICByZXR1cm4gb2Zmc2V0UGFyZW50IHx8IGRvY0VsZW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgfTsKCiAgICAvKioKICAgICAqIFByb3ZpZGVzIGVxdWl2YWxlbnQgb2YgalF1ZXJ5J3MgaGVpZ2h0IGZ1bmN0aW9uCiAgICAgKiBAcmVxdWlyZWQtYnkgYm9vdHN0cmFwLWFmZml4CiAgICAgKiBAdXJsIGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9oZWlnaHQvCiAgICAgKiBAcGFyYW0gZWxlbWVudAogICAgICogQHBhcmFtIG91dGVyCiAgICAgKi8KICAgIGZuLmhlaWdodCA9IGZ1bmN0aW9uKGVsZW1lbnQsIG91dGVyKSB7CiAgICAgIHZhciB2YWx1ZSA9IGVsZW1lbnQub2Zmc2V0SGVpZ2h0OwogICAgICBpZihvdXRlcikgewogICAgICAgIHZhbHVlICs9IGZuLmNzcyhlbGVtZW50LCAnbWFyZ2luVG9wJywgdHJ1ZSkgKyBmbi5jc3MoZWxlbWVudCwgJ21hcmdpbkJvdHRvbScsIHRydWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhbHVlIC09IGZuLmNzcyhlbGVtZW50LCAncGFkZGluZ1RvcCcsIHRydWUpICsgZm4uY3NzKGVsZW1lbnQsICdwYWRkaW5nQm90dG9tJywgdHJ1ZSkgKyBmbi5jc3MoZWxlbWVudCwgJ2JvcmRlclRvcFdpZHRoJywgdHJ1ZSkgKyBmbi5jc3MoZWxlbWVudCwgJ2JvcmRlckJvdHRvbVdpZHRoJywgdHJ1ZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKCiAgICAvKioKICAgICAqIFByb3ZpZGVzIGVxdWl2YWxlbnQgb2YgalF1ZXJ5J3Mgd2lkdGggZnVuY3Rpb24KICAgICAqIEByZXF1aXJlZC1ieSBib290c3RyYXAtYWZmaXgKICAgICAqIEB1cmwgaHR0cDovL2FwaS5qcXVlcnkuY29tL3dpZHRoLwogICAgICogQHBhcmFtIGVsZW1lbnQKICAgICAqIEBwYXJhbSBvdXRlcgogICAgICovCiAgICBmbi53aWR0aCA9IGZ1bmN0aW9uKGVsZW1lbnQsIG91dGVyKSB7CiAgICAgIHZhciB2YWx1ZSA9IGVsZW1lbnQub2Zmc2V0V2lkdGg7CiAgICAgIGlmKG91dGVyKSB7CiAgICAgICAgdmFsdWUgKz0gZm4uY3NzKGVsZW1lbnQsICdtYXJnaW5MZWZ0JywgdHJ1ZSkgKyBmbi5jc3MoZWxlbWVudCwgJ21hcmdpblJpZ2h0JywgdHJ1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgLT0gZm4uY3NzKGVsZW1lbnQsICdwYWRkaW5nTGVmdCcsIHRydWUpICsgZm4uY3NzKGVsZW1lbnQsICdwYWRkaW5nUmlnaHQnLCB0cnVlKSArIGZuLmNzcyhlbGVtZW50LCAnYm9yZGVyTGVmdFdpZHRoJywgdHJ1ZSkgKyBmbi5jc3MoZWxlbWVudCwgJ2JvcmRlclJpZ2h0V2lkdGgnLCB0cnVlKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwoKICAgIHJldHVybiBmbjsKCiAgfV0pOwoKLy8gU291cmNlOiBwYXJzZS1vcHRpb25zLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5oZWxwZXJzLnBhcnNlT3B0aW9ucycsIFtdKQoKICAucHJvdmlkZXIoJyRwYXJzZU9wdGlvbnMnLCBmdW5jdGlvbigpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICByZWdleHA6IC9eXHMqKC4qPykoPzpccythc1xzKyguKj8pKT8oPzpccytncm91cFxzK2J5XHMrKC4qKSk/XHMrZm9yXHMrKD86KFtcJFx3XVtcJFx3XSopfCg/OlwoXHMqKFtcJFx3XVtcJFx3XSopXHMqLFxzKihbXCRcd11bXCRcd10qKVxzKlwpKSlccytpblxzKyguKj8pKD86XHMrdHJhY2tccytieVxzKyguKj8pKT8kLwogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBbIiRwYXJzZSIsICIkcSIsIGZ1bmN0aW9uKCRwYXJzZSwgJHEpIHsKCiAgICAgIGZ1bmN0aW9uIFBhcnNlT3B0aW9uc0ZhY3RvcnkoYXR0ciwgY29uZmlnKSB7CgogICAgICAgIHZhciAkcGFyc2VPcHRpb25zID0ge307CgogICAgICAgIC8vIENvbW1vbiB2YXJzCiAgICAgICAgdmFyIG9wdGlvbnMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgZGVmYXVsdHMsIGNvbmZpZyk7CiAgICAgICAgJHBhcnNlT3B0aW9ucy4kdmFsdWVzID0gW107CgogICAgICAgIC8vIFByaXZhdGUgdmFycwogICAgICAgIHZhciBtYXRjaCwgZGlzcGxheUZuLCB2YWx1ZU5hbWUsIGtleU5hbWUsIGdyb3VwQnlGbiwgdmFsdWVGbiwgdmFsdWVzRm47CgogICAgICAgICRwYXJzZU9wdGlvbnMuaW5pdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgJHBhcnNlT3B0aW9ucy4kbWF0Y2ggPSBtYXRjaCA9IGF0dHIubWF0Y2gob3B0aW9ucy5yZWdleHApOwogICAgICAgICAgZGlzcGxheUZuID0gJHBhcnNlKG1hdGNoWzJdIHx8IG1hdGNoWzFdKSwKICAgICAgICAgIHZhbHVlTmFtZSA9IG1hdGNoWzRdIHx8IG1hdGNoWzZdLAogICAgICAgICAga2V5TmFtZSA9IG1hdGNoWzVdLAogICAgICAgICAgZ3JvdXBCeUZuID0gJHBhcnNlKG1hdGNoWzNdIHx8ICcnKSwKICAgICAgICAgIHZhbHVlRm4gPSAkcGFyc2UobWF0Y2hbMl0gPyBtYXRjaFsxXSA6IHZhbHVlTmFtZSksCiAgICAgICAgICB2YWx1ZXNGbiA9ICRwYXJzZShtYXRjaFs3XSk7CiAgICAgICAgfTsKCiAgICAgICAgJHBhcnNlT3B0aW9ucy52YWx1ZXNGbiA9IGZ1bmN0aW9uKHNjb3BlLCBjb250cm9sbGVyKSB7CiAgICAgICAgICByZXR1cm4gJHEud2hlbih2YWx1ZXNGbihzY29wZSwgY29udHJvbGxlcikpCiAgICAgICAgICAudGhlbihmdW5jdGlvbih2YWx1ZXMpIHsKICAgICAgICAgICAgJHBhcnNlT3B0aW9ucy4kdmFsdWVzID0gdmFsdWVzID8gcGFyc2VWYWx1ZXModmFsdWVzLCBzY29wZSkgOiB7fTsKICAgICAgICAgICAgcmV0dXJuICRwYXJzZU9wdGlvbnMuJHZhbHVlczsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgICRwYXJzZU9wdGlvbnMuZGlzcGxheVZhbHVlID0gZnVuY3Rpb24obW9kZWxWYWx1ZSkgewogICAgICAgICAgdmFyIHNjb3BlID0ge307CiAgICAgICAgICBzY29wZVt2YWx1ZU5hbWVdID0gbW9kZWxWYWx1ZTsKICAgICAgICAgIHJldHVybiBkaXNwbGF5Rm4oc2NvcGUpOwogICAgICAgIH07CgogICAgICAgIC8vIFByaXZhdGUgZnVuY3Rpb25zCgogICAgICAgIGZ1bmN0aW9uIHBhcnNlVmFsdWVzKHZhbHVlcywgc2NvcGUpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZXMubWFwKGZ1bmN0aW9uKG1hdGNoLCBpbmRleCkgewogICAgICAgICAgICB2YXIgbG9jYWxzID0ge30sIGxhYmVsLCB2YWx1ZTsKICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBtYXRjaDsKICAgICAgICAgICAgbGFiZWwgPSBkaXNwbGF5Rm4oc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgIHZhbHVlID0gdmFsdWVGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgcmV0dXJuIHtsYWJlbDogbGFiZWwsIHZhbHVlOiB2YWx1ZSwgaW5kZXg6IGluZGV4fTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgJHBhcnNlT3B0aW9ucy5pbml0KCk7CiAgICAgICAgcmV0dXJuICRwYXJzZU9wdGlvbnM7CgogICAgICB9CgogICAgICByZXR1cm4gUGFyc2VPcHRpb25zRmFjdG9yeTsKCiAgICB9XTsKCiAgfSk7CgovLyBTb3VyY2U6IHJhZi5qcwooYW5ndWxhci52ZXJzaW9uLm1pbm9yIDwgMyAmJiBhbmd1bGFyLnZlcnNpb24uZG90IDwgMTQpICYmIGFuZ3VsYXIubW9kdWxlKCduZycpCgouZmFjdG9yeSgnJCRyQUYnLCBbIiR3aW5kb3ciLCAiJHRpbWVvdXQiLCBmdW5jdGlvbigkd2luZG93LCAkdGltZW91dCkgewoKICB2YXIgcmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gJHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CgogIHZhciBjYW5jZWxBbmltYXRpb25GcmFtZSA9ICR3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93LndlYmtpdENhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHdpbmRvdy5tb3pDYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3aW5kb3cud2Via2l0Q2FuY2VsUmVxdWVzdEFuaW1hdGlvbkZyYW1lOwoKICB2YXIgcmFmU3VwcG9ydGVkID0gISFyZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CiAgdmFyIHJhZiA9IHJhZlN1cHBvcnRlZCA/CiAgICBmdW5jdGlvbihmbikgewogICAgICB2YXIgaWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZm4pOwogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoaWQpOwogICAgICB9OwogICAgfSA6CiAgICBmdW5jdGlvbihmbikgewogICAgICB2YXIgdGltZXIgPSAkdGltZW91dChmbiwgMTYuNjYsIGZhbHNlKTsgLy8gMTAwMCAvIDYwID0gMTYuNjY2CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAkdGltZW91dC5jYW5jZWwodGltZXIpOwogICAgICB9OwogICAgfTsKCiAgcmFmLnN1cHBvcnRlZCA9IHJhZlN1cHBvcnRlZDsKCiAgcmV0dXJuIHJhZjsKCn1dKTsKCi8vIC5mYWN0b3J5KCckJGFuaW1hdGVSZWZsb3cnLCBmdW5jdGlvbigkJHJBRiwgJGRvY3VtZW50KSB7CgovLyAgIHZhciBib2R5RWwgPSAkZG9jdW1lbnRbMF0uYm9keTsKCi8vICAgcmV0dXJuIGZ1bmN0aW9uKGZuKSB7Ci8vICAgICAvL3RoZSByZXR1cm5lZCBmdW5jdGlvbiBhY3RzIGFzIHRoZSBjYW5jZWxsYXRpb24gZnVuY3Rpb24KLy8gICAgIHJldHVybiAkJHJBRihmdW5jdGlvbigpIHsKLy8gICAgICAgLy90aGUgbGluZSBiZWxvdyB3aWxsIGZvcmNlIHRoZSBicm93c2VyIHRvIHBlcmZvcm0gYSByZXBhaW50Ci8vICAgICAgIC8vc28gdGhhdCBhbGwgdGhlIGFuaW1hdGVkIGVsZW1lbnRzIHdpdGhpbiB0aGUgYW5pbWF0aW9uIGZyYW1lCi8vICAgICAgIC8vd2lsbCBiZSBwcm9wZXJseSB1cGRhdGVkIGFuZCBkcmF3biBvbiBzY3JlZW4uIFRoaXMgaXMKLy8gICAgICAgLy9yZXF1aXJlZCB0byBwZXJmb3JtIG11bHRpLWNsYXNzIENTUyBiYXNlZCBhbmltYXRpb25zIHdpdGgKLy8gICAgICAgLy9GaXJlZm94LiBETyBOT1QgUkVNT1ZFIFRISVMgTElORS4KLy8gICAgICAgdmFyIGEgPSBib2R5RWwub2Zmc2V0V2lkdGggKyAxOwovLyAgICAgICBmbigpOwovLyAgICAgfSk7Ci8vICAgfTsKCi8vIH0pOwoKLy8gU291cmNlOiBkcm9wZG93bi5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAuZHJvcGRvd24nLCBbJ21nY3JlYS5uZ1N0cmFwLnRvb2x0aXAnXSkKCiAgLnByb3ZpZGVyKCckZHJvcGRvd24nLCBmdW5jdGlvbigpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICBhbmltYXRpb246ICdhbS1mYWRlJywKICAgICAgcHJlZml4Q2xhc3M6ICdkcm9wZG93bicsCiAgICAgIHBsYWNlbWVudDogJ2JvdHRvbS1sZWZ0JywKICAgICAgdGVtcGxhdGU6ICdkcm9wZG93bi9kcm9wZG93bi50cGwuaHRtbCcsCiAgICAgIHRyaWdnZXI6ICdjbGljaycsCiAgICAgIGNvbnRhaW5lcjogZmFsc2UsCiAgICAgIGtleWJvYXJkOiB0cnVlLAogICAgICBodG1sOiBmYWxzZSwKICAgICAgZGVsYXk6IDAKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gWyIkd2luZG93IiwgIiRyb290U2NvcGUiLCAiJHRvb2x0aXAiLCBmdW5jdGlvbigkd2luZG93LCAkcm9vdFNjb3BlLCAkdG9vbHRpcCkgewoKICAgICAgdmFyIGJvZHlFbCA9IGFuZ3VsYXIuZWxlbWVudCgkd2luZG93LmRvY3VtZW50LmJvZHkpOwogICAgICB2YXIgbWF0Y2hlc1NlbGVjdG9yID0gRWxlbWVudC5wcm90b3R5cGUubWF0Y2hlc1NlbGVjdG9yIHx8IEVsZW1lbnQucHJvdG90eXBlLndlYmtpdE1hdGNoZXNTZWxlY3RvciB8fCBFbGVtZW50LnByb3RvdHlwZS5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudC5wcm90b3R5cGUubXNNYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudC5wcm90b3R5cGUub01hdGNoZXNTZWxlY3RvcjsKCiAgICAgIGZ1bmN0aW9uIERyb3Bkb3duRmFjdG9yeShlbGVtZW50LCBjb25maWcpIHsKCiAgICAgICAgdmFyICRkcm9wZG93biA9IHt9OwoKICAgICAgICAvLyBDb21tb24gdmFycwogICAgICAgIHZhciBvcHRpb25zID0gYW5ndWxhci5leHRlbmQoe30sIGRlZmF1bHRzLCBjb25maWcpOwogICAgICAgIHZhciBzY29wZSA9ICRkcm9wZG93bi4kc2NvcGUgPSBvcHRpb25zLnNjb3BlICYmIG9wdGlvbnMuc2NvcGUuJG5ldygpIHx8ICRyb290U2NvcGUuJG5ldygpOwoKICAgICAgICAkZHJvcGRvd24gPSAkdG9vbHRpcChlbGVtZW50LCBvcHRpb25zKTsKICAgICAgICB2YXIgcGFyZW50RWwgPSBlbGVtZW50LnBhcmVudCgpOwoKICAgICAgICAvLyBQcm90ZWN0ZWQgbWV0aG9kcwoKICAgICAgICAkZHJvcGRvd24uJG9uS2V5RG93biA9IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgaWYgKCEvKDM4fDQwKS8udGVzdChldnQua2V5Q29kZSkpIHJldHVybjsKICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwoKICAgICAgICAgIC8vIFJldHJpZXZlIGZvY3VzZWQgaW5kZXgKICAgICAgICAgIHZhciBpdGVtcyA9IGFuZ3VsYXIuZWxlbWVudCgkZHJvcGRvd24uJGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvckFsbCgnbGk6bm90KC5kaXZpZGVyKSBhJykpOwogICAgICAgICAgaWYoIWl0ZW1zLmxlbmd0aCkgcmV0dXJuOwogICAgICAgICAgdmFyIGluZGV4OwogICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGl0ZW1zLCBmdW5jdGlvbihlbCwgaSkgewogICAgICAgICAgICBpZihtYXRjaGVzU2VsZWN0b3IgJiYgbWF0Y2hlc1NlbGVjdG9yLmNhbGwoZWwsICc6Zm9jdXMnKSkgaW5kZXggPSBpOwogICAgICAgICAgfSk7CgogICAgICAgICAgLy8gTmF2aWdhdGUgd2l0aCBrZXlib2FyZAogICAgICAgICAgaWYoZXZ0LmtleUNvZGUgPT09IDM4ICYmIGluZGV4ID4gMCkgaW5kZXgtLTsKICAgICAgICAgIGVsc2UgaWYoZXZ0LmtleUNvZGUgPT09IDQwICYmIGluZGV4IDwgaXRlbXMubGVuZ3RoIC0gMSkgaW5kZXgrKzsKICAgICAgICAgIGVsc2UgaWYoYW5ndWxhci5pc1VuZGVmaW5lZChpbmRleCkpIGluZGV4ID0gMDsKICAgICAgICAgIGl0ZW1zLmVxKGluZGV4KVswXS5mb2N1cygpOwoKICAgICAgICB9OwoKICAgICAgICAvLyBPdmVycmlkZXMKCiAgICAgICAgdmFyIHNob3cgPSAkZHJvcGRvd24uc2hvdzsKICAgICAgICAkZHJvcGRvd24uc2hvdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hvdygpOwogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgb3B0aW9ucy5rZXlib2FyZCAmJiAkZHJvcGRvd24uJGVsZW1lbnQub24oJ2tleWRvd24nLCAkZHJvcGRvd24uJG9uS2V5RG93bik7CiAgICAgICAgICAgIGJvZHlFbC5vbignY2xpY2snLCBvbkJvZHlDbGljayk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHBhcmVudEVsLmhhc0NsYXNzKCdkcm9wZG93bicpICYmIHBhcmVudEVsLmFkZENsYXNzKCdvcGVuJyk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIGhpZGUgPSAkZHJvcGRvd24uaGlkZTsKICAgICAgICAkZHJvcGRvd24uaGlkZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYoISRkcm9wZG93bi4kaXNTaG93bikgcmV0dXJuOwogICAgICAgICAgb3B0aW9ucy5rZXlib2FyZCAmJiAkZHJvcGRvd24uJGVsZW1lbnQub2ZmKCdrZXlkb3duJywgJGRyb3Bkb3duLiRvbktleURvd24pOwogICAgICAgICAgYm9keUVsLm9mZignY2xpY2snLCBvbkJvZHlDbGljayk7CiAgICAgICAgICBwYXJlbnRFbC5oYXNDbGFzcygnZHJvcGRvd24nKSAmJiBwYXJlbnRFbC5yZW1vdmVDbGFzcygnb3BlbicpOwogICAgICAgICAgaGlkZSgpOwogICAgICAgIH07CgogICAgICAgIC8vIFByaXZhdGUgZnVuY3Rpb25zCgogICAgICAgIGZ1bmN0aW9uIG9uQm9keUNsaWNrKGV2dCkgewogICAgICAgICAgaWYoZXZ0LnRhcmdldCA9PT0gZWxlbWVudFswXSkgcmV0dXJuOwogICAgICAgICAgcmV0dXJuIGV2dC50YXJnZXQgIT09IGVsZW1lbnRbMF0gJiYgJGRyb3Bkb3duLmhpZGUoKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkZHJvcGRvd247CgogICAgICB9CgogICAgICByZXR1cm4gRHJvcGRvd25GYWN0b3J5OwoKICAgIH1dOwoKICB9KQoKICAuZGlyZWN0aXZlKCdic0Ryb3Bkb3duJywgWyIkd2luZG93IiwgIiRzY2UiLCAiJGRyb3Bkb3duIiwgZnVuY3Rpb24oJHdpbmRvdywgJHNjZSwgJGRyb3Bkb3duKSB7CgogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFQUMnLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIHRyYW5zY2x1c2lvbikgewoKICAgICAgICAvLyBEaXJlY3RpdmUgb3B0aW9ucwogICAgICAgIHZhciBvcHRpb25zID0ge3Njb3BlOiBzY29wZX07CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsncGxhY2VtZW50JywgJ2NvbnRhaW5lcicsICdkZWxheScsICd0cmlnZ2VyJywgJ2tleWJvYXJkJywgJ2h0bWwnLCAnYW5pbWF0aW9uJywgJ3RlbXBsYXRlJ10sIGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgaWYoYW5ndWxhci5pc0RlZmluZWQoYXR0cltrZXldKSkgb3B0aW9uc1trZXldID0gYXR0cltrZXldOwogICAgICAgIH0pOwoKICAgICAgICAvLyBTdXBwb3J0IHNjb3BlIGFzIGFuIG9iamVjdAogICAgICAgIGF0dHIuYnNEcm9wZG93biAmJiBzY29wZS4kd2F0Y2goYXR0ci5ic0Ryb3Bkb3duLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgIHNjb3BlLmNvbnRlbnQgPSBuZXdWYWx1ZTsKICAgICAgICB9LCB0cnVlKTsKCiAgICAgICAgLy8gVmlzaWJpbGl0eSBiaW5kaW5nIHN1cHBvcnQKICAgICAgICBhdHRyLmJzU2hvdyAmJiBzY29wZS4kd2F0Y2goYXR0ci5ic1Nob3csIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgaWYoIWRyb3Bkb3duIHx8ICFhbmd1bGFyLmlzRGVmaW5lZChuZXdWYWx1ZSkpIHJldHVybjsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNTdHJpbmcobmV3VmFsdWUpKSBuZXdWYWx1ZSA9ICEhbmV3VmFsdWUubWF0Y2goL3RydWV8LD8oZHJvcGRvd24pLD8vaSk7CiAgICAgICAgICBuZXdWYWx1ZSA9PT0gdHJ1ZSA/IGRyb3Bkb3duLnNob3coKSA6IGRyb3Bkb3duLmhpZGUoKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSBkcm9wZG93bgogICAgICAgIHZhciBkcm9wZG93biA9ICRkcm9wZG93bihlbGVtZW50LCBvcHRpb25zKTsKCiAgICAgICAgLy8gR2FyYmFnZSBjb2xsZWN0aW9uCiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKGRyb3Bkb3duKSBkcm9wZG93bi5kZXN0cm95KCk7CiAgICAgICAgICBvcHRpb25zID0gbnVsbDsKICAgICAgICAgIGRyb3Bkb3duID0gbnVsbDsKICAgICAgICB9KTsKCiAgICAgIH0KICAgIH07CgogIH1dKTsKCi8vIFNvdXJjZTogbW9kYWwuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLm1vZGFsJywgWydtZ2NyZWEubmdTdHJhcC5oZWxwZXJzLmRpbWVuc2lvbnMnXSkKCiAgLnByb3ZpZGVyKCckbW9kYWwnLCBmdW5jdGlvbigpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICBhbmltYXRpb246ICdhbS1mYWRlJywKICAgICAgYmFja2Ryb3BBbmltYXRpb246ICdhbS1mYWRlJywKICAgICAgcHJlZml4Q2xhc3M6ICdtb2RhbCcsCiAgICAgIHByZWZpeEV2ZW50OiAnbW9kYWwnLAogICAgICBwbGFjZW1lbnQ6ICd0b3AnLAogICAgICB0ZW1wbGF0ZTogJ21vZGFsL21vZGFsLnRwbC5odG1sJywKICAgICAgY29udGVudFRlbXBsYXRlOiBmYWxzZSwKICAgICAgY29udGFpbmVyOiBmYWxzZSwKICAgICAgZWxlbWVudDogbnVsbCwKICAgICAgYmFja2Ryb3A6IHRydWUsCiAgICAgIGtleWJvYXJkOiB0cnVlLAogICAgICBodG1sOiBmYWxzZSwKICAgICAgc2hvdzogdHJ1ZQogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBbIiR3aW5kb3ciLCAiJHJvb3RTY29wZSIsICIkY29tcGlsZSIsICIkcSIsICIkdGVtcGxhdGVDYWNoZSIsICIkaHR0cCIsICIkYW5pbWF0ZSIsICIkdGltZW91dCIsICIkc2NlIiwgImRpbWVuc2lvbnMiLCBmdW5jdGlvbigkd2luZG93LCAkcm9vdFNjb3BlLCAkY29tcGlsZSwgJHEsICR0ZW1wbGF0ZUNhY2hlLCAkaHR0cCwgJGFuaW1hdGUsICR0aW1lb3V0LCAkc2NlLCBkaW1lbnNpb25zKSB7CgogICAgICB2YXIgZm9yRWFjaCA9IGFuZ3VsYXIuZm9yRWFjaDsKICAgICAgdmFyIHRyaW0gPSBTdHJpbmcucHJvdG90eXBlLnRyaW07CiAgICAgIHZhciByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSAkd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCAkd2luZG93LnNldFRpbWVvdXQ7CiAgICAgIHZhciBib2R5RWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudCgkd2luZG93LmRvY3VtZW50LmJvZHkpOwogICAgICB2YXIgaHRtbFJlcGxhY2VSZWdFeHAgPSAvbmctYmluZD0iL2lnOwoKICAgICAgZnVuY3Rpb24gTW9kYWxGYWN0b3J5KGNvbmZpZykgewoKICAgICAgICB2YXIgJG1vZGFsID0ge307CgogICAgICAgIC8vIENvbW1vbiB2YXJzCiAgICAgICAgdmFyIG9wdGlvbnMgPSAkbW9kYWwuJG9wdGlvbnMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgZGVmYXVsdHMsIGNvbmZpZyk7CiAgICAgICAgJG1vZGFsLiRwcm9taXNlID0gZmV0Y2hUZW1wbGF0ZShvcHRpb25zLnRlbXBsYXRlKTsKICAgICAgICB2YXIgc2NvcGUgPSAkbW9kYWwuJHNjb3BlID0gb3B0aW9ucy5zY29wZSAmJiBvcHRpb25zLnNjb3BlLiRuZXcoKSB8fCAkcm9vdFNjb3BlLiRuZXcoKTsKICAgICAgICBpZighb3B0aW9ucy5lbGVtZW50ICYmICFvcHRpb25zLmNvbnRhaW5lcikgewogICAgICAgICAgb3B0aW9ucy5jb250YWluZXIgPSAnYm9keSc7CiAgICAgICAgfQoKICAgICAgICAvLyBTdXBwb3J0IHNjb3BlIGFzIHN0cmluZyBvcHRpb25zCiAgICAgICAgZm9yRWFjaChbJ3RpdGxlJywgJ2NvbnRlbnQnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBpZihvcHRpb25zW2tleV0pIHNjb3BlW2tleV0gPSAkc2NlLnRydXN0QXNIdG1sKG9wdGlvbnNba2V5XSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIFByb3ZpZGUgc2NvcGUgaGVscGVycwogICAgICAgIHNjb3BlLiRoaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBzY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRtb2RhbC5oaWRlKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIHNjb3BlLiRzaG93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBzY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRtb2RhbC5zaG93KCk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIHNjb3BlLiR0b2dnbGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJG1vZGFsLnRvZ2dsZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gU3VwcG9ydCBjb250ZW50VGVtcGxhdGUgb3B0aW9uCiAgICAgICAgaWYob3B0aW9ucy5jb250ZW50VGVtcGxhdGUpIHsKICAgICAgICAgICRtb2RhbC4kcHJvbWlzZSA9ICRtb2RhbC4kcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZUVsID0gYW5ndWxhci5lbGVtZW50KHRlbXBsYXRlKTsKICAgICAgICAgICAgcmV0dXJuIGZldGNoVGVtcGxhdGUob3B0aW9ucy5jb250ZW50VGVtcGxhdGUpCiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKGNvbnRlbnRUZW1wbGF0ZSkgewogICAgICAgICAgICAgIHZhciBjb250ZW50RWwgPSBmaW5kRWxlbWVudCgnW25nLWJpbmQ9ImNvbnRlbnQiXScsIHRlbXBsYXRlRWxbMF0pLnJlbW92ZUF0dHIoJ25nLWJpbmQnKS5odG1sKGNvbnRlbnRUZW1wbGF0ZSk7CiAgICAgICAgICAgICAgLy8gRHJvcCB0aGUgZGVmYXVsdCBmb290ZXIgYXMgeW91IHByb2JhYmx5IGRvbid0IHdhbnQgaXQgaWYgeW91IHVzZSBhIGN1c3RvbSBjb250ZW50VGVtcGxhdGUKICAgICAgICAgICAgICBpZighY29uZmlnLnRlbXBsYXRlKSBjb250ZW50RWwubmV4dCgpLnJlbW92ZSgpOwogICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZUVsWzBdLm91dGVySFRNTDsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEZldGNoLCBjb21waWxlIHRoZW4gaW5pdGlhbGl6ZSBtb2RhbAogICAgICAgIHZhciBtb2RhbExpbmtlciwgbW9kYWxFbGVtZW50OwogICAgICAgIHZhciBiYWNrZHJvcEVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoJzxkaXYgY2xhc3M9IicgKyBvcHRpb25zLnByZWZpeENsYXNzICsgJy1iYWNrZHJvcCIvPicpOwogICAgICAgICRtb2RhbC4kcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHRlbXBsYXRlKSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzT2JqZWN0KHRlbXBsYXRlKSkgdGVtcGxhdGUgPSB0ZW1wbGF0ZS5kYXRhOwogICAgICAgICAgaWYob3B0aW9ucy5odG1sKSB0ZW1wbGF0ZSA9IHRlbXBsYXRlLnJlcGxhY2UoaHRtbFJlcGxhY2VSZWdFeHAsICduZy1iaW5kLWh0bWw9IicpOwogICAgICAgICAgdGVtcGxhdGUgPSB0cmltLmFwcGx5KHRlbXBsYXRlKTsKICAgICAgICAgIG1vZGFsTGlua2VyID0gJGNvbXBpbGUodGVtcGxhdGUpOwogICAgICAgICAgJG1vZGFsLmluaXQoKTsKICAgICAgICB9KTsKCiAgICAgICAgJG1vZGFsLmluaXQgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAvLyBPcHRpb25zOiBzaG93CiAgICAgICAgICBpZihvcHRpb25zLnNob3cpIHsKICAgICAgICAgICAgc2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICRtb2RhbC5zaG93KCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICB9OwoKICAgICAgICAkbW9kYWwuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoKICAgICAgICAgIC8vIFJlbW92ZSBlbGVtZW50CiAgICAgICAgICBpZihtb2RhbEVsZW1lbnQpIHsKICAgICAgICAgICAgbW9kYWxFbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICBtb2RhbEVsZW1lbnQgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYoYmFja2Ryb3BFbGVtZW50KSB7CiAgICAgICAgICAgIGJhY2tkcm9wRWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgYmFja2Ryb3BFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBEZXN0cm95IHNjb3BlCiAgICAgICAgICBzY29wZS4kZGVzdHJveSgpOwoKICAgICAgICB9OwoKICAgICAgICAkbW9kYWwuc2hvdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYoc2NvcGUuJGlzU2hvd24pIHJldHVybjsKCiAgICAgICAgICBpZihzY29wZS4kZW1pdChvcHRpb25zLnByZWZpeEV2ZW50ICsgJy5zaG93LmJlZm9yZScsICRtb2RhbCkuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGFyZW50OwogICAgICAgICAgaWYoYW5ndWxhci5pc0VsZW1lbnQob3B0aW9ucy5jb250YWluZXIpKSB7CiAgICAgICAgICAgIHBhcmVudCA9IG9wdGlvbnMuY29udGFpbmVyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFyZW50ID0gb3B0aW9ucy5jb250YWluZXIgPyBmaW5kRWxlbWVudChvcHRpb25zLmNvbnRhaW5lcikgOiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGFmdGVyID0gb3B0aW9ucy5jb250YWluZXIgPyBudWxsIDogb3B0aW9ucy5lbGVtZW50OwoKICAgICAgICAgIC8vIEZldGNoIGEgY2xvbmVkIGVsZW1lbnQgbGlua2VkIGZyb20gdGVtcGxhdGUKICAgICAgICAgIG1vZGFsRWxlbWVudCA9ICRtb2RhbC4kZWxlbWVudCA9IG1vZGFsTGlua2VyKHNjb3BlLCBmdW5jdGlvbihjbG9uZWRFbGVtZW50LCBzY29wZSkge30pOwoKICAgICAgICAgIC8vIFNldCB0aGUgaW5pdGlhbCBwb3NpdGlvbmluZy4KICAgICAgICAgIG1vZGFsRWxlbWVudC5jc3Moe2Rpc3BsYXk6ICdibG9jayd9KS5hZGRDbGFzcyhvcHRpb25zLnBsYWNlbWVudCk7CgogICAgICAgICAgLy8gT3B0aW9uczogYW5pbWF0aW9uCiAgICAgICAgICBpZihvcHRpb25zLmFuaW1hdGlvbikgewogICAgICAgICAgICBpZihvcHRpb25zLmJhY2tkcm9wKSB7CiAgICAgICAgICAgICAgYmFja2Ryb3BFbGVtZW50LmFkZENsYXNzKG9wdGlvbnMuYmFja2Ryb3BBbmltYXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1vZGFsRWxlbWVudC5hZGRDbGFzcyhvcHRpb25zLmFuaW1hdGlvbik7CiAgICAgICAgICB9CgogICAgICAgICAgaWYob3B0aW9ucy5iYWNrZHJvcCkgewogICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihiYWNrZHJvcEVsZW1lbnQsIGJvZHlFbGVtZW50LCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFN1cHBvcnQgdjEuMysgJGFuaW1hdGUKICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvY29tbWl0L2JmMGY1NTAyYjFiYmZkZGM1Y2RkMmYxMzhlZmQ5MTg4YjhjNjUyYTkKICAgICAgICAgIHZhciBwcm9taXNlID0gJGFuaW1hdGUuZW50ZXIobW9kYWxFbGVtZW50LCBwYXJlbnQsIGFmdGVyLCBlbnRlckFuaW1hdGVDYWxsYmFjayk7CiAgICAgICAgICBpZihwcm9taXNlICYmIHByb21pc2UudGhlbikgcHJvbWlzZS50aGVuKGVudGVyQW5pbWF0ZUNhbGxiYWNrKTsKCiAgICAgICAgICBzY29wZS4kaXNTaG93biA9IHRydWU7CiAgICAgICAgICBzY29wZS4kJHBoYXNlIHx8IChzY29wZS4kcm9vdCAmJiBzY29wZS4kcm9vdC4kJHBoYXNlKSB8fCBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAvLyBGb2N1cyBvbmNlIHRoZSBlbnRlci1hbmltYXRpb24gaGFzIHN0YXJ0ZWQKICAgICAgICAgIC8vIFdlaXJkIFBoYW50b21KUyBidWcgaGFjawogICAgICAgICAgdmFyIGVsID0gbW9kYWxFbGVtZW50WzBdOwogICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbC5mb2N1cygpOwogICAgICAgICAgfSk7CgogICAgICAgICAgYm9keUVsZW1lbnQuYWRkQ2xhc3Mob3B0aW9ucy5wcmVmaXhDbGFzcyArICctb3BlbicpOwogICAgICAgICAgaWYob3B0aW9ucy5hbmltYXRpb24pIHsKICAgICAgICAgICAgYm9keUVsZW1lbnQuYWRkQ2xhc3Mob3B0aW9ucy5wcmVmaXhDbGFzcyArICctd2l0aC0nICsgb3B0aW9ucy5hbmltYXRpb24pOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIEJpbmQgZXZlbnRzCiAgICAgICAgICBpZihvcHRpb25zLmJhY2tkcm9wKSB7CiAgICAgICAgICAgIG1vZGFsRWxlbWVudC5vbignY2xpY2snLCBoaWRlT25CYWNrZHJvcENsaWNrKTsKICAgICAgICAgICAgYmFja2Ryb3BFbGVtZW50Lm9uKCdjbGljaycsIGhpZGVPbkJhY2tkcm9wQ2xpY2spOwogICAgICAgICAgfQogICAgICAgICAgaWYob3B0aW9ucy5rZXlib2FyZCkgewogICAgICAgICAgICBtb2RhbEVsZW1lbnQub24oJ2tleXVwJywgJG1vZGFsLiRvbktleVVwKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBlbnRlckFuaW1hdGVDYWxsYmFjaygpIHsKICAgICAgICAgIHNjb3BlLiRlbWl0KG9wdGlvbnMucHJlZml4RXZlbnQgKyAnLnNob3cnLCAkbW9kYWwpOwogICAgICAgIH0KCiAgICAgICAgJG1vZGFsLmhpZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmKCFzY29wZS4kaXNTaG93bikgcmV0dXJuOwoKICAgICAgICAgIGlmKHNjb3BlLiRlbWl0KG9wdGlvbnMucHJlZml4RXZlbnQgKyAnLmhpZGUuYmVmb3JlJywgJG1vZGFsKS5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9taXNlID0gJGFuaW1hdGUubGVhdmUobW9kYWxFbGVtZW50LCBsZWF2ZUFuaW1hdGVDYWxsYmFjayk7CiAgICAgICAgICAvLyBTdXBwb3J0IHYxLjMrICRhbmltYXRlCiAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2NvbW1pdC9iZjBmNTUwMmIxYmJmZGRjNWNkZDJmMTM4ZWZkOTE4OGI4YzY1MmE5CiAgICAgICAgICBpZihwcm9taXNlICYmIHByb21pc2UudGhlbikgcHJvbWlzZS50aGVuKGxlYXZlQW5pbWF0ZUNhbGxiYWNrKTsKCiAgICAgICAgICBpZihvcHRpb25zLmJhY2tkcm9wKSB7CiAgICAgICAgICAgICRhbmltYXRlLmxlYXZlKGJhY2tkcm9wRWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICBzY29wZS4kaXNTaG93biA9IGZhbHNlOwogICAgICAgICAgc2NvcGUuJCRwaGFzZSB8fCAoc2NvcGUuJHJvb3QgJiYgc2NvcGUuJHJvb3QuJCRwaGFzZSkgfHwgc2NvcGUuJGRpZ2VzdCgpOwoKICAgICAgICAgIC8vIFVuYmluZCBldmVudHMKICAgICAgICAgIGlmKG9wdGlvbnMuYmFja2Ryb3ApIHsKICAgICAgICAgICAgbW9kYWxFbGVtZW50Lm9mZignY2xpY2snLCBoaWRlT25CYWNrZHJvcENsaWNrKTsKICAgICAgICAgICAgYmFja2Ryb3BFbGVtZW50Lm9mZignY2xpY2snLCBoaWRlT25CYWNrZHJvcENsaWNrKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmKG9wdGlvbnMua2V5Ym9hcmQpIHsKICAgICAgICAgICAgbW9kYWxFbGVtZW50Lm9mZigna2V5dXAnLCAkbW9kYWwuJG9uS2V5VXApOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIGxlYXZlQW5pbWF0ZUNhbGxiYWNrKCkgewogICAgICAgICAgc2NvcGUuJGVtaXQob3B0aW9ucy5wcmVmaXhFdmVudCArICcuaGlkZScsICRtb2RhbCk7CiAgICAgICAgICBib2R5RWxlbWVudC5yZW1vdmVDbGFzcyhvcHRpb25zLnByZWZpeENsYXNzICsgJy1vcGVuJyk7CiAgICAgICAgICBpZihvcHRpb25zLmFuaW1hdGlvbikgewogICAgICAgICAgICBib2R5RWxlbWVudC5yZW1vdmVDbGFzcyhvcHRpb25zLnByZWZpeENsYXNzICsgJy13aXRoLScgKyBvcHRpb25zLmFuaW1hdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAkbW9kYWwudG9nZ2xlID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgc2NvcGUuJGlzU2hvd24gPyAkbW9kYWwuaGlkZSgpIDogJG1vZGFsLnNob3coKTsKCiAgICAgICAgfTsKCiAgICAgICAgJG1vZGFsLmZvY3VzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBtb2RhbEVsZW1lbnRbMF0uZm9jdXMoKTsKICAgICAgICB9OwoKICAgICAgICAvLyBQcm90ZWN0ZWQgbWV0aG9kcwoKICAgICAgICAkbW9kYWwuJG9uS2V5VXAgPSBmdW5jdGlvbihldnQpIHsKCiAgICAgICAgICBpZiAoZXZ0LndoaWNoID09PSAyNyAmJiBzY29wZS4kaXNTaG93bikgewogICAgICAgICAgICAkbW9kYWwuaGlkZSgpOwogICAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICB9CgogICAgICAgIH07CgogICAgICAgIC8vIFByaXZhdGUgbWV0aG9kcwoKICAgICAgICBmdW5jdGlvbiBoaWRlT25CYWNrZHJvcENsaWNrKGV2dCkgewogICAgICAgICAgaWYoZXZ0LnRhcmdldCAhPT0gZXZ0LmN1cnJlbnRUYXJnZXQpIHJldHVybjsKICAgICAgICAgIG9wdGlvbnMuYmFja2Ryb3AgPT09ICdzdGF0aWMnID8gJG1vZGFsLmZvY3VzKCkgOiAkbW9kYWwuaGlkZSgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRtb2RhbDsKCiAgICAgIH0KCiAgICAgIC8vIEhlbHBlciBmdW5jdGlvbnMKCiAgICAgIGZ1bmN0aW9uIGZpbmRFbGVtZW50KHF1ZXJ5LCBlbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIGFuZ3VsYXIuZWxlbWVudCgoZWxlbWVudCB8fCBkb2N1bWVudCkucXVlcnlTZWxlY3RvckFsbChxdWVyeSkpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBmZXRjaFRlbXBsYXRlKHRlbXBsYXRlKSB7CiAgICAgICAgcmV0dXJuICRxLndoZW4oJHRlbXBsYXRlQ2FjaGUuZ2V0KHRlbXBsYXRlKSB8fCAkaHR0cC5nZXQodGVtcGxhdGUpKQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgaWYoYW5ndWxhci5pc09iamVjdChyZXMpKSB7CiAgICAgICAgICAgICR0ZW1wbGF0ZUNhY2hlLnB1dCh0ZW1wbGF0ZSwgcmVzLmRhdGEpOwogICAgICAgICAgICByZXR1cm4gcmVzLmRhdGE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzOwogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gTW9kYWxGYWN0b3J5OwoKICAgIH1dOwoKICB9KQoKICAuZGlyZWN0aXZlKCdic01vZGFsJywgWyIkd2luZG93IiwgIiRzY2UiLCAiJG1vZGFsIiwgZnVuY3Rpb24oJHdpbmRvdywgJHNjZSwgJG1vZGFsKSB7CgogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFQUMnLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIHRyYW5zY2x1c2lvbikgewoKICAgICAgICAvLyBEaXJlY3RpdmUgb3B0aW9ucwogICAgICAgIHZhciBvcHRpb25zID0ge3Njb3BlOiBzY29wZSwgZWxlbWVudDogZWxlbWVudCwgc2hvdzogZmFsc2V9OwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ3RlbXBsYXRlJywgJ2NvbnRlbnRUZW1wbGF0ZScsICdwbGFjZW1lbnQnLCAnYmFja2Ryb3AnLCAna2V5Ym9hcmQnLCAnaHRtbCcsICdjb250YWluZXInLCAnYW5pbWF0aW9uJ10sIGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgaWYoYW5ndWxhci5pc0RlZmluZWQoYXR0cltrZXldKSkgb3B0aW9uc1trZXldID0gYXR0cltrZXldOwogICAgICAgIH0pOwoKICAgICAgICAvLyBTdXBwb3J0IHNjb3BlIGFzIGRhdGEtYXR0cnMKICAgICAgICBhbmd1bGFyLmZvckVhY2goWyd0aXRsZScsICdjb250ZW50J10sIGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgYXR0cltrZXldICYmIGF0dHIuJG9ic2VydmUoa2V5LCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgc2NvcGVba2V5XSA9ICRzY2UudHJ1c3RBc0h0bWwobmV3VmFsdWUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIFN1cHBvcnQgc2NvcGUgYXMgYW4gb2JqZWN0CiAgICAgICAgYXR0ci5ic01vZGFsICYmIHNjb3BlLiR3YXRjaChhdHRyLmJzTW9kYWwsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgaWYoYW5ndWxhci5pc09iamVjdChuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgYW5ndWxhci5leHRlbmQoc2NvcGUsIG5ld1ZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNjb3BlLmNvbnRlbnQgPSBuZXdWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9LCB0cnVlKTsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSBtb2RhbAogICAgICAgIHZhciBtb2RhbCA9ICRtb2RhbChvcHRpb25zKTsKCiAgICAgICAgLy8gVHJpZ2dlcgogICAgICAgIGVsZW1lbnQub24oYXR0ci50cmlnZ2VyIHx8ICdjbGljaycsIG1vZGFsLnRvZ2dsZSk7CgogICAgICAgIC8vIEdhcmJhZ2UgY29sbGVjdGlvbgogICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChtb2RhbCkgbW9kYWwuZGVzdHJveSgpOwogICAgICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICAgICAgICBtb2RhbCA9IG51bGw7CiAgICAgICAgfSk7CgogICAgICB9CiAgICB9OwoKICB9XSk7CgovLyBTb3VyY2U6IG5hdmJhci5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAubmF2YmFyJywgW10pCgogIC5wcm92aWRlcignJG5hdmJhcicsIGZ1bmN0aW9uKCkgewoKICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgIGFjdGl2ZUNsYXNzOiAnYWN0aXZlJywKICAgICAgcm91dGVBdHRyOiAnZGF0YS1tYXRjaC1yb3V0ZScsCiAgICAgIHN0cmljdDogZmFsc2UKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7ZGVmYXVsdHM6IGRlZmF1bHRzfTsKICAgIH07CgogIH0pCgogIC5kaXJlY3RpdmUoJ2JzTmF2YmFyJywgWyIkd2luZG93IiwgIiRsb2NhdGlvbiIsICIkbmF2YmFyIiwgZnVuY3Rpb24oJHdpbmRvdywgJGxvY2F0aW9uLCAkbmF2YmFyKSB7CgogICAgdmFyIGRlZmF1bHRzID0gJG5hdmJhci5kZWZhdWx0czsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0EnLAogICAgICBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgZWxlbWVudCwgYXR0ciwgY29udHJvbGxlcikgewoKICAgICAgICAvLyBEaXJlY3RpdmUgb3B0aW9ucwogICAgICAgIHZhciBvcHRpb25zID0gYW5ndWxhci5jb3B5KGRlZmF1bHRzKTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goT2JqZWN0LmtleXMoZGVmYXVsdHMpLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNEZWZpbmVkKGF0dHJba2V5XSkpIG9wdGlvbnNba2V5XSA9IGF0dHJba2V5XTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gV2F0Y2ggZm9yIHRoZSAkbG9jYXRpb24KICAgICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7CgogICAgICAgICAgcmV0dXJuICRsb2NhdGlvbi5wYXRoKCk7CgogICAgICAgIH0sIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewoKICAgICAgICAgIHZhciBsaUVsZW1lbnRzID0gZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yQWxsKCdsaVsnICsgb3B0aW9ucy5yb3V0ZUF0dHIgKyAnXScpOwoKICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChsaUVsZW1lbnRzLCBmdW5jdGlvbihsaSkgewoKICAgICAgICAgICAgdmFyIGxpRWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChsaSk7CiAgICAgICAgICAgIHZhciBwYXR0ZXJuID0gbGlFbGVtZW50LmF0dHIob3B0aW9ucy5yb3V0ZUF0dHIpLnJlcGxhY2UoJy8nLCAnXFwvJyk7CiAgICAgICAgICAgIGlmKG9wdGlvbnMuc3RyaWN0KSB7CiAgICAgICAgICAgICAgcGF0dGVybiA9ICdeJyArIHBhdHRlcm4gKyAnJCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAocGF0dGVybiwgWydpJ10pOwoKICAgICAgICAgICAgaWYocmVnZXhwLnRlc3QobmV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgbGlFbGVtZW50LmFkZENsYXNzKG9wdGlvbnMuYWN0aXZlQ2xhc3MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxpRWxlbWVudC5yZW1vdmVDbGFzcyhvcHRpb25zLmFjdGl2ZUNsYXNzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0pOwoKICAgICAgICB9KTsKCiAgICAgIH0KCiAgICB9OwoKICB9XSk7CgovLyBTb3VyY2U6IHBvcG92ZXIuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLnBvcG92ZXInLCBbJ21nY3JlYS5uZ1N0cmFwLnRvb2x0aXAnXSkKCiAgLnByb3ZpZGVyKCckcG9wb3ZlcicsIGZ1bmN0aW9uKCkgewoKICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgIGFuaW1hdGlvbjogJ2FtLWZhZGUnLAogICAgICBjdXN0b21DbGFzczogJycsCiAgICAgIGNvbnRhaW5lcjogZmFsc2UsCiAgICAgIHRhcmdldDogZmFsc2UsCiAgICAgIHBsYWNlbWVudDogJ3JpZ2h0JywKICAgICAgdGVtcGxhdGU6ICdwb3BvdmVyL3BvcG92ZXIudHBsLmh0bWwnLAogICAgICBjb250ZW50VGVtcGxhdGU6IGZhbHNlLAogICAgICB0cmlnZ2VyOiAnY2xpY2snLAogICAgICBrZXlib2FyZDogdHJ1ZSwKICAgICAgaHRtbDogZmFsc2UsCiAgICAgIHRpdGxlOiAnJywKICAgICAgY29udGVudDogJycsCiAgICAgIGRlbGF5OiAwCiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsiJHRvb2x0aXAiLCBmdW5jdGlvbigkdG9vbHRpcCkgewoKICAgICAgZnVuY3Rpb24gUG9wb3ZlckZhY3RvcnkoZWxlbWVudCwgY29uZmlnKSB7CgogICAgICAgIC8vIENvbW1vbiB2YXJzCiAgICAgICAgdmFyIG9wdGlvbnMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgZGVmYXVsdHMsIGNvbmZpZyk7CgogICAgICAgIHZhciAkcG9wb3ZlciA9ICR0b29sdGlwKGVsZW1lbnQsIG9wdGlvbnMpOwoKICAgICAgICAvLyBTdXBwb3J0IHNjb3BlIGFzIHN0cmluZyBvcHRpb25zIFsvKnRpdGxlLCAqL2NvbnRlbnRdCiAgICAgICAgaWYob3B0aW9ucy5jb250ZW50KSB7CiAgICAgICAgICAkcG9wb3Zlci4kc2NvcGUuY29udGVudCA9IG9wdGlvbnMuY29udGVudDsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkcG9wb3ZlcjsKCiAgICAgIH0KCiAgICAgIHJldHVybiBQb3BvdmVyRmFjdG9yeTsKCiAgICB9XTsKCiAgfSkKCiAgLmRpcmVjdGl2ZSgnYnNQb3BvdmVyJywgWyIkd2luZG93IiwgIiRzY2UiLCAiJHBvcG92ZXIiLCBmdW5jdGlvbigkd2luZG93LCAkc2NlLCAkcG9wb3ZlcikgewoKICAgIHZhciByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSAkd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCAkd2luZG93LnNldFRpbWVvdXQ7CgogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFQUMnLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKCiAgICAgICAgLy8gRGlyZWN0aXZlIG9wdGlvbnMKICAgICAgICB2YXIgb3B0aW9ucyA9IHtzY29wZTogc2NvcGV9OwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ3RlbXBsYXRlJywgJ2NvbnRlbnRUZW1wbGF0ZScsICdwbGFjZW1lbnQnLCAnY29udGFpbmVyJywgJ3RhcmdldCcsICdkZWxheScsICd0cmlnZ2VyJywgJ2tleWJvYXJkJywgJ2h0bWwnLCAnYW5pbWF0aW9uJywgJ2N1c3RvbUNsYXNzJ10sIGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgaWYoYW5ndWxhci5pc0RlZmluZWQoYXR0cltrZXldKSkgb3B0aW9uc1trZXldID0gYXR0cltrZXldOwogICAgICAgIH0pOwoKICAgICAgICAvLyBTdXBwb3J0IHNjb3BlIGFzIGRhdGEtYXR0cnMKICAgICAgICBhbmd1bGFyLmZvckVhY2goWyd0aXRsZScsICdjb250ZW50J10sIGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgYXR0cltrZXldICYmIGF0dHIuJG9ic2VydmUoa2V5LCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgc2NvcGVba2V5XSA9ICRzY2UudHJ1c3RBc0h0bWwobmV3VmFsdWUpOwogICAgICAgICAgICBhbmd1bGFyLmlzRGVmaW5lZChvbGRWYWx1ZSkgJiYgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHBvcG92ZXIgJiYgcG9wb3Zlci4kYXBwbHlQbGFjZW1lbnQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gU3VwcG9ydCBzY29wZSBhcyBhbiBvYmplY3QKICAgICAgICBhdHRyLmJzUG9wb3ZlciAmJiBzY29wZS4kd2F0Y2goYXR0ci5ic1BvcG92ZXIsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgaWYoYW5ndWxhci5pc09iamVjdChuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgYW5ndWxhci5leHRlbmQoc2NvcGUsIG5ld1ZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNjb3BlLmNvbnRlbnQgPSBuZXdWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGFuZ3VsYXIuaXNEZWZpbmVkKG9sZFZhbHVlKSAmJiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBvcG92ZXIgJiYgcG9wb3Zlci4kYXBwbHlQbGFjZW1lbnQoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sIHRydWUpOwoKICAgICAgICAvLyBWaXNpYmlsaXR5IGJpbmRpbmcgc3VwcG9ydAogICAgICAgIGF0dHIuYnNTaG93ICYmIHNjb3BlLiR3YXRjaChhdHRyLmJzU2hvdywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICBpZighcG9wb3ZlciB8fCAhYW5ndWxhci5pc0RlZmluZWQobmV3VmFsdWUpKSByZXR1cm47CiAgICAgICAgICBpZihhbmd1bGFyLmlzU3RyaW5nKG5ld1ZhbHVlKSkgbmV3VmFsdWUgPSAhIW5ld1ZhbHVlLm1hdGNoKC90cnVlfCw/KHBvcG92ZXIpLD8vaSk7CiAgICAgICAgICBuZXdWYWx1ZSA9PT0gdHJ1ZSA/IHBvcG92ZXIuc2hvdygpIDogcG9wb3Zlci5oaWRlKCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIEluaXRpYWxpemUgcG9wb3ZlcgogICAgICAgIHZhciBwb3BvdmVyID0gJHBvcG92ZXIoZWxlbWVudCwgb3B0aW9ucyk7CgogICAgICAgIC8vIEdhcmJhZ2UgY29sbGVjdGlvbgogICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChwb3BvdmVyKSBwb3BvdmVyLmRlc3Ryb3koKTsKICAgICAgICAgIG9wdGlvbnMgPSBudWxsOwogICAgICAgICAgcG9wb3ZlciA9IG51bGw7CiAgICAgICAgfSk7CgogICAgICB9CiAgICB9OwoKICB9XSk7CgovLyBTb3VyY2U6IHNjcm9sbHNweS5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAuc2Nyb2xsc3B5JywgWydtZ2NyZWEubmdTdHJhcC5oZWxwZXJzLmRlYm91bmNlJywgJ21nY3JlYS5uZ1N0cmFwLmhlbHBlcnMuZGltZW5zaW9ucyddKQoKICAucHJvdmlkZXIoJyRzY3JvbGxzcHknLCBmdW5jdGlvbigpIHsKCiAgICAvLyBQb29sIG9mIHJlZ2lzdGVyZWQgc3BpZXMKICAgIHZhciBzcGllcyA9IHRoaXMuJCRzcGllcyA9IHt9OwoKICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgIGRlYm91bmNlOiAxNTAsCiAgICAgIHRocm90dGxlOiAxMDAsCiAgICAgIG9mZnNldDogMTAwCiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsiJHdpbmRvdyIsICIkZG9jdW1lbnQiLCAiJHJvb3RTY29wZSIsICJkaW1lbnNpb25zIiwgImRlYm91bmNlIiwgInRocm90dGxlIiwgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCAkcm9vdFNjb3BlLCBkaW1lbnNpb25zLCBkZWJvdW5jZSwgdGhyb3R0bGUpIHsKCiAgICAgIHZhciB3aW5kb3dFbCA9IGFuZ3VsYXIuZWxlbWVudCgkd2luZG93KTsKICAgICAgdmFyIGRvY0VsID0gYW5ndWxhci5lbGVtZW50KCRkb2N1bWVudC5wcm9wKCdkb2N1bWVudEVsZW1lbnQnKSk7CiAgICAgIHZhciBib2R5RWwgPSBhbmd1bGFyLmVsZW1lbnQoJHdpbmRvdy5kb2N1bWVudC5ib2R5KTsKCiAgICAgIC8vIEhlbHBlciBmdW5jdGlvbnMKCiAgICAgIGZ1bmN0aW9uIG5vZGVOYW1lKGVsZW1lbnQsIG5hbWUpIHsKICAgICAgICByZXR1cm4gZWxlbWVudFswXS5ub2RlTmFtZSAmJiBlbGVtZW50WzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gU2Nyb2xsU3B5RmFjdG9yeShjb25maWcpIHsKCiAgICAgICAgLy8gQ29tbW9uIHZhcnMKICAgICAgICB2YXIgb3B0aW9ucyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBkZWZhdWx0cywgY29uZmlnKTsKICAgICAgICBpZighb3B0aW9ucy5lbGVtZW50KSBvcHRpb25zLmVsZW1lbnQgPSBib2R5RWw7CiAgICAgICAgdmFyIGlzV2luZG93U3B5ID0gbm9kZU5hbWUob3B0aW9ucy5lbGVtZW50LCAnYm9keScpOwogICAgICAgIHZhciBzY3JvbGxFbCA9IGlzV2luZG93U3B5ID8gd2luZG93RWwgOiBvcHRpb25zLmVsZW1lbnQ7CiAgICAgICAgdmFyIHNjcm9sbElkID0gaXNXaW5kb3dTcHkgPyAnd2luZG93JyA6IG9wdGlvbnMuaWQ7CgogICAgICAgIC8vIFVzZSBleGlzdGluZyBzcHkKICAgICAgICBpZihzcGllc1tzY3JvbGxJZF0pIHsKICAgICAgICAgIHNwaWVzW3Njcm9sbElkXS4kJGNvdW50Kys7CiAgICAgICAgICByZXR1cm4gc3BpZXNbc2Nyb2xsSWRdOwogICAgICAgIH0KCiAgICAgICAgdmFyICRzY3JvbGxzcHkgPSB7fTsKCiAgICAgICAgLy8gUHJpdmF0ZSB2YXJzCiAgICAgICAgdmFyIHVuYmluZFZpZXdDb250ZW50TG9hZGVkLCB1bmJpbmRJbmNsdWRlQ29udGVudExvYWRlZDsKICAgICAgICB2YXIgdHJhY2tlZEVsZW1lbnRzID0gJHNjcm9sbHNweS4kdHJhY2tlZEVsZW1lbnRzID0gW107CiAgICAgICAgdmFyIHNvcnRlZEVsZW1lbnRzID0gW107CiAgICAgICAgdmFyIGFjdGl2ZVRhcmdldDsKICAgICAgICB2YXIgZGVib3VuY2VkQ2hlY2tQb3NpdGlvbjsKICAgICAgICB2YXIgdGhyb3R0bGVkQ2hlY2tQb3NpdGlvbjsKICAgICAgICB2YXIgZGVib3VuY2VkQ2hlY2tPZmZzZXRzOwogICAgICAgIHZhciB2aWV3cG9ydEhlaWdodDsKICAgICAgICB2YXIgc2Nyb2xsVG9wOwoKICAgICAgICAkc2Nyb2xsc3B5LmluaXQgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAvLyBTZXR1cCBpbnRlcm5hbCByZWYgY291bnRlcgogICAgICAgICAgdGhpcy4kJGNvdW50ID0gMTsKCiAgICAgICAgICAvLyBCaW5kIGV2ZW50cwogICAgICAgICAgZGVib3VuY2VkQ2hlY2tQb3NpdGlvbiA9IGRlYm91bmNlKHRoaXMuY2hlY2tQb3NpdGlvbiwgb3B0aW9ucy5kZWJvdW5jZSk7CiAgICAgICAgICB0aHJvdHRsZWRDaGVja1Bvc2l0aW9uID0gdGhyb3R0bGUodGhpcy5jaGVja1Bvc2l0aW9uLCBvcHRpb25zLnRocm90dGxlKTsKICAgICAgICAgIHNjcm9sbEVsLm9uKCdjbGljaycsIHRoaXMuY2hlY2tQb3NpdGlvbldpdGhFdmVudExvb3ApOwogICAgICAgICAgd2luZG93RWwub24oJ3Jlc2l6ZScsIGRlYm91bmNlZENoZWNrUG9zaXRpb24pOwogICAgICAgICAgc2Nyb2xsRWwub24oJ3Njcm9sbCcsIHRocm90dGxlZENoZWNrUG9zaXRpb24pOwoKICAgICAgICAgIGRlYm91bmNlZENoZWNrT2Zmc2V0cyA9IGRlYm91bmNlKHRoaXMuY2hlY2tPZmZzZXRzLCBvcHRpb25zLmRlYm91bmNlKTsKICAgICAgICAgIHVuYmluZFZpZXdDb250ZW50TG9hZGVkID0gJHJvb3RTY29wZS4kb24oJyR2aWV3Q29udGVudExvYWRlZCcsIGRlYm91bmNlZENoZWNrT2Zmc2V0cyk7CiAgICAgICAgICB1bmJpbmRJbmNsdWRlQ29udGVudExvYWRlZCA9ICRyb290U2NvcGUuJG9uKCckaW5jbHVkZUNvbnRlbnRMb2FkZWQnLCBkZWJvdW5jZWRDaGVja09mZnNldHMpOwogICAgICAgICAgZGVib3VuY2VkQ2hlY2tPZmZzZXRzKCk7CgogICAgICAgICAgLy8gUmVnaXN0ZXIgc3B5IGZvciByZXVzZQogICAgICAgICAgaWYoc2Nyb2xsSWQpIHsKICAgICAgICAgICAgc3BpZXNbc2Nyb2xsSWRdID0gJHNjcm9sbHNweTsKICAgICAgICAgIH0KCiAgICAgICAgfTsKCiAgICAgICAgJHNjcm9sbHNweS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgLy8gQ2hlY2sgaW50ZXJuYWwgcmVmIGNvdW50ZXIKICAgICAgICAgIHRoaXMuJCRjb3VudC0tOwogICAgICAgICAgaWYodGhpcy4kJGNvdW50ID4gMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgLy8gVW5iaW5kIGV2ZW50cwogICAgICAgICAgc2Nyb2xsRWwub2ZmKCdjbGljaycsIHRoaXMuY2hlY2tQb3NpdGlvbldpdGhFdmVudExvb3ApOwogICAgICAgICAgd2luZG93RWwub2ZmKCdyZXNpemUnLCBkZWJvdW5jZWRDaGVja1Bvc2l0aW9uKTsKICAgICAgICAgIHNjcm9sbEVsLm9mZignc2Nyb2xsJywgZGVib3VuY2VkQ2hlY2tQb3NpdGlvbik7CiAgICAgICAgICB1bmJpbmRWaWV3Q29udGVudExvYWRlZCgpOwogICAgICAgICAgdW5iaW5kSW5jbHVkZUNvbnRlbnRMb2FkZWQoKTsKICAgICAgICAgIGlmIChzY3JvbGxJZCkgewogICAgICAgICAgICBkZWxldGUgc3BpZXNbc2Nyb2xsSWRdOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgICRzY3JvbGxzcHkuY2hlY2tQb3NpdGlvbiA9IGZ1bmN0aW9uKCkgewoKICAgICAgICAgIC8vIE5vdCByZWFkeSB5ZXQKICAgICAgICAgIGlmKCFzb3J0ZWRFbGVtZW50cy5sZW5ndGgpIHJldHVybjsKCiAgICAgICAgICAvLyBDYWxjdWxhdGUgdGhlIHNjcm9sbCBwb3NpdGlvbgogICAgICAgICAgc2Nyb2xsVG9wID0gKGlzV2luZG93U3B5ID8gJHdpbmRvdy5wYWdlWU9mZnNldCA6IHNjcm9sbEVsLnByb3AoJ3Njcm9sbFRvcCcpKSB8fCAwOwoKICAgICAgICAgIC8vIENhbGN1bGF0ZSB0aGUgdmlld3BvcnQgaGVpZ2h0IGZvciB1c2UgYnkgdGhlIGNvbXBvbmVudHMKICAgICAgICAgIHZpZXdwb3J0SGVpZ2h0ID0gTWF0aC5tYXgoJHdpbmRvdy5pbm5lckhlaWdodCwgZG9jRWwucHJvcCgnY2xpZW50SGVpZ2h0JykpOwoKICAgICAgICAgIC8vIEFjdGl2YXRlIGZpcnN0IGVsZW1lbnQgaWYgc2Nyb2xsIGlzIHNtYWxsZXIKICAgICAgICAgIGlmKHNjcm9sbFRvcCA8IHNvcnRlZEVsZW1lbnRzWzBdLm9mZnNldFRvcCAmJiBhY3RpdmVUYXJnZXQgIT09IHNvcnRlZEVsZW1lbnRzWzBdLnRhcmdldCkgewogICAgICAgICAgICByZXR1cm4gJHNjcm9sbHNweS4kYWN0aXZhdGVFbGVtZW50KHNvcnRlZEVsZW1lbnRzWzBdKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBBY3RpdmF0ZSBwcm9wZXIgZWxlbWVudAogICAgICAgICAgZm9yICh2YXIgaSA9IHNvcnRlZEVsZW1lbnRzLmxlbmd0aDsgaS0tOykgewogICAgICAgICAgICBpZihhbmd1bGFyLmlzVW5kZWZpbmVkKHNvcnRlZEVsZW1lbnRzW2ldLm9mZnNldFRvcCkgfHwgc29ydGVkRWxlbWVudHNbaV0ub2Zmc2V0VG9wID09PSBudWxsKSBjb250aW51ZTsKICAgICAgICAgICAgaWYoYWN0aXZlVGFyZ2V0ID09PSBzb3J0ZWRFbGVtZW50c1tpXS50YXJnZXQpIGNvbnRpbnVlOwogICAgICAgICAgICBpZihzY3JvbGxUb3AgPCBzb3J0ZWRFbGVtZW50c1tpXS5vZmZzZXRUb3ApIGNvbnRpbnVlOwogICAgICAgICAgICBpZihzb3J0ZWRFbGVtZW50c1tpICsgMV0gJiYgc2Nyb2xsVG9wID4gc29ydGVkRWxlbWVudHNbaSArIDFdLm9mZnNldFRvcCkgY29udGludWU7CiAgICAgICAgICAgIHJldHVybiAkc2Nyb2xsc3B5LiRhY3RpdmF0ZUVsZW1lbnQoc29ydGVkRWxlbWVudHNbaV0pOwogICAgICAgICAgfQoKICAgICAgICB9OwoKICAgICAgICAkc2Nyb2xsc3B5LmNoZWNrUG9zaXRpb25XaXRoRXZlbnRMb29wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KHRoaXMuY2hlY2tQb3NpdGlvbiwgMSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gUHJvdGVjdGVkIG1ldGhvZHMKCiAgICAgICAgJHNjcm9sbHNweS4kYWN0aXZhdGVFbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgaWYoYWN0aXZlVGFyZ2V0KSB7CiAgICAgICAgICAgIHZhciBhY3RpdmVFbGVtZW50ID0gJHNjcm9sbHNweS4kZ2V0VHJhY2tlZEVsZW1lbnQoYWN0aXZlVGFyZ2V0KTsKICAgICAgICAgICAgaWYoYWN0aXZlRWxlbWVudCkgewogICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQuc291cmNlLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsKICAgICAgICAgICAgICBpZihub2RlTmFtZShhY3RpdmVFbGVtZW50LnNvdXJjZSwgJ2xpJykgJiYgbm9kZU5hbWUoYWN0aXZlRWxlbWVudC5zb3VyY2UucGFyZW50KCkucGFyZW50KCksICdsaScpKSB7CiAgICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50LnNvdXJjZS5wYXJlbnQoKS5wYXJlbnQoKS5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBhY3RpdmVUYXJnZXQgPSBlbGVtZW50LnRhcmdldDsKICAgICAgICAgIGVsZW1lbnQuc291cmNlLmFkZENsYXNzKCdhY3RpdmUnKTsKICAgICAgICAgIGlmKG5vZGVOYW1lKGVsZW1lbnQuc291cmNlLCAnbGknKSAmJiBub2RlTmFtZShlbGVtZW50LnNvdXJjZS5wYXJlbnQoKS5wYXJlbnQoKSwgJ2xpJykpIHsKICAgICAgICAgICAgZWxlbWVudC5zb3VyY2UucGFyZW50KCkucGFyZW50KCkuYWRkQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgICRzY3JvbGxzcHkuJGdldFRyYWNrZWRFbGVtZW50ID0gZnVuY3Rpb24odGFyZ2V0KSB7CiAgICAgICAgICByZXR1cm4gdHJhY2tlZEVsZW1lbnRzLmZpbHRlcihmdW5jdGlvbihvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iai50YXJnZXQgPT09IHRhcmdldDsKICAgICAgICAgIH0pWzBdOwogICAgICAgIH07CgogICAgICAgIC8vIFRyYWNrIG9mZnNldHMgYmVoYXZpb3IKCiAgICAgICAgJHNjcm9sbHNweS5jaGVja09mZnNldHMgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICBhbmd1bGFyLmZvckVhY2godHJhY2tlZEVsZW1lbnRzLCBmdW5jdGlvbih0cmFja2VkRWxlbWVudCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0RWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodHJhY2tlZEVsZW1lbnQudGFyZ2V0KTsKICAgICAgICAgICAgdHJhY2tlZEVsZW1lbnQub2Zmc2V0VG9wID0gdGFyZ2V0RWxlbWVudCA/IGRpbWVuc2lvbnMub2Zmc2V0KHRhcmdldEVsZW1lbnQpLnRvcCA6IG51bGw7CiAgICAgICAgICAgIGlmKG9wdGlvbnMub2Zmc2V0ICYmIHRyYWNrZWRFbGVtZW50Lm9mZnNldFRvcCAhPT0gbnVsbCkgdHJhY2tlZEVsZW1lbnQub2Zmc2V0VG9wIC09IG9wdGlvbnMub2Zmc2V0ICogMTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHNvcnRlZEVsZW1lbnRzID0gdHJhY2tlZEVsZW1lbnRzCiAgICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIHJldHVybiBlbC5vZmZzZXRUb3AgIT09IG51bGw7CiAgICAgICAgICB9KQogICAgICAgICAgLnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgICByZXR1cm4gYS5vZmZzZXRUb3AgLSBiLm9mZnNldFRvcDsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGRlYm91bmNlZENoZWNrUG9zaXRpb24oKTsKCiAgICAgICAgfTsKCiAgICAgICAgJHNjcm9sbHNweS50cmFja0VsZW1lbnQgPSBmdW5jdGlvbih0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgdHJhY2tlZEVsZW1lbnRzLnB1c2goe3RhcmdldDogdGFyZ2V0LCBzb3VyY2U6IHNvdXJjZX0pOwogICAgICAgIH07CgogICAgICAgICRzY3JvbGxzcHkudW50cmFja0VsZW1lbnQgPSBmdW5jdGlvbih0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgdmFyIHRvRGVsZXRlOwogICAgICAgICAgZm9yICh2YXIgaSA9IHRyYWNrZWRFbGVtZW50cy5sZW5ndGg7IGktLTspIHsKICAgICAgICAgICAgaWYodHJhY2tlZEVsZW1lbnRzW2ldLnRhcmdldCA9PT0gdGFyZ2V0ICYmIHRyYWNrZWRFbGVtZW50c1tpXS5zb3VyY2UgPT09IHNvdXJjZSkgewogICAgICAgICAgICAgIHRvRGVsZXRlID0gaTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdHJhY2tlZEVsZW1lbnRzID0gdHJhY2tlZEVsZW1lbnRzLnNwbGljZSh0b0RlbGV0ZSwgMSk7CiAgICAgICAgfTsKCiAgICAgICAgJHNjcm9sbHNweS5hY3RpdmF0ZSA9IGZ1bmN0aW9uKGkpIHsKICAgICAgICAgIHRyYWNrZWRFbGVtZW50c1tpXS5hZGRDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSBwbHVnaW4KCiAgICAgICAgJHNjcm9sbHNweS5pbml0KCk7CiAgICAgICAgcmV0dXJuICRzY3JvbGxzcHk7CgogICAgICB9CgogICAgICByZXR1cm4gU2Nyb2xsU3B5RmFjdG9yeTsKCiAgICB9XTsKCiAgfSkKCiAgLmRpcmVjdGl2ZSgnYnNTY3JvbGxzcHknLCBbIiRyb290U2NvcGUiLCAiZGVib3VuY2UiLCAiZGltZW5zaW9ucyIsICIkc2Nyb2xsc3B5IiwgZnVuY3Rpb24oJHJvb3RTY29wZSwgZGVib3VuY2UsIGRpbWVuc2lvbnMsICRzY3JvbGxzcHkpIHsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0VBQycsCiAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CgogICAgICAgIHZhciBvcHRpb25zID0ge3Njb3BlOiBzY29wZX07CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsnb2Zmc2V0JywgJ3RhcmdldCddLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNEZWZpbmVkKGF0dHJba2V5XSkpIG9wdGlvbnNba2V5XSA9IGF0dHJba2V5XTsKICAgICAgICB9KTsKCiAgICAgICAgdmFyIHNjcm9sbHNweSA9ICRzY3JvbGxzcHkob3B0aW9ucyk7CiAgICAgICAgc2Nyb2xsc3B5LnRyYWNrRWxlbWVudChvcHRpb25zLnRhcmdldCwgZWxlbWVudCk7CgogICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChzY3JvbGxzcHkpIHsKICAgICAgICAgICAgc2Nyb2xsc3B5LnVudHJhY2tFbGVtZW50KG9wdGlvbnMudGFyZ2V0LCBlbGVtZW50KTsKICAgICAgICAgICAgc2Nyb2xsc3B5LmRlc3Ryb3koKTsKICAgICAgICAgIH0KICAgICAgICAgIG9wdGlvbnMgPSBudWxsOwogICAgICAgICAgc2Nyb2xsc3B5ID0gbnVsbDsKICAgICAgICB9KTsKCiAgICAgIH0KICAgIH07CgogIH1dKQoKCiAgLmRpcmVjdGl2ZSgnYnNTY3JvbGxzcHlMaXN0JywgWyIkcm9vdFNjb3BlIiwgImRlYm91bmNlIiwgImRpbWVuc2lvbnMiLCAiJHNjcm9sbHNweSIsIGZ1bmN0aW9uKCRyb290U2NvcGUsIGRlYm91bmNlLCBkaW1lbnNpb25zLCAkc2Nyb2xsc3B5KSB7CgogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgY29tcGlsZTogZnVuY3Rpb24gcG9zdExpbmsoZWxlbWVudCwgYXR0cikgewogICAgICAgIHZhciBjaGlsZHJlbiA9IGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvckFsbCgnbGkgPiBhW2hyZWZdJyk7CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKGNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgdmFyIGNoaWxkRWwgPSBhbmd1bGFyLmVsZW1lbnQoY2hpbGQpOwogICAgICAgICAgY2hpbGRFbC5wYXJlbnQoKS5hdHRyKCdicy1zY3JvbGxzcHknLCAnJykuYXR0cignZGF0YS10YXJnZXQnLCBjaGlsZEVsLmF0dHIoJ2hyZWYnKSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICB9OwoKICB9XSk7CgovLyBTb3VyY2U6IHNlbGVjdC5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAuc2VsZWN0JywgWydtZ2NyZWEubmdTdHJhcC50b29sdGlwJywgJ21nY3JlYS5uZ1N0cmFwLmhlbHBlcnMucGFyc2VPcHRpb25zJ10pCgogIC5wcm92aWRlcignJHNlbGVjdCcsIGZ1bmN0aW9uKCkgewoKICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgIGFuaW1hdGlvbjogJ2FtLWZhZGUnLAogICAgICBwcmVmaXhDbGFzczogJ3NlbGVjdCcsCiAgICAgIHByZWZpeEV2ZW50OiAnJHNlbGVjdCcsCiAgICAgIHBsYWNlbWVudDogJ2JvdHRvbS1sZWZ0JywKICAgICAgdGVtcGxhdGU6ICdzZWxlY3Qvc2VsZWN0LnRwbC5odG1sJywKICAgICAgdHJpZ2dlcjogJ2ZvY3VzJywKICAgICAgY29udGFpbmVyOiBmYWxzZSwKICAgICAga2V5Ym9hcmQ6IHRydWUsCiAgICAgIGh0bWw6IGZhbHNlLAogICAgICBkZWxheTogMCwKICAgICAgbXVsdGlwbGU6IGZhbHNlLAogICAgICBhbGxOb25lQnV0dG9uczogZmFsc2UsCiAgICAgIHNvcnQ6IHRydWUsCiAgICAgIGNhcmV0SHRtbDogJyZuYnNwOzxzcGFuIGNsYXNzPSJjYXJldCI+PC9zcGFuPicsCiAgICAgIHBsYWNlaG9sZGVyOiAnQ2hvb3NlIGFtb25nIHRoZSBmb2xsb3dpbmcuLi4nLAogICAgICBtYXhMZW5ndGg6IDMsCiAgICAgIG1heExlbmd0aEh0bWw6ICdzZWxlY3RlZCcsCiAgICAgIGljb25DaGVja21hcms6ICdnbHlwaGljb24gZ2x5cGhpY29uLW9rJwogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBbIiR3aW5kb3ciLCAiJGRvY3VtZW50IiwgIiRyb290U2NvcGUiLCAiJHRvb2x0aXAiLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsICRyb290U2NvcGUsICR0b29sdGlwKSB7CgogICAgICB2YXIgYm9keUVsID0gYW5ndWxhci5lbGVtZW50KCR3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgIHZhciBpc05hdGl2ZSA9IC8oaXAoYXxvKWR8aXBob25lfGFuZHJvaWQpL2lnLnRlc3QoJHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgdmFyIGlzVG91Y2ggPSAoJ2NyZWF0ZVRvdWNoJyBpbiAkd2luZG93LmRvY3VtZW50KSAmJiBpc05hdGl2ZTsKCiAgICAgIGZ1bmN0aW9uIFNlbGVjdEZhY3RvcnkoZWxlbWVudCwgY29udHJvbGxlciwgY29uZmlnKSB7CgogICAgICAgIHZhciAkc2VsZWN0ID0ge307CgogICAgICAgIC8vIENvbW1vbiB2YXJzCiAgICAgICAgdmFyIG9wdGlvbnMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgZGVmYXVsdHMsIGNvbmZpZyk7CgogICAgICAgICRzZWxlY3QgPSAkdG9vbHRpcChlbGVtZW50LCBvcHRpb25zKTsKICAgICAgICB2YXIgc2NvcGUgPSAkc2VsZWN0LiRzY29wZTsKCiAgICAgICAgc2NvcGUuJG1hdGNoZXMgPSBbXTsKICAgICAgICBzY29wZS4kYWN0aXZlSW5kZXggPSAwOwogICAgICAgIHNjb3BlLiRpc011bHRpcGxlID0gb3B0aW9ucy5tdWx0aXBsZTsKICAgICAgICBzY29wZS4kc2hvd0FsbE5vbmVCdXR0b25zID0gb3B0aW9ucy5hbGxOb25lQnV0dG9ucyAmJiBvcHRpb25zLm11bHRpcGxlOwogICAgICAgIHNjb3BlLiRpY29uQ2hlY2ttYXJrID0gb3B0aW9ucy5pY29uQ2hlY2ttYXJrOwoKICAgICAgICBzY29wZS4kYWN0aXZhdGUgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgc2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkc2VsZWN0LmFjdGl2YXRlKGluZGV4KTsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHNjb3BlLiRzZWxlY3QgPSBmdW5jdGlvbihpbmRleCwgZXZ0KSB7CiAgICAgICAgICBzY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRzZWxlY3Quc2VsZWN0KGluZGV4KTsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHNjb3BlLiRpc1Zpc2libGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiAkc2VsZWN0LiRpc1Zpc2libGUoKTsKICAgICAgICB9OwoKICAgICAgICBzY29wZS4kaXNBY3RpdmUgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgcmV0dXJuICRzZWxlY3QuJGlzQWN0aXZlKGluZGV4KTsKICAgICAgICB9OwoKICAgICAgICBzY29wZS4kc2VsZWN0QWxsID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzY29wZS4kbWF0Y2hlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoIXNjb3BlLiRpc0FjdGl2ZShpKSkgewogICAgICAgICAgICAgIHNjb3BlLiRzZWxlY3QoaSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBzY29wZS4kc2VsZWN0Tm9uZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2NvcGUuJG1hdGNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKHNjb3BlLiRpc0FjdGl2ZShpKSkgewogICAgICAgICAgICAgIHNjb3BlLiRzZWxlY3QoaSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLyBQdWJsaWMgbWV0aG9kcwoKICAgICAgICAkc2VsZWN0LnVwZGF0ZSA9IGZ1bmN0aW9uKG1hdGNoZXMpIHsKICAgICAgICAgIHNjb3BlLiRtYXRjaGVzID0gbWF0Y2hlczsKICAgICAgICAgICRzZWxlY3QuJHVwZGF0ZUFjdGl2ZUluZGV4KCk7CiAgICAgICAgfTsKCiAgICAgICAgJHNlbGVjdC5hY3RpdmF0ZSA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICBpZihvcHRpb25zLm11bHRpcGxlKSB7CiAgICAgICAgICAgIHNjb3BlLiRhY3RpdmVJbmRleC5zb3J0KCk7CiAgICAgICAgICAgICRzZWxlY3QuJGlzQWN0aXZlKGluZGV4KSA/IHNjb3BlLiRhY3RpdmVJbmRleC5zcGxpY2Uoc2NvcGUuJGFjdGl2ZUluZGV4LmluZGV4T2YoaW5kZXgpLCAxKSA6IHNjb3BlLiRhY3RpdmVJbmRleC5wdXNoKGluZGV4KTsKICAgICAgICAgICAgaWYob3B0aW9ucy5zb3J0KSBzY29wZS4kYWN0aXZlSW5kZXguc29ydCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2NvcGUuJGFjdGl2ZUluZGV4ID0gaW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc2NvcGUuJGFjdGl2ZUluZGV4OwogICAgICAgIH07CgogICAgICAgICRzZWxlY3Quc2VsZWN0ID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHNjb3BlLiRtYXRjaGVzW2luZGV4XS52YWx1ZTsKICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHNlbGVjdC5hY3RpdmF0ZShpbmRleCk7CiAgICAgICAgICAgIGlmKG9wdGlvbnMubXVsdGlwbGUpIHsKICAgICAgICAgICAgICBjb250cm9sbGVyLiRzZXRWaWV3VmFsdWUoc2NvcGUuJGFjdGl2ZUluZGV4Lm1hcChmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRtYXRjaGVzW2luZGV4XS52YWx1ZTsKICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29udHJvbGxlci4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICAvLyBIaWRlIGlmIHNpbmdsZSBzZWxlY3QKICAgICAgICAgICAgICAkc2VsZWN0LmhpZGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICAvLyBFbWl0IGV2ZW50CiAgICAgICAgICBzY29wZS4kZW1pdChvcHRpb25zLnByZWZpeEV2ZW50ICsgJy5zZWxlY3QnLCB2YWx1ZSwgaW5kZXgpOwogICAgICAgIH07CgogICAgICAgIC8vIFByb3RlY3RlZCBtZXRob2RzCgogICAgICAgICRzZWxlY3QuJHVwZGF0ZUFjdGl2ZUluZGV4ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZihjb250cm9sbGVyLiRtb2RlbFZhbHVlICYmIHNjb3BlLiRtYXRjaGVzLmxlbmd0aCkgewogICAgICAgICAgICBpZihvcHRpb25zLm11bHRpcGxlICYmIGFuZ3VsYXIuaXNBcnJheShjb250cm9sbGVyLiRtb2RlbFZhbHVlKSkgewogICAgICAgICAgICAgIHNjb3BlLiRhY3RpdmVJbmRleCA9IGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUubWFwKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHNlbGVjdC4kZ2V0SW5kZXgodmFsdWUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNjb3BlLiRhY3RpdmVJbmRleCA9ICRzZWxlY3QuJGdldEluZGV4KGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYoc2NvcGUuJGFjdGl2ZUluZGV4ID49IHNjb3BlLiRtYXRjaGVzLmxlbmd0aCkgewogICAgICAgICAgICBzY29wZS4kYWN0aXZlSW5kZXggPSBvcHRpb25zLm11bHRpcGxlID8gW10gOiAwOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgICRzZWxlY3QuJGlzVmlzaWJsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYoIW9wdGlvbnMubWluTGVuZ3RoIHx8ICFjb250cm9sbGVyKSB7CiAgICAgICAgICAgIHJldHVybiBzY29wZS4kbWF0Y2hlcy5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBtaW5MZW5ndGggc3VwcG9ydAogICAgICAgICAgcmV0dXJuIHNjb3BlLiRtYXRjaGVzLmxlbmd0aCAmJiBjb250cm9sbGVyLiR2aWV3VmFsdWUubGVuZ3RoID49IG9wdGlvbnMubWluTGVuZ3RoOwogICAgICAgIH07CgogICAgICAgICRzZWxlY3QuJGlzQWN0aXZlID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgIGlmKG9wdGlvbnMubXVsdGlwbGUpIHsKICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRhY3RpdmVJbmRleC5pbmRleE9mKGluZGV4KSAhPT0gLTE7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gc2NvcGUuJGFjdGl2ZUluZGV4ID09PSBpbmRleDsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAkc2VsZWN0LiRnZXRJbmRleCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICB2YXIgbCA9IHNjb3BlLiRtYXRjaGVzLmxlbmd0aCwgaSA9IGw7CiAgICAgICAgICBpZighbCkgcmV0dXJuOwogICAgICAgICAgZm9yKGkgPSBsOyBpLS07KSB7CiAgICAgICAgICAgIGlmKHNjb3BlLiRtYXRjaGVzW2ldLnZhbHVlID09PSB2YWx1ZSkgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZihpIDwgMCkgcmV0dXJuOwogICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgfTsKCiAgICAgICAgJHNlbGVjdC4kb25Nb3VzZURvd24gPSBmdW5jdGlvbihldnQpIHsKICAgICAgICAgIC8vIFByZXZlbnQgYmx1ciBvbiBtb3VzZWRvd24gb24gLmRyb3Bkb3duLW1lbnUKICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgLy8gRW11bGF0ZSBjbGljayBmb3IgbW9iaWxlIGRldmljZXMKICAgICAgICAgIGlmKGlzVG91Y2gpIHsKICAgICAgICAgICAgdmFyIHRhcmdldEVsID0gYW5ndWxhci5lbGVtZW50KGV2dC50YXJnZXQpOwogICAgICAgICAgICB0YXJnZXRFbC50cmlnZ2VySGFuZGxlcignY2xpY2snKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAkc2VsZWN0LiRvbktleURvd24gPSBmdW5jdGlvbihldnQpIHsKICAgICAgICAgIGlmICghLyg5fDEzfDM4fDQwKS8udGVzdChldnQua2V5Q29kZSkpIHJldHVybjsKICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwoKICAgICAgICAgIC8vIFNlbGVjdCB3aXRoIGVudGVyCiAgICAgICAgICBpZighb3B0aW9ucy5tdWx0aXBsZSAmJiAoZXZ0LmtleUNvZGUgPT09IDEzIHx8IGV2dC5rZXlDb2RlID09PSA5KSkgewogICAgICAgICAgICByZXR1cm4gJHNlbGVjdC5zZWxlY3Qoc2NvcGUuJGFjdGl2ZUluZGV4KTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBOYXZpZ2F0ZSB3aXRoIGtleWJvYXJkCiAgICAgICAgICBpZihldnQua2V5Q29kZSA9PT0gMzggJiYgc2NvcGUuJGFjdGl2ZUluZGV4ID4gMCkgc2NvcGUuJGFjdGl2ZUluZGV4LS07CiAgICAgICAgICBlbHNlIGlmKGV2dC5rZXlDb2RlID09PSA0MCAmJiBzY29wZS4kYWN0aXZlSW5kZXggPCBzY29wZS4kbWF0Y2hlcy5sZW5ndGggLSAxKSBzY29wZS4kYWN0aXZlSW5kZXgrKzsKICAgICAgICAgIGVsc2UgaWYoYW5ndWxhci5pc1VuZGVmaW5lZChzY29wZS4kYWN0aXZlSW5kZXgpKSBzY29wZS4kYWN0aXZlSW5kZXggPSAwOwogICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgIH07CgogICAgICAgIC8vIE92ZXJyaWRlcwoKICAgICAgICB2YXIgX3Nob3cgPSAkc2VsZWN0LnNob3c7CiAgICAgICAgJHNlbGVjdC5zaG93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBfc2hvdygpOwogICAgICAgICAgaWYob3B0aW9ucy5tdWx0aXBsZSkgewogICAgICAgICAgICAkc2VsZWN0LiRlbGVtZW50LmFkZENsYXNzKCdzZWxlY3QtbXVsdGlwbGUnKTsKICAgICAgICAgIH0KICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRzZWxlY3QuJGVsZW1lbnQub24oaXNUb3VjaCA/ICd0b3VjaHN0YXJ0JyA6ICdtb3VzZWRvd24nLCAkc2VsZWN0LiRvbk1vdXNlRG93bik7CiAgICAgICAgICAgIGlmKG9wdGlvbnMua2V5Ym9hcmQpIHsKICAgICAgICAgICAgICBlbGVtZW50Lm9uKCdrZXlkb3duJywgJHNlbGVjdC4kb25LZXlEb3duKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIF9oaWRlID0gJHNlbGVjdC5oaWRlOwogICAgICAgICRzZWxlY3QuaGlkZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgJHNlbGVjdC4kZWxlbWVudC5vZmYoaXNUb3VjaCA/ICd0b3VjaHN0YXJ0JyA6ICdtb3VzZWRvd24nLCAkc2VsZWN0LiRvbk1vdXNlRG93bik7CiAgICAgICAgICBpZihvcHRpb25zLmtleWJvYXJkKSB7CiAgICAgICAgICAgIGVsZW1lbnQub2ZmKCdrZXlkb3duJywgJHNlbGVjdC4kb25LZXlEb3duKTsKICAgICAgICAgIH0KICAgICAgICAgIF9oaWRlKHRydWUpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiAkc2VsZWN0OwoKICAgICAgfQoKICAgICAgU2VsZWN0RmFjdG9yeS5kZWZhdWx0cyA9IGRlZmF1bHRzOwogICAgICByZXR1cm4gU2VsZWN0RmFjdG9yeTsKCiAgICB9XTsKCiAgfSkKCiAgLmRpcmVjdGl2ZSgnYnNTZWxlY3QnLCBbIiR3aW5kb3ciLCAiJHBhcnNlIiwgIiRxIiwgIiRzZWxlY3QiLCAiJHBhcnNlT3B0aW9ucyIsIGZ1bmN0aW9uKCR3aW5kb3csICRwYXJzZSwgJHEsICRzZWxlY3QsICRwYXJzZU9wdGlvbnMpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSAkc2VsZWN0LmRlZmF1bHRzOwoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRUFDJywKICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgICBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgZWxlbWVudCwgYXR0ciwgY29udHJvbGxlcikgewoKICAgICAgICAvLyBEaXJlY3RpdmUgb3B0aW9ucwogICAgICAgIHZhciBvcHRpb25zID0ge3Njb3BlOiBzY29wZSwgcGxhY2Vob2xkZXI6IGRlZmF1bHRzLnBsYWNlaG9sZGVyfTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goWydwbGFjZW1lbnQnLCAnY29udGFpbmVyJywgJ2RlbGF5JywgJ3RyaWdnZXInLCAna2V5Ym9hcmQnLCAnaHRtbCcsICdhbmltYXRpb24nLCAndGVtcGxhdGUnLCAncGxhY2Vob2xkZXInLCAnbXVsdGlwbGUnLCAnYWxsTm9uZUJ1dHRvbnMnLCAnbWF4TGVuZ3RoJywgJ21heExlbmd0aEh0bWwnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzRGVmaW5lZChhdHRyW2tleV0pKSBvcHRpb25zW2tleV0gPSBhdHRyW2tleV07CiAgICAgICAgfSk7CgogICAgICAgIC8vIEFkZCBzdXBwb3J0IGZvciBzZWxlY3QgbWFya3VwCiAgICAgICAgaWYoZWxlbWVudFswXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnc2VsZWN0JykgewogICAgICAgICAgdmFyIGlucHV0RWwgPSBlbGVtZW50OwogICAgICAgICAgaW5wdXRFbC5jc3MoJ2Rpc3BsYXknLCAnbm9uZScpOwogICAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudCgnPGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQiPjwvYnV0dG9uPicpOwogICAgICAgICAgaW5wdXRFbC5hZnRlcihlbGVtZW50KTsKICAgICAgICB9CgogICAgICAgIC8vIEJ1aWxkIHByb3BlciBuZ09wdGlvbnMKICAgICAgICB2YXIgcGFyc2VkT3B0aW9ucyA9ICRwYXJzZU9wdGlvbnMoYXR0ci5uZ09wdGlvbnMpOwoKICAgICAgICAvLyBJbml0aWFsaXplIHNlbGVjdAogICAgICAgIHZhciBzZWxlY3QgPSAkc2VsZWN0KGVsZW1lbnQsIGNvbnRyb2xsZXIsIG9wdGlvbnMpOwoKICAgICAgICAvLyBXYXRjaCBuZ09wdGlvbnMgdmFsdWVzIGJlZm9yZSBmaWx0ZXJpbmcgZm9yIGNoYW5nZXMKICAgICAgICB2YXIgd2F0Y2hlZE9wdGlvbnMgPSBwYXJzZWRPcHRpb25zLiRtYXRjaFs3XS5yZXBsYWNlKC9cfC4rLywgJycpLnRyaW0oKTsKICAgICAgICBzY29wZS4kd2F0Y2god2F0Y2hlZE9wdGlvbnMsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCdzY29wZS4kd2F0Y2goJXMpJywgd2F0Y2hlZE9wdGlvbnMsIG5ld1ZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgICBwYXJzZWRPcHRpb25zLnZhbHVlc0ZuKHNjb3BlLCBjb250cm9sbGVyKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24odmFsdWVzKSB7CiAgICAgICAgICAgIHNlbGVjdC51cGRhdGUodmFsdWVzKTsKICAgICAgICAgICAgY29udHJvbGxlci4kcmVuZGVyKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9LCB0cnVlKTsKCiAgICAgICAgLy8gV2F0Y2ggbW9kZWwgZm9yIGNoYW5nZXMKICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ01vZGVsLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2Fybignc2NvcGUuJHdhdGNoKCVzKScsIGF0dHIubmdNb2RlbCwgbmV3VmFsdWUsIG9sZFZhbHVlKTsKICAgICAgICAgIHNlbGVjdC4kdXBkYXRlQWN0aXZlSW5kZXgoKTsKICAgICAgICAgIGNvbnRyb2xsZXIuJHJlbmRlcigpOwogICAgICAgIH0sIHRydWUpOwoKICAgICAgICAvLyBNb2RlbCByZW5kZXJpbmcgaW4gdmlldwogICAgICAgIGNvbnRyb2xsZXIuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2FybignJHJlbmRlcicsIGVsZW1lbnQuYXR0cignbmctbW9kZWwnKSwgJ2NvbnRyb2xsZXIuJG1vZGVsVmFsdWUnLCB0eXBlb2YgY29udHJvbGxlci4kbW9kZWxWYWx1ZSwgY29udHJvbGxlci4kbW9kZWxWYWx1ZSwgJ2NvbnRyb2xsZXIuJHZpZXdWYWx1ZScsIHR5cGVvZiBjb250cm9sbGVyLiR2aWV3VmFsdWUsIGNvbnRyb2xsZXIuJHZpZXdWYWx1ZSk7CiAgICAgICAgICB2YXIgc2VsZWN0ZWQsIGluZGV4OwogICAgICAgICAgaWYob3B0aW9ucy5tdWx0aXBsZSAmJiBhbmd1bGFyLmlzQXJyYXkoY29udHJvbGxlci4kbW9kZWxWYWx1ZSkpIHsKICAgICAgICAgICAgc2VsZWN0ZWQgPSBjb250cm9sbGVyLiRtb2RlbFZhbHVlLm1hcChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGluZGV4ID0gc2VsZWN0LiRnZXRJbmRleCh2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuaXNEZWZpbmVkKGluZGV4KSA/IHNlbGVjdC4kc2NvcGUuJG1hdGNoZXNbaW5kZXhdLmxhYmVsIDogZmFsc2U7CiAgICAgICAgICAgIH0pLmZpbHRlcihhbmd1bGFyLmlzRGVmaW5lZCk7CiAgICAgICAgICAgIGlmKHNlbGVjdGVkLmxlbmd0aCA+IChvcHRpb25zLm1heExlbmd0aCB8fCBkZWZhdWx0cy5tYXhMZW5ndGgpKSB7CiAgICAgICAgICAgICAgc2VsZWN0ZWQgPSBzZWxlY3RlZC5sZW5ndGggKyAnICcgKyAob3B0aW9ucy5tYXhMZW5ndGhIdG1sIHx8IGRlZmF1bHRzLm1heExlbmd0aEh0bWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNlbGVjdGVkID0gc2VsZWN0ZWQuam9pbignLCAnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5kZXggPSBzZWxlY3QuJGdldEluZGV4KGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUpOwogICAgICAgICAgICBzZWxlY3RlZCA9IGFuZ3VsYXIuaXNEZWZpbmVkKGluZGV4KSA/IHNlbGVjdC4kc2NvcGUuJG1hdGNoZXNbaW5kZXhdLmxhYmVsIDogZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50Lmh0bWwoKHNlbGVjdGVkID8gc2VsZWN0ZWQgOiBvcHRpb25zLnBsYWNlaG9sZGVyKSArIGRlZmF1bHRzLmNhcmV0SHRtbCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gR2FyYmFnZSBjb2xsZWN0aW9uCiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHNlbGVjdCkgc2VsZWN0LmRlc3Ryb3koKTsKICAgICAgICAgIG9wdGlvbnMgPSBudWxsOwogICAgICAgICAgc2VsZWN0ID0gbnVsbDsKICAgICAgICB9KTsKCiAgICAgIH0KICAgIH07CgogIH1dKTsKCi8vIFNvdXJjZTogdGFiLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC50YWInLCBbXSkKCiAgLnByb3ZpZGVyKCckdGFiJywgZnVuY3Rpb24oKSB7CgogICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgYW5pbWF0aW9uOiAnYW0tZmFkZScsCiAgICAgIHRlbXBsYXRlOiAndGFiL3RhYi50cGwuaHRtbCcsCiAgICAgIG5hdkNsYXNzOiAnbmF2LXRhYnMnLAogICAgICBhY3RpdmVDbGFzczogJ2FjdGl2ZScKICAgIH07CgogICAgdmFyIGNvbnRyb2xsZXIgPSB0aGlzLmNvbnRyb2xsZXIgPSBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgLy8gQXR0cmlidXRlcyBvcHRpb25zCiAgICAgIHNlbGYuJG9wdGlvbnMgPSBhbmd1bGFyLmNvcHkoZGVmYXVsdHMpOwogICAgICBhbmd1bGFyLmZvckVhY2goWydhbmltYXRpb24nLCAnbmF2Q2xhc3MnLCAnYWN0aXZlQ2xhc3MnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYoYW5ndWxhci5pc0RlZmluZWQoJGF0dHJzW2tleV0pKSBzZWxmLiRvcHRpb25zW2tleV0gPSAkYXR0cnNba2V5XTsKICAgICAgfSk7CgogICAgICAvLyBQdWJsaXNoIG9wdGlvbnMgb24gc2NvcGUKICAgICAgJHNjb3BlLiRuYXZDbGFzcyA9IHNlbGYuJG9wdGlvbnMubmF2Q2xhc3M7CiAgICAgICRzY29wZS4kYWN0aXZlQ2xhc3MgPSBzZWxmLiRvcHRpb25zLmFjdGl2ZUNsYXNzOwoKICAgICAgc2VsZi4kcGFuZXMgPSAkc2NvcGUuJHBhbmVzID0gW107CgogICAgICBzZWxmLiR2aWV3Q2hhbmdlTGlzdGVuZXJzID0gW107CgogICAgICBzZWxmLiRwdXNoID0gZnVuY3Rpb24ocGFuZSkgewogICAgICAgIHNlbGYuJHBhbmVzLnB1c2gocGFuZSk7CiAgICAgIH07CgogICAgICBzZWxmLiRyZW1vdmUgPSBmdW5jdGlvbihwYW5lKSB7CiAgICAgICAgdmFyIGluZGV4ID0gc2VsZi4kcGFuZXMuaW5kZXhPZihwYW5lKTsKICAgICAgICB2YXIgYWN0aXZlSW5kZXggPSBzZWxmLiRwYW5lcy4kYWN0aXZlOwoKICAgICAgICAvLyByZW1vdmUgcGFuZSBmcm9tICRwYW5lcyBhcnJheQogICAgICAgIHNlbGYuJHBhbmVzLnNwbGljZShpbmRleCwgMSk7CgogICAgICAgIGlmIChpbmRleCA8IGFjdGl2ZUluZGV4KSB7CiAgICAgICAgICAvLyB3ZSByZW1vdmVkIGEgcGFuZSBiZWZvcmUgdGhlIGFjdGl2ZSBwYW5lLCBzbyB3ZSBuZWVkIHRvIAogICAgICAgICAgLy8gZGVjcmVtZW50IHRoZSBhY3RpdmUgcGFuZSBpbmRleAogICAgICAgICAgYWN0aXZlSW5kZXgtLTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoaW5kZXggPT09IGFjdGl2ZUluZGV4ICYmIGFjdGl2ZUluZGV4ID09PSBzZWxmLiRwYW5lcy5sZW5ndGgpIHsKICAgICAgICAgIC8vIHdlIHJlbW92ZSB0aGUgYWN0aXZlIHBhbmUgYW5kIGl0IHdhcyB0aGUgb25lIGF0IHRoZSBlbmQsCiAgICAgICAgICAvLyBzbyBzZWxlY3QgdGhlIHByZXZpb3VzIG9uZQogICAgICAgICAgYWN0aXZlSW5kZXgtLTsKICAgICAgICB9CiAgICAgICAgc2VsZi4kc2V0QWN0aXZlKGFjdGl2ZUluZGV4KTsKICAgICAgfTsKCiAgICAgIHNlbGYuJHBhbmVzLiRhY3RpdmUgPSAwOwogICAgICBzZWxmLiRzZXRBY3RpdmUgPSAkc2NvcGUuJHNldEFjdGl2ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgc2VsZi4kcGFuZXMuJGFjdGl2ZSA9IHZhbHVlOwogICAgICAgIHNlbGYuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbihmbikgewogICAgICAgICAgZm4oKTsKICAgICAgICB9KTsKICAgICAgfTsKCiAgICB9OwoKICAgIHRoaXMuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgJHRhYiA9IHt9OwogICAgICAkdGFiLmRlZmF1bHRzID0gZGVmYXVsdHM7CiAgICAgICR0YWIuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7CiAgICAgIHJldHVybiAkdGFiOwogICAgfTsKCiAgfSkKCiAgLmRpcmVjdGl2ZSgnYnNUYWJzJywgWyIkd2luZG93IiwgIiRhbmltYXRlIiwgIiR0YWIiLCBmdW5jdGlvbigkd2luZG93LCAkYW5pbWF0ZSwgJHRhYikgewoKICAgIHZhciBkZWZhdWx0cyA9ICR0YWIuZGVmYXVsdHM7CgogICAgcmV0dXJuIHsKICAgICAgcmVxdWlyZTogWyc/bmdNb2RlbCcsICdic1RhYnMnXSwKICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgc2NvcGU6IHRydWUsCiAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgJyRhdHRycycsICR0YWIuY29udHJvbGxlcl0sCiAgICAgIHRlbXBsYXRlVXJsOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgcmV0dXJuIGF0dHIudGVtcGxhdGUgfHwgZGVmYXVsdHMudGVtcGxhdGU7CiAgICAgIH0sCiAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcnMpIHsKCiAgICAgICAgdmFyIG5nTW9kZWxDdHJsID0gY29udHJvbGxlcnNbMF07CiAgICAgICAgdmFyIGJzVGFic0N0cmwgPSBjb250cm9sbGVyc1sxXTsKCiAgICAgICAgaWYobmdNb2RlbEN0cmwpIHsKCiAgICAgICAgICAvLyBVcGRhdGUgdGhlIG1vZGVsVmFsdWUgZm9sbG93aW5nCiAgICAgICAgICBic1RhYnNDdHJsLiR2aWV3Q2hhbmdlTGlzdGVuZXJzLnB1c2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRzZXRWaWV3VmFsdWUoYnNUYWJzQ3RybC4kcGFuZXMuJGFjdGl2ZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICAvLyBtb2RlbFZhbHVlIC0+ICRmb3JtYXR0ZXJzIC0+IHZpZXdWYWx1ZQogICAgICAgICAgbmdNb2RlbEN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbihtb2RlbFZhbHVlKSB7CiAgICAgICAgICAgIC8vIGNvbnNvbGUud2FybignJGZvcm1hdHRlcigiJXMiKTogbW9kZWxWYWx1ZT0lbyAoJW8pJywgZWxlbWVudC5hdHRyKCduZy1tb2RlbCcpLCBtb2RlbFZhbHVlLCB0eXBlb2YgbW9kZWxWYWx1ZSk7CiAgICAgICAgICAgIGJzVGFic0N0cmwuJHNldEFjdGl2ZShtb2RlbFZhbHVlICogMSk7CiAgICAgICAgICAgIHJldHVybiBtb2RlbFZhbHVlOwogICAgICAgICAgfSk7CgogICAgICAgIH0KCiAgICAgIH0KICAgIH07CgogIH1dKQoKICAuZGlyZWN0aXZlKCdic1BhbmUnLCBbIiR3aW5kb3ciLCAiJGFuaW1hdGUiLCAiJHNjZSIsIGZ1bmN0aW9uKCR3aW5kb3csICRhbmltYXRlLCAkc2NlKSB7CgogICAgcmV0dXJuIHsKICAgICAgcmVxdWlyZTogWydeP25nTW9kZWwnLCAnXmJzVGFicyddLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjb250cm9sbGVycykgewoKICAgICAgICB2YXIgbmdNb2RlbEN0cmwgPSBjb250cm9sbGVyc1swXTsKICAgICAgICB2YXIgYnNUYWJzQ3RybCA9IGNvbnRyb2xsZXJzWzFdOwoKICAgICAgICAvLyBBZGQgYmFzZSBjbGFzcwogICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ3RhYi1wYW5lJyk7CgogICAgICAgIC8vIE9ic2VydmUgdGl0bGUgYXR0cmlidXRlIGZvciBjaGFuZ2UKICAgICAgICBhdHRycy4kb2JzZXJ2ZSgndGl0bGUnLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgIHNjb3BlLnRpdGxlID0gJHNjZS50cnVzdEFzSHRtbChuZXdWYWx1ZSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIEFkZCBhbmltYXRpb24gY2xhc3MKICAgICAgICBpZihic1RhYnNDdHJsLiRvcHRpb25zLmFuaW1hdGlvbikgewogICAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhic1RhYnNDdHJsLiRvcHRpb25zLmFuaW1hdGlvbik7CiAgICAgICAgfQoKICAgICAgICAvLyBQdXNoIHBhbmUgdG8gcGFyZW50IGJzVGFicyBjb250cm9sbGVyCiAgICAgICAgYnNUYWJzQ3RybC4kcHVzaChzY29wZSk7CgogICAgICAgIC8vIHJlbW92ZSBwYW5lIGZyb20gdGFiIGNvbnRyb2xsZXIgd2hlbiBwYW5lIGlzIGRlc3Ryb3llZAogICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGJzVGFic0N0cmwuJHJlbW92ZShzY29wZSk7CiAgICAgICAgfSk7CgogICAgICAgIGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGJzVGFic0N0cmwuJHBhbmVzLmluZGV4T2Yoc2NvcGUpOwogICAgICAgICAgdmFyIGFjdGl2ZSA9IGJzVGFic0N0cmwuJHBhbmVzLiRhY3RpdmU7CiAgICAgICAgICAkYW5pbWF0ZVtpbmRleCA9PT0gYWN0aXZlID8gJ2FkZENsYXNzJyA6ICdyZW1vdmVDbGFzcyddKGVsZW1lbnQsIGJzVGFic0N0cmwuJG9wdGlvbnMuYWN0aXZlQ2xhc3MpOwogICAgICAgIH0KCiAgICAgICAgYnNUYWJzQ3RybC4kdmlld0NoYW5nZUxpc3RlbmVycy5wdXNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgcmVuZGVyKCk7CiAgICAgICAgfSk7CiAgICAgICAgcmVuZGVyKCk7CgogICAgICB9CiAgICB9OwoKICB9XSk7CgovLyBTb3VyY2U6IHRpbWVwaWNrZXIuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLnRpbWVwaWNrZXInLCBbJ21nY3JlYS5uZ1N0cmFwLmhlbHBlcnMuZGF0ZVBhcnNlcicsICdtZ2NyZWEubmdTdHJhcC50b29sdGlwJ10pCgogIC5wcm92aWRlcignJHRpbWVwaWNrZXInLCBmdW5jdGlvbigpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICBhbmltYXRpb246ICdhbS1mYWRlJywKICAgICAgcHJlZml4Q2xhc3M6ICd0aW1lcGlja2VyJywKICAgICAgcGxhY2VtZW50OiAnYm90dG9tLWxlZnQnLAogICAgICB0ZW1wbGF0ZTogJ3RpbWVwaWNrZXIvdGltZXBpY2tlci50cGwuaHRtbCcsCiAgICAgIHRyaWdnZXI6ICdmb2N1cycsCiAgICAgIGNvbnRhaW5lcjogZmFsc2UsCiAgICAgIGtleWJvYXJkOiB0cnVlLAogICAgICBodG1sOiBmYWxzZSwKICAgICAgZGVsYXk6IDAsCiAgICAgIC8vIGxhbmc6ICRsb2NhbGUuaWQsCiAgICAgIHVzZU5hdGl2ZTogdHJ1ZSwKICAgICAgdGltZVR5cGU6ICdkYXRlJywKICAgICAgdGltZUZvcm1hdDogJ3Nob3J0VGltZScsCiAgICAgIG1vZGVsVGltZUZvcm1hdDogbnVsbCwKICAgICAgYXV0b2Nsb3NlOiBmYWxzZSwKICAgICAgbWluVGltZTogLUluZmluaXR5LAogICAgICBtYXhUaW1lOiArSW5maW5pdHksCiAgICAgIGxlbmd0aDogNSwKICAgICAgaG91clN0ZXA6IDEsCiAgICAgIG1pbnV0ZVN0ZXA6IDUsCiAgICAgIGljb25VcDogJ2dseXBoaWNvbiBnbHlwaGljb24tY2hldnJvbi11cCcsCiAgICAgIGljb25Eb3duOiAnZ2x5cGhpY29uIGdseXBoaWNvbi1jaGV2cm9uLWRvd24nLAogICAgICBhcnJvd0JlaGF2aW9yOiAncGFnZXInCiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsiJHdpbmRvdyIsICIkZG9jdW1lbnQiLCAiJHJvb3RTY29wZSIsICIkc2NlIiwgIiRsb2NhbGUiLCAiZGF0ZUZpbHRlciIsICIkdG9vbHRpcCIsICIkdGltZW91dCIsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgJHJvb3RTY29wZSwgJHNjZSwgJGxvY2FsZSwgZGF0ZUZpbHRlciwgJHRvb2x0aXAsICR0aW1lb3V0KSB7CgogICAgICB2YXIgYm9keUVsID0gYW5ndWxhci5lbGVtZW50KCR3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgIHZhciBpc05hdGl2ZSA9IC8oaXAoYXxvKWR8aXBob25lfGFuZHJvaWQpL2lnLnRlc3QoJHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgdmFyIGlzVG91Y2ggPSAoJ2NyZWF0ZVRvdWNoJyBpbiAkd2luZG93LmRvY3VtZW50KSAmJiBpc05hdGl2ZTsKICAgICAgaWYoIWRlZmF1bHRzLmxhbmcpIGRlZmF1bHRzLmxhbmcgPSAkbG9jYWxlLmlkOwoKICAgICAgZnVuY3Rpb24gdGltZXBpY2tlckZhY3RvcnkoZWxlbWVudCwgY29udHJvbGxlciwgY29uZmlnKSB7CgogICAgICAgIHZhciAkdGltZXBpY2tlciA9ICR0b29sdGlwKGVsZW1lbnQsIGFuZ3VsYXIuZXh0ZW5kKHt9LCBkZWZhdWx0cywgY29uZmlnKSk7CiAgICAgICAgdmFyIHBhcmVudFNjb3BlID0gY29uZmlnLnNjb3BlOwogICAgICAgIHZhciBvcHRpb25zID0gJHRpbWVwaWNrZXIuJG9wdGlvbnM7CiAgICAgICAgdmFyIHNjb3BlID0gJHRpbWVwaWNrZXIuJHNjb3BlOwoKICAgICAgICAvLyBWaWV3IHZhcnMKCiAgICAgICAgdmFyIHNlbGVjdGVkSW5kZXggPSAwOwogICAgICAgIHZhciBzdGFydERhdGUgPSBjb250cm9sbGVyLiRkYXRlVmFsdWUgfHwgbmV3IERhdGUoKTsKICAgICAgICB2YXIgdmlld0RhdGUgPSB7aG91cjogc3RhcnREYXRlLmdldEhvdXJzKCksIG1lcmlkaWFuOiBzdGFydERhdGUuZ2V0SG91cnMoKSA8IDEyLCBtaW51dGU6IHN0YXJ0RGF0ZS5nZXRNaW51dGVzKCksIHNlY29uZDogc3RhcnREYXRlLmdldFNlY29uZHMoKSwgbWlsbGlzZWNvbmQ6IHN0YXJ0RGF0ZS5nZXRNaWxsaXNlY29uZHMoKX07CgogICAgICAgIHZhciBmb3JtYXQgPSAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFNbb3B0aW9ucy50aW1lRm9ybWF0XSB8fCBvcHRpb25zLnRpbWVGb3JtYXQ7CiAgICAgICAgdmFyIGZvcm1hdHMgPSAvKGgrKShbOlwuXSk/KG0rKVsgXT8oYT8pL2kuZXhlYyhmb3JtYXQpLnNsaWNlKDEpOwogICAgICAgIHNjb3BlLiRpY29uVXAgPSBvcHRpb25zLmljb25VcDsKICAgICAgICBzY29wZS4kaWNvbkRvd24gPSBvcHRpb25zLmljb25Eb3duOwoKICAgICAgICAvLyBTY29wZSBtZXRob2RzCgogICAgICAgIHNjb3BlLiRzZWxlY3QgPSBmdW5jdGlvbihkYXRlLCBpbmRleCkgewogICAgICAgICAgJHRpbWVwaWNrZXIuc2VsZWN0KGRhdGUsIGluZGV4KTsKICAgICAgICB9OwogICAgICAgIHNjb3BlLiRtb3ZlSW5kZXggPSBmdW5jdGlvbih2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICR0aW1lcGlja2VyLiRtb3ZlSW5kZXgodmFsdWUsIGluZGV4KTsKICAgICAgICB9OwogICAgICAgIHNjb3BlLiRzd2l0Y2hNZXJpZGlhbiA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgICR0aW1lcGlja2VyLnN3aXRjaE1lcmlkaWFuKGRhdGUpOwogICAgICAgIH07CgogICAgICAgIC8vIFB1YmxpYyBtZXRob2RzCgogICAgICAgICR0aW1lcGlja2VyLnVwZGF0ZSA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2FybignJHRpbWVwaWNrZXIudXBkYXRlKCkgbmV3VmFsdWU9JW8nLCBkYXRlKTsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNEYXRlKGRhdGUpICYmICFpc05hTihkYXRlLmdldFRpbWUoKSkpIHsKICAgICAgICAgICAgJHRpbWVwaWNrZXIuJGRhdGUgPSBkYXRlOwogICAgICAgICAgICBhbmd1bGFyLmV4dGVuZCh2aWV3RGF0ZSwge2hvdXI6IGRhdGUuZ2V0SG91cnMoKSwgbWludXRlOiBkYXRlLmdldE1pbnV0ZXMoKSwgc2Vjb25kOiBkYXRlLmdldFNlY29uZHMoKSwgbWlsbGlzZWNvbmQ6IGRhdGUuZ2V0TWlsbGlzZWNvbmRzKCl9KTsKICAgICAgICAgICAgJHRpbWVwaWNrZXIuJGJ1aWxkKCk7CiAgICAgICAgICB9IGVsc2UgaWYoISR0aW1lcGlja2VyLiRpc0J1aWx0KSB7CiAgICAgICAgICAgICR0aW1lcGlja2VyLiRidWlsZCgpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgICR0aW1lcGlja2VyLnNlbGVjdCA9IGZ1bmN0aW9uKGRhdGUsIGluZGV4LCBrZWVwKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyR0aW1lcGlja2VyLnNlbGVjdCcsIGRhdGUsIHNjb3BlLiRtb2RlKTsKICAgICAgICAgIGlmKCFjb250cm9sbGVyLiRkYXRlVmFsdWUgfHwgaXNOYU4oY29udHJvbGxlci4kZGF0ZVZhbHVlLmdldFRpbWUoKSkpIGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSA9IG5ldyBEYXRlKDE5NzAsIDAsIDEpOwogICAgICAgICAgaWYoIWFuZ3VsYXIuaXNEYXRlKGRhdGUpKSBkYXRlID0gbmV3IERhdGUoZGF0ZSk7CiAgICAgICAgICBpZihpbmRleCA9PT0gMCkgY29udHJvbGxlci4kZGF0ZVZhbHVlLnNldEhvdXJzKGRhdGUuZ2V0SG91cnMoKSk7CiAgICAgICAgICBlbHNlIGlmKGluZGV4ID09PSAxKSBjb250cm9sbGVyLiRkYXRlVmFsdWUuc2V0TWludXRlcyhkYXRlLmdldE1pbnV0ZXMoKSk7CiAgICAgICAgICBjb250cm9sbGVyLiRzZXRWaWV3VmFsdWUoY29udHJvbGxlci4kZGF0ZVZhbHVlKTsKICAgICAgICAgIGNvbnRyb2xsZXIuJHJlbmRlcigpOwogICAgICAgICAgaWYob3B0aW9ucy5hdXRvY2xvc2UgJiYgIWtlZXApIHsKICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7ICR0aW1lcGlja2VyLmhpZGUodHJ1ZSk7IH0pOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgICR0aW1lcGlja2VyLnN3aXRjaE1lcmlkaWFuID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgaWYgKCFjb250cm9sbGVyLiRkYXRlVmFsdWUgfHwgaXNOYU4oY29udHJvbGxlci4kZGF0ZVZhbHVlLmdldFRpbWUoKSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvdXJzID0gKGRhdGUgfHwgY29udHJvbGxlci4kZGF0ZVZhbHVlKS5nZXRIb3VycygpOwogICAgICAgICAgY29udHJvbGxlci4kZGF0ZVZhbHVlLnNldEhvdXJzKGhvdXJzIDwgMTIgPyBob3VycyArIDEyIDogaG91cnMgLSAxMik7CiAgICAgICAgICBjb250cm9sbGVyLiRzZXRWaWV3VmFsdWUoY29udHJvbGxlci4kZGF0ZVZhbHVlKTsKICAgICAgICAgIGNvbnRyb2xsZXIuJHJlbmRlcigpOwogICAgICAgIH07CgogICAgICAgIC8vIFByb3RlY3RlZCBtZXRob2RzCgogICAgICAgICR0aW1lcGlja2VyLiRidWlsZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCckdGltZXBpY2tlci4kYnVpbGQoKSB2aWV3RGF0ZT0lbycsIHZpZXdEYXRlKTsKICAgICAgICAgIHZhciBpLCBtaWRJbmRleCA9IHNjb3BlLm1pZEluZGV4ID0gcGFyc2VJbnQob3B0aW9ucy5sZW5ndGggLyAyLCAxMCk7CiAgICAgICAgICB2YXIgaG91cnMgPSBbXSwgaG91cjsKICAgICAgICAgIGZvcihpID0gMDsgaSA8IG9wdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaG91ciA9IG5ldyBEYXRlKDE5NzAsIDAsIDEsIHZpZXdEYXRlLmhvdXIgLSAobWlkSW5kZXggLSBpKSAqIG9wdGlvbnMuaG91clN0ZXApOwogICAgICAgICAgICBob3Vycy5wdXNoKHtkYXRlOiBob3VyLCBsYWJlbDogZGF0ZUZpbHRlcihob3VyLCBmb3JtYXRzWzBdKSwgc2VsZWN0ZWQ6ICR0aW1lcGlja2VyLiRkYXRlICYmICR0aW1lcGlja2VyLiRpc1NlbGVjdGVkKGhvdXIsIDApLCBkaXNhYmxlZDogJHRpbWVwaWNrZXIuJGlzRGlzYWJsZWQoaG91ciwgMCl9KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtaW51dGVzID0gW10sIG1pbnV0ZTsKICAgICAgICAgIGZvcihpID0gMDsgaSA8IG9wdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgbWludXRlID0gbmV3IERhdGUoMTk3MCwgMCwgMSwgMCwgdmlld0RhdGUubWludXRlIC0gKG1pZEluZGV4IC0gaSkgKiBvcHRpb25zLm1pbnV0ZVN0ZXApOwogICAgICAgICAgICBtaW51dGVzLnB1c2goe2RhdGU6IG1pbnV0ZSwgbGFiZWw6IGRhdGVGaWx0ZXIobWludXRlLCBmb3JtYXRzWzJdKSwgc2VsZWN0ZWQ6ICR0aW1lcGlja2VyLiRkYXRlICYmICR0aW1lcGlja2VyLiRpc1NlbGVjdGVkKG1pbnV0ZSwgMSksIGRpc2FibGVkOiAkdGltZXBpY2tlci4kaXNEaXNhYmxlZChtaW51dGUsIDEpfSk7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHJvd3MgPSBbXTsKICAgICAgICAgIGZvcihpID0gMDsgaSA8IG9wdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcm93cy5wdXNoKFtob3Vyc1tpXSwgbWludXRlc1tpXV0pOwogICAgICAgICAgfQogICAgICAgICAgc2NvcGUucm93cyA9IHJvd3M7CiAgICAgICAgICBzY29wZS5zaG93QU0gPSAhIWZvcm1hdHNbM107CiAgICAgICAgICBzY29wZS5pc0FNID0gKCR0aW1lcGlja2VyLiRkYXRlIHx8IGhvdXJzW21pZEluZGV4XS5kYXRlKS5nZXRIb3VycygpIDwgMTI7CiAgICAgICAgICBzY29wZS50aW1lU2VwYXJhdG9yID0gZm9ybWF0c1sxXTsKICAgICAgICAgICR0aW1lcGlja2VyLiRpc0J1aWx0ID0gdHJ1ZTsKICAgICAgICB9OwoKICAgICAgICAkdGltZXBpY2tlci4kaXNTZWxlY3RlZCA9IGZ1bmN0aW9uKGRhdGUsIGluZGV4KSB7CiAgICAgICAgICBpZighJHRpbWVwaWNrZXIuJGRhdGUpIHJldHVybiBmYWxzZTsKICAgICAgICAgIGVsc2UgaWYoaW5kZXggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGUuZ2V0SG91cnMoKSA9PT0gJHRpbWVwaWNrZXIuJGRhdGUuZ2V0SG91cnMoKTsKICAgICAgICAgIH0gZWxzZSBpZihpbmRleCA9PT0gMSkgewogICAgICAgICAgICByZXR1cm4gZGF0ZS5nZXRNaW51dGVzKCkgPT09ICR0aW1lcGlja2VyLiRkYXRlLmdldE1pbnV0ZXMoKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAkdGltZXBpY2tlci4kaXNEaXNhYmxlZCA9IGZ1bmN0aW9uKGRhdGUsIGluZGV4KSB7CiAgICAgICAgICB2YXIgc2VsZWN0ZWRUaW1lOwogICAgICAgICAgaWYoaW5kZXggPT09IDApIHsKICAgICAgICAgICAgc2VsZWN0ZWRUaW1lID0gZGF0ZS5nZXRUaW1lKCkgKyB2aWV3RGF0ZS5taW51dGUgKiA2ZTQ7CiAgICAgICAgICB9IGVsc2UgaWYoaW5kZXggPT09IDEpIHsKICAgICAgICAgICAgc2VsZWN0ZWRUaW1lID0gZGF0ZS5nZXRUaW1lKCkgKyB2aWV3RGF0ZS5ob3VyICogMzZlNTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzZWxlY3RlZFRpbWUgPCBvcHRpb25zLm1pblRpbWUgKiAxIHx8IHNlbGVjdGVkVGltZSA+IG9wdGlvbnMubWF4VGltZSAqIDE7CiAgICAgICAgfTsKCiAgICAgICAgc2NvcGUuJGFycm93QWN0aW9uID0gZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkgewogICAgICAgICAgaWYgKG9wdGlvbnMuYXJyb3dCZWhhdmlvciA9PT0gJ3BpY2tlcicpIHsKICAgICAgICAgICAgJHRpbWVwaWNrZXIuJHNldFRpbWVCeVN0ZXAodmFsdWUsaW5kZXgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJHRpbWVwaWNrZXIuJG1vdmVJbmRleCh2YWx1ZSxpbmRleCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgJHRpbWVwaWNrZXIuJHNldFRpbWVCeVN0ZXAgPSBmdW5jdGlvbih2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgIHZhciBuZXdEYXRlID0gbmV3IERhdGUoJHRpbWVwaWNrZXIuJGRhdGUpOwogICAgICAgICAgdmFyIGhvdXJzID0gbmV3RGF0ZS5nZXRIb3VycygpLCBob3Vyc0xlbmd0aCA9IGRhdGVGaWx0ZXIobmV3RGF0ZSwgJ2gnKS5sZW5ndGg7CiAgICAgICAgICB2YXIgbWludXRlcyA9IG5ld0RhdGUuZ2V0TWludXRlcygpLCBtaW51dGVzTGVuZ3RoID0gZGF0ZUZpbHRlcihuZXdEYXRlLCAnbW0nKS5sZW5ndGg7CiAgICAgICAgICBpZiAoaW5kZXggPT09IDApIHsKICAgICAgICAgICAgbmV3RGF0ZS5zZXRIb3Vycyhob3VycyAtIChwYXJzZUludChvcHRpb25zLmhvdXJTdGVwLCAxMCkgKiB2YWx1ZSkpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIG5ld0RhdGUuc2V0TWludXRlcyhtaW51dGVzIC0gKHBhcnNlSW50KG9wdGlvbnMubWludXRlU3RlcCwgMTApICogdmFsdWUpKTsKICAgICAgICAgIH0KICAgICAgICAgICR0aW1lcGlja2VyLnNlbGVjdChuZXdEYXRlLCBpbmRleCwgdHJ1ZSk7CiAgICAgICAgICBwYXJlbnRTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgfTsKCiAgICAgICAgJHRpbWVwaWNrZXIuJG1vdmVJbmRleCA9IGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICAgICAgdmFyIHRhcmdldERhdGU7CiAgICAgICAgICBpZihpbmRleCA9PT0gMCkgewogICAgICAgICAgICB0YXJnZXREYXRlID0gbmV3IERhdGUoMTk3MCwgMCwgMSwgdmlld0RhdGUuaG91ciArICh2YWx1ZSAqIG9wdGlvbnMubGVuZ3RoKSwgdmlld0RhdGUubWludXRlKTsKICAgICAgICAgICAgYW5ndWxhci5leHRlbmQodmlld0RhdGUsIHtob3VyOiB0YXJnZXREYXRlLmdldEhvdXJzKCl9KTsKICAgICAgICAgIH0gZWxzZSBpZihpbmRleCA9PT0gMSkgewogICAgICAgICAgICB0YXJnZXREYXRlID0gbmV3IERhdGUoMTk3MCwgMCwgMSwgdmlld0RhdGUuaG91ciwgdmlld0RhdGUubWludXRlICsgKHZhbHVlICogb3B0aW9ucy5sZW5ndGggKiBvcHRpb25zLm1pbnV0ZVN0ZXApKTsKICAgICAgICAgICAgYW5ndWxhci5leHRlbmQodmlld0RhdGUsIHttaW51dGU6IHRhcmdldERhdGUuZ2V0TWludXRlcygpfSk7CiAgICAgICAgICB9CiAgICAgICAgICAkdGltZXBpY2tlci4kYnVpbGQoKTsKICAgICAgICB9OwoKICAgICAgICAkdGltZXBpY2tlci4kb25Nb3VzZURvd24gPSBmdW5jdGlvbihldnQpIHsKICAgICAgICAgIC8vIFByZXZlbnQgYmx1ciBvbiBtb3VzZWRvd24gb24gLmRyb3Bkb3duLW1lbnUKICAgICAgICAgIGlmKGV2dC50YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gJ2lucHV0JykgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAvLyBFbXVsYXRlIGNsaWNrIGZvciBtb2JpbGUgZGV2aWNlcwogICAgICAgICAgaWYoaXNUb3VjaCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0RWwgPSBhbmd1bGFyLmVsZW1lbnQoZXZ0LnRhcmdldCk7CiAgICAgICAgICAgIGlmKHRhcmdldEVsWzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdidXR0b24nKSB7CiAgICAgICAgICAgICAgdGFyZ2V0RWwgPSB0YXJnZXRFbC5wYXJlbnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YXJnZXRFbC50cmlnZ2VySGFuZGxlcignY2xpY2snKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAkdGltZXBpY2tlci4kb25LZXlEb3duID0gZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICBpZiAoIS8oMzh8Mzd8Mzl8NDB8MTMpLy50ZXN0KGV2dC5rZXlDb2RlKSB8fCBldnQuc2hpZnRLZXkgfHwgZXZ0LmFsdEtleSkgcmV0dXJuOwogICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CgogICAgICAgICAgLy8gQ2xvc2Ugb24gZW50ZXIKICAgICAgICAgIGlmKGV2dC5rZXlDb2RlID09PSAxMykgcmV0dXJuICR0aW1lcGlja2VyLmhpZGUodHJ1ZSk7CgogICAgICAgICAgLy8gTmF2aWdhdGUgd2l0aCBrZXlib2FyZAogICAgICAgICAgdmFyIG5ld0RhdGUgPSBuZXcgRGF0ZSgkdGltZXBpY2tlci4kZGF0ZSk7CiAgICAgICAgICB2YXIgaG91cnMgPSBuZXdEYXRlLmdldEhvdXJzKCksIGhvdXJzTGVuZ3RoID0gZGF0ZUZpbHRlcihuZXdEYXRlLCAnaCcpLmxlbmd0aDsKICAgICAgICAgIHZhciBtaW51dGVzID0gbmV3RGF0ZS5nZXRNaW51dGVzKCksIG1pbnV0ZXNMZW5ndGggPSBkYXRlRmlsdGVyKG5ld0RhdGUsICdtbScpLmxlbmd0aDsKICAgICAgICAgIHZhciBsYXRlcmFsTW92ZSA9IC8oMzd8MzkpLy50ZXN0KGV2dC5rZXlDb2RlKTsKICAgICAgICAgIHZhciBjb3VudCA9IDIgKyAhIWZvcm1hdHNbM10gKiAxOwoKICAgICAgICAgIC8vIE5hdmlnYXRlIGluZGV4ZXMgKGxlZnQsIHJpZ2h0KQogICAgICAgICAgaWYgKGxhdGVyYWxNb3ZlKSB7CiAgICAgICAgICAgIGlmKGV2dC5rZXlDb2RlID09PSAzNykgc2VsZWN0ZWRJbmRleCA9IHNlbGVjdGVkSW5kZXggPCAxID8gY291bnQgLSAxIDogc2VsZWN0ZWRJbmRleCAtIDE7CiAgICAgICAgICAgIGVsc2UgaWYoZXZ0LmtleUNvZGUgPT09IDM5KSBzZWxlY3RlZEluZGV4ID0gc2VsZWN0ZWRJbmRleCA8IGNvdW50IC0gMSA/IHNlbGVjdGVkSW5kZXggKyAxIDogMDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBVcGRhdGUgdmFsdWVzICh1cCwgZG93bikKICAgICAgICAgIHZhciBzZWxlY3RSYW5nZSA9IFswLCBob3Vyc0xlbmd0aF07CiAgICAgICAgICBpZihzZWxlY3RlZEluZGV4ID09PSAwKSB7CiAgICAgICAgICAgIGlmKGV2dC5rZXlDb2RlID09PSAzOCkgbmV3RGF0ZS5zZXRIb3Vycyhob3VycyAtIHBhcnNlSW50KG9wdGlvbnMuaG91clN0ZXAsIDEwKSk7CiAgICAgICAgICAgIGVsc2UgaWYoZXZ0LmtleUNvZGUgPT09IDQwKSBuZXdEYXRlLnNldEhvdXJzKGhvdXJzICsgcGFyc2VJbnQob3B0aW9ucy5ob3VyU3RlcCwgMTApKTsKICAgICAgICAgICAgc2VsZWN0UmFuZ2UgPSBbMCwgaG91cnNMZW5ndGhdOwogICAgICAgICAgfSBlbHNlIGlmKHNlbGVjdGVkSW5kZXggPT09IDEpIHsKICAgICAgICAgICAgaWYoZXZ0LmtleUNvZGUgPT09IDM4KSBuZXdEYXRlLnNldE1pbnV0ZXMobWludXRlcyAtIHBhcnNlSW50KG9wdGlvbnMubWludXRlU3RlcCwgMTApKTsKICAgICAgICAgICAgZWxzZSBpZihldnQua2V5Q29kZSA9PT0gNDApIG5ld0RhdGUuc2V0TWludXRlcyhtaW51dGVzICsgcGFyc2VJbnQob3B0aW9ucy5taW51dGVTdGVwLCAxMCkpOwogICAgICAgICAgICBzZWxlY3RSYW5nZSA9IFtob3Vyc0xlbmd0aCArIDEsIGhvdXJzTGVuZ3RoICsgMSArIG1pbnV0ZXNMZW5ndGhdOwogICAgICAgICAgfSBlbHNlIGlmKHNlbGVjdGVkSW5kZXggPT09IDIpIHsKICAgICAgICAgICAgaWYoIWxhdGVyYWxNb3ZlKSAkdGltZXBpY2tlci5zd2l0Y2hNZXJpZGlhbigpOwogICAgICAgICAgICBzZWxlY3RSYW5nZSA9IFtob3Vyc0xlbmd0aCArIDEgKyBtaW51dGVzTGVuZ3RoICsgMSwgaG91cnNMZW5ndGggKyAxICsgbWludXRlc0xlbmd0aCArIDNdOwogICAgICAgICAgfQogICAgICAgICAgJHRpbWVwaWNrZXIuc2VsZWN0KG5ld0RhdGUsIHNlbGVjdGVkSW5kZXgsIHRydWUpOwogICAgICAgICAgY3JlYXRlU2VsZWN0aW9uKHNlbGVjdFJhbmdlWzBdLCBzZWxlY3RSYW5nZVsxXSk7CiAgICAgICAgICBwYXJlbnRTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gUHJpdmF0ZQoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVTZWxlY3Rpb24oc3RhcnQsIGVuZCkgewogICAgICAgICAgaWYoZWxlbWVudFswXS5jcmVhdGVUZXh0UmFuZ2UpIHsKICAgICAgICAgICAgdmFyIHNlbFJhbmdlID0gZWxlbWVudFswXS5jcmVhdGVUZXh0UmFuZ2UoKTsKICAgICAgICAgICAgc2VsUmFuZ2UuY29sbGFwc2UodHJ1ZSk7CiAgICAgICAgICAgIHNlbFJhbmdlLm1vdmVTdGFydCgnY2hhcmFjdGVyJywgc3RhcnQpOwogICAgICAgICAgICBzZWxSYW5nZS5tb3ZlRW5kKCdjaGFyYWN0ZXInLCBlbmQpOwogICAgICAgICAgICBzZWxSYW5nZS5zZWxlY3QoKTsKICAgICAgICAgIH0gZWxzZSBpZihlbGVtZW50WzBdLnNldFNlbGVjdGlvblJhbmdlKSB7CiAgICAgICAgICAgIGVsZW1lbnRbMF0uc2V0U2VsZWN0aW9uUmFuZ2Uoc3RhcnQsIGVuZCk7CiAgICAgICAgICB9IGVsc2UgaWYoYW5ndWxhci5pc1VuZGVmaW5lZChlbGVtZW50WzBdLnNlbGVjdGlvblN0YXJ0KSkgewogICAgICAgICAgICBlbGVtZW50WzBdLnNlbGVjdGlvblN0YXJ0ID0gc3RhcnQ7CiAgICAgICAgICAgIGVsZW1lbnRbMF0uc2VsZWN0aW9uRW5kID0gZW5kOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZm9jdXNFbGVtZW50KCkgewogICAgICAgICAgZWxlbWVudFswXS5mb2N1cygpOwogICAgICAgIH0KCiAgICAgICAgLy8gT3ZlcnJpZGVzCgogICAgICAgIHZhciBfaW5pdCA9ICR0aW1lcGlja2VyLmluaXQ7CiAgICAgICAgJHRpbWVwaWNrZXIuaW5pdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYoaXNOYXRpdmUgJiYgb3B0aW9ucy51c2VOYXRpdmUpIHsKICAgICAgICAgICAgZWxlbWVudC5wcm9wKCd0eXBlJywgJ3RpbWUnKTsKICAgICAgICAgICAgZWxlbWVudC5jc3MoJy13ZWJraXQtYXBwZWFyYW5jZScsICd0ZXh0ZmllbGQnKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSBlbHNlIGlmKGlzVG91Y2gpIHsKICAgICAgICAgICAgZWxlbWVudC5wcm9wKCd0eXBlJywgJ3RleHQnKTsKICAgICAgICAgICAgZWxlbWVudC5hdHRyKCdyZWFkb25seScsICd0cnVlJyk7CiAgICAgICAgICAgIGVsZW1lbnQub24oJ2NsaWNrJywgZm9jdXNFbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIF9pbml0KCk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIF9kZXN0cm95ID0gJHRpbWVwaWNrZXIuZGVzdHJveTsKICAgICAgICAkdGltZXBpY2tlci5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZihpc05hdGl2ZSAmJiBvcHRpb25zLnVzZU5hdGl2ZSkgewogICAgICAgICAgICBlbGVtZW50Lm9mZignY2xpY2snLCBmb2N1c0VsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgX2Rlc3Ryb3koKTsKICAgICAgICB9OwoKICAgICAgICB2YXIgX3Nob3cgPSAkdGltZXBpY2tlci5zaG93OwogICAgICAgICR0aW1lcGlja2VyLnNob3cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIF9zaG93KCk7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkdGltZXBpY2tlci4kZWxlbWVudC5vbihpc1RvdWNoID8gJ3RvdWNoc3RhcnQnIDogJ21vdXNlZG93bicsICR0aW1lcGlja2VyLiRvbk1vdXNlRG93bik7CiAgICAgICAgICAgIGlmKG9wdGlvbnMua2V5Ym9hcmQpIHsKICAgICAgICAgICAgICBlbGVtZW50Lm9uKCdrZXlkb3duJywgJHRpbWVwaWNrZXIuJG9uS2V5RG93bik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHZhciBfaGlkZSA9ICR0aW1lcGlja2VyLmhpZGU7CiAgICAgICAgJHRpbWVwaWNrZXIuaGlkZSA9IGZ1bmN0aW9uKGJsdXIpIHsKICAgICAgICAgIGlmKCEkdGltZXBpY2tlci4kaXNTaG93bikgcmV0dXJuOwogICAgICAgICAgJHRpbWVwaWNrZXIuJGVsZW1lbnQub2ZmKGlzVG91Y2ggPyAndG91Y2hzdGFydCcgOiAnbW91c2Vkb3duJywgJHRpbWVwaWNrZXIuJG9uTW91c2VEb3duKTsKICAgICAgICAgIGlmKG9wdGlvbnMua2V5Ym9hcmQpIHsKICAgICAgICAgICAgZWxlbWVudC5vZmYoJ2tleWRvd24nLCAkdGltZXBpY2tlci4kb25LZXlEb3duKTsKICAgICAgICAgIH0KICAgICAgICAgIF9oaWRlKGJsdXIpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiAkdGltZXBpY2tlcjsKCiAgICAgIH0KCiAgICAgIHRpbWVwaWNrZXJGYWN0b3J5LmRlZmF1bHRzID0gZGVmYXVsdHM7CiAgICAgIHJldHVybiB0aW1lcGlja2VyRmFjdG9yeTsKCiAgICB9XTsKCiAgfSkKCgogIC5kaXJlY3RpdmUoJ2JzVGltZXBpY2tlcicsIFsiJHdpbmRvdyIsICIkcGFyc2UiLCAiJHEiLCAiJGxvY2FsZSIsICJkYXRlRmlsdGVyIiwgIiR0aW1lcGlja2VyIiwgIiRkYXRlUGFyc2VyIiwgIiR0aW1lb3V0IiwgZnVuY3Rpb24oJHdpbmRvdywgJHBhcnNlLCAkcSwgJGxvY2FsZSwgZGF0ZUZpbHRlciwgJHRpbWVwaWNrZXIsICRkYXRlUGFyc2VyLCAkdGltZW91dCkgewoKICAgIHZhciBkZWZhdWx0cyA9ICR0aW1lcGlja2VyLmRlZmF1bHRzOwogICAgdmFyIGlzTmF0aXZlID0gLyhpcChhfG8pZHxpcGhvbmV8YW5kcm9pZCkvaWcudGVzdCgkd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpOwogICAgdmFyIHJlcXVlc3RBbmltYXRpb25GcmFtZSA9ICR3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8ICR3aW5kb3cuc2V0VGltZW91dDsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0VBQycsCiAgICAgIHJlcXVpcmU6ICduZ01vZGVsJywKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGNvbnRyb2xsZXIpIHsKCiAgICAgICAgLy8gRGlyZWN0aXZlIG9wdGlvbnMKICAgICAgICB2YXIgb3B0aW9ucyA9IHtzY29wZTogc2NvcGUsIGNvbnRyb2xsZXI6IGNvbnRyb2xsZXJ9OwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ3BsYWNlbWVudCcsICdjb250YWluZXInLCAnZGVsYXknLCAndHJpZ2dlcicsICdrZXlib2FyZCcsICdodG1sJywgJ2FuaW1hdGlvbicsICd0ZW1wbGF0ZScsICdhdXRvY2xvc2UnLCAndGltZVR5cGUnLCAndGltZUZvcm1hdCcsICdtb2RlbFRpbWVGb3JtYXQnLCAndXNlTmF0aXZlJywgJ2hvdXJTdGVwJywgJ21pbnV0ZVN0ZXAnLCAnbGVuZ3RoJywgJ2Fycm93QmVoYXZpb3InLCAnaWNvblVwJywgJ2ljb25Eb3duJ10sIGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgaWYoYW5ndWxhci5pc0RlZmluZWQoYXR0cltrZXldKSkgb3B0aW9uc1trZXldID0gYXR0cltrZXldOwogICAgICAgIH0pOwoKICAgICAgICAvLyBWaXNpYmlsaXR5IGJpbmRpbmcgc3VwcG9ydAogICAgICAgIGF0dHIuYnNTaG93ICYmIHNjb3BlLiR3YXRjaChhdHRyLmJzU2hvdywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICBpZighdGltZXBpY2tlciB8fCAhYW5ndWxhci5pc0RlZmluZWQobmV3VmFsdWUpKSByZXR1cm47CiAgICAgICAgICBpZihhbmd1bGFyLmlzU3RyaW5nKG5ld1ZhbHVlKSkgbmV3VmFsdWUgPSAhIW5ld1ZhbHVlLm1hdGNoKC90cnVlfCw/KHRpbWVwaWNrZXIpLD8vaSk7CiAgICAgICAgICBuZXdWYWx1ZSA9PT0gdHJ1ZSA/IHRpbWVwaWNrZXIuc2hvdygpIDogdGltZXBpY2tlci5oaWRlKCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIEluaXRpYWxpemUgdGltZXBpY2tlcgogICAgICAgIGlmKGlzTmF0aXZlICYmIChvcHRpb25zLnVzZU5hdGl2ZSB8fCBkZWZhdWx0cy51c2VOYXRpdmUpKSBvcHRpb25zLnRpbWVGb3JtYXQgPSAnSEg6bW0nOwogICAgICAgIHZhciB0aW1lcGlja2VyID0gJHRpbWVwaWNrZXIoZWxlbWVudCwgY29udHJvbGxlciwgb3B0aW9ucyk7CiAgICAgICAgb3B0aW9ucyA9IHRpbWVwaWNrZXIuJG9wdGlvbnM7CgogICAgICAgIC8vIEluaXRpYWxpemUgcGFyc2VyCiAgICAgICAgdmFyIGRhdGVQYXJzZXIgPSAkZGF0ZVBhcnNlcih7Zm9ybWF0OiBvcHRpb25zLnRpbWVGb3JtYXQsIGxhbmc6IG9wdGlvbnMubGFuZ30pOwoKICAgICAgICAvLyBPYnNlcnZlIGF0dHJpYnV0ZXMgZm9yIGNoYW5nZXMKICAgICAgICBhbmd1bGFyLmZvckVhY2goWydtaW5UaW1lJywgJ21heFRpbWUnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJ2F0dHIuJG9ic2VydmUoJXMpJywga2V5LCBhdHRyW2tleV0pOwogICAgICAgICAgYW5ndWxhci5pc0RlZmluZWQoYXR0cltrZXldKSAmJiBhdHRyLiRvYnNlcnZlKGtleSwgZnVuY3Rpb24obmV3VmFsdWUpIHsKICAgICAgICAgICAgdGltZXBpY2tlci4kb3B0aW9uc1trZXldID0gZGF0ZVBhcnNlci5nZXRUaW1lRm9yQXR0cmlidXRlKGtleSwgbmV3VmFsdWUpOwogICAgICAgICAgICAhaXNOYU4odGltZXBpY2tlci4kb3B0aW9uc1trZXldKSAmJiB0aW1lcGlja2VyLiRidWlsZCgpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIFdhdGNoIG1vZGVsIGZvciBjaGFuZ2VzCiAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdNb2RlbCwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJ3Njb3BlLiR3YXRjaCglcyknLCBhdHRyLm5nTW9kZWwsIG5ld1ZhbHVlLCBvbGRWYWx1ZSwgY29udHJvbGxlci4kZGF0ZVZhbHVlKTsKICAgICAgICAgIHRpbWVwaWNrZXIudXBkYXRlKGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSk7CiAgICAgICAgfSwgdHJ1ZSk7CgogICAgICAgIC8vIHZpZXdWYWx1ZSAtPiAkcGFyc2VycyAtPiBtb2RlbFZhbHVlCiAgICAgICAgY29udHJvbGxlci4kcGFyc2Vycy51bnNoaWZ0KGZ1bmN0aW9uKHZpZXdWYWx1ZSkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCckcGFyc2VyKCIlcyIpOiB2aWV3VmFsdWU9JW8nLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksIHZpZXdWYWx1ZSk7CiAgICAgICAgICAvLyBOdWxsIHZhbHVlcyBzaG91bGQgY29ycmVjdGx5IHJlc2V0IHRoZSBtb2RlbCB2YWx1ZSAmIHZhbGlkaXR5CiAgICAgICAgICBpZighdmlld1ZhbHVlKSB7CiAgICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZhbGlkaXR5KCdkYXRlJywgdHJ1ZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJzZWRUaW1lID0gYW5ndWxhci5pc0RhdGUodmlld1ZhbHVlKSA/IHZpZXdWYWx1ZSA6IGRhdGVQYXJzZXIucGFyc2Uodmlld1ZhbHVlLCBjb250cm9sbGVyLiRkYXRlVmFsdWUpOwogICAgICAgICAgaWYoIXBhcnNlZFRpbWUgfHwgaXNOYU4ocGFyc2VkVGltZS5nZXRUaW1lKCkpKSB7CiAgICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZhbGlkaXR5KCdkYXRlJywgZmFsc2UpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBpc01pblZhbGlkID0gaXNOYU4ob3B0aW9ucy5taW5UaW1lKSB8fCBwYXJzZWRUaW1lLmdldFRpbWUoKSA+PSBvcHRpb25zLm1pblRpbWU7CiAgICAgICAgICAgICAgdmFyIGlzTWF4VmFsaWQgPSBpc05hTihvcHRpb25zLm1heFRpbWUpIHx8IHBhcnNlZFRpbWUuZ2V0VGltZSgpIDw9IG9wdGlvbnMubWF4VGltZTsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IGlzTWluVmFsaWQgJiYgaXNNYXhWYWxpZDsKICAgICAgICAgICAgICBjb250cm9sbGVyLiRzZXRWYWxpZGl0eSgnZGF0ZScsIGlzVmFsaWQpOwogICAgICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZhbGlkaXR5KCdtaW4nLCBpc01pblZhbGlkKTsKICAgICAgICAgICAgICBjb250cm9sbGVyLiRzZXRWYWxpZGl0eSgnbWF4JywgaXNNYXhWYWxpZCk7CiAgICAgICAgICAgICAgLy8gT25seSB1cGRhdGUgdGhlIG1vZGVsIHdoZW4gd2UgaGF2ZSBhIHZhbGlkIGRhdGUKICAgICAgICAgICAgICBpZighaXNWYWxpZCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSA9IHBhcnNlZFRpbWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZihvcHRpb25zLnRpbWVUeXBlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICByZXR1cm4gZGF0ZUZpbHRlcihwYXJzZWRUaW1lLCBvcHRpb25zLm1vZGVsVGltZUZvcm1hdCB8fCBvcHRpb25zLnRpbWVGb3JtYXQpOwogICAgICAgICAgfSBlbHNlIGlmKG9wdGlvbnMudGltZVR5cGUgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHJldHVybiBjb250cm9sbGVyLiRkYXRlVmFsdWUuZ2V0VGltZSgpOwogICAgICAgICAgfSBlbHNlIGlmKG9wdGlvbnMudGltZVR5cGUgPT09ICdpc28nKSB7CiAgICAgICAgICAgIHJldHVybiBjb250cm9sbGVyLiRkYXRlVmFsdWUudG9JU09TdHJpbmcoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShjb250cm9sbGVyLiRkYXRlVmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyBtb2RlbFZhbHVlIC0+ICRmb3JtYXR0ZXJzIC0+IHZpZXdWYWx1ZQogICAgICAgIGNvbnRyb2xsZXIuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbihtb2RlbFZhbHVlKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRmb3JtYXR0ZXIoIiVzIik6IG1vZGVsVmFsdWU9JW8gKCVvKScsIGVsZW1lbnQuYXR0cignbmctbW9kZWwnKSwgbW9kZWxWYWx1ZSwgdHlwZW9mIG1vZGVsVmFsdWUpOwogICAgICAgICAgdmFyIGRhdGU7CiAgICAgICAgICBpZihhbmd1bGFyLmlzVW5kZWZpbmVkKG1vZGVsVmFsdWUpIHx8IG1vZGVsVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgZGF0ZSA9IE5hTjsKICAgICAgICAgIH0gZWxzZSBpZihhbmd1bGFyLmlzRGF0ZShtb2RlbFZhbHVlKSkgewogICAgICAgICAgICBkYXRlID0gbW9kZWxWYWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZihvcHRpb25zLnRpbWVUeXBlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBkYXRlID0gZGF0ZVBhcnNlci5wYXJzZShtb2RlbFZhbHVlLCBudWxsLCBvcHRpb25zLm1vZGVsVGltZUZvcm1hdCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkYXRlID0gbmV3IERhdGUobW9kZWxWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBTZXR1cCBkZWZhdWx0IHZhbHVlPwogICAgICAgICAgLy8gaWYoaXNOYU4oZGF0ZS5nZXRUaW1lKCkpKSBkYXRlID0gbmV3IERhdGUobmV3IERhdGUoKS5zZXRNaW51dGVzKDApICsgMzZlNSk7CiAgICAgICAgICBjb250cm9sbGVyLiRkYXRlVmFsdWUgPSBkYXRlOwogICAgICAgICAgcmV0dXJuIGNvbnRyb2xsZXIuJGRhdGVWYWx1ZTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gdmlld1ZhbHVlIC0+IGVsZW1lbnQKICAgICAgICBjb250cm9sbGVyLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2FybignJHJlbmRlcigiJXMiKTogdmlld1ZhbHVlPSVvJywgZWxlbWVudC5hdHRyKCduZy1tb2RlbCcpLCBjb250cm9sbGVyLiR2aWV3VmFsdWUpOwogICAgICAgICAgZWxlbWVudC52YWwoIWNvbnRyb2xsZXIuJGRhdGVWYWx1ZSB8fCBpc05hTihjb250cm9sbGVyLiRkYXRlVmFsdWUuZ2V0VGltZSgpKSA/ICcnIDogZGF0ZUZpbHRlcihjb250cm9sbGVyLiRkYXRlVmFsdWUsIG9wdGlvbnMudGltZUZvcm1hdCkpOwogICAgICAgIH07CgogICAgICAgIC8vIEdhcmJhZ2UgY29sbGVjdGlvbgogICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICh0aW1lcGlja2VyKSB0aW1lcGlja2VyLmRlc3Ryb3koKTsKICAgICAgICAgIG9wdGlvbnMgPSBudWxsOwogICAgICAgICAgdGltZXBpY2tlciA9IG51bGw7CiAgICAgICAgfSk7CgogICAgICB9CiAgICB9OwoKICB9XSk7CgovLyBTb3VyY2U6IHRvb2x0aXAuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLnRvb2x0aXAnLCBbJ21nY3JlYS5uZ1N0cmFwLmhlbHBlcnMuZGltZW5zaW9ucyddKQoKICAucHJvdmlkZXIoJyR0b29sdGlwJywgZnVuY3Rpb24oKSB7CgogICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgYW5pbWF0aW9uOiAnYW0tZmFkZScsCiAgICAgIGN1c3RvbUNsYXNzOiAnJywKICAgICAgcHJlZml4Q2xhc3M6ICd0b29sdGlwJywKICAgICAgcHJlZml4RXZlbnQ6ICd0b29sdGlwJywKICAgICAgY29udGFpbmVyOiBmYWxzZSwKICAgICAgdGFyZ2V0OiBmYWxzZSwKICAgICAgcGxhY2VtZW50OiAndG9wJywKICAgICAgdGVtcGxhdGU6ICd0b29sdGlwL3Rvb2x0aXAudHBsLmh0bWwnLAogICAgICBjb250ZW50VGVtcGxhdGU6IGZhbHNlLAogICAgICB0cmlnZ2VyOiAnaG92ZXIgZm9jdXMnLAogICAgICBrZXlib2FyZDogZmFsc2UsCiAgICAgIGh0bWw6IGZhbHNlLAogICAgICBzaG93OiBmYWxzZSwKICAgICAgdGl0bGU6ICcnLAogICAgICB0eXBlOiAnJywKICAgICAgZGVsYXk6IDAKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gWyIkd2luZG93IiwgIiRyb290U2NvcGUiLCAiJGNvbXBpbGUiLCAiJHEiLCAiJHRlbXBsYXRlQ2FjaGUiLCAiJGh0dHAiLCAiJGFuaW1hdGUiLCAiZGltZW5zaW9ucyIsICIkJHJBRiIsIGZ1bmN0aW9uKCR3aW5kb3csICRyb290U2NvcGUsICRjb21waWxlLCAkcSwgJHRlbXBsYXRlQ2FjaGUsICRodHRwLCAkYW5pbWF0ZSwgZGltZW5zaW9ucywgJCRyQUYpIHsKCiAgICAgIHZhciB0cmltID0gU3RyaW5nLnByb3RvdHlwZS50cmltOwogICAgICB2YXIgaXNUb3VjaCA9ICdjcmVhdGVUb3VjaCcgaW4gJHdpbmRvdy5kb2N1bWVudDsKICAgICAgdmFyIGh0bWxSZXBsYWNlUmVnRXhwID0gL25nLWJpbmQ9Ii9pZzsKCiAgICAgIGZ1bmN0aW9uIFRvb2x0aXBGYWN0b3J5KGVsZW1lbnQsIGNvbmZpZykgewoKICAgICAgICB2YXIgJHRvb2x0aXAgPSB7fTsKCiAgICAgICAgLy8gQ29tbW9uIHZhcnMKICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtZW50WzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgdmFyIG9wdGlvbnMgPSAkdG9vbHRpcC4kb3B0aW9ucyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBkZWZhdWx0cywgY29uZmlnKTsKICAgICAgICAkdG9vbHRpcC4kcHJvbWlzZSA9IGZldGNoVGVtcGxhdGUob3B0aW9ucy50ZW1wbGF0ZSk7CiAgICAgICAgdmFyIHNjb3BlID0gJHRvb2x0aXAuJHNjb3BlID0gb3B0aW9ucy5zY29wZSAmJiBvcHRpb25zLnNjb3BlLiRuZXcoKSB8fCAkcm9vdFNjb3BlLiRuZXcoKTsKICAgICAgICBpZihvcHRpb25zLmRlbGF5ICYmIGFuZ3VsYXIuaXNTdHJpbmcob3B0aW9ucy5kZWxheSkpIHsKICAgICAgICAgIHZhciBzcGxpdCA9IG9wdGlvbnMuZGVsYXkuc3BsaXQoJywnKS5tYXAocGFyc2VGbG9hdCk7CiAgICAgICAgICBvcHRpb25zLmRlbGF5ID0gc3BsaXQubGVuZ3RoID4gMSA/IHtzaG93OiBzcGxpdFswXSwgaGlkZTogc3BsaXRbMV19IDogc3BsaXRbMF07CiAgICAgICAgfQoKICAgICAgICAvLyBTdXBwb3J0IHNjb3BlIGFzIHN0cmluZyBvcHRpb25zCiAgICAgICAgaWYob3B0aW9ucy50aXRsZSkgewogICAgICAgICAgJHRvb2x0aXAuJHNjb3BlLnRpdGxlID0gb3B0aW9ucy50aXRsZTsKICAgICAgICB9CgogICAgICAgIC8vIFByb3ZpZGUgc2NvcGUgaGVscGVycwogICAgICAgIHNjb3BlLiRoaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBzY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICR0b29sdGlwLmhpZGUoKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgc2NvcGUuJHNob3cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHRvb2x0aXAuc2hvdygpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICBzY29wZS4kdG9nZ2xlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBzY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICR0b29sdGlwLnRvZ2dsZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICAkdG9vbHRpcC4kaXNTaG93biA9IHNjb3BlLiRpc1Nob3duID0gZmFsc2U7CgogICAgICAgIC8vIFByaXZhdGUgdmFycwogICAgICAgIHZhciB0aW1lb3V0LCBob3ZlclN0YXRlOwoKICAgICAgICAvLyBTdXBwb3J0IGNvbnRlbnRUZW1wbGF0ZSBvcHRpb24KICAgICAgICBpZihvcHRpb25zLmNvbnRlbnRUZW1wbGF0ZSkgewogICAgICAgICAgJHRvb2x0aXAuJHByb21pc2UgPSAkdG9vbHRpcC4kcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZUVsID0gYW5ndWxhci5lbGVtZW50KHRlbXBsYXRlKTsKICAgICAgICAgICAgcmV0dXJuIGZldGNoVGVtcGxhdGUob3B0aW9ucy5jb250ZW50VGVtcGxhdGUpCiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKGNvbnRlbnRUZW1wbGF0ZSkgewogICAgICAgICAgICAgIHZhciBjb250ZW50RWwgPSBmaW5kRWxlbWVudCgnW25nLWJpbmQ9ImNvbnRlbnQiXScsIHRlbXBsYXRlRWxbMF0pOwogICAgICAgICAgICAgIGlmKCFjb250ZW50RWwubGVuZ3RoKSBjb250ZW50RWwgPSBmaW5kRWxlbWVudCgnW25nLWJpbmQ9InRpdGxlIl0nLCB0ZW1wbGF0ZUVsWzBdKTsKICAgICAgICAgICAgICBjb250ZW50RWwucmVtb3ZlQXR0cignbmctYmluZCcpLmh0bWwoY29udGVudFRlbXBsYXRlKTsKICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGVFbFswXS5vdXRlckhUTUw7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBGZXRjaCwgY29tcGlsZSB0aGVuIGluaXRpYWxpemUgdG9vbHRpcAogICAgICAgIHZhciB0aXBMaW5rZXIsIHRpcEVsZW1lbnQsIHRpcFRlbXBsYXRlLCB0aXBDb250YWluZXI7CiAgICAgICAgJHRvb2x0aXAuJHByb21pc2UudGhlbihmdW5jdGlvbih0ZW1wbGF0ZSkgewogICAgICAgICAgaWYoYW5ndWxhci5pc09iamVjdCh0ZW1wbGF0ZSkpIHRlbXBsYXRlID0gdGVtcGxhdGUuZGF0YTsKICAgICAgICAgIGlmKG9wdGlvbnMuaHRtbCkgdGVtcGxhdGUgPSB0ZW1wbGF0ZS5yZXBsYWNlKGh0bWxSZXBsYWNlUmVnRXhwLCAnbmctYmluZC1odG1sPSInKTsKICAgICAgICAgIHRlbXBsYXRlID0gdHJpbS5hcHBseSh0ZW1wbGF0ZSk7CiAgICAgICAgICB0aXBUZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgICAgdGlwTGlua2VyID0gJGNvbXBpbGUodGVtcGxhdGUpOwogICAgICAgICAgJHRvb2x0aXAuaW5pdCgpOwogICAgICAgIH0pOwoKICAgICAgICAkdG9vbHRpcC5pbml0ID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgLy8gT3B0aW9uczogZGVsYXkKICAgICAgICAgIGlmIChvcHRpb25zLmRlbGF5ICYmIGFuZ3VsYXIuaXNOdW1iZXIob3B0aW9ucy5kZWxheSkpIHsKICAgICAgICAgICAgb3B0aW9ucy5kZWxheSA9IHsKICAgICAgICAgICAgICBzaG93OiBvcHRpb25zLmRlbGF5LAogICAgICAgICAgICAgIGhpZGU6IG9wdGlvbnMuZGVsYXkKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBSZXBsYWNlIHRyaWdnZXIgb24gdG91Y2ggZGV2aWNlcyA/CiAgICAgICAgICAvLyBpZihpc1RvdWNoICYmIG9wdGlvbnMudHJpZ2dlciA9PT0gZGVmYXVsdHMudHJpZ2dlcikgewogICAgICAgICAgLy8gICBvcHRpb25zLnRyaWdnZXIucmVwbGFjZSgvaG92ZXIvZywgJ2NsaWNrJyk7CiAgICAgICAgICAvLyB9CgogICAgICAgICAgLy8gT3B0aW9ucyA6IGNvbnRhaW5lcgogICAgICAgICAgaWYob3B0aW9ucy5jb250YWluZXIgPT09ICdzZWxmJykgewogICAgICAgICAgICB0aXBDb250YWluZXIgPSBlbGVtZW50OwogICAgICAgICAgfSBlbHNlIGlmKGFuZ3VsYXIuaXNFbGVtZW50KG9wdGlvbnMuY29udGFpbmVyKSkgewogICAgICAgICAgICB0aXBDb250YWluZXIgPSBvcHRpb25zLmNvbnRhaW5lcjsKICAgICAgICAgIH0gZWxzZSBpZihvcHRpb25zLmNvbnRhaW5lcikgewogICAgICAgICAgICB0aXBDb250YWluZXIgPSBmaW5kRWxlbWVudChvcHRpb25zLmNvbnRhaW5lcik7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gT3B0aW9uczogdHJpZ2dlcgogICAgICAgICAgdmFyIHRyaWdnZXJzID0gb3B0aW9ucy50cmlnZ2VyLnNwbGl0KCcgJyk7CiAgICAgICAgICBhbmd1bGFyLmZvckVhY2godHJpZ2dlcnMsIGZ1bmN0aW9uKHRyaWdnZXIpIHsKICAgICAgICAgICAgaWYodHJpZ2dlciA9PT0gJ2NsaWNrJykgewogICAgICAgICAgICAgIGVsZW1lbnQub24oJ2NsaWNrJywgJHRvb2x0aXAudG9nZ2xlKTsKICAgICAgICAgICAgfSBlbHNlIGlmKHRyaWdnZXIgIT09ICdtYW51YWwnKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5vbih0cmlnZ2VyID09PSAnaG92ZXInID8gJ21vdXNlZW50ZXInIDogJ2ZvY3VzJywgJHRvb2x0aXAuZW50ZXIpOwogICAgICAgICAgICAgIGVsZW1lbnQub24odHJpZ2dlciA9PT0gJ2hvdmVyJyA/ICdtb3VzZWxlYXZlJyA6ICdibHVyJywgJHRvb2x0aXAubGVhdmUpOwogICAgICAgICAgICAgIG5vZGVOYW1lID09PSAnYnV0dG9uJyAmJiB0cmlnZ2VyICE9PSAnaG92ZXInICYmIGVsZW1lbnQub24oaXNUb3VjaCA/ICd0b3VjaHN0YXJ0JyA6ICdtb3VzZWRvd24nLCAkdG9vbHRpcC4kb25Gb2N1c0VsZW1lbnRNb3VzZURvd24pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICAvLyBPcHRpb25zOiB0YXJnZXQKICAgICAgICAgIGlmKG9wdGlvbnMudGFyZ2V0KSB7CiAgICAgICAgICAgIG9wdGlvbnMudGFyZ2V0ID0gYW5ndWxhci5pc0VsZW1lbnQob3B0aW9ucy50YXJnZXQpID8gb3B0aW9ucy50YXJnZXQgOiBmaW5kRWxlbWVudChvcHRpb25zLnRhcmdldCk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gT3B0aW9uczogc2hvdwogICAgICAgICAgaWYob3B0aW9ucy5zaG93KSB7CiAgICAgICAgICAgIHNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBvcHRpb25zLnRyaWdnZXIgPT09ICdmb2N1cycgPyBlbGVtZW50WzBdLmZvY3VzKCkgOiAkdG9vbHRpcC5zaG93KCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICB9OwoKICAgICAgICAkdG9vbHRpcC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgLy8gVW5iaW5kIGV2ZW50cwogICAgICAgICAgdmFyIHRyaWdnZXJzID0gb3B0aW9ucy50cmlnZ2VyLnNwbGl0KCcgJyk7CiAgICAgICAgICBmb3IgKHZhciBpID0gdHJpZ2dlcnMubGVuZ3RoOyBpLS07KSB7CiAgICAgICAgICAgIHZhciB0cmlnZ2VyID0gdHJpZ2dlcnNbaV07CiAgICAgICAgICAgIGlmKHRyaWdnZXIgPT09ICdjbGljaycpIHsKICAgICAgICAgICAgICBlbGVtZW50Lm9mZignY2xpY2snLCAkdG9vbHRpcC50b2dnbGUpOwogICAgICAgICAgICB9IGVsc2UgaWYodHJpZ2dlciAhPT0gJ21hbnVhbCcpIHsKICAgICAgICAgICAgICBlbGVtZW50Lm9mZih0cmlnZ2VyID09PSAnaG92ZXInID8gJ21vdXNlZW50ZXInIDogJ2ZvY3VzJywgJHRvb2x0aXAuZW50ZXIpOwogICAgICAgICAgICAgIGVsZW1lbnQub2ZmKHRyaWdnZXIgPT09ICdob3ZlcicgPyAnbW91c2VsZWF2ZScgOiAnYmx1cicsICR0b29sdGlwLmxlYXZlKTsKICAgICAgICAgICAgICBub2RlTmFtZSA9PT0gJ2J1dHRvbicgJiYgdHJpZ2dlciAhPT0gJ2hvdmVyJyAmJiBlbGVtZW50Lm9mZihpc1RvdWNoID8gJ3RvdWNoc3RhcnQnIDogJ21vdXNlZG93bicsICR0b29sdGlwLiRvbkZvY3VzRWxlbWVudE1vdXNlRG93bik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBSZW1vdmUgZWxlbWVudAogICAgICAgICAgaWYodGlwRWxlbWVudCkgewogICAgICAgICAgICB0aXBFbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICB0aXBFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBDYW5jZWwgcGVuZGluZyBjYWxsYmFja3MKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKCiAgICAgICAgICAvLyBEZXN0cm95IHNjb3BlCiAgICAgICAgICBzY29wZS4kZGVzdHJveSgpOwoKICAgICAgICB9OwoKICAgICAgICAkdG9vbHRpcC5lbnRlciA9IGZ1bmN0aW9uKCkgewoKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgIGhvdmVyU3RhdGUgPSAnaW4nOwogICAgICAgICAgaWYgKCFvcHRpb25zLmRlbGF5IHx8ICFvcHRpb25zLmRlbGF5LnNob3cpIHsKICAgICAgICAgICAgcmV0dXJuICR0b29sdGlwLnNob3coKTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGhvdmVyU3RhdGUgPT09J2luJykgJHRvb2x0aXAuc2hvdygpOwogICAgICAgICAgfSwgb3B0aW9ucy5kZWxheS5zaG93KTsKCiAgICAgICAgfTsKCiAgICAgICAgJHRvb2x0aXAuc2hvdyA9IGZ1bmN0aW9uKCkgewoKICAgICAgICAgIHNjb3BlLiRlbWl0KG9wdGlvbnMucHJlZml4RXZlbnQgKyAnLnNob3cuYmVmb3JlJywgJHRvb2x0aXApOwogICAgICAgICAgdmFyIHBhcmVudCA9IG9wdGlvbnMuY29udGFpbmVyID8gdGlwQ29udGFpbmVyIDogbnVsbDsKICAgICAgICAgIHZhciBhZnRlciA9IG9wdGlvbnMuY29udGFpbmVyID8gbnVsbCA6IGVsZW1lbnQ7CgogICAgICAgICAgLy8gSGlkZSBhbnkgZXhpc3RpbmcgdGlwRWxlbWVudAogICAgICAgICAgaWYodGlwRWxlbWVudCkgdGlwRWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgIC8vIEZldGNoIGEgY2xvbmVkIGVsZW1lbnQgbGlua2VkIGZyb20gdGVtcGxhdGUKICAgICAgICAgIHRpcEVsZW1lbnQgPSAkdG9vbHRpcC4kZWxlbWVudCA9IHRpcExpbmtlcihzY29wZSwgZnVuY3Rpb24oY2xvbmVkRWxlbWVudCwgc2NvcGUpIHt9KTsKCiAgICAgICAgICAvLyBTZXQgdGhlIGluaXRpYWwgcG9zaXRpb25pbmcuICBNYWtlIHRoZSB0b29sdGlwIGludmlzaWJsZQogICAgICAgICAgLy8gc28gSUUgZG9lc24ndCB0cnkgdG8gZm9jdXMgb24gaXQgb2ZmIHNjcmVlbi4KICAgICAgICAgIHRpcEVsZW1lbnQuY3NzKHt0b3A6ICctOTk5OXB4JywgbGVmdDogJy05OTk5cHgnLCBkaXNwbGF5OiAnYmxvY2snLCB2aXNpYmlsaXR5OiAnaGlkZGVuJ30pLmFkZENsYXNzKG9wdGlvbnMucGxhY2VtZW50KTsKCiAgICAgICAgICAvLyBPcHRpb25zOiBhbmltYXRpb24KICAgICAgICAgIGlmKG9wdGlvbnMuYW5pbWF0aW9uKSB0aXBFbGVtZW50LmFkZENsYXNzKG9wdGlvbnMuYW5pbWF0aW9uKTsKICAgICAgICAgIC8vIE9wdGlvbnM6IHR5cGUKICAgICAgICAgIGlmKG9wdGlvbnMudHlwZSkgdGlwRWxlbWVudC5hZGRDbGFzcyhvcHRpb25zLnByZWZpeENsYXNzICsgJy0nICsgb3B0aW9ucy50eXBlKTsKICAgICAgICAgIC8vIE9wdGlvbnM6IGN1c3RvbSBjbGFzc2VzCiAgICAgICAgICBpZihvcHRpb25zLmN1c3RvbUNsYXNzKSB0aXBFbGVtZW50LmFkZENsYXNzKG9wdGlvbnMuY3VzdG9tQ2xhc3MpOwoKICAgICAgICAgIC8vIFN1cHBvcnQgdjEuMysgJGFuaW1hdGUKICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvY29tbWl0L2JmMGY1NTAyYjFiYmZkZGM1Y2RkMmYxMzhlZmQ5MTg4YjhjNjUyYTkKICAgICAgICAgIHZhciBwcm9taXNlID0gJGFuaW1hdGUuZW50ZXIodGlwRWxlbWVudCwgcGFyZW50LCBhZnRlciwgZW50ZXJBbmltYXRlQ2FsbGJhY2spOwogICAgICAgICAgaWYocHJvbWlzZSAmJiBwcm9taXNlLnRoZW4pIHByb21pc2UudGhlbihlbnRlckFuaW1hdGVDYWxsYmFjayk7CgogICAgICAgICAgJHRvb2x0aXAuJGlzU2hvd24gPSBzY29wZS4kaXNTaG93biA9IHRydWU7CiAgICAgICAgICBzY29wZS4kJHBoYXNlIHx8IChzY29wZS4kcm9vdCAmJiBzY29wZS4kcm9vdC4kJHBoYXNlKSB8fCBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAkJHJBRihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICR0b29sdGlwLiRhcHBseVBsYWNlbWVudCgpOwoKICAgICAgICAgICAgLy8gT25jZSBwbGFjZWQsIG1ha2UgdGhlIHRvb2x0aXAgdmlzaWJsZQogICAgICAgICAgICB0aXBFbGVtZW50LmNzcyh7dmlzaWJpbGl0eTogJ3Zpc2libGUnfSk7CiAgICAgICAgICB9KTsgLy8gdmFyIGEgPSBib2R5RWwub2Zmc2V0V2lkdGggKyAxOyA/CgogICAgICAgICAgLy8gQmluZCBldmVudHMKICAgICAgICAgIGlmKG9wdGlvbnMua2V5Ym9hcmQpIHsKICAgICAgICAgICAgaWYob3B0aW9ucy50cmlnZ2VyICE9PSAnZm9jdXMnKSB7CiAgICAgICAgICAgICAgJHRvb2x0aXAuZm9jdXMoKTsKICAgICAgICAgICAgICB0aXBFbGVtZW50Lm9uKCdrZXl1cCcsICR0b29sdGlwLiRvbktleVVwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlbGVtZW50Lm9uKCdrZXl1cCcsICR0b29sdGlwLiRvbkZvY3VzS2V5VXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIGVudGVyQW5pbWF0ZUNhbGxiYWNrKCkgewogICAgICAgICAgc2NvcGUuJGVtaXQob3B0aW9ucy5wcmVmaXhFdmVudCArICcuc2hvdycsICR0b29sdGlwKTsKICAgICAgICB9CgogICAgICAgICR0b29sdGlwLmxlYXZlID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgICAgaG92ZXJTdGF0ZSA9ICdvdXQnOwogICAgICAgICAgaWYgKCFvcHRpb25zLmRlbGF5IHx8ICFvcHRpb25zLmRlbGF5LmhpZGUpIHsKICAgICAgICAgICAgcmV0dXJuICR0b29sdGlwLmhpZGUoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKGhvdmVyU3RhdGUgPT09ICdvdXQnKSB7CiAgICAgICAgICAgICAgJHRvb2x0aXAuaGlkZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCBvcHRpb25zLmRlbGF5LmhpZGUpOwoKICAgICAgICB9OwoKICAgICAgICAkdG9vbHRpcC5oaWRlID0gZnVuY3Rpb24oYmx1cikgewoKICAgICAgICAgIGlmKCEkdG9vbHRpcC4kaXNTaG93bikgcmV0dXJuOwogICAgICAgICAgc2NvcGUuJGVtaXQob3B0aW9ucy5wcmVmaXhFdmVudCArICcuaGlkZS5iZWZvcmUnLCAkdG9vbHRpcCk7CgogICAgICAgICAgLy8gU3VwcG9ydCB2MS4zKyAkYW5pbWF0ZQogICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9jb21taXQvYmYwZjU1MDJiMWJiZmRkYzVjZGQyZjEzOGVmZDkxODhiOGM2NTJhOQogICAgICAgICAgdmFyIHByb21pc2UgPSAkYW5pbWF0ZS5sZWF2ZSh0aXBFbGVtZW50LCBsZWF2ZUFuaW1hdGVDYWxsYmFjayk7CiAgICAgICAgICBpZihwcm9taXNlICYmIHByb21pc2UudGhlbikgcHJvbWlzZS50aGVuKGxlYXZlQW5pbWF0ZUNhbGxiYWNrKTsKCiAgICAgICAgICAkdG9vbHRpcC4kaXNTaG93biA9IHNjb3BlLiRpc1Nob3duID0gZmFsc2U7CiAgICAgICAgICBzY29wZS4kJHBoYXNlIHx8IChzY29wZS4kcm9vdCAmJiBzY29wZS4kcm9vdC4kJHBoYXNlKSB8fCBzY29wZS4kZGlnZXN0KCk7CgogICAgICAgICAgLy8gVW5iaW5kIGV2ZW50cwogICAgICAgICAgaWYob3B0aW9ucy5rZXlib2FyZCAmJiB0aXBFbGVtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRpcEVsZW1lbnQub2ZmKCdrZXl1cCcsICR0b29sdGlwLiRvbktleVVwKTsKICAgICAgICAgIH0KCiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gbGVhdmVBbmltYXRlQ2FsbGJhY2soKSB7CiAgICAgICAgICBzY29wZS4kZW1pdChvcHRpb25zLnByZWZpeEV2ZW50ICsgJy5oaWRlJywgJHRvb2x0aXApOwogICAgICAgICAgLy8gQWxsb3cgdG8gYmx1ciB0aGUgaW5wdXQgd2hlbiBoaWRkZW4sIGxpa2Ugd2hlbiBwcmVzc2luZyBlbnRlciBrZXkKICAgICAgICAgIGlmKGJsdXIgJiYgb3B0aW9ucy50cmlnZ2VyID09PSAnZm9jdXMnKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50WzBdLmJsdXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgICR0b29sdGlwLnRvZ2dsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgJHRvb2x0aXAuJGlzU2hvd24gPyAkdG9vbHRpcC5sZWF2ZSgpIDogJHRvb2x0aXAuZW50ZXIoKTsKICAgICAgICB9OwoKICAgICAgICAkdG9vbHRpcC5mb2N1cyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGlwRWxlbWVudFswXS5mb2N1cygpOwogICAgICAgIH07CgogICAgICAgIC8vIFByb3RlY3RlZCBtZXRob2RzCgogICAgICAgICR0b29sdGlwLiRhcHBseVBsYWNlbWVudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYoIXRpcEVsZW1lbnQpIHJldHVybjsKCiAgICAgICAgICAvLyBHZXQgdGhlIHBvc2l0aW9uIG9mIHRoZSB0b29sdGlwIGVsZW1lbnQuCiAgICAgICAgICB2YXIgZWxlbWVudFBvc2l0aW9uID0gZ2V0UG9zaXRpb24oKTsKCiAgICAgICAgICAvLyBHZXQgdGhlIGhlaWdodCBhbmQgd2lkdGggb2YgdGhlIHRvb2x0aXAgc28gd2UgY2FuIGNlbnRlciBpdC4KICAgICAgICAgIHZhciB0aXBXaWR0aCA9IHRpcEVsZW1lbnQucHJvcCgnb2Zmc2V0V2lkdGgnKSwKICAgICAgICAgICAgICB0aXBIZWlnaHQgPSB0aXBFbGVtZW50LnByb3AoJ29mZnNldEhlaWdodCcpOwoKICAgICAgICAgIC8vIEdldCB0aGUgdG9vbHRpcCdzIHRvcCBhbmQgbGVmdCBjb29yZGluYXRlcyB0byBjZW50ZXIgaXQgd2l0aCB0aGlzIGRpcmVjdGl2ZS4KICAgICAgICAgIHZhciB0aXBQb3NpdGlvbiA9IGdldENhbGN1bGF0ZWRPZmZzZXQob3B0aW9ucy5wbGFjZW1lbnQsIGVsZW1lbnRQb3NpdGlvbiwgdGlwV2lkdGgsIHRpcEhlaWdodCk7CgogICAgICAgICAgLy8gTm93IHNldCB0aGUgY2FsY3VsYXRlZCBwb3NpdGlvbmluZy4KICAgICAgICAgIHRpcFBvc2l0aW9uLnRvcCArPSAncHgnOwogICAgICAgICAgdGlwUG9zaXRpb24ubGVmdCArPSAncHgnOwogICAgICAgICAgdGlwRWxlbWVudC5jc3ModGlwUG9zaXRpb24pOwoKICAgICAgICB9OwoKICAgICAgICAkdG9vbHRpcC4kb25LZXlVcCA9IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgaWYgKGV2dC53aGljaCA9PT0gMjcgJiYgJHRvb2x0aXAuJGlzU2hvd24pIHsKICAgICAgICAgICAgJHRvb2x0aXAuaGlkZSgpOwogICAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgJHRvb2x0aXAuJG9uRm9jdXNLZXlVcCA9IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgaWYgKGV2dC53aGljaCA9PT0gMjcpIHsKICAgICAgICAgICAgZWxlbWVudFswXS5ibHVyKCk7CiAgICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAkdG9vbHRpcC4kb25Gb2N1c0VsZW1lbnRNb3VzZURvd24gPSBmdW5jdGlvbihldnQpIHsKICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgLy8gU29tZSBicm93c2VycyBkbyBub3QgYXV0by1mb2N1cyBidXR0b25zIChlZy4gU2FmYXJpKQogICAgICAgICAgJHRvb2x0aXAuJGlzU2hvd24gPyBlbGVtZW50WzBdLmJsdXIoKSA6IGVsZW1lbnRbMF0uZm9jdXMoKTsKICAgICAgICB9OwoKICAgICAgICAvLyBQcml2YXRlIG1ldGhvZHMKCiAgICAgICAgZnVuY3Rpb24gZ2V0UG9zaXRpb24oKSB7CiAgICAgICAgICBpZihvcHRpb25zLmNvbnRhaW5lciA9PT0gJ2JvZHknKSB7CiAgICAgICAgICAgIHJldHVybiBkaW1lbnNpb25zLm9mZnNldChvcHRpb25zLnRhcmdldFswXSB8fCBlbGVtZW50WzBdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBkaW1lbnNpb25zLnBvc2l0aW9uKG9wdGlvbnMudGFyZ2V0WzBdIHx8IGVsZW1lbnRbMF0pOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0Q2FsY3VsYXRlZE9mZnNldChwbGFjZW1lbnQsIHBvc2l0aW9uLCBhY3R1YWxXaWR0aCwgYWN0dWFsSGVpZ2h0KSB7CiAgICAgICAgICB2YXIgb2Zmc2V0OwogICAgICAgICAgdmFyIHNwbGl0ID0gcGxhY2VtZW50LnNwbGl0KCctJyk7CgogICAgICAgICAgc3dpdGNoIChzcGxpdFswXSkgewogICAgICAgICAgY2FzZSAncmlnaHQnOgogICAgICAgICAgICBvZmZzZXQgPSB7CiAgICAgICAgICAgICAgdG9wOiBwb3NpdGlvbi50b3AgKyBwb3NpdGlvbi5oZWlnaHQgLyAyIC0gYWN0dWFsSGVpZ2h0IC8gMiwKICAgICAgICAgICAgICBsZWZ0OiBwb3NpdGlvbi5sZWZ0ICsgcG9zaXRpb24ud2lkdGgKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdib3R0b20nOgogICAgICAgICAgICBvZmZzZXQgPSB7CiAgICAgICAgICAgICAgdG9wOiBwb3NpdGlvbi50b3AgKyBwb3NpdGlvbi5oZWlnaHQsCiAgICAgICAgICAgICAgbGVmdDogcG9zaXRpb24ubGVmdCArIHBvc2l0aW9uLndpZHRoIC8gMiAtIGFjdHVhbFdpZHRoIC8gMgogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ2xlZnQnOgogICAgICAgICAgICBvZmZzZXQgPSB7CiAgICAgICAgICAgICAgdG9wOiBwb3NpdGlvbi50b3AgKyBwb3NpdGlvbi5oZWlnaHQgLyAyIC0gYWN0dWFsSGVpZ2h0IC8gMiwKICAgICAgICAgICAgICBsZWZ0OiBwb3NpdGlvbi5sZWZ0IC0gYWN0dWFsV2lkdGgKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBvZmZzZXQgPSB7CiAgICAgICAgICAgICAgdG9wOiBwb3NpdGlvbi50b3AgLSBhY3R1YWxIZWlnaHQsCiAgICAgICAgICAgICAgbGVmdDogcG9zaXRpb24ubGVmdCArIHBvc2l0aW9uLndpZHRoIC8gMiAtIGFjdHVhbFdpZHRoIC8gMgogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KCiAgICAgICAgICBpZighc3BsaXRbMV0pIHsKICAgICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBBZGQgc3VwcG9ydCBmb3IgY29ybmVycyBAdG9kbyBjc3MKICAgICAgICAgIGlmKHNwbGl0WzBdID09PSAndG9wJyB8fCBzcGxpdFswXSA9PT0gJ2JvdHRvbScpIHsKICAgICAgICAgICAgc3dpdGNoIChzcGxpdFsxXSkgewogICAgICAgICAgICBjYXNlICdsZWZ0JzoKICAgICAgICAgICAgICBvZmZzZXQubGVmdCA9IHBvc2l0aW9uLmxlZnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3JpZ2h0JzoKICAgICAgICAgICAgICBvZmZzZXQubGVmdCA9ICBwb3NpdGlvbi5sZWZ0ICsgcG9zaXRpb24ud2lkdGggLSBhY3R1YWxXaWR0aDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmKHNwbGl0WzBdID09PSAnbGVmdCcgfHwgc3BsaXRbMF0gPT09ICdyaWdodCcpIHsKICAgICAgICAgICAgc3dpdGNoIChzcGxpdFsxXSkgewogICAgICAgICAgICBjYXNlICd0b3AnOgogICAgICAgICAgICAgIG9mZnNldC50b3AgPSBwb3NpdGlvbi50b3AgLSBhY3R1YWxIZWlnaHQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2JvdHRvbSc6CiAgICAgICAgICAgICAgb2Zmc2V0LnRvcCA9IHBvc2l0aW9uLnRvcCArIHBvc2l0aW9uLmhlaWdodDsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJHRvb2x0aXA7CgogICAgICB9CgogICAgICAvLyBIZWxwZXIgZnVuY3Rpb25zCgogICAgICBmdW5jdGlvbiBmaW5kRWxlbWVudChxdWVyeSwgZWxlbWVudCkgewogICAgICAgIHJldHVybiBhbmd1bGFyLmVsZW1lbnQoKGVsZW1lbnQgfHwgZG9jdW1lbnQpLnF1ZXJ5U2VsZWN0b3JBbGwocXVlcnkpKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZmV0Y2hUZW1wbGF0ZSh0ZW1wbGF0ZSkgewogICAgICAgIHJldHVybiAkcS53aGVuKCR0ZW1wbGF0ZUNhY2hlLmdldCh0ZW1wbGF0ZSkgfHwgJGh0dHAuZ2V0KHRlbXBsYXRlKSkKICAgICAgICAudGhlbihmdW5jdGlvbihyZXMpIHsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNPYmplY3QocmVzKSkgewogICAgICAgICAgICAkdGVtcGxhdGVDYWNoZS5wdXQodGVtcGxhdGUsIHJlcy5kYXRhKTsKICAgICAgICAgICAgcmV0dXJuIHJlcy5kYXRhOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcmV0dXJuIFRvb2x0aXBGYWN0b3J5OwoKICAgIH1dOwoKICB9KQoKICAuZGlyZWN0aXZlKCdic1Rvb2x0aXAnLCBbIiR3aW5kb3ciLCAiJGxvY2F0aW9uIiwgIiRzY2UiLCAiJHRvb2x0aXAiLCAiJCRyQUYiLCBmdW5jdGlvbigkd2luZG93LCAkbG9jYXRpb24sICRzY2UsICR0b29sdGlwLCAkJHJBRikgewoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRUFDJywKICAgICAgc2NvcGU6IHRydWUsCiAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRyLCB0cmFuc2NsdXNpb24pIHsKCiAgICAgICAgLy8gRGlyZWN0aXZlIG9wdGlvbnMKICAgICAgICB2YXIgb3B0aW9ucyA9IHtzY29wZTogc2NvcGV9OwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ3RlbXBsYXRlJywgJ2NvbnRlbnRUZW1wbGF0ZScsICdwbGFjZW1lbnQnLCAnY29udGFpbmVyJywgJ3RhcmdldCcsICdkZWxheScsICd0cmlnZ2VyJywgJ2tleWJvYXJkJywgJ2h0bWwnLCAnYW5pbWF0aW9uJywgJ3R5cGUnLCAnY3VzdG9tQ2xhc3MnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzRGVmaW5lZChhdHRyW2tleV0pKSBvcHRpb25zW2tleV0gPSBhdHRyW2tleV07CiAgICAgICAgfSk7CgogICAgICAgIC8vIE9ic2VydmUgc2NvcGUgYXR0cmlidXRlcyBmb3IgY2hhbmdlCiAgICAgICAgYXR0ci4kb2JzZXJ2ZSgndGl0bGUnLCBmdW5jdGlvbihuZXdWYWx1ZSkgewogICAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKG5ld1ZhbHVlKSB8fCAhc2NvcGUuaGFzT3duUHJvcGVydHkoJ3RpdGxlJykpIHsKICAgICAgICAgICAgdmFyIG9sZFZhbHVlID0gc2NvcGUudGl0bGU7CiAgICAgICAgICAgIHNjb3BlLnRpdGxlID0gJHNjZS50cnVzdEFzSHRtbChuZXdWYWx1ZSk7CiAgICAgICAgICAgIGFuZ3VsYXIuaXNEZWZpbmVkKG9sZFZhbHVlKSAmJiAkJHJBRihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0b29sdGlwICYmIHRvb2x0aXAuJGFwcGx5UGxhY2VtZW50KCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyBTdXBwb3J0IHNjb3BlIGFzIGFuIG9iamVjdAogICAgICAgIGF0dHIuYnNUb29sdGlwICYmIHNjb3BlLiR3YXRjaChhdHRyLmJzVG9vbHRpcCwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzT2JqZWN0KG5ld1ZhbHVlKSkgewogICAgICAgICAgICBhbmd1bGFyLmV4dGVuZChzY29wZSwgbmV3VmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2NvcGUudGl0bGUgPSBuZXdWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGFuZ3VsYXIuaXNEZWZpbmVkKG9sZFZhbHVlKSAmJiAkJHJBRihmdW5jdGlvbigpIHsKICAgICAgICAgICAgdG9vbHRpcCAmJiB0b29sdGlwLiRhcHBseVBsYWNlbWVudCgpOwogICAgICAgICAgfSk7CiAgICAgICAgfSwgdHJ1ZSk7CgogICAgICAgIC8vIFZpc2liaWxpdHkgYmluZGluZyBzdXBwb3J0CiAgICAgICAgYXR0ci5ic1Nob3cgJiYgc2NvcGUuJHdhdGNoKGF0dHIuYnNTaG93LCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgIGlmKCF0b29sdGlwIHx8ICFhbmd1bGFyLmlzRGVmaW5lZChuZXdWYWx1ZSkpIHJldHVybjsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNTdHJpbmcobmV3VmFsdWUpKSBuZXdWYWx1ZSA9ICEhbmV3VmFsdWUubWF0Y2goL3RydWV8LD8odG9vbHRpcCksPy9pKTsKICAgICAgICAgIG5ld1ZhbHVlID09PSB0cnVlID8gdG9vbHRpcC5zaG93KCkgOiB0b29sdGlwLmhpZGUoKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSBwb3BvdmVyCiAgICAgICAgdmFyIHRvb2x0aXAgPSAkdG9vbHRpcChlbGVtZW50LCBvcHRpb25zKTsKCiAgICAgICAgLy8gR2FyYmFnZSBjb2xsZWN0aW9uCiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYodG9vbHRpcCkgdG9vbHRpcC5kZXN0cm95KCk7CiAgICAgICAgICBvcHRpb25zID0gbnVsbDsKICAgICAgICAgIHRvb2x0aXAgPSBudWxsOwogICAgICAgIH0pOwoKICAgICAgfQogICAgfTsKCiAgfV0pOwoKLy8gU291cmNlOiB0eXBlYWhlYWQuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLnR5cGVhaGVhZCcsIFsnbWdjcmVhLm5nU3RyYXAudG9vbHRpcCcsICdtZ2NyZWEubmdTdHJhcC5oZWxwZXJzLnBhcnNlT3B0aW9ucyddKQoKICAucHJvdmlkZXIoJyR0eXBlYWhlYWQnLCBmdW5jdGlvbigpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICBhbmltYXRpb246ICdhbS1mYWRlJywKICAgICAgcHJlZml4Q2xhc3M6ICd0eXBlYWhlYWQnLAogICAgICBwcmVmaXhFdmVudDogJyR0eXBlYWhlYWQnLAogICAgICBwbGFjZW1lbnQ6ICdib3R0b20tbGVmdCcsCiAgICAgIHRlbXBsYXRlOiAndHlwZWFoZWFkL3R5cGVhaGVhZC50cGwuaHRtbCcsCiAgICAgIHRyaWdnZXI6ICdmb2N1cycsCiAgICAgIGNvbnRhaW5lcjogZmFsc2UsCiAgICAgIGtleWJvYXJkOiB0cnVlLAogICAgICBodG1sOiBmYWxzZSwKICAgICAgZGVsYXk6IDAsCiAgICAgIG1pbkxlbmd0aDogMSwKICAgICAgZmlsdGVyOiAnZmlsdGVyJywKICAgICAgbGltaXQ6IDYKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gWyIkd2luZG93IiwgIiRyb290U2NvcGUiLCAiJHRvb2x0aXAiLCBmdW5jdGlvbigkd2luZG93LCAkcm9vdFNjb3BlLCAkdG9vbHRpcCkgewoKICAgICAgdmFyIGJvZHlFbCA9IGFuZ3VsYXIuZWxlbWVudCgkd2luZG93LmRvY3VtZW50LmJvZHkpOwoKICAgICAgZnVuY3Rpb24gVHlwZWFoZWFkRmFjdG9yeShlbGVtZW50LCBjb250cm9sbGVyLCBjb25maWcpIHsKCiAgICAgICAgdmFyICR0eXBlYWhlYWQgPSB7fTsKCiAgICAgICAgLy8gQ29tbW9uIHZhcnMKICAgICAgICB2YXIgb3B0aW9ucyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBkZWZhdWx0cywgY29uZmlnKTsKCiAgICAgICAgJHR5cGVhaGVhZCA9ICR0b29sdGlwKGVsZW1lbnQsIG9wdGlvbnMpOwogICAgICAgIHZhciBwYXJlbnRTY29wZSA9IGNvbmZpZy5zY29wZTsKICAgICAgICB2YXIgc2NvcGUgPSAkdHlwZWFoZWFkLiRzY29wZTsKCiAgICAgICAgc2NvcGUuJHJlc2V0TWF0Y2hlcyA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICBzY29wZS4kbWF0Y2hlcyA9IFtdOwogICAgICAgICAgc2NvcGUuJGFjdGl2ZUluZGV4ID0gMDsKICAgICAgICB9OwogICAgICAgIHNjb3BlLiRyZXNldE1hdGNoZXMoKTsKCiAgICAgICAgc2NvcGUuJGFjdGl2YXRlID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgIHNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHR5cGVhaGVhZC5hY3RpdmF0ZShpbmRleCk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBzY29wZS4kc2VsZWN0ID0gZnVuY3Rpb24oaW5kZXgsIGV2dCkgewogICAgICAgICAgc2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkdHlwZWFoZWFkLnNlbGVjdChpbmRleCk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBzY29wZS4kaXNWaXNpYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gJHR5cGVhaGVhZC4kaXNWaXNpYmxlKCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gUHVibGljIG1ldGhvZHMKCiAgICAgICAgJHR5cGVhaGVhZC51cGRhdGUgPSBmdW5jdGlvbihtYXRjaGVzKSB7CiAgICAgICAgICBzY29wZS4kbWF0Y2hlcyA9IG1hdGNoZXM7CiAgICAgICAgICBpZihzY29wZS4kYWN0aXZlSW5kZXggPj0gbWF0Y2hlcy5sZW5ndGgpIHsKICAgICAgICAgICAgc2NvcGUuJGFjdGl2ZUluZGV4ID0gMDsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAkdHlwZWFoZWFkLmFjdGl2YXRlID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgIHNjb3BlLiRhY3RpdmVJbmRleCA9IGluZGV4OwogICAgICAgIH07CgogICAgICAgICR0eXBlYWhlYWQuc2VsZWN0ID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHNjb3BlLiRtYXRjaGVzW2luZGV4XS52YWx1ZTsKICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCckc2V0Vmlld1ZhbHVlJywgdmFsdWUpOwogICAgICAgICAgY29udHJvbGxlci4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgIGNvbnRyb2xsZXIuJHJlbmRlcigpOwogICAgICAgICAgc2NvcGUuJHJlc2V0TWF0Y2hlcygpOwogICAgICAgICAgaWYocGFyZW50U2NvcGUpIHBhcmVudFNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgIC8vIEVtaXQgZXZlbnQKICAgICAgICAgIHNjb3BlLiRlbWl0KG9wdGlvbnMucHJlZml4RXZlbnQgKyAnLnNlbGVjdCcsIHZhbHVlLCBpbmRleCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gUHJvdGVjdGVkIG1ldGhvZHMKCiAgICAgICAgJHR5cGVhaGVhZC4kaXNWaXNpYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZighb3B0aW9ucy5taW5MZW5ndGggfHwgIWNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgcmV0dXJuICEhc2NvcGUuJG1hdGNoZXMubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgLy8gbWluTGVuZ3RoIHN1cHBvcnQKICAgICAgICAgIHJldHVybiBzY29wZS4kbWF0Y2hlcy5sZW5ndGggJiYgYW5ndWxhci5pc1N0cmluZyhjb250cm9sbGVyLiR2aWV3VmFsdWUpICYmIGNvbnRyb2xsZXIuJHZpZXdWYWx1ZS5sZW5ndGggPj0gb3B0aW9ucy5taW5MZW5ndGg7CiAgICAgICAgfTsKCiAgICAgICAgJHR5cGVhaGVhZC4kZ2V0SW5kZXggPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgdmFyIGwgPSBzY29wZS4kbWF0Y2hlcy5sZW5ndGgsIGkgPSBsOwogICAgICAgICAgaWYoIWwpIHJldHVybjsKICAgICAgICAgIGZvcihpID0gbDsgaS0tOykgewogICAgICAgICAgICBpZihzY29wZS4kbWF0Y2hlc1tpXS52YWx1ZSA9PT0gdmFsdWUpIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgaWYoaSA8IDApIHJldHVybjsKICAgICAgICAgIHJldHVybiBpOwogICAgICAgIH07CgogICAgICAgICR0eXBlYWhlYWQuJG9uTW91c2VEb3duID0gZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICAvLyBQcmV2ZW50IGJsdXIgb24gbW91c2Vkb3duCiAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICB9OwoKICAgICAgICAkdHlwZWFoZWFkLiRvbktleURvd24gPSBmdW5jdGlvbihldnQpIHsKICAgICAgICAgIGlmKCEvKDM4fDQwfDEzKS8udGVzdChldnQua2V5Q29kZSkpIHJldHVybjsKCiAgICAgICAgICAvLyBMZXQgbmdTdWJtaXQgcGFzcyBpZiB0aGUgdHlwZWFoZWFkIHRpcCBpcyBoaWRkZW4KICAgICAgICAgIGlmKCR0eXBlYWhlYWQuJGlzVmlzaWJsZSgpKSB7CiAgICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU2VsZWN0IHdpdGggZW50ZXIKICAgICAgICAgIGlmKGV2dC5rZXlDb2RlID09PSAxMyAmJiBzY29wZS4kbWF0Y2hlcy5sZW5ndGgpIHsKICAgICAgICAgICAgJHR5cGVhaGVhZC5zZWxlY3Qoc2NvcGUuJGFjdGl2ZUluZGV4KTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBOYXZpZ2F0ZSB3aXRoIGtleWJvYXJkCiAgICAgICAgICBlbHNlIGlmKGV2dC5rZXlDb2RlID09PSAzOCAmJiBzY29wZS4kYWN0aXZlSW5kZXggPiAwKSBzY29wZS4kYWN0aXZlSW5kZXgtLTsKICAgICAgICAgIGVsc2UgaWYoZXZ0LmtleUNvZGUgPT09IDQwICYmIHNjb3BlLiRhY3RpdmVJbmRleCA8IHNjb3BlLiRtYXRjaGVzLmxlbmd0aCAtIDEpIHNjb3BlLiRhY3RpdmVJbmRleCsrOwogICAgICAgICAgZWxzZSBpZihhbmd1bGFyLmlzVW5kZWZpbmVkKHNjb3BlLiRhY3RpdmVJbmRleCkpIHNjb3BlLiRhY3RpdmVJbmRleCA9IDA7CiAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gT3ZlcnJpZGVzCgogICAgICAgIHZhciBzaG93ID0gJHR5cGVhaGVhZC5zaG93OwogICAgICAgICR0eXBlYWhlYWQuc2hvdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hvdygpOwogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHR5cGVhaGVhZC4kZWxlbWVudC5vbignbW91c2Vkb3duJywgJHR5cGVhaGVhZC4kb25Nb3VzZURvd24pOwogICAgICAgICAgICBpZihvcHRpb25zLmtleWJvYXJkKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5vbigna2V5ZG93bicsICR0eXBlYWhlYWQuJG9uS2V5RG93bik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHZhciBoaWRlID0gJHR5cGVhaGVhZC5oaWRlOwogICAgICAgICR0eXBlYWhlYWQuaGlkZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgJHR5cGVhaGVhZC4kZWxlbWVudC5vZmYoJ21vdXNlZG93bicsICR0eXBlYWhlYWQuJG9uTW91c2VEb3duKTsKICAgICAgICAgIGlmKG9wdGlvbnMua2V5Ym9hcmQpIHsKICAgICAgICAgICAgZWxlbWVudC5vZmYoJ2tleWRvd24nLCAkdHlwZWFoZWFkLiRvbktleURvd24pOwogICAgICAgICAgfQogICAgICAgICAgaGlkZSgpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiAkdHlwZWFoZWFkOwoKICAgICAgfQoKICAgICAgVHlwZWFoZWFkRmFjdG9yeS5kZWZhdWx0cyA9IGRlZmF1bHRzOwogICAgICByZXR1cm4gVHlwZWFoZWFkRmFjdG9yeTsKCiAgICB9XTsKCiAgfSkKCiAgLmRpcmVjdGl2ZSgnYnNUeXBlYWhlYWQnLCBbIiR3aW5kb3ciLCAiJHBhcnNlIiwgIiRxIiwgIiR0eXBlYWhlYWQiLCAiJHBhcnNlT3B0aW9ucyIsIGZ1bmN0aW9uKCR3aW5kb3csICRwYXJzZSwgJHEsICR0eXBlYWhlYWQsICRwYXJzZU9wdGlvbnMpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSAkdHlwZWFoZWFkLmRlZmF1bHRzOwoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRUFDJywKICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgICBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgZWxlbWVudCwgYXR0ciwgY29udHJvbGxlcikgewoKICAgICAgICAvLyBEaXJlY3RpdmUgb3B0aW9ucwogICAgICAgIHZhciBvcHRpb25zID0ge3Njb3BlOiBzY29wZX07CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsncGxhY2VtZW50JywgJ2NvbnRhaW5lcicsICdkZWxheScsICd0cmlnZ2VyJywgJ2tleWJvYXJkJywgJ2h0bWwnLCAnYW5pbWF0aW9uJywgJ3RlbXBsYXRlJywgJ2ZpbHRlcicsICdsaW1pdCcsICdtaW5MZW5ndGgnLCAnd2F0Y2hPcHRpb25zJywgJ3NlbGVjdE1vZGUnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzRGVmaW5lZChhdHRyW2tleV0pKSBvcHRpb25zW2tleV0gPSBhdHRyW2tleV07CiAgICAgICAgfSk7CgogICAgICAgIC8vIEJ1aWxkIHByb3BlciBuZ09wdGlvbnMKICAgICAgICB2YXIgZmlsdGVyID0gb3B0aW9ucy5maWx0ZXIgfHwgZGVmYXVsdHMuZmlsdGVyOwogICAgICAgIHZhciBsaW1pdCA9IG9wdGlvbnMubGltaXQgfHwgZGVmYXVsdHMubGltaXQ7CiAgICAgICAgdmFyIG5nT3B0aW9ucyA9IGF0dHIubmdPcHRpb25zOwogICAgICAgIGlmKGZpbHRlcikgbmdPcHRpb25zICs9ICcgfCAnICsgZmlsdGVyICsgJzokdmlld1ZhbHVlJzsKICAgICAgICBpZihsaW1pdCkgbmdPcHRpb25zICs9ICcgfCBsaW1pdFRvOicgKyBsaW1pdDsKICAgICAgICB2YXIgcGFyc2VkT3B0aW9ucyA9ICRwYXJzZU9wdGlvbnMobmdPcHRpb25zKTsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSB0eXBlYWhlYWQKICAgICAgICB2YXIgdHlwZWFoZWFkID0gJHR5cGVhaGVhZChlbGVtZW50LCBjb250cm9sbGVyLCBvcHRpb25zKTsKCiAgICAgICAgLy8gV2F0Y2ggb3B0aW9ucyBvbiBkZW1hbmQKICAgICAgICBpZihvcHRpb25zLndhdGNoT3B0aW9ucykgewogICAgICAgICAgLy8gV2F0Y2ggbmdPcHRpb25zIHZhbHVlcyBiZWZvcmUgZmlsdGVyaW5nIGZvciBjaGFuZ2VzLCBkcm9wIGZ1bmN0aW9uIGNhbGxzCiAgICAgICAgICB2YXIgd2F0Y2hlZE9wdGlvbnMgPSBwYXJzZWRPcHRpb25zLiRtYXRjaFs3XS5yZXBsYWNlKC9cfC4rLywgJycpLnJlcGxhY2UoL1woLipcKS9nLCAnJykudHJpbSgpOwogICAgICAgICAgc2NvcGUuJHdhdGNoKHdhdGNoZWRPcHRpb25zLCBmdW5jdGlvbiAobmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgIC8vIGNvbnNvbGUud2Fybignc2NvcGUuJHdhdGNoKCVzKScsIHdhdGNoZWRPcHRpb25zLCBuZXdWYWx1ZSwgb2xkVmFsdWUpOwogICAgICAgICAgICBwYXJzZWRPcHRpb25zLnZhbHVlc0ZuKHNjb3BlLCBjb250cm9sbGVyKS50aGVuKGZ1bmN0aW9uICh2YWx1ZXMpIHsKICAgICAgICAgICAgICB0eXBlYWhlYWQudXBkYXRlKHZhbHVlcyk7CiAgICAgICAgICAgICAgY29udHJvbGxlci4kcmVuZGVyKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBXYXRjaCBtb2RlbCBmb3IgY2hhbmdlcwogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nTW9kZWwsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCckd2F0Y2gnLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksIG5ld1ZhbHVlKTsKICAgICAgICAgIHNjb3BlLiRtb2RlbFZhbHVlID0gbmV3VmFsdWU7IC8vIFB1Ymxpc2ggbW9kZWxWYWx1ZSBvbiBzY29wZSBmb3IgY3VzdG9tIHRlbXBsYXRlcwogICAgICAgICAgcGFyc2VkT3B0aW9ucy52YWx1ZXNGbihzY29wZSwgY29udHJvbGxlcikKICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHZhbHVlcykgewogICAgICAgICAgICAvLyBQcmV2ZW50IGlucHV0IHdpdGggbm8gZnV0dXJlIHByb3NwZWN0IGlmIHNlbGVjdE1vZGUgaXMgdHJ1dGh5CiAgICAgICAgICAgIC8vIEBUT0RPIHRlc3Qgc2VsZWN0TW9kZQogICAgICAgICAgICBpZihvcHRpb25zLnNlbGVjdE1vZGUgJiYgIXZhbHVlcy5sZW5ndGggJiYgbmV3VmFsdWUubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZpZXdWYWx1ZShjb250cm9sbGVyLiR2aWV3VmFsdWUuc3Vic3RyaW5nKDAsIGNvbnRyb2xsZXIuJHZpZXdWYWx1ZS5sZW5ndGggLSAxKSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHZhbHVlcy5sZW5ndGggPiBsaW1pdCkgdmFsdWVzID0gdmFsdWVzLnNsaWNlKDAsIGxpbWl0KTsKICAgICAgICAgICAgdmFyIGlzVmlzaWJsZSA9IHR5cGVhaGVhZC4kaXNWaXNpYmxlKCk7CiAgICAgICAgICAgIGlzVmlzaWJsZSAmJiB0eXBlYWhlYWQudXBkYXRlKHZhbHVlcyk7CiAgICAgICAgICAgIC8vIERvIG5vdCByZS1xdWV1ZSBhbiB1cGRhdGUgaWYgYSBjb3JyZWN0IHZhbHVlIGhhcyBiZWVuIHNlbGVjdGVkCiAgICAgICAgICAgIGlmKHZhbHVlcy5sZW5ndGggPT09IDEgJiYgdmFsdWVzWzBdLnZhbHVlID09PSBuZXdWYWx1ZSkgcmV0dXJuOwogICAgICAgICAgICAhaXNWaXNpYmxlICYmIHR5cGVhaGVhZC51cGRhdGUodmFsdWVzKTsKICAgICAgICAgICAgLy8gUXVldWUgYSBuZXcgcmVuZGVyaW5nIHRoYXQgd2lsbCBsZXZlcmFnZSBjb2xsZWN0aW9uIGxvYWRpbmcKICAgICAgICAgICAgY29udHJvbGxlci4kcmVuZGVyKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gbW9kZWxWYWx1ZSAtPiAkZm9ybWF0dGVycyAtPiB2aWV3VmFsdWUKICAgICAgICBjb250cm9sbGVyLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24obW9kZWxWYWx1ZSkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCckZm9ybWF0dGVyKCIlcyIpOiBtb2RlbFZhbHVlPSVvICglbyknLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksIG1vZGVsVmFsdWUsIHR5cGVvZiBtb2RlbFZhbHVlKTsKICAgICAgICAgIHJldHVybiBwYXJzZWRPcHRpb25zLmRpc3BsYXlWYWx1ZShtb2RlbFZhbHVlKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gTW9kZWwgcmVuZGVyaW5nIGluIHZpZXcKICAgICAgICBjb250cm9sbGVyLiRyZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRyZW5kZXInLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksICdjb250cm9sbGVyLiRtb2RlbFZhbHVlJywgdHlwZW9mIGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUsIGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUsICdjb250cm9sbGVyLiR2aWV3VmFsdWUnLCB0eXBlb2YgY29udHJvbGxlci4kdmlld1ZhbHVlLCBjb250cm9sbGVyLiR2aWV3VmFsdWUpOwogICAgICAgICAgaWYoY29udHJvbGxlci4kaXNFbXB0eShjb250cm9sbGVyLiR2aWV3VmFsdWUpKSByZXR1cm4gZWxlbWVudC52YWwoJycpOwogICAgICAgICAgdmFyIGluZGV4ID0gdHlwZWFoZWFkLiRnZXRJbmRleChjb250cm9sbGVyLiRtb2RlbFZhbHVlKTsKICAgICAgICAgIHZhciBzZWxlY3RlZCA9IGFuZ3VsYXIuaXNEZWZpbmVkKGluZGV4KSA/IHR5cGVhaGVhZC4kc2NvcGUuJG1hdGNoZXNbaW5kZXhdLmxhYmVsIDogY29udHJvbGxlci4kdmlld1ZhbHVlOwogICAgICAgICAgc2VsZWN0ZWQgPSBhbmd1bGFyLmlzT2JqZWN0KHNlbGVjdGVkKSA/IHNlbGVjdGVkLmxhYmVsIDogc2VsZWN0ZWQ7CiAgICAgICAgICBlbGVtZW50LnZhbChzZWxlY3RlZCA/IHNlbGVjdGVkLnJlcGxhY2UoLzwoPzoufFxuKSo/Pi9nbSwgJycpLnRyaW0oKSA6ICcnKTsKICAgICAgICB9OwoKICAgICAgICAvLyBHYXJiYWdlIGNvbGxlY3Rpb24KICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAodHlwZWFoZWFkKSB0eXBlYWhlYWQuZGVzdHJveSgpOwogICAgICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICAgICAgICB0eXBlYWhlYWQgPSBudWxsOwogICAgICAgIH0pOwoKICAgICAgfQogICAgfTsKCiAgfV0pOwoKfSkod2luZG93LCBkb2N1bWVudCk7CgovKioKICogYW5ndWxhci1zdHJhcAogKiBAdmVyc2lvbiB2Mi4xLjIgLSAyMDE0LTEwLTE5CiAqIEBsaW5rIGh0dHA6Ly9tZ2NyZWEuZ2l0aHViLmlvL2FuZ3VsYXItc3RyYXAKICogQGF1dGhvciBPbGl2aWVyIExvdXZpZ25lcyAob2xpdmllckBtZy1jcmVhLmNvbSkKICogQGxpY2Vuc2UgTUlUIExpY2Vuc2UsIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUCiAqLwooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkKSB7Cid1c2Ugc3RyaWN0JzsKCi8vIFNvdXJjZTogYWxlcnQudHBsLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5hbGVydCcpLnJ1bihbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKCiAgJHRlbXBsYXRlQ2FjaGUucHV0KCdhbGVydC9hbGVydC50cGwuaHRtbCcsICc8ZGl2IGNsYXNzPSJhbGVydCIgbmctY2xhc3M9Ilt0eXBlID8gXCdhbGVydC1cJyArIHR5cGUgOiBudWxsXSI+PGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJjbG9zZSIgbmctaWY9ImRpc21pc3NhYmxlIiBuZy1jbGljaz0iJGhpZGUoKSI+JnRpbWVzOzwvYnV0dG9uPiA8c3Ryb25nIG5nLWJpbmQ9InRpdGxlIj48L3N0cm9uZz4mbmJzcDs8c3BhbiBuZy1iaW5kLWh0bWw9ImNvbnRlbnQiPjwvc3Bhbj48L2Rpdj4nKTsKCn1dKTsKCi8vIFNvdXJjZTogYXNpZGUudHBsLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5hc2lkZScpLnJ1bihbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKCiAgJHRlbXBsYXRlQ2FjaGUucHV0KCdhc2lkZS9hc2lkZS50cGwuaHRtbCcsICc8ZGl2IGNsYXNzPSJhc2lkZSIgdGFiaW5kZXg9Ii0xIiByb2xlPSJkaWFsb2ciPjxkaXYgY2xhc3M9ImFzaWRlLWRpYWxvZyI+PGRpdiBjbGFzcz0iYXNpZGUtY29udGVudCI+PGRpdiBjbGFzcz0iYXNpZGUtaGVhZGVyIiBuZy1zaG93PSJ0aXRsZSI+PGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJjbG9zZSIgbmctY2xpY2s9IiRoaWRlKCkiPiZ0aW1lczs8L2J1dHRvbj48aDQgY2xhc3M9ImFzaWRlLXRpdGxlIiBuZy1iaW5kPSJ0aXRsZSI+PC9oND48L2Rpdj48ZGl2IGNsYXNzPSJhc2lkZS1ib2R5IiBuZy1iaW5kPSJjb250ZW50Ij48L2Rpdj48ZGl2IGNsYXNzPSJhc2lkZS1mb290ZXIiPjxidXR0b24gdHlwZT0iYnV0dG9uIiBjbGFzcz0iYnRuIGJ0bi1kZWZhdWx0IiBuZy1jbGljaz0iJGhpZGUoKSI+Q2xvc2U8L2J1dHRvbj48L2Rpdj48L2Rpdj48L2Rpdj48L2Rpdj4nKTsKCn1dKTsKCi8vIFNvdXJjZTogZHJvcGRvd24udHBsLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5kcm9wZG93bicpLnJ1bihbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKCiAgJHRlbXBsYXRlQ2FjaGUucHV0KCdkcm9wZG93bi9kcm9wZG93bi50cGwuaHRtbCcsICc8dWwgdGFiaW5kZXg9Ii0xIiBjbGFzcz0iZHJvcGRvd24tbWVudSIgcm9sZT0ibWVudSI+PGxpIHJvbGU9InByZXNlbnRhdGlvbiIgbmctY2xhc3M9IntkaXZpZGVyOiBpdGVtLmRpdmlkZXJ9IiBuZy1yZXBlYXQ9Iml0ZW0gaW4gY29udGVudCI+PGEgcm9sZT0ibWVudWl0ZW0iIHRhYmluZGV4PSItMSIgbmctaHJlZj0ie3tpdGVtLmhyZWZ9fSIgbmctaWY9IiFpdGVtLmRpdmlkZXIgJiYgaXRlbS5ocmVmIiB0YXJnZXQ9Int7aXRlbS50YXJnZXQgfHwgXCdcJ319IiBuZy1iaW5kPSJpdGVtLnRleHQiPjwvYT4gPGEgcm9sZT0ibWVudWl0ZW0iIHRhYmluZGV4PSItMSIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBuZy1pZj0iIWl0ZW0uZGl2aWRlciAmJiBpdGVtLmNsaWNrIiBuZy1jbGljaz0iJGV2YWwoaXRlbS5jbGljayk7JGhpZGUoKSIgbmctYmluZD0iaXRlbS50ZXh0Ij48L2E+PC9saT48L3VsPicpOwoKfV0pOwoKLy8gU291cmNlOiBkYXRlcGlja2VyLnRwbC5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAuZGF0ZXBpY2tlcicpLnJ1bihbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKCiAgJHRlbXBsYXRlQ2FjaGUucHV0KCdkYXRlcGlja2VyL2RhdGVwaWNrZXIudHBsLmh0bWwnLCAnPGRpdiBjbGFzcz0iZHJvcGRvd24tbWVudSBkYXRlcGlja2VyIiBuZy1jbGFzcz0iXCdkYXRlcGlja2VyLW1vZGUtXCcgKyAkbW9kZSIgc3R5bGU9Im1heC13aWR0aDogMzIwcHgiPjx0YWJsZSBzdHlsZT0idGFibGUtbGF5b3V0OiBmaXhlZDsgaGVpZ2h0OiAxMDAlOyB3aWR0aDogMTAwJSI+PHRoZWFkPjx0ciBjbGFzcz0idGV4dC1jZW50ZXIiPjx0aD48YnV0dG9uIHRhYmluZGV4PSItMSIgdHlwZT0iYnV0dG9uIiBjbGFzcz0iYnRuIGJ0bi1kZWZhdWx0IHB1bGwtbGVmdCIgbmctY2xpY2s9IiRzZWxlY3RQYW5lKC0xKSI+PGkgY2xhc3M9Int7JGljb25MZWZ0fX0iPjwvaT48L2J1dHRvbj48L3RoPjx0aCBjb2xzcGFuPSJ7eyByb3dzWzBdLmxlbmd0aCAtIDIgfX0iPjxidXR0b24gdGFiaW5kZXg9Ii0xIiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQgYnRuLWJsb2NrIHRleHQtc3Ryb25nIiBuZy1jbGljaz0iJHRvZ2dsZU1vZGUoKSI+PHN0cm9uZyBzdHlsZT0idGV4dC10cmFuc2Zvcm06IGNhcGl0YWxpemUiIG5nLWJpbmQ9InRpdGxlIj48L3N0cm9uZz48L2J1dHRvbj48L3RoPjx0aD48YnV0dG9uIHRhYmluZGV4PSItMSIgdHlwZT0iYnV0dG9uIiBjbGFzcz0iYnRuIGJ0bi1kZWZhdWx0IHB1bGwtcmlnaHQiIG5nLWNsaWNrPSIkc2VsZWN0UGFuZSgrMSkiPjxpIGNsYXNzPSJ7eyRpY29uUmlnaHR9fSI+PC9pPjwvYnV0dG9uPjwvdGg+PC90cj48dHIgbmctc2hvdz0ic2hvd0xhYmVscyIgbmctYmluZC1odG1sPSJsYWJlbHMiPjwvdHI+PC90aGVhZD48dGJvZHk+PHRyIG5nLXJlcGVhdD0iKGksIHJvdykgaW4gcm93cyIgaGVpZ2h0PSJ7eyAxMDAgLyByb3dzLmxlbmd0aCB9fSUiPjx0ZCBjbGFzcz0idGV4dC1jZW50ZXIiIG5nLXJlcGVhdD0iKGosIGVsKSBpbiByb3ciPjxidXR0b24gdGFiaW5kZXg9Ii0xIiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQiIHN0eWxlPSJ3aWR0aDogMTAwJSIgbmctY2xhc3M9IntcJ2J0bi1wcmltYXJ5XCc6IGVsLnNlbGVjdGVkLCBcJ2J0bi1pbmZvIGJ0bi10b2RheVwnOiBlbC5pc1RvZGF5ICYmICFlbC5zZWxlY3RlZH0iIG5nLWNsaWNrPSIkc2VsZWN0KGVsLmRhdGUpIiBuZy1kaXNhYmxlZD0iZWwuZGlzYWJsZWQiPjxzcGFuIG5nLWNsYXNzPSJ7XCd0ZXh0LW11dGVkXCc6IGVsLm11dGVkfSIgbmctYmluZD0iZWwubGFiZWwiPjwvc3Bhbj48L2J1dHRvbj48L3RkPjwvdHI+PC90Ym9keT48L3RhYmxlPjwvZGl2PicpOwoKfV0pOwoKLy8gU291cmNlOiBtb2RhbC50cGwuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLm1vZGFsJykucnVuKFsnJHRlbXBsYXRlQ2FjaGUnLCBmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewoKICAkdGVtcGxhdGVDYWNoZS5wdXQoJ21vZGFsL21vZGFsLnRwbC5odG1sJywgJzxkaXYgY2xhc3M9Im1vZGFsIiB0YWJpbmRleD0iLTEiIHJvbGU9ImRpYWxvZyI+PGRpdiBjbGFzcz0ibW9kYWwtZGlhbG9nIj48ZGl2IGNsYXNzPSJtb2RhbC1jb250ZW50Ij48ZGl2IGNsYXNzPSJtb2RhbC1oZWFkZXIiIG5nLXNob3c9InRpdGxlIj48YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImNsb3NlIiBuZy1jbGljaz0iJGhpZGUoKSI+JnRpbWVzOzwvYnV0dG9uPjxoNCBjbGFzcz0ibW9kYWwtdGl0bGUiIG5nLWJpbmQ9InRpdGxlIj48L2g0PjwvZGl2PjxkaXYgY2xhc3M9Im1vZGFsLWJvZHkiIG5nLWJpbmQ9ImNvbnRlbnQiPjwvZGl2PjxkaXYgY2xhc3M9Im1vZGFsLWZvb3RlciI+PGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQiIG5nLWNsaWNrPSIkaGlkZSgpIj5DbG9zZTwvYnV0dG9uPjwvZGl2PjwvZGl2PjwvZGl2PjwvZGl2PicpOwoKfV0pOwoKLy8gU291cmNlOiBwb3BvdmVyLnRwbC5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAucG9wb3ZlcicpLnJ1bihbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKCiAgJHRlbXBsYXRlQ2FjaGUucHV0KCdwb3BvdmVyL3BvcG92ZXIudHBsLmh0bWwnLCAnPGRpdiBjbGFzcz0icG9wb3ZlciI+PGRpdiBjbGFzcz0iYXJyb3ciPjwvZGl2PjxoMyBjbGFzcz0icG9wb3Zlci10aXRsZSIgbmctYmluZD0idGl0bGUiIG5nLXNob3c9InRpdGxlIj48L2gzPjxkaXYgY2xhc3M9InBvcG92ZXItY29udGVudCIgbmctYmluZD0iY29udGVudCI+PC9kaXY+PC9kaXY+Jyk7Cgp9XSk7CgovLyBTb3VyY2U6IHNlbGVjdC50cGwuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLnNlbGVjdCcpLnJ1bihbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKCiAgJHRlbXBsYXRlQ2FjaGUucHV0KCdzZWxlY3Qvc2VsZWN0LnRwbC5odG1sJywgJzx1bCB0YWJpbmRleD0iLTEiIGNsYXNzPSJzZWxlY3QgZHJvcGRvd24tbWVudSIgbmctc2hvdz0iJGlzVmlzaWJsZSgpIiByb2xlPSJzZWxlY3QiPjxsaSBuZy1pZj0iJHNob3dBbGxOb25lQnV0dG9ucyI+PGRpdiBjbGFzcz0iYnRuLWdyb3VwIiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogNXB4OyBtYXJnaW4tbGVmdDogNXB4Ij48YnV0dG9uIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQgYnRuLXhzIiBuZy1jbGljaz0iJHNlbGVjdEFsbCgpIj5BbGw8L2J1dHRvbj4gPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1kZWZhdWx0IGJ0bi14cyIgbmctY2xpY2s9IiRzZWxlY3ROb25lKCkiPk5vbmU8L2J1dHRvbj48L2Rpdj48L2xpPjxsaSByb2xlPSJwcmVzZW50YXRpb24iIG5nLXJlcGVhdD0ibWF0Y2ggaW4gJG1hdGNoZXMiIG5nLWNsYXNzPSJ7YWN0aXZlOiAkaXNBY3RpdmUoJGluZGV4KX0iPjxhIHN0eWxlPSJjdXJzb3I6IGRlZmF1bHQiIHJvbGU9Im1lbnVpdGVtIiB0YWJpbmRleD0iLTEiIG5nLWNsaWNrPSIkc2VsZWN0KCRpbmRleCwgJGV2ZW50KSI+PHNwYW4gbmctYmluZD0ibWF0Y2gubGFiZWwiPjwvc3Bhbj4gPGkgY2xhc3M9Int7JGljb25DaGVja21hcmt9fSBwdWxsLXJpZ2h0IiBuZy1pZj0iJGlzTXVsdGlwbGUgJiYgJGlzQWN0aXZlKCRpbmRleCkiPjwvaT48L2E+PC9saT48L3VsPicpOwoKfV0pOwoKLy8gU291cmNlOiB0YWIudHBsLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC50YWInKS5ydW4oWyckdGVtcGxhdGVDYWNoZScsIGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CgogICR0ZW1wbGF0ZUNhY2hlLnB1dCgndGFiL3RhYi50cGwuaHRtbCcsICc8dWwgY2xhc3M9Im5hdiIgbmctY2xhc3M9IiRuYXZDbGFzcyIgcm9sZT0idGFibGlzdCI+PGxpIG5nLXJlcGVhdD0iJHBhbmUgaW4gJHBhbmVzIiBuZy1jbGFzcz0iJGluZGV4ID09ICRwYW5lcy4kYWN0aXZlID8gJGFjdGl2ZUNsYXNzIDogXCdcJyI+PGEgcm9sZT0idGFiIiBkYXRhLXRvZ2dsZT0idGFiIiBuZy1jbGljaz0iJHNldEFjdGl2ZSgkaW5kZXgpIiBkYXRhLWluZGV4PSJ7eyAkaW5kZXggfX0iIG5nLWJpbmQtaHRtbD0iJHBhbmUudGl0bGUiPjwvYT48L2xpPjwvdWw+PGRpdiBuZy10cmFuc2NsdWRlIGNsYXNzPSJ0YWItY29udGVudCI+PC9kaXY+Jyk7Cgp9XSk7CgovLyBTb3VyY2U6IHRpbWVwaWNrZXIudHBsLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC50aW1lcGlja2VyJykucnVuKFsnJHRlbXBsYXRlQ2FjaGUnLCBmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewoKICAkdGVtcGxhdGVDYWNoZS5wdXQoJ3RpbWVwaWNrZXIvdGltZXBpY2tlci50cGwuaHRtbCcsICc8ZGl2IGNsYXNzPSJkcm9wZG93bi1tZW51IHRpbWVwaWNrZXIiIHN0eWxlPSJtaW4td2lkdGg6IDBweDt3aWR0aDogYXV0byI+PHRhYmxlIGhlaWdodD0iMTAwJSI+PHRoZWFkPjx0ciBjbGFzcz0idGV4dC1jZW50ZXIiPjx0aD48YnV0dG9uIHRhYmluZGV4PSItMSIgdHlwZT0iYnV0dG9uIiBjbGFzcz0iYnRuIGJ0bi1kZWZhdWx0IHB1bGwtbGVmdCIgbmctY2xpY2s9IiRhcnJvd0FjdGlvbigtMSwgMCkiPjxpIGNsYXNzPSJ7eyAkaWNvblVwIH19Ij48L2k+PC9idXR0b24+PC90aD48dGg+Jm5ic3A7PC90aD48dGg+PGJ1dHRvbiB0YWJpbmRleD0iLTEiIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImJ0biBidG4tZGVmYXVsdCBwdWxsLWxlZnQiIG5nLWNsaWNrPSIkYXJyb3dBY3Rpb24oLTEsIDEpIj48aSBjbGFzcz0ie3sgJGljb25VcCB9fSI+PC9pPjwvYnV0dG9uPjwvdGg+PC90cj48L3RoZWFkPjx0Ym9keT48dHIgbmctcmVwZWF0PSIoaSwgcm93KSBpbiByb3dzIj48dGQgY2xhc3M9InRleHQtY2VudGVyIj48YnV0dG9uIHRhYmluZGV4PSItMSIgc3R5bGU9IndpZHRoOiAxMDAlIiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQiIG5nLWNsYXNzPSJ7XCdidG4tcHJpbWFyeVwnOiByb3dbMF0uc2VsZWN0ZWR9IiBuZy1jbGljaz0iJHNlbGVjdChyb3dbMF0uZGF0ZSwgMCkiIG5nLWRpc2FibGVkPSJyb3dbMF0uZGlzYWJsZWQiPjxzcGFuIG5nLWNsYXNzPSJ7XCd0ZXh0LW11dGVkXCc6IHJvd1swXS5tdXRlZH0iIG5nLWJpbmQ9InJvd1swXS5sYWJlbCI+PC9zcGFuPjwvYnV0dG9uPjwvdGQ+PHRkPjxzcGFuIG5nLWJpbmQ9ImkgPT0gbWlkSW5kZXggPyB0aW1lU2VwYXJhdG9yIDogXCcgXCciPjwvc3Bhbj48L3RkPjx0ZCBjbGFzcz0idGV4dC1jZW50ZXIiPjxidXR0b24gdGFiaW5kZXg9Ii0xIiBuZy1pZj0icm93WzFdLmRhdGUiIHN0eWxlPSJ3aWR0aDogMTAwJSIgdHlwZT0iYnV0dG9uIiBjbGFzcz0iYnRuIGJ0bi1kZWZhdWx0IiBuZy1jbGFzcz0ie1wnYnRuLXByaW1hcnlcJzogcm93WzFdLnNlbGVjdGVkfSIgbmctY2xpY2s9IiRzZWxlY3Qocm93WzFdLmRhdGUsIDEpIiBuZy1kaXNhYmxlZD0icm93WzFdLmRpc2FibGVkIj48c3BhbiBuZy1jbGFzcz0ie1wndGV4dC1tdXRlZFwnOiByb3dbMV0ubXV0ZWR9IiBuZy1iaW5kPSJyb3dbMV0ubGFiZWwiPjwvc3Bhbj48L2J1dHRvbj48L3RkPjx0ZCBuZy1pZj0ic2hvd0FNIj4mbmJzcDs8L3RkPjx0ZCBuZy1pZj0ic2hvd0FNIj48YnV0dG9uIHRhYmluZGV4PSItMSIgbmctc2hvdz0iaSA9PSBtaWRJbmRleCAtICFpc0FNICogMSIgc3R5bGU9IndpZHRoOiAxMDAlIiB0eXBlPSJidXR0b24iIG5nLWNsYXNzPSJ7XCdidG4tcHJpbWFyeVwnOiAhIWlzQU19IiBjbGFzcz0iYnRuIGJ0bi1kZWZhdWx0IiBuZy1jbGljaz0iJHN3aXRjaE1lcmlkaWFuKCkiIG5nLWRpc2FibGVkPSJlbC5kaXNhYmxlZCI+QU08L2J1dHRvbj4gPGJ1dHRvbiB0YWJpbmRleD0iLTEiIG5nLXNob3c9ImkgPT0gbWlkSW5kZXggKyAxIC0gIWlzQU0gKiAxIiBzdHlsZT0id2lkdGg6IDEwMCUiIHR5cGU9ImJ1dHRvbiIgbmctY2xhc3M9IntcJ2J0bi1wcmltYXJ5XCc6ICFpc0FNfSIgY2xhc3M9ImJ0biBidG4tZGVmYXVsdCIgbmctY2xpY2s9IiRzd2l0Y2hNZXJpZGlhbigpIiBuZy1kaXNhYmxlZD0iZWwuZGlzYWJsZWQiPlBNPC9idXR0b24+PC90ZD48L3RyPjwvdGJvZHk+PHRmb290Pjx0ciBjbGFzcz0idGV4dC1jZW50ZXIiPjx0aD48YnV0dG9uIHRhYmluZGV4PSItMSIgdHlwZT0iYnV0dG9uIiBjbGFzcz0iYnRuIGJ0bi1kZWZhdWx0IHB1bGwtbGVmdCIgbmctY2xpY2s9IiRhcnJvd0FjdGlvbigxLCAwKSI+PGkgY2xhc3M9Int7ICRpY29uRG93biB9fSI+PC9pPjwvYnV0dG9uPjwvdGg+PHRoPiZuYnNwOzwvdGg+PHRoPjxidXR0b24gdGFiaW5kZXg9Ii0xIiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQgcHVsbC1sZWZ0IiBuZy1jbGljaz0iJGFycm93QWN0aW9uKDEsIDEpIj48aSBjbGFzcz0ie3sgJGljb25Eb3duIH19Ij48L2k+PC9idXR0b24+PC90aD48L3RyPjwvdGZvb3Q+PC90YWJsZT48L2Rpdj4nKTsKCn1dKTsKCi8vIFNvdXJjZTogdG9vbHRpcC50cGwuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLnRvb2x0aXAnKS5ydW4oWyckdGVtcGxhdGVDYWNoZScsIGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CgogICR0ZW1wbGF0ZUNhY2hlLnB1dCgndG9vbHRpcC90b29sdGlwLnRwbC5odG1sJywgJzxkaXYgY2xhc3M9InRvb2x0aXAgaW4iIG5nLXNob3c9InRpdGxlIj48ZGl2IGNsYXNzPSJ0b29sdGlwLWFycm93Ij48L2Rpdj48ZGl2IGNsYXNzPSJ0b29sdGlwLWlubmVyIiBuZy1iaW5kPSJ0aXRsZSI+PC9kaXY+PC9kaXY+Jyk7Cgp9XSk7CgovLyBTb3VyY2U6IHR5cGVhaGVhZC50cGwuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLnR5cGVhaGVhZCcpLnJ1bihbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKCiAgJHRlbXBsYXRlQ2FjaGUucHV0KCd0eXBlYWhlYWQvdHlwZWFoZWFkLnRwbC5odG1sJywgJzx1bCB0YWJpbmRleD0iLTEiIGNsYXNzPSJ0eXBlYWhlYWQgZHJvcGRvd24tbWVudSIgbmctc2hvdz0iJGlzVmlzaWJsZSgpIiByb2xlPSJzZWxlY3QiPjxsaSByb2xlPSJwcmVzZW50YXRpb24iIG5nLXJlcGVhdD0ibWF0Y2ggaW4gJG1hdGNoZXMiIG5nLWNsYXNzPSJ7YWN0aXZlOiAkaW5kZXggPT0gJGFjdGl2ZUluZGV4fSI+PGEgcm9sZT0ibWVudWl0ZW0iIHRhYmluZGV4PSItMSIgbmctY2xpY2s9IiRzZWxlY3QoJGluZGV4LCAkZXZlbnQpIiBuZy1iaW5kPSJtYXRjaC5sYWJlbCI+PC9hPjwvbGk+PC91bD4nKTsKCn1dKTsKCgp9KSh3aW5kb3csIGRvY3VtZW50KTsKCi8vISBtb21lbnQuanMKLy8hIHZlcnNpb24gOiAyLjguMwovLyEgYXV0aG9ycyA6IFRpbSBXb29kLCBJc2tyZW4gQ2hlcm5ldiwgTW9tZW50LmpzIGNvbnRyaWJ1dG9ycwovLyEgbGljZW5zZSA6IE1JVAovLyEgbW9tZW50anMuY29tCgooZnVuY3Rpb24gKHVuZGVmaW5lZCkgewogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIENvbnN0YW50cwogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKICAgIHZhciBtb21lbnQsCiAgICAgICAgVkVSU0lPTiA9ICcyLjguMycsCiAgICAgICAgLy8gdGhlIGdsb2JhbC1zY29wZSB0aGlzIGlzIE5PVCB0aGUgZ2xvYmFsIG9iamVjdCBpbiBOb2RlLmpzCiAgICAgICAgZ2xvYmFsU2NvcGUgPSB0eXBlb2YgZ2xvYmFsICE9PSAndW5kZWZpbmVkJyA/IGdsb2JhbCA6IHRoaXMsCiAgICAgICAgb2xkR2xvYmFsTW9tZW50LAogICAgICAgIHJvdW5kID0gTWF0aC5yb3VuZCwKICAgICAgICBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAgICAgaSwKCiAgICAgICAgWUVBUiA9IDAsCiAgICAgICAgTU9OVEggPSAxLAogICAgICAgIERBVEUgPSAyLAogICAgICAgIEhPVVIgPSAzLAogICAgICAgIE1JTlVURSA9IDQsCiAgICAgICAgU0VDT05EID0gNSwKICAgICAgICBNSUxMSVNFQ09ORCA9IDYsCgogICAgICAgIC8vIGludGVybmFsIHN0b3JhZ2UgZm9yIGxvY2FsZSBjb25maWcgZmlsZXMKICAgICAgICBsb2NhbGVzID0ge30sCgogICAgICAgIC8vIGV4dHJhIG1vbWVudCBpbnRlcm5hbCBwcm9wZXJ0aWVzIChwbHVnaW5zIHJlZ2lzdGVyIHByb3BzIGhlcmUpCiAgICAgICAgbW9tZW50UHJvcGVydGllcyA9IFtdLAoKICAgICAgICAvLyBjaGVjayBmb3Igbm9kZUpTCiAgICAgICAgaGFzTW9kdWxlID0gKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSwKCiAgICAgICAgLy8gQVNQLk5FVCBqc29uIGRhdGUgZm9ybWF0IHJlZ2V4CiAgICAgICAgYXNwTmV0SnNvblJlZ2V4ID0gL15cLz9EYXRlXCgoXC0/XGQrKS9pLAogICAgICAgIGFzcE5ldFRpbWVTcGFuSnNvblJlZ2V4ID0gLyhcLSk/KD86KFxkKilcLik/KFxkKylcOihcZCspKD86XDooXGQrKVwuPyhcZHszfSk/KT8vLAoKICAgICAgICAvLyBmcm9tIGh0dHA6Ly9kb2NzLmNsb3N1cmUtbGlicmFyeS5nb29nbGVjb2RlLmNvbS9naXQvY2xvc3VyZV9nb29nX2RhdGVfZGF0ZS5qcy5zb3VyY2UuaHRtbAogICAgICAgIC8vIHNvbWV3aGF0IG1vcmUgaW4gbGluZSB3aXRoIDQuNC4zLjIgMjAwNCBzcGVjLCBidXQgYWxsb3dzIGRlY2ltYWwgYW55d2hlcmUKICAgICAgICBpc29EdXJhdGlvblJlZ2V4ID0gL14oLSk/UCg/Oig/OihbMC05LC5dKilZKT8oPzooWzAtOSwuXSopTSk/KD86KFswLTksLl0qKUQpPyg/OlQoPzooWzAtOSwuXSopSCk/KD86KFswLTksLl0qKU0pPyg/OihbMC05LC5dKilTKT8pP3woWzAtOSwuXSopVykkLywKCiAgICAgICAgLy8gZm9ybWF0IHRva2VucwogICAgICAgIGZvcm1hdHRpbmdUb2tlbnMgPSAvKFxbW15cW10qXF0pfChcXCk/KE1vfE1NP00/TT98RG98REREb3xERD9EP0Q/fGRkZD9kP3xkbz98d1tvfHddP3xXW298V10/fFF8WVlZWVlZfFlZWVlZfFlZWVl8WVl8Z2coZ2dnPyk/fEdHKEdHRz8pP3xlfEV8YXxBfGhoP3xISD98bW0/fHNzP3xTezEsNH18WHx6ej98Wlo/fC4pL2csCiAgICAgICAgbG9jYWxGb3JtYXR0aW5nVG9rZW5zID0gLyhcW1teXFtdKlxdKXwoXFwpPyhMVHxMTD9MP0w/fGx7MSw0fSkvZywKCiAgICAgICAgLy8gcGFyc2luZyB0b2tlbiByZWdleGVzCiAgICAgICAgcGFyc2VUb2tlbk9uZU9yVHdvRGlnaXRzID0gL1xkXGQ/LywgLy8gMCAtIDk5CiAgICAgICAgcGFyc2VUb2tlbk9uZVRvVGhyZWVEaWdpdHMgPSAvXGR7MSwzfS8sIC8vIDAgLSA5OTkKICAgICAgICBwYXJzZVRva2VuT25lVG9Gb3VyRGlnaXRzID0gL1xkezEsNH0vLCAvLyAwIC0gOTk5OQogICAgICAgIHBhcnNlVG9rZW5PbmVUb1NpeERpZ2l0cyA9IC9bK1wtXT9cZHsxLDZ9LywgLy8gLTk5OSw5OTkgLSA5OTksOTk5CiAgICAgICAgcGFyc2VUb2tlbkRpZ2l0cyA9IC9cZCsvLCAvLyBub256ZXJvIG51bWJlciBvZiBkaWdpdHMKICAgICAgICBwYXJzZVRva2VuV29yZCA9IC9bMC05XSpbJ2Etelx1MDBBMC1cdTA1RkZcdTA3MDAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdK3xbXHUwNjAwLVx1MDZGRlwvXSsoXHMqP1tcdTA2MDAtXHUwNkZGXSspezEsMn0vaSwgLy8gYW55IHdvcmQgKG9yIHR3bykgY2hhcmFjdGVycyBvciBudW1iZXJzIGluY2x1ZGluZyB0d28vdGhyZWUgd29yZCBtb250aCBpbiBhcmFiaWMuCiAgICAgICAgcGFyc2VUb2tlblRpbWV6b25lID0gL1p8W1wrXC1dXGRcZDo/XGRcZC9naSwgLy8gKzAwOjAwIC0wMDowMCArMDAwMCAtMDAwMCBvciBaCiAgICAgICAgcGFyc2VUb2tlblQgPSAvVC9pLCAvLyBUIChJU08gc2VwYXJhdG9yKQogICAgICAgIHBhcnNlVG9rZW5UaW1lc3RhbXBNcyA9IC9bXCtcLV0/XGQrKFwuXGR7MSwzfSk/LywgLy8gMTIzNDU2Nzg5IDEyMzQ1Njc4OS4xMjMKICAgICAgICBwYXJzZVRva2VuT3JkaW5hbCA9IC9cZHsxLDJ9LywKCiAgICAgICAgLy9zdHJpY3QgcGFyc2luZyByZWdleGVzCiAgICAgICAgcGFyc2VUb2tlbk9uZURpZ2l0ID0gL1xkLywgLy8gMCAtIDkKICAgICAgICBwYXJzZVRva2VuVHdvRGlnaXRzID0gL1xkXGQvLCAvLyAwMCAtIDk5CiAgICAgICAgcGFyc2VUb2tlblRocmVlRGlnaXRzID0gL1xkezN9LywgLy8gMDAwIC0gOTk5CiAgICAgICAgcGFyc2VUb2tlbkZvdXJEaWdpdHMgPSAvXGR7NH0vLCAvLyAwMDAwIC0gOTk5OQogICAgICAgIHBhcnNlVG9rZW5TaXhEaWdpdHMgPSAvWystXT9cZHs2fS8sIC8vIC05OTksOTk5IC0gOTk5LDk5OQogICAgICAgIHBhcnNlVG9rZW5TaWduZWROdW1iZXIgPSAvWystXT9cZCsvLCAvLyAtaW5mIC0gaW5mCgogICAgICAgIC8vIGlzbyA4NjAxIHJlZ2V4CiAgICAgICAgLy8gMDAwMC0wMC0wMCAwMDAwLVcwMCBvciAwMDAwLVcwMC0wICsgVCArIDAwIG9yIDAwOjAwIG9yIDAwOjAwOjAwIG9yIDAwOjAwOjAwLjAwMCArICswMDowMCBvciArMDAwMCBvciArMDApCiAgICAgICAgaXNvUmVnZXggPSAvXlxzKig/OlsrLV1cZHs2fXxcZHs0fSktKD86KFxkXGQtXGRcZCl8KFdcZFxkJCl8KFdcZFxkLVxkKXwoXGRcZFxkKSkoKFR8ICkoXGRcZCg6XGRcZCg6XGRcZChcLlxkKyk/KT8pPyk/KFtcK1wtXVxkXGQoPzo6P1xkXGQpP3xccypaKT8pPyQvLAoKICAgICAgICBpc29Gb3JtYXQgPSAnWVlZWS1NTS1ERFRISDptbTpzc1onLAoKICAgICAgICBpc29EYXRlcyA9IFsKICAgICAgICAgICAgWydZWVlZWVktTU0tREQnLCAvWystXVxkezZ9LVxkezJ9LVxkezJ9L10sCiAgICAgICAgICAgIFsnWVlZWS1NTS1ERCcsIC9cZHs0fS1cZHsyfS1cZHsyfS9dLAogICAgICAgICAgICBbJ0dHR0ctW1ddV1ctRScsIC9cZHs0fS1XXGR7Mn0tXGQvXSwKICAgICAgICAgICAgWydHR0dHLVtXXVdXJywgL1xkezR9LVdcZHsyfS9dLAogICAgICAgICAgICBbJ1lZWVktREREJywgL1xkezR9LVxkezN9L10KICAgICAgICBdLAoKICAgICAgICAvLyBpc28gdGltZSBmb3JtYXRzIGFuZCByZWdleGVzCiAgICAgICAgaXNvVGltZXMgPSBbCiAgICAgICAgICAgIFsnSEg6bW06c3MuU1NTUycsIC8oVHwgKVxkXGQ6XGRcZDpcZFxkXC5cZCsvXSwKICAgICAgICAgICAgWydISDptbTpzcycsIC8oVHwgKVxkXGQ6XGRcZDpcZFxkL10sCiAgICAgICAgICAgIFsnSEg6bW0nLCAvKFR8IClcZFxkOlxkXGQvXSwKICAgICAgICAgICAgWydISCcsIC8oVHwgKVxkXGQvXQogICAgICAgIF0sCgogICAgICAgIC8vIHRpbWV6b25lIGNodW5rZXIgJysxMDowMCcgPiBbJzEwJywgJzAwJ10gb3IgJy0xNTMwJyA+IFsnLTE1JywgJzMwJ10KICAgICAgICBwYXJzZVRpbWV6b25lQ2h1bmtlciA9IC8oW1wrXC1dfFxkXGQpL2dpLAoKICAgICAgICAvLyBnZXR0ZXIgYW5kIHNldHRlciBuYW1lcwogICAgICAgIHByb3h5R2V0dGVyc0FuZFNldHRlcnMgPSAnRGF0ZXxIb3Vyc3xNaW51dGVzfFNlY29uZHN8TWlsbGlzZWNvbmRzJy5zcGxpdCgnfCcpLAogICAgICAgIHVuaXRNaWxsaXNlY29uZEZhY3RvcnMgPSB7CiAgICAgICAgICAgICdNaWxsaXNlY29uZHMnIDogMSwKICAgICAgICAgICAgJ1NlY29uZHMnIDogMWUzLAogICAgICAgICAgICAnTWludXRlcycgOiA2ZTQsCiAgICAgICAgICAgICdIb3VycycgOiAzNmU1LAogICAgICAgICAgICAnRGF5cycgOiA4NjRlNSwKICAgICAgICAgICAgJ01vbnRocycgOiAyNTkyZTYsCiAgICAgICAgICAgICdZZWFycycgOiAzMTUzNmU2CiAgICAgICAgfSwKCiAgICAgICAgdW5pdEFsaWFzZXMgPSB7CiAgICAgICAgICAgIG1zIDogJ21pbGxpc2Vjb25kJywKICAgICAgICAgICAgcyA6ICdzZWNvbmQnLAogICAgICAgICAgICBtIDogJ21pbnV0ZScsCiAgICAgICAgICAgIGggOiAnaG91cicsCiAgICAgICAgICAgIGQgOiAnZGF5JywKICAgICAgICAgICAgRCA6ICdkYXRlJywKICAgICAgICAgICAgdyA6ICd3ZWVrJywKICAgICAgICAgICAgVyA6ICdpc29XZWVrJywKICAgICAgICAgICAgTSA6ICdtb250aCcsCiAgICAgICAgICAgIFEgOiAncXVhcnRlcicsCiAgICAgICAgICAgIHkgOiAneWVhcicsCiAgICAgICAgICAgIERERCA6ICdkYXlPZlllYXInLAogICAgICAgICAgICBlIDogJ3dlZWtkYXknLAogICAgICAgICAgICBFIDogJ2lzb1dlZWtkYXknLAogICAgICAgICAgICBnZzogJ3dlZWtZZWFyJywKICAgICAgICAgICAgR0c6ICdpc29XZWVrWWVhcicKICAgICAgICB9LAoKICAgICAgICBjYW1lbEZ1bmN0aW9ucyA9IHsKICAgICAgICAgICAgZGF5b2Z5ZWFyIDogJ2RheU9mWWVhcicsCiAgICAgICAgICAgIGlzb3dlZWtkYXkgOiAnaXNvV2Vla2RheScsCiAgICAgICAgICAgIGlzb3dlZWsgOiAnaXNvV2VlaycsCiAgICAgICAgICAgIHdlZWt5ZWFyIDogJ3dlZWtZZWFyJywKICAgICAgICAgICAgaXNvd2Vla3llYXIgOiAnaXNvV2Vla1llYXInCiAgICAgICAgfSwKCiAgICAgICAgLy8gZm9ybWF0IGZ1bmN0aW9uIHN0cmluZ3MKICAgICAgICBmb3JtYXRGdW5jdGlvbnMgPSB7fSwKCiAgICAgICAgLy8gZGVmYXVsdCByZWxhdGl2ZSB0aW1lIHRocmVzaG9sZHMKICAgICAgICByZWxhdGl2ZVRpbWVUaHJlc2hvbGRzID0gewogICAgICAgICAgICBzOiA0NSwgIC8vIHNlY29uZHMgdG8gbWludXRlCiAgICAgICAgICAgIG06IDQ1LCAgLy8gbWludXRlcyB0byBob3VyCiAgICAgICAgICAgIGg6IDIyLCAgLy8gaG91cnMgdG8gZGF5CiAgICAgICAgICAgIGQ6IDI2LCAgLy8gZGF5cyB0byBtb250aAogICAgICAgICAgICBNOiAxMSAgIC8vIG1vbnRocyB0byB5ZWFyCiAgICAgICAgfSwKCiAgICAgICAgLy8gdG9rZW5zIHRvIG9yZGluYWxpemUgYW5kIHBhZAogICAgICAgIG9yZGluYWxpemVUb2tlbnMgPSAnREREIHcgVyBNIEQgZCcuc3BsaXQoJyAnKSwKICAgICAgICBwYWRkZWRUb2tlbnMgPSAnTSBEIEggaCBtIHMgdyBXJy5zcGxpdCgnICcpLAoKICAgICAgICBmb3JtYXRUb2tlbkZ1bmN0aW9ucyA9IHsKICAgICAgICAgICAgTSAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1vbnRoKCkgKyAxOwogICAgICAgICAgICB9LAogICAgICAgICAgICBNTU0gIDogZnVuY3Rpb24gKGZvcm1hdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLm1vbnRoc1Nob3J0KHRoaXMsIGZvcm1hdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIE1NTU0gOiBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkubW9udGhzKHRoaXMsIGZvcm1hdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEQgICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIERERCAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kYXlPZlllYXIoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZCAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRheSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZCAgIDogZnVuY3Rpb24gKGZvcm1hdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLndlZWtkYXlzTWluKHRoaXMsIGZvcm1hdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRkZCAgOiBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkud2Vla2RheXNTaG9ydCh0aGlzLCBmb3JtYXQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZGRkIDogZnVuY3Rpb24gKGZvcm1hdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLndlZWtkYXlzKHRoaXMsIGZvcm1hdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHcgICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy53ZWVrKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFcgICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pc29XZWVrKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFlZICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKHRoaXMueWVhcigpICUgMTAwLCAyKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgWVlZWSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy55ZWFyKCksIDQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBZWVlZWSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy55ZWFyKCksIDUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBZWVlZWVkgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgeSA9IHRoaXMueWVhcigpLCBzaWduID0geSA+PSAwID8gJysnIDogJy0nOwogICAgICAgICAgICAgICAgcmV0dXJuIHNpZ24gKyBsZWZ0WmVyb0ZpbGwoTWF0aC5hYnMoeSksIDYpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZyAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLndlZWtZZWFyKCkgJSAxMDAsIDIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZ2dnIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLndlZWtZZWFyKCksIDQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZ2dnZyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy53ZWVrWWVhcigpLCA1KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgR0cgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy5pc29XZWVrWWVhcigpICUgMTAwLCAyKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgR0dHRyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy5pc29XZWVrWWVhcigpLCA0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgR0dHR0cgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKHRoaXMuaXNvV2Vla1llYXIoKSwgNSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGUgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy53ZWVrZGF5KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEUgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pc29XZWVrZGF5KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGEgICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkubWVyaWRpZW0odGhpcy5ob3VycygpLCB0aGlzLm1pbnV0ZXMoKSwgdHJ1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEEgICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkubWVyaWRpZW0odGhpcy5ob3VycygpLCB0aGlzLm1pbnV0ZXMoKSwgZmFsc2UpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBIICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaG91cnMoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaCAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmhvdXJzKCkgJSAxMiB8fCAxMjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbSAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1pbnV0ZXMoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcyAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNlY29uZHMoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgUyAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0b0ludCh0aGlzLm1pbGxpc2Vjb25kcygpIC8gMTAwKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgU1MgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodG9JbnQodGhpcy5taWxsaXNlY29uZHMoKSAvIDEwKSwgMik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFNTUyAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKHRoaXMubWlsbGlzZWNvbmRzKCksIDMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBTU1NTIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLm1pbGxpc2Vjb25kcygpLCAzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgWiAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBhID0gLXRoaXMuem9uZSgpLAogICAgICAgICAgICAgICAgICAgIGIgPSAnKyc7CiAgICAgICAgICAgICAgICBpZiAoYSA8IDApIHsKICAgICAgICAgICAgICAgICAgICBhID0gLWE7CiAgICAgICAgICAgICAgICAgICAgYiA9ICctJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBiICsgbGVmdFplcm9GaWxsKHRvSW50KGEgLyA2MCksIDIpICsgJzonICsgbGVmdFplcm9GaWxsKHRvSW50KGEpICUgNjAsIDIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBaWiAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGEgPSAtdGhpcy56b25lKCksCiAgICAgICAgICAgICAgICAgICAgYiA9ICcrJzsKICAgICAgICAgICAgICAgIGlmIChhIDwgMCkgewogICAgICAgICAgICAgICAgICAgIGEgPSAtYTsKICAgICAgICAgICAgICAgICAgICBiID0gJy0nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGIgKyBsZWZ0WmVyb0ZpbGwodG9JbnQoYSAvIDYwKSwgMikgKyBsZWZ0WmVyb0ZpbGwodG9JbnQoYSkgJSA2MCwgMik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHogOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy56b25lQWJicigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB6eiA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnpvbmVOYW1lKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFggICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51bml4KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFEgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5xdWFydGVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBkZXByZWNhdGlvbnMgPSB7fSwKCiAgICAgICAgbGlzdHMgPSBbJ21vbnRocycsICdtb250aHNTaG9ydCcsICd3ZWVrZGF5cycsICd3ZWVrZGF5c1Nob3J0JywgJ3dlZWtkYXlzTWluJ107CgogICAgLy8gUGljayB0aGUgZmlyc3QgZGVmaW5lZCBvZiB0d28gb3IgdGhyZWUgYXJndW1lbnRzLiBkZmwgY29tZXMgZnJvbQogICAgLy8gZGVmYXVsdC4KICAgIGZ1bmN0aW9uIGRmbChhLCBiLCBjKSB7CiAgICAgICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgIGNhc2UgMjogcmV0dXJuIGEgIT0gbnVsbCA/IGEgOiBiOwogICAgICAgICAgICBjYXNlIDM6IHJldHVybiBhICE9IG51bGwgPyBhIDogYiAhPSBudWxsID8gYiA6IGM7CiAgICAgICAgICAgIGRlZmF1bHQ6IHRocm93IG5ldyBFcnJvcignSW1wbGVtZW50IG1lJyk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGhhc093blByb3AoYSwgYikgewogICAgICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKGEsIGIpOwogICAgfQoKICAgIGZ1bmN0aW9uIGRlZmF1bHRQYXJzaW5nRmxhZ3MoKSB7CiAgICAgICAgLy8gV2UgbmVlZCB0byBkZWVwIGNsb25lIHRoaXMgb2JqZWN0LCBhbmQgZXM1IHN0YW5kYXJkIGlzIG5vdCB2ZXJ5CiAgICAgICAgLy8gaGVscGZ1bC4KICAgICAgICByZXR1cm4gewogICAgICAgICAgICBlbXB0eSA6IGZhbHNlLAogICAgICAgICAgICB1bnVzZWRUb2tlbnMgOiBbXSwKICAgICAgICAgICAgdW51c2VkSW5wdXQgOiBbXSwKICAgICAgICAgICAgb3ZlcmZsb3cgOiAtMiwKICAgICAgICAgICAgY2hhcnNMZWZ0T3ZlciA6IDAsCiAgICAgICAgICAgIG51bGxJbnB1dCA6IGZhbHNlLAogICAgICAgICAgICBpbnZhbGlkTW9udGggOiBudWxsLAogICAgICAgICAgICBpbnZhbGlkRm9ybWF0IDogZmFsc2UsCiAgICAgICAgICAgIHVzZXJJbnZhbGlkYXRlZCA6IGZhbHNlLAogICAgICAgICAgICBpc286IGZhbHNlCiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBwcmludE1zZyhtc2cpIHsKICAgICAgICBpZiAobW9tZW50LnN1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5ncyA9PT0gZmFsc2UgJiYKICAgICAgICAgICAgICAgIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJyAmJiBjb25zb2xlLndhcm4pIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdEZXByZWNhdGlvbiB3YXJuaW5nOiAnICsgbXNnKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZGVwcmVjYXRlKG1zZywgZm4pIHsKICAgICAgICB2YXIgZmlyc3RUaW1lID0gdHJ1ZTsKICAgICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKGZpcnN0VGltZSkgewogICAgICAgICAgICAgICAgcHJpbnRNc2cobXNnKTsKICAgICAgICAgICAgICAgIGZpcnN0VGltZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0sIGZuKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkZXByZWNhdGVTaW1wbGUobmFtZSwgbXNnKSB7CiAgICAgICAgaWYgKCFkZXByZWNhdGlvbnNbbmFtZV0pIHsKICAgICAgICAgICAgcHJpbnRNc2cobXNnKTsKICAgICAgICAgICAgZGVwcmVjYXRpb25zW25hbWVdID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcGFkVG9rZW4oZnVuYywgY291bnQpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbChmdW5jLmNhbGwodGhpcywgYSksIGNvdW50KTsKICAgICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gb3JkaW5hbGl6ZVRva2VuKGZ1bmMsIHBlcmlvZCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkub3JkaW5hbChmdW5jLmNhbGwodGhpcywgYSksIHBlcmlvZCk7CiAgICAgICAgfTsKICAgIH0KCiAgICB3aGlsZSAob3JkaW5hbGl6ZVRva2Vucy5sZW5ndGgpIHsKICAgICAgICBpID0gb3JkaW5hbGl6ZVRva2Vucy5wb3AoKTsKICAgICAgICBmb3JtYXRUb2tlbkZ1bmN0aW9uc1tpICsgJ28nXSA9IG9yZGluYWxpemVUb2tlbihmb3JtYXRUb2tlbkZ1bmN0aW9uc1tpXSwgaSk7CiAgICB9CiAgICB3aGlsZSAocGFkZGVkVG9rZW5zLmxlbmd0aCkgewogICAgICAgIGkgPSBwYWRkZWRUb2tlbnMucG9wKCk7CiAgICAgICAgZm9ybWF0VG9rZW5GdW5jdGlvbnNbaSArIGldID0gcGFkVG9rZW4oZm9ybWF0VG9rZW5GdW5jdGlvbnNbaV0sIDIpOwogICAgfQogICAgZm9ybWF0VG9rZW5GdW5jdGlvbnMuRERERCA9IHBhZFRva2VuKGZvcm1hdFRva2VuRnVuY3Rpb25zLkRERCwgMyk7CgoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBDb25zdHJ1Y3RvcnMKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCiAgICBmdW5jdGlvbiBMb2NhbGUoKSB7CiAgICB9CgogICAgLy8gTW9tZW50IHByb3RvdHlwZSBvYmplY3QKICAgIGZ1bmN0aW9uIE1vbWVudChjb25maWcsIHNraXBPdmVyZmxvdykgewogICAgICAgIGlmIChza2lwT3ZlcmZsb3cgIT09IGZhbHNlKSB7CiAgICAgICAgICAgIGNoZWNrT3ZlcmZsb3coY29uZmlnKTsKICAgICAgICB9CiAgICAgICAgY29weUNvbmZpZyh0aGlzLCBjb25maWcpOwogICAgICAgIHRoaXMuX2QgPSBuZXcgRGF0ZSgrY29uZmlnLl9kKTsKICAgIH0KCiAgICAvLyBEdXJhdGlvbiBDb25zdHJ1Y3RvcgogICAgZnVuY3Rpb24gRHVyYXRpb24oZHVyYXRpb24pIHsKICAgICAgICB2YXIgbm9ybWFsaXplZElucHV0ID0gbm9ybWFsaXplT2JqZWN0VW5pdHMoZHVyYXRpb24pLAogICAgICAgICAgICB5ZWFycyA9IG5vcm1hbGl6ZWRJbnB1dC55ZWFyIHx8IDAsCiAgICAgICAgICAgIHF1YXJ0ZXJzID0gbm9ybWFsaXplZElucHV0LnF1YXJ0ZXIgfHwgMCwKICAgICAgICAgICAgbW9udGhzID0gbm9ybWFsaXplZElucHV0Lm1vbnRoIHx8IDAsCiAgICAgICAgICAgIHdlZWtzID0gbm9ybWFsaXplZElucHV0LndlZWsgfHwgMCwKICAgICAgICAgICAgZGF5cyA9IG5vcm1hbGl6ZWRJbnB1dC5kYXkgfHwgMCwKICAgICAgICAgICAgaG91cnMgPSBub3JtYWxpemVkSW5wdXQuaG91ciB8fCAwLAogICAgICAgICAgICBtaW51dGVzID0gbm9ybWFsaXplZElucHV0Lm1pbnV0ZSB8fCAwLAogICAgICAgICAgICBzZWNvbmRzID0gbm9ybWFsaXplZElucHV0LnNlY29uZCB8fCAwLAogICAgICAgICAgICBtaWxsaXNlY29uZHMgPSBub3JtYWxpemVkSW5wdXQubWlsbGlzZWNvbmQgfHwgMDsKCiAgICAgICAgLy8gcmVwcmVzZW50YXRpb24gZm9yIGRhdGVBZGRSZW1vdmUKICAgICAgICB0aGlzLl9taWxsaXNlY29uZHMgPSArbWlsbGlzZWNvbmRzICsKICAgICAgICAgICAgc2Vjb25kcyAqIDFlMyArIC8vIDEwMDAKICAgICAgICAgICAgbWludXRlcyAqIDZlNCArIC8vIDEwMDAgKiA2MAogICAgICAgICAgICBob3VycyAqIDM2ZTU7IC8vIDEwMDAgKiA2MCAqIDYwCiAgICAgICAgLy8gQmVjYXVzZSBvZiBkYXRlQWRkUmVtb3ZlIHRyZWF0cyAyNCBob3VycyBhcyBkaWZmZXJlbnQgZnJvbSBhCiAgICAgICAgLy8gZGF5IHdoZW4gd29ya2luZyBhcm91bmQgRFNULCB3ZSBuZWVkIHRvIHN0b3JlIHRoZW0gc2VwYXJhdGVseQogICAgICAgIHRoaXMuX2RheXMgPSArZGF5cyArCiAgICAgICAgICAgIHdlZWtzICogNzsKICAgICAgICAvLyBJdCBpcyBpbXBvc3NpYmxlIHRyYW5zbGF0ZSBtb250aHMgaW50byBkYXlzIHdpdGhvdXQga25vd2luZwogICAgICAgIC8vIHdoaWNoIG1vbnRocyB5b3UgYXJlIGFyZSB0YWxraW5nIGFib3V0LCBzbyB3ZSBoYXZlIHRvIHN0b3JlCiAgICAgICAgLy8gaXQgc2VwYXJhdGVseS4KICAgICAgICB0aGlzLl9tb250aHMgPSArbW9udGhzICsKICAgICAgICAgICAgcXVhcnRlcnMgKiAzICsKICAgICAgICAgICAgeWVhcnMgKiAxMjsKCiAgICAgICAgdGhpcy5fZGF0YSA9IHt9OwoKICAgICAgICB0aGlzLl9sb2NhbGUgPSBtb21lbnQubG9jYWxlRGF0YSgpOwoKICAgICAgICB0aGlzLl9idWJibGUoKTsKICAgIH0KCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgSGVscGVycwogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCiAgICBmdW5jdGlvbiBleHRlbmQoYSwgYikgewogICAgICAgIGZvciAodmFyIGkgaW4gYikgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcChiLCBpKSkgewogICAgICAgICAgICAgICAgYVtpXSA9IGJbaV07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChoYXNPd25Qcm9wKGIsICd0b1N0cmluZycpKSB7CiAgICAgICAgICAgIGEudG9TdHJpbmcgPSBiLnRvU3RyaW5nOwogICAgICAgIH0KCiAgICAgICAgaWYgKGhhc093blByb3AoYiwgJ3ZhbHVlT2YnKSkgewogICAgICAgICAgICBhLnZhbHVlT2YgPSBiLnZhbHVlT2Y7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYTsKICAgIH0KCiAgICBmdW5jdGlvbiBjb3B5Q29uZmlnKHRvLCBmcm9tKSB7CiAgICAgICAgdmFyIGksIHByb3AsIHZhbDsKCiAgICAgICAgaWYgKHR5cGVvZiBmcm9tLl9pc0FNb21lbnRPYmplY3QgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHRvLl9pc0FNb21lbnRPYmplY3QgPSBmcm9tLl9pc0FNb21lbnRPYmplY3Q7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZnJvbS5faSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgdG8uX2kgPSBmcm9tLl9pOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGZyb20uX2YgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHRvLl9mID0gZnJvbS5fZjsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBmcm9tLl9sICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICB0by5fbCA9IGZyb20uX2w7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZnJvbS5fc3RyaWN0ICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICB0by5fc3RyaWN0ID0gZnJvbS5fc3RyaWN0OwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGZyb20uX3R6bSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgdG8uX3R6bSA9IGZyb20uX3R6bTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBmcm9tLl9pc1VUQyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgdG8uX2lzVVRDID0gZnJvbS5faXNVVEM7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZnJvbS5fb2Zmc2V0ICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICB0by5fb2Zmc2V0ID0gZnJvbS5fb2Zmc2V0OwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGZyb20uX3BmICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICB0by5fcGYgPSBmcm9tLl9wZjsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBmcm9tLl9sb2NhbGUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHRvLl9sb2NhbGUgPSBmcm9tLl9sb2NhbGU7CiAgICAgICAgfQoKICAgICAgICBpZiAobW9tZW50UHJvcGVydGllcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGZvciAoaSBpbiBtb21lbnRQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICBwcm9wID0gbW9tZW50UHJvcGVydGllc1tpXTsKICAgICAgICAgICAgICAgIHZhbCA9IGZyb21bcHJvcF07CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbCAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICB0b1twcm9wXSA9IHZhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRvOwogICAgfQoKICAgIGZ1bmN0aW9uIGFic1JvdW5kKG51bWJlcikgewogICAgICAgIGlmIChudW1iZXIgPCAwKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLmNlaWwobnVtYmVyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihudW1iZXIpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBsZWZ0IHplcm8gZmlsbCBhIG51bWJlcgogICAgLy8gc2VlIGh0dHA6Ly9qc3BlcmYuY29tL2xlZnQtemVyby1maWxsaW5nIGZvciBwZXJmb3JtYW5jZSBjb21wYXJpc29uCiAgICBmdW5jdGlvbiBsZWZ0WmVyb0ZpbGwobnVtYmVyLCB0YXJnZXRMZW5ndGgsIGZvcmNlU2lnbikgewogICAgICAgIHZhciBvdXRwdXQgPSAnJyArIE1hdGguYWJzKG51bWJlciksCiAgICAgICAgICAgIHNpZ24gPSBudW1iZXIgPj0gMDsKCiAgICAgICAgd2hpbGUgKG91dHB1dC5sZW5ndGggPCB0YXJnZXRMZW5ndGgpIHsKICAgICAgICAgICAgb3V0cHV0ID0gJzAnICsgb3V0cHV0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gKHNpZ24gPyAoZm9yY2VTaWduID8gJysnIDogJycpIDogJy0nKSArIG91dHB1dDsKICAgIH0KCiAgICBmdW5jdGlvbiBwb3NpdGl2ZU1vbWVudHNEaWZmZXJlbmNlKGJhc2UsIG90aGVyKSB7CiAgICAgICAgdmFyIHJlcyA9IHttaWxsaXNlY29uZHM6IDAsIG1vbnRoczogMH07CgogICAgICAgIHJlcy5tb250aHMgPSBvdGhlci5tb250aCgpIC0gYmFzZS5tb250aCgpICsKICAgICAgICAgICAgKG90aGVyLnllYXIoKSAtIGJhc2UueWVhcigpKSAqIDEyOwogICAgICAgIGlmIChiYXNlLmNsb25lKCkuYWRkKHJlcy5tb250aHMsICdNJykuaXNBZnRlcihvdGhlcikpIHsKICAgICAgICAgICAgLS1yZXMubW9udGhzOwogICAgICAgIH0KCiAgICAgICAgcmVzLm1pbGxpc2Vjb25kcyA9ICtvdGhlciAtICsoYmFzZS5jbG9uZSgpLmFkZChyZXMubW9udGhzLCAnTScpKTsKCiAgICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICBmdW5jdGlvbiBtb21lbnRzRGlmZmVyZW5jZShiYXNlLCBvdGhlcikgewogICAgICAgIHZhciByZXM7CiAgICAgICAgb3RoZXIgPSBtYWtlQXMob3RoZXIsIGJhc2UpOwogICAgICAgIGlmIChiYXNlLmlzQmVmb3JlKG90aGVyKSkgewogICAgICAgICAgICByZXMgPSBwb3NpdGl2ZU1vbWVudHNEaWZmZXJlbmNlKGJhc2UsIG90aGVyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXMgPSBwb3NpdGl2ZU1vbWVudHNEaWZmZXJlbmNlKG90aGVyLCBiYXNlKTsKICAgICAgICAgICAgcmVzLm1pbGxpc2Vjb25kcyA9IC1yZXMubWlsbGlzZWNvbmRzOwogICAgICAgICAgICByZXMubW9udGhzID0gLXJlcy5tb250aHM7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzOwogICAgfQoKICAgIC8vIFRPRE86IHJlbW92ZSAnbmFtZScgYXJnIGFmdGVyIGRlcHJlY2F0aW9uIGlzIHJlbW92ZWQKICAgIGZ1bmN0aW9uIGNyZWF0ZUFkZGVyKGRpcmVjdGlvbiwgbmFtZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsLCBwZXJpb2QpIHsKICAgICAgICAgICAgdmFyIGR1ciwgdG1wOwogICAgICAgICAgICAvL2ludmVydCB0aGUgYXJndW1lbnRzLCBidXQgY29tcGxhaW4gYWJvdXQgaXQKICAgICAgICAgICAgaWYgKHBlcmlvZCAhPT0gbnVsbCAmJiAhaXNOYU4oK3BlcmlvZCkpIHsKICAgICAgICAgICAgICAgIGRlcHJlY2F0ZVNpbXBsZShuYW1lLCAnbW9tZW50KCkuJyArIG5hbWUgICsgJyhwZXJpb2QsIG51bWJlcikgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHVzZSBtb21lbnQoKS4nICsgbmFtZSArICcobnVtYmVyLCBwZXJpb2QpLicpOwogICAgICAgICAgICAgICAgdG1wID0gdmFsOyB2YWwgPSBwZXJpb2Q7IHBlcmlvZCA9IHRtcDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFsID0gdHlwZW9mIHZhbCA9PT0gJ3N0cmluZycgPyArdmFsIDogdmFsOwogICAgICAgICAgICBkdXIgPSBtb21lbnQuZHVyYXRpb24odmFsLCBwZXJpb2QpOwogICAgICAgICAgICBhZGRPclN1YnRyYWN0RHVyYXRpb25Gcm9tTW9tZW50KHRoaXMsIGR1ciwgZGlyZWN0aW9uKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBhZGRPclN1YnRyYWN0RHVyYXRpb25Gcm9tTW9tZW50KG1vbSwgZHVyYXRpb24sIGlzQWRkaW5nLCB1cGRhdGVPZmZzZXQpIHsKICAgICAgICB2YXIgbWlsbGlzZWNvbmRzID0gZHVyYXRpb24uX21pbGxpc2Vjb25kcywKICAgICAgICAgICAgZGF5cyA9IGR1cmF0aW9uLl9kYXlzLAogICAgICAgICAgICBtb250aHMgPSBkdXJhdGlvbi5fbW9udGhzOwogICAgICAgIHVwZGF0ZU9mZnNldCA9IHVwZGF0ZU9mZnNldCA9PSBudWxsID8gdHJ1ZSA6IHVwZGF0ZU9mZnNldDsKCiAgICAgICAgaWYgKG1pbGxpc2Vjb25kcykgewogICAgICAgICAgICBtb20uX2Quc2V0VGltZSgrbW9tLl9kICsgbWlsbGlzZWNvbmRzICogaXNBZGRpbmcpOwogICAgICAgIH0KICAgICAgICBpZiAoZGF5cykgewogICAgICAgICAgICByYXdTZXR0ZXIobW9tLCAnRGF0ZScsIHJhd0dldHRlcihtb20sICdEYXRlJykgKyBkYXlzICogaXNBZGRpbmcpOwogICAgICAgIH0KICAgICAgICBpZiAobW9udGhzKSB7CiAgICAgICAgICAgIHJhd01vbnRoU2V0dGVyKG1vbSwgcmF3R2V0dGVyKG1vbSwgJ01vbnRoJykgKyBtb250aHMgKiBpc0FkZGluZyk7CiAgICAgICAgfQogICAgICAgIGlmICh1cGRhdGVPZmZzZXQpIHsKICAgICAgICAgICAgbW9tZW50LnVwZGF0ZU9mZnNldChtb20sIGRheXMgfHwgbW9udGhzKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gY2hlY2sgaWYgaXMgYW4gYXJyYXkKICAgIGZ1bmN0aW9uIGlzQXJyYXkoaW5wdXQpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGlucHV0KSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0RhdGUoaW5wdXQpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGlucHV0KSA9PT0gJ1tvYmplY3QgRGF0ZV0nIHx8CiAgICAgICAgICAgIGlucHV0IGluc3RhbmNlb2YgRGF0ZTsKICAgIH0KCiAgICAvLyBjb21wYXJlIHR3byBhcnJheXMsIHJldHVybiB0aGUgbnVtYmVyIG9mIGRpZmZlcmVuY2VzCiAgICBmdW5jdGlvbiBjb21wYXJlQXJyYXlzKGFycmF5MSwgYXJyYXkyLCBkb250Q29udmVydCkgewogICAgICAgIHZhciBsZW4gPSBNYXRoLm1pbihhcnJheTEubGVuZ3RoLCBhcnJheTIubGVuZ3RoKSwKICAgICAgICAgICAgbGVuZ3RoRGlmZiA9IE1hdGguYWJzKGFycmF5MS5sZW5ndGggLSBhcnJheTIubGVuZ3RoKSwKICAgICAgICAgICAgZGlmZnMgPSAwLAogICAgICAgICAgICBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBpZiAoKGRvbnRDb252ZXJ0ICYmIGFycmF5MVtpXSAhPT0gYXJyYXkyW2ldKSB8fAogICAgICAgICAgICAgICAgKCFkb250Q29udmVydCAmJiB0b0ludChhcnJheTFbaV0pICE9PSB0b0ludChhcnJheTJbaV0pKSkgewogICAgICAgICAgICAgICAgZGlmZnMrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGlmZnMgKyBsZW5ndGhEaWZmOwogICAgfQoKICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZVVuaXRzKHVuaXRzKSB7CiAgICAgICAgaWYgKHVuaXRzKSB7CiAgICAgICAgICAgIHZhciBsb3dlcmVkID0gdW5pdHMudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC8oLilzJC8sICckMScpOwogICAgICAgICAgICB1bml0cyA9IHVuaXRBbGlhc2VzW3VuaXRzXSB8fCBjYW1lbEZ1bmN0aW9uc1tsb3dlcmVkXSB8fCBsb3dlcmVkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5pdHM7CiAgICB9CgogICAgZnVuY3Rpb24gbm9ybWFsaXplT2JqZWN0VW5pdHMoaW5wdXRPYmplY3QpIHsKICAgICAgICB2YXIgbm9ybWFsaXplZElucHV0ID0ge30sCiAgICAgICAgICAgIG5vcm1hbGl6ZWRQcm9wLAogICAgICAgICAgICBwcm9wOwoKICAgICAgICBmb3IgKHByb3AgaW4gaW5wdXRPYmplY3QpIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3AoaW5wdXRPYmplY3QsIHByb3ApKSB7CiAgICAgICAgICAgICAgICBub3JtYWxpemVkUHJvcCA9IG5vcm1hbGl6ZVVuaXRzKHByb3ApOwogICAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRQcm9wKSB7CiAgICAgICAgICAgICAgICAgICAgbm9ybWFsaXplZElucHV0W25vcm1hbGl6ZWRQcm9wXSA9IGlucHV0T2JqZWN0W3Byb3BdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbm9ybWFsaXplZElucHV0OwogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VMaXN0KGZpZWxkKSB7CiAgICAgICAgdmFyIGNvdW50LCBzZXR0ZXI7CgogICAgICAgIGlmIChmaWVsZC5pbmRleE9mKCd3ZWVrJykgPT09IDApIHsKICAgICAgICAgICAgY291bnQgPSA3OwogICAgICAgICAgICBzZXR0ZXIgPSAnZGF5JzsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZmllbGQuaW5kZXhPZignbW9udGgnKSA9PT0gMCkgewogICAgICAgICAgICBjb3VudCA9IDEyOwogICAgICAgICAgICBzZXR0ZXIgPSAnbW9udGgnOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgbW9tZW50W2ZpZWxkXSA9IGZ1bmN0aW9uIChmb3JtYXQsIGluZGV4KSB7CiAgICAgICAgICAgIHZhciBpLCBnZXR0ZXIsCiAgICAgICAgICAgICAgICBtZXRob2QgPSBtb21lbnQuX2xvY2FsZVtmaWVsZF0sCiAgICAgICAgICAgICAgICByZXN1bHRzID0gW107CgogICAgICAgICAgICBpZiAodHlwZW9mIGZvcm1hdCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gZm9ybWF0OwogICAgICAgICAgICAgICAgZm9ybWF0ID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9CgogICAgICAgICAgICBnZXR0ZXIgPSBmdW5jdGlvbiAoaSkgewogICAgICAgICAgICAgICAgdmFyIG0gPSBtb21lbnQoKS51dGMoKS5zZXQoc2V0dGVyLCBpKTsKICAgICAgICAgICAgICAgIHJldHVybiBtZXRob2QuY2FsbChtb21lbnQuX2xvY2FsZSwgbSwgZm9ybWF0IHx8ICcnKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChpbmRleCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0dGVyKGluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGdldHRlcihpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gdG9JbnQoYXJndW1lbnRGb3JDb2VyY2lvbikgewogICAgICAgIHZhciBjb2VyY2VkTnVtYmVyID0gK2FyZ3VtZW50Rm9yQ29lcmNpb24sCiAgICAgICAgICAgIHZhbHVlID0gMDsKCiAgICAgICAgaWYgKGNvZXJjZWROdW1iZXIgIT09IDAgJiYgaXNGaW5pdGUoY29lcmNlZE51bWJlcikpIHsKICAgICAgICAgICAgaWYgKGNvZXJjZWROdW1iZXIgPj0gMCkgewogICAgICAgICAgICAgICAgdmFsdWUgPSBNYXRoLmZsb29yKGNvZXJjZWROdW1iZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFsdWUgPSBNYXRoLmNlaWwoY29lcmNlZE51bWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBkYXlzSW5Nb250aCh5ZWFyLCBtb250aCkgewogICAgICAgIHJldHVybiBuZXcgRGF0ZShEYXRlLlVUQyh5ZWFyLCBtb250aCArIDEsIDApKS5nZXRVVENEYXRlKCk7CiAgICB9CgogICAgZnVuY3Rpb24gd2Vla3NJblllYXIoeWVhciwgZG93LCBkb3kpIHsKICAgICAgICByZXR1cm4gd2Vla09mWWVhcihtb21lbnQoW3llYXIsIDExLCAzMSArIGRvdyAtIGRveV0pLCBkb3csIGRveSkud2VlazsKICAgIH0KCiAgICBmdW5jdGlvbiBkYXlzSW5ZZWFyKHllYXIpIHsKICAgICAgICByZXR1cm4gaXNMZWFwWWVhcih5ZWFyKSA/IDM2NiA6IDM2NTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0xlYXBZZWFyKHllYXIpIHsKICAgICAgICByZXR1cm4gKHllYXIgJSA0ID09PSAwICYmIHllYXIgJSAxMDAgIT09IDApIHx8IHllYXIgJSA0MDAgPT09IDA7CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tPdmVyZmxvdyhtKSB7CiAgICAgICAgdmFyIG92ZXJmbG93OwogICAgICAgIGlmIChtLl9hICYmIG0uX3BmLm92ZXJmbG93ID09PSAtMikgewogICAgICAgICAgICBvdmVyZmxvdyA9CiAgICAgICAgICAgICAgICBtLl9hW01PTlRIXSA8IDAgfHwgbS5fYVtNT05USF0gPiAxMSA/IE1PTlRIIDoKICAgICAgICAgICAgICAgIG0uX2FbREFURV0gPCAxIHx8IG0uX2FbREFURV0gPiBkYXlzSW5Nb250aChtLl9hW1lFQVJdLCBtLl9hW01PTlRIXSkgPyBEQVRFIDoKICAgICAgICAgICAgICAgIG0uX2FbSE9VUl0gPCAwIHx8IG0uX2FbSE9VUl0gPiAyMyA/IEhPVVIgOgogICAgICAgICAgICAgICAgbS5fYVtNSU5VVEVdIDwgMCB8fCBtLl9hW01JTlVURV0gPiA1OSA/IE1JTlVURSA6CiAgICAgICAgICAgICAgICBtLl9hW1NFQ09ORF0gPCAwIHx8IG0uX2FbU0VDT05EXSA+IDU5ID8gU0VDT05EIDoKICAgICAgICAgICAgICAgIG0uX2FbTUlMTElTRUNPTkRdIDwgMCB8fCBtLl9hW01JTExJU0VDT05EXSA+IDk5OSA/IE1JTExJU0VDT05EIDoKICAgICAgICAgICAgICAgIC0xOwoKICAgICAgICAgICAgaWYgKG0uX3BmLl9vdmVyZmxvd0RheU9mWWVhciAmJiAob3ZlcmZsb3cgPCBZRUFSIHx8IG92ZXJmbG93ID4gREFURSkpIHsKICAgICAgICAgICAgICAgIG92ZXJmbG93ID0gREFURTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbS5fcGYub3ZlcmZsb3cgPSBvdmVyZmxvdzsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaXNWYWxpZChtKSB7CiAgICAgICAgaWYgKG0uX2lzVmFsaWQgPT0gbnVsbCkgewogICAgICAgICAgICBtLl9pc1ZhbGlkID0gIWlzTmFOKG0uX2QuZ2V0VGltZSgpKSAmJgogICAgICAgICAgICAgICAgbS5fcGYub3ZlcmZsb3cgPCAwICYmCiAgICAgICAgICAgICAgICAhbS5fcGYuZW1wdHkgJiYKICAgICAgICAgICAgICAgICFtLl9wZi5pbnZhbGlkTW9udGggJiYKICAgICAgICAgICAgICAgICFtLl9wZi5udWxsSW5wdXQgJiYKICAgICAgICAgICAgICAgICFtLl9wZi5pbnZhbGlkRm9ybWF0ICYmCiAgICAgICAgICAgICAgICAhbS5fcGYudXNlckludmFsaWRhdGVkOwoKICAgICAgICAgICAgaWYgKG0uX3N0cmljdCkgewogICAgICAgICAgICAgICAgbS5faXNWYWxpZCA9IG0uX2lzVmFsaWQgJiYKICAgICAgICAgICAgICAgICAgICBtLl9wZi5jaGFyc0xlZnRPdmVyID09PSAwICYmCiAgICAgICAgICAgICAgICAgICAgbS5fcGYudW51c2VkVG9rZW5zLmxlbmd0aCA9PT0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbS5faXNWYWxpZDsKICAgIH0KCiAgICBmdW5jdGlvbiBub3JtYWxpemVMb2NhbGUoa2V5KSB7CiAgICAgICAgcmV0dXJuIGtleSA/IGtleS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoJ18nLCAnLScpIDoga2V5OwogICAgfQoKICAgIC8vIHBpY2sgdGhlIGxvY2FsZSBmcm9tIHRoZSBhcnJheQogICAgLy8gdHJ5IFsnZW4tYXUnLCAnZW4tZ2InXSBhcyAnZW4tYXUnLCAnZW4tZ2InLCAnZW4nLCBhcyBpbiBtb3ZlIHRocm91Z2ggdGhlIGxpc3QgdHJ5aW5nIGVhY2gKICAgIC8vIHN1YnN0cmluZyBmcm9tIG1vc3Qgc3BlY2lmaWMgdG8gbGVhc3QsIGJ1dCBtb3ZlIHRvIHRoZSBuZXh0IGFycmF5IGl0ZW0gaWYgaXQncyBhIG1vcmUgc3BlY2lmaWMgdmFyaWFudCB0aGFuIHRoZSBjdXJyZW50IHJvb3QKICAgIGZ1bmN0aW9uIGNob29zZUxvY2FsZShuYW1lcykgewogICAgICAgIHZhciBpID0gMCwgaiwgbmV4dCwgbG9jYWxlLCBzcGxpdDsKCiAgICAgICAgd2hpbGUgKGkgPCBuYW1lcy5sZW5ndGgpIHsKICAgICAgICAgICAgc3BsaXQgPSBub3JtYWxpemVMb2NhbGUobmFtZXNbaV0pLnNwbGl0KCctJyk7CiAgICAgICAgICAgIGogPSBzcGxpdC5sZW5ndGg7CiAgICAgICAgICAgIG5leHQgPSBub3JtYWxpemVMb2NhbGUobmFtZXNbaSArIDFdKTsKICAgICAgICAgICAgbmV4dCA9IG5leHQgPyBuZXh0LnNwbGl0KCctJykgOiBudWxsOwogICAgICAgICAgICB3aGlsZSAoaiA+IDApIHsKICAgICAgICAgICAgICAgIGxvY2FsZSA9IGxvYWRMb2NhbGUoc3BsaXQuc2xpY2UoMCwgaikuam9pbignLScpKTsKICAgICAgICAgICAgICAgIGlmIChsb2NhbGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbG9jYWxlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG5leHQgJiYgbmV4dC5sZW5ndGggPj0gaiAmJiBjb21wYXJlQXJyYXlzKHNwbGl0LCBuZXh0LCB0cnVlKSA+PSBqIC0gMSkgewogICAgICAgICAgICAgICAgICAgIC8vdGhlIG5leHQgYXJyYXkgaXRlbSBpcyBiZXR0ZXIgdGhhbiBhIHNoYWxsb3dlciBzdWJzdHJpbmcgb2YgdGhpcyBvbmUKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGotLTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpKys7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIGxvYWRMb2NhbGUobmFtZSkgewogICAgICAgIHZhciBvbGRMb2NhbGUgPSBudWxsOwogICAgICAgIGlmICghbG9jYWxlc1tuYW1lXSAmJiBoYXNNb2R1bGUpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG9sZExvY2FsZSA9IG1vbWVudC5sb2NhbGUoKTsKICAgICAgICAgICAgICAgIHJlcXVpcmUoJy4vbG9jYWxlLycgKyBuYW1lKTsKICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgZGVmaW5lTG9jYWxlIGN1cnJlbnRseSBhbHNvIHNldHMgdGhlIGdsb2JhbCBsb2NhbGUsIHdlIHdhbnQgdG8gdW5kbyB0aGF0IGZvciBsYXp5IGxvYWRlZCBsb2NhbGVzCiAgICAgICAgICAgICAgICBtb21lbnQubG9jYWxlKG9sZExvY2FsZSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbG9jYWxlc1tuYW1lXTsKICAgIH0KCiAgICAvLyBSZXR1cm4gYSBtb21lbnQgZnJvbSBpbnB1dCwgdGhhdCBpcyBsb2NhbC91dGMvem9uZSBlcXVpdmFsZW50IHRvIG1vZGVsLgogICAgZnVuY3Rpb24gbWFrZUFzKGlucHV0LCBtb2RlbCkgewogICAgICAgIHJldHVybiBtb2RlbC5faXNVVEMgPyBtb21lbnQoaW5wdXQpLnpvbmUobW9kZWwuX29mZnNldCB8fCAwKSA6CiAgICAgICAgICAgIG1vbWVudChpbnB1dCkubG9jYWwoKTsKICAgIH0KCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgTG9jYWxlCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoKICAgIGV4dGVuZChMb2NhbGUucHJvdG90eXBlLCB7CgogICAgICAgIHNldCA6IGZ1bmN0aW9uIChjb25maWcpIHsKICAgICAgICAgICAgdmFyIHByb3AsIGk7CiAgICAgICAgICAgIGZvciAoaSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICAgIHByb3AgPSBjb25maWdbaV07CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3AgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzW2ldID0gcHJvcDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpc1snXycgKyBpXSA9IHByb3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfbW9udGhzIDogJ0phbnVhcnlfRmVicnVhcnlfTWFyY2hfQXByaWxfTWF5X0p1bmVfSnVseV9BdWd1c3RfU2VwdGVtYmVyX09jdG9iZXJfTm92ZW1iZXJfRGVjZW1iZXInLnNwbGl0KCdfJyksCiAgICAgICAgbW9udGhzIDogZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21vbnRoc1ttLm1vbnRoKCldOwogICAgICAgIH0sCgogICAgICAgIF9tb250aHNTaG9ydCA6ICdKYW5fRmViX01hcl9BcHJfTWF5X0p1bl9KdWxfQXVnX1NlcF9PY3RfTm92X0RlYycuc3BsaXQoJ18nKSwKICAgICAgICBtb250aHNTaG9ydCA6IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9tb250aHNTaG9ydFttLm1vbnRoKCldOwogICAgICAgIH0sCgogICAgICAgIG1vbnRoc1BhcnNlIDogZnVuY3Rpb24gKG1vbnRoTmFtZSkgewogICAgICAgICAgICB2YXIgaSwgbW9tLCByZWdleDsKCiAgICAgICAgICAgIGlmICghdGhpcy5fbW9udGhzUGFyc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuX21vbnRoc1BhcnNlID0gW107CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCAxMjsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBtYWtlIHRoZSByZWdleCBpZiB3ZSBkb24ndCBoYXZlIGl0IGFscmVhZHkKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fbW9udGhzUGFyc2VbaV0pIHsKICAgICAgICAgICAgICAgICAgICBtb20gPSBtb21lbnQudXRjKFsyMDAwLCBpXSk7CiAgICAgICAgICAgICAgICAgICAgcmVnZXggPSAnXicgKyB0aGlzLm1vbnRocyhtb20sICcnKSArICd8XicgKyB0aGlzLm1vbnRoc1Nob3J0KG1vbSwgJycpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX21vbnRoc1BhcnNlW2ldID0gbmV3IFJlZ0V4cChyZWdleC5yZXBsYWNlKCcuJywgJycpLCAnaScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gdGVzdCB0aGUgcmVnZXgKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9tb250aHNQYXJzZVtpXS50ZXN0KG1vbnRoTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF93ZWVrZGF5cyA6ICdTdW5kYXlfTW9uZGF5X1R1ZXNkYXlfV2VkbmVzZGF5X1RodXJzZGF5X0ZyaWRheV9TYXR1cmRheScuc3BsaXQoJ18nKSwKICAgICAgICB3ZWVrZGF5cyA6IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl93ZWVrZGF5c1ttLmRheSgpXTsKICAgICAgICB9LAoKICAgICAgICBfd2Vla2RheXNTaG9ydCA6ICdTdW5fTW9uX1R1ZV9XZWRfVGh1X0ZyaV9TYXQnLnNwbGl0KCdfJyksCiAgICAgICAgd2Vla2RheXNTaG9ydCA6IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl93ZWVrZGF5c1Nob3J0W20uZGF5KCldOwogICAgICAgIH0sCgogICAgICAgIF93ZWVrZGF5c01pbiA6ICdTdV9Nb19UdV9XZV9UaF9Gcl9TYScuc3BsaXQoJ18nKSwKICAgICAgICB3ZWVrZGF5c01pbiA6IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl93ZWVrZGF5c01pblttLmRheSgpXTsKICAgICAgICB9LAoKICAgICAgICB3ZWVrZGF5c1BhcnNlIDogZnVuY3Rpb24gKHdlZWtkYXlOYW1lKSB7CiAgICAgICAgICAgIHZhciBpLCBtb20sIHJlZ2V4OwoKICAgICAgICAgICAgaWYgKCF0aGlzLl93ZWVrZGF5c1BhcnNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl93ZWVrZGF5c1BhcnNlID0gW107CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCA3OyBpKyspIHsKICAgICAgICAgICAgICAgIC8vIG1ha2UgdGhlIHJlZ2V4IGlmIHdlIGRvbid0IGhhdmUgaXQgYWxyZWFkeQogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl93ZWVrZGF5c1BhcnNlW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgbW9tID0gbW9tZW50KFsyMDAwLCAxXSkuZGF5KGkpOwogICAgICAgICAgICAgICAgICAgIHJlZ2V4ID0gJ14nICsgdGhpcy53ZWVrZGF5cyhtb20sICcnKSArICd8XicgKyB0aGlzLndlZWtkYXlzU2hvcnQobW9tLCAnJykgKyAnfF4nICsgdGhpcy53ZWVrZGF5c01pbihtb20sICcnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl93ZWVrZGF5c1BhcnNlW2ldID0gbmV3IFJlZ0V4cChyZWdleC5yZXBsYWNlKCcuJywgJycpLCAnaScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gdGVzdCB0aGUgcmVnZXgKICAgICAgICAgICAgICAgIGlmICh0aGlzLl93ZWVrZGF5c1BhcnNlW2ldLnRlc3Qod2Vla2RheU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfbG9uZ0RhdGVGb3JtYXQgOiB7CiAgICAgICAgICAgIExUIDogJ2g6bW0gQScsCiAgICAgICAgICAgIEwgOiAnTU0vREQvWVlZWScsCiAgICAgICAgICAgIExMIDogJ01NTU0gRCwgWVlZWScsCiAgICAgICAgICAgIExMTCA6ICdNTU1NIEQsIFlZWVkgTFQnLAogICAgICAgICAgICBMTExMIDogJ2RkZGQsIE1NTU0gRCwgWVlZWSBMVCcKICAgICAgICB9LAogICAgICAgIGxvbmdEYXRlRm9ybWF0IDogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICB2YXIgb3V0cHV0ID0gdGhpcy5fbG9uZ0RhdGVGb3JtYXRba2V5XTsKICAgICAgICAgICAgaWYgKCFvdXRwdXQgJiYgdGhpcy5fbG9uZ0RhdGVGb3JtYXRba2V5LnRvVXBwZXJDYXNlKCldKSB7CiAgICAgICAgICAgICAgICBvdXRwdXQgPSB0aGlzLl9sb25nRGF0ZUZvcm1hdFtrZXkudG9VcHBlckNhc2UoKV0ucmVwbGFjZSgvTU1NTXxNTXxERHxkZGRkL2csIGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsLnNsaWNlKDEpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLl9sb25nRGF0ZUZvcm1hdFtrZXldID0gb3V0cHV0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgfSwKCiAgICAgICAgaXNQTSA6IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgICAvLyBJRTggUXVpcmtzIE1vZGUgJiBJRTcgU3RhbmRhcmRzIE1vZGUgZG8gbm90IGFsbG93IGFjY2Vzc2luZyBzdHJpbmdzIGxpa2UgYXJyYXlzCiAgICAgICAgICAgIC8vIFVzaW5nIGNoYXJBdCBzaG91bGQgYmUgbW9yZSBjb21wYXRpYmxlLgogICAgICAgICAgICByZXR1cm4gKChpbnB1dCArICcnKS50b0xvd2VyQ2FzZSgpLmNoYXJBdCgwKSA9PT0gJ3AnKTsKICAgICAgICB9LAoKICAgICAgICBfbWVyaWRpZW1QYXJzZSA6IC9bYXBdXC4/bT9cLj8vaSwKICAgICAgICBtZXJpZGllbSA6IGZ1bmN0aW9uIChob3VycywgbWludXRlcywgaXNMb3dlcikgewogICAgICAgICAgICBpZiAoaG91cnMgPiAxMSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlzTG93ZXIgPyAncG0nIDogJ1BNJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBpc0xvd2VyID8gJ2FtJyA6ICdBTSc7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfY2FsZW5kYXIgOiB7CiAgICAgICAgICAgIHNhbWVEYXkgOiAnW1RvZGF5IGF0XSBMVCcsCiAgICAgICAgICAgIG5leHREYXkgOiAnW1RvbW9ycm93IGF0XSBMVCcsCiAgICAgICAgICAgIG5leHRXZWVrIDogJ2RkZGQgW2F0XSBMVCcsCiAgICAgICAgICAgIGxhc3REYXkgOiAnW1llc3RlcmRheSBhdF0gTFQnLAogICAgICAgICAgICBsYXN0V2VlayA6ICdbTGFzdF0gZGRkZCBbYXRdIExUJywKICAgICAgICAgICAgc2FtZUVsc2UgOiAnTCcKICAgICAgICB9LAogICAgICAgIGNhbGVuZGFyIDogZnVuY3Rpb24gKGtleSwgbW9tKSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSB0aGlzLl9jYWxlbmRhcltrZXldOwogICAgICAgICAgICByZXR1cm4gdHlwZW9mIG91dHB1dCA9PT0gJ2Z1bmN0aW9uJyA/IG91dHB1dC5hcHBseShtb20pIDogb3V0cHV0OwogICAgICAgIH0sCgogICAgICAgIF9yZWxhdGl2ZVRpbWUgOiB7CiAgICAgICAgICAgIGZ1dHVyZSA6ICdpbiAlcycsCiAgICAgICAgICAgIHBhc3QgOiAnJXMgYWdvJywKICAgICAgICAgICAgcyA6ICdhIGZldyBzZWNvbmRzJywKICAgICAgICAgICAgbSA6ICdhIG1pbnV0ZScsCiAgICAgICAgICAgIG1tIDogJyVkIG1pbnV0ZXMnLAogICAgICAgICAgICBoIDogJ2FuIGhvdXInLAogICAgICAgICAgICBoaCA6ICclZCBob3VycycsCiAgICAgICAgICAgIGQgOiAnYSBkYXknLAogICAgICAgICAgICBkZCA6ICclZCBkYXlzJywKICAgICAgICAgICAgTSA6ICdhIG1vbnRoJywKICAgICAgICAgICAgTU0gOiAnJWQgbW9udGhzJywKICAgICAgICAgICAgeSA6ICdhIHllYXInLAogICAgICAgICAgICB5eSA6ICclZCB5ZWFycycKICAgICAgICB9LAoKICAgICAgICByZWxhdGl2ZVRpbWUgOiBmdW5jdGlvbiAobnVtYmVyLCB3aXRob3V0U3VmZml4LCBzdHJpbmcsIGlzRnV0dXJlKSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSB0aGlzLl9yZWxhdGl2ZVRpbWVbc3RyaW5nXTsKICAgICAgICAgICAgcmV0dXJuICh0eXBlb2Ygb3V0cHV0ID09PSAnZnVuY3Rpb24nKSA/CiAgICAgICAgICAgICAgICBvdXRwdXQobnVtYmVyLCB3aXRob3V0U3VmZml4LCBzdHJpbmcsIGlzRnV0dXJlKSA6CiAgICAgICAgICAgICAgICBvdXRwdXQucmVwbGFjZSgvJWQvaSwgbnVtYmVyKTsKICAgICAgICB9LAoKICAgICAgICBwYXN0RnV0dXJlIDogZnVuY3Rpb24gKGRpZmYsIG91dHB1dCkgewogICAgICAgICAgICB2YXIgZm9ybWF0ID0gdGhpcy5fcmVsYXRpdmVUaW1lW2RpZmYgPiAwID8gJ2Z1dHVyZScgOiAncGFzdCddOwogICAgICAgICAgICByZXR1cm4gdHlwZW9mIGZvcm1hdCA9PT0gJ2Z1bmN0aW9uJyA/IGZvcm1hdChvdXRwdXQpIDogZm9ybWF0LnJlcGxhY2UoLyVzL2ksIG91dHB1dCk7CiAgICAgICAgfSwKCiAgICAgICAgb3JkaW5hbCA6IGZ1bmN0aW9uIChudW1iZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29yZGluYWwucmVwbGFjZSgnJWQnLCBudW1iZXIpOwogICAgICAgIH0sCiAgICAgICAgX29yZGluYWwgOiAnJWQnLAoKICAgICAgICBwcmVwYXJzZSA6IGZ1bmN0aW9uIChzdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9LAoKICAgICAgICBwb3N0Zm9ybWF0IDogZnVuY3Rpb24gKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH0sCgogICAgICAgIHdlZWsgOiBmdW5jdGlvbiAobW9tKSB7CiAgICAgICAgICAgIHJldHVybiB3ZWVrT2ZZZWFyKG1vbSwgdGhpcy5fd2Vlay5kb3csIHRoaXMuX3dlZWsuZG95KS53ZWVrOwogICAgICAgIH0sCgogICAgICAgIF93ZWVrIDogewogICAgICAgICAgICBkb3cgOiAwLCAvLyBTdW5kYXkgaXMgdGhlIGZpcnN0IGRheSBvZiB0aGUgd2Vlay4KICAgICAgICAgICAgZG95IDogNiAgLy8gVGhlIHdlZWsgdGhhdCBjb250YWlucyBKYW4gMXN0IGlzIHRoZSBmaXJzdCB3ZWVrIG9mIHRoZSB5ZWFyLgogICAgICAgIH0sCgogICAgICAgIF9pbnZhbGlkRGF0ZTogJ0ludmFsaWQgZGF0ZScsCiAgICAgICAgaW52YWxpZERhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ludmFsaWREYXRlOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBGb3JtYXR0aW5nCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoKICAgIGZ1bmN0aW9uIHJlbW92ZUZvcm1hdHRpbmdUb2tlbnMoaW5wdXQpIHsKICAgICAgICBpZiAoaW5wdXQubWF0Y2goL1xbW1xzXFNdLykpIHsKICAgICAgICAgICAgcmV0dXJuIGlucHV0LnJlcGxhY2UoL15cW3xcXSQvZywgJycpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaW5wdXQucmVwbGFjZSgvXFwvZywgJycpOwogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VGb3JtYXRGdW5jdGlvbihmb3JtYXQpIHsKICAgICAgICB2YXIgYXJyYXkgPSBmb3JtYXQubWF0Y2goZm9ybWF0dGluZ1Rva2VucyksIGksIGxlbmd0aDsKCiAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKGZvcm1hdFRva2VuRnVuY3Rpb25zW2FycmF5W2ldXSkgewogICAgICAgICAgICAgICAgYXJyYXlbaV0gPSBmb3JtYXRUb2tlbkZ1bmN0aW9uc1thcnJheVtpXV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhcnJheVtpXSA9IHJlbW92ZUZvcm1hdHRpbmdUb2tlbnMoYXJyYXlbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG1vbSkgewogICAgICAgICAgICB2YXIgb3V0cHV0ID0gJyc7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgb3V0cHV0ICs9IGFycmF5W2ldIGluc3RhbmNlb2YgRnVuY3Rpb24gPyBhcnJheVtpXS5jYWxsKG1vbSwgZm9ybWF0KSA6IGFycmF5W2ldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgfTsKICAgIH0KCiAgICAvLyBmb3JtYXQgZGF0ZSB1c2luZyBuYXRpdmUgZGF0ZSBvYmplY3QKICAgIGZ1bmN0aW9uIGZvcm1hdE1vbWVudChtLCBmb3JtYXQpIHsKICAgICAgICBpZiAoIW0uaXNWYWxpZCgpKSB7CiAgICAgICAgICAgIHJldHVybiBtLmxvY2FsZURhdGEoKS5pbnZhbGlkRGF0ZSgpOwogICAgICAgIH0KCiAgICAgICAgZm9ybWF0ID0gZXhwYW5kRm9ybWF0KGZvcm1hdCwgbS5sb2NhbGVEYXRhKCkpOwoKICAgICAgICBpZiAoIWZvcm1hdEZ1bmN0aW9uc1tmb3JtYXRdKSB7CiAgICAgICAgICAgIGZvcm1hdEZ1bmN0aW9uc1tmb3JtYXRdID0gbWFrZUZvcm1hdEZ1bmN0aW9uKGZvcm1hdCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZm9ybWF0RnVuY3Rpb25zW2Zvcm1hdF0obSk7CiAgICB9CgogICAgZnVuY3Rpb24gZXhwYW5kRm9ybWF0KGZvcm1hdCwgbG9jYWxlKSB7CiAgICAgICAgdmFyIGkgPSA1OwoKICAgICAgICBmdW5jdGlvbiByZXBsYWNlTG9uZ0RhdGVGb3JtYXRUb2tlbnMoaW5wdXQpIHsKICAgICAgICAgICAgcmV0dXJuIGxvY2FsZS5sb25nRGF0ZUZvcm1hdChpbnB1dCkgfHwgaW5wdXQ7CiAgICAgICAgfQoKICAgICAgICBsb2NhbEZvcm1hdHRpbmdUb2tlbnMubGFzdEluZGV4ID0gMDsKICAgICAgICB3aGlsZSAoaSA+PSAwICYmIGxvY2FsRm9ybWF0dGluZ1Rva2Vucy50ZXN0KGZvcm1hdCkpIHsKICAgICAgICAgICAgZm9ybWF0ID0gZm9ybWF0LnJlcGxhY2UobG9jYWxGb3JtYXR0aW5nVG9rZW5zLCByZXBsYWNlTG9uZ0RhdGVGb3JtYXRUb2tlbnMpOwogICAgICAgICAgICBsb2NhbEZvcm1hdHRpbmdUb2tlbnMubGFzdEluZGV4ID0gMDsKICAgICAgICAgICAgaSAtPSAxOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZvcm1hdDsKICAgIH0KCgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIFBhcnNpbmcKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgLy8gZ2V0IHRoZSByZWdleCB0byBmaW5kIHRoZSBuZXh0IHRva2VuCiAgICBmdW5jdGlvbiBnZXRQYXJzZVJlZ2V4Rm9yVG9rZW4odG9rZW4sIGNvbmZpZykgewogICAgICAgIHZhciBhLCBzdHJpY3QgPSBjb25maWcuX3N0cmljdDsKICAgICAgICBzd2l0Y2ggKHRva2VuKSB7CiAgICAgICAgY2FzZSAnUSc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuT25lRGlnaXQ7CiAgICAgICAgY2FzZSAnRERERCc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuVGhyZWVEaWdpdHM7CiAgICAgICAgY2FzZSAnWVlZWSc6CiAgICAgICAgY2FzZSAnR0dHRyc6CiAgICAgICAgY2FzZSAnZ2dnZyc6CiAgICAgICAgICAgIHJldHVybiBzdHJpY3QgPyBwYXJzZVRva2VuRm91ckRpZ2l0cyA6IHBhcnNlVG9rZW5PbmVUb0ZvdXJEaWdpdHM7CiAgICAgICAgY2FzZSAnWSc6CiAgICAgICAgY2FzZSAnRyc6CiAgICAgICAgY2FzZSAnZyc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuU2lnbmVkTnVtYmVyOwogICAgICAgIGNhc2UgJ1lZWVlZWSc6CiAgICAgICAgY2FzZSAnWVlZWVknOgogICAgICAgIGNhc2UgJ0dHR0dHJzoKICAgICAgICBjYXNlICdnZ2dnZyc6CiAgICAgICAgICAgIHJldHVybiBzdHJpY3QgPyBwYXJzZVRva2VuU2l4RGlnaXRzIDogcGFyc2VUb2tlbk9uZVRvU2l4RGlnaXRzOwogICAgICAgIGNhc2UgJ1MnOgogICAgICAgICAgICBpZiAoc3RyaWN0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyc2VUb2tlbk9uZURpZ2l0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICBjYXNlICdTUyc6CiAgICAgICAgICAgIGlmIChzdHJpY3QpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuVHdvRGlnaXRzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICBjYXNlICdTU1MnOgogICAgICAgICAgICBpZiAoc3RyaWN0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyc2VUb2tlblRocmVlRGlnaXRzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICBjYXNlICdEREQnOgogICAgICAgICAgICByZXR1cm4gcGFyc2VUb2tlbk9uZVRvVGhyZWVEaWdpdHM7CiAgICAgICAgY2FzZSAnTU1NJzoKICAgICAgICBjYXNlICdNTU1NJzoKICAgICAgICBjYXNlICdkZCc6CiAgICAgICAgY2FzZSAnZGRkJzoKICAgICAgICBjYXNlICdkZGRkJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5Xb3JkOwogICAgICAgIGNhc2UgJ2EnOgogICAgICAgIGNhc2UgJ0EnOgogICAgICAgICAgICByZXR1cm4gY29uZmlnLl9sb2NhbGUuX21lcmlkaWVtUGFyc2U7CiAgICAgICAgY2FzZSAnWCc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuVGltZXN0YW1wTXM7CiAgICAgICAgY2FzZSAnWic6CiAgICAgICAgY2FzZSAnWlonOgogICAgICAgICAgICByZXR1cm4gcGFyc2VUb2tlblRpbWV6b25lOwogICAgICAgIGNhc2UgJ1QnOgogICAgICAgICAgICByZXR1cm4gcGFyc2VUb2tlblQ7CiAgICAgICAgY2FzZSAnU1NTUyc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuRGlnaXRzOwogICAgICAgIGNhc2UgJ01NJzoKICAgICAgICBjYXNlICdERCc6CiAgICAgICAgY2FzZSAnWVknOgogICAgICAgIGNhc2UgJ0dHJzoKICAgICAgICBjYXNlICdnZyc6CiAgICAgICAgY2FzZSAnSEgnOgogICAgICAgIGNhc2UgJ2hoJzoKICAgICAgICBjYXNlICdtbSc6CiAgICAgICAgY2FzZSAnc3MnOgogICAgICAgIGNhc2UgJ3d3JzoKICAgICAgICBjYXNlICdXVyc6CiAgICAgICAgICAgIHJldHVybiBzdHJpY3QgPyBwYXJzZVRva2VuVHdvRGlnaXRzIDogcGFyc2VUb2tlbk9uZU9yVHdvRGlnaXRzOwogICAgICAgIGNhc2UgJ00nOgogICAgICAgIGNhc2UgJ0QnOgogICAgICAgIGNhc2UgJ2QnOgogICAgICAgIGNhc2UgJ0gnOgogICAgICAgIGNhc2UgJ2gnOgogICAgICAgIGNhc2UgJ20nOgogICAgICAgIGNhc2UgJ3MnOgogICAgICAgIGNhc2UgJ3cnOgogICAgICAgIGNhc2UgJ1cnOgogICAgICAgIGNhc2UgJ2UnOgogICAgICAgIGNhc2UgJ0UnOgogICAgICAgICAgICByZXR1cm4gcGFyc2VUb2tlbk9uZU9yVHdvRGlnaXRzOwogICAgICAgIGNhc2UgJ0RvJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5PcmRpbmFsOwogICAgICAgIGRlZmF1bHQgOgogICAgICAgICAgICBhID0gbmV3IFJlZ0V4cChyZWdleHBFc2NhcGUodW5lc2NhcGVGb3JtYXQodG9rZW4ucmVwbGFjZSgnXFwnLCAnJykpLCAnaScpKTsKICAgICAgICAgICAgcmV0dXJuIGE7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHRpbWV6b25lTWludXRlc0Zyb21TdHJpbmcoc3RyaW5nKSB7CiAgICAgICAgc3RyaW5nID0gc3RyaW5nIHx8ICcnOwogICAgICAgIHZhciBwb3NzaWJsZVR6TWF0Y2hlcyA9IChzdHJpbmcubWF0Y2gocGFyc2VUb2tlblRpbWV6b25lKSB8fCBbXSksCiAgICAgICAgICAgIHR6Q2h1bmsgPSBwb3NzaWJsZVR6TWF0Y2hlc1twb3NzaWJsZVR6TWF0Y2hlcy5sZW5ndGggLSAxXSB8fCBbXSwKICAgICAgICAgICAgcGFydHMgPSAodHpDaHVuayArICcnKS5tYXRjaChwYXJzZVRpbWV6b25lQ2h1bmtlcikgfHwgWyctJywgMCwgMF0sCiAgICAgICAgICAgIG1pbnV0ZXMgPSArKHBhcnRzWzFdICogNjApICsgdG9JbnQocGFydHNbMl0pOwoKICAgICAgICByZXR1cm4gcGFydHNbMF0gPT09ICcrJyA/IC1taW51dGVzIDogbWludXRlczsKICAgIH0KCiAgICAvLyBmdW5jdGlvbiB0byBjb252ZXJ0IHN0cmluZyBpbnB1dCB0byBkYXRlCiAgICBmdW5jdGlvbiBhZGRUaW1lVG9BcnJheUZyb21Ub2tlbih0b2tlbiwgaW5wdXQsIGNvbmZpZykgewogICAgICAgIHZhciBhLCBkYXRlUGFydEFycmF5ID0gY29uZmlnLl9hOwoKICAgICAgICBzd2l0Y2ggKHRva2VuKSB7CiAgICAgICAgLy8gUVVBUlRFUgogICAgICAgIGNhc2UgJ1EnOgogICAgICAgICAgICBpZiAoaW5wdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGF0ZVBhcnRBcnJheVtNT05USF0gPSAodG9JbnQoaW5wdXQpIC0gMSkgKiAzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIE1PTlRICiAgICAgICAgY2FzZSAnTScgOiAvLyBmYWxsIHRocm91Z2ggdG8gTU0KICAgICAgICBjYXNlICdNTScgOgogICAgICAgICAgICBpZiAoaW5wdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGF0ZVBhcnRBcnJheVtNT05USF0gPSB0b0ludChpbnB1dCkgLSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ01NTScgOiAvLyBmYWxsIHRocm91Z2ggdG8gTU1NTQogICAgICAgIGNhc2UgJ01NTU0nIDoKICAgICAgICAgICAgYSA9IGNvbmZpZy5fbG9jYWxlLm1vbnRoc1BhcnNlKGlucHV0KTsKICAgICAgICAgICAgLy8gaWYgd2UgZGlkbid0IGZpbmQgYSBtb250aCBuYW1lLCBtYXJrIHRoZSBkYXRlIGFzIGludmFsaWQuCiAgICAgICAgICAgIGlmIChhICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbTU9OVEhdID0gYTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5fcGYuaW52YWxpZE1vbnRoID0gaW5wdXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gREFZIE9GIE1PTlRICiAgICAgICAgY2FzZSAnRCcgOiAvLyBmYWxsIHRocm91Z2ggdG8gREQKICAgICAgICBjYXNlICdERCcgOgogICAgICAgICAgICBpZiAoaW5wdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGF0ZVBhcnRBcnJheVtEQVRFXSA9IHRvSW50KGlucHV0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdEbycgOgogICAgICAgICAgICBpZiAoaW5wdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGF0ZVBhcnRBcnJheVtEQVRFXSA9IHRvSW50KHBhcnNlSW50KGlucHV0LCAxMCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIERBWSBPRiBZRUFSCiAgICAgICAgY2FzZSAnREREJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBERERECiAgICAgICAgY2FzZSAnRERERCcgOgogICAgICAgICAgICBpZiAoaW5wdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29uZmlnLl9kYXlPZlllYXIgPSB0b0ludChpbnB1dCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIFlFQVIKICAgICAgICBjYXNlICdZWScgOgogICAgICAgICAgICBkYXRlUGFydEFycmF5W1lFQVJdID0gbW9tZW50LnBhcnNlVHdvRGlnaXRZZWFyKGlucHV0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnWVlZWScgOgogICAgICAgIGNhc2UgJ1lZWVlZJyA6CiAgICAgICAgY2FzZSAnWVlZWVlZJyA6CiAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbWUVBUl0gPSB0b0ludChpbnB1dCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIEFNIC8gUE0KICAgICAgICBjYXNlICdhJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBBCiAgICAgICAgY2FzZSAnQScgOgogICAgICAgICAgICBjb25maWcuX2lzUG0gPSBjb25maWcuX2xvY2FsZS5pc1BNKGlucHV0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gMjQgSE9VUgogICAgICAgIGNhc2UgJ0gnIDogLy8gZmFsbCB0aHJvdWdoIHRvIGhoCiAgICAgICAgY2FzZSAnSEgnIDogLy8gZmFsbCB0aHJvdWdoIHRvIGhoCiAgICAgICAgY2FzZSAnaCcgOiAvLyBmYWxsIHRocm91Z2ggdG8gaGgKICAgICAgICBjYXNlICdoaCcgOgogICAgICAgICAgICBkYXRlUGFydEFycmF5W0hPVVJdID0gdG9JbnQoaW5wdXQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyBNSU5VVEUKICAgICAgICBjYXNlICdtJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBtbQogICAgICAgIGNhc2UgJ21tJyA6CiAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbTUlOVVRFXSA9IHRvSW50KGlucHV0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gU0VDT05ECiAgICAgICAgY2FzZSAncycgOiAvLyBmYWxsIHRocm91Z2ggdG8gc3MKICAgICAgICBjYXNlICdzcycgOgogICAgICAgICAgICBkYXRlUGFydEFycmF5W1NFQ09ORF0gPSB0b0ludChpbnB1dCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIE1JTExJU0VDT05ECiAgICAgICAgY2FzZSAnUycgOgogICAgICAgIGNhc2UgJ1NTJyA6CiAgICAgICAgY2FzZSAnU1NTJyA6CiAgICAgICAgY2FzZSAnU1NTUycgOgogICAgICAgICAgICBkYXRlUGFydEFycmF5W01JTExJU0VDT05EXSA9IHRvSW50KCgnMC4nICsgaW5wdXQpICogMTAwMCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIFVOSVggVElNRVNUQU1QIFdJVEggTVMKICAgICAgICBjYXNlICdYJzoKICAgICAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUocGFyc2VGbG9hdChpbnB1dCkgKiAxMDAwKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gVElNRVpPTkUKICAgICAgICBjYXNlICdaJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBaWgogICAgICAgIGNhc2UgJ1paJyA6CiAgICAgICAgICAgIGNvbmZpZy5fdXNlVVRDID0gdHJ1ZTsKICAgICAgICAgICAgY29uZmlnLl90em0gPSB0aW1lem9uZU1pbnV0ZXNGcm9tU3RyaW5nKGlucHV0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gV0VFS0RBWSAtIGh1bWFuCiAgICAgICAgY2FzZSAnZGQnOgogICAgICAgIGNhc2UgJ2RkZCc6CiAgICAgICAgY2FzZSAnZGRkZCc6CiAgICAgICAgICAgIGEgPSBjb25maWcuX2xvY2FsZS53ZWVrZGF5c1BhcnNlKGlucHV0KTsKICAgICAgICAgICAgLy8gaWYgd2UgZGlkbid0IGdldCBhIHdlZWtkYXkgbmFtZSwgbWFyayB0aGUgZGF0ZSBhcyBpbnZhbGlkCiAgICAgICAgICAgIGlmIChhICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5fdyA9IGNvbmZpZy5fdyB8fCB7fTsKICAgICAgICAgICAgICAgIGNvbmZpZy5fd1snZCddID0gYTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5fcGYuaW52YWxpZFdlZWtkYXkgPSBpbnB1dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyBXRUVLLCBXRUVLIERBWSAtIG51bWVyaWMKICAgICAgICBjYXNlICd3JzoKICAgICAgICBjYXNlICd3dyc6CiAgICAgICAgY2FzZSAnVyc6CiAgICAgICAgY2FzZSAnV1cnOgogICAgICAgIGNhc2UgJ2QnOgogICAgICAgIGNhc2UgJ2UnOgogICAgICAgIGNhc2UgJ0UnOgogICAgICAgICAgICB0b2tlbiA9IHRva2VuLnN1YnN0cigwLCAxKTsKICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgIGNhc2UgJ2dnZ2cnOgogICAgICAgIGNhc2UgJ0dHR0cnOgogICAgICAgIGNhc2UgJ0dHR0dHJzoKICAgICAgICAgICAgdG9rZW4gPSB0b2tlbi5zdWJzdHIoMCwgMik7CiAgICAgICAgICAgIGlmIChpbnB1dCkgewogICAgICAgICAgICAgICAgY29uZmlnLl93ID0gY29uZmlnLl93IHx8IHt9OwogICAgICAgICAgICAgICAgY29uZmlnLl93W3Rva2VuXSA9IHRvSW50KGlucHV0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdnZyc6CiAgICAgICAgY2FzZSAnR0cnOgogICAgICAgICAgICBjb25maWcuX3cgPSBjb25maWcuX3cgfHwge307CiAgICAgICAgICAgIGNvbmZpZy5fd1t0b2tlbl0gPSBtb21lbnQucGFyc2VUd29EaWdpdFllYXIoaW5wdXQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBkYXlPZlllYXJGcm9tV2Vla0luZm8oY29uZmlnKSB7CiAgICAgICAgdmFyIHcsIHdlZWtZZWFyLCB3ZWVrLCB3ZWVrZGF5LCBkb3csIGRveSwgdGVtcDsKCiAgICAgICAgdyA9IGNvbmZpZy5fdzsKICAgICAgICBpZiAody5HRyAhPSBudWxsIHx8IHcuVyAhPSBudWxsIHx8IHcuRSAhPSBudWxsKSB7CiAgICAgICAgICAgIGRvdyA9IDE7CiAgICAgICAgICAgIGRveSA9IDQ7CgogICAgICAgICAgICAvLyBUT0RPOiBXZSBuZWVkIHRvIHRha2UgdGhlIGN1cnJlbnQgaXNvV2Vla1llYXIsIGJ1dCB0aGF0IGRlcGVuZHMgb24KICAgICAgICAgICAgLy8gaG93IHdlIGludGVycHJldCBub3cgKGxvY2FsLCB1dGMsIGZpeGVkIG9mZnNldCkuIFNvIGNyZWF0ZQogICAgICAgICAgICAvLyBhIG5vdyB2ZXJzaW9uIG9mIGN1cnJlbnQgY29uZmlnICh0YWtlIGxvY2FsL3V0Yy9vZmZzZXQgZmxhZ3MsIGFuZAogICAgICAgICAgICAvLyBjcmVhdGUgbm93KS4KICAgICAgICAgICAgd2Vla1llYXIgPSBkZmwody5HRywgY29uZmlnLl9hW1lFQVJdLCB3ZWVrT2ZZZWFyKG1vbWVudCgpLCAxLCA0KS55ZWFyKTsKICAgICAgICAgICAgd2VlayA9IGRmbCh3LlcsIDEpOwogICAgICAgICAgICB3ZWVrZGF5ID0gZGZsKHcuRSwgMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZG93ID0gY29uZmlnLl9sb2NhbGUuX3dlZWsuZG93OwogICAgICAgICAgICBkb3kgPSBjb25maWcuX2xvY2FsZS5fd2Vlay5kb3k7CgogICAgICAgICAgICB3ZWVrWWVhciA9IGRmbCh3LmdnLCBjb25maWcuX2FbWUVBUl0sIHdlZWtPZlllYXIobW9tZW50KCksIGRvdywgZG95KS55ZWFyKTsKICAgICAgICAgICAgd2VlayA9IGRmbCh3LncsIDEpOwoKICAgICAgICAgICAgaWYgKHcuZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAvLyB3ZWVrZGF5IC0tIGxvdyBkYXkgbnVtYmVycyBhcmUgY29uc2lkZXJlZCBuZXh0IHdlZWsKICAgICAgICAgICAgICAgIHdlZWtkYXkgPSB3LmQ7CiAgICAgICAgICAgICAgICBpZiAod2Vla2RheSA8IGRvdykgewogICAgICAgICAgICAgICAgICAgICsrd2VlazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh3LmUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgLy8gbG9jYWwgd2Vla2RheSAtLSBjb3VudGluZyBzdGFydHMgZnJvbSBiZWdpbmluZyBvZiB3ZWVrCiAgICAgICAgICAgICAgICB3ZWVrZGF5ID0gdy5lICsgZG93OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gZGVmYXVsdCB0byBiZWdpbmluZyBvZiB3ZWVrCiAgICAgICAgICAgICAgICB3ZWVrZGF5ID0gZG93OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRlbXAgPSBkYXlPZlllYXJGcm9tV2Vla3Mod2Vla1llYXIsIHdlZWssIHdlZWtkYXksIGRveSwgZG93KTsKCiAgICAgICAgY29uZmlnLl9hW1lFQVJdID0gdGVtcC55ZWFyOwogICAgICAgIGNvbmZpZy5fZGF5T2ZZZWFyID0gdGVtcC5kYXlPZlllYXI7CiAgICB9CgogICAgLy8gY29udmVydCBhbiBhcnJheSB0byBhIGRhdGUuCiAgICAvLyB0aGUgYXJyYXkgc2hvdWxkIG1pcnJvciB0aGUgcGFyYW1ldGVycyBiZWxvdwogICAgLy8gbm90ZTogYWxsIHZhbHVlcyBwYXN0IHRoZSB5ZWFyIGFyZSBvcHRpb25hbCBhbmQgd2lsbCBkZWZhdWx0IHRvIHRoZSBsb3dlc3QgcG9zc2libGUgdmFsdWUuCiAgICAvLyBbeWVhciwgbW9udGgsIGRheSAsIGhvdXIsIG1pbnV0ZSwgc2Vjb25kLCBtaWxsaXNlY29uZF0KICAgIGZ1bmN0aW9uIGRhdGVGcm9tQ29uZmlnKGNvbmZpZykgewogICAgICAgIHZhciBpLCBkYXRlLCBpbnB1dCA9IFtdLCBjdXJyZW50RGF0ZSwgeWVhclRvVXNlOwoKICAgICAgICBpZiAoY29uZmlnLl9kKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGN1cnJlbnREYXRlID0gY3VycmVudERhdGVBcnJheShjb25maWcpOwoKICAgICAgICAvL2NvbXB1dGUgZGF5IG9mIHRoZSB5ZWFyIGZyb20gd2Vla3MgYW5kIHdlZWtkYXlzCiAgICAgICAgaWYgKGNvbmZpZy5fdyAmJiBjb25maWcuX2FbREFURV0gPT0gbnVsbCAmJiBjb25maWcuX2FbTU9OVEhdID09IG51bGwpIHsKICAgICAgICAgICAgZGF5T2ZZZWFyRnJvbVdlZWtJbmZvKGNvbmZpZyk7CiAgICAgICAgfQoKICAgICAgICAvL2lmIHRoZSBkYXkgb2YgdGhlIHllYXIgaXMgc2V0LCBmaWd1cmUgb3V0IHdoYXQgaXQgaXMKICAgICAgICBpZiAoY29uZmlnLl9kYXlPZlllYXIpIHsKICAgICAgICAgICAgeWVhclRvVXNlID0gZGZsKGNvbmZpZy5fYVtZRUFSXSwgY3VycmVudERhdGVbWUVBUl0pOwoKICAgICAgICAgICAgaWYgKGNvbmZpZy5fZGF5T2ZZZWFyID4gZGF5c0luWWVhcih5ZWFyVG9Vc2UpKSB7CiAgICAgICAgICAgICAgICBjb25maWcuX3BmLl9vdmVyZmxvd0RheU9mWWVhciA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRhdGUgPSBtYWtlVVRDRGF0ZSh5ZWFyVG9Vc2UsIDAsIGNvbmZpZy5fZGF5T2ZZZWFyKTsKICAgICAgICAgICAgY29uZmlnLl9hW01PTlRIXSA9IGRhdGUuZ2V0VVRDTW9udGgoKTsKICAgICAgICAgICAgY29uZmlnLl9hW0RBVEVdID0gZGF0ZS5nZXRVVENEYXRlKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBEZWZhdWx0IHRvIGN1cnJlbnQgZGF0ZS4KICAgICAgICAvLyAqIGlmIG5vIHllYXIsIG1vbnRoLCBkYXkgb2YgbW9udGggYXJlIGdpdmVuLCBkZWZhdWx0IHRvIHRvZGF5CiAgICAgICAgLy8gKiBpZiBkYXkgb2YgbW9udGggaXMgZ2l2ZW4sIGRlZmF1bHQgbW9udGggYW5kIHllYXIKICAgICAgICAvLyAqIGlmIG1vbnRoIGlzIGdpdmVuLCBkZWZhdWx0IG9ubHkgeWVhcgogICAgICAgIC8vICogaWYgeWVhciBpcyBnaXZlbiwgZG9uJ3QgZGVmYXVsdCBhbnl0aGluZwogICAgICAgIGZvciAoaSA9IDA7IGkgPCAzICYmIGNvbmZpZy5fYVtpXSA9PSBudWxsOyArK2kpIHsKICAgICAgICAgICAgY29uZmlnLl9hW2ldID0gaW5wdXRbaV0gPSBjdXJyZW50RGF0ZVtpXTsKICAgICAgICB9CgogICAgICAgIC8vIFplcm8gb3V0IHdoYXRldmVyIHdhcyBub3QgZGVmYXVsdGVkLCBpbmNsdWRpbmcgdGltZQogICAgICAgIGZvciAoOyBpIDwgNzsgaSsrKSB7CiAgICAgICAgICAgIGNvbmZpZy5fYVtpXSA9IGlucHV0W2ldID0gKGNvbmZpZy5fYVtpXSA9PSBudWxsKSA/IChpID09PSAyID8gMSA6IDApIDogY29uZmlnLl9hW2ldOwogICAgICAgIH0KCiAgICAgICAgY29uZmlnLl9kID0gKGNvbmZpZy5fdXNlVVRDID8gbWFrZVVUQ0RhdGUgOiBtYWtlRGF0ZSkuYXBwbHkobnVsbCwgaW5wdXQpOwogICAgICAgIC8vIEFwcGx5IHRpbWV6b25lIG9mZnNldCBmcm9tIGlucHV0LiBUaGUgYWN0dWFsIHpvbmUgY2FuIGJlIGNoYW5nZWQKICAgICAgICAvLyB3aXRoIHBhcnNlWm9uZS4KICAgICAgICBpZiAoY29uZmlnLl90em0gIT0gbnVsbCkgewogICAgICAgICAgICBjb25maWcuX2Quc2V0VVRDTWludXRlcyhjb25maWcuX2QuZ2V0VVRDTWludXRlcygpICsgY29uZmlnLl90em0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBkYXRlRnJvbU9iamVjdChjb25maWcpIHsKICAgICAgICB2YXIgbm9ybWFsaXplZElucHV0OwoKICAgICAgICBpZiAoY29uZmlnLl9kKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIG5vcm1hbGl6ZWRJbnB1dCA9IG5vcm1hbGl6ZU9iamVjdFVuaXRzKGNvbmZpZy5faSk7CiAgICAgICAgY29uZmlnLl9hID0gWwogICAgICAgICAgICBub3JtYWxpemVkSW5wdXQueWVhciwKICAgICAgICAgICAgbm9ybWFsaXplZElucHV0Lm1vbnRoLAogICAgICAgICAgICBub3JtYWxpemVkSW5wdXQuZGF5LAogICAgICAgICAgICBub3JtYWxpemVkSW5wdXQuaG91ciwKICAgICAgICAgICAgbm9ybWFsaXplZElucHV0Lm1pbnV0ZSwKICAgICAgICAgICAgbm9ybWFsaXplZElucHV0LnNlY29uZCwKICAgICAgICAgICAgbm9ybWFsaXplZElucHV0Lm1pbGxpc2Vjb25kCiAgICAgICAgXTsKCiAgICAgICAgZGF0ZUZyb21Db25maWcoY29uZmlnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjdXJyZW50RGF0ZUFycmF5KGNvbmZpZykgewogICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpOwogICAgICAgIGlmIChjb25maWcuX3VzZVVUQykgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgbm93LmdldFVUQ0Z1bGxZZWFyKCksCiAgICAgICAgICAgICAgICBub3cuZ2V0VVRDTW9udGgoKSwKICAgICAgICAgICAgICAgIG5vdy5nZXRVVENEYXRlKCkKICAgICAgICAgICAgXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gW25vdy5nZXRGdWxsWWVhcigpLCBub3cuZ2V0TW9udGgoKSwgbm93LmdldERhdGUoKV07CiAgICAgICAgfQogICAgfQoKICAgIC8vIGRhdGUgZnJvbSBzdHJpbmcgYW5kIGZvcm1hdCBzdHJpbmcKICAgIGZ1bmN0aW9uIG1ha2VEYXRlRnJvbVN0cmluZ0FuZEZvcm1hdChjb25maWcpIHsKICAgICAgICBpZiAoY29uZmlnLl9mID09PSBtb21lbnQuSVNPXzg2MDEpIHsKICAgICAgICAgICAgcGFyc2VJU08oY29uZmlnKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uZmlnLl9hID0gW107CiAgICAgICAgY29uZmlnLl9wZi5lbXB0eSA9IHRydWU7CgogICAgICAgIC8vIFRoaXMgYXJyYXkgaXMgdXNlZCB0byBtYWtlIGEgRGF0ZSwgZWl0aGVyIHdpdGggYG5ldyBEYXRlYCBvciBgRGF0ZS5VVENgCiAgICAgICAgdmFyIHN0cmluZyA9ICcnICsgY29uZmlnLl9pLAogICAgICAgICAgICBpLCBwYXJzZWRJbnB1dCwgdG9rZW5zLCB0b2tlbiwgc2tpcHBlZCwKICAgICAgICAgICAgc3RyaW5nTGVuZ3RoID0gc3RyaW5nLmxlbmd0aCwKICAgICAgICAgICAgdG90YWxQYXJzZWRJbnB1dExlbmd0aCA9IDA7CgogICAgICAgIHRva2VucyA9IGV4cGFuZEZvcm1hdChjb25maWcuX2YsIGNvbmZpZy5fbG9jYWxlKS5tYXRjaChmb3JtYXR0aW5nVG9rZW5zKSB8fCBbXTsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRva2Vucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0b2tlbiA9IHRva2Vuc1tpXTsKICAgICAgICAgICAgcGFyc2VkSW5wdXQgPSAoc3RyaW5nLm1hdGNoKGdldFBhcnNlUmVnZXhGb3JUb2tlbih0b2tlbiwgY29uZmlnKSkgfHwgW10pWzBdOwogICAgICAgICAgICBpZiAocGFyc2VkSW5wdXQpIHsKICAgICAgICAgICAgICAgIHNraXBwZWQgPSBzdHJpbmcuc3Vic3RyKDAsIHN0cmluZy5pbmRleE9mKHBhcnNlZElucHV0KSk7CiAgICAgICAgICAgICAgICBpZiAoc2tpcHBlZC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLl9wZi51bnVzZWRJbnB1dC5wdXNoKHNraXBwZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnNsaWNlKHN0cmluZy5pbmRleE9mKHBhcnNlZElucHV0KSArIHBhcnNlZElucHV0Lmxlbmd0aCk7CiAgICAgICAgICAgICAgICB0b3RhbFBhcnNlZElucHV0TGVuZ3RoICs9IHBhcnNlZElucHV0Lmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBkb24ndCBwYXJzZSBpZiBpdCdzIG5vdCBhIGtub3duIHRva2VuCiAgICAgICAgICAgIGlmIChmb3JtYXRUb2tlbkZ1bmN0aW9uc1t0b2tlbl0pIHsKICAgICAgICAgICAgICAgIGlmIChwYXJzZWRJbnB1dCkgewogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5fcGYuZW1wdHkgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5fcGYudW51c2VkVG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYWRkVGltZVRvQXJyYXlGcm9tVG9rZW4odG9rZW4sIHBhcnNlZElucHV0LCBjb25maWcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGNvbmZpZy5fc3RyaWN0ICYmICFwYXJzZWRJbnB1dCkgewogICAgICAgICAgICAgICAgY29uZmlnLl9wZi51bnVzZWRUb2tlbnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIGFkZCByZW1haW5pbmcgdW5wYXJzZWQgaW5wdXQgbGVuZ3RoIHRvIHRoZSBzdHJpbmcKICAgICAgICBjb25maWcuX3BmLmNoYXJzTGVmdE92ZXIgPSBzdHJpbmdMZW5ndGggLSB0b3RhbFBhcnNlZElucHV0TGVuZ3RoOwogICAgICAgIGlmIChzdHJpbmcubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25maWcuX3BmLnVudXNlZElucHV0LnB1c2goc3RyaW5nKTsKICAgICAgICB9CgogICAgICAgIC8vIGhhbmRsZSBhbSBwbQogICAgICAgIGlmIChjb25maWcuX2lzUG0gJiYgY29uZmlnLl9hW0hPVVJdIDwgMTIpIHsKICAgICAgICAgICAgY29uZmlnLl9hW0hPVVJdICs9IDEyOwogICAgICAgIH0KICAgICAgICAvLyBpZiBpcyAxMiBhbSwgY2hhbmdlIGhvdXJzIHRvIDAKICAgICAgICBpZiAoY29uZmlnLl9pc1BtID09PSBmYWxzZSAmJiBjb25maWcuX2FbSE9VUl0gPT09IDEyKSB7CiAgICAgICAgICAgIGNvbmZpZy5fYVtIT1VSXSA9IDA7CiAgICAgICAgfQoKICAgICAgICBkYXRlRnJvbUNvbmZpZyhjb25maWcpOwogICAgICAgIGNoZWNrT3ZlcmZsb3coY29uZmlnKTsKICAgIH0KCiAgICBmdW5jdGlvbiB1bmVzY2FwZUZvcm1hdChzKSB7CiAgICAgICAgcmV0dXJuIHMucmVwbGFjZSgvXFwoXFspfFxcKFxdKXxcWyhbXlxdXFtdKilcXXxcXCguKS9nLCBmdW5jdGlvbiAobWF0Y2hlZCwgcDEsIHAyLCBwMywgcDQpIHsKICAgICAgICAgICAgcmV0dXJuIHAxIHx8IHAyIHx8IHAzIHx8IHA0OwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIENvZGUgZnJvbSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzM1NjE0OTMvaXMtdGhlcmUtYS1yZWdleHAtZXNjYXBlLWZ1bmN0aW9uLWluLWphdmFzY3JpcHQKICAgIGZ1bmN0aW9uIHJlZ2V4cEVzY2FwZShzKSB7CiAgICAgICAgcmV0dXJuIHMucmVwbGFjZSgvWy1cL1xcXiQqKz8uKCl8W1xde31dL2csICdcXCQmJyk7CiAgICB9CgogICAgLy8gZGF0ZSBmcm9tIHN0cmluZyBhbmQgYXJyYXkgb2YgZm9ybWF0IHN0cmluZ3MKICAgIGZ1bmN0aW9uIG1ha2VEYXRlRnJvbVN0cmluZ0FuZEFycmF5KGNvbmZpZykgewogICAgICAgIHZhciB0ZW1wQ29uZmlnLAogICAgICAgICAgICBiZXN0TW9tZW50LAoKICAgICAgICAgICAgc2NvcmVUb0JlYXQsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIGN1cnJlbnRTY29yZTsKCiAgICAgICAgaWYgKGNvbmZpZy5fZi5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgY29uZmlnLl9wZi5pbnZhbGlkRm9ybWF0ID0gdHJ1ZTsKICAgICAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoTmFOKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvbmZpZy5fZi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjdXJyZW50U2NvcmUgPSAwOwogICAgICAgICAgICB0ZW1wQ29uZmlnID0gY29weUNvbmZpZyh7fSwgY29uZmlnKTsKICAgICAgICAgICAgaWYgKGNvbmZpZy5fdXNlVVRDICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRlbXBDb25maWcuX3VzZVVUQyA9IGNvbmZpZy5fdXNlVVRDOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRlbXBDb25maWcuX3BmID0gZGVmYXVsdFBhcnNpbmdGbGFncygpOwogICAgICAgICAgICB0ZW1wQ29uZmlnLl9mID0gY29uZmlnLl9mW2ldOwogICAgICAgICAgICBtYWtlRGF0ZUZyb21TdHJpbmdBbmRGb3JtYXQodGVtcENvbmZpZyk7CgogICAgICAgICAgICBpZiAoIWlzVmFsaWQodGVtcENvbmZpZykpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiB0aGVyZSBpcyBhbnkgaW5wdXQgdGhhdCB3YXMgbm90IHBhcnNlZCBhZGQgYSBwZW5hbHR5IGZvciB0aGF0IGZvcm1hdAogICAgICAgICAgICBjdXJyZW50U2NvcmUgKz0gdGVtcENvbmZpZy5fcGYuY2hhcnNMZWZ0T3ZlcjsKCiAgICAgICAgICAgIC8vb3IgdG9rZW5zCiAgICAgICAgICAgIGN1cnJlbnRTY29yZSArPSB0ZW1wQ29uZmlnLl9wZi51bnVzZWRUb2tlbnMubGVuZ3RoICogMTA7CgogICAgICAgICAgICB0ZW1wQ29uZmlnLl9wZi5zY29yZSA9IGN1cnJlbnRTY29yZTsKCiAgICAgICAgICAgIGlmIChzY29yZVRvQmVhdCA9PSBudWxsIHx8IGN1cnJlbnRTY29yZSA8IHNjb3JlVG9CZWF0KSB7CiAgICAgICAgICAgICAgICBzY29yZVRvQmVhdCA9IGN1cnJlbnRTY29yZTsKICAgICAgICAgICAgICAgIGJlc3RNb21lbnQgPSB0ZW1wQ29uZmlnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBleHRlbmQoY29uZmlnLCBiZXN0TW9tZW50IHx8IHRlbXBDb25maWcpOwogICAgfQoKICAgIC8vIGRhdGUgZnJvbSBpc28gZm9ybWF0CiAgICBmdW5jdGlvbiBwYXJzZUlTTyhjb25maWcpIHsKICAgICAgICB2YXIgaSwgbCwKICAgICAgICAgICAgc3RyaW5nID0gY29uZmlnLl9pLAogICAgICAgICAgICBtYXRjaCA9IGlzb1JlZ2V4LmV4ZWMoc3RyaW5nKTsKCiAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIGNvbmZpZy5fcGYuaXNvID0gdHJ1ZTsKICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IGlzb0RhdGVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGlzb0RhdGVzW2ldWzFdLmV4ZWMoc3RyaW5nKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG1hdGNoWzVdIHNob3VsZCBiZSAnVCcgb3IgdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgY29uZmlnLl9mID0gaXNvRGF0ZXNbaV1bMF0gKyAobWF0Y2hbNl0gfHwgJyAnKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gaXNvVGltZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNvVGltZXNbaV1bMV0uZXhlYyhzdHJpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLl9mICs9IGlzb1RpbWVzW2ldWzBdOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdHJpbmcubWF0Y2gocGFyc2VUb2tlblRpbWV6b25lKSkgewogICAgICAgICAgICAgICAgY29uZmlnLl9mICs9ICdaJzsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYWtlRGF0ZUZyb21TdHJpbmdBbmRGb3JtYXQoY29uZmlnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWcuX2lzVmFsaWQgPSBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgLy8gZGF0ZSBmcm9tIGlzbyBmb3JtYXQgb3IgZmFsbGJhY2sKICAgIGZ1bmN0aW9uIG1ha2VEYXRlRnJvbVN0cmluZyhjb25maWcpIHsKICAgICAgICBwYXJzZUlTTyhjb25maWcpOwogICAgICAgIGlmIChjb25maWcuX2lzVmFsaWQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGRlbGV0ZSBjb25maWcuX2lzVmFsaWQ7CiAgICAgICAgICAgIG1vbWVudC5jcmVhdGVGcm9tSW5wdXRGYWxsYmFjayhjb25maWcpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBtYXAoYXJyLCBmbikgewogICAgICAgIHZhciByZXMgPSBbXSwgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIHJlcy5wdXNoKGZuKGFycltpXSwgaSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzOwogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VEYXRlRnJvbUlucHV0KGNvbmZpZykgewogICAgICAgIHZhciBpbnB1dCA9IGNvbmZpZy5faSwgbWF0Y2hlZDsKICAgICAgICBpZiAoaW5wdXQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZSgpOwogICAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKGlucHV0KSkgewogICAgICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZSgraW5wdXQpOwogICAgICAgIH0gZWxzZSBpZiAoKG1hdGNoZWQgPSBhc3BOZXRKc29uUmVnZXguZXhlYyhpbnB1dCkpICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbmZpZy5fZCA9IG5ldyBEYXRlKCttYXRjaGVkWzFdKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgbWFrZURhdGVGcm9tU3RyaW5nKGNvbmZpZyk7CiAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KGlucHV0KSkgewogICAgICAgICAgICBjb25maWcuX2EgPSBtYXAoaW5wdXQuc2xpY2UoMCksIGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUludChvYmosIDEwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRhdGVGcm9tQ29uZmlnKGNvbmZpZyk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YoaW5wdXQpID09PSAnb2JqZWN0JykgewogICAgICAgICAgICBkYXRlRnJvbU9iamVjdChjb25maWcpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mKGlucHV0KSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgLy8gZnJvbSBtaWxsaXNlY29uZHMKICAgICAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoaW5wdXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1vbWVudC5jcmVhdGVGcm9tSW5wdXRGYWxsYmFjayhjb25maWcpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBtYWtlRGF0ZSh5LCBtLCBkLCBoLCBNLCBzLCBtcykgewogICAgICAgIC8vY2FuJ3QganVzdCBhcHBseSgpIHRvIGNyZWF0ZSBhIGRhdGU6CiAgICAgICAgLy9odHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzE4MTM0OC9pbnN0YW50aWF0aW5nLWEtamF2YXNjcmlwdC1vYmplY3QtYnktY2FsbGluZy1wcm90b3R5cGUtY29uc3RydWN0b3ItYXBwbHkKICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKHksIG0sIGQsIGgsIE0sIHMsIG1zKTsKCiAgICAgICAgLy90aGUgZGF0ZSBjb25zdHJ1Y3RvciBkb2Vzbid0IGFjY2VwdCB5ZWFycyA8IDE5NzAKICAgICAgICBpZiAoeSA8IDE5NzApIHsKICAgICAgICAgICAgZGF0ZS5zZXRGdWxsWWVhcih5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRhdGU7CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZVVUQ0RhdGUoeSkgewogICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoRGF0ZS5VVEMuYXBwbHkobnVsbCwgYXJndW1lbnRzKSk7CiAgICAgICAgaWYgKHkgPCAxOTcwKSB7CiAgICAgICAgICAgIGRhdGUuc2V0VVRDRnVsbFllYXIoeSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkYXRlOwogICAgfQoKICAgIGZ1bmN0aW9uIHBhcnNlV2Vla2RheShpbnB1dCwgbG9jYWxlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgaWYgKCFpc05hTihpbnB1dCkpIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gcGFyc2VJbnQoaW5wdXQsIDEwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gbG9jYWxlLndlZWtkYXlzUGFyc2UoaW5wdXQpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gaW5wdXQ7CiAgICB9CgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIFJlbGF0aXZlIFRpbWUKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgLy8gaGVscGVyIGZ1bmN0aW9uIGZvciBtb21lbnQuZm4uZnJvbSwgbW9tZW50LmZuLmZyb21Ob3csIGFuZCBtb21lbnQuZHVyYXRpb24uZm4uaHVtYW5pemUKICAgIGZ1bmN0aW9uIHN1YnN0aXR1dGVUaW1lQWdvKHN0cmluZywgbnVtYmVyLCB3aXRob3V0U3VmZml4LCBpc0Z1dHVyZSwgbG9jYWxlKSB7CiAgICAgICAgcmV0dXJuIGxvY2FsZS5yZWxhdGl2ZVRpbWUobnVtYmVyIHx8IDEsICEhd2l0aG91dFN1ZmZpeCwgc3RyaW5nLCBpc0Z1dHVyZSk7CiAgICB9CgogICAgZnVuY3Rpb24gcmVsYXRpdmVUaW1lKHBvc05lZ0R1cmF0aW9uLCB3aXRob3V0U3VmZml4LCBsb2NhbGUpIHsKICAgICAgICB2YXIgZHVyYXRpb24gPSBtb21lbnQuZHVyYXRpb24ocG9zTmVnRHVyYXRpb24pLmFicygpLAogICAgICAgICAgICBzZWNvbmRzID0gcm91bmQoZHVyYXRpb24uYXMoJ3MnKSksCiAgICAgICAgICAgIG1pbnV0ZXMgPSByb3VuZChkdXJhdGlvbi5hcygnbScpKSwKICAgICAgICAgICAgaG91cnMgPSByb3VuZChkdXJhdGlvbi5hcygnaCcpKSwKICAgICAgICAgICAgZGF5cyA9IHJvdW5kKGR1cmF0aW9uLmFzKCdkJykpLAogICAgICAgICAgICBtb250aHMgPSByb3VuZChkdXJhdGlvbi5hcygnTScpKSwKICAgICAgICAgICAgeWVhcnMgPSByb3VuZChkdXJhdGlvbi5hcygneScpKSwKCiAgICAgICAgICAgIGFyZ3MgPSBzZWNvbmRzIDwgcmVsYXRpdmVUaW1lVGhyZXNob2xkcy5zICYmIFsncycsIHNlY29uZHNdIHx8CiAgICAgICAgICAgICAgICBtaW51dGVzID09PSAxICYmIFsnbSddIHx8CiAgICAgICAgICAgICAgICBtaW51dGVzIDwgcmVsYXRpdmVUaW1lVGhyZXNob2xkcy5tICYmIFsnbW0nLCBtaW51dGVzXSB8fAogICAgICAgICAgICAgICAgaG91cnMgPT09IDEgJiYgWydoJ10gfHwKICAgICAgICAgICAgICAgIGhvdXJzIDwgcmVsYXRpdmVUaW1lVGhyZXNob2xkcy5oICYmIFsnaGgnLCBob3Vyc10gfHwKICAgICAgICAgICAgICAgIGRheXMgPT09IDEgJiYgWydkJ10gfHwKICAgICAgICAgICAgICAgIGRheXMgPCByZWxhdGl2ZVRpbWVUaHJlc2hvbGRzLmQgJiYgWydkZCcsIGRheXNdIHx8CiAgICAgICAgICAgICAgICBtb250aHMgPT09IDEgJiYgWydNJ10gfHwKICAgICAgICAgICAgICAgIG1vbnRocyA8IHJlbGF0aXZlVGltZVRocmVzaG9sZHMuTSAmJiBbJ01NJywgbW9udGhzXSB8fAogICAgICAgICAgICAgICAgeWVhcnMgPT09IDEgJiYgWyd5J10gfHwgWyd5eScsIHllYXJzXTsKCiAgICAgICAgYXJnc1syXSA9IHdpdGhvdXRTdWZmaXg7CiAgICAgICAgYXJnc1szXSA9ICtwb3NOZWdEdXJhdGlvbiA+IDA7CiAgICAgICAgYXJnc1s0XSA9IGxvY2FsZTsKICAgICAgICByZXR1cm4gc3Vic3RpdHV0ZVRpbWVBZ28uYXBwbHkoe30sIGFyZ3MpOwogICAgfQoKCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgV2VlayBvZiBZZWFyCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoKICAgIC8vIGZpcnN0RGF5T2ZXZWVrICAgICAgIDAgPSBzdW4sIDYgPSBzYXQKICAgIC8vICAgICAgICAgICAgICAgICAgICAgIHRoZSBkYXkgb2YgdGhlIHdlZWsgdGhhdCBzdGFydHMgdGhlIHdlZWsKICAgIC8vICAgICAgICAgICAgICAgICAgICAgICh1c3VhbGx5IHN1bmRheSBvciBtb25kYXkpCiAgICAvLyBmaXJzdERheU9mV2Vla09mWWVhciAwID0gc3VuLCA2ID0gc2F0CiAgICAvLyAgICAgICAgICAgICAgICAgICAgICB0aGUgZmlyc3Qgd2VlayBpcyB0aGUgd2VlayB0aGF0IGNvbnRhaW5zIHRoZSBmaXJzdAogICAgLy8gICAgICAgICAgICAgICAgICAgICAgb2YgdGhpcyBkYXkgb2YgdGhlIHdlZWsKICAgIC8vICAgICAgICAgICAgICAgICAgICAgIChlZy4gSVNPIHdlZWtzIHVzZSB0aHVyc2RheSAoNCkpCiAgICBmdW5jdGlvbiB3ZWVrT2ZZZWFyKG1vbSwgZmlyc3REYXlPZldlZWssIGZpcnN0RGF5T2ZXZWVrT2ZZZWFyKSB7CiAgICAgICAgdmFyIGVuZCA9IGZpcnN0RGF5T2ZXZWVrT2ZZZWFyIC0gZmlyc3REYXlPZldlZWssCiAgICAgICAgICAgIGRheXNUb0RheU9mV2VlayA9IGZpcnN0RGF5T2ZXZWVrT2ZZZWFyIC0gbW9tLmRheSgpLAogICAgICAgICAgICBhZGp1c3RlZE1vbWVudDsKCgogICAgICAgIGlmIChkYXlzVG9EYXlPZldlZWsgPiBlbmQpIHsKICAgICAgICAgICAgZGF5c1RvRGF5T2ZXZWVrIC09IDc7CiAgICAgICAgfQoKICAgICAgICBpZiAoZGF5c1RvRGF5T2ZXZWVrIDwgZW5kIC0gNykgewogICAgICAgICAgICBkYXlzVG9EYXlPZldlZWsgKz0gNzsKICAgICAgICB9CgogICAgICAgIGFkanVzdGVkTW9tZW50ID0gbW9tZW50KG1vbSkuYWRkKGRheXNUb0RheU9mV2VlaywgJ2QnKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB3ZWVrOiBNYXRoLmNlaWwoYWRqdXN0ZWRNb21lbnQuZGF5T2ZZZWFyKCkgLyA3KSwKICAgICAgICAgICAgeWVhcjogYWRqdXN0ZWRNb21lbnQueWVhcigpCiAgICAgICAgfTsKICAgIH0KCiAgICAvL2h0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSVNPX3dlZWtfZGF0ZSNDYWxjdWxhdGluZ19hX2RhdGVfZ2l2ZW5fdGhlX3llYXIuMkNfd2Vla19udW1iZXJfYW5kX3dlZWtkYXkKICAgIGZ1bmN0aW9uIGRheU9mWWVhckZyb21XZWVrcyh5ZWFyLCB3ZWVrLCB3ZWVrZGF5LCBmaXJzdERheU9mV2Vla09mWWVhciwgZmlyc3REYXlPZldlZWspIHsKICAgICAgICB2YXIgZCA9IG1ha2VVVENEYXRlKHllYXIsIDAsIDEpLmdldFVUQ0RheSgpLCBkYXlzVG9BZGQsIGRheU9mWWVhcjsKCiAgICAgICAgZCA9IGQgPT09IDAgPyA3IDogZDsKICAgICAgICB3ZWVrZGF5ID0gd2Vla2RheSAhPSBudWxsID8gd2Vla2RheSA6IGZpcnN0RGF5T2ZXZWVrOwogICAgICAgIGRheXNUb0FkZCA9IGZpcnN0RGF5T2ZXZWVrIC0gZCArIChkID4gZmlyc3REYXlPZldlZWtPZlllYXIgPyA3IDogMCkgLSAoZCA8IGZpcnN0RGF5T2ZXZWVrID8gNyA6IDApOwogICAgICAgIGRheU9mWWVhciA9IDcgKiAod2VlayAtIDEpICsgKHdlZWtkYXkgLSBmaXJzdERheU9mV2VlaykgKyBkYXlzVG9BZGQgKyAxOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB5ZWFyOiBkYXlPZlllYXIgPiAwID8geWVhciA6IHllYXIgLSAxLAogICAgICAgICAgICBkYXlPZlllYXI6IGRheU9mWWVhciA+IDAgPyAgZGF5T2ZZZWFyIDogZGF5c0luWWVhcih5ZWFyIC0gMSkgKyBkYXlPZlllYXIKICAgICAgICB9OwogICAgfQoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBUb3AgTGV2ZWwgRnVuY3Rpb25zCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgogICAgZnVuY3Rpb24gbWFrZU1vbWVudChjb25maWcpIHsKICAgICAgICB2YXIgaW5wdXQgPSBjb25maWcuX2ksCiAgICAgICAgICAgIGZvcm1hdCA9IGNvbmZpZy5fZjsKCiAgICAgICAgY29uZmlnLl9sb2NhbGUgPSBjb25maWcuX2xvY2FsZSB8fCBtb21lbnQubG9jYWxlRGF0YShjb25maWcuX2wpOwoKICAgICAgICBpZiAoaW5wdXQgPT09IG51bGwgfHwgKGZvcm1hdCA9PT0gdW5kZWZpbmVkICYmIGlucHV0ID09PSAnJykpIHsKICAgICAgICAgICAgcmV0dXJuIG1vbWVudC5pbnZhbGlkKHtudWxsSW5wdXQ6IHRydWV9KTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGNvbmZpZy5faSA9IGlucHV0ID0gY29uZmlnLl9sb2NhbGUucHJlcGFyc2UoaW5wdXQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKG1vbWVudC5pc01vbWVudChpbnB1dCkpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBNb21lbnQoaW5wdXQsIHRydWUpOwogICAgICAgIH0gZWxzZSBpZiAoZm9ybWF0KSB7CiAgICAgICAgICAgIGlmIChpc0FycmF5KGZvcm1hdCkpIHsKICAgICAgICAgICAgICAgIG1ha2VEYXRlRnJvbVN0cmluZ0FuZEFycmF5KGNvbmZpZyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtYWtlRGF0ZUZyb21TdHJpbmdBbmRGb3JtYXQoY29uZmlnKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1ha2VEYXRlRnJvbUlucHV0KGNvbmZpZyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbmV3IE1vbWVudChjb25maWcpOwogICAgfQoKICAgIG1vbWVudCA9IGZ1bmN0aW9uIChpbnB1dCwgZm9ybWF0LCBsb2NhbGUsIHN0cmljdCkgewogICAgICAgIHZhciBjOwoKICAgICAgICBpZiAodHlwZW9mKGxvY2FsZSkgPT09ICdib29sZWFuJykgewogICAgICAgICAgICBzdHJpY3QgPSBsb2NhbGU7CiAgICAgICAgICAgIGxvY2FsZSA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgICAgLy8gb2JqZWN0IGNvbnN0cnVjdGlvbiBtdXN0IGJlIGRvbmUgdGhpcyB3YXkuCiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudC9tb21lbnQvaXNzdWVzLzE0MjMKICAgICAgICBjID0ge307CiAgICAgICAgYy5faXNBTW9tZW50T2JqZWN0ID0gdHJ1ZTsKICAgICAgICBjLl9pID0gaW5wdXQ7CiAgICAgICAgYy5fZiA9IGZvcm1hdDsKICAgICAgICBjLl9sID0gbG9jYWxlOwogICAgICAgIGMuX3N0cmljdCA9IHN0cmljdDsKICAgICAgICBjLl9pc1VUQyA9IGZhbHNlOwogICAgICAgIGMuX3BmID0gZGVmYXVsdFBhcnNpbmdGbGFncygpOwoKICAgICAgICByZXR1cm4gbWFrZU1vbWVudChjKTsKICAgIH07CgogICAgbW9tZW50LnN1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5ncyA9IGZhbHNlOwoKICAgIG1vbWVudC5jcmVhdGVGcm9tSW5wdXRGYWxsYmFjayA9IGRlcHJlY2F0ZSgKICAgICAgICAnbW9tZW50IGNvbnN0cnVjdGlvbiBmYWxscyBiYWNrIHRvIGpzIERhdGUuIFRoaXMgaXMgJyArCiAgICAgICAgJ2Rpc2NvdXJhZ2VkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdXBjb21pbmcgbWFqb3IgJyArCiAgICAgICAgJ3JlbGVhc2UuIFBsZWFzZSByZWZlciB0byAnICsKICAgICAgICAnaHR0cHM6Ly9naXRodWIuY29tL21vbWVudC9tb21lbnQvaXNzdWVzLzE0MDcgZm9yIG1vcmUgaW5mby4nLAogICAgICAgIGZ1bmN0aW9uIChjb25maWcpIHsKICAgICAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoY29uZmlnLl9pKTsKICAgICAgICB9CiAgICApOwoKICAgIC8vIFBpY2sgYSBtb21lbnQgbSBmcm9tIG1vbWVudHMgc28gdGhhdCBtW2ZuXShvdGhlcikgaXMgdHJ1ZSBmb3IgYWxsCiAgICAvLyBvdGhlci4gVGhpcyByZWxpZXMgb24gdGhlIGZ1bmN0aW9uIGZuIHRvIGJlIHRyYW5zaXRpdmUuCiAgICAvLwogICAgLy8gbW9tZW50cyBzaG91bGQgZWl0aGVyIGJlIGFuIGFycmF5IG9mIG1vbWVudCBvYmplY3RzIG9yIGFuIGFycmF5LCB3aG9zZQogICAgLy8gZmlyc3QgZWxlbWVudCBpcyBhbiBhcnJheSBvZiBtb21lbnQgb2JqZWN0cy4KICAgIGZ1bmN0aW9uIHBpY2tCeShmbiwgbW9tZW50cykgewogICAgICAgIHZhciByZXMsIGk7CiAgICAgICAgaWYgKG1vbWVudHMubGVuZ3RoID09PSAxICYmIGlzQXJyYXkobW9tZW50c1swXSkpIHsKICAgICAgICAgICAgbW9tZW50cyA9IG1vbWVudHNbMF07CiAgICAgICAgfQogICAgICAgIGlmICghbW9tZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIG1vbWVudCgpOwogICAgICAgIH0KICAgICAgICByZXMgPSBtb21lbnRzWzBdOwogICAgICAgIGZvciAoaSA9IDE7IGkgPCBtb21lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGlmIChtb21lbnRzW2ldW2ZuXShyZXMpKSB7CiAgICAgICAgICAgICAgICByZXMgPSBtb21lbnRzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXM7CiAgICB9CgogICAgbW9tZW50Lm1pbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgYXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKCiAgICAgICAgcmV0dXJuIHBpY2tCeSgnaXNCZWZvcmUnLCBhcmdzKTsKICAgIH07CgogICAgbW9tZW50Lm1heCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgYXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKCiAgICAgICAgcmV0dXJuIHBpY2tCeSgnaXNBZnRlcicsIGFyZ3MpOwogICAgfTsKCiAgICAvLyBjcmVhdGluZyB3aXRoIHV0YwogICAgbW9tZW50LnV0YyA9IGZ1bmN0aW9uIChpbnB1dCwgZm9ybWF0LCBsb2NhbGUsIHN0cmljdCkgewogICAgICAgIHZhciBjOwoKICAgICAgICBpZiAodHlwZW9mKGxvY2FsZSkgPT09ICdib29sZWFuJykgewogICAgICAgICAgICBzdHJpY3QgPSBsb2NhbGU7CiAgICAgICAgICAgIGxvY2FsZSA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgICAgLy8gb2JqZWN0IGNvbnN0cnVjdGlvbiBtdXN0IGJlIGRvbmUgdGhpcyB3YXkuCiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudC9tb21lbnQvaXNzdWVzLzE0MjMKICAgICAgICBjID0ge307CiAgICAgICAgYy5faXNBTW9tZW50T2JqZWN0ID0gdHJ1ZTsKICAgICAgICBjLl91c2VVVEMgPSB0cnVlOwogICAgICAgIGMuX2lzVVRDID0gdHJ1ZTsKICAgICAgICBjLl9sID0gbG9jYWxlOwogICAgICAgIGMuX2kgPSBpbnB1dDsKICAgICAgICBjLl9mID0gZm9ybWF0OwogICAgICAgIGMuX3N0cmljdCA9IHN0cmljdDsKICAgICAgICBjLl9wZiA9IGRlZmF1bHRQYXJzaW5nRmxhZ3MoKTsKCiAgICAgICAgcmV0dXJuIG1ha2VNb21lbnQoYykudXRjKCk7CiAgICB9OwoKICAgIC8vIGNyZWF0aW5nIHdpdGggdW5peCB0aW1lc3RhbXAgKGluIHNlY29uZHMpCiAgICBtb21lbnQudW5peCA9IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgIHJldHVybiBtb21lbnQoaW5wdXQgKiAxMDAwKTsKICAgIH07CgogICAgLy8gZHVyYXRpb24KICAgIG1vbWVudC5kdXJhdGlvbiA9IGZ1bmN0aW9uIChpbnB1dCwga2V5KSB7CiAgICAgICAgdmFyIGR1cmF0aW9uID0gaW5wdXQsCiAgICAgICAgICAgIC8vIG1hdGNoaW5nIGFnYWluc3QgcmVnZXhwIGlzIGV4cGVuc2l2ZSwgZG8gaXQgb24gZGVtYW5kCiAgICAgICAgICAgIG1hdGNoID0gbnVsbCwKICAgICAgICAgICAgc2lnbiwKICAgICAgICAgICAgcmV0LAogICAgICAgICAgICBwYXJzZUlzbywKICAgICAgICAgICAgZGlmZlJlczsKCiAgICAgICAgaWYgKG1vbWVudC5pc0R1cmF0aW9uKGlucHV0KSkgewogICAgICAgICAgICBkdXJhdGlvbiA9IHsKICAgICAgICAgICAgICAgIG1zOiBpbnB1dC5fbWlsbGlzZWNvbmRzLAogICAgICAgICAgICAgICAgZDogaW5wdXQuX2RheXMsCiAgICAgICAgICAgICAgICBNOiBpbnB1dC5fbW9udGhzCiAgICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5wdXQgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIGR1cmF0aW9uID0ge307CiAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgIGR1cmF0aW9uW2tleV0gPSBpbnB1dDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGR1cmF0aW9uLm1pbGxpc2Vjb25kcyA9IGlucHV0OwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICghIShtYXRjaCA9IGFzcE5ldFRpbWVTcGFuSnNvblJlZ2V4LmV4ZWMoaW5wdXQpKSkgewogICAgICAgICAgICBzaWduID0gKG1hdGNoWzFdID09PSAnLScpID8gLTEgOiAxOwogICAgICAgICAgICBkdXJhdGlvbiA9IHsKICAgICAgICAgICAgICAgIHk6IDAsCiAgICAgICAgICAgICAgICBkOiB0b0ludChtYXRjaFtEQVRFXSkgKiBzaWduLAogICAgICAgICAgICAgICAgaDogdG9JbnQobWF0Y2hbSE9VUl0pICogc2lnbiwKICAgICAgICAgICAgICAgIG06IHRvSW50KG1hdGNoW01JTlVURV0pICogc2lnbiwKICAgICAgICAgICAgICAgIHM6IHRvSW50KG1hdGNoW1NFQ09ORF0pICogc2lnbiwKICAgICAgICAgICAgICAgIG1zOiB0b0ludChtYXRjaFtNSUxMSVNFQ09ORF0pICogc2lnbgogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSBpZiAoISEobWF0Y2ggPSBpc29EdXJhdGlvblJlZ2V4LmV4ZWMoaW5wdXQpKSkgewogICAgICAgICAgICBzaWduID0gKG1hdGNoWzFdID09PSAnLScpID8gLTEgOiAxOwogICAgICAgICAgICBwYXJzZUlzbyA9IGZ1bmN0aW9uIChpbnApIHsKICAgICAgICAgICAgICAgIC8vIFdlJ2Qgbm9ybWFsbHkgdXNlIH5+aW5wIGZvciB0aGlzLCBidXQgdW5mb3J0dW5hdGVseSBpdCBhbHNvCiAgICAgICAgICAgICAgICAvLyBjb252ZXJ0cyBmbG9hdHMgdG8gaW50cy4KICAgICAgICAgICAgICAgIC8vIGlucCBtYXkgYmUgdW5kZWZpbmVkLCBzbyBjYXJlZnVsIGNhbGxpbmcgcmVwbGFjZSBvbiBpdC4KICAgICAgICAgICAgICAgIHZhciByZXMgPSBpbnAgJiYgcGFyc2VGbG9hdChpbnAucmVwbGFjZSgnLCcsICcuJykpOwogICAgICAgICAgICAgICAgLy8gYXBwbHkgc2lnbiB3aGlsZSB3ZSdyZSBhdCBpdAogICAgICAgICAgICAgICAgcmV0dXJuIChpc05hTihyZXMpID8gMCA6IHJlcykgKiBzaWduOwogICAgICAgICAgICB9OwogICAgICAgICAgICBkdXJhdGlvbiA9IHsKICAgICAgICAgICAgICAgIHk6IHBhcnNlSXNvKG1hdGNoWzJdKSwKICAgICAgICAgICAgICAgIE06IHBhcnNlSXNvKG1hdGNoWzNdKSwKICAgICAgICAgICAgICAgIGQ6IHBhcnNlSXNvKG1hdGNoWzRdKSwKICAgICAgICAgICAgICAgIGg6IHBhcnNlSXNvKG1hdGNoWzVdKSwKICAgICAgICAgICAgICAgIG06IHBhcnNlSXNvKG1hdGNoWzZdKSwKICAgICAgICAgICAgICAgIHM6IHBhcnNlSXNvKG1hdGNoWzddKSwKICAgICAgICAgICAgICAgIHc6IHBhcnNlSXNvKG1hdGNoWzhdKQogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGR1cmF0aW9uID09PSAnb2JqZWN0JyAmJgogICAgICAgICAgICAgICAgKCdmcm9tJyBpbiBkdXJhdGlvbiB8fCAndG8nIGluIGR1cmF0aW9uKSkgewogICAgICAgICAgICBkaWZmUmVzID0gbW9tZW50c0RpZmZlcmVuY2UobW9tZW50KGR1cmF0aW9uLmZyb20pLCBtb21lbnQoZHVyYXRpb24udG8pKTsKCiAgICAgICAgICAgIGR1cmF0aW9uID0ge307CiAgICAgICAgICAgIGR1cmF0aW9uLm1zID0gZGlmZlJlcy5taWxsaXNlY29uZHM7CiAgICAgICAgICAgIGR1cmF0aW9uLk0gPSBkaWZmUmVzLm1vbnRoczsKICAgICAgICB9CgogICAgICAgIHJldCA9IG5ldyBEdXJhdGlvbihkdXJhdGlvbik7CgogICAgICAgIGlmIChtb21lbnQuaXNEdXJhdGlvbihpbnB1dCkgJiYgaGFzT3duUHJvcChpbnB1dCwgJ19sb2NhbGUnKSkgewogICAgICAgICAgICByZXQuX2xvY2FsZSA9IGlucHV0Ll9sb2NhbGU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmV0OwogICAgfTsKCiAgICAvLyB2ZXJzaW9uIG51bWJlcgogICAgbW9tZW50LnZlcnNpb24gPSBWRVJTSU9OOwoKICAgIC8vIGRlZmF1bHQgZm9ybWF0CiAgICBtb21lbnQuZGVmYXVsdEZvcm1hdCA9IGlzb0Zvcm1hdDsKCiAgICAvLyBjb25zdGFudCB0aGF0IHJlZmVycyB0byB0aGUgSVNPIHN0YW5kYXJkCiAgICBtb21lbnQuSVNPXzg2MDEgPSBmdW5jdGlvbiAoKSB7fTsKCiAgICAvLyBQbHVnaW5zIHRoYXQgYWRkIHByb3BlcnRpZXMgc2hvdWxkIGFsc28gYWRkIHRoZSBrZXkgaGVyZSAobnVsbCB2YWx1ZSksCiAgICAvLyBzbyB3ZSBjYW4gcHJvcGVybHkgY2xvbmUgb3Vyc2VsdmVzLgogICAgbW9tZW50Lm1vbWVudFByb3BlcnRpZXMgPSBtb21lbnRQcm9wZXJ0aWVzOwoKICAgIC8vIFRoaXMgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgd2hlbmV2ZXIgYSBtb21lbnQgaXMgbXV0YXRlZC4KICAgIC8vIEl0IGlzIGludGVuZGVkIHRvIGtlZXAgdGhlIG9mZnNldCBpbiBzeW5jIHdpdGggdGhlIHRpbWV6b25lLgogICAgbW9tZW50LnVwZGF0ZU9mZnNldCA9IGZ1bmN0aW9uICgpIHt9OwoKICAgIC8vIFRoaXMgZnVuY3Rpb24gYWxsb3dzIHlvdSB0byBzZXQgYSB0aHJlc2hvbGQgZm9yIHJlbGF0aXZlIHRpbWUgc3RyaW5ncwogICAgbW9tZW50LnJlbGF0aXZlVGltZVRocmVzaG9sZCA9IGZ1bmN0aW9uICh0aHJlc2hvbGQsIGxpbWl0KSB7CiAgICAgICAgaWYgKHJlbGF0aXZlVGltZVRocmVzaG9sZHNbdGhyZXNob2xkXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKGxpbWl0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHJlbGF0aXZlVGltZVRocmVzaG9sZHNbdGhyZXNob2xkXTsKICAgICAgICB9CiAgICAgICAgcmVsYXRpdmVUaW1lVGhyZXNob2xkc1t0aHJlc2hvbGRdID0gbGltaXQ7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwoKICAgIG1vbWVudC5sYW5nID0gZGVwcmVjYXRlKAogICAgICAgICdtb21lbnQubGFuZyBpcyBkZXByZWNhdGVkLiBVc2UgbW9tZW50LmxvY2FsZSBpbnN0ZWFkLicsCiAgICAgICAgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIG1vbWVudC5sb2NhbGUoa2V5LCB2YWx1ZSk7CiAgICAgICAgfQogICAgKTsKCiAgICAvLyBUaGlzIGZ1bmN0aW9uIHdpbGwgbG9hZCBsb2NhbGUgYW5kIHRoZW4gc2V0IHRoZSBnbG9iYWwgbG9jYWxlLiAgSWYKICAgIC8vIG5vIGFyZ3VtZW50cyBhcmUgcGFzc2VkIGluLCBpdCB3aWxsIHNpbXBseSByZXR1cm4gdGhlIGN1cnJlbnQgZ2xvYmFsCiAgICAvLyBsb2NhbGUga2V5LgogICAgbW9tZW50LmxvY2FsZSA9IGZ1bmN0aW9uIChrZXksIHZhbHVlcykgewogICAgICAgIHZhciBkYXRhOwogICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZih2YWx1ZXMpICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgZGF0YSA9IG1vbWVudC5kZWZpbmVMb2NhbGUoa2V5LCB2YWx1ZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgZGF0YSA9IG1vbWVudC5sb2NhbGVEYXRhKGtleSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgICAgICBtb21lbnQuZHVyYXRpb24uX2xvY2FsZSA9IG1vbWVudC5fbG9jYWxlID0gZGF0YTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG1vbWVudC5fbG9jYWxlLl9hYmJyOwogICAgfTsKCiAgICBtb21lbnQuZGVmaW5lTG9jYWxlID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlcykgewogICAgICAgIGlmICh2YWx1ZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFsdWVzLmFiYnIgPSBuYW1lOwogICAgICAgICAgICBpZiAoIWxvY2FsZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgIGxvY2FsZXNbbmFtZV0gPSBuZXcgTG9jYWxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbG9jYWxlc1tuYW1lXS5zZXQodmFsdWVzKTsKCiAgICAgICAgICAgIC8vIGJhY2t3YXJkcyBjb21wYXQgZm9yIG5vdzogYWxzbyBzZXQgdGhlIGxvY2FsZQogICAgICAgICAgICBtb21lbnQubG9jYWxlKG5hbWUpOwoKICAgICAgICAgICAgcmV0dXJuIGxvY2FsZXNbbmFtZV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gdXNlZnVsIGZvciB0ZXN0aW5nCiAgICAgICAgICAgIGRlbGV0ZSBsb2NhbGVzW25hbWVdOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9OwoKICAgIG1vbWVudC5sYW5nRGF0YSA9IGRlcHJlY2F0ZSgKICAgICAgICAnbW9tZW50LmxhbmdEYXRhIGlzIGRlcHJlY2F0ZWQuIFVzZSBtb21lbnQubG9jYWxlRGF0YSBpbnN0ZWFkLicsCiAgICAgICAgZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICByZXR1cm4gbW9tZW50LmxvY2FsZURhdGEoa2V5KTsKICAgICAgICB9CiAgICApOwoKICAgIC8vIHJldHVybnMgbG9jYWxlIGRhdGEKICAgIG1vbWVudC5sb2NhbGVEYXRhID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciBsb2NhbGU7CgogICAgICAgIGlmIChrZXkgJiYga2V5Ll9sb2NhbGUgJiYga2V5Ll9sb2NhbGUuX2FiYnIpIHsKICAgICAgICAgICAga2V5ID0ga2V5Ll9sb2NhbGUuX2FiYnI7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWtleSkgewogICAgICAgICAgICByZXR1cm4gbW9tZW50Ll9sb2NhbGU7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWlzQXJyYXkoa2V5KSkgewogICAgICAgICAgICAvL3Nob3J0LWNpcmN1aXQgZXZlcnl0aGluZyBlbHNlCiAgICAgICAgICAgIGxvY2FsZSA9IGxvYWRMb2NhbGUoa2V5KTsKICAgICAgICAgICAgaWYgKGxvY2FsZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxvY2FsZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBrZXkgPSBba2V5XTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBjaG9vc2VMb2NhbGUoa2V5KTsKICAgIH07CgogICAgLy8gY29tcGFyZSBtb21lbnQgb2JqZWN0CiAgICBtb21lbnQuaXNNb21lbnQgPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIE1vbWVudCB8fAogICAgICAgICAgICAob2JqICE9IG51bGwgJiYgaGFzT3duUHJvcChvYmosICdfaXNBTW9tZW50T2JqZWN0JykpOwogICAgfTsKCiAgICAvLyBmb3IgdHlwZWNoZWNraW5nIER1cmF0aW9uIG9iamVjdHMKICAgIG1vbWVudC5pc0R1cmF0aW9uID0gZnVuY3Rpb24gKG9iaikgewogICAgICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBEdXJhdGlvbjsKICAgIH07CgogICAgZm9yIChpID0gbGlzdHMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICBtYWtlTGlzdChsaXN0c1tpXSk7CiAgICB9CgogICAgbW9tZW50Lm5vcm1hbGl6ZVVuaXRzID0gZnVuY3Rpb24gKHVuaXRzKSB7CiAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKICAgIH07CgogICAgbW9tZW50LmludmFsaWQgPSBmdW5jdGlvbiAoZmxhZ3MpIHsKICAgICAgICB2YXIgbSA9IG1vbWVudC51dGMoTmFOKTsKICAgICAgICBpZiAoZmxhZ3MgIT0gbnVsbCkgewogICAgICAgICAgICBleHRlbmQobS5fcGYsIGZsYWdzKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIG0uX3BmLnVzZXJJbnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbTsKICAgIH07CgogICAgbW9tZW50LnBhcnNlWm9uZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gbW9tZW50LmFwcGx5KG51bGwsIGFyZ3VtZW50cykucGFyc2Vab25lKCk7CiAgICB9OwoKICAgIG1vbWVudC5wYXJzZVR3b0RpZ2l0WWVhciA9IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgIHJldHVybiB0b0ludChpbnB1dCkgKyAodG9JbnQoaW5wdXQpID4gNjggPyAxOTAwIDogMjAwMCk7CiAgICB9OwoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBNb21lbnQgUHJvdG90eXBlCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoKICAgIGV4dGVuZChtb21lbnQuZm4gPSBNb21lbnQucHJvdG90eXBlLCB7CgogICAgICAgIGNsb25lIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gbW9tZW50KHRoaXMpOwogICAgICAgIH0sCgogICAgICAgIHZhbHVlT2YgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiArdGhpcy5fZCArICgodGhpcy5fb2Zmc2V0IHx8IDApICogNjAwMDApOwogICAgICAgIH0sCgogICAgICAgIHVuaXggOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKCt0aGlzIC8gMTAwMCk7CiAgICAgICAgfSwKCiAgICAgICAgdG9TdHJpbmcgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNsb25lKCkubG9jYWxlKCdlbicpLmZvcm1hdCgnZGRkIE1NTSBERCBZWVlZIEhIOm1tOnNzIFtHTVRdWlonKTsKICAgICAgICB9LAoKICAgICAgICB0b0RhdGUgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vZmZzZXQgPyBuZXcgRGF0ZSgrdGhpcykgOiB0aGlzLl9kOwogICAgICAgIH0sCgogICAgICAgIHRvSVNPU3RyaW5nIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgbSA9IG1vbWVudCh0aGlzKS51dGMoKTsKICAgICAgICAgICAgaWYgKDAgPCBtLnllYXIoKSAmJiBtLnllYXIoKSA8PSA5OTk5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm9ybWF0TW9tZW50KG0sICdZWVlZLU1NLUREW1RdSEg6bW06c3MuU1NTW1pdJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm9ybWF0TW9tZW50KG0sICdZWVlZWVktTU0tRERbVF1ISDptbTpzcy5TU1NbWl0nKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHRvQXJyYXkgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBtID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIG0ueWVhcigpLAogICAgICAgICAgICAgICAgbS5tb250aCgpLAogICAgICAgICAgICAgICAgbS5kYXRlKCksCiAgICAgICAgICAgICAgICBtLmhvdXJzKCksCiAgICAgICAgICAgICAgICBtLm1pbnV0ZXMoKSwKICAgICAgICAgICAgICAgIG0uc2Vjb25kcygpLAogICAgICAgICAgICAgICAgbS5taWxsaXNlY29uZHMoKQogICAgICAgICAgICBdOwogICAgICAgIH0sCgogICAgICAgIGlzVmFsaWQgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBpc1ZhbGlkKHRoaXMpOwogICAgICAgIH0sCgogICAgICAgIGlzRFNUU2hpZnRlZCA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2EpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlzVmFsaWQoKSAmJiBjb21wYXJlQXJyYXlzKHRoaXMuX2EsICh0aGlzLl9pc1VUQyA/IG1vbWVudC51dGModGhpcy5fYSkgOiBtb21lbnQodGhpcy5fYSkpLnRvQXJyYXkoKSkgPiAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgcGFyc2luZ0ZsYWdzIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gZXh0ZW5kKHt9LCB0aGlzLl9wZik7CiAgICAgICAgfSwKCiAgICAgICAgaW52YWxpZEF0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wZi5vdmVyZmxvdzsKICAgICAgICB9LAoKICAgICAgICB1dGMgOiBmdW5jdGlvbiAoa2VlcExvY2FsVGltZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy56b25lKDAsIGtlZXBMb2NhbFRpbWUpOwogICAgICAgIH0sCgogICAgICAgIGxvY2FsIDogZnVuY3Rpb24gKGtlZXBMb2NhbFRpbWUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2lzVVRDKSB7CiAgICAgICAgICAgICAgICB0aGlzLnpvbmUoMCwga2VlcExvY2FsVGltZSk7CiAgICAgICAgICAgICAgICB0aGlzLl9pc1VUQyA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIGlmIChrZWVwTG9jYWxUaW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGQodGhpcy5fZGF0ZVR6T2Zmc2V0KCksICdtJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgZm9ybWF0IDogZnVuY3Rpb24gKGlucHV0U3RyaW5nKSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSBmb3JtYXRNb21lbnQodGhpcywgaW5wdXRTdHJpbmcgfHwgbW9tZW50LmRlZmF1bHRGb3JtYXQpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkucG9zdGZvcm1hdChvdXRwdXQpOwogICAgICAgIH0sCgogICAgICAgIGFkZCA6IGNyZWF0ZUFkZGVyKDEsICdhZGQnKSwKCiAgICAgICAgc3VidHJhY3QgOiBjcmVhdGVBZGRlcigtMSwgJ3N1YnRyYWN0JyksCgogICAgICAgIGRpZmYgOiBmdW5jdGlvbiAoaW5wdXQsIHVuaXRzLCBhc0Zsb2F0KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gbWFrZUFzKGlucHV0LCB0aGlzKSwKICAgICAgICAgICAgICAgIHpvbmVEaWZmID0gKHRoaXMuem9uZSgpIC0gdGhhdC56b25lKCkpICogNmU0LAogICAgICAgICAgICAgICAgZGlmZiwgb3V0cHV0LCBkYXlzQWRqdXN0OwoKICAgICAgICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CgogICAgICAgICAgICBpZiAodW5pdHMgPT09ICd5ZWFyJyB8fCB1bml0cyA9PT0gJ21vbnRoJykgewogICAgICAgICAgICAgICAgLy8gYXZlcmFnZSBudW1iZXIgb2YgZGF5cyBpbiB0aGUgbW9udGhzIGluIHRoZSBnaXZlbiBkYXRlcwogICAgICAgICAgICAgICAgZGlmZiA9ICh0aGlzLmRheXNJbk1vbnRoKCkgKyB0aGF0LmRheXNJbk1vbnRoKCkpICogNDMyZTU7IC8vIDI0ICogNjAgKiA2MCAqIDEwMDAgLyAyCiAgICAgICAgICAgICAgICAvLyBkaWZmZXJlbmNlIGluIG1vbnRocwogICAgICAgICAgICAgICAgb3V0cHV0ID0gKCh0aGlzLnllYXIoKSAtIHRoYXQueWVhcigpKSAqIDEyKSArICh0aGlzLm1vbnRoKCkgLSB0aGF0Lm1vbnRoKCkpOwogICAgICAgICAgICAgICAgLy8gYWRqdXN0IGJ5IHRha2luZyBkaWZmZXJlbmNlIGluIGRheXMsIGF2ZXJhZ2UgbnVtYmVyIG9mIGRheXMKICAgICAgICAgICAgICAgIC8vIGFuZCBkc3QgaW4gdGhlIGdpdmVuIG1vbnRocy4KICAgICAgICAgICAgICAgIGRheXNBZGp1c3QgPSAodGhpcyAtIG1vbWVudCh0aGlzKS5zdGFydE9mKCdtb250aCcpKSAtCiAgICAgICAgICAgICAgICAgICAgKHRoYXQgLSBtb21lbnQodGhhdCkuc3RhcnRPZignbW9udGgnKSk7CiAgICAgICAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlIGJ1dCB3aXRoIHpvbmVzLCB0byBuZWdhdGUgYWxsIGRzdAogICAgICAgICAgICAgICAgZGF5c0FkanVzdCAtPSAoKHRoaXMuem9uZSgpIC0gbW9tZW50KHRoaXMpLnN0YXJ0T2YoJ21vbnRoJykuem9uZSgpKSAtCiAgICAgICAgICAgICAgICAgICAgICAgICh0aGF0LnpvbmUoKSAtIG1vbWVudCh0aGF0KS5zdGFydE9mKCdtb250aCcpLnpvbmUoKSkpICogNmU0OwogICAgICAgICAgICAgICAgb3V0cHV0ICs9IGRheXNBZGp1c3QgLyBkaWZmOwogICAgICAgICAgICAgICAgaWYgKHVuaXRzID09PSAneWVhcicpIHsKICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSBvdXRwdXQgLyAxMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRpZmYgPSAodGhpcyAtIHRoYXQpOwogICAgICAgICAgICAgICAgb3V0cHV0ID0gdW5pdHMgPT09ICdzZWNvbmQnID8gZGlmZiAvIDFlMyA6IC8vIDEwMDAKICAgICAgICAgICAgICAgICAgICB1bml0cyA9PT0gJ21pbnV0ZScgPyBkaWZmIC8gNmU0IDogLy8gMTAwMCAqIDYwCiAgICAgICAgICAgICAgICAgICAgdW5pdHMgPT09ICdob3VyJyA/IGRpZmYgLyAzNmU1IDogLy8gMTAwMCAqIDYwICogNjAKICAgICAgICAgICAgICAgICAgICB1bml0cyA9PT0gJ2RheScgPyAoZGlmZiAtIHpvbmVEaWZmKSAvIDg2NGU1IDogLy8gMTAwMCAqIDYwICogNjAgKiAyNCwgbmVnYXRlIGRzdAogICAgICAgICAgICAgICAgICAgIHVuaXRzID09PSAnd2VlaycgPyAoZGlmZiAtIHpvbmVEaWZmKSAvIDYwNDhlNSA6IC8vIDEwMDAgKiA2MCAqIDYwICogMjQgKiA3LCBuZWdhdGUgZHN0CiAgICAgICAgICAgICAgICAgICAgZGlmZjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYXNGbG9hdCA/IG91dHB1dCA6IGFic1JvdW5kKG91dHB1dCk7CiAgICAgICAgfSwKCiAgICAgICAgZnJvbSA6IGZ1bmN0aW9uICh0aW1lLCB3aXRob3V0U3VmZml4KSB7CiAgICAgICAgICAgIHJldHVybiBtb21lbnQuZHVyYXRpb24oe3RvOiB0aGlzLCBmcm9tOiB0aW1lfSkubG9jYWxlKHRoaXMubG9jYWxlKCkpLmh1bWFuaXplKCF3aXRob3V0U3VmZml4KTsKICAgICAgICB9LAoKICAgICAgICBmcm9tTm93IDogZnVuY3Rpb24gKHdpdGhvdXRTdWZmaXgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZnJvbShtb21lbnQoKSwgd2l0aG91dFN1ZmZpeCk7CiAgICAgICAgfSwKCiAgICAgICAgY2FsZW5kYXIgOiBmdW5jdGlvbiAodGltZSkgewogICAgICAgICAgICAvLyBXZSB3YW50IHRvIGNvbXBhcmUgdGhlIHN0YXJ0IG9mIHRvZGF5LCB2cyB0aGlzLgogICAgICAgICAgICAvLyBHZXR0aW5nIHN0YXJ0LW9mLXRvZGF5IGRlcGVuZHMgb24gd2hldGhlciB3ZSdyZSB6b25lJ2Qgb3Igbm90LgogICAgICAgICAgICB2YXIgbm93ID0gdGltZSB8fCBtb21lbnQoKSwKICAgICAgICAgICAgICAgIHNvZCA9IG1ha2VBcyhub3csIHRoaXMpLnN0YXJ0T2YoJ2RheScpLAogICAgICAgICAgICAgICAgZGlmZiA9IHRoaXMuZGlmZihzb2QsICdkYXlzJywgdHJ1ZSksCiAgICAgICAgICAgICAgICBmb3JtYXQgPSBkaWZmIDwgLTYgPyAnc2FtZUVsc2UnIDoKICAgICAgICAgICAgICAgICAgICBkaWZmIDwgLTEgPyAnbGFzdFdlZWsnIDoKICAgICAgICAgICAgICAgICAgICBkaWZmIDwgMCA/ICdsYXN0RGF5JyA6CiAgICAgICAgICAgICAgICAgICAgZGlmZiA8IDEgPyAnc2FtZURheScgOgogICAgICAgICAgICAgICAgICAgIGRpZmYgPCAyID8gJ25leHREYXknIDoKICAgICAgICAgICAgICAgICAgICBkaWZmIDwgNyA/ICduZXh0V2VlaycgOiAnc2FtZUVsc2UnOwogICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXQodGhpcy5sb2NhbGVEYXRhKCkuY2FsZW5kYXIoZm9ybWF0LCB0aGlzKSk7CiAgICAgICAgfSwKCiAgICAgICAgaXNMZWFwWWVhciA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGlzTGVhcFllYXIodGhpcy55ZWFyKCkpOwogICAgICAgIH0sCgogICAgICAgIGlzRFNUIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gKHRoaXMuem9uZSgpIDwgdGhpcy5jbG9uZSgpLm1vbnRoKDApLnpvbmUoKSB8fAogICAgICAgICAgICAgICAgdGhpcy56b25lKCkgPCB0aGlzLmNsb25lKCkubW9udGgoNSkuem9uZSgpKTsKICAgICAgICB9LAoKICAgICAgICBkYXkgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgdmFyIGRheSA9IHRoaXMuX2lzVVRDID8gdGhpcy5fZC5nZXRVVENEYXkoKSA6IHRoaXMuX2QuZ2V0RGF5KCk7CiAgICAgICAgICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpbnB1dCA9IHBhcnNlV2Vla2RheShpbnB1dCwgdGhpcy5sb2NhbGVEYXRhKCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkKGlucHV0IC0gZGF5LCAnZCcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGRheTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIG1vbnRoIDogbWFrZUFjY2Vzc29yKCdNb250aCcsIHRydWUpLAoKICAgICAgICBzdGFydE9mIDogZnVuY3Rpb24gKHVuaXRzKSB7CiAgICAgICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwogICAgICAgICAgICAvLyB0aGUgZm9sbG93aW5nIHN3aXRjaCBpbnRlbnRpb25hbGx5IG9taXRzIGJyZWFrIGtleXdvcmRzCiAgICAgICAgICAgIC8vIHRvIHV0aWxpemUgZmFsbGluZyB0aHJvdWdoIHRoZSBjYXNlcy4KICAgICAgICAgICAgc3dpdGNoICh1bml0cykgewogICAgICAgICAgICBjYXNlICd5ZWFyJzoKICAgICAgICAgICAgICAgIHRoaXMubW9udGgoMCk7CiAgICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgIGNhc2UgJ3F1YXJ0ZXInOgogICAgICAgICAgICBjYXNlICdtb250aCc6CiAgICAgICAgICAgICAgICB0aGlzLmRhdGUoMSk7CiAgICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgIGNhc2UgJ3dlZWsnOgogICAgICAgICAgICBjYXNlICdpc29XZWVrJzoKICAgICAgICAgICAgY2FzZSAnZGF5JzoKICAgICAgICAgICAgICAgIHRoaXMuaG91cnMoMCk7CiAgICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgIGNhc2UgJ2hvdXInOgogICAgICAgICAgICAgICAgdGhpcy5taW51dGVzKDApOwogICAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICBjYXNlICdtaW51dGUnOgogICAgICAgICAgICAgICAgdGhpcy5zZWNvbmRzKDApOwogICAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICBjYXNlICdzZWNvbmQnOgogICAgICAgICAgICAgICAgdGhpcy5taWxsaXNlY29uZHMoMCk7CiAgICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHdlZWtzIGFyZSBhIHNwZWNpYWwgY2FzZQogICAgICAgICAgICBpZiAodW5pdHMgPT09ICd3ZWVrJykgewogICAgICAgICAgICAgICAgdGhpcy53ZWVrZGF5KDApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHVuaXRzID09PSAnaXNvV2VlaycpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNvV2Vla2RheSgxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gcXVhcnRlcnMgYXJlIGFsc28gc3BlY2lhbAogICAgICAgICAgICBpZiAodW5pdHMgPT09ICdxdWFydGVyJykgewogICAgICAgICAgICAgICAgdGhpcy5tb250aChNYXRoLmZsb29yKHRoaXMubW9udGgoKSAvIDMpICogMyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIGVuZE9mOiBmdW5jdGlvbiAodW5pdHMpIHsKICAgICAgICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0YXJ0T2YodW5pdHMpLmFkZCgxLCAodW5pdHMgPT09ICdpc29XZWVrJyA/ICd3ZWVrJyA6IHVuaXRzKSkuc3VidHJhY3QoMSwgJ21zJyk7CiAgICAgICAgfSwKCiAgICAgICAgaXNBZnRlcjogZnVuY3Rpb24gKGlucHV0LCB1bml0cykgewogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHR5cGVvZiB1bml0cyAhPT0gJ3VuZGVmaW5lZCcgPyB1bml0cyA6ICdtaWxsaXNlY29uZCcpOwogICAgICAgICAgICBpZiAodW5pdHMgPT09ICdtaWxsaXNlY29uZCcpIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gbW9tZW50LmlzTW9tZW50KGlucHV0KSA/IGlucHV0IDogbW9tZW50KGlucHV0KTsKICAgICAgICAgICAgICAgIHJldHVybiArdGhpcyA+ICtpbnB1dDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiArdGhpcy5jbG9uZSgpLnN0YXJ0T2YodW5pdHMpID4gK21vbWVudChpbnB1dCkuc3RhcnRPZih1bml0cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBpc0JlZm9yZTogZnVuY3Rpb24gKGlucHV0LCB1bml0cykgewogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHR5cGVvZiB1bml0cyAhPT0gJ3VuZGVmaW5lZCcgPyB1bml0cyA6ICdtaWxsaXNlY29uZCcpOwogICAgICAgICAgICBpZiAodW5pdHMgPT09ICdtaWxsaXNlY29uZCcpIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gbW9tZW50LmlzTW9tZW50KGlucHV0KSA/IGlucHV0IDogbW9tZW50KGlucHV0KTsKICAgICAgICAgICAgICAgIHJldHVybiArdGhpcyA8ICtpbnB1dDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiArdGhpcy5jbG9uZSgpLnN0YXJ0T2YodW5pdHMpIDwgK21vbWVudChpbnB1dCkuc3RhcnRPZih1bml0cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBpc1NhbWU6IGZ1bmN0aW9uIChpbnB1dCwgdW5pdHMpIHsKICAgICAgICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyB8fCAnbWlsbGlzZWNvbmQnKTsKICAgICAgICAgICAgaWYgKHVuaXRzID09PSAnbWlsbGlzZWNvbmQnKSB7CiAgICAgICAgICAgICAgICBpbnB1dCA9IG1vbWVudC5pc01vbWVudChpbnB1dCkgPyBpbnB1dCA6IG1vbWVudChpbnB1dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gK3RoaXMgPT09ICtpbnB1dDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiArdGhpcy5jbG9uZSgpLnN0YXJ0T2YodW5pdHMpID09PSArbWFrZUFzKGlucHV0LCB0aGlzKS5zdGFydE9mKHVuaXRzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIG1pbjogZGVwcmVjYXRlKAogICAgICAgICAgICAgICAgICdtb21lbnQoKS5taW4gaXMgZGVwcmVjYXRlZCwgdXNlIG1vbWVudC5taW4gaW5zdGVhZC4gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudC9tb21lbnQvaXNzdWVzLzE1NDgnLAogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChvdGhlcikgewogICAgICAgICAgICAgICAgICAgICBvdGhlciA9IG1vbWVudC5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3RoZXIgPCB0aGlzID8gdGhpcyA6IG90aGVyOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgKSwKCiAgICAgICAgbWF4OiBkZXByZWNhdGUoCiAgICAgICAgICAgICAgICAnbW9tZW50KCkubWF4IGlzIGRlcHJlY2F0ZWQsIHVzZSBtb21lbnQubWF4IGluc3RlYWQuIGh0dHBzOi8vZ2l0aHViLmNvbS9tb21lbnQvbW9tZW50L2lzc3Vlcy8xNTQ4JywKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChvdGhlcikgewogICAgICAgICAgICAgICAgICAgIG90aGVyID0gbW9tZW50LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG90aGVyID4gdGhpcyA/IHRoaXMgOiBvdGhlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICApLAoKICAgICAgICAvLyBrZWVwTG9jYWxUaW1lID0gdHJ1ZSBtZWFucyBvbmx5IGNoYW5nZSB0aGUgdGltZXpvbmUsIHdpdGhvdXQKICAgICAgICAvLyBhZmZlY3RpbmcgdGhlIGxvY2FsIGhvdXIuIFNvIDU6MzE6MjYgKzAzMDAgLS1bem9uZSgyLCB0cnVlKV0tLT4KICAgICAgICAvLyA1OjMxOjI2ICswMjAwIEl0IGlzIHBvc3NpYmxlIHRoYXQgNTozMToyNiBkb2Vzbid0IGV4aXN0IGludCB6b25lCiAgICAgICAgLy8gKzAyMDAsIHNvIHdlIGFkanVzdCB0aGUgdGltZSBhcyBuZWVkZWQsIHRvIGJlIHZhbGlkLgogICAgICAgIC8vCiAgICAgICAgLy8gS2VlcGluZyB0aGUgdGltZSBhY3R1YWxseSBhZGRzL3N1YnRyYWN0cyAob25lIGhvdXIpCiAgICAgICAgLy8gZnJvbSB0aGUgYWN0dWFsIHJlcHJlc2VudGVkIHRpbWUuIFRoYXQgaXMgd2h5IHdlIGNhbGwgdXBkYXRlT2Zmc2V0CiAgICAgICAgLy8gYSBzZWNvbmQgdGltZS4gSW4gY2FzZSBpdCB3YW50cyB1cyB0byBjaGFuZ2UgdGhlIG9mZnNldCBhZ2FpbgogICAgICAgIC8vIF9jaGFuZ2VJblByb2dyZXNzID09IHRydWUgY2FzZSwgdGhlbiB3ZSBoYXZlIHRvIGFkanVzdCwgYmVjYXVzZQogICAgICAgIC8vIHRoZXJlIGlzIG5vIHN1Y2ggdGltZSBpbiB0aGUgZ2l2ZW4gdGltZXpvbmUuCiAgICAgICAgem9uZSA6IGZ1bmN0aW9uIChpbnB1dCwga2VlcExvY2FsVGltZSkgewogICAgICAgICAgICB2YXIgb2Zmc2V0ID0gdGhpcy5fb2Zmc2V0IHx8IDAsCiAgICAgICAgICAgICAgICBsb2NhbEFkanVzdDsKICAgICAgICAgICAgaWYgKGlucHV0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgaW5wdXQgPSB0aW1lem9uZU1pbnV0ZXNGcm9tU3RyaW5nKGlucHV0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhpbnB1dCkgPCAxNikgewogICAgICAgICAgICAgICAgICAgIGlucHV0ID0gaW5wdXQgKiA2MDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghdGhpcy5faXNVVEMgJiYga2VlcExvY2FsVGltZSkgewogICAgICAgICAgICAgICAgICAgIGxvY2FsQWRqdXN0ID0gdGhpcy5fZGF0ZVR6T2Zmc2V0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9vZmZzZXQgPSBpbnB1dDsKICAgICAgICAgICAgICAgIHRoaXMuX2lzVVRDID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChsb2NhbEFkanVzdCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdWJ0cmFjdChsb2NhbEFkanVzdCwgJ20nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvZmZzZXQgIT09IGlucHV0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFrZWVwTG9jYWxUaW1lIHx8IHRoaXMuX2NoYW5nZUluUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkT3JTdWJ0cmFjdER1cmF0aW9uRnJvbU1vbWVudCh0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vbWVudC5kdXJhdGlvbihvZmZzZXQgLSBpbnB1dCwgJ20nKSwgMSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuX2NoYW5nZUluUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlSW5Qcm9ncmVzcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIG1vbWVudC51cGRhdGVPZmZzZXQodGhpcywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZUluUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9pc1VUQyA/IG9mZnNldCA6IHRoaXMuX2RhdGVUek9mZnNldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHpvbmVBYmJyIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faXNVVEMgPyAnVVRDJyA6ICcnOwogICAgICAgIH0sCgogICAgICAgIHpvbmVOYW1lIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faXNVVEMgPyAnQ29vcmRpbmF0ZWQgVW5pdmVyc2FsIFRpbWUnIDogJyc7CiAgICAgICAgfSwKCiAgICAgICAgcGFyc2Vab25lIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAodGhpcy5fdHptKSB7CiAgICAgICAgICAgICAgICB0aGlzLnpvbmUodGhpcy5fdHptKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGhpcy5faSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHRoaXMuem9uZSh0aGlzLl9pKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICBoYXNBbGlnbmVkSG91ck9mZnNldCA6IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgICBpZiAoIWlucHV0KSB7CiAgICAgICAgICAgICAgICBpbnB1dCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBpbnB1dCA9IG1vbWVudChpbnB1dCkuem9uZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gKHRoaXMuem9uZSgpIC0gaW5wdXQpICUgNjAgPT09IDA7CiAgICAgICAgfSwKCiAgICAgICAgZGF5c0luTW9udGggOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBkYXlzSW5Nb250aCh0aGlzLnllYXIoKSwgdGhpcy5tb250aCgpKTsKICAgICAgICB9LAoKICAgICAgICBkYXlPZlllYXIgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgdmFyIGRheU9mWWVhciA9IHJvdW5kKChtb21lbnQodGhpcykuc3RhcnRPZignZGF5JykgLSBtb21lbnQodGhpcykuc3RhcnRPZigneWVhcicpKSAvIDg2NGU1KSArIDE7CiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gZGF5T2ZZZWFyIDogdGhpcy5hZGQoKGlucHV0IC0gZGF5T2ZZZWFyKSwgJ2QnKTsKICAgICAgICB9LAoKICAgICAgICBxdWFydGVyIDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gTWF0aC5jZWlsKCh0aGlzLm1vbnRoKCkgKyAxKSAvIDMpIDogdGhpcy5tb250aCgoaW5wdXQgLSAxKSAqIDMgKyB0aGlzLm1vbnRoKCkgJSAzKTsKICAgICAgICB9LAoKICAgICAgICB3ZWVrWWVhciA6IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgICB2YXIgeWVhciA9IHdlZWtPZlllYXIodGhpcywgdGhpcy5sb2NhbGVEYXRhKCkuX3dlZWsuZG93LCB0aGlzLmxvY2FsZURhdGEoKS5fd2Vlay5kb3kpLnllYXI7CiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8geWVhciA6IHRoaXMuYWRkKChpbnB1dCAtIHllYXIpLCAneScpOwogICAgICAgIH0sCgogICAgICAgIGlzb1dlZWtZZWFyIDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIHZhciB5ZWFyID0gd2Vla09mWWVhcih0aGlzLCAxLCA0KS55ZWFyOwogICAgICAgICAgICByZXR1cm4gaW5wdXQgPT0gbnVsbCA/IHllYXIgOiB0aGlzLmFkZCgoaW5wdXQgLSB5ZWFyKSwgJ3knKTsKICAgICAgICB9LAoKICAgICAgICB3ZWVrIDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIHZhciB3ZWVrID0gdGhpcy5sb2NhbGVEYXRhKCkud2Vlayh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB3ZWVrIDogdGhpcy5hZGQoKGlucHV0IC0gd2VlaykgKiA3LCAnZCcpOwogICAgICAgIH0sCgogICAgICAgIGlzb1dlZWsgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgdmFyIHdlZWsgPSB3ZWVrT2ZZZWFyKHRoaXMsIDEsIDQpLndlZWs7CiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gd2VlayA6IHRoaXMuYWRkKChpbnB1dCAtIHdlZWspICogNywgJ2QnKTsKICAgICAgICB9LAoKICAgICAgICB3ZWVrZGF5IDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIHZhciB3ZWVrZGF5ID0gKHRoaXMuZGF5KCkgKyA3IC0gdGhpcy5sb2NhbGVEYXRhKCkuX3dlZWsuZG93KSAlIDc7CiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gd2Vla2RheSA6IHRoaXMuYWRkKGlucHV0IC0gd2Vla2RheSwgJ2QnKTsKICAgICAgICB9LAoKICAgICAgICBpc29XZWVrZGF5IDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIC8vIGJlaGF2ZXMgdGhlIHNhbWUgYXMgbW9tZW50I2RheSBleGNlcHQKICAgICAgICAgICAgLy8gYXMgYSBnZXR0ZXIsIHJldHVybnMgNyBpbnN0ZWFkIG9mIDAgKDEtNyByYW5nZSBpbnN0ZWFkIG9mIDAtNikKICAgICAgICAgICAgLy8gYXMgYSBzZXR0ZXIsIHN1bmRheSBzaG91bGQgYmVsb25nIHRvIHRoZSBwcmV2aW91cyB3ZWVrLgogICAgICAgICAgICByZXR1cm4gaW5wdXQgPT0gbnVsbCA/IHRoaXMuZGF5KCkgfHwgNyA6IHRoaXMuZGF5KHRoaXMuZGF5KCkgJSA3ID8gaW5wdXQgOiBpbnB1dCAtIDcpOwogICAgICAgIH0sCgogICAgICAgIGlzb1dlZWtzSW5ZZWFyIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gd2Vla3NJblllYXIodGhpcy55ZWFyKCksIDEsIDQpOwogICAgICAgIH0sCgogICAgICAgIHdlZWtzSW5ZZWFyIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgd2Vla0luZm8gPSB0aGlzLmxvY2FsZURhdGEoKS5fd2VlazsKICAgICAgICAgICAgcmV0dXJuIHdlZWtzSW5ZZWFyKHRoaXMueWVhcigpLCB3ZWVrSW5mby5kb3csIHdlZWtJbmZvLmRveSk7CiAgICAgICAgfSwKCiAgICAgICAgZ2V0IDogZnVuY3Rpb24gKHVuaXRzKSB7CiAgICAgICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwogICAgICAgICAgICByZXR1cm4gdGhpc1t1bml0c10oKTsKICAgICAgICB9LAoKICAgICAgICBzZXQgOiBmdW5jdGlvbiAodW5pdHMsIHZhbHVlKSB7CiAgICAgICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwogICAgICAgICAgICBpZiAodHlwZW9mIHRoaXNbdW5pdHNdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0aGlzW3VuaXRzXSh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLy8gSWYgcGFzc2VkIGEgbG9jYWxlIGtleSwgaXQgd2lsbCBzZXQgdGhlIGxvY2FsZSBmb3IgdGhpcwogICAgICAgIC8vIGluc3RhbmNlLiAgT3RoZXJ3aXNlLCBpdCB3aWxsIHJldHVybiB0aGUgbG9jYWxlIGNvbmZpZ3VyYXRpb24KICAgICAgICAvLyB2YXJpYWJsZXMgZm9yIHRoaXMgaW5zdGFuY2UuCiAgICAgICAgbG9jYWxlIDogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICB2YXIgbmV3TG9jYWxlRGF0YTsKCiAgICAgICAgICAgIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xvY2FsZS5fYWJicjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5ld0xvY2FsZURhdGEgPSBtb21lbnQubG9jYWxlRGF0YShrZXkpOwogICAgICAgICAgICAgICAgaWYgKG5ld0xvY2FsZURhdGEgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvY2FsZSA9IG5ld0xvY2FsZURhdGE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGxhbmcgOiBkZXByZWNhdGUoCiAgICAgICAgICAgICdtb21lbnQoKS5sYW5nKCkgaXMgZGVwcmVjYXRlZC4gVXNlIG1vbWVudCgpLmxvY2FsZURhdGEoKSBpbnN0ZWFkLicsCiAgICAgICAgICAgIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlKGtleSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICApLAoKICAgICAgICBsb2NhbGVEYXRhIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbG9jYWxlOwogICAgICAgIH0sCgogICAgICAgIF9kYXRlVHpPZmZzZXQgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vIE9uIEZpcmVmb3guMjQgRGF0ZSNnZXRUaW1lem9uZU9mZnNldCByZXR1cm5zIGEgZmxvYXRpbmcgcG9pbnQuCiAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tb21lbnQvbW9tZW50L3B1bGwvMTg3MQogICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZCh0aGlzLl9kLmdldFRpbWV6b25lT2Zmc2V0KCkgLyAxNSkgKiAxNTsKICAgICAgICB9CiAgICB9KTsKCiAgICBmdW5jdGlvbiByYXdNb250aFNldHRlcihtb20sIHZhbHVlKSB7CiAgICAgICAgdmFyIGRheU9mTW9udGg7CgogICAgICAgIC8vIFRPRE86IE1vdmUgdGhpcyBvdXQgb2YgaGVyZSEKICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICB2YWx1ZSA9IG1vbS5sb2NhbGVEYXRhKCkubW9udGhzUGFyc2UodmFsdWUpOwogICAgICAgICAgICAvLyBUT0RPOiBBbm90aGVyIHNpbGVudCBmYWlsdXJlPwogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vbTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZGF5T2ZNb250aCA9IE1hdGgubWluKG1vbS5kYXRlKCksCiAgICAgICAgICAgICAgICBkYXlzSW5Nb250aChtb20ueWVhcigpLCB2YWx1ZSkpOwogICAgICAgIG1vbS5fZFsnc2V0JyArIChtb20uX2lzVVRDID8gJ1VUQycgOiAnJykgKyAnTW9udGgnXSh2YWx1ZSwgZGF5T2ZNb250aCk7CiAgICAgICAgcmV0dXJuIG1vbTsKICAgIH0KCiAgICBmdW5jdGlvbiByYXdHZXR0ZXIobW9tLCB1bml0KSB7CiAgICAgICAgcmV0dXJuIG1vbS5fZFsnZ2V0JyArIChtb20uX2lzVVRDID8gJ1VUQycgOiAnJykgKyB1bml0XSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJhd1NldHRlcihtb20sIHVuaXQsIHZhbHVlKSB7CiAgICAgICAgaWYgKHVuaXQgPT09ICdNb250aCcpIHsKICAgICAgICAgICAgcmV0dXJuIHJhd01vbnRoU2V0dGVyKG1vbSwgdmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBtb20uX2RbJ3NldCcgKyAobW9tLl9pc1VUQyA/ICdVVEMnIDogJycpICsgdW5pdF0odmFsdWUpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBtYWtlQWNjZXNzb3IodW5pdCwga2VlcFRpbWUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByYXdTZXR0ZXIodGhpcywgdW5pdCwgdmFsdWUpOwogICAgICAgICAgICAgICAgbW9tZW50LnVwZGF0ZU9mZnNldCh0aGlzLCBrZWVwVGltZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiByYXdHZXR0ZXIodGhpcywgdW5pdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQoKICAgIG1vbWVudC5mbi5taWxsaXNlY29uZCA9IG1vbWVudC5mbi5taWxsaXNlY29uZHMgPSBtYWtlQWNjZXNzb3IoJ01pbGxpc2Vjb25kcycsIGZhbHNlKTsKICAgIG1vbWVudC5mbi5zZWNvbmQgPSBtb21lbnQuZm4uc2Vjb25kcyA9IG1ha2VBY2Nlc3NvcignU2Vjb25kcycsIGZhbHNlKTsKICAgIG1vbWVudC5mbi5taW51dGUgPSBtb21lbnQuZm4ubWludXRlcyA9IG1ha2VBY2Nlc3NvcignTWludXRlcycsIGZhbHNlKTsKICAgIC8vIFNldHRpbmcgdGhlIGhvdXIgc2hvdWxkIGtlZXAgdGhlIHRpbWUsIGJlY2F1c2UgdGhlIHVzZXIgZXhwbGljaXRseQogICAgLy8gc3BlY2lmaWVkIHdoaWNoIGhvdXIgaGUgd2FudHMuIFNvIHRyeWluZyB0byBtYWludGFpbiB0aGUgc2FtZSBob3VyIChpbgogICAgLy8gYSBuZXcgdGltZXpvbmUpIG1ha2VzIHNlbnNlLiBBZGRpbmcvc3VidHJhY3RpbmcgaG91cnMgZG9lcyBub3QgZm9sbG93CiAgICAvLyB0aGlzIHJ1bGUuCiAgICBtb21lbnQuZm4uaG91ciA9IG1vbWVudC5mbi5ob3VycyA9IG1ha2VBY2Nlc3NvcignSG91cnMnLCB0cnVlKTsKICAgIC8vIG1vbWVudC5mbi5tb250aCBpcyBkZWZpbmVkIHNlcGFyYXRlbHkKICAgIG1vbWVudC5mbi5kYXRlID0gbWFrZUFjY2Vzc29yKCdEYXRlJywgdHJ1ZSk7CiAgICBtb21lbnQuZm4uZGF0ZXMgPSBkZXByZWNhdGUoJ2RhdGVzIGFjY2Vzc29yIGlzIGRlcHJlY2F0ZWQuIFVzZSBkYXRlIGluc3RlYWQuJywgbWFrZUFjY2Vzc29yKCdEYXRlJywgdHJ1ZSkpOwogICAgbW9tZW50LmZuLnllYXIgPSBtYWtlQWNjZXNzb3IoJ0Z1bGxZZWFyJywgdHJ1ZSk7CiAgICBtb21lbnQuZm4ueWVhcnMgPSBkZXByZWNhdGUoJ3llYXJzIGFjY2Vzc29yIGlzIGRlcHJlY2F0ZWQuIFVzZSB5ZWFyIGluc3RlYWQuJywgbWFrZUFjY2Vzc29yKCdGdWxsWWVhcicsIHRydWUpKTsKCiAgICAvLyBhZGQgcGx1cmFsIG1ldGhvZHMKICAgIG1vbWVudC5mbi5kYXlzID0gbW9tZW50LmZuLmRheTsKICAgIG1vbWVudC5mbi5tb250aHMgPSBtb21lbnQuZm4ubW9udGg7CiAgICBtb21lbnQuZm4ud2Vla3MgPSBtb21lbnQuZm4ud2VlazsKICAgIG1vbWVudC5mbi5pc29XZWVrcyA9IG1vbWVudC5mbi5pc29XZWVrOwogICAgbW9tZW50LmZuLnF1YXJ0ZXJzID0gbW9tZW50LmZuLnF1YXJ0ZXI7CgogICAgLy8gYWRkIGFsaWFzZWQgZm9ybWF0IG1ldGhvZHMKICAgIG1vbWVudC5mbi50b0pTT04gPSBtb21lbnQuZm4udG9JU09TdHJpbmc7CgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIER1cmF0aW9uIFByb3RvdHlwZQogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCiAgICBmdW5jdGlvbiBkYXlzVG9ZZWFycyAoZGF5cykgewogICAgICAgIC8vIDQwMCB5ZWFycyBoYXZlIDE0NjA5NyBkYXlzICh0YWtpbmcgaW50byBhY2NvdW50IGxlYXAgeWVhciBydWxlcykKICAgICAgICByZXR1cm4gZGF5cyAqIDQwMCAvIDE0NjA5NzsKICAgIH0KCiAgICBmdW5jdGlvbiB5ZWFyc1RvRGF5cyAoeWVhcnMpIHsKICAgICAgICAvLyB5ZWFycyAqIDM2NSArIGFic1JvdW5kKHllYXJzIC8gNCkgLQogICAgICAgIC8vICAgICBhYnNSb3VuZCh5ZWFycyAvIDEwMCkgKyBhYnNSb3VuZCh5ZWFycyAvIDQwMCk7CiAgICAgICAgcmV0dXJuIHllYXJzICogMTQ2MDk3IC8gNDAwOwogICAgfQoKICAgIGV4dGVuZChtb21lbnQuZHVyYXRpb24uZm4gPSBEdXJhdGlvbi5wcm90b3R5cGUsIHsKCiAgICAgICAgX2J1YmJsZSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG1pbGxpc2Vjb25kcyA9IHRoaXMuX21pbGxpc2Vjb25kcywKICAgICAgICAgICAgICAgIGRheXMgPSB0aGlzLl9kYXlzLAogICAgICAgICAgICAgICAgbW9udGhzID0gdGhpcy5fbW9udGhzLAogICAgICAgICAgICAgICAgZGF0YSA9IHRoaXMuX2RhdGEsCiAgICAgICAgICAgICAgICBzZWNvbmRzLCBtaW51dGVzLCBob3VycywgeWVhcnMgPSAwOwoKICAgICAgICAgICAgLy8gVGhlIGZvbGxvd2luZyBjb2RlIGJ1YmJsZXMgdXAgdmFsdWVzLCBzZWUgdGhlIHRlc3RzIGZvcgogICAgICAgICAgICAvLyBleGFtcGxlcyBvZiB3aGF0IHRoYXQgbWVhbnMuCiAgICAgICAgICAgIGRhdGEubWlsbGlzZWNvbmRzID0gbWlsbGlzZWNvbmRzICUgMTAwMDsKCiAgICAgICAgICAgIHNlY29uZHMgPSBhYnNSb3VuZChtaWxsaXNlY29uZHMgLyAxMDAwKTsKICAgICAgICAgICAgZGF0YS5zZWNvbmRzID0gc2Vjb25kcyAlIDYwOwoKICAgICAgICAgICAgbWludXRlcyA9IGFic1JvdW5kKHNlY29uZHMgLyA2MCk7CiAgICAgICAgICAgIGRhdGEubWludXRlcyA9IG1pbnV0ZXMgJSA2MDsKCiAgICAgICAgICAgIGhvdXJzID0gYWJzUm91bmQobWludXRlcyAvIDYwKTsKICAgICAgICAgICAgZGF0YS5ob3VycyA9IGhvdXJzICUgMjQ7CgogICAgICAgICAgICBkYXlzICs9IGFic1JvdW5kKGhvdXJzIC8gMjQpOwoKICAgICAgICAgICAgLy8gQWNjdXJhdGVseSBjb252ZXJ0IGRheXMgdG8geWVhcnMsIGFzc3VtZSBzdGFydCBmcm9tIHllYXIgMC4KICAgICAgICAgICAgeWVhcnMgPSBhYnNSb3VuZChkYXlzVG9ZZWFycyhkYXlzKSk7CiAgICAgICAgICAgIGRheXMgLT0gYWJzUm91bmQoeWVhcnNUb0RheXMoeWVhcnMpKTsKCiAgICAgICAgICAgIC8vIDMwIGRheXMgdG8gYSBtb250aAogICAgICAgICAgICAvLyBUT0RPIChpc2tyZW4pOiBVc2UgYW5jaG9yIGRhdGUgKGxpa2UgMXN0IEphbikgdG8gY29tcHV0ZSB0aGlzLgogICAgICAgICAgICBtb250aHMgKz0gYWJzUm91bmQoZGF5cyAvIDMwKTsKICAgICAgICAgICAgZGF5cyAlPSAzMDsKCiAgICAgICAgICAgIC8vIDEyIG1vbnRocyAtPiAxIHllYXIKICAgICAgICAgICAgeWVhcnMgKz0gYWJzUm91bmQobW9udGhzIC8gMTIpOwogICAgICAgICAgICBtb250aHMgJT0gMTI7CgogICAgICAgICAgICBkYXRhLmRheXMgPSBkYXlzOwogICAgICAgICAgICBkYXRhLm1vbnRocyA9IG1vbnRoczsKICAgICAgICAgICAgZGF0YS55ZWFycyA9IHllYXJzOwogICAgICAgIH0sCgogICAgICAgIGFicyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5fbWlsbGlzZWNvbmRzID0gTWF0aC5hYnModGhpcy5fbWlsbGlzZWNvbmRzKTsKICAgICAgICAgICAgdGhpcy5fZGF5cyA9IE1hdGguYWJzKHRoaXMuX2RheXMpOwogICAgICAgICAgICB0aGlzLl9tb250aHMgPSBNYXRoLmFicyh0aGlzLl9tb250aHMpOwoKICAgICAgICAgICAgdGhpcy5fZGF0YS5taWxsaXNlY29uZHMgPSBNYXRoLmFicyh0aGlzLl9kYXRhLm1pbGxpc2Vjb25kcyk7CiAgICAgICAgICAgIHRoaXMuX2RhdGEuc2Vjb25kcyA9IE1hdGguYWJzKHRoaXMuX2RhdGEuc2Vjb25kcyk7CiAgICAgICAgICAgIHRoaXMuX2RhdGEubWludXRlcyA9IE1hdGguYWJzKHRoaXMuX2RhdGEubWludXRlcyk7CiAgICAgICAgICAgIHRoaXMuX2RhdGEuaG91cnMgPSBNYXRoLmFicyh0aGlzLl9kYXRhLmhvdXJzKTsKICAgICAgICAgICAgdGhpcy5fZGF0YS5tb250aHMgPSBNYXRoLmFicyh0aGlzLl9kYXRhLm1vbnRocyk7CiAgICAgICAgICAgIHRoaXMuX2RhdGEueWVhcnMgPSBNYXRoLmFicyh0aGlzLl9kYXRhLnllYXJzKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHdlZWtzIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gYWJzUm91bmQodGhpcy5kYXlzKCkgLyA3KTsKICAgICAgICB9LAoKICAgICAgICB2YWx1ZU9mIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbWlsbGlzZWNvbmRzICsKICAgICAgICAgICAgICB0aGlzLl9kYXlzICogODY0ZTUgKwogICAgICAgICAgICAgICh0aGlzLl9tb250aHMgJSAxMikgKiAyNTkyZTYgKwogICAgICAgICAgICAgIHRvSW50KHRoaXMuX21vbnRocyAvIDEyKSAqIDMxNTM2ZTY7CiAgICAgICAgfSwKCiAgICAgICAgaHVtYW5pemUgOiBmdW5jdGlvbiAod2l0aFN1ZmZpeCkgewogICAgICAgICAgICB2YXIgb3V0cHV0ID0gcmVsYXRpdmVUaW1lKHRoaXMsICF3aXRoU3VmZml4LCB0aGlzLmxvY2FsZURhdGEoKSk7CgogICAgICAgICAgICBpZiAod2l0aFN1ZmZpeCkgewogICAgICAgICAgICAgICAgb3V0cHV0ID0gdGhpcy5sb2NhbGVEYXRhKCkucGFzdEZ1dHVyZSgrdGhpcywgb3V0cHV0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLnBvc3Rmb3JtYXQob3V0cHV0KTsKICAgICAgICB9LAoKICAgICAgICBhZGQgOiBmdW5jdGlvbiAoaW5wdXQsIHZhbCkgewogICAgICAgICAgICAvLyBzdXBwb3J0cyBvbmx5IDIuMC1zdHlsZSBhZGQoMSwgJ3MnKSBvciBhZGQobW9tZW50KQogICAgICAgICAgICB2YXIgZHVyID0gbW9tZW50LmR1cmF0aW9uKGlucHV0LCB2YWwpOwoKICAgICAgICAgICAgdGhpcy5fbWlsbGlzZWNvbmRzICs9IGR1ci5fbWlsbGlzZWNvbmRzOwogICAgICAgICAgICB0aGlzLl9kYXlzICs9IGR1ci5fZGF5czsKICAgICAgICAgICAgdGhpcy5fbW9udGhzICs9IGR1ci5fbW9udGhzOwoKICAgICAgICAgICAgdGhpcy5fYnViYmxlKCk7CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICBzdWJ0cmFjdCA6IGZ1bmN0aW9uIChpbnB1dCwgdmFsKSB7CiAgICAgICAgICAgIHZhciBkdXIgPSBtb21lbnQuZHVyYXRpb24oaW5wdXQsIHZhbCk7CgogICAgICAgICAgICB0aGlzLl9taWxsaXNlY29uZHMgLT0gZHVyLl9taWxsaXNlY29uZHM7CiAgICAgICAgICAgIHRoaXMuX2RheXMgLT0gZHVyLl9kYXlzOwogICAgICAgICAgICB0aGlzLl9tb250aHMgLT0gZHVyLl9tb250aHM7CgogICAgICAgICAgICB0aGlzLl9idWJibGUoKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIGdldCA6IGZ1bmN0aW9uICh1bml0cykgewogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbdW5pdHMudG9Mb3dlckNhc2UoKSArICdzJ10oKTsKICAgICAgICB9LAoKICAgICAgICBhcyA6IGZ1bmN0aW9uICh1bml0cykgewogICAgICAgICAgICB2YXIgZGF5cywgbW9udGhzOwogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKCiAgICAgICAgICAgIGlmICh1bml0cyA9PT0gJ21vbnRoJyB8fCB1bml0cyA9PT0gJ3llYXInKSB7CiAgICAgICAgICAgICAgICBkYXlzID0gdGhpcy5fZGF5cyArIHRoaXMuX21pbGxpc2Vjb25kcyAvIDg2NGU1OwogICAgICAgICAgICAgICAgbW9udGhzID0gdGhpcy5fbW9udGhzICsgZGF5c1RvWWVhcnMoZGF5cykgKiAxMjsKICAgICAgICAgICAgICAgIHJldHVybiB1bml0cyA9PT0gJ21vbnRoJyA/IG1vbnRocyA6IG1vbnRocyAvIDEyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gaGFuZGxlIG1pbGxpc2Vjb25kcyBzZXBhcmF0ZWx5IGJlY2F1c2Ugb2YgZmxvYXRpbmcgcG9pbnQgbWF0aCBlcnJvcnMgKGlzc3VlICMxODY3KQogICAgICAgICAgICAgICAgZGF5cyA9IHRoaXMuX2RheXMgKyB5ZWFyc1RvRGF5cyh0aGlzLl9tb250aHMgLyAxMik7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHVuaXRzKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnd2Vlayc6IHJldHVybiBkYXlzIC8gNyArIHRoaXMuX21pbGxpc2Vjb25kcyAvIDYwNDhlNTsKICAgICAgICAgICAgICAgICAgICBjYXNlICdkYXknOiByZXR1cm4gZGF5cyArIHRoaXMuX21pbGxpc2Vjb25kcyAvIDg2NGU1OwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ2hvdXInOiByZXR1cm4gZGF5cyAqIDI0ICsgdGhpcy5fbWlsbGlzZWNvbmRzIC8gMzZlNTsKICAgICAgICAgICAgICAgICAgICBjYXNlICdtaW51dGUnOiByZXR1cm4gZGF5cyAqIDI0ICogNjAgKyB0aGlzLl9taWxsaXNlY29uZHMgLyA2ZTQ7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc2Vjb25kJzogcmV0dXJuIGRheXMgKiAyNCAqIDYwICogNjAgKyB0aGlzLl9taWxsaXNlY29uZHMgLyAxMDAwOwogICAgICAgICAgICAgICAgICAgIC8vIE1hdGguZmxvb3IgcHJldmVudHMgZmxvYXRpbmcgcG9pbnQgbWF0aCBlcnJvcnMgaGVyZQogICAgICAgICAgICAgICAgICAgIGNhc2UgJ21pbGxpc2Vjb25kJzogcmV0dXJuIE1hdGguZmxvb3IoZGF5cyAqIDI0ICogNjAgKiA2MCAqIDEwMDApICsgdGhpcy5fbWlsbGlzZWNvbmRzOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHRocm93IG5ldyBFcnJvcignVW5rbm93biB1bml0ICcgKyB1bml0cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBsYW5nIDogbW9tZW50LmZuLmxhbmcsCiAgICAgICAgbG9jYWxlIDogbW9tZW50LmZuLmxvY2FsZSwKCiAgICAgICAgdG9Jc29TdHJpbmcgOiBkZXByZWNhdGUoCiAgICAgICAgICAgICd0b0lzb1N0cmluZygpIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgdG9JU09TdHJpbmcoKSBpbnN0ZWFkICcgKwogICAgICAgICAgICAnKG5vdGljZSB0aGUgY2FwaXRhbHMpJywKICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9JU09TdHJpbmcoKTsKICAgICAgICAgICAgfQogICAgICAgICksCgogICAgICAgIHRvSVNPU3RyaW5nIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBpbnNwaXJlZCBieSBodHRwczovL2dpdGh1Yi5jb20vZG9yZGlsbGUvbW9tZW50LWlzb2R1cmF0aW9uL2Jsb2IvbWFzdGVyL21vbWVudC5pc29kdXJhdGlvbi5qcwogICAgICAgICAgICB2YXIgeWVhcnMgPSBNYXRoLmFicyh0aGlzLnllYXJzKCkpLAogICAgICAgICAgICAgICAgbW9udGhzID0gTWF0aC5hYnModGhpcy5tb250aHMoKSksCiAgICAgICAgICAgICAgICBkYXlzID0gTWF0aC5hYnModGhpcy5kYXlzKCkpLAogICAgICAgICAgICAgICAgaG91cnMgPSBNYXRoLmFicyh0aGlzLmhvdXJzKCkpLAogICAgICAgICAgICAgICAgbWludXRlcyA9IE1hdGguYWJzKHRoaXMubWludXRlcygpKSwKICAgICAgICAgICAgICAgIHNlY29uZHMgPSBNYXRoLmFicyh0aGlzLnNlY29uZHMoKSArIHRoaXMubWlsbGlzZWNvbmRzKCkgLyAxMDAwKTsKCiAgICAgICAgICAgIGlmICghdGhpcy5hc1NlY29uZHMoKSkgewogICAgICAgICAgICAgICAgLy8gdGhpcyBpcyB0aGUgc2FtZSBhcyBDIydzIChOb2RhKSBhbmQgcHl0aG9uIChpc29kYXRlKS4uLgogICAgICAgICAgICAgICAgLy8gYnV0IG5vdCBvdGhlciBKUyAoZ29vZy5kYXRlKQogICAgICAgICAgICAgICAgcmV0dXJuICdQMEQnOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gKHRoaXMuYXNTZWNvbmRzKCkgPCAwID8gJy0nIDogJycpICsKICAgICAgICAgICAgICAgICdQJyArCiAgICAgICAgICAgICAgICAoeWVhcnMgPyB5ZWFycyArICdZJyA6ICcnKSArCiAgICAgICAgICAgICAgICAobW9udGhzID8gbW9udGhzICsgJ00nIDogJycpICsKICAgICAgICAgICAgICAgIChkYXlzID8gZGF5cyArICdEJyA6ICcnKSArCiAgICAgICAgICAgICAgICAoKGhvdXJzIHx8IG1pbnV0ZXMgfHwgc2Vjb25kcykgPyAnVCcgOiAnJykgKwogICAgICAgICAgICAgICAgKGhvdXJzID8gaG91cnMgKyAnSCcgOiAnJykgKwogICAgICAgICAgICAgICAgKG1pbnV0ZXMgPyBtaW51dGVzICsgJ00nIDogJycpICsKICAgICAgICAgICAgICAgIChzZWNvbmRzID8gc2Vjb25kcyArICdTJyA6ICcnKTsKICAgICAgICB9LAoKICAgICAgICBsb2NhbGVEYXRhIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbG9jYWxlOwogICAgICAgIH0KICAgIH0pOwoKICAgIG1vbWVudC5kdXJhdGlvbi5mbi50b1N0cmluZyA9IG1vbWVudC5kdXJhdGlvbi5mbi50b0lTT1N0cmluZzsKCiAgICBmdW5jdGlvbiBtYWtlRHVyYXRpb25HZXR0ZXIobmFtZSkgewogICAgICAgIG1vbWVudC5kdXJhdGlvbi5mbltuYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2RhdGFbbmFtZV07CiAgICAgICAgfTsKICAgIH0KCiAgICBmb3IgKGkgaW4gdW5pdE1pbGxpc2Vjb25kRmFjdG9ycykgewogICAgICAgIGlmIChoYXNPd25Qcm9wKHVuaXRNaWxsaXNlY29uZEZhY3RvcnMsIGkpKSB7CiAgICAgICAgICAgIG1ha2VEdXJhdGlvbkdldHRlcihpLnRvTG93ZXJDYXNlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICBtb21lbnQuZHVyYXRpb24uZm4uYXNNaWxsaXNlY29uZHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYXMoJ21zJyk7CiAgICB9OwogICAgbW9tZW50LmR1cmF0aW9uLmZuLmFzU2Vjb25kcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hcygncycpOwogICAgfTsKICAgIG1vbWVudC5kdXJhdGlvbi5mbi5hc01pbnV0ZXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYXMoJ20nKTsKICAgIH07CiAgICBtb21lbnQuZHVyYXRpb24uZm4uYXNIb3VycyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hcygnaCcpOwogICAgfTsKICAgIG1vbWVudC5kdXJhdGlvbi5mbi5hc0RheXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYXMoJ2QnKTsKICAgIH07CiAgICBtb21lbnQuZHVyYXRpb24uZm4uYXNXZWVrcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hcygnd2Vla3MnKTsKICAgIH07CiAgICBtb21lbnQuZHVyYXRpb24uZm4uYXNNb250aHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYXMoJ00nKTsKICAgIH07CiAgICBtb21lbnQuZHVyYXRpb24uZm4uYXNZZWFycyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hcygneScpOwogICAgfTsKCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgRGVmYXVsdCBMb2NhbGUKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgLy8gU2V0IGRlZmF1bHQgbG9jYWxlLCBvdGhlciBsb2NhbGUgd2lsbCBpbmhlcml0IGZyb20gRW5nbGlzaC4KICAgIG1vbWVudC5sb2NhbGUoJ2VuJywgewogICAgICAgIG9yZGluYWwgOiBmdW5jdGlvbiAobnVtYmVyKSB7CiAgICAgICAgICAgIHZhciBiID0gbnVtYmVyICUgMTAsCiAgICAgICAgICAgICAgICBvdXRwdXQgPSAodG9JbnQobnVtYmVyICUgMTAwIC8gMTApID09PSAxKSA/ICd0aCcgOgogICAgICAgICAgICAgICAgKGIgPT09IDEpID8gJ3N0JyA6CiAgICAgICAgICAgICAgICAoYiA9PT0gMikgPyAnbmQnIDoKICAgICAgICAgICAgICAgIChiID09PSAzKSA/ICdyZCcgOiAndGgnOwogICAgICAgICAgICByZXR1cm4gbnVtYmVyICsgb3V0cHV0OwogICAgICAgIH0KICAgIH0pOwoKICAgIC8qIEVNQkVEX0xPQ0FMRVMgKi8KCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgRXhwb3NpbmcgTW9tZW50CiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgogICAgZnVuY3Rpb24gbWFrZUdsb2JhbChzaG91bGREZXByZWNhdGUpIHsKICAgICAgICAvKmdsb2JhbCBlbmRlcjpmYWxzZSAqLwogICAgICAgIGlmICh0eXBlb2YgZW5kZXIgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgb2xkR2xvYmFsTW9tZW50ID0gZ2xvYmFsU2NvcGUubW9tZW50OwogICAgICAgIGlmIChzaG91bGREZXByZWNhdGUpIHsKICAgICAgICAgICAgZ2xvYmFsU2NvcGUubW9tZW50ID0gZGVwcmVjYXRlKAogICAgICAgICAgICAgICAgICAgICdBY2Nlc3NpbmcgTW9tZW50IHRocm91Z2ggdGhlIGdsb2JhbCBzY29wZSBpcyAnICsKICAgICAgICAgICAgICAgICAgICAnZGVwcmVjYXRlZCwgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhbiB1cGNvbWluZyAnICsKICAgICAgICAgICAgICAgICAgICAncmVsZWFzZS4nLAogICAgICAgICAgICAgICAgICAgIG1vbWVudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2xvYmFsU2NvcGUubW9tZW50ID0gbW9tZW50OwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDb21tb25KUyBtb2R1bGUgaXMgZGVmaW5lZAogICAgaWYgKGhhc01vZHVsZSkgewogICAgICAgIG1vZHVsZS5leHBvcnRzID0gbW9tZW50OwogICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgICAgICBkZWZpbmUoJ21vbWVudCcsIGZ1bmN0aW9uIChyZXF1aXJlLCBleHBvcnRzLCBtb2R1bGUpIHsKICAgICAgICAgICAgaWYgKG1vZHVsZS5jb25maWcgJiYgbW9kdWxlLmNvbmZpZygpICYmIG1vZHVsZS5jb25maWcoKS5ub0dsb2JhbCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgLy8gcmVsZWFzZSB0aGUgZ2xvYmFsIHZhcmlhYmxlCiAgICAgICAgICAgICAgICBnbG9iYWxTY29wZS5tb21lbnQgPSBvbGRHbG9iYWxNb21lbnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBtb21lbnQ7CiAgICAgICAgfSk7CiAgICAgICAgbWFrZUdsb2JhbCh0cnVlKTsKICAgIH0gZWxzZSB7CiAgICAgICAgbWFrZUdsb2JhbCgpOwogICAgfQp9KS5jYWxsKHRoaXMpOwoKLyogYW5ndWxhci1tb21lbnQuanMgLyB2MC44LjIgLyAoYykgMjAxMywgMjAxNCBVcmkgU2hha2VkIC8gTUlUIExpY2VuY2UgKi8KCi8qIGdsb2JhbCBkZWZpbmUgKi8KCihmdW5jdGlvbiAoKSB7CgkndXNlIHN0cmljdCc7CgoJZnVuY3Rpb24gYW5ndWxhck1vbWVudChhbmd1bGFyLCBtb21lbnQpIHsKCgkJLyoqCgkJICogQG5nZG9jIG92ZXJ2aWV3CgkJICogQG5hbWUgYW5ndWxhck1vbWVudAoJCSAqCgkJICogQGRlc2NyaXB0aW9uCgkJICogYW5ndWxhck1vbWVudCBtb2R1bGUgcHJvdmlkZXMgbW9tZW50LmpzIGZ1bmN0aW9uYWxpdHkgZm9yIGFuZ3VsYXIuanMgYXBwcy4KCQkgKi8KCQlyZXR1cm4gYW5ndWxhci5tb2R1bGUoJ2FuZ3VsYXJNb21lbnQnLCBbXSkKCgkJLyoqCgkJICogQG5nZG9jIG9iamVjdAoJCSAqIEBuYW1lIGFuZ3VsYXJNb21lbnQuY29uZmlnOmFuZ3VsYXJNb21lbnRDb25maWcKCQkgKgoJCSAqIEBkZXNjcmlwdGlvbgoJCSAqIENvbW1vbiBjb25maWd1cmF0aW9uIG9mIHRoZSBhbmd1bGFyTW9tZW50IG1vZHVsZQoJCSAqLwoJCQkuY29uc3RhbnQoJ2FuZ3VsYXJNb21lbnRDb25maWcnLCB7CgkJCQkvKioKCQkJCSAqIEBuZ2RvYyBwcm9wZXJ0eQoJCQkJICogQG5hbWUgYW5ndWxhck1vbWVudC5jb25maWcuYW5ndWxhck1vbWVudENvbmZpZyNwcmVwcm9jZXNzCgkJCQkgKiBAcHJvcGVydHlPZiBhbmd1bGFyTW9tZW50LmNvbmZpZzphbmd1bGFyTW9tZW50Q29uZmlnCgkJCQkgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgZGVmYXVsdCBwcmVwcm9jZXNzb3IgdG8gYXBwbHkKCQkJCSAqCgkJCQkgKiBAZGVzY3JpcHRpb24KCQkJCSAqIERlZmluZXMgYSBkZWZhdWx0IHByZXByb2Nlc3NvciB0byBhcHBseSAoZS5nLiAndW5peCcsICdldGMnLCAuLi4pLiBUaGUgZGVmYXVsdCB2YWx1ZSBpcyBudWxsLAoJCQkJICogaS5lLiBubyBwcmVwcm9jZXNzb3Igd2lsbCBiZSBhcHBsaWVkLgoJCQkJICovCgkJCQlwcmVwcm9jZXNzOiBudWxsLCAvLyBlLmcuICd1bml4JywgJ3V0YycsIC4uLgoKCQkJCS8qKgoJCQkJICogQG5nZG9jIHByb3BlcnR5CgkJCQkgKiBAbmFtZSBhbmd1bGFyTW9tZW50LmNvbmZpZy5hbmd1bGFyTW9tZW50Q29uZmlnI3RpbWV6b25lCgkJCQkgKiBAcHJvcGVydHlPZiBhbmd1bGFyTW9tZW50LmNvbmZpZzphbmd1bGFyTW9tZW50Q29uZmlnCgkJCQkgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgZGVmYXVsdCB0aW1lem9uZQoJCQkJICoKCQkJCSAqIEBkZXNjcmlwdGlvbgoJCQkJICogVGhlIGRlZmF1bHQgdGltZXpvbmUgKGUuZy4gJ0V1cm9wZS9Mb25kb24nKS4gRW1wdHkgc3RyaW5nIGJ5IGRlZmF1bHQgKGRvZXMgbm90IGFwcGx5CgkJCQkgKiBhbnkgdGltZXpvbmUgc2hpZnQpLgoJCQkJICovCgkJCQl0aW1lem9uZTogJycsCgoJCQkJLyoqCgkJCQkgKiBAbmdkb2MgcHJvcGVydHkKCQkJCSAqIEBuYW1lIGFuZ3VsYXJNb21lbnQuY29uZmlnLmFuZ3VsYXJNb21lbnRDb25maWcjZm9ybWF0CgkJCQkgKiBAcHJvcGVydHlPZiBhbmd1bGFyTW9tZW50LmNvbmZpZzphbmd1bGFyTW9tZW50Q29uZmlnCgkJCQkgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgcHJlLWNvbnZlcnNpb24gZm9ybWF0IG9mIHRoZSBkYXRlCgkJCQkgKgoJCQkJICogQGRlc2NyaXB0aW9uCgkJCQkgKiBTcGVjaWZ5IHRoZSBmb3JtYXQgb2YgdGhlIGlucHV0IGRhdGUuIEVzc2VudGlhbGx5IGl0J3MgYQoJCQkJICogZGVmYXVsdCBhbmQgc2F2ZXMgeW91IGZyb20gc3BlY2lmeWluZyBhIGZvcm1hdCBpbiBldmVyeQoJCQkJICogZWxlbWVudC4gT3ZlcnJpZGRlbiBieSBlbGVtZW50IGF0dHIuIE51bGwgYnkgZGVmYXVsdC4KCQkJCSAqLwoJCQkJZm9ybWF0OiBudWxsCgkJCX0pCgoJCS8qKgoJCSAqIEBuZ2RvYyBvYmplY3QKCQkgKiBAbmFtZSBhbmd1bGFyTW9tZW50Lm9iamVjdDptb21lbnQKCQkgKgoJCSAqIEBkZXNjcmlwdGlvbgoJCSAqIG1vbWVudCBnbG9iYWwgKGFzIHByb3ZpZGVkIGJ5IHRoZSBtb21lbnQuanMgbGlicmFyeSkKCQkgKi8KCQkJLmNvbnN0YW50KCdtb21lbnQnLCBtb21lbnQpCgoJCS8qKgoJCSAqIEBuZ2RvYyBvYmplY3QKCQkgKiBAbmFtZSBhbmd1bGFyTW9tZW50LmNvbmZpZzphbVRpbWVBZ29Db25maWcKCQkgKiBAbW9kdWxlIGFuZ3VsYXJNb21lbnQKCQkgKgoJCSAqIEBkZXNjcmlwdGlvbgoJCSAqIGNvbmZpZ3VyYXRpb24gc3BlY2lmaWMgdG8gdGhlIGFtVGltZUFnbyBkaXJlY3RpdmUKCQkgKi8KCQkJLmNvbnN0YW50KCdhbVRpbWVBZ29Db25maWcnLCB7CgkJCQkvKioKCQkJCSAqIEBuZ2RvYyBwcm9wZXJ0eQoJCQkJICogQG5hbWUgYW5ndWxhck1vbWVudC5jb25maWcuYW1UaW1lQWdvQ29uZmlnI3dpdGhvdXRTdWZmaXgKCQkJCSAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXJNb21lbnQuY29uZmlnOmFtVGltZUFnb0NvbmZpZwoJCQkJICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdG8gaW5jbHVkZSBhIHN1ZmZpeCBpbiBhbS10aW1lLWFnbyBkaXJlY3RpdmUKCQkJCSAqCgkJCQkgKiBAZGVzY3JpcHRpb24KCQkJCSAqIERlZmF1bHRzIHRvIGZhbHNlLgoJCQkJICovCgkJCQl3aXRob3V0U3VmZml4OiBmYWxzZSwKCgkJCQkvKioKCQkJCSAqIEBuZ2RvYyBwcm9wZXJ0eQoJCQkJICogQG5hbWUgYW5ndWxhck1vbWVudC5jb25maWcuYW1UaW1lQWdvQ29uZmlnI3NlcnZlclRpbWUKCQkJCSAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXJNb21lbnQuY29uZmlnOmFtVGltZUFnb0NvbmZpZwoJCQkJICogQHJldHVybnMge251bWJlcn0gU2VydmVyIHRpbWUgaW4gbWlsbGlzZWNvbmRzIHNpbmNlIHRoZSBlcG9jaAoJCQkJICoKCQkJCSAqIEBkZXNjcmlwdGlvbgoJCQkJICogSWYgc2V0LCB0aW1lIGFnbyB3aWxsIGJlIGNhbGN1bGF0ZWQgcmVsYXRpdmUgdG8gdGhlIGdpdmVuIHZhbHVlLgoJCQkJICogSWYgbnVsbCwgbG9jYWwgdGltZSB3aWxsIGJlIHVzZWQuIERlZmF1bHRzIHRvIG51bGwuCgkJCQkgKi8KCQkJCXNlcnZlclRpbWU6IG51bGwKCQkJfSkKCgkJLyoqCgkJICogQG5nZG9jIGRpcmVjdGl2ZQoJCSAqIEBuYW1lIGFuZ3VsYXJNb21lbnQuZGlyZWN0aXZlOmFtVGltZUFnbwoJCSAqIEBtb2R1bGUgYW5ndWxhck1vbWVudAoJCSAqCgkJICogQHJlc3RyaWN0IEEKCQkgKi8KCQkJLmRpcmVjdGl2ZSgnYW1UaW1lQWdvJywgWyckd2luZG93JywgJ21vbWVudCcsICdhbU1vbWVudCcsICdhbVRpbWVBZ29Db25maWcnLCAnYW5ndWxhck1vbWVudENvbmZpZycsIGZ1bmN0aW9uICgkd2luZG93LCBtb21lbnQsIGFtTW9tZW50LCBhbVRpbWVBZ29Db25maWcsIGFuZ3VsYXJNb21lbnRDb25maWcpIHsKCgkJCQlyZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CgkJCQkJdmFyIGFjdGl2ZVRpbWVvdXQgPSBudWxsOwoJCQkJCXZhciBjdXJyZW50VmFsdWU7CgkJCQkJdmFyIGN1cnJlbnRGb3JtYXQgPSBhbmd1bGFyTW9tZW50Q29uZmlnLmZvcm1hdDsKCQkJCQl2YXIgd2l0aG91dFN1ZmZpeCA9IGFtVGltZUFnb0NvbmZpZy53aXRob3V0U3VmZml4OwoJCQkJCXZhciBsb2NhbERhdGUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCQkJCQl2YXIgcHJlcHJvY2VzcyA9IGFuZ3VsYXJNb21lbnRDb25maWcucHJlcHJvY2VzczsKCQkJCQl2YXIgbW9kZWxOYW1lID0gYXR0ci5hbVRpbWVBZ28ucmVwbGFjZSgvXjo6LywgJycpOwoJCQkJCXZhciBpc0JpbmRPbmNlID0gKGF0dHIuYW1UaW1lQWdvLmluZGV4T2YoJzo6JykgPT09IDApOwoJCQkJCXZhciBpc1RpbWVFbGVtZW50ID0gKCdUSU1FJyA9PT0gZWxlbWVudFswXS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpKTsKCQkJCQl2YXIgdW53YXRjaENoYW5nZXM7CgoJCQkJCWZ1bmN0aW9uIGdldE5vdygpIHsKCQkJCQkJdmFyIG5vdzsKCQkJCQkJaWYgKGFtVGltZUFnb0NvbmZpZy5zZXJ2ZXJUaW1lKSB7CgkJCQkJCQl2YXIgbG9jYWxOb3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCQkJCQkJCXZhciBub3dNaWxsaXMgPSBsb2NhbE5vdyAtIGxvY2FsRGF0ZSArIGFtVGltZUFnb0NvbmZpZy5zZXJ2ZXJUaW1lOwoJCQkJCQkJbm93ID0gbW9tZW50KG5vd01pbGxpcyk7CgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCQlub3cgPSBtb21lbnQoKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gbm93OwoJCQkJCX0KCgkJCQkJZnVuY3Rpb24gY2FuY2VsVGltZXIoKSB7CgkJCQkJCWlmIChhY3RpdmVUaW1lb3V0KSB7CgkJCQkJCQkkd2luZG93LmNsZWFyVGltZW91dChhY3RpdmVUaW1lb3V0KTsKCQkJCQkJCWFjdGl2ZVRpbWVvdXQgPSBudWxsOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlmdW5jdGlvbiB1cGRhdGVUaW1lKG1vbWVudEluc3RhbmNlKSB7CgkJCQkJCWVsZW1lbnQudGV4dChtb21lbnRJbnN0YW5jZS5mcm9tKGdldE5vdygpLCB3aXRob3V0U3VmZml4KSk7CgkJCQkJCWlmICghaXNCaW5kT25jZSkgewoKCQkJCQkJCXZhciBob3dPbGQgPSBNYXRoLmFicyhnZXROb3coKS5kaWZmKG1vbWVudEluc3RhbmNlLCAnbWludXRlJykpOwoJCQkJCQkJdmFyIHNlY29uZHNVbnRpbFVwZGF0ZSA9IDM2MDA7CgkJCQkJCQlpZiAoaG93T2xkIDwgMSkgewoJCQkJCQkJCXNlY29uZHNVbnRpbFVwZGF0ZSA9IDE7CgkJCQkJCQl9IGVsc2UgaWYgKGhvd09sZCA8IDYwKSB7CgkJCQkJCQkJc2Vjb25kc1VudGlsVXBkYXRlID0gMzA7CgkJCQkJCQl9IGVsc2UgaWYgKGhvd09sZCA8IDE4MCkgewoJCQkJCQkJCXNlY29uZHNVbnRpbFVwZGF0ZSA9IDMwMDsKCQkJCQkJCX0KCgkJCQkJCQlhY3RpdmVUaW1lb3V0ID0gJHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKCQkJCQkJCQl1cGRhdGVUaW1lKG1vbWVudEluc3RhbmNlKTsKCQkJCQkJCX0sIHNlY29uZHNVbnRpbFVwZGF0ZSAqIDEwMDApOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlmdW5jdGlvbiB1cGRhdGVEYXRlVGltZUF0dHIodmFsdWUpIHsKCQkJCQkJaWYgKGlzVGltZUVsZW1lbnQpIHsKCQkJCQkJCWVsZW1lbnQuYXR0cignZGF0ZXRpbWUnLCB2YWx1ZSk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWZ1bmN0aW9uIHVwZGF0ZU1vbWVudCgpIHsKCQkJCQkJY2FuY2VsVGltZXIoKTsKCQkJCQkJaWYgKGN1cnJlbnRWYWx1ZSkgewoJCQkJCQkJdmFyIG1vbWVudFZhbHVlID0gYW1Nb21lbnQucHJlcHJvY2Vzc0RhdGUoY3VycmVudFZhbHVlLCBwcmVwcm9jZXNzLCBjdXJyZW50Rm9ybWF0KTsKCQkJCQkJCXVwZGF0ZVRpbWUobW9tZW50VmFsdWUpOwoJCQkJCQkJdXBkYXRlRGF0ZVRpbWVBdHRyKG1vbWVudFZhbHVlLnRvSVNPU3RyaW5nKCkpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQl1bndhdGNoQ2hhbmdlcyA9IHNjb3BlLiR3YXRjaChtb2RlbE5hbWUsIGZ1bmN0aW9uICh2YWx1ZSkgewoJCQkJCQlpZiAoKHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcpIHx8ICh2YWx1ZSA9PT0gbnVsbCkgfHwgKHZhbHVlID09PSAnJykpIHsKCQkJCQkJCWNhbmNlbFRpbWVyKCk7CgkJCQkJCQlpZiAoY3VycmVudFZhbHVlKSB7CgkJCQkJCQkJZWxlbWVudC50ZXh0KCcnKTsKCQkJCQkJCQl1cGRhdGVEYXRlVGltZUF0dHIoJycpOwoJCQkJCQkJCWN1cnJlbnRWYWx1ZSA9IG51bGw7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm47CgkJCQkJCX0KCgkJCQkJCWN1cnJlbnRWYWx1ZSA9IHZhbHVlOwoJCQkJCQl1cGRhdGVNb21lbnQoKTsKCgkJCQkJCWlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIGlzQmluZE9uY2UpIHsKCQkJCQkJCXVud2F0Y2hDaGFuZ2VzKCk7CgkJCQkJCX0KCQkJCQl9KTsKCgkJCQkJaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKGF0dHIuYW1XaXRob3V0U3VmZml4KSkgewoJCQkJCQlzY29wZS4kd2F0Y2goYXR0ci5hbVdpdGhvdXRTdWZmaXgsIGZ1bmN0aW9uICh2YWx1ZSkgewoJCQkJCQkJaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSB7CgkJCQkJCQkJd2l0aG91dFN1ZmZpeCA9IHZhbHVlOwoJCQkJCQkJCXVwZGF0ZU1vbWVudCgpOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQl3aXRob3V0U3VmZml4ID0gYW1UaW1lQWdvQ29uZmlnLndpdGhvdXRTdWZmaXg7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCX0KCgkJCQkJYXR0ci4kb2JzZXJ2ZSgnYW1Gb3JtYXQnLCBmdW5jdGlvbiAoZm9ybWF0KSB7CgkJCQkJCWlmICh0eXBlb2YgZm9ybWF0ICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQkJY3VycmVudEZvcm1hdCA9IGZvcm1hdDsKCQkJCQkJCXVwZGF0ZU1vbWVudCgpOwoJCQkJCQl9CgkJCQkJfSk7CgoJCQkJCWF0dHIuJG9ic2VydmUoJ2FtUHJlcHJvY2VzcycsIGZ1bmN0aW9uIChuZXdWYWx1ZSkgewoJCQkJCQlwcmVwcm9jZXNzID0gbmV3VmFsdWU7CgkJCQkJCXVwZGF0ZU1vbWVudCgpOwoJCQkJCX0pOwoKCQkJCQlzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewoJCQkJCQljYW5jZWxUaW1lcigpOwoJCQkJCX0pOwoKCQkJCQlzY29wZS4kb24oJ2FtTW9tZW50OmxvY2FsZUNoYW5nZWQnLCBmdW5jdGlvbiAoKSB7CgkJCQkJCXVwZGF0ZU1vbWVudCgpOwoJCQkJCX0pOwoJCQkJfTsKCQkJfV0pCgoJCS8qKgoJCSAqIEBuZ2RvYyBzZXJ2aWNlCgkJICogQG5hbWUgYW5ndWxhck1vbWVudC5zZXJ2aWNlLmFtTW9tZW50CgkJICogQG1vZHVsZSBhbmd1bGFyTW9tZW50CgkJICovCgkJCS5zZXJ2aWNlKCdhbU1vbWVudCcsIFsnbW9tZW50JywgJyRyb290U2NvcGUnLCAnJGxvZycsICdhbmd1bGFyTW9tZW50Q29uZmlnJywgZnVuY3Rpb24gKG1vbWVudCwgJHJvb3RTY29wZSwgJGxvZywgYW5ndWxhck1vbWVudENvbmZpZykgewoJCQkJdmFyIHRoYXQgPSB0aGlzOwoJCQkJLyoqCgkJCQkgKiBAbmdkb2MgcHJvcGVydHkKCQkJCSAqIEBuYW1lIGFuZ3VsYXJNb21lbnQ6YW1Nb21lbnQjcHJlcHJvY2Vzc29ycwoJCQkJICogQG1vZHVsZSBhbmd1bGFyTW9tZW50CgkJCQkgKgoJCQkJICogQGRlc2NyaXB0aW9uCgkJCQkgKiBEZWZpbmVzIHRoZSBwcmVwcm9jZXNzb3JzIGZvciB0aGUgcHJlcHJvY2Vzc0RhdGUgbWV0aG9kLiBCeSBkZWZhdWx0LCB0aGUgZm9sbG93aW5nIHByZXByb2Nlc3NvcnMKCQkJCSAqIGFyZSBkZWZpbmVkOiB1dGMsIHVuaXguCgkJCQkgKi8KCQkJCXRoaXMucHJlcHJvY2Vzc29ycyA9IHsKCQkJCQl1dGM6IG1vbWVudC51dGMsCgkJCQkJdW5peDogbW9tZW50LnVuaXgKCQkJCX07CgoJCQkJLyoqCgkJCQkgKiBAbmdkb2MgZnVuY3Rpb24KCQkJCSAqIEBuYW1lIGFuZ3VsYXJNb21lbnQuc2VydmljZS5hbU1vbWVudCNjaGFuZ2VMb2NhbGUKCQkJCSAqIEBtZXRob2RPZiBhbmd1bGFyTW9tZW50LnNlcnZpY2UuYW1Nb21lbnQKCQkJCSAqCgkJCQkgKiBAZGVzY3JpcHRpb24KCQkJCSAqIENoYW5nZXMgdGhlIGxvY2FsZSBmb3IgbW9tZW50LmpzIGFuZCB1cGRhdGVzIGFsbCB0aGUgYW0tdGltZS1hZ28gZGlyZWN0aXZlIGluc3RhbmNlcwoJCQkJICogd2l0aCB0aGUgbmV3IGxvY2FsZS4gQWxzbyBicm9hZGNhc3RzIGEgYGFtTW9tZW50OmxvY2FsZUNoYW5nZWRgIGV2ZW50IG9uICRyb290U2NvcGUuCgkJCQkgKgoJCQkJICogQHBhcmFtIHtzdHJpbmd9IGxvY2FsZSAyLWxldHRlciBsYW5ndWFnZSBjb2RlIChlLmcuIGVuLCBlcywgcnUsIGV0Yy4pCgkJCQkgKi8KCQkJCXRoaXMuY2hhbmdlTG9jYWxlID0gZnVuY3Rpb24gKGxvY2FsZSkgewoJCQkJCXZhciByZXN1bHQgPSAobW9tZW50LmxvY2FsZXx8bW9tZW50LmxhbmcpKGxvY2FsZSk7CgkJCQkJaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKGxvY2FsZSkpIHsKCQkJCQkJJHJvb3RTY29wZS4kYnJvYWRjYXN0KCdhbU1vbWVudDpsb2NhbGVDaGFuZ2VkJyk7CgoJCQkJCQkvLyBUaGUgZm9sbG93aW5nIGV2ZW50IGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhbiB1cGNvbWluZwoJCQkJCQkvLyBtYWpvciByZWxlYXNlLgoJCQkJCQkkcm9vdFNjb3BlLiRicm9hZGNhc3QoJ2FtTW9tZW50Omxhbmd1YWdlQ2hhbmdlJyk7CgkJCQkJfQoJCQkJCXJldHVybiByZXN1bHQ7CgkJCQl9OwoKCQkJCS8qKgoJCQkJICogQG5nZG9jIGZ1bmN0aW9uCgkJCQkgKiBAbmFtZSBhbmd1bGFyTW9tZW50LnNlcnZpY2UuYW1Nb21lbnQjY2hhbmdlTGFuZ3VhZ2UKCQkJCSAqIEBtZXRob2RPZiBhbmd1bGFyTW9tZW50LnNlcnZpY2UuYW1Nb21lbnQKCQkJCSAqIEBkZXByZWNhdGVkIFBsZWFzZSB1c2UgY2hhbmdlTG9jYWxlKCkgaW5zdGVhZC4KCQkJCSAqCgkJCQkgKiBAZGVzY3JpcHRpb24KCQkJCSAqIERlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgY2hhbmdlTG9jYWxlKCkgaW5zdGVhZC4KCQkJCSAqLwoJCQkJdGhpcy5jaGFuZ2VMYW5ndWFnZSA9IGZ1bmN0aW9uIChsYW5nKSB7CgkJCQkJJGxvZy53YXJuKCdhbmd1bGFyLW1vbWVudDogVXNhZ2Ugb2YgYW1Nb21lbnQuY2hhbmdlTGFuZ3VhZ2UoKSBpcyBkZXByZWNhdGVkLiBQbGVhc2UgdXNlIGNoYW5nZUxvY2FsZSgpJyk7CgkJCQkJcmV0dXJuIHRoYXQuY2hhbmdlTG9jYWxlKGxhbmcpOwoJCQkJfTsKCgkJCQkvKioKCQkJCSAqIEBuZ2RvYyBmdW5jdGlvbgoJCQkJICogQG5hbWUgYW5ndWxhck1vbWVudC5zZXJ2aWNlLmFtTW9tZW50I3ByZXByb2Nlc3NEYXRlCgkJCQkgKiBAbWV0aG9kT2YgYW5ndWxhck1vbWVudC5zZXJ2aWNlLmFtTW9tZW50CgkJCQkgKgoJCQkJICogQGRlc2NyaXB0aW9uCgkJCQkgKiBQcmVwcm9jZXNzIGEgZ2l2ZW4gdmFsdWUgYW5kIGNvbnZlcnQgaXQgaW50byBhIE1vbWVudCBpbnN0YW5jZSBhcHByb3ByaWF0ZSBmb3IgdXNlIGluIHRoZQoJCQkJICogYW0tdGltZS1hZ28gZGlyZWN0aXZlIGFuZCB0aGUgZmlsdGVycy4KCQkJCSAqCgkJCQkgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBiZSBwcmVwcm9jZXNzZWQKCQkJCSAqIEBwYXJhbSB7c3RyaW5nfSBwcmVwcm9jZXNzIFRoZSBuYW1lIG9mIHRoZSBwcmVwcm9jZXNzb3IgdGhlIGFwcGx5IChlLmcuIHV0YywgdW5peCkKCQkJCSAqIEBwYXJhbSB7c3RyaW5nPX0gZm9ybWF0IFNwZWNpZmllcyBob3cgdG8gcGFyc2UgdGhlIHZhbHVlIChzZWUge0BsaW5rIGh0dHA6Ly9tb21lbnRqcy5jb20vZG9jcy8jL3BhcnNpbmcvc3RyaW5nLWZvcm1hdC99KQoJCQkJICogQHJldHVybiB7TW9tZW50fSBBIHZhbHVlIHRoYXQgY2FuIGJlIHBhcnNlZCBieSB0aGUgbW9tZW50IGxpYnJhcnkKCQkJCSAqLwoJCQkJdGhpcy5wcmVwcm9jZXNzRGF0ZSA9IGZ1bmN0aW9uICh2YWx1ZSwgcHJlcHJvY2VzcywgZm9ybWF0KSB7CgkJCQkJaWYgKGFuZ3VsYXIuaXNVbmRlZmluZWQocHJlcHJvY2VzcykpIHsKCQkJCQkJcHJlcHJvY2VzcyA9IGFuZ3VsYXJNb21lbnRDb25maWcucHJlcHJvY2VzczsKCQkJCQl9CgkJCQkJaWYgKHRoaXMucHJlcHJvY2Vzc29yc1twcmVwcm9jZXNzXSkgewoJCQkJCQlyZXR1cm4gdGhpcy5wcmVwcm9jZXNzb3JzW3ByZXByb2Nlc3NdKHZhbHVlLCBmb3JtYXQpOwoJCQkJCX0KCQkJCQlpZiAocHJlcHJvY2VzcykgewoJCQkJCQkkbG9nLndhcm4oJ2FuZ3VsYXItbW9tZW50OiBJZ25vcmluZyB1bnN1cHBvcnRlZCB2YWx1ZSBmb3IgcHJlcHJvY2VzczogJyArIHByZXByb2Nlc3MpOwoJCQkJCX0KCQkJCQlpZiAoIWlzTmFOKHBhcnNlRmxvYXQodmFsdWUpKSAmJiBpc0Zpbml0ZSh2YWx1ZSkpIHsKCQkJCQkJLy8gTWlsbGlzZWNvbmRzIHNpbmNlIHRoZSBlcG9jaAoJCQkJCQlyZXR1cm4gbW9tZW50KHBhcnNlSW50KHZhbHVlLCAxMCkpOwoJCQkJCX0KCQkJCQkvLyBlbHNlIGp1c3QgcmV0dXJucyB0aGUgdmFsdWUgYXMtaXMuCgkJCQkJcmV0dXJuIG1vbWVudCh2YWx1ZSwgZm9ybWF0KTsKCQkJCX07CgoJCQkJLyoqCgkJCQkgKiBAbmdkb2MgZnVuY3Rpb24KCQkJCSAqIEBuYW1lIGFuZ3VsYXJNb21lbnQuc2VydmljZS5hbU1vbWVudCNhcHBseVRpbWV6b25lCgkJCQkgKiBAbWV0aG9kT2YgYW5ndWxhck1vbWVudC5zZXJ2aWNlLmFtTW9tZW50CgkJCQkgKgoJCQkJICogQGRlc2NyaXB0aW9uCgkJCQkgKiBBcHBseSBhIHRpbWV6b25lIG9udG8gYSBnaXZlbiBtb21lbnQgb2JqZWN0IC0gaWYgbW9tZW50LXRpbWV6b25lLmpzIGlzIGluY2x1ZGVkCgkJCQkgKiBPdGhlcndpc2UsIGl0J2xsIG5vdCBhcHBseSBhbnkgdGltZXpvbmUgc2hpZnQuCgkJCQkgKgoJCQkJICogQHBhcmFtIHtNb21lbnR9IGFNb21lbnQgYSBtb21lbnQoKSBpbnN0YW5jZSB0byBhcHBseSB0aGUgdGltZXpvbmUgc2hpZnQgdG8KCQkJCSAqIEByZXR1cm5zIHtNb21lbnR9IFRoZSBnaXZlbiBtb21lbnQgd2l0aCB0aGUgdGltZXpvbmUgc2hpZnQgYXBwbGllZAoJCQkJICovCgkJCQl0aGlzLmFwcGx5VGltZXpvbmUgPSBmdW5jdGlvbiAoYU1vbWVudCkgewoJCQkJCXZhciB0aW1lem9uZSA9IGFuZ3VsYXJNb21lbnRDb25maWcudGltZXpvbmU7CgkJCQkJaWYgKGFNb21lbnQgJiYgdGltZXpvbmUpIHsKCQkJCQkJaWYgKGFNb21lbnQudHopIHsKCQkJCQkJCWFNb21lbnQgPSBhTW9tZW50LnR6KHRpbWV6b25lKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCSRsb2cud2FybignYW5ndWxhci1tb21lbnQ6IHRpbWV6b25lIHNwZWNpZmllZCBidXQgbW9tZW50LnR6KCkgaXMgdW5kZWZpbmVkLiBEaWQgeW91IGZvcmdldCB0byBpbmNsdWRlIG1vbWVudC10aW1lem9uZS5qcz8nKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlyZXR1cm4gYU1vbWVudDsKCQkJCX07CgkJCX1dKQoKCQkvKioKCQkgKiBAbmdkb2MgZmlsdGVyCgkJICogQG5hbWUgYW5ndWxhck1vbWVudC5maWx0ZXI6YW1DYWxlbmRhcgoJCSAqIEBtb2R1bGUgYW5ndWxhck1vbWVudAoJCSAqLwoJCQkuZmlsdGVyKCdhbUNhbGVuZGFyJywgWydtb21lbnQnLCAnYW1Nb21lbnQnLCBmdW5jdGlvbiAobW9tZW50LCBhbU1vbWVudCkgewoJCQkJcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSwgcHJlcHJvY2VzcykgewoJCQkJCWlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IHZhbHVlID09PSBudWxsKSB7CgkJCQkJCXJldHVybiAnJzsKCQkJCQl9CgoJCQkJCXZhbHVlID0gYW1Nb21lbnQucHJlcHJvY2Vzc0RhdGUodmFsdWUsIHByZXByb2Nlc3MpOwoJCQkJCXZhciBkYXRlID0gbW9tZW50KHZhbHVlKTsKCQkJCQlpZiAoIWRhdGUuaXNWYWxpZCgpKSB7CgkJCQkJCXJldHVybiAnJzsKCQkJCQl9CgoJCQkJCXJldHVybiBhbU1vbWVudC5hcHBseVRpbWV6b25lKGRhdGUpLmNhbGVuZGFyKCk7CgkJCQl9OwoJCQl9XSkKCgkJLyoqCgkJICogQG5nZG9jIGZpbHRlcgoJCSAqIEBuYW1lIGFuZ3VsYXJNb21lbnQuZmlsdGVyOmFtRGF0ZUZvcm1hdAoJCSAqIEBtb2R1bGUgYW5ndWxhck1vbWVudAoJCSAqIEBmdW5jdGlvbgoJCSAqLwoJCQkuZmlsdGVyKCdhbURhdGVGb3JtYXQnLCBbJ21vbWVudCcsICdhbU1vbWVudCcsIGZ1bmN0aW9uIChtb21lbnQsIGFtTW9tZW50KSB7CgkJCQlyZXR1cm4gZnVuY3Rpb24gKHZhbHVlLCBmb3JtYXQsIHByZXByb2Nlc3MpIHsKCQkJCQlpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJyB8fCB2YWx1ZSA9PT0gbnVsbCkgewoJCQkJCQlyZXR1cm4gJyc7CgkJCQkJfQoKCQkJCQl2YWx1ZSA9IGFtTW9tZW50LnByZXByb2Nlc3NEYXRlKHZhbHVlLCBwcmVwcm9jZXNzKTsKCQkJCQl2YXIgZGF0ZSA9IG1vbWVudCh2YWx1ZSk7CgkJCQkJaWYgKCFkYXRlLmlzVmFsaWQoKSkgewoJCQkJCQlyZXR1cm4gJyc7CgkJCQkJfQoKCQkJCQlyZXR1cm4gYW1Nb21lbnQuYXBwbHlUaW1lem9uZShkYXRlKS5mb3JtYXQoZm9ybWF0KTsKCQkJCX07CgkJCX1dKQoKCQkvKioKCQkgKiBAbmdkb2MgZmlsdGVyCgkJICogQG5hbWUgYW5ndWxhck1vbWVudC5maWx0ZXI6YW1EdXJhdGlvbkZvcm1hdAoJCSAqIEBtb2R1bGUgYW5ndWxhck1vbWVudAoJCSAqIEBmdW5jdGlvbgoJCSAqLwoJCQkuZmlsdGVyKCdhbUR1cmF0aW9uRm9ybWF0JywgWydtb21lbnQnLCBmdW5jdGlvbiAobW9tZW50KSB7CgkJCQlyZXR1cm4gZnVuY3Rpb24gKHZhbHVlLCBmb3JtYXQsIHN1ZmZpeCkgewoJCQkJCWlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IHZhbHVlID09PSBudWxsKSB7CgkJCQkJCXJldHVybiAnJzsKCQkJCQl9CgoJCQkJCXJldHVybiBtb21lbnQuZHVyYXRpb24odmFsdWUsIGZvcm1hdCkuaHVtYW5pemUoc3VmZml4KTsKCQkJCX07CgkJCX1dKTsKCX0KCglpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CgkJZGVmaW5lKCdhbmd1bGFyLW1vbWVudCcsIFsnYW5ndWxhcicsICdtb21lbnQnXSwgYW5ndWxhck1vbWVudCk7Cgl9IGVsc2UgewoJCWFuZ3VsYXJNb21lbnQoYW5ndWxhciwgd2luZG93Lm1vbWVudCk7Cgl9Cn0pKCk7CgoKLyoKUHJvamVjdDogYW5ndWxhci1nYW50dCBmb3IgQW5ndWxhckpTCkF1dGhvcjogTWFyY28gU2Nod2VpZ2hhdXNlcgpDb250cmlidXRvcnM6IFLDqW1pIEFsdmVyZ25hdApMaWNlbnNlOiBNSVQuCkdpdGh1YjogaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXItZ2FudHQvYW5ndWxhci1nYW50dAoqLwondXNlIHN0cmljdCc7CgoKdmFyIGdhbnR0ID0gYW5ndWxhci5tb2R1bGUoJ2dhbnR0JywgWydnYW50dFRlbXBsYXRlcycsICdhbmd1bGFyTW9tZW50J10pOwpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0JywgWydHYW50dCcsICdnYW50dE9wdGlvbnMnLCAnR2FudHRDYWxlbmRhcicsICdtb21lbnQnLCAnZ2FudHRNb3VzZU9mZnNldCcsICdnYW50dERlYm91bmNlJywgJ2dhbnR0RW5hYmxlTmdBbmltYXRlJywgZnVuY3Rpb24oR2FudHQsIE9wdGlvbnMsIENhbGVuZGFyLCBtb21lbnQsIG1vdXNlT2Zmc2V0LCBkZWJvdW5jZSwgZW5hYmxlTmdBbmltYXRlKSB7CiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgaWYgKHRBdHRycy50ZW1wbGF0ZVVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3RlbXBsYXRlL2RlZmF1bHQuZ2FudHQudG1wbC5odG1sJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0QXR0cnMudGVtcGxhdGVVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHNjb3BlOiB7CiAgICAgICAgICAgIHNvcnRNb2RlOiAnPT8nLCAvLyBQb3NzaWJsZSBtb2RlczogJ25hbWUnLCAnZGF0ZScsICdjdXN0b20nCiAgICAgICAgICAgIGZpbHRlclRhc2s6ICc9PycsIC8vIFRhc2sgZmlsdGVyIGFzIGEgYW5ndWxhckpTIGV4cHJlc3Npb24KICAgICAgICAgICAgZmlsdGVyVGFza0NvbXBhcmF0b3I6ICc9PycsIC8vIENvbXBhcmF0b3IgdG8gdXNlIGZvciB0aGUgdGFzayBmaWx0ZXIKICAgICAgICAgICAgZmlsdGVyUm93OiAnPT8nLCAvLyBSb3cgZmlsdGVyIGFzIGEgYW5ndWxhckpTIGV4cHJlc3Npb24KICAgICAgICAgICAgZmlsdGVyUm93Q29tcGFyYXRvcjogJz0/JywgLy8gQ29tcGFyYXRvciB0byB1c2UgZm9yIHRoZSByb3cgZmlsdGVyCiAgICAgICAgICAgIHZpZXdTY2FsZTogJz0/JywgLy8gUG9zc2libGUgc2NhbGVzOiAnaG91cicsICdkYXknLCAnd2VlaycsICdtb250aCcKICAgICAgICAgICAgY29sdW1uV2lkdGg6ICc9PycsIC8vIERlZmluZXMgdGhlIHNpemUgb2YgYSBjb2x1bW4sIDEgYmVpbmcgMWVtIHBlciB1bml0IChob3VyIG9yIGRheSwgLi4gZGVwZW5kaW5nIG9uIHNjYWxlKSwKICAgICAgICAgICAgYWxsb3dMYWJlbHNSZXNpemluZzogJz0/JywgLy8gU2V0IHRvIHRydWUgaWYgdGhlIHVzZXIgc2hvdWxkIGJlIGFibGUgdG8gcmVzaXplIHRoZSBsYWJlbCBzZWN0aW9uLgogICAgICAgICAgICBmcm9tRGF0ZTogJz0/JywgLy8gSWYgbm90IHNwZWNpZmllZCB3aWxsIHVzZSB0aGUgZWFybGllc3QgdGFzayBkYXRlIChub3RlOiBhcyBvZiBub3cgdGhpcyBjYW4gb25seSBleHBhbmQgbm90IHNocmluaykKICAgICAgICAgICAgdG9EYXRlOiAnPT8nLCAvLyBJZiBub3Qgc3BlY2lmaWVkIHdpbGwgdXNlIHRoZSBsYXRlc3QgdGFzayBkYXRlIChub3RlOiBhcyBvZiBub3cgdGhpcyBjYW4gb25seSBleHBhbmQgbm90IHNocmluaykKICAgICAgICAgICAgY3VycmVudERhdGVWYWx1ZTogJz0/JywgLy8gSWYgc3BlY2lmaWVkLCB0aGUgY3VycmVudCBkYXRlIHdpbGwgYmUgZGlzcGxheWVkCiAgICAgICAgICAgIGN1cnJlbnREYXRlOiAnPT8nLCAvLyBUaGUgZGlzcGxheSBvZiBjdXJyZW50RGF0ZSAoJ25vbmUnLCAnbGluZScgb3IgJ2NvbHVtbicpLgogICAgICAgICAgICBhdXRvRXhwYW5kOiAnPT8nLCAvLyBTZXQgdGhpcyBib3RoLCBsZWZ0IG9yIHJpZ2h0IGlmIHRoZSBkYXRlIHJhbmdlIHNoYWxsIGV4cGFuZCBpZiB0aGUgdXNlciBzY3JvbGwgdG8gdGhlIGxlZnQgb3IgcmlnaHQgZW5kLiBPdGhlcndpc2Ugc2V0IHRvIGZhbHNlIG9yIG5vbmUuCiAgICAgICAgICAgIHRhc2tPdXRPZlJhbmdlOiAnPT8nLCAvLyBTZXQgdGhpcyB0byBleHBhbmQgb3IgdHJ1bmNhdGUgdG8gZGVmaW5lIHRoZSBiZWhhdmlvciBvZiB0YXNrcyBnb2luZyBvdXQgb2YgdmlzaWJsZSByYW5nZS4KICAgICAgICAgICAgbWF4SGVpZ2h0OiAnPT8nLCAvLyBEZWZpbmUgdGhlIG1heGltdW0gaGVpZ2h0IG9mIHRoZSBHYW50dCBpbiBQWC4gPiAwIHRvIGFjdGl2YXRlIG1heCBoZWlnaHQgYmVoYXZpb3VyLgogICAgICAgICAgICBsYWJlbHNXaWR0aDogJz0/JywgLy8gRGVmaW5lIHRoZSB3aWR0aCBvZiB0aGUgbGFiZWxzIHNlY3Rpb24uIENoYW5nZXMgd2hlbiB0aGUgdXNlciBpcyByZXNpemluZyB0aGUgbGFiZWxzIHdpZHRoCiAgICAgICAgICAgIHNob3dMYWJlbHNDb2x1bW46ICc9PycsIC8vIFdoZXRoZXIgdG8gc2hvdyBjb2x1bW4gd2l0aCBsYWJlbHMgb3Igbm90LiBEZWZhdWx0ICh0cnVlKQogICAgICAgICAgICBzaG93VG9vbHRpcHM6ICc9PycsIC8vIFRydWUgd2hlbiB0b29sdGlwcyBzaGFsbCBiZSBlbmFibGVkLiBEZWZhdWx0ICh0cnVlKQogICAgICAgICAgICBoZWFkZXJzOiAnPT8nLCAvLyBBbiBhcnJheSBvZiB1bml0cyBmb3IgaGVhZGVycy4KICAgICAgICAgICAgaGVhZGVyc0Zvcm1hdHM6ICc9PycsIC8vIEFuIGFycmF5IG9mIGNvcnJlc3BvbmRpbmcgZm9ybWF0cyBmb3IgaGVhZGVycy4KICAgICAgICAgICAgdGltZUZyYW1lczogJz0/JywKICAgICAgICAgICAgZGF0ZUZyYW1lczogJz0/JywKICAgICAgICAgICAgdGltZUZyYW1lc1dvcmtpbmdNb2RlOiAnPT8nLAogICAgICAgICAgICB0aW1lRnJhbWVzTm9uV29ya2luZ01vZGU6ICc9PycsCiAgICAgICAgICAgIHRvb2x0aXBEYXRlRm9ybWF0OiAnPT8nLAogICAgICAgICAgICB0aW1lc3BhbnM6ICc9PycsCiAgICAgICAgICAgIGNvbHVtbk1hZ25ldDogJz0/JywKICAgICAgICAgICAgZGF0YTogJz0/JywKICAgICAgICAgICAgYXBpOiAnPT8nLAogICAgICAgICAgICBvcHRpb25zOiAnPT8nCiAgICAgICAgfSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgZm9yICh2YXIgb3B0aW9uIGluICRzY29wZS5vcHRpb25zKSB7CiAgICAgICAgICAgICAgICAkc2NvcGVbb3B0aW9uXSA9ICRzY29wZS5vcHRpb25zW29wdGlvbl07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIE9wdGlvbnMuaW5pdGlhbGl6ZSgkc2NvcGUpOwoKICAgICAgICAgICAgLy8gRGlzYWJsZSBhbmltYXRpb24gaWYgbmdBbmltYXRlIGlzIHByZXNlbnQsIGFzIGl0IGRyb3BzIGRvd24gcGVyZm9ybWFuY2UuCiAgICAgICAgICAgIGVuYWJsZU5nQW5pbWF0ZShmYWxzZSwgJGVsZW1lbnQpOwoKICAgICAgICAgICAgJHNjb3BlLmdhbnR0ID0gbmV3IEdhbnR0KCRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICB0aGlzLmdhbnR0ID0gJHNjb3BlLmdhbnR0OwogICAgICAgIH1dLAogICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50KSB7CiAgICAgICAgICAgIC8vIEdhbnR0IGlzIGluaXRpYWxpemVkLiBTaWduYWwgdGhhdCB0aGUgR2FudHQgaXMgcmVhZHkuCiAgICAgICAgICAgIHNjb3BlLmdhbnR0LmFwaS5jb3JlLnJhaXNlLnJlYWR5KHNjb3BlLmdhbnR0LmFwaSk7CgogICAgICAgICAgICBzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0Jywgc2NvcGUsIGVsZW1lbnQpOwogICAgICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5kZXN0cm95KCdnYW50dCcsIHNjb3BlLCBlbGVtZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfTsKfV0pOwoKCi8vIFRoaXMgZmlsZSBpcyBhZGFwdGVkIGZyb20gQW5ndWxhciBVSSBuZ0dyaWQgcHJvamVjdAovLyBNSVQgTGljZW5zZQovLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci11aS9uZy1ncmlkL2Jsb2IvdjMuMC4wLXJjLjEyL3NyYy9qcy9jb3JlL2ZhY3Rvcmllcy9HcmlkQXBpLmpzCihmdW5jdGlvbigpIHsKCiAgICBhbmd1bGFyLm1vZHVsZSgnZ2FudHQnKQogICAgICAgIC5mYWN0b3J5KCdHYW50dEFwaScsIFsnJHEnLCAnJHJvb3RTY29wZScsICdnYW50dFV0aWxzJywKICAgICAgICAgICAgZnVuY3Rpb24oJHEsICRyb290U2NvcGUsIHV0aWxzKSB7CiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgZ2FudHQuY2xhc3M6R2FudHRBcGkKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbiBHYW50dEFwaSBwcm92aWRlcyB0aGUgYWJpbGl0eSB0byByZWdpc3RlciBwdWJsaWMgbWV0aG9kcyBldmVudHMgaW5zaWRlIHRoZSBnYW50dCBhbmQgYWxsb3cKICAgICAgICAgICAgICAgICAqIGZvciBvdGhlciBjb21wb25lbnRzIHRvIHVzZSB0aGUgYXBpIHZpYSBmZWF0dXJlTmFtZS5tZXRob2ROYW1lIGFuZCBmZWF0dXJlTmFtZS5vbi5ldmVudE5hbWUoZnVuY3Rpb24oYXJncyl7fQogICAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGdhbnR0IGdhbnR0IHRoYXQgb3ducyBhcGkKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgdmFyIEdhbnR0QXBpID0gZnVuY3Rpb24gR2FudHRBcGkoZ2FudHQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbnR0ID0gZ2FudHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5saXN0ZW5lcnMgPSBbXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwaUlkID0gdXRpbHMubmV3SWQoKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIGdhbnR0LmNsYXNzOnN1cHByZXNzRXZlbnRzCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgZ2FudHQuY2xhc3M6R2FudHRBcGkKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbiBVc2VkIHRvIGV4ZWN1dGUgYSBmdW5jdGlvbiB3aGlsZSBkaXNhYmxpbmcgdGhlIHNwZWNpZmllZCBldmVudCBsaXN0ZW5lcnMuCiAgICAgICAgICAgICAgICAgKiBEaXNhYmxlcyB0aGUgbGlzdGVuZXJGdW5jdGlvbnMsIGV4ZWN1dGVzIHRoZSBjYWxsYmFja0ZuLCBhbmQgdGhlbiBlbmFibGVzCiAgICAgICAgICAgICAgICAgKiB0aGUgbGlzdGVuZXJGdW5jdGlvbnMgYWdhaW4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBsaXN0ZW5lckZ1bmNzIGxpc3RlbmVyRnVuYyBvciBhcnJheSBvZiBsaXN0ZW5lckZ1bmNzIHRvIHN1cHByZXNzLiBUaGVzZSBtdXN0IGJlIHRoZSBzYW1lCiAgICAgICAgICAgICAgICAgKiBmdW5jdGlvbnMgdGhhdCB3ZXJlIHVzZWQgaW4gdGhlIC5vbi5ldmVudE5hbWUgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gY2FsbEJhY2tGbiBmdW5jdGlvbiB0byBleGVjdXRlCiAgICAgICAgICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICAgIHZhciBuYXZpZ2F0ZSA9IGZ1bmN0aW9uIChuZXdSb3dDb2wsIG9sZFJvd0NvbCl7CiAgICAgICAgICAgICAgICAgKiAgICAgICAvL2RvIHNvbWV0aGluZyBvbiBuYXZpZ2F0ZQogICAgICAgICAgICAgICAgICogICAgfQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgIGdhbnR0QXBpLmNlbGxOYXYub24ubmF2aWdhdGUoc2NvcGUsbmF2aWdhdGUpOwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgICAvL2NhbGwgdGhlIHNjcm9sbFRvIGV2ZW50IGFuZCBzdXBwcmVzcyBvdXIgbmF2aWdhdGUgbGlzdGVuZXIKICAgICAgICAgICAgICAgICAqICAgIC8vc2Nyb2xsVG8gd2lsbCBzdGlsbCByYWlzZSB0aGUgZXZlbnQgZm9yIG90aGVyIGxpc3RlbmVycwogICAgICAgICAgICAgICAgICogICAgZ2FudHRBcGkuc3VwcHJlc3NFdmVudHMobmF2aWdhdGUsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgKiAgICAgICBnYW50dEFwaS5jZWxsTmF2LnNjcm9sbFRvKGFSb3csIGFDb2wpOwogICAgICAgICAgICAgICAgICogICAgfSk7CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIEdhbnR0QXBpLnByb3RvdHlwZS5zdXBwcmVzc0V2ZW50cyA9IGZ1bmN0aW9uKGxpc3RlbmVyRnVuY3MsIGNhbGxCYWNrRm4pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxpc3RlbmVycyA9IGFuZ3VsYXIuaXNBcnJheShsaXN0ZW5lckZ1bmNzKSA/IGxpc3RlbmVyRnVuY3MgOiBbbGlzdGVuZXJGdW5jc107CgogICAgICAgICAgICAgICAgICAgIC8vZmluZCBhbGwgcmVnaXN0ZXJlZCBsaXN0ZW5lcnMKICAgICAgICAgICAgICAgICAgICB2YXIgZm91bmRMaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbihsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kTGlzdGVuZXJzID0gc2VsZi5saXN0ZW5lcnMuZmlsdGVyKGZ1bmN0aW9uKGxzdG5yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbCA9PT0gbHN0bnIuaGFuZGxlcjsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vZGVyZWdpc3RlciBhbGwgdGhlIGxpc3RlbmVycwogICAgICAgICAgICAgICAgICAgIGZvdW5kTGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24obCkgewogICAgICAgICAgICAgICAgICAgICAgICBsLmRlcmVnKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIGNhbGxCYWNrRm4oKTsKCiAgICAgICAgICAgICAgICAgICAgLy9yZXJlZ2lzdGVyIGFsbCB0aGUgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICAgICAgZm91bmRMaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbihsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGwuZGVyZWcgPSByZWdpc3RlckV2ZW50V2l0aEFuZ3VsYXIobC5zY29wZSwgbC5ldmVudElkLCBsLmhhbmRsZXIsIHNlbGYuZ2FudHQpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIHJlZ2lzdGVyRXZlbnQKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBnYW50dC5jbGFzczpHYW50dEFwaQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uIFJlZ2lzdGVycyBhIG5ldyBldmVudCBmb3IgdGhlIGdpdmVuIGZlYXR1cmUKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmZWF0dXJlTmFtZSBuYW1lIG9mIHRoZSBmZWF0dXJlIHRoYXQgcmFpc2VzIHRoZSBldmVudAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50TmFtZSAgbmFtZSBvZiB0aGUgZXZlbnQKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgR2FudHRBcGkucHJvdG90eXBlLnJlZ2lzdGVyRXZlbnQgPSBmdW5jdGlvbihmZWF0dXJlTmFtZSwgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgIGlmICghc2VsZltmZWF0dXJlTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZltmZWF0dXJlTmFtZV0gPSB7fTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBmZWF0dXJlID0gc2VsZltmZWF0dXJlTmFtZV07CiAgICAgICAgICAgICAgICAgICAgaWYgKCFmZWF0dXJlLm9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmUub24gPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgZmVhdHVyZS5yYWlzZSA9IHt9OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50SWQgPSAnZXZlbnQ6Z2FudHQ6JyArIHRoaXMuYXBpSWQgKyAnOicgKyBmZWF0dXJlTmFtZSArICc6JyArIGV2ZW50TmFtZTsKCiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZS5yYWlzZVtldmVudE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdC5hcHBseSgkcm9vdFNjb3BlLCBbZXZlbnRJZF0uY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlLm9uW2V2ZW50TmFtZV0gPSBmdW5jdGlvbihzY29wZSwgaGFuZGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGVyZWcgPSByZWdpc3RlckV2ZW50V2l0aEFuZ3VsYXIoc2NvcGUsIGV2ZW50SWQsIGhhbmRsZXIsIHNlbGYuZ2FudHQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy90cmFjayBvdXIgbGlzdGVuZXIgc28gd2UgY2FuIHR1cm4gb2ZmIGFuZCBvbgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXIgPSB7aGFuZGxlcjogaGFuZGxlciwgZGVyZWc6IGRlcmVnLCBldmVudElkOiBldmVudElkLCBzY29wZTogc2NvcGV9OwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vZGVzdHJveSB0cmFja2luZyB3aGVuIHNjb3BlIGlzIGRlc3Ryb3llZAogICAgICAgICAgICAgICAgICAgICAgICAvL3dhbnRlZCB0byByZW1vdmUgdGhlIGxpc3RlbmVyIGZyb20gdGhlIGFycmF5IGJ1dCBhbmd1bGFyIGRvZXMKICAgICAgICAgICAgICAgICAgICAgICAgLy9zdHJhbmdlIHRoaW5ncyBpbiBzY29wZS4kZGVzdHJveSBzbyBJIGNvdWxkIG5vdCBhY2Nlc3MgdGhlIGxpc3RlbmVyIGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyLmRlcmVnID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyLmhhbmRsZXIgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIuZXZlbnRJZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lci5zY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRXaXRoQW5ndWxhcihzY29wZSwgZXZlbnRJZCwgaGFuZGxlciwgZ2FudHQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuJG9uKGV2ZW50SWQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3Muc3BsaWNlKDAsIDEpOyAvL3JlbW92ZSBldnQgYXJndW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5hcHBseShnYW50dC5hcGksIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSByZWdpc3RlckV2ZW50c0Zyb21PYmplY3QKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBnYW50dC5jbGFzczpHYW50dEFwaQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uIFJlZ2lzdGVycyBmZWF0dXJlcyBhbmQgZXZlbnRzIGZyb20gYSBzaW1wbGUgb2JqZWN0TWFwLgogICAgICAgICAgICAgICAgICogZXZlbnRPYmplY3RNYXAgbXVzdCBiZSBpbiB0aGlzIGZvcm1hdCAobXVsdGlwbGUgZmVhdHVyZXMgYWxsb3dlZCkKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiB7ZmVhdHVyZU5hbWU6CiAgICAgICAgICAgICAgICAgKiAgICAgICAgewogICAgICAgICAgICAgICAgICogICAgICAgICAgZXZlbnROYW1lT25lOmZ1bmN0aW9uKGFyZ3Mpe30sCiAgICAgICAgICAgICAgICAgKiAgICAgICAgICBldmVudE5hbWVUd286ZnVuY3Rpb24oYXJncyl7fQogICAgICAgICAgICAgICAgICogICAgICAgIH0KICAgICAgICAgICAgICAgICAqICB9CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBldmVudE9iamVjdE1hcCBtYXAgb2YgZmVhdHVyZS9ldmVudCBuYW1lcwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBHYW50dEFwaS5wcm90b3R5cGUucmVnaXN0ZXJFdmVudHNGcm9tT2JqZWN0ID0gZnVuY3Rpb24oZXZlbnRPYmplY3RNYXApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZlYXR1cmVzID0gW107CiAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGV2ZW50T2JqZWN0TWFwLCBmdW5jdGlvbihmZWF0UHJvcCwgZmVhdFByb3BOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmZWF0dXJlID0ge25hbWU6IGZlYXRQcm9wTmFtZSwgZXZlbnRzOiBbXX07CiAgICAgICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChmZWF0UHJvcCwgZnVuY3Rpb24ocHJvcCwgcHJvcE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmUuZXZlbnRzLnB1c2gocHJvcE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgZmVhdHVyZXMucHVzaChmZWF0dXJlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZXMuZm9yRWFjaChmdW5jdGlvbihmZWF0dXJlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmUuZXZlbnRzLmZvckVhY2goZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucmVnaXN0ZXJFdmVudChmZWF0dXJlLm5hbWUsIGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgcmVnaXN0ZXJNZXRob2QKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBnYW50dC5jbGFzczpHYW50dEFwaQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uIFJlZ2lzdGVycyBhIG5ldyBldmVudCBmb3IgdGhlIGdpdmVuIGZlYXR1cmUKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmZWF0dXJlTmFtZSBuYW1lIG9mIHRoZSBmZWF0dXJlCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kTmFtZSAgbmFtZSBvZiB0aGUgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gY2FsbEJhY2tGbiBmdW5jdGlvbiB0byBleGVjdXRlCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gdGhpc0FyZyBiaW5kcyBjYWxsQmFja0ZuICd0aGlzJyB0byB0aGlzQXJnLiAgRGVmYXVsdHMgdG8gZ2FudHRBcGkuZ2FudHQKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgR2FudHRBcGkucHJvdG90eXBlLnJlZ2lzdGVyTWV0aG9kID0gZnVuY3Rpb24oZmVhdHVyZU5hbWUsIG1ldGhvZE5hbWUsIGNhbGxCYWNrRm4sIHRoaXNBcmcpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXNbZmVhdHVyZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbZmVhdHVyZU5hbWVdID0ge307CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgZmVhdHVyZSA9IHRoaXNbZmVhdHVyZU5hbWVdOwoKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlW21ldGhvZE5hbWVdID0gdXRpbHMuY3JlYXRlQm91bmRlZFdyYXBwZXIodGhpc0FyZyB8fCB0aGlzLmdhbnR0LCBjYWxsQmFja0ZuKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIHJlZ2lzdGVyTWV0aG9kc0Zyb21PYmplY3QKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBnYW50dC5jbGFzczpHYW50dEFwaQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uIFJlZ2lzdGVycyBmZWF0dXJlcyBhbmQgbWV0aG9kcyBmcm9tIGEgc2ltcGxlIG9iamVjdE1hcC4KICAgICAgICAgICAgICAgICAqIGV2ZW50T2JqZWN0TWFwIG11c3QgYmUgaW4gdGhpcyBmb3JtYXQgKG11bHRpcGxlIGZlYXR1cmVzIGFsbG93ZWQpCiAgICAgICAgICAgICAgICAgKiA8YnI+CiAgICAgICAgICAgICAgICAgKiB7ZmVhdHVyZU5hbWU6CiAgICAgICAgICAgICAgICAgKiAgICAgICAgewogICAgICAgICAgICAgICAgICogICAgICAgICAgbWV0aG9kTmFtZU9uZTpmdW5jdGlvbihhcmdzKXt9LAogICAgICAgICAgICAgICAgICogICAgICAgICAgbWV0aG9kTmFtZVR3bzpmdW5jdGlvbihhcmdzKXt9CiAgICAgICAgICAgICAgICAgKiAgICAgICAgfQogICAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGV2ZW50T2JqZWN0TWFwIG1hcCBvZiBmZWF0dXJlL2V2ZW50IG5hbWVzCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gdGhpc0FyZyBiaW5kcyB0aGlzIHRvIHRoaXNBcmcgZm9yIGFsbCBmdW5jdGlvbnMuICBEZWZhdWx0cyB0byBHYW50dEFwaS5nYW50dAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBHYW50dEFwaS5wcm90b3R5cGUucmVnaXN0ZXJNZXRob2RzRnJvbU9iamVjdCA9IGZ1bmN0aW9uKG1ldGhvZE1hcCwgdGhpc0FyZykgewogICAgICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgICAgICAgICB2YXIgZmVhdHVyZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2gobWV0aG9kTWFwLCBmdW5jdGlvbihmZWF0UHJvcCwgZmVhdFByb3BOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmZWF0dXJlID0ge25hbWU6IGZlYXRQcm9wTmFtZSwgbWV0aG9kczogW119OwogICAgICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goZmVhdFByb3AsIGZ1bmN0aW9uKHByb3AsIHByb3BOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlLm1ldGhvZHMucHVzaCh7bmFtZTogcHJvcE5hbWUsIGZuOiBwcm9wfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlcy5wdXNoKGZlYXR1cmUpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlcy5mb3JFYWNoKGZ1bmN0aW9uKGZlYXR1cmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmVhdHVyZS5tZXRob2RzLmZvckVhY2goZnVuY3Rpb24obWV0aG9kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnJlZ2lzdGVyTWV0aG9kKGZlYXR1cmUubmFtZSwgbWV0aG9kLm5hbWUsIG1ldGhvZC5mbiwgdGhpc0FyZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgcmV0dXJuIEdhbnR0QXBpOwoKICAgICAgICAgICAgfV0pOwoKfSkoKTsKCgpnYW50dC5mYWN0b3J5KCdnYW50dE9wdGlvbnMnLCBbJ21vbWVudCcsIGZ1bmN0aW9uKG1vbWVudCkgewogICAgcmV0dXJuIHtpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucy5hcGkgPSBvcHRpb25zLmFwaSB8fCBhbmd1bGFyLm5vb3AoKTsKCiAgICAgICAgb3B0aW9ucy5kYXRhID0gb3B0aW9ucy5kYXRhIHx8IFtdOwoKICAgICAgICBvcHRpb25zLnRpbWVzcGFucyA9IG9wdGlvbnMudGltZXNwYW5zIHx8IFtdOwoKICAgICAgICBvcHRpb25zLnNvcnRNb2RlID0gb3B0aW9ucy5zb3J0TW9kZSB8fCAnbmFtZSc7CgogICAgICAgIG9wdGlvbnMuZmlsdGVyVGFzayA9IG9wdGlvbnMuZmlsdGVyVGFzayB8fCB1bmRlZmluZWQ7CiAgICAgICAgb3B0aW9ucy5maWx0ZXJUYXNrQ29tcGFyYXRvciA9IG9wdGlvbnMuZmlsdGVyVGFza0NvbXBhcmF0b3IgfHwgdW5kZWZpbmVkOwoKICAgICAgICBvcHRpb25zLmZpbHRlclJvdyA9IG9wdGlvbnMuZmlsdGVyUm93IHx8IHVuZGVmaW5lZDsKICAgICAgICBvcHRpb25zLmZpbHRlclJvd0NvbXBhcmF0b3IgPSBvcHRpb25zLmZpbHRlclJvd0NvbXBhcmF0b3IgfHwgdW5kZWZpbmVkOwoKICAgICAgICBvcHRpb25zLnZpZXdTY2FsZSA9IG9wdGlvbnMudmlld1NjYWxlIHx8ICdkYXknOwogICAgICAgIG9wdGlvbnMuY29sdW1uTWFnbmV0ID0gb3B0aW9ucy5jb2x1bW5NYWduZXQgfHwgJzE1IG1pbnV0ZXMnOwogICAgICAgIG9wdGlvbnMuY29sdW1uV2lkdGggPSBvcHRpb25zLmNvbHVtbldpZHRoIHx8IHVuZGVmaW5lZDsKCiAgICAgICAgb3B0aW9ucy5mcm9tRGF0ZSA9IG9wdGlvbnMuZnJvbURhdGUgfHwgdW5kZWZpbmVkOwogICAgICAgIG9wdGlvbnMudG9EYXRlID0gb3B0aW9ucy50b0RhdGUgfHwgdW5kZWZpbmVkOwoKICAgICAgICBvcHRpb25zLmFsbG93TGFiZWxzUmVzaXppbmcgPSBvcHRpb25zLmFsbG93TGFiZWxzUmVzaXppbmcgIT09IHVuZGVmaW5lZCA/ICEhb3B0aW9ucy5hbGxvd0xhYmVsc1Jlc2l6aW5nIDogdHJ1ZTsKCiAgICAgICAgb3B0aW9ucy5jdXJyZW50RGF0ZSA9IG9wdGlvbnMuY3VycmVudERhdGUgfHwgJ2xpbmUnOwogICAgICAgIG9wdGlvbnMuY3VycmVudERhdGVWYWx1ZSA9IG9wdGlvbnMuY3VycmVudERhdGVWYWx1ZSB8fCBtb21lbnQoKTsKCiAgICAgICAgb3B0aW9ucy5hdXRvRXhwYW5kID0gb3B0aW9ucy5hdXRvRXhwYW5kIHx8ICdub25lJzsKICAgICAgICBvcHRpb25zLnRhc2tPdXRPZlJhbmdlID0gb3B0aW9ucy50YXNrT3V0T2ZSYW5nZSB8fCAndHJ1bmNhdGUnOwoKICAgICAgICBvcHRpb25zLm1heEhlaWdodCA9IG9wdGlvbnMubWF4SGVpZ2h0IHx8IDA7CgogICAgICAgIG9wdGlvbnMubGFiZWxzV2lkdGggPSBvcHRpb25zLmxhYmVsc1dpZHRoIHx8IHVuZGVmaW5lZDsKCiAgICAgICAgb3B0aW9ucy5zaG93TGFiZWxzQ29sdW1uID0gb3B0aW9ucy5zaG93TGFiZWxzQ29sdW1uICE9PSB1bmRlZmluZWQgPyAhIW9wdGlvbnMuc2hvd0xhYmVsc0NvbHVtbiA6IHRydWU7CiAgICAgICAgb3B0aW9ucy5zaG93VG9vbHRpcHMgPSBvcHRpb25zLnNob3dUb29sdGlwcyAhPT0gdW5kZWZpbmVkID8gISFvcHRpb25zLnNob3dUb29sdGlwcyA6IHRydWU7CgogICAgICAgIG9wdGlvbnMuaGVhZGVycyA9IG9wdGlvbnMuaGVhZGVycyB8fCB1bmRlZmluZWQ7CiAgICAgICAgb3B0aW9ucy5oZWFkZXJzRm9ybWF0cyA9IG9wdGlvbnMuaGVhZGVyc0Zvcm1hdHMgfHwgdW5kZWZpbmVkOwoKICAgICAgICBvcHRpb25zLnRpbWVGcmFtZXMgPSBvcHRpb25zLnRpbWVGcmFtZXMgfHwgW107CiAgICAgICAgb3B0aW9ucy5kYXRlRnJhbWVzID0gb3B0aW9ucy5kYXRlRnJhbWVzIHx8IFtdOwoKICAgICAgICBvcHRpb25zLnRpbWVGcmFtZXNXb3JraW5nTW9kZSA9IG9wdGlvbnMudGltZUZyYW1lc1dvcmtpbmdNb2RlIHx8ICdoaWRkZW4nOwogICAgICAgIG9wdGlvbnMudGltZUZyYW1lc05vbldvcmtpbmdNb2RlID0gb3B0aW9ucy50aW1lRnJhbWVzTm9uV29ya2luZ01vZGUgfHwgJ3Zpc2libGUnOwoKICAgICAgICBvcHRpb25zLnRvb2x0aXBEYXRlRm9ybWF0ID0gb3B0aW9ucy50b29sdGlwRGF0ZUZvcm1hdCB8fCAnTU1NIERELCBISDptbSc7CgogICAgICAgIHJldHVybiBvcHRpb25zOwogICAgfQogICAgfTsKfV0pOwoKCi8qKgogKiBDYWxlbmRhciBmYWN0b3J5IGlzIHVzZWQgdG8gZGVmaW5lIHdvcmtpbmcgcGVyaW9kcywgbm9uIHdvcmtpbmcgcGVyaW9kcywgYW5kIG90aGVyIHNwZWNpZmljIHBlcmlvZCBvZiB0aW1lLAogKiBhbmQgcmV0cmlldmUgZWZmZWN0aXZlIHRpbWVGcmFtZXMgZm9yIGVhY2ggZGF5IG9mIHRoZSBnYW50dC4KICovCmdhbnR0LmZhY3RvcnkoJ0dhbnR0Q2FsZW5kYXInLCBbJyRmaWx0ZXInLCBmdW5jdGlvbigkZmlsdGVyKSB7CiAgICAvKioKICAgICAqIFRpbWVGcmFtZSByZXByZXNlbnRzIHRpbWUgZnJhbWUgaW4gYW55IGRheS4gcGFyYW1ldGVycyBhcmUgZ2l2ZW4gdXNpbmcgb3B0aW9ucyBvYmplY3QuCiAgICAgKgogICAgICogQHBhcmFtIHttb21lbnR8c3RyaW5nfSBzdGFydCBzdGFydCBvZiB0aW1lRnJhbWUuIElmIGEgc3RyaW5nIGlzIGdpdmVuLCBpdCB3aWxsIGJlIHBhcnNlZCBhcyBhIG1vbWVudC4KICAgICAqIEBwYXJhbSB7bW9tZW50fHN0cmluZ30gZW5kIGVuZCBvZiB0aW1lRnJhbWUuIElmIGEgc3RyaW5nIGlzIGdpdmVuLCBpdCB3aWxsIGJlIHBhcnNlZCBhcyBhIG1vbWVudC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gd29ya2luZyBpcyB0aGlzIHRpbWVGcmFtZSBmbGFnZ2VkIGFzIHdvcmtpbmcuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGRlZmF1bHQgaXMgdGhpcyB0aW1lRnJhbWUgd2lsbCBiZSB1c2VkIGFzIGRlZmF1bHQuCiAgICAgKiBAcGFyYW0ge2NvbG9yfSBjc3MgY29sb3IgYXR0YWNoZWQgdG8gdGhpcyB0aW1lRnJhbWUuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NlcyBjc3MgY2xhc3NlcyBhdHRhY2hlZCB0byB0aGlzIHRpbWVGcmFtZS4KICAgICAqCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqLwogICAgdmFyIFRpbWVGcmFtZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3RhcnQgPSBvcHRpb25zLnN0YXJ0OwogICAgICAgIHRoaXMuZW5kID0gb3B0aW9ucy5lbmQ7CiAgICAgICAgdGhpcy53b3JraW5nID0gb3B0aW9ucy53b3JraW5nOwogICAgICAgIHRoaXMuZGVmYXVsdCA9IG9wdGlvbnMuZGVmYXVsdDsKICAgICAgICB0aGlzLmNvbG9yID0gb3B0aW9ucy5jb2xvcjsKICAgICAgICB0aGlzLmNsYXNzZXMgPSBvcHRpb25zLmNsYXNzZXM7CiAgICB9OwoKCiAgICBUaW1lRnJhbWUucHJvdG90eXBlLmdldER1cmF0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZW5kLmRpZmYodGhpcy5zdGFydCwgJ21pbGxpc2Vjb25kcycpOwogICAgfTsKCiAgICBUaW1lRnJhbWUucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBUaW1lRnJhbWUodGhpcyk7CiAgICB9OwoKICAgIC8qKgogICAgICogVGltZUZyYW1lTWFwcGluZyBkZWZpbmVzIGhvdyB0aW1lRnJhbWVzIHdpbGwgYmUgcGxhY2VkIGZvciBlYWNoIGRheXMuIHBhcmFtZXRlcnMgYXJlIGdpdmVuIHVzaW5nIG9wdGlvbnMgb2JqZWN0LgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGZ1bmMgYSBmdW5jdGlvbiB3aXRoIGRhdGUgcGFyYW1ldGVyLCB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkIGZvciBlYWNoIGRpc3RpbmN0IGRheSBvZiB0aGUgZ2FudHQuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMgZnVuY3Rpb24gbXVzdCByZXR1cm4gYW4gYXJyYXkgb2YgdGltZUZyYW1lIG5hbWVzIHRvIGFwcGx5LgogICAgICogQGNvbnN0cnVjdG9yCiAgICAgKi8KICAgIHZhciBUaW1lRnJhbWVNYXBwaW5nID0gZnVuY3Rpb24oZnVuYykgewogICAgICAgIHRoaXMuZnVuYyA9IGZ1bmM7CiAgICB9OwoKICAgIFRpbWVGcmFtZU1hcHBpbmcucHJvdG90eXBlLmdldFRpbWVGcmFtZXMgPSBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgdmFyIHJldCA9IHRoaXMuZnVuYyhkYXRlKTsKICAgICAgICBpZiAoIShyZXQgaW5zdGFuY2VvZiBBcnJheSkpIHsKICAgICAgICAgICAgcmV0ID0gW3JldF07CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXQ7CiAgICB9OwoKICAgIFRpbWVGcmFtZU1hcHBpbmcucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBUaW1lRnJhbWVNYXBwaW5nKHRoaXMuZnVuYyk7CiAgICB9OwoKICAgIC8qKgogICAgICogQSBEYXRlRnJhbWUgaXMgZGF0ZSByYW5nZSB0aGF0IHdpbGwgdXNlIGEgc3BlY2lmaWMgVGltZUZyYW1lTWFwcGluZywgY29uZmlndXJlZCB1c2luZyBhIGZ1bmN0aW9uIChldmFsdWF0b3IpLAogICAgICogYSBkYXRlIChkYXRlKSBvciBhIGRhdGUgcmFuZ2UgKHN0YXJ0LCBlbmQpLiBwYXJhbWV0ZXJzIGFyZSBnaXZlbiB1c2luZyBvcHRpb25zIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBldmFsdWF0b3IgYSBmdW5jdGlvbiB3aXRoIGRhdGUgcGFyYW1ldGVyLCB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkIGZvciBlYWNoIGRpc3RpbmN0IGRheSBvZiB0aGUgZ2FudHQuCiAgICAgKiAgICAgICAgICAgICAgICAgICB0aGlzIGZ1bmN0aW9uIG11c3QgcmV0dXJuIGEgYm9vbGVhbiByZXByZXNlbnRpbmcgbWF0Y2hpbmcgb2YgdGhpcyBkYXRlRnJhbWUgb3Igbm90LgogICAgICogQHBhcmFtIHttb21lbnR9IGRhdGUgZGF0ZSBvZiBkYXRlRnJhbWUuCiAgICAgKiBAcGFyYW0ge21vbWVudH0gc3RhcnQgc3RhcnQgb2YgZGF0ZSBmcmFtZS4KICAgICAqIEBwYXJhbSB7bW9tZW50fSBlbmQgZW5kIG9mIGRhdGUgZnJhbWUuCiAgICAgKiBAcGFyYW0ge2FycmF5fSB0YXJnZXRzIGFycmF5IG9mIFRpbWVGcmFtZU1hcHBpbmdzL1RpbWVGcmFtZXMgbmFtZXMgdG8gdXNlIGZvciB0aGlzIGRhdGUgZnJhbWUuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGRlZmF1bHQgaXMgdGhpcyBkYXRlRnJhbWUgd2lsbCBiZSB1c2VkIGFzIGRlZmF1bHQuCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqLwogICAgdmFyIERhdGVGcmFtZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICB0aGlzLmV2YWx1YXRvciA9IG9wdGlvbnMuZXZhbHVhdG9yOwogICAgICAgIGlmIChvcHRpb25zLmRhdGUpIHsKICAgICAgICAgICAgdGhpcy5zdGFydCA9IG1vbWVudChvcHRpb25zLmRhdGUpLnN0YXJ0T2YoJ2RheScpOwogICAgICAgICAgICB0aGlzLmVuZCA9IG1vbWVudChvcHRpb25zLmRhdGUpLmVuZE9mKCdkYXknKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnN0YXJ0ID0gb3B0aW9ucy5zdGFydDsKICAgICAgICAgICAgdGhpcy5lbmQgPSBvcHRpb25zLmVuZDsKICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMudGFyZ2V0cyBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0cyA9IG9wdGlvbnMudGFyZ2V0czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnRhcmdldHMgPSBbb3B0aW9ucy50YXJnZXRzXTsKICAgICAgICB9CiAgICAgICAgdGhpcy5kZWZhdWx0ID0gb3B0aW9ucy5kZWZhdWx0OwogICAgfTsKCiAgICBEYXRlRnJhbWUucHJvdG90eXBlLmRhdGVNYXRjaCA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICBpZiAodGhpcy5ldmFsdWF0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdG9yKGRhdGUpOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGFydCAmJiB0aGlzLmVuZCkgewogICAgICAgICAgICByZXR1cm4gZGF0ZSA+PSB0aGlzLnN0YXJ0ICYmIGRhdGUgPD0gdGhpcy5lbmQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH07CgogICAgRGF0ZUZyYW1lLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgRGF0ZUZyYW1lKHRoaXMpOwogICAgfTsKCgoKICAgIC8qKgogICAgICogUmVnaXN0ZXIgVGltZUZyYW1lLCBUaW1lRnJhbWVNYXBwaW5nIGFuZCBEYXRlTWFwcGluZyBvYmplY3RzIGludG8gQ2FsZW5kYXIgb2JqZWN0LAogICAgICogYW5kIHVzZSBDYWxlbmRhciNnZXRUaW1lRnJhbWVzKGRhdGUpIGZ1bmN0aW9uIHRvIHJldHJpZXZlIGVmZmVjdGl2ZSB0aW1lRnJhbWVzIGZvciBhIHNwZWNpZmljIGRheS4KICAgICAqCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqLwogICAgdmFyIENhbGVuZGFyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy50aW1lRnJhbWVzID0ge307CiAgICAgICAgdGhpcy50aW1lRnJhbWVNYXBwaW5ncyA9IHt9OwogICAgICAgIHRoaXMuZGF0ZUZyYW1lcyA9IHt9OwogICAgfTsKCiAgICAvKioKICAgICAqIFJlbW92ZSBhbGwgb2JqZWN0cy4KICAgICAqLwogICAgQ2FsZW5kYXIucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy50aW1lRnJhbWVzID0ge307CiAgICAgICAgdGhpcy50aW1lRnJhbWVNYXBwaW5ncyA9IHt9OwogICAgICAgIHRoaXMuZGF0ZUZyYW1lcyA9IHt9OwogICAgfTsKCiAgICAvKioKICAgICAqIFJlZ2lzdGVyIFRpbWVGcmFtZSBvYmplY3RzLgogICAgICoKICAgICAqIEBwYXJhbSB7b2JqZWN0fSB0aW1lRnJhbWVzIHdpdGggbmFtZXMgb2YgdGltZUZyYW1lcyBmb3Iga2V5cyBhbmQgVGltZUZyYW1lIG9iamVjdHMgZm9yIHZhbHVlcy4KICAgICAqLwogICAgQ2FsZW5kYXIucHJvdG90eXBlLnJlZ2lzdGVyVGltZUZyYW1lcyA9IGZ1bmN0aW9uKHRpbWVGcmFtZXMpIHsKICAgICAgICBhbmd1bGFyLmZvckVhY2godGltZUZyYW1lcywgZnVuY3Rpb24odGltZUZyYW1lLCBuYW1lKSB7CiAgICAgICAgICAgIHRoaXMudGltZUZyYW1lc1tuYW1lXSA9IG5ldyBUaW1lRnJhbWUodGltZUZyYW1lKTsKICAgICAgICB9LCB0aGlzKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBSZW1vdmVzIFRpbWVGcmFtZSBvYmplY3RzLgogICAgICoKICAgICAqIEBwYXJhbSB7YXJyYXl9IHRpbWVGcmFtZXMgbmFtZXMgb2YgdGltZUZyYW1lcyB0byByZW1vdmUuCiAgICAgKi8KICAgIENhbGVuZGFyLnByb3RvdHlwZS5yZW1vdmVUaW1lRnJhbWVzID0gZnVuY3Rpb24odGltZUZyYW1lcykgewogICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aW1lRnJhbWVzLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnRpbWVGcmFtZXNbbmFtZV07CiAgICAgICAgfSwgdGhpcyk7CiAgICB9OwoKICAgIC8qKgogICAgICogUmVtb3ZlIGFsbCBUaW1lRnJhbWUgb2JqZWN0cy4KICAgICAqLwogICAgQ2FsZW5kYXIucHJvdG90eXBlLmNsZWFyVGltZUZyYW1lcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudGltZUZyYW1lcyA9IHt9OwogICAgfTsKCiAgICAvKioKICAgICAqIFJlZ2lzdGVyIFRpbWVGcmFtZU1hcHBpbmcgb2JqZWN0cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge29iamVjdH0gbWFwcGluZ3Mgb2JqZWN0IHdpdGggbmFtZXMgb2YgdGltZUZyYW1lcyBtYXBwaW5ncyBmb3Iga2V5cyBhbmQgVGltZUZyYW1lTWFwcGluZyBvYmplY3RzIGZvciB2YWx1ZXMuCiAgICAgKi8KICAgIENhbGVuZGFyLnByb3RvdHlwZS5yZWdpc3RlclRpbWVGcmFtZU1hcHBpbmdzID0gZnVuY3Rpb24obWFwcGluZ3MpIHsKICAgICAgICBhbmd1bGFyLmZvckVhY2gobWFwcGluZ3MsIGZ1bmN0aW9uKHRpbWVGcmFtZU1hcHBpbmcsIG5hbWUpIHsKICAgICAgICAgICAgdGhpcy50aW1lRnJhbWVNYXBwaW5nc1tuYW1lXSA9IG5ldyBUaW1lRnJhbWVNYXBwaW5nKHRpbWVGcmFtZU1hcHBpbmcpOwogICAgICAgIH0sIHRoaXMpOwogICAgfTsKCiAgICAvKioKICAgICAqIFJlbW92ZXMgVGltZUZyYW1lTWFwcGluZyBvYmplY3RzLgogICAgICoKICAgICAqIEBwYXJhbSB7YXJyYXl9IG1hcHBpbmdzIG5hbWVzIG9mIHRpbWVGcmFtZSBtYXBwaW5ncyB0byByZW1vdmUuCiAgICAgKi8KICAgIENhbGVuZGFyLnByb3RvdHlwZS5yZW1vdmVUaW1lRnJhbWVNYXBwaW5ncyA9IGZ1bmN0aW9uKG1hcHBpbmdzKSB7CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKG1hcHBpbmdzLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnRpbWVGcmFtZU1hcHBpbmdzW25hbWVdOwogICAgICAgIH0sIHRoaXMpOwogICAgfTsKCiAgICAvKioKICAgICAqIFJlbW92ZXMgYWxsIFRpbWVGcmFtZU1hcHBpbmcgb2JqZWN0cy4KICAgICAqLwogICAgQ2FsZW5kYXIucHJvdG90eXBlLmNsZWFyVGltZUZyYW1lTWFwcGluZ3MgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnRpbWVGcmFtZU1hcHBpbmdzID0ge307CiAgICB9OwoKICAgIC8qKgogICAgICogUmVnaXN0ZXIgRGF0ZUZyYW1lIG9iamVjdHMuCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGVGcmFtZXMgb2JqZWN0IHdpdGggbmFtZXMgb2YgZGF0ZUZyYW1lcyBmb3Iga2V5cyBhbmQgRGF0ZUZyYW1lIG9iamVjdHMgZm9yIHZhbHVlcy4KICAgICAqLwogICAgQ2FsZW5kYXIucHJvdG90eXBlLnJlZ2lzdGVyRGF0ZUZyYW1lcyA9IGZ1bmN0aW9uKGRhdGVGcmFtZXMpIHsKICAgICAgICBhbmd1bGFyLmZvckVhY2goZGF0ZUZyYW1lcywgZnVuY3Rpb24oZGF0ZUZyYW1lLCBuYW1lKSB7CiAgICAgICAgICAgIHRoaXMuZGF0ZUZyYW1lc1tuYW1lXSA9IG5ldyBEYXRlRnJhbWUoZGF0ZUZyYW1lKTsKICAgICAgICB9LCB0aGlzKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBSZW1vdmUgRGF0ZUZyYW1lIG9iamVjdHMuCiAgICAgKgogICAgICogQHBhcmFtIHthcnJheX0gbWFwcGluZ3MgbmFtZXMgb2YgZGF0ZSBmcmFtZXMgdG8gcmVtb3ZlLgogICAgICovCiAgICBDYWxlbmRhci5wcm90b3R5cGUucmVtb3ZlRGF0ZUZyYW1lcyA9IGZ1bmN0aW9uKGRhdGVGcmFtZXMpIHsKICAgICAgICBhbmd1bGFyLmZvckVhY2goZGF0ZUZyYW1lcywgZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBkZWxldGUgdGhpcy5kYXRlRnJhbWVzW25hbWVdOwogICAgICAgIH0sIHRoaXMpOwogICAgfTsKCiAgICAvKioKICAgICAqIFJlbW92ZXMgYWxsIERhdGVGcmFtZSBvYmplY3RzLgogICAgICovCiAgICBDYWxlbmRhci5wcm90b3R5cGUuY2xlYXJEYXRlRnJhbWVzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5kYXRlRnJhbWVzID0ge307CiAgICB9OwoKICAgIHZhciBmaWx0ZXJEYXRlRnJhbWVzID0gZnVuY3Rpb24oaW5wdXREYXRlRnJhbWVzLCBkYXRlKSB7CiAgICAgICAgdmFyIGRhdGVGcmFtZXMgPSBbXTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goaW5wdXREYXRlRnJhbWVzLCBmdW5jdGlvbihkYXRlRnJhbWUpIHsKICAgICAgICAgICAgaWYgKGRhdGVGcmFtZS5kYXRlTWF0Y2goZGF0ZSkpIHsKICAgICAgICAgICAgICAgIGRhdGVGcmFtZXMucHVzaChkYXRlRnJhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgaWYgKGRhdGVGcmFtZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChpbnB1dERhdGVGcmFtZXMsIGZ1bmN0aW9uKGRhdGVGcmFtZSkgewogICAgICAgICAgICAgICAgaWYgKGRhdGVGcmFtZS5kZWZhdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZUZyYW1lcy5wdXNoKGRhdGVGcmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGF0ZUZyYW1lczsKICAgIH07CgogICAgLyoqCiAgICAgKiBSZXRyaWV2ZXMgVGltZUZyYW1lIG9iamVjdHMgZm9yIGEgZ2l2ZW4gZGF0ZSwgdXNpbmcgd2hvbGUgY29uZmlndXJhdGlvbiBmb3IgdGhpcyBDYWxlbmRhciBvYmplY3QuCiAgICAgKgogICAgICogQHBhcmFtIHttb21lbnR9IGRhdGUKICAgICAqCiAgICAgKiBAcmV0dXJuIHthcnJheX0gYW4gYXJyYXkgb2YgVGltZUZyYW1lIG9iamVjdHMuCiAgICAgKi8KICAgIENhbGVuZGFyLnByb3RvdHlwZS5nZXRUaW1lRnJhbWVzID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgIHZhciB0aW1lRnJhbWVzID0gW107CiAgICAgICAgdmFyIGRhdGVGcmFtZXMgPSBmaWx0ZXJEYXRlRnJhbWVzKHRoaXMuZGF0ZUZyYW1lcywgZGF0ZSk7CgogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChkYXRlRnJhbWVzLCBmdW5jdGlvbihkYXRlRnJhbWUpIHsKICAgICAgICAgICAgaWYgKGRhdGVGcmFtZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goZGF0ZUZyYW1lLnRhcmdldHMsIGZ1bmN0aW9uKHRpbWVGcmFtZU1hcHBpbmdOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRpbWVGcmFtZU1hcHBpbmcgPSB0aGlzLnRpbWVGcmFtZU1hcHBpbmdzW3RpbWVGcmFtZU1hcHBpbmdOYW1lXTsKICAgICAgICAgICAgICAgICAgICBpZiAodGltZUZyYW1lTWFwcGluZyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIGEgdGltZUZyYW1lIG1hcHBpbmcgaXMgZm91bmQKICAgICAgICAgICAgICAgICAgICAgICAgdGltZUZyYW1lcy5wdXNoKHRpbWVGcmFtZU1hcHBpbmcuZ2V0VGltZUZyYW1lcygpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBubyB0aW1lRnJhbWUgbWFwcGluZyBpcyBmb3VuZCwgdHJ5IHVzaW5nIGRpcmVjdCB0aW1lRnJhbWUKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRpbWVGcmFtZSA9IHRoaXMudGltZUZyYW1lc1t0aW1lRnJhbWVNYXBwaW5nTmFtZV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aW1lRnJhbWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZUZyYW1lcy5wdXNoKHRpbWVGcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sIHRoaXMpOwoKICAgICAgICB2YXIgZGF0ZVllYXIgPSBkYXRlLnllYXIoKTsKICAgICAgICB2YXIgZGF0ZU1vbnRoID0gZGF0ZS5tb250aCgpOwogICAgICAgIHZhciBkYXRlRGF0ZSA9IGRhdGUuZGF0ZSgpOwoKICAgICAgICB2YXIgdmFsaWRhdGVkVGltZUZyYW1lcyA9IFtdOwogICAgICAgIGlmICh0aW1lRnJhbWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBhbmd1bGFyLmZvckVhY2godGhpcy50aW1lRnJhbWVzLCBmdW5jdGlvbih0aW1lRnJhbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0aW1lRnJhbWUuZGVmYXVsdCkgewogICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZXMucHVzaCh0aW1lRnJhbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aW1lRnJhbWVzLCBmdW5jdGlvbih0aW1lRnJhbWUpIHsKICAgICAgICAgICAgdGltZUZyYW1lID0gdGltZUZyYW1lLmNsb25lKCk7CgogICAgICAgICAgICBpZiAodGltZUZyYW1lLnN0YXJ0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRpbWVGcmFtZS5zdGFydC55ZWFyKGRhdGVZZWFyKTsKICAgICAgICAgICAgICAgIHRpbWVGcmFtZS5zdGFydC5tb250aChkYXRlTW9udGgpOwogICAgICAgICAgICAgICAgdGltZUZyYW1lLnN0YXJ0LmRhdGUoZGF0ZURhdGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGltZUZyYW1lLmVuZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aW1lRnJhbWUuZW5kLnllYXIoZGF0ZVllYXIpOwogICAgICAgICAgICAgICAgdGltZUZyYW1lLmVuZC5tb250aChkYXRlTW9udGgpOwogICAgICAgICAgICAgICAgdGltZUZyYW1lLmVuZC5kYXRlKGRhdGVEYXRlKTsKCiAgICAgICAgICAgICAgICBpZiAobW9tZW50KHRpbWVGcmFtZS5lbmQpLnN0YXJ0T2YoJ2RheScpID09PSB0aW1lRnJhbWUuZW5kKSB7CiAgICAgICAgICAgICAgICAgICAgdGltZUZyYW1lLmVuZC5hZGQoMSwgJ2RheScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB2YWxpZGF0ZWRUaW1lRnJhbWVzLnB1c2godGltZUZyYW1lKTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHZhbGlkYXRlZFRpbWVGcmFtZXM7CiAgICB9OwoKICAgIC8qKgogICAgICogU29sdmUgdGltZUZyYW1lcyB1c2luZyB0d28gcnVsZXMuCiAgICAgKgogICAgICogMSkgSWYgYXQgbGVhc3Qgb25lIHdvcmtpbmcgdGltZUZyYW1lIGlzIGRlZmluZWQsIGV2ZXJ5dGhpbmcgb3V0c2lkZQogICAgICogZGVmaW5lZCB0aW1lRnJhbWVzIGlzIGNvbnNpZGVyZWQgYXMgbm9uLXdvcmtpbmcuIEVsc2UgaXQncyBjb25zaWRlcmVkCiAgICAgKiBhcyB3b3JraW5nLgogICAgICoKICAgICAqIDIpIFNtYWxsZXIgdGltZUZyYW1lcyBoYXZlIHByaW9yaXR5IG92ZXIgbGFyZ2VyIG9uZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge2FycmF5fSB0aW1lRnJhbWVzIEFycmF5IG9mIHRpbWVGcmFtZXMgdG8gc29sdmUKICAgICAqIEBwYXJhbSB7bW9tZW50fSBzdGFydERhdGUKICAgICAqIEBwYXJhbSB7bW9tZW50fSBlbmREYXRlCiAgICAgKi8KICAgIENhbGVuZGFyLnByb3RvdHlwZS5zb2x2ZSA9IGZ1bmN0aW9uKHRpbWVGcmFtZXMsIHN0YXJ0RGF0ZSwgZW5kRGF0ZSkgewogICAgICAgIHZhciBkZWZhdWx0V29ya2luZyA9IHRpbWVGcmFtZXMubGVuZ3RoID09PSAwOwogICAgICAgIHZhciBjb2xvcjsKICAgICAgICB2YXIgY2xhc3NlczsKICAgICAgICB2YXIgbWluRGF0ZTsKICAgICAgICB2YXIgbWF4RGF0ZTsKCiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRpbWVGcmFtZXMsIGZ1bmN0aW9uKHRpbWVGcmFtZSkgewogICAgICAgICAgICBpZiAobWluRGF0ZSA9PT0gdW5kZWZpbmVkIHx8IG1pbkRhdGUgPiB0aW1lRnJhbWUuc3RhcnQpIHsKICAgICAgICAgICAgICAgIG1pbkRhdGUgPSB0aW1lRnJhbWUuc3RhcnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1heERhdGUgPT09IHVuZGVmaW5lZCB8fCBtYXhEYXRlIDwgdGltZUZyYW1lLmVuZCkgewogICAgICAgICAgICAgICAgbWF4RGF0ZSA9IHRpbWVGcmFtZS5lbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbG9yID09PSB1bmRlZmluZWQgJiYgdGltZUZyYW1lLmNvbG9yKSB7CiAgICAgICAgICAgICAgICBjb2xvciA9IHRpbWVGcmFtZS5jb2xvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGltZUZyYW1lLmNsYXNzZXMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgaWYgKGNsYXNzZXMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGNsYXNzZXMgPSBbXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNsYXNzZXMgPSBjbGFzc2VzLmNvbmNhdCh0aW1lRnJhbWUuY2xhc3Nlcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgaWYgKHN0YXJ0RGF0ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHN0YXJ0RGF0ZSA9IG1pbkRhdGU7CiAgICAgICAgfQoKICAgICAgICBpZiAoZW5kRGF0ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGVuZERhdGUgPSBtYXhEYXRlOwogICAgICAgIH0KCiAgICAgICAgdmFyIHNvbHZlZFRpbWVGcmFtZXMgPSBbbmV3IFRpbWVGcmFtZSh7c3RhcnQ6IHN0YXJ0RGF0ZSwgZW5kOiBlbmREYXRlLCB3b3JraW5nOiBkZWZhdWx0V29ya2luZywgY29sb3I6IGNvbG9yLCBjbGFzc2VzOiBjbGFzc2VzfSldOwoKICAgICAgICB2YXIgb3JkZXJlZFRpbWVGcmFtZXMgPSAkZmlsdGVyKCdvcmRlckJ5JykodGltZUZyYW1lcywgZnVuY3Rpb24odGltZUZyYW1lKSB7CiAgICAgICAgICAgIHJldHVybiAtdGltZUZyYW1lLmdldER1cmF0aW9uKCk7CiAgICAgICAgfSk7CgogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChvcmRlcmVkVGltZUZyYW1lcywgZnVuY3Rpb24odGltZUZyYW1lKSB7CiAgICAgICAgICAgIHZhciB0bXBTb2x2ZWRUaW1lRnJhbWVzID0gc29sdmVkVGltZUZyYW1lcy5zbGljZSgpOwoKICAgICAgICAgICAgdmFyIGk9MDsKICAgICAgICAgICAgdmFyIGRpc3BhdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIHRyZWF0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHNvbHZlZFRpbWVGcmFtZXMsIGZ1bmN0aW9uKHNvbHZlZFRpbWVGcmFtZSkgewogICAgICAgICAgICAgICAgaWYgKCF0cmVhdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRpbWVGcmFtZS5lbmQgPiBzb2x2ZWRUaW1lRnJhbWUuc3RhcnQgJiYgdGltZUZyYW1lLnN0YXJ0IDwgc29sdmVkVGltZUZyYW1lLmVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aW1lRnJhbWUgaXMgaW5jbHVkZWQgaW4gdGhpcyBzb2x2ZWRUaW1lRnJhbWUuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNvbHZlZFRpbWVGcmFtZTp8c3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3wKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgdGltZUZyYW1lOiAgICAgICAgICB8dHR0dHR0fAogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgICByZXN1bHQ6fHNzc3Nzc3Nzc3x0dHR0dHR8c3Nzc3Nzc3Nzc3Nzc3Nzc3N8CgogICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUgPSB0aW1lRnJhbWUuY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1NvbHZlZFRpbWVGcmFtZSA9IHNvbHZlZFRpbWVGcmFtZS5jbG9uZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgc29sdmVkVGltZUZyYW1lLmVuZCA9IG1vbWVudCh0aW1lRnJhbWUuc3RhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICBuZXdTb2x2ZWRUaW1lRnJhbWUuc3RhcnQgPSBtb21lbnQodGltZUZyYW1lLmVuZCk7CgogICAgICAgICAgICAgICAgICAgICAgICB0bXBTb2x2ZWRUaW1lRnJhbWVzLnNwbGljZShpICsgMSwgMCwgdGltZUZyYW1lLmNsb25lKCksIG5ld1NvbHZlZFRpbWVGcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyZWF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWRpc3BhdGNoZWQgJiYgdGltZUZyYW1lLnN0YXJ0IDwgc29sdmVkVGltZUZyYW1lLmVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aW1lRnJhbWUgaXMgZGlzcGF0Y2hlZCBvbiB0d28gc29sdmVkVGltZUZyYW1lLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBGaXJzdCBwYXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNvbHZlZFRpbWVGcmFtZTp8c3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3N8cysxO3MrMTtzKzE7cysxO3MrMTtzKzF8CiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgIHRpbWVGcmFtZTogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHx0dHR0dHR8CiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgIHJlc3VsdDp8c3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3x0dHR0dHR8O3MrMTtzKzE7cysxO3MrMTtzKzF8CgogICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUgPSB0aW1lRnJhbWUuY2xvbmUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHNvbHZlZFRpbWVGcmFtZS5lbmQgPSBtb21lbnQodGltZUZyYW1lLnN0YXJ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdG1wU29sdmVkVGltZUZyYW1lcy5zcGxpY2UoaSArIDEsIDAsIHRpbWVGcmFtZSk7CgogICAgICAgICAgICAgICAgICAgICAgICBkaXNwYXRjaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRpc3BhdGNoZWQgJiYgdGltZUZyYW1lLmVuZCA+IHNvbHZlZFRpbWVGcmFtZS5zdGFydCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aW1lRnJhbWUgaXMgZGlzcGF0Y2hlZCBvbiB0d28gc29sdmVkVGltZUZyYW1lLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTZWNvbmQgcGFydAoKICAgICAgICAgICAgICAgICAgICAgICAgc29sdmVkVGltZUZyYW1lLnN0YXJ0ID0gbW9tZW50KHRpbWVGcmFtZS5lbmQpOwogICAgICAgICAgICAgICAgICAgICAgICBkaXNwYXRjaGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyZWF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc29sdmVkVGltZUZyYW1lcyA9IHRtcFNvbHZlZFRpbWVGcmFtZXM7CiAgICAgICAgfSk7CgogICAgICAgIHNvbHZlZFRpbWVGcmFtZXMgPSAkZmlsdGVyKCdmaWx0ZXInKShzb2x2ZWRUaW1lRnJhbWVzLCBmdW5jdGlvbih0aW1lRnJhbWUpIHsKICAgICAgICAgICAgcmV0dXJuICh0aW1lRnJhbWUuc3RhcnQgPT09IHVuZGVmaW5lZCB8fCB0aW1lRnJhbWUuc3RhcnQgPCBlbmREYXRlKSAmJiAodGltZUZyYW1lLmVuZCA9PT0gdW5kZWZpbmVkIHx8IHRpbWVGcmFtZS5lbmQgPiBzdGFydERhdGUpOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gc29sdmVkVGltZUZyYW1lczsKCiAgICB9OwoKICAgIHJldHVybiBDYWxlbmRhcjsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0Q3VycmVudERhdGVNYW5hZ2VyJywgW2Z1bmN0aW9uKCkgewogICAgdmFyIEdhbnR0Q3VycmVudERhdGVNYW5hZ2VyID0gZnVuY3Rpb24oZ2FudHQpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHRoaXMuZ2FudHQgPSBnYW50dDsKCiAgICAgICAgdGhpcy5kYXRlID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMucG9zaXRpb24gPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5jdXJyZW50RGF0ZUNvbHVtbiA9IHVuZGVmaW5lZDsKCiAgICAgICAgdGhpcy5nYW50dC4kc2NvcGUuJHdhdGNoR3JvdXAoWydjdXJyZW50RGF0ZScsICdjdXJyZW50RGF0ZVZhbHVlJ10sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzZWxmLnNldEN1cnJlbnREYXRlKHNlbGYuZ2FudHQuJHNjb3BlLmN1cnJlbnREYXRlVmFsdWUpOwogICAgICAgIH0pOwogICAgfTsKCiAgICBHYW50dEN1cnJlbnREYXRlTWFuYWdlci5wcm90b3R5cGUuc2V0Q3VycmVudERhdGUgPSBmdW5jdGlvbihjdXJyZW50RGF0ZSkgewogICAgICAgIHRoaXMuZGF0ZSA9IGN1cnJlbnREYXRlOwogICAgICAgIGlmICh0aGlzLmN1cnJlbnREYXRlQ29sdW1uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RGF0ZUNvbHVtbi5jdXJyZW50RGF0ZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuY3VycmVudERhdGVDb2x1bW47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5kYXRlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdmFyIGNvbHVtbiA9IHRoaXMuZ2FudHQuY29sdW1uc01hbmFnZXIuZ2V0Q29sdW1uQnlEYXRlKHRoaXMuZGF0ZSk7CiAgICAgICAgICAgIGlmIChjb2x1bW4gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgY29sdW1uLmN1cnJlbnREYXRlID0gdGhpcy5kYXRlOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RGF0ZUNvbHVtbiA9IGNvbHVtbjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHRoaXMuZ2FudHQuZ2V0UG9zaXRpb25CeURhdGUodGhpcy5kYXRlKTsKICAgIH07CiAgICByZXR1cm4gR2FudHRDdXJyZW50RGF0ZU1hbmFnZXI7Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdHYW50dENvbHVtbicsIFsgJ21vbWVudCcsIGZ1bmN0aW9uKG1vbWVudCkgewogICAgLy8gVXNlZCB0byBkaXNwbGF5IHRoZSBHYW50dCBncmlkIGFuZCBoZWFkZXIuCiAgICAvLyBUaGUgY29sdW1ucyBhcmUgZ2VuZXJhdGVkIGJ5IHRoZSBjb2x1bW4gZ2VuZXJhdG9yLgogICAgdmFyIENvbHVtbiA9IGZ1bmN0aW9uKGRhdGUsIGVuZERhdGUsIGxlZnQsIHdpZHRoLCBjYWxlbmRhciwgdGltZUZyYW1lc1dvcmtpbmdNb2RlLCB0aW1lRnJhbWVzTm9uV29ya2luZ01vZGUsIGNvbHVtbk1hZ25ldFZhbHVlLCBjb2x1bW5NYWduZXRVbml0KSB7CiAgICAgICAgdGhpcy5kYXRlID0gZGF0ZTsKICAgICAgICB0aGlzLmVuZERhdGUgPSBlbmREYXRlOwogICAgICAgIHRoaXMubGVmdCA9IGxlZnQ7CiAgICAgICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgICAgIHRoaXMuY2FsZW5kYXIgPSBjYWxlbmRhcjsKICAgICAgICB0aGlzLmR1cmF0aW9uID0gdGhpcy5lbmREYXRlLmRpZmYodGhpcy5kYXRlLCAnbWlsbGlzZWNvbmRzJyk7CiAgICAgICAgdGhpcy50aW1lRnJhbWVzV29ya2luZ01vZGUgPSB0aW1lRnJhbWVzV29ya2luZ01vZGU7CiAgICAgICAgdGhpcy50aW1lRnJhbWVzTm9uV29ya2luZ01vZGUgPSB0aW1lRnJhbWVzTm9uV29ya2luZ01vZGU7CiAgICAgICAgdGhpcy50aW1lRnJhbWVzID0gW107CiAgICAgICAgdGhpcy52aXNpYmxlVGltZUZyYW1lcyA9IFtdOwogICAgICAgIHRoaXMuZGF5c1RpbWVGcmFtZXMgPSB7fTsKICAgICAgICB0aGlzLmNyb3BwZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmNvbHVtbk1hZ25ldFZhbHVlID0gY29sdW1uTWFnbmV0VmFsdWU7CiAgICAgICAgdGhpcy5jb2x1bW5NYWduZXRVbml0ID0gY29sdW1uTWFnbmV0VW5pdDsKICAgICAgICB0aGlzLm9yaWdpbmFsU2l6ZSA9IHtsZWZ0OiB0aGlzLmxlZnQsIHdpZHRoOiB0aGlzLndpZHRofTsKICAgICAgICB0aGlzLnVwZGF0ZVRpbWVGcmFtZXMoKTsKICAgIH07CgogICAgdmFyIGdldERhdGVLZXkgPSBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgcmV0dXJuIGRhdGUueWVhcigpICsgJy0nICsgZGF0ZS5tb250aCgpICsgJy0nICsgZGF0ZS5kYXRlKCk7CiAgICB9OwoKICAgIENvbHVtbi5wcm90b3R5cGUudXBkYXRlVGltZUZyYW1lcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgaWYgKHNlbGYuY2FsZW5kYXIgIT09IHVuZGVmaW5lZCAmJiAoc2VsZi50aW1lRnJhbWVzTm9uV29ya2luZ01vZGUgIT09ICdoaWRkZW4nIHx8IHNlbGYudGltZUZyYW1lc1dvcmtpbmdNb2RlICE9PSAnaGlkZGVuJykpIHsKICAgICAgICAgICAgdmFyIGJ1aWxkUHVzaFRpbWVGcmFtZXMgPSBmdW5jdGlvbih0aW1lRnJhbWVzLCBzdGFydERhdGUsIGVuZERhdGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0aW1lRnJhbWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RhcnQgPSB0aW1lRnJhbWUuc3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXJ0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBzdGFydERhdGU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgZW5kID0gdGltZUZyYW1lLmVuZDsKICAgICAgICAgICAgICAgICAgICBpZiAoZW5kID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZW5kID0gZW5kRGF0ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChzdGFydCA8IHNlbGYuZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHNlbGYuZGF0ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChlbmQgPiBzZWxmLmVuZERhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZW5kID0gc2VsZi5lbmREYXRlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdGltZUZyYW1lID0gdGltZUZyYW1lLmNsb25lKCk7CgogICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZS5zdGFydCA9IG1vbWVudChzdGFydCk7CiAgICAgICAgICAgICAgICAgICAgdGltZUZyYW1lLmVuZCA9IG1vbWVudChlbmQpOwoKICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWVzLnB1c2godGltZUZyYW1lKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgY0RhdGUgPSBzZWxmLmRhdGU7CiAgICAgICAgICAgIHZhciBjRGF0ZVN0YXJ0T2ZEYXkgPSBtb21lbnQoY0RhdGUpLnN0YXJ0T2YoJ2RheScpOwogICAgICAgICAgICB2YXIgY0RhdGVOZXh0RGF5ID0gY0RhdGVTdGFydE9mRGF5LmFkZCgxLCAnZGF5Jyk7CiAgICAgICAgICAgIHdoaWxlIChjRGF0ZSA8IHNlbGYuZW5kRGF0ZSkgewogICAgICAgICAgICAgICAgdmFyIHRpbWVGcmFtZXMgPSBzZWxmLmNhbGVuZGFyLmdldFRpbWVGcmFtZXMoY0RhdGUpOwogICAgICAgICAgICAgICAgdmFyIG5leHRDRGF0ZSA9IG1vbWVudC5taW4oY0RhdGVOZXh0RGF5LCBzZWxmLmVuZERhdGUpOwogICAgICAgICAgICAgICAgdGltZUZyYW1lcyA9IHNlbGYuY2FsZW5kYXIuc29sdmUodGltZUZyYW1lcywgY0RhdGUsIG5leHRDRGF0ZSk7CiAgICAgICAgICAgICAgICB2YXIgY1RpbWVGcmFtZXMgPSBbXTsKICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aW1lRnJhbWVzLCBidWlsZFB1c2hUaW1lRnJhbWVzKGNUaW1lRnJhbWVzLCBjRGF0ZSwgbmV4dENEYXRlKSk7CiAgICAgICAgICAgICAgICBzZWxmLnRpbWVGcmFtZXMgPSBzZWxmLnRpbWVGcmFtZXMuY29uY2F0KGNUaW1lRnJhbWVzKTsKCiAgICAgICAgICAgICAgICB2YXIgY0RhdGVLZXkgPSBnZXREYXRlS2V5KGNEYXRlKTsKICAgICAgICAgICAgICAgIHNlbGYuZGF5c1RpbWVGcmFtZXNbY0RhdGVLZXldID0gY1RpbWVGcmFtZXM7CgogICAgICAgICAgICAgICAgY0RhdGUgPSBuZXh0Q0RhdGU7CiAgICAgICAgICAgICAgICBjRGF0ZVN0YXJ0T2ZEYXkgPSBtb21lbnQoY0RhdGUpLnN0YXJ0T2YoJ2RheScpOwogICAgICAgICAgICAgICAgY0RhdGVOZXh0RGF5ID0gY0RhdGVTdGFydE9mRGF5LmFkZCgxLCAnZGF5Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChzZWxmLnRpbWVGcmFtZXMsIGZ1bmN0aW9uKHRpbWVGcmFtZSkgewogICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9uRHVyYXRpb24gPSB0aW1lRnJhbWUuc3RhcnQuZGlmZihzZWxmLmRhdGUsICdtaWxsaXNlY29uZHMnKTsKICAgICAgICAgICAgICAgIHZhciBwb3NpdGlvbiA9IHBvc2l0aW9uRHVyYXRpb24gLyBzZWxmLmR1cmF0aW9uICogc2VsZi53aWR0aDsKCiAgICAgICAgICAgICAgICB2YXIgdGltZUZyYW1lRHVyYXRpb24gPSB0aW1lRnJhbWUuZW5kLmRpZmYodGltZUZyYW1lLnN0YXJ0LCAnbWlsbGlzZWNvbmRzJyk7CiAgICAgICAgICAgICAgICB2YXIgdGltZUZyYW1lUG9zaXRpb24gPSB0aW1lRnJhbWVEdXJhdGlvbiAvIHNlbGYuZHVyYXRpb24gKiBzZWxmLndpZHRoOwoKICAgICAgICAgICAgICAgIHZhciBoaWRkZW4gPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICh0aW1lRnJhbWUud29ya2luZyAmJiBzZWxmLnRpbWVGcmFtZXNXb3JraW5nTW9kZSAhPT0gJ3Zpc2libGUnKSB7CiAgICAgICAgICAgICAgICAgICAgaGlkZGVuID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRpbWVGcmFtZS53b3JraW5nICYmIHNlbGYudGltZUZyYW1lc05vbldvcmtpbmdNb2RlICE9PSAndmlzaWJsZScpIHsKICAgICAgICAgICAgICAgICAgICBoaWRkZW4gPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghaGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi52aXNpYmxlVGltZUZyYW1lcy5wdXNoKHRpbWVGcmFtZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGltZUZyYW1lLmhpZGRlbiA9IGhpZGRlbjsKICAgICAgICAgICAgICAgIHRpbWVGcmFtZS5sZWZ0ID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICB0aW1lRnJhbWUud2lkdGggPSB0aW1lRnJhbWVQb3NpdGlvbjsKICAgICAgICAgICAgICAgIHRpbWVGcmFtZS5vcmlnaW5hbFNpemUgPSB7bGVmdDogdGltZUZyYW1lLmxlZnQsIHdpZHRoOiB0aW1lRnJhbWUud2lkdGh9OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChzZWxmLnRpbWVGcmFtZXNOb25Xb3JraW5nTW9kZSA9PT0gJ2Nyb3BwZWQnIHx8IHNlbGYudGltZUZyYW1lc1dvcmtpbmdNb2RlID09PSAnY3JvcHBlZCcpIHsKICAgICAgICAgICAgICAgIHZhciB0aW1lRnJhbWVzV2lkdGggPSAwOwogICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHNlbGYudGltZUZyYW1lcywgZnVuY3Rpb24odGltZUZyYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aW1lRnJhbWUud29ya2luZyAmJiBzZWxmLnRpbWVGcmFtZXNOb25Xb3JraW5nTW9kZSAhPT0gJ2Nyb3BwZWQnIHx8CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZS53b3JraW5nICYmIHNlbGYudGltZUZyYW1lc1dvcmtpbmdNb2RlICE9PSAnY3JvcHBlZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGltZUZyYW1lc1dpZHRoICs9IHRpbWVGcmFtZS53aWR0aDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBpZiAodGltZUZyYW1lc1dpZHRoICE9PSBzZWxmLndpZHRoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNyb3BwZWRSYXRpbyA9IHNlbGYud2lkdGggLyB0aW1lRnJhbWVzV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNyb3BwZWRXaWR0aCA9IDA7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsQ3JvcHBlZFdpZHRoID0gMDsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGFsbENyb3BwZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goc2VsZi50aW1lRnJhbWVzLCBmdW5jdGlvbih0aW1lRnJhbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aW1lRnJhbWUud29ya2luZyAmJiBzZWxmLnRpbWVGcmFtZXNOb25Xb3JraW5nTW9kZSAhPT0gJ2Nyb3BwZWQnIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUud29ya2luZyAmJiBzZWxmLnRpbWVGcmFtZXNXb3JraW5nTW9kZSAhPT0gJ2Nyb3BwZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUubGVmdCA9ICh0aW1lRnJhbWUubGVmdCAtIGNyb3BwZWRXaWR0aCkgKiBjcm9wcGVkUmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUud2lkdGggPSB0aW1lRnJhbWUud2lkdGggKiBjcm9wcGVkUmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUub3JpZ2luYWxTaXplLmxlZnQgPSAodGltZUZyYW1lLm9yaWdpbmFsU2l6ZS5sZWZ0IC0gb3JpZ2luYWxDcm9wcGVkV2lkdGgpICogY3JvcHBlZFJhdGlvOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZUZyYW1lLm9yaWdpbmFsU2l6ZS53aWR0aCA9IHRpbWVGcmFtZS5vcmlnaW5hbFNpemUud2lkdGggKiBjcm9wcGVkUmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUuY3JvcHBlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsQ3JvcHBlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JvcHBlZFdpZHRoICs9IHRpbWVGcmFtZS53aWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsQ3JvcHBlZFdpZHRoICs9IHRpbWVGcmFtZS5vcmlnaW5hbFNpemUud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUubGVmdCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZS53aWR0aCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUub3JpZ2luYWxTaXplID0ge2xlZnQ6IHVuZGVmaW5lZCwgd2lkdGg6IDB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZUZyYW1lLmNyb3BwZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIHNlbGYuY3JvcHBlZCA9IGFsbENyb3BwZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHNlbGYuY3JvcHBlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICBDb2x1bW4ucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBDb2x1bW4obW9tZW50KHRoaXMuZGF0ZSksIG1vbWVudCh0aGlzLmVuZERhdGUpLCB0aGlzLmxlZnQsIHRoaXMud2lkdGgsIHRoaXMuY2FsZW5kYXIpOwogICAgfTsKCiAgICBDb2x1bW4ucHJvdG90eXBlLmNvbnRhaW5zRGF0ZSA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICByZXR1cm4gZGF0ZSA+IHRoaXMuZGF0ZSAmJiBkYXRlIDw9IHRoaXMuZW5kRGF0ZTsKICAgIH07CgogICAgQ29sdW1uLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihvdGhlcikgewogICAgICAgIHJldHVybiB0aGlzLmRhdGUgPT09IG90aGVyLmRhdGU7CiAgICB9OwoKICAgIENvbHVtbi5wcm90b3R5cGUuZ2V0TWFnbmV0RGF0ZSA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICBpZiAodGhpcy5jb2x1bW5NYWduZXRWYWx1ZSA+IDAgJiYgdGhpcy5jb2x1bW5NYWduZXRVbml0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgZGF0ZSA9IG1vbWVudChkYXRlKTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gZGF0ZS5nZXQodGhpcy5jb2x1bW5NYWduZXRVbml0KTsKICAgICAgICAgICAgdmFyIG1hZ25ldFZhbHVlID0gTWF0aC5yb3VuZCh2YWx1ZS90aGlzLmNvbHVtbk1hZ25ldFZhbHVlKSAqIHRoaXMuY29sdW1uTWFnbmV0VmFsdWU7CiAgICAgICAgICAgIGRhdGUuc3RhcnRPZih0aGlzLmNvbHVtbk1hZ25ldFVuaXQpOwogICAgICAgICAgICBkYXRlLnNldCh0aGlzLmNvbHVtbk1hZ25ldFVuaXQsIG1hZ25ldFZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIGRhdGU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkYXRlOwogICAgfTsKCiAgICB2YXIgZ2V0RGF0ZUJ5UG9zaXRpb25Vc2luZ1RpbWVGcmFtZXMgPSBmdW5jdGlvbih0aW1lRnJhbWVzLCBwb3NpdGlvbikgewogICAgICAgIGZvciAodmFyIGk9MDsgaSA8IHRpbWVGcmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgLy8gVE9ETzogcGVyZm9ybWFuY2Ugb3B0aW1pemF0aW9uIGNvdWxkIGJlIGRvbmUuCiAgICAgICAgICAgIHZhciB0aW1lRnJhbWUgPSB0aW1lRnJhbWVzW2ldOwogICAgICAgICAgICBpZiAoIXRpbWVGcmFtZS5jcm9wcGVkICYmIHBvc2l0aW9uID49IHRpbWVGcmFtZS5sZWZ0ICYmIHBvc2l0aW9uIDw9IHRpbWVGcmFtZS5sZWZ0ICsgdGltZUZyYW1lLndpZHRoKSB7CiAgICAgICAgICAgICAgICB2YXIgcG9zaXRpb25EdXJhdGlvbiA9IHRpbWVGcmFtZS5nZXREdXJhdGlvbigpIC8gdGltZUZyYW1lLndpZHRoICogKHBvc2l0aW9uIC0gdGltZUZyYW1lLmxlZnQpOwogICAgICAgICAgICAgICAgdmFyIGRhdGUgPSBtb21lbnQodGltZUZyYW1lLnN0YXJ0KS5hZGQocG9zaXRpb25EdXJhdGlvbiwgJ21pbGxpc2Vjb25kcycpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIENvbHVtbi5wcm90b3R5cGUuZ2V0RGF0ZUJ5UG9zaXRpb24gPSBmdW5jdGlvbihwb3NpdGlvbiwgbWFnbmV0KSB7CiAgICAgICAgdmFyIHBvc2l0aW9uRHVyYXRpb247CiAgICAgICAgdmFyIGRhdGU7CgogICAgICAgIGlmIChwb3NpdGlvbiA8IDApIHsKICAgICAgICAgICAgcG9zaXRpb24gPSAwOwogICAgICAgIH0KICAgICAgICBpZiAocG9zaXRpb24gPiB0aGlzLndpZHRoKSB7CiAgICAgICAgICAgIHBvc2l0aW9uID0gdGhpcy53aWR0aDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnRpbWVGcmFtZXNOb25Xb3JraW5nTW9kZSA9PT0gJ2Nyb3BwZWQnIHx8IHRoaXMudGltZUZyYW1lc1dvcmtpbmdNb2RlID09PSAnY3JvcHBlZCcpIHsKICAgICAgICAgICAgZGF0ZSA9IGdldERhdGVCeVBvc2l0aW9uVXNpbmdUaW1lRnJhbWVzKHRoaXMudGltZUZyYW1lcywgcG9zaXRpb24pOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRhdGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBwb3NpdGlvbkR1cmF0aW9uID0gdGhpcy5kdXJhdGlvbiAvIHRoaXMud2lkdGggKiBwb3NpdGlvbjsKICAgICAgICAgICAgZGF0ZSA9IG1vbWVudCh0aGlzLmRhdGUpLmFkZChwb3NpdGlvbkR1cmF0aW9uLCAnbWlsbGlzZWNvbmRzJyk7CiAgICAgICAgfQoKICAgICAgICBpZiAobWFnbmV0KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldE1hZ25ldERhdGUoZGF0ZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZGF0ZTsKICAgIH07CgogICAgQ29sdW1uLnByb3RvdHlwZS5nZXREYXlUaW1lRnJhbWUgPSBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgdmFyIGR0ZiA9IHRoaXMuZGF5c1RpbWVGcmFtZXNbZ2V0RGF0ZUtleShkYXRlKV07CiAgICAgICAgaWYgKGR0ZiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGR0ZjsKICAgIH07CgogICAgQ29sdW1uLnByb3RvdHlwZS5nZXRQb3NpdGlvbkJ5RGF0ZSA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICB2YXIgcG9zaXRpb25EdXJhdGlvbjsKICAgICAgICB2YXIgcG9zaXRpb247CgogICAgICAgIGlmICh0aGlzLnRpbWVGcmFtZXNOb25Xb3JraW5nTW9kZSA9PT0gJ2Nyb3BwZWQnIHx8IHRoaXMudGltZUZyYW1lc1dvcmtpbmdNb2RlID09PSAnY3JvcHBlZCcpIHsKICAgICAgICAgICAgdmFyIGNyb3BwZWREYXRlID0gZGF0ZTsKICAgICAgICAgICAgdmFyIHRpbWVGcmFtZXMgPSB0aGlzLmdldERheVRpbWVGcmFtZShjcm9wcGVkRGF0ZSk7CiAgICAgICAgICAgIGZvciAodmFyIGk9MDsgaSA8IHRpbWVGcmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciB0aW1lRnJhbWUgPSB0aW1lRnJhbWVzW2ldOwogICAgICAgICAgICAgICAgaWYgKGNyb3BwZWREYXRlID49IHRpbWVGcmFtZS5zdGFydCAmJiBjcm9wcGVkRGF0ZSA8PSB0aW1lRnJhbWUuZW5kKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRpbWVGcmFtZS5jcm9wcGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aW1lRnJhbWVzLmxlbmd0aCA+IGkrMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JvcHBlZERhdGUgPSB0aW1lRnJhbWVzW2krMV0uc3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcm9wcGVkRGF0ZSA9IHRpbWVGcmFtZS5lbmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbkR1cmF0aW9uID0gY3JvcHBlZERhdGUuZGlmZih0aW1lRnJhbWUuc3RhcnQsICdtaWxsaXNlY29uZHMnKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbkR1cmF0aW9uIC8gdGltZUZyYW1lLmdldER1cmF0aW9uKCkgKiB0aW1lRnJhbWUud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxlZnQgKyB0aW1lRnJhbWUubGVmdCArIHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcG9zaXRpb25EdXJhdGlvbiA9IGRhdGUuZGlmZih0aGlzLmRhdGUsICdtaWxsaXNlY29uZHMnKTsKICAgICAgICBwb3NpdGlvbiA9IHBvc2l0aW9uRHVyYXRpb24gLyB0aGlzLmR1cmF0aW9uICogdGhpcy53aWR0aDsKCiAgICAgICAgaWYgKHBvc2l0aW9uIDwgMCkgewogICAgICAgICAgICBwb3NpdGlvbiA9IDA7CiAgICAgICAgfQoKICAgICAgICBpZiAocG9zaXRpb24gPiB0aGlzLndpZHRoKSB7CiAgICAgICAgICAgIHBvc2l0aW9uID0gdGhpcy53aWR0aDsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmxlZnQgKyBwb3NpdGlvbjsKICAgIH07CgogICAgcmV0dXJuIENvbHVtbjsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0Q29sdW1uR2VuZXJhdG9yJywgWyAnR2FudHRDb2x1bW4nLCAnbW9tZW50JywgZnVuY3Rpb24oQ29sdW1uLCBtb21lbnQpIHsKICAgIHZhciBDb2x1bW5HZW5lcmF0b3IgPSBmdW5jdGlvbihjb2x1bW5zTWFuYWdlcikgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgdmFyIGNvbHVtbldpZHRoID0gY29sdW1uc01hbmFnZXIuZ2FudHQuJHNjb3BlLmNvbHVtbldpZHRoOwogICAgICAgIGlmIChjb2x1bW5XaWR0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGNvbHVtbldpZHRoID0gMjA7CiAgICAgICAgfQogICAgICAgIHZhciB1bml0ID0gY29sdW1uc01hbmFnZXIuZ2FudHQuJHNjb3BlLnZpZXdTY2FsZTsKICAgICAgICB2YXIgY2FsZW5kYXIgPSBjb2x1bW5zTWFuYWdlci5nYW50dC5jYWxlbmRhcjsKICAgICAgICB2YXIgdGltZUZyYW1lc1dvcmtpbmdNb2RlID0gY29sdW1uc01hbmFnZXIuZ2FudHQuJHNjb3BlLnRpbWVGcmFtZXNXb3JraW5nTW9kZTsKICAgICAgICB2YXIgdGltZUZyYW1lc05vbldvcmtpbmdNb2RlID0gY29sdW1uc01hbmFnZXIuZ2FudHQuJHNjb3BlLnRpbWVGcmFtZXNOb25Xb3JraW5nTW9kZTsKCiAgICAgICAgdmFyIGNvbHVtbk1hZ25ldFZhbHVlOwogICAgICAgIHZhciBjb2x1bW5NYWduZXRVbml0OwoKICAgICAgICBpZiAoY29sdW1uc01hbmFnZXIuZ2FudHQuJHNjb3BlLmNvbHVtbk1hZ25ldCkgewogICAgICAgICAgICB2YXIgc3BsaXR0ZWRDb2x1bW5NYWduZXQgPSBjb2x1bW5zTWFuYWdlci5nYW50dC4kc2NvcGUuY29sdW1uTWFnbmV0LnRyaW0oKS5zcGxpdCgnICcpOwogICAgICAgICAgICBpZiAoc3BsaXR0ZWRDb2x1bW5NYWduZXQubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgY29sdW1uTWFnbmV0VmFsdWUgPSBwYXJzZUludChzcGxpdHRlZENvbHVtbk1hZ25ldFswXSk7CiAgICAgICAgICAgICAgICBjb2x1bW5NYWduZXRVbml0ID0gc3BsaXR0ZWRDb2x1bW5NYWduZXRbc3BsaXR0ZWRDb2x1bW5NYWduZXQubGVuZ3RoLTFdOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBHZW5lcmF0ZXMgb25lIGNvbHVtbiBmb3IgZWFjaCB0aW1lIHVuaXQgYmV0d2VlbiB0aGUgZ2l2ZW4gZnJvbSBhbmQgdG8gZGF0ZS4KICAgICAgICBzZWxmLmdlbmVyYXRlID0gZnVuY3Rpb24oZnJvbSwgdG8sIG1heGltdW1XaWR0aCwgbGVmdE9mZnNldCwgcmV2ZXJzZSkgewogICAgICAgICAgICBpZiAoIXRvICYmICFtYXhpbXVtV2lkdGgpIHsKICAgICAgICAgICAgICAgIHRocm93ICd0byBvciBtYXhpbXVtV2lkdGggbXVzdCBiZSBkZWZpbmVkJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGV4Y2x1ZGVUbyA9IGZhbHNlOwogICAgICAgICAgICBmcm9tID0gbW9tZW50KGZyb20pLnN0YXJ0T2YodW5pdCk7CiAgICAgICAgICAgIGlmICh0bykgewogICAgICAgICAgICAgICAgZXhjbHVkZVRvID0gaXNUb0RhdGVUb0V4Y2x1ZGUodG8pOwogICAgICAgICAgICAgICAgdG8gPSBtb21lbnQodG8pLnN0YXJ0T2YodW5pdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkYXRlID0gbW9tZW50KGZyb20pLnN0YXJ0T2YodW5pdCk7CiAgICAgICAgICAgIHZhciBnZW5lcmF0ZWRDb2xzID0gW107CiAgICAgICAgICAgIHZhciBsZWZ0ID0gMDsKCiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAobWF4aW11bVdpZHRoICYmIE1hdGguYWJzKGxlZnQpID4gbWF4aW11bVdpZHRoICsgY29sdW1uV2lkdGgpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgc3RhcnREYXRlID0gbW9tZW50KGRhdGUpOwogICAgICAgICAgICAgICAgdmFyIGVuZERhdGUgPSBtb21lbnQoc3RhcnREYXRlKS5hZGQoMSwgdW5pdCk7CgogICAgICAgICAgICAgICAgdmFyIGNvbHVtbiA9IG5ldyBDb2x1bW4oc3RhcnREYXRlLCBlbmREYXRlLCBsZWZ0T2Zmc2V0ID8gbGVmdCArIGxlZnRPZmZzZXQgOiBsZWZ0LCBjb2x1bW5XaWR0aCwgY2FsZW5kYXIsIHRpbWVGcmFtZXNXb3JraW5nTW9kZSwgdGltZUZyYW1lc05vbldvcmtpbmdNb2RlLCBjb2x1bW5NYWduZXRWYWx1ZSwgY29sdW1uTWFnbmV0VW5pdCk7CiAgICAgICAgICAgICAgICBpZiAoIWNvbHVtbi5jcm9wcGVkKSB7CiAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGVkQ29scy5wdXNoKGNvbHVtbik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJldmVyc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGVmdCAtPSBjb2x1bW5XaWR0aDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBsZWZ0ICs9IGNvbHVtbldpZHRoOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHRvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXZlcnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZVRvICYmIGRhdGUgPCB0byB8fCAhZXhjbHVkZVRvICYmIGRhdGUgPD0gdG8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlVG8gJiYgZGF0ZSA+IHRvIHx8ICFleGNsdWRlVG8gJiYgZGF0ZSA+PSB0bykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGF0ZS5hZGQocmV2ZXJzZSA/IC0xIDogMSwgdW5pdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChyZXZlcnNlKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNUb0RhdGVUb0V4Y2x1ZGUoZnJvbSkpIHsKICAgICAgICAgICAgICAgICAgICBnZW5lcmF0ZWRDb2xzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBnZW5lcmF0ZWRDb2xzLnJldmVyc2UoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGdlbmVyYXRlZENvbHM7CiAgICAgICAgfTsKCiAgICAgICAgLy8gQ29sdW1ucyBhcmUgZ2VuZXJhdGVkIGluY2x1ZGluZyBvciBleGNsdWRpbmcgdGhlIHRvIGRhdGUuCiAgICAgICAgLy8gSWYgdGhlIFRvIGRhdGUgaXMgdGhlIGZpcnN0IGRheSBvZiBtb250aCBhbmQgdGhlIHRpbWUgaXMgMDA6MDAgdGhlbiBubyBuZXcgY29sdW1uIGlzIGdlbmVyYXRlZCBmb3IgdGhpcyBtb250aC4KCiAgICAgICAgdmFyIGlzVG9EYXRlVG9FeGNsdWRlID0gZnVuY3Rpb24odG8pIHsKICAgICAgICAgICAgcmV0dXJuIG1vbWVudCh0bykuYWRkKDEsIHVuaXQpLnN0YXJ0T2YodW5pdCkgPT09IHRvOwogICAgICAgIH07CiAgICB9OwogICAgcmV0dXJuIENvbHVtbkdlbmVyYXRvcjsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0Q29sdW1uSGVhZGVyJywgWyAnbW9tZW50JywgJ0dhbnR0Q29sdW1uJywgZnVuY3Rpb24obW9tZW50LCBDb2x1bW4pIHsKICAgIC8vIFVzZWQgdG8gZGlzcGxheSB0aGUgR2FudHQgZ3JpZCBhbmQgaGVhZGVyLgogICAgLy8gVGhlIGNvbHVtbnMgYXJlIGdlbmVyYXRlZCBieSB0aGUgY29sdW1uIGdlbmVyYXRvci4KCiAgICB2YXIgQ29sdW1uSGVhZGVyID0gZnVuY3Rpb24oZGF0ZSwgdW5pdCwgbGVmdCwgd2lkdGgsIGxhYmVsKSB7CiAgICAgICAgdmFyIHN0YXJ0RGF0ZSA9IG1vbWVudChkYXRlKTsKICAgICAgICB2YXIgZW5kRGF0ZSA9IG1vbWVudChzdGFydERhdGUpLmFkZCgxLCB1bml0KTsKCiAgICAgICAgdmFyIGNvbHVtbiA9IG5ldyBDb2x1bW4oc3RhcnREYXRlLCBlbmREYXRlLCBsZWZ0LCB3aWR0aCk7CiAgICAgICAgY29sdW1uLnVuaXQgPSB1bml0OwogICAgICAgIGNvbHVtbi5sYWJlbCA9IGxhYmVsOwoKICAgICAgICByZXR1cm4gY29sdW1uOwogICAgfTsKICAgIHJldHVybiBDb2x1bW5IZWFkZXI7Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdHYW50dENvbHVtbnNNYW5hZ2VyJywgWydHYW50dENvbHVtbkdlbmVyYXRvcicsICdHYW50dEhlYWRlckdlbmVyYXRvcicsICckZmlsdGVyJywgJ2dhbnR0TGF5b3V0JywgJ2dhbnR0QmluYXJ5U2VhcmNoJywgZnVuY3Rpb24oQ29sdW1uR2VuZXJhdG9yLCBIZWFkZXJHZW5lcmF0b3IsICRmaWx0ZXIsIGxheW91dCwgYnMpIHsKICAgIHZhciBDb2x1bW5zTWFuYWdlciA9IGZ1bmN0aW9uKGdhbnR0KSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICB0aGlzLmdhbnR0ID0gZ2FudHQ7CgogICAgICAgIHRoaXMuZnJvbSA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLnRvID0gdW5kZWZpbmVkOwoKICAgICAgICB0aGlzLmNvbHVtbnMgPSBbXTsKICAgICAgICB0aGlzLnZpc2libGVDb2x1bW5zID0gW107CiAgICAgICAgdGhpcy5wcmV2aW91c0NvbHVtbnMgPSBbXTsKICAgICAgICB0aGlzLm5leHRDb2x1bW5zID0gW107CgogICAgICAgIHRoaXMuaGVhZGVycyA9IHt9OwogICAgICAgIHRoaXMudmlzaWJsZUhlYWRlcnMgPSB7fTsKCiAgICAgICAgdGhpcy5zY3JvbGxBbmNob3IgPSB1bmRlZmluZWQ7CgogICAgICAgIC8vIEFkZCBhIHdhdGNoZXIgaWYgYSB2aWV3IHJlbGF0ZWQgc2V0dGluZyBjaGFuZ2VkIGZyb20gb3V0c2lkZSBvZiB0aGUgR2FudHQuIFVwZGF0ZSB0aGUgZ2FudHQgYWNjb3JkaW5nbHkgaWYgc28uCiAgICAgICAgLy8gQWxsIHRob3NlIGNoYW5nZXMgbmVlZCBhIHJlY2FsY3VsYXRpb24gb2YgdGhlIGhlYWRlciBjb2x1bW5zCiAgICAgICAgdGhpcy5nYW50dC4kc2NvcGUuJHdhdGNoR3JvdXAoWyd2aWV3U2NhbGUnLCAnY29sdW1uV2lkdGgnLCAndGltZUZyYW1lc1dvcmtpbmdNb2RlJywgJ3RpbWVGcmFtZXNOb25Xb3JraW5nTW9kZScsICdjb2x1bW5NYWduZXQnLCAnZnJvbURhdGUnLCAndG9EYXRlJywgJ2F1dG9FeHBhbmQnLCAndGFza091dE9mUmFuZ2UnXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNlbGYuZ2VuZXJhdGVDb2x1bW5zKCk7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuZ2FudHQuJHNjb3BlLiR3YXRjaENvbGxlY3Rpb24oJ2hlYWRlcnMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi5nZW5lcmF0ZUNvbHVtbnMoKTsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5nYW50dC4kc2NvcGUuJHdhdGNoQ29sbGVjdGlvbignaGVhZGVyc0Zvcm1hdHMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi5nZW5lcmF0ZUNvbHVtbnMoKTsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5nYW50dC4kc2NvcGUuJHdhdGNoR3JvdXAoWydnYW50dEVsZW1lbnRXaWR0aCcsICdsYWJlbHNXaWR0aCcsICdzaG93TGFiZWxzQ29sdW1uJywgJ21heEhlaWdodCddLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi51cGRhdGVDb2x1bW5zTWV0YSgpOwogICAgICAgIH0pOwoKICAgICAgICB0aGlzLmdhbnR0LiRzY29wZS4kd2F0Y2hHcm91cChbJ3Njcm9sbExlZnQnLCAnc2Nyb2xsV2lkdGgnXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNlbGYudXBkYXRlVmlzaWJsZUNvbHVtbnMoKTsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5nYW50dC5hcGkuZGF0YS5vbi5sb2FkKHRoaXMuZ2FudHQuJHNjb3BlLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHNlbGYuZnJvbSA+IHNlbGYuZ2FudHQucm93c01hbmFnZXIuZ2V0RGVmYXVsdEZyb20oKSB8fAogICAgICAgICAgICAgICAgc2VsZi50byA8IHNlbGYuZ2FudHQucm93c01hbmFnZXIuZ2V0RGVmYXVsdFRvKCkpIHsKICAgICAgICAgICAgICAgIHNlbGYuZ2VuZXJhdGVDb2x1bW5zKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlbGYuZ2FudHQucm93c01hbmFnZXIuc29ydFJvd3MoKTsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5nYW50dC5hcGkuZGF0YS5vbi5yZW1vdmUodGhpcy5nYW50dC4kc2NvcGUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzZWxmLmdhbnR0LnJvd3NNYW5hZ2VyLnNvcnRSb3dzKCk7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyTWV0aG9kKCdjb2x1bW5zJywgJ2NsZWFyJywgdGhpcy5jbGVhckNvbHVtbnMsIHRoaXMpOwogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyTWV0aG9kKCdjb2x1bW5zJywgJ2dlbmVyYXRlJywgdGhpcy5nZW5lcmF0ZUNvbHVtbnMsIHRoaXMpOwoKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3RlckV2ZW50KCdjb2x1bW5zJywgJ2dlbmVyYXRlJyk7CiAgICB9OwoKICAgIENvbHVtbnNNYW5hZ2VyLnByb3RvdHlwZS5zZXRTY3JvbGxBbmNob3IgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5nYW50dC5zY3JvbGwuJGVsZW1lbnQgJiYgdGhpcy5jb2x1bW5zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIGVsID0gdGhpcy5nYW50dC5zY3JvbGwuJGVsZW1lbnRbMF07CiAgICAgICAgICAgIHZhciBjZW50ZXIgPSBlbC5zY3JvbGxMZWZ0ICsgZWwub2Zmc2V0V2lkdGggLyAyOwoKICAgICAgICAgICAgdGhpcy5zY3JvbGxBbmNob3IgPSB0aGlzLmdhbnR0LmdldERhdGVCeVBvc2l0aW9uKGNlbnRlcik7CiAgICAgICAgfQogICAgfTsKCiAgICBDb2x1bW5zTWFuYWdlci5wcm90b3R5cGUuc2Nyb2xsVG9TY3JvbGxBbmNob3IgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIGlmICh0aGlzLmNvbHVtbnMubGVuZ3RoID4gMCAmJiB0aGlzLnNjcm9sbEFuY2hvciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIC8vIFVnbHkgYnV0IHByZXZlbnRzIHNjcmVlbiBmbGlja2VyaW5nICh1bmxpa2UgJHRpbWVvdXQpCiAgICAgICAgICAgIHRoaXMuZ2FudHQuJHNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNlbGYuZ2FudHQuYXBpLnNjcm9sbC50b0RhdGUoc2VsZi5zY3JvbGxBbmNob3IpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9OwoKICAgIENvbHVtbnNNYW5hZ2VyLnByb3RvdHlwZS5jbGVhckNvbHVtbnMgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNldFNjcm9sbEFuY2hvcigpOwoKICAgICAgICB0aGlzLmZyb20gPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy50byA9IHVuZGVmaW5lZDsKCiAgICAgICAgdGhpcy5jb2x1bW5zID0gW107CiAgICAgICAgdGhpcy52aXNpYmxlQ29sdW1ucyA9IFtdOwogICAgICAgIHRoaXMucHJldmlvdXNDb2x1bW5zID0gW107CiAgICAgICAgdGhpcy5uZXh0Q29sdW1ucyA9IFtdOwoKICAgICAgICB0aGlzLmhlYWRlcnMgPSBbXTsKICAgICAgICB0aGlzLnZpc2libGVIZWFkZXJzID0ge307CgogICAgICAgIHRoaXMuZ2FudHQuYXBpLmNvbHVtbnMucmFpc2UuY2xlYXIoKTsKICAgIH07CgogICAgQ29sdW1uc01hbmFnZXIucHJvdG90eXBlLmdlbmVyYXRlQ29sdW1ucyA9IGZ1bmN0aW9uKGZyb20sIHRvKSB7CiAgICAgICAgaWYgKCFmcm9tKSB7CiAgICAgICAgICAgIGZyb20gPSB0aGlzLmdhbnR0LiRzY29wZS5mcm9tRGF0ZTsKICAgICAgICB9CgogICAgICAgIGlmICghdG8pIHsKICAgICAgICAgICAgdG8gPSB0aGlzLmdhbnR0LiRzY29wZS50b0RhdGU7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWZyb20pIHsKICAgICAgICAgICAgZnJvbSA9IHRoaXMuZ2FudHQucm93c01hbmFnZXIuZ2V0RGVmYXVsdEZyb20oKTsKICAgICAgICAgICAgaWYgKCFmcm9tKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICghdG8pIHsKICAgICAgICAgICAgdG8gPSB0aGlzLmdhbnR0LnJvd3NNYW5hZ2VyLmdldERlZmF1bHRUbygpOwogICAgICAgICAgICBpZiAoIXRvKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbnR0LiRzY29wZS50YXNrT3V0T2ZSYW5nZSA9PT0gJ2V4cGFuZCcpIHsKICAgICAgICAgICAgZnJvbSA9IHRoaXMuZ2FudHQucm93c01hbmFnZXIuZ2V0RXhwYW5kZWRGcm9tKGZyb20pOwogICAgICAgICAgICB0byA9IHRoaXMuZ2FudHQucm93c01hbmFnZXIuZ2V0RXhwYW5kZWRUbyh0byk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNldFNjcm9sbEFuY2hvcigpOwoKICAgICAgICB0aGlzLmZyb20gPSBmcm9tOwogICAgICAgIHRoaXMudG8gPSB0bzsKCiAgICAgICAgdmFyIGNvbHVtbkdlbmVyYXRvciA9IG5ldyBDb2x1bW5HZW5lcmF0b3IodGhpcyk7CiAgICAgICAgdmFyIGhlYWRlckdlbmVyYXRvciA9IG5ldyBIZWFkZXJHZW5lcmF0b3IodGhpcyk7CgogICAgICAgIHRoaXMuY29sdW1ucyA9IGNvbHVtbkdlbmVyYXRvci5nZW5lcmF0ZShmcm9tLCB0byk7CiAgICAgICAgdGhpcy5oZWFkZXJzID0gaGVhZGVyR2VuZXJhdG9yLmdlbmVyYXRlKHRoaXMuY29sdW1ucyk7CiAgICAgICAgdGhpcy5wcmV2aW91c0NvbHVtbnMgPSBbXTsKICAgICAgICB0aGlzLm5leHRDb2x1bW5zID0gW107CgogICAgICAgIHRoaXMudXBkYXRlQ29sdW1uc01ldGEoKTsKICAgICAgICB0aGlzLnNjcm9sbFRvU2Nyb2xsQW5jaG9yKCk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkuY29sdW1ucy5yYWlzZS5nZW5lcmF0ZSh0aGlzLmNvbHVtbnMsIHRoaXMuaGVhZGVycyk7CiAgICB9OwoKICAgIENvbHVtbnNNYW5hZ2VyLnByb3RvdHlwZS51cGRhdGVDb2x1bW5zTWV0YSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBsYXN0Q29sdW1uID0gdGhpcy5nZXRMYXN0Q29sdW1uKCk7CiAgICAgICAgdGhpcy5nYW50dC5vcmlnaW5hbFdpZHRoID0gbGFzdENvbHVtbiAhPT0gdW5kZWZpbmVkID8gbGFzdENvbHVtbi5vcmlnaW5hbFNpemUubGVmdCArIGxhc3RDb2x1bW4ub3JpZ2luYWxTaXplLndpZHRoIDogMDsKCiAgICAgICAgaWYgKHRoaXMuZ2FudHQuJHNjb3BlLmNvbHVtbldpZHRoID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdmFyIG5ld1dpZHRoID0gdGhpcy5nYW50dC4kc2NvcGUuZ2FudHRFbGVtZW50V2lkdGggLSAodGhpcy5nYW50dC4kc2NvcGUuc2hvd0xhYmVsc0NvbHVtbiA/IHRoaXMuZ2FudHQuJHNjb3BlLmxhYmVsc1dpZHRoIDogMCk7CgogICAgICAgICAgICBpZiAodGhpcy5nYW50dC4kc2NvcGUubWF4SGVpZ2h0ID4gMCkgewogICAgICAgICAgICAgICAgbmV3V2lkdGggPSBuZXdXaWR0aCAtIGxheW91dC5nZXRTY3JvbGxCYXJXaWR0aCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsYXlvdXQuc2V0Q29sdW1uc1dpZHRoKG5ld1dpZHRoLCB0aGlzLmdhbnR0Lm9yaWdpbmFsV2lkdGgsIHRoaXMucHJldmlvdXNDb2x1bW5zKTsKICAgICAgICAgICAgbGF5b3V0LnNldENvbHVtbnNXaWR0aChuZXdXaWR0aCwgdGhpcy5nYW50dC5vcmlnaW5hbFdpZHRoLCB0aGlzLmNvbHVtbnMpOwogICAgICAgICAgICBsYXlvdXQuc2V0Q29sdW1uc1dpZHRoKG5ld1dpZHRoLCB0aGlzLmdhbnR0Lm9yaWdpbmFsV2lkdGgsIHRoaXMubmV4dENvbHVtbnMpOwoKICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRoaXMuaGVhZGVycywgZnVuY3Rpb24oaGVhZGVyKSB7CiAgICAgICAgICAgICAgICBsYXlvdXQuc2V0Q29sdW1uc1dpZHRoKG5ld1dpZHRoLCB0aGlzLmdhbnR0Lm9yaWdpbmFsV2lkdGgsIGhlYWRlcik7CiAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5nYW50dC53aWR0aCA9IGxhc3RDb2x1bW4gIT09IHVuZGVmaW5lZCA/IGxhc3RDb2x1bW4ubGVmdCArIGxhc3RDb2x1bW4ud2lkdGggOiAwOwoKICAgICAgICB0aGlzLmdhbnR0LnJvd3NNYW5hZ2VyLnVwZGF0ZVRhc2tzUG9zQW5kU2l6ZSgpOwogICAgICAgIHRoaXMuZ2FudHQudGltZXNwYW5zTWFuYWdlci51cGRhdGVUaW1lc3BhbnNQb3NBbmRTaXplKCk7CgogICAgICAgIHRoaXMudXBkYXRlVmlzaWJsZUNvbHVtbnMoKTsKICAgICAgICB0aGlzLmdhbnR0LnJvd3NNYW5hZ2VyLnVwZGF0ZVZpc2libGVPYmplY3RzKCk7CgogICAgICAgIHRoaXMuZ2FudHQuY3VycmVudERhdGVNYW5hZ2VyLnNldEN1cnJlbnREYXRlKHRoaXMuZ2FudHQuJHNjb3BlLmN1cnJlbnREYXRlVmFsdWUpOwogICAgfTsKCiAgICAvLyBSZXR1cm5zIHRoZSBsYXN0IEdhbnR0IGNvbHVtbiBvciB1bmRlZmluZWQKICAgIENvbHVtbnNNYW5hZ2VyLnByb3RvdHlwZS5nZXRMYXN0Q29sdW1uID0gZnVuY3Rpb24oZXh0ZW5kZWQpIHsKICAgICAgICB2YXIgY29sdW1ucyA9IHRoaXMuY29sdW1uczsKICAgICAgICBpZiAoZXh0ZW5kZWQpIHsKICAgICAgICAgICAgY29sdW1ucyA9IHRoaXMubmV4dENvbHVtbnM7CiAgICAgICAgfQogICAgICAgIGlmIChjb2x1bW5zICYmIGNvbHVtbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICByZXR1cm4gY29sdW1uc1tjb2x1bW5zLmxlbmd0aCAtIDFdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBSZXR1cm5zIHRoZSBmaXJzdCBHYW50dCBjb2x1bW4gb3IgdW5kZWZpbmVkCiAgICBDb2x1bW5zTWFuYWdlci5wcm90b3R5cGUuZ2V0Rmlyc3RDb2x1bW4gPSBmdW5jdGlvbihleHRlbmRlZCkgewogICAgICAgIHZhciBjb2x1bW5zID0gdGhpcy5jb2x1bW5zOwogICAgICAgIGlmIChleHRlbmRlZCkgewogICAgICAgICAgICBjb2x1bW5zID0gdGhpcy5wcmV2aW91c0NvbHVtbnM7CiAgICAgICAgfQoKICAgICAgICBpZiAoY29sdW1ucyAmJiBjb2x1bW5zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgcmV0dXJuIGNvbHVtbnNbMF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIFJldHVybnMgdGhlIGNvbHVtbiBhdCB0aGUgZ2l2ZW4gb3IgbmV4dCBwb3NzaWJsZSBkYXRlCiAgICBDb2x1bW5zTWFuYWdlci5wcm90b3R5cGUuZ2V0Q29sdW1uQnlEYXRlID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgIHRoaXMuZXhwYW5kRXh0ZW5kZWRDb2x1bW5zRm9yRGF0ZShkYXRlKTsKICAgICAgICB2YXIgZXh0ZW5kZWRDb2x1bW5zID0gdGhpcy5wcmV2aW91c0NvbHVtbnMuY29uY2F0KHRoaXMuY29sdW1ucywgdGhpcy5uZXh0Q29sdW1ucyk7CiAgICAgICAgdmFyIGNvbHVtbnMgPSBicy5nZXQoZXh0ZW5kZWRDb2x1bW5zLCBkYXRlLCBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgIHJldHVybiBjLmRhdGU7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGNvbHVtbnNbMF0gIT09IHVuZGVmaW5lZCA/IGNvbHVtbnNbMF0gOiBjb2x1bW5zWzFdOwogICAgfTsKCiAgICAvLyBSZXR1cm5zIHRoZSBjb2x1bW4gYXQgdGhlIGdpdmVuIHBvc2l0aW9uIHggKGluIGVtKQogICAgQ29sdW1uc01hbmFnZXIucHJvdG90eXBlLmdldENvbHVtbkJ5UG9zaXRpb24gPSBmdW5jdGlvbih4KSB7CiAgICAgICAgdGhpcy5leHBhbmRFeHRlbmRlZENvbHVtbnNGb3JQb3NpdGlvbih4KTsKICAgICAgICB2YXIgZXh0ZW5kZWRDb2x1bW5zID0gdGhpcy5wcmV2aW91c0NvbHVtbnMuY29uY2F0KHRoaXMuY29sdW1ucywgdGhpcy5uZXh0Q29sdW1ucyk7CiAgICAgICAgcmV0dXJuIGJzLmdldChleHRlbmRlZENvbHVtbnMsIHgsIGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgcmV0dXJuIGMubGVmdDsKICAgICAgICB9KVswXTsKICAgIH07CgogICAgQ29sdW1uc01hbmFnZXIucHJvdG90eXBlLmV4cGFuZEV4dGVuZGVkQ29sdW1uc0ZvclBvc2l0aW9uID0gZnVuY3Rpb24oeCkgewogICAgICAgIGlmICh4IDwgMCkgewogICAgICAgICAgICB2YXIgZmlyc3RDb2x1bW4gPSB0aGlzLmdldEZpcnN0Q29sdW1uKCk7CiAgICAgICAgICAgIHZhciBmcm9tID0gZmlyc3RDb2x1bW4uZGF0ZTsKICAgICAgICAgICAgdmFyIGZpcnN0RXh0ZW5kZWRDb2x1bW4gPSB0aGlzLmdldEZpcnN0Q29sdW1uKHRydWUpOwogICAgICAgICAgICBpZiAoIWZpcnN0RXh0ZW5kZWRDb2x1bW4gfHwgZmlyc3RFeHRlbmRlZENvbHVtbi5sZWZ0ID4geCkgewogICAgICAgICAgICAgICAgdGhpcy5wcmV2aW91c0NvbHVtbnMgPSBuZXcgQ29sdW1uR2VuZXJhdG9yKHRoaXMpLmdlbmVyYXRlKGZyb20sIHVuZGVmaW5lZCwgLXgsIDAsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoeCA+IHRoaXMud2lkdGgpIHsKICAgICAgICAgICAgdmFyIGxhc3RDb2x1bW4gPSB0aGlzLmdldExhc3RDb2x1bW4oKTsKICAgICAgICAgICAgdmFyIGVuZERhdGUgPSBsYXN0Q29sdW1uLmdldERhdGVCeVBvc2l0aW9uKGxhc3RDb2x1bW4ud2lkdGgpOwogICAgICAgICAgICB2YXIgbGFzdEV4dGVuZGVkQ29sdW1uID0gdGhpcy5nZXRMYXN0Q29sdW1uKHRydWUpOwogICAgICAgICAgICBpZiAoIWxhc3RFeHRlbmRlZENvbHVtbiB8fCBsYXN0RXh0ZW5kZWRDb2x1bW4ubGVmdCArIGxhc3RFeHRlbmRlZENvbHVtbi53aWR0aCA8IHgpIHsKICAgICAgICAgICAgICAgIHRoaXMubmV4dENvbHVtbnMgPSBuZXcgQ29sdW1uR2VuZXJhdG9yKHRoaXMpLmdlbmVyYXRlKGVuZERhdGUsIHVuZGVmaW5lZCwgeCAtIHRoaXMud2lkdGgsIHRoaXMud2lkdGgsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICBDb2x1bW5zTWFuYWdlci5wcm90b3R5cGUuZXhwYW5kRXh0ZW5kZWRDb2x1bW5zRm9yRGF0ZSA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICB2YXIgZmlyc3RDb2x1bW4gPSB0aGlzLmdldEZpcnN0Q29sdW1uKCk7CiAgICAgICAgdmFyIGZyb207CiAgICAgICAgaWYgKGZpcnN0Q29sdW1uKSB7CiAgICAgICAgICAgIGZyb20gPSBmaXJzdENvbHVtbi5kYXRlOwogICAgICAgIH0KCiAgICAgICAgdmFyIGxhc3RDb2x1bW4gPSB0aGlzLmdldExhc3RDb2x1bW4oKTsKICAgICAgICB2YXIgZW5kRGF0ZTsKICAgICAgICBpZiAobGFzdENvbHVtbikgewogICAgICAgICAgICBlbmREYXRlID0gbGFzdENvbHVtbi5nZXREYXRlQnlQb3NpdGlvbihsYXN0Q29sdW1uLndpZHRoKTsKICAgICAgICB9CgogICAgICAgIGlmIChmcm9tICYmIGRhdGUgPCBmcm9tKSB7CiAgICAgICAgICAgIHZhciBmaXJzdEV4dGVuZGVkQ29sdW1uID0gdGhpcy5nZXRGaXJzdENvbHVtbih0cnVlKTsKICAgICAgICAgICAgaWYgKCFmaXJzdEV4dGVuZGVkQ29sdW1uIHx8IGZpcnN0RXh0ZW5kZWRDb2x1bW4uZGF0ZSA+IGRhdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMucHJldmlvdXNDb2x1bW5zID0gbmV3IENvbHVtbkdlbmVyYXRvcih0aGlzKS5nZW5lcmF0ZShmcm9tLCBkYXRlLCB1bmRlZmluZWQsIDAsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoZW5kRGF0ZSAmJiBkYXRlID4gZW5kRGF0ZSkgewogICAgICAgICAgICB2YXIgbGFzdEV4dGVuZGVkQ29sdW1uID0gdGhpcy5nZXRMYXN0Q29sdW1uKHRydWUpOwogICAgICAgICAgICBpZiAoIWxhc3RFeHRlbmRlZENvbHVtbiB8fCBlbmREYXRlIDwgbGFzdEV4dGVuZGVkQ29sdW1uKSB7CiAgICAgICAgICAgICAgICB0aGlzLm5leHRDb2x1bW5zID0gbmV3IENvbHVtbkdlbmVyYXRvcih0aGlzKS5nZW5lcmF0ZShlbmREYXRlLCBkYXRlLCB1bmRlZmluZWQsIHRoaXMud2lkdGgsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICAvLyBSZXR1cm5zIHRoZSBudW1iZXIgb2YgYWN0aXZlIGhlYWRlcnMKICAgIENvbHVtbnNNYW5hZ2VyLnByb3RvdHlwZS5nZXRBY3RpdmVIZWFkZXJzQ291bnQgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc2l6ZSA9IDAsIGtleTsKICAgICAgICBmb3IgKGtleSBpbiB0aGlzLmhlYWRlcnMpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaGVhZGVycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICBzaXplKys7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNpemU7CiAgICB9OwoKICAgIENvbHVtbnNNYW5hZ2VyLnByb3RvdHlwZS51cGRhdGVWaXNpYmxlQ29sdW1ucyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudmlzaWJsZUNvbHVtbnMgPSAkZmlsdGVyKCdnYW50dENvbHVtbkxpbWl0JykodGhpcy5jb2x1bW5zLCB0aGlzLmdhbnR0LiRzY29wZS5zY3JvbGxMZWZ0LCB0aGlzLmdhbnR0LiRzY29wZS5zY3JvbGxXaWR0aCk7CgogICAgICAgIHRoaXMudmlzaWJsZUhlYWRlcnMgPSB7fTsKICAgICAgICBhbmd1bGFyLmZvckVhY2godGhpcy5oZWFkZXJzLCBmdW5jdGlvbihoZWFkZXJzLCBrZXkpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaGVhZGVycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZpc2libGVIZWFkZXJzW2tleV0gPSAkZmlsdGVyKCdnYW50dENvbHVtbkxpbWl0JykoaGVhZGVycywgdGhpcy5nYW50dC4kc2NvcGUuc2Nyb2xsTGVmdCwgdGhpcy5nYW50dC4kc2NvcGUuc2Nyb2xsV2lkdGgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwgdGhpcyk7CiAgICB9OwoKICAgIHZhciBkZWZhdWx0SGVhZGVyc0Zvcm1hdHMgPSB7J3llYXInOiAnWVlZWScsICdxdWFydGVyJzogJ1tRXVEgWVlZWScsIG1vbnRoOiAnTU1NTSBZWVlZJywgd2VlazogJ3cnLCBkYXk6ICdEJywgaG91cjogJ0gnLCBtaW51dGU6J0hIOm1tJ307CiAgICB2YXIgZGVmYXVsdERheUhlYWRlcnNGb3JtYXRzID0ge2RheTogJ0xMJywgaG91cjogJ0gnLCBtaW51dGU6J0hIOm1tJ307CiAgICB2YXIgZGVmYXVsdFllYXJIZWFkZXJzRm9ybWF0cyA9IHsneWVhcic6ICdZWVlZJywgJ3F1YXJ0ZXInOiAnW1FdUScsIG1vbnRoOiAnTU1NTSd9OwoKICAgIENvbHVtbnNNYW5hZ2VyLnByb3RvdHlwZS5nZXRIZWFkZXJGb3JtYXQgPSBmdW5jdGlvbih1bml0KSB7CiAgICAgICAgdmFyIGZvcm1hdDsKICAgICAgICBpZiAodGhpcy5nYW50dC4kc2NvcGUuaGVhZGVyc0Zvcm1hdHMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBmb3JtYXQgPSB0aGlzLmdhbnR0LiRzY29wZS5oZWFkZXJzRm9ybWF0c1t1bml0XTsKICAgICAgICB9CiAgICAgICAgaWYgKGZvcm1hdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGlmIChbJ21pbGxpc2Vjb25kJywgJ3NlY29uZCcsICdtaW51dGUnLCAnaG91ciddLmluZGV4T2YodGhpcy5nYW50dC4kc2NvcGUudmlld1NjYWxlKSA+IC0xKSB7CiAgICAgICAgICAgICAgICBmb3JtYXQgPSBkZWZhdWx0RGF5SGVhZGVyc0Zvcm1hdHNbdW5pdF07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoWydtb250aCcsICdxdWFydGVyJywgJ3llYXInXS5pbmRleE9mKHRoaXMuZ2FudHQuJHNjb3BlLnZpZXdTY2FsZSkgPiAtMSkgewogICAgICAgICAgICAgICAgZm9ybWF0ID0gZGVmYXVsdFllYXJIZWFkZXJzRm9ybWF0c1t1bml0XTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZm9ybWF0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGZvcm1hdCA9IGRlZmF1bHRIZWFkZXJzRm9ybWF0c1t1bml0XTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZm9ybWF0OwogICAgfTsKCiAgICByZXR1cm4gQ29sdW1uc01hbmFnZXI7Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdHYW50dEhlYWRlckdlbmVyYXRvcicsIFsnR2FudHRDb2x1bW5IZWFkZXInLCBmdW5jdGlvbihDb2x1bW5IZWFkZXIpIHsKICAgIHZhciBnZW5lcmF0ZUhlYWRlciA9IGZ1bmN0aW9uKGNvbHVtbnNNYW5hZ2VyLCBjb2x1bW5zLCB1bml0KSB7CiAgICAgICAgdmFyIGdlbmVyYXRlZEhlYWRlcnMgPSBbXTsKICAgICAgICB2YXIgaGVhZGVyOwogICAgICAgIHZhciBwcmV2Q29sRGF0ZVZhbDsKCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjb2x1bW5zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB2YXIgY29sID0gY29sdW1uc1tpXTsKICAgICAgICAgICAgdmFyIGNvbERhdGVWYWwgPSBjb2wuZGF0ZS5nZXQodW5pdCk7CiAgICAgICAgICAgIGlmIChpID09PSAwIHx8IHByZXZDb2xEYXRlVmFsICE9PSBjb2xEYXRlVmFsKSB7CiAgICAgICAgICAgICAgICBwcmV2Q29sRGF0ZVZhbCA9IGNvbERhdGVWYWw7CiAgICAgICAgICAgICAgICB2YXIgbGFiZWwgPSBjb2wuZGF0ZS5mb3JtYXQoY29sdW1uc01hbmFnZXIuZ2V0SGVhZGVyRm9ybWF0KHVuaXQpKTsKCiAgICAgICAgICAgICAgICBoZWFkZXIgPSBuZXcgQ29sdW1uSGVhZGVyKGNvbC5kYXRlLCB1bml0LCBjb2wub3JpZ2luYWxTaXplLmxlZnQsIGNvbC5vcmlnaW5hbFNpemUud2lkdGgsIGxhYmVsKTsKICAgICAgICAgICAgICAgIGhlYWRlci5sZWZ0ID0gY29sLmxlZnQ7CiAgICAgICAgICAgICAgICBoZWFkZXIud2lkdGggPSBjb2wud2lkdGg7CiAgICAgICAgICAgICAgICBnZW5lcmF0ZWRIZWFkZXJzLnB1c2goaGVhZGVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGhlYWRlci5vcmlnaW5hbFNpemUud2lkdGggKz0gY29sLm9yaWdpbmFsU2l6ZS53aWR0aDsKICAgICAgICAgICAgICAgIGhlYWRlci53aWR0aCArPSBjb2wud2lkdGg7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdlbmVyYXRlZEhlYWRlcnM7CgogICAgfTsKCiAgICByZXR1cm4gZnVuY3Rpb24oY29sdW1uc01hbmFnZXIpIHsKICAgICAgICB0aGlzLmdlbmVyYXRlID0gZnVuY3Rpb24oY29sdW1ucykgewogICAgICAgICAgICB2YXIgdW5pdHMgPSBbXTsKICAgICAgICAgICAgaWYgKGNvbHVtbnNNYW5hZ2VyLmdhbnR0LiRzY29wZS5oZWFkZXJzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHVuaXRzID0gW107CiAgICAgICAgICAgICAgICBpZiAoWyd5ZWFyJywgJ3F1YXJ0ZXInLCAnbW9udGgnXS5pbmRleE9mKGNvbHVtbnNNYW5hZ2VyLmdhbnR0LiRzY29wZS52aWV3U2NhbGUpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICB1bml0cy5wdXNoKCd5ZWFyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoWydxdWFydGVyJ10uaW5kZXhPZihjb2x1bW5zTWFuYWdlci5nYW50dC4kc2NvcGUudmlld1NjYWxlKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdW5pdHMucHVzaCgncXVhcnRlcicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKFsnZGF5JywgJ3dlZWsnLCAnbW9udGgnXS5pbmRleE9mKGNvbHVtbnNNYW5hZ2VyLmdhbnR0LiRzY29wZS52aWV3U2NhbGUpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICB1bml0cy5wdXNoKCdtb250aCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKFsnZGF5JywgJ3dlZWsnXS5pbmRleE9mKGNvbHVtbnNNYW5hZ2VyLmdhbnR0LiRzY29wZS52aWV3U2NhbGUpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICB1bml0cy5wdXNoKCd3ZWVrJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoWydob3VyJywgJ2RheSddLmluZGV4T2YoY29sdW1uc01hbmFnZXIuZ2FudHQuJHNjb3BlLnZpZXdTY2FsZSkgPiAtMSkgewogICAgICAgICAgICAgICAgICAgIHVuaXRzLnB1c2goJ2RheScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKFsnaG91cicsICdtaW51dGUnLCAnc2Vjb25kJ10uaW5kZXhPZihjb2x1bW5zTWFuYWdlci5nYW50dC4kc2NvcGUudmlld1NjYWxlKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdW5pdHMucHVzaCgnaG91cicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKFsnbWludXRlJywgJ3NlY29uZCddLmluZGV4T2YoY29sdW1uc01hbmFnZXIuZ2FudHQuJHNjb3BlLnZpZXdTY2FsZSkgPiAtMSkgewogICAgICAgICAgICAgICAgICAgIHVuaXRzLnB1c2goJ21pbnV0ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKFsnc2Vjb25kJ10uaW5kZXhPZihjb2x1bW5zTWFuYWdlci5nYW50dC4kc2NvcGUudmlld1NjYWxlKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdW5pdHMucHVzaCgnc2Vjb25kJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodW5pdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdW5pdHMucHVzaChjb2x1bW5zTWFuYWdlci5nYW50dC4kc2NvcGUudmlld1NjYWxlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVuaXRzID0gY29sdW1uc01hbmFnZXIuZ2FudHQuJHNjb3BlLmhlYWRlcnM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBoZWFkZXJzID0gW107CiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh1bml0cywgZnVuY3Rpb24odW5pdCkgewogICAgICAgICAgICAgICAgaGVhZGVycy5wdXNoKGdlbmVyYXRlSGVhZGVyKGNvbHVtbnNNYW5hZ2VyLCBjb2x1bW5zLCB1bml0KSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIGhlYWRlcnM7CiAgICAgICAgfTsKICAgIH07Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdHYW50dCcsIFsKICAgICdHYW50dEFwaScsICdHYW50dENhbGVuZGFyJywgJ0dhbnR0U2Nyb2xsJywgJ0dhbnR0Qm9keScsICdHYW50dFJvd0hlYWRlcicsICdHYW50dEhlYWRlcicsICdHYW50dExhYmVscycsICdHYW50dFJvd3NNYW5hZ2VyJywgJ0dhbnR0Q29sdW1uc01hbmFnZXInLCAnR2FudHRUaW1lc3BhbnNNYW5hZ2VyJywgJ0dhbnR0Q3VycmVudERhdGVNYW5hZ2VyJywKICAgIGZ1bmN0aW9uKEdhbnR0QXBpLCBDYWxlbmRhciwgU2Nyb2xsLCBCb2R5LCBSb3dIZWFkZXIsIEhlYWRlciwgTGFiZWxzLCBSb3dzTWFuYWdlciwgQ29sdW1uc01hbmFnZXIsIFRpbWVzcGFuc01hbmFnZXIsIEN1cnJlbnREYXRlTWFuYWdlcikgewogICAgICAgIC8vIEdhbnR0IGxvZ2ljLiBNYW5hZ2VzIHRoZSBjb2x1bW5zLCByb3dzIGFuZCBzb3J0aW5nIGZ1bmN0aW9uYWxpdHkuCiAgICAgICAgdmFyIEdhbnR0ID0gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLiRzY29wZSA9ICRzY29wZTsKICAgICAgICAgICAgdGhpcy4kZWxlbWVudCA9ICRlbGVtZW50OwoKICAgICAgICAgICAgdGhpcy5hcGkgPSBuZXcgR2FudHRBcGkodGhpcyk7CgogICAgICAgICAgICB0aGlzLmFwaS5yZWdpc3RlckV2ZW50KCdjb3JlJywgJ3JlYWR5Jyk7CgogICAgICAgICAgICB0aGlzLmFwaS5yZWdpc3RlckV2ZW50KCdkaXJlY3RpdmVzJywgJ25ldycpOwogICAgICAgICAgICB0aGlzLmFwaS5yZWdpc3RlckV2ZW50KCdkaXJlY3RpdmVzJywgJ2Rlc3Ryb3knKTsKCiAgICAgICAgICAgIHRoaXMuYXBpLnJlZ2lzdGVyRXZlbnQoJ2RhdGEnLCAnbG9hZCcpOwogICAgICAgICAgICB0aGlzLmFwaS5yZWdpc3RlckV2ZW50KCdkYXRhJywgJ3JlbW92ZScpOwogICAgICAgICAgICB0aGlzLmFwaS5yZWdpc3RlckV2ZW50KCdkYXRhJywgJ2NsZWFyJywgdGhpcy5jbGVhckRhdGEsIHRoaXMpOwoKICAgICAgICAgICAgdGhpcy5hcGkucmVnaXN0ZXJNZXRob2QoJ2NvcmUnLCAnZ2V0RGF0ZUJ5UG9zaXRpb24nLCB0aGlzLmdldERhdGVCeVBvc2l0aW9uLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy5hcGkucmVnaXN0ZXJNZXRob2QoJ2NvcmUnLCAnZ2V0UG9zaXRpb25CeURhdGUnLCB0aGlzLmdldFBvc2l0aW9uQnlEYXRlLCB0aGlzKTsKCiAgICAgICAgICAgIHRoaXMuYXBpLnJlZ2lzdGVyTWV0aG9kKCdkYXRhJywgJ2xvYWQnLCB0aGlzLmxvYWREYXRhLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy5hcGkucmVnaXN0ZXJNZXRob2QoJ2RhdGEnLCAncmVtb3ZlJywgdGhpcy5yZW1vdmVEYXRhLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy5hcGkucmVnaXN0ZXJNZXRob2QoJ2RhdGEnLCAnY2xlYXInLCB0aGlzLmNsZWFyRGF0YSwgdGhpcyk7CgogICAgICAgICAgICB0aGlzLmNhbGVuZGFyID0gbmV3IENhbGVuZGFyKHRoaXMpOwogICAgICAgICAgICB0aGlzLmNhbGVuZGFyLnJlZ2lzdGVyVGltZUZyYW1lcyh0aGlzLiRzY29wZS50aW1lRnJhbWVzKTsKICAgICAgICAgICAgdGhpcy5jYWxlbmRhci5yZWdpc3RlckRhdGVGcmFtZXModGhpcy4kc2NvcGUuZGF0ZUZyYW1lcyk7CgogICAgICAgICAgICB0aGlzLmFwaS5yZWdpc3Rlck1ldGhvZCgndGltZWZyYW1lcycsICdyZWdpc3RlclRpbWVGcmFtZXMnLCB0aGlzLmNhbGVuZGFyLnJlZ2lzdGVyVGltZUZyYW1lcywgdGhpcy5jYWxlbmRhcik7CiAgICAgICAgICAgIHRoaXMuYXBpLnJlZ2lzdGVyTWV0aG9kKCd0aW1lZnJhbWVzJywgJ2NsZWFyVGltZWZyYW1lcycsIHRoaXMuY2FsZW5kYXIuY2xlYXJUaW1lRnJhbWVzLCB0aGlzLmNhbGVuZGFyKTsKICAgICAgICAgICAgdGhpcy5hcGkucmVnaXN0ZXJNZXRob2QoJ3RpbWVmcmFtZXMnLCAncmVnaXN0ZXJEYXRlRnJhbWVzJywgdGhpcy5jYWxlbmRhci5yZWdpc3RlckRhdGVGcmFtZXMsIHRoaXMuY2FsZW5kYXIpOwogICAgICAgICAgICB0aGlzLmFwaS5yZWdpc3Rlck1ldGhvZCgndGltZWZyYW1lcycsICdjbGVhckRhdGVGcmFtZXMnLCB0aGlzLmNhbGVuZGFyLmNsZWFyRGF0ZUZyYW1lcywgdGhpcy5jYWxlbmRhcik7CiAgICAgICAgICAgIHRoaXMuYXBpLnJlZ2lzdGVyTWV0aG9kKCd0aW1lZnJhbWVzJywgJ3JlZ2lzdGVyVGltZUZyYW1lTWFwcGluZ3MnLCB0aGlzLmNhbGVuZGFyLnJlZ2lzdGVyVGltZUZyYW1lTWFwcGluZ3MsIHRoaXMuY2FsZW5kYXIpOwogICAgICAgICAgICB0aGlzLmFwaS5yZWdpc3Rlck1ldGhvZCgndGltZWZyYW1lcycsICdjbGVhclRpbWVGcmFtZU1hcHBpbmdzJywgdGhpcy5jYWxlbmRhci5jbGVhclRpbWVGcmFtZU1hcHBpbmdzLCB0aGlzLmNhbGVuZGFyKTsKCiAgICAgICAgICAgICRzY29wZS4kd2F0Y2goJ3RpbWVGcmFtZXMnLCBmdW5jdGlvbihuZXdWYWx1ZXMsIG9sZFZhbHVlcykgewogICAgICAgICAgICAgICAgaWYgKCFhbmd1bGFyLmVxdWFscyhuZXdWYWx1ZXMsIG9sZFZhbHVlcykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbGVuZGFyLmNsZWFyVGltZUZyYW1lcygpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FsZW5kYXIucmVnaXN0ZXJUaW1lRnJhbWVzKCRzY29wZS50aW1lRnJhbWVzKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbHVtbnNNYW5hZ2VyLmdlbmVyYXRlQ29sdW1ucygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICRzY29wZS4kd2F0Y2goJ2RhdGVGcmFtZXMnLCBmdW5jdGlvbihuZXdWYWx1ZXMsIG9sZFZhbHVlcykgewogICAgICAgICAgICAgICAgaWYgKCFhbmd1bGFyLmVxdWFscyhuZXdWYWx1ZXMsIG9sZFZhbHVlcykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbGVuZGFyLmNsZWFyVGltZUZyYW1lcygpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FsZW5kYXIucmVnaXN0ZXJUaW1lRnJhbWVzKCRzY29wZS50aW1lRnJhbWVzKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbHVtbnNNYW5hZ2VyLmdlbmVyYXRlQ29sdW1ucygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuc2Nyb2xsID0gbmV3IFNjcm9sbCh0aGlzKTsKICAgICAgICAgICAgdGhpcy5ib2R5ID0gbmV3IEJvZHkodGhpcyk7CiAgICAgICAgICAgIHRoaXMucm93SGVhZGVyID0gbmV3IFJvd0hlYWRlcih0aGlzKTsKICAgICAgICAgICAgdGhpcy5oZWFkZXIgPSBuZXcgSGVhZGVyKHRoaXMpOwogICAgICAgICAgICB0aGlzLmxhYmVscyA9IG5ldyBMYWJlbHModGhpcyk7CgogICAgICAgICAgICB0aGlzLnJvd3NNYW5hZ2VyID0gbmV3IFJvd3NNYW5hZ2VyKHRoaXMpOwogICAgICAgICAgICB0aGlzLmNvbHVtbnNNYW5hZ2VyID0gbmV3IENvbHVtbnNNYW5hZ2VyKHRoaXMpOwogICAgICAgICAgICB0aGlzLnRpbWVzcGFuc01hbmFnZXIgPSBuZXcgVGltZXNwYW5zTWFuYWdlcih0aGlzKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RGF0ZU1hbmFnZXIgPSBuZXcgQ3VycmVudERhdGVNYW5hZ2VyKHRoaXMpOwoKICAgICAgICAgICAgdGhpcy5vcmlnaW5hbFdpZHRoID0gMDsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IDA7CgogICAgICAgICAgICB0aGlzLiRzY29wZS4kd2F0Y2goJ2RhdGEnLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICghYW5ndWxhci5lcXVhbHMobmV3VmFsdWUsIG9sZFZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHNlbGYuY2xlYXJEYXRhKCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2FkRGF0YShuZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNGdW5jdGlvbih0aGlzLiRzY29wZS5hcGkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRzY29wZS5hcGkodGhpcy5hcGkpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gUmV0dXJucyB0aGUgZXhhY3QgY29sdW1uIGRhdGUgYXQgdGhlIGdpdmVuIHBvc2l0aW9uIHggKGluIGVtKQogICAgICAgIEdhbnR0LnByb3RvdHlwZS5nZXREYXRlQnlQb3NpdGlvbiA9IGZ1bmN0aW9uKHgsIG1hZ25ldCkgewogICAgICAgICAgICB2YXIgY29sdW1uID0gdGhpcy5jb2x1bW5zTWFuYWdlci5nZXRDb2x1bW5CeVBvc2l0aW9uKHgpOwogICAgICAgICAgICBpZiAoY29sdW1uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjb2x1bW4uZ2V0RGF0ZUJ5UG9zaXRpb24oeCAtIGNvbHVtbi5sZWZ0LCBtYWduZXQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vIFJldHVybnMgdGhlIHBvc2l0aW9uIGluc2lkZSB0aGUgR2FudHQgY2FsY3VsYXRlZCBieSB0aGUgZ2l2ZW4gZGF0ZQogICAgICAgIEdhbnR0LnByb3RvdHlwZS5nZXRQb3NpdGlvbkJ5RGF0ZSA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgICAgaWYgKGRhdGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFtb21lbnQuaXNNb21lbnQobW9tZW50KSkgewogICAgICAgICAgICAgICAgZGF0ZSA9IG1vbWVudChkYXRlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNvbHVtbiA9IHRoaXMuY29sdW1uc01hbmFnZXIuZ2V0Q29sdW1uQnlEYXRlKGRhdGUpOwogICAgICAgICAgICBpZiAoY29sdW1uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjb2x1bW4uZ2V0UG9zaXRpb25CeURhdGUoZGF0ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gQWRkcyBvciB1cGRhdGUgcm93cyBhbmQgdGFza3MuCiAgICAgICAgR2FudHQucHJvdG90eXBlLmxvYWREYXRhID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICBpZiAoIWFuZ3VsYXIuaXNBcnJheShkYXRhKSkgewogICAgICAgICAgICAgICAgZGF0YSA9IFtkYXRhXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBkYXRhLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHJvd0RhdGEgPSBkYXRhW2ldOwogICAgICAgICAgICAgICAgdGhpcy5yb3dzTWFuYWdlci5hZGRSb3cocm93RGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hcGkuZGF0YS5yYWlzZS5sb2FkKHRoaXMuJHNjb3BlLCBkYXRhKTsKICAgICAgICB9OwoKICAgICAgICAvLyBSZW1vdmVzIHNwZWNpZmllZCByb3dzIG9yIHRhc2tzLgogICAgICAgIC8vIElmIGEgcm93IGhhcyBubyB0YXNrcyBpbnNpZGUgdGhlIGNvbXBsZXRlIHJvdyB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgR2FudHQucHJvdG90eXBlLnJlbW92ZURhdGEgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgIGlmICghYW5ndWxhci5pc0FycmF5KGRhdGEpKSB7CiAgICAgICAgICAgICAgICBkYXRhID0gW2RhdGFdOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnJvd3NNYW5hZ2VyLnJlbW92ZURhdGEoZGF0YSk7CiAgICAgICAgICAgIHRoaXMuYXBpLmRhdGEucmFpc2UucmVtb3ZlKHRoaXMuJHNjb3BlLCBkYXRhKTsKICAgICAgICB9OwoKICAgICAgICAvLyBSZW1vdmVzIGFsbCByb3dzIGFuZCB0YXNrcwogICAgICAgIEdhbnR0LnByb3RvdHlwZS5jbGVhckRhdGEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5yb3dzTWFuYWdlci5yZW1vdmVBbGwoKTsKICAgICAgICAgICAgdGhpcy5hcGkuZGF0YS5yYWlzZS5jbGVhcih0aGlzLiRzY29wZSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEdhbnR0OwogICAgfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0Um93JywgWydHYW50dFRhc2snLCAnbW9tZW50JywgJyRmaWx0ZXInLCBmdW5jdGlvbihUYXNrLCBtb21lbnQsICRmaWx0ZXIpIHsKICAgIHZhciBSb3cgPSBmdW5jdGlvbihpZCwgcm93c01hbmFnZXIsIG5hbWUsIG9yZGVyLCBoZWlnaHQsIGNvbG9yLCBjbGFzc2VzLCBkYXRhKSB7CiAgICAgICAgdGhpcy5pZCA9IGlkOwogICAgICAgIHRoaXMucm93c01hbmFnZXIgPSByb3dzTWFuYWdlcjsKICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgIHRoaXMub3JkZXIgPSBvcmRlcjsKICAgICAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKICAgICAgICB0aGlzLmNvbG9yID0gY29sb3I7CiAgICAgICAgdGhpcy5jbGFzc2VzID0gY2xhc3NlczsKICAgICAgICB0aGlzLmZyb20gPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy50byA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLnRhc2tzTWFwID0ge307CiAgICAgICAgdGhpcy50YXNrcyA9IFtdOwogICAgICAgIHRoaXMuZmlsdGVyZWRUYXNrcyA9IFtdOwogICAgICAgIHRoaXMudmlzaWJsZVRhc2tzID0gW107CiAgICAgICAgdGhpcy5kYXRhID0gZGF0YTsKICAgIH07CgogICAgLy8gQWRkcyBhIHRhc2sgdG8gYSBzcGVjaWZpYyByb3cuIE1lcmdlcyB0aGUgdGFzayBpZiB0aGVyZSBpcyBhbHJlYWR5IG9uZSB3aXRoIHRoZSBzYW1lIGlkCiAgICBSb3cucHJvdG90eXBlLmFkZFRhc2sgPSBmdW5jdGlvbih0YXNrRGF0YSkgewogICAgICAgIC8vIENvcHkgdG8gbmV3IHRhc2sgKGFkZCkgb3IgbWVyZ2Ugd2l0aCBleGlzdGluZyAodXBkYXRlKQogICAgICAgIHZhciB0YXNrOwoKICAgICAgICBpZiAodGFza0RhdGEuaWQgaW4gdGhpcy50YXNrc01hcCkgewogICAgICAgICAgICB0YXNrID0gdGhpcy50YXNrc01hcFt0YXNrRGF0YS5pZF07CiAgICAgICAgICAgIHRhc2suY29weSh0YXNrRGF0YSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGFzayA9IG5ldyBUYXNrKHRhc2tEYXRhLmlkLCB0aGlzLCB0YXNrRGF0YS5uYW1lLCB0YXNrRGF0YS5jb2xvciwgdGFza0RhdGEuY2xhc3NlcywgdGFza0RhdGEucHJpb3JpdHksIHRhc2tEYXRhLmZyb20sIHRhc2tEYXRhLnRvLCB0YXNrRGF0YS5kYXRhLCB0YXNrRGF0YS5lc3QsIHRhc2tEYXRhLmxjdCwgdGFza0RhdGEucHJvZ3Jlc3MpOwogICAgICAgICAgICB0aGlzLnRhc2tzTWFwW3Rhc2tEYXRhLmlkXSA9IHRhc2s7CiAgICAgICAgICAgIHRoaXMudGFza3MucHVzaCh0YXNrKTsKICAgICAgICAgICAgdGhpcy5maWx0ZXJlZFRhc2tzLnB1c2godGFzayk7CiAgICAgICAgICAgIHRoaXMudmlzaWJsZVRhc2tzLnB1c2godGFzayk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNvcnRUYXNrcygpOwogICAgICAgIHRoaXMuc2V0RnJvbVRvQnlUYXNrKHRhc2spOwogICAgICAgIHRoaXMucm93c01hbmFnZXIuZ2FudHQuYXBpLnRhc2tzLnJhaXNlLmFkZCh0YXNrKTsKICAgICAgICByZXR1cm4gdGFzazsKICAgIH07CgogICAgLy8gUmVtb3ZlcyB0aGUgdGFzayBmcm9tIHRoZSBleGlzdGluZyByb3cgYW5kIGFkZHMgaXQgdG8gaGUgY3VycmVudCBvbmUKICAgIFJvdy5wcm90b3R5cGUubW92ZVRhc2tUb1JvdyA9IGZ1bmN0aW9uKHRhc2spIHsKICAgICAgICB2YXIgb2xkUm93ID0gdGFzay5yb3c7CiAgICAgICAgb2xkUm93LnJlbW92ZVRhc2sodGFzay5pZCwgdHJ1ZSk7CiAgICAgICAgb2xkUm93LnVwZGF0ZVZpc2libGVUYXNrcygpOwoKICAgICAgICB0aGlzLnRhc2tzTWFwW3Rhc2suaWRdID0gdGFzazsKICAgICAgICB0aGlzLnRhc2tzLnB1c2godGFzayk7CiAgICAgICAgdGhpcy5maWx0ZXJlZFRhc2tzLnB1c2godGFzayk7CiAgICAgICAgdGhpcy52aXNpYmxlVGFza3MucHVzaCh0YXNrKTsKICAgICAgICB0YXNrLnJvdyA9IHRoaXM7CgogICAgICAgIHRoaXMuc29ydFRhc2tzKCk7CiAgICAgICAgdGhpcy5zZXRGcm9tVG9CeVRhc2sodGFzayk7CgogICAgICAgIHRhc2sudXBkYXRlUG9zQW5kU2l6ZSgpOwogICAgICAgIHRoaXMudXBkYXRlVmlzaWJsZVRhc2tzKCk7CgogICAgICAgIHRoaXMucm93c01hbmFnZXIuZ2FudHQuYXBpLnRhc2tzLnJhaXNlLm1vdmUodGFzaywgb2xkUm93KTsKCiAgICB9OwoKICAgIFJvdy5wcm90b3R5cGUudXBkYXRlVmlzaWJsZVRhc2tzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMucm93c01hbmFnZXIuZ2FudHQuJHNjb3BlLmZpbHRlclRhc2spIHsKICAgICAgICAgICAgdGhpcy5maWx0ZXJlZFRhc2tzID0gJGZpbHRlcignZmlsdGVyJykodGhpcy50YXNrcywgdGhpcy5yb3dzTWFuYWdlci5nYW50dC4kc2NvcGUuZmlsdGVyVGFzaywgdGhpcy5yb3dzTWFuYWdlci5nYW50dC4kc2NvcGUuZmlsdGVyVGFza0NvbXBhcmF0b3IpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuZmlsdGVyZWRUYXNrcyA9IHRoaXMudGFza3Muc2xpY2UoMCk7CiAgICAgICAgfQogICAgICAgIHRoaXMudmlzaWJsZVRhc2tzID0gJGZpbHRlcignZ2FudHRUYXNrTGltaXQnKSh0aGlzLmZpbHRlcmVkVGFza3MsIHRoaXMucm93c01hbmFnZXIuZ2FudHQpOwogICAgfTsKCiAgICBSb3cucHJvdG90eXBlLnVwZGF0ZVRhc2tzUG9zQW5kU2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGogPSAwLCBrID0gdGhpcy50YXNrcy5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgdGhpcy50YXNrc1tqXS51cGRhdGVQb3NBbmRTaXplKCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBSZW1vdmUgdGhlIHNwZWNpZmllZCB0YXNrIGZyb20gdGhlIHJvdwogICAgUm93LnByb3RvdHlwZS5yZW1vdmVUYXNrID0gZnVuY3Rpb24odGFza0lkLCBkaXNhYmxlRW1pdCkgewogICAgICAgIGlmICh0YXNrSWQgaW4gdGhpcy50YXNrc01hcCkgewogICAgICAgICAgICBkZWxldGUgdGhpcy50YXNrc01hcFt0YXNrSWRdOyAvLyBSZW1vdmUgZnJvbSBtYXAKCiAgICAgICAgICAgIHZhciB0YXNrOwogICAgICAgICAgICB2YXIgcmVtb3ZlZFRhc2s7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLnRhc2tzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0YXNrID0gdGhpcy50YXNrc1tpXTsKICAgICAgICAgICAgICAgIGlmICh0YXNrLmlkID09PSB0YXNrSWQpIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVkVGFzayA9IHRhc2s7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50YXNrcy5zcGxpY2UoaSwgMSk7IC8vIFJlbW92ZSBmcm9tIGFycmF5CgogICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBlYXJsaWVzdCBvciBsYXRlc3QgZGF0ZSBpbmZvIGFzIHRoaXMgbWF5IGNoYW5nZQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZyb20gLSB0YXNrLmZyb20gPT09IDAgfHwgdGhpcy50byAtIHRhc2sudG8gPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRGcm9tVG8oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaSA9IHRoaXMuZmlsdGVyZWRUYXNrcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgdGFzayA9IHRoaXMuZmlsdGVyZWRUYXNrc1tpXTsKICAgICAgICAgICAgICAgIGlmICh0YXNrLmlkID09PSB0YXNrSWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbHRlcmVkVGFza3Muc3BsaWNlKGksIDEpOyAvLyBSZW1vdmUgZnJvbSBmaWx0ZXJlZCBhcnJheQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKGkgPSB0aGlzLnZpc2libGVUYXNrcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgdGFzayA9IHRoaXMudmlzaWJsZVRhc2tzW2ldOwogICAgICAgICAgICAgICAgaWYgKHRhc2suaWQgPT09IHRhc2tJZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudmlzaWJsZVRhc2tzLnNwbGljZShpLCAxKTsgLy8gUmVtb3ZlIGZyb20gdmlzaWJsZSBhcnJheQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWRpc2FibGVFbWl0KSB7CiAgICAgICAgICAgICAgICB0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LmFwaS50YXNrcy5yYWlzZS5yZW1vdmUocmVtb3ZlZFRhc2spOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVtb3ZlZFRhc2s7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBDYWxjdWxhdGUgdGhlIGVhcmxpZXN0IGZyb20gYW5kIGxhdGVzdCB0byBkYXRlIG9mIGFsbCB0YXNrcyBpbiBhIHJvdwogICAgUm93LnByb3RvdHlwZS5zZXRGcm9tVG8gPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmZyb20gPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy50byA9IHVuZGVmaW5lZDsKICAgICAgICBmb3IgKHZhciBqID0gMCwgayA9IHRoaXMudGFza3MubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgIHRoaXMuc2V0RnJvbVRvQnlUYXNrKHRoaXMudGFza3Nbal0pOwogICAgICAgIH0KICAgIH07CgogICAgUm93LnByb3RvdHlwZS5zZXRGcm9tVG9CeVRhc2sgPSBmdW5jdGlvbih0YXNrKSB7CiAgICAgICAgaWYgKHRoaXMuZnJvbSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRoaXMuZnJvbSA9IG1vbWVudCh0YXNrLmZyb20pOwogICAgICAgIH0gZWxzZSBpZiAodGFzay5mcm9tIDwgdGhpcy5mcm9tKSB7CiAgICAgICAgICAgIHRoaXMuZnJvbSA9IG1vbWVudCh0YXNrLmZyb20pOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMudG8gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aGlzLnRvID0gbW9tZW50KHRhc2sudG8pOwogICAgICAgIH0gZWxzZSBpZiAodGFzay50byA+IHRoaXMudG8pIHsKICAgICAgICAgICAgdGhpcy50byA9IG1vbWVudCh0YXNrLnRvKTsKICAgICAgICB9CiAgICB9OwoKICAgIFJvdy5wcm90b3R5cGUuc29ydFRhc2tzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy50YXNrcy5zb3J0KGZ1bmN0aW9uKHQxLCB0MikgewogICAgICAgICAgICByZXR1cm4gdDEubGVmdCAtIHQyLmxlZnQ7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIFJvdy5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uKHJvdykgewogICAgICAgIHRoaXMubmFtZSA9IHJvdy5uYW1lOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gcm93LmhlaWdodDsKICAgICAgICB0aGlzLmNvbG9yID0gcm93LmNvbG9yOwogICAgICAgIHRoaXMuY2xhc3NlcyA9IHJvdy5jbGFzc2VzOwogICAgICAgIHRoaXMuZGF0YSA9IHJvdy5kYXRhOwoKICAgICAgICBpZiAocm93Lm9yZGVyICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy5vcmRlciA9IHJvdy5vcmRlcjsKICAgICAgICB9CiAgICB9OwoKICAgIFJvdy5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY2xvbmUgPSBuZXcgUm93KHRoaXMuaWQsIHRoaXMucm93c01hbmFnZXIsIHRoaXMubmFtZSwgdGhpcy5vcmRlciwgdGhpcy5oZWlnaHQsIHRoaXMuY29sb3IsIHRoaXMuY2xhc3NlcywgdGhpcy5kYXRhKTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMudGFza3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIGNsb25lLmFkZFRhc2sodGhpcy50YXNrc1tpXS5jbG9uZSgpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNsb25lOwogICAgfTsKCiAgICByZXR1cm4gUm93Owp9XSk7CgoKZ2FudHQuZmFjdG9yeSgnR2FudHRSb3dIZWFkZXInLCBbZnVuY3Rpb24oKSB7CiAgICB2YXIgUm93SGVhZGVyID0gZnVuY3Rpb24oZ2FudHQpIHsKICAgICAgICB0aGlzLmdhbnR0ID0gZ2FudHQ7CiAgICB9OwogICAgcmV0dXJuIFJvd0hlYWRlcjsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0Um93c01hbmFnZXInLCBbJ0dhbnR0Um93JywgJyRmaWx0ZXInLCAnbW9tZW50JywgZnVuY3Rpb24oUm93LCAkZmlsdGVyLCBtb21lbnQpIHsKICAgIHZhciBSb3dzTWFuYWdlciA9IGZ1bmN0aW9uKGdhbnR0KSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICB0aGlzLmdhbnR0ID0gZ2FudHQ7CgogICAgICAgIHRoaXMucm93c01hcCA9IHt9OwogICAgICAgIHRoaXMucm93cyA9IFtdOwogICAgICAgIHRoaXMuZmlsdGVyZWRSb3dzID0gW107CiAgICAgICAgdGhpcy52aXNpYmxlUm93cyA9IFtdOwoKICAgICAgICB0aGlzLmdhbnR0LiRzY29wZS4kd2F0Y2hHcm91cChbJ3Njcm9sbExlZnQnLCAnc2Nyb2xsV2lkdGgnXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNlbGYudXBkYXRlVmlzaWJsZVRhc2tzKCk7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuZ2FudHQuJHNjb3BlLiR3YXRjaEdyb3VwKFsnZmlsdGVyVGFzaycsICdmaWx0ZXJUYXNrQ29tcGFyYXRvciddLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi51cGRhdGVWaXNpYmxlVGFza3MoKTsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5nYW50dC4kc2NvcGUuJHdhdGNoR3JvdXAoWydmaWx0ZXJSb3cnLCAnZmlsdGVyUm93Q29tcGFyYXRvciddLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi51cGRhdGVWaXNpYmxlUm93cygpOwogICAgICAgIH0pOwoKICAgICAgICB0aGlzLmdhbnR0LiRzY29wZS4kd2F0Y2goJ3NvcnRNb2RlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNlbGYuc29ydFJvd3MoKTsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy51cGRhdGVWaXNpYmxlT2JqZWN0cygpOwoKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3Rlck1ldGhvZCgncm93cycsICdzb3J0JywgUm93c01hbmFnZXIucHJvdG90eXBlLnNvcnRSb3dzLCB0aGlzKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3Rlck1ldGhvZCgncm93cycsICdzd2FwJywgUm93c01hbmFnZXIucHJvdG90eXBlLnN3YXBSb3dzLCB0aGlzKTsKCiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJFdmVudCgndGFza3MnLCAnYWRkJyk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJFdmVudCgndGFza3MnLCAnY2hhbmdlJyk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJFdmVudCgndGFza3MnLCAncmVtb3ZlJyk7CgogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyRXZlbnQoJ3Rhc2tzJywgJ2ZpbHRlcicpOwoKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3RlckV2ZW50KCdyb3dzJywgJ2FkZCcpOwogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyRXZlbnQoJ3Jvd3MnLCAnY2hhbmdlJyk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJFdmVudCgncm93cycsICdyZW1vdmUnKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3RlckV2ZW50KCdyb3dzJywgJ29yZGVyQ2hhbmdlJyk7CgogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyRXZlbnQoJ3Jvd3MnLCAnZmlsdGVyJyk7CgogICAgfTsKCiAgICBSb3dzTWFuYWdlci5wcm90b3R5cGUuYWRkUm93ID0gZnVuY3Rpb24ocm93RGF0YSkgewogICAgICAgIC8vIENvcHkgdG8gbmV3IHJvdyAoYWRkKSBvciBtZXJnZSB3aXRoIGV4aXN0aW5nICh1cGRhdGUpCiAgICAgICAgdmFyIHJvdywgaXNVcGRhdGUgPSBmYWxzZTsKCiAgICAgICAgaWYgKHJvd0RhdGEuaWQgaW4gdGhpcy5yb3dzTWFwKSB7CiAgICAgICAgICAgIHJvdyA9IHRoaXMucm93c01hcFtyb3dEYXRhLmlkXTsKICAgICAgICAgICAgcm93LmNvcHkocm93RGF0YSk7CiAgICAgICAgICAgIGlzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5nYW50dC5hcGkucm93cy5yYWlzZS5jaGFuZ2Uocm93KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgb3JkZXIgPSByb3dEYXRhLm9yZGVyOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIHJvdyBoYXMgYSBvcmRlciBwcmVkZWZpbmVkLiBJZiBub3QgYXNzaWduIG9uZQogICAgICAgICAgICBpZiAob3JkZXIgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgb3JkZXIgPSB0aGlzLmhpZ2hlc3RSb3dPcmRlcjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9yZGVyID49IHRoaXMuaGlnaGVzdFJvd09yZGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhpZ2hlc3RSb3dPcmRlciA9IG9yZGVyICsgMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcm93ID0gbmV3IFJvdyhyb3dEYXRhLmlkLCB0aGlzLCByb3dEYXRhLm5hbWUsIG9yZGVyLCByb3dEYXRhLmhlaWdodCwgcm93RGF0YS5jb2xvciwgcm93RGF0YS5jbGFzc2VzLCByb3dEYXRhLmRhdGEpOwogICAgICAgICAgICB0aGlzLnJvd3NNYXBbcm93RGF0YS5pZF0gPSByb3c7CiAgICAgICAgICAgIHRoaXMucm93cy5wdXNoKHJvdyk7CiAgICAgICAgICAgIHRoaXMuZmlsdGVyZWRSb3dzLnB1c2gocm93KTsKICAgICAgICAgICAgdGhpcy52aXNpYmxlUm93cy5wdXNoKHJvdyk7CiAgICAgICAgICAgIHRoaXMuZ2FudHQuYXBpLnJvd3MucmFpc2UuYWRkKHJvdyk7CiAgICAgICAgfQoKICAgICAgICBpZiAocm93RGF0YS50YXNrcyAhPT0gdW5kZWZpbmVkICYmIHJvd0RhdGEudGFza3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHJvd0RhdGEudGFza3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICByb3cuYWRkVGFzayhyb3dEYXRhLnRhc2tzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gaXNVcGRhdGU7CiAgICB9OwoKICAgIFJvd3NNYW5hZ2VyLnByb3RvdHlwZS5yZW1vdmVSb3cgPSBmdW5jdGlvbihyb3dJZCkgewogICAgICAgIGlmIChyb3dJZCBpbiB0aGlzLnJvd3NNYXApIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMucm93c01hcFtyb3dJZF07IC8vIFJlbW92ZSBmcm9tIG1hcAoKICAgICAgICAgICAgdmFyIHJlbW92ZWRSb3c7CiAgICAgICAgICAgIHZhciByb3c7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLnJvd3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIHJvdyA9IHRoaXMucm93c1tpXTsKICAgICAgICAgICAgICAgIGlmIChyb3cuaWQgPT09IHJvd0lkKSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlZFJvdyA9IHJvdzsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJvd3Muc3BsaWNlKGksIDEpOyAvLyBSZW1vdmUgZnJvbSBhcnJheQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKGkgPSB0aGlzLmZpbHRlcmVkUm93cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgcm93ID0gdGhpcy5maWx0ZXJlZFJvd3NbaV07CiAgICAgICAgICAgICAgICBpZiAocm93LmlkID09PSByb3dJZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyZWRSb3dzLnNwbGljZShpLCAxKTsgLy8gUmVtb3ZlIGZyb20gZmlsdGVyZWQgYXJyYXkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gdGhpcy52aXNpYmxlUm93cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgcm93ID0gdGhpcy52aXNpYmxlUm93c1tpXTsKICAgICAgICAgICAgICAgIGlmIChyb3cuaWQgPT09IHJvd0lkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXNpYmxlUm93cy5zcGxpY2UoaSwgMSk7IC8vIFJlbW92ZSBmcm9tIHZpc2libGUgYXJyYXkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5nYW50dC5hcGkucm93cy5yYWlzZS5yZW1vdmUocmVtb3ZlZFJvdyk7CiAgICAgICAgICAgIHJldHVybiByb3c7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfTsKCiAgICBSb3dzTWFuYWdlci5wcm90b3R5cGUucmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGRhdGEubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHZhciByb3dEYXRhID0gZGF0YVtpXTsKICAgICAgICAgICAgdmFyIHJvdzsKCiAgICAgICAgICAgIGlmIChyb3dEYXRhLnRhc2tzICE9PSB1bmRlZmluZWQgJiYgcm93RGF0YS50YXNrcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBPbmx5IGRlbGV0ZSB0aGUgc3BlY2lmaWVkIHRhc2tzIGJ1dCBub3QgdGhlIHJvdyBhbmQgdGhlIG90aGVyIHRhc2tzCgogICAgICAgICAgICAgICAgaWYgKHJvd0RhdGEuaWQgaW4gdGhpcy5yb3dzTWFwKSB7CiAgICAgICAgICAgICAgICAgICAgcm93ID0gdGhpcy5yb3dzTWFwW3Jvd0RhdGEuaWRdOwoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgayA9IHJvd0RhdGEudGFza3MubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvdy5yZW1vdmVUYXNrKHJvd0RhdGEudGFza3Nbal0uaWQpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW50dC5hcGkucm93cy5yYWlzZS5jaGFuZ2Uocm93KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIERlbGV0ZSB0aGUgY29tcGxldGUgcm93CiAgICAgICAgICAgICAgICByb3cgPSB0aGlzLnJlbW92ZVJvdyhyb3dEYXRhLmlkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLnVwZGF0ZVZpc2libGVPYmplY3RzKCk7CiAgICB9OwoKICAgIFJvd3NNYW5hZ2VyLnByb3RvdHlwZS5yZW1vdmVBbGwgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvd3NNYXAgPSB7fTsKICAgICAgICB0aGlzLnJvd3MgPSBbXTsKICAgICAgICB0aGlzLmZpbHRlcmVkUm93cyA9IFtdOwogICAgICAgIHRoaXMudmlzaWJsZVJvd3MgPSBbXTsKICAgIH07CgogICAgUm93c01hbmFnZXIucHJvdG90eXBlLnNvcnRSb3dzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGV4cHJlc3Npb24gPSB0aGlzLmdhbnR0LiRzY29wZS5zb3J0TW9kZTsKCiAgICAgICAgdmFyIHJldmVyc2UgPSBmYWxzZTsKICAgICAgICBpZiAoZXhwcmVzc2lvbi5jaGFyQXQoMCkgPT09ICctJykgewogICAgICAgICAgICByZXZlcnNlID0gdHJ1ZTsKICAgICAgICAgICAgZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24uc3Vic3RyKDEpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGFuZ3VsYXJPcmRlckJ5ID0gJGZpbHRlcignb3JkZXJCeScpOwogICAgICAgIGlmIChleHByZXNzaW9uID09PSAnY3VzdG9tJykgewogICAgICAgICAgICB0aGlzLnJvd3MgPSBhbmd1bGFyT3JkZXJCeSh0aGlzLnJvd3MsICdvcmRlcicsIHJldmVyc2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMucm93cyA9IGFuZ3VsYXJPcmRlckJ5KHRoaXMucm93cywgZXhwcmVzc2lvbiwgcmV2ZXJzZSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnVwZGF0ZVZpc2libGVSb3dzKCk7CiAgICB9OwoKICAgIC8vIFN3YXBzIHR3byByb3dzIGFuZCBjaGFuZ2VzIHRoZSBzb3J0IG9yZGVyIHRvIGN1c3RvbSB0byBkaXNwbGF5IHRoZSBzd2FwcGVkIHJvd3MKICAgIFJvd3NNYW5hZ2VyLnByb3RvdHlwZS5zd2FwUm93cyA9IGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAvLyBTd2FwIHRoZSB0d28gcm93cwogICAgICAgIHZhciBvcmRlciA9IGEub3JkZXI7CiAgICAgICAgYS5vcmRlciA9IGIub3JkZXI7CiAgICAgICAgYi5vcmRlciA9IG9yZGVyOwoKICAgICAgICAvLyBSYWlzZSBjaGFuZ2UgZXZlbnRzCiAgICAgICAgdGhpcy5nYW50dC5hcGkucm93cy5yYWlzZS5jaGFuZ2UoYSk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucm93cy5yYWlzZS5vcmRlckNoYW5nZShhKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yb3dzLnJhaXNlLmNoYW5nZShiKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yb3dzLnJhaXNlLm9yZGVyQ2hhbmdlKGIpOwoKICAgICAgICAvLyBTd2l0Y2ggdG8gY3VzdG9tIHNvcnQgbW9kZSBhbmQgdHJpZ2dlciBzb3J0CiAgICAgICAgaWYgKHRoaXMuZ2FudHQuJHNjb3BlLnNvcnRNb2RlICE9PSAnY3VzdG9tJykgewogICAgICAgICAgICB0aGlzLmdhbnR0LiRzY29wZS5zb3J0TW9kZSA9ICdjdXN0b20nOyAvLyBTb3J0IHdpbGwgYmUgdHJpZ2dlcmVkIGJ5IHRoZSB3YXRjaGVyCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5zb3J0Um93cygpOwogICAgICAgIH0KICAgIH07CgogICAgUm93c01hbmFnZXIucHJvdG90eXBlLnVwZGF0ZVZpc2libGVPYmplY3RzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy51cGRhdGVWaXNpYmxlUm93cygpOwogICAgICAgIHRoaXMudXBkYXRlVmlzaWJsZVRhc2tzKCk7CiAgICB9OwoKICAgIFJvd3NNYW5hZ2VyLnByb3RvdHlwZS51cGRhdGVWaXNpYmxlUm93cyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBvbGRGaWx0ZXJlZFJvd3MgPSB0aGlzLmZpbHRlcmVkUm93czsKICAgICAgICBpZiAodGhpcy5nYW50dC4kc2NvcGUuZmlsdGVyUm93KSB7CiAgICAgICAgICAgIHRoaXMuZmlsdGVyZWRSb3dzID0gJGZpbHRlcignZmlsdGVyJykodGhpcy5yb3dzLCB0aGlzLmdhbnR0LiRzY29wZS5maWx0ZXJSb3csIHRoaXMuZ2FudHQuJHNjb3BlLmZpbHRlclJvd0NvbXBhcmF0b3IpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuZmlsdGVyZWRSb3dzID0gdGhpcy5yb3dzLnNsaWNlKDApOwogICAgICAgIH0KCgogICAgICAgIHZhciByYWlzZUV2ZW50ID0gIWFuZ3VsYXIuZXF1YWxzKG9sZEZpbHRlcmVkUm93cywgdGhpcy5maWx0ZXJlZFJvd3MpOwoKICAgICAgICAvLyBUT0RPOiBJbXBsZW1lbnQgcm93TGltaXQgbGlrZSBjb2x1bW5MaW1pdCB0byBlbmhhbmNlIHBlcmZvcm1hbmNlIGZvciBnYW50dCB3aXRoIG1hbnkgcm93cwogICAgICAgIHRoaXMudmlzaWJsZVJvd3MgPSB0aGlzLmZpbHRlcmVkUm93czsKICAgICAgICBpZiAocmFpc2VFdmVudCkgewogICAgICAgICAgICB0aGlzLmdhbnR0LmFwaS5yb3dzLnJhaXNlLmZpbHRlcih0aGlzLnJvd3MsIHRoaXMuZmlsdGVyZWRSb3dzKTsKICAgICAgICB9CiAgICB9OwoKICAgIFJvd3NNYW5hZ2VyLnByb3RvdHlwZS51cGRhdGVWaXNpYmxlVGFza3MgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgb2xkRmlsdGVyZWRUYXNrcyA9IFtdOwogICAgICAgIHZhciBmaWx0ZXJlZFRhc2tzID0gW107CiAgICAgICAgdmFyIHRhc2tzID0gW107CgogICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmZpbHRlcmVkUm93cywgZnVuY3Rpb24ocm93KSB7CiAgICAgICAgICAgIG9sZEZpbHRlcmVkVGFza3MgPSBvbGRGaWx0ZXJlZFRhc2tzLmNvbmNhdChyb3cuZmlsdGVyZWRUYXNrcyk7CiAgICAgICAgICAgIHJvdy51cGRhdGVWaXNpYmxlVGFza3MoKTsKICAgICAgICAgICAgZmlsdGVyZWRUYXNrcyA9IGZpbHRlcmVkVGFza3MuY29uY2F0KHJvdy5maWx0ZXJlZFRhc2tzKTsKICAgICAgICAgICAgdGFza3MgPSB0YXNrcy5jb25jYXQocm93LnRhc2tzKTsKICAgICAgICB9KTsKCiAgICAgICAgdmFyIGZpbHRlckV2ZW50ID0gIWFuZ3VsYXIuZXF1YWxzKG9sZEZpbHRlcmVkVGFza3MsIGZpbHRlcmVkVGFza3MpOwoKICAgICAgICBpZiAoZmlsdGVyRXZlbnQpIHsKICAgICAgICAgICAgdGhpcy5nYW50dC5hcGkudGFza3MucmFpc2UuZmlsdGVyKHRhc2tzLCBmaWx0ZXJlZFRhc2tzKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIFVwZGF0ZSB0aGUgcG9zaXRpb24vc2l6ZSBvZiBhbGwgdGFza3MgaW4gdGhlIEdhbnR0CiAgICBSb3dzTWFuYWdlci5wcm90b3R5cGUudXBkYXRlVGFza3NQb3NBbmRTaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLnJvd3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMucm93c1tpXS51cGRhdGVUYXNrc1Bvc0FuZFNpemUoKTsKICAgICAgICB9CiAgICB9OwoKICAgIFJvd3NNYW5hZ2VyLnByb3RvdHlwZS5nZXRFeHBhbmRlZEZyb20gPSBmdW5jdGlvbihmcm9tKSB7CiAgICAgICAgZnJvbSA9IGZyb20gPyBtb21lbnQoZnJvbSkgOiBmcm9tOwoKICAgICAgICB2YXIgbWluUm93RnJvbSA9IGZyb207CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRoaXMucm93cywgZnVuY3Rpb24ocm93KSB7CiAgICAgICAgICAgIGlmIChtaW5Sb3dGcm9tID09PSB1bmRlZmluZWQgfHwgbWluUm93RnJvbSA+IHJvdy5mcm9tKSB7CiAgICAgICAgICAgICAgICBtaW5Sb3dGcm9tID0gcm93LmZyb207CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBpZiAobWluUm93RnJvbSAmJiAoIWZyb20gfHwgbWluUm93RnJvbSA8IGZyb20pKSB7CiAgICAgICAgICAgIHJldHVybiBtaW5Sb3dGcm9tOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZnJvbTsKICAgIH07CgogICAgUm93c01hbmFnZXIucHJvdG90eXBlLmdldEV4cGFuZGVkVG8gPSBmdW5jdGlvbih0bykgewogICAgICAgIHRvID0gdG8gPyBtb21lbnQodG8pIDogdG87CgogICAgICAgIHZhciBtYXhSb3dUbyA9IHRvOwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLnJvd3MsIGZ1bmN0aW9uKHJvdykgewogICAgICAgICAgICBpZiAobWF4Um93VG8gPT09IHVuZGVmaW5lZCB8fCBtYXhSb3dUbyA8IHJvdy50bykgewogICAgICAgICAgICAgICAgbWF4Um93VG8gPSByb3cudG87CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBpZiAobWF4Um93VG8gJiYgKCF0aGlzLmdhbnR0LiRzY29wZS50b0RhdGUgfHwgbWF4Um93VG8gPiB0aGlzLmdhbnR0LiRzY29wZS50b0RhdGUpKSB7CiAgICAgICAgICAgIHJldHVybiBtYXhSb3dUbzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRvOwogICAgfTsKCiAgICBSb3dzTWFuYWdlci5wcm90b3R5cGUuZ2V0RGVmYXVsdEZyb20gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGVmYXVsdEZyb207CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRoaXMucm93cywgZnVuY3Rpb24ocm93KSB7CiAgICAgICAgICAgIGlmIChkZWZhdWx0RnJvbSA9PT0gdW5kZWZpbmVkIHx8IHJvdy5mcm9tIDwgZGVmYXVsdEZyb20pIHsKICAgICAgICAgICAgICAgIGRlZmF1bHRGcm9tID0gcm93LmZyb207CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZGVmYXVsdEZyb207CiAgICB9OwoKICAgIFJvd3NNYW5hZ2VyLnByb3RvdHlwZS5nZXREZWZhdWx0VG8gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGVmYXVsdFRvOwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLnJvd3MsIGZ1bmN0aW9uKHJvdykgewogICAgICAgICAgICBpZiAoZGVmYXVsdFRvID09PSB1bmRlZmluZWQgfHwgcm93LnRvID4gZGVmYXVsdFRvKSB7CiAgICAgICAgICAgICAgICBkZWZhdWx0VG8gPSByb3cudG87CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZGVmYXVsdFRvOwogICAgfTsKCiAgICByZXR1cm4gUm93c01hbmFnZXI7Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdHYW50dFRhc2snLCBbJ21vbWVudCcsICdHYW50dFRhc2tQcm9ncmVzcycsIGZ1bmN0aW9uKG1vbWVudCwgVGFza1Byb2dyZXNzKSB7CiAgICB2YXIgVGFzayA9IGZ1bmN0aW9uKGlkLCByb3csIG5hbWUsIGNvbG9yLCBjbGFzc2VzLCBwcmlvcml0eSwgZnJvbSwgdG8sIGRhdGEsIGVzdCwgbGN0LCBwcm9ncmVzcykgewogICAgICAgIHRoaXMuaWQgPSBpZDsKICAgICAgICB0aGlzLnJvd3NNYW5hZ2VyID0gcm93LnJvd3NNYW5hZ2VyOwogICAgICAgIHRoaXMucm93ID0gcm93OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5jb2xvciA9IGNvbG9yOwogICAgICAgIHRoaXMuY2xhc3NlcyA9IGNsYXNzZXM7CiAgICAgICAgdGhpcy5wcmlvcml0eSA9IHByaW9yaXR5OwogICAgICAgIHRoaXMuZnJvbSA9IG1vbWVudChmcm9tKTsKICAgICAgICB0aGlzLnRvID0gbW9tZW50KHRvKTsKICAgICAgICB0aGlzLnRydW5jYXRlZExlZnQgPSBmYWxzZTsKICAgICAgICB0aGlzLnRydW5jYXRlZFJpZ2h0ID0gZmFsc2U7CiAgICAgICAgdGhpcy5kYXRhID0gZGF0YTsKCiAgICAgICAgaWYgKHByb2dyZXNzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9ncmVzcyA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIHRoaXMucHJvZ3Jlc3MgPSBuZXcgVGFza1Byb2dyZXNzKHRoaXMsIHByb2dyZXNzLnBlcmNlbnQsIHByb2dyZXNzLmNvbG9yLCBwcm9ncmVzcy5jbGFzc2VzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMucHJvZ3Jlc3MgPSBuZXcgVGFza1Byb2dyZXNzKHRoaXMsIHByb2dyZXNzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGVzdCAhPT0gdW5kZWZpbmVkICYmIGxjdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRoaXMuZXN0ID0gbW9tZW50KGVzdCk7ICAvL0VhcmxpZXN0IFN0YXJ0IFRpbWUKICAgICAgICAgICAgdGhpcy5sY3QgPSBtb21lbnQobGN0KTsgIC8vTGF0ZXN0IENvbXBsZXRpb24gVGltZQogICAgICAgIH0KCiAgICAgICAgdGhpcy5fZnJvbUxhYmVsID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMuX3RvTGFiZWwgPSB1bmRlZmluZWQ7CiAgICB9OwoKCiAgICBUYXNrLnByb3RvdHlwZS5nZXRGcm9tTGFiZWwgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5fZnJvbUxhYmVsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy5fZnJvbUxhYmVsID0gdGhpcy5mcm9tLmZvcm1hdCh0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LiRzY29wZS50b29sdGlwRGF0ZUZvcm1hdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9mcm9tTGFiZWw7CiAgICB9OwoKICAgIFRhc2sucHJvdG90eXBlLmdldFRvTGFiZWwgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5fdG9MYWJlbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRoaXMuX3RvTGFiZWwgPSB0aGlzLnRvLmZvcm1hdCh0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LiRzY29wZS50b29sdGlwRGF0ZUZvcm1hdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl90b0xhYmVsOwogICAgfTsKCiAgICBUYXNrLnByb3RvdHlwZS5jaGVja0lmTWlsZXN0b25lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5pc01pbGVzdG9uZSA9IHRoaXMuZnJvbSAtIHRoaXMudG8gPT09IDA7CiAgICB9OwoKICAgIFRhc2sucHJvdG90eXBlLmNoZWNrSWZNaWxlc3RvbmUoKTsKCiAgICAvLyBVcGRhdGVzIHRoZSBwb3MgYW5kIHNpemUgb2YgdGhlIHRhc2sgYWNjb3JkaW5nIHRvIHRoZSBmcm9tIC0gdG8gZGF0ZQogICAgVGFzay5wcm90b3R5cGUudXBkYXRlUG9zQW5kU2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMubW9kZWxMZWZ0ID0gdGhpcy5yb3dzTWFuYWdlci5nYW50dC5nZXRQb3NpdGlvbkJ5RGF0ZSh0aGlzLmZyb20pOwogICAgICAgIHRoaXMubW9kZWxXaWR0aCA9IHRoaXMucm93c01hbmFnZXIuZ2FudHQuZ2V0UG9zaXRpb25CeURhdGUodGhpcy50bykgLSB0aGlzLm1vZGVsTGVmdDsKCiAgICAgICAgdGhpcy5vdXRPZlJhbmdlID0gdGhpcy5tb2RlbExlZnQgKyB0aGlzLm1vZGVsV2lkdGggPCAwIHx8IHRoaXMubW9kZWxMZWZ0ID4gdGhpcy5yb3dzTWFuYWdlci5nYW50dC53aWR0aDsKCiAgICAgICAgdGhpcy5sZWZ0ID0gTWF0aC5taW4oTWF0aC5tYXgodGhpcy5tb2RlbExlZnQsIDApLCB0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LndpZHRoKTsKICAgICAgICBpZiAodGhpcy5tb2RlbExlZnQgPCAwKSB7CiAgICAgICAgICAgIHRoaXMudHJ1bmNhdGVkTGVmdCA9IHRydWU7CiAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsV2lkdGggKyB0aGlzLm1vZGVsTGVmdCA+IHRoaXMucm93c01hbmFnZXIuZ2FudHQud2lkdGgpIHsKICAgICAgICAgICAgICAgIHRoaXMudHJ1bmNhdGVkUmlnaHQgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy53aWR0aCA9IHRoaXMucm93c01hbmFnZXIuZ2FudHQud2lkdGg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnRydW5jYXRlZFJpZ2h0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5tb2RlbFdpZHRoICsgdGhpcy5tb2RlbExlZnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHRoaXMubW9kZWxXaWR0aCArIHRoaXMubW9kZWxMZWZ0ID4gdGhpcy5yb3dzTWFuYWdlci5nYW50dC53aWR0aCkgewogICAgICAgICAgICB0aGlzLnRydW5jYXRlZFJpZ2h0ID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50cnVuY2F0ZWRMZWZ0ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMud2lkdGggPSB0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LndpZHRoIC0gdGhpcy5tb2RlbExlZnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy50cnVuY2F0ZWRMZWZ0ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMudHJ1bmNhdGVkUmlnaHQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IHRoaXMubW9kZWxXaWR0aDsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIEV4cGFuZHMgdGhlIHN0YXJ0IG9mIHRoZSB0YXNrIHRvIHRoZSBzcGVjaWZpZWQgcG9zaXRpb24gKGluIGVtKQogICAgVGFzay5wcm90b3R5cGUuc2V0RnJvbSA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICB0aGlzLmZyb20gPSB0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LmdldERhdGVCeVBvc2l0aW9uKHgsIHRydWUpOwogICAgICAgIHRoaXMuX2Zyb21MYWJlbCA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLnJvdy5zZXRGcm9tVG9CeVRhc2sodGhpcyk7CiAgICAgICAgdGhpcy51cGRhdGVQb3NBbmRTaXplKCk7CiAgICAgICAgdGhpcy5jaGVja0lmTWlsZXN0b25lKCk7CiAgICB9OwoKICAgIC8vIEV4cGFuZHMgdGhlIGVuZCBvZiB0aGUgdGFzayB0byB0aGUgc3BlY2lmaWVkIHBvc2l0aW9uIChpbiBlbSkKICAgIFRhc2sucHJvdG90eXBlLnNldFRvID0gZnVuY3Rpb24oeCkgewogICAgICAgIHRoaXMudG8gPSB0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LmdldERhdGVCeVBvc2l0aW9uKHgsIHRydWUpOwogICAgICAgIHRoaXMuX3RvTGFiZWwgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5yb3cuc2V0RnJvbVRvQnlUYXNrKHRoaXMpOwogICAgICAgIHRoaXMudXBkYXRlUG9zQW5kU2l6ZSgpOwogICAgICAgIHRoaXMuY2hlY2tJZk1pbGVzdG9uZSgpOwogICAgfTsKCiAgICAvLyBNb3ZlcyB0aGUgdGFzayB0byB0aGUgc3BlY2lmaWVkIHBvc2l0aW9uIChpbiBlbSkKICAgIFRhc2sucHJvdG90eXBlLm1vdmVUbyA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICB0aGlzLmZyb20gPSB0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LmdldERhdGVCeVBvc2l0aW9uKHgsIHRydWUpOwogICAgICAgIHRoaXMuX2Zyb21MYWJlbCA9IHVuZGVmaW5lZDsKICAgICAgICB2YXIgbmV3VGFza0xlZnQgPSB0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LmdldFBvc2l0aW9uQnlEYXRlKHRoaXMuZnJvbSk7CiAgICAgICAgdGhpcy50byA9IHRoaXMucm93c01hbmFnZXIuZ2FudHQuZ2V0RGF0ZUJ5UG9zaXRpb24obmV3VGFza0xlZnQgKyB0aGlzLm1vZGVsV2lkdGgsIHRydWUpOwogICAgICAgIHRoaXMuX3RvTGFiZWwgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5yb3cuc2V0RnJvbVRvQnlUYXNrKHRoaXMpOwogICAgICAgIHRoaXMudXBkYXRlUG9zQW5kU2l6ZSgpOwogICAgfTsKCiAgICBUYXNrLnByb3RvdHlwZS5jb3B5ID0gZnVuY3Rpb24odGFzaykgewogICAgICAgIHRoaXMubmFtZSA9IHRhc2submFtZTsKICAgICAgICB0aGlzLmNvbG9yID0gdGFzay5jb2xvcjsKICAgICAgICB0aGlzLmNsYXNzZXMgPSB0YXNrLmNsYXNzZXM7CiAgICAgICAgdGhpcy5wcmlvcml0eSA9IHRhc2sucHJpb3JpdHk7CiAgICAgICAgdGhpcy5mcm9tID0gbW9tZW50KHRhc2suZnJvbSk7CiAgICAgICAgdGhpcy50byA9IG1vbWVudCh0YXNrLnRvKTsKICAgICAgICB0aGlzLmVzdCA9IHRhc2suZXN0ICE9PSB1bmRlZmluZWQgPyBtb21lbnQodGFzay5lc3QpIDogdW5kZWZpbmVkOwogICAgICAgIHRoaXMubGN0ID0gdGFzay5sY3QgIT09IHVuZGVmaW5lZCA/IG1vbWVudCh0YXNrLmxjdCkgOiB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5kYXRhID0gdGFzay5kYXRhOwogICAgICAgIHRoaXMuaXNNaWxlc3RvbmUgPSB0YXNrLmlzTWlsZXN0b25lOwogICAgfTsKCiAgICBUYXNrLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgVGFzayh0aGlzLmlkLCB0aGlzLnJvdywgdGhpcy5uYW1lLCB0aGlzLmNvbG9yLCB0aGlzLmNsYXNzZXMsIHRoaXMucHJpb3JpdHksIHRoaXMuZnJvbSwgdGhpcy50bywgdGhpcy5kYXRhLCB0aGlzLmVzdCwgdGhpcy5sY3QsIHRoaXMucHJvZ3Jlc3MpOwogICAgfTsKCiAgICByZXR1cm4gVGFzazsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0VGFza1Byb2dyZXNzJywgW2Z1bmN0aW9uKCkgewogICAgdmFyIFRhc2tQcm9ncmVzcyA9IGZ1bmN0aW9uKHRhc2ssIHBlcmNlbnQsIGNvbG9yLCBjbGFzc2VzKSB7CiAgICAgICAgdGhpcy50YXNrID0gdGFzazsKICAgICAgICB0aGlzLnBlcmNlbnQgPSBwZXJjZW50OwogICAgICAgIHRoaXMuY29sb3IgPSBjb2xvcjsKICAgICAgICB0aGlzLmNsYXNzZXMgPSBjbGFzc2VzOwogICAgfTsKCiAgICBUYXNrUHJvZ3Jlc3MucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBUYXNrUHJvZ3Jlc3ModGhpcy50YXNrLCB0aGlzLnBlcmNlbnQsIHRoaXMuY29sb3IsIHRoaXMuY2xhc3Nlcyk7CiAgICB9OwoKICAgIHJldHVybiBUYXNrUHJvZ3Jlc3M7Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdHYW50dEJvZHknLCBbJ0dhbnR0Qm9keUNvbHVtbnMnLCAnR2FudHRCb2R5Um93cycsIGZ1bmN0aW9uKEJvZHlDb2x1bW5zLCBCb2R5Um93cykgewogICAgdmFyIEJvZHk9IGZ1bmN0aW9uKGdhbnR0KSB7CiAgICAgICAgdGhpcy5nYW50dCA9IGdhbnR0OwoKICAgICAgICB0aGlzLmNvbHVtbnMgPSBuZXcgQm9keUNvbHVtbnModGhpcyk7CiAgICAgICAgdGhpcy5yb3dzID0gbmV3IEJvZHlSb3dzKHRoaXMpOwogICAgfTsKICAgIHJldHVybiBCb2R5Owp9XSk7CgoKZ2FudHQuZmFjdG9yeSgnR2FudHRCb2R5Q29sdW1ucycsIFtmdW5jdGlvbigpIHsKICAgIHZhciBCb2R5Q29sdW1ucyA9IGZ1bmN0aW9uKCRlbGVtZW50KSB7CiAgICAgICAgdGhpcy4kZWxlbWVudCA9ICRlbGVtZW50OwogICAgfTsKICAgIHJldHVybiBCb2R5Q29sdW1uczsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0Qm9keVJvd3MnLCBbZnVuY3Rpb24oKSB7CiAgICB2YXIgQm9keVJvd3MgPSBmdW5jdGlvbigkZWxlbWVudCkgewogICAgICAgIHRoaXMuJGVsZW1lbnQgPSAkZWxlbWVudDsKICAgIH07CiAgICByZXR1cm4gQm9keVJvd3M7Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdHYW50dEhlYWRlcicsIFsnR2FudHRIZWFkZXJDb2x1bW5zJywgZnVuY3Rpb24oSGVhZGVyQ29sdW1ucykgewogICAgdmFyIEhlYWRlciA9IGZ1bmN0aW9uKGdhbnR0KSB7CiAgICAgICAgdGhpcy5nYW50dCA9IGdhbnR0OwogICAgICAgIHRoaXMuY29sdW1ucyA9IG5ldyBIZWFkZXJDb2x1bW5zKHRoaXMpOwoKICAgICAgICB0aGlzLmdldEhlaWdodCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy4kZWxlbWVudFswXS5vZmZzZXRIZWlnaHQ7CiAgICAgICAgfTsKICAgIH07CiAgICByZXR1cm4gSGVhZGVyOwp9XSk7CgoKZ2FudHQuZmFjdG9yeSgnR2FudHRIZWFkZXJDb2x1bW5zJywgW2Z1bmN0aW9uKCkgewogICAgdmFyIEhlYWRlckNvbHVtbnMgPSBmdW5jdGlvbigkZWxlbWVudCkgewogICAgICAgIHRoaXMuJGVsZW1lbnQgPSAkZWxlbWVudDsKICAgIH07CiAgICByZXR1cm4gSGVhZGVyQ29sdW1uczsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0TGFiZWxzJywgW2Z1bmN0aW9uKCkgewogICAgdmFyIExhYmVscz0gZnVuY3Rpb24oZ2FudHQpIHsKICAgICAgICB0aGlzLmdhbnR0ID0gZ2FudHQ7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJFdmVudCgnbGFiZWxzJywgJ3Jlc2l6ZScpOwogICAgfTsKICAgIHJldHVybiBMYWJlbHM7Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdHYW50dFNjcm9sbCcsIFtmdW5jdGlvbigpIHsKICAgIHZhciBTY3JvbGwgPSBmdW5jdGlvbihnYW50dCkgewogICAgICAgIHRoaXMuZ2FudHQgPSBnYW50dDsKCiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJFdmVudCgnc2Nyb2xsJywgJ3Njcm9sbCcpOwoKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3Rlck1ldGhvZCgnc2Nyb2xsJywgJ3RvJywgU2Nyb2xsLnByb3RvdHlwZS5zY3JvbGxUbywgdGhpcyk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJNZXRob2QoJ3Njcm9sbCcsICd0b0RhdGUnLCBTY3JvbGwucHJvdG90eXBlLnNjcm9sbFRvRGF0ZSwgdGhpcyk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJNZXRob2QoJ3Njcm9sbCcsICdsZWZ0JywgU2Nyb2xsLnByb3RvdHlwZS5zY3JvbGxUb0xlZnQsIHRoaXMpOwogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyTWV0aG9kKCdzY3JvbGwnLCAncmlnaHQnLCBTY3JvbGwucHJvdG90eXBlLnNjcm9sbFRvUmlnaHQsIHRoaXMpOwogICAgfTsKCiAgICAvKioKICAgICAqIFNjcm9sbCB0byBhIHBvc2l0aW9uCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IHBvc2l0aW9uIFBvc2l0aW9uIHRvIHNjcm9sbCB0by4KICAgICAqLwogICAgU2Nyb2xsLnByb3RvdHlwZS5zY3JvbGxUbyA9IGZ1bmN0aW9uKHBvc2l0aW9uKSB7CiAgICAgICAgdGhpcy4kZWxlbWVudFswXS5zY3JvbGxMZWZ0ID0gcG9zaXRpb247CiAgICAgICAgdGhpcy4kZWxlbWVudC50cmlnZ2VySGFuZGxlcignc2Nyb2xsJyk7CiAgICB9OwoKICAgIC8qKgogICAgICogU2Nyb2xsIHRvIHRoZSBsZWZ0IHNpZGUKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gb2Zmc2V0IE9mZnNldCB0byBzY3JvbGwuCiAgICAgKi8KICAgIFNjcm9sbC5wcm90b3R5cGUuc2Nyb2xsVG9MZWZ0ID0gZnVuY3Rpb24ob2Zmc2V0KSB7CiAgICAgICAgdGhpcy4kZWxlbWVudFswXS5zY3JvbGxMZWZ0IC09IG9mZnNldDsKICAgICAgICB0aGlzLiRlbGVtZW50LnRyaWdnZXJIYW5kbGVyKCdzY3JvbGwnKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTY3JvbGwgdG8gdGhlIHJpZ2h0IHNpZGUKICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gb2Zmc2V0IE9mZnNldCB0byBzY3JvbGwuCiAgICAgKi8KICAgIFNjcm9sbC5wcm90b3R5cGUuc2Nyb2xsVG9SaWdodCA9IGZ1bmN0aW9uKG9mZnNldCkgewogICAgICAgIHRoaXMuJGVsZW1lbnRbMF0uc2Nyb2xsTGVmdCArPSBvZmZzZXQ7CiAgICAgICAgdGhpcy4kZWxlbWVudC50cmlnZ2VySGFuZGxlcignc2Nyb2xsJyk7CiAgICB9OwoKICAgIC8qKgogICAgICogU2Nyb2xsIHRvIGEgZGF0ZQogICAgICoKICAgICAqIEBwYXJhbSB7bW9tZW50fSBkYXRlIG1vbWVudCB0byBzY3JvbGwgdG8uCiAgICAgKi8KICAgIFNjcm9sbC5wcm90b3R5cGUuc2Nyb2xsVG9EYXRlID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgIHZhciBwb3NpdGlvbiA9IHRoaXMuZ2FudHQuZ2V0UG9zaXRpb25CeURhdGUoZGF0ZSk7CgogICAgICAgIGlmIChwb3NpdGlvbiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRoaXMuJGVsZW1lbnRbMF0uc2Nyb2xsTGVmdCA9IHBvc2l0aW9uIC0gdGhpcy4kZWxlbWVudFswXS5vZmZzZXRXaWR0aCAvIDI7CiAgICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gU2Nyb2xsOwp9XSk7CgoKZ2FudHQuZmFjdG9yeSgnR2FudHRUaW1lc3BhbicsIFsnbW9tZW50JywgZnVuY3Rpb24obW9tZW50KSB7CiAgICB2YXIgVGltZXNwYW4gPSBmdW5jdGlvbihpZCwgZ2FudHQsIG5hbWUsIGNvbG9yLCBjbGFzc2VzLCBwcmlvcml0eSwgZnJvbSwgdG8sIGRhdGEsIGVzdCwgbGN0KSB7CiAgICAgICAgdGhpcy5pZCA9IGlkOwogICAgICAgIHRoaXMuZ2FudHQgPSBnYW50dDsKICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgIHRoaXMuY29sb3IgPSBjb2xvcjsKICAgICAgICB0aGlzLmNsYXNzZXMgPSBjbGFzc2VzOwogICAgICAgIHRoaXMucHJpb3JpdHkgPSBwcmlvcml0eTsKICAgICAgICB0aGlzLmZyb20gPSBtb21lbnQoZnJvbSk7CiAgICAgICAgdGhpcy50byA9IG1vbWVudCh0byk7CiAgICAgICAgdGhpcy5kYXRhID0gZGF0YTsKCiAgICAgICAgaWYgKGVzdCAhPT0gdW5kZWZpbmVkICYmIGxjdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRoaXMuZXN0ID0gbW9tZW50KGVzdCk7ICAvL0VhcmxpZXN0IFN0YXJ0IFRpbWUKICAgICAgICAgICAgdGhpcy5sY3QgPSBtb21lbnQobGN0KTsgIC8vTGF0ZXN0IENvbXBsZXRpb24gVGltZQogICAgICAgIH0KICAgIH07CgogICAgLy8gVXBkYXRlcyB0aGUgcG9zIGFuZCBzaXplIG9mIHRoZSB0aW1lc3BhbiBhY2NvcmRpbmcgdG8gdGhlIGZyb20gLSB0byBkYXRlCiAgICBUaW1lc3Bhbi5wcm90b3R5cGUudXBkYXRlUG9zQW5kU2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMubGVmdCA9IHRoaXMuZ2FudHQuZ2V0UG9zaXRpb25CeURhdGUodGhpcy5mcm9tKTsKICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5nYW50dC5nZXRQb3NpdGlvbkJ5RGF0ZSh0aGlzLnRvKSAtIHRoaXMubGVmdDsKICAgIH07CgogICAgLy8gRXhwYW5kcyB0aGUgc3RhcnQgb2YgdGhlIHRpbWVzcGFuIHRvIHRoZSBzcGVjaWZpZWQgcG9zaXRpb24gKGluIGVtKQogICAgVGltZXNwYW4ucHJvdG90eXBlLnNldEZyb20gPSBmdW5jdGlvbih4KSB7CiAgICAgICAgdGhpcy5mcm9tID0gdGhpcy5nYW50dC5nZXREYXRlQnlQb3NpdGlvbih4KTsKICAgICAgICB0aGlzLnVwZGF0ZVBvc0FuZFNpemUoKTsKICAgIH07CgogICAgLy8gRXhwYW5kcyB0aGUgZW5kIG9mIHRoZSB0aW1lc3BhbiB0byB0aGUgc3BlY2lmaWVkIHBvc2l0aW9uIChpbiBlbSkKICAgIFRpbWVzcGFuLnByb3RvdHlwZS5zZXRUbyA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICB0aGlzLnRvID0gdGhpcy5nYW50dC5nZXREYXRlQnlQb3NpdGlvbih4KTsKICAgICAgICB0aGlzLnVwZGF0ZVBvc0FuZFNpemUoKTsKICAgIH07CgogICAgLy8gTW92ZXMgdGhlIHRpbWVzcGFuIHRvIHRoZSBzcGVjaWZpZWQgcG9zaXRpb24gKGluIGVtKQogICAgVGltZXNwYW4ucHJvdG90eXBlLm1vdmVUbyA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICB0aGlzLmZyb20gPSB0aGlzLmdhbnR0LmdldERhdGVCeVBvc2l0aW9uKHgpOwogICAgICAgIHRoaXMudG8gPSB0aGlzLmdhbnR0LmdldERhdGVCeVBvc2l0aW9uKHggKyB0aGlzLndpZHRoKTsKICAgICAgICB0aGlzLnVwZGF0ZVBvc0FuZFNpemUoKTsKICAgIH07CgogICAgVGltZXNwYW4ucHJvdG90eXBlLmNvcHkgPSBmdW5jdGlvbih0aW1lc3BhbikgewogICAgICAgIHRoaXMubmFtZSA9IHRpbWVzcGFuLm5hbWU7CiAgICAgICAgdGhpcy5jb2xvciA9IHRpbWVzcGFuLmNvbG9yOwogICAgICAgIHRoaXMuY2xhc3NlcyA9IHRpbWVzcGFuLmNsYXNzZXM7CiAgICAgICAgdGhpcy5wcmlvcml0eSA9IHRpbWVzcGFuLnByaW9yaXR5OwogICAgICAgIHRoaXMuZnJvbSA9IG1vbWVudCh0aW1lc3Bhbi5mcm9tKTsKICAgICAgICB0aGlzLnRvID0gbW9tZW50KHRpbWVzcGFuLnRvKTsKICAgICAgICB0aGlzLmVzdCA9IHRpbWVzcGFuLmVzdCAhPT0gdW5kZWZpbmVkID8gbW9tZW50KHRpbWVzcGFuLmVzdCkgOiB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5sY3QgPSB0aW1lc3Bhbi5sY3QgIT09IHVuZGVmaW5lZCA/IG1vbWVudCh0aW1lc3Bhbi5sY3QpIDogdW5kZWZpbmVkOwogICAgICAgIHRoaXMuZGF0YSA9IHRpbWVzcGFuLmRhdGE7CiAgICB9OwoKICAgIFRpbWVzcGFuLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgVGltZXNwYW4odGhpcy5pZCwgdGhpcy5nYW50dCwgdGhpcy5uYW1lLCB0aGlzLmNvbG9yLCB0aGlzLmNsYXNzZXMsIHRoaXMucHJpb3JpdHksIHRoaXMuZnJvbSwgdGhpcy50bywgdGhpcy5kYXRhLCB0aGlzLmVzdCwgdGhpcy5sY3QpOwogICAgfTsKCiAgICByZXR1cm4gVGltZXNwYW47Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdHYW50dFRpbWVzcGFuc01hbmFnZXInLCBbJ0dhbnR0VGltZXNwYW4nLCBmdW5jdGlvbihUaW1lc3BhbikgewogICAgdmFyIEdhbnR0VGltZXNwYW5zTWFuYWdlciA9IGZ1bmN0aW9uKGdhbnR0KSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICB0aGlzLmdhbnR0ID0gZ2FudHQ7CgogICAgICAgIHRoaXMudGltZXNwYW5zTWFwID0ge307CiAgICAgICAgdGhpcy50aW1lc3BhbnMgPSBbXTsKCiAgICAgICAgdGhpcy5nYW50dC4kc2NvcGUuJHdhdGNoKCd0aW1lc3BhbnMnLCBmdW5jdGlvbihuZXdWYWx1ZSkgewogICAgICAgICAgICBzZWxmLmNsZWFyVGltZXNwYW5zKCk7CiAgICAgICAgICAgIHNlbGYubG9hZFRpbWVzcGFucyhuZXdWYWx1ZSk7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyTWV0aG9kKCd0aW1lc3BhbnMnLCAnbG9hZCcsIHRoaXMubG9hZFRpbWVzcGFucywgdGhpcyk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJNZXRob2QoJ3RpbWVzcGFucycsICdyZW1vdmUnLCB0aGlzLnJlbW92ZVRpbWVzcGFucywgdGhpcyk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJNZXRob2QoJ3RpbWVzcGFucycsICdjbGVhcicsIHRoaXMuY2xlYXJUaW1lc3BhbnMsIHRoaXMpOwoKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3RlckV2ZW50KCd0aW1lc3BhbnMnLCAnYWRkJyk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJFdmVudCgndGltZXNwYW5zJywgJ3JlbW92ZScpOwogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyRXZlbnQoJ3RpbWVzcGFucycsICdjaGFuZ2UnKTsKICAgIH07CgogICAgLy8gQWRkcyBvciB1cGRhdGVzIHRpbWVzcGFucwogICAgR2FudHRUaW1lc3BhbnNNYW5hZ2VyLnByb3RvdHlwZS5sb2FkVGltZXNwYW5zID0gZnVuY3Rpb24odGltZXNwYW5zKSB7CiAgICAgICAgaWYgKCFhbmd1bGFyLmlzQXJyYXkodGltZXNwYW5zKSkgewogICAgICAgICAgICB0aW1lc3BhbnMgPSBbdGltZXNwYW5zXTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGltZXNwYW5zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB2YXIgdGltZXNwYW5EYXRhID0gdGltZXNwYW5zW2ldOwogICAgICAgICAgICB0aGlzLmxvYWRUaW1lc3Bhbih0aW1lc3BhbkRhdGEpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gQWRkcyBhIHRpbWVzcGFuIG9yIG1lcmdlcyB0aGUgdGltZXNwYW4gaWYgdGhlcmUgaXMgYWxyZWFkeSBvbmUgd2l0aCB0aGUgc2FtZSBpZAogICAgR2FudHRUaW1lc3BhbnNNYW5hZ2VyLnByb3RvdHlwZS5sb2FkVGltZXNwYW4gPSBmdW5jdGlvbih0aW1lc3BhbkRhdGEpIHsKICAgICAgICAvLyBDb3B5IHRvIG5ldyB0aW1lc3BhbiAoYWRkKSBvciBtZXJnZSB3aXRoIGV4aXN0aW5nICh1cGRhdGUpCiAgICAgICAgdmFyIHRpbWVzcGFuLCBpc1VwZGF0ZSA9IGZhbHNlOwoKICAgICAgICBpZiAodGltZXNwYW5EYXRhLmlkIGluIHRoaXMudGltZXNwYW5zTWFwKSB7CiAgICAgICAgICAgIHRpbWVzcGFuID0gdGhpcy50aW1lc3BhbnNNYXBbdGltZXNwYW5EYXRhLmlkXTsKICAgICAgICAgICAgdGltZXNwYW4uY29weSh0aW1lc3BhbkRhdGEpOwogICAgICAgICAgICBpc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuZ2FudHQuYXBpLnRpbWVzcGFucy5yYWlzZS5jaGFuZ2UodGltZXNwYW4pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRpbWVzcGFuID0gbmV3IFRpbWVzcGFuKHRpbWVzcGFuRGF0YS5pZCwgdGhpcy5nYW50dCwgdGltZXNwYW5EYXRhLm5hbWUsIHRpbWVzcGFuRGF0YS5jb2xvciwKICAgICAgICAgICAgICAgIHRpbWVzcGFuRGF0YS5jbGFzc2VzLCB0aW1lc3BhbkRhdGEucHJpb3JpdHksIHRpbWVzcGFuRGF0YS5mcm9tLCB0aW1lc3BhbkRhdGEudG8sIHRpbWVzcGFuRGF0YS5kYXRhKTsKICAgICAgICAgICAgdGhpcy50aW1lc3BhbnNNYXBbdGltZXNwYW5EYXRhLmlkXSA9IHRpbWVzcGFuOwogICAgICAgICAgICB0aGlzLnRpbWVzcGFucy5wdXNoKHRpbWVzcGFuKTsKICAgICAgICAgICAgdGhpcy5nYW50dC5hcGkudGltZXNwYW5zLnJhaXNlLmFkZCh0aW1lc3Bhbik7CiAgICAgICAgfQoKICAgICAgICB0aW1lc3Bhbi51cGRhdGVQb3NBbmRTaXplKCk7CiAgICAgICAgcmV0dXJuIGlzVXBkYXRlOwogICAgfTsKCiAgICBHYW50dFRpbWVzcGFuc01hbmFnZXIucHJvdG90eXBlLnJlbW92ZVRpbWVzcGFucyA9IGZ1bmN0aW9uKHRpbWVzcGFucykgewogICAgICAgIGlmICghYW5ndWxhci5pc0FycmF5KHRpbWVzcGFucykpIHsKICAgICAgICAgICAgdGltZXNwYW5zID0gW3RpbWVzcGFuc107CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRpbWVzcGFucy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdmFyIHRpbWVzcGFuRGF0YSA9IHRpbWVzcGFuc1tpXTsKICAgICAgICAgICAgLy8gRGVsZXRlIHRoZSB0aW1lc3BhbgogICAgICAgICAgICB0aGlzLnJlbW92ZVRpbWVzcGFuKHRpbWVzcGFuRGF0YS5pZCk7CiAgICAgICAgfQogICAgICAgIHRoaXMudXBkYXRlVmlzaWJsZU9iamVjdHMoKTsKICAgIH07CgogICAgR2FudHRUaW1lc3BhbnNNYW5hZ2VyLnByb3RvdHlwZS5yZW1vdmVUaW1lc3BhbiA9IGZ1bmN0aW9uKHRpbWVzcGFuSWQpIHsKICAgICAgICBpZiAodGltZXNwYW5JZCBpbiB0aGlzLnRpbWVzcGFuc01hcCkgewogICAgICAgICAgICBkZWxldGUgdGhpcy50aW1lc3BhbnNNYXBbdGltZXNwYW5JZF07IC8vIFJlbW92ZSBmcm9tIG1hcAoKICAgICAgICAgICAgdmFyIHJlbW92ZWRUaW1lc3BhbjsKICAgICAgICAgICAgdmFyIHRpbWVzcGFuOwogICAgICAgICAgICBmb3IgKHZhciBpID0gdGhpcy50aW1lc3BhbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIHRpbWVzcGFuID0gdGhpcy50aW1lc3BhbnNbaV07CiAgICAgICAgICAgICAgICBpZiAodGltZXNwYW4uaWQgPT09IHRpbWVzcGFuSWQpIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVkVGltZXNwYW4gPSB0aW1lc3BhbjsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbWVzcGFucy5zcGxpY2UoaSwgMSk7IC8vIFJlbW92ZSBmcm9tIGFycmF5CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2FudHQuYXBpLnRpbWVzcGFucy5yYWlzZS5yZW1vdmUocmVtb3ZlZFRpbWVzcGFuKTsKICAgICAgICAgICAgcmV0dXJuIHJlbW92ZWRUaW1lc3BhbjsKICAgICAgICB9CgogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9OwoKICAgIC8vIFJlbW92ZXMgYWxsIHRpbWVzcGFucwogICAgR2FudHRUaW1lc3BhbnNNYW5hZ2VyLnByb3RvdHlwZS5jbGVhclRpbWVzcGFucyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudGltZXNwYW5zTWFwID0ge307CiAgICAgICAgdGhpcy50aW1lc3BhbnMgPSBbXTsKICAgIH07CgogICAgR2FudHRUaW1lc3BhbnNNYW5hZ2VyLnByb3RvdHlwZS51cGRhdGVUaW1lc3BhbnNQb3NBbmRTaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLnRpbWVzcGFucy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy50aW1lc3BhbnNbaV0udXBkYXRlUG9zQW5kU2l6ZSgpOwogICAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIEdhbnR0VGltZXNwYW5zTWFuYWdlcjsKfV0pOwoKCmdhbnR0LnNlcnZpY2UoJ2dhbnR0QmluYXJ5U2VhcmNoJywgWyBmdW5jdGlvbigpIHsKICAgIC8vIFJldHVybnMgdGhlIG9iamVjdCBvbiB0aGUgbGVmdCBhbmQgcmlnaHQgaW4gYW4gYXJyYXkgdXNpbmcgdGhlIGdpdmVuIGNtcCBmdW5jdGlvbi4KICAgIC8vIFRoZSBjb21wYXJlIGZ1bmN0aW9uIGRlZmluZWQgd2hpY2ggcHJvcGVydHkgb2YgdGhlIHZhbHVlIHRvIGNvbXBhcmUgKGUuZy46IGMgPT4gYy5sZWZ0KQoKICAgIHJldHVybiB7CiAgICAgICAgZ2V0SW5kaWNlc09ubHk6IGZ1bmN0aW9uKGlucHV0LCB2YWx1ZSwgY29tcGFyZXIpIHsKICAgICAgICAgICAgdmFyIGxvID0gLTEsIGhpID0gaW5wdXQubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoaGkgLSBsbyA+IDEpIHsKICAgICAgICAgICAgICAgIHZhciBtaWQgPSBNYXRoLmZsb29yKChsbyArIGhpKSAvIDIpOwogICAgICAgICAgICAgICAgaWYgKGNvbXBhcmVyKGlucHV0W21pZF0pIDw9IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgbG8gPSBtaWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGhpID0gbWlkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnB1dFtsb10gIT09IHVuZGVmaW5lZCAmJiBjb21wYXJlcihpbnB1dFtsb10pID09PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgaGkgPSBsbzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gW2xvLCBoaV07CiAgICAgICAgfSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uKGlucHV0LCB2YWx1ZSwgY29tcGFyZXIpIHsKICAgICAgICAgICAgdmFyIHJlcyA9IHRoaXMuZ2V0SW5kaWNlc09ubHkoaW5wdXQsIHZhbHVlLCBjb21wYXJlcik7CiAgICAgICAgICAgIHJldHVybiBbaW5wdXRbcmVzWzBdXSwgaW5wdXRbcmVzWzFdXV07CiAgICAgICAgfQogICAgfTsKfV0pOwoKZ2FudHQuc2VydmljZSgnZ2FudHRVdGlscycsIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgICAgY3JlYXRlQm91bmRlZFdyYXBwZXI6IGZ1bmN0aW9uKG9iamVjdCwgbWV0aG9kKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkob2JqZWN0LCBhcmd1bWVudHMpOwogICAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgbmV3SWQ6IChmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHNlZWRJZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VlZElkICs9IDE7CiAgICAgICAgICAgIH07CiAgICAgICAgfSkoKQogICAgfTsKfV0pOwoKCmdhbnR0LmZpbHRlcignZ2FudHRDb2x1bW5MaW1pdCcsIFsgJ2dhbnR0QmluYXJ5U2VhcmNoJywgZnVuY3Rpb24oYnMpIHsKICAgIC8vIFJldHVybnMgb25seSB0aGUgY29sdW1ucyB3aGljaCBhcmUgdmlzaWJsZSBvbiB0aGUgc2NyZWVuCgogICAgcmV0dXJuIGZ1bmN0aW9uKGlucHV0LCBzY3JvbGxMZWZ0LCBzY3JvbGxXaWR0aCkgewogICAgICAgIHZhciBjbXAgPSBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgIHJldHVybiBjLmxlZnQ7CiAgICAgICAgfTsKICAgICAgICB2YXIgc3RhcnQgPSBicy5nZXRJbmRpY2VzT25seShpbnB1dCwgc2Nyb2xsTGVmdCwgY21wKVswXTsKICAgICAgICB2YXIgZW5kID0gYnMuZ2V0SW5kaWNlc09ubHkoaW5wdXQsIHNjcm9sbExlZnQgKyBzY3JvbGxXaWR0aCwgY21wKVsxXTsKICAgICAgICByZXR1cm4gaW5wdXQuc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dExpbWl0VXBkYXRlcicsIFsnJHRpbWVvdXQnLCAnZ2FudHREZWJvdW5jZScsIGZ1bmN0aW9uKCR0aW1lb3V0LCBkZWJvdW5jZSkgewogICAgLy8gVXBkYXRlcyB0aGUgbGltaXQgZmlsdGVycyBpZiB0aGUgdXNlciBzY3JvbGxzIHRoZSBnYW50dCBjaGFydAoKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIGVsID0gJGVsZW1lbnRbMF07CiAgICAgICAgICAgIHZhciBzY3JvbGxVcGRhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS5zY3JvbGxMZWZ0ID0gZWwuc2Nyb2xsTGVmdDsKICAgICAgICAgICAgICAgICRzY29wZS5zY3JvbGxXaWR0aCA9IGVsLm9mZnNldFdpZHRoOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJGVsZW1lbnQuYmluZCgnc2Nyb2xsJywgZGVib3VuY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzY3JvbGxVcGRhdGUoKTsKICAgICAgICAgICAgfSwgNSkpOwoKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnZ2FudHQud2lkdGgnLCBkZWJvdW5jZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNjcm9sbFVwZGF0ZSgpOwogICAgICAgICAgICB9LCAyMCkpOwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZmlsdGVyKCdnYW50dFRhc2tMaW1pdCcsIFtmdW5jdGlvbigpIHsKICAgIC8vIFJldHVybnMgb25seSB0aGUgdGFza3Mgd2hpY2ggYXJlIHZpc2libGUgb24gdGhlIHNjcmVlbgogICAgLy8gVXNlIHRoZSB0YXNrIHdpZHRoIGFuZCBwb3NpdGlvbiB0byBkZWNpZGUgaWYgYSB0YXNrIGlzIHN0aWxsIHZpc2libGUKCiAgICByZXR1cm4gZnVuY3Rpb24oaW5wdXQsIGdhbnR0KSB7CiAgICAgICAgdmFyIHJlcyA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gaW5wdXQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHZhciB0YXNrID0gaW5wdXRbaV07CiAgICAgICAgICAgIC8vIElmIHRoZSB0YXNrIGNhbiBiZSBkcmF3biB3aXRoIGdhbnR0IGNvbHVtbnMgb25seS4KICAgICAgICAgICAgaWYgKHRhc2sudG8gPiBnYW50dC5jb2x1bW5zTWFuYWdlci5nZXRGaXJzdENvbHVtbigpLmRhdGUgJiYgdGFzay5mcm9tIDwgZ2FudHQuY29sdW1uc01hbmFnZXIuZ2V0TGFzdENvbHVtbigpLmVuZERhdGUpIHsKCiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsTGVmdCA9IGdhbnR0LiRzY29wZS5zY3JvbGxMZWZ0OwogICAgICAgICAgICAgICAgdmFyIHNjcm9sbFdpZHRoID0gZ2FudHQuJHNjb3BlLnNjcm9sbFdpZHRoOwoKICAgICAgICAgICAgICAgIC8vIElmIHRhc2sgaGFzIGEgdmlzaWJsZSBwYXJ0IG9uIHRoZSBzY3JlZW4KICAgICAgICAgICAgICAgIGlmICh0YXNrLmxlZnQgPj0gc2Nyb2xsTGVmdCAmJiB0YXNrLmxlZnQgPD0gc2Nyb2xsTGVmdCArIHNjcm9sbFdpZHRoIHx8CiAgICAgICAgICAgICAgICAgICAgdGFzay5sZWZ0ICsgdGFzay53aWR0aCA+PSBzY3JvbGxMZWZ0ICYmIHRhc2subGVmdCArIHRhc2sud2lkdGggPD0gc2Nyb2xsTGVmdCArIHNjcm9sbFdpZHRoIHx8CiAgICAgICAgICAgICAgICAgICAgdGFzay5sZWZ0IDwgc2Nyb2xsTGVmdCAmJiB0YXNrLmxlZnQgKyB0YXNrLndpZHRoID4gc2Nyb2xsTGVmdCArIHNjcm9sbFdpZHRoKSB7CgogICAgICAgICAgICAgICAgICAgIHJlcy5wdXNoKHRhc2spOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlczsKICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0TGFiZWxzUmVzaXplJywgWyckZG9jdW1lbnQnLCAnZ2FudHREZWJvdW5jZScsICdnYW50dE1vdXNlT2Zmc2V0JywgZnVuY3Rpb24oJGRvY3VtZW50LCBkZWJvdW5jZSwgbW91c2VPZmZzZXQpIHsKCiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgICAgc2NvcGU6IHsgZW5hYmxlZDogJz1nYW50dExhYmVsc1Jlc2l6ZScsCiAgICAgICAgICAgIHdpZHRoOiAnPWdhbnR0TGFiZWxzUmVzaXplV2lkdGgnLAogICAgICAgICAgICBtaW5XaWR0aDogJz1nYW50dExhYmVsc1Jlc2l6ZU1pbldpZHRoJ30sCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciByZXNpemVBcmVhV2lkdGggPSA1OwogICAgICAgICAgICB2YXIgY3Vyc29yID0gJ2V3LXJlc2l6ZSc7CiAgICAgICAgICAgIHZhciBvcmlnaW5hbFBvczsKCiAgICAgICAgICAgICRlbGVtZW50LmJpbmQoJ21vdXNlZG93bicsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIGlmICgkc2NvcGUuZW5hYmxlZCAmJiBpc0luUmVzaXplQXJlYShlKSkgewogICAgICAgICAgICAgICAgICAgIGVuYWJsZVJlc2l6ZU1vZGUoZSk7CiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICRlbGVtZW50LmJpbmQoJ21vdXNlbW92ZScsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIGlmICgkc2NvcGUuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0luUmVzaXplQXJlYShlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC5jc3MoJ2N1cnNvcicsIGN1cnNvcik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuY3NzKCdjdXJzb3InLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHZhciByZXNpemUgPSBmdW5jdGlvbih4KSB7CiAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLndpZHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLndpZHRoID0gJGVsZW1lbnRbMF0ub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJHNjb3BlLndpZHRoICs9IHggLSBvcmlnaW5hbFBvczsKICAgICAgICAgICAgICAgIGlmICgkc2NvcGUud2lkdGggPCAkc2NvcGUubWluV2lkdGgpIHsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUud2lkdGggPSAkc2NvcGUubWluV2lkdGg7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb3JpZ2luYWxQb3MgPSB4OwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGlzSW5SZXNpemVBcmVhID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgdmFyIHggPSBtb3VzZU9mZnNldC5nZXRPZmZzZXQoZSkueDsKCiAgICAgICAgICAgICAgICByZXR1cm4geCA+ICRlbGVtZW50WzBdLm9mZnNldFdpZHRoIC0gcmVzaXplQXJlYVdpZHRoOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGVuYWJsZVJlc2l6ZU1vZGUgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBvcmlnaW5hbFBvcyA9IGUuc2NyZWVuWDsKCiAgICAgICAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoJGRvY3VtZW50WzBdLmJvZHkpLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgJy1tb3otdXNlci1zZWxlY3QnOiAnLW1vei1ub25lJywKICAgICAgICAgICAgICAgICAgICAnLXdlYmtpdC11c2VyLXNlbGVjdCc6ICdub25lJywKICAgICAgICAgICAgICAgICAgICAnLW1zLXVzZXItc2VsZWN0JzogJ25vbmUnLAogICAgICAgICAgICAgICAgICAgICd1c2VyLXNlbGVjdCc6ICdub25lJywKICAgICAgICAgICAgICAgICAgICAnY3Vyc29yJzogY3Vyc29yCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB2YXIgbW92ZUhhbmRsZXIgPSBkZWJvdW5jZShmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzaXplKGUuc2NyZWVuWCk7CiAgICAgICAgICAgICAgICB9LCA1KTsKCiAgICAgICAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoJGRvY3VtZW50WzBdLmJvZHkpLmJpbmQoJ21vdXNlbW92ZScsIG1vdmVIYW5kbGVyKTsKCiAgICAgICAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoJGRvY3VtZW50WzBdLmJvZHkpLm9uZSgnbW91c2V1cCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudCgkZG9jdW1lbnRbMF0uYm9keSkudW5iaW5kKCdtb3VzZW1vdmUnLCBtb3ZlSGFuZGxlcik7CiAgICAgICAgICAgICAgICAgICAgZGlzYWJsZVJlc2l6ZU1vZGUoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGRpc2FibGVSZXNpemVNb2RlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5jc3MoJ2N1cnNvcicsICcnKTsKCiAgICAgICAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoJGRvY3VtZW50WzBdLmJvZHkpLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgJy1tb3otdXNlci1zZWxlY3QnOiAnJywKICAgICAgICAgICAgICAgICAgICAnLXdlYmtpdC11c2VyLXNlbGVjdCc6ICcnLAogICAgICAgICAgICAgICAgICAgICctbXMtdXNlci1zZWxlY3QnOiAnJywKICAgICAgICAgICAgICAgICAgICAndXNlci1zZWxlY3QnOiAnJywKICAgICAgICAgICAgICAgICAgICAnY3Vyc29yJzogJycKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkubGFiZWxzLnJhaXNlLnJlc2l6ZSgkc2NvcGUud2lkdGgpOwogICAgICAgICAgICB9OwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dFJpZ2h0Q2xpY2snLCBbJyRwYXJzZScsIGZ1bmN0aW9uKCRwYXJzZSkgewoKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICB2YXIgZm4gPSAkcGFyc2UoYXR0ci5nYW50dFJpZ2h0Q2xpY2spOwoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50KSB7CiAgICAgICAgICAgICAgICBlbGVtZW50Lm9uKCdjb250ZXh0bWVudScsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBmbihzY29wZSwgeyRldmVudDogZXZlbnR9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH07Cn1dKTsKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRIb3Jpem9udGFsU2Nyb2xsUmVjZWl2ZXInLCBmdW5jdGlvbigpIHsKICAgIC8vIFRoZSBlbGVtZW50IHdpdGggdGhpcyBhdHRyaWJ1dGUgd2lsbCBzY3JvbGwgYXQgdGhlIHNhbWUgdGltZSBhcyB0aGUgc2Nyb2xsU2VuZGVyIGVsZW1lbnQKCiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgICAgcmVxdWlyZTogJ15nYW50dFNjcm9sbE1hbmFnZXInLAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICAkc2NvcGUuc2Nyb2xsTWFuYWdlci5ob3Jpem9udGFsLnB1c2goJGVsZW1lbnRbMF0pOwogICAgICAgIH1dCiAgICB9Owp9KTsKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRTY3JvbGxNYW5hZ2VyJywgZnVuY3Rpb24oKSB7CiAgICAvLyBUaGUgZWxlbWVudCB3aXRoIHRoaXMgYXR0cmlidXRlIHdpbGwgc2Nyb2xsIGF0IHRoZSBzYW1lIHRpbWUgYXMgdGhlIHNjcm9sbFNlbmRlciBlbGVtZW50CgogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0EnLAogICAgICAgIHJlcXVpcmU6ICdeZ2FudHQnLAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAgICRzY29wZS5zY3JvbGxNYW5hZ2VyID0gewogICAgICAgICAgICAgICAgaG9yaXpvbnRhbDogW10sCiAgICAgICAgICAgICAgICB2ZXJ0aWNhbDogW10KICAgICAgICAgICAgfTsKICAgICAgICB9XQogICAgfTsKfSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dFNjcm9sbFNlbmRlcicsIFsnJHRpbWVvdXQnLCAnZ2FudHREZWJvdW5jZScsIGZ1bmN0aW9uKCR0aW1lb3V0LCBkZWJvdW5jZSkgewogICAgLy8gVXBkYXRlcyB0aGUgZWxlbWVudCB3aGljaCBhcmUgcmVnaXN0ZXJlZCBmb3IgdGhlIGhvcml6b250YWwgb3IgdmVydGljYWwgc2Nyb2xsIGV2ZW50CgogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0EnLAogICAgICAgIHJlcXVpcmU6ICdeZ2FudHRTY3JvbGxNYW5hZ2VyJywKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIGVsID0gJGVsZW1lbnRbMF07CiAgICAgICAgICAgIHZhciB1cGRhdGVMaXN0ZW5lcnMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpLCBsOwoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSAkc2NvcGUuc2Nyb2xsTWFuYWdlci52ZXJ0aWNhbC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdkVsZW1lbnQgPSAkc2NvcGUuc2Nyb2xsTWFuYWdlci52ZXJ0aWNhbFtpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodkVsZW1lbnQuc3R5bGUudG9wICE9PSAtZWwuc2Nyb2xsVG9wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZFbGVtZW50LnN0eWxlLnRvcCA9IC1lbC5zY3JvbGxUb3AgKyAncHgnOwogICAgICAgICAgICAgICAgICAgICAgICB2RWxlbWVudC5zdHlsZS5oZWlnaHQgPSBlbC5zY3JvbGxIZWlnaHQgKyAncHgnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gJHNjb3BlLnNjcm9sbE1hbmFnZXIuaG9yaXpvbnRhbC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaEVsZW1lbnQgPSAkc2NvcGUuc2Nyb2xsTWFuYWdlci5ob3Jpem9udGFsW2ldOwogICAgICAgICAgICAgICAgICAgIGlmIChoRWxlbWVudC5zdHlsZS5sZWZ0ICE9PSAtZWwuc2Nyb2xsTGVmdCkgewogICAgICAgICAgICAgICAgICAgICAgICBoRWxlbWVudC5zdHlsZS5sZWZ0ID0gLWVsLnNjcm9sbExlZnQgKyAncHgnOwogICAgICAgICAgICAgICAgICAgICAgICBoRWxlbWVudC5zdHlsZS53aWR0aCA9IGVsLnNjcm9sbFdpZHRoICsgJ3B4JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAkZWxlbWVudC5iaW5kKCdzY3JvbGwnLCB1cGRhdGVMaXN0ZW5lcnMpOwogICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLnJvd3Mub24uY2hhbmdlKCRzY29wZSwgZGVib3VuY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVMaXN0ZW5lcnMoKTsKICAgICAgICAgICAgfSwgNSkpOwoKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnZ2FudHQud2lkdGgnLCBmdW5jdGlvbihuZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKG5ld1ZhbHVlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUxpc3RlbmVycygpOwogICAgICAgICAgICAgICAgICAgIH0sIDAsIHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfTsKfV0pOwoKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRTY3JvbGxhYmxlJywgWydnYW50dERlYm91bmNlJywgJ2dhbnR0TGF5b3V0JywgZnVuY3Rpb24oZGVib3VuY2UsIGxheW91dCkgewogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICB0ZW1wbGF0ZVVybDogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICAgICAgICBpZiAodEF0dHJzLnRlbXBsYXRlVXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAndGVtcGxhdGUvZGVmYXVsdC5zY3JvbGxhYmxlLnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LnNjcm9sbC4kZWxlbWVudCA9ICRlbGVtZW50OwoKICAgICAgICAgICAgdmFyIHNjcm9sbEJhcldpZHRoID0gbGF5b3V0LmdldFNjcm9sbEJhcldpZHRoKCk7CiAgICAgICAgICAgIHZhciBsYXN0U2Nyb2xsTGVmdDsKCiAgICAgICAgICAgIHZhciBsYXN0QXV0b0V4cGFuZDsKICAgICAgICAgICAgdmFyIGF1dG9FeHBhbmRDb29sRG93blBlcmlvZCA9IDUwMDsKICAgICAgICAgICAgdmFyIGF1dG9FeHBhbmRDb2x1bW5zID0gZnVuY3Rpb24oZWwsIGRhdGUsIGRpcmVjdGlvbikgewogICAgICAgICAgICAgICAgaWYgKCRzY29wZS5hdXRvRXhwYW5kICE9PSAnYm90aCcgJiYgJHNjb3BlLmF1dG9FeHBhbmQgIT09IHRydWUgJiYgJHNjb3BlLmF1dG9FeHBhbmQgIT09IGRpcmVjdGlvbikgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIGxhc3RBdXRvRXhwYW5kIDwgYXV0b0V4cGFuZENvb2xEb3duUGVyaW9kKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBmcm9tLCB0bzsKICAgICAgICAgICAgICAgIHZhciBleHBhbmRIb3VyID0gMSwgZXhwYW5kRGF5ID0gMzE7CgogICAgICAgICAgICAgICAgaWYgKGRpcmVjdGlvbiA9PT0gJ2xlZnQnKSB7CiAgICAgICAgICAgICAgICAgICAgZnJvbSA9ICRzY29wZS52aWV3U2NhbGUgPT09ICdob3VyJyA/IG1vbWVudChkYXRlKS5hZGQoLWV4cGFuZEhvdXIsICdkYXknKSA6IG1vbWVudChkYXRlKS5hZGQoLWV4cGFuZERheSwgJ2RheScpOwogICAgICAgICAgICAgICAgICAgIHRvID0gZGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZnJvbSA9IGRhdGU7CiAgICAgICAgICAgICAgICAgICAgdG8gPSAkc2NvcGUudmlld1NjYWxlID09PSAnaG91cicgPyBtb21lbnQoZGF0ZSkuYWRkKGV4cGFuZEhvdXIsICdkYXknKSA6IG1vbWVudChkYXRlKS5hZGQoZXhwYW5kRGF5LCAnZGF5Jyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJHNjb3BlLmZyb21EYXRlID0gZnJvbTsKICAgICAgICAgICAgICAgICRzY29wZS50b0RhdGUgPSB0bzsKICAgICAgICAgICAgICAgIGxhc3RBdXRvRXhwYW5kID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICRlbGVtZW50LmJpbmQoJ3Njcm9sbCcsIGRlYm91bmNlKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGVsID0gJGVsZW1lbnRbMF07CiAgICAgICAgICAgICAgICB2YXIgZGlyZWN0aW9uOwogICAgICAgICAgICAgICAgdmFyIGRhdGU7CgogICAgICAgICAgICAgICAgaWYgKGVsLnNjcm9sbExlZnQgPCBsYXN0U2Nyb2xsTGVmdCAmJiBlbC5zY3JvbGxMZWZ0ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aW9uID0gJ2xlZnQnOwogICAgICAgICAgICAgICAgICAgIGRhdGUgPSAkc2NvcGUuZ2FudHQuY29sdW1uc01hbmFnZXIuZnJvbTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZWwuc2Nyb2xsTGVmdCA+IGxhc3RTY3JvbGxMZWZ0ICYmIGVsLm9mZnNldFdpZHRoICsgZWwuc2Nyb2xsTGVmdCA+PSBlbC5zY3JvbGxXaWR0aCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICBkaXJlY3Rpb24gPSAncmlnaHQnOwogICAgICAgICAgICAgICAgICAgIGRhdGUgPSAkc2NvcGUuZ2FudHQuY29sdW1uc01hbmFnZXIudG87CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGFzdFNjcm9sbExlZnQgPSBlbC5zY3JvbGxMZWZ0OwoKICAgICAgICAgICAgICAgIGlmIChkYXRlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBhdXRvRXhwYW5kQ29sdW1ucyhlbCwgZGF0ZSwgZGlyZWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLnNjcm9sbC5yYWlzZS5zY3JvbGwoZWwuc2Nyb2xsTGVmdCwgZGF0ZSwgZGlyZWN0aW9uKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5zY3JvbGwucmFpc2Uuc2Nyb2xsKGVsLnNjcm9sbExlZnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCA1KSk7CgogICAgICAgICAgICAkc2NvcGUuZ2V0U2Nyb2xsYWJsZUNzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGNzcyA9IHt9OwoKICAgICAgICAgICAgICAgIGlmICgkc2NvcGUuZ2FudHRFbGVtZW50V2lkdGggLSAoJHNjb3BlLnNob3dMYWJlbHNDb2x1bW4gPyAkc2NvcGUubGFiZWxzV2lkdGggOiAwKSA+ICRzY29wZS5nYW50dC53aWR0aCArIHNjcm9sbEJhcldpZHRoKSB7CiAgICAgICAgICAgICAgICAgICAgY3NzLndpZHRoID0gJHNjb3BlLmdhbnR0LndpZHRoICsgc2Nyb2xsQmFyV2lkdGggKyAncHgnOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICgkc2NvcGUubWF4SGVpZ2h0ID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNzc1snbWF4LWhlaWdodCddID0gJHNjb3BlLm1heEhlaWdodCAtICRzY29wZS5nYW50dC5oZWFkZXIuZ2V0SGVpZ2h0KCkgKyAncHgnOwogICAgICAgICAgICAgICAgICAgIGNzc1snb3ZlcmZsb3cteSddID0gJ2F1dG8nOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjc3NbJ292ZXJmbG93LXknXSA9ICdoaWRkZW4nOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBjc3M7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UubmV3KCdnYW50dFNjcm9sbGFibGUnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5kZXN0cm95KCdnYW50dFNjcm9sbGFibGUnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0VmVydGljYWxTY3JvbGxSZWNlaXZlcicsIGZ1bmN0aW9uKCkgewogICAgLy8gVGhlIGVsZW1lbnQgd2l0aCB0aGlzIGF0dHJpYnV0ZSB3aWxsIHNjcm9sbCBhdCB0aGUgc2FtZSB0aW1lIGFzIHRoZSBzY3JvbGxTZW5kZXIgZWxlbWVudAoKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgICByZXF1aXJlOiAnXmdhbnR0U2Nyb2xsTWFuYWdlcicsCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICRzY29wZS5zY3JvbGxNYW5hZ2VyLnZlcnRpY2FsLnB1c2goJGVsZW1lbnRbMF0pOwogICAgICAgIH1dCiAgICB9Owp9KTsKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRFbGVtZW50V2lkdGhMaXN0ZW5lcicsIFtmdW5jdGlvbigpIHsKICAgIC8vIFVwZGF0ZXMgdGhlIGxpbWl0IGZpbHRlcnMgaWYgdGhlIHVzZXIgc2Nyb2xscyB0aGUgZ2FudHQgY2hhcnQKCiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCAnJGF0dHJzJywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzKSB7CiAgICAgICAgICAgIHZhciBzY29wZVZhcmlhYmxlID0gJGF0dHJzLmdhbnR0RWxlbWVudFdpZHRoTGlzdGVuZXI7CiAgICAgICAgICAgIGlmIChzY29wZVZhcmlhYmxlID09PSAnJykgewogICAgICAgICAgICAgICAgc2NvcGVWYXJpYWJsZSA9ICdnYW50dEVsZW1lbnRXaWR0aCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBlZmZlY3RpdmVTY29wZSA9ICRzY29wZTsKCiAgICAgICAgICAgIHdoaWxlKHNjb3BlVmFyaWFibGUuaW5kZXhPZignJHBhcmVudC4nKSA9PT0gMCkgewogICAgICAgICAgICAgICAgc2NvcGVWYXJpYWJsZSA9IHNjb3BlVmFyaWFibGUuc3Vic3RyaW5nKCckcGFyZW50LicubGVuZ3RoKTsKICAgICAgICAgICAgICAgIGVmZmVjdGl2ZVNjb3BlID0gJHNjb3BlLiRwYXJlbnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGVmZmVjdGl2ZVNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGVmZmVjdGl2ZVNjb3BlW3Njb3BlVmFyaWFibGVdID0gJGVsZW1lbnRbMF0ub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dEJvdW5kcycsIFtmdW5jdGlvbigpIHsKICAgIC8vIERpc3BsYXlzIGEgYm94IHJlcHJlc2VudGluZyB0aGUgZWFybGllc3QgYWxsb3dhYmxlIHN0YXJ0IHRpbWUgYW5kIGxhdGVzdCBjb21wbGV0aW9uIHRpbWUgZm9yIGEgam9iCgogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHRlbXBsYXRlVXJsOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgICAgICAgIGlmICh0QXR0cnMudGVtcGxhdGVVcmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICd0ZW1wbGF0ZS9kZWZhdWx0LmJvdW5kcy50bXBsLmh0bWwnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRBdHRycy50ZW1wbGF0ZVVybDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICBzY29wZToge3Rhc2s6ICc9bmdNb2RlbCd9LAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICB2YXIgY3NzID0ge307CgogICAgICAgICAgICAkc2NvcGUuJHdhdGNoR3JvdXAoWyd0YXNrLmVzdCcsICd0YXNrLmxjdCddLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICgkc2NvcGUudGFzay5lc3QgIT09IHVuZGVmaW5lZCAmJiAkc2NvcGUudGFzay5sY3QgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICRzY29wZS5ib3VuZHMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUuYm91bmRzLmxlZnQgPSAkc2NvcGUudGFzay5yb3dzTWFuYWdlci5nYW50dC5nZXRQb3NpdGlvbkJ5RGF0ZSgkc2NvcGUudGFzay5lc3QpOwogICAgICAgICAgICAgICAgICAgICRzY29wZS5ib3VuZHMud2lkdGggPSAkc2NvcGUudGFzay5yb3dzTWFuYWdlci5nYW50dC5nZXRQb3NpdGlvbkJ5RGF0ZSgkc2NvcGUudGFzay5sY3QpIC0gJHNjb3BlLmJvdW5kcy5sZWZ0OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUuYm91bmRzID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICRzY29wZS50YXNrLiRlbGVtZW50LmJpbmQoJ21vdXNlZW50ZXInLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmlzVGFza01vdXNlT3ZlciA9IHRydWU7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAkc2NvcGUudGFzay4kZWxlbWVudC5iaW5kKCdtb3VzZWxlYXZlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICRzY29wZS5pc1Rhc2tNb3VzZU92ZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICRzY29wZS5nZXRDc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICgkc2NvcGUuYm91bmRzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBjc3Mud2lkdGggPSAkc2NvcGUuYm91bmRzLndpZHRoICsgJ3B4JzsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCRzY29wZS50YXNrLmlzTWlsZXN0b25lID09PSB0cnVlIHx8ICRzY29wZS50YXNrLndpZHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNzcy5sZWZ0ID0gKCRzY29wZS5ib3VuZHMubGVmdCAtICgkc2NvcGUudGFzay5sZWZ0IC0gMC4zKSkgKyAncHgnOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNzcy5sZWZ0ID0gKCRzY29wZS5ib3VuZHMubGVmdCAtICRzY29wZS50YXNrLmxlZnQpICsgJ3B4JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGNzczsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICRzY29wZS5nZXRDbGFzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKCRzY29wZS50YXNrLmVzdCA9PT0gdW5kZWZpbmVkIHx8ICRzY29wZS50YXNrLmxjdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdnYW50dC10YXNrLWJvdW5kcy1pbic7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCRzY29wZS50YXNrLmVzdCA+ICRzY29wZS50YXNrLmZyb20pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ2dhbnR0LXRhc2stYm91bmRzLW91dCc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICgkc2NvcGUudGFzay5sY3QgPCAkc2NvcGUudGFzay50bykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAnZ2FudHQtdGFzay1ib3VuZHMtb3V0JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAnZ2FudHQtdGFzay1ib3VuZHMtaW4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJHNjb3BlLnRhc2sucm93c01hbmFnZXIuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UubmV3KCdnYW50dEJvdW5kcycsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLnRhc2sucm93c01hbmFnZXIuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UuZGVzdHJveSgnZ2FudHRCb3VuZHMnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0VGFza1Byb2dyZXNzJywgW2Z1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcXVpcmVzOiAnXmdhbnR0VGFzaycsCiAgICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgaWYgKHRBdHRycy50ZW1wbGF0ZVVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3RlbXBsYXRlL2RlZmF1bHQudGFza1Byb2dyZXNzLnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICAkc2NvcGUuZ2V0Q3NzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgY3NzID0ge307CgogICAgICAgICAgICAgICAgaWYgKCRzY29wZS50YXNrLnByb2dyZXNzLmNvbG9yKSB7CiAgICAgICAgICAgICAgICAgICAgY3NzWydiYWNrZ3JvdW5kLWNvbG9yJ10gPSAkc2NvcGUudGFzay5wcm9ncmVzcy5jb2xvcjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3NzWydiYWNrZ3JvdW5kLWNvbG9yJ10gPSAnIzZCQzQ0Myc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY3NzLndpZHRoID0gJHNjb3BlLnRhc2sucHJvZ3Jlc3MucGVyY2VudCArICclJzsKCiAgICAgICAgICAgICAgICByZXR1cm4gY3NzOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJHNjb3BlLnRhc2sucm93c01hbmFnZXIuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UubmV3KCdnYW50dFRhc2tQcm9ncmVzcycsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLnRhc2sucm93c01hbmFnZXIuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UuZGVzdHJveSgnZ2FudHRUYXNrUHJvZ3Jlc3MnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0VGFzaycsIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXF1aXJlOiAnXmdhbnR0Um93JywKICAgICAgICB0ZW1wbGF0ZVVybDogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICAgICAgICBpZiAodEF0dHJzLnRlbXBsYXRlVXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAndGVtcGxhdGUvZGVmYXVsdC50YXNrLnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICAkc2NvcGUudGFzay4kZWxlbWVudCA9ICRlbGVtZW50OwoKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLm5ldygnZ2FudHRUYXNrJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UuZGVzdHJveSgnZ2FudHRUYXNrJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dFRvb2x0aXAnLCBbJyR0aW1lb3V0JywgJyRkb2N1bWVudCcsICdnYW50dERlYm91bmNlJywgJ2dhbnR0U21hcnRFdmVudCcsIGZ1bmN0aW9uKCR0aW1lb3V0LCAkZG9jdW1lbnQsIGRlYm91bmNlLCBzbWFydEV2ZW50KSB7CiAgICAvLyBUaGlzIHRvb2x0aXAgZGlzcGxheXMgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBhIHRhc2sKCiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgaWYgKHRBdHRycy50ZW1wbGF0ZVVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3RlbXBsYXRlL2RlZmF1bHQudG9vbHRpcC50bXBsLmh0bWwnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRBdHRycy50ZW1wbGF0ZVVybDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIGJvZHlFbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KCRkb2N1bWVudFswXS5ib2R5KTsKICAgICAgICAgICAgdmFyIHBhcmVudEVsZW1lbnQgPSAkZWxlbWVudC5wYXJlbnQoKTsKICAgICAgICAgICAgdmFyIHNob3dUb29sdGlwUHJvbWlzZTsKICAgICAgICAgICAgdmFyIG1vdXNlUG9zaXRpb25YOwoKICAgICAgICAgICAgJHNjb3BlLmNzcyA9IHt9OwoKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnaXNUYXNrTW91c2VPdmVyJywgZnVuY3Rpb24obmV3VmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChzaG93VG9vbHRpcFByb21pc2UpIHsKICAgICAgICAgICAgICAgICAgICAkdGltZW91dC5jYW5jZWwoc2hvd1Rvb2x0aXBQcm9taXNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChuZXdWYWx1ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIHNob3dUb29sdGlwUHJvbWlzZSA9ICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzaG93VG9vbHRpcChtb3VzZVBvc2l0aW9uWCk7CiAgICAgICAgICAgICAgICAgICAgfSwgNTAwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEkc2NvcGUudGFzay5pc01vdmluZykgewogICAgICAgICAgICAgICAgICAgICAgICBoaWRlVG9vbHRpcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAkc2NvcGUudGFzay4kZWxlbWVudC5iaW5kKCdtb3VzZW1vdmUnLCBmdW5jdGlvbihldnQpIHsKICAgICAgICAgICAgICAgIG1vdXNlUG9zaXRpb25YID0gZXZ0LmNsaWVudFg7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgJHNjb3BlLnRhc2suJGVsZW1lbnQuYmluZCgnbW91c2VlbnRlcicsIGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgICAgICAgJHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUubW91c2VFbnRlclggPSBldnQuY2xpZW50WDsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUuaXNUYXNrTW91c2VPdmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICRzY29wZS50YXNrLiRlbGVtZW50LmJpbmQoJ21vdXNlbGVhdmUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLm1vdXNlRW50ZXJYID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICRzY29wZS5pc1Rhc2tNb3VzZU92ZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHZhciBtb3VzZU1vdmVIYW5kbGVyID0gc21hcnRFdmVudCgkc2NvcGUsIGJvZHlFbGVtZW50LCAnbW91c2Vtb3ZlJywgZGVib3VuY2UoZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgdXBkYXRlVG9vbHRpcChlLmNsaWVudFgpOwogICAgICAgICAgICB9LCA1LCBmYWxzZSkpOwoKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgndGFzay5pc01vdmluZycsIGZ1bmN0aW9uKG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAobmV3VmFsdWUgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBtb3VzZU1vdmVIYW5kbGVyLmJpbmQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmV3VmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgbW91c2VNb3ZlSGFuZGxlci51bmJpbmQoKTsKICAgICAgICAgICAgICAgICAgICBoaWRlVG9vbHRpcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHZhciBnZXRWaWV3UG9ydFdpZHRoID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgZCA9ICRkb2N1bWVudFswXTsKICAgICAgICAgICAgICAgIHJldHVybiBkLmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCB8fCBkLmRvY3VtZW50RWxlbWVudC5nZXRFbGVtZW50QnlJZCgnYm9keScpWzBdLmNsaWVudFdpZHRoOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIHNob3dUb29sdGlwID0gZnVuY3Rpb24oeCkgewogICAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlVG9vbHRpcCh4KTsKCiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmNzcy50b3AgPSBwYXJlbnRFbGVtZW50WzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCArICdweCc7CiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmNzcy5tYXJnaW5Ub3AgPSAtJGVsZW1lbnRbMF0ub2Zmc2V0SGVpZ2h0IC0gOCArICdweCc7CiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmNzcy5vcGFjaXR5ID0gMTsKICAgICAgICAgICAgICAgIH0sIDAsIHRydWUpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIHVwZGF0ZVRvb2x0aXAgPSBmdW5jdGlvbih4KSB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBpbmZvIGlzIG92ZXJsYXBwaW5nIHdpdGggdmlldyBwb3J0CiAgICAgICAgICAgICAgICBpZiAoeCArICRlbGVtZW50WzBdLm9mZnNldFdpZHRoID4gZ2V0Vmlld1BvcnRXaWR0aCgpKSB7CiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmNzcy5sZWZ0ID0gKHggKyAyMCAtICRlbGVtZW50WzBdLm9mZnNldFdpZHRoKSArICdweCc7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoJ2dhbnR0LXRhc2staW5mb0Fycm93UicpOyAvLyBSaWdodCBhbGlnbmVkIGluZm8KICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC5yZW1vdmVDbGFzcygnZ2FudHQtdGFzay1pbmZvQXJyb3cnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmNzcy5sZWZ0ID0gKHggLSAyMCkgKyAncHgnOwogICAgICAgICAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKCdnYW50dC10YXNrLWluZm9BcnJvdycpOwogICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnJlbW92ZUNsYXNzKCdnYW50dC10YXNrLWluZm9BcnJvd1InKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciBoaWRlVG9vbHRpcCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLmNzcy5vcGFjaXR5ID0gMDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0VG9vbHRpcCcsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLmRlc3Ryb3koJ2dhbnR0VG9vbHRpcCcsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfTsKfV0pOwoKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRCb2R5JywgW2Z1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcXVpcmU6ICdeZ2FudHQnLAogICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICB0ZW1wbGF0ZVVybDogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICAgICAgICBpZiAodEF0dHJzLnRlbXBsYXRlVXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAndGVtcGxhdGUvZGVmYXVsdC5ib2R5LnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmJvZHkuJGVsZW1lbnQgPSAkZWxlbWVudDsKCiAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0Qm9keScsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLmRlc3Ryb3koJ2dhbnR0Qm9keScsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfTsKfV0pOwoKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRCb2R5Q29sdW1ucycsIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXF1aXJlOiAnXmdhbnR0Qm9keScsCiAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHRlbXBsYXRlVXJsOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgICAgICAgIGlmICh0QXR0cnMudGVtcGxhdGVVcmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICd0ZW1wbGF0ZS9kZWZhdWx0LmJvZHlDb2x1bW5zLnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmJvZHkuY29sdW1ucy4kZWxlbWVudCA9ICRlbGVtZW50OwoKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLm5ldygnZ2FudHRCb2R5Q29sdW1ucycsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLmRlc3Ryb3koJ2dhbnR0Qm9keUNvbHVtbnMnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0Qm9keVJvd3MnLCBbZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVxdWlyZTogJ15nYW50dEJvZHknLAogICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICB0ZW1wbGF0ZVVybDogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICAgICAgICBpZiAodEF0dHJzLnRlbXBsYXRlVXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAndGVtcGxhdGUvZGVmYXVsdC5ib2R5Um93cy50bXBsLmh0bWwnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRBdHRycy50ZW1wbGF0ZVVybDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICRzY29wZS5nYW50dC5ib2R5LnJvd3MuJGVsZW1lbnQgPSAkZWxlbWVudDsKCiAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0Qm9keVJvd3MnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5kZXN0cm95KCdnYW50dEJvZHlSb3dzJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dENvbHVtbicsIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXF1aXJlOiAnXmdhbnR0Qm9keUNvbHVtbnMnLAogICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICB0ZW1wbGF0ZVVybDogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICAgICAgICBpZiAodEF0dHJzLnRlbXBsYXRlVXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAndGVtcGxhdGUvZGVmYXVsdC5jb2x1bW4udG1wbC5odG1sJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0QXR0cnMudGVtcGxhdGVVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICAkc2NvcGUuY29sdW1uLiRlbGVtZW50ID0gJGVsZW1lbnQ7CgogICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UubmV3KCdnYW50dENvbHVtbicsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLmRlc3Ryb3koJ2dhbnR0Q29sdW1uJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dENvbHVtbkhlYWRlcicsIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgaWYgKHRBdHRycy50ZW1wbGF0ZVVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3RlbXBsYXRlL2RlZmF1bHQuY29sdW1uSGVhZGVyLnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLm5ldygnZ2FudHRDb2x1bW5IZWFkZXInLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5kZXN0cm95KCdnYW50dENvbHVtbkhlYWRlcicsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfTsKfV0pOwoKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRIZWFkZXInLCBbZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVxdWlyZTogJ15nYW50dCcsCiAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHRlbXBsYXRlVXJsOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgICAgICAgIGlmICh0QXR0cnMudGVtcGxhdGVVcmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICd0ZW1wbGF0ZS9kZWZhdWx0LmhlYWRlci50bXBsLmh0bWwnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRBdHRycy50ZW1wbGF0ZVVybDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICRzY29wZS5nYW50dC5oZWFkZXIuJGVsZW1lbnQgPSAkZWxlbWVudDsKCiAgICAgICAgICAgICRzY29wZS5nZXRIZWFkZXJDc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBjc3MgPSB7fTsKCiAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLmdhbnR0RWxlbWVudFdpZHRoIC0gKCRzY29wZS5zaG93TGFiZWxzQ29sdW1uID8gJHNjb3BlLmxhYmVsc1dpZHRoIDogMCkgPiAkc2NvcGUuZ2FudHQud2lkdGgpIHsKICAgICAgICAgICAgICAgICAgICBjc3Mud2lkdGggPSAkc2NvcGUuZ2FudHQud2lkdGggKyAncHgnOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBjc3M7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UubmV3KCdnYW50dEhlYWRlcicsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLmRlc3Ryb3koJ2dhbnR0SGVhZGVyJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dEhlYWRlckNvbHVtbnMnLCBbZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVxdWlyZTogJ15nYW50dEhlYWRlcicsCiAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHRlbXBsYXRlVXJsOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgICAgICAgIGlmICh0QXR0cnMudGVtcGxhdGVVcmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICd0ZW1wbGF0ZS9kZWZhdWx0LmhlYWRlckNvbHVtbnMudG1wbC5odG1sJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0QXR0cnMudGVtcGxhdGVVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICAkc2NvcGUuZ2FudHQuaGVhZGVyLmNvbHVtbnMuJGVsZW1lbnQgPSAkZWxlbWVudDsKCiAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0SGVhZGVyQ29sdW1ucycsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLmRlc3Ryb3koJ2dhbnR0SGVhZGVyQ29sdW1ucycsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfTsKfV0pOwoKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRMYWJlbHMnLCBbZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVxdWlyZTogJ15nYW50dCcsCiAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHRlbXBsYXRlVXJsOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgICAgICAgIGlmICh0QXR0cnMudGVtcGxhdGVVcmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICd0ZW1wbGF0ZS9kZWZhdWx0LmxhYmVscy50bXBsLmh0bWwnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRBdHRycy50ZW1wbGF0ZVVybDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICRzY29wZS5nYW50dC5sYWJlbHMuJGVsZW1lbnQgPSAkZWxlbWVudDsKCiAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0TGFiZWxzJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UuZGVzdHJveSgnZ2FudHRMYWJlbHMnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0Um93JywgW2Z1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcXVpcmU6ICdeZ2FudHRCb2R5JywKICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgaWYgKHRBdHRycy50ZW1wbGF0ZVVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3RlbXBsYXRlL2RlZmF1bHQucm93LnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHNjb3BlLnJvdy4kZWxlbWVudCA9ICRlbGVtZW50OwoKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLm5ldygnZ2FudHRSb3cnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5kZXN0cm95KCdnYW50dFJvdycsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfTsKfV0pOwoKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRSb3dIZWFkZXInLCBbZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHRlbXBsYXRlVXJsOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgICAgICAgIGlmICh0QXR0cnMudGVtcGxhdGVVcmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICd0ZW1wbGF0ZS9kZWZhdWx0LnJvd0hlYWRlci50bXBsLmh0bWwnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRBdHRycy50ZW1wbGF0ZVVybDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICRzY29wZS5nYW50dC5yb3dIZWFkZXIuJGVsZW1lbnQgPSAkZWxlbWVudDsKCiAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0Um93SGVhZGVyJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UuZGVzdHJveSgnZ2FudHRSb3dIZWFkZXInLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0Um93TGFiZWwnLCBbZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHRlbXBsYXRlVXJsOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgICAgICAgIGlmICh0QXR0cnMudGVtcGxhdGVVcmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICd0ZW1wbGF0ZS9kZWZhdWx0LnJvd0xhYmVsLnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKCiAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0Um93TGFiZWwnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5kZXN0cm95KCdnYW50dFJvd0xhYmVsJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dFRpbWVGcmFtZScsIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXF1aXJlOiAnXmdhbnR0Q29sdW1uJywKICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgaWYgKHRBdHRycy50ZW1wbGF0ZVVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3RlbXBsYXRlL2RlZmF1bHQudGltZUZyYW1lLnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHNjb3BlLnRpbWVGcmFtZS4kZWxlbWVudCA9ICRlbGVtZW50OwoKICAgICAgICAgICAgJHNjb3BlLmdldENsYXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xhc3NlcyA9IFsnZ2FudHQtdGltZWZyYW1lJyArICgkc2NvcGUudGltZUZyYW1lLndvcmtpbmcgPyAnJyA6ICctbm9uJykgKyAnLXdvcmtpbmcnXTsKCiAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLnRpbWVGcmFtZS5jbGFzc2VzKSB7CiAgICAgICAgICAgICAgICAgICAgY2xhc3NlcyA9IGNsYXNzZXMuY29uY2F0KCRzY29wZS50aW1lRnJhbWUuY2xhc3Nlcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY2xhc3NlczsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0VGltZUZyYW1lJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UuZGVzdHJveSgnZ2FudHRUaW1lRnJhbWUnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgfSk7CgogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZmFjdG9yeSgnZ2FudHREZWJvdW5jZScsIFsnJHRpbWVvdXQnLCBmdW5jdGlvbigkdGltZW91dCkgewogICAgZnVuY3Rpb24gZGVib3VuY2UoZm4sIHRpbWVvdXQsIGludm9rZUFwcGx5KSB7CiAgICAgICAgdmFyIG50aENhbGwgPSAwOwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICB2YXIgYXJneiA9IGFyZ3VtZW50czsKICAgICAgICAgICAgbnRoQ2FsbCsrOwogICAgICAgICAgICB2YXIgbGF0ZXIgPSAoZnVuY3Rpb24odmVyc2lvbikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh2ZXJzaW9uID09PSBudGhDYWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbi5hcHBseShzZWxmLCBhcmd6KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KShudGhDYWxsKTsKICAgICAgICAgICAgcmV0dXJuICR0aW1lb3V0KGxhdGVyLCB0aW1lb3V0LCBpbnZva2VBcHBseSA9PT0gdW5kZWZpbmVkID8gdHJ1ZTogaW52b2tlQXBwbHkpOwogICAgICAgIH07CiAgICB9CgogICAgcmV0dXJuIGRlYm91bmNlOwp9XSk7CgpnYW50dC5zZXJ2aWNlKCdnYW50dEVuYWJsZU5nQW5pbWF0ZScsIFsnJGluamVjdG9yJywgZnVuY3Rpb24oJGluamVjdG9yKSB7CiAgICB2YXIgbmdBbmltYXRlOwogICAgdHJ5IHsKICAgICAgICBuZ0FuaW1hdGUgPSAkaW5qZWN0b3IuZ2V0KCckYW5pbWF0ZScpOwogICAgfSBjYXRjaCAoZSkgewogICAgfQoKICAgIGlmIChuZ0FuaW1hdGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbihlbmFibGVkLCBlbGVtZW50KSB7CiAgICAgICAgICAgIG5nQW5pbWF0ZS5lbmFibGVkKGZhbHNlLCBlbGVtZW50KTsKICAgICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7fTsKICAgIH0KCgp9XSk7CgoKZ2FudHQuc2VydmljZSgnZ2FudHRMYXlvdXQnLCBbJyRkb2N1bWVudCcsIGZ1bmN0aW9uKCRkb2N1bWVudCkgewogICAgcmV0dXJuIHsKICAgICAgICAvKioKICAgICAgICAgKiBDb21wdXRlIHRoZSB3aWR0aCBvZiBzY3JvbGxiYXIuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSB3aWR0aCBvZiB0aGUgc2Nyb2xsYmFyLCBpbiBweC4KICAgICAgICAgKi8KICAgICAgICBnZXRTY3JvbGxCYXJXaWR0aDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBpbm5lciA9ICRkb2N1bWVudFswXS5jcmVhdGVFbGVtZW50KCdwJyk7CiAgICAgICAgICAgIGlubmVyLnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgICAgICAgICBpbm5lci5zdHlsZS5oZWlnaHQgPSAnMjAwcHgnOwoKICAgICAgICAgICAgdmFyIG91dGVyID0gJGRvY3VtZW50WzBdLmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBvdXRlci5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIG91dGVyLnN0eWxlLnRvcCA9ICcwcHgnOwogICAgICAgICAgICBvdXRlci5zdHlsZS5sZWZ0ID0gJzBweCc7CiAgICAgICAgICAgIG91dGVyLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKICAgICAgICAgICAgb3V0ZXIuc3R5bGUud2lkdGggPSAnMjAwcHgnOwogICAgICAgICAgICBvdXRlci5zdHlsZS5oZWlnaHQgPSAnMTUwcHgnOwogICAgICAgICAgICBvdXRlci5zdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nOwogICAgICAgICAgICBvdXRlci5hcHBlbmRDaGlsZCAoaW5uZXIpOwoKICAgICAgICAgICAgJGRvY3VtZW50WzBdLmJvZHkuYXBwZW5kQ2hpbGQgKG91dGVyKTsKICAgICAgICAgICAgdmFyIHcxID0gaW5uZXIub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgIG91dGVyLnN0eWxlLm92ZXJmbG93ID0gJ3Njcm9sbCc7CiAgICAgICAgICAgIHZhciB3MiA9IGlubmVyLm9mZnNldFdpZHRoOwogICAgICAgICAgICBpZiAodzEgPT09IHcyKSB7CiAgICAgICAgICAgICAgICB3MiA9IG91dGVyLmNsaWVudFdpZHRoOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRkb2N1bWVudFswXS5ib2R5LnJlbW92ZUNoaWxkIChvdXRlcik7CgogICAgICAgICAgICByZXR1cm4gKHcxIC0gdzIpOwogICAgICAgIH0sCgogICAgICAgIHNldENvbHVtbnNXaWR0aDogZnVuY3Rpb24od2lkdGgsIG9yaWdpbmFsV2lkdGgsIGNvbHVtbnMpIHsKICAgICAgICAgICAgaWYgKHdpZHRoICYmIG9yaWdpbmFsV2lkdGggJiYgY29sdW1ucykgewoKICAgICAgICAgICAgICAgIHZhciB3aWR0aEZhY3RvciA9IE1hdGguYWJzKHdpZHRoIC8gb3JpZ2luYWxXaWR0aCk7CgogICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGNvbHVtbnMsIGZ1bmN0aW9uKGNvbHVtbikgewogICAgICAgICAgICAgICAgICAgIGNvbHVtbi5sZWZ0ID0gd2lkdGhGYWN0b3IgKiBjb2x1bW4ub3JpZ2luYWxTaXplLmxlZnQ7CiAgICAgICAgICAgICAgICAgICAgY29sdW1uLndpZHRoID0gd2lkdGhGYWN0b3IgKiBjb2x1bW4ub3JpZ2luYWxTaXplLndpZHRoOwoKICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goY29sdW1uLnRpbWVGcmFtZXMsIGZ1bmN0aW9uKHRpbWVGcmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUubGVmdCA9IHdpZHRoRmFjdG9yICogdGltZUZyYW1lLm9yaWdpbmFsU2l6ZS5sZWZ0OwogICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUud2lkdGggPSB3aWR0aEZhY3RvciAqIHRpbWVGcmFtZS5vcmlnaW5hbFNpemUud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn1dKTsKCgpnYW50dC5zZXJ2aWNlKCdnYW50dE1vdXNlQnV0dG9uJywgWyBmdW5jdGlvbigpIHsKICAgIC8vIE1vdXNlIGJ1dHRvbiBjcm9zcyBicm93c2VyIG5vcm1hbGl6YXRpb24KCiAgICByZXR1cm4gewogICAgICAgIGdldEJ1dHRvbjogZnVuY3Rpb24oZSkgewogICAgICAgICAgICBlID0gZSB8fCB3aW5kb3cuZXZlbnQ7CgogICAgICAgICAgICBpZiAoIWUud2hpY2gpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlLmJ1dHRvbiA8IDIgPyAxIDogZS5idXR0b24gPT09IDQgPyAyIDogMzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlLndoaWNoOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKfV0pOwoKZ2FudHQuc2VydmljZSgnZ2FudHRNb3VzZU9mZnNldCcsIFsgZnVuY3Rpb24oKSB7CiAgICAvLyBNb3VzZSBvZmZzZXQgc3VwcG9ydCBmb3IgbGVzc2VyIGJyb3dzZXJzIChyZWFkIElFIDgpCgogICAgcmV0dXJuIHsKICAgICAgICBnZXRPZmZzZXQ6IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgICBpZiAoZXZ0Lm9mZnNldFggJiYgZXZ0Lm9mZnNldFkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7IHg6IGV2dC5vZmZzZXRYLCB5OiBldnQub2Zmc2V0WSB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChldnQubGF5ZXJYICYmIGV2dC5sYXllclkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7IHg6IGV2dC5sYXllclgsIHk6IGV2dC5sYXllclkgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldE9mZnNldEZvckVsZW1lbnQoZXZ0LnRhcmdldCwgZXZ0KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZ2V0T2Zmc2V0Rm9yRWxlbWVudDogZnVuY3Rpb24oZWwsIGV2dCkgewogICAgICAgICAgICB2YXIgYmIgPSBlbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgICAgcmV0dXJuIHsgeDogZXZ0LmNsaWVudFggLSBiYi5sZWZ0LCB5OiBldnQuY2xpZW50WSAtIGJiLnRvcCB9OwogICAgICAgIH0KICAgIH07Cn1dKTsKCmdhbnR0LmZhY3RvcnkoJ2dhbnR0U21hcnRFdmVudCcsIFtmdW5jdGlvbigpIHsKICAgIC8vIEF1dG8gcmVsZWFzZWQgdGhlIGJpbmRpbmcgd2hlbiB0aGUgc2NvcGUgaXMgZGVzdHJveWVkLiBVc2UgaWYgYW4gZXZlbnQgaXMgcmVnaXN0ZXJlZCBvbiBhbm90aGVyIGVsZW1lbnQgdGhhbiB0aGUgc2NvcGUuCgogICAgZnVuY3Rpb24gc21hcnRFdmVudCgkc2NvcGUsICRlbGVtZW50LCBldmVudCwgZm4pIHsKICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkZWxlbWVudC51bmJpbmQoZXZlbnQsIGZuKTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgYmluZE9uY2U6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJGVsZW1lbnQub25lKGV2ZW50LCBmbik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJpbmQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJGVsZW1lbnQuYmluZChldmVudCwgZm4pOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bmJpbmQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJGVsZW1lbnQudW5iaW5kKGV2ZW50LCBmbik7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQoKICAgIHJldHVybiBzbWFydEV2ZW50Owp9XSk7CmFuZ3VsYXIubW9kdWxlKCdnYW50dFRlbXBsYXRlcycsIFtdKS5ydW4oWyckdGVtcGxhdGVDYWNoZScsIGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CiAgICAkdGVtcGxhdGVDYWNoZS5wdXQoJ3RlbXBsYXRlL2RlZmF1bHQuZ2FudHQudG1wbC5odG1sJywKICAgICAgICAnPGRpdiBjbGFzcz0iZ2FudHQgdW5zZWxlY3RhYmxlIiBuZy1jbG9hayBnYW50dC1zY3JvbGwtbWFuYWdlciBnYW50dC1lbGVtZW50LXdpZHRoLWxpc3RlbmVyPlxuJyArCiAgICAgICAgJyAgICA8Z2FudHQtbGFiZWxzPlxuJyArCiAgICAgICAgJyAgICAgICAgPGRpdiBjbGFzcz0iZ2FudHQtbGFiZWxzLWhlYWRlciI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPGdhbnR0LXJvdy1oZWFkZXI+PC9nYW50dC1yb3ctaGVhZGVyPlxuJyArCiAgICAgICAgJyAgICAgICAgPC9kaXY+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IGNsYXNzPSJnYW50dC1sYWJlbHMtYm9keSJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctc3R5bGU9IihtYXhIZWlnaHQgPiAwICYmIHtcJ21heC1oZWlnaHRcJzogKG1heEhlaWdodCAtIGdhbnR0LmhlYWRlci5nZXRIZWlnaHQoKSkrXCdweFwnfSB8fCB7fSkiXG4nICsKICAgICAgICAnICAgICAgICAgICAgIG5nLXNob3c9ImdhbnR0LmNvbHVtbnNNYW5hZ2VyLmNvbHVtbnMubGVuZ3RoID4gMCI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPGRpdiBnYW50dC12ZXJ0aWNhbC1zY3JvbGwtcmVjZWl2ZXIgc3R5bGU9InBvc2l0aW9uOiByZWxhdGl2ZSI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgIDxnYW50dC1yb3ctbGFiZWwgbmctcmVwZWF0PSJyb3cgaW4gZ2FudHQucm93c01hbmFnZXIudmlzaWJsZVJvd3MgdHJhY2sgYnkgJGluZGV4Ij5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJnYW50dC1sYWJlbHMtdGV4dCI+e3sgcm93Lm5hbWUgfX08L3NwYW4+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgIDwvZ2FudHQtcm93LWxhYmVsPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDwvZGl2PlxuJyArCiAgICAgICAgJyAgICAgICAgPC9kaXY+XG4nICsKICAgICAgICAnICAgIDwvZ2FudHQtbGFiZWxzPlxuJyArCiAgICAgICAgJyAgICA8Z2FudHQtaGVhZGVyPlxuJyArCiAgICAgICAgJyAgICAgICAgPGdhbnR0LWhlYWRlci1jb2x1bW5zPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDxkaXYgbmctcmVwZWF0PSJoZWFkZXIgaW4gZ2FudHQuY29sdW1uc01hbmFnZXIudmlzaWJsZUhlYWRlcnMiPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJnYW50dC1oZWFkZXItcm93IGdhbnR0LWhlYWRlci1yb3ctYm90dG9tIj5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgIDxnYW50dC1jb2x1bW4taGVhZGVyIG5nLXJlcGVhdD0iY29sdW1uIGluIGhlYWRlciB0cmFjayBieSAkaW5kZXgiPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgICAgIHt7IGNvbHVtbi5sYWJlbCB9fVxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgPC9nYW50dC1jb2x1bW4taGVhZGVyPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICA8L2Rpdj5cbicgKwogICAgICAgICcgICAgICAgICAgICA8L2Rpdj5cbicgKwogICAgICAgICcgICAgICAgIDwvZ2FudHQtaGVhZGVyLWNvbHVtbnM+XG4nICsKICAgICAgICAnICAgIDwvZ2FudHQtaGVhZGVyPlxuJyArCiAgICAgICAgJyAgICA8Z2FudHQtc2Nyb2xsYWJsZT5cbicgKwogICAgICAgICcgICAgICAgIDxnYW50dC1ib2R5PlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDxkaXYgY2xhc3M9ImdhbnR0LWJvZHktYmFja2dyb3VuZCI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImdhbnR0LXJvdy1oZWlnaHQiXG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgICAgICAgbmctY2xhc3Mtb2RkPSJcJ2dhbnR0LWJhY2tncm91bmQtcm93XCciXG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgICAgICAgbmctY2xhc3MtZXZlbj0iXCdnYW50dC1iYWNrZ3JvdW5kLXJvdy1hbHRcJyJcbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgICBuZy1jbGFzcz0icm93LmNsYXNzZXMiXG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgICAgICAgbmctc3R5bGU9IntcJ2JhY2tncm91bmQtY29sb3JcJzogcm93LmNvbG9yLCBcJ2hlaWdodFwnOiByb3cuaGVpZ2h0fSJcbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgICBuZy1yZXBlYXQ9InJvdyBpbiBnYW50dC5yb3dzTWFuYWdlci52aXNpYmxlUm93cyB0cmFjayBieSAkaW5kZXgiPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICA8L2Rpdj5cbicgKwogICAgICAgICcgICAgICAgICAgICA8L2Rpdj5cbicgKwogICAgICAgICcgICAgICAgICAgICA8ZGl2IGNsYXNzPSJnYW50dC1ib2R5LWZvcmVncm91bmQiPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJnYW50dC1jdXJyZW50LWRhdGUtbGluZSIgbmctaWY9ImN1cnJlbnREYXRlID09PSBcJ2xpbmVcJyAmJiBnYW50dC5jdXJyZW50RGF0ZU1hbmFnZXIucG9zaXRpb24gPj0gMCAmJiBnYW50dC5jdXJyZW50RGF0ZU1hbmFnZXIucG9zaXRpb24gPD0gZ2FudHQud2lkdGgiIG5nLXN0eWxlPSJ7XCdsZWZ0XCc6IGdhbnR0LmN1cnJlbnREYXRlTWFuYWdlci5wb3NpdGlvbiArIFwncHhcJyB9Ij48L2Rpdj5cbicgKwogICAgICAgICcgICAgICAgICAgICA8L2Rpdj5cbicgKwogICAgICAgICcgICAgICAgICAgICA8Z2FudHQtYm9keS1jb2x1bW5zIGNsYXNzPSJnYW50dC1ib2R5LWNvbHVtbnMiPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICA8Z2FudHQtY29sdW1uIG5nLXJlcGVhdD0iY29sdW1uIGluIGdhbnR0LmNvbHVtbnNNYW5hZ2VyLnZpc2libGVDb2x1bW5zIHRyYWNrIGJ5ICRpbmRleCI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgICAgICA8Z2FudHQtdGltZS1mcmFtZSBuZy1yZXBlYXQ9InRpbWVGcmFtZSBpbiBjb2x1bW4udmlzaWJsZVRpbWVGcmFtZXMiPjwvZ2FudHQtdGltZS1mcmFtZT5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgPC9nYW50dC1jb2x1bW4+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPC9nYW50dC1ib2R5LWNvbHVtbnM+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPGdhbnR0LWJvZHktcm93cz5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZ2FudHQtdGltZXNwYW4iXG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgICAgICAgbmctc3R5bGU9IntcJ2xlZnRcJzogKCh0aW1lc3Bhbi5sZWZ0LTAuMykgfHwgdGltZXNwYW4ubGVmdCkrXCdweFwnLCBcJ3dpZHRoXCc6IHRpbWVzcGFuLndpZHRoICtcJ3B4XCcsIFwnei1pbmRleFwnOiAodGltZXNwYW4ucHJpb3JpdHkgfHwgMCl9IlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgIG5nLWNsYXNzPSJ0aW1lc3Bhbi5jbGFzc2VzIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgIG5nLXJlcGVhdD0idGltZXNwYW4gaW4gZ2FudHQudGltZXNwYW5zTWFuYWdlci50aW1lc3BhbnMiPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgPGdhbnR0LXRvb2x0aXAgbmctbW9kZWw9InRpbWVzcGFuIiBkYXRlLWZvcm1hdD0iXCdNTU0gZFwnIj5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJnYW50dC10YXNrLWNvbnRlbnQiPjxzcGFuPnt7IHRpbWVzcGFuLm5hbWUgfX08L3NwYW4+PC9kaXY+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgICAgICA8L2dhbnR0LXRvb2x0aXA+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgIDwvZGl2PlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICA8Z2FudHQtcm93IG5nLXJlcGVhdD0icm93IGluIGdhbnR0LnJvd3NNYW5hZ2VyLnZpc2libGVSb3dzIHRyYWNrIGJ5ICRpbmRleCI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgICAgICA8Z2FudHQtdGFzayBuZy1yZXBlYXQ9InRhc2sgaW4gcm93LnZpc2libGVUYXNrcyB0cmFjayBieSB0YXNrLmlkIj48L2dhbnR0LXRhc2s+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgIDwvZ2FudHQtcm93PlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDwvZ2FudHQtYm9keS1yb3dzPlxuJyArCiAgICAgICAgJyAgICAgICAgPC9nYW50dC1ib2R5PlxuJyArCiAgICAgICAgJyAgICA8L2dhbnR0LXNjcm9sbGFibGU+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS0gUGx1Z2lucyAtLT5cbicgKwogICAgICAgICcgICAgPG5nLXRyYW5zY2x1ZGU+PC9uZy10cmFuc2NsdWRlPlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8IS0tXG4nICsKICAgICAgICAnICAgICoqKioqKiogSW5saW5lIHRlbXBsYXRlcyAqKioqKioqXG4nICsKICAgICAgICAnICAgIFlvdSBjYW4gc3BlY2lmeSB5b3VyIG93biB0ZW1wbGF0ZXMgYnkgZWl0aGVyIGNoYW5naW5nIHRoZSBkZWZhdWx0IG9uZXMgYmVsb3cgb3IgYnlcbicgKwogICAgICAgICcgICAgYWRkaW5nIGFuIGF0dHJpYnV0ZSB0ZW1wbGF0ZS11cmw9Ijx1cmwgdG8geW91ciB0ZW1wbGF0ZT4iIG9uIHRoZSBzcGVjaWZpYyBlbGVtZW50LlxuJyArCiAgICAgICAgJyAgICAtLT5cbicgKwogICAgICAgICdcbicgKwogICAgICAgICcgICAgPCEtLSBCb2R5IHRlbXBsYXRlIC0tPlxuJyArCiAgICAgICAgJyAgICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSJ0ZW1wbGF0ZS9kZWZhdWx0LmJvZHkudG1wbC5odG1sIj5cbicgKwogICAgICAgICcgICAgICAgIDxkaXYgbmctdHJhbnNjbHVkZSBjbGFzcz0iZ2FudHQtYm9keSJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctc3R5bGU9IntcJ3dpZHRoXCc6IGdhbnR0LndpZHRoICtcJ3B4XCd9Ij48L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS0gSGVhZGVyIHRlbXBsYXRlIC0tPlxuJyArCiAgICAgICAgJyAgICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSJ0ZW1wbGF0ZS9kZWZhdWx0LmhlYWRlci50bXBsLmh0bWwiPlxuJyArCiAgICAgICAgJyAgICAgICAgPGRpdiBuZy10cmFuc2NsdWRlIGNsYXNzPSJnYW50dC1oZWFkZXIiXG4nICsKICAgICAgICAnICAgICAgICAgICAgIG5nLXNob3c9ImdhbnR0LmNvbHVtbnNNYW5hZ2VyLmNvbHVtbnMubGVuZ3RoID4gMCAmJiBnYW50dC5jb2x1bW5zTWFuYWdlci5nZXRBY3RpdmVIZWFkZXJzQ291bnQoKSA+IDAiXG4nICsKICAgICAgICAnICAgICAgICAgICAgIG5nLXN0eWxlPSJnZXRIZWFkZXJDc3MoKSI+PC9kaXY+XG4nICsKICAgICAgICAnICAgIDwvc2NyaXB0PlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8IS0tIFJvdyBsYWJlbCB0ZW1wbGF0ZSAtLT5cbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC5yb3dMYWJlbC50bXBsLmh0bWwiPlxuJyArCiAgICAgICAgJyAgICAgICAgPGRpdiBuZy10cmFuc2NsdWRlIGNsYXNzPSJnYW50dC1sYWJlbHMtcm93IGdhbnR0LXJvdy1oZWlnaHQiXG4nICsKICAgICAgICAnICAgICAgICAgICAgIG5nLWNsYXNzLW9kZD0iXCdnYW50dC1iYWNrZ3JvdW5kLXJvd1wnIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBuZy1jbGFzcy1ldmVuPSJcJ2dhbnR0LWJhY2tncm91bmQtcm93LWFsdFwnIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBuZy1jbGFzcz0icm93LmNsYXNzZXMiIG5nLXN0eWxlPSJ7XCdiYWNrZ3JvdW5kLWNvbG9yXCc6IHJvdy5jb2xvciwgXCdoZWlnaHRcJzogcm93LmhlaWdodH0iPlxuJyArCiAgICAgICAgJyAgICAgICAgPC9kaXY+XG4nICsKICAgICAgICAnICAgIDwvc2NyaXB0PlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8IS0tIFJvdyBoZWFkZXIgdGVtcGxhdGUgLS0+XG4nICsKICAgICAgICAnICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlL2RlZmF1bHQucm93SGVhZGVyLnRtcGwuaHRtbCI+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IGNsYXNzPSJnYW50dC1sYWJlbHMtaGVhZGVyLXJvdyJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctc2hvdz0iZ2FudHQuY29sdW1uc01hbmFnZXIuY29sdW1ucy5sZW5ndGggPiAwICYmIGdhbnR0LmNvbHVtbnNNYW5hZ2VyLmdldEFjdGl2ZUhlYWRlcnNDb3VudCgpID4gMCJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctc3R5bGU9IntcJ21hcmdpbi10b3BcJzogKChnYW50dC5jb2x1bW5zTWFuYWdlci5nZXRBY3RpdmVIZWFkZXJzQ291bnQoKS0xKSoyKStcJ2VtXCd9Ij5cbicgKwogICAgICAgICcgICAgICAgICAgICA8c3Bhbj5OYW1lPC9zcGFuPlxuJyArCiAgICAgICAgJyAgICAgICAgPC9kaXY+XG4nICsKICAgICAgICAnICAgIDwvc2NyaXB0PlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8IS0tIExhYmVscyB0ZW1wbGF0ZSAtLT5cbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC5sYWJlbHMudG1wbC5odG1sIj5cbicgKwogICAgICAgICcgICAgICAgIDxkaXYgbmctdHJhbnNjbHVkZSBuZy1pZj0ic2hvd0xhYmVsc0NvbHVtbiIgY2xhc3M9ImdhbnR0LWxhYmVscyJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctc3R5bGU9IihsYWJlbHNXaWR0aCA+IDAgJiYge1wnd2lkdGhcJzogbGFiZWxzV2lkdGgrXCdweFwnfSB8fCB7fSkiXG4nICsKICAgICAgICAnICAgICAgICAgICAgIGdhbnR0LWxhYmVscy1yZXNpemU9IiRwYXJlbnQuYWxsb3dMYWJlbHNSZXNpemluZyJcbicgKwogICAgICAgICcgICAgICAgICAgICAgZ2FudHQtbGFiZWxzLXJlc2l6ZS13aWR0aD0iJHBhcmVudC5sYWJlbHNXaWR0aCJcbicgKwogICAgICAgICcgICAgICAgICAgICAgZ2FudHQtbGFiZWxzLXJlc2l6ZS1taW4td2lkdGg9IjUwIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBnYW50dC1lbGVtZW50LXdpZHRoLWxpc3RlbmVyPSIkcGFyZW50LmxhYmVsc1dpZHRoIj48L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS0gSGVhZGVyIGNvbHVtbnMgdGVtcGxhdGUgLS0+XG4nICsKICAgICAgICAnICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlL2RlZmF1bHQuaGVhZGVyQ29sdW1ucy50bXBsLmh0bWwiPlxuJyArCiAgICAgICAgJyAgICAgICAgPGRpdiBuZy10cmFuc2NsdWRlIGNsYXNzPSJnYW50dC1oZWFkZXItY29sdW1ucyJcbicgKwogICAgICAgICcgICAgICAgICAgICAgIGdhbnR0LWhvcml6b250YWwtc2Nyb2xsLXJlY2VpdmVyPjwvZGl2PlxuJyArCiAgICAgICAgJyAgICA8L3NjcmlwdD5cbicgKwogICAgICAgICdcbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC5jb2x1bW5IZWFkZXIudG1wbC5odG1sIj5cbicgKwogICAgICAgICcgICAgICAgIDxkaXYgbmctdHJhbnNjbHVkZSBjbGFzcz0iZ2FudHQtY29sdW1uLWhlYWRlciJcbicgKwogICAgICAgICcgICAgICAgICAgICAgIG5nLXN0eWxlPSJ7XCdsZWZ0XCc6IGNvbHVtbi5sZWZ0K1wncHhcJywgXCd3aWR0aFwnOiBjb2x1bW4ud2lkdGgrXCdweFwnfSI+PC9kaXY+XG4nICsKICAgICAgICAnICAgIDwvc2NyaXB0PlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8IS0tIEJvZHkgY29sdW1ucyB0ZW1wbGF0ZSAtLT5cbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC5ib2R5Q29sdW1ucy50bXBsLmh0bWwiPlxuJyArCiAgICAgICAgJyAgICAgICAgPGRpdiBuZy10cmFuc2NsdWRlIGNsYXNzPSJnYW50dC1ib2R5LWNvbHVtbnMiPjwvZGl2PlxuJyArCiAgICAgICAgJyAgICA8L3NjcmlwdD5cbicgKwogICAgICAgICdcbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC5jb2x1bW4udG1wbC5odG1sIj5cbicgKwogICAgICAgICcgICAgICAgIDxkaXYgbmctdHJhbnNjbHVkZSBjbGFzcz0iZ2FudHQtY29sdW1uIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBuZy1jbGFzcz0iKGNvbHVtbi5jdXJyZW50RGF0ZSAmJiBjdXJyZW50RGF0ZSA9PT0gXCdjb2x1bW5cJykgJiYgXCdnYW50dC1mb3JlZ3JvdW5kLWNvbC1jdXJyZW50LWRhdGVcJyB8fCBcJ2dhbnR0LWZvcmVncm91bmQtY29sXCciXG4nICsKICAgICAgICAnICAgICAgICAgICAgIG5nLXN0eWxlPSJ7XCdsZWZ0XCc6IGNvbHVtbi5sZWZ0K1wncHhcJywgXCd3aWR0aFwnOiBjb2x1bW4ud2lkdGgrXCdweFwnfSI+PC9kaXY+XG4nICsKICAgICAgICAnICAgIDwvc2NyaXB0PlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSJ0ZW1wbGF0ZS9kZWZhdWx0LnRpbWVGcmFtZS50bXBsLmh0bWwiPlxuJyArCiAgICAgICAgJyAgICAgICAgPGRpdiBjbGFzcz0iZ2FudHQtdGltZWZyYW1lIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBuZy1jbGFzcz0iZ2V0Q2xhc3MoKSJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctc3R5bGU9IntcJ2xlZnRcJzogdGltZUZyYW1lLmxlZnQgKyBcJ3B4XCcsIFwnd2lkdGhcJzogdGltZUZyYW1lLndpZHRoICsgXCdweFwnLCBcJ2JhY2tncm91bmQtY29sb3JcJzogdGltZUZyYW1lLmNvbG9yICYmIHRpbWVGcmFtZS5jb2xvciB8fCBcJ1wnfSI+PC9kaXY+XG4nICsKICAgICAgICAnICAgIDwvc2NyaXB0PlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8IS0tIFNjcm9sbGFibGUgdGVtcGxhdGUgLS0+XG4nICsKICAgICAgICAnICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlL2RlZmF1bHQuc2Nyb2xsYWJsZS50bXBsLmh0bWwiPlxuJyArCiAgICAgICAgJyAgICAgICAgPGRpdiBuZy10cmFuc2NsdWRlIGNsYXNzPSJnYW50dC1zY3JvbGxhYmxlIiBnYW50dC1zY3JvbGwtc2VuZGVyIGdhbnR0LWxpbWl0LXVwZGF0ZXJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctc3R5bGU9ImdldFNjcm9sbGFibGVDc3MoKSI+PC9kaXY+XG4nICsKICAgICAgICAnICAgIDwvc2NyaXB0PlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8IS0tIFJvd3MgdGVtcGxhdGUgLS0+XG4nICsKICAgICAgICAnICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlL2RlZmF1bHQuYm9keVJvd3MudG1wbC5odG1sIj5cbicgKwogICAgICAgICcgICAgICAgIDxkaXYgbmctdHJhbnNjbHVkZSBjbGFzcz0iZ2FudHQtYm9keS1yb3dzIj48L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS0gVGFzayB0ZW1wbGF0ZSAtLT5cbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC50YXNrLnRtcGwuaHRtbCI+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IG5nLWNsYXNzPSIodGFzay5pc01pbGVzdG9uZSA9PT0gdHJ1ZSAmJiBbXCdnYW50dC10YXNrLW1pbGVzdG9uZVwnXSB8fCBbXCdnYW50dC10YXNrXCddKS5jb25jYXQodGFzay5jbGFzc2VzKSJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctc3R5bGU9IntcJ2xlZnRcJzogKCh0YXNrLmlzTWlsZXN0b25lID09PSB0cnVlIHx8IHRhc2sud2lkdGggPT09IDApICYmICh0YXNrLmxlZnQtMC4zKSB8fCB0YXNrLmxlZnQpK1wncHhcJywgXCd3aWR0aFwnOiB0YXNrLndpZHRoICtcJ3B4XCcsIFwnei1pbmRleFwnOiAodGFzay5pc01vdmluZyA9PT0gdHJ1ZSAmJiAxICB8fCB0YXNrLnByaW9yaXR5IHx8IFwnXCcpLCBcJ2JhY2tncm91bmQtY29sb3JcJzogdGFzay5jb2xvcn0iPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDxnYW50dC1ib3VuZHMgbmctbW9kZWw9InRhc2siPjwvZ2FudHQtYm91bmRzPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDxnYW50dC10b29sdGlwIG5nLW1vZGVsPSJ0YXNrIj48L2dhbnR0LXRvb2x0aXA+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPGRpdiBuZy1pZj0idGFzay50cnVuY2F0ZWRMZWZ0IiBjbGFzcz0iZ2FudHQtdGFzay10cnVuY2F0ZWQtbGVmdCI+PHNwYW4+Jmx0Ozwvc3Bhbj48L2Rpdj5cbicgKwogICAgICAgICcgICAgICAgICAgICA8ZGl2IGNsYXNzPSJnYW50dC10YXNrLWNvbnRlbnQiPjxzcGFuPnt7ICh0YXNrLmlzTWlsZXN0b25lID09PSB0cnVlICYmIFwnJm5ic3A7XCcgfHwgdGFzay5uYW1lKSB9fTwvc3Bhbj48L2Rpdj5cbicgKwogICAgICAgICcgICAgICAgICAgICA8ZGl2IG5nLWlmPSJ0YXNrLnRydW5jYXRlZFJpZ2h0IiBjbGFzcz0iZ2FudHQtdGFzay10cnVuY2F0ZWQtcmlnaHQiPjxzcGFuPiZndDs8L3NwYW4+PC9kaXY+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPGdhbnR0LXRhc2stcHJvZ3Jlc3MgbmctaWY9InRhc2sucHJvZ3Jlc3MgIT09IHVuZGVmaW5lZCI+PC9nYW50dC10YXNrLXByb2dyZXNzPlxuJyArCiAgICAgICAgJyAgICAgICAgPC9kaXY+XG4nICsKICAgICAgICAnICAgIDwvc2NyaXB0PlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8IS0tIFRvb2x0aXAgdGVtcGxhdGUgLS0+XG4nICsKICAgICAgICAnICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlL2RlZmF1bHQudG9vbHRpcC50bXBsLmh0bWwiPlxuJyArCiAgICAgICAgJyAgICAgICAgPGRpdiBuZy1zaG93PSJzaG93VG9vbHRpcHMiIGNsYXNzPSJnYW50dC10YXNrLWluZm8iIG5nLXN0eWxlPSJjc3MiPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDxkaXYgY2xhc3M9ImdhbnR0LXRhc2staW5mby1jb250ZW50Ij5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAge3sgdGFzay5uYW1lIH19PC9icj5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgPHNtYWxsPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICAgICAge3tcbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgIHRhc2suaXNNaWxlc3RvbmUgPT09IHRydWUgJiYgKHRhc2suZ2V0RnJvbUxhYmVsKCkpIHx8ICh0YXNrLmdldEZyb21MYWJlbCgpICsgXCcgLSBcJyArIHRhc2suZ2V0VG9MYWJlbCgpKTtcbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgIH19XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgIDwvc21hbGw+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPC9kaXY+XG4nICsKICAgICAgICAnICAgICAgICA8L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS0gVGFzayBib3VuZHMgdGVtcGxhdGUgLS0+XG4nICsKICAgICAgICAnICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlL2RlZmF1bHQuYm91bmRzLnRtcGwuaHRtbCI+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IG5nLXNob3c9ImJvdW5kcyAmJiBpc1Rhc2tNb3VzZU92ZXIiIGNsYXNzPSJnYW50dC10YXNrLWJvdW5kcyJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctc3R5bGU9ImdldENzcygpIiBuZy1jbGFzcz0iZ2V0Q2xhc3MoKSI+PC9kaXY+XG4nICsKICAgICAgICAnICAgIDwvc2NyaXB0PlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8IS0tIFRhc2sgcHJvZ3Jlc3MgdGVtcGxhdGUgLS0+XG4nICsKICAgICAgICAnICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlL2RlZmF1bHQudGFza1Byb2dyZXNzLnRtcGwuaHRtbCI+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IGNsYXNzPVwnZ2FudHQtdGFzay1wcm9ncmVzc1wnIG5nLXN0eWxlPSJnZXRDc3MoKSIgbmctY2xhc3M9InByb2dyZXNzLmNsYXNzZXMiPjwvZGl2PlxuJyArCiAgICAgICAgJyAgICA8L3NjcmlwdD5cbicgKwogICAgICAgICdcbicgKwogICAgICAgICcgICAgPCEtLSBSb3cgdGVtcGxhdGUgLS0+XG4nICsKICAgICAgICAnICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlL2RlZmF1bHQucm93LnRtcGwuaHRtbCI+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IG5nLXRyYW5zY2x1ZGUgY2xhc3M9ImdhbnR0LXJvdyBnYW50dC1yb3ctaGVpZ2h0IiBuZy1zdHlsZT0ie1wnaGVpZ2h0XCc6IHJvdy5oZWlnaHR9Ij48L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnPC9kaXY+XG4nICsKICAgICAgICAnJyk7Cn1dKTsKCi8vIyBzb3VyY2VNYXBwaW5nVVJMPWFuZ3VsYXItZ2FudHQuanMubWFwCi8qClByb2plY3Q6IGFuZ3VsYXItZ2FudHQgZm9yIEFuZ3VsYXJKUwpBdXRob3I6IE1hcmNvIFNjaHdlaWdoYXVzZXIKQ29udHJpYnV0b3JzOiBSw6ltaSBBbHZlcmduYXQKTGljZW5zZTogTUlULgpHaXRodWI6IGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyLWdhbnR0L2FuZ3VsYXItZ2FudHQKKi8KJ3VzZSBzdHJpY3QnOwoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dE1vdmFibGUnLCBbJ2dhbnR0TW91c2VCdXR0b24nLCAnZ2FudHRNb3VzZU9mZnNldCcsICdnYW50dERlYm91bmNlJywgJ2dhbnR0U21hcnRFdmVudCcsICdnYW50dE1vdmFibGVPcHRpb25zJywgJyR3aW5kb3cnLCAnJGRvY3VtZW50JywgJyR0aW1lb3V0JywKICAgIGZ1bmN0aW9uKG1vdXNlQnV0dG9uLCBtb3VzZU9mZnNldCwgZGVib3VuY2UsIHNtYXJ0RXZlbnQsIG1vdmFibGVPcHRpb25zLCAkd2luZG93LCAkZG9jdW1lbnQsICR0aW1lb3V0KSB7CiAgICAgICAgLy8gUHJvdmlkZXMgbW92aW5nIGFuZCByZXNpemluZyBvZiB0YXNrcwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgIHJlcXVpcmU6ICdeZ2FudHQnLAogICAgICAgICAgICBzY29wZTogewogICAgICAgICAgICAgICAgYWxsb3dNb3Zpbmc6ICc9PycsCiAgICAgICAgICAgICAgICBhbGxvd1Jlc2l6aW5nOiAnPT8nLAogICAgICAgICAgICAgICAgYWxsb3dSb3dTd2l0Y2hpbmc6ICc9PycKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBnYW50dEN0cmwpIHsKICAgICAgICAgICAgICAgIHZhciBhcGkgPSBnYW50dEN0cmwuZ2FudHQuYXBpOwoKICAgICAgICAgICAgICAgIGFwaS5yZWdpc3RlckV2ZW50KCd0YXNrcycsICdtb3ZlJyk7CiAgICAgICAgICAgICAgICBhcGkucmVnaXN0ZXJFdmVudCgndGFza3MnLCAnbW92ZUJlZ2luJyk7CiAgICAgICAgICAgICAgICBhcGkucmVnaXN0ZXJFdmVudCgndGFza3MnLCAnbW92ZUVuZCcpOwogICAgICAgICAgICAgICAgYXBpLnJlZ2lzdGVyRXZlbnQoJ3Rhc2tzJywgJ3Jlc2l6ZScpOwogICAgICAgICAgICAgICAgYXBpLnJlZ2lzdGVyRXZlbnQoJ3Rhc2tzJywgJ3Jlc2l6ZUJlZ2luJyk7CiAgICAgICAgICAgICAgICBhcGkucmVnaXN0ZXJFdmVudCgndGFza3MnLCAncmVzaXplRW5kJyk7CgogICAgICAgICAgICAgICAgaWYgKHNjb3BlLm9wdGlvbnMgJiYgdHlwZW9mKHNjb3BlLm9wdGlvbnMubW92YWJsZSkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgb3B0aW9uIGluIHNjb3BlLm9wdGlvbnMubW92YWJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZVtvcHRpb25dID0gc2NvcGUub3B0aW9uc1tvcHRpb25dOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBtb3ZhYmxlT3B0aW9ucy5pbml0aWFsaXplKHNjb3BlKTsKCiAgICAgICAgICAgICAgICBhcGkuZGlyZWN0aXZlcy5vbi5uZXcoc2NvcGUsIGZ1bmN0aW9uKGRpcmVjdGl2ZU5hbWUsIHRhc2tTY29wZSwgdGFza0VsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlTmFtZSA9PT0gJ2dhbnR0VGFzaycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc2l6ZUFyZWFXaWR0aEJpZyA9IDU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNpemVBcmVhV2lkdGhTbWFsbCA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzY3JvbGxTcGVlZCA9IDE1OwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsVHJpZ2dlckRpc3RhbmNlID0gNTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3aW5kb3dFbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KCR3aW5kb3cpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ2FudHRSb3dFbGVtZW50ID0gdGFza1Njb3BlLnJvdy4kZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdhbnR0Qm9keUVsZW1lbnQgPSB0YXNrU2NvcGUucm93LnJvd3NNYW5hZ2VyLmdhbnR0LmJvZHkuJGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBnYW50dFNjcm9sbEVsZW1lbnQgPSB0YXNrU2NvcGUucm93LnJvd3NNYW5hZ2VyLmdhbnR0LnNjcm9sbC4kZWxlbWVudDsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YXNrSGFzQmVlbkNoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vdXNlT2Zmc2V0SW5FbTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vdmVTdGFydFg7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzY3JvbGxJbnRlcnZhbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tFbGVtZW50LmJpbmQoJ21vdXNlZG93bicsIGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kZSA9IGdldE1vdmVNb2RlKGV2dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGUgIT09ICcnICYmIG1vdXNlQnV0dG9uLmdldEJ1dHRvbihldnQpID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvZmZzZXRYID0gbW91c2VPZmZzZXQuZ2V0T2Zmc2V0Rm9yRWxlbWVudChnYW50dEJvZHlFbGVtZW50WzBdLCBldnQpLng7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuYWJsZU1vdmVNb2RlKG1vZGUsIG9mZnNldFgsIGV2dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgdGFza0VsZW1lbnQuYmluZCgnbW91c2Vtb3ZlJywgZGVib3VuY2UoZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZGUgPSBnZXRNb3ZlTW9kZShlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2RlICE9PSAnJyAmJiAodGFza1Njb3BlLnRhc2suaXNNb3ZpbmcgfHwgbW9kZSAhPT0gJ00nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tFbGVtZW50LmNzcygnY3Vyc29yJywgZ2V0Q3Vyc29yKG1vZGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza0VsZW1lbnQuY3NzKCdjdXJzb3InLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDUpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVNb3ZlID0gZnVuY3Rpb24obW9kZSwgZXZ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFza1Njb3BlLnRhc2suaXNNb3ZpbmcgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmVUYXNrKG1vZGUsIGV2dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxTY3JlZW4obW9kZSwgZXZ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb3ZlVGFzayA9IGZ1bmN0aW9uKG1vZGUsIGV2dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vdXNlUG9zID0gbW91c2VPZmZzZXQuZ2V0T2Zmc2V0Rm9yRWxlbWVudChnYW50dEJvZHlFbGVtZW50WzBdLCBldnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnRhc2subW91c2VPZmZzZXRYID0gbW91c2VQb3MueDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB4ID0gbW91c2VQb3MueDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2RlID09PSAnTScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NvcGUuYWxsb3dSb3dTd2l0Y2hpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldFJvdyA9IGdldFJvd0J5WShtb3VzZVBvcy55KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldFJvdyAhPT0gdW5kZWZpbmVkICYmIHRhc2tTY29wZS50YXNrLnJvdy5pZCAhPT0gdGFyZ2V0Um93LmlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRSb3cubW92ZVRhc2tUb1Jvdyh0YXNrU2NvcGUudGFzayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzY29wZS5hbGxvd01vdmluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ID0geCAtIG1vdXNlT2Zmc2V0SW5FbTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhc2tTY29wZS50YXNrT3V0T2ZSYW5nZSAhPT0gJ3RydW5jYXRlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHggPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHggKyB0YXNrU2NvcGUudGFzay53aWR0aCA+PSB0YXNrU2NvcGUuZ2FudHQud2lkdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ID0gdGFza1Njb3BlLmdhbnR0LndpZHRoIC0gdGFza1Njb3BlLnRhc2sud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnRhc2subW92ZVRvKHgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUucm93LnJvd3NNYW5hZ2VyLmdhbnR0LmFwaS50YXNrcy5yYWlzZS5tb3ZlKHRhc2tTY29wZS50YXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICdFJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXNrU2NvcGUudGFza091dE9mUmFuZ2UgIT09ICd0cnVuY2F0ZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHggPCB0YXNrU2NvcGUudGFzay5sZWZ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ID0gdGFza1Njb3BlLnRhc2subGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh4ID4gdGFza1Njb3BlLmdhbnR0LndpZHRoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ID0gdGFza1Njb3BlLmdhbnR0LndpZHRoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tTY29wZS50YXNrLnNldFRvKHgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tTY29wZS5yb3cucm93c01hbmFnZXIuZ2FudHQuYXBpLnRhc2tzLnJhaXNlLnJlc2l6ZSh0YXNrU2NvcGUudGFzayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXNrU2NvcGUudGFza091dE9mUmFuZ2UgIT09ICd0cnVuY2F0ZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHggPiB0YXNrU2NvcGUudGFzay5sZWZ0ICsgdGFza1Njb3BlLnRhc2sud2lkdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggPSB0YXNrU2NvcGUudGFzay5sZWZ0ICsgdGFza1Njb3BlLnRhc2sud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoeCA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tTY29wZS50YXNrLnNldEZyb20oeCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnJvdy5yb3dzTWFuYWdlci5nYW50dC5hcGkudGFza3MucmFpc2UucmVzaXplKHRhc2tTY29wZS50YXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrSGFzQmVlbkNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjcm9sbFNjcmVlbiA9IGZ1bmN0aW9uKG1vZGUsIGV2dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vdXNlUG9zID0gbW91c2VPZmZzZXQuZ2V0T2Zmc2V0Rm9yRWxlbWVudChnYW50dEJvZHlFbGVtZW50WzBdLCBldnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxlZnRTY3JlZW5Cb3JkZXIgPSBnYW50dFNjcm9sbEVsZW1lbnRbMF0uc2Nyb2xsTGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBrZWVwT25TY3JvbGxpbmcgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobW91c2VQb3MueCA8IG1vdmVTdGFydFgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGwgdG8gdGhlIGxlZnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobW91c2VQb3MueCA8PSBsZWZ0U2NyZWVuQm9yZGVyICsgc2Nyb2xsVHJpZ2dlckRpc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdXNlUG9zLnggLT0gc2Nyb2xsU3BlZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtlZXBPblNjcm9sbGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tTY29wZS5yb3cucm93c01hbmFnZXIuZ2FudHQuYXBpLnNjcm9sbC5sZWZ0KHNjcm9sbFNwZWVkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNjcm9sbCB0byB0aGUgcmlnaHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2NyZWVuV2lkdGggPSBnYW50dFNjcm9sbEVsZW1lbnRbMF0ub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJpZ2h0U2NyZWVuQm9yZGVyID0gbGVmdFNjcmVlbkJvcmRlciArIHNjcmVlbldpZHRoOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobW91c2VQb3MueCA+PSByaWdodFNjcmVlbkJvcmRlciAtIHNjcm9sbFRyaWdnZXJEaXN0YW5jZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3VzZVBvcy54ICs9IHNjcm9sbFNwZWVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZWVwT25TY3JvbGxpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUucm93LnJvd3NNYW5hZ2VyLmdhbnR0LmFwaS5zY3JvbGwucmlnaHQoc2Nyb2xsU3BlZWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2VlcE9uU2Nyb2xsaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsSW50ZXJ2YWwgPSAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlTW92ZShtb2RlLCBldnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDEwMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2xlYXJTY3JvbGxJbnRlcnZhbCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjcm9sbEludGVydmFsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGltZW91dC5jYW5jZWwoc2Nyb2xsSW50ZXJ2YWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbEludGVydmFsID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdldFJvd0J5WSA9IGZ1bmN0aW9uKHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh5ID49IGdhbnR0Um93RWxlbWVudFswXS5vZmZzZXRUb3AgJiYgeSA8PSBnYW50dFJvd0VsZW1lbnRbMF0ub2Zmc2V0VG9wICsgZ2FudHRSb3dFbGVtZW50WzBdLm9mZnNldEhlaWdodCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXNrU2NvcGUudGFzay5yb3c7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2aXNpYmxlUm93cyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0YXNrU2NvcGUudGFzay5yb3cucm93c01hbmFnZXIucm93cywgZnVuY3Rpb24ocm93KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcm93LmhpZGRlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlzaWJsZVJvd3MucHVzaChyb3cpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvd0hlaWdodCA9IGdhbnR0Qm9keUVsZW1lbnRbMF0ub2Zmc2V0SGVpZ2h0IC8gdmlzaWJsZVJvd3MubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwb3MgPSBNYXRoLmZsb29yKHkgLyByb3dIZWlnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2aXNpYmxlUm93c1twb3NdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdldE1vdmVNb2RlID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHggPSBtb3VzZU9mZnNldC5nZXRPZmZzZXQoZSkueDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlzdGFuY2UgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlZmluZSByZXNpemUmbW92ZSBhcmVhLiBNYWtlIHN1cmUgdGhlIG1vdmUgYXJlYSBkb2VzIG5vdCBnZXQgdG9vIHNtYWxsLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjb3BlLmFsbG93UmVzaXppbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXN0YW5jZSA9IHRhc2tFbGVtZW50WzBdLm9mZnNldFdpZHRoIDwgMTAgPyByZXNpemVBcmVhV2lkdGhTbWFsbCA6IHJlc2l6ZUFyZWFXaWR0aEJpZzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NvcGUuYWxsb3dSZXNpemluZyAmJiB4ID4gdGFza0VsZW1lbnRbMF0ub2Zmc2V0V2lkdGggLSBkaXN0YW5jZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnRSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNjb3BlLmFsbG93UmVzaXppbmcgJiYgeCA8IGRpc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdXJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKHNjb3BlLmFsbG93TW92aW5nIHx8IHNjb3BlLmFsbG93Um93U3dpdGNoaW5nKSAmJiB4ID49IGRpc3RhbmNlICYmIHggPD0gdGFza0VsZW1lbnRbMF0ub2Zmc2V0V2lkdGggLSBkaXN0YW5jZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnTSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBnZXRDdXJzb3IgPSBmdW5jdGlvbihtb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdFJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdlLXJlc2l6ZSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnVyc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAndy1yZXNpemUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ00nOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ21vdmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVuYWJsZU1vdmVNb2RlID0gZnVuY3Rpb24obW9kZSwgeCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmFpc2UgdGFzayBtb3ZlIHN0YXJ0IGV2ZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRhc2tTY29wZS50YXNrLmlzTW92aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdNJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUucm93LnJvd3NNYW5hZ2VyLmdhbnR0LmFwaS50YXNrcy5yYWlzZS5tb3ZlQmVnaW4odGFza1Njb3BlLnRhc2spOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tTY29wZS5yb3cucm93c01hbmFnZXIuZ2FudHQuYXBpLnRhc2tzLnJhaXNlLnJlc2l6ZUJlZ2luKHRhc2tTY29wZS50YXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5pdCB0YXNrIG1vdmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tIYXNCZWVuQ2hhbmdlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnRhc2subW92ZU1vZGUgPSBtb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnRhc2suaXNNb3ZpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZVN0YXJ0WCA9IHg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3VzZU9mZnNldEluRW0gPSB4IC0gdGFza1Njb3BlLnRhc2subW9kZWxMZWZ0OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFkZCBtb3ZlIGV2ZW50IGhhbmRsZXJzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFza01vdmVIYW5kbGVyID0gZGVib3VuY2UoZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhc2tTY29wZS50YXNrLmlzTW92aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFzIHRoaXMgZnVuY3Rpb24gaXMgZGVmZXJlZCwgZGlzYWJsZU1vdmVNb2RlIG1heSBoYXZlIGJlZW4gY2FsbGVkIGJlZm9yZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2l0aG91dCB0aGlzIGNoZWNrLCB0YXNrLmNoYW5nZWQgZXZlbnQgaXMgbm90IGZpcmVkIGZvciBmYXN0ZXIgbW92ZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNlZSBnaXRodWIgaXNzdWUgIzE5MAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclNjcm9sbEludGVydmFsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZU1vdmUobW9kZSwgZXZ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCA1KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNtYXJ0RXZlbnQodGFza1Njb3BlLCB3aW5kb3dFbGVtZW50LCAnbW91c2Vtb3ZlJywgdGFza01vdmVIYW5kbGVyKS5iaW5kKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc21hcnRFdmVudCh0YXNrU2NvcGUsIHdpbmRvd0VsZW1lbnQsICdtb3VzZXVwJywgZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93RWxlbWVudC51bmJpbmQoJ21vdXNlbW92ZScsIHRhc2tNb3ZlSGFuZGxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVNb3ZlTW9kZShldnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkuYmluZE9uY2UoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTaG93IG1vdXNlIG1vdmUvcmVzaXplIGN1cnNvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza0VsZW1lbnQuY3NzKCdjdXJzb3InLCBnZXRDdXJzb3IobW9kZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5lbGVtZW50KCRkb2N1bWVudFswXS5ib2R5KS5jc3MoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICctbW96LXVzZXItc2VsZWN0JzogJy1tb3otbm9uZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJy13ZWJraXQtdXNlci1zZWxlY3QnOiAnbm9uZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJy1tcy11c2VyLXNlbGVjdCc6ICdub25lJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAndXNlci1zZWxlY3QnOiAnbm9uZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2N1cnNvcic6IGdldEN1cnNvcihtb2RlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlzYWJsZU1vdmVNb2RlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUudGFzay5pc01vdmluZyA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgYW55IGFjdGl2ZSBhdXRvIHNjcm9sbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJTY3JvbGxJbnRlcnZhbCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCBtb3VzZSBjdXJzb3IgYmFjayB0byBkZWZhdWx0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrRWxlbWVudC5jc3MoJ2N1cnNvcicsICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudCgkZG9jdW1lbnRbMF0uYm9keSkuY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLW1vei11c2VyLXNlbGVjdCc6ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICctd2Via2l0LXVzZXItc2VsZWN0JzogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJy1tcy11c2VyLXNlbGVjdCc6ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd1c2VyLXNlbGVjdCc6ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjdXJzb3InOiAnJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmFpc2UgbW92ZSBlbmQgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXNrU2NvcGUudGFzay5tb3ZlTW9kZSA9PT0gJ00nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnJvdy5yb3dzTWFuYWdlci5nYW50dC5hcGkudGFza3MucmFpc2UubW92ZUVuZCh0YXNrU2NvcGUudGFzayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tTY29wZS5yb3cucm93c01hbmFnZXIuZ2FudHQuYXBpLnRhc2tzLnJhaXNlLnJlc2l6ZUVuZCh0YXNrU2NvcGUudGFzayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnRhc2subW92ZU1vZGUgPSB1bmRlZmluZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmFpc2UgdGFzayBjaGFuZ2VkIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFza0hhc0JlZW5DaGFuZ2VkID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza0hhc0JlZW5DaGFuZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnRhc2sucm93LnNvcnRUYXNrcygpOyAvLyBTb3J0IHRhc2tzIHNvIHRoZXkgaGF2ZSB0aGUgcmlnaHQgei1vcmRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tTY29wZS5yb3cucm93c01hbmFnZXIuZ2FudHQuYXBpLnRhc2tzLnJhaXNlLmNoYW5nZSh0YXNrU2NvcGUudGFzayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFza1Njb3BlLnRhc2suaXNDcmVhdGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRhc2tTY29wZS50YXNrLmlzQ3JlYXRpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmFibGVNb3ZlTW9kZSgnRScsIHRhc2tTY29wZS50YXNrLm1vdXNlT2Zmc2V0WCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFza1Njb3BlLnRhc2suaXNNb3ZpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluIGNhc2UgdGhlIHRhc2sgaGFzIGJlZW4gbW92ZWQgdG8gYW5vdGhlciByb3cgYSBuZXcgY29udHJvbGxlciBpcyBpcyBjcmVhdGVkIGJ5IGFuZ3VsYXIuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBFbmFibGUgdGhlIG1vdmUgbW9kZSBhZ2FpbiBpZiB0aGlzIHdhcyB0aGUgY2FzZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuYWJsZU1vdmVNb2RlKCdNJywgdGFza1Njb3BlLnRhc2subW91c2VPZmZzZXRYKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ2dhbnR0TW92YWJsZU9wdGlvbnMnLCBbZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCiAgICAgICAgICAgIG9wdGlvbnMuYWxsb3dNb3ZpbmcgPSBvcHRpb25zLmFsbG93TW92aW5nICE9PSB1bmRlZmluZWQgPyAhIW9wdGlvbnMuYWxsb3dNb3ZpbmcgOiB0cnVlOwogICAgICAgICAgICBvcHRpb25zLmFsbG93UmVzaXppbmcgPSBvcHRpb25zLmFsbG93UmVzaXppbmcgIT09IHVuZGVmaW5lZCA/ICEhb3B0aW9ucy5hbGxvd1Jlc2l6aW5nIDogdHJ1ZTsKICAgICAgICAgICAgb3B0aW9ucy5hbGxvd1Jvd1N3aXRjaGluZyA9IG9wdGlvbnMuYWxsb3dSb3dTd2l0Y2hpbmcgIT09IHVuZGVmaW5lZCA/ICEhb3B0aW9ucy5hbGxvd1Jvd1N3aXRjaGluZyA6IHRydWU7CgogICAgICAgICAgICByZXR1cm4gb3B0aW9uczsKICAgICAgICB9CiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dFNvcnRhYmxlJywgWyckZG9jdW1lbnQnLCBmdW5jdGlvbigkZG9jdW1lbnQpIHsKICAgIC8vIFByb3ZpZGVzIHRoZSByb3cgc29ydCBmdW5jdGlvbmFsaXR5IHRvIGFueSBHYW50dCByb3cKICAgIC8vIFVzZXMgdGhlIHNvcnRhYmxlU3RhdGUgdG8gc2hhcmUgdGhlIGN1cnJlbnQgcm93CgogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcXVpcmU6ICdeZ2FudHQnLAogICAgICAgIHNjb3BlOiB7CiAgICAgICAgICAgIGVuYWJsZWQ6ICc9PycKICAgICAgICB9LAogICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycywgZ2FudHRDdHJsKSB7CiAgICAgICAgICAgIHZhciBhcGkgPSBnYW50dEN0cmwuZ2FudHQuYXBpOwoKICAgICAgICAgICAgaWYgKHNjb3BlLmVuYWJsZWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgc2NvcGUuZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGFwaS5kaXJlY3RpdmVzLm9uLm5ldyhzY29wZSwgZnVuY3Rpb24oZGlyZWN0aXZlTmFtZSwgcm93U2NvcGUsIHJvd0VsZW1lbnQpIHsKICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmVOYW1lID09PSAnZ2FudHRSb3dMYWJlbCcpIHsKICAgICAgICAgICAgICAgICAgICByb3dFbGVtZW50LmJpbmQoJ21vdXNlZG93bicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNjb3BlLmVuYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgZW5hYmxlRHJhZ01vZGUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXNhYmxlSGFuZGxlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcm93U2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudCgkZG9jdW1lbnRbMF0uYm9keSkudW5iaW5kKCdtb3VzZXVwJywgZGlzYWJsZUhhbmRsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVEcmFnTW9kZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudCgkZG9jdW1lbnRbMF0uYm9keSkuYmluZCgnbW91c2V1cCcsIGRpc2FibGVIYW5kbGVyKTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgcm93RWxlbWVudC5iaW5kKCdtb3VzZW1vdmUnLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0luRHJhZ01vZGUoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVsZW1lbnRCZWxvd01vdXNlID0gJGRvY3VtZW50WzBdLmVsZW1lbnRGcm9tUG9pbnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudEJlbG93TW91c2UgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudEJlbG93TW91c2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldFJvdyA9IGVsZW1lbnRCZWxvd01vdXNlLnNjb3BlKCkucm93OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXRSb3cuaWQgIT09IHNjb3BlLnN0YXJ0Um93LmlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm93U2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm93U2NvcGUucm93LnJvd3NNYW5hZ2VyLnN3YXBSb3dzKHRhcmdldFJvdywgc2NvcGUuc3RhcnRSb3cpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIHZhciBpc0luRHJhZ01vZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLnN0YXJ0Um93ICE9PSB1bmRlZmluZWQgJiYgIWFuZ3VsYXIuZXF1YWxzKHJvd1Njb3BlLnJvdywgc2NvcGUuc3RhcnRSb3cpOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIHZhciBlbmFibGVEcmFnTW9kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5zdGFydFJvdyA9IHJvd1Njb3BlLnJvdzsKICAgICAgICAgICAgICAgICAgICAgICAgcm93RWxlbWVudC5jc3MoJ2N1cnNvcicsICdtb3ZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudCgkZG9jdW1lbnRbMF0uYm9keSkuY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICctbW96LXVzZXItc2VsZWN0JzogJy1tb3otbm9uZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLXdlYmtpdC11c2VyLXNlbGVjdCc6ICdub25lJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICctbXMtdXNlci1zZWxlY3QnOiAnbm9uZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndXNlci1zZWxlY3QnOiAnbm9uZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY3Vyc29yJzogJ25vLWRyb3AnCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIHZhciBkaXNhYmxlRHJhZ01vZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuc3RhcnRSb3cgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvd0VsZW1lbnQuY3NzKCdjdXJzb3InLCAncG9pbnRlcicpOwogICAgICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoJGRvY3VtZW50WzBdLmJvZHkpLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLW1vei11c2VyLXNlbGVjdCc6ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJy13ZWJraXQtdXNlci1zZWxlY3QnOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICctbXMtdXNlci1zZWxlY3QnOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICd1c2VyLXNlbGVjdCc6ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2N1cnNvcic6ICdhdXRvJwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgfQogICAgfTsKfV0pOwoKLy8jIHNvdXJjZU1hcHBpbmdVUkw9YW5ndWxhci1nYW50dC1wbHVnaW5zLmpzLm1hcA==",
                "body": "LyoqCiAqIEBsaWNlbnNlIEFuZ3VsYXJKUyB2MS4zLjAKICogKGMpIDIwMTAtMjAxNCBHb29nbGUsIEluYy4gaHR0cDovL2FuZ3VsYXJqcy5vcmcKICogTGljZW5zZTogTUlUCiAqLwooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkKSB7J3VzZSBzdHJpY3QnOwoKLyoqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBUaGlzIG9iamVjdCBwcm92aWRlcyBhIHV0aWxpdHkgZm9yIHByb2R1Y2luZyByaWNoIEVycm9yIG1lc3NhZ2VzIHdpdGhpbgogKiBBbmd1bGFyLiBJdCBjYW4gYmUgY2FsbGVkIGFzIGZvbGxvd3M6CiAqCiAqIHZhciBleGFtcGxlTWluRXJyID0gbWluRXJyKCdleGFtcGxlJyk7CiAqIHRocm93IGV4YW1wbGVNaW5FcnIoJ29uZScsICdUaGlzIHswfSBpcyB7MX0nLCBmb28sIGJhcik7CiAqCiAqIFRoZSBhYm92ZSBjcmVhdGVzIGFuIGluc3RhbmNlIG9mIG1pbkVyciBpbiB0aGUgZXhhbXBsZSBuYW1lc3BhY2UuIFRoZQogKiByZXN1bHRpbmcgZXJyb3Igd2lsbCBoYXZlIGEgbmFtZXNwYWNlZCBlcnJvciBjb2RlIG9mIGV4YW1wbGUub25lLiAgVGhlCiAqIHJlc3VsdGluZyBlcnJvciB3aWxsIHJlcGxhY2UgezB9IHdpdGggdGhlIHZhbHVlIG9mIGZvbywgYW5kIHsxfSB3aXRoIHRoZQogKiB2YWx1ZSBvZiBiYXIuIFRoZSBvYmplY3QgaXMgbm90IHJlc3RyaWN0ZWQgaW4gdGhlIG51bWJlciBvZiBhcmd1bWVudHMgaXQgY2FuCiAqIHRha2UuCiAqCiAqIElmIGZld2VyIGFyZ3VtZW50cyBhcmUgc3BlY2lmaWVkIHRoYW4gbmVjZXNzYXJ5IGZvciBpbnRlcnBvbGF0aW9uLCB0aGUgZXh0cmEKICogaW50ZXJwb2xhdGlvbiBtYXJrZXJzIHdpbGwgYmUgcHJlc2VydmVkIGluIHRoZSBmaW5hbCBzdHJpbmcuCiAqCiAqIFNpbmNlIGRhdGEgd2lsbCBiZSBwYXJzZWQgc3RhdGljYWxseSBkdXJpbmcgYSBidWlsZCBzdGVwLCBzb21lIHJlc3RyaWN0aW9ucwogKiBhcmUgYXBwbGllZCB3aXRoIHJlc3BlY3QgdG8gaG93IG1pbkVyciBpbnN0YW5jZXMgYXJlIGNyZWF0ZWQgYW5kIGNhbGxlZC4KICogSW5zdGFuY2VzIHNob3VsZCBoYXZlIG5hbWVzIG9mIHRoZSBmb3JtIG5hbWVzcGFjZU1pbkVyciBmb3IgYSBtaW5FcnIgY3JlYXRlZAogKiB1c2luZyBtaW5FcnIoJ25hbWVzcGFjZScpIC4gRXJyb3IgY29kZXMsIG5hbWVzcGFjZXMgYW5kIHRlbXBsYXRlIHN0cmluZ3MKICogc2hvdWxkIGFsbCBiZSBzdGF0aWMgc3RyaW5ncywgbm90IHZhcmlhYmxlcyBvciBnZW5lcmFsIGV4cHJlc3Npb25zLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlIFRoZSBuYW1lc3BhY2UgdG8gdXNlIGZvciB0aGUgbmV3IG1pbkVyciBpbnN0YW5jZS4KICogQHBhcmFtIHtmdW5jdGlvbn0gRXJyb3JDb25zdHJ1Y3RvciBDdXN0b20gZXJyb3IgY29uc3RydWN0b3IgdG8gYmUgaW5zdGFudGlhdGVkIHdoZW4gcmV0dXJuaW5nCiAqICAgZXJyb3IgZnJvbSByZXR1cm5lZCBmdW5jdGlvbiwgZm9yIGNhc2VzIHdoZW4gYSBwYXJ0aWN1bGFyIHR5cGUgb2YgZXJyb3IgaXMgdXNlZnVsLgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29kZTpzdHJpbmcsIHRlbXBsYXRlOnN0cmluZywgLi4udGVtcGxhdGVBcmdzKTogRXJyb3J9IG1pbkVyciBpbnN0YW5jZQogKi8KCmZ1bmN0aW9uIG1pbkVycihtb2R1bGUsIEVycm9yQ29uc3RydWN0b3IpIHsKICBFcnJvckNvbnN0cnVjdG9yID0gRXJyb3JDb25zdHJ1Y3RvciB8fCBFcnJvcjsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvZGUgPSBhcmd1bWVudHNbMF0sCiAgICAgIHByZWZpeCA9ICdbJyArIChtb2R1bGUgPyBtb2R1bGUgKyAnOicgOiAnJykgKyBjb2RlICsgJ10gJywKICAgICAgdGVtcGxhdGUgPSBhcmd1bWVudHNbMV0sCiAgICAgIHRlbXBsYXRlQXJncyA9IGFyZ3VtZW50cywKICAgICAgc3RyaW5naWZ5ID0gZnVuY3Rpb24gKG9iaikgewogICAgICAgIGlmICh0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICByZXR1cm4gb2JqLnRvU3RyaW5nKCkucmVwbGFjZSgvIFx7W1xzXFNdKiQvLCAnJyk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgcmV0dXJuICd1bmRlZmluZWQnOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iaiAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmopOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb2JqOwogICAgICB9LAogICAgICBtZXNzYWdlLCBpOwoKICAgIG1lc3NhZ2UgPSBwcmVmaXggKyB0ZW1wbGF0ZS5yZXBsYWNlKC9ce1xkK1x9L2csIGZ1bmN0aW9uIChtYXRjaCkgewogICAgICB2YXIgaW5kZXggPSArbWF0Y2guc2xpY2UoMSwgLTEpLCBhcmc7CgogICAgICBpZiAoaW5kZXggKyAyIDwgdGVtcGxhdGVBcmdzLmxlbmd0aCkgewogICAgICAgIGFyZyA9IHRlbXBsYXRlQXJnc1tpbmRleCArIDJdOwogICAgICAgIGlmICh0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICByZXR1cm4gYXJnLnRvU3RyaW5nKCkucmVwbGFjZSgvID9ce1tcc1xTXSokLywgJycpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHJldHVybiAndW5kZWZpbmVkJzsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmcgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICByZXR1cm4gdG9Kc29uKGFyZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhcmc7CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoOwogICAgfSk7CgogICAgbWVzc2FnZSA9IG1lc3NhZ2UgKyAnXG5odHRwOi8vZXJyb3JzLmFuZ3VsYXJqcy5vcmcvMS4zLjAvJyArCiAgICAgIChtb2R1bGUgPyBtb2R1bGUgKyAnLycgOiAnJykgKyBjb2RlOwogICAgZm9yIChpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICBtZXNzYWdlID0gbWVzc2FnZSArIChpID09IDIgPyAnPycgOiAnJicpICsgJ3AnICsgKGktMikgKyAnPScgKwogICAgICAgIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnkoYXJndW1lbnRzW2ldKSk7CiAgICB9CiAgICByZXR1cm4gbmV3IEVycm9yQ29uc3RydWN0b3IobWVzc2FnZSk7CiAgfTsKfQoKLyogV2UgbmVlZCB0byB0ZWxsIGpzaGludCB3aGF0IHZhcmlhYmxlcyBhcmUgYmVpbmcgZXhwb3J0ZWQgKi8KLyogZ2xvYmFsIGFuZ3VsYXI6IHRydWUsCiAgbXNpZTogdHJ1ZSwKICBqcUxpdGU6IHRydWUsCiAgalF1ZXJ5OiB0cnVlLAogIHNsaWNlOiB0cnVlLAogIHNwbGljZTogdHJ1ZSwKICBwdXNoOiB0cnVlLAogIHRvU3RyaW5nOiB0cnVlLAogIG5nTWluRXJyOiB0cnVlLAogIGFuZ3VsYXJNb2R1bGU6IHRydWUsCiAgdWlkOiB0cnVlLAogIFJFR0VYX1NUUklOR19SRUdFWFA6IHRydWUsCiAgVkFMSURJVFlfU1RBVEVfUFJPUEVSVFk6IHRydWUsCgogIGxvd2VyY2FzZTogdHJ1ZSwKICB1cHBlcmNhc2U6IHRydWUsCiAgbWFudWFsTG93ZXJjYXNlOiB0cnVlLAogIG1hbnVhbFVwcGVyY2FzZTogdHJ1ZSwKICBub2RlTmFtZV86IHRydWUsCiAgaXNBcnJheUxpa2U6IHRydWUsCiAgZm9yRWFjaDogdHJ1ZSwKICBzb3J0ZWRLZXlzOiB0cnVlLAogIGZvckVhY2hTb3J0ZWQ6IHRydWUsCiAgcmV2ZXJzZVBhcmFtczogdHJ1ZSwKICBuZXh0VWlkOiB0cnVlLAogIHNldEhhc2hLZXk6IHRydWUsCiAgZXh0ZW5kOiB0cnVlLAogIGludDogdHJ1ZSwKICBpbmhlcml0OiB0cnVlLAogIG5vb3A6IHRydWUsCiAgaWRlbnRpdHk6IHRydWUsCiAgdmFsdWVGbjogdHJ1ZSwKICBpc1VuZGVmaW5lZDogdHJ1ZSwKICBpc0RlZmluZWQ6IHRydWUsCiAgaXNPYmplY3Q6IHRydWUsCiAgaXNTdHJpbmc6IHRydWUsCiAgaXNOdW1iZXI6IHRydWUsCiAgaXNEYXRlOiB0cnVlLAogIGlzQXJyYXk6IHRydWUsCiAgaXNGdW5jdGlvbjogdHJ1ZSwKICBpc1JlZ0V4cDogdHJ1ZSwKICBpc1dpbmRvdzogdHJ1ZSwKICBpc1Njb3BlOiB0cnVlLAogIGlzRmlsZTogdHJ1ZSwKICBpc0Jsb2I6IHRydWUsCiAgaXNCb29sZWFuOiB0cnVlLAogIGlzUHJvbWlzZUxpa2U6IHRydWUsCiAgdHJpbTogdHJ1ZSwKICBpc0VsZW1lbnQ6IHRydWUsCiAgbWFrZU1hcDogdHJ1ZSwKICBzaXplOiB0cnVlLAogIGluY2x1ZGVzOiB0cnVlLAogIGFycmF5UmVtb3ZlOiB0cnVlLAogIGlzTGVhZk5vZGU6IHRydWUsCiAgY29weTogdHJ1ZSwKICBzaGFsbG93Q29weTogdHJ1ZSwKICBlcXVhbHM6IHRydWUsCiAgY3NwOiB0cnVlLAogIGNvbmNhdDogdHJ1ZSwKICBzbGljZUFyZ3M6IHRydWUsCiAgYmluZDogdHJ1ZSwKICB0b0pzb25SZXBsYWNlcjogdHJ1ZSwKICB0b0pzb246IHRydWUsCiAgZnJvbUpzb246IHRydWUsCiAgc3RhcnRpbmdUYWc6IHRydWUsCiAgdHJ5RGVjb2RlVVJJQ29tcG9uZW50OiB0cnVlLAogIHBhcnNlS2V5VmFsdWU6IHRydWUsCiAgdG9LZXlWYWx1ZTogdHJ1ZSwKICBlbmNvZGVVcmlTZWdtZW50OiB0cnVlLAogIGVuY29kZVVyaVF1ZXJ5OiB0cnVlLAogIGFuZ3VsYXJJbml0OiB0cnVlLAogIGJvb3RzdHJhcDogdHJ1ZSwKICBnZXRUZXN0YWJpbGl0eTogdHJ1ZSwKICBzbmFrZV9jYXNlOiB0cnVlLAogIGJpbmRKUXVlcnk6IHRydWUsCiAgYXNzZXJ0QXJnOiB0cnVlLAogIGFzc2VydEFyZ0ZuOiB0cnVlLAogIGFzc2VydE5vdEhhc093blByb3BlcnR5OiB0cnVlLAogIGdldHRlcjogdHJ1ZSwKICBnZXRCbG9ja05vZGVzOiB0cnVlLAogIGhhc093blByb3BlcnR5OiB0cnVlLAogIGNyZWF0ZU1hcDogdHJ1ZSwKCiAgTk9ERV9UWVBFX0VMRU1FTlQ6IHRydWUsCiAgTk9ERV9UWVBFX1RFWFQ6IHRydWUsCiAgTk9ERV9UWVBFX0NPTU1FTlQ6IHRydWUsCiAgTk9ERV9UWVBFX0RPQ1VNRU5UOiB0cnVlLAogIE5PREVfVFlQRV9ET0NVTUVOVF9GUkFHTUVOVDogdHJ1ZSwKKi8KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKLyoqCiAqIEBuZ2RvYyBtb2R1bGUKICogQG5hbWUgbmcKICogQG1vZHVsZSBuZwogKiBAZGVzY3JpcHRpb24KICoKICogIyBuZyAoY29yZSBtb2R1bGUpCiAqIFRoZSBuZyBtb2R1bGUgaXMgbG9hZGVkIGJ5IGRlZmF1bHQgd2hlbiBhbiBBbmd1bGFySlMgYXBwbGljYXRpb24gaXMgc3RhcnRlZC4gVGhlIG1vZHVsZSBpdHNlbGYKICogY29udGFpbnMgdGhlIGVzc2VudGlhbCBjb21wb25lbnRzIGZvciBhbiBBbmd1bGFySlMgYXBwbGljYXRpb24gdG8gZnVuY3Rpb24uIFRoZSB0YWJsZSBiZWxvdwogKiBsaXN0cyBhIGhpZ2ggbGV2ZWwgYnJlYWtkb3duIG9mIGVhY2ggb2YgdGhlIHNlcnZpY2VzL2ZhY3RvcmllcywgZmlsdGVycywgZGlyZWN0aXZlcyBhbmQgdGVzdGluZwogKiBjb21wb25lbnRzIGF2YWlsYWJsZSB3aXRoaW4gdGhpcyBjb3JlIG1vZHVsZS4KICoKICogPGRpdiBkb2MtbW9kdWxlLWNvbXBvbmVudHM9Im5nIj48L2Rpdj4KICovCgp2YXIgUkVHRVhfU1RSSU5HX1JFR0VYUCA9IC9eXC8oLispXC8oW2Etel0qKSQvOwoKLy8gVGhlIG5hbWUgb2YgYSBmb3JtIGNvbnRyb2wncyBWYWxpZGl0eVN0YXRlIHByb3BlcnR5LgovLyBUaGlzIGlzIHVzZWQgc28gdGhhdCBpdCdzIHBvc3NpYmxlIGZvciBpbnRlcm5hbCB0ZXN0cyB0byBjcmVhdGUgbW9jayBWYWxpZGl0eVN0YXRlcy4KdmFyIFZBTElESVRZX1NUQVRFX1BST1BFUlRZID0gJ3ZhbGlkaXR5JzsKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5sb3dlcmNhc2UKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24gQ29udmVydHMgdGhlIHNwZWNpZmllZCBzdHJpbmcgdG8gbG93ZXJjYXNlLgogKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFN0cmluZyB0byBiZSBjb252ZXJ0ZWQgdG8gbG93ZXJjYXNlLgogKiBAcmV0dXJucyB7c3RyaW5nfSBMb3dlcmNhc2VkIHN0cmluZy4KICovCnZhciBsb3dlcmNhc2UgPSBmdW5jdGlvbihzdHJpbmcpe3JldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvTG93ZXJDYXNlKCkgOiBzdHJpbmc7fTsKdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci51cHBlcmNhc2UKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24gQ29udmVydHMgdGhlIHNwZWNpZmllZCBzdHJpbmcgdG8gdXBwZXJjYXNlLgogKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFN0cmluZyB0byBiZSBjb252ZXJ0ZWQgdG8gdXBwZXJjYXNlLgogKiBAcmV0dXJucyB7c3RyaW5nfSBVcHBlcmNhc2VkIHN0cmluZy4KICovCnZhciB1cHBlcmNhc2UgPSBmdW5jdGlvbihzdHJpbmcpe3JldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvVXBwZXJDYXNlKCkgOiBzdHJpbmc7fTsKCgp2YXIgbWFudWFsTG93ZXJjYXNlID0gZnVuY3Rpb24ocykgewogIC8qIGpzaGludCBiaXR3aXNlOiBmYWxzZSAqLwogIHJldHVybiBpc1N0cmluZyhzKQogICAgICA/IHMucmVwbGFjZSgvW0EtWl0vZywgZnVuY3Rpb24oY2gpIHtyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShjaC5jaGFyQ29kZUF0KDApIHwgMzIpO30pCiAgICAgIDogczsKfTsKdmFyIG1hbnVhbFVwcGVyY2FzZSA9IGZ1bmN0aW9uKHMpIHsKICAvKiBqc2hpbnQgYml0d2lzZTogZmFsc2UgKi8KICByZXR1cm4gaXNTdHJpbmcocykKICAgICAgPyBzLnJlcGxhY2UoL1thLXpdL2csIGZ1bmN0aW9uKGNoKSB7cmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoY2guY2hhckNvZGVBdCgwKSAmIH4zMik7fSkKICAgICAgOiBzOwp9OwoKCi8vIFN0cmluZyN0b0xvd2VyQ2FzZSBhbmQgU3RyaW5nI3RvVXBwZXJDYXNlIGRvbid0IHByb2R1Y2UgY29ycmVjdCByZXN1bHRzIGluIGJyb3dzZXJzIHdpdGggVHVya2lzaAovLyBsb2NhbGUsIGZvciB0aGlzIHJlYXNvbiB3ZSBuZWVkIHRvIGRldGVjdCB0aGlzIGNhc2UgYW5kIHJlZGVmaW5lIGxvd2VyY2FzZS91cHBlcmNhc2UgbWV0aG9kcwovLyB3aXRoIGNvcnJlY3QgYnV0IHNsb3dlciBhbHRlcm5hdGl2ZXMuCmlmICgnaScgIT09ICdJJy50b0xvd2VyQ2FzZSgpKSB7CiAgbG93ZXJjYXNlID0gbWFudWFsTG93ZXJjYXNlOwogIHVwcGVyY2FzZSA9IG1hbnVhbFVwcGVyY2FzZTsKfQoKCnZhciAvKiogaG9sZHMgbWFqb3IgdmVyc2lvbiBudW1iZXIgZm9yIElFIG9yIE5hTiBmb3IgcmVhbCBicm93c2VycyAqLwogICAgbXNpZSwKICAgIGpxTGl0ZSwgICAgICAgICAgIC8vIGRlbGF5IGJpbmRpbmcgc2luY2UgalF1ZXJ5IGNvdWxkIGJlIGxvYWRlZCBhZnRlciB1cy4KICAgIGpRdWVyeSwgICAgICAgICAgIC8vIGRlbGF5IGJpbmRpbmcKICAgIHNsaWNlICAgICAgICAgICAgID0gW10uc2xpY2UsCiAgICBzcGxpY2UgICAgICAgICAgICA9IFtdLnNwbGljZSwKICAgIHB1c2ggICAgICAgICAgICAgID0gW10ucHVzaCwKICAgIHRvU3RyaW5nICAgICAgICAgID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZywKICAgIG5nTWluRXJyICAgICAgICAgID0gbWluRXJyKCduZycpLAoKICAgIC8qKiBAbmFtZSBhbmd1bGFyICovCiAgICBhbmd1bGFyICAgICAgICAgICA9IHdpbmRvdy5hbmd1bGFyIHx8ICh3aW5kb3cuYW5ndWxhciA9IHt9KSwKICAgIGFuZ3VsYXJNb2R1bGUsCiAgICB1aWQgICAgICAgICAgICAgICA9IDA7CgovKioKICogZG9jdW1lbnRNb2RlIGlzIGFuIElFLW9ubHkgcHJvcGVydHkKICogaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L2llL2NjMTk2OTg4KHY9dnMuODUpLmFzcHgKICovCm1zaWUgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CgoKLyoqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSB7Kn0gb2JqCiAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiBgb2JqYCBpcyBhbiBhcnJheSBvciBhcnJheS1saWtlIG9iamVjdCAoTm9kZUxpc3QsIEFyZ3VtZW50cywKICogICAgICAgICAgICAgICAgICAgU3RyaW5nIC4uLikKICovCmZ1bmN0aW9uIGlzQXJyYXlMaWtlKG9iaikgewogIGlmIChvYmogPT0gbnVsbCB8fCBpc1dpbmRvdyhvYmopKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICB2YXIgbGVuZ3RoID0gb2JqLmxlbmd0aDsKCiAgaWYgKG9iai5ub2RlVHlwZSA9PT0gTk9ERV9UWVBFX0VMRU1FTlQgJiYgbGVuZ3RoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIHJldHVybiBpc1N0cmluZyhvYmopIHx8IGlzQXJyYXkob2JqKSB8fCBsZW5ndGggPT09IDAgfHwKICAgICAgICAgdHlwZW9mIGxlbmd0aCA9PT0gJ251bWJlcicgJiYgbGVuZ3RoID4gMCAmJiAobGVuZ3RoIC0gMSkgaW4gb2JqOwp9CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuZm9yRWFjaAogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBJbnZva2VzIHRoZSBgaXRlcmF0b3JgIGZ1bmN0aW9uIG9uY2UgZm9yIGVhY2ggaXRlbSBpbiBgb2JqYCBjb2xsZWN0aW9uLCB3aGljaCBjYW4gYmUgZWl0aGVyIGFuCiAqIG9iamVjdCBvciBhbiBhcnJheS4gVGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gaXMgaW52b2tlZCB3aXRoIGBpdGVyYXRvcih2YWx1ZSwga2V5LCBvYmopYCwgd2hlcmUgYHZhbHVlYAogKiBpcyB0aGUgdmFsdWUgb2YgYW4gb2JqZWN0IHByb3BlcnR5IG9yIGFuIGFycmF5IGVsZW1lbnQsIGBrZXlgIGlzIHRoZSBvYmplY3QgcHJvcGVydHkga2V5IG9yCiAqIGFycmF5IGVsZW1lbnQgaW5kZXggYW5kIG9iaiBpcyB0aGUgYG9iamAgaXRzZWxmLiBTcGVjaWZ5aW5nIGEgYGNvbnRleHRgIGZvciB0aGUgZnVuY3Rpb24gaXMgb3B0aW9uYWwuCiAqCiAqIEl0IGlzIHdvcnRoIG5vdGluZyB0aGF0IGAuZm9yRWFjaGAgZG9lcyBub3QgaXRlcmF0ZSBvdmVyIGluaGVyaXRlZCBwcm9wZXJ0aWVzIGJlY2F1c2UgaXQgZmlsdGVycwogKiB1c2luZyB0aGUgYGhhc093blByb3BlcnR5YCBtZXRob2QuCiAqCiAgIGBgYGpzCiAgICAgdmFyIHZhbHVlcyA9IHtuYW1lOiAnbWlza28nLCBnZW5kZXI6ICdtYWxlJ307CiAgICAgdmFyIGxvZyA9IFtdOwogICAgIGFuZ3VsYXIuZm9yRWFjaCh2YWx1ZXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgIHRoaXMucHVzaChrZXkgKyAnOiAnICsgdmFsdWUpOwogICAgIH0sIGxvZyk7CiAgICAgZXhwZWN0KGxvZykudG9FcXVhbChbJ25hbWU6IG1pc2tvJywgJ2dlbmRlcjogbWFsZSddKTsKICAgYGBgCiAqCiAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fSBvYmogT2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICogQHBhcmFtIHtGdW5jdGlvbn0gaXRlcmF0b3IgSXRlcmF0b3IgZnVuY3Rpb24uCiAqIEBwYXJhbSB7T2JqZWN0PX0gY29udGV4dCBPYmplY3QgdG8gYmVjb21lIGNvbnRleHQgKGB0aGlzYCkgZm9yIHRoZSBpdGVyYXRvciBmdW5jdGlvbi4KICogQHJldHVybnMge09iamVjdHxBcnJheX0gUmVmZXJlbmNlIHRvIGBvYmpgLgogKi8KCmZ1bmN0aW9uIGZvckVhY2gob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogIHZhciBrZXksIGxlbmd0aDsKICBpZiAob2JqKSB7CiAgICBpZiAoaXNGdW5jdGlvbihvYmopKSB7CiAgICAgIGZvciAoa2V5IGluIG9iaikgewogICAgICAgIC8vIE5lZWQgdG8gY2hlY2sgaWYgaGFzT3duUHJvcGVydHkgZXhpc3RzLAogICAgICAgIC8vIGFzIG9uIElFOCB0aGUgcmVzdWx0IG9mIHF1ZXJ5U2VsZWN0b3JBbGwgaXMgYW4gb2JqZWN0IHdpdGhvdXQgYSBoYXNPd25Qcm9wZXJ0eSBmdW5jdGlvbgogICAgICAgIGlmIChrZXkgIT0gJ3Byb3RvdHlwZScgJiYga2V5ICE9ICdsZW5ndGgnICYmIGtleSAhPSAnbmFtZScgJiYgKCFvYmouaGFzT3duUHJvcGVydHkgfHwgb2JqLmhhc093blByb3BlcnR5KGtleSkpKSB7CiAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXksIG9iaik7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzQXJyYXkob2JqKSB8fCBpc0FycmF5TGlrZShvYmopKSB7CiAgICAgIHZhciBpc1ByaW1pdGl2ZSA9IHR5cGVvZiBvYmogIT09ICdvYmplY3QnOwogICAgICBmb3IgKGtleSA9IDAsIGxlbmd0aCA9IG9iai5sZW5ndGg7IGtleSA8IGxlbmd0aDsga2V5KyspIHsKICAgICAgICBpZiAoaXNQcmltaXRpdmUgfHwga2V5IGluIG9iaikgewogICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmopOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChvYmouZm9yRWFjaCAmJiBvYmouZm9yRWFjaCAhPT0gZm9yRWFjaCkgewogICAgICAgIG9iai5mb3JFYWNoKGl0ZXJhdG9yLCBjb250ZXh0LCBvYmopOwogICAgfSBlbHNlIHsKICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CiAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXksIG9iaik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBvYmo7Cn0KCmZ1bmN0aW9uIHNvcnRlZEtleXMob2JqKSB7CiAgdmFyIGtleXMgPSBbXTsKICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAga2V5cy5wdXNoKGtleSk7CiAgICB9CiAgfQogIHJldHVybiBrZXlzLnNvcnQoKTsKfQoKZnVuY3Rpb24gZm9yRWFjaFNvcnRlZChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgdmFyIGtleXMgPSBzb3J0ZWRLZXlzKG9iaik7CiAgZm9yICggdmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5c1tpXV0sIGtleXNbaV0pOwogIH0KICByZXR1cm4ga2V5czsKfQoKCi8qKgogKiB3aGVuIHVzaW5nIGZvckVhY2ggdGhlIHBhcmFtcyBhcmUgdmFsdWUsIGtleSwgYnV0IGl0IGlzIG9mdGVuIHVzZWZ1bCB0byBoYXZlIGtleSwgdmFsdWUuCiAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nLCAqKX0gaXRlcmF0b3JGbgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oKiwgc3RyaW5nKX0KICovCmZ1bmN0aW9uIHJldmVyc2VQYXJhbXMoaXRlcmF0b3JGbikgewogIHJldHVybiBmdW5jdGlvbih2YWx1ZSwga2V5KSB7IGl0ZXJhdG9yRm4oa2V5LCB2YWx1ZSk7IH07Cn0KCi8qKgogKiBBIGNvbnNpc3RlbnQgd2F5IG9mIGNyZWF0aW5nIHVuaXF1ZSBJRHMgaW4gYW5ndWxhci4KICoKICogVXNpbmcgc2ltcGxlIG51bWJlcnMgYWxsb3dzIHVzIHRvIGdlbmVyYXRlIDI4LjYgbWlsbGlvbiB1bmlxdWUgaWRzIHBlciBzZWNvbmQgZm9yIDEwIHllYXJzIGJlZm9yZQogKiB3ZSBoaXQgbnVtYmVyIHByZWNpc2lvbiBpc3N1ZXMgaW4gSmF2YVNjcmlwdC4KICoKICogTWF0aC5wb3coMiw1MykgLyA2MCAvIDYwIC8gMjQgLyAzNjUgLyAxMCA9IDI4LjZNCiAqCiAqIEByZXR1cm5zIHtudW1iZXJ9IGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogKi8KZnVuY3Rpb24gbmV4dFVpZCgpIHsKICByZXR1cm4gKyt1aWQ7Cn0KCgovKioKICogU2V0IG9yIGNsZWFyIHRoZSBoYXNoa2V5IGZvciBhbiBvYmplY3QuCiAqIEBwYXJhbSBvYmogb2JqZWN0CiAqIEBwYXJhbSBoIHRoZSBoYXNoa2V5ICghdHJ1dGh5IHRvIGRlbGV0ZSB0aGUgaGFzaGtleSkKICovCmZ1bmN0aW9uIHNldEhhc2hLZXkob2JqLCBoKSB7CiAgaWYgKGgpIHsKICAgIG9iai4kJGhhc2hLZXkgPSBoOwogIH0KICBlbHNlIHsKICAgIGRlbGV0ZSBvYmouJCRoYXNoS2V5OwogIH0KfQoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmV4dGVuZAogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBFeHRlbmRzIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QgYGRzdGAgYnkgY29weWluZyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIGZyb20gdGhlIGBzcmNgIG9iamVjdChzKQogKiB0byBgZHN0YC4gWW91IGNhbiBzcGVjaWZ5IG11bHRpcGxlIGBzcmNgIG9iamVjdHMuIElmIHlvdSB3YW50IHRvIHByZXNlcnZlIG9yaWdpbmFsIG9iamVjdHMsIHlvdSBjYW4gZG8gc28KICogYnkgcGFzc2luZyBhbiBlbXB0eSBvYmplY3QgYXMgdGhlIHRhcmdldDogYHZhciBvYmplY3QgPSBhbmd1bGFyLmV4dGVuZCh7fSwgb2JqZWN0MSwgb2JqZWN0MilgLgogKgogKiBAcGFyYW0ge09iamVjdH0gZHN0IERlc3RpbmF0aW9uIG9iamVjdC4KICogQHBhcmFtIHsuLi5PYmplY3R9IHNyYyBTb3VyY2Ugb2JqZWN0KHMpLgogKiBAcmV0dXJucyB7T2JqZWN0fSBSZWZlcmVuY2UgdG8gYGRzdGAuCiAqLwpmdW5jdGlvbiBleHRlbmQoZHN0KSB7CiAgdmFyIGggPSBkc3QuJCRoYXNoS2V5OwoKICBmb3IgKHZhciBpID0gMSwgaWkgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgdmFyIG9iaiA9IGFyZ3VtZW50c1tpXTsKICAgIGlmIChvYmopIHsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmopOwogICAgICBmb3IgKHZhciBqID0gMCwgamogPSBrZXlzLmxlbmd0aDsgaiA8IGpqOyBqKyspIHsKICAgICAgICB2YXIga2V5ID0ga2V5c1tqXTsKICAgICAgICBkc3Rba2V5XSA9IG9ialtrZXldOwogICAgICB9CiAgICB9CiAgfQoKICBzZXRIYXNoS2V5KGRzdCwgaCk7CiAgcmV0dXJuIGRzdDsKfQoKZnVuY3Rpb24gaW50KHN0cikgewogIHJldHVybiBwYXJzZUludChzdHIsIDEwKTsKfQoKCmZ1bmN0aW9uIGluaGVyaXQocGFyZW50LCBleHRyYSkgewogIHJldHVybiBleHRlbmQobmV3IChleHRlbmQoZnVuY3Rpb24oKSB7fSwge3Byb3RvdHlwZTpwYXJlbnR9KSkoKSwgZXh0cmEpOwp9CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIubm9vcAogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIGZ1bmN0aW9uIHRoYXQgcGVyZm9ybXMgbm8gb3BlcmF0aW9ucy4gVGhpcyBmdW5jdGlvbiBjYW4gYmUgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlIGluIHRoZQogKiBmdW5jdGlvbmFsIHN0eWxlLgogICBgYGBqcwogICAgIGZ1bmN0aW9uIGZvbyhjYWxsYmFjaykgewogICAgICAgdmFyIHJlc3VsdCA9IGNhbGN1bGF0ZVJlc3VsdCgpOwogICAgICAgKGNhbGxiYWNrIHx8IGFuZ3VsYXIubm9vcCkocmVzdWx0KTsKICAgICB9CiAgIGBgYAogKi8KZnVuY3Rpb24gbm9vcCgpIHt9Cm5vb3AuJGluamVjdCA9IFtdOwoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pZGVudGl0eQogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBpdHMgZmlyc3QgYXJndW1lbnQuIFRoaXMgZnVuY3Rpb24gaXMgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlIGluIHRoZQogKiBmdW5jdGlvbmFsIHN0eWxlLgogKgogICBgYGBqcwogICAgIGZ1bmN0aW9uIHRyYW5zZm9ybWVyKHRyYW5zZm9ybWF0aW9uRm4sIHZhbHVlKSB7CiAgICAgICByZXR1cm4gKHRyYW5zZm9ybWF0aW9uRm4gfHwgYW5ndWxhci5pZGVudGl0eSkodmFsdWUpOwogICAgIH07CiAgIGBgYAogKi8KZnVuY3Rpb24gaWRlbnRpdHkoJCkge3JldHVybiAkO30KaWRlbnRpdHkuJGluamVjdCA9IFtdOwoKCmZ1bmN0aW9uIHZhbHVlRm4odmFsdWUpIHtyZXR1cm4gZnVuY3Rpb24oKSB7cmV0dXJuIHZhbHVlO307fQoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzVW5kZWZpbmVkCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgdW5kZWZpbmVkLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyB1bmRlZmluZWQuCiAqLwpmdW5jdGlvbiBpc1VuZGVmaW5lZCh2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCc7fQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc0RlZmluZWQKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBkZWZpbmVkLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBkZWZpbmVkLgogKi8KZnVuY3Rpb24gaXNEZWZpbmVkKHZhbHVlKXtyZXR1cm4gdHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJzt9CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzT2JqZWN0CiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYW4gYE9iamVjdGAuIFVubGlrZSBgdHlwZW9mYCBpbiBKYXZhU2NyaXB0LCBgbnVsbGBzIGFyZSBub3QKICogY29uc2lkZXJlZCB0byBiZSBvYmplY3RzLiBOb3RlIHRoYXQgSmF2YVNjcmlwdCBhcnJheXMgYXJlIG9iamVjdHMuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIGBPYmplY3RgIGJ1dCBub3QgYG51bGxgLgogKi8KZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpewogIC8vIGh0dHA6Ly9qc3BlcmYuY29tL2lzb2JqZWN0NAogIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnOwp9CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzU3RyaW5nCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBgU3RyaW5nYC4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgU3RyaW5nYC4KICovCmZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKXtyZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJzt9CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzTnVtYmVyCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBgTnVtYmVyYC4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgTnVtYmVyYC4KICovCmZ1bmN0aW9uIGlzTnVtYmVyKHZhbHVlKXtyZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJzt9CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzRGF0ZQogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIGEgdmFsdWUgaXMgYSBkYXRlLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBEYXRlYC4KICovCmZ1bmN0aW9uIGlzRGF0ZSh2YWx1ZSkgewogIHJldHVybiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gJ1tvYmplY3QgRGF0ZV0nOwp9CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzQXJyYXkKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhbiBgQXJyYXlgLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhbiBgQXJyYXlgLgogKi8KdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5OwoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzRnVuY3Rpb24KICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBGdW5jdGlvbmAuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYEZ1bmN0aW9uYC4KICovCmZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsdWUpe3JldHVybiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbic7fQoKCi8qKgogKiBEZXRlcm1pbmVzIGlmIGEgdmFsdWUgaXMgYSByZWd1bGFyIGV4cHJlc3Npb24gb2JqZWN0LgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBSZWdFeHBgLgogKi8KZnVuY3Rpb24gaXNSZWdFeHAodmFsdWUpIHsKICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IFJlZ0V4cF0nOwp9CgoKLyoqCiAqIENoZWNrcyBpZiBgb2JqYCBpcyBhIHdpbmRvdyBvYmplY3QuCiAqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSB7Kn0gb2JqIE9iamVjdCB0byBjaGVjawogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgb2JqYCBpcyBhIHdpbmRvdyBvYmouCiAqLwpmdW5jdGlvbiBpc1dpbmRvdyhvYmopIHsKICByZXR1cm4gb2JqICYmIG9iai53aW5kb3cgPT09IG9iajsKfQoKCmZ1bmN0aW9uIGlzU2NvcGUob2JqKSB7CiAgcmV0dXJuIG9iaiAmJiBvYmouJGV2YWxBc3luYyAmJiBvYmouJHdhdGNoOwp9CgoKZnVuY3Rpb24gaXNGaWxlKG9iaikgewogIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEZpbGVdJzsKfQoKCmZ1bmN0aW9uIGlzQmxvYihvYmopIHsKICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBCbG9iXSc7Cn0KCgpmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsKICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbic7Cn0KCgpmdW5jdGlvbiBpc1Byb21pc2VMaWtlKG9iaikgewogIHJldHVybiBvYmogJiYgaXNGdW5jdGlvbihvYmoudGhlbik7Cn0KCgp2YXIgdHJpbSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgcmV0dXJuIGlzU3RyaW5nKHZhbHVlKSA/IHZhbHVlLnRyaW0oKSA6IHZhbHVlOwp9OwoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc0VsZW1lbnQKICogQG1vZHVsZSBuZwogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIERPTSBlbGVtZW50IChvciB3cmFwcGVkIGpRdWVyeSBlbGVtZW50KS4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBET00gZWxlbWVudCAob3Igd3JhcHBlZCBqUXVlcnkgZWxlbWVudCkuCiAqLwpmdW5jdGlvbiBpc0VsZW1lbnQobm9kZSkgewogIHJldHVybiAhIShub2RlICYmCiAgICAobm9kZS5ub2RlTmFtZSAgLy8gd2UgYXJlIGEgZGlyZWN0IGVsZW1lbnQKICAgIHx8IChub2RlLnByb3AgJiYgbm9kZS5hdHRyICYmIG5vZGUuZmluZCkpKTsgIC8vIHdlIGhhdmUgYW4gb24gYW5kIGZpbmQgbWV0aG9kIHBhcnQgb2YgalF1ZXJ5IEFQSQp9CgovKioKICogQHBhcmFtIHN0ciAna2V5MSxrZXkyLC4uLicKICogQHJldHVybnMge29iamVjdH0gaW4gdGhlIGZvcm0gb2Yge2tleTE6dHJ1ZSwga2V5Mjp0cnVlLCAuLi59CiAqLwpmdW5jdGlvbiBtYWtlTWFwKHN0cikgewogIHZhciBvYmogPSB7fSwgaXRlbXMgPSBzdHIuc3BsaXQoIiwiKSwgaTsKICBmb3IgKCBpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrICkKICAgIG9ialsgaXRlbXNbaV0gXSA9IHRydWU7CiAgcmV0dXJuIG9iajsKfQoKCmZ1bmN0aW9uIG5vZGVOYW1lXyhlbGVtZW50KSB7CiAgcmV0dXJuIGxvd2VyY2FzZShlbGVtZW50Lm5vZGVOYW1lIHx8IGVsZW1lbnRbMF0ubm9kZU5hbWUpOwp9CgoKLyoqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gYXJyYXksIHRoZSBudW1iZXIgb2YgcHJvcGVydGllcyBhbiBvYmplY3QgaGFzLCBvcgogKiB0aGUgbGVuZ3RoIG9mIGEgc3RyaW5nLgogKgogKiBOb3RlOiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgT2JqZWN0IHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAqIHtAbGluayBhbmd1bGFyLk9iamVjdH0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fHN0cmluZ30gb2JqIE9iamVjdCwgYXJyYXksIG9yIHN0cmluZyB0byBpbnNwZWN0LgogKiBAcGFyYW0ge2Jvb2xlYW59IFtvd25Qcm9wc09ubHk9ZmFsc2VdIENvdW50IG9ubHkgIm93biIgcHJvcGVydGllcyBpbiBhbiBvYmplY3QKICogQHJldHVybnMge251bWJlcn0gVGhlIHNpemUgb2YgYG9iamAgb3IgYDBgIGlmIGBvYmpgIGlzIG5laXRoZXIgYW4gb2JqZWN0IG5vciBhbiBhcnJheS4KICovCmZ1bmN0aW9uIHNpemUob2JqLCBvd25Qcm9wc09ubHkpIHsKICB2YXIgY291bnQgPSAwLCBrZXk7CgogIGlmIChpc0FycmF5KG9iaikgfHwgaXNTdHJpbmcob2JqKSkgewogICAgcmV0dXJuIG9iai5sZW5ndGg7CiAgfSBlbHNlIGlmIChpc09iamVjdChvYmopKSB7CiAgICBmb3IgKGtleSBpbiBvYmopCiAgICAgIGlmICghb3duUHJvcHNPbmx5IHx8IG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKQogICAgICAgIGNvdW50Kys7CiAgfQoKICByZXR1cm4gY291bnQ7Cn0KCgpmdW5jdGlvbiBpbmNsdWRlcyhhcnJheSwgb2JqKSB7CiAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5pbmRleE9mLmNhbGwoYXJyYXksIG9iaikgIT0gLTE7Cn0KCmZ1bmN0aW9uIGFycmF5UmVtb3ZlKGFycmF5LCB2YWx1ZSkgewogIHZhciBpbmRleCA9IGFycmF5LmluZGV4T2YodmFsdWUpOwogIGlmIChpbmRleCA+PTApCiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEpOwogIHJldHVybiB2YWx1ZTsKfQoKZnVuY3Rpb24gaXNMZWFmTm9kZSAobm9kZSkgewogIGlmIChub2RlKSB7CiAgICBzd2l0Y2ggKG5vZGVOYW1lXyhub2RlKSkgewogICAgY2FzZSAib3B0aW9uIjoKICAgIGNhc2UgInByZSI6CiAgICBjYXNlICJ0aXRsZSI6CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn0KCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5jb3B5CiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIENyZWF0ZXMgYSBkZWVwIGNvcHkgb2YgYHNvdXJjZWAsIHdoaWNoIHNob3VsZCBiZSBhbiBvYmplY3Qgb3IgYW4gYXJyYXkuCiAqCiAqICogSWYgbm8gZGVzdGluYXRpb24gaXMgc3VwcGxpZWQsIGEgY29weSBvZiB0aGUgb2JqZWN0IG9yIGFycmF5IGlzIGNyZWF0ZWQuCiAqICogSWYgYSBkZXN0aW5hdGlvbiBpcyBwcm92aWRlZCwgYWxsIG9mIGl0cyBlbGVtZW50cyAoZm9yIGFycmF5KSBvciBwcm9wZXJ0aWVzIChmb3Igb2JqZWN0cykKICogICBhcmUgZGVsZXRlZCBhbmQgdGhlbiBhbGwgZWxlbWVudHMvcHJvcGVydGllcyBmcm9tIHRoZSBzb3VyY2UgYXJlIGNvcGllZCB0byBpdC4KICogKiBJZiBgc291cmNlYCBpcyBub3QgYW4gb2JqZWN0IG9yIGFycmF5IChpbmMuIGBudWxsYCBhbmQgYHVuZGVmaW5lZGApLCBgc291cmNlYCBpcyByZXR1cm5lZC4KICogKiBJZiBgc291cmNlYCBpcyBpZGVudGljYWwgdG8gJ2Rlc3RpbmF0aW9uJyBhbiBleGNlcHRpb24gd2lsbCBiZSB0aHJvd24uCiAqCiAqIEBwYXJhbSB7Kn0gc291cmNlIFRoZSBzb3VyY2UgdGhhdCB3aWxsIGJlIHVzZWQgdG8gbWFrZSBhIGNvcHkuCiAqICAgICAgICAgICAgICAgICAgIENhbiBiZSBhbnkgdHlwZSwgaW5jbHVkaW5nIHByaW1pdGl2ZXMsIGBudWxsYCwgYW5kIGB1bmRlZmluZWRgLgogKiBAcGFyYW0geyhPYmplY3R8QXJyYXkpPX0gZGVzdGluYXRpb24gRGVzdGluYXRpb24gaW50byB3aGljaCB0aGUgc291cmNlIGlzIGNvcGllZC4gSWYKICogICAgIHByb3ZpZGVkLCBtdXN0IGJlIG9mIHRoZSBzYW1lIHR5cGUgYXMgYHNvdXJjZWAuCiAqIEByZXR1cm5zIHsqfSBUaGUgY29weSBvciB1cGRhdGVkIGBkZXN0aW5hdGlvbmAsIGlmIGBkZXN0aW5hdGlvbmAgd2FzIHNwZWNpZmllZC4KICoKICogQGV4YW1wbGUKIDxleGFtcGxlIG1vZHVsZT0iY29weUV4YW1wbGUiPgogPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KIDxmb3JtIG5vdmFsaWRhdGUgY2xhc3M9InNpbXBsZS1mb3JtIj4KIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idXNlci5uYW1lIiAvPjxiciAvPgogRS1tYWlsOiA8aW5wdXQgdHlwZT0iZW1haWwiIG5nLW1vZGVsPSJ1c2VyLmVtYWlsIiAvPjxiciAvPgogR2VuZGVyOiA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJ1c2VyLmdlbmRlciIgdmFsdWU9Im1hbGUiIC8+bWFsZQogPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0idXNlci5nZW5kZXIiIHZhbHVlPSJmZW1hbGUiIC8+ZmVtYWxlPGJyIC8+CiA8YnV0dG9uIG5nLWNsaWNrPSJyZXNldCgpIj5SRVNFVDwvYnV0dG9uPgogPGJ1dHRvbiBuZy1jbGljaz0idXBkYXRlKHVzZXIpIj5TQVZFPC9idXR0b24+CiA8L2Zvcm0+CiA8cHJlPmZvcm0gPSB7e3VzZXIgfCBqc29ufX08L3ByZT4KIDxwcmU+bWFzdGVyID0ge3ttYXN0ZXIgfCBqc29ufX08L3ByZT4KIDwvZGl2PgoKIDxzY3JpcHQ+CiAgYW5ndWxhci5tb2R1bGUoJ2NvcHlFeGFtcGxlJywgW10pCiAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAkc2NvcGUubWFzdGVyPSB7fTsKCiAgICAgICRzY29wZS51cGRhdGUgPSBmdW5jdGlvbih1c2VyKSB7CiAgICAgICAgLy8gRXhhbXBsZSB3aXRoIDEgYXJndW1lbnQKICAgICAgICAkc2NvcGUubWFzdGVyPSBhbmd1bGFyLmNvcHkodXNlcik7CiAgICAgIH07CgogICAgICAkc2NvcGUucmVzZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAvLyBFeGFtcGxlIHdpdGggMiBhcmd1bWVudHMKICAgICAgICBhbmd1bGFyLmNvcHkoJHNjb3BlLm1hc3RlciwgJHNjb3BlLnVzZXIpOwogICAgICB9OwoKICAgICAgJHNjb3BlLnJlc2V0KCk7CiAgICB9XSk7CiA8L3NjcmlwdD4KIDwvZmlsZT4KIDwvZXhhbXBsZT4KICovCmZ1bmN0aW9uIGNvcHkoc291cmNlLCBkZXN0aW5hdGlvbiwgc3RhY2tTb3VyY2UsIHN0YWNrRGVzdCkgewogIGlmIChpc1dpbmRvdyhzb3VyY2UpIHx8IGlzU2NvcGUoc291cmNlKSkgewogICAgdGhyb3cgbmdNaW5FcnIoJ2Nwd3MnLAogICAgICAiQ2FuJ3QgY29weSEgTWFraW5nIGNvcGllcyBvZiBXaW5kb3cgb3IgU2NvcGUgaW5zdGFuY2VzIGlzIG5vdCBzdXBwb3J0ZWQuIik7CiAgfQoKICBpZiAoIWRlc3RpbmF0aW9uKSB7CiAgICBkZXN0aW5hdGlvbiA9IHNvdXJjZTsKICAgIGlmIChzb3VyY2UpIHsKICAgICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICAgIGRlc3RpbmF0aW9uID0gY29weShzb3VyY2UsIFtdLCBzdGFja1NvdXJjZSwgc3RhY2tEZXN0KTsKICAgICAgfSBlbHNlIGlmIChpc0RhdGUoc291cmNlKSkgewogICAgICAgIGRlc3RpbmF0aW9uID0gbmV3IERhdGUoc291cmNlLmdldFRpbWUoKSk7CiAgICAgIH0gZWxzZSBpZiAoaXNSZWdFeHAoc291cmNlKSkgewogICAgICAgIGRlc3RpbmF0aW9uID0gbmV3IFJlZ0V4cChzb3VyY2Uuc291cmNlLCBzb3VyY2UudG9TdHJpbmcoKS5tYXRjaCgvW15cL10qJC8pWzBdKTsKICAgICAgICBkZXN0aW5hdGlvbi5sYXN0SW5kZXggPSBzb3VyY2UubGFzdEluZGV4OwogICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHNvdXJjZSkpIHsKICAgICAgICB2YXIgZW1wdHlPYmplY3QgPSBPYmplY3QuY3JlYXRlKE9iamVjdC5nZXRQcm90b3R5cGVPZihzb3VyY2UpKTsKICAgICAgICBkZXN0aW5hdGlvbiA9IGNvcHkoc291cmNlLCBlbXB0eU9iamVjdCwgc3RhY2tTb3VyY2UsIHN0YWNrRGVzdCk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgaWYgKHNvdXJjZSA9PT0gZGVzdGluYXRpb24pIHRocm93IG5nTWluRXJyKCdjcGknLAogICAgICAiQ2FuJ3QgY29weSEgU291cmNlIGFuZCBkZXN0aW5hdGlvbiBhcmUgaWRlbnRpY2FsLiIpOwoKICAgIHN0YWNrU291cmNlID0gc3RhY2tTb3VyY2UgfHwgW107CiAgICBzdGFja0Rlc3QgPSBzdGFja0Rlc3QgfHwgW107CgogICAgaWYgKGlzT2JqZWN0KHNvdXJjZSkpIHsKICAgICAgdmFyIGluZGV4ID0gc3RhY2tTb3VyY2UuaW5kZXhPZihzb3VyY2UpOwogICAgICBpZiAoaW5kZXggIT09IC0xKSByZXR1cm4gc3RhY2tEZXN0W2luZGV4XTsKCiAgICAgIHN0YWNrU291cmNlLnB1c2goc291cmNlKTsKICAgICAgc3RhY2tEZXN0LnB1c2goZGVzdGluYXRpb24pOwogICAgfQoKICAgIHZhciByZXN1bHQ7CiAgICBpZiAoaXNBcnJheShzb3VyY2UpKSB7CiAgICAgIGRlc3RpbmF0aW9uLmxlbmd0aCA9IDA7CiAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHNvdXJjZS5sZW5ndGg7IGkrKykgewogICAgICAgIHJlc3VsdCA9IGNvcHkoc291cmNlW2ldLCBudWxsLCBzdGFja1NvdXJjZSwgc3RhY2tEZXN0KTsKICAgICAgICBpZiAoaXNPYmplY3Qoc291cmNlW2ldKSkgewogICAgICAgICAgc3RhY2tTb3VyY2UucHVzaChzb3VyY2VbaV0pOwogICAgICAgICAgc3RhY2tEZXN0LnB1c2gocmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgZGVzdGluYXRpb24ucHVzaChyZXN1bHQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgaCA9IGRlc3RpbmF0aW9uLiQkaGFzaEtleTsKICAgICAgaWYgKGlzQXJyYXkoZGVzdGluYXRpb24pKSB7CiAgICAgICAgZGVzdGluYXRpb24ubGVuZ3RoID0gMDsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3JFYWNoKGRlc3RpbmF0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICBkZWxldGUgZGVzdGluYXRpb25ba2V5XTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBmb3IgKCB2YXIga2V5IGluIHNvdXJjZSkgewogICAgICAgIGlmKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICByZXN1bHQgPSBjb3B5KHNvdXJjZVtrZXldLCBudWxsLCBzdGFja1NvdXJjZSwgc3RhY2tEZXN0KTsKICAgICAgICAgIGlmIChpc09iamVjdChzb3VyY2Vba2V5XSkpIHsKICAgICAgICAgICAgc3RhY2tTb3VyY2UucHVzaChzb3VyY2Vba2V5XSk7CiAgICAgICAgICAgIHN0YWNrRGVzdC5wdXNoKHJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgICBkZXN0aW5hdGlvbltrZXldID0gcmVzdWx0OwogICAgICAgIH0KICAgICAgfQogICAgICBzZXRIYXNoS2V5KGRlc3RpbmF0aW9uLGgpOwogICAgfQoKICB9CiAgcmV0dXJuIGRlc3RpbmF0aW9uOwp9CgovKioKICogQ3JlYXRlcyBhIHNoYWxsb3cgY29weSBvZiBhbiBvYmplY3QsIGFuIGFycmF5IG9yIGEgcHJpbWl0aXZlLgogKgogKiBBc3N1bWVzIHRoYXQgdGhlcmUgYXJlIG5vIHByb3RvIHByb3BlcnRpZXMgZm9yIG9iamVjdHMuCiAqLwpmdW5jdGlvbiBzaGFsbG93Q29weShzcmMsIGRzdCkgewogIGlmIChpc0FycmF5KHNyYykpIHsKICAgIGRzdCA9IGRzdCB8fCBbXTsKCiAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBzcmMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICBkc3RbaV0gPSBzcmNbaV07CiAgICB9CiAgfSBlbHNlIGlmIChpc09iamVjdChzcmMpKSB7CiAgICBkc3QgPSBkc3QgfHwge307CgogICAgZm9yICh2YXIga2V5IGluIHNyYykgewogICAgICBpZiAoIShrZXkuY2hhckF0KDApID09PSAnJCcgJiYga2V5LmNoYXJBdCgxKSA9PT0gJyQnKSkgewogICAgICAgIGRzdFtrZXldID0gc3JjW2tleV07CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiBkc3QgfHwgc3JjOwp9CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmVxdWFscwogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIHR3byBvYmplY3RzIG9yIHR3byB2YWx1ZXMgYXJlIGVxdWl2YWxlbnQuIFN1cHBvcnRzIHZhbHVlIHR5cGVzLCByZWd1bGFyCiAqIGV4cHJlc3Npb25zLCBhcnJheXMgYW5kIG9iamVjdHMuCiAqCiAqIFR3byBvYmplY3RzIG9yIHZhbHVlcyBhcmUgY29uc2lkZXJlZCBlcXVpdmFsZW50IGlmIGF0IGxlYXN0IG9uZSBvZiB0aGUgZm9sbG93aW5nIGlzIHRydWU6CiAqCiAqICogQm90aCBvYmplY3RzIG9yIHZhbHVlcyBwYXNzIGA9PT1gIGNvbXBhcmlzb24uCiAqICogQm90aCBvYmplY3RzIG9yIHZhbHVlcyBhcmUgb2YgdGhlIHNhbWUgdHlwZSBhbmQgYWxsIG9mIHRoZWlyIHByb3BlcnRpZXMgYXJlIGVxdWFsIGJ5CiAqICAgY29tcGFyaW5nIHRoZW0gd2l0aCBgYW5ndWxhci5lcXVhbHNgLgogKiAqIEJvdGggdmFsdWVzIGFyZSBOYU4uIChJbiBKYXZhU2NyaXB0LCBOYU4gPT0gTmFOID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIE5hTiBhcyBlcXVhbCkKICogKiBCb3RoIHZhbHVlcyByZXByZXNlbnQgdGhlIHNhbWUgcmVndWxhciBleHByZXNzaW9uIChJbiBKYXZhU2NyaXB0LAogKiAgIC9hYmMvID09IC9hYmMvID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIHJlZ3VsYXIgZXhwcmVzc2lvbnMgYXMgZXF1YWwgd2hlbiB0aGVpciB0ZXh0dWFsCiAqICAgcmVwcmVzZW50YXRpb24gbWF0Y2hlcykuCiAqCiAqIER1cmluZyBhIHByb3BlcnR5IGNvbXBhcmlzb24sIHByb3BlcnRpZXMgb2YgYGZ1bmN0aW9uYCB0eXBlIGFuZCBwcm9wZXJ0aWVzIHdpdGggbmFtZXMKICogdGhhdCBiZWdpbiB3aXRoIGAkYCBhcmUgaWdub3JlZC4KICoKICogU2NvcGUgYW5kIERPTVdpbmRvdyBvYmplY3RzIGFyZSBiZWluZyBjb21wYXJlZCBvbmx5IGJ5IGlkZW50aWZ5IChgPT09YCkuCiAqCiAqIEBwYXJhbSB7Kn0gbzEgT2JqZWN0IG9yIHZhbHVlIHRvIGNvbXBhcmUuCiAqIEBwYXJhbSB7Kn0gbzIgT2JqZWN0IG9yIHZhbHVlIHRvIGNvbXBhcmUuCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGFyZ3VtZW50cyBhcmUgZXF1YWwuCiAqLwpmdW5jdGlvbiBlcXVhbHMobzEsIG8yKSB7CiAgaWYgKG8xID09PSBvMikgcmV0dXJuIHRydWU7CiAgaWYgKG8xID09PSBudWxsIHx8IG8yID09PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgaWYgKG8xICE9PSBvMSAmJiBvMiAhPT0gbzIpIHJldHVybiB0cnVlOyAvLyBOYU4gPT09IE5hTgogIHZhciB0MSA9IHR5cGVvZiBvMSwgdDIgPSB0eXBlb2YgbzIsIGxlbmd0aCwga2V5LCBrZXlTZXQ7CiAgaWYgKHQxID09IHQyKSB7CiAgICBpZiAodDEgPT0gJ29iamVjdCcpIHsKICAgICAgaWYgKGlzQXJyYXkobzEpKSB7CiAgICAgICAgaWYgKCFpc0FycmF5KG8yKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmICgobGVuZ3RoID0gbzEubGVuZ3RoKSA9PSBvMi5sZW5ndGgpIHsKICAgICAgICAgIGZvcihrZXk9MDsga2V5PGxlbmd0aDsga2V5KyspIHsKICAgICAgICAgICAgaWYgKCFlcXVhbHMobzFba2V5XSwgbzJba2V5XSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpc0RhdGUobzEpKSB7CiAgICAgICAgaWYgKCFpc0RhdGUobzIpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgcmV0dXJuIGVxdWFscyhvMS5nZXRUaW1lKCksIG8yLmdldFRpbWUoKSk7CiAgICAgIH0gZWxzZSBpZiAoaXNSZWdFeHAobzEpICYmIGlzUmVnRXhwKG8yKSkgewogICAgICAgIHJldHVybiBvMS50b1N0cmluZygpID09IG8yLnRvU3RyaW5nKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlzU2NvcGUobzEpIHx8IGlzU2NvcGUobzIpIHx8IGlzV2luZG93KG8xKSB8fCBpc1dpbmRvdyhvMikgfHwgaXNBcnJheShvMikpIHJldHVybiBmYWxzZTsKICAgICAgICBrZXlTZXQgPSB7fTsKICAgICAgICBmb3Ioa2V5IGluIG8xKSB7CiAgICAgICAgICBpZiAoa2V5LmNoYXJBdCgwKSA9PT0gJyQnIHx8IGlzRnVuY3Rpb24obzFba2V5XSkpIGNvbnRpbnVlOwogICAgICAgICAgaWYgKCFlcXVhbHMobzFba2V5XSwgbzJba2V5XSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIGtleVNldFtrZXldID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZm9yKGtleSBpbiBvMikgewogICAgICAgICAgaWYgKCFrZXlTZXQuaGFzT3duUHJvcGVydHkoa2V5KSAmJgogICAgICAgICAgICAgIGtleS5jaGFyQXQoMCkgIT09ICckJyAmJgogICAgICAgICAgICAgIG8yW2tleV0gIT09IHVuZGVmaW5lZCAmJgogICAgICAgICAgICAgICFpc0Z1bmN0aW9uKG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfQoKdmFyIGNzcCA9IGZ1bmN0aW9uKCkgewogIGlmIChpc0RlZmluZWQoY3NwLmlzQWN0aXZlXykpIHJldHVybiBjc3AuaXNBY3RpdmVfOwoKICB2YXIgYWN0aXZlID0gISEoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW25nLWNzcF0nKSB8fAogICAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1uZy1jc3BdJykpOwoKICBpZiAoIWFjdGl2ZSkgewogICAgdHJ5IHsKICAgICAgLyoganNoaW50IC1XMDMxLCAtVzA1NCAqLwogICAgICBuZXcgRnVuY3Rpb24oJycpOwogICAgICAvKiBqc2hpbnQgK1cwMzEsICtXMDU0ICovCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGFjdGl2ZSA9IHRydWU7CiAgICB9CiAgfQoKICByZXR1cm4gKGNzcC5pc0FjdGl2ZV8gPSBhY3RpdmUpOwp9OwoKCgpmdW5jdGlvbiBjb25jYXQoYXJyYXkxLCBhcnJheTIsIGluZGV4KSB7CiAgcmV0dXJuIGFycmF5MS5jb25jYXQoc2xpY2UuY2FsbChhcnJheTIsIGluZGV4KSk7Cn0KCmZ1bmN0aW9uIHNsaWNlQXJncyhhcmdzLCBzdGFydEluZGV4KSB7CiAgcmV0dXJuIHNsaWNlLmNhbGwoYXJncywgc3RhcnRJbmRleCB8fCAwKTsKfQoKCi8qIGpzaGludCAtVzEwMSAqLwovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuYmluZAogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBSZXR1cm5zIGEgZnVuY3Rpb24gd2hpY2ggY2FsbHMgZnVuY3Rpb24gYGZuYCBib3VuZCB0byBgc2VsZmAgKGBzZWxmYCBiZWNvbWVzIHRoZSBgdGhpc2AgZm9yCiAqIGBmbmApLiBZb3UgY2FuIHN1cHBseSBvcHRpb25hbCBgYXJnc2AgdGhhdCBhcmUgcHJlYm91bmQgdG8gdGhlIGZ1bmN0aW9uLiBUaGlzIGZlYXR1cmUgaXMgYWxzbwogKiBrbm93biBhcyBbcGFydGlhbCBhcHBsaWNhdGlvbl0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9QYXJ0aWFsX2FwcGxpY2F0aW9uKSwgYXMKICogZGlzdGluZ3Vpc2hlZCBmcm9tIFtmdW5jdGlvbiBjdXJyeWluZ10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9DdXJyeWluZyNDb250cmFzdF93aXRoX3BhcnRpYWxfZnVuY3Rpb25fYXBwbGljYXRpb24pLgogKgogKiBAcGFyYW0ge09iamVjdH0gc2VsZiBDb250ZXh0IHdoaWNoIGBmbmAgc2hvdWxkIGJlIGV2YWx1YXRlZCBpbi4KICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBGdW5jdGlvbiB0byBiZSBib3VuZC4KICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBiZSBwcmVib3VuZCB0byB0aGUgYGZuYCBmdW5jdGlvbiBjYWxsLgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gRnVuY3Rpb24gdGhhdCB3cmFwcyB0aGUgYGZuYCB3aXRoIGFsbCB0aGUgc3BlY2lmaWVkIGJpbmRpbmdzLgogKi8KLyoganNoaW50ICtXMTAxICovCmZ1bmN0aW9uIGJpbmQoc2VsZiwgZm4pIHsKICB2YXIgY3VycnlBcmdzID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBzbGljZUFyZ3MoYXJndW1lbnRzLCAyKSA6IFtdOwogIGlmIChpc0Z1bmN0aW9uKGZuKSAmJiAhKGZuIGluc3RhbmNlb2YgUmVnRXhwKSkgewogICAgcmV0dXJuIGN1cnJ5QXJncy5sZW5ndGgKICAgICAgPyBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgID8gZm4uYXBwbHkoc2VsZiwgY3VycnlBcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpKQogICAgICAgICAgICA6IGZuLmFwcGx5KHNlbGYsIGN1cnJ5QXJncyk7CiAgICAgICAgfQogICAgICA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGgKICAgICAgICAgICAgPyBmbi5hcHBseShzZWxmLCBhcmd1bWVudHMpCiAgICAgICAgICAgIDogZm4uY2FsbChzZWxmKTsKICAgICAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBpbiBJRSwgbmF0aXZlIG1ldGhvZHMgYXJlIG5vdCBmdW5jdGlvbnMgc28gdGhleSBjYW5ub3QgYmUgYm91bmQgKG5vdGU6IHRoZXkgZG9uJ3QgbmVlZCB0byBiZSkKICAgIHJldHVybiBmbjsKICB9Cn0KCgpmdW5jdGlvbiB0b0pzb25SZXBsYWNlcihrZXksIHZhbHVlKSB7CiAgdmFyIHZhbCA9IHZhbHVlOwoKICBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYga2V5LmNoYXJBdCgwKSA9PT0gJyQnICYmIGtleS5jaGFyQXQoMSkgPT09ICckJykgewogICAgdmFsID0gdW5kZWZpbmVkOwogIH0gZWxzZSBpZiAoaXNXaW5kb3codmFsdWUpKSB7CiAgICB2YWwgPSAnJFdJTkRPVyc7CiAgfSBlbHNlIGlmICh2YWx1ZSAmJiAgZG9jdW1lbnQgPT09IHZhbHVlKSB7CiAgICB2YWwgPSAnJERPQ1VNRU5UJzsKICB9IGVsc2UgaWYgKGlzU2NvcGUodmFsdWUpKSB7CiAgICB2YWwgPSAnJFNDT1BFJzsKICB9CgogIHJldHVybiB2YWw7Cn0KCgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIudG9Kc29uCiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIFNlcmlhbGl6ZXMgaW5wdXQgaW50byBhIEpTT04tZm9ybWF0dGVkIHN0cmluZy4gUHJvcGVydGllcyB3aXRoIGxlYWRpbmcgJCQgY2hhcmFjdGVycyB3aWxsIGJlCiAqIHN0cmlwcGVkIHNpbmNlIGFuZ3VsYXIgdXNlcyB0aGlzIG5vdGF0aW9uIGludGVybmFsbHkuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fERhdGV8c3RyaW5nfG51bWJlcn0gb2JqIElucHV0IHRvIGJlIHNlcmlhbGl6ZWQgaW50byBKU09OLgogKiBAcGFyYW0ge2Jvb2xlYW49fSBwcmV0dHkgSWYgc2V0IHRvIHRydWUsIHRoZSBKU09OIG91dHB1dCB3aWxsIGNvbnRhaW4gbmV3bGluZXMgYW5kIHdoaXRlc3BhY2UuCiAqIEByZXR1cm5zIHtzdHJpbmd8dW5kZWZpbmVkfSBKU09OLWlmaWVkIHN0cmluZyByZXByZXNlbnRpbmcgYG9iamAuCiAqLwpmdW5jdGlvbiB0b0pzb24ob2JqLCBwcmV0dHkpIHsKICBpZiAodHlwZW9mIG9iaiA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB1bmRlZmluZWQ7CiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaiwgdG9Kc29uUmVwbGFjZXIsIHByZXR0eSA/ICcgICcgOiBudWxsKTsKfQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5mcm9tSnNvbgogKiBAbW9kdWxlIG5nCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXNlcmlhbGl6ZXMgYSBKU09OIHN0cmluZy4KICoKICogQHBhcmFtIHtzdHJpbmd9IGpzb24gSlNPTiBzdHJpbmcgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm5zIHtPYmplY3R8QXJyYXl8c3RyaW5nfG51bWJlcn0gRGVzZXJpYWxpemVkIHRoaW5neS4KICovCmZ1bmN0aW9uIGZyb21Kc29uKGpzb24pIHsKICByZXR1cm4gaXNTdHJpbmcoanNvbikKICAgICAgPyBKU09OLnBhcnNlKGpzb24pCiAgICAgIDoganNvbjsKfQoKCi8qKgogKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGVsZW1lbnQuCiAqLwpmdW5jdGlvbiBzdGFydGluZ1RhZyhlbGVtZW50KSB7CiAgZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KS5jbG9uZSgpOwogIHRyeSB7CiAgICAvLyB0dXJucyBvdXQgSUUgZG9lcyBub3QgbGV0IHlvdSBzZXQgLmh0bWwoKSBvbiBlbGVtZW50cyB3aGljaAogICAgLy8gYXJlIG5vdCBhbGxvd2VkIHRvIGhhdmUgY2hpbGRyZW4uIFNvIHdlIGp1c3QgaWdub3JlIGl0LgogICAgZWxlbWVudC5lbXB0eSgpOwogIH0gY2F0Y2goZSkge30KICB2YXIgZWxlbUh0bWwgPSBqcUxpdGUoJzxkaXY+JykuYXBwZW5kKGVsZW1lbnQpLmh0bWwoKTsKICB0cnkgewogICAgcmV0dXJuIGVsZW1lbnRbMF0ubm9kZVR5cGUgPT09IE5PREVfVFlQRV9URVhUID8gbG93ZXJjYXNlKGVsZW1IdG1sKSA6CiAgICAgICAgZWxlbUh0bWwuCiAgICAgICAgICBtYXRjaCgvXig8W14+XSs+KS8pWzFdLgogICAgICAgICAgcmVwbGFjZSgvXjwoW1x3XC1dKykvLCBmdW5jdGlvbihtYXRjaCwgbm9kZU5hbWUpIHsgcmV0dXJuICc8JyArIGxvd2VyY2FzZShub2RlTmFtZSk7IH0pOwogIH0gY2F0Y2goZSkgewogICAgcmV0dXJuIGxvd2VyY2FzZShlbGVtSHRtbCk7CiAgfQoKfQoKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCi8qKgogKiBUcmllcyB0byBkZWNvZGUgdGhlIFVSSSBjb21wb25lbnQgd2l0aG91dCB0aHJvd2luZyBhbiBleGNlcHRpb24uCiAqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSBzdHIgdmFsdWUgcG90ZW50aWFsIFVSSSBjb21wb25lbnQgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgY2FuIGJlIGRlY29kZWQKICogd2l0aCB0aGUgZGVjb2RlVVJJQ29tcG9uZW50IGZ1bmN0aW9uLgogKi8KZnVuY3Rpb24gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKSB7CiAgdHJ5IHsKICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQodmFsdWUpOwogIH0gY2F0Y2goZSkgewogICAgLy8gSWdub3JlIGFueSBpbnZhbGlkIHVyaSBjb21wb25lbnQKICB9Cn0KCgovKioKICogUGFyc2VzIGFuIGVzY2FwZWQgdXJsIHF1ZXJ5IHN0cmluZyBpbnRvIGtleS12YWx1ZSBwYWlycy4KICogQHJldHVybnMge09iamVjdC48c3RyaW5nLGJvb2xlYW58QXJyYXk+fQogKi8KZnVuY3Rpb24gcGFyc2VLZXlWYWx1ZSgvKipzdHJpbmcqL2tleVZhbHVlKSB7CiAgdmFyIG9iaiA9IHt9LCBrZXlfdmFsdWUsIGtleTsKICBmb3JFYWNoKChrZXlWYWx1ZSB8fCAiIikuc3BsaXQoJyYnKSwgZnVuY3Rpb24oa2V5VmFsdWUpIHsKICAgIGlmICgga2V5VmFsdWUgKSB7CiAgICAgIGtleV92YWx1ZSA9IGtleVZhbHVlLnJlcGxhY2UoL1wrL2csJyUyMCcpLnNwbGl0KCc9Jyk7CiAgICAgIGtleSA9IHRyeURlY29kZVVSSUNvbXBvbmVudChrZXlfdmFsdWVbMF0pOwogICAgICBpZiAoIGlzRGVmaW5lZChrZXkpICkgewogICAgICAgIHZhciB2YWwgPSBpc0RlZmluZWQoa2V5X3ZhbHVlWzFdKSA/IHRyeURlY29kZVVSSUNvbXBvbmVudChrZXlfdmFsdWVbMV0pIDogdHJ1ZTsKICAgICAgICBpZiAoIWhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7CiAgICAgICAgICBvYmpba2V5XSA9IHZhbDsKICAgICAgICB9IGVsc2UgaWYoaXNBcnJheShvYmpba2V5XSkpIHsKICAgICAgICAgIG9ialtrZXldLnB1c2godmFsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb2JqW2tleV0gPSBbb2JqW2tleV0sdmFsXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKICByZXR1cm4gb2JqOwp9CgpmdW5jdGlvbiB0b0tleVZhbHVlKG9iaikgewogIHZhciBwYXJ0cyA9IFtdOwogIGZvckVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgZm9yRWFjaCh2YWx1ZSwgZnVuY3Rpb24oYXJyYXlWYWx1ZSkgewogICAgICAgIHBhcnRzLnB1c2goZW5jb2RlVXJpUXVlcnkoa2V5LCB0cnVlKSArCiAgICAgICAgICAgICAgICAgICAoYXJyYXlWYWx1ZSA9PT0gdHJ1ZSA/ICcnIDogJz0nICsgZW5jb2RlVXJpUXVlcnkoYXJyYXlWYWx1ZSwgdHJ1ZSkpKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgcGFydHMucHVzaChlbmNvZGVVcmlRdWVyeShrZXksIHRydWUpICsKICAgICAgICAgICAgICAgKHZhbHVlID09PSB0cnVlID8gJycgOiAnPScgKyBlbmNvZGVVcmlRdWVyeSh2YWx1ZSwgdHJ1ZSkpKTsKICAgIH0KICB9KTsKICByZXR1cm4gcGFydHMubGVuZ3RoID8gcGFydHMuam9pbignJicpIDogJyc7Cn0KCgovKioKICogV2UgbmVlZCBvdXIgY3VzdG9tIG1ldGhvZCBiZWNhdXNlIGVuY29kZVVSSUNvbXBvbmVudCBpcyB0b28gYWdncmVzc2l2ZSBhbmQgZG9lc24ndCBmb2xsb3cKICogaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMzk4Ni50eHQgd2l0aCByZWdhcmRzIHRvIHRoZSBjaGFyYWN0ZXIgc2V0IChwY2hhcikgYWxsb3dlZCBpbiBwYXRoCiAqIHNlZ21lbnRzOgogKiAgICBzZWdtZW50ICAgICAgID0gKnBjaGFyCiAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAqICAgIHBjdC1lbmNvZGVkICAgPSAiJSIgSEVYRElHIEhFWERJRwogKiAgICB1bnJlc2VydmVkICAgID0gQUxQSEEgLyBESUdJVCAvICItIiAvICIuIiAvICJfIiAvICJ+IgogKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAqICAgICAgICAgICAgICAgICAgICAgLyAiKiIgLyAiKyIgLyAiLCIgLyAiOyIgLyAiPSIKICovCmZ1bmN0aW9uIGVuY29kZVVyaVNlZ21lbnQodmFsKSB7CiAgcmV0dXJuIGVuY29kZVVyaVF1ZXJ5KHZhbCwgdHJ1ZSkuCiAgICAgICAgICAgICByZXBsYWNlKC8lMjYvZ2ksICcmJykuCiAgICAgICAgICAgICByZXBsYWNlKC8lM0QvZ2ksICc9JykuCiAgICAgICAgICAgICByZXBsYWNlKC8lMkIvZ2ksICcrJyk7Cn0KCgovKioKICogVGhpcyBtZXRob2QgaXMgaW50ZW5kZWQgZm9yIGVuY29kaW5nICprZXkqIG9yICp2YWx1ZSogcGFydHMgb2YgcXVlcnkgY29tcG9uZW50LiBXZSBuZWVkIGEgY3VzdG9tCiAqIG1ldGhvZCBiZWNhdXNlIGVuY29kZVVSSUNvbXBvbmVudCBpcyB0b28gYWdncmVzc2l2ZSBhbmQgZW5jb2RlcyBzdHVmZiB0aGF0IGRvZXNuJ3QgaGF2ZSB0byBiZQogKiBlbmNvZGVkIHBlciBodHRwOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMzOTg2OgogKiAgICBxdWVyeSAgICAgICA9ICooIHBjaGFyIC8gIi8iIC8gIj8iICkKICogICAgcGNoYXIgICAgICAgICA9IHVucmVzZXJ2ZWQgLyBwY3QtZW5jb2RlZCAvIHN1Yi1kZWxpbXMgLyAiOiIgLyAiQCIKICogICAgdW5yZXNlcnZlZCAgICA9IEFMUEhBIC8gRElHSVQgLyAiLSIgLyAiLiIgLyAiXyIgLyAifiIKICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAqICAgIHN1Yi1kZWxpbXMgICAgPSAiISIgLyAiJCIgLyAiJiIgLyAiJyIgLyAiKCIgLyAiKSIKICogICAgICAgICAgICAgICAgICAgICAvICIqIiAvICIrIiAvICIsIiAvICI7IiAvICI9IgogKi8KZnVuY3Rpb24gZW5jb2RlVXJpUXVlcnkodmFsLCBwY3RFbmNvZGVTcGFjZXMpIHsKICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHZhbCkuCiAgICAgICAgICAgICByZXBsYWNlKC8lNDAvZ2ksICdAJykuCiAgICAgICAgICAgICByZXBsYWNlKC8lM0EvZ2ksICc6JykuCiAgICAgICAgICAgICByZXBsYWNlKC8lMjQvZywgJyQnKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUyQy9naSwgJywnKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUzQi9naSwgJzsnKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUyMC9nLCAocGN0RW5jb2RlU3BhY2VzID8gJyUyMCcgOiAnKycpKTsKfQoKdmFyIG5nQXR0clByZWZpeGVzID0gWyduZy0nLCAnZGF0YS1uZy0nLCAnbmc6JywgJ3gtbmctJ107CgpmdW5jdGlvbiBnZXROZ0F0dHJpYnV0ZShlbGVtZW50LCBuZ0F0dHIpIHsKICB2YXIgYXR0ciwgaSwgaWkgPSBuZ0F0dHJQcmVmaXhlcy5sZW5ndGg7CiAgZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KTsKICBmb3IgKGk9MDsgaTxpaTsgKytpKSB7CiAgICBhdHRyID0gbmdBdHRyUHJlZml4ZXNbaV0gKyBuZ0F0dHI7CiAgICBpZiAoaXNTdHJpbmcoYXR0ciA9IGVsZW1lbnQuYXR0cihhdHRyKSkpIHsKICAgICAgcmV0dXJuIGF0dHI7CiAgICB9CiAgfQogIHJldHVybiBudWxsOwp9CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0FwcAogKiBAbW9kdWxlIG5nCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2FuZ3VsYXIuTW9kdWxlfSBuZ0FwcCBhbiBvcHRpb25hbCBhcHBsaWNhdGlvbgogKiAgIHtAbGluayBhbmd1bGFyLm1vZHVsZSBtb2R1bGV9IG5hbWUgdG8gbG9hZC4KICogQHBhcmFtIHtib29sZWFuPX0gbmdTdHJpY3REaSBpZiB0aGlzIGF0dHJpYnV0ZSBpcyBwcmVzZW50IG9uIHRoZSBhcHAgZWxlbWVudCwgdGhlIGluamVjdG9yIHdpbGwgYmUKICogICBjcmVhdGVkIGluICJzdHJpY3QtZGkiIG1vZGUuIFRoaXMgbWVhbnMgdGhhdCB0aGUgYXBwbGljYXRpb24gd2lsbCBmYWlsIHRvIGludm9rZSBmdW5jdGlvbnMgd2hpY2gKICogICBkbyBub3QgdXNlIGV4cGxpY2l0IGZ1bmN0aW9uIGFubm90YXRpb24gKGFuZCBhcmUgdGh1cyB1bnN1aXRhYmxlIGZvciBtaW5pZmljYXRpb24pLCBhcyBkZXNjcmliZWQKICogICBpbiB7QGxpbmsgZ3VpZGUvZGkgdGhlIERlcGVuZGVuY3kgSW5qZWN0aW9uIGd1aWRlfSwgYW5kIHVzZWZ1bCBkZWJ1Z2dpbmcgaW5mbyB3aWxsIGFzc2lzdCBpbgogKiAgIHRyYWNraW5nIGRvd24gdGhlIHJvb3Qgb2YgdGhlc2UgYnVncy4KICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIFVzZSB0aGlzIGRpcmVjdGl2ZSB0byAqKmF1dG8tYm9vdHN0cmFwKiogYW4gQW5ndWxhckpTIGFwcGxpY2F0aW9uLiBUaGUgYG5nQXBwYCBkaXJlY3RpdmUKICogZGVzaWduYXRlcyB0aGUgKipyb290IGVsZW1lbnQqKiBvZiB0aGUgYXBwbGljYXRpb24gYW5kIGlzIHR5cGljYWxseSBwbGFjZWQgbmVhciB0aGUgcm9vdCBlbGVtZW50CiAqIG9mIHRoZSBwYWdlIC0gZS5nLiBvbiB0aGUgYDxib2R5PmAgb3IgYDxodG1sPmAgdGFncy4KICoKICogT25seSBvbmUgQW5ndWxhckpTIGFwcGxpY2F0aW9uIGNhbiBiZSBhdXRvLWJvb3RzdHJhcHBlZCBwZXIgSFRNTCBkb2N1bWVudC4gVGhlIGZpcnN0IGBuZ0FwcGAKICogZm91bmQgaW4gdGhlIGRvY3VtZW50IHdpbGwgYmUgdXNlZCB0byBkZWZpbmUgdGhlIHJvb3QgZWxlbWVudCB0byBhdXRvLWJvb3RzdHJhcCBhcyBhbgogKiBhcHBsaWNhdGlvbi4gVG8gcnVuIG11bHRpcGxlIGFwcGxpY2F0aW9ucyBpbiBhbiBIVE1MIGRvY3VtZW50IHlvdSBtdXN0IG1hbnVhbGx5IGJvb3RzdHJhcCB0aGVtIHVzaW5nCiAqIHtAbGluayBhbmd1bGFyLmJvb3RzdHJhcH0gaW5zdGVhZC4gQW5ndWxhckpTIGFwcGxpY2F0aW9ucyBjYW5ub3QgYmUgbmVzdGVkIHdpdGhpbiBlYWNoIG90aGVyLgogKgogKiBZb3UgY2FuIHNwZWNpZnkgYW4gKipBbmd1bGFySlMgbW9kdWxlKiogdG8gYmUgdXNlZCBhcyB0aGUgcm9vdCBtb2R1bGUgZm9yIHRoZSBhcHBsaWNhdGlvbi4gIFRoaXMKICogbW9kdWxlIHdpbGwgYmUgbG9hZGVkIGludG8gdGhlIHtAbGluayBhdXRvLiRpbmplY3Rvcn0gd2hlbiB0aGUgYXBwbGljYXRpb24gaXMgYm9vdHN0cmFwcGVkIGFuZAogKiBzaG91bGQgY29udGFpbiB0aGUgYXBwbGljYXRpb24gY29kZSBuZWVkZWQgb3IgaGF2ZSBkZXBlbmRlbmNpZXMgb24gb3RoZXIgbW9kdWxlcyB0aGF0IHdpbGwKICogY29udGFpbiB0aGUgY29kZS4gU2VlIHtAbGluayBhbmd1bGFyLm1vZHVsZX0gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAqCiAqIEluIHRoZSBleGFtcGxlIGJlbG93IGlmIHRoZSBgbmdBcHBgIGRpcmVjdGl2ZSB3ZXJlIG5vdCBwbGFjZWQgb24gdGhlIGBodG1sYCBlbGVtZW50IHRoZW4gdGhlCiAqIGRvY3VtZW50IHdvdWxkIG5vdCBiZSBjb21waWxlZCwgdGhlIGBBcHBDb250cm9sbGVyYCB3b3VsZCBub3QgYmUgaW5zdGFudGlhdGVkIGFuZCB0aGUgYHt7IGErYiB9fWAKICogd291bGQgbm90IGJlIHJlc29sdmVkIHRvIGAzYC4KICoKICogYG5nQXBwYCBpcyB0aGUgZWFzaWVzdCwgYW5kIG1vc3QgY29tbW9uLCB3YXkgdG8gYm9vdHN0cmFwIGFuIGFwcGxpY2F0aW9uLgogKgogPGV4YW1wbGUgbW9kdWxlPSJuZ0FwcERlbW8iPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJuZ0FwcERlbW9Db250cm9sbGVyIj4KICAgICBJIGNhbiBhZGQ6IHt7YX19ICsge3tifX0gPSAge3sgYStiIH19CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgIGFuZ3VsYXIubW9kdWxlKCduZ0FwcERlbW8nLCBbXSkuY29udHJvbGxlcignbmdBcHBEZW1vQ29udHJvbGxlcicsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICRzY29wZS5hID0gMTsKICAgICAkc2NvcGUuYiA9IDI7CiAgIH0pOwogICA8L2ZpbGU+CiA8L2V4YW1wbGU+CiAqCiAqIFVzaW5nIGBuZ1N0cmljdERpYCwgeW91IHdvdWxkIHNlZSBzb21ldGhpbmcgbGlrZSB0aGlzOgogKgogPGV4YW1wbGUgbmctYXBwLWluY2x1ZGVkPSJ0cnVlIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctYXBwPSJuZ0FwcFN0cmljdERlbW8iIG5nLXN0cmljdC1kaT4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iR29vZENvbnRyb2xsZXIxIj4KICAgICAgICAgICBJIGNhbiBhZGQ6IHt7YX19ICsge3tifX0gPSAge3sgYStiIH19CgogICAgICAgICAgIDxwPlRoaXMgcmVuZGVycyBiZWNhdXNlIHRoZSBjb250cm9sbGVyIGRvZXMgbm90IGZhaWwgdG8KICAgICAgICAgICAgICBpbnN0YW50aWF0ZSwgYnkgdXNpbmcgZXhwbGljaXQgYW5ub3RhdGlvbiBzdHlsZSAoc2VlCiAgICAgICAgICAgICAgc2NyaXB0LmpzIGZvciBkZXRhaWxzKQogICAgICAgICAgIDwvcD4KICAgICAgIDwvZGl2PgoKICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iR29vZENvbnRyb2xsZXIyIj4KICAgICAgICAgICBOYW1lOiA8aW5wdXQgbmctbW9kZWw9Im5hbWUiPjxiciAvPgogICAgICAgICAgIEhlbGxvLCB7e25hbWV9fSEKCiAgICAgICAgICAgPHA+VGhpcyByZW5kZXJzIGJlY2F1c2UgdGhlIGNvbnRyb2xsZXIgZG9lcyBub3QgZmFpbCB0bwogICAgICAgICAgICAgIGluc3RhbnRpYXRlLCBieSB1c2luZyBleHBsaWNpdCBhbm5vdGF0aW9uIHN0eWxlCiAgICAgICAgICAgICAgKHNlZSBzY3JpcHQuanMgZm9yIGRldGFpbHMpCiAgICAgICAgICAgPC9wPgogICAgICAgPC9kaXY+CgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJCYWRDb250cm9sbGVyIj4KICAgICAgICAgICBJIGNhbiBhZGQ6IHt7YX19ICsge3tifX0gPSAge3sgYStiIH19CgogICAgICAgICAgIDxwPlRoZSBjb250cm9sbGVyIGNvdWxkIG5vdCBiZSBpbnN0YW50aWF0ZWQsIGR1ZSB0byByZWx5aW5nCiAgICAgICAgICAgICAgb24gYXV0b21hdGljIGZ1bmN0aW9uIGFubm90YXRpb25zICh3aGljaCBhcmUgZGlzYWJsZWQgaW4KICAgICAgICAgICAgICBzdHJpY3QgbW9kZSkuIEFzIHN1Y2gsIHRoZSBjb250ZW50IG9mIHRoaXMgc2VjdGlvbiBpcyBub3QKICAgICAgICAgICAgICBpbnRlcnBvbGF0ZWQsIGFuZCB0aGVyZSBzaG91bGQgYmUgYW4gZXJyb3IgaW4geW91ciB3ZWIgY29uc29sZS4KICAgICAgICAgICA8L3A+CiAgICAgICA8L2Rpdj4KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgYW5ndWxhci5tb2R1bGUoJ25nQXBwU3RyaWN0RGVtbycsIFtdKQogICAgIC8vIEJhZENvbnRyb2xsZXIgd2lsbCBmYWlsIHRvIGluc3RhbnRpYXRlLCBkdWUgdG8gcmVseWluZyBvbiBhdXRvbWF0aWMgZnVuY3Rpb24gYW5ub3RhdGlvbiwKICAgICAvLyByYXRoZXIgdGhhbiBhbiBleHBsaWNpdCBhbm5vdGF0aW9uCiAgICAgLmNvbnRyb2xsZXIoJ0JhZENvbnRyb2xsZXInLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICRzY29wZS5hID0gMTsKICAgICAgICRzY29wZS5iID0gMjsKICAgICB9KQogICAgIC8vIFVubGlrZSBCYWRDb250cm9sbGVyLCBHb29kQ29udHJvbGxlcjEgYW5kIEdvb2RDb250cm9sbGVyMiB3aWxsIG5vdCBmYWlsIHRvIGJlIGluc3RhbnRpYXRlZCwKICAgICAvLyBkdWUgdG8gdXNpbmcgZXhwbGljaXQgYW5ub3RhdGlvbnMgdXNpbmcgdGhlIGFycmF5IHN0eWxlIGFuZCAkaW5qZWN0IHByb3BlcnR5LCByZXNwZWN0aXZlbHkuCiAgICAgLmNvbnRyb2xsZXIoJ0dvb2RDb250cm9sbGVyMScsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAkc2NvcGUuYSA9IDE7CiAgICAgICAkc2NvcGUuYiA9IDI7CiAgICAgfV0pCiAgICAgLmNvbnRyb2xsZXIoJ0dvb2RDb250cm9sbGVyMicsIEdvb2RDb250cm9sbGVyMik7CiAgICAgZnVuY3Rpb24gR29vZENvbnRyb2xsZXIyKCRzY29wZSkgewogICAgICAgJHNjb3BlLm5hbWUgPSAiV29ybGQiOwogICAgIH0KICAgICBHb29kQ29udHJvbGxlcjIuJGluamVjdCA9IFsnJHNjb3BlJ107CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgZGl2W25nLWNvbnRyb2xsZXJdIHsKICAgICAgIG1hcmdpbi1ib3R0b206IDFlbTsKICAgICAgIC13ZWJraXQtYm9yZGVyLXJhZGl1czogNHB4OwogICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICAgYm9yZGVyOiAxcHggc29saWQ7CiAgICAgICBwYWRkaW5nOiAuNWVtOwogICB9CiAgIGRpdltuZy1jb250cm9sbGVyXj1Hb29kXSB7CiAgICAgICBib3JkZXItY29sb3I6ICNkNmU5YzY7CiAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZGZmMGQ4OwogICAgICAgY29sb3I6ICMzYzc2M2Q7CiAgIH0KICAgZGl2W25nLWNvbnRyb2xsZXJePUJhZF0gewogICAgICAgYm9yZGVyLWNvbG9yOiAjZWJjY2QxOwogICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2YyZGVkZTsKICAgICAgIGNvbG9yOiAjYTk0NDQyOwogICAgICAgbWFyZ2luLWJvdHRvbTogMDsKICAgfQogICA8L2ZpbGU+CiA8L2V4YW1wbGU+CiAqLwpmdW5jdGlvbiBhbmd1bGFySW5pdChlbGVtZW50LCBib290c3RyYXApIHsKICB2YXIgYXBwRWxlbWVudCwKICAgICAgbW9kdWxlLAogICAgICBjb25maWcgPSB7fTsKCiAgLy8gVGhlIGVsZW1lbnQgYGVsZW1lbnRgIGhhcyBwcmlvcml0eSBvdmVyIGFueSBvdGhlciBlbGVtZW50CiAgZm9yRWFjaChuZ0F0dHJQcmVmaXhlcywgZnVuY3Rpb24ocHJlZml4KSB7CiAgICB2YXIgbmFtZSA9IHByZWZpeCArICdhcHAnOwoKICAgIGlmICghYXBwRWxlbWVudCAmJiBlbGVtZW50Lmhhc0F0dHJpYnV0ZSAmJiBlbGVtZW50Lmhhc0F0dHJpYnV0ZShuYW1lKSkgewogICAgICBhcHBFbGVtZW50ID0gZWxlbWVudDsKICAgICAgbW9kdWxlID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICB9CiAgfSk7CiAgZm9yRWFjaChuZ0F0dHJQcmVmaXhlcywgZnVuY3Rpb24ocHJlZml4KSB7CiAgICB2YXIgbmFtZSA9IHByZWZpeCArICdhcHAnOwogICAgdmFyIGNhbmRpZGF0ZTsKCiAgICBpZiAoIWFwcEVsZW1lbnQgJiYgKGNhbmRpZGF0ZSA9IGVsZW1lbnQucXVlcnlTZWxlY3RvcignWycgKyBuYW1lLnJlcGxhY2UoJzonLCAnXFw6JykgKyAnXScpKSkgewogICAgICBhcHBFbGVtZW50ID0gY2FuZGlkYXRlOwogICAgICBtb2R1bGUgPSBjYW5kaWRhdGUuZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgfQogIH0pOwogIGlmIChhcHBFbGVtZW50KSB7CiAgICBjb25maWcuc3RyaWN0RGkgPSBnZXROZ0F0dHJpYnV0ZShhcHBFbGVtZW50LCAic3RyaWN0LWRpIikgIT09IG51bGw7CiAgICBib290c3RyYXAoYXBwRWxlbWVudCwgbW9kdWxlID8gW21vZHVsZV0gOiBbXSwgY29uZmlnKTsKICB9Cn0KCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5ib290c3RyYXAKICogQG1vZHVsZSBuZwogKiBAZGVzY3JpcHRpb24KICogVXNlIHRoaXMgZnVuY3Rpb24gdG8gbWFudWFsbHkgc3RhcnQgdXAgYW5ndWxhciBhcHBsaWNhdGlvbi4KICoKICogU2VlOiB7QGxpbmsgZ3VpZGUvYm9vdHN0cmFwIEJvb3RzdHJhcH0KICoKICogTm90ZSB0aGF0IFByb3RyYWN0b3IgYmFzZWQgZW5kLXRvLWVuZCB0ZXN0cyBjYW5ub3QgdXNlIHRoaXMgZnVuY3Rpb24gdG8gYm9vdHN0cmFwIG1hbnVhbGx5LgogKiBUaGV5IG11c3QgdXNlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdBcHAgbmdBcHB9LgogKgogKiBBbmd1bGFyIHdpbGwgZGV0ZWN0IGlmIGl0IGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBicm93c2VyIG1vcmUgdGhhbiBvbmNlIGFuZCBvbmx5IGFsbG93IHRoZQogKiBmaXJzdCBsb2FkZWQgc2NyaXB0IHRvIGJlIGJvb3RzdHJhcHBlZCBhbmQgd2lsbCByZXBvcnQgYSB3YXJuaW5nIHRvIHRoZSBicm93c2VyIGNvbnNvbGUgZm9yCiAqIGVhY2ggb2YgdGhlIHN1YnNlcXVlbnQgc2NyaXB0cy4gVGhpcyBwcmV2ZW50cyBzdHJhbmdlIHJlc3VsdHMgaW4gYXBwbGljYXRpb25zLCB3aGVyZSBvdGhlcndpc2UKICogbXVsdGlwbGUgaW5zdGFuY2VzIG9mIEFuZ3VsYXIgdHJ5IHRvIHdvcmsgb24gdGhlIERPTS4KICoKICogYGBgaHRtbAogKiA8IWRvY3R5cGUgaHRtbD4KICogPGh0bWw+CiAqIDxib2R5PgogKiA8ZGl2IG5nLWNvbnRyb2xsZXI9IldlbGNvbWVDb250cm9sbGVyIj4KICogICB7e2dyZWV0aW5nfX0KICogPC9kaXY+CiAqCiAqIDxzY3JpcHQgc3JjPSJhbmd1bGFyLmpzIj48L3NjcmlwdD4KICogPHNjcmlwdD4KICogICB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2RlbW8nLCBbXSkKICogICAuY29udHJvbGxlcignV2VsY29tZUNvbnRyb2xsZXInLCBmdW5jdGlvbigkc2NvcGUpIHsKICogICAgICAgJHNjb3BlLmdyZWV0aW5nID0gJ1dlbGNvbWUhJzsKICogICB9KTsKICogICBhbmd1bGFyLmJvb3RzdHJhcChkb2N1bWVudCwgWydkZW1vJ10pOwogKiA8L3NjcmlwdD4KICogPC9ib2R5PgogKiA8L2h0bWw+CiAqIGBgYAogKgogKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgRE9NIGVsZW1lbnQgd2hpY2ggaXMgdGhlIHJvb3Qgb2YgYW5ndWxhciBhcHBsaWNhdGlvbi4KICogQHBhcmFtIHtBcnJheTxTdHJpbmd8RnVuY3Rpb258QXJyYXk+PX0gbW9kdWxlcyBhbiBhcnJheSBvZiBtb2R1bGVzIHRvIGxvYWQgaW50byB0aGUgYXBwbGljYXRpb24uCiAqICAgICBFYWNoIGl0ZW0gaW4gdGhlIGFycmF5IHNob3VsZCBiZSB0aGUgbmFtZSBvZiBhIHByZWRlZmluZWQgbW9kdWxlIG9yIGEgKERJIGFubm90YXRlZCkKICogICAgIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBpbnZva2VkIGJ5IHRoZSBpbmplY3RvciBhcyBhIHJ1biBibG9jay4KICogICAgIFNlZToge0BsaW5rIGFuZ3VsYXIubW9kdWxlIG1vZHVsZXN9CiAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIGFuIG9iamVjdCBmb3IgZGVmaW5pbmcgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgYXBwbGljYXRpb24uIFRoZQogKiAgICAgZm9sbG93aW5nIGtleXMgYXJlIHN1cHBvcnRlZDoKICoKICogICAgIC0gYHN0cmljdERpYDogZGlzYWJsZSBhdXRvbWF0aWMgZnVuY3Rpb24gYW5ub3RhdGlvbiBmb3IgdGhlIGFwcGxpY2F0aW9uLiBUaGlzIGlzIG1lYW50IHRvCiAqICAgICAgIGFzc2lzdCBpbiBmaW5kaW5nIGJ1Z3Mgd2hpY2ggYnJlYWsgbWluaWZpZWQgY29kZS4KICoKICogQHJldHVybnMge2F1dG8uJGluamVjdG9yfSBSZXR1cm5zIHRoZSBuZXdseSBjcmVhdGVkIGluamVjdG9yIGZvciB0aGlzIGFwcC4KICovCmZ1bmN0aW9uIGJvb3RzdHJhcChlbGVtZW50LCBtb2R1bGVzLCBjb25maWcpIHsKICBpZiAoIWlzT2JqZWN0KGNvbmZpZykpIGNvbmZpZyA9IHt9OwogIHZhciBkZWZhdWx0Q29uZmlnID0gewogICAgc3RyaWN0RGk6IGZhbHNlCiAgfTsKICBjb25maWcgPSBleHRlbmQoZGVmYXVsdENvbmZpZywgY29uZmlnKTsKICB2YXIgZG9Cb290c3RyYXAgPSBmdW5jdGlvbigpIHsKICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CgogICAgaWYgKGVsZW1lbnQuaW5qZWN0b3IoKSkgewogICAgICB2YXIgdGFnID0gKGVsZW1lbnRbMF0gPT09IGRvY3VtZW50KSA/ICdkb2N1bWVudCcgOiBzdGFydGluZ1RhZyhlbGVtZW50KTsKICAgICAgLy9FbmNvZGUgYW5nbGUgYnJhY2tldHMgdG8gcHJldmVudCBpbnB1dCBmcm9tIGJlaW5nIHNhbml0aXplZCB0byBlbXB0eSBzdHJpbmcgIzg2ODMKICAgICAgdGhyb3cgbmdNaW5FcnIoCiAgICAgICAgICAnYnRzdHJwZCcsCiAgICAgICAgICAiQXBwIEFscmVhZHkgQm9vdHN0cmFwcGVkIHdpdGggdGhpcyBFbGVtZW50ICd7MH0nIiwKICAgICAgICAgIHRhZy5yZXBsYWNlKC88LywnJmx0OycpLnJlcGxhY2UoLz4vLCcmZ3Q7JykpOwogICAgfQoKICAgIG1vZHVsZXMgPSBtb2R1bGVzIHx8IFtdOwogICAgbW9kdWxlcy51bnNoaWZ0KFsnJHByb3ZpZGUnLCBmdW5jdGlvbigkcHJvdmlkZSkgewogICAgICAkcHJvdmlkZS52YWx1ZSgnJHJvb3RFbGVtZW50JywgZWxlbWVudCk7CiAgICB9XSk7CgogICAgaWYgKGNvbmZpZy5kZWJ1Z0luZm9FbmFibGVkKSB7CiAgICAgIC8vIFB1c2hpbmcgc28gdGhhdCB0aGlzIG92ZXJyaWRlcyBgZGVidWdJbmZvRW5hYmxlZGAgc2V0dGluZyBkZWZpbmVkIGluIHVzZXIncyBgbW9kdWxlc2AuCiAgICAgIG1vZHVsZXMucHVzaChbJyRjb21waWxlUHJvdmlkZXInLCBmdW5jdGlvbigkY29tcGlsZVByb3ZpZGVyKSB7CiAgICAgICAgJGNvbXBpbGVQcm92aWRlci5kZWJ1Z0luZm9FbmFibGVkKHRydWUpOwogICAgICB9XSk7CiAgICB9CgogICAgbW9kdWxlcy51bnNoaWZ0KCduZycpOwogICAgdmFyIGluamVjdG9yID0gY3JlYXRlSW5qZWN0b3IobW9kdWxlcywgY29uZmlnLnN0cmljdERpKTsKICAgIGluamVjdG9yLmludm9rZShbJyRyb290U2NvcGUnLCAnJHJvb3RFbGVtZW50JywgJyRjb21waWxlJywgJyRpbmplY3RvcicsCiAgICAgICBmdW5jdGlvbiBib290c3RyYXBBcHBseShzY29wZSwgZWxlbWVudCwgY29tcGlsZSwgaW5qZWN0b3IpIHsKICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50LmRhdGEoJyRpbmplY3RvcicsIGluamVjdG9yKTsKICAgICAgICAgIGNvbXBpbGUoZWxlbWVudCkoc2NvcGUpOwogICAgICAgIH0pOwogICAgICB9XQogICAgKTsKICAgIHJldHVybiBpbmplY3RvcjsKICB9OwoKICB2YXIgTkdfRU5BQkxFX0RFQlVHX0lORk8gPSAvXk5HX0VOQUJMRV9ERUJVR19JTkZPIS87CiAgdmFyIE5HX0RFRkVSX0JPT1RTVFJBUCA9IC9eTkdfREVGRVJfQk9PVFNUUkFQIS87CgogIGlmICh3aW5kb3cgJiYgTkdfRU5BQkxFX0RFQlVHX0lORk8udGVzdCh3aW5kb3cubmFtZSkpIHsKICAgIGNvbmZpZy5kZWJ1Z0luZm9FbmFibGVkID0gdHJ1ZTsKICAgIHdpbmRvdy5uYW1lID0gd2luZG93Lm5hbWUucmVwbGFjZShOR19FTkFCTEVfREVCVUdfSU5GTywgJycpOwogIH0KCiAgaWYgKHdpbmRvdyAmJiAhTkdfREVGRVJfQk9PVFNUUkFQLnRlc3Qod2luZG93Lm5hbWUpKSB7CiAgICByZXR1cm4gZG9Cb290c3RyYXAoKTsKICB9CgogIHdpbmRvdy5uYW1lID0gd2luZG93Lm5hbWUucmVwbGFjZShOR19ERUZFUl9CT09UU1RSQVAsICcnKTsKICBhbmd1bGFyLnJlc3VtZUJvb3RzdHJhcCA9IGZ1bmN0aW9uKGV4dHJhTW9kdWxlcykgewogICAgZm9yRWFjaChleHRyYU1vZHVsZXMsIGZ1bmN0aW9uKG1vZHVsZSkgewogICAgICBtb2R1bGVzLnB1c2gobW9kdWxlKTsKICAgIH0pOwogICAgZG9Cb290c3RyYXAoKTsKICB9Owp9CgovKioKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIucmVsb2FkV2l0aERlYnVnSW5mbwogKiBAbW9kdWxlIG5nCiAqIEBkZXNjcmlwdGlvbgogKiBVc2UgdGhpcyBmdW5jdGlvbiB0byByZWxvYWQgdGhlIGN1cnJlbnQgYXBwbGljYXRpb24gd2l0aCBkZWJ1ZyBpbmZvcm1hdGlvbiB0dXJuZWQgb24uCiAqIFRoaXMgdGFrZXMgcHJlY2VkZW5jZSBvdmVyIGEgY2FsbCB0byBgJGNvbXBpbGVQcm92aWRlci5kZWJ1Z0luZm9FbmFibGVkKGZhbHNlKWAuCiAqCiAqIFNlZSB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkZWJ1Z0luZm9FbmFibGVkfSBmb3IgbW9yZS4KICovCmZ1bmN0aW9uIHJlbG9hZFdpdGhEZWJ1Z0luZm8oKSB7CiAgd2luZG93Lm5hbWUgPSAnTkdfRU5BQkxFX0RFQlVHX0lORk8hJyArIHdpbmRvdy5uYW1lOwogIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTsKfQoKLyoqCiAqIEBuYW1lIGFuZ3VsYXIuZ2V0VGVzdGFiaWxpdHkKICogQG1vZHVsZSBuZwogKiBAZGVzY3JpcHRpb24KICogR2V0IHRoZSB0ZXN0YWJpbGl0eSBzZXJ2aWNlIGZvciB0aGUgaW5zdGFuY2Ugb2YgQW5ndWxhciBvbiB0aGUgZ2l2ZW4KICogZWxlbWVudC4KICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IERPTSBlbGVtZW50IHdoaWNoIGlzIHRoZSByb290IG9mIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAqLwpmdW5jdGlvbiBnZXRUZXN0YWJpbGl0eShyb290RWxlbWVudCkgewogIHJldHVybiBhbmd1bGFyLmVsZW1lbnQocm9vdEVsZW1lbnQpLmluamVjdG9yKCkuZ2V0KCckJHRlc3RhYmlsaXR5Jyk7Cn0KCnZhciBTTkFLRV9DQVNFX1JFR0VYUCA9IC9bQS1aXS9nOwpmdW5jdGlvbiBzbmFrZV9jYXNlKG5hbWUsIHNlcGFyYXRvcikgewogIHNlcGFyYXRvciA9IHNlcGFyYXRvciB8fCAnXyc7CiAgcmV0dXJuIG5hbWUucmVwbGFjZShTTkFLRV9DQVNFX1JFR0VYUCwgZnVuY3Rpb24obGV0dGVyLCBwb3MpIHsKICAgIHJldHVybiAocG9zID8gc2VwYXJhdG9yIDogJycpICsgbGV0dGVyLnRvTG93ZXJDYXNlKCk7CiAgfSk7Cn0KCnZhciBiaW5kSlF1ZXJ5RmlyZWQgPSBmYWxzZTsKdmFyIHNraXBEZXN0cm95T25OZXh0SlF1ZXJ5Q2xlYW5EYXRhOwpmdW5jdGlvbiBiaW5kSlF1ZXJ5KCkgewogIHZhciBvcmlnaW5hbENsZWFuRGF0YTsKCiAgaWYgKGJpbmRKUXVlcnlGaXJlZCkgewogICAgcmV0dXJuOwogIH0KCiAgLy8gYmluZCB0byBqUXVlcnkgaWYgcHJlc2VudDsKICBqUXVlcnkgPSB3aW5kb3cualF1ZXJ5OwogIC8vIFVzZSBqUXVlcnkgaWYgaXQgZXhpc3RzIHdpdGggcHJvcGVyIGZ1bmN0aW9uYWxpdHksIG90aGVyd2lzZSBkZWZhdWx0IHRvIHVzLgogIC8vIEFuZ3VsYXIgMS4yKyByZXF1aXJlcyBqUXVlcnkgMS43KyBmb3Igb24oKS9vZmYoKSBzdXBwb3J0LgogIC8vIEFuZ3VsYXIgMS4zKyB0ZWNobmljYWxseSByZXF1aXJlcyBhdCBsZWFzdCBqUXVlcnkgMi4xKyBidXQgaXQgbWF5IHdvcmsgd2l0aCBvbGRlcgogIC8vIHZlcnNpb25zLiBJdCB3aWxsIG5vdCB3b3JrIGZvciBzdXJlIHdpdGggalF1ZXJ5IDwxLjcsIHRob3VnaC4KICBpZiAoalF1ZXJ5ICYmIGpRdWVyeS5mbi5vbikgewogICAganFMaXRlID0galF1ZXJ5OwogICAgZXh0ZW5kKGpRdWVyeS5mbiwgewogICAgICBzY29wZTogSlFMaXRlUHJvdG90eXBlLnNjb3BlLAogICAgICBpc29sYXRlU2NvcGU6IEpRTGl0ZVByb3RvdHlwZS5pc29sYXRlU2NvcGUsCiAgICAgIGNvbnRyb2xsZXI6IEpRTGl0ZVByb3RvdHlwZS5jb250cm9sbGVyLAogICAgICBpbmplY3RvcjogSlFMaXRlUHJvdG90eXBlLmluamVjdG9yLAogICAgICBpbmhlcml0ZWREYXRhOiBKUUxpdGVQcm90b3R5cGUuaW5oZXJpdGVkRGF0YQogICAgfSk7CgogICAgLy8gQWxsIG5vZGVzIHJlbW92ZWQgZnJvbSB0aGUgRE9NIHZpYSB2YXJpb3VzIGpRdWVyeSBBUElzIGxpa2UgLnJlbW92ZSgpCiAgICAvLyBhcmUgcGFzc2VkIHRocm91Z2ggalF1ZXJ5LmNsZWFuRGF0YS4gTW9ua2V5LXBhdGNoIHRoaXMgbWV0aG9kIHRvIGZpcmUKICAgIC8vIHRoZSAkZGVzdHJveSBldmVudCBvbiBhbGwgcmVtb3ZlZCBub2Rlcy4KICAgIG9yaWdpbmFsQ2xlYW5EYXRhID0galF1ZXJ5LmNsZWFuRGF0YTsKICAgIGpRdWVyeS5jbGVhbkRhdGEgPSBmdW5jdGlvbihlbGVtcykgewogICAgICB2YXIgZXZlbnRzOwogICAgICBpZiAoIXNraXBEZXN0cm95T25OZXh0SlF1ZXJ5Q2xlYW5EYXRhKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKykgewogICAgICAgICAgZXZlbnRzID0galF1ZXJ5Ll9kYXRhKGVsZW0sICJldmVudHMiKTsKICAgICAgICAgIGlmIChldmVudHMgJiYgZXZlbnRzLiRkZXN0cm95KSB7CiAgICAgICAgICAgIGpRdWVyeShlbGVtKS50cmlnZ2VySGFuZGxlcignJGRlc3Ryb3knKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2tpcERlc3Ryb3lPbk5leHRKUXVlcnlDbGVhbkRhdGEgPSBmYWxzZTsKICAgICAgfQogICAgICBvcmlnaW5hbENsZWFuRGF0YShlbGVtcyk7CiAgICB9OwogIH0gZWxzZSB7CiAgICBqcUxpdGUgPSBKUUxpdGU7CiAgfQoKICBhbmd1bGFyLmVsZW1lbnQgPSBqcUxpdGU7CgogIC8vIFByZXZlbnQgZG91YmxlLXByb3h5aW5nLgogIGJpbmRKUXVlcnlGaXJlZCA9IHRydWU7Cn0KCi8qKgogKiB0aHJvdyBlcnJvciBpZiB0aGUgYXJndW1lbnQgaXMgZmFsc3kuCiAqLwpmdW5jdGlvbiBhc3NlcnRBcmcoYXJnLCBuYW1lLCByZWFzb24pIHsKICBpZiAoIWFyZykgewogICAgdGhyb3cgbmdNaW5FcnIoJ2FyZXEnLCAiQXJndW1lbnQgJ3swfScgaXMgezF9IiwgKG5hbWUgfHwgJz8nKSwgKHJlYXNvbiB8fCAicmVxdWlyZWQiKSk7CiAgfQogIHJldHVybiBhcmc7Cn0KCmZ1bmN0aW9uIGFzc2VydEFyZ0ZuKGFyZywgbmFtZSwgYWNjZXB0QXJyYXlBbm5vdGF0aW9uKSB7CiAgaWYgKGFjY2VwdEFycmF5QW5ub3RhdGlvbiAmJiBpc0FycmF5KGFyZykpIHsKICAgICAgYXJnID0gYXJnW2FyZy5sZW5ndGggLSAxXTsKICB9CgogIGFzc2VydEFyZyhpc0Z1bmN0aW9uKGFyZyksIG5hbWUsICdub3QgYSBmdW5jdGlvbiwgZ290ICcgKwogICAgICAoYXJnICYmIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnID8gYXJnLmNvbnN0cnVjdG9yLm5hbWUgfHwgJ09iamVjdCcgOiB0eXBlb2YgYXJnKSk7CiAgcmV0dXJuIGFyZzsKfQoKLyoqCiAqIHRocm93IGVycm9yIGlmIHRoZSBuYW1lIGdpdmVuIGlzIGhhc093blByb3BlcnR5CiAqIEBwYXJhbSAge1N0cmluZ30gbmFtZSAgICB0aGUgbmFtZSB0byB0ZXN0CiAqIEBwYXJhbSAge1N0cmluZ30gY29udGV4dCB0aGUgY29udGV4dCBpbiB3aGljaCB0aGUgbmFtZSBpcyB1c2VkLCBzdWNoIGFzIG1vZHVsZSBvciBkaXJlY3RpdmUKICovCmZ1bmN0aW9uIGFzc2VydE5vdEhhc093blByb3BlcnR5KG5hbWUsIGNvbnRleHQpIHsKICBpZiAobmFtZSA9PT0gJ2hhc093blByb3BlcnR5JykgewogICAgdGhyb3cgbmdNaW5FcnIoJ2JhZG5hbWUnLCAiaGFzT3duUHJvcGVydHkgaXMgbm90IGEgdmFsaWQgezB9IG5hbWUiLCBjb250ZXh0KTsKICB9Cn0KCi8qKgogKiBSZXR1cm4gdGhlIHZhbHVlIGFjY2Vzc2libGUgZnJvbSB0aGUgb2JqZWN0IGJ5IHBhdGguIEFueSB1bmRlZmluZWQgdHJhdmVyc2FscyBhcmUgaWdub3JlZAogKiBAcGFyYW0ge09iamVjdH0gb2JqIHN0YXJ0aW5nIG9iamVjdAogKiBAcGFyYW0ge1N0cmluZ30gcGF0aCBwYXRoIHRvIHRyYXZlcnNlCiAqIEBwYXJhbSB7Ym9vbGVhbn0gW2JpbmRGblRvU2NvcGU9dHJ1ZV0KICogQHJldHVybnMge09iamVjdH0gdmFsdWUgYXMgYWNjZXNzaWJsZSBieSBwYXRoCiAqLwovL1RPRE8obWlza28pOiB0aGlzIGZ1bmN0aW9uIG5lZWRzIHRvIGJlIHJlbW92ZWQKZnVuY3Rpb24gZ2V0dGVyKG9iaiwgcGF0aCwgYmluZEZuVG9TY29wZSkgewogIGlmICghcGF0aCkgcmV0dXJuIG9iajsKICB2YXIga2V5cyA9IHBhdGguc3BsaXQoJy4nKTsKICB2YXIga2V5OwogIHZhciBsYXN0SW5zdGFuY2UgPSBvYmo7CiAgdmFyIGxlbiA9IGtleXMubGVuZ3RoOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICBrZXkgPSBrZXlzW2ldOwogICAgaWYgKG9iaikgewogICAgICBvYmogPSAobGFzdEluc3RhbmNlID0gb2JqKVtrZXldOwogICAgfQogIH0KICBpZiAoIWJpbmRGblRvU2NvcGUgJiYgaXNGdW5jdGlvbihvYmopKSB7CiAgICByZXR1cm4gYmluZChsYXN0SW5zdGFuY2UsIG9iaik7CiAgfQogIHJldHVybiBvYmo7Cn0KCi8qKgogKiBSZXR1cm4gdGhlIERPTSBzaWJsaW5ncyBiZXR3ZWVuIHRoZSBmaXJzdCBhbmQgbGFzdCBub2RlIGluIHRoZSBnaXZlbiBhcnJheS4KICogQHBhcmFtIHtBcnJheX0gYXJyYXkgbGlrZSBvYmplY3QKICogQHJldHVybnMge2pxTGl0ZX0ganFMaXRlIGNvbGxlY3Rpb24gY29udGFpbmluZyB0aGUgbm9kZXMKICovCmZ1bmN0aW9uIGdldEJsb2NrTm9kZXMobm9kZXMpIHsKICAvLyBUT0RPKHBlcmYpOiBqdXN0IGNoZWNrIGlmIGFsbCBpdGVtcyBpbiBgbm9kZXNgIGFyZSBzaWJsaW5ncyBhbmQgaWYgdGhleSBhcmUgcmV0dXJuIHRoZSBvcmlnaW5hbAogIC8vICAgICAgICAgICAgIGNvbGxlY3Rpb24sIG90aGVyd2lzZSB1cGRhdGUgdGhlIG9yaWdpbmFsIGNvbGxlY3Rpb24uCiAgdmFyIG5vZGUgPSBub2Rlc1swXTsKICB2YXIgZW5kTm9kZSA9IG5vZGVzW25vZGVzLmxlbmd0aCAtIDFdOwogIHZhciBibG9ja05vZGVzID0gW25vZGVdOwoKICBkbyB7CiAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgIGlmICghbm9kZSkgYnJlYWs7CiAgICBibG9ja05vZGVzLnB1c2gobm9kZSk7CiAgfSB3aGlsZSAobm9kZSAhPT0gZW5kTm9kZSk7CgogIHJldHVybiBqcUxpdGUoYmxvY2tOb2Rlcyk7Cn0KCgovKioKICogQ3JlYXRlcyBhIG5ldyBvYmplY3Qgd2l0aG91dCBhIHByb3RvdHlwZS4gVGhpcyBvYmplY3QgaXMgdXNlZnVsIGZvciBsb29rdXAgd2l0aG91dCBoYXZpbmcgdG8KICogZ3VhcmQgYWdhaW5zdCBwcm90b3R5cGljYWxseSBpbmhlcml0ZWQgcHJvcGVydGllcyB2aWEgaGFzT3duUHJvcGVydHkuCiAqCiAqIFJlbGF0ZWQgbWljcm8tYmVuY2htYXJrczoKICogLSBodHRwOi8vanNwZXJmLmNvbS9vYmplY3QtY3JlYXRlMgogKiAtIGh0dHA6Ly9qc3BlcmYuY29tL3Byb3RvLW1hcC1sb29rdXAvMgogKiAtIGh0dHA6Ly9qc3BlcmYuY29tL2Zvci1pbi12cy1vYmplY3Qta2V5czIKICoKICogQHJldHVybnMge09iamVjdH0KICovCmZ1bmN0aW9uIGNyZWF0ZU1hcCgpIHsKICByZXR1cm4gT2JqZWN0LmNyZWF0ZShudWxsKTsKfQoKdmFyIE5PREVfVFlQRV9FTEVNRU5UID0gMTsKdmFyIE5PREVfVFlQRV9URVhUID0gMzsKdmFyIE5PREVfVFlQRV9DT01NRU5UID0gODsKdmFyIE5PREVfVFlQRV9ET0NVTUVOVCA9IDk7CnZhciBOT0RFX1RZUEVfRE9DVU1FTlRfRlJBR01FTlQgPSAxMTsKCi8qKgogKiBAbmdkb2MgdHlwZQogKiBAbmFtZSBhbmd1bGFyLk1vZHVsZQogKiBAbW9kdWxlIG5nCiAqIEBkZXNjcmlwdGlvbgogKgogKiBJbnRlcmZhY2UgZm9yIGNvbmZpZ3VyaW5nIGFuZ3VsYXIge0BsaW5rIGFuZ3VsYXIubW9kdWxlIG1vZHVsZXN9LgogKi8KCmZ1bmN0aW9uIHNldHVwTW9kdWxlTG9hZGVyKHdpbmRvdykgewoKICB2YXIgJGluamVjdG9yTWluRXJyID0gbWluRXJyKCckaW5qZWN0b3InKTsKICB2YXIgbmdNaW5FcnIgPSBtaW5FcnIoJ25nJyk7CgogIGZ1bmN0aW9uIGVuc3VyZShvYmosIG5hbWUsIGZhY3RvcnkpIHsKICAgIHJldHVybiBvYmpbbmFtZV0gfHwgKG9ialtuYW1lXSA9IGZhY3RvcnkoKSk7CiAgfQoKICB2YXIgYW5ndWxhciA9IGVuc3VyZSh3aW5kb3csICdhbmd1bGFyJywgT2JqZWN0KTsKCiAgLy8gV2UgbmVlZCB0byBleHBvc2UgYGFuZ3VsYXIuJCRtaW5FcnJgIHRvIG1vZHVsZXMgc3VjaCBhcyBgbmdSZXNvdXJjZWAgdGhhdCByZWZlcmVuY2UgaXQgZHVyaW5nIGJvb3RzdHJhcAogIGFuZ3VsYXIuJCRtaW5FcnIgPSBhbmd1bGFyLiQkbWluRXJyIHx8IG1pbkVycjsKCiAgcmV0dXJuIGVuc3VyZShhbmd1bGFyLCAnbW9kdWxlJywgZnVuY3Rpb24oKSB7CiAgICAvKiogQHR5cGUge09iamVjdC48c3RyaW5nLCBhbmd1bGFyLk1vZHVsZT59ICovCiAgICB2YXIgbW9kdWxlcyA9IHt9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLm1vZHVsZQogICAgICogQG1vZHVsZSBuZwogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVGhlIGBhbmd1bGFyLm1vZHVsZWAgaXMgYSBnbG9iYWwgcGxhY2UgZm9yIGNyZWF0aW5nLCByZWdpc3RlcmluZyBhbmQgcmV0cmlldmluZyBBbmd1bGFyCiAgICAgKiBtb2R1bGVzLgogICAgICogQWxsIG1vZHVsZXMgKGFuZ3VsYXIgY29yZSBvciAzcmQgcGFydHkpIHRoYXQgc2hvdWxkIGJlIGF2YWlsYWJsZSB0byBhbiBhcHBsaWNhdGlvbiBtdXN0IGJlCiAgICAgKiByZWdpc3RlcmVkIHVzaW5nIHRoaXMgbWVjaGFuaXNtLgogICAgICoKICAgICAqIFdoZW4gcGFzc2VkIHR3byBvciBtb3JlIGFyZ3VtZW50cywgYSBuZXcgbW9kdWxlIGlzIGNyZWF0ZWQuICBJZiBwYXNzZWQgb25seSBvbmUgYXJndW1lbnQsIGFuCiAgICAgKiBleGlzdGluZyBtb2R1bGUgKHRoZSBuYW1lIHBhc3NlZCBhcyB0aGUgZmlyc3QgYXJndW1lbnQgdG8gYG1vZHVsZWApIGlzIHJldHJpZXZlZC4KICAgICAqCiAgICAgKgogICAgICogIyBNb2R1bGUKICAgICAqCiAgICAgKiBBIG1vZHVsZSBpcyBhIGNvbGxlY3Rpb24gb2Ygc2VydmljZXMsIGRpcmVjdGl2ZXMsIGNvbnRyb2xsZXJzLCBmaWx0ZXJzLCBhbmQgY29uZmlndXJhdGlvbiBpbmZvcm1hdGlvbi4KICAgICAqIGBhbmd1bGFyLm1vZHVsZWAgaXMgdXNlZCB0byBjb25maWd1cmUgdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LgogICAgICoKICAgICAqIGBgYGpzCiAgICAgKiAvLyBDcmVhdGUgYSBuZXcgbW9kdWxlCiAgICAgKiB2YXIgbXlNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgnbXlNb2R1bGUnLCBbXSk7CiAgICAgKgogICAgICogLy8gcmVnaXN0ZXIgYSBuZXcgc2VydmljZQogICAgICogbXlNb2R1bGUudmFsdWUoJ2FwcE5hbWUnLCAnTXlDb29sQXBwJyk7CiAgICAgKgogICAgICogLy8gY29uZmlndXJlIGV4aXN0aW5nIHNlcnZpY2VzIGluc2lkZSBpbml0aWFsaXphdGlvbiBibG9ja3MuCiAgICAgKiBteU1vZHVsZS5jb25maWcoWyckbG9jYXRpb25Qcm92aWRlcicsIGZ1bmN0aW9uKCRsb2NhdGlvblByb3ZpZGVyKSB7CiAgICAgKiAgIC8vIENvbmZpZ3VyZSBleGlzdGluZyBwcm92aWRlcnMKICAgICAqICAgJGxvY2F0aW9uUHJvdmlkZXIuaGFzaFByZWZpeCgnIScpOwogICAgICogfV0pOwogICAgICogYGBgCiAgICAgKgogICAgICogVGhlbiB5b3UgY2FuIGNyZWF0ZSBhbiBpbmplY3RvciBhbmQgbG9hZCB5b3VyIG1vZHVsZXMgbGlrZSB0aGlzOgogICAgICoKICAgICAqIGBgYGpzCiAgICAgKiB2YXIgaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKFsnbmcnLCAnbXlNb2R1bGUnXSkKICAgICAqIGBgYAogICAgICoKICAgICAqIEhvd2V2ZXIgaXQncyBtb3JlIGxpa2VseSB0aGF0IHlvdSdsbCBqdXN0IHVzZQogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0FwcCBuZ0FwcH0gb3IKICAgICAqIHtAbGluayBhbmd1bGFyLmJvb3RzdHJhcH0gdG8gc2ltcGxpZnkgdGhpcyBwcm9jZXNzIGZvciB5b3UuCiAgICAgKgogICAgICogQHBhcmFtIHshc3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBtb2R1bGUgdG8gY3JlYXRlIG9yIHJldHJpZXZlLgogICAgICogQHBhcmFtIHshQXJyYXkuPHN0cmluZz49fSByZXF1aXJlcyBJZiBzcGVjaWZpZWQgdGhlbiBuZXcgbW9kdWxlIGlzIGJlaW5nIGNyZWF0ZWQuIElmCiAgICAgKiAgICAgICAgdW5zcGVjaWZpZWQgdGhlbiB0aGUgbW9kdWxlIGlzIGJlaW5nIHJldHJpZXZlZCBmb3IgZnVydGhlciBjb25maWd1cmF0aW9uLgogICAgICogQHBhcmFtIHtGdW5jdGlvbj19IGNvbmZpZ0ZuIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gZm9yIHRoZSBtb2R1bGUuIFNhbWUgYXMKICAgICAqICAgICAgICB7QGxpbmsgYW5ndWxhci5Nb2R1bGUjY29uZmlnIE1vZHVsZSNjb25maWcoKX0uCiAgICAgKiBAcmV0dXJucyB7bW9kdWxlfSBuZXcgbW9kdWxlIHdpdGggdGhlIHtAbGluayBhbmd1bGFyLk1vZHVsZX0gYXBpLgogICAgICovCiAgICByZXR1cm4gZnVuY3Rpb24gbW9kdWxlKG5hbWUsIHJlcXVpcmVzLCBjb25maWdGbikgewogICAgICB2YXIgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkgPSBmdW5jdGlvbihuYW1lLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKG5hbWUgPT09ICdoYXNPd25Qcm9wZXJ0eScpIHsKICAgICAgICAgIHRocm93IG5nTWluRXJyKCdiYWRuYW1lJywgJ2hhc093blByb3BlcnR5IGlzIG5vdCBhIHZhbGlkIHswfSBuYW1lJywgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkobmFtZSwgJ21vZHVsZScpOwogICAgICBpZiAocmVxdWlyZXMgJiYgbW9kdWxlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIG1vZHVsZXNbbmFtZV0gPSBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBlbnN1cmUobW9kdWxlcywgbmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFyZXF1aXJlcykgewogICAgICAgICAgdGhyb3cgJGluamVjdG9yTWluRXJyKCdub21vZCcsICJNb2R1bGUgJ3swfScgaXMgbm90IGF2YWlsYWJsZSEgWW91IGVpdGhlciBtaXNzcGVsbGVkICIgKwogICAgICAgICAgICAgInRoZSBtb2R1bGUgbmFtZSBvciBmb3Jnb3QgdG8gbG9hZCBpdC4gSWYgcmVnaXN0ZXJpbmcgYSBtb2R1bGUgZW5zdXJlIHRoYXQgeW91ICIgKwogICAgICAgICAgICAgInNwZWNpZnkgdGhlIGRlcGVuZGVuY2llcyBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50LiIsIG5hbWUpOwogICAgICAgIH0KCiAgICAgICAgLyoqIEB0eXBlIHshQXJyYXkuPEFycmF5LjwqPj59ICovCiAgICAgICAgdmFyIGludm9rZVF1ZXVlID0gW107CgogICAgICAgIC8qKiBAdHlwZSB7IUFycmF5LjxGdW5jdGlvbj59ICovCiAgICAgICAgdmFyIGNvbmZpZ0Jsb2NrcyA9IFtdOwoKICAgICAgICAvKiogQHR5cGUgeyFBcnJheS48RnVuY3Rpb24+fSAqLwogICAgICAgIHZhciBydW5CbG9ja3MgPSBbXTsKCiAgICAgICAgdmFyIGNvbmZpZyA9IGludm9rZUxhdGVyKCckaW5qZWN0b3InLCAnaW52b2tlJywgJ3B1c2gnLCBjb25maWdCbG9ja3MpOwoKICAgICAgICAvKiogQHR5cGUge2FuZ3VsYXIuTW9kdWxlfSAqLwogICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IHsKICAgICAgICAgIC8vIFByaXZhdGUgc3RhdGUKICAgICAgICAgIF9pbnZva2VRdWV1ZTogaW52b2tlUXVldWUsCiAgICAgICAgICBfY29uZmlnQmxvY2tzOiBjb25maWdCbG9ja3MsCiAgICAgICAgICBfcnVuQmxvY2tzOiBydW5CbG9ja3MsCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3JlcXVpcmVzCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBIb2xkcyB0aGUgbGlzdCBvZiBtb2R1bGVzIHdoaWNoIHRoZSBpbmplY3RvciB3aWxsIGxvYWQgYmVmb3JlIHRoZSBjdXJyZW50IG1vZHVsZSBpcwogICAgICAgICAgICogbG9hZGVkLgogICAgICAgICAgICovCiAgICAgICAgICByZXF1aXJlczogcmVxdWlyZXMsCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI25hbWUKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIE5hbWUgb2YgdGhlIG1vZHVsZS4KICAgICAgICAgICAqLwogICAgICAgICAgbmFtZTogbmFtZSwKCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNwcm92aWRlcgogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcm92aWRlclR5cGUgQ29uc3RydWN0aW9uIGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgdGhlCiAgICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmljZS4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogU2VlIHtAbGluayBhdXRvLiRwcm92aWRlI3Byb3ZpZGVyICRwcm92aWRlLnByb3ZpZGVyKCl9LgogICAgICAgICAgICovCiAgICAgICAgICBwcm92aWRlcjogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ3Byb3ZpZGVyJyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNmYWN0b3J5CiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByb3ZpZGVyRnVuY3Rpb24gRnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiB0aGUgc2VydmljZS4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogU2VlIHtAbGluayBhdXRvLiRwcm92aWRlI2ZhY3RvcnkgJHByb3ZpZGUuZmFjdG9yeSgpfS4KICAgICAgICAgICAqLwogICAgICAgICAgZmFjdG9yeTogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ2ZhY3RvcnknKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3NlcnZpY2UKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQSBjb25zdHJ1Y3RvciBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgaW5zdGFudGlhdGVkLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBTZWUge0BsaW5rIGF1dG8uJHByb3ZpZGUjc2VydmljZSAkcHJvdmlkZS5zZXJ2aWNlKCl9LgogICAgICAgICAgICovCiAgICAgICAgICBzZXJ2aWNlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnc2VydmljZScpLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjdmFsdWUKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICogQHBhcmFtIHsqfSBvYmplY3QgU2VydmljZSBpbnN0YW5jZSBvYmplY3QuCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFNlZSB7QGxpbmsgYXV0by4kcHJvdmlkZSN2YWx1ZSAkcHJvdmlkZS52YWx1ZSgpfS4KICAgICAgICAgICAqLwogICAgICAgICAgdmFsdWU6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICd2YWx1ZScpLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29uc3RhbnQKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIGNvbnN0YW50IG5hbWUKICAgICAgICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IENvbnN0YW50IHZhbHVlLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBCZWNhdXNlIHRoZSBjb25zdGFudCBhcmUgZml4ZWQsIHRoZXkgZ2V0IGFwcGxpZWQgYmVmb3JlIG90aGVyIHByb3ZpZGUgbWV0aG9kcy4KICAgICAgICAgICAqIFNlZSB7QGxpbmsgYXV0by4kcHJvdmlkZSNjb25zdGFudCAkcHJvdmlkZS5jb25zdGFudCgpfS4KICAgICAgICAgICAqLwogICAgICAgICAgY29uc3RhbnQ6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdjb25zdGFudCcsICd1bnNoaWZ0JyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNhbmltYXRpb24KICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIGFuaW1hdGlvbiBuYW1lCiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBhbmltYXRpb25GYWN0b3J5IEZhY3RvcnkgZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiBhbgogICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmltYXRpb24uCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiAqKk5PVEUqKjogYW5pbWF0aW9ucyB0YWtlIGVmZmVjdCBvbmx5IGlmIHRoZSAqKm5nQW5pbWF0ZSoqIG1vZHVsZSBpcyBsb2FkZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICoKICAgICAgICAgICAqIERlZmluZXMgYW4gYW5pbWF0aW9uIGhvb2sgdGhhdCBjYW4gYmUgbGF0ZXIgdXNlZCB3aXRoCiAgICAgICAgICAgKiB7QGxpbmsgbmdBbmltYXRlLiRhbmltYXRlICRhbmltYXRlfSBzZXJ2aWNlIGFuZCBkaXJlY3RpdmVzIHRoYXQgdXNlIHRoaXMgc2VydmljZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBgYGBqcwogICAgICAgICAgICogbW9kdWxlLmFuaW1hdGlvbignLmFuaW1hdGlvbi1uYW1lJywgZnVuY3Rpb24oJGluamVjdDEsICRpbmplY3QyKSB7CiAgICAgICAgICAgKiAgIHJldHVybiB7CiAgICAgICAgICAgKiAgICAgZXZlbnROYW1lIDogZnVuY3Rpb24oZWxlbWVudCwgZG9uZSkgewogICAgICAgICAgICogICAgICAgLy9jb2RlIHRvIHJ1biB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgKiAgICAgICAvL29uY2UgY29tcGxldGUsIHRoZW4gcnVuIGRvbmUoKQogICAgICAgICAgICogICAgICAgcmV0dXJuIGZ1bmN0aW9uIGNhbmNlbGxhdGlvbkZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAqICAgICAgICAgLy9jb2RlIHRvIGNhbmNlbCB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgKiAgICAgICB9CiAgICAgICAgICAgKiAgICAgfQogICAgICAgICAgICogICB9CiAgICAgICAgICAgKiB9KQogICAgICAgICAgICogYGBgCiAgICAgICAgICAgKgogICAgICAgICAgICogU2VlIHtAbGluayBuZy4kYW5pbWF0ZVByb3ZpZGVyI3JlZ2lzdGVyICRhbmltYXRlUHJvdmlkZXIucmVnaXN0ZXIoKX0gYW5kCiAgICAgICAgICAgKiB7QGxpbmsgbmdBbmltYXRlIG5nQW5pbWF0ZSBtb2R1bGV9IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICAgICAgICovCiAgICAgICAgICBhbmltYXRpb246IGludm9rZUxhdGVyKCckYW5pbWF0ZVByb3ZpZGVyJywgJ3JlZ2lzdGVyJyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNmaWx0ZXIKICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEZpbHRlciBuYW1lLgogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZmlsdGVyRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgZmlsdGVyLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRmaWx0ZXJQcm92aWRlciNyZWdpc3RlciAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoKX0uCiAgICAgICAgICAgKi8KICAgICAgICAgIGZpbHRlcjogaW52b2tlTGF0ZXIoJyRmaWx0ZXJQcm92aWRlcicsICdyZWdpc3RlcicpLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29udHJvbGxlcgogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fSBuYW1lIENvbnRyb2xsZXIgbmFtZSwgb3IgYW4gb2JqZWN0IG1hcCBvZiBjb250cm9sbGVycyB3aGVyZSB0aGUKICAgICAgICAgICAqICAgIGtleXMgYXJlIHRoZSBuYW1lcyBhbmQgdGhlIHZhbHVlcyBhcmUgdGhlIGNvbnN0cnVjdG9ycy4KICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGNvbnRyb2xsZXJQcm92aWRlciNyZWdpc3RlciAkY29udHJvbGxlclByb3ZpZGVyLnJlZ2lzdGVyKCl9LgogICAgICAgICAgICovCiAgICAgICAgICBjb250cm9sbGVyOiBpbnZva2VMYXRlcignJGNvbnRyb2xsZXJQcm92aWRlcicsICdyZWdpc3RlcicpLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZGlyZWN0aXZlCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R9IG5hbWUgRGlyZWN0aXZlIG5hbWUsIG9yIGFuIG9iamVjdCBtYXAgb2YgZGlyZWN0aXZlcyB3aGVyZSB0aGUKICAgICAgICAgICAqICAgIGtleXMgYXJlIHRoZSBuYW1lcyBhbmQgdGhlIHZhbHVlcyBhcmUgdGhlIGZhY3Rvcmllcy4KICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGRpcmVjdGl2ZUZhY3RvcnkgRmFjdG9yeSBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mCiAgICAgICAgICAgKiBkaXJlY3RpdmVzLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlICRjb21waWxlUHJvdmlkZXIuZGlyZWN0aXZlKCl9LgogICAgICAgICAgICovCiAgICAgICAgICBkaXJlY3RpdmU6IGludm9rZUxhdGVyKCckY29tcGlsZVByb3ZpZGVyJywgJ2RpcmVjdGl2ZScpLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29uZmlnCiAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25maWdGbiBFeGVjdXRlIHRoaXMgZnVuY3Rpb24gb24gbW9kdWxlIGxvYWQuIFVzZWZ1bCBmb3Igc2VydmljZQogICAgICAgICAgICogICAgY29uZmlndXJhdGlvbi4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogVXNlIHRoaXMgbWV0aG9kIHRvIHJlZ2lzdGVyIHdvcmsgd2hpY2ggbmVlZHMgdG8gYmUgcGVyZm9ybWVkIG9uIG1vZHVsZSBsb2FkaW5nLgogICAgICAgICAgICogRm9yIG1vcmUgYWJvdXQgaG93IHRvIGNvbmZpZ3VyZSBzZXJ2aWNlcywgc2VlCiAgICAgICAgICAgKiB7QGxpbmsgcHJvdmlkZXJzI3Byb3ZpZGVyLXJlY2lwZSBQcm92aWRlciBSZWNpcGV9LgogICAgICAgICAgICovCiAgICAgICAgICBjb25maWc6IGNvbmZpZywKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3J1bgogICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gaW5pdGlhbGl6YXRpb25GbiBFeGVjdXRlIHRoaXMgZnVuY3Rpb24gYWZ0ZXIgaW5qZWN0b3IgY3JlYXRpb24uCiAgICAgICAgICAgKiAgICBVc2VmdWwgZm9yIGFwcGxpY2F0aW9uIGluaXRpYWxpemF0aW9uLgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBVc2UgdGhpcyBtZXRob2QgdG8gcmVnaXN0ZXIgd29yayB3aGljaCBzaG91bGQgYmUgcGVyZm9ybWVkIHdoZW4gdGhlIGluamVjdG9yIGlzIGRvbmUKICAgICAgICAgICAqIGxvYWRpbmcgYWxsIG1vZHVsZXMuCiAgICAgICAgICAgKi8KICAgICAgICAgIHJ1bjogZnVuY3Rpb24oYmxvY2spIHsKICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2goYmxvY2spOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBpZiAoY29uZmlnRm4pIHsKICAgICAgICAgIGNvbmZpZyhjb25maWdGbik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gIG1vZHVsZUluc3RhbmNlOwoKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvdmlkZXIKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmc9fSBpbnNlcnRNZXRob2QKICAgICAgICAgKiBAcmV0dXJucyB7YW5ndWxhci5Nb2R1bGV9CiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF0ZXIocHJvdmlkZXIsIG1ldGhvZCwgaW5zZXJ0TWV0aG9kLCBxdWV1ZSkgewogICAgICAgICAgaWYgKCFxdWV1ZSkgcXVldWUgPSBpbnZva2VRdWV1ZTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcXVldWVbaW5zZXJ0TWV0aG9kIHx8ICdwdXNoJ10oW3Byb3ZpZGVyLCBtZXRob2QsIGFyZ3VtZW50c10pOwogICAgICAgICAgICByZXR1cm4gbW9kdWxlSW5zdGFuY2U7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9OwogIH0pOwoKfQoKLyogZ2xvYmFsIGFuZ3VsYXJNb2R1bGU6IHRydWUsCiAgdmVyc2lvbjogdHJ1ZSwKCiAgJExvY2FsZVByb3ZpZGVyLAogICRDb21waWxlUHJvdmlkZXIsCgogIGh0bWxBbmNob3JEaXJlY3RpdmUsCiAgaW5wdXREaXJlY3RpdmUsCiAgaW5wdXREaXJlY3RpdmUsCiAgZm9ybURpcmVjdGl2ZSwKICBzY3JpcHREaXJlY3RpdmUsCiAgc2VsZWN0RGlyZWN0aXZlLAogIHN0eWxlRGlyZWN0aXZlLAogIG9wdGlvbkRpcmVjdGl2ZSwKICBuZ0JpbmREaXJlY3RpdmUsCiAgbmdCaW5kSHRtbERpcmVjdGl2ZSwKICBuZ0JpbmRUZW1wbGF0ZURpcmVjdGl2ZSwKICBuZ0NsYXNzRGlyZWN0aXZlLAogIG5nQ2xhc3NFdmVuRGlyZWN0aXZlLAogIG5nQ2xhc3NPZGREaXJlY3RpdmUsCiAgbmdDc3BEaXJlY3RpdmUsCiAgbmdDbG9ha0RpcmVjdGl2ZSwKICBuZ0NvbnRyb2xsZXJEaXJlY3RpdmUsCiAgbmdGb3JtRGlyZWN0aXZlLAogIG5nSGlkZURpcmVjdGl2ZSwKICBuZ0lmRGlyZWN0aXZlLAogIG5nSW5jbHVkZURpcmVjdGl2ZSwKICBuZ0luY2x1ZGVGaWxsQ29udGVudERpcmVjdGl2ZSwKICBuZ0luaXREaXJlY3RpdmUsCiAgbmdOb25CaW5kYWJsZURpcmVjdGl2ZSwKICBuZ1BsdXJhbGl6ZURpcmVjdGl2ZSwKICBuZ1JlcGVhdERpcmVjdGl2ZSwKICBuZ1Nob3dEaXJlY3RpdmUsCiAgbmdTdHlsZURpcmVjdGl2ZSwKICBuZ1N3aXRjaERpcmVjdGl2ZSwKICBuZ1N3aXRjaFdoZW5EaXJlY3RpdmUsCiAgbmdTd2l0Y2hEZWZhdWx0RGlyZWN0aXZlLAogIG5nT3B0aW9uc0RpcmVjdGl2ZSwKICBuZ1RyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgbmdNb2RlbERpcmVjdGl2ZSwKICBuZ0xpc3REaXJlY3RpdmUsCiAgbmdDaGFuZ2VEaXJlY3RpdmUsCiAgcGF0dGVybkRpcmVjdGl2ZSwKICBwYXR0ZXJuRGlyZWN0aXZlLAogIHJlcXVpcmVkRGlyZWN0aXZlLAogIHJlcXVpcmVkRGlyZWN0aXZlLAogIG1pbmxlbmd0aERpcmVjdGl2ZSwKICBtaW5sZW5ndGhEaXJlY3RpdmUsCiAgbWF4bGVuZ3RoRGlyZWN0aXZlLAogIG1heGxlbmd0aERpcmVjdGl2ZSwKICBuZ1ZhbHVlRGlyZWN0aXZlLAogIG5nTW9kZWxPcHRpb25zRGlyZWN0aXZlLAogIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzLAogIG5nRXZlbnREaXJlY3RpdmVzLAoKICAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIsCiAgJEFuaW1hdGVQcm92aWRlciwKICAkQnJvd3NlclByb3ZpZGVyLAogICRDYWNoZUZhY3RvcnlQcm92aWRlciwKICAkQ29udHJvbGxlclByb3ZpZGVyLAogICREb2N1bWVudFByb3ZpZGVyLAogICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIsCiAgJEZpbHRlclByb3ZpZGVyLAogICRJbnRlcnBvbGF0ZVByb3ZpZGVyLAogICRJbnRlcnZhbFByb3ZpZGVyLAogICRIdHRwUHJvdmlkZXIsCiAgJEh0dHBCYWNrZW5kUHJvdmlkZXIsCiAgJExvY2F0aW9uUHJvdmlkZXIsCiAgJExvZ1Byb3ZpZGVyLAogICRQYXJzZVByb3ZpZGVyLAogICRSb290U2NvcGVQcm92aWRlciwKICAkUVByb3ZpZGVyLAogICQkUVByb3ZpZGVyLAogICQkU2FuaXRpemVVcmlQcm92aWRlciwKICAkU2NlUHJvdmlkZXIsCiAgJFNjZURlbGVnYXRlUHJvdmlkZXIsCiAgJFNuaWZmZXJQcm92aWRlciwKICAkVGVtcGxhdGVDYWNoZVByb3ZpZGVyLAogICRUZW1wbGF0ZVJlcXVlc3RQcm92aWRlciwKICAkJFRlc3RhYmlsaXR5UHJvdmlkZXIsCiAgJFRpbWVvdXRQcm92aWRlciwKICAkJFJBRlByb3ZpZGVyLAogICQkQXN5bmNDYWxsYmFja1Byb3ZpZGVyLAogICRXaW5kb3dQcm92aWRlcgoqLwoKCi8qKgogKiBAbmdkb2Mgb2JqZWN0CiAqIEBuYW1lIGFuZ3VsYXIudmVyc2lvbgogKiBAbW9kdWxlIG5nCiAqIEBkZXNjcmlwdGlvbgogKiBBbiBvYmplY3QgdGhhdCBjb250YWlucyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY3VycmVudCBBbmd1bGFySlMgdmVyc2lvbi4gVGhpcyBvYmplY3QgaGFzIHRoZQogKiBmb2xsb3dpbmcgcHJvcGVydGllczoKICoKICogLSBgZnVsbGAg4oCTIGB7c3RyaW5nfWAg4oCTIEZ1bGwgdmVyc2lvbiBzdHJpbmcsIHN1Y2ggYXMgIjAuOS4xOCIuCiAqIC0gYG1ham9yYCDigJMgYHtudW1iZXJ9YCDigJMgTWFqb3IgdmVyc2lvbiBudW1iZXIsIHN1Y2ggYXMgIjAiLgogKiAtIGBtaW5vcmAg4oCTIGB7bnVtYmVyfWAg4oCTIE1pbm9yIHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICI5Ii4KICogLSBgZG90YCDigJMgYHtudW1iZXJ9YCDigJMgRG90IHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIxOCIuCiAqIC0gYGNvZGVOYW1lYCDigJMgYHtzdHJpbmd9YCDigJMgQ29kZSBuYW1lIG9mIHRoZSByZWxlYXNlLCBzdWNoIGFzICJqaWdnbGluZy1hcm1mYXQiLgogKi8KdmFyIHZlcnNpb24gPSB7CiAgZnVsbDogJzEuMy4wJywgICAgLy8gYWxsIG9mIHRoZXNlIHBsYWNlaG9sZGVyIHN0cmluZ3Mgd2lsbCBiZSByZXBsYWNlZCBieSBncnVudCdzCiAgbWFqb3I6IDEsICAgIC8vIHBhY2thZ2UgdGFzawogIG1pbm9yOiAzLAogIGRvdDogMCwKICBjb2RlTmFtZTogJ3N1cGVybHVtaW5hbC1udWRnZScKfTsKCgpmdW5jdGlvbiBwdWJsaXNoRXh0ZXJuYWxBUEkoYW5ndWxhcil7CiAgZXh0ZW5kKGFuZ3VsYXIsIHsKICAgICdib290c3RyYXAnOiBib290c3RyYXAsCiAgICAnY29weSc6IGNvcHksCiAgICAnZXh0ZW5kJzogZXh0ZW5kLAogICAgJ2VxdWFscyc6IGVxdWFscywKICAgICdlbGVtZW50JzoganFMaXRlLAogICAgJ2ZvckVhY2gnOiBmb3JFYWNoLAogICAgJ2luamVjdG9yJzogY3JlYXRlSW5qZWN0b3IsCiAgICAnbm9vcCc6IG5vb3AsCiAgICAnYmluZCc6IGJpbmQsCiAgICAndG9Kc29uJzogdG9Kc29uLAogICAgJ2Zyb21Kc29uJzogZnJvbUpzb24sCiAgICAnaWRlbnRpdHknOiBpZGVudGl0eSwKICAgICdpc1VuZGVmaW5lZCc6IGlzVW5kZWZpbmVkLAogICAgJ2lzRGVmaW5lZCc6IGlzRGVmaW5lZCwKICAgICdpc1N0cmluZyc6IGlzU3RyaW5nLAogICAgJ2lzRnVuY3Rpb24nOiBpc0Z1bmN0aW9uLAogICAgJ2lzT2JqZWN0JzogaXNPYmplY3QsCiAgICAnaXNOdW1iZXInOiBpc051bWJlciwKICAgICdpc0VsZW1lbnQnOiBpc0VsZW1lbnQsCiAgICAnaXNBcnJheSc6IGlzQXJyYXksCiAgICAndmVyc2lvbic6IHZlcnNpb24sCiAgICAnaXNEYXRlJzogaXNEYXRlLAogICAgJ2xvd2VyY2FzZSc6IGxvd2VyY2FzZSwKICAgICd1cHBlcmNhc2UnOiB1cHBlcmNhc2UsCiAgICAnY2FsbGJhY2tzJzoge2NvdW50ZXI6IDB9LAogICAgJ2dldFRlc3RhYmlsaXR5JzogZ2V0VGVzdGFiaWxpdHksCiAgICAnJCRtaW5FcnInOiBtaW5FcnIsCiAgICAnJCRjc3AnOiBjc3AsCiAgICAncmVsb2FkV2l0aERlYnVnSW5mbyc6IHJlbG9hZFdpdGhEZWJ1Z0luZm8KICB9KTsKCiAgYW5ndWxhck1vZHVsZSA9IHNldHVwTW9kdWxlTG9hZGVyKHdpbmRvdyk7CiAgdHJ5IHsKICAgIGFuZ3VsYXJNb2R1bGUoJ25nTG9jYWxlJyk7CiAgfSBjYXRjaCAoZSkgewogICAgYW5ndWxhck1vZHVsZSgnbmdMb2NhbGUnLCBbXSkucHJvdmlkZXIoJyRsb2NhbGUnLCAkTG9jYWxlUHJvdmlkZXIpOwogIH0KCiAgYW5ndWxhck1vZHVsZSgnbmcnLCBbJ25nTG9jYWxlJ10sIFsnJHByb3ZpZGUnLAogICAgZnVuY3Rpb24gbmdNb2R1bGUoJHByb3ZpZGUpIHsKICAgICAgLy8gJCRzYW5pdGl6ZVVyaVByb3ZpZGVyIG5lZWRzIHRvIGJlIGJlZm9yZSAkY29tcGlsZVByb3ZpZGVyIGFzIGl0IGlzIHVzZWQgYnkgaXQuCiAgICAgICRwcm92aWRlLnByb3ZpZGVyKHsKICAgICAgICAkJHNhbml0aXplVXJpOiAkJFNhbml0aXplVXJpUHJvdmlkZXIKICAgICAgfSk7CiAgICAgICRwcm92aWRlLnByb3ZpZGVyKCckY29tcGlsZScsICRDb21waWxlUHJvdmlkZXIpLgogICAgICAgIGRpcmVjdGl2ZSh7CiAgICAgICAgICAgIGE6IGh0bWxBbmNob3JEaXJlY3RpdmUsCiAgICAgICAgICAgIGlucHV0OiBpbnB1dERpcmVjdGl2ZSwKICAgICAgICAgICAgdGV4dGFyZWE6IGlucHV0RGlyZWN0aXZlLAogICAgICAgICAgICBmb3JtOiBmb3JtRGlyZWN0aXZlLAogICAgICAgICAgICBzY3JpcHQ6IHNjcmlwdERpcmVjdGl2ZSwKICAgICAgICAgICAgc2VsZWN0OiBzZWxlY3REaXJlY3RpdmUsCiAgICAgICAgICAgIHN0eWxlOiBzdHlsZURpcmVjdGl2ZSwKICAgICAgICAgICAgb3B0aW9uOiBvcHRpb25EaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQmluZDogbmdCaW5kRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0JpbmRIdG1sOiBuZ0JpbmRIdG1sRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0JpbmRUZW1wbGF0ZTogbmdCaW5kVGVtcGxhdGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQ2xhc3M6IG5nQ2xhc3NEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQ2xhc3NFdmVuOiBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSwKICAgICAgICAgICAgbmdDbGFzc09kZDogbmdDbGFzc09kZERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdDbG9hazogbmdDbG9ha0RpcmVjdGl2ZSwKICAgICAgICAgICAgbmdDb250cm9sbGVyOiBuZ0NvbnRyb2xsZXJEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nRm9ybTogbmdGb3JtRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0hpZGU6IG5nSGlkZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdJZjogbmdJZkRpcmVjdGl2ZSwKICAgICAgICAgICAgbmdJbmNsdWRlOiBuZ0luY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nSW5pdDogbmdJbml0RGlyZWN0aXZlLAogICAgICAgICAgICBuZ05vbkJpbmRhYmxlOiBuZ05vbkJpbmRhYmxlRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1BsdXJhbGl6ZTogbmdQbHVyYWxpemVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nUmVwZWF0OiBuZ1JlcGVhdERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdTaG93OiBuZ1Nob3dEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nU3R5bGU6IG5nU3R5bGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nU3dpdGNoOiBuZ1N3aXRjaERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdTd2l0Y2hXaGVuOiBuZ1N3aXRjaFdoZW5EaXJlY3RpdmUsCiAgICAgICAgICAgIG5nU3dpdGNoRGVmYXVsdDogbmdTd2l0Y2hEZWZhdWx0RGlyZWN0aXZlLAogICAgICAgICAgICBuZ09wdGlvbnM6IG5nT3B0aW9uc0RpcmVjdGl2ZSwKICAgICAgICAgICAgbmdUcmFuc2NsdWRlOiBuZ1RyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nTW9kZWw6IG5nTW9kZWxEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nTGlzdDogbmdMaXN0RGlyZWN0aXZlLAogICAgICAgICAgICBuZ0NoYW5nZTogbmdDaGFuZ2VEaXJlY3RpdmUsCiAgICAgICAgICAgIHBhdHRlcm46IHBhdHRlcm5EaXJlY3RpdmUsCiAgICAgICAgICAgIG5nUGF0dGVybjogcGF0dGVybkRpcmVjdGl2ZSwKICAgICAgICAgICAgcmVxdWlyZWQ6IHJlcXVpcmVkRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1JlcXVpcmVkOiByZXF1aXJlZERpcmVjdGl2ZSwKICAgICAgICAgICAgbWlubGVuZ3RoOiBtaW5sZW5ndGhEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nTWlubGVuZ3RoOiBtaW5sZW5ndGhEaXJlY3RpdmUsCiAgICAgICAgICAgIG1heGxlbmd0aDogbWF4bGVuZ3RoRGlyZWN0aXZlLAogICAgICAgICAgICBuZ01heGxlbmd0aDogbWF4bGVuZ3RoRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1ZhbHVlOiBuZ1ZhbHVlRGlyZWN0aXZlLAogICAgICAgICAgICBuZ01vZGVsT3B0aW9uczogbmdNb2RlbE9wdGlvbnNEaXJlY3RpdmUKICAgICAgICB9KS4KICAgICAgICBkaXJlY3RpdmUoewogICAgICAgICAgbmdJbmNsdWRlOiBuZ0luY2x1ZGVGaWxsQ29udGVudERpcmVjdGl2ZQogICAgICAgIH0pLgogICAgICAgIGRpcmVjdGl2ZShuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlcykuCiAgICAgICAgZGlyZWN0aXZlKG5nRXZlbnREaXJlY3RpdmVzKTsKICAgICAgJHByb3ZpZGUucHJvdmlkZXIoewogICAgICAgICRhbmNob3JTY3JvbGw6ICRBbmNob3JTY3JvbGxQcm92aWRlciwKICAgICAgICAkYW5pbWF0ZTogJEFuaW1hdGVQcm92aWRlciwKICAgICAgICAkYnJvd3NlcjogJEJyb3dzZXJQcm92aWRlciwKICAgICAgICAkY2FjaGVGYWN0b3J5OiAkQ2FjaGVGYWN0b3J5UHJvdmlkZXIsCiAgICAgICAgJGNvbnRyb2xsZXI6ICRDb250cm9sbGVyUHJvdmlkZXIsCiAgICAgICAgJGRvY3VtZW50OiAkRG9jdW1lbnRQcm92aWRlciwKICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcjogJEV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlciwKICAgICAgICAkZmlsdGVyOiAkRmlsdGVyUHJvdmlkZXIsCiAgICAgICAgJGludGVycG9sYXRlOiAkSW50ZXJwb2xhdGVQcm92aWRlciwKICAgICAgICAkaW50ZXJ2YWw6ICRJbnRlcnZhbFByb3ZpZGVyLAogICAgICAgICRodHRwOiAkSHR0cFByb3ZpZGVyLAogICAgICAgICRodHRwQmFja2VuZDogJEh0dHBCYWNrZW5kUHJvdmlkZXIsCiAgICAgICAgJGxvY2F0aW9uOiAkTG9jYXRpb25Qcm92aWRlciwKICAgICAgICAkbG9nOiAkTG9nUHJvdmlkZXIsCiAgICAgICAgJHBhcnNlOiAkUGFyc2VQcm92aWRlciwKICAgICAgICAkcm9vdFNjb3BlOiAkUm9vdFNjb3BlUHJvdmlkZXIsCiAgICAgICAgJHE6ICRRUHJvdmlkZXIsCiAgICAgICAgJCRxOiAkJFFQcm92aWRlciwKICAgICAgICAkc2NlOiAkU2NlUHJvdmlkZXIsCiAgICAgICAgJHNjZURlbGVnYXRlOiAkU2NlRGVsZWdhdGVQcm92aWRlciwKICAgICAgICAkc25pZmZlcjogJFNuaWZmZXJQcm92aWRlciwKICAgICAgICAkdGVtcGxhdGVDYWNoZTogJFRlbXBsYXRlQ2FjaGVQcm92aWRlciwKICAgICAgICAkdGVtcGxhdGVSZXF1ZXN0OiAkVGVtcGxhdGVSZXF1ZXN0UHJvdmlkZXIsCiAgICAgICAgJCR0ZXN0YWJpbGl0eTogJCRUZXN0YWJpbGl0eVByb3ZpZGVyLAogICAgICAgICR0aW1lb3V0OiAkVGltZW91dFByb3ZpZGVyLAogICAgICAgICR3aW5kb3c6ICRXaW5kb3dQcm92aWRlciwKICAgICAgICAkJHJBRjogJCRSQUZQcm92aWRlciwKICAgICAgICAkJGFzeW5jQ2FsbGJhY2sgOiAkJEFzeW5jQ2FsbGJhY2tQcm92aWRlcgogICAgICB9KTsKICAgIH0KICBdKTsKfQoKLyogZ2xvYmFsIEpRTGl0ZVByb3RvdHlwZTogdHJ1ZSwKICBhZGRFdmVudExpc3RlbmVyRm46IHRydWUsCiAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuOiB0cnVlLAogIEJPT0xFQU5fQVRUUjogdHJ1ZSwKICBBTElBU0VEX0FUVFI6IHRydWUsCiovCgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vSlFMaXRlCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5lbGVtZW50CiAqIEBtb2R1bGUgbmcKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIFdyYXBzIGEgcmF3IERPTSBlbGVtZW50IG9yIEhUTUwgc3RyaW5nIGFzIGEgW2pRdWVyeV0oaHR0cDovL2pxdWVyeS5jb20pIGVsZW1lbnQuCiAqCiAqIElmIGpRdWVyeSBpcyBhdmFpbGFibGUsIGBhbmd1bGFyLmVsZW1lbnRgIGlzIGFuIGFsaWFzIGZvciB0aGUKICogW2pRdWVyeV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS8pIGZ1bmN0aW9uLiBJZiBqUXVlcnkgaXMgbm90IGF2YWlsYWJsZSwgYGFuZ3VsYXIuZWxlbWVudGAKICogZGVsZWdhdGVzIHRvIEFuZ3VsYXIncyBidWlsdC1pbiBzdWJzZXQgb2YgalF1ZXJ5LCBjYWxsZWQgImpRdWVyeSBsaXRlIiBvciAianFMaXRlLiIKICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtc3VjY2VzcyI+anFMaXRlIGlzIGEgdGlueSwgQVBJLWNvbXBhdGlibGUgc3Vic2V0IG9mIGpRdWVyeSB0aGF0IGFsbG93cwogKiBBbmd1bGFyIHRvIG1hbmlwdWxhdGUgdGhlIERPTSBpbiBhIGNyb3NzLWJyb3dzZXIgY29tcGF0aWJsZSB3YXkuICoqanFMaXRlKiogaW1wbGVtZW50cyBvbmx5IHRoZSBtb3N0CiAqIGNvbW1vbmx5IG5lZWRlZCBmdW5jdGlvbmFsaXR5IHdpdGggdGhlIGdvYWwgb2YgaGF2aW5nIGEgdmVyeSBzbWFsbCBmb290cHJpbnQuPC9kaXY+CiAqCiAqIFRvIHVzZSBqUXVlcnksIHNpbXBseSBsb2FkIGl0IGJlZm9yZSBgRE9NQ29udGVudExvYWRlZGAgZXZlbnQgZmlyZWQuCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0Ij4qKk5vdGU6KiogYWxsIGVsZW1lbnQgcmVmZXJlbmNlcyBpbiBBbmd1bGFyIGFyZSBhbHdheXMgd3JhcHBlZCB3aXRoIGpRdWVyeSBvcgogKiBqcUxpdGU7IHRoZXkgYXJlIG5ldmVyIHJhdyBET00gcmVmZXJlbmNlcy48L2Rpdj4KICoKICogIyMgQW5ndWxhcidzIGpxTGl0ZQogKiBqcUxpdGUgcHJvdmlkZXMgb25seSB0aGUgZm9sbG93aW5nIGpRdWVyeSBtZXRob2RzOgogKgogKiAtIFtgYWRkQ2xhc3MoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hZGRDbGFzcy8pCiAqIC0gW2BhZnRlcigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FmdGVyLykKICogLSBbYGFwcGVuZCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FwcGVuZC8pCiAqIC0gW2BhdHRyKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYXR0ci8pIC0gRG9lcyBub3Qgc3VwcG9ydCBmdW5jdGlvbnMgYXMgcGFyYW1ldGVycwogKiAtIFtgYmluZCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2JpbmQvKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcywgc2VsZWN0b3JzIG9yIGV2ZW50RGF0YQogKiAtIFtgY2hpbGRyZW4oKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jaGlsZHJlbi8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICogLSBbYGNsb25lKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY2xvbmUvKQogKiAtIFtgY29udGVudHMoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jb250ZW50cy8pCiAqIC0gW2Bjc3MoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jc3MvKSAtIE9ubHkgcmV0cmlldmVzIGlubGluZS1zdHlsZXMsIGRvZXMgbm90IGNhbGwgYGdldENvbXB1dGVkU3R5bGVzKClgCiAqIC0gW2BkYXRhKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZGF0YS8pCiAqIC0gW2BkZXRhY2goKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9kZXRhY2gvKQogKiAtIFtgZW1wdHkoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9lbXB0eS8pCiAqIC0gW2BlcSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2VxLykKICogLSBbYGZpbmQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9maW5kLykgLSBMaW1pdGVkIHRvIGxvb2t1cHMgYnkgdGFnIG5hbWUKICogLSBbYGhhc0NsYXNzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaGFzQ2xhc3MvKQogKiAtIFtgaHRtbCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2h0bWwvKQogKiAtIFtgbmV4dCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL25leHQvKSAtIERvZXMgbm90IHN1cHBvcnQgc2VsZWN0b3JzCiAqIC0gW2BvbigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29uLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMsIHNlbGVjdG9ycyBvciBldmVudERhdGEKICogLSBbYG9mZigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29mZi8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzIG9yIHNlbGVjdG9ycwogKiAtIFtgb25lKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vb25lLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMgb3Igc2VsZWN0b3JzCiAqIC0gW2BwYXJlbnQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wYXJlbnQvKSAtIERvZXMgbm90IHN1cHBvcnQgc2VsZWN0b3JzCiAqIC0gW2BwcmVwZW5kKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcHJlcGVuZC8pCiAqIC0gW2Bwcm9wKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcHJvcC8pCiAqIC0gW2ByZWFkeSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlYWR5LykKICogLSBbYHJlbW92ZSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZS8pCiAqIC0gW2ByZW1vdmVBdHRyKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQXR0ci8pCiAqIC0gW2ByZW1vdmVDbGFzcygpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZUNsYXNzLykKICogLSBbYHJlbW92ZURhdGEoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmVEYXRhLykKICogLSBbYHJlcGxhY2VXaXRoKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVwbGFjZVdpdGgvKQogKiAtIFtgdGV4dCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RleHQvKQogKiAtIFtgdG9nZ2xlQ2xhc3MoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS90b2dnbGVDbGFzcy8pCiAqIC0gW2B0cmlnZ2VySGFuZGxlcigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RyaWdnZXJIYW5kbGVyLykgLSBQYXNzZXMgYSBkdW1teSBldmVudCBvYmplY3QgdG8gaGFuZGxlcnMuCiAqIC0gW2B1bmJpbmQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS91bmJpbmQvKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcwogKiAtIFtgdmFsKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdmFsLykKICogLSBbYHdyYXAoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS93cmFwLykKICoKICogIyMgalF1ZXJ5L2pxTGl0ZSBFeHRyYXMKICogQW5ndWxhciBhbHNvIHByb3ZpZGVzIHRoZSBmb2xsb3dpbmcgYWRkaXRpb25hbCBtZXRob2RzIGFuZCBldmVudHMgdG8gYm90aCBqUXVlcnkgYW5kIGpxTGl0ZToKICoKICogIyMjIEV2ZW50cwogKiAtIGAkZGVzdHJveWAgLSBBbmd1bGFySlMgaW50ZXJjZXB0cyBhbGwganFMaXRlL2pRdWVyeSdzIERPTSBkZXN0cnVjdGlvbiBhcGlzIGFuZCBmaXJlcyB0aGlzIGV2ZW50CiAqICAgIG9uIGFsbCBET00gbm9kZXMgYmVpbmcgcmVtb3ZlZC4gIFRoaXMgY2FuIGJlIHVzZWQgdG8gY2xlYW4gdXAgYW55IDNyZCBwYXJ0eSBiaW5kaW5ncyB0byB0aGUgRE9NCiAqICAgIGVsZW1lbnQgYmVmb3JlIGl0IGlzIHJlbW92ZWQuCiAqCiAqICMjIyBNZXRob2RzCiAqIC0gYGNvbnRyb2xsZXIobmFtZSlgIC0gcmV0cmlldmVzIHRoZSBjb250cm9sbGVyIG9mIHRoZSBjdXJyZW50IGVsZW1lbnQgb3IgaXRzIHBhcmVudC4gQnkgZGVmYXVsdAogKiAgIHJldHJpZXZlcyBjb250cm9sbGVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgYG5nQ29udHJvbGxlcmAgZGlyZWN0aXZlLiBJZiBgbmFtZWAgaXMgcHJvdmlkZWQgYXMKICogICBjYW1lbENhc2UgZGlyZWN0aXZlIG5hbWUsIHRoZW4gdGhlIGNvbnRyb2xsZXIgZm9yIHRoaXMgZGlyZWN0aXZlIHdpbGwgYmUgcmV0cmlldmVkIChlLmcuCiAqICAgYCduZ01vZGVsJ2ApLgogKiAtIGBpbmplY3RvcigpYCAtIHJldHJpZXZlcyB0aGUgaW5qZWN0b3Igb2YgdGhlIGN1cnJlbnQgZWxlbWVudCBvciBpdHMgcGFyZW50LgogKiAtIGBzY29wZSgpYCAtIHJldHJpZXZlcyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9IG9mIHRoZSBjdXJyZW50CiAqICAgZWxlbWVudCBvciBpdHMgcGFyZW50LgogKiAtIGBpc29sYXRlU2NvcGUoKWAgLSByZXRyaWV2ZXMgYW4gaXNvbGF0ZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0gaWYgb25lIGlzIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZQogKiAgIGN1cnJlbnQgZWxlbWVudC4gVGhpcyBnZXR0ZXIgc2hvdWxkIGJlIHVzZWQgb25seSBvbiBlbGVtZW50cyB0aGF0IGNvbnRhaW4gYSBkaXJlY3RpdmUgd2hpY2ggc3RhcnRzIGEgbmV3IGlzb2xhdGUKICogICBzY29wZS4gQ2FsbGluZyBgc2NvcGUoKWAgb24gdGhpcyBlbGVtZW50IGFsd2F5cyByZXR1cm5zIHRoZSBvcmlnaW5hbCBub24taXNvbGF0ZSBzY29wZS4KICogLSBgaW5oZXJpdGVkRGF0YSgpYCAtIHNhbWUgYXMgYGRhdGEoKWAsIGJ1dCB3YWxrcyB1cCB0aGUgRE9NIHVudGlsIGEgdmFsdWUgaXMgZm91bmQgb3IgdGhlIHRvcAogKiAgIHBhcmVudCBlbGVtZW50IGlzIHJlYWNoZWQuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfERPTUVsZW1lbnR9IGVsZW1lbnQgSFRNTCBzdHJpbmcgb3IgRE9NRWxlbWVudCB0byBiZSB3cmFwcGVkIGludG8galF1ZXJ5LgogKiBAcmV0dXJucyB7T2JqZWN0fSBqUXVlcnkgb2JqZWN0LgogKi8KCkpRTGl0ZS5leHBhbmRvID0gJ25nMzM5JzsKCnZhciBqcUNhY2hlID0gSlFMaXRlLmNhY2hlID0ge30sCiAgICBqcUlkID0gMSwKICAgIGFkZEV2ZW50TGlzdGVuZXJGbiA9IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwogICAgfSwKICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbiA9IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwogICAgfTsKCi8qCiAqICEhISBUaGlzIGlzIGFuIHVuZG9jdW1lbnRlZCAicHJpdmF0ZSIgZnVuY3Rpb24gISEhCiAqLwpKUUxpdGUuX2RhdGEgPSBmdW5jdGlvbihub2RlKSB7CiAgLy9qUXVlcnkgYWx3YXlzIHJldHVybnMgYW4gb2JqZWN0IG9uIGNhY2hlIG1pc3MKICByZXR1cm4gdGhpcy5jYWNoZVtub2RlW3RoaXMuZXhwYW5kb11dIHx8IHt9Owp9OwoKZnVuY3Rpb24ganFOZXh0SWQoKSB7IHJldHVybiArK2pxSWQ7IH0KCgp2YXIgU1BFQ0lBTF9DSEFSU19SRUdFWFAgPSAvKFtcOlwtXF9dKyguKSkvZzsKdmFyIE1PWl9IQUNLX1JFR0VYUCA9IC9ebW96KFtBLVpdKS87CnZhciBNT1VTRV9FVkVOVF9NQVA9IHsgbW91c2VsZWF2ZSA6ICJtb3VzZW91dCIsIG1vdXNlZW50ZXIgOiAibW91c2VvdmVyIn07CnZhciBqcUxpdGVNaW5FcnIgPSBtaW5FcnIoJ2pxTGl0ZScpOwoKLyoqCiAqIENvbnZlcnRzIHNuYWtlX2Nhc2UgdG8gY2FtZWxDYXNlLgogKiBBbHNvIHRoZXJlIGlzIHNwZWNpYWwgY2FzZSBmb3IgTW96IHByZWZpeCBzdGFydGluZyB3aXRoIHVwcGVyIGNhc2UgbGV0dGVyLgogKiBAcGFyYW0gbmFtZSBOYW1lIHRvIG5vcm1hbGl6ZQogKi8KZnVuY3Rpb24gY2FtZWxDYXNlKG5hbWUpIHsKICByZXR1cm4gbmFtZS4KICAgIHJlcGxhY2UoU1BFQ0lBTF9DSEFSU19SRUdFWFAsIGZ1bmN0aW9uKF8sIHNlcGFyYXRvciwgbGV0dGVyLCBvZmZzZXQpIHsKICAgICAgcmV0dXJuIG9mZnNldCA/IGxldHRlci50b1VwcGVyQ2FzZSgpIDogbGV0dGVyOwogICAgfSkuCiAgICByZXBsYWNlKE1PWl9IQUNLX1JFR0VYUCwgJ01veiQxJyk7Cn0KCnZhciBTSU5HTEVfVEFHX1JFR0VYUCA9IC9ePChcdyspXHMqXC8/Pig/OjxcL1wxPnwpJC87CnZhciBIVE1MX1JFR0VYUCA9IC88fCYjP1x3KzsvOwp2YXIgVEFHX05BTUVfUkVHRVhQID0gLzwoW1x3Ol0rKS87CnZhciBYSFRNTF9UQUdfUkVHRVhQID0gLzwoPyFhcmVhfGJyfGNvbHxlbWJlZHxocnxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtKSgoW1x3Ol0rKVtePl0qKVwvPi9naTsKCnZhciB3cmFwTWFwID0gewogICdvcHRpb24nOiBbMSwgJzxzZWxlY3QgbXVsdGlwbGU9Im11bHRpcGxlIj4nLCAnPC9zZWxlY3Q+J10sCgogICd0aGVhZCc6IFsxLCAnPHRhYmxlPicsICc8L3RhYmxlPiddLAogICdjb2wnOiBbMiwgJzx0YWJsZT48Y29sZ3JvdXA+JywgJzwvY29sZ3JvdXA+PC90YWJsZT4nXSwKICAndHInOiBbMiwgJzx0YWJsZT48dGJvZHk+JywgJzwvdGJvZHk+PC90YWJsZT4nXSwKICAndGQnOiBbMywgJzx0YWJsZT48dGJvZHk+PHRyPicsICc8L3RyPjwvdGJvZHk+PC90YWJsZT4nXSwKICAnX2RlZmF1bHQnOiBbMCwgIiIsICIiXQp9OwoKd3JhcE1hcC5vcHRncm91cCA9IHdyYXBNYXAub3B0aW9uOwp3cmFwTWFwLnRib2R5ID0gd3JhcE1hcC50Zm9vdCA9IHdyYXBNYXAuY29sZ3JvdXAgPSB3cmFwTWFwLmNhcHRpb24gPSB3cmFwTWFwLnRoZWFkOwp3cmFwTWFwLnRoID0gd3JhcE1hcC50ZDsKCgpmdW5jdGlvbiBqcUxpdGVJc1RleHROb2RlKGh0bWwpIHsKICByZXR1cm4gIUhUTUxfUkVHRVhQLnRlc3QoaHRtbCk7Cn0KCmZ1bmN0aW9uIGpxTGl0ZUFjY2VwdHNEYXRhKG5vZGUpIHsKICAvLyBUaGUgd2luZG93IG9iamVjdCBjYW4gYWNjZXB0IGRhdGEgYnV0IGhhcyBubyBub2RlVHlwZQogIC8vIE90aGVyd2lzZSB3ZSBhcmUgb25seSBpbnRlcmVzdGVkIGluIGVsZW1lbnRzICgxKSBhbmQgZG9jdW1lbnRzICg5KQogIHZhciBub2RlVHlwZSA9IG5vZGUubm9kZVR5cGU7CiAgcmV0dXJuIG5vZGVUeXBlID09PSBOT0RFX1RZUEVfRUxFTUVOVCB8fCAhbm9kZVR5cGUgfHwgbm9kZVR5cGUgPT09IE5PREVfVFlQRV9ET0NVTUVOVDsKfQoKZnVuY3Rpb24ganFMaXRlQnVpbGRGcmFnbWVudChodG1sLCBjb250ZXh0KSB7CiAgdmFyIHRtcCwgdGFnLCB3cmFwLAogICAgICBmcmFnbWVudCA9IGNvbnRleHQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICBub2RlcyA9IFtdLCBpOwoKICBpZiAoanFMaXRlSXNUZXh0Tm9kZShodG1sKSkgewogICAgLy8gQ29udmVydCBub24taHRtbCBpbnRvIGEgdGV4dCBub2RlCiAgICBub2Rlcy5wdXNoKGNvbnRleHQuY3JlYXRlVGV4dE5vZGUoaHRtbCkpOwogIH0gZWxzZSB7CiAgICAvLyBDb252ZXJ0IGh0bWwgaW50byBET00gbm9kZXMKICAgIHRtcCA9IHRtcCB8fCBmcmFnbWVudC5hcHBlbmRDaGlsZChjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpKTsKICAgIHRhZyA9IChUQUdfTkFNRV9SRUdFWFAuZXhlYyhodG1sKSB8fCBbIiIsICIiXSlbMV0udG9Mb3dlckNhc2UoKTsKICAgIHdyYXAgPSB3cmFwTWFwW3RhZ10gfHwgd3JhcE1hcC5fZGVmYXVsdDsKICAgIHRtcC5pbm5lckhUTUwgPSB3cmFwWzFdICsgaHRtbC5yZXBsYWNlKFhIVE1MX1RBR19SRUdFWFAsICI8JDE+PC8kMj4iKSArIHdyYXBbMl07CgogICAgLy8gRGVzY2VuZCB0aHJvdWdoIHdyYXBwZXJzIHRvIHRoZSByaWdodCBjb250ZW50CiAgICBpID0gd3JhcFswXTsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgdG1wID0gdG1wLmxhc3RDaGlsZDsKICAgIH0KCiAgICBub2RlcyA9IGNvbmNhdChub2RlcywgdG1wLmNoaWxkTm9kZXMpOwoKICAgIHRtcCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7CiAgICB0bXAudGV4dENvbnRlbnQgPSAiIjsKICB9CgogIC8vIFJlbW92ZSB3cmFwcGVyIGZyb20gZnJhZ21lbnQKICBmcmFnbWVudC50ZXh0Q29udGVudCA9ICIiOwogIGZyYWdtZW50LmlubmVySFRNTCA9ICIiOyAvLyBDbGVhciBpbm5lciBIVE1MCiAgZm9yRWFjaChub2RlcywgZnVuY3Rpb24obm9kZSkgewogICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQobm9kZSk7CiAgfSk7CgogIHJldHVybiBmcmFnbWVudDsKfQoKZnVuY3Rpb24ganFMaXRlUGFyc2VIVE1MKGh0bWwsIGNvbnRleHQpIHsKICBjb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKICB2YXIgcGFyc2VkOwoKICBpZiAoKHBhcnNlZCA9IFNJTkdMRV9UQUdfUkVHRVhQLmV4ZWMoaHRtbCkpKSB7CiAgICByZXR1cm4gW2NvbnRleHQuY3JlYXRlRWxlbWVudChwYXJzZWRbMV0pXTsKICB9CgogIGlmICgocGFyc2VkID0ganFMaXRlQnVpbGRGcmFnbWVudChodG1sLCBjb250ZXh0KSkpIHsKICAgIHJldHVybiBwYXJzZWQuY2hpbGROb2RlczsKICB9CgogIHJldHVybiBbXTsKfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCmZ1bmN0aW9uIEpRTGl0ZShlbGVtZW50KSB7CiAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBKUUxpdGUpIHsKICAgIHJldHVybiBlbGVtZW50OwogIH0KCiAgdmFyIGFyZ0lzU3RyaW5nOwoKICBpZiAoaXNTdHJpbmcoZWxlbWVudCkpIHsKICAgIGVsZW1lbnQgPSB0cmltKGVsZW1lbnQpOwogICAgYXJnSXNTdHJpbmcgPSB0cnVlOwogIH0KICBpZiAoISh0aGlzIGluc3RhbmNlb2YgSlFMaXRlKSkgewogICAgaWYgKGFyZ0lzU3RyaW5nICYmIGVsZW1lbnQuY2hhckF0KDApICE9ICc8JykgewogICAgICB0aHJvdyBqcUxpdGVNaW5FcnIoJ25vc2VsJywgJ0xvb2tpbmcgdXAgZWxlbWVudHMgdmlhIHNlbGVjdG9ycyBpcyBub3Qgc3VwcG9ydGVkIGJ5IGpxTGl0ZSEgU2VlOiBodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9hbmd1bGFyLmVsZW1lbnQnKTsKICAgIH0KICAgIHJldHVybiBuZXcgSlFMaXRlKGVsZW1lbnQpOwogIH0KCiAgaWYgKGFyZ0lzU3RyaW5nKSB7CiAgICBqcUxpdGVBZGROb2Rlcyh0aGlzLCBqcUxpdGVQYXJzZUhUTUwoZWxlbWVudCkpOwogIH0gZWxzZSB7CiAgICBqcUxpdGVBZGROb2Rlcyh0aGlzLCBlbGVtZW50KTsKICB9Cn0KCmZ1bmN0aW9uIGpxTGl0ZUNsb25lKGVsZW1lbnQpIHsKICByZXR1cm4gZWxlbWVudC5jbG9uZU5vZGUodHJ1ZSk7Cn0KCmZ1bmN0aW9uIGpxTGl0ZURlYWxvYyhlbGVtZW50LCBvbmx5RGVzY2VuZGFudHMpewogIGlmICghb25seURlc2NlbmRhbnRzKSBqcUxpdGVSZW1vdmVEYXRhKGVsZW1lbnQpOwoKICBpZiAoZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKSB7CiAgICB2YXIgZGVzY2VuZGFudHMgPSBlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJyonKTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gZGVzY2VuZGFudHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGpxTGl0ZVJlbW92ZURhdGEoZGVzY2VuZGFudHNbaV0pOwogICAgfQogIH0KfQoKZnVuY3Rpb24ganFMaXRlT2ZmKGVsZW1lbnQsIHR5cGUsIGZuLCB1bnN1cHBvcnRlZCkgewogIGlmIChpc0RlZmluZWQodW5zdXBwb3J0ZWQpKSB0aHJvdyBqcUxpdGVNaW5FcnIoJ29mZmFyZ3MnLCAnanFMaXRlI29mZigpIGRvZXMgbm90IHN1cHBvcnQgdGhlIGBzZWxlY3RvcmAgYXJndW1lbnQnKTsKCiAgdmFyIGV4cGFuZG9TdG9yZSA9IGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50KTsKICB2YXIgZXZlbnRzID0gZXhwYW5kb1N0b3JlICYmIGV4cGFuZG9TdG9yZS5ldmVudHM7CiAgdmFyIGhhbmRsZSA9IGV4cGFuZG9TdG9yZSAmJiBleHBhbmRvU3RvcmUuaGFuZGxlOwoKICBpZiAoIWhhbmRsZSkgcmV0dXJuOyAvL25vIGxpc3RlbmVycyByZWdpc3RlcmVkCgogIGlmICghdHlwZSkgewogICAgZm9yICh0eXBlIGluIGV2ZW50cykgewogICAgICBpZiAodHlwZSAhPT0gJyRkZXN0cm95JykgewogICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBoYW5kbGUpOwogICAgICB9CiAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICB9CiAgfSBlbHNlIHsKICAgIGZvckVhY2godHlwZS5zcGxpdCgnICcpLCBmdW5jdGlvbih0eXBlKSB7CiAgICAgIGlmIChpc0RlZmluZWQoZm4pKSB7CiAgICAgICAgdmFyIGxpc3RlbmVyRm5zID0gZXZlbnRzW3R5cGVdOwogICAgICAgIGFycmF5UmVtb3ZlKGxpc3RlbmVyRm5zIHx8IFtdLCBmbik7CiAgICAgICAgaWYgKGxpc3RlbmVyRm5zICYmIGxpc3RlbmVyRm5zLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBoYW5kbGUpOwogICAgICBkZWxldGUgZXZlbnRzW3R5cGVdOwogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBqcUxpdGVSZW1vdmVEYXRhKGVsZW1lbnQsIG5hbWUpIHsKICB2YXIgZXhwYW5kb0lkID0gZWxlbWVudC5uZzMzOTsKICB2YXIgZXhwYW5kb1N0b3JlID0gZXhwYW5kb0lkICYmIGpxQ2FjaGVbZXhwYW5kb0lkXTsKCiAgaWYgKGV4cGFuZG9TdG9yZSkgewogICAgaWYgKG5hbWUpIHsKICAgICAgZGVsZXRlIGV4cGFuZG9TdG9yZS5kYXRhW25hbWVdOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKGV4cGFuZG9TdG9yZS5oYW5kbGUpIHsKICAgICAgaWYgKGV4cGFuZG9TdG9yZS5ldmVudHMuJGRlc3Ryb3kpIHsKICAgICAgICBleHBhbmRvU3RvcmUuaGFuZGxlKHt9LCAnJGRlc3Ryb3knKTsKICAgICAgfQogICAgICBqcUxpdGVPZmYoZWxlbWVudCk7CiAgICB9CiAgICBkZWxldGUganFDYWNoZVtleHBhbmRvSWRdOwogICAgZWxlbWVudC5uZzMzOSA9IHVuZGVmaW5lZDsgLy8gZG9uJ3QgZGVsZXRlIERPTSBleHBhbmRvcy4gSUUgYW5kIENocm9tZSBkb24ndCBsaWtlIGl0CiAgfQp9CgoKZnVuY3Rpb24ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsIGNyZWF0ZUlmTmVjZXNzYXJ5KSB7CiAgdmFyIGV4cGFuZG9JZCA9IGVsZW1lbnQubmczMzksCiAgICAgIGV4cGFuZG9TdG9yZSA9IGV4cGFuZG9JZCAmJiBqcUNhY2hlW2V4cGFuZG9JZF07CgogIGlmIChjcmVhdGVJZk5lY2Vzc2FyeSAmJiAhZXhwYW5kb1N0b3JlKSB7CiAgICBlbGVtZW50Lm5nMzM5ID0gZXhwYW5kb0lkID0ganFOZXh0SWQoKTsKICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkXSA9IHtldmVudHM6IHt9LCBkYXRhOiB7fSwgaGFuZGxlOiB1bmRlZmluZWR9OwogIH0KCiAgcmV0dXJuIGV4cGFuZG9TdG9yZTsKfQoKCmZ1bmN0aW9uIGpxTGl0ZURhdGEoZWxlbWVudCwga2V5LCB2YWx1ZSkgewogIGlmIChqcUxpdGVBY2NlcHRzRGF0YShlbGVtZW50KSkgewoKICAgIHZhciBpc1NpbXBsZVNldHRlciA9IGlzRGVmaW5lZCh2YWx1ZSk7CiAgICB2YXIgaXNTaW1wbGVHZXR0ZXIgPSAhaXNTaW1wbGVTZXR0ZXIgJiYga2V5ICYmICFpc09iamVjdChrZXkpOwogICAgdmFyIG1hc3NHZXR0ZXIgPSAha2V5OwogICAgdmFyIGV4cGFuZG9TdG9yZSA9IGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAhaXNTaW1wbGVHZXR0ZXIpOwogICAgdmFyIGRhdGEgPSBleHBhbmRvU3RvcmUgJiYgZXhwYW5kb1N0b3JlLmRhdGE7CgogICAgaWYgKGlzU2ltcGxlU2V0dGVyKSB7IC8vIGRhdGEoJ2tleScsIHZhbHVlKQogICAgICBkYXRhW2tleV0gPSB2YWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChtYXNzR2V0dGVyKSB7ICAvLyBkYXRhKCkKICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaXNTaW1wbGVHZXR0ZXIpIHsgLy8gZGF0YSgna2V5JykKICAgICAgICAgIC8vIGRvbid0IGZvcmNlIGNyZWF0aW9uIG9mIGV4cGFuZG9TdG9yZSBpZiBpdCBkb2Vzbid0IGV4aXN0IHlldAogICAgICAgICAgcmV0dXJuIGRhdGEgJiYgZGF0YVtrZXldOwogICAgICAgIH0gZWxzZSB7IC8vIG1hc3Mtc2V0dGVyOiBkYXRhKHtrZXkxOiB2YWwxLCBrZXkyOiB2YWwyfSkKICAgICAgICAgIGV4dGVuZChkYXRhLCBrZXkpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24ganFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpIHsKICBpZiAoIWVsZW1lbnQuZ2V0QXR0cmlidXRlKSByZXR1cm4gZmFsc2U7CiAgcmV0dXJuICgoIiAiICsgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKSArICIgIikucmVwbGFjZSgvW1xuXHRdL2csICIgIikuCiAgICAgIGluZGV4T2YoICIgIiArIHNlbGVjdG9yICsgIiAiICkgPiAtMSk7Cn0KCmZ1bmN0aW9uIGpxTGl0ZVJlbW92ZUNsYXNzKGVsZW1lbnQsIGNzc0NsYXNzZXMpIHsKICBpZiAoY3NzQ2xhc3NlcyAmJiBlbGVtZW50LnNldEF0dHJpYnV0ZSkgewogICAgZm9yRWFjaChjc3NDbGFzc2VzLnNwbGl0KCcgJyksIGZ1bmN0aW9uKGNzc0NsYXNzKSB7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdjbGFzcycsIHRyaW0oCiAgICAgICAgICAoIiAiICsgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKSArICIgIikKICAgICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKQogICAgICAgICAgLnJlcGxhY2UoIiAiICsgdHJpbShjc3NDbGFzcykgKyAiICIsICIgIikpCiAgICAgICk7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIGpxTGl0ZUFkZENsYXNzKGVsZW1lbnQsIGNzc0NsYXNzZXMpIHsKICBpZiAoY3NzQ2xhc3NlcyAmJiBlbGVtZW50LnNldEF0dHJpYnV0ZSkgewogICAgdmFyIGV4aXN0aW5nQ2xhc3NlcyA9ICgnICcgKyAoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgfHwgJycpICsgJyAnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcblx0XS9nLCAiICIpOwoKICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbihjc3NDbGFzcykgewogICAgICBjc3NDbGFzcyA9IHRyaW0oY3NzQ2xhc3MpOwogICAgICBpZiAoZXhpc3RpbmdDbGFzc2VzLmluZGV4T2YoJyAnICsgY3NzQ2xhc3MgKyAnICcpID09PSAtMSkgewogICAgICAgIGV4aXN0aW5nQ2xhc3NlcyArPSBjc3NDbGFzcyArICcgJzsKICAgICAgfQogICAgfSk7CgogICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgdHJpbShleGlzdGluZ0NsYXNzZXMpKTsKICB9Cn0KCgpmdW5jdGlvbiBqcUxpdGVBZGROb2Rlcyhyb290LCBlbGVtZW50cykgewogIC8vIFRISVMgQ09ERSBJUyBWRVJZIEhPVC4gRG9uJ3QgbWFrZSBjaGFuZ2VzIHdpdGhvdXQgYmVuY2htYXJraW5nLgoKICBpZiAoZWxlbWVudHMpIHsKCiAgICAvLyBpZiBhIE5vZGUgKHRoZSBtb3N0IGNvbW1vbiBjYXNlKQogICAgaWYgKGVsZW1lbnRzLm5vZGVUeXBlKSB7CiAgICAgIHJvb3Rbcm9vdC5sZW5ndGgrK10gPSBlbGVtZW50czsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgogICAgICAvLyBpZiBhbiBBcnJheSBvciBOb2RlTGlzdCBhbmQgbm90IGEgV2luZG93CiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09PSAnbnVtYmVyJyAmJiBlbGVtZW50cy53aW5kb3cgIT09IGVsZW1lbnRzKSB7CiAgICAgICAgaWYgKGxlbmd0aCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICByb290W3Jvb3QubGVuZ3RoKytdID0gZWxlbWVudHNbaV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJvb3Rbcm9vdC5sZW5ndGgrK10gPSBlbGVtZW50czsKICAgICAgfQogICAgfQogIH0KfQoKCmZ1bmN0aW9uIGpxTGl0ZUNvbnRyb2xsZXIoZWxlbWVudCwgbmFtZSkgewogIHJldHVybiBqcUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckJyArIChuYW1lIHx8ICduZ0NvbnRyb2xsZXInICkgKyAnQ29udHJvbGxlcicpOwp9CgpmdW5jdGlvbiBqcUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7CiAgLy8gaWYgZWxlbWVudCBpcyB0aGUgZG9jdW1lbnQgb2JqZWN0IHdvcmsgd2l0aCB0aGUgaHRtbCBlbGVtZW50IGluc3RlYWQKICAvLyB0aGlzIG1ha2VzICQoZG9jdW1lbnQpLnNjb3BlKCkgcG9zc2libGUKICBpZihlbGVtZW50Lm5vZGVUeXBlID09IE5PREVfVFlQRV9ET0NVTUVOVCkgewogICAgZWxlbWVudCA9IGVsZW1lbnQuZG9jdW1lbnRFbGVtZW50OwogIH0KICB2YXIgbmFtZXMgPSBpc0FycmF5KG5hbWUpID8gbmFtZSA6IFtuYW1lXTsKCiAgd2hpbGUgKGVsZW1lbnQpIHsKICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IG5hbWVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgaWYgKCh2YWx1ZSA9IGpxTGl0ZS5kYXRhKGVsZW1lbnQsIG5hbWVzW2ldKSkgIT09IHVuZGVmaW5lZCkgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIC8vIElmIGRlYWxpbmcgd2l0aCBhIGRvY3VtZW50IGZyYWdtZW50IG5vZGUgd2l0aCBhIGhvc3QgZWxlbWVudCwgYW5kIG5vIHBhcmVudCwgdXNlIHRoZSBob3N0CiAgICAvLyBlbGVtZW50IGFzIHRoZSBwYXJlbnQuIFRoaXMgZW5hYmxlcyBkaXJlY3RpdmVzIHdpdGhpbiBhIFNoYWRvdyBET00gb3IgcG9seWZpbGxlZCBTaGFkb3cgRE9NCiAgICAvLyB0byBsb29rdXAgcGFyZW50IGNvbnRyb2xsZXJzLgogICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSB8fCAoZWxlbWVudC5ub2RlVHlwZSA9PT0gTk9ERV9UWVBFX0RPQ1VNRU5UX0ZSQUdNRU5UICYmIGVsZW1lbnQuaG9zdCk7CiAgfQp9CgpmdW5jdGlvbiBqcUxpdGVFbXB0eShlbGVtZW50KSB7CiAganFMaXRlRGVhbG9jKGVsZW1lbnQsIHRydWUpOwogIHdoaWxlIChlbGVtZW50LmZpcnN0Q2hpbGQpIHsKICAgIGVsZW1lbnQucmVtb3ZlQ2hpbGQoZWxlbWVudC5maXJzdENoaWxkKTsKICB9Cn0KCmZ1bmN0aW9uIGpxTGl0ZVJlbW92ZShlbGVtZW50LCBrZWVwRGF0YSkgewogIGlmICgha2VlcERhdGEpIGpxTGl0ZURlYWxvYyhlbGVtZW50KTsKICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogIGlmIChwYXJlbnQpIHBhcmVudC5yZW1vdmVDaGlsZChlbGVtZW50KTsKfQoKCmZ1bmN0aW9uIGpxTGl0ZURvY3VtZW50TG9hZGVkKGFjdGlvbiwgd2luKSB7CiAgd2luID0gd2luIHx8IHdpbmRvdzsKICBpZiAod2luLmRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScpIHsKICAgIC8vIEZvcmNlIHRoZSBhY3Rpb24gdG8gYmUgcnVuIGFzeW5jIGZvciBjb25zaXN0ZW50IGJlaGF2aW91cgogICAgLy8gZnJvbSB0aGUgYWN0aW9uJ3MgcG9pbnQgb2YgdmlldwogICAgLy8gaS5lLiBpdCB3aWxsIGRlZmluaXRlbHkgbm90IGJlIGluIGEgJGFwcGx5CiAgICB3aW4uc2V0VGltZW91dChhY3Rpb24pOwogIH0gZWxzZSB7CiAgICAvLyBObyBuZWVkIHRvIHVuYmluZCB0aGlzIGhhbmRsZXIgYXMgbG9hZCBpcyBvbmx5IGV2ZXIgY2FsbGVkIG9uY2UKICAgIGpxTGl0ZSh3aW4pLm9uKCdsb2FkJywgYWN0aW9uKTsKICB9Cn0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgd2hpY2ggYXJlIGRlY2xhcmVkIGRpcmVjdGx5LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KdmFyIEpRTGl0ZVByb3RvdHlwZSA9IEpRTGl0ZS5wcm90b3R5cGUgPSB7CiAgcmVhZHk6IGZ1bmN0aW9uKGZuKSB7CiAgICB2YXIgZmlyZWQgPSBmYWxzZTsKCiAgICBmdW5jdGlvbiB0cmlnZ2VyKCkgewogICAgICBpZiAoZmlyZWQpIHJldHVybjsKICAgICAgZmlyZWQgPSB0cnVlOwogICAgICBmbigpOwogICAgfQoKICAgIC8vIGNoZWNrIGlmIGRvY3VtZW50IGlzIGFscmVhZHkgbG9hZGVkCiAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJyl7CiAgICAgIHNldFRpbWVvdXQodHJpZ2dlcik7CiAgICB9IGVsc2UgewogICAgICB0aGlzLm9uKCdET01Db250ZW50TG9hZGVkJywgdHJpZ2dlcik7IC8vIHdvcmtzIGZvciBtb2Rlcm4gYnJvd3NlcnMgYW5kIElFOQogICAgICAvLyB3ZSBjYW4gbm90IHVzZSBqcUxpdGUgc2luY2Ugd2UgYXJlIG5vdCBkb25lIGxvYWRpbmcgYW5kIGpRdWVyeSBjb3VsZCBiZSBsb2FkZWQgbGF0ZXIuCiAgICAgIC8vIGpzaGludCAtVzA2NAogICAgICBKUUxpdGUod2luZG93KS5vbignbG9hZCcsIHRyaWdnZXIpOyAvLyBmYWxsYmFjayB0byB3aW5kb3cub25sb2FkIGZvciBvdGhlcnMKICAgICAgLy8ganNoaW50ICtXMDY0CiAgICAgIHRoaXMub24oJ0RPTUNvbnRlbnRMb2FkZWQnLCB0cmlnZ2VyKTsKICAgIH0KICB9LAogIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgIHZhciB2YWx1ZSA9IFtdOwogICAgZm9yRWFjaCh0aGlzLCBmdW5jdGlvbihlKXsgdmFsdWUucHVzaCgnJyArIGUpO30pOwogICAgcmV0dXJuICdbJyArIHZhbHVlLmpvaW4oJywgJykgKyAnXSc7CiAgfSwKCiAgZXE6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgIHJldHVybiAoaW5kZXggPj0gMCkgPyBqcUxpdGUodGhpc1tpbmRleF0pIDoganFMaXRlKHRoaXNbdGhpcy5sZW5ndGggKyBpbmRleF0pOwogIH0sCgogIGxlbmd0aDogMCwKICBwdXNoOiBwdXNoLAogIHNvcnQ6IFtdLnNvcnQsCiAgc3BsaWNlOiBbXS5zcGxpY2UKfTsKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgaXRlcmF0aW5nIGdldHRlci9zZXR0ZXJzLgovLyB0aGVzZSBmdW5jdGlvbnMgcmV0dXJuIHNlbGYgb24gc2V0dGVyIGFuZAovLyB2YWx1ZSBvbiBnZXQuCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwp2YXIgQk9PTEVBTl9BVFRSID0ge307CmZvckVhY2goJ211bHRpcGxlLHNlbGVjdGVkLGNoZWNrZWQsZGlzYWJsZWQscmVhZE9ubHkscmVxdWlyZWQsb3Blbicuc3BsaXQoJywnKSwgZnVuY3Rpb24odmFsdWUpIHsKICBCT09MRUFOX0FUVFJbbG93ZXJjYXNlKHZhbHVlKV0gPSB2YWx1ZTsKfSk7CnZhciBCT09MRUFOX0VMRU1FTlRTID0ge307CmZvckVhY2goJ2lucHV0LHNlbGVjdCxvcHRpb24sdGV4dGFyZWEsYnV0dG9uLGZvcm0sZGV0YWlscycuc3BsaXQoJywnKSwgZnVuY3Rpb24odmFsdWUpIHsKICBCT09MRUFOX0VMRU1FTlRTW3ZhbHVlXSA9IHRydWU7Cn0pOwp2YXIgQUxJQVNFRF9BVFRSID0gewogICduZ01pbmxlbmd0aCcgOiAnbWlubGVuZ3RoJywKICAnbmdNYXhsZW5ndGgnIDogJ21heGxlbmd0aCcsCiAgJ25nTWluJyA6ICdtaW4nLAogICduZ01heCcgOiAnbWF4JywKICAnbmdQYXR0ZXJuJyA6ICdwYXR0ZXJuJwp9OwoKZnVuY3Rpb24gZ2V0Qm9vbGVhbkF0dHJOYW1lKGVsZW1lbnQsIG5hbWUpIHsKICAvLyBjaGVjayBkb20gbGFzdCBzaW5jZSB3ZSB3aWxsIG1vc3QgbGlrZWx5IGZhaWwgb24gbmFtZQogIHZhciBib29sZWFuQXR0ciA9IEJPT0xFQU5fQVRUUltuYW1lLnRvTG93ZXJDYXNlKCldOwoKICAvLyBib29sZWFuQXR0ciBpcyBoZXJlIHR3aWNlIHRvIG1pbmltaXplIERPTSBhY2Nlc3MKICByZXR1cm4gYm9vbGVhbkF0dHIgJiYgQk9PTEVBTl9FTEVNRU5UU1tub2RlTmFtZV8oZWxlbWVudCldICYmIGJvb2xlYW5BdHRyOwp9CgpmdW5jdGlvbiBnZXRBbGlhc2VkQXR0ck5hbWUoZWxlbWVudCwgbmFtZSkgewogIHZhciBub2RlTmFtZSA9IGVsZW1lbnQubm9kZU5hbWU7CiAgcmV0dXJuIChub2RlTmFtZSA9PT0gJ0lOUFVUJyB8fCBub2RlTmFtZSA9PT0gJ1RFWFRBUkVBJykgJiYgQUxJQVNFRF9BVFRSW25hbWVdOwp9Cgpmb3JFYWNoKHsKICBkYXRhOiBqcUxpdGVEYXRhLAogIHJlbW92ZURhdGE6IGpxTGl0ZVJlbW92ZURhdGEKfSwgZnVuY3Rpb24oZm4sIG5hbWUpIHsKICBKUUxpdGVbbmFtZV0gPSBmbjsKfSk7Cgpmb3JFYWNoKHsKICBkYXRhOiBqcUxpdGVEYXRhLAogIGluaGVyaXRlZERhdGE6IGpxTGl0ZUluaGVyaXRlZERhdGEsCgogIHNjb3BlOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAvLyBDYW4ndCB1c2UganFMaXRlRGF0YSBoZXJlIGRpcmVjdGx5IHNvIHdlIHN0YXkgY29tcGF0aWJsZSB3aXRoIGpRdWVyeSEKICAgIHJldHVybiBqcUxpdGUuZGF0YShlbGVtZW50LCAnJHNjb3BlJykgfHwganFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LnBhcmVudE5vZGUgfHwgZWxlbWVudCwgWyckaXNvbGF0ZVNjb3BlJywgJyRzY29wZSddKTsKICB9LAoKICBpc29sYXRlU2NvcGU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIC8vIENhbid0IHVzZSBqcUxpdGVEYXRhIGhlcmUgZGlyZWN0bHkgc28gd2Ugc3RheSBjb21wYXRpYmxlIHdpdGggalF1ZXJ5IQogICAgcmV0dXJuIGpxTGl0ZS5kYXRhKGVsZW1lbnQsICckaXNvbGF0ZVNjb3BlJykgfHwganFMaXRlLmRhdGEoZWxlbWVudCwgJyRpc29sYXRlU2NvcGVOb1RlbXBsYXRlJyk7CiAgfSwKCiAgY29udHJvbGxlcjoganFMaXRlQ29udHJvbGxlciwKCiAgaW5qZWN0b3I6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHJldHVybiBqcUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckaW5qZWN0b3InKTsKICB9LAoKICByZW1vdmVBdHRyOiBmdW5jdGlvbihlbGVtZW50LCBuYW1lKSB7CiAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShuYW1lKTsKICB9LAoKICBoYXNDbGFzczoganFMaXRlSGFzQ2xhc3MsCgogIGNzczogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgIG5hbWUgPSBjYW1lbENhc2UobmFtZSk7CgogICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgZWxlbWVudC5zdHlsZVtuYW1lXSA9IHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGVsZW1lbnQuc3R5bGVbbmFtZV07CiAgICB9CiAgfSwKCiAgYXR0cjogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSwgdmFsdWUpewogICAgdmFyIGxvd2VyY2FzZWROYW1lID0gbG93ZXJjYXNlKG5hbWUpOwogICAgaWYgKEJPT0xFQU5fQVRUUltsb3dlcmNhc2VkTmFtZV0pIHsKICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICBpZiAoISF2YWx1ZSkgewogICAgICAgICAgZWxlbWVudFtuYW1lXSA9IHRydWU7CiAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCBsb3dlcmNhc2VkTmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSBmYWxzZTsKICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGxvd2VyY2FzZWROYW1lKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIChlbGVtZW50W25hbWVdIHx8CiAgICAgICAgICAgICAgICAgKGVsZW1lbnQuYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0obmFtZSl8fCBub29wKS5zcGVjaWZpZWQpCiAgICAgICAgICAgICAgID8gbG93ZXJjYXNlZE5hbWUKICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICB9IGVsc2UgaWYgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKSB7CiAgICAgIC8vIHRoZSBleHRyYSBhcmd1bWVudCAiMiIgaXMgdG8gZ2V0IHRoZSByaWdodCB0aGluZyBmb3IgYS5ocmVmIGluIElFLCBzZWUgalF1ZXJ5IGNvZGUKICAgICAgLy8gc29tZSBlbGVtZW50cyAoZS5nLiBEb2N1bWVudCkgZG9uJ3QgaGF2ZSBnZXQgYXR0cmlidXRlLCBzbyByZXR1cm4gdW5kZWZpbmVkCiAgICAgIHZhciByZXQgPSBlbGVtZW50LmdldEF0dHJpYnV0ZShuYW1lLCAyKTsKICAgICAgLy8gbm9ybWFsaXplIG5vbi1leGlzdGluZyBhdHRyaWJ1dGVzIHRvIHVuZGVmaW5lZCAoYXMgalF1ZXJ5KQogICAgICByZXR1cm4gcmV0ID09PSBudWxsID8gdW5kZWZpbmVkIDogcmV0OwogICAgfQogIH0sCgogIHByb3A6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7CiAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICBlbGVtZW50W25hbWVdID0gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZWxlbWVudFtuYW1lXTsKICAgIH0KICB9LAoKICB0ZXh0OiAoZnVuY3Rpb24oKSB7CiAgICBnZXRUZXh0LiRkdiA9ICcnOwogICAgcmV0dXJuIGdldFRleHQ7CgogICAgZnVuY3Rpb24gZ2V0VGV4dChlbGVtZW50LCB2YWx1ZSkgewogICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgdmFyIG5vZGVUeXBlID0gZWxlbWVudC5ub2RlVHlwZTsKICAgICAgICByZXR1cm4gKG5vZGVUeXBlID09PSBOT0RFX1RZUEVfRUxFTUVOVCB8fCBub2RlVHlwZSA9PT0gTk9ERV9UWVBFX1RFWFQpID8gZWxlbWVudC50ZXh0Q29udGVudCA6ICcnOwogICAgICB9CiAgICAgIGVsZW1lbnQudGV4dENvbnRlbnQgPSB2YWx1ZTsKICAgIH0KICB9KSgpLAoKICB2YWw6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlKSB7CiAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgIGlmIChlbGVtZW50Lm11bHRpcGxlICYmIG5vZGVOYW1lXyhlbGVtZW50KSA9PT0gJ3NlbGVjdCcpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgZm9yRWFjaChlbGVtZW50Lm9wdGlvbnMsIGZ1bmN0aW9uIChvcHRpb24pIHsKICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgcmVzdWx0LnB1c2gob3B0aW9uLnZhbHVlIHx8IG9wdGlvbi50ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA9PT0gMCA/IG51bGwgOiByZXN1bHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGVsZW1lbnQudmFsdWU7CiAgICB9CiAgICBlbGVtZW50LnZhbHVlID0gdmFsdWU7CiAgfSwKCiAgaHRtbDogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQuaW5uZXJIVE1MOwogICAgfQogICAganFMaXRlRGVhbG9jKGVsZW1lbnQsIHRydWUpOwogICAgZWxlbWVudC5pbm5lckhUTUwgPSB2YWx1ZTsKICB9LAoKICBlbXB0eToganFMaXRlRW1wdHkKfSwgZnVuY3Rpb24oZm4sIG5hbWUpewogIC8qKgogICAqIFByb3BlcnRpZXM6IHdyaXRlcyByZXR1cm4gc2VsZWN0aW9uLCByZWFkcyByZXR1cm4gZmlyc3QgdmFsdWUKICAgKi8KICBKUUxpdGUucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oYXJnMSwgYXJnMikgewogICAgdmFyIGksIGtleTsKICAgIHZhciBub2RlQ291bnQgPSB0aGlzLmxlbmd0aDsKCiAgICAvLyBqcUxpdGVIYXNDbGFzcyBoYXMgb25seSB0d28gYXJndW1lbnRzLCBidXQgaXMgYSBnZXR0ZXItb25seSBmbiwgc28gd2UgbmVlZCB0byBzcGVjaWFsLWNhc2UgaXQKICAgIC8vIGluIGEgd2F5IHRoYXQgc3Vydml2ZXMgbWluaWZpY2F0aW9uLgogICAgLy8ganFMaXRlRW1wdHkgdGFrZXMgbm8gYXJndW1lbnRzIGJ1dCBpcyBhIHNldHRlci4KICAgIGlmIChmbiAhPT0ganFMaXRlRW1wdHkgJiYKICAgICAgICAoKChmbi5sZW5ndGggPT0gMiAmJiAoZm4gIT09IGpxTGl0ZUhhc0NsYXNzICYmIGZuICE9PSBqcUxpdGVDb250cm9sbGVyKSkgPyBhcmcxIDogYXJnMikgPT09IHVuZGVmaW5lZCkpIHsKICAgICAgaWYgKGlzT2JqZWN0KGFyZzEpKSB7CgogICAgICAgIC8vIHdlIGFyZSBhIHdyaXRlLCBidXQgdGhlIG9iamVjdCBwcm9wZXJ0aWVzIGFyZSB0aGUga2V5L3ZhbHVlcwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBub2RlQ291bnQ7IGkrKykgewogICAgICAgICAgaWYgKGZuID09PSBqcUxpdGVEYXRhKSB7CiAgICAgICAgICAgIC8vIGRhdGEoKSB0YWtlcyB0aGUgd2hvbGUgb2JqZWN0IGluIGpRdWVyeQogICAgICAgICAgICBmbih0aGlzW2ldLCBhcmcxKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIGFyZzEpIHsKICAgICAgICAgICAgICBmbih0aGlzW2ldLCBrZXksIGFyZzFba2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gd2UgYXJlIGEgcmVhZCwgc28gcmVhZCB0aGUgZmlyc3QgY2hpbGQuCiAgICAgICAgLy8gVE9ETzogZG8gd2Ugc3RpbGwgbmVlZCB0aGlzPwogICAgICAgIHZhciB2YWx1ZSA9IGZuLiRkdjsKICAgICAgICAvLyBPbmx5IGlmIHdlIGhhdmUgJGR2IGRvIHdlIGl0ZXJhdGUgb3ZlciBhbGwsIG90aGVyd2lzZSBpdCBpcyBqdXN0IHRoZSBmaXJzdCBlbGVtZW50LgogICAgICAgIHZhciBqaiA9ICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/IE1hdGgubWluKG5vZGVDb3VudCwgMSkgOiBub2RlQ291bnQ7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBqajsgaisrKSB7CiAgICAgICAgICB2YXIgbm9kZVZhbHVlID0gZm4odGhpc1tqXSwgYXJnMSwgYXJnMik7CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlID8gdmFsdWUgKyBub2RlVmFsdWUgOiBub2RlVmFsdWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gd2UgYXJlIGEgd3JpdGUsIHNvIGFwcGx5IHRvIGFsbCBjaGlsZHJlbgogICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZUNvdW50OyBpKyspIHsKICAgICAgICBmbih0aGlzW2ldLCBhcmcxLCBhcmcyKTsKICAgICAgfQogICAgICAvLyByZXR1cm4gc2VsZiBmb3IgY2hhaW5pbmcKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfTsKfSk7CgpmdW5jdGlvbiBjcmVhdGVFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnRzKSB7CiAgdmFyIGV2ZW50SGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCwgdHlwZSkgewogICAgLy8galF1ZXJ5IHNwZWNpZmljIGFwaQogICAgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBldmVudC5kZWZhdWx0UHJldmVudGVkOwogICAgfTsKCiAgICB2YXIgZXZlbnRGbnMgPSBldmVudHNbdHlwZSB8fCBldmVudC50eXBlXTsKICAgIHZhciBldmVudEZuc0xlbmd0aCA9IGV2ZW50Rm5zID8gZXZlbnRGbnMubGVuZ3RoIDogMDsKCiAgICBpZiAoIWV2ZW50Rm5zTGVuZ3RoKSByZXR1cm47CgogICAgaWYgKGlzVW5kZWZpbmVkKGV2ZW50LmltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCkpIHsKICAgICAgdmFyIG9yaWdpbmFsU3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uID0gZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOwogICAgICBldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICBldmVudC5pbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSB0cnVlOwoKICAgICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB7CiAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICB9CgogICAgICAgIGlmIChvcmlnaW5hbFN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbikgewogICAgICAgICAgb3JpZ2luYWxTdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24uY2FsbChldmVudCk7CiAgICAgICAgfQogICAgICB9OwogICAgfQoKICAgIGV2ZW50LmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBldmVudC5pbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPT09IHRydWU7CiAgICB9OwoKICAgIC8vIENvcHkgZXZlbnQgaGFuZGxlcnMgaW4gY2FzZSBldmVudCBoYW5kbGVycyBhcnJheSBpcyBtb2RpZmllZCBkdXJpbmcgZXhlY3V0aW9uLgogICAgaWYgKChldmVudEZuc0xlbmd0aCA+IDEpKSB7CiAgICAgIGV2ZW50Rm5zID0gc2hhbGxvd0NvcHkoZXZlbnRGbnMpOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRGbnNMZW5ndGg7IGkrKykgewogICAgICBpZiAoIWV2ZW50LmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICBldmVudEZuc1tpXS5jYWxsKGVsZW1lbnQsIGV2ZW50KTsKICAgICAgfQogICAgfQogIH07CgogIC8vIFRPRE86IHRoaXMgaXMgYSBoYWNrIGZvciBhbmd1bGFyTW9ja3MvY2xlYXJEYXRhQ2FjaGUgdGhhdCBtYWtlcyBpdCBwb3NzaWJsZSB0byBkZXJlZ2lzdGVyIGFsbAogIC8vICAgICAgIGV2ZW50cyBvbiBgZWxlbWVudGAKICBldmVudEhhbmRsZXIuZWxlbSA9IGVsZW1lbnQ7CiAgcmV0dXJuIGV2ZW50SGFuZGxlcjsKfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIEZ1bmN0aW9ucyBpdGVyYXRpbmcgdHJhdmVyc2FsLgovLyBUaGVzZSBmdW5jdGlvbnMgY2hhaW4gcmVzdWx0cyBpbnRvIGEgc2luZ2xlCi8vIHNlbGVjdG9yLgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KZm9yRWFjaCh7CiAgcmVtb3ZlRGF0YToganFMaXRlUmVtb3ZlRGF0YSwKCiAgb246IGZ1bmN0aW9uIGpxTGl0ZU9uKGVsZW1lbnQsIHR5cGUsIGZuLCB1bnN1cHBvcnRlZCl7CiAgICBpZiAoaXNEZWZpbmVkKHVuc3VwcG9ydGVkKSkgdGhyb3cganFMaXRlTWluRXJyKCdvbmFyZ3MnLCAnanFMaXRlI29uKCkgZG9lcyBub3Qgc3VwcG9ydCB0aGUgYHNlbGVjdG9yYCBvciBgZXZlbnREYXRhYCBwYXJhbWV0ZXJzJyk7CgogICAgLy8gRG8gbm90IGFkZCBldmVudCBoYW5kbGVycyB0byBub24tZWxlbWVudHMgYmVjYXVzZSB0aGV5IHdpbGwgbm90IGJlIGNsZWFuZWQgdXAuCiAgICBpZiAoIWpxTGl0ZUFjY2VwdHNEYXRhKGVsZW1lbnQpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgZXhwYW5kb1N0b3JlID0ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsIHRydWUpOwogICAgdmFyIGV2ZW50cyA9IGV4cGFuZG9TdG9yZS5ldmVudHM7CiAgICB2YXIgaGFuZGxlID0gZXhwYW5kb1N0b3JlLmhhbmRsZTsKCiAgICBpZiAoIWhhbmRsZSkgewogICAgICBoYW5kbGUgPSBleHBhbmRvU3RvcmUuaGFuZGxlID0gY3JlYXRlRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50cyk7CiAgICB9CgogICAgLy8gaHR0cDovL2pzcGVyZi5jb20vc3RyaW5nLWluZGV4b2YtdnMtc3BsaXQKICAgIHZhciB0eXBlcyA9IHR5cGUuaW5kZXhPZignICcpID49IDAgPyB0eXBlLnNwbGl0KCcgJykgOiBbdHlwZV07CiAgICB2YXIgaSA9IHR5cGVzLmxlbmd0aDsKCiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHR5cGUgPSB0eXBlc1tpXTsKICAgICAgdmFyIGV2ZW50Rm5zID0gZXZlbnRzW3R5cGVdOwoKICAgICAgaWYgKCFldmVudEZucykgewogICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ21vdXNlZW50ZXInIHx8IHR5cGUgPT09ICdtb3VzZWxlYXZlJykgewogICAgICAgICAgLy8gUmVmZXIgdG8galF1ZXJ5J3MgaW1wbGVtZW50YXRpb24gb2YgbW91c2VlbnRlciAmIG1vdXNlbGVhdmUKICAgICAgICAgIC8vIFJlYWQgYWJvdXQgbW91c2VlbnRlciBhbmQgbW91c2VsZWF2ZToKICAgICAgICAgIC8vIGh0dHA6Ly93d3cucXVpcmtzbW9kZS5vcmcvanMvZXZlbnRzX21vdXNlLmh0bWwjbGluazgKCiAgICAgICAgICBqcUxpdGVPbihlbGVtZW50LCBNT1VTRV9FVkVOVF9NQVBbdHlwZV0sIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLCByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgICAgLy8gRm9yIG1vdXNlbnRlci9sZWF2ZSBjYWxsIHRoZSBoYW5kbGVyIGlmIHJlbGF0ZWQgaXMgb3V0c2lkZSB0aGUgdGFyZ2V0LgogICAgICAgICAgICAvLyBOQjogTm8gcmVsYXRlZFRhcmdldCBpZiB0aGUgbW91c2UgbGVmdC9lbnRlcmVkIHRoZSBicm93c2VyIHdpbmRvdwogICAgICAgICAgICBpZiAoICFyZWxhdGVkIHx8IChyZWxhdGVkICE9PSB0YXJnZXQgJiYgIXRhcmdldC5jb250YWlucyhyZWxhdGVkKSkgKXsKICAgICAgICAgICAgICBoYW5kbGUoZXZlbnQsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh0eXBlICE9PSAnJGRlc3Ryb3knKSB7CiAgICAgICAgICAgIGFkZEV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBoYW5kbGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBldmVudEZucyA9IGV2ZW50c1t0eXBlXTsKICAgICAgfQogICAgICBldmVudEZucy5wdXNoKGZuKTsKICAgIH0KICB9LAoKICBvZmY6IGpxTGl0ZU9mZiwKCiAgb25lOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbikgewogICAgZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KTsKCiAgICAvL2FkZCB0aGUgbGlzdGVuZXIgdHdpY2Ugc28gdGhhdCB3aGVuIGl0IGlzIGNhbGxlZAogICAgLy95b3UgY2FuIHJlbW92ZSB0aGUgb3JpZ2luYWwgZnVuY3Rpb24gYW5kIHN0aWxsIGJlCiAgICAvL2FibGUgdG8gY2FsbCBlbGVtZW50Lm9mZihldiwgZm4pIG5vcm1hbGx5CiAgICBlbGVtZW50Lm9uKHR5cGUsIGZ1bmN0aW9uIG9uRm4oKSB7CiAgICAgIGVsZW1lbnQub2ZmKHR5cGUsIGZuKTsKICAgICAgZWxlbWVudC5vZmYodHlwZSwgb25Gbik7CiAgICB9KTsKICAgIGVsZW1lbnQub24odHlwZSwgZm4pOwogIH0sCgogIHJlcGxhY2VXaXRoOiBmdW5jdGlvbihlbGVtZW50LCByZXBsYWNlTm9kZSkgewogICAgdmFyIGluZGV4LCBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICBqcUxpdGVEZWFsb2MoZWxlbWVudCk7CiAgICBmb3JFYWNoKG5ldyBKUUxpdGUocmVwbGFjZU5vZGUpLCBmdW5jdGlvbihub2RlKXsKICAgICAgaWYgKGluZGV4KSB7CiAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCBpbmRleC5uZXh0U2libGluZyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZChub2RlLCBlbGVtZW50KTsKICAgICAgfQogICAgICBpbmRleCA9IG5vZGU7CiAgICB9KTsKICB9LAoKICBjaGlsZHJlbjogZnVuY3Rpb24oZWxlbWVudCkgewogICAgdmFyIGNoaWxkcmVuID0gW107CiAgICBmb3JFYWNoKGVsZW1lbnQuY2hpbGROb2RlcywgZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSBOT0RFX1RZUEVfRUxFTUVOVCkKICAgICAgICBjaGlsZHJlbi5wdXNoKGVsZW1lbnQpOwogICAgfSk7CiAgICByZXR1cm4gY2hpbGRyZW47CiAgfSwKCiAgY29udGVudHM6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHJldHVybiBlbGVtZW50LmNvbnRlbnREb2N1bWVudCB8fCBlbGVtZW50LmNoaWxkTm9kZXMgfHwgW107CiAgfSwKCiAgYXBwZW5kOiBmdW5jdGlvbihlbGVtZW50LCBub2RlKSB7CiAgICB2YXIgbm9kZVR5cGUgPSBlbGVtZW50Lm5vZGVUeXBlOwogICAgaWYgKG5vZGVUeXBlICE9PSBOT0RFX1RZUEVfRUxFTUVOVCAmJiBub2RlVHlwZSAhPT0gTk9ERV9UWVBFX0RPQ1VNRU5UX0ZSQUdNRU5UKSByZXR1cm47CgogICAgbm9kZSA9IG5ldyBKUUxpdGUobm9kZSk7CgogICAgZm9yICh2YXIgaSA9IDAsIGlpID0gbm9kZS5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgIHZhciBjaGlsZCA9IG5vZGVbaV07CiAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgfQogIH0sCgogIHByZXBlbmQ6IGZ1bmN0aW9uKGVsZW1lbnQsIG5vZGUpIHsKICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSBOT0RFX1RZUEVfRUxFTUVOVCkgewogICAgICB2YXIgaW5kZXggPSBlbGVtZW50LmZpcnN0Q2hpbGQ7CiAgICAgIGZvckVhY2gobmV3IEpRTGl0ZShub2RlKSwgZnVuY3Rpb24oY2hpbGQpewogICAgICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNoaWxkLCBpbmRleCk7CiAgICAgIH0pOwogICAgfQogIH0sCgogIHdyYXA6IGZ1bmN0aW9uKGVsZW1lbnQsIHdyYXBOb2RlKSB7CiAgICB3cmFwTm9kZSA9IGpxTGl0ZSh3cmFwTm9kZSkuZXEoMCkuY2xvbmUoKVswXTsKICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICBpZiAocGFyZW50KSB7CiAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQod3JhcE5vZGUsIGVsZW1lbnQpOwogICAgfQogICAgd3JhcE5vZGUuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CiAgfSwKCiAgcmVtb3ZlOiBqcUxpdGVSZW1vdmUsCgogIGRldGFjaDogZnVuY3Rpb24oZWxlbWVudCkgewogICAganFMaXRlUmVtb3ZlKGVsZW1lbnQsIHRydWUpOwogIH0sCgogIGFmdGVyOiBmdW5jdGlvbihlbGVtZW50LCBuZXdFbGVtZW50KSB7CiAgICB2YXIgaW5kZXggPSBlbGVtZW50LCBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICBuZXdFbGVtZW50ID0gbmV3IEpRTGl0ZShuZXdFbGVtZW50KTsKCiAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBuZXdFbGVtZW50Lmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgdmFyIG5vZGUgPSBuZXdFbGVtZW50W2ldOwogICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIGluZGV4Lm5leHRTaWJsaW5nKTsKICAgICAgaW5kZXggPSBub2RlOwogICAgfQogIH0sCgogIGFkZENsYXNzOiBqcUxpdGVBZGRDbGFzcywKICByZW1vdmVDbGFzczoganFMaXRlUmVtb3ZlQ2xhc3MsCgogIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbihlbGVtZW50LCBzZWxlY3RvciwgY29uZGl0aW9uKSB7CiAgICBpZiAoc2VsZWN0b3IpIHsKICAgICAgZm9yRWFjaChzZWxlY3Rvci5zcGxpdCgnICcpLCBmdW5jdGlvbihjbGFzc05hbWUpewogICAgICAgIHZhciBjbGFzc0NvbmRpdGlvbiA9IGNvbmRpdGlvbjsKICAgICAgICBpZiAoaXNVbmRlZmluZWQoY2xhc3NDb25kaXRpb24pKSB7CiAgICAgICAgICBjbGFzc0NvbmRpdGlvbiA9ICFqcUxpdGVIYXNDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgIH0KICAgICAgICAoY2xhc3NDb25kaXRpb24gPyBqcUxpdGVBZGRDbGFzcyA6IGpxTGl0ZVJlbW92ZUNsYXNzKShlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICB9KTsKICAgIH0KICB9LAoKICBwYXJlbnQ6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICByZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gTk9ERV9UWVBFX0RPQ1VNRU5UX0ZSQUdNRU5UID8gcGFyZW50IDogbnVsbDsKICB9LAoKICBuZXh0OiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICByZXR1cm4gZWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgfSwKCiAgZmluZDogZnVuY3Rpb24oZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgIGlmIChlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKSB7CiAgICAgIHJldHVybiBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KICB9LAoKICBjbG9uZToganFMaXRlQ2xvbmUsCgogIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbihlbGVtZW50LCBldmVudCwgZXh0cmFQYXJhbWV0ZXJzKSB7CgogICAgdmFyIGR1bW15RXZlbnQsIGV2ZW50Rm5zQ29weSwgaGFuZGxlckFyZ3M7CiAgICB2YXIgZXZlbnROYW1lID0gZXZlbnQudHlwZSB8fCBldmVudDsKICAgIHZhciBleHBhbmRvU3RvcmUgPSBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCk7CiAgICB2YXIgZXZlbnRzID0gZXhwYW5kb1N0b3JlICYmIGV4cGFuZG9TdG9yZS5ldmVudHM7CiAgICB2YXIgZXZlbnRGbnMgPSBldmVudHMgJiYgZXZlbnRzW2V2ZW50TmFtZV07CgogICAgaWYgKGV2ZW50Rm5zKSB7CiAgICAgIC8vIENyZWF0ZSBhIGR1bW15IGV2ZW50IHRvIHBhc3MgdG8gdGhlIGhhbmRsZXJzCiAgICAgIGR1bW15RXZlbnQgPSB7CiAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgeyB0aGlzLmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOyB9LAogICAgICAgIGlzRGVmYXVsdFByZXZlbnRlZDogZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzLmRlZmF1bHRQcmV2ZW50ZWQgPT09IHRydWU7IH0sCiAgICAgICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsgdGhpcy5pbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSB0cnVlOyB9LAogICAgICAgIGlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOiBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuaW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkID09PSB0cnVlOyB9LAogICAgICAgIHN0b3BQcm9wYWdhdGlvbjogbm9vcCwKICAgICAgICB0eXBlOiBldmVudE5hbWUsCiAgICAgICAgdGFyZ2V0OiBlbGVtZW50CiAgICAgIH07CgogICAgICAvLyBJZiBhIGN1c3RvbSBldmVudCB3YXMgcHJvdmlkZWQgdGhlbiBleHRlbmQgb3VyIGR1bW15IGV2ZW50IHdpdGggaXQKICAgICAgaWYgKGV2ZW50LnR5cGUpIHsKICAgICAgICBkdW1teUV2ZW50ID0gZXh0ZW5kKGR1bW15RXZlbnQsIGV2ZW50KTsKICAgICAgfQoKICAgICAgLy8gQ29weSBldmVudCBoYW5kbGVycyBpbiBjYXNlIGV2ZW50IGhhbmRsZXJzIGFycmF5IGlzIG1vZGlmaWVkIGR1cmluZyBleGVjdXRpb24uCiAgICAgIGV2ZW50Rm5zQ29weSA9IHNoYWxsb3dDb3B5KGV2ZW50Rm5zKTsKICAgICAgaGFuZGxlckFyZ3MgPSBleHRyYVBhcmFtZXRlcnMgPyBbZHVtbXlFdmVudF0uY29uY2F0KGV4dHJhUGFyYW1ldGVycykgOiBbZHVtbXlFdmVudF07CgogICAgICBmb3JFYWNoKGV2ZW50Rm5zQ29weSwgZnVuY3Rpb24oZm4pIHsKICAgICAgICBpZiAoIWR1bW15RXZlbnQuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgZm4uYXBwbHkoZWxlbWVudCwgaGFuZGxlckFyZ3MpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQp9LCBmdW5jdGlvbihmbiwgbmFtZSl7CiAgLyoqCiAgICogY2hhaW5pbmcgZnVuY3Rpb25zCiAgICovCiAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKGFyZzEsIGFyZzIsIGFyZzMpIHsKICAgIHZhciB2YWx1ZTsKCiAgICBmb3IodmFyIGkgPSAwLCBpaSA9IHRoaXMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgdmFsdWUgPSBmbih0aGlzW2ldLCBhcmcxLCBhcmcyLCBhcmczKTsKICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgLy8gYW55IGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYSB2YWx1ZSBuZWVkcyB0byBiZSB3cmFwcGVkCiAgICAgICAgICB2YWx1ZSA9IGpxTGl0ZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGpxTGl0ZUFkZE5vZGVzKHZhbHVlLCBmbih0aGlzW2ldLCBhcmcxLCBhcmcyLCBhcmczKSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpc0RlZmluZWQodmFsdWUpID8gdmFsdWUgOiB0aGlzOwogIH07CgogIC8vIGJpbmQgbGVnYWN5IGJpbmQvdW5iaW5kIHRvIG9uL29mZgogIEpRTGl0ZS5wcm90b3R5cGUuYmluZCA9IEpRTGl0ZS5wcm90b3R5cGUub247CiAgSlFMaXRlLnByb3RvdHlwZS51bmJpbmQgPSBKUUxpdGUucHJvdG90eXBlLm9mZjsKfSk7CgovKioKICogQ29tcHV0ZXMgYSBoYXNoIG9mIGFuICdvYmonLgogKiBIYXNoIG9mIGE6CiAqICBzdHJpbmcgaXMgc3RyaW5nCiAqICBudW1iZXIgaXMgbnVtYmVyIGFzIHN0cmluZwogKiAgb2JqZWN0IGlzIGVpdGhlciByZXN1bHQgb2YgY2FsbGluZyAkJGhhc2hLZXkgZnVuY3Rpb24gb24gdGhlIG9iamVjdCBvciB1bmlxdWVseSBnZW5lcmF0ZWQgaWQsCiAqICAgICAgICAgdGhhdCBpcyBhbHNvIGFzc2lnbmVkIHRvIHRoZSAkJGhhc2hLZXkgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4KICoKICogQHBhcmFtIG9iagogKiBAcmV0dXJucyB7c3RyaW5nfSBoYXNoIHN0cmluZyBzdWNoIHRoYXQgdGhlIHNhbWUgaW5wdXQgd2lsbCBoYXZlIHRoZSBzYW1lIGhhc2ggc3RyaW5nLgogKiAgICAgICAgIFRoZSByZXN1bHRpbmcgc3RyaW5nIGtleSBpcyBpbiAndHlwZTpoYXNoS2V5JyBmb3JtYXQuCiAqLwpmdW5jdGlvbiBoYXNoS2V5KG9iaiwgbmV4dFVpZEZuKSB7CiAgdmFyIGtleSA9IG9iaiAmJiBvYmouJCRoYXNoS2V5OwoKICBpZiAoa2V5KSB7CiAgICBpZiAodHlwZW9mIGtleSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBrZXkgPSBvYmouJCRoYXNoS2V5KCk7CiAgICB9CiAgICByZXR1cm4ga2V5OwogIH0KCiAgdmFyIG9ialR5cGUgPSB0eXBlb2Ygb2JqOwogIGlmIChvYmpUeXBlID09ICdmdW5jdGlvbicgfHwgKG9ialR5cGUgPT0gJ29iamVjdCcgJiYgb2JqICE9PSBudWxsKSkgewogICAga2V5ID0gb2JqLiQkaGFzaEtleSA9IG9ialR5cGUgKyAnOicgKyAobmV4dFVpZEZuIHx8IG5leHRVaWQpKCk7CiAgfSBlbHNlIHsKICAgIGtleSA9IG9ialR5cGUgKyAnOicgKyBvYmo7CiAgfQoKICByZXR1cm4ga2V5Owp9CgovKioKICogSGFzaE1hcCB3aGljaCBjYW4gdXNlIG9iamVjdHMgYXMga2V5cwogKi8KZnVuY3Rpb24gSGFzaE1hcChhcnJheSwgaXNvbGF0ZWRVaWQpIHsKICBpZiAoaXNvbGF0ZWRVaWQpIHsKICAgIHZhciB1aWQgPSAwOwogICAgdGhpcy5uZXh0VWlkID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiArK3VpZDsKICAgIH07CiAgfQogIGZvckVhY2goYXJyYXksIHRoaXMucHV0LCB0aGlzKTsKfQpIYXNoTWFwLnByb3RvdHlwZSA9IHsKICAvKioKICAgKiBTdG9yZSBrZXkgdmFsdWUgcGFpcgogICAqIEBwYXJhbSBrZXkga2V5IHRvIHN0b3JlIGNhbiBiZSBhbnkgdHlwZQogICAqIEBwYXJhbSB2YWx1ZSB2YWx1ZSB0byBzdG9yZSBjYW4gYmUgYW55IHR5cGUKICAgKi8KICBwdXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIHRoaXNbaGFzaEtleShrZXksIHRoaXMubmV4dFVpZCldID0gdmFsdWU7CiAgfSwKCiAgLyoqCiAgICogQHBhcmFtIGtleQogICAqIEByZXR1cm5zIHtPYmplY3R9IHRoZSB2YWx1ZSBmb3IgdGhlIGtleQogICAqLwogIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICByZXR1cm4gdGhpc1toYXNoS2V5KGtleSwgdGhpcy5uZXh0VWlkKV07CiAgfSwKCiAgLyoqCiAgICogUmVtb3ZlIHRoZSBrZXkvdmFsdWUgcGFpcgogICAqIEBwYXJhbSBrZXkKICAgKi8KICByZW1vdmU6IGZ1bmN0aW9uKGtleSkgewogICAgdmFyIHZhbHVlID0gdGhpc1trZXkgPSBoYXNoS2V5KGtleSwgdGhpcy5uZXh0VWlkKV07CiAgICBkZWxldGUgdGhpc1trZXldOwogICAgcmV0dXJuIHZhbHVlOwogIH0KfTsKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG1vZHVsZSBuZwogKiBAbmFtZSBhbmd1bGFyLmluamVjdG9yCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDcmVhdGVzIGFuIGluamVjdG9yIG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIGZvciByZXRyaWV2aW5nIHNlcnZpY2VzIGFzIHdlbGwgYXMgZm9yCiAqIGRlcGVuZGVuY3kgaW5qZWN0aW9uIChzZWUge0BsaW5rIGd1aWRlL2RpIGRlcGVuZGVuY3kgaW5qZWN0aW9ufSkuCiAqCgogKiBAcGFyYW0ge0FycmF5LjxzdHJpbmd8RnVuY3Rpb24+fSBtb2R1bGVzIEEgbGlzdCBvZiBtb2R1bGUgZnVuY3Rpb25zIG9yIHRoZWlyIGFsaWFzZXMuIFNlZQogKiAgICAgICAge0BsaW5rIGFuZ3VsYXIubW9kdWxlfS4gVGhlIGBuZ2AgbW9kdWxlIG11c3QgYmUgZXhwbGljaXRseSBhZGRlZC4KICogQHJldHVybnMge2luamVjdG9yfSBJbmplY3RvciBvYmplY3QuIFNlZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4KICoKICogQGV4YW1wbGUKICogVHlwaWNhbCB1c2FnZQogKiBgYGBqcwogKiAgIC8vIGNyZWF0ZSBhbiBpbmplY3RvcgogKiAgIHZhciAkaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKFsnbmcnXSk7CiAqCiAqICAgLy8gdXNlIHRoZSBpbmplY3RvciB0byBraWNrIG9mZiB5b3VyIGFwcGxpY2F0aW9uCiAqICAgLy8gdXNlIHRoZSB0eXBlIGluZmVyZW5jZSB0byBhdXRvIGluamVjdCBhcmd1bWVudHMsIG9yIHVzZSBpbXBsaWNpdCBpbmplY3Rpb24KICogICAkaW5qZWN0b3IuaW52b2tlKGZ1bmN0aW9uKCRyb290U2NvcGUsICRjb21waWxlLCAkZG9jdW1lbnQpIHsKICogICAgICRjb21waWxlKCRkb2N1bWVudCkoJHJvb3RTY29wZSk7CiAqICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICogICB9KTsKICogYGBgCiAqCiAqIFNvbWV0aW1lcyB5b3Ugd2FudCB0byBnZXQgYWNjZXNzIHRvIHRoZSBpbmplY3RvciBvZiBhIGN1cnJlbnRseSBydW5uaW5nIEFuZ3VsYXIgYXBwCiAqIGZyb20gb3V0c2lkZSBBbmd1bGFyLiBQZXJoYXBzLCB5b3Ugd2FudCB0byBpbmplY3QgYW5kIGNvbXBpbGUgc29tZSBtYXJrdXAgYWZ0ZXIgdGhlCiAqIGFwcGxpY2F0aW9uIGhhcyBiZWVuIGJvb3RzdHJhcHBlZC4gWW91IGNhbiBkbyB0aGlzIHVzaW5nIHRoZSBleHRyYSBgaW5qZWN0b3IoKWAgYWRkZWQKICogdG8gSlF1ZXJ5L2pxTGl0ZSBlbGVtZW50cy4gU2VlIHtAbGluayBhbmd1bGFyLmVsZW1lbnR9LgogKgogKiAqVGhpcyBpcyBmYWlybHkgcmFyZSBidXQgY291bGQgYmUgdGhlIGNhc2UgaWYgYSB0aGlyZCBwYXJ0eSBsaWJyYXJ5IGlzIGluamVjdGluZyB0aGUKICogbWFya3VwLioKICoKICogSW4gdGhlIGZvbGxvd2luZyBleGFtcGxlIGEgbmV3IGJsb2NrIG9mIEhUTUwgY29udGFpbmluZyBhIGBuZy1jb250cm9sbGVyYAogKiBkaXJlY3RpdmUgaXMgYWRkZWQgdG8gdGhlIGVuZCBvZiB0aGUgZG9jdW1lbnQgYm9keSBieSBKUXVlcnkuIFdlIHRoZW4gY29tcGlsZSBhbmQgbGluawogKiBpdCBpbnRvIHRoZSBjdXJyZW50IEFuZ3VsYXJKUyBzY29wZS4KICoKICogYGBganMKICogdmFyICRkaXYgPSAkKCc8ZGl2IG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+e3tjb250ZW50LmxhYmVsfX08L2Rpdj4nKTsKICogJChkb2N1bWVudC5ib2R5KS5hcHBlbmQoJGRpdik7CiAqCiAqIGFuZ3VsYXIuZWxlbWVudChkb2N1bWVudCkuaW5qZWN0b3IoKS5pbnZva2UoZnVuY3Rpb24oJGNvbXBpbGUpIHsKICogICB2YXIgc2NvcGUgPSBhbmd1bGFyLmVsZW1lbnQoJGRpdikuc2NvcGUoKTsKICogICAkY29tcGlsZSgkZGl2KShzY29wZSk7CiAqIH0pOwogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBtb2R1bGUKICogQG5hbWUgYXV0bwogKiBAZGVzY3JpcHRpb24KICoKICogSW1wbGljaXQgbW9kdWxlIHdoaWNoIGdldHMgYXV0b21hdGljYWxseSBhZGRlZCB0byBlYWNoIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LgogKi8KCnZhciBGTl9BUkdTID0gL15mdW5jdGlvblxzKlteXChdKlwoXHMqKFteXCldKilcKS9tOwp2YXIgRk5fQVJHX1NQTElUID0gLywvOwp2YXIgRk5fQVJHID0gL15ccyooXz8pKFxTKz8pXDFccyokLzsKdmFyIFNUUklQX0NPTU1FTlRTID0gLygoXC9cLy4qJCl8KFwvXCpbXHNcU10qP1wqXC8pKS9tZzsKdmFyICRpbmplY3Rvck1pbkVyciA9IG1pbkVycignJGluamVjdG9yJyk7CgpmdW5jdGlvbiBhbm9uRm4oZm4pIHsKICAvLyBGb3IgYW5vbnltb3VzIGZ1bmN0aW9ucywgc2hvd2luZyBhdCB0aGUgdmVyeSBsZWFzdCB0aGUgZnVuY3Rpb24gc2lnbmF0dXJlIGNhbiBoZWxwIGluCiAgLy8gZGVidWdnaW5nLgogIHZhciBmblRleHQgPSBmbi50b1N0cmluZygpLnJlcGxhY2UoU1RSSVBfQ09NTUVOVFMsICcnKSwKICAgICAgYXJncyA9IGZuVGV4dC5tYXRjaChGTl9BUkdTKTsKICBpZiAoYXJncykgewogICAgcmV0dXJuICdmdW5jdGlvbignICsgKGFyZ3NbMV0gfHwgJycpLnJlcGxhY2UoL1tcc1xyXG5dKy8sICcgJykgKyAnKSc7CiAgfQogIHJldHVybiAnZm4nOwp9CgpmdW5jdGlvbiBhbm5vdGF0ZShmbiwgc3RyaWN0RGksIG5hbWUpIHsKICB2YXIgJGluamVjdCwKICAgICAgZm5UZXh0LAogICAgICBhcmdEZWNsLAogICAgICBsYXN0OwoKICBpZiAodHlwZW9mIGZuID09PSAnZnVuY3Rpb24nKSB7CiAgICBpZiAoISgkaW5qZWN0ID0gZm4uJGluamVjdCkpIHsKICAgICAgJGluamVjdCA9IFtdOwogICAgICBpZiAoZm4ubGVuZ3RoKSB7CiAgICAgICAgaWYgKHN0cmljdERpKSB7CiAgICAgICAgICBpZiAoIWlzU3RyaW5nKG5hbWUpIHx8ICFuYW1lKSB7CiAgICAgICAgICAgIG5hbWUgPSBmbi5uYW1lIHx8IGFub25Gbihmbik7CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ3N0cmljdGRpJywKICAgICAgICAgICAgJ3swfSBpcyBub3QgdXNpbmcgZXhwbGljaXQgYW5ub3RhdGlvbiBhbmQgY2Fubm90IGJlIGludm9rZWQgaW4gc3RyaWN0IG1vZGUnLCBuYW1lKTsKICAgICAgICB9CiAgICAgICAgZm5UZXh0ID0gZm4udG9TdHJpbmcoKS5yZXBsYWNlKFNUUklQX0NPTU1FTlRTLCAnJyk7CiAgICAgICAgYXJnRGVjbCA9IGZuVGV4dC5tYXRjaChGTl9BUkdTKTsKICAgICAgICBmb3JFYWNoKGFyZ0RlY2xbMV0uc3BsaXQoRk5fQVJHX1NQTElUKSwgZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICBhcmcucmVwbGFjZShGTl9BUkcsIGZ1bmN0aW9uKGFsbCwgdW5kZXJzY29yZSwgbmFtZSkgewogICAgICAgICAgICAkaW5qZWN0LnB1c2gobmFtZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBmbi4kaW5qZWN0ID0gJGluamVjdDsKICAgIH0KICB9IGVsc2UgaWYgKGlzQXJyYXkoZm4pKSB7CiAgICBsYXN0ID0gZm4ubGVuZ3RoIC0gMTsKICAgIGFzc2VydEFyZ0ZuKGZuW2xhc3RdLCAnZm4nKTsKICAgICRpbmplY3QgPSBmbi5zbGljZSgwLCBsYXN0KTsKICB9IGVsc2UgewogICAgYXNzZXJ0QXJnRm4oZm4sICdmbicsIHRydWUpOwogIH0KICByZXR1cm4gJGluamVjdDsKfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGluamVjdG9yCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBgJGluamVjdG9yYCBpcyB1c2VkIHRvIHJldHJpZXZlIG9iamVjdCBpbnN0YW5jZXMgYXMgZGVmaW5lZCBieQogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSBwcm92aWRlcn0sIGluc3RhbnRpYXRlIHR5cGVzLCBpbnZva2UgbWV0aG9kcywKICogYW5kIGxvYWQgbW9kdWxlcy4KICoKICogVGhlIGZvbGxvd2luZyBhbHdheXMgaG9sZHMgdHJ1ZToKICoKICogYGBganMKICogICB2YXIgJGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcigpOwogKiAgIGV4cGVjdCgkaW5qZWN0b3IuZ2V0KCckaW5qZWN0b3InKSkudG9CZSgkaW5qZWN0b3IpOwogKiAgIGV4cGVjdCgkaW5qZWN0b3IuaW52b2tlKGZ1bmN0aW9uKCRpbmplY3RvcikgewogKiAgICAgcmV0dXJuICRpbmplY3RvcjsKICogICB9KSkudG9CZSgkaW5qZWN0b3IpOwogKiBgYGAKICoKICogIyBJbmplY3Rpb24gRnVuY3Rpb24gQW5ub3RhdGlvbgogKgogKiBKYXZhU2NyaXB0IGRvZXMgbm90IGhhdmUgYW5ub3RhdGlvbnMsIGFuZCBhbm5vdGF0aW9ucyBhcmUgbmVlZGVkIGZvciBkZXBlbmRlbmN5IGluamVjdGlvbi4gVGhlCiAqIGZvbGxvd2luZyBhcmUgYWxsIHZhbGlkIHdheXMgb2YgYW5ub3RhdGluZyBmdW5jdGlvbiB3aXRoIGluamVjdGlvbiBhcmd1bWVudHMgYW5kIGFyZSBlcXVpdmFsZW50LgogKgogKiBgYGBqcwogKiAgIC8vIGluZmVycmVkIChvbmx5IHdvcmtzIGlmIGNvZGUgbm90IG1pbmlmaWVkL29iZnVzY2F0ZWQpCiAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbihzZXJ2aWNlQSl7fSk7CiAqCiAqICAgLy8gYW5ub3RhdGVkCiAqICAgZnVuY3Rpb24gZXhwbGljaXQoc2VydmljZUEpIHt9OwogKiAgIGV4cGxpY2l0LiRpbmplY3QgPSBbJ3NlcnZpY2VBJ107CiAqICAgJGluamVjdG9yLmludm9rZShleHBsaWNpdCk7CiAqCiAqICAgLy8gaW5saW5lCiAqICAgJGluamVjdG9yLmludm9rZShbJ3NlcnZpY2VBJywgZnVuY3Rpb24oc2VydmljZUEpe31dKTsKICogYGBgCiAqCiAqICMjIEluZmVyZW5jZQogKgogKiBJbiBKYXZhU2NyaXB0IGNhbGxpbmcgYHRvU3RyaW5nKClgIG9uIGEgZnVuY3Rpb24gcmV0dXJucyB0aGUgZnVuY3Rpb24gZGVmaW5pdGlvbi4gVGhlIGRlZmluaXRpb24KICogY2FuIHRoZW4gYmUgcGFyc2VkIGFuZCB0aGUgZnVuY3Rpb24gYXJndW1lbnRzIGNhbiBiZSBleHRyYWN0ZWQuICpOT1RFOiogVGhpcyBkb2VzIG5vdCB3b3JrIHdpdGgKICogbWluaWZpY2F0aW9uLCBhbmQgb2JmdXNjYXRpb24gdG9vbHMgc2luY2UgdGhlc2UgdG9vbHMgY2hhbmdlIHRoZSBhcmd1bWVudCBuYW1lcy4KICoKICogIyMgYCRpbmplY3RgIEFubm90YXRpb24KICogQnkgYWRkaW5nIGFuIGAkaW5qZWN0YCBwcm9wZXJ0eSBvbnRvIGEgZnVuY3Rpb24gdGhlIGluamVjdGlvbiBwYXJhbWV0ZXJzIGNhbiBiZSBzcGVjaWZpZWQuCiAqCiAqICMjIElubGluZQogKiBBcyBhbiBhcnJheSBvZiBpbmplY3Rpb24gbmFtZXMsIHdoZXJlIHRoZSBsYXN0IGl0ZW0gaW4gdGhlIGFycmF5IGlzIHRoZSBmdW5jdGlvbiB0byBjYWxsLgogKi8KCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRpbmplY3RvciNnZXQKICoKICogQGRlc2NyaXB0aW9uCiAqIFJldHVybiBhbiBpbnN0YW5jZSBvZiB0aGUgc2VydmljZS4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRvIHJldHJpZXZlLgogKiBAcmV0dXJuIHsqfSBUaGUgaW5zdGFuY2UuCiAqLwoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJGluamVjdG9yI2ludm9rZQogKgogKiBAZGVzY3JpcHRpb24KICogSW52b2tlIHRoZSBtZXRob2QgYW5kIHN1cHBseSB0aGUgbWV0aG9kIGFyZ3VtZW50cyBmcm9tIHRoZSBgJGluamVjdG9yYC4KICoKICogQHBhcmFtIHshRnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byBpbnZva2UuIEZ1bmN0aW9uIHBhcmFtZXRlcnMgYXJlIGluamVjdGVkIGFjY29yZGluZyB0byB0aGUKICogICB7QGxpbmsgZ3VpZGUvZGkgJGluamVjdCBBbm5vdGF0aW9ufSBydWxlcy4KICogQHBhcmFtIHtPYmplY3Q9fSBzZWxmIFRoZSBgdGhpc2AgZm9yIHRoZSBpbnZva2VkIG1ldGhvZC4KICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzCiAqICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdCBmaXJzdCwgYmVmb3JlIHRoZSBgJGluamVjdG9yYCBpcyBjb25zdWx0ZWQuCiAqIEByZXR1cm5zIHsqfSB0aGUgdmFsdWUgcmV0dXJuZWQgYnkgdGhlIGludm9rZWQgYGZuYCBmdW5jdGlvbi4KICovCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkaW5qZWN0b3IjaGFzCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBbGxvd3MgdGhlIHVzZXIgdG8gcXVlcnkgaWYgdGhlIHBhcnRpY3VsYXIgc2VydmljZSBleGlzdHMuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIHNlcnZpY2UgdG8gcXVlcnkuCiAqIEByZXR1cm5zIHtib29sZWFufSBgdHJ1ZWAgaWYgaW5qZWN0b3IgaGFzIGdpdmVuIHNlcnZpY2UuCiAqLwoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJGluamVjdG9yI2luc3RhbnRpYXRlCiAqIEBkZXNjcmlwdGlvbgogKiBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgSlMgdHlwZS4gVGhlIG1ldGhvZCB0YWtlcyBhIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpbnZva2VzIHRoZSBuZXcKICogb3BlcmF0b3IsIGFuZCBzdXBwbGllcyBhbGwgb2YgdGhlIGFyZ3VtZW50cyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24gYXMgc3BlY2lmaWVkIGJ5IHRoZQogKiBjb25zdHJ1Y3RvciBhbm5vdGF0aW9uLgogKgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBUeXBlIEFubm90YXRlZCBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzCiAqIG9iamVjdCBmaXJzdCwgYmVmb3JlIHRoZSBgJGluamVjdG9yYCBpcyBjb25zdWx0ZWQuCiAqIEByZXR1cm5zIHtPYmplY3R9IG5ldyBpbnN0YW5jZSBvZiBgVHlwZWAuCiAqLwoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJGluamVjdG9yI2Fubm90YXRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBSZXR1cm5zIGFuIGFycmF5IG9mIHNlcnZpY2UgbmFtZXMgd2hpY2ggdGhlIGZ1bmN0aW9uIGlzIHJlcXVlc3RpbmcgZm9yIGluamVjdGlvbi4gVGhpcyBBUEkgaXMKICogdXNlZCBieSB0aGUgaW5qZWN0b3IgdG8gZGV0ZXJtaW5lIHdoaWNoIHNlcnZpY2VzIG5lZWQgdG8gYmUgaW5qZWN0ZWQgaW50byB0aGUgZnVuY3Rpb24gd2hlbiB0aGUKICogZnVuY3Rpb24gaXMgaW52b2tlZC4gVGhlcmUgYXJlIHRocmVlIHdheXMgaW4gd2hpY2ggdGhlIGZ1bmN0aW9uIGNhbiBiZSBhbm5vdGF0ZWQgd2l0aCB0aGUgbmVlZGVkCiAqIGRlcGVuZGVuY2llcy4KICoKICogIyBBcmd1bWVudCBuYW1lcwogKgogKiBUaGUgc2ltcGxlc3QgZm9ybSBpcyB0byBleHRyYWN0IHRoZSBkZXBlbmRlbmNpZXMgZnJvbSB0aGUgYXJndW1lbnRzIG9mIHRoZSBmdW5jdGlvbi4gVGhpcyBpcyBkb25lCiAqIGJ5IGNvbnZlcnRpbmcgdGhlIGZ1bmN0aW9uIGludG8gYSBzdHJpbmcgdXNpbmcgYHRvU3RyaW5nKClgIG1ldGhvZCBhbmQgZXh0cmFjdGluZyB0aGUgYXJndW1lbnQKICogbmFtZXMuCiAqIGBgYGpzCiAqICAgLy8gR2l2ZW4KICogICBmdW5jdGlvbiBNeUNvbnRyb2xsZXIoJHNjb3BlLCAkcm91dGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0KICoKICogICAvLyBUaGVuCiAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKE15Q29udHJvbGxlcikpLnRvRXF1YWwoWyckc2NvcGUnLCAnJHJvdXRlJ10pOwogKiBgYGAKICoKICogVGhpcyBtZXRob2QgZG9lcyBub3Qgd29yayB3aXRoIGNvZGUgbWluaWZpY2F0aW9uIC8gb2JmdXNjYXRpb24uIEZvciB0aGlzIHJlYXNvbiB0aGUgZm9sbG93aW5nCiAqIGFubm90YXRpb24gc3RyYXRlZ2llcyBhcmUgc3VwcG9ydGVkLgogKgogKiAjIFRoZSBgJGluamVjdGAgcHJvcGVydHkKICoKICogSWYgYSBmdW5jdGlvbiBoYXMgYW4gYCRpbmplY3RgIHByb3BlcnR5IGFuZCBpdHMgdmFsdWUgaXMgYW4gYXJyYXkgb2Ygc3RyaW5ncywgdGhlbiB0aGUgc3RyaW5ncwogKiByZXByZXNlbnQgbmFtZXMgb2Ygc2VydmljZXMgdG8gYmUgaW5qZWN0ZWQgaW50byB0aGUgZnVuY3Rpb24uCiAqIGBgYGpzCiAqICAgLy8gR2l2ZW4KICogICB2YXIgTXlDb250cm9sbGVyID0gZnVuY3Rpb24ob2JmdXNjYXRlZFNjb3BlLCBvYmZ1c2NhdGVkUm91dGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0KICogICAvLyBEZWZpbmUgZnVuY3Rpb24gZGVwZW5kZW5jaWVzCiAqICAgTXlDb250cm9sbGVyWyckaW5qZWN0J10gPSBbJyRzY29wZScsICckcm91dGUnXTsKICoKICogICAvLyBUaGVuCiAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKE15Q29udHJvbGxlcikpLnRvRXF1YWwoWyckc2NvcGUnLCAnJHJvdXRlJ10pOwogKiBgYGAKICoKICogIyBUaGUgYXJyYXkgbm90YXRpb24KICoKICogSXQgaXMgb2Z0ZW4gZGVzaXJhYmxlIHRvIGlubGluZSBJbmplY3RlZCBmdW5jdGlvbnMgYW5kIHRoYXQncyB3aGVuIHNldHRpbmcgdGhlIGAkaW5qZWN0YCBwcm9wZXJ0eQogKiBpcyB2ZXJ5IGluY29udmVuaWVudC4gSW4gdGhlc2Ugc2l0dWF0aW9ucyB1c2luZyB0aGUgYXJyYXkgbm90YXRpb24gdG8gc3BlY2lmeSB0aGUgZGVwZW5kZW5jaWVzIGluCiAqIGEgd2F5IHRoYXQgc3Vydml2ZXMgbWluaWZpY2F0aW9uIGlzIGEgYmV0dGVyIGNob2ljZToKICoKICogYGBganMKICogICAvLyBXZSB3aXNoIHRvIHdyaXRlIHRoaXMgKG5vdCBtaW5pZmljYXRpb24gLyBvYmZ1c2NhdGlvbiBzYWZlKQogKiAgIGluamVjdG9yLmludm9rZShmdW5jdGlvbigkY29tcGlsZSwgJHJvb3RTY29wZSkgewogKiAgICAgLy8gLi4uCiAqICAgfSk7CiAqCiAqICAgLy8gV2UgYXJlIGZvcmNlZCB0byB3cml0ZSBicmVhayBpbmxpbmluZwogKiAgIHZhciB0bXBGbiA9IGZ1bmN0aW9uKG9iZnVzY2F0ZWRDb21waWxlLCBvYmZ1c2NhdGVkUm9vdFNjb3BlKSB7CiAqICAgICAvLyAuLi4KICogICB9OwogKiAgIHRtcEZuLiRpbmplY3QgPSBbJyRjb21waWxlJywgJyRyb290U2NvcGUnXTsKICogICBpbmplY3Rvci5pbnZva2UodG1wRm4pOwogKgogKiAgIC8vIFRvIGJldHRlciBzdXBwb3J0IGlubGluZSBmdW5jdGlvbiB0aGUgaW5saW5lIGFubm90YXRpb24gaXMgc3VwcG9ydGVkCiAqICAgaW5qZWN0b3IuaW52b2tlKFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKG9iZkNvbXBpbGUsIG9iZlJvb3RTY29wZSkgewogKiAgICAgLy8gLi4uCiAqICAgfV0pOwogKgogKiAgIC8vIFRoZXJlZm9yZQogKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZSgKICogICAgICBbJyRjb21waWxlJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbihvYmZ1c18kY29tcGlsZSwgb2JmdXNfJHJvb3RTY29wZSkge31dKQogKiAgICApLnRvRXF1YWwoWyckY29tcGlsZScsICckcm9vdFNjb3BlJ10pOwogKiBgYGAKICoKICogQHBhcmFtIHtGdW5jdGlvbnxBcnJheS48c3RyaW5nfEZ1bmN0aW9uPn0gZm4gRnVuY3Rpb24gZm9yIHdoaWNoIGRlcGVuZGVudCBzZXJ2aWNlIG5hbWVzIG5lZWQgdG8KICogYmUgcmV0cmlldmVkIGFzIGRlc2NyaWJlZCBhYm92ZS4KICoKICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fSBUaGUgbmFtZXMgb2YgdGhlIHNlcnZpY2VzIHdoaWNoIHRoZSBmdW5jdGlvbiByZXF1aXJlcy4KICovCgoKCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHByb3ZpZGUKICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIFRoZSB7QGxpbmsgYXV0by4kcHJvdmlkZSAkcHJvdmlkZX0gc2VydmljZSBoYXMgYSBudW1iZXIgb2YgbWV0aG9kcyBmb3IgcmVnaXN0ZXJpbmcgY29tcG9uZW50cwogKiB3aXRoIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4gTWFueSBvZiB0aGVzZSBmdW5jdGlvbnMgYXJlIGFsc28gZXhwb3NlZCBvbgogKiB7QGxpbmsgYW5ndWxhci5Nb2R1bGV9LgogKgogKiBBbiBBbmd1bGFyICoqc2VydmljZSoqIGlzIGEgc2luZ2xldG9uIG9iamVjdCBjcmVhdGVkIGJ5IGEgKipzZXJ2aWNlIGZhY3RvcnkqKi4gIFRoZXNlICoqc2VydmljZQogKiBmYWN0b3JpZXMqKiBhcmUgZnVuY3Rpb25zIHdoaWNoLCBpbiB0dXJuLCBhcmUgY3JlYXRlZCBieSBhICoqc2VydmljZSBwcm92aWRlcioqLgogKiBUaGUgKipzZXJ2aWNlIHByb3ZpZGVycyoqIGFyZSBjb25zdHJ1Y3RvciBmdW5jdGlvbnMuIFdoZW4gaW5zdGFudGlhdGVkIHRoZXkgbXVzdCBjb250YWluIGEKICogcHJvcGVydHkgY2FsbGVkIGAkZ2V0YCwgd2hpY2ggaG9sZHMgdGhlICoqc2VydmljZSBmYWN0b3J5KiogZnVuY3Rpb24uCiAqCiAqIFdoZW4geW91IHJlcXVlc3QgYSBzZXJ2aWNlLCB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0gaXMgcmVzcG9uc2libGUgZm9yIGZpbmRpbmcgdGhlCiAqIGNvcnJlY3QgKipzZXJ2aWNlIHByb3ZpZGVyKiosIGluc3RhbnRpYXRpbmcgaXQgYW5kIHRoZW4gY2FsbGluZyBpdHMgYCRnZXRgICoqc2VydmljZSBmYWN0b3J5KioKICogZnVuY3Rpb24gdG8gZ2V0IHRoZSBpbnN0YW5jZSBvZiB0aGUgKipzZXJ2aWNlKiouCiAqCiAqIE9mdGVuIHNlcnZpY2VzIGhhdmUgbm8gY29uZmlndXJhdGlvbiBvcHRpb25zIGFuZCB0aGVyZSBpcyBubyBuZWVkIHRvIGFkZCBtZXRob2RzIHRvIHRoZSBzZXJ2aWNlCiAqIHByb3ZpZGVyLiAgVGhlIHByb3ZpZGVyIHdpbGwgYmUgbm8gbW9yZSB0aGFuIGEgY29uc3RydWN0b3IgZnVuY3Rpb24gd2l0aCBhIGAkZ2V0YCBwcm9wZXJ0eS4gRm9yCiAqIHRoZXNlIGNhc2VzIHRoZSB7QGxpbmsgYXV0by4kcHJvdmlkZSAkcHJvdmlkZX0gc2VydmljZSBoYXMgYWRkaXRpb25hbCBoZWxwZXIgbWV0aG9kcyB0byByZWdpc3RlcgogKiBzZXJ2aWNlcyB3aXRob3V0IHNwZWNpZnlpbmcgYSBwcm92aWRlci4KICoKICogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNwcm92aWRlciBwcm92aWRlcihwcm92aWRlcil9IC0gcmVnaXN0ZXJzIGEgKipzZXJ2aWNlIHByb3ZpZGVyKiogd2l0aCB0aGUKICogICAgIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9CiAqICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjY29uc3RhbnQgY29uc3RhbnQob2JqKX0gLSByZWdpc3RlcnMgYSB2YWx1ZS9vYmplY3QgdGhhdCBjYW4gYmUgYWNjZXNzZWQgYnkKICogICAgIHByb3ZpZGVycyBhbmQgc2VydmljZXMuCiAqICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjdmFsdWUgdmFsdWUob2JqKX0gLSByZWdpc3RlcnMgYSB2YWx1ZS9vYmplY3QgdGhhdCBjYW4gb25seSBiZSBhY2Nlc3NlZCBieQogKiAgICAgc2VydmljZXMsIG5vdCBwcm92aWRlcnMuCiAqICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjZmFjdG9yeSBmYWN0b3J5KGZuKX0gLSByZWdpc3RlcnMgYSBzZXJ2aWNlICoqZmFjdG9yeSBmdW5jdGlvbioqLCBgZm5gLAogKiAgICAgdGhhdCB3aWxsIGJlIHdyYXBwZWQgaW4gYSAqKnNlcnZpY2UgcHJvdmlkZXIqKiBvYmplY3QsIHdob3NlIGAkZ2V0YCBwcm9wZXJ0eSB3aWxsIGNvbnRhaW4gdGhlCiAqICAgICBnaXZlbiBmYWN0b3J5IGZ1bmN0aW9uLgogKiAqIHtAbGluayBhdXRvLiRwcm92aWRlI3NlcnZpY2Ugc2VydmljZShjbGFzcyl9IC0gcmVnaXN0ZXJzIGEgKipjb25zdHJ1Y3RvciBmdW5jdGlvbioqLCBgY2xhc3NgCiAqICAgICB0aGF0IHdpbGwgYmUgd3JhcHBlZCBpbiBhICoqc2VydmljZSBwcm92aWRlcioqIG9iamVjdCwgd2hvc2UgYCRnZXRgIHByb3BlcnR5IHdpbGwgaW5zdGFudGlhdGUKICogICAgICBhIG5ldyBvYmplY3QgdXNpbmcgdGhlIGdpdmVuIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogKgogKiBTZWUgdGhlIGluZGl2aWR1YWwgbWV0aG9kcyBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhbmQgZXhhbXBsZXMuCiAqLwoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJHByb3ZpZGUjcHJvdmlkZXIKICogQGRlc2NyaXB0aW9uCiAqCiAqIFJlZ2lzdGVyIGEgKipwcm92aWRlciBmdW5jdGlvbioqIHdpdGggdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LiBQcm92aWRlciBmdW5jdGlvbnMKICogYXJlIGNvbnN0cnVjdG9yIGZ1bmN0aW9ucywgd2hvc2UgaW5zdGFuY2VzIGFyZSByZXNwb25zaWJsZSBmb3IgInByb3ZpZGluZyIgYSBmYWN0b3J5IGZvciBhCiAqIHNlcnZpY2UuCiAqCiAqIFNlcnZpY2UgcHJvdmlkZXIgbmFtZXMgc3RhcnQgd2l0aCB0aGUgbmFtZSBvZiB0aGUgc2VydmljZSB0aGV5IHByb3ZpZGUgZm9sbG93ZWQgYnkgYFByb3ZpZGVyYC4KICogRm9yIGV4YW1wbGUsIHRoZSB7QGxpbmsgbmcuJGxvZyAkbG9nfSBzZXJ2aWNlIGhhcyBhIHByb3ZpZGVyIGNhbGxlZAogKiB7QGxpbmsgbmcuJGxvZ1Byb3ZpZGVyICRsb2dQcm92aWRlcn0uCiAqCiAqIFNlcnZpY2UgcHJvdmlkZXIgb2JqZWN0cyBjYW4gaGF2ZSBhZGRpdGlvbmFsIG1ldGhvZHMgd2hpY2ggYWxsb3cgY29uZmlndXJhdGlvbiBvZiB0aGUgcHJvdmlkZXIKICogYW5kIGl0cyBzZXJ2aWNlLiBJbXBvcnRhbnRseSwgeW91IGNhbiBjb25maWd1cmUgd2hhdCBraW5kIG9mIHNlcnZpY2UgaXMgY3JlYXRlZCBieSB0aGUgYCRnZXRgCiAqIG1ldGhvZCwgb3IgaG93IHRoYXQgc2VydmljZSB3aWxsIGFjdC4gRm9yIGV4YW1wbGUsIHRoZSB7QGxpbmsgbmcuJGxvZ1Byb3ZpZGVyICRsb2dQcm92aWRlcn0gaGFzIGEKICogbWV0aG9kIHtAbGluayBuZy4kbG9nUHJvdmlkZXIjZGVidWdFbmFibGVkIGRlYnVnRW5hYmxlZH0KICogd2hpY2ggbGV0cyB5b3Ugc3BlY2lmeSB3aGV0aGVyIHRoZSB7QGxpbmsgbmcuJGxvZyAkbG9nfSBzZXJ2aWNlIHdpbGwgbG9nIGRlYnVnIG1lc3NhZ2VzIHRvIHRoZQogKiBjb25zb2xlIG9yIG5vdC4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLiBOT1RFOiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBhdmFpbGFibGUgdW5kZXIgYG5hbWUgKwogICAgICAgICAgICAgICAgICAgICAgICAnUHJvdmlkZXInYCBrZXkuCiAqIEBwYXJhbSB7KE9iamVjdHxmdW5jdGlvbigpKX0gcHJvdmlkZXIgSWYgdGhlIHByb3ZpZGVyIGlzOgogKgogKiAgIC0gYE9iamVjdGA6IHRoZW4gaXQgc2hvdWxkIGhhdmUgYSBgJGdldGAgbWV0aG9kLiBUaGUgYCRnZXRgIG1ldGhvZCB3aWxsIGJlIGludm9rZWQgdXNpbmcKICogICAgIHtAbGluayBhdXRvLiRpbmplY3RvciNpbnZva2UgJGluamVjdG9yLmludm9rZSgpfSB3aGVuIGFuIGluc3RhbmNlIG5lZWRzIHRvIGJlIGNyZWF0ZWQuCiAqICAgLSBgQ29uc3RydWN0b3JgOiBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBjcmVhdGVkIHVzaW5nCiAqICAgICB7QGxpbmsgYXV0by4kaW5qZWN0b3IjaW5zdGFudGlhdGUgJGluamVjdG9yLmluc3RhbnRpYXRlKCl9LCB0aGVuIHRyZWF0ZWQgYXMgYG9iamVjdGAuCiAqCiAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKCiAqIEBleGFtcGxlCiAqCiAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzaG93cyBob3cgdG8gY3JlYXRlIGEgc2ltcGxlIGV2ZW50IHRyYWNraW5nIHNlcnZpY2UgYW5kIHJlZ2lzdGVyIGl0IHVzaW5nCiAqIHtAbGluayBhdXRvLiRwcm92aWRlI3Byb3ZpZGVyICRwcm92aWRlLnByb3ZpZGVyKCl9LgogKgogKiBgYGBqcwogKiAgLy8gRGVmaW5lIHRoZSBldmVudFRyYWNrZXIgcHJvdmlkZXIKICogIGZ1bmN0aW9uIEV2ZW50VHJhY2tlclByb3ZpZGVyKCkgewogKiAgICB2YXIgdHJhY2tpbmdVcmwgPSAnL3RyYWNrJzsKICoKICogICAgLy8gQSBwcm92aWRlciBtZXRob2QgZm9yIGNvbmZpZ3VyaW5nIHdoZXJlIHRoZSB0cmFja2VkIGV2ZW50cyBzaG91bGQgYmVlbiBzYXZlZAogKiAgICB0aGlzLnNldFRyYWNraW5nVXJsID0gZnVuY3Rpb24odXJsKSB7CiAqICAgICAgdHJhY2tpbmdVcmwgPSB1cmw7CiAqICAgIH07CiAqCiAqICAgIC8vIFRoZSBzZXJ2aWNlIGZhY3RvcnkgZnVuY3Rpb24KICogICAgdGhpcy4kZ2V0ID0gWyckaHR0cCcsIGZ1bmN0aW9uKCRodHRwKSB7CiAqICAgICAgdmFyIHRyYWNrZWRFdmVudHMgPSB7fTsKICogICAgICByZXR1cm4gewogKiAgICAgICAgLy8gQ2FsbCB0aGlzIHRvIHRyYWNrIGFuIGV2ZW50CiAqICAgICAgICBldmVudDogZnVuY3Rpb24oZXZlbnQpIHsKICogICAgICAgICAgdmFyIGNvdW50ID0gdHJhY2tlZEV2ZW50c1tldmVudF0gfHwgMDsKICogICAgICAgICAgY291bnQgKz0gMTsKICogICAgICAgICAgdHJhY2tlZEV2ZW50c1tldmVudF0gPSBjb3VudDsKICogICAgICAgICAgcmV0dXJuIGNvdW50OwogKiAgICAgICAgfSwKICogICAgICAgIC8vIENhbGwgdGhpcyB0byBzYXZlIHRoZSB0cmFja2VkIGV2ZW50cyB0byB0aGUgdHJhY2tpbmdVcmwKICogICAgICAgIHNhdmU6IGZ1bmN0aW9uKCkgewogKiAgICAgICAgICAkaHR0cC5wb3N0KHRyYWNraW5nVXJsLCB0cmFja2VkRXZlbnRzKTsKICogICAgICAgIH0KICogICAgICB9OwogKiAgICB9XTsKICogIH0KICoKICogIGRlc2NyaWJlKCdldmVudFRyYWNrZXInLCBmdW5jdGlvbigpIHsKICogICAgdmFyIHBvc3RTcHk7CiAqCiAqICAgIGJlZm9yZUVhY2gobW9kdWxlKGZ1bmN0aW9uKCRwcm92aWRlKSB7CiAqICAgICAgLy8gUmVnaXN0ZXIgdGhlIGV2ZW50VHJhY2tlciBwcm92aWRlcgogKiAgICAgICRwcm92aWRlLnByb3ZpZGVyKCdldmVudFRyYWNrZXInLCBFdmVudFRyYWNrZXJQcm92aWRlcik7CiAqICAgIH0pKTsKICoKICogICAgYmVmb3JlRWFjaChtb2R1bGUoZnVuY3Rpb24oZXZlbnRUcmFja2VyUHJvdmlkZXIpIHsKICogICAgICAvLyBDb25maWd1cmUgZXZlbnRUcmFja2VyIHByb3ZpZGVyCiAqICAgICAgZXZlbnRUcmFja2VyUHJvdmlkZXIuc2V0VHJhY2tpbmdVcmwoJy9jdXN0b20tdHJhY2snKTsKICogICAgfSkpOwogKgogKiAgICBpdCgndHJhY2tzIGV2ZW50cycsIGluamVjdChmdW5jdGlvbihldmVudFRyYWNrZXIpIHsKICogICAgICBleHBlY3QoZXZlbnRUcmFja2VyLmV2ZW50KCdsb2dpbicpKS50b0VxdWFsKDEpOwogKiAgICAgIGV4cGVjdChldmVudFRyYWNrZXIuZXZlbnQoJ2xvZ2luJykpLnRvRXF1YWwoMik7CiAqICAgIH0pKTsKICoKICogICAgaXQoJ3NhdmVzIHRvIHRoZSB0cmFja2luZyB1cmwnLCBpbmplY3QoZnVuY3Rpb24oZXZlbnRUcmFja2VyLCAkaHR0cCkgewogKiAgICAgIHBvc3RTcHkgPSBzcHlPbigkaHR0cCwgJ3Bvc3QnKTsKICogICAgICBldmVudFRyYWNrZXIuZXZlbnQoJ2xvZ2luJyk7CiAqICAgICAgZXZlbnRUcmFja2VyLnNhdmUoKTsKICogICAgICBleHBlY3QocG9zdFNweSkudG9IYXZlQmVlbkNhbGxlZCgpOwogKiAgICAgIGV4cGVjdChwb3N0U3B5Lm1vc3RSZWNlbnRDYWxsLmFyZ3NbMF0pLm5vdC50b0VxdWFsKCcvdHJhY2snKTsKICogICAgICBleHBlY3QocG9zdFNweS5tb3N0UmVjZW50Q2FsbC5hcmdzWzBdKS50b0VxdWFsKCcvY3VzdG9tLXRyYWNrJyk7CiAqICAgICAgZXhwZWN0KHBvc3RTcHkubW9zdFJlY2VudENhbGwuYXJnc1sxXSkudG9FcXVhbCh7ICdsb2dpbic6IDEgfSk7CiAqICAgIH0pKTsKICogIH0pOwogKiBgYGAKICovCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkcHJvdmlkZSNmYWN0b3J5CiAqIEBkZXNjcmlwdGlvbgogKgogKiBSZWdpc3RlciBhICoqc2VydmljZSBmYWN0b3J5KiosIHdoaWNoIHdpbGwgYmUgY2FsbGVkIHRvIHJldHVybiB0aGUgc2VydmljZSBpbnN0YW5jZS4KICogVGhpcyBpcyBzaG9ydCBmb3IgcmVnaXN0ZXJpbmcgYSBzZXJ2aWNlIHdoZXJlIGl0cyBwcm92aWRlciBjb25zaXN0cyBvZiBvbmx5IGEgYCRnZXRgIHByb3BlcnR5LAogKiB3aGljaCBpcyB0aGUgZ2l2ZW4gc2VydmljZSBmYWN0b3J5IGZ1bmN0aW9uLgogKiBZb3Ugc2hvdWxkIHVzZSB7QGxpbmsgYXV0by4kcHJvdmlkZSNmYWN0b3J5ICRwcm92aWRlLmZhY3RvcnkoZ2V0Rm4pfSBpZiB5b3UgZG8gbm90IG5lZWQgdG8KICogY29uZmlndXJlIHlvdXIgc2VydmljZSBpbiBhIHByb3ZpZGVyLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuCiAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gJGdldEZuIFRoZSAkZ2V0Rm4gZm9yIHRoZSBpbnN0YW5jZSBjcmVhdGlvbi4gSW50ZXJuYWxseSB0aGlzIGlzIGEgc2hvcnQgaGFuZAogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgYCRwcm92aWRlLnByb3ZpZGVyKG5hbWUsIHskZ2V0OiAkZ2V0Rm59KWAuCiAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICoKICogQGV4YW1wbGUKICogSGVyZSBpcyBhbiBleGFtcGxlIG9mIHJlZ2lzdGVyaW5nIGEgc2VydmljZQogKiBgYGBqcwogKiAgICRwcm92aWRlLmZhY3RvcnkoJ3BpbmcnLCBbJyRodHRwJywgZnVuY3Rpb24oJGh0dHApIHsKICogICAgIHJldHVybiBmdW5jdGlvbiBwaW5nKCkgewogKiAgICAgICByZXR1cm4gJGh0dHAuc2VuZCgnL3BpbmcnKTsKICogICAgIH07CiAqICAgfV0pOwogKiBgYGAKICogWW91IHdvdWxkIHRoZW4gaW5qZWN0IGFuZCB1c2UgdGhpcyBzZXJ2aWNlIGxpa2UgdGhpczoKICogYGBganMKICogICBzb21lTW9kdWxlLmNvbnRyb2xsZXIoJ0N0cmwnLCBbJ3BpbmcnLCBmdW5jdGlvbihwaW5nKSB7CiAqICAgICBwaW5nKCk7CiAqICAgfV0pOwogKiBgYGAKICovCgoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJHByb3ZpZGUjc2VydmljZQogKiBAZGVzY3JpcHRpb24KICoKICogUmVnaXN0ZXIgYSAqKnNlcnZpY2UgY29uc3RydWN0b3IqKiwgd2hpY2ggd2lsbCBiZSBpbnZva2VkIHdpdGggYG5ld2AgdG8gY3JlYXRlIHRoZSBzZXJ2aWNlCiAqIGluc3RhbmNlLgogKiBUaGlzIGlzIHNob3J0IGZvciByZWdpc3RlcmluZyBhIHNlcnZpY2Ugd2hlcmUgaXRzIHByb3ZpZGVyJ3MgYCRnZXRgIHByb3BlcnR5IGlzIHRoZSBzZXJ2aWNlCiAqIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGluc3RhbnRpYXRlIHRoZSBzZXJ2aWNlIGluc3RhbmNlLgogKgogKiBZb3Ugc2hvdWxkIHVzZSB7QGxpbmsgYXV0by4kcHJvdmlkZSNzZXJ2aWNlICRwcm92aWRlLnNlcnZpY2UoY2xhc3MpfSBpZiB5b3UgZGVmaW5lIHlvdXIgc2VydmljZQogKiBhcyBhIHR5cGUvY2xhc3MuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQSBjbGFzcyAoY29uc3RydWN0b3IgZnVuY3Rpb24pIHRoYXQgd2lsbCBiZSBpbnN0YW50aWF0ZWQuCiAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICoKICogQGV4YW1wbGUKICogSGVyZSBpcyBhbiBleGFtcGxlIG9mIHJlZ2lzdGVyaW5nIGEgc2VydmljZSB1c2luZwogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNzZXJ2aWNlICRwcm92aWRlLnNlcnZpY2UoY2xhc3MpfS4KICogYGBganMKICogICB2YXIgUGluZyA9IGZ1bmN0aW9uKCRodHRwKSB7CiAqICAgICB0aGlzLiRodHRwID0gJGh0dHA7CiAqICAgfTsKICoKICogICBQaW5nLiRpbmplY3QgPSBbJyRodHRwJ107CiAqCiAqICAgUGluZy5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKCkgewogKiAgICAgcmV0dXJuIHRoaXMuJGh0dHAuZ2V0KCcvcGluZycpOwogKiAgIH07CiAqICAgJHByb3ZpZGUuc2VydmljZSgncGluZycsIFBpbmcpOwogKiBgYGAKICogWW91IHdvdWxkIHRoZW4gaW5qZWN0IGFuZCB1c2UgdGhpcyBzZXJ2aWNlIGxpa2UgdGhpczoKICogYGBganMKICogICBzb21lTW9kdWxlLmNvbnRyb2xsZXIoJ0N0cmwnLCBbJ3BpbmcnLCBmdW5jdGlvbihwaW5nKSB7CiAqICAgICBwaW5nLnNlbmQoKTsKICogICB9XSk7CiAqIGBgYAogKi8KCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkcHJvdmlkZSN2YWx1ZQogKiBAZGVzY3JpcHRpb24KICoKICogUmVnaXN0ZXIgYSAqKnZhbHVlIHNlcnZpY2UqKiB3aXRoIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfSwgc3VjaCBhcyBhIHN0cmluZywgYQogKiBudW1iZXIsIGFuIGFycmF5LCBhbiBvYmplY3Qgb3IgYSBmdW5jdGlvbi4gIFRoaXMgaXMgc2hvcnQgZm9yIHJlZ2lzdGVyaW5nIGEgc2VydmljZSB3aGVyZSBpdHMKICogcHJvdmlkZXIncyBgJGdldGAgcHJvcGVydHkgaXMgYSBmYWN0b3J5IGZ1bmN0aW9uIHRoYXQgdGFrZXMgbm8gYXJndW1lbnRzIGFuZCByZXR1cm5zIHRoZSAqKnZhbHVlCiAqIHNlcnZpY2UqKi4KICoKICogVmFsdWUgc2VydmljZXMgYXJlIHNpbWlsYXIgdG8gY29uc3RhbnQgc2VydmljZXMsIGV4Y2VwdCB0aGF0IHRoZXkgY2Fubm90IGJlIGluamVjdGVkIGludG8gYQogKiBtb2R1bGUgY29uZmlndXJhdGlvbiBmdW5jdGlvbiAoc2VlIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb25maWd9KSBidXQgdGhleSBjYW4gYmUgb3ZlcnJpZGRlbiBieQogKiBhbiBBbmd1bGFyCiAqIHtAbGluayBhdXRvLiRwcm92aWRlI2RlY29yYXRvciBkZWNvcmF0b3J9LgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuCiAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlLgogKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAqCiAqIEBleGFtcGxlCiAqIEhlcmUgYXJlIHNvbWUgZXhhbXBsZXMgb2YgY3JlYXRpbmcgdmFsdWUgc2VydmljZXMuCiAqIGBgYGpzCiAqICAgJHByb3ZpZGUudmFsdWUoJ0FETUlOX1VTRVInLCAnYWRtaW4nKTsKICoKICogICAkcHJvdmlkZS52YWx1ZSgnUm9sZUxvb2t1cCcsIHsgYWRtaW46IDAsIHdyaXRlcjogMSwgcmVhZGVyOiAyIH0pOwogKgogKiAgICRwcm92aWRlLnZhbHVlKCdoYWxmT2YnLCBmdW5jdGlvbih2YWx1ZSkgewogKiAgICAgcmV0dXJuIHZhbHVlIC8gMjsKICogICB9KTsKICogYGBgCiAqLwoKCi8qKgogKiBAbmdkb2MgbWV0aG9kCiAqIEBuYW1lICRwcm92aWRlI2NvbnN0YW50CiAqIEBkZXNjcmlwdGlvbgogKgogKiBSZWdpc3RlciBhICoqY29uc3RhbnQgc2VydmljZSoqLCBzdWNoIGFzIGEgc3RyaW5nLCBhIG51bWJlciwgYW4gYXJyYXksIGFuIG9iamVjdCBvciBhIGZ1bmN0aW9uLAogKiB3aXRoIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4gVW5saWtlIHtAbGluayBhdXRvLiRwcm92aWRlI3ZhbHVlIHZhbHVlfSBpdCBjYW4gYmUKICogaW5qZWN0ZWQgaW50byBhIG1vZHVsZSBjb25maWd1cmF0aW9uIGZ1bmN0aW9uIChzZWUge0BsaW5rIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZ30pIGFuZCBpdCBjYW5ub3QKICogYmUgb3ZlcnJpZGRlbiBieSBhbiBBbmd1bGFyIHtAbGluayBhdXRvLiRwcm92aWRlI2RlY29yYXRvciBkZWNvcmF0b3J9LgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgY29uc3RhbnQuCiAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIGNvbnN0YW50IHZhbHVlLgogKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIGluc3RhbmNlCiAqCiAqIEBleGFtcGxlCiAqIEhlcmUgYSBzb21lIGV4YW1wbGVzIG9mIGNyZWF0aW5nIGNvbnN0YW50czoKICogYGBganMKICogICAkcHJvdmlkZS5jb25zdGFudCgnU0hBUkRfSEVJR0hUJywgMzA2KTsKICoKICogICAkcHJvdmlkZS5jb25zdGFudCgnTVlfQ09MT1VSUycsIFsncmVkJywgJ2JsdWUnLCAnZ3JleSddKTsKICoKICogICAkcHJvdmlkZS5jb25zdGFudCgnZG91YmxlJywgZnVuY3Rpb24odmFsdWUpIHsKICogICAgIHJldHVybiB2YWx1ZSAqIDI7CiAqICAgfSk7CiAqIGBgYAogKi8KCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkcHJvdmlkZSNkZWNvcmF0b3IKICogQGRlc2NyaXB0aW9uCiAqCiAqIFJlZ2lzdGVyIGEgKipzZXJ2aWNlIGRlY29yYXRvcioqIHdpdGggdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LiBBIHNlcnZpY2UgZGVjb3JhdG9yCiAqIGludGVyY2VwdHMgdGhlIGNyZWF0aW9uIG9mIGEgc2VydmljZSwgYWxsb3dpbmcgaXQgdG8gb3ZlcnJpZGUgb3IgbW9kaWZ5IHRoZSBiZWhhdmlvdXIgb2YgdGhlCiAqIHNlcnZpY2UuIFRoZSBvYmplY3QgcmV0dXJuZWQgYnkgdGhlIGRlY29yYXRvciBtYXkgYmUgdGhlIG9yaWdpbmFsIHNlcnZpY2UsIG9yIGEgbmV3IHNlcnZpY2UKICogb2JqZWN0IHdoaWNoIHJlcGxhY2VzIG9yIHdyYXBzIGFuZCBkZWxlZ2F0ZXMgdG8gdGhlIG9yaWdpbmFsIHNlcnZpY2UuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBzZXJ2aWNlIHRvIGRlY29yYXRlLgogKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGRlY29yYXRvciBUaGlzIGZ1bmN0aW9uIHdpbGwgYmUgaW52b2tlZCB3aGVuIHRoZSBzZXJ2aWNlIG5lZWRzIHRvIGJlCiAqICAgIGluc3RhbnRpYXRlZCBhbmQgc2hvdWxkIHJldHVybiB0aGUgZGVjb3JhdGVkIHNlcnZpY2UgaW5zdGFuY2UuIFRoZSBmdW5jdGlvbiBpcyBjYWxsZWQgdXNpbmcKICogICAgdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciNpbnZva2UgaW5qZWN0b3IuaW52b2tlfSBtZXRob2QgYW5kIGlzIHRoZXJlZm9yZSBmdWxseSBpbmplY3RhYmxlLgogKiAgICBMb2NhbCBpbmplY3Rpb24gYXJndW1lbnRzOgogKgogKiAgICAqIGAkZGVsZWdhdGVgIC0gVGhlIG9yaWdpbmFsIHNlcnZpY2UgaW5zdGFuY2UsIHdoaWNoIGNhbiBiZSBtb25rZXkgcGF0Y2hlZCwgY29uZmlndXJlZCwKICogICAgICBkZWNvcmF0ZWQgb3IgZGVsZWdhdGVkIHRvLgogKgogKiBAZXhhbXBsZQogKiBIZXJlIHdlIGRlY29yYXRlIHRoZSB7QGxpbmsgbmcuJGxvZyAkbG9nfSBzZXJ2aWNlIHRvIGNvbnZlcnQgd2FybmluZ3MgdG8gZXJyb3JzIGJ5IGludGVyY2VwdGluZwogKiBjYWxscyB0byB7QGxpbmsgbmcuJGxvZyNlcnJvciAkbG9nLndhcm4oKX0uCiAqIGBgYGpzCiAqICAgJHByb3ZpZGUuZGVjb3JhdG9yKCckbG9nJywgWyckZGVsZWdhdGUnLCBmdW5jdGlvbigkZGVsZWdhdGUpIHsKICogICAgICRkZWxlZ2F0ZS53YXJuID0gJGRlbGVnYXRlLmVycm9yOwogKiAgICAgcmV0dXJuICRkZWxlZ2F0ZTsKICogICB9XSk7CiAqIGBgYAogKi8KCgpmdW5jdGlvbiBjcmVhdGVJbmplY3Rvcihtb2R1bGVzVG9Mb2FkLCBzdHJpY3REaSkgewogIHN0cmljdERpID0gKHN0cmljdERpID09PSB0cnVlKTsKICB2YXIgSU5TVEFOVElBVElORyA9IHt9LAogICAgICBwcm92aWRlclN1ZmZpeCA9ICdQcm92aWRlcicsCiAgICAgIHBhdGggPSBbXSwKICAgICAgbG9hZGVkTW9kdWxlcyA9IG5ldyBIYXNoTWFwKFtdLCB0cnVlKSwKICAgICAgcHJvdmlkZXJDYWNoZSA9IHsKICAgICAgICAkcHJvdmlkZTogewogICAgICAgICAgICBwcm92aWRlcjogc3VwcG9ydE9iamVjdChwcm92aWRlciksCiAgICAgICAgICAgIGZhY3Rvcnk6IHN1cHBvcnRPYmplY3QoZmFjdG9yeSksCiAgICAgICAgICAgIHNlcnZpY2U6IHN1cHBvcnRPYmplY3Qoc2VydmljZSksCiAgICAgICAgICAgIHZhbHVlOiBzdXBwb3J0T2JqZWN0KHZhbHVlKSwKICAgICAgICAgICAgY29uc3RhbnQ6IHN1cHBvcnRPYmplY3QoY29uc3RhbnQpLAogICAgICAgICAgICBkZWNvcmF0b3I6IGRlY29yYXRvcgogICAgICAgICAgfQogICAgICB9LAogICAgICBwcm92aWRlckluamVjdG9yID0gKHByb3ZpZGVyQ2FjaGUuJGluamVjdG9yID0KICAgICAgICAgIGNyZWF0ZUludGVybmFsSW5qZWN0b3IocHJvdmlkZXJDYWNoZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycigndW5wcicsICJVbmtub3duIHByb3ZpZGVyOiB7MH0iLCBwYXRoLmpvaW4oJyA8LSAnKSk7CiAgICAgICAgICB9KSksCiAgICAgIGluc3RhbmNlQ2FjaGUgPSB7fSwKICAgICAgaW5zdGFuY2VJbmplY3RvciA9IChpbnN0YW5jZUNhY2hlLiRpbmplY3RvciA9CiAgICAgICAgICBjcmVhdGVJbnRlcm5hbEluamVjdG9yKGluc3RhbmNlQ2FjaGUsIGZ1bmN0aW9uKHNlcnZpY2VuYW1lKSB7CiAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHByb3ZpZGVySW5qZWN0b3IuZ2V0KHNlcnZpY2VuYW1lICsgcHJvdmlkZXJTdWZmaXgpOwogICAgICAgICAgICByZXR1cm4gaW5zdGFuY2VJbmplY3Rvci5pbnZva2UocHJvdmlkZXIuJGdldCwgcHJvdmlkZXIsIHVuZGVmaW5lZCwgc2VydmljZW5hbWUpOwogICAgICAgICAgfSkpOwoKCiAgZm9yRWFjaChsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKSwgZnVuY3Rpb24oZm4pIHsgaW5zdGFuY2VJbmplY3Rvci5pbnZva2UoZm4gfHwgbm9vcCk7IH0pOwoKICByZXR1cm4gaW5zdGFuY2VJbmplY3RvcjsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgLy8gJHByb3ZpZGVyCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogIGZ1bmN0aW9uIHN1cHBvcnRPYmplY3QoZGVsZWdhdGUpIHsKICAgIHJldHVybiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIGlmIChpc09iamVjdChrZXkpKSB7CiAgICAgICAgZm9yRWFjaChrZXksIHJldmVyc2VQYXJhbXMoZGVsZWdhdGUpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZGVsZWdhdGUoa2V5LCB2YWx1ZSk7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBwcm92aWRlcihuYW1lLCBwcm92aWRlcl8pIHsKICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KG5hbWUsICdzZXJ2aWNlJyk7CiAgICBpZiAoaXNGdW5jdGlvbihwcm92aWRlcl8pIHx8IGlzQXJyYXkocHJvdmlkZXJfKSkgewogICAgICBwcm92aWRlcl8gPSBwcm92aWRlckluamVjdG9yLmluc3RhbnRpYXRlKHByb3ZpZGVyXyk7CiAgICB9CiAgICBpZiAoIXByb3ZpZGVyXy4kZ2V0KSB7CiAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycigncGdldCcsICJQcm92aWRlciAnezB9JyBtdXN0IGRlZmluZSAkZ2V0IGZhY3RvcnkgbWV0aG9kLiIsIG5hbWUpOwogICAgfQogICAgcmV0dXJuIHByb3ZpZGVyQ2FjaGVbbmFtZSArIHByb3ZpZGVyU3VmZml4XSA9IHByb3ZpZGVyXzsKICB9CgogIGZ1bmN0aW9uIGVuZm9yY2VSZXR1cm5WYWx1ZShuYW1lLCBmYWN0b3J5KSB7CiAgICByZXR1cm4gZnVuY3Rpb24gZW5mb3JjZWRSZXR1cm5WYWx1ZSgpIHsKICAgICAgdmFyIHJlc3VsdCA9IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGZhY3RvcnksIHRoaXMsIHVuZGVmaW5lZCwgbmFtZSk7CiAgICAgIGlmIChpc1VuZGVmaW5lZChyZXN1bHQpKSB7CiAgICAgICAgdGhyb3cgJGluamVjdG9yTWluRXJyKCd1bmRlZicsICJQcm92aWRlciAnezB9JyBtdXN0IHJldHVybiBhIHZhbHVlIGZyb20gJGdldCBmYWN0b3J5IG1ldGhvZC4iLCBuYW1lKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGZhY3RvcnkobmFtZSwgZmFjdG9yeUZuLCBlbmZvcmNlKSB7CiAgICByZXR1cm4gcHJvdmlkZXIobmFtZSwgewogICAgICAkZ2V0OiBlbmZvcmNlICE9PSBmYWxzZSA/IGVuZm9yY2VSZXR1cm5WYWx1ZShuYW1lLCBmYWN0b3J5Rm4pIDogZmFjdG9yeUZuCiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHNlcnZpY2UobmFtZSwgY29uc3RydWN0b3IpIHsKICAgIHJldHVybiBmYWN0b3J5KG5hbWUsIFsnJGluamVjdG9yJywgZnVuY3Rpb24oJGluamVjdG9yKSB7CiAgICAgIHJldHVybiAkaW5qZWN0b3IuaW5zdGFudGlhdGUoY29uc3RydWN0b3IpOwogICAgfV0pOwogIH0KCiAgZnVuY3Rpb24gdmFsdWUobmFtZSwgdmFsKSB7IHJldHVybiBmYWN0b3J5KG5hbWUsIHZhbHVlRm4odmFsKSwgZmFsc2UpOyB9CgogIGZ1bmN0aW9uIGNvbnN0YW50KG5hbWUsIHZhbHVlKSB7CiAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCAnY29uc3RhbnQnKTsKICAgIHByb3ZpZGVyQ2FjaGVbbmFtZV0gPSB2YWx1ZTsKICAgIGluc3RhbmNlQ2FjaGVbbmFtZV0gPSB2YWx1ZTsKICB9CgogIGZ1bmN0aW9uIGRlY29yYXRvcihzZXJ2aWNlTmFtZSwgZGVjb3JGbikgewogICAgdmFyIG9yaWdQcm92aWRlciA9IHByb3ZpZGVySW5qZWN0b3IuZ2V0KHNlcnZpY2VOYW1lICsgcHJvdmlkZXJTdWZmaXgpLAogICAgICAgIG9yaWckZ2V0ID0gb3JpZ1Byb3ZpZGVyLiRnZXQ7CgogICAgb3JpZ1Byb3ZpZGVyLiRnZXQgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9yaWdJbnN0YW5jZSA9IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKG9yaWckZ2V0LCBvcmlnUHJvdmlkZXIpOwogICAgICByZXR1cm4gaW5zdGFuY2VJbmplY3Rvci5pbnZva2UoZGVjb3JGbiwgbnVsbCwgeyRkZWxlZ2F0ZTogb3JpZ0luc3RhbmNlfSk7CiAgICB9OwogIH0KCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgLy8gTW9kdWxlIExvYWRpbmcKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICBmdW5jdGlvbiBsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKXsKICAgIHZhciBydW5CbG9ja3MgPSBbXSwgbW9kdWxlRm47CiAgICBmb3JFYWNoKG1vZHVsZXNUb0xvYWQsIGZ1bmN0aW9uKG1vZHVsZSkgewogICAgICBpZiAobG9hZGVkTW9kdWxlcy5nZXQobW9kdWxlKSkgcmV0dXJuOwogICAgICBsb2FkZWRNb2R1bGVzLnB1dChtb2R1bGUsIHRydWUpOwoKICAgICAgZnVuY3Rpb24gcnVuSW52b2tlUXVldWUocXVldWUpIHsKICAgICAgICB2YXIgaSwgaWk7CiAgICAgICAgZm9yKGkgPSAwLCBpaSA9IHF1ZXVlLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgIHZhciBpbnZva2VBcmdzID0gcXVldWVbaV0sCiAgICAgICAgICAgICAgcHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChpbnZva2VBcmdzWzBdKTsKCiAgICAgICAgICBwcm92aWRlcltpbnZva2VBcmdzWzFdXS5hcHBseShwcm92aWRlciwgaW52b2tlQXJnc1syXSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0cnkgewogICAgICAgIGlmIChpc1N0cmluZyhtb2R1bGUpKSB7CiAgICAgICAgICBtb2R1bGVGbiA9IGFuZ3VsYXJNb2R1bGUobW9kdWxlKTsKICAgICAgICAgIHJ1bkJsb2NrcyA9IHJ1bkJsb2Nrcy5jb25jYXQobG9hZE1vZHVsZXMobW9kdWxlRm4ucmVxdWlyZXMpKS5jb25jYXQobW9kdWxlRm4uX3J1bkJsb2Nrcyk7CiAgICAgICAgICBydW5JbnZva2VRdWV1ZShtb2R1bGVGbi5faW52b2tlUXVldWUpOwogICAgICAgICAgcnVuSW52b2tlUXVldWUobW9kdWxlRm4uX2NvbmZpZ0Jsb2Nrcyk7CiAgICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKG1vZHVsZSkpIHsKICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2gocHJvdmlkZXJJbmplY3Rvci5pbnZva2UobW9kdWxlKSk7CiAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KG1vZHVsZSkpIHsKICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2gocHJvdmlkZXJJbmplY3Rvci5pbnZva2UobW9kdWxlKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFzc2VydEFyZ0ZuKG1vZHVsZSwgJ21vZHVsZScpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChpc0FycmF5KG1vZHVsZSkpIHsKICAgICAgICAgIG1vZHVsZSA9IG1vZHVsZVttb2R1bGUubGVuZ3RoIC0gMV07CiAgICAgICAgfQogICAgICAgIGlmIChlLm1lc3NhZ2UgJiYgZS5zdGFjayAmJiBlLnN0YWNrLmluZGV4T2YoZS5tZXNzYWdlKSA9PSAtMSkgewogICAgICAgICAgLy8gU2FmYXJpICYgRkYncyBzdGFjayB0cmFjZXMgZG9uJ3QgY29udGFpbiBlcnJvci5tZXNzYWdlIGNvbnRlbnQKICAgICAgICAgIC8vIHVubGlrZSB0aG9zZSBvZiBDaHJvbWUgYW5kIElFCiAgICAgICAgICAvLyBTbyBpZiBzdGFjayBkb2Vzbid0IGNvbnRhaW4gbWVzc2FnZSwgd2UgY3JlYXRlIGEgbmV3IHN0cmluZyB0aGF0IGNvbnRhaW5zIGJvdGguCiAgICAgICAgICAvLyBTaW5jZSBlcnJvci5zdGFjayBpcyByZWFkLW9ubHkgaW4gU2FmYXJpLCBJJ20gb3ZlcnJpZGluZyBlIGFuZCBub3QgZS5zdGFjayBoZXJlLgogICAgICAgICAgLyoganNoaW50IC1XMDIyICovCiAgICAgICAgICBlID0gZS5tZXNzYWdlICsgJ1xuJyArIGUuc3RhY2s7CiAgICAgICAgfQogICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycignbW9kdWxlcnInLCAiRmFpbGVkIHRvIGluc3RhbnRpYXRlIG1vZHVsZSB7MH0gZHVlIHRvOlxuezF9IiwKICAgICAgICAgICAgICAgICAgbW9kdWxlLCBlLnN0YWNrIHx8IGUubWVzc2FnZSB8fCBlKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcnVuQmxvY2tzOwogIH0KCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgLy8gaW50ZXJuYWwgSW5qZWN0b3IKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgZnVuY3Rpb24gY3JlYXRlSW50ZXJuYWxJbmplY3RvcihjYWNoZSwgZmFjdG9yeSkgewoKICAgIGZ1bmN0aW9uIGdldFNlcnZpY2Uoc2VydmljZU5hbWUpIHsKICAgICAgaWYgKGNhY2hlLmhhc093blByb3BlcnR5KHNlcnZpY2VOYW1lKSkgewogICAgICAgIGlmIChjYWNoZVtzZXJ2aWNlTmFtZV0gPT09IElOU1RBTlRJQVRJTkcpIHsKICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycignY2RlcCcsICdDaXJjdWxhciBkZXBlbmRlbmN5IGZvdW5kOiB7MH0nLAogICAgICAgICAgICAgICAgICAgIHNlcnZpY2VOYW1lICsgJyA8LSAnICsgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdOwogICAgICB9IGVsc2UgewogICAgICAgIHRyeSB7CiAgICAgICAgICBwYXRoLnVuc2hpZnQoc2VydmljZU5hbWUpOwogICAgICAgICAgY2FjaGVbc2VydmljZU5hbWVdID0gSU5TVEFOVElBVElORzsKICAgICAgICAgIHJldHVybiBjYWNoZVtzZXJ2aWNlTmFtZV0gPSBmYWN0b3J5KHNlcnZpY2VOYW1lKTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIGlmIChjYWNoZVtzZXJ2aWNlTmFtZV0gPT09IElOU1RBTlRJQVRJTkcpIHsKICAgICAgICAgICAgZGVsZXRlIGNhY2hlW3NlcnZpY2VOYW1lXTsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IGVycjsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgcGF0aC5zaGlmdCgpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGludm9rZShmbiwgc2VsZiwgbG9jYWxzLCBzZXJ2aWNlTmFtZSkgewogICAgICBpZiAodHlwZW9mIGxvY2FscyA9PT0gJ3N0cmluZycpIHsKICAgICAgICBzZXJ2aWNlTmFtZSA9IGxvY2FsczsKICAgICAgICBsb2NhbHMgPSBudWxsOwogICAgICB9CgogICAgICB2YXIgYXJncyA9IFtdLAogICAgICAgICAgJGluamVjdCA9IGFubm90YXRlKGZuLCBzdHJpY3REaSwgc2VydmljZU5hbWUpLAogICAgICAgICAgbGVuZ3RoLCBpLAogICAgICAgICAga2V5OwoKICAgICAgZm9yKGkgPSAwLCBsZW5ndGggPSAkaW5qZWN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAga2V5ID0gJGluamVjdFtpXTsKICAgICAgICBpZiAodHlwZW9mIGtleSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycignaXRrbicsCiAgICAgICAgICAgICAgICAgICdJbmNvcnJlY3QgaW5qZWN0aW9uIHRva2VuISBFeHBlY3RlZCBzZXJ2aWNlIG5hbWUgYXMgc3RyaW5nLCBnb3QgezB9Jywga2V5KTsKICAgICAgICB9CiAgICAgICAgYXJncy5wdXNoKAogICAgICAgICAgbG9jYWxzICYmIGxvY2Fscy5oYXNPd25Qcm9wZXJ0eShrZXkpCiAgICAgICAgICA/IGxvY2Fsc1trZXldCiAgICAgICAgICA6IGdldFNlcnZpY2Uoa2V5KQogICAgICAgICk7CiAgICAgIH0KICAgICAgaWYgKGlzQXJyYXkoZm4pKSB7CiAgICAgICAgZm4gPSBmbltsZW5ndGhdOwogICAgICB9CgogICAgICAvLyBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyanMtaW52b2tlLWFwcGx5LXZzLXN3aXRjaAogICAgICAvLyAjNTM4OAogICAgICByZXR1cm4gZm4uYXBwbHkoc2VsZiwgYXJncyk7CiAgICB9CgogICAgZnVuY3Rpb24gaW5zdGFudGlhdGUoVHlwZSwgbG9jYWxzLCBzZXJ2aWNlTmFtZSkgewogICAgICB2YXIgQ29uc3RydWN0b3IgPSBmdW5jdGlvbigpIHt9LAogICAgICAgICAgaW5zdGFuY2UsIHJldHVybmVkVmFsdWU7CgogICAgICAvLyBDaGVjayBpZiBUeXBlIGlzIGFubm90YXRlZCBhbmQgdXNlIGp1c3QgdGhlIGdpdmVuIGZ1bmN0aW9uIGF0IG4tMSBhcyBwYXJhbWV0ZXIKICAgICAgLy8gZS5nLiBzb21lTW9kdWxlLmZhY3RvcnkoJ2dyZWV0ZXInLCBbJyR3aW5kb3cnLCBmdW5jdGlvbihyZW5hbWVkJHdpbmRvdykge31dKTsKICAgICAgQ29uc3RydWN0b3IucHJvdG90eXBlID0gKGlzQXJyYXkoVHlwZSkgPyBUeXBlW1R5cGUubGVuZ3RoIC0gMV0gOiBUeXBlKS5wcm90b3R5cGU7CiAgICAgIGluc3RhbmNlID0gbmV3IENvbnN0cnVjdG9yKCk7CiAgICAgIHJldHVybmVkVmFsdWUgPSBpbnZva2UoVHlwZSwgaW5zdGFuY2UsIGxvY2Fscywgc2VydmljZU5hbWUpOwoKICAgICAgcmV0dXJuIGlzT2JqZWN0KHJldHVybmVkVmFsdWUpIHx8IGlzRnVuY3Rpb24ocmV0dXJuZWRWYWx1ZSkgPyByZXR1cm5lZFZhbHVlIDogaW5zdGFuY2U7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgaW52b2tlOiBpbnZva2UsCiAgICAgIGluc3RhbnRpYXRlOiBpbnN0YW50aWF0ZSwKICAgICAgZ2V0OiBnZXRTZXJ2aWNlLAogICAgICBhbm5vdGF0ZTogYW5ub3RhdGUsCiAgICAgIGhhczogZnVuY3Rpb24obmFtZSkgewogICAgICAgIHJldHVybiBwcm92aWRlckNhY2hlLmhhc093blByb3BlcnR5KG5hbWUgKyBwcm92aWRlclN1ZmZpeCkgfHwgY2FjaGUuaGFzT3duUHJvcGVydHkobmFtZSk7CiAgICAgIH0KICAgIH07CiAgfQp9CgpjcmVhdGVJbmplY3Rvci4kJGFubm90YXRlID0gYW5ub3RhdGU7CgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRhbmNob3JTY3JvbGxQcm92aWRlcgogKgogKiBAZGVzY3JpcHRpb24KICogVXNlIGAkYW5jaG9yU2Nyb2xsUHJvdmlkZXJgIHRvIGRpc2FibGUgYXV0b21hdGljIHNjcm9sbGluZyB3aGVuZXZlcgogKiB7QGxpbmsgbmcuJGxvY2F0aW9uI2hhc2ggJGxvY2F0aW9uLmhhc2goKX0gY2hhbmdlcy4KICovCmZ1bmN0aW9uICRBbmNob3JTY3JvbGxQcm92aWRlcigpIHsKCiAgdmFyIGF1dG9TY3JvbGxpbmdFbmFibGVkID0gdHJ1ZTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRhbmNob3JTY3JvbGxQcm92aWRlciNkaXNhYmxlQXV0b1Njcm9sbGluZwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQnkgZGVmYXVsdCwge0BsaW5rIG5nLiRhbmNob3JTY3JvbGwgJGFuY2hvclNjcm9sbCgpfSB3aWxsIGF1dG9tYXRpY2FsbHkgd2lsbCBkZXRlY3QgY2hhbmdlcyB0bwogICAqIHtAbGluayBuZy4kbG9jYXRpb24jaGFzaCAkbG9jYXRpb24uaGFzaCgpfSBhbmQgc2Nyb2xsIHRvIHRoZSBlbGVtZW50IG1hdGNoaW5nIHRoZSBuZXcgaGFzaC48YnIgLz4KICAgKiBVc2UgdGhpcyBtZXRob2QgdG8gZGlzYWJsZSBhdXRvbWF0aWMgc2Nyb2xsaW5nLgogICAqCiAgICogSWYgYXV0b21hdGljIHNjcm9sbGluZyBpcyBkaXNhYmxlZCwgb25lIG11c3QgZXhwbGljaXRseSBjYWxsCiAgICoge0BsaW5rIG5nLiRhbmNob3JTY3JvbGwgJGFuY2hvclNjcm9sbCgpfSBpbiBvcmRlciB0byBzY3JvbGwgdG8gdGhlIGVsZW1lbnQgcmVsYXRlZCB0byB0aGUKICAgKiBjdXJyZW50IGhhc2guCiAgICovCiAgdGhpcy5kaXNhYmxlQXV0b1Njcm9sbGluZyA9IGZ1bmN0aW9uKCkgewogICAgYXV0b1Njcm9sbGluZ0VuYWJsZWQgPSBmYWxzZTsKICB9OwoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRhbmNob3JTY3JvbGwKICAgKiBAa2luZCBmdW5jdGlvbgogICAqIEByZXF1aXJlcyAkd2luZG93CiAgICogQHJlcXVpcmVzICRsb2NhdGlvbgogICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBXaGVuIGNhbGxlZCwgaXQgY2hlY2tzIHRoZSBjdXJyZW50IHZhbHVlIG9mIHtAbGluayBuZy4kbG9jYXRpb24jaGFzaCAkbG9jYXRpb24uaGFzaCgpfSBhbmQKICAgKiBzY3JvbGxzIHRvIHRoZSByZWxhdGVkIGVsZW1lbnQsIGFjY29yZGluZyB0byB0aGUgcnVsZXMgc3BlY2lmaWVkIGluIHRoZQogICAqIFtIdG1sNSBzcGVjXShodHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL092ZXJ2aWV3Lmh0bWwjdGhlLWluZGljYXRlZC1wYXJ0LW9mLXRoZS1kb2N1bWVudCkuCiAgICoKICAgKiBJdCBhbHNvIHdhdGNoZXMgdGhlIHtAbGluayBuZy4kbG9jYXRpb24jaGFzaCAkbG9jYXRpb24uaGFzaCgpfSBhbmQgYXV0b21hdGljYWxseSBzY3JvbGxzIHRvCiAgICogbWF0Y2ggYW55IGFuY2hvciB3aGVuZXZlciBpdCBjaGFuZ2VzLiBUaGlzIGNhbiBiZSBkaXNhYmxlZCBieSBjYWxsaW5nCiAgICoge0BsaW5rIG5nLiRhbmNob3JTY3JvbGxQcm92aWRlciNkaXNhYmxlQXV0b1Njcm9sbGluZyAkYW5jaG9yU2Nyb2xsUHJvdmlkZXIuZGlzYWJsZUF1dG9TY3JvbGxpbmcoKX0uCiAgICoKICAgKiBBZGRpdGlvbmFsbHksIHlvdSBjYW4gdXNlIGl0cyB7QGxpbmsgbmcuJGFuY2hvclNjcm9sbCN5T2Zmc2V0IHlPZmZzZXR9IHByb3BlcnR5IHRvIHNwZWNpZnkgYQogICAqIHZlcnRpY2FsIHNjcm9sbC1vZmZzZXQgKGVpdGhlciBmaXhlZCBvciBkeW5hbWljKS4KICAgKgogICAqIEBwcm9wZXJ0eSB7KG51bWJlcnxmdW5jdGlvbnxqcUxpdGUpfSB5T2Zmc2V0CiAgICogSWYgc2V0LCBzcGVjaWZpZXMgYSB2ZXJ0aWNhbCBzY3JvbGwtb2Zmc2V0LiBUaGlzIGlzIG9mdGVuIHVzZWZ1bCB3aGVuIHRoZXJlIGFyZSBmaXhlZAogICAqIHBvc2l0aW9uZWQgZWxlbWVudHMgYXQgdGhlIHRvcCBvZiB0aGUgcGFnZSwgc3VjaCBhcyBuYXZiYXJzLCBoZWFkZXJzIGV0Yy4KICAgKgogICAqIGB5T2Zmc2V0YCBjYW4gYmUgc3BlY2lmaWVkIGluIHZhcmlvdXMgd2F5czoKICAgKiAtICoqbnVtYmVyKio6IEEgZml4ZWQgbnVtYmVyIG9mIHBpeGVscyB0byBiZSB1c2VkIGFzIG9mZnNldC48YnIgLz48YnIgLz4KICAgKiAtICoqZnVuY3Rpb24qKjogQSBnZXR0ZXIgZnVuY3Rpb24gY2FsbGVkIGV2ZXJ5dGltZSBgJGFuY2hvclNjcm9sbCgpYCBpcyBleGVjdXRlZC4gTXVzdCByZXR1cm4KICAgKiAgIGEgbnVtYmVyIHJlcHJlc2VudGluZyB0aGUgb2Zmc2V0IChpbiBwaXhlbHMpLjxiciAvPjxiciAvPgogICAqIC0gKipqcUxpdGUqKjogQSBqcUxpdGUvalF1ZXJ5IGVsZW1lbnQgdG8gYmUgdXNlZCBmb3Igc3BlY2lmeWluZyB0aGUgb2Zmc2V0LiBUaGUgZGlzdGFuY2UgZnJvbQogICAqICAgdGhlIHRvcCBvZiB0aGUgcGFnZSB0byB0aGUgZWxlbWVudCdzIGJvdHRvbSB3aWxsIGJlIHVzZWQgYXMgb2Zmc2V0LjxiciAvPgogICAqICAgKipOb3RlKio6IFRoZSBlbGVtZW50IHdpbGwgYmUgdGFrZW4gaW50byBhY2NvdW50IG9ubHkgYXMgbG9uZyBhcyBpdHMgYHBvc2l0aW9uYCBpcyBzZXQgdG8KICAgKiAgIGBmaXhlZGAuIFRoaXMgb3B0aW9uIGlzIHVzZWZ1bCwgd2hlbiBkZWFsaW5nIHdpdGggcmVzcG9uc2l2ZSBuYXZiYXJzL2hlYWRlcnMgdGhhdCBhZGp1c3QKICAgKiAgIHRoZWlyIGhlaWdodCBhbmQvb3IgcG9zaXRpb25pbmcgYWNjb3JkaW5nIHRvIHRoZSB2aWV3cG9ydCdzIHNpemUuCiAgICoKICAgKiA8YnIgLz4KICAgKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICAgKiBJbiBvcmRlciBmb3IgYHlPZmZzZXRgIHRvIHdvcmsgcHJvcGVybHksIHNjcm9sbGluZyBzaG91bGQgdGFrZSBwbGFjZSBvbiB0aGUgZG9jdW1lbnQncyByb290IGFuZAogICAqIG5vdCBzb21lIGNoaWxkIGVsZW1lbnQuCiAgICogPC9kaXY+CiAgICoKICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlIG1vZHVsZT0iYW5jaG9yU2Nyb2xsRXhhbXBsZSI+CiAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgPGRpdiBpZD0ic2Nyb2xsQXJlYSIgbmctY29udHJvbGxlcj0iU2Nyb2xsQ29udHJvbGxlciI+CiAgICAgICAgICAgPGEgbmctY2xpY2s9ImdvdG9Cb3R0b20oKSI+R28gdG8gYm90dG9tPC9hPgogICAgICAgICAgIDxhIGlkPSJib3R0b20iPjwvYT4gWW91J3JlIGF0IHRoZSBib3R0b20hCiAgICAgICAgIDwvZGl2PgogICAgICAgPC9maWxlPgogICAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ2FuY2hvclNjcm9sbEV4YW1wbGUnLCBbXSkKICAgICAgICAgICAuY29udHJvbGxlcignU2Nyb2xsQ29udHJvbGxlcicsIFsnJHNjb3BlJywgJyRsb2NhdGlvbicsICckYW5jaG9yU2Nyb2xsJywKICAgICAgICAgICAgIGZ1bmN0aW9uICgkc2NvcGUsICRsb2NhdGlvbiwgJGFuY2hvclNjcm9sbCkgewogICAgICAgICAgICAgICAkc2NvcGUuZ290b0JvdHRvbSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgIC8vIHNldCB0aGUgbG9jYXRpb24uaGFzaCB0byB0aGUgaWQgb2YKICAgICAgICAgICAgICAgICAvLyB0aGUgZWxlbWVudCB5b3Ugd2lzaCB0byBzY3JvbGwgdG8uCiAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLmhhc2goJ2JvdHRvbScpOwoKICAgICAgICAgICAgICAgICAvLyBjYWxsICRhbmNob3JTY3JvbGwoKQogICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGwoKTsKICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgIH1dKTsKICAgICAgIDwvZmlsZT4KICAgICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgICAgICNzY3JvbGxBcmVhIHsKICAgICAgICAgICBoZWlnaHQ6IDI4MHB4OwogICAgICAgICAgIG92ZXJmbG93OiBhdXRvOwogICAgICAgICB9CgogICAgICAgICAjYm90dG9tIHsKICAgICAgICAgICBkaXNwbGF5OiBibG9jazsKICAgICAgICAgICBtYXJnaW4tdG9wOiAyMDAwcHg7CiAgICAgICAgIH0KICAgICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICoKICAgKiA8aHIgLz4KICAgKiBUaGUgZXhhbXBsZSBiZWxvdyBpbGx1c3RyYXRlcyB0aGUgdXNlIG9mIGEgdmVydGljYWwgc2Nyb2xsLW9mZnNldCAoc3BlY2lmaWVkIGFzIGEgZml4ZWQgdmFsdWUpLgogICAqIFNlZSB7QGxpbmsgbmcuJGFuY2hvclNjcm9sbCN5T2Zmc2V0ICRhbmNob3JTY3JvbGwueU9mZnNldH0gZm9yIG1vcmUgZGV0YWlscy4KICAgKgogICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGUgbW9kdWxlPSJhbmNob3JTY3JvbGxPZmZzZXRFeGFtcGxlIj4KICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICA8ZGl2IGNsYXNzPSJmaXhlZC1oZWFkZXIiIG5nLWNvbnRyb2xsZXI9ImhlYWRlckN0cmwiPgogICAgICAgICAgIDxhIGhyZWY9IiIgbmctY2xpY2s9ImdvdG9BbmNob3IoeCkiIG5nLXJlcGVhdD0ieCBpbiBbMSwyLDMsNCw1XSI+CiAgICAgICAgICAgICBHbyB0byBhbmNob3Ige3t4fX0KICAgICAgICAgICA8L2E+CiAgICAgICAgIDwvZGl2PgogICAgICAgICA8ZGl2IGlkPSJhbmNob3J7e3h9fSIgY2xhc3M9ImFuY2hvciIgbmctcmVwZWF0PSJ4IGluIFsxLDIsMyw0LDVdIj4KICAgICAgICAgICBBbmNob3Ige3t4fX0gb2YgNQogICAgICAgICA8L2Rpdj4KICAgICAgIDwvZmlsZT4KICAgICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCdhbmNob3JTY3JvbGxPZmZzZXRFeGFtcGxlJywgW10pCiAgICAgICAgICAgLnJ1bihbJyRhbmNob3JTY3JvbGwnLCBmdW5jdGlvbigkYW5jaG9yU2Nyb2xsKSB7CiAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsLnlPZmZzZXQgPSA1MDsgICAvLyBhbHdheXMgc2Nyb2xsIGJ5IDUwIGV4dHJhIHBpeGVscwogICAgICAgICAgIH1dKQogICAgICAgICAgIC5jb250cm9sbGVyKCdoZWFkZXJDdHJsJywgWyckYW5jaG9yU2Nyb2xsJywgJyRsb2NhdGlvbicsICckc2NvcGUnLAogICAgICAgICAgICAgZnVuY3Rpb24gKCRhbmNob3JTY3JvbGwsICRsb2NhdGlvbiwgJHNjb3BlKSB7CiAgICAgICAgICAgICAgICRzY29wZS5nb3RvQW5jaG9yID0gZnVuY3Rpb24oeCkgewogICAgICAgICAgICAgICAgIHZhciBuZXdIYXNoID0gJ2FuY2hvcicgKyB4OwogICAgICAgICAgICAgICAgIGlmICgkbG9jYXRpb24uaGFzaCgpICE9PSBuZXdIYXNoKSB7CiAgICAgICAgICAgICAgICAgICAvLyBzZXQgdGhlICRsb2NhdGlvbi5oYXNoIHRvIGBuZXdIYXNoYCBhbmQKICAgICAgICAgICAgICAgICAgIC8vICRhbmNob3JTY3JvbGwgd2lsbCBhdXRvbWF0aWNhbGx5IHNjcm9sbCB0byBpdAogICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLmhhc2goJ2FuY2hvcicgKyB4KTsKICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgLy8gY2FsbCAkYW5jaG9yU2Nyb2xsKCkgZXhwbGljaXRseSwKICAgICAgICAgICAgICAgICAgIC8vIHNpbmNlICRsb2NhdGlvbi5oYXNoIGhhc24ndCBjaGFuZ2VkCiAgICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsKCk7CiAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgfQogICAgICAgICAgIF0pOwogICAgICAgPC9maWxlPgogICAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgICAgYm9keSB7CiAgICAgICAgICAgcGFkZGluZy10b3A6IDUwcHg7CiAgICAgICAgIH0KCiAgICAgICAgIC5hbmNob3IgewogICAgICAgICAgIGJvcmRlcjogMnB4IGRhc2hlZCBEYXJrT3JjaGlkOwogICAgICAgICAgIHBhZGRpbmc6IDEwcHggMTBweCAyMDBweCAxMHB4OwogICAgICAgICB9CgogICAgICAgICAuZml4ZWQtaGVhZGVyIHsKICAgICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDAsIDAsIDAuMik7CiAgICAgICAgICAgaGVpZ2h0OiA1MHB4OwogICAgICAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgICAgICB0b3A6IDA7IGxlZnQ6IDA7IHJpZ2h0OiAwOwogICAgICAgICB9CgogICAgICAgICAuZml4ZWQtaGVhZGVyID4gYSB7CiAgICAgICAgICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgICAgICAgIG1hcmdpbjogNXB4IDE1cHg7CiAgICAgICAgIH0KICAgICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICovCiAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgJyRsb2NhdGlvbicsICckcm9vdFNjb3BlJywgZnVuY3Rpb24oJHdpbmRvdywgJGxvY2F0aW9uLCAkcm9vdFNjb3BlKSB7CiAgICB2YXIgZG9jdW1lbnQgPSAkd2luZG93LmRvY3VtZW50OwogICAgdmFyIHNjcm9sbFNjaGVkdWxlZCA9IGZhbHNlOwoKICAgIC8vIEhlbHBlciBmdW5jdGlvbiB0byBnZXQgZmlyc3QgYW5jaG9yIGZyb20gYSBOb2RlTGlzdAogICAgLy8gKHVzaW5nIGBBcnJheSNzb21lKClgIGluc3RlYWQgb2YgYGFuZ3VsYXIjZm9yRWFjaCgpYCBzaW5jZSBpdCdzIG1vcmUgcGVyZm9ybWFudAogICAgLy8gIGFuZCB3b3JraW5nIGluIGFsbCBzdXBwb3J0ZWQgYnJvd3NlcnMuKQogICAgZnVuY3Rpb24gZ2V0Rmlyc3RBbmNob3IobGlzdCkgewogICAgICB2YXIgcmVzdWx0ID0gbnVsbDsKICAgICAgQXJyYXkucHJvdG90eXBlLnNvbWUuY2FsbChsaXN0LCBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgaWYgKG5vZGVOYW1lXyhlbGVtZW50KSA9PT0gJ2EnKSB7CiAgICAgICAgICByZXN1bHQgPSBlbGVtZW50OwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRZT2Zmc2V0KCkgewoKICAgICAgdmFyIG9mZnNldCA9IHNjcm9sbC55T2Zmc2V0OwoKICAgICAgaWYgKGlzRnVuY3Rpb24ob2Zmc2V0KSkgewogICAgICAgIG9mZnNldCA9IG9mZnNldCgpOwogICAgICB9IGVsc2UgaWYgKGlzRWxlbWVudChvZmZzZXQpKSB7CiAgICAgICAgdmFyIGVsZW0gPSBvZmZzZXRbMF07CiAgICAgICAgdmFyIHN0eWxlID0gJHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsZW0pOwogICAgICAgIGlmIChzdHlsZS5wb3NpdGlvbiAhPT0gJ2ZpeGVkJykgewogICAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb2Zmc2V0ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b207CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKCFpc051bWJlcihvZmZzZXQpKSB7CiAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgfQoKICAgICAgcmV0dXJuIG9mZnNldDsKICAgIH0KCiAgICBmdW5jdGlvbiBzY3JvbGxUbyhlbGVtKSB7CiAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgZWxlbS5zY3JvbGxJbnRvVmlldygpOwoKICAgICAgICB2YXIgb2Zmc2V0ID0gZ2V0WU9mZnNldCgpOwoKICAgICAgICBpZiAob2Zmc2V0KSB7CiAgICAgICAgICAvLyBgb2Zmc2V0YCBpcyB0aGUgbnVtYmVyIG9mIHBpeGVscyB3ZSBzaG91bGQgc2Nyb2xsIFVQIGluIG9yZGVyIHRvIGFsaWduIGBlbGVtYCBwcm9wZXJseS4KICAgICAgICAgIC8vIFRoaXMgaXMgdHJ1ZSBPTkxZIGlmIHRoZSBjYWxsIHRvIGBlbGVtLnNjcm9sbEludG9WaWV3KClgIGluaXRpYWxseSBhbGlnbnMgYGVsZW1gIGF0IHRoZQogICAgICAgICAgLy8gdG9wIG9mIHRoZSB2aWV3cG9ydC4KICAgICAgICAgIC8vCiAgICAgICAgICAvLyBJRiB0aGUgbnVtYmVyIG9mIHBpeGVscyBmcm9tIHRoZSB0b3Agb2YgYGVsZW1gIHRvIHRoZSBlbmQgb2YgdGhlIHBhZ2UncyBjb250ZW50IGlzIGxlc3MKICAgICAgICAgIC8vIHRoYW4gdGhlIGhlaWdodCBvZiB0aGUgdmlld3BvcnQsIHRoZW4gYGVsZW0uc2Nyb2xsSW50b1ZpZXcoKWAgd2lsbCBhbGlnbiB0aGUgYGVsZW1gIHNvbWUKICAgICAgICAgIC8vIHdheSBkb3duIHRoZSBwYWdlLgogICAgICAgICAgLy8KICAgICAgICAgIC8vIFRoaXMgaXMgb2Z0ZW4gdGhlIGNhc2UgZm9yIGVsZW1lbnRzIG5lYXIgdGhlIGJvdHRvbSBvZiB0aGUgcGFnZS4KICAgICAgICAgIC8vCiAgICAgICAgICAvLyBJbiBzdWNoIGNhc2VzIHdlIGRvIG5vdCBuZWVkIHRvIHNjcm9sbCB0aGUgd2hvbGUgYG9mZnNldGAgdXAsIGp1c3QgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbgogICAgICAgICAgLy8gdGhlIHRvcCBvZiB0aGUgZWxlbWVudCBhbmQgdGhlIG9mZnNldCwgd2hpY2ggaXMgZW5vdWdoIHRvIGFsaWduIHRoZSB0b3Agb2YgYGVsZW1gIGF0IHRoZQogICAgICAgICAgLy8gZGVzaXJlZCBwb3NpdGlvbi4KICAgICAgICAgIHZhciBlbGVtVG9wID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3A7CiAgICAgICAgICAkd2luZG93LnNjcm9sbEJ5KDAsIGVsZW1Ub3AgLSBvZmZzZXQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAkd2luZG93LnNjcm9sbFRvKDAsIDApOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gc2Nyb2xsKCkgewogICAgICB2YXIgaGFzaCA9ICRsb2NhdGlvbi5oYXNoKCksIGVsbTsKCiAgICAgIC8vIGVtcHR5IGhhc2gsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgIGlmICghaGFzaCkgc2Nyb2xsVG8obnVsbCk7CgogICAgICAvLyBlbGVtZW50IHdpdGggZ2l2ZW4gaWQKICAgICAgZWxzZSBpZiAoKGVsbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGhhc2gpKSkgc2Nyb2xsVG8oZWxtKTsKCiAgICAgIC8vIGZpcnN0IGFuY2hvciB3aXRoIGdpdmVuIG5hbWUgOi1ECiAgICAgIGVsc2UgaWYgKChlbG0gPSBnZXRGaXJzdEFuY2hvcihkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZShoYXNoKSkpKSBzY3JvbGxUbyhlbG0pOwoKICAgICAgLy8gbm8gZWxlbWVudCBhbmQgaGFzaCA9PSAndG9wJywgc2Nyb2xsIHRvIHRoZSB0b3Agb2YgdGhlIHBhZ2UKICAgICAgZWxzZSBpZiAoaGFzaCA9PT0gJ3RvcCcpIHNjcm9sbFRvKG51bGwpOwogICAgfQoKICAgIC8vIGRvZXMgbm90IHNjcm9sbCB3aGVuIHVzZXIgY2xpY2tzIG9uIGFuY2hvciBsaW5rIHRoYXQgaXMgY3VycmVudGx5IG9uCiAgICAvLyAobm8gdXJsIGNoYW5nZSwgbm8gJGxvY2F0aW9uLmhhc2goKSBjaGFuZ2UpLCBicm93c2VyIG5hdGl2ZSBkb2VzIHNjcm9sbAogICAgaWYgKGF1dG9TY3JvbGxpbmdFbmFibGVkKSB7CiAgICAgICRyb290U2NvcGUuJHdhdGNoKGZ1bmN0aW9uIGF1dG9TY3JvbGxXYXRjaCgpIHtyZXR1cm4gJGxvY2F0aW9uLmhhc2goKTt9LAogICAgICAgIGZ1bmN0aW9uIGF1dG9TY3JvbGxXYXRjaEFjdGlvbihuZXdWYWwsIG9sZFZhbCkgewogICAgICAgICAgLy8gc2tpcCB0aGUgaW5pdGlhbCBzY3JvbGwgaWYgJGxvY2F0aW9uLmhhc2ggaXMgZW1wdHkKICAgICAgICAgIGlmIChuZXdWYWwgPT09IG9sZFZhbCAmJiBuZXdWYWwgPT09ICcnKSByZXR1cm47CgogICAgICAgICAganFMaXRlRG9jdW1lbnRMb2FkZWQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhzY3JvbGwpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIHNjcm9sbDsKICB9XTsKfQoKdmFyICRhbmltYXRlTWluRXJyID0gbWluRXJyKCckYW5pbWF0ZScpOwoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkYW5pbWF0ZVByb3ZpZGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mICRhbmltYXRlIHRoYXQgZG9lc24ndCBwZXJmb3JtIGFueSBhbmltYXRpb25zLCBpbnN0ZWFkIGp1c3QKICogc3luY2hyb25vdXNseSBwZXJmb3JtcyBET00KICogdXBkYXRlcyBhbmQgY2FsbHMgZG9uZSgpIGNhbGxiYWNrcy4KICoKICogSW4gb3JkZXIgdG8gZW5hYmxlIGFuaW1hdGlvbnMgdGhlIG5nQW5pbWF0ZSBtb2R1bGUgaGFzIHRvIGJlIGxvYWRlZC4KICoKICogVG8gc2VlIHRoZSBmdW5jdGlvbmFsIGltcGxlbWVudGF0aW9uIGNoZWNrIG91dCBzcmMvbmdBbmltYXRlL2FuaW1hdGUuanMKICovCnZhciAkQW5pbWF0ZVByb3ZpZGVyID0gWyckcHJvdmlkZScsIGZ1bmN0aW9uKCRwcm92aWRlKSB7CgoKICB0aGlzLiQkc2VsZWN0b3JzID0ge307CgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGFuaW1hdGVQcm92aWRlciNyZWdpc3RlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmVnaXN0ZXJzIGEgbmV3IGluamVjdGFibGUgYW5pbWF0aW9uIGZhY3RvcnkgZnVuY3Rpb24uIFRoZSBmYWN0b3J5IGZ1bmN0aW9uIHByb2R1Y2VzIHRoZQogICAqIGFuaW1hdGlvbiBvYmplY3Qgd2hpY2ggY29udGFpbnMgY2FsbGJhY2sgZnVuY3Rpb25zIGZvciBlYWNoIGV2ZW50IHRoYXQgaXMgZXhwZWN0ZWQgdG8gYmUKICAgKiBhbmltYXRlZC4KICAgKgogICAqICAgKiBgZXZlbnRGbmA6IGBmdW5jdGlvbihFbGVtZW50LCBkb25lRnVuY3Rpb24pYCBUaGUgZWxlbWVudCB0byBhbmltYXRlLCB0aGUgYGRvbmVGdW5jdGlvbmAKICAgKiAgIG11c3QgYmUgY2FsbGVkIG9uY2UgdGhlIGVsZW1lbnQgYW5pbWF0aW9uIGlzIGNvbXBsZXRlLiBJZiBhIGZ1bmN0aW9uIGlzIHJldHVybmVkIHRoZW4gdGhlCiAgICogICBhbmltYXRpb24gc2VydmljZSB3aWxsIHVzZSB0aGlzIGZ1bmN0aW9uIHRvIGNhbmNlbCB0aGUgYW5pbWF0aW9uIHdoZW5ldmVyIGEgY2FuY2VsIGV2ZW50IGlzCiAgICogICB0cmlnZ2VyZWQuCiAgICoKICAgKgogICAqIGBgYGpzCiAgICogICByZXR1cm4gewogICAgICogICAgIGV2ZW50Rm4gOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7CiAgICAgKiAgICAgICAvL2NvZGUgdG8gcnVuIHRoZSBhbmltYXRpb24KICAgICAqICAgICAgIC8vb25jZSBjb21wbGV0ZSwgdGhlbiBydW4gZG9uZSgpCiAgICAgKiAgICAgICByZXR1cm4gZnVuY3Rpb24gY2FuY2VsbGF0aW9uRnVuY3Rpb24oKSB7CiAgICAgKiAgICAgICAgIC8vY29kZSB0byBjYW5jZWwgdGhlIGFuaW1hdGlvbgogICAgICogICAgICAgfQogICAgICogICAgIH0KICAgICAqICAgfQogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGFuaW1hdGlvbi4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmYWN0b3J5IFRoZSBmYWN0b3J5IGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCB0byByZXR1cm4gdGhlIGFuaW1hdGlvbgogICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0LgogICAqLwogIHRoaXMucmVnaXN0ZXIgPSBmdW5jdGlvbihuYW1lLCBmYWN0b3J5KSB7CiAgICB2YXIga2V5ID0gbmFtZSArICctYW5pbWF0aW9uJzsKICAgIGlmIChuYW1lICYmIG5hbWUuY2hhckF0KDApICE9ICcuJykgdGhyb3cgJGFuaW1hdGVNaW5FcnIoJ25vdGNzZWwnLAogICAgICAgICJFeHBlY3RpbmcgY2xhc3Mgc2VsZWN0b3Igc3RhcnRpbmcgd2l0aCAnLicgZ290ICd7MH0nLiIsIG5hbWUpOwogICAgdGhpcy4kJHNlbGVjdG9yc1tuYW1lLnN1YnN0cigxKV0gPSBrZXk7CiAgICAkcHJvdmlkZS5mYWN0b3J5KGtleSwgZmFjdG9yeSk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRhbmltYXRlUHJvdmlkZXIjY2xhc3NOYW1lRmlsdGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXRzIGFuZC9vciByZXR1cm5zIHRoZSBDU1MgY2xhc3MgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgY2hlY2tlZCB3aGVuIHBlcmZvcm1pbmcKICAgKiBhbiBhbmltYXRpb24uIFVwb24gYm9vdHN0cmFwIHRoZSBjbGFzc05hbWVGaWx0ZXIgdmFsdWUgaXMgbm90IHNldCBhdCBhbGwgYW5kIHdpbGwKICAgKiB0aGVyZWZvcmUgZW5hYmxlICRhbmltYXRlIHRvIGF0dGVtcHQgdG8gcGVyZm9ybSBhbiBhbmltYXRpb24gb24gYW55IGVsZW1lbnQuCiAgICogV2hlbiBzZXR0aW5nIHRoZSBjbGFzc05hbWVGaWx0ZXIgdmFsdWUsIGFuaW1hdGlvbnMgd2lsbCBvbmx5IGJlIHBlcmZvcm1lZCBvbiBlbGVtZW50cwogICAqIHRoYXQgc3VjY2Vzc2Z1bGx5IG1hdGNoIHRoZSBmaWx0ZXIgZXhwcmVzc2lvbi4gVGhpcyBpbiB0dXJuIGNhbiBib29zdCBwZXJmb3JtYW5jZQogICAqIGZvciBsb3ctcG93ZXJlZCBkZXZpY2VzIGFzIHdlbGwgYXMgYXBwbGljYXRpb25zIGNvbnRhaW5pbmcgYSBsb3Qgb2Ygc3RydWN0dXJhbCBvcGVyYXRpb25zLgogICAqIEBwYXJhbSB7UmVnRXhwPX0gZXhwcmVzc2lvbiBUaGUgY2xhc3NOYW1lIGV4cHJlc3Npb24gd2hpY2ggd2lsbCBiZSBjaGVja2VkIGFnYWluc3QgYWxsIGFuaW1hdGlvbnMKICAgKiBAcmV0dXJuIHtSZWdFeHB9IFRoZSBjdXJyZW50IENTUyBjbGFzc05hbWUgZXhwcmVzc2lvbiB2YWx1ZS4gSWYgbnVsbCB0aGVuIHRoZXJlIGlzIG5vIGV4cHJlc3Npb24gdmFsdWUKICAgKi8KICB0aGlzLmNsYXNzTmFtZUZpbHRlciA9IGZ1bmN0aW9uKGV4cHJlc3Npb24pIHsKICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgdGhpcy4kJGNsYXNzTmFtZUZpbHRlciA9IChleHByZXNzaW9uIGluc3RhbmNlb2YgUmVnRXhwKSA/IGV4cHJlc3Npb24gOiBudWxsOwogICAgfQogICAgcmV0dXJuIHRoaXMuJCRjbGFzc05hbWVGaWx0ZXI7CiAgfTsKCiAgdGhpcy4kZ2V0ID0gWyckJHEnLCAnJCRhc3luY0NhbGxiYWNrJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbigkJHEsICQkYXN5bmNDYWxsYmFjaywgJHJvb3RTY29wZSkgewoKICAgIHZhciBjdXJyZW50RGVmZXI7CgogICAgZnVuY3Rpb24gcnVuQW5pbWF0aW9uUG9zdERpZ2VzdChmbikgewogICAgICB2YXIgY2FuY2VsRm4sIGRlZmVyID0gJCRxLmRlZmVyKCk7CiAgICAgIGRlZmVyLnByb21pc2UuJCRjYW5jZWxGbiA9IGZ1bmN0aW9uIG5nQW5pbWF0ZU1heWJlQ2FuY2VsKCkgewogICAgICAgIGNhbmNlbEZuICYmIGNhbmNlbEZuKCk7CiAgICAgIH07CgogICAgICAkcm9vdFNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbiBuZ0FuaW1hdGVQb3N0RGlnZXN0KCkgewogICAgICAgIGNhbmNlbEZuID0gZm4oZnVuY3Rpb24gbmdBbmltYXRlTm90aWZ5Q29tcGxldGUoKSB7CiAgICAgICAgICBkZWZlci5yZXNvbHZlKCk7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICB9CgogICAgZnVuY3Rpb24gcmVzb2x2ZUVsZW1lbnRDbGFzc2VzKGVsZW1lbnQsIGNsYXNzZXMpIHsKICAgICAgdmFyIHRvQWRkID0gW10sIHRvUmVtb3ZlID0gW107CgogICAgICB2YXIgaGFzQ2xhc3NlcyA9IGNyZWF0ZU1hcCgpOwogICAgICBmb3JFYWNoKChlbGVtZW50LmF0dHIoJ2NsYXNzJykgfHwgJycpLnNwbGl0KC9ccysvKSwgZnVuY3Rpb24oY2xhc3NOYW1lKSB7CiAgICAgICAgaGFzQ2xhc3Nlc1tjbGFzc05hbWVdID0gdHJ1ZTsKICAgICAgfSk7CgogICAgICBmb3JFYWNoKGNsYXNzZXMsIGZ1bmN0aW9uKHN0YXR1cywgY2xhc3NOYW1lKSB7CiAgICAgICAgdmFyIGhhc0NsYXNzID0gaGFzQ2xhc3Nlc1tjbGFzc05hbWVdOwoKICAgICAgICAvLyBJZiB0aGUgbW9zdCByZWNlbnQgY2xhc3MgbWFuaXB1bGF0aW9uICh2aWEgJGFuaW1hdGUpIHdhcyB0byByZW1vdmUgdGhlIGNsYXNzLCBhbmQgdGhlCiAgICAgICAgLy8gZWxlbWVudCBjdXJyZW50bHkgaGFzIHRoZSBjbGFzcywgdGhlIGNsYXNzIGlzIHNjaGVkdWxlZCBmb3IgcmVtb3ZhbC4gT3RoZXJ3aXNlLCBpZgogICAgICAgIC8vIHRoZSBtb3N0IHJlY2VudCBjbGFzcyBtYW5pcHVsYXRpb24gKHZpYSAkYW5pbWF0ZSkgd2FzIHRvIGFkZCB0aGUgY2xhc3MsIGFuZCB0aGUKICAgICAgICAvLyBlbGVtZW50IGRvZXMgbm90IGN1cnJlbnRseSBoYXZlIHRoZSBjbGFzcywgdGhlIGNsYXNzIGlzIHNjaGVkdWxlZCB0byBiZSBhZGRlZC4KICAgICAgICBpZiAoc3RhdHVzID09PSBmYWxzZSAmJiBoYXNDbGFzcykgewogICAgICAgICAgdG9SZW1vdmUucHVzaChjbGFzc05hbWUpOwogICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSB0cnVlICYmICFoYXNDbGFzcykgewogICAgICAgICAgdG9BZGQucHVzaChjbGFzc05hbWUpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4gKHRvQWRkLmxlbmd0aCArIHRvUmVtb3ZlLmxlbmd0aCkgPiAwICYmCiAgICAgICAgW3RvQWRkLmxlbmd0aCA/IHRvQWRkIDogbnVsbCwgdG9SZW1vdmUubGVuZ3RoID8gdG9SZW1vdmUgOiBudWxsXTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYWNoZWRDbGFzc01hbmlwdWxhdGlvbihjYWNoZSwgY2xhc3Nlcywgb3ApIHsKICAgICAgZm9yICh2YXIgaT0wLCBpaSA9IGNsYXNzZXMubGVuZ3RoOyBpIDwgaWk7ICsraSkgewogICAgICAgIHZhciBjbGFzc05hbWUgPSBjbGFzc2VzW2ldOwogICAgICAgIGNhY2hlW2NsYXNzTmFtZV0gPSBvcDsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGFzeW5jUHJvbWlzZSgpIHsKICAgICAgLy8gb25seSBzZXJ2ZSBvbmUgaW5zdGFuY2Ugb2YgYSBwcm9taXNlIGluIG9yZGVyIHRvIHNhdmUgQ1BVIGN5Y2xlcwogICAgICBpZiAoIWN1cnJlbnREZWZlcikgewogICAgICAgIGN1cnJlbnREZWZlciA9ICQkcS5kZWZlcigpOwogICAgICAgICQkYXN5bmNDYWxsYmFjayhmdW5jdGlvbigpIHsKICAgICAgICAgIGN1cnJlbnREZWZlci5yZXNvbHZlKCk7CiAgICAgICAgICBjdXJyZW50RGVmZXIgPSBudWxsOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBjdXJyZW50RGVmZXIucHJvbWlzZTsKICAgIH0KCiAgICBmdW5jdGlvbiBhcHBseVN0eWxlcyhlbGVtZW50LCBvcHRpb25zKSB7CiAgICAgIGlmIChhbmd1bGFyLmlzT2JqZWN0KG9wdGlvbnMpKSB7CiAgICAgICAgdmFyIHN0eWxlcyA9IGV4dGVuZChvcHRpb25zLmZyb20gfHwge30sIG9wdGlvbnMudG8gfHwge30pOwogICAgICAgIGVsZW1lbnQuY3NzKHN0eWxlcyk7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQG5hbWUgJGFuaW1hdGUKICAgICAqIEBkZXNjcmlwdGlvbiBUaGUgJGFuaW1hdGUgc2VydmljZSBwcm92aWRlcyBydWRpbWVudGFyeSBET00gbWFuaXB1bGF0aW9uIGZ1bmN0aW9ucyB0bwogICAgICogaW5zZXJ0LCByZW1vdmUgYW5kIG1vdmUgZWxlbWVudHMgd2l0aGluIHRoZSBET00sIGFzIHdlbGwgYXMgYWRkaW5nIGFuZCByZW1vdmluZyBjbGFzc2VzLgogICAgICogVGhpcyBzZXJ2aWNlIGlzIHRoZSBjb3JlIHNlcnZpY2UgdXNlZCBieSB0aGUgbmdBbmltYXRlICRhbmltYXRvciBzZXJ2aWNlIHdoaWNoIHByb3ZpZGVzCiAgICAgKiBoaWdoLWxldmVsIGFuaW1hdGlvbiBob29rcyBmb3IgQ1NTIGFuZCBKYXZhU2NyaXB0LgogICAgICoKICAgICAqICRhbmltYXRlIGlzIGF2YWlsYWJsZSBpbiB0aGUgQW5ndWxhckpTIGNvcmUsIGhvd2V2ZXIsIHRoZSBuZ0FuaW1hdGUgbW9kdWxlIG11c3QgYmUgaW5jbHVkZWQKICAgICAqIHRvIGVuYWJsZSBmdWxsIG91dCBhbmltYXRpb24gc3VwcG9ydC4gT3RoZXJ3aXNlLCAkYW5pbWF0ZSB3aWxsIG9ubHkgcGVyZm9ybSBzaW1wbGUgRE9NCiAgICAgKiBtYW5pcHVsYXRpb24gb3BlcmF0aW9ucy4KICAgICAqCiAgICAgKiBUbyBsZWFybiBtb3JlIGFib3V0IGVuYWJsaW5nIGFuaW1hdGlvbiBzdXBwb3J0LCBjbGljayBoZXJlIHRvIHZpc2l0IHRoZSB7QGxpbmsgbmdBbmltYXRlCiAgICAgKiBuZ0FuaW1hdGUgbW9kdWxlIHBhZ2V9IGFzIHdlbGwgYXMgdGhlIHtAbGluayBuZ0FuaW1hdGUuJGFuaW1hdGUgbmdBbmltYXRlICRhbmltYXRlIHNlcnZpY2UKICAgICAqIHBhZ2V9LgogICAgICovCiAgICByZXR1cm4gewogICAgICBhbmltYXRlIDogZnVuY3Rpb24oZWxlbWVudCwgZnJvbSwgdG8pIHsKICAgICAgICBhcHBseVN0eWxlcyhlbGVtZW50LCB7IGZyb206IGZyb20sIHRvOiB0byB9KTsKICAgICAgICByZXR1cm4gYXN5bmNQcm9taXNlKCk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICoKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNlbnRlcgogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKiBAZGVzY3JpcHRpb24gSW5zZXJ0cyB0aGUgZWxlbWVudCBpbnRvIHRoZSBET00gZWl0aGVyIGFmdGVyIHRoZSBgYWZ0ZXJgIGVsZW1lbnQgb3IKICAgICAgICogYXMgdGhlIGZpcnN0IGNoaWxkIHdpdGhpbiB0aGUgYHBhcmVudGAgZWxlbWVudC4gV2hlbiB0aGUgZnVuY3Rpb24gaXMgY2FsbGVkIGEgcHJvbWlzZQogICAgICAgKiBpcyByZXR1cm5lZCB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgYXQgYSBsYXRlciB0aW1lLgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBiZSBpbnNlcnRlZCBpbnRvIHRoZSBET00KICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBwYXJlbnQgdGhlIHBhcmVudCBlbGVtZW50IHdoaWNoIHdpbGwgYXBwZW5kIHRoZSBlbGVtZW50IGFzCiAgICAgICAqICAgYSBjaGlsZCAoaWYgdGhlIGFmdGVyIGVsZW1lbnQgaXMgbm90IHByZXNlbnQpCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gYWZ0ZXIgdGhlIHNpYmxpbmcgZWxlbWVudCB3aGljaCB3aWxsIGFwcGVuZCB0aGUgZWxlbWVudAogICAgICAgKiAgIGFmdGVyIGl0c2VsZgogICAgICAgKiBAcGFyYW0ge29iamVjdD19IG9wdGlvbnMgYW4gb3B0aW9uYWwgY29sbGVjdGlvbiBvZiBzdHlsZXMgdGhhdCB3aWxsIGJlIGFwcGxpZWQgdG8gdGhlIGVsZW1lbnQuCiAgICAgICAqIEByZXR1cm4ge1Byb21pc2V9IHRoZSBhbmltYXRpb24gY2FsbGJhY2sgcHJvbWlzZQogICAgICAgKi8KICAgICAgZW50ZXIgOiBmdW5jdGlvbihlbGVtZW50LCBwYXJlbnQsIGFmdGVyLCBvcHRpb25zKSB7CiAgICAgICAgYXBwbHlTdHlsZXMoZWxlbWVudCwgb3B0aW9ucyk7CiAgICAgICAgYWZ0ZXIgPyBhZnRlci5hZnRlcihlbGVtZW50KQogICAgICAgICAgICAgIDogcGFyZW50LnByZXBlbmQoZWxlbWVudCk7CiAgICAgICAgcmV0dXJuIGFzeW5jUHJvbWlzZSgpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGFuaW1hdGUjbGVhdmUKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICogQGRlc2NyaXB0aW9uIFJlbW92ZXMgdGhlIGVsZW1lbnQgZnJvbSB0aGUgRE9NLiBXaGVuIHRoZSBmdW5jdGlvbiBpcyBjYWxsZWQgYSBwcm9taXNlCiAgICAgICAqIGlzIHJldHVybmVkIHRoYXQgd2lsbCBiZSByZXNvbHZlZCBhdCBhIGxhdGVyIHRpbWUuCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgRE9NCiAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBhbiBvcHRpb25hbCBjb2xsZWN0aW9uIG9mIG9wdGlvbnMgdGhhdCB3aWxsIGJlIGFwcGxpZWQgdG8gdGhlIGVsZW1lbnQuCiAgICAgICAqIEByZXR1cm4ge1Byb21pc2V9IHRoZSBhbmltYXRpb24gY2FsbGJhY2sgcHJvbWlzZQogICAgICAgKi8KICAgICAgbGVhdmUgOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7CiAgICAgICAgZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICByZXR1cm4gYXN5bmNQcm9taXNlKCk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICoKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNtb3ZlCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqIEBkZXNjcmlwdGlvbiBNb3ZlcyB0aGUgcG9zaXRpb24gb2YgdGhlIHByb3ZpZGVkIGVsZW1lbnQgd2l0aGluIHRoZSBET00gdG8gYmUgcGxhY2VkCiAgICAgICAqIGVpdGhlciBhZnRlciB0aGUgYGFmdGVyYCBlbGVtZW50IG9yIGluc2lkZSBvZiB0aGUgYHBhcmVudGAgZWxlbWVudC4gV2hlbiB0aGUgZnVuY3Rpb24KICAgICAgICogaXMgY2FsbGVkIGEgcHJvbWlzZSBpcyByZXR1cm5lZCB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgYXQgYSBsYXRlciB0aW1lLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBiZSBtb3ZlZCBhcm91bmQgd2l0aGluIHRoZQogICAgICAgKiAgIERPTQogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IHBhcmVudCB0aGUgcGFyZW50IGVsZW1lbnQgd2hlcmUgdGhlIGVsZW1lbnQgd2lsbCBiZQogICAgICAgKiAgIGluc2VydGVkIGludG8gKGlmIHRoZSBhZnRlciBlbGVtZW50IGlzIG5vdCBwcmVzZW50KQogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGFmdGVyIHRoZSBzaWJsaW5nIGVsZW1lbnQgd2hlcmUgdGhlIGVsZW1lbnQgd2lsbCBiZQogICAgICAgKiAgIHBvc2l0aW9uZWQgbmV4dCB0bwogICAgICAgKiBAcGFyYW0ge29iamVjdD19IG9wdGlvbnMgYW4gb3B0aW9uYWwgY29sbGVjdGlvbiBvZiBvcHRpb25zIHRoYXQgd2lsbCBiZSBhcHBsaWVkIHRvIHRoZSBlbGVtZW50LgogICAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSB0aGUgYW5pbWF0aW9uIGNhbGxiYWNrIHByb21pc2UKICAgICAgICovCiAgICAgIG1vdmUgOiBmdW5jdGlvbihlbGVtZW50LCBwYXJlbnQsIGFmdGVyLCBvcHRpb25zKSB7CiAgICAgICAgLy8gRG8gbm90IHJlbW92ZSBlbGVtZW50IGJlZm9yZSBpbnNlcnQuIFJlbW92aW5nIHdpbGwgY2F1c2UgZGF0YSBhc3NvY2lhdGVkIHdpdGggdGhlCiAgICAgICAgLy8gZWxlbWVudCB0byBiZSBkcm9wcGVkLiBJbnNlcnQgd2lsbCBpbXBsaWNpdGx5IGRvIHRoZSByZW1vdmUuCiAgICAgICAgcmV0dXJuIHRoaXMuZW50ZXIoZWxlbWVudCwgcGFyZW50LCBhZnRlciwgb3B0aW9ucyk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICoKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNhZGRDbGFzcwogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKiBAZGVzY3JpcHRpb24gQWRkcyB0aGUgcHJvdmlkZWQgY2xhc3NOYW1lIENTUyBjbGFzcyB2YWx1ZSB0byB0aGUgcHJvdmlkZWQgZWxlbWVudC4KICAgICAgICogV2hlbiB0aGUgZnVuY3Rpb24gaXMgY2FsbGVkIGEgcHJvbWlzZSBpcyByZXR1cm5lZCB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgYXQgYSBsYXRlciB0aW1lLgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBoYXZlIHRoZSBjbGFzc05hbWUgdmFsdWUKICAgICAgICogICBhZGRlZCB0byBpdAogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgKiBAcGFyYW0ge29iamVjdD19IG9wdGlvbnMgYW4gb3B0aW9uYWwgY29sbGVjdGlvbiBvZiBvcHRpb25zIHRoYXQgd2lsbCBiZSBhcHBsaWVkIHRvIHRoZSBlbGVtZW50LgogICAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSB0aGUgYW5pbWF0aW9uIGNhbGxiYWNrIHByb21pc2UKICAgICAgICovCiAgICAgIGFkZENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0Q2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lLCBbXSwgb3B0aW9ucyk7CiAgICAgIH0sCgogICAgICAkJGFkZENsYXNzSW1tZWRpYXRlbHkgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIG9wdGlvbnMpIHsKICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwogICAgICAgIGNsYXNzTmFtZSA9ICFpc1N0cmluZyhjbGFzc05hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgID8gKGlzQXJyYXkoY2xhc3NOYW1lKSA/IGNsYXNzTmFtZS5qb2luKCcgJykgOiAnJykKICAgICAgICAgICAgICAgICAgICAgICAgOiBjbGFzc05hbWU7CiAgICAgICAgZm9yRWFjaChlbGVtZW50LCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAganFMaXRlQWRkQ2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICB9KTsKICAgICAgICBhcHBseVN0eWxlcyhlbGVtZW50LCBvcHRpb25zKTsKICAgICAgICByZXR1cm4gYXN5bmNQcm9taXNlKCk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICoKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNyZW1vdmVDbGFzcwogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKiBAZGVzY3JpcHRpb24gUmVtb3ZlcyB0aGUgcHJvdmlkZWQgY2xhc3NOYW1lIENTUyBjbGFzcyB2YWx1ZSBmcm9tIHRoZSBwcm92aWRlZCBlbGVtZW50LgogICAgICAgKiBXaGVuIHRoZSBmdW5jdGlvbiBpcyBjYWxsZWQgYSBwcm9taXNlIGlzIHJldHVybmVkIHRoYXQgd2lsbCBiZSByZXNvbHZlZCBhdCBhIGxhdGVyIHRpbWUuCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGhhdmUgdGhlIGNsYXNzTmFtZSB2YWx1ZQogICAgICAgKiAgIHJlbW92ZWQgZnJvbSBpdAogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIGFuIG9wdGlvbmFsIGNvbGxlY3Rpb24gb2Ygb3B0aW9ucyB0aGF0IHdpbGwgYmUgYXBwbGllZCB0byB0aGUgZWxlbWVudC4KICAgICAgICogQHJldHVybiB7UHJvbWlzZX0gdGhlIGFuaW1hdGlvbiBjYWxsYmFjayBwcm9taXNlCiAgICAgICAqLwogICAgICByZW1vdmVDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgb3B0aW9ucykgewogICAgICAgIHJldHVybiB0aGlzLnNldENsYXNzKGVsZW1lbnQsIFtdLCBjbGFzc05hbWUsIG9wdGlvbnMpOwogICAgICB9LAoKICAgICAgJCRyZW1vdmVDbGFzc0ltbWVkaWF0ZWx5IDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBvcHRpb25zKSB7CiAgICAgICAgZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KTsKICAgICAgICBjbGFzc05hbWUgPSAhaXNTdHJpbmcoY2xhc3NOYW1lKQogICAgICAgICAgICAgICAgICAgICAgICA/IChpc0FycmF5KGNsYXNzTmFtZSkgPyBjbGFzc05hbWUuam9pbignICcpIDogJycpCiAgICAgICAgICAgICAgICAgICAgICAgIDogY2xhc3NOYW1lOwogICAgICAgIGZvckVhY2goZWxlbWVudCwgZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgIGpxTGl0ZVJlbW92ZUNsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgfSk7CiAgICAgICAgYXBwbHlTdHlsZXMoZWxlbWVudCwgb3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIGFzeW5jUHJvbWlzZSgpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGFuaW1hdGUjc2V0Q2xhc3MKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICogQGRlc2NyaXB0aW9uIEFkZHMgYW5kL29yIHJlbW92ZXMgdGhlIGdpdmVuIENTUyBjbGFzc2VzIHRvIGFuZCBmcm9tIHRoZSBlbGVtZW50LgogICAgICAgKiBXaGVuIHRoZSBmdW5jdGlvbiBpcyBjYWxsZWQgYSBwcm9taXNlIGlzIHJldHVybmVkIHRoYXQgd2lsbCBiZSByZXNvbHZlZCBhdCBhIGxhdGVyIHRpbWUuCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGhhdmUgaXRzIENTUyBjbGFzc2VzIGNoYW5nZWQKICAgICAgICogICByZW1vdmVkIGZyb20gaXQKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGFkZCB0aGUgQ1NTIGNsYXNzZXMgd2hpY2ggd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVtb3ZlIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIGFuIG9wdGlvbmFsIGNvbGxlY3Rpb24gb2Ygb3B0aW9ucyB0aGF0IHdpbGwgYmUgYXBwbGllZCB0byB0aGUgZWxlbWVudC4KICAgICAgICogQHJldHVybiB7UHJvbWlzZX0gdGhlIGFuaW1hdGlvbiBjYWxsYmFjayBwcm9taXNlCiAgICAgICAqLwogICAgICBzZXRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGFkZCwgcmVtb3ZlLCBvcHRpb25zKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHZhciBTVE9SQUdFX0tFWSA9ICckJGFuaW1hdGVDbGFzc2VzJzsKICAgICAgICB2YXIgY3JlYXRlZENhY2hlID0gZmFsc2U7CiAgICAgICAgZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KTsKCiAgICAgICAgdmFyIGNhY2hlID0gZWxlbWVudC5kYXRhKFNUT1JBR0VfS0VZKTsKICAgICAgICBpZiAoIWNhY2hlKSB7CiAgICAgICAgICBjYWNoZSA9IHsKICAgICAgICAgICAgY2xhc3Nlczoge30sCiAgICAgICAgICAgIG9wdGlvbnMgOiBvcHRpb25zCiAgICAgICAgICB9OwogICAgICAgICAgY3JlYXRlZENhY2hlID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMgJiYgY2FjaGUub3B0aW9ucykgewogICAgICAgICAgY2FjaGUub3B0aW9ucyA9IGFuZ3VsYXIuZXh0ZW5kKGNhY2hlLm9wdGlvbnMgfHwge30sIG9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGNsYXNzZXMgPSBjYWNoZS5jbGFzc2VzOwoKICAgICAgICBhZGQgPSBpc0FycmF5KGFkZCkgPyBhZGQgOiBhZGQuc3BsaXQoJyAnKTsKICAgICAgICByZW1vdmUgPSBpc0FycmF5KHJlbW92ZSkgPyByZW1vdmUgOiByZW1vdmUuc3BsaXQoJyAnKTsKICAgICAgICBjYWNoZWRDbGFzc01hbmlwdWxhdGlvbihjbGFzc2VzLCBhZGQsIHRydWUpOwogICAgICAgIGNhY2hlZENsYXNzTWFuaXB1bGF0aW9uKGNsYXNzZXMsIHJlbW92ZSwgZmFsc2UpOwoKICAgICAgICBpZiAoY3JlYXRlZENhY2hlKSB7CiAgICAgICAgICBjYWNoZS5wcm9taXNlID0gcnVuQW5pbWF0aW9uUG9zdERpZ2VzdChmdW5jdGlvbihkb25lKSB7CiAgICAgICAgICAgIHZhciBjYWNoZSA9IGVsZW1lbnQuZGF0YShTVE9SQUdFX0tFWSk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRGF0YShTVE9SQUdFX0tFWSk7CgogICAgICAgICAgICAvLyBpbiB0aGUgZXZlbnQgdGhhdCB0aGUgZWxlbWVudCBpcyByZW1vdmVkIGJlZm9yZSBwb3N0RGlnZXN0CiAgICAgICAgICAgIC8vIGlzIHJ1biB0aGVuIHRoZSBjYWNoZSB3aWxsIGJlIHVuZGVmaW5lZCBhbmQgdGhlcmUgd2lsbCBiZQogICAgICAgICAgICAvLyBubyBuZWVkIGFueW1vcmUgdG8gYWRkIG9yIHJlbW92ZSBhbmQgb2YgdGhlIGVsZW1lbnQgY2xhc3NlcwogICAgICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgICAgICB2YXIgY2xhc3NlcyA9IHJlc29sdmVFbGVtZW50Q2xhc3NlcyhlbGVtZW50LCBjYWNoZS5jbGFzc2VzKTsKICAgICAgICAgICAgICBpZiAoY2xhc3NlcykgewogICAgICAgICAgICAgICAgc2VsZi4kJHNldENsYXNzSW1tZWRpYXRlbHkoZWxlbWVudCwgY2xhc3Nlc1swXSwgY2xhc3Nlc1sxXSwgY2FjaGUub3B0aW9ucyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGVsZW1lbnQuZGF0YShTVE9SQUdFX0tFWSwgY2FjaGUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGNhY2hlLnByb21pc2U7CiAgICAgIH0sCgogICAgICAkJHNldENsYXNzSW1tZWRpYXRlbHkgOiBmdW5jdGlvbihlbGVtZW50LCBhZGQsIHJlbW92ZSwgb3B0aW9ucykgewogICAgICAgIGFkZCAmJiB0aGlzLiQkYWRkQ2xhc3NJbW1lZGlhdGVseShlbGVtZW50LCBhZGQpOwogICAgICAgIHJlbW92ZSAmJiB0aGlzLiQkcmVtb3ZlQ2xhc3NJbW1lZGlhdGVseShlbGVtZW50LCByZW1vdmUpOwogICAgICAgIGFwcGx5U3R5bGVzKGVsZW1lbnQsIG9wdGlvbnMpOwogICAgICAgIHJldHVybiBhc3luY1Byb21pc2UoKTsKICAgICAgfSwKCiAgICAgIGVuYWJsZWQgOiBub29wLAogICAgICBjYW5jZWwgOiBub29wCiAgICB9OwogIH1dOwp9XTsKCmZ1bmN0aW9uICQkQXN5bmNDYWxsYmFja1Byb3ZpZGVyKCl7CiAgdGhpcy4kZ2V0ID0gWyckJHJBRicsICckdGltZW91dCcsIGZ1bmN0aW9uKCQkckFGLCAkdGltZW91dCkgewogICAgcmV0dXJuICQkckFGLnN1cHBvcnRlZAogICAgICA/IGZ1bmN0aW9uKGZuKSB7IHJldHVybiAkJHJBRihmbik7IH0KICAgICAgOiBmdW5jdGlvbihmbikgewogICAgICAgIHJldHVybiAkdGltZW91dChmbiwgMCwgZmFsc2UpOwogICAgICB9OwogIH1dOwp9CgovKiBnbG9iYWwgc3RyaXBIYXNoOiB0cnVlICovCgovKioKICogISBUaGlzIGlzIGEgcHJpdmF0ZSB1bmRvY3VtZW50ZWQgc2VydmljZSAhCiAqCiAqIEBuYW1lICRicm93c2VyCiAqIEByZXF1aXJlcyAkbG9nCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIG9iamVjdCBoYXMgdHdvIGdvYWxzOgogKgogKiAtIGhpZGUgYWxsIHRoZSBnbG9iYWwgc3RhdGUgaW4gdGhlIGJyb3dzZXIgY2F1c2VkIGJ5IHRoZSB3aW5kb3cgb2JqZWN0CiAqIC0gYWJzdHJhY3QgYXdheSBhbGwgdGhlIGJyb3dzZXIgc3BlY2lmaWMgZmVhdHVyZXMgYW5kIGluY29uc2lzdGVuY2llcwogKgogKiBGb3IgdGVzdHMgd2UgcHJvdmlkZSB7QGxpbmsgbmdNb2NrLiRicm93c2VyIG1vY2sgaW1wbGVtZW50YXRpb259IG9mIHRoZSBgJGJyb3dzZXJgCiAqIHNlcnZpY2UsIHdoaWNoIGNhbiBiZSB1c2VkIGZvciBjb252ZW5pZW50IHRlc3Rpbmcgb2YgdGhlIGFwcGxpY2F0aW9uIHdpdGhvdXQgdGhlIGludGVyYWN0aW9uIHdpdGgKICogdGhlIHJlYWwgYnJvd3NlciBhcGlzLgogKi8KLyoqCiAqIEBwYXJhbSB7b2JqZWN0fSB3aW5kb3cgVGhlIGdsb2JhbCB3aW5kb3cgb2JqZWN0LgogKiBAcGFyYW0ge29iamVjdH0gZG9jdW1lbnQgalF1ZXJ5IHdyYXBwZWQgZG9jdW1lbnQuCiAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gWEhSIFhNTEh0dHBSZXF1ZXN0IGNvbnN0cnVjdG9yLgogKiBAcGFyYW0ge29iamVjdH0gJGxvZyBjb25zb2xlLmxvZyBvciBhbiBvYmplY3Qgd2l0aCB0aGUgc2FtZSBpbnRlcmZhY2UuCiAqIEBwYXJhbSB7b2JqZWN0fSAkc25pZmZlciAkc25pZmZlciBzZXJ2aWNlCiAqLwpmdW5jdGlvbiBCcm93c2VyKHdpbmRvdywgZG9jdW1lbnQsICRsb2csICRzbmlmZmVyKSB7CiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICByYXdEb2N1bWVudCA9IGRvY3VtZW50WzBdLAogICAgICBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbiwKICAgICAgaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5LAogICAgICBzZXRUaW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQsCiAgICAgIGNsZWFyVGltZW91dCA9IHdpbmRvdy5jbGVhclRpbWVvdXQsCiAgICAgIHBlbmRpbmdEZWZlcklkcyA9IHt9OwoKICBzZWxmLmlzTW9jayA9IGZhbHNlOwoKICB2YXIgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPSAwOwogIHZhciBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MgPSBbXTsKCiAgLy8gVE9ETyh2b2p0YSk6IHJlbW92ZSB0aGlzIHRlbXBvcmFyeSBhcGkKICBzZWxmLiQkY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QgPSBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdDsKICBzZWxmLiQkaW5jT3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPSBmdW5jdGlvbigpIHsgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQrKzsgfTsKCiAgLyoqCiAgICogRXhlY3V0ZXMgdGhlIGBmbmAgZnVuY3Rpb24oc3VwcG9ydHMgY3VycnlpbmcpIGFuZCBkZWNyZW1lbnRzIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYAogICAqIGNvdW50ZXIuIElmIHRoZSBjb3VudGVyIHJlYWNoZXMgMCwgYWxsIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYCBhcmUgZXhlY3V0ZWQuCiAgICovCiAgZnVuY3Rpb24gY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoZm4pIHsKICAgIHRyeSB7CiAgICAgIGZuLmFwcGx5KG51bGwsIHNsaWNlQXJncyhhcmd1bWVudHMsIDEpKTsKICAgIH0gZmluYWxseSB7CiAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENvdW50LS07CiAgICAgIGlmIChvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9PT0gMCkgewogICAgICAgIHdoaWxlKG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5wb3AoKSgpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAkbG9nLmVycm9yKGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgLyoqCiAgICogQHByaXZhdGUKICAgKiBOb3RlOiB0aGlzIG1ldGhvZCBpcyB1c2VkIG9ubHkgYnkgc2NlbmFyaW8gcnVubmVyCiAgICogVE9ETyh2b2p0YSk6IHByZWZpeCB0aGlzIG1ldGhvZCB3aXRoICQkID8KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGNhbGxiYWNrIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiBubyBvdXRzdGFuZGluZyByZXF1ZXN0CiAgICovCiAgc2VsZi5ub3RpZnlXaGVuTm9PdXRzdGFuZGluZ1JlcXVlc3RzID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIC8vIGZvcmNlIGJyb3dzZXIgdG8gZXhlY3V0ZSBhbGwgcG9sbEZucyAtIHRoaXMgaXMgbmVlZGVkIHNvIHRoYXQgY29va2llcyBhbmQgb3RoZXIgcG9sbGVycyBmaXJlCiAgICAvLyBhdCBzb21lIGRldGVybWluaXN0aWMgdGltZSBpbiByZXNwZWN0IHRvIHRoZSB0ZXN0IHJ1bm5lcidzIGFjdGlvbnMuIExlYXZpbmcgdGhpbmdzIHVwIHRvIHRoZQogICAgLy8gcmVndWxhciBwb2xsZXIgd291bGQgcmVzdWx0IGluIGZsYWt5IHRlc3RzLgogICAgZm9yRWFjaChwb2xsRm5zLCBmdW5jdGlvbihwb2xsRm4peyBwb2xsRm4oKTsgfSk7CgogICAgaWYgKG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID09PSAwKSB7CiAgICAgIGNhbGxiYWNrKCk7CiAgICB9IGVsc2UgewogICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgICB9CiAgfTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBQb2xsIFdhdGNoZXIgQVBJCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICB2YXIgcG9sbEZucyA9IFtdLAogICAgICBwb2xsVGltZW91dDsKCiAgLyoqCiAgICogQG5hbWUgJGJyb3dzZXIjYWRkUG9sbEZuCiAgICoKICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIFBvbGwgZnVuY3Rpb24gdG8gYWRkCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBZGRzIGEgZnVuY3Rpb24gdG8gdGhlIGxpc3Qgb2YgZnVuY3Rpb25zIHRoYXQgcG9sbGVyIHBlcmlvZGljYWxseSBleGVjdXRlcywKICAgKiBhbmQgc3RhcnRzIHBvbGxpbmcgaWYgbm90IHN0YXJ0ZWQgeWV0LgogICAqCiAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IHRoZSBhZGRlZCBmdW5jdGlvbgogICAqLwogIHNlbGYuYWRkUG9sbEZuID0gZnVuY3Rpb24oZm4pIHsKICAgIGlmIChpc1VuZGVmaW5lZChwb2xsVGltZW91dCkpIHN0YXJ0UG9sbGVyKDEwMCwgc2V0VGltZW91dCk7CiAgICBwb2xsRm5zLnB1c2goZm4pOwogICAgcmV0dXJuIGZuOwogIH07CgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbnRlcnZhbCBIb3cgb2Z0ZW4gc2hvdWxkIGJyb3dzZXIgY2FsbCBwb2xsIGZ1bmN0aW9ucyAobXMpCiAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBzZXRUaW1lb3V0IFJlZmVyZW5jZSB0byBhIHJlYWwgb3IgZmFrZSBgc2V0VGltZW91dGAgZnVuY3Rpb24uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDb25maWd1cmVzIHRoZSBwb2xsZXIgdG8gcnVuIGluIHRoZSBzcGVjaWZpZWQgaW50ZXJ2YWxzLCB1c2luZyB0aGUgc3BlY2lmaWVkCiAgICogc2V0VGltZW91dCBmbiBhbmQga2lja3MgaXQgb2ZmLgogICAqLwogIGZ1bmN0aW9uIHN0YXJ0UG9sbGVyKGludGVydmFsLCBzZXRUaW1lb3V0KSB7CiAgICAoZnVuY3Rpb24gY2hlY2soKSB7CiAgICAgIGZvckVhY2gocG9sbEZucywgZnVuY3Rpb24ocG9sbEZuKXsgcG9sbEZuKCk7IH0pOwogICAgICBwb2xsVGltZW91dCA9IHNldFRpbWVvdXQoY2hlY2ssIGludGVydmFsKTsKICAgIH0pKCk7CiAgfQoKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIC8vIFVSTCBBUEkKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICB2YXIgY2FjaGVkU3RhdGUsIGxhc3RIaXN0b3J5U3RhdGUsCiAgICAgIGxhc3RCcm93c2VyVXJsID0gbG9jYXRpb24uaHJlZiwKICAgICAgYmFzZUVsZW1lbnQgPSBkb2N1bWVudC5maW5kKCdiYXNlJyksCiAgICAgIHJlbG9hZExvY2F0aW9uID0gbnVsbDsKCiAgY2FjaGVTdGF0ZSgpOwogIGxhc3RIaXN0b3J5U3RhdGUgPSBjYWNoZWRTdGF0ZTsKCiAgLyoqCiAgICogQG5hbWUgJGJyb3dzZXIjdXJsCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBHRVRURVI6CiAgICogV2l0aG91dCBhbnkgYXJndW1lbnQsIHRoaXMgbWV0aG9kIGp1c3QgcmV0dXJucyBjdXJyZW50IHZhbHVlIG9mIGxvY2F0aW9uLmhyZWYuCiAgICoKICAgKiBTRVRURVI6CiAgICogV2l0aCBhdCBsZWFzdCBvbmUgYXJndW1lbnQsIHRoaXMgbWV0aG9kIHNldHMgdXJsIHRvIG5ldyB2YWx1ZS4KICAgKiBJZiBodG1sNSBoaXN0b3J5IGFwaSBzdXBwb3J0ZWQsIHB1c2hTdGF0ZS9yZXBsYWNlU3RhdGUgaXMgdXNlZCwgb3RoZXJ3aXNlCiAgICogbG9jYXRpb24uaHJlZi9sb2NhdGlvbi5yZXBsYWNlIGlzIHVzZWQuCiAgICogUmV0dXJucyBpdHMgb3duIGluc3RhbmNlIHRvIGFsbG93IGNoYWluaW5nCiAgICoKICAgKiBOT1RFOiB0aGlzIGFwaSBpcyBpbnRlbmRlZCBmb3IgdXNlIG9ubHkgYnkgdGhlICRsb2NhdGlvbiBzZXJ2aWNlLiBQbGVhc2UgdXNlIHRoZQogICAqIHtAbGluayBuZy4kbG9jYXRpb24gJGxvY2F0aW9uIHNlcnZpY2V9IHRvIGNoYW5nZSB1cmwuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIE5ldyB1cmwgKHdoZW4gdXNlZCBhcyBzZXR0ZXIpCiAgICogQHBhcmFtIHtib29sZWFuPX0gcmVwbGFjZSBTaG91bGQgbmV3IHVybCByZXBsYWNlIGN1cnJlbnQgaGlzdG9yeSByZWNvcmQ/CiAgICogQHBhcmFtIHtvYmplY3Q9fSBzdGF0ZSBvYmplY3QgdG8gdXNlIHdpdGggcHVzaFN0YXRlL3JlcGxhY2VTdGF0ZQogICAqLwogIHNlbGYudXJsID0gZnVuY3Rpb24odXJsLCByZXBsYWNlLCBzdGF0ZSkgewogICAgLy8gSW4gbW9kZXJuIGJyb3dzZXJzIGBoaXN0b3J5LnN0YXRlYCBpcyBgbnVsbGAgYnkgZGVmYXVsdDsgdHJlYXRpbmcgaXQgc2VwYXJhdGVseQogICAgLy8gZnJvbSBgdW5kZWZpbmVkYCB3b3VsZCBjYXVzZSBgJGJyb3dzZXIudXJsKCcvZm9vJylgIHRvIGNoYW5nZSBgaGlzdG9yeS5zdGF0ZWAKICAgIC8vIHRvIHVuZGVmaW5lZCB2aWEgYHB1c2hTdGF0ZWAuIEluc3RlYWQsIGxldCdzIGNoYW5nZSBgdW5kZWZpbmVkYCB0byBgbnVsbGAgaGVyZS4KICAgIGlmIChpc1VuZGVmaW5lZChzdGF0ZSkpIHsKICAgICAgc3RhdGUgPSBudWxsOwogICAgfQoKICAgIC8vIEFuZHJvaWQgQnJvd3NlciBCRkNhY2hlIGNhdXNlcyBsb2NhdGlvbiwgaGlzdG9yeSByZWZlcmVuY2UgdG8gYmVjb21lIHN0YWxlLgogICAgaWYgKGxvY2F0aW9uICE9PSB3aW5kb3cubG9jYXRpb24pIGxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwogICAgaWYgKGhpc3RvcnkgIT09IHdpbmRvdy5oaXN0b3J5KSBoaXN0b3J5ID0gd2luZG93Lmhpc3Rvcnk7CgogICAgLy8gc2V0dGVyCiAgICBpZiAodXJsKSB7CiAgICAgIHZhciBzYW1lU3RhdGUgPSBsYXN0SGlzdG9yeVN0YXRlID09PSBzdGF0ZTsKCiAgICAgIC8vIERvbid0IGNoYW5nZSBhbnl0aGluZyBpZiBwcmV2aW91cyBhbmQgY3VycmVudCBVUkxzIGFuZCBzdGF0ZXMgbWF0Y2guIFRoaXMgYWxzbyBwcmV2ZW50cwogICAgICAvLyBJRTwxMCBmcm9tIGdldHRpbmcgaW50byByZWRpcmVjdCBsb29wIHdoZW4gaW4gTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmwgbW9kZS4KICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvY29tbWl0L2ZmYjI3MDEKICAgICAgaWYgKGxhc3RCcm93c2VyVXJsID09PSB1cmwgJiYgKCEkc25pZmZlci5oaXN0b3J5IHx8IHNhbWVTdGF0ZSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHNhbWVCYXNlID0gbGFzdEJyb3dzZXJVcmwgJiYgc3RyaXBIYXNoKGxhc3RCcm93c2VyVXJsKSA9PT0gc3RyaXBIYXNoKHVybCk7CiAgICAgIGxhc3RCcm93c2VyVXJsID0gdXJsOwogICAgICBsYXN0SGlzdG9yeVN0YXRlID0gc3RhdGU7CiAgICAgIC8vIERvbid0IHVzZSBoaXN0b3J5IEFQSSBpZiBvbmx5IHRoZSBoYXNoIGNoYW5nZWQKICAgICAgLy8gZHVlIHRvIGEgYnVnIGluIElFMTAvSUUxMSB3aGljaCBsZWFkcwogICAgICAvLyB0byBub3QgZmlyaW5nIGEgYGhhc2hjaGFuZ2VgIG5vciBgcG9wc3RhdGVgIGV2ZW50CiAgICAgIC8vIGluIHNvbWUgY2FzZXMgKHNlZSAjOTE0MykuCiAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5ICYmICghc2FtZUJhc2UgfHwgIXNhbWVTdGF0ZSkpIHsKICAgICAgICBoaXN0b3J5W3JlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXShzdGF0ZSwgJycsIHVybCk7CiAgICAgICAgY2FjaGVTdGF0ZSgpOwogICAgICAgIC8vIERvIHRoZSBhc3NpZ25tZW50IGFnYWluIHNvIHRoYXQgdGhvc2UgdHdvIHZhcmlhYmxlcyBhcmUgcmVmZXJlbnRpYWxseSBpZGVudGljYWwuCiAgICAgICAgbGFzdEhpc3RvcnlTdGF0ZSA9IGNhY2hlZFN0YXRlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghc2FtZUJhc2UpIHsKICAgICAgICAgIHJlbG9hZExvY2F0aW9uID0gdXJsOwogICAgICAgIH0KICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgbG9jYXRpb24ucmVwbGFjZSh1cmwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsb2NhdGlvbi5ocmVmID0gdXJsOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gc2VsZjsKICAgIC8vIGdldHRlcgogICAgfSBlbHNlIHsKICAgICAgLy8gLSByZWxvYWRMb2NhdGlvbiBpcyBuZWVkZWQgYXMgYnJvd3NlcnMgZG9uJ3QgYWxsb3cgdG8gcmVhZCBvdXQKICAgICAgLy8gICB0aGUgbmV3IGxvY2F0aW9uLmhyZWYgaWYgYSByZWxvYWQgaGFwcGVuZWQuCiAgICAgIC8vIC0gdGhlIHJlcGxhY2VtZW50IGlzIGEgd29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NDA3MTcyCiAgICAgIHJldHVybiByZWxvYWRMb2NhdGlvbiB8fCBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyUyNy9nLCInIik7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQG5hbWUgJGJyb3dzZXIjc3RhdGUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGEgZ2V0dGVyLgogICAqCiAgICogUmV0dXJuIGhpc3Rvcnkuc3RhdGUgb3IgbnVsbCBpZiBoaXN0b3J5LnN0YXRlIGlzIHVuZGVmaW5lZC4KICAgKgogICAqIEByZXR1cm5zIHtvYmplY3R9IHN0YXRlCiAgICovCiAgc2VsZi5zdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNhY2hlZFN0YXRlOwogIH07CgogIHZhciB1cmxDaGFuZ2VMaXN0ZW5lcnMgPSBbXSwKICAgICAgdXJsQ2hhbmdlSW5pdCA9IGZhbHNlOwoKICBmdW5jdGlvbiBjYWNoZVN0YXRlQW5kRmlyZVVybENoYW5nZSgpIHsKICAgIGNhY2hlU3RhdGUoKTsKICAgIGZpcmVVcmxDaGFuZ2UoKTsKICB9CgogIC8vIFRoaXMgdmFyaWFibGUgc2hvdWxkIGJlIHVzZWQgKm9ubHkqIGluc2lkZSB0aGUgY2FjaGVTdGF0ZSBmdW5jdGlvbi4KICB2YXIgbGFzdENhY2hlZFN0YXRlID0gbnVsbDsKICBmdW5jdGlvbiBjYWNoZVN0YXRlKCkgewogICAgLy8gVGhpcyBzaG91bGQgYmUgdGhlIG9ubHkgcGxhY2UgaW4gJGJyb3dzZXIgd2hlcmUgYGhpc3Rvcnkuc3RhdGVgIGlzIHJlYWQuCiAgICBjYWNoZWRTdGF0ZSA9IHdpbmRvdy5oaXN0b3J5LnN0YXRlOwogICAgY2FjaGVkU3RhdGUgPSBpc1VuZGVmaW5lZChjYWNoZWRTdGF0ZSkgPyBudWxsIDogY2FjaGVkU3RhdGU7CgogICAgLy8gUHJldmVudCBjYWxsYmFja3MgZm8gZmlyZSB0d2ljZSBpZiBib3RoIGhhc2hjaGFuZ2UgJiBwb3BzdGF0ZSB3ZXJlIGZpcmVkLgogICAgaWYgKGVxdWFscyhjYWNoZWRTdGF0ZSwgbGFzdENhY2hlZFN0YXRlKSkgewogICAgICBjYWNoZWRTdGF0ZSA9IGxhc3RDYWNoZWRTdGF0ZTsKICAgIH0KICAgIGxhc3RDYWNoZWRTdGF0ZSA9IGNhY2hlZFN0YXRlOwogIH0KCiAgZnVuY3Rpb24gZmlyZVVybENoYW5nZSgpIHsKICAgIGlmIChsYXN0QnJvd3NlclVybCA9PT0gc2VsZi51cmwoKSAmJiBsYXN0SGlzdG9yeVN0YXRlID09PSBjYWNoZWRTdGF0ZSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgbGFzdEJyb3dzZXJVcmwgPSBzZWxmLnVybCgpOwogICAgbGFzdEhpc3RvcnlTdGF0ZSA9IGNhY2hlZFN0YXRlOwogICAgZm9yRWFjaCh1cmxDaGFuZ2VMaXN0ZW5lcnMsIGZ1bmN0aW9uKGxpc3RlbmVyKSB7CiAgICAgIGxpc3RlbmVyKHNlbGYudXJsKCksIGNhY2hlZFN0YXRlKTsKICAgIH0pOwogIH0KCiAgLyoqCiAgICogQG5hbWUgJGJyb3dzZXIjb25VcmxDaGFuZ2UKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJlZ2lzdGVyIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQsIHdoZW4gdXJsIGNoYW5nZXMuCiAgICoKICAgKiBJdCdzIG9ubHkgY2FsbGVkIHdoZW4gdGhlIHVybCBpcyBjaGFuZ2VkIGZyb20gb3V0c2lkZSBvZiBhbmd1bGFyOgogICAqIC0gdXNlciB0eXBlcyBkaWZmZXJlbnQgdXJsIGludG8gYWRkcmVzcyBiYXIKICAgKiAtIHVzZXIgY2xpY2tzIG9uIGhpc3RvcnkgKGZvcndhcmQvYmFjaykgYnV0dG9uCiAgICogLSB1c2VyIGNsaWNrcyBvbiBhIGxpbmsKICAgKgogICAqIEl0J3Mgbm90IGNhbGxlZCB3aGVuIHVybCBpcyBjaGFuZ2VkIGJ5ICRicm93c2VyLnVybCgpIG1ldGhvZAogICAqCiAgICogVGhlIGxpc3RlbmVyIGdldHMgY2FsbGVkIHdpdGggbmV3IHVybCBhcyBwYXJhbWV0ZXIuCiAgICoKICAgKiBOT1RFOiB0aGlzIGFwaSBpcyBpbnRlbmRlZCBmb3IgdXNlIG9ubHkgYnkgdGhlICRsb2NhdGlvbiBzZXJ2aWNlLiBQbGVhc2UgdXNlIHRoZQogICAqIHtAbGluayBuZy4kbG9jYXRpb24gJGxvY2F0aW9uIHNlcnZpY2V9IHRvIG1vbml0b3IgdXJsIGNoYW5nZXMgaW4gYW5ndWxhciBhcHBzLgogICAqCiAgICogQHBhcmFtIHtmdW5jdGlvbihzdHJpbmcpfSBsaXN0ZW5lciBMaXN0ZW5lciBmdW5jdGlvbiB0byBiZSBjYWxsZWQgd2hlbiB1cmwgY2hhbmdlcy4KICAgKiBAcmV0dXJuIHtmdW5jdGlvbihzdHJpbmcpfSBSZXR1cm5zIHRoZSByZWdpc3RlcmVkIGxpc3RlbmVyIGZuIC0gaGFuZHkgaWYgdGhlIGZuIGlzIGFub255bW91cy4KICAgKi8KICBzZWxmLm9uVXJsQ2hhbmdlID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIC8vIFRPRE8odm9qdGEpOiByZWZhY3RvciB0byB1c2Ugbm9kZSdzIHN5bnRheCBmb3IgZXZlbnRzCiAgICBpZiAoIXVybENoYW5nZUluaXQpIHsKICAgICAgLy8gV2UgbGlzdGVuIG9uIGJvdGggKGhhc2hjaGFuZ2UvcG9wc3RhdGUpIHdoZW4gYXZhaWxhYmxlLCBhcyBzb21lIGJyb3dzZXJzIChlLmcuIE9wZXJhKQogICAgICAvLyBkb24ndCBmaXJlIHBvcHN0YXRlIHdoZW4gdXNlciBjaGFuZ2UgdGhlIGFkZHJlc3MgYmFyIGFuZCBkb24ndCBmaXJlIGhhc2hjaGFuZ2Ugd2hlbiB1cmwKICAgICAgLy8gY2hhbmdlZCBieSBwdXNoL3JlcGxhY2VTdGF0ZQoKICAgICAgLy8gaHRtbDUgaGlzdG9yeSBhcGkgLSBwb3BzdGF0ZSBldmVudAogICAgICBpZiAoJHNuaWZmZXIuaGlzdG9yeSkganFMaXRlKHdpbmRvdykub24oJ3BvcHN0YXRlJywgY2FjaGVTdGF0ZUFuZEZpcmVVcmxDaGFuZ2UpOwogICAgICAvLyBoYXNoY2hhbmdlIGV2ZW50CiAgICAgIGpxTGl0ZSh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgY2FjaGVTdGF0ZUFuZEZpcmVVcmxDaGFuZ2UpOwoKICAgICAgdXJsQ2hhbmdlSW5pdCA9IHRydWU7CiAgICB9CgogICAgdXJsQ2hhbmdlTGlzdGVuZXJzLnB1c2goY2FsbGJhY2spOwogICAgcmV0dXJuIGNhbGxiYWNrOwogIH07CgogIC8qKgogICAqIENoZWNrcyB3aGV0aGVyIHRoZSB1cmwgaGFzIGNoYW5nZWQgb3V0c2lkZSBvZiBBbmd1bGFyLgogICAqIE5lZWRzIHRvIGJlIGV4cG9ydGVkIHRvIGJlIGFibGUgdG8gY2hlY2sgZm9yIGNoYW5nZXMgdGhhdCBoYXZlIGJlZW4gZG9uZSBpbiBzeW5jLAogICAqIGFzIGhhc2hjaGFuZ2UvcG9wc3RhdGUgZXZlbnRzIGZpcmUgaW4gYXN5bmMuCiAgICovCiAgc2VsZi4kJGNoZWNrVXJsQ2hhbmdlID0gZmlyZVVybENoYW5nZTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBNaXNjIEFQSQogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogIC8qKgogICAqIEBuYW1lICRicm93c2VyI2Jhc2VIcmVmCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZXR1cm5zIGN1cnJlbnQgPGJhc2UgaHJlZj4KICAgKiAoYWx3YXlzIHJlbGF0aXZlIC0gd2l0aG91dCBkb21haW4pCiAgICoKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgY3VycmVudCBiYXNlIGhyZWYKICAgKi8KICBzZWxmLmJhc2VIcmVmID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgaHJlZiA9IGJhc2VFbGVtZW50LmF0dHIoJ2hyZWYnKTsKICAgIHJldHVybiBocmVmID8gaHJlZi5yZXBsYWNlKC9eKGh0dHBzP1w6KT9cL1wvW15cL10qLywgJycpIDogJyc7CiAgfTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBDb29raWVzIEFQSQogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgdmFyIGxhc3RDb29raWVzID0ge307CiAgdmFyIGxhc3RDb29raWVTdHJpbmcgPSAnJzsKICB2YXIgY29va2llUGF0aCA9IHNlbGYuYmFzZUhyZWYoKTsKCiAgZnVuY3Rpb24gc2FmZURlY29kZVVSSUNvbXBvbmVudChzdHIpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQoc3RyKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIHN0cjsKICAgIH0KICB9CgogIC8qKgogICAqIEBuYW1lICRicm93c2VyI2Nvb2tpZXMKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBDb29raWUgbmFtZQogICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgQ29va2llIHZhbHVlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgY29va2llcyBtZXRob2QgcHJvdmlkZXMgYSAncHJpdmF0ZScgbG93IGxldmVsIGFjY2VzcyB0byBicm93c2VyIGNvb2tpZXMuCiAgICogSXQgaXMgbm90IG1lYW50IHRvIGJlIHVzZWQgZGlyZWN0bHksIHVzZSB0aGUgJGNvb2tpZSBzZXJ2aWNlIGluc3RlYWQuCiAgICoKICAgKiBUaGUgcmV0dXJuIHZhbHVlcyB2YXJ5IGRlcGVuZGluZyBvbiB0aGUgYXJndW1lbnRzIHRoYXQgdGhlIG1ldGhvZCB3YXMgY2FsbGVkIHdpdGggYXMgZm9sbG93czoKICAgKgogICAqIC0gY29va2llcygpIC0+IGhhc2ggb2YgYWxsIGNvb2tpZXMsIHRoaXMgaXMgTk9UIGEgY29weSBvZiB0aGUgaW50ZXJuYWwgc3RhdGUsIHNvIGRvIG5vdCBtb2RpZnkKICAgKiAgIGl0CiAgICogLSBjb29raWVzKG5hbWUsIHZhbHVlKSAtPiBzZXQgbmFtZSB0byB2YWx1ZSwgaWYgdmFsdWUgaXMgdW5kZWZpbmVkIGRlbGV0ZSB0aGUgY29va2llCiAgICogLSBjb29raWVzKG5hbWUpIC0+IHRoZSBzYW1lIGFzIChuYW1lLCB1bmRlZmluZWQpID09IERFTEVURVMgKG5vIG9uZSBjYWxscyBpdCByaWdodCBub3cgdGhhdAogICAqICAgd2F5KQogICAqCiAgICogQHJldHVybnMge09iamVjdH0gSGFzaCBvZiBhbGwgY29va2llcyAoaWYgY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlcikKICAgKi8KICBzZWxmLmNvb2tpZXMgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgdmFyIGNvb2tpZUxlbmd0aCwgY29va2llQXJyYXksIGNvb2tpZSwgaSwgaW5kZXg7CgogICAgaWYgKG5hbWUpIHsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICByYXdEb2N1bWVudC5jb29raWUgPSBlbmNvZGVVUklDb21wb25lbnQobmFtZSkgKyAiPTtwYXRoPSIgKyBjb29raWVQYXRoICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiO2V4cGlyZXM9VGh1LCAwMSBKYW4gMTk3MCAwMDowMDowMCBHTVQiOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgIGNvb2tpZUxlbmd0aCA9IChyYXdEb2N1bWVudC5jb29raWUgPSBlbmNvZGVVUklDb21wb25lbnQobmFtZSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnO3BhdGg9JyArIGNvb2tpZVBhdGgpLmxlbmd0aCArIDE7CgogICAgICAgICAgLy8gcGVyIGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzIxMDkudHh0IGJyb3dzZXIgbXVzdCBhbGxvdyBhdCBtaW5pbXVtOgogICAgICAgICAgLy8gLSAzMDAgY29va2llcwogICAgICAgICAgLy8gLSAyMCBjb29raWVzIHBlciB1bmlxdWUgZG9tYWluCiAgICAgICAgICAvLyAtIDQwOTYgYnl0ZXMgcGVyIGNvb2tpZQogICAgICAgICAgaWYgKGNvb2tpZUxlbmd0aCA+IDQwOTYpIHsKICAgICAgICAgICAgJGxvZy53YXJuKCJDb29raWUgJyIrIG5hbWUgKwogICAgICAgICAgICAgICInIHBvc3NpYmx5IG5vdCBzZXQgb3Igb3ZlcmZsb3dlZCBiZWNhdXNlIGl0IHdhcyB0b28gbGFyZ2UgKCIrCiAgICAgICAgICAgICAgY29va2llTGVuZ3RoICsgIiA+IDQwOTYgYnl0ZXMpISIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKHJhd0RvY3VtZW50LmNvb2tpZSAhPT0gbGFzdENvb2tpZVN0cmluZykgewogICAgICAgIGxhc3RDb29raWVTdHJpbmcgPSByYXdEb2N1bWVudC5jb29raWU7CiAgICAgICAgY29va2llQXJyYXkgPSBsYXN0Q29va2llU3RyaW5nLnNwbGl0KCI7ICIpOwogICAgICAgIGxhc3RDb29raWVzID0ge307CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb29raWVBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29va2llID0gY29va2llQXJyYXlbaV07CiAgICAgICAgICBpbmRleCA9IGNvb2tpZS5pbmRleE9mKCc9Jyk7CiAgICAgICAgICBpZiAoaW5kZXggPiAwKSB7IC8vaWdub3JlIG5hbWVsZXNzIGNvb2tpZXMKICAgICAgICAgICAgbmFtZSA9IHNhZmVEZWNvZGVVUklDb21wb25lbnQoY29va2llLnN1YnN0cmluZygwLCBpbmRleCkpOwogICAgICAgICAgICAvLyB0aGUgZmlyc3QgdmFsdWUgdGhhdCBpcyBzZWVuIGZvciBhIGNvb2tpZSBpcyB0aGUgbW9zdAogICAgICAgICAgICAvLyBzcGVjaWZpYyBvbmUuICB2YWx1ZXMgZm9yIHRoZSBzYW1lIGNvb2tpZSBuYW1lIHRoYXQKICAgICAgICAgICAgLy8gZm9sbG93IGFyZSBmb3IgbGVzcyBzcGVjaWZpYyBwYXRocy4KICAgICAgICAgICAgaWYgKGxhc3RDb29raWVzW25hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBsYXN0Q29va2llc1tuYW1lXSA9IHNhZmVEZWNvZGVVUklDb21wb25lbnQoY29va2llLnN1YnN0cmluZyhpbmRleCArIDEpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbGFzdENvb2tpZXM7CiAgICB9CiAgfTsKCgogIC8qKgogICAqIEBuYW1lICRicm93c2VyI2RlZmVyCiAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBBIGZ1bmN0aW9uLCB3aG8ncyBleGVjdXRpb24gc2hvdWxkIGJlIGRlZmVycmVkLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIG9mIG1pbGxpc2Vjb25kcyB0byBkZWZlciB0aGUgZnVuY3Rpb24gZXhlY3V0aW9uLgogICAqIEByZXR1cm5zIHsqfSBEZWZlcklkIHRoYXQgY2FuIGJlIHVzZWQgdG8gY2FuY2VsIHRoZSB0YXNrIHZpYSBgJGJyb3dzZXIuZGVmZXIuY2FuY2VsKClgLgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRXhlY3V0ZXMgYSBmbiBhc3luY2hyb25vdXNseSB2aWEgYHNldFRpbWVvdXQoZm4sIGRlbGF5KWAuCiAgICoKICAgKiBVbmxpa2Ugd2hlbiBjYWxsaW5nIGBzZXRUaW1lb3V0YCBkaXJlY3RseSwgaW4gdGVzdCB0aGlzIGZ1bmN0aW9uIGlzIG1vY2tlZCBhbmQgaW5zdGVhZCBvZiB1c2luZwogICAqIGBzZXRUaW1lb3V0YCBpbiB0ZXN0cywgdGhlIGZucyBhcmUgcXVldWVkIGluIGFuIGFycmF5LCB3aGljaCBjYW4gYmUgcHJvZ3JhbW1hdGljYWxseSBmbHVzaGVkCiAgICogdmlhIGAkYnJvd3Nlci5kZWZlci5mbHVzaCgpYC4KICAgKgogICAqLwogIHNlbGYuZGVmZXIgPSBmdW5jdGlvbihmbiwgZGVsYXkpIHsKICAgIHZhciB0aW1lb3V0SWQ7CiAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCsrOwogICAgdGltZW91dElkID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgZGVsZXRlIHBlbmRpbmdEZWZlcklkc1t0aW1lb3V0SWRdOwogICAgICBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChmbik7CiAgICB9LCBkZWxheSB8fCAwKTsKICAgIHBlbmRpbmdEZWZlcklkc1t0aW1lb3V0SWRdID0gdHJ1ZTsKICAgIHJldHVybiB0aW1lb3V0SWQ7CiAgfTsKCgogIC8qKgogICAqIEBuYW1lICRicm93c2VyI2RlZmVyLmNhbmNlbAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2FuY2VscyBhIGRlZmVycmVkIHRhc2sgaWRlbnRpZmllZCB3aXRoIGBkZWZlcklkYC4KICAgKgogICAqIEBwYXJhbSB7Kn0gZGVmZXJJZCBUb2tlbiByZXR1cm5lZCBieSB0aGUgYCRicm93c2VyLmRlZmVyYCBmdW5jdGlvbi4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHRhc2sgaGFzbid0IGV4ZWN1dGVkIHlldCBhbmQgd2FzIHN1Y2Nlc3NmdWxseQogICAqICAgICAgICAgICAgICAgICAgICBjYW5jZWxlZC4KICAgKi8KICBzZWxmLmRlZmVyLmNhbmNlbCA9IGZ1bmN0aW9uKGRlZmVySWQpIHsKICAgIGlmIChwZW5kaW5nRGVmZXJJZHNbZGVmZXJJZF0pIHsKICAgICAgZGVsZXRlIHBlbmRpbmdEZWZlcklkc1tkZWZlcklkXTsKICAgICAgY2xlYXJUaW1lb3V0KGRlZmVySWQpOwogICAgICBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChub29wKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfTsKCn0KCmZ1bmN0aW9uICRCcm93c2VyUHJvdmlkZXIoKXsKICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJGxvZycsICckc25pZmZlcicsICckZG9jdW1lbnQnLAogICAgICBmdW5jdGlvbiggJHdpbmRvdywgICAkbG9nLCAgICRzbmlmZmVyLCAgICRkb2N1bWVudCl7CiAgICAgICAgcmV0dXJuIG5ldyBCcm93c2VyKCR3aW5kb3csICRkb2N1bWVudCwgJGxvZywgJHNuaWZmZXIpOwogICAgICB9XTsKfQoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRjYWNoZUZhY3RvcnkKICoKICogQGRlc2NyaXB0aW9uCiAqIEZhY3RvcnkgdGhhdCBjb25zdHJ1Y3RzIHtAbGluayAkY2FjaGVGYWN0b3J5LkNhY2hlIENhY2hlfSBvYmplY3RzIGFuZCBnaXZlcyBhY2Nlc3MgdG8KICogdGhlbS4KICoKICogYGBganMKICoKICogIHZhciBjYWNoZSA9ICRjYWNoZUZhY3RvcnkoJ2NhY2hlSWQnKTsKICogIGV4cGVjdCgkY2FjaGVGYWN0b3J5LmdldCgnY2FjaGVJZCcpKS50b0JlKGNhY2hlKTsKICogIGV4cGVjdCgkY2FjaGVGYWN0b3J5LmdldCgnbm9TdWNoQ2FjaGVJZCcpKS5ub3QudG9CZURlZmluZWQoKTsKICoKICogIGNhY2hlLnB1dCgia2V5IiwgInZhbHVlIik7CiAqICBjYWNoZS5wdXQoImFub3RoZXIga2V5IiwgImFub3RoZXIgdmFsdWUiKTsKICoKICogIC8vIFdlJ3ZlIHNwZWNpZmllZCBubyBvcHRpb25zIG9uIGNyZWF0aW9uCiAqICBleHBlY3QoY2FjaGUuaW5mbygpKS50b0VxdWFsKHtpZDogJ2NhY2hlSWQnLCBzaXplOiAyfSk7CiAqCiAqIGBgYAogKgogKgogKiBAcGFyYW0ge3N0cmluZ30gY2FjaGVJZCBOYW1lIG9yIGlkIG9mIHRoZSBuZXdseSBjcmVhdGVkIGNhY2hlLgogKiBAcGFyYW0ge29iamVjdD19IG9wdGlvbnMgT3B0aW9ucyBvYmplY3QgdGhhdCBzcGVjaWZpZXMgdGhlIGNhY2hlIGJlaGF2aW9yLiBQcm9wZXJ0aWVzOgogKgogKiAgIC0gYHtudW1iZXI9fWAgYGNhcGFjaXR5YCDigJQgdHVybnMgdGhlIGNhY2hlIGludG8gTFJVIGNhY2hlLgogKgogKiBAcmV0dXJucyB7b2JqZWN0fSBOZXdseSBjcmVhdGVkIGNhY2hlIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcgc2V0IG9mIG1ldGhvZHM6CiAqCiAqIC0gYHtvYmplY3R9YCBgaW5mbygpYCDigJQgUmV0dXJucyBpZCwgc2l6ZSwgYW5kIG9wdGlvbnMgb2YgY2FjaGUuCiAqIC0gYHt7Kn19YCBgcHV0KHtzdHJpbmd9IGtleSwgeyp9IHZhbHVlKWAg4oCUIFB1dHMgYSBuZXcga2V5LXZhbHVlIHBhaXIgaW50byB0aGUgY2FjaGUgYW5kIHJldHVybnMKICogICBpdC4KICogLSBge3sqfX1gIGBnZXQoe3N0cmluZ30ga2V5KWAg4oCUIFJldHVybnMgY2FjaGVkIHZhbHVlIGZvciBga2V5YCBvciB1bmRlZmluZWQgZm9yIGNhY2hlIG1pc3MuCiAqIC0gYHt2b2lkfWAgYHJlbW92ZSh7c3RyaW5nfSBrZXkpYCDigJQgUmVtb3ZlcyBhIGtleS12YWx1ZSBwYWlyIGZyb20gdGhlIGNhY2hlLgogKiAtIGB7dm9pZH1gIGByZW1vdmVBbGwoKWAg4oCUIFJlbW92ZXMgYWxsIGNhY2hlZCB2YWx1ZXMuCiAqIC0gYHt2b2lkfWAgYGRlc3Ryb3koKWAg4oCUIFJlbW92ZXMgcmVmZXJlbmNlcyB0byB0aGlzIGNhY2hlIGZyb20gJGNhY2hlRmFjdG9yeS4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJjYWNoZUV4YW1wbGVBcHAiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDYWNoZUNvbnRyb2xsZXIiPgogICAgICAgICA8aW5wdXQgbmctbW9kZWw9Im5ld0NhY2hlS2V5IiBwbGFjZWhvbGRlcj0iS2V5Ij4KICAgICAgICAgPGlucHV0IG5nLW1vZGVsPSJuZXdDYWNoZVZhbHVlIiBwbGFjZWhvbGRlcj0iVmFsdWUiPgogICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJwdXQobmV3Q2FjaGVLZXksIG5ld0NhY2hlVmFsdWUpIj5DYWNoZTwvYnV0dG9uPgoKICAgICAgICAgPHAgbmctaWY9ImtleXMubGVuZ3RoIj5DYWNoZWQgVmFsdWVzPC9wPgogICAgICAgICA8ZGl2IG5nLXJlcGVhdD0ia2V5IGluIGtleXMiPgogICAgICAgICAgIDxzcGFuIG5nLWJpbmQ9ImtleSI+PC9zcGFuPgogICAgICAgICAgIDxzcGFuPjogPC9zcGFuPgogICAgICAgICAgIDxiIG5nLWJpbmQ9ImNhY2hlLmdldChrZXkpIj48L2I+CiAgICAgICAgIDwvZGl2PgoKICAgICAgICAgPHA+Q2FjaGUgSW5mbzwvcD4KICAgICAgICAgPGRpdiBuZy1yZXBlYXQ9IihrZXksIHZhbHVlKSBpbiBjYWNoZS5pbmZvKCkiPgogICAgICAgICAgIDxzcGFuIG5nLWJpbmQ9ImtleSI+PC9zcGFuPgogICAgICAgICAgIDxzcGFuPjogPC9zcGFuPgogICAgICAgICAgIDxiIG5nLWJpbmQ9InZhbHVlIj48L2I+CiAgICAgICAgIDwvZGl2PgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgICBhbmd1bGFyLm1vZHVsZSgnY2FjaGVFeGFtcGxlQXBwJywgW10pLgogICAgICAgICBjb250cm9sbGVyKCdDYWNoZUNvbnRyb2xsZXInLCBbJyRzY29wZScsICckY2FjaGVGYWN0b3J5JywgZnVuY3Rpb24oJHNjb3BlLCAkY2FjaGVGYWN0b3J5KSB7CiAgICAgICAgICAgJHNjb3BlLmtleXMgPSBbXTsKICAgICAgICAgICAkc2NvcGUuY2FjaGUgPSAkY2FjaGVGYWN0b3J5KCdjYWNoZUlkJyk7CiAgICAgICAgICAgJHNjb3BlLnB1dCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgIGlmICgkc2NvcGUuY2FjaGUuZ2V0KGtleSkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAkc2NvcGUua2V5cy5wdXNoKGtleSk7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgICAkc2NvcGUuY2FjaGUucHV0KGtleSwgdmFsdWUgPT09IHVuZGVmaW5lZCA/IG51bGwgOiB2YWx1ZSk7CiAgICAgICAgICAgfTsKICAgICAgICAgfV0pOwogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgcCB7CiAgICAgICAgIG1hcmdpbjogMTBweCAwIDNweDsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmZ1bmN0aW9uICRDYWNoZUZhY3RvcnlQcm92aWRlcigpIHsKCiAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgY2FjaGVzID0ge307CgogICAgZnVuY3Rpb24gY2FjaGVGYWN0b3J5KGNhY2hlSWQsIG9wdGlvbnMpIHsKICAgICAgaWYgKGNhY2hlSWQgaW4gY2FjaGVzKSB7CiAgICAgICAgdGhyb3cgbWluRXJyKCckY2FjaGVGYWN0b3J5JykoJ2lpZCcsICJDYWNoZUlkICd7MH0nIGlzIGFscmVhZHkgdGFrZW4hIiwgY2FjaGVJZCk7CiAgICAgIH0KCiAgICAgIHZhciBzaXplID0gMCwKICAgICAgICAgIHN0YXRzID0gZXh0ZW5kKHt9LCBvcHRpb25zLCB7aWQ6IGNhY2hlSWR9KSwKICAgICAgICAgIGRhdGEgPSB7fSwKICAgICAgICAgIGNhcGFjaXR5ID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5jYXBhY2l0eSkgfHwgTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICAgIGxydUhhc2ggPSB7fSwKICAgICAgICAgIGZyZXNoRW5kID0gbnVsbCwKICAgICAgICAgIHN0YWxlRW5kID0gbnVsbDsKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgdHlwZQogICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5LkNhY2hlCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBBIGNhY2hlIG9iamVjdCB1c2VkIHRvIHN0b3JlIGFuZCByZXRyaWV2ZSBkYXRhLCBwcmltYXJpbHkgdXNlZCBieQogICAgICAgKiB7QGxpbmsgJGh0dHAgJGh0dHB9IGFuZCB0aGUge0BsaW5rIG5nLmRpcmVjdGl2ZTpzY3JpcHQgc2NyaXB0fSBkaXJlY3RpdmUgdG8gY2FjaGUKICAgICAgICogdGVtcGxhdGVzIGFuZCBvdGhlciBkYXRhLgogICAgICAgKgogICAgICAgKiBgYGBqcwogICAgICAgKiAgYW5ndWxhci5tb2R1bGUoJ3N1cGVyQ2FjaGUnKQogICAgICAgKiAgICAuZmFjdG9yeSgnc3VwZXJDYWNoZScsIFsnJGNhY2hlRmFjdG9yeScsIGZ1bmN0aW9uKCRjYWNoZUZhY3RvcnkpIHsKICAgICAgICogICAgICByZXR1cm4gJGNhY2hlRmFjdG9yeSgnc3VwZXItY2FjaGUnKTsKICAgICAgICogICAgfV0pOwogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICogRXhhbXBsZSB0ZXN0OgogICAgICAgKgogICAgICAgKiBgYGBqcwogICAgICAgKiAgaXQoJ3Nob3VsZCBiZWhhdmUgbGlrZSBhIGNhY2hlJywgaW5qZWN0KGZ1bmN0aW9uKHN1cGVyQ2FjaGUpIHsKICAgICAgICogICAgc3VwZXJDYWNoZS5wdXQoJ2tleScsICd2YWx1ZScpOwogICAgICAgKiAgICBzdXBlckNhY2hlLnB1dCgnYW5vdGhlciBrZXknLCAnYW5vdGhlciB2YWx1ZScpOwogICAgICAgKgogICAgICAgKiAgICBleHBlY3Qoc3VwZXJDYWNoZS5pbmZvKCkpLnRvRXF1YWwoewogICAgICAgKiAgICAgIGlkOiAnc3VwZXItY2FjaGUnLAogICAgICAgKiAgICAgIHNpemU6IDIKICAgICAgICogICAgfSk7CiAgICAgICAqCiAgICAgICAqICAgIHN1cGVyQ2FjaGUucmVtb3ZlKCdhbm90aGVyIGtleScpOwogICAgICAgKiAgICBleHBlY3Qoc3VwZXJDYWNoZS5nZXQoJ2Fub3RoZXIga2V5JykpLnRvQmVVbmRlZmluZWQoKTsKICAgICAgICoKICAgICAgICogICAgc3VwZXJDYWNoZS5yZW1vdmVBbGwoKTsKICAgICAgICogICAgZXhwZWN0KHN1cGVyQ2FjaGUuaW5mbygpKS50b0VxdWFsKHsKICAgICAgICogICAgICBpZDogJ3N1cGVyLWNhY2hlJywKICAgICAgICogICAgICBzaXplOiAwCiAgICAgICAqICAgIH0pOwogICAgICAgKiAgfSkpOwogICAgICAgKiBgYGAKICAgICAgICovCiAgICAgIHJldHVybiBjYWNoZXNbY2FjaGVJZF0gPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5LkNhY2hlI3B1dAogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBJbnNlcnRzIGEgbmFtZWQgZW50cnkgaW50byB0aGUge0BsaW5rICRjYWNoZUZhY3RvcnkuQ2FjaGUgQ2FjaGV9IG9iamVjdCB0byBiZQogICAgICAgICAqIHJldHJpZXZlZCBsYXRlciwgYW5kIGluY3JlbWVudGluZyB0aGUgc2l6ZSBvZiB0aGUgY2FjaGUgaWYgdGhlIGtleSB3YXMgbm90IGFscmVhZHkKICAgICAgICAgKiBwcmVzZW50IGluIHRoZSBjYWNoZS4gSWYgYmVoYXZpbmcgbGlrZSBhbiBMUlUgY2FjaGUsIGl0IHdpbGwgYWxzbyByZW1vdmUgc3RhbGUKICAgICAgICAgKiBlbnRyaWVzIGZyb20gdGhlIHNldC4KICAgICAgICAgKgogICAgICAgICAqIEl0IHdpbGwgbm90IGluc2VydCB1bmRlZmluZWQgdmFsdWVzIGludG8gdGhlIGNhY2hlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSB0aGUga2V5IHVuZGVyIHdoaWNoIHRoZSBjYWNoZWQgZGF0YSBpcyBzdG9yZWQuCiAgICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSB0aGUgdmFsdWUgdG8gc3RvcmUgYWxvbmdzaWRlIHRoZSBrZXkuIElmIGl0IGlzIHVuZGVmaW5lZCwgdGhlIGtleQogICAgICAgICAqICAgIHdpbGwgbm90IGJlIHN0b3JlZC4KICAgICAgICAgKiBAcmV0dXJucyB7Kn0gdGhlIHZhbHVlIHN0b3JlZC4KICAgICAgICAgKi8KICAgICAgICBwdXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgIGlmIChjYXBhY2l0eSA8IE51bWJlci5NQVhfVkFMVUUpIHsKICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldIHx8IChscnVIYXNoW2tleV0gPSB7a2V5OiBrZXl9KTsKCiAgICAgICAgICAgIHJlZnJlc2gobHJ1RW50cnkpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHJldHVybjsKICAgICAgICAgIGlmICghKGtleSBpbiBkYXRhKSkgc2l6ZSsrOwogICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CgogICAgICAgICAgaWYgKHNpemUgPiBjYXBhY2l0eSkgewogICAgICAgICAgICB0aGlzLnJlbW92ZShzdGFsZUVuZC5rZXkpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZSNnZXQKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogUmV0cmlldmVzIG5hbWVkIGRhdGEgc3RvcmVkIGluIHRoZSB7QGxpbmsgJGNhY2hlRmFjdG9yeS5DYWNoZSBDYWNoZX0gb2JqZWN0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSB0aGUga2V5IG9mIHRoZSBkYXRhIHRvIGJlIHJldHJpZXZlZAogICAgICAgICAqIEByZXR1cm5zIHsqfSB0aGUgdmFsdWUgc3RvcmVkLgogICAgICAgICAqLwogICAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBpZiAoY2FwYWNpdHkgPCBOdW1iZXIuTUFYX1ZBTFVFKSB7CiAgICAgICAgICAgIHZhciBscnVFbnRyeSA9IGxydUhhc2hba2V5XTsKCiAgICAgICAgICAgIGlmICghbHJ1RW50cnkpIHJldHVybjsKCiAgICAgICAgICAgIHJlZnJlc2gobHJ1RW50cnkpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBkYXRhW2tleV07CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5LkNhY2hlI3JlbW92ZQogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZW1vdmVzIGFuIGVudHJ5IGZyb20gdGhlIHtAbGluayAkY2FjaGVGYWN0b3J5LkNhY2hlIENhY2hlfSBvYmplY3QuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IHRoZSBrZXkgb2YgdGhlIGVudHJ5IHRvIGJlIHJlbW92ZWQKICAgICAgICAgKi8KICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgaWYgKGNhcGFjaXR5IDwgTnVtYmVyLk1BWF9WQUxVRSkgewogICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICBpZiAobHJ1RW50cnkgPT0gZnJlc2hFbmQpIGZyZXNoRW5kID0gbHJ1RW50cnkucDsKICAgICAgICAgICAgaWYgKGxydUVudHJ5ID09IHN0YWxlRW5kKSBzdGFsZUVuZCA9IGxydUVudHJ5Lm47CiAgICAgICAgICAgIGxpbmsobHJ1RW50cnkubixscnVFbnRyeS5wKTsKCiAgICAgICAgICAgIGRlbGV0ZSBscnVIYXNoW2tleV07CiAgICAgICAgICB9CgogICAgICAgICAgZGVsZXRlIGRhdGFba2V5XTsKICAgICAgICAgIHNpemUtLTsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUjcmVtb3ZlQWxsCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENsZWFycyB0aGUgY2FjaGUgb2JqZWN0IG9mIGFueSBlbnRyaWVzLgogICAgICAgICAqLwogICAgICAgIHJlbW92ZUFsbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICBkYXRhID0ge307CiAgICAgICAgICBzaXplID0gMDsKICAgICAgICAgIGxydUhhc2ggPSB7fTsKICAgICAgICAgIGZyZXNoRW5kID0gc3RhbGVFbmQgPSBudWxsOwogICAgICAgIH0sCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZSNkZXN0cm95CiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIERlc3Ryb3lzIHRoZSB7QGxpbmsgJGNhY2hlRmFjdG9yeS5DYWNoZSBDYWNoZX0gb2JqZWN0IGVudGlyZWx5LAogICAgICAgICAqIHJlbW92aW5nIGl0IGZyb20gdGhlIHtAbGluayAkY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9IHNldC4KICAgICAgICAgKi8KICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgIGRhdGEgPSBudWxsOwogICAgICAgICAgc3RhdHMgPSBudWxsOwogICAgICAgICAgbHJ1SGFzaCA9IG51bGw7CiAgICAgICAgICBkZWxldGUgY2FjaGVzW2NhY2hlSWRdOwogICAgICAgIH0sCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZSNpbmZvCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJldHJpZXZlIGluZm9ybWF0aW9uIHJlZ2FyZGluZyBhIHBhcnRpY3VsYXIge0BsaW5rICRjYWNoZUZhY3RvcnkuQ2FjaGUgQ2FjaGV9LgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge29iamVjdH0gYW4gb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICAgICAqICAgPHVsPgogICAgICAgICAqICAgICA8bGk+KippZCoqOiB0aGUgaWQgb2YgdGhlIGNhY2hlIGluc3RhbmNlPC9saT4KICAgICAgICAgKiAgICAgPGxpPioqc2l6ZSoqOiB0aGUgbnVtYmVyIG9mIGVudHJpZXMga2VwdCBpbiB0aGUgY2FjaGUgaW5zdGFuY2U8L2xpPgogICAgICAgICAqICAgICA8bGk+KiouLi4qKjogYW55IGFkZGl0aW9uYWwgcHJvcGVydGllcyBmcm9tIHRoZSBvcHRpb25zIG9iamVjdCB3aGVuIGNyZWF0aW5nIHRoZQogICAgICAgICAqICAgICAgIGNhY2hlLjwvbGk+CiAgICAgICAgICogICA8L3VsPgogICAgICAgICAqLwogICAgICAgIGluZm86IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIGV4dGVuZCh7fSwgc3RhdHMsIHtzaXplOiBzaXplfSk7CiAgICAgICAgfQogICAgICB9OwoKCiAgICAgIC8qKgogICAgICAgKiBtYWtlcyB0aGUgYGVudHJ5YCB0aGUgZnJlc2hFbmQgb2YgdGhlIExSVSBsaW5rZWQgbGlzdAogICAgICAgKi8KICAgICAgZnVuY3Rpb24gcmVmcmVzaChlbnRyeSkgewogICAgICAgIGlmIChlbnRyeSAhPSBmcmVzaEVuZCkgewogICAgICAgICAgaWYgKCFzdGFsZUVuZCkgewogICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5OwogICAgICAgICAgfSBlbHNlIGlmIChzdGFsZUVuZCA9PSBlbnRyeSkgewogICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5Lm47CiAgICAgICAgICB9CgogICAgICAgICAgbGluayhlbnRyeS5uLCBlbnRyeS5wKTsKICAgICAgICAgIGxpbmsoZW50cnksIGZyZXNoRW5kKTsKICAgICAgICAgIGZyZXNoRW5kID0gZW50cnk7CiAgICAgICAgICBmcmVzaEVuZC5uID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KCgogICAgICAvKioKICAgICAgICogYmlkaXJlY3Rpb25hbGx5IGxpbmtzIHR3byBlbnRyaWVzIG9mIHRoZSBMUlUgbGlua2VkIGxpc3QKICAgICAgICovCiAgICAgIGZ1bmN0aW9uIGxpbmsobmV4dEVudHJ5LCBwcmV2RW50cnkpIHsKICAgICAgICBpZiAobmV4dEVudHJ5ICE9IHByZXZFbnRyeSkgewogICAgICAgICAgaWYgKG5leHRFbnRyeSkgbmV4dEVudHJ5LnAgPSBwcmV2RW50cnk7IC8vcCBzdGFuZHMgZm9yIHByZXZpb3VzLCAncHJldicgZGlkbid0IG1pbmlmeQogICAgICAgICAgaWYgKHByZXZFbnRyeSkgcHJldkVudHJ5Lm4gPSBuZXh0RW50cnk7IC8vbiBzdGFuZHMgZm9yIG5leHQsICduZXh0JyBkaWRuJ3QgbWluaWZ5CiAgICAgICAgfQogICAgICB9CiAgICB9CgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGNhY2hlRmFjdG9yeSNpbmZvCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBHZXQgaW5mb3JtYXRpb24gYWJvdXQgYWxsIHRoZSBjYWNoZXMgdGhhdCBoYXZlIGJlZW4gY3JlYXRlZAogICAqCiAgICogQHJldHVybnMge09iamVjdH0gLSBrZXktdmFsdWUgbWFwIG9mIGBjYWNoZUlkYCB0byB0aGUgcmVzdWx0IG9mIGNhbGxpbmcgYGNhY2hlI2luZm9gCiAgICovCiAgICBjYWNoZUZhY3RvcnkuaW5mbyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaW5mbyA9IHt9OwogICAgICBmb3JFYWNoKGNhY2hlcywgZnVuY3Rpb24oY2FjaGUsIGNhY2hlSWQpIHsKICAgICAgICBpbmZvW2NhY2hlSWRdID0gY2FjaGUuaW5mbygpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGluZm87CiAgICB9OwoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRjYWNoZUZhY3RvcnkjZ2V0CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBHZXQgYWNjZXNzIHRvIGEgY2FjaGUgb2JqZWN0IGJ5IHRoZSBgY2FjaGVJZGAgdXNlZCB3aGVuIGl0IHdhcyBjcmVhdGVkLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlSWQgTmFtZSBvciBpZCBvZiBhIGNhY2hlIHRvIGFjY2Vzcy4KICAgKiBAcmV0dXJucyB7b2JqZWN0fSBDYWNoZSBvYmplY3QgaWRlbnRpZmllZCBieSB0aGUgY2FjaGVJZCBvciB1bmRlZmluZWQgaWYgbm8gc3VjaCBjYWNoZS4KICAgKi8KICAgIGNhY2hlRmFjdG9yeS5nZXQgPSBmdW5jdGlvbihjYWNoZUlkKSB7CiAgICAgIHJldHVybiBjYWNoZXNbY2FjaGVJZF07CiAgICB9OwoKCiAgICByZXR1cm4gY2FjaGVGYWN0b3J5OwogIH07Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkdGVtcGxhdGVDYWNoZQogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGZpcnN0IHRpbWUgYSB0ZW1wbGF0ZSBpcyB1c2VkLCBpdCBpcyBsb2FkZWQgaW4gdGhlIHRlbXBsYXRlIGNhY2hlIGZvciBxdWljayByZXRyaWV2YWwuIFlvdQogKiBjYW4gbG9hZCB0ZW1wbGF0ZXMgZGlyZWN0bHkgaW50byB0aGUgY2FjaGUgaW4gYSBgc2NyaXB0YCB0YWcsIG9yIGJ5IGNvbnN1bWluZyB0aGUKICogYCR0ZW1wbGF0ZUNhY2hlYCBzZXJ2aWNlIGRpcmVjdGx5LgogKgogKiBBZGRpbmcgdmlhIHRoZSBgc2NyaXB0YCB0YWc6CiAqCiAqIGBgYGh0bWwKICogICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSJ0ZW1wbGF0ZUlkLmh0bWwiPgogKiAgICAgPHA+VGhpcyBpcyB0aGUgY29udGVudCBvZiB0aGUgdGVtcGxhdGU8L3A+CiAqICAgPC9zY3JpcHQ+CiAqIGBgYAogKgogKiAqKk5vdGU6KiogdGhlIGBzY3JpcHRgIHRhZyBjb250YWluaW5nIHRoZSB0ZW1wbGF0ZSBkb2VzIG5vdCBuZWVkIHRvIGJlIGluY2x1ZGVkIGluIHRoZSBgaGVhZGAgb2YKICogdGhlIGRvY3VtZW50LCBidXQgaXQgbXVzdCBiZSBiZWxvdyB0aGUgYG5nLWFwcGAgZGVmaW5pdGlvbi4KICoKICogQWRkaW5nIHZpYSB0aGUgJHRlbXBsYXRlQ2FjaGUgc2VydmljZToKICoKICogYGBganMKICogdmFyIG15QXBwID0gYW5ndWxhci5tb2R1bGUoJ215QXBwJywgW10pOwogKiBteUFwcC5ydW4oZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKICogICAkdGVtcGxhdGVDYWNoZS5wdXQoJ3RlbXBsYXRlSWQuaHRtbCcsICdUaGlzIGlzIHRoZSBjb250ZW50IG9mIHRoZSB0ZW1wbGF0ZScpOwogKiB9KTsKICogYGBgCiAqCiAqIFRvIHJldHJpZXZlIHRoZSB0ZW1wbGF0ZSBsYXRlciwgc2ltcGx5IHVzZSBpdCBpbiB5b3VyIEhUTUw6CiAqIGBgYGh0bWwKICogPGRpdiBuZy1pbmNsdWRlPSIgJ3RlbXBsYXRlSWQuaHRtbCcgIj48L2Rpdj4KICogYGBgCiAqCiAqIG9yIGdldCBpdCB2aWEgSmF2YXNjcmlwdDoKICogYGBganMKICogJHRlbXBsYXRlQ2FjaGUuZ2V0KCd0ZW1wbGF0ZUlkLmh0bWwnKQogKiBgYGAKICoKICogU2VlIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9LgogKgogKi8KZnVuY3Rpb24gJFRlbXBsYXRlQ2FjaGVQcm92aWRlcigpIHsKICB0aGlzLiRnZXQgPSBbJyRjYWNoZUZhY3RvcnknLCBmdW5jdGlvbigkY2FjaGVGYWN0b3J5KSB7CiAgICByZXR1cm4gJGNhY2hlRmFjdG9yeSgndGVtcGxhdGVzJyk7CiAgfV07Cn0KCi8qICEgVkFSSUFCTEUvRlVOQ1RJT04gTkFNSU5HIENPTlZFTlRJT05TIFRIQVQgQVBQTFkgVE8gVEhJUyBGSUxFIQogKgogKiBET00tcmVsYXRlZCB2YXJpYWJsZXM6CiAqCiAqIC0gIm5vZGUiIC0gRE9NIE5vZGUKICogLSAiZWxlbWVudCIgLSBET00gRWxlbWVudCBvciBOb2RlCiAqIC0gIiRub2RlIiBvciAiJGVsZW1lbnQiIC0ganFMaXRlLXdyYXBwZWQgbm9kZSBvciBlbGVtZW50CiAqCiAqCiAqIENvbXBpbGVyIHJlbGF0ZWQgc3R1ZmY6CiAqCiAqIC0gImxpbmtGbiIgLSBsaW5raW5nIGZuIG9mIGEgc2luZ2xlIGRpcmVjdGl2ZQogKiAtICJub2RlTGlua0ZuIiAtIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGEgcGFydGljdWxhciBub2RlCiAqIC0gImNoaWxkTGlua0ZuIiAtICBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBjaGlsZCBub2RlcyBvZiBhIHBhcnRpY3VsYXIgbm9kZQogKiAtICJjb21wb3NpdGVMaW5rRm4iIC0gZnVuY3Rpb24gdGhhdCBhZ2dyZWdhdGVzIGFsbCBsaW5raW5nIGZucyBmb3IgYSBjb21waWxhdGlvbiByb290IChub2RlTGlzdCkKICovCgoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRjb21waWxlCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDb21waWxlcyBhbiBIVE1MIHN0cmluZyBvciBET00gaW50byBhIHRlbXBsYXRlIGFuZCBwcm9kdWNlcyBhIHRlbXBsYXRlIGZ1bmN0aW9uLCB3aGljaAogKiBjYW4gdGhlbiBiZSB1c2VkIHRvIGxpbmsge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgYHNjb3BlYH0gYW5kIHRoZSB0ZW1wbGF0ZSB0b2dldGhlci4KICoKICogVGhlIGNvbXBpbGF0aW9uIGlzIGEgcHJvY2VzcyBvZiB3YWxraW5nIHRoZSBET00gdHJlZSBhbmQgbWF0Y2hpbmcgRE9NIGVsZW1lbnRzIHRvCiAqIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4KICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAqICoqTm90ZToqKiBUaGlzIGRvY3VtZW50IGlzIGFuIGluLWRlcHRoIHJlZmVyZW5jZSBvZiBhbGwgZGlyZWN0aXZlIG9wdGlvbnMuCiAqIEZvciBhIGdlbnRsZSBpbnRyb2R1Y3Rpb24gdG8gZGlyZWN0aXZlcyB3aXRoIGV4YW1wbGVzIG9mIGNvbW1vbiB1c2UgY2FzZXMsCiAqIHNlZSB0aGUge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSBkaXJlY3RpdmUgZ3VpZGV9LgogKiA8L2Rpdj4KICoKICogIyMgQ29tcHJlaGVuc2l2ZSBEaXJlY3RpdmUgQVBJCiAqCiAqIFRoZXJlIGFyZSBtYW55IGRpZmZlcmVudCBvcHRpb25zIGZvciBhIGRpcmVjdGl2ZS4KICoKICogVGhlIGRpZmZlcmVuY2UgcmVzaWRlcyBpbiB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmYWN0b3J5IGZ1bmN0aW9uLgogKiBZb3UgY2FuIGVpdGhlciByZXR1cm4gYSAiRGlyZWN0aXZlIERlZmluaXRpb24gT2JqZWN0IiAoc2VlIGJlbG93KSB0aGF0IGRlZmluZXMgdGhlIGRpcmVjdGl2ZSBwcm9wZXJ0aWVzLAogKiBvciBqdXN0IHRoZSBgcG9zdExpbmtgIGZ1bmN0aW9uIChhbGwgb3RoZXIgcHJvcGVydGllcyB3aWxsIGhhdmUgdGhlIGRlZmF1bHQgdmFsdWVzKS4KICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtc3VjY2VzcyI+CiAqICoqQmVzdCBQcmFjdGljZToqKiBJdCdzIHJlY29tbWVuZGVkIHRvIHVzZSB0aGUgImRpcmVjdGl2ZSBkZWZpbml0aW9uIG9iamVjdCIgZm9ybS4KICogPC9kaXY+CiAqCiAqIEhlcmUncyBhbiBleGFtcGxlIGRpcmVjdGl2ZSBkZWNsYXJlZCB3aXRoIGEgRGlyZWN0aXZlIERlZmluaXRpb24gT2JqZWN0OgogKgogKiBgYGBqcwogKiAgIHZhciBteU1vZHVsZSA9IGFuZ3VsYXIubW9kdWxlKC4uLik7CiAqCiAqICAgbXlNb2R1bGUuZGlyZWN0aXZlKCdkaXJlY3RpdmVOYW1lJywgZnVuY3Rpb24gZmFjdG9yeShpbmplY3RhYmxlcykgewogKiAgICAgdmFyIGRpcmVjdGl2ZURlZmluaXRpb25PYmplY3QgPSB7CiAqICAgICAgIHByaW9yaXR5OiAwLAogKiAgICAgICB0ZW1wbGF0ZTogJzxkaXY+PC9kaXY+JywgLy8gb3IgLy8gZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgeyAuLi4gfSwKICogICAgICAgLy8gb3IKICogICAgICAgLy8gdGVtcGxhdGVVcmw6ICdkaXJlY3RpdmUuaHRtbCcsIC8vIG9yIC8vIGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsgLi4uIH0sCiAqICAgICAgIHRyYW5zY2x1ZGU6IGZhbHNlLAogKiAgICAgICByZXN0cmljdDogJ0EnLAogKiAgICAgICB0ZW1wbGF0ZU5hbWVzcGFjZTogJ2h0bWwnLAogKiAgICAgICBzY29wZTogZmFsc2UsCiAqICAgICAgIGNvbnRyb2xsZXI6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgJHRyYW5zY2x1ZGUsIG90aGVySW5qZWN0YWJsZXMpIHsgLi4uIH0sCiAqICAgICAgIGNvbnRyb2xsZXJBczogJ3N0cmluZ0FsaWFzJywKICogICAgICAgcmVxdWlyZTogJ3NpYmxpbmdEaXJlY3RpdmVOYW1lJywgLy8gb3IgLy8gWydecGFyZW50RGlyZWN0aXZlTmFtZScsICc/b3B0aW9uYWxEaXJlY3RpdmVOYW1lJywgJz9eb3B0aW9uYWxQYXJlbnQnXSwKICogICAgICAgY29tcGlsZTogZnVuY3Rpb24gY29tcGlsZSh0RWxlbWVudCwgdEF0dHJzLCB0cmFuc2NsdWRlKSB7CiAqICAgICAgICAgcmV0dXJuIHsKICogICAgICAgICAgIHByZTogZnVuY3Rpb24gcHJlTGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycywgY29udHJvbGxlcikgeyAuLi4gfSwKICogICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzLCBjb250cm9sbGVyKSB7IC4uLiB9CiAqICAgICAgICAgfQogKiAgICAgICAgIC8vIG9yCiAqICAgICAgICAgLy8gcmV0dXJuIGZ1bmN0aW9uIHBvc3RMaW5rKCAuLi4gKSB7IC4uLiB9CiAqICAgICAgIH0sCiAqICAgICAgIC8vIG9yCiAqICAgICAgIC8vIGxpbms6IHsKICogICAgICAgLy8gIHByZTogZnVuY3Rpb24gcHJlTGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycywgY29udHJvbGxlcikgeyAuLi4gfSwKICogICAgICAgLy8gIHBvc3Q6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzLCBjb250cm9sbGVyKSB7IC4uLiB9CiAqICAgICAgIC8vIH0KICogICAgICAgLy8gb3IKICogICAgICAgLy8gbGluazogZnVuY3Rpb24gcG9zdExpbmsoIC4uLiApIHsgLi4uIH0KICogICAgIH07CiAqICAgICByZXR1cm4gZGlyZWN0aXZlRGVmaW5pdGlvbk9iamVjdDsKICogICB9KTsKICogYGBgCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKk5vdGU6KiogQW55IHVuc3BlY2lmaWVkIG9wdGlvbnMgd2lsbCB1c2UgdGhlIGRlZmF1bHQgdmFsdWUuIFlvdSBjYW4gc2VlIHRoZSBkZWZhdWx0IHZhbHVlcyBiZWxvdy4KICogPC9kaXY+CiAqCiAqIFRoZXJlZm9yZSB0aGUgYWJvdmUgY2FuIGJlIHNpbXBsaWZpZWQgYXM6CiAqCiAqIGBgYGpzCiAqICAgdmFyIG15TW9kdWxlID0gYW5ndWxhci5tb2R1bGUoLi4uKTsKICoKICogICBteU1vZHVsZS5kaXJlY3RpdmUoJ2RpcmVjdGl2ZU5hbWUnLCBmdW5jdGlvbiBmYWN0b3J5KGluamVjdGFibGVzKSB7CiAqICAgICB2YXIgZGlyZWN0aXZlRGVmaW5pdGlvbk9iamVjdCA9IHsKICogICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMpIHsgLi4uIH0KICogICAgIH07CiAqICAgICByZXR1cm4gZGlyZWN0aXZlRGVmaW5pdGlvbk9iamVjdDsKICogICAgIC8vIG9yCiAqICAgICAvLyByZXR1cm4gZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMpIHsgLi4uIH0KICogICB9KTsKICogYGBgCiAqCiAqCiAqCiAqICMjIyBEaXJlY3RpdmUgRGVmaW5pdGlvbiBPYmplY3QKICoKICogVGhlIGRpcmVjdGl2ZSBkZWZpbml0aW9uIG9iamVjdCBwcm92aWRlcyBpbnN0cnVjdGlvbnMgdG8gdGhlIHtAbGluayBuZy4kY29tcGlsZQogKiBjb21waWxlcn0uIFRoZSBhdHRyaWJ1dGVzIGFyZToKICoKICogIyMjIyBgbXVsdGlFbGVtZW50YAogKiBXaGVuIHRoaXMgcHJvcGVydHkgaXMgc2V0IHRvIHRydWUsIHRoZSBIVE1MIGNvbXBpbGVyIHdpbGwgY29sbGVjdCBET00gbm9kZXMgYmV0d2VlbgogKiBub2RlcyB3aXRoIHRoZSBhdHRyaWJ1dGVzIGBkaXJlY3RpdmUtbmFtZS1zdGFydGAgYW5kIGBkaXJlY3RpdmUtbmFtZS1lbmRgLCBhbmQgZ3JvdXAgdGhlbQogKiB0b2dldGhlciBhcyB0aGUgZGlyZWN0aXZlIGVsZW1lbnRzLiBJdCBpcyByZWNvbWVuZGVkIHRoYXQgdGhpcyBmZWF0dXJlIGJlIHVzZWQgb24gZGlyZWN0aXZlcwogKiB3aGljaCBhcmUgbm90IHN0cmljdGx5IGJlaGF2aW91cmFsIChzdWNoIGFzIHtAbGluayBuZ0NsaWNrfSksIGFuZCB3aGljaAogKiBkbyBub3QgbWFuaXB1bGF0ZSBvciByZXBsYWNlIGNoaWxkIG5vZGVzIChzdWNoIGFzIHtAbGluayBuZ0luY2x1ZGV9KS4KICoKICogIyMjIyBgcHJpb3JpdHlgCiAqIFdoZW4gdGhlcmUgYXJlIG11bHRpcGxlIGRpcmVjdGl2ZXMgZGVmaW5lZCBvbiBhIHNpbmdsZSBET00gZWxlbWVudCwgc29tZXRpbWVzIGl0CiAqIGlzIG5lY2Vzc2FyeSB0byBzcGVjaWZ5IHRoZSBvcmRlciBpbiB3aGljaCB0aGUgZGlyZWN0aXZlcyBhcmUgYXBwbGllZC4gVGhlIGBwcmlvcml0eWAgaXMgdXNlZAogKiB0byBzb3J0IHRoZSBkaXJlY3RpdmVzIGJlZm9yZSB0aGVpciBgY29tcGlsZWAgZnVuY3Rpb25zIGdldCBjYWxsZWQuIFByaW9yaXR5IGlzIGRlZmluZWQgYXMgYQogKiBudW1iZXIuIERpcmVjdGl2ZXMgd2l0aCBncmVhdGVyIG51bWVyaWNhbCBgcHJpb3JpdHlgIGFyZSBjb21waWxlZCBmaXJzdC4gUHJlLWxpbmsgZnVuY3Rpb25zCiAqIGFyZSBhbHNvIHJ1biBpbiBwcmlvcml0eSBvcmRlciwgYnV0IHBvc3QtbGluayBmdW5jdGlvbnMgYXJlIHJ1biBpbiByZXZlcnNlIG9yZGVyLiBUaGUgb3JkZXIKICogb2YgZGlyZWN0aXZlcyB3aXRoIHRoZSBzYW1lIHByaW9yaXR5IGlzIHVuZGVmaW5lZC4gVGhlIGRlZmF1bHQgcHJpb3JpdHkgaXMgYDBgLgogKgogKiAjIyMjIGB0ZXJtaW5hbGAKICogSWYgc2V0IHRvIHRydWUgdGhlbiB0aGUgY3VycmVudCBgcHJpb3JpdHlgIHdpbGwgYmUgdGhlIGxhc3Qgc2V0IG9mIGRpcmVjdGl2ZXMKICogd2hpY2ggd2lsbCBleGVjdXRlIChhbnkgZGlyZWN0aXZlcyBhdCB0aGUgY3VycmVudCBwcmlvcml0eSB3aWxsIHN0aWxsIGV4ZWN1dGUKICogYXMgdGhlIG9yZGVyIG9mIGV4ZWN1dGlvbiBvbiBzYW1lIGBwcmlvcml0eWAgaXMgdW5kZWZpbmVkKS4gTm90ZSB0aGF0IGV4cHJlc3Npb25zCiAqIGFuZCBvdGhlciBkaXJlY3RpdmVzIHVzZWQgaW4gdGhlIGRpcmVjdGl2ZSdzIHRlbXBsYXRlIHdpbGwgYWxzbyBiZSBleGNsdWRlZCBmcm9tIGV4ZWN1dGlvbi4KICoKICogIyMjIyBgc2NvcGVgCiAqICoqSWYgc2V0IHRvIGB0cnVlYCwqKiB0aGVuIGEgbmV3IHNjb3BlIHdpbGwgYmUgY3JlYXRlZCBmb3IgdGhpcyBkaXJlY3RpdmUuIElmIG11bHRpcGxlIGRpcmVjdGl2ZXMgb24gdGhlCiAqIHNhbWUgZWxlbWVudCByZXF1ZXN0IGEgbmV3IHNjb3BlLCBvbmx5IG9uZSBuZXcgc2NvcGUgaXMgY3JlYXRlZC4gVGhlIG5ldyBzY29wZSBydWxlIGRvZXMgbm90CiAqIGFwcGx5IGZvciB0aGUgcm9vdCBvZiB0aGUgdGVtcGxhdGUgc2luY2UgdGhlIHJvb3Qgb2YgdGhlIHRlbXBsYXRlIGFsd2F5cyBnZXRzIGEgbmV3IHNjb3BlLgogKgogKiAqKklmIHNldCB0byBge31gIChvYmplY3QgaGFzaCksKiogdGhlbiBhIG5ldyAiaXNvbGF0ZSIgc2NvcGUgaXMgY3JlYXRlZC4gVGhlICdpc29sYXRlJyBzY29wZSBkaWZmZXJzIGZyb20KICogbm9ybWFsIHNjb3BlIGluIHRoYXQgaXQgZG9lcyBub3QgcHJvdG90eXBpY2FsbHkgaW5oZXJpdCBmcm9tIHRoZSBwYXJlbnQgc2NvcGUuIFRoaXMgaXMgdXNlZnVsCiAqIHdoZW4gY3JlYXRpbmcgcmV1c2FibGUgY29tcG9uZW50cywgd2hpY2ggc2hvdWxkIG5vdCBhY2NpZGVudGFsbHkgcmVhZCBvciBtb2RpZnkgZGF0YSBpbiB0aGUKICogcGFyZW50IHNjb3BlLgogKgogKiBUaGUgJ2lzb2xhdGUnIHNjb3BlIHRha2VzIGFuIG9iamVjdCBoYXNoIHdoaWNoIGRlZmluZXMgYSBzZXQgb2YgbG9jYWwgc2NvcGUgcHJvcGVydGllcwogKiBkZXJpdmVkIGZyb20gdGhlIHBhcmVudCBzY29wZS4gVGhlc2UgbG9jYWwgcHJvcGVydGllcyBhcmUgdXNlZnVsIGZvciBhbGlhc2luZyB2YWx1ZXMgZm9yCiAqIHRlbXBsYXRlcy4gTG9jYWxzIGRlZmluaXRpb24gaXMgYSBoYXNoIG9mIGxvY2FsIHNjb3BlIHByb3BlcnR5IHRvIGl0cyBzb3VyY2U6CiAqCiAqICogYEBgIG9yIGBAYXR0cmAgLSBiaW5kIGEgbG9jYWwgc2NvcGUgcHJvcGVydHkgdG8gdGhlIHZhbHVlIG9mIERPTSBhdHRyaWJ1dGUuIFRoZSByZXN1bHQgaXMKICogICBhbHdheXMgYSBzdHJpbmcgc2luY2UgRE9NIGF0dHJpYnV0ZXMgYXJlIHN0cmluZ3MuIElmIG5vIGBhdHRyYCBuYW1lIGlzIHNwZWNpZmllZCAgdGhlbiB0aGUKICogICBhdHRyaWJ1dGUgbmFtZSBpcyBhc3N1bWVkIHRvIGJlIHRoZSBzYW1lIGFzIHRoZSBsb2NhbCBuYW1lLgogKiAgIEdpdmVuIGA8d2lkZ2V0IG15LWF0dHI9ImhlbGxvIHt7bmFtZX19Ij5gIGFuZCB3aWRnZXQgZGVmaW5pdGlvbgogKiAgIG9mIGBzY29wZTogeyBsb2NhbE5hbWU6J0BteUF0dHInIH1gLCB0aGVuIHdpZGdldCBzY29wZSBwcm9wZXJ0eSBgbG9jYWxOYW1lYCB3aWxsIHJlZmxlY3QKICogICB0aGUgaW50ZXJwb2xhdGVkIHZhbHVlIG9mIGBoZWxsbyB7e25hbWV9fWAuIEFzIHRoZSBgbmFtZWAgYXR0cmlidXRlIGNoYW5nZXMgc28gd2lsbCB0aGUKICogICBgbG9jYWxOYW1lYCBwcm9wZXJ0eSBvbiB0aGUgd2lkZ2V0IHNjb3BlLiBUaGUgYG5hbWVgIGlzIHJlYWQgZnJvbSB0aGUgcGFyZW50IHNjb3BlIChub3QKICogICBjb21wb25lbnQgc2NvcGUpLgogKgogKiAqIGA9YCBvciBgPWF0dHJgIC0gc2V0IHVwIGJpLWRpcmVjdGlvbmFsIGJpbmRpbmcgYmV0d2VlbiBhIGxvY2FsIHNjb3BlIHByb3BlcnR5IGFuZCB0aGUKICogICBwYXJlbnQgc2NvcGUgcHJvcGVydHkgb2YgbmFtZSBkZWZpbmVkIHZpYSB0aGUgdmFsdWUgb2YgdGhlIGBhdHRyYCBhdHRyaWJ1dGUuIElmIG5vIGBhdHRyYAogKiAgIG5hbWUgaXMgc3BlY2lmaWVkIHRoZW4gdGhlIGF0dHJpYnV0ZSBuYW1lIGlzIGFzc3VtZWQgdG8gYmUgdGhlIHNhbWUgYXMgdGhlIGxvY2FsIG5hbWUuCiAqICAgR2l2ZW4gYDx3aWRnZXQgbXktYXR0cj0icGFyZW50TW9kZWwiPmAgYW5kIHdpZGdldCBkZWZpbml0aW9uIG9mCiAqICAgYHNjb3BlOiB7IGxvY2FsTW9kZWw6Jz1teUF0dHInIH1gLCB0aGVuIHdpZGdldCBzY29wZSBwcm9wZXJ0eSBgbG9jYWxNb2RlbGAgd2lsbCByZWZsZWN0IHRoZQogKiAgIHZhbHVlIG9mIGBwYXJlbnRNb2RlbGAgb24gdGhlIHBhcmVudCBzY29wZS4gQW55IGNoYW5nZXMgdG8gYHBhcmVudE1vZGVsYCB3aWxsIGJlIHJlZmxlY3RlZAogKiAgIGluIGBsb2NhbE1vZGVsYCBhbmQgYW55IGNoYW5nZXMgaW4gYGxvY2FsTW9kZWxgIHdpbGwgcmVmbGVjdCBpbiBgcGFyZW50TW9kZWxgLiBJZiB0aGUgcGFyZW50CiAqICAgc2NvcGUgcHJvcGVydHkgZG9lc24ndCBleGlzdCwgaXQgd2lsbCB0aHJvdyBhIE5PTl9BU1NJR05BQkxFX01PREVMX0VYUFJFU1NJT04gZXhjZXB0aW9uLiBZb3UKICogICBjYW4gYXZvaWQgdGhpcyBiZWhhdmlvciB1c2luZyBgPT9gIG9yIGA9P2F0dHJgIGluIG9yZGVyIHRvIGZsYWcgdGhlIHByb3BlcnR5IGFzIG9wdGlvbmFsLgogKgogKiAqIGAmYCBvciBgJmF0dHJgIC0gcHJvdmlkZXMgYSB3YXkgdG8gZXhlY3V0ZSBhbiBleHByZXNzaW9uIGluIHRoZSBjb250ZXh0IG9mIHRoZSBwYXJlbnQgc2NvcGUuCiAqICAgSWYgbm8gYGF0dHJgIG5hbWUgaXMgc3BlY2lmaWVkIHRoZW4gdGhlIGF0dHJpYnV0ZSBuYW1lIGlzIGFzc3VtZWQgdG8gYmUgdGhlIHNhbWUgYXMgdGhlCiAqICAgbG9jYWwgbmFtZS4gR2l2ZW4gYDx3aWRnZXQgbXktYXR0cj0iY291bnQgPSBjb3VudCArIHZhbHVlIj5gIGFuZCB3aWRnZXQgZGVmaW5pdGlvbiBvZgogKiAgIGBzY29wZTogeyBsb2NhbEZuOicmbXlBdHRyJyB9YCwgdGhlbiBpc29sYXRlIHNjb3BlIHByb3BlcnR5IGBsb2NhbEZuYCB3aWxsIHBvaW50IHRvCiAqICAgYSBmdW5jdGlvbiB3cmFwcGVyIGZvciB0aGUgYGNvdW50ID0gY291bnQgKyB2YWx1ZWAgZXhwcmVzc2lvbi4gT2Z0ZW4gaXQncyBkZXNpcmFibGUgdG8KICogICBwYXNzIGRhdGEgZnJvbSB0aGUgaXNvbGF0ZWQgc2NvcGUgdmlhIGFuIGV4cHJlc3Npb24gdG8gdGhlIHBhcmVudCBzY29wZSwgdGhpcyBjYW4gYmUKICogICBkb25lIGJ5IHBhc3NpbmcgYSBtYXAgb2YgbG9jYWwgdmFyaWFibGUgbmFtZXMgYW5kIHZhbHVlcyBpbnRvIHRoZSBleHByZXNzaW9uIHdyYXBwZXIgZm4uCiAqICAgRm9yIGV4YW1wbGUsIGlmIHRoZSBleHByZXNzaW9uIGlzIGBpbmNyZW1lbnQoYW1vdW50KWAgdGhlbiB3ZSBjYW4gc3BlY2lmeSB0aGUgYW1vdW50IHZhbHVlCiAqICAgYnkgY2FsbGluZyB0aGUgYGxvY2FsRm5gIGFzIGBsb2NhbEZuKHthbW91bnQ6IDIyfSlgLgogKgogKgogKiAjIyMjIGBiaW5kVG9Db250cm9sbGVyYAogKiBXaGVuIGFuIGlzb2xhdGUgc2NvcGUgaXMgdXNlZCBmb3IgYSBjb21wb25lbnQgKHNlZSBhYm92ZSksIGFuZCBgY29udHJvbGxlckFzYCBpcyB1c2VkLCBgYmluZFRvQ29udHJvbGxlcmAgd2lsbAogKiBhbGxvdyBhIGNvbXBvbmVudCB0byBoYXZlIGl0cyBwcm9wZXJ0aWVzIGJvdW5kIHRvIHRoZSBjb250cm9sbGVyLCByYXRoZXIgdGhhbiB0byBzY29wZS4gV2hlbiB0aGUgY29udHJvbGxlcgogKiBpcyBpbnN0YW50aWF0ZWQsIHRoZSBpbml0aWFsIHZhbHVlcyBvZiB0aGUgaXNvbGF0ZSBzY29wZSBiaW5kaW5ncyBhcmUgYWxyZWFkeSBhdmFpbGFibGUuCiAqCiAqICMjIyMgYGNvbnRyb2xsZXJgCiAqIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZnVuY3Rpb24uIFRoZSBjb250cm9sbGVyIGlzIGluc3RhbnRpYXRlZCBiZWZvcmUgdGhlCiAqIHByZS1saW5raW5nIHBoYXNlIGFuZCBpdCBpcyBzaGFyZWQgd2l0aCBvdGhlciBkaXJlY3RpdmVzIChzZWUKICogYHJlcXVpcmVgIGF0dHJpYnV0ZSkuIFRoaXMgYWxsb3dzIHRoZSBkaXJlY3RpdmVzIHRvIGNvbW11bmljYXRlIHdpdGggZWFjaCBvdGhlciBhbmQgYXVnbWVudAogKiBlYWNoIG90aGVyJ3MgYmVoYXZpb3IuIFRoZSBjb250cm9sbGVyIGlzIGluamVjdGFibGUgKGFuZCBzdXBwb3J0cyBicmFja2V0IG5vdGF0aW9uKSB3aXRoIHRoZSBmb2xsb3dpbmcgbG9jYWxzOgogKgogKiAqIGAkc2NvcGVgIC0gQ3VycmVudCBzY29wZSBhc3NvY2lhdGVkIHdpdGggdGhlIGVsZW1lbnQKICogKiBgJGVsZW1lbnRgIC0gQ3VycmVudCBlbGVtZW50CiAqICogYCRhdHRyc2AgLSBDdXJyZW50IGF0dHJpYnV0ZXMgb2JqZWN0IGZvciB0aGUgZWxlbWVudAogKiAqIGAkdHJhbnNjbHVkZWAgLSBBIHRyYW5zY2x1ZGUgbGlua2luZyBmdW5jdGlvbiBwcmUtYm91bmQgdG8gdGhlIGNvcnJlY3QgdHJhbnNjbHVzaW9uIHNjb3BlOgogKiAgIGBmdW5jdGlvbihbc2NvcGVdLCBjbG9uZUxpbmtpbmdGbiwgZnV0dXJlUGFyZW50RWxlbWVudClgLgogKiAgICAqIGBzY29wZWA6IG9wdGlvbmFsIGFyZ3VtZW50IHRvIG92ZXJyaWRlIHRoZSBzY29wZS4KICogICAgKiBgY2xvbmVMaW5raW5nRm5gOiBvcHRpb25hbCBhcmd1bWVudCB0byBjcmVhdGUgY2xvbmVzIG9mIHRoZSBvcmlnaW5hbCB0cmFuc2NsdWRlZCBjb250ZW50LgogKiAgICAqIGBmdXR1cmVQYXJlbnRFbGVtZW50YDoKICogICAgICAgICogZGVmaW5lcyB0aGUgcGFyZW50IHRvIHdoaWNoIHRoZSBgY2xvbmVMaW5raW5nRm5gIHdpbGwgYWRkIHRoZSBjbG9uZWQgZWxlbWVudHMuCiAqICAgICAgICAqIGRlZmF1bHQ6IGAkZWxlbWVudC5wYXJlbnQoKWAgcmVzcC4gYCRlbGVtZW50YCBmb3IgYHRyYW5zY2x1ZGU6J2VsZW1lbnQnYCByZXNwLiBgdHJhbnNjbHVkZTp0cnVlYC4KICogICAgICAgICogb25seSBuZWVkZWQgZm9yIHRyYW5zY2x1ZGVzIHRoYXQgYXJlIGFsbG93ZWQgdG8gY29udGFpbiBub24gaHRtbCBlbGVtZW50cyAoZS5nLiBTVkcgZWxlbWVudHMpCiAqICAgICAgICAgIGFuZCB3aGVuIHRoZSBgY2xvbmVMaW5raW5GbmAgaXMgcGFzc2VkLAogKiAgICAgICAgICBhcyB0aG9zZSBlbGVtZW50cyBuZWVkIHRvIGNyZWF0ZWQgYW5kIGNsb25lZCBpbiBhIHNwZWNpYWwgd2F5IHdoZW4gdGhleSBhcmUgZGVmaW5lZCBvdXRzaWRlIHRoZWlyCiAqICAgICAgICAgIHVzdWFsIGNvbnRhaW5lcnMgKGUuZy4gbGlrZSBgPHN2Zz5gKS4KICogICAgICAgICogU2VlIGFsc28gdGhlIGBkaXJlY3RpdmUudGVtcGxhdGVOYW1lc3BhY2VgIHByb3BlcnR5LgogKgogKgogKiAjIyMjIGByZXF1aXJlYAogKiBSZXF1aXJlIGFub3RoZXIgZGlyZWN0aXZlIGFuZCBpbmplY3QgaXRzIGNvbnRyb2xsZXIgYXMgdGhlIGZvdXJ0aCBhcmd1bWVudCB0byB0aGUgbGlua2luZyBmdW5jdGlvbi4gVGhlCiAqIGByZXF1aXJlYCB0YWtlcyBhIHN0cmluZyBuYW1lIChvciBhcnJheSBvZiBzdHJpbmdzKSBvZiB0aGUgZGlyZWN0aXZlKHMpIHRvIHBhc3MgaW4uIElmIGFuIGFycmF5IGlzIHVzZWQsIHRoZQogKiBpbmplY3RlZCBhcmd1bWVudCB3aWxsIGJlIGFuIGFycmF5IGluIGNvcnJlc3BvbmRpbmcgb3JkZXIuIElmIG5vIHN1Y2ggZGlyZWN0aXZlIGNhbiBiZQogKiBmb3VuZCwgb3IgaWYgdGhlIGRpcmVjdGl2ZSBkb2VzIG5vdCBoYXZlIGEgY29udHJvbGxlciwgdGhlbiBhbiBlcnJvciBpcyByYWlzZWQuIFRoZSBuYW1lIGNhbiBiZSBwcmVmaXhlZCB3aXRoOgogKgogKiAqIChubyBwcmVmaXgpIC0gTG9jYXRlIHRoZSByZXF1aXJlZCBjb250cm9sbGVyIG9uIHRoZSBjdXJyZW50IGVsZW1lbnQuIFRocm93IGFuIGVycm9yIGlmIG5vdCBmb3VuZC4KICogKiBgP2AgLSBBdHRlbXB0IHRvIGxvY2F0ZSB0aGUgcmVxdWlyZWQgY29udHJvbGxlciBvciBwYXNzIGBudWxsYCB0byB0aGUgYGxpbmtgIGZuIGlmIG5vdCBmb3VuZC4KICogKiBgXmAgLSBMb2NhdGUgdGhlIHJlcXVpcmVkIGNvbnRyb2xsZXIgYnkgc2VhcmNoaW5nIHRoZSBlbGVtZW50IGFuZCBpdHMgcGFyZW50cy4gVGhyb3cgYW4gZXJyb3IgaWYgbm90IGZvdW5kLgogKiAqIGBeXmAgLSBMb2NhdGUgdGhlIHJlcXVpcmVkIGNvbnRyb2xsZXIgYnkgc2VhcmNoaW5nIHRoZSBlbGVtZW50J3MgcGFyZW50cy4gVGhyb3cgYW4gZXJyb3IgaWYgbm90IGZvdW5kLgogKiAqIGA/XmAgLSBBdHRlbXB0IHRvIGxvY2F0ZSB0aGUgcmVxdWlyZWQgY29udHJvbGxlciBieSBzZWFyY2hpbmcgdGhlIGVsZW1lbnQgYW5kIGl0cyBwYXJlbnRzIG9yIHBhc3MKICogICBgbnVsbGAgdG8gdGhlIGBsaW5rYCBmbiBpZiBub3QgZm91bmQuCiAqICogYD9eXmAgLSBBdHRlbXB0IHRvIGxvY2F0ZSB0aGUgcmVxdWlyZWQgY29udHJvbGxlciBieSBzZWFyY2hpbmcgdGhlIGVsZW1lbnQncyBwYXJlbnRzLCBvciBwYXNzCiAqICAgYG51bGxgIHRvIHRoZSBgbGlua2AgZm4gaWYgbm90IGZvdW5kLgogKgogKgogKiAjIyMjIGBjb250cm9sbGVyQXNgCiAqIENvbnRyb2xsZXIgYWxpYXMgYXQgdGhlIGRpcmVjdGl2ZSBzY29wZS4gQW4gYWxpYXMgZm9yIHRoZSBjb250cm9sbGVyIHNvIGl0CiAqIGNhbiBiZSByZWZlcmVuY2VkIGF0IHRoZSBkaXJlY3RpdmUgdGVtcGxhdGUuIFRoZSBkaXJlY3RpdmUgbmVlZHMgdG8gZGVmaW5lIGEgc2NvcGUgZm9yIHRoaXMKICogY29uZmlndXJhdGlvbiB0byBiZSB1c2VkLiBVc2VmdWwgaW4gdGhlIGNhc2Ugd2hlbiBkaXJlY3RpdmUgaXMgdXNlZCBhcyBjb21wb25lbnQuCiAqCiAqCiAqICMjIyMgYHJlc3RyaWN0YAogKiBTdHJpbmcgb2Ygc3Vic2V0IG9mIGBFQUNNYCB3aGljaCByZXN0cmljdHMgdGhlIGRpcmVjdGl2ZSB0byBhIHNwZWNpZmljIGRpcmVjdGl2ZQogKiBkZWNsYXJhdGlvbiBzdHlsZS4gSWYgb21pdHRlZCwgdGhlIGRlZmF1bHRzIChlbGVtZW50cyBhbmQgYXR0cmlidXRlcykgYXJlIHVzZWQuCiAqCiAqICogYEVgIC0gRWxlbWVudCBuYW1lIChkZWZhdWx0KTogYDxteS1kaXJlY3RpdmU+PC9teS1kaXJlY3RpdmU+YAogKiAqIGBBYCAtIEF0dHJpYnV0ZSAoZGVmYXVsdCk6IGA8ZGl2IG15LWRpcmVjdGl2ZT0iZXhwIj48L2Rpdj5gCiAqICogYENgIC0gQ2xhc3M6IGA8ZGl2IGNsYXNzPSJteS1kaXJlY3RpdmU6IGV4cDsiPjwvZGl2PmAKICogKiBgTWAgLSBDb21tZW50OiBgPCEtLSBkaXJlY3RpdmU6IG15LWRpcmVjdGl2ZSBleHAgLS0+YAogKgogKgogKiAjIyMjIGB0ZW1wbGF0ZU5hbWVzcGFjZWAKICogU3RyaW5nIHJlcHJlc2VudGluZyB0aGUgZG9jdW1lbnQgdHlwZSB1c2VkIGJ5IHRoZSBtYXJrdXAgaW4gdGhlIHRlbXBsYXRlLgogKiBBbmd1bGFySlMgbmVlZHMgdGhpcyBpbmZvcm1hdGlvbiBhcyB0aG9zZSBlbGVtZW50cyBuZWVkIHRvIGJlIGNyZWF0ZWQgYW5kIGNsb25lZAogKiBpbiBhIHNwZWNpYWwgd2F5IHdoZW4gdGhleSBhcmUgZGVmaW5lZCBvdXRzaWRlIHRoZWlyIHVzdWFsIGNvbnRhaW5lcnMgbGlrZSBgPHN2Zz5gIGFuZCBgPG1hdGg+YC4KICoKICogKiBgaHRtbGAgLSBBbGwgcm9vdCBub2RlcyBpbiB0aGUgdGVtcGxhdGUgYXJlIEhUTUwuIFJvb3Qgbm9kZXMgbWF5IGFsc28gYmUKICogICB0b3AtbGV2ZWwgZWxlbWVudHMgc3VjaCBhcyBgPHN2Zz5gIG9yIGA8bWF0aD5gLgogKiAqIGBzdmdgIC0gVGhlIHJvb3Qgbm9kZXMgaW4gdGhlIHRlbXBsYXRlIGFyZSBTVkcgZWxlbWVudHMgKGV4Y2x1ZGluZyBgPG1hdGg+YCkuCiAqICogYG1hdGhgIC0gVGhlIHJvb3Qgbm9kZXMgaW4gdGhlIHRlbXBsYXRlIGFyZSBNYXRoTUwgZWxlbWVudHMgKGV4Y2x1ZGluZyBgPHN2Zz5gKS4KICoKICogSWYgbm8gYHRlbXBsYXRlTmFtZXNwYWNlYCBpcyBzcGVjaWZpZWQsIHRoZW4gdGhlIG5hbWVzcGFjZSBpcyBjb25zaWRlcmVkIHRvIGJlIGBodG1sYC4KICoKICogIyMjIyBgdGVtcGxhdGVgCiAqIEhUTUwgbWFya3VwIHRoYXQgbWF5OgogKiAqIFJlcGxhY2UgdGhlIGNvbnRlbnRzIG9mIHRoZSBkaXJlY3RpdmUncyBlbGVtZW50IChkZWZhdWx0KS4KICogKiBSZXBsYWNlIHRoZSBkaXJlY3RpdmUncyBlbGVtZW50IGl0c2VsZiAoaWYgYHJlcGxhY2VgIGlzIHRydWUgLSBERVBSRUNBVEVEKS4KICogKiBXcmFwIHRoZSBjb250ZW50cyBvZiB0aGUgZGlyZWN0aXZlJ3MgZWxlbWVudCAoaWYgYHRyYW5zY2x1ZGVgIGlzIHRydWUpLgogKgogKiBWYWx1ZSBtYXkgYmU6CiAqCiAqICogQSBzdHJpbmcuIEZvciBleGFtcGxlIGA8ZGl2IHJlZC1vbi1ob3Zlcj57e2RlbGV0ZV9zdHJ9fTwvZGl2PmAuCiAqICogQSBmdW5jdGlvbiB3aGljaCB0YWtlcyB0d28gYXJndW1lbnRzIGB0RWxlbWVudGAgYW5kIGB0QXR0cnNgIChkZXNjcmliZWQgaW4gdGhlIGBjb21waWxlYAogKiAgIGZ1bmN0aW9uIGFwaSBiZWxvdykgYW5kIHJldHVybnMgYSBzdHJpbmcgdmFsdWUuCiAqCiAqCiAqICMjIyMgYHRlbXBsYXRlVXJsYAogKiBUaGlzIGlzIHNpbWlsYXIgdG8gYHRlbXBsYXRlYCBidXQgdGhlIHRlbXBsYXRlIGlzIGxvYWRlZCBmcm9tIHRoZSBzcGVjaWZpZWQgVVJMLCBhc3luY2hyb25vdXNseS4KICoKICogQmVjYXVzZSB0ZW1wbGF0ZSBsb2FkaW5nIGlzIGFzeW5jaHJvbm91cyB0aGUgY29tcGlsZXIgd2lsbCBzdXNwZW5kIGNvbXBpbGF0aW9uIG9mIGRpcmVjdGl2ZXMgb24gdGhhdCBlbGVtZW50CiAqIGZvciBsYXRlciB3aGVuIHRoZSB0ZW1wbGF0ZSBoYXMgYmVlbiByZXNvbHZlZC4gIEluIHRoZSBtZWFudGltZSBpdCB3aWxsIGNvbnRpbnVlIHRvIGNvbXBpbGUgYW5kIGxpbmsKICogc2libGluZyBhbmQgcGFyZW50IGVsZW1lbnRzIGFzIHRob3VnaCB0aGlzIGVsZW1lbnQgaGFkIG5vdCBjb250YWluZWQgYW55IGRpcmVjdGl2ZXMuCiAqCiAqIFRoZSBjb21waWxlciBkb2VzIG5vdCBzdXNwZW5kIHRoZSBlbnRpcmUgY29tcGlsYXRpb24gdG8gd2FpdCBmb3IgdGVtcGxhdGVzIHRvIGJlIGxvYWRlZCBiZWNhdXNlIHRoaXMKICogd291bGQgcmVzdWx0IGluIHRoZSB3aG9sZSBhcHAgInN0YWxsaW5nIiB1bnRpbCBhbGwgdGVtcGxhdGVzIGFyZSBsb2FkZWQgYXN5bmNocm9ub3VzbHkgLSBldmVuIGluIHRoZQogKiBjYXNlIHdoZW4gb25seSBvbmUgZGVlcGx5IG5lc3RlZCBkaXJlY3RpdmUgaGFzIGB0ZW1wbGF0ZVVybGAuCiAqCiAqIFRlbXBsYXRlIGxvYWRpbmcgaXMgYXN5bmNocm9ub3VzIGV2ZW4gaWYgdGhlIHRlbXBsYXRlIGhhcyBiZWVuIHByZWxvYWRlZCBpbnRvIHRoZSB7QGxpbmsgJHRlbXBsYXRlQ2FjaGV9CiAqCiAqIFlvdSBjYW4gc3BlY2lmeSBgdGVtcGxhdGVVcmxgIGFzIGEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgVVJMIG9yIGFzIGEgZnVuY3Rpb24gd2hpY2ggdGFrZXMgdHdvCiAqIGFyZ3VtZW50cyBgdEVsZW1lbnRgIGFuZCBgdEF0dHJzYCAoZGVzY3JpYmVkIGluIHRoZSBgY29tcGlsZWAgZnVuY3Rpb24gYXBpIGJlbG93KSBhbmQgcmV0dXJucwogKiBhIHN0cmluZyB2YWx1ZSByZXByZXNlbnRpbmcgdGhlIHVybC4gIEluIGVpdGhlciBjYXNlLCB0aGUgdGVtcGxhdGUgVVJMIGlzIHBhc3NlZCB0aHJvdWdoIHtAbGluawogKiAkc2NlI2dldFRydXN0ZWRSZXNvdXJjZVVybCAkc2NlLmdldFRydXN0ZWRSZXNvdXJjZVVybH0uCiAqCiAqCiAqICMjIyMgYHJlcGxhY2VgIChbKkRFUFJFQ0FURUQqIV0sIHdpbGwgYmUgcmVtb3ZlZCBpbiBuZXh0IG1ham9yIHJlbGVhc2UgLSBpLmUuIHYyLjApCiAqIHNwZWNpZnkgd2hhdCB0aGUgdGVtcGxhdGUgc2hvdWxkIHJlcGxhY2UuIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAqCiAqICogYHRydWVgIC0gdGhlIHRlbXBsYXRlIHdpbGwgcmVwbGFjZSB0aGUgZGlyZWN0aXZlJ3MgZWxlbWVudC4KICogKiBgZmFsc2VgIC0gdGhlIHRlbXBsYXRlIHdpbGwgcmVwbGFjZSB0aGUgY29udGVudHMgb2YgdGhlIGRpcmVjdGl2ZSdzIGVsZW1lbnQuCiAqCiAqIFRoZSByZXBsYWNlbWVudCBwcm9jZXNzIG1pZ3JhdGVzIGFsbCBvZiB0aGUgYXR0cmlidXRlcyAvIGNsYXNzZXMgZnJvbSB0aGUgb2xkIGVsZW1lbnQgdG8gdGhlIG5ldwogKiBvbmUuIFNlZSB0aGUge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSN0ZW1wbGF0ZS1leHBhbmRpbmctZGlyZWN0aXZlCiAqIERpcmVjdGl2ZXMgR3VpZGV9IGZvciBhbiBleGFtcGxlLgogKgogKiBUaGVyZSBhcmUgdmVyeSBmZXcgc2NlbmFyaW9zIHdoZXJlIGVsZW1lbnQgcmVwbGFjZW1lbnQgaXMgcmVxdWlyZWQgZm9yIHRoZSBhcHBsaWNhdGlvbiBmdW5jdGlvbiwKICogdGhlIG1haW4gb25lIGJlaW5nIHJldXNhYmxlIGN1c3RvbSBjb21wb25lbnRzIHRoYXQgYXJlIHVzZWQgd2l0aGluIFNWRyBjb250ZXh0cwogKiAoYmVjYXVzZSBTVkcgZG9lc24ndCB3b3JrIHdpdGggY3VzdG9tIGVsZW1lbnRzIGluIHRoZSBET00gdHJlZSkuCiAqCiAqICMjIyMgYHRyYW5zY2x1ZGVgCiAqIEV4dHJhY3QgdGhlIGNvbnRlbnRzIG9mIHRoZSBlbGVtZW50IHdoZXJlIHRoZSBkaXJlY3RpdmUgYXBwZWFycyBhbmQgbWFrZSBpdCBhdmFpbGFibGUgdG8gdGhlIGRpcmVjdGl2ZS4KICogVGhlIGNvbnRlbnRzIGFyZSBjb21waWxlZCBhbmQgcHJvdmlkZWQgdG8gdGhlIGRpcmVjdGl2ZSBhcyBhICoqdHJhbnNjbHVzaW9uIGZ1bmN0aW9uKiouIFNlZSB0aGUKICoge0BsaW5rICRjb21waWxlI3RyYW5zY2x1c2lvbiBUcmFuc2NsdXNpb259IHNlY3Rpb24gYmVsb3cuCiAqCiAqIFRoZXJlIGFyZSB0d28ga2luZHMgb2YgdHJhbnNjbHVzaW9uIGRlcGVuZGluZyB1cG9uIHdoZXRoZXIgeW91IHdhbnQgdG8gdHJhbnNjbHVkZSBqdXN0IHRoZSBjb250ZW50cyBvZiB0aGUKICogZGlyZWN0aXZlJ3MgZWxlbWVudCBvciB0aGUgZW50aXJlIGVsZW1lbnQ6CiAqCiAqICogYHRydWVgIC0gdHJhbnNjbHVkZSB0aGUgY29udGVudCAoaS5lLiB0aGUgY2hpbGQgbm9kZXMpIG9mIHRoZSBkaXJlY3RpdmUncyBlbGVtZW50LgogKiAqIGAnZWxlbWVudCdgIC0gdHJhbnNjbHVkZSB0aGUgd2hvbGUgb2YgdGhlIGRpcmVjdGl2ZSdzIGVsZW1lbnQgaW5jbHVkaW5nIGFueSBkaXJlY3RpdmVzIG9uIHRoaXMKICogICBlbGVtZW50IHRoYXQgZGVmaW5lZCBhdCBhIGxvd2VyIHByaW9yaXR5IHRoYW4gdGhpcyBkaXJlY3RpdmUuIFdoZW4gdXNlZCwgdGhlIGB0ZW1wbGF0ZWAKICogICBwcm9wZXJ0eSBpcyBpZ25vcmVkLgogKgogKgogKiAjIyMjIGBjb21waWxlYAogKgogKiBgYGBqcwogKiAgIGZ1bmN0aW9uIGNvbXBpbGUodEVsZW1lbnQsIHRBdHRycywgdHJhbnNjbHVkZSkgeyAuLi4gfQogKiBgYGAKICoKICogVGhlIGNvbXBpbGUgZnVuY3Rpb24gZGVhbHMgd2l0aCB0cmFuc2Zvcm1pbmcgdGhlIHRlbXBsYXRlIERPTS4gU2luY2UgbW9zdCBkaXJlY3RpdmVzIGRvIG5vdCBkbwogKiB0ZW1wbGF0ZSB0cmFuc2Zvcm1hdGlvbiwgaXQgaXMgbm90IHVzZWQgb2Z0ZW4uIFRoZSBjb21waWxlIGZ1bmN0aW9uIHRha2VzIHRoZSBmb2xsb3dpbmcgYXJndW1lbnRzOgogKgogKiAgICogYHRFbGVtZW50YCAtIHRlbXBsYXRlIGVsZW1lbnQgLSBUaGUgZWxlbWVudCB3aGVyZSB0aGUgZGlyZWN0aXZlIGhhcyBiZWVuIGRlY2xhcmVkLiBJdCBpcwogKiAgICAgc2FmZSB0byBkbyB0ZW1wbGF0ZSB0cmFuc2Zvcm1hdGlvbiBvbiB0aGUgZWxlbWVudCBhbmQgY2hpbGQgZWxlbWVudHMgb25seS4KICoKICogICAqIGB0QXR0cnNgIC0gdGVtcGxhdGUgYXR0cmlidXRlcyAtIE5vcm1hbGl6ZWQgbGlzdCBvZiBhdHRyaWJ1dGVzIGRlY2xhcmVkIG9uIHRoaXMgZWxlbWVudCBzaGFyZWQKICogICAgIGJldHdlZW4gYWxsIGRpcmVjdGl2ZSBjb21waWxlIGZ1bmN0aW9ucy4KICoKICogICAqIGB0cmFuc2NsdWRlYCAtICBbKkRFUFJFQ0FURUQqIV0gQSB0cmFuc2NsdWRlIGxpbmtpbmcgZnVuY3Rpb246IGBmdW5jdGlvbihzY29wZSwgY2xvbmVMaW5raW5nRm4pYAogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlOioqIFRoZSB0ZW1wbGF0ZSBpbnN0YW5jZSBhbmQgdGhlIGxpbmsgaW5zdGFuY2UgbWF5IGJlIGRpZmZlcmVudCBvYmplY3RzIGlmIHRoZSB0ZW1wbGF0ZSBoYXMKICogYmVlbiBjbG9uZWQuIEZvciB0aGlzIHJlYXNvbiBpdCBpcyAqKm5vdCoqIHNhZmUgdG8gZG8gYW55dGhpbmcgb3RoZXIgdGhhbiBET00gdHJhbnNmb3JtYXRpb25zIHRoYXQKICogYXBwbHkgdG8gYWxsIGNsb25lZCBET00gbm9kZXMgd2l0aGluIHRoZSBjb21waWxlIGZ1bmN0aW9uLiBTcGVjaWZpY2FsbHksIERPTSBsaXN0ZW5lciByZWdpc3RyYXRpb24KICogc2hvdWxkIGJlIGRvbmUgaW4gYSBsaW5raW5nIGZ1bmN0aW9uIHJhdGhlciB0aGFuIGluIGEgY29tcGlsZSBmdW5jdGlvbi4KICogPC9kaXY+CgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlOioqIFRoZSBjb21waWxlIGZ1bmN0aW9uIGNhbm5vdCBoYW5kbGUgZGlyZWN0aXZlcyB0aGF0IHJlY3Vyc2l2ZWx5IHVzZSB0aGVtc2VsdmVzIGluIHRoZWlyCiAqIG93biB0ZW1wbGF0ZXMgb3IgY29tcGlsZSBmdW5jdGlvbnMuIENvbXBpbGluZyB0aGVzZSBkaXJlY3RpdmVzIHJlc3VsdHMgaW4gYW4gaW5maW5pdGUgbG9vcCBhbmQgYQogKiBzdGFjayBvdmVyZmxvdyBlcnJvcnMuCiAqCiAqIFRoaXMgY2FuIGJlIGF2b2lkZWQgYnkgbWFudWFsbHkgdXNpbmcgJGNvbXBpbGUgaW4gdGhlIHBvc3RMaW5rIGZ1bmN0aW9uIHRvIGltcGVyYXRpdmVseSBjb21waWxlCiAqIGEgZGlyZWN0aXZlJ3MgdGVtcGxhdGUgaW5zdGVhZCBvZiByZWx5aW5nIG9uIGF1dG9tYXRpYyB0ZW1wbGF0ZSBjb21waWxhdGlvbiB2aWEgYHRlbXBsYXRlYCBvcgogKiBgdGVtcGxhdGVVcmxgIGRlY2xhcmF0aW9uIG9yIG1hbnVhbCBjb21waWxhdGlvbiBpbnNpZGUgdGhlIGNvbXBpbGUgZnVuY3Rpb24uCiAqIDwvZGl2PgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1lcnJvciI+CiAqICoqTm90ZToqKiBUaGUgYHRyYW5zY2x1ZGVgIGZ1bmN0aW9uIHRoYXQgaXMgcGFzc2VkIHRvIHRoZSBjb21waWxlIGZ1bmN0aW9uIGlzIGRlcHJlY2F0ZWQsIGFzIGl0CiAqICAgZS5nLiBkb2VzIG5vdCBrbm93IGFib3V0IHRoZSByaWdodCBvdXRlciBzY29wZS4gUGxlYXNlIHVzZSB0aGUgdHJhbnNjbHVkZSBmdW5jdGlvbiB0aGF0IGlzIHBhc3NlZAogKiAgIHRvIHRoZSBsaW5rIGZ1bmN0aW9uIGluc3RlYWQuCiAqIDwvZGl2PgoKICogQSBjb21waWxlIGZ1bmN0aW9uIGNhbiBoYXZlIGEgcmV0dXJuIHZhbHVlIHdoaWNoIGNhbiBiZSBlaXRoZXIgYSBmdW5jdGlvbiBvciBhbiBvYmplY3QuCiAqCiAqICogcmV0dXJuaW5nIGEgKHBvc3QtbGluaykgZnVuY3Rpb24gLSBpcyBlcXVpdmFsZW50IHRvIHJlZ2lzdGVyaW5nIHRoZSBsaW5raW5nIGZ1bmN0aW9uIHZpYSB0aGUKICogICBgbGlua2AgcHJvcGVydHkgb2YgdGhlIGNvbmZpZyBvYmplY3Qgd2hlbiB0aGUgY29tcGlsZSBmdW5jdGlvbiBpcyBlbXB0eS4KICoKICogKiByZXR1cm5pbmcgYW4gb2JqZWN0IHdpdGggZnVuY3Rpb24ocykgcmVnaXN0ZXJlZCB2aWEgYHByZWAgYW5kIGBwb3N0YCBwcm9wZXJ0aWVzIC0gYWxsb3dzIHlvdSB0bwogKiAgIGNvbnRyb2wgd2hlbiBhIGxpbmtpbmcgZnVuY3Rpb24gc2hvdWxkIGJlIGNhbGxlZCBkdXJpbmcgdGhlIGxpbmtpbmcgcGhhc2UuIFNlZSBpbmZvIGFib3V0CiAqICAgcHJlLWxpbmtpbmcgYW5kIHBvc3QtbGlua2luZyBmdW5jdGlvbnMgYmVsb3cuCiAqCiAqCiAqICMjIyMgYGxpbmtgCiAqIFRoaXMgcHJvcGVydHkgaXMgdXNlZCBvbmx5IGlmIHRoZSBgY29tcGlsZWAgcHJvcGVydHkgaXMgbm90IGRlZmluZWQuCiAqCiAqIGBgYGpzCiAqICAgZnVuY3Rpb24gbGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycywgY29udHJvbGxlciwgdHJhbnNjbHVkZUZuKSB7IC4uLiB9CiAqIGBgYAogKgogKiBUaGUgbGluayBmdW5jdGlvbiBpcyByZXNwb25zaWJsZSBmb3IgcmVnaXN0ZXJpbmcgRE9NIGxpc3RlbmVycyBhcyB3ZWxsIGFzIHVwZGF0aW5nIHRoZSBET00uIEl0IGlzCiAqIGV4ZWN1dGVkIGFmdGVyIHRoZSB0ZW1wbGF0ZSBoYXMgYmVlbiBjbG9uZWQuIFRoaXMgaXMgd2hlcmUgbW9zdCBvZiB0aGUgZGlyZWN0aXZlIGxvZ2ljIHdpbGwgYmUKICogcHV0LgogKgogKiAgICogYHNjb3BlYCAtIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIFNjb3BlfSAtIFRoZSBzY29wZSB0byBiZSB1c2VkIGJ5IHRoZQogKiAgICAgZGlyZWN0aXZlIGZvciByZWdpc3RlcmluZyB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2hlc30uCiAqCiAqICAgKiBgaUVsZW1lbnRgIC0gaW5zdGFuY2UgZWxlbWVudCAtIFRoZSBlbGVtZW50IHdoZXJlIHRoZSBkaXJlY3RpdmUgaXMgdG8gYmUgdXNlZC4gSXQgaXMgc2FmZSB0bwogKiAgICAgbWFuaXB1bGF0ZSB0aGUgY2hpbGRyZW4gb2YgdGhlIGVsZW1lbnQgb25seSBpbiBgcG9zdExpbmtgIGZ1bmN0aW9uIHNpbmNlIHRoZSBjaGlsZHJlbiBoYXZlCiAqICAgICBhbHJlYWR5IGJlZW4gbGlua2VkLgogKgogKiAgICogYGlBdHRyc2AgLSBpbnN0YW5jZSBhdHRyaWJ1dGVzIC0gTm9ybWFsaXplZCBsaXN0IG9mIGF0dHJpYnV0ZXMgZGVjbGFyZWQgb24gdGhpcyBlbGVtZW50IHNoYXJlZAogKiAgICAgYmV0d2VlbiBhbGwgZGlyZWN0aXZlIGxpbmtpbmcgZnVuY3Rpb25zLgogKgogKiAgICogYGNvbnRyb2xsZXJgIC0gYSBjb250cm9sbGVyIGluc3RhbmNlIC0gQSBjb250cm9sbGVyIGluc3RhbmNlIGlmIGF0IGxlYXN0IG9uZSBkaXJlY3RpdmUgb24gdGhlCiAqICAgICBlbGVtZW50IGRlZmluZXMgYSBjb250cm9sbGVyLiBUaGUgY29udHJvbGxlciBpcyBzaGFyZWQgYW1vbmcgYWxsIHRoZSBkaXJlY3RpdmVzLCB3aGljaCBhbGxvd3MKICogICAgIHRoZSBkaXJlY3RpdmVzIHRvIHVzZSB0aGUgY29udHJvbGxlcnMgYXMgYSBjb21tdW5pY2F0aW9uIGNoYW5uZWwuCiAqCiAqICAgKiBgdHJhbnNjbHVkZUZuYCAtIEEgdHJhbnNjbHVkZSBsaW5raW5nIGZ1bmN0aW9uIHByZS1ib3VuZCB0byB0aGUgY29ycmVjdCB0cmFuc2NsdXNpb24gc2NvcGUuCiAqICAgICBUaGlzIGlzIHRoZSBzYW1lIGFzIHRoZSBgJHRyYW5zY2x1ZGVgCiAqICAgICBwYXJhbWV0ZXIgb2YgZGlyZWN0aXZlIGNvbnRyb2xsZXJzLCBzZWUgdGhlcmUgZm9yIGRldGFpbHMuCiAqICAgICBgZnVuY3Rpb24oW3Njb3BlXSwgY2xvbmVMaW5raW5nRm4sIGZ1dHVyZVBhcmVudEVsZW1lbnQpYC4KICoKICogIyMjIyBQcmUtbGlua2luZyBmdW5jdGlvbgogKgogKiBFeGVjdXRlZCBiZWZvcmUgdGhlIGNoaWxkIGVsZW1lbnRzIGFyZSBsaW5rZWQuIE5vdCBzYWZlIHRvIGRvIERPTSB0cmFuc2Zvcm1hdGlvbiBzaW5jZSB0aGUKICogY29tcGlsZXIgbGlua2luZyBmdW5jdGlvbiB3aWxsIGZhaWwgdG8gbG9jYXRlIHRoZSBjb3JyZWN0IGVsZW1lbnRzIGZvciBsaW5raW5nLgogKgogKiAjIyMjIFBvc3QtbGlua2luZyBmdW5jdGlvbgogKgogKiBFeGVjdXRlZCBhZnRlciB0aGUgY2hpbGQgZWxlbWVudHMgYXJlIGxpbmtlZC4KICoKICogTm90ZSB0aGF0IGNoaWxkIGVsZW1lbnRzIHRoYXQgY29udGFpbiBgdGVtcGxhdGVVcmxgIGRpcmVjdGl2ZXMgd2lsbCBub3QgaGF2ZSBiZWVuIGNvbXBpbGVkCiAqIGFuZCBsaW5rZWQgc2luY2UgdGhleSBhcmUgd2FpdGluZyBmb3IgdGhlaXIgdGVtcGxhdGUgdG8gbG9hZCBhc3luY2hyb25vdXNseSBhbmQgdGhlaXIgb3duCiAqIGNvbXBpbGF0aW9uIGFuZCBsaW5raW5nIGhhcyBiZWVuIHN1c3BlbmRlZCB1bnRpbCB0aGF0IG9jY3Vycy4KICoKICogSXQgaXMgc2FmZSB0byBkbyBET00gdHJhbnNmb3JtYXRpb24gaW4gdGhlIHBvc3QtbGlua2luZyBmdW5jdGlvbiBvbiBlbGVtZW50cyB0aGF0IGFyZSBub3Qgd2FpdGluZwogKiBmb3IgdGhlaXIgYXN5bmMgdGVtcGxhdGVzIHRvIGJlIHJlc29sdmVkLgogKgogKgogKiAjIyMgVHJhbnNjbHVzaW9uCiAqCiAqIFRyYW5zY2x1c2lvbiBpcyB0aGUgcHJvY2VzcyBvZiBleHRyYWN0aW5nIGEgY29sbGVjdGlvbiBvZiBET00gZWxlbWVudCBmcm9tIG9uZSBwYXJ0IG9mIHRoZSBET00gYW5kCiAqIGNvcHlpbmcgdGhlbSB0byBhbm90aGVyIHBhcnQgb2YgdGhlIERPTSwgd2hpbGUgbWFpbnRhaW5pbmcgdGhlaXIgY29ubmVjdGlvbiB0byB0aGUgb3JpZ2luYWwgQW5ndWxhckpTCiAqIHNjb3BlIGZyb20gd2hlcmUgdGhleSB3ZXJlIHRha2VuLgogKgogKiBUcmFuc2NsdXNpb24gaXMgdXNlZCAob2Z0ZW4gd2l0aCB7QGxpbmsgbmdUcmFuc2NsdWRlfSkgdG8gaW5zZXJ0IHRoZQogKiBvcmlnaW5hbCBjb250ZW50cyBvZiBhIGRpcmVjdGl2ZSdzIGVsZW1lbnQgaW50byBhIHNwZWNpZmllZCBwbGFjZSBpbiB0aGUgdGVtcGxhdGUgb2YgdGhlIGRpcmVjdGl2ZS4KICogVGhlIGJlbmVmaXQgb2YgdHJhbnNjbHVzaW9uLCBvdmVyIHNpbXBseSBtb3ZpbmcgdGhlIERPTSBlbGVtZW50cyBtYW51YWxseSwgaXMgdGhhdCB0aGUgdHJhbnNjbHVkZWQKICogY29udGVudCBoYXMgYWNjZXNzIHRvIHRoZSBwcm9wZXJ0aWVzIG9uIHRoZSBzY29wZSBmcm9tIHdoaWNoIGl0IHdhcyB0YWtlbiwgZXZlbiBpZiB0aGUgZGlyZWN0aXZlCiAqIGhhcyBpc29sYXRlZCBzY29wZS4KICogU2VlIHRoZSB7QGxpbmsgZ3VpZGUvZGlyZWN0aXZlI2NyZWF0aW5nLWEtZGlyZWN0aXZlLXRoYXQtd3JhcHMtb3RoZXItZWxlbWVudHMgRGlyZWN0aXZlcyBHdWlkZX0uCiAqCiAqIFRoaXMgbWFrZXMgaXQgcG9zc2libGUgZm9yIHRoZSB3aWRnZXQgdG8gaGF2ZSBwcml2YXRlIHN0YXRlIGZvciBpdHMgdGVtcGxhdGUsIHdoaWxlIHRoZSB0cmFuc2NsdWRlZAogKiBjb250ZW50IGhhcyBhY2Nlc3MgdG8gaXRzIG9yaWdpbmF0aW5nIHNjb3BlLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlOioqIFdoZW4gdGVzdGluZyBhbiBlbGVtZW50IHRyYW5zY2x1ZGUgZGlyZWN0aXZlIHlvdSBtdXN0IG5vdCBwbGFjZSB0aGUgZGlyZWN0aXZlIGF0IHRoZSByb290IG9mIHRoZQogKiBET00gZnJhZ21lbnQgdGhhdCBpcyBiZWluZyBjb21waWxlZC4gU2VlIHtAbGluayBndWlkZS91bml0LXRlc3RpbmcjdGVzdGluZy10cmFuc2NsdXNpb24tZGlyZWN0aXZlcwogKiBUZXN0aW5nIFRyYW5zY2x1c2lvbiBEaXJlY3RpdmVzfS4KICogPC9kaXY+CiAqCiAqICMjIyMgVHJhbnNjbHVzaW9uIEZ1bmN0aW9ucwogKgogKiBXaGVuIGEgZGlyZWN0aXZlIHJlcXVlc3RzIHRyYW5zY2x1c2lvbiwgdGhlIGNvbXBpbGVyIGV4dHJhY3RzIGl0cyBjb250ZW50cyBhbmQgcHJvdmlkZXMgYSAqKnRyYW5zY2x1c2lvbgogKiBmdW5jdGlvbioqIHRvIHRoZSBkaXJlY3RpdmUncyBgbGlua2AgZnVuY3Rpb24gYW5kIGBjb250cm9sbGVyYC4gVGhpcyB0cmFuc2NsdXNpb24gZnVuY3Rpb24gaXMgYSBzcGVjaWFsCiAqICoqbGlua2luZyBmdW5jdGlvbioqIHRoYXQgd2lsbCByZXR1cm4gdGhlIGNvbXBpbGVkIGNvbnRlbnRzIGxpbmtlZCB0byBhIG5ldyB0cmFuc2NsdXNpb24gc2NvcGUuCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LWluZm8iPgogKiBJZiB5b3UgYXJlIGp1c3QgdXNpbmcge0BsaW5rIG5nVHJhbnNjbHVkZX0gdGhlbiB5b3UgZG9uJ3QgbmVlZCB0byB3b3JyeSBhYm91dCB0aGlzIGZ1bmN0aW9uLCBzaW5jZQogKiBuZ1RyYW5zY2x1ZGUgd2lsbCBkZWFsIHdpdGggaXQgZm9yIHVzLgogKiA8L2Rpdj4KICoKICogSWYgeW91IHdhbnQgdG8gbWFudWFsbHkgY29udHJvbCB0aGUgaW5zZXJ0aW9uIGFuZCByZW1vdmFsIG9mIHRoZSB0cmFuc2NsdWRlZCBjb250ZW50IGluIHlvdXIgZGlyZWN0aXZlCiAqIHRoZW4geW91IG11c3QgdXNlIHRoaXMgdHJhbnNjbHVkZSBmdW5jdGlvbi4gV2hlbiB5b3UgY2FsbCBhIHRyYW5zY2x1ZGUgZnVuY3Rpb24gaXQgcmV0dXJucyBhIGEganFMaXRlL0pRdWVyeQogKiBvYmplY3QgdGhhdCBjb250YWlucyB0aGUgY29tcGlsZWQgRE9NLCB3aGljaCBpcyBsaW5rZWQgdG8gdGhlIGNvcnJlY3QgdHJhbnNjbHVzaW9uIHNjb3BlLgogKgogKiBXaGVuIHlvdSBjYWxsIGEgdHJhbnNjbHVzaW9uIGZ1bmN0aW9uIHlvdSBjYW4gcGFzcyBpbiBhICoqY2xvbmUgYXR0YWNoIGZ1bmN0aW9uKiouIFRoaXMgZnVuY3Rpb24gYWNjZXB0cwogKiB0d28gcGFyYW1ldGVycywgYGZ1bmN0aW9uKGNsb25lLCBzY29wZSkgeyAuLi4gfWAsIHdoZXJlIHRoZSBgY2xvbmVgIGlzIGEgZnJlc2ggY29tcGlsZWQgY29weSBvZiB5b3VyIHRyYW5zY2x1ZGVkCiAqIGNvbnRlbnQgYW5kIHRoZSBgc2NvcGVgIGlzIHRoZSBuZXdseSBjcmVhdGVkIHRyYW5zY2x1c2lvbiBzY29wZSwgdG8gd2hpY2ggdGhlIGNsb25lIGlzIGJvdW5kLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1pbmZvIj4KICogKipCZXN0IFByYWN0aWNlKio6IEFsd2F5cyBwcm92aWRlIGEgYGNsb25lRm5gIChjbG9uZSBhdHRhY2ggZnVuY3Rpb24pIHdoZW4geW91IGNhbGwgYSB0cmFuc2x1ZGUgZnVuY3Rpb24KICogc2luY2UgeW91IHRoZW4gZ2V0IGEgZnJlc2ggY2xvbmUgb2YgdGhlIG9yaWdpbmFsIERPTSBhbmQgYWxzbyBoYXZlIGFjY2VzcyB0byB0aGUgbmV3IHRyYW5zY2x1c2lvbiBzY29wZS4KICogPC9kaXY+CiAqCiAqIEl0IGlzIG5vcm1hbCBwcmFjdGljZSB0byBhdHRhY2ggeW91ciB0cmFuc2NsdWRlZCBjb250ZW50IChgY2xvbmVgKSB0byB0aGUgRE9NIGluc2lkZSB5b3VyICoqY2xvbmUKICogYXR0YWNoIGZ1bmN0aW9uKio6CiAqCiAqIGBgYGpzCiAqIHZhciB0cmFuc2NsdWRlZENvbnRlbnQsIHRyYW5zY2x1c2lvblNjb3BlOwogKgogKiAkdHJhbnNjbHVkZShmdW5jdGlvbihjbG9uZSwgc2NvcGUpIHsKICogICBlbGVtZW50LmFwcGVuZChjbG9uZSk7CiAqICAgdHJhbnNjbHVkZWRDb250ZW50ID0gY2xvbmU7CiAqICAgdHJhbnNjbHVzaW9uU2NvcGUgPSBzY29wZTsKICogfSk7CiAqIGBgYAogKgogKiBMYXRlciwgaWYgeW91IHdhbnQgdG8gcmVtb3ZlIHRoZSB0cmFuc2NsdWRlZCBjb250ZW50IGZyb20geW91ciBET00gdGhlbiB5b3Ugc2hvdWxkIGFsc28gZGVzdHJveSB0aGUKICogYXNzb2NpYXRlZCB0cmFuc2NsdXNpb24gc2NvcGU6CiAqCiAqIGBgYGpzCiAqIHRyYW5zY2x1ZGVkQ29udGVudC5yZW1vdmUoKTsKICogdHJhbnNjbHVzaW9uU2NvcGUuJGRlc3Ryb3koKTsKICogYGBgCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LWluZm8iPgogKiAqKkJlc3QgUHJhY3RpY2UqKjogaWYgeW91IGludGVuZCB0byBhZGQgYW5kIHJlbW92ZSB0cmFuc2NsdWRlZCBjb250ZW50IG1hbnVhbGx5IGluIHlvdXIgZGlyZWN0aXZlCiAqIChieSBjYWxsaW5nIHRoZSB0cmFuc2NsdWRlIGZ1bmN0aW9uIHRvIGdldCB0aGUgRE9NIGFuZCBhbmQgY2FsbGluZyBgZWxlbWVudC5yZW1vdmUoKWAgdG8gcmVtb3ZlIGl0KSwKICogdGhlbiB5b3UgYXJlIGFsc28gcmVzcG9uc2libGUgZm9yIGNhbGxpbmcgYCRkZXN0cm95YCBvbiB0aGUgdHJhbnNjbHVzaW9uIHNjb3BlLgogKiA8L2Rpdj4KICoKICogVGhlIGJ1aWx0LWluIERPTSBtYW5pcHVsYXRpb24gZGlyZWN0aXZlcywgc3VjaCBhcyB7QGxpbmsgbmdJZn0sIHtAbGluayBuZ1N3aXRjaH0gYW5kIHtAbGluayBuZ1JlcGVhdH0KICogYXV0b21hdGljYWxseSBkZXN0cm95IHRoZWlyIHRyYW5zbHVkZWQgY2xvbmVzIGFzIG5lY2Vzc2FyeSBzbyB5b3UgZG8gbm90IG5lZWQgdG8gd29ycnkgYWJvdXQgdGhpcyBpZgogKiB5b3UgYXJlIHNpbXBseSB1c2luZyB7QGxpbmsgbmdUcmFuc2NsdWRlfSB0byBpbmplY3QgdGhlIHRyYW5zY2x1c2lvbiBpbnRvIHlvdXIgZGlyZWN0aXZlLgogKgogKgogKiAjIyMjIFRyYW5zY2x1c2lvbiBTY29wZXMKICoKICogV2hlbiB5b3UgY2FsbCBhIHRyYW5zY2x1ZGUgZnVuY3Rpb24gaXQgcmV0dXJucyBhIERPTSBmcmFnbWVudCB0aGF0IGlzIHByZS1ib3VuZCB0byBhICoqdHJhbnNjbHVzaW9uCiAqIHNjb3BlKiouIFRoaXMgc2NvcGUgaXMgc3BlY2lhbCwgaW4gdGhhdCBpdCBpcyBhIGNoaWxkIG9mIHRoZSBkaXJlY3RpdmUncyBzY29wZSAoYW5kIHNvIGdldHMgZGVzdHJveWVkCiAqIHdoZW4gdGhlIGRpcmVjdGl2ZSdzIHNjb3BlIGdldHMgZGVzdHJveWVkKSBidXQgaXQgaW5oZXJpdHMgdGhlIHByb3BlcnRpZXMgb2YgdGhlIHNjb3BlIGZyb20gd2hpY2ggaXQKICogd2FzIHRha2VuLgogKgogKiBGb3IgZXhhbXBsZSBjb25zaWRlciBhIGRpcmVjdGl2ZSB0aGF0IHVzZXMgdHJhbnNjbHVzaW9uIGFuZCBpc29sYXRlZCBzY29wZS4gVGhlIERPTSBoaWVyYXJjaHkgbWlnaHQgbG9vawogKiBsaWtlIHRoaXM6CiAqCiAqIGBgYGh0bWwKICogPGRpdiBuZy1hcHA+CiAqICAgPGRpdiBpc29sYXRlPgogKiAgICAgPGRpdiB0cmFuc2NsdXNpb24+CiAqICAgICA8L2Rpdj4KICogICA8L2Rpdj4KICogPC9kaXY+CiAqIGBgYAogKgogKiBUaGUgYCRwYXJlbnRgIHNjb3BlIGhpZXJhcmNoeSB3aWxsIGxvb2sgbGlrZSB0aGlzOgogKgogKiBgYGAKICogLSAkcm9vdFNjb3BlCiAqICAgLSBpc29sYXRlCiAqICAgICAtIHRyYW5zY2x1c2lvbgogKiBgYGAKICoKICogYnV0IHRoZSBzY29wZXMgd2lsbCBpbmhlcml0IHByb3RvdHlwaWNhbGx5IGZyb20gZGlmZmVyZW50IHNjb3BlcyB0byB0aGVpciBgJHBhcmVudGAuCiAqCiAqIGBgYAogKiAtICRyb290U2NvcGUKICogICAtIHRyYW5zY2x1c2lvbgogKiAtIGlzb2xhdGUKICogYGBgCiAqCiAqCiAqICMjIyBBdHRyaWJ1dGVzCiAqCiAqIFRoZSB7QGxpbmsgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMgQXR0cmlidXRlc30gb2JqZWN0IC0gcGFzc2VkIGFzIGEgcGFyYW1ldGVyIGluIHRoZQogKiBgbGluaygpYCBvciBgY29tcGlsZSgpYCBmdW5jdGlvbnMuIEl0IGhhcyBhIHZhcmlldHkgb2YgdXNlcy4KICoKICogYWNjZXNzaW5nICpOb3JtYWxpemVkIGF0dHJpYnV0ZSBuYW1lczoqCiAqIERpcmVjdGl2ZXMgbGlrZSAnbmdCaW5kJyBjYW4gYmUgZXhwcmVzc2VkIGluIG1hbnkgd2F5czogJ25nOmJpbmQnLCBgZGF0YS1uZy1iaW5kYCwgb3IgJ3gtbmctYmluZCcuCiAqIHRoZSBhdHRyaWJ1dGVzIG9iamVjdCBhbGxvd3MgZm9yIG5vcm1hbGl6ZWQgYWNjZXNzIHRvCiAqICAgdGhlIGF0dHJpYnV0ZXMuCiAqCiAqICogKkRpcmVjdGl2ZSBpbnRlci1jb21tdW5pY2F0aW9uOiogQWxsIGRpcmVjdGl2ZXMgc2hhcmUgdGhlIHNhbWUgaW5zdGFuY2Ugb2YgdGhlIGF0dHJpYnV0ZXMKICogICBvYmplY3Qgd2hpY2ggYWxsb3dzIHRoZSBkaXJlY3RpdmVzIHRvIHVzZSB0aGUgYXR0cmlidXRlcyBvYmplY3QgYXMgaW50ZXIgZGlyZWN0aXZlCiAqICAgY29tbXVuaWNhdGlvbi4KICoKICogKiAqU3VwcG9ydHMgaW50ZXJwb2xhdGlvbjoqIEludGVycG9sYXRpb24gYXR0cmlidXRlcyBhcmUgYXNzaWduZWQgdG8gdGhlIGF0dHJpYnV0ZSBvYmplY3QKICogICBhbGxvd2luZyBvdGhlciBkaXJlY3RpdmVzIHRvIHJlYWQgdGhlIGludGVycG9sYXRlZCB2YWx1ZS4KICoKICogKiAqT2JzZXJ2aW5nIGludGVycG9sYXRlZCBhdHRyaWJ1dGVzOiogVXNlIGAkb2JzZXJ2ZWAgdG8gb2JzZXJ2ZSB0aGUgdmFsdWUgY2hhbmdlcyBvZiBhdHRyaWJ1dGVzCiAqICAgdGhhdCBjb250YWluIGludGVycG9sYXRpb24gKGUuZy4gYHNyYz0ie3tiYXJ9fSJgKS4gTm90IG9ubHkgaXMgdGhpcyB2ZXJ5IGVmZmljaWVudCBidXQgaXQncyBhbHNvCiAqICAgdGhlIG9ubHkgd2F5IHRvIGVhc2lseSBnZXQgdGhlIGFjdHVhbCB2YWx1ZSBiZWNhdXNlIGR1cmluZyB0aGUgbGlua2luZyBwaGFzZSB0aGUgaW50ZXJwb2xhdGlvbgogKiAgIGhhc24ndCBiZWVuIGV2YWx1YXRlZCB5ZXQgYW5kIHNvIHRoZSB2YWx1ZSBpcyBhdCB0aGlzIHRpbWUgc2V0IHRvIGB1bmRlZmluZWRgLgogKgogKiBgYGBqcwogKiBmdW5jdGlvbiBsaW5raW5nRm4oc2NvcGUsIGVsbSwgYXR0cnMsIGN0cmwpIHsKICogICAvLyBnZXQgdGhlIGF0dHJpYnV0ZSB2YWx1ZQogKiAgIGNvbnNvbGUubG9nKGF0dHJzLm5nTW9kZWwpOwogKgogKiAgIC8vIGNoYW5nZSB0aGUgYXR0cmlidXRlCiAqICAgYXR0cnMuJHNldCgnbmdNb2RlbCcsICduZXcgdmFsdWUnKTsKICoKICogICAvLyBvYnNlcnZlIGNoYW5nZXMgdG8gaW50ZXJwb2xhdGVkIGF0dHJpYnV0ZQogKiAgIGF0dHJzLiRvYnNlcnZlKCduZ01vZGVsJywgZnVuY3Rpb24odmFsdWUpIHsKICogICAgIGNvbnNvbGUubG9nKCduZ01vZGVsIGhhcyBjaGFuZ2VkIHZhbHVlIHRvICcgKyB2YWx1ZSk7CiAqICAgfSk7CiAqIH0KICogYGBgCiAqCiAqICMjIEV4YW1wbGUKICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAqICoqTm90ZSoqOiBUeXBpY2FsbHkgZGlyZWN0aXZlcyBhcmUgcmVnaXN0ZXJlZCB3aXRoIGBtb2R1bGUuZGlyZWN0aXZlYC4gVGhlIGV4YW1wbGUgYmVsb3cgaXMKICogdG8gaWxsdXN0cmF0ZSBob3cgYCRjb21waWxlYCB3b3Jrcy4KICogPC9kaXY+CiAqCiA8ZXhhbXBsZSBtb2R1bGU9ImNvbXBpbGVFeGFtcGxlIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICA8c2NyaXB0PgogICAgICBhbmd1bGFyLm1vZHVsZSgnY29tcGlsZUV4YW1wbGUnLCBbXSwgZnVuY3Rpb24oJGNvbXBpbGVQcm92aWRlcikgewogICAgICAgIC8vIGNvbmZpZ3VyZSBuZXcgJ2NvbXBpbGUnIGRpcmVjdGl2ZSBieSBwYXNzaW5nIGEgZGlyZWN0aXZlCiAgICAgICAgLy8gZmFjdG9yeSBmdW5jdGlvbi4gVGhlIGZhY3RvcnkgZnVuY3Rpb24gaW5qZWN0cyB0aGUgJyRjb21waWxlJwogICAgICAgICRjb21waWxlUHJvdmlkZXIuZGlyZWN0aXZlKCdjb21waWxlJywgZnVuY3Rpb24oJGNvbXBpbGUpIHsKICAgICAgICAgIC8vIGRpcmVjdGl2ZSBmYWN0b3J5IGNyZWF0ZXMgYSBsaW5rIGZ1bmN0aW9uCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgKICAgICAgICAgICAgICBmdW5jdGlvbihzY29wZSkgewogICAgICAgICAgICAgICAgIC8vIHdhdGNoIHRoZSAnY29tcGlsZScgZXhwcmVzc2lvbiBmb3IgY2hhbmdlcwogICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRldmFsKGF0dHJzLmNvbXBpbGUpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhlICdjb21waWxlJyBleHByZXNzaW9uIGNoYW5nZXMKICAgICAgICAgICAgICAgIC8vIGFzc2lnbiBpdCBpbnRvIHRoZSBjdXJyZW50IERPTQogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHZhbHVlKTsKCiAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRoZSBuZXcgRE9NIGFuZCBsaW5rIGl0IHRvIHRoZSBjdXJyZW50CiAgICAgICAgICAgICAgICAvLyBzY29wZS4KICAgICAgICAgICAgICAgIC8vIE5PVEU6IHdlIG9ubHkgY29tcGlsZSAuY2hpbGROb2RlcyBzbyB0aGF0CiAgICAgICAgICAgICAgICAvLyB3ZSBkb24ndCBnZXQgaW50byBpbmZpbml0ZSBsb29wIGNvbXBpbGluZyBvdXJzZWx2ZXMKICAgICAgICAgICAgICAgICRjb21waWxlKGVsZW1lbnQuY29udGVudHMoKSkoc2NvcGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICAgIH0pCiAgICAgIC5jb250cm9sbGVyKCdHcmVldGVyQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgJHNjb3BlLm5hbWUgPSAnQW5ndWxhcic7CiAgICAgICAgJHNjb3BlLmh0bWwgPSAnSGVsbG8ge3tuYW1lfX0nOwogICAgICB9XSk7CiAgICA8L3NjcmlwdD4KICAgIDxkaXYgbmctY29udHJvbGxlcj0iR3JlZXRlckNvbnRyb2xsZXIiPgogICAgICA8aW5wdXQgbmctbW9kZWw9Im5hbWUiPiA8YnI+CiAgICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0iaHRtbCI+PC90ZXh0YXJlYT4gPGJyPgogICAgICA8ZGl2IGNvbXBpbGU9Imh0bWwiPjwvZGl2PgogICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgaXQoJ3Nob3VsZCBhdXRvIGNvbXBpbGUnLCBmdW5jdGlvbigpIHsKICAgICAgIHZhciB0ZXh0YXJlYSA9ICQoJ3RleHRhcmVhJyk7CiAgICAgICB2YXIgb3V0cHV0ID0gJCgnZGl2W2NvbXBpbGVdJyk7CiAgICAgICAvLyBUaGUgaW5pdGlhbCBzdGF0ZSByZWFkcyAnSGVsbG8gQW5ndWxhcicuCiAgICAgICBleHBlY3Qob3V0cHV0LmdldFRleHQoKSkudG9CZSgnSGVsbG8gQW5ndWxhcicpOwogICAgICAgdGV4dGFyZWEuY2xlYXIoKTsKICAgICAgIHRleHRhcmVhLnNlbmRLZXlzKCd7e25hbWV9fSEnKTsKICAgICAgIGV4cGVjdChvdXRwdXQuZ2V0VGV4dCgpKS50b0JlKCdBbmd1bGFyIScpOwogICAgIH0pOwogICA8L2ZpbGU+CiA8L2V4YW1wbGU+CgogKgogKgogKiBAcGFyYW0ge3N0cmluZ3xET01FbGVtZW50fSBlbGVtZW50IEVsZW1lbnQgb3IgSFRNTCBzdHJpbmcgdG8gY29tcGlsZSBpbnRvIGEgdGVtcGxhdGUgZnVuY3Rpb24uCiAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZSwgY2xvbmVBdHRhY2hGbj0pfSB0cmFuc2NsdWRlIGZ1bmN0aW9uIGF2YWlsYWJsZSB0byBkaXJlY3RpdmVzLgogKiBAcGFyYW0ge251bWJlcn0gbWF4UHJpb3JpdHkgb25seSBhcHBseSBkaXJlY3RpdmVzIGxvd2VyIHRoYW4gZ2l2ZW4gcHJpb3JpdHkgKE9ubHkgZWZmZWN0cyB0aGUKICogICAgICAgICAgICAgICAgIHJvb3QgZWxlbWVudChzKSwgbm90IHRoZWlyIGNoaWxkcmVuKQogKiBAcmV0dXJucyB7ZnVuY3Rpb24oc2NvcGUsIGNsb25lQXR0YWNoRm49KX0gYSBsaW5rIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gYmluZCB0ZW1wbGF0ZQogKiAoYSBET00gZWxlbWVudC90cmVlKSB0byBhIHNjb3BlLiBXaGVyZToKICoKICogICogYHNjb3BlYCAtIEEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgU2NvcGV9IHRvIGJpbmQgdG8uCiAqICAqIGBjbG9uZUF0dGFjaEZuYCAtIElmIGBjbG9uZUF0dGFjaEZuYCBpcyBwcm92aWRlZCwgdGhlbiB0aGUgbGluayBmdW5jdGlvbiB3aWxsIGNsb25lIHRoZQogKiAgYHRlbXBsYXRlYCBhbmQgY2FsbCB0aGUgYGNsb25lQXR0YWNoRm5gIGZ1bmN0aW9uIGFsbG93aW5nIHRoZSBjYWxsZXIgdG8gYXR0YWNoIHRoZQogKiAgY2xvbmVkIGVsZW1lbnRzIHRvIHRoZSBET00gZG9jdW1lbnQgYXQgdGhlIGFwcHJvcHJpYXRlIHBsYWNlLiBUaGUgYGNsb25lQXR0YWNoRm5gIGlzCiAqICBjYWxsZWQgYXM6IDxicj4gYGNsb25lQXR0YWNoRm4oY2xvbmVkRWxlbWVudCwgc2NvcGUpYCB3aGVyZToKICoKICogICAgICAqIGBjbG9uZWRFbGVtZW50YCAtIGlzIGEgY2xvbmUgb2YgdGhlIG9yaWdpbmFsIGBlbGVtZW50YCBwYXNzZWQgaW50byB0aGUgY29tcGlsZXIuCiAqICAgICAgKiBgc2NvcGVgIC0gaXMgdGhlIGN1cnJlbnQgc2NvcGUgd2l0aCB3aGljaCB0aGUgbGlua2luZyBmdW5jdGlvbiBpcyB3b3JraW5nIHdpdGguCiAqCiAqIENhbGxpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gcmV0dXJucyB0aGUgZWxlbWVudCBvZiB0aGUgdGVtcGxhdGUuIEl0IGlzIGVpdGhlciB0aGUgb3JpZ2luYWwKICogZWxlbWVudCBwYXNzZWQgaW4sIG9yIHRoZSBjbG9uZSBvZiB0aGUgZWxlbWVudCBpZiB0aGUgYGNsb25lQXR0YWNoRm5gIGlzIHByb3ZpZGVkLgogKgogKiBBZnRlciBsaW5raW5nIHRoZSB2aWV3IGlzIG5vdCB1cGRhdGVkIHVudGlsIGFmdGVyIGEgY2FsbCB0byAkZGlnZXN0IHdoaWNoIHR5cGljYWxseSBpcyBkb25lIGJ5CiAqIEFuZ3VsYXIgYXV0b21hdGljYWxseS4KICoKICogSWYgeW91IG5lZWQgYWNjZXNzIHRvIHRoZSBib3VuZCB2aWV3LCB0aGVyZSBhcmUgdHdvIHdheXMgdG8gZG8gaXQ6CiAqCiAqIC0gSWYgeW91IGFyZSBub3QgYXNraW5nIHRoZSBsaW5raW5nIGZ1bmN0aW9uIHRvIGNsb25lIHRoZSB0ZW1wbGF0ZSwgY3JlYXRlIHRoZSBET00gZWxlbWVudChzKQogKiAgIGJlZm9yZSB5b3Ugc2VuZCB0aGVtIHRvIHRoZSBjb21waWxlciBhbmQga2VlcCB0aGlzIHJlZmVyZW5jZSBhcm91bmQuCiAqICAgYGBganMKICogICAgIHZhciBlbGVtZW50ID0gJGNvbXBpbGUoJzxwPnt7dG90YWx9fTwvcD4nKShzY29wZSk7CiAqICAgYGBgCiAqCiAqIC0gaWYgb24gdGhlIG90aGVyIGhhbmQsIHlvdSBuZWVkIHRoZSBlbGVtZW50IHRvIGJlIGNsb25lZCwgdGhlIHZpZXcgcmVmZXJlbmNlIGZyb20gdGhlIG9yaWdpbmFsCiAqICAgZXhhbXBsZSB3b3VsZCBub3QgcG9pbnQgdG8gdGhlIGNsb25lLCBidXQgcmF0aGVyIHRvIHRoZSBvcmlnaW5hbCB0ZW1wbGF0ZSB0aGF0IHdhcyBjbG9uZWQuIEluCiAqICAgdGhpcyBjYXNlLCB5b3UgY2FuIGFjY2VzcyB0aGUgY2xvbmUgdmlhIHRoZSBjbG9uZUF0dGFjaEZuOgogKiAgIGBgYGpzCiAqICAgICB2YXIgdGVtcGxhdGVFbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KCc8cD57e3RvdGFsfX08L3A+JyksCiAqICAgICAgICAgc2NvcGUgPSAuLi4uOwogKgogKiAgICAgdmFyIGNsb25lZEVsZW1lbnQgPSAkY29tcGlsZSh0ZW1wbGF0ZUVsZW1lbnQpKHNjb3BlLCBmdW5jdGlvbihjbG9uZWRFbGVtZW50LCBzY29wZSkgewogKiAgICAgICAvL2F0dGFjaCB0aGUgY2xvbmUgdG8gRE9NIGRvY3VtZW50IGF0IHRoZSByaWdodCBwbGFjZQogKiAgICAgfSk7CiAqCiAqICAgICAvL25vdyB3ZSBoYXZlIHJlZmVyZW5jZSB0byB0aGUgY2xvbmVkIERPTSB2aWEgYGNsb25lZEVsZW1lbnRgCiAqICAgYGBgCiAqCiAqCiAqIEZvciBpbmZvcm1hdGlvbiBvbiBob3cgdGhlIGNvbXBpbGVyIHdvcmtzLCBzZWUgdGhlCiAqIHtAbGluayBndWlkZS9jb21waWxlciBBbmd1bGFyIEhUTUwgQ29tcGlsZXJ9IHNlY3Rpb24gb2YgdGhlIERldmVsb3BlciBHdWlkZS4KICovCgp2YXIgJGNvbXBpbGVNaW5FcnIgPSBtaW5FcnIoJyRjb21waWxlJyk7CgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRjb21waWxlUHJvdmlkZXIKICoKICogQGRlc2NyaXB0aW9uCiAqLwokQ29tcGlsZVByb3ZpZGVyLiRpbmplY3QgPSBbJyRwcm92aWRlJywgJyQkc2FuaXRpemVVcmlQcm92aWRlciddOwpmdW5jdGlvbiAkQ29tcGlsZVByb3ZpZGVyKCRwcm92aWRlLCAkJHNhbml0aXplVXJpUHJvdmlkZXIpIHsKICB2YXIgaGFzRGlyZWN0aXZlcyA9IHt9LAogICAgICBTdWZmaXggPSAnRGlyZWN0aXZlJywKICAgICAgQ09NTUVOVF9ESVJFQ1RJVkVfUkVHRVhQID0gL15ccypkaXJlY3RpdmVcOlxzKihbXGRcd19cLV0rKVxzKyguKikkLywKICAgICAgQ0xBU1NfRElSRUNUSVZFX1JFR0VYUCA9IC8oKFtcZFx3X1wtXSspKD86XDooW147XSspKT87PykvLAogICAgICBBTExfT1JfTk9USElOR19BVFRSUyA9IG1ha2VNYXAoJ25nU3JjLG5nU3Jjc2V0LHNyYyxzcmNzZXQnKSwKICAgICAgUkVRVUlSRV9QUkVGSVhfUkVHRVhQID0gL14oPzooXF5cXj8pPyhcPyk/KFxeXF4/KT8pPy87CgogIC8vIFJlZjogaHR0cDovL2RldmVsb3BlcnMud2hhdHdnLm9yZy93ZWJhcHBhcGlzLmh0bWwjZXZlbnQtaGFuZGxlci1pZGwtYXR0cmlidXRlcwogIC8vIFRoZSBhc3N1bXB0aW9uIGlzIHRoYXQgZnV0dXJlIERPTSBldmVudCBhdHRyaWJ1dGUgbmFtZXMgd2lsbCBiZWdpbiB3aXRoCiAgLy8gJ29uJyBhbmQgYmUgY29tcG9zZWQgb2Ygb25seSBFbmdsaXNoIGxldHRlcnMuCiAgdmFyIEVWRU5UX0hBTkRMRVJfQVRUUl9SRUdFWFAgPSAvXihvblthLXpdK3xmb3JtYWN0aW9uKSQvOwoKICBmdW5jdGlvbiBwYXJzZUlzb2xhdGVCaW5kaW5ncyhzY29wZSwgZGlyZWN0aXZlTmFtZSkgewogICAgdmFyIExPQ0FMX1JFR0VYUCA9IC9eXHMqKFtAPSZdKShcPz8pXHMqKFx3KilccyokLzsKCiAgICB2YXIgYmluZGluZ3MgPSB7fTsKCiAgICBmb3JFYWNoKHNjb3BlLCBmdW5jdGlvbihkZWZpbml0aW9uLCBzY29wZU5hbWUpIHsKICAgICAgdmFyIG1hdGNoID0gZGVmaW5pdGlvbi5tYXRjaChMT0NBTF9SRUdFWFApOwoKICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCdpc2NwJywKICAgICAgICAgICAgIkludmFsaWQgaXNvbGF0ZSBzY29wZSBkZWZpbml0aW9uIGZvciBkaXJlY3RpdmUgJ3swfScuIiArCiAgICAgICAgICAgICIgRGVmaW5pdGlvbjogey4uLiB7MX06ICd7Mn0nIC4uLn0iLAogICAgICAgICAgICBkaXJlY3RpdmVOYW1lLCBzY29wZU5hbWUsIGRlZmluaXRpb24pOwogICAgICB9CgogICAgICBiaW5kaW5nc1tzY29wZU5hbWVdID0gewogICAgICAgIGF0dHJOYW1lOiBtYXRjaFszXSB8fCBzY29wZU5hbWUsCiAgICAgICAgbW9kZTogbWF0Y2hbMV0sCiAgICAgICAgb3B0aW9uYWw6IG1hdGNoWzJdID09PSAnPycKICAgICAgfTsKICAgIH0pOwoKICAgIHJldHVybiBiaW5kaW5nczsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZQogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZWdpc3RlciBhIG5ldyBkaXJlY3RpdmUgd2l0aCB0aGUgY29tcGlsZXIuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R9IG5hbWUgTmFtZSBvZiB0aGUgZGlyZWN0aXZlIGluIGNhbWVsLWNhc2UgKGkuZS4gPGNvZGU+bmdCaW5kPC9jb2RlPiB3aGljaAogICAqICAgIHdpbGwgbWF0Y2ggYXMgPGNvZGU+bmctYmluZDwvY29kZT4pLCBvciBhbiBvYmplY3QgbWFwIG9mIGRpcmVjdGl2ZXMgd2hlcmUgdGhlIGtleXMgYXJlIHRoZQogICAqICAgIG5hbWVzIGFuZCB0aGUgdmFsdWVzIGFyZSB0aGUgZmFjdG9yaWVzLgogICAqIEBwYXJhbSB7RnVuY3Rpb258QXJyYXl9IGRpcmVjdGl2ZUZhY3RvcnkgQW4gaW5qZWN0YWJsZSBkaXJlY3RpdmUgZmFjdG9yeSBmdW5jdGlvbi4gU2VlCiAgICogICAge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZX0gZm9yIG1vcmUgaW5mby4KICAgKiBAcmV0dXJucyB7bmcuJGNvbXBpbGVQcm92aWRlcn0gU2VsZiBmb3IgY2hhaW5pbmcuCiAgICovCiAgIHRoaXMuZGlyZWN0aXZlID0gZnVuY3Rpb24gcmVnaXN0ZXJEaXJlY3RpdmUobmFtZSwgZGlyZWN0aXZlRmFjdG9yeSkgewogICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkobmFtZSwgJ2RpcmVjdGl2ZScpOwogICAgaWYgKGlzU3RyaW5nKG5hbWUpKSB7CiAgICAgIGFzc2VydEFyZyhkaXJlY3RpdmVGYWN0b3J5LCAnZGlyZWN0aXZlRmFjdG9yeScpOwogICAgICBpZiAoIWhhc0RpcmVjdGl2ZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBoYXNEaXJlY3RpdmVzW25hbWVdID0gW107CiAgICAgICAgJHByb3ZpZGUuZmFjdG9yeShuYW1lICsgU3VmZml4LCBbJyRpbmplY3RvcicsICckZXhjZXB0aW9uSGFuZGxlcicsCiAgICAgICAgICBmdW5jdGlvbigkaW5qZWN0b3IsICRleGNlcHRpb25IYW5kbGVyKSB7CiAgICAgICAgICAgIHZhciBkaXJlY3RpdmVzID0gW107CiAgICAgICAgICAgIGZvckVhY2goaGFzRGlyZWN0aXZlc1tuYW1lXSwgZnVuY3Rpb24oZGlyZWN0aXZlRmFjdG9yeSwgaW5kZXgpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIGRpcmVjdGl2ZSA9ICRpbmplY3Rvci5pbnZva2UoZGlyZWN0aXZlRmFjdG9yeSk7CiAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihkaXJlY3RpdmUpKSB7CiAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IHsgY29tcGlsZTogdmFsdWVGbihkaXJlY3RpdmUpIH07CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFkaXJlY3RpdmUuY29tcGlsZSAmJiBkaXJlY3RpdmUubGluaykgewogICAgICAgICAgICAgICAgICBkaXJlY3RpdmUuY29tcGlsZSA9IHZhbHVlRm4oZGlyZWN0aXZlLmxpbmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlyZWN0aXZlLnByaW9yaXR5ID0gZGlyZWN0aXZlLnByaW9yaXR5IHx8IDA7CiAgICAgICAgICAgICAgICBkaXJlY3RpdmUuaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5uYW1lID0gZGlyZWN0aXZlLm5hbWUgfHwgbmFtZTsKICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5yZXF1aXJlID0gZGlyZWN0aXZlLnJlcXVpcmUgfHwgKGRpcmVjdGl2ZS5jb250cm9sbGVyICYmIGRpcmVjdGl2ZS5uYW1lKTsKICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnRUEnOwogICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGRpcmVjdGl2ZS5zY29wZSkpIHsKICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLiQkaXNvbGF0ZUJpbmRpbmdzID0gcGFyc2VJc29sYXRlQmluZGluZ3MoZGlyZWN0aXZlLnNjb3BlLCBkaXJlY3RpdmUubmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gZGlyZWN0aXZlczsKICAgICAgICAgIH1dKTsKICAgICAgfQogICAgICBoYXNEaXJlY3RpdmVzW25hbWVdLnB1c2goZGlyZWN0aXZlRmFjdG9yeSk7CiAgICB9IGVsc2UgewogICAgICBmb3JFYWNoKG5hbWUsIHJldmVyc2VQYXJhbXMocmVnaXN0ZXJEaXJlY3RpdmUpKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGNvbXBpbGVQcm92aWRlciNhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdAogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZXRyaWV2ZXMgb3Igb3ZlcnJpZGVzIHRoZSBkZWZhdWx0IHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgZm9yIHdoaXRlbGlzdGluZyBvZiBzYWZlCiAgICogdXJscyBkdXJpbmcgYVtocmVmXSBzYW5pdGl6YXRpb24uCiAgICoKICAgKiBUaGUgc2FuaXRpemF0aW9uIGlzIGEgc2VjdXJpdHkgbWVhc3VyZSBhaW1lZCBhdCBwcmV2ZW50IFhTUyBhdHRhY2tzIHZpYSBodG1sIGxpbmtzLgogICAqCiAgICogQW55IHVybCBhYm91dCB0byBiZSBhc3NpZ25lZCB0byBhW2hyZWZdIHZpYSBkYXRhLWJpbmRpbmcgaXMgZmlyc3Qgbm9ybWFsaXplZCBhbmQgdHVybmVkIGludG8KICAgKiBhbiBhYnNvbHV0ZSB1cmwuIEFmdGVyd2FyZHMsIHRoZSB1cmwgaXMgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBgYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3RgCiAgICogcmVndWxhciBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kLCB0aGUgb3JpZ2luYWwgdXJsIGlzIHdyaXR0ZW4gaW50byB0aGUgZG9tLiBPdGhlcndpc2UsCiAgICogdGhlIGFic29sdXRlIHVybCBpcyBwcmVmaXhlZCB3aXRoIGAndW5zYWZlOidgIHN0cmluZyBhbmQgb25seSB0aGVuIGlzIGl0IHdyaXR0ZW4gaW50byB0aGUgRE9NLgogICAqCiAgICogQHBhcmFtIHtSZWdFeHA9fSByZWdleHAgTmV3IHJlZ2V4cCB0byB3aGl0ZWxpc3QgdXJscyB3aXRoLgogICAqIEByZXR1cm5zIHtSZWdFeHB8bmcuJGNvbXBpbGVQcm92aWRlcn0gQ3VycmVudCBSZWdFeHAgaWYgY2FsbGVkIHdpdGhvdXQgdmFsdWUgb3Igc2VsZiBmb3IKICAgKiAgICBjaGFpbmluZyBvdGhlcndpc2UuCiAgICovCiAgdGhpcy5hSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCA9IGZ1bmN0aW9uKHJlZ2V4cCkgewogICAgaWYgKGlzRGVmaW5lZChyZWdleHApKSB7CiAgICAgICQkc2FuaXRpemVVcmlQcm92aWRlci5hSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdChyZWdleHApOwogICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAkJHNhbml0aXplVXJpUHJvdmlkZXIuYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QoKTsKICAgIH0KICB9OwoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRjb21waWxlUHJvdmlkZXIjaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0CiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJldHJpZXZlcyBvciBvdmVycmlkZXMgdGhlIGRlZmF1bHQgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgdXNlZCBmb3Igd2hpdGVsaXN0aW5nIG9mIHNhZmUKICAgKiB1cmxzIGR1cmluZyBpbWdbc3JjXSBzYW5pdGl6YXRpb24uCiAgICoKICAgKiBUaGUgc2FuaXRpemF0aW9uIGlzIGEgc2VjdXJpdHkgbWVhc3VyZSBhaW1lZCBhdCBwcmV2ZW50IFhTUyBhdHRhY2tzIHZpYSBodG1sIGxpbmtzLgogICAqCiAgICogQW55IHVybCBhYm91dCB0byBiZSBhc3NpZ25lZCB0byBpbWdbc3JjXSB2aWEgZGF0YS1iaW5kaW5nIGlzIGZpcnN0IG5vcm1hbGl6ZWQgYW5kIHR1cm5lZCBpbnRvCiAgICogYW4gYWJzb2x1dGUgdXJsLiBBZnRlcndhcmRzLCB0aGUgdXJsIGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgYGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdGAKICAgKiByZWd1bGFyIGV4cHJlc3Npb24uIElmIGEgbWF0Y2ggaXMgZm91bmQsIHRoZSBvcmlnaW5hbCB1cmwgaXMgd3JpdHRlbiBpbnRvIHRoZSBkb20uIE90aGVyd2lzZSwKICAgKiB0aGUgYWJzb2x1dGUgdXJsIGlzIHByZWZpeGVkIHdpdGggYCd1bnNhZmU6J2Agc3RyaW5nIGFuZCBvbmx5IHRoZW4gaXMgaXQgd3JpdHRlbiBpbnRvIHRoZSBET00uCiAgICoKICAgKiBAcGFyYW0ge1JlZ0V4cD19IHJlZ2V4cCBOZXcgcmVnZXhwIHRvIHdoaXRlbGlzdCB1cmxzIHdpdGguCiAgICogQHJldHVybnMge1JlZ0V4cHxuZy4kY29tcGlsZVByb3ZpZGVyfSBDdXJyZW50IFJlZ0V4cCBpZiBjYWxsZWQgd2l0aG91dCB2YWx1ZSBvciBzZWxmIGZvcgogICAqICAgIGNoYWluaW5nIG90aGVyd2lzZS4KICAgKi8KICB0aGlzLmltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCA9IGZ1bmN0aW9uKHJlZ2V4cCkgewogICAgaWYgKGlzRGVmaW5lZChyZWdleHApKSB7CiAgICAgICQkc2FuaXRpemVVcmlQcm92aWRlci5pbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QocmVnZXhwKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gJCRzYW5pdGl6ZVVyaVByb3ZpZGVyLmltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCgpOwogICAgfQogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAgJGNvbXBpbGVQcm92aWRlciNkZWJ1Z0luZm9FbmFibGVkCiAgICoKICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBlbmFibGVkIHVwZGF0ZSB0aGUgZGVidWdJbmZvRW5hYmxlZCBzdGF0ZSBpZiBwcm92aWRlZCwgb3RoZXJ3aXNlIGp1c3QgcmV0dXJuIHRoZQogICAqIGN1cnJlbnQgZGVidWdJbmZvRW5hYmxlZCBzdGF0ZQogICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICoKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2FsbCB0aGlzIG1ldGhvZCB0byBlbmFibGUvZGlzYWJsZSB2YXJpb3VzIGRlYnVnIHJ1bnRpbWUgaW5mb3JtYXRpb24gaW4gdGhlIGNvbXBpbGVyIHN1Y2ggYXMgYWRkaW5nCiAgICogYmluZGluZyBpbmZvcm1hdGlvbiBhbmQgYSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgc2NvcGUgb24gdG8gRE9NIGVsZW1lbnRzLgogICAqIElmIGVuYWJsZWQsIHRoZSBjb21waWxlciB3aWxsIGFkZCB0aGUgZm9sbG93aW5nIHRvIERPTSBlbGVtZW50cyB0aGF0IGhhdmUgYmVlbiBib3VuZCB0byB0aGUgc2NvcGUKICAgKiAqIGBuZy1iaW5kaW5nYCBDU1MgY2xhc3MKICAgKiAqIGAkYmluZGluZ2AgZGF0YSBwcm9wZXJ0eSBjb250YWluaW5nIGFuIGFycmF5IG9mIHRoZSBiaW5kaW5nIGV4cHJlc3Npb25zCiAgICoKICAgKiBZb3UgbWF5IHdhbnQgdG8gdXNlIHRoaXMgaW4gcHJvZHVjdGlvbiBmb3IgYSBzaWduaWZpY2FudCBwZXJmb3JtYW5jZSBib29zdC4gU2VlCiAgICoge0BsaW5rIGd1aWRlL3Byb2R1Y3Rpb24jZGlzYWJsaW5nLWRlYnVnLWRhdGEgRGlzYWJsaW5nIERlYnVnIERhdGF9IGZvciBtb3JlLgogICAqCiAgICogVGhlIGRlZmF1bHQgdmFsdWUgaXMgdHJ1ZS4KICAgKi8KICB2YXIgZGVidWdJbmZvRW5hYmxlZCA9IHRydWU7CiAgdGhpcy5kZWJ1Z0luZm9FbmFibGVkID0gZnVuY3Rpb24oZW5hYmxlZCkgewogICAgaWYoaXNEZWZpbmVkKGVuYWJsZWQpKSB7CiAgICAgIGRlYnVnSW5mb0VuYWJsZWQgPSBlbmFibGVkOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHJldHVybiBkZWJ1Z0luZm9FbmFibGVkOwogIH07CgogIHRoaXMuJGdldCA9IFsKICAgICAgICAgICAgJyRpbmplY3RvcicsICckaW50ZXJwb2xhdGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJHRlbXBsYXRlUmVxdWVzdCcsICckcGFyc2UnLAogICAgICAgICAgICAnJGNvbnRyb2xsZXInLCAnJHJvb3RTY29wZScsICckZG9jdW1lbnQnLCAnJHNjZScsICckYW5pbWF0ZScsICckJHNhbml0aXplVXJpJywKICAgIGZ1bmN0aW9uKCRpbmplY3RvciwgICAkaW50ZXJwb2xhdGUsICAgJGV4Y2VwdGlvbkhhbmRsZXIsICAgJHRlbXBsYXRlUmVxdWVzdCwgICAkcGFyc2UsCiAgICAgICAgICAgICAkY29udHJvbGxlciwgICAkcm9vdFNjb3BlLCAgICRkb2N1bWVudCwgICAkc2NlLCAgICRhbmltYXRlLCAgICQkc2FuaXRpemVVcmkpIHsKCiAgICB2YXIgQXR0cmlidXRlcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHJpYnV0ZXNUb0NvcHkpIHsKICAgICAgaWYgKGF0dHJpYnV0ZXNUb0NvcHkpIHsKICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGF0dHJpYnV0ZXNUb0NvcHkpOwogICAgICAgIHZhciBpLCBsLCBrZXk7CgogICAgICAgIGZvciAoaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAga2V5ID0ga2V5c1tpXTsKICAgICAgICAgIHRoaXNba2V5XSA9IGF0dHJpYnV0ZXNUb0NvcHlba2V5XTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy4kYXR0ciA9IHt9OwogICAgICB9CgogICAgICB0aGlzLiQkZWxlbWVudCA9IGVsZW1lbnQ7CiAgICB9OwoKICAgIEF0dHJpYnV0ZXMucHJvdG90eXBlID0gewogICAgICAkbm9ybWFsaXplOiBkaXJlY3RpdmVOb3JtYWxpemUsCgoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGFkZENsYXNzCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBBZGRzIHRoZSBDU1MgY2xhc3MgdmFsdWUgc3BlY2lmaWVkIGJ5IHRoZSBjbGFzc1ZhbCBwYXJhbWV0ZXIgdG8gdGhlIGVsZW1lbnQuIElmIGFuaW1hdGlvbnMKICAgICAgICogYXJlIGVuYWJsZWQgdGhlbiBhbiBhbmltYXRpb24gd2lsbCBiZSB0cmlnZ2VyZWQgZm9yIHRoZSBjbGFzcyBhZGRpdGlvbi4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzVmFsIFRoZSBjbGFzc05hbWUgdmFsdWUgdGhhdCB3aWxsIGJlIGFkZGVkIHRvIHRoZSBlbGVtZW50CiAgICAgICAqLwogICAgICAkYWRkQ2xhc3MgOiBmdW5jdGlvbihjbGFzc1ZhbCkgewogICAgICAgIGlmKGNsYXNzVmFsICYmIGNsYXNzVmFsLmxlbmd0aCA+IDApIHsKICAgICAgICAgICRhbmltYXRlLmFkZENsYXNzKHRoaXMuJCRlbGVtZW50LCBjbGFzc1ZhbCk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJHJlbW92ZUNsYXNzCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBSZW1vdmVzIHRoZSBDU1MgY2xhc3MgdmFsdWUgc3BlY2lmaWVkIGJ5IHRoZSBjbGFzc1ZhbCBwYXJhbWV0ZXIgZnJvbSB0aGUgZWxlbWVudC4gSWYKICAgICAgICogYW5pbWF0aW9ucyBhcmUgZW5hYmxlZCB0aGVuIGFuIGFuaW1hdGlvbiB3aWxsIGJlIHRyaWdnZXJlZCBmb3IgdGhlIGNsYXNzIHJlbW92YWwuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc1ZhbCBUaGUgY2xhc3NOYW1lIHZhbHVlIHRoYXQgd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICovCiAgICAgICRyZW1vdmVDbGFzcyA6IGZ1bmN0aW9uKGNsYXNzVmFsKSB7CiAgICAgICAgaWYoY2xhc3NWYWwgJiYgY2xhc3NWYWwubGVuZ3RoID4gMCkgewogICAgICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3ModGhpcy4kJGVsZW1lbnQsIGNsYXNzVmFsKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkdXBkYXRlQ2xhc3MKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEFkZHMgYW5kIHJlbW92ZXMgdGhlIGFwcHJvcHJpYXRlIENTUyBjbGFzcyB2YWx1ZXMgdG8gdGhlIGVsZW1lbnQgYmFzZWQgb24gdGhlIGRpZmZlcmVuY2UKICAgICAgICogYmV0d2VlbiB0aGUgbmV3IGFuZCBvbGQgQ1NTIGNsYXNzIHZhbHVlcyAoc3BlY2lmaWVkIGFzIG5ld0NsYXNzZXMgYW5kIG9sZENsYXNzZXMpLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3Q2xhc3NlcyBUaGUgY3VycmVudCBDU1MgY2xhc3NOYW1lIHZhbHVlCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBvbGRDbGFzc2VzIFRoZSBmb3JtZXIgQ1NTIGNsYXNzTmFtZSB2YWx1ZQogICAgICAgKi8KICAgICAgJHVwZGF0ZUNsYXNzIDogZnVuY3Rpb24obmV3Q2xhc3Nlcywgb2xkQ2xhc3NlcykgewogICAgICAgIHZhciB0b0FkZCA9IHRva2VuRGlmZmVyZW5jZShuZXdDbGFzc2VzLCBvbGRDbGFzc2VzKTsKICAgICAgICBpZiAodG9BZGQgJiYgdG9BZGQubGVuZ3RoKSB7CiAgICAgICAgICAkYW5pbWF0ZS5hZGRDbGFzcyh0aGlzLiQkZWxlbWVudCwgdG9BZGQpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHRvUmVtb3ZlID0gdG9rZW5EaWZmZXJlbmNlKG9sZENsYXNzZXMsIG5ld0NsYXNzZXMpOwogICAgICAgIGlmICh0b1JlbW92ZSAmJiB0b1JlbW92ZS5sZW5ndGgpIHsKICAgICAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKHRoaXMuJCRlbGVtZW50LCB0b1JlbW92ZSk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFNldCBhIG5vcm1hbGl6ZWQgYXR0cmlidXRlIG9uIHRoZSBlbGVtZW50IGluIGEgd2F5IHN1Y2ggdGhhdCBhbGwgZGlyZWN0aXZlcwogICAgICAgKiBjYW4gc2hhcmUgdGhlIGF0dHJpYnV0ZS4gVGhpcyBmdW5jdGlvbiBwcm9wZXJseSBoYW5kbGVzIGJvb2xlYW4gYXR0cmlidXRlcy4KICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBOb3JtYWxpemVkIGtleS4gKGllIG5nQXR0cmlidXRlKQogICAgICAgKiBAcGFyYW0ge3N0cmluZ3xib29sZWFufSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0LiBJZiBgbnVsbGAgYXR0cmlidXRlIHdpbGwgYmUgZGVsZXRlZC4KICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gd3JpdGVBdHRyIElmIGZhbHNlLCBkb2VzIG5vdCB3cml0ZSB0aGUgdmFsdWUgdG8gRE9NIGVsZW1lbnQgYXR0cmlidXRlLgogICAgICAgKiAgICAgRGVmYXVsdHMgdG8gdHJ1ZS4KICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBhdHRyTmFtZSBPcHRpb25hbCBub25lIG5vcm1hbGl6ZWQgbmFtZS4gRGVmYXVsdHMgdG8ga2V5LgogICAgICAgKi8KICAgICAgJHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSwgd3JpdGVBdHRyLCBhdHRyTmFtZSkgewogICAgICAgIC8vIFRPRE86IGRlY2lkZSB3aGV0aGVyIG9yIG5vdCB0byB0aHJvdyBhbiBlcnJvciBpZiAiY2xhc3MiCiAgICAgICAgLy9pcyBzZXQgdGhyb3VnaCB0aGlzIGZ1bmN0aW9uIHNpbmNlIGl0IG1heSBjYXVzZSAkdXBkYXRlQ2xhc3MgdG8KICAgICAgICAvL2JlY29tZSB1bnN0YWJsZS4KCiAgICAgICAgdmFyIG5vZGUgPSB0aGlzLiQkZWxlbWVudFswXSwKICAgICAgICAgICAgYm9vbGVhbktleSA9IGdldEJvb2xlYW5BdHRyTmFtZShub2RlLCBrZXkpLAogICAgICAgICAgICBhbGlhc2VkS2V5ID0gZ2V0QWxpYXNlZEF0dHJOYW1lKG5vZGUsIGtleSksCiAgICAgICAgICAgIG9ic2VydmVyID0ga2V5LAogICAgICAgICAgICBub3JtYWxpemVkVmFsLAogICAgICAgICAgICBub2RlTmFtZTsKCiAgICAgICAgaWYgKGJvb2xlYW5LZXkpIHsKICAgICAgICAgIHRoaXMuJCRlbGVtZW50LnByb3Aoa2V5LCB2YWx1ZSk7CiAgICAgICAgICBhdHRyTmFtZSA9IGJvb2xlYW5LZXk7CiAgICAgICAgfSBlbHNlIGlmKGFsaWFzZWRLZXkpIHsKICAgICAgICAgIHRoaXNbYWxpYXNlZEtleV0gPSB2YWx1ZTsKICAgICAgICAgIG9ic2VydmVyID0gYWxpYXNlZEtleTsKICAgICAgICB9CgogICAgICAgIHRoaXNba2V5XSA9IHZhbHVlOwoKICAgICAgICAvLyB0cmFuc2xhdGUgbm9ybWFsaXplZCBrZXkgdG8gYWN0dWFsIGtleQogICAgICAgIGlmIChhdHRyTmFtZSkgewogICAgICAgICAgdGhpcy4kYXR0cltrZXldID0gYXR0ck5hbWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGF0dHJOYW1lID0gdGhpcy4kYXR0cltrZXldOwogICAgICAgICAgaWYgKCFhdHRyTmFtZSkgewogICAgICAgICAgICB0aGlzLiRhdHRyW2tleV0gPSBhdHRyTmFtZSA9IHNuYWtlX2Nhc2Uoa2V5LCAnLScpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbm9kZU5hbWUgPSBub2RlTmFtZV8odGhpcy4kJGVsZW1lbnQpOwoKICAgICAgICBpZiAoKG5vZGVOYW1lID09PSAnYScgJiYga2V5ID09PSAnaHJlZicpIHx8CiAgICAgICAgICAgIChub2RlTmFtZSA9PT0gJ2ltZycgJiYga2V5ID09PSAnc3JjJykpIHsKICAgICAgICAgIC8vIHNhbml0aXplIGFbaHJlZl0gYW5kIGltZ1tzcmNdIHZhbHVlcwogICAgICAgICAgdGhpc1trZXldID0gdmFsdWUgPSAkJHNhbml0aXplVXJpKHZhbHVlLCBrZXkgPT09ICdzcmMnKTsKICAgICAgICB9IGVsc2UgaWYgKG5vZGVOYW1lID09PSAnaW1nJyAmJiBrZXkgPT09ICdzcmNzZXQnKSB7CiAgICAgICAgICAvLyBzYW5pdGl6ZSBpbWdbc3Jjc2V0XSB2YWx1ZXMKICAgICAgICAgIHZhciByZXN1bHQgPSAiIjsKCiAgICAgICAgICAvLyBmaXJzdCBjaGVjayBpZiB0aGVyZSBhcmUgc3BhY2VzIGJlY2F1c2UgaXQncyBub3QgdGhlIHNhbWUgcGF0dGVybgogICAgICAgICAgdmFyIHRyaW1tZWRTcmNzZXQgPSB0cmltKHZhbHVlKTsKICAgICAgICAgIC8vICAgICAgICAgICAgICAgICggICA5OTl4ICAgLHwgICA5OTl3ICAgLHwgICAsfCwgICApCiAgICAgICAgICB2YXIgc3JjUGF0dGVybiA9IC8oXHMrXGQreFxzKix8XHMrXGQrd1xzKix8XHMrLHwsXHMrKS87CiAgICAgICAgICB2YXIgcGF0dGVybiA9IC9ccy8udGVzdCh0cmltbWVkU3Jjc2V0KSA/IHNyY1BhdHRlcm4gOiAvKCwpLzsKCiAgICAgICAgICAvLyBzcGxpdCBzcmNzZXQgaW50byB0dXBsZSBvZiB1cmkgYW5kIGRlc2NyaXB0b3IgZXhjZXB0IGZvciB0aGUgbGFzdCBpdGVtCiAgICAgICAgICB2YXIgcmF3VXJpcyA9IHRyaW1tZWRTcmNzZXQuc3BsaXQocGF0dGVybik7CgogICAgICAgICAgLy8gZm9yIGVhY2ggdHVwbGVzCiAgICAgICAgICB2YXIgbmJyVXJpc1dpdGgycGFydHMgPSBNYXRoLmZsb29yKHJhd1VyaXMubGVuZ3RoIC8gMik7CiAgICAgICAgICBmb3IgKHZhciBpPTA7IGk8bmJyVXJpc1dpdGgycGFydHM7IGkrKykgewogICAgICAgICAgICB2YXIgaW5uZXJJZHggPSBpKjI7CiAgICAgICAgICAgIC8vIHNhbml0aXplIHRoZSB1cmkKICAgICAgICAgICAgcmVzdWx0ICs9ICQkc2FuaXRpemVVcmkodHJpbSggcmF3VXJpc1tpbm5lcklkeF0pLCB0cnVlKTsKICAgICAgICAgICAgLy8gYWRkIHRoZSBkZXNjcmlwdG9yCiAgICAgICAgICAgIHJlc3VsdCArPSAoICIgIiArIHRyaW0ocmF3VXJpc1tpbm5lcklkeCsxXSkpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIHNwbGl0IHRoZSBsYXN0IGl0ZW0gaW50byB1cmkgYW5kIGRlc2NyaXB0b3IKICAgICAgICAgIHZhciBsYXN0VHVwbGUgPSB0cmltKHJhd1VyaXNbaSoyXSkuc3BsaXQoL1xzLyk7CgogICAgICAgICAgLy8gc2FuaXRpemUgdGhlIGxhc3QgdXJpCiAgICAgICAgICByZXN1bHQgKz0gJCRzYW5pdGl6ZVVyaSh0cmltKGxhc3RUdXBsZVswXSksIHRydWUpOwoKICAgICAgICAgIC8vIGFuZCBhZGQgdGhlIGxhc3QgZGVzY3JpcHRvciBpZiBhbnkKICAgICAgICAgIGlmKCBsYXN0VHVwbGUubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAgIHJlc3VsdCArPSAoIiAiICsgdHJpbShsYXN0VHVwbGVbMV0pKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlID0gcmVzdWx0OwogICAgICAgIH0KCiAgICAgICAgaWYgKHdyaXRlQXR0ciAhPT0gZmFsc2UpIHsKICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50LnJlbW92ZUF0dHIoYXR0ck5hbWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQuYXR0cihhdHRyTmFtZSwgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gZmlyZSBvYnNlcnZlcnMKICAgICAgICB2YXIgJCRvYnNlcnZlcnMgPSB0aGlzLiQkb2JzZXJ2ZXJzOwogICAgICAgICQkb2JzZXJ2ZXJzICYmIGZvckVhY2goJCRvYnNlcnZlcnNbb2JzZXJ2ZXJdLCBmdW5jdGlvbihmbikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZm4odmFsdWUpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkb2JzZXJ2ZQogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogT2JzZXJ2ZXMgYW4gaW50ZXJwb2xhdGVkIGF0dHJpYnV0ZS4KICAgICAgICoKICAgICAgICogVGhlIG9ic2VydmVyIGZ1bmN0aW9uIHdpbGwgYmUgaW52b2tlZCBvbmNlIGR1cmluZyB0aGUgbmV4dCBgJGRpZ2VzdGAgZm9sbG93aW5nCiAgICAgICAqIGNvbXBpbGF0aW9uLiBUaGUgb2JzZXJ2ZXIgaXMgdGhlbiBpbnZva2VkIHdoZW5ldmVyIHRoZSBpbnRlcnBvbGF0ZWQgdmFsdWUKICAgICAgICogY2hhbmdlcy4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBOb3JtYWxpemVkIGtleS4gKGllIG5nQXR0cmlidXRlKSAuCiAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oaW50ZXJwb2xhdGVkVmFsdWUpfSBmbiBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW5ldmVyCiAgICAgICAgICAgICAgICB0aGUgaW50ZXJwb2xhdGVkIHZhbHVlIG9mIHRoZSBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgICogICAgICAgIFNlZSB0aGUge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSN0ZXh0LWFuZC1hdHRyaWJ1dGUtYmluZGluZ3MgRGlyZWN0aXZlc30gZ3VpZGUgZm9yIG1vcmUgaW5mby4KICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBvYnNlcnZlci4KICAgICAgICovCiAgICAgICRvYnNlcnZlOiBmdW5jdGlvbihrZXksIGZuKSB7CiAgICAgICAgdmFyIGF0dHJzID0gdGhpcywKICAgICAgICAgICAgJCRvYnNlcnZlcnMgPSAoYXR0cnMuJCRvYnNlcnZlcnMgfHwgKGF0dHJzLiQkb2JzZXJ2ZXJzID0gY3JlYXRlTWFwKCkpKSwKICAgICAgICAgICAgbGlzdGVuZXJzID0gKCQkb2JzZXJ2ZXJzW2tleV0gfHwgKCQkb2JzZXJ2ZXJzW2tleV0gPSBbXSkpOwoKICAgICAgICBsaXN0ZW5lcnMucHVzaChmbik7CiAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKCFsaXN0ZW5lcnMuJCRpbnRlcikgewogICAgICAgICAgICAvLyBubyBvbmUgcmVnaXN0ZXJlZCBhdHRyaWJ1dGUgaW50ZXJwb2xhdGlvbiBmdW5jdGlvbiwgc28gbGV0cyBjYWxsIGl0IG1hbnVhbGx5CiAgICAgICAgICAgIGZuKGF0dHJzW2tleV0pOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICBhcnJheVJlbW92ZShsaXN0ZW5lcnMsIGZuKTsKICAgICAgICB9OwogICAgICB9CiAgICB9OwoKCiAgICBmdW5jdGlvbiBzYWZlQWRkQ2xhc3MoJGVsZW1lbnQsIGNsYXNzTmFtZSkgewogICAgICB0cnkgewogICAgICAgICRlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIC8vIGlnbm9yZSwgc2luY2UgaXQgbWVhbnMgdGhhdCB3ZSBhcmUgdHJ5aW5nIHRvIHNldCBjbGFzcyBvbgogICAgICAgIC8vIFNWRyBlbGVtZW50LCB3aGVyZSBjbGFzcyBuYW1lIGlzIHJlYWQtb25seS4KICAgICAgfQogICAgfQoKCiAgICB2YXIgc3RhcnRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2woKSwKICAgICAgICBlbmRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sKCksCiAgICAgICAgZGVub3JtYWxpemVUZW1wbGF0ZSA9IChzdGFydFN5bWJvbCA9PSAne3snIHx8IGVuZFN5bWJvbCAgPT0gJ319JykKICAgICAgICAgICAgPyBpZGVudGl0eQogICAgICAgICAgICA6IGZ1bmN0aW9uIGRlbm9ybWFsaXplVGVtcGxhdGUodGVtcGxhdGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGUucmVwbGFjZSgvXHtcey9nLCBzdGFydFN5bWJvbCkucmVwbGFjZSgvfX0vZywgZW5kU3ltYm9sKTsKICAgICAgICB9LAogICAgICAgIE5HX0FUVFJfQklORElORyA9IC9ebmdBdHRyW0EtWl0vOwoKICAgIGNvbXBpbGUuJCRhZGRCaW5kaW5nSW5mbyA9IGRlYnVnSW5mb0VuYWJsZWQgPyBmdW5jdGlvbiAkJGFkZEJpbmRpbmdJbmZvKCRlbGVtZW50LCBiaW5kaW5nKSB7CiAgICAgIHZhciBiaW5kaW5ncyA9ICRlbGVtZW50LmRhdGEoJyRiaW5kaW5nJykgfHwgW107CgogICAgICBpZiAoaXNBcnJheShiaW5kaW5nKSkgewogICAgICAgIGJpbmRpbmdzID0gYmluZGluZ3MuY29uY2F0KGJpbmRpbmcpOwogICAgICB9IGVsc2UgewogICAgICAgIGJpbmRpbmdzLnB1c2goYmluZGluZyk7CiAgICAgIH0KCiAgICAgICRlbGVtZW50LmRhdGEoJyRiaW5kaW5nJywgYmluZGluZ3MpOwogICAgfSA6IG5vb3A7CgogICAgY29tcGlsZS4kJGFkZEJpbmRpbmdDbGFzcyA9IGRlYnVnSW5mb0VuYWJsZWQgPyBmdW5jdGlvbiAkJGFkZEJpbmRpbmdDbGFzcygkZWxlbWVudCkgewogICAgICBzYWZlQWRkQ2xhc3MoJGVsZW1lbnQsICduZy1iaW5kaW5nJyk7CiAgICB9IDogbm9vcDsKCiAgICBjb21waWxlLiQkYWRkU2NvcGVJbmZvID0gZGVidWdJbmZvRW5hYmxlZCA/IGZ1bmN0aW9uICQkYWRkU2NvcGVJbmZvKCRlbGVtZW50LCBzY29wZSwgaXNvbGF0ZWQsIG5vVGVtcGxhdGUpIHsKICAgICAgdmFyIGRhdGFOYW1lID0gaXNvbGF0ZWQgPyAobm9UZW1wbGF0ZSA/ICckaXNvbGF0ZVNjb3BlTm9UZW1wbGF0ZScgOiAnJGlzb2xhdGVTY29wZScpIDogJyRzY29wZSc7CiAgICAgICRlbGVtZW50LmRhdGEoZGF0YU5hbWUsIHNjb3BlKTsKICAgIH0gOiBub29wOwoKICAgIGNvbXBpbGUuJCRhZGRTY29wZUNsYXNzID0gZGVidWdJbmZvRW5hYmxlZCA/IGZ1bmN0aW9uICQkYWRkU2NvcGVDbGFzcygkZWxlbWVudCwgaXNvbGF0ZWQpIHsKICAgICAgc2FmZUFkZENsYXNzKCRlbGVtZW50LCBpc29sYXRlZCA/ICduZy1pc29sYXRlLXNjb3BlJyA6ICduZy1zY29wZScpOwogICAgfSA6IG5vb3A7CgogICAgcmV0dXJuIGNvbXBpbGU7CgogICAgLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKICAgIGZ1bmN0aW9uIGNvbXBpbGUoJGNvbXBpbGVOb2RlcywgdHJhbnNjbHVkZUZuLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0NvbXBpbGVDb250ZXh0KSB7CiAgICAgIGlmICghKCRjb21waWxlTm9kZXMgaW5zdGFuY2VvZiBqcUxpdGUpKSB7CiAgICAgICAgLy8ganF1ZXJ5IGFsd2F5cyByZXdyYXBzLCB3aGVyZWFzIHdlIG5lZWQgdG8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHNlbGVjdG9yIHNvIHRoYXQgd2UgY2FuCiAgICAgICAgLy8gbW9kaWZ5IGl0LgogICAgICAgICRjb21waWxlTm9kZXMgPSBqcUxpdGUoJGNvbXBpbGVOb2Rlcyk7CiAgICAgIH0KICAgICAgLy8gV2UgY2FuIG5vdCBjb21waWxlIHRvcCBsZXZlbCB0ZXh0IGVsZW1lbnRzIHNpbmNlIHRleHQgbm9kZXMgY2FuIGJlIG1lcmdlZCBhbmQgd2Ugd2lsbAogICAgICAvLyBub3QgYmUgYWJsZSB0byBhdHRhY2ggc2NvcGUgZGF0YSB0byB0aGVtLCBzbyB3ZSB3aWxsIHdyYXAgdGhlbSBpbiA8c3Bhbj4KICAgICAgZm9yRWFjaCgkY29tcGlsZU5vZGVzLCBmdW5jdGlvbihub2RlLCBpbmRleCl7CiAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gTk9ERV9UWVBFX1RFWFQgJiYgbm9kZS5ub2RlVmFsdWUubWF0Y2goL1xTKy8pIC8qIG5vbi1lbXB0eSAqLyApIHsKICAgICAgICAgICRjb21waWxlTm9kZXNbaW5kZXhdID0ganFMaXRlKG5vZGUpLndyYXAoJzxzcGFuPjwvc3Bhbj4nKS5wYXJlbnQoKVswXTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB2YXIgY29tcG9zaXRlTGlua0ZuID0KICAgICAgICAgICAgICBjb21waWxlTm9kZXMoJGNvbXBpbGVOb2RlcywgdHJhbnNjbHVkZUZuLCAkY29tcGlsZU5vZGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlLCBwcmV2aW91c0NvbXBpbGVDb250ZXh0KTsKICAgICAgY29tcGlsZS4kJGFkZFNjb3BlQ2xhc3MoJGNvbXBpbGVOb2Rlcyk7CiAgICAgIHZhciBuYW1lc3BhY2UgPSBudWxsOwogICAgICByZXR1cm4gZnVuY3Rpb24gcHVibGljTGlua0ZuKHNjb3BlLCBjbG9uZUNvbm5lY3RGbiwgdHJhbnNjbHVkZUNvbnRyb2xsZXJzLCBwYXJlbnRCb3VuZFRyYW5zY2x1ZGVGbiwgZnV0dXJlUGFyZW50RWxlbWVudCl7CiAgICAgICAgYXNzZXJ0QXJnKHNjb3BlLCAnc2NvcGUnKTsKICAgICAgICBpZiAoIW5hbWVzcGFjZSkgewogICAgICAgICAgbmFtZXNwYWNlID0gZGV0ZWN0TmFtZXNwYWNlRm9yQ2hpbGRFbGVtZW50cyhmdXR1cmVQYXJlbnRFbGVtZW50KTsKICAgICAgICB9CiAgICAgICAgdmFyICRsaW5rTm9kZTsKICAgICAgICBpZiAobmFtZXNwYWNlICE9PSAnaHRtbCcpIHsKICAgICAgICAgIC8vIFdoZW4gdXNpbmcgYSBkaXJlY3RpdmUgd2l0aCByZXBsYWNlOnRydWUgYW5kIHRlbXBsYXRlVXJsIHRoZSAkY29tcGlsZU5vZGVzCiAgICAgICAgICAvLyAob3IgYSBjaGlsZCBlbGVtZW50IGluc2lkZSBvZiB0aGVtKQogICAgICAgICAgLy8gbWlnaHQgY2hhbmdlLCBzbyB3ZSBuZWVkIHRvIHJlY3JlYXRlIHRoZSBuYW1lc3BhY2UgYWRhcHRlZCBjb21waWxlTm9kZXMKICAgICAgICAgIC8vIGZvciBjYWxsIHRvIHRoZSBsaW5rIGZ1bmN0aW9uLgogICAgICAgICAgLy8gTm90ZTogVGhpcyB3aWxsIGFscmVhZHkgY2xvbmUgdGhlIG5vZGVzLi4uCiAgICAgICAgICAkbGlua05vZGUgPSBqcUxpdGUoCiAgICAgICAgICAgIHdyYXBUZW1wbGF0ZShuYW1lc3BhY2UsIGpxTGl0ZSgnPGRpdj4nKS5hcHBlbmQoJGNvbXBpbGVOb2RlcykuaHRtbCgpKQogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKGNsb25lQ29ubmVjdEZuKSB7CiAgICAgICAgICAvLyBpbXBvcnRhbnQhITogd2UgbXVzdCBjYWxsIG91ciBqcUxpdGUuY2xvbmUoKSBzaW5jZSB0aGUgalF1ZXJ5IG9uZSBpcyB0cnlpbmcgdG8gYmUgc21hcnQKICAgICAgICAgIC8vIGFuZCBzb21ldGltZXMgY2hhbmdlcyB0aGUgc3RydWN0dXJlIG9mIHRoZSBET00uCiAgICAgICAgICAkbGlua05vZGUgPSBKUUxpdGVQcm90b3R5cGUuY2xvbmUuY2FsbCgkY29tcGlsZU5vZGVzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgJGxpbmtOb2RlID0gJGNvbXBpbGVOb2RlczsKICAgICAgICB9CgogICAgICAgIGlmICh0cmFuc2NsdWRlQ29udHJvbGxlcnMpIHsKICAgICAgICAgIGZvciAodmFyIGNvbnRyb2xsZXJOYW1lIGluIHRyYW5zY2x1ZGVDb250cm9sbGVycykgewogICAgICAgICAgICAkbGlua05vZGUuZGF0YSgnJCcgKyBjb250cm9sbGVyTmFtZSArICdDb250cm9sbGVyJywgdHJhbnNjbHVkZUNvbnRyb2xsZXJzW2NvbnRyb2xsZXJOYW1lXS5pbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjb21waWxlLiQkYWRkU2NvcGVJbmZvKCRsaW5rTm9kZSwgc2NvcGUpOwoKICAgICAgICBpZiAoY2xvbmVDb25uZWN0Rm4pIGNsb25lQ29ubmVjdEZuKCRsaW5rTm9kZSwgc2NvcGUpOwogICAgICAgIGlmIChjb21wb3NpdGVMaW5rRm4pIGNvbXBvc2l0ZUxpbmtGbihzY29wZSwgJGxpbmtOb2RlLCAkbGlua05vZGUsIHBhcmVudEJvdW5kVHJhbnNjbHVkZUZuKTsKICAgICAgICByZXR1cm4gJGxpbmtOb2RlOwogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGRldGVjdE5hbWVzcGFjZUZvckNoaWxkRWxlbWVudHMocGFyZW50RWxlbWVudCkgewogICAgICAvLyBUT0RPOiBNYWtlIHRoaXMgZGV0ZWN0IE1hdGhNTCBhcyB3ZWxsLi4uCiAgICAgIHZhciBub2RlID0gcGFyZW50RWxlbWVudCAmJiBwYXJlbnRFbGVtZW50WzBdOwogICAgICBpZiAoIW5vZGUpIHsKICAgICAgICByZXR1cm4gJ2h0bWwnOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBub2RlTmFtZV8obm9kZSkgIT09ICdmb3JlaWdub2JqZWN0JyAmJiBub2RlLnRvU3RyaW5nKCkubWF0Y2goL1NWRy8pID8gJ3N2Zyc6ICdodG1sJzsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQ29tcGlsZSBmdW5jdGlvbiBtYXRjaGVzIGVhY2ggbm9kZSBpbiBub2RlTGlzdCBhZ2FpbnN0IHRoZSBkaXJlY3RpdmVzLiBPbmNlIGFsbCBkaXJlY3RpdmVzCiAgICAgKiBmb3IgYSBwYXJ0aWN1bGFyIG5vZGUgYXJlIGNvbGxlY3RlZCB0aGVpciBjb21waWxlIGZ1bmN0aW9ucyBhcmUgZXhlY3V0ZWQuIFRoZSBjb21waWxlCiAgICAgKiBmdW5jdGlvbnMgcmV0dXJuIHZhbHVlcyAtIHRoZSBsaW5raW5nIGZ1bmN0aW9ucyAtIGFyZSBjb21iaW5lZCBpbnRvIGEgY29tcG9zaXRlIGxpbmtpbmcKICAgICAqIGZ1bmN0aW9uLCB3aGljaCBpcyB0aGUgYSBsaW5raW5nIGZ1bmN0aW9uIGZvciB0aGUgbm9kZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge05vZGVMaXN0fSBub2RlTGlzdCBhbiBhcnJheSBvZiBub2RlcyBvciBOb2RlTGlzdCB0byBjb21waWxlCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGFuZ3VsYXIuU2NvcGUsIGNsb25lQXR0YWNoRm49KX0gdHJhbnNjbHVkZUZuIEEgbGlua2luZyBmdW5jdGlvbiwgd2hlcmUgdGhlCiAgICAgKiAgICAgICAgc2NvcGUgYXJndW1lbnQgaXMgYXV0by1nZW5lcmF0ZWQgdG8gdGhlIG5ldyBjaGlsZCBvZiB0aGUgdHJhbnNjbHVkZWQgcGFyZW50IHNjb3BlLgogICAgICogQHBhcmFtIHtET01FbGVtZW50PX0gJHJvb3RFbGVtZW50IElmIHRoZSBub2RlTGlzdCBpcyB0aGUgcm9vdCBvZiB0aGUgY29tcGlsYXRpb24gdHJlZSB0aGVuCiAgICAgKiAgICAgICAgdGhlIHJvb3RFbGVtZW50IG11c3QgYmUgc2V0IHRoZSBqcUxpdGUgY29sbGVjdGlvbiBvZiB0aGUgY29tcGlsZSByb290LiBUaGlzIGlzCiAgICAgKiAgICAgICAgbmVlZGVkIHNvIHRoYXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIGl0ZW1zIGNhbiBiZSByZXBsYWNlZCB3aXRoIHdpZGdldHMuCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG1heFByaW9yaXR5IE1heCBkaXJlY3RpdmUgcHJpb3JpdHkuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IEEgY29tcG9zaXRlIGxpbmtpbmcgZnVuY3Rpb24gb2YgYWxsIG9mIHRoZSBtYXRjaGVkIGRpcmVjdGl2ZXMgb3IgbnVsbC4KICAgICAqLwogICAgZnVuY3Rpb24gY29tcGlsZU5vZGVzKG5vZGVMaXN0LCB0cmFuc2NsdWRlRm4sICRyb290RWxlbWVudCwgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpIHsKICAgICAgdmFyIGxpbmtGbnMgPSBbXSwKICAgICAgICAgIGF0dHJzLCBkaXJlY3RpdmVzLCBub2RlTGlua0ZuLCBjaGlsZE5vZGVzLCBjaGlsZExpbmtGbiwgbGlua0ZuRm91bmQsIG5vZGVMaW5rRm5Gb3VuZDsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZUxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICBhdHRycyA9IG5ldyBBdHRyaWJ1dGVzKCk7CgogICAgICAgIC8vIHdlIG11c3QgYWx3YXlzIHJlZmVyIHRvIG5vZGVMaXN0W2ldIHNpbmNlIHRoZSBub2RlcyBjYW4gYmUgcmVwbGFjZWQgdW5kZXJuZWF0aCB1cy4KICAgICAgICBkaXJlY3RpdmVzID0gY29sbGVjdERpcmVjdGl2ZXMobm9kZUxpc3RbaV0sIFtdLCBhdHRycywgaSA9PT0gMCA/IG1heFByaW9yaXR5IDogdW5kZWZpbmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWdub3JlRGlyZWN0aXZlKTsKCiAgICAgICAgbm9kZUxpbmtGbiA9IChkaXJlY3RpdmVzLmxlbmd0aCkKICAgICAgICAgICAgPyBhcHBseURpcmVjdGl2ZXNUb05vZGUoZGlyZWN0aXZlcywgbm9kZUxpc3RbaV0sIGF0dHJzLCB0cmFuc2NsdWRlRm4sICRyb290RWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudWxsLCBbXSwgW10sIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpCiAgICAgICAgICAgIDogbnVsbDsKCiAgICAgICAgaWYgKG5vZGVMaW5rRm4gJiYgbm9kZUxpbmtGbi5zY29wZSkgewogICAgICAgICAgY29tcGlsZS4kJGFkZFNjb3BlQ2xhc3MoYXR0cnMuJCRlbGVtZW50KTsKICAgICAgICB9CgogICAgICAgIGNoaWxkTGlua0ZuID0gKG5vZGVMaW5rRm4gJiYgbm9kZUxpbmtGbi50ZXJtaW5hbCB8fAogICAgICAgICAgICAgICAgICAgICAgIShjaGlsZE5vZGVzID0gbm9kZUxpc3RbaV0uY2hpbGROb2RlcykgfHwKICAgICAgICAgICAgICAgICAgICAgICFjaGlsZE5vZGVzLmxlbmd0aCkKICAgICAgICAgICAgPyBudWxsCiAgICAgICAgICAgIDogY29tcGlsZU5vZGVzKGNoaWxkTm9kZXMsCiAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA/ICgKICAgICAgICAgICAgICAgICAgKG5vZGVMaW5rRm4udHJhbnNjbHVkZU9uVGhpc0VsZW1lbnQgfHwgIW5vZGVMaW5rRm4udGVtcGxhdGVPblRoaXNFbGVtZW50KQogICAgICAgICAgICAgICAgICAgICAmJiBub2RlTGlua0ZuLnRyYW5zY2x1ZGUpIDogdHJhbnNjbHVkZUZuKTsKCiAgICAgICAgaWYgKG5vZGVMaW5rRm4gfHwgY2hpbGRMaW5rRm4pIHsKICAgICAgICAgIGxpbmtGbnMucHVzaChpLCBub2RlTGlua0ZuLCBjaGlsZExpbmtGbik7CiAgICAgICAgICBsaW5rRm5Gb3VuZCA9IHRydWU7CiAgICAgICAgICBub2RlTGlua0ZuRm91bmQgPSBub2RlTGlua0ZuRm91bmQgfHwgbm9kZUxpbmtGbjsKICAgICAgICB9CgogICAgICAgIC8vdXNlIHRoZSBwcmV2aW91cyBjb250ZXh0IG9ubHkgZm9yIHRoZSBmaXJzdCBlbGVtZW50IGluIHRoZSB2aXJ0dWFsIGdyb3VwCiAgICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dCA9IG51bGw7CiAgICAgIH0KCiAgICAgIC8vIHJldHVybiBhIGxpbmtpbmcgZnVuY3Rpb24gaWYgd2UgaGF2ZSBmb3VuZCBhbnl0aGluZywgbnVsbCBvdGhlcndpc2UKICAgICAgcmV0dXJuIGxpbmtGbkZvdW5kID8gY29tcG9zaXRlTGlua0ZuIDogbnVsbDsKCiAgICAgIGZ1bmN0aW9uIGNvbXBvc2l0ZUxpbmtGbihzY29wZSwgbm9kZUxpc3QsICRyb290RWxlbWVudCwgcGFyZW50Qm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICB2YXIgbm9kZUxpbmtGbiwgY2hpbGRMaW5rRm4sIG5vZGUsIGNoaWxkU2NvcGUsIGksIGlpLCBpZHgsIGNoaWxkQm91bmRUcmFuc2NsdWRlRm47CiAgICAgICAgdmFyIHN0YWJsZU5vZGVMaXN0OwoKCiAgICAgICAgaWYgKG5vZGVMaW5rRm5Gb3VuZCkgewogICAgICAgICAgLy8gY29weSBub2RlTGlzdCBzbyB0aGF0IGlmIGEgbm9kZUxpbmtGbiByZW1vdmVzIG9yIGFkZHMgYW4gZWxlbWVudCBhdCB0aGlzIERPTSBsZXZlbCBvdXIKICAgICAgICAgIC8vIG9mZnNldHMgZG9uJ3QgZ2V0IHNjcmV3ZWQgdXAKICAgICAgICAgIHZhciBub2RlTGlzdExlbmd0aCA9IG5vZGVMaXN0Lmxlbmd0aDsKICAgICAgICAgIHN0YWJsZU5vZGVMaXN0ID0gbmV3IEFycmF5KG5vZGVMaXN0TGVuZ3RoKTsKCiAgICAgICAgICAvLyBjcmVhdGUgYSBzcGFyc2UgYXJyYXkgYnkgb25seSBjb3B5aW5nIHRoZSBlbGVtZW50cyB3aGljaCBoYXZlIGEgbGlua0ZuCiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGlua0Zucy5sZW5ndGg7IGkrPTMpIHsKICAgICAgICAgICAgaWR4ID0gbGlua0Zuc1tpXTsKICAgICAgICAgICAgc3RhYmxlTm9kZUxpc3RbaWR4XSA9IG5vZGVMaXN0W2lkeF07CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0YWJsZU5vZGVMaXN0ID0gbm9kZUxpc3Q7CiAgICAgICAgfQoKICAgICAgICBmb3IoaSA9IDAsIGlpID0gbGlua0Zucy5sZW5ndGg7IGkgPCBpaTspIHsKICAgICAgICAgIG5vZGUgPSBzdGFibGVOb2RlTGlzdFtsaW5rRm5zW2krK11dOwogICAgICAgICAgbm9kZUxpbmtGbiA9IGxpbmtGbnNbaSsrXTsKICAgICAgICAgIGNoaWxkTGlua0ZuID0gbGlua0Zuc1tpKytdOwoKICAgICAgICAgIGlmIChub2RlTGlua0ZuKSB7CiAgICAgICAgICAgIGlmIChub2RlTGlua0ZuLnNjb3BlKSB7CiAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlLiRuZXcoKTsKICAgICAgICAgICAgICBjb21waWxlLiQkYWRkU2NvcGVJbmZvKGpxTGl0ZShub2RlKSwgY2hpbGRTY29wZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIG5vZGVMaW5rRm4udHJhbnNjbHVkZU9uVGhpc0VsZW1lbnQgKSB7CiAgICAgICAgICAgICAgY2hpbGRCb3VuZFRyYW5zY2x1ZGVGbiA9IGNyZWF0ZUJvdW5kVHJhbnNjbHVkZUZuKAogICAgICAgICAgICAgICAgICBzY29wZSwgbm9kZUxpbmtGbi50cmFuc2NsdWRlLCBwYXJlbnRCb3VuZFRyYW5zY2x1ZGVGbiwKICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbi5lbGVtZW50VHJhbnNjbHVkZU9uVGhpc0VsZW1lbnQpOwoKICAgICAgICAgICAgfSBlbHNlIGlmICghbm9kZUxpbmtGbi50ZW1wbGF0ZU9uVGhpc0VsZW1lbnQgJiYgcGFyZW50Qm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICAgICAgICBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuID0gcGFyZW50Qm91bmRUcmFuc2NsdWRlRm47CgogICAgICAgICAgICB9IGVsc2UgaWYgKCFwYXJlbnRCb3VuZFRyYW5zY2x1ZGVGbiAmJiB0cmFuc2NsdWRlRm4pIHsKICAgICAgICAgICAgICBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuID0gY3JlYXRlQm91bmRUcmFuc2NsdWRlRm4oc2NvcGUsIHRyYW5zY2x1ZGVGbik7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNoaWxkQm91bmRUcmFuc2NsdWRlRm4gPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBub2RlTGlua0ZuKGNoaWxkTGlua0ZuLCBjaGlsZFNjb3BlLCBub2RlLCAkcm9vdEVsZW1lbnQsIGNoaWxkQm91bmRUcmFuc2NsdWRlRm4pOwoKICAgICAgICAgIH0gZWxzZSBpZiAoY2hpbGRMaW5rRm4pIHsKICAgICAgICAgICAgY2hpbGRMaW5rRm4oc2NvcGUsIG5vZGUuY2hpbGROb2RlcywgdW5kZWZpbmVkLCBwYXJlbnRCb3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlQm91bmRUcmFuc2NsdWRlRm4oc2NvcGUsIHRyYW5zY2x1ZGVGbiwgcHJldmlvdXNCb3VuZFRyYW5zY2x1ZGVGbiwgZWxlbWVudFRyYW5zY2x1c2lvbikgewoKICAgICAgdmFyIGJvdW5kVHJhbnNjbHVkZUZuID0gZnVuY3Rpb24odHJhbnNjbHVkZWRTY29wZSwgY2xvbmVGbiwgY29udHJvbGxlcnMsIGZ1dHVyZVBhcmVudEVsZW1lbnQsIGNvbnRhaW5pbmdTY29wZSkgewoKICAgICAgICBpZiAoIXRyYW5zY2x1ZGVkU2NvcGUpIHsKICAgICAgICAgIHRyYW5zY2x1ZGVkU2NvcGUgPSBzY29wZS4kbmV3KGZhbHNlLCBjb250YWluaW5nU2NvcGUpOwogICAgICAgICAgdHJhbnNjbHVkZWRTY29wZS4kJHRyYW5zY2x1ZGVkID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cmFuc2NsdWRlRm4odHJhbnNjbHVkZWRTY29wZSwgY2xvbmVGbiwgY29udHJvbGxlcnMsIHByZXZpb3VzQm91bmRUcmFuc2NsdWRlRm4sIGZ1dHVyZVBhcmVudEVsZW1lbnQpOwogICAgICB9OwoKICAgICAgcmV0dXJuIGJvdW5kVHJhbnNjbHVkZUZuOwogICAgfQoKICAgIC8qKgogICAgICogTG9va3MgZm9yIGRpcmVjdGl2ZXMgb24gdGhlIGdpdmVuIG5vZGUgYW5kIGFkZHMgdGhlbSB0byB0aGUgZGlyZWN0aXZlIGNvbGxlY3Rpb24gd2hpY2ggaXMKICAgICAqIHNvcnRlZC4KICAgICAqCiAgICAgKiBAcGFyYW0gbm9kZSBOb2RlIHRvIHNlYXJjaC4KICAgICAqIEBwYXJhbSBkaXJlY3RpdmVzIEFuIGFycmF5IHRvIHdoaWNoIHRoZSBkaXJlY3RpdmVzIGFyZSBhZGRlZCB0by4gVGhpcyBhcnJheSBpcyBzb3J0ZWQgYmVmb3JlCiAgICAgKiAgICAgICAgdGhlIGZ1bmN0aW9uIHJldHVybnMuCiAgICAgKiBAcGFyYW0gYXR0cnMgVGhlIHNoYXJlZCBhdHRycyBvYmplY3Qgd2hpY2ggaXMgdXNlZCB0byBwb3B1bGF0ZSB0aGUgbm9ybWFsaXplZCBhdHRyaWJ1dGVzLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBtYXhQcmlvcml0eSBNYXggZGlyZWN0aXZlIHByaW9yaXR5LgogICAgICovCiAgICBmdW5jdGlvbiBjb2xsZWN0RGlyZWN0aXZlcyhub2RlLCBkaXJlY3RpdmVzLCBhdHRycywgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSkgewogICAgICB2YXIgbm9kZVR5cGUgPSBub2RlLm5vZGVUeXBlLAogICAgICAgICAgYXR0cnNNYXAgPSBhdHRycy4kYXR0ciwKICAgICAgICAgIG1hdGNoLAogICAgICAgICAgY2xhc3NOYW1lOwoKICAgICAgc3dpdGNoKG5vZGVUeXBlKSB7CiAgICAgICAgY2FzZSBOT0RFX1RZUEVfRUxFTUVOVDogLyogRWxlbWVudCAqLwogICAgICAgICAgLy8gdXNlIHRoZSBub2RlIG5hbWU6IDxkaXJlY3RpdmU+CiAgICAgICAgICBhZGREaXJlY3RpdmUoZGlyZWN0aXZlcywKICAgICAgICAgICAgICBkaXJlY3RpdmVOb3JtYWxpemUobm9kZU5hbWVfKG5vZGUpKSwgJ0UnLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlKTsKCiAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgdGhlIGF0dHJpYnV0ZXMKICAgICAgICAgIGZvciAodmFyIGF0dHIsIG5hbWUsIG5OYW1lLCBuZ0F0dHJOYW1lLCB2YWx1ZSwgaXNOZ0F0dHIsIG5BdHRycyA9IG5vZGUuYXR0cmlidXRlcywKICAgICAgICAgICAgICAgICAgIGogPSAwLCBqaiA9IG5BdHRycyAmJiBuQXR0cnMubGVuZ3RoOyBqIDwgamo7IGorKykgewogICAgICAgICAgICB2YXIgYXR0clN0YXJ0TmFtZSA9IGZhbHNlOwogICAgICAgICAgICB2YXIgYXR0ckVuZE5hbWUgPSBmYWxzZTsKCiAgICAgICAgICAgIGF0dHIgPSBuQXR0cnNbal07CiAgICAgICAgICAgIG5hbWUgPSBhdHRyLm5hbWU7CiAgICAgICAgICAgIHZhbHVlID0gdHJpbShhdHRyLnZhbHVlKTsKCiAgICAgICAgICAgIC8vIHN1cHBvcnQgbmdBdHRyIGF0dHJpYnV0ZSBiaW5kaW5nCiAgICAgICAgICAgIG5nQXR0ck5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobmFtZSk7CiAgICAgICAgICAgIGlmIChpc05nQXR0ciA9IE5HX0FUVFJfQklORElORy50ZXN0KG5nQXR0ck5hbWUpKSB7CiAgICAgICAgICAgICAgbmFtZSA9IHNuYWtlX2Nhc2UobmdBdHRyTmFtZS5zdWJzdHIoNiksICctJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkaXJlY3RpdmVOTmFtZSA9IG5nQXR0ck5hbWUucmVwbGFjZSgvKFN0YXJ0fEVuZCkkLywgJycpOwogICAgICAgICAgICBpZiAoZGlyZWN0aXZlSXNNdWx0aUVsZW1lbnQoZGlyZWN0aXZlTk5hbWUpKSB7CiAgICAgICAgICAgICAgaWYgKG5nQXR0ck5hbWUgPT09IGRpcmVjdGl2ZU5OYW1lICsgJ1N0YXJ0JykgewogICAgICAgICAgICAgICAgYXR0clN0YXJ0TmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBhdHRyRW5kTmFtZSA9IG5hbWUuc3Vic3RyKDAsIG5hbWUubGVuZ3RoIC0gNSkgKyAnZW5kJzsKICAgICAgICAgICAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cigwLCBuYW1lLmxlbmd0aCAtIDYpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgYXR0cnNNYXBbbk5hbWVdID0gbmFtZTsKICAgICAgICAgICAgaWYgKGlzTmdBdHRyIHx8ICFhdHRycy5oYXNPd25Qcm9wZXJ0eShuTmFtZSkpIHsKICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgaWYgKGdldEJvb2xlYW5BdHRyTmFtZShub2RlLCBuTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJ1ZTsgLy8gcHJlc2VuY2UgbWVhbnMgdHJ1ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGFkZEF0dHJJbnRlcnBvbGF0ZURpcmVjdGl2ZShub2RlLCBkaXJlY3RpdmVzLCB2YWx1ZSwgbk5hbWUsIGlzTmdBdHRyKTsKICAgICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQScsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUsIGF0dHJTdGFydE5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ckVuZE5hbWUpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIHVzZSBjbGFzcyBhcyBkaXJlY3RpdmUKICAgICAgICAgIGNsYXNzTmFtZSA9IG5vZGUuY2xhc3NOYW1lOwogICAgICAgICAgaWYgKGlzU3RyaW5nKGNsYXNzTmFtZSkgJiYgY2xhc3NOYW1lICE9PSAnJykgewogICAgICAgICAgICB3aGlsZSAobWF0Y2ggPSBDTEFTU19ESVJFQ1RJVkVfUkVHRVhQLmV4ZWMoY2xhc3NOYW1lKSkgewogICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG1hdGNoWzJdKTsKICAgICAgICAgICAgICBpZiAoYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQycsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpKSB7CiAgICAgICAgICAgICAgICBhdHRyc1tuTmFtZV0gPSB0cmltKG1hdGNoWzNdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lLnN1YnN0cihtYXRjaC5pbmRleCArIG1hdGNoWzBdLmxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgTk9ERV9UWVBFX1RFWFQ6IC8qIFRleHQgTm9kZSAqLwogICAgICAgICAgYWRkVGV4dEludGVycG9sYXRlRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5vZGUubm9kZVZhbHVlKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgTk9ERV9UWVBFX0NPTU1FTlQ6IC8qIENvbW1lbnQgKi8KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIG1hdGNoID0gQ09NTUVOVF9ESVJFQ1RJVkVfUkVHRVhQLmV4ZWMobm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICBuTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZShtYXRjaFsxXSk7CiAgICAgICAgICAgICAgaWYgKGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLCBuTmFtZSwgJ00nLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFsyXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIC8vIHR1cm5zIG91dCB0aGF0IHVuZGVyIHNvbWUgY2lyY3Vtc3RhbmNlcyBJRTkgdGhyb3dzIGVycm9ycyB3aGVuIG9uZSBhdHRlbXB0cyB0byByZWFkCiAgICAgICAgICAgIC8vIGNvbW1lbnQncyBub2RlIHZhbHVlLgogICAgICAgICAgICAvLyBKdXN0IGlnbm9yZSBpdCBhbmQgY29udGludWUuIChDYW4ndCBzZWVtIHRvIHJlcHJvZHVjZSBpbiB0ZXN0IGNhc2UuKQogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIGRpcmVjdGl2ZXMuc29ydChieVByaW9yaXR5KTsKICAgICAgcmV0dXJuIGRpcmVjdGl2ZXM7CiAgICB9CgogICAgLyoqCiAgICAgKiBHaXZlbiBhIG5vZGUgd2l0aCBhbiBkaXJlY3RpdmUtc3RhcnQgaXQgY29sbGVjdHMgYWxsIG9mIHRoZSBzaWJsaW5ncyB1bnRpbCBpdCBmaW5kcwogICAgICogZGlyZWN0aXZlLWVuZC4KICAgICAqIEBwYXJhbSBub2RlCiAgICAgKiBAcGFyYW0gYXR0clN0YXJ0CiAgICAgKiBAcGFyYW0gYXR0ckVuZAogICAgICogQHJldHVybnMgeyp9CiAgICAgKi8KICAgIGZ1bmN0aW9uIGdyb3VwU2Nhbihub2RlLCBhdHRyU3RhcnQsIGF0dHJFbmQpIHsKICAgICAgdmFyIG5vZGVzID0gW107CiAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgIGlmIChhdHRyU3RhcnQgJiYgbm9kZS5oYXNBdHRyaWJ1dGUgJiYgbm9kZS5oYXNBdHRyaWJ1dGUoYXR0clN0YXJ0KSkgewogICAgICAgIHZhciBzdGFydE5vZGUgPSBub2RlOwogICAgICAgIGRvIHsKICAgICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycigndXRlcmRpcicsCiAgICAgICAgICAgICAgICAgICAgICAiVW50ZXJtaW5hdGVkIGF0dHJpYnV0ZSwgZm91bmQgJ3swfScgYnV0IG5vIG1hdGNoaW5nICd7MX0nIGZvdW5kLiIsCiAgICAgICAgICAgICAgICAgICAgICBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gTk9ERV9UWVBFX0VMRU1FTlQpIHsKICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJTdGFydCkpIGRlcHRoKys7CiAgICAgICAgICAgIGlmIChub2RlLmhhc0F0dHJpYnV0ZShhdHRyRW5kKSkgZGVwdGgtLTsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGVzLnB1c2gobm9kZSk7CiAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICB9IHdoaWxlIChkZXB0aCA+IDApOwogICAgICB9IGVsc2UgewogICAgICAgIG5vZGVzLnB1c2gobm9kZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBqcUxpdGUobm9kZXMpOwogICAgfQoKICAgIC8qKgogICAgICogV3JhcHBlciBmb3IgbGlua2luZyBmdW5jdGlvbiB3aGljaCBjb252ZXJ0cyBub3JtYWwgbGlua2luZyBmdW5jdGlvbiBpbnRvIGEgZ3JvdXBlZAogICAgICogbGlua2luZyBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSBsaW5rRm4KICAgICAqIEBwYXJhbSBhdHRyU3RhcnQKICAgICAqIEBwYXJhbSBhdHRyRW5kCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259CiAgICAgKi8KICAgIGZ1bmN0aW9uIGdyb3VwRWxlbWVudHNMaW5rRm5XcmFwcGVyKGxpbmtGbiwgYXR0clN0YXJ0LCBhdHRyRW5kKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIGNvbnRyb2xsZXJzLCB0cmFuc2NsdWRlRm4pIHsKICAgICAgICBlbGVtZW50ID0gZ3JvdXBTY2FuKGVsZW1lbnRbMF0sIGF0dHJTdGFydCwgYXR0ckVuZCk7CiAgICAgICAgcmV0dXJuIGxpbmtGbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIGNvbnRyb2xsZXJzLCB0cmFuc2NsdWRlRm4pOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogT25jZSB0aGUgZGlyZWN0aXZlcyBoYXZlIGJlZW4gY29sbGVjdGVkLCB0aGVpciBjb21waWxlIGZ1bmN0aW9ucyBhcmUgZXhlY3V0ZWQuIFRoaXMgbWV0aG9kCiAgICAgKiBpcyByZXNwb25zaWJsZSBmb3IgaW5saW5pbmcgZGlyZWN0aXZlIHRlbXBsYXRlcyBhcyB3ZWxsIGFzIHRlcm1pbmF0aW5nIHRoZSBhcHBsaWNhdGlvbgogICAgICogb2YgdGhlIGRpcmVjdGl2ZXMgaWYgdGhlIHRlcm1pbmFsIGRpcmVjdGl2ZSBoYXMgYmVlbiByZWFjaGVkLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGRpcmVjdGl2ZXMgQXJyYXkgb2YgY29sbGVjdGVkIGRpcmVjdGl2ZXMgdG8gZXhlY3V0ZSB0aGVpciBjb21waWxlIGZ1bmN0aW9uLgogICAgICogICAgICAgIHRoaXMgbmVlZHMgdG8gYmUgcHJlLXNvcnRlZCBieSBwcmlvcml0eSBvcmRlci4KICAgICAqIEBwYXJhbSB7Tm9kZX0gY29tcGlsZU5vZGUgVGhlIHJhdyBET00gbm9kZSB0byBhcHBseSB0aGUgY29tcGlsZSBmdW5jdGlvbnMgdG8KICAgICAqIEBwYXJhbSB7T2JqZWN0fSB0ZW1wbGF0ZUF0dHJzIFRoZSBzaGFyZWQgYXR0cmlidXRlIGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGFuZ3VsYXIuU2NvcGUsIGNsb25lQXR0YWNoRm49KX0gdHJhbnNjbHVkZUZuIEEgbGlua2luZyBmdW5jdGlvbiwgd2hlcmUgdGhlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgYXJndW1lbnQgaXMgYXV0by1nZW5lcmF0ZWQgdG8gdGhlIG5ldwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkIG9mIHRoZSB0cmFuc2NsdWRlZCBwYXJlbnQgc2NvcGUuCiAgICAgKiBAcGFyYW0ge0pRTGl0ZX0ganFDb2xsZWN0aW9uIElmIHdlIGFyZSB3b3JraW5nIG9uIHRoZSByb290IG9mIHRoZSBjb21waWxlIHRyZWUgdGhlbiB0aGlzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50IGhhcyB0aGUgcm9vdCBqcUxpdGUgYXJyYXkgc28gdGhhdCB3ZSBjYW4gcmVwbGFjZSBub2RlcwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbiBpdC4KICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gb3JpZ2luYWxSZXBsYWNlRGlyZWN0aXZlIEFuIG9wdGlvbmFsIGRpcmVjdGl2ZSB0aGF0IHdpbGwgYmUgaWdub3JlZCB3aGVuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxpbmcgdGhlIHRyYW5zY2x1c2lvbi4KICAgICAqIEBwYXJhbSB7QXJyYXkuPEZ1bmN0aW9uPn0gcHJlTGlua0ZucwogICAgICogQHBhcmFtIHtBcnJheS48RnVuY3Rpb24+fSBwb3N0TGlua0ZucwogICAgICogQHBhcmFtIHtPYmplY3R9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQgQ29udGV4dCB1c2VkIGZvciBwcmV2aW91cyBjb21waWxhdGlvbiBvZiB0aGUgY3VycmVudAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZQogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBsaW5rRm4KICAgICAqLwogICAgZnVuY3Rpb24gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCB0cmFuc2NsdWRlRm4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganFDb2xsZWN0aW9uLCBvcmlnaW5hbFJlcGxhY2VEaXJlY3RpdmUsIHByZUxpbmtGbnMsIHBvc3RMaW5rRm5zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpIHsKICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dCA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQgfHwge307CgogICAgICB2YXIgdGVybWluYWxQcmlvcml0eSA9IC1OdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgICAgbmV3U2NvcGVEaXJlY3RpdmUsCiAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcyA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQuY29udHJvbGxlckRpcmVjdGl2ZXMsCiAgICAgICAgICBjb250cm9sbGVycywKICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQubmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLAogICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPSBwcmV2aW91c0NvbXBpbGVDb250ZXh0LnRlbXBsYXRlRGlyZWN0aXZlLAogICAgICAgICAgbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZSA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQubm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZSwKICAgICAgICAgIGhhc1RyYW5zY2x1ZGVEaXJlY3RpdmUgPSBmYWxzZSwKICAgICAgICAgIGhhc1RlbXBsYXRlID0gZmFsc2UsCiAgICAgICAgICBoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQuaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAkY29tcGlsZU5vZGUgPSB0ZW1wbGF0ZUF0dHJzLiQkZWxlbWVudCA9IGpxTGl0ZShjb21waWxlTm9kZSksCiAgICAgICAgICBkaXJlY3RpdmUsCiAgICAgICAgICBkaXJlY3RpdmVOYW1lLAogICAgICAgICAgJHRlbXBsYXRlLAogICAgICAgICAgcmVwbGFjZURpcmVjdGl2ZSA9IG9yaWdpbmFsUmVwbGFjZURpcmVjdGl2ZSwKICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gdHJhbnNjbHVkZUZuLAogICAgICAgICAgbGlua0ZuLAogICAgICAgICAgZGlyZWN0aXZlVmFsdWU7CgogICAgICAvLyBleGVjdXRlcyBhbGwgZGlyZWN0aXZlcyBvbiB0aGUgY3VycmVudCBlbGVtZW50CiAgICAgIGZvcih2YXIgaSA9IDAsIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgZGlyZWN0aXZlID0gZGlyZWN0aXZlc1tpXTsKICAgICAgICB2YXIgYXR0clN0YXJ0ID0gZGlyZWN0aXZlLiQkc3RhcnQ7CiAgICAgICAgdmFyIGF0dHJFbmQgPSBkaXJlY3RpdmUuJCRlbmQ7CgogICAgICAgIC8vIGNvbGxlY3QgbXVsdGlibG9jayBzZWN0aW9ucwogICAgICAgIGlmIChhdHRyU3RhcnQpIHsKICAgICAgICAgICRjb21waWxlTm9kZSA9IGdyb3VwU2Nhbihjb21waWxlTm9kZSwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICB9CiAgICAgICAgJHRlbXBsYXRlID0gdW5kZWZpbmVkOwoKICAgICAgICBpZiAodGVybWluYWxQcmlvcml0eSA+IGRpcmVjdGl2ZS5wcmlvcml0eSkgewogICAgICAgICAgYnJlYWs7IC8vIHByZXZlbnQgZnVydGhlciBwcm9jZXNzaW5nIG9mIGRpcmVjdGl2ZXMKICAgICAgICB9CgogICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS5zY29wZSkgewoKICAgICAgICAgIC8vIHNraXAgdGhlIGNoZWNrIGZvciBkaXJlY3RpdmVzIHdpdGggYXN5bmMgdGVtcGxhdGVzLCB3ZSdsbCBjaGVjayB0aGUgZGVyaXZlZCBzeW5jCiAgICAgICAgICAvLyBkaXJlY3RpdmUgd2hlbiB0aGUgdGVtcGxhdGUgYXJyaXZlcwogICAgICAgICAgaWYgKCFkaXJlY3RpdmUudGVtcGxhdGVVcmwpIHsKICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGRpcmVjdGl2ZVZhbHVlKSkgewogICAgICAgICAgICAgIC8vIFRoaXMgZGlyZWN0aXZlIGlzIHRyeWluZyB0byBhZGQgYW4gaXNvbGF0ZWQgc2NvcGUuCiAgICAgICAgICAgICAgLy8gQ2hlY2sgdGhhdCB0aGVyZSBpcyBubyBzY29wZSBvZiBhbnkga2luZCBhbHJlYWR5CiAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ25ldy9pc29sYXRlZCBzY29wZScsIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSB8fCBuZXdTY29wZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIFRoaXMgZGlyZWN0aXZlIGlzIHRyeWluZyB0byBhZGQgYSBjaGlsZCBzY29wZS4KICAgICAgICAgICAgICAvLyBDaGVjayB0aGF0IHRoZXJlIGlzIG5vIGlzb2xhdGVkIHNjb3BlIGFscmVhZHkKICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgnbmV3L2lzb2xhdGVkIHNjb3BlJywgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLCBkaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIG5ld1Njb3BlRGlyZWN0aXZlID0gbmV3U2NvcGVEaXJlY3RpdmUgfHwgZGlyZWN0aXZlOwogICAgICAgIH0KCiAgICAgICAgZGlyZWN0aXZlTmFtZSA9IGRpcmVjdGl2ZS5uYW1lOwoKICAgICAgICBpZiAoIWRpcmVjdGl2ZS50ZW1wbGF0ZVVybCAmJiBkaXJlY3RpdmUuY29udHJvbGxlcikgewogICAgICAgICAgZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUuY29udHJvbGxlcjsKICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzID0gY29udHJvbGxlckRpcmVjdGl2ZXMgfHwge307CiAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgiJyIgKyBkaXJlY3RpdmVOYW1lICsgIicgY29udHJvbGxlciIsCiAgICAgICAgICAgICAgY29udHJvbGxlckRpcmVjdGl2ZXNbZGlyZWN0aXZlTmFtZV0sIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdID0gZGlyZWN0aXZlOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLnRyYW5zY2x1ZGUpIHsKICAgICAgICAgIGhhc1RyYW5zY2x1ZGVEaXJlY3RpdmUgPSB0cnVlOwoKICAgICAgICAgIC8vIFNwZWNpYWwgY2FzZSBuZ0lmIGFuZCBuZ1JlcGVhdCBzbyB0aGF0IHdlIGRvbid0IGNvbXBsYWluIGFib3V0IGR1cGxpY2F0ZSB0cmFuc2NsdXNpb24uCiAgICAgICAgICAvLyBUaGlzIG9wdGlvbiBzaG91bGQgb25seSBiZSB1c2VkIGJ5IGRpcmVjdGl2ZXMgdGhhdCBrbm93IGhvdyB0byBzYWZlbHkgaGFuZGxlIGVsZW1lbnQgdHJhbnNjbHVzaW9uLAogICAgICAgICAgLy8gd2hlcmUgdGhlIHRyYW5zY2x1ZGVkIG5vZGVzIGFyZSBhZGRlZCBvciByZXBsYWNlZCBhZnRlciBsaW5raW5nLgogICAgICAgICAgaWYgKCFkaXJlY3RpdmUuJCR0bGIpIHsKICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ3RyYW5zY2x1c2lvbicsIG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZGlyZWN0aXZlVmFsdWUgPT0gJ2VsZW1lbnQnKSB7CiAgICAgICAgICAgIGhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgdGVybWluYWxQcmlvcml0eSA9IGRpcmVjdGl2ZS5wcmlvcml0eTsKICAgICAgICAgICAgJHRlbXBsYXRlID0gJGNvbXBpbGVOb2RlOwogICAgICAgICAgICAkY29tcGlsZU5vZGUgPSB0ZW1wbGF0ZUF0dHJzLiQkZWxlbWVudCA9CiAgICAgICAgICAgICAgICBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgnICcgKyBkaXJlY3RpdmVOYW1lICsgJzogJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZUF0dHJzW2RpcmVjdGl2ZU5hbWVdICsgJyAnKSk7CiAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJGNvbXBpbGVOb2RlWzBdOwogICAgICAgICAgICByZXBsYWNlV2l0aChqcUNvbGxlY3Rpb24sIHNsaWNlQXJncygkdGVtcGxhdGUpLCBjb21waWxlTm9kZSk7CgogICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IGNvbXBpbGUoJHRlbXBsYXRlLCB0cmFuc2NsdWRlRm4sIHRlcm1pbmFsUHJpb3JpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlRGlyZWN0aXZlICYmIHJlcGxhY2VEaXJlY3RpdmUubmFtZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBwYXNzIGluOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAtIGNvbnRyb2xsZXJEaXJlY3RpdmVzIC0gb3RoZXJ3aXNlIHdlJ2xsIGNyZWF0ZSBkdXBsaWNhdGVzIGNvbnRyb2xsZXJzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlIG9yIHRlbXBsYXRlRGlyZWN0aXZlIC0gY29tYmluaW5nIHRlbXBsYXRlcyB3aXRoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgZWxlbWVudCB0cmFuc2NsdXNpb24gZG9lc24ndCBtYWtlIHNlbnNlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIG9ubHkgbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZSBzbyB0aGF0IHdlIHByZXZlbnQgcHV0dGluZyB0cmFuc2NsdXNpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb24gdGhlIHNhbWUgZWxlbWVudCBtb3JlIHRoYW4gb25jZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZTogbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoanFMaXRlQ2xvbmUoY29tcGlsZU5vZGUpKS5jb250ZW50cygpOwogICAgICAgICAgICAkY29tcGlsZU5vZGUuZW1wdHkoKTsgLy8gY2xlYXIgY29udGVudHMKICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSBjb21waWxlKCR0ZW1wbGF0ZSwgdHJhbnNjbHVkZUZuKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChkaXJlY3RpdmUudGVtcGxhdGUpIHsKICAgICAgICAgIGhhc1RlbXBsYXRlID0gdHJ1ZTsKICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0ZW1wbGF0ZScsIHRlbXBsYXRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKCiAgICAgICAgICBkaXJlY3RpdmVWYWx1ZSA9IChpc0Z1bmN0aW9uKGRpcmVjdGl2ZS50ZW1wbGF0ZSkpCiAgICAgICAgICAgICAgPyBkaXJlY3RpdmUudGVtcGxhdGUoJGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzKQogICAgICAgICAgICAgIDogZGlyZWN0aXZlLnRlbXBsYXRlOwoKICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlID0gZGVub3JtYWxpemVUZW1wbGF0ZShkaXJlY3RpdmVWYWx1ZSk7CgogICAgICAgICAgaWYgKGRpcmVjdGl2ZS5yZXBsYWNlKSB7CiAgICAgICAgICAgIHJlcGxhY2VEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgIGlmIChqcUxpdGVJc1RleHROb2RlKGRpcmVjdGl2ZVZhbHVlKSkgewogICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IFtdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IHJlbW92ZUNvbW1lbnRzKHdyYXBUZW1wbGF0ZShkaXJlY3RpdmUudGVtcGxhdGVOYW1lc3BhY2UsIHRyaW0oZGlyZWN0aXZlVmFsdWUpKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGlsZU5vZGUgPSAkdGVtcGxhdGVbMF07CgogICAgICAgICAgICBpZiAoJHRlbXBsYXRlLmxlbmd0aCAhPSAxIHx8IGNvbXBpbGVOb2RlLm5vZGVUeXBlICE9PSBOT0RFX1RZUEVfRUxFTUVOVCkgewogICAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCd0cGxydCcsCiAgICAgICAgICAgICAgICAgICJUZW1wbGF0ZSBmb3IgZGlyZWN0aXZlICd7MH0nIG11c3QgaGF2ZSBleGFjdGx5IG9uZSByb290IGVsZW1lbnQuIHsxfSIsCiAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZU5hbWUsICcnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmVwbGFjZVdpdGgoanFDb2xsZWN0aW9uLCAkY29tcGlsZU5vZGUsIGNvbXBpbGVOb2RlKTsKCiAgICAgICAgICAgIHZhciBuZXdUZW1wbGF0ZUF0dHJzID0geyRhdHRyOiB7fX07CgogICAgICAgICAgICAvLyBjb21iaW5lIGRpcmVjdGl2ZXMgZnJvbSB0aGUgb3JpZ2luYWwgbm9kZSBhbmQgZnJvbSB0aGUgdGVtcGxhdGU6CiAgICAgICAgICAgIC8vIC0gdGFrZSB0aGUgYXJyYXkgb2YgZGlyZWN0aXZlcyBmb3IgdGhpcyBlbGVtZW50CiAgICAgICAgICAgIC8vIC0gc3BsaXQgaXQgaW50byB0d28gcGFydHMsIHRob3NlIHRoYXQgYWxyZWFkeSBhcHBsaWVkIChwcm9jZXNzZWQpIGFuZCB0aG9zZSB0aGF0IHdlcmVuJ3QgKHVucHJvY2Vzc2VkKQogICAgICAgICAgICAvLyAtIGNvbGxlY3QgZGlyZWN0aXZlcyBmcm9tIHRoZSB0ZW1wbGF0ZSBhbmQgc29ydCB0aGVtIGJ5IHByaW9yaXR5CiAgICAgICAgICAgIC8vIC0gY29tYmluZSBkaXJlY3RpdmVzIGFzOiBwcm9jZXNzZWQgKyB0ZW1wbGF0ZSArIHVucHJvY2Vzc2VkCiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURpcmVjdGl2ZXMgPSBjb2xsZWN0RGlyZWN0aXZlcyhjb21waWxlTm9kZSwgW10sIG5ld1RlbXBsYXRlQXR0cnMpOwogICAgICAgICAgICB2YXIgdW5wcm9jZXNzZWREaXJlY3RpdmVzID0gZGlyZWN0aXZlcy5zcGxpY2UoaSArIDEsIGRpcmVjdGl2ZXMubGVuZ3RoIC0gKGkgKyAxKSk7CgogICAgICAgICAgICBpZiAobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlKSB7CiAgICAgICAgICAgICAgbWFya0RpcmVjdGl2ZXNBc0lzb2xhdGUodGVtcGxhdGVEaXJlY3RpdmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXJlY3RpdmVzID0gZGlyZWN0aXZlcy5jb25jYXQodGVtcGxhdGVEaXJlY3RpdmVzKS5jb25jYXQodW5wcm9jZXNzZWREaXJlY3RpdmVzKTsKICAgICAgICAgICAgbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXModGVtcGxhdGVBdHRycywgbmV3VGVtcGxhdGVBdHRycyk7CgogICAgICAgICAgICBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoZGlyZWN0aXZlVmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGRpcmVjdGl2ZS50ZW1wbGF0ZVVybCkgewogICAgICAgICAgaGFzVGVtcGxhdGUgPSB0cnVlOwogICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ3RlbXBsYXRlJywgdGVtcGxhdGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwoKICAgICAgICAgIGlmIChkaXJlY3RpdmUucmVwbGFjZSkgewogICAgICAgICAgICByZXBsYWNlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgfQoKICAgICAgICAgIG5vZGVMaW5rRm4gPSBjb21waWxlVGVtcGxhdGVVcmwoZGlyZWN0aXZlcy5zcGxpY2UoaSwgZGlyZWN0aXZlcy5sZW5ndGggLSBpKSwgJGNvbXBpbGVOb2RlLAogICAgICAgICAgICAgIHRlbXBsYXRlQXR0cnMsIGpxQ29sbGVjdGlvbiwgaGFzVHJhbnNjbHVkZURpcmVjdGl2ZSAmJiBjaGlsZFRyYW5zY2x1ZGVGbiwgcHJlTGlua0ZucywgcG9zdExpbmtGbnMsIHsKICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzOiBjb250cm9sbGVyRGlyZWN0aXZlcywKICAgICAgICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZTogbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmU6IHRlbXBsYXRlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZTogbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsKICAgICAgICB9IGVsc2UgaWYgKGRpcmVjdGl2ZS5jb21waWxlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBsaW5rRm4gPSBkaXJlY3RpdmUuY29tcGlsZSgkY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24obGlua0ZuKSkgewogICAgICAgICAgICAgIGFkZExpbmtGbnMobnVsbCwgbGlua0ZuLCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGxpbmtGbikgewogICAgICAgICAgICAgIGFkZExpbmtGbnMobGlua0ZuLnByZSwgbGlua0ZuLnBvc3QsIGF0dHJTdGFydCwgYXR0ckVuZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGNvbXBpbGVOb2RlKSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoZGlyZWN0aXZlLnRlcm1pbmFsKSB7CiAgICAgICAgICBub2RlTGlua0ZuLnRlcm1pbmFsID0gdHJ1ZTsKICAgICAgICAgIHRlcm1pbmFsUHJpb3JpdHkgPSBNYXRoLm1heCh0ZXJtaW5hbFByaW9yaXR5LCBkaXJlY3RpdmUucHJpb3JpdHkpOwogICAgICAgIH0KCiAgICAgIH0KCiAgICAgIG5vZGVMaW5rRm4uc2NvcGUgPSBuZXdTY29wZURpcmVjdGl2ZSAmJiBuZXdTY29wZURpcmVjdGl2ZS5zY29wZSA9PT0gdHJ1ZTsKICAgICAgbm9kZUxpbmtGbi50cmFuc2NsdWRlT25UaGlzRWxlbWVudCA9IGhhc1RyYW5zY2x1ZGVEaXJlY3RpdmU7CiAgICAgIG5vZGVMaW5rRm4uZWxlbWVudFRyYW5zY2x1ZGVPblRoaXNFbGVtZW50ID0gaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmU7CiAgICAgIG5vZGVMaW5rRm4udGVtcGxhdGVPblRoaXNFbGVtZW50ID0gaGFzVGVtcGxhdGU7CiAgICAgIG5vZGVMaW5rRm4udHJhbnNjbHVkZSA9IGNoaWxkVHJhbnNjbHVkZUZuOwoKICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dC5oYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSA9IGhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlOwoKICAgICAgLy8gbWlnaHQgYmUgbm9ybWFsIG9yIGRlbGF5ZWQgbm9kZUxpbmtGbiBkZXBlbmRpbmcgb24gaWYgdGVtcGxhdGVVcmwgaXMgcHJlc2VudAogICAgICByZXR1cm4gbm9kZUxpbmtGbjsKCiAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICBmdW5jdGlvbiBhZGRMaW5rRm5zKHByZSwgcG9zdCwgYXR0clN0YXJ0LCBhdHRyRW5kKSB7CiAgICAgICAgaWYgKHByZSkgewogICAgICAgICAgaWYgKGF0dHJTdGFydCkgcHJlID0gZ3JvdXBFbGVtZW50c0xpbmtGbldyYXBwZXIocHJlLCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgcHJlLnJlcXVpcmUgPSBkaXJlY3RpdmUucmVxdWlyZTsKICAgICAgICAgIHByZS5kaXJlY3RpdmVOYW1lID0gZGlyZWN0aXZlTmFtZTsKICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPT09IGRpcmVjdGl2ZSB8fCBkaXJlY3RpdmUuJCRpc29sYXRlU2NvcGUpIHsKICAgICAgICAgICAgcHJlID0gY2xvbmVBbmRBbm5vdGF0ZUZuKHByZSwge2lzb2xhdGVTY29wZTogdHJ1ZX0pOwogICAgICAgICAgfQogICAgICAgICAgcHJlTGlua0Zucy5wdXNoKHByZSk7CiAgICAgICAgfQogICAgICAgIGlmIChwb3N0KSB7CiAgICAgICAgICBpZiAoYXR0clN0YXJ0KSBwb3N0ID0gZ3JvdXBFbGVtZW50c0xpbmtGbldyYXBwZXIocG9zdCwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgIHBvc3QucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlOwogICAgICAgICAgcG9zdC5kaXJlY3RpdmVOYW1lID0gZGlyZWN0aXZlTmFtZTsKICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPT09IGRpcmVjdGl2ZSB8fCBkaXJlY3RpdmUuJCRpc29sYXRlU2NvcGUpIHsKICAgICAgICAgICAgcG9zdCA9IGNsb25lQW5kQW5ub3RhdGVGbihwb3N0LCB7aXNvbGF0ZVNjb3BlOiB0cnVlfSk7CiAgICAgICAgICB9CiAgICAgICAgICBwb3N0TGlua0Zucy5wdXNoKHBvc3QpOwogICAgICAgIH0KICAgICAgfQoKCiAgICAgIGZ1bmN0aW9uIGdldENvbnRyb2xsZXJzKGRpcmVjdGl2ZU5hbWUsIHJlcXVpcmUsICRlbGVtZW50LCBlbGVtZW50Q29udHJvbGxlcnMpIHsKICAgICAgICB2YXIgdmFsdWUsIHJldHJpZXZhbE1ldGhvZCA9ICdkYXRhJywgb3B0aW9uYWwgPSBmYWxzZTsKICAgICAgICB2YXIgJHNlYXJjaEVsZW1lbnQgPSAkZWxlbWVudDsKICAgICAgICB2YXIgbWF0Y2g7CiAgICAgICAgaWYgKGlzU3RyaW5nKHJlcXVpcmUpKSB7CiAgICAgICAgICBtYXRjaCA9IHJlcXVpcmUubWF0Y2goUkVRVUlSRV9QUkVGSVhfUkVHRVhQKTsKICAgICAgICAgIHJlcXVpcmUgPSByZXF1aXJlLnN1YnN0cmluZyhtYXRjaFswXS5sZW5ndGgpOwoKICAgICAgICAgIGlmIChtYXRjaFszXSkgewogICAgICAgICAgICBpZiAobWF0Y2hbMV0pIG1hdGNoWzNdID0gbnVsbDsKICAgICAgICAgICAgZWxzZSBtYXRjaFsxXSA9IG1hdGNoWzNdOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1hdGNoWzFdID09PSAnXicpIHsKICAgICAgICAgICAgcmV0cmlldmFsTWV0aG9kID0gJ2luaGVyaXRlZERhdGEnOwogICAgICAgICAgfSBlbHNlIGlmIChtYXRjaFsxXSA9PT0gJ15eJykgewogICAgICAgICAgICByZXRyaWV2YWxNZXRob2QgPSAnaW5oZXJpdGVkRGF0YSc7CiAgICAgICAgICAgICRzZWFyY2hFbGVtZW50ID0gJGVsZW1lbnQucGFyZW50KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWF0Y2hbMl0gPT09ICc/JykgewogICAgICAgICAgICBvcHRpb25hbCA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgdmFsdWUgPSBudWxsOwoKICAgICAgICAgIGlmIChlbGVtZW50Q29udHJvbGxlcnMgJiYgcmV0cmlldmFsTWV0aG9kID09PSAnZGF0YScpIHsKICAgICAgICAgICAgaWYgKHZhbHVlID0gZWxlbWVudENvbnRyb2xsZXJzW3JlcXVpcmVdKSB7CiAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5pbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFsdWUgPSB2YWx1ZSB8fCAkc2VhcmNoRWxlbWVudFtyZXRyaWV2YWxNZXRob2RdKCckJyArIHJlcXVpcmUgKyAnQ29udHJvbGxlcicpOwoKICAgICAgICAgIGlmICghdmFsdWUgJiYgIW9wdGlvbmFsKSB7CiAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCdjdHJlcScsCiAgICAgICAgICAgICAgICAiQ29udHJvbGxlciAnezB9JywgcmVxdWlyZWQgYnkgZGlyZWN0aXZlICd7MX0nLCBjYW4ndCBiZSBmb3VuZCEiLAogICAgICAgICAgICAgICAgcmVxdWlyZSwgZGlyZWN0aXZlTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KHJlcXVpcmUpKSB7CiAgICAgICAgICB2YWx1ZSA9IFtdOwogICAgICAgICAgZm9yRWFjaChyZXF1aXJlLCBmdW5jdGlvbihyZXF1aXJlKSB7CiAgICAgICAgICAgIHZhbHVlLnB1c2goZ2V0Q29udHJvbGxlcnMoZGlyZWN0aXZlTmFtZSwgcmVxdWlyZSwgJGVsZW1lbnQsIGVsZW1lbnRDb250cm9sbGVycykpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQoKCiAgICAgIGZ1bmN0aW9uIG5vZGVMaW5rRm4oY2hpbGRMaW5rRm4sIHNjb3BlLCBsaW5rTm9kZSwgJHJvb3RFbGVtZW50LCBib3VuZFRyYW5zY2x1ZGVGbikgewogICAgICAgIHZhciBpLCBpaSwgbGlua0ZuLCBjb250cm9sbGVyLCBpc29sYXRlU2NvcGUsIGVsZW1lbnRDb250cm9sbGVycywgdHJhbnNjbHVkZUZuLCAkZWxlbWVudCwKICAgICAgICAgICAgYXR0cnM7CgogICAgICAgIGlmIChjb21waWxlTm9kZSA9PT0gbGlua05vZGUpIHsKICAgICAgICAgIGF0dHJzID0gdGVtcGxhdGVBdHRyczsKICAgICAgICAgICRlbGVtZW50ID0gdGVtcGxhdGVBdHRycy4kJGVsZW1lbnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICRlbGVtZW50ID0ganFMaXRlKGxpbmtOb2RlKTsKICAgICAgICAgIGF0dHJzID0gbmV3IEF0dHJpYnV0ZXMoJGVsZW1lbnQsIHRlbXBsYXRlQXR0cnMpOwogICAgICAgIH0KCiAgICAgICAgaWYgKG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSkgewogICAgICAgICAgaXNvbGF0ZVNjb3BlID0gc2NvcGUuJG5ldyh0cnVlKTsKICAgICAgICB9CgogICAgICAgIHRyYW5zY2x1ZGVGbiA9IGJvdW5kVHJhbnNjbHVkZUZuICYmIGNvbnRyb2xsZXJzQm91bmRUcmFuc2NsdWRlOwogICAgICAgIGlmIChjb250cm9sbGVyRGlyZWN0aXZlcykgewogICAgICAgICAgLy8gVE9ETzogbWVyZ2UgYGNvbnRyb2xsZXJzYCBhbmQgYGVsZW1lbnRDb250cm9sbGVyc2AgaW50byBzaW5nbGUgb2JqZWN0LgogICAgICAgICAgY29udHJvbGxlcnMgPSB7fTsKICAgICAgICAgIGVsZW1lbnRDb250cm9sbGVycyA9IHt9OwogICAgICAgICAgZm9yRWFjaChjb250cm9sbGVyRGlyZWN0aXZlcywgZnVuY3Rpb24oZGlyZWN0aXZlKSB7CiAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7CiAgICAgICAgICAgICAgJHNjb3BlOiBkaXJlY3RpdmUgPT09IG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSB8fCBkaXJlY3RpdmUuJCRpc29sYXRlU2NvcGUgPyBpc29sYXRlU2NvcGUgOiBzY29wZSwKICAgICAgICAgICAgICAkZWxlbWVudDogJGVsZW1lbnQsCiAgICAgICAgICAgICAgJGF0dHJzOiBhdHRycywKICAgICAgICAgICAgICAkdHJhbnNjbHVkZTogdHJhbnNjbHVkZUZuCiAgICAgICAgICAgIH0sIGNvbnRyb2xsZXJJbnN0YW5jZTsKCiAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBkaXJlY3RpdmUuY29udHJvbGxlcjsKICAgICAgICAgICAgaWYgKGNvbnRyb2xsZXIgPT0gJ0AnKSB7CiAgICAgICAgICAgICAgY29udHJvbGxlciA9IGF0dHJzW2RpcmVjdGl2ZS5uYW1lXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udHJvbGxlckluc3RhbmNlID0gJGNvbnRyb2xsZXIoY29udHJvbGxlciwgbG9jYWxzLCB0cnVlLCBkaXJlY3RpdmUuY29udHJvbGxlckFzKTsKCiAgICAgICAgICAgIC8vIEZvciBkaXJlY3RpdmVzIHdpdGggZWxlbWVudCB0cmFuc2NsdXNpb24gdGhlIGVsZW1lbnQgaXMgYSBjb21tZW50LAogICAgICAgICAgICAvLyBidXQgalF1ZXJ5IC5kYXRhIGRvZXNuJ3Qgc3VwcG9ydCBhdHRhY2hpbmcgZGF0YSB0byBjb21tZW50IG5vZGVzIGFzIGl0J3MgaGFyZCB0bwogICAgICAgICAgICAvLyBjbGVhbiB1cCAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvODMzNSkuCiAgICAgICAgICAgIC8vIEluc3RlYWQsIHdlIHNhdmUgdGhlIGNvbnRyb2xsZXJzIGZvciB0aGUgZWxlbWVudCBpbiBhIGxvY2FsIGhhc2ggYW5kIGF0dGFjaCB0byAuZGF0YQogICAgICAgICAgICAvLyBsYXRlciwgb25jZSB3ZSBoYXZlIHRoZSBhY3R1YWwgZWxlbWVudC4KICAgICAgICAgICAgZWxlbWVudENvbnRyb2xsZXJzW2RpcmVjdGl2ZS5uYW1lXSA9IGNvbnRyb2xsZXJJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKCFoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSkgewogICAgICAgICAgICAgICRlbGVtZW50LmRhdGEoJyQnICsgZGlyZWN0aXZlLm5hbWUgKyAnQ29udHJvbGxlcicsIGNvbnRyb2xsZXJJbnN0YW5jZS5pbnN0YW5jZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRyb2xsZXJzW2RpcmVjdGl2ZS5uYW1lXSA9IGNvbnRyb2xsZXJJbnN0YW5jZTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSkgewogICAgICAgICAgdmFyIExPQ0FMX1JFR0VYUCA9IC9eXHMqKFtAPSZdKShcPz8pXHMqKFx3KilccyokLzsKCiAgICAgICAgICBjb21waWxlLiQkYWRkU2NvcGVJbmZvKCRlbGVtZW50LCBpc29sYXRlU2NvcGUsIHRydWUsICEodGVtcGxhdGVEaXJlY3RpdmUgJiYgKHRlbXBsYXRlRGlyZWN0aXZlID09PSBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgfHwKICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9PT0gbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLiQkb3JpZ2luYWxEaXJlY3RpdmUpKSk7CiAgICAgICAgICBjb21waWxlLiQkYWRkU2NvcGVDbGFzcygkZWxlbWVudCwgdHJ1ZSk7CgogICAgICAgICAgdmFyIGlzb2xhdGVTY29wZUNvbnRyb2xsZXIgPSBjb250cm9sbGVycyAmJiBjb250cm9sbGVyc1tuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUubmFtZV07CiAgICAgICAgICB2YXIgaXNvbGF0ZUJpbmRpbmdDb250ZXh0ID0gaXNvbGF0ZVNjb3BlOwogICAgICAgICAgaWYgKGlzb2xhdGVTY29wZUNvbnRyb2xsZXIgJiYgaXNvbGF0ZVNjb3BlQ29udHJvbGxlci5pZGVudGlmaWVyICYmCiAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLmJpbmRUb0NvbnRyb2xsZXIgPT09IHRydWUpIHsKICAgICAgICAgICAgaXNvbGF0ZUJpbmRpbmdDb250ZXh0ID0gaXNvbGF0ZVNjb3BlQ29udHJvbGxlci5pbnN0YW5jZTsKICAgICAgICAgIH0KCiAgICAgICAgICBmb3JFYWNoKGlzb2xhdGVTY29wZS4kJGlzb2xhdGVCaW5kaW5ncyA9IG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS4kJGlzb2xhdGVCaW5kaW5ncywgZnVuY3Rpb24oZGVmaW5pdGlvbiwgc2NvcGVOYW1lKSB7CiAgICAgICAgICAgIHZhciBhdHRyTmFtZSA9IGRlZmluaXRpb24uYXR0ck5hbWUsCiAgICAgICAgICAgICAgICBvcHRpb25hbCA9IGRlZmluaXRpb24ub3B0aW9uYWwsCiAgICAgICAgICAgICAgICBtb2RlID0gZGVmaW5pdGlvbi5tb2RlLCAvLyBALCA9LCBvciAmCiAgICAgICAgICAgICAgICBsYXN0VmFsdWUsCiAgICAgICAgICAgICAgICBwYXJlbnRHZXQsIHBhcmVudFNldCwgY29tcGFyZTsKCiAgICAgICAgICAgIHN3aXRjaCAobW9kZSkgewoKICAgICAgICAgICAgICBjYXNlICdAJzoKICAgICAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKGF0dHJOYW1lLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICBpc29sYXRlQmluZGluZ0NvbnRleHRbc2NvcGVOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhdHRycy4kJG9ic2VydmVyc1thdHRyTmFtZV0uJCRzY29wZSA9IHNjb3BlOwogICAgICAgICAgICAgICAgaWYoIGF0dHJzW2F0dHJOYW1lXSApIHsKICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIGF0dHJpYnV0ZSBoYXMgYmVlbiBwcm92aWRlZCB0aGVuIHdlIHRyaWdnZXIgYW4gaW50ZXJwb2xhdGlvbiB0byBlbnN1cmUKICAgICAgICAgICAgICAgICAgLy8gdGhlIHZhbHVlIGlzIHRoZXJlIGZvciB1c2UgaW4gdGhlIGxpbmsgZm4KICAgICAgICAgICAgICAgICAgaXNvbGF0ZUJpbmRpbmdDb250ZXh0W3Njb3BlTmFtZV0gPSAkaW50ZXJwb2xhdGUoYXR0cnNbYXR0ck5hbWVdKShzY29wZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgY2FzZSAnPSc6CiAgICAgICAgICAgICAgICBpZiAob3B0aW9uYWwgJiYgIWF0dHJzW2F0dHJOYW1lXSkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJlbnRHZXQgPSAkcGFyc2UoYXR0cnNbYXR0ck5hbWVdKTsKICAgICAgICAgICAgICAgIGlmIChwYXJlbnRHZXQubGl0ZXJhbCkgewogICAgICAgICAgICAgICAgICBjb21wYXJlID0gZXF1YWxzOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY29tcGFyZSA9IGZ1bmN0aW9uKGEsYikgeyByZXR1cm4gYSA9PT0gYiB8fCAoYSAhPT0gYSAmJiBiICE9PSBiKTsgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhcmVudFNldCA9IHBhcmVudEdldC5hc3NpZ24gfHwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIC8vIHJlc2V0IHRoZSBjaGFuZ2UsIG9yIHdlIHdpbGwgdGhyb3cgdGhpcyBleGNlcHRpb24gb24gZXZlcnkgJGRpZ2VzdAogICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBpc29sYXRlQmluZGluZ0NvbnRleHRbc2NvcGVOYW1lXSA9IHBhcmVudEdldChzY29wZSk7CiAgICAgICAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCdub25hc3NpZ24nLAogICAgICAgICAgICAgICAgICAgICAgIkV4cHJlc3Npb24gJ3swfScgdXNlZCB3aXRoIGRpcmVjdGl2ZSAnezF9JyBpcyBub24tYXNzaWduYWJsZSEiLAogICAgICAgICAgICAgICAgICAgICAgYXR0cnNbYXR0ck5hbWVdLCBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUubmFtZSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgbGFzdFZhbHVlID0gaXNvbGF0ZUJpbmRpbmdDb250ZXh0W3Njb3BlTmFtZV0gPSBwYXJlbnRHZXQoc2NvcGUpOwogICAgICAgICAgICAgICAgdmFyIHBhcmVudFZhbHVlV2F0Y2ggPSBmdW5jdGlvbiBwYXJlbnRWYWx1ZVdhdGNoKHBhcmVudFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIGlmICghY29tcGFyZShwYXJlbnRWYWx1ZSwgaXNvbGF0ZUJpbmRpbmdDb250ZXh0W3Njb3BlTmFtZV0pKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIG91dCBvZiBzeW5jIGFuZCBuZWVkIHRvIGNvcHkKICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbXBhcmUocGFyZW50VmFsdWUsIGxhc3RWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIHBhcmVudCBjaGFuZ2VkIGFuZCBpdCBoYXMgcHJlY2VkZW5jZQogICAgICAgICAgICAgICAgICAgICAgaXNvbGF0ZUJpbmRpbmdDb250ZXh0W3Njb3BlTmFtZV0gPSBwYXJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHBhcmVudCBjYW4gYmUgYXNzaWduZWQgdGhlbiBkbyBzbwogICAgICAgICAgICAgICAgICAgICAgcGFyZW50U2V0KHNjb3BlLCBwYXJlbnRWYWx1ZSA9IGlzb2xhdGVCaW5kaW5nQ29udGV4dFtzY29wZU5hbWVdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIGxhc3RWYWx1ZSA9IHBhcmVudFZhbHVlOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHBhcmVudFZhbHVlV2F0Y2guJHN0YXRlZnVsID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHZhciB1bndhdGNoID0gc2NvcGUuJHdhdGNoKCRwYXJzZShhdHRyc1thdHRyTmFtZV0sIHBhcmVudFZhbHVlV2F0Y2gpLCBudWxsLCBwYXJlbnRHZXQubGl0ZXJhbCk7CiAgICAgICAgICAgICAgICBpc29sYXRlU2NvcGUuJG9uKCckZGVzdHJveScsIHVud2F0Y2gpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgJyYnOgogICAgICAgICAgICAgICAgcGFyZW50R2V0ID0gJHBhcnNlKGF0dHJzW2F0dHJOYW1lXSk7CiAgICAgICAgICAgICAgICBpc29sYXRlQmluZGluZ0NvbnRleHRbc2NvcGVOYW1lXSA9IGZ1bmN0aW9uKGxvY2FscykgewogICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50R2V0KHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvbnRyb2xsZXJzKSB7CiAgICAgICAgICBmb3JFYWNoKGNvbnRyb2xsZXJzLCBmdW5jdGlvbihjb250cm9sbGVyKSB7CiAgICAgICAgICAgIGNvbnRyb2xsZXIoKTsKICAgICAgICAgIH0pOwogICAgICAgICAgY29udHJvbGxlcnMgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgLy8gUFJFTElOS0lORwogICAgICAgIGZvcihpID0gMCwgaWkgPSBwcmVMaW5rRm5zLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgIGxpbmtGbiA9IHByZUxpbmtGbnNbaV07CiAgICAgICAgICBpbnZva2VMaW5rRm4obGlua0ZuLAogICAgICAgICAgICAgIGxpbmtGbi5pc29sYXRlU2NvcGUgPyBpc29sYXRlU2NvcGUgOiBzY29wZSwKICAgICAgICAgICAgICAkZWxlbWVudCwKICAgICAgICAgICAgICBhdHRycywKICAgICAgICAgICAgICBsaW5rRm4ucmVxdWlyZSAmJiBnZXRDb250cm9sbGVycyhsaW5rRm4uZGlyZWN0aXZlTmFtZSwgbGlua0ZuLnJlcXVpcmUsICRlbGVtZW50LCBlbGVtZW50Q29udHJvbGxlcnMpLAogICAgICAgICAgICAgIHRyYW5zY2x1ZGVGbgogICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIC8vIFJFQ1VSU0lPTgogICAgICAgIC8vIFdlIG9ubHkgcGFzcyB0aGUgaXNvbGF0ZSBzY29wZSwgaWYgdGhlIGlzb2xhdGUgZGlyZWN0aXZlIGhhcyBhIHRlbXBsYXRlLAogICAgICAgIC8vIG90aGVyd2lzZSB0aGUgY2hpbGQgZWxlbWVudHMgZG8gbm90IGJlbG9uZyB0byB0aGUgaXNvbGF0ZSBkaXJlY3RpdmUuCiAgICAgICAgdmFyIHNjb3BlVG9DaGlsZCA9IHNjb3BlOwogICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgJiYgKG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS50ZW1wbGF0ZSB8fCBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUudGVtcGxhdGVVcmwgPT09IG51bGwpKSB7CiAgICAgICAgICBzY29wZVRvQ2hpbGQgPSBpc29sYXRlU2NvcGU7CiAgICAgICAgfQogICAgICAgIGNoaWxkTGlua0ZuICYmIGNoaWxkTGlua0ZuKHNjb3BlVG9DaGlsZCwgbGlua05vZGUuY2hpbGROb2RlcywgdW5kZWZpbmVkLCBib3VuZFRyYW5zY2x1ZGVGbik7CgogICAgICAgIC8vIFBPU1RMSU5LSU5HCiAgICAgICAgZm9yKGkgPSBwb3N0TGlua0Zucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgbGlua0ZuID0gcG9zdExpbmtGbnNbaV07CiAgICAgICAgICBpbnZva2VMaW5rRm4obGlua0ZuLAogICAgICAgICAgICAgIGxpbmtGbi5pc29sYXRlU2NvcGUgPyBpc29sYXRlU2NvcGUgOiBzY29wZSwKICAgICAgICAgICAgICAkZWxlbWVudCwKICAgICAgICAgICAgICBhdHRycywKICAgICAgICAgICAgICBsaW5rRm4ucmVxdWlyZSAmJiBnZXRDb250cm9sbGVycyhsaW5rRm4uZGlyZWN0aXZlTmFtZSwgbGlua0ZuLnJlcXVpcmUsICRlbGVtZW50LCBlbGVtZW50Q29udHJvbGxlcnMpLAogICAgICAgICAgICAgIHRyYW5zY2x1ZGVGbgogICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIC8vIFRoaXMgaXMgdGhlIGZ1bmN0aW9uIHRoYXQgaXMgaW5qZWN0ZWQgYXMgYCR0cmFuc2NsdWRlYC4KICAgICAgICAvLyBOb3RlOiBhbGwgYXJndW1lbnRzIGFyZSBvcHRpb25hbCEKICAgICAgICBmdW5jdGlvbiBjb250cm9sbGVyc0JvdW5kVHJhbnNjbHVkZShzY29wZSwgY2xvbmVBdHRhY2hGbiwgZnV0dXJlUGFyZW50RWxlbWVudCkgewogICAgICAgICAgdmFyIHRyYW5zY2x1ZGVDb250cm9sbGVyczsKCiAgICAgICAgICAvLyBObyBzY29wZSBwYXNzZWQgaW46CiAgICAgICAgICBpZiAoIWlzU2NvcGUoc2NvcGUpKSB7CiAgICAgICAgICAgIGZ1dHVyZVBhcmVudEVsZW1lbnQgPSBjbG9uZUF0dGFjaEZuOwogICAgICAgICAgICBjbG9uZUF0dGFjaEZuID0gc2NvcGU7CiAgICAgICAgICAgIHNjb3BlID0gdW5kZWZpbmVkOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSkgewogICAgICAgICAgICB0cmFuc2NsdWRlQ29udHJvbGxlcnMgPSBlbGVtZW50Q29udHJvbGxlcnM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWZ1dHVyZVBhcmVudEVsZW1lbnQpIHsKICAgICAgICAgICAgZnV0dXJlUGFyZW50RWxlbWVudCA9IGhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlID8gJGVsZW1lbnQucGFyZW50KCkgOiAkZWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBib3VuZFRyYW5zY2x1ZGVGbihzY29wZSwgY2xvbmVBdHRhY2hGbiwgdHJhbnNjbHVkZUNvbnRyb2xsZXJzLCBmdXR1cmVQYXJlbnRFbGVtZW50LCBzY29wZVRvQ2hpbGQpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG1hcmtEaXJlY3RpdmVzQXNJc29sYXRlKGRpcmVjdGl2ZXMpIHsKICAgICAgLy8gbWFyayBhbGwgZGlyZWN0aXZlcyBhcyBuZWVkaW5nIGlzb2xhdGUgc2NvcGUuCiAgICAgIGZvciAodmFyIGogPSAwLCBqaiA9IGRpcmVjdGl2ZXMubGVuZ3RoOyBqIDwgamo7IGorKykgewogICAgICAgIGRpcmVjdGl2ZXNbal0gPSBpbmhlcml0KGRpcmVjdGl2ZXNbal0sIHskJGlzb2xhdGVTY29wZTogdHJ1ZX0pOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBsb29rcyB1cCB0aGUgZGlyZWN0aXZlIGFuZCBkZWNvcmF0ZXMgaXQgd2l0aCBleGNlcHRpb24gaGFuZGxpbmcgYW5kIHByb3BlciBwYXJhbWV0ZXJzLiBXZQogICAgICogY2FsbCB0aGlzIHRoZSBib3VuZERpcmVjdGl2ZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBuYW1lIG9mIHRoZSBkaXJlY3RpdmUgdG8gbG9vayB1cC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhdGlvbiBUaGUgZGlyZWN0aXZlIG11c3QgYmUgZm91bmQgaW4gc3BlY2lmaWMgZm9ybWF0LgogICAgICogICBTdHJpbmcgY29udGFpbmluZyBhbnkgb2YgdGhlc2VzIGNoYXJhY3RlcnM6CiAgICAgKgogICAgICogICAqIGBFYDogZWxlbWVudCBuYW1lCiAgICAgKiAgICogYEEnOiBhdHRyaWJ1dGUKICAgICAqICAgKiBgQ2A6IGNsYXNzCiAgICAgKiAgICogYE1gOiBjb21tZW50CiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gdHJ1ZSBpZiBkaXJlY3RpdmUgd2FzIGFkZGVkLgogICAgICovCiAgICBmdW5jdGlvbiBhZGREaXJlY3RpdmUodERpcmVjdGl2ZXMsIG5hbWUsIGxvY2F0aW9uLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlLCBzdGFydEF0dHJOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgIGVuZEF0dHJOYW1lKSB7CiAgICAgIGlmIChuYW1lID09PSBpZ25vcmVEaXJlY3RpdmUpIHJldHVybiBudWxsOwogICAgICB2YXIgbWF0Y2ggPSBudWxsOwogICAgICBpZiAoaGFzRGlyZWN0aXZlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIGZvcih2YXIgZGlyZWN0aXZlLCBkaXJlY3RpdmVzID0gJGluamVjdG9yLmdldChuYW1lICsgU3VmZml4KSwKICAgICAgICAgICAgaSA9IDAsIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7IGk8aWk7IGkrKykgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZGlyZWN0aXZlID0gZGlyZWN0aXZlc1tpXTsKICAgICAgICAgICAgaWYgKCAobWF4UHJpb3JpdHkgPT09IHVuZGVmaW5lZCB8fCBtYXhQcmlvcml0eSA+IGRpcmVjdGl2ZS5wcmlvcml0eSkgJiYKICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVzdHJpY3QuaW5kZXhPZihsb2NhdGlvbikgIT0gLTEpIHsKICAgICAgICAgICAgICBpZiAoc3RhcnRBdHRyTmFtZSkgewogICAgICAgICAgICAgICAgZGlyZWN0aXZlID0gaW5oZXJpdChkaXJlY3RpdmUsIHskJHN0YXJ0OiBzdGFydEF0dHJOYW1lLCAkJGVuZDogZW5kQXR0ck5hbWV9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdERpcmVjdGl2ZXMucHVzaChkaXJlY3RpdmUpOwogICAgICAgICAgICAgIG1hdGNoID0gZGlyZWN0aXZlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoKGUpIHsgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7IH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoOwogICAgfQoKCiAgICAvKioKICAgICAqIGxvb2tzIHVwIHRoZSBkaXJlY3RpdmUgYW5kIHJldHVybnMgdHJ1ZSBpZiBpdCBpcyBhIG11bHRpLWVsZW1lbnQgZGlyZWN0aXZlLAogICAgICogYW5kIHRoZXJlZm9yZSByZXF1aXJlcyBET00gbm9kZXMgYmV0d2VlbiAtc3RhcnQgYW5kIC1lbmQgbWFya2VycyB0byBiZSBncm91cGVkCiAgICAgKiB0b2dldGhlci4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBuYW1lIG9mIHRoZSBkaXJlY3RpdmUgdG8gbG9vayB1cC4KICAgICAqIEByZXR1cm5zIHRydWUgaWYgZGlyZWN0aXZlIHdhcyByZWdpc3RlcmVkIGFzIG11bHRpLWVsZW1lbnQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRpcmVjdGl2ZUlzTXVsdGlFbGVtZW50KG5hbWUpIHsKICAgICAgaWYgKGhhc0RpcmVjdGl2ZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBmb3IodmFyIGRpcmVjdGl2ZSwgZGlyZWN0aXZlcyA9ICRpbmplY3Rvci5nZXQobmFtZSArIFN1ZmZpeCksCiAgICAgICAgICAgIGkgPSAwLCBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOyBpPGlpOyBpKyspIHsKICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICBpZiAoZGlyZWN0aXZlLm11bHRpRWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogV2hlbiB0aGUgZWxlbWVudCBpcyByZXBsYWNlZCB3aXRoIEhUTUwgdGVtcGxhdGUgdGhlbiB0aGUgbmV3IGF0dHJpYnV0ZXMKICAgICAqIG9uIHRoZSB0ZW1wbGF0ZSBuZWVkIHRvIGJlIG1lcmdlZCB3aXRoIHRoZSBleGlzdGluZyBhdHRyaWJ1dGVzIGluIHRoZSBET00uCiAgICAgKiBUaGUgZGVzaXJlZCBlZmZlY3QgaXMgdG8gaGF2ZSBib3RoIG9mIHRoZSBhdHRyaWJ1dGVzIHByZXNlbnQuCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IGRzdCBkZXN0aW5hdGlvbiBhdHRyaWJ1dGVzIChvcmlnaW5hbCBET00pCiAgICAgKiBAcGFyYW0ge29iamVjdH0gc3JjIHNvdXJjZSBhdHRyaWJ1dGVzIChmcm9tIHRoZSBkaXJlY3RpdmUgdGVtcGxhdGUpCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKGRzdCwgc3JjKSB7CiAgICAgIHZhciBzcmNBdHRyID0gc3JjLiRhdHRyLAogICAgICAgICAgZHN0QXR0ciA9IGRzdC4kYXR0ciwKICAgICAgICAgICRlbGVtZW50ID0gZHN0LiQkZWxlbWVudDsKCiAgICAgIC8vIHJlYXBwbHkgdGhlIG9sZCBhdHRyaWJ1dGVzIHRvIHRoZSBuZXcgZWxlbWVudAogICAgICBmb3JFYWNoKGRzdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIGlmIChrZXkuY2hhckF0KDApICE9ICckJykgewogICAgICAgICAgaWYgKHNyY1trZXldICYmIHNyY1trZXldICE9PSB2YWx1ZSkgewogICAgICAgICAgICB2YWx1ZSArPSAoa2V5ID09PSAnc3R5bGUnID8gJzsnIDogJyAnKSArIHNyY1trZXldOwogICAgICAgICAgfQogICAgICAgICAgZHN0LiRzZXQoa2V5LCB2YWx1ZSwgdHJ1ZSwgc3JjQXR0cltrZXldKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gY29weSB0aGUgbmV3IGF0dHJpYnV0ZXMgb24gdGhlIG9sZCBhdHRycyBvYmplY3QKICAgICAgZm9yRWFjaChzcmMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICBpZiAoa2V5ID09ICdjbGFzcycpIHsKICAgICAgICAgIHNhZmVBZGRDbGFzcygkZWxlbWVudCwgdmFsdWUpOwogICAgICAgICAgZHN0WydjbGFzcyddID0gKGRzdFsnY2xhc3MnXSA/IGRzdFsnY2xhc3MnXSArICcgJyA6ICcnKSArIHZhbHVlOwogICAgICAgIH0gZWxzZSBpZiAoa2V5ID09ICdzdHlsZScpIHsKICAgICAgICAgICRlbGVtZW50LmF0dHIoJ3N0eWxlJywgJGVsZW1lbnQuYXR0cignc3R5bGUnKSArICc7JyArIHZhbHVlKTsKICAgICAgICAgIGRzdFsnc3R5bGUnXSA9IChkc3RbJ3N0eWxlJ10gPyBkc3RbJ3N0eWxlJ10gKyAnOycgOiAnJykgKyB2YWx1ZTsKICAgICAgICAgIC8vIGBkc3RgIHdpbGwgbmV2ZXIgY29udGFpbiBoYXNPd25Qcm9wZXJ0eSBhcyBET00gcGFyc2VyIHdvbid0IGxldCBpdC4KICAgICAgICAgIC8vIFlvdSB3aWxsIGdldCBhbiAiSW52YWxpZENoYXJhY3RlckVycm9yOiBET00gRXhjZXB0aW9uIDUiIGVycm9yIGlmIHlvdQogICAgICAgICAgLy8gaGF2ZSBhbiBhdHRyaWJ1dGUgbGlrZSAiaGFzLW93bi1wcm9wZXJ0eSIgb3IgImRhdGEtaGFzLW93bi1wcm9wZXJ0eSIsIGV0Yy4KICAgICAgICB9IGVsc2UgaWYgKGtleS5jaGFyQXQoMCkgIT0gJyQnICYmICFkc3QuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgIGRzdEF0dHJba2V5XSA9IHNyY0F0dHJba2V5XTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKCiAgICBmdW5jdGlvbiBjb21waWxlVGVtcGxhdGVVcmwoZGlyZWN0aXZlcywgJGNvbXBpbGVOb2RlLCB0QXR0cnMsCiAgICAgICAgJHJvb3RFbGVtZW50LCBjaGlsZFRyYW5zY2x1ZGVGbiwgcHJlTGlua0ZucywgcG9zdExpbmtGbnMsIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpIHsKICAgICAgdmFyIGxpbmtRdWV1ZSA9IFtdLAogICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4sCiAgICAgICAgICBhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4sCiAgICAgICAgICBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlID0gJGNvbXBpbGVOb2RlWzBdLAogICAgICAgICAgb3JpZ0FzeW5jRGlyZWN0aXZlID0gZGlyZWN0aXZlcy5zaGlmdCgpLAogICAgICAgICAgLy8gVGhlIGZhY3QgdGhhdCB3ZSBoYXZlIHRvIGNvcHkgYW5kIHBhdGNoIHRoZSBkaXJlY3RpdmUgc2VlbXMgd3JvbmchCiAgICAgICAgICBkZXJpdmVkU3luY0RpcmVjdGl2ZSA9IGV4dGVuZCh7fSwgb3JpZ0FzeW5jRGlyZWN0aXZlLCB7CiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBudWxsLCB0cmFuc2NsdWRlOiBudWxsLCByZXBsYWNlOiBudWxsLCAkJG9yaWdpbmFsRGlyZWN0aXZlOiBvcmlnQXN5bmNEaXJlY3RpdmUKICAgICAgICAgIH0pLAogICAgICAgICAgdGVtcGxhdGVVcmwgPSAoaXNGdW5jdGlvbihvcmlnQXN5bmNEaXJlY3RpdmUudGVtcGxhdGVVcmwpKQogICAgICAgICAgICAgID8gb3JpZ0FzeW5jRGlyZWN0aXZlLnRlbXBsYXRlVXJsKCRjb21waWxlTm9kZSwgdEF0dHJzKQogICAgICAgICAgICAgIDogb3JpZ0FzeW5jRGlyZWN0aXZlLnRlbXBsYXRlVXJsLAogICAgICAgICAgdGVtcGxhdGVOYW1lc3BhY2UgPSBvcmlnQXN5bmNEaXJlY3RpdmUudGVtcGxhdGVOYW1lc3BhY2U7CgogICAgICAkY29tcGlsZU5vZGUuZW1wdHkoKTsKCiAgICAgICR0ZW1wbGF0ZVJlcXVlc3QoJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmwodGVtcGxhdGVVcmwpKQogICAgICAgIC50aGVuKGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgICAgIHZhciBjb21waWxlTm9kZSwgdGVtcFRlbXBsYXRlQXR0cnMsICR0ZW1wbGF0ZSwgY2hpbGRCb3VuZFRyYW5zY2x1ZGVGbjsKCiAgICAgICAgICBjb250ZW50ID0gZGVub3JtYWxpemVUZW1wbGF0ZShjb250ZW50KTsKCiAgICAgICAgICBpZiAob3JpZ0FzeW5jRGlyZWN0aXZlLnJlcGxhY2UpIHsKICAgICAgICAgICAgaWYgKGpxTGl0ZUlzVGV4dE5vZGUoY29udGVudCkpIHsKICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBbXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAkdGVtcGxhdGUgPSByZW1vdmVDb21tZW50cyh3cmFwVGVtcGxhdGUodGVtcGxhdGVOYW1lc3BhY2UsIHRyaW0oY29udGVudCkpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb21waWxlTm9kZSA9ICR0ZW1wbGF0ZVswXTsKCiAgICAgICAgICAgIGlmICgkdGVtcGxhdGUubGVuZ3RoICE9IDEgfHwgY29tcGlsZU5vZGUubm9kZVR5cGUgIT09IE5PREVfVFlQRV9FTEVNRU5UKSB7CiAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ3RwbHJ0JywKICAgICAgICAgICAgICAgICAgIlRlbXBsYXRlIGZvciBkaXJlY3RpdmUgJ3swfScgbXVzdCBoYXZlIGV4YWN0bHkgb25lIHJvb3QgZWxlbWVudC4gezF9IiwKICAgICAgICAgICAgICAgICAgb3JpZ0FzeW5jRGlyZWN0aXZlLm5hbWUsIHRlbXBsYXRlVXJsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGVtcFRlbXBsYXRlQXR0cnMgPSB7JGF0dHI6IHt9fTsKICAgICAgICAgICAgcmVwbGFjZVdpdGgoJHJvb3RFbGVtZW50LCAkY29tcGlsZU5vZGUsIGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlRGlyZWN0aXZlcyA9IGNvbGxlY3REaXJlY3RpdmVzKGNvbXBpbGVOb2RlLCBbXSwgdGVtcFRlbXBsYXRlQXR0cnMpOwoKICAgICAgICAgICAgaWYgKGlzT2JqZWN0KG9yaWdBc3luY0RpcmVjdGl2ZS5zY29wZSkpIHsKICAgICAgICAgICAgICBtYXJrRGlyZWN0aXZlc0FzSXNvbGF0ZSh0ZW1wbGF0ZURpcmVjdGl2ZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpcmVjdGl2ZXMgPSB0ZW1wbGF0ZURpcmVjdGl2ZXMuY29uY2F0KGRpcmVjdGl2ZXMpOwogICAgICAgICAgICBtZXJnZVRlbXBsYXRlQXR0cmlidXRlcyh0QXR0cnMsIHRlbXBUZW1wbGF0ZUF0dHJzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gYmVmb3JlVGVtcGxhdGVDb21waWxlTm9kZTsKICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoY29udGVudCk7CiAgICAgICAgICB9CgogICAgICAgICAgZGlyZWN0aXZlcy51bnNoaWZ0KGRlcml2ZWRTeW5jRGlyZWN0aXZlKTsKCiAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbiA9IGFwcGx5RGlyZWN0aXZlc1RvTm9kZShkaXJlY3RpdmVzLCBjb21waWxlTm9kZSwgdEF0dHJzLAogICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuLCAkY29tcGlsZU5vZGUsIG9yaWdBc3luY0RpcmVjdGl2ZSwgcHJlTGlua0ZucywgcG9zdExpbmtGbnMsCiAgICAgICAgICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dCk7CiAgICAgICAgICBmb3JFYWNoKCRyb290RWxlbWVudCwgZnVuY3Rpb24obm9kZSwgaSkgewogICAgICAgICAgICBpZiAobm9kZSA9PSBjb21waWxlTm9kZSkgewogICAgICAgICAgICAgICRyb290RWxlbWVudFtpXSA9ICRjb21waWxlTm9kZVswXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4gPSBjb21waWxlTm9kZXMoJGNvbXBpbGVOb2RlWzBdLmNoaWxkTm9kZXMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKCiAgICAgICAgICB3aGlsZShsaW5rUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBzY29wZSA9IGxpbmtRdWV1ZS5zaGlmdCgpLAogICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVMaW5rTm9kZSA9IGxpbmtRdWV1ZS5zaGlmdCgpLAogICAgICAgICAgICAgICAgbGlua1Jvb3RFbGVtZW50ID0gbGlua1F1ZXVlLnNoaWZ0KCksCiAgICAgICAgICAgICAgICBib3VuZFRyYW5zY2x1ZGVGbiA9IGxpbmtRdWV1ZS5zaGlmdCgpLAogICAgICAgICAgICAgICAgbGlua05vZGUgPSAkY29tcGlsZU5vZGVbMF07CgogICAgICAgICAgICBpZiAoc2NvcGUuJCRkZXN0cm95ZWQpIGNvbnRpbnVlOwoKICAgICAgICAgICAgaWYgKGJlZm9yZVRlbXBsYXRlTGlua05vZGUgIT09IGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGUpIHsKICAgICAgICAgICAgICB2YXIgb2xkQ2xhc3NlcyA9IGJlZm9yZVRlbXBsYXRlTGlua05vZGUuY2xhc3NOYW1lOwoKICAgICAgICAgICAgICBpZiAoIShwcmV2aW91c0NvbXBpbGVDb250ZXh0Lmhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlICYmCiAgICAgICAgICAgICAgICAgIG9yaWdBc3luY0RpcmVjdGl2ZS5yZXBsYWNlKSkgewogICAgICAgICAgICAgICAgLy8gaXQgd2FzIGNsb25lZCB0aGVyZWZvcmUgd2UgaGF2ZSB0byBjbG9uZSBhcyB3ZWxsLgogICAgICAgICAgICAgICAgbGlua05vZGUgPSBqcUxpdGVDbG9uZShjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlcGxhY2VXaXRoKGxpbmtSb290RWxlbWVudCwganFMaXRlKGJlZm9yZVRlbXBsYXRlTGlua05vZGUpLCBsaW5rTm9kZSk7CgogICAgICAgICAgICAgIC8vIENvcHkgaW4gQ1NTIGNsYXNzZXMgZnJvbSBvcmlnaW5hbCBub2RlCiAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKGpxTGl0ZShsaW5rTm9kZSksIG9sZENsYXNzZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhZnRlclRlbXBsYXRlTm9kZUxpbmtGbi50cmFuc2NsdWRlT25UaGlzRWxlbWVudCkgewogICAgICAgICAgICAgIGNoaWxkQm91bmRUcmFuc2NsdWRlRm4gPSBjcmVhdGVCb3VuZFRyYW5zY2x1ZGVGbihzY29wZSwgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4udHJhbnNjbHVkZSwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNoaWxkQm91bmRUcmFuc2NsdWRlRm4gPSBib3VuZFRyYW5zY2x1ZGVGbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbihhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4sIHNjb3BlLCBsaW5rTm9kZSwgJHJvb3RFbGVtZW50LAogICAgICAgICAgICAgIGNoaWxkQm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgfQogICAgICAgICAgbGlua1F1ZXVlID0gbnVsbDsKICAgICAgICB9KTsKCiAgICAgIHJldHVybiBmdW5jdGlvbiBkZWxheWVkTm9kZUxpbmtGbihpZ25vcmVDaGlsZExpbmtGbiwgc2NvcGUsIG5vZGUsIHJvb3RFbGVtZW50LCBib3VuZFRyYW5zY2x1ZGVGbikgewogICAgICAgIHZhciBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuID0gYm91bmRUcmFuc2NsdWRlRm47CiAgICAgICAgaWYgKHNjb3BlLiQkZGVzdHJveWVkKSByZXR1cm47CiAgICAgICAgaWYgKGxpbmtRdWV1ZSkgewogICAgICAgICAgbGlua1F1ZXVlLnB1c2goc2NvcGUpOwogICAgICAgICAgbGlua1F1ZXVlLnB1c2gobm9kZSk7CiAgICAgICAgICBsaW5rUXVldWUucHVzaChyb290RWxlbWVudCk7CiAgICAgICAgICBsaW5rUXVldWUucHVzaChjaGlsZEJvdW5kVHJhbnNjbHVkZUZuKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuLnRyYW5zY2x1ZGVPblRoaXNFbGVtZW50KSB7CiAgICAgICAgICAgIGNoaWxkQm91bmRUcmFuc2NsdWRlRm4gPSBjcmVhdGVCb3VuZFRyYW5zY2x1ZGVGbihzY29wZSwgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4udHJhbnNjbHVkZSwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgfQogICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4oYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLCBzY29wZSwgbm9kZSwgcm9vdEVsZW1lbnQsIGNoaWxkQm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBTb3J0aW5nIGZ1bmN0aW9uIGZvciBib3VuZCBkaXJlY3RpdmVzLgogICAgICovCiAgICBmdW5jdGlvbiBieVByaW9yaXR5KGEsIGIpIHsKICAgICAgdmFyIGRpZmYgPSBiLnByaW9yaXR5IC0gYS5wcmlvcml0eTsKICAgICAgaWYgKGRpZmYgIT09IDApIHJldHVybiBkaWZmOwogICAgICBpZiAoYS5uYW1lICE9PSBiLm5hbWUpIHJldHVybiAoYS5uYW1lIDwgYi5uYW1lKSA/IC0xIDogMTsKICAgICAgcmV0dXJuIGEuaW5kZXggLSBiLmluZGV4OwogICAgfQoKCiAgICBmdW5jdGlvbiBhc3NlcnROb0R1cGxpY2F0ZSh3aGF0LCBwcmV2aW91c0RpcmVjdGl2ZSwgZGlyZWN0aXZlLCBlbGVtZW50KSB7CiAgICAgIGlmIChwcmV2aW91c0RpcmVjdGl2ZSkgewogICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCdtdWx0aWRpcicsICdNdWx0aXBsZSBkaXJlY3RpdmVzIFt7MH0sIHsxfV0gYXNraW5nIGZvciB7Mn0gb246IHszfScsCiAgICAgICAgICAgIHByZXZpb3VzRGlyZWN0aXZlLm5hbWUsIGRpcmVjdGl2ZS5uYW1lLCB3aGF0LCBzdGFydGluZ1RhZyhlbGVtZW50KSk7CiAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gYWRkVGV4dEludGVycG9sYXRlRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIHRleHQpIHsKICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUodGV4dCwgdHJ1ZSk7CiAgICAgIGlmIChpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgZGlyZWN0aXZlcy5wdXNoKHsKICAgICAgICAgIHByaW9yaXR5OiAwLAogICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gdGV4dEludGVycG9sYXRlQ29tcGlsZUZuKHRlbXBsYXRlTm9kZSkgewogICAgICAgICAgICB2YXIgdGVtcGxhdGVOb2RlUGFyZW50ID0gdGVtcGxhdGVOb2RlLnBhcmVudCgpLAogICAgICAgICAgICAgICAgaGFzQ29tcGlsZVBhcmVudCA9ICEhdGVtcGxhdGVOb2RlUGFyZW50Lmxlbmd0aDsKCiAgICAgICAgICAgIC8vIFdoZW4gdHJhbnNjbHVkaW5nIGEgdGVtcGxhdGUgdGhhdCBoYXMgYmluZGluZ3MgaW4gdGhlIHJvb3QKICAgICAgICAgICAgLy8gd2UgZG9uJ3QgaGF2ZSBhIHBhcmVudCBhbmQgdGh1cyBuZWVkIHRvIGFkZCB0aGUgY2xhc3MgZHVyaW5nIGxpbmtpbmcgZm4uCiAgICAgICAgICAgIGlmIChoYXNDb21waWxlUGFyZW50KSBjb21waWxlLiQkYWRkQmluZGluZ0NsYXNzKHRlbXBsYXRlTm9kZVBhcmVudCk7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gdGV4dEludGVycG9sYXRlTGlua0ZuKHNjb3BlLCBub2RlKSB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IG5vZGUucGFyZW50KCk7CiAgICAgICAgICAgICAgaWYgKCFoYXNDb21waWxlUGFyZW50KSBjb21waWxlLiQkYWRkQmluZGluZ0NsYXNzKHBhcmVudCk7CiAgICAgICAgICAgICAgY29tcGlsZS4kJGFkZEJpbmRpbmdJbmZvKHBhcmVudCwgaW50ZXJwb2xhdGVGbi5leHByZXNzaW9ucyk7CiAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGludGVycG9sYXRlRm4sIGZ1bmN0aW9uIGludGVycG9sYXRlRm5XYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgbm9kZVswXS5ub2RlVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfQoKCiAgICBmdW5jdGlvbiB3cmFwVGVtcGxhdGUodHlwZSwgdGVtcGxhdGUpIHsKICAgICAgdHlwZSA9IGxvd2VyY2FzZSh0eXBlIHx8ICdodG1sJyk7CiAgICAgIHN3aXRjaCh0eXBlKSB7CiAgICAgIGNhc2UgJ3N2Zyc6CiAgICAgIGNhc2UgJ21hdGgnOgogICAgICAgIHZhciB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgd3JhcHBlci5pbm5lckhUTUwgPSAnPCcrdHlwZSsnPicrdGVtcGxhdGUrJzwvJyt0eXBlKyc+JzsKICAgICAgICByZXR1cm4gd3JhcHBlci5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXM7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIGdldFRydXN0ZWRDb250ZXh0KG5vZGUsIGF0dHJOb3JtYWxpemVkTmFtZSkgewogICAgICBpZiAoYXR0ck5vcm1hbGl6ZWROYW1lID09ICJzcmNkb2MiKSB7CiAgICAgICAgcmV0dXJuICRzY2UuSFRNTDsKICAgICAgfQogICAgICB2YXIgdGFnID0gbm9kZU5hbWVfKG5vZGUpOwogICAgICAvLyBtYWN0aW9uW3hsaW5rOmhyZWZdIGNhbiBzb3VyY2UgU1ZHLiAgSXQncyBub3QgbGltaXRlZCB0byA8bWFjdGlvbj4uCiAgICAgIGlmIChhdHRyTm9ybWFsaXplZE5hbWUgPT0gInhsaW5rSHJlZiIgfHwKICAgICAgICAgICh0YWcgPT0gImZvcm0iICYmIGF0dHJOb3JtYWxpemVkTmFtZSA9PSAiYWN0aW9uIikgfHwKICAgICAgICAgICh0YWcgIT0gImltZyIgJiYgKGF0dHJOb3JtYWxpemVkTmFtZSA9PSAic3JjIiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ck5vcm1hbGl6ZWROYW1lID09ICJuZ1NyYyIpKSkgewogICAgICAgIHJldHVybiAkc2NlLlJFU09VUkNFX1VSTDsKICAgICAgfQogICAgfQoKCiAgICBmdW5jdGlvbiBhZGRBdHRySW50ZXJwb2xhdGVEaXJlY3RpdmUobm9kZSwgZGlyZWN0aXZlcywgdmFsdWUsIG5hbWUsIGFsbE9yTm90aGluZykgewogICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZSh2YWx1ZSwgdHJ1ZSk7CgogICAgICAvLyBubyBpbnRlcnBvbGF0aW9uIGZvdW5kIC0+IGlnbm9yZQogICAgICBpZiAoIWludGVycG9sYXRlRm4pIHJldHVybjsKCgogICAgICBpZiAobmFtZSA9PT0gIm11bHRpcGxlIiAmJiBub2RlTmFtZV8obm9kZSkgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoInNlbG11bHRpIiwKICAgICAgICAgICAgIkJpbmRpbmcgdG8gdGhlICdtdWx0aXBsZScgYXR0cmlidXRlIGlzIG5vdCBzdXBwb3J0ZWQuIEVsZW1lbnQ6IHswfSIsCiAgICAgICAgICAgIHN0YXJ0aW5nVGFnKG5vZGUpKTsKICAgICAgfQoKICAgICAgZGlyZWN0aXZlcy5wdXNoKHsKICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHByZTogZnVuY3Rpb24gYXR0ckludGVycG9sYXRlUHJlTGlua0ZuKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICB2YXIgJCRvYnNlcnZlcnMgPSAoYXR0ci4kJG9ic2VydmVycyB8fCAoYXR0ci4kJG9ic2VydmVycyA9IHt9KSk7CgogICAgICAgICAgICAgICAgaWYgKEVWRU5UX0hBTkRMRVJfQVRUUl9SRUdFWFAudGVzdChuYW1lKSkgewogICAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycignbm9kb21ldmVudHMnLAogICAgICAgICAgICAgICAgICAgICAgIkludGVycG9sYXRpb25zIGZvciBIVE1MIERPTSBldmVudCBhdHRyaWJ1dGVzIGFyZSBkaXNhbGxvd2VkLiAgUGxlYXNlIHVzZSB0aGUgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgIm5nLSB2ZXJzaW9ucyAoc3VjaCBhcyBuZy1jbGljayBpbnN0ZWFkIG9mIG9uY2xpY2spIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGF0dHJpYnV0ZSB3YXMgcmVtb3ZlZCwgdGhlbiB3ZSBhcmUgZG9uZQogICAgICAgICAgICAgICAgaWYgKCFhdHRyW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGludGVycG9sYXRlIGFnYWluLCBpbiBjYXNlIHRoZSBhdHRyaWJ1dGUgdmFsdWUgaGFzIGJlZW4gdXBkYXRlZAogICAgICAgICAgICAgICAgLy8gKGUuZy4gYnkgYW5vdGhlciBkaXJlY3RpdmUncyBjb21waWxlIGZ1bmN0aW9uKQogICAgICAgICAgICAgICAgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShhdHRyW25hbWVdLCB0cnVlLCBnZXRUcnVzdGVkQ29udGV4dChub2RlLCBuYW1lKSwKICAgICAgICAgICAgICAgICAgICBBTExfT1JfTk9USElOR19BVFRSU1tuYW1lXSB8fCBhbGxPck5vdGhpbmcpOwoKICAgICAgICAgICAgICAgIC8vIGlmIGF0dHJpYnV0ZSB3YXMgdXBkYXRlZCBzbyB0aGF0IHRoZXJlIGlzIG5vIGludGVycG9sYXRpb24gZ29pbmcgb24gd2UgZG9uJ3Qgd2FudCB0bwogICAgICAgICAgICAgICAgLy8gcmVnaXN0ZXIgYW55IG9ic2VydmVycwogICAgICAgICAgICAgICAgaWYgKCFpbnRlcnBvbGF0ZUZuKSByZXR1cm47CgogICAgICAgICAgICAgICAgLy8gaW5pdGlhbGl6ZSBhdHRyIG9iamVjdCBzbyB0aGF0IGl0J3MgcmVhZHkgaW4gY2FzZSB3ZSBuZWVkIHRoZSB2YWx1ZSBmb3IgaXNvbGF0ZQogICAgICAgICAgICAgICAgLy8gc2NvcGUgaW5pdGlhbGl6YXRpb24sIG90aGVyd2lzZSB0aGUgdmFsdWUgd291bGQgbm90IGJlIGF2YWlsYWJsZSBmcm9tIGlzb2xhdGUKICAgICAgICAgICAgICAgIC8vIGRpcmVjdGl2ZSdzIGxpbmtpbmcgZm4gZHVyaW5nIGxpbmtpbmcgcGhhc2UKICAgICAgICAgICAgICAgIGF0dHJbbmFtZV0gPSBpbnRlcnBvbGF0ZUZuKHNjb3BlKTsKCiAgICAgICAgICAgICAgICAoJCRvYnNlcnZlcnNbbmFtZV0gfHwgKCQkb2JzZXJ2ZXJzW25hbWVdID0gW10pKS4kJGludGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIChhdHRyLiQkb2JzZXJ2ZXJzICYmIGF0dHIuJCRvYnNlcnZlcnNbbmFtZV0uJCRzY29wZSB8fCBzY29wZSkuCiAgICAgICAgICAgICAgICAgICR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZUZuV2F0Y2hBY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgLy9zcGVjaWFsIGNhc2UgZm9yIGNsYXNzIGF0dHJpYnV0ZSBhZGRpdGlvbiArIHJlbW92YWwKICAgICAgICAgICAgICAgICAgICAvL3NvIHRoYXQgY2xhc3MgY2hhbmdlcyBjYW4gdGFwIGludG8gdGhlIGFuaW1hdGlvbgogICAgICAgICAgICAgICAgICAgIC8vaG9va3MgcHJvdmlkZWQgYnkgdGhlICRhbmltYXRlIHNlcnZpY2UuIEJlIHN1cmUgdG8KICAgICAgICAgICAgICAgICAgICAvL3NraXAgYW5pbWF0aW9ucyB3aGVuIHRoZSBmaXJzdCBkaWdlc3Qgb2NjdXJzICh3aGVuCiAgICAgICAgICAgICAgICAgICAgLy9ib3RoIHRoZSBuZXcgYW5kIHRoZSBvbGQgdmFsdWVzIGFyZSB0aGUgc2FtZSkgc2luY2UKICAgICAgICAgICAgICAgICAgICAvL3RoZSBDU1MgY2xhc3NlcyBhcmUgdGhlIG5vbi1pbnRlcnBvbGF0ZWQgdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgaWYobmFtZSA9PT0gJ2NsYXNzJyAmJiBuZXdWYWx1ZSAhPSBvbGRWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgYXR0ci4kdXBkYXRlQ2xhc3MobmV3VmFsdWUsIG9sZFZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KG5hbWUsIG5ld1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgfSk7CiAgICB9CgoKICAgIC8qKgogICAgICogVGhpcyBpcyBhIHNwZWNpYWwganFMaXRlLnJlcGxhY2VXaXRoLCB3aGljaCBjYW4gcmVwbGFjZSBpdGVtcyB3aGljaAogICAgICogaGF2ZSBubyBwYXJlbnRzLCBwcm92aWRlZCB0aGF0IHRoZSBjb250YWluaW5nIGpxTGl0ZSBjb2xsZWN0aW9uIGlzIHByb3ZpZGVkLgogICAgICoKICAgICAqIEBwYXJhbSB7SnFMaXRlPX0gJHJvb3RFbGVtZW50IFRoZSByb290IG9mIHRoZSBjb21waWxlIHRyZWUuIFVzZWQgc28gdGhhdCB3ZSBjYW4gcmVwbGFjZSBub2RlcwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW4gdGhlIHJvb3Qgb2YgdGhlIHRyZWUuCiAgICAgKiBAcGFyYW0ge0pxTGl0ZX0gZWxlbWVudHNUb1JlbW92ZSBUaGUganFMaXRlIGVsZW1lbnQgd2hpY2ggd2UgYXJlIGdvaW5nIHRvIHJlcGxhY2UuIFdlIGtlZXAKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSBzaGVsbCwgYnV0IHJlcGxhY2UgaXRzIERPTSBub2RlIHJlZmVyZW5jZS4KICAgICAqIEBwYXJhbSB7Tm9kZX0gbmV3Tm9kZSBUaGUgbmV3IERPTSBub2RlLgogICAgICovCiAgICBmdW5jdGlvbiByZXBsYWNlV2l0aCgkcm9vdEVsZW1lbnQsIGVsZW1lbnRzVG9SZW1vdmUsIG5ld05vZGUpIHsKICAgICAgdmFyIGZpcnN0RWxlbWVudFRvUmVtb3ZlID0gZWxlbWVudHNUb1JlbW92ZVswXSwKICAgICAgICAgIHJlbW92ZUNvdW50ID0gZWxlbWVudHNUb1JlbW92ZS5sZW5ndGgsCiAgICAgICAgICBwYXJlbnQgPSBmaXJzdEVsZW1lbnRUb1JlbW92ZS5wYXJlbnROb2RlLAogICAgICAgICAgaSwgaWk7CgogICAgICBpZiAoJHJvb3RFbGVtZW50KSB7CiAgICAgICAgZm9yKGkgPSAwLCBpaSA9ICRyb290RWxlbWVudC5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICBpZiAoJHJvb3RFbGVtZW50W2ldID09IGZpcnN0RWxlbWVudFRvUmVtb3ZlKSB7CiAgICAgICAgICAgICRyb290RWxlbWVudFtpKytdID0gbmV3Tm9kZTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IGksIGoyID0gaiArIHJlbW92ZUNvdW50IC0gMSwKICAgICAgICAgICAgICAgICAgICAgamogPSAkcm9vdEVsZW1lbnQubGVuZ3RoOwogICAgICAgICAgICAgICAgIGogPCBqajsgaisrLCBqMisrKSB7CiAgICAgICAgICAgICAgaWYgKGoyIDwgamopIHsKICAgICAgICAgICAgICAgICRyb290RWxlbWVudFtqXSA9ICRyb290RWxlbWVudFtqMl07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSAkcm9vdEVsZW1lbnRbal07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgICRyb290RWxlbWVudC5sZW5ndGggLT0gcmVtb3ZlQ291bnQgLSAxOwoKICAgICAgICAgICAgLy8gSWYgdGhlIHJlcGxhY2VkIGVsZW1lbnQgaXMgYWxzbyB0aGUgalF1ZXJ5IC5jb250ZXh0IHRoZW4gcmVwbGFjZSBpdAogICAgICAgICAgICAvLyAuY29udGV4dCBpcyBhIGRlcHJlY2F0ZWQgalF1ZXJ5IGFwaSwgc28gd2Ugc2hvdWxkIHNldCBpdCBvbmx5IHdoZW4galF1ZXJ5IHNldCBpdAogICAgICAgICAgICAvLyBodHRwOi8vYXBpLmpxdWVyeS5jb20vY29udGV4dC8KICAgICAgICAgICAgaWYgKCRyb290RWxlbWVudC5jb250ZXh0ID09PSBmaXJzdEVsZW1lbnRUb1JlbW92ZSkgewogICAgICAgICAgICAgICRyb290RWxlbWVudC5jb250ZXh0ID0gbmV3Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKG5ld05vZGUsIGZpcnN0RWxlbWVudFRvUmVtb3ZlKTsKICAgICAgfQoKICAgICAgLy8gVE9ETyhwZXJmKTogd2hhdCdzIHRoaXMgZG9jdW1lbnQgZnJhZ21lbnQgZm9yPyBpcyBpdCBuZWVkZWQ/IGNhbiB3ZSBhdCBsZWFzdCByZXVzZSBpdD8KICAgICAgdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChmaXJzdEVsZW1lbnRUb1JlbW92ZSk7CgogICAgICAvLyBDb3B5IG92ZXIgdXNlciBkYXRhICh0aGF0IGluY2x1ZGVzIEFuZ3VsYXIncyAkc2NvcGUgZXRjLikuIERvbid0IGNvcHkgcHJpdmF0ZQogICAgICAvLyBkYXRhIGhlcmUgYmVjYXVzZSB0aGVyZSdzIG5vIHB1YmxpYyBpbnRlcmZhY2UgaW4galF1ZXJ5IHRvIGRvIHRoYXQgYW5kIGNvcHlpbmcgb3ZlcgogICAgICAvLyBldmVudCBsaXN0ZW5lcnMgKHdoaWNoIGlzIHRoZSBtYWluIHVzZSBvZiBwcml2YXRlIGRhdGEpIHdvdWxkbid0IHdvcmsgYW55d2F5LgogICAgICBqcUxpdGUobmV3Tm9kZSkuZGF0YShqcUxpdGUoZmlyc3RFbGVtZW50VG9SZW1vdmUpLmRhdGEoKSk7CgogICAgICAvLyBSZW1vdmUgZGF0YSBvZiB0aGUgcmVwbGFjZWQgZWxlbWVudC4gV2UgY2Fubm90IGp1c3QgY2FsbCAucmVtb3ZlKCkKICAgICAgLy8gb24gdGhlIGVsZW1lbnQgaXQgc2luY2UgdGhhdCB3b3VsZCBkZWFsbG9jYXRlIHNjb3BlIHRoYXQgaXMgbmVlZGVkCiAgICAgIC8vIGZvciB0aGUgbmV3IG5vZGUuIEluc3RlYWQsIHJlbW92ZSB0aGUgZGF0YSAibWFudWFsbHkiLgogICAgICBpZiAoIWpRdWVyeSkgewogICAgICAgIGRlbGV0ZSBqcUxpdGUuY2FjaGVbZmlyc3RFbGVtZW50VG9SZW1vdmVbanFMaXRlLmV4cGFuZG9dXTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBqUXVlcnkgMi54IGRvZXNuJ3QgZXhwb3NlIHRoZSBkYXRhIHN0b3JhZ2UuIFVzZSBqUXVlcnkuY2xlYW5EYXRhIHRvIGNsZWFuIHVwIGFmdGVyCiAgICAgICAgLy8gdGhlIHJlcGxhY2VkIGVsZW1lbnQuIFRoZSBjbGVhbkRhdGEgdmVyc2lvbiBtb25rZXktcGF0Y2hlZCBieSBBbmd1bGFyIHdvdWxkIGNhdXNlCiAgICAgICAgLy8gdGhlIHNjb3BlIHRvIGJlIHRyYXNoZWQgYW5kIHdlIGRvIG5lZWQgdGhlIHZlcnkgc2FtZSBzY29wZSB0byB3b3JrIHdpdGggdGhlIG5ldwogICAgICAgIC8vIGVsZW1lbnQuIEhvd2V2ZXIsIHdlIGNhbm5vdCBqdXN0IGNhY2hlIHRoZSBub24tcGF0Y2hlZCB2ZXJzaW9uIGFuZCB1c2UgaXQgaGVyZSBhcwogICAgICAgIC8vIHRoYXQgd291bGQgYnJlYWsgaWYgYW5vdGhlciBsaWJyYXJ5IHBhdGNoZXMgdGhlIG1ldGhvZCBhZnRlciBBbmd1bGFyIGRvZXMgKG9uZQogICAgICAgIC8vIGV4YW1wbGUgaXMgalF1ZXJ5IFVJKS4gSW5zdGVhZCwgc2V0IGEgZmxhZyBpbmRpY2F0aW5nIHNjb3BlIGRlc3Ryb3lpbmcgc2hvdWxkIGJlCiAgICAgICAgLy8gc2tpcHBlZCB0aGlzIG9uZSB0aW1lLgogICAgICAgIHNraXBEZXN0cm95T25OZXh0SlF1ZXJ5Q2xlYW5EYXRhID0gdHJ1ZTsKICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKFtmaXJzdEVsZW1lbnRUb1JlbW92ZV0pOwogICAgICB9CgogICAgICBmb3IgKHZhciBrID0gMSwga2sgPSBlbGVtZW50c1RvUmVtb3ZlLmxlbmd0aDsgayA8IGtrOyBrKyspIHsKICAgICAgICB2YXIgZWxlbWVudCA9IGVsZW1lbnRzVG9SZW1vdmVba107CiAgICAgICAganFMaXRlKGVsZW1lbnQpLnJlbW92ZSgpOyAvLyBtdXN0IGRvIHRoaXMgd2F5IHRvIGNsZWFuIHVwIGV4cGFuZG8KICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChlbGVtZW50KTsKICAgICAgICBkZWxldGUgZWxlbWVudHNUb1JlbW92ZVtrXTsKICAgICAgfQoKICAgICAgZWxlbWVudHNUb1JlbW92ZVswXSA9IG5ld05vZGU7CiAgICAgIGVsZW1lbnRzVG9SZW1vdmUubGVuZ3RoID0gMTsKICAgIH0KCgogICAgZnVuY3Rpb24gY2xvbmVBbmRBbm5vdGF0ZUZuKGZuLCBhbm5vdGF0aW9uKSB7CiAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oKSB7IHJldHVybiBmbi5hcHBseShudWxsLCBhcmd1bWVudHMpOyB9LCBmbiwgYW5ub3RhdGlvbik7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGludm9rZUxpbmtGbihsaW5rRm4sIHNjb3BlLCAkZWxlbWVudCwgYXR0cnMsIGNvbnRyb2xsZXJzLCB0cmFuc2NsdWRlRm4pIHsKICAgICAgdHJ5IHsKICAgICAgICBsaW5rRm4oc2NvcGUsICRlbGVtZW50LCBhdHRycywgY29udHJvbGxlcnMsIHRyYW5zY2x1ZGVGbik7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUsIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgICAgIH0KICAgIH0KICB9XTsKfQoKdmFyIFBSRUZJWF9SRUdFWFAgPSAvXih4W1w6XC1fXXxkYXRhW1w6XC1fXSkvaTsKLyoqCiAqIENvbnZlcnRzIGFsbCBhY2NlcHRlZCBkaXJlY3RpdmVzIGZvcm1hdCBpbnRvIHByb3BlciBkaXJlY3RpdmUgbmFtZS4KICogQWxsIG9mIHRoZXNlIHdpbGwgYmVjb21lICdteURpcmVjdGl2ZSc6CiAqICAgbXk6RGlyZWN0aXZlCiAqICAgbXktZGlyZWN0aXZlCiAqICAgeC1teS1kaXJlY3RpdmUKICogICBkYXRhLW15OmRpcmVjdGl2ZQogKgogKiBBbHNvIHRoZXJlIGlzIHNwZWNpYWwgY2FzZSBmb3IgTW96IHByZWZpeCBzdGFydGluZyB3aXRoIHVwcGVyIGNhc2UgbGV0dGVyLgogKiBAcGFyYW0gbmFtZSBOYW1lIHRvIG5vcm1hbGl6ZQogKi8KZnVuY3Rpb24gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUpIHsKICByZXR1cm4gY2FtZWxDYXNlKG5hbWUucmVwbGFjZShQUkVGSVhfUkVHRVhQLCAnJykpOwp9CgovKioKICogQG5nZG9jIHR5cGUKICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgc2hhcmVkIG9iamVjdCBiZXR3ZWVuIGRpcmVjdGl2ZSBjb21waWxlIC8gbGlua2luZyBmdW5jdGlvbnMgd2hpY2ggY29udGFpbnMgbm9ybWFsaXplZCBET00KICogZWxlbWVudCBhdHRyaWJ1dGVzLiBUaGUgdmFsdWVzIHJlZmxlY3QgY3VycmVudCBiaW5kaW5nIHN0YXRlIGB7eyB9fWAuIFRoZSBub3JtYWxpemF0aW9uIGlzCiAqIG5lZWRlZCBzaW5jZSBhbGwgb2YgdGhlc2UgYXJlIHRyZWF0ZWQgYXMgZXF1aXZhbGVudCBpbiBBbmd1bGFyOgogKgogKiBgYGAKICogICAgPHNwYW4gbmc6YmluZD0iYSIgbmctYmluZD0iYSIgZGF0YS1uZy1iaW5kPSJhIiB4LW5nLWJpbmQ9ImEiPgogKiBgYGAKICovCgovKioKICogQG5nZG9jIHByb3BlcnR5CiAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRhdHRyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIG1hcCBvZiBET00gZWxlbWVudCBhdHRyaWJ1dGUgbmFtZXMgdG8gdGhlIG5vcm1hbGl6ZWQgbmFtZS4gVGhpcyBpcwogKiBuZWVkZWQgdG8gZG8gcmV2ZXJzZSBsb29rdXAgZnJvbSBub3JtYWxpemVkIG5hbWUgYmFjayB0byBhY3R1YWwgbmFtZS4KICovCgoKLyoqCiAqIEBuZ2RvYyBtZXRob2QKICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJHNldAogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogU2V0IERPTSBlbGVtZW50IGF0dHJpYnV0ZSB2YWx1ZS4KICoKICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTm9ybWFsaXplZCBlbGVtZW50IGF0dHJpYnV0ZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB0byBtb2RpZnkuIFRoZSBuYW1lIGlzCiAqICAgICAgICAgIHJldmVyc2UtdHJhbnNsYXRlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRhdHRyICRhdHRyfQogKiAgICAgICAgICBwcm9wZXJ0eSB0byB0aGUgb3JpZ2luYWwgbmFtZS4KICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIFZhbHVlIHRvIHNldCB0aGUgYXR0cmlidXRlIHRvLiBUaGUgdmFsdWUgY2FuIGJlIGFuIGludGVycG9sYXRlZCBzdHJpbmcuCiAqLwoKCgovKioKICogQ2xvc3VyZSBjb21waWxlciB0eXBlIGluZm9ybWF0aW9uCiAqLwoKZnVuY3Rpb24gbm9kZXNldExpbmtpbmdGbigKICAvKiBhbmd1bGFyLlNjb3BlICovIHNjb3BlLAogIC8qIE5vZGVMaXN0ICovIG5vZGVMaXN0LAogIC8qIEVsZW1lbnQgKi8gcm9vdEVsZW1lbnQsCiAgLyogZnVuY3Rpb24oRnVuY3Rpb24pICovIGJvdW5kVHJhbnNjbHVkZUZuCil7fQoKZnVuY3Rpb24gZGlyZWN0aXZlTGlua2luZ0ZuKAogIC8qIG5vZGVzZXRMaW5raW5nRm4gKi8gbm9kZXNldExpbmtpbmdGbiwKICAvKiBhbmd1bGFyLlNjb3BlICovIHNjb3BlLAogIC8qIE5vZGUgKi8gbm9kZSwKICAvKiBFbGVtZW50ICovIHJvb3RFbGVtZW50LAogIC8qIGZ1bmN0aW9uKEZ1bmN0aW9uKSAqLyBib3VuZFRyYW5zY2x1ZGVGbgope30KCmZ1bmN0aW9uIHRva2VuRGlmZmVyZW5jZShzdHIxLCBzdHIyKSB7CiAgdmFyIHZhbHVlcyA9ICcnLAogICAgICB0b2tlbnMxID0gc3RyMS5zcGxpdCgvXHMrLyksCiAgICAgIHRva2VuczIgPSBzdHIyLnNwbGl0KC9ccysvKTsKCiAgb3V0ZXI6CiAgZm9yKHZhciBpID0gMDsgaSA8IHRva2VuczEubGVuZ3RoOyBpKyspIHsKICAgIHZhciB0b2tlbiA9IHRva2VuczFbaV07CiAgICBmb3IodmFyIGogPSAwOyBqIDwgdG9rZW5zMi5sZW5ndGg7IGorKykgewogICAgICBpZih0b2tlbiA9PSB0b2tlbnMyW2pdKSBjb250aW51ZSBvdXRlcjsKICAgIH0KICAgIHZhbHVlcyArPSAodmFsdWVzLmxlbmd0aCA+IDAgPyAnICcgOiAnJykgKyB0b2tlbjsKICB9CiAgcmV0dXJuIHZhbHVlczsKfQoKZnVuY3Rpb24gcmVtb3ZlQ29tbWVudHMoanFOb2RlcykgewogIGpxTm9kZXMgPSBqcUxpdGUoanFOb2Rlcyk7CiAgdmFyIGkgPSBqcU5vZGVzLmxlbmd0aDsKCiAgaWYgKGkgPD0gMSkgewogICAgcmV0dXJuIGpxTm9kZXM7CiAgfQoKICB3aGlsZSAoaS0tKSB7CiAgICB2YXIgbm9kZSA9IGpxTm9kZXNbaV07CiAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gTk9ERV9UWVBFX0NPTU1FTlQpIHsKICAgICAgc3BsaWNlLmNhbGwoanFOb2RlcywgaSwgMSk7CiAgICB9CiAgfQogIHJldHVybiBqcU5vZGVzOwp9CgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRjb250cm9sbGVyUHJvdmlkZXIKICogQGRlc2NyaXB0aW9uCiAqIFRoZSB7QGxpbmsgbmcuJGNvbnRyb2xsZXIgJGNvbnRyb2xsZXIgc2VydmljZX0gaXMgdXNlZCBieSBBbmd1bGFyIHRvIGNyZWF0ZSBuZXcKICogY29udHJvbGxlcnMuCiAqCiAqIFRoaXMgcHJvdmlkZXIgYWxsb3dzIGNvbnRyb2xsZXIgcmVnaXN0cmF0aW9uIHZpYSB0aGUKICoge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIgcmVnaXN0ZXJ9IG1ldGhvZC4KICovCmZ1bmN0aW9uICRDb250cm9sbGVyUHJvdmlkZXIoKSB7CiAgdmFyIGNvbnRyb2xsZXJzID0ge30sCiAgICAgIGdsb2JhbHMgPSBmYWxzZSwKICAgICAgQ05UUkxfUkVHID0gL14oXFMrKShccythc1xzKyhcdyspKT8kLzsKCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyCiAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fSBuYW1lIENvbnRyb2xsZXIgbmFtZSwgb3IgYW4gb2JqZWN0IG1hcCBvZiBjb250cm9sbGVycyB3aGVyZSB0aGUga2V5cyBhcmUKICAgKiAgICB0aGUgbmFtZXMgYW5kIHRoZSB2YWx1ZXMgYXJlIHRoZSBjb25zdHJ1Y3RvcnMuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxBcnJheX0gY29uc3RydWN0b3IgQ29udHJvbGxlciBjb25zdHJ1Y3RvciBmbiAob3B0aW9uYWxseSBkZWNvcmF0ZWQgd2l0aCBESQogICAqICAgIGFubm90YXRpb25zIGluIHRoZSBhcnJheSBub3RhdGlvbikuCiAgICovCiAgdGhpcy5yZWdpc3RlciA9IGZ1bmN0aW9uKG5hbWUsIGNvbnN0cnVjdG9yKSB7CiAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCAnY29udHJvbGxlcicpOwogICAgaWYgKGlzT2JqZWN0KG5hbWUpKSB7CiAgICAgIGV4dGVuZChjb250cm9sbGVycywgbmFtZSk7CiAgICB9IGVsc2UgewogICAgICBjb250cm9sbGVyc1tuYW1lXSA9IGNvbnN0cnVjdG9yOwogICAgfQogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkY29udHJvbGxlclByb3ZpZGVyI2FsbG93R2xvYmFscwogICAqIEBkZXNjcmlwdGlvbiBJZiBjYWxsZWQsIGFsbG93cyBgJGNvbnRyb2xsZXJgIHRvIGZpbmQgY29udHJvbGxlciBjb25zdHJ1Y3RvcnMgb24gYHdpbmRvd2AKICAgKi8KICB0aGlzLmFsbG93R2xvYmFscyA9IGZ1bmN0aW9uKCkgewogICAgZ2xvYmFscyA9IHRydWU7CiAgfTsKCgogIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgJyR3aW5kb3cnLCBmdW5jdGlvbigkaW5qZWN0b3IsICR3aW5kb3cpIHsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgKiBAbmFtZSAkY29udHJvbGxlcgogICAgICogQHJlcXVpcmVzICRpbmplY3RvcgogICAgICoKICAgICAqIEBwYXJhbSB7RnVuY3Rpb258c3RyaW5nfSBjb25zdHJ1Y3RvciBJZiBjYWxsZWQgd2l0aCBhIGZ1bmN0aW9uIHRoZW4gaXQncyBjb25zaWRlcmVkIHRvIGJlIHRoZQogICAgICogICAgY29udHJvbGxlciBjb25zdHJ1Y3RvciBmdW5jdGlvbi4gT3RoZXJ3aXNlIGl0J3MgY29uc2lkZXJlZCB0byBiZSBhIHN0cmluZyB3aGljaCBpcyB1c2VkCiAgICAgKiAgICB0byByZXRyaWV2ZSB0aGUgY29udHJvbGxlciBjb25zdHJ1Y3RvciB1c2luZyB0aGUgZm9sbG93aW5nIHN0ZXBzOgogICAgICoKICAgICAqICAgICogY2hlY2sgaWYgYSBjb250cm9sbGVyIHdpdGggZ2l2ZW4gbmFtZSBpcyByZWdpc3RlcmVkIHZpYSBgJGNvbnRyb2xsZXJQcm92aWRlcmAKICAgICAqICAgICogY2hlY2sgaWYgZXZhbHVhdGluZyB0aGUgc3RyaW5nIG9uIHRoZSBjdXJyZW50IHNjb3BlIHJldHVybnMgYSBjb25zdHJ1Y3RvcgogICAgICogICAgKiBpZiAkY29udHJvbGxlclByb3ZpZGVyI2FsbG93R2xvYmFscywgY2hlY2sgYHdpbmRvd1tjb25zdHJ1Y3Rvcl1gIG9uIHRoZSBnbG9iYWwKICAgICAqICAgICAgYHdpbmRvd2Agb2JqZWN0IChub3QgcmVjb21tZW5kZWQpCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IGxvY2FscyBJbmplY3Rpb24gbG9jYWxzIGZvciBDb250cm9sbGVyLgogICAgICogQHJldHVybiB7T2JqZWN0fSBJbnN0YW5jZSBvZiBnaXZlbiBjb250cm9sbGVyLgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogYCRjb250cm9sbGVyYCBzZXJ2aWNlIGlzIHJlc3BvbnNpYmxlIGZvciBpbnN0YW50aWF0aW5nIGNvbnRyb2xsZXJzLgogICAgICoKICAgICAqIEl0J3MganVzdCBhIHNpbXBsZSBjYWxsIHRvIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LCBidXQgZXh0cmFjdGVkIGludG8KICAgICAqIGEgc2VydmljZSwgc28gdGhhdCBvbmUgY2FuIG92ZXJyaWRlIHRoaXMgc2VydmljZSB3aXRoIFtCQyB2ZXJzaW9uXShodHRwczovL2dpc3QuZ2l0aHViLmNvbS8xNjQ5Nzg4KS4KICAgICAqLwogICAgcmV0dXJuIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGxvY2FscywgbGF0ZXIsIGlkZW50KSB7CiAgICAgIC8vIFBSSVZBVEUgQVBJOgogICAgICAvLyAgIHBhcmFtIGBsYXRlcmAgLS0tIGluZGljYXRlcyB0aGF0IHRoZSBjb250cm9sbGVyJ3MgY29uc3RydWN0b3IgaXMgaW52b2tlZCBhdCBhIGxhdGVyIHRpbWUuCiAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgSWYgdHJ1ZSwgJGNvbnRyb2xsZXIgd2lsbCBhbGxvY2F0ZSB0aGUgb2JqZWN0IHdpdGggdGhlIGNvcnJlY3QKICAgICAgLy8gICAgICAgICAgICAgICAgICAgICBwcm90b3R5cGUgY2hhaW4sIGJ1dCB3aWxsIG5vdCBpbnZva2UgdGhlIGNvbnRyb2xsZXIgdW50aWwgYSByZXR1cm5lZAogICAgICAvLyAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrIGlzIGludm9rZWQuCiAgICAgIC8vICAgcGFyYW0gYGlkZW50YCAtLS0gQW4gb3B0aW9uYWwgbGFiZWwgd2hpY2ggb3ZlcnJpZGVzIHRoZSBsYWJlbCBwYXJzZWQgZnJvbSB0aGUgY29udHJvbGxlcgogICAgICAvLyAgICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24sIGlmIGFueS4KICAgICAgdmFyIGluc3RhbmNlLCBtYXRjaCwgY29uc3RydWN0b3IsIGlkZW50aWZpZXI7CiAgICAgIGxhdGVyID0gbGF0ZXIgPT09IHRydWU7CiAgICAgIGlmIChpZGVudCAmJiBpc1N0cmluZyhpZGVudCkpIHsKICAgICAgICBpZGVudGlmaWVyID0gaWRlbnQ7CiAgICAgIH0KCiAgICAgIGlmKGlzU3RyaW5nKGV4cHJlc3Npb24pKSB7CiAgICAgICAgbWF0Y2ggPSBleHByZXNzaW9uLm1hdGNoKENOVFJMX1JFRyksCiAgICAgICAgY29uc3RydWN0b3IgPSBtYXRjaFsxXSwKICAgICAgICBpZGVudGlmaWVyID0gaWRlbnRpZmllciB8fCBtYXRjaFszXTsKICAgICAgICBleHByZXNzaW9uID0gY29udHJvbGxlcnMuaGFzT3duUHJvcGVydHkoY29uc3RydWN0b3IpCiAgICAgICAgICAgID8gY29udHJvbGxlcnNbY29uc3RydWN0b3JdCiAgICAgICAgICAgIDogZ2V0dGVyKGxvY2Fscy4kc2NvcGUsIGNvbnN0cnVjdG9yLCB0cnVlKSB8fAogICAgICAgICAgICAgICAgKGdsb2JhbHMgPyBnZXR0ZXIoJHdpbmRvdywgY29uc3RydWN0b3IsIHRydWUpIDogdW5kZWZpbmVkKTsKCiAgICAgICAgYXNzZXJ0QXJnRm4oZXhwcmVzc2lvbiwgY29uc3RydWN0b3IsIHRydWUpOwogICAgICB9CgogICAgICBpZiAobGF0ZXIpIHsKICAgICAgICAvLyBJbnN0YW50aWF0ZSBjb250cm9sbGVyIGxhdGVyOgogICAgICAgIC8vIFRoaXMgbWFjaGluZXJ5IGlzIHVzZWQgdG8gY3JlYXRlIGFuIGluc3RhbmNlIG9mIHRoZSBvYmplY3QgYmVmb3JlIGNhbGxpbmcgdGhlCiAgICAgICAgLy8gY29udHJvbGxlcidzIGNvbnN0cnVjdG9yIGl0c2VsZi4KICAgICAgICAvLwogICAgICAgIC8vIFRoaXMgYWxsb3dzIHByb3BlcnRpZXMgdG8gYmUgYWRkZWQgdG8gdGhlIGNvbnRyb2xsZXIgYmVmb3JlIHRoZSBjb25zdHJ1Y3RvciBpcwogICAgICAgIC8vIGludm9rZWQuIFByaW1hcmlseSwgdGhpcyBpcyB1c2VkIGZvciBpc29sYXRlIHNjb3BlIGJpbmRpbmdzIGluICRjb21waWxlLgogICAgICAgIC8vCiAgICAgICAgLy8gVGhpcyBmZWF0dXJlIGlzIG5vdCBpbnRlbmRlZCBmb3IgdXNlIGJ5IGFwcGxpY2F0aW9ucywgYW5kIGlzIHRodXMgbm90IGRvY3VtZW50ZWQKICAgICAgICAvLyBwdWJsaWNseS4KICAgICAgICB2YXIgQ29uc3RydWN0b3IgPSBmdW5jdGlvbigpIHt9OwogICAgICAgIENvbnN0cnVjdG9yLnByb3RvdHlwZSA9IChpc0FycmF5KGV4cHJlc3Npb24pID8KICAgICAgICAgIGV4cHJlc3Npb25bZXhwcmVzc2lvbi5sZW5ndGggLSAxXSA6IGV4cHJlc3Npb24pLnByb3RvdHlwZTsKICAgICAgICBpbnN0YW5jZSA9IG5ldyBDb25zdHJ1Y3RvcigpOwoKICAgICAgICBpZiAoaWRlbnRpZmllcikgewogICAgICAgICAgYWRkSWRlbnRpZmllcihsb2NhbHMsIGlkZW50aWZpZXIsIGluc3RhbmNlLCBjb25zdHJ1Y3RvciB8fCBleHByZXNzaW9uLm5hbWUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbigpIHsKICAgICAgICAgICRpbmplY3Rvci5pbnZva2UoZXhwcmVzc2lvbiwgaW5zdGFuY2UsIGxvY2FscywgY29uc3RydWN0b3IpOwogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0sIHsKICAgICAgICAgIGluc3RhbmNlOiBpbnN0YW5jZSwKICAgICAgICAgIGlkZW50aWZpZXI6IGlkZW50aWZpZXIKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgaW5zdGFuY2UgPSAkaW5qZWN0b3IuaW5zdGFudGlhdGUoZXhwcmVzc2lvbiwgbG9jYWxzLCBjb25zdHJ1Y3Rvcik7CgogICAgICBpZiAoaWRlbnRpZmllcikgewogICAgICAgIGFkZElkZW50aWZpZXIobG9jYWxzLCBpZGVudGlmaWVyLCBpbnN0YW5jZSwgY29uc3RydWN0b3IgfHwgZXhwcmVzc2lvbi5uYW1lKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgfTsKCiAgICBmdW5jdGlvbiBhZGRJZGVudGlmaWVyKGxvY2FscywgaWRlbnRpZmllciwgaW5zdGFuY2UsIG5hbWUpIHsKICAgICAgaWYgKCEobG9jYWxzICYmIGlzT2JqZWN0KGxvY2Fscy4kc2NvcGUpKSkgewogICAgICAgIHRocm93IG1pbkVycignJGNvbnRyb2xsZXInKSgnbm9zY3AnLAogICAgICAgICAgIkNhbm5vdCBleHBvcnQgY29udHJvbGxlciAnezB9JyBhcyAnezF9JyEgTm8gJHNjb3BlIG9iamVjdCBwcm92aWRlZCB2aWEgYGxvY2Fsc2AuIiwKICAgICAgICAgIG5hbWUsIGlkZW50aWZpZXIpOwogICAgICB9CgogICAgICBsb2NhbHMuJHNjb3BlW2lkZW50aWZpZXJdID0gaW5zdGFuY2U7CiAgICB9CiAgfV07Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkZG9jdW1lbnQKICogQHJlcXVpcmVzICR3aW5kb3cKICoKICogQGRlc2NyaXB0aW9uCiAqIEEge0BsaW5rIGFuZ3VsYXIuZWxlbWVudCBqUXVlcnkgb3IganFMaXRlfSB3cmFwcGVyIGZvciB0aGUgYnJvd3NlcidzIGB3aW5kb3cuZG9jdW1lbnRgIG9iamVjdC4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJkb2N1bWVudEV4YW1wbGUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICAgIDxwPiRkb2N1bWVudCB0aXRsZTogPGIgbmctYmluZD0idGl0bGUiPjwvYj48L3A+CiAgICAgICAgIDxwPndpbmRvdy5kb2N1bWVudCB0aXRsZTogPGIgbmctYmluZD0id2luZG93VGl0bGUiPjwvYj48L3A+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgIGFuZ3VsYXIubW9kdWxlKCdkb2N1bWVudEV4YW1wbGUnLCBbXSkKICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZG9jdW1lbnQpIHsKICAgICAgICAgICAkc2NvcGUudGl0bGUgPSAkZG9jdW1lbnRbMF0udGl0bGU7CiAgICAgICAgICAgJHNjb3BlLndpbmRvd1RpdGxlID0gYW5ndWxhci5lbGVtZW50KHdpbmRvdy5kb2N1bWVudClbMF0udGl0bGU7CiAgICAgICAgIH1dKTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmZ1bmN0aW9uICREb2N1bWVudFByb3ZpZGVyKCl7CiAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24od2luZG93KXsKICAgIHJldHVybiBqcUxpdGUod2luZG93LmRvY3VtZW50KTsKICB9XTsKfQoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRleGNlcHRpb25IYW5kbGVyCiAqIEByZXF1aXJlcyBuZy4kbG9nCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBbnkgdW5jYXVnaHQgZXhjZXB0aW9uIGluIGFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGVsZWdhdGVkIHRvIHRoaXMgc2VydmljZS4KICogVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gc2ltcGx5IGRlbGVnYXRlcyB0byBgJGxvZy5lcnJvcmAgd2hpY2ggbG9ncyBpdCBpbnRvCiAqIHRoZSBicm93c2VyIGNvbnNvbGUuCiAqCiAqIEluIHVuaXQgdGVzdHMsIGlmIGBhbmd1bGFyLW1vY2tzLmpzYCBpcyBsb2FkZWQsIHRoaXMgc2VydmljZSBpcyBvdmVycmlkZGVuIGJ5CiAqIHtAbGluayBuZ01vY2suJGV4Y2VwdGlvbkhhbmRsZXIgbW9jayAkZXhjZXB0aW9uSGFuZGxlcn0gd2hpY2ggYWlkcyBpbiB0ZXN0aW5nLgogKgogKiAjIyBFeGFtcGxlOgogKgogKiBgYGBqcwogKiAgIGFuZ3VsYXIubW9kdWxlKCdleGNlcHRpb25PdmVycmlkZScsIFtdKS5mYWN0b3J5KCckZXhjZXB0aW9uSGFuZGxlcicsIGZ1bmN0aW9uICgpIHsKICogICAgIHJldHVybiBmdW5jdGlvbiAoZXhjZXB0aW9uLCBjYXVzZSkgewogKiAgICAgICBleGNlcHRpb24ubWVzc2FnZSArPSAnIChjYXVzZWQgYnkgIicgKyBjYXVzZSArICciKSc7CiAqICAgICAgIHRocm93IGV4Y2VwdGlvbjsKICogICAgIH07CiAqICAgfSk7CiAqIGBgYAogKgogKiBUaGlzIGV4YW1wbGUgd2lsbCBvdmVycmlkZSB0aGUgbm9ybWFsIGFjdGlvbiBvZiBgJGV4Y2VwdGlvbkhhbmRsZXJgLCB0byBtYWtlIGFuZ3VsYXIKICogZXhjZXB0aW9ucyBmYWlsIGhhcmQgd2hlbiB0aGV5IGhhcHBlbiwgaW5zdGVhZCBvZiBqdXN0IGxvZ2dpbmcgdG8gdGhlIGNvbnNvbGUuCiAqCiAqIDxociAvPgogKiBOb3RlLCB0aGF0IGNvZGUgZXhlY3V0ZWQgaW4gZXZlbnQtbGlzdGVuZXJzIChldmVuIHRob3NlIHJlZ2lzdGVyZWQgdXNpbmcganFMaXRlJ3MgYG9uYC9gYmluZGAKICogbWV0aG9kcykgZG9lcyBub3QgZGVsZWdhdGUgZXhjZXB0aW9ucyB0byB0aGUge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfQogKiAodW5sZXNzIGV4ZWN1dGVkIGR1cmluZyBhIGRpZ2VzdCkuCiAqCiAqIElmIHlvdSB3aXNoLCB5b3UgY2FuIG1hbnVhbGx5IGRlbGVnYXRlIGV4Y2VwdGlvbnMsIGUuZy4KICogYHRyeSB7IC4uLiB9IGNhdGNoKGUpIHsgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7IH1gCiAqCiAqIEBwYXJhbSB7RXJyb3J9IGV4Y2VwdGlvbiBFeGNlcHRpb24gYXNzb2NpYXRlZCB3aXRoIHRoZSBlcnJvci4KICogQHBhcmFtIHtzdHJpbmc9fSBjYXVzZSBvcHRpb25hbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY29udGV4dCBpbiB3aGljaAogKiAgICAgICB0aGUgZXJyb3Igd2FzIHRocm93bi4KICoKICovCmZ1bmN0aW9uICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIoKSB7CiAgdGhpcy4kZ2V0ID0gWyckbG9nJywgZnVuY3Rpb24oJGxvZykgewogICAgcmV0dXJuIGZ1bmN0aW9uKGV4Y2VwdGlvbiwgY2F1c2UpIHsKICAgICAgJGxvZy5lcnJvci5hcHBseSgkbG9nLCBhcmd1bWVudHMpOwogICAgfTsKICB9XTsKfQoKLyoqCiAqIFBhcnNlIGhlYWRlcnMgaW50byBrZXkgdmFsdWUgb2JqZWN0CiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBoZWFkZXJzIFJhdyBoZWFkZXJzIGFzIGEgc3RyaW5nCiAqIEByZXR1cm5zIHtPYmplY3R9IFBhcnNlZCBoZWFkZXJzIGFzIGtleSB2YWx1ZSBvYmplY3QKICovCmZ1bmN0aW9uIHBhcnNlSGVhZGVycyhoZWFkZXJzKSB7CiAgdmFyIHBhcnNlZCA9IHt9LCBrZXksIHZhbCwgaTsKCiAgaWYgKCFoZWFkZXJzKSByZXR1cm4gcGFyc2VkOwoKICBmb3JFYWNoKGhlYWRlcnMuc3BsaXQoJ1xuJyksIGZ1bmN0aW9uKGxpbmUpIHsKICAgIGkgPSBsaW5lLmluZGV4T2YoJzonKTsKICAgIGtleSA9IGxvd2VyY2FzZSh0cmltKGxpbmUuc3Vic3RyKDAsIGkpKSk7CiAgICB2YWwgPSB0cmltKGxpbmUuc3Vic3RyKGkgKyAxKSk7CgogICAgaWYgKGtleSkgewogICAgICBwYXJzZWRba2V5XSA9IHBhcnNlZFtrZXldID8gcGFyc2VkW2tleV0gKyAnLCAnICsgdmFsIDogdmFsOwogICAgfQogIH0pOwoKICByZXR1cm4gcGFyc2VkOwp9CgoKLyoqCiAqIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHByb3ZpZGVzIGFjY2VzcyB0byBwYXJzZWQgaGVhZGVycy4KICoKICogSGVhZGVycyBhcmUgbGF6eSBwYXJzZWQgd2hlbiBmaXJzdCByZXF1ZXN0ZWQuCiAqIEBzZWUgcGFyc2VIZWFkZXJzCiAqCiAqIEBwYXJhbSB7KHN0cmluZ3xPYmplY3QpfSBoZWFkZXJzIEhlYWRlcnMgdG8gcHJvdmlkZSBhY2Nlc3MgdG8uCiAqIEByZXR1cm5zIHtmdW5jdGlvbihzdHJpbmc9KX0gUmV0dXJucyBhIGdldHRlciBmdW5jdGlvbiB3aGljaCBpZiBjYWxsZWQgd2l0aDoKICoKICogICAtIGlmIGNhbGxlZCB3aXRoIHNpbmdsZSBhbiBhcmd1bWVudCByZXR1cm5zIGEgc2luZ2xlIGhlYWRlciB2YWx1ZSBvciBudWxsCiAqICAgLSBpZiBjYWxsZWQgd2l0aCBubyBhcmd1bWVudHMgcmV0dXJucyBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgaGVhZGVycy4KICovCmZ1bmN0aW9uIGhlYWRlcnNHZXR0ZXIoaGVhZGVycykgewogIHZhciBoZWFkZXJzT2JqID0gaXNPYmplY3QoaGVhZGVycykgPyBoZWFkZXJzIDogdW5kZWZpbmVkOwoKICByZXR1cm4gZnVuY3Rpb24obmFtZSkgewogICAgaWYgKCFoZWFkZXJzT2JqKSBoZWFkZXJzT2JqID0gIHBhcnNlSGVhZGVycyhoZWFkZXJzKTsKCiAgICBpZiAobmFtZSkgewogICAgICByZXR1cm4gaGVhZGVyc09ialtsb3dlcmNhc2UobmFtZSldIHx8IG51bGw7CiAgICB9CgogICAgcmV0dXJuIGhlYWRlcnNPYmo7CiAgfTsKfQoKCi8qKgogKiBDaGFpbiBhbGwgZ2l2ZW4gZnVuY3Rpb25zCiAqCiAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgYm90aCByZXF1ZXN0IGFuZCByZXNwb25zZSB0cmFuc2Zvcm1pbmcKICoKICogQHBhcmFtIHsqfSBkYXRhIERhdGEgdG8gdHJhbnNmb3JtLgogKiBAcGFyYW0ge2Z1bmN0aW9uKHN0cmluZz0pfSBoZWFkZXJzIEh0dHAgaGVhZGVycyBnZXR0ZXIgZm4uCiAqIEBwYXJhbSB7KEZ1bmN0aW9ufEFycmF5LjxGdW5jdGlvbj4pfSBmbnMgRnVuY3Rpb24gb3IgYW4gYXJyYXkgb2YgZnVuY3Rpb25zLgogKiBAcmV0dXJucyB7Kn0gVHJhbnNmb3JtZWQgZGF0YS4KICovCmZ1bmN0aW9uIHRyYW5zZm9ybURhdGEoZGF0YSwgaGVhZGVycywgZm5zKSB7CiAgaWYgKGlzRnVuY3Rpb24oZm5zKSkKICAgIHJldHVybiBmbnMoZGF0YSwgaGVhZGVycyk7CgogIGZvckVhY2goZm5zLCBmdW5jdGlvbihmbikgewogICAgZGF0YSA9IGZuKGRhdGEsIGhlYWRlcnMpOwogIH0pOwoKICByZXR1cm4gZGF0YTsKfQoKCmZ1bmN0aW9uIGlzU3VjY2VzcyhzdGF0dXMpIHsKICByZXR1cm4gMjAwIDw9IHN0YXR1cyAmJiBzdGF0dXMgPCAzMDA7Cn0KCgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRodHRwUHJvdmlkZXIKICogQGRlc2NyaXB0aW9uCiAqIFVzZSBgJGh0dHBQcm92aWRlcmAgdG8gY2hhbmdlIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIHRoZSB7QGxpbmsgbmcuJGh0dHAgJGh0dHB9IHNlcnZpY2UuCiAqICovCmZ1bmN0aW9uICRIdHRwUHJvdmlkZXIoKSB7CiAgdmFyIEpTT05fU1RBUlQgPSAvXlxzKihcW3xce1teXHtdKS8sCiAgICAgIEpTT05fRU5EID0gL1tcfVxdXVxzKiQvLAogICAgICBQUk9URUNUSU9OX1BSRUZJWCA9IC9eXClcXVx9Jyw/XG4vLAogICAgICBBUFBMSUNBVElPTl9KU09OID0gJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICBDT05URU5UX1RZUEVfQVBQTElDQVRJT05fSlNPTiA9IHsnQ29udGVudC1UeXBlJzogQVBQTElDQVRJT05fSlNPTiArICc7Y2hhcnNldD11dGYtOCd9OwoKICAvKioKICAgKiBAbmdkb2MgcHJvcGVydHkKICAgKiBAbmFtZSAkaHR0cFByb3ZpZGVyI2RlZmF1bHRzCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBPYmplY3QgY29udGFpbmluZyBkZWZhdWx0IHZhbHVlcyBmb3IgYWxsIHtAbGluayBuZy4kaHR0cCAkaHR0cH0gcmVxdWVzdHMuCiAgICoKICAgKiAtICoqYGRlZmF1bHRzLnhzcmZDb29raWVOYW1lYCoqIC0ge3N0cmluZ30gLSBOYW1lIG9mIGNvb2tpZSBjb250YWluaW5nIHRoZSBYU1JGIHRva2VuLgogICAqIERlZmF1bHRzIHZhbHVlIGlzIGAnWFNSRi1UT0tFTidgLgogICAqCiAgICogLSAqKmBkZWZhdWx0cy54c3JmSGVhZGVyTmFtZWAqKiAtIHtzdHJpbmd9IC0gTmFtZSBvZiBIVFRQIGhlYWRlciB0byBwb3B1bGF0ZSB3aXRoIHRoZQogICAqIFhTUkYgdG9rZW4uIERlZmF1bHRzIHZhbHVlIGlzIGAnWC1YU1JGLVRPS0VOJ2AuCiAgICoKICAgKiAtICoqYGRlZmF1bHRzLmhlYWRlcnNgKiogLSB7T2JqZWN0fSAtIERlZmF1bHQgaGVhZGVycyBmb3IgYWxsICRodHRwIHJlcXVlc3RzLgogICAqIFJlZmVyIHRvIHtAbGluayBuZy4kaHR0cCNzZXR0aW5nLWh0dHAtaGVhZGVycyAkaHR0cH0gZm9yIGRvY3VtZW50YXRpb24gb24KICAgKiBzZXR0aW5nIGRlZmF1bHQgaGVhZGVycy4KICAgKiAgICAgLSAqKmBkZWZhdWx0cy5oZWFkZXJzLmNvbW1vbmAqKgogICAqICAgICAtICoqYGRlZmF1bHRzLmhlYWRlcnMucG9zdGAqKgogICAqICAgICAtICoqYGRlZmF1bHRzLmhlYWRlcnMucHV0YCoqCiAgICogICAgIC0gKipgZGVmYXVsdHMuaGVhZGVycy5wYXRjaGAqKgogICAqKi8KICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgLy8gdHJhbnNmb3JtIGluY29taW5nIHJlc3BvbnNlIGRhdGEKICAgIHRyYW5zZm9ybVJlc3BvbnNlOiBbZnVuY3Rpb24gZGVmYXVsdEh0dHBSZXNwb25zZVRyYW5zZm9ybShkYXRhLCBoZWFkZXJzKSB7CiAgICAgIGlmIChpc1N0cmluZyhkYXRhKSkgewogICAgICAgIC8vIHN0cmlwIGpzb24gdnVsbmVyYWJpbGl0eSBwcm90ZWN0aW9uIHByZWZpeAogICAgICAgIGRhdGEgPSBkYXRhLnJlcGxhY2UoUFJPVEVDVElPTl9QUkVGSVgsICcnKTsKICAgICAgICB2YXIgY29udGVudFR5cGUgPSBoZWFkZXJzKCdDb250ZW50LVR5cGUnKTsKICAgICAgICBpZiAoKGNvbnRlbnRUeXBlICYmIGNvbnRlbnRUeXBlLmluZGV4T2YoQVBQTElDQVRJT05fSlNPTikgPT09IDApIHx8CiAgICAgICAgICAgIChKU09OX1NUQVJULnRlc3QoZGF0YSkgJiYgSlNPTl9FTkQudGVzdChkYXRhKSkpIHsKICAgICAgICAgIGRhdGEgPSBmcm9tSnNvbihkYXRhKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGE7CiAgICB9XSwKCiAgICAvLyB0cmFuc2Zvcm0gb3V0Z29pbmcgcmVxdWVzdCBkYXRhCiAgICB0cmFuc2Zvcm1SZXF1ZXN0OiBbZnVuY3Rpb24oZCkgewogICAgICByZXR1cm4gaXNPYmplY3QoZCkgJiYgIWlzRmlsZShkKSAmJiAhaXNCbG9iKGQpID8gdG9Kc29uKGQpIDogZDsKICAgIH1dLAoKICAgIC8vIGRlZmF1bHQgaGVhZGVycwogICAgaGVhZGVyczogewogICAgICBjb21tb246IHsKICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICovKicKICAgICAgfSwKICAgICAgcG9zdDogICBzaGFsbG93Q29weShDT05URU5UX1RZUEVfQVBQTElDQVRJT05fSlNPTiksCiAgICAgIHB1dDogICAgc2hhbGxvd0NvcHkoQ09OVEVOVF9UWVBFX0FQUExJQ0FUSU9OX0pTT04pLAogICAgICBwYXRjaDogIHNoYWxsb3dDb3B5KENPTlRFTlRfVFlQRV9BUFBMSUNBVElPTl9KU09OKQogICAgfSwKCiAgICB4c3JmQ29va2llTmFtZTogJ1hTUkYtVE9LRU4nLAogICAgeHNyZkhlYWRlck5hbWU6ICdYLVhTUkYtVE9LRU4nCiAgfTsKCiAgdmFyIHVzZUFwcGx5QXN5bmMgPSBmYWxzZTsKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGh0dHBQcm92aWRlciN1c2VBcHBseUFzeW5jCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBDb25maWd1cmUgJGh0dHAgc2VydmljZSB0byBjb21iaW5lIHByb2Nlc3Npbmcgb2YgbXVsdGlwbGUgaHR0cCByZXNwb25zZXMgcmVjZWl2ZWQgYXQgYXJvdW5kCiAgICogdGhlIHNhbWUgdGltZSB2aWEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5QXN5bmMgJHJvb3RTY29wZS4kYXBwbHlBc3luY30uIFRoaXMgY2FuIHJlc3VsdCBpbgogICAqIHNpZ25pZmljYW50IHBlcmZvcm1hbmNlIGltcHJvdmVtZW50IGZvciBiaWdnZXIgYXBwbGljYXRpb25zIHRoYXQgbWFrZSBtYW55IEhUVFAgcmVxdWVzdHMKICAgKiBjb25jdXJyZW50bHkgKGNvbW1vbiBkdXJpbmcgYXBwbGljYXRpb24gYm9vdHN0cmFwKS4KICAgKgogICAqIERlZmF1bHRzIHRvIGZhbHNlLiBJZiBubyB2YWx1ZSBpcyBzcGVjaWZlZCwgcmV0dXJucyB0aGUgY3VycmVudCBjb25maWd1cmVkIHZhbHVlLgogICAqCiAgICogQHBhcmFtIHtib29sZWFuPX0gdmFsdWUgSWYgdHJ1ZSwgd2hlbiByZXF1ZXN0cyBhcmUgbG9hZGVkLCB0aGV5IHdpbGwgc2NoZWR1bGUgYSBkZWZlcnJlZAogICAqICAgICJhcHBseSIgb24gdGhlIG5leHQgdGljaywgZ2l2aW5nIHRpbWUgZm9yIHN1YnNlcXVlbnQgcmVxdWVzdHMgaW4gYSByb3VnaGx5IH4xMG1zIHdpbmRvdwogICAqICAgIHRvIGxvYWQgYW5kIHNoYXJlIHRoZSBzYW1lIGRpZ2VzdCBjeWNsZS4KICAgKgogICAqIEByZXR1cm5zIHtib29sZWFufE9iamVjdH0gSWYgYSB2YWx1ZSBpcyBzcGVjaWZpZWQsIHJldHVybnMgdGhlICRodHRwUHJvdmlkZXIgZm9yIGNoYWluaW5nLgogICAqICAgIG90aGVyd2lzZSwgcmV0dXJucyB0aGUgY3VycmVudCBjb25maWd1cmVkIHZhbHVlLgogICAqKi8KICB0aGlzLnVzZUFwcGx5QXN5bmMgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgdXNlQXBwbHlBc3luYyA9ICEhdmFsdWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgcmV0dXJuIHVzZUFwcGx5QXN5bmM7CiAgfTsKCiAgLyoqCiAgICogQXJlIG9yZGVyZWQgYnkgcmVxdWVzdCwgaS5lLiB0aGV5IGFyZSBhcHBsaWVkIGluIHRoZSBzYW1lIG9yZGVyIGFzIHRoZQogICAqIGFycmF5LCBvbiByZXF1ZXN0LCBidXQgcmV2ZXJzZSBvcmRlciwgb24gcmVzcG9uc2UuCiAgICovCiAgdmFyIGludGVyY2VwdG9yRmFjdG9yaWVzID0gdGhpcy5pbnRlcmNlcHRvcnMgPSBbXTsKCiAgdGhpcy4kZ2V0ID0gWyckaHR0cEJhY2tlbmQnLCAnJGJyb3dzZXInLCAnJGNhY2hlRmFjdG9yeScsICckcm9vdFNjb3BlJywgJyRxJywgJyRpbmplY3RvcicsCiAgICAgIGZ1bmN0aW9uKCRodHRwQmFja2VuZCwgJGJyb3dzZXIsICRjYWNoZUZhY3RvcnksICRyb290U2NvcGUsICRxLCAkaW5qZWN0b3IpIHsKCiAgICB2YXIgZGVmYXVsdENhY2hlID0gJGNhY2hlRmFjdG9yeSgnJGh0dHAnKTsKCiAgICAvKioKICAgICAqIEludGVyY2VwdG9ycyBzdG9yZWQgaW4gcmV2ZXJzZSBvcmRlci4gSW5uZXIgaW50ZXJjZXB0b3JzIGJlZm9yZSBvdXRlciBpbnRlcmNlcHRvcnMuCiAgICAgKiBUaGUgcmV2ZXJzYWwgaXMgbmVlZGVkIHNvIHRoYXQgd2UgY2FuIGJ1aWxkIHVwIHRoZSBpbnRlcmNlcHRpb24gY2hhaW4gYXJvdW5kIHRoZQogICAgICogc2VydmVyIHJlcXVlc3QuCiAgICAgKi8KICAgIHZhciByZXZlcnNlZEludGVyY2VwdG9ycyA9IFtdOwoKICAgIGZvckVhY2goaW50ZXJjZXB0b3JGYWN0b3JpZXMsIGZ1bmN0aW9uKGludGVyY2VwdG9yRmFjdG9yeSkgewogICAgICByZXZlcnNlZEludGVyY2VwdG9ycy51bnNoaWZ0KGlzU3RyaW5nKGludGVyY2VwdG9yRmFjdG9yeSkKICAgICAgICAgID8gJGluamVjdG9yLmdldChpbnRlcmNlcHRvckZhY3RvcnkpIDogJGluamVjdG9yLmludm9rZShpbnRlcmNlcHRvckZhY3RvcnkpKTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSAkaHR0cAogICAgICogQHJlcXVpcmVzIG5nLiRodHRwQmFja2VuZAogICAgICogQHJlcXVpcmVzICRjYWNoZUZhY3RvcnkKICAgICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICAgKiBAcmVxdWlyZXMgJHEKICAgICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgJGh0dHBgIHNlcnZpY2UgaXMgYSBjb3JlIEFuZ3VsYXIgc2VydmljZSB0aGF0IGZhY2lsaXRhdGVzIGNvbW11bmljYXRpb24gd2l0aCB0aGUgcmVtb3RlCiAgICAgKiBIVFRQIHNlcnZlcnMgdmlhIHRoZSBicm93c2VyJ3MgW1hNTEh0dHBSZXF1ZXN0XShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi94bWxodHRwcmVxdWVzdCkKICAgICAqIG9iamVjdCBvciB2aWEgW0pTT05QXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0pTT05QKS4KICAgICAqCiAgICAgKiBGb3IgdW5pdCB0ZXN0aW5nIGFwcGxpY2F0aW9ucyB0aGF0IHVzZSBgJGh0dHBgIHNlcnZpY2UsIHNlZQogICAgICoge0BsaW5rIG5nTW9jay4kaHR0cEJhY2tlbmQgJGh0dHBCYWNrZW5kIG1vY2t9LgogICAgICoKICAgICAqIEZvciBhIGhpZ2hlciBsZXZlbCBvZiBhYnN0cmFjdGlvbiwgcGxlYXNlIGNoZWNrIG91dCB0aGUge0BsaW5rIG5nUmVzb3VyY2UuJHJlc291cmNlCiAgICAgKiAkcmVzb3VyY2V9IHNlcnZpY2UuCiAgICAgKgogICAgICogVGhlICRodHRwIEFQSSBpcyBiYXNlZCBvbiB0aGUge0BsaW5rIG5nLiRxIGRlZmVycmVkL3Byb21pc2UgQVBJc30gZXhwb3NlZCBieQogICAgICogdGhlICRxIHNlcnZpY2UuIFdoaWxlIGZvciBzaW1wbGUgdXNhZ2UgcGF0dGVybnMgdGhpcyBkb2Vzbid0IG1hdHRlciBtdWNoLCBmb3IgYWR2YW5jZWQgdXNhZ2UKICAgICAqIGl0IGlzIGltcG9ydGFudCB0byBmYW1pbGlhcml6ZSB5b3Vyc2VsZiB3aXRoIHRoZXNlIEFQSXMgYW5kIHRoZSBndWFyYW50ZWVzIHRoZXkgcHJvdmlkZS4KICAgICAqCiAgICAgKgogICAgICogIyMgR2VuZXJhbCB1c2FnZQogICAgICogVGhlIGAkaHR0cGAgc2VydmljZSBpcyBhIGZ1bmN0aW9uIHdoaWNoIHRha2VzIGEgc2luZ2xlIGFyZ3VtZW50IOKAlCBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0IOKAlAogICAgICogdGhhdCBpcyB1c2VkIHRvIGdlbmVyYXRlIGFuIEhUVFAgcmVxdWVzdCBhbmQgcmV0dXJucyAgYSB7QGxpbmsgbmcuJHEgcHJvbWlzZX0KICAgICAqIHdpdGggdHdvICRodHRwIHNwZWNpZmljIG1ldGhvZHM6IGBzdWNjZXNzYCBhbmQgYGVycm9yYC4KICAgICAqCiAgICAgKiBgYGBqcwogICAgICogICAvLyBTaW1wbGUgR0VUIHJlcXVlc3QgZXhhbXBsZSA6CiAgICAgKiAgICRodHRwLmdldCgnL3NvbWVVcmwnKS4KICAgICAqICAgICBzdWNjZXNzKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7CiAgICAgKiAgICAgICAvLyB0aGlzIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGFzeW5jaHJvbm91c2x5CiAgICAgKiAgICAgICAvLyB3aGVuIHRoZSByZXNwb25zZSBpcyBhdmFpbGFibGUKICAgICAqICAgICB9KS4KICAgICAqICAgICBlcnJvcihmdW5jdGlvbihkYXRhLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICogICAgICAgLy8gY2FsbGVkIGFzeW5jaHJvbm91c2x5IGlmIGFuIGVycm9yIG9jY3VycwogICAgICogICAgICAgLy8gb3Igc2VydmVyIHJldHVybnMgcmVzcG9uc2Ugd2l0aCBhbiBlcnJvciBzdGF0dXMuCiAgICAgKiAgICAgfSk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBgYGBqcwogICAgICogICAvLyBTaW1wbGUgUE9TVCByZXF1ZXN0IGV4YW1wbGUgKHBhc3NpbmcgZGF0YSkgOgogICAgICogICAkaHR0cC5wb3N0KCcvc29tZVVybCcsIHttc2c6J2hlbGxvIHdvcmQhJ30pLgogICAgICogICAgIHN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAqICAgICAgIC8vIHRoaXMgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgYXN5bmNocm9ub3VzbHkKICAgICAqICAgICAgIC8vIHdoZW4gdGhlIHJlc3BvbnNlIGlzIGF2YWlsYWJsZQogICAgICogICAgIH0pLgogICAgICogICAgIGVycm9yKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7CiAgICAgKiAgICAgICAvLyBjYWxsZWQgYXN5bmNocm9ub3VzbHkgaWYgYW4gZXJyb3Igb2NjdXJzCiAgICAgKiAgICAgICAvLyBvciBzZXJ2ZXIgcmV0dXJucyByZXNwb25zZSB3aXRoIGFuIGVycm9yIHN0YXR1cy4KICAgICAqICAgICB9KTsKICAgICAqIGBgYAogICAgICoKICAgICAqCiAgICAgKiBTaW5jZSB0aGUgcmV0dXJuZWQgdmFsdWUgb2YgY2FsbGluZyB0aGUgJGh0dHAgZnVuY3Rpb24gaXMgYSBgcHJvbWlzZWAsIHlvdSBjYW4gYWxzbyB1c2UKICAgICAqIHRoZSBgdGhlbmAgbWV0aG9kIHRvIHJlZ2lzdGVyIGNhbGxiYWNrcywgYW5kIHRoZXNlIGNhbGxiYWNrcyB3aWxsIHJlY2VpdmUgYSBzaW5nbGUgYXJndW1lbnQg4oCTCiAgICAgKiBhbiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByZXNwb25zZS4gU2VlIHRoZSBBUEkgc2lnbmF0dXJlIGFuZCB0eXBlIGluZm8gYmVsb3cgZm9yIG1vcmUKICAgICAqIGRldGFpbHMuCiAgICAgKgogICAgICogQSByZXNwb25zZSBzdGF0dXMgY29kZSBiZXR3ZWVuIDIwMCBhbmQgMjk5IGlzIGNvbnNpZGVyZWQgYSBzdWNjZXNzIHN0YXR1cyBhbmQKICAgICAqIHdpbGwgcmVzdWx0IGluIHRoZSBzdWNjZXNzIGNhbGxiYWNrIGJlaW5nIGNhbGxlZC4gTm90ZSB0aGF0IGlmIHRoZSByZXNwb25zZSBpcyBhIHJlZGlyZWN0LAogICAgICogWE1MSHR0cFJlcXVlc3Qgd2lsbCB0cmFuc3BhcmVudGx5IGZvbGxvdyBpdCwgbWVhbmluZyB0aGF0IHRoZSBlcnJvciBjYWxsYmFjayB3aWxsIG5vdCBiZQogICAgICogY2FsbGVkIGZvciBzdWNoIHJlc3BvbnNlcy4KICAgICAqCiAgICAgKiAjIyBXcml0aW5nIFVuaXQgVGVzdHMgdGhhdCB1c2UgJGh0dHAKICAgICAqIFdoZW4gdW5pdCB0ZXN0aW5nICh1c2luZyB7QGxpbmsgbmdNb2NrIG5nTW9ja30pLCBpdCBpcyBuZWNlc3NhcnkgdG8gY2FsbAogICAgICoge0BsaW5rIG5nTW9jay4kaHR0cEJhY2tlbmQjZmx1c2ggJGh0dHBCYWNrZW5kLmZsdXNoKCl9IHRvIGZsdXNoIGVhY2ggcGVuZGluZwogICAgICogcmVxdWVzdCB1c2luZyB0cmFpbmVkIHJlc3BvbnNlcy4KICAgICAqCiAgICAgKiBgYGAKICAgICAqICRodHRwQmFja2VuZC5leHBlY3RHRVQoLi4uKTsKICAgICAqICRodHRwLmdldCguLi4pOwogICAgICogJGh0dHBCYWNrZW5kLmZsdXNoKCk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiAjIyBTaG9ydGN1dCBtZXRob2RzCiAgICAgKgogICAgICogU2hvcnRjdXQgbWV0aG9kcyBhcmUgYWxzbyBhdmFpbGFibGUuIEFsbCBzaG9ydGN1dCBtZXRob2RzIHJlcXVpcmUgcGFzc2luZyBpbiB0aGUgVVJMLCBhbmQKICAgICAqIHJlcXVlc3QgZGF0YSBtdXN0IGJlIHBhc3NlZCBpbiBmb3IgUE9TVC9QVVQgcmVxdWVzdHMuCiAgICAgKgogICAgICogYGBganMKICAgICAqICAgJGh0dHAuZ2V0KCcvc29tZVVybCcpLnN1Y2Nlc3Moc3VjY2Vzc0NhbGxiYWNrKTsKICAgICAqICAgJGh0dHAucG9zdCgnL3NvbWVVcmwnLCBkYXRhKS5zdWNjZXNzKHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBDb21wbGV0ZSBsaXN0IG9mIHNob3J0Y3V0IG1ldGhvZHM6CiAgICAgKgogICAgICogLSB7QGxpbmsgbmcuJGh0dHAjZ2V0ICRodHRwLmdldH0KICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2hlYWQgJGh0dHAuaGVhZH0KICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI3Bvc3QgJGh0dHAucG9zdH0KICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI3B1dCAkaHR0cC5wdXR9CiAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNkZWxldGUgJGh0dHAuZGVsZXRlfQogICAgICogLSB7QGxpbmsgbmcuJGh0dHAjanNvbnAgJGh0dHAuanNvbnB9CiAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNwYXRjaCAkaHR0cC5wYXRjaH0KICAgICAqCiAgICAgKgogICAgICogIyMgU2V0dGluZyBIVFRQIEhlYWRlcnMKICAgICAqCiAgICAgKiBUaGUgJGh0dHAgc2VydmljZSB3aWxsIGF1dG9tYXRpY2FsbHkgYWRkIGNlcnRhaW4gSFRUUCBoZWFkZXJzIHRvIGFsbCByZXF1ZXN0cy4gVGhlc2UgZGVmYXVsdHMKICAgICAqIGNhbiBiZSBmdWxseSBjb25maWd1cmVkIGJ5IGFjY2Vzc2luZyB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVyc2AgY29uZmlndXJhdGlvbgogICAgICogb2JqZWN0LCB3aGljaCBjdXJyZW50bHkgY29udGFpbnMgdGhpcyBkZWZhdWx0IGNvbmZpZ3VyYXRpb246CiAgICAgKgogICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLmNvbW1vbmAgKGhlYWRlcnMgdGhhdCBhcmUgY29tbW9uIGZvciBhbGwgcmVxdWVzdHMpOgogICAgICogICAtIGBBY2NlcHQ6IGFwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICogLyAqYAogICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLnBvc3RgOiAoaGVhZGVyIGRlZmF1bHRzIGZvciBQT1NUIHJlcXVlc3RzKQogICAgICogICAtIGBDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb25gCiAgICAgKiAtIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMucHV0YCAoaGVhZGVyIGRlZmF1bHRzIGZvciBQVVQgcmVxdWVzdHMpCiAgICAgKiAgIC0gYENvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbmAKICAgICAqCiAgICAgKiBUbyBhZGQgb3Igb3ZlcndyaXRlIHRoZXNlIGRlZmF1bHRzLCBzaW1wbHkgYWRkIG9yIHJlbW92ZSBhIHByb3BlcnR5IGZyb20gdGhlc2UgY29uZmlndXJhdGlvbgogICAgICogb2JqZWN0cy4gVG8gYWRkIGhlYWRlcnMgZm9yIGFuIEhUVFAgbWV0aG9kIG90aGVyIHRoYW4gUE9TVCBvciBQVVQsIHNpbXBseSBhZGQgYSBuZXcgb2JqZWN0CiAgICAgKiB3aXRoIHRoZSBsb3dlcmNhc2VkIEhUVFAgbWV0aG9kIG5hbWUgYXMgdGhlIGtleSwgZS5nLgogICAgICogYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5nZXQgPSB7ICdNeS1IZWFkZXInIDogJ3ZhbHVlJyB9LgogICAgICoKICAgICAqIFRoZSBkZWZhdWx0cyBjYW4gYWxzbyBiZSBzZXQgYXQgcnVudGltZSB2aWEgdGhlIGAkaHR0cC5kZWZhdWx0c2Agb2JqZWN0IGluIHRoZSBzYW1lCiAgICAgKiBmYXNoaW9uLiBGb3IgZXhhbXBsZToKICAgICAqCiAgICAgKiBgYGAKICAgICAqIG1vZHVsZS5ydW4oZnVuY3Rpb24oJGh0dHApIHsKICAgICAqICAgJGh0dHAuZGVmYXVsdHMuaGVhZGVycy5jb21tb24uQXV0aG9yaXphdGlvbiA9ICdCYXNpYyBZbVZsY0RwaWIyOXcnCiAgICAgKiB9KTsKICAgICAqIGBgYAogICAgICoKICAgICAqIEluIGFkZGl0aW9uLCB5b3UgY2FuIHN1cHBseSBhIGBoZWFkZXJzYCBwcm9wZXJ0eSBpbiB0aGUgY29uZmlnIG9iamVjdCBwYXNzZWQgd2hlbgogICAgICogY2FsbGluZyBgJGh0dHAoY29uZmlnKWAsIHdoaWNoIG92ZXJyaWRlcyB0aGUgZGVmYXVsdHMgd2l0aG91dCBjaGFuZ2luZyB0aGVtIGdsb2JhbGx5LgogICAgICoKICAgICAqCiAgICAgKiAjIyBUcmFuc2Zvcm1pbmcgUmVxdWVzdHMgYW5kIFJlc3BvbnNlcwogICAgICoKICAgICAqIEJvdGggcmVxdWVzdHMgYW5kIHJlc3BvbnNlcyBjYW4gYmUgdHJhbnNmb3JtZWQgdXNpbmcgdHJhbnNmb3JtYXRpb24gZnVuY3Rpb25zOiBgdHJhbnNmb3JtUmVxdWVzdGAKICAgICAqIGFuZCBgdHJhbnNmb3JtUmVzcG9uc2VgLiBUaGVzZSBwcm9wZXJ0aWVzIGNhbiBiZSBhIHNpbmdsZSBmdW5jdGlvbiB0aGF0IHJldHVybnMKICAgICAqIHRoZSB0cmFuc2Zvcm1lZCB2YWx1ZSAoYHtmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKWApIG9yIGFuIGFycmF5IG9mIHN1Y2ggdHJhbnNmb3JtYXRpb24gZnVuY3Rpb25zLAogICAgICogd2hpY2ggYWxsb3dzIHlvdSB0byBgcHVzaGAgb3IgYHVuc2hpZnRgIGEgbmV3IHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9uIGludG8gdGhlIHRyYW5zZm9ybWF0aW9uIGNoYWluLgogICAgICoKICAgICAqICMjIyBEZWZhdWx0IFRyYW5zZm9ybWF0aW9ucwogICAgICoKICAgICAqIFRoZSBgJGh0dHBQcm92aWRlcmAgcHJvdmlkZXIgYW5kIGAkaHR0cGAgc2VydmljZSBleHBvc2UgYGRlZmF1bHRzLnRyYW5zZm9ybVJlcXVlc3RgIGFuZAogICAgICogYGRlZmF1bHRzLnRyYW5zZm9ybVJlc3BvbnNlYCBwcm9wZXJ0aWVzLiBJZiBhIHJlcXVlc3QgZG9lcyBub3QgcHJvdmlkZSBpdHMgb3duIHRyYW5zZm9ybWF0aW9ucwogICAgICogdGhlbiB0aGVzZSB3aWxsIGJlIGFwcGxpZWQuCiAgICAgKgogICAgICogWW91IGNhbiBhdWdtZW50IG9yIHJlcGxhY2UgdGhlIGRlZmF1bHQgdHJhbnNmb3JtYXRpb25zIGJ5IG1vZGlmeWluZyB0aGVzZSBwcm9wZXJ0aWVzIGJ5IGFkZGluZyB0byBvcgogICAgICogcmVwbGFjaW5nIHRoZSBhcnJheS4KICAgICAqCiAgICAgKiBBbmd1bGFyIHByb3ZpZGVzIHRoZSBmb2xsb3dpbmcgZGVmYXVsdCB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgKgogICAgICogUmVxdWVzdCB0cmFuc2Zvcm1hdGlvbnMgKGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLnRyYW5zZm9ybVJlcXVlc3RgIGFuZCBgJGh0dHAuZGVmYXVsdHMudHJhbnNmb3JtUmVxdWVzdGApOgogICAgICoKICAgICAqIC0gSWYgdGhlIGBkYXRhYCBwcm9wZXJ0eSBvZiB0aGUgcmVxdWVzdCBjb25maWd1cmF0aW9uIG9iamVjdCBjb250YWlucyBhbiBvYmplY3QsIHNlcmlhbGl6ZSBpdAogICAgICogICBpbnRvIEpTT04gZm9ybWF0LgogICAgICoKICAgICAqIFJlc3BvbnNlIHRyYW5zZm9ybWF0aW9ucyAoYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMudHJhbnNmb3JtUmVzcG9uc2VgIGFuZCBgJGh0dHAuZGVmYXVsdHMudHJhbnNmb3JtUmVzcG9uc2VgKToKICAgICAqCiAgICAgKiAgLSBJZiBYU1JGIHByZWZpeCBpcyBkZXRlY3RlZCwgc3RyaXAgaXQgKHNlZSBTZWN1cml0eSBDb25zaWRlcmF0aW9ucyBzZWN0aW9uIGJlbG93KS4KICAgICAqICAtIElmIEpTT04gcmVzcG9uc2UgaXMgZGV0ZWN0ZWQsIGRlc2VyaWFsaXplIGl0IHVzaW5nIGEgSlNPTiBwYXJzZXIuCiAgICAgKgogICAgICoKICAgICAqICMjIyBPdmVycmlkaW5nIHRoZSBEZWZhdWx0IFRyYW5zZm9ybWF0aW9ucyBQZXIgUmVxdWVzdAogICAgICoKICAgICAqIElmIHlvdSB3aXNoIG92ZXJyaWRlIHRoZSByZXF1ZXN0L3Jlc3BvbnNlIHRyYW5zZm9ybWF0aW9ucyBvbmx5IGZvciBhIHNpbmdsZSByZXF1ZXN0IHRoZW4gcHJvdmlkZQogICAgICogYHRyYW5zZm9ybVJlcXVlc3RgIGFuZC9vciBgdHJhbnNmb3JtUmVzcG9uc2VgIHByb3BlcnRpZXMgb24gdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHBhc3NlZAogICAgICogaW50byBgJGh0dHBgLgogICAgICoKICAgICAqIE5vdGUgdGhhdCBpZiB5b3UgcHJvdmlkZSB0aGVzZSBwcm9wZXJ0aWVzIG9uIHRoZSBjb25maWcgb2JqZWN0IHRoZSBkZWZhdWx0IHRyYW5zZm9ybWF0aW9ucyB3aWxsIGJlCiAgICAgKiBvdmVyd3JpdHRlbi4gSWYgeW91IHdpc2ggdG8gYXVnbWVudCB0aGUgZGVmYXVsdCB0cmFuc2Zvcm1hdGlvbnMgdGhlbiB5b3UgbXVzdCBpbmNsdWRlIHRoZW0gaW4geW91cgogICAgICogbG9jYWwgdHJhbnNmb3JtYXRpb24gYXJyYXkuCiAgICAgKgogICAgICogVGhlIGZvbGxvd2luZyBjb2RlIGRlbW9uc3RyYXRlcyBhZGRpbmcgYSBuZXcgcmVzcG9uc2UgdHJhbnNmb3JtYXRpb24gdG8gYmUgcnVuIGFmdGVyIHRoZSBkZWZhdWx0IHJlc3BvbnNlCiAgICAgKiB0cmFuc2Zvcm1hdGlvbnMgaGF2ZSBiZWVuIHJ1bi4KICAgICAqCiAgICAgKiBgYGBqcwogICAgICogZnVuY3Rpb24gYXBwZW5kVHJhbnNmb3JtKGRlZmF1bHRzLCB0cmFuc2Zvcm0pIHsKICAgICAqCiAgICAgKiAgIC8vIFdlIGNhbid0IGd1YXJhbnRlZSB0aGF0IHRoZSBkZWZhdWx0IHRyYW5zZm9ybWF0aW9uIGlzIGFuIGFycmF5CiAgICAgKiAgIGRlZmF1bHRzID0gYW5ndWxhci5pc0FycmF5KGRlZmF1bHRzKSA/IGRlZmF1bHRzIDogW2RlZmF1bHRzXTsKICAgICAqCiAgICAgKiAgIC8vIEFwcGVuZCB0aGUgbmV3IHRyYW5zZm9ybWF0aW9uIHRvIHRoZSBkZWZhdWx0cwogICAgICogICByZXR1cm4gZGVmYXVsdHMuY29uY2F0KHRyYW5zZm9ybSk7CiAgICAgKiB9CiAgICAgKgogICAgICogJGh0dHAoewogICAgICogICB1cmw6ICcuLi4nLAogICAgICogICBtZXRob2Q6ICdHRVQnLAogICAgICogICB0cmFuc2Zvcm1SZXNwb25zZTogYXBwZW5kVHJhbnNmb3JtKCRodHRwLmRlZmF1bHRzLnRyYW5zZm9ybVJlc3BvbnNlLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICogICAgIHJldHVybiBkb1RyYW5zZm9ybSh2YWx1ZSk7CiAgICAgKiAgIH0pCiAgICAgKiB9KTsKICAgICAqIGBgYAogICAgICoKICAgICAqCiAgICAgKiAjIyBDYWNoaW5nCiAgICAgKgogICAgICogVG8gZW5hYmxlIGNhY2hpbmcsIHNldCB0aGUgcmVxdWVzdCBjb25maWd1cmF0aW9uIGBjYWNoZWAgcHJvcGVydHkgdG8gYHRydWVgICh0byB1c2UgZGVmYXVsdAogICAgICogY2FjaGUpIG9yIHRvIGEgY3VzdG9tIGNhY2hlIG9iamVjdCAoYnVpbHQgd2l0aCB7QGxpbmsgbmcuJGNhY2hlRmFjdG9yeSBgJGNhY2hlRmFjdG9yeWB9KS4KICAgICAqIFdoZW4gdGhlIGNhY2hlIGlzIGVuYWJsZWQsIGAkaHR0cGAgc3RvcmVzIHRoZSByZXNwb25zZSBmcm9tIHRoZSBzZXJ2ZXIgaW4gdGhlIHNwZWNpZmllZAogICAgICogY2FjaGUuIFRoZSBuZXh0IHRpbWUgdGhlIHNhbWUgcmVxdWVzdCBpcyBtYWRlLCB0aGUgcmVzcG9uc2UgaXMgc2VydmVkIGZyb20gdGhlIGNhY2hlIHdpdGhvdXQKICAgICAqIHNlbmRpbmcgYSByZXF1ZXN0IHRvIHRoZSBzZXJ2ZXIuCiAgICAgKgogICAgICogTm90ZSB0aGF0IGV2ZW4gaWYgdGhlIHJlc3BvbnNlIGlzIHNlcnZlZCBmcm9tIGNhY2hlLCBkZWxpdmVyeSBvZiB0aGUgZGF0YSBpcyBhc3luY2hyb25vdXMgaW4KICAgICAqIHRoZSBzYW1lIHdheSB0aGF0IHJlYWwgcmVxdWVzdHMgYXJlLgogICAgICoKICAgICAqIElmIHRoZXJlIGFyZSBtdWx0aXBsZSBHRVQgcmVxdWVzdHMgZm9yIHRoZSBzYW1lIFVSTCB0aGF0IHNob3VsZCBiZSBjYWNoZWQgdXNpbmcgdGhlIHNhbWUKICAgICAqIGNhY2hlLCBidXQgdGhlIGNhY2hlIGlzIG5vdCBwb3B1bGF0ZWQgeWV0LCBvbmx5IG9uZSByZXF1ZXN0IHRvIHRoZSBzZXJ2ZXIgd2lsbCBiZSBtYWRlIGFuZAogICAgICogdGhlIHJlbWFpbmluZyByZXF1ZXN0cyB3aWxsIGJlIGZ1bGZpbGxlZCB1c2luZyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgZmlyc3QgcmVxdWVzdC4KICAgICAqCiAgICAgKiBZb3UgY2FuIGNoYW5nZSB0aGUgZGVmYXVsdCBjYWNoZSB0byBhIG5ldyBvYmplY3QgKGJ1aWx0IHdpdGgKICAgICAqIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5IGAkY2FjaGVGYWN0b3J5YH0pIGJ5IHVwZGF0aW5nIHRoZQogICAgICoge0BsaW5rIG5nLiRodHRwI2RlZmF1bHRzIGAkaHR0cC5kZWZhdWx0cy5jYWNoZWB9IHByb3BlcnR5LiBBbGwgcmVxdWVzdHMgd2hvIHNldAogICAgICogdGhlaXIgYGNhY2hlYCBwcm9wZXJ0eSB0byBgdHJ1ZWAgd2lsbCBub3cgdXNlIHRoaXMgY2FjaGUgb2JqZWN0LgogICAgICoKICAgICAqIElmIHlvdSBzZXQgdGhlIGRlZmF1bHQgY2FjaGUgdG8gYGZhbHNlYCB0aGVuIG9ubHkgcmVxdWVzdHMgdGhhdCBzcGVjaWZ5IHRoZWlyIG93biBjdXN0b20KICAgICAqIGNhY2hlIG9iamVjdCB3aWxsIGJlIGNhY2hlZC4KICAgICAqCiAgICAgKiAjIyBJbnRlcmNlcHRvcnMKICAgICAqCiAgICAgKiBCZWZvcmUgeW91IHN0YXJ0IGNyZWF0aW5nIGludGVyY2VwdG9ycywgYmUgc3VyZSB0byB1bmRlcnN0YW5kIHRoZQogICAgICoge0BsaW5rIG5nLiRxICRxIGFuZCBkZWZlcnJlZC9wcm9taXNlIEFQSXN9LgogICAgICoKICAgICAqIEZvciBwdXJwb3NlcyBvZiBnbG9iYWwgZXJyb3IgaGFuZGxpbmcsIGF1dGhlbnRpY2F0aW9uLCBvciBhbnkga2luZCBvZiBzeW5jaHJvbm91cyBvcgogICAgICogYXN5bmNocm9ub3VzIHByZS1wcm9jZXNzaW5nIG9mIHJlcXVlc3Qgb3IgcG9zdHByb2Nlc3Npbmcgb2YgcmVzcG9uc2VzLCBpdCBpcyBkZXNpcmFibGUgdG8gYmUKICAgICAqIGFibGUgdG8gaW50ZXJjZXB0IHJlcXVlc3RzIGJlZm9yZSB0aGV5IGFyZSBoYW5kZWQgdG8gdGhlIHNlcnZlciBhbmQKICAgICAqIHJlc3BvbnNlcyBiZWZvcmUgdGhleSBhcmUgaGFuZGVkIG92ZXIgdG8gdGhlIGFwcGxpY2F0aW9uIGNvZGUgdGhhdAogICAgICogaW5pdGlhdGVkIHRoZXNlIHJlcXVlc3RzLiBUaGUgaW50ZXJjZXB0b3JzIGxldmVyYWdlIHRoZSB7QGxpbmsgbmcuJHEKICAgICAqIHByb21pc2UgQVBJc30gdG8gZnVsZmlsbCB0aGlzIG5lZWQgZm9yIGJvdGggc3luY2hyb25vdXMgYW5kIGFzeW5jaHJvbm91cyBwcmUtcHJvY2Vzc2luZy4KICAgICAqCiAgICAgKiBUaGUgaW50ZXJjZXB0b3JzIGFyZSBzZXJ2aWNlIGZhY3RvcmllcyB0aGF0IGFyZSByZWdpc3RlcmVkIHdpdGggdGhlIGAkaHR0cFByb3ZpZGVyYCBieQogICAgICogYWRkaW5nIHRoZW0gdG8gdGhlIGAkaHR0cFByb3ZpZGVyLmludGVyY2VwdG9yc2AgYXJyYXkuIFRoZSBmYWN0b3J5IGlzIGNhbGxlZCBhbmQKICAgICAqIGluamVjdGVkIHdpdGggZGVwZW5kZW5jaWVzIChpZiBzcGVjaWZpZWQpIGFuZCByZXR1cm5zIHRoZSBpbnRlcmNlcHRvci4KICAgICAqCiAgICAgKiBUaGVyZSBhcmUgdHdvIGtpbmRzIG9mIGludGVyY2VwdG9ycyAoYW5kIHR3byBraW5kcyBvZiByZWplY3Rpb24gaW50ZXJjZXB0b3JzKToKICAgICAqCiAgICAgKiAgICogYHJlcXVlc3RgOiBpbnRlcmNlcHRvcnMgZ2V0IGNhbGxlZCB3aXRoIGEgaHR0cCBgY29uZmlnYCBvYmplY3QuIFRoZSBmdW5jdGlvbiBpcyBmcmVlIHRvCiAgICAgKiAgICAgbW9kaWZ5IHRoZSBgY29uZmlnYCBvYmplY3Qgb3IgY3JlYXRlIGEgbmV3IG9uZS4gVGhlIGZ1bmN0aW9uIG5lZWRzIHRvIHJldHVybiB0aGUgYGNvbmZpZ2AKICAgICAqICAgICBvYmplY3QgZGlyZWN0bHksIG9yIGEgcHJvbWlzZSBjb250YWluaW5nIHRoZSBgY29uZmlnYCBvciBhIG5ldyBgY29uZmlnYCBvYmplY3QuCiAgICAgKiAgICogYHJlcXVlc3RFcnJvcmA6IGludGVyY2VwdG9yIGdldHMgY2FsbGVkIHdoZW4gYSBwcmV2aW91cyBpbnRlcmNlcHRvciB0aHJldyBhbiBlcnJvciBvcgogICAgICogICAgIHJlc29sdmVkIHdpdGggYSByZWplY3Rpb24uCiAgICAgKiAgICogYHJlc3BvbnNlYDogaW50ZXJjZXB0b3JzIGdldCBjYWxsZWQgd2l0aCBodHRwIGByZXNwb25zZWAgb2JqZWN0LiBUaGUgZnVuY3Rpb24gaXMgZnJlZSB0bwogICAgICogICAgIG1vZGlmeSB0aGUgYHJlc3BvbnNlYCBvYmplY3Qgb3IgY3JlYXRlIGEgbmV3IG9uZS4gVGhlIGZ1bmN0aW9uIG5lZWRzIHRvIHJldHVybiB0aGUgYHJlc3BvbnNlYAogICAgICogICAgIG9iamVjdCBkaXJlY3RseSwgb3IgYXMgYSBwcm9taXNlIGNvbnRhaW5pbmcgdGhlIGByZXNwb25zZWAgb3IgYSBuZXcgYHJlc3BvbnNlYCBvYmplY3QuCiAgICAgKiAgICogYHJlc3BvbnNlRXJyb3JgOiBpbnRlcmNlcHRvciBnZXRzIGNhbGxlZCB3aGVuIGEgcHJldmlvdXMgaW50ZXJjZXB0b3IgdGhyZXcgYW4gZXJyb3Igb3IKICAgICAqICAgICByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLgogICAgICoKICAgICAqCiAgICAgKiBgYGBqcwogICAgICogICAvLyByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgYXMgYSBzZXJ2aWNlCiAgICAgKiAgICRwcm92aWRlLmZhY3RvcnkoJ215SHR0cEludGVyY2VwdG9yJywgZnVuY3Rpb24oJHEsIGRlcGVuZGVuY3kxLCBkZXBlbmRlbmN5MikgewogICAgICogICAgIHJldHVybiB7CiAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAqICAgICAgICdyZXF1ZXN0JzogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBzdWNjZXNzCiAgICAgKiAgICAgICAgIHJldHVybiBjb25maWc7CiAgICAgKiAgICAgICB9LAogICAgICoKICAgICAqICAgICAgIC8vIG9wdGlvbmFsIG1ldGhvZAogICAgICogICAgICAncmVxdWVzdEVycm9yJzogZnVuY3Rpb24ocmVqZWN0aW9uKSB7CiAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBlcnJvcgogICAgICogICAgICAgICBpZiAoY2FuUmVjb3ZlcihyZWplY3Rpb24pKSB7CiAgICAgKiAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT3JOZXdQcm9taXNlCiAgICAgKiAgICAgICAgIH0KICAgICAqICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZWplY3Rpb24pOwogICAgICogICAgICAgfSwKICAgICAqCiAgICAgKgogICAgICoKICAgICAqICAgICAgIC8vIG9wdGlvbmFsIG1ldGhvZAogICAgICogICAgICAgJ3Jlc3BvbnNlJzogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIHN1Y2Nlc3MKICAgICAqICAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICogICAgICAgfSwKICAgICAqCiAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAqICAgICAgJ3Jlc3BvbnNlRXJyb3InOiBmdW5jdGlvbihyZWplY3Rpb24pIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIGVycm9yCiAgICAgKiAgICAgICAgIGlmIChjYW5SZWNvdmVyKHJlamVjdGlvbikpIHsKICAgICAqICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VPck5ld1Byb21pc2UKICAgICAqICAgICAgICAgfQogICAgICogICAgICAgICByZXR1cm4gJHEucmVqZWN0KHJlamVjdGlvbik7CiAgICAgKiAgICAgICB9CiAgICAgKiAgICAgfTsKICAgICAqICAgfSk7CiAgICAgKgogICAgICogICAkaHR0cFByb3ZpZGVyLmludGVyY2VwdG9ycy5wdXNoKCdteUh0dHBJbnRlcmNlcHRvcicpOwogICAgICoKICAgICAqCiAgICAgKiAgIC8vIGFsdGVybmF0aXZlbHksIHJlZ2lzdGVyIHRoZSBpbnRlcmNlcHRvciB2aWEgYW4gYW5vbnltb3VzIGZhY3RvcnkKICAgICAqICAgJGh0dHBQcm92aWRlci5pbnRlcmNlcHRvcnMucHVzaChmdW5jdGlvbigkcSwgZGVwZW5kZW5jeTEsIGRlcGVuZGVuY3kyKSB7CiAgICAgKiAgICAgcmV0dXJuIHsKICAgICAqICAgICAgJ3JlcXVlc3QnOiBmdW5jdGlvbihjb25maWcpIHsKICAgICAqICAgICAgICAgIC8vIHNhbWUgYXMgYWJvdmUKICAgICAqICAgICAgIH0sCiAgICAgKgogICAgICogICAgICAgJ3Jlc3BvbnNlJzogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgICAgIC8vIHNhbWUgYXMgYWJvdmUKICAgICAqICAgICAgIH0KICAgICAqICAgICB9OwogICAgICogICB9KTsKICAgICAqIGBgYAogICAgICoKICAgICAqICMjIFNlY3VyaXR5IENvbnNpZGVyYXRpb25zCiAgICAgKgogICAgICogV2hlbiBkZXNpZ25pbmcgd2ViIGFwcGxpY2F0aW9ucywgY29uc2lkZXIgc2VjdXJpdHkgdGhyZWF0cyBmcm9tOgogICAgICoKICAgICAqIC0gW0pTT04gdnVsbmVyYWJpbGl0eV0oaHR0cDovL2hhYWNrZWQuY29tL2FyY2hpdmUvMjAwOC8xMS8yMC9hbmF0b215LW9mLWEtc3VidGxlLWpzb24tdnVsbmVyYWJpbGl0eS5hc3B4KQogICAgICogLSBbWFNSRl0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1zaXRlX3JlcXVlc3RfZm9yZ2VyeSkKICAgICAqCiAgICAgKiBCb3RoIHNlcnZlciBhbmQgdGhlIGNsaWVudCBtdXN0IGNvb3BlcmF0ZSBpbiBvcmRlciB0byBlbGltaW5hdGUgdGhlc2UgdGhyZWF0cy4gQW5ndWxhciBjb21lcwogICAgICogcHJlLWNvbmZpZ3VyZWQgd2l0aCBzdHJhdGVnaWVzIHRoYXQgYWRkcmVzcyB0aGVzZSBpc3N1ZXMsIGJ1dCBmb3IgdGhpcyB0byB3b3JrIGJhY2tlbmQgc2VydmVyCiAgICAgKiBjb29wZXJhdGlvbiBpcyByZXF1aXJlZC4KICAgICAqCiAgICAgKiAjIyMgSlNPTiBWdWxuZXJhYmlsaXR5IFByb3RlY3Rpb24KICAgICAqCiAgICAgKiBBIFtKU09OIHZ1bG5lcmFiaWxpdHldKGh0dHA6Ly9oYWFja2VkLmNvbS9hcmNoaXZlLzIwMDgvMTEvMjAvYW5hdG9teS1vZi1hLXN1YnRsZS1qc29uLXZ1bG5lcmFiaWxpdHkuYXNweCkKICAgICAqIGFsbG93cyB0aGlyZCBwYXJ0eSB3ZWJzaXRlIHRvIHR1cm4geW91ciBKU09OIHJlc291cmNlIFVSTCBpbnRvCiAgICAgKiBbSlNPTlBdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSlNPTlApIHJlcXVlc3QgdW5kZXIgc29tZSBjb25kaXRpb25zLiBUbwogICAgICogY291bnRlciB0aGlzIHlvdXIgc2VydmVyIGNhbiBwcmVmaXggYWxsIEpTT04gcmVxdWVzdHMgd2l0aCBmb2xsb3dpbmcgc3RyaW5nIGAiKV19JyxcbiJgLgogICAgICogQW5ndWxhciB3aWxsIGF1dG9tYXRpY2FsbHkgc3RyaXAgdGhlIHByZWZpeCBiZWZvcmUgcHJvY2Vzc2luZyBpdCBhcyBKU09OLgogICAgICoKICAgICAqIEZvciBleGFtcGxlIGlmIHlvdXIgc2VydmVyIG5lZWRzIHRvIHJldHVybjoKICAgICAqIGBgYGpzCiAgICAgKiBbJ29uZScsJ3R3byddCiAgICAgKiBgYGAKICAgICAqCiAgICAgKiB3aGljaCBpcyB2dWxuZXJhYmxlIHRvIGF0dGFjaywgeW91ciBzZXJ2ZXIgY2FuIHJldHVybjoKICAgICAqIGBgYGpzCiAgICAgKiApXX0nLAogICAgICogWydvbmUnLCd0d28nXQogICAgICogYGBgCiAgICAgKgogICAgICogQW5ndWxhciB3aWxsIHN0cmlwIHRoZSBwcmVmaXgsIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSBKU09OLgogICAgICoKICAgICAqCiAgICAgKiAjIyMgQ3Jvc3MgU2l0ZSBSZXF1ZXN0IEZvcmdlcnkgKFhTUkYpIFByb3RlY3Rpb24KICAgICAqCiAgICAgKiBbWFNSRl0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1zaXRlX3JlcXVlc3RfZm9yZ2VyeSkgaXMgYSB0ZWNobmlxdWUgYnkgd2hpY2gKICAgICAqIGFuIHVuYXV0aG9yaXplZCBzaXRlIGNhbiBnYWluIHlvdXIgdXNlcidzIHByaXZhdGUgZGF0YS4gQW5ndWxhciBwcm92aWRlcyBhIG1lY2hhbmlzbQogICAgICogdG8gY291bnRlciBYU1JGLiBXaGVuIHBlcmZvcm1pbmcgWEhSIHJlcXVlc3RzLCB0aGUgJGh0dHAgc2VydmljZSByZWFkcyBhIHRva2VuIGZyb20gYSBjb29raWUKICAgICAqIChieSBkZWZhdWx0LCBgWFNSRi1UT0tFTmApIGFuZCBzZXRzIGl0IGFzIGFuIEhUVFAgaGVhZGVyIChgWC1YU1JGLVRPS0VOYCkuIFNpbmNlIG9ubHkKICAgICAqIEphdmFTY3JpcHQgdGhhdCBydW5zIG9uIHlvdXIgZG9tYWluIGNvdWxkIHJlYWQgdGhlIGNvb2tpZSwgeW91ciBzZXJ2ZXIgY2FuIGJlIGFzc3VyZWQgdGhhdAogICAgICogdGhlIFhIUiBjYW1lIGZyb20gSmF2YVNjcmlwdCBydW5uaW5nIG9uIHlvdXIgZG9tYWluLiBUaGUgaGVhZGVyIHdpbGwgbm90IGJlIHNldCBmb3IKICAgICAqIGNyb3NzLWRvbWFpbiByZXF1ZXN0cy4KICAgICAqCiAgICAgKiBUbyB0YWtlIGFkdmFudGFnZSBvZiB0aGlzLCB5b3VyIHNlcnZlciBuZWVkcyB0byBzZXQgYSB0b2tlbiBpbiBhIEphdmFTY3JpcHQgcmVhZGFibGUgc2Vzc2lvbgogICAgICogY29va2llIGNhbGxlZCBgWFNSRi1UT0tFTmAgb24gdGhlIGZpcnN0IEhUVFAgR0VUIHJlcXVlc3QuIE9uIHN1YnNlcXVlbnQgWEhSIHJlcXVlc3RzIHRoZQogICAgICogc2VydmVyIGNhbiB2ZXJpZnkgdGhhdCB0aGUgY29va2llIG1hdGNoZXMgYFgtWFNSRi1UT0tFTmAgSFRUUCBoZWFkZXIsIGFuZCB0aGVyZWZvcmUgYmUgc3VyZQogICAgICogdGhhdCBvbmx5IEphdmFTY3JpcHQgcnVubmluZyBvbiB5b3VyIGRvbWFpbiBjb3VsZCBoYXZlIHNlbnQgdGhlIHJlcXVlc3QuIFRoZSB0b2tlbiBtdXN0IGJlCiAgICAgKiB1bmlxdWUgZm9yIGVhY2ggdXNlciBhbmQgbXVzdCBiZSB2ZXJpZmlhYmxlIGJ5IHRoZSBzZXJ2ZXIgKHRvIHByZXZlbnQgdGhlIEphdmFTY3JpcHQgZnJvbQogICAgICogbWFraW5nIHVwIGl0cyBvd24gdG9rZW5zKS4gV2UgcmVjb21tZW5kIHRoYXQgdGhlIHRva2VuIGlzIGEgZGlnZXN0IG9mIHlvdXIgc2l0ZSdzCiAgICAgKiBhdXRoZW50aWNhdGlvbiBjb29raWUgd2l0aCBhIFtzYWx0XShodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TYWx0XyhjcnlwdG9ncmFwaHkmIzQxOykKICAgICAqIGZvciBhZGRlZCBzZWN1cml0eS4KICAgICAqCiAgICAgKiBUaGUgbmFtZSBvZiB0aGUgaGVhZGVycyBjYW4gYmUgc3BlY2lmaWVkIHVzaW5nIHRoZSB4c3JmSGVhZGVyTmFtZSBhbmQgeHNyZkNvb2tpZU5hbWUKICAgICAqIHByb3BlcnRpZXMgb2YgZWl0aGVyICRodHRwUHJvdmlkZXIuZGVmYXVsdHMgYXQgY29uZmlnLXRpbWUsICRodHRwLmRlZmF1bHRzIGF0IHJ1bi10aW1lLAogICAgICogb3IgdGhlIHBlci1yZXF1ZXN0IGNvbmZpZyBvYmplY3QuCiAgICAgKgogICAgICoKICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb25maWcgT2JqZWN0IGRlc2NyaWJpbmcgdGhlIHJlcXVlc3QgdG8gYmUgbWFkZSBhbmQgaG93IGl0IHNob3VsZCBiZQogICAgICogICAgcHJvY2Vzc2VkLiBUaGUgb2JqZWN0IGhhcyBmb2xsb3dpbmcgcHJvcGVydGllczoKICAgICAqCiAgICAgKiAgICAtICoqbWV0aG9kKiog4oCTIGB7c3RyaW5nfWAg4oCTIEhUVFAgbWV0aG9kIChlLmcuICdHRVQnLCAnUE9TVCcsIGV0YykKICAgICAqICAgIC0gKip1cmwqKiDigJMgYHtzdHJpbmd9YCDigJMgQWJzb2x1dGUgb3IgcmVsYXRpdmUgVVJMIG9mIHRoZSByZXNvdXJjZSB0aGF0IGlzIGJlaW5nIHJlcXVlc3RlZC4KICAgICAqICAgIC0gKipwYXJhbXMqKiDigJMgYHtPYmplY3QuPHN0cmluZ3xPYmplY3Q+fWAg4oCTIE1hcCBvZiBzdHJpbmdzIG9yIG9iamVjdHMgd2hpY2ggd2lsbCBiZSB0dXJuZWQKICAgICAqICAgICAgdG8gYD9rZXkxPXZhbHVlMSZrZXkyPXZhbHVlMmAgYWZ0ZXIgdGhlIHVybC4gSWYgdGhlIHZhbHVlIGlzIG5vdCBhIHN0cmluZywgaXQgd2lsbCBiZQogICAgICogICAgICBKU09OaWZpZWQuCiAgICAgKiAgICAtICoqZGF0YSoqIOKAkyBge3N0cmluZ3xPYmplY3R9YCDigJMgRGF0YSB0byBiZSBzZW50IGFzIHRoZSByZXF1ZXN0IG1lc3NhZ2UgZGF0YS4KICAgICAqICAgIC0gKipoZWFkZXJzKiog4oCTIGB7T2JqZWN0fWAg4oCTIE1hcCBvZiBzdHJpbmdzIG9yIGZ1bmN0aW9ucyB3aGljaCByZXR1cm4gc3RyaW5ncyByZXByZXNlbnRpbmcKICAgICAqICAgICAgSFRUUCBoZWFkZXJzIHRvIHNlbmQgdG8gdGhlIHNlcnZlci4gSWYgdGhlIHJldHVybiB2YWx1ZSBvZiBhIGZ1bmN0aW9uIGlzIG51bGwsIHRoZQogICAgICogICAgICBoZWFkZXIgd2lsbCBub3QgYmUgc2VudC4KICAgICAqICAgIC0gKip4c3JmSGVhZGVyTmFtZSoqIOKAkyBge3N0cmluZ31gIOKAkyBOYW1lIG9mIEhUVFAgaGVhZGVyIHRvIHBvcHVsYXRlIHdpdGggdGhlIFhTUkYgdG9rZW4uCiAgICAgKiAgICAtICoqeHNyZkNvb2tpZU5hbWUqKiDigJMgYHtzdHJpbmd9YCDigJMgTmFtZSBvZiBjb29raWUgY29udGFpbmluZyB0aGUgWFNSRiB0b2tlbi4KICAgICAqICAgIC0gKip0cmFuc2Zvcm1SZXF1ZXN0Kiog4oCTCiAgICAgKiAgICAgIGB7ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcil8QXJyYXkuPGZ1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpPn1gIOKAkwogICAgICogICAgICB0cmFuc2Zvcm0gZnVuY3Rpb24gb3IgYW4gYXJyYXkgb2Ygc3VjaCBmdW5jdGlvbnMuIFRoZSB0cmFuc2Zvcm0gZnVuY3Rpb24gdGFrZXMgdGhlIGh0dHAKICAgICAqICAgICAgcmVxdWVzdCBib2R5IGFuZCBoZWFkZXJzIGFuZCByZXR1cm5zIGl0cyB0cmFuc2Zvcm1lZCAodHlwaWNhbGx5IHNlcmlhbGl6ZWQpIHZlcnNpb24uCiAgICAgKiAgICAgIFNlZSB7QGxpbmsgI292ZXJyaWRpbmctdGhlLWRlZmF1bHQtdHJhbnNmb3JtYXRpb25zLXBlci1yZXF1ZXN0IE92ZXJyaWRpbmcgdGhlIERlZmF1bHQgVHJhbnNmb3JtYXRpb25zfQogICAgICogICAgLSAqKnRyYW5zZm9ybVJlc3BvbnNlKiog4oCTCiAgICAgKiAgICAgIGB7ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcil8QXJyYXkuPGZ1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpPn1gIOKAkwogICAgICogICAgICB0cmFuc2Zvcm0gZnVuY3Rpb24gb3IgYW4gYXJyYXkgb2Ygc3VjaCBmdW5jdGlvbnMuIFRoZSB0cmFuc2Zvcm0gZnVuY3Rpb24gdGFrZXMgdGhlIGh0dHAKICAgICAqICAgICAgcmVzcG9uc2UgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBkZXNlcmlhbGl6ZWQpIHZlcnNpb24uCiAgICAgKiAgICAgIFNlZSB7QGxpbmsgI292ZXJyaWRpbmctdGhlLWRlZmF1bHQtdHJhbnNmb3JtYXRpb25zLXBlci1yZXF1ZXN0IE92ZXJyaWRpbmcgdGhlIERlZmF1bHQgVHJhbnNmb3JtYXRpb25zfQogICAgICogICAgLSAqKmNhY2hlKiog4oCTIGB7Ym9vbGVhbnxDYWNoZX1gIOKAkyBJZiB0cnVlLCBhIGRlZmF1bHQgJGh0dHAgY2FjaGUgd2lsbCBiZSB1c2VkIHRvIGNhY2hlIHRoZQogICAgICogICAgICBHRVQgcmVxdWVzdCwgb3RoZXJ3aXNlIGlmIGEgY2FjaGUgaW5zdGFuY2UgYnVpbHQgd2l0aAogICAgICogICAgICB7QGxpbmsgbmcuJGNhY2hlRmFjdG9yeSAkY2FjaGVGYWN0b3J5fSwgdGhpcyBjYWNoZSB3aWxsIGJlIHVzZWQgZm9yCiAgICAgKiAgICAgIGNhY2hpbmcuCiAgICAgKiAgICAtICoqdGltZW91dCoqIOKAkyBge251bWJlcnxQcm9taXNlfWAg4oCTIHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzLCBvciB7QGxpbmsgbmcuJHEgcHJvbWlzZX0KICAgICAqICAgICAgdGhhdCBzaG91bGQgYWJvcnQgdGhlIHJlcXVlc3Qgd2hlbiByZXNvbHZlZC4KICAgICAqICAgIC0gKip3aXRoQ3JlZGVudGlhbHMqKiAtIGB7Ym9vbGVhbn1gIC0gd2hldGhlciB0byBzZXQgdGhlIGB3aXRoQ3JlZGVudGlhbHNgIGZsYWcgb24gdGhlCiAgICAgKiAgICAgIFhIUiBvYmplY3QuIFNlZSBbcmVxdWVzdHMgd2l0aCBjcmVkZW50aWFsc10oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZG9jcy9XZWIvSFRUUC9BY2Nlc3NfY29udHJvbF9DT1JTI1JlcXVlc3RzX3dpdGhfY3JlZGVudGlhbHMpCiAgICAgKiAgICAgIGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogICAgLSAqKnJlc3BvbnNlVHlwZSoqIC0gYHtzdHJpbmd9YCAtIHNlZQogICAgICogICAgICBbcmVxdWVzdFR5cGVdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL1hNTEh0dHBSZXF1ZXN0I3Jlc3BvbnNlVHlwZSkuCiAgICAgKgogICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBSZXR1cm5zIGEge0BsaW5rIG5nLiRxIHByb21pc2V9IG9iamVjdCB3aXRoIHRoZQogICAgICogICBzdGFuZGFyZCBgdGhlbmAgbWV0aG9kIGFuZCB0d28gaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuIFRoZSBgdGhlbmAKICAgICAqICAgbWV0aG9kIHRha2VzIHR3byBhcmd1bWVudHMgYSBzdWNjZXNzIGFuZCBhbiBlcnJvciBjYWxsYmFjayB3aGljaCB3aWxsIGJlIGNhbGxlZCB3aXRoIGEKICAgICAqICAgcmVzcG9uc2Ugb2JqZWN0LiBUaGUgYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgIG1ldGhvZHMgdGFrZSBhIHNpbmdsZSBhcmd1bWVudCAtIGEgZnVuY3Rpb24gdGhhdAogICAgICogICB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IHN1Y2NlZWRzIG9yIGZhaWxzIHJlc3BlY3RpdmVseS4gVGhlIGFyZ3VtZW50cyBwYXNzZWQgaW50bwogICAgICogICB0aGVzZSBmdW5jdGlvbnMgYXJlIGRlc3RydWN0dXJlZCByZXByZXNlbnRhdGlvbiBvZiB0aGUgcmVzcG9uc2Ugb2JqZWN0IHBhc3NlZCBpbnRvIHRoZQogICAgICogICBgdGhlbmAgbWV0aG9kLiBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0aGVzZSBwcm9wZXJ0aWVzOgogICAgICoKICAgICAqICAgLSAqKmRhdGEqKiDigJMgYHtzdHJpbmd8T2JqZWN0fWAg4oCTIFRoZSByZXNwb25zZSBib2R5IHRyYW5zZm9ybWVkIHdpdGggdGhlIHRyYW5zZm9ybQogICAgICogICAgIGZ1bmN0aW9ucy4KICAgICAqICAgLSAqKnN0YXR1cyoqIOKAkyBge251bWJlcn1gIOKAkyBIVFRQIHN0YXR1cyBjb2RlIG9mIHRoZSByZXNwb25zZS4KICAgICAqICAgLSAqKmhlYWRlcnMqKiDigJMgYHtmdW5jdGlvbihbaGVhZGVyTmFtZV0pfWAg4oCTIEhlYWRlciBnZXR0ZXIgZnVuY3Rpb24uCiAgICAgKiAgIC0gKipjb25maWcqKiDigJMgYHtPYmplY3R9YCDigJMgVGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHRoYXQgd2FzIHVzZWQgdG8gZ2VuZXJhdGUgdGhlIHJlcXVlc3QuCiAgICAgKiAgIC0gKipzdGF0dXNUZXh0Kiog4oCTIGB7c3RyaW5nfWAg4oCTIEhUVFAgc3RhdHVzIHRleHQgb2YgdGhlIHJlc3BvbnNlLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPE9iamVjdD59IHBlbmRpbmdSZXF1ZXN0cyBBcnJheSBvZiBjb25maWcgb2JqZWN0cyBmb3IgY3VycmVudGx5IHBlbmRpbmcKICAgICAqICAgcmVxdWVzdHMuIFRoaXMgaXMgcHJpbWFyaWx5IG1lYW50IHRvIGJlIHVzZWQgZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAgICAqCiAgICAgKgogICAgICogQGV4YW1wbGUKPGV4YW1wbGUgbW9kdWxlPSJodHRwRXhhbXBsZSI+CjxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogIDxkaXYgbmctY29udHJvbGxlcj0iRmV0Y2hDb250cm9sbGVyIj4KICAgIDxzZWxlY3QgbmctbW9kZWw9Im1ldGhvZCI+CiAgICAgIDxvcHRpb24+R0VUPC9vcHRpb24+CiAgICAgIDxvcHRpb24+SlNPTlA8L29wdGlvbj4KICAgIDwvc2VsZWN0PgogICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJ1cmwiIHNpemU9IjgwIi8+CiAgICA8YnV0dG9uIGlkPSJmZXRjaGJ0biIgbmctY2xpY2s9ImZldGNoKCkiPmZldGNoPC9idXR0b24+PGJyPgogICAgPGJ1dHRvbiBpZD0ic2FtcGxlZ2V0YnRuIiBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0dFVCcsICdodHRwLWhlbGxvLmh0bWwnKSI+U2FtcGxlIEdFVDwvYnV0dG9uPgogICAgPGJ1dHRvbiBpZD0ic2FtcGxlanNvbnBidG4iCiAgICAgIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnSlNPTlAnLAogICAgICAgICAgICAgICAgICAgICdodHRwczovL2FuZ3VsYXJqcy5vcmcvZ3JlZXQucGhwP2NhbGxiYWNrPUpTT05fQ0FMTEJBQ0smbmFtZT1TdXBlciUyMEhlcm8nKSI+CiAgICAgIFNhbXBsZSBKU09OUAogICAgPC9idXR0b24+CiAgICA8YnV0dG9uIGlkPSJpbnZhbGlkanNvbnBidG4iCiAgICAgIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnSlNPTlAnLCAnaHR0cHM6Ly9hbmd1bGFyanMub3JnL2RvZXNudGV4aXN0JmNhbGxiYWNrPUpTT05fQ0FMTEJBQ0snKSI+CiAgICAgICAgSW52YWxpZCBKU09OUAogICAgICA8L2J1dHRvbj4KICAgIDxwcmU+aHR0cCBzdGF0dXMgY29kZToge3tzdGF0dXN9fTwvcHJlPgogICAgPHByZT5odHRwIHJlc3BvbnNlIGRhdGE6IHt7ZGF0YX19PC9wcmU+CiAgPC9kaXY+CjwvZmlsZT4KPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICBhbmd1bGFyLm1vZHVsZSgnaHR0cEV4YW1wbGUnLCBbXSkKICAgIC5jb250cm9sbGVyKCdGZXRjaENvbnRyb2xsZXInLCBbJyRzY29wZScsICckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsCiAgICAgIGZ1bmN0aW9uKCRzY29wZSwgJGh0dHAsICR0ZW1wbGF0ZUNhY2hlKSB7CiAgICAgICAgJHNjb3BlLm1ldGhvZCA9ICdHRVQnOwogICAgICAgICRzY29wZS51cmwgPSAnaHR0cC1oZWxsby5odG1sJzsKCiAgICAgICAgJHNjb3BlLmZldGNoID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAkc2NvcGUuY29kZSA9IG51bGw7CiAgICAgICAgICAkc2NvcGUucmVzcG9uc2UgPSBudWxsOwoKICAgICAgICAgICRodHRwKHttZXRob2Q6ICRzY29wZS5tZXRob2QsIHVybDogJHNjb3BlLnVybCwgY2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgICAgIHN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSwgc3RhdHVzKSB7CiAgICAgICAgICAgICAgJHNjb3BlLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICAgICAgICAkc2NvcGUuZGF0YSA9IGRhdGE7CiAgICAgICAgICAgIH0pLgogICAgICAgICAgICBlcnJvcihmdW5jdGlvbihkYXRhLCBzdGF0dXMpIHsKICAgICAgICAgICAgICAkc2NvcGUuZGF0YSA9IGRhdGEgfHwgIlJlcXVlc3QgZmFpbGVkIjsKICAgICAgICAgICAgICAkc2NvcGUuc3RhdHVzID0gc3RhdHVzOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgJHNjb3BlLnVwZGF0ZU1vZGVsID0gZnVuY3Rpb24obWV0aG9kLCB1cmwpIHsKICAgICAgICAgICRzY29wZS5tZXRob2QgPSBtZXRob2Q7CiAgICAgICAgICAkc2NvcGUudXJsID0gdXJsOwogICAgICAgIH07CiAgICAgIH1dKTsKPC9maWxlPgo8ZmlsZSBuYW1lPSJodHRwLWhlbGxvLmh0bWwiPgogIEhlbGxvLCAkaHR0cCEKPC9maWxlPgo8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICB2YXIgc3RhdHVzID0gZWxlbWVudChieS5iaW5kaW5nKCdzdGF0dXMnKSk7CiAgdmFyIGRhdGEgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ2RhdGEnKSk7CiAgdmFyIGZldGNoQnRuID0gZWxlbWVudChieS5pZCgnZmV0Y2hidG4nKSk7CiAgdmFyIHNhbXBsZUdldEJ0biA9IGVsZW1lbnQoYnkuaWQoJ3NhbXBsZWdldGJ0bicpKTsKICB2YXIgc2FtcGxlSnNvbnBCdG4gPSBlbGVtZW50KGJ5LmlkKCdzYW1wbGVqc29ucGJ0bicpKTsKICB2YXIgaW52YWxpZEpzb25wQnRuID0gZWxlbWVudChieS5pZCgnaW52YWxpZGpzb25wYnRuJykpOwoKICBpdCgnc2hvdWxkIG1ha2UgYW4geGhyIEdFVCByZXF1ZXN0JywgZnVuY3Rpb24oKSB7CiAgICBzYW1wbGVHZXRCdG4uY2xpY2soKTsKICAgIGZldGNoQnRuLmNsaWNrKCk7CiAgICBleHBlY3Qoc3RhdHVzLmdldFRleHQoKSkudG9NYXRjaCgnMjAwJyk7CiAgICBleHBlY3QoZGF0YS5nZXRUZXh0KCkpLnRvTWF0Y2goL0hlbGxvLCBcJGh0dHAhLyk7CiAgfSk7CgovLyBDb21tZW50ZWQgb3V0IGR1ZSB0byBmbGFrZXMuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy85MTg1Ci8vIGl0KCdzaG91bGQgbWFrZSBhIEpTT05QIHJlcXVlc3QgdG8gYW5ndWxhcmpzLm9yZycsIGZ1bmN0aW9uKCkgewovLyAgIHNhbXBsZUpzb25wQnRuLmNsaWNrKCk7Ci8vICAgZmV0Y2hCdG4uY2xpY2soKTsKLy8gICBleHBlY3Qoc3RhdHVzLmdldFRleHQoKSkudG9NYXRjaCgnMjAwJyk7Ci8vICAgZXhwZWN0KGRhdGEuZ2V0VGV4dCgpKS50b01hdGNoKC9TdXBlciBIZXJvIS8pOwovLyB9KTsKCiAgaXQoJ3Nob3VsZCBtYWtlIEpTT05QIHJlcXVlc3QgdG8gaW52YWxpZCBVUkwgYW5kIGludm9rZSB0aGUgZXJyb3IgaGFuZGxlcicsCiAgICAgIGZ1bmN0aW9uKCkgewogICAgaW52YWxpZEpzb25wQnRuLmNsaWNrKCk7CiAgICBmZXRjaEJ0bi5jbGljaygpOwogICAgZXhwZWN0KHN0YXR1cy5nZXRUZXh0KCkpLnRvTWF0Y2goJzAnKTsKICAgIGV4cGVjdChkYXRhLmdldFRleHQoKSkudG9NYXRjaCgnUmVxdWVzdCBmYWlsZWQnKTsKICB9KTsKPC9maWxlPgo8L2V4YW1wbGU+CiAgICAgKi8KICAgIGZ1bmN0aW9uICRodHRwKHJlcXVlc3RDb25maWcpIHsKICAgICAgdmFyIGNvbmZpZyA9IHsKICAgICAgICBtZXRob2Q6ICdnZXQnLAogICAgICAgIHRyYW5zZm9ybVJlcXVlc3Q6IGRlZmF1bHRzLnRyYW5zZm9ybVJlcXVlc3QsCiAgICAgICAgdHJhbnNmb3JtUmVzcG9uc2U6IGRlZmF1bHRzLnRyYW5zZm9ybVJlc3BvbnNlCiAgICAgIH07CiAgICAgIHZhciBoZWFkZXJzID0gbWVyZ2VIZWFkZXJzKHJlcXVlc3RDb25maWcpOwoKICAgICAgZXh0ZW5kKGNvbmZpZywgcmVxdWVzdENvbmZpZyk7CiAgICAgIGNvbmZpZy5oZWFkZXJzID0gaGVhZGVyczsKICAgICAgY29uZmlnLm1ldGhvZCA9IHVwcGVyY2FzZShjb25maWcubWV0aG9kKTsKCiAgICAgIHZhciBzZXJ2ZXJSZXF1ZXN0ID0gZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgaGVhZGVycyA9IGNvbmZpZy5oZWFkZXJzOwogICAgICAgIHZhciByZXFEYXRhID0gdHJhbnNmb3JtRGF0YShjb25maWcuZGF0YSwgaGVhZGVyc0dldHRlcihoZWFkZXJzKSwgY29uZmlnLnRyYW5zZm9ybVJlcXVlc3QpOwoKICAgICAgICAvLyBzdHJpcCBjb250ZW50LXR5cGUgaWYgZGF0YSBpcyB1bmRlZmluZWQKICAgICAgICBpZiAoaXNVbmRlZmluZWQocmVxRGF0YSkpIHsKICAgICAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGhlYWRlcikgewogICAgICAgICAgICBpZiAobG93ZXJjYXNlKGhlYWRlcikgPT09ICdjb250ZW50LXR5cGUnKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGlmIChpc1VuZGVmaW5lZChjb25maWcud2l0aENyZWRlbnRpYWxzKSAmJiAhaXNVbmRlZmluZWQoZGVmYXVsdHMud2l0aENyZWRlbnRpYWxzKSkgewogICAgICAgICAgY29uZmlnLndpdGhDcmVkZW50aWFscyA9IGRlZmF1bHRzLndpdGhDcmVkZW50aWFsczsKICAgICAgICB9CgogICAgICAgIC8vIHNlbmQgcmVxdWVzdAogICAgICAgIHJldHVybiBzZW5kUmVxKGNvbmZpZywgcmVxRGF0YSwgaGVhZGVycykudGhlbih0cmFuc2Zvcm1SZXNwb25zZSwgdHJhbnNmb3JtUmVzcG9uc2UpOwogICAgICB9OwoKICAgICAgdmFyIGNoYWluID0gW3NlcnZlclJlcXVlc3QsIHVuZGVmaW5lZF07CiAgICAgIHZhciBwcm9taXNlID0gJHEud2hlbihjb25maWcpOwoKICAgICAgLy8gYXBwbHkgaW50ZXJjZXB0b3JzCiAgICAgIGZvckVhY2gocmV2ZXJzZWRJbnRlcmNlcHRvcnMsIGZ1bmN0aW9uKGludGVyY2VwdG9yKSB7CiAgICAgICAgaWYgKGludGVyY2VwdG9yLnJlcXVlc3QgfHwgaW50ZXJjZXB0b3IucmVxdWVzdEVycm9yKSB7CiAgICAgICAgICBjaGFpbi51bnNoaWZ0KGludGVyY2VwdG9yLnJlcXVlc3QsIGludGVyY2VwdG9yLnJlcXVlc3RFcnJvcik7CiAgICAgICAgfQogICAgICAgIGlmIChpbnRlcmNlcHRvci5yZXNwb25zZSB8fCBpbnRlcmNlcHRvci5yZXNwb25zZUVycm9yKSB7CiAgICAgICAgICBjaGFpbi5wdXNoKGludGVyY2VwdG9yLnJlc3BvbnNlLCBpbnRlcmNlcHRvci5yZXNwb25zZUVycm9yKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgd2hpbGUoY2hhaW4ubGVuZ3RoKSB7CiAgICAgICAgdmFyIHRoZW5GbiA9IGNoYWluLnNoaWZ0KCk7CiAgICAgICAgdmFyIHJlamVjdEZuID0gY2hhaW4uc2hpZnQoKTsKCiAgICAgICAgcHJvbWlzZSA9IHByb21pc2UudGhlbih0aGVuRm4sIHJlamVjdEZuKTsKICAgICAgfQoKICAgICAgcHJvbWlzZS5zdWNjZXNzID0gZnVuY3Rpb24oZm4pIHsKICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgIGZuKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgfTsKCiAgICAgIHByb21pc2UuZXJyb3IgPSBmdW5jdGlvbihmbikgewogICAgICAgIHByb21pc2UudGhlbihudWxsLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgZm4ocmVzcG9uc2UuZGF0YSwgcmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5oZWFkZXJzLCBjb25maWcpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICB9OwoKICAgICAgcmV0dXJuIHByb21pc2U7CgogICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1SZXNwb25zZShyZXNwb25zZSkgewogICAgICAgIC8vIG1ha2UgYSBjb3B5IHNpbmNlIHRoZSByZXNwb25zZSBtdXN0IGJlIGNhY2hlYWJsZQogICAgICAgIHZhciByZXNwID0gZXh0ZW5kKHt9LCByZXNwb25zZSk7CiAgICAgICAgaWYgKCFyZXNwb25zZS5kYXRhKSB7CiAgICAgICAgICByZXNwLmRhdGEgPSByZXNwb25zZS5kYXRhOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXNwLmRhdGEgPSB0cmFuc2Zvcm1EYXRhKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLmhlYWRlcnMsIGNvbmZpZy50cmFuc2Zvcm1SZXNwb25zZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAoaXNTdWNjZXNzKHJlc3BvbnNlLnN0YXR1cykpCiAgICAgICAgICA/IHJlc3AKICAgICAgICAgIDogJHEucmVqZWN0KHJlc3ApOwogICAgICB9CgogICAgICBmdW5jdGlvbiBtZXJnZUhlYWRlcnMoY29uZmlnKSB7CiAgICAgICAgdmFyIGRlZkhlYWRlcnMgPSBkZWZhdWx0cy5oZWFkZXJzLAogICAgICAgICAgICByZXFIZWFkZXJzID0gZXh0ZW5kKHt9LCBjb25maWcuaGVhZGVycyksCiAgICAgICAgICAgIGRlZkhlYWRlck5hbWUsIGxvd2VyY2FzZURlZkhlYWRlck5hbWUsIHJlcUhlYWRlck5hbWU7CgogICAgICAgIGRlZkhlYWRlcnMgPSBleHRlbmQoe30sIGRlZkhlYWRlcnMuY29tbW9uLCBkZWZIZWFkZXJzW2xvd2VyY2FzZShjb25maWcubWV0aG9kKV0pOwoKICAgICAgICAvLyB1c2luZyBmb3ItaW4gaW5zdGVhZCBvZiBmb3JFYWNoIHRvIGF2b2lkIHVuZWNlc3NhcnkgaXRlcmF0aW9uIGFmdGVyIGhlYWRlciBoYXMgYmVlbiBmb3VuZAogICAgICAgIGRlZmF1bHRIZWFkZXJzSXRlcmF0aW9uOgogICAgICAgIGZvciAoZGVmSGVhZGVyTmFtZSBpbiBkZWZIZWFkZXJzKSB7CiAgICAgICAgICBsb3dlcmNhc2VEZWZIZWFkZXJOYW1lID0gbG93ZXJjYXNlKGRlZkhlYWRlck5hbWUpOwoKICAgICAgICAgIGZvciAocmVxSGVhZGVyTmFtZSBpbiByZXFIZWFkZXJzKSB7CiAgICAgICAgICAgIGlmIChsb3dlcmNhc2UocmVxSGVhZGVyTmFtZSkgPT09IGxvd2VyY2FzZURlZkhlYWRlck5hbWUpIHsKICAgICAgICAgICAgICBjb250aW51ZSBkZWZhdWx0SGVhZGVyc0l0ZXJhdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJlcUhlYWRlcnNbZGVmSGVhZGVyTmFtZV0gPSBkZWZIZWFkZXJzW2RlZkhlYWRlck5hbWVdOwogICAgICAgIH0KCiAgICAgICAgLy8gZXhlY3V0ZSBpZiBoZWFkZXIgdmFsdWUgaXMgYSBmdW5jdGlvbiBmb3IgbWVyZ2VkIGhlYWRlcnMKICAgICAgICBleGVjSGVhZGVycyhyZXFIZWFkZXJzKTsKICAgICAgICByZXR1cm4gcmVxSGVhZGVyczsKCiAgICAgICAgZnVuY3Rpb24gZXhlY0hlYWRlcnMoaGVhZGVycykgewogICAgICAgICAgdmFyIGhlYWRlckNvbnRlbnQ7CgogICAgICAgICAgZm9yRWFjaChoZWFkZXJzLCBmdW5jdGlvbihoZWFkZXJGbiwgaGVhZGVyKSB7CiAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGhlYWRlckZuKSkgewogICAgICAgICAgICAgIGhlYWRlckNvbnRlbnQgPSBoZWFkZXJGbigpOwogICAgICAgICAgICAgIGlmIChoZWFkZXJDb250ZW50ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGhlYWRlcnNbaGVhZGVyXSA9IGhlYWRlckNvbnRlbnQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBoZWFkZXJzW2hlYWRlcl07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAkaHR0cC5wZW5kaW5nUmVxdWVzdHMgPSBbXTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRodHRwI2dldAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEdFVGAgcmVxdWVzdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaHR0cCNkZWxldGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBERUxFVEVgIHJlcXVlc3QuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGh0dHAjaGVhZAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEhFQURgIHJlcXVlc3QuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGh0dHAjanNvbnAKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBKU09OUGAgcmVxdWVzdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdC4KICAgICAqICAgICAgICAgICAgICAgICAgICAgVGhlIG5hbWUgb2YgdGhlIGNhbGxiYWNrIHNob3VsZCBiZSB0aGUgc3RyaW5nIGBKU09OX0NBTExCQUNLYC4KICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAqLwogICAgY3JlYXRlU2hvcnRNZXRob2RzKCdnZXQnLCAnZGVsZXRlJywgJ2hlYWQnLCAnanNvbnAnKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRodHRwI3Bvc3QKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBQT1NUYCByZXF1ZXN0LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgKiBAcGFyYW0geyp9IGRhdGEgUmVxdWVzdCBjb250ZW50CiAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRodHRwI3B1dAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYFBVVGAgcmVxdWVzdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICogQHBhcmFtIHsqfSBkYXRhIFJlcXVlc3QgY29udGVudAogICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICovCgogICAgIC8qKgogICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgKiBAbmFtZSAkaHR0cCNwYXRjaAogICAgICAqCiAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYFBBVENIYCByZXF1ZXN0LgogICAgICAqCiAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgKiBAcGFyYW0geyp9IGRhdGEgUmVxdWVzdCBjb250ZW50CiAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgKi8KICAgIGNyZWF0ZVNob3J0TWV0aG9kc1dpdGhEYXRhKCdwb3N0JywgJ3B1dCcsICdwYXRjaCcpOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgKiBAbmFtZSAkaHR0cCNkZWZhdWx0cwogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogUnVudGltZSBlcXVpdmFsZW50IG9mIHRoZSBgJGh0dHBQcm92aWRlci5kZWZhdWx0c2AgcHJvcGVydHkuIEFsbG93cyBjb25maWd1cmF0aW9uIG9mCiAgICAgICAgICogZGVmYXVsdCBoZWFkZXJzLCB3aXRoQ3JlZGVudGlhbHMgYXMgd2VsbCBhcyByZXF1ZXN0IGFuZCByZXNwb25zZSB0cmFuc2Zvcm1hdGlvbnMuCiAgICAgICAgICoKICAgICAgICAgKiBTZWUgIlNldHRpbmcgSFRUUCBIZWFkZXJzIiBhbmQgIlRyYW5zZm9ybWluZyBSZXF1ZXN0cyBhbmQgUmVzcG9uc2VzIiBzZWN0aW9ucyBhYm92ZS4KICAgICAgICAgKi8KICAgICRodHRwLmRlZmF1bHRzID0gZGVmYXVsdHM7CgoKICAgIHJldHVybiAkaHR0cDsKCgogICAgZnVuY3Rpb24gY3JlYXRlU2hvcnRNZXRob2RzKG5hbWVzKSB7CiAgICAgIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgJGh0dHBbbmFtZV0gPSBmdW5jdGlvbih1cmwsIGNvbmZpZykgewogICAgICAgICAgcmV0dXJuICRodHRwKGV4dGVuZChjb25maWcgfHwge30sIHsKICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICB1cmw6IHVybAogICAgICAgICAgfSkpOwogICAgICAgIH07CiAgICAgIH0pOwogICAgfQoKCiAgICBmdW5jdGlvbiBjcmVhdGVTaG9ydE1ldGhvZHNXaXRoRGF0YShuYW1lKSB7CiAgICAgIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgJGh0dHBbbmFtZV0gPSBmdW5jdGlvbih1cmwsIGRhdGEsIGNvbmZpZykgewogICAgICAgICAgcmV0dXJuICRodHRwKGV4dGVuZChjb25maWcgfHwge30sIHsKICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgfSkpOwogICAgICAgIH07CiAgICAgIH0pOwogICAgfQoKCiAgICAvKioKICAgICAqIE1ha2VzIHRoZSByZXF1ZXN0LgogICAgICoKICAgICAqICEhISBBQ0NFU1NFUyBDTE9TVVJFIFZBUlM6CiAgICAgKiAkaHR0cEJhY2tlbmQsIGRlZmF1bHRzLCAkbG9nLCAkcm9vdFNjb3BlLCBkZWZhdWx0Q2FjaGUsICRodHRwLnBlbmRpbmdSZXF1ZXN0cwogICAgICovCiAgICBmdW5jdGlvbiBzZW5kUmVxKGNvbmZpZywgcmVxRGF0YSwgcmVxSGVhZGVycykgewogICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpLAogICAgICAgICAgcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2UsCiAgICAgICAgICBjYWNoZSwKICAgICAgICAgIGNhY2hlZFJlc3AsCiAgICAgICAgICB1cmwgPSBidWlsZFVybChjb25maWcudXJsLCBjb25maWcucGFyYW1zKTsKCiAgICAgICRodHRwLnBlbmRpbmdSZXF1ZXN0cy5wdXNoKGNvbmZpZyk7CiAgICAgIHByb21pc2UudGhlbihyZW1vdmVQZW5kaW5nUmVxLCByZW1vdmVQZW5kaW5nUmVxKTsKCgogICAgICBpZiAoKGNvbmZpZy5jYWNoZSB8fCBkZWZhdWx0cy5jYWNoZSkgJiYgY29uZmlnLmNhY2hlICE9PSBmYWxzZSAmJgogICAgICAgICAgKGNvbmZpZy5tZXRob2QgPT09ICdHRVQnIHx8IGNvbmZpZy5tZXRob2QgPT09ICdKU09OUCcpKSB7CiAgICAgICAgY2FjaGUgPSBpc09iamVjdChjb25maWcuY2FjaGUpID8gY29uZmlnLmNhY2hlCiAgICAgICAgICAgICAgOiBpc09iamVjdChkZWZhdWx0cy5jYWNoZSkgPyBkZWZhdWx0cy5jYWNoZQogICAgICAgICAgICAgIDogZGVmYXVsdENhY2hlOwogICAgICB9CgogICAgICBpZiAoY2FjaGUpIHsKICAgICAgICBjYWNoZWRSZXNwID0gY2FjaGUuZ2V0KHVybCk7CiAgICAgICAgaWYgKGlzRGVmaW5lZChjYWNoZWRSZXNwKSkgewogICAgICAgICAgaWYgKGlzUHJvbWlzZUxpa2UoY2FjaGVkUmVzcCkpIHsKICAgICAgICAgICAgLy8gY2FjaGVkIHJlcXVlc3QgaGFzIGFscmVhZHkgYmVlbiBzZW50LCBidXQgdGhlcmUgaXMgbm8gcmVzcG9uc2UgeWV0CiAgICAgICAgICAgIGNhY2hlZFJlc3AudGhlbihyZW1vdmVQZW5kaW5nUmVxLCByZW1vdmVQZW5kaW5nUmVxKTsKICAgICAgICAgICAgcmV0dXJuIGNhY2hlZFJlc3A7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBzZXJ2aW5nIGZyb20gY2FjaGUKICAgICAgICAgICAgaWYgKGlzQXJyYXkoY2FjaGVkUmVzcCkpIHsKICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShjYWNoZWRSZXNwWzFdLCBjYWNoZWRSZXNwWzBdLCBzaGFsbG93Q29weShjYWNoZWRSZXNwWzJdKSwgY2FjaGVkUmVzcFszXSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzb2x2ZVByb21pc2UoY2FjaGVkUmVzcCwgMjAwLCB7fSwgJ09LJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gcHV0IHRoZSBwcm9taXNlIGZvciB0aGUgbm9uLXRyYW5zZm9ybWVkIHJlc3BvbnNlIGludG8gY2FjaGUgYXMgYSBwbGFjZWhvbGRlcgogICAgICAgICAgY2FjaGUucHV0KHVybCwgcHJvbWlzZSk7CiAgICAgICAgfQogICAgICB9CgoKICAgICAgLy8gaWYgd2Ugd29uJ3QgaGF2ZSB0aGUgcmVzcG9uc2UgaW4gY2FjaGUsIHNldCB0aGUgeHNyZiBoZWFkZXJzIGFuZAogICAgICAvLyBzZW5kIHRoZSByZXF1ZXN0IHRvIHRoZSBiYWNrZW5kCiAgICAgIGlmIChpc1VuZGVmaW5lZChjYWNoZWRSZXNwKSkgewogICAgICAgIHZhciB4c3JmVmFsdWUgPSB1cmxJc1NhbWVPcmlnaW4oY29uZmlnLnVybCkKICAgICAgICAgICAgPyAkYnJvd3Nlci5jb29raWVzKClbY29uZmlnLnhzcmZDb29raWVOYW1lIHx8IGRlZmF1bHRzLnhzcmZDb29raWVOYW1lXQogICAgICAgICAgICA6IHVuZGVmaW5lZDsKICAgICAgICBpZiAoeHNyZlZhbHVlKSB7CiAgICAgICAgICByZXFIZWFkZXJzWyhjb25maWcueHNyZkhlYWRlck5hbWUgfHwgZGVmYXVsdHMueHNyZkhlYWRlck5hbWUpXSA9IHhzcmZWYWx1ZTsKICAgICAgICB9CgogICAgICAgICRodHRwQmFja2VuZChjb25maWcubWV0aG9kLCB1cmwsIHJlcURhdGEsIGRvbmUsIHJlcUhlYWRlcnMsIGNvbmZpZy50aW1lb3V0LAogICAgICAgICAgICBjb25maWcud2l0aENyZWRlbnRpYWxzLCBjb25maWcucmVzcG9uc2VUeXBlKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHByb21pc2U7CgoKICAgICAgLyoqCiAgICAgICAqIENhbGxiYWNrIHJlZ2lzdGVyZWQgdG8gJGh0dHBCYWNrZW5kKCk6CiAgICAgICAqICAtIGNhY2hlcyB0aGUgcmVzcG9uc2UgaWYgZGVzaXJlZAogICAgICAgKiAgLSByZXNvbHZlcyB0aGUgcmF3ICRodHRwIHByb21pc2UKICAgICAgICogIC0gY2FsbHMgJGFwcGx5CiAgICAgICAqLwogICAgICBmdW5jdGlvbiBkb25lKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcsIHN0YXR1c1RleHQpIHsKICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgIGlmIChpc1N1Y2Nlc3Moc3RhdHVzKSkgewogICAgICAgICAgICBjYWNoZS5wdXQodXJsLCBbc3RhdHVzLCByZXNwb25zZSwgcGFyc2VIZWFkZXJzKGhlYWRlcnNTdHJpbmcpLCBzdGF0dXNUZXh0XSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyByZW1vdmUgcHJvbWlzZSBmcm9tIHRoZSBjYWNoZQogICAgICAgICAgICBjYWNoZS5yZW1vdmUodXJsKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVIdHRwUHJvbWlzZSgpIHsKICAgICAgICAgIHJlc29sdmVQcm9taXNlKHJlc3BvbnNlLCBzdGF0dXMsIGhlYWRlcnNTdHJpbmcsIHN0YXR1c1RleHQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHVzZUFwcGx5QXN5bmMpIHsKICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5QXN5bmMocmVzb2x2ZUh0dHBQcm9taXNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzb2x2ZUh0dHBQcm9taXNlKCk7CiAgICAgICAgICBpZiAoISRyb290U2NvcGUuJCRwaGFzZSkgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICB9CiAgICAgIH0KCgogICAgICAvKioKICAgICAgICogUmVzb2x2ZXMgdGhlIHJhdyAkaHR0cCBwcm9taXNlLgogICAgICAgKi8KICAgICAgZnVuY3Rpb24gcmVzb2x2ZVByb21pc2UocmVzcG9uc2UsIHN0YXR1cywgaGVhZGVycywgc3RhdHVzVGV4dCkgewogICAgICAgIC8vIG5vcm1hbGl6ZSBpbnRlcm5hbCBzdGF0dXNlcyB0byAwCiAgICAgICAgc3RhdHVzID0gTWF0aC5tYXgoc3RhdHVzLCAwKTsKCiAgICAgICAgKGlzU3VjY2VzcyhzdGF0dXMpID8gZGVmZXJyZWQucmVzb2x2ZSA6IGRlZmVycmVkLnJlamVjdCkoewogICAgICAgICAgZGF0YTogcmVzcG9uc2UsCiAgICAgICAgICBzdGF0dXM6IHN0YXR1cywKICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnNHZXR0ZXIoaGVhZGVycyksCiAgICAgICAgICBjb25maWc6IGNvbmZpZywKICAgICAgICAgIHN0YXR1c1RleHQgOiBzdGF0dXNUZXh0CiAgICAgICAgfSk7CiAgICAgIH0KCgogICAgICBmdW5jdGlvbiByZW1vdmVQZW5kaW5nUmVxKCkgewogICAgICAgIHZhciBpZHggPSAkaHR0cC5wZW5kaW5nUmVxdWVzdHMuaW5kZXhPZihjb25maWcpOwogICAgICAgIGlmIChpZHggIT09IC0xKSAkaHR0cC5wZW5kaW5nUmVxdWVzdHMuc3BsaWNlKGlkeCwgMSk7CiAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gYnVpbGRVcmwodXJsLCBwYXJhbXMpIHsKICAgICAgaWYgKCFwYXJhbXMpIHJldHVybiB1cmw7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBmb3JFYWNoU29ydGVkKHBhcmFtcywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCBpc1VuZGVmaW5lZCh2YWx1ZSkpIHJldHVybjsKICAgICAgICBpZiAoIWlzQXJyYXkodmFsdWUpKSB2YWx1ZSA9IFt2YWx1ZV07CgogICAgICAgIGZvckVhY2godmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgIGlmIChpc09iamVjdCh2KSkgewogICAgICAgICAgICBpZiAoaXNEYXRlKHYpKXsKICAgICAgICAgICAgICB2ID0gdi50b0lTT1N0cmluZygpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHYgPSB0b0pzb24odik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBhcnRzLnB1c2goZW5jb2RlVXJpUXVlcnkoa2V5KSArICc9JyArCiAgICAgICAgICAgICAgICAgICAgIGVuY29kZVVyaVF1ZXJ5KHYpKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIGlmKHBhcnRzLmxlbmd0aCA+IDApIHsKICAgICAgICB1cmwgKz0gKCh1cmwuaW5kZXhPZignPycpID09IC0xKSA/ICc/JyA6ICcmJykgKyBwYXJ0cy5qb2luKCcmJyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHVybDsKICAgIH0KICB9XTsKfQoKZnVuY3Rpb24gY3JlYXRlWGhyKCkgewogICAgcmV0dXJuIG5ldyB3aW5kb3cuWE1MSHR0cFJlcXVlc3QoKTsKfQoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRodHRwQmFja2VuZAogKiBAcmVxdWlyZXMgJHdpbmRvdwogKiBAcmVxdWlyZXMgJGRvY3VtZW50CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBIVFRQIGJhY2tlbmQgdXNlZCBieSB0aGUge0BsaW5rIG5nLiRodHRwIHNlcnZpY2V9IHRoYXQgZGVsZWdhdGVzIHRvCiAqIFhNTEh0dHBSZXF1ZXN0IG9iamVjdCBvciBKU09OUCBhbmQgZGVhbHMgd2l0aCBicm93c2VyIGluY29tcGF0aWJpbGl0aWVzLgogKgogKiBZb3Ugc2hvdWxkIG5ldmVyIG5lZWQgdG8gdXNlIHRoaXMgc2VydmljZSBkaXJlY3RseSwgaW5zdGVhZCB1c2UgdGhlIGhpZ2hlci1sZXZlbCBhYnN0cmFjdGlvbnM6CiAqIHtAbGluayBuZy4kaHR0cCAkaHR0cH0gb3Ige0BsaW5rIG5nUmVzb3VyY2UuJHJlc291cmNlICRyZXNvdXJjZX0uCiAqCiAqIER1cmluZyB0ZXN0aW5nIHRoaXMgaW1wbGVtZW50YXRpb24gaXMgc3dhcHBlZCB3aXRoIHtAbGluayBuZ01vY2suJGh0dHBCYWNrZW5kIG1vY2sKICogJGh0dHBCYWNrZW5kfSB3aGljaCBjYW4gYmUgdHJhaW5lZCB3aXRoIHJlc3BvbnNlcy4KICovCmZ1bmN0aW9uICRIdHRwQmFja2VuZFByb3ZpZGVyKCkgewogIHRoaXMuJGdldCA9IFsnJGJyb3dzZXInLCAnJHdpbmRvdycsICckZG9jdW1lbnQnLCBmdW5jdGlvbigkYnJvd3NlciwgJHdpbmRvdywgJGRvY3VtZW50KSB7CiAgICByZXR1cm4gY3JlYXRlSHR0cEJhY2tlbmQoJGJyb3dzZXIsIGNyZWF0ZVhociwgJGJyb3dzZXIuZGVmZXIsICR3aW5kb3cuYW5ndWxhci5jYWxsYmFja3MsICRkb2N1bWVudFswXSk7CiAgfV07Cn0KCmZ1bmN0aW9uIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBjcmVhdGVYaHIsICRicm93c2VyRGVmZXIsIGNhbGxiYWNrcywgcmF3RG9jdW1lbnQpIHsKICAvLyBUT0RPKHZvanRhKTogZml4IHRoZSBzaWduYXR1cmUKICByZXR1cm4gZnVuY3Rpb24obWV0aG9kLCB1cmwsIHBvc3QsIGNhbGxiYWNrLCBoZWFkZXJzLCB0aW1lb3V0LCB3aXRoQ3JlZGVudGlhbHMsIHJlc3BvbnNlVHlwZSkgewogICAgJGJyb3dzZXIuJCRpbmNPdXRzdGFuZGluZ1JlcXVlc3RDb3VudCgpOwogICAgdXJsID0gdXJsIHx8ICRicm93c2VyLnVybCgpOwoKICAgIGlmIChsb3dlcmNhc2UobWV0aG9kKSA9PSAnanNvbnAnKSB7CiAgICAgIHZhciBjYWxsYmFja0lkID0gJ18nICsgKGNhbGxiYWNrcy5jb3VudGVyKyspLnRvU3RyaW5nKDM2KTsKICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXS5kYXRhID0gZGF0YTsKICAgICAgICBjYWxsYmFja3NbY2FsbGJhY2tJZF0uY2FsbGVkID0gdHJ1ZTsKICAgICAgfTsKCiAgICAgIHZhciBqc29ucERvbmUgPSBqc29ucFJlcSh1cmwucmVwbGFjZSgnSlNPTl9DQUxMQkFDSycsICdhbmd1bGFyLmNhbGxiYWNrcy4nICsgY2FsbGJhY2tJZCksCiAgICAgICAgICBjYWxsYmFja0lkLCBmdW5jdGlvbihzdGF0dXMsIHRleHQpIHsKICAgICAgICBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIHN0YXR1cywgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEsICIiLCB0ZXh0KTsKICAgICAgICBjYWxsYmFja3NbY2FsbGJhY2tJZF0gPSBub29wOwogICAgICB9KTsKICAgIH0gZWxzZSB7CgogICAgICB2YXIgeGhyID0gY3JlYXRlWGhyKCk7CgogICAgICB4aHIub3BlbihtZXRob2QsIHVybCwgdHJ1ZSk7CiAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICB4aHIub25sb2FkID0gZnVuY3Rpb24gcmVxdWVzdExvYWRlZCgpIHsKICAgICAgICB2YXIgc3RhdHVzVGV4dCA9IHhoci5zdGF0dXNUZXh0IHx8ICcnOwoKICAgICAgICAvLyByZXNwb25zZVRleHQgaXMgdGhlIG9sZC1zY2hvb2wgd2F5IG9mIHJldHJpZXZpbmcgcmVzcG9uc2UgKHN1cHBvcnRlZCBieSBJRTggJiA5KQogICAgICAgIC8vIHJlc3BvbnNlL3Jlc3BvbnNlVHlwZSBwcm9wZXJ0aWVzIHdlcmUgaW50cm9kdWNlZCBpbiBYSFIgTGV2ZWwyIHNwZWMgKHN1cHBvcnRlZCBieSBJRTEwKQogICAgICAgIHZhciByZXNwb25zZSA9ICgncmVzcG9uc2UnIGluIHhocikgPyB4aHIucmVzcG9uc2UgOiB4aHIucmVzcG9uc2VUZXh0OwoKICAgICAgICAvLyBub3JtYWxpemUgSUU5IGJ1ZyAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTQ1MCkKICAgICAgICB2YXIgc3RhdHVzID0geGhyLnN0YXR1cyA9PT0gMTIyMyA/IDIwNCA6IHhoci5zdGF0dXM7CgogICAgICAgIC8vIGZpeCBzdGF0dXMgY29kZSB3aGVuIGl0IGlzIDAgKDAgc3RhdHVzIGlzIHVuZG9jdW1lbnRlZCkuCiAgICAgICAgLy8gT2NjdXJzIHdoZW4gYWNjZXNzaW5nIGZpbGUgcmVzb3VyY2VzIG9yIG9uIEFuZHJvaWQgNC4xIHN0b2NrIGJyb3dzZXIKICAgICAgICAvLyB3aGlsZSByZXRyaWV2aW5nIGZpbGVzIGZyb20gYXBwbGljYXRpb24gY2FjaGUuCiAgICAgICAgaWYgKHN0YXR1cyA9PT0gMCkgewogICAgICAgICAgc3RhdHVzID0gcmVzcG9uc2UgPyAyMDAgOiB1cmxSZXNvbHZlKHVybCkucHJvdG9jb2wgPT0gJ2ZpbGUnID8gNDA0IDogMDsKICAgICAgICB9CgogICAgICAgIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywKICAgICAgICAgICAgc3RhdHVzLAogICAgICAgICAgICByZXNwb25zZSwKICAgICAgICAgICAgeGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpLAogICAgICAgICAgICBzdGF0dXNUZXh0KTsKICAgICAgfTsKCiAgICAgIHZhciByZXF1ZXN0RXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gVGhlIHJlc3BvbnNlIGlzIGFsd2F5cyBlbXB0eQogICAgICAgIC8vIFNlZSBodHRwczovL3hoci5zcGVjLndoYXR3Zy5vcmcvI3JlcXVlc3QtZXJyb3Itc3RlcHMgYW5kIGh0dHBzOi8vZmV0Y2guc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LW5ldHdvcmstZXJyb3IKICAgICAgICBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIC0xLCBudWxsLCBudWxsLCAnJyk7CiAgICAgIH07CgogICAgICB4aHIub25lcnJvciA9IHJlcXVlc3RFcnJvcjsKICAgICAgeGhyLm9uYWJvcnQgPSByZXF1ZXN0RXJyb3I7CgogICAgICBpZiAod2l0aENyZWRlbnRpYWxzKSB7CiAgICAgICAgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmIChyZXNwb25zZVR5cGUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9IHJlc3BvbnNlVHlwZTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAvLyBXZWJLaXQgYWRkZWQgc3VwcG9ydCBmb3IgdGhlIGpzb24gcmVzcG9uc2VUeXBlIHZhbHVlIG9uIDA5LzAzLzIwMTMKICAgICAgICAgIC8vIGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD03MzY0OC4gVmVyc2lvbnMgb2YgU2FmYXJpIHByaW9yIHRvIDcgYXJlCiAgICAgICAgICAvLyBrbm93biB0byB0aHJvdyB3aGVuIHNldHRpbmcgdGhlIHZhbHVlICJqc29uIiBhcyB0aGUgcmVzcG9uc2UgdHlwZS4gT3RoZXIgb2xkZXIKICAgICAgICAgIC8vIGJyb3dzZXJzIGltcGxlbWVudGluZyB0aGUgcmVzcG9uc2VUeXBlCiAgICAgICAgICAvLwogICAgICAgICAgLy8gVGhlIGpzb24gcmVzcG9uc2UgdHlwZSBjYW4gYmUgaWdub3JlZCBpZiBub3Qgc3VwcG9ydGVkLCBiZWNhdXNlIEpTT04gcGF5bG9hZHMgYXJlCiAgICAgICAgICAvLyBwYXJzZWQgb24gdGhlIGNsaWVudC1zaWRlIHJlZ2FyZGxlc3MuCiAgICAgICAgICBpZiAocmVzcG9uc2VUeXBlICE9PSAnanNvbicpIHsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHhoci5zZW5kKHBvc3QgfHwgbnVsbCk7CiAgICB9CgogICAgaWYgKHRpbWVvdXQgPiAwKSB7CiAgICAgIHZhciB0aW1lb3V0SWQgPSAkYnJvd3NlckRlZmVyKHRpbWVvdXRSZXF1ZXN0LCB0aW1lb3V0KTsKICAgIH0gZWxzZSBpZiAoaXNQcm9taXNlTGlrZSh0aW1lb3V0KSkgewogICAgICB0aW1lb3V0LnRoZW4odGltZW91dFJlcXVlc3QpOwogICAgfQoKCiAgICBmdW5jdGlvbiB0aW1lb3V0UmVxdWVzdCgpIHsKICAgICAganNvbnBEb25lICYmIGpzb25wRG9uZSgpOwogICAgICB4aHIgJiYgeGhyLmFib3J0KCk7CiAgICB9CgogICAgZnVuY3Rpb24gY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLCBzdGF0dXMsIHJlc3BvbnNlLCBoZWFkZXJzU3RyaW5nLCBzdGF0dXNUZXh0KSB7CiAgICAgIC8vIGNhbmNlbCB0aW1lb3V0IGFuZCBzdWJzZXF1ZW50IHRpbWVvdXQgcHJvbWlzZSByZXNvbHV0aW9uCiAgICAgIHRpbWVvdXRJZCAmJiAkYnJvd3NlckRlZmVyLmNhbmNlbCh0aW1lb3V0SWQpOwogICAgICBqc29ucERvbmUgPSB4aHIgPSBudWxsOwoKICAgICAgY2FsbGJhY2soc3RhdHVzLCByZXNwb25zZSwgaGVhZGVyc1N0cmluZywgc3RhdHVzVGV4dCk7CiAgICAgICRicm93c2VyLiQkY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Qobm9vcCk7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24ganNvbnBSZXEodXJsLCBjYWxsYmFja0lkLCBkb25lKSB7CiAgICAvLyB3ZSBjYW4ndCB1c2UgalF1ZXJ5L2pxTGl0ZSBoZXJlIGJlY2F1c2UgalF1ZXJ5IGRvZXMgY3Jhenkgc2hpdCB3aXRoIHNjcmlwdCBlbGVtZW50cywgZS5nLjoKICAgIC8vIC0gZmV0Y2hlcyBsb2NhbCBzY3JpcHRzIHZpYSBYSFIgYW5kIGV2YWxzIHRoZW0KICAgIC8vIC0gYWRkcyBhbmQgaW1tZWRpYXRlbHkgcmVtb3ZlcyBzY3JpcHQgZWxlbWVudHMgZnJvbSB0aGUgZG9jdW1lbnQKICAgIHZhciBzY3JpcHQgPSByYXdEb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwgY2FsbGJhY2sgPSBudWxsOwogICAgc2NyaXB0LnR5cGUgPSAidGV4dC9qYXZhc2NyaXB0IjsKICAgIHNjcmlwdC5zcmMgPSB1cmw7CiAgICBzY3JpcHQuYXN5bmMgPSB0cnVlOwoKICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKHNjcmlwdCwgImxvYWQiLCBjYWxsYmFjayk7CiAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihzY3JpcHQsICJlcnJvciIsIGNhbGxiYWNrKTsKICAgICAgcmF3RG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICBzY3JpcHQgPSBudWxsOwogICAgICB2YXIgc3RhdHVzID0gLTE7CiAgICAgIHZhciB0ZXh0ID0gInVua25vd24iOwoKICAgICAgaWYgKGV2ZW50KSB7CiAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJsb2FkIiAmJiAhY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmNhbGxlZCkgewogICAgICAgICAgZXZlbnQgPSB7IHR5cGU6ICJlcnJvciIgfTsKICAgICAgICB9CiAgICAgICAgdGV4dCA9IGV2ZW50LnR5cGU7CiAgICAgICAgc3RhdHVzID0gZXZlbnQudHlwZSA9PT0gImVycm9yIiA/IDQwNCA6IDIwMDsKICAgICAgfQoKICAgICAgaWYgKGRvbmUpIHsKICAgICAgICBkb25lKHN0YXR1cywgdGV4dCk7CiAgICAgIH0KICAgIH07CgogICAgYWRkRXZlbnRMaXN0ZW5lckZuKHNjcmlwdCwgImxvYWQiLCBjYWxsYmFjayk7CiAgICBhZGRFdmVudExpc3RlbmVyRm4oc2NyaXB0LCAiZXJyb3IiLCBjYWxsYmFjayk7CiAgICByYXdEb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICByZXR1cm4gY2FsbGJhY2s7CiAgfQp9Cgp2YXIgJGludGVycG9sYXRlTWluRXJyID0gbWluRXJyKCckaW50ZXJwb2xhdGUnKTsKCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJGludGVycG9sYXRlUHJvdmlkZXIKICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIFVzZWQgZm9yIGNvbmZpZ3VyaW5nIHRoZSBpbnRlcnBvbGF0aW9uIG1hcmt1cC4gRGVmYXVsdHMgdG8gYHt7YCBhbmQgYH19YC4KICoKICogQGV4YW1wbGUKPGV4YW1wbGUgbW9kdWxlPSJjdXN0b21JbnRlcnBvbGF0aW9uQXBwIj4KPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CjxzY3JpcHQ+CiAgdmFyIGN1c3RvbUludGVycG9sYXRpb25BcHAgPSBhbmd1bGFyLm1vZHVsZSgnY3VzdG9tSW50ZXJwb2xhdGlvbkFwcCcsIFtdKTsKCiAgY3VzdG9tSW50ZXJwb2xhdGlvbkFwcC5jb25maWcoZnVuY3Rpb24oJGludGVycG9sYXRlUHJvdmlkZXIpIHsKICAgICRpbnRlcnBvbGF0ZVByb3ZpZGVyLnN0YXJ0U3ltYm9sKCcvLycpOwogICAgJGludGVycG9sYXRlUHJvdmlkZXIuZW5kU3ltYm9sKCcvLycpOwogIH0pOwoKCiAgY3VzdG9tSW50ZXJwb2xhdGlvbkFwcC5jb250cm9sbGVyKCdEZW1vQ29udHJvbGxlcicsIGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmxhYmVsID0gIlRoaXMgYmluZGluZyBpcyBicm91Z2h0IHlvdSBieSAvLyBpbnRlcnBvbGF0aW9uIHN5bWJvbHMuIjsKICB9KTsKPC9zY3JpcHQ+CjxkaXYgbmctYXBwPSJBcHAiIG5nLWNvbnRyb2xsZXI9IkRlbW9Db250cm9sbGVyIGFzIGRlbW8iPgogICAgLy9kZW1vLmxhYmVsLy8KPC9kaXY+CjwvZmlsZT4KPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgaXQoJ3Nob3VsZCBpbnRlcnBvbGF0ZSBiaW5kaW5nIHdpdGggY3VzdG9tIHN5bWJvbHMnLCBmdW5jdGlvbigpIHsKICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2RlbW8ubGFiZWwnKSkuZ2V0VGV4dCgpKS50b0JlKCdUaGlzIGJpbmRpbmcgaXMgYnJvdWdodCB5b3UgYnkgLy8gaW50ZXJwb2xhdGlvbiBzeW1ib2xzLicpOwogIH0pOwo8L2ZpbGU+CjwvZXhhbXBsZT4KICovCmZ1bmN0aW9uICRJbnRlcnBvbGF0ZVByb3ZpZGVyKCkgewogIHZhciBzdGFydFN5bWJvbCA9ICd7eyc7CiAgdmFyIGVuZFN5bWJvbCA9ICd9fSc7CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW50ZXJwb2xhdGVQcm92aWRlciNzdGFydFN5bWJvbAogICAqIEBkZXNjcmlwdGlvbgogICAqIFN5bWJvbCB0byBkZW5vdGUgc3RhcnQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYHt7YC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgbmV3IHZhbHVlIHRvIHNldCB0aGUgc3RhcnRpbmcgc3ltYm9sIHRvLgogICAqIEByZXR1cm5zIHtzdHJpbmd8c2VsZn0gUmV0dXJucyB0aGUgc3ltYm9sIHdoZW4gdXNlZCBhcyBnZXR0ZXIgYW5kIHNlbGYgaWYgdXNlZCBhcyBzZXR0ZXIuCiAgICovCiAgdGhpcy5zdGFydFN5bWJvbCA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgIGlmICh2YWx1ZSkgewogICAgICBzdGFydFN5bWJvbCA9IHZhbHVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBzdGFydFN5bWJvbDsKICAgIH0KICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGludGVycG9sYXRlUHJvdmlkZXIjZW5kU3ltYm9sCiAgICogQGRlc2NyaXB0aW9uCiAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgZW5kIG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB9fWAuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIG5ldyB2YWx1ZSB0byBzZXQgdGhlIGVuZGluZyBzeW1ib2wgdG8uCiAgICogQHJldHVybnMge3N0cmluZ3xzZWxmfSBSZXR1cm5zIHRoZSBzeW1ib2wgd2hlbiB1c2VkIGFzIGdldHRlciBhbmQgc2VsZiBpZiB1c2VkIGFzIHNldHRlci4KICAgKi8KICB0aGlzLmVuZFN5bWJvbCA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgIGlmICh2YWx1ZSkgewogICAgICBlbmRTeW1ib2wgPSB2YWx1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZW5kU3ltYm9sOwogICAgfQogIH07CgoKICB0aGlzLiRnZXQgPSBbJyRwYXJzZScsICckZXhjZXB0aW9uSGFuZGxlcicsICckc2NlJywgZnVuY3Rpb24oJHBhcnNlLCAkZXhjZXB0aW9uSGFuZGxlciwgJHNjZSkgewogICAgdmFyIHN0YXJ0U3ltYm9sTGVuZ3RoID0gc3RhcnRTeW1ib2wubGVuZ3RoLAogICAgICAgIGVuZFN5bWJvbExlbmd0aCA9IGVuZFN5bWJvbC5sZW5ndGgsCiAgICAgICAgZXNjYXBlZFN0YXJ0UmVnZXhwID0gbmV3IFJlZ0V4cChzdGFydFN5bWJvbC5yZXBsYWNlKC8uL2csIGVzY2FwZSksICdnJyksCiAgICAgICAgZXNjYXBlZEVuZFJlZ2V4cCA9IG5ldyBSZWdFeHAoZW5kU3ltYm9sLnJlcGxhY2UoLy4vZywgZXNjYXBlKSwgJ2cnKTsKCiAgICBmdW5jdGlvbiBlc2NhcGUoY2gpIHsKICAgICAgcmV0dXJuICdcXFxcXFwnICsgY2g7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQG5hbWUgJGludGVycG9sYXRlCiAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICoKICAgICAqIEByZXF1aXJlcyAkcGFyc2UKICAgICAqIEByZXF1aXJlcyAkc2NlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQ29tcGlsZXMgYSBzdHJpbmcgd2l0aCBtYXJrdXAgaW50byBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLiBUaGlzIHNlcnZpY2UgaXMgdXNlZCBieSB0aGUKICAgICAqIEhUTUwge0BsaW5rIG5nLiRjb21waWxlICRjb21waWxlfSBzZXJ2aWNlIGZvciBkYXRhIGJpbmRpbmcuIFNlZQogICAgICoge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyICRpbnRlcnBvbGF0ZVByb3ZpZGVyfSBmb3IgY29uZmlndXJpbmcgdGhlCiAgICAgKiBpbnRlcnBvbGF0aW9uIG1hcmt1cC4KICAgICAqCiAgICAgKgogICAgICogYGBganMKICAgICAqICAgdmFyICRpbnRlcnBvbGF0ZSA9IC4uLjsgLy8gaW5qZWN0ZWQKICAgICAqICAgdmFyIGV4cCA9ICRpbnRlcnBvbGF0ZSgnSGVsbG8ge3tuYW1lIHwgdXBwZXJjYXNlfX0hJyk7CiAgICAgKiAgIGV4cGVjdChleHAoe25hbWU6J0FuZ3VsYXInfSkudG9FcXVhbCgnSGVsbG8gQU5HVUxBUiEnKTsKICAgICAqIGBgYAogICAgICoKICAgICAqIGAkaW50ZXJwb2xhdGVgIHRha2VzIGFuIG9wdGlvbmFsIGZvdXJ0aCBhcmd1bWVudCwgYGFsbE9yTm90aGluZ2AuIElmIGBhbGxPck5vdGhpbmdgIGlzCiAgICAgKiBgdHJ1ZWAsIHRoZSBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIGB1bmRlZmluZWRgIHVubGVzcyBhbGwgZW1iZWRkZWQgZXhwcmVzc2lvbnMKICAgICAqIGV2YWx1YXRlIHRvIGEgdmFsdWUgb3RoZXIgdGhhbiBgdW5kZWZpbmVkYC4KICAgICAqCiAgICAgKiBgYGBqcwogICAgICogICB2YXIgJGludGVycG9sYXRlID0gLi4uOyAvLyBpbmplY3RlZAogICAgICogICB2YXIgY29udGV4dCA9IHtncmVldGluZzogJ0hlbGxvJywgbmFtZTogdW5kZWZpbmVkIH07CiAgICAgKgogICAgICogICAvLyBkZWZhdWx0ICJmb3JnaXZpbmciIG1vZGUKICAgICAqICAgdmFyIGV4cCA9ICRpbnRlcnBvbGF0ZSgne3tncmVldGluZ319IHt7bmFtZX19IScpOwogICAgICogICBleHBlY3QoZXhwKGNvbnRleHQpKS50b0VxdWFsKCdIZWxsbyAhJyk7CiAgICAgKgogICAgICogICAvLyAiYWxsT3JOb3RoaW5nIiBtb2RlCiAgICAgKiAgIGV4cCA9ICRpbnRlcnBvbGF0ZSgne3tncmVldGluZ319IHt7bmFtZX19IScsIGZhbHNlLCBudWxsLCB0cnVlKTsKICAgICAqICAgZXhwZWN0KGV4cChjb250ZXh0KSkudG9CZVVuZGVmaW5lZCgpOwogICAgICogICBjb250ZXh0Lm5hbWUgPSAnQW5ndWxhcic7CiAgICAgKiAgIGV4cGVjdChleHAoY29udGV4dCkpLnRvRXF1YWwoJ0hlbGxvIEFuZ3VsYXIhJyk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBgYWxsT3JOb3RoaW5nYCBpcyB1c2VmdWwgZm9yIGludGVycG9sYXRpbmcgVVJMcy4gYG5nU3JjYCBhbmQgYG5nU3Jjc2V0YCB1c2UgdGhpcyBiZWhhdmlvci4KICAgICAqCiAgICAgKiAjIyMjRXNjYXBlZCBJbnRlcnBvbGF0aW9uCiAgICAgKiAkaW50ZXJwb2xhdGUgcHJvdmlkZXMgYSBtZWNoYW5pc20gZm9yIGVzY2FwaW5nIGludGVycG9sYXRpb24gbWFya2Vycy4gU3RhcnQgYW5kIGVuZCBtYXJrZXJzCiAgICAgKiBjYW4gYmUgZXNjYXBlZCBieSBwcmVjZWRpbmcgZWFjaCBvZiB0aGVpciBjaGFyYWN0ZXJzIHdpdGggYSBSRVZFUlNFIFNPTElEVVMgVSswMDVDIChiYWNrc2xhc2gpLgogICAgICogSXQgd2lsbCBiZSByZW5kZXJlZCBhcyBhIHJlZ3VsYXIgc3RhcnQvZW5kIG1hcmtlciwgYW5kIHdpbGwgbm90IGJlIGludGVycHJldGVkIGFzIGFuIGV4cHJlc3Npb24KICAgICAqIG9yIGJpbmRpbmcuCiAgICAgKgogICAgICogVGhpcyBlbmFibGVzIHdlYi1zZXJ2ZXJzIHRvIHByZXZlbnQgc2NyaXB0IGluamVjdGlvbiBhdHRhY2tzIGFuZCBkZWZhY2luZyBhdHRhY2tzLCB0byBzb21lCiAgICAgKiBkZWdyZWUsIHdoaWxlIGFsc28gZW5hYmxpbmcgY29kZSBleGFtcGxlcyB0byB3b3JrIHdpdGhvdXQgcmVseWluZyBvbiB0aGUKICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdOb25CaW5kYWJsZSBuZ05vbkJpbmRhYmxlfSBkaXJlY3RpdmUuCiAgICAgKgogICAgICogKipGb3Igc2VjdXJpdHkgcHVycG9zZXMsIGl0IGlzIHN0cm9uZ2x5IGVuY291cmFnZWQgdGhhdCB3ZWIgc2VydmVycyBlc2NhcGUgdXNlci1zdXBwbGllZCBkYXRhLAogICAgICogcmVwbGFjaW5nIGFuZ2xlIGJyYWNrZXRzICgmbHQ7LCAmZ3Q7KSB3aXRoICZhbXA7bHQ7IGFuZCAmYW1wO2d0OyByZXNwZWN0aXZlbHksIGFuZCByZXBsYWNpbmcgYWxsCiAgICAgKiBpbnRlcnBvbGF0aW9uIHN0YXJ0L2VuZCBtYXJrZXJzIHdpdGggdGhlaXIgZXNjYXBlZCBjb3VudGVycGFydHMuKioKICAgICAqCiAgICAgKiBFc2NhcGVkIGludGVycG9sYXRpb24gbWFya2VycyBhcmUgb25seSByZXBsYWNlZCB3aXRoIHRoZSBhY3R1YWwgaW50ZXJwb2xhdGlvbiBtYXJrZXJzIGluIHJlbmRlcmVkCiAgICAgKiBvdXRwdXQgd2hlbiB0aGUgJGludGVycG9sYXRlIHNlcnZpY2UgcHJvY2Vzc2VzIHRoZSB0ZXh0LiBTbywgZm9yIEhUTUwgZWxlbWVudHMgaW50ZXJwb2xhdGVkCiAgICAgKiBieSB7QGxpbmsgbmcuJGNvbXBpbGUgJGNvbXBpbGV9LCBvciBvdGhlcndpc2UgaW50ZXJwb2xhdGVkIHdpdGggdGhlIGBtdXN0SGF2ZUV4cHJlc3Npb25gIHBhcmFtZXRlcgogICAgICogc2V0IHRvIGB0cnVlYCwgdGhlIGludGVycG9sYXRlZCB0ZXh0IG11c3QgY29udGFpbiBhbiB1bmVzY2FwZWQgaW50ZXJwb2xhdGlvbiBleHByZXNzaW9uLiBBcyBzdWNoLAogICAgICogdGhpcyBpcyB0eXBpY2FsbHkgdXNlZnVsIG9ubHkgd2hlbiB1c2VyLWRhdGEgaXMgdXNlZCBpbiByZW5kZXJpbmcgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBzZXJ2ZXIsIG9yCiAgICAgKiB3aGVuIG90aGVyd2lzZSB1bnRydXN0ZWQgZGF0YSBpcyB1c2VkIGJ5IGEgZGlyZWN0aXZlLgogICAgICoKICAgICAqIDxleGFtcGxlPgogICAgICogIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICogICAgPGRpdiBuZy1pbml0PSJ1c2VybmFtZT0nQSB1c2VyJyI+CiAgICAgKiAgICAgIDxwIG5nLWluaXQ9ImFwcHRpdGxlPSdFc2NhcGluZyBkZW1vJyI+e3thcHB0aXRsZX19OiBce1x7IHVzZXJuYW1lID0gImRlZmFjZWQgdmFsdWUiOyBcfVx9CiAgICAgKiAgICAgICAgPC9wPgogICAgICogICAgICA8cD48c3Ryb25nPnt7dXNlcm5hbWV9fTwvc3Ryb25nPiBhdHRlbXB0cyB0byBpbmplY3QgY29kZSB3aGljaCB3aWxsIGRlZmFjZSB0aGUKICAgICAqICAgICAgICBhcHBsaWNhdGlvbiwgYnV0IGZhaWxzIHRvIGFjY29tcGxpc2ggdGhlaXIgdGFzaywgYmVjYXVzZSB0aGUgc2VydmVyIGhhcyBjb3JyZWN0bHkKICAgICAqICAgICAgICBlc2NhcGVkIHRoZSBpbnRlcnBvbGF0aW9uIHN0YXJ0L2VuZCBtYXJrZXJzIHdpdGggUkVWRVJTRSBTT0xJRFVTIFUrMDA1QyAoYmFja3NsYXNoKQogICAgICogICAgICAgIGNoYXJhY3RlcnMuPC9wPgogICAgICogICAgICA8cD5JbnN0ZWFkLCB0aGUgcmVzdWx0IG9mIHRoZSBhdHRlbXB0ZWQgc2NyaXB0IGluamVjdGlvbiBpcyB2aXNpYmxlLCBhbmQgY2FuIGJlIHJlbW92ZWQKICAgICAqICAgICAgICBmcm9tIHRoZSBkYXRhYmFzZSBieSBhbiBhZG1pbmlzdHJhdG9yLjwvcD4KICAgICAqICAgIDwvZGl2PgogICAgICogIDwvZmlsZT4KICAgICAqIDwvZXhhbXBsZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBUaGUgdGV4dCB3aXRoIG1hcmt1cCB0byBpbnRlcnBvbGF0ZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IG11c3RIYXZlRXhwcmVzc2lvbiBpZiBzZXQgdG8gdHJ1ZSB0aGVuIHRoZSBpbnRlcnBvbGF0aW9uIHN0cmluZyBtdXN0IGhhdmUKICAgICAqICAgIGVtYmVkZGVkIGV4cHJlc3Npb24gaW4gb3JkZXIgdG8gcmV0dXJuIGFuIGludGVycG9sYXRpb24gZnVuY3Rpb24uIFN0cmluZ3Mgd2l0aCBubwogICAgICogICAgZW1iZWRkZWQgZXhwcmVzc2lvbiB3aWxsIHJldHVybiBudWxsIGZvciB0aGUgaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdHJ1c3RlZENvbnRleHQgd2hlbiBwcm92aWRlZCwgdGhlIHJldHVybmVkIGZ1bmN0aW9uIHBhc3NlcyB0aGUgaW50ZXJwb2xhdGVkCiAgICAgKiAgICByZXN1bHQgdGhyb3VnaCB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkICRzY2UuZ2V0VHJ1c3RlZChpbnRlcnBvbGF0ZWRSZXN1bHQsCiAgICAgKiAgICB0cnVzdGVkQ29udGV4dCl9IGJlZm9yZSByZXR1cm5pbmcgaXQuICBSZWZlciB0byB0aGUge0BsaW5rIG5nLiRzY2UgJHNjZX0gc2VydmljZSB0aGF0CiAgICAgKiAgICBwcm92aWRlcyBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyBmb3IgZGV0YWlscy4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IGFsbE9yTm90aGluZyBpZiBgdHJ1ZWAsIHRoZW4gdGhlIHJldHVybmVkIGZ1bmN0aW9uIHJldHVybnMgdW5kZWZpbmVkCiAgICAgKiAgICB1bmxlc3MgYWxsIGVtYmVkZGVkIGV4cHJlc3Npb25zIGV2YWx1YXRlIHRvIGEgdmFsdWUgb3RoZXIgdGhhbiBgdW5kZWZpbmVkYC4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0KX0gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbiB3aGljaCBpcyB1c2VkIHRvIGNvbXB1dGUgdGhlCiAgICAgKiAgICBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBUaGUgZnVuY3Rpb24gaGFzIHRoZXNlIHBhcmFtZXRlcnM6CiAgICAgKgogICAgICogLSBgY29udGV4dGA6IGV2YWx1YXRpb24gY29udGV4dCBmb3IgYWxsIGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBpbnRlcnBvbGF0ZWQgdGV4dAogICAgICovCiAgICBmdW5jdGlvbiAkaW50ZXJwb2xhdGUodGV4dCwgbXVzdEhhdmVFeHByZXNzaW9uLCB0cnVzdGVkQ29udGV4dCwgYWxsT3JOb3RoaW5nKSB7CiAgICAgIGFsbE9yTm90aGluZyA9ICEhYWxsT3JOb3RoaW5nOwogICAgICB2YXIgc3RhcnRJbmRleCwKICAgICAgICAgIGVuZEluZGV4LAogICAgICAgICAgaW5kZXggPSAwLAogICAgICAgICAgZXhwcmVzc2lvbnMgPSBbXSwKICAgICAgICAgIHBhcnNlRm5zID0gW10sCiAgICAgICAgICB0ZXh0TGVuZ3RoID0gdGV4dC5sZW5ndGgsCiAgICAgICAgICBleHAsCiAgICAgICAgICBjb25jYXQgPSBbXSwKICAgICAgICAgIGV4cHJlc3Npb25Qb3NpdGlvbnMgPSBbXTsKCiAgICAgIHdoaWxlKGluZGV4IDwgdGV4dExlbmd0aCkgewogICAgICAgIGlmICggKChzdGFydEluZGV4ID0gdGV4dC5pbmRleE9mKHN0YXJ0U3ltYm9sLCBpbmRleCkpICE9IC0xKSAmJgogICAgICAgICAgICAgKChlbmRJbmRleCA9IHRleHQuaW5kZXhPZihlbmRTeW1ib2wsIHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCkpICE9IC0xKSApIHsKICAgICAgICAgIGlmIChpbmRleCAhPT0gc3RhcnRJbmRleCkgewogICAgICAgICAgICBjb25jYXQucHVzaCh1bmVzY2FwZVRleHQodGV4dC5zdWJzdHJpbmcoaW5kZXgsIHN0YXJ0SW5kZXgpKSk7CiAgICAgICAgICB9CiAgICAgICAgICBleHAgPSB0ZXh0LnN1YnN0cmluZyhzdGFydEluZGV4ICsgc3RhcnRTeW1ib2xMZW5ndGgsIGVuZEluZGV4KTsKICAgICAgICAgIGV4cHJlc3Npb25zLnB1c2goZXhwKTsKICAgICAgICAgIHBhcnNlRm5zLnB1c2goJHBhcnNlKGV4cCwgcGFyc2VTdHJpbmdpZnlJbnRlcmNlcHRvcikpOwogICAgICAgICAgaW5kZXggPSBlbmRJbmRleCArIGVuZFN5bWJvbExlbmd0aDsKICAgICAgICAgIGV4cHJlc3Npb25Qb3NpdGlvbnMucHVzaChjb25jYXQubGVuZ3RoKTsKICAgICAgICAgIGNvbmNhdC5wdXNoKCcnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gd2UgZGlkIG5vdCBmaW5kIGFuIGludGVycG9sYXRpb24sIHNvIHdlIGhhdmUgdG8gYWRkIHRoZSByZW1haW5kZXIgdG8gdGhlIHNlcGFyYXRvcnMgYXJyYXkKICAgICAgICAgIGlmIChpbmRleCAhPT0gdGV4dExlbmd0aCkgewogICAgICAgICAgICBjb25jYXQucHVzaCh1bmVzY2FwZVRleHQodGV4dC5zdWJzdHJpbmcoaW5kZXgpKSk7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIENvbmNhdGVuYXRpbmcgZXhwcmVzc2lvbnMgbWFrZXMgaXQgaGFyZCB0byByZWFzb24gYWJvdXQgd2hldGhlciBzb21lIGNvbWJpbmF0aW9uIG9mCiAgICAgIC8vIGNvbmNhdGVuYXRlZCB2YWx1ZXMgYXJlIHVuc2FmZSB0byB1c2UgYW5kIGNvdWxkIGVhc2lseSBsZWFkIHRvIFhTUy4gIEJ5IHJlcXVpcmluZyB0aGF0IGEKICAgICAgLy8gc2luZ2xlIGV4cHJlc3Npb24gYmUgdXNlZCBmb3IgaWZyYW1lW3NyY10sIG9iamVjdFtzcmNdLCBldGMuLCB3ZSBlbnN1cmUgdGhhdCB0aGUgdmFsdWUKICAgICAgLy8gdGhhdCdzIHVzZWQgaXMgYXNzaWduZWQgb3IgY29uc3RydWN0ZWQgYnkgc29tZSBKUyBjb2RlIHNvbWV3aGVyZSB0aGF0IGlzIG1vcmUgdGVzdGFibGUgb3IKICAgICAgLy8gbWFrZSBpdCBvYnZpb3VzIHRoYXQgeW91IGJvdW5kIHRoZSB2YWx1ZSB0byBzb21lIHVzZXIgY29udHJvbGxlZCB2YWx1ZS4gIFRoaXMgaGVscHMgcmVkdWNlCiAgICAgIC8vIHRoZSBsb2FkIHdoZW4gYXVkaXRpbmcgZm9yIFhTUyBpc3N1ZXMuCiAgICAgIGlmICh0cnVzdGVkQ29udGV4dCAmJiBjb25jYXQubGVuZ3RoID4gMSkgewogICAgICAgICAgdGhyb3cgJGludGVycG9sYXRlTWluRXJyKCdub2NvbmNhdCcsCiAgICAgICAgICAgICAgIkVycm9yIHdoaWxlIGludGVycG9sYXRpbmc6IHswfVxuU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgZGlzYWxsb3dzICIgKwogICAgICAgICAgICAgICJpbnRlcnBvbGF0aW9ucyB0aGF0IGNvbmNhdGVuYXRlIG11bHRpcGxlIGV4cHJlc3Npb25zIHdoZW4gYSB0cnVzdGVkIHZhbHVlIGlzICIgKwogICAgICAgICAgICAgICJyZXF1aXJlZC4gIFNlZSBodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy4kc2NlIiwgdGV4dCk7CiAgICAgIH0KCiAgICAgIGlmICghbXVzdEhhdmVFeHByZXNzaW9uIHx8IGV4cHJlc3Npb25zLmxlbmd0aCkgewogICAgICAgIHZhciBjb21wdXRlID0gZnVuY3Rpb24odmFsdWVzKSB7CiAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpaSA9IGV4cHJlc3Npb25zLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgaWYgKGFsbE9yTm90aGluZyAmJiBpc1VuZGVmaW5lZCh2YWx1ZXNbaV0pKSByZXR1cm47CiAgICAgICAgICAgIGNvbmNhdFtleHByZXNzaW9uUG9zaXRpb25zW2ldXSA9IHZhbHVlc1tpXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25jYXQuam9pbignJyk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIGdldFZhbHVlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdHJ1c3RlZENvbnRleHQgPwogICAgICAgICAgICAkc2NlLmdldFRydXN0ZWQodHJ1c3RlZENvbnRleHQsIHZhbHVlKSA6CiAgICAgICAgICAgICRzY2UudmFsdWVPZih2YWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIHN0cmluZ2lmeSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsgLy8gbnVsbCB8fCB1bmRlZmluZWQKICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzoKICAgICAgICAgICAgICB2YWx1ZSA9ICcnICsgdmFsdWU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdmFsdWUgPSB0b0pzb24odmFsdWUpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uIGludGVycG9sYXRpb25Gbihjb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgdmFyIGlpID0gZXhwcmVzc2lvbnMubGVuZ3RoOwogICAgICAgICAgICB2YXIgdmFsdWVzID0gbmV3IEFycmF5KGlpKTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgZm9yICg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YWx1ZXNbaV0gPSBwYXJzZUZuc1tpXShjb250ZXh0KTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBjb21wdXRlKHZhbHVlcyk7CiAgICAgICAgICAgIH0gY2F0Y2goZXJyKSB7CiAgICAgICAgICAgICAgdmFyIG5ld0VyciA9ICRpbnRlcnBvbGF0ZU1pbkVycignaW50ZXJyJywgIkNhbid0IGludGVycG9sYXRlOiB7MH1cbnsxfSIsIHRleHQsCiAgICAgICAgICAgICAgICAgIGVyci50b1N0cmluZygpKTsKICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihuZXdFcnIpOwogICAgICAgICAgICB9CgogICAgICAgICAgfSwgewogICAgICAgICAgLy8gYWxsIG9mIHRoZXNlIHByb3BlcnRpZXMgYXJlIHVuZG9jdW1lbnRlZCBmb3Igbm93CiAgICAgICAgICBleHA6IHRleHQsIC8vanVzdCBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIHJlZ3VsYXIgd2F0Y2hlcnMgY3JlYXRlZCB2aWEgJHdhdGNoCiAgICAgICAgICBleHByZXNzaW9uczogZXhwcmVzc2lvbnMsCiAgICAgICAgICAkJHdhdGNoRGVsZWdhdGU6IGZ1bmN0aW9uIChzY29wZSwgbGlzdGVuZXIsIG9iamVjdEVxdWFsaXR5KSB7CiAgICAgICAgICAgIHZhciBsYXN0VmFsdWU7CiAgICAgICAgICAgIHJldHVybiBzY29wZS4kd2F0Y2hHcm91cChwYXJzZUZucywgZnVuY3Rpb24gaW50ZXJwb2xhdGVGbldhdGNoZXIodmFsdWVzLCBvbGRWYWx1ZXMpIHsKICAgICAgICAgICAgICB2YXIgY3VyclZhbHVlID0gY29tcHV0ZSh2YWx1ZXMpOwogICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGxpc3RlbmVyKSkgewogICAgICAgICAgICAgICAgbGlzdGVuZXIuY2FsbCh0aGlzLCBjdXJyVmFsdWUsIHZhbHVlcyAhPT0gb2xkVmFsdWVzID8gbGFzdFZhbHVlIDogY3VyclZhbHVlLCBzY29wZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IGN1cnJWYWx1ZTsKICAgICAgICAgICAgfSwgb2JqZWN0RXF1YWxpdHkpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiB1bmVzY2FwZVRleHQodGV4dCkgewogICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UoZXNjYXBlZFN0YXJ0UmVnZXhwLCBzdGFydFN5bWJvbCkuCiAgICAgICAgICByZXBsYWNlKGVzY2FwZWRFbmRSZWdleHAsIGVuZFN5bWJvbCk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHBhcnNlU3RyaW5naWZ5SW50ZXJjZXB0b3IodmFsdWUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIHN0cmluZ2lmeShnZXRWYWx1ZSh2YWx1ZSkpOwogICAgICAgIH0gY2F0Y2goZXJyKSB7CiAgICAgICAgICB2YXIgbmV3RXJyID0gJGludGVycG9sYXRlTWluRXJyKCdpbnRlcnInLCAiQ2FuJ3QgaW50ZXJwb2xhdGU6IHswfVxuezF9IiwgdGV4dCwKICAgICAgICAgICAgZXJyLnRvU3RyaW5nKCkpOwogICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIobmV3RXJyKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW50ZXJwb2xhdGUjc3RhcnRTeW1ib2wKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgc3RhcnQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYHt7YC4KICAgICAqCiAgICAgKiBVc2Uge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sIGAkaW50ZXJwb2xhdGVQcm92aWRlci5zdGFydFN5bWJvbGB9IHRvIGNoYW5nZQogICAgICogdGhlIHN5bWJvbC4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBzdGFydCBzeW1ib2wuCiAgICAgKi8KICAgICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc3RhcnRTeW1ib2w7CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpbnRlcnBvbGF0ZSNlbmRTeW1ib2wKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgZW5kIG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB9fWAuCiAgICAgKgogICAgICogVXNlIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2wgYCRpbnRlcnBvbGF0ZVByb3ZpZGVyLmVuZFN5bWJvbGB9IHRvIGNoYW5nZQogICAgICogdGhlIHN5bWJvbC4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBlbmQgc3ltYm9sLgogICAgICovCiAgICAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBlbmRTeW1ib2w7CiAgICB9OwoKICAgIHJldHVybiAkaW50ZXJwb2xhdGU7CiAgfV07Cn0KCmZ1bmN0aW9uICRJbnRlcnZhbFByb3ZpZGVyKCkgewogIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckd2luZG93JywgJyRxJywgJyQkcScsCiAgICAgICBmdW5jdGlvbigkcm9vdFNjb3BlLCAgICR3aW5kb3csICAgJHEsICAgJCRxKSB7CiAgICB2YXIgaW50ZXJ2YWxzID0ge307CgoKICAgICAvKioKICAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICAqIEBuYW1lICRpbnRlcnZhbAogICAgICAqCiAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICogQW5ndWxhcidzIHdyYXBwZXIgZm9yIGB3aW5kb3cuc2V0SW50ZXJ2YWxgLiBUaGUgYGZuYCBmdW5jdGlvbiBpcyBleGVjdXRlZCBldmVyeSBgZGVsYXlgCiAgICAgICogbWlsbGlzZWNvbmRzLgogICAgICAqCiAgICAgICogVGhlIHJldHVybiB2YWx1ZSBvZiByZWdpc3RlcmluZyBhbiBpbnRlcnZhbCBmdW5jdGlvbiBpcyBhIHByb21pc2UuIFRoaXMgcHJvbWlzZSB3aWxsIGJlCiAgICAgICogbm90aWZpZWQgdXBvbiBlYWNoIHRpY2sgb2YgdGhlIGludGVydmFsLCBhbmQgd2lsbCBiZSByZXNvbHZlZCBhZnRlciBgY291bnRgIGl0ZXJhdGlvbnMsIG9yCiAgICAgICogcnVuIGluZGVmaW5pdGVseSBpZiBgY291bnRgIGlzIG5vdCBkZWZpbmVkLiBUaGUgdmFsdWUgb2YgdGhlIG5vdGlmaWNhdGlvbiB3aWxsIGJlIHRoZQogICAgICAqIG51bWJlciBvZiBpdGVyYXRpb25zIHRoYXQgaGF2ZSBydW4uCiAgICAgICogVG8gY2FuY2VsIGFuIGludGVydmFsLCBjYWxsIGAkaW50ZXJ2YWwuY2FuY2VsKHByb21pc2UpYC4KICAgICAgKgogICAgICAqIEluIHRlc3RzIHlvdSBjYW4gdXNlIHtAbGluayBuZ01vY2suJGludGVydmFsI2ZsdXNoIGAkaW50ZXJ2YWwuZmx1c2gobWlsbGlzKWB9IHRvCiAgICAgICogbW92ZSBmb3J3YXJkIGJ5IGBtaWxsaXNgIG1pbGxpc2Vjb25kcyBhbmQgdHJpZ2dlciBhbnkgZnVuY3Rpb25zIHNjaGVkdWxlZCB0byBydW4gaW4gdGhhdAogICAgICAqIHRpbWUuCiAgICAgICoKICAgICAgKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICAgICAgKiAqKk5vdGUqKjogSW50ZXJ2YWxzIGNyZWF0ZWQgYnkgdGhpcyBzZXJ2aWNlIG11c3QgYmUgZXhwbGljaXRseSBkZXN0cm95ZWQgd2hlbiB5b3UgYXJlIGZpbmlzaGVkCiAgICAgICogd2l0aCB0aGVtLiAgSW4gcGFydGljdWxhciB0aGV5IGFyZSBub3QgYXV0b21hdGljYWxseSBkZXN0cm95ZWQgd2hlbiBhIGNvbnRyb2xsZXIncyBzY29wZSBvciBhCiAgICAgICogZGlyZWN0aXZlJ3MgZWxlbWVudCBhcmUgZGVzdHJveWVkLgogICAgICAqIFlvdSBzaG91bGQgdGFrZSB0aGlzIGludG8gY29uc2lkZXJhdGlvbiBhbmQgbWFrZSBzdXJlIHRvIGFsd2F5cyBjYW5jZWwgdGhlIGludGVydmFsIGF0IHRoZQogICAgICAqIGFwcHJvcHJpYXRlIG1vbWVudC4gIFNlZSB0aGUgZXhhbXBsZSBiZWxvdyBmb3IgbW9yZSBkZXRhaWxzIG9uIGhvdyBhbmQgd2hlbiB0byBkbyB0aGlzLgogICAgICAqIDwvZGl2PgogICAgICAqCiAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBBIGZ1bmN0aW9uIHRoYXQgc2hvdWxkIGJlIGNhbGxlZCByZXBlYXRlZGx5LgogICAgICAqIEBwYXJhbSB7bnVtYmVyfSBkZWxheSBOdW1iZXIgb2YgbWlsbGlzZWNvbmRzIGJldHdlZW4gZWFjaCBmdW5jdGlvbiBjYWxsLgogICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gW2NvdW50PTBdIE51bWJlciBvZiB0aW1lcyB0byByZXBlYXQuIElmIG5vdCBzZXQsIG9yIDAsIHdpbGwgcmVwZWF0CiAgICAgICogICBpbmRlZmluaXRlbHkuCiAgICAgICogQHBhcmFtIHtib29sZWFuPX0gW2ludm9rZUFwcGx5PXRydWVdIElmIHNldCB0byBgZmFsc2VgIHNraXBzIG1vZGVsIGRpcnR5IGNoZWNraW5nLCBvdGhlcndpc2UKICAgICAgKiAgIHdpbGwgaW52b2tlIGBmbmAgd2l0aGluIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkYXBwbHkgJGFwcGx5fSBibG9jay4KICAgICAgKiBAcmV0dXJucyB7cHJvbWlzZX0gQSBwcm9taXNlIHdoaWNoIHdpbGwgYmUgbm90aWZpZWQgb24gZWFjaCBpdGVyYXRpb24uCiAgICAgICoKICAgICAgKiBAZXhhbXBsZQogICAgICAqIDxleGFtcGxlIG1vZHVsZT0iaW50ZXJ2YWxFeGFtcGxlIj4KICAgICAgKiA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgKiAgIDxzY3JpcHQ+CiAgICAgICogICAgIGFuZ3VsYXIubW9kdWxlKCdpbnRlcnZhbEV4YW1wbGUnLCBbXSkKICAgICAgKiAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsICckaW50ZXJ2YWwnLAogICAgICAqICAgICAgICAgZnVuY3Rpb24oJHNjb3BlLCAkaW50ZXJ2YWwpIHsKICAgICAgKiAgICAgICAgICAgJHNjb3BlLmZvcm1hdCA9ICdNL2QveXkgaDptbTpzcyBhJzsKICAgICAgKiAgICAgICAgICAgJHNjb3BlLmJsb29kXzEgPSAxMDA7CiAgICAgICogICAgICAgICAgICRzY29wZS5ibG9vZF8yID0gMTIwOwogICAgICAqCiAgICAgICogICAgICAgICAgIHZhciBzdG9wOwogICAgICAqICAgICAgICAgICAkc2NvcGUuZmlnaHQgPSBmdW5jdGlvbigpIHsKICAgICAgKiAgICAgICAgICAgICAvLyBEb24ndCBzdGFydCBhIG5ldyBmaWdodCBpZiB3ZSBhcmUgYWxyZWFkeSBmaWdodGluZwogICAgICAqICAgICAgICAgICAgIGlmICggYW5ndWxhci5pc0RlZmluZWQoc3RvcCkgKSByZXR1cm47CiAgICAgICoKICAgICAgKiAgICAgICAgICAgc3RvcCA9ICRpbnRlcnZhbChmdW5jdGlvbigpIHsKICAgICAgKiAgICAgICAgICAgICBpZiAoJHNjb3BlLmJsb29kXzEgPiAwICYmICRzY29wZS5ibG9vZF8yID4gMCkgewogICAgICAqICAgICAgICAgICAgICAgJHNjb3BlLmJsb29kXzEgPSAkc2NvcGUuYmxvb2RfMSAtIDM7CiAgICAgICogICAgICAgICAgICAgICAkc2NvcGUuYmxvb2RfMiA9ICRzY29wZS5ibG9vZF8yIC0gNDsKICAgICAgKiAgICAgICAgICAgICB9IGVsc2UgewogICAgICAqICAgICAgICAgICAgICAgJHNjb3BlLnN0b3BGaWdodCgpOwogICAgICAqICAgICAgICAgICAgIH0KICAgICAgKiAgICAgICAgICAgfSwgMTAwKTsKICAgICAgKiAgICAgICAgIH07CiAgICAgICoKICAgICAgKiAgICAgICAgICRzY29wZS5zdG9wRmlnaHQgPSBmdW5jdGlvbigpIHsKICAgICAgKiAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKHN0b3ApKSB7CiAgICAgICogICAgICAgICAgICAgJGludGVydmFsLmNhbmNlbChzdG9wKTsKICAgICAgKiAgICAgICAgICAgICBzdG9wID0gdW5kZWZpbmVkOwogICAgICAqICAgICAgICAgICB9CiAgICAgICogICAgICAgICB9OwogICAgICAqCiAgICAgICogICAgICAgICAkc2NvcGUucmVzZXRGaWdodCA9IGZ1bmN0aW9uKCkgewogICAgICAqICAgICAgICAgICAkc2NvcGUuYmxvb2RfMSA9IDEwMDsKICAgICAgKiAgICAgICAgICAgJHNjb3BlLmJsb29kXzIgPSAxMjA7CiAgICAgICogICAgICAgICB9OwogICAgICAqCiAgICAgICogICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAqICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgaW50ZXJ2YWwgaXMgZGVzdHJveWVkIHRvbwogICAgICAqICAgICAgICAgICAkc2NvcGUuc3RvcEZpZ2h0KCk7CiAgICAgICogICAgICAgICB9KTsKICAgICAgKiAgICAgICB9XSkKICAgICAgKiAgICAgICAvLyBSZWdpc3RlciB0aGUgJ215Q3VycmVudFRpbWUnIGRpcmVjdGl2ZSBmYWN0b3J5IG1ldGhvZC4KICAgICAgKiAgICAgICAvLyBXZSBpbmplY3QgJGludGVydmFsIGFuZCBkYXRlRmlsdGVyIHNlcnZpY2Ugc2luY2UgdGhlIGZhY3RvcnkgbWV0aG9kIGlzIERJLgogICAgICAqICAgICAgIC5kaXJlY3RpdmUoJ215Q3VycmVudFRpbWUnLCBbJyRpbnRlcnZhbCcsICdkYXRlRmlsdGVyJywKICAgICAgKiAgICAgICAgIGZ1bmN0aW9uKCRpbnRlcnZhbCwgZGF0ZUZpbHRlcikgewogICAgICAqICAgICAgICAgICAvLyByZXR1cm4gdGhlIGRpcmVjdGl2ZSBsaW5rIGZ1bmN0aW9uLiAoY29tcGlsZSBmdW5jdGlvbiBub3QgbmVlZGVkKQogICAgICAqICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICogICAgICAgICAgICAgdmFyIGZvcm1hdCwgIC8vIGRhdGUgZm9ybWF0CiAgICAgICogICAgICAgICAgICAgICAgIHN0b3BUaW1lOyAvLyBzbyB0aGF0IHdlIGNhbiBjYW5jZWwgdGhlIHRpbWUgdXBkYXRlcwogICAgICAqCiAgICAgICogICAgICAgICAgICAgLy8gdXNlZCB0byB1cGRhdGUgdGhlIFVJCiAgICAgICogICAgICAgICAgICAgZnVuY3Rpb24gdXBkYXRlVGltZSgpIHsKICAgICAgKiAgICAgICAgICAgICAgIGVsZW1lbnQudGV4dChkYXRlRmlsdGVyKG5ldyBEYXRlKCksIGZvcm1hdCkpOwogICAgICAqICAgICAgICAgICAgIH0KICAgICAgKgogICAgICAqICAgICAgICAgICAgIC8vIHdhdGNoIHRoZSBleHByZXNzaW9uLCBhbmQgdXBkYXRlIHRoZSBVSSBvbiBjaGFuZ2UuCiAgICAgICogICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHJzLm15Q3VycmVudFRpbWUsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICogICAgICAgICAgICAgICBmb3JtYXQgPSB2YWx1ZTsKICAgICAgKiAgICAgICAgICAgICAgIHVwZGF0ZVRpbWUoKTsKICAgICAgKiAgICAgICAgICAgICB9KTsKICAgICAgKgogICAgICAqICAgICAgICAgICAgIHN0b3BUaW1lID0gJGludGVydmFsKHVwZGF0ZVRpbWUsIDEwMDApOwogICAgICAqCiAgICAgICogICAgICAgICAgICAgLy8gbGlzdGVuIG9uIERPTSBkZXN0cm95IChyZW1vdmFsKSBldmVudCwgYW5kIGNhbmNlbCB0aGUgbmV4dCBVSSB1cGRhdGUKICAgICAgKiAgICAgICAgICAgICAvLyB0byBwcmV2ZW50IHVwZGF0aW5nIHRpbWUgYWZ0ZXIgdGhlIERPTSBlbGVtZW50IHdhcyByZW1vdmVkLgogICAgICAqICAgICAgICAgICAgIGVsZW1lbnQub24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgICAgICAkaW50ZXJ2YWwuY2FuY2VsKHN0b3BUaW1lKTsKICAgICAgKiAgICAgICAgICAgICB9KTsKICAgICAgKiAgICAgICAgICAgfQogICAgICAqICAgICAgICAgfV0pOwogICAgICAqICAgPC9zY3JpcHQ+CiAgICAgICoKICAgICAgKiAgIDxkaXY+CiAgICAgICogICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAqICAgICAgIERhdGUgZm9ybWF0OiA8aW5wdXQgbmctbW9kZWw9ImZvcm1hdCI+IDxoci8+CiAgICAgICogICAgICAgQ3VycmVudCB0aW1lIGlzOiA8c3BhbiBteS1jdXJyZW50LXRpbWU9ImZvcm1hdCI+PC9zcGFuPgogICAgICAqICAgICAgIDxoci8+CiAgICAgICogICAgICAgQmxvb2QgMSA6IDxmb250IGNvbG9yPSdyZWQnPnt7Ymxvb2RfMX19PC9mb250PgogICAgICAqICAgICAgIEJsb29kIDIgOiA8Zm9udCBjb2xvcj0ncmVkJz57e2Jsb29kXzJ9fTwvZm9udD4KICAgICAgKiAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgZGF0YS1uZy1jbGljaz0iZmlnaHQoKSI+RmlnaHQ8L2J1dHRvbj4KICAgICAgKiAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgZGF0YS1uZy1jbGljaz0ic3RvcEZpZ2h0KCkiPlN0b3BGaWdodDwvYnV0dG9uPgogICAgICAqICAgICAgIDxidXR0b24gdHlwZT0iYnV0dG9uIiBkYXRhLW5nLWNsaWNrPSJyZXNldEZpZ2h0KCkiPnJlc2V0RmlnaHQ8L2J1dHRvbj4KICAgICAgKiAgICAgPC9kaXY+CiAgICAgICogICA8L2Rpdj4KICAgICAgKgogICAgICAqIDwvZmlsZT4KICAgICAgKiA8L2V4YW1wbGU+CiAgICAgICovCiAgICBmdW5jdGlvbiBpbnRlcnZhbChmbiwgZGVsYXksIGNvdW50LCBpbnZva2VBcHBseSkgewogICAgICB2YXIgc2V0SW50ZXJ2YWwgPSAkd2luZG93LnNldEludGVydmFsLAogICAgICAgICAgY2xlYXJJbnRlcnZhbCA9ICR3aW5kb3cuY2xlYXJJbnRlcnZhbCwKICAgICAgICAgIGl0ZXJhdGlvbiA9IDAsCiAgICAgICAgICBza2lwQXBwbHkgPSAoaXNEZWZpbmVkKGludm9rZUFwcGx5KSAmJiAhaW52b2tlQXBwbHkpLAogICAgICAgICAgZGVmZXJyZWQgPSAoc2tpcEFwcGx5ID8gJCRxIDogJHEpLmRlZmVyKCksCiAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZTsKCiAgICAgIGNvdW50ID0gaXNEZWZpbmVkKGNvdW50KSA/IGNvdW50IDogMDsKCiAgICAgIHByb21pc2UudGhlbihudWxsLCBudWxsLCBmbik7CgogICAgICBwcm9taXNlLiQkaW50ZXJ2YWxJZCA9IHNldEludGVydmFsKGZ1bmN0aW9uIHRpY2soKSB7CiAgICAgICAgZGVmZXJyZWQubm90aWZ5KGl0ZXJhdGlvbisrKTsKCiAgICAgICAgaWYgKGNvdW50ID4gMCAmJiBpdGVyYXRpb24gPj0gY291bnQpIHsKICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoaXRlcmF0aW9uKTsKICAgICAgICAgIGNsZWFySW50ZXJ2YWwocHJvbWlzZS4kJGludGVydmFsSWQpOwogICAgICAgICAgZGVsZXRlIGludGVydmFsc1twcm9taXNlLiQkaW50ZXJ2YWxJZF07CiAgICAgICAgfQoKICAgICAgICBpZiAoIXNraXBBcHBseSkgJHJvb3RTY29wZS4kYXBwbHkoKTsKCiAgICAgIH0sIGRlbGF5KTsKCiAgICAgIGludGVydmFsc1twcm9taXNlLiQkaW50ZXJ2YWxJZF0gPSBkZWZlcnJlZDsKCiAgICAgIHJldHVybiBwcm9taXNlOwogICAgfQoKCiAgICAgLyoqCiAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAqIEBuYW1lICRpbnRlcnZhbCNjYW5jZWwKICAgICAgKgogICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAqIENhbmNlbHMgYSB0YXNrIGFzc29jaWF0ZWQgd2l0aCB0aGUgYHByb21pc2VgLgogICAgICAqCiAgICAgICogQHBhcmFtIHtwcm9taXNlfSBwcm9taXNlIHJldHVybmVkIGJ5IHRoZSBgJGludGVydmFsYCBmdW5jdGlvbi4KICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHRhc2sgd2FzIHN1Y2Nlc3NmdWxseSBjYW5jZWxlZC4KICAgICAgKi8KICAgIGludGVydmFsLmNhbmNlbCA9IGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAgaWYgKHByb21pc2UgJiYgcHJvbWlzZS4kJGludGVydmFsSWQgaW4gaW50ZXJ2YWxzKSB7CiAgICAgICAgaW50ZXJ2YWxzW3Byb21pc2UuJCRpbnRlcnZhbElkXS5yZWplY3QoJ2NhbmNlbGVkJyk7CiAgICAgICAgJHdpbmRvdy5jbGVhckludGVydmFsKHByb21pc2UuJCRpbnRlcnZhbElkKTsKICAgICAgICBkZWxldGUgaW50ZXJ2YWxzW3Byb21pc2UuJCRpbnRlcnZhbElkXTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIHJldHVybiBpbnRlcnZhbDsKICB9XTsKfQoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRsb2NhbGUKICoKICogQGRlc2NyaXB0aW9uCiAqICRsb2NhbGUgc2VydmljZSBwcm92aWRlcyBsb2NhbGl6YXRpb24gcnVsZXMgZm9yIHZhcmlvdXMgQW5ndWxhciBjb21wb25lbnRzLiBBcyBvZiByaWdodCBub3cgdGhlCiAqIG9ubHkgcHVibGljIGFwaSBpczoKICoKICogKiBgaWRgIOKAkyBge3N0cmluZ31gIOKAkyBsb2NhbGUgaWQgZm9ybWF0dGVkIGFzIGBsYW5ndWFnZUlkLWNvdW50cnlJZGAgKGUuZy4gYGVuLXVzYCkKICovCmZ1bmN0aW9uICRMb2NhbGVQcm92aWRlcigpewogIHRoaXMuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgaWQ6ICdlbi11cycsCgogICAgICBOVU1CRVJfRk9STUFUUzogewogICAgICAgIERFQ0lNQUxfU0VQOiAnLicsCiAgICAgICAgR1JPVVBfU0VQOiAnLCcsCiAgICAgICAgUEFUVEVSTlM6IFsKICAgICAgICAgIHsgLy8gRGVjaW1hbCBQYXR0ZXJuCiAgICAgICAgICAgIG1pbkludDogMSwKICAgICAgICAgICAgbWluRnJhYzogMCwKICAgICAgICAgICAgbWF4RnJhYzogMywKICAgICAgICAgICAgcG9zUHJlOiAnJywKICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgbmVnUHJlOiAnLScsCiAgICAgICAgICAgIG5lZ1N1ZjogJycsCiAgICAgICAgICAgIGdTaXplOiAzLAogICAgICAgICAgICBsZ1NpemU6IDMKICAgICAgICAgIH0seyAvL0N1cnJlbmN5IFBhdHRlcm4KICAgICAgICAgICAgbWluSW50OiAxLAogICAgICAgICAgICBtaW5GcmFjOiAyLAogICAgICAgICAgICBtYXhGcmFjOiAyLAogICAgICAgICAgICBwb3NQcmU6ICdcdTAwQTQnLAogICAgICAgICAgICBwb3NTdWY6ICcnLAogICAgICAgICAgICBuZWdQcmU6ICcoXHUwMEE0JywKICAgICAgICAgICAgbmVnU3VmOiAnKScsCiAgICAgICAgICAgIGdTaXplOiAzLAogICAgICAgICAgICBsZ1NpemU6IDMKICAgICAgICAgIH0KICAgICAgICBdLAogICAgICAgIENVUlJFTkNZX1NZTTogJyQnCiAgICAgIH0sCgogICAgICBEQVRFVElNRV9GT1JNQVRTOiB7CiAgICAgICAgTU9OVEg6CiAgICAgICAgICAgICdKYW51YXJ5LEZlYnJ1YXJ5LE1hcmNoLEFwcmlsLE1heSxKdW5lLEp1bHksQXVndXN0LFNlcHRlbWJlcixPY3RvYmVyLE5vdmVtYmVyLERlY2VtYmVyJwogICAgICAgICAgICAuc3BsaXQoJywnKSwKICAgICAgICBTSE9SVE1PTlRIOiAgJ0phbixGZWIsTWFyLEFwcixNYXksSnVuLEp1bCxBdWcsU2VwLE9jdCxOb3YsRGVjJy5zcGxpdCgnLCcpLAogICAgICAgIERBWTogJ1N1bmRheSxNb25kYXksVHVlc2RheSxXZWRuZXNkYXksVGh1cnNkYXksRnJpZGF5LFNhdHVyZGF5Jy5zcGxpdCgnLCcpLAogICAgICAgIFNIT1JUREFZOiAnU3VuLE1vbixUdWUsV2VkLFRodSxGcmksU2F0Jy5zcGxpdCgnLCcpLAogICAgICAgIEFNUE1TOiBbJ0FNJywnUE0nXSwKICAgICAgICBtZWRpdW06ICdNTU0gZCwgeSBoOm1tOnNzIGEnLAogICAgICAgIHNob3J0OiAnTS9kL3l5IGg6bW0gYScsCiAgICAgICAgZnVsbERhdGU6ICdFRUVFLCBNTU1NIGQsIHknLAogICAgICAgIGxvbmdEYXRlOiAnTU1NTSBkLCB5JywKICAgICAgICBtZWRpdW1EYXRlOiAnTU1NIGQsIHknLAogICAgICAgIHNob3J0RGF0ZTogJ00vZC95eScsCiAgICAgICAgbWVkaXVtVGltZTogJ2g6bW06c3MgYScsCiAgICAgICAgc2hvcnRUaW1lOiAnaDptbSBhJwogICAgICB9LAoKICAgICAgcGx1cmFsQ2F0OiBmdW5jdGlvbihudW0pIHsKICAgICAgICBpZiAobnVtID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gJ29uZSc7CiAgICAgICAgfQogICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICB9CiAgICB9OwogIH07Cn0KCnZhciBQQVRIX01BVENIID0gL14oW15cPyNdKikoXD8oW14jXSopKT8oIyguKikpPyQvLAogICAgREVGQVVMVF9QT1JUUyA9IHsnaHR0cCc6IDgwLCAnaHR0cHMnOiA0NDMsICdmdHAnOiAyMX07CnZhciAkbG9jYXRpb25NaW5FcnIgPSBtaW5FcnIoJyRsb2NhdGlvbicpOwoKCi8qKgogKiBFbmNvZGUgcGF0aCB1c2luZyBlbmNvZGVVcmlTZWdtZW50LCBpZ25vcmluZyBmb3J3YXJkIHNsYXNoZXMKICoKICogQHBhcmFtIHtzdHJpbmd9IHBhdGggUGF0aCB0byBlbmNvZGUKICogQHJldHVybnMge3N0cmluZ30KICovCmZ1bmN0aW9uIGVuY29kZVBhdGgocGF0aCkgewogIHZhciBzZWdtZW50cyA9IHBhdGguc3BsaXQoJy8nKSwKICAgICAgaSA9IHNlZ21lbnRzLmxlbmd0aDsKCiAgd2hpbGUgKGktLSkgewogICAgc2VnbWVudHNbaV0gPSBlbmNvZGVVcmlTZWdtZW50KHNlZ21lbnRzW2ldKTsKICB9CgogIHJldHVybiBzZWdtZW50cy5qb2luKCcvJyk7Cn0KCmZ1bmN0aW9uIHBhcnNlQWJzb2x1dGVVcmwoYWJzb2x1dGVVcmwsIGxvY2F0aW9uT2JqLCBhcHBCYXNlKSB7CiAgdmFyIHBhcnNlZFVybCA9IHVybFJlc29sdmUoYWJzb2x1dGVVcmwsIGFwcEJhc2UpOwoKICBsb2NhdGlvbk9iai4kJHByb3RvY29sID0gcGFyc2VkVXJsLnByb3RvY29sOwogIGxvY2F0aW9uT2JqLiQkaG9zdCA9IHBhcnNlZFVybC5ob3N0bmFtZTsKICBsb2NhdGlvbk9iai4kJHBvcnQgPSBpbnQocGFyc2VkVXJsLnBvcnQpIHx8IERFRkFVTFRfUE9SVFNbcGFyc2VkVXJsLnByb3RvY29sXSB8fCBudWxsOwp9CgoKZnVuY3Rpb24gcGFyc2VBcHBVcmwocmVsYXRpdmVVcmwsIGxvY2F0aW9uT2JqLCBhcHBCYXNlKSB7CiAgdmFyIHByZWZpeGVkID0gKHJlbGF0aXZlVXJsLmNoYXJBdCgwKSAhPT0gJy8nKTsKICBpZiAocHJlZml4ZWQpIHsKICAgIHJlbGF0aXZlVXJsID0gJy8nICsgcmVsYXRpdmVVcmw7CiAgfQogIHZhciBtYXRjaCA9IHVybFJlc29sdmUocmVsYXRpdmVVcmwsIGFwcEJhc2UpOwogIGxvY2F0aW9uT2JqLiQkcGF0aCA9IGRlY29kZVVSSUNvbXBvbmVudChwcmVmaXhlZCAmJiBtYXRjaC5wYXRobmFtZS5jaGFyQXQoMCkgPT09ICcvJyA/CiAgICAgIG1hdGNoLnBhdGhuYW1lLnN1YnN0cmluZygxKSA6IG1hdGNoLnBhdGhuYW1lKTsKICBsb2NhdGlvbk9iai4kJHNlYXJjaCA9IHBhcnNlS2V5VmFsdWUobWF0Y2guc2VhcmNoKTsKICBsb2NhdGlvbk9iai4kJGhhc2ggPSBkZWNvZGVVUklDb21wb25lbnQobWF0Y2guaGFzaCk7CgogIC8vIG1ha2Ugc3VyZSBwYXRoIHN0YXJ0cyB3aXRoICcvJzsKICBpZiAobG9jYXRpb25PYmouJCRwYXRoICYmIGxvY2F0aW9uT2JqLiQkcGF0aC5jaGFyQXQoMCkgIT0gJy8nKSB7CiAgICBsb2NhdGlvbk9iai4kJHBhdGggPSAnLycgKyBsb2NhdGlvbk9iai4kJHBhdGg7CiAgfQp9CgoKLyoqCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBiZWdpbgogKiBAcGFyYW0ge3N0cmluZ30gd2hvbGUKICogQHJldHVybnMge3N0cmluZ30gcmV0dXJucyB0ZXh0IGZyb20gd2hvbGUgYWZ0ZXIgYmVnaW4gb3IgdW5kZWZpbmVkIGlmIGl0IGRvZXMgbm90IGJlZ2luIHdpdGgKICogICAgICAgICAgICAgICAgICAgZXhwZWN0ZWQgc3RyaW5nLgogKi8KZnVuY3Rpb24gYmVnaW5zV2l0aChiZWdpbiwgd2hvbGUpIHsKICBpZiAod2hvbGUuaW5kZXhPZihiZWdpbikgPT09IDApIHsKICAgIHJldHVybiB3aG9sZS5zdWJzdHIoYmVnaW4ubGVuZ3RoKTsKICB9Cn0KCgpmdW5jdGlvbiBzdHJpcEhhc2godXJsKSB7CiAgdmFyIGluZGV4ID0gdXJsLmluZGV4T2YoJyMnKTsKICByZXR1cm4gaW5kZXggPT0gLTEgPyB1cmwgOiB1cmwuc3Vic3RyKDAsIGluZGV4KTsKfQoKCmZ1bmN0aW9uIHN0cmlwRmlsZSh1cmwpIHsKICByZXR1cm4gdXJsLnN1YnN0cigwLCBzdHJpcEhhc2godXJsKS5sYXN0SW5kZXhPZignLycpICsgMSk7Cn0KCi8qIHJldHVybiB0aGUgc2VydmVyIG9ubHkgKHNjaGVtZTovL2hvc3Q6cG9ydCkgKi8KZnVuY3Rpb24gc2VydmVyQmFzZSh1cmwpIHsKICByZXR1cm4gdXJsLnN1YnN0cmluZygwLCB1cmwuaW5kZXhPZignLycsIHVybC5pbmRleE9mKCcvLycpICsgMikpOwp9CgoKLyoqCiAqIExvY2F0aW9uSHRtbDVVcmwgcmVwcmVzZW50cyBhbiB1cmwKICogVGhpcyBvYmplY3QgaXMgZXhwb3NlZCBhcyAkbG9jYXRpb24gc2VydmljZSB3aGVuIEhUTUw1IG1vZGUgaXMgZW5hYmxlZCBhbmQgc3VwcG9ydGVkCiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge3N0cmluZ30gYXBwQmFzZSBhcHBsaWNhdGlvbiBiYXNlIFVSTAogKiBAcGFyYW0ge3N0cmluZ30gYmFzZVByZWZpeCB1cmwgcGF0aCBwcmVmaXgKICovCmZ1bmN0aW9uIExvY2F0aW9uSHRtbDVVcmwoYXBwQmFzZSwgYmFzZVByZWZpeCkgewogIHRoaXMuJCRodG1sNSA9IHRydWU7CiAgYmFzZVByZWZpeCA9IGJhc2VQcmVmaXggfHwgJyc7CiAgdmFyIGFwcEJhc2VOb0ZpbGUgPSBzdHJpcEZpbGUoYXBwQmFzZSk7CiAgcGFyc2VBYnNvbHV0ZVVybChhcHBCYXNlLCB0aGlzLCBhcHBCYXNlKTsKCgogIC8qKgogICAqIFBhcnNlIGdpdmVuIGh0bWw1IChyZWd1bGFyKSB1cmwgc3RyaW5nIGludG8gcHJvcGVydGllcwogICAqIEBwYXJhbSB7c3RyaW5nfSBuZXdBYnNvbHV0ZVVybCBIVE1MNSB1cmwKICAgKiBAcHJpdmF0ZQogICAqLwogIHRoaXMuJCRwYXJzZSA9IGZ1bmN0aW9uKHVybCkgewogICAgdmFyIHBhdGhVcmwgPSBiZWdpbnNXaXRoKGFwcEJhc2VOb0ZpbGUsIHVybCk7CiAgICBpZiAoIWlzU3RyaW5nKHBhdGhVcmwpKSB7CiAgICAgIHRocm93ICRsb2NhdGlvbk1pbkVycignaXB0aHByZngnLCAnSW52YWxpZCB1cmwgInswfSIsIG1pc3NpbmcgcGF0aCBwcmVmaXggInsxfSIuJywgdXJsLAogICAgICAgICAgYXBwQmFzZU5vRmlsZSk7CiAgICB9CgogICAgcGFyc2VBcHBVcmwocGF0aFVybCwgdGhpcywgYXBwQmFzZSk7CgogICAgaWYgKCF0aGlzLiQkcGF0aCkgewogICAgICB0aGlzLiQkcGF0aCA9ICcvJzsKICAgIH0KCiAgICB0aGlzLiQkY29tcG9zZSgpOwogIH07CgogIC8qKgogICAqIENvbXBvc2UgdXJsIGFuZCB1cGRhdGUgYGFic1VybGAgcHJvcGVydHkKICAgKiBAcHJpdmF0ZQogICAqLwogIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VhcmNoID0gdG9LZXlWYWx1ZSh0aGlzLiQkc2VhcmNoKSwKICAgICAgICBoYXNoID0gdGhpcy4kJGhhc2ggPyAnIycgKyBlbmNvZGVVcmlTZWdtZW50KHRoaXMuJCRoYXNoKSA6ICcnOwoKICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgdGhpcy4kJGFic1VybCA9IGFwcEJhc2VOb0ZpbGUgKyB0aGlzLiQkdXJsLnN1YnN0cigxKTsgLy8gZmlyc3QgY2hhciBpcyBhbHdheXMgJy8nCiAgfTsKCiAgdGhpcy4kJHBhcnNlTGlua1VybCA9IGZ1bmN0aW9uKHVybCwgcmVsSHJlZikgewogICAgaWYgKHJlbEhyZWYgJiYgcmVsSHJlZlswXSA9PT0gJyMnKSB7CiAgICAgIC8vIHNwZWNpYWwgY2FzZSBmb3IgbGlua3MgdG8gaGFzaCBmcmFnbWVudHM6CiAgICAgIC8vIGtlZXAgdGhlIG9sZCB1cmwgYW5kIG9ubHkgcmVwbGFjZSB0aGUgaGFzaCBmcmFnbWVudAogICAgICB0aGlzLmhhc2gocmVsSHJlZi5zbGljZSgxKSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgdmFyIGFwcFVybCwgcHJldkFwcFVybDsKICAgIHZhciByZXdyaXR0ZW5Vcmw7CgogICAgaWYgKCAoYXBwVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlLCB1cmwpKSAhPT0gdW5kZWZpbmVkICkgewogICAgICBwcmV2QXBwVXJsID0gYXBwVXJsOwogICAgICBpZiAoIChhcHBVcmwgPSBiZWdpbnNXaXRoKGJhc2VQcmVmaXgsIGFwcFVybCkpICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgcmV3cml0dGVuVXJsID0gYXBwQmFzZU5vRmlsZSArIChiZWdpbnNXaXRoKCcvJywgYXBwVXJsKSB8fCBhcHBVcmwpOwogICAgICB9IGVsc2UgewogICAgICAgIHJld3JpdHRlblVybCA9IGFwcEJhc2UgKyBwcmV2QXBwVXJsOwogICAgICB9CiAgICB9IGVsc2UgaWYgKCAoYXBwVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlTm9GaWxlLCB1cmwpKSAhPT0gdW5kZWZpbmVkICkgewogICAgICByZXdyaXR0ZW5VcmwgPSBhcHBCYXNlTm9GaWxlICsgYXBwVXJsOwogICAgfSBlbHNlIGlmIChhcHBCYXNlTm9GaWxlID09IHVybCArICcvJykgewogICAgICByZXdyaXR0ZW5VcmwgPSBhcHBCYXNlTm9GaWxlOwogICAgfQogICAgaWYgKHJld3JpdHRlblVybCkgewogICAgICB0aGlzLiQkcGFyc2UocmV3cml0dGVuVXJsKTsKICAgIH0KICAgIHJldHVybiAhIXJld3JpdHRlblVybDsKICB9Owp9CgoKLyoqCiAqIExvY2F0aW9uSGFzaGJhbmdVcmwgcmVwcmVzZW50cyB1cmwKICogVGhpcyBvYmplY3QgaXMgZXhwb3NlZCBhcyAkbG9jYXRpb24gc2VydmljZSB3aGVuIGRldmVsb3BlciBkb2Vzbid0IG9wdCBpbnRvIGh0bWw1IG1vZGUuCiAqIEl0IGFsc28gc2VydmVzIGFzIHRoZSBiYXNlIGNsYXNzIGZvciBodG1sNSBtb2RlIGZhbGxiYWNrIG9uIGxlZ2FjeSBicm93c2Vycy4KICoKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBCYXNlIGFwcGxpY2F0aW9uIGJhc2UgVVJMCiAqIEBwYXJhbSB7c3RyaW5nfSBoYXNoUHJlZml4IGhhc2hiYW5nIHByZWZpeAogKi8KZnVuY3Rpb24gTG9jYXRpb25IYXNoYmFuZ1VybChhcHBCYXNlLCBoYXNoUHJlZml4KSB7CiAgdmFyIGFwcEJhc2VOb0ZpbGUgPSBzdHJpcEZpbGUoYXBwQmFzZSk7CgogIHBhcnNlQWJzb2x1dGVVcmwoYXBwQmFzZSwgdGhpcywgYXBwQmFzZSk7CgoKICAvKioKICAgKiBQYXJzZSBnaXZlbiBoYXNoYmFuZyB1cmwgaW50byBwcm9wZXJ0aWVzCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBIYXNoYmFuZyB1cmwKICAgKiBAcHJpdmF0ZQogICAqLwogIHRoaXMuJCRwYXJzZSA9IGZ1bmN0aW9uKHVybCkgewogICAgdmFyIHdpdGhvdXRCYXNlVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlLCB1cmwpIHx8IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKTsKICAgIHZhciB3aXRob3V0SGFzaFVybCA9IHdpdGhvdXRCYXNlVXJsLmNoYXJBdCgwKSA9PSAnIycKICAgICAgICA/IGJlZ2luc1dpdGgoaGFzaFByZWZpeCwgd2l0aG91dEJhc2VVcmwpCiAgICAgICAgOiAodGhpcy4kJGh0bWw1KQogICAgICAgICAgPyB3aXRob3V0QmFzZVVybAogICAgICAgICAgOiAnJzsKCiAgICBpZiAoIWlzU3RyaW5nKHdpdGhvdXRIYXNoVXJsKSkgewogICAgICB0aHJvdyAkbG9jYXRpb25NaW5FcnIoJ2loc2hwcmZ4JywgJ0ludmFsaWQgdXJsICJ7MH0iLCBtaXNzaW5nIGhhc2ggcHJlZml4ICJ7MX0iLicsIHVybCwKICAgICAgICAgIGhhc2hQcmVmaXgpOwogICAgfQogICAgcGFyc2VBcHBVcmwod2l0aG91dEhhc2hVcmwsIHRoaXMsIGFwcEJhc2UpOwoKICAgIHRoaXMuJCRwYXRoID0gcmVtb3ZlV2luZG93c0RyaXZlTmFtZSh0aGlzLiQkcGF0aCwgd2l0aG91dEhhc2hVcmwsIGFwcEJhc2UpOwoKICAgIHRoaXMuJCRjb21wb3NlKCk7CgogICAgLyoKICAgICAqIEluIFdpbmRvd3MsIG9uIGFuIGFuY2hvciBub2RlIG9uIGRvY3VtZW50cyBsb2FkZWQgZnJvbQogICAgICogdGhlIGZpbGVzeXN0ZW0sIHRoZSBicm93c2VyIHdpbGwgcmV0dXJuIGEgcGF0aG5hbWUKICAgICAqIHByZWZpeGVkIHdpdGggdGhlIGRyaXZlIG5hbWUgKCcvQzovcGF0aCcpIHdoZW4gYQogICAgICogcGF0aG5hbWUgd2l0aG91dCBhIGRyaXZlIGlzIHNldDoKICAgICAqICAqIGEuc2V0QXR0cmlidXRlKCdocmVmJywgJy9mb28nKQogICAgICogICAqIGEucGF0aG5hbWUgPT09ICcvQzovZm9vJyAvL3RydWUKICAgICAqCiAgICAgKiBJbnNpZGUgb2YgQW5ndWxhciwgd2UncmUgYWx3YXlzIHVzaW5nIHBhdGhuYW1lcyB0aGF0CiAgICAgKiBkbyBub3QgaW5jbHVkZSBkcml2ZSBuYW1lcyBmb3Igcm91dGluZy4KICAgICAqLwogICAgZnVuY3Rpb24gcmVtb3ZlV2luZG93c0RyaXZlTmFtZSAocGF0aCwgdXJsLCBiYXNlKSB7CiAgICAgIC8qCiAgICAgIE1hdGNoZXMgcGF0aHMgZm9yIGZpbGUgcHJvdG9jb2wgb24gd2luZG93cywKICAgICAgc3VjaCBhcyAvQzovZm9vL2JhciwgYW5kIGNhcHR1cmVzIG9ubHkgL2Zvby9iYXIuCiAgICAgICovCiAgICAgIHZhciB3aW5kb3dzRmlsZVBhdGhFeHAgPSAvXlwvW0EtWl06KFwvLiopLzsKCiAgICAgIHZhciBmaXJzdFBhdGhTZWdtZW50TWF0Y2g7CgogICAgICAvL0dldCB0aGUgcmVsYXRpdmUgcGF0aCBmcm9tIHRoZSBpbnB1dCBVUkwuCiAgICAgIGlmICh1cmwuaW5kZXhPZihiYXNlKSA9PT0gMCkgewogICAgICAgIHVybCA9IHVybC5yZXBsYWNlKGJhc2UsICcnKTsKICAgICAgfQoKICAgICAgLy8gVGhlIGlucHV0IFVSTCBpbnRlbnRpb25hbGx5IGNvbnRhaW5zIGEgZmlyc3QgcGF0aCBzZWdtZW50IHRoYXQgZW5kcyB3aXRoIGEgY29sb24uCiAgICAgIGlmICh3aW5kb3dzRmlsZVBhdGhFeHAuZXhlYyh1cmwpKSB7CiAgICAgICAgcmV0dXJuIHBhdGg7CiAgICAgIH0KCiAgICAgIGZpcnN0UGF0aFNlZ21lbnRNYXRjaCA9IHdpbmRvd3NGaWxlUGF0aEV4cC5leGVjKHBhdGgpOwogICAgICByZXR1cm4gZmlyc3RQYXRoU2VnbWVudE1hdGNoID8gZmlyc3RQYXRoU2VnbWVudE1hdGNoWzFdIDogcGF0aDsKICAgIH0KICB9OwoKICAvKioKICAgKiBDb21wb3NlIGhhc2hiYW5nIHVybCBhbmQgdXBkYXRlIGBhYnNVcmxgIHByb3BlcnR5CiAgICogQHByaXZhdGUKICAgKi8KICB0aGlzLiQkY29tcG9zZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlYXJjaCA9IHRvS2V5VmFsdWUodGhpcy4kJHNlYXJjaCksCiAgICAgICAgaGFzaCA9IHRoaXMuJCRoYXNoID8gJyMnICsgZW5jb2RlVXJpU2VnbWVudCh0aGlzLiQkaGFzaCkgOiAnJzsKCiAgICB0aGlzLiQkdXJsID0gZW5jb2RlUGF0aCh0aGlzLiQkcGF0aCkgKyAoc2VhcmNoID8gJz8nICsgc2VhcmNoIDogJycpICsgaGFzaDsKICAgIHRoaXMuJCRhYnNVcmwgPSBhcHBCYXNlICsgKHRoaXMuJCR1cmwgPyBoYXNoUHJlZml4ICsgdGhpcy4kJHVybCA6ICcnKTsKICB9OwoKICB0aGlzLiQkcGFyc2VMaW5rVXJsID0gZnVuY3Rpb24odXJsLCByZWxIcmVmKSB7CiAgICBpZihzdHJpcEhhc2goYXBwQmFzZSkgPT0gc3RyaXBIYXNoKHVybCkpIHsKICAgICAgdGhpcy4kJHBhcnNlKHVybCk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07Cn0KCgovKioKICogTG9jYXRpb25IYXNoYmFuZ1VybCByZXByZXNlbnRzIHVybAogKiBUaGlzIG9iamVjdCBpcyBleHBvc2VkIGFzICRsb2NhdGlvbiBzZXJ2aWNlIHdoZW4gaHRtbDUgaGlzdG9yeSBhcGkgaXMgZW5hYmxlZCBidXQgdGhlIGJyb3dzZXIKICogZG9lcyBub3Qgc3VwcG9ydCBpdC4KICoKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBCYXNlIGFwcGxpY2F0aW9uIGJhc2UgVVJMCiAqIEBwYXJhbSB7c3RyaW5nfSBoYXNoUHJlZml4IGhhc2hiYW5nIHByZWZpeAogKi8KZnVuY3Rpb24gTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmwoYXBwQmFzZSwgaGFzaFByZWZpeCkgewogIHRoaXMuJCRodG1sNSA9IHRydWU7CiAgTG9jYXRpb25IYXNoYmFuZ1VybC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICB2YXIgYXBwQmFzZU5vRmlsZSA9IHN0cmlwRmlsZShhcHBCYXNlKTsKCiAgdGhpcy4kJHBhcnNlTGlua1VybCA9IGZ1bmN0aW9uKHVybCwgcmVsSHJlZikgewogICAgaWYgKHJlbEhyZWYgJiYgcmVsSHJlZlswXSA9PT0gJyMnKSB7CiAgICAgIC8vIHNwZWNpYWwgY2FzZSBmb3IgbGlua3MgdG8gaGFzaCBmcmFnbWVudHM6CiAgICAgIC8vIGtlZXAgdGhlIG9sZCB1cmwgYW5kIG9ubHkgcmVwbGFjZSB0aGUgaGFzaCBmcmFnbWVudAogICAgICB0aGlzLmhhc2gocmVsSHJlZi5zbGljZSgxKSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHZhciByZXdyaXR0ZW5Vcmw7CiAgICB2YXIgYXBwVXJsOwoKICAgIGlmICggYXBwQmFzZSA9PSBzdHJpcEhhc2godXJsKSApIHsKICAgICAgcmV3cml0dGVuVXJsID0gdXJsOwogICAgfSBlbHNlIGlmICggKGFwcFVybCA9IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKSkgKSB7CiAgICAgIHJld3JpdHRlblVybCA9IGFwcEJhc2UgKyBoYXNoUHJlZml4ICsgYXBwVXJsOwogICAgfSBlbHNlIGlmICggYXBwQmFzZU5vRmlsZSA9PT0gdXJsICsgJy8nKSB7CiAgICAgIHJld3JpdHRlblVybCA9IGFwcEJhc2VOb0ZpbGU7CiAgICB9CiAgICBpZiAocmV3cml0dGVuVXJsKSB7CiAgICAgIHRoaXMuJCRwYXJzZShyZXdyaXR0ZW5VcmwpOwogICAgfQogICAgcmV0dXJuICEhcmV3cml0dGVuVXJsOwogIH07CgogIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VhcmNoID0gdG9LZXlWYWx1ZSh0aGlzLiQkc2VhcmNoKSwKICAgICAgICBoYXNoID0gdGhpcy4kJGhhc2ggPyAnIycgKyBlbmNvZGVVcmlTZWdtZW50KHRoaXMuJCRoYXNoKSA6ICcnOwoKICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgLy8gaW5jbHVkZSBoYXNoUHJlZml4IGluICQkYWJzVXJsIHdoZW4gJCR1cmwgaXMgZW1wdHkgc28gSUU4ICYgOSBkbyBub3QgcmVsb2FkIHBhZ2UgYmVjYXVzZSBvZiByZW1vdmFsIG9mICcjJwogICAgdGhpcy4kJGFic1VybCA9IGFwcEJhc2UgKyBoYXNoUHJlZml4ICsgdGhpcy4kJHVybDsKICB9OwoKfQoKCnZhciBsb2NhdGlvblByb3RvdHlwZSA9IHsKCiAgLyoqCiAgICogQXJlIHdlIGluIGh0bWw1IG1vZGU/CiAgICogQHByaXZhdGUKICAgKi8KICAkJGh0bWw1OiBmYWxzZSwKCiAgLyoqCiAgICogSGFzIGFueSBjaGFuZ2UgYmVlbiByZXBsYWNpbmc/CiAgICogQHByaXZhdGUKICAgKi8KICAkJHJlcGxhY2U6IGZhbHNlLAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI2Fic1VybAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICoKICAgKiBSZXR1cm4gZnVsbCB1cmwgcmVwcmVzZW50YXRpb24gd2l0aCBhbGwgc2VnbWVudHMgZW5jb2RlZCBhY2NvcmRpbmcgdG8gcnVsZXMgc3BlY2lmaWVkIGluCiAgICogW1JGQyAzOTg2XShodHRwOi8vd3d3LmlldGYub3JnL3JmYy9yZmMzOTg2LnR4dCkuCiAgICoKICAgKiBAcmV0dXJuIHtzdHJpbmd9IGZ1bGwgdXJsCiAgICovCiAgYWJzVXJsOiBsb2NhdGlvbkdldHRlcignJCRhYnNVcmwnKSwKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2NhdGlvbiN1cmwKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgKgogICAqIFJldHVybiB1cmwgKGUuZy4gYC9wYXRoP2E9YiNoYXNoYCkgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAqCiAgICogQ2hhbmdlIHBhdGgsIHNlYXJjaCBhbmQgaGFzaCwgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gdXJsIE5ldyB1cmwgd2l0aG91dCBiYXNlIHByZWZpeCAoZS5nLiBgL3BhdGg/YT1iI2hhc2hgKQogICAqIEByZXR1cm4ge3N0cmluZ30gdXJsCiAgICovCiAgdXJsOiBmdW5jdGlvbih1cmwpIHsKICAgIGlmIChpc1VuZGVmaW5lZCh1cmwpKQogICAgICByZXR1cm4gdGhpcy4kJHVybDsKCiAgICB2YXIgbWF0Y2ggPSBQQVRIX01BVENILmV4ZWModXJsKTsKICAgIGlmIChtYXRjaFsxXSkgdGhpcy5wYXRoKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFsxXSkpOwogICAgaWYgKG1hdGNoWzJdIHx8IG1hdGNoWzFdKSB0aGlzLnNlYXJjaChtYXRjaFszXSB8fCAnJyk7CiAgICB0aGlzLmhhc2gobWF0Y2hbNV0gfHwgJycpOwoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkbG9jYXRpb24jcHJvdG9jb2wKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAqCiAgICogUmV0dXJuIHByb3RvY29sIG9mIGN1cnJlbnQgdXJsLgogICAqCiAgICogQHJldHVybiB7c3RyaW5nfSBwcm90b2NvbCBvZiBjdXJyZW50IHVybAogICAqLwogIHByb3RvY29sOiBsb2NhdGlvbkdldHRlcignJCRwcm90b2NvbCcpLAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI2hvc3QKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAqCiAgICogUmV0dXJuIGhvc3Qgb2YgY3VycmVudCB1cmwuCiAgICoKICAgKiBAcmV0dXJuIHtzdHJpbmd9IGhvc3Qgb2YgY3VycmVudCB1cmwuCiAgICovCiAgaG9zdDogbG9jYXRpb25HZXR0ZXIoJyQkaG9zdCcpLAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI3BvcnQKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAqCiAgICogUmV0dXJuIHBvcnQgb2YgY3VycmVudCB1cmwuCiAgICoKICAgKiBAcmV0dXJuIHtOdW1iZXJ9IHBvcnQKICAgKi8KICBwb3J0OiBsb2NhdGlvbkdldHRlcignJCRwb3J0JyksCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkbG9jYXRpb24jcGF0aAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAqCiAgICogUmV0dXJuIHBhdGggb2YgY3VycmVudCB1cmwgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAqCiAgICogQ2hhbmdlIHBhdGggd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgKgogICAqIE5vdGU6IFBhdGggc2hvdWxkIGFsd2F5cyBiZWdpbiB3aXRoIGZvcndhcmQgc2xhc2ggKC8pLCB0aGlzIG1ldGhvZCB3aWxsIGFkZCB0aGUgZm9yd2FyZCBzbGFzaAogICAqIGlmIGl0IGlzIG1pc3NpbmcuCiAgICoKICAgKiBAcGFyYW0geyhzdHJpbmd8bnVtYmVyKT19IHBhdGggTmV3IHBhdGgKICAgKiBAcmV0dXJuIHtzdHJpbmd9IHBhdGgKICAgKi8KICBwYXRoOiBsb2NhdGlvbkdldHRlclNldHRlcignJCRwYXRoJywgZnVuY3Rpb24ocGF0aCkgewogICAgcGF0aCA9IHBhdGggIT09IG51bGwgPyBwYXRoLnRvU3RyaW5nKCkgOiAnJzsKICAgIHJldHVybiBwYXRoLmNoYXJBdCgwKSA9PSAnLycgPyBwYXRoIDogJy8nICsgcGF0aDsKICB9KSwKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2NhdGlvbiNzZWFyY2gKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgKgogICAqIFJldHVybiBzZWFyY2ggcGFydCAoYXMgb2JqZWN0KSBvZiBjdXJyZW50IHVybCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICoKICAgKiBDaGFuZ2Ugc2VhcmNoIHBhcnQgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgKgogICAqCiAgICogYGBganMKICAgKiAvLyBnaXZlbiB1cmwgaHR0cDovL2V4YW1wbGUuY29tLyMvc29tZS9wYXRoP2Zvbz1iYXImYmF6PXhveG8KICAgKiB2YXIgc2VhcmNoT2JqZWN0ID0gJGxvY2F0aW9uLnNlYXJjaCgpOwogICAqIC8vID0+IHtmb286ICdiYXInLCBiYXo6ICd4b3hvJ30KICAgKgogICAqCiAgICogLy8gc2V0IGZvbyB0byAneWlwZWUnCiAgICogJGxvY2F0aW9uLnNlYXJjaCgnZm9vJywgJ3lpcGVlJyk7CiAgICogLy8gPT4gJGxvY2F0aW9uCiAgICogYGBgCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3QuPHN0cmluZz58T2JqZWN0LjxBcnJheS48c3RyaW5nPj59IHNlYXJjaCBOZXcgc2VhcmNoIHBhcmFtcyAtIHN0cmluZyBvcgogICAqIGhhc2ggb2JqZWN0LgogICAqCiAgICogV2hlbiBjYWxsZWQgd2l0aCBhIHNpbmdsZSBhcmd1bWVudCB0aGUgbWV0aG9kIGFjdHMgYXMgYSBzZXR0ZXIsIHNldHRpbmcgdGhlIGBzZWFyY2hgIGNvbXBvbmVudAogICAqIG9mIGAkbG9jYXRpb25gIHRvIHRoZSBzcGVjaWZpZWQgdmFsdWUuCiAgICoKICAgKiBJZiB0aGUgYXJndW1lbnQgaXMgYSBoYXNoIG9iamVjdCBjb250YWluaW5nIGFuIGFycmF5IG9mIHZhbHVlcywgdGhlc2UgdmFsdWVzIHdpbGwgYmUgZW5jb2RlZAogICAqIGFzIGR1cGxpY2F0ZSBzZWFyY2ggcGFyYW1ldGVycyBpbiB0aGUgdXJsLgogICAqCiAgICogQHBhcmFtIHsoc3RyaW5nfE51bWJlcnxBcnJheTxzdHJpbmc+fGJvb2xlYW4pPX0gcGFyYW1WYWx1ZSBJZiBgc2VhcmNoYCBpcyBhIHN0cmluZyBvciBudW1iZXIsIHRoZW4gYHBhcmFtVmFsdWVgCiAgICogd2lsbCBvdmVycmlkZSBvbmx5IGEgc2luZ2xlIHNlYXJjaCBwcm9wZXJ0eS4KICAgKgogICAqIElmIGBwYXJhbVZhbHVlYCBpcyBhbiBhcnJheSwgaXQgd2lsbCBvdmVycmlkZSB0aGUgcHJvcGVydHkgb2YgdGhlIGBzZWFyY2hgIGNvbXBvbmVudCBvZgogICAqIGAkbG9jYXRpb25gIHNwZWNpZmllZCB2aWEgdGhlIGZpcnN0IGFyZ3VtZW50LgogICAqCiAgICogSWYgYHBhcmFtVmFsdWVgIGlzIGBudWxsYCwgdGhlIHByb3BlcnR5IHNwZWNpZmllZCB2aWEgdGhlIGZpcnN0IGFyZ3VtZW50IHdpbGwgYmUgZGVsZXRlZC4KICAgKgogICAqIElmIGBwYXJhbVZhbHVlYCBpcyBgdHJ1ZWAsIHRoZSBwcm9wZXJ0eSBzcGVjaWZpZWQgdmlhIHRoZSBmaXJzdCBhcmd1bWVudCB3aWxsIGJlIGFkZGVkIHdpdGggbm8KICAgKiB2YWx1ZSBub3IgdHJhaWxpbmcgZXF1YWwgc2lnbi4KICAgKgogICAqIEByZXR1cm4ge09iamVjdH0gSWYgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzIHJldHVybnMgdGhlIHBhcnNlZCBgc2VhcmNoYCBvYmplY3QuIElmIGNhbGxlZCB3aXRoCiAgICogb25lIG9yIG1vcmUgYXJndW1lbnRzIHJldHVybnMgYCRsb2NhdGlvbmAgb2JqZWN0IGl0c2VsZi4KICAgKi8KICBzZWFyY2g6IGZ1bmN0aW9uKHNlYXJjaCwgcGFyYW1WYWx1ZSkgewogICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXR1cm4gdGhpcy4kJHNlYXJjaDsKICAgICAgY2FzZSAxOgogICAgICAgIGlmIChpc1N0cmluZyhzZWFyY2gpIHx8IGlzTnVtYmVyKHNlYXJjaCkpIHsKICAgICAgICAgIHNlYXJjaCA9IHNlYXJjaC50b1N0cmluZygpOwogICAgICAgICAgdGhpcy4kJHNlYXJjaCA9IHBhcnNlS2V5VmFsdWUoc2VhcmNoKTsKICAgICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHNlYXJjaCkpIHsKICAgICAgICAgIHNlYXJjaCA9IGNvcHkoc2VhcmNoLCB7fSk7CiAgICAgICAgICAvLyByZW1vdmUgb2JqZWN0IHVuZGVmaW5lZCBvciBudWxsIHByb3BlcnRpZXMKICAgICAgICAgIGZvckVhY2goc2VhcmNoLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSBkZWxldGUgc2VhcmNoW2tleV07CiAgICAgICAgICB9KTsKCiAgICAgICAgICB0aGlzLiQkc2VhcmNoID0gc2VhcmNoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyAkbG9jYXRpb25NaW5FcnIoJ2lzcmNoYXJnJywKICAgICAgICAgICAgICAnVGhlIGZpcnN0IGFyZ3VtZW50IG9mIHRoZSBgJGxvY2F0aW9uI3NlYXJjaCgpYCBjYWxsIG11c3QgYmUgYSBzdHJpbmcgb3IgYW4gb2JqZWN0LicpOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBpZiAoaXNVbmRlZmluZWQocGFyYW1WYWx1ZSkgfHwgcGFyYW1WYWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgZGVsZXRlIHRoaXMuJCRzZWFyY2hbc2VhcmNoXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4kJHNlYXJjaFtzZWFyY2hdID0gcGFyYW1WYWx1ZTsKICAgICAgICB9CiAgICB9CgogICAgdGhpcy4kJGNvbXBvc2UoKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkbG9jYXRpb24jaGFzaAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAqCiAgICogUmV0dXJuIGhhc2ggZnJhZ21lbnQgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAqCiAgICogQ2hhbmdlIGhhc2ggZnJhZ21lbnQgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgKgogICAqIEBwYXJhbSB7KHN0cmluZ3xudW1iZXIpPX0gaGFzaCBOZXcgaGFzaCBmcmFnbWVudAogICAqIEByZXR1cm4ge3N0cmluZ30gaGFzaAogICAqLwogIGhhc2g6IGxvY2F0aW9uR2V0dGVyU2V0dGVyKCckJGhhc2gnLCBmdW5jdGlvbihoYXNoKSB7CiAgICByZXR1cm4gaGFzaCAhPT0gbnVsbCA/IGhhc2gudG9TdHJpbmcoKSA6ICcnOwogIH0pLAoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI3JlcGxhY2UKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIElmIGNhbGxlZCwgYWxsIGNoYW5nZXMgdG8gJGxvY2F0aW9uIGR1cmluZyBjdXJyZW50IGAkZGlnZXN0YCB3aWxsIGJlIHJlcGxhY2luZyBjdXJyZW50IGhpc3RvcnkKICAgKiByZWNvcmQsIGluc3RlYWQgb2YgYWRkaW5nIG5ldyBvbmUuCiAgICovCiAgcmVwbGFjZTogZnVuY3Rpb24oKSB7CiAgICB0aGlzLiQkcmVwbGFjZSA9IHRydWU7CiAgICByZXR1cm4gdGhpczsKICB9Cn07Cgpmb3JFYWNoKFtMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybCwgTG9jYXRpb25IYXNoYmFuZ1VybCwgTG9jYXRpb25IdG1sNVVybF0sIGZ1bmN0aW9uIChMb2NhdGlvbikgewogIExvY2F0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUobG9jYXRpb25Qcm90b3R5cGUpOwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uI3N0YXRlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICoKICAgKiBSZXR1cm4gdGhlIGhpc3Rvcnkgc3RhdGUgb2JqZWN0IHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgKgogICAqIENoYW5nZSB0aGUgaGlzdG9yeSBzdGF0ZSBvYmplY3Qgd2hlbiBjYWxsZWQgd2l0aCBvbmUgcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICogVGhlIHN0YXRlIG9iamVjdCBpcyBsYXRlciBwYXNzZWQgdG8gYHB1c2hTdGF0ZWAgb3IgYHJlcGxhY2VTdGF0ZWAuCiAgICoKICAgKiBOT1RFOiBUaGlzIG1ldGhvZCBpcyBzdXBwb3J0ZWQgb25seSBpbiBIVE1MNSBtb2RlIGFuZCBvbmx5IGluIGJyb3dzZXJzIHN1cHBvcnRpbmcKICAgKiB0aGUgSFRNTDUgSGlzdG9yeSBBUEkgKGkuZS4gbWV0aG9kcyBgcHVzaFN0YXRlYCBhbmQgYHJlcGxhY2VTdGF0ZWApLiBJZiB5b3UgbmVlZCB0byBzdXBwb3J0CiAgICogb2xkZXIgYnJvd3NlcnMgKGxpa2UgSUU5IG9yIEFuZHJvaWQgPCA0LjApLCBkb24ndCB1c2UgdGhpcyBtZXRob2QuCiAgICoKICAgKiBAcGFyYW0ge29iamVjdD19IHN0YXRlIFN0YXRlIG9iamVjdCBmb3IgcHVzaFN0YXRlIG9yIHJlcGxhY2VTdGF0ZQogICAqIEByZXR1cm4ge29iamVjdH0gc3RhdGUKICAgKi8KICBMb2NhdGlvbi5wcm90b3R5cGUuc3RhdGUgPSBmdW5jdGlvbihzdGF0ZSkgewogICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKQogICAgICByZXR1cm4gdGhpcy4kJHN0YXRlOwoKICAgIGlmIChMb2NhdGlvbiAhPT0gTG9jYXRpb25IdG1sNVVybCB8fCAhdGhpcy4kJGh0bWw1KSB7CiAgICAgIHRocm93ICRsb2NhdGlvbk1pbkVycignbm9zdGF0ZScsICdIaXN0b3J5IEFQSSBzdGF0ZSBzdXBwb3J0IGlzIGF2YWlsYWJsZSBvbmx5ICcgKwogICAgICAgICdpbiBIVE1MNSBtb2RlIGFuZCBvbmx5IGluIGJyb3dzZXJzIHN1cHBvcnRpbmcgSFRNTDUgSGlzdG9yeSBBUEknKTsKICAgIH0KICAgIC8vIFRoZSB1c2VyIG1pZ2h0IG1vZGlmeSBgc3RhdGVPYmplY3RgIGFmdGVyIGludm9raW5nIGAkbG9jYXRpb24uc3RhdGUoc3RhdGVPYmplY3QpYAogICAgLy8gYnV0IHdlJ3JlIGNoYW5naW5nIHRoZSAkJHN0YXRlIHJlZmVyZW5jZSB0byAkYnJvd3Nlci5zdGF0ZSgpIGR1cmluZyB0aGUgJGRpZ2VzdAogICAgLy8gc28gdGhlIG1vZGlmaWNhdGlvbiB3aW5kb3cgaXMgbmFycm93LgogICAgdGhpcy4kJHN0YXRlID0gaXNVbmRlZmluZWQoc3RhdGUpID8gbnVsbCA6IHN0YXRlOwoKICAgIHJldHVybiB0aGlzOwogIH07Cn0pOwoKCmZ1bmN0aW9uIGxvY2F0aW9uR2V0dGVyKHByb3BlcnR5KSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXNbcHJvcGVydHldOwogIH07Cn0KCgpmdW5jdGlvbiBsb2NhdGlvbkdldHRlclNldHRlcihwcm9wZXJ0eSwgcHJlcHJvY2VzcykgewogIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgcmV0dXJuIHRoaXNbcHJvcGVydHldOwoKICAgIHRoaXNbcHJvcGVydHldID0gcHJlcHJvY2Vzcyh2YWx1ZSk7CiAgICB0aGlzLiQkY29tcG9zZSgpOwoKICAgIHJldHVybiB0aGlzOwogIH07Cn0KCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGxvY2F0aW9uCiAqCiAqIEByZXF1aXJlcyAkcm9vdEVsZW1lbnQKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSAkbG9jYXRpb24gc2VydmljZSBwYXJzZXMgdGhlIFVSTCBpbiB0aGUgYnJvd3NlciBhZGRyZXNzIGJhciAoYmFzZWQgb24gdGhlCiAqIFt3aW5kb3cubG9jYXRpb25dKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL3dpbmRvdy5sb2NhdGlvbikpIGFuZCBtYWtlcyB0aGUgVVJMCiAqIGF2YWlsYWJsZSB0byB5b3VyIGFwcGxpY2F0aW9uLiBDaGFuZ2VzIHRvIHRoZSBVUkwgaW4gdGhlIGFkZHJlc3MgYmFyIGFyZSByZWZsZWN0ZWQgaW50bwogKiAkbG9jYXRpb24gc2VydmljZSBhbmQgY2hhbmdlcyB0byAkbG9jYXRpb24gYXJlIHJlZmxlY3RlZCBpbnRvIHRoZSBicm93c2VyIGFkZHJlc3MgYmFyLgogKgogKiAqKlRoZSAkbG9jYXRpb24gc2VydmljZToqKgogKgogKiAtIEV4cG9zZXMgdGhlIGN1cnJlbnQgVVJMIGluIHRoZSBicm93c2VyIGFkZHJlc3MgYmFyLCBzbyB5b3UgY2FuCiAqICAgLSBXYXRjaCBhbmQgb2JzZXJ2ZSB0aGUgVVJMLgogKiAgIC0gQ2hhbmdlIHRoZSBVUkwuCiAqIC0gU3luY2hyb25pemVzIHRoZSBVUkwgd2l0aCB0aGUgYnJvd3NlciB3aGVuIHRoZSB1c2VyCiAqICAgLSBDaGFuZ2VzIHRoZSBhZGRyZXNzIGJhci4KICogICAtIENsaWNrcyB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbiAob3IgY2xpY2tzIGEgSGlzdG9yeSBsaW5rKS4KICogICAtIENsaWNrcyBvbiBhIGxpbmsuCiAqIC0gUmVwcmVzZW50cyB0aGUgVVJMIG9iamVjdCBhcyBhIHNldCBvZiBtZXRob2RzIChwcm90b2NvbCwgaG9zdCwgcG9ydCwgcGF0aCwgc2VhcmNoLCBoYXNoKS4KICoKICogRm9yIG1vcmUgaW5mb3JtYXRpb24gc2VlIHtAbGluayBndWlkZS8kbG9jYXRpb24gRGV2ZWxvcGVyIEd1aWRlOiBVc2luZyAkbG9jYXRpb259CiAqLwoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkbG9jYXRpb25Qcm92aWRlcgogKiBAZGVzY3JpcHRpb24KICogVXNlIHRoZSBgJGxvY2F0aW9uUHJvdmlkZXJgIHRvIGNvbmZpZ3VyZSBob3cgdGhlIGFwcGxpY2F0aW9uIGRlZXAgbGlua2luZyBwYXRocyBhcmUgc3RvcmVkLgogKi8KZnVuY3Rpb24gJExvY2F0aW9uUHJvdmlkZXIoKXsKICB2YXIgaGFzaFByZWZpeCA9ICcnLAogICAgICBodG1sNU1vZGUgPSB7CiAgICAgICAgZW5hYmxlZDogZmFsc2UsCiAgICAgICAgcmVxdWlyZUJhc2U6IHRydWUsCiAgICAgICAgcmV3cml0ZUxpbmtzOiB0cnVlCiAgICAgIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkbG9jYXRpb25Qcm92aWRlciNoYXNoUHJlZml4CiAgICogQGRlc2NyaXB0aW9uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBwcmVmaXggUHJlZml4IGZvciBoYXNoIHBhcnQgKGNvbnRhaW5pbmcgcGF0aCBhbmQgc2VhcmNoKQogICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICovCiAgdGhpcy5oYXNoUHJlZml4ID0gZnVuY3Rpb24ocHJlZml4KSB7CiAgICBpZiAoaXNEZWZpbmVkKHByZWZpeCkpIHsKICAgICAgaGFzaFByZWZpeCA9IHByZWZpeDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaGFzaFByZWZpeDsKICAgIH0KICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGxvY2F0aW9uUHJvdmlkZXIjaHRtbDVNb2RlCiAgICogQGRlc2NyaXB0aW9uCiAgICogQHBhcmFtIHsoYm9vbGVhbnxPYmplY3QpPX0gbW9kZSBJZiBib29sZWFuLCBzZXRzIGBodG1sNU1vZGUuZW5hYmxlZGAgdG8gdmFsdWUuCiAgICogICBJZiBvYmplY3QsIHNldHMgYGVuYWJsZWRgLCBgcmVxdWlyZUJhc2VgIGFuZCBgcmV3cml0ZUxpbmtzYCB0byByZXNwZWN0aXZlIHZhbHVlcy4gU3VwcG9ydGVkCiAgICogICBwcm9wZXJ0aWVzOgogICAqICAgLSAqKmVuYWJsZWQqKiDigJMgYHtib29sZWFufWAg4oCTIChkZWZhdWx0OiBmYWxzZSkgSWYgdHJ1ZSwgd2lsbCByZWx5IG9uIGBoaXN0b3J5LnB1c2hTdGF0ZWAgdG8KICAgKiAgICAgY2hhbmdlIHVybHMgd2hlcmUgc3VwcG9ydGVkLiBXaWxsIGZhbGwgYmFjayB0byBoYXNoLXByZWZpeGVkIHBhdGhzIGluIGJyb3dzZXJzIHRoYXQgZG8gbm90CiAgICogICAgIHN1cHBvcnQgYHB1c2hTdGF0ZWAuCiAgICogICAtICoqcmVxdWlyZUJhc2UqKiAtIGB7Ym9vbGVhbn1gIC0gKGRlZmF1bHQ6IGB0cnVlYCkgV2hlbiBodG1sNU1vZGUgaXMgZW5hYmxlZCwgc3BlY2lmaWVzCiAgICogICAgIHdoZXRoZXIgb3Igbm90IGEgPGJhc2U+IHRhZyBpcyByZXF1aXJlZCB0byBiZSBwcmVzZW50LiBJZiBgZW5hYmxlZGAgYW5kIGByZXF1aXJlQmFzZWAgYXJlCiAgICogICAgIHRydWUsIGFuZCBhIGJhc2UgdGFnIGlzIG5vdCBwcmVzZW50LCBhbiBlcnJvciB3aWxsIGJlIHRocm93biB3aGVuIGAkbG9jYXRpb25gIGlzIGluamVjdGVkLgogICAqICAgICBTZWUgdGhlIHtAbGluayBndWlkZS8kbG9jYXRpb24gJGxvY2F0aW9uIGd1aWRlIGZvciBtb3JlIGluZm9ybWF0aW9ufQogICAqICAgLSAqKnJld3JpdGVMaW5rcyoqIC0gYHtib29sZWFufWAgLSAoZGVmYXVsdDogYHRydWVgKSBXaGVuIGh0bWw1TW9kZSBpcyBlbmFibGVkLAogICAqICAgICBlbmFibGVzL2Rpc2FibGVzIHVybCByZXdyaXRpbmcgZm9yIHJlbGF0aXZlIGxpbmtzLgogICAqCiAgICogQHJldHVybnMge09iamVjdH0gaHRtbDVNb2RlIG9iamVjdCBpZiB1c2VkIGFzIGdldHRlciBvciBpdHNlbGYgKGNoYWluaW5nKSBpZiB1c2VkIGFzIHNldHRlcgogICAqLwogIHRoaXMuaHRtbDVNb2RlID0gZnVuY3Rpb24obW9kZSkgewogICAgaWYgKGlzQm9vbGVhbihtb2RlKSkgewogICAgICBodG1sNU1vZGUuZW5hYmxlZCA9IG1vZGU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIGlmIChpc09iamVjdChtb2RlKSkgewoKICAgICAgaWYgKGlzQm9vbGVhbihtb2RlLmVuYWJsZWQpKSB7CiAgICAgICAgaHRtbDVNb2RlLmVuYWJsZWQgPSBtb2RlLmVuYWJsZWQ7CiAgICAgIH0KCiAgICAgIGlmIChpc0Jvb2xlYW4obW9kZS5yZXF1aXJlQmFzZSkpIHsKICAgICAgICBodG1sNU1vZGUucmVxdWlyZUJhc2UgPSBtb2RlLnJlcXVpcmVCYXNlOwogICAgICB9CgogICAgICBpZiAoaXNCb29sZWFuKG1vZGUucmV3cml0ZUxpbmtzKSkgewogICAgICAgIGh0bWw1TW9kZS5yZXdyaXRlTGlua3MgPSBtb2RlLnJld3JpdGVMaW5rczsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaHRtbDVNb2RlOwogICAgfQogIH07CgogIC8qKgogICAqIEBuZ2RvYyBldmVudAogICAqIEBuYW1lICRsb2NhdGlvbiMkbG9jYXRpb25DaGFuZ2VTdGFydAogICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgKiBAZGVzY3JpcHRpb24KICAgKiBCcm9hZGNhc3RlZCBiZWZvcmUgYSBVUkwgd2lsbCBjaGFuZ2UuCiAgICoKICAgKiBUaGlzIGNoYW5nZSBjYW4gYmUgcHJldmVudGVkIGJ5IGNhbGxpbmcKICAgKiBgcHJldmVudERlZmF1bHRgIG1ldGhvZCBvZiB0aGUgZXZlbnQuIFNlZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGZvciBtb3JlCiAgICogZGV0YWlscyBhYm91dCBldmVudCBvYmplY3QuIFVwb24gc3VjY2Vzc2Z1bCBjaGFuZ2UKICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uIyRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3MgJGxvY2F0aW9uQ2hhbmdlU3VjY2Vzc30gaXMgZmlyZWQuCiAgICoKICAgKiBUaGUgYG5ld1N0YXRlYCBhbmQgYG9sZFN0YXRlYCBwYXJhbWV0ZXJzIG1heSBiZSBkZWZpbmVkIG9ubHkgaW4gSFRNTDUgbW9kZSBhbmQgd2hlbgogICAqIHRoZSBicm93c2VyIHN1cHBvcnRzIHRoZSBIVE1MNSBIaXN0b3J5IEFQSS4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBhbmd1bGFyRXZlbnQgU3ludGhldGljIGV2ZW50IG9iamVjdC4KICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3VXJsIE5ldyBVUkwKICAgKiBAcGFyYW0ge3N0cmluZz19IG9sZFVybCBVUkwgdGhhdCB3YXMgYmVmb3JlIGl0IHdhcyBjaGFuZ2VkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmV3U3RhdGUgTmV3IGhpc3Rvcnkgc3RhdGUgb2JqZWN0CiAgICogQHBhcmFtIHtzdHJpbmc9fSBvbGRTdGF0ZSBIaXN0b3J5IHN0YXRlIG9iamVjdCB0aGF0IHdhcyBiZWZvcmUgaXQgd2FzIGNoYW5nZWQuCiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBldmVudAogICAqIEBuYW1lICRsb2NhdGlvbiMkbG9jYXRpb25DaGFuZ2VTdWNjZXNzCiAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAqIEBkZXNjcmlwdGlvbgogICAqIEJyb2FkY2FzdGVkIGFmdGVyIGEgVVJMIHdhcyBjaGFuZ2VkLgogICAqCiAgICogVGhlIGBuZXdTdGF0ZWAgYW5kIGBvbGRTdGF0ZWAgcGFyYW1ldGVycyBtYXkgYmUgZGVmaW5lZCBvbmx5IGluIEhUTUw1IG1vZGUgYW5kIHdoZW4KICAgKiB0aGUgYnJvd3NlciBzdXBwb3J0cyB0aGUgSFRNTDUgSGlzdG9yeSBBUEkuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gYW5ndWxhckV2ZW50IFN5bnRoZXRpYyBldmVudCBvYmplY3QuCiAgICogQHBhcmFtIHtzdHJpbmd9IG5ld1VybCBOZXcgVVJMCiAgICogQHBhcmFtIHtzdHJpbmc9fSBvbGRVcmwgVVJMIHRoYXQgd2FzIGJlZm9yZSBpdCB3YXMgY2hhbmdlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5ld1N0YXRlIE5ldyBoaXN0b3J5IHN0YXRlIG9iamVjdAogICAqIEBwYXJhbSB7c3RyaW5nPX0gb2xkU3RhdGUgSGlzdG9yeSBzdGF0ZSBvYmplY3QgdGhhdCB3YXMgYmVmb3JlIGl0IHdhcyBjaGFuZ2VkLgogICAqLwoKICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJHNuaWZmZXInLCAnJHJvb3RFbGVtZW50JywKICAgICAgZnVuY3Rpb24oICRyb290U2NvcGUsICAgJGJyb3dzZXIsICAgJHNuaWZmZXIsICAgJHJvb3RFbGVtZW50KSB7CiAgICB2YXIgJGxvY2F0aW9uLAogICAgICAgIExvY2F0aW9uTW9kZSwKICAgICAgICBiYXNlSHJlZiA9ICRicm93c2VyLmJhc2VIcmVmKCksIC8vIGlmIGJhc2VbaHJlZl0gaXMgdW5kZWZpbmVkLCBpdCBkZWZhdWx0cyB0byAnJwogICAgICAgIGluaXRpYWxVcmwgPSAkYnJvd3Nlci51cmwoKSwKICAgICAgICBhcHBCYXNlOwoKICAgIGlmIChodG1sNU1vZGUuZW5hYmxlZCkgewogICAgICBpZiAoIWJhc2VIcmVmICYmIGh0bWw1TW9kZS5yZXF1aXJlQmFzZSkgewogICAgICAgIHRocm93ICRsb2NhdGlvbk1pbkVycignbm9iYXNlJywKICAgICAgICAgICIkbG9jYXRpb24gaW4gSFRNTDUgbW9kZSByZXF1aXJlcyBhIDxiYXNlPiB0YWcgdG8gYmUgcHJlc2VudCEiKTsKICAgICAgfQogICAgICBhcHBCYXNlID0gc2VydmVyQmFzZShpbml0aWFsVXJsKSArIChiYXNlSHJlZiB8fCAnLycpOwogICAgICBMb2NhdGlvbk1vZGUgPSAkc25pZmZlci5oaXN0b3J5ID8gTG9jYXRpb25IdG1sNVVybCA6IExvY2F0aW9uSGFzaGJhbmdJbkh0bWw1VXJsOwogICAgfSBlbHNlIHsKICAgICAgYXBwQmFzZSA9IHN0cmlwSGFzaChpbml0aWFsVXJsKTsKICAgICAgTG9jYXRpb25Nb2RlID0gTG9jYXRpb25IYXNoYmFuZ1VybDsKICAgIH0KICAgICRsb2NhdGlvbiA9IG5ldyBMb2NhdGlvbk1vZGUoYXBwQmFzZSwgJyMnICsgaGFzaFByZWZpeCk7CiAgICAkbG9jYXRpb24uJCRwYXJzZUxpbmtVcmwoaW5pdGlhbFVybCwgaW5pdGlhbFVybCk7CgogICAgJGxvY2F0aW9uLiQkc3RhdGUgPSAkYnJvd3Nlci5zdGF0ZSgpOwoKICAgIHZhciBJR05PUkVfVVJJX1JFR0VYUCA9IC9eXHMqKGphdmFzY3JpcHR8bWFpbHRvKTovaTsKCiAgICBmdW5jdGlvbiBzZXRCcm93c2VyVXJsV2l0aEZhbGxiYWNrKHVybCwgcmVwbGFjZSwgc3RhdGUpIHsKICAgICAgdmFyIG9sZFVybCA9ICRsb2NhdGlvbi51cmwoKTsKICAgICAgdmFyIG9sZFN0YXRlID0gJGxvY2F0aW9uLiQkc3RhdGU7CiAgICAgIHRyeSB7CiAgICAgICAgJGJyb3dzZXIudXJsKHVybCwgcmVwbGFjZSwgc3RhdGUpOwoKICAgICAgICAvLyBNYWtlIHN1cmUgJGxvY2F0aW9uLnN0YXRlKCkgcmV0dXJucyByZWZlcmVudGlhbGx5IGlkZW50aWNhbCAobm90IGp1c3QgZGVlcGx5IGVxdWFsKQogICAgICAgIC8vIHN0YXRlIG9iamVjdDsgdGhpcyBtYWtlcyBwb3NzaWJsZSBxdWljayBjaGVja2luZyBpZiB0aGUgc3RhdGUgY2hhbmdlZCBpbiB0aGUgZGlnZXN0CiAgICAgICAgLy8gbG9vcC4gQ2hlY2tpbmcgZGVlcCBlcXVhbGl0eSB3b3VsZCBiZSB0b28gZXhwZW5zaXZlLgogICAgICAgICRsb2NhdGlvbi4kJHN0YXRlID0gJGJyb3dzZXIuc3RhdGUoKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8vIFJlc3RvcmUgb2xkIHZhbHVlcyBpZiBwdXNoU3RhdGUgZmFpbHMKICAgICAgICAkbG9jYXRpb24udXJsKG9sZFVybCk7CiAgICAgICAgJGxvY2F0aW9uLiQkc3RhdGUgPSBvbGRTdGF0ZTsKCiAgICAgICAgdGhyb3cgZTsKICAgICAgfQogICAgfQoKICAgICRyb290RWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbihldmVudCkgewogICAgICAvLyBUT0RPKHZvanRhKTogcmV3cml0ZSBsaW5rIHdoZW4gb3BlbmluZyBpbiBuZXcgdGFiL3dpbmRvdyAoaW4gbGVnYWN5IGJyb3dzZXIpCiAgICAgIC8vIGN1cnJlbnRseSB3ZSBvcGVuIG5pY2UgdXJsIGxpbmsgYW5kIHJlZGlyZWN0IHRoZW4KCiAgICAgIGlmICghaHRtbDVNb2RlLnJld3JpdGVMaW5rcyB8fCBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgfHwgZXZlbnQud2hpY2ggPT0gMikgcmV0dXJuOwoKICAgICAgdmFyIGVsbSA9IGpxTGl0ZShldmVudC50YXJnZXQpOwoKICAgICAgLy8gdHJhdmVyc2UgdGhlIERPTSB1cCB0byBmaW5kIGZpcnN0IEEgdGFnCiAgICAgIHdoaWxlIChub2RlTmFtZV8oZWxtWzBdKSAhPT0gJ2EnKSB7CiAgICAgICAgLy8gaWdub3JlIHJld3JpdGluZyBpZiBubyBBIHRhZyAocmVhY2hlZCByb290IGVsZW1lbnQsIG9yIG5vIHBhcmVudCAtIHJlbW92ZWQgZnJvbSBkb2N1bWVudCkKICAgICAgICBpZiAoZWxtWzBdID09PSAkcm9vdEVsZW1lbnRbMF0gfHwgIShlbG0gPSBlbG0ucGFyZW50KCkpWzBdKSByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBhYnNIcmVmID0gZWxtLnByb3AoJ2hyZWYnKTsKICAgICAgLy8gZ2V0IHRoZSBhY3R1YWwgaHJlZiBhdHRyaWJ1dGUgLSBzZWUKICAgICAgLy8gaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L2llL2RkMzQ3MTQ4KHY9dnMuODUpLmFzcHgKICAgICAgdmFyIHJlbEhyZWYgPSBlbG0uYXR0cignaHJlZicpIHx8IGVsbS5hdHRyKCd4bGluazpocmVmJyk7CgogICAgICBpZiAoaXNPYmplY3QoYWJzSHJlZikgJiYgYWJzSHJlZi50b1N0cmluZygpID09PSAnW29iamVjdCBTVkdBbmltYXRlZFN0cmluZ10nKSB7CiAgICAgICAgLy8gU1ZHQW5pbWF0ZWRTdHJpbmcuYW5pbVZhbCBzaG91bGQgYmUgaWRlbnRpY2FsIHRvIFNWR0FuaW1hdGVkU3RyaW5nLmJhc2VWYWwsIHVubGVzcyBkdXJpbmcKICAgICAgICAvLyBhbiBhbmltYXRpb24uCiAgICAgICAgYWJzSHJlZiA9IHVybFJlc29sdmUoYWJzSHJlZi5hbmltVmFsKS5ocmVmOwogICAgICB9CgogICAgICAvLyBJZ25vcmUgd2hlbiB1cmwgaXMgc3RhcnRlZCB3aXRoIGphdmFzY3JpcHQ6IG9yIG1haWx0bzoKICAgICAgaWYgKElHTk9SRV9VUklfUkVHRVhQLnRlc3QoYWJzSHJlZikpIHJldHVybjsKCiAgICAgIGlmIChhYnNIcmVmICYmICFlbG0uYXR0cigndGFyZ2V0JykgJiYgIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpKSB7CiAgICAgICAgaWYgKCRsb2NhdGlvbi4kJHBhcnNlTGlua1VybChhYnNIcmVmLCByZWxIcmVmKSkgewogICAgICAgICAgLy8gV2UgZG8gYSBwcmV2ZW50RGVmYXVsdCBmb3IgYWxsIHVybHMgdGhhdCBhcmUgcGFydCBvZiB0aGUgYW5ndWxhciBhcHBsaWNhdGlvbiwKICAgICAgICAgIC8vIGluIGh0bWw1bW9kZSBhbmQgYWxzbyB3aXRob3V0LCBzbyB0aGF0IHdlIGFyZSBhYmxlIHRvIGFib3J0IG5hdmlnYXRpb24gd2l0aG91dAogICAgICAgICAgLy8gZ2V0dGluZyBkb3VibGUgZW50cmllcyBpbiB0aGUgbG9jYXRpb24gaGlzdG9yeS4KICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAvLyB1cGRhdGUgbG9jYXRpb24gbWFudWFsbHkKICAgICAgICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gJGJyb3dzZXIudXJsKCkpIHsKICAgICAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgLy8gaGFjayB0byB3b3JrIGFyb3VuZCBGRjYgYnVnIDY4NDIwOCB3aGVuIHNjZW5hcmlvIHJ1bm5lciBjbGlja3Mgb24gbGlua3MKICAgICAgICAgICAgd2luZG93LmFuZ3VsYXJbJ2ZmLTY4NDIwOC1wcmV2ZW50RGVmYXVsdCddID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKCiAgICAvLyByZXdyaXRlIGhhc2hiYW5nIHVybCA8PiBodG1sNSB1cmwKICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gaW5pdGlhbFVybCkgewogICAgICAkYnJvd3Nlci51cmwoJGxvY2F0aW9uLmFic1VybCgpLCB0cnVlKTsKICAgIH0KCiAgICB2YXIgaW5pdGlhbGl6aW5nID0gdHJ1ZTsKCiAgICAvLyB1cGRhdGUgJGxvY2F0aW9uIHdoZW4gJGJyb3dzZXIgdXJsIGNoYW5nZXMKICAgICRicm93c2VyLm9uVXJsQ2hhbmdlKGZ1bmN0aW9uKG5ld1VybCwgbmV3U3RhdGUpIHsKICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBvbGRVcmwgPSAkbG9jYXRpb24uYWJzVXJsKCk7CiAgICAgICAgdmFyIG9sZFN0YXRlID0gJGxvY2F0aW9uLiQkc3RhdGU7CgogICAgICAgICRsb2NhdGlvbi4kJHBhcnNlKG5ld1VybCk7CiAgICAgICAgJGxvY2F0aW9uLiQkc3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICBpZiAoJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdGFydCcsIG5ld1VybCwgb2xkVXJsLAogICAgICAgICAgICBuZXdTdGF0ZSwgb2xkU3RhdGUpLmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICRsb2NhdGlvbi4kJHBhcnNlKG9sZFVybCk7CiAgICAgICAgICAkbG9jYXRpb24uJCRzdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgc2V0QnJvd3NlclVybFdpdGhGYWxsYmFjayhvbGRVcmwsIGZhbHNlLCBvbGRTdGF0ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGluaXRpYWxpemluZyA9IGZhbHNlOwogICAgICAgICAgYWZ0ZXJMb2NhdGlvbkNoYW5nZShvbGRVcmwsIG9sZFN0YXRlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBpZiAoISRyb290U2NvcGUuJCRwaGFzZSkgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICB9KTsKCiAgICAvLyB1cGRhdGUgYnJvd3NlcgogICAgJHJvb3RTY29wZS4kd2F0Y2goZnVuY3Rpb24gJGxvY2F0aW9uV2F0Y2goKSB7CiAgICAgIHZhciBvbGRVcmwgPSAkYnJvd3Nlci51cmwoKTsKICAgICAgdmFyIG9sZFN0YXRlID0gJGJyb3dzZXIuc3RhdGUoKTsKICAgICAgdmFyIGN1cnJlbnRSZXBsYWNlID0gJGxvY2F0aW9uLiQkcmVwbGFjZTsKICAgICAgdmFyIHVybE9yU3RhdGVDaGFuZ2VkID0gb2xkVXJsICE9PSAkbG9jYXRpb24uYWJzVXJsKCkgfHwKICAgICAgICAoJGxvY2F0aW9uLiQkaHRtbDUgJiYgJHNuaWZmZXIuaGlzdG9yeSAmJiBvbGRTdGF0ZSAhPT0gJGxvY2F0aW9uLiQkc3RhdGUpOwoKICAgICAgaWYgKGluaXRpYWxpemluZyB8fCB1cmxPclN0YXRlQ2hhbmdlZCkgewogICAgICAgIGluaXRpYWxpemluZyA9IGZhbHNlOwoKICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdGFydCcsICRsb2NhdGlvbi5hYnNVcmwoKSwgb2xkVXJsLAogICAgICAgICAgICAgICRsb2NhdGlvbi4kJHN0YXRlLCBvbGRTdGF0ZSkuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShvbGRVcmwpOwogICAgICAgICAgICAkbG9jYXRpb24uJCRzdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHVybE9yU3RhdGVDaGFuZ2VkKSB7CiAgICAgICAgICAgICAgc2V0QnJvd3NlclVybFdpdGhGYWxsYmFjaygkbG9jYXRpb24uYWJzVXJsKCksIGN1cnJlbnRSZXBsYWNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkU3RhdGUgPT09ICRsb2NhdGlvbi4kJHN0YXRlID8gbnVsbCA6ICRsb2NhdGlvbi4kJHN0YXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhZnRlckxvY2F0aW9uQ2hhbmdlKG9sZFVybCwgb2xkU3RhdGUpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICAkbG9jYXRpb24uJCRyZXBsYWNlID0gZmFsc2U7CgogICAgICAvLyB3ZSBkb24ndCBuZWVkIHRvIHJldHVybiBhbnl0aGluZyBiZWNhdXNlICRldmFsQXN5bmMgd2lsbCBtYWtlIHRoZSBkaWdlc3QgbG9vcCBkaXJ0eSB3aGVuCiAgICAgIC8vIHRoZXJlIGlzIGEgY2hhbmdlCiAgICB9KTsKCiAgICByZXR1cm4gJGxvY2F0aW9uOwoKICAgIGZ1bmN0aW9uIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsLCBvbGRTdGF0ZSkgewogICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3MnLCAkbG9jYXRpb24uYWJzVXJsKCksIG9sZFVybCwKICAgICAgICAkbG9jYXRpb24uJCRzdGF0ZSwgb2xkU3RhdGUpOwogICAgfQp9XTsKfQoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRsb2cKICogQHJlcXVpcmVzICR3aW5kb3cKICoKICogQGRlc2NyaXB0aW9uCiAqIFNpbXBsZSBzZXJ2aWNlIGZvciBsb2dnaW5nLiBEZWZhdWx0IGltcGxlbWVudGF0aW9uIHNhZmVseSB3cml0ZXMgdGhlIG1lc3NhZ2UKICogaW50byB0aGUgYnJvd3NlcidzIGNvbnNvbGUgKGlmIHByZXNlbnQpLgogKgogKiBUaGUgbWFpbiBwdXJwb3NlIG9mIHRoaXMgc2VydmljZSBpcyB0byBzaW1wbGlmeSBkZWJ1Z2dpbmcgYW5kIHRyb3VibGVzaG9vdGluZy4KICoKICogVGhlIGRlZmF1bHQgaXMgdG8gbG9nIGBkZWJ1Z2AgbWVzc2FnZXMuIFlvdSBjYW4gdXNlCiAqIHtAbGluayBuZy4kbG9nUHJvdmlkZXIgbmcuJGxvZ1Byb3ZpZGVyI2RlYnVnRW5hYmxlZH0gdG8gY2hhbmdlIHRoaXMuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0ibG9nRXhhbXBsZSI+CiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgIGFuZ3VsYXIubW9kdWxlKCdsb2dFeGFtcGxlJywgW10pCiAgICAgICAgIC5jb250cm9sbGVyKCdMb2dDb250cm9sbGVyJywgWyckc2NvcGUnLCAnJGxvZycsIGZ1bmN0aW9uKCRzY29wZSwgJGxvZykgewogICAgICAgICAgICRzY29wZS4kbG9nID0gJGxvZzsKICAgICAgICAgICAkc2NvcGUubWVzc2FnZSA9ICdIZWxsbyBXb3JsZCEnOwogICAgICAgICB9XSk7CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJMb2dDb250cm9sbGVyIj4KICAgICAgICAgPHA+UmVsb2FkIHRoaXMgcGFnZSB3aXRoIG9wZW4gY29uc29sZSwgZW50ZXIgdGV4dCBhbmQgaGl0IHRoZSBsb2cgYnV0dG9uLi4uPC9wPgogICAgICAgICBNZXNzYWdlOgogICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im1lc3NhZ2UiLz4KICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJGxvZy5sb2cobWVzc2FnZSkiPmxvZzwvYnV0dG9uPgogICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLndhcm4obWVzc2FnZSkiPndhcm48L2J1dHRvbj4KICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJGxvZy5pbmZvKG1lc3NhZ2UpIj5pbmZvPC9idXR0b24+CiAgICAgICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cuZXJyb3IobWVzc2FnZSkiPmVycm9yPC9idXR0b24+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRsb2dQcm92aWRlcgogKiBAZGVzY3JpcHRpb24KICogVXNlIHRoZSBgJGxvZ1Byb3ZpZGVyYCB0byBjb25maWd1cmUgaG93IHRoZSBhcHBsaWNhdGlvbiBsb2dzIG1lc3NhZ2VzCiAqLwpmdW5jdGlvbiAkTG9nUHJvdmlkZXIoKXsKICB2YXIgZGVidWcgPSB0cnVlLAogICAgICBzZWxmID0gdGhpczsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRsb2dQcm92aWRlciNkZWJ1Z0VuYWJsZWQKICAgKiBAZGVzY3JpcHRpb24KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBmbGFnIGVuYWJsZSBvciBkaXNhYmxlIGRlYnVnIGxldmVsIG1lc3NhZ2VzCiAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgKi8KICB0aGlzLmRlYnVnRW5hYmxlZCA9IGZ1bmN0aW9uKGZsYWcpIHsKICAgIGlmIChpc0RlZmluZWQoZmxhZykpIHsKICAgICAgZGVidWcgPSBmbGFnOwogICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZGVidWc7CiAgICB9CiAgfTsKCiAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24oJHdpbmRvdyl7CiAgICByZXR1cm4gewogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkbG9nI2xvZwogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogV3JpdGUgYSBsb2cgbWVzc2FnZQogICAgICAgKi8KICAgICAgbG9nOiBjb25zb2xlTG9nKCdsb2cnKSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRsb2cjaW5mbwogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogV3JpdGUgYW4gaW5mb3JtYXRpb24gbWVzc2FnZQogICAgICAgKi8KICAgICAgaW5mbzogY29uc29sZUxvZygnaW5mbycpLAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGxvZyN3YXJuCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBXcml0ZSBhIHdhcm5pbmcgbWVzc2FnZQogICAgICAgKi8KICAgICAgd2FybjogY29uc29sZUxvZygnd2FybicpLAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGxvZyNlcnJvcgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogV3JpdGUgYW4gZXJyb3IgbWVzc2FnZQogICAgICAgKi8KICAgICAgZXJyb3I6IGNvbnNvbGVMb2coJ2Vycm9yJyksCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkbG9nI2RlYnVnCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBXcml0ZSBhIGRlYnVnIG1lc3NhZ2UKICAgICAgICovCiAgICAgIGRlYnVnOiAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBmbiA9IGNvbnNvbGVMb2coJ2RlYnVnJyk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChkZWJ1ZykgewogICAgICAgICAgICBmbi5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0oKSkKICAgIH07CgogICAgZnVuY3Rpb24gZm9ybWF0RXJyb3IoYXJnKSB7CiAgICAgIGlmIChhcmcgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgIGlmIChhcmcuc3RhY2spIHsKICAgICAgICAgIGFyZyA9IChhcmcubWVzc2FnZSAmJiBhcmcuc3RhY2suaW5kZXhPZihhcmcubWVzc2FnZSkgPT09IC0xKQogICAgICAgICAgICAgID8gJ0Vycm9yOiAnICsgYXJnLm1lc3NhZ2UgKyAnXG4nICsgYXJnLnN0YWNrCiAgICAgICAgICAgICAgOiBhcmcuc3RhY2s7CiAgICAgICAgfSBlbHNlIGlmIChhcmcuc291cmNlVVJMKSB7CiAgICAgICAgICBhcmcgPSBhcmcubWVzc2FnZSArICdcbicgKyBhcmcuc291cmNlVVJMICsgJzonICsgYXJnLmxpbmU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBhcmc7CiAgICB9CgogICAgZnVuY3Rpb24gY29uc29sZUxvZyh0eXBlKSB7CiAgICAgIHZhciBjb25zb2xlID0gJHdpbmRvdy5jb25zb2xlIHx8IHt9LAogICAgICAgICAgbG9nRm4gPSBjb25zb2xlW3R5cGVdIHx8IGNvbnNvbGUubG9nIHx8IG5vb3AsCiAgICAgICAgICBoYXNBcHBseSA9IGZhbHNlOwoKICAgICAgLy8gTm90ZTogcmVhZGluZyBsb2dGbi5hcHBseSB0aHJvd3MgYW4gZXJyb3IgaW4gSUUxMSBpbiBJRTggZG9jdW1lbnQgbW9kZS4KICAgICAgLy8gVGhlIHJlYXNvbiBiZWhpbmQgdGhpcyBpcyB0aGF0IGNvbnNvbGUubG9nIGhhcyB0eXBlICJvYmplY3QiIGluIElFOC4uLgogICAgICB0cnkgewogICAgICAgIGhhc0FwcGx5ID0gISFsb2dGbi5hcHBseTsKICAgICAgfSBjYXRjaCAoZSkge30KCiAgICAgIGlmIChoYXNBcHBseSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICAgIGFyZ3MucHVzaChmb3JtYXRFcnJvcihhcmcpKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGxvZ0ZuLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIC8vIHdlIGFyZSBJRSB3aGljaCBlaXRoZXIgZG9lc24ndCBoYXZlIHdpbmRvdy5jb25zb2xlID0+IHRoaXMgaXMgbm9vcCBhbmQgd2UgZG8gbm90aGluZywKICAgICAgLy8gb3Igd2UgYXJlIElFIHdoZXJlIGNvbnNvbGUubG9nIGRvZXNuJ3QgaGF2ZSBhcHBseSBzbyB3ZSBsb2cgYXQgbGVhc3QgZmlyc3QgMiBhcmdzCiAgICAgIHJldHVybiBmdW5jdGlvbihhcmcxLCBhcmcyKSB7CiAgICAgICAgbG9nRm4oYXJnMSwgYXJnMiA9PSBudWxsID8gJycgOiBhcmcyKTsKICAgICAgfTsKICAgIH0KICB9XTsKfQoKdmFyICRwYXJzZU1pbkVyciA9IG1pbkVycignJHBhcnNlJyk7CgovLyBTYW5kYm94aW5nIEFuZ3VsYXIgRXhwcmVzc2lvbnMKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIEFuZ3VsYXIgZXhwcmVzc2lvbnMgYXJlIGdlbmVyYWxseSBjb25zaWRlcmVkIHNhZmUgYmVjYXVzZSB0aGVzZSBleHByZXNzaW9ucyBvbmx5IGhhdmUgZGlyZWN0Ci8vIGFjY2VzcyB0byAkc2NvcGUgYW5kIGxvY2Fscy4gSG93ZXZlciwgb25lIGNhbiBvYnRhaW4gdGhlIGFiaWxpdHkgdG8gZXhlY3V0ZSBhcmJpdHJhcnkgSlMgY29kZSBieQovLyBvYnRhaW5pbmcgYSByZWZlcmVuY2UgdG8gbmF0aXZlIEpTIGZ1bmN0aW9ucyBzdWNoIGFzIHRoZSBGdW5jdGlvbiBjb25zdHJ1Y3Rvci4KLy8KLy8gQXMgYW4gZXhhbXBsZSwgY29uc2lkZXIgdGhlIGZvbGxvd2luZyBBbmd1bGFyIGV4cHJlc3Npb246Ci8vCi8vICAge30udG9TdHJpbmcuY29uc3RydWN0b3IoJ2FsZXJ0KCJldmlsIEpTIGNvZGUiKScpCi8vCi8vIFRoaXMgc2FuZGJveGluZyB0ZWNobmlxdWUgaXMgbm90IHBlcmZlY3QgYW5kIGRvZXNuJ3QgYWltIHRvIGJlLiBUaGUgZ29hbCBpcyB0byBwcmV2ZW50IGV4cGxvaXRzCi8vIGFnYWluc3QgdGhlIGV4cHJlc3Npb24gbGFuZ3VhZ2UsIGJ1dCBub3QgdG8gcHJldmVudCBleHBsb2l0cyB0aGF0IHdlcmUgZW5hYmxlZCBieSBleHBvc2luZwovLyBzZW5zaXRpdmUgSmF2YVNjcmlwdCBvciBicm93c2VyIGFwaXMgb24gU2NvcGUuIEV4cG9zaW5nIHN1Y2ggb2JqZWN0cyBvbiBhIFNjb3BlIGlzIG5ldmVyIGEgZ29vZAovLyBwcmFjdGljZSBhbmQgdGhlcmVmb3JlIHdlIGFyZSBub3QgZXZlbiB0cnlpbmcgdG8gcHJvdGVjdCBhZ2FpbnN0IGludGVyYWN0aW9uIHdpdGggYW4gb2JqZWN0Ci8vIGV4cGxpY2l0bHkgZXhwb3NlZCBpbiB0aGlzIHdheS4KLy8KLy8gSW4gZ2VuZXJhbCwgaXQgaXMgbm90IHBvc3NpYmxlIHRvIGFjY2VzcyBhIFdpbmRvdyBvYmplY3QgZnJvbSBhbiBhbmd1bGFyIGV4cHJlc3Npb24gdW5sZXNzIGEKLy8gd2luZG93IG9yIHNvbWUgRE9NIG9iamVjdCB0aGF0IGhhcyBhIHJlZmVyZW5jZSB0byB3aW5kb3cgaXMgcHVibGlzaGVkIG9udG8gYSBTY29wZS4KLy8gU2ltaWxhcmx5IHdlIHByZXZlbnQgaW52b2NhdGlvbnMgb2YgZnVuY3Rpb24ga25vd24gdG8gYmUgZGFuZ2Vyb3VzLCBhcyB3ZWxsIGFzIGFzc2lnbm1lbnRzIHRvCi8vIG5hdGl2ZSBvYmplY3RzLgoKCmZ1bmN0aW9uIGVuc3VyZVNhZmVNZW1iZXJOYW1lKG5hbWUsIGZ1bGxFeHByZXNzaW9uKSB7CiAgaWYgKG5hbWUgPT09ICJfX2RlZmluZUdldHRlcl9fIiB8fCBuYW1lID09PSAiX19kZWZpbmVTZXR0ZXJfXyIKICAgICAgfHwgbmFtZSA9PT0gIl9fbG9va3VwR2V0dGVyX18iIHx8IG5hbWUgPT09ICJfX2xvb2t1cFNldHRlcl9fIgogICAgICB8fCBuYW1lID09PSAiX19wcm90b19fIikgewogICAgdGhyb3cgJHBhcnNlTWluRXJyKCdpc2VjZmxkJywKICAgICAgICAnQXR0ZW1wdGluZyB0byBhY2Nlc3MgYSBkaXNhbGxvd2VkIGZpZWxkIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMhICcKICAgICAgICArJ0V4cHJlc3Npb246IHswfScsIGZ1bGxFeHByZXNzaW9uKTsKICB9CiAgcmV0dXJuIG5hbWU7Cn0KCmZ1bmN0aW9uIGVuc3VyZVNhZmVPYmplY3Qob2JqLCBmdWxsRXhwcmVzc2lvbikgewogIC8vIG5pZnR5IGNoZWNrIGlmIG9iaiBpcyBGdW5jdGlvbiB0aGF0IGlzIGZhc3QgYW5kIHdvcmtzIGFjcm9zcyBpZnJhbWVzIGFuZCBvdGhlciBjb250ZXh0cwogIGlmIChvYmopIHsKICAgIGlmIChvYmouY29uc3RydWN0b3IgPT09IG9iaikgewogICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ2lzZWNmbicsCiAgICAgICAgICAnUmVmZXJlbmNpbmcgRnVuY3Rpb24gaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLAogICAgICAgICAgZnVsbEV4cHJlc3Npb24pOwogICAgfSBlbHNlIGlmICgvLyBpc1dpbmRvdyhvYmopCiAgICAgICAgb2JqLndpbmRvdyA9PT0gb2JqKSB7CiAgICAgIHRocm93ICRwYXJzZU1pbkVycignaXNlY3dpbmRvdycsCiAgICAgICAgICAnUmVmZXJlbmNpbmcgdGhlIFdpbmRvdyBpbiBBbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRpc2FsbG93ZWQhIEV4cHJlc3Npb246IHswfScsCiAgICAgICAgICBmdWxsRXhwcmVzc2lvbik7CiAgICB9IGVsc2UgaWYgKC8vIGlzRWxlbWVudChvYmopCiAgICAgICAgb2JqLmNoaWxkcmVuICYmIChvYmoubm9kZU5hbWUgfHwgKG9iai5wcm9wICYmIG9iai5hdHRyICYmIG9iai5maW5kKSkpIHsKICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdpc2VjZG9tJywKICAgICAgICAgICdSZWZlcmVuY2luZyBET00gbm9kZXMgaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLAogICAgICAgICAgZnVsbEV4cHJlc3Npb24pOwogICAgfSBlbHNlIGlmICgvLyBibG9jayBPYmplY3Qgc28gdGhhdCB3ZSBjYW4ndCBnZXQgaG9sZCBvZiBkYW5nZXJvdXMgT2JqZWN0LiogbWV0aG9kcwogICAgICAgIG9iaiA9PT0gT2JqZWN0KSB7CiAgICAgIHRocm93ICRwYXJzZU1pbkVycignaXNlY29iaicsCiAgICAgICAgICAnUmVmZXJlbmNpbmcgT2JqZWN0IGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGlzYWxsb3dlZCEgRXhwcmVzc2lvbjogezB9JywKICAgICAgICAgIGZ1bGxFeHByZXNzaW9uKTsKICAgIH0KICB9CiAgcmV0dXJuIG9iajsKfQoKdmFyIENBTEwgPSBGdW5jdGlvbi5wcm90b3R5cGUuY2FsbDsKdmFyIEFQUExZID0gRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5Owp2YXIgQklORCA9IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kOwoKZnVuY3Rpb24gZW5zdXJlU2FmZUZ1bmN0aW9uKG9iaiwgZnVsbEV4cHJlc3Npb24pIHsKICBpZiAob2JqKSB7CiAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBvYmopIHsKICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdpc2VjZm4nLAogICAgICAgICdSZWZlcmVuY2luZyBGdW5jdGlvbiBpbiBBbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRpc2FsbG93ZWQhIEV4cHJlc3Npb246IHswfScsCiAgICAgICAgZnVsbEV4cHJlc3Npb24pOwogICAgfSBlbHNlIGlmIChvYmogPT09IENBTEwgfHwgb2JqID09PSBBUFBMWSB8fCBvYmogPT09IEJJTkQpIHsKICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdpc2VjZmYnLAogICAgICAgICdSZWZlcmVuY2luZyBjYWxsLCBhcHBseSBvciBiaW5kIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGlzYWxsb3dlZCEgRXhwcmVzc2lvbjogezB9JywKICAgICAgICBmdWxsRXhwcmVzc2lvbik7CiAgICB9CiAgfQp9CgovL0tleXdvcmQgY29uc3RhbnRzCnZhciBDT05TVEFOVFMgPSBjcmVhdGVNYXAoKTsKZm9yRWFjaCh7CiAgJ251bGwnOiBmdW5jdGlvbigpIHsgcmV0dXJuIG51bGw7IH0sCiAgJ3RydWUnOiBmdW5jdGlvbigpIHsgcmV0dXJuIHRydWU7IH0sCiAgJ2ZhbHNlJzogZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfSwKICAndW5kZWZpbmVkJzogZnVuY3Rpb24oKSB7fQp9LCBmdW5jdGlvbihjb25zdGFudEdldHRlciwgbmFtZSkgewogIGNvbnN0YW50R2V0dGVyLmNvbnN0YW50ID0gY29uc3RhbnRHZXR0ZXIubGl0ZXJhbCA9IGNvbnN0YW50R2V0dGVyLnNoYXJlZEdldHRlciA9IHRydWU7CiAgQ09OU1RBTlRTW25hbWVdID0gY29uc3RhbnRHZXR0ZXI7Cn0pOwoKLy9Ob3QgcXVpdGUgYSBjb25zdGFudCwgYnV0IGNhbiBiZSBsZXgvcGFyc2VkIHRoZSBzYW1lCkNPTlNUQU5UU1sndGhpcyddID0gZnVuY3Rpb24oc2VsZikgeyByZXR1cm4gc2VsZjsgfTsKQ09OU1RBTlRTWyd0aGlzJ10uc2hhcmVkR2V0dGVyID0gdHJ1ZTsKCgovL09wZXJhdG9ycyAtIHdpbGwgYmUgd3JhcHBlZCBieSBiaW5hcnlGbi91bmFyeUZuL2Fzc2lnbm1lbnQvZmlsdGVyCnZhciBPUEVSQVRPUlMgPSBleHRlbmQoY3JlYXRlTWFwKCksIHsKICAgICcrJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7CiAgICAgIGE9YShzZWxmLCBsb2NhbHMpOyBiPWIoc2VsZiwgbG9jYWxzKTsKICAgICAgaWYgKGlzRGVmaW5lZChhKSkgewogICAgICAgIGlmIChpc0RlZmluZWQoYikpIHsKICAgICAgICAgIHJldHVybiBhICsgYjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGE7CiAgICAgIH0KICAgICAgcmV0dXJuIGlzRGVmaW5lZChiKT9iOnVuZGVmaW5lZDt9LAogICAgJy0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXsKICAgICAgICAgIGE9YShzZWxmLCBsb2NhbHMpOyBiPWIoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgIHJldHVybiAoaXNEZWZpbmVkKGEpP2E6MCktKGlzRGVmaW5lZChiKT9iOjApOwogICAgICAgIH0sCiAgICAnKic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykqYihzZWxmLCBsb2NhbHMpO30sCiAgICAnLyc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykvYihzZWxmLCBsb2NhbHMpO30sCiAgICAnJSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscyklYihzZWxmLCBsb2NhbHMpO30sCiAgICAnPT09JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsIGIpe3JldHVybiBhKHNlbGYsIGxvY2Fscyk9PT1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICchPT0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSwgYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKSE9PWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJz09JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT09YihzZWxmLCBsb2NhbHMpO30sCiAgICAnIT0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpIT1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICc8JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKTxiKHNlbGYsIGxvY2Fscyk7fSwKICAgICc+JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT5iKHNlbGYsIGxvY2Fscyk7fSwKICAgICc8PSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2Fscyk8PWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJz49JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT49YihzZWxmLCBsb2NhbHMpO30sCiAgICAnJiYnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpJiZiKHNlbGYsIGxvY2Fscyk7fSwKICAgICd8fCc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2Fscyl8fGIoc2VsZiwgbG9jYWxzKTt9LAogICAgJyEnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSl7cmV0dXJuICFhKHNlbGYsIGxvY2Fscyk7fSwKCiAgICAvL1Rva2VuaXplZCBhcyBvcGVyYXRvcnMgYnV0IHBhcnNlZCBhcyBhc3NpZ25tZW50L2ZpbHRlcnMKICAgICc9Jzp0cnVlLAogICAgJ3wnOnRydWUKfSk7CnZhciBFU0NBUEUgPSB7Im4iOiJcbiIsICJmIjoiXGYiLCAiciI6IlxyIiwgInQiOiJcdCIsICJ2IjoiXHYiLCAiJyI6IiciLCAnIic6JyInfTsKCgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKCi8qKgogKiBAY29uc3RydWN0b3IKICovCnZhciBMZXhlciA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKfTsKCkxleGVyLnByb3RvdHlwZSA9IHsKICBjb25zdHJ1Y3RvcjogTGV4ZXIsCgogIGxleDogZnVuY3Rpb24gKHRleHQpIHsKICAgIHRoaXMudGV4dCA9IHRleHQ7CiAgICB0aGlzLmluZGV4ID0gMDsKICAgIHRoaXMuY2ggPSB1bmRlZmluZWQ7CiAgICB0aGlzLnRva2VucyA9IFtdOwoKICAgIHdoaWxlICh0aGlzLmluZGV4IDwgdGhpcy50ZXh0Lmxlbmd0aCkgewogICAgICB0aGlzLmNoID0gdGhpcy50ZXh0LmNoYXJBdCh0aGlzLmluZGV4KTsKICAgICAgaWYgKHRoaXMuaXMoJyJcJycpKSB7CiAgICAgICAgdGhpcy5yZWFkU3RyaW5nKHRoaXMuY2gpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuaXNOdW1iZXIodGhpcy5jaCkgfHwgdGhpcy5pcygnLicpICYmIHRoaXMuaXNOdW1iZXIodGhpcy5wZWVrKCkpKSB7CiAgICAgICAgdGhpcy5yZWFkTnVtYmVyKCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0lkZW50KHRoaXMuY2gpKSB7CiAgICAgICAgdGhpcy5yZWFkSWRlbnQoKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmlzKCcoKXt9W10uLDs6PycpKSB7CiAgICAgICAgdGhpcy50b2tlbnMucHVzaCh7CiAgICAgICAgICBpbmRleDogdGhpcy5pbmRleCwKICAgICAgICAgIHRleHQ6IHRoaXMuY2gKICAgICAgICB9KTsKICAgICAgICB0aGlzLmluZGV4Kys7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc1doaXRlc3BhY2UodGhpcy5jaCkpIHsKICAgICAgICB0aGlzLmluZGV4Kys7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGNoMiA9IHRoaXMuY2ggKyB0aGlzLnBlZWsoKTsKICAgICAgICB2YXIgY2gzID0gY2gyICsgdGhpcy5wZWVrKDIpOwogICAgICAgIHZhciBmbiA9IE9QRVJBVE9SU1t0aGlzLmNoXTsKICAgICAgICB2YXIgZm4yID0gT1BFUkFUT1JTW2NoMl07CiAgICAgICAgdmFyIGZuMyA9IE9QRVJBVE9SU1tjaDNdOwogICAgICAgIGlmIChmbjMpIHsKICAgICAgICAgIHRoaXMudG9rZW5zLnB1c2goe2luZGV4OiB0aGlzLmluZGV4LCB0ZXh0OiBjaDMsIGZuOiBmbjN9KTsKICAgICAgICAgIHRoaXMuaW5kZXggKz0gMzsKICAgICAgICB9IGVsc2UgaWYgKGZuMikgewogICAgICAgICAgdGhpcy50b2tlbnMucHVzaCh7aW5kZXg6IHRoaXMuaW5kZXgsIHRleHQ6IGNoMiwgZm46IGZuMn0pOwogICAgICAgICAgdGhpcy5pbmRleCArPSAyOwogICAgICAgIH0gZWxzZSBpZiAoZm4pIHsKICAgICAgICAgIHRoaXMudG9rZW5zLnB1c2goewogICAgICAgICAgICBpbmRleDogdGhpcy5pbmRleCwKICAgICAgICAgICAgdGV4dDogdGhpcy5jaCwKICAgICAgICAgICAgZm46IGZuCiAgICAgICAgICB9KTsKICAgICAgICAgIHRoaXMuaW5kZXggKz0gMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdVbmV4cGVjdGVkIG5leHQgY2hhcmFjdGVyICcsIHRoaXMuaW5kZXgsIHRoaXMuaW5kZXggKyAxKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzLnRva2VuczsKICB9LAoKICBpczogZnVuY3Rpb24oY2hhcnMpIHsKICAgIHJldHVybiBjaGFycy5pbmRleE9mKHRoaXMuY2gpICE9PSAtMTsKICB9LAoKICBwZWVrOiBmdW5jdGlvbihpKSB7CiAgICB2YXIgbnVtID0gaSB8fCAxOwogICAgcmV0dXJuICh0aGlzLmluZGV4ICsgbnVtIDwgdGhpcy50ZXh0Lmxlbmd0aCkgPyB0aGlzLnRleHQuY2hhckF0KHRoaXMuaW5kZXggKyBudW0pIDogZmFsc2U7CiAgfSwKCiAgaXNOdW1iZXI6IGZ1bmN0aW9uKGNoKSB7CiAgICByZXR1cm4gKCcwJyA8PSBjaCAmJiBjaCA8PSAnOScpOwogIH0sCgogIGlzV2hpdGVzcGFjZTogZnVuY3Rpb24oY2gpIHsKICAgIC8vIElFIHRyZWF0cyBub24tYnJlYWtpbmcgc3BhY2UgYXMgXHUwMEEwCiAgICByZXR1cm4gKGNoID09PSAnICcgfHwgY2ggPT09ICdccicgfHwgY2ggPT09ICdcdCcgfHwKICAgICAgICAgICAgY2ggPT09ICdcbicgfHwgY2ggPT09ICdcdicgfHwgY2ggPT09ICdcdTAwQTAnKTsKICB9LAoKICBpc0lkZW50OiBmdW5jdGlvbihjaCkgewogICAgcmV0dXJuICgnYScgPD0gY2ggJiYgY2ggPD0gJ3onIHx8CiAgICAgICAgICAgICdBJyA8PSBjaCAmJiBjaCA8PSAnWicgfHwKICAgICAgICAgICAgJ18nID09PSBjaCB8fCBjaCA9PT0gJyQnKTsKICB9LAoKICBpc0V4cE9wZXJhdG9yOiBmdW5jdGlvbihjaCkgewogICAgcmV0dXJuIChjaCA9PT0gJy0nIHx8IGNoID09PSAnKycgfHwgdGhpcy5pc051bWJlcihjaCkpOwogIH0sCgogIHRocm93RXJyb3I6IGZ1bmN0aW9uKGVycm9yLCBzdGFydCwgZW5kKSB7CiAgICBlbmQgPSBlbmQgfHwgdGhpcy5pbmRleDsKICAgIHZhciBjb2xTdHIgPSAoaXNEZWZpbmVkKHN0YXJ0KQogICAgICAgICAgICA/ICdzICcgKyBzdGFydCArICAnLScgKyB0aGlzLmluZGV4ICsgJyBbJyArIHRoaXMudGV4dC5zdWJzdHJpbmcoc3RhcnQsIGVuZCkgKyAnXScKICAgICAgICAgICAgOiAnICcgKyBlbmQpOwogICAgdGhyb3cgJHBhcnNlTWluRXJyKCdsZXhlcnInLCAnTGV4ZXIgRXJyb3I6IHswfSBhdCBjb2x1bW57MX0gaW4gZXhwcmVzc2lvbiBbezJ9XS4nLAogICAgICAgIGVycm9yLCBjb2xTdHIsIHRoaXMudGV4dCk7CiAgfSwKCiAgcmVhZE51bWJlcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgbnVtYmVyID0gJyc7CiAgICB2YXIgc3RhcnQgPSB0aGlzLmluZGV4OwogICAgd2hpbGUgKHRoaXMuaW5kZXggPCB0aGlzLnRleHQubGVuZ3RoKSB7CiAgICAgIHZhciBjaCA9IGxvd2VyY2FzZSh0aGlzLnRleHQuY2hhckF0KHRoaXMuaW5kZXgpKTsKICAgICAgaWYgKGNoID09ICcuJyB8fCB0aGlzLmlzTnVtYmVyKGNoKSkgewogICAgICAgIG51bWJlciArPSBjaDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcGVla0NoID0gdGhpcy5wZWVrKCk7CiAgICAgICAgaWYgKGNoID09ICdlJyAmJiB0aGlzLmlzRXhwT3BlcmF0b3IocGVla0NoKSkgewogICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0V4cE9wZXJhdG9yKGNoKSAmJgogICAgICAgICAgICBwZWVrQ2ggJiYgdGhpcy5pc051bWJlcihwZWVrQ2gpICYmCiAgICAgICAgICAgIG51bWJlci5jaGFyQXQobnVtYmVyLmxlbmd0aCAtIDEpID09ICdlJykgewogICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0V4cE9wZXJhdG9yKGNoKSAmJgogICAgICAgICAgICAoIXBlZWtDaCB8fCAhdGhpcy5pc051bWJlcihwZWVrQ2gpKSAmJgogICAgICAgICAgICBudW1iZXIuY2hhckF0KG51bWJlci5sZW5ndGggLSAxKSA9PSAnZScpIHsKICAgICAgICAgIHRoaXMudGhyb3dFcnJvcignSW52YWxpZCBleHBvbmVudCcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5pbmRleCsrOwogICAgfQogICAgbnVtYmVyID0gMSAqIG51bWJlcjsKICAgIHRoaXMudG9rZW5zLnB1c2goewogICAgICBpbmRleDogc3RhcnQsCiAgICAgIHRleHQ6IG51bWJlciwKICAgICAgY29uc3RhbnQ6IHRydWUsCiAgICAgIGZuOiBmdW5jdGlvbigpIHsgcmV0dXJuIG51bWJlcjsgfQogICAgfSk7CiAgfSwKCiAgcmVhZElkZW50OiBmdW5jdGlvbigpIHsKICAgIHZhciBleHByZXNzaW9uID0gdGhpcy50ZXh0OwoKICAgIHZhciBpZGVudCA9ICcnOwogICAgdmFyIHN0YXJ0ID0gdGhpcy5pbmRleDsKCiAgICB2YXIgbGFzdERvdCwgcGVla0luZGV4LCBtZXRob2ROYW1lLCBjaDsKCiAgICB3aGlsZSAodGhpcy5pbmRleCA8IHRoaXMudGV4dC5sZW5ndGgpIHsKICAgICAgY2ggPSB0aGlzLnRleHQuY2hhckF0KHRoaXMuaW5kZXgpOwogICAgICBpZiAoY2ggPT09ICcuJyB8fCB0aGlzLmlzSWRlbnQoY2gpIHx8IHRoaXMuaXNOdW1iZXIoY2gpKSB7CiAgICAgICAgaWYgKGNoID09PSAnLicpIGxhc3REb3QgPSB0aGlzLmluZGV4OwogICAgICAgIGlkZW50ICs9IGNoOwogICAgICB9IGVsc2UgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHRoaXMuaW5kZXgrKzsKICAgIH0KCiAgICAvL2NoZWNrIGlmIHRoZSBpZGVudGlmaWVyIGVuZHMgd2l0aCAuIGFuZCBpZiBzbyBtb3ZlIGJhY2sgb25lIGNoYXIKICAgIGlmIChsYXN0RG90ICYmIGlkZW50W2lkZW50Lmxlbmd0aCAtIDFdID09PSAnLicpIHsKICAgICAgdGhpcy5pbmRleC0tOwogICAgICBpZGVudCA9IGlkZW50LnNsaWNlKDAsIC0xKTsKICAgICAgbGFzdERvdCA9IGlkZW50Lmxhc3RJbmRleE9mKCcuJyk7CiAgICAgIGlmIChsYXN0RG90ID09PSAtMSkgewogICAgICAgIGxhc3REb3QgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH0KCiAgICAvL2NoZWNrIGlmIHRoaXMgaXMgbm90IGEgbWV0aG9kIGludm9jYXRpb24gYW5kIGlmIGl0IGlzIGJhY2sgb3V0IHRvIGxhc3QgZG90CiAgICBpZiAobGFzdERvdCkgewogICAgICBwZWVrSW5kZXggPSB0aGlzLmluZGV4OwogICAgICB3aGlsZSAocGVla0luZGV4IDwgdGhpcy50ZXh0Lmxlbmd0aCkgewogICAgICAgIGNoID0gdGhpcy50ZXh0LmNoYXJBdChwZWVrSW5kZXgpOwogICAgICAgIGlmIChjaCA9PT0gJygnKSB7CiAgICAgICAgICBtZXRob2ROYW1lID0gaWRlbnQuc3Vic3RyKGxhc3REb3QgLSBzdGFydCArIDEpOwogICAgICAgICAgaWRlbnQgPSBpZGVudC5zdWJzdHIoMCwgbGFzdERvdCAtIHN0YXJ0KTsKICAgICAgICAgIHRoaXMuaW5kZXggPSBwZWVrSW5kZXg7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuaXNXaGl0ZXNwYWNlKGNoKSkgewogICAgICAgICAgcGVla0luZGV4Kys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHRoaXMudG9rZW5zLnB1c2goewogICAgICBpbmRleDogc3RhcnQsCiAgICAgIHRleHQ6IGlkZW50LAogICAgICBmbjogQ09OU1RBTlRTW2lkZW50XSB8fCBnZXR0ZXJGbihpZGVudCwgdGhpcy5vcHRpb25zLCBleHByZXNzaW9uKQogICAgfSk7CgogICAgaWYgKG1ldGhvZE5hbWUpIHsKICAgICAgdGhpcy50b2tlbnMucHVzaCh7CiAgICAgICAgaW5kZXg6IGxhc3REb3QsCiAgICAgICAgdGV4dDogJy4nCiAgICAgIH0pOwogICAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgICBpbmRleDogbGFzdERvdCArIDEsCiAgICAgICAgdGV4dDogbWV0aG9kTmFtZQogICAgICB9KTsKICAgIH0KICB9LAoKICByZWFkU3RyaW5nOiBmdW5jdGlvbihxdW90ZSkgewogICAgdmFyIHN0YXJ0ID0gdGhpcy5pbmRleDsKICAgIHRoaXMuaW5kZXgrKzsKICAgIHZhciBzdHJpbmcgPSAnJzsKICAgIHZhciByYXdTdHJpbmcgPSBxdW90ZTsKICAgIHZhciBlc2NhcGUgPSBmYWxzZTsKICAgIHdoaWxlICh0aGlzLmluZGV4IDwgdGhpcy50ZXh0Lmxlbmd0aCkgewogICAgICB2YXIgY2ggPSB0aGlzLnRleHQuY2hhckF0KHRoaXMuaW5kZXgpOwogICAgICByYXdTdHJpbmcgKz0gY2g7CiAgICAgIGlmIChlc2NhcGUpIHsKICAgICAgICBpZiAoY2ggPT09ICd1JykgewogICAgICAgICAgdmFyIGhleCA9IHRoaXMudGV4dC5zdWJzdHJpbmcodGhpcy5pbmRleCArIDEsIHRoaXMuaW5kZXggKyA1KTsKICAgICAgICAgIGlmICghaGV4Lm1hdGNoKC9bXGRhLWZdezR9L2kpKQogICAgICAgICAgICB0aGlzLnRocm93RXJyb3IoJ0ludmFsaWQgdW5pY29kZSBlc2NhcGUgW1xcdScgKyBoZXggKyAnXScpOwogICAgICAgICAgdGhpcy5pbmRleCArPSA0OwogICAgICAgICAgc3RyaW5nICs9IFN0cmluZy5mcm9tQ2hhckNvZGUocGFyc2VJbnQoaGV4LCAxNikpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgcmVwID0gRVNDQVBFW2NoXTsKICAgICAgICAgIHN0cmluZyA9IHN0cmluZyArIChyZXAgfHwgY2gpOwogICAgICAgIH0KICAgICAgICBlc2NhcGUgPSBmYWxzZTsKICAgICAgfSBlbHNlIGlmIChjaCA9PT0gJ1xcJykgewogICAgICAgIGVzY2FwZSA9IHRydWU7CiAgICAgIH0gZWxzZSBpZiAoY2ggPT09IHF1b3RlKSB7CiAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICAgIHRoaXMudG9rZW5zLnB1c2goewogICAgICAgICAgaW5kZXg6IHN0YXJ0LAogICAgICAgICAgdGV4dDogcmF3U3RyaW5nLAogICAgICAgICAgc3RyaW5nOiBzdHJpbmcsCiAgICAgICAgICBjb25zdGFudDogdHJ1ZSwKICAgICAgICAgIGZuOiBmdW5jdGlvbigpIHsgcmV0dXJuIHN0cmluZzsgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHJpbmcgKz0gY2g7CiAgICAgIH0KICAgICAgdGhpcy5pbmRleCsrOwogICAgfQogICAgdGhpcy50aHJvd0Vycm9yKCdVbnRlcm1pbmF0ZWQgcXVvdGUnLCBzdGFydCk7CiAgfQp9OwoKCmZ1bmN0aW9uIGlzQ29uc3RhbnQoZXhwKSB7CiAgcmV0dXJuIGV4cC5jb25zdGFudDsKfQoKLyoqCiAqIEBjb25zdHJ1Y3RvcgogKi8KdmFyIFBhcnNlciA9IGZ1bmN0aW9uIChsZXhlciwgJGZpbHRlciwgb3B0aW9ucykgewogIHRoaXMubGV4ZXIgPSBsZXhlcjsKICB0aGlzLiRmaWx0ZXIgPSAkZmlsdGVyOwogIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7Cn07CgpQYXJzZXIuWkVSTyA9IGV4dGVuZChmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIDA7Cn0sIHsKICBzaGFyZWRHZXR0ZXI6IHRydWUsCiAgY29uc3RhbnQ6IHRydWUKfSk7CgpQYXJzZXIucHJvdG90eXBlID0gewogIGNvbnN0cnVjdG9yOiBQYXJzZXIsCgogIHBhcnNlOiBmdW5jdGlvbiAodGV4dCkgewogICAgdGhpcy50ZXh0ID0gdGV4dDsKICAgIHRoaXMudG9rZW5zID0gdGhpcy5sZXhlci5sZXgodGV4dCk7CgogICAgdmFyIHZhbHVlID0gdGhpcy5zdGF0ZW1lbnRzKCk7CgogICAgaWYgKHRoaXMudG9rZW5zLmxlbmd0aCAhPT0gMCkgewogICAgICB0aGlzLnRocm93RXJyb3IoJ2lzIGFuIHVuZXhwZWN0ZWQgdG9rZW4nLCB0aGlzLnRva2Vuc1swXSk7CiAgICB9CgogICAgdmFsdWUubGl0ZXJhbCA9ICEhdmFsdWUubGl0ZXJhbDsKICAgIHZhbHVlLmNvbnN0YW50ID0gISF2YWx1ZS5jb25zdGFudDsKCiAgICByZXR1cm4gdmFsdWU7CiAgfSwKCiAgcHJpbWFyeTogZnVuY3Rpb24gKCkgewogICAgdmFyIHByaW1hcnk7CiAgICBpZiAodGhpcy5leHBlY3QoJygnKSkgewogICAgICBwcmltYXJ5ID0gdGhpcy5maWx0ZXJDaGFpbigpOwogICAgICB0aGlzLmNvbnN1bWUoJyknKTsKICAgIH0gZWxzZSBpZiAodGhpcy5leHBlY3QoJ1snKSkgewogICAgICBwcmltYXJ5ID0gdGhpcy5hcnJheURlY2xhcmF0aW9uKCk7CiAgICB9IGVsc2UgaWYgKHRoaXMuZXhwZWN0KCd7JykpIHsKICAgICAgcHJpbWFyeSA9IHRoaXMub2JqZWN0KCk7CiAgICB9IGVsc2UgewogICAgICB2YXIgdG9rZW4gPSB0aGlzLmV4cGVjdCgpOwogICAgICBwcmltYXJ5ID0gdG9rZW4uZm47CiAgICAgIGlmICghcHJpbWFyeSkgewogICAgICAgIHRoaXMudGhyb3dFcnJvcignbm90IGEgcHJpbWFyeSBleHByZXNzaW9uJywgdG9rZW4pOwogICAgICB9CiAgICAgIGlmICh0b2tlbi5jb25zdGFudCkgewogICAgICAgIHByaW1hcnkuY29uc3RhbnQgPSB0cnVlOwogICAgICAgIHByaW1hcnkubGl0ZXJhbCA9IHRydWU7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgbmV4dCwgY29udGV4dDsKICAgIHdoaWxlICgobmV4dCA9IHRoaXMuZXhwZWN0KCcoJywgJ1snLCAnLicpKSkgewogICAgICBpZiAobmV4dC50ZXh0ID09PSAnKCcpIHsKICAgICAgICBwcmltYXJ5ID0gdGhpcy5mdW5jdGlvbkNhbGwocHJpbWFyeSwgY29udGV4dCk7CiAgICAgICAgY29udGV4dCA9IG51bGw7CiAgICAgIH0gZWxzZSBpZiAobmV4dC50ZXh0ID09PSAnWycpIHsKICAgICAgICBjb250ZXh0ID0gcHJpbWFyeTsKICAgICAgICBwcmltYXJ5ID0gdGhpcy5vYmplY3RJbmRleChwcmltYXJ5KTsKICAgICAgfSBlbHNlIGlmIChuZXh0LnRleHQgPT09ICcuJykgewogICAgICAgIGNvbnRleHQgPSBwcmltYXJ5OwogICAgICAgIHByaW1hcnkgPSB0aGlzLmZpZWxkQWNjZXNzKHByaW1hcnkpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudGhyb3dFcnJvcignSU1QT1NTSUJMRScpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcHJpbWFyeTsKICB9LAoKICB0aHJvd0Vycm9yOiBmdW5jdGlvbihtc2csIHRva2VuKSB7CiAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ3N5bnRheCcsCiAgICAgICAgJ1N5bnRheCBFcnJvcjogVG9rZW4gXCd7MH1cJyB7MX0gYXQgY29sdW1uIHsyfSBvZiB0aGUgZXhwcmVzc2lvbiBbezN9XSBzdGFydGluZyBhdCBbezR9XS4nLAogICAgICAgICAgdG9rZW4udGV4dCwgbXNnLCAodG9rZW4uaW5kZXggKyAxKSwgdGhpcy50ZXh0LCB0aGlzLnRleHQuc3Vic3RyaW5nKHRva2VuLmluZGV4KSk7CiAgfSwKCiAgcGVla1Rva2VuOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLnRva2Vucy5sZW5ndGggPT09IDApCiAgICAgIHRocm93ICRwYXJzZU1pbkVycigndWVvZScsICdVbmV4cGVjdGVkIGVuZCBvZiBleHByZXNzaW9uOiB7MH0nLCB0aGlzLnRleHQpOwogICAgcmV0dXJuIHRoaXMudG9rZW5zWzBdOwogIH0sCgogIHBlZWs6IGZ1bmN0aW9uKGUxLCBlMiwgZTMsIGU0KSB7CiAgICBpZiAodGhpcy50b2tlbnMubGVuZ3RoID4gMCkgewogICAgICB2YXIgdG9rZW4gPSB0aGlzLnRva2Vuc1swXTsKICAgICAgdmFyIHQgPSB0b2tlbi50ZXh0OwogICAgICBpZiAodCA9PT0gZTEgfHwgdCA9PT0gZTIgfHwgdCA9PT0gZTMgfHwgdCA9PT0gZTQgfHwKICAgICAgICAgICghZTEgJiYgIWUyICYmICFlMyAmJiAhZTQpKSB7CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfSwKCiAgZXhwZWN0OiBmdW5jdGlvbihlMSwgZTIsIGUzLCBlNCl7CiAgICB2YXIgdG9rZW4gPSB0aGlzLnBlZWsoZTEsIGUyLCBlMywgZTQpOwogICAgaWYgKHRva2VuKSB7CiAgICAgIHRoaXMudG9rZW5zLnNoaWZ0KCk7CiAgICAgIHJldHVybiB0b2tlbjsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9LAoKICBjb25zdW1lOiBmdW5jdGlvbihlMSl7CiAgICBpZiAoIXRoaXMuZXhwZWN0KGUxKSkgewogICAgICB0aGlzLnRocm93RXJyb3IoJ2lzIHVuZXhwZWN0ZWQsIGV4cGVjdGluZyBbJyArIGUxICsgJ10nLCB0aGlzLnBlZWsoKSk7CiAgICB9CiAgfSwKCiAgdW5hcnlGbjogZnVuY3Rpb24oZm4sIHJpZ2h0KSB7CiAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uICRwYXJzZVVuYXJ5Rm4oc2VsZiwgbG9jYWxzKSB7CiAgICAgIHJldHVybiBmbihzZWxmLCBsb2NhbHMsIHJpZ2h0KTsKICAgIH0sIHsKICAgICAgY29uc3RhbnQ6cmlnaHQuY29uc3RhbnQsCiAgICAgIGlucHV0czogW3JpZ2h0XQogICAgfSk7CiAgfSwKCiAgYmluYXJ5Rm46IGZ1bmN0aW9uKGxlZnQsIGZuLCByaWdodCwgaXNCcmFuY2hpbmcpIHsKICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gJHBhcnNlQmluYXJ5Rm4oc2VsZiwgbG9jYWxzKSB7CiAgICAgIHJldHVybiBmbihzZWxmLCBsb2NhbHMsIGxlZnQsIHJpZ2h0KTsKICAgIH0sIHsKICAgICAgY29uc3RhbnQ6IGxlZnQuY29uc3RhbnQgJiYgcmlnaHQuY29uc3RhbnQsCiAgICAgIGlucHV0czogIWlzQnJhbmNoaW5nICYmIFtsZWZ0LCByaWdodF0KICAgIH0pOwogIH0sCgogIHN0YXRlbWVudHM6IGZ1bmN0aW9uKCkgewogICAgdmFyIHN0YXRlbWVudHMgPSBbXTsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGlmICh0aGlzLnRva2Vucy5sZW5ndGggPiAwICYmICF0aGlzLnBlZWsoJ30nLCAnKScsICc7JywgJ10nKSkKICAgICAgICBzdGF0ZW1lbnRzLnB1c2godGhpcy5maWx0ZXJDaGFpbigpKTsKICAgICAgaWYgKCF0aGlzLmV4cGVjdCgnOycpKSB7CiAgICAgICAgLy8gb3B0aW1pemUgZm9yIHRoZSBjb21tb24gY2FzZSB3aGVyZSB0aGVyZSBpcyBvbmx5IG9uZSBzdGF0ZW1lbnQuCiAgICAgICAgLy8gVE9ETyhzaXplKTogbWF5YmUgd2Ugc2hvdWxkIG5vdCBzdXBwb3J0IG11bHRpcGxlIHN0YXRlbWVudHM/CiAgICAgICAgcmV0dXJuIChzdGF0ZW1lbnRzLmxlbmd0aCA9PT0gMSkKICAgICAgICAgICAgPyBzdGF0ZW1lbnRzWzBdCiAgICAgICAgICAgIDogZnVuY3Rpb24gJHBhcnNlU3RhdGVtZW50cyhzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IHN0YXRlbWVudHMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0YXRlbWVudHNbaV0oc2VsZiwgbG9jYWxzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfSwKCiAgZmlsdGVyQ2hhaW46IGZ1bmN0aW9uKCkgewogICAgdmFyIGxlZnQgPSB0aGlzLmV4cHJlc3Npb24oKTsKICAgIHZhciB0b2tlbjsKICAgIHdoaWxlICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnfCcpKSkgewogICAgICBsZWZ0ID0gdGhpcy5maWx0ZXIobGVmdCk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9LAoKICBmaWx0ZXI6IGZ1bmN0aW9uKGlucHV0Rm4pIHsKICAgIHZhciB0b2tlbiA9IHRoaXMuZXhwZWN0KCk7CiAgICB2YXIgZm4gPSB0aGlzLiRmaWx0ZXIodG9rZW4udGV4dCk7CiAgICB2YXIgYXJnc0ZuOwogICAgdmFyIGFyZ3M7CgogICAgaWYgKHRoaXMucGVlaygnOicpKSB7CiAgICAgIGFyZ3NGbiA9IFtdOwogICAgICBhcmdzID0gW107IC8vIHdlIGNhbiBzYWZlbHkgcmV1c2UgdGhlIGFycmF5CiAgICAgIHdoaWxlICh0aGlzLmV4cGVjdCgnOicpKSB7CiAgICAgICAgYXJnc0ZuLnB1c2godGhpcy5leHByZXNzaW9uKCkpOwogICAgICB9CiAgICB9CgogICAgdmFyIGlucHV0cyA9IFtpbnB1dEZuXS5jb25jYXQoYXJnc0ZuIHx8IFtdKTsKCiAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uICRwYXJzZUZpbHRlcihzZWxmLCBsb2NhbHMpIHsKICAgICAgdmFyIGlucHV0ID0gaW5wdXRGbihzZWxmLCBsb2NhbHMpOwogICAgICBpZiAoYXJncykgewogICAgICAgIGFyZ3NbMF0gPSBpbnB1dDsKCiAgICAgICAgdmFyIGkgPSBhcmdzRm4ubGVuZ3RoOwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgIGFyZ3NbaSArIDFdID0gYXJnc0ZuW2ldKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZm4uYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZuKGlucHV0KTsKICAgIH0sIHsKICAgICAgY29uc3RhbnQ6ICFmbi4kc3RhdGVmdWwgJiYgaW5wdXRzLmV2ZXJ5KGlzQ29uc3RhbnQpLAogICAgICBpbnB1dHM6ICFmbi4kc3RhdGVmdWwgJiYgaW5wdXRzCiAgICB9KTsKICB9LAoKICBleHByZXNzaW9uOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmFzc2lnbm1lbnQoKTsKICB9LAoKICBhc3NpZ25tZW50OiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy50ZXJuYXJ5KCk7CiAgICB2YXIgcmlnaHQ7CiAgICB2YXIgdG9rZW47CiAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJz0nKSkpIHsKICAgICAgaWYgKCFsZWZ0LmFzc2lnbikgewogICAgICAgIHRoaXMudGhyb3dFcnJvcignaW1wbGllcyBhc3NpZ25tZW50IGJ1dCBbJyArCiAgICAgICAgICAgIHRoaXMudGV4dC5zdWJzdHJpbmcoMCwgdG9rZW4uaW5kZXgpICsgJ10gY2FuIG5vdCBiZSBhc3NpZ25lZCB0bycsIHRva2VuKTsKICAgICAgfQogICAgICByaWdodCA9IHRoaXMudGVybmFyeSgpOwogICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uICRwYXJzZUFzc2lnbm1lbnQoc2NvcGUsIGxvY2FscykgewogICAgICAgIHJldHVybiBsZWZ0LmFzc2lnbihzY29wZSwgcmlnaHQoc2NvcGUsIGxvY2FscyksIGxvY2Fscyk7CiAgICAgIH0sIHsKICAgICAgICBpbnB1dHM6IFtsZWZ0LCByaWdodF0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9LAoKICB0ZXJuYXJ5OiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy5sb2dpY2FsT1IoKTsKICAgIHZhciBtaWRkbGU7CiAgICB2YXIgdG9rZW47CiAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJz8nKSkpIHsKICAgICAgbWlkZGxlID0gdGhpcy5hc3NpZ25tZW50KCk7CiAgICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnOicpKSkgewogICAgICAgIHZhciByaWdodCA9IHRoaXMuYXNzaWdubWVudCgpOwoKICAgICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uICRwYXJzZVRlcm5hcnkoc2VsZiwgbG9jYWxzKXsKICAgICAgICAgIHJldHVybiBsZWZ0KHNlbGYsIGxvY2FscykgPyBtaWRkbGUoc2VsZiwgbG9jYWxzKSA6IHJpZ2h0KHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwgewogICAgICAgICAgY29uc3RhbnQ6IGxlZnQuY29uc3RhbnQgJiYgbWlkZGxlLmNvbnN0YW50ICYmIHJpZ2h0LmNvbnN0YW50CiAgICAgICAgfSk7CgogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudGhyb3dFcnJvcignZXhwZWN0ZWQgOicsIHRva2VuKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBsZWZ0OwogIH0sCgogIGxvZ2ljYWxPUjogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVmdCA9IHRoaXMubG9naWNhbEFORCgpOwogICAgdmFyIHRva2VuOwogICAgd2hpbGUgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCd8fCcpKSkgewogICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy5sb2dpY2FsQU5EKCksIHRydWUpOwogICAgfQogICAgcmV0dXJuIGxlZnQ7CiAgfSwKCiAgbG9naWNhbEFORDogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVmdCA9IHRoaXMuZXF1YWxpdHkoKTsKICAgIHZhciB0b2tlbjsKICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnJiYnKSkpIHsKICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMubG9naWNhbEFORCgpLCB0cnVlKTsKICAgIH0KICAgIHJldHVybiBsZWZ0OwogIH0sCgogIGVxdWFsaXR5OiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy5yZWxhdGlvbmFsKCk7CiAgICB2YXIgdG9rZW47CiAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJz09JywnIT0nLCc9PT0nLCchPT0nKSkpIHsKICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMuZXF1YWxpdHkoKSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9LAoKICByZWxhdGlvbmFsOiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy5hZGRpdGl2ZSgpOwogICAgdmFyIHRva2VuOwogICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCc8JywgJz4nLCAnPD0nLCAnPj0nKSkpIHsKICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMucmVsYXRpb25hbCgpKTsKICAgIH0KICAgIHJldHVybiBsZWZ0OwogIH0sCgogIGFkZGl0aXZlOiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy5tdWx0aXBsaWNhdGl2ZSgpOwogICAgdmFyIHRva2VuOwogICAgd2hpbGUgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCcrJywnLScpKSkgewogICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy5tdWx0aXBsaWNhdGl2ZSgpKTsKICAgIH0KICAgIHJldHVybiBsZWZ0OwogIH0sCgogIG11bHRpcGxpY2F0aXZlOiBmdW5jdGlvbigpIHsKICAgIHZhciBsZWZ0ID0gdGhpcy51bmFyeSgpOwogICAgdmFyIHRva2VuOwogICAgd2hpbGUgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCcqJywnLycsJyUnKSkpIHsKICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMudW5hcnkoKSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9LAoKICB1bmFyeTogZnVuY3Rpb24oKSB7CiAgICB2YXIgdG9rZW47CiAgICBpZiAodGhpcy5leHBlY3QoJysnKSkgewogICAgICByZXR1cm4gdGhpcy5wcmltYXJ5KCk7CiAgICB9IGVsc2UgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCctJykpKSB7CiAgICAgIHJldHVybiB0aGlzLmJpbmFyeUZuKFBhcnNlci5aRVJPLCB0b2tlbi5mbiwgdGhpcy51bmFyeSgpKTsKICAgIH0gZWxzZSBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJyEnKSkpIHsKICAgICAgcmV0dXJuIHRoaXMudW5hcnlGbih0b2tlbi5mbiwgdGhpcy51bmFyeSgpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLnByaW1hcnkoKTsKICAgIH0KICB9LAoKICBmaWVsZEFjY2VzczogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICB2YXIgZXhwcmVzc2lvbiA9IHRoaXMudGV4dDsKICAgIHZhciBmaWVsZCA9IHRoaXMuZXhwZWN0KCkudGV4dDsKICAgIHZhciBnZXR0ZXIgPSBnZXR0ZXJGbihmaWVsZCwgdGhpcy5vcHRpb25zLCBleHByZXNzaW9uKTsKCiAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uICRwYXJzZUZpZWxkQWNjZXNzKHNjb3BlLCBsb2NhbHMsIHNlbGYpIHsKICAgICAgcmV0dXJuIGdldHRlcihzZWxmIHx8IG9iamVjdChzY29wZSwgbG9jYWxzKSk7CiAgICB9LCB7CiAgICAgIGFzc2lnbjogZnVuY3Rpb24oc2NvcGUsIHZhbHVlLCBsb2NhbHMpIHsKICAgICAgICB2YXIgbyA9IG9iamVjdChzY29wZSwgbG9jYWxzKTsKICAgICAgICBpZiAoIW8pIG9iamVjdC5hc3NpZ24oc2NvcGUsIG8gPSB7fSk7CiAgICAgICAgcmV0dXJuIHNldHRlcihvLCBmaWVsZCwgdmFsdWUsIGV4cHJlc3Npb24pOwogICAgICB9CiAgICB9KTsKICB9LAoKICBvYmplY3RJbmRleDogZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgZXhwcmVzc2lvbiA9IHRoaXMudGV4dDsKCiAgICB2YXIgaW5kZXhGbiA9IHRoaXMuZXhwcmVzc2lvbigpOwogICAgdGhpcy5jb25zdW1lKCddJyk7CgogICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAkcGFyc2VPYmplY3RJbmRleChzZWxmLCBsb2NhbHMpIHsKICAgICAgdmFyIG8gPSBvYmooc2VsZiwgbG9jYWxzKSwKICAgICAgICAgIGkgPSBpbmRleEZuKHNlbGYsIGxvY2FscyksCiAgICAgICAgICB2OwoKICAgICAgZW5zdXJlU2FmZU1lbWJlck5hbWUoaSwgZXhwcmVzc2lvbik7CiAgICAgIGlmICghbykgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgdiA9IGVuc3VyZVNhZmVPYmplY3Qob1tpXSwgZXhwcmVzc2lvbik7CiAgICAgIHJldHVybiB2OwogICAgfSwgewogICAgICBhc3NpZ246IGZ1bmN0aW9uKHNlbGYsIHZhbHVlLCBsb2NhbHMpIHsKICAgICAgICB2YXIga2V5ID0gZW5zdXJlU2FmZU1lbWJlck5hbWUoaW5kZXhGbihzZWxmLCBsb2NhbHMpLCBleHByZXNzaW9uKTsKICAgICAgICAvLyBwcmV2ZW50IG92ZXJ3cml0aW5nIG9mIEZ1bmN0aW9uLmNvbnN0cnVjdG9yIHdoaWNoIHdvdWxkIGJyZWFrIGVuc3VyZVNhZmVPYmplY3QgY2hlY2sKICAgICAgICB2YXIgbyA9IGVuc3VyZVNhZmVPYmplY3Qob2JqKHNlbGYsIGxvY2FscyksIGV4cHJlc3Npb24pOwogICAgICAgIGlmICghbykgb2JqLmFzc2lnbihzZWxmLCBvID0ge30pOwogICAgICAgIHJldHVybiBvW2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgZnVuY3Rpb25DYWxsOiBmdW5jdGlvbihmbkdldHRlciwgY29udGV4dEdldHRlcikgewogICAgdmFyIGFyZ3NGbiA9IFtdOwogICAgaWYgKHRoaXMucGVla1Rva2VuKCkudGV4dCAhPT0gJyknKSB7CiAgICAgIGRvIHsKICAgICAgICBhcmdzRm4ucHVzaCh0aGlzLmV4cHJlc3Npb24oKSk7CiAgICAgIH0gd2hpbGUgKHRoaXMuZXhwZWN0KCcsJykpOwogICAgfQogICAgdGhpcy5jb25zdW1lKCcpJyk7CgogICAgdmFyIGV4cHJlc3Npb25UZXh0ID0gdGhpcy50ZXh0OwogICAgLy8gd2UgY2FuIHNhZmVseSByZXVzZSB0aGUgYXJyYXkgYWNyb3NzIGludm9jYXRpb25zCiAgICB2YXIgYXJncyA9IGFyZ3NGbi5sZW5ndGggPyBbXSA6IG51bGw7CgogICAgcmV0dXJuIGZ1bmN0aW9uICRwYXJzZUZ1bmN0aW9uQ2FsbChzY29wZSwgbG9jYWxzKSB7CiAgICAgIHZhciBjb250ZXh0ID0gY29udGV4dEdldHRlciA/IGNvbnRleHRHZXR0ZXIoc2NvcGUsIGxvY2FscykgOiBzY29wZTsKICAgICAgdmFyIGZuID0gZm5HZXR0ZXIoc2NvcGUsIGxvY2FscywgY29udGV4dCkgfHwgbm9vcDsKCiAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgdmFyIGkgPSBhcmdzRm4ubGVuZ3RoOwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgIGFyZ3NbaV0gPSBlbnN1cmVTYWZlT2JqZWN0KGFyZ3NGbltpXShzY29wZSwgbG9jYWxzKSwgZXhwcmVzc2lvblRleHQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZW5zdXJlU2FmZU9iamVjdChjb250ZXh0LCBleHByZXNzaW9uVGV4dCk7CiAgICAgIGVuc3VyZVNhZmVGdW5jdGlvbihmbiwgZXhwcmVzc2lvblRleHQpOwoKICAgICAgLy8gSUUgc3R1cGlkaXR5ISAoSUUgZG9lc24ndCBoYXZlIGFwcGx5IGZvciBzb21lIG5hdGl2ZSBmdW5jdGlvbnMpCiAgICAgIHZhciB2ID0gZm4uYXBwbHkKICAgICAgICAgICAgPyBmbi5hcHBseShjb250ZXh0LCBhcmdzKQogICAgICAgICAgICA6IGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0pOwoKICAgICAgcmV0dXJuIGVuc3VyZVNhZmVPYmplY3QodiwgZXhwcmVzc2lvblRleHQpOwogICAgfTsKICB9LAoKICAvLyBUaGlzIGlzIHVzZWQgd2l0aCBqc29uIGFycmF5IGRlY2xhcmF0aW9uCiAgYXJyYXlEZWNsYXJhdGlvbjogZnVuY3Rpb24gKCkgewogICAgdmFyIGVsZW1lbnRGbnMgPSBbXTsKICAgIGlmICh0aGlzLnBlZWtUb2tlbigpLnRleHQgIT09ICddJykgewogICAgICBkbyB7CiAgICAgICAgaWYgKHRoaXMucGVlaygnXScpKSB7CiAgICAgICAgICAvLyBTdXBwb3J0IHRyYWlsaW5nIGNvbW1hcyBwZXIgRVM1LjEuCiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgdmFyIGVsZW1lbnRGbiA9IHRoaXMuZXhwcmVzc2lvbigpOwogICAgICAgIGVsZW1lbnRGbnMucHVzaChlbGVtZW50Rm4pOwogICAgICB9IHdoaWxlICh0aGlzLmV4cGVjdCgnLCcpKTsKICAgIH0KICAgIHRoaXMuY29uc3VtZSgnXScpOwoKICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gJHBhcnNlQXJyYXlMaXRlcmFsKHNlbGYsIGxvY2FscykgewogICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gZWxlbWVudEZucy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgYXJyYXkucHVzaChlbGVtZW50Rm5zW2ldKHNlbGYsIGxvY2FscykpOwogICAgICB9CiAgICAgIHJldHVybiBhcnJheTsKICAgIH0sIHsKICAgICAgbGl0ZXJhbDogdHJ1ZSwKICAgICAgY29uc3RhbnQ6IGVsZW1lbnRGbnMuZXZlcnkoaXNDb25zdGFudCksCiAgICAgIGlucHV0czogZWxlbWVudEZucwogICAgfSk7CiAgfSwKCiAgb2JqZWN0OiBmdW5jdGlvbiAoKSB7CiAgICB2YXIga2V5cyA9IFtdLCB2YWx1ZUZucyA9IFtdOwogICAgaWYgKHRoaXMucGVla1Rva2VuKCkudGV4dCAhPT0gJ30nKSB7CiAgICAgIGRvIHsKICAgICAgICBpZiAodGhpcy5wZWVrKCd9JykpIHsKICAgICAgICAgIC8vIFN1cHBvcnQgdHJhaWxpbmcgY29tbWFzIHBlciBFUzUuMS4KICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICB2YXIgdG9rZW4gPSB0aGlzLmV4cGVjdCgpOwogICAgICAgIGtleXMucHVzaCh0b2tlbi5zdHJpbmcgfHwgdG9rZW4udGV4dCk7CiAgICAgICAgdGhpcy5jb25zdW1lKCc6Jyk7CiAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5leHByZXNzaW9uKCk7CiAgICAgICAgdmFsdWVGbnMucHVzaCh2YWx1ZSk7CiAgICAgIH0gd2hpbGUgKHRoaXMuZXhwZWN0KCcsJykpOwogICAgfQogICAgdGhpcy5jb25zdW1lKCd9Jyk7CgogICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAkcGFyc2VPYmplY3RMaXRlcmFsKHNlbGYsIGxvY2FscykgewogICAgICB2YXIgb2JqZWN0ID0ge307CiAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IHZhbHVlRm5zLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICBvYmplY3Rba2V5c1tpXV0gPSB2YWx1ZUZuc1tpXShzZWxmLCBsb2NhbHMpOwogICAgICB9CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9LCB7CiAgICAgIGxpdGVyYWw6IHRydWUsCiAgICAgIGNvbnN0YW50OiB2YWx1ZUZucy5ldmVyeShpc0NvbnN0YW50KSwKICAgICAgaW5wdXRzOiB2YWx1ZUZucwogICAgfSk7CiAgfQp9OwoKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIFBhcnNlciBoZWxwZXIgZnVuY3Rpb25zCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgpmdW5jdGlvbiBzZXR0ZXIob2JqLCBwYXRoLCBzZXRWYWx1ZSwgZnVsbEV4cCkgewogIGVuc3VyZVNhZmVPYmplY3Qob2JqLCBmdWxsRXhwKTsKCiAgdmFyIGVsZW1lbnQgPSBwYXRoLnNwbGl0KCcuJyksIGtleTsKICBmb3IgKHZhciBpID0gMDsgZWxlbWVudC5sZW5ndGggPiAxOyBpKyspIHsKICAgIGtleSA9IGVuc3VyZVNhZmVNZW1iZXJOYW1lKGVsZW1lbnQuc2hpZnQoKSwgZnVsbEV4cCk7CiAgICB2YXIgcHJvcGVydHlPYmogPSBlbnN1cmVTYWZlT2JqZWN0KG9ialtrZXldLCBmdWxsRXhwKTsKICAgIGlmICghcHJvcGVydHlPYmopIHsKICAgICAgcHJvcGVydHlPYmogPSB7fTsKICAgICAgb2JqW2tleV0gPSBwcm9wZXJ0eU9iajsKICAgIH0KICAgIG9iaiA9IHByb3BlcnR5T2JqOwogIH0KICBrZXkgPSBlbnN1cmVTYWZlTWVtYmVyTmFtZShlbGVtZW50LnNoaWZ0KCksIGZ1bGxFeHApOwogIGVuc3VyZVNhZmVPYmplY3Qob2JqW2tleV0sIGZ1bGxFeHApOwogIG9ialtrZXldID0gc2V0VmFsdWU7CiAgcmV0dXJuIHNldFZhbHVlOwp9Cgp2YXIgZ2V0dGVyRm5DYWNoZSA9IGNyZWF0ZU1hcCgpOwoKLyoqCiAqIEltcGxlbWVudGF0aW9uIG9mIHRoZSAiQmxhY2sgSG9sZSIgdmFyaWFudCBmcm9tOgogKiAtIGh0dHA6Ly9qc3BlcmYuY29tL2FuZ3VsYXJqcy1wYXJzZS1nZXR0ZXIvNAogKiAtIGh0dHA6Ly9qc3BlcmYuY29tL3BhdGgtZXZhbHVhdGlvbi1zaW1wbGlmaWVkLzcKICovCmZ1bmN0aW9uIGNzcFNhZmVHZXR0ZXJGbihrZXkwLCBrZXkxLCBrZXkyLCBrZXkzLCBrZXk0LCBmdWxsRXhwKSB7CiAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MCwgZnVsbEV4cCk7CiAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MSwgZnVsbEV4cCk7CiAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MiwgZnVsbEV4cCk7CiAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MywgZnVsbEV4cCk7CiAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5NCwgZnVsbEV4cCk7CgogIHJldHVybiBmdW5jdGlvbiBjc3BTYWZlR2V0dGVyKHNjb3BlLCBsb2NhbHMpIHsKICAgIHZhciBwYXRoVmFsID0gKGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5MCkpID8gbG9jYWxzIDogc2NvcGU7CgogICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHBhdGhWYWw7CiAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkwXTsKCiAgICBpZiAoIWtleTEpIHJldHVybiBwYXRoVmFsOwogICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTFdOwoKICAgIGlmICgha2V5MikgcmV0dXJuIHBhdGhWYWw7CiAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5Ml07CgogICAgaWYgKCFrZXkzKSByZXR1cm4gcGF0aFZhbDsKICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkzXTsKCiAgICBpZiAoIWtleTQpIHJldHVybiBwYXRoVmFsOwogICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTRdOwoKICAgIHJldHVybiBwYXRoVmFsOwogIH07Cn0KCmZ1bmN0aW9uIGdldHRlckZuKHBhdGgsIG9wdGlvbnMsIGZ1bGxFeHApIHsKICB2YXIgZm4gPSBnZXR0ZXJGbkNhY2hlW3BhdGhdOwoKICBpZiAoZm4pIHJldHVybiBmbjsKCiAgdmFyIHBhdGhLZXlzID0gcGF0aC5zcGxpdCgnLicpLAogICAgICBwYXRoS2V5c0xlbmd0aCA9IHBhdGhLZXlzLmxlbmd0aDsKCiAgLy8gaHR0cDovL2pzcGVyZi5jb20vYW5ndWxhcmpzLXBhcnNlLWdldHRlci82CiAgaWYgKG9wdGlvbnMuY3NwKSB7CiAgICBpZiAocGF0aEtleXNMZW5ndGggPCA2KSB7CiAgICAgIGZuID0gY3NwU2FmZUdldHRlckZuKHBhdGhLZXlzWzBdLCBwYXRoS2V5c1sxXSwgcGF0aEtleXNbMl0sIHBhdGhLZXlzWzNdLCBwYXRoS2V5c1s0XSwgZnVsbEV4cCk7CiAgICB9IGVsc2UgewogICAgICBmbiA9IGZ1bmN0aW9uIGNzcFNhZmVHZXR0ZXIoc2NvcGUsIGxvY2FscykgewogICAgICAgIHZhciBpID0gMCwgdmFsOwogICAgICAgIGRvIHsKICAgICAgICAgIHZhbCA9IGNzcFNhZmVHZXR0ZXJGbihwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGhLZXlzW2krK10sIGZ1bGxFeHApKHNjb3BlLCBsb2NhbHMpOwoKICAgICAgICAgIGxvY2FscyA9IHVuZGVmaW5lZDsgLy8gY2xlYXIgYWZ0ZXIgZmlyc3QgaXRlcmF0aW9uCiAgICAgICAgICBzY29wZSA9IHZhbDsKICAgICAgICB9IHdoaWxlIChpIDwgcGF0aEtleXNMZW5ndGgpOwogICAgICAgIHJldHVybiB2YWw7CiAgICAgIH07CiAgICB9CiAgfSBlbHNlIHsKICAgIHZhciBjb2RlID0gJyc7CiAgICBmb3JFYWNoKHBhdGhLZXlzLCBmdW5jdGlvbihrZXksIGluZGV4KSB7CiAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleSwgZnVsbEV4cCk7CiAgICAgIGNvZGUgKz0gJ2lmKHMgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDtcbicgKwogICAgICAgICAgICAgICdzPScrIChpbmRleAogICAgICAgICAgICAgICAgICAgICAgLy8gd2Ugc2ltcGx5IGRlcmVmZXJlbmNlICdzJyBvbiBhbnkgLmRvdCBub3RhdGlvbgogICAgICAgICAgICAgICAgICAgICAgPyAncycKICAgICAgICAgICAgICAgICAgICAgIC8vIGJ1dCBpZiB3ZSBhcmUgZmlyc3QgdGhlbiB3ZSBjaGVjayBsb2NhbHMgZmlyc3QsIGFuZCBpZiBzbyByZWFkIGl0IGZpcnN0CiAgICAgICAgICAgICAgICAgICAgICA6ICcoKGwmJmwuaGFzT3duUHJvcGVydHkoIicgKyBrZXkgKyAnIikpP2w6cyknKSArICcuJyArIGtleSArICc7XG4nOwogICAgfSk7CiAgICBjb2RlICs9ICdyZXR1cm4gczsnOwoKICAgIC8qIGpzaGludCAtVzA1NCAqLwogICAgdmFyIGV2YWxlZEZuR2V0dGVyID0gbmV3IEZ1bmN0aW9uKCdzJywgJ2wnLCBjb2RlKTsgLy8gcz1zY29wZSwgbD1sb2NhbHMKICAgIC8qIGpzaGludCArVzA1NCAqLwogICAgZXZhbGVkRm5HZXR0ZXIudG9TdHJpbmcgPSB2YWx1ZUZuKGNvZGUpOwoKICAgIGZuID0gZXZhbGVkRm5HZXR0ZXI7CiAgfQoKICBmbi5zaGFyZWRHZXR0ZXIgPSB0cnVlOwogIGZuLmFzc2lnbiA9IGZ1bmN0aW9uKHNlbGYsIHZhbHVlKSB7CiAgICByZXR1cm4gc2V0dGVyKHNlbGYsIHBhdGgsIHZhbHVlLCBwYXRoKTsKICB9OwogIGdldHRlckZuQ2FjaGVbcGF0aF0gPSBmbjsKICByZXR1cm4gZm47Cn0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHBhcnNlCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBDb252ZXJ0cyBBbmd1bGFyIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGludG8gYSBmdW5jdGlvbi4KICoKICogYGBganMKICogICB2YXIgZ2V0dGVyID0gJHBhcnNlKCd1c2VyLm5hbWUnKTsKICogICB2YXIgc2V0dGVyID0gZ2V0dGVyLmFzc2lnbjsKICogICB2YXIgY29udGV4dCA9IHt1c2VyOntuYW1lOidhbmd1bGFyJ319OwogKiAgIHZhciBsb2NhbHMgPSB7dXNlcjp7bmFtZTonbG9jYWwnfX07CiAqCiAqICAgZXhwZWN0KGdldHRlcihjb250ZXh0KSkudG9FcXVhbCgnYW5ndWxhcicpOwogKiAgIHNldHRlcihjb250ZXh0LCAnbmV3VmFsdWUnKTsKICogICBleHBlY3QoY29udGV4dC51c2VyLm5hbWUpLnRvRXF1YWwoJ25ld1ZhbHVlJyk7CiAqICAgZXhwZWN0KGdldHRlcihjb250ZXh0LCBsb2NhbHMpKS50b0VxdWFsKCdsb2NhbCcpOwogKiBgYGAKICoKICoKICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICoKICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogKiAgICAgIGBjb250ZXh0YC4KICoKICogICAgVGhlIHJldHVybmVkIGZ1bmN0aW9uIGFsc28gaGFzIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczoKICogICAgICAqIGBsaXRlcmFsYCDigJMgYHtib29sZWFufWAg4oCTIHdoZXRoZXIgdGhlIGV4cHJlc3Npb24ncyB0b3AtbGV2ZWwgbm9kZSBpcyBhIEphdmFTY3JpcHQKICogICAgICAgIGxpdGVyYWwuCiAqICAgICAgKiBgY29uc3RhbnRgIOKAkyBge2Jvb2xlYW59YCDigJMgd2hldGhlciB0aGUgZXhwcmVzc2lvbiBpcyBtYWRlIGVudGlyZWx5IG9mIEphdmFTY3JpcHQKICogICAgICAgIGNvbnN0YW50IGxpdGVyYWxzLgogKiAgICAgICogYGFzc2lnbmAg4oCTIGB7P2Z1bmN0aW9uKGNvbnRleHQsIHZhbHVlKX1gIOKAkyBpZiB0aGUgZXhwcmVzc2lvbiBpcyBhc3NpZ25hYmxlLCB0aGlzIHdpbGwgYmUKICogICAgICAgIHNldCB0byBhIGZ1bmN0aW9uIHRvIGNoYW5nZSBpdHMgdmFsdWUgb24gdGhlIGdpdmVuIGNvbnRleHQuCiAqCiAqLwoKCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJHBhcnNlUHJvdmlkZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIGAkcGFyc2VQcm92aWRlcmAgY2FuIGJlIHVzZWQgZm9yIGNvbmZpZ3VyaW5nIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIHRoZSB7QGxpbmsgbmcuJHBhcnNlICRwYXJzZX0KICogIHNlcnZpY2UuCiAqLwpmdW5jdGlvbiAkUGFyc2VQcm92aWRlcigpIHsKICB2YXIgY2FjaGUgPSBjcmVhdGVNYXAoKTsKCiAgdmFyICRwYXJzZU9wdGlvbnMgPSB7CiAgICBjc3A6IGZhbHNlCiAgfTsKCgogIHRoaXMuJGdldCA9IFsnJGZpbHRlcicsICckc25pZmZlcicsIGZ1bmN0aW9uKCRmaWx0ZXIsICRzbmlmZmVyKSB7CiAgICAkcGFyc2VPcHRpb25zLmNzcCA9ICRzbmlmZmVyLmNzcDsKCiAgICBmdW5jdGlvbiB3cmFwU2hhcmVkRXhwcmVzc2lvbihleHApIHsKICAgICAgdmFyIHdyYXBwZWQgPSBleHA7CgogICAgICBpZiAoZXhwLnNoYXJlZEdldHRlcikgewogICAgICAgIHdyYXBwZWQgPSBmdW5jdGlvbiAkcGFyc2VXcmFwcGVyKHNlbGYsIGxvY2FscykgewogICAgICAgICAgcmV0dXJuIGV4cChzZWxmLCBsb2NhbHMpOwogICAgICAgIH07CiAgICAgICAgd3JhcHBlZC5saXRlcmFsID0gZXhwLmxpdGVyYWw7CiAgICAgICAgd3JhcHBlZC5jb25zdGFudCA9IGV4cC5jb25zdGFudDsKICAgICAgICB3cmFwcGVkLmFzc2lnbiA9IGV4cC5hc3NpZ247CiAgICAgIH0KCiAgICAgIHJldHVybiB3cmFwcGVkOwogICAgfQoKICAgIHJldHVybiBmdW5jdGlvbiAkcGFyc2UoZXhwLCBpbnRlcmNlcHRvckZuKSB7CiAgICAgIHZhciBwYXJzZWRFeHByZXNzaW9uLCBvbmVUaW1lLCBjYWNoZUtleTsKCiAgICAgIHN3aXRjaCAodHlwZW9mIGV4cCkgewogICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICBjYWNoZUtleSA9IGV4cCA9IGV4cC50cmltKCk7CgogICAgICAgICAgcGFyc2VkRXhwcmVzc2lvbiA9IGNhY2hlW2NhY2hlS2V5XTsKCiAgICAgICAgICBpZiAoIXBhcnNlZEV4cHJlc3Npb24pIHsKICAgICAgICAgICAgaWYgKGV4cC5jaGFyQXQoMCkgPT09ICc6JyAmJiBleHAuY2hhckF0KDEpID09PSAnOicpIHsKICAgICAgICAgICAgICBvbmVUaW1lID0gdHJ1ZTsKICAgICAgICAgICAgICBleHAgPSBleHAuc3Vic3RyaW5nKDIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbGV4ZXIgPSBuZXcgTGV4ZXIoJHBhcnNlT3B0aW9ucyk7CiAgICAgICAgICAgIHZhciBwYXJzZXIgPSBuZXcgUGFyc2VyKGxleGVyLCAkZmlsdGVyLCAkcGFyc2VPcHRpb25zKTsKICAgICAgICAgICAgcGFyc2VkRXhwcmVzc2lvbiA9IHBhcnNlci5wYXJzZShleHApOwoKICAgICAgICAgICAgaWYgKHBhcnNlZEV4cHJlc3Npb24uY29uc3RhbnQpIHsKICAgICAgICAgICAgICBwYXJzZWRFeHByZXNzaW9uLiQkd2F0Y2hEZWxlZ2F0ZSA9IGNvbnN0YW50V2F0Y2hEZWxlZ2F0ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChvbmVUaW1lKSB7CiAgICAgICAgICAgICAgLy9vbmVUaW1lIGlzIG5vdCBwYXJ0IG9mIHRoZSBleHAgcGFzc2VkIHRvIHRoZSBQYXJzZXIgc28gd2UgbWF5IGhhdmUgdG8KICAgICAgICAgICAgICAvL3dyYXAgdGhlIHBhcnNlZEV4cHJlc3Npb24gYmVmb3JlIGFkZGluZyBhICQkd2F0Y2hEZWxlZ2F0ZQogICAgICAgICAgICAgIHBhcnNlZEV4cHJlc3Npb24gPSB3cmFwU2hhcmVkRXhwcmVzc2lvbihwYXJzZWRFeHByZXNzaW9uKTsKICAgICAgICAgICAgICBwYXJzZWRFeHByZXNzaW9uLiQkd2F0Y2hEZWxlZ2F0ZSA9IHBhcnNlZEV4cHJlc3Npb24ubGl0ZXJhbCA/CiAgICAgICAgICAgICAgICBvbmVUaW1lTGl0ZXJhbFdhdGNoRGVsZWdhdGUgOiBvbmVUaW1lV2F0Y2hEZWxlZ2F0ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwYXJzZWRFeHByZXNzaW9uLmlucHV0cykgewogICAgICAgICAgICAgIHBhcnNlZEV4cHJlc3Npb24uJCR3YXRjaERlbGVnYXRlID0gaW5wdXRzV2F0Y2hEZWxlZ2F0ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2FjaGVbY2FjaGVLZXldID0gcGFyc2VkRXhwcmVzc2lvbjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBhZGRJbnRlcmNlcHRvcihwYXJzZWRFeHByZXNzaW9uLCBpbnRlcmNlcHRvckZuKTsKCiAgICAgICAgY2FzZSAnZnVuY3Rpb24nOgogICAgICAgICAgcmV0dXJuIGFkZEludGVyY2VwdG9yKGV4cCwgaW50ZXJjZXB0b3JGbik7CgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gYWRkSW50ZXJjZXB0b3Iobm9vcCwgaW50ZXJjZXB0b3JGbik7CiAgICAgIH0KICAgIH07CgogICAgZnVuY3Rpb24gY29sbGVjdEV4cHJlc3Npb25JbnB1dHMoaW5wdXRzLCBsaXN0KSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGlucHV0cy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgdmFyIGlucHV0ID0gaW5wdXRzW2ldOwogICAgICAgIGlmICghaW5wdXQuY29uc3RhbnQpIHsKICAgICAgICAgIGlmIChpbnB1dC5pbnB1dHMpIHsKICAgICAgICAgICAgY29sbGVjdEV4cHJlc3Npb25JbnB1dHMoaW5wdXQuaW5wdXRzLCBsaXN0KTsKICAgICAgICAgIH0gZWxzZSBpZiAobGlzdC5pbmRleE9mKGlucHV0KSA9PT0gLTEpIHsgLy8gVE9ETyhwZXJmKSBjYW4gd2UgZG8gYmV0dGVyPwogICAgICAgICAgICBsaXN0LnB1c2goaW5wdXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGxpc3Q7CiAgICB9CgogICAgZnVuY3Rpb24gZXhwcmVzc2lvbklucHV0RGlydHlDaGVjayhuZXdWYWx1ZSwgb2xkVmFsdWVPZlZhbHVlKSB7CgogICAgICBpZiAobmV3VmFsdWUgPT0gbnVsbCB8fCBvbGRWYWx1ZU9mVmFsdWUgPT0gbnVsbCkgeyAvLyBudWxsL3VuZGVmaW5lZAogICAgICAgIHJldHVybiBuZXdWYWx1ZSA9PT0gb2xkVmFsdWVPZlZhbHVlOwogICAgICB9CgogICAgICBpZiAodHlwZW9mIG5ld1ZhbHVlID09PSAnb2JqZWN0JykgewoKICAgICAgICAvLyBhdHRlbXB0IHRvIGNvbnZlcnQgdGhlIHZhbHVlIHRvIGEgcHJpbWl0aXZlIHR5cGUKICAgICAgICAvLyBUT0RPKGRvY3MpOiBhZGQgYSBub3RlIHRvIGRvY3MgdGhhdCBieSBpbXBsZW1lbnRpbmcgdmFsdWVPZiBldmVuIG9iamVjdHMgYW5kIGFycmF5cyBjYW4KICAgICAgICAvLyAgICAgICAgICAgICBiZSBjaGVhcGx5IGRpcnR5LWNoZWNrZWQKICAgICAgICBuZXdWYWx1ZSA9IG5ld1ZhbHVlLnZhbHVlT2YoKTsKCiAgICAgICAgaWYgKHR5cGVvZiBuZXdWYWx1ZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgIC8vIG9iamVjdHMvYXJyYXlzIGFyZSBub3Qgc3VwcG9ydGVkIC0gZGVlcC13YXRjaGluZyB0aGVtIHdvdWxkIGJlIHRvbyBleHBlbnNpdmUKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIC8vIGZhbGwtdGhyb3VnaCB0byB0aGUgcHJpbWl0aXZlIGVxdWFsaXR5IGNoZWNrCiAgICAgIH0KCiAgICAgIC8vUHJpbWl0aXZlIG9yIE5hTgogICAgICByZXR1cm4gbmV3VmFsdWUgPT09IG9sZFZhbHVlT2ZWYWx1ZSB8fCAobmV3VmFsdWUgIT09IG5ld1ZhbHVlICYmIG9sZFZhbHVlT2ZWYWx1ZSAhPT0gb2xkVmFsdWVPZlZhbHVlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbnB1dHNXYXRjaERlbGVnYXRlKHNjb3BlLCBsaXN0ZW5lciwgb2JqZWN0RXF1YWxpdHksIHBhcnNlZEV4cHJlc3Npb24pIHsKICAgICAgdmFyIGlucHV0RXhwcmVzc2lvbnMgPSBwYXJzZWRFeHByZXNzaW9uLiQkaW5wdXRzIHx8CiAgICAgICAgICAgICAgICAgICAgKHBhcnNlZEV4cHJlc3Npb24uJCRpbnB1dHMgPSBjb2xsZWN0RXhwcmVzc2lvbklucHV0cyhwYXJzZWRFeHByZXNzaW9uLmlucHV0cywgW10pKTsKCiAgICAgIHZhciBsYXN0UmVzdWx0OwoKICAgICAgaWYgKGlucHV0RXhwcmVzc2lvbnMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdmFyIG9sZElucHV0VmFsdWUgPSBleHByZXNzaW9uSW5wdXREaXJ0eUNoZWNrOyAvLyBpbml0IHRvIHNvbWV0aGluZyB1bmlxdWUgc28gdGhhdCBlcXVhbHMgY2hlY2sgZmFpbHMKICAgICAgICBpbnB1dEV4cHJlc3Npb25zID0gaW5wdXRFeHByZXNzaW9uc1swXTsKICAgICAgICByZXR1cm4gc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIGV4cHJlc3Npb25JbnB1dFdhdGNoKHNjb3BlKSB7CiAgICAgICAgICB2YXIgbmV3SW5wdXRWYWx1ZSA9IGlucHV0RXhwcmVzc2lvbnMoc2NvcGUpOwogICAgICAgICAgaWYgKCFleHByZXNzaW9uSW5wdXREaXJ0eUNoZWNrKG5ld0lucHV0VmFsdWUsIG9sZElucHV0VmFsdWUpKSB7CiAgICAgICAgICAgIGxhc3RSZXN1bHQgPSBwYXJzZWRFeHByZXNzaW9uKHNjb3BlKTsKICAgICAgICAgICAgb2xkSW5wdXRWYWx1ZSA9IG5ld0lucHV0VmFsdWUgJiYgbmV3SW5wdXRWYWx1ZS52YWx1ZU9mKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFzdFJlc3VsdDsKICAgICAgICB9LCBsaXN0ZW5lciwgb2JqZWN0RXF1YWxpdHkpOwogICAgICB9CgogICAgICB2YXIgb2xkSW5wdXRWYWx1ZU9mVmFsdWVzID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGlucHV0RXhwcmVzc2lvbnMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgIG9sZElucHV0VmFsdWVPZlZhbHVlc1tpXSA9IGV4cHJlc3Npb25JbnB1dERpcnR5Q2hlY2s7IC8vIGluaXQgdG8gc29tZXRoaW5nIHVuaXF1ZSBzbyB0aGF0IGVxdWFscyBjaGVjayBmYWlscwogICAgICB9CgogICAgICByZXR1cm4gc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIGV4cHJlc3Npb25JbnB1dHNXYXRjaChzY29wZSkgewogICAgICAgIHZhciBjaGFuZ2VkID0gZmFsc2U7CgogICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGlucHV0RXhwcmVzc2lvbnMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgdmFyIG5ld0lucHV0VmFsdWUgPSBpbnB1dEV4cHJlc3Npb25zW2ldKHNjb3BlKTsKICAgICAgICAgIGlmIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0gIWV4cHJlc3Npb25JbnB1dERpcnR5Q2hlY2sobmV3SW5wdXRWYWx1ZSwgb2xkSW5wdXRWYWx1ZU9mVmFsdWVzW2ldKSkpIHsKICAgICAgICAgICAgb2xkSW5wdXRWYWx1ZU9mVmFsdWVzW2ldID0gbmV3SW5wdXRWYWx1ZSAmJiBuZXdJbnB1dFZhbHVlLnZhbHVlT2YoKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChjaGFuZ2VkKSB7CiAgICAgICAgICBsYXN0UmVzdWx0ID0gcGFyc2VkRXhwcmVzc2lvbihzY29wZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbGFzdFJlc3VsdDsKICAgICAgfSwgbGlzdGVuZXIsIG9iamVjdEVxdWFsaXR5KTsKICAgIH0KCiAgICBmdW5jdGlvbiBvbmVUaW1lV2F0Y2hEZWxlZ2F0ZShzY29wZSwgbGlzdGVuZXIsIG9iamVjdEVxdWFsaXR5LCBwYXJzZWRFeHByZXNzaW9uKSB7CiAgICAgIHZhciB1bndhdGNoLCBsYXN0VmFsdWU7CiAgICAgIHJldHVybiB1bndhdGNoID0gc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIG9uZVRpbWVXYXRjaChzY29wZSkgewogICAgICAgIHJldHVybiBwYXJzZWRFeHByZXNzaW9uKHNjb3BlKTsKICAgICAgfSwgZnVuY3Rpb24gb25lVGltZUxpc3RlbmVyKHZhbHVlLCBvbGQsIHNjb3BlKSB7CiAgICAgICAgbGFzdFZhbHVlID0gdmFsdWU7CiAgICAgICAgaWYgKGlzRnVuY3Rpb24obGlzdGVuZXIpKSB7CiAgICAgICAgICBsaXN0ZW5lci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgc2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChsYXN0VmFsdWUpKSB7CiAgICAgICAgICAgICAgdW53YXRjaCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0sIG9iamVjdEVxdWFsaXR5KTsKICAgIH0KCiAgICBmdW5jdGlvbiBvbmVUaW1lTGl0ZXJhbFdhdGNoRGVsZWdhdGUoc2NvcGUsIGxpc3RlbmVyLCBvYmplY3RFcXVhbGl0eSwgcGFyc2VkRXhwcmVzc2lvbikgewogICAgICB2YXIgdW53YXRjaCwgbGFzdFZhbHVlOwogICAgICByZXR1cm4gdW53YXRjaCA9IHNjb3BlLiR3YXRjaChmdW5jdGlvbiBvbmVUaW1lV2F0Y2goc2NvcGUpIHsKICAgICAgICByZXR1cm4gcGFyc2VkRXhwcmVzc2lvbihzY29wZSk7CiAgICAgIH0sIGZ1bmN0aW9uIG9uZVRpbWVMaXN0ZW5lcih2YWx1ZSwgb2xkLCBzY29wZSkgewogICAgICAgIGxhc3RWYWx1ZSA9IHZhbHVlOwogICAgICAgIGlmIChpc0Z1bmN0aW9uKGxpc3RlbmVyKSkgewogICAgICAgICAgbGlzdGVuZXIuY2FsbCh0aGlzLCB2YWx1ZSwgb2xkLCBzY29wZSk7CiAgICAgICAgfQogICAgICAgIGlmIChpc0FsbERlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICBzY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZihpc0FsbERlZmluZWQobGFzdFZhbHVlKSkgdW53YXRjaCgpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9LCBvYmplY3RFcXVhbGl0eSk7CgogICAgICBmdW5jdGlvbiBpc0FsbERlZmluZWQodmFsdWUpIHsKICAgICAgICB2YXIgYWxsRGVmaW5lZCA9IHRydWU7CiAgICAgICAgZm9yRWFjaCh2YWx1ZSwgZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgaWYgKCFpc0RlZmluZWQodmFsKSkgYWxsRGVmaW5lZCA9IGZhbHNlOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBhbGxEZWZpbmVkOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY29uc3RhbnRXYXRjaERlbGVnYXRlKHNjb3BlLCBsaXN0ZW5lciwgb2JqZWN0RXF1YWxpdHksIHBhcnNlZEV4cHJlc3Npb24pIHsKICAgICAgdmFyIHVud2F0Y2g7CiAgICAgIHJldHVybiB1bndhdGNoID0gc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIGNvbnN0YW50V2F0Y2goc2NvcGUpIHsKICAgICAgICByZXR1cm4gcGFyc2VkRXhwcmVzc2lvbihzY29wZSk7CiAgICAgIH0sIGZ1bmN0aW9uIGNvbnN0YW50TGlzdGVuZXIodmFsdWUsIG9sZCwgc2NvcGUpIHsKICAgICAgICBpZiAoaXNGdW5jdGlvbihsaXN0ZW5lcikpIHsKICAgICAgICAgIGxpc3RlbmVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICAgIHVud2F0Y2goKTsKICAgICAgfSwgb2JqZWN0RXF1YWxpdHkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGFkZEludGVyY2VwdG9yKHBhcnNlZEV4cHJlc3Npb24sIGludGVyY2VwdG9yRm4pIHsKICAgICAgaWYgKCFpbnRlcmNlcHRvckZuKSByZXR1cm4gcGFyc2VkRXhwcmVzc2lvbjsKCiAgICAgIHZhciBmbiA9IGZ1bmN0aW9uIGludGVyY2VwdGVkRXhwcmVzc2lvbihzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VkRXhwcmVzc2lvbihzY29wZSwgbG9jYWxzKTsKICAgICAgICB2YXIgcmVzdWx0ID0gaW50ZXJjZXB0b3JGbih2YWx1ZSwgc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgLy8gd2Ugb25seSByZXR1cm4gdGhlIGludGVyY2VwdG9yJ3MgcmVzdWx0IGlmIHRoZQogICAgICAgIC8vIGluaXRpYWwgdmFsdWUgaXMgZGVmaW5lZCAoZm9yIGJpbmQtb25jZSkKICAgICAgICByZXR1cm4gaXNEZWZpbmVkKHZhbHVlKSA/IHJlc3VsdCA6IHZhbHVlOwogICAgICB9OwoKICAgICAgLy8gUHJvcGFnYXRlICQkd2F0Y2hEZWxlZ2F0ZXMgb3RoZXIgdGhlbiBpbnB1dHNXYXRjaERlbGVnYXRlCiAgICAgIGlmIChwYXJzZWRFeHByZXNzaW9uLiQkd2F0Y2hEZWxlZ2F0ZSAmJgogICAgICAgICAgcGFyc2VkRXhwcmVzc2lvbi4kJHdhdGNoRGVsZWdhdGUgIT09IGlucHV0c1dhdGNoRGVsZWdhdGUpIHsKICAgICAgICBmbi4kJHdhdGNoRGVsZWdhdGUgPSBwYXJzZWRFeHByZXNzaW9uLiQkd2F0Y2hEZWxlZ2F0ZTsKICAgICAgfSBlbHNlIGlmICghaW50ZXJjZXB0b3JGbi4kc3RhdGVmdWwpIHsKICAgICAgICAvLyBJZiB0aGVyZSBpcyBhbiBpbnRlcmNlcHRvciwgYnV0IG5vIHdhdGNoRGVsZWdhdGUgdGhlbiB0cmVhdCB0aGUgaW50ZXJjZXB0b3IgbGlrZQogICAgICAgIC8vIHdlIHRyZWF0IGZpbHRlcnMgLSBpdCBpcyBhc3N1bWVkIHRvIGJlIGEgcHVyZSBmdW5jdGlvbiB1bmxlc3MgZmxhZ2dlZCB3aXRoICRzdGF0ZWZ1bAogICAgICAgIGZuLiQkd2F0Y2hEZWxlZ2F0ZSA9IGlucHV0c1dhdGNoRGVsZWdhdGU7CiAgICAgICAgZm4uaW5wdXRzID0gW3BhcnNlZEV4cHJlc3Npb25dOwogICAgICB9CgogICAgICByZXR1cm4gZm47CiAgICB9CiAgfV07Cn0KCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkcQogKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogKgogKiBAZGVzY3JpcHRpb24KICogQSBwcm9taXNlL2RlZmVycmVkIGltcGxlbWVudGF0aW9uIGluc3BpcmVkIGJ5IFtLcmlzIEtvd2FsJ3MgUV0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xKS4KICoKICogJHEgY2FuIGJlIHVzZWQgaW4gdHdvIGZhc2hpb25zIC0tLSBvbmUgd2hpY2ggaXMgbW9yZSBzaW1pbGFyIHRvIEtyaXMgS293YWwncyBRIG9yIGpRdWVyeSdzIERlZmVycmVkCiAqIGltcGxlbWVudGF0aW9ucywgYW5kIHRoZSBvdGhlciB3aGljaCByZXNlbWJsZXMgRVM2IHByb21pc2VzIHRvIHNvbWUgZGVncmVlLgogKgogKiAjICRxIGNvbnN0cnVjdG9yCiAqCiAqIFRoZSBzdHJlYW1saW5lZCBFUzYgc3R5bGUgcHJvbWlzZSBpcyBlc3NlbnRpYWxseSBqdXN0IHVzaW5nICRxIGFzIGEgY29uc3RydWN0b3Igd2hpY2ggdGFrZXMgYSBgcmVzb2x2ZXJgCiAqIGZ1bmN0aW9uIGFzIHRoZSBmaXJzdCBhcmd1bWVudC4gVGhpcyBpcyBzaW1pbGFyIHRvIHRoZSBuYXRpdmUgUHJvbWlzZSBpbXBsZW1lbnRhdGlvbiBmcm9tIEVTNiBIYXJtb255LAogKiBzZWUgW01ETl0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvUHJvbWlzZSkuCiAqCiAqIFdoaWxlIHRoZSBjb25zdHJ1Y3Rvci1zdHlsZSB1c2UgaXMgc3VwcG9ydGVkLCBub3QgYWxsIG9mIHRoZSBzdXBwb3J0aW5nIG1ldGhvZHMgZnJvbSBFUzYgSGFybW9ueSBwcm9taXNlcyBhcmUKICogYXZhaWxhYmxlIHlldC4KICoKICogSXQgY2FuIGJlIHVzZWQgbGlrZSBzbzoKICoKICogYGBganMKICogICAvLyBmb3IgdGhlIHB1cnBvc2Ugb2YgdGhpcyBleGFtcGxlIGxldCdzIGFzc3VtZSB0aGF0IHZhcmlhYmxlcyBgJHFgIGFuZCBgb2tUb0dyZWV0YAogKiAgIC8vIGFyZSBhdmFpbGFibGUgaW4gdGhlIGN1cnJlbnQgbGV4aWNhbCBzY29wZSAodGhleSBjb3VsZCBoYXZlIGJlZW4gaW5qZWN0ZWQgb3IgcGFzc2VkIGluKS4KICoKICogICBmdW5jdGlvbiBhc3luY0dyZWV0KG5hbWUpIHsKICogICAgIC8vIHBlcmZvcm0gc29tZSBhc3luY2hyb25vdXMgb3BlcmF0aW9uLCByZXNvbHZlIG9yIHJlamVjdCB0aGUgcHJvbWlzZSB3aGVuIGFwcHJvcHJpYXRlLgogKiAgICAgcmV0dXJuICRxKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogKiAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogKiAgICAgICAgIGlmIChva1RvR3JlZXQobmFtZSkpIHsKICogICAgICAgICAgIHJlc29sdmUoJ0hlbGxvLCAnICsgbmFtZSArICchJyk7CiAqICAgICAgICAgfSBlbHNlIHsKICogICAgICAgICAgIHJlamVjdCgnR3JlZXRpbmcgJyArIG5hbWUgKyAnIGlzIG5vdCBhbGxvd2VkLicpOwogKiAgICAgICAgIH0KICogICAgICAgfSwgMTAwMCk7CiAqICAgICB9KTsKICogICB9CiAqCiAqICAgdmFyIHByb21pc2UgPSBhc3luY0dyZWV0KCdSb2JpbiBIb29kJyk7CiAqICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAqICAgICBhbGVydCgnU3VjY2VzczogJyArIGdyZWV0aW5nKTsKICogICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICogICAgIGFsZXJ0KCdGYWlsZWQ6ICcgKyByZWFzb24pOwogKiAgIH0pOwogKiBgYGAKICoKICogTm90ZTogcHJvZ3Jlc3Mvbm90aWZ5IGNhbGxiYWNrcyBhcmUgbm90IGN1cnJlbnRseSBzdXBwb3J0ZWQgdmlhIHRoZSBFUzYtc3R5bGUgaW50ZXJmYWNlLgogKgogKiBIb3dldmVyLCB0aGUgbW9yZSB0cmFkaXRpb25hbCBDb21tb25KUy1zdHlsZSB1c2FnZSBpcyBzdGlsbCBhdmFpbGFibGUsIGFuZCBkb2N1bWVudGVkIGJlbG93LgogKgogKiBbVGhlIENvbW1vbkpTIFByb21pc2UgcHJvcG9zYWxdKGh0dHA6Ly93aWtpLmNvbW1vbmpzLm9yZy93aWtpL1Byb21pc2VzKSBkZXNjcmliZXMgYSBwcm9taXNlIGFzIGFuCiAqIGludGVyZmFjZSBmb3IgaW50ZXJhY3Rpbmcgd2l0aCBhbiBvYmplY3QgdGhhdCByZXByZXNlbnRzIHRoZSByZXN1bHQgb2YgYW4gYWN0aW9uIHRoYXQgaXMKICogcGVyZm9ybWVkIGFzeW5jaHJvbm91c2x5LCBhbmQgbWF5IG9yIG1heSBub3QgYmUgZmluaXNoZWQgYXQgYW55IGdpdmVuIHBvaW50IGluIHRpbWUuCiAqCiAqIEZyb20gdGhlIHBlcnNwZWN0aXZlIG9mIGRlYWxpbmcgd2l0aCBlcnJvciBoYW5kbGluZywgZGVmZXJyZWQgYW5kIHByb21pc2UgQVBJcyBhcmUgdG8KICogYXN5bmNocm9ub3VzIHByb2dyYW1taW5nIHdoYXQgYHRyeWAsIGBjYXRjaGAgYW5kIGB0aHJvd2Aga2V5d29yZHMgYXJlIHRvIHN5bmNocm9ub3VzIHByb2dyYW1taW5nLgogKgogKiBgYGBqcwogKiAgIC8vIGZvciB0aGUgcHVycG9zZSBvZiB0aGlzIGV4YW1wbGUgbGV0J3MgYXNzdW1lIHRoYXQgdmFyaWFibGVzIGAkcWAgYW5kIGBva1RvR3JlZXRgCiAqICAgLy8gYXJlIGF2YWlsYWJsZSBpbiB0aGUgY3VycmVudCBsZXhpY2FsIHNjb3BlICh0aGV5IGNvdWxkIGhhdmUgYmVlbiBpbmplY3RlZCBvciBwYXNzZWQgaW4pLgogKgogKiAgIGZ1bmN0aW9uIGFzeW5jR3JlZXQobmFtZSkgewogKiAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTsKICoKICogICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAqICAgICAgIGRlZmVycmVkLm5vdGlmeSgnQWJvdXQgdG8gZ3JlZXQgJyArIG5hbWUgKyAnLicpOwogKgogKiAgICAgICBpZiAob2tUb0dyZWV0KG5hbWUpKSB7CiAqICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgnSGVsbG8sICcgKyBuYW1lICsgJyEnKTsKICogICAgICAgfSBlbHNlIHsKICogICAgICAgICBkZWZlcnJlZC5yZWplY3QoJ0dyZWV0aW5nICcgKyBuYW1lICsgJyBpcyBub3QgYWxsb3dlZC4nKTsKICogICAgICAgfQogKiAgICAgfSwgMTAwMCk7CiAqCiAqICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICogICB9CiAqCiAqICAgdmFyIHByb21pc2UgPSBhc3luY0dyZWV0KCdSb2JpbiBIb29kJyk7CiAqICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAqICAgICBhbGVydCgnU3VjY2VzczogJyArIGdyZWV0aW5nKTsKICogICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICogICAgIGFsZXJ0KCdGYWlsZWQ6ICcgKyByZWFzb24pOwogKiAgIH0sIGZ1bmN0aW9uKHVwZGF0ZSkgewogKiAgICAgYWxlcnQoJ0dvdCBub3RpZmljYXRpb246ICcgKyB1cGRhdGUpOwogKiAgIH0pOwogKiBgYGAKICoKICogQXQgZmlyc3QgaXQgbWlnaHQgbm90IGJlIG9idmlvdXMgd2h5IHRoaXMgZXh0cmEgY29tcGxleGl0eSBpcyB3b3J0aCB0aGUgdHJvdWJsZS4gVGhlIHBheW9mZgogKiBjb21lcyBpbiB0aGUgd2F5IG9mIGd1YXJhbnRlZXMgdGhhdCBwcm9taXNlIGFuZCBkZWZlcnJlZCBBUElzIG1ha2UsIHNlZQogKiBodHRwczovL2dpdGh1Yi5jb20va3Jpc2tvd2FsL3VuY29tbW9uanMvYmxvYi9tYXN0ZXIvcHJvbWlzZXMvc3BlY2lmaWNhdGlvbi5tZC4KICoKICogQWRkaXRpb25hbGx5IHRoZSBwcm9taXNlIGFwaSBhbGxvd3MgZm9yIGNvbXBvc2l0aW9uIHRoYXQgaXMgdmVyeSBoYXJkIHRvIGRvIHdpdGggdGhlCiAqIHRyYWRpdGlvbmFsIGNhbGxiYWNrIChbQ1BTXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0NvbnRpbnVhdGlvbi1wYXNzaW5nX3N0eWxlKSkgYXBwcm9hY2guCiAqIEZvciBtb3JlIG9uIHRoaXMgcGxlYXNlIHNlZSB0aGUgW1EgZG9jdW1lbnRhdGlvbl0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xKSBlc3BlY2lhbGx5IHRoZQogKiBzZWN0aW9uIG9uIHNlcmlhbCBvciBwYXJhbGxlbCBqb2luaW5nIG9mIHByb21pc2VzLgogKgogKiAjIFRoZSBEZWZlcnJlZCBBUEkKICoKICogQSBuZXcgaW5zdGFuY2Ugb2YgZGVmZXJyZWQgaXMgY29uc3RydWN0ZWQgYnkgY2FsbGluZyBgJHEuZGVmZXIoKWAuCiAqCiAqIFRoZSBwdXJwb3NlIG9mIHRoZSBkZWZlcnJlZCBvYmplY3QgaXMgdG8gZXhwb3NlIHRoZSBhc3NvY2lhdGVkIFByb21pc2UgaW5zdGFuY2UgYXMgd2VsbCBhcyBBUElzCiAqIHRoYXQgY2FuIGJlIHVzZWQgZm9yIHNpZ25hbGluZyB0aGUgc3VjY2Vzc2Z1bCBvciB1bnN1Y2Nlc3NmdWwgY29tcGxldGlvbiwgYXMgd2VsbCBhcyB0aGUgc3RhdHVzCiAqIG9mIHRoZSB0YXNrLgogKgogKiAqKk1ldGhvZHMqKgogKgogKiAtIGByZXNvbHZlKHZhbHVlKWAg4oCTIHJlc29sdmVzIHRoZSBkZXJpdmVkIHByb21pc2Ugd2l0aCB0aGUgYHZhbHVlYC4gSWYgdGhlIHZhbHVlIGlzIGEgcmVqZWN0aW9uCiAqICAgY29uc3RydWN0ZWQgdmlhIGAkcS5yZWplY3RgLCB0aGUgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIGluc3RlYWQuCiAqIC0gYHJlamVjdChyZWFzb24pYCDigJMgcmVqZWN0cyB0aGUgZGVyaXZlZCBwcm9taXNlIHdpdGggdGhlIGByZWFzb25gLiBUaGlzIGlzIGVxdWl2YWxlbnQgdG8KICogICByZXNvbHZpbmcgaXQgd2l0aCBhIHJlamVjdGlvbiBjb25zdHJ1Y3RlZCB2aWEgYCRxLnJlamVjdGAuCiAqIC0gYG5vdGlmeSh2YWx1ZSlgIC0gcHJvdmlkZXMgdXBkYXRlcyBvbiB0aGUgc3RhdHVzIG9mIHRoZSBwcm9taXNlJ3MgZXhlY3V0aW9uLiBUaGlzIG1heSBiZSBjYWxsZWQKICogICBtdWx0aXBsZSB0aW1lcyBiZWZvcmUgdGhlIHByb21pc2UgaXMgZWl0aGVyIHJlc29sdmVkIG9yIHJlamVjdGVkLgogKgogKiAqKlByb3BlcnRpZXMqKgogKgogKiAtIHByb21pc2Ug4oCTIGB7UHJvbWlzZX1gIOKAkyBwcm9taXNlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhpcyBkZWZlcnJlZC4KICoKICoKICogIyBUaGUgUHJvbWlzZSBBUEkKICoKICogQSBuZXcgcHJvbWlzZSBpbnN0YW5jZSBpcyBjcmVhdGVkIHdoZW4gYSBkZWZlcnJlZCBpbnN0YW5jZSBpcyBjcmVhdGVkIGFuZCBjYW4gYmUgcmV0cmlldmVkIGJ5CiAqIGNhbGxpbmcgYGRlZmVycmVkLnByb21pc2VgLgogKgogKiBUaGUgcHVycG9zZSBvZiB0aGUgcHJvbWlzZSBvYmplY3QgaXMgdG8gYWxsb3cgZm9yIGludGVyZXN0ZWQgcGFydGllcyB0byBnZXQgYWNjZXNzIHRvIHRoZSByZXN1bHQKICogb2YgdGhlIGRlZmVycmVkIHRhc2sgd2hlbiBpdCBjb21wbGV0ZXMuCiAqCiAqICoqTWV0aG9kcyoqCiAqCiAqIC0gYHRoZW4oc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrLCBub3RpZnlDYWxsYmFjaylgIOKAkyByZWdhcmRsZXNzIG9mIHdoZW4gdGhlIHByb21pc2Ugd2FzIG9yCiAqICAgd2lsbCBiZSByZXNvbHZlZCBvciByZWplY3RlZCwgYHRoZW5gIGNhbGxzIG9uZSBvZiB0aGUgc3VjY2VzcyBvciBlcnJvciBjYWxsYmFja3MgYXN5bmNocm9ub3VzbHkKICogICBhcyBzb29uIGFzIHRoZSByZXN1bHQgaXMgYXZhaWxhYmxlLiBUaGUgY2FsbGJhY2tzIGFyZSBjYWxsZWQgd2l0aCBhIHNpbmdsZSBhcmd1bWVudDogdGhlIHJlc3VsdAogKiAgIG9yIHJlamVjdGlvbiByZWFzb24uIEFkZGl0aW9uYWxseSwgdGhlIG5vdGlmeSBjYWxsYmFjayBtYXkgYmUgY2FsbGVkIHplcm8gb3IgbW9yZSB0aW1lcyB0bwogKiAgIHByb3ZpZGUgYSBwcm9ncmVzcyBpbmRpY2F0aW9uLCBiZWZvcmUgdGhlIHByb21pc2UgaXMgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQuCiAqCiAqICAgVGhpcyBtZXRob2QgKnJldHVybnMgYSBuZXcgcHJvbWlzZSogd2hpY2ggaXMgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQgdmlhIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlCiAqICAgYHN1Y2Nlc3NDYWxsYmFja2AsIGBlcnJvckNhbGxiYWNrYC4gSXQgYWxzbyBub3RpZmllcyB2aWEgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUKICogICBgbm90aWZ5Q2FsbGJhY2tgIG1ldGhvZC4gVGhlIHByb21pc2UgY2Fubm90IGJlIHJlc29sdmVkIG9yIHJlamVjdGVkIGZyb20gdGhlIG5vdGlmeUNhbGxiYWNrCiAqICAgbWV0aG9kLgogKgogKiAtIGBjYXRjaChlcnJvckNhbGxiYWNrKWAg4oCTIHNob3J0aGFuZCBmb3IgYHByb21pc2UudGhlbihudWxsLCBlcnJvckNhbGxiYWNrKWAKICoKICogLSBgZmluYWxseShjYWxsYmFjaylgIOKAkyBhbGxvd3MgeW91IHRvIG9ic2VydmUgZWl0aGVyIHRoZSBmdWxmaWxsbWVudCBvciByZWplY3Rpb24gb2YgYSBwcm9taXNlLAogKiAgIGJ1dCB0byBkbyBzbyB3aXRob3V0IG1vZGlmeWluZyB0aGUgZmluYWwgdmFsdWUuIFRoaXMgaXMgdXNlZnVsIHRvIHJlbGVhc2UgcmVzb3VyY2VzIG9yIGRvIHNvbWUKICogICBjbGVhbi11cCB0aGF0IG5lZWRzIHRvIGJlIGRvbmUgd2hldGhlciB0aGUgcHJvbWlzZSB3YXMgcmVqZWN0ZWQgb3IgcmVzb2x2ZWQuIFNlZSB0aGUgW2Z1bGwKICogICBzcGVjaWZpY2F0aW9uXShodHRwczovL2dpdGh1Yi5jb20va3Jpc2tvd2FsL3Evd2lraS9BUEktUmVmZXJlbmNlI3Byb21pc2VmaW5hbGx5Y2FsbGJhY2spIGZvcgogKiAgIG1vcmUgaW5mb3JtYXRpb24uCiAqCiAqICAgQmVjYXVzZSBgZmluYWxseWAgaXMgYSByZXNlcnZlZCB3b3JkIGluIEphdmFTY3JpcHQgYW5kIHJlc2VydmVkIGtleXdvcmRzIGFyZSBub3Qgc3VwcG9ydGVkIGFzCiAqICAgcHJvcGVydHkgbmFtZXMgYnkgRVMzLCB5b3UnbGwgbmVlZCB0byBpbnZva2UgdGhlIG1ldGhvZCBsaWtlIGBwcm9taXNlWydmaW5hbGx5J10oY2FsbGJhY2spYCB0bwogKiAgIG1ha2UgeW91ciBjb2RlIElFOCBhbmQgQW5kcm9pZCAyLnggY29tcGF0aWJsZS4KICoKICogIyBDaGFpbmluZyBwcm9taXNlcwogKgogKiBCZWNhdXNlIGNhbGxpbmcgdGhlIGB0aGVuYCBtZXRob2Qgb2YgYSBwcm9taXNlIHJldHVybnMgYSBuZXcgZGVyaXZlZCBwcm9taXNlLCBpdCBpcyBlYXNpbHkKICogcG9zc2libGUgdG8gY3JlYXRlIGEgY2hhaW4gb2YgcHJvbWlzZXM6CiAqCiAqIGBgYGpzCiAqICAgcHJvbWlzZUIgPSBwcm9taXNlQS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogKiAgICAgcmV0dXJuIHJlc3VsdCArIDE7CiAqICAgfSk7CiAqCiAqICAgLy8gcHJvbWlzZUIgd2lsbCBiZSByZXNvbHZlZCBpbW1lZGlhdGVseSBhZnRlciBwcm9taXNlQSBpcyByZXNvbHZlZCBhbmQgaXRzIHZhbHVlCiAqICAgLy8gd2lsbCBiZSB0aGUgcmVzdWx0IG9mIHByb21pc2VBIGluY3JlbWVudGVkIGJ5IDEKICogYGBgCiAqCiAqIEl0IGlzIHBvc3NpYmxlIHRvIGNyZWF0ZSBjaGFpbnMgb2YgYW55IGxlbmd0aCBhbmQgc2luY2UgYSBwcm9taXNlIGNhbiBiZSByZXNvbHZlZCB3aXRoIGFub3RoZXIKICogcHJvbWlzZSAod2hpY2ggd2lsbCBkZWZlciBpdHMgcmVzb2x1dGlvbiBmdXJ0aGVyKSwgaXQgaXMgcG9zc2libGUgdG8gcGF1c2UvZGVmZXIgcmVzb2x1dGlvbiBvZgogKiB0aGUgcHJvbWlzZXMgYXQgYW55IHBvaW50IGluIHRoZSBjaGFpbi4gVGhpcyBtYWtlcyBpdCBwb3NzaWJsZSB0byBpbXBsZW1lbnQgcG93ZXJmdWwgQVBJcyBsaWtlCiAqICRodHRwJ3MgcmVzcG9uc2UgaW50ZXJjZXB0b3JzLgogKgogKgogKiAjIERpZmZlcmVuY2VzIGJldHdlZW4gS3JpcyBLb3dhbCdzIFEgYW5kICRxCiAqCiAqICBUaGVyZSBhcmUgdHdvIG1haW4gZGlmZmVyZW5jZXM6CiAqCiAqIC0gJHEgaXMgaW50ZWdyYXRlZCB3aXRoIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZX0gU2NvcGUgbW9kZWwgb2JzZXJ2YXRpb24KICogICBtZWNoYW5pc20gaW4gYW5ndWxhciwgd2hpY2ggbWVhbnMgZmFzdGVyIHByb3BhZ2F0aW9uIG9mIHJlc29sdXRpb24gb3IgcmVqZWN0aW9uIGludG8geW91cgogKiAgIG1vZGVscyBhbmQgYXZvaWRpbmcgdW5uZWNlc3NhcnkgYnJvd3NlciByZXBhaW50cywgd2hpY2ggd291bGQgcmVzdWx0IGluIGZsaWNrZXJpbmcgVUkuCiAqIC0gUSBoYXMgbWFueSBtb3JlIGZlYXR1cmVzIHRoYW4gJHEsIGJ1dCB0aGF0IGNvbWVzIGF0IGEgY29zdCBvZiBieXRlcy4gJHEgaXMgdGlueSwgYnV0IGNvbnRhaW5zCiAqICAgYWxsIHRoZSBpbXBvcnRhbnQgZnVuY3Rpb25hbGl0eSBuZWVkZWQgZm9yIGNvbW1vbiBhc3luYyB0YXNrcy4KICoKICogICMgVGVzdGluZwogKgogKiAgYGBganMKICogICAgaXQoJ3Nob3VsZCBzaW11bGF0ZSBwcm9taXNlJywgaW5qZWN0KGZ1bmN0aW9uKCRxLCAkcm9vdFNjb3BlKSB7CiAqICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTsKICogICAgICB2YXIgcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2U7CiAqICAgICAgdmFyIHJlc29sdmVkVmFsdWU7CiAqCiAqICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7IHJlc29sdmVkVmFsdWUgPSB2YWx1ZTsgfSk7CiAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvQmVVbmRlZmluZWQoKTsKICoKICogICAgICAvLyBTaW11bGF0ZSByZXNvbHZpbmcgb2YgcHJvbWlzZQogKiAgICAgIGRlZmVycmVkLnJlc29sdmUoMTIzKTsKICogICAgICAvLyBOb3RlIHRoYXQgdGhlICd0aGVuJyBmdW5jdGlvbiBkb2VzIG5vdCBnZXQgY2FsbGVkIHN5bmNocm9ub3VzbHkuCiAqICAgICAgLy8gVGhpcyBpcyBiZWNhdXNlIHdlIHdhbnQgdGhlIHByb21pc2UgQVBJIHRvIGFsd2F5cyBiZSBhc3luYywgd2hldGhlciBvciBub3QKICogICAgICAvLyBpdCBnb3QgY2FsbGVkIHN5bmNocm9ub3VzbHkgb3IgYXN5bmNocm9ub3VzbHkuCiAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvQmVVbmRlZmluZWQoKTsKICoKICogICAgICAvLyBQcm9wYWdhdGUgcHJvbWlzZSByZXNvbHV0aW9uIHRvICd0aGVuJyBmdW5jdGlvbnMgdXNpbmcgJGFwcGx5KCkuCiAqICAgICAgJHJvb3RTY29wZS4kYXBwbHkoKTsKICogICAgICBleHBlY3QocmVzb2x2ZWRWYWx1ZSkudG9FcXVhbCgxMjMpOwogKiAgICB9KSk7CiAqICBgYGAKICoKICogQHBhcmFtIHtmdW5jdGlvbihmdW5jdGlvbiwgZnVuY3Rpb24pfSByZXNvbHZlciBGdW5jdGlvbiB3aGljaCBpcyByZXNwb25zaWJsZSBmb3IgcmVzb2x2aW5nIG9yCiAqICAgcmVqZWN0aW5nIHRoZSBuZXdseSBjcmVhdGVkIHByb21pc2UuIFRoZSBmaXJzdCBwYXJhbWV0ZXIgaXMgYSBmdW5jdGlvbiB3aGljaCByZXNvbHZlcyB0aGUKICogICBwcm9taXNlLCB0aGUgc2Vjb25kIHBhcmFtZXRlciBpcyBhIGZ1bmN0aW9uIHdoaWNoIHJlamVjdHMgdGhlIHByb21pc2UuCiAqCiAqIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgbmV3bHkgY3JlYXRlZCBwcm9taXNlLgogKi8KZnVuY3Rpb24gJFFQcm92aWRlcigpIHsKCiAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRleGNlcHRpb25IYW5kbGVyJywgZnVuY3Rpb24oJHJvb3RTY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgIHJldHVybiBxRmFjdG9yeShmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoY2FsbGJhY2spOwogICAgfSwgJGV4Y2VwdGlvbkhhbmRsZXIpOwogIH1dOwp9CgpmdW5jdGlvbiAkJFFQcm92aWRlcigpIHsKICB0aGlzLiRnZXQgPSBbJyRicm93c2VyJywgJyRleGNlcHRpb25IYW5kbGVyJywgZnVuY3Rpb24oJGJyb3dzZXIsICRleGNlcHRpb25IYW5kbGVyKSB7CiAgICByZXR1cm4gcUZhY3RvcnkoZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgJGJyb3dzZXIuZGVmZXIoY2FsbGJhY2spOwogICAgfSwgJGV4Y2VwdGlvbkhhbmRsZXIpOwogIH1dOwp9CgovKioKICogQ29uc3RydWN0cyBhIHByb21pc2UgbWFuYWdlci4KICoKICogQHBhcmFtIHtmdW5jdGlvbihmdW5jdGlvbil9IG5leHRUaWNrIEZ1bmN0aW9uIGZvciBleGVjdXRpbmcgZnVuY3Rpb25zIGluIHRoZSBuZXh0IHR1cm4uCiAqIEBwYXJhbSB7ZnVuY3Rpb24oLi4uKil9IGV4Y2VwdGlvbkhhbmRsZXIgRnVuY3Rpb24gaW50byB3aGljaCB1bmV4cGVjdGVkIGV4Y2VwdGlvbnMgYXJlIHBhc3NlZCBmb3IKICogICAgIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICogQHJldHVybnMge29iamVjdH0gUHJvbWlzZSBtYW5hZ2VyLgogKi8KZnVuY3Rpb24gcUZhY3RvcnkobmV4dFRpY2ssIGV4Y2VwdGlvbkhhbmRsZXIpIHsKICB2YXIgJHFNaW5FcnIgPSBtaW5FcnIoJyRxJywgVHlwZUVycm9yKTsKICBmdW5jdGlvbiBjYWxsT25jZShzZWxmLCByZXNvbHZlRm4sIHJlamVjdEZuKSB7CiAgICB2YXIgY2FsbGVkID0gZmFsc2U7CiAgICBmdW5jdGlvbiB3cmFwKGZuKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmIChjYWxsZWQpIHJldHVybjsKICAgICAgICBjYWxsZWQgPSB0cnVlOwogICAgICAgIGZuLmNhbGwoc2VsZiwgdmFsdWUpOwogICAgICB9OwogICAgfQoKICAgIHJldHVybiBbd3JhcChyZXNvbHZlRm4pLCB3cmFwKHJlamVjdEZuKV07CiAgfQoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgbmcuJHEjZGVmZXIKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ3JlYXRlcyBhIGBEZWZlcnJlZGAgb2JqZWN0IHdoaWNoIHJlcHJlc2VudHMgYSB0YXNrIHdoaWNoIHdpbGwgZmluaXNoIGluIHRoZSBmdXR1cmUuCiAgICoKICAgKiBAcmV0dXJucyB7RGVmZXJyZWR9IFJldHVybnMgYSBuZXcgaW5zdGFuY2Ugb2YgZGVmZXJyZWQuCiAgICovCiAgdmFyIGRlZmVyID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IERlZmVycmVkKCk7CiAgfTsKCiAgZnVuY3Rpb24gUHJvbWlzZSgpIHsKICAgIHRoaXMuJCRzdGF0ZSA9IHsgc3RhdHVzOiAwIH07CiAgfQoKICBQcm9taXNlLnByb3RvdHlwZSA9IHsKICAgIHRoZW46IGZ1bmN0aW9uKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBwcm9ncmVzc0JhY2spIHsKICAgICAgdmFyIHJlc3VsdCA9IG5ldyBEZWZlcnJlZCgpOwoKICAgICAgdGhpcy4kJHN0YXRlLnBlbmRpbmcgPSB0aGlzLiQkc3RhdGUucGVuZGluZyB8fCBbXTsKICAgICAgdGhpcy4kJHN0YXRlLnBlbmRpbmcucHVzaChbcmVzdWx0LCBvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgcHJvZ3Jlc3NCYWNrXSk7CiAgICAgIGlmICh0aGlzLiQkc3RhdGUuc3RhdHVzID4gMCkgc2NoZWR1bGVQcm9jZXNzUXVldWUodGhpcy4kJHN0YXRlKTsKCiAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgIH0sCgogICAgImNhdGNoIjogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMudGhlbihudWxsLCBjYWxsYmFjayk7CiAgICB9LAoKICAgICJmaW5hbGx5IjogZnVuY3Rpb24oY2FsbGJhY2ssIHByb2dyZXNzQmFjaykgewogICAgICByZXR1cm4gdGhpcy50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGhhbmRsZUNhbGxiYWNrKHZhbHVlLCB0cnVlLCBjYWxsYmFjayk7CiAgICAgIH0sIGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgcmV0dXJuIGhhbmRsZUNhbGxiYWNrKGVycm9yLCBmYWxzZSwgY2FsbGJhY2spOwogICAgICB9LCBwcm9ncmVzc0JhY2spOwogICAgfQogIH07CgogIC8vRmFzdGVyLCBtb3JlIGJhc2ljIHRoYW4gYW5ndWxhci5iaW5kIGh0dHA6Ly9qc3BlcmYuY29tL2FuZ3VsYXItYmluZC12cy1jdXN0b20tdnMtbmF0aXZlCiAgZnVuY3Rpb24gc2ltcGxlQmluZChjb250ZXh0LCBmbikgewogICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGZuLmNhbGwoY29udGV4dCwgdmFsdWUpOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NRdWV1ZShzdGF0ZSkgewogICAgdmFyIGZuLCBwcm9taXNlLCBwZW5kaW5nOwoKICAgIHBlbmRpbmcgPSBzdGF0ZS5wZW5kaW5nOwogICAgc3RhdGUucHJvY2Vzc1NjaGVkdWxlZCA9IGZhbHNlOwogICAgc3RhdGUucGVuZGluZyA9IHVuZGVmaW5lZDsKICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IHBlbmRpbmcubGVuZ3RoOyBpIDwgaWk7ICsraSkgewogICAgICBwcm9taXNlID0gcGVuZGluZ1tpXVswXTsKICAgICAgZm4gPSBwZW5kaW5nW2ldW3N0YXRlLnN0YXR1c107CiAgICAgIHRyeSB7CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm4pKSB7CiAgICAgICAgICBwcm9taXNlLnJlc29sdmUoZm4oc3RhdGUudmFsdWUpKTsKICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLnN0YXR1cyA9PT0gMSkgewogICAgICAgICAgcHJvbWlzZS5yZXNvbHZlKHN0YXRlLnZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcHJvbWlzZS5yZWplY3Qoc3RhdGUudmFsdWUpOwogICAgICAgIH0KICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgcHJvbWlzZS5yZWplY3QoZSk7CiAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gc2NoZWR1bGVQcm9jZXNzUXVldWUoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5wcm9jZXNzU2NoZWR1bGVkIHx8ICFzdGF0ZS5wZW5kaW5nKSByZXR1cm47CiAgICBzdGF0ZS5wcm9jZXNzU2NoZWR1bGVkID0gdHJ1ZTsKICAgIG5leHRUaWNrKGZ1bmN0aW9uKCkgeyBwcm9jZXNzUXVldWUoc3RhdGUpOyB9KTsKICB9CgogIGZ1bmN0aW9uIERlZmVycmVkKCkgewogICAgdGhpcy5wcm9taXNlID0gbmV3IFByb21pc2UoKTsKICAgIC8vTmVjZXNzYXJ5IHRvIHN1cHBvcnQgdW5ib3VuZCBleGVjdXRpb24gOi8KICAgIHRoaXMucmVzb2x2ZSA9IHNpbXBsZUJpbmQodGhpcywgdGhpcy5yZXNvbHZlKTsKICAgIHRoaXMucmVqZWN0ID0gc2ltcGxlQmluZCh0aGlzLCB0aGlzLnJlamVjdCk7CiAgICB0aGlzLm5vdGlmeSA9IHNpbXBsZUJpbmQodGhpcywgdGhpcy5ub3RpZnkpOwogIH0KCiAgRGVmZXJyZWQucHJvdG90eXBlID0gewogICAgcmVzb2x2ZTogZnVuY3Rpb24odmFsKSB7CiAgICAgIGlmICh0aGlzLnByb21pc2UuJCRzdGF0ZS5zdGF0dXMpIHJldHVybjsKICAgICAgaWYgKHZhbCA9PT0gdGhpcy5wcm9taXNlKSB7CiAgICAgICAgdGhpcy4kJHJlamVjdCgkcU1pbkVycigKICAgICAgICAgICdxY3ljbGUnLAogICAgICAgICAgIkV4cGVjdGVkIHByb21pc2UgdG8gYmUgcmVzb2x2ZWQgd2l0aCB2YWx1ZSBvdGhlciB0aGFuIGl0c2VsZiAnezB9JyIsCiAgICAgICAgICB2YWwpKTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICB0aGlzLiQkcmVzb2x2ZSh2YWwpOwogICAgICB9CgogICAgfSwKCiAgICAkJHJlc29sdmU6IGZ1bmN0aW9uKHZhbCkgewogICAgICB2YXIgdGhlbiwgZm5zOwoKICAgICAgZm5zID0gY2FsbE9uY2UodGhpcywgdGhpcy4kJHJlc29sdmUsIHRoaXMuJCRyZWplY3QpOwogICAgICB0cnkgewogICAgICAgIGlmICgoaXNPYmplY3QodmFsKSB8fCBpc0Z1bmN0aW9uKHZhbCkpKSB0aGVuID0gdmFsICYmIHZhbC50aGVuOwogICAgICAgIGlmIChpc0Z1bmN0aW9uKHRoZW4pKSB7CiAgICAgICAgICB0aGlzLnByb21pc2UuJCRzdGF0ZS5zdGF0dXMgPSAtMTsKICAgICAgICAgIHRoZW4uY2FsbCh2YWwsIGZuc1swXSwgZm5zWzFdLCB0aGlzLm5vdGlmeSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMucHJvbWlzZS4kJHN0YXRlLnZhbHVlID0gdmFsOwogICAgICAgICAgdGhpcy5wcm9taXNlLiQkc3RhdGUuc3RhdHVzID0gMTsKICAgICAgICAgIHNjaGVkdWxlUHJvY2Vzc1F1ZXVlKHRoaXMucHJvbWlzZS4kJHN0YXRlKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIGZuc1sxXShlKTsKICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICB9CiAgICB9LAoKICAgIHJlamVjdDogZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgIGlmICh0aGlzLnByb21pc2UuJCRzdGF0ZS5zdGF0dXMpIHJldHVybjsKICAgICAgdGhpcy4kJHJlamVjdChyZWFzb24pOwogICAgfSwKCiAgICAkJHJlamVjdDogZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgIHRoaXMucHJvbWlzZS4kJHN0YXRlLnZhbHVlID0gcmVhc29uOwogICAgICB0aGlzLnByb21pc2UuJCRzdGF0ZS5zdGF0dXMgPSAyOwogICAgICBzY2hlZHVsZVByb2Nlc3NRdWV1ZSh0aGlzLnByb21pc2UuJCRzdGF0ZSk7CiAgICB9LAoKICAgIG5vdGlmeTogZnVuY3Rpb24ocHJvZ3Jlc3MpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMucHJvbWlzZS4kJHN0YXRlLnBlbmRpbmc7CgogICAgICBpZiAoKHRoaXMucHJvbWlzZS4kJHN0YXRlLnN0YXR1cyA8PSAwKSAmJiBjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmxlbmd0aCkgewogICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGNhbGxiYWNrLCByZXN1bHQ7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBjYWxsYmFja3MubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICByZXN1bHQgPSBjYWxsYmFja3NbaV1bMF07CiAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2tzW2ldWzNdOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJlc3VsdC5ub3RpZnkoaXNGdW5jdGlvbihjYWxsYmFjaykgPyBjYWxsYmFjayhwcm9ncmVzcykgOiBwcm9ncmVzcyk7CiAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkcSNyZWplY3QKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ3JlYXRlcyBhIHByb21pc2UgdGhhdCBpcyByZXNvbHZlZCBhcyByZWplY3RlZCB3aXRoIHRoZSBzcGVjaWZpZWQgYHJlYXNvbmAuIFRoaXMgYXBpIHNob3VsZCBiZQogICAqIHVzZWQgdG8gZm9yd2FyZCByZWplY3Rpb24gaW4gYSBjaGFpbiBvZiBwcm9taXNlcy4gSWYgeW91IGFyZSBkZWFsaW5nIHdpdGggdGhlIGxhc3QgcHJvbWlzZSBpbgogICAqIGEgcHJvbWlzZSBjaGFpbiwgeW91IGRvbid0IG5lZWQgdG8gd29ycnkgYWJvdXQgaXQuCiAgICoKICAgKiBXaGVuIGNvbXBhcmluZyBkZWZlcnJlZHMvcHJvbWlzZXMgdG8gdGhlIGZhbWlsaWFyIGJlaGF2aW9yIG9mIHRyeS9jYXRjaC90aHJvdywgdGhpbmsgb2YKICAgKiBgcmVqZWN0YCBhcyB0aGUgYHRocm93YCBrZXl3b3JkIGluIEphdmFTY3JpcHQuIFRoaXMgYWxzbyBtZWFucyB0aGF0IGlmIHlvdSAiY2F0Y2giIGFuIGVycm9yIHZpYQogICAqIGEgcHJvbWlzZSBlcnJvciBjYWxsYmFjayBhbmQgeW91IHdhbnQgdG8gZm9yd2FyZCB0aGUgZXJyb3IgdG8gdGhlIHByb21pc2UgZGVyaXZlZCBmcm9tIHRoZQogICAqIGN1cnJlbnQgcHJvbWlzZSwgeW91IGhhdmUgdG8gInJldGhyb3ciIHRoZSBlcnJvciBieSByZXR1cm5pbmcgYSByZWplY3Rpb24gY29uc3RydWN0ZWQgdmlhCiAgICogYHJlamVjdGAuCiAgICoKICAgKiBgYGBqcwogICAqICAgcHJvbWlzZUIgPSBwcm9taXNlQS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAqICAgICAvLyBzdWNjZXNzOiBkbyBzb21ldGhpbmcgYW5kIHJlc29sdmUgcHJvbWlzZUIKICAgKiAgICAgLy8gICAgICAgICAgd2l0aCB0aGUgb2xkIG9yIGEgbmV3IHJlc3VsdAogICAqICAgICByZXR1cm4gcmVzdWx0OwogICAqICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICogICAgIC8vIGVycm9yOiBoYW5kbGUgdGhlIGVycm9yIGlmIHBvc3NpYmxlIGFuZAogICAqICAgICAvLyAgICAgICAgcmVzb2x2ZSBwcm9taXNlQiB3aXRoIG5ld1Byb21pc2VPclZhbHVlLAogICAqICAgICAvLyAgICAgICAgb3RoZXJ3aXNlIGZvcndhcmQgdGhlIHJlamVjdGlvbiB0byBwcm9taXNlQgogICAqICAgICBpZiAoY2FuSGFuZGxlKHJlYXNvbikpIHsKICAgKiAgICAgIC8vIGhhbmRsZSB0aGUgZXJyb3IgYW5kIHJlY292ZXIKICAgKiAgICAgIHJldHVybiBuZXdQcm9taXNlT3JWYWx1ZTsKICAgKiAgICAgfQogICAqICAgICByZXR1cm4gJHEucmVqZWN0KHJlYXNvbik7CiAgICogICB9KTsKICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7Kn0gcmVhc29uIENvbnN0YW50LCBtZXNzYWdlLCBleGNlcHRpb24gb3IgYW4gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcmVqZWN0aW9uIHJlYXNvbi4KICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHByb21pc2UgdGhhdCB3YXMgYWxyZWFkeSByZXNvbHZlZCBhcyByZWplY3RlZCB3aXRoIHRoZSBgcmVhc29uYC4KICAgKi8KICB2YXIgcmVqZWN0ID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICB2YXIgcmVzdWx0ID0gbmV3IERlZmVycmVkKCk7CiAgICByZXN1bHQucmVqZWN0KHJlYXNvbik7CiAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgfTsKCiAgdmFyIG1ha2VQcm9taXNlID0gZnVuY3Rpb24gbWFrZVByb21pc2UodmFsdWUsIHJlc29sdmVkKSB7CiAgICB2YXIgcmVzdWx0ID0gbmV3IERlZmVycmVkKCk7CiAgICBpZiAocmVzb2x2ZWQpIHsKICAgICAgcmVzdWx0LnJlc29sdmUodmFsdWUpOwogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0LnJlamVjdCh2YWx1ZSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgfTsKCiAgdmFyIGhhbmRsZUNhbGxiYWNrID0gZnVuY3Rpb24gaGFuZGxlQ2FsbGJhY2sodmFsdWUsIGlzUmVzb2x2ZWQsIGNhbGxiYWNrKSB7CiAgICB2YXIgY2FsbGJhY2tPdXRwdXQgPSBudWxsOwogICAgdHJ5IHsKICAgICAgaWYgKGlzRnVuY3Rpb24oY2FsbGJhY2spKSBjYWxsYmFja091dHB1dCA9IGNhbGxiYWNrKCk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgcmV0dXJuIG1ha2VQcm9taXNlKGUsIGZhbHNlKTsKICAgIH0KICAgIGlmIChpc1Byb21pc2VMaWtlKGNhbGxiYWNrT3V0cHV0KSkgewogICAgICByZXR1cm4gY2FsbGJhY2tPdXRwdXQudGhlbihmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbWFrZVByb21pc2UodmFsdWUsIGlzUmVzb2x2ZWQpOwogICAgICB9LCBmdW5jdGlvbihlcnJvcikgewogICAgICAgIHJldHVybiBtYWtlUHJvbWlzZShlcnJvciwgZmFsc2UpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBtYWtlUHJvbWlzZSh2YWx1ZSwgaXNSZXNvbHZlZCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRxI3doZW4KICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogV3JhcHMgYW4gb2JqZWN0IHRoYXQgbWlnaHQgYmUgYSB2YWx1ZSBvciBhICgzcmQgcGFydHkpIHRoZW4tYWJsZSBwcm9taXNlIGludG8gYSAkcSBwcm9taXNlLgogICAqIFRoaXMgaXMgdXNlZnVsIHdoZW4geW91IGFyZSBkZWFsaW5nIHdpdGggYW4gb2JqZWN0IHRoYXQgbWlnaHQgb3IgbWlnaHQgbm90IGJlIGEgcHJvbWlzZSwgb3IgaWYKICAgKiB0aGUgcHJvbWlzZSBjb21lcyBmcm9tIGEgc291cmNlIHRoYXQgY2FuJ3QgYmUgdHJ1c3RlZC4KICAgKgogICAqIEBwYXJhbSB7Kn0gdmFsdWUgVmFsdWUgb3IgYSBwcm9taXNlCiAgICogQHJldHVybnMge1Byb21pc2V9IFJldHVybnMgYSBwcm9taXNlIG9mIHRoZSBwYXNzZWQgdmFsdWUgb3IgcHJvbWlzZQogICAqLwoKCiAgdmFyIHdoZW4gPSBmdW5jdGlvbih2YWx1ZSwgY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzQmFjaykgewogICAgdmFyIHJlc3VsdCA9IG5ldyBEZWZlcnJlZCgpOwogICAgcmVzdWx0LnJlc29sdmUodmFsdWUpOwogICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlLnRoZW4oY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzQmFjayk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRxI2FsbAogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDb21iaW5lcyBtdWx0aXBsZSBwcm9taXNlcyBpbnRvIGEgc2luZ2xlIHByb21pc2UgdGhhdCBpcyByZXNvbHZlZCB3aGVuIGFsbCBvZiB0aGUgaW5wdXQKICAgKiBwcm9taXNlcyBhcmUgcmVzb2x2ZWQuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5LjxQcm9taXNlPnxPYmplY3QuPFByb21pc2U+fSBwcm9taXNlcyBBbiBhcnJheSBvciBoYXNoIG9mIHByb21pc2VzLgogICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgc2luZ2xlIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdpdGggYW4gYXJyYXkvaGFzaCBvZiB2YWx1ZXMsCiAgICogICBlYWNoIHZhbHVlIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHByb21pc2UgYXQgdGhlIHNhbWUgaW5kZXgva2V5IGluIHRoZSBgcHJvbWlzZXNgIGFycmF5L2hhc2guCiAgICogICBJZiBhbnkgb2YgdGhlIHByb21pc2VzIGlzIHJlc29sdmVkIHdpdGggYSByZWplY3Rpb24sIHRoaXMgcmVzdWx0aW5nIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZAogICAqICAgd2l0aCB0aGUgc2FtZSByZWplY3Rpb24gdmFsdWUuCiAgICovCgogIGZ1bmN0aW9uIGFsbChwcm9taXNlcykgewogICAgdmFyIGRlZmVycmVkID0gbmV3IERlZmVycmVkKCksCiAgICAgICAgY291bnRlciA9IDAsCiAgICAgICAgcmVzdWx0cyA9IGlzQXJyYXkocHJvbWlzZXMpID8gW10gOiB7fTsKCiAgICBmb3JFYWNoKHByb21pc2VzLCBmdW5jdGlvbihwcm9taXNlLCBrZXkpIHsKICAgICAgY291bnRlcisrOwogICAgICB3aGVuKHByb21pc2UpLnRoZW4oZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAocmVzdWx0cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXR1cm47CiAgICAgICAgcmVzdWx0c1trZXldID0gdmFsdWU7CiAgICAgICAgaWYgKCEoLS1jb3VudGVyKSkgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgaWYgKHJlc3VsdHMuaGFzT3duUHJvcGVydHkoa2V5KSkgcmV0dXJuOwogICAgICAgIGRlZmVycmVkLnJlamVjdChyZWFzb24pOwogICAgICB9KTsKICAgIH0pOwoKICAgIGlmIChjb3VudGVyID09PSAwKSB7CiAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzdWx0cyk7CiAgICB9CgogICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgfQoKICB2YXIgJFEgPSBmdW5jdGlvbiBRKHJlc29sdmVyKSB7CiAgICBpZiAoIWlzRnVuY3Rpb24ocmVzb2x2ZXIpKSB7CiAgICAgIHRocm93ICRxTWluRXJyKCdub3JzbHZyJywgIkV4cGVjdGVkIHJlc29sdmVyRm4sIGdvdCAnezB9JyIsIHJlc29sdmVyKTsKICAgIH0KCiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUSkpIHsKICAgICAgLy8gTW9yZSB1c2VmdWwgd2hlbiAkUSBpcyB0aGUgUHJvbWlzZSBpdHNlbGYuCiAgICAgIHJldHVybiBuZXcgUShyZXNvbHZlcik7CiAgICB9CgogICAgdmFyIGRlZmVycmVkID0gbmV3IERlZmVycmVkKCk7CgogICAgZnVuY3Rpb24gcmVzb2x2ZUZuKHZhbHVlKSB7CiAgICAgIGRlZmVycmVkLnJlc29sdmUodmFsdWUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlamVjdEZuKHJlYXNvbikgewogICAgICBkZWZlcnJlZC5yZWplY3QocmVhc29uKTsKICAgIH0KCiAgICByZXNvbHZlcihyZXNvbHZlRm4sIHJlamVjdEZuKTsKCiAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICB9OwoKICAkUS5kZWZlciA9IGRlZmVyOwogICRRLnJlamVjdCA9IHJlamVjdDsKICAkUS53aGVuID0gd2hlbjsKICAkUS5hbGwgPSBhbGw7CgogIHJldHVybiAkUTsKfQoKZnVuY3Rpb24gJCRSQUZQcm92aWRlcigpeyAvL3JBRgogIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckdGltZW91dCcsIGZ1bmN0aW9uKCR3aW5kb3csICR0aW1lb3V0KSB7CiAgICB2YXIgcmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gJHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3aW5kb3cubW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lOwoKICAgIHZhciBjYW5jZWxBbmltYXRpb25GcmFtZSA9ICR3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3aW5kb3cud2Via2l0Q2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3aW5kb3cubW96Q2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3aW5kb3cud2Via2l0Q2FuY2VsUmVxdWVzdEFuaW1hdGlvbkZyYW1lOwoKICAgIHZhciByYWZTdXBwb3J0ZWQgPSAhIXJlcXVlc3RBbmltYXRpb25GcmFtZTsKICAgIHZhciByYWYgPSByYWZTdXBwb3J0ZWQKICAgICAgPyBmdW5jdGlvbihmbikgewogICAgICAgICAgdmFyIGlkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZuKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoaWQpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIDogZnVuY3Rpb24oZm4pIHsKICAgICAgICAgIHZhciB0aW1lciA9ICR0aW1lb3V0KGZuLCAxNi42NiwgZmFsc2UpOyAvLyAxMDAwIC8gNjAgPSAxNi42NjYKICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHRpbWVvdXQuY2FuY2VsKHRpbWVyKTsKICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICByYWYuc3VwcG9ydGVkID0gcmFmU3VwcG9ydGVkOwoKICAgIHJldHVybiByYWY7CiAgfV07Cn0KCi8qKgogKiBERVNJR04gTk9URVMKICoKICogVGhlIGRlc2lnbiBkZWNpc2lvbnMgYmVoaW5kIHRoZSBzY29wZSBhcmUgaGVhdmlseSBmYXZvcmVkIGZvciBzcGVlZCBhbmQgbWVtb3J5IGNvbnN1bXB0aW9uLgogKgogKiBUaGUgdHlwaWNhbCB1c2Ugb2Ygc2NvcGUgaXMgdG8gd2F0Y2ggdGhlIGV4cHJlc3Npb25zLCB3aGljaCBtb3N0IG9mIHRoZSB0aW1lIHJldHVybiB0aGUgc2FtZQogKiB2YWx1ZSBhcyBsYXN0IHRpbWUgc28gd2Ugb3B0aW1pemUgdGhlIG9wZXJhdGlvbi4KICoKICogQ2xvc3VyZXMgY29uc3RydWN0aW9uIGlzIGV4cGVuc2l2ZSBpbiB0ZXJtcyBvZiBzcGVlZCBhcyB3ZWxsIGFzIG1lbW9yeToKICogICAtIE5vIGNsb3N1cmVzLCBpbnN0ZWFkIHVzZSBwcm90b3R5cGljYWwgaW5oZXJpdGFuY2UgZm9yIEFQSQogKiAgIC0gSW50ZXJuYWwgc3RhdGUgbmVlZHMgdG8gYmUgc3RvcmVkIG9uIHNjb3BlIGRpcmVjdGx5LCB3aGljaCBtZWFucyB0aGF0IHByaXZhdGUgc3RhdGUgaXMKICogICAgIGV4cG9zZWQgYXMgJCRfX19fIHByb3BlcnRpZXMKICoKICogTG9vcCBvcGVyYXRpb25zIGFyZSBvcHRpbWl6ZWQgYnkgdXNpbmcgd2hpbGUoY291bnQtLSkgeyAuLi4gfQogKiAgIC0gdGhpcyBtZWFucyB0aGF0IGluIG9yZGVyIHRvIGtlZXAgdGhlIHNhbWUgb3JkZXIgb2YgZXhlY3V0aW9uIGFzIGFkZGl0aW9uIHdlIGhhdmUgdG8gYWRkCiAqICAgICBpdGVtcyB0byB0aGUgYXJyYXkgYXQgdGhlIGJlZ2lubmluZyAodW5zaGlmdCkgaW5zdGVhZCBvZiBhdCB0aGUgZW5kIChwdXNoKQogKgogKiBDaGlsZCBzY29wZXMgYXJlIGNyZWF0ZWQgYW5kIHJlbW92ZWQgb2Z0ZW4KICogICAtIFVzaW5nIGFuIGFycmF5IHdvdWxkIGJlIHNsb3cgc2luY2UgaW5zZXJ0cyBpbiBtaWRkbGUgYXJlIGV4cGVuc2l2ZSBzbyB3ZSB1c2UgbGlua2VkIGxpc3QKICoKICogVGhlcmUgYXJlIGZldyB3YXRjaGVzIHRoZW4gYSBsb3Qgb2Ygb2JzZXJ2ZXJzLiBUaGlzIGlzIHdoeSB5b3UgZG9uJ3Qgd2FudCB0aGUgb2JzZXJ2ZXIgdG8gYmUKICogaW1wbGVtZW50ZWQgaW4gdGhlIHNhbWUgd2F5IGFzIHdhdGNoLiBXYXRjaCByZXF1aXJlcyByZXR1cm4gb2YgaW5pdGlhbGl6YXRpb24gZnVuY3Rpb24gd2hpY2gKICogYXJlIGV4cGVuc2l2ZSB0byBjb25zdHJ1Y3QuCiAqLwoKCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJHJvb3RTY29wZVByb3ZpZGVyCiAqIEBkZXNjcmlwdGlvbgogKgogKiBQcm92aWRlciBmb3IgdGhlICRyb290U2NvcGUgc2VydmljZS4KICovCgovKioKICogQG5nZG9jIG1ldGhvZAogKiBAbmFtZSAkcm9vdFNjb3BlUHJvdmlkZXIjZGlnZXN0VHRsCiAqIEBkZXNjcmlwdGlvbgogKgogKiBTZXRzIHRoZSBudW1iZXIgb2YgYCRkaWdlc3RgIGl0ZXJhdGlvbnMgdGhlIHNjb3BlIHNob3VsZCBhdHRlbXB0IHRvIGV4ZWN1dGUgYmVmb3JlIGdpdmluZyB1cCBhbmQKICogYXNzdW1pbmcgdGhhdCB0aGUgbW9kZWwgaXMgdW5zdGFibGUuCiAqCiAqIFRoZSBjdXJyZW50IGRlZmF1bHQgaXMgMTAgaXRlcmF0aW9ucy4KICoKICogSW4gY29tcGxleCBhcHBsaWNhdGlvbnMgaXQncyBwb3NzaWJsZSB0aGF0IHRoZSBkZXBlbmRlbmNpZXMgYmV0d2VlbiBgJHdhdGNoYHMgd2lsbCByZXN1bHQgaW4KICogc2V2ZXJhbCBkaWdlc3QgaXRlcmF0aW9ucy4gSG93ZXZlciBpZiBhbiBhcHBsaWNhdGlvbiBuZWVkcyBtb3JlIHRoYW4gdGhlIGRlZmF1bHQgMTAgZGlnZXN0CiAqIGl0ZXJhdGlvbnMgZm9yIGl0cyBtb2RlbCB0byBzdGFiaWxpemUgdGhlbiB5b3Ugc2hvdWxkIGludmVzdGlnYXRlIHdoYXQgaXMgY2F1c2luZyB0aGUgbW9kZWwgdG8KICogY29udGludW91c2x5IGNoYW5nZSBkdXJpbmcgdGhlIGRpZ2VzdC4KICoKICogSW5jcmVhc2luZyB0aGUgVFRMIGNvdWxkIGhhdmUgcGVyZm9ybWFuY2UgaW1wbGljYXRpb25zLCBzbyB5b3Ugc2hvdWxkIG5vdCBjaGFuZ2UgaXQgd2l0aG91dAogKiBwcm9wZXIganVzdGlmaWNhdGlvbi4KICoKICogQHBhcmFtIHtudW1iZXJ9IGxpbWl0IFRoZSBudW1iZXIgb2YgZGlnZXN0IGl0ZXJhdGlvbnMuCiAqLwoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkcm9vdFNjb3BlCiAqIEBkZXNjcmlwdGlvbgogKgogKiBFdmVyeSBhcHBsaWNhdGlvbiBoYXMgYSBzaW5nbGUgcm9vdCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0uCiAqIEFsbCBvdGhlciBzY29wZXMgYXJlIGRlc2NlbmRhbnQgc2NvcGVzIG9mIHRoZSByb290IHNjb3BlLiBTY29wZXMgcHJvdmlkZSBzZXBhcmF0aW9uCiAqIGJldHdlZW4gdGhlIG1vZGVsIGFuZCB0aGUgdmlldywgdmlhIGEgbWVjaGFuaXNtIGZvciB3YXRjaGluZyB0aGUgbW9kZWwgZm9yIGNoYW5nZXMuCiAqIFRoZXkgYWxzbyBwcm92aWRlIGFuIGV2ZW50IGVtaXNzaW9uL2Jyb2FkY2FzdCBhbmQgc3Vic2NyaXB0aW9uIGZhY2lsaXR5LiBTZWUgdGhlCiAqIHtAbGluayBndWlkZS9zY29wZSBkZXZlbG9wZXIgZ3VpZGUgb24gc2NvcGVzfS4KICovCmZ1bmN0aW9uICRSb290U2NvcGVQcm92aWRlcigpewogIHZhciBUVEwgPSAxMDsKICB2YXIgJHJvb3RTY29wZU1pbkVyciA9IG1pbkVycignJHJvb3RTY29wZScpOwogIHZhciBsYXN0RGlydHlXYXRjaCA9IG51bGw7CiAgdmFyIGFwcGx5QXN5bmNJZCA9IG51bGw7CgogIHRoaXMuZGlnZXN0VHRsID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIFRUTCA9IHZhbHVlOwogICAgfQogICAgcmV0dXJuIFRUTDsKICB9OwoKICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsICckZXhjZXB0aW9uSGFuZGxlcicsICckcGFyc2UnLCAnJGJyb3dzZXInLAogICAgICBmdW5jdGlvbiggJGluamVjdG9yLCAgICRleGNlcHRpb25IYW5kbGVyLCAgICRwYXJzZSwgICAkYnJvd3NlcikgewoKICAgIC8qKgogICAgICogQG5nZG9jIHR5cGUKICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgcm9vdCBzY29wZSBjYW4gYmUgcmV0cmlldmVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZSAkcm9vdFNjb3BlfSBrZXkgZnJvbSB0aGUKICAgICAqIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LiBDaGlsZCBzY29wZXMgYXJlIGNyZWF0ZWQgdXNpbmcgdGhlCiAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkbmV3ICRuZXcoKX0gbWV0aG9kLiAoTW9zdCBzY29wZXMgYXJlIGNyZWF0ZWQgYXV0b21hdGljYWxseSB3aGVuCiAgICAgKiBjb21waWxlZCBIVE1MIHRlbXBsYXRlIGlzIGV4ZWN1dGVkLikKICAgICAqCiAgICAgKiBIZXJlIGlzIGEgc2ltcGxlIHNjb3BlIHNuaXBwZXQgdG8gc2hvdyBob3cgeW91IGNhbiBpbnRlcmFjdCB3aXRoIHRoZSBzY29wZS4KICAgICAqIGBgYGh0bWwKICAgICAqIDxmaWxlIHNyYz0iLi90ZXN0L25nL3Jvb3RTY29wZVNwZWMuanMiIHRhZz0iZG9jczEiIC8+CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiAjIEluaGVyaXRhbmNlCiAgICAgKiBBIHNjb3BlIGNhbiBpbmhlcml0IGZyb20gYSBwYXJlbnQgc2NvcGUsIGFzIGluIHRoaXMgZXhhbXBsZToKICAgICAqIGBgYGpzCiAgICAgICAgIHZhciBwYXJlbnQgPSAkcm9vdFNjb3BlOwogICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnQuJG5ldygpOwoKICAgICAgICAgcGFyZW50LnNhbHV0YXRpb24gPSAiSGVsbG8iOwogICAgICAgICBjaGlsZC5uYW1lID0gIldvcmxkIjsKICAgICAgICAgZXhwZWN0KGNoaWxkLnNhbHV0YXRpb24pLnRvRXF1YWwoJ0hlbGxvJyk7CgogICAgICAgICBjaGlsZC5zYWx1dGF0aW9uID0gIldlbGNvbWUiOwogICAgICAgICBleHBlY3QoY2hpbGQuc2FsdXRhdGlvbikudG9FcXVhbCgnV2VsY29tZScpOwogICAgICAgICBleHBlY3QocGFyZW50LnNhbHV0YXRpb24pLnRvRXF1YWwoJ0hlbGxvJyk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgZnVuY3Rpb24oKT49fSBwcm92aWRlcnMgTWFwIG9mIHNlcnZpY2UgZmFjdG9yeSB3aGljaCBuZWVkIHRvIGJlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVkIGZvciB0aGUgY3VycmVudCBzY29wZS4gRGVmYXVsdHMgdG8ge0BsaW5rIG5nfS4KICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsICo+PX0gaW5zdGFuY2VDYWNoZSBQcm92aWRlcyBwcmUtaW5zdGFudGlhdGVkIHNlcnZpY2VzIHdoaWNoIHNob3VsZAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBlbmQvb3ZlcnJpZGUgc2VydmljZXMgcHJvdmlkZWQgYnkgYHByb3ZpZGVyc2AuIFRoaXMgaXMgaGFuZHkKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hlbiB1bml0LXRlc3RpbmcgYW5kIGhhdmluZyB0aGUgbmVlZCB0byBvdmVycmlkZSBhIGRlZmF1bHQKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmljZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IE5ld2x5IGNyZWF0ZWQgc2NvcGUuCiAgICAgKgogICAgICovCiAgICBmdW5jdGlvbiBTY29wZSgpIHsKICAgICAgdGhpcy4kaWQgPSBuZXh0VWlkKCk7CiAgICAgIHRoaXMuJCRwaGFzZSA9IHRoaXMuJHBhcmVudCA9IHRoaXMuJCR3YXRjaGVycyA9CiAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRuZXh0U2libGluZyA9IHRoaXMuJCRwcmV2U2libGluZyA9CiAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgdGhpcy4kcm9vdCA9IHRoaXM7CiAgICAgIHRoaXMuJCRkZXN0cm95ZWQgPSBmYWxzZTsKICAgICAgdGhpcy4kJGxpc3RlbmVycyA9IHt9OwogICAgICB0aGlzLiQkbGlzdGVuZXJDb3VudCA9IHt9OwogICAgICB0aGlzLiQkaXNvbGF0ZUJpbmRpbmdzID0gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkaWQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVuaXF1ZSBzY29wZSBJRCAobW9ub3RvbmljYWxseSBpbmNyZWFzaW5nKSB1c2VmdWwgZm9yIGRlYnVnZ2luZy4KICAgICAqLwoKICAgICAvKioKICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRwYXJlbnQKICAgICAgKgogICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAqIFJlZmVyZW5jZSB0byB0aGUgcGFyZW50IHNjb3BlLgogICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRyb290CiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBSZWZlcmVuY2UgdG8gdGhlIHJvb3Qgc2NvcGUuCiAgICAgICAqLwoKICAgIFNjb3BlLnByb3RvdHlwZSA9IHsKICAgICAgY29uc3RydWN0b3I6IFNjb3BlLAogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRuZXcKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIENyZWF0ZXMgYSBuZXcgY2hpbGQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9LgogICAgICAgKgogICAgICAgKiBUaGUgcGFyZW50IHNjb3BlIHdpbGwgcHJvcGFnYXRlIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gZXZlbnQuCiAgICAgICAqIFRoZSBzY29wZSBjYW4gYmUgcmVtb3ZlZCBmcm9tIHRoZSBzY29wZSBoaWVyYXJjaHkgdXNpbmcge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRlc3Ryb3kgJGRlc3Ryb3koKX0uCiAgICAgICAqCiAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95ICRkZXN0cm95KCl9IG11c3QgYmUgY2FsbGVkIG9uIGEgc2NvcGUgd2hlbiBpdCBpcwogICAgICAgKiBkZXNpcmVkIGZvciB0aGUgc2NvcGUgYW5kIGl0cyBjaGlsZCBzY29wZXMgdG8gYmUgcGVybWFuZW50bHkgZGV0YWNoZWQgZnJvbSB0aGUgcGFyZW50IGFuZAogICAgICAgKiB0aHVzIHN0b3AgcGFydGljaXBhdGluZyBpbiBtb2RlbCBjaGFuZ2UgZGV0ZWN0aW9uIGFuZCBsaXN0ZW5lciBub3RpZmljYXRpb24gYnkgaW52b2tpbmcuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNvbGF0ZSBJZiB0cnVlLCB0aGVuIHRoZSBzY29wZSBkb2VzIG5vdCBwcm90b3R5cGljYWxseSBpbmhlcml0IGZyb20gdGhlCiAgICAgICAqICAgICAgICAgcGFyZW50IHNjb3BlLiBUaGUgc2NvcGUgaXMgaXNvbGF0ZWQsIGFzIGl0IGNhbiBub3Qgc2VlIHBhcmVudCBzY29wZSBwcm9wZXJ0aWVzLgogICAgICAgKiAgICAgICAgIFdoZW4gY3JlYXRpbmcgd2lkZ2V0cywgaXQgaXMgdXNlZnVsIGZvciB0aGUgd2lkZ2V0IHRvIG5vdCBhY2NpZGVudGFsbHkgcmVhZCBwYXJlbnQKICAgICAgICogICAgICAgICBzdGF0ZS4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtTY29wZX0gW3BhcmVudD10aGlzXSBUaGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgYFNjb3BlYH0gdGhhdCB3aWxsIGJlIHRoZSBgJHBhcmVudGAKICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZiB0aGUgbmV3bHkgY3JlYXRlZCBzY29wZS4gRGVmYXVsdHMgdG8gYHRoaXNgIHNjb3BlIGlmIG5vdCBwcm92aWRlZC4KICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIGlzIHVzZWQgd2hlbiBjcmVhdGluZyBhIHRyYW5zY2x1ZGUgc2NvcGUgdG8gY29ycmVjdGx5IHBsYWNlIGl0CiAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW4gdGhlIHNjb3BlIGhpZXJhcmNoeSB3aGlsZSBtYWludGFpbmluZyB0aGUgY29ycmVjdCBwcm90b3R5cGljYWwKICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmhlcml0YW5jZS4KICAgICAgICoKICAgICAgICogQHJldHVybnMge09iamVjdH0gVGhlIG5ld2x5IGNyZWF0ZWQgY2hpbGQgc2NvcGUuCiAgICAgICAqCiAgICAgICAqLwogICAgICAkbmV3OiBmdW5jdGlvbihpc29sYXRlLCBwYXJlbnQpIHsKICAgICAgICB2YXIgY2hpbGQ7CgogICAgICAgIHBhcmVudCA9IHBhcmVudCB8fCB0aGlzOwoKICAgICAgICBpZiAoaXNvbGF0ZSkgewogICAgICAgICAgY2hpbGQgPSBuZXcgU2NvcGUoKTsKICAgICAgICAgIGNoaWxkLiRyb290ID0gdGhpcy4kcm9vdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gT25seSBjcmVhdGUgYSBjaGlsZCBzY29wZSBjbGFzcyBpZiBzb21lYm9keSBhc2tzIGZvciBvbmUsCiAgICAgICAgICAvLyBidXQgY2FjaGUgaXQgdG8gYWxsb3cgdGhlIFZNIHRvIG9wdGltaXplIGxvb2t1cHMuCiAgICAgICAgICBpZiAoIXRoaXMuJCRDaGlsZFNjb3BlKSB7CiAgICAgICAgICAgIHRoaXMuJCRDaGlsZFNjb3BlID0gZnVuY3Rpb24gQ2hpbGRTY29wZSgpIHsKICAgICAgICAgICAgICB0aGlzLiQkd2F0Y2hlcnMgPSB0aGlzLiQkbmV4dFNpYmxpbmcgPQogICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRIZWFkID0gdGhpcy4kJGNoaWxkVGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgdGhpcy4kJGxpc3RlbmVycyA9IHt9OwogICAgICAgICAgICAgIHRoaXMuJCRsaXN0ZW5lckNvdW50ID0ge307CiAgICAgICAgICAgICAgdGhpcy4kaWQgPSBuZXh0VWlkKCk7CiAgICAgICAgICAgICAgdGhpcy4kJENoaWxkU2NvcGUgPSBudWxsOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLiQkQ2hpbGRTY29wZS5wcm90b3R5cGUgPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgY2hpbGQgPSBuZXcgdGhpcy4kJENoaWxkU2NvcGUoKTsKICAgICAgICB9CiAgICAgICAgY2hpbGQuJHBhcmVudCA9IHBhcmVudDsKICAgICAgICBjaGlsZC4kJHByZXZTaWJsaW5nID0gcGFyZW50LiQkY2hpbGRUYWlsOwogICAgICAgIGlmIChwYXJlbnQuJCRjaGlsZEhlYWQpIHsKICAgICAgICAgIHBhcmVudC4kJGNoaWxkVGFpbC4kJG5leHRTaWJsaW5nID0gY2hpbGQ7CiAgICAgICAgICBwYXJlbnQuJCRjaGlsZFRhaWwgPSBjaGlsZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGFyZW50LiQkY2hpbGRIZWFkID0gcGFyZW50LiQkY2hpbGRUYWlsID0gY2hpbGQ7CiAgICAgICAgfQoKICAgICAgICAvLyBXaGVuIHRoZSBuZXcgc2NvcGUgaXMgbm90IGlzb2xhdGVkIG9yIHdlIGluaGVyaXQgZnJvbSBgdGhpc2AsIGFuZAogICAgICAgIC8vIHRoZSBwYXJlbnQgc2NvcGUgaXMgZGVzdHJveWVkLCB0aGUgcHJvcGVydHkgYCQkZGVzdHJveWVkYCBpcyBpbmhlcml0ZWQKICAgICAgICAvLyBwcm90b3R5cGljYWxseS4gSW4gYWxsIG90aGVyIGNhc2VzLCB0aGlzIHByb3BlcnR5IG5lZWRzIHRvIGJlIHNldAogICAgICAgIC8vIHdoZW4gdGhlIHBhcmVudCBzY29wZSBpcyBkZXN0cm95ZWQuCiAgICAgICAgLy8gVGhlIGxpc3RlbmVyIG5lZWRzIHRvIGJlIGFkZGVkIGFmdGVyIHRoZSBwYXJlbnQgaXMgc2V0CiAgICAgICAgaWYgKGlzb2xhdGUgfHwgcGFyZW50ICE9IHRoaXMpIGNoaWxkLiRvbignJGRlc3Ryb3knLCBkZXN0cm95Q2hpbGQpOwoKICAgICAgICByZXR1cm4gY2hpbGQ7CgogICAgICAgIGZ1bmN0aW9uIGRlc3Ryb3lDaGlsZCgpIHsKICAgICAgICAgIGNoaWxkLiQkZGVzdHJveWVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyR3YXRjaAogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogUmVnaXN0ZXJzIGEgYGxpc3RlbmVyYCBjYWxsYmFjayB0byBiZSBleGVjdXRlZCB3aGVuZXZlciB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2hhbmdlcy4KICAgICAgICoKICAgICAgICogLSBUaGUgYHdhdGNoRXhwcmVzc2lvbmAgaXMgY2FsbGVkIG9uIGV2ZXJ5IGNhbGwgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdAogICAgICAgKiAgICRkaWdlc3QoKX0gYW5kIHNob3VsZCByZXR1cm4gdGhlIHZhbHVlIHRoYXQgd2lsbCBiZSB3YXRjaGVkLiAoU2luY2UKICAgICAgICogICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gcmVydW5zIHdoZW4gaXQgZGV0ZWN0cyBjaGFuZ2VzIHRoZQogICAgICAgKiAgIGB3YXRjaEV4cHJlc3Npb25gIGNhbiBleGVjdXRlIG11bHRpcGxlIHRpbWVzIHBlcgogICAgICAgKiAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBhbmQgc2hvdWxkIGJlIGlkZW1wb3RlbnQuKQogICAgICAgKiAtIFRoZSBgbGlzdGVuZXJgIGlzIGNhbGxlZCBvbmx5IHdoZW4gdGhlIHZhbHVlIGZyb20gdGhlIGN1cnJlbnQgYHdhdGNoRXhwcmVzc2lvbmAgYW5kIHRoZQogICAgICAgKiAgIHByZXZpb3VzIGNhbGwgdG8gYHdhdGNoRXhwcmVzc2lvbmAgYXJlIG5vdCBlcXVhbCAod2l0aCB0aGUgZXhjZXB0aW9uIG9mIHRoZSBpbml0aWFsIHJ1biwKICAgICAgICogICBzZWUgYmVsb3cpLiBJbmVxdWFsaXR5IGlzIGRldGVybWluZWQgYWNjb3JkaW5nIHRvIHJlZmVyZW5jZSBpbmVxdWFsaXR5LAogICAgICAgKiAgIFtzdHJpY3QgY29tcGFyaXNvbl0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvT3BlcmF0b3JzL0NvbXBhcmlzb25fT3BlcmF0b3JzKQogICAgICAgKiAgICB2aWEgdGhlIGAhPT1gIEphdmFzY3JpcHQgb3BlcmF0b3IsIHVubGVzcyBgb2JqZWN0RXF1YWxpdHkgPT0gdHJ1ZWAKICAgICAgICogICAoc2VlIG5leHQgcG9pbnQpCiAgICAgICAqIC0gV2hlbiBgb2JqZWN0RXF1YWxpdHkgPT0gdHJ1ZWAsIGluZXF1YWxpdHkgb2YgdGhlIGB3YXRjaEV4cHJlc3Npb25gIGlzIGRldGVybWluZWQKICAgICAgICogICBhY2NvcmRpbmcgdG8gdGhlIHtAbGluayBhbmd1bGFyLmVxdWFsc30gZnVuY3Rpb24uIFRvIHNhdmUgdGhlIHZhbHVlIG9mIHRoZSBvYmplY3QgZm9yCiAgICAgICAqICAgbGF0ZXIgY29tcGFyaXNvbiwgdGhlIHtAbGluayBhbmd1bGFyLmNvcHl9IGZ1bmN0aW9uIGlzIHVzZWQuIFRoaXMgdGhlcmVmb3JlIG1lYW5zIHRoYXQKICAgICAgICogICB3YXRjaGluZyBjb21wbGV4IG9iamVjdHMgd2lsbCBoYXZlIGFkdmVyc2UgbWVtb3J5IGFuZCBwZXJmb3JtYW5jZSBpbXBsaWNhdGlvbnMuCiAgICAgICAqIC0gVGhlIHdhdGNoIGBsaXN0ZW5lcmAgbWF5IGNoYW5nZSB0aGUgbW9kZWwsIHdoaWNoIG1heSB0cmlnZ2VyIG90aGVyIGBsaXN0ZW5lcmBzIHRvIGZpcmUuCiAgICAgICAqICAgVGhpcyBpcyBhY2hpZXZlZCBieSByZXJ1bm5pbmcgdGhlIHdhdGNoZXJzIHVudGlsIG5vIGNoYW5nZXMgYXJlIGRldGVjdGVkLiBUaGUgcmVydW4KICAgICAgICogICBpdGVyYXRpb24gbGltaXQgaXMgMTAgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wIGRlYWRsb2NrLgogICAgICAgKgogICAgICAgKgogICAgICAgKiBJZiB5b3Ugd2FudCB0byBiZSBub3RpZmllZCB3aGVuZXZlciB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGlzIGNhbGxlZCwKICAgICAgICogeW91IGNhbiByZWdpc3RlciBhIGB3YXRjaEV4cHJlc3Npb25gIGZ1bmN0aW9uIHdpdGggbm8gYGxpc3RlbmVyYC4gKFNpbmNlIGB3YXRjaEV4cHJlc3Npb25gCiAgICAgICAqIGNhbiBleGVjdXRlIG11bHRpcGxlIHRpbWVzIHBlciB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGN5Y2xlIHdoZW4gYQogICAgICAgKiBjaGFuZ2UgaXMgZGV0ZWN0ZWQsIGJlIHByZXBhcmVkIGZvciBtdWx0aXBsZSBjYWxscyB0byB5b3VyIGxpc3RlbmVyLikKICAgICAgICoKICAgICAgICogQWZ0ZXIgYSB3YXRjaGVyIGlzIHJlZ2lzdGVyZWQgd2l0aCB0aGUgc2NvcGUsIHRoZSBgbGlzdGVuZXJgIGZuIGlzIGNhbGxlZCBhc3luY2hyb25vdXNseQogICAgICAgKiAodmlhIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsQXN5bmMgJGV2YWxBc3luY30pIHRvIGluaXRpYWxpemUgdGhlCiAgICAgICAqIHdhdGNoZXIuIEluIHJhcmUgY2FzZXMsIHRoaXMgaXMgdW5kZXNpcmFibGUgYmVjYXVzZSB0aGUgbGlzdGVuZXIgaXMgY2FsbGVkIHdoZW4gdGhlIHJlc3VsdAogICAgICAgKiBvZiBgd2F0Y2hFeHByZXNzaW9uYCBkaWRuJ3QgY2hhbmdlLiBUbyBkZXRlY3QgdGhpcyBzY2VuYXJpbyB3aXRoaW4gdGhlIGBsaXN0ZW5lcmAgZm4sIHlvdQogICAgICAgKiBjYW4gY29tcGFyZSB0aGUgYG5ld1ZhbGAgYW5kIGBvbGRWYWxgLiBJZiB0aGVzZSB0d28gdmFsdWVzIGFyZSBpZGVudGljYWwgKGA9PT1gKSB0aGVuIHRoZQogICAgICAgKiBsaXN0ZW5lciB3YXMgY2FsbGVkIGR1ZSB0byBpbml0aWFsaXphdGlvbi4KICAgICAgICoKICAgICAgICoKICAgICAgICoKICAgICAgICogIyBFeGFtcGxlCiAgICAgICAqIGBgYGpzCiAgICAgICAgICAgLy8gbGV0J3MgYXNzdW1lIHRoYXQgc2NvcGUgd2FzIGRlcGVuZGVuY3kgaW5qZWN0ZWQgYXMgdGhlICRyb290U2NvcGUKICAgICAgICAgICB2YXIgc2NvcGUgPSAkcm9vdFNjb3BlOwogICAgICAgICAgIHNjb3BlLm5hbWUgPSAnbWlza28nOwogICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSAwOwoKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICBzY29wZS4kd2F0Y2goJ25hbWUnLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSBzY29wZS5jb3VudGVyICsgMTsKICAgICAgICAgICB9KTsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKCiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIC8vIHRoZSBsaXN0ZW5lciBpcyBhbHdheXMgY2FsbGVkIGR1cmluZyB0aGUgZmlyc3QgJGRpZ2VzdCBsb29wIGFmdGVyIGl0IHdhcyByZWdpc3RlcmVkCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMSk7CgogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAvLyBidXQgbm93IGl0IHdpbGwgbm90IGJlIGNhbGxlZCB1bmxlc3MgdGhlIHZhbHVlIGNoYW5nZXMKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKCiAgICAgICAgICAgc2NvcGUubmFtZSA9ICdhZGFtJzsKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMik7CgoKCiAgICAgICAgICAgLy8gVXNpbmcgYSBmdW5jdGlvbiBhcyBhIHdhdGNoRXhwcmVzc2lvbgogICAgICAgICAgIHZhciBmb29kOwogICAgICAgICAgIHNjb3BlLmZvb2RDb3VudGVyID0gMDsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuZm9vZENvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgICAgc2NvcGUuJHdhdGNoKAogICAgICAgICAgICAgLy8gVGhpcyBmdW5jdGlvbiByZXR1cm5zIHRoZSB2YWx1ZSBiZWluZyB3YXRjaGVkLiBJdCBpcyBjYWxsZWQgZm9yIGVhY2ggdHVybiBvZiB0aGUgJGRpZ2VzdCBsb29wCiAgICAgICAgICAgICBmdW5jdGlvbigpIHsgcmV0dXJuIGZvb2Q7IH0sCiAgICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBjaGFuZ2UgbGlzdGVuZXIsIGNhbGxlZCB3aGVuIHRoZSB2YWx1ZSByZXR1cm5lZCBmcm9tIHRoZSBhYm92ZSBmdW5jdGlvbiBjaGFuZ2VzCiAgICAgICAgICAgICBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgICAgaWYgKCBuZXdWYWx1ZSAhPT0gb2xkVmFsdWUgKSB7CiAgICAgICAgICAgICAgICAgLy8gT25seSBpbmNyZW1lbnQgdGhlIGNvdW50ZXIgaWYgdGhlIHZhbHVlIGNoYW5nZWQKICAgICAgICAgICAgICAgICBzY29wZS5mb29kQ291bnRlciA9IHNjb3BlLmZvb2RDb3VudGVyICsgMTsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgfQogICAgICAgICAgICk7CiAgICAgICAgICAgLy8gTm8gZGlnZXN0IGhhcyBiZWVuIHJ1biBzbyB0aGUgY291bnRlciB3aWxsIGJlIHplcm8KICAgICAgICAgICBleHBlY3Qoc2NvcGUuZm9vZENvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgIC8vIFJ1biB0aGUgZGlnZXN0IGJ1dCBzaW5jZSBmb29kIGhhcyBub3QgY2hhbmdlZCBjb3VudCB3aWxsIHN0aWxsIGJlIHplcm8KICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmZvb2RDb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAvLyBVcGRhdGUgZm9vZCBhbmQgcnVuIGRpZ2VzdC4gIE5vdyB0aGUgY291bnRlciB3aWxsIGluY3JlbWVudAogICAgICAgICAgIGZvb2QgPSAnY2hlZXNlYnVyZ2VyJzsKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmZvb2RDb3VudGVyKS50b0VxdWFsKDEpOwoKICAgICAgICogYGBgCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9uKCl8c3RyaW5nKX0gd2F0Y2hFeHByZXNzaW9uIEV4cHJlc3Npb24gdGhhdCBpcyBldmFsdWF0ZWQgb24gZWFjaAogICAgICAgKiAgICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGN5Y2xlLiBBIGNoYW5nZSBpbiB0aGUgcmV0dXJuIHZhbHVlIHRyaWdnZXJzCiAgICAgICAqICAgIGEgY2FsbCB0byB0aGUgYGxpc3RlbmVyYC4KICAgICAgICoKICAgICAgICogICAgLSBgc3RyaW5nYDogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259CiAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGNhbGxlZCB3aXRoIGN1cnJlbnQgYHNjb3BlYCBhcyBhIHBhcmFtZXRlci4KICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihuZXdWYWwsIG9sZFZhbCwgc2NvcGUpfSBsaXN0ZW5lciBDYWxsYmFjayBjYWxsZWQgd2hlbmV2ZXIgdGhlIHZhbHVlCiAgICAgICAqICAgIG9mIGB3YXRjaEV4cHJlc3Npb25gIGNoYW5nZXMuCiAgICAgICAqCiAgICAgICAqICAgIC0gYG5ld1ZhbGAgY29udGFpbnMgdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIGB3YXRjaEV4cHJlc3Npb25gCiAgICAgICAqICAgIC0gYG9sZFZhbGAgY29udGFpbnMgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgd2F0Y2hFeHByZXNzaW9uYAogICAgICAgKiAgICAtIGBzY29wZWAgcmVmZXJzIHRvIHRoZSBjdXJyZW50IHNjb3BlCiAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9iamVjdEVxdWFsaXR5IENvbXBhcmUgZm9yIG9iamVjdCBlcXVhbGl0eSB1c2luZyB7QGxpbmsgYW5ndWxhci5lcXVhbHN9IGluc3RlYWQgb2YKICAgICAgICogICAgIGNvbXBhcmluZyBmb3IgcmVmZXJlbmNlIGVxdWFsaXR5LgogICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gUmV0dXJucyBhIGRlcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGZvciB0aGlzIGxpc3RlbmVyLgogICAgICAgKi8KICAgICAgJHdhdGNoOiBmdW5jdGlvbih3YXRjaEV4cCwgbGlzdGVuZXIsIG9iamVjdEVxdWFsaXR5KSB7CiAgICAgICAgdmFyIGdldCA9ICRwYXJzZSh3YXRjaEV4cCk7CgogICAgICAgIGlmIChnZXQuJCR3YXRjaERlbGVnYXRlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0LiQkd2F0Y2hEZWxlZ2F0ZSh0aGlzLCBsaXN0ZW5lciwgb2JqZWN0RXF1YWxpdHksIGdldCk7CiAgICAgICAgfQogICAgICAgIHZhciBzY29wZSA9IHRoaXMsCiAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycywKICAgICAgICAgICAgd2F0Y2hlciA9IHsKICAgICAgICAgICAgICBmbjogbGlzdGVuZXIsCiAgICAgICAgICAgICAgbGFzdDogaW5pdFdhdGNoVmFsLAogICAgICAgICAgICAgIGdldDogZ2V0LAogICAgICAgICAgICAgIGV4cDogd2F0Y2hFeHAsCiAgICAgICAgICAgICAgZXE6ICEhb2JqZWN0RXF1YWxpdHkKICAgICAgICAgICAgfTsKCiAgICAgICAgbGFzdERpcnR5V2F0Y2ggPSBudWxsOwoKICAgICAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKSB7CiAgICAgICAgICB3YXRjaGVyLmZuID0gbm9vcDsKICAgICAgICB9CgogICAgICAgIGlmICghYXJyYXkpIHsKICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycyA9IFtdOwogICAgICAgIH0KICAgICAgICAvLyB3ZSB1c2UgdW5zaGlmdCBzaW5jZSB3ZSB1c2UgYSB3aGlsZSBsb29wIGluICRkaWdlc3QgZm9yIHNwZWVkLgogICAgICAgIC8vIHRoZSB3aGlsZSBsb29wIHJlYWRzIGluIHJldmVyc2Ugb3JkZXIuCiAgICAgICAgYXJyYXkudW5zaGlmdCh3YXRjaGVyKTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGRlcmVnaXN0ZXJXYXRjaCgpIHsKICAgICAgICAgIGFycmF5UmVtb3ZlKGFycmF5LCB3YXRjaGVyKTsKICAgICAgICAgIGxhc3REaXJ0eVdhdGNoID0gbnVsbDsKICAgICAgICB9OwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkd2F0Y2hHcm91cAogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogQSB2YXJpYW50IG9mIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCAkd2F0Y2goKX0gd2hlcmUgaXQgd2F0Y2hlcyBhbiBhcnJheSBvZiBgd2F0Y2hFeHByZXNzaW9uc2AuCiAgICAgICAqIElmIGFueSBvbmUgZXhwcmVzc2lvbiBpbiB0aGUgY29sbGVjdGlvbiBjaGFuZ2VzIHRoZSBgbGlzdGVuZXJgIGlzIGV4ZWN1dGVkLgogICAgICAgKgogICAgICAgKiAtIFRoZSBpdGVtcyBpbiB0aGUgYHdhdGNoRXhwcmVzc2lvbnNgIGFycmF5IGFyZSBvYnNlcnZlZCB2aWEgc3RhbmRhcmQgJHdhdGNoIG9wZXJhdGlvbiBhbmQgYXJlIGV4YW1pbmVkIG9uIGV2ZXJ5CiAgICAgICAqICAgY2FsbCB0byAkZGlnZXN0KCkgdG8gc2VlIGlmIGFueSBpdGVtcyBjaGFuZ2VzLgogICAgICAgKiAtIFRoZSBgbGlzdGVuZXJgIGlzIGNhbGxlZCB3aGVuZXZlciBhbnkgZXhwcmVzc2lvbiBpbiB0aGUgYHdhdGNoRXhwcmVzc2lvbnNgIGFycmF5IGNoYW5nZXMuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7QXJyYXkuPHN0cmluZ3xGdW5jdGlvbihzY29wZSk+fSB3YXRjaEV4cHJlc3Npb25zIEFycmF5IG9mIGV4cHJlc3Npb25zIHRoYXQgd2lsbCBiZSBpbmRpdmlkdWFsbHkKICAgICAgICogd2F0Y2hlZCB1c2luZyB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggJHdhdGNoKCl9CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24obmV3VmFsdWVzLCBvbGRWYWx1ZXMsIHNjb3BlKX0gbGlzdGVuZXIgQ2FsbGJhY2sgY2FsbGVkIHdoZW5ldmVyIHRoZSByZXR1cm4gdmFsdWUgb2YgYW55CiAgICAgICAqICAgIGV4cHJlc3Npb24gaW4gYHdhdGNoRXhwcmVzc2lvbnNgIGNoYW5nZXMKICAgICAgICogICAgVGhlIGBuZXdWYWx1ZXNgIGFycmF5IGNvbnRhaW5zIHRoZSBjdXJyZW50IHZhbHVlcyBvZiB0aGUgYHdhdGNoRXhwcmVzc2lvbnNgLCB3aXRoIHRoZSBpbmRleGVzIG1hdGNoaW5nCiAgICAgICAqICAgIHRob3NlIG9mIGB3YXRjaEV4cHJlc3Npb25gCiAgICAgICAqICAgIGFuZCB0aGUgYG9sZFZhbHVlc2AgYXJyYXkgY29udGFpbnMgdGhlIHByZXZpb3VzIHZhbHVlcyBvZiB0aGUgYHdhdGNoRXhwcmVzc2lvbnNgLCB3aXRoIHRoZSBpbmRleGVzIG1hdGNoaW5nCiAgICAgICAqICAgIHRob3NlIG9mIGB3YXRjaEV4cHJlc3Npb25gCiAgICAgICAqICAgIFRoZSBgc2NvcGVgIHJlZmVycyB0byB0aGUgY3VycmVudCBzY29wZS4KICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZS1yZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIGFsbCBsaXN0ZW5lcnMuCiAgICAgICAqLwogICAgICAkd2F0Y2hHcm91cDogZnVuY3Rpb24od2F0Y2hFeHByZXNzaW9ucywgbGlzdGVuZXIpIHsKICAgICAgICB2YXIgb2xkVmFsdWVzID0gbmV3IEFycmF5KHdhdGNoRXhwcmVzc2lvbnMubGVuZ3RoKTsKICAgICAgICB2YXIgbmV3VmFsdWVzID0gbmV3IEFycmF5KHdhdGNoRXhwcmVzc2lvbnMubGVuZ3RoKTsKICAgICAgICB2YXIgZGVyZWdpc3RlckZucyA9IFtdOwogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB2YXIgY2hhbmdlUmVhY3Rpb25TY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgZmlyc3RSdW4gPSB0cnVlOwoKICAgICAgICBpZiAoIXdhdGNoRXhwcmVzc2lvbnMubGVuZ3RoKSB7CiAgICAgICAgICAvLyBObyBleHByZXNzaW9ucyBtZWFucyB3ZSBjYWxsIHRoZSBsaXN0ZW5lciBBU0FQCiAgICAgICAgICB2YXIgc2hvdWxkQ2FsbCA9IHRydWU7CiAgICAgICAgICBzZWxmLiRldmFsQXN5bmMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoc2hvdWxkQ2FsbCkgbGlzdGVuZXIobmV3VmFsdWVzLCBuZXdWYWx1ZXMsIHNlbGYpOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gZGVyZWdpc3RlcldhdGNoR3JvdXAoKSB7CiAgICAgICAgICAgIHNob3VsZENhbGwgPSBmYWxzZTsKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBpZiAod2F0Y2hFeHByZXNzaW9ucy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgIC8vIFNwZWNpYWwgY2FzZSBzaXplIG9mIG9uZQogICAgICAgICAgcmV0dXJuIHRoaXMuJHdhdGNoKHdhdGNoRXhwcmVzc2lvbnNbMF0sIGZ1bmN0aW9uIHdhdGNoR3JvdXBBY3Rpb24odmFsdWUsIG9sZFZhbHVlLCBzY29wZSkgewogICAgICAgICAgICBuZXdWYWx1ZXNbMF0gPSB2YWx1ZTsKICAgICAgICAgICAgb2xkVmFsdWVzWzBdID0gb2xkVmFsdWU7CiAgICAgICAgICAgIGxpc3RlbmVyKG5ld1ZhbHVlcywgKHZhbHVlID09PSBvbGRWYWx1ZSkgPyBuZXdWYWx1ZXMgOiBvbGRWYWx1ZXMsIHNjb3BlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZm9yRWFjaCh3YXRjaEV4cHJlc3Npb25zLCBmdW5jdGlvbiAoZXhwciwgaSkgewogICAgICAgICAgdmFyIHVud2F0Y2hGbiA9IHNlbGYuJHdhdGNoKGV4cHIsIGZ1bmN0aW9uIHdhdGNoR3JvdXBTdWJBY3Rpb24odmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgIG5ld1ZhbHVlc1tpXSA9IHZhbHVlOwogICAgICAgICAgICBvbGRWYWx1ZXNbaV0gPSBvbGRWYWx1ZTsKICAgICAgICAgICAgaWYgKCFjaGFuZ2VSZWFjdGlvblNjaGVkdWxlZCkgewogICAgICAgICAgICAgIGNoYW5nZVJlYWN0aW9uU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICAgICAgICBzZWxmLiRldmFsQXN5bmMod2F0Y2hHcm91cEFjdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgZGVyZWdpc3RlckZucy5wdXNoKHVud2F0Y2hGbik7CiAgICAgICAgfSk7CgogICAgICAgIGZ1bmN0aW9uIHdhdGNoR3JvdXBBY3Rpb24oKSB7CiAgICAgICAgICBjaGFuZ2VSZWFjdGlvblNjaGVkdWxlZCA9IGZhbHNlOwoKICAgICAgICAgIGlmIChmaXJzdFJ1bikgewogICAgICAgICAgICBmaXJzdFJ1biA9IGZhbHNlOwogICAgICAgICAgICBsaXN0ZW5lcihuZXdWYWx1ZXMsIG5ld1ZhbHVlcywgc2VsZik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaXN0ZW5lcihuZXdWYWx1ZXMsIG9sZFZhbHVlcywgc2VsZik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gZGVyZWdpc3RlcldhdGNoR3JvdXAoKSB7CiAgICAgICAgICB3aGlsZSAoZGVyZWdpc3RlckZucy5sZW5ndGgpIHsKICAgICAgICAgICAgZGVyZWdpc3RlckZucy5zaGlmdCgpKCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyR3YXRjaENvbGxlY3Rpb24KICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNoYWxsb3cgd2F0Y2hlcyB0aGUgcHJvcGVydGllcyBvZiBhbiBvYmplY3QgYW5kIGZpcmVzIHdoZW5ldmVyIGFueSBvZiB0aGUgcHJvcGVydGllcyBjaGFuZ2UKICAgICAgICogKGZvciBhcnJheXMsIHRoaXMgaW1wbGllcyB3YXRjaGluZyB0aGUgYXJyYXkgaXRlbXM7IGZvciBvYmplY3QgbWFwcywgdGhpcyBpbXBsaWVzIHdhdGNoaW5nCiAgICAgICAqIHRoZSBwcm9wZXJ0aWVzKS4gSWYgYSBjaGFuZ2UgaXMgZGV0ZWN0ZWQsIHRoZSBgbGlzdGVuZXJgIGNhbGxiYWNrIGlzIGZpcmVkLgogICAgICAgKgogICAgICAgKiAtIFRoZSBgb2JqYCBjb2xsZWN0aW9uIGlzIG9ic2VydmVkIHZpYSBzdGFuZGFyZCAkd2F0Y2ggb3BlcmF0aW9uIGFuZCBpcyBleGFtaW5lZCBvbiBldmVyeQogICAgICAgKiAgIGNhbGwgdG8gJGRpZ2VzdCgpIHRvIHNlZSBpZiBhbnkgaXRlbXMgaGF2ZSBiZWVuIGFkZGVkLCByZW1vdmVkLCBvciBtb3ZlZC4KICAgICAgICogLSBUaGUgYGxpc3RlbmVyYCBpcyBjYWxsZWQgd2hlbmV2ZXIgYW55dGhpbmcgd2l0aGluIHRoZSBgb2JqYCBoYXMgY2hhbmdlZC4gRXhhbXBsZXMgaW5jbHVkZQogICAgICAgKiAgIGFkZGluZywgcmVtb3ZpbmcsIGFuZCBtb3ZpbmcgaXRlbXMgYmVsb25naW5nIHRvIGFuIG9iamVjdCBvciBhcnJheS4KICAgICAgICoKICAgICAgICoKICAgICAgICogIyBFeGFtcGxlCiAgICAgICAqIGBgYGpzCiAgICAgICAgICAkc2NvcGUubmFtZXMgPSBbJ2lnb3InLCAnbWF0aWFzJywgJ21pc2tvJywgJ2phbWVzJ107CiAgICAgICAgICAkc2NvcGUuZGF0YUNvdW50ID0gNDsKCiAgICAgICAgICAkc2NvcGUuJHdhdGNoQ29sbGVjdGlvbignbmFtZXMnLCBmdW5jdGlvbihuZXdOYW1lcywgb2xkTmFtZXMpIHsKICAgICAgICAgICAgJHNjb3BlLmRhdGFDb3VudCA9IG5ld05hbWVzLmxlbmd0aDsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGV4cGVjdCgkc2NvcGUuZGF0YUNvdW50KS50b0VxdWFsKDQpOwogICAgICAgICAgJHNjb3BlLiRkaWdlc3QoKTsKCiAgICAgICAgICAvL3N0aWxsIGF0IDQgLi4uIG5vIGNoYW5nZXMKICAgICAgICAgIGV4cGVjdCgkc2NvcGUuZGF0YUNvdW50KS50b0VxdWFsKDQpOwoKICAgICAgICAgICRzY29wZS5uYW1lcy5wb3AoKTsKICAgICAgICAgICRzY29wZS4kZGlnZXN0KCk7CgogICAgICAgICAgLy9ub3cgdGhlcmUncyBiZWVuIGEgY2hhbmdlCiAgICAgICAgICBleHBlY3QoJHNjb3BlLmRhdGFDb3VudCkudG9FcXVhbCgzKTsKICAgICAgICogYGBgCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfGZ1bmN0aW9uKHNjb3BlKX0gb2JqIEV2YWx1YXRlZCBhcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4gVGhlCiAgICAgICAqICAgIGV4cHJlc3Npb24gdmFsdWUgc2hvdWxkIGV2YWx1YXRlIHRvIGFuIG9iamVjdCBvciBhbiBhcnJheSB3aGljaCBpcyBvYnNlcnZlZCBvbiBlYWNoCiAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gY3ljbGUuIEFueSBzaGFsbG93IGNoYW5nZSB3aXRoaW4gdGhlCiAgICAgICAqICAgIGNvbGxlY3Rpb24gd2lsbCB0cmlnZ2VyIGEgY2FsbCB0byB0aGUgYGxpc3RlbmVyYC4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihuZXdDb2xsZWN0aW9uLCBvbGRDb2xsZWN0aW9uLCBzY29wZSl9IGxpc3RlbmVyIGEgY2FsbGJhY2sgZnVuY3Rpb24gY2FsbGVkCiAgICAgICAqICAgIHdoZW4gYSBjaGFuZ2UgaXMgZGV0ZWN0ZWQuCiAgICAgICAqICAgIC0gVGhlIGBuZXdDb2xsZWN0aW9uYCBvYmplY3QgaXMgdGhlIG5ld2x5IG1vZGlmaWVkIGRhdGEgb2J0YWluZWQgZnJvbSB0aGUgYG9iamAgZXhwcmVzc2lvbgogICAgICAgKiAgICAtIFRoZSBgb2xkQ29sbGVjdGlvbmAgb2JqZWN0IGlzIGEgY29weSBvZiB0aGUgZm9ybWVyIGNvbGxlY3Rpb24gZGF0YS4KICAgICAgICogICAgICBEdWUgdG8gcGVyZm9ybWFuY2UgY29uc2lkZXJhdGlvbnMsIHRoZWBvbGRDb2xsZWN0aW9uYCB2YWx1ZSBpcyBjb21wdXRlZCBvbmx5IGlmIHRoZQogICAgICAgKiAgICAgIGBsaXN0ZW5lcmAgZnVuY3Rpb24gZGVjbGFyZXMgdHdvIG9yIG1vcmUgYXJndW1lbnRzLgogICAgICAgKiAgICAtIFRoZSBgc2NvcGVgIGFyZ3VtZW50IHJlZmVycyB0byB0aGUgY3VycmVudCBzY29wZS4KICAgICAgICoKICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZS1yZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIHRoaXMgbGlzdGVuZXIuIFdoZW4gdGhlCiAgICAgICAqICAgIGRlLXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBpcyBleGVjdXRlZCwgdGhlIGludGVybmFsIHdhdGNoIG9wZXJhdGlvbiBpcyB0ZXJtaW5hdGVkLgogICAgICAgKi8KICAgICAgJHdhdGNoQ29sbGVjdGlvbjogZnVuY3Rpb24ob2JqLCBsaXN0ZW5lcikgewogICAgICAgICR3YXRjaENvbGxlY3Rpb25JbnRlcmNlcHRvci4kc3RhdGVmdWwgPSB0cnVlOwoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgLy8gdGhlIGN1cnJlbnQgdmFsdWUsIHVwZGF0ZWQgb24gZWFjaCBkaXJ0eS1jaGVjayBydW4KICAgICAgICB2YXIgbmV3VmFsdWU7CiAgICAgICAgLy8gYSBzaGFsbG93IGNvcHkgb2YgdGhlIG5ld1ZhbHVlIGZyb20gdGhlIGxhc3QgZGlydHktY2hlY2sgcnVuLAogICAgICAgIC8vIHVwZGF0ZWQgdG8gbWF0Y2ggbmV3VmFsdWUgZHVyaW5nIGRpcnR5LWNoZWNrIHJ1bgogICAgICAgIHZhciBvbGRWYWx1ZTsKICAgICAgICAvLyBhIHNoYWxsb3cgY29weSBvZiB0aGUgbmV3VmFsdWUgZnJvbSB3aGVuIHRoZSBsYXN0IGNoYW5nZSBoYXBwZW5lZAogICAgICAgIHZhciB2ZXJ5T2xkVmFsdWU7CiAgICAgICAgLy8gb25seSB0cmFjayB2ZXJ5T2xkVmFsdWUgaWYgdGhlIGxpc3RlbmVyIGlzIGFza2luZyBmb3IgaXQKICAgICAgICB2YXIgdHJhY2tWZXJ5T2xkVmFsdWUgPSAobGlzdGVuZXIubGVuZ3RoID4gMSk7CiAgICAgICAgdmFyIGNoYW5nZURldGVjdGVkID0gMDsKICAgICAgICB2YXIgY2hhbmdlRGV0ZWN0b3IgPSAkcGFyc2Uob2JqLCAkd2F0Y2hDb2xsZWN0aW9uSW50ZXJjZXB0b3IpOwogICAgICAgIHZhciBpbnRlcm5hbEFycmF5ID0gW107CiAgICAgICAgdmFyIGludGVybmFsT2JqZWN0ID0ge307CiAgICAgICAgdmFyIGluaXRSdW4gPSB0cnVlOwogICAgICAgIHZhciBvbGRMZW5ndGggPSAwOwoKICAgICAgICBmdW5jdGlvbiAkd2F0Y2hDb2xsZWN0aW9uSW50ZXJjZXB0b3IoX3ZhbHVlKSB7CiAgICAgICAgICBuZXdWYWx1ZSA9IF92YWx1ZTsKICAgICAgICAgIHZhciBuZXdMZW5ndGgsIGtleSwgYm90aE5hTiwgbmV3SXRlbSwgb2xkSXRlbTsKCiAgICAgICAgICBpZiAoIWlzT2JqZWN0KG5ld1ZhbHVlKSkgeyAvLyBpZiBwcmltaXRpdmUKICAgICAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBuZXdWYWx1ZSkgewogICAgICAgICAgICAgIG9sZFZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5TGlrZShuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBpbnRlcm5hbEFycmF5KSB7CiAgICAgICAgICAgICAgLy8gd2UgYXJlIHRyYW5zaXRpb25pbmcgZnJvbSBzb21ldGhpbmcgd2hpY2ggd2FzIG5vdCBhbiBhcnJheSBpbnRvIGFycmF5LgogICAgICAgICAgICAgIG9sZFZhbHVlID0gaW50ZXJuYWxBcnJheTsKICAgICAgICAgICAgICBvbGRMZW5ndGggPSBvbGRWYWx1ZS5sZW5ndGggPSAwOwogICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5ld0xlbmd0aCA9IG5ld1ZhbHVlLmxlbmd0aDsKCiAgICAgICAgICAgIGlmIChvbGRMZW5ndGggIT09IG5ld0xlbmd0aCkgewogICAgICAgICAgICAgIC8vIGlmIGxlbmd0aHMgZG8gbm90IG1hdGNoIHdlIG5lZWQgdG8gdHJpZ2dlciBjaGFuZ2Ugbm90aWZpY2F0aW9uCiAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICBvbGRWYWx1ZS5sZW5ndGggPSBvbGRMZW5ndGggPSBuZXdMZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gY29weSB0aGUgaXRlbXMgdG8gb2xkVmFsdWUgYW5kIGxvb2sgZm9yIGNoYW5nZXMuCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3TGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBvbGRJdGVtID0gb2xkVmFsdWVbaV07CiAgICAgICAgICAgICAgbmV3SXRlbSA9IG5ld1ZhbHVlW2ldOwoKICAgICAgICAgICAgICBib3RoTmFOID0gKG9sZEl0ZW0gIT09IG9sZEl0ZW0pICYmIChuZXdJdGVtICE9PSBuZXdJdGVtKTsKICAgICAgICAgICAgICBpZiAoIWJvdGhOYU4gJiYgKG9sZEl0ZW0gIT09IG5ld0l0ZW0pKSB7CiAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgb2xkVmFsdWVbaV0gPSBuZXdJdGVtOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBpbnRlcm5hbE9iamVjdCkgewogICAgICAgICAgICAgIC8vIHdlIGFyZSB0cmFuc2l0aW9uaW5nIGZyb20gc29tZXRoaW5nIHdoaWNoIHdhcyBub3QgYW4gb2JqZWN0IGludG8gb2JqZWN0LgogICAgICAgICAgICAgIG9sZFZhbHVlID0gaW50ZXJuYWxPYmplY3QgPSB7fTsKICAgICAgICAgICAgICBvbGRMZW5ndGggPSAwOwogICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gY29weSB0aGUgaXRlbXMgdG8gb2xkVmFsdWUgYW5kIGxvb2sgZm9yIGNoYW5nZXMuCiAgICAgICAgICAgIG5ld0xlbmd0aCA9IDA7CiAgICAgICAgICAgIGZvciAoa2V5IGluIG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKG5ld1ZhbHVlLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgIG5ld0xlbmd0aCsrOwogICAgICAgICAgICAgICAgbmV3SXRlbSA9IG5ld1ZhbHVlW2tleV07CiAgICAgICAgICAgICAgICBvbGRJdGVtID0gb2xkVmFsdWVba2V5XTsKCiAgICAgICAgICAgICAgICBpZiAoa2V5IGluIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIGJvdGhOYU4gPSAob2xkSXRlbSAhPT0gb2xkSXRlbSkgJiYgKG5ld0l0ZW0gIT09IG5ld0l0ZW0pOwogICAgICAgICAgICAgICAgICBpZiAoIWJvdGhOYU4gJiYgKG9sZEl0ZW0gIT09IG5ld0l0ZW0pKSB7CiAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgICBvbGRWYWx1ZVtrZXldID0gbmV3SXRlbTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgb2xkTGVuZ3RoKys7CiAgICAgICAgICAgICAgICAgIG9sZFZhbHVlW2tleV0gPSBuZXdJdGVtOwogICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkTGVuZ3RoID4gbmV3TGVuZ3RoKSB7CiAgICAgICAgICAgICAgLy8gd2UgdXNlZCB0byBoYXZlIG1vcmUga2V5cywgbmVlZCB0byBmaW5kIHRoZW0gYW5kIGRlc3Ryb3kgdGhlbS4KICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgIGZvcihrZXkgaW4gb2xkVmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICghbmV3VmFsdWUuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICBvbGRMZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgZGVsZXRlIG9sZFZhbHVlW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2hhbmdlRGV0ZWN0ZWQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiAkd2F0Y2hDb2xsZWN0aW9uQWN0aW9uKCkgewogICAgICAgICAgaWYgKGluaXRSdW4pIHsKICAgICAgICAgICAgaW5pdFJ1biA9IGZhbHNlOwogICAgICAgICAgICBsaXN0ZW5lcihuZXdWYWx1ZSwgbmV3VmFsdWUsIHNlbGYpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlzdGVuZXIobmV3VmFsdWUsIHZlcnlPbGRWYWx1ZSwgc2VsZik7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gbWFrZSBhIGNvcHkgZm9yIHRoZSBuZXh0IHRpbWUgYSBjb2xsZWN0aW9uIGlzIGNoYW5nZWQKICAgICAgICAgIGlmICh0cmFja1ZlcnlPbGRWYWx1ZSkgewogICAgICAgICAgICBpZiAoIWlzT2JqZWN0KG5ld1ZhbHVlKSkgewogICAgICAgICAgICAgIC8vcHJpbWl0aXZlCiAgICAgICAgICAgICAgdmVyeU9sZFZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheUxpa2UobmV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgdmVyeU9sZFZhbHVlID0gbmV3IEFycmF5KG5ld1ZhbHVlLmxlbmd0aCk7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdWYWx1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmVyeU9sZFZhbHVlW2ldID0gbmV3VmFsdWVbaV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgeyAvLyBpZiBvYmplY3QKICAgICAgICAgICAgICB2ZXJ5T2xkVmFsdWUgPSB7fTsKICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG5ld1ZhbHVlLCBrZXkpKSB7CiAgICAgICAgICAgICAgICAgIHZlcnlPbGRWYWx1ZVtrZXldID0gbmV3VmFsdWVba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLiR3YXRjaChjaGFuZ2VEZXRlY3RvciwgJHdhdGNoQ29sbGVjdGlvbkFjdGlvbik7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFByb2Nlc3NlcyBhbGwgb2YgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30gb2YgdGhlIGN1cnJlbnQgc2NvcGUgYW5kCiAgICAgICAqIGl0cyBjaGlsZHJlbi4gQmVjYXVzZSBhIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyfSdzIGxpc3RlbmVyIGNhbiBjaGFuZ2UKICAgICAgICogdGhlIG1vZGVsLCB0aGUgYCRkaWdlc3QoKWAga2VlcHMgY2FsbGluZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJzfQogICAgICAgKiB1bnRpbCBubyBtb3JlIGxpc3RlbmVycyBhcmUgZmlyaW5nLiBUaGlzIG1lYW5zIHRoYXQgaXQgaXMgcG9zc2libGUgdG8gZ2V0IGludG8gYW4gaW5maW5pdGUKICAgICAgICogbG9vcC4gVGhpcyBmdW5jdGlvbiB3aWxsIHRocm93IGAnTWF4aW11bSBpdGVyYXRpb24gbGltaXQgZXhjZWVkZWQuJ2AgaWYgdGhlIG51bWJlciBvZgogICAgICAgKiBpdGVyYXRpb25zIGV4Y2VlZHMgMTAuCiAgICAgICAqCiAgICAgICAqIFVzdWFsbHksIHlvdSBkb24ndCBjYWxsIGAkZGlnZXN0KClgIGRpcmVjdGx5IGluCiAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDb250cm9sbGVyIGNvbnRyb2xsZXJzfSBvciBpbgogICAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30uCiAgICAgICAqIEluc3RlYWQsIHlvdSBzaG91bGQgY2FsbCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkYXBwbHkgJGFwcGx5KCl9ICh0eXBpY2FsbHkgZnJvbSB3aXRoaW4KICAgICAgICogYSB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlfSksIHdoaWNoIHdpbGwgZm9yY2UgYSBgJGRpZ2VzdCgpYC4KICAgICAgICoKICAgICAgICogSWYgeW91IHdhbnQgdG8gYmUgbm90aWZpZWQgd2hlbmV2ZXIgYCRkaWdlc3QoKWAgaXMgY2FsbGVkLAogICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gd2l0aAogICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggJHdhdGNoKCl9IHdpdGggbm8gYGxpc3RlbmVyYC4KICAgICAgICoKICAgICAgICogSW4gdW5pdCB0ZXN0cywgeW91IG1heSBuZWVkIHRvIGNhbGwgYCRkaWdlc3QoKWAgdG8gc2ltdWxhdGUgdGhlIHNjb3BlIGxpZmUgY3ljbGUuCiAgICAgICAqCiAgICAgICAqICMgRXhhbXBsZQogICAgICAgKiBgYGBqcwogICAgICAgICAgIHZhciBzY29wZSA9IC4uLjsKICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICBzY29wZS5jb3VudGVyID0gMDsKCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICBzY29wZS5jb3VudGVyID0gc2NvcGUuY291bnRlciArIDE7CiAgICAgICAgICAgfSk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAvLyB0aGUgbGlzdGVuZXIgaXMgYWx3YXlzIGNhbGxlZCBkdXJpbmcgdGhlIGZpcnN0ICRkaWdlc3QgbG9vcCBhZnRlciBpdCB3YXMgcmVnaXN0ZXJlZAogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwoKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgLy8gYnV0IG5vdyBpdCB3aWxsIG5vdCBiZSBjYWxsZWQgdW5sZXNzIHRoZSB2YWx1ZSBjaGFuZ2VzCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMSk7CgogICAgICAgICAgIHNjb3BlLm5hbWUgPSAnYWRhbSc7CiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDIpOwogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICovCiAgICAgICRkaWdlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB3YXRjaCwgdmFsdWUsIGxhc3QsCiAgICAgICAgICAgIHdhdGNoZXJzLAogICAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICAgIGRpcnR5LCB0dGwgPSBUVEwsCiAgICAgICAgICAgIG5leHQsIGN1cnJlbnQsIHRhcmdldCA9IHRoaXMsCiAgICAgICAgICAgIHdhdGNoTG9nID0gW10sCiAgICAgICAgICAgIGxvZ0lkeCwgbG9nTXNnLCBhc3luY1Rhc2s7CgogICAgICAgIGJlZ2luUGhhc2UoJyRkaWdlc3QnKTsKICAgICAgICAvLyBDaGVjayBmb3IgY2hhbmdlcyB0byBicm93c2VyIHVybCB0aGF0IGhhcHBlbmVkIGluIHN5bmMgYmVmb3JlIHRoZSBjYWxsIHRvICRkaWdlc3QKICAgICAgICAkYnJvd3Nlci4kJGNoZWNrVXJsQ2hhbmdlKCk7CgogICAgICAgIGlmICh0aGlzID09PSAkcm9vdFNjb3BlICYmIGFwcGx5QXN5bmNJZCAhPT0gbnVsbCkgewogICAgICAgICAgLy8gSWYgdGhpcyBpcyB0aGUgcm9vdCBzY29wZSwgYW5kICRhcHBseUFzeW5jIGhhcyBzY2hlZHVsZWQgYSBkZWZlcnJlZCAkYXBwbHkoKSwgdGhlbgogICAgICAgICAgLy8gY2FuY2VsIHRoZSBzY2hlZHVsZWQgJGFwcGx5IGFuZCBmbHVzaCB0aGUgcXVldWUgb2YgZXhwcmVzc2lvbnMgdG8gYmUgZXZhbHVhdGVkLgogICAgICAgICAgJGJyb3dzZXIuZGVmZXIuY2FuY2VsKGFwcGx5QXN5bmNJZCk7CiAgICAgICAgICBmbHVzaEFwcGx5QXN5bmMoKTsKICAgICAgICB9CgogICAgICAgIGxhc3REaXJ0eVdhdGNoID0gbnVsbDsKCiAgICAgICAgZG8geyAvLyAid2hpbGUgZGlydHkiIGxvb3AKICAgICAgICAgIGRpcnR5ID0gZmFsc2U7CiAgICAgICAgICBjdXJyZW50ID0gdGFyZ2V0OwoKICAgICAgICAgIHdoaWxlKGFzeW5jUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgYXN5bmNUYXNrID0gYXN5bmNRdWV1ZS5zaGlmdCgpOwogICAgICAgICAgICAgIGFzeW5jVGFzay5zY29wZS4kZXZhbChhc3luY1Rhc2suZXhwcmVzc2lvbik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0RGlydHlXYXRjaCA9IG51bGw7CiAgICAgICAgICB9CgogICAgICAgICAgdHJhdmVyc2VTY29wZXNMb29wOgogICAgICAgICAgZG8geyAvLyAidHJhdmVyc2UgdGhlIHNjb3BlcyIgbG9vcAogICAgICAgICAgICBpZiAoKHdhdGNoZXJzID0gY3VycmVudC4kJHdhdGNoZXJzKSkgewogICAgICAgICAgICAgIC8vIHByb2Nlc3Mgb3VyIHdhdGNoZXMKICAgICAgICAgICAgICBsZW5ndGggPSB3YXRjaGVycy5sZW5ndGg7CiAgICAgICAgICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB3YXRjaCA9IHdhdGNoZXJzW2xlbmd0aF07CiAgICAgICAgICAgICAgICAgIC8vIE1vc3QgY29tbW9uIHdhdGNoZXMgYXJlIG9uIHByaW1pdGl2ZXMsIGluIHdoaWNoIGNhc2Ugd2UgY2FuIHNob3J0CiAgICAgICAgICAgICAgICAgIC8vIGNpcmN1aXQgaXQgd2l0aCA9PT0gb3BlcmF0b3IsIG9ubHkgd2hlbiA9PT0gZmFpbHMgZG8gd2UgdXNlIC5lcXVhbHMKICAgICAgICAgICAgICAgICAgaWYgKHdhdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCh2YWx1ZSA9IHdhdGNoLmdldChjdXJyZW50KSkgIT09IChsYXN0ID0gd2F0Y2gubGFzdCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgISh3YXRjaC5lcQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBlcXVhbHModmFsdWUsIGxhc3QpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInICYmIHR5cGVvZiBsYXN0ID09PSAnbnVtYmVyJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgaXNOYU4odmFsdWUpICYmIGlzTmFOKGxhc3QpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIGxhc3REaXJ0eVdhdGNoID0gd2F0Y2g7CiAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5sYXN0ID0gd2F0Y2guZXEgPyBjb3B5KHZhbHVlLCBudWxsKSA6IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgd2F0Y2guZm4odmFsdWUsICgobGFzdCA9PT0gaW5pdFdhdGNoVmFsKSA/IHZhbHVlIDogbGFzdCksIGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHR0bCA8IDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nSWR4ID0gNCAtIHR0bDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF3YXRjaExvZ1tsb2dJZHhdKSB3YXRjaExvZ1tsb2dJZHhdID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ01zZyA9IChpc0Z1bmN0aW9uKHdhdGNoLmV4cCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdmbjogJyArICh3YXRjaC5leHAubmFtZSB8fCB3YXRjaC5leHAudG9TdHJpbmcoKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogd2F0Y2guZXhwOwogICAgICAgICAgICAgICAgICAgICAgICBsb2dNc2cgKz0gJzsgbmV3VmFsOiAnICsgdG9Kc29uKHZhbHVlKSArICc7IG9sZFZhbDogJyArIHRvSnNvbihsYXN0KTsKICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2hMb2dbbG9nSWR4XS5wdXNoKGxvZ01zZyk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh3YXRjaCA9PT0gbGFzdERpcnR5V2F0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBtb3N0IHJlY2VudGx5IGRpcnR5IHdhdGNoZXIgaXMgbm93IGNsZWFuLCBzaG9ydCBjaXJjdWl0IHNpbmNlIHRoZSByZW1haW5pbmcgd2F0Y2hlcnMKICAgICAgICAgICAgICAgICAgICAgIC8vIGhhdmUgYWxyZWFkeSBiZWVuIHRlc3RlZC4KICAgICAgICAgICAgICAgICAgICAgIGRpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayB0cmF2ZXJzZVNjb3Blc0xvb3A7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSW5zYW5pdHkgV2FybmluZzogc2NvcGUgZGVwdGgtZmlyc3QgdHJhdmVyc2FsCiAgICAgICAgICAgIC8vIHllcywgdGhpcyBjb2RlIGlzIGEgYml0IGNyYXp5LCBidXQgaXQgd29ya3MgYW5kIHdlIGhhdmUgdGVzdHMgdG8gcHJvdmUgaXQhCiAgICAgICAgICAgIC8vIHRoaXMgcGllY2Ugc2hvdWxkIGJlIGtlcHQgaW4gc3luYyB3aXRoIHRoZSB0cmF2ZXJzYWwgaW4gJGJyb2FkY2FzdAogICAgICAgICAgICBpZiAoIShuZXh0ID0gKGN1cnJlbnQuJCRjaGlsZEhlYWQgfHwKICAgICAgICAgICAgICAgIChjdXJyZW50ICE9PSB0YXJnZXQgJiYgY3VycmVudC4kJG5leHRTaWJsaW5nKSkpKSB7CiAgICAgICAgICAgICAgd2hpbGUoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlICgoY3VycmVudCA9IG5leHQpKTsKCiAgICAgICAgICAvLyBgYnJlYWsgdHJhdmVyc2VTY29wZXNMb29wO2AgdGFrZXMgdXMgdG8gaGVyZQoKICAgICAgICAgIGlmKChkaXJ0eSB8fCBhc3luY1F1ZXVlLmxlbmd0aCkgJiYgISh0dGwtLSkpIHsKICAgICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgICB0aHJvdyAkcm9vdFNjb3BlTWluRXJyKCdpbmZkaWcnLAogICAgICAgICAgICAgICAgJ3swfSAkZGlnZXN0KCkgaXRlcmF0aW9ucyByZWFjaGVkLiBBYm9ydGluZyFcbicgKwogICAgICAgICAgICAgICAgJ1dhdGNoZXJzIGZpcmVkIGluIHRoZSBsYXN0IDUgaXRlcmF0aW9uczogezF9JywKICAgICAgICAgICAgICAgIFRUTCwgdG9Kc29uKHdhdGNoTG9nKSk7CiAgICAgICAgICB9CgogICAgICAgIH0gd2hpbGUgKGRpcnR5IHx8IGFzeW5jUXVldWUubGVuZ3RoKTsKCiAgICAgICAgY2xlYXJQaGFzZSgpOwoKICAgICAgICB3aGlsZShwb3N0RGlnZXN0UXVldWUubGVuZ3RoKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBwb3N0RGlnZXN0UXVldWUuc2hpZnQoKSgpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95CiAgICAgICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHNjb3BlIGJlaW5nIGRlc3Ryb3llZAogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogQnJvYWRjYXN0ZWQgd2hlbiBhIHNjb3BlIGFuZCBpdHMgY2hpbGRyZW4gYXJlIGJlaW5nIGRlc3Ryb3llZC4KICAgICAgICoKICAgICAgICogTm90ZSB0aGF0LCBpbiBBbmd1bGFySlMsIHRoZXJlIGlzIGFsc28gYSBgJGRlc3Ryb3lgIGpRdWVyeSBldmVudCwgd2hpY2ggY2FuIGJlIHVzZWQgdG8KICAgICAgICogY2xlYW4gdXAgRE9NIGJpbmRpbmdzIGJlZm9yZSBhbiBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NLgogICAgICAgKi8KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGRlc3Ryb3kKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFJlbW92ZXMgdGhlIGN1cnJlbnQgc2NvcGUgKGFuZCBhbGwgb2YgaXRzIGNoaWxkcmVuKSBmcm9tIHRoZSBwYXJlbnQgc2NvcGUuIFJlbW92YWwgaW1wbGllcwogICAgICAgKiB0aGF0IGNhbGxzIHRvIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSB3aWxsIG5vIGxvbmdlcgogICAgICAgKiBwcm9wYWdhdGUgdG8gdGhlIGN1cnJlbnQgc2NvcGUgYW5kIGl0cyBjaGlsZHJlbi4gUmVtb3ZhbCBhbHNvIGltcGxpZXMgdGhhdCB0aGUgY3VycmVudAogICAgICAgKiBzY29wZSBpcyBlbGlnaWJsZSBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uLgogICAgICAgKgogICAgICAgKiBUaGUgYCRkZXN0cm95KClgIGlzIHVzdWFsbHkgdXNlZCBieSBkaXJlY3RpdmVzIHN1Y2ggYXMKICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0gZm9yIG1hbmFnaW5nIHRoZQogICAgICAgKiB1bnJvbGxpbmcgb2YgdGhlIGxvb3AuCiAgICAgICAqCiAgICAgICAqIEp1c3QgYmVmb3JlIGEgc2NvcGUgaXMgZGVzdHJveWVkLCBhIGAkZGVzdHJveWAgZXZlbnQgaXMgYnJvYWRjYXN0ZWQgb24gdGhpcyBzY29wZS4KICAgICAgICogQXBwbGljYXRpb24gY29kZSBjYW4gcmVnaXN0ZXIgYSBgJGRlc3Ryb3lgIGV2ZW50IGhhbmRsZXIgdGhhdCB3aWxsIGdpdmUgaXQgYSBjaGFuY2UgdG8KICAgICAgICogcGVyZm9ybSBhbnkgbmVjZXNzYXJ5IGNsZWFudXAuCiAgICAgICAqCiAgICAgICAqIE5vdGUgdGhhdCwgaW4gQW5ndWxhckpTLCB0aGVyZSBpcyBhbHNvIGEgYCRkZXN0cm95YCBqUXVlcnkgZXZlbnQsIHdoaWNoIGNhbiBiZSB1c2VkIHRvCiAgICAgICAqIGNsZWFuIHVwIERPTSBiaW5kaW5ncyBiZWZvcmUgYW4gZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTS4KICAgICAgICovCiAgICAgICRkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAvLyB3ZSBjYW4ndCBkZXN0cm95IHRoZSByb290IHNjb3BlIG9yIGEgc2NvcGUgdGhhdCBoYXMgYmVlbiBhbHJlYWR5IGRlc3Ryb3llZAogICAgICAgIGlmICh0aGlzLiQkZGVzdHJveWVkKSByZXR1cm47CiAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMuJHBhcmVudDsKCiAgICAgICAgdGhpcy4kYnJvYWRjYXN0KCckZGVzdHJveScpOwogICAgICAgIHRoaXMuJCRkZXN0cm95ZWQgPSB0cnVlOwogICAgICAgIGlmICh0aGlzID09PSAkcm9vdFNjb3BlKSByZXR1cm47CgogICAgICAgIGZvciAodmFyIGV2ZW50TmFtZSBpbiB0aGlzLiQkbGlzdGVuZXJDb3VudCkgewogICAgICAgICAgZGVjcmVtZW50TGlzdGVuZXJDb3VudCh0aGlzLCB0aGlzLiQkbGlzdGVuZXJDb3VudFtldmVudE5hbWVdLCBldmVudE5hbWUpOwogICAgICAgIH0KCiAgICAgICAgLy8gc2V2ZXIgYWxsIHRoZSByZWZlcmVuY2VzIHRvIHBhcmVudCBzY29wZXMgKGFmdGVyIHRoaXMgY2xlYW51cCwgdGhlIGN1cnJlbnQgc2NvcGUgc2hvdWxkCiAgICAgICAgLy8gbm90IGJlIHJldGFpbmVkIGJ5IGFueSBvZiBvdXIgcmVmZXJlbmNlcyBhbmQgc2hvdWxkIGJlIGVsaWdpYmxlIGZvciBnYXJiYWdlIGNvbGxlY3Rpb24pCiAgICAgICAgaWYgKHBhcmVudC4kJGNoaWxkSGVhZCA9PSB0aGlzKSBwYXJlbnQuJCRjaGlsZEhlYWQgPSB0aGlzLiQkbmV4dFNpYmxpbmc7CiAgICAgICAgaWYgKHBhcmVudC4kJGNoaWxkVGFpbCA9PSB0aGlzKSBwYXJlbnQuJCRjaGlsZFRhaWwgPSB0aGlzLiQkcHJldlNpYmxpbmc7CiAgICAgICAgaWYgKHRoaXMuJCRwcmV2U2libGluZykgdGhpcy4kJHByZXZTaWJsaW5nLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkbmV4dFNpYmxpbmc7CiAgICAgICAgaWYgKHRoaXMuJCRuZXh0U2libGluZykgdGhpcy4kJG5leHRTaWJsaW5nLiQkcHJldlNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmc7CgogICAgICAgIC8vIERpc2FibGUgbGlzdGVuZXJzLCB3YXRjaGVycyBhbmQgYXBwbHkvZGlnZXN0IG1ldGhvZHMKICAgICAgICB0aGlzLiRkZXN0cm95ID0gdGhpcy4kZGlnZXN0ID0gdGhpcy4kYXBwbHkgPSB0aGlzLiRldmFsQXN5bmMgPSB0aGlzLiRhcHBseUFzeW5jID0gbm9vcDsKICAgICAgICB0aGlzLiRvbiA9IHRoaXMuJHdhdGNoID0gdGhpcy4kd2F0Y2hHcm91cCA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gbm9vcDsgfTsKICAgICAgICB0aGlzLiQkbGlzdGVuZXJzID0ge307CgogICAgICAgIC8vIEFsbCBvZiB0aGUgY29kZSBiZWxvdyBpcyBib2d1cyBjb2RlIHRoYXQgd29ya3MgYXJvdW5kIFY4J3MgbWVtb3J5IGxlYWsgdmlhIG9wdGltaXplZCBjb2RlCiAgICAgICAgLy8gYW5kIGlubGluZSBjYWNoZXMuCiAgICAgICAgLy8KICAgICAgICAvLyBzZWU6CiAgICAgICAgLy8gLSBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL3Y4L2lzc3Vlcy9kZXRhaWw/aWQ9MjA3MyNjMjYKICAgICAgICAvLyAtIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvaXNzdWVzLzY3OTQjaXNzdWVjb21tZW50LTM4NjQ4OTA5CiAgICAgICAgLy8gLSBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy8xMzEzI2lzc3VlY29tbWVudC0xMDM3ODQ1MQoKICAgICAgICB0aGlzLiRwYXJlbnQgPSB0aGlzLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmcgPSB0aGlzLiQkY2hpbGRIZWFkID0KICAgICAgICAgICAgdGhpcy4kJGNoaWxkVGFpbCA9IHRoaXMuJHJvb3QgPSB0aGlzLiQkd2F0Y2hlcnMgPSBudWxsOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZXZhbAogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogRXhlY3V0ZXMgdGhlIGBleHByZXNzaW9uYCBvbiB0aGUgY3VycmVudCBzY29wZSBhbmQgcmV0dXJucyB0aGUgcmVzdWx0LiBBbnkgZXhjZXB0aW9ucyBpbgogICAgICAgKiB0aGUgZXhwcmVzc2lvbiBhcmUgcHJvcGFnYXRlZCAodW5jYXVnaHQpLiBUaGlzIGlzIHVzZWZ1bCB3aGVuIGV2YWx1YXRpbmcgQW5ndWxhcgogICAgICAgKiBleHByZXNzaW9ucy4KICAgICAgICoKICAgICAgICogIyBFeGFtcGxlCiAgICAgICAqIGBgYGpzCiAgICAgICAgICAgdmFyIHNjb3BlID0gbmcuJHJvb3RTY29wZS5TY29wZSgpOwogICAgICAgICAgIHNjb3BlLmEgPSAxOwogICAgICAgICAgIHNjb3BlLmIgPSAyOwoKICAgICAgICAgICBleHBlY3Qoc2NvcGUuJGV2YWwoJ2ErYicpKS50b0VxdWFsKDMpOwogICAgICAgICAgIGV4cGVjdChzY29wZS4kZXZhbChmdW5jdGlvbihzY29wZSl7IHJldHVybiBzY29wZS5hICsgc2NvcGUuYjsgfSkpLnRvRXF1YWwoMyk7CiAgICAgICAqIGBgYAogICAgICAgKgogICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICoKICAgICAgICogICAgLSBgc3RyaW5nYDogZXhlY3V0ZSB1c2luZyB0aGUgcnVsZXMgYXMgZGVmaW5lZCBpbiAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uCiAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7KG9iamVjdCk9fSBsb2NhbHMgTG9jYWwgdmFyaWFibGVzIG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbiBzY29wZS4KICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICovCiAgICAgICRldmFsOiBmdW5jdGlvbihleHByLCBsb2NhbHMpIHsKICAgICAgICByZXR1cm4gJHBhcnNlKGV4cHIpKHRoaXMsIGxvY2Fscyk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRldmFsQXN5bmMKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEV4ZWN1dGVzIHRoZSBleHByZXNzaW9uIG9uIHRoZSBjdXJyZW50IHNjb3BlIGF0IGEgbGF0ZXIgcG9pbnQgaW4gdGltZS4KICAgICAgICoKICAgICAgICogVGhlIGAkZXZhbEFzeW5jYCBtYWtlcyBubyBndWFyYW50ZWVzIGFzIHRvIHdoZW4gdGhlIGBleHByZXNzaW9uYCB3aWxsIGJlIGV4ZWN1dGVkLCBvbmx5CiAgICAgICAqIHRoYXQ6CiAgICAgICAqCiAgICAgICAqICAgLSBpdCB3aWxsIGV4ZWN1dGUgYWZ0ZXIgdGhlIGZ1bmN0aW9uIHRoYXQgc2NoZWR1bGVkIHRoZSBldmFsdWF0aW9uIChwcmVmZXJhYmx5IGJlZm9yZSBET00KICAgICAgICogICAgIHJlbmRlcmluZykuCiAgICAgICAqICAgLSBhdCBsZWFzdCBvbmUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0IGN5Y2xlfSB3aWxsIGJlIHBlcmZvcm1lZCBhZnRlcgogICAgICAgKiAgICAgYGV4cHJlc3Npb25gIGV4ZWN1dGlvbi4KICAgICAgICoKICAgICAgICogQW55IGV4Y2VwdGlvbnMgZnJvbSB0aGUgZXhlY3V0aW9uIG9mIHRoZSBleHByZXNzaW9uIGFyZSBmb3J3YXJkZWQgdG8gdGhlCiAgICAgICAqIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICoKICAgICAgICogX19Ob3RlOl9fIGlmIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIG91dHNpZGUgb2YgYSBgJGRpZ2VzdGAgY3ljbGUsIGEgbmV3IGAkZGlnZXN0YCBjeWNsZQogICAgICAgKiB3aWxsIGJlIHNjaGVkdWxlZC4gSG93ZXZlciwgaXQgaXMgZW5jb3VyYWdlZCB0byBhbHdheXMgY2FsbCBjb2RlIHRoYXQgY2hhbmdlcyB0aGUgbW9kZWwKICAgICAgICogZnJvbSB3aXRoaW4gYW4gYCRhcHBseWAgY2FsbC4gVGhhdCBpbmNsdWRlcyBjb2RlIGV2YWx1YXRlZCB2aWEgYCRldmFsQXN5bmNgLgogICAgICAgKgogICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICoKICAgICAgICogICAgLSBgc3RyaW5nYDogZXhlY3V0ZSB1c2luZyB0aGUgcnVsZXMgYXMgZGVmaW5lZCBpbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4KICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogZXhlY3V0ZSB0aGUgZnVuY3Rpb24gd2l0aCB0aGUgY3VycmVudCBgc2NvcGVgIHBhcmFtZXRlci4KICAgICAgICoKICAgICAgICovCiAgICAgICRldmFsQXN5bmM6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgICAvLyBpZiB3ZSBhcmUgb3V0c2lkZSBvZiBhbiAkZGlnZXN0IGxvb3AgYW5kIHRoaXMgaXMgdGhlIGZpcnN0IHRpbWUgd2UgYXJlIHNjaGVkdWxpbmcgYXN5bmMKICAgICAgICAvLyB0YXNrIGFsc28gc2NoZWR1bGUgYXN5bmMgYXV0by1mbHVzaAogICAgICAgIGlmICghJHJvb3RTY29wZS4kJHBoYXNlICYmICFhc3luY1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgJGJyb3dzZXIuZGVmZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChhc3luY1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGFzeW5jUXVldWUucHVzaCh7c2NvcGU6IHRoaXMsIGV4cHJlc3Npb246IGV4cHJ9KTsKICAgICAgfSwKCiAgICAgICQkcG9zdERpZ2VzdCA6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgcG9zdERpZ2VzdFF1ZXVlLnB1c2goZm4pOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkYXBwbHkKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIGAkYXBwbHkoKWAgaXMgdXNlZCB0byBleGVjdXRlIGFuIGV4cHJlc3Npb24gaW4gYW5ndWxhciBmcm9tIG91dHNpZGUgb2YgdGhlIGFuZ3VsYXIKICAgICAgICogZnJhbWV3b3JrLiAoRm9yIGV4YW1wbGUgZnJvbSBicm93c2VyIERPTSBldmVudHMsIHNldFRpbWVvdXQsIFhIUiBvciB0aGlyZCBwYXJ0eSBsaWJyYXJpZXMpLgogICAgICAgKiBCZWNhdXNlIHdlIGFyZSBjYWxsaW5nIGludG8gdGhlIGFuZ3VsYXIgZnJhbWV3b3JrIHdlIG5lZWQgdG8gcGVyZm9ybSBwcm9wZXIgc2NvcGUgbGlmZQogICAgICAgKiBjeWNsZSBvZiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgZXhjZXB0aW9uIGhhbmRsaW5nfSwKICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCBleGVjdXRpbmcgd2F0Y2hlc30uCiAgICAgICAqCiAgICAgICAqICMjIExpZmUgY3ljbGUKICAgICAgICoKICAgICAgICogIyBQc2V1ZG8tQ29kZSBvZiBgJGFwcGx5KClgCiAgICAgICAqIGBgYGpzCiAgICAgICAgICAgZnVuY3Rpb24gJGFwcGx5KGV4cHIpIHsKICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgIHJldHVybiAkZXZhbChleHByKTsKICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAkcm9vdC4kZGlnZXN0KCk7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgfQogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICoKICAgICAgICogU2NvcGUncyBgJGFwcGx5KClgIG1ldGhvZCB0cmFuc2l0aW9ucyB0aHJvdWdoIHRoZSBmb2xsb3dpbmcgc3RhZ2VzOgogICAgICAgKgogICAgICAgKiAxLiBUaGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgZXhlY3V0ZWQgdXNpbmcgdGhlCiAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsICRldmFsKCl9IG1ldGhvZC4KICAgICAgICogMi4gQW55IGV4Y2VwdGlvbnMgZnJvbSB0aGUgZXhlY3V0aW9uIG9mIHRoZSBleHByZXNzaW9uIGFyZSBmb3J3YXJkZWQgdG8gdGhlCiAgICAgICAqICAgIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICogMy4gVGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaH0gbGlzdGVuZXJzIGFyZSBmaXJlZCBpbW1lZGlhdGVseSBhZnRlciB0aGUKICAgICAgICogICAgZXhwcmVzc2lvbiB3YXMgZXhlY3V0ZWQgdXNpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBtZXRob2QuCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cCBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAqCiAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uCiAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggY3VycmVudCBgc2NvcGVgIHBhcmFtZXRlci4KICAgICAgICoKICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICovCiAgICAgICRhcHBseTogZnVuY3Rpb24oZXhwcikgewogICAgICAgIHRyeSB7CiAgICAgICAgICBiZWdpblBoYXNlKCckYXBwbHknKTsKICAgICAgICAgIHJldHVybiB0aGlzLiRldmFsKGV4cHIpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBjbGVhclBoYXNlKCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkYXBwbHlBc3luYwogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2NoZWR1bGUgdGhlIGludm9rYXRpb24gb2YgJGFwcGx5IHRvIG9jY3VyIGF0IGEgbGF0ZXIgdGltZS4gVGhlIGFjdHVhbCB0aW1lIGRpZmZlcmVuY2UKICAgICAgICogdmFyaWVzIGFjcm9zcyBicm93c2VycywgYnV0IGlzIHR5cGljYWxseSBhcm91bmQgfjEwIG1pbGxpc2Vjb25kcy4KICAgICAgICoKICAgICAgICogVGhpcyBjYW4gYmUgdXNlZCB0byBxdWV1ZSB1cCBtdWx0aXBsZSBleHByZXNzaW9ucyB3aGljaCBuZWVkIHRvIGJlIGV2YWx1YXRlZCBpbiB0aGUgc2FtZQogICAgICAgKiBkaWdlc3QuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cCBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAqCiAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uCiAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggY3VycmVudCBgc2NvcGVgIHBhcmFtZXRlci4KICAgICAgICovCiAgICAgICRhcHBseUFzeW5jOiBmdW5jdGlvbihleHByKSB7CiAgICAgICAgdmFyIHNjb3BlID0gdGhpczsKICAgICAgICBleHByICYmIGFwcGx5QXN5bmNRdWV1ZS5wdXNoKCRhcHBseUFzeW5jRXhwcmVzc2lvbik7CiAgICAgICAgc2NoZWR1bGVBcHBseUFzeW5jKCk7CgogICAgICAgIGZ1bmN0aW9uICRhcHBseUFzeW5jRXhwcmVzc2lvbigpIHsKICAgICAgICAgIHNjb3BlLiRldmFsKGV4cHIpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJG9uCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBMaXN0ZW5zIG9uIGV2ZW50cyBvZiBhIGdpdmVuIHR5cGUuIFNlZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZW1pdCAkZW1pdH0gZm9yCiAgICAgICAqIGRpc2N1c3Npb24gb2YgZXZlbnQgbGlmZSBjeWNsZS4KICAgICAgICoKICAgICAgICogVGhlIGV2ZW50IGxpc3RlbmVyIGZ1bmN0aW9uIGZvcm1hdCBpczogYGZ1bmN0aW9uKGV2ZW50LCBhcmdzLi4uKWAuIFRoZSBgZXZlbnRgIG9iamVjdAogICAgICAgKiBwYXNzZWQgaW50byB0aGUgbGlzdGVuZXIgaGFzIHRoZSBmb2xsb3dpbmcgYXR0cmlidXRlczoKICAgICAgICoKICAgICAgICogICAtIGB0YXJnZXRTY29wZWAgLSBge1Njb3BlfWA6IHRoZSBzY29wZSBvbiB3aGljaCB0aGUgZXZlbnQgd2FzIGAkZW1pdGAtZWQgb3IKICAgICAgICogICAgIGAkYnJvYWRjYXN0YC1lZC4KICAgICAgICogICAtIGBjdXJyZW50U2NvcGVgIC0gYHtTY29wZX1gOiB0aGUgc2NvcGUgdGhhdCBpcyBjdXJyZW50bHkgaGFuZGxpbmcgdGhlIGV2ZW50LiBPbmNlIHRoZQogICAgICAgKiAgICAgZXZlbnQgcHJvcGFnYXRlcyB0aHJvdWdoIHRoZSBzY29wZSBoaWVyYXJjaHksIHRoaXMgcHJvcGVydHkgaXMgc2V0IHRvIG51bGwuCiAgICAgICAqICAgLSBgbmFtZWAgLSBge3N0cmluZ31gOiBuYW1lIG9mIHRoZSBldmVudC4KICAgICAgICogICAtIGBzdG9wUHJvcGFnYXRpb25gIC0gYHtmdW5jdGlvbj19YDogY2FsbGluZyBgc3RvcFByb3BhZ2F0aW9uYCBmdW5jdGlvbiB3aWxsIGNhbmNlbAogICAgICAgKiAgICAgZnVydGhlciBldmVudCBwcm9wYWdhdGlvbiAoYXZhaWxhYmxlIG9ubHkgZm9yIGV2ZW50cyB0aGF0IHdlcmUgYCRlbWl0YC1lZCkuCiAgICAgICAqICAgLSBgcHJldmVudERlZmF1bHRgIC0gYHtmdW5jdGlvbn1gOiBjYWxsaW5nIGBwcmV2ZW50RGVmYXVsdGAgc2V0cyBgZGVmYXVsdFByZXZlbnRlZGAgZmxhZwogICAgICAgKiAgICAgdG8gdHJ1ZS4KICAgICAgICogICAtIGBkZWZhdWx0UHJldmVudGVkYCAtIGB7Ym9vbGVhbn1gOiB0cnVlIGlmIGBwcmV2ZW50RGVmYXVsdGAgd2FzIGNhbGxlZC4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBsaXN0ZW4gb24uCiAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQsIC4uLmFyZ3MpfSBsaXN0ZW5lciBGdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGV2ZW50IGlzIGVtaXR0ZWQuCiAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBSZXR1cm5zIGEgZGVyZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIHRoaXMgbGlzdGVuZXIuCiAgICAgICAqLwogICAgICAkb246IGZ1bmN0aW9uKG5hbWUsIGxpc3RlbmVyKSB7CiAgICAgICAgdmFyIG5hbWVkTGlzdGVuZXJzID0gdGhpcy4kJGxpc3RlbmVyc1tuYW1lXTsKICAgICAgICBpZiAoIW5hbWVkTGlzdGVuZXJzKSB7CiAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJzW25hbWVdID0gbmFtZWRMaXN0ZW5lcnMgPSBbXTsKICAgICAgICB9CiAgICAgICAgbmFtZWRMaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CgogICAgICAgIHZhciBjdXJyZW50ID0gdGhpczsKICAgICAgICBkbyB7CiAgICAgICAgICBpZiAoIWN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdKSB7CiAgICAgICAgICAgIGN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdKys7CiAgICAgICAgfSB3aGlsZSAoKGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQpKTsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIG5hbWVkTGlzdGVuZXJzW25hbWVkTGlzdGVuZXJzLmluZGV4T2YobGlzdGVuZXIpXSA9IG51bGw7CiAgICAgICAgICBkZWNyZW1lbnRMaXN0ZW5lckNvdW50KHNlbGYsIDEsIG5hbWUpOwogICAgICAgIH07CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZW1pdAogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogRGlzcGF0Y2hlcyBhbiBldmVudCBgbmFtZWAgdXB3YXJkcyB0aHJvdWdoIHRoZSBzY29wZSBoaWVyYXJjaHkgbm90aWZ5aW5nIHRoZQogICAgICAgKiByZWdpc3RlcmVkIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0gbGlzdGVuZXJzLgogICAgICAgKgogICAgICAgKiBUaGUgZXZlbnQgbGlmZSBjeWNsZSBzdGFydHMgYXQgdGhlIHNjb3BlIG9uIHdoaWNoIGAkZW1pdGAgd2FzIGNhbGxlZC4gQWxsCiAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IGxpc3RlbmluZyBmb3IgYG5hbWVgIGV2ZW50IG9uIHRoaXMgc2NvcGUgZ2V0CiAgICAgICAqIG5vdGlmaWVkLiBBZnRlcndhcmRzLCB0aGUgZXZlbnQgdHJhdmVyc2VzIHVwd2FyZHMgdG93YXJkIHRoZSByb290IHNjb3BlIGFuZCBjYWxscyBhbGwKICAgICAgICogcmVnaXN0ZXJlZCBsaXN0ZW5lcnMgYWxvbmcgdGhlIHdheS4gVGhlIGV2ZW50IHdpbGwgc3RvcCBwcm9wYWdhdGluZyBpZiBvbmUgb2YgdGhlIGxpc3RlbmVycwogICAgICAgKiBjYW5jZWxzIGl0LgogICAgICAgKgogICAgICAgKiBBbnkgZXhjZXB0aW9uIGVtaXR0ZWQgZnJvbSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gd2lsbCBiZSBwYXNzZWQKICAgICAgICogb250byB0aGUge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGVtaXQuCiAgICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBvbmUgb3IgbW9yZSBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEV2ZW50IG9iamVjdCAoc2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0pLgogICAgICAgKi8KICAgICAgJGVtaXQ6IGZ1bmN0aW9uKG5hbWUsIGFyZ3MpIHsKICAgICAgICB2YXIgZW1wdHkgPSBbXSwKICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMsCiAgICAgICAgICAgIHNjb3BlID0gdGhpcywKICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uID0gZmFsc2UsCiAgICAgICAgICAgIGV2ZW50ID0gewogICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgdGFyZ2V0U2NvcGU6IHNjb3BlLAogICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7c3RvcFByb3BhZ2F0aW9uID0gdHJ1ZTt9LAogICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbGlzdGVuZXJBcmdzID0gY29uY2F0KFtldmVudF0sIGFyZ3VtZW50cywgMSksCiAgICAgICAgICAgIGksIGxlbmd0aDsKCiAgICAgICAgZG8gewogICAgICAgICAgbmFtZWRMaXN0ZW5lcnMgPSBzY29wZS4kJGxpc3RlbmVyc1tuYW1lXSB8fCBlbXB0eTsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IHNjb3BlOwogICAgICAgICAgZm9yIChpPTAsIGxlbmd0aD1uYW1lZExpc3RlbmVycy5sZW5ndGg7IGk8bGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIC8vIGlmIGxpc3RlbmVycyB3ZXJlIGRlcmVnaXN0ZXJlZCwgZGVmcmFnbWVudCB0aGUgYXJyYXkKICAgICAgICAgICAgaWYgKCFuYW1lZExpc3RlbmVyc1tpXSkgewogICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgbGVuZ3RoLS07CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAvL2FsbG93IGFsbCBsaXN0ZW5lcnMgYXR0YWNoZWQgdG8gdGhlIGN1cnJlbnQgc2NvcGUgdG8gcnVuCiAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnNbaV0uYXBwbHkobnVsbCwgbGlzdGVuZXJBcmdzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvL2lmIGFueSBsaXN0ZW5lciBvbiB0aGUgY3VycmVudCBzY29wZSBzdG9wcyBwcm9wYWdhdGlvbiwgcHJldmVudCBidWJibGluZwogICAgICAgICAgaWYgKHN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICBldmVudC5jdXJyZW50U2NvcGUgPSBudWxsOwogICAgICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICAvL3RyYXZlcnNlIHVwd2FyZHMKICAgICAgICAgIHNjb3BlID0gc2NvcGUuJHBhcmVudDsKICAgICAgICB9IHdoaWxlIChzY29wZSk7CgogICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IG51bGw7CgogICAgICAgIHJldHVybiBldmVudDsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRicm9hZGNhc3QKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIERpc3BhdGNoZXMgYW4gZXZlbnQgYG5hbWVgIGRvd253YXJkcyB0byBhbGwgY2hpbGQgc2NvcGVzIChhbmQgdGhlaXIgY2hpbGRyZW4pIG5vdGlmeWluZyB0aGUKICAgICAgICogcmVnaXN0ZXJlZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGxpc3RlbmVycy4KICAgICAgICoKICAgICAgICogVGhlIGV2ZW50IGxpZmUgY3ljbGUgc3RhcnRzIGF0IHRoZSBzY29wZSBvbiB3aGljaCBgJGJyb2FkY2FzdGAgd2FzIGNhbGxlZC4gQWxsCiAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IGxpc3RlbmluZyBmb3IgYG5hbWVgIGV2ZW50IG9uIHRoaXMgc2NvcGUgZ2V0CiAgICAgICAqIG5vdGlmaWVkLiBBZnRlcndhcmRzLCB0aGUgZXZlbnQgcHJvcGFnYXRlcyB0byBhbGwgZGlyZWN0IGFuZCBpbmRpcmVjdCBzY29wZXMgb2YgdGhlIGN1cnJlbnQKICAgICAgICogc2NvcGUgYW5kIGNhbGxzIGFsbCByZWdpc3RlcmVkIGxpc3RlbmVycyBhbG9uZyB0aGUgd2F5LiBUaGUgZXZlbnQgY2Fubm90IGJlIGNhbmNlbGVkLgogICAgICAgKgogICAgICAgKiBBbnkgZXhjZXB0aW9uIGVtaXR0ZWQgZnJvbSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gd2lsbCBiZSBwYXNzZWQKICAgICAgICogb250byB0aGUge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGJyb2FkY2FzdC4KICAgICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIG9uZSBvciBtb3JlIGFyZ3VtZW50cyB3aGljaCB3aWxsIGJlIHBhc3NlZCBvbnRvIHRoZSBldmVudCBsaXN0ZW5lcnMuCiAgICAgICAqIEByZXR1cm4ge09iamVjdH0gRXZlbnQgb2JqZWN0LCBzZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufQogICAgICAgKi8KICAgICAgJGJyb2FkY2FzdDogZnVuY3Rpb24obmFtZSwgYXJncykgewogICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLAogICAgICAgICAgICBjdXJyZW50ID0gdGFyZ2V0LAogICAgICAgICAgICBuZXh0ID0gdGFyZ2V0LAogICAgICAgICAgICBldmVudCA9IHsKICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgIHRhcmdldFNjb3BlOiB0YXJnZXQsCiAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiBmYWxzZQogICAgICAgICAgICB9OwoKICAgICAgICBpZiAoIXRhcmdldC4kJGxpc3RlbmVyQ291bnRbbmFtZV0pIHJldHVybiBldmVudDsKCiAgICAgICAgdmFyIGxpc3RlbmVyQXJncyA9IGNvbmNhdChbZXZlbnRdLCBhcmd1bWVudHMsIDEpLAogICAgICAgICAgICBsaXN0ZW5lcnMsIGksIGxlbmd0aDsKCiAgICAgICAgLy9kb3duIHdoaWxlIHlvdSBjYW4sIHRoZW4gdXAgYW5kIG5leHQgc2libGluZyBvciB1cCBhbmQgbmV4dCBzaWJsaW5nIHVudGlsIGJhY2sgYXQgcm9vdAogICAgICAgIHdoaWxlICgoY3VycmVudCA9IG5leHQpKSB7CiAgICAgICAgICBldmVudC5jdXJyZW50U2NvcGUgPSBjdXJyZW50OwogICAgICAgICAgbGlzdGVuZXJzID0gY3VycmVudC4kJGxpc3RlbmVyc1tuYW1lXSB8fCBbXTsKICAgICAgICAgIGZvciAoaT0wLCBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOyBpPGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIC8vIGlmIGxpc3RlbmVycyB3ZXJlIGRlcmVnaXN0ZXJlZCwgZGVmcmFnbWVudCB0aGUgYXJyYXkKICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnNbaV0pIHsKICAgICAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkobnVsbCwgbGlzdGVuZXJBcmdzKTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBJbnNhbml0eSBXYXJuaW5nOiBzY29wZSBkZXB0aC1maXJzdCB0cmF2ZXJzYWwKICAgICAgICAgIC8vIHllcywgdGhpcyBjb2RlIGlzIGEgYml0IGNyYXp5LCBidXQgaXQgd29ya3MgYW5kIHdlIGhhdmUgdGVzdHMgdG8gcHJvdmUgaXQhCiAgICAgICAgICAvLyB0aGlzIHBpZWNlIHNob3VsZCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgdHJhdmVyc2FsIGluICRkaWdlc3QKICAgICAgICAgIC8vICh0aG91Z2ggaXQgZGlmZmVycyBkdWUgdG8gaGF2aW5nIHRoZSBleHRyYSBjaGVjayBmb3IgJCRsaXN0ZW5lckNvdW50KQogICAgICAgICAgaWYgKCEobmV4dCA9ICgoY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV0gJiYgY3VycmVudC4kJGNoaWxkSGVhZCkgfHwKICAgICAgICAgICAgICAoY3VycmVudCAhPT0gdGFyZ2V0ICYmIGN1cnJlbnQuJCRuZXh0U2libGluZykpKSkgewogICAgICAgICAgICB3aGlsZShjdXJyZW50ICE9PSB0YXJnZXQgJiYgIShuZXh0ID0gY3VycmVudC4kJG5leHRTaWJsaW5nKSkgewogICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IG51bGw7CiAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICB9CiAgICB9OwoKICAgIHZhciAkcm9vdFNjb3BlID0gbmV3IFNjb3BlKCk7CgogICAgLy9UaGUgaW50ZXJuYWwgcXVldWVzLiBFeHBvc2UgdGhlbSBvbiB0aGUgJHJvb3RTY29wZSBmb3IgZGVidWdnaW5nL3Rlc3RpbmcgcHVycG9zZXMuCiAgICB2YXIgYXN5bmNRdWV1ZSA9ICRyb290U2NvcGUuJCRhc3luY1F1ZXVlID0gW107CiAgICB2YXIgcG9zdERpZ2VzdFF1ZXVlID0gJHJvb3RTY29wZS4kJHBvc3REaWdlc3RRdWV1ZSA9IFtdOwogICAgdmFyIGFwcGx5QXN5bmNRdWV1ZSA9ICRyb290U2NvcGUuJCRhcHBseUFzeW5jUXVldWUgPSBbXTsKCiAgICByZXR1cm4gJHJvb3RTY29wZTsKCgogICAgZnVuY3Rpb24gYmVnaW5QaGFzZShwaGFzZSkgewogICAgICBpZiAoJHJvb3RTY29wZS4kJHBoYXNlKSB7CiAgICAgICAgdGhyb3cgJHJvb3RTY29wZU1pbkVycignaW5wcm9nJywgJ3swfSBhbHJlYWR5IGluIHByb2dyZXNzJywgJHJvb3RTY29wZS4kJHBoYXNlKTsKICAgICAgfQoKICAgICAgJHJvb3RTY29wZS4kJHBoYXNlID0gcGhhc2U7CiAgICB9CgogICAgZnVuY3Rpb24gY2xlYXJQaGFzZSgpIHsKICAgICAgJHJvb3RTY29wZS4kJHBoYXNlID0gbnVsbDsKICAgIH0KCgogICAgZnVuY3Rpb24gZGVjcmVtZW50TGlzdGVuZXJDb3VudChjdXJyZW50LCBjb3VudCwgbmFtZSkgewogICAgICBkbyB7CiAgICAgICAgY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV0gLT0gY291bnQ7CgogICAgICAgIGlmIChjdXJyZW50LiQkbGlzdGVuZXJDb3VudFtuYW1lXSA9PT0gMCkgewogICAgICAgICAgZGVsZXRlIGN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdOwogICAgICAgIH0KICAgICAgfSB3aGlsZSAoKGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQpKTsKICAgIH0KCiAgICAvKioKICAgICAqIGZ1bmN0aW9uIHVzZWQgYXMgYW4gaW5pdGlhbCB2YWx1ZSBmb3Igd2F0Y2hlcnMuCiAgICAgKiBiZWNhdXNlIGl0J3MgdW5pcXVlIHdlIGNhbiBlYXNpbHkgdGVsbCBpdCBhcGFydCBmcm9tIG90aGVyIHZhbHVlcwogICAgICovCiAgICBmdW5jdGlvbiBpbml0V2F0Y2hWYWwoKSB7fQoKICAgIGZ1bmN0aW9uIGZsdXNoQXBwbHlBc3luYygpIHsKICAgICAgd2hpbGUgKGFwcGx5QXN5bmNRdWV1ZS5sZW5ndGgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgYXBwbHlBc3luY1F1ZXVlLnNoaWZ0KCkoKTsKICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgIH0KICAgICAgfQogICAgICBhcHBseUFzeW5jSWQgPSBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIHNjaGVkdWxlQXBwbHlBc3luYygpIHsKICAgICAgaWYgKGFwcGx5QXN5bmNJZCA9PT0gbnVsbCkgewogICAgICAgIGFwcGx5QXN5bmNJZCA9ICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoZmx1c2hBcHBseUFzeW5jKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH1dOwp9CgovKioKICogQGRlc2NyaXB0aW9uCiAqIFByaXZhdGUgc2VydmljZSB0byBzYW5pdGl6ZSB1cmlzIGZvciBsaW5rcyBhbmQgaW1hZ2VzLiBVc2VkIGJ5ICRjb21waWxlIGFuZCAkc2FuaXRpemUuCiAqLwpmdW5jdGlvbiAkJFNhbml0aXplVXJpUHJvdmlkZXIoKSB7CiAgdmFyIGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gL15ccyooaHR0cHM/fGZ0cHxtYWlsdG98dGVsfGZpbGUpOi8sCiAgICBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSAvXlxzKigoaHR0cHM/fGZ0cHxmaWxlfGJsb2IpOnxkYXRhOmltYWdlXC8pLzsKCiAgLyoqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmV0cmlldmVzIG9yIG92ZXJyaWRlcyB0aGUgZGVmYXVsdCByZWd1bGFyIGV4cHJlc3Npb24gdGhhdCBpcyB1c2VkIGZvciB3aGl0ZWxpc3Rpbmcgb2Ygc2FmZQogICAqIHVybHMgZHVyaW5nIGFbaHJlZl0gc2FuaXRpemF0aW9uLgogICAqCiAgICogVGhlIHNhbml0aXphdGlvbiBpcyBhIHNlY3VyaXR5IG1lYXN1cmUgYWltZWQgYXQgcHJldmVudCBYU1MgYXR0YWNrcyB2aWEgaHRtbCBsaW5rcy4KICAgKgogICAqIEFueSB1cmwgYWJvdXQgdG8gYmUgYXNzaWduZWQgdG8gYVtocmVmXSB2aWEgZGF0YS1iaW5kaW5nIGlzIGZpcnN0IG5vcm1hbGl6ZWQgYW5kIHR1cm5lZCBpbnRvCiAgICogYW4gYWJzb2x1dGUgdXJsLiBBZnRlcndhcmRzLCB0aGUgdXJsIGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgYGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0YAogICAqIHJlZ3VsYXIgZXhwcmVzc2lvbi4gSWYgYSBtYXRjaCBpcyBmb3VuZCwgdGhlIG9yaWdpbmFsIHVybCBpcyB3cml0dGVuIGludG8gdGhlIGRvbS4gT3RoZXJ3aXNlLAogICAqIHRoZSBhYnNvbHV0ZSB1cmwgaXMgcHJlZml4ZWQgd2l0aCBgJ3Vuc2FmZTonYCBzdHJpbmcgYW5kIG9ubHkgdGhlbiBpcyBpdCB3cml0dGVuIGludG8gdGhlIERPTS4KICAgKgogICAqIEBwYXJhbSB7UmVnRXhwPX0gcmVnZXhwIE5ldyByZWdleHAgdG8gd2hpdGVsaXN0IHVybHMgd2l0aC4KICAgKiBAcmV0dXJucyB7UmVnRXhwfG5nLiRjb21waWxlUHJvdmlkZXJ9IEN1cnJlbnQgUmVnRXhwIGlmIGNhbGxlZCB3aXRob3V0IHZhbHVlIG9yIHNlbGYgZm9yCiAgICogICAgY2hhaW5pbmcgb3RoZXJ3aXNlLgogICAqLwogIHRoaXMuYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSBmdW5jdGlvbihyZWdleHApIHsKICAgIGlmIChpc0RlZmluZWQocmVnZXhwKSkgewogICAgICBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCA9IHJlZ2V4cDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICByZXR1cm4gYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3Q7CiAgfTsKCgogIC8qKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJldHJpZXZlcyBvciBvdmVycmlkZXMgdGhlIGRlZmF1bHQgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgdXNlZCBmb3Igd2hpdGVsaXN0aW5nIG9mIHNhZmUKICAgKiB1cmxzIGR1cmluZyBpbWdbc3JjXSBzYW5pdGl6YXRpb24uCiAgICoKICAgKiBUaGUgc2FuaXRpemF0aW9uIGlzIGEgc2VjdXJpdHkgbWVhc3VyZSBhaW1lZCBhdCBwcmV2ZW50IFhTUyBhdHRhY2tzIHZpYSBodG1sIGxpbmtzLgogICAqCiAgICogQW55IHVybCBhYm91dCB0byBiZSBhc3NpZ25lZCB0byBpbWdbc3JjXSB2aWEgZGF0YS1iaW5kaW5nIGlzIGZpcnN0IG5vcm1hbGl6ZWQgYW5kIHR1cm5lZCBpbnRvCiAgICogYW4gYWJzb2x1dGUgdXJsLiBBZnRlcndhcmRzLCB0aGUgdXJsIGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgYGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdGAKICAgKiByZWd1bGFyIGV4cHJlc3Npb24uIElmIGEgbWF0Y2ggaXMgZm91bmQsIHRoZSBvcmlnaW5hbCB1cmwgaXMgd3JpdHRlbiBpbnRvIHRoZSBkb20uIE90aGVyd2lzZSwKICAgKiB0aGUgYWJzb2x1dGUgdXJsIGlzIHByZWZpeGVkIHdpdGggYCd1bnNhZmU6J2Agc3RyaW5nIGFuZCBvbmx5IHRoZW4gaXMgaXQgd3JpdHRlbiBpbnRvIHRoZSBET00uCiAgICoKICAgKiBAcGFyYW0ge1JlZ0V4cD19IHJlZ2V4cCBOZXcgcmVnZXhwIHRvIHdoaXRlbGlzdCB1cmxzIHdpdGguCiAgICogQHJldHVybnMge1JlZ0V4cHxuZy4kY29tcGlsZVByb3ZpZGVyfSBDdXJyZW50IFJlZ0V4cCBpZiBjYWxsZWQgd2l0aG91dCB2YWx1ZSBvciBzZWxmIGZvcgogICAqICAgIGNoYWluaW5nIG90aGVyd2lzZS4KICAgKi8KICB0aGlzLmltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCA9IGZ1bmN0aW9uKHJlZ2V4cCkgewogICAgaWYgKGlzRGVmaW5lZChyZWdleHApKSB7CiAgICAgIGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCA9IHJlZ2V4cDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICByZXR1cm4gaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0OwogIH07CgogIHRoaXMuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGZ1bmN0aW9uIHNhbml0aXplVXJpKHVyaSwgaXNJbWFnZSkgewogICAgICB2YXIgcmVnZXggPSBpc0ltYWdlID8gaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0IDogYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3Q7CiAgICAgIHZhciBub3JtYWxpemVkVmFsOwogICAgICBub3JtYWxpemVkVmFsID0gdXJsUmVzb2x2ZSh1cmkpLmhyZWY7CiAgICAgIGlmIChub3JtYWxpemVkVmFsICE9PSAnJyAmJiAhbm9ybWFsaXplZFZhbC5tYXRjaChyZWdleCkpIHsKICAgICAgICByZXR1cm4gJ3Vuc2FmZTonK25vcm1hbGl6ZWRWYWw7CiAgICAgIH0KICAgICAgcmV0dXJuIHVyaTsKICAgIH07CiAgfTsKfQoKdmFyICRzY2VNaW5FcnIgPSBtaW5FcnIoJyRzY2UnKTsKCnZhciBTQ0VfQ09OVEVYVFMgPSB7CiAgSFRNTDogJ2h0bWwnLAogIENTUzogJ2NzcycsCiAgVVJMOiAndXJsJywKICAvLyBSRVNPVVJDRV9VUkwgaXMgYSBzdWJ0eXBlIG9mIFVSTCB1c2VkIGluIGNvbnRleHRzIHdoZXJlIGEgcHJpdmlsZWdlZCByZXNvdXJjZSBpcyBzb3VyY2VkIGZyb20gYQogIC8vIHVybC4gIChlLmcuIG5nLWluY2x1ZGUsIHNjcmlwdCBzcmMsIHRlbXBsYXRlVXJsKQogIFJFU09VUkNFX1VSTDogJ3Jlc291cmNlVXJsJywKICBKUzogJ2pzJwp9OwoKLy8gSGVscGVyIGZ1bmN0aW9ucyBmb2xsb3cuCgovLyBDb3BpZWQgZnJvbToKLy8gaHR0cDovL2RvY3MuY2xvc3VyZS1saWJyYXJ5Lmdvb2dsZWNvZGUuY29tL2dpdC9jbG9zdXJlX2dvb2dfc3RyaW5nX3N0cmluZy5qcy5zb3VyY2UuaHRtbCNsaW5lOTYyCi8vIFByZXJlcTogcyBpcyBhIHN0cmluZy4KZnVuY3Rpb24gZXNjYXBlRm9yUmVnZXhwKHMpIHsKICByZXR1cm4gcy5yZXBsYWNlKC8oWy0oKVxbXF17fSs/Ki4kXF58LDojPCFcXF0pL2csICdcXCQxJykuCiAgICAgICAgICAgcmVwbGFjZSgvXHgwOC9nLCAnXFx4MDgnKTsKfQoKCmZ1bmN0aW9uIGFkanVzdE1hdGNoZXIobWF0Y2hlcikgewogIGlmIChtYXRjaGVyID09PSAnc2VsZicpIHsKICAgIHJldHVybiBtYXRjaGVyOwogIH0gZWxzZSBpZiAoaXNTdHJpbmcobWF0Y2hlcikpIHsKICAgIC8vIFN0cmluZ3MgbWF0Y2ggZXhhY3RseSBleGNlcHQgZm9yIDIgd2lsZGNhcmRzIC0gJyonIGFuZCAnKionLgogICAgLy8gJyonIG1hdGNoZXMgYW55IGNoYXJhY3RlciBleGNlcHQgdGhvc2UgZnJvbSB0aGUgc2V0ICc6Ly4/JicuCiAgICAvLyAnKionIG1hdGNoZXMgYW55IGNoYXJhY3RlciAobGlrZSAuKiBpbiBhIFJlZ0V4cCkuCiAgICAvLyBNb3JlIHRoYW4gMiAqJ3MgcmFpc2VzIGFuIGVycm9yIGFzIGl0J3MgaWxsIGRlZmluZWQuCiAgICBpZiAobWF0Y2hlci5pbmRleE9mKCcqKionKSA+IC0xKSB7CiAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2l3Y2FyZCcsCiAgICAgICAgICAnSWxsZWdhbCBzZXF1ZW5jZSAqKiogaW4gc3RyaW5nIG1hdGNoZXIuICBTdHJpbmc6IHswfScsIG1hdGNoZXIpOwogICAgfQogICAgbWF0Y2hlciA9IGVzY2FwZUZvclJlZ2V4cChtYXRjaGVyKS4KICAgICAgICAgICAgICAgICAgcmVwbGFjZSgnXFwqXFwqJywgJy4qJykuCiAgICAgICAgICAgICAgICAgIHJlcGxhY2UoJ1xcKicsICdbXjovLj8mO10qJyk7CiAgICByZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyBtYXRjaGVyICsgJyQnKTsKICB9IGVsc2UgaWYgKGlzUmVnRXhwKG1hdGNoZXIpKSB7CiAgICAvLyBUaGUgb25seSBvdGhlciB0eXBlIG9mIG1hdGNoZXIgYWxsb3dlZCBpcyBhIFJlZ2V4cC4KICAgIC8vIE1hdGNoIGVudGlyZSBVUkwgLyBkaXNhbGxvdyBwYXJ0aWFsIG1hdGNoZXMuCiAgICAvLyBGbGFncyBhcmUgcmVzZXQgKGkuZS4gbm8gZ2xvYmFsLCBpZ25vcmVDYXNlIG9yIG11bHRpbGluZSkKICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIG1hdGNoZXIuc291cmNlICsgJyQnKTsKICB9IGVsc2UgewogICAgdGhyb3cgJHNjZU1pbkVycignaW1hdGNoZXInLAogICAgICAgICdNYXRjaGVycyBtYXkgb25seSBiZSAic2VsZiIsIHN0cmluZyBwYXR0ZXJucyBvciBSZWdFeHAgb2JqZWN0cycpOwogIH0KfQoKCmZ1bmN0aW9uIGFkanVzdE1hdGNoZXJzKG1hdGNoZXJzKSB7CiAgdmFyIGFkanVzdGVkTWF0Y2hlcnMgPSBbXTsKICBpZiAoaXNEZWZpbmVkKG1hdGNoZXJzKSkgewogICAgZm9yRWFjaChtYXRjaGVycywgZnVuY3Rpb24obWF0Y2hlcikgewogICAgICBhZGp1c3RlZE1hdGNoZXJzLnB1c2goYWRqdXN0TWF0Y2hlcihtYXRjaGVyKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGFkanVzdGVkTWF0Y2hlcnM7Cn0KCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHNjZURlbGVnYXRlCiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBgJHNjZURlbGVnYXRlYCBpcyBhIHNlcnZpY2UgdGhhdCBpcyB1c2VkIGJ5IHRoZSBgJHNjZWAgc2VydmljZSB0byBwcm92aWRlIHtAbGluayBuZy4kc2NlIFN0cmljdAogKiBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpfSBzZXJ2aWNlcyB0byBBbmd1bGFySlMuCiAqCiAqIFR5cGljYWxseSwgeW91IHdvdWxkIGNvbmZpZ3VyZSBvciBvdmVycmlkZSB0aGUge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSAkc2NlRGVsZWdhdGV9IGluc3RlYWQgb2YKICogdGhlIGAkc2NlYCBzZXJ2aWNlIHRvIGN1c3RvbWl6ZSB0aGUgd2F5IFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIHdvcmtzIGluIEFuZ3VsYXJKUy4gIFRoaXMgaXMKICogYmVjYXVzZSwgd2hpbGUgdGhlIGAkc2NlYCBwcm92aWRlcyBudW1lcm91cyBzaG9ydGhhbmQgbWV0aG9kcywgZXRjLiwgeW91IHJlYWxseSBvbmx5IG5lZWQgdG8KICogb3ZlcnJpZGUgMyBjb3JlIGZ1bmN0aW9ucyAoYHRydXN0QXNgLCBgZ2V0VHJ1c3RlZGAgYW5kIGB2YWx1ZU9mYCkgdG8gcmVwbGFjZSB0aGUgd2F5IHRoaW5ncwogKiB3b3JrIGJlY2F1c2UgYCRzY2VgIGRlbGVnYXRlcyB0byBgJHNjZURlbGVnYXRlYCBmb3IgdGhlc2Ugb3BlcmF0aW9ucy4KICoKICogUmVmZXIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyICRzY2VEZWxlZ2F0ZVByb3ZpZGVyfSB0byBjb25maWd1cmUgdGhpcyBzZXJ2aWNlLgogKgogKiBUaGUgZGVmYXVsdCBpbnN0YW5jZSBvZiBgJHNjZURlbGVnYXRlYCBzaG91bGQgd29yayBvdXQgb2YgdGhlIGJveCB3aXRoIGxpdHRsZSBwYWluLiAgV2hpbGUgeW91CiAqIGNhbiBvdmVycmlkZSBpdCBjb21wbGV0ZWx5IHRvIGNoYW5nZSB0aGUgYmVoYXZpb3Igb2YgYCRzY2VgLCB0aGUgY29tbW9uIGNhc2Ugd291bGQKICogaW52b2x2ZSBjb25maWd1cmluZyB0aGUge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyICRzY2VEZWxlZ2F0ZVByb3ZpZGVyfSBpbnN0ZWFkIGJ5IHNldHRpbmcKICogeW91ciBvd24gd2hpdGVsaXN0cyBhbmQgYmxhY2tsaXN0cyBmb3IgdHJ1c3RpbmcgVVJMcyB1c2VkIGZvciBsb2FkaW5nIEFuZ3VsYXJKUyByZXNvdXJjZXMgc3VjaCBhcwogKiB0ZW1wbGF0ZXMuICBSZWZlciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3QKICogJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxXaGl0ZWxpc3R9IGFuZCB7QGxpbmsKICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QgJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxCbGFja2xpc3R9CiAqLwoKLyoqCiAqIEBuZ2RvYyBwcm92aWRlcgogKiBAbmFtZSAkc2NlRGVsZWdhdGVQcm92aWRlcgogKiBAZGVzY3JpcHRpb24KICoKICogVGhlIGAkc2NlRGVsZWdhdGVQcm92aWRlcmAgcHJvdmlkZXIgYWxsb3dzIGRldmVsb3BlcnMgdG8gY29uZmlndXJlIHRoZSB7QGxpbmsgbmcuJHNjZURlbGVnYXRlCiAqICRzY2VEZWxlZ2F0ZX0gc2VydmljZS4gIFRoaXMgYWxsb3dzIG9uZSB0byBnZXQvc2V0IHRoZSB3aGl0ZWxpc3RzIGFuZCBibGFja2xpc3RzIHVzZWQgdG8gZW5zdXJlCiAqIHRoYXQgdGhlIFVSTHMgdXNlZCBmb3Igc291cmNpbmcgQW5ndWxhciB0ZW1wbGF0ZXMgYXJlIHNhZmUuICBSZWZlciB7QGxpbmsKICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3QgJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxXaGl0ZWxpc3R9IGFuZAogKiB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QgJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxCbGFja2xpc3R9CiAqCiAqIEZvciB0aGUgZ2VuZXJhbCBkZXRhaWxzIGFib3V0IHRoaXMgc2VydmljZSBpbiBBbmd1bGFyLCByZWFkIHRoZSBtYWluIHBhZ2UgZm9yIHtAbGluayBuZy4kc2NlCiAqIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpfS4KICoKICogKipFeGFtcGxlKio6ICBDb25zaWRlciB0aGUgZm9sbG93aW5nIGNhc2UuIDxhIG5hbWU9ImV4YW1wbGUiPjwvYT4KICoKICogLSB5b3VyIGFwcCBpcyBob3N0ZWQgYXQgdXJsIGBodHRwOi8vbXlhcHAuZXhhbXBsZS5jb20vYAogKiAtIGJ1dCBzb21lIG9mIHlvdXIgdGVtcGxhdGVzIGFyZSBob3N0ZWQgb24gb3RoZXIgZG9tYWlucyB5b3UgY29udHJvbCBzdWNoIGFzCiAqICAgYGh0dHA6Ly9zcnYwMS5hc3NldHMuZXhhbXBsZS5jb20vYCzCoCBgaHR0cDovL3NydjAyLmFzc2V0cy5leGFtcGxlLmNvbS9gLCBldGMuCiAqIC0gYW5kIHlvdSBoYXZlIGFuIG9wZW4gcmVkaXJlY3QgYXQgYGh0dHA6Ly9teWFwcC5leGFtcGxlLmNvbS9jbGlja1RocnU/Li4uYC4KICoKICogSGVyZSBpcyB3aGF0IGEgc2VjdXJlIGNvbmZpZ3VyYXRpb24gZm9yIHRoaXMgc2NlbmFyaW8gbWlnaHQgbG9vayBsaWtlOgogKgogKiBgYGAKICogIGFuZ3VsYXIubW9kdWxlKCdteUFwcCcsIFtdKS5jb25maWcoZnVuY3Rpb24oJHNjZURlbGVnYXRlUHJvdmlkZXIpIHsKICogICAgJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxXaGl0ZWxpc3QoWwogKiAgICAgIC8vIEFsbG93IHNhbWUgb3JpZ2luIHJlc291cmNlIGxvYWRzLgogKiAgICAgICdzZWxmJywKICogICAgICAvLyBBbGxvdyBsb2FkaW5nIGZyb20gb3VyIGFzc2V0cyBkb21haW4uICBOb3RpY2UgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiAqIGFuZCAqKi4KICogICAgICAnaHR0cDovL3NydiouYXNzZXRzLmV4YW1wbGUuY29tLyoqJwogKiAgICBdKTsKICoKICogICAgLy8gVGhlIGJsYWNrbGlzdCBvdmVycmlkZXMgdGhlIHdoaXRlbGlzdCBzbyB0aGUgb3BlbiByZWRpcmVjdCBoZXJlIGlzIGJsb2NrZWQuCiAqICAgICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsQmxhY2tsaXN0KFsKICogICAgICAnaHR0cDovL215YXBwLmV4YW1wbGUuY29tL2NsaWNrVGhydSoqJwogKiAgICBdKTsKICogIH0pOwogKiBgYGAKICovCgpmdW5jdGlvbiAkU2NlRGVsZWdhdGVQcm92aWRlcigpIHsKICB0aGlzLlNDRV9DT05URVhUUyA9IFNDRV9DT05URVhUUzsKCiAgLy8gUmVzb3VyY2UgVVJMcyBjYW4gYWxzbyBiZSB0cnVzdGVkIGJ5IHBvbGljeS4KICB2YXIgcmVzb3VyY2VVcmxXaGl0ZWxpc3QgPSBbJ3NlbGYnXSwKICAgICAgcmVzb3VyY2VVcmxCbGFja2xpc3QgPSBbXTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0CiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBwYXJhbSB7QXJyYXk9fSB3aGl0ZWxpc3QgV2hlbiBwcm92aWRlZCwgcmVwbGFjZXMgdGhlIHJlc291cmNlVXJsV2hpdGVsaXN0IHdpdGggdGhlIHZhbHVlCiAgICogICAgIHByb3ZpZGVkLiAgVGhpcyBtdXN0IGJlIGFuIGFycmF5IG9yIG51bGwuICBBIHNuYXBzaG90IG9mIHRoaXMgYXJyYXkgaXMgdXNlZCBzbyBmdXJ0aGVyCiAgICogICAgIGNoYW5nZXMgdG8gdGhlIGFycmF5IGFyZSBpZ25vcmVkLgogICAqCiAgICogICAgIEZvbGxvdyB7QGxpbmsgbmcuJHNjZSNyZXNvdXJjZVVybFBhdHRlcm5JdGVtIHRoaXMgbGlua30gZm9yIGEgZGVzY3JpcHRpb24gb2YgdGhlIGl0ZW1zCiAgICogICAgIGFsbG93ZWQgaW4gdGhpcyBhcnJheS4KICAgKgogICAqICAgICBOb3RlOiAqKmFuIGVtcHR5IHdoaXRlbGlzdCBhcnJheSB3aWxsIGJsb2NrIGFsbCBVUkxzKiohCiAgICoKICAgKiBAcmV0dXJuIHtBcnJheX0gdGhlIGN1cnJlbnRseSBzZXQgd2hpdGVsaXN0IGFycmF5LgogICAqCiAgICogVGhlICoqZGVmYXVsdCB2YWx1ZSoqIHdoZW4gbm8gd2hpdGVsaXN0IGhhcyBiZWVuIGV4cGxpY2l0bHkgc2V0IGlzIGBbJ3NlbGYnXWAgYWxsb3dpbmcgb25seQogICAqIHNhbWUgb3JpZ2luIHJlc291cmNlIHJlcXVlc3RzLgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cy9HZXRzIHRoZSB3aGl0ZWxpc3Qgb2YgdHJ1c3RlZCByZXNvdXJjZSBVUkxzLgogICAqLwogIHRoaXMucmVzb3VyY2VVcmxXaGl0ZWxpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIHJlc291cmNlVXJsV2hpdGVsaXN0ID0gYWRqdXN0TWF0Y2hlcnModmFsdWUpOwogICAgfQogICAgcmV0dXJuIHJlc291cmNlVXJsV2hpdGVsaXN0OwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybEJsYWNrbGlzdAogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PX0gYmxhY2tsaXN0IFdoZW4gcHJvdmlkZWQsIHJlcGxhY2VzIHRoZSByZXNvdXJjZVVybEJsYWNrbGlzdCB3aXRoIHRoZSB2YWx1ZQogICAqICAgICBwcm92aWRlZC4gIFRoaXMgbXVzdCBiZSBhbiBhcnJheSBvciBudWxsLiAgQSBzbmFwc2hvdCBvZiB0aGlzIGFycmF5IGlzIHVzZWQgc28gZnVydGhlcgogICAqICAgICBjaGFuZ2VzIHRvIHRoZSBhcnJheSBhcmUgaWdub3JlZC4KICAgKgogICAqICAgICBGb2xsb3cge0BsaW5rIG5nLiRzY2UjcmVzb3VyY2VVcmxQYXR0ZXJuSXRlbSB0aGlzIGxpbmt9IGZvciBhIGRlc2NyaXB0aW9uIG9mIHRoZSBpdGVtcwogICAqICAgICBhbGxvd2VkIGluIHRoaXMgYXJyYXkuCiAgICoKICAgKiAgICAgVGhlIHR5cGljYWwgdXNhZ2UgZm9yIHRoZSBibGFja2xpc3QgaXMgdG8gKipibG9jawogICAqICAgICBbb3BlbiByZWRpcmVjdHNdKGh0dHA6Ly9jd2UubWl0cmUub3JnL2RhdGEvZGVmaW5pdGlvbnMvNjAxLmh0bWwpKiogc2VydmVkIGJ5IHlvdXIgZG9tYWluIGFzCiAgICogICAgIHRoZXNlIHdvdWxkIG90aGVyd2lzZSBiZSB0cnVzdGVkIGJ1dCBhY3R1YWxseSByZXR1cm4gY29udGVudCBmcm9tIHRoZSByZWRpcmVjdGVkIGRvbWFpbi4KICAgKgogICAqICAgICBGaW5hbGx5LCAqKnRoZSBibGFja2xpc3Qgb3ZlcnJpZGVzIHRoZSB3aGl0ZWxpc3QqKiBhbmQgaGFzIHRoZSBmaW5hbCBzYXkuCiAgICoKICAgKiBAcmV0dXJuIHtBcnJheX0gdGhlIGN1cnJlbnRseSBzZXQgYmxhY2tsaXN0IGFycmF5LgogICAqCiAgICogVGhlICoqZGVmYXVsdCB2YWx1ZSoqIHdoZW4gbm8gd2hpdGVsaXN0IGhhcyBiZWVuIGV4cGxpY2l0bHkgc2V0IGlzIHRoZSBlbXB0eSBhcnJheSAoaS5lLiB0aGVyZQogICAqIGlzIG5vIGJsYWNrbGlzdC4pCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXRzL0dldHMgdGhlIGJsYWNrbGlzdCBvZiB0cnVzdGVkIHJlc291cmNlIFVSTHMuCiAgICovCgogIHRoaXMucmVzb3VyY2VVcmxCbGFja2xpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIHJlc291cmNlVXJsQmxhY2tsaXN0ID0gYWRqdXN0TWF0Y2hlcnModmFsdWUpOwogICAgfQogICAgcmV0dXJuIHJlc291cmNlVXJsQmxhY2tsaXN0OwogIH07CgogIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgZnVuY3Rpb24oJGluamVjdG9yKSB7CgogICAgdmFyIGh0bWxTYW5pdGl6ZXIgPSBmdW5jdGlvbiBodG1sU2FuaXRpemVyKGh0bWwpIHsKICAgICAgdGhyb3cgJHNjZU1pbkVycigndW5zYWZlJywgJ0F0dGVtcHRpbmcgdG8gdXNlIGFuIHVuc2FmZSB2YWx1ZSBpbiBhIHNhZmUgY29udGV4dC4nKTsKICAgIH07CgogICAgaWYgKCRpbmplY3Rvci5oYXMoJyRzYW5pdGl6ZScpKSB7CiAgICAgIGh0bWxTYW5pdGl6ZXIgPSAkaW5qZWN0b3IuZ2V0KCckc2FuaXRpemUnKTsKICAgIH0KCgogICAgZnVuY3Rpb24gbWF0Y2hVcmwobWF0Y2hlciwgcGFyc2VkVXJsKSB7CiAgICAgIGlmIChtYXRjaGVyID09PSAnc2VsZicpIHsKICAgICAgICByZXR1cm4gdXJsSXNTYW1lT3JpZ2luKHBhcnNlZFVybCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZGVmaW5pdGVseSBhIHJlZ2V4LiAgU2VlIGFkanVzdE1hdGNoZXJzKCkKICAgICAgICByZXR1cm4gISFtYXRjaGVyLmV4ZWMocGFyc2VkVXJsLmhyZWYpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaXNSZXNvdXJjZVVybEFsbG93ZWRCeVBvbGljeSh1cmwpIHsKICAgICAgdmFyIHBhcnNlZFVybCA9IHVybFJlc29sdmUodXJsLnRvU3RyaW5nKCkpOwogICAgICB2YXIgaSwgbiwgYWxsb3dlZCA9IGZhbHNlOwogICAgICAvLyBFbnN1cmUgdGhhdCBhdCBsZWFzdCBvbmUgaXRlbSBmcm9tIHRoZSB3aGl0ZWxpc3QgYWxsb3dzIHRoaXMgdXJsLgogICAgICBmb3IgKGkgPSAwLCBuID0gcmVzb3VyY2VVcmxXaGl0ZWxpc3QubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgaWYgKG1hdGNoVXJsKHJlc291cmNlVXJsV2hpdGVsaXN0W2ldLCBwYXJzZWRVcmwpKSB7CiAgICAgICAgICBhbGxvd2VkID0gdHJ1ZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoYWxsb3dlZCkgewogICAgICAgIC8vIEVuc3VyZSB0aGF0IG5vIGl0ZW0gZnJvbSB0aGUgYmxhY2tsaXN0IGJsb2NrZWQgdGhpcyB1cmwuCiAgICAgICAgZm9yIChpID0gMCwgbiA9IHJlc291cmNlVXJsQmxhY2tsaXN0Lmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICAgICAgaWYgKG1hdGNoVXJsKHJlc291cmNlVXJsQmxhY2tsaXN0W2ldLCBwYXJzZWRVcmwpKSB7CiAgICAgICAgICAgIGFsbG93ZWQgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBhbGxvd2VkOwogICAgfQoKICAgIGZ1bmN0aW9uIGdlbmVyYXRlSG9sZGVyVHlwZShCYXNlKSB7CiAgICAgIHZhciBob2xkZXJUeXBlID0gZnVuY3Rpb24gVHJ1c3RlZFZhbHVlSG9sZGVyVHlwZSh0cnVzdGVkVmFsdWUpIHsKICAgICAgICB0aGlzLiQkdW53cmFwVHJ1c3RlZFZhbHVlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdHJ1c3RlZFZhbHVlOwogICAgICAgIH07CiAgICAgIH07CiAgICAgIGlmIChCYXNlKSB7CiAgICAgICAgaG9sZGVyVHlwZS5wcm90b3R5cGUgPSBuZXcgQmFzZSgpOwogICAgICB9CiAgICAgIGhvbGRlclR5cGUucHJvdG90eXBlLnZhbHVlT2YgPSBmdW5jdGlvbiBzY2VWYWx1ZU9mKCkgewogICAgICAgIHJldHVybiB0aGlzLiQkdW53cmFwVHJ1c3RlZFZhbHVlKCk7CiAgICAgIH07CiAgICAgIGhvbGRlclR5cGUucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gc2NlVG9TdHJpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuJCR1bndyYXBUcnVzdGVkVmFsdWUoKS50b1N0cmluZygpOwogICAgICB9OwogICAgICByZXR1cm4gaG9sZGVyVHlwZTsKICAgIH0KCiAgICB2YXIgdHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSA9IGdlbmVyYXRlSG9sZGVyVHlwZSgpLAogICAgICAgIGJ5VHlwZSA9IHt9OwoKICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuSFRNTF0gPSBnZW5lcmF0ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSk7CiAgICBieVR5cGVbU0NFX0NPTlRFWFRTLkNTU10gPSBnZW5lcmF0ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSk7CiAgICBieVR5cGVbU0NFX0NPTlRFWFRTLlVSTF0gPSBnZW5lcmF0ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSk7CiAgICBieVR5cGVbU0NFX0NPTlRFWFRTLkpTXSA9IGdlbmVyYXRlSG9sZGVyVHlwZSh0cnVzdGVkVmFsdWVIb2xkZXJCYXNlKTsKICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuUkVTT1VSQ0VfVVJMXSA9IGdlbmVyYXRlSG9sZGVyVHlwZShieVR5cGVbU0NFX0NPTlRFWFRTLlVSTF0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJldHVybnMgYW4gb2JqZWN0IHRoYXQgaXMgdHJ1c3RlZCBieSBhbmd1bGFyIGZvciB1c2UgaW4gc3BlY2lmaWVkIHN0cmljdAogICAgICogY29udGV4dHVhbCBlc2NhcGluZyBjb250ZXh0cyAoc3VjaCBhcyBuZy1iaW5kLWh0bWwsIG5nLWluY2x1ZGUsIGFueSBzcmMKICAgICAqIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uLCBhbnkgZG9tIGV2ZW50IGJpbmRpbmcgYXR0cmlidXRlIGludGVycG9sYXRpb24KICAgICAqIHN1Y2ggYXMgZm9yIG9uY2xpY2ssICBldGMuKSB0aGF0IHVzZXMgdGhlIHByb3ZpZGVkIHZhbHVlLgogICAgICogU2VlIHtAbGluayBuZy4kc2NlICRzY2V9IGZvciBlbmFibGluZyBzdHJpY3QgY29udGV4dHVhbCBlc2NhcGluZy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgc2FmZSBmb3IgdXNlLiAgZS5nLiB1cmwsCiAgICAgKiAgIHJlc291cmNlVXJsLCBodG1sLCBqcyBhbmQgY3NzLgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdGhhdCB0aGF0IHNob3VsZCBiZSBjb25zaWRlcmVkIHRydXN0ZWQvc2FmZS4KICAgICAqIEByZXR1cm5zIHsqfSBBIHZhbHVlIHRoYXQgY2FuIGJlIHVzZWQgdG8gc3RhbmQgaW4gZm9yIHRoZSBwcm92aWRlZCBgdmFsdWVgIGluIHBsYWNlcwogICAgICogd2hlcmUgQW5ndWxhciBleHBlY3RzIGEgJHNjZS50cnVzdEFzKCkgcmV0dXJuIHZhbHVlLgogICAgICovCiAgICBmdW5jdGlvbiB0cnVzdEFzKHR5cGUsIHRydXN0ZWRWYWx1ZSkgewogICAgICB2YXIgQ29uc3RydWN0b3IgPSAoYnlUeXBlLmhhc093blByb3BlcnR5KHR5cGUpID8gYnlUeXBlW3R5cGVdIDogbnVsbCk7CiAgICAgIGlmICghQ29uc3RydWN0b3IpIHsKICAgICAgICB0aHJvdyAkc2NlTWluRXJyKCdpY29udGV4dCcsCiAgICAgICAgICAgICdBdHRlbXB0ZWQgdG8gdHJ1c3QgYSB2YWx1ZSBpbiBpbnZhbGlkIGNvbnRleHQuIENvbnRleHQ6IHswfTsgVmFsdWU6IHsxfScsCiAgICAgICAgICAgIHR5cGUsIHRydXN0ZWRWYWx1ZSk7CiAgICAgIH0KICAgICAgaWYgKHRydXN0ZWRWYWx1ZSA9PT0gbnVsbCB8fCB0cnVzdGVkVmFsdWUgPT09IHVuZGVmaW5lZCB8fCB0cnVzdGVkVmFsdWUgPT09ICcnKSB7CiAgICAgICAgcmV0dXJuIHRydXN0ZWRWYWx1ZTsKICAgICAgfQogICAgICAvLyBBbGwgdGhlIGN1cnJlbnQgY29udGV4dHMgaW4gU0NFX0NPTlRFWFRTIGhhcHBlbiB0byBiZSBzdHJpbmdzLiAgSW4gb3JkZXIgdG8gYXZvaWQgdHJ1c3RpbmcKICAgICAgLy8gbXV0YWJsZSBvYmplY3RzLCB3ZSBlbnN1cmUgaGVyZSB0aGF0IHRoZSB2YWx1ZSBwYXNzZWQgaW4gaXMgYWN0dWFsbHkgYSBzdHJpbmcuCiAgICAgIGlmICh0eXBlb2YgdHJ1c3RlZFZhbHVlICE9PSAnc3RyaW5nJykgewogICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2l0eXBlJywKICAgICAgICAgICAgJ0F0dGVtcHRlZCB0byB0cnVzdCBhIG5vbi1zdHJpbmcgdmFsdWUgaW4gYSBjb250ZW50IHJlcXVpcmluZyBhIHN0cmluZzogQ29udGV4dDogezB9JywKICAgICAgICAgICAgdHlwZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBDb25zdHJ1Y3Rvcih0cnVzdGVkVmFsdWUpOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZURlbGVnYXRlI3ZhbHVlT2YKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIElmIHRoZSBwYXNzZWQgcGFyYW1ldGVyIGhhZCBiZWVuIHJldHVybmVkIGJ5IGEgcHJpb3IgY2FsbCB0byB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAqIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9LCByZXR1cm5zIHRoZSB2YWx1ZSB0aGF0IGhhZCBiZWVuIHBhc3NlZCB0byB7QGxpbmsKICAgICAqIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9LgogICAgICoKICAgICAqIElmIHRoZSBwYXNzZWQgcGFyYW1ldGVyIGlzIG5vdCBhIHZhbHVlIHRoYXQgaGFkIGJlZW4gcmV0dXJuZWQgYnkge0BsaW5rCiAgICAgKiBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSwgcmV0dXJucyBpdCBhcy1pcy4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSByZXN1bHQgb2YgYSBwcmlvciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0KICAgICAqICAgICAgY2FsbCBvciBhbnl0aGluZyBlbHNlLgogICAgICogQHJldHVybnMgeyp9IFRoZSBgdmFsdWVgIHRoYXQgd2FzIG9yaWdpbmFsbHkgcHJvdmlkZWQgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzCiAgICAgKiAgICAgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gaWYgYHZhbHVlYCBpcyB0aGUgcmVzdWx0IG9mIHN1Y2ggYSBjYWxsLiAgT3RoZXJ3aXNlLCByZXR1cm5zCiAgICAgKiAgICAgYHZhbHVlYCB1bmNoYW5nZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHZhbHVlT2YobWF5YmVUcnVzdGVkKSB7CiAgICAgIGlmIChtYXliZVRydXN0ZWQgaW5zdGFuY2VvZiB0cnVzdGVkVmFsdWVIb2xkZXJCYXNlKSB7CiAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZC4kJHVud3JhcFRydXN0ZWRWYWx1ZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQ7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUYWtlcyB0aGUgcmVzdWx0IG9mIGEge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9IGNhbGwgYW5kCiAgICAgKiByZXR1cm5zIHRoZSBvcmlnaW5hbGx5IHN1cHBsaWVkIHZhbHVlIGlmIHRoZSBxdWVyaWVkIGNvbnRleHQgdHlwZSBpcyBhIHN1cGVydHlwZSBvZiB0aGUKICAgICAqIGNyZWF0ZWQgdHlwZS4gIElmIHRoaXMgY29uZGl0aW9uIGlzbid0IHNhdGlzZmllZCwgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgdG8gYmUgdXNlZC4KICAgICAqIEBwYXJhbSB7Kn0gbWF5YmVUcnVzdGVkIFRoZSByZXN1bHQgb2YgYSBwcmlvciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAqICAgICBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSBjYWxsLgogICAgICogQHJldHVybnMgeyp9IFRoZSB2YWx1ZSB0aGUgd2FzIG9yaWdpbmFsbHkgcHJvdmlkZWQgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzCiAgICAgKiAgICAgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gaWYgdmFsaWQgaW4gdGhpcyBjb250ZXh0LiAgT3RoZXJ3aXNlLCB0aHJvd3MgYW4gZXhjZXB0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBnZXRUcnVzdGVkKHR5cGUsIG1heWJlVHJ1c3RlZCkgewogICAgICBpZiAobWF5YmVUcnVzdGVkID09PSBudWxsIHx8IG1heWJlVHJ1c3RlZCA9PT0gdW5kZWZpbmVkIHx8IG1heWJlVHJ1c3RlZCA9PT0gJycpIHsKICAgICAgICByZXR1cm4gbWF5YmVUcnVzdGVkOwogICAgICB9CiAgICAgIHZhciBjb25zdHJ1Y3RvciA9IChieVR5cGUuaGFzT3duUHJvcGVydHkodHlwZSkgPyBieVR5cGVbdHlwZV0gOiBudWxsKTsKICAgICAgaWYgKGNvbnN0cnVjdG9yICYmIG1heWJlVHJ1c3RlZCBpbnN0YW5jZW9mIGNvbnN0cnVjdG9yKSB7CiAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZC4kJHVud3JhcFRydXN0ZWRWYWx1ZSgpOwogICAgICB9CiAgICAgIC8vIElmIHdlIGdldCBoZXJlLCB0aGVuIHdlIG1heSBvbmx5IHRha2Ugb25lIG9mIHR3byBhY3Rpb25zLgogICAgICAvLyAxLiBzYW5pdGl6ZSB0aGUgdmFsdWUgZm9yIHRoZSByZXF1ZXN0ZWQgdHlwZSwgb3IKICAgICAgLy8gMi4gdGhyb3cgYW4gZXhjZXB0aW9uLgogICAgICBpZiAodHlwZSA9PT0gU0NFX0NPTlRFWFRTLlJFU09VUkNFX1VSTCkgewogICAgICAgIGlmIChpc1Jlc291cmNlVXJsQWxsb3dlZEJ5UG9saWN5KG1heWJlVHJ1c3RlZCkpIHsKICAgICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2luc2VjdXJsJywKICAgICAgICAgICAgICAnQmxvY2tlZCBsb2FkaW5nIHJlc291cmNlIGZyb20gdXJsIG5vdCBhbGxvd2VkIGJ5ICRzY2VEZWxlZ2F0ZSBwb2xpY3kuICBVUkw6IHswfScsCiAgICAgICAgICAgICAgbWF5YmVUcnVzdGVkLnRvU3RyaW5nKCkpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0eXBlID09PSBTQ0VfQ09OVEVYVFMuSFRNTCkgewogICAgICAgIHJldHVybiBodG1sU2FuaXRpemVyKG1heWJlVHJ1c3RlZCk7CiAgICAgIH0KICAgICAgdGhyb3cgJHNjZU1pbkVycigndW5zYWZlJywgJ0F0dGVtcHRpbmcgdG8gdXNlIGFuIHVuc2FmZSB2YWx1ZSBpbiBhIHNhZmUgY29udGV4dC4nKTsKICAgIH0KCiAgICByZXR1cm4geyB0cnVzdEFzOiB0cnVzdEFzLAogICAgICAgICAgICAgZ2V0VHJ1c3RlZDogZ2V0VHJ1c3RlZCwKICAgICAgICAgICAgIHZhbHVlT2Y6IHZhbHVlT2YgfTsKICB9XTsKfQoKCi8qKgogKiBAbmdkb2MgcHJvdmlkZXIKICogQG5hbWUgJHNjZVByb3ZpZGVyCiAqIEBkZXNjcmlwdGlvbgogKgogKiBUaGUgJHNjZVByb3ZpZGVyIHByb3ZpZGVyIGFsbG93cyBkZXZlbG9wZXJzIHRvIGNvbmZpZ3VyZSB0aGUge0BsaW5rIG5nLiRzY2UgJHNjZX0gc2VydmljZS4KICogLSAgIGVuYWJsZS9kaXNhYmxlIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpIGluIGEgbW9kdWxlCiAqIC0gICBvdmVycmlkZSB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3aXRoIGEgY3VzdG9tIGRlbGVnYXRlCiAqCiAqIFJlYWQgbW9yZSBhYm91dCB7QGxpbmsgbmcuJHNjZSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKX0uCiAqLwoKLyoganNoaW50IG1heGxlbjogZmFsc2UqLwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRzY2UKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIGAkc2NlYCBpcyBhIHNlcnZpY2UgdGhhdCBwcm92aWRlcyBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyBzZXJ2aWNlcyB0byBBbmd1bGFySlMuCiAqCiAqICMgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcKICoKICogU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgKFNDRSkgaXMgYSBtb2RlIGluIHdoaWNoIEFuZ3VsYXJKUyByZXF1aXJlcyBiaW5kaW5ncyBpbiBjZXJ0YWluCiAqIGNvbnRleHRzIHRvIHJlc3VsdCBpbiBhIHZhbHVlIHRoYXQgaXMgbWFya2VkIGFzIHNhZmUgdG8gdXNlIGZvciB0aGF0IGNvbnRleHQuICBPbmUgZXhhbXBsZSBvZgogKiBzdWNoIGEgY29udGV4dCBpcyBiaW5kaW5nIGFyYml0cmFyeSBodG1sIGNvbnRyb2xsZWQgYnkgdGhlIHVzZXIgdmlhIGBuZy1iaW5kLWh0bWxgLiAgV2UgcmVmZXIKICogdG8gdGhlc2UgY29udGV4dHMgYXMgcHJpdmlsZWdlZCBvciBTQ0UgY29udGV4dHMuCiAqCiAqIEFzIG9mIHZlcnNpb24gMS4yLCBBbmd1bGFyIHNoaXBzIHdpdGggU0NFIGVuYWJsZWQgYnkgZGVmYXVsdC4KICoKICogTm90ZTogIFdoZW4gZW5hYmxlZCAodGhlIGRlZmF1bHQpLCBJRTwxMSBpbiBxdWlya3MgbW9kZSBpcyBub3Qgc3VwcG9ydGVkLiAgSW4gdGhpcyBtb2RlLCBJRTwxMSBhbGxvdwogKiBvbmUgdG8gZXhlY3V0ZSBhcmJpdHJhcnkgamF2YXNjcmlwdCBieSB0aGUgdXNlIG9mIHRoZSBleHByZXNzaW9uKCkgc3ludGF4LiAgUmVmZXIKICogPGh0dHA6Ly9ibG9ncy5tc2RuLmNvbS9iL2llL2FyY2hpdmUvMjAwOC8xMC8xNi9lbmRpbmctZXhwcmVzc2lvbnMuYXNweD4gdG8gbGVhcm4gbW9yZSBhYm91dCB0aGVtLgogKiBZb3UgY2FuIGVuc3VyZSB5b3VyIGRvY3VtZW50IGlzIGluIHN0YW5kYXJkcyBtb2RlIGFuZCBub3QgcXVpcmtzIG1vZGUgYnkgYWRkaW5nIGA8IWRvY3R5cGUgaHRtbD5gCiAqIHRvIHRoZSB0b3Agb2YgeW91ciBIVE1MIGRvY3VtZW50LgogKgogKiBTQ0UgYXNzaXN0cyBpbiB3cml0aW5nIGNvZGUgaW4gd2F5IHRoYXQgKGEpIGlzIHNlY3VyZSBieSBkZWZhdWx0IGFuZCAoYikgbWFrZXMgYXVkaXRpbmcgZm9yCiAqIHNlY3VyaXR5IHZ1bG5lcmFiaWxpdGllcyBzdWNoIGFzIFhTUywgY2xpY2tqYWNraW5nLCBldGMuIGEgbG90IGVhc2llci4KICoKICogSGVyZSdzIGFuIGV4YW1wbGUgb2YgYSBiaW5kaW5nIGluIGEgcHJpdmlsZWdlZCBjb250ZXh0OgogKgogKiBgYGAKICogPGlucHV0IG5nLW1vZGVsPSJ1c2VySHRtbCI+CiAqIDxkaXYgbmctYmluZC1odG1sPSJ1c2VySHRtbCI+PC9kaXY+CiAqIGBgYAogKgogKiBOb3RpY2UgdGhhdCBgbmctYmluZC1odG1sYCBpcyBib3VuZCB0byBgdXNlckh0bWxgIGNvbnRyb2xsZWQgYnkgdGhlIHVzZXIuICBXaXRoIFNDRQogKiBkaXNhYmxlZCwgdGhpcyBhcHBsaWNhdGlvbiBhbGxvd3MgdGhlIHVzZXIgdG8gcmVuZGVyIGFyYml0cmFyeSBIVE1MIGludG8gdGhlIERJVi4KICogSW4gYSBtb3JlIHJlYWxpc3RpYyBleGFtcGxlLCBvbmUgbWF5IGJlIHJlbmRlcmluZyB1c2VyIGNvbW1lbnRzLCBibG9nIGFydGljbGVzLCBldGMuIHZpYQogKiBiaW5kaW5ncy4gIChIVE1MIGlzIGp1c3Qgb25lIGV4YW1wbGUgb2YgYSBjb250ZXh0IHdoZXJlIHJlbmRlcmluZyB1c2VyIGNvbnRyb2xsZWQgaW5wdXQgY3JlYXRlcwogKiBzZWN1cml0eSB2dWxuZXJhYmlsaXRpZXMuKQogKgogKiBGb3IgdGhlIGNhc2Ugb2YgSFRNTCwgeW91IG1pZ2h0IHVzZSBhIGxpYnJhcnksIGVpdGhlciBvbiB0aGUgY2xpZW50IHNpZGUsIG9yIG9uIHRoZSBzZXJ2ZXIgc2lkZSwKICogdG8gc2FuaXRpemUgdW5zYWZlIEhUTUwgYmVmb3JlIGJpbmRpbmcgdG8gdGhlIHZhbHVlIGFuZCByZW5kZXJpbmcgaXQgaW4gdGhlIGRvY3VtZW50LgogKgogKiBIb3cgd291bGQgeW91IGVuc3VyZSB0aGF0IGV2ZXJ5IHBsYWNlIHRoYXQgdXNlZCB0aGVzZSB0eXBlcyBvZiBiaW5kaW5ncyB3YXMgYm91bmQgdG8gYSB2YWx1ZSB0aGF0CiAqIHdhcyBzYW5pdGl6ZWQgYnkgeW91ciBsaWJyYXJ5IChvciByZXR1cm5lZCBhcyBzYWZlIGZvciByZW5kZXJpbmcgYnkgeW91ciBzZXJ2ZXI/KSAgSG93IGNhbiB5b3UKICogZW5zdXJlIHRoYXQgeW91IGRpZG4ndCBhY2NpZGVudGFsbHkgZGVsZXRlIHRoZSBsaW5lIHRoYXQgc2FuaXRpemVkIHRoZSB2YWx1ZSwgb3IgcmVuYW1lZCBzb21lCiAqIHByb3BlcnRpZXMvZmllbGRzIGFuZCBmb3Jnb3QgdG8gdXBkYXRlIHRoZSBiaW5kaW5nIHRvIHRoZSBzYW5pdGl6ZWQgdmFsdWU/CiAqCiAqIFRvIGJlIHNlY3VyZSBieSBkZWZhdWx0LCB5b3Ugd2FudCB0byBlbnN1cmUgdGhhdCBhbnkgc3VjaCBiaW5kaW5ncyBhcmUgZGlzYWxsb3dlZCB1bmxlc3MgeW91IGNhbgogKiBkZXRlcm1pbmUgdGhhdCBzb21ldGhpbmcgZXhwbGljaXRseSBzYXlzIGl0J3Mgc2FmZSB0byB1c2UgYSB2YWx1ZSBmb3IgYmluZGluZyBpbiB0aGF0CiAqIGNvbnRleHQuICBZb3UgY2FuIHRoZW4gYXVkaXQgeW91ciBjb2RlIChhIHNpbXBsZSBncmVwIHdvdWxkIGRvKSB0byBlbnN1cmUgdGhhdCB0aGlzIGlzIG9ubHkgZG9uZQogKiBmb3IgdGhvc2UgdmFsdWVzIHRoYXQgeW91IGNhbiBlYXNpbHkgdGVsbCBhcmUgc2FmZSAtIGJlY2F1c2UgdGhleSB3ZXJlIHJlY2VpdmVkIGZyb20geW91ciBzZXJ2ZXIsCiAqIHNhbml0aXplZCBieSB5b3VyIGxpYnJhcnksIGV0Yy4gIFlvdSBjYW4gb3JnYW5pemUgeW91ciBjb2RlYmFzZSB0byBoZWxwIHdpdGggdGhpcyAtIHBlcmhhcHMKICogYWxsb3dpbmcgb25seSB0aGUgZmlsZXMgaW4gYSBzcGVjaWZpYyBkaXJlY3RvcnkgdG8gZG8gdGhpcy4gIEVuc3VyaW5nIHRoYXQgdGhlIGludGVybmFsIEFQSQogKiBleHBvc2VkIGJ5IHRoYXQgY29kZSBkb2Vzbid0IG1hcmt1cCBhcmJpdHJhcnkgdmFsdWVzIGFzIHNhZmUgdGhlbiBiZWNvbWVzIGEgbW9yZSBtYW5hZ2VhYmxlIHRhc2suCiAqCiAqIEluIHRoZSBjYXNlIG9mIEFuZ3VsYXJKUycgU0NFIHNlcnZpY2UsIG9uZSB1c2VzIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfQogKiAoYW5kIHNob3J0aGFuZCBtZXRob2RzIHN1Y2ggYXMge0BsaW5rIG5nLiRzY2UjdHJ1c3RBc0h0bWwgJHNjZS50cnVzdEFzSHRtbH0sIGV0Yy4pIHRvCiAqIG9idGFpbiB2YWx1ZXMgdGhhdCB3aWxsIGJlIGFjY2VwdGVkIGJ5IFNDRSAvIHByaXZpbGVnZWQgY29udGV4dHMuCiAqCiAqCiAqICMjIEhvdyBkb2VzIGl0IHdvcms/CiAqCiAqIEluIHByaXZpbGVnZWQgY29udGV4dHMsIGRpcmVjdGl2ZXMgYW5kIGNvZGUgd2lsbCBiaW5kIHRvIHRoZSByZXN1bHQgb2Yge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZAogKiAkc2NlLmdldFRydXN0ZWQoY29udGV4dCwgdmFsdWUpfSByYXRoZXIgdGhhbiB0byB0aGUgdmFsdWUgZGlyZWN0bHkuICBEaXJlY3RpdmVzIHVzZSB7QGxpbmsKICogbmcuJHNjZSNwYXJzZUFzICRzY2UucGFyc2VBc30gcmF0aGVyIHRoYW4gYCRwYXJzZWAgdG8gd2F0Y2ggYXR0cmlidXRlIGJpbmRpbmdzLCB3aGljaCBwZXJmb3JtcyB0aGUKICoge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWR9IGJlaGluZCB0aGUgc2NlbmVzIG9uIG5vbi1jb25zdGFudCBsaXRlcmFscy4KICoKICogQXMgYW4gZXhhbXBsZSwge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0JpbmRIdG1sIG5nQmluZEh0bWx9IHVzZXMge0BsaW5rCiAqIG5nLiRzY2UjcGFyc2VBc0h0bWwgJHNjZS5wYXJzZUFzSHRtbChiaW5kaW5nIGV4cHJlc3Npb24pfS4gIEhlcmUncyB0aGUgYWN0dWFsIGNvZGUgKHNsaWdodGx5CiAqIHNpbXBsaWZpZWQpOgogKgogKiBgYGAKICogdmFyIG5nQmluZEh0bWxEaXJlY3RpdmUgPSBbJyRzY2UnLCBmdW5jdGlvbigkc2NlKSB7CiAqICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAqICAgICBzY29wZS4kd2F0Y2goJHNjZS5wYXJzZUFzSHRtbChhdHRyLm5nQmluZEh0bWwpLCBmdW5jdGlvbih2YWx1ZSkgewogKiAgICAgICBlbGVtZW50Lmh0bWwodmFsdWUgfHwgJycpOwogKiAgICAgfSk7CiAqICAgfTsKICogfV07CiAqIGBgYAogKgogKiAjIyBJbXBhY3Qgb24gbG9hZGluZyB0ZW1wbGF0ZXMKICoKICogVGhpcyBhcHBsaWVzIGJvdGggdG8gdGhlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlIGBuZy1pbmNsdWRlYH0gZGlyZWN0aXZlIGFzIHdlbGwgYXMKICogYHRlbXBsYXRlVXJsYCdzIHNwZWNpZmllZCBieSB7QGxpbmsgZ3VpZGUvZGlyZWN0aXZlIGRpcmVjdGl2ZXN9LgogKgogKiBCeSBkZWZhdWx0LCBBbmd1bGFyIG9ubHkgbG9hZHMgdGVtcGxhdGVzIGZyb20gdGhlIHNhbWUgZG9tYWluIGFuZCBwcm90b2NvbCBhcyB0aGUgYXBwbGljYXRpb24KICogZG9jdW1lbnQuICBUaGlzIGlzIGRvbmUgYnkgY2FsbGluZyB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkUmVzb3VyY2VVcmwKICogJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmx9IG9uIHRoZSB0ZW1wbGF0ZSBVUkwuICBUbyBsb2FkIHRlbXBsYXRlcyBmcm9tIG90aGVyIGRvbWFpbnMgYW5kL29yCiAqIHByb3RvY29scywgeW91IG1heSBlaXRoZXIgZWl0aGVyIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdCB3aGl0ZWxpc3QKICogdGhlbX0gb3Ige0BsaW5rIG5nLiRzY2UjdHJ1c3RBc1Jlc291cmNlVXJsIHdyYXAgaXR9IGludG8gYSB0cnVzdGVkIHZhbHVlLgogKgogKiAqUGxlYXNlIG5vdGUqOgogKiBUaGUgYnJvd3NlcidzCiAqIFtTYW1lIE9yaWdpbiBQb2xpY3ldKGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvYnJvd3NlcnNlYy93aWtpL1BhcnQyI1NhbWUtb3JpZ2luX3BvbGljeV9mb3JfWE1MSHR0cFJlcXVlc3QpCiAqIGFuZCBbQ3Jvc3MtT3JpZ2luIFJlc291cmNlIFNoYXJpbmcgKENPUlMpXShodHRwOi8vd3d3LnczLm9yZy9UUi9jb3JzLykKICogcG9saWN5IGFwcGx5IGluIGFkZGl0aW9uIHRvIHRoaXMgYW5kIG1heSBmdXJ0aGVyIHJlc3RyaWN0IHdoZXRoZXIgdGhlIHRlbXBsYXRlIGlzIHN1Y2Nlc3NmdWxseQogKiBsb2FkZWQuICBUaGlzIG1lYW5zIHRoYXQgd2l0aG91dCB0aGUgcmlnaHQgQ09SUyBwb2xpY3ksIGxvYWRpbmcgdGVtcGxhdGVzIGZyb20gYSBkaWZmZXJlbnQgZG9tYWluCiAqIHdvbid0IHdvcmsgb24gYWxsIGJyb3dzZXJzLiAgQWxzbywgbG9hZGluZyB0ZW1wbGF0ZXMgZnJvbSBgZmlsZTovL2AgVVJMIGRvZXMgbm90IHdvcmsgb24gc29tZQogKiBicm93c2Vycy4KICoKICogIyMgVGhpcyBmZWVscyBsaWtlIHRvbyBtdWNoIG92ZXJoZWFkCiAqCiAqIEl0J3MgaW1wb3J0YW50IHRvIHJlbWVtYmVyIHRoYXQgU0NFIG9ubHkgYXBwbGllcyB0byBpbnRlcnBvbGF0aW9uIGV4cHJlc3Npb25zLgogKgogKiBJZiB5b3VyIGV4cHJlc3Npb25zIGFyZSBjb25zdGFudCBsaXRlcmFscywgdGhleSdyZSBhdXRvbWF0aWNhbGx5IHRydXN0ZWQgYW5kIHlvdSBkb24ndCBuZWVkIHRvCiAqIGNhbGwgYCRzY2UudHJ1c3RBc2Agb24gdGhlbSAocmVtZW1iZXIgdG8gaW5jbHVkZSB0aGUgYG5nU2FuaXRpemVgIG1vZHVsZSkgKGUuZy4KICogYDxkaXYgbmctYmluZC1odG1sPSInPGI+aW1wbGljaXRseSB0cnVzdGVkPC9iPiciPjwvZGl2PmApIGp1c3Qgd29ya3MuCiAqCiAqIEFkZGl0aW9uYWxseSwgYGFbaHJlZl1gIGFuZCBgaW1nW3NyY11gIGF1dG9tYXRpY2FsbHkgc2FuaXRpemUgdGhlaXIgVVJMcyBhbmQgZG8gbm90IHBhc3MgdGhlbQogKiB0aHJvdWdoIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWQgJHNjZS5nZXRUcnVzdGVkfS4gIFNDRSBkb2Vzbid0IHBsYXkgYSByb2xlIGhlcmUuCiAqCiAqIFRoZSBpbmNsdWRlZCB7QGxpbmsgbmcuJHNjZURlbGVnYXRlICRzY2VEZWxlZ2F0ZX0gY29tZXMgd2l0aCBzYW5lIGRlZmF1bHRzIHRvIGFsbG93IHlvdSB0byBsb2FkCiAqIHRlbXBsYXRlcyBpbiBgbmctaW5jbHVkZWAgZnJvbSB5b3VyIGFwcGxpY2F0aW9uJ3MgZG9tYWluIHdpdGhvdXQgaGF2aW5nIHRvIGV2ZW4ga25vdyBhYm91dCBTQ0UuCiAqIEl0IGJsb2NrcyBsb2FkaW5nIHRlbXBsYXRlcyBmcm9tIG90aGVyIGRvbWFpbnMgb3IgbG9hZGluZyB0ZW1wbGF0ZXMgb3ZlciBodHRwIGZyb20gYW4gaHR0cHMKICogc2VydmVkIGRvY3VtZW50LiAgWW91IGNhbiBjaGFuZ2UgdGhlc2UgYnkgc2V0dGluZyB5b3VyIG93biBjdXN0b20ge0BsaW5rCiAqIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0IHdoaXRlbGlzdHN9IGFuZCB7QGxpbmsKICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QgYmxhY2tsaXN0c30gZm9yIG1hdGNoaW5nIHN1Y2ggVVJMcy4KICoKICogVGhpcyBzaWduaWZpY2FudGx5IHJlZHVjZXMgdGhlIG92ZXJoZWFkLiAgSXQgaXMgZmFyIGVhc2llciB0byBwYXkgdGhlIHNtYWxsIG92ZXJoZWFkIGFuZCBoYXZlIGFuCiAqIGFwcGxpY2F0aW9uIHRoYXQncyBzZWN1cmUgYW5kIGNhbiBiZSBhdWRpdGVkIHRvIHZlcmlmeSB0aGF0IHdpdGggbXVjaCBtb3JlIGVhc2UgdGhhbiBib2x0aW5nCiAqIHNlY3VyaXR5IG9udG8gYW4gYXBwbGljYXRpb24gbGF0ZXIuCiAqCiAqIDxhIG5hbWU9ImNvbnRleHRzIj48L2E+CiAqICMjIFdoYXQgdHJ1c3RlZCBjb250ZXh0IHR5cGVzIGFyZSBzdXBwb3J0ZWQ/CiAqCiAqIHwgQ29udGV4dCAgICAgICAgICAgICB8IE5vdGVzICAgICAgICAgIHwKICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tfAogKiB8IGAkc2NlLkhUTUxgICAgICAgICAgfCBGb3IgSFRNTCB0aGF0J3Mgc2FmZSB0byBzb3VyY2UgaW50byB0aGUgYXBwbGljYXRpb24uICBUaGUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0JpbmRIdG1sIG5nQmluZEh0bWx9IGRpcmVjdGl2ZSB1c2VzIHRoaXMgY29udGV4dCBmb3IgYmluZGluZ3MuIElmIGFuIHVuc2FmZSB2YWx1ZSBpcyBlbmNvdW50ZXJlZCBhbmQgdGhlIHtAbGluayBuZ1Nhbml0aXplICRzYW5pdGl6ZX0gbW9kdWxlIGlzIHByZXNlbnQgdGhpcyB3aWxsIHNhbml0aXplIHRoZSB2YWx1ZSBpbnN0ZWFkIG9mIHRocm93aW5nIGFuIGVycm9yLiB8CiAqIHwgYCRzY2UuQ1NTYCAgICAgICAgICB8IEZvciBDU1MgdGhhdCdzIHNhZmUgdG8gc291cmNlIGludG8gdGhlIGFwcGxpY2F0aW9uLiAgQ3VycmVudGx5IHVudXNlZC4gIEZlZWwgZnJlZSB0byB1c2UgaXQgaW4geW91ciBvd24gZGlyZWN0aXZlcy4gfAogKiB8IGAkc2NlLlVSTGAgICAgICAgICAgfCBGb3IgVVJMcyB0aGF0IGFyZSBzYWZlIHRvIGZvbGxvdyBhcyBsaW5rcy4gIEN1cnJlbnRseSB1bnVzZWQgKGA8YSBocmVmPWAgYW5kIGA8aW1nIHNyYz1gIHNhbml0aXplIHRoZWlyIHVybHMgYW5kIGRvbid0IGNvbnN0aXR1dGUgYW4gU0NFIGNvbnRleHQuIHwKICogfCBgJHNjZS5SRVNPVVJDRV9VUkxgIHwgRm9yIFVSTHMgdGhhdCBhcmUgbm90IG9ubHkgc2FmZSB0byBmb2xsb3cgYXMgbGlua3MsIGJ1dCB3aG9zZSBjb250ZW50cyBhcmUgYWxzbyBzYWZlIHRvIGluY2x1ZGUgaW4geW91ciBhcHBsaWNhdGlvbi4gIEV4YW1wbGVzIGluY2x1ZGUgYG5nLWluY2x1ZGVgLCBgc3JjYCAvIGBuZ1NyY2AgYmluZGluZ3MgZm9yIHRhZ3Mgb3RoZXIgdGhhbiBgSU1HYCAoZS5nLiBgSUZSQU1FYCwgYE9CSkVDVGAsIGV0Yy4pICA8YnI+PGJyPk5vdGUgdGhhdCBgJHNjZS5SRVNPVVJDRV9VUkxgIG1ha2VzIGEgc3Ryb25nZXIgc3RhdGVtZW50IGFib3V0IHRoZSBVUkwgdGhhbiBgJHNjZS5VUkxgIGRvZXMgYW5kIHRoZXJlZm9yZSBjb250ZXh0cyByZXF1aXJpbmcgdmFsdWVzIHRydXN0ZWQgZm9yIGAkc2NlLlJFU09VUkNFX1VSTGAgY2FuIGJlIHVzZWQgYW55d2hlcmUgdGhhdCB2YWx1ZXMgdHJ1c3RlZCBmb3IgYCRzY2UuVVJMYCBhcmUgcmVxdWlyZWQuIHwKICogfCBgJHNjZS5KU2AgICAgICAgICAgIHwgRm9yIEphdmFTY3JpcHQgdGhhdCBpcyBzYWZlIHRvIGV4ZWN1dGUgaW4geW91ciBhcHBsaWNhdGlvbidzIGNvbnRleHQuICBDdXJyZW50bHkgdW51c2VkLiAgRmVlbCBmcmVlIHRvIHVzZSBpdCBpbiB5b3VyIG93biBkaXJlY3RpdmVzLiB8CiAqCiAqICMjIEZvcm1hdCBvZiBpdGVtcyBpbiB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3QgcmVzb3VyY2VVcmxXaGl0ZWxpc3R9L3tAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybEJsYWNrbGlzdCBCbGFja2xpc3R9IDxhIG5hbWU9InJlc291cmNlVXJsUGF0dGVybkl0ZW0iPjwvYT4KICoKICogIEVhY2ggZWxlbWVudCBpbiB0aGVzZSBhcnJheXMgbXVzdCBiZSBvbmUgb2YgdGhlIGZvbGxvd2luZzoKICoKICogIC0gKionc2VsZicqKgogKiAgICAtIFRoZSBzcGVjaWFsICoqc3RyaW5nKiosIGAnc2VsZidgLCBjYW4gYmUgdXNlZCB0byBtYXRjaCBhZ2FpbnN0IGFsbCBVUkxzIG9mIHRoZSAqKnNhbWUKICogICAgICBkb21haW4qKiBhcyB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgdXNpbmcgdGhlICoqc2FtZSBwcm90b2NvbCoqLgogKiAgLSAqKlN0cmluZyoqIChleGNlcHQgdGhlIHNwZWNpYWwgdmFsdWUgYCdzZWxmJ2ApCiAqICAgIC0gVGhlIHN0cmluZyBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGZ1bGwgKm5vcm1hbGl6ZWQgLyBhYnNvbHV0ZSBVUkwqIG9mIHRoZSByZXNvdXJjZQogKiAgICAgIGJlaW5nIHRlc3RlZCAoc3Vic3RyaW5nIG1hdGNoZXMgYXJlIG5vdCBnb29kIGVub3VnaC4pCiAqICAgIC0gVGhlcmUgYXJlIGV4YWN0bHkgKip0d28gd2lsZGNhcmQgc2VxdWVuY2VzKiogLSBgKmAgYW5kIGAqKmAuICBBbGwgb3RoZXIgY2hhcmFjdGVycwogKiAgICAgIG1hdGNoIHRoZW1zZWx2ZXMuCiAqICAgIC0gYCpgOiBtYXRjaGVzIHplcm8gb3IgbW9yZSBvY2N1cnJlbmNlcyBvZiBhbnkgY2hhcmFjdGVyIG90aGVyIHRoYW4gb25lIG9mIHRoZSBmb2xsb3dpbmcgNgogKiAgICAgIGNoYXJhY3RlcnM6ICdgOmAnLCAnYC9gJywgJ2AuYCcsICdgP2AnLCAnYCZgJyBhbmQgJzsnLiAgSXQncyBhIHVzZWZ1bCB3aWxkY2FyZCBmb3IgdXNlCiAqICAgICAgaW4gYSB3aGl0ZWxpc3QuCiAqICAgIC0gYCoqYDogbWF0Y2hlcyB6ZXJvIG9yIG1vcmUgb2NjdXJyZW5jZXMgb2YgKmFueSogY2hhcmFjdGVyLiAgQXMgc3VjaCwgaXQncyBub3QKICogICAgICBub3QgYXBwcm9wcmlhdGUgdG8gdXNlIGluIGZvciBhIHNjaGVtZSwgZG9tYWluLCBldGMuIGFzIGl0IHdvdWxkIG1hdGNoIHRvbyBtdWNoLiAgKGUuZy4KICogICAgICBodHRwOi8vKiouZXhhbXBsZS5jb20vIHdvdWxkIG1hdGNoIGh0dHA6Ly9ldmlsLmNvbS8/aWdub3JlPS5leGFtcGxlLmNvbS8gYW5kIHRoYXQgbWlnaHQKICogICAgICBub3QgaGF2ZSBiZWVuIHRoZSBpbnRlbnRpb24uKSAgSXRzIHVzYWdlIGF0IHRoZSB2ZXJ5IGVuZCBvZiB0aGUgcGF0aCBpcyBvay4gIChlLmcuCiAqICAgICAgaHR0cDovL2Zvby5leGFtcGxlLmNvbS90ZW1wbGF0ZXMvKiopLgogKiAgLSAqKlJlZ0V4cCoqICgqc2VlIGNhdmVhdCBiZWxvdyopCiAqICAgIC0gKkNhdmVhdCo6ICBXaGlsZSByZWd1bGFyIGV4cHJlc3Npb25zIGFyZSBwb3dlcmZ1bCBhbmQgb2ZmZXIgZ3JlYXQgZmxleGliaWxpdHksICB0aGVpciBzeW50YXgKICogICAgICAoYW5kIGFsbCB0aGUgaW5ldml0YWJsZSBlc2NhcGluZykgbWFrZXMgdGhlbSAqaGFyZGVyIHRvIG1haW50YWluKi4gIEl0J3MgZWFzeSB0bwogKiAgICAgIGFjY2lkZW50YWxseSBpbnRyb2R1Y2UgYSBidWcgd2hlbiBvbmUgdXBkYXRlcyBhIGNvbXBsZXggZXhwcmVzc2lvbiAoaW1obywgYWxsIHJlZ2V4ZXMgc2hvdWxkCiAqICAgICAgaGF2ZSBnb29kIHRlc3QgY292ZXJhZ2UuKS4gIEZvciBpbnN0YW5jZSwgdGhlIHVzZSBvZiBgLmAgaW4gdGhlIHJlZ2V4IGlzIGNvcnJlY3Qgb25seSBpbiBhCiAqICAgICAgc21hbGwgbnVtYmVyIG9mIGNhc2VzLiAgQSBgLmAgY2hhcmFjdGVyIGluIHRoZSByZWdleCB1c2VkIHdoZW4gbWF0Y2hpbmcgdGhlIHNjaGVtZSBvciBhCiAqICAgICAgc3ViZG9tYWluIGNvdWxkIGJlIG1hdGNoZWQgYWdhaW5zdCBhIGA6YCBvciBsaXRlcmFsIGAuYCB0aGF0IHdhcyBsaWtlbHkgbm90IGludGVuZGVkLiAgIEl0CiAqICAgICAgaXMgaGlnaGx5IHJlY29tbWVuZGVkIHRvIHVzZSB0aGUgc3RyaW5nIHBhdHRlcm5zIGFuZCBvbmx5IGZhbGwgYmFjayB0byByZWd1bGFyIGV4cHJlc3Npb25zCiAqICAgICAgaWYgdGhleSBhcyBhIGxhc3QgcmVzb3J0LgogKiAgICAtIFRoZSByZWd1bGFyIGV4cHJlc3Npb24gbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBSZWdFeHAgKGkuZS4gbm90IGEgc3RyaW5nLikgIEl0IGlzCiAqICAgICAgbWF0Y2hlZCBhZ2FpbnN0IHRoZSAqKmVudGlyZSoqICpub3JtYWxpemVkIC8gYWJzb2x1dGUgVVJMKiBvZiB0aGUgcmVzb3VyY2UgYmVpbmcgdGVzdGVkCiAqICAgICAgKGV2ZW4gd2hlbiB0aGUgUmVnRXhwIGRpZCBub3QgaGF2ZSB0aGUgYF5gIGFuZCBgJGAgY29kZXMuKSAgSW4gYWRkaXRpb24sIGFueSBmbGFncwogKiAgICAgIHByZXNlbnQgb24gdGhlIFJlZ0V4cCAoc3VjaCBhcyBtdWx0aWxpbmUsIGdsb2JhbCwgaWdub3JlQ2FzZSkgYXJlIGlnbm9yZWQuCiAqICAgIC0gSWYgeW91IGFyZSBnZW5lcmF0aW5nIHlvdXIgSmF2YVNjcmlwdCBmcm9tIHNvbWUgb3RoZXIgdGVtcGxhdGluZyBlbmdpbmUgKG5vdAogKiAgICAgIHJlY29tbWVuZGVkLCBlLmcuIGluIGlzc3VlIFsjNDAwNl0oaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvNDAwNikpLAogKiAgICAgIHJlbWVtYmVyIHRvIGVzY2FwZSB5b3VyIHJlZ3VsYXIgZXhwcmVzc2lvbiAoYW5kIGJlIGF3YXJlIHRoYXQgeW91IG1pZ2h0IG5lZWQgbW9yZSB0aGFuCiAqICAgICAgb25lIGxldmVsIG9mIGVzY2FwaW5nIGRlcGVuZGluZyBvbiB5b3VyIHRlbXBsYXRpbmcgZW5naW5lIGFuZCB0aGUgd2F5IHlvdSBpbnRlcnBvbGF0ZWQKICogICAgICB0aGUgdmFsdWUuKSAgRG8gbWFrZSB1c2Ugb2YgeW91ciBwbGF0Zm9ybSdzIGVzY2FwaW5nIG1lY2hhbmlzbSBhcyBpdCBtaWdodCBiZSBnb29kCiAqICAgICAgZW5vdWdoIGJlZm9yZSBjb2RpbmcgeW91ciBvd24uICBlLmcuIFJ1YnkgaGFzCiAqICAgICAgW1JlZ2V4cC5lc2NhcGUoc3RyKV0oaHR0cDovL3d3dy5ydWJ5LWRvYy5vcmcvY29yZS0yLjAuMC9SZWdleHAuaHRtbCNtZXRob2QtYy1lc2NhcGUpCiAqICAgICAgYW5kIFB5dGhvbiBoYXMgW3JlLmVzY2FwZV0oaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L3JlLmh0bWwjcmUuZXNjYXBlKS4KICogICAgICBKYXZhc2NyaXB0IGxhY2tzIGEgc2ltaWxhciBidWlsdCBpbiBmdW5jdGlvbiBmb3IgZXNjYXBpbmcuICBUYWtlIGEgbG9vayBhdCBHb29nbGUKICogICAgICBDbG9zdXJlIGxpYnJhcnkncyBbZ29vZy5zdHJpbmcucmVnRXhwRXNjYXBlKHMpXSgKICogICAgICBodHRwOi8vZG9jcy5jbG9zdXJlLWxpYnJhcnkuZ29vZ2xlY29kZS5jb20vZ2l0L2Nsb3N1cmVfZ29vZ19zdHJpbmdfc3RyaW5nLmpzLnNvdXJjZS5odG1sI2xpbmU5NjIpLgogKgogKiBSZWZlciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIgJHNjZURlbGVnYXRlUHJvdmlkZXJ9IGZvciBhbiBleGFtcGxlLgogKgogKiAjIyBTaG93IG1lIGFuIGV4YW1wbGUgdXNpbmcgU0NFLgogKgogKiA8ZXhhbXBsZSBtb2R1bGU9Im15U2NlQXBwIiBkZXBzPSJhbmd1bGFyLXNhbml0aXplLmpzIj4KICogPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAqICAgPGRpdiBuZy1jb250cm9sbGVyPSJBcHBDb250cm9sbGVyIGFzIG15Q3RybCI+CiAqICAgICA8aSBuZy1iaW5kLWh0bWw9Im15Q3RybC5leHBsaWNpdGx5VHJ1c3RlZEh0bWwiIGlkPSJleHBsaWNpdGx5VHJ1c3RlZEh0bWwiPjwvaT48YnI+PGJyPgogKiAgICAgPGI+VXNlciBjb21tZW50czwvYj48YnI+CiAqICAgICBCeSBkZWZhdWx0LCBIVE1MIHRoYXQgaXNuJ3QgZXhwbGljaXRseSB0cnVzdGVkIChlLmcuIEFsaWNlJ3MgY29tbWVudCkgaXMgc2FuaXRpemVkIHdoZW4KICogICAgICRzYW5pdGl6ZSBpcyBhdmFpbGFibGUuICBJZiAkc2FuaXRpemUgaXNuJ3QgYXZhaWxhYmxlLCB0aGlzIHJlc3VsdHMgaW4gYW4gZXJyb3IgaW5zdGVhZCBvZiBhbgogKiAgICAgZXhwbG9pdC4KICogICAgIDxkaXYgY2xhc3M9IndlbGwiPgogKiAgICAgICA8ZGl2IG5nLXJlcGVhdD0idXNlckNvbW1lbnQgaW4gbXlDdHJsLnVzZXJDb21tZW50cyI+CiAqICAgICAgICAgPGI+e3t1c2VyQ29tbWVudC5uYW1lfX08L2I+OgogKiAgICAgICAgIDxzcGFuIG5nLWJpbmQtaHRtbD0idXNlckNvbW1lbnQuaHRtbENvbW1lbnQiIGNsYXNzPSJodG1sQ29tbWVudCI+PC9zcGFuPgogKiAgICAgICAgIDxicj4KICogICAgICAgPC9kaXY+CiAqICAgICA8L2Rpdj4KICogICA8L2Rpdj4KICogPC9maWxlPgogKgogKiA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogKiAgIGFuZ3VsYXIubW9kdWxlKCdteVNjZUFwcCcsIFsnbmdTYW5pdGl6ZSddKQogKiAgICAgLmNvbnRyb2xsZXIoJ0FwcENvbnRyb2xsZXInLCBbJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywgJyRzY2UnLAogKiAgICAgICBmdW5jdGlvbigkaHR0cCwgJHRlbXBsYXRlQ2FjaGUsICRzY2UpIHsKICogICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAqICAgICAgICAgJGh0dHAuZ2V0KCJ0ZXN0X2RhdGEuanNvbiIsIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS5zdWNjZXNzKGZ1bmN0aW9uKHVzZXJDb21tZW50cykgewogKiAgICAgICAgICAgc2VsZi51c2VyQ29tbWVudHMgPSB1c2VyQ29tbWVudHM7CiAqICAgICAgICAgfSk7CiAqICAgICAgICAgc2VsZi5leHBsaWNpdGx5VHJ1c3RlZEh0bWwgPSAkc2NlLnRydXN0QXNIdG1sKAogKiAgICAgICAgICAgICAnPHNwYW4gb25tb3VzZW92ZXI9InRoaXMudGV4dENvbnRlbnQ9JnF1b3Q7RXhwbGljaXRseSB0cnVzdGVkIEhUTUwgYnlwYXNzZXMgJyArCiAqICAgICAgICAgICAgICdzYW5pdGl6YXRpb24uJnF1b3Q7Ij5Ib3ZlciBvdmVyIHRoaXMgdGV4dC48L3NwYW4+Jyk7CiAqICAgICAgIH1dKTsKICogPC9maWxlPgogKgogKiA8ZmlsZSBuYW1lPSJ0ZXN0X2RhdGEuanNvbiI+CiAqIFsKICogICB7ICJuYW1lIjogIkFsaWNlIiwKICogICAgICJodG1sQ29tbWVudCI6CiAqICAgICAgICAgIjxzcGFuIG9ubW91c2VvdmVyPSd0aGlzLnRleHRDb250ZW50PVwiUFdOM0QhXCInPklzIDxpPmFueW9uZTwvaT4gcmVhZGluZyB0aGlzPzwvc3Bhbj4iCiAqICAgfSwKICogICB7ICJuYW1lIjogIkJvYiIsCiAqICAgICAiaHRtbENvbW1lbnQiOiAiPGk+WWVzITwvaT4gIEFtIEkgdGhlIG9ubHkgb3RoZXIgb25lPyIKICogICB9CiAqIF0KICogPC9maWxlPgogKgogKiA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICogICBkZXNjcmliZSgnU0NFIGRvYyBkZW1vJywgZnVuY3Rpb24oKSB7CiAqICAgICBpdCgnc2hvdWxkIHNhbml0aXplIHVudHJ1c3RlZCB2YWx1ZXMnLCBmdW5jdGlvbigpIHsKICogICAgICAgZXhwZWN0KGVsZW1lbnQuYWxsKGJ5LmNzcygnLmh0bWxDb21tZW50JykpLmZpcnN0KCkuZ2V0SW5uZXJIdG1sKCkpCiAqICAgICAgICAgICAudG9CZSgnPHNwYW4+SXMgPGk+YW55b25lPC9pPiByZWFkaW5nIHRoaXM/PC9zcGFuPicpOwogKiAgICAgfSk7CiAqCiAqICAgICBpdCgnc2hvdWxkIE5PVCBzYW5pdGl6ZSBleHBsaWNpdGx5IHRydXN0ZWQgdmFsdWVzJywgZnVuY3Rpb24oKSB7CiAqICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdleHBsaWNpdGx5VHJ1c3RlZEh0bWwnKSkuZ2V0SW5uZXJIdG1sKCkpLnRvQmUoCiAqICAgICAgICAgICAnPHNwYW4gb25tb3VzZW92ZXI9InRoaXMudGV4dENvbnRlbnQ9JnF1b3Q7RXhwbGljaXRseSB0cnVzdGVkIEhUTUwgYnlwYXNzZXMgJyArCiAqICAgICAgICAgICAnc2FuaXRpemF0aW9uLiZxdW90OyI+SG92ZXIgb3ZlciB0aGlzIHRleHQuPC9zcGFuPicpOwogKiAgICAgfSk7CiAqICAgfSk7CiAqIDwvZmlsZT4KICogPC9leGFtcGxlPgogKgogKgogKgogKiAjIyBDYW4gSSBkaXNhYmxlIFNDRSBjb21wbGV0ZWx5PwogKgogKiBZZXMsIHlvdSBjYW4uICBIb3dldmVyLCB0aGlzIGlzIHN0cm9uZ2x5IGRpc2NvdXJhZ2VkLiAgU0NFIGdpdmVzIHlvdSBhIGxvdCBvZiBzZWN1cml0eSBiZW5lZml0cwogKiBmb3IgbGl0dGxlIGNvZGluZyBvdmVyaGVhZC4gIEl0IHdpbGwgYmUgbXVjaCBoYXJkZXIgdG8gdGFrZSBhbiBTQ0UgZGlzYWJsZWQgYXBwbGljYXRpb24gYW5kCiAqIGVpdGhlciBzZWN1cmUgaXQgb24geW91ciBvd24gb3IgZW5hYmxlIFNDRSBhdCBhIGxhdGVyIHN0YWdlLiAgSXQgbWlnaHQgbWFrZSBzZW5zZSB0byBkaXNhYmxlIFNDRQogKiBmb3IgY2FzZXMgd2hlcmUgeW91IGhhdmUgYSBsb3Qgb2YgZXhpc3RpbmcgY29kZSB0aGF0IHdhcyB3cml0dGVuIGJlZm9yZSBTQ0Ugd2FzIGludHJvZHVjZWQgYW5kCiAqIHlvdSdyZSBtaWdyYXRpbmcgdGhlbSBhIG1vZHVsZSBhdCBhIHRpbWUuCiAqCiAqIFRoYXQgc2FpZCwgaGVyZSdzIGhvdyB5b3UgY2FuIGNvbXBsZXRlbHkgZGlzYWJsZSBTQ0U6CiAqCiAqIGBgYAogKiBhbmd1bGFyLm1vZHVsZSgnbXlBcHBXaXRoU2NlRGlzYWJsZWRteUFwcCcsIFtdKS5jb25maWcoZnVuY3Rpb24oJHNjZVByb3ZpZGVyKSB7CiAqICAgLy8gQ29tcGxldGVseSBkaXNhYmxlIFNDRS4gIEZvciBkZW1vbnN0cmF0aW9uIHB1cnBvc2VzIG9ubHkhCiAqICAgLy8gRG8gbm90IHVzZSBpbiBuZXcgcHJvamVjdHMuCiAqICAgJHNjZVByb3ZpZGVyLmVuYWJsZWQoZmFsc2UpOwogKiB9KTsKICogYGBgCiAqCiAqLwovKiBqc2hpbnQgbWF4bGVuOiAxMDAgKi8KCmZ1bmN0aW9uICRTY2VQcm92aWRlcigpIHsKICB2YXIgZW5hYmxlZCA9IHRydWU7CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkc2NlUHJvdmlkZXIjZW5hYmxlZAogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAcGFyYW0ge2Jvb2xlYW49fSB2YWx1ZSBJZiBwcm92aWRlZCwgdGhlbiBlbmFibGVzL2Rpc2FibGVzIFNDRS4KICAgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIFNDRSBpcyBlbmFibGVkLCBmYWxzZSBvdGhlcndpc2UuCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBFbmFibGVzL2Rpc2FibGVzIFNDRSBhbmQgcmV0dXJucyB0aGUgY3VycmVudCB2YWx1ZS4KICAgKi8KICB0aGlzLmVuYWJsZWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIGVuYWJsZWQgPSAhIXZhbHVlOwogICAgfQogICAgcmV0dXJuIGVuYWJsZWQ7CiAgfTsKCgogIC8qIERlc2lnbiBub3RlcyBvbiB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBmb3IgU0NFLgogICAqCiAgICogVGhlIEFQSSBjb250cmFjdCBmb3IgdGhlIFNDRSBkZWxlZ2F0ZQogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBUaGUgU0NFIGRlbGVnYXRlIG9iamVjdCBtdXN0IHByb3ZpZGUgdGhlIGZvbGxvd2luZyAzIG1ldGhvZHM6CiAgICoKICAgKiAtIHRydXN0QXMoY29udGV4dEVudW0sIHZhbHVlKQogICAqICAgICBUaGlzIG1ldGhvZCBpcyB1c2VkIHRvIHRlbGwgdGhlIFNDRSBzZXJ2aWNlIHRoYXQgdGhlIHByb3ZpZGVkIHZhbHVlIGlzIE9LIHRvIHVzZSBpbiB0aGUKICAgKiAgICAgY29udGV4dHMgc3BlY2lmaWVkIGJ5IGNvbnRleHRFbnVtLiAgSXQgbXVzdCByZXR1cm4gYW4gb2JqZWN0IHRoYXQgd2lsbCBiZSBhY2NlcHRlZCBieQogICAqICAgICBnZXRUcnVzdGVkKCkgZm9yIGEgY29tcGF0aWJsZSBjb250ZXh0RW51bSBhbmQgcmV0dXJuIHRoaXMgdmFsdWUuCiAgICoKICAgKiAtIHZhbHVlT2YodmFsdWUpCiAgICogICAgIEZvciB2YWx1ZXMgdGhhdCB3ZXJlIG5vdCBwcm9kdWNlZCBieSB0cnVzdEFzKCksIHJldHVybiB0aGVtIGFzIGlzLiAgRm9yIHZhbHVlcyB0aGF0IHdlcmUKICAgKiAgICAgcHJvZHVjZWQgYnkgdHJ1c3RBcygpLCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgaW5wdXQgdmFsdWUgdG8gdHJ1c3RBcy4gIEJhc2ljYWxseSwgaWYKICAgKiAgICAgdHJ1c3RBcyBpcyB3cmFwcGluZyB0aGUgZ2l2ZW4gdmFsdWVzIGludG8gc29tZSB0eXBlLCB0aGlzIG9wZXJhdGlvbiB1bndyYXBzIGl0IHdoZW4gZ2l2ZW4KICAgKiAgICAgc3VjaCBhIHZhbHVlLgogICAqCiAgICogLSBnZXRUcnVzdGVkKGNvbnRleHRFbnVtLCB2YWx1ZSkKICAgKiAgICAgVGhpcyBmdW5jdGlvbiBzaG91bGQgcmV0dXJuIHRoZSBhIHZhbHVlIHRoYXQgaXMgc2FmZSB0byB1c2UgaW4gdGhlIGNvbnRleHQgc3BlY2lmaWVkIGJ5CiAgICogICAgIGNvbnRleHRFbnVtIG9yIHRocm93IGFuZCBleGNlcHRpb24gb3RoZXJ3aXNlLgogICAqCiAgICogTk9URTogVGhpcyBjb250cmFjdCBkZWxpYmVyYXRlbHkgZG9lcyBOT1Qgc3RhdGUgdGhhdCB2YWx1ZXMgcmV0dXJuZWQgYnkgdHJ1c3RBcygpIG11c3QgYmUKICAgKiBvcGFxdWUgb3Igd3JhcHBlZCBpbiBzb21lIGhvbGRlciBvYmplY3QuICBUaGF0IGhhcHBlbnMgdG8gYmUgYW4gaW1wbGVtZW50YXRpb24gZGV0YWlsLiAgRm9yCiAgICogaW5zdGFuY2UsIGFuIGltcGxlbWVudGF0aW9uIGNvdWxkIG1haW50YWluIGEgcmVnaXN0cnkgb2YgYWxsIHRydXN0ZWQgb2JqZWN0cyBieSBjb250ZXh0LiAgSW4KICAgKiBzdWNoIGEgY2FzZSwgdHJ1c3RBcygpIHdvdWxkIHJldHVybiB0aGUgc2FtZSBvYmplY3QgdGhhdCB3YXMgcGFzc2VkIGluLiAgZ2V0VHJ1c3RlZCgpIHdvdWxkCiAgICogcmV0dXJuIHRoZSBzYW1lIG9iamVjdCBwYXNzZWQgaW4gaWYgaXQgd2FzIGZvdW5kIGluIHRoZSByZWdpc3RyeSB1bmRlciBhIGNvbXBhdGlibGUgY29udGV4dCBvcgogICAqIHRocm93IGFuIGV4Y2VwdGlvbiBvdGhlcndpc2UuICBBbiBpbXBsZW1lbnRhdGlvbiBtaWdodCBvbmx5IHdyYXAgdmFsdWVzIHNvbWUgb2YgdGhlIHRpbWUgYmFzZWQKICAgKiBvbiBzb21lIGNyaXRlcmlhLiAgZ2V0VHJ1c3RlZCgpIG1pZ2h0IHJldHVybiBhIHZhbHVlIGFuZCBub3QgdGhyb3cgYW4gZXhjZXB0aW9uIGZvciBzcGVjaWFsCiAgICogY29uc3RhbnRzIG9yIG9iamVjdHMgZXZlbiBpZiBub3Qgd3JhcHBlZC4gIEFsbCBzdWNoIGltcGxlbWVudGF0aW9ucyBmdWxmaWxsIHRoaXMgY29udHJhY3QuCiAgICoKICAgKgogICAqIEEgbm90ZSBvbiB0aGUgaW5oZXJpdGFuY2UgbW9kZWwgZm9yIFNDRSBjb250ZXh0cwogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEkndmUgdXNlZCBpbmhlcml0YW5jZSBhbmQgbWFkZSBSRVNPVVJDRV9VUkwgd3JhcHBlZCB0eXBlcyBhIHN1YnR5cGUgb2YgVVJMIHdyYXBwZWQgdHlwZXMuICBUaGlzCiAgICogaXMgcHVyZWx5IGFuIGltcGxlbWVudGF0aW9uIGRldGFpbHMuCiAgICoKICAgKiBUaGUgY29udHJhY3QgaXMgc2ltcGx5IHRoaXM6CiAgICoKICAgKiAgICAgZ2V0VHJ1c3RlZCgkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpIHN1Y2NlZWRpbmcgaW1wbGllcyB0aGF0IGdldFRydXN0ZWQoJHNjZS5VUkwsIHZhbHVlKQogICAqICAgICB3aWxsIGFsc28gc3VjY2VlZC4KICAgKgogICAqIEluaGVyaXRhbmNlIGhhcHBlbnMgdG8gY2FwdHVyZSB0aGlzIGluIGEgbmF0dXJhbCB3YXkuICBJbiBzb21lIGZ1dHVyZSwgd2UKICAgKiBtYXkgbm90IHVzZSBpbmhlcml0YW5jZSBhbnltb3JlLiAgVGhhdCBpcyBPSyBiZWNhdXNlIG5vIGNvZGUgb3V0c2lkZSBvZgogICAqIHNjZS5qcyBhbmQgc2NlU3BlY3MuanMgd291bGQgbmVlZCB0byBiZSBhd2FyZSBvZiB0aGlzIGRldGFpbC4KICAgKi8KCiAgdGhpcy4kZ2V0ID0gWyckZG9jdW1lbnQnLCAnJHBhcnNlJywgJyRzY2VEZWxlZ2F0ZScsIGZ1bmN0aW9uKAogICAgICAgICAgICAgICAgJGRvY3VtZW50LCAgICRwYXJzZSwgICAkc2NlRGVsZWdhdGUpIHsKICAgIC8vIFByZXJlcTogRW5zdXJlIHRoYXQgd2UncmUgbm90IHJ1bm5pbmcgaW4gSUU8MTEgcXVpcmtzIG1vZGUuICBJbiB0aGF0IG1vZGUsIElFIDwgMTEgYWxsb3cKICAgIC8vIHRoZSAiZXhwcmVzc2lvbihqYXZhc2NyaXB0IGV4cHJlc3Npb24pIiBzeW50YXggd2hpY2ggaXMgaW5zZWN1cmUuCiAgICBpZiAoZW5hYmxlZCAmJiAkZG9jdW1lbnRbMF0uZG9jdW1lbnRNb2RlIDwgOCkgewogICAgICB0aHJvdyAkc2NlTWluRXJyKCdpZXF1aXJrcycsCiAgICAgICAgJ1N0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIGRvZXMgbm90IHN1cHBvcnQgSW50ZXJuZXQgRXhwbG9yZXIgdmVyc2lvbiA8IDExIGluIHF1aXJrcyAnICsKICAgICAgICAnbW9kZS4gIFlvdSBjYW4gZml4IHRoaXMgYnkgYWRkaW5nIHRoZSB0ZXh0IDwhZG9jdHlwZSBodG1sPiB0byB0aGUgdG9wIG9mIHlvdXIgSFRNTCAnICsKICAgICAgICAnZG9jdW1lbnQuICBTZWUgaHR0cDovL2RvY3MuYW5ndWxhcmpzLm9yZy9hcGkvbmcuJHNjZSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4nKTsKICAgIH0KCiAgICB2YXIgc2NlID0gc2hhbGxvd0NvcHkoU0NFX0NPTlRFWFRTKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjaXNFbmFibGVkCiAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICoKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IHRydWUgaWYgU0NFIGlzIGVuYWJsZWQsIGZhbHNlIG90aGVyd2lzZS4gIElmIHlvdSB3YW50IHRvIHNldCB0aGUgdmFsdWUsIHlvdQogICAgICogaGF2ZSB0byBkbyBpdCBhdCBtb2R1bGUgY29uZmlnIHRpbWUgb24ge0BsaW5rIG5nLiRzY2VQcm92aWRlciAkc2NlUHJvdmlkZXJ9LgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJucyBhIGJvb2xlYW4gaW5kaWNhdGluZyBpZiBTQ0UgaXMgZW5hYmxlZC4KICAgICAqLwogICAgc2NlLmlzRW5hYmxlZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGVuYWJsZWQ7CiAgICB9OwogICAgc2NlLnRydXN0QXMgPSAkc2NlRGVsZWdhdGUudHJ1c3RBczsKICAgIHNjZS5nZXRUcnVzdGVkID0gJHNjZURlbGVnYXRlLmdldFRydXN0ZWQ7CiAgICBzY2UudmFsdWVPZiA9ICRzY2VEZWxlZ2F0ZS52YWx1ZU9mOwoKICAgIGlmICghZW5hYmxlZCkgewogICAgICBzY2UudHJ1c3RBcyA9IHNjZS5nZXRUcnVzdGVkID0gZnVuY3Rpb24odHlwZSwgdmFsdWUpIHsgcmV0dXJuIHZhbHVlOyB9OwogICAgICBzY2UudmFsdWVPZiA9IGlkZW50aXR5OwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNwYXJzZUFzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb252ZXJ0cyBBbmd1bGFyIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGludG8gYSBmdW5jdGlvbi4gIFRoaXMgaXMgbGlrZSB7QGxpbmsKICAgICAqIG5nLiRwYXJzZSAkcGFyc2V9IGFuZCBpcyBpZGVudGljYWwgd2hlbiB0aGUgZXhwcmVzc2lvbiBpcyBhIGxpdGVyYWwgY29uc3RhbnQuICBPdGhlcndpc2UsIGl0CiAgICAgKiB3cmFwcyB0aGUgZXhwcmVzc2lvbiBpbiBhIGNhbGwgdG8ge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWQoKnR5cGUqLAogICAgICogKnJlc3VsdCopfQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIFRoZSBraW5kIG9mIFNDRSBjb250ZXh0IGluIHdoaWNoIHRoaXMgcmVzdWx0IHdpbGwgYmUgdXNlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICoKICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICogICAgICBgY29udGV4dGAuCiAgICAgKi8KICAgIHNjZS5wYXJzZUFzID0gZnVuY3Rpb24gc2NlUGFyc2VBcyh0eXBlLCBleHByKSB7CiAgICAgIHZhciBwYXJzZWQgPSAkcGFyc2UoZXhwcik7CiAgICAgIGlmIChwYXJzZWQubGl0ZXJhbCAmJiBwYXJzZWQuY29uc3RhbnQpIHsKICAgICAgICByZXR1cm4gcGFyc2VkOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAkcGFyc2UoZXhwciwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gc2NlLmdldFRydXN0ZWQodHlwZSwgdmFsdWUpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSN0cnVzdEFzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZWxlZ2F0ZXMgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9LiAgQXMgc3VjaCwKICAgICAqIHJldHVybnMgYW4gb2JqZWN0IHRoYXQgaXMgdHJ1c3RlZCBieSBhbmd1bGFyIGZvciB1c2UgaW4gc3BlY2lmaWVkIHN0cmljdCBjb250ZXh0dWFsCiAgICAgKiBlc2NhcGluZyBjb250ZXh0cyAoc3VjaCBhcyBuZy1iaW5kLWh0bWwsIG5nLWluY2x1ZGUsIGFueSBzcmMgYXR0cmlidXRlCiAgICAgKiBpbnRlcnBvbGF0aW9uLCBhbnkgZG9tIGV2ZW50IGJpbmRpbmcgYXR0cmlidXRlIGludGVycG9sYXRpb24gc3VjaCBhcyBmb3Igb25jbGljaywgIGV0Yy4pCiAgICAgKiB0aGF0IHVzZXMgdGhlIHByb3ZpZGVkIHZhbHVlLiAgU2VlICoge0BsaW5rIG5nLiRzY2UgJHNjZX0gZm9yIGVuYWJsaW5nIHN0cmljdCBjb250ZXh0dWFsCiAgICAgKiBlc2NhcGluZy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgc2FmZSBmb3IgdXNlLiAgZS5nLiB1cmwsCiAgICAgKiAgIHJlc291cmNlX3VybCwgaHRtbCwganMgYW5kIGNzcy4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRoYXQgdGhhdCBzaG91bGQgYmUgY29uc2lkZXJlZCB0cnVzdGVkL3NhZmUuCiAgICAgKiBAcmV0dXJucyB7Kn0gQSB2YWx1ZSB0aGF0IGNhbiBiZSB1c2VkIHRvIHN0YW5kIGluIGZvciB0aGUgcHJvdmlkZWQgYHZhbHVlYCBpbiBwbGFjZXMKICAgICAqIHdoZXJlIEFuZ3VsYXIgZXhwZWN0cyBhICRzY2UudHJ1c3RBcygpIHJldHVybiB2YWx1ZS4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSN0cnVzdEFzSHRtbAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnRydXN0QXNIdG1sKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLkhUTUwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gdHJ1c3RBcy4KICAgICAqIEByZXR1cm5zIHsqfSBBbiBvYmplY3QgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRIdG1sCiAgICAgKiAgICAgJHNjZS5nZXRUcnVzdGVkSHRtbCh2YWx1ZSl9IHRvIG9idGFpbiB0aGUgb3JpZ2luYWwgdmFsdWUuICAocHJpdmlsZWdlZCBkaXJlY3RpdmVzCiAgICAgKiAgICAgb25seSBhY2NlcHQgZXhwcmVzc2lvbnMgdGhhdCBhcmUgZWl0aGVyIGxpdGVyYWwgY29uc3RhbnRzIG9yIGFyZSB0aGUKICAgICAqICAgICByZXR1cm4gdmFsdWUgb2Yge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyAkc2NlLnRydXN0QXN9LikKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSN0cnVzdEFzVXJsCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UudHJ1c3RBc1VybCh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5VUkwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gdHJ1c3RBcy4KICAgICAqIEByZXR1cm5zIHsqfSBBbiBvYmplY3QgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRVcmwKICAgICAqICAgICAkc2NlLmdldFRydXN0ZWRVcmwodmFsdWUpfSB0byBvYnRhaW4gdGhlIG9yaWdpbmFsIHZhbHVlLiAgKHByaXZpbGVnZWQgZGlyZWN0aXZlcwogICAgICogICAgIG9ubHkgYWNjZXB0IGV4cHJlc3Npb25zIHRoYXQgYXJlIGVpdGhlciBsaXRlcmFsIGNvbnN0YW50cyBvciBhcmUgdGhlCiAgICAgKiAgICAgcmV0dXJuIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBc1Jlc291cmNlVXJsCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UudHJ1c3RBc1Jlc291cmNlVXJsKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB0cnVzdEFzLgogICAgICogQHJldHVybnMgeyp9IEFuIG9iamVjdCB0aGF0IGNhbiBiZSBwYXNzZWQgdG8ge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAgICAgKiAgICAgJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmwodmFsdWUpfSB0byBvYnRhaW4gdGhlIG9yaWdpbmFsIHZhbHVlLiAgKHByaXZpbGVnZWQgZGlyZWN0aXZlcwogICAgICogICAgIG9ubHkgYWNjZXB0IGV4cHJlc3Npb25zIHRoYXQgYXJlIGVpdGhlciBsaXRlcmFsIGNvbnN0YW50cyBvciBhcmUgdGhlIHJldHVybgogICAgICogICAgIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBc0pzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UudHJ1c3RBc0pzKHZhbHVlKWAg4oaSCiAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLkpTLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHRydXN0QXMuCiAgICAgKiBAcmV0dXJucyB7Kn0gQW4gb2JqZWN0IHRoYXQgY2FuIGJlIHBhc3NlZCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkSnMKICAgICAqICAgICAkc2NlLmdldFRydXN0ZWRKcyh2YWx1ZSl9IHRvIG9idGFpbiB0aGUgb3JpZ2luYWwgdmFsdWUuICAocHJpdmlsZWdlZCBkaXJlY3RpdmVzCiAgICAgKiAgICAgb25seSBhY2NlcHQgZXhwcmVzc2lvbnMgdGhhdCBhcmUgZWl0aGVyIGxpdGVyYWwgY29uc3RhbnRzIG9yIGFyZSB0aGUKICAgICAqICAgICByZXR1cm4gdmFsdWUgb2Yge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyAkc2NlLnRydXN0QXN9LikKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZWxlZ2F0ZXMgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZGB9LiAgQXMgc3VjaCwKICAgICAqIHRha2VzIHRoZSByZXN1bHQgb2YgYSB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzIGAkc2NlLnRydXN0QXNgfSgpIGNhbGwgYW5kIHJldHVybnMgdGhlCiAgICAgKiBvcmlnaW5hbGx5IHN1cHBsaWVkIHZhbHVlIGlmIHRoZSBxdWVyaWVkIGNvbnRleHQgdHlwZSBpcyBhIHN1cGVydHlwZSBvZiB0aGUgY3JlYXRlZCB0eXBlLgogICAgICogSWYgdGhpcyBjb25kaXRpb24gaXNuJ3Qgc2F0aXNmaWVkLCB0aHJvd3MgYW4gZXhjZXB0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIFRoZSBraW5kIG9mIGNvbnRleHQgaW4gd2hpY2ggdGhpcyB2YWx1ZSBpcyB0byBiZSB1c2VkLgogICAgICogQHBhcmFtIHsqfSBtYXliZVRydXN0ZWQgVGhlIHJlc3VsdCBvZiBhIHByaW9yIHtAbGluayBuZy4kc2NlI3RydXN0QXMgYCRzY2UudHJ1c3RBc2B9CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsLgogICAgICogQHJldHVybnMgeyp9IFRoZSB2YWx1ZSB0aGUgd2FzIG9yaWdpbmFsbHkgcHJvdmlkZWQgdG8KICAgICAqICAgICAgICAgICAgICB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzIGAkc2NlLnRydXN0QXNgfSBpZiB2YWxpZCBpbiB0aGlzIGNvbnRleHQuCiAgICAgKiAgICAgICAgICAgICAgT3RoZXJ3aXNlLCB0aHJvd3MgYW4gZXhjZXB0aW9uLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI2dldFRydXN0ZWRIdG1sCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZEh0bWwodmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkKCRzY2UuSFRNTCwgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBwYXNzIHRvIGAkc2NlLmdldFRydXN0ZWRgLgogICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLkhUTUwsIHZhbHVlKWAKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkQ3NzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZENzcyh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWQoJHNjZS5DU1MsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkc2NlLmdldFRydXN0ZWQoJHNjZS5DU1MsIHZhbHVlKWAKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkVXJsCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZFVybCh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWQoJHNjZS5VUkwsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkc2NlLmdldFRydXN0ZWQoJHNjZS5VUkwsIHZhbHVlKWAKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkUmVzb3VyY2VVcmwKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmwodmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkKCRzY2UuUkVTT1VSQ0VfVVJMLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHBhc3MgdG8gYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkc2NlLmdldFRydXN0ZWQoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKWAKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkSnMKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5nZXRUcnVzdGVkSnModmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkKCRzY2UuSlMsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkc2NlLmdldFRydXN0ZWQoJHNjZS5KUywgdmFsdWUpYAogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI3BhcnNlQXNIdG1sCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UucGFyc2VBc0h0bWwoZXhwcmVzc2lvbiBzdHJpbmcpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZSNwYXJzZUFzIGAkc2NlLnBhcnNlQXMoJHNjZS5IVE1MLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICoKICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICogICAgICBgY29udGV4dGAuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2UjcGFyc2VBc0NzcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNDc3ModmFsdWUpYCDihpIKICAgICAqICAgICB7QGxpbmsgbmcuJHNjZSNwYXJzZUFzIGAkc2NlLnBhcnNlQXMoJHNjZS5DU1MsIHZhbHVlKWB9CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZSNwYXJzZUFzVXJsCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UucGFyc2VBc1VybCh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlI3BhcnNlQXMgYCRzY2UucGFyc2VBcygkc2NlLlVSTCwgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAqCiAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI3BhcnNlQXNSZXNvdXJjZVVybAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNSZXNvdXJjZVVybCh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlI3BhcnNlQXMgYCRzY2UucGFyc2VBcygkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpYH0KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAqCiAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlI3BhcnNlQXNKcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNKcyh2YWx1ZSlgIOKGkgogICAgICogICAgIHtAbGluayBuZy4kc2NlI3BhcnNlQXMgYCRzY2UucGFyc2VBcygkc2NlLkpTLCB2YWx1ZSlgfQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICoKICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICogICAgICBgY29udGV4dGAuCiAgICAgKi8KCiAgICAvLyBTaG9ydGhhbmQgZGVsZWdhdGlvbnMuCiAgICB2YXIgcGFyc2UgPSBzY2UucGFyc2VBcywKICAgICAgICBnZXRUcnVzdGVkID0gc2NlLmdldFRydXN0ZWQsCiAgICAgICAgdHJ1c3RBcyA9IHNjZS50cnVzdEFzOwoKICAgIGZvckVhY2goU0NFX0NPTlRFWFRTLCBmdW5jdGlvbiAoZW51bVZhbHVlLCBuYW1lKSB7CiAgICAgIHZhciBsTmFtZSA9IGxvd2VyY2FzZShuYW1lKTsKICAgICAgc2NlW2NhbWVsQ2FzZSgicGFyc2VfYXNfIiArIGxOYW1lKV0gPSBmdW5jdGlvbiAoZXhwcikgewogICAgICAgIHJldHVybiBwYXJzZShlbnVtVmFsdWUsIGV4cHIpOwogICAgICB9OwogICAgICBzY2VbY2FtZWxDYXNlKCJnZXRfdHJ1c3RlZF8iICsgbE5hbWUpXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHJldHVybiBnZXRUcnVzdGVkKGVudW1WYWx1ZSwgdmFsdWUpOwogICAgICB9OwogICAgICBzY2VbY2FtZWxDYXNlKCJ0cnVzdF9hc18iICsgbE5hbWUpXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHJldHVybiB0cnVzdEFzKGVudW1WYWx1ZSwgdmFsdWUpOwogICAgICB9OwogICAgfSk7CgogICAgcmV0dXJuIHNjZTsKICB9XTsKfQoKLyoqCiAqICEhISBUaGlzIGlzIGFuIHVuZG9jdW1lbnRlZCAicHJpdmF0ZSIgc2VydmljZSAhISEKICoKICogQG5hbWUgJHNuaWZmZXIKICogQHJlcXVpcmVzICR3aW5kb3cKICogQHJlcXVpcmVzICRkb2N1bWVudAogKgogKiBAcHJvcGVydHkge2Jvb2xlYW59IGhpc3RvcnkgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IGh0bWw1IGhpc3RvcnkgYXBpID8KICogQHByb3BlcnR5IHtib29sZWFufSB0cmFuc2l0aW9ucyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgQ1NTIHRyYW5zaXRpb24gZXZlbnRzID8KICogQHByb3BlcnR5IHtib29sZWFufSBhbmltYXRpb25zIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCBDU1MgYW5pbWF0aW9uIGV2ZW50cyA/CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGlzIHZlcnkgc2ltcGxlIGltcGxlbWVudGF0aW9uIG9mIHRlc3RpbmcgYnJvd3NlcidzIGZlYXR1cmVzLgogKi8KZnVuY3Rpb24gJFNuaWZmZXJQcm92aWRlcigpIHsKICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50KSB7CiAgICB2YXIgZXZlbnRTdXBwb3J0ID0ge30sCiAgICAgICAgYW5kcm9pZCA9CiAgICAgICAgICBpbnQoKC9hbmRyb2lkIChcZCspLy5leGVjKGxvd2VyY2FzZSgoJHdpbmRvdy5uYXZpZ2F0b3IgfHwge30pLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSksCiAgICAgICAgYm94ZWUgPSAvQm94ZWUvaS50ZXN0KCgkd2luZG93Lm5hdmlnYXRvciB8fCB7fSkudXNlckFnZW50KSwKICAgICAgICBkb2N1bWVudCA9ICRkb2N1bWVudFswXSB8fCB7fSwKICAgICAgICB2ZW5kb3JQcmVmaXgsCiAgICAgICAgdmVuZG9yUmVnZXggPSAvXihNb3p8d2Via2l0fE98bXMpKD89W0EtWl0pLywKICAgICAgICBib2R5U3R5bGUgPSBkb2N1bWVudC5ib2R5ICYmIGRvY3VtZW50LmJvZHkuc3R5bGUsCiAgICAgICAgdHJhbnNpdGlvbnMgPSBmYWxzZSwKICAgICAgICBhbmltYXRpb25zID0gZmFsc2UsCiAgICAgICAgbWF0Y2g7CgogICAgaWYgKGJvZHlTdHlsZSkgewogICAgICBmb3IodmFyIHByb3AgaW4gYm9keVN0eWxlKSB7CiAgICAgICAgaWYobWF0Y2ggPSB2ZW5kb3JSZWdleC5leGVjKHByb3ApKSB7CiAgICAgICAgICB2ZW5kb3JQcmVmaXggPSBtYXRjaFswXTsKICAgICAgICAgIHZlbmRvclByZWZpeCA9IHZlbmRvclByZWZpeC5zdWJzdHIoMCwgMSkudG9VcHBlckNhc2UoKSArIHZlbmRvclByZWZpeC5zdWJzdHIoMSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmKCF2ZW5kb3JQcmVmaXgpIHsKICAgICAgICB2ZW5kb3JQcmVmaXggPSAoJ1dlYmtpdE9wYWNpdHknIGluIGJvZHlTdHlsZSkgJiYgJ3dlYmtpdCc7CiAgICAgIH0KCiAgICAgIHRyYW5zaXRpb25zID0gISEoKCd0cmFuc2l0aW9uJyBpbiBib2R5U3R5bGUpIHx8ICh2ZW5kb3JQcmVmaXggKyAnVHJhbnNpdGlvbicgaW4gYm9keVN0eWxlKSk7CiAgICAgIGFuaW1hdGlvbnMgID0gISEoKCdhbmltYXRpb24nIGluIGJvZHlTdHlsZSkgfHwgKHZlbmRvclByZWZpeCArICdBbmltYXRpb24nIGluIGJvZHlTdHlsZSkpOwoKICAgICAgaWYgKGFuZHJvaWQgJiYgKCF0cmFuc2l0aW9uc3x8IWFuaW1hdGlvbnMpKSB7CiAgICAgICAgdHJhbnNpdGlvbnMgPSBpc1N0cmluZyhkb2N1bWVudC5ib2R5LnN0eWxlLndlYmtpdFRyYW5zaXRpb24pOwogICAgICAgIGFuaW1hdGlvbnMgPSBpc1N0cmluZyhkb2N1bWVudC5ib2R5LnN0eWxlLndlYmtpdEFuaW1hdGlvbik7CiAgICAgIH0KICAgIH0KCgogICAgcmV0dXJuIHsKICAgICAgLy8gQW5kcm9pZCBoYXMgaGlzdG9yeS5wdXNoU3RhdGUsIGJ1dCBpdCBkb2VzIG5vdCB1cGRhdGUgbG9jYXRpb24gY29ycmVjdGx5CiAgICAgIC8vIHNvIGxldCdzIG5vdCB1c2UgdGhlIGhpc3RvcnkgQVBJIGF0IGFsbC4KICAgICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL2FuZHJvaWQvaXNzdWVzL2RldGFpbD9pZD0xNzQ3MQogICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy85MDQKCiAgICAgIC8vIG9sZGVyIHdlYmtpdCBicm93c2VyICg1MzMuOSkgb24gQm94ZWUgYm94IGhhcyBleGFjdGx5IHRoZSBzYW1lIHByb2JsZW0gYXMgQW5kcm9pZCBoYXMKICAgICAgLy8gc28gbGV0J3Mgbm90IHVzZSB0aGUgaGlzdG9yeSBBUEkgYWxzbwogICAgICAvLyBXZSBhcmUgcHVycG9zZWZ1bGx5IHVzaW5nIGAhKGFuZHJvaWQgPCA0KWAgdG8gY292ZXIgdGhlIGNhc2Ugd2hlbiBgYW5kcm9pZGAgaXMgdW5kZWZpbmVkCiAgICAgIC8vIGpzaGludCAtVzAxOAogICAgICBoaXN0b3J5OiAhISgkd2luZG93Lmhpc3RvcnkgJiYgJHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZSAmJiAhKGFuZHJvaWQgPCA0KSAmJiAhYm94ZWUpLAogICAgICAvLyBqc2hpbnQgK1cwMTgKICAgICAgaGFzRXZlbnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgLy8gSUU5IGltcGxlbWVudHMgJ2lucHV0JyBldmVudCBpdCdzIHNvIGZ1YmFyZWQgdGhhdCB3ZSByYXRoZXIgcHJldGVuZCB0aGF0IGl0IGRvZXNuJ3QgaGF2ZQogICAgICAgIC8vIGl0LiBJbiBwYXJ0aWN1bGFyIHRoZSBldmVudCBpcyBub3QgZmlyZWQgd2hlbiBiYWNrc3BhY2Ugb3IgZGVsZXRlIGtleSBhcmUgcHJlc3NlZCBvcgogICAgICAgIC8vIHdoZW4gY3V0IG9wZXJhdGlvbiBpcyBwZXJmb3JtZWQuCiAgICAgICAgaWYgKGV2ZW50ID09ICdpbnB1dCcgJiYgbXNpZSA9PSA5KSByZXR1cm4gZmFsc2U7CgogICAgICAgIGlmIChpc1VuZGVmaW5lZChldmVudFN1cHBvcnRbZXZlbnRdKSkgewogICAgICAgICAgdmFyIGRpdkVsbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgZXZlbnRTdXBwb3J0W2V2ZW50XSA9ICdvbicgKyBldmVudCBpbiBkaXZFbG07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZXZlbnRTdXBwb3J0W2V2ZW50XTsKICAgICAgfSwKICAgICAgY3NwOiBjc3AoKSwKICAgICAgdmVuZG9yUHJlZml4OiB2ZW5kb3JQcmVmaXgsCiAgICAgIHRyYW5zaXRpb25zIDogdHJhbnNpdGlvbnMsCiAgICAgIGFuaW1hdGlvbnMgOiBhbmltYXRpb25zLAogICAgICBhbmRyb2lkOiBhbmRyb2lkCiAgICB9OwogIH1dOwp9Cgp2YXIgJGNvbXBpbGVNaW5FcnIgPSBtaW5FcnIoJyRjb21waWxlJyk7CgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJHRlbXBsYXRlUmVxdWVzdAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGAkdGVtcGxhdGVSZXF1ZXN0YCBzZXJ2aWNlIGRvd25sb2FkcyB0aGUgcHJvdmlkZWQgdGVtcGxhdGUgdXNpbmcgYCRodHRwYCBhbmQsIHVwb24gc3VjY2VzcywKICogc3RvcmVzIHRoZSBjb250ZW50cyBpbnNpZGUgb2YgYCR0ZW1wbGF0ZUNhY2hlYC4gSWYgdGhlIEhUVFAgcmVxdWVzdCBmYWlscyBvciB0aGUgcmVzcG9uc2UgZGF0YQogKiBvZiB0aGUgSFRUUCByZXF1ZXN0IGlzIGVtcHR5IHRoZW4gYSBgJGNvbXBpbGVgIGVycm9yIHdpbGwgYmUgdGhyb3duICh0aGUgZXhjZXB0aW9uIGNhbiBiZSB0aHdhcnRlZAogKiBieSBzZXR0aW5nIHRoZSAybmQgcGFyYW1ldGVyIG9mIHRoZSBmdW5jdGlvbiB0byB0cnVlKS4KICoKICogQHBhcmFtIHtzdHJpbmd9IHRwbCBUaGUgSFRUUCByZXF1ZXN0IHRlbXBsYXRlIFVSTAogKiBAcGFyYW0ge2Jvb2xlYW49fSBpZ25vcmVSZXF1ZXN0RXJyb3IgV2hldGhlciBvciBub3QgdG8gaWdub3JlIHRoZSBleGNlcHRpb24gd2hlbiB0aGUgcmVxdWVzdCBmYWlscyBvciB0aGUgdGVtcGxhdGUgaXMgZW1wdHkKICoKICogQHJldHVybiB7UHJvbWlzZX0gdGhlIEhUVFAgUHJvbWlzZSBmb3IgdGhlIGdpdmVuLgogKgogKiBAcHJvcGVydHkge251bWJlcn0gdG90YWxQZW5kaW5nUmVxdWVzdHMgdG90YWwgYW1vdW50IG9mIHBlbmRpbmcgdGVtcGxhdGUgcmVxdWVzdHMgYmVpbmcgZG93bmxvYWRlZC4KICovCmZ1bmN0aW9uICRUZW1wbGF0ZVJlcXVlc3RQcm92aWRlcigpIHsKICB0aGlzLiRnZXQgPSBbJyR0ZW1wbGF0ZUNhY2hlJywgJyRodHRwJywgJyRxJywgZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUsICRodHRwLCAkcSkgewogICAgZnVuY3Rpb24gaGFuZGxlUmVxdWVzdEZuKHRwbCwgaWdub3JlUmVxdWVzdEVycm9yKSB7CiAgICAgIHZhciBzZWxmID0gaGFuZGxlUmVxdWVzdEZuOwogICAgICBzZWxmLnRvdGFsUGVuZGluZ1JlcXVlc3RzKys7CgogICAgICByZXR1cm4gJGh0dHAuZ2V0KHRwbCwgeyBjYWNoZSA6ICR0ZW1wbGF0ZUNhY2hlIH0pCiAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgIHZhciBodG1sID0gcmVzcG9uc2UuZGF0YTsKICAgICAgICAgIGlmKCFodG1sIHx8IGh0bWwubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBoYW5kbGVFcnJvcigpOwogICAgICAgICAgfQoKICAgICAgICAgIHNlbGYudG90YWxQZW5kaW5nUmVxdWVzdHMtLTsKICAgICAgICAgICR0ZW1wbGF0ZUNhY2hlLnB1dCh0cGwsIGh0bWwpOwogICAgICAgICAgcmV0dXJuIGh0bWw7CiAgICAgICAgfSwgaGFuZGxlRXJyb3IpOwoKICAgICAgZnVuY3Rpb24gaGFuZGxlRXJyb3IoKSB7CiAgICAgICAgc2VsZi50b3RhbFBlbmRpbmdSZXF1ZXN0cy0tOwogICAgICAgIGlmICghaWdub3JlUmVxdWVzdEVycm9yKSB7CiAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycigndHBsb2FkJywgJ0ZhaWxlZCB0byBsb2FkIHRlbXBsYXRlOiB7MH0nLCB0cGwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJHEucmVqZWN0KCk7CiAgICAgIH0KICAgIH0KCiAgICBoYW5kbGVSZXF1ZXN0Rm4udG90YWxQZW5kaW5nUmVxdWVzdHMgPSAwOwoKICAgIHJldHVybiBoYW5kbGVSZXF1ZXN0Rm47CiAgfV07Cn0KCmZ1bmN0aW9uICQkVGVzdGFiaWxpdHlQcm92aWRlcigpIHsKICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJGxvY2F0aW9uJywKICAgICAgIGZ1bmN0aW9uKCRyb290U2NvcGUsICAgJGJyb3dzZXIsICAgJGxvY2F0aW9uKSB7CgogICAgLyoqCiAgICAgKiBAbmFtZSAkdGVzdGFiaWxpdHkKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBwcml2YXRlICQkdGVzdGFiaWxpdHkgc2VydmljZSBwcm92aWRlcyBhIGNvbGxlY3Rpb24gb2YgbWV0aG9kcyBmb3IgdXNlIHdoZW4gZGVidWdnaW5nCiAgICAgKiBvciBieSBhdXRvbWF0ZWQgdGVzdCBhbmQgZGVidWdnaW5nIHRvb2xzLgogICAgICovCiAgICB2YXIgdGVzdGFiaWxpdHkgPSB7fTsKCiAgICAvKioKICAgICAqIEBuYW1lICQkdGVzdGFiaWxpdHkjZmluZEJpbmRpbmdzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGFuIGFycmF5IG9mIGVsZW1lbnRzIHRoYXQgYXJlIGJvdW5kICh2aWEgbmctYmluZCBvciB7e319KQogICAgICogdG8gZXhwcmVzc2lvbnMgbWF0Y2hpbmcgdGhlIGlucHV0LgogICAgICoKICAgICAqIEBwYXJhbSB7RWxlbWVudH0gZWxlbWVudCBUaGUgZWxlbWVudCByb290IHRvIHNlYXJjaCBmcm9tLgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gVGhlIGJpbmRpbmcgZXhwcmVzc2lvbiB0byBtYXRjaC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3B0X2V4YWN0TWF0Y2ggSWYgdHJ1ZSwgb25seSByZXR1cm5zIGV4YWN0IG1hdGNoZXMKICAgICAqICAgICBmb3IgdGhlIGV4cHJlc3Npb24uIEZpbHRlcnMgYW5kIHdoaXRlc3BhY2UgYXJlIGlnbm9yZWQuCiAgICAgKi8KICAgIHRlc3RhYmlsaXR5LmZpbmRCaW5kaW5ncyA9IGZ1bmN0aW9uKGVsZW1lbnQsIGV4cHJlc3Npb24sIG9wdF9leGFjdE1hdGNoKSB7CiAgICAgIHZhciBiaW5kaW5ncyA9IGVsZW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnbmctYmluZGluZycpOwogICAgICB2YXIgbWF0Y2hlcyA9IFtdOwogICAgICBmb3JFYWNoKGJpbmRpbmdzLCBmdW5jdGlvbihiaW5kaW5nKSB7CiAgICAgICAgdmFyIGRhdGFCaW5kaW5nID0gYW5ndWxhci5lbGVtZW50KGJpbmRpbmcpLmRhdGEoJyRiaW5kaW5nJyk7CiAgICAgICAgaWYgKGRhdGFCaW5kaW5nKSB7CiAgICAgICAgICBmb3JFYWNoKGRhdGFCaW5kaW5nLCBmdW5jdGlvbihiaW5kaW5nTmFtZSkgewogICAgICAgICAgICBpZiAob3B0X2V4YWN0TWF0Y2gpIHsKICAgICAgICAgICAgICB2YXIgbWF0Y2hlciA9IG5ldyBSZWdFeHAoJyhefFxccyknICsgZXhwcmVzc2lvbiArICcoXFxzfFxcfHwkKScpOwogICAgICAgICAgICAgIGlmIChtYXRjaGVyLnRlc3QoYmluZGluZ05hbWUpKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVzLnB1c2goYmluZGluZyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChiaW5kaW5nTmFtZS5pbmRleE9mKGV4cHJlc3Npb24pICE9IC0xKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVzLnB1c2goYmluZGluZyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gbWF0Y2hlczsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSAkJHRlc3RhYmlsaXR5I2ZpbmRNb2RlbHMKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJldHVybnMgYW4gYXJyYXkgb2YgZWxlbWVudHMgdGhhdCBhcmUgdHdvLXdheSBmb3VuZCB2aWEgbmctbW9kZWwgdG8KICAgICAqIGV4cHJlc3Npb25zIG1hdGNoaW5nIHRoZSBpbnB1dC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgVGhlIGVsZW1lbnQgcm9vdCB0byBzZWFyY2ggZnJvbS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFRoZSBtb2RlbCBleHByZXNzaW9uIHRvIG1hdGNoLgogICAgICogQHBhcmFtIHtib29sZWFufSBvcHRfZXhhY3RNYXRjaCBJZiB0cnVlLCBvbmx5IHJldHVybnMgZXhhY3QgbWF0Y2hlcwogICAgICogICAgIGZvciB0aGUgZXhwcmVzc2lvbi4KICAgICAqLwogICAgdGVzdGFiaWxpdHkuZmluZE1vZGVscyA9IGZ1bmN0aW9uKGVsZW1lbnQsIGV4cHJlc3Npb24sIG9wdF9leGFjdE1hdGNoKSB7CiAgICAgIHZhciBwcmVmaXhlcyA9IFsnbmctJywgJ2RhdGEtbmctJywgJ25nXFw6J107CiAgICAgIGZvciAodmFyIHAgPSAwOyBwIDwgcHJlZml4ZXMubGVuZ3RoOyArK3ApIHsKICAgICAgICB2YXIgYXR0cmlidXRlRXF1YWxzID0gb3B0X2V4YWN0TWF0Y2ggPyAnPScgOiAnKj0nOwogICAgICAgIHZhciBzZWxlY3RvciA9ICdbJyArIHByZWZpeGVzW3BdICsgJ21vZGVsJyArIGF0dHJpYnV0ZUVxdWFscyArICciJyArIGV4cHJlc3Npb24gKyAnIl0nOwogICAgICAgIHZhciBlbGVtZW50cyA9IGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICAgICAgaWYgKGVsZW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIGVsZW1lbnRzOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lICQkdGVzdGFiaWxpdHkjZ2V0TG9jYXRpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IGZvciBnZXR0aW5nIHRoZSBsb2NhdGlvbiBpbiBhIGJyb3dzZXIgYWdub3N0aWMgd2F5LiBSZXR1cm5zCiAgICAgKiAgICAgdGhlIHBhdGgsIHNlYXJjaCwgYW5kIGhhc2guIChlLmcuIC9wYXRoP2E9YiNoYXNoKQogICAgICovCiAgICB0ZXN0YWJpbGl0eS5nZXRMb2NhdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gJGxvY2F0aW9uLnVybCgpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lICQkdGVzdGFiaWxpdHkjc2V0TG9jYXRpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNob3J0Y3V0IGZvciBuYXZpZ2F0aW5nIHRvIGEgbG9jYXRpb24gd2l0aG91dCBkb2luZyBhIGZ1bGwgcGFnZSByZWxvYWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgbG9jYXRpb24gdXJsIChwYXRoLCBzZWFyY2ggYW5kIGhhc2gsCiAgICAgKiAgICAgZS5nLiAvcGF0aD9hPWIjaGFzaCkgdG8gZ28gdG8uCiAgICAgKi8KICAgIHRlc3RhYmlsaXR5LnNldExvY2F0aW9uID0gZnVuY3Rpb24odXJsKSB7CiAgICAgIGlmICh1cmwgIT09ICRsb2NhdGlvbi51cmwoKSkgewogICAgICAgICRsb2NhdGlvbi51cmwodXJsKTsKICAgICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lICQkdGVzdGFiaWxpdHkjd2hlblN0YWJsZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ2FsbHMgdGhlIGNhbGxiYWNrIHdoZW4gJHRpbWVvdXQgYW5kICRodHRwIHJlcXVlc3RzIGFyZSBjb21wbGV0ZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sKICAgICAqLwogICAgdGVzdGFiaWxpdHkud2hlblN0YWJsZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICRicm93c2VyLm5vdGlmeVdoZW5Ob091dHN0YW5kaW5nUmVxdWVzdHMoY2FsbGJhY2spOwogICAgfTsKCiAgICByZXR1cm4gdGVzdGFiaWxpdHk7CiAgfV07Cn0KCmZ1bmN0aW9uICRUaW1lb3V0UHJvdmlkZXIoKSB7CiAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRicm93c2VyJywgJyRxJywgJyQkcScsICckZXhjZXB0aW9uSGFuZGxlcicsCiAgICAgICBmdW5jdGlvbigkcm9vdFNjb3BlLCAgICRicm93c2VyLCAgICRxLCAgICQkcSwgICAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgdmFyIGRlZmVycmVkcyA9IHt9OwoKCiAgICAgLyoqCiAgICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAgKiBAbmFtZSAkdGltZW91dAogICAgICAqCiAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICogQW5ndWxhcidzIHdyYXBwZXIgZm9yIGB3aW5kb3cuc2V0VGltZW91dGAuIFRoZSBgZm5gIGZ1bmN0aW9uIGlzIHdyYXBwZWQgaW50byBhIHRyeS9jYXRjaAogICAgICAqIGJsb2NrIGFuZCBkZWxlZ2F0ZXMgYW55IGV4Y2VwdGlvbnMgdG8KICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICoKICAgICAgKiBUaGUgcmV0dXJuIHZhbHVlIG9mIHJlZ2lzdGVyaW5nIGEgdGltZW91dCBmdW5jdGlvbiBpcyBhIHByb21pc2UsIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgd2hlbgogICAgICAqIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQgYW5kIHRoZSB0aW1lb3V0IGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogICAgICAqCiAgICAgICogVG8gY2FuY2VsIGEgdGltZW91dCByZXF1ZXN0LCBjYWxsIGAkdGltZW91dC5jYW5jZWwocHJvbWlzZSlgLgogICAgICAqCiAgICAgICogSW4gdGVzdHMgeW91IGNhbiB1c2Uge0BsaW5rIG5nTW9jay4kdGltZW91dCBgJHRpbWVvdXQuZmx1c2goKWB9IHRvCiAgICAgICogc3luY2hyb25vdXNseSBmbHVzaCB0aGUgcXVldWUgb2YgZGVmZXJyZWQgZnVuY3Rpb25zLgogICAgICAqCiAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBBIGZ1bmN0aW9uLCB3aG9zZSBleGVjdXRpb24gc2hvdWxkIGJlIGRlbGF5ZWQuCiAgICAgICogQHBhcmFtIHtudW1iZXI9fSBbZGVsYXk9MF0gRGVsYXkgaW4gbWlsbGlzZWNvbmRzLgogICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtpbnZva2VBcHBseT10cnVlXSBJZiBzZXQgdG8gYGZhbHNlYCBza2lwcyBtb2RlbCBkaXJ0eSBjaGVja2luZywgb3RoZXJ3aXNlCiAgICAgICogICB3aWxsIGludm9rZSBgZm5gIHdpdGhpbiB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseX0gYmxvY2suCiAgICAgICogQHJldHVybnMge1Byb21pc2V9IFByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdoZW4gdGhlIHRpbWVvdXQgaXMgcmVhY2hlZC4gVGhlIHZhbHVlIHRoaXMKICAgICAgKiAgIHByb21pc2Ugd2lsbCBiZSByZXNvbHZlZCB3aXRoIGlzIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGBmbmAgZnVuY3Rpb24uCiAgICAgICoKICAgICAgKi8KICAgIGZ1bmN0aW9uIHRpbWVvdXQoZm4sIGRlbGF5LCBpbnZva2VBcHBseSkgewogICAgICB2YXIgc2tpcEFwcGx5ID0gKGlzRGVmaW5lZChpbnZva2VBcHBseSkgJiYgIWludm9rZUFwcGx5KSwKICAgICAgICAgIGRlZmVycmVkID0gKHNraXBBcHBseSA/ICQkcSA6ICRxKS5kZWZlcigpLAogICAgICAgICAgcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2UsCiAgICAgICAgICB0aW1lb3V0SWQ7CgogICAgICB0aW1lb3V0SWQgPSAkYnJvd3Nlci5kZWZlcihmdW5jdGlvbigpIHsKICAgICAgICB0cnkgewogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShmbigpKTsKICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTsKICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgIH0KICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgIGRlbGV0ZSBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF07CiAgICAgICAgfQoKICAgICAgICBpZiAoIXNraXBBcHBseSkgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgfSwgZGVsYXkpOwoKICAgICAgcHJvbWlzZS4kJHRpbWVvdXRJZCA9IHRpbWVvdXRJZDsKICAgICAgZGVmZXJyZWRzW3RpbWVvdXRJZF0gPSBkZWZlcnJlZDsKCiAgICAgIHJldHVybiBwcm9taXNlOwogICAgfQoKCiAgICAgLyoqCiAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAqIEBuYW1lICR0aW1lb3V0I2NhbmNlbAogICAgICAqCiAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICogQ2FuY2VscyBhIHRhc2sgYXNzb2NpYXRlZCB3aXRoIHRoZSBgcHJvbWlzZWAuIEFzIGEgcmVzdWx0IG9mIHRoaXMsIHRoZSBwcm9taXNlIHdpbGwgYmUKICAgICAgKiByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLgogICAgICAqCiAgICAgICogQHBhcmFtIHtQcm9taXNlPX0gcHJvbWlzZSBQcm9taXNlIHJldHVybmVkIGJ5IHRoZSBgJHRpbWVvdXRgIGZ1bmN0aW9uLgogICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bGx5CiAgICAgICogICBjYW5jZWxlZC4KICAgICAgKi8KICAgIHRpbWVvdXQuY2FuY2VsID0gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICBpZiAocHJvbWlzZSAmJiBwcm9taXNlLiQkdGltZW91dElkIGluIGRlZmVycmVkcykgewogICAgICAgIGRlZmVycmVkc1twcm9taXNlLiQkdGltZW91dElkXS5yZWplY3QoJ2NhbmNlbGVkJyk7CiAgICAgICAgZGVsZXRlIGRlZmVycmVkc1twcm9taXNlLiQkdGltZW91dElkXTsKICAgICAgICByZXR1cm4gJGJyb3dzZXIuZGVmZXIuY2FuY2VsKHByb21pc2UuJCR0aW1lb3V0SWQpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgcmV0dXJuIHRpbWVvdXQ7CiAgfV07Cn0KCi8vIE5PVEU6ICBUaGUgdXNhZ2Ugb2Ygd2luZG93IGFuZCBkb2N1bWVudCBpbnN0ZWFkIG9mICR3aW5kb3cgYW5kICRkb2N1bWVudCBoZXJlIGlzCi8vIGRlbGliZXJhdGUuICBUaGlzIHNlcnZpY2UgZGVwZW5kcyBvbiB0aGUgc3BlY2lmaWMgYmVoYXZpb3Igb2YgYW5jaG9yIG5vZGVzIGNyZWF0ZWQgYnkgdGhlCi8vIGJyb3dzZXIgKHJlc29sdmluZyBhbmQgcGFyc2luZyBVUkxzKSB0aGF0IGlzIHVubGlrZWx5IHRvIGJlIHByb3ZpZGVkIGJ5IG1vY2sgb2JqZWN0cyBhbmQKLy8gY2F1c2UgdXMgdG8gYnJlYWsgdGVzdHMuICBJbiBhZGRpdGlvbiwgd2hlbiB0aGUgYnJvd3NlciByZXNvbHZlcyBhIFVSTCBmb3IgWEhSLCBpdAovLyBkb2Vzbid0IGtub3cgYWJvdXQgbW9ja2VkIGxvY2F0aW9ucyBhbmQgcmVzb2x2ZXMgVVJMcyB0byB0aGUgcmVhbCBkb2N1bWVudCAtIHdoaWNoIGlzCi8vIGV4YWN0bHkgdGhlIGJlaGF2aW9yIG5lZWRlZCBoZXJlLiAgVGhlcmUgaXMgbGl0dGxlIHZhbHVlIGlzIG1vY2tpbmcgdGhlc2Ugb3V0IGZvciB0aGlzCi8vIHNlcnZpY2UuCnZhciB1cmxQYXJzaW5nTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKdmFyIG9yaWdpblVybCA9IHVybFJlc29sdmUod2luZG93LmxvY2F0aW9uLmhyZWYsIHRydWUpOwoKCi8qKgogKgogKiBJbXBsZW1lbnRhdGlvbiBOb3RlcyBmb3Igbm9uLUlFIGJyb3dzZXJzCiAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICogQXNzaWduaW5nIGEgVVJMIHRvIHRoZSBocmVmIHByb3BlcnR5IG9mIGFuIGFuY2hvciBET00gbm9kZSwgZXZlbiBvbmUgYXR0YWNoZWQgdG8gdGhlIERPTSwKICogcmVzdWx0cyBib3RoIGluIHRoZSBub3JtYWxpemluZyBhbmQgcGFyc2luZyBvZiB0aGUgVVJMLiAgTm9ybWFsaXppbmcgbWVhbnMgdGhhdCBhIHJlbGF0aXZlCiAqIFVSTCB3aWxsIGJlIHJlc29sdmVkIGludG8gYW4gYWJzb2x1dGUgVVJMIGluIHRoZSBjb250ZXh0IG9mIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudC4KICogUGFyc2luZyBtZWFucyB0aGF0IHRoZSBhbmNob3Igbm9kZSdzIGhvc3QsIGhvc3RuYW1lLCBwcm90b2NvbCwgcG9ydCwgcGF0aG5hbWUgYW5kIHJlbGF0ZWQKICogcHJvcGVydGllcyBhcmUgYWxsIHBvcHVsYXRlZCB0byByZWZsZWN0IHRoZSBub3JtYWxpemVkIFVSTC4gIFRoaXMgYXBwcm9hY2ggaGFzIHdpZGUKICogY29tcGF0aWJpbGl0eSAtIFNhZmFyaSAxKywgTW96aWxsYSAxKywgT3BlcmEgNyssZSBldGMuICBTZWUKICogaHR0cDovL3d3dy5hcHRhbmEuY29tL3JlZmVyZW5jZS9odG1sL2FwaS9IVE1MQW5jaG9yRWxlbWVudC5odG1sCiAqCiAqIEltcGxlbWVudGF0aW9uIE5vdGVzIGZvciBJRQogKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICogSUUgPj0gOCBhbmQgPD0gMTAgbm9ybWFsaXplcyB0aGUgVVJMIHdoZW4gYXNzaWduZWQgdG8gdGhlIGFuY2hvciBub2RlIHNpbWlsYXIgdG8gdGhlIG90aGVyCiAqIGJyb3dzZXJzLiAgSG93ZXZlciwgdGhlIHBhcnNlZCBjb21wb25lbnRzIHdpbGwgbm90IGJlIHNldCBpZiB0aGUgVVJMIGFzc2lnbmVkIGRpZCBub3Qgc3BlY2lmeQogKiB0aGVtLiAgKGUuZy4gaWYgeW91IGFzc2lnbiBhLmhyZWYgPSAiZm9vIiwgdGhlbiBhLnByb3RvY29sLCBhLmhvc3QsIGV0Yy4gd2lsbCBiZSBlbXB0eS4pICBXZQogKiB3b3JrIGFyb3VuZCB0aGF0IGJ5IHBlcmZvcm1pbmcgdGhlIHBhcnNpbmcgaW4gYSAybmQgc3RlcCBieSB0YWtpbmcgYSBwcmV2aW91c2x5IG5vcm1hbGl6ZWQKICogVVJMIChlLmcuIGJ5IGFzc2lnbmluZyB0byBhLmhyZWYpIGFuZCBhc3NpZ25pbmcgaXQgYS5ocmVmIGFnYWluLiAgVGhpcyBjb3JyZWN0bHkgcG9wdWxhdGVzIHRoZQogKiBwcm9wZXJ0aWVzIHN1Y2ggYXMgcHJvdG9jb2wsIGhvc3RuYW1lLCBwb3J0LCBldGMuCiAqCiAqIElFNyBkb2VzIG5vdCBub3JtYWxpemUgdGhlIFVSTCB3aGVuIGFzc2lnbmVkIHRvIGFuIGFuY2hvciBub2RlLiAgKEFwcGFyZW50bHksIGl0IGRvZXMsIGlmIG9uZQogKiB1c2VzIHRoZSBpbm5lciBIVE1MIGFwcHJvYWNoIHRvIGFzc2lnbiB0aGUgVVJMIGFzIHBhcnQgb2YgYW4gSFRNTCBzbmlwcGV0IC0KICogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvNDcyNzI5KSAgSG93ZXZlciwgc2V0dGluZyBpbWdbc3JjXSBkb2VzIG5vcm1hbGl6ZSB0aGUgVVJMLgogKiBVbmZvcnR1bmF0ZWx5LCBzZXR0aW5nIGltZ1tzcmNdIHRvIHNvbWV0aGluZyBsaWtlICJqYXZhc2NyaXB0OmZvbyIgb24gSUUgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KICogU2luY2UgdGhlIHByaW1hcnkgdXNhZ2UgZm9yIG5vcm1hbGl6aW5nIFVSTHMgaXMgdG8gc2FuaXRpemUgc3VjaCBVUkxzLCB3ZSBjYW4ndCB1c2UgdGhhdAogKiBtZXRob2QgYW5kIElFIDwgOCBpcyB1bnN1cHBvcnRlZC4KICoKICogUmVmZXJlbmNlczoKICogICBodHRwOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9IVE1MQW5jaG9yRWxlbWVudAogKiAgIGh0dHA6Ly93d3cuYXB0YW5hLmNvbS9yZWZlcmVuY2UvaHRtbC9hcGkvSFRNTEFuY2hvckVsZW1lbnQuaHRtbAogKiAgIGh0dHA6Ly91cmwuc3BlYy53aGF0d2cub3JnLyN1cmx1dGlscwogKiAgIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvcHVsbC8yOTAyCiAqICAgaHR0cDovL2phbWVzLnBhZG9sc2V5LmNvbS9qYXZhc2NyaXB0L3BhcnNpbmctdXJscy13aXRoLXRoZS1kb20vCiAqCiAqIEBraW5kIGZ1bmN0aW9uCiAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIFVSTCB0byBiZSBwYXJzZWQuCiAqIEBkZXNjcmlwdGlvbiBOb3JtYWxpemVzIGFuZCBwYXJzZXMgYSBVUkwuCiAqIEByZXR1cm5zIHtvYmplY3R9IFJldHVybnMgdGhlIG5vcm1hbGl6ZWQgVVJMIGFzIGEgZGljdGlvbmFyeS4KICoKICogICB8IG1lbWJlciBuYW1lICAgfCBEZXNjcmlwdGlvbiAgICB8CiAqICAgfC0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tfAogKiAgIHwgaHJlZiAgICAgICAgICB8IEEgbm9ybWFsaXplZCB2ZXJzaW9uIG9mIHRoZSBwcm92aWRlZCBVUkwgaWYgaXQgd2FzIG5vdCBhbiBhYnNvbHV0ZSBVUkwgfAogKiAgIHwgcHJvdG9jb2wgICAgICB8IFRoZSBwcm90b2NvbCBpbmNsdWRpbmcgdGhlIHRyYWlsaW5nIGNvbG9uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiAgIHwgaG9zdCAgICAgICAgICB8IFRoZSBob3N0IGFuZCBwb3J0IChpZiB0aGUgcG9ydCBpcyBub24tZGVmYXVsdCkgb2YgdGhlIG5vcm1hbGl6ZWRVcmwgICAgfAogKiAgIHwgc2VhcmNoICAgICAgICB8IFRoZSBzZWFyY2ggcGFyYW1zLCBtaW51cyB0aGUgcXVlc3Rpb24gbWFyayAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiAgIHwgaGFzaCAgICAgICAgICB8IFRoZSBoYXNoIHN0cmluZywgbWludXMgdGhlIGhhc2ggc3ltYm9sCiAqICAgfCBob3N0bmFtZSAgICAgIHwgVGhlIGhvc3RuYW1lCiAqICAgfCBwb3J0ICAgICAgICAgIHwgVGhlIHBvcnQsIHdpdGhvdXQgIjoiCiAqICAgfCBwYXRobmFtZSAgICAgIHwgVGhlIHBhdGhuYW1lLCBiZWdpbm5pbmcgd2l0aCAiLyIKICoKICovCmZ1bmN0aW9uIHVybFJlc29sdmUodXJsLCBiYXNlKSB7CiAgdmFyIGhyZWYgPSB1cmw7CgogIGlmIChtc2llKSB7CiAgICAvLyBOb3JtYWxpemUgYmVmb3JlIHBhcnNlLiAgUmVmZXIgSW1wbGVtZW50YXRpb24gTm90ZXMgb24gd2h5IHRoaXMgaXMKICAgIC8vIGRvbmUgaW4gdHdvIHN0ZXBzIG9uIElFLgogICAgdXJsUGFyc2luZ05vZGUuc2V0QXR0cmlidXRlKCJocmVmIiwgaHJlZik7CiAgICBocmVmID0gdXJsUGFyc2luZ05vZGUuaHJlZjsKICB9CgogIHVybFBhcnNpbmdOb2RlLnNldEF0dHJpYnV0ZSgnaHJlZicsIGhyZWYpOwoKICAvLyB1cmxQYXJzaW5nTm9kZSBwcm92aWRlcyB0aGUgVXJsVXRpbHMgaW50ZXJmYWNlIC0gaHR0cDovL3VybC5zcGVjLndoYXR3Zy5vcmcvI3VybHV0aWxzCiAgcmV0dXJuIHsKICAgIGhyZWY6IHVybFBhcnNpbmdOb2RlLmhyZWYsCiAgICBwcm90b2NvbDogdXJsUGFyc2luZ05vZGUucHJvdG9jb2wgPyB1cmxQYXJzaW5nTm9kZS5wcm90b2NvbC5yZXBsYWNlKC86JC8sICcnKSA6ICcnLAogICAgaG9zdDogdXJsUGFyc2luZ05vZGUuaG9zdCwKICAgIHNlYXJjaDogdXJsUGFyc2luZ05vZGUuc2VhcmNoID8gdXJsUGFyc2luZ05vZGUuc2VhcmNoLnJlcGxhY2UoL15cPy8sICcnKSA6ICcnLAogICAgaGFzaDogdXJsUGFyc2luZ05vZGUuaGFzaCA/IHVybFBhcnNpbmdOb2RlLmhhc2gucmVwbGFjZSgvXiMvLCAnJykgOiAnJywKICAgIGhvc3RuYW1lOiB1cmxQYXJzaW5nTm9kZS5ob3N0bmFtZSwKICAgIHBvcnQ6IHVybFBhcnNpbmdOb2RlLnBvcnQsCiAgICBwYXRobmFtZTogKHVybFBhcnNpbmdOb2RlLnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nKQogICAgICA/IHVybFBhcnNpbmdOb2RlLnBhdGhuYW1lCiAgICAgIDogJy8nICsgdXJsUGFyc2luZ05vZGUucGF0aG5hbWUKICB9Owp9CgovKioKICogUGFyc2UgYSByZXF1ZXN0IFVSTCBhbmQgZGV0ZXJtaW5lIHdoZXRoZXIgdGhpcyBpcyBhIHNhbWUtb3JpZ2luIHJlcXVlc3QgYXMgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50LgogKgogKiBAcGFyYW0ge3N0cmluZ3xvYmplY3R9IHJlcXVlc3RVcmwgVGhlIHVybCBvZiB0aGUgcmVxdWVzdCBhcyBhIHN0cmluZyB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQKICogb3IgYSBwYXJzZWQgVVJMIG9iamVjdC4KICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIHJlcXVlc3QgaXMgZm9yIHRoZSBzYW1lIG9yaWdpbiBhcyB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQuCiAqLwpmdW5jdGlvbiB1cmxJc1NhbWVPcmlnaW4ocmVxdWVzdFVybCkgewogIHZhciBwYXJzZWQgPSAoaXNTdHJpbmcocmVxdWVzdFVybCkpID8gdXJsUmVzb2x2ZShyZXF1ZXN0VXJsKSA6IHJlcXVlc3RVcmw7CiAgcmV0dXJuIChwYXJzZWQucHJvdG9jb2wgPT09IG9yaWdpblVybC5wcm90b2NvbCAmJgogICAgICAgICAgcGFyc2VkLmhvc3QgPT09IG9yaWdpblVybC5ob3N0KTsKfQoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICR3aW5kb3cKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgcmVmZXJlbmNlIHRvIHRoZSBicm93c2VyJ3MgYHdpbmRvd2Agb2JqZWN0LiBXaGlsZSBgd2luZG93YAogKiBpcyBnbG9iYWxseSBhdmFpbGFibGUgaW4gSmF2YVNjcmlwdCwgaXQgY2F1c2VzIHRlc3RhYmlsaXR5IHByb2JsZW1zLCBiZWNhdXNlCiAqIGl0IGlzIGEgZ2xvYmFsIHZhcmlhYmxlLiBJbiBhbmd1bGFyIHdlIGFsd2F5cyByZWZlciB0byBpdCB0aHJvdWdoIHRoZQogKiBgJHdpbmRvd2Agc2VydmljZSwgc28gaXQgbWF5IGJlIG92ZXJyaWRkZW4sIHJlbW92ZWQgb3IgbW9ja2VkIGZvciB0ZXN0aW5nLgogKgogKiBFeHByZXNzaW9ucywgbGlrZSB0aGUgb25lIGRlZmluZWQgZm9yIHRoZSBgbmdDbGlja2AgZGlyZWN0aXZlIGluIHRoZSBleGFtcGxlCiAqIGJlbG93LCBhcmUgZXZhbHVhdGVkIHdpdGggcmVzcGVjdCB0byB0aGUgY3VycmVudCBzY29wZS4gIFRoZXJlZm9yZSwgdGhlcmUgaXMKICogbm8gcmlzayBvZiBpbmFkdmVydGVudGx5IGNvZGluZyBpbiBhIGRlcGVuZGVuY3kgb24gYSBnbG9iYWwgdmFsdWUgaW4gc3VjaCBhbgogKiBleHByZXNzaW9uLgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9IndpbmRvd0V4YW1wbGUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ3dpbmRvd0V4YW1wbGUnLCBbXSkKICAgICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsICckd2luZG93JywgZnVuY3Rpb24gKCRzY29wZSwgJHdpbmRvdykgewogICAgICAgICAgICAgJHNjb3BlLmdyZWV0aW5nID0gJ0hlbGxvLCBXb3JsZCEnOwogICAgICAgICAgICAgJHNjb3BlLmRvR3JlZXRpbmcgPSBmdW5jdGlvbihncmVldGluZykgewogICAgICAgICAgICAgICAkd2luZG93LmFsZXJ0KGdyZWV0aW5nKTsKICAgICAgICAgICAgIH07CiAgICAgICAgICAgfV0pOwogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJncmVldGluZyIgLz4KICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iZG9HcmVldGluZyhncmVldGluZykiPkFMRVJUPC9idXR0b24+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgIGl0KCdzaG91bGQgZGlzcGxheSB0aGUgZ3JlZXRpbmcgaW4gdGhlIGlucHV0IGJveCcsIGZ1bmN0aW9uKCkgewogICAgICAgZWxlbWVudChieS5tb2RlbCgnZ3JlZXRpbmcnKSkuc2VuZEtleXMoJ0hlbGxvLCBFMkUgVGVzdHMnKTsKICAgICAgIC8vIElmIHdlIGNsaWNrIHRoZSBidXR0b24gaXQgd2lsbCBibG9jayB0aGUgdGVzdCBydW5uZXIKICAgICAgIC8vIGVsZW1lbnQoJzpidXR0b24nKS5jbGljaygpOwogICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCmZ1bmN0aW9uICRXaW5kb3dQcm92aWRlcigpewogIHRoaXMuJGdldCA9IHZhbHVlRm4od2luZG93KTsKfQoKLyogZ2xvYmFsIGN1cnJlbmN5RmlsdGVyOiB0cnVlLAogZGF0ZUZpbHRlcjogdHJ1ZSwKIGZpbHRlckZpbHRlcjogdHJ1ZSwKIGpzb25GaWx0ZXI6IHRydWUsCiBsaW1pdFRvRmlsdGVyOiB0cnVlLAogbG93ZXJjYXNlRmlsdGVyOiB0cnVlLAogbnVtYmVyRmlsdGVyOiB0cnVlLAogb3JkZXJCeUZpbHRlcjogdHJ1ZSwKIHVwcGVyY2FzZUZpbHRlcjogdHJ1ZSwKICovCgovKioKICogQG5nZG9jIHByb3ZpZGVyCiAqIEBuYW1lICRmaWx0ZXJQcm92aWRlcgogKiBAZGVzY3JpcHRpb24KICoKICogRmlsdGVycyBhcmUganVzdCBmdW5jdGlvbnMgd2hpY2ggdHJhbnNmb3JtIGlucHV0IHRvIGFuIG91dHB1dC4gSG93ZXZlciBmaWx0ZXJzIG5lZWQgdG8gYmUKICogRGVwZW5kZW5jeSBJbmplY3RlZC4gVG8gYWNoaWV2ZSB0aGlzIGEgZmlsdGVyIGRlZmluaXRpb24gY29uc2lzdHMgb2YgYSBmYWN0b3J5IGZ1bmN0aW9uIHdoaWNoIGlzCiAqIGFubm90YXRlZCB3aXRoIGRlcGVuZGVuY2llcyBhbmQgaXMgcmVzcG9uc2libGUgZm9yIGNyZWF0aW5nIGEgZmlsdGVyIGZ1bmN0aW9uLgogKgogKiBgYGBqcwogKiAgIC8vIEZpbHRlciByZWdpc3RyYXRpb24KICogICBmdW5jdGlvbiBNeU1vZHVsZSgkcHJvdmlkZSwgJGZpbHRlclByb3ZpZGVyKSB7CiAqICAgICAvLyBjcmVhdGUgYSBzZXJ2aWNlIHRvIGRlbW9uc3RyYXRlIGluamVjdGlvbiAobm90IGFsd2F5cyBuZWVkZWQpCiAqICAgICAkcHJvdmlkZS52YWx1ZSgnZ3JlZXQnLCBmdW5jdGlvbihuYW1lKXsKICogICAgICAgcmV0dXJuICdIZWxsbyAnICsgbmFtZSArICchJzsKICogICAgIH0pOwogKgogKiAgICAgLy8gcmVnaXN0ZXIgYSBmaWx0ZXIgZmFjdG9yeSB3aGljaCB1c2VzIHRoZQogKiAgICAgLy8gZ3JlZXQgc2VydmljZSB0byBkZW1vbnN0cmF0ZSBESS4KICogICAgICRmaWx0ZXJQcm92aWRlci5yZWdpc3RlcignZ3JlZXQnLCBmdW5jdGlvbihncmVldCl7CiAqICAgICAgIC8vIHJldHVybiB0aGUgZmlsdGVyIGZ1bmN0aW9uIHdoaWNoIHVzZXMgdGhlIGdyZWV0IHNlcnZpY2UKICogICAgICAgLy8gdG8gZ2VuZXJhdGUgc2FsdXRhdGlvbgogKiAgICAgICByZXR1cm4gZnVuY3Rpb24odGV4dCkgewogKiAgICAgICAgIC8vIGZpbHRlcnMgbmVlZCB0byBiZSBmb3JnaXZpbmcgc28gY2hlY2sgaW5wdXQgdmFsaWRpdHkKICogICAgICAgICByZXR1cm4gdGV4dCAmJiBncmVldCh0ZXh0KSB8fCB0ZXh0OwogKiAgICAgICB9OwogKiAgICAgfSk7CiAqICAgfQogKiBgYGAKICoKICogVGhlIGZpbHRlciBmdW5jdGlvbiBpcyByZWdpc3RlcmVkIHdpdGggdGhlIGAkaW5qZWN0b3JgIHVuZGVyIHRoZSBmaWx0ZXIgbmFtZSBzdWZmaXggd2l0aAogKiBgRmlsdGVyYC4KICoKICogYGBganMKICogICBpdCgnc2hvdWxkIGJlIHRoZSBzYW1lIGluc3RhbmNlJywgaW5qZWN0KAogKiAgICAgZnVuY3Rpb24oJGZpbHRlclByb3ZpZGVyKSB7CiAqICAgICAgICRmaWx0ZXJQcm92aWRlci5yZWdpc3RlcigncmV2ZXJzZScsIGZ1bmN0aW9uKCl7CiAqICAgICAgICAgcmV0dXJuIC4uLjsKICogICAgICAgfSk7CiAqICAgICB9LAogKiAgICAgZnVuY3Rpb24oJGZpbHRlciwgcmV2ZXJzZUZpbHRlcikgewogKiAgICAgICBleHBlY3QoJGZpbHRlcigncmV2ZXJzZScpKS50b0JlKHJldmVyc2VGaWx0ZXIpOwogKiAgICAgfSk7CiAqIGBgYAogKgogKgogKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBob3cgYW5ndWxhciBmaWx0ZXJzIHdvcmssIGFuZCBob3cgdG8gY3JlYXRlIHlvdXIgb3duIGZpbHRlcnMsIHNlZQogKiB7QGxpbmsgZ3VpZGUvZmlsdGVyIEZpbHRlcnN9IGluIHRoZSBBbmd1bGFyIERldmVsb3BlciBHdWlkZS4KICovCgovKioKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgJGZpbHRlcgogKiBAa2luZCBmdW5jdGlvbgogKiBAZGVzY3JpcHRpb24KICogRmlsdGVycyBhcmUgdXNlZCBmb3IgZm9ybWF0dGluZyBkYXRhIGRpc3BsYXllZCB0byB0aGUgdXNlci4KICoKICogVGhlIGdlbmVyYWwgc3ludGF4IGluIHRlbXBsYXRlcyBpcyBhcyBmb2xsb3dzOgogKgogKiAgICAgICAgIHt7IGV4cHJlc3Npb24gW3wgZmlsdGVyX25hbWVbOnBhcmFtZXRlcl92YWx1ZV0gLi4uIF0gfX0KICoKICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyIGZ1bmN0aW9uIHRvIHJldHJpZXZlCiAqIEByZXR1cm4ge0Z1bmN0aW9ufSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG5hbWU9IiRmaWx0ZXIiIG1vZHVsZT0iZmlsdGVyRXhhbXBsZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9Ik1haW5DdHJsIj4KICAgICAgICA8aDM+e3sgb3JpZ2luYWxUZXh0IH19PC9oMz4KICAgICAgICA8aDM+e3sgZmlsdGVyZWRUZXh0IH19PC9oMz4KICAgICAgIDwvZGl2PgogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgYW5ndWxhci5tb2R1bGUoJ2ZpbHRlckV4YW1wbGUnLCBbXSkKICAgICAgLmNvbnRyb2xsZXIoJ01haW5DdHJsJywgZnVuY3Rpb24oJHNjb3BlLCAkZmlsdGVyKSB7CiAgICAgICAgJHNjb3BlLm9yaWdpbmFsVGV4dCA9ICdoZWxsbyc7CiAgICAgICAgJHNjb3BlLmZpbHRlcmVkVGV4dCA9ICRmaWx0ZXIoJ3VwcGVyY2FzZScpKCRzY29wZS5vcmlnaW5hbFRleHQpOwogICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAqLwokRmlsdGVyUHJvdmlkZXIuJGluamVjdCA9IFsnJHByb3ZpZGUnXTsKZnVuY3Rpb24gJEZpbHRlclByb3ZpZGVyKCRwcm92aWRlKSB7CiAgdmFyIHN1ZmZpeCA9ICdGaWx0ZXInOwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGZpbHRlclByb3ZpZGVyI3JlZ2lzdGVyCiAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fSBuYW1lIE5hbWUgb2YgdGhlIGZpbHRlciBmdW5jdGlvbiwgb3IgYW4gb2JqZWN0IG1hcCBvZiBmaWx0ZXJzIHdoZXJlCiAgICogICAgdGhlIGtleXMgYXJlIHRoZSBmaWx0ZXIgbmFtZXMgYW5kIHRoZSB2YWx1ZXMgYXJlIHRoZSBmaWx0ZXIgZmFjdG9yaWVzLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJlZ2lzdGVyZWQgZmlsdGVyIGluc3RhbmNlLCBvciBpZiBhIG1hcCBvZiBmaWx0ZXJzIHdhcyBwcm92aWRlZCB0aGVuIGEgbWFwCiAgICogICAgb2YgdGhlIHJlZ2lzdGVyZWQgZmlsdGVyIGluc3RhbmNlcy4KICAgKi8KICBmdW5jdGlvbiByZWdpc3RlcihuYW1lLCBmYWN0b3J5KSB7CiAgICBpZihpc09iamVjdChuYW1lKSkgewogICAgICB2YXIgZmlsdGVycyA9IHt9OwogICAgICBmb3JFYWNoKG5hbWUsIGZ1bmN0aW9uKGZpbHRlciwga2V5KSB7CiAgICAgICAgZmlsdGVyc1trZXldID0gcmVnaXN0ZXIoa2V5LCBmaWx0ZXIpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGZpbHRlcnM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gJHByb3ZpZGUuZmFjdG9yeShuYW1lICsgc3VmZml4LCBmYWN0b3J5KTsKICAgIH0KICB9CiAgdGhpcy5yZWdpc3RlciA9IHJlZ2lzdGVyOwoKICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsIGZ1bmN0aW9uKCRpbmplY3RvcikgewogICAgcmV0dXJuIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgcmV0dXJuICRpbmplY3Rvci5nZXQobmFtZSArIHN1ZmZpeCk7CiAgICB9OwogIH1dOwoKICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogIC8qIGdsb2JhbAogICAgY3VycmVuY3lGaWx0ZXI6IGZhbHNlLAogICAgZGF0ZUZpbHRlcjogZmFsc2UsCiAgICBmaWx0ZXJGaWx0ZXI6IGZhbHNlLAogICAganNvbkZpbHRlcjogZmFsc2UsCiAgICBsaW1pdFRvRmlsdGVyOiBmYWxzZSwKICAgIGxvd2VyY2FzZUZpbHRlcjogZmFsc2UsCiAgICBudW1iZXJGaWx0ZXI6IGZhbHNlLAogICAgb3JkZXJCeUZpbHRlcjogZmFsc2UsCiAgICB1cHBlcmNhc2VGaWx0ZXI6IGZhbHNlLAogICovCgogIHJlZ2lzdGVyKCdjdXJyZW5jeScsIGN1cnJlbmN5RmlsdGVyKTsKICByZWdpc3RlcignZGF0ZScsIGRhdGVGaWx0ZXIpOwogIHJlZ2lzdGVyKCdmaWx0ZXInLCBmaWx0ZXJGaWx0ZXIpOwogIHJlZ2lzdGVyKCdqc29uJywganNvbkZpbHRlcik7CiAgcmVnaXN0ZXIoJ2xpbWl0VG8nLCBsaW1pdFRvRmlsdGVyKTsKICByZWdpc3RlcignbG93ZXJjYXNlJywgbG93ZXJjYXNlRmlsdGVyKTsKICByZWdpc3RlcignbnVtYmVyJywgbnVtYmVyRmlsdGVyKTsKICByZWdpc3Rlcignb3JkZXJCeScsIG9yZGVyQnlGaWx0ZXIpOwogIHJlZ2lzdGVyKCd1cHBlcmNhc2UnLCB1cHBlcmNhc2VGaWx0ZXIpOwp9CgovKioKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBmaWx0ZXIKICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIFNlbGVjdHMgYSBzdWJzZXQgb2YgaXRlbXMgZnJvbSBgYXJyYXlgIGFuZCByZXR1cm5zIGl0IGFzIGEgbmV3IGFycmF5LgogKgogKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgc291cmNlIGFycmF5LgogKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R8ZnVuY3Rpb24oKX0gZXhwcmVzc2lvbiBUaGUgcHJlZGljYXRlIHRvIGJlIHVzZWQgZm9yIHNlbGVjdGluZyBpdGVtcyBmcm9tCiAqICAgYGFycmF5YC4KICoKICogICBDYW4gYmUgb25lIG9mOgogKgogKiAgIC0gYHN0cmluZ2A6IFRoZSBzdHJpbmcgaXMgZXZhbHVhdGVkIGFzIGFuIGV4cHJlc3Npb24gYW5kIHRoZSByZXN1bHRpbmcgdmFsdWUgaXMgdXNlZCBmb3Igc3Vic3RyaW5nIG1hdGNoIGFnYWluc3QKICogICAgIHRoZSBjb250ZW50cyBvZiB0aGUgYGFycmF5YC4gQWxsIHN0cmluZ3Mgb3Igb2JqZWN0cyB3aXRoIHN0cmluZyBwcm9wZXJ0aWVzIGluIGBhcnJheWAgdGhhdCBjb250YWluIHRoaXMgc3RyaW5nCiAqICAgICB3aWxsIGJlIHJldHVybmVkLiBUaGUgcHJlZGljYXRlIGNhbiBiZSBuZWdhdGVkIGJ5IHByZWZpeGluZyB0aGUgc3RyaW5nIHdpdGggYCFgLgogKgogKiAgIC0gYE9iamVjdGA6IEEgcGF0dGVybiBvYmplY3QgY2FuIGJlIHVzZWQgdG8gZmlsdGVyIHNwZWNpZmljIHByb3BlcnRpZXMgb24gb2JqZWN0cyBjb250YWluZWQKICogICAgIGJ5IGBhcnJheWAuIEZvciBleGFtcGxlIGB7bmFtZToiTSIsIHBob25lOiIxIn1gIHByZWRpY2F0ZSB3aWxsIHJldHVybiBhbiBhcnJheSBvZiBpdGVtcwogKiAgICAgd2hpY2ggaGF2ZSBwcm9wZXJ0eSBgbmFtZWAgY29udGFpbmluZyAiTSIgYW5kIHByb3BlcnR5IGBwaG9uZWAgY29udGFpbmluZyAiMSIuIEEgc3BlY2lhbAogKiAgICAgcHJvcGVydHkgbmFtZSBgJGAgY2FuIGJlIHVzZWQgKGFzIGluIGB7JDoidGV4dCJ9YCkgdG8gYWNjZXB0IGEgbWF0Y2ggYWdhaW5zdCBhbnkKICogICAgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoYXQncyBlcXVpdmFsZW50IHRvIHRoZSBzaW1wbGUgc3Vic3RyaW5nIG1hdGNoIHdpdGggYSBgc3RyaW5nYAogKiAgICAgYXMgZGVzY3JpYmVkIGFib3ZlLiBUaGUgcHJlZGljYXRlIGNhbiBiZSBuZWdhdGVkIGJ5IHByZWZpeGluZyB0aGUgc3RyaW5nIHdpdGggYCFgLgogKiAgICAgRm9yIEV4YW1wbGUgYHtuYW1lOiAiIU0ifWAgcHJlZGljYXRlIHdpbGwgcmV0dXJuIGFuIGFycmF5IG9mIGl0ZW1zIHdoaWNoIGhhdmUgcHJvcGVydHkgYG5hbWVgCiAqICAgICBub3QgY29udGFpbmluZyAiTSIuCiAqCiAqICAgLSBgZnVuY3Rpb24odmFsdWUsIGluZGV4KWA6IEEgcHJlZGljYXRlIGZ1bmN0aW9uIGNhbiBiZSB1c2VkIHRvIHdyaXRlIGFyYml0cmFyeSBmaWx0ZXJzLiBUaGUKICogICAgIGZ1bmN0aW9uIGlzIGNhbGxlZCBmb3IgZWFjaCBlbGVtZW50IG9mIGBhcnJheWAuIFRoZSBmaW5hbCByZXN1bHQgaXMgYW4gYXJyYXkgb2YgdGhvc2UKICogICAgIGVsZW1lbnRzIHRoYXQgdGhlIHByZWRpY2F0ZSByZXR1cm5lZCB0cnVlIGZvci4KICoKICogQHBhcmFtIHtmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkKXx0cnVlfHVuZGVmaW5lZH0gY29tcGFyYXRvciBDb21wYXJhdG9yIHdoaWNoIGlzIHVzZWQgaW4KICogICAgIGRldGVybWluaW5nIGlmIHRoZSBleHBlY3RlZCB2YWx1ZSAoZnJvbSB0aGUgZmlsdGVyIGV4cHJlc3Npb24pIGFuZCBhY3R1YWwgdmFsdWUgKGZyb20KICogICAgIHRoZSBvYmplY3QgaW4gdGhlIGFycmF5KSBzaG91bGQgYmUgY29uc2lkZXJlZCBhIG1hdGNoLgogKgogKiAgIENhbiBiZSBvbmUgb2Y6CiAqCiAqICAgLSBgZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZClgOgogKiAgICAgVGhlIGZ1bmN0aW9uIHdpbGwgYmUgZ2l2ZW4gdGhlIG9iamVjdCB2YWx1ZSBhbmQgdGhlIHByZWRpY2F0ZSB2YWx1ZSB0byBjb21wYXJlIGFuZAogKiAgICAgc2hvdWxkIHJldHVybiB0cnVlIGlmIHRoZSBpdGVtIHNob3VsZCBiZSBpbmNsdWRlZCBpbiBmaWx0ZXJlZCByZXN1bHQuCiAqCiAqICAgLSBgdHJ1ZWA6IEEgc2hvcnRoYW5kIGZvciBgZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCkgeyByZXR1cm4gYW5ndWxhci5lcXVhbHMoZXhwZWN0ZWQsIGFjdHVhbCl9YC4KICogICAgIHRoaXMgaXMgZXNzZW50aWFsbHkgc3RyaWN0IGNvbXBhcmlzb24gb2YgZXhwZWN0ZWQgYW5kIGFjdHVhbC4KICoKICogICAtIGBmYWxzZXx1bmRlZmluZWRgOiBBIHNob3J0IGhhbmQgZm9yIGEgZnVuY3Rpb24gd2hpY2ggd2lsbCBsb29rIGZvciBhIHN1YnN0cmluZyBtYXRjaCBpbiBjYXNlCiAqICAgICBpbnNlbnNpdGl2ZSB3YXkuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPGRpdiBuZy1pbml0PSJmcmllbmRzID0gW3tuYW1lOidKb2huJywgcGhvbmU6JzU1NS0xMjc2J30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge25hbWU6J01hcnknLCBwaG9uZTonODAwLUJJRy1NQVJZJ30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge25hbWU6J01pa2UnLCBwaG9uZTonNTU1LTQzMjEnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidKdWxpZScsIHBob25lOic1NTUtODc2NSd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidKdWxpZXR0ZScsIHBob25lOic1NTUtNTY3OCd9XSI+PC9kaXY+CgogICAgICAgU2VhcmNoOiA8aW5wdXQgbmctbW9kZWw9InNlYXJjaFRleHQiPgogICAgICAgPHRhYmxlIGlkPSJzZWFyY2hUZXh0UmVzdWx0cyI+CiAgICAgICAgIDx0cj48dGg+TmFtZTwvdGg+PHRoPlBob25lPC90aD48L3RyPgogICAgICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2hUZXh0Ij4KICAgICAgICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICAgICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICA8L3RhYmxlPgogICAgICAgPGhyPgogICAgICAgQW55OiA8aW5wdXQgbmctbW9kZWw9InNlYXJjaC4kIj4gPGJyPgogICAgICAgTmFtZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLm5hbWUiPjxicj4KICAgICAgIFBob25lIG9ubHkgPGlucHV0IG5nLW1vZGVsPSJzZWFyY2gucGhvbmUiPjxicj4KICAgICAgIEVxdWFsaXR5IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InN0cmljdCI+PGJyPgogICAgICAgPHRhYmxlIGlkPSJzZWFyY2hPYmpSZXN1bHRzIj4KICAgICAgICAgPHRyPjx0aD5OYW1lPC90aD48dGg+UGhvbmU8L3RoPjwvdHI+CiAgICAgICAgIDx0ciBuZy1yZXBlYXQ9ImZyaWVuZE9iaiBpbiBmcmllbmRzIHwgZmlsdGVyOnNlYXJjaDpzdHJpY3QiPgogICAgICAgICAgIDx0ZD57e2ZyaWVuZE9iai5uYW1lfX08L3RkPgogICAgICAgICAgIDx0ZD57e2ZyaWVuZE9iai5waG9uZX19PC90ZD4KICAgICAgICAgPC90cj4KICAgICAgIDwvdGFibGU+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgdmFyIGV4cGVjdEZyaWVuZE5hbWVzID0gZnVuY3Rpb24oZXhwZWN0ZWROYW1lcywga2V5KSB7CiAgICAgICAgIGVsZW1lbnQuYWxsKGJ5LnJlcGVhdGVyKGtleSArICcgaW4gZnJpZW5kcycpLmNvbHVtbihrZXkgKyAnLm5hbWUnKSkudGhlbihmdW5jdGlvbihhcnIpIHsKICAgICAgICAgICBhcnIuZm9yRWFjaChmdW5jdGlvbih3ZCwgaSkgewogICAgICAgICAgICAgZXhwZWN0KHdkLmdldFRleHQoKSkudG9NYXRjaChleHBlY3RlZE5hbWVzW2ldKTsKICAgICAgICAgICB9KTsKICAgICAgICAgfSk7CiAgICAgICB9OwoKICAgICAgIGl0KCdzaG91bGQgc2VhcmNoIGFjcm9zcyBhbGwgZmllbGRzIHdoZW4gZmlsdGVyaW5nIHdpdGggYSBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgdmFyIHNlYXJjaFRleHQgPSBlbGVtZW50KGJ5Lm1vZGVsKCdzZWFyY2hUZXh0JykpOwogICAgICAgICBzZWFyY2hUZXh0LmNsZWFyKCk7CiAgICAgICAgIHNlYXJjaFRleHQuc2VuZEtleXMoJ20nKTsKICAgICAgICAgZXhwZWN0RnJpZW5kTmFtZXMoWydNYXJ5JywgJ01pa2UnLCAnQWRhbSddLCAnZnJpZW5kJyk7CgogICAgICAgICBzZWFyY2hUZXh0LmNsZWFyKCk7CiAgICAgICAgIHNlYXJjaFRleHQuc2VuZEtleXMoJzc2Jyk7CiAgICAgICAgIGV4cGVjdEZyaWVuZE5hbWVzKFsnSm9obicsICdKdWxpZSddLCAnZnJpZW5kJyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIHNlYXJjaCBpbiBzcGVjaWZpYyBmaWVsZHMgd2hlbiBmaWx0ZXJpbmcgd2l0aCBhIHByZWRpY2F0ZSBvYmplY3QnLCBmdW5jdGlvbigpIHsKICAgICAgICAgdmFyIHNlYXJjaEFueSA9IGVsZW1lbnQoYnkubW9kZWwoJ3NlYXJjaC4kJykpOwogICAgICAgICBzZWFyY2hBbnkuY2xlYXIoKTsKICAgICAgICAgc2VhcmNoQW55LnNlbmRLZXlzKCdpJyk7CiAgICAgICAgIGV4cGVjdEZyaWVuZE5hbWVzKFsnTWFyeScsICdNaWtlJywgJ0p1bGllJywgJ0p1bGlldHRlJ10sICdmcmllbmRPYmonKTsKICAgICAgIH0pOwogICAgICAgaXQoJ3Nob3VsZCB1c2UgYSBlcXVhbCBjb21wYXJpc29uIHdoZW4gY29tcGFyYXRvciBpcyB0cnVlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBzZWFyY2hOYW1lID0gZWxlbWVudChieS5tb2RlbCgnc2VhcmNoLm5hbWUnKSk7CiAgICAgICAgIHZhciBzdHJpY3QgPSBlbGVtZW50KGJ5Lm1vZGVsKCdzdHJpY3QnKSk7CiAgICAgICAgIHNlYXJjaE5hbWUuY2xlYXIoKTsKICAgICAgICAgc2VhcmNoTmFtZS5zZW5kS2V5cygnSnVsaWUnKTsKICAgICAgICAgc3RyaWN0LmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdEZyaWVuZE5hbWVzKFsnSnVsaWUnXSwgJ2ZyaWVuZE9iaicpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwpmdW5jdGlvbiBmaWx0ZXJGaWx0ZXIoKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGFycmF5LCBleHByZXNzaW9uLCBjb21wYXJhdG9yKSB7CiAgICBpZiAoIWlzQXJyYXkoYXJyYXkpKSByZXR1cm4gYXJyYXk7CgogICAgdmFyIGNvbXBhcmF0b3JUeXBlID0gdHlwZW9mKGNvbXBhcmF0b3IpLAogICAgICAgIHByZWRpY2F0ZXMgPSBbXTsKCiAgICBwcmVkaWNhdGVzLmNoZWNrID0gZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcHJlZGljYXRlcy5sZW5ndGg7IGorKykgewogICAgICAgIGlmKCFwcmVkaWNhdGVzW2pdKHZhbHVlLCBpbmRleCkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwoKICAgIGlmIChjb21wYXJhdG9yVHlwZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICBpZiAoY29tcGFyYXRvclR5cGUgPT09ICdib29sZWFuJyAmJiBjb21wYXJhdG9yKSB7CiAgICAgICAgY29tcGFyYXRvciA9IGZ1bmN0aW9uKG9iaiwgdGV4dCkgewogICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuZXF1YWxzKG9iaiwgdGV4dCk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb21wYXJhdG9yID0gZnVuY3Rpb24ob2JqLCB0ZXh0KSB7CiAgICAgICAgICBpZiAob2JqICYmIHRleHQgJiYgdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIHRleHQgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIGZvciAodmFyIG9iaktleSBpbiBvYmopIHsKICAgICAgICAgICAgICBpZiAob2JqS2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBvYmpLZXkpICYmCiAgICAgICAgICAgICAgICAgIGNvbXBhcmF0b3Iob2JqW29iaktleV0sIHRleHRbb2JqS2V5XSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB0ZXh0ID0gKCcnK3RleHQpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gKCcnK29iaikudG9Mb3dlckNhc2UoKS5pbmRleE9mKHRleHQpID4gLTE7CiAgICAgICAgfTsKICAgICAgfQogICAgfQoKICAgIHZhciBzZWFyY2ggPSBmdW5jdGlvbihvYmosIHRleHQpewogICAgICBpZiAodHlwZW9mIHRleHQgPT09ICdzdHJpbmcnICYmIHRleHQuY2hhckF0KDApID09PSAnIScpIHsKICAgICAgICByZXR1cm4gIXNlYXJjaChvYmosIHRleHQuc3Vic3RyKDEpKTsKICAgICAgfQogICAgICBzd2l0Y2ggKHR5cGVvZiBvYmopIHsKICAgICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICBjYXNlICdudW1iZXInOgogICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICByZXR1cm4gY29tcGFyYXRvcihvYmosIHRleHQpOwogICAgICAgIGNhc2UgJ29iamVjdCc6CiAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiB0ZXh0KSB7CiAgICAgICAgICAgIGNhc2UgJ29iamVjdCc6CiAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmF0b3Iob2JqLCB0ZXh0KTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBmb3IgKCB2YXIgb2JqS2V5IGluIG9iaikgewogICAgICAgICAgICAgICAgaWYgKG9iaktleS5jaGFyQXQoMCkgIT09ICckJyAmJiBzZWFyY2gob2JqW29iaktleV0sIHRleHQpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICBjYXNlICdhcnJheSc6CiAgICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBvYmoubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKHNlYXJjaChvYmpbaV0sIHRleHQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9OwogICAgc3dpdGNoICh0eXBlb2YgZXhwcmVzc2lvbikgewogICAgICBjYXNlICdib29sZWFuJzoKICAgICAgY2FzZSAnbnVtYmVyJzoKICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAvLyBTZXQgdXAgZXhwcmVzc2lvbiBvYmplY3QgYW5kIGZhbGwgdGhyb3VnaAogICAgICAgIGV4cHJlc3Npb24gPSB7JDpleHByZXNzaW9ufTsKICAgICAgICAvLyBqc2hpbnQgLVcwODYKICAgICAgY2FzZSAnb2JqZWN0JzoKICAgICAgICAvLyBqc2hpbnQgK1cwODYKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXhwcmVzc2lvbikgewogICAgICAgICAgKGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBleHByZXNzaW9uW3BhdGhdID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwogICAgICAgICAgICBwcmVkaWNhdGVzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gc2VhcmNoKHBhdGggPT0gJyQnID8gdmFsdWUgOiAodmFsdWUgJiYgdmFsdWVbcGF0aF0pLCBleHByZXNzaW9uW3BhdGhdKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KShrZXkpOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAnZnVuY3Rpb24nOgogICAgICAgIHByZWRpY2F0ZXMucHVzaChleHByZXNzaW9uKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICB9CiAgICB2YXIgZmlsdGVyZWQgPSBbXTsKICAgIGZvciAoIHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSB7CiAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2pdOwogICAgICBpZiAocHJlZGljYXRlcy5jaGVjayh2YWx1ZSwgaikpIHsKICAgICAgICBmaWx0ZXJlZC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZpbHRlcmVkOwogIH07Cn0KCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGN1cnJlbmN5CiAqIEBraW5kIGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBGb3JtYXRzIGEgbnVtYmVyIGFzIGEgY3VycmVuY3kgKGllICQxLDIzNC41NikuIFdoZW4gbm8gY3VycmVuY3kgc3ltYm9sIGlzIHByb3ZpZGVkLCBkZWZhdWx0CiAqIHN5bWJvbCBmb3IgY3VycmVudCBsb2NhbGUgaXMgdXNlZC4KICoKICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCBJbnB1dCB0byBmaWx0ZXIuCiAqIEBwYXJhbSB7c3RyaW5nPX0gc3ltYm9sIEN1cnJlbmN5IHN5bWJvbCBvciBpZGVudGlmaWVyIHRvIGJlIGRpc3BsYXllZC4KICogQHBhcmFtIHtudW1iZXI9fSBmcmFjdGlvblNpemUgTnVtYmVyIG9mIGRlY2ltYWwgcGxhY2VzIHRvIHJvdW5kIHRoZSBhbW91bnQgdG8uCiAqIEByZXR1cm5zIHtzdHJpbmd9IEZvcm1hdHRlZCBudW1iZXIuCiAqCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0iY3VycmVuY3lFeGFtcGxlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCdjdXJyZW5jeUV4YW1wbGUnLCBbXSkKICAgICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLmFtb3VudCA9IDEyMzQuNTY7CiAgICAgICAgICAgfV0pOwogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgPGlucHV0IHR5cGU9Im51bWJlciIgbmctbW9kZWw9ImFtb3VudCI+IDxicj4KICAgICAgICAgZGVmYXVsdCBjdXJyZW5jeSBzeW1ib2wgKCQpOiA8c3BhbiBpZD0iY3VycmVuY3ktZGVmYXVsdCI+e3thbW91bnQgfCBjdXJyZW5jeX19PC9zcGFuPjxicj4KICAgICAgICAgY3VzdG9tIGN1cnJlbmN5IGlkZW50aWZpZXIgKFVTRCQpOiA8c3BhbiBpZD0iY3VycmVuY3ktY3VzdG9tIj57e2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIn19PC9zcGFuPgogICAgICAgICBubyBmcmFjdGlvbnMgKDApOiA8c3BhbiBpZD0iY3VycmVuY3ktbm8tZnJhY3Rpb25zIj57e2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIjowfX08L3NwYW4+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGluaXQgd2l0aCAxMjM0LjU2JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdjdXJyZW5jeS1kZWZhdWx0JykpLmdldFRleHQoKSkudG9CZSgnJDEsMjM0LjU2Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdjdXJyZW5jeS1jdXN0b20nKSkuZ2V0VGV4dCgpKS50b0JlKCdVU0QkMSwyMzQuNTYnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2N1cnJlbmN5LW5vLWZyYWN0aW9ucycpKS5nZXRUZXh0KCkpLnRvQmUoJ1VTRCQxLDIzNScpOwogICAgICAgfSk7CiAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBpZiAoYnJvd3Nlci5wYXJhbXMuYnJvd3NlciA9PSAnc2FmYXJpJykgewogICAgICAgICAgIC8vIFNhZmFyaSBkb2VzIG5vdCB1bmRlcnN0YW5kIHRoZSBtaW51cyBrZXkuIFNlZQogICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL3Byb3RyYWN0b3IvaXNzdWVzLzQ4MQogICAgICAgICAgIHJldHVybjsKICAgICAgICAgfQogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdhbW91bnQnKSkuY2xlYXIoKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnYW1vdW50JykpLnNlbmRLZXlzKCctMTIzNCcpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnY3VycmVuY3ktZGVmYXVsdCcpKS5nZXRUZXh0KCkpLnRvQmUoJygkMSwyMzQuMDApJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdjdXJyZW5jeS1jdXN0b20nKSkuZ2V0VGV4dCgpKS50b0JlKCcoVVNEJDEsMjM0LjAwKScpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnY3VycmVuY3ktbm8tZnJhY3Rpb25zJykpLmdldFRleHQoKSkudG9CZSgnKFVTRCQxLDIzNCknKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KY3VycmVuY3lGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwpmdW5jdGlvbiBjdXJyZW5jeUZpbHRlcigkbG9jYWxlKSB7CiAgdmFyIGZvcm1hdHMgPSAkbG9jYWxlLk5VTUJFUl9GT1JNQVRTOwogIHJldHVybiBmdW5jdGlvbihhbW91bnQsIGN1cnJlbmN5U3ltYm9sLCBmcmFjdGlvblNpemUpewogICAgaWYgKGlzVW5kZWZpbmVkKGN1cnJlbmN5U3ltYm9sKSkgewogICAgICBjdXJyZW5jeVN5bWJvbCA9IGZvcm1hdHMuQ1VSUkVOQ1lfU1lNOwogICAgfQoKICAgIGlmIChpc1VuZGVmaW5lZChmcmFjdGlvblNpemUpKSB7CiAgICAgIC8vIFRPRE86IHJlYWQgdGhlIGRlZmF1bHQgdmFsdWUgZnJvbSB0aGUgbG9jYWxlIGZpbGUKICAgICAgZnJhY3Rpb25TaXplID0gMjsKICAgIH0KCiAgICAvLyBpZiBudWxsIG9yIHVuZGVmaW5lZCBwYXNzIGl0IHRocm91Z2gKICAgIHJldHVybiAoYW1vdW50ID09IG51bGwpCiAgICAgICAgPyBhbW91bnQKICAgICAgICA6IGZvcm1hdE51bWJlcihhbW91bnQsIGZvcm1hdHMuUEFUVEVSTlNbMV0sIGZvcm1hdHMuR1JPVVBfU0VQLCBmb3JtYXRzLkRFQ0lNQUxfU0VQLCBmcmFjdGlvblNpemUpLgogICAgICAgICAgICByZXBsYWNlKC9cdTAwQTQvZywgY3VycmVuY3lTeW1ib2wpOwogIH07Cn0KCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIG51bWJlcgogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogRm9ybWF0cyBhIG51bWJlciBhcyB0ZXh0LgogKgogKiBJZiB0aGUgaW5wdXQgaXMgbm90IGEgbnVtYmVyIGFuIGVtcHR5IHN0cmluZyBpcyByZXR1cm5lZC4KICoKICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSBudW1iZXIgTnVtYmVyIHRvIGZvcm1hdC4KICogQHBhcmFtIHsobnVtYmVyfHN0cmluZyk9fSBmcmFjdGlvblNpemUgTnVtYmVyIG9mIGRlY2ltYWwgcGxhY2VzIHRvIHJvdW5kIHRoZSBudW1iZXIgdG8uCiAqIElmIHRoaXMgaXMgbm90IHByb3ZpZGVkIHRoZW4gdGhlIGZyYWN0aW9uIHNpemUgaXMgY29tcHV0ZWQgZnJvbSB0aGUgY3VycmVudCBsb2NhbGUncyBudW1iZXIKICogZm9ybWF0dGluZyBwYXR0ZXJuLiBJbiB0aGUgY2FzZSBvZiB0aGUgZGVmYXVsdCBsb2NhbGUsIGl0IHdpbGwgYmUgMy4KICogQHJldHVybnMge3N0cmluZ30gTnVtYmVyIHJvdW5kZWQgdG8gZGVjaW1hbFBsYWNlcyBhbmQgcGxhY2VzIGEg4oCcLOKAnSBhZnRlciBlYWNoIHRoaXJkIGRpZ2l0LgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9Im51bWJlckZpbHRlckV4YW1wbGUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ251bWJlckZpbHRlckV4YW1wbGUnLCBbXSkKICAgICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnZhbCA9IDEyMzQuNTY3ODk7CiAgICAgICAgICAgfV0pOwogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgRW50ZXIgbnVtYmVyOiA8aW5wdXQgbmctbW9kZWw9J3ZhbCc+PGJyPgogICAgICAgICBEZWZhdWx0IGZvcm1hdHRpbmc6IDxzcGFuIGlkPSdudW1iZXItZGVmYXVsdCc+e3t2YWwgfCBudW1iZXJ9fTwvc3Bhbj48YnI+CiAgICAgICAgIE5vIGZyYWN0aW9uczogPHNwYW4+e3t2YWwgfCBudW1iZXI6MH19PC9zcGFuPjxicj4KICAgICAgICAgTmVnYXRpdmUgbnVtYmVyOiA8c3Bhbj57ey12YWwgfCBudW1iZXI6NH19PC9zcGFuPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBmb3JtYXQgbnVtYmVycycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbnVtYmVyLWRlZmF1bHQnKSkuZ2V0VGV4dCgpKS50b0JlKCcxLDIzNC41NjgnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygndmFsIHwgbnVtYmVyOjAnKSkuZ2V0VGV4dCgpKS50b0JlKCcxLDIzNScpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCctdmFsIHwgbnVtYmVyOjQnKSkuZ2V0VGV4dCgpKS50b0JlKCctMSwyMzQuNTY3OScpOwogICAgICAgfSk7CgogICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsJykpLmNsZWFyKCk7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3ZhbCcpKS5zZW5kS2V5cygnMzM3NC4zMzMnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ251bWJlci1kZWZhdWx0JykpLmdldFRleHQoKSkudG9CZSgnMywzNzQuMzMzJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3ZhbCB8IG51bWJlcjowJykpLmdldFRleHQoKSkudG9CZSgnMywzNzQnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnLXZhbCB8IG51bWJlcjo0JykpLmdldFRleHQoKSkudG9CZSgnLTMsMzc0LjMzMzAnKTsKICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKCm51bWJlckZpbHRlci4kaW5qZWN0ID0gWyckbG9jYWxlJ107CmZ1bmN0aW9uIG51bWJlckZpbHRlcigkbG9jYWxlKSB7CiAgdmFyIGZvcm1hdHMgPSAkbG9jYWxlLk5VTUJFUl9GT1JNQVRTOwogIHJldHVybiBmdW5jdGlvbihudW1iZXIsIGZyYWN0aW9uU2l6ZSkgewoKICAgIC8vIGlmIG51bGwgb3IgdW5kZWZpbmVkIHBhc3MgaXQgdGhyb3VnaAogICAgcmV0dXJuIChudW1iZXIgPT0gbnVsbCkKICAgICAgICA/IG51bWJlcgogICAgICAgIDogZm9ybWF0TnVtYmVyKG51bWJlciwgZm9ybWF0cy5QQVRURVJOU1swXSwgZm9ybWF0cy5HUk9VUF9TRVAsIGZvcm1hdHMuREVDSU1BTF9TRVAsCiAgICAgICAgICAgICAgICAgICAgICAgZnJhY3Rpb25TaXplKTsKICB9Owp9Cgp2YXIgREVDSU1BTF9TRVAgPSAnLic7CmZ1bmN0aW9uIGZvcm1hdE51bWJlcihudW1iZXIsIHBhdHRlcm4sIGdyb3VwU2VwLCBkZWNpbWFsU2VwLCBmcmFjdGlvblNpemUpIHsKICBpZiAoIWlzRmluaXRlKG51bWJlcikgfHwgaXNPYmplY3QobnVtYmVyKSkgcmV0dXJuICcnOwoKICB2YXIgaXNOZWdhdGl2ZSA9IG51bWJlciA8IDA7CiAgbnVtYmVyID0gTWF0aC5hYnMobnVtYmVyKTsKICB2YXIgbnVtU3RyID0gbnVtYmVyICsgJycsCiAgICAgIGZvcm1hdGVkVGV4dCA9ICcnLAogICAgICBwYXJ0cyA9IFtdOwoKICB2YXIgaGFzRXhwb25lbnQgPSBmYWxzZTsKICBpZiAobnVtU3RyLmluZGV4T2YoJ2UnKSAhPT0gLTEpIHsKICAgIHZhciBtYXRjaCA9IG51bVN0ci5tYXRjaCgvKFtcZFwuXSspZSgtPykoXGQrKS8pOwogICAgaWYgKG1hdGNoICYmIG1hdGNoWzJdID09ICctJyAmJiBtYXRjaFszXSA+IGZyYWN0aW9uU2l6ZSArIDEpIHsKICAgICAgbnVtU3RyID0gJzAnOwogICAgICBudW1iZXIgPSAwOwogICAgfSBlbHNlIHsKICAgICAgZm9ybWF0ZWRUZXh0ID0gbnVtU3RyOwogICAgICBoYXNFeHBvbmVudCA9IHRydWU7CiAgICB9CiAgfQoKICBpZiAoIWhhc0V4cG9uZW50KSB7CiAgICB2YXIgZnJhY3Rpb25MZW4gPSAobnVtU3RyLnNwbGl0KERFQ0lNQUxfU0VQKVsxXSB8fCAnJykubGVuZ3RoOwoKICAgIC8vIGRldGVybWluZSBmcmFjdGlvblNpemUgaWYgaXQgaXMgbm90IHNwZWNpZmllZAogICAgaWYgKGlzVW5kZWZpbmVkKGZyYWN0aW9uU2l6ZSkpIHsKICAgICAgZnJhY3Rpb25TaXplID0gTWF0aC5taW4oTWF0aC5tYXgocGF0dGVybi5taW5GcmFjLCBmcmFjdGlvbkxlbiksIHBhdHRlcm4ubWF4RnJhYyk7CiAgICB9CgogICAgLy8gc2FmZWx5IHJvdW5kIG51bWJlcnMgaW4gSlMgd2l0aG91dCBoaXR0aW5nIGltcHJlY2lzaW9ucyBvZiBmbG9hdGluZy1wb2ludCBhcml0aG1ldGljcwogICAgLy8gaW5zcGlyZWQgYnk6CiAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9NYXRoL3JvdW5kCiAgICBudW1iZXIgPSArKE1hdGgucm91bmQoKyhudW1iZXIudG9TdHJpbmcoKSArICdlJyArIGZyYWN0aW9uU2l6ZSkpLnRvU3RyaW5nKCkgKyAnZScgKyAtZnJhY3Rpb25TaXplKTsKCiAgICBpZiAobnVtYmVyID09PSAwKSB7CiAgICAgIGlzTmVnYXRpdmUgPSBmYWxzZTsKICAgIH0KCiAgICB2YXIgZnJhY3Rpb24gPSAoJycgKyBudW1iZXIpLnNwbGl0KERFQ0lNQUxfU0VQKTsKICAgIHZhciB3aG9sZSA9IGZyYWN0aW9uWzBdOwogICAgZnJhY3Rpb24gPSBmcmFjdGlvblsxXSB8fCAnJzsKCiAgICB2YXIgaSwgcG9zID0gMCwKICAgICAgICBsZ3JvdXAgPSBwYXR0ZXJuLmxnU2l6ZSwKICAgICAgICBncm91cCA9IHBhdHRlcm4uZ1NpemU7CgogICAgaWYgKHdob2xlLmxlbmd0aCA+PSAobGdyb3VwICsgZ3JvdXApKSB7CiAgICAgIHBvcyA9IHdob2xlLmxlbmd0aCAtIGxncm91cDsKICAgICAgZm9yIChpID0gMDsgaSA8IHBvczsgaSsrKSB7CiAgICAgICAgaWYgKChwb3MgLSBpKSVncm91cCA9PT0gMCAmJiBpICE9PSAwKSB7CiAgICAgICAgICBmb3JtYXRlZFRleHQgKz0gZ3JvdXBTZXA7CiAgICAgICAgfQogICAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICAgIH0KICAgIH0KCiAgICBmb3IgKGkgPSBwb3M7IGkgPCB3aG9sZS5sZW5ndGg7IGkrKykgewogICAgICBpZiAoKHdob2xlLmxlbmd0aCAtIGkpJWxncm91cCA9PT0gMCAmJiBpICE9PSAwKSB7CiAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IGdyb3VwU2VwOwogICAgICB9CiAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICB9CgogICAgLy8gZm9ybWF0IGZyYWN0aW9uIHBhcnQuCiAgICB3aGlsZShmcmFjdGlvbi5sZW5ndGggPCBmcmFjdGlvblNpemUpIHsKICAgICAgZnJhY3Rpb24gKz0gJzAnOwogICAgfQoKICAgIGlmIChmcmFjdGlvblNpemUgJiYgZnJhY3Rpb25TaXplICE9PSAiMCIpIGZvcm1hdGVkVGV4dCArPSBkZWNpbWFsU2VwICsgZnJhY3Rpb24uc3Vic3RyKDAsIGZyYWN0aW9uU2l6ZSk7CiAgfSBlbHNlIHsKCiAgICBpZiAoZnJhY3Rpb25TaXplID4gMCAmJiBudW1iZXIgPiAtMSAmJiBudW1iZXIgPCAxKSB7CiAgICAgIGZvcm1hdGVkVGV4dCA9IG51bWJlci50b0ZpeGVkKGZyYWN0aW9uU2l6ZSk7CiAgICB9CiAgfQoKICBwYXJ0cy5wdXNoKGlzTmVnYXRpdmUgPyBwYXR0ZXJuLm5lZ1ByZSA6IHBhdHRlcm4ucG9zUHJlKTsKICBwYXJ0cy5wdXNoKGZvcm1hdGVkVGV4dCk7CiAgcGFydHMucHVzaChpc05lZ2F0aXZlID8gcGF0dGVybi5uZWdTdWYgOiBwYXR0ZXJuLnBvc1N1Zik7CiAgcmV0dXJuIHBhcnRzLmpvaW4oJycpOwp9CgpmdW5jdGlvbiBwYWROdW1iZXIobnVtLCBkaWdpdHMsIHRyaW0pIHsKICB2YXIgbmVnID0gJyc7CiAgaWYgKG51bSA8IDApIHsKICAgIG5lZyA9ICAnLSc7CiAgICBudW0gPSAtbnVtOwogIH0KICBudW0gPSAnJyArIG51bTsKICB3aGlsZShudW0ubGVuZ3RoIDwgZGlnaXRzKSBudW0gPSAnMCcgKyBudW07CiAgaWYgKHRyaW0pCiAgICBudW0gPSBudW0uc3Vic3RyKG51bS5sZW5ndGggLSBkaWdpdHMpOwogIHJldHVybiBuZWcgKyBudW07Cn0KCgpmdW5jdGlvbiBkYXRlR2V0dGVyKG5hbWUsIHNpemUsIG9mZnNldCwgdHJpbSkgewogIG9mZnNldCA9IG9mZnNldCB8fCAwOwogIHJldHVybiBmdW5jdGlvbihkYXRlKSB7CiAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKICAgIGlmIChvZmZzZXQgPiAwIHx8IHZhbHVlID4gLW9mZnNldCkKICAgICAgdmFsdWUgKz0gb2Zmc2V0OwogICAgaWYgKHZhbHVlID09PSAwICYmIG9mZnNldCA9PSAtMTIgKSB2YWx1ZSA9IDEyOwogICAgcmV0dXJuIHBhZE51bWJlcih2YWx1ZSwgc2l6ZSwgdHJpbSk7CiAgfTsKfQoKZnVuY3Rpb24gZGF0ZVN0ckdldHRlcihuYW1lLCBzaG9ydEZvcm0pIHsKICByZXR1cm4gZnVuY3Rpb24oZGF0ZSwgZm9ybWF0cykgewogICAgdmFyIHZhbHVlID0gZGF0ZVsnZ2V0JyArIG5hbWVdKCk7CiAgICB2YXIgZ2V0ID0gdXBwZXJjYXNlKHNob3J0Rm9ybSA/ICgnU0hPUlQnICsgbmFtZSkgOiBuYW1lKTsKCiAgICByZXR1cm4gZm9ybWF0c1tnZXRdW3ZhbHVlXTsKICB9Owp9CgpmdW5jdGlvbiB0aW1lWm9uZUdldHRlcihkYXRlKSB7CiAgdmFyIHpvbmUgPSAtMSAqIGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICB2YXIgcGFkZGVkWm9uZSA9ICh6b25lID49IDApID8gIisiIDogIiI7CgogIHBhZGRlZFpvbmUgKz0gcGFkTnVtYmVyKE1hdGhbem9uZSA+IDAgPyAnZmxvb3InIDogJ2NlaWwnXSh6b25lIC8gNjApLCAyKSArCiAgICAgICAgICAgICAgICBwYWROdW1iZXIoTWF0aC5hYnMoem9uZSAlIDYwKSwgMik7CgogIHJldHVybiBwYWRkZWRab25lOwp9CgpmdW5jdGlvbiBnZXRGaXJzdFRodXJzZGF5T2ZZZWFyKHllYXIpIHsKICAgIC8vIDAgPSBpbmRleCBvZiBKYW51YXJ5CiAgICB2YXIgZGF5T2ZXZWVrT25GaXJzdCA9IChuZXcgRGF0ZSh5ZWFyLCAwLCAxKSkuZ2V0RGF5KCk7CiAgICAvLyA0ID0gaW5kZXggb2YgVGh1cnNkYXkgKCsxIHRvIGFjY291bnQgZm9yIDFzdCA9IDUpCiAgICAvLyAxMSA9IGluZGV4IG9mICpuZXh0KiBUaHVyc2RheSAoKzEgYWNjb3VudCBmb3IgMXN0ID0gMTIpCiAgICByZXR1cm4gbmV3IERhdGUoeWVhciwgMCwgKChkYXlPZldlZWtPbkZpcnN0IDw9IDQpID8gNSA6IDEyKSAtIGRheU9mV2Vla09uRmlyc3QpOwp9CgpmdW5jdGlvbiBnZXRUaHVyc2RheVRoaXNXZWVrKGRhdGV0aW1lKSB7CiAgICByZXR1cm4gbmV3IERhdGUoZGF0ZXRpbWUuZ2V0RnVsbFllYXIoKSwgZGF0ZXRpbWUuZ2V0TW9udGgoKSwKICAgICAgLy8gNCA9IGluZGV4IG9mIFRodXJzZGF5CiAgICAgIGRhdGV0aW1lLmdldERhdGUoKSArICg0IC0gZGF0ZXRpbWUuZ2V0RGF5KCkpKTsKfQoKZnVuY3Rpb24gd2Vla0dldHRlcihzaXplKSB7CiAgIHJldHVybiBmdW5jdGlvbihkYXRlKSB7CiAgICAgIHZhciBmaXJzdFRodXJzID0gZ2V0Rmlyc3RUaHVyc2RheU9mWWVhcihkYXRlLmdldEZ1bGxZZWFyKCkpLAogICAgICAgICB0aGlzVGh1cnMgPSBnZXRUaHVyc2RheVRoaXNXZWVrKGRhdGUpOwoKICAgICAgdmFyIGRpZmYgPSArdGhpc1RodXJzIC0gK2ZpcnN0VGh1cnMsCiAgICAgICAgIHJlc3VsdCA9IDEgKyBNYXRoLnJvdW5kKGRpZmYgLyA2LjA0OGU4KTsgLy8gNi4wNDhlOCBtcyBwZXIgd2VlawoKICAgICAgcmV0dXJuIHBhZE51bWJlcihyZXN1bHQsIHNpemUpOwogICB9Owp9CgpmdW5jdGlvbiBhbXBtR2V0dGVyKGRhdGUsIGZvcm1hdHMpIHsKICByZXR1cm4gZGF0ZS5nZXRIb3VycygpIDwgMTIgPyBmb3JtYXRzLkFNUE1TWzBdIDogZm9ybWF0cy5BTVBNU1sxXTsKfQoKdmFyIERBVEVfRk9STUFUUyA9IHsKICB5eXl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDQpLAogICAgeXk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMiwgMCwgdHJ1ZSksCiAgICAgeTogZGF0ZUdldHRlcignRnVsbFllYXInLCAxKSwKICBNTU1NOiBkYXRlU3RyR2V0dGVyKCdNb250aCcpLAogICBNTU06IGRhdGVTdHJHZXR0ZXIoJ01vbnRoJywgdHJ1ZSksCiAgICBNTTogZGF0ZUdldHRlcignTW9udGgnLCAyLCAxKSwKICAgICBNOiBkYXRlR2V0dGVyKCdNb250aCcsIDEsIDEpLAogICAgZGQ6IGRhdGVHZXR0ZXIoJ0RhdGUnLCAyKSwKICAgICBkOiBkYXRlR2V0dGVyKCdEYXRlJywgMSksCiAgICBISDogZGF0ZUdldHRlcignSG91cnMnLCAyKSwKICAgICBIOiBkYXRlR2V0dGVyKCdIb3VycycsIDEpLAogICAgaGg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMiwgLTEyKSwKICAgICBoOiBkYXRlR2V0dGVyKCdIb3VycycsIDEsIC0xMiksCiAgICBtbTogZGF0ZUdldHRlcignTWludXRlcycsIDIpLAogICAgIG06IGRhdGVHZXR0ZXIoJ01pbnV0ZXMnLCAxKSwKICAgIHNzOiBkYXRlR2V0dGVyKCdTZWNvbmRzJywgMiksCiAgICAgczogZGF0ZUdldHRlcignU2Vjb25kcycsIDEpLAogICAgIC8vIHdoaWxlIElTTyA4NjAxIHJlcXVpcmVzIGZyYWN0aW9ucyB0byBiZSBwcmVmaXhlZCB3aXRoIGAuYCBvciBgLGAKICAgICAvLyB3ZSBjYW4gYmUganVzdCBzYWZlbHkgcmVseSBvbiB1c2luZyBgc3NzYCBzaW5jZSB3ZSBjdXJyZW50bHkgZG9uJ3Qgc3VwcG9ydCBzaW5nbGUgb3IgdHdvIGRpZ2l0IGZyYWN0aW9ucwogICBzc3M6IGRhdGVHZXR0ZXIoJ01pbGxpc2Vjb25kcycsIDMpLAogIEVFRUU6IGRhdGVTdHJHZXR0ZXIoJ0RheScpLAogICBFRUU6IGRhdGVTdHJHZXR0ZXIoJ0RheScsIHRydWUpLAogICAgIGE6IGFtcG1HZXR0ZXIsCiAgICAgWjogdGltZVpvbmVHZXR0ZXIsCiAgICB3dzogd2Vla0dldHRlcigyKSwKICAgICB3OiB3ZWVrR2V0dGVyKDEpCn07Cgp2YXIgREFURV9GT1JNQVRTX1NQTElUID0gLygoPzpbXnlNZEhobXNhWkV3J10rKXwoPzonKD86W14nXXwnJykqJyl8KD86RSt8eSt8TSt8ZCt8SCt8aCt8bSt8cyt8YXxafHcrKSkoLiopLywKICAgIE5VTUJFUl9TVFJJTkcgPSAvXlwtP1xkKyQvOwoKLyoqCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgZGF0ZQogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogICBGb3JtYXRzIGBkYXRlYCB0byBhIHN0cmluZyBiYXNlZCBvbiB0aGUgcmVxdWVzdGVkIGBmb3JtYXRgLgogKgogKiAgIGBmb3JtYXRgIHN0cmluZyBjYW4gYmUgY29tcG9zZWQgb2YgdGhlIGZvbGxvd2luZyBlbGVtZW50czoKICoKICogICAqIGAneXl5eSdgOiA0IGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIgKGUuZy4gQUQgMSA9PiAwMDAxLCBBRCAyMDEwID0+IDIwMTApCiAqICAgKiBgJ3l5J2A6IDIgZGlnaXQgcmVwcmVzZW50YXRpb24gb2YgeWVhciwgcGFkZGVkICgwMC05OSkuIChlLmcuIEFEIDIwMDEgPT4gMDEsIEFEIDIwMTAgPT4gMTApCiAqICAgKiBgJ3knYDogMSBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyLCBlLmcuIChBRCAxID0+IDEsIEFEIDE5OSA9PiAxOTkpCiAqICAgKiBgJ01NTU0nYDogTW9udGggaW4geWVhciAoSmFudWFyeS1EZWNlbWJlcikKICogICAqIGAnTU1NJ2A6IE1vbnRoIGluIHllYXIgKEphbi1EZWMpCiAqICAgKiBgJ01NJ2A6IE1vbnRoIGluIHllYXIsIHBhZGRlZCAoMDEtMTIpCiAqICAgKiBgJ00nYDogTW9udGggaW4geWVhciAoMS0xMikKICogICAqIGAnZGQnYDogRGF5IGluIG1vbnRoLCBwYWRkZWQgKDAxLTMxKQogKiAgICogYCdkJ2A6IERheSBpbiBtb250aCAoMS0zMSkKICogICAqIGAnRUVFRSdgOiBEYXkgaW4gV2VlaywoU3VuZGF5LVNhdHVyZGF5KQogKiAgICogYCdFRUUnYDogRGF5IGluIFdlZWssIChTdW4tU2F0KQogKiAgICogYCdISCdgOiBIb3VyIGluIGRheSwgcGFkZGVkICgwMC0yMykKICogICAqIGAnSCdgOiBIb3VyIGluIGRheSAoMC0yMykKICogICAqIGAnaGgnYDogSG91ciBpbiBBTS9QTSwgcGFkZGVkICgwMS0xMikKICogICAqIGAnaCdgOiBIb3VyIGluIEFNL1BNLCAoMS0xMikKICogICAqIGAnbW0nYDogTWludXRlIGluIGhvdXIsIHBhZGRlZCAoMDAtNTkpCiAqICAgKiBgJ20nYDogTWludXRlIGluIGhvdXIgKDAtNTkpCiAqICAgKiBgJ3NzJ2A6IFNlY29uZCBpbiBtaW51dGUsIHBhZGRlZCAoMDAtNTkpCiAqICAgKiBgJ3MnYDogU2Vjb25kIGluIG1pbnV0ZSAoMC01OSkKICogICAqIGAnLnNzcycgb3IgJyxzc3MnYDogTWlsbGlzZWNvbmQgaW4gc2Vjb25kLCBwYWRkZWQgKDAwMC05OTkpCiAqICAgKiBgJ2EnYDogQU0vUE0gbWFya2VyCiAqICAgKiBgJ1onYDogNCBkaWdpdCAoK3NpZ24pIHJlcHJlc2VudGF0aW9uIG9mIHRoZSB0aW1lem9uZSBvZmZzZXQgKC0xMjAwLSsxMjAwKQogKiAgICogYCd3dydgOiBJU08tODYwMSB3ZWVrIG9mIHllYXIgKDAwLTUzKQogKiAgICogYCd3J2A6IElTTy04NjAxIHdlZWsgb2YgeWVhciAoMC01MykKICoKICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGFsc28gYmUgb25lIG9mIHRoZSBmb2xsb3dpbmcgcHJlZGVmaW5lZAogKiAgIHtAbGluayBndWlkZS9pMThuIGxvY2FsaXphYmxlIGZvcm1hdHN9OgogKgogKiAgICogYCdtZWRpdW0nYDogZXF1aXZhbGVudCB0byBgJ01NTSBkLCB5IGg6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUKICogICAgIChlLmcuIFNlcCAzLCAyMDEwIDEyOjA1OjA4IFBNKQogKiAgICogYCdzaG9ydCdgOiBlcXVpdmFsZW50IHRvIGAnTS9kL3l5IGg6bW0gYSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIDkvMy8xMCAxMjowNSBQTSkKICogICAqIGAnZnVsbERhdGUnYDogZXF1aXZhbGVudCB0byBgJ0VFRUUsIE1NTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlCiAqICAgICAoZS5nLiBGcmlkYXksIFNlcHRlbWJlciAzLCAyMDEwKQogKiAgICogYCdsb25nRGF0ZSdgOiBlcXVpdmFsZW50IHRvIGAnTU1NTSBkLCB5J2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gU2VwdGVtYmVyIDMsIDIwMTApCiAqICAgKiBgJ21lZGl1bURhdGUnYDogZXF1aXZhbGVudCB0byBgJ01NTSBkLCB5J2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gU2VwIDMsIDIwMTApCiAqICAgKiBgJ3Nob3J0RGF0ZSdgOiBlcXVpdmFsZW50IHRvIGAnTS9kL3l5J2AgZm9yIGVuX1VTIGxvY2FsZSAoZS5nLiA5LzMvMTApCiAqICAgKiBgJ21lZGl1bVRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDU6MDggUE0pCiAqICAgKiBgJ3Nob3J0VGltZSdgOiBlcXVpdmFsZW50IHRvIGAnaDptbSBhJ2AgZm9yIGVuX1VTIGxvY2FsZSAoZS5nLiAxMjowNSBQTSkKICoKICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGNvbnRhaW4gbGl0ZXJhbCB2YWx1ZXMuIFRoZXNlIG5lZWQgdG8gYmUgZXNjYXBlZCBieSBzdXJyb3VuZGluZyB3aXRoIHNpbmdsZSBxdW90ZXMgKGUuZy4KICogICBgImggJ2luIHRoZSBtb3JuaW5nJyJgKS4gSW4gb3JkZXIgdG8gb3V0cHV0IGEgc2luZ2xlIHF1b3RlLCBlc2NhcGUgaXQgLSBpLmUuLCB0d28gc2luZ2xlIHF1b3RlcyBpbiBhIHNlcXVlbmNlCiAqICAgKGUuZy4gYCJoICdvJydjbG9jayciYCkuCiAqCiAqIEBwYXJhbSB7KERhdGV8bnVtYmVyfHN0cmluZyl9IGRhdGUgRGF0ZSB0byBmb3JtYXQgZWl0aGVyIGFzIERhdGUgb2JqZWN0LCBtaWxsaXNlY29uZHMgKHN0cmluZyBvcgogKiAgICBudW1iZXIpIG9yIHZhcmlvdXMgSVNPIDg2MDEgZGF0ZXRpbWUgc3RyaW5nIGZvcm1hdHMgKGUuZy4geXl5eS1NTS1kZFRISDptbTpzcy5zc3NaIGFuZCBpdHMKICogICAgc2hvcnRlciB2ZXJzaW9ucyBsaWtlIHl5eXktTU0tZGRUSEg6bW1aLCB5eXl5LU1NLWRkIG9yIHl5eXlNTWRkVEhIbW1zc1opLiBJZiBubyB0aW1lem9uZSBpcwogKiAgICBzcGVjaWZpZWQgaW4gdGhlIHN0cmluZyBpbnB1dCwgdGhlIHRpbWUgaXMgY29uc2lkZXJlZCB0byBiZSBpbiB0aGUgbG9jYWwgdGltZXpvbmUuCiAqIEBwYXJhbSB7c3RyaW5nPX0gZm9ybWF0IEZvcm1hdHRpbmcgcnVsZXMgKHNlZSBEZXNjcmlwdGlvbikuIElmIG5vdCBzcGVjaWZpZWQsCiAqICAgIGBtZWRpdW1EYXRlYCBpcyB1c2VkLgogKiBAcGFyYW0ge3N0cmluZz19IHRpbWV6b25lIFRpbWV6b25lIHRvIGJlIHVzZWQgZm9yIGZvcm1hdHRpbmcuIFJpZ2h0IG5vdywgb25seSBgJ1VUQydgIGlzIHN1cHBvcnRlZC4KICogICAgSWYgbm90IHNwZWNpZmllZCwgdGhlIHRpbWV6b25lIG9mIHRoZSBicm93c2VyIHdpbGwgYmUgdXNlZC4KICogQHJldHVybnMge3N0cmluZ30gRm9ybWF0dGVkIHN0cmluZyBvciB0aGUgaW5wdXQgaWYgaW5wdXQgaXMgbm90IHJlY29nbml6ZWQgYXMgZGF0ZS9taWxsaXMuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSd9fTwvc3Bhbj46CiAgICAgICAgICAgPHNwYW4+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZTonbWVkaXVtJ319PC9zcGFuPjxicj4KICAgICAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonfX08L3NwYW4+OgogICAgICAgICAgPHNwYW4+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJ319PC9zcGFuPjxicj4KICAgICAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnfX08L3NwYW4+OgogICAgICAgICAgPHNwYW4+e3snMTI4ODMyMzYyMzAwNicgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnfX08L3NwYW4+PGJyPgogICAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6Ik1NL2RkL3l5eXkgJ2F0JyBoOm1tYSJ9fTwvc3Bhbj46CiAgICAgICAgICA8c3Bhbj57eycxMjg4MzIzNjIzMDA2JyB8IGRhdGU6Ik1NL2RkL3l5eXkgJ2F0JyBoOm1tYSJ9fTwvc3Bhbj48YnI+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBmb3JtYXQgZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCIxMjg4MzIzNjIzMDA2IHwgZGF0ZTonbWVkaXVtJyIpKS5nZXRUZXh0KCkpLgogICAgICAgICAgICB0b01hdGNoKC9PY3QgMlxkLCAyMDEwIFxkezEsMn06XGR7Mn06XGR7Mn0gKEFNfFBNKS8pOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCIxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJyIpKS5nZXRUZXh0KCkpLgogICAgICAgICAgICB0b01hdGNoKC8yMDEwXC0xMFwtMlxkIFxkezJ9OlxkezJ9OlxkezJ9IChcLXxcKyk/XGR7NH0vKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygiJzEyODgzMjM2MjMwMDYnIHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJyIpKS5nZXRUZXh0KCkpLgogICAgICAgICAgICB0b01hdGNoKC8xMFwvMlxkXC8yMDEwIEAgXGR7MSwyfTpcZHsyfShBTXxQTSkvKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygiJzEyODgzMjM2MjMwMDYnIHwgZGF0ZTpcIk1NL2RkL3l5eXkgJ2F0JyBoOm1tYVwiIikpLmdldFRleHQoKSkuCiAgICAgICAgICAgIHRvTWF0Y2goLzEwXC8yXGRcLzIwMTAgYXQgXGR7MSwyfTpcZHsyfShBTXxQTSkvKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KZGF0ZUZpbHRlci4kaW5qZWN0ID0gWyckbG9jYWxlJ107CmZ1bmN0aW9uIGRhdGVGaWx0ZXIoJGxvY2FsZSkgewoKCiAgdmFyIFJfSVNPODYwMV9TVFIgPSAvXihcZHs0fSktPyhcZFxkKS0/KFxkXGQpKD86VChcZFxkKSg/Ojo/KFxkXGQpKD86Oj8oXGRcZCkoPzpcLihcZCspKT8pPyk/KFp8KFsrLV0pKFxkXGQpOj8oXGRcZCkpPyk/JC87CiAgICAgICAgICAgICAgICAgICAgIC8vIDEgICAgICAgIDIgICAgICAgMyAgICAgICAgIDQgICAgICAgICAgNSAgICAgICAgICA2ICAgICAgICAgIDcgICAgICAgICAgOCAgOSAgICAgMTAgICAgICAxMQogIGZ1bmN0aW9uIGpzb25TdHJpbmdUb0RhdGUoc3RyaW5nKSB7CiAgICB2YXIgbWF0Y2g7CiAgICBpZiAobWF0Y2ggPSBzdHJpbmcubWF0Y2goUl9JU084NjAxX1NUUikpIHsKICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgwKSwKICAgICAgICAgIHR6SG91ciA9IDAsCiAgICAgICAgICB0ek1pbiAgPSAwLAogICAgICAgICAgZGF0ZVNldHRlciA9IG1hdGNoWzhdID8gZGF0ZS5zZXRVVENGdWxsWWVhciA6IGRhdGUuc2V0RnVsbFllYXIsCiAgICAgICAgICB0aW1lU2V0dGVyID0gbWF0Y2hbOF0gPyBkYXRlLnNldFVUQ0hvdXJzIDogZGF0ZS5zZXRIb3VyczsKCiAgICAgIGlmIChtYXRjaFs5XSkgewogICAgICAgIHR6SG91ciA9IGludChtYXRjaFs5XSArIG1hdGNoWzEwXSk7CiAgICAgICAgdHpNaW4gPSBpbnQobWF0Y2hbOV0gKyBtYXRjaFsxMV0pOwogICAgICB9CiAgICAgIGRhdGVTZXR0ZXIuY2FsbChkYXRlLCBpbnQobWF0Y2hbMV0pLCBpbnQobWF0Y2hbMl0pIC0gMSwgaW50KG1hdGNoWzNdKSk7CiAgICAgIHZhciBoID0gaW50KG1hdGNoWzRdfHwwKSAtIHR6SG91cjsKICAgICAgdmFyIG0gPSBpbnQobWF0Y2hbNV18fDApIC0gdHpNaW47CiAgICAgIHZhciBzID0gaW50KG1hdGNoWzZdfHwwKTsKICAgICAgdmFyIG1zID0gTWF0aC5yb3VuZChwYXJzZUZsb2F0KCcwLicgKyAobWF0Y2hbN118fDApKSAqIDEwMDApOwogICAgICB0aW1lU2V0dGVyLmNhbGwoZGF0ZSwgaCwgbSwgcywgbXMpOwogICAgICByZXR1cm4gZGF0ZTsKICAgIH0KICAgIHJldHVybiBzdHJpbmc7CiAgfQoKCiAgcmV0dXJuIGZ1bmN0aW9uKGRhdGUsIGZvcm1hdCwgdGltZXpvbmUpIHsKICAgIHZhciB0ZXh0ID0gJycsCiAgICAgICAgcGFydHMgPSBbXSwKICAgICAgICBmbiwgbWF0Y2g7CgogICAgZm9ybWF0ID0gZm9ybWF0IHx8ICdtZWRpdW1EYXRlJzsKICAgIGZvcm1hdCA9ICRsb2NhbGUuREFURVRJTUVfRk9STUFUU1tmb3JtYXRdIHx8IGZvcm1hdDsKICAgIGlmIChpc1N0cmluZyhkYXRlKSkgewogICAgICBkYXRlID0gTlVNQkVSX1NUUklORy50ZXN0KGRhdGUpID8gaW50KGRhdGUpIDoganNvblN0cmluZ1RvRGF0ZShkYXRlKTsKICAgIH0KCiAgICBpZiAoaXNOdW1iZXIoZGF0ZSkpIHsKICAgICAgZGF0ZSA9IG5ldyBEYXRlKGRhdGUpOwogICAgfQoKICAgIGlmICghaXNEYXRlKGRhdGUpKSB7CiAgICAgIHJldHVybiBkYXRlOwogICAgfQoKICAgIHdoaWxlKGZvcm1hdCkgewogICAgICBtYXRjaCA9IERBVEVfRk9STUFUU19TUExJVC5leGVjKGZvcm1hdCk7CiAgICAgIGlmIChtYXRjaCkgewogICAgICAgIHBhcnRzID0gY29uY2F0KHBhcnRzLCBtYXRjaCwgMSk7CiAgICAgICAgZm9ybWF0ID0gcGFydHMucG9wKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFydHMucHVzaChmb3JtYXQpOwogICAgICAgIGZvcm1hdCA9IG51bGw7CiAgICAgIH0KICAgIH0KCiAgICBpZiAodGltZXpvbmUgJiYgdGltZXpvbmUgPT09ICdVVEMnKSB7CiAgICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlLmdldFRpbWUoKSk7CiAgICAgIGRhdGUuc2V0TWludXRlcyhkYXRlLmdldE1pbnV0ZXMoKSArIGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKSk7CiAgICB9CiAgICBmb3JFYWNoKHBhcnRzLCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIGZuID0gREFURV9GT1JNQVRTW3ZhbHVlXTsKICAgICAgdGV4dCArPSBmbiA/IGZuKGRhdGUsICRsb2NhbGUuREFURVRJTUVfRk9STUFUUykKICAgICAgICAgICAgICAgICA6IHZhbHVlLnJlcGxhY2UoLyheJ3wnJCkvZywgJycpLnJlcGxhY2UoLycnL2csICInIik7CiAgICB9KTsKCiAgICByZXR1cm4gdGV4dDsKICB9Owp9CgoKLyoqCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUganNvbgogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogICBBbGxvd3MgeW91IHRvIGNvbnZlcnQgYSBKYXZhU2NyaXB0IG9iamVjdCBpbnRvIEpTT04gc3RyaW5nLgogKgogKiAgIFRoaXMgZmlsdGVyIGlzIG1vc3RseSB1c2VmdWwgZm9yIGRlYnVnZ2luZy4gV2hlbiB1c2luZyB0aGUgZG91YmxlIGN1cmx5IHt7dmFsdWV9fSBub3RhdGlvbgogKiAgIHRoZSBiaW5kaW5nIGlzIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIEpTT04uCiAqCiAqIEBwYXJhbSB7Kn0gb2JqZWN0IEFueSBKYXZhU2NyaXB0IG9iamVjdCAoaW5jbHVkaW5nIGFycmF5cyBhbmQgcHJpbWl0aXZlIHR5cGVzKSB0byBmaWx0ZXIuCiAqIEByZXR1cm5zIHtzdHJpbmd9IEpTT04gc3RyaW5nLgogKgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxwcmU+e3sgeyduYW1lJzondmFsdWUnfSB8IGpzb24gfX08L3ByZT4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGpzb25pZnkgZmlsdGVyZWQgb2JqZWN0cycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCJ7J25hbWUnOid2YWx1ZSd9IikpLmdldFRleHQoKSkudG9NYXRjaCgvXHtcbiAgIm5hbWUiOiA/InZhbHVlIlxufS8pOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqCiAqLwpmdW5jdGlvbiBqc29uRmlsdGVyKCkgewogIHJldHVybiBmdW5jdGlvbihvYmplY3QpIHsKICAgIHJldHVybiB0b0pzb24ob2JqZWN0LCB0cnVlKTsKICB9Owp9CgoKLyoqCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgbG93ZXJjYXNlCiAqIEBraW5kIGZ1bmN0aW9uCiAqIEBkZXNjcmlwdGlvbgogKiBDb252ZXJ0cyBzdHJpbmcgdG8gbG93ZXJjYXNlLgogKiBAc2VlIGFuZ3VsYXIubG93ZXJjYXNlCiAqLwp2YXIgbG93ZXJjYXNlRmlsdGVyID0gdmFsdWVGbihsb3dlcmNhc2UpOwoKCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIHVwcGVyY2FzZQogKiBAa2luZCBmdW5jdGlvbgogKiBAZGVzY3JpcHRpb24KICogQ29udmVydHMgc3RyaW5nIHRvIHVwcGVyY2FzZS4KICogQHNlZSBhbmd1bGFyLnVwcGVyY2FzZQogKi8KdmFyIHVwcGVyY2FzZUZpbHRlciA9IHZhbHVlRm4odXBwZXJjYXNlKTsKCi8qKgogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGxpbWl0VG8KICogQGtpbmQgZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIENyZWF0ZXMgYSBuZXcgYXJyYXkgb3Igc3RyaW5nIGNvbnRhaW5pbmcgb25seSBhIHNwZWNpZmllZCBudW1iZXIgb2YgZWxlbWVudHMuIFRoZSBlbGVtZW50cwogKiBhcmUgdGFrZW4gZnJvbSBlaXRoZXIgdGhlIGJlZ2lubmluZyBvciB0aGUgZW5kIG9mIHRoZSBzb3VyY2UgYXJyYXksIHN0cmluZyBvciBudW1iZXIsIGFzIHNwZWNpZmllZCBieQogKiB0aGUgdmFsdWUgYW5kIHNpZ24gKHBvc2l0aXZlIG9yIG5lZ2F0aXZlKSBvZiBgbGltaXRgLiBJZiBhIG51bWJlciBpcyB1c2VkIGFzIGlucHV0LCBpdCBpcwogKiBjb252ZXJ0ZWQgdG8gYSBzdHJpbmcuCiAqCiAqIEBwYXJhbSB7QXJyYXl8c3RyaW5nfG51bWJlcn0gaW5wdXQgU291cmNlIGFycmF5LCBzdHJpbmcgb3IgbnVtYmVyIHRvIGJlIGxpbWl0ZWQuCiAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gbGltaXQgVGhlIGxlbmd0aCBvZiB0aGUgcmV0dXJuZWQgYXJyYXkgb3Igc3RyaW5nLiBJZiB0aGUgYGxpbWl0YCBudW1iZXIKICogICAgIGlzIHBvc2l0aXZlLCBgbGltaXRgIG51bWJlciBvZiBpdGVtcyBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIHNvdXJjZSBhcnJheS9zdHJpbmcgYXJlIGNvcGllZC4KICogICAgIElmIHRoZSBudW1iZXIgaXMgbmVnYXRpdmUsIGBsaW1pdGAgbnVtYmVyICBvZiBpdGVtcyBmcm9tIHRoZSBlbmQgb2YgdGhlIHNvdXJjZSBhcnJheS9zdHJpbmcKICogICAgIGFyZSBjb3BpZWQuIFRoZSBgbGltaXRgIHdpbGwgYmUgdHJpbW1lZCBpZiBpdCBleGNlZWRzIGBhcnJheS5sZW5ndGhgCiAqIEByZXR1cm5zIHtBcnJheXxzdHJpbmd9IEEgbmV3IHN1Yi1hcnJheSBvciBzdWJzdHJpbmcgb2YgbGVuZ3RoIGBsaW1pdGAgb3IgbGVzcyBpZiBpbnB1dCBhcnJheQogKiAgICAgaGFkIGxlc3MgdGhhbiBgbGltaXRgIGVsZW1lbnRzLgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9ImxpbWl0VG9FeGFtcGxlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCdsaW1pdFRvRXhhbXBsZScsIFtdKQogICAgICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUubnVtYmVycyA9IFsxLDIsMyw0LDUsNiw3LDgsOV07CiAgICAgICAgICAgICAkc2NvcGUubGV0dGVycyA9ICJhYmNkZWZnaGkiOwogICAgICAgICAgICAgJHNjb3BlLmxvbmdOdW1iZXIgPSAyMzQ1NDMyMzQyOwogICAgICAgICAgICAgJHNjb3BlLm51bUxpbWl0ID0gMzsKICAgICAgICAgICAgICRzY29wZS5sZXR0ZXJMaW1pdCA9IDM7CiAgICAgICAgICAgICAkc2NvcGUubG9uZ051bWJlckxpbWl0ID0gMzsKICAgICAgICAgICB9XSk7CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgICBMaW1pdCB7e251bWJlcnN9fSB0bzogPGlucHV0IHR5cGU9Im51bWJlciIgc3RlcD0iMSIgbmctbW9kZWw9Im51bUxpbWl0Ij4KICAgICAgICAgPHA+T3V0cHV0IG51bWJlcnM6IHt7IG51bWJlcnMgfCBsaW1pdFRvOm51bUxpbWl0IH19PC9wPgogICAgICAgICBMaW1pdCB7e2xldHRlcnN9fSB0bzogPGlucHV0IHR5cGU9Im51bWJlciIgc3RlcD0iMSIgbmctbW9kZWw9ImxldHRlckxpbWl0Ij4KICAgICAgICAgPHA+T3V0cHV0IGxldHRlcnM6IHt7IGxldHRlcnMgfCBsaW1pdFRvOmxldHRlckxpbWl0IH19PC9wPgogICAgICAgICBMaW1pdCB7e2xvbmdOdW1iZXJ9fSB0bzogPGlucHV0IHR5cGU9Im51bWJlciIgc3RlcD0iMSIgbmctbW9kZWw9ImxvbmdOdW1iZXJMaW1pdCI+CiAgICAgICAgIDxwPk91dHB1dCBsb25nIG51bWJlcjoge3sgbG9uZ051bWJlciB8IGxpbWl0VG86bG9uZ051bWJlckxpbWl0IH19PC9wPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgdmFyIG51bUxpbWl0SW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCdudW1MaW1pdCcpKTsKICAgICAgIHZhciBsZXR0ZXJMaW1pdElucHV0ID0gZWxlbWVudChieS5tb2RlbCgnbGV0dGVyTGltaXQnKSk7CiAgICAgICB2YXIgbG9uZ051bWJlckxpbWl0SW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCdsb25nTnVtYmVyTGltaXQnKSk7CiAgICAgICB2YXIgbGltaXRlZE51bWJlcnMgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ251bWJlcnMgfCBsaW1pdFRvOm51bUxpbWl0JykpOwogICAgICAgdmFyIGxpbWl0ZWRMZXR0ZXJzID0gZWxlbWVudChieS5iaW5kaW5nKCdsZXR0ZXJzIHwgbGltaXRUbzpsZXR0ZXJMaW1pdCcpKTsKICAgICAgIHZhciBsaW1pdGVkTG9uZ051bWJlciA9IGVsZW1lbnQoYnkuYmluZGluZygnbG9uZ051bWJlciB8IGxpbWl0VG86bG9uZ051bWJlckxpbWl0JykpOwoKICAgICAgIGl0KCdzaG91bGQgbGltaXQgdGhlIG51bWJlciBhcnJheSB0byBmaXJzdCB0aHJlZSBpdGVtcycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QobnVtTGltaXRJbnB1dC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvQmUoJzMnKTsKICAgICAgICAgZXhwZWN0KGxldHRlckxpbWl0SW5wdXQuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0JlKCczJyk7CiAgICAgICAgIGV4cGVjdChsb25nTnVtYmVyTGltaXRJbnB1dC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvQmUoJzMnKTsKICAgICAgICAgZXhwZWN0KGxpbWl0ZWROdW1iZXJzLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IG51bWJlcnM6IFsxLDIsM10nKTsKICAgICAgICAgZXhwZWN0KGxpbWl0ZWRMZXR0ZXJzLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IGxldHRlcnM6IGFiYycpOwogICAgICAgICBleHBlY3QobGltaXRlZExvbmdOdW1iZXIuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbG9uZyBudW1iZXI6IDIzNCcpOwogICAgICAgfSk7CgogICAgICAgLy8gVGhlcmUgaXMgYSBidWcgaW4gc2FmYXJpIGFuZCBwcm90cmFjdG9yIHRoYXQgZG9lc24ndCBsaWtlIHRoZSBtaW51cyBrZXkKICAgICAgIC8vIGl0KCdzaG91bGQgdXBkYXRlIHRoZSBvdXRwdXQgd2hlbiAtMyBpcyBlbnRlcmVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAvLyAgIG51bUxpbWl0SW5wdXQuY2xlYXIoKTsKICAgICAgIC8vICAgbnVtTGltaXRJbnB1dC5zZW5kS2V5cygnLTMnKTsKICAgICAgIC8vICAgbGV0dGVyTGltaXRJbnB1dC5jbGVhcigpOwogICAgICAgLy8gICBsZXR0ZXJMaW1pdElucHV0LnNlbmRLZXlzKCctMycpOwogICAgICAgLy8gICBsb25nTnVtYmVyTGltaXRJbnB1dC5jbGVhcigpOwogICAgICAgLy8gICBsb25nTnVtYmVyTGltaXRJbnB1dC5zZW5kS2V5cygnLTMnKTsKICAgICAgIC8vICAgZXhwZWN0KGxpbWl0ZWROdW1iZXJzLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IG51bWJlcnM6IFs3LDgsOV0nKTsKICAgICAgIC8vICAgZXhwZWN0KGxpbWl0ZWRMZXR0ZXJzLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IGxldHRlcnM6IGdoaScpOwogICAgICAgLy8gICBleHBlY3QobGltaXRlZExvbmdOdW1iZXIuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbG9uZyBudW1iZXI6IDM0MicpOwogICAgICAgLy8gfSk7CgogICAgICAgaXQoJ3Nob3VsZCBub3QgZXhjZWVkIHRoZSBtYXhpbXVtIHNpemUgb2YgaW5wdXQgYXJyYXknLCBmdW5jdGlvbigpIHsKICAgICAgICAgbnVtTGltaXRJbnB1dC5jbGVhcigpOwogICAgICAgICBudW1MaW1pdElucHV0LnNlbmRLZXlzKCcxMDAnKTsKICAgICAgICAgbGV0dGVyTGltaXRJbnB1dC5jbGVhcigpOwogICAgICAgICBsZXR0ZXJMaW1pdElucHV0LnNlbmRLZXlzKCcxMDAnKTsKICAgICAgICAgbG9uZ051bWJlckxpbWl0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgbG9uZ051bWJlckxpbWl0SW5wdXQuc2VuZEtleXMoJzEwMCcpOwogICAgICAgICBleHBlY3QobGltaXRlZE51bWJlcnMuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbnVtYmVyczogWzEsMiwzLDQsNSw2LDcsOCw5XScpOwogICAgICAgICBleHBlY3QobGltaXRlZExldHRlcnMuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbGV0dGVyczogYWJjZGVmZ2hpJyk7CiAgICAgICAgIGV4cGVjdChsaW1pdGVkTG9uZ051bWJlci5nZXRUZXh0KCkpLnRvRXF1YWwoJ091dHB1dCBsb25nIG51bWJlcjogMjM0NTQzMjM0MicpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiovCmZ1bmN0aW9uIGxpbWl0VG9GaWx0ZXIoKXsKICByZXR1cm4gZnVuY3Rpb24oaW5wdXQsIGxpbWl0KSB7CiAgICBpZiAoaXNOdW1iZXIoaW5wdXQpKSBpbnB1dCA9IGlucHV0LnRvU3RyaW5nKCk7CiAgICBpZiAoIWlzQXJyYXkoaW5wdXQpICYmICFpc1N0cmluZyhpbnB1dCkpIHJldHVybiBpbnB1dDsKCiAgICBpZiAoTWF0aC5hYnMoTnVtYmVyKGxpbWl0KSkgPT09IEluZmluaXR5KSB7CiAgICAgIGxpbWl0ID0gTnVtYmVyKGxpbWl0KTsKICAgIH0gZWxzZSB7CiAgICAgIGxpbWl0ID0gaW50KGxpbWl0KTsKICAgIH0KCiAgICBpZiAoaXNTdHJpbmcoaW5wdXQpKSB7CiAgICAgIC8vTmFOIGNoZWNrIG9uIGxpbWl0CiAgICAgIGlmIChsaW1pdCkgewogICAgICAgIHJldHVybiBsaW1pdCA+PSAwID8gaW5wdXQuc2xpY2UoMCwgbGltaXQpIDogaW5wdXQuc2xpY2UobGltaXQsIGlucHV0Lmxlbmd0aCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICIiOwogICAgICB9CiAgICB9CgogICAgdmFyIG91dCA9IFtdLAogICAgICBpLCBuOwoKICAgIC8vIGlmIGFicyhsaW1pdCkgZXhjZWVkcyBtYXhpbXVtIGxlbmd0aCwgdHJpbSBpdAogICAgaWYgKGxpbWl0ID4gaW5wdXQubGVuZ3RoKQogICAgICBsaW1pdCA9IGlucHV0Lmxlbmd0aDsKICAgIGVsc2UgaWYgKGxpbWl0IDwgLWlucHV0Lmxlbmd0aCkKICAgICAgbGltaXQgPSAtaW5wdXQubGVuZ3RoOwoKICAgIGlmIChsaW1pdCA+IDApIHsKICAgICAgaSA9IDA7CiAgICAgIG4gPSBsaW1pdDsKICAgIH0gZWxzZSB7CiAgICAgIGkgPSBpbnB1dC5sZW5ndGggKyBsaW1pdDsKICAgICAgbiA9IGlucHV0Lmxlbmd0aDsKICAgIH0KCiAgICBmb3IgKDsgaTxuOyBpKyspIHsKICAgICAgb3V0LnB1c2goaW5wdXRbaV0pOwogICAgfQoKICAgIHJldHVybiBvdXQ7CiAgfTsKfQoKLyoqCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgb3JkZXJCeQogKiBAa2luZCBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogT3JkZXJzIGEgc3BlY2lmaWVkIGBhcnJheWAgYnkgdGhlIGBleHByZXNzaW9uYCBwcmVkaWNhdGUuIEl0IGlzIG9yZGVyZWQgYWxwaGFiZXRpY2FsbHkKICogZm9yIHN0cmluZ3MgYW5kIG51bWVyaWNhbGx5IGZvciBudW1iZXJzLiBOb3RlOiBpZiB5b3Ugbm90aWNlIG51bWJlcnMgYXJlIG5vdCBiZWluZyBzb3J0ZWQKICogY29ycmVjdGx5LCBtYWtlIHN1cmUgdGhleSBhcmUgYWN0dWFsbHkgYmVpbmcgc2F2ZWQgYXMgbnVtYmVycyBhbmQgbm90IHN0cmluZ3MuCiAqCiAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzb3J0LgogKiBAcGFyYW0ge2Z1bmN0aW9uKCopfHN0cmluZ3xBcnJheS48KGZ1bmN0aW9uKCopfHN0cmluZyk+PX0gZXhwcmVzc2lvbiBBIHByZWRpY2F0ZSB0byBiZQogKiAgICB1c2VkIGJ5IHRoZSBjb21wYXJhdG9yIHRvIGRldGVybWluZSB0aGUgb3JkZXIgb2YgZWxlbWVudHMuCiAqCiAqICAgIENhbiBiZSBvbmUgb2Y6CiAqCiAqICAgIC0gYGZ1bmN0aW9uYDogR2V0dGVyIGZ1bmN0aW9uLiBUaGUgcmVzdWx0IG9mIHRoaXMgZnVuY3Rpb24gd2lsbCBiZSBzb3J0ZWQgdXNpbmcgdGhlCiAqICAgICAgYDxgLCBgPWAsIGA+YCBvcGVyYXRvci4KICogICAgLSBgc3RyaW5nYDogQW4gQW5ndWxhciBleHByZXNzaW9uLiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiBpcyB1c2VkIHRvIGNvbXBhcmUgZWxlbWVudHMKICogICAgICAoZm9yIGV4YW1wbGUgYG5hbWVgIHRvIHNvcnQgYnkgYSBwcm9wZXJ0eSBjYWxsZWQgYG5hbWVgIG9yIGBuYW1lLnN1YnN0cigwLCAzKWAgdG8gc29ydCBieQogKiAgICAgIDMgZmlyc3QgY2hhcmFjdGVycyBvZiBhIHByb3BlcnR5IGNhbGxlZCBgbmFtZWApLiBUaGUgcmVzdWx0IG9mIGEgY29uc3RhbnQgZXhwcmVzc2lvbgogKiAgICAgIGlzIGludGVycHJldGVkIGFzIGEgcHJvcGVydHkgbmFtZSB0byBiZSB1c2VkIGluIGNvbXBhcmlzb25zIChmb3IgZXhhbXBsZSBgInNwZWNpYWwgbmFtZSJgCiAqICAgICAgdG8gc29ydCBvYmplY3QgYnkgdGhlIHZhbHVlIG9mIHRoZWlyIGBzcGVjaWFsIG5hbWVgIHByb3BlcnR5KS4gQW4gZXhwcmVzc2lvbiBjYW4gYmUKICogICAgICBvcHRpb25hbGx5IHByZWZpeGVkIHdpdGggYCtgIG9yIGAtYCB0byBjb250cm9sIGFzY2VuZGluZyBvciBkZXNjZW5kaW5nIHNvcnQgb3JkZXIKICogICAgICAoZm9yIGV4YW1wbGUsIGArbmFtZWAgb3IgYC1uYW1lYCkuIElmIG5vIHByb3BlcnR5IGlzIHByb3ZpZGVkLCAoZS5nLiBgJysnYCkgdGhlbiB0aGUgYXJyYXkKICogICAgICBlbGVtZW50IGl0c2VsZiBpcyB1c2VkIHRvIGNvbXBhcmUgd2hlcmUgc29ydGluZy4KICogICAgLSBgQXJyYXlgOiBBbiBhcnJheSBvZiBmdW5jdGlvbiBvciBzdHJpbmcgcHJlZGljYXRlcy4gVGhlIGZpcnN0IHByZWRpY2F0ZSBpbiB0aGUgYXJyYXkKICogICAgICBpcyB1c2VkIGZvciBzb3J0aW5nLCBidXQgd2hlbiB0d28gaXRlbXMgYXJlIGVxdWl2YWxlbnQsIHRoZSBuZXh0IHByZWRpY2F0ZSBpcyB1c2VkLgogKgogKiAgICBJZiB0aGUgcHJlZGljYXRlIGlzIG1pc3Npbmcgb3IgZW1wdHkgdGhlbiBpdCBkZWZhdWx0cyB0byBgJysnYC4KICoKICogQHBhcmFtIHtib29sZWFuPX0gcmV2ZXJzZSBSZXZlcnNlIHRoZSBvcmRlciBvZiB0aGUgYXJyYXkuCiAqIEByZXR1cm5zIHtBcnJheX0gU29ydGVkIGNvcHkgb2YgdGhlIHNvdXJjZSBhcnJheS4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJvcmRlckJ5RXhhbXBsZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBhbmd1bGFyLm1vZHVsZSgnb3JkZXJCeUV4YW1wbGUnLCBbXSkKICAgICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLmZyaWVuZHMgPQogICAgICAgICAgICAgICAgIFt7bmFtZTonSm9obicsIHBob25lOic1NTUtMTIxMicsIGFnZToxMH0sCiAgICAgICAgICAgICAgICAgIHtuYW1lOidNYXJ5JywgcGhvbmU6JzU1NS05ODc2JywgYWdlOjE5fSwKICAgICAgICAgICAgICAgICAge25hbWU6J01pa2UnLCBwaG9uZTonNTU1LTQzMjEnLCBhZ2U6MjF9LAogICAgICAgICAgICAgICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCcsIGFnZTozNX0sCiAgICAgICAgICAgICAgICAgIHtuYW1lOidKdWxpZScsIHBob25lOic1NTUtODc2NScsIGFnZToyOX1dOwogICAgICAgICAgICAgJHNjb3BlLnByZWRpY2F0ZSA9ICctYWdlJzsKICAgICAgICAgICB9XSk7CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgICA8cHJlPlNvcnRpbmcgcHJlZGljYXRlID0ge3twcmVkaWNhdGV9fTsgcmV2ZXJzZSA9IHt7cmV2ZXJzZX19PC9wcmU+CiAgICAgICAgIDxoci8+CiAgICAgICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlPScnIj51bnNvcnRlZDwvYT4gXQogICAgICAgICA8dGFibGUgY2xhc3M9ImZyaWVuZCI+CiAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICduYW1lJzsgcmV2ZXJzZT1mYWxzZSI+TmFtZTwvYT4KICAgICAgICAgICAgICAgICAoPGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlID0gJy1uYW1lJzsgcmV2ZXJzZT1mYWxzZSI+XjwvYT4pPC90aD4KICAgICAgICAgICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAncGhvbmUnOyByZXZlcnNlPSFyZXZlcnNlIj5QaG9uZSBOdW1iZXI8L2E+PC90aD4KICAgICAgICAgICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAnYWdlJzsgcmV2ZXJzZT0hcmV2ZXJzZSI+QWdlPC9hPjwvdGg+CiAgICAgICAgICAgPC90cj4KICAgICAgICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IG9yZGVyQnk6cHJlZGljYXRlOnJldmVyc2UiPgogICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgICAgICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgICAgICAgICA8dGQ+e3tmcmllbmQuYWdlfX08L3RkPgogICAgICAgICAgIDwvdHI+CiAgICAgICAgIDwvdGFibGU+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICoKICogSXQncyBhbHNvIHBvc3NpYmxlIHRvIGNhbGwgdGhlIG9yZGVyQnkgZmlsdGVyIG1hbnVhbGx5LCBieSBpbmplY3RpbmcgYCRmaWx0ZXJgLCByZXRyaWV2aW5nIHRoZQogKiBmaWx0ZXIgcm91dGluZSB3aXRoIGAkZmlsdGVyKCdvcmRlckJ5JylgLCBhbmQgY2FsbGluZyB0aGUgcmV0dXJuZWQgZmlsdGVyIHJvdXRpbmUgd2l0aCB0aGUKICogZGVzaXJlZCBwYXJhbWV0ZXJzLgogKgogKiBFeGFtcGxlOgogKgogKiBAZXhhbXBsZQogIDxleGFtcGxlIG1vZHVsZT0ib3JkZXJCeUV4YW1wbGUiPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgIDx0YWJsZSBjbGFzcz0iZnJpZW5kIj4KICAgICAgICAgIDx0cj4KICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InJldmVyc2U9ZmFsc2U7b3JkZXIoJ25hbWUnLCBmYWxzZSkiPk5hbWU8L2E+CiAgICAgICAgICAgICAgKDxhIGhyZWY9IiIgbmctY2xpY2s9Im9yZGVyKCctbmFtZScsZmFsc2UpIj5ePC9hPik8L3RoPgogICAgICAgICAgICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icmV2ZXJzZT0hcmV2ZXJzZTtvcmRlcigncGhvbmUnLCByZXZlcnNlKSI+UGhvbmUgTnVtYmVyPC9hPjwvdGg+CiAgICAgICAgICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJyZXZlcnNlPSFyZXZlcnNlO29yZGVyKCdhZ2UnLHJldmVyc2UpIj5BZ2U8L2E+PC90aD4KICAgICAgICAgIDwvdHI+CiAgICAgICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyI+CiAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICAgICAgICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5hZ2V9fTwvdGQ+CiAgICAgICAgICA8L3RyPgogICAgICAgIDwvdGFibGU+CiAgICAgIDwvZGl2PgogICAgPC9maWxlPgoKICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgIGFuZ3VsYXIubW9kdWxlKCdvcmRlckJ5RXhhbXBsZScsIFtdKQogICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgJyRmaWx0ZXInLCBmdW5jdGlvbigkc2NvcGUsICRmaWx0ZXIpIHsKICAgICAgICAgIHZhciBvcmRlckJ5ID0gJGZpbHRlcignb3JkZXJCeScpOwogICAgICAgICAgJHNjb3BlLmZyaWVuZHMgPSBbCiAgICAgICAgICAgIHsgbmFtZTogJ0pvaG4nLCAgICBwaG9uZTogJzU1NS0xMjEyJywgICAgYWdlOiAxMCB9LAogICAgICAgICAgICB7IG5hbWU6ICdNYXJ5JywgICAgcGhvbmU6ICc1NTUtOTg3NicsICAgIGFnZTogMTkgfSwKICAgICAgICAgICAgeyBuYW1lOiAnTWlrZScsICAgIHBob25lOiAnNTU1LTQzMjEnLCAgICBhZ2U6IDIxIH0sCiAgICAgICAgICAgIHsgbmFtZTogJ0FkYW0nLCAgICBwaG9uZTogJzU1NS01Njc4JywgICAgYWdlOiAzNSB9LAogICAgICAgICAgICB7IG5hbWU6ICdKdWxpZScsICAgcGhvbmU6ICc1NTUtODc2NScsICAgIGFnZTogMjkgfQogICAgICAgICAgXTsKICAgICAgICAgICRzY29wZS5vcmRlciA9IGZ1bmN0aW9uKHByZWRpY2F0ZSwgcmV2ZXJzZSkgewogICAgICAgICAgICAkc2NvcGUuZnJpZW5kcyA9IG9yZGVyQnkoJHNjb3BlLmZyaWVuZHMsIHByZWRpY2F0ZSwgcmV2ZXJzZSk7CiAgICAgICAgICB9OwogICAgICAgICAgJHNjb3BlLm9yZGVyKCctYWdlJyxmYWxzZSk7CiAgICAgICAgfV0pOwogICAgPC9maWxlPgo8L2V4YW1wbGU+CiAqLwpvcmRlckJ5RmlsdGVyLiRpbmplY3QgPSBbJyRwYXJzZSddOwpmdW5jdGlvbiBvcmRlckJ5RmlsdGVyKCRwYXJzZSl7CiAgcmV0dXJuIGZ1bmN0aW9uKGFycmF5LCBzb3J0UHJlZGljYXRlLCByZXZlcnNlT3JkZXIpIHsKICAgIGlmICghKGlzQXJyYXlMaWtlKGFycmF5KSkpIHJldHVybiBhcnJheTsKICAgIHNvcnRQcmVkaWNhdGUgPSBpc0FycmF5KHNvcnRQcmVkaWNhdGUpID8gc29ydFByZWRpY2F0ZTogW3NvcnRQcmVkaWNhdGVdOwogICAgaWYgKHNvcnRQcmVkaWNhdGUubGVuZ3RoID09PSAwKSB7IHNvcnRQcmVkaWNhdGUgPSBbJysnXTsgfQogICAgc29ydFByZWRpY2F0ZSA9IHNvcnRQcmVkaWNhdGUubWFwKGZ1bmN0aW9uKHByZWRpY2F0ZSl7CiAgICAgIHZhciBkZXNjZW5kaW5nID0gZmFsc2UsIGdldCA9IHByZWRpY2F0ZSB8fCBpZGVudGl0eTsKICAgICAgaWYgKGlzU3RyaW5nKHByZWRpY2F0ZSkpIHsKICAgICAgICBpZiAoKHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJysnIHx8IHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJy0nKSkgewogICAgICAgICAgZGVzY2VuZGluZyA9IHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJy0nOwogICAgICAgICAgcHJlZGljYXRlID0gcHJlZGljYXRlLnN1YnN0cmluZygxKTsKICAgICAgICB9CiAgICAgICAgaWYgKCBwcmVkaWNhdGUgPT09ICcnICkgewogICAgICAgICAgLy8gRWZmZWN0aXZlbHkgbm8gcHJlZGljYXRlIHdhcyBwYXNzZWQgc28gd2UgY29tcGFyZSBpZGVudGl0eQogICAgICAgICAgcmV0dXJuIHJldmVyc2VDb21wYXJhdG9yKGZ1bmN0aW9uKGEsYikgewogICAgICAgICAgICByZXR1cm4gY29tcGFyZShhLCBiKTsKICAgICAgICAgIH0sIGRlc2NlbmRpbmcpOwogICAgICAgIH0KICAgICAgICBnZXQgPSAkcGFyc2UocHJlZGljYXRlKTsKICAgICAgICBpZiAoZ2V0LmNvbnN0YW50KSB7CiAgICAgICAgICB2YXIga2V5ID0gZ2V0KCk7CiAgICAgICAgICByZXR1cm4gcmV2ZXJzZUNvbXBhcmF0b3IoZnVuY3Rpb24oYSxiKSB7CiAgICAgICAgICAgIHJldHVybiBjb21wYXJlKGFba2V5XSwgYltrZXldKTsKICAgICAgICAgIH0sIGRlc2NlbmRpbmcpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmV2ZXJzZUNvbXBhcmF0b3IoZnVuY3Rpb24oYSxiKXsKICAgICAgICByZXR1cm4gY29tcGFyZShnZXQoYSksZ2V0KGIpKTsKICAgICAgfSwgZGVzY2VuZGluZyk7CiAgICB9KTsKICAgIHZhciBhcnJheUNvcHkgPSBbXTsKICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7IGFycmF5Q29weS5wdXNoKGFycmF5W2ldKTsgfQogICAgcmV0dXJuIGFycmF5Q29weS5zb3J0KHJldmVyc2VDb21wYXJhdG9yKGNvbXBhcmF0b3IsIHJldmVyc2VPcmRlcikpOwoKICAgIGZ1bmN0aW9uIGNvbXBhcmF0b3IobzEsIG8yKXsKICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgc29ydFByZWRpY2F0ZS5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBjb21wID0gc29ydFByZWRpY2F0ZVtpXShvMSwgbzIpOwogICAgICAgIGlmIChjb21wICE9PSAwKSByZXR1cm4gY29tcDsKICAgICAgfQogICAgICByZXR1cm4gMDsKICAgIH0KICAgIGZ1bmN0aW9uIHJldmVyc2VDb21wYXJhdG9yKGNvbXAsIGRlc2NlbmRpbmcpIHsKICAgICAgcmV0dXJuIGRlc2NlbmRpbmcKICAgICAgICAgID8gZnVuY3Rpb24oYSxiKXtyZXR1cm4gY29tcChiLGEpO30KICAgICAgICAgIDogY29tcDsKICAgIH0KICAgIGZ1bmN0aW9uIGNvbXBhcmUodjEsIHYyKXsKICAgICAgdmFyIHQxID0gdHlwZW9mIHYxOwogICAgICB2YXIgdDIgPSB0eXBlb2YgdjI7CiAgICAgIGlmICh0MSA9PSB0MikgewogICAgICAgIGlmIChpc0RhdGUodjEpICYmIGlzRGF0ZSh2MikpIHsKICAgICAgICAgIHYxID0gdjEudmFsdWVPZigpOwogICAgICAgICAgdjIgPSB2Mi52YWx1ZU9mKCk7CiAgICAgICAgfQogICAgICAgIGlmICh0MSA9PSAic3RyaW5nIikgewogICAgICAgICAgIHYxID0gdjEudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICB2MiA9IHYyLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfQogICAgICAgIGlmICh2MSA9PT0gdjIpIHJldHVybiAwOwogICAgICAgIHJldHVybiB2MSA8IHYyID8gLTEgOiAxOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0MSA8IHQyID8gLTEgOiAxOwogICAgICB9CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gbmdEaXJlY3RpdmUoZGlyZWN0aXZlKSB7CiAgaWYgKGlzRnVuY3Rpb24oZGlyZWN0aXZlKSkgewogICAgZGlyZWN0aXZlID0gewogICAgICBsaW5rOiBkaXJlY3RpdmUKICAgIH07CiAgfQogIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnQUMnOwogIHJldHVybiB2YWx1ZUZuKGRpcmVjdGl2ZSk7Cn0KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGEKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIE1vZGlmaWVzIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIHRoZSBodG1sIEEgdGFnIHNvIHRoYXQgdGhlIGRlZmF1bHQgYWN0aW9uIGlzIHByZXZlbnRlZCB3aGVuCiAqIHRoZSBocmVmIGF0dHJpYnV0ZSBpcyBlbXB0eS4KICoKICogVGhpcyBjaGFuZ2UgcGVybWl0cyB0aGUgZWFzeSBjcmVhdGlvbiBvZiBhY3Rpb24gbGlua3Mgd2l0aCB0aGUgYG5nQ2xpY2tgIGRpcmVjdGl2ZQogKiB3aXRob3V0IGNoYW5naW5nIHRoZSBsb2NhdGlvbiBvciBjYXVzaW5nIHBhZ2UgcmVsb2FkcywgZS5nLjoKICogYDxhIGhyZWY9IiIgbmctY2xpY2s9Imxpc3QuYWRkSXRlbSgpIj5BZGQgSXRlbTwvYT5gCiAqLwp2YXIgaHRtbEFuY2hvckRpcmVjdGl2ZSA9IHZhbHVlRm4oewogIHJlc3RyaWN0OiAnRScsCiAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgaWYgKCFhdHRyLmhyZWYgJiYgIWF0dHIueGxpbmtIcmVmICYmICFhdHRyLm5hbWUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50KSB7CiAgICAgICAgLy8gU1ZHQUVsZW1lbnQgZG9lcyBub3QgdXNlIHRoZSBocmVmIGF0dHJpYnV0ZSwgYnV0IHJhdGhlciB0aGUgJ3hsaW5rSHJlZicgYXR0cmlidXRlLgogICAgICAgIHZhciBocmVmID0gdG9TdHJpbmcuY2FsbChlbGVtZW50LnByb3AoJ2hyZWYnKSkgPT09ICdbb2JqZWN0IFNWR0FuaW1hdGVkU3RyaW5nXScgPwogICAgICAgICAgICAgICAgICAgJ3hsaW5rOmhyZWYnIDogJ2hyZWYnOwogICAgICAgIGVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgLy8gaWYgd2UgaGF2ZSBubyBocmVmIHVybCwgdGhlbiBkb24ndCBuYXZpZ2F0ZSBhbnl3aGVyZS4KICAgICAgICAgIGlmICghZWxlbWVudC5hdHRyKGhyZWYpKSB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9CiAgfQp9KTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nSHJlZgogKiBAcmVzdHJpY3QgQQogKiBAcHJpb3JpdHkgOTkKICoKICogQGRlc2NyaXB0aW9uCiAqIFVzaW5nIEFuZ3VsYXIgbWFya3VwIGxpa2UgYHt7aGFzaH19YCBpbiBhbiBocmVmIGF0dHJpYnV0ZSB3aWxsCiAqIG1ha2UgdGhlIGxpbmsgZ28gdG8gdGhlIHdyb25nIFVSTCBpZiB0aGUgdXNlciBjbGlja3MgaXQgYmVmb3JlCiAqIEFuZ3VsYXIgaGFzIGEgY2hhbmNlIHRvIHJlcGxhY2UgdGhlIGB7e2hhc2h9fWAgbWFya3VwIHdpdGggaXRzCiAqIHZhbHVlLiBVbnRpbCBBbmd1bGFyIHJlcGxhY2VzIHRoZSBtYXJrdXAgdGhlIGxpbmsgd2lsbCBiZSBicm9rZW4KICogYW5kIHdpbGwgbW9zdCBsaWtlbHkgcmV0dXJuIGEgNDA0IGVycm9yLgogKgogKiBUaGUgYG5nSHJlZmAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0uCiAqCiAqIFRoZSB3cm9uZyB3YXkgdG8gd3JpdGUgaXQ6CiAqIGBgYGh0bWwKICogPGEgaHJlZj0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ij5saW5rMTwvYT4KICogYGBgCiAqCiAqIFRoZSBjb3JyZWN0IHdheSB0byB3cml0ZSBpdDoKICogYGBgaHRtbAogKiA8YSBuZy1ocmVmPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iPmxpbmsxPC9hPgogKiBgYGAKICoKICogQGVsZW1lbnQgQQogKiBAcGFyYW0ge3RlbXBsYXRlfSBuZ0hyZWYgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogKgogKiBAZXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgc2hvd3MgdmFyaW91cyBjb21iaW5hdGlvbnMgb2YgYGhyZWZgLCBgbmctaHJlZmAgYW5kIGBuZy1jbGlja2AgYXR0cmlidXRlcwogKiBpbiBsaW5rcyBhbmQgdGhlaXIgZGlmZmVyZW50IGJlaGF2aW9yczoKICAgIDxleGFtcGxlPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICA8aW5wdXQgbmctbW9kZWw9InZhbHVlIiAvPjxiciAvPgogICAgICAgIDxhIGlkPSJsaW5rLTEiIGhyZWYgbmctY2xpY2s9InZhbHVlID0gMSI+bGluayAxPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgICAgIDxhIGlkPSJsaW5rLTIiIGhyZWY9IiIgbmctY2xpY2s9InZhbHVlID0gMiI+bGluayAyPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgICAgIDxhIGlkPSJsaW5rLTMiIG5nLWhyZWY9Ii97eycxMjMnfX0iPmxpbmsgMzwvYT4gKGxpbmssIHJlbG9hZCEpPGJyIC8+CiAgICAgICAgPGEgaWQ9ImxpbmstNCIgaHJlZj0iIiBuYW1lPSJ4eCIgbmctY2xpY2s9InZhbHVlID0gNCI+YW5jaG9yPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgICAgIDxhIGlkPSJsaW5rLTUiIG5hbWU9Inh4eCIgbmctY2xpY2s9InZhbHVlID0gNSI+YW5jaG9yPC9hPiAobm8gbGluayk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay02IiBuZy1ocmVmPSJ7e3ZhbHVlfX0iPmxpbms8L2E+IChsaW5rLCBjaGFuZ2UgbG9jYXRpb24pCiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiB3aXRob3V0IHZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTEnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvRXF1YWwoJzEnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTEnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvQmUoJycpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudChieS5pZCgnbGluay0yJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0VxdWFsKCcyJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay0yJykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b0JlKCcnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGFuZCBjaGFuZ2UgdXJsIHdoZW4gbmctaHJlZiBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTMnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvTWF0Y2goL1wvMTIzJC8pOwoKICAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ2xpbmstMycpKS5jbGljaygpOwoKICAgICAgICAgIC8vIEF0IHRoaXMgcG9pbnQsIHdlIG5hdmlnYXRlIGF3YXkgZnJvbSBhbiBBbmd1bGFyIHBhZ2UsIHNvIHdlIG5lZWQKICAgICAgICAgIC8vIHRvIHVzZSBicm93c2VyLmRyaXZlciB0byBnZXQgdGhlIGJhc2Ugd2ViZHJpdmVyLgoKICAgICAgICAgIGJyb3dzZXIud2FpdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGJyb3dzZXIuZHJpdmVyLmdldEN1cnJlbnRVcmwoKS50aGVuKGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICAgIHJldHVybiB1cmwubWF0Y2goL1wvMTIzJC8pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sIDUwMDAsICdwYWdlIHNob3VsZCBuYXZpZ2F0ZSB0byAvMTIzJyk7CiAgICAgICAgfSk7CgogICAgICAgIHhpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZyBhbmQgbmFtZSBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ2xpbmstNCcpKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9FcXVhbCgnNCcpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2xpbmstNCcpKS5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSkudG9CZSgnJyk7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIG5vIGhyZWYgYnV0IG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTUnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvRXF1YWwoJzUnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTUnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvQmUobnVsbCk7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgb25seSBjaGFuZ2UgdXJsIHdoZW4gb25seSBuZy1ocmVmJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKS5jbGVhcigpOwogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuc2VuZEtleXMoJzYnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTYnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvTWF0Y2goL1wvNiQvKTsKCiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTYnKSkuY2xpY2soKTsKCiAgICAgICAgICAvLyBBdCB0aGlzIHBvaW50LCB3ZSBuYXZpZ2F0ZSBhd2F5IGZyb20gYW4gQW5ndWxhciBwYWdlLCBzbyB3ZSBuZWVkCiAgICAgICAgICAvLyB0byB1c2UgYnJvd3Nlci5kcml2ZXIgdG8gZ2V0IHRoZSBiYXNlIHdlYmRyaXZlci4KICAgICAgICAgIGJyb3dzZXIud2FpdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGJyb3dzZXIuZHJpdmVyLmdldEN1cnJlbnRVcmwoKS50aGVuKGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICAgIHJldHVybiB1cmwubWF0Y2goL1wvNiQvKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LCA1MDAwLCAncGFnZSBzaG91bGQgbmF2aWdhdGUgdG8gLzYnKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nU3JjCiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSA5OQogKgogKiBAZGVzY3JpcHRpb24KICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSBge3toYXNofX1gIGluIGEgYHNyY2AgYXR0cmlidXRlIGRvZXNuJ3QKICogd29yayByaWdodDogVGhlIGJyb3dzZXIgd2lsbCBmZXRjaCBmcm9tIHRoZSBVUkwgd2l0aCB0aGUgbGl0ZXJhbAogKiB0ZXh0IGB7e2hhc2h9fWAgdW50aWwgQW5ndWxhciByZXBsYWNlcyB0aGUgZXhwcmVzc2lvbiBpbnNpZGUKICogYHt7aGFzaH19YC4gVGhlIGBuZ1NyY2AgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0uCiAqCiAqIFRoZSBidWdneSB3YXkgdG8gd3JpdGUgaXQ6CiAqIGBgYGh0bWwKICogPGltZyBzcmM9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogKiBgYGAKICoKICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogKiBgYGBodG1sCiAqIDxpbWcgbmctc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICogYGBgCiAqCiAqIEBlbGVtZW50IElNRwogKiBAcGFyYW0ge3RlbXBsYXRlfSBuZ1NyYyBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluIGB7e319YCBtYXJrdXAuCiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdTcmNzZXQKICogQHJlc3RyaWN0IEEKICogQHByaW9yaXR5IDk5CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBVc2luZyBBbmd1bGFyIG1hcmt1cCBsaWtlIGB7e2hhc2h9fWAgaW4gYSBgc3Jjc2V0YCBhdHRyaWJ1dGUgZG9lc24ndAogKiB3b3JrIHJpZ2h0OiBUaGUgYnJvd3NlciB3aWxsIGZldGNoIGZyb20gdGhlIFVSTCB3aXRoIHRoZSBsaXRlcmFsCiAqIHRleHQgYHt7aGFzaH19YCB1bnRpbCBBbmd1bGFyIHJlcGxhY2VzIHRoZSBleHByZXNzaW9uIGluc2lkZQogKiBge3toYXNofX1gLiBUaGUgYG5nU3Jjc2V0YCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbS4KICoKICogVGhlIGJ1Z2d5IHdheSB0byB3cml0ZSBpdDoKICogYGBgaHRtbAogKiA8aW1nIHNyY3NldD0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19IDJ4Ii8+CiAqIGBgYAogKgogKiBUaGUgY29ycmVjdCB3YXkgdG8gd3JpdGUgaXQ6CiAqIGBgYGh0bWwKICogPGltZyBuZy1zcmNzZXQ9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSAyeCIvPgogKiBgYGAKICoKICogQGVsZW1lbnQgSU1HCiAqIEBwYXJhbSB7dGVtcGxhdGV9IG5nU3Jjc2V0IGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0Rpc2FibGVkCiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSAxMDAKICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIFdlIHNob3VsZG4ndCBkbyB0aGlzLCBiZWNhdXNlIGl0IHdpbGwgbWFrZSB0aGUgYnV0dG9uIGVuYWJsZWQgb24gQ2hyb21lL0ZpcmVmb3ggYnV0IG5vdCBvbiBJRTggYW5kIG9sZGVyIElFczoKICogYGBgaHRtbAogKiA8ZGl2IG5nLWluaXQ9InNjb3BlID0geyBpc0Rpc2FibGVkOiBmYWxzZSB9Ij4KICogIDxidXR0b24gZGlzYWJsZWQ9Int7c2NvcGUuaXNEaXNhYmxlZH19Ij5EaXNhYmxlZDwvYnV0dG9uPgogKiA8L2Rpdj4KICogYGBgCiAqCiAqIFRoZSBIVE1MIHNwZWNpZmljYXRpb24gZG9lcyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgdmFsdWVzIG9mIGJvb2xlYW4gYXR0cmlidXRlcwogKiBzdWNoIGFzIGRpc2FibGVkLiAoVGhlaXIgcHJlc2VuY2UgbWVhbnMgdHJ1ZSBhbmQgdGhlaXIgYWJzZW5jZSBtZWFucyBmYWxzZS4pCiAqIElmIHdlIHB1dCBhbiBBbmd1bGFyIGludGVycG9sYXRpb24gZXhwcmVzc2lvbiBpbnRvIHN1Y2ggYW4gYXR0cmlidXRlIHRoZW4gdGhlCiAqIGJpbmRpbmcgaW5mb3JtYXRpb24gd291bGQgYmUgbG9zdCB3aGVuIHRoZSBicm93c2VyIHJlbW92ZXMgdGhlIGF0dHJpYnV0ZS4KICogVGhlIGBuZ0Rpc2FibGVkYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbSBmb3IgdGhlIGBkaXNhYmxlZGAgYXR0cmlidXRlLgogKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogKiBhIHBlcm1hbmVudCByZWxpYWJsZSBwbGFjZSB0byBzdG9yZSB0aGUgYmluZGluZyBpbmZvcm1hdGlvbi4KICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICBDbGljayBtZSB0byB0b2dnbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgICAgPGJ1dHRvbiBuZy1tb2RlbD0iYnV0dG9uIiBuZy1kaXNhYmxlZD0iY2hlY2tlZCI+QnV0dG9uPC9idXR0b24+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgYnV0dG9uJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJ2J1dHRvbicpKS5nZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnY2hlY2tlZCcpKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCdidXR0b24nKSkuZ2V0QXR0cmlidXRlKCdkaXNhYmxlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICoKICogQGVsZW1lbnQgSU5QVVQKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0Rpc2FibGVkIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHksCiAqICAgICB0aGVuIHNwZWNpYWwgYXR0cmlidXRlICJkaXNhYmxlZCIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDaGVja2VkCiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSAxMDAKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBIVE1MIHNwZWNpZmljYXRpb24gZG9lcyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgdmFsdWVzIG9mIGJvb2xlYW4gYXR0cmlidXRlcwogKiBzdWNoIGFzIGNoZWNrZWQuIChUaGVpciBwcmVzZW5jZSBtZWFucyB0cnVlIGFuZCB0aGVpciBhYnNlbmNlIG1lYW5zIGZhbHNlLikKICogSWYgd2UgcHV0IGFuIEFuZ3VsYXIgaW50ZXJwb2xhdGlvbiBleHByZXNzaW9uIGludG8gc3VjaCBhbiBhdHRyaWJ1dGUgdGhlbiB0aGUKICogYmluZGluZyBpbmZvcm1hdGlvbiB3b3VsZCBiZSBsb3N0IHdoZW4gdGhlIGJyb3dzZXIgcmVtb3ZlcyB0aGUgYXR0cmlidXRlLgogKiBUaGUgYG5nQ2hlY2tlZGAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0gZm9yIHRoZSBgY2hlY2tlZGAgYXR0cmlidXRlLgogKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogKiBhIHBlcm1hbmVudCByZWxpYWJsZSBwbGFjZSB0byBzdG9yZSB0aGUgYmluZGluZyBpbmZvcm1hdGlvbi4KICogQGV4YW1wbGUKICAgIDxleGFtcGxlPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICBDaGVjayBtZSB0byBjaGVjayBib3RoOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJtYXN0ZXIiPjxici8+CiAgICAgICAgPGlucHV0IGlkPSJjaGVja1NsYXZlIiB0eXBlPSJjaGVja2JveCIgbmctY2hlY2tlZD0ibWFzdGVyIj4KICAgICAgPC9maWxlPgogICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIGJvdGggY2hlY2tCb3hlcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2NoZWNrU2xhdmUnKSkuZ2V0QXR0cmlidXRlKCdjaGVja2VkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnbWFzdGVyJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnY2hlY2tTbGF2ZScpKS5nZXRBdHRyaWJ1dGUoJ2NoZWNrZWQnKSkudG9CZVRydXRoeSgpOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAqCiAqIEBlbGVtZW50IElOUFVUCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDaGVja2VkIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHksCiAqICAgICB0aGVuIHNwZWNpYWwgYXR0cmlidXRlICJjaGVja2VkIiB3aWxsIGJlIHNldCBvbiB0aGUgZWxlbWVudAogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1JlYWRvbmx5CiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSAxMDAKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBIVE1MIHNwZWNpZmljYXRpb24gZG9lcyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgdmFsdWVzIG9mIGJvb2xlYW4gYXR0cmlidXRlcwogKiBzdWNoIGFzIHJlYWRvbmx5LiAoVGhlaXIgcHJlc2VuY2UgbWVhbnMgdHJ1ZSBhbmQgdGhlaXIgYWJzZW5jZSBtZWFucyBmYWxzZS4pCiAqIElmIHdlIHB1dCBhbiBBbmd1bGFyIGludGVycG9sYXRpb24gZXhwcmVzc2lvbiBpbnRvIHN1Y2ggYW4gYXR0cmlidXRlIHRoZW4gdGhlCiAqIGJpbmRpbmcgaW5mb3JtYXRpb24gd291bGQgYmUgbG9zdCB3aGVuIHRoZSBicm93c2VyIHJlbW92ZXMgdGhlIGF0dHJpYnV0ZS4KICogVGhlIGBuZ1JlYWRvbmx5YCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbSBmb3IgdGhlIGByZWFkb25seWAgYXR0cmlidXRlLgogKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogKiBhIHBlcm1hbmVudCByZWxpYWJsZSBwbGFjZSB0byBzdG9yZSB0aGUgYmluZGluZyBpbmZvcm1hdGlvbi4KICogQGV4YW1wbGUKICAgIDxleGFtcGxlPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICBDaGVjayBtZSB0byBtYWtlIHRleHQgcmVhZG9ubHk6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLXJlYWRvbmx5PSJjaGVja2VkIiB2YWx1ZT0iSSdtIEFuZ3VsYXIiLz4KICAgICAgPC9maWxlPgogICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICBpdCgnc2hvdWxkIHRvZ2dsZSByZWFkb25seSBhdHRyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJ1t0eXBlPSJ0ZXh0Il0nKSkuZ2V0QXR0cmlidXRlKCdyZWFkb25seScpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2NoZWNrZWQnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnW3R5cGU9InRleHQiXScpKS5nZXRBdHRyaWJ1dGUoJ3JlYWRvbmx5JykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKgogKiBAZWxlbWVudCBJTlBVVAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nUmVhZG9ubHkgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSwKICogICAgIHRoZW4gc3BlY2lhbCBhdHRyaWJ1dGUgInJlYWRvbmx5IiB3aWxsIGJlIHNldCBvbiB0aGUgZWxlbWVudAogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1NlbGVjdGVkCiAqIEByZXN0cmljdCBBCiAqIEBwcmlvcml0eSAxMDAKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBIVE1MIHNwZWNpZmljYXRpb24gZG9lcyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgdmFsdWVzIG9mIGJvb2xlYW4gYXR0cmlidXRlcwogKiBzdWNoIGFzIHNlbGVjdGVkLiAoVGhlaXIgcHJlc2VuY2UgbWVhbnMgdHJ1ZSBhbmQgdGhlaXIgYWJzZW5jZSBtZWFucyBmYWxzZS4pCiAqIElmIHdlIHB1dCBhbiBBbmd1bGFyIGludGVycG9sYXRpb24gZXhwcmVzc2lvbiBpbnRvIHN1Y2ggYW4gYXR0cmlidXRlIHRoZW4gdGhlCiAqIGJpbmRpbmcgaW5mb3JtYXRpb24gd291bGQgYmUgbG9zdCB3aGVuIHRoZSBicm93c2VyIHJlbW92ZXMgdGhlIGF0dHJpYnV0ZS4KICogVGhlIGBuZ1NlbGVjdGVkYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbSBmb3IgdGhlIGBzZWxlY3RlZGAgYXR0cmlidXRlLgogKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogKiBhIHBlcm1hbmVudCByZWxpYWJsZSBwbGFjZSB0byBzdG9yZSB0aGUgYmluZGluZyBpbmZvcm1hdGlvbi4KICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICBDaGVjayBtZSB0byBzZWxlY3Q6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InNlbGVjdGVkIj48YnIvPgogICAgICAgIDxzZWxlY3Q+CiAgICAgICAgICA8b3B0aW9uPkhlbGxvITwvb3B0aW9uPgogICAgICAgICAgPG9wdGlvbiBpZD0iZ3JlZXQiIG5nLXNlbGVjdGVkPSJzZWxlY3RlZCI+R3JlZXRpbmdzITwvb3B0aW9uPgogICAgICAgIDwvc2VsZWN0PgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIGl0KCdzaG91bGQgc2VsZWN0IEdyZWV0aW5ncyEnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdncmVldCcpKS5nZXRBdHRyaWJ1dGUoJ3NlbGVjdGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc2VsZWN0ZWQnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdncmVldCcpKS5nZXRBdHRyaWJ1dGUoJ3NlbGVjdGVkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKgogKiBAZWxlbWVudCBPUFRJT04KICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1NlbGVjdGVkIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHksCiAqICAgICB0aGVuIHNwZWNpYWwgYXR0cmlidXRlICJzZWxlY3RlZCIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ09wZW4KICogQHJlc3RyaWN0IEEKICogQHByaW9yaXR5IDEwMAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIEhUTUwgc3BlY2lmaWNhdGlvbiBkb2VzIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSB2YWx1ZXMgb2YgYm9vbGVhbiBhdHRyaWJ1dGVzCiAqIHN1Y2ggYXMgb3Blbi4gKFRoZWlyIHByZXNlbmNlIG1lYW5zIHRydWUgYW5kIHRoZWlyIGFic2VuY2UgbWVhbnMgZmFsc2UuKQogKiBJZiB3ZSBwdXQgYW4gQW5ndWxhciBpbnRlcnBvbGF0aW9uIGV4cHJlc3Npb24gaW50byBzdWNoIGFuIGF0dHJpYnV0ZSB0aGVuIHRoZQogKiBiaW5kaW5nIGluZm9ybWF0aW9uIHdvdWxkIGJlIGxvc3Qgd2hlbiB0aGUgYnJvd3NlciByZW1vdmVzIHRoZSBhdHRyaWJ1dGUuCiAqIFRoZSBgbmdPcGVuYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbSBmb3IgdGhlIGBvcGVuYCBhdHRyaWJ1dGUuCiAqIFRoaXMgY29tcGxlbWVudGFyeSBkaXJlY3RpdmUgaXMgbm90IHJlbW92ZWQgYnkgdGhlIGJyb3dzZXIgYW5kIHNvIHByb3ZpZGVzCiAqIGEgcGVybWFuZW50IHJlbGlhYmxlIHBsYWNlIHRvIHN0b3JlIHRoZSBiaW5kaW5nIGluZm9ybWF0aW9uLgogKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgIENoZWNrIG1lIGNoZWNrIG11bHRpcGxlOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJvcGVuIj48YnIvPgogICAgICAgICA8ZGV0YWlscyBpZD0iZGV0YWlscyIgbmctb3Blbj0ib3BlbiI+CiAgICAgICAgICAgIDxzdW1tYXJ5PlNob3cvSGlkZSBtZTwvc3VtbWFyeT4KICAgICAgICAgPC9kZXRhaWxzPgogICAgICAgPC9maWxlPgogICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgIGl0KCdzaG91bGQgdG9nZ2xlIG9wZW4nLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnZGV0YWlscycpKS5nZXRBdHRyaWJ1dGUoJ29wZW4nKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnb3BlbicpKS5jbGljaygpOwogICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdkZXRhaWxzJykpLmdldEF0dHJpYnV0ZSgnb3BlbicpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgIH0pOwogICAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICoKICogQGVsZW1lbnQgREVUQUlMUwogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nT3BlbiBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5LAogKiAgICAgdGhlbiBzcGVjaWFsIGF0dHJpYnV0ZSAib3BlbiIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICovCgp2YXIgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXMgPSB7fTsKCgovLyBib29sZWFuIGF0dHJzIGFyZSBldmFsdWF0ZWQKZm9yRWFjaChCT09MRUFOX0FUVFIsIGZ1bmN0aW9uKHByb3BOYW1lLCBhdHRyTmFtZSkgewogIC8vIGJpbmRpbmcgdG8gbXVsdGlwbGUgaXMgbm90IHN1cHBvcnRlZAogIGlmIChwcm9wTmFtZSA9PSAibXVsdGlwbGUiKSByZXR1cm47CgogIHZhciBub3JtYWxpemVkID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgYXR0ck5hbWUpOwogIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzW25vcm1hbGl6ZWRdID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0EnLAogICAgICBwcmlvcml0eTogMTAwLAogICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyW25vcm1hbGl6ZWRdLCBmdW5jdGlvbiBuZ0Jvb2xlYW5BdHRyV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGF0dHIuJHNldChhdHRyTmFtZSwgISF2YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgfTsKfSk7CgovLyBhbGlhc2VkIGlucHV0IGF0dHJzIGFyZSBldmFsdWF0ZWQKZm9yRWFjaChBTElBU0VEX0FUVFIsIGZ1bmN0aW9uKGh0bWxBdHRyLCBuZ0F0dHIpIHsKICBuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlc1tuZ0F0dHJdID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICBwcmlvcml0eTogMTAwLAogICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIC8vc3BlY2lhbCBjYXNlIG5nUGF0dGVybiB3aGVuIGEgbGl0ZXJhbCByZWd1bGFyIGV4cHJlc3Npb24gdmFsdWUKICAgICAgICAvL2lzIHVzZWQgYXMgdGhlIGV4cHJlc3Npb24gKHRoaXMgd2F5IHdlIGRvbid0IGhhdmUgdG8gd2F0Y2ggYW55dGhpbmcpLgogICAgICAgIGlmIChuZ0F0dHIgPT09ICJuZ1BhdHRlcm4iICYmIGF0dHIubmdQYXR0ZXJuLmNoYXJBdCgwKSA9PSAiLyIpIHsKICAgICAgICAgIHZhciBtYXRjaCA9IGF0dHIubmdQYXR0ZXJuLm1hdGNoKFJFR0VYX1NUUklOR19SRUdFWFApOwogICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIGF0dHIuJHNldCgibmdQYXR0ZXJuIiwgbmV3IFJlZ0V4cChtYXRjaFsxXSwgbWF0Y2hbMl0pKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHJbbmdBdHRyXSwgZnVuY3Rpb24gbmdBdHRyQWxpYXNXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgYXR0ci4kc2V0KG5nQXR0ciwgdmFsdWUpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwogIH07Cn0pOwoKLy8gbmctc3JjLCBuZy1zcmNzZXQsIG5nLWhyZWYgYXJlIGludGVycG9sYXRlZApmb3JFYWNoKFsnc3JjJywgJ3NyY3NldCcsICdocmVmJ10sIGZ1bmN0aW9uKGF0dHJOYW1lKSB7CiAgdmFyIG5vcm1hbGl6ZWQgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBhdHRyTmFtZSk7CiAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbm9ybWFsaXplZF0gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIHByaW9yaXR5OiA5OSwgLy8gaXQgbmVlZHMgdG8gcnVuIGFmdGVyIHRoZSBhdHRyaWJ1dGVzIGFyZSBpbnRlcnBvbGF0ZWQKICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICB2YXIgcHJvcE5hbWUgPSBhdHRyTmFtZSwKICAgICAgICAgICAgbmFtZSA9IGF0dHJOYW1lOwoKICAgICAgICBpZiAoYXR0ck5hbWUgPT09ICdocmVmJyAmJgogICAgICAgICAgICB0b1N0cmluZy5jYWxsKGVsZW1lbnQucHJvcCgnaHJlZicpKSA9PT0gJ1tvYmplY3QgU1ZHQW5pbWF0ZWRTdHJpbmddJykgewogICAgICAgICAgbmFtZSA9ICd4bGlua0hyZWYnOwogICAgICAgICAgYXR0ci4kYXR0cltuYW1lXSA9ICd4bGluazpocmVmJzsKICAgICAgICAgIHByb3BOYW1lID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGF0dHIuJG9ic2VydmUobm9ybWFsaXplZCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGF0dHJOYW1lID09PSAnaHJlZicpIHsKICAgICAgICAgICAgICBhdHRyLiRzZXQobmFtZSwgbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGF0dHIuJHNldChuYW1lLCB2YWx1ZSk7CgogICAgICAgICAgLy8gb24gSUUsIGlmICJuZzpzcmMiIGRpcmVjdGl2ZSBkZWNsYXJhdGlvbiBpcyB1c2VkIGFuZCAic3JjIiBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdAogICAgICAgICAgLy8gdGhlbiBjYWxsaW5nIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdzcmMnLCAnZm9vJykgZG9lc24ndCBkbyBhbnl0aGluZywgc28gd2UgbmVlZAogICAgICAgICAgLy8gdG8gc2V0IHRoZSBwcm9wZXJ0eSBhcyB3ZWxsIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgZWZmZWN0LgogICAgICAgICAgLy8gd2UgdXNlIGF0dHJbYXR0ck5hbWVdIHZhbHVlIHNpbmNlICRzZXQgY2FuIHNhbml0aXplIHRoZSB1cmwuCiAgICAgICAgICBpZiAobXNpZSAmJiBwcm9wTmFtZSkgZWxlbWVudC5wcm9wKHByb3BOYW1lLCBhdHRyW25hbWVdKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICB9Owp9KTsKCi8qIGdsb2JhbCAtbnVsbEZvcm1DdHJsLCAtU1VCTUlUVEVEX0NMQVNTLCBhZGRTZXRWYWxpZGl0eU1ldGhvZDogdHJ1ZQogKi8KdmFyIG51bGxGb3JtQ3RybCA9IHsKICAkYWRkQ29udHJvbDogbm9vcCwKICAkJHJlbmFtZUNvbnRyb2w6IG51bGxGb3JtUmVuYW1lQ29udHJvbCwKICAkcmVtb3ZlQ29udHJvbDogbm9vcCwKICAkc2V0VmFsaWRpdHk6IG5vb3AsCiAgJHNldERpcnR5OiBub29wLAogICRzZXRQcmlzdGluZTogbm9vcCwKICAkc2V0U3VibWl0dGVkOiBub29wCn0sClNVQk1JVFRFRF9DTEFTUyA9ICduZy1zdWJtaXR0ZWQnOwoKZnVuY3Rpb24gbnVsbEZvcm1SZW5hbWVDb250cm9sKGNvbnRyb2wsIG5hbWUpIHsKICBjb250cm9sLiRuYW1lID0gbmFtZTsKfQoKLyoqCiAqIEBuZ2RvYyB0eXBlCiAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIKICoKICogQHByb3BlcnR5IHtib29sZWFufSAkcHJpc3RpbmUgVHJ1ZSBpZiB1c2VyIGhhcyBub3QgaW50ZXJhY3RlZCB3aXRoIHRoZSBmb3JtIHlldC4KICogQHByb3BlcnR5IHtib29sZWFufSAkZGlydHkgVHJ1ZSBpZiB1c2VyIGhhcyBhbHJlYWR5IGludGVyYWN0ZWQgd2l0aCB0aGUgZm9ybS4KICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiBhbGwgb2YgdGhlIGNvbnRhaW5pbmcgZm9ybXMgYW5kIGNvbnRyb2xzIGFyZSB2YWxpZC4KICogQHByb3BlcnR5IHtib29sZWFufSAkaW52YWxpZCBUcnVlIGlmIGF0IGxlYXN0IG9uZSBjb250YWluaW5nIGNvbnRyb2wgb3IgZm9ybSBpcyBpbnZhbGlkLgogKiBAcHJvcGVydHkge2Jvb2xlYW59ICRzdWJtaXR0ZWQgVHJ1ZSBpZiB1c2VyIGhhcyBzdWJtaXR0ZWQgdGhlIGZvcm0gZXZlbiBpZiBpdHMgaW52YWxpZC4KICoKICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBJcyBhbiBvYmplY3QgaGFzaCwgY29udGFpbmluZyByZWZlcmVuY2VzIHRvIGNvbnRyb2xzIG9yCiAqICBmb3JtcyB3aXRoIGZhaWxpbmcgdmFsaWRhdG9ycywgd2hlcmU6CiAqCiAqICAtIGtleXMgYXJlIHZhbGlkYXRpb24gdG9rZW5zIChlcnJvciBuYW1lcyksCiAqICAtIHZhbHVlcyBhcmUgYXJyYXlzIG9mIGNvbnRyb2xzIG9yIGZvcm1zIHRoYXQgaGF2ZSBhIGZhaWxpbmcgdmFsaWRhdG9yIGZvciBnaXZlbiBlcnJvciBuYW1lLgogKgogKiAgQnVpbHQtaW4gdmFsaWRhdGlvbiB0b2tlbnM6CiAqCiAqICAtIGBlbWFpbGAKICogIC0gYG1heGAKICogIC0gYG1heGxlbmd0aGAKICogIC0gYG1pbmAKICogIC0gYG1pbmxlbmd0aGAKICogIC0gYG51bWJlcmAKICogIC0gYHBhdHRlcm5gCiAqICAtIGByZXF1aXJlZGAKICogIC0gYHVybGAKICoKICogQGRlc2NyaXB0aW9uCiAqIGBGb3JtQ29udHJvbGxlcmAga2VlcHMgdHJhY2sgb2YgYWxsIGl0cyBjb250cm9scyBhbmQgbmVzdGVkIGZvcm1zIGFzIHdlbGwgYXMgdGhlIHN0YXRlIG9mIHRoZW0sCiAqIHN1Y2ggYXMgYmVpbmcgdmFsaWQvaW52YWxpZCBvciBkaXJ0eS9wcmlzdGluZS4KICoKICogRWFjaCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0gZGlyZWN0aXZlIGNyZWF0ZXMgYW4gaW5zdGFuY2UKICogb2YgYEZvcm1Db250cm9sbGVyYC4KICoKICovCi8vYXNrcyBmb3IgJHNjb3BlIHRvIGZvb2wgdGhlIEJDIGNvbnRyb2xsZXIgbW9kdWxlCkZvcm1Db250cm9sbGVyLiRpbmplY3QgPSBbJyRlbGVtZW50JywgJyRhdHRycycsICckc2NvcGUnLCAnJGFuaW1hdGUnLCAnJGludGVycG9sYXRlJ107CmZ1bmN0aW9uIEZvcm1Db250cm9sbGVyKGVsZW1lbnQsIGF0dHJzLCAkc2NvcGUsICRhbmltYXRlLCAkaW50ZXJwb2xhdGUpIHsKICB2YXIgZm9ybSA9IHRoaXMsCiAgICAgIGNvbnRyb2xzID0gW107CgogIHZhciBwYXJlbnRGb3JtID0gZm9ybS4kJHBhcmVudEZvcm0gPSBlbGVtZW50LnBhcmVudCgpLmNvbnRyb2xsZXIoJ2Zvcm0nKSB8fCBudWxsRm9ybUN0cmw7CgogIC8vIGluaXQgc3RhdGUKICBmb3JtLiRlcnJvciA9IHt9OwogIGZvcm0uJCRzdWNjZXNzID0ge307CiAgZm9ybS4kcGVuZGluZyA9IHVuZGVmaW5lZDsKICBmb3JtLiRuYW1lID0gJGludGVycG9sYXRlKGF0dHJzLm5hbWUgfHwgYXR0cnMubmdGb3JtIHx8ICcnKSgkc2NvcGUpOwogIGZvcm0uJGRpcnR5ID0gZmFsc2U7CiAgZm9ybS4kcHJpc3RpbmUgPSB0cnVlOwogIGZvcm0uJHZhbGlkID0gdHJ1ZTsKICBmb3JtLiRpbnZhbGlkID0gZmFsc2U7CiAgZm9ybS4kc3VibWl0dGVkID0gZmFsc2U7CgogIHBhcmVudEZvcm0uJGFkZENvbnRyb2woZm9ybSk7CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRyb2xsYmFja1ZpZXdWYWx1ZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUm9sbGJhY2sgYWxsIGZvcm0gY29udHJvbHMgcGVuZGluZyB1cGRhdGVzIHRvIHRoZSBgJG1vZGVsVmFsdWVgLgogICAqCiAgICogVXBkYXRlcyBtYXkgYmUgcGVuZGluZyBieSBhIGRlYm91bmNlZCBldmVudCBvciBiZWNhdXNlIHRoZSBpbnB1dCBpcyB3YWl0aW5nIGZvciBhIHNvbWUgZnV0dXJlCiAgICogZXZlbnQgZGVmaW5lZCBpbiBgbmctbW9kZWwtb3B0aW9uc2AuIFRoaXMgbWV0aG9kIGlzIHR5cGljYWxseSBuZWVkZWQgYnkgdGhlIHJlc2V0IGJ1dHRvbiBvZgogICAqIGEgZm9ybSB0aGF0IHVzZXMgYG5nLW1vZGVsLW9wdGlvbnNgIHRvIHBlbmQgdXBkYXRlcy4KICAgKi8KICBmb3JtLiRyb2xsYmFja1ZpZXdWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgZm9yRWFjaChjb250cm9scywgZnVuY3Rpb24oY29udHJvbCkgewogICAgICBjb250cm9sLiRyb2xsYmFja1ZpZXdWYWx1ZSgpOwogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJGNvbW1pdFZpZXdWYWx1ZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ29tbWl0IGFsbCBmb3JtIGNvbnRyb2xzIHBlbmRpbmcgdXBkYXRlcyB0byB0aGUgYCRtb2RlbFZhbHVlYC4KICAgKgogICAqIFVwZGF0ZXMgbWF5IGJlIHBlbmRpbmcgYnkgYSBkZWJvdW5jZWQgZXZlbnQgb3IgYmVjYXVzZSB0aGUgaW5wdXQgaXMgd2FpdGluZyBmb3IgYSBzb21lIGZ1dHVyZQogICAqIGV2ZW50IGRlZmluZWQgaW4gYG5nLW1vZGVsLW9wdGlvbnNgLiBUaGlzIG1ldGhvZCBpcyByYXJlbHkgbmVlZGVkIGFzIGBOZ01vZGVsQ29udHJvbGxlcmAKICAgKiB1c3VhbGx5IGhhbmRsZXMgY2FsbGluZyB0aGlzIGluIHJlc3BvbnNlIHRvIGlucHV0IGV2ZW50cy4KICAgKi8KICBmb3JtLiRjb21taXRWaWV3VmFsdWUgPSBmdW5jdGlvbigpIHsKICAgIGZvckVhY2goY29udHJvbHMsIGZ1bmN0aW9uKGNvbnRyb2wpIHsKICAgICAgY29udHJvbC4kY29tbWl0Vmlld1ZhbHVlKCk7CiAgICB9KTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgZm9ybS5Gb3JtQ29udHJvbGxlciMkYWRkQ29udHJvbAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmVnaXN0ZXIgYSBjb250cm9sIHdpdGggdGhlIGZvcm0uCiAgICoKICAgKiBJbnB1dCBlbGVtZW50cyB1c2luZyBuZ01vZGVsQ29udHJvbGxlciBkbyB0aGlzIGF1dG9tYXRpY2FsbHkgd2hlbiB0aGV5IGFyZSBsaW5rZWQuCiAgICovCiAgZm9ybS4kYWRkQ29udHJvbCA9IGZ1bmN0aW9uKGNvbnRyb2wpIHsKICAgIC8vIEJyZWFraW5nIGNoYW5nZSAtIGJlZm9yZSwgaW5wdXRzIHdob3NlIG5hbWUgd2FzICJoYXNPd25Qcm9wZXJ0eSIgd2VyZSBxdWlldGx5IGlnbm9yZWQKICAgIC8vIGFuZCBub3QgYWRkZWQgdG8gdGhlIHNjb3BlLiAgTm93IHdlIHRocm93IGFuIGVycm9yLgogICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkoY29udHJvbC4kbmFtZSwgJ2lucHV0Jyk7CiAgICBjb250cm9scy5wdXNoKGNvbnRyb2wpOwoKICAgIGlmIChjb250cm9sLiRuYW1lKSB7CiAgICAgIGZvcm1bY29udHJvbC4kbmFtZV0gPSBjb250cm9sOwogICAgfQogIH07CgogIC8vIFByaXZhdGUgQVBJOiByZW5hbWUgYSBmb3JtIGNvbnRyb2wKICBmb3JtLiQkcmVuYW1lQ29udHJvbCA9IGZ1bmN0aW9uKGNvbnRyb2wsIG5ld05hbWUpIHsKICAgIHZhciBvbGROYW1lID0gY29udHJvbC4kbmFtZTsKCiAgICBpZiAoZm9ybVtvbGROYW1lXSA9PT0gY29udHJvbCkgewogICAgICBkZWxldGUgZm9ybVtvbGROYW1lXTsKICAgIH0KICAgIGZvcm1bbmV3TmFtZV0gPSBjb250cm9sOwogICAgY29udHJvbC4kbmFtZSA9IG5ld05hbWU7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJHJlbW92ZUNvbnRyb2wKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERlcmVnaXN0ZXIgYSBjb250cm9sIGZyb20gdGhlIGZvcm0uCiAgICoKICAgKiBJbnB1dCBlbGVtZW50cyB1c2luZyBuZ01vZGVsQ29udHJvbGxlciBkbyB0aGlzIGF1dG9tYXRpY2FsbHkgd2hlbiB0aGV5IGFyZSBkZXN0cm95ZWQuCiAgICovCiAgZm9ybS4kcmVtb3ZlQ29udHJvbCA9IGZ1bmN0aW9uKGNvbnRyb2wpIHsKICAgIGlmIChjb250cm9sLiRuYW1lICYmIGZvcm1bY29udHJvbC4kbmFtZV0gPT09IGNvbnRyb2wpIHsKICAgICAgZGVsZXRlIGZvcm1bY29udHJvbC4kbmFtZV07CiAgICB9CiAgICBmb3JFYWNoKGZvcm0uJHBlbmRpbmcsIGZ1bmN0aW9uKHZhbHVlLCBuYW1lKSB7CiAgICAgIGZvcm0uJHNldFZhbGlkaXR5KG5hbWUsIG51bGwsIGNvbnRyb2wpOwogICAgfSk7CiAgICBmb3JFYWNoKGZvcm0uJGVycm9yLCBmdW5jdGlvbih2YWx1ZSwgbmFtZSkgewogICAgICBmb3JtLiRzZXRWYWxpZGl0eShuYW1lLCBudWxsLCBjb250cm9sKTsKICAgIH0pOwoKICAgIGFycmF5UmVtb3ZlKGNvbnRyb2xzLCBjb250cm9sKTsKICB9OwoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXRzIHRoZSB2YWxpZGl0eSBvZiBhIGZvcm0gY29udHJvbC4KICAgKgogICAqIFRoaXMgbWV0aG9kIHdpbGwgYWxzbyBwcm9wYWdhdGUgdG8gcGFyZW50IGZvcm1zLgogICAqLwogIGFkZFNldFZhbGlkaXR5TWV0aG9kKHsKICAgIGN0cmw6IHRoaXMsCiAgICAkZWxlbWVudDogZWxlbWVudCwKICAgIHNldDogZnVuY3Rpb24ob2JqZWN0LCBwcm9wZXJ0eSwgY29udHJvbCkgewogICAgICB2YXIgbGlzdCA9IG9iamVjdFtwcm9wZXJ0eV07CiAgICAgIGlmICghbGlzdCkgewogICAgICAgIG9iamVjdFtwcm9wZXJ0eV0gPSBbY29udHJvbF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGluZGV4ID0gbGlzdC5pbmRleE9mKGNvbnRyb2wpOwogICAgICAgIGlmIChpbmRleCA9PT0gLTEpIHsKICAgICAgICAgIGxpc3QucHVzaChjb250cm9sKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICB1bnNldDogZnVuY3Rpb24ob2JqZWN0LCBwcm9wZXJ0eSwgY29udHJvbCkgewogICAgICB2YXIgbGlzdCA9IG9iamVjdFtwcm9wZXJ0eV07CiAgICAgIGlmICghbGlzdCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBhcnJheVJlbW92ZShsaXN0LCBjb250cm9sKTsKICAgICAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSB7CiAgICAgICAgZGVsZXRlIG9iamVjdFtwcm9wZXJ0eV07CiAgICAgIH0KICAgIH0sCiAgICBwYXJlbnRGb3JtOiBwYXJlbnRGb3JtLAogICAgJGFuaW1hdGU6ICRhbmltYXRlCiAgfSk7CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRzZXREaXJ0eQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cyB0aGUgZm9ybSB0byBhIGRpcnR5IHN0YXRlLgogICAqCiAgICogVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB0byBhZGQgdGhlICduZy1kaXJ0eScgY2xhc3MgYW5kIHNldCB0aGUgZm9ybSB0byBhIGRpcnR5CiAgICogc3RhdGUgKG5nLWRpcnR5IGNsYXNzKS4gVGhpcyBtZXRob2Qgd2lsbCBhbHNvIHByb3BhZ2F0ZSB0byBwYXJlbnQgZm9ybXMuCiAgICovCiAgZm9ybS4kc2V0RGlydHkgPSBmdW5jdGlvbigpIHsKICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsIFBSSVNUSU5FX0NMQVNTKTsKICAgICRhbmltYXRlLmFkZENsYXNzKGVsZW1lbnQsIERJUlRZX0NMQVNTKTsKICAgIGZvcm0uJGRpcnR5ID0gdHJ1ZTsKICAgIGZvcm0uJHByaXN0aW5lID0gZmFsc2U7CiAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRzZXRQcmlzdGluZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cyB0aGUgZm9ybSB0byBpdHMgcHJpc3RpbmUgc3RhdGUuCiAgICoKICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIHJlbW92ZSB0aGUgJ25nLWRpcnR5JyBjbGFzcyBhbmQgc2V0IHRoZSBmb3JtIHRvIGl0cyBwcmlzdGluZQogICAqIHN0YXRlIChuZy1wcmlzdGluZSBjbGFzcykuIFRoaXMgbWV0aG9kIHdpbGwgYWxzbyBwcm9wYWdhdGUgdG8gYWxsIHRoZSBjb250cm9scyBjb250YWluZWQKICAgKiBpbiB0aGlzIGZvcm0uCiAgICoKICAgKiBTZXR0aW5nIGEgZm9ybSBiYWNrIHRvIGEgcHJpc3RpbmUgc3RhdGUgaXMgb2Z0ZW4gdXNlZnVsIHdoZW4gd2Ugd2FudCB0byAncmV1c2UnIGEgZm9ybSBhZnRlcgogICAqIHNhdmluZyBvciByZXNldHRpbmcgaXQuCiAgICovCiAgZm9ybS4kc2V0UHJpc3RpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAkYW5pbWF0ZS5zZXRDbGFzcyhlbGVtZW50LCBQUklTVElORV9DTEFTUywgRElSVFlfQ0xBU1MgKyAnICcgKyBTVUJNSVRURURfQ0xBU1MpOwogICAgZm9ybS4kZGlydHkgPSBmYWxzZTsKICAgIGZvcm0uJHByaXN0aW5lID0gdHJ1ZTsKICAgIGZvcm0uJHN1Ym1pdHRlZCA9IGZhbHNlOwogICAgZm9yRWFjaChjb250cm9scywgZnVuY3Rpb24oY29udHJvbCkgewogICAgICBjb250cm9sLiRzZXRQcmlzdGluZSgpOwogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJHNldFVudG91Y2hlZAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cyB0aGUgZm9ybSB0byBpdHMgdW50b3VjaGVkIHN0YXRlLgogICAqCiAgICogVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB0byByZW1vdmUgdGhlICduZy10b3VjaGVkJyBjbGFzcyBhbmQgc2V0IHRoZSBmb3JtIGNvbnRyb2xzIHRvIHRoZWlyCiAgICogdW50b3VjaGVkIHN0YXRlIChuZy11bnRvdWNoZWQgY2xhc3MpLgogICAqCiAgICogU2V0dGluZyBhIGZvcm0gY29udHJvbHMgYmFjayB0byB0aGVpciB1bnRvdWNoZWQgc3RhdGUgaXMgb2Z0ZW4gdXNlZnVsIHdoZW4gc2V0dGluZyB0aGUgZm9ybQogICAqIGJhY2sgdG8gaXRzIHByaXN0aW5lIHN0YXRlLgogICAqLwogIGZvcm0uJHNldFVudG91Y2hlZCA9IGZ1bmN0aW9uICgpIHsKICAgIGZvckVhY2goY29udHJvbHMsIGZ1bmN0aW9uKGNvbnRyb2wpIHsKICAgICAgY29udHJvbC4kc2V0VW50b3VjaGVkKCk7CiAgICB9KTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgZm9ybS5Gb3JtQ29udHJvbGxlciMkc2V0U3VibWl0dGVkCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXRzIHRoZSBmb3JtIHRvIGl0cyBzdWJtaXR0ZWQgc3RhdGUuCiAgICovCiAgZm9ybS4kc2V0U3VibWl0dGVkID0gZnVuY3Rpb24gKCkgewogICAgJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgU1VCTUlUVEVEX0NMQVNTKTsKICAgIGZvcm0uJHN1Ym1pdHRlZCA9IHRydWU7CiAgICBwYXJlbnRGb3JtLiRzZXRTdWJtaXR0ZWQoKTsKICB9Owp9CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0Zvcm0KICogQHJlc3RyaWN0IEVBQwogKgogKiBAZGVzY3JpcHRpb24KICogTmVzdGFibGUgYWxpYXMgb2Yge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtIGBmb3JtYH0gZGlyZWN0aXZlLiBIVE1MCiAqIGRvZXMgbm90IGFsbG93IG5lc3Rpbmcgb2YgZm9ybSBlbGVtZW50cy4gSXQgaXMgdXNlZnVsIHRvIG5lc3QgZm9ybXMsIGZvciBleGFtcGxlIGlmIHRoZSB2YWxpZGl0eSBvZiBhCiAqIHN1Yi1ncm91cCBvZiBjb250cm9scyBuZWVkcyB0byBiZSBkZXRlcm1pbmVkLgogKgogKiBOb3RlOiB0aGUgcHVycG9zZSBvZiBgbmdGb3JtYCBpcyB0byBncm91cCBjb250cm9scywKICogYnV0IG5vdCB0byBiZSBhIHJlcGxhY2VtZW50IGZvciB0aGUgYDxmb3JtPmAgdGFnIHdpdGggYWxsIG9mIGl0cyBjYXBhYmlsaXRpZXMKICogKGUuZy4gcG9zdGluZyB0byB0aGUgc2VydmVyLCAuLi4pLgogKgogKiBAcGFyYW0ge3N0cmluZz19IG5nRm9ybXxuYW1lIE5hbWUgb2YgdGhlIGZvcm0uIElmIHNwZWNpZmllZCwgdGhlIGZvcm0gY29udHJvbGxlciB3aWxsIGJlIHB1Ymxpc2hlZCBpbnRvCiAqICAgICAgICAgICAgICAgICAgICAgICByZWxhdGVkIHNjb3BlLCB1bmRlciB0aGlzIG5hbWUuCiAqCiAqLwoKIC8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGZvcm0KICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIERpcmVjdGl2ZSB0aGF0IGluc3RhbnRpYXRlcwogKiB7QGxpbmsgZm9ybS5Gb3JtQ29udHJvbGxlciBGb3JtQ29udHJvbGxlcn0uCiAqCiAqIElmIHRoZSBgbmFtZWAgYXR0cmlidXRlIGlzIHNwZWNpZmllZCwgdGhlIGZvcm0gY29udHJvbGxlciBpcyBwdWJsaXNoZWQgb250byB0aGUgY3VycmVudCBzY29wZSB1bmRlcgogKiB0aGlzIG5hbWUuCiAqCiAqICMgQWxpYXM6IHtAbGluayBuZy5kaXJlY3RpdmU6bmdGb3JtIGBuZ0Zvcm1gfQogKgogKiBJbiBBbmd1bGFyIGZvcm1zIGNhbiBiZSBuZXN0ZWQuIFRoaXMgbWVhbnMgdGhhdCB0aGUgb3V0ZXIgZm9ybSBpcyB2YWxpZCB3aGVuIGFsbCBvZiB0aGUgY2hpbGQKICogZm9ybXMgYXJlIHZhbGlkIGFzIHdlbGwuIEhvd2V2ZXIsIGJyb3dzZXJzIGRvIG5vdCBhbGxvdyBuZXN0aW5nIG9mIGA8Zm9ybT5gIGVsZW1lbnRzLCBzbwogKiBBbmd1bGFyIHByb3ZpZGVzIHRoZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nRm9ybSBgbmdGb3JtYH0gZGlyZWN0aXZlIHdoaWNoIGJlaGF2ZXMgaWRlbnRpY2FsbHkgdG8KICogYDxmb3JtPmAgYnV0IGNhbiBiZSBuZXN0ZWQuICBUaGlzIGFsbG93cyB5b3UgdG8gaGF2ZSBuZXN0ZWQgZm9ybXMsIHdoaWNoIGlzIHZlcnkgdXNlZnVsIHdoZW4KICogdXNpbmcgQW5ndWxhciB2YWxpZGF0aW9uIGRpcmVjdGl2ZXMgaW4gZm9ybXMgdGhhdCBhcmUgZHluYW1pY2FsbHkgZ2VuZXJhdGVkIHVzaW5nIHRoZQogKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IGBuZ1JlcGVhdGB9IGRpcmVjdGl2ZS4gU2luY2UgeW91IGNhbm5vdCBkeW5hbWljYWxseSBnZW5lcmF0ZSB0aGUgYG5hbWVgCiAqIGF0dHJpYnV0ZSBvZiBpbnB1dCBlbGVtZW50cyB1c2luZyBpbnRlcnBvbGF0aW9uLCB5b3UgaGF2ZSB0byB3cmFwIGVhY2ggc2V0IG9mIHJlcGVhdGVkIGlucHV0cyBpbiBhbgogKiBgbmdGb3JtYCBkaXJlY3RpdmUgYW5kIG5lc3QgdGhlc2UgaW4gYW4gb3V0ZXIgYGZvcm1gIGVsZW1lbnQuCiAqCiAqCiAqICMgQ1NTIGNsYXNzZXMKICogIC0gYG5nLXZhbGlkYCBpcyBzZXQgaWYgdGhlIGZvcm0gaXMgdmFsaWQuCiAqICAtIGBuZy1pbnZhbGlkYCBpcyBzZXQgaWYgdGhlIGZvcm0gaXMgaW52YWxpZC4KICogIC0gYG5nLXByaXN0aW5lYCBpcyBzZXQgaWYgdGhlIGZvcm0gaXMgcHJpc3RpbmUuCiAqICAtIGBuZy1kaXJ0eWAgaXMgc2V0IGlmIHRoZSBmb3JtIGlzIGRpcnR5LgogKiAgLSBgbmctc3VibWl0dGVkYCBpcyBzZXQgaWYgdGhlIGZvcm0gd2FzIHN1Ym1pdHRlZC4KICoKICogS2VlcCBpbiBtaW5kIHRoYXQgbmdBbmltYXRlIGNhbiBkZXRlY3QgZWFjaCBvZiB0aGVzZSBjbGFzc2VzIHdoZW4gYWRkZWQgYW5kIHJlbW92ZWQuCiAqCiAqCiAqICMgU3VibWl0dGluZyBhIGZvcm0gYW5kIHByZXZlbnRpbmcgdGhlIGRlZmF1bHQgYWN0aW9uCiAqCiAqIFNpbmNlIHRoZSByb2xlIG9mIGZvcm1zIGluIGNsaWVudC1zaWRlIEFuZ3VsYXIgYXBwbGljYXRpb25zIGlzIGRpZmZlcmVudCB0aGFuIGluIGNsYXNzaWNhbAogKiByb3VuZHRyaXAgYXBwcywgaXQgaXMgZGVzaXJhYmxlIGZvciB0aGUgYnJvd3NlciBub3QgdG8gdHJhbnNsYXRlIHRoZSBmb3JtIHN1Ym1pc3Npb24gaW50byBhIGZ1bGwKICogcGFnZSByZWxvYWQgdGhhdCBzZW5kcyB0aGUgZGF0YSB0byB0aGUgc2VydmVyLiBJbnN0ZWFkIHNvbWUgamF2YXNjcmlwdCBsb2dpYyBzaG91bGQgYmUgdHJpZ2dlcmVkCiAqIHRvIGhhbmRsZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGluIGFuIGFwcGxpY2F0aW9uLXNwZWNpZmljIHdheS4KICoKICogRm9yIHRoaXMgcmVhc29uLCBBbmd1bGFyIHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAoZm9ybSBzdWJtaXNzaW9uIHRvIHRoZSBzZXJ2ZXIpIHVubGVzcyB0aGUKICogYDxmb3JtPmAgZWxlbWVudCBoYXMgYW4gYGFjdGlvbmAgYXR0cmlidXRlIHNwZWNpZmllZC4KICoKICogWW91IGNhbiB1c2Ugb25lIG9mIHRoZSBmb2xsb3dpbmcgdHdvIHdheXMgdG8gc3BlY2lmeSB3aGF0IGphdmFzY3JpcHQgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgd2hlbgogKiBhIGZvcm0gaXMgc3VibWl0dGVkOgogKgogKiAtIHtAbGluayBuZy5kaXJlY3RpdmU6bmdTdWJtaXQgbmdTdWJtaXR9IGRpcmVjdGl2ZSBvbiB0aGUgZm9ybSBlbGVtZW50CiAqIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9IGRpcmVjdGl2ZSBvbiB0aGUgZmlyc3QKICAqICBidXR0b24gb3IgaW5wdXQgZmllbGQgb2YgdHlwZSBzdWJtaXQgKGlucHV0W3R5cGU9c3VibWl0XSkKICoKICogVG8gcHJldmVudCBkb3VibGUgZXhlY3V0aW9uIG9mIHRoZSBoYW5kbGVyLCB1c2Ugb25seSBvbmUgb2YgdGhlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdTdWJtaXQgbmdTdWJtaXR9CiAqIG9yIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfSBkaXJlY3RpdmVzLgogKiBUaGlzIGlzIGJlY2F1c2Ugb2YgdGhlIGZvbGxvd2luZyBmb3JtIHN1Ym1pc3Npb24gcnVsZXMgaW4gdGhlIEhUTUwgc3BlY2lmaWNhdGlvbjoKICoKICogLSBJZiBhIGZvcm0gaGFzIG9ubHkgb25lIGlucHV0IGZpZWxkIHRoZW4gaGl0dGluZyBlbnRlciBpbiB0aGlzIGZpZWxkIHRyaWdnZXJzIGZvcm0gc3VibWl0CiAqIChgbmdTdWJtaXRgKQogKiAtIGlmIGEgZm9ybSBoYXMgMisgaW5wdXQgZmllbGRzIGFuZCBubyBidXR0b25zIG9yIGlucHV0W3R5cGU9c3VibWl0XSB0aGVuIGhpdHRpbmcgZW50ZXIKICogZG9lc24ndCB0cmlnZ2VyIHN1Ym1pdAogKiAtIGlmIGEgZm9ybSBoYXMgb25lIG9yIG1vcmUgaW5wdXQgZmllbGRzIGFuZCBvbmUgb3IgbW9yZSBidXR0b25zIG9yIGlucHV0W3R5cGU9c3VibWl0XSB0aGVuCiAqIGhpdHRpbmcgZW50ZXIgaW4gYW55IG9mIHRoZSBpbnB1dCBmaWVsZHMgd2lsbCB0cmlnZ2VyIHRoZSBjbGljayBoYW5kbGVyIG9uIHRoZSAqZmlyc3QqIGJ1dHRvbiBvcgogKiBpbnB1dFt0eXBlPXN1Ym1pdF0gKGBuZ0NsaWNrYCkgKmFuZCogYSBzdWJtaXQgaGFuZGxlciBvbiB0aGUgZW5jbG9zaW5nIGZvcm0gKGBuZ1N1Ym1pdGApCiAqCiAqIEFueSBwZW5kaW5nIGBuZ01vZGVsT3B0aW9uc2AgY2hhbmdlcyB3aWxsIHRha2UgcGxhY2UgaW1tZWRpYXRlbHkgd2hlbiBhbiBlbmNsb3NpbmcgZm9ybSBpcwogKiBzdWJtaXR0ZWQuIE5vdGUgdGhhdCBgbmdDbGlja2AgZXZlbnRzIHdpbGwgb2NjdXIgYmVmb3JlIHRoZSBtb2RlbCBpcyB1cGRhdGVkLiBVc2UgYG5nU3VibWl0YAogKiB0byBoYXZlIGFjY2VzcyB0byB0aGUgdXBkYXRlZCBtb2RlbC4KICoKICogIyMgQW5pbWF0aW9uIEhvb2tzCiAqCiAqIEFuaW1hdGlvbnMgaW4gbmdGb3JtIGFyZSB0cmlnZ2VyZWQgd2hlbiBhbnkgb2YgdGhlIGFzc29jaWF0ZWQgQ1NTIGNsYXNzZXMgYXJlIGFkZGVkIGFuZCByZW1vdmVkLgogKiBUaGVzZSBjbGFzc2VzIGFyZTogYC5uZy1wcmlzdGluZWAsIGAubmctZGlydHlgLCBgLm5nLWludmFsaWRgIGFuZCBgLm5nLXZhbGlkYCBhcyB3ZWxsIGFzIGFueQogKiBvdGhlciB2YWxpZGF0aW9ucyB0aGF0IGFyZSBwZXJmb3JtZWQgd2l0aGluIHRoZSBmb3JtLiBBbmltYXRpb25zIGluIG5nRm9ybSBhcmUgc2ltaWxhciB0byBob3cKICogdGhleSB3b3JrIGluIG5nQ2xhc3MgYW5kIGFuaW1hdGlvbnMgY2FuIGJlIGhvb2tlZCBpbnRvIHVzaW5nIENTUyB0cmFuc2l0aW9ucywga2V5ZnJhbWVzIGFzIHdlbGwKICogYXMgSlMgYW5pbWF0aW9ucy4KICoKICogVGhlIGZvbGxvd2luZyBleGFtcGxlIHNob3dzIGEgc2ltcGxlIHdheSB0byB1dGlsaXplIENTUyB0cmFuc2l0aW9ucyB0byBzdHlsZSBhIGZvcm0gZWxlbWVudAogKiB0aGF0IGhhcyBiZWVuIHJlbmRlcmVkIGFzIGludmFsaWQgYWZ0ZXIgaXQgaGFzIGJlZW4gdmFsaWRhdGVkOgogKgogKiA8cHJlPgogKiAvL2JlIHN1cmUgdG8gaW5jbHVkZSBuZ0FuaW1hdGUgYXMgYSBtb2R1bGUgdG8gaG9vayBpbnRvIG1vcmUKICogLy9hZHZhbmNlZCBhbmltYXRpb25zCiAqIC5teS1mb3JtIHsKICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICogfQogKiAubXktZm9ybS5uZy1pbnZhbGlkIHsKICogICBiYWNrZ3JvdW5kOiByZWQ7CiAqICAgY29sb3I6d2hpdGU7CiAqIH0KICogPC9wcmU+CiAqCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZSBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiIGZpeEJhc2U9InRydWUiIG1vZHVsZT0iZm9ybUV4YW1wbGUiPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCdmb3JtRXhhbXBsZScsIFtdKQogICAgICAgICAgIC5jb250cm9sbGVyKCdGb3JtQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudXNlclR5cGUgPSAnZ3Vlc3QnOwogICAgICAgICAgIH1dKTsKICAgICAgIDwvc2NyaXB0PgogICAgICAgPHN0eWxlPgogICAgICAgIC5teS1mb3JtIHsKICAgICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICB0cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OwogICAgICAgIH0KICAgICAgICAubXktZm9ybS5uZy1pbnZhbGlkIHsKICAgICAgICAgIGJhY2tncm91bmQ6IHJlZDsKICAgICAgICB9CiAgICAgICA8L3N0eWxlPgogICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJGb3JtQ29udHJvbGxlciIgY2xhc3M9Im15LWZvcm0iPgogICAgICAgICB1c2VyVHlwZTogPGlucHV0IG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idXNlclR5cGUiIHJlcXVpcmVkPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPlJlcXVpcmVkITwvc3Bhbj48YnI+CiAgICAgICAgIDx0dD51c2VyVHlwZSA9IHt7dXNlclR5cGV9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxicj4KICAgICAgICA8L2Zvcm0+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdXNlclR5cGUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3VzZXJUeXBlJykpOwogICAgICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyVHlwZS5nZXRUZXh0KCkpLnRvQ29udGFpbignZ3Vlc3QnKTsKICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB1c2VyVHlwZSA9IGVsZW1lbnQoYnkuYmluZGluZygndXNlclR5cGUnKSk7CiAgICAgICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgICAgICB2YXIgdXNlcklucHV0ID0gZWxlbWVudChieS5tb2RlbCgndXNlclR5cGUnKSk7CgogICAgICAgICAgdXNlcklucHV0LmNsZWFyKCk7CiAgICAgICAgICB1c2VySW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyVHlwZS5nZXRUZXh0KCkpLnRvRXF1YWwoJ3VzZXJUeXBlID0nKTsKICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKgogKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgTmFtZSBvZiB0aGUgZm9ybS4gSWYgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIHdpbGwgYmUgcHVibGlzaGVkIGludG8KICogICAgICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQgc2NvcGUsIHVuZGVyIHRoaXMgbmFtZS4KICovCnZhciBmb3JtRGlyZWN0aXZlRmFjdG9yeSA9IGZ1bmN0aW9uKGlzTmdGb3JtKSB7CiAgcmV0dXJuIFsnJHRpbWVvdXQnLCBmdW5jdGlvbigkdGltZW91dCkgewogICAgdmFyIGZvcm1EaXJlY3RpdmUgPSB7CiAgICAgIG5hbWU6ICdmb3JtJywKICAgICAgcmVzdHJpY3Q6IGlzTmdGb3JtID8gJ0VBQycgOiAnRScsCiAgICAgIGNvbnRyb2xsZXI6IEZvcm1Db250cm9sbGVyLAogICAgICBjb21waWxlOiBmdW5jdGlvbiBuZ0Zvcm1Db21waWxlKGZvcm1FbGVtZW50KSB7CiAgICAgICAgLy8gU2V0dXAgaW5pdGlhbCBzdGF0ZSBvZiB0aGUgY29udHJvbAogICAgICAgIGZvcm1FbGVtZW50LmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKS5hZGRDbGFzcyhWQUxJRF9DTEFTUyk7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwcmU6IGZ1bmN0aW9uIG5nRm9ybVByZUxpbmsoc2NvcGUsIGZvcm1FbGVtZW50LCBhdHRyLCBjb250cm9sbGVyKSB7CiAgICAgICAgICAgIC8vIGlmIGBhY3Rpb25gIGF0dHIgaXMgbm90IHByZXNlbnQgb24gdGhlIGZvcm0sIHByZXZlbnQgdGhlIGRlZmF1bHQgYWN0aW9uIChzdWJtaXNzaW9uKQogICAgICAgICAgICBpZiAoISgnYWN0aW9uJyBpbiBhdHRyKSkgewogICAgICAgICAgICAgIC8vIHdlIGNhbid0IHVzZSBqcSBldmVudHMgYmVjYXVzZSBpZiBhIGZvcm0gaXMgZGVzdHJveWVkIGR1cmluZyBzdWJtaXNzaW9uIHRoZSBkZWZhdWx0CiAgICAgICAgICAgICAgLy8gYWN0aW9uIGlzIG5vdCBwcmV2ZW50ZWQuIHNlZSAjMTIzOAogICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgLy8gSUUgOSBpcyBub3QgYWZmZWN0ZWQgYmVjYXVzZSBpdCBkb2Vzbid0IGZpcmUgYSBzdWJtaXQgZXZlbnQgYW5kIHRyeSB0byBkbyBhIGZ1bGwKICAgICAgICAgICAgICAvLyBwYWdlIHJlbG9hZCBpZiB0aGUgZm9ybSB3YXMgZGVzdHJveWVkIGJ5IHN1Ym1pc3Npb24gb2YgdGhlIGZvcm0gdmlhIGEgY2xpY2sgaGFuZGxlcgogICAgICAgICAgICAgIC8vIG9uIGEgYnV0dG9uIGluIHRoZSBmb3JtLiBMb29rcyBsaWtlIGFuIElFOSBzcGVjaWZpYyBidWcuCiAgICAgICAgICAgICAgdmFyIGhhbmRsZUZvcm1TdWJtaXNzaW9uID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbGxlci4kY29tbWl0Vmlld1ZhbHVlKCk7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFN1Ym1pdHRlZCgpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQKICAgICAgICAgICAgICAgICAgPyBldmVudC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgICAgICAgICAgIDogZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsgLy8gSUUKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICBhZGRFdmVudExpc3RlbmVyRm4oZm9ybUVsZW1lbnRbMF0sICdzdWJtaXQnLCBoYW5kbGVGb3JtU3VibWlzc2lvbik7CgogICAgICAgICAgICAgIC8vIHVucmVnaXN0ZXIgdGhlIHByZXZlbnREZWZhdWx0IGxpc3RlbmVyIHNvIHRoYXQgd2UgZG9uJ3Qgbm90IGxlYWsgbWVtb3J5IGJ1dCBpbiBhCiAgICAgICAgICAgICAgLy8gd2F5IHRoYXQgd2lsbCBhY2hpZXZlIHRoZSBwcmV2ZW50aW9uIG9mIHRoZSBkZWZhdWx0IGFjdGlvbi4KICAgICAgICAgICAgICBmb3JtRWxlbWVudC5vbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZm9ybUVsZW1lbnRbMF0sICdzdWJtaXQnLCBoYW5kbGVGb3JtU3VibWlzc2lvbik7CiAgICAgICAgICAgICAgICB9LCAwLCBmYWxzZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBwYXJlbnRGb3JtQ3RybCA9IGNvbnRyb2xsZXIuJCRwYXJlbnRGb3JtLAogICAgICAgICAgICAgICAgYWxpYXMgPSBjb250cm9sbGVyLiRuYW1lOwoKICAgICAgICAgICAgaWYgKGFsaWFzKSB7CiAgICAgICAgICAgICAgc2V0dGVyKHNjb3BlLCBhbGlhcywgY29udHJvbGxlciwgYWxpYXMpOwogICAgICAgICAgICAgIGF0dHIuJG9ic2VydmUoYXR0ci5uYW1lID8gJ25hbWUnIDogJ25nRm9ybScsIGZ1bmN0aW9uKG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoYWxpYXMgPT09IG5ld1ZhbHVlKSByZXR1cm47CiAgICAgICAgICAgICAgICBzZXR0ZXIoc2NvcGUsIGFsaWFzLCB1bmRlZmluZWQsIGFsaWFzKTsKICAgICAgICAgICAgICAgIGFsaWFzID0gbmV3VmFsdWU7CiAgICAgICAgICAgICAgICBzZXR0ZXIoc2NvcGUsIGFsaWFzLCBjb250cm9sbGVyLCBhbGlhcyk7CiAgICAgICAgICAgICAgICBwYXJlbnRGb3JtQ3RybC4kJHJlbmFtZUNvbnRyb2woY29udHJvbGxlciwgYWxpYXMpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvcm1FbGVtZW50Lm9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHBhcmVudEZvcm1DdHJsLiRyZW1vdmVDb250cm9sKGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgIGlmIChhbGlhcykgewogICAgICAgICAgICAgICAgc2V0dGVyKHNjb3BlLCBhbGlhcywgdW5kZWZpbmVkLCBhbGlhcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4dGVuZChjb250cm9sbGVyLCBudWxsRm9ybUN0cmwpOyAvL3N0b3AgcHJvcGFnYXRpbmcgY2hpbGQgZGVzdHJ1Y3Rpb24gaGFuZGxlcnMgdXB3YXJkcwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBmb3JtRGlyZWN0aXZlOwogIH1dOwp9OwoKdmFyIGZvcm1EaXJlY3RpdmUgPSBmb3JtRGlyZWN0aXZlRmFjdG9yeSgpOwp2YXIgbmdGb3JtRGlyZWN0aXZlID0gZm9ybURpcmVjdGl2ZUZhY3RvcnkodHJ1ZSk7CgovKiBnbG9iYWwgVkFMSURfQ0xBU1M6IHRydWUsCiAgSU5WQUxJRF9DTEFTUzogdHJ1ZSwKICBQUklTVElORV9DTEFTUzogdHJ1ZSwKICBESVJUWV9DTEFTUzogdHJ1ZSwKICBVTlRPVUNIRURfQ0xBU1M6IHRydWUsCiAgVE9VQ0hFRF9DTEFTUzogdHJ1ZSwKKi8KCi8vIFJlZ2V4IGNvZGUgaXMgb2J0YWluZWQgZnJvbSBTTzogaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzE0MzA3MC9qYXZhc2NyaXB0LXJlZ2V4LWlzby1kYXRldGltZSNhbnN3ZXItMzE0MzIzMQp2YXIgSVNPX0RBVEVfUkVHRVhQID0gL1xkezR9LVswMV1cZC1bMC0zXVxkVFswLTJdXGQ6WzAtNV1cZDpbMC01XVxkXC5cZCsoWystXVswLTJdXGQ6WzAtNV1cZHxaKS87CnZhciBVUkxfUkVHRVhQID0gL14oZnRwfGh0dHB8aHR0cHMpOlwvXC8oXHcrOnswLDF9XHcqQCk/KFxTKykoOlswLTldKyk/KFwvfFwvKFtcdyMhOi4/Kz0mJUAhXC1cL10pKT8kLzsKdmFyIEVNQUlMX1JFR0VYUCA9IC9eW2EtejAtOSEjJCUmJyorXC89P15fYHt8fX4uLV0rQFthLXowLTldKFthLXowLTktXSpbYS16MC05XSk/KFwuW2EtejAtOV0oW2EtejAtOS1dKlthLXowLTldKT8pKiQvaTsKdmFyIE5VTUJFUl9SRUdFWFAgPSAvXlxzKihcLXxcKyk/KFxkK3woXGQqKFwuXGQqKSkpXHMqJC87CnZhciBEQVRFX1JFR0VYUCA9IC9eKFxkezR9KS0oXGR7Mn0pLShcZHsyfSkkLzsKdmFyIERBVEVUSU1FTE9DQUxfUkVHRVhQID0gL14oXGR7NH0pLShcZFxkKS0oXGRcZClUKFxkXGQpOihcZFxkKSg/OjooXGRcZCkoXC5cZHsxLDN9KT8pPyQvOwp2YXIgV0VFS19SRUdFWFAgPSAvXihcZHs0fSktVyhcZFxkKSQvOwp2YXIgTU9OVEhfUkVHRVhQID0gL14oXGR7NH0pLShcZFxkKSQvOwp2YXIgVElNRV9SRUdFWFAgPSAvXihcZFxkKTooXGRcZCkoPzo6KFxkXGQpKFwuXGR7MSwzfSk/KT8kLzsKdmFyIERFRkFVTFRfUkVHRVhQID0gLyhccyt8XilkZWZhdWx0KFxzK3wkKS87Cgp2YXIgJG5nTW9kZWxNaW5FcnIgPSBuZXcgbWluRXJyKCduZ01vZGVsJyk7Cgp2YXIgaW5wdXRUeXBlID0gewoKICAvKioKICAgKiBAbmdkb2MgaW5wdXQKICAgKiBAbmFtZSBpbnB1dFt0ZXh0XQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU3RhbmRhcmQgSFRNTCB0ZXh0IGlucHV0IHdpdGggYW5ndWxhciBkYXRhIGJpbmRpbmcsIGluaGVyaXRlZCBieSBtb3N0IG9mIHRoZSBgaW5wdXRgIGVsZW1lbnRzLgogICAqCiAgICogKk5PVEUqIE5vdCBldmVyeSBmZWF0dXJlIG9mZmVyZWQgaXMgYXZhaWxhYmxlIGZvciBhbGwgaW5wdXQgdHlwZXMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICogICAgbWlubGVuZ3RoLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgKiAgICBtYXhsZW5ndGguCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gW25nVHJpbT10cnVlXSBJZiBzZXQgdG8gZmFsc2UgQW5ndWxhciB3aWxsIG5vdCBhdXRvbWF0aWNhbGx5IHRyaW0gdGhlIGlucHV0LgogICAqICAgIFRoaXMgcGFyYW1ldGVyIGlzIGlnbm9yZWQgZm9yIGlucHV0W3R5cGU9cGFzc3dvcmRdIGNvbnRyb2xzLCB3aGljaCB3aWxsIG5ldmVyIHRyaW0gdGhlCiAgICogICAgaW5wdXQuCiAgICoKICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBuYW1lPSJ0ZXh0LWlucHV0LWRpcmVjdGl2ZSIgbW9kdWxlPSJ0ZXh0SW5wdXRFeGFtcGxlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICBhbmd1bGFyLm1vZHVsZSgndGV4dElucHV0RXhhbXBsZScsIFtdKQogICAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnZ3Vlc3QnOwogICAgICAgICAgICAgICAkc2NvcGUud29yZCA9IC9eXHMqXHcqXHMqJC87CiAgICAgICAgICAgICB9XSk7CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgICBTaW5nbGUgd29yZDogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idGV4dCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5nLXBhdHRlcm49IndvcmQiIHJlcXVpcmVkIG5nLXRyaW09ImZhbHNlIj4KICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5wYXR0ZXJuIj4KICAgICAgICAgICAgIFNpbmdsZSB3b3JkIG9ubHkhPC9zcGFuPgoKICAgICAgICAgICA8dHQ+dGV4dCA9IHt7dGV4dH19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICAgICAgIDwvZm9ybT4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgICB2YXIgdGV4dCA9IGVsZW1lbnQoYnkuYmluZGluZygndGV4dCcpKTsKICAgICAgICAgIHZhciB2YWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKTsKICAgICAgICAgIHZhciBpbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3RleHQnKSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdCh0ZXh0LmdldFRleHQoKSkudG9Db250YWluKCdndWVzdCcpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygnJyk7CgogICAgICAgICAgICBleHBlY3QodGV4dC5nZXRUZXh0KCkpLnRvRXF1YWwoJ3RleHQgPScpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbXVsdGkgd29yZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygnaGVsbG8gd29ybGQnKTsKCiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgIDwvZmlsZT4KICAgICAgPC9leGFtcGxlPgogICAqLwogICd0ZXh0JzogdGV4dElucHV0VHlwZSwKCiAgICAvKioKICAgICAqIEBuZ2RvYyBpbnB1dAogICAgICogQG5hbWUgaW5wdXRbZGF0ZV0KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIElucHV0IHdpdGggZGF0ZSB2YWxpZGF0aW9uIGFuZCB0cmFuc2Zvcm1hdGlvbi4gSW4gYnJvd3NlcnMgdGhhdCBkbyBub3QgeWV0IHN1cHBvcnQKICAgICAqIHRoZSBIVE1MNSBkYXRlIGlucHV0LCBhIHRleHQgZWxlbWVudCB3aWxsIGJlIHVzZWQuIEluIHRoYXQgY2FzZSwgdGV4dCBtdXN0IGJlIGVudGVyZWQgaW4gYSB2YWxpZCBJU08tODYwMQogICAgICogZGF0ZSBmb3JtYXQgKHl5eXktTU0tZGQpLCBmb3IgZXhhbXBsZTogYDIwMDktMDEtMDZgLiBTaW5jZSBtYW55CiAgICAgKiBtb2Rlcm4gYnJvd3NlcnMgZG8gbm90IHlldCBzdXBwb3J0IHRoaXMgaW5wdXQgdHlwZSwgaXQgaXMgaW1wb3J0YW50IHRvIHByb3ZpZGUgY3VlcyB0byB1c2VycyBvbiB0aGUKICAgICAqIGV4cGVjdGVkIGlucHV0IGZvcm1hdCB2aWEgYSBwbGFjZWhvbGRlciBvciBsYWJlbC4gVGhlIG1vZGVsIG11c3QgYWx3YXlzIGJlIGEgRGF0ZSBvYmplY3QuCiAgICAgKgogICAgICogVGhlIHRpbWV6b25lIHRvIGJlIHVzZWQgdG8gcmVhZC93cml0ZSB0aGUgYERhdGVgIGluc3RhbmNlIGluIHRoZSBtb2RlbCBjYW4gYmUgZGVmaW5lZCB1c2luZwogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ01vZGVsT3B0aW9ucyBuZ01vZGVsT3B0aW9uc30uIEJ5IGRlZmF1bHQsIHRoaXMgaXMgdGhlIHRpbWV6b25lIG9mIHRoZSBicm93c2VyLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWluIFNldHMgdGhlIGBtaW5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGxlc3MgdGhhbiBgbWluYC4gVGhpcyBtdXN0IGJlIGEKICAgICAqIHZhbGlkIElTTyBkYXRlIHN0cmluZyAoeXl5eS1NTS1kZCkuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG1heCBTZXRzIHRoZSBgbWF4YCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBncmVhdGVyIHRoYW4gYG1heGAuIFRoaXMgbXVzdCBiZQogICAgICogYSB2YWxpZCBJU08gZGF0ZSBzdHJpbmcgKHl5eXktTU0tZGQpLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZSBuYW1lPSJkYXRlLWlucHV0LWRpcmVjdGl2ZSIgbW9kdWxlPSJkYXRlSW5wdXRFeGFtcGxlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICBhbmd1bGFyLm1vZHVsZSgnZGF0ZUlucHV0RXhhbXBsZScsIFtdKQogICAgICAgICAgICAuY29udHJvbGxlcignRGF0ZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAgICRzY29wZS52YWx1ZSA9IG5ldyBEYXRlKDIwMTMsIDksIDIyKTsKICAgICAgICAgICAgfV0pOwogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkRhdGVDb250cm9sbGVyIGFzIGRhdGVDdHJsIj4KICAgICAgICAgIFBpY2sgYSBkYXRlIGluIDIwMTM6CiAgICAgICAgICA8aW5wdXQgdHlwZT0iZGF0ZSIgaWQ9ImV4YW1wbGVJbnB1dCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ2YWx1ZSIKICAgICAgICAgICAgICBwbGFjZWhvbGRlcj0ieXl5eS1NTS1kZCIgbWluPSIyMDEzLTAxLTAxIiBtYXg9IjIwMTMtMTItMzEiIHJlcXVpcmVkIC8+CiAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5kYXRlIj4KICAgICAgICAgICAgICBOb3QgYSB2YWxpZCBkYXRlITwvc3Bhbj4KICAgICAgICAgICA8dHQ+dmFsdWUgPSB7e3ZhbHVlIHwgZGF0ZTogInl5eXktTU0tZGQifX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgPC9mb3JtPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICB2YXIgdmFsdWUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3ZhbHVlIHwgZGF0ZTogInl5eXktTU0tZGQiJykpOwogICAgICAgIHZhciB2YWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKTsKICAgICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKTsKCiAgICAgICAgLy8gY3VycmVudGx5IHByb3RyYWN0b3Ivd2ViZHJpdmVyIGRvZXMgbm90IHN1cHBvcnQKICAgICAgICAvLyBzZW5kaW5nIGtleXMgdG8gYWxsIGtub3duIEhUTUw1IGlucHV0IGNvbnRyb2xzCiAgICAgICAgLy8gZm9yIHZhcmlvdXMgYnJvd3NlcnMgKHNlZSBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9wcm90cmFjdG9yL2lzc3Vlcy81NjIpLgogICAgICAgIGZ1bmN0aW9uIHNldElucHV0KHZhbCkgewogICAgICAgICAgLy8gc2V0IHRoZSB2YWx1ZSBvZiB0aGUgZWxlbWVudCBhbmQgZm9yY2UgdmFsaWRhdGlvbi4KICAgICAgICAgIHZhciBzY3IgPSAidmFyIGlwdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdleGFtcGxlSW5wdXQnKTsgIiArCiAgICAgICAgICAiaXB0LnZhbHVlID0gJyIgKyB2YWwgKyAiJzsiICsKICAgICAgICAgICJhbmd1bGFyLmVsZW1lbnQoaXB0KS5zY29wZSgpLiRhcHBseShmdW5jdGlvbihzKSB7IHMubXlGb3JtW2lwdC5uYW1lXS4kc2V0Vmlld1ZhbHVlKCciICsgdmFsICsgIicpOyB9KTsiOwogICAgICAgICAgYnJvd3Nlci5leGVjdXRlU2NyaXB0KHNjcik7CiAgICAgICAgfQoKICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvQ29udGFpbignMjAxMy0xMC0yMicpOwogICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdteUZvcm0uaW5wdXQuJHZhbGlkID0gdHJ1ZScpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHNldElucHV0KCcnKTsKICAgICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvRXF1YWwoJ3ZhbHVlID0nKTsKICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignbXlGb3JtLmlucHV0LiR2YWxpZCA9IGZhbHNlJyk7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBvdmVyIG1heCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgc2V0SW5wdXQoJzIwMTUtMDEtMDEnKTsKICAgICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvQ29udGFpbignJyk7CiAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ215Rm9ybS5pbnB1dC4kdmFsaWQgPSBmYWxzZScpOwogICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAnZGF0ZSc6IGNyZWF0ZURhdGVJbnB1dFR5cGUoJ2RhdGUnLCBEQVRFX1JFR0VYUCwKICAgICAgICAgY3JlYXRlRGF0ZVBhcnNlcihEQVRFX1JFR0VYUCwgWyd5eXl5JywgJ01NJywgJ2RkJ10pLAogICAgICAgICAneXl5eS1NTS1kZCcpLAoKICAgLyoqCiAgICAqIEBuZ2RvYyBpbnB1dAogICAgKiBAbmFtZSBpbnB1dFtkYXRlVGltZUxvY2FsXQogICAgKgogICAgKiBAZGVzY3JpcHRpb24KICAgICogSW5wdXQgd2l0aCBkYXRldGltZSB2YWxpZGF0aW9uIGFuZCB0cmFuc2Zvcm1hdGlvbi4gSW4gYnJvd3NlcnMgdGhhdCBkbyBub3QgeWV0IHN1cHBvcnQKICAgICogdGhlIEhUTUw1IGRhdGUgaW5wdXQsIGEgdGV4dCBlbGVtZW50IHdpbGwgYmUgdXNlZC4gSW4gdGhhdCBjYXNlLCB0aGUgdGV4dCBtdXN0IGJlIGVudGVyZWQgaW4gYSB2YWxpZCBJU08tODYwMQogICAgKiBsb2NhbCBkYXRldGltZSBmb3JtYXQgKHl5eXktTU0tZGRUSEg6bW06c3MpLCBmb3IgZXhhbXBsZTogYDIwMTAtMTItMjhUMTQ6NTc6MDBgLiBUaGUgbW9kZWwgbXVzdCBiZSBhIERhdGUgb2JqZWN0LgogICAgKgogICAgKiBUaGUgdGltZXpvbmUgdG8gYmUgdXNlZCB0byByZWFkL3dyaXRlIHRoZSBgRGF0ZWAgaW5zdGFuY2UgaW4gdGhlIG1vZGVsIGNhbiBiZSBkZWZpbmVkIHVzaW5nCiAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbE9wdGlvbnMgbmdNb2RlbE9wdGlvbnN9LiBCeSBkZWZhdWx0LCB0aGlzIGlzIHRoZSB0aW1lem9uZSBvZiB0aGUgYnJvd3Nlci4KICAgICoKICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWluIFNldHMgdGhlIGBtaW5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGxlc3MgdGhhbiBgbWluYC4gVGhpcyBtdXN0IGJlIGEKICAgICogdmFsaWQgSVNPIGRhdGV0aW1lIGZvcm1hdCAoeXl5eS1NTS1kZFRISDptbTpzcykuCiAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWF4IFNldHMgdGhlIGBtYXhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGdyZWF0ZXIgdGhhbiBgbWF4YC4gVGhpcyBtdXN0IGJlCiAgICAqIGEgdmFsaWQgSVNPIGRhdGV0aW1lIGZvcm1hdCAoeXl5eS1NTS1kZFRISDptbTpzcykuCiAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICoKICAgICogQGV4YW1wbGUKICAgIDxleGFtcGxlIG5hbWU9ImRhdGV0aW1lbG9jYWwtaW5wdXQtZGlyZWN0aXZlIiBtb2R1bGU9ImRhdGVFeGFtcGxlIj4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8c2NyaXB0PgogICAgICAgIGFuZ3VsYXIubW9kdWxlKCdkYXRlRXhhbXBsZScsIFtdKQogICAgICAgICAgLmNvbnRyb2xsZXIoJ0RhdGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLnZhbHVlID0gbmV3IERhdGUoMjAxMCwgMTEsIDI4LCAxNCwgNTcpOwogICAgICAgICAgfV0pOwogICAgICA8L3NjcmlwdD4KICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJEYXRlQ29udHJvbGxlciBhcyBkYXRlQ3RybCI+CiAgICAgICAgUGljayBhIGRhdGUgYmV0d2VlbiBpbiAyMDEzOgogICAgICAgIDxpbnB1dCB0eXBlPSJkYXRldGltZS1sb2NhbCIgaWQ9ImV4YW1wbGVJbnB1dCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ2YWx1ZSIKICAgICAgICAgICAgcGxhY2Vob2xkZXI9Inl5eXktTU0tZGRUSEg6bW06c3MiIG1pbj0iMjAwMS0wMS0wMVQwMDowMDowMCIgbWF4PSIyMDEzLTEyLTMxVDAwOjAwOjAwIiByZXF1aXJlZCAvPgogICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IuZGF0ZXRpbWVsb2NhbCI+CiAgICAgICAgICAgIE5vdCBhIHZhbGlkIGRhdGUhPC9zcGFuPgogICAgICAgIDx0dD52YWx1ZSA9IHt7dmFsdWUgfCBkYXRlOiAieXl5eS1NTS1kZFRISDptbTpzcyJ9fTwvdHQ+PGJyLz4KICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgIDwvZm9ybT4KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICB2YXIgdmFsdWUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3ZhbHVlIHwgZGF0ZTogInl5eXktTU0tZGRUSEg6bW06c3MiJykpOwogICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgIHZhciBpbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpOwoKICAgICAgLy8gY3VycmVudGx5IHByb3RyYWN0b3Ivd2ViZHJpdmVyIGRvZXMgbm90IHN1cHBvcnQKICAgICAgLy8gc2VuZGluZyBrZXlzIHRvIGFsbCBrbm93biBIVE1MNSBpbnB1dCBjb250cm9scwogICAgICAvLyBmb3IgdmFyaW91cyBicm93c2VycyAoaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvcHJvdHJhY3Rvci9pc3N1ZXMvNTYyKS4KICAgICAgZnVuY3Rpb24gc2V0SW5wdXQodmFsKSB7CiAgICAgICAgLy8gc2V0IHRoZSB2YWx1ZSBvZiB0aGUgZWxlbWVudCBhbmQgZm9yY2UgdmFsaWRhdGlvbi4KICAgICAgICB2YXIgc2NyID0gInZhciBpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXhhbXBsZUlucHV0Jyk7ICIgKwogICAgICAgICJpcHQudmFsdWUgPSAnIiArIHZhbCArICInOyIgKwogICAgICAgICJhbmd1bGFyLmVsZW1lbnQoaXB0KS5zY29wZSgpLiRhcHBseShmdW5jdGlvbihzKSB7IHMubXlGb3JtW2lwdC5uYW1lXS4kc2V0Vmlld1ZhbHVlKCciICsgdmFsICsgIicpOyB9KTsiOwogICAgICAgIGJyb3dzZXIuZXhlY3V0ZVNjcmlwdChzY3IpOwogICAgICB9CgogICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJzIwMTAtMTItMjhUMTQ6NTc6MDAnKTsKICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ215Rm9ybS5pbnB1dC4kdmFsaWQgPSB0cnVlJyk7CiAgICAgIH0pOwoKICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2V0SW5wdXQoJycpOwogICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvRXF1YWwoJ3ZhbHVlID0nKTsKICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ215Rm9ybS5pbnB1dC4kdmFsaWQgPSBmYWxzZScpOwogICAgICB9KTsKCiAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBvdmVyIG1heCcsIGZ1bmN0aW9uKCkgewogICAgICAgIHNldElucHV0KCcyMDE1LTAxLTAxVDIzOjU5OjAwJyk7CiAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9Db250YWluKCcnKTsKICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ215Rm9ybS5pbnB1dC4kdmFsaWQgPSBmYWxzZScpOwogICAgICB9KTsKICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICAgICovCiAgJ2RhdGV0aW1lLWxvY2FsJzogY3JlYXRlRGF0ZUlucHV0VHlwZSgnZGF0ZXRpbWVsb2NhbCcsIERBVEVUSU1FTE9DQUxfUkVHRVhQLAogICAgICBjcmVhdGVEYXRlUGFyc2VyKERBVEVUSU1FTE9DQUxfUkVHRVhQLCBbJ3l5eXknLCAnTU0nLCAnZGQnLCAnSEgnLCAnbW0nLCAnc3MnLCAnc3NzJ10pLAogICAgICAneXl5eS1NTS1kZFRISDptbTpzcy5zc3MnKSwKCiAgLyoqCiAgICogQG5nZG9jIGlucHV0CiAgICogQG5hbWUgaW5wdXRbdGltZV0KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIElucHV0IHdpdGggdGltZSB2YWxpZGF0aW9uIGFuZCB0cmFuc2Zvcm1hdGlvbi4gSW4gYnJvd3NlcnMgdGhhdCBkbyBub3QgeWV0IHN1cHBvcnQKICAgKiB0aGUgSFRNTDUgZGF0ZSBpbnB1dCwgYSB0ZXh0IGVsZW1lbnQgd2lsbCBiZSB1c2VkLiBJbiB0aGF0IGNhc2UsIHRoZSB0ZXh0IG11c3QgYmUgZW50ZXJlZCBpbiBhIHZhbGlkIElTTy04NjAxCiAgICogbG9jYWwgdGltZSBmb3JtYXQgKEhIOm1tOnNzKSwgZm9yIGV4YW1wbGU6IGAxNDo1NzowMGAuIE1vZGVsIG11c3QgYmUgYSBEYXRlIG9iamVjdC4gVGhpcyBiaW5kaW5nIHdpbGwgYWx3YXlzIG91dHB1dCBhCiAgICogRGF0ZSBvYmplY3QgdG8gdGhlIG1vZGVsIG9mIEphbnVhcnkgMSwgMTk3MCwgb3IgbG9jYWwgZGF0ZSBgbmV3IERhdGUoMTk3MCwgMCwgMSwgSEgsIG1tLCBzcylgLgogICAqCiAgICogVGhlIHRpbWV6b25lIHRvIGJlIHVzZWQgdG8gcmVhZC93cml0ZSB0aGUgYERhdGVgIGluc3RhbmNlIGluIHRoZSBtb2RlbCBjYW4gYmUgZGVmaW5lZCB1c2luZwogICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbE9wdGlvbnMgbmdNb2RlbE9wdGlvbnN9LiBCeSBkZWZhdWx0LCB0aGlzIGlzIHRoZSB0aW1lem9uZSBvZiB0aGUgYnJvd3Nlci4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBtaW4gU2V0cyB0aGUgYG1pbmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGVudGVyZWQgaXMgbGVzcyB0aGFuIGBtaW5gLiBUaGlzIG11c3QgYmUgYQogICAqIHZhbGlkIElTTyB0aW1lIGZvcm1hdCAoSEg6bW06c3MpLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbWF4IFNldHMgdGhlIGBtYXhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGdyZWF0ZXIgdGhhbiBgbWF4YC4gVGhpcyBtdXN0IGJlIGEKICAgKiB2YWxpZCBJU08gdGltZSBmb3JtYXQgKEhIOm1tOnNzKS4KICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbmFtZT0idGltZS1pbnB1dC1kaXJlY3RpdmUiIG1vZHVsZT0idGltZUV4YW1wbGUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8c2NyaXB0PgogICAgICBhbmd1bGFyLm1vZHVsZSgndGltZUV4YW1wbGUnLCBbXSkKICAgICAgICAuY29udHJvbGxlcignRGF0ZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLnZhbHVlID0gbmV3IERhdGUoMTk3MCwgMCwgMSwgMTQsIDU3LCAwKTsKICAgICAgICB9XSk7CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJEYXRlQ29udHJvbGxlciBhcyBkYXRlQ3RybCI+CiAgICAgICAgUGljayBhIGJldHdlZW4gOGFtIGFuZCA1cG06CiAgICAgICAgPGlucHV0IHR5cGU9InRpbWUiIGlkPSJleGFtcGxlSW5wdXQiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idmFsdWUiCiAgICAgICAgICAgIHBsYWNlaG9sZGVyPSJISDptbTpzcyIgbWluPSIwODowMDowMCIgbWF4PSIxNzowMDowMCIgcmVxdWlyZWQgLz4KICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnRpbWUiPgogICAgICAgICAgICBOb3QgYSB2YWxpZCBkYXRlITwvc3Bhbj4KICAgICAgICA8dHQ+dmFsdWUgPSB7e3ZhbHVlIHwgZGF0ZTogIkhIOm1tOnNzIn19PC90dD48YnIvPgogICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICA8L2Zvcm0+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgIHZhciB2YWx1ZSA9IGVsZW1lbnQoYnkuYmluZGluZygndmFsdWUgfCBkYXRlOiAiSEg6bW06c3MiJykpOwogICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgIHZhciBpbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpOwoKICAgICAgLy8gY3VycmVudGx5IHByb3RyYWN0b3Ivd2ViZHJpdmVyIGRvZXMgbm90IHN1cHBvcnQKICAgICAgLy8gc2VuZGluZyBrZXlzIHRvIGFsbCBrbm93biBIVE1MNSBpbnB1dCBjb250cm9scwogICAgICAvLyBmb3IgdmFyaW91cyBicm93c2VycyAoaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvcHJvdHJhY3Rvci9pc3N1ZXMvNTYyKS4KICAgICAgZnVuY3Rpb24gc2V0SW5wdXQodmFsKSB7CiAgICAgICAgLy8gc2V0IHRoZSB2YWx1ZSBvZiB0aGUgZWxlbWVudCBhbmQgZm9yY2UgdmFsaWRhdGlvbi4KICAgICAgICB2YXIgc2NyID0gInZhciBpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXhhbXBsZUlucHV0Jyk7ICIgKwogICAgICAgICJpcHQudmFsdWUgPSAnIiArIHZhbCArICInOyIgKwogICAgICAgICJhbmd1bGFyLmVsZW1lbnQoaXB0KS5zY29wZSgpLiRhcHBseShmdW5jdGlvbihzKSB7IHMubXlGb3JtW2lwdC5uYW1lXS4kc2V0Vmlld1ZhbHVlKCciICsgdmFsICsgIicpOyB9KTsiOwogICAgICAgIGJyb3dzZXIuZXhlY3V0ZVNjcmlwdChzY3IpOwogICAgICB9CgogICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJzE0OjU3OjAwJyk7CiAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdteUZvcm0uaW5wdXQuJHZhbGlkID0gdHJ1ZScpOwogICAgICB9KTsKCiAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgIHNldElucHV0KCcnKTsKICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0VxdWFsKCd2YWx1ZSA9Jyk7CiAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdteUZvcm0uaW5wdXQuJHZhbGlkID0gZmFsc2UnKTsKICAgICAgfSk7CgogICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgb3ZlciBtYXgnLCBmdW5jdGlvbigpIHsKICAgICAgICBzZXRJbnB1dCgnMjM6NTk6MDAnKTsKICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJycpOwogICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignbXlGb3JtLmlucHV0LiR2YWxpZCA9IGZhbHNlJyk7CiAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICAndGltZSc6IGNyZWF0ZURhdGVJbnB1dFR5cGUoJ3RpbWUnLCBUSU1FX1JFR0VYUCwKICAgICAgY3JlYXRlRGF0ZVBhcnNlcihUSU1FX1JFR0VYUCwgWydISCcsICdtbScsICdzcycsICdzc3MnXSksCiAgICAgJ0hIOm1tOnNzLnNzcycpLAoKICAgLyoqCiAgICAqIEBuZ2RvYyBpbnB1dAogICAgKiBAbmFtZSBpbnB1dFt3ZWVrXQogICAgKgogICAgKiBAZGVzY3JpcHRpb24KICAgICogSW5wdXQgd2l0aCB3ZWVrLW9mLXRoZS15ZWFyIHZhbGlkYXRpb24gYW5kIHRyYW5zZm9ybWF0aW9uIHRvIERhdGUuIEluIGJyb3dzZXJzIHRoYXQgZG8gbm90IHlldCBzdXBwb3J0CiAgICAqIHRoZSBIVE1MNSB3ZWVrIGlucHV0LCBhIHRleHQgZWxlbWVudCB3aWxsIGJlIHVzZWQuIEluIHRoYXQgY2FzZSwgdGhlIHRleHQgbXVzdCBiZSBlbnRlcmVkIGluIGEgdmFsaWQgSVNPLTg2MDEKICAgICogd2VlayBmb3JtYXQgKHl5eXktVyMjKSwgZm9yIGV4YW1wbGU6IGAyMDEzLVcwMmAuIFRoZSBtb2RlbCBtdXN0IGFsd2F5cyBiZSBhIERhdGUgb2JqZWN0LgogICAgKgogICAgKiBUaGUgdGltZXpvbmUgdG8gYmUgdXNlZCB0byByZWFkL3dyaXRlIHRoZSBgRGF0ZWAgaW5zdGFuY2UgaW4gdGhlIG1vZGVsIGNhbiBiZSBkZWZpbmVkIHVzaW5nCiAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbE9wdGlvbnMgbmdNb2RlbE9wdGlvbnN9LiBCeSBkZWZhdWx0LCB0aGlzIGlzIHRoZSB0aW1lem9uZSBvZiB0aGUgYnJvd3Nlci4KICAgICoKICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWluIFNldHMgdGhlIGBtaW5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGxlc3MgdGhhbiBgbWluYC4gVGhpcyBtdXN0IGJlIGEKICAgICogdmFsaWQgSVNPIHdlZWsgZm9ybWF0ICh5eXl5LVcjIykuCiAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWF4IFNldHMgdGhlIGBtYXhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGdyZWF0ZXIgdGhhbiBgbWF4YC4gVGhpcyBtdXN0IGJlCiAgICAqIGEgdmFsaWQgSVNPIHdlZWsgZm9ybWF0ICh5eXl5LVcjIykuCiAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICoKICAgICogQGV4YW1wbGUKICAgIDxleGFtcGxlIG5hbWU9IndlZWstaW5wdXQtZGlyZWN0aXZlIiBtb2R1bGU9IndlZWtFeGFtcGxlIj4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8c2NyaXB0PgogICAgICBhbmd1bGFyLm1vZHVsZSgnd2Vla0V4YW1wbGUnLCBbXSkKICAgICAgICAuY29udHJvbGxlcignRGF0ZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLnZhbHVlID0gbmV3IERhdGUoMjAxMywgMCwgMyk7CiAgICAgICAgfV0pOwogICAgICA8L3NjcmlwdD4KICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJEYXRlQ29udHJvbGxlciBhcyBkYXRlQ3RybCI+CiAgICAgICAgUGljayBhIGRhdGUgYmV0d2VlbiBpbiAyMDEzOgogICAgICAgIDxpbnB1dCBpZD0iZXhhbXBsZUlucHV0IiB0eXBlPSJ3ZWVrIiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InZhbHVlIgogICAgICAgICAgICBwbGFjZWhvbGRlcj0iWVlZWS1XIyMiIG1pbj0iMjAxMi1XMzIiIG1heD0iMjAxMy1XNTIiIHJlcXVpcmVkIC8+CiAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci53ZWVrIj4KICAgICAgICAgICAgTm90IGEgdmFsaWQgZGF0ZSE8L3NwYW4+CiAgICAgICAgPHR0PnZhbHVlID0ge3t2YWx1ZSB8IGRhdGU6ICJ5eXl5LVd3dyJ9fTwvdHQ+PGJyLz4KICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgIDwvZm9ybT4KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICB2YXIgdmFsdWUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3ZhbHVlIHwgZGF0ZTogInl5eXktV3d3IicpKTsKICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKTsKCiAgICAgIC8vIGN1cnJlbnRseSBwcm90cmFjdG9yL3dlYmRyaXZlciBkb2VzIG5vdCBzdXBwb3J0CiAgICAgIC8vIHNlbmRpbmcga2V5cyB0byBhbGwga25vd24gSFRNTDUgaW5wdXQgY29udHJvbHMKICAgICAgLy8gZm9yIHZhcmlvdXMgYnJvd3NlcnMgKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL3Byb3RyYWN0b3IvaXNzdWVzLzU2MikuCiAgICAgIGZ1bmN0aW9uIHNldElucHV0KHZhbCkgewogICAgICAgIC8vIHNldCB0aGUgdmFsdWUgb2YgdGhlIGVsZW1lbnQgYW5kIGZvcmNlIHZhbGlkYXRpb24uCiAgICAgICAgdmFyIHNjciA9ICJ2YXIgaXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4YW1wbGVJbnB1dCcpOyAiICsKICAgICAgICAiaXB0LnZhbHVlID0gJyIgKyB2YWwgKyAiJzsiICsKICAgICAgICAiYW5ndWxhci5lbGVtZW50KGlwdCkuc2NvcGUoKS4kYXBwbHkoZnVuY3Rpb24ocykgeyBzLm15Rm9ybVtpcHQubmFtZV0uJHNldFZpZXdWYWx1ZSgnIiArIHZhbCArICInKTsgfSk7IjsKICAgICAgICBicm93c2VyLmV4ZWN1dGVTY3JpcHQoc2NyKTsKICAgICAgfQoKICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9Db250YWluKCcyMDEzLVcwMScpOwogICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignbXlGb3JtLmlucHV0LiR2YWxpZCA9IHRydWUnKTsKICAgICAgfSk7CgogICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICBzZXRJbnB1dCgnJyk7CiAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9FcXVhbCgndmFsdWUgPScpOwogICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignbXlGb3JtLmlucHV0LiR2YWxpZCA9IGZhbHNlJyk7CiAgICAgIH0pOwoKICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG92ZXIgbWF4JywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2V0SW5wdXQoJzIwMTUtVzAxJyk7CiAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9Db250YWluKCcnKTsKICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ215Rm9ybS5pbnB1dC4kdmFsaWQgPSBmYWxzZScpOwogICAgICB9KTsKICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICAgICovCiAgJ3dlZWsnOiBjcmVhdGVEYXRlSW5wdXRUeXBlKCd3ZWVrJywgV0VFS19SRUdFWFAsIHdlZWtQYXJzZXIsICd5eXl5LVd3dycpLAoKICAvKioKICAgKiBAbmdkb2MgaW5wdXQKICAgKiBAbmFtZSBpbnB1dFttb250aF0KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIElucHV0IHdpdGggbW9udGggdmFsaWRhdGlvbiBhbmQgdHJhbnNmb3JtYXRpb24uIEluIGJyb3dzZXJzIHRoYXQgZG8gbm90IHlldCBzdXBwb3J0CiAgICogdGhlIEhUTUw1IG1vbnRoIGlucHV0LCBhIHRleHQgZWxlbWVudCB3aWxsIGJlIHVzZWQuIEluIHRoYXQgY2FzZSwgdGhlIHRleHQgbXVzdCBiZSBlbnRlcmVkIGluIGEgdmFsaWQgSVNPLTg2MDEKICAgKiBtb250aCBmb3JtYXQgKHl5eXktTU0pLCBmb3IgZXhhbXBsZTogYDIwMDktMDFgLiBUaGUgbW9kZWwgbXVzdCBhbHdheXMgYmUgYSBEYXRlIG9iamVjdC4gSW4gdGhlIGV2ZW50IHRoZSBtb2RlbCBpcwogICAqIG5vdCBzZXQgdG8gdGhlIGZpcnN0IG9mIHRoZSBtb250aCwgdGhlIGZpcnN0IG9mIHRoYXQgbW9kZWwncyBtb250aCBpcyBhc3N1bWVkLgogICAqCiAgICogVGhlIHRpbWV6b25lIHRvIGJlIHVzZWQgdG8gcmVhZC93cml0ZSB0aGUgYERhdGVgIGluc3RhbmNlIGluIHRoZSBtb2RlbCBjYW4gYmUgZGVmaW5lZCB1c2luZwogICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbE9wdGlvbnMgbmdNb2RlbE9wdGlvbnN9LiBCeSBkZWZhdWx0LCB0aGlzIGlzIHRoZSB0aW1lem9uZSBvZiB0aGUgYnJvd3Nlci4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBtaW4gU2V0cyB0aGUgYG1pbmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGVudGVyZWQgaXMgbGVzcyB0aGFuIGBtaW5gLiBUaGlzIG11c3QgYmUKICAgKiBhIHZhbGlkIElTTyBtb250aCBmb3JtYXQgKHl5eXktTU0pLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbWF4IFNldHMgdGhlIGBtYXhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGdyZWF0ZXIgdGhhbiBgbWF4YC4gVGhpcyBtdXN0CiAgICogYmUgYSB2YWxpZCBJU08gbW9udGggZm9ybWF0ICh5eXl5LU1NKS4KICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbmFtZT0ibW9udGgtaW5wdXQtZGlyZWN0aXZlIiBtb2R1bGU9Im1vbnRoRXhhbXBsZSI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxzY3JpcHQ+CiAgICAgIGFuZ3VsYXIubW9kdWxlKCdtb250aEV4YW1wbGUnLCBbXSkKICAgICAgICAuY29udHJvbGxlcignRGF0ZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLnZhbHVlID0gbmV3IERhdGUoMjAxMywgOSwgMSk7CiAgICAgICAgfV0pOwogICAgIDwvc2NyaXB0PgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iRGF0ZUNvbnRyb2xsZXIgYXMgZGF0ZUN0cmwiPgogICAgICAgUGljayBhIG1vbnRoIGludCAyMDEzOgogICAgICAgPGlucHV0IGlkPSJleGFtcGxlSW5wdXQiIHR5cGU9Im1vbnRoIiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InZhbHVlIgogICAgICAgICAgcGxhY2Vob2xkZXI9Inl5eXktTU0iIG1pbj0iMjAxMy0wMSIgbWF4PSIyMDEzLTEyIiByZXF1aXJlZCAvPgogICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5tb250aCI+CiAgICAgICAgICBOb3QgYSB2YWxpZCBtb250aCE8L3NwYW4+CiAgICAgICA8dHQ+dmFsdWUgPSB7e3ZhbHVlIHwgZGF0ZTogInl5eXktTU0ifX08L3R0Pjxici8+CiAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgPC9mb3JtPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICB2YXIgdmFsdWUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3ZhbHVlIHwgZGF0ZTogInl5eXktTU0iJykpOwogICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgIHZhciBpbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpOwoKICAgICAgLy8gY3VycmVudGx5IHByb3RyYWN0b3Ivd2ViZHJpdmVyIGRvZXMgbm90IHN1cHBvcnQKICAgICAgLy8gc2VuZGluZyBrZXlzIHRvIGFsbCBrbm93biBIVE1MNSBpbnB1dCBjb250cm9scwogICAgICAvLyBmb3IgdmFyaW91cyBicm93c2VycyAoaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvcHJvdHJhY3Rvci9pc3N1ZXMvNTYyKS4KICAgICAgZnVuY3Rpb24gc2V0SW5wdXQodmFsKSB7CiAgICAgICAgLy8gc2V0IHRoZSB2YWx1ZSBvZiB0aGUgZWxlbWVudCBhbmQgZm9yY2UgdmFsaWRhdGlvbi4KICAgICAgICB2YXIgc2NyID0gInZhciBpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXhhbXBsZUlucHV0Jyk7ICIgKwogICAgICAgICJpcHQudmFsdWUgPSAnIiArIHZhbCArICInOyIgKwogICAgICAgICJhbmd1bGFyLmVsZW1lbnQoaXB0KS5zY29wZSgpLiRhcHBseShmdW5jdGlvbihzKSB7IHMubXlGb3JtW2lwdC5uYW1lXS4kc2V0Vmlld1ZhbHVlKCciICsgdmFsICsgIicpOyB9KTsiOwogICAgICAgIGJyb3dzZXIuZXhlY3V0ZVNjcmlwdChzY3IpOwogICAgICB9CgogICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJzIwMTMtMTAnKTsKICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ215Rm9ybS5pbnB1dC4kdmFsaWQgPSB0cnVlJyk7CiAgICAgIH0pOwoKICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2V0SW5wdXQoJycpOwogICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvRXF1YWwoJ3ZhbHVlID0nKTsKICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ215Rm9ybS5pbnB1dC4kdmFsaWQgPSBmYWxzZScpOwogICAgICB9KTsKCiAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBvdmVyIG1heCcsIGZ1bmN0aW9uKCkgewogICAgICAgIHNldElucHV0KCcyMDE1LTAxJyk7CiAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9Db250YWluKCcnKTsKICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ215Rm9ybS5pbnB1dC4kdmFsaWQgPSBmYWxzZScpOwogICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgJ21vbnRoJzogY3JlYXRlRGF0ZUlucHV0VHlwZSgnbW9udGgnLCBNT05USF9SRUdFWFAsCiAgICAgY3JlYXRlRGF0ZVBhcnNlcihNT05USF9SRUdFWFAsIFsneXl5eScsICdNTSddKSwKICAgICAneXl5eS1NTScpLAoKICAvKioKICAgKiBAbmdkb2MgaW5wdXQKICAgKiBAbmFtZSBpbnB1dFtudW1iZXJdCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUZXh0IGlucHV0IHdpdGggbnVtYmVyIHZhbGlkYXRpb24gYW5kIHRyYW5zZm9ybWF0aW9uLiBTZXRzIHRoZSBgbnVtYmVyYCB2YWxpZGF0aW9uCiAgICogZXJyb3IgaWYgbm90IGEgdmFsaWQgbnVtYmVyLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG1pbiBTZXRzIHRoZSBgbWluYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBsZXNzIHRoYW4gYG1pbmAuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBtYXggU2V0cyB0aGUgYG1heGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGVudGVyZWQgaXMgZ3JlYXRlciB0aGFuIGBtYXhgLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICogICAgbWlubGVuZ3RoLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgKiAgICBtYXhsZW5ndGguCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICoKICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBuYW1lPSJudW1iZXItaW5wdXQtZGlyZWN0aXZlIiBtb2R1bGU9Im51bWJlckV4YW1wbGUiPgogICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICA8c2NyaXB0PgogICAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCdudW1iZXJFeGFtcGxlJywgW10pCiAgICAgICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAgICAkc2NvcGUudmFsdWUgPSAxMjsKICAgICAgICAgICAgIH1dKTsKICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgICAgIE51bWJlcjogPGlucHV0IHR5cGU9Im51bWJlciIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ2YWx1ZSIKICAgICAgICAgICAgICAgICAgICAgICAgICBtaW49IjAiIG1heD0iOTkiIHJlcXVpcmVkPgogICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLm51bWJlciI+CiAgICAgICAgICAgICBOb3QgdmFsaWQgbnVtYmVyITwvc3Bhbj4KICAgICAgICAgICA8dHQ+dmFsdWUgPSB7e3ZhbHVlfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICAgPC9mb3JtPgogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICAgIHZhciB2YWx1ZSA9IGVsZW1lbnQoYnkuYmluZGluZygndmFsdWUnKSk7CiAgICAgICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9Db250YWluKCcxMicpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygnJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvRXF1YWwoJ3ZhbHVlID0nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG92ZXIgbWF4JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0LmNsZWFyKCk7CiAgICAgICAgICAgIGlucHV0LnNlbmRLZXlzKCcxMjMnKTsKICAgICAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9FcXVhbCgndmFsdWUgPScpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgIDwvZXhhbXBsZT4KICAgKi8KICAnbnVtYmVyJzogbnVtYmVySW5wdXRUeXBlLAoKCiAgLyoqCiAgICogQG5nZG9jIGlucHV0CiAgICogQG5hbWUgaW5wdXRbdXJsXQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGV4dCBpbnB1dCB3aXRoIFVSTCB2YWxpZGF0aW9uLiBTZXRzIHRoZSBgdXJsYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgY29udGVudCBpcyBub3QgYQogICAqIHZhbGlkIFVSTC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgKiAgICBtaW5sZW5ndGguCiAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAqICAgIG1heGxlbmd0aC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgKgogICAqIEBleGFtcGxlCiAgICAgIDxleGFtcGxlIG5hbWU9InVybC1pbnB1dC1kaXJlY3RpdmUiIG1vZHVsZT0idXJsRXhhbXBsZSI+CiAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ3VybEV4YW1wbGUnLCBbXSkKICAgICAgICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ2h0dHA6Ly9nb29nbGUuY29tJzsKICAgICAgICAgICAgIH1dKTsKICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgICAgIFVSTDogPGlucHV0IHR5cGU9InVybCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IiByZXF1aXJlZD4KICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci51cmwiPgogICAgICAgICAgICAgTm90IHZhbGlkIHVybCE8L3NwYW4+CiAgICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IudXJsID0ge3shIW15Rm9ybS4kZXJyb3IudXJsfX08L3R0Pjxici8+CiAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICAgdmFyIHRleHQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3RleHQnKSk7CiAgICAgICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd0ZXh0JykpOwoKICAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QodGV4dC5nZXRUZXh0KCkpLnRvQ29udGFpbignaHR0cDovL2dvb2dsZS5jb20nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0VxdWFsKCd0ZXh0ID0nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG5vdCB1cmwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJ2JveCcpOwoKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgICovCiAgJ3VybCc6IHVybElucHV0VHlwZSwKCgogIC8qKgogICAqIEBuZ2RvYyBpbnB1dAogICAqIEBuYW1lIGlucHV0W2VtYWlsXQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGV4dCBpbnB1dCB3aXRoIGVtYWlsIHZhbGlkYXRpb24uIFNldHMgdGhlIGBlbWFpbGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgbm90IGEgdmFsaWQgZW1haWwKICAgKiBhZGRyZXNzLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAqICAgIG1pbmxlbmd0aC4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICogICAgbWF4bGVuZ3RoLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAqCiAgICogQGV4YW1wbGUKICAgICAgPGV4YW1wbGUgbmFtZT0iZW1haWwtaW5wdXQtZGlyZWN0aXZlIiBtb2R1bGU9ImVtYWlsRXhhbXBsZSI+CiAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ2VtYWlsRXhhbXBsZScsIFtdKQogICAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnbWVAZXhhbXBsZS5jb20nOwogICAgICAgICAgICAgfV0pOwogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgICAgIEVtYWlsOiA8aW5wdXQgdHlwZT0iZW1haWwiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idGV4dCIgcmVxdWlyZWQ+CiAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IuZW1haWwiPgogICAgICAgICAgICAgICBOb3QgdmFsaWQgZW1haWwhPC9zcGFuPgogICAgICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLmVtYWlsID0ge3shIW15Rm9ybS4kZXJyb3IuZW1haWx9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICAgIHZhciB0ZXh0ID0gZWxlbWVudChieS5iaW5kaW5nKCd0ZXh0JykpOwogICAgICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgICAgICAgdmFyIGlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndGV4dCcpKTsKCiAgICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ21lQGV4YW1wbGUuY29tJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0LmNsZWFyKCk7CiAgICAgICAgICAgIGlucHV0LnNlbmRLZXlzKCcnKTsKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0VxdWFsKCd0ZXh0ID0nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG5vdCBlbWFpbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygneHh4Jyk7CgogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgIDwvZXhhbXBsZT4KICAgKi8KICAnZW1haWwnOiBlbWFpbElucHV0VHlwZSwKCgogIC8qKgogICAqIEBuZ2RvYyBpbnB1dAogICAqIEBuYW1lIGlucHV0W3JhZGlvXQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogSFRNTCByYWRpbyBidXR0b24uCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIFRoZSB2YWx1ZSB0byB3aGljaCB0aGUgZXhwcmVzc2lvbiBzaG91bGQgYmUgc2V0IHdoZW4gc2VsZWN0ZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nVmFsdWUgQW5ndWxhciBleHByZXNzaW9uIHdoaWNoIHNldHMgdGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZAogICAqICAgIGJlIHNldCB3aGVuIHNlbGVjdGVkLgogICAqCiAgICogQGV4YW1wbGUKICAgICAgPGV4YW1wbGUgbmFtZT0icmFkaW8taW5wdXQtZGlyZWN0aXZlIiBtb2R1bGU9InJhZGlvRXhhbXBsZSI+CiAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ3JhZGlvRXhhbXBsZScsIFtdKQogICAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLmNvbG9yID0gJ2JsdWUnOwogICAgICAgICAgICAgICAkc2NvcGUuc3BlY2lhbFZhbHVlID0gewogICAgICAgICAgICAgICAgICJpZCI6ICIxMjM0NSIsCiAgICAgICAgICAgICAgICAgInZhbHVlIjogImdyZWVuIgogICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgfV0pOwogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJyZWQiPiAgUmVkIDxici8+CiAgICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIG5nLXZhbHVlPSJzcGVjaWFsVmFsdWUiPiBHcmVlbiA8YnIvPgogICAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiB2YWx1ZT0iYmx1ZSI+IEJsdWUgPGJyLz4KICAgICAgICAgICA8dHQ+Y29sb3IgPSB7e2NvbG9yIHwganNvbn19PC90dD48YnIvPgogICAgICAgICAgPC9mb3JtPgogICAgICAgICAgTm90ZSB0aGF0IGBuZy12YWx1ZT0ic3BlY2lhbFZhbHVlImAgc2V0cyByYWRpbyBpdGVtJ3MgdmFsdWUgdG8gYmUgdGhlIHZhbHVlIG9mIGAkc2NvcGUuc3BlY2lhbFZhbHVlYC4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgICBpdCgnc2hvdWxkIGNoYW5nZSBzdGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY29sb3IgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ2NvbG9yJykpOwoKICAgICAgICAgICAgZXhwZWN0KGNvbG9yLmdldFRleHQoKSkudG9Db250YWluKCdibHVlJyk7CgogICAgICAgICAgICBlbGVtZW50LmFsbChieS5tb2RlbCgnY29sb3InKSkuZ2V0KDApLmNsaWNrKCk7CgogICAgICAgICAgICBleHBlY3QoY29sb3IuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3JlZCcpOwogICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgICovCiAgJ3JhZGlvJzogcmFkaW9JbnB1dFR5cGUsCgoKICAvKioKICAgKiBAbmdkb2MgaW5wdXQKICAgKiBAbmFtZSBpbnB1dFtjaGVja2JveF0KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEhUTUwgY2hlY2tib3guCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG5nVHJ1ZVZhbHVlIFRoZSB2YWx1ZSB0byB3aGljaCB0aGUgZXhwcmVzc2lvbiBzaG91bGQgYmUgc2V0IHdoZW4gc2VsZWN0ZWQuCiAgICogQHBhcmFtIHtleHByZXNzaW9uPX0gbmdGYWxzZVZhbHVlIFRoZSB2YWx1ZSB0byB3aGljaCB0aGUgZXhwcmVzc2lvbiBzaG91bGQgYmUgc2V0IHdoZW4gbm90IHNlbGVjdGVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICoKICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBuYW1lPSJjaGVja2JveC1pbnB1dC1kaXJlY3RpdmUiIG1vZHVsZT0iY2hlY2tib3hFeGFtcGxlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICBhbmd1bGFyLm1vZHVsZSgnY2hlY2tib3hFeGFtcGxlJywgW10pCiAgICAgICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAgICAkc2NvcGUudmFsdWUxID0gdHJ1ZTsKICAgICAgICAgICAgICAgJHNjb3BlLnZhbHVlMiA9ICdZRVMnCiAgICAgICAgICAgICB9XSk7CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgICBWYWx1ZTE6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InZhbHVlMSI+IDxici8+CiAgICAgICAgICAgVmFsdWUyOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJ2YWx1ZTIiCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmctdHJ1ZS12YWx1ZT0iJ1lFUyciIG5nLWZhbHNlLXZhbHVlPSInTk8nIj4gPGJyLz4KICAgICAgICAgICA8dHQ+dmFsdWUxID0ge3t2YWx1ZTF9fTwvdHQ+PGJyLz4KICAgICAgICAgICA8dHQ+dmFsdWUyID0ge3t2YWx1ZTJ9fTwvdHQ+PGJyLz4KICAgICAgICAgIDwvZm9ybT4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgICBpdCgnc2hvdWxkIGNoYW5nZSBzdGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdmFsdWUxID0gZWxlbWVudChieS5iaW5kaW5nKCd2YWx1ZTEnKSk7CiAgICAgICAgICAgIHZhciB2YWx1ZTIgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3ZhbHVlMicpKTsKCiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZTEuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgICAgZXhwZWN0KHZhbHVlMi5nZXRUZXh0KCkpLnRvQ29udGFpbignWUVTJyk7CgogICAgICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZTEnKSkuY2xpY2soKTsKICAgICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsdWUyJykpLmNsaWNrKCk7CgogICAgICAgICAgICBleHBlY3QodmFsdWUxLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgICBleHBlY3QodmFsdWUyLmdldFRleHQoKSkudG9Db250YWluKCdOTycpOwogICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgICovCiAgJ2NoZWNrYm94JzogY2hlY2tib3hJbnB1dFR5cGUsCgogICdoaWRkZW4nOiBub29wLAogICdidXR0b24nOiBub29wLAogICdzdWJtaXQnOiBub29wLAogICdyZXNldCc6IG5vb3AsCiAgJ2ZpbGUnOiBub29wCn07CgpmdW5jdGlvbiB0ZXN0RmxhZ3ModmFsaWRpdHksIGZsYWdzKSB7CiAgdmFyIGksIGZsYWc7CiAgaWYgKGZsYWdzKSB7CiAgICBmb3IgKGk9MDsgaTxmbGFncy5sZW5ndGg7ICsraSkgewogICAgICBmbGFnID0gZmxhZ3NbaV07CiAgICAgIGlmICh2YWxpZGl0eVtmbGFnXSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gc3RyaW5nQmFzZWRJbnB1dFR5cGUoY3RybCkgewogIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIGN0cmwuJGlzRW1wdHkodmFsdWUpID8gdmFsdWUgOiB2YWx1ZS50b1N0cmluZygpOwogIH0pOwp9CgpmdW5jdGlvbiB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICBiYXNlSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwogIHN0cmluZ0Jhc2VkSW5wdXRUeXBlKGN0cmwpOwp9CgpmdW5jdGlvbiBiYXNlSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICB2YXIgdmFsaWRpdHkgPSBlbGVtZW50LnByb3AoVkFMSURJVFlfU1RBVEVfUFJPUEVSVFkpOwogIHZhciBwbGFjZWhvbGRlciA9IGVsZW1lbnRbMF0ucGxhY2Vob2xkZXIsIG5vZXZlbnQgPSB7fTsKICB2YXIgdHlwZSA9IGxvd2VyY2FzZShlbGVtZW50WzBdLnR5cGUpOwoKICAvLyBJbiBjb21wb3NpdGlvbiBtb2RlLCB1c2VycyBhcmUgc3RpbGwgaW5wdXRpbmcgaW50ZXJtZWRpYXRlIHRleHQgYnVmZmVyLAogIC8vIGhvbGQgdGhlIGxpc3RlbmVyIHVudGlsIGNvbXBvc2l0aW9uIGlzIGRvbmUuCiAgLy8gTW9yZSBhYm91dCBjb21wb3NpdGlvbiBldmVudHM6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9Db21wb3NpdGlvbkV2ZW50CiAgaWYgKCEkc25pZmZlci5hbmRyb2lkKSB7CiAgICB2YXIgY29tcG9zaW5nID0gZmFsc2U7CgogICAgZWxlbWVudC5vbignY29tcG9zaXRpb25zdGFydCcsIGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgY29tcG9zaW5nID0gdHJ1ZTsKICAgIH0pOwoKICAgIGVsZW1lbnQub24oJ2NvbXBvc2l0aW9uZW5kJywgZnVuY3Rpb24oKSB7CiAgICAgIGNvbXBvc2luZyA9IGZhbHNlOwogICAgICBsaXN0ZW5lcigpOwogICAgfSk7CiAgfQoKICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbihldikgewogICAgaWYgKGNvbXBvc2luZykgcmV0dXJuOwogICAgdmFyIHZhbHVlID0gZWxlbWVudC52YWwoKSwKICAgICAgICBldmVudCA9IGV2ICYmIGV2LnR5cGU7CgogICAgLy8gSUUgKDExIGFuZCB1bmRlcikgc2VlbSB0byBlbWl0IGFuICdpbnB1dCcgZXZlbnQgaWYgdGhlIHBsYWNlaG9sZGVyIHZhbHVlIGNoYW5nZXMuCiAgICAvLyBXZSBkb24ndCB3YW50IHRvIGRpcnR5IHRoZSB2YWx1ZSB3aGVuIHRoaXMgaGFwcGVucywgc28gd2UgYWJvcnQgaGVyZS4gVW5mb3J0dW5hdGVseSwKICAgIC8vIElFIGFsc28gc2VuZHMgaW5wdXQgZXZlbnRzIGZvciBvdGhlciBub24taW5wdXQtcmVsYXRlZCB0aGluZ3MsIChzdWNoIGFzIGZvY3VzaW5nIG9uIGEKICAgIC8vIGZvcm0gY29udHJvbCksIHNvIHRoaXMgY2hhbmdlIGlzIG5vdCBlbnRpcmVseSBlbm91Z2ggdG8gc29sdmUgdGhpcy4KICAgIGlmIChtc2llICYmIChldiB8fCBub2V2ZW50KS50eXBlID09PSAnaW5wdXQnICYmIGVsZW1lbnRbMF0ucGxhY2Vob2xkZXIgIT09IHBsYWNlaG9sZGVyKSB7CiAgICAgIHBsYWNlaG9sZGVyID0gZWxlbWVudFswXS5wbGFjZWhvbGRlcjsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIEJ5IGRlZmF1bHQgd2Ugd2lsbCB0cmltIHRoZSB2YWx1ZQogICAgLy8gSWYgdGhlIGF0dHJpYnV0ZSBuZy10cmltIGV4aXN0cyB3ZSB3aWxsIGF2b2lkIHRyaW1taW5nCiAgICAvLyBJZiBpbnB1dCB0eXBlIGlzICdwYXNzd29yZCcsIHRoZSB2YWx1ZSBpcyBuZXZlciB0cmltbWVkCiAgICBpZiAodHlwZSAhPT0gJ3Bhc3N3b3JkJyAmJiAoIWF0dHIubmdUcmltIHx8IGF0dHIubmdUcmltICE9PSAnZmFsc2UnKSkgewogICAgICB2YWx1ZSA9IHRyaW0odmFsdWUpOwogICAgfQoKICAgIC8vIElmIGEgY29udHJvbCBpcyBzdWZmZXJpbmcgZnJvbSBiYWQgaW5wdXQgKGR1ZSB0byBuYXRpdmUgdmFsaWRhdG9ycyksIGJyb3dzZXJzIGRpc2NhcmQgaXRzCiAgICAvLyB2YWx1ZSwgc28gaXQgbWF5IGJlIG5lY2Vzc2FyeSB0byByZXZhbGlkYXRlIChieSBjYWxsaW5nICRzZXRWaWV3VmFsdWUgYWdhaW4pIGV2ZW4gaWYgdGhlCiAgICAvLyBjb250cm9sJ3MgdmFsdWUgaXMgdGhlIHNhbWUgZW1wdHkgdmFsdWUgdHdpY2UgaW4gYSByb3cuCiAgICBpZiAoY3RybC4kdmlld1ZhbHVlICE9PSB2YWx1ZSB8fCAodmFsdWUgPT09ICcnICYmIGN0cmwuJCRoYXNOYXRpdmVWYWxpZGF0b3JzKSkgewogICAgICBjdHJsLiRzZXRWaWV3VmFsdWUodmFsdWUsIGV2ZW50KTsKICAgIH0KICB9OwoKICAvLyBpZiB0aGUgYnJvd3NlciBkb2VzIHN1cHBvcnQgImlucHV0IiBldmVudCwgd2UgYXJlIGZpbmUgLSBleGNlcHQgb24gSUU5IHdoaWNoIGRvZXNuJ3QgZmlyZSB0aGUKICAvLyBpbnB1dCBldmVudCBvbiBiYWNrc3BhY2UsIGRlbGV0ZSBvciBjdXQKICBpZiAoJHNuaWZmZXIuaGFzRXZlbnQoJ2lucHV0JykpIHsKICAgIGVsZW1lbnQub24oJ2lucHV0JywgbGlzdGVuZXIpOwogIH0gZWxzZSB7CiAgICB2YXIgdGltZW91dDsKCiAgICB2YXIgZGVmZXJMaXN0ZW5lciA9IGZ1bmN0aW9uKGV2KSB7CiAgICAgIGlmICghdGltZW91dCkgewogICAgICAgIHRpbWVvdXQgPSAkYnJvd3Nlci5kZWZlcihmdW5jdGlvbigpIHsKICAgICAgICAgIGxpc3RlbmVyKGV2KTsKICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIGVsZW1lbnQub24oJ2tleWRvd24nLCBmdW5jdGlvbihldmVudCkgewogICAgICB2YXIga2V5ID0gZXZlbnQua2V5Q29kZTsKCiAgICAgIC8vIGlnbm9yZQogICAgICAvLyAgICBjb21tYW5kICAgICAgICAgICAgbW9kaWZpZXJzICAgICAgICAgICAgICAgICAgIGFycm93cwogICAgICBpZiAoa2V5ID09PSA5MSB8fCAoMTUgPCBrZXkgJiYga2V5IDwgMTkpIHx8ICgzNyA8PSBrZXkgJiYga2V5IDw9IDQwKSkgcmV0dXJuOwoKICAgICAgZGVmZXJMaXN0ZW5lcihldmVudCk7CiAgICB9KTsKCiAgICAvLyBpZiB1c2VyIG1vZGlmaWVzIGlucHV0IHZhbHVlIHVzaW5nIGNvbnRleHQgbWVudSBpbiBJRSwgd2UgbmVlZCAicGFzdGUiIGFuZCAiY3V0IiBldmVudHMgdG8gY2F0Y2ggaXQKICAgIGlmICgkc25pZmZlci5oYXNFdmVudCgncGFzdGUnKSkgewogICAgICBlbGVtZW50Lm9uKCdwYXN0ZSBjdXQnLCBkZWZlckxpc3RlbmVyKTsKICAgIH0KICB9CgogIC8vIGlmIHVzZXIgcGFzdGUgaW50byBpbnB1dCB1c2luZyBtb3VzZSBvbiBvbGRlciBicm93c2VyCiAgLy8gb3IgZm9ybSBhdXRvY29tcGxldGUgb24gbmV3ZXIgYnJvd3Nlciwgd2UgbmVlZCAiY2hhbmdlIiBldmVudCB0byBjYXRjaCBpdAogIGVsZW1lbnQub24oJ2NoYW5nZScsIGxpc3RlbmVyKTsKCiAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICBlbGVtZW50LnZhbChjdHJsLiRpc0VtcHR5KGN0cmwuJG1vZGVsVmFsdWUpID8gJycgOiBjdHJsLiR2aWV3VmFsdWUpOwogIH07Cn0KCmZ1bmN0aW9uIHdlZWtQYXJzZXIoaXNvV2VlaywgZXhpc3RpbmdEYXRlKSB7CiAgaWYgKGlzRGF0ZShpc29XZWVrKSkgewogICAgcmV0dXJuIGlzb1dlZWs7CiAgfQoKICBpZiAoaXNTdHJpbmcoaXNvV2VlaykpIHsKICAgIFdFRUtfUkVHRVhQLmxhc3RJbmRleCA9IDA7CiAgICB2YXIgcGFydHMgPSBXRUVLX1JFR0VYUC5leGVjKGlzb1dlZWspOwogICAgaWYgKHBhcnRzKSB7CiAgICAgIHZhciB5ZWFyID0gK3BhcnRzWzFdLAogICAgICAgICAgd2VlayA9ICtwYXJ0c1syXSwKICAgICAgICAgIGhvdXJzID0gMCwKICAgICAgICAgIG1pbnV0ZXMgPSAwLAogICAgICAgICAgc2Vjb25kcyA9IDAsCiAgICAgICAgICBtaWxsaXNlY29uZHMgPSAwLAogICAgICAgICAgZmlyc3RUaHVycyA9IGdldEZpcnN0VGh1cnNkYXlPZlllYXIoeWVhciksCiAgICAgICAgICBhZGREYXlzID0gKHdlZWsgLSAxKSAqIDc7CgogICAgICBpZiAoZXhpc3RpbmdEYXRlKSB7CiAgICAgICAgaG91cnMgPSBleGlzdGluZ0RhdGUuZ2V0SG91cnMoKTsKICAgICAgICBtaW51dGVzID0gZXhpc3RpbmdEYXRlLmdldE1pbnV0ZXMoKTsKICAgICAgICBzZWNvbmRzID0gZXhpc3RpbmdEYXRlLmdldFNlY29uZHMoKTsKICAgICAgICBtaWxsaXNlY29uZHMgPSBleGlzdGluZ0RhdGUuZ2V0TWlsbGlzZWNvbmRzKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBuZXcgRGF0ZSh5ZWFyLCAwLCBmaXJzdFRodXJzLmdldERhdGUoKSArIGFkZERheXMsIGhvdXJzLCBtaW51dGVzLCBzZWNvbmRzLCBtaWxsaXNlY29uZHMpOwogICAgfQogIH0KCiAgcmV0dXJuIE5hTjsKfQoKZnVuY3Rpb24gY3JlYXRlRGF0ZVBhcnNlcihyZWdleHAsIG1hcHBpbmcpIHsKICByZXR1cm4gZnVuY3Rpb24oaXNvLCBkYXRlKSB7CiAgICB2YXIgcGFydHMsIG1hcDsKCiAgICBpZiAoaXNEYXRlKGlzbykpIHsKICAgICAgcmV0dXJuIGlzbzsKICAgIH0KCiAgICBpZiAoaXNTdHJpbmcoaXNvKSkgewogICAgICAvLyBXaGVuIGEgZGF0ZSBpcyBKU09OJ2lmaWVkIHRvIHdyYXBzIGl0c2VsZiBpbnNpZGUgb2YgYW4gZXh0cmEKICAgICAgLy8gc2V0IG9mIGRvdWJsZSBxdW90ZXMuIFRoaXMgbWFrZXMgdGhlIGRhdGUgcGFyc2luZyBjb2RlIHVuYWJsZQogICAgICAvLyB0byBtYXRjaCB0aGUgZGF0ZSBzdHJpbmcgYW5kIHBhcnNlIGl0IGFzIGEgZGF0ZS4KICAgICAgaWYgKGlzby5jaGFyQXQoMCkgPT0gJyInICYmIGlzby5jaGFyQXQoaXNvLmxlbmd0aC0xKSA9PSAnIicpIHsKICAgICAgICBpc28gPSBpc28uc3Vic3RyaW5nKDEsIGlzby5sZW5ndGgtMSk7CiAgICAgIH0KICAgICAgaWYgKElTT19EQVRFX1JFR0VYUC50ZXN0KGlzbykpIHsKICAgICAgICByZXR1cm4gbmV3IERhdGUoaXNvKTsKICAgICAgfQogICAgICByZWdleHAubGFzdEluZGV4ID0gMDsKICAgICAgcGFydHMgPSByZWdleHAuZXhlYyhpc28pOwoKICAgICAgaWYgKHBhcnRzKSB7CiAgICAgICAgcGFydHMuc2hpZnQoKTsKICAgICAgICBpZiAoZGF0ZSkgewogICAgICAgICAgbWFwID0gewogICAgICAgICAgICB5eXl5OiBkYXRlLmdldEZ1bGxZZWFyKCksCiAgICAgICAgICAgIE1NOiBkYXRlLmdldE1vbnRoKCkgKyAxLAogICAgICAgICAgICBkZDogZGF0ZS5nZXREYXRlKCksCiAgICAgICAgICAgIEhIOiBkYXRlLmdldEhvdXJzKCksCiAgICAgICAgICAgIG1tOiBkYXRlLmdldE1pbnV0ZXMoKSwKICAgICAgICAgICAgc3M6IGRhdGUuZ2V0U2Vjb25kcygpLAogICAgICAgICAgICBzc3M6IGRhdGUuZ2V0TWlsbGlzZWNvbmRzKCkgLyAxMDAwCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtYXAgPSB7IHl5eXk6IDE5NzAsIE1NOiAxLCBkZDogMSwgSEg6IDAsIG1tOiAwLCBzczogMCwgc3NzOiAwIH07CiAgICAgICAgfQoKICAgICAgICBmb3JFYWNoKHBhcnRzLCBmdW5jdGlvbihwYXJ0LCBpbmRleCkgewogICAgICAgICAgaWYgKGluZGV4IDwgbWFwcGluZy5sZW5ndGgpIHsKICAgICAgICAgICAgbWFwW21hcHBpbmdbaW5kZXhdXSA9ICtwYXJ0OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBuZXcgRGF0ZShtYXAueXl5eSwgbWFwLk1NIC0gMSwgbWFwLmRkLCBtYXAuSEgsIG1hcC5tbSwgbWFwLnNzIHx8IDAsIG1hcC5zc3MgKiAxMDAwIHx8IDApOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIE5hTjsKICB9Owp9CgpmdW5jdGlvbiBjcmVhdGVEYXRlSW5wdXRUeXBlKHR5cGUsIHJlZ2V4cCwgcGFyc2VEYXRlLCBmb3JtYXQpIHsKICByZXR1cm4gZnVuY3Rpb24gZHluYW1pY0RhdGVJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlciwgJGZpbHRlcikgewogICAgYmFkSW5wdXRDaGVja2VyKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKTsKICAgIGJhc2VJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CiAgICB2YXIgdGltZXpvbmUgPSBjdHJsICYmIGN0cmwuJG9wdGlvbnMgJiYgY3RybC4kb3B0aW9ucy50aW1lem9uZTsKICAgIHZhciBwcmV2aW91c0RhdGU7CgogICAgY3RybC4kJHBhcnNlck5hbWUgPSB0eXBlOwogICAgY3RybC4kcGFyc2Vycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmIChjdHJsLiRpc0VtcHR5KHZhbHVlKSkgcmV0dXJuIG51bGw7CiAgICAgIGlmIChyZWdleHAudGVzdCh2YWx1ZSkpIHsKICAgICAgICAvLyBOb3RlOiBXZSBjYW5ub3QgcmVhZCBjdHJsLiRtb2RlbFZhbHVlLCBhcyB0aGVyZSBtaWdodCBiZSBhIGRpZmZlcmVudAogICAgICAgIC8vIHBhcnNlci9mb3JtYXR0ZXIgaW4gdGhlIHByb2Nlc3NpbmcgY2hhaW4gc28gdGhhdCB0aGUgbW9kZWwKICAgICAgICAvLyBjb250YWlucyBzb21lIGRpZmZlcmVudCBkYXRhIGZvcm1hdCEKICAgICAgICB2YXIgcGFyc2VkRGF0ZSA9IHBhcnNlRGF0ZSh2YWx1ZSwgcHJldmlvdXNEYXRlKTsKICAgICAgICBpZiAodGltZXpvbmUgPT09ICdVVEMnKSB7CiAgICAgICAgICBwYXJzZWREYXRlLnNldE1pbnV0ZXMocGFyc2VkRGF0ZS5nZXRNaW51dGVzKCkgLSBwYXJzZWREYXRlLmdldFRpbWV6b25lT2Zmc2V0KCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFyc2VkRGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfSk7CgogICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICghY3RybC4kaXNFbXB0eSh2YWx1ZSkpIHsKICAgICAgICBpZiAoIWlzRGF0ZSh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93ICRuZ01vZGVsTWluRXJyKCdkYXRlZm10JywgJ0V4cGVjdGVkIGB7MH1gIHRvIGJlIGEgZGF0ZScsIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcHJldmlvdXNEYXRlID0gdmFsdWU7CiAgICAgICAgaWYgKHByZXZpb3VzRGF0ZSAmJiB0aW1lem9uZSA9PT0gJ1VUQycpIHsKICAgICAgICAgIHZhciB0aW1lem9uZU9mZnNldCA9IDYwMDAwICogcHJldmlvdXNEYXRlLmdldFRpbWV6b25lT2Zmc2V0KCk7CiAgICAgICAgICBwcmV2aW91c0RhdGUgPSBuZXcgRGF0ZShwcmV2aW91c0RhdGUuZ2V0VGltZSgpICsgdGltZXpvbmVPZmZzZXQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJGZpbHRlcignZGF0ZScpKHZhbHVlLCBmb3JtYXQsIHRpbWV6b25lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwcmV2aW91c0RhdGUgPSBudWxsOwogICAgICB9CiAgICAgIHJldHVybiAnJzsKICAgIH0pOwoKICAgIGlmIChpc0RlZmluZWQoYXR0ci5taW4pIHx8IGF0dHIubmdNaW4pIHsKICAgICAgdmFyIG1pblZhbDsKICAgICAgY3RybC4kdmFsaWRhdG9ycy5taW4gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBjdHJsLiRpc0VtcHR5KHZhbHVlKSB8fCBpc1VuZGVmaW5lZChtaW5WYWwpIHx8IHBhcnNlRGF0ZSh2YWx1ZSkgPj0gbWluVmFsOwogICAgICB9OwogICAgICBhdHRyLiRvYnNlcnZlKCdtaW4nLCBmdW5jdGlvbih2YWwpIHsKICAgICAgICBtaW5WYWwgPSBwYXJzZU9ic2VydmVkRGF0ZVZhbHVlKHZhbCk7CiAgICAgICAgY3RybC4kdmFsaWRhdGUoKTsKICAgICAgfSk7CiAgICB9CgogICAgaWYgKGlzRGVmaW5lZChhdHRyLm1heCkgfHwgYXR0ci5uZ01heCkgewogICAgICB2YXIgbWF4VmFsOwogICAgICBjdHJsLiR2YWxpZGF0b3JzLm1heCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IGlzVW5kZWZpbmVkKG1heFZhbCkgfHwgcGFyc2VEYXRlKHZhbHVlKSA8PSBtYXhWYWw7CiAgICAgIH07CiAgICAgIGF0dHIuJG9ic2VydmUoJ21heCcsIGZ1bmN0aW9uKHZhbCkgewogICAgICAgIG1heFZhbCA9IHBhcnNlT2JzZXJ2ZWREYXRlVmFsdWUodmFsKTsKICAgICAgICBjdHJsLiR2YWxpZGF0ZSgpOwogICAgICB9KTsKICAgIH0KICAgIC8vIE92ZXJyaWRlIHRoZSBzdGFuZGFyZCAkaXNFbXB0eSB0byBkZXRlY3QgaW52YWxpZCBkYXRlcyBhcyB3ZWxsCiAgICBjdHJsLiRpc0VtcHR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgLy8gSW52YWxpZCBEYXRlOiBnZXRUaW1lKCkgcmV0dXJucyBOYU4KICAgICAgcmV0dXJuICF2YWx1ZSB8fCAodmFsdWUuZ2V0VGltZSAmJiB2YWx1ZS5nZXRUaW1lKCkgIT09IHZhbHVlLmdldFRpbWUoKSk7CiAgICB9OwoKICAgIGZ1bmN0aW9uIHBhcnNlT2JzZXJ2ZWREYXRlVmFsdWUodmFsKSB7CiAgICAgIHJldHVybiBpc0RlZmluZWQodmFsKSA/IChpc0RhdGUodmFsKSA/IHZhbCA6IHBhcnNlRGF0ZSh2YWwpKSA6IHVuZGVmaW5lZDsKICAgIH0KICB9Owp9CgpmdW5jdGlvbiBiYWRJbnB1dENoZWNrZXIoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICB2YXIgbm9kZSA9IGVsZW1lbnRbMF07CiAgdmFyIG5hdGl2ZVZhbGlkYXRpb24gPSBjdHJsLiQkaGFzTmF0aXZlVmFsaWRhdG9ycyA9IGlzT2JqZWN0KG5vZGUudmFsaWRpdHkpOwogIGlmIChuYXRpdmVWYWxpZGF0aW9uKSB7CiAgICBjdHJsLiRwYXJzZXJzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIHZhbGlkaXR5ID0gZWxlbWVudC5wcm9wKFZBTElESVRZX1NUQVRFX1BST1BFUlRZKSB8fCB7fTsKICAgICAgLy8gRGV0ZWN0IGJ1ZyBpbiBGRjM1IGZvciBpbnB1dFtlbWFpbF0gKGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTEwNjQ0MzApOgogICAgICAvLyAtIGFsc28gc2V0cyB2YWxpZGl0eS5iYWRJbnB1dCAoc2hvdWxkIG9ubHkgYmUgdmFsaWRpdHkudHlwZU1pc21hdGNoKS4KICAgICAgLy8gLSBzZWUgaHR0cDovL3d3dy53aGF0d2cub3JnL3NwZWNzL3dlYi1hcHBzL2N1cnJlbnQtd29yay9tdWx0aXBhZ2UvZm9ybXMuaHRtbCNlLW1haWwtc3RhdGUtKHR5cGU9ZW1haWwpCiAgICAgIC8vIC0gY2FuIGlnbm9yZSB0aGlzIGNhc2UgYXMgd2UgY2FuIHN0aWxsIHJlYWQgb3V0IHRoZSBlcnJvbmVvdXMgZW1haWwuLi4KICAgICAgcmV0dXJuIHZhbGlkaXR5LmJhZElucHV0ICYmICF2YWxpZGl0eS50eXBlTWlzbWF0Y2ggPyB1bmRlZmluZWQgOiB2YWx1ZTsKICAgIH0pOwogIH0KfQoKZnVuY3Rpb24gbnVtYmVySW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICBiYWRJbnB1dENoZWNrZXIoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpOwogIGJhc2VJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CgogIGN0cmwuJCRwYXJzZXJOYW1lID0gJ251bWJlcic7CiAgY3RybC4kcGFyc2Vycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAoY3RybC4kaXNFbXB0eSh2YWx1ZSkpICAgICAgcmV0dXJuIG51bGw7CiAgICBpZiAoTlVNQkVSX1JFR0VYUC50ZXN0KHZhbHVlKSkgcmV0dXJuIHBhcnNlRmxvYXQodmFsdWUpOwogICAgcmV0dXJuIHVuZGVmaW5lZDsKICB9KTsKCiAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAoIWN0cmwuJGlzRW1wdHkodmFsdWUpKSB7CiAgICAgIGlmICghaXNOdW1iZXIodmFsdWUpKSB7CiAgICAgICAgdGhyb3cgJG5nTW9kZWxNaW5FcnIoJ251bWZtdCcsICdFeHBlY3RlZCBgezB9YCB0byBiZSBhIG51bWJlcicsIHZhbHVlKTsKICAgICAgfQogICAgICB2YWx1ZSA9IHZhbHVlLnRvU3RyaW5nKCk7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfSk7CgogIGlmIChhdHRyLm1pbiB8fCBhdHRyLm5nTWluKSB7CiAgICB2YXIgbWluVmFsOwogICAgY3RybC4kdmFsaWRhdG9ycy5taW4gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgaXNVbmRlZmluZWQobWluVmFsKSB8fCB2YWx1ZSA+PSBtaW5WYWw7CiAgICB9OwoKICAgIGF0dHIuJG9ic2VydmUoJ21pbicsIGZ1bmN0aW9uKHZhbCkgewogICAgICBpZiAoaXNEZWZpbmVkKHZhbCkgJiYgIWlzTnVtYmVyKHZhbCkpIHsKICAgICAgICB2YWwgPSBwYXJzZUZsb2F0KHZhbCwgMTApOwogICAgICB9CiAgICAgIG1pblZhbCA9IGlzTnVtYmVyKHZhbCkgJiYgIWlzTmFOKHZhbCkgPyB2YWwgOiB1bmRlZmluZWQ7CiAgICAgIC8vIFRPRE8obWF0c2tvKTogaW1wbGVtZW50IHZhbGlkYXRlTGF0ZXIgdG8gcmVkdWNlIG51bWJlciBvZiB2YWxpZGF0aW9ucwogICAgICBjdHJsLiR2YWxpZGF0ZSgpOwogICAgfSk7CiAgfQoKICBpZiAoYXR0ci5tYXggfHwgYXR0ci5uZ01heCkgewogICAgdmFyIG1heFZhbDsKICAgIGN0cmwuJHZhbGlkYXRvcnMubWF4ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IGlzVW5kZWZpbmVkKG1heFZhbCkgfHwgdmFsdWUgPD0gbWF4VmFsOwogICAgfTsKCiAgICBhdHRyLiRvYnNlcnZlKCdtYXgnLCBmdW5jdGlvbih2YWwpIHsKICAgICAgaWYgKGlzRGVmaW5lZCh2YWwpICYmICFpc051bWJlcih2YWwpKSB7CiAgICAgICAgdmFsID0gcGFyc2VGbG9hdCh2YWwsIDEwKTsKICAgICAgfQogICAgICBtYXhWYWwgPSBpc051bWJlcih2YWwpICYmICFpc05hTih2YWwpID8gdmFsIDogdW5kZWZpbmVkOwogICAgICAvLyBUT0RPKG1hdHNrbyk6IGltcGxlbWVudCB2YWxpZGF0ZUxhdGVyIHRvIHJlZHVjZSBudW1iZXIgb2YgdmFsaWRhdGlvbnMKICAgICAgY3RybC4kdmFsaWRhdGUoKTsKICAgIH0pOwogIH0KfQoKZnVuY3Rpb24gdXJsSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICAvLyBOb3RlOiBubyBiYWRJbnB1dENoZWNrZXIgaGVyZSBieSBwdXJwb3NlIGFzIGB1cmxgIGlzIG9ubHkgYSB2YWxpZGF0aW9uCiAgLy8gaW4gYnJvd3NlcnMsIGkuZS4gd2UgY2FuIGFsd2F5cyByZWFkIG91dCBpbnB1dC52YWx1ZSBldmVuIGlmIGl0IGlzIG5vdCB2YWxpZCEKICBiYXNlSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwogIHN0cmluZ0Jhc2VkSW5wdXRUeXBlKGN0cmwpOwoKICBjdHJsLiQkcGFyc2VyTmFtZSA9ICd1cmwnOwogIGN0cmwuJHZhbGlkYXRvcnMudXJsID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiBjdHJsLiRpc0VtcHR5KHZhbHVlKSB8fCBVUkxfUkVHRVhQLnRlc3QodmFsdWUpOwogIH07Cn0KCmZ1bmN0aW9uIGVtYWlsSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICAvLyBOb3RlOiBubyBiYWRJbnB1dENoZWNrZXIgaGVyZSBieSBwdXJwb3NlIGFzIGB1cmxgIGlzIG9ubHkgYSB2YWxpZGF0aW9uCiAgLy8gaW4gYnJvd3NlcnMsIGkuZS4gd2UgY2FuIGFsd2F5cyByZWFkIG91dCBpbnB1dC52YWx1ZSBldmVuIGlmIGl0IGlzIG5vdCB2YWxpZCEKICBiYXNlSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwogIHN0cmluZ0Jhc2VkSW5wdXRUeXBlKGN0cmwpOwoKICBjdHJsLiQkcGFyc2VyTmFtZSA9ICdlbWFpbCc7CiAgY3RybC4kdmFsaWRhdG9ycy5lbWFpbCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgRU1BSUxfUkVHRVhQLnRlc3QodmFsdWUpOwogIH07Cn0KCmZ1bmN0aW9uIHJhZGlvSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgLy8gbWFrZSB0aGUgbmFtZSB1bmlxdWUsIGlmIG5vdCBkZWZpbmVkCiAgaWYgKGlzVW5kZWZpbmVkKGF0dHIubmFtZSkpIHsKICAgIGVsZW1lbnQuYXR0cignbmFtZScsIG5leHRVaWQoKSk7CiAgfQoKICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbihldikgewogICAgaWYgKGVsZW1lbnRbMF0uY2hlY2tlZCkgewogICAgICBjdHJsLiRzZXRWaWV3VmFsdWUoYXR0ci52YWx1ZSwgZXYgJiYgZXYudHlwZSk7CiAgICB9CiAgfTsKCiAgZWxlbWVudC5vbignY2xpY2snLCBsaXN0ZW5lcik7CgogIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHZhbHVlID0gYXR0ci52YWx1ZTsKICAgIGVsZW1lbnRbMF0uY2hlY2tlZCA9ICh2YWx1ZSA9PSBjdHJsLiR2aWV3VmFsdWUpOwogIH07CgogIGF0dHIuJG9ic2VydmUoJ3ZhbHVlJywgY3RybC4kcmVuZGVyKTsKfQoKZnVuY3Rpb24gcGFyc2VDb25zdGFudEV4cHIoJHBhcnNlLCBjb250ZXh0LCBuYW1lLCBleHByZXNzaW9uLCBmYWxsYmFjaykgewogIHZhciBwYXJzZUZuOwogIGlmIChpc0RlZmluZWQoZXhwcmVzc2lvbikpIHsKICAgIHBhcnNlRm4gPSAkcGFyc2UoZXhwcmVzc2lvbik7CiAgICBpZiAoIXBhcnNlRm4uY29uc3RhbnQpIHsKICAgICAgdGhyb3cgbWluRXJyKCduZ01vZGVsJykoJ2NvbnN0ZXhwcicsICdFeHBlY3RlZCBjb25zdGFudCBleHByZXNzaW9uIGZvciBgezB9YCwgYnV0IHNhdyAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYHsxfWAuJywgbmFtZSwgZXhwcmVzc2lvbik7CiAgICB9CiAgICByZXR1cm4gcGFyc2VGbihjb250ZXh0KTsKICB9CiAgcmV0dXJuIGZhbGxiYWNrOwp9CgpmdW5jdGlvbiBjaGVja2JveElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyLCAkZmlsdGVyLCAkcGFyc2UpIHsKICB2YXIgdHJ1ZVZhbHVlID0gcGFyc2VDb25zdGFudEV4cHIoJHBhcnNlLCBzY29wZSwgJ25nVHJ1ZVZhbHVlJywgYXR0ci5uZ1RydWVWYWx1ZSwgdHJ1ZSk7CiAgdmFyIGZhbHNlVmFsdWUgPSBwYXJzZUNvbnN0YW50RXhwcigkcGFyc2UsIHNjb3BlLCAnbmdGYWxzZVZhbHVlJywgYXR0ci5uZ0ZhbHNlVmFsdWUsIGZhbHNlKTsKCiAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24oZXYpIHsKICAgIGN0cmwuJHNldFZpZXdWYWx1ZShlbGVtZW50WzBdLmNoZWNrZWQsIGV2ICYmIGV2LnR5cGUpOwogIH07CgogIGVsZW1lbnQub24oJ2NsaWNrJywgbGlzdGVuZXIpOwoKICBjdHJsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgIGVsZW1lbnRbMF0uY2hlY2tlZCA9IGN0cmwuJHZpZXdWYWx1ZTsKICB9OwoKICAvLyBPdmVycmlkZSB0aGUgc3RhbmRhcmQgYCRpc0VtcHR5YCBiZWNhdXNlIGFuIGVtcHR5IGNoZWNrYm94IGlzIG5ldmVyIGVxdWFsIHRvIHRoZSB0cnVlVmFsdWUKICBjdHJsLiRpc0VtcHR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSAhPT0gdHJ1ZVZhbHVlOwogIH07CgogIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIGVxdWFscyh2YWx1ZSwgdHJ1ZVZhbHVlKTsKICB9KTsKCiAgY3RybC4kcGFyc2Vycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPyB0cnVlVmFsdWUgOiBmYWxzZVZhbHVlOwogIH0pOwp9CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgdGV4dGFyZWEKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIEhUTUwgdGV4dGFyZWEgZWxlbWVudCBjb250cm9sIHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuIFRoZSBkYXRhLWJpbmRpbmcgYW5kIHZhbGlkYXRpb24KICogcHJvcGVydGllcyBvZiB0aGlzIGVsZW1lbnQgYXJlIGV4YWN0bHkgdGhlIHNhbWUgYXMgdGhvc2Ugb2YgdGhlCiAqIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQgaW5wdXQgZWxlbWVudH0uCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICogICAgbWlubGVuZ3RoLgogKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAqICAgIG1heGxlbmd0aC4KICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogKiBAcGFyYW0ge2Jvb2xlYW49fSBbbmdUcmltPXRydWVdIElmIHNldCB0byBmYWxzZSBBbmd1bGFyIHdpbGwgbm90IGF1dG9tYXRpY2FsbHkgdHJpbSB0aGUgaW5wdXQuCiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGlucHV0CiAqIEByZXN0cmljdCBFCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBIVE1MIGlucHV0IGVsZW1lbnQgY29udHJvbCB3aXRoIGFuZ3VsYXIgZGF0YS1iaW5kaW5nLiBJbnB1dCBjb250cm9sIGZvbGxvd3MgSFRNTDUgaW5wdXQgdHlwZXMKICogYW5kIHBvbHlmaWxscyB0aGUgSFRNTDUgdmFsaWRhdGlvbiBiZWhhdmlvciBmb3Igb2xkZXIgYnJvd3NlcnMuCiAqCiAqICpOT1RFKiBOb3QgZXZlcnkgZmVhdHVyZSBvZmZlcmVkIGlzIGF2YWlsYWJsZSBmb3IgYWxsIGlucHV0IHR5cGVzLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogKiBAcGFyYW0ge2Jvb2xlYW49fSBuZ1JlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgaWYgc2V0IHRvIHRydWUKICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICogICAgbWlubGVuZ3RoLgogKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAqICAgIG1heGxlbmd0aC4KICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogKiBAcGFyYW0ge2Jvb2xlYW49fSBbbmdUcmltPXRydWVdIElmIHNldCB0byBmYWxzZSBBbmd1bGFyIHdpbGwgbm90IGF1dG9tYXRpY2FsbHkgdHJpbSB0aGUgaW5wdXQuCiAqICAgIFRoaXMgcGFyYW1ldGVyIGlzIGlnbm9yZWQgZm9yIGlucHV0W3R5cGU9cGFzc3dvcmRdIGNvbnRyb2xzLCB3aGljaCB3aWxsIG5ldmVyIHRyaW0gdGhlCiAqICAgIGlucHV0LgogKgogKiBAZXhhbXBsZQogICAgPGV4YW1wbGUgbmFtZT0iaW5wdXQtZGlyZWN0aXZlIiBtb2R1bGU9ImlucHV0RXhhbXBsZSI+CiAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCdpbnB1dEV4YW1wbGUnLCBbXSkKICAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgICAkc2NvcGUudXNlciA9IHtuYW1lOiAnZ3Vlc3QnLCBsYXN0OiAndmlzaXRvcid9OwogICAgICAgICAgICB9XSk7CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iPgogICAgICAgICAgIFVzZXIgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InVzZXJOYW1lIiBuZy1tb2RlbD0idXNlci5uYW1lIiByZXF1aXJlZD4KICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS51c2VyTmFtZS4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPjxicj4KICAgICAgICAgICBMYXN0IG5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJsYXN0TmFtZSIgbmctbW9kZWw9InVzZXIubGFzdCIKICAgICAgICAgICAgIG5nLW1pbmxlbmd0aD0iMyIgbmctbWF4bGVuZ3RoPSIxMCI+CiAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0ubGFzdE5hbWUuJGVycm9yLm1pbmxlbmd0aCI+CiAgICAgICAgICAgICBUb28gc2hvcnQhPC9zcGFuPgogICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxhc3ROYW1lLiRlcnJvci5tYXhsZW5ndGgiPgogICAgICAgICAgICAgVG9vIGxvbmchPC9zcGFuPjxicj4KICAgICAgICAgPC9mb3JtPgogICAgICAgICA8aHI+CiAgICAgICAgIDx0dD51c2VyID0ge3t1c2VyfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0udXNlck5hbWUuJHZhbGlkID0ge3tteUZvcm0udXNlck5hbWUuJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS51c2VyTmFtZS4kZXJyb3IgPSB7e215Rm9ybS51c2VyTmFtZS4kZXJyb3J9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLmxhc3ROYW1lLiR2YWxpZCA9IHt7bXlGb3JtLmxhc3ROYW1lLiR2YWxpZH19PC90dD48YnI+CiAgICAgICAgIDx0dD5teUZvcm0ubGFzdE5hbWUuJGVycm9yID0ge3tteUZvcm0ubGFzdE5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IubWlubGVuZ3RoID0ge3shIW15Rm9ybS4kZXJyb3IubWlubGVuZ3RofX08L3R0Pjxicj4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IubWF4bGVuZ3RoID0ge3shIW15Rm9ybS4kZXJyb3IubWF4bGVuZ3RofX08L3R0Pjxicj4KICAgICAgIDwvZGl2PgogICAgICA8L2ZpbGU+CiAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgIHZhciB1c2VyID0gZWxlbWVudChieS5leGFjdEJpbmRpbmcoJ3VzZXInKSk7CiAgICAgICAgdmFyIHVzZXJOYW1lVmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS51c2VyTmFtZS4kdmFsaWQnKSk7CiAgICAgICAgdmFyIGxhc3ROYW1lVmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kdmFsaWQnKSk7CiAgICAgICAgdmFyIGxhc3ROYW1lRXJyb3IgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kZXJyb3InKSk7CiAgICAgICAgdmFyIGZvcm1WYWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKTsKICAgICAgICB2YXIgdXNlck5hbWVJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3VzZXIubmFtZScpKTsKICAgICAgICB2YXIgdXNlckxhc3RJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3VzZXIubGFzdCcpKTsKCiAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QodXNlci5nZXRUZXh0KCkpLnRvQ29udGFpbigneyJuYW1lIjoiZ3Vlc3QiLCJsYXN0IjoidmlzaXRvciJ9Jyk7CiAgICAgICAgICBleHBlY3QodXNlck5hbWVWYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgZXhwZWN0KGZvcm1WYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHkgd2hlbiByZXF1aXJlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdXNlck5hbWVJbnB1dC5jbGVhcigpOwogICAgICAgICAgdXNlck5hbWVJbnB1dC5zZW5kS2V5cygnJyk7CgogICAgICAgICAgZXhwZWN0KHVzZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3sibGFzdCI6InZpc2l0b3IifScpOwogICAgICAgICAgZXhwZWN0KHVzZXJOYW1lVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoZm9ybVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGJlIHZhbGlkIGlmIGVtcHR5IHdoZW4gbWluIGxlbmd0aCBpcyBzZXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHVzZXJMYXN0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIHVzZXJMYXN0SW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyLmdldFRleHQoKSkudG9Db250YWluKCd7Im5hbWUiOiJndWVzdCIsImxhc3QiOiIifScpOwogICAgICAgICAgZXhwZWN0KGxhc3ROYW1lVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIGV4cGVjdChmb3JtVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGxlc3MgdGhhbiByZXF1aXJlZCBtaW4gbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB1c2VyTGFzdElucHV0LmNsZWFyKCk7CiAgICAgICAgICB1c2VyTGFzdElucHV0LnNlbmRLZXlzKCd4eCcpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyLmdldFRleHQoKSkudG9Db250YWluKCd7Im5hbWUiOiJndWVzdCJ9Jyk7CiAgICAgICAgICBleHBlY3QobGFzdE5hbWVWYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIGV4cGVjdChsYXN0TmFtZUVycm9yLmdldFRleHQoKSkudG9Db250YWluKCdtaW5sZW5ndGgnKTsKICAgICAgICAgIGV4cGVjdChmb3JtVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBsb25nZXIgdGhhbiBtYXggbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB1c2VyTGFzdElucHV0LmNsZWFyKCk7CiAgICAgICAgICB1c2VyTGFzdElucHV0LnNlbmRLZXlzKCdzb21lIHJpZGljdWxvdXNseSBsb25nIG5hbWUnKTsKCiAgICAgICAgICBleHBlY3QodXNlci5nZXRUZXh0KCkpLnRvQ29udGFpbigneyJuYW1lIjoiZ3Vlc3QifScpOwogICAgICAgICAgZXhwZWN0KGxhc3ROYW1lVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QobGFzdE5hbWVFcnJvci5nZXRUZXh0KCkpLnRvQ29udGFpbignbWF4bGVuZ3RoJyk7CiAgICAgICAgICBleHBlY3QoZm9ybVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAqLwp2YXIgaW5wdXREaXJlY3RpdmUgPSBbJyRicm93c2VyJywgJyRzbmlmZmVyJywgJyRmaWx0ZXInLCAnJHBhcnNlJywKICAgIGZ1bmN0aW9uKCRicm93c2VyLCAkc25pZmZlciwgJGZpbHRlciwgJHBhcnNlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICByZXF1aXJlOiBbJz9uZ01vZGVsJ10sCiAgICBsaW5rOiB7CiAgICAgIHByZTogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmxzKSB7CiAgICAgICAgaWYgKGN0cmxzWzBdKSB7CiAgICAgICAgICAoaW5wdXRUeXBlW2xvd2VyY2FzZShhdHRyLnR5cGUpXSB8fCBpbnB1dFR5cGUudGV4dCkoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmxzWzBdLCAkc25pZmZlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYnJvd3NlciwgJGZpbHRlciwgJHBhcnNlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Owp9XTsKCnZhciBWQUxJRF9DTEFTUyA9ICduZy12YWxpZCcsCiAgICBJTlZBTElEX0NMQVNTID0gJ25nLWludmFsaWQnLAogICAgUFJJU1RJTkVfQ0xBU1MgPSAnbmctcHJpc3RpbmUnLAogICAgRElSVFlfQ0xBU1MgPSAnbmctZGlydHknLAogICAgVU5UT1VDSEVEX0NMQVNTID0gJ25nLXVudG91Y2hlZCcsCiAgICBUT1VDSEVEX0NMQVNTID0gJ25nLXRvdWNoZWQnLAogICAgUEVORElOR19DTEFTUyA9ICduZy1wZW5kaW5nJzsKCi8qKgogKiBAbmdkb2MgdHlwZQogKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyCiAqCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSAkdmlld1ZhbHVlIEFjdHVhbCBzdHJpbmcgdmFsdWUgaW4gdGhlIHZpZXcuCiAqIEBwcm9wZXJ0eSB7Kn0gJG1vZGVsVmFsdWUgVGhlIHZhbHVlIGluIHRoZSBtb2RlbCwgdGhhdCB0aGUgY29udHJvbCBpcyBib3VuZCB0by4KICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkcGFyc2VycyBBcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZSwgYXMgYSBwaXBlbGluZSwgd2hlbmV2ZXIKICAgICAgIHRoZSBjb250cm9sIHJlYWRzIHZhbHVlIGZyb20gdGhlIERPTS4gIEVhY2ggZnVuY3Rpb24gaXMgY2FsbGVkLCBpbiB0dXJuLCBwYXNzaW5nIHRoZSB2YWx1ZQogICAgICAgdGhyb3VnaCB0byB0aGUgbmV4dC4gVGhlIGxhc3QgcmV0dXJuIHZhbHVlIGlzIHVzZWQgdG8gcG9wdWxhdGUgdGhlIG1vZGVsLgogICAgICAgVXNlZCB0byBzYW5pdGl6ZSAvIGNvbnZlcnQgdGhlIHZhbHVlIGFzIHdlbGwgYXMgdmFsaWRhdGlvbi4gRm9yIHZhbGlkYXRpb24sCiAgICAgICB0aGUgcGFyc2VycyBzaG91bGQgdXBkYXRlIHRoZSB2YWxpZGl0eSBzdGF0ZSB1c2luZwogICAgICAge0BsaW5rIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZhbGlkaXR5ICRzZXRWYWxpZGl0eSgpfSwKICAgICAgIGFuZCByZXR1cm4gYHVuZGVmaW5lZGAgZm9yIGludmFsaWQgdmFsdWVzLgoKICoKICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkZm9ybWF0dGVycyBBcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZSwgYXMgYSBwaXBlbGluZSwgd2hlbmV2ZXIKICAgICAgIHRoZSBtb2RlbCB2YWx1ZSBjaGFuZ2VzLiBFYWNoIGZ1bmN0aW9uIGlzIGNhbGxlZCwgaW4gdHVybiwgcGFzc2luZyB0aGUgdmFsdWUgdGhyb3VnaCB0byB0aGUKICAgICAgIG5leHQuIFVzZWQgdG8gZm9ybWF0IC8gY29udmVydCB2YWx1ZXMgZm9yIGRpc3BsYXkgaW4gdGhlIGNvbnRyb2wgYW5kIHZhbGlkYXRpb24uCiAqIGBgYGpzCiAqIGZ1bmN0aW9uIGZvcm1hdHRlcih2YWx1ZSkgewogKiAgIGlmICh2YWx1ZSkgewogKiAgICAgcmV0dXJuIHZhbHVlLnRvVXBwZXJDYXNlKCk7CiAqICAgfQogKiB9CiAqIG5nTW9kZWwuJGZvcm1hdHRlcnMucHVzaChmb3JtYXR0ZXIpOwogKiBgYGAKICoKICogQHByb3BlcnR5IHtPYmplY3QuPHN0cmluZywgZnVuY3Rpb24+fSAkdmFsaWRhdG9ycyBBIGNvbGxlY3Rpb24gb2YgdmFsaWRhdG9ycyB0aGF0IGFyZSBhcHBsaWVkCiAqICAgICAgd2hlbmV2ZXIgdGhlIG1vZGVsIHZhbHVlIGNoYW5nZXMuIFRoZSBrZXkgdmFsdWUgd2l0aGluIHRoZSBvYmplY3QgcmVmZXJzIHRvIHRoZSBuYW1lIG9mIHRoZQogKiAgICAgIHZhbGlkYXRvciB3aGlsZSB0aGUgZnVuY3Rpb24gcmVmZXJzIHRvIHRoZSB2YWxpZGF0aW9uIG9wZXJhdGlvbi4gVGhlIHZhbGlkYXRpb24gb3BlcmF0aW9uIGlzCiAqICAgICAgcHJvdmlkZWQgd2l0aCB0aGUgbW9kZWwgdmFsdWUgYXMgYW4gYXJndW1lbnQgYW5kIG11c3QgcmV0dXJuIGEgdHJ1ZSBvciBmYWxzZSB2YWx1ZSBkZXBlbmRpbmcKICogICAgICBvbiB0aGUgcmVzcG9uc2Ugb2YgdGhhdCB2YWxpZGF0aW9uLgogKgogKiBgYGBqcwogKiBuZ01vZGVsLiR2YWxpZGF0b3JzLnZhbGlkQ2hhcmFjdGVycyA9IGZ1bmN0aW9uKG1vZGVsVmFsdWUsIHZpZXdWYWx1ZSkgewogKiAgIHZhciB2YWx1ZSA9IG1vZGVsVmFsdWUgfHwgdmlld1ZhbHVlOwogKiAgIHJldHVybiAvWzAtOV0rLy50ZXN0KHZhbHVlKSAmJgogKiAgICAgICAgICAvW2Etel0rLy50ZXN0KHZhbHVlKSAmJgogKiAgICAgICAgICAvW0EtWl0rLy50ZXN0KHZhbHVlKSAmJgogKiAgICAgICAgICAvXFcrLy50ZXN0KHZhbHVlKTsKICogfTsKICogYGBgCiAqCiAqIEBwcm9wZXJ0eSB7T2JqZWN0LjxzdHJpbmcsIGZ1bmN0aW9uPn0gJGFzeW5jVmFsaWRhdG9ycyBBIGNvbGxlY3Rpb24gb2YgdmFsaWRhdGlvbnMgdGhhdCBhcmUgZXhwZWN0ZWQgdG8KICogICAgICBwZXJmb3JtIGFuIGFzeW5jaHJvbm91cyB2YWxpZGF0aW9uIChlLmcuIGEgSFRUUCByZXF1ZXN0KS4gVGhlIHZhbGlkYXRpb24gZnVuY3Rpb24gdGhhdCBpcyBwcm92aWRlZAogKiAgICAgIGlzIGV4cGVjdGVkIHRvIHJldHVybiBhIHByb21pc2Ugd2hlbiBpdCBpcyBydW4gZHVyaW5nIHRoZSBtb2RlbCB2YWxpZGF0aW9uIHByb2Nlc3MuIE9uY2UgdGhlIHByb21pc2UKICogICAgICBpcyBkZWxpdmVyZWQgdGhlbiB0aGUgdmFsaWRhdGlvbiBzdGF0dXMgd2lsbCBiZSBzZXQgdG8gdHJ1ZSB3aGVuIGZ1bGZpbGxlZCBhbmQgZmFsc2Ugd2hlbiByZWplY3RlZC4KICogICAgICBXaGVuIHRoZSBhc3luY2hyb25vdXMgdmFsaWRhdG9ycyBhcmUgdHJpZ2dlcmVkLCBlYWNoIG9mIHRoZSB2YWxpZGF0b3JzIHdpbGwgcnVuIGluIHBhcmFsbGVsIGFuZCB0aGUgbW9kZWwKICogICAgICB2YWx1ZSB3aWxsIG9ubHkgYmUgdXBkYXRlZCBvbmNlIGFsbCB2YWxpZGF0b3JzIGhhdmUgYmVlbiBmdWxmaWxsZWQuIEFsc28sIGtlZXAgaW4gbWluZCB0aGF0IGFsbAogKiAgICAgIGFzeW5jaHJvbm91cyB2YWxpZGF0b3JzIHdpbGwgb25seSBydW4gb25jZSBhbGwgc3luY2hyb25vdXMgdmFsaWRhdG9ycyBoYXZlIHBhc3NlZC4KICoKICogUGxlYXNlIG5vdGUgdGhhdCBpZiAkaHR0cCBpcyB1c2VkIHRoZW4gaXQgaXMgaW1wb3J0YW50IHRoYXQgdGhlIHNlcnZlciByZXR1cm5zIGEgc3VjY2VzcyBIVFRQIHJlc3BvbnNlIGNvZGUKICogaW4gb3JkZXIgdG8gZnVsZmlsbCB0aGUgdmFsaWRhdGlvbiBhbmQgYSBzdGF0dXMgbGV2ZWwgb2YgYDR4eGAgaW4gb3JkZXIgdG8gcmVqZWN0IHRoZSB2YWxpZGF0aW9uLgogKgogKiBgYGBqcwogKiBuZ01vZGVsLiRhc3luY1ZhbGlkYXRvcnMudW5pcXVlVXNlcm5hbWUgPSBmdW5jdGlvbihtb2RlbFZhbHVlLCB2aWV3VmFsdWUpIHsKICogICB2YXIgdmFsdWUgPSBtb2RlbFZhbHVlIHx8IHZpZXdWYWx1ZTsKICoKICogICAvLyBMb29rdXAgdXNlciBieSB1c2VybmFtZQogKiAgIHJldHVybiAkaHR0cC5nZXQoJy9hcGkvdXNlcnMvJyArIHZhbHVlKS4KICogICAgICB0aGVuKGZ1bmN0aW9uIHJlc29sdmVkKCkgewogKiAgICAgICAgLy91c2VybmFtZSBleGlzdHMsIHRoaXMgbWVhbnMgdmFsaWRhdGlvbiBmYWlscwogKiAgICAgICAgcmV0dXJuICRxLnJlamVjdCgnZXhpc3RzJyk7CiAqICAgICAgfSwgZnVuY3Rpb24gcmVqZWN0ZWQoKSB7CiAqICAgICAgICAvL3VzZXJuYW1lIGRvZXMgbm90IGV4aXN0LCB0aGVyZWZvcmUgdGhpcyB2YWxpZGF0aW9uIHBhc3NlcwogKiAgICAgICAgcmV0dXJuIHRydWU7CiAqICAgICAgfSk7CiAqIH07CiAqIGBgYAogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgdmFsaWRhdG9yLgogKiBAcGFyYW0ge0Z1bmN0aW9ufSB2YWxpZGF0aW9uRm4gVGhlIHZhbGlkYXRpb24gZnVuY3Rpb24gdGhhdCB3aWxsIGJlIHJ1bi4KICoKICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkdmlld0NoYW5nZUxpc3RlbmVycyBBcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZSB3aGVuZXZlciB0aGUKICogICAgIHZpZXcgdmFsdWUgaGFzIGNoYW5nZWQuIEl0IGlzIGNhbGxlZCB3aXRoIG5vIGFyZ3VtZW50cywgYW5kIGl0cyByZXR1cm4gdmFsdWUgaXMgaWdub3JlZC4KICogICAgIFRoaXMgY2FuIGJlIHVzZWQgaW4gcGxhY2Ugb2YgYWRkaXRpb25hbCAkd2F0Y2hlcyBhZ2FpbnN0IHRoZSBtb2RlbCB2YWx1ZS4KICoKICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBBbiBvYmplY3QgaGFzaCB3aXRoIGFsbCBmYWlsaW5nIHZhbGlkYXRvciBpZHMgYXMga2V5cy4KICogQHByb3BlcnR5IHtPYmplY3R9ICRwZW5kaW5nIEFuIG9iamVjdCBoYXNoIHdpdGggYWxsIHBlbmRpbmcgdmFsaWRhdG9yIGlkcyBhcyBrZXlzLgogKgogKiBAcHJvcGVydHkge2Jvb2xlYW59ICR1bnRvdWNoZWQgVHJ1ZSBpZiBjb250cm9sIGhhcyBub3QgbG9zdCBmb2N1cyB5ZXQuCiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHRvdWNoZWQgVHJ1ZSBpZiBjb250cm9sIGhhcyBsb3N0IGZvY3VzLgogKiBAcHJvcGVydHkge2Jvb2xlYW59ICRwcmlzdGluZSBUcnVlIGlmIHVzZXIgaGFzIG5vdCBpbnRlcmFjdGVkIHdpdGggdGhlIGNvbnRyb2wgeWV0LgogKiBAcHJvcGVydHkge2Jvb2xlYW59ICRkaXJ0eSBUcnVlIGlmIHVzZXIgaGFzIGFscmVhZHkgaW50ZXJhY3RlZCB3aXRoIHRoZSBjb250cm9sLgogKiBAcHJvcGVydHkge2Jvb2xlYW59ICR2YWxpZCBUcnVlIGlmIHRoZXJlIGlzIG5vIGVycm9yLgogKiBAcHJvcGVydHkge2Jvb2xlYW59ICRpbnZhbGlkIFRydWUgaWYgYXQgbGVhc3Qgb25lIGVycm9yIG9uIHRoZSBjb250cm9sLgogKgogKiBAZGVzY3JpcHRpb24KICoKICogYE5nTW9kZWxDb250cm9sbGVyYCBwcm92aWRlcyBBUEkgZm9yIHRoZSBgbmctbW9kZWxgIGRpcmVjdGl2ZS4gVGhlIGNvbnRyb2xsZXIgY29udGFpbnMKICogc2VydmljZXMgZm9yIGRhdGEtYmluZGluZywgdmFsaWRhdGlvbiwgQ1NTIHVwZGF0ZXMsIGFuZCB2YWx1ZSBmb3JtYXR0aW5nIGFuZCBwYXJzaW5nLiBJdAogKiBwdXJwb3NlZnVsbHkgZG9lcyBub3QgY29udGFpbiBhbnkgbG9naWMgd2hpY2ggZGVhbHMgd2l0aCBET00gcmVuZGVyaW5nIG9yIGxpc3RlbmluZyB0bwogKiBET00gZXZlbnRzLiBTdWNoIERPTSByZWxhdGVkIGxvZ2ljIHNob3VsZCBiZSBwcm92aWRlZCBieSBvdGhlciBkaXJlY3RpdmVzIHdoaWNoIG1ha2UgdXNlIG9mCiAqIGBOZ01vZGVsQ29udHJvbGxlcmAgZm9yIGRhdGEtYmluZGluZy4KICoKICogIyMgQ3VzdG9tIENvbnRyb2wgRXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IHRvIHVzZSBgTmdNb2RlbENvbnRyb2xsZXJgIHdpdGggYSBjdXN0b20gY29udHJvbCB0byBhY2hpZXZlCiAqIGRhdGEtYmluZGluZy4gTm90aWNlIGhvdyBkaWZmZXJlbnQgZGlyZWN0aXZlcyAoYGNvbnRlbnRlZGl0YWJsZWAsIGBuZy1tb2RlbGAsIGFuZCBgcmVxdWlyZWRgKQogKiBjb2xsYWJvcmF0ZSB0b2dldGhlciB0byBhY2hpZXZlIHRoZSBkZXNpcmVkIHJlc3VsdC4KICoKICogTm90ZSB0aGF0IGBjb250ZW50ZWRpdGFibGVgIGlzIGFuIEhUTUw1IGF0dHJpYnV0ZSwgd2hpY2ggdGVsbHMgdGhlIGJyb3dzZXIgdG8gbGV0IHRoZSBlbGVtZW50CiAqIGNvbnRlbnRzIGJlIGVkaXRlZCBpbiBwbGFjZSBieSB0aGUgdXNlci4gIFRoaXMgd2lsbCBub3Qgd29yayBvbiBvbGRlciBicm93c2Vycy4KICoKICogV2UgYXJlIHVzaW5nIHRoZSB7QGxpbmsgbmcuc2VydmljZTokc2NlICRzY2V9IHNlcnZpY2UgaGVyZSBhbmQgaW5jbHVkZSB0aGUge0BsaW5rIG5nU2FuaXRpemUgJHNhbml0aXplfQogKiBtb2R1bGUgdG8gYXV0b21hdGljYWxseSByZW1vdmUgImJhZCIgY29udGVudCBsaWtlIGlubGluZSBldmVudCBsaXN0ZW5lciAoZS5nLiBgPHNwYW4gb25jbGljaz0iLi4uIj5gKS4KICogSG93ZXZlciwgYXMgd2UgYXJlIHVzaW5nIGAkc2NlYCB0aGUgbW9kZWwgY2FuIHN0aWxsIGRlY2lkZSB0byB0byBwcm92aWRlIHVuc2FmZSBjb250ZW50IGlmIGl0IG1hcmtzCiAqIHRoYXQgY29udGVudCB1c2luZyB0aGUgYCRzY2VgIHNlcnZpY2UuCiAqCiAqIDxleGFtcGxlIG5hbWU9Ik5nTW9kZWxDb250cm9sbGVyIiBtb2R1bGU9ImN1c3RvbUNvbnRyb2wiIGRlcHM9ImFuZ3VsYXItc2FuaXRpemUuanMiPgogICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgW2NvbnRlbnRlZGl0YWJsZV0gewogICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogICAgICAgIG1pbi1oZWlnaHQ6IDIwcHg7CiAgICAgIH0KCiAgICAgIC5uZy1pbnZhbGlkIHsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCByZWQ7CiAgICAgIH0KCiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICBhbmd1bGFyLm1vZHVsZSgnY3VzdG9tQ29udHJvbCcsIFsnbmdTYW5pdGl6ZSddKS4KICAgICAgICBkaXJlY3RpdmUoJ2NvbnRlbnRlZGl0YWJsZScsIFsnJHNjZScsIGZ1bmN0aW9uKCRzY2UpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnQScsIC8vIG9ubHkgYWN0aXZhdGUgb24gZWxlbWVudCBhdHRyaWJ1dGUKICAgICAgICAgICAgcmVxdWlyZTogJz9uZ01vZGVsJywgLy8gZ2V0IGEgaG9sZCBvZiBOZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIG5nTW9kZWwpIHsKICAgICAgICAgICAgICBpZiAoIW5nTW9kZWwpIHJldHVybjsgLy8gZG8gbm90aGluZyBpZiBubyBuZy1tb2RlbAoKICAgICAgICAgICAgICAvLyBTcGVjaWZ5IGhvdyBVSSBzaG91bGQgYmUgdXBkYXRlZAogICAgICAgICAgICAgIG5nTW9kZWwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKCRzY2UuZ2V0VHJ1c3RlZEh0bWwobmdNb2RlbC4kdmlld1ZhbHVlIHx8ICcnKSk7CiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgLy8gTGlzdGVuIGZvciBjaGFuZ2UgZXZlbnRzIHRvIGVuYWJsZSBiaW5kaW5nCiAgICAgICAgICAgICAgZWxlbWVudC5vbignYmx1ciBrZXl1cCBjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShyZWFkKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZWFkKCk7IC8vIGluaXRpYWxpemUKCiAgICAgICAgICAgICAgLy8gV3JpdGUgZGF0YSB0byB0aGUgbW9kZWwKICAgICAgICAgICAgICBmdW5jdGlvbiByZWFkKCkgewogICAgICAgICAgICAgICAgdmFyIGh0bWwgPSBlbGVtZW50Lmh0bWwoKTsKICAgICAgICAgICAgICAgIC8vIFdoZW4gd2UgY2xlYXIgdGhlIGNvbnRlbnQgZWRpdGFibGUgdGhlIGJyb3dzZXIgbGVhdmVzIGEgPGJyPiBiZWhpbmQKICAgICAgICAgICAgICAgIC8vIElmIHN0cmlwLWJyIGF0dHJpYnV0ZSBpcyBwcm92aWRlZCB0aGVuIHdlIHN0cmlwIHRoaXMgb3V0CiAgICAgICAgICAgICAgICBpZiAoIGF0dHJzLnN0cmlwQnIgJiYgaHRtbCA9PSAnPGJyPicgKSB7CiAgICAgICAgICAgICAgICAgIGh0bWwgPSAnJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5nTW9kZWwuJHNldFZpZXdWYWx1ZShodG1sKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfV0pOwogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSI+CiAgICAgICA8ZGl2IGNvbnRlbnRlZGl0YWJsZQogICAgICAgICAgICBuYW1lPSJteVdpZGdldCIgbmctbW9kZWw9InVzZXJDb250ZW50IgogICAgICAgICAgICBzdHJpcC1icj0idHJ1ZSIKICAgICAgICAgICAgcmVxdWlyZWQ+Q2hhbmdlIG1lITwvZGl2PgogICAgICAgIDxzcGFuIG5nLXNob3c9Im15Rm9ybS5teVdpZGdldC4kZXJyb3IucmVxdWlyZWQiPlJlcXVpcmVkITwvc3Bhbj4KICAgICAgIDxocj4KICAgICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0idXNlckNvbnRlbnQiPjwvdGV4dGFyZWE+CiAgICAgIDwvZm9ybT4KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgaXQoJ3Nob3VsZCBkYXRhLWJpbmQgYW5kIGJlY29tZSBpbnZhbGlkJywgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChicm93c2VyLnBhcmFtcy5icm93c2VyID09ICdzYWZhcmknIHx8IGJyb3dzZXIucGFyYW1zLmJyb3dzZXIgPT0gJ2ZpcmVmb3gnKSB7CiAgICAgICAgLy8gU2FmYXJpRHJpdmVyIGNhbid0IGhhbmRsZSBjb250ZW50ZWRpdGFibGUKICAgICAgICAvLyBhbmQgRmlyZWZveCBkcml2ZXIgY2FuJ3QgY2xlYXIgY29udGVudGVkaXRhYmxlcyB2ZXJ5IHdlbGwKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGNvbnRlbnRFZGl0YWJsZSA9IGVsZW1lbnQoYnkuY3NzKCdbY29udGVudGVkaXRhYmxlXScpKTsKICAgICAgdmFyIGNvbnRlbnQgPSAnQ2hhbmdlIG1lISc7CgogICAgICBleHBlY3QoY29udGVudEVkaXRhYmxlLmdldFRleHQoKSkudG9FcXVhbChjb250ZW50KTsKCiAgICAgIGNvbnRlbnRFZGl0YWJsZS5jbGVhcigpOwogICAgICBjb250ZW50RWRpdGFibGUuc2VuZEtleXMocHJvdHJhY3Rvci5LZXkuQkFDS19TUEFDRSk7CiAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUuZ2V0VGV4dCgpKS50b0VxdWFsKCcnKTsKICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvTWF0Y2goL25nLWludmFsaWQtcmVxdWlyZWQvKTsKICAgIH0pOwogICAgPC9maWxlPgogKiA8L2V4YW1wbGU+CiAqCiAqCiAqLwp2YXIgTmdNb2RlbENvbnRyb2xsZXIgPSBbJyRzY29wZScsICckZXhjZXB0aW9uSGFuZGxlcicsICckYXR0cnMnLCAnJGVsZW1lbnQnLCAnJHBhcnNlJywgJyRhbmltYXRlJywgJyR0aW1lb3V0JywgJyRyb290U2NvcGUnLCAnJHEnLCAnJGludGVycG9sYXRlJywKICAgIGZ1bmN0aW9uKCRzY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIsICRhdHRyLCAkZWxlbWVudCwgJHBhcnNlLCAkYW5pbWF0ZSwgJHRpbWVvdXQsICRyb290U2NvcGUsICRxLCAkaW50ZXJwb2xhdGUpIHsKICB0aGlzLiR2aWV3VmFsdWUgPSBOdW1iZXIuTmFOOwogIHRoaXMuJG1vZGVsVmFsdWUgPSBOdW1iZXIuTmFOOwogIHRoaXMuJHZhbGlkYXRvcnMgPSB7fTsKICB0aGlzLiRhc3luY1ZhbGlkYXRvcnMgPSB7fTsKICB0aGlzLiRwYXJzZXJzID0gW107CiAgdGhpcy4kZm9ybWF0dGVycyA9IFtdOwogIHRoaXMuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMgPSBbXTsKICB0aGlzLiR1bnRvdWNoZWQgPSB0cnVlOwogIHRoaXMuJHRvdWNoZWQgPSBmYWxzZTsKICB0aGlzLiRwcmlzdGluZSA9IHRydWU7CiAgdGhpcy4kZGlydHkgPSBmYWxzZTsKICB0aGlzLiR2YWxpZCA9IHRydWU7CiAgdGhpcy4kaW52YWxpZCA9IGZhbHNlOwogIHRoaXMuJGVycm9yID0ge307IC8vIGtlZXAgaW52YWxpZCBrZXlzIGhlcmUKICB0aGlzLiQkc3VjY2VzcyA9IHt9OyAvLyBrZWVwIHZhbGlkIGtleXMgaGVyZQogIHRoaXMuJHBlbmRpbmcgPSB1bmRlZmluZWQ7IC8vIGtlZXAgcGVuZGluZyBrZXlzIGhlcmUKICB0aGlzLiRuYW1lID0gJGludGVycG9sYXRlKCRhdHRyLm5hbWUgfHwgJycsIGZhbHNlKSgkc2NvcGUpOwoKCiAgdmFyIHBhcnNlZE5nTW9kZWwgPSAkcGFyc2UoJGF0dHIubmdNb2RlbCksCiAgICAgIHBlbmRpbmdEZWJvdW5jZSA9IG51bGwsCiAgICAgIGN0cmwgPSB0aGlzOwoKICB2YXIgbmdNb2RlbEdldCA9IGZ1bmN0aW9uIG5nTW9kZWxHZXQoKSB7CiAgICB2YXIgbW9kZWxWYWx1ZSA9IHBhcnNlZE5nTW9kZWwoJHNjb3BlKTsKICAgIGlmIChjdHJsLiRvcHRpb25zICYmIGN0cmwuJG9wdGlvbnMuZ2V0dGVyU2V0dGVyICYmIGlzRnVuY3Rpb24obW9kZWxWYWx1ZSkpIHsKICAgICAgbW9kZWxWYWx1ZSA9IG1vZGVsVmFsdWUoKTsKICAgIH0KICAgIHJldHVybiBtb2RlbFZhbHVlOwogIH07CgogIHZhciBuZ01vZGVsU2V0ID0gZnVuY3Rpb24gbmdNb2RlbFNldChuZXdWYWx1ZSkgewogICAgdmFyIGdldHRlclNldHRlcjsKICAgIGlmIChjdHJsLiRvcHRpb25zICYmIGN0cmwuJG9wdGlvbnMuZ2V0dGVyU2V0dGVyICYmCiAgICAgICAgaXNGdW5jdGlvbihnZXR0ZXJTZXR0ZXIgPSBwYXJzZWROZ01vZGVsKCRzY29wZSkpKSB7CgogICAgICBnZXR0ZXJTZXR0ZXIoY3RybC4kbW9kZWxWYWx1ZSk7CiAgICB9IGVsc2UgewogICAgICBwYXJzZWROZ01vZGVsLmFzc2lnbigkc2NvcGUsIGN0cmwuJG1vZGVsVmFsdWUpOwogICAgfQogIH07CgogIHRoaXMuJCRzZXRPcHRpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgY3RybC4kb3B0aW9ucyA9IG9wdGlvbnM7CgogICAgaWYgKCFwYXJzZWROZ01vZGVsLmFzc2lnbiAmJiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMuZ2V0dGVyU2V0dGVyKSkgewogICAgICB0aHJvdyAkbmdNb2RlbE1pbkVycignbm9uYXNzaWduJywgIkV4cHJlc3Npb24gJ3swfScgaXMgbm9uLWFzc2lnbmFibGUuIEVsZW1lbnQ6IHsxfSIsCiAgICAgICAgICAkYXR0ci5uZ01vZGVsLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgfQogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRyZW5kZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENhbGxlZCB3aGVuIHRoZSB2aWV3IG5lZWRzIHRvIGJlIHVwZGF0ZWQuIEl0IGlzIGV4cGVjdGVkIHRoYXQgdGhlIHVzZXIgb2YgdGhlIG5nLW1vZGVsCiAgICogZGlyZWN0aXZlIHdpbGwgaW1wbGVtZW50IHRoaXMgbWV0aG9kLgogICAqCiAgICogVGhlIGAkcmVuZGVyKClgIG1ldGhvZCBpcyBpbnZva2VkIGluIHRoZSBmb2xsb3dpbmcgc2l0dWF0aW9uczoKICAgKgogICAqICogYCRyb2xsYmFja1ZpZXdWYWx1ZSgpYCBpcyBjYWxsZWQuICBJZiB3ZSBhcmUgcm9sbGluZyBiYWNrIHRoZSB2aWV3IHZhbHVlIHRvIHRoZSBsYXN0CiAgICogICBjb21taXR0ZWQgdmFsdWUgdGhlbiBgJHJlbmRlcigpYCBpcyBjYWxsZWQgdG8gdXBkYXRlIHRoZSBpbnB1dCBjb250cm9sLgogICAqICogVGhlIHZhbHVlIHJlZmVyZW5jZWQgYnkgYG5nLW1vZGVsYCBpcyBjaGFuZ2VkIHByb2dyYW1tYXRpY2FsbHkgYW5kIGJvdGggdGhlIGAkbW9kZWxWYWx1ZWAgYW5kCiAgICogICB0aGUgYCR2aWV3VmFsdWVgIGFyZSBkaWZmZXJlbnQgdG8gbGFzdCB0aW1lLgogICAqCiAgICogU2luY2UgYG5nLW1vZGVsYCBkb2VzIG5vdCBkbyBhIGRlZXAgd2F0Y2gsIGAkcmVuZGVyKClgIGlzIG9ubHkgaW52b2tlZCBpZiB0aGUgdmFsdWVzIG9mCiAgICogYCRtb2RlbFZhbHVlYCBhbmQgYCR2aWV3VmFsdWVgIGFyZSBhY3R1YWxseSBkaWZmZXJlbnQgdG8gdGhlaXIgcHJldmlvdXMgdmFsdWUuIElmIGAkbW9kZWxWYWx1ZWAKICAgKiBvciBgJHZpZXdWYWx1ZWAgYXJlIG9iamVjdHMgKHJhdGhlciB0aGFuIGEgc3RyaW5nIG9yIG51bWJlcikgdGhlbiBgJHJlbmRlcigpYCB3aWxsIG5vdCBiZQogICAqIGludm9rZWQgaWYgeW91IG9ubHkgY2hhbmdlIGEgcHJvcGVydHkgb24gdGhlIG9iamVjdHMuCiAgICovCiAgdGhpcy4kcmVuZGVyID0gbm9vcDsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJGlzRW1wdHkKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgaXMgY2FsbGVkIHdoZW4gd2UgbmVlZCB0byBkZXRlcm1pbmUgaWYgdGhlIHZhbHVlIG9mIHRoZSBpbnB1dCBpcyBlbXB0eS4KICAgKgogICAqIEZvciBpbnN0YW5jZSwgdGhlIHJlcXVpcmVkIGRpcmVjdGl2ZSBkb2VzIHRoaXMgdG8gd29yayBvdXQgaWYgdGhlIGlucHV0IGhhcyBkYXRhIG9yIG5vdC4KICAgKiBUaGUgZGVmYXVsdCBgJGlzRW1wdHlgIGZ1bmN0aW9uIGNoZWNrcyB3aGV0aGVyIHRoZSB2YWx1ZSBpcyBgdW5kZWZpbmVkYCwgYCcnYCwgYG51bGxgIG9yIGBOYU5gLgogICAqCiAgICogWW91IGNhbiBvdmVycmlkZSB0aGlzIGZvciBpbnB1dCBkaXJlY3RpdmVzIHdob3NlIGNvbmNlcHQgb2YgYmVpbmcgZW1wdHkgaXMgZGlmZmVyZW50IHRvIHRoZQogICAqIGRlZmF1bHQuIFRoZSBgY2hlY2tib3hJbnB1dFR5cGVgIGRpcmVjdGl2ZSBkb2VzIHRoaXMgYmVjYXVzZSBpbiBpdHMgY2FzZSBhIHZhbHVlIG9mIGBmYWxzZWAKICAgKiBpbXBsaWVzIGVtcHR5LgogICAqCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBNb2RlbCB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGVtcHR5LgogICAqLwogIHRoaXMuJGlzRW1wdHkgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIGlzVW5kZWZpbmVkKHZhbHVlKSB8fCB2YWx1ZSA9PT0gJycgfHwgdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgIT09IHZhbHVlOwogIH07CgogIHZhciBwYXJlbnRGb3JtID0gJGVsZW1lbnQuaW5oZXJpdGVkRGF0YSgnJGZvcm1Db250cm9sbGVyJykgfHwgbnVsbEZvcm1DdHJsLAogICAgICBjdXJyZW50VmFsaWRhdGlvblJ1bklkID0gMDsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDaGFuZ2UgdGhlIHZhbGlkaXR5IHN0YXRlLCBhbmQgbm90aWZpZXMgdGhlIGZvcm0uCiAgICoKICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHdpdGhpbiAkcGFyc2Vycy8kZm9ybWF0dGVycy4gSG93ZXZlciwgaWYgcG9zc2libGUsIHBsZWFzZSB1c2UgdGhlCiAgICogICAgICAgIGBuZ01vZGVsLiR2YWxpZGF0b3JzYCBwaXBlbGluZSB3aGljaCBpcyBkZXNpZ25lZCB0byBjYWxsIHRoaXMgbWV0aG9kIGF1dG9tYXRpY2FsbHkuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsaWRhdGlvbkVycm9yS2V5IE5hbWUgb2YgdGhlIHZhbGlkYXRvci4gdGhlIGB2YWxpZGF0aW9uRXJyb3JLZXlgIHdpbGwgYXNzaWduCiAgICogICAgICAgIHRvIGAkZXJyb3JbdmFsaWRhdGlvbkVycm9yS2V5XWAgYW5kIGAkcGVuZGluZ1t2YWxpZGF0aW9uRXJyb3JLZXldYAogICAqICAgICAgICBzbyB0aGF0IGl0IGlzIGF2YWlsYWJsZSBmb3IgZGF0YS1iaW5kaW5nLgogICAqICAgICAgICBUaGUgYHZhbGlkYXRpb25FcnJvcktleWAgc2hvdWxkIGJlIGluIGNhbWVsQ2FzZSBhbmQgd2lsbCBnZXQgY29udmVydGVkIGludG8gZGFzaC1jYXNlCiAgICogICAgICAgIGZvciBjbGFzcyBuYW1lLiBFeGFtcGxlOiBgbXlFcnJvcmAgd2lsbCByZXN1bHQgaW4gYG5nLXZhbGlkLW15LWVycm9yYCBhbmQgYG5nLWludmFsaWQtbXktZXJyb3JgCiAgICogICAgICAgIGNsYXNzIGFuZCBjYW4gYmUgYm91bmQgdG8gYXMgIGB7e3NvbWVGb3JtLnNvbWVDb250cm9sLiRlcnJvci5teUVycm9yfX1gIC4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzVmFsaWQgV2hldGhlciB0aGUgY3VycmVudCBzdGF0ZSBpcyB2YWxpZCAodHJ1ZSksIGludmFsaWQgKGZhbHNlKSwgcGVuZGluZyAodW5kZWZpbmVkKSwKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgb3Igc2tpcHBlZCAobnVsbCkuCiAgICovCiAgYWRkU2V0VmFsaWRpdHlNZXRob2QoewogICAgY3RybDogdGhpcywKICAgICRlbGVtZW50OiAkZWxlbWVudCwKICAgIHNldDogZnVuY3Rpb24ob2JqZWN0LCBwcm9wZXJ0eSkgewogICAgICBvYmplY3RbcHJvcGVydHldID0gdHJ1ZTsKICAgIH0sCiAgICB1bnNldDogZnVuY3Rpb24ob2JqZWN0LCBwcm9wZXJ0eSkgewogICAgICBkZWxldGUgb2JqZWN0W3Byb3BlcnR5XTsKICAgIH0sCiAgICBwYXJlbnRGb3JtOiBwYXJlbnRGb3JtLAogICAgJGFuaW1hdGU6ICRhbmltYXRlCiAgfSk7CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRQcmlzdGluZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0cyB0aGUgY29udHJvbCB0byBpdHMgcHJpc3RpbmUgc3RhdGUuCiAgICoKICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIHJlbW92ZSB0aGUgJ25nLWRpcnR5JyBjbGFzcyBhbmQgc2V0IHRoZSBjb250cm9sIHRvIGl0cyBwcmlzdGluZQogICAqIHN0YXRlIChuZy1wcmlzdGluZSBjbGFzcykuIEEgbW9kZWwgaXMgY29uc2lkZXJlZCB0byBiZSBwcmlzdGluZSB3aGVuIHRoZSBtb2RlbCBoYXMgbm90IGJlZW4gY2hhbmdlZAogICAqIGZyb20gd2hlbiBmaXJzdCBjb21waWxlZCB3aXRoaW4gdGhlbiBmb3JtLgogICAqLwogIHRoaXMuJHNldFByaXN0aW5lID0gZnVuY3Rpb24gKCkgewogICAgY3RybC4kZGlydHkgPSBmYWxzZTsKICAgIGN0cmwuJHByaXN0aW5lID0gdHJ1ZTsKICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKCRlbGVtZW50LCBESVJUWV9DTEFTUyk7CiAgICAkYW5pbWF0ZS5hZGRDbGFzcygkZWxlbWVudCwgUFJJU1RJTkVfQ0xBU1MpOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRVbnRvdWNoZWQKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNldHMgdGhlIGNvbnRyb2wgdG8gaXRzIHVudG91Y2hlZCBzdGF0ZS4KICAgKgogICAqIFRoaXMgbWV0aG9kIGNhbiBiZSBjYWxsZWQgdG8gcmVtb3ZlIHRoZSAnbmctdG91Y2hlZCcgY2xhc3MgYW5kIHNldCB0aGUgY29udHJvbCB0byBpdHMKICAgKiB1bnRvdWNoZWQgc3RhdGUgKG5nLXVudG91Y2hlZCBjbGFzcykuIFVwb24gY29tcGlsYXRpb24sIGEgbW9kZWwgaXMgc2V0IGFzIHVudG91Y2hlZAogICAqIGJ5IGRlZmF1bHQsIGhvd2V2ZXIgdGhpcyBmdW5jdGlvbiBjYW4gYmUgdXNlZCB0byByZXN0b3JlIHRoYXQgc3RhdGUgaWYgdGhlIG1vZGVsIGhhcwogICAqIGFscmVhZHkgYmVlbiB0b3VjaGVkIGJ5IHRoZSB1c2VyLgogICAqLwogIHRoaXMuJHNldFVudG91Y2hlZCA9IGZ1bmN0aW9uKCkgewogICAgY3RybC4kdG91Y2hlZCA9IGZhbHNlOwogICAgY3RybC4kdW50b3VjaGVkID0gdHJ1ZTsKICAgICRhbmltYXRlLnNldENsYXNzKCRlbGVtZW50LCBVTlRPVUNIRURfQ0xBU1MsIFRPVUNIRURfQ0xBU1MpOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRUb3VjaGVkCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXRzIHRoZSBjb250cm9sIHRvIGl0cyB0b3VjaGVkIHN0YXRlLgogICAqCiAgICogVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB0byByZW1vdmUgdGhlICduZy11bnRvdWNoZWQnIGNsYXNzIGFuZCBzZXQgdGhlIGNvbnRyb2wgdG8gaXRzCiAgICogdG91Y2hlZCBzdGF0ZSAobmctdG91Y2hlZCBjbGFzcykuIEEgbW9kZWwgaXMgY29uc2lkZXJlZCB0byBiZSB0b3VjaGVkIHdoZW4gdGhlIHVzZXIgaGFzCiAgICogZmlyc3QgaW50ZXJhY3RlZCAoZm9jdXNzZWQpIG9uIHRoZSBtb2RlbCBpbnB1dCBlbGVtZW50IGFuZCB0aGVuIHNoaWZ0ZWQgZm9jdXMgYXdheSAoYmx1cnJlZCkKICAgKiBmcm9tIHRoZSBpbnB1dCBlbGVtZW50LgogICAqLwogIHRoaXMuJHNldFRvdWNoZWQgPSBmdW5jdGlvbigpIHsKICAgIGN0cmwuJHRvdWNoZWQgPSB0cnVlOwogICAgY3RybC4kdW50b3VjaGVkID0gZmFsc2U7CiAgICAkYW5pbWF0ZS5zZXRDbGFzcygkZWxlbWVudCwgVE9VQ0hFRF9DTEFTUywgVU5UT1VDSEVEX0NMQVNTKTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkcm9sbGJhY2tWaWV3VmFsdWUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENhbmNlbCBhbiB1cGRhdGUgYW5kIHJlc2V0IHRoZSBpbnB1dCBlbGVtZW50J3MgdmFsdWUgdG8gcHJldmVudCBhbiB1cGRhdGUgdG8gdGhlIGAkbW9kZWxWYWx1ZWAsCiAgICogd2hpY2ggbWF5IGJlIGNhdXNlZCBieSBhIHBlbmRpbmcgZGVib3VuY2VkIGV2ZW50IG9yIGJlY2F1c2UgdGhlIGlucHV0IGlzIHdhaXRpbmcgZm9yIGEgc29tZQogICAqIGZ1dHVyZSBldmVudC4KICAgKgogICAqIElmIHlvdSBoYXZlIGFuIGlucHV0IHRoYXQgdXNlcyBgbmctbW9kZWwtb3B0aW9uc2AgdG8gc2V0IHVwIGRlYm91bmNlZCBldmVudHMgb3IgZXZlbnRzIHN1Y2gKICAgKiBhcyBibHVyIHlvdSBjYW4gaGF2ZSBhIHNpdHVhdGlvbiB3aGVyZSB0aGVyZSBpcyBhIHBlcmlvZCB3aGVuIHRoZSBgJHZpZXdWYWx1ZWAKICAgKiBpcyBvdXQgb2Ygc3luY2ggd2l0aCB0aGUgbmdNb2RlbCdzIGAkbW9kZWxWYWx1ZWAuCiAgICoKICAgKiBJbiB0aGlzIGNhc2UsIHlvdSBjYW4gcnVuIGludG8gZGlmZmljdWx0aWVzIGlmIHlvdSB0cnkgdG8gdXBkYXRlIHRoZSBuZ01vZGVsJ3MgYCRtb2RlbFZhbHVlYAogICAqIHByb2dyYW1tYXRpY2FsbHkgYmVmb3JlIHRoZXNlIGRlYm91bmNlZC9mdXR1cmUgZXZlbnRzIGhhdmUgcmVzb2x2ZWQvb2NjdXJyZWQsIGJlY2F1c2UgQW5ndWxhcidzCiAgICogZGlydHkgY2hlY2tpbmcgbWVjaGFuaXNtIGlzIG5vdCBhYmxlIHRvIHRlbGwgd2hldGhlciB0aGUgbW9kZWwgaGFzIGFjdHVhbGx5IGNoYW5nZWQgb3Igbm90LgogICAqCiAgICogVGhlIGAkcm9sbGJhY2tWaWV3VmFsdWUoKWAgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgYmVmb3JlIHByb2dyYW1tYXRpY2FsbHkgY2hhbmdpbmcgdGhlIG1vZGVsIG9mIGFuCiAgICogaW5wdXQgd2hpY2ggbWF5IGhhdmUgc3VjaCBldmVudHMgcGVuZGluZy4gVGhpcyBpcyBpbXBvcnRhbnQgaW4gb3JkZXIgdG8gbWFrZSBzdXJlIHRoYXQgdGhlCiAgICogaW5wdXQgZmllbGQgd2lsbCBiZSB1cGRhdGVkIHdpdGggdGhlIG5ldyBtb2RlbCB2YWx1ZSBhbmQgYW55IHBlbmRpbmcgb3BlcmF0aW9ucyBhcmUgY2FuY2VsbGVkLgogICAqCiAgICogPGV4YW1wbGUgbmFtZT0ibmctbW9kZWwtY2FuY2VsLXVwZGF0ZSIgbW9kdWxlPSJjYW5jZWwtdXBkYXRlLWV4YW1wbGUiPgogICAqICAgPGZpbGUgbmFtZT0iYXBwLmpzIj4KICAgKiAgICAgYW5ndWxhci5tb2R1bGUoJ2NhbmNlbC11cGRhdGUtZXhhbXBsZScsIFtdKQogICAqCiAgICogICAgIC5jb250cm9sbGVyKCdDYW5jZWxVcGRhdGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgKiAgICAgICAkc2NvcGUucmVzZXRXaXRoQ2FuY2VsID0gZnVuY3Rpb24gKGUpIHsKICAgKiAgICAgICAgIGlmIChlLmtleUNvZGUgPT0gMjcpIHsKICAgKiAgICAgICAgICAgJHNjb3BlLm15Rm9ybS5teUlucHV0MS4kcm9sbGJhY2tWaWV3VmFsdWUoKTsKICAgKiAgICAgICAgICAgJHNjb3BlLm15VmFsdWUgPSAnJzsKICAgKiAgICAgICAgIH0KICAgKiAgICAgICB9OwogICAqICAgICAgICRzY29wZS5yZXNldFdpdGhvdXRDYW5jZWwgPSBmdW5jdGlvbiAoZSkgewogICAqICAgICAgICAgaWYgKGUua2V5Q29kZSA9PSAyNykgewogICAqICAgICAgICAgICAkc2NvcGUubXlWYWx1ZSA9ICcnOwogICAqICAgICAgICAgfQogICAqICAgICAgIH07CiAgICogICAgIH1dKTsKICAgKiAgIDwvZmlsZT4KICAgKiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAqICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkNhbmNlbFVwZGF0ZUNvbnRyb2xsZXIiPgogICAqICAgICAgIDxwPlRyeSB0eXBpbmcgc29tZXRoaW5nIGluIGVhY2ggaW5wdXQuICBTZWUgdGhhdCB0aGUgbW9kZWwgb25seSB1cGRhdGVzIHdoZW4geW91CiAgICogICAgICAgICAgYmx1ciBvZmYgdGhlIGlucHV0LgogICAqICAgICAgICA8L3A+CiAgICogICAgICAgIDxwPk5vdyBzZWUgd2hhdCBoYXBwZW5zIGlmIHlvdSBzdGFydCB0eXBpbmcgdGhlbiBwcmVzcyB0aGUgRXNjYXBlIGtleTwvcD4KICAgKgogICAqICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctbW9kZWwtb3B0aW9ucz0ieyB1cGRhdGVPbjogJ2JsdXInIH0iPgogICAqICAgICAgICAgPHA+V2l0aCAkcm9sbGJhY2tWaWV3VmFsdWUoKTwvcD4KICAgKiAgICAgICAgIDxpbnB1dCBuYW1lPSJteUlucHV0MSIgbmctbW9kZWw9Im15VmFsdWUiIG5nLWtleWRvd249InJlc2V0V2l0aENhbmNlbCgkZXZlbnQpIj48YnIvPgogICAqICAgICAgICAgbXlWYWx1ZTogInt7IG15VmFsdWUgfX0iCiAgICoKICAgKiAgICAgICAgIDxwPldpdGhvdXQgJHJvbGxiYWNrVmlld1ZhbHVlKCk8L3A+CiAgICogICAgICAgICA8aW5wdXQgbmFtZT0ibXlJbnB1dDIiIG5nLW1vZGVsPSJteVZhbHVlIiBuZy1rZXlkb3duPSJyZXNldFdpdGhvdXRDYW5jZWwoJGV2ZW50KSI+PGJyLz4KICAgKiAgICAgICAgIG15VmFsdWU6ICJ7eyBteVZhbHVlIH19IgogICAqICAgICAgIDwvZm9ybT4KICAgKiAgICAgPC9kaXY+CiAgICogICA8L2ZpbGU+CiAgICogPC9leGFtcGxlPgogICAqLwogIHRoaXMuJHJvbGxiYWNrVmlld1ZhbHVlID0gZnVuY3Rpb24oKSB7CiAgICAkdGltZW91dC5jYW5jZWwocGVuZGluZ0RlYm91bmNlKTsKICAgIGN0cmwuJHZpZXdWYWx1ZSA9IGN0cmwuJCRsYXN0Q29tbWl0dGVkVmlld1ZhbHVlOwogICAgY3RybC4kcmVuZGVyKCk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHZhbGlkYXRlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSdW5zIGVhY2ggb2YgdGhlIHJlZ2lzdGVyZWQgdmFsaWRhdG9ycyAoZmlyc3Qgc3luY2hyb25vdXMgdmFsaWRhdG9ycyBhbmQgdGhlbiBhc3luY2hyb25vdXMgdmFsaWRhdG9ycykuCiAgICovCiAgdGhpcy4kdmFsaWRhdGUgPSBmdW5jdGlvbigpIHsKICAgIC8vIGlnbm9yZSAkdmFsaWRhdGUgYmVmb3JlIG1vZGVsIGlzIGluaXRpYWxpemVkCiAgICBpZiAoaXNOdW1iZXIoY3RybC4kbW9kZWxWYWx1ZSkgJiYgaXNOYU4oY3RybC4kbW9kZWxWYWx1ZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4kJHBhcnNlQW5kVmFsaWRhdGUoKTsKICB9OwoKICB0aGlzLiQkcnVuVmFsaWRhdG9ycyA9IGZ1bmN0aW9uKHBhcnNlVmFsaWQsIG1vZGVsVmFsdWUsIHZpZXdWYWx1ZSwgZG9uZUNhbGxiYWNrKSB7CiAgICBjdXJyZW50VmFsaWRhdGlvblJ1bklkKys7CiAgICB2YXIgbG9jYWxWYWxpZGF0aW9uUnVuSWQgPSBjdXJyZW50VmFsaWRhdGlvblJ1bklkOwoKICAgIC8vIGNoZWNrIHBhcnNlciBlcnJvcgogICAgaWYgKCFwcm9jZXNzUGFyc2VFcnJvcnMocGFyc2VWYWxpZCkpIHsKICAgICAgdmFsaWRhdGlvbkRvbmUoZmFsc2UpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXByb2Nlc3NTeW5jVmFsaWRhdG9ycygpKSB7CiAgICAgIHZhbGlkYXRpb25Eb25lKGZhbHNlKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgcHJvY2Vzc0FzeW5jVmFsaWRhdG9ycygpOwoKICAgIGZ1bmN0aW9uIHByb2Nlc3NQYXJzZUVycm9ycyhwYXJzZVZhbGlkKSB7CiAgICAgIHZhciBlcnJvcktleSA9IGN0cmwuJCRwYXJzZXJOYW1lIHx8ICdwYXJzZSc7CiAgICAgIGlmIChwYXJzZVZhbGlkID09PSB1bmRlZmluZWQpIHsKICAgICAgICBzZXRWYWxpZGl0eShlcnJvcktleSwgbnVsbCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0VmFsaWRpdHkoZXJyb3JLZXksIHBhcnNlVmFsaWQpOwogICAgICAgIGlmICghcGFyc2VWYWxpZCkgewogICAgICAgICAgZm9yRWFjaChjdHJsLiR2YWxpZGF0b3JzLCBmdW5jdGlvbih2LCBuYW1lKSB7CiAgICAgICAgICAgIHNldFZhbGlkaXR5KG5hbWUsIG51bGwpOwogICAgICAgICAgfSk7CiAgICAgICAgICBmb3JFYWNoKGN0cmwuJGFzeW5jVmFsaWRhdG9ycywgZnVuY3Rpb24odiwgbmFtZSkgewogICAgICAgICAgICBzZXRWYWxpZGl0eShuYW1lLCBudWxsKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBwcm9jZXNzU3luY1ZhbGlkYXRvcnMoKSB7CiAgICAgIHZhciBzeW5jVmFsaWRhdG9yc1ZhbGlkID0gdHJ1ZTsKICAgICAgZm9yRWFjaChjdHJsLiR2YWxpZGF0b3JzLCBmdW5jdGlvbih2YWxpZGF0b3IsIG5hbWUpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gdmFsaWRhdG9yKG1vZGVsVmFsdWUsIHZpZXdWYWx1ZSk7CiAgICAgICAgc3luY1ZhbGlkYXRvcnNWYWxpZCA9IHN5bmNWYWxpZGF0b3JzVmFsaWQgJiYgcmVzdWx0OwogICAgICAgIHNldFZhbGlkaXR5KG5hbWUsIHJlc3VsdCk7CiAgICAgIH0pOwogICAgICBpZiAoIXN5bmNWYWxpZGF0b3JzVmFsaWQpIHsKICAgICAgICBmb3JFYWNoKGN0cmwuJGFzeW5jVmFsaWRhdG9ycywgZnVuY3Rpb24odiwgbmFtZSkgewogICAgICAgICAgc2V0VmFsaWRpdHkobmFtZSwgbnVsbCk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIHByb2Nlc3NBc3luY1ZhbGlkYXRvcnMoKSB7CiAgICAgIHZhciB2YWxpZGF0b3JQcm9taXNlcyA9IFtdOwogICAgICB2YXIgYWxsVmFsaWQgPSB0cnVlOwogICAgICBmb3JFYWNoKGN0cmwuJGFzeW5jVmFsaWRhdG9ycywgZnVuY3Rpb24odmFsaWRhdG9yLCBuYW1lKSB7CiAgICAgICAgdmFyIHByb21pc2UgPSB2YWxpZGF0b3IobW9kZWxWYWx1ZSwgdmlld1ZhbHVlKTsKICAgICAgICBpZiAoIWlzUHJvbWlzZUxpa2UocHJvbWlzZSkpIHsKICAgICAgICAgIHRocm93ICRuZ01vZGVsTWluRXJyKCIkYXN5bmNWYWxpZGF0b3JzIiwKICAgICAgICAgICAgIkV4cGVjdGVkIGFzeW5jaHJvbm91cyB2YWxpZGF0b3IgdG8gcmV0dXJuIGEgcHJvbWlzZSBidXQgZ290ICd7MH0nIGluc3RlYWQuIiwgcHJvbWlzZSk7CiAgICAgICAgfQogICAgICAgIHNldFZhbGlkaXR5KG5hbWUsIHVuZGVmaW5lZCk7CiAgICAgICAgdmFsaWRhdG9yUHJvbWlzZXMucHVzaChwcm9taXNlLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZXRWYWxpZGl0eShuYW1lLCB0cnVlKTsKICAgICAgICB9LCBmdW5jdGlvbihlcnJvcikgewogICAgICAgICAgYWxsVmFsaWQgPSBmYWxzZTsKICAgICAgICAgIHNldFZhbGlkaXR5KG5hbWUsIGZhbHNlKTsKICAgICAgICB9KSk7CiAgICAgIH0pOwogICAgICBpZiAoIXZhbGlkYXRvclByb21pc2VzLmxlbmd0aCkgewogICAgICAgIHZhbGlkYXRpb25Eb25lKHRydWUpOwogICAgICB9IGVsc2UgewogICAgICAgICRxLmFsbCh2YWxpZGF0b3JQcm9taXNlcykudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgIHZhbGlkYXRpb25Eb25lKGFsbFZhbGlkKTsKICAgICAgICB9LCBub29wKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHNldFZhbGlkaXR5KG5hbWUsIGlzVmFsaWQpIHsKICAgICAgaWYgKGxvY2FsVmFsaWRhdGlvblJ1bklkID09PSBjdXJyZW50VmFsaWRhdGlvblJ1bklkKSB7CiAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkobmFtZSwgaXNWYWxpZCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiB2YWxpZGF0aW9uRG9uZShhbGxWYWxpZCkgewogICAgICBpZiAobG9jYWxWYWxpZGF0aW9uUnVuSWQgPT09IGN1cnJlbnRWYWxpZGF0aW9uUnVuSWQpIHsKCiAgICAgICAgZG9uZUNhbGxiYWNrKGFsbFZhbGlkKTsKICAgICAgfQogICAgfQogIH07CgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRjb21taXRWaWV3VmFsdWUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENvbW1pdCBhIHBlbmRpbmcgdXBkYXRlIHRvIHRoZSBgJG1vZGVsVmFsdWVgLgogICAqCiAgICogVXBkYXRlcyBtYXkgYmUgcGVuZGluZyBieSBhIGRlYm91bmNlZCBldmVudCBvciBiZWNhdXNlIHRoZSBpbnB1dCBpcyB3YWl0aW5nIGZvciBhIHNvbWUgZnV0dXJlCiAgICogZXZlbnQgZGVmaW5lZCBpbiBgbmctbW9kZWwtb3B0aW9uc2AuIHRoaXMgbWV0aG9kIGlzIHJhcmVseSBuZWVkZWQgYXMgYE5nTW9kZWxDb250cm9sbGVyYAogICAqIHVzdWFsbHkgaGFuZGxlcyBjYWxsaW5nIHRoaXMgaW4gcmVzcG9uc2UgdG8gaW5wdXQgZXZlbnRzLgogICAqLwogIHRoaXMuJGNvbW1pdFZpZXdWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHZpZXdWYWx1ZSA9IGN0cmwuJHZpZXdWYWx1ZTsKCiAgICAkdGltZW91dC5jYW5jZWwocGVuZGluZ0RlYm91bmNlKTsKCiAgICAvLyBJZiB0aGUgdmlldyB2YWx1ZSBoYXMgbm90IGNoYW5nZWQgdGhlbiB3ZSBzaG91bGQganVzdCBleGl0LCBleGNlcHQgaW4gdGhlIGNhc2Ugd2hlcmUgdGhlcmUgaXMKICAgIC8vIGEgbmF0aXZlIHZhbGlkYXRvciBvbiB0aGUgZWxlbWVudC4gSW4gdGhpcyBjYXNlIHRoZSB2YWxpZGF0aW9uIHN0YXRlIG1heSBoYXZlIGNoYW5nZWQgZXZlbiB0aG91Z2gKICAgIC8vIHRoZSB2aWV3VmFsdWUgaGFzIHN0YXllZCBlbXB0eS4KICAgIGlmIChjdHJsLiQkbGFzdENvbW1pdHRlZFZpZXdWYWx1ZSA9PT0gdmlld1ZhbHVlICYmICh2aWV3VmFsdWUgIT09ICcnIHx8ICFjdHJsLiQkaGFzTmF0aXZlVmFsaWRhdG9ycykpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY3RybC4kJGxhc3RDb21taXR0ZWRWaWV3VmFsdWUgPSB2aWV3VmFsdWU7CgogICAgLy8gY2hhbmdlIHRvIGRpcnR5CiAgICBpZiAoY3RybC4kcHJpc3RpbmUpIHsKICAgICAgY3RybC4kZGlydHkgPSB0cnVlOwogICAgICBjdHJsLiRwcmlzdGluZSA9IGZhbHNlOwogICAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcygkZWxlbWVudCwgUFJJU1RJTkVfQ0xBU1MpOwogICAgICAkYW5pbWF0ZS5hZGRDbGFzcygkZWxlbWVudCwgRElSVFlfQ0xBU1MpOwogICAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogICAgfQogICAgdGhpcy4kJHBhcnNlQW5kVmFsaWRhdGUoKTsKICB9OwoKICB0aGlzLiQkcGFyc2VBbmRWYWxpZGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHZpZXdWYWx1ZSA9IGN0cmwuJCRsYXN0Q29tbWl0dGVkVmlld1ZhbHVlOwogICAgdmFyIG1vZGVsVmFsdWUgPSB2aWV3VmFsdWU7CiAgICB2YXIgcGFyc2VyVmFsaWQgPSBpc1VuZGVmaW5lZChtb2RlbFZhbHVlKSA/IHVuZGVmaW5lZCA6IHRydWU7CgogICAgaWYgKHBhcnNlclZhbGlkKSB7CiAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBjdHJsLiRwYXJzZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbW9kZWxWYWx1ZSA9IGN0cmwuJHBhcnNlcnNbaV0obW9kZWxWYWx1ZSk7CiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKG1vZGVsVmFsdWUpKSB7CiAgICAgICAgICBwYXJzZXJWYWxpZCA9IGZhbHNlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAoaXNOdW1iZXIoY3RybC4kbW9kZWxWYWx1ZSkgJiYgaXNOYU4oY3RybC4kbW9kZWxWYWx1ZSkpIHsKICAgICAgLy8gY3RybC4kbW9kZWxWYWx1ZSBoYXMgbm90IGJlZW4gdG91Y2hlZCB5ZXQuLi4KICAgICAgY3RybC4kbW9kZWxWYWx1ZSA9IG5nTW9kZWxHZXQoKTsKICAgIH0KICAgIHZhciBwcmV2TW9kZWxWYWx1ZSA9IGN0cmwuJG1vZGVsVmFsdWU7CiAgICB2YXIgYWxsb3dJbnZhbGlkID0gY3RybC4kb3B0aW9ucyAmJiBjdHJsLiRvcHRpb25zLmFsbG93SW52YWxpZDsKICAgIGlmIChhbGxvd0ludmFsaWQpIHsKICAgICAgY3RybC4kbW9kZWxWYWx1ZSA9IG1vZGVsVmFsdWU7CiAgICAgIHdyaXRlVG9Nb2RlbElmTmVlZGVkKCk7CiAgICB9CiAgICBjdHJsLiQkcnVuVmFsaWRhdG9ycyhwYXJzZXJWYWxpZCwgbW9kZWxWYWx1ZSwgdmlld1ZhbHVlLCBmdW5jdGlvbihhbGxWYWxpZCkgewogICAgICBpZiAoIWFsbG93SW52YWxpZCkgewogICAgICAgIC8vIE5vdGU6IERvbid0IGNoZWNrIGN0cmwuJHZhbGlkIGhlcmUsIGFzIHdlIGNvdWxkIGhhdmUKICAgICAgICAvLyBleHRlcm5hbCB2YWxpZGF0b3JzIChlLmcuIGNhbGN1bGF0ZWQgb24gdGhlIHNlcnZlciksCiAgICAgICAgLy8gdGhhdCBqdXN0IGNhbGwgJHNldFZhbGlkaXR5IGFuZCBuZWVkIHRoZSBtb2RlbCB2YWx1ZQogICAgICAgIC8vIHRvIGNhbGN1bGF0ZSB0aGVpciB2YWxpZGl0eS4KICAgICAgICBjdHJsLiRtb2RlbFZhbHVlID0gYWxsVmFsaWQgPyBtb2RlbFZhbHVlIDogdW5kZWZpbmVkOwogICAgICAgIHdyaXRlVG9Nb2RlbElmTmVlZGVkKCk7CiAgICAgIH0KICAgIH0pOwoKICAgIGZ1bmN0aW9uIHdyaXRlVG9Nb2RlbElmTmVlZGVkKCkgewogICAgICBpZiAoY3RybC4kbW9kZWxWYWx1ZSAhPT0gcHJldk1vZGVsVmFsdWUpIHsKICAgICAgICBjdHJsLiQkd3JpdGVNb2RlbFRvU2NvcGUoKTsKICAgICAgfQogICAgfQogIH07CgogIHRoaXMuJCR3cml0ZU1vZGVsVG9TY29wZSA9IGZ1bmN0aW9uKCkgewogICAgbmdNb2RlbFNldChjdHJsLiRtb2RlbFZhbHVlKTsKICAgIGZvckVhY2goY3RybC4kdmlld0NoYW5nZUxpc3RlbmVycywgZnVuY3Rpb24obGlzdGVuZXIpIHsKICAgICAgdHJ5IHsKICAgICAgICBsaXN0ZW5lcigpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZpZXdWYWx1ZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVXBkYXRlIHRoZSB2aWV3IHZhbHVlLgogICAqCiAgICogVGhpcyBtZXRob2Qgc2hvdWxkIGJlIGNhbGxlZCB3aGVuIGFuIGlucHV0IGRpcmVjdGl2ZSB3YW50IHRvIGNoYW5nZSB0aGUgdmlldyB2YWx1ZTsgdHlwaWNhbGx5LAogICAqIHRoaXMgaXMgZG9uZSBmcm9tIHdpdGhpbiBhIERPTSBldmVudCBoYW5kbGVyLgogICAqCiAgICogRm9yIGV4YW1wbGUge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dH0gY2FsbHMgaXQgd2hlbiB0aGUgdmFsdWUgb2YgdGhlIGlucHV0IGNoYW5nZXMgYW5kCiAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpzZWxlY3Qgc2VsZWN0fSBjYWxscyBpdCB3aGVuIGFuIG9wdGlvbiBpcyBzZWxlY3RlZC4KICAgKgogICAqIElmIHRoZSBuZXcgYHZhbHVlYCBpcyBhbiBvYmplY3QgKHJhdGhlciB0aGFuIGEgc3RyaW5nIG9yIGEgbnVtYmVyKSwgd2Ugc2hvdWxkIG1ha2UgYSBjb3B5IG9mIHRoZQogICAqIG9iamVjdCBiZWZvcmUgcGFzc2luZyBpdCB0byBgJHNldFZpZXdWYWx1ZWAuICBUaGlzIGlzIGJlY2F1c2UgYG5nTW9kZWxgIGRvZXMgbm90IHBlcmZvcm0gYSBkZWVwCiAgICogd2F0Y2ggb2Ygb2JqZWN0cywgaXQgb25seSBsb29rcyBmb3IgYSBjaGFuZ2Ugb2YgaWRlbnRpdHkuIElmIHlvdSBvbmx5IGNoYW5nZSB0aGUgcHJvcGVydHkgb2YKICAgKiB0aGUgb2JqZWN0IHRoZW4gbmdNb2RlbCB3aWxsIG5vdCByZWFsaXNlIHRoYXQgdGhlIG9iamVjdCBoYXMgY2hhbmdlZCBhbmQgd2lsbCBub3QgaW52b2tlIHRoZQogICAqIGAkcGFyc2Vyc2AgYW5kIGAkdmFsaWRhdG9yc2AgcGlwZWxpbmVzLgogICAqCiAgICogRm9yIHRoaXMgcmVhc29uLCB5b3Ugc2hvdWxkIG5vdCBjaGFuZ2UgcHJvcGVydGllcyBvZiB0aGUgY29weSBvbmNlIGl0IGhhcyBiZWVuIHBhc3NlZCB0bwogICAqIGAkc2V0Vmlld1ZhbHVlYC4gT3RoZXJ3aXNlIHlvdSBtYXkgY2F1c2UgdGhlIG1vZGVsIHZhbHVlIG9uIHRoZSBzY29wZSB0byBjaGFuZ2UgaW5jb3JyZWN0bHkuCiAgICoKICAgKiBXaGVuIHRoaXMgbWV0aG9kIGlzIGNhbGxlZCwgdGhlIG5ldyBgdmFsdWVgIHdpbGwgYmUgc3RhZ2VkIGZvciBjb21taXR0aW5nIHRocm91Z2ggdGhlIGAkcGFyc2Vyc2AKICAgKiBhbmQgYCR2YWxpZGF0b3JzYCBwaXBlbGluZXMuIElmIHRoZXJlIGFyZSBubyBzcGVjaWFsIHtAbGluayBuZ01vZGVsT3B0aW9uc30gc3BlY2lmaWVkIHRoZW4gdGhlIHN0YWdlZAogICAqIHZhbHVlIHNlbnQgZGlyZWN0bHkgZm9yIHByb2Nlc3NpbmcsIGZpbmFsbHkgdG8gYmUgYXBwbGllZCB0byBgJG1vZGVsVmFsdWVgIGFuZCB0aGVuIHRoZQogICAqICoqZXhwcmVzc2lvbioqIHNwZWNpZmllZCBpbiB0aGUgYG5nLW1vZGVsYCBhdHRyaWJ1dGUuCiAgICoKICAgKiBMYXN0bHksIGFsbCB0aGUgcmVnaXN0ZXJlZCBjaGFuZ2UgbGlzdGVuZXJzLCBpbiB0aGUgYCR2aWV3Q2hhbmdlTGlzdGVuZXJzYCBsaXN0LCBhcmUgY2FsbGVkLgogICAqCiAgICogSW4gY2FzZSB0aGUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ01vZGVsT3B0aW9ucyBuZ01vZGVsT3B0aW9uc30gZGlyZWN0aXZlIGlzIHVzZWQgd2l0aCBgdXBkYXRlT25gCiAgICogYW5kIHRoZSBgZGVmYXVsdGAgdHJpZ2dlciBpcyBub3QgbGlzdGVkLCBhbGwgdGhvc2UgYWN0aW9ucyB3aWxsIHJlbWFpbiBwZW5kaW5nIHVudGlsIG9uZSBvZiB0aGUKICAgKiBgdXBkYXRlT25gIGV2ZW50cyBpcyB0cmlnZ2VyZWQgb24gdGhlIERPTSBlbGVtZW50LgogICAqIEFsbCB0aGVzZSBhY3Rpb25zIHdpbGwgYmUgZGVib3VuY2VkIGlmIHRoZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nTW9kZWxPcHRpb25zIG5nTW9kZWxPcHRpb25zfQogICAqIGRpcmVjdGl2ZSBpcyB1c2VkIHdpdGggYSBjdXN0b20gZGVib3VuY2UgZm9yIHRoaXMgcGFydGljdWxhciBldmVudC4KICAgKgogICAqIE5vdGUgdGhhdCBjYWxsaW5nIHRoaXMgZnVuY3Rpb24gZG9lcyBub3QgdHJpZ2dlciBhIGAkZGlnZXN0YC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSBmcm9tIHRoZSB2aWV3LgogICAqIEBwYXJhbSB7c3RyaW5nfSB0cmlnZ2VyIEV2ZW50IHRoYXQgdHJpZ2dlcmVkIHRoZSB1cGRhdGUuCiAgICovCiAgdGhpcy4kc2V0Vmlld1ZhbHVlID0gZnVuY3Rpb24odmFsdWUsIHRyaWdnZXIpIHsKICAgIGN0cmwuJHZpZXdWYWx1ZSA9IHZhbHVlOwogICAgaWYgKCFjdHJsLiRvcHRpb25zIHx8IGN0cmwuJG9wdGlvbnMudXBkYXRlT25EZWZhdWx0KSB7CiAgICAgIGN0cmwuJCRkZWJvdW5jZVZpZXdWYWx1ZUNvbW1pdCh0cmlnZ2VyKTsKICAgIH0KICB9OwoKICB0aGlzLiQkZGVib3VuY2VWaWV3VmFsdWVDb21taXQgPSBmdW5jdGlvbih0cmlnZ2VyKSB7CiAgICB2YXIgZGVib3VuY2VEZWxheSA9IDAsCiAgICAgICAgb3B0aW9ucyA9IGN0cmwuJG9wdGlvbnMsCiAgICAgICAgZGVib3VuY2U7CgogICAgaWYgKG9wdGlvbnMgJiYgaXNEZWZpbmVkKG9wdGlvbnMuZGVib3VuY2UpKSB7CiAgICAgIGRlYm91bmNlID0gb3B0aW9ucy5kZWJvdW5jZTsKICAgICAgaWYgKGlzTnVtYmVyKGRlYm91bmNlKSkgewogICAgICAgIGRlYm91bmNlRGVsYXkgPSBkZWJvdW5jZTsKICAgICAgfSBlbHNlIGlmIChpc051bWJlcihkZWJvdW5jZVt0cmlnZ2VyXSkpIHsKICAgICAgICBkZWJvdW5jZURlbGF5ID0gZGVib3VuY2VbdHJpZ2dlcl07CiAgICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIoZGVib3VuY2VbJ2RlZmF1bHQnXSkpIHsKICAgICAgICBkZWJvdW5jZURlbGF5ID0gZGVib3VuY2VbJ2RlZmF1bHQnXTsKICAgICAgfQogICAgfQoKICAgICR0aW1lb3V0LmNhbmNlbChwZW5kaW5nRGVib3VuY2UpOwogICAgaWYgKGRlYm91bmNlRGVsYXkpIHsKICAgICAgcGVuZGluZ0RlYm91bmNlID0gJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgY3RybC4kY29tbWl0Vmlld1ZhbHVlKCk7CiAgICAgIH0sIGRlYm91bmNlRGVsYXkpOwogICAgfSBlbHNlIGlmICgkcm9vdFNjb3BlLiQkcGhhc2UpIHsKICAgICAgY3RybC4kY29tbWl0Vmlld1ZhbHVlKCk7CiAgICB9IGVsc2UgewogICAgICAkc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgIGN0cmwuJGNvbW1pdFZpZXdWYWx1ZSgpOwogICAgICB9KTsKICAgIH0KICB9OwoKICAvLyBtb2RlbCAtPiB2YWx1ZQogIC8vIE5vdGU6IHdlIGNhbm5vdCB1c2UgYSBub3JtYWwgc2NvcGUuJHdhdGNoIGFzIHdlIHdhbnQgdG8gZGV0ZWN0IHRoZSBmb2xsb3dpbmc6CiAgLy8gMS4gc2NvcGUgdmFsdWUgaXMgJ2EnCiAgLy8gMi4gdXNlciBlbnRlcnMgJ2InCiAgLy8gMy4gbmctY2hhbmdlIGtpY2tzIGluIGFuZCByZXZlcnRzIHNjb3BlIHZhbHVlIHRvICdhJwogIC8vICAgIC0+IHNjb3BlIHZhbHVlIGRpZCBub3QgY2hhbmdlIHNpbmNlIHRoZSBsYXN0IGRpZ2VzdCBhcwogIC8vICAgICAgIG5nLWNoYW5nZSBleGVjdXRlcyBpbiBhcHBseSBwaGFzZQogIC8vIDQuIHZpZXcgc2hvdWxkIGJlIGNoYW5nZWQgYmFjayB0byAnYScKICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIG5nTW9kZWxXYXRjaCgpIHsKICAgIHZhciBtb2RlbFZhbHVlID0gbmdNb2RlbEdldCgpOwoKICAgIC8vIGlmIHNjb3BlIG1vZGVsIHZhbHVlIGFuZCBuZ01vZGVsIHZhbHVlIGFyZSBvdXQgb2Ygc3luYwogICAgLy8gVE9ETyhwZXJmKTogd2h5IG5vdCBtb3ZlIHRoaXMgdG8gdGhlIGFjdGlvbiBmbj8KICAgIGlmIChtb2RlbFZhbHVlICE9PSBjdHJsLiRtb2RlbFZhbHVlKSB7CiAgICAgIGN0cmwuJG1vZGVsVmFsdWUgPSBtb2RlbFZhbHVlOwoKICAgICAgdmFyIGZvcm1hdHRlcnMgPSBjdHJsLiRmb3JtYXR0ZXJzLAogICAgICAgICAgaWR4ID0gZm9ybWF0dGVycy5sZW5ndGg7CgogICAgICB2YXIgdmlld1ZhbHVlID0gbW9kZWxWYWx1ZTsKICAgICAgd2hpbGUoaWR4LS0pIHsKICAgICAgICB2aWV3VmFsdWUgPSBmb3JtYXR0ZXJzW2lkeF0odmlld1ZhbHVlKTsKICAgICAgfQogICAgICBpZiAoY3RybC4kdmlld1ZhbHVlICE9PSB2aWV3VmFsdWUpIHsKICAgICAgICBjdHJsLiR2aWV3VmFsdWUgPSBjdHJsLiQkbGFzdENvbW1pdHRlZFZpZXdWYWx1ZSA9IHZpZXdWYWx1ZTsKICAgICAgICBjdHJsLiRyZW5kZXIoKTsKCiAgICAgICAgY3RybC4kJHJ1blZhbGlkYXRvcnModW5kZWZpbmVkLCBtb2RlbFZhbHVlLCB2aWV3VmFsdWUsIG5vb3ApOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG1vZGVsVmFsdWU7CiAgfSk7Cn1dOwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nTW9kZWwKICoKICogQGVsZW1lbnQgaW5wdXQKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdNb2RlbGAgZGlyZWN0aXZlIGJpbmRzIGFuIGBpbnB1dGAsYHNlbGVjdGAsIGB0ZXh0YXJlYWAgKG9yIGN1c3RvbSBmb3JtIGNvbnRyb2wpIHRvIGEKICogcHJvcGVydHkgb24gdGhlIHNjb3BlIHVzaW5nIHtAbGluayBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIE5nTW9kZWxDb250cm9sbGVyfSwKICogd2hpY2ggaXMgY3JlYXRlZCBhbmQgZXhwb3NlZCBieSB0aGlzIGRpcmVjdGl2ZS4KICoKICogYG5nTW9kZWxgIGlzIHJlc3BvbnNpYmxlIGZvcjoKICoKICogLSBCaW5kaW5nIHRoZSB2aWV3IGludG8gdGhlIG1vZGVsLCB3aGljaCBvdGhlciBkaXJlY3RpdmVzIHN1Y2ggYXMgYGlucHV0YCwgYHRleHRhcmVhYCBvciBgc2VsZWN0YAogKiAgIHJlcXVpcmUuCiAqIC0gUHJvdmlkaW5nIHZhbGlkYXRpb24gYmVoYXZpb3IgKGkuZS4gcmVxdWlyZWQsIG51bWJlciwgZW1haWwsIHVybCkuCiAqIC0gS2VlcGluZyB0aGUgc3RhdGUgb2YgdGhlIGNvbnRyb2wgKHZhbGlkL2ludmFsaWQsIGRpcnR5L3ByaXN0aW5lLCB0b3VjaGVkL3VudG91Y2hlZCwgdmFsaWRhdGlvbiBlcnJvcnMpLgogKiAtIFNldHRpbmcgcmVsYXRlZCBjc3MgY2xhc3NlcyBvbiB0aGUgZWxlbWVudCAoYG5nLXZhbGlkYCwgYG5nLWludmFsaWRgLCBgbmctZGlydHlgLCBgbmctcHJpc3RpbmVgLCBgbmctdG91Y2hlZGAsIGBuZy11bnRvdWNoZWRgKSBpbmNsdWRpbmcgYW5pbWF0aW9ucy4KICogLSBSZWdpc3RlcmluZyB0aGUgY29udHJvbCB3aXRoIGl0cyBwYXJlbnQge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtIGZvcm19LgogKgogKiBOb3RlOiBgbmdNb2RlbGAgd2lsbCB0cnkgdG8gYmluZCB0byB0aGUgcHJvcGVydHkgZ2l2ZW4gYnkgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbiBvbiB0aGUKICogY3VycmVudCBzY29wZS4gSWYgdGhlIHByb3BlcnR5IGRvZXNuJ3QgYWxyZWFkeSBleGlzdCBvbiB0aGlzIHNjb3BlLCBpdCB3aWxsIGJlIGNyZWF0ZWQKICogaW1wbGljaXRseSBhbmQgYWRkZWQgdG8gdGhlIHNjb3BlLgogKgogKiBGb3IgYmVzdCBwcmFjdGljZXMgb24gdXNpbmcgYG5nTW9kZWxgLCBzZWU6CiAqCiAqICAtIFtodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL3dpa2kvVW5kZXJzdGFuZGluZy1TY29wZXNdCiAqCiAqIEZvciBiYXNpYyBleGFtcGxlcywgaG93IHRvIHVzZSBgbmdNb2RlbGAsIHNlZToKICoKICogIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dH0KICogICAgLSB7QGxpbmsgaW5wdXRbdGV4dF0gdGV4dH0KICogICAgLSB7QGxpbmsgaW5wdXRbY2hlY2tib3hdIGNoZWNrYm94fQogKiAgICAtIHtAbGluayBpbnB1dFtyYWRpb10gcmFkaW99CiAqICAgIC0ge0BsaW5rIGlucHV0W251bWJlcl0gbnVtYmVyfQogKiAgICAtIHtAbGluayBpbnB1dFtlbWFpbF0gZW1haWx9CiAqICAgIC0ge0BsaW5rIGlucHV0W3VybF0gdXJsfQogKiAgICAtIHtAbGluayBpbnB1dFtkYXRlXSBkYXRlfQogKiAgICAtIHtAbGluayBpbnB1dFtkYXRlVGltZUxvY2FsXSBkYXRlVGltZUxvY2FsfQogKiAgICAtIHtAbGluayBpbnB1dFt0aW1lXSB0aW1lfQogKiAgICAtIHtAbGluayBpbnB1dFttb250aF0gbW9udGh9CiAqICAgIC0ge0BsaW5rIGlucHV0W3dlZWtdIHdlZWt9CiAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6c2VsZWN0IHNlbGVjdH0KICogIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTp0ZXh0YXJlYSB0ZXh0YXJlYX0KICoKICogIyBDU1MgY2xhc3NlcwogKiBUaGUgZm9sbG93aW5nIENTUyBjbGFzc2VzIGFyZSBhZGRlZCBhbmQgcmVtb3ZlZCBvbiB0aGUgYXNzb2NpYXRlZCBpbnB1dC9zZWxlY3QvdGV4dGFyZWEgZWxlbWVudAogKiBkZXBlbmRpbmcgb24gdGhlIHZhbGlkaXR5IG9mIHRoZSBtb2RlbC4KICoKICogIC0gYG5nLXZhbGlkYCBpcyBzZXQgaWYgdGhlIG1vZGVsIGlzIHZhbGlkLgogKiAgLSBgbmctaW52YWxpZGAgaXMgc2V0IGlmIHRoZSBtb2RlbCBpcyBpbnZhbGlkLgogKiAgLSBgbmctcHJpc3RpbmVgIGlzIHNldCBpZiB0aGUgbW9kZWwgaXMgcHJpc3RpbmUuCiAqICAtIGBuZy1kaXJ0eWAgaXMgc2V0IGlmIHRoZSBtb2RlbCBpcyBkaXJ0eS4KICoKICogS2VlcCBpbiBtaW5kIHRoYXQgbmdBbmltYXRlIGNhbiBkZXRlY3QgZWFjaCBvZiB0aGVzZSBjbGFzc2VzIHdoZW4gYWRkZWQgYW5kIHJlbW92ZWQuCiAqCiAqICMjIEFuaW1hdGlvbiBIb29rcwogKgogKiBBbmltYXRpb25zIHdpdGhpbiBtb2RlbHMgYXJlIHRyaWdnZXJlZCB3aGVuIGFueSBvZiB0aGUgYXNzb2NpYXRlZCBDU1MgY2xhc3NlcyBhcmUgYWRkZWQgYW5kIHJlbW92ZWQKICogb24gdGhlIGlucHV0IGVsZW1lbnQgd2hpY2ggaXMgYXR0YWNoZWQgdG8gdGhlIG1vZGVsLiBUaGVzZSBjbGFzc2VzIGFyZTogYC5uZy1wcmlzdGluZWAsIGAubmctZGlydHlgLAogKiBgLm5nLWludmFsaWRgIGFuZCBgLm5nLXZhbGlkYCBhcyB3ZWxsIGFzIGFueSBvdGhlciB2YWxpZGF0aW9ucyB0aGF0IGFyZSBwZXJmb3JtZWQgb24gdGhlIG1vZGVsIGl0c2VsZi4KICogVGhlIGFuaW1hdGlvbnMgdGhhdCBhcmUgdHJpZ2dlcmVkIHdpdGhpbiBuZ01vZGVsIGFyZSBzaW1pbGFyIHRvIGhvdyB0aGV5IHdvcmsgaW4gbmdDbGFzcyBhbmQKICogYW5pbWF0aW9ucyBjYW4gYmUgaG9va2VkIGludG8gdXNpbmcgQ1NTIHRyYW5zaXRpb25zLCBrZXlmcmFtZXMgYXMgd2VsbCBhcyBKUyBhbmltYXRpb25zLgogKgogKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgc2hvd3MgYSBzaW1wbGUgd2F5IHRvIHV0aWxpemUgQ1NTIHRyYW5zaXRpb25zIHRvIHN0eWxlIGFuIGlucHV0IGVsZW1lbnQKICogdGhhdCBoYXMgYmVlbiByZW5kZXJlZCBhcyBpbnZhbGlkIGFmdGVyIGl0IGhhcyBiZWVuIHZhbGlkYXRlZDoKICoKICogPHByZT4KICogLy9iZSBzdXJlIHRvIGluY2x1ZGUgbmdBbmltYXRlIGFzIGEgbW9kdWxlIHRvIGhvb2sgaW50byBtb3JlCiAqIC8vYWR2YW5jZWQgYW5pbWF0aW9ucwogKiAubXktaW5wdXQgewogKiAgIHRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogKiAgIGJhY2tncm91bmQ6IHdoaXRlOwogKiB9CiAqIC5teS1pbnB1dC5uZy1pbnZhbGlkIHsKICogICBiYWNrZ3JvdW5kOiByZWQ7CiAqICAgY29sb3I6d2hpdGU7CiAqIH0KICogPC9wcmU+CiAqCiAqIEBleGFtcGxlCiAqIDxleGFtcGxlIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSIgZml4QmFzZT0idHJ1ZSIgbW9kdWxlPSJpbnB1dEV4YW1wbGUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICBhbmd1bGFyLm1vZHVsZSgnaW5wdXRFeGFtcGxlJywgW10pCiAgICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAkc2NvcGUudmFsID0gJzEnOwogICAgICAgICAgfV0pOwogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8c3R5bGU+CiAgICAgICAgIC5teS1pbnB1dCB7CiAgICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgICB0cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICAgICAgICAgfQogICAgICAgICAubXktaW5wdXQubmctaW52YWxpZCB7CiAgICAgICAgICAgY29sb3I6d2hpdGU7CiAgICAgICAgICAgYmFja2dyb3VuZDogcmVkOwogICAgICAgICB9CiAgICAgICA8L3N0eWxlPgogICAgICAgVXBkYXRlIGlucHV0IHRvIHNlZSB0cmFuc2l0aW9ucyB3aGVuIHZhbGlkL2ludmFsaWQuCiAgICAgICBJbnRlZ2VyIGlzIGEgdmFsaWQgdmFsdWUuCiAgICAgICA8Zm9ybSBuYW1lPSJ0ZXN0Rm9ybSIgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgICA8aW5wdXQgbmctbW9kZWw9InZhbCIgbmctcGF0dGVybj0iL15cZCskLyIgbmFtZT0iYW5pbSIgY2xhc3M9Im15LWlucHV0IiAvPgogICAgICAgPC9mb3JtPgogICAgIDwvZmlsZT4KICogPC9leGFtcGxlPgogKgogKiAjIyBCaW5kaW5nIHRvIGEgZ2V0dGVyL3NldHRlcgogKgogKiBTb21ldGltZXMgaXQncyBoZWxwZnVsIHRvIGJpbmQgYG5nTW9kZWxgIHRvIGEgZ2V0dGVyL3NldHRlciBmdW5jdGlvbi4gIEEgZ2V0dGVyL3NldHRlciBpcyBhCiAqIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBtb2RlbCB3aGVuIGNhbGxlZCB3aXRoIHplcm8gYXJndW1lbnRzLCBhbmQgc2V0cwogKiB0aGUgaW50ZXJuYWwgc3RhdGUgb2YgYSBtb2RlbCB3aGVuIGNhbGxlZCB3aXRoIGFuIGFyZ3VtZW50LiBJdCdzIHNvbWV0aW1lcyB1c2VmdWwgdG8gdXNlIHRoaXMKICogZm9yIG1vZGVscyB0aGF0IGhhdmUgYW4gaW50ZXJuYWwgcmVwcmVzZW50YXRpb24gdGhhdCdzIGRpZmZlcmVudCB0aGFuIHdoYXQgdGhlIG1vZGVsIGV4cG9zZXMKICogdG8gdGhlIHZpZXcuCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXN1Y2Nlc3MiPgogKiAqKkJlc3QgUHJhY3RpY2U6KiogSXQncyBiZXN0IHRvIGtlZXAgZ2V0dGVycyBmYXN0IGJlY2F1c2UgQW5ndWxhciBpcyBsaWtlbHkgdG8gY2FsbCB0aGVtIG1vcmUKICogZnJlcXVlbnRseSB0aGFuIG90aGVyIHBhcnRzIG9mIHlvdXIgY29kZS4KICogPC9kaXY+CiAqCiAqIFlvdSB1c2UgdGhpcyBiZWhhdmlvciBieSBhZGRpbmcgYG5nLW1vZGVsLW9wdGlvbnM9InsgZ2V0dGVyU2V0dGVyOiB0cnVlIH0iYCB0byBhbiBlbGVtZW50IHRoYXQKICogaGFzIGBuZy1tb2RlbGAgYXR0YWNoZWQgdG8gaXQuIFlvdSBjYW4gYWxzbyBhZGQgYG5nLW1vZGVsLW9wdGlvbnM9InsgZ2V0dGVyU2V0dGVyOiB0cnVlIH0iYCB0bwogKiBhIGA8Zm9ybT5gLCB3aGljaCB3aWxsIGVuYWJsZSB0aGlzIGJlaGF2aW9yIGZvciBhbGwgYDxpbnB1dD5gcyB3aXRoaW4gaXQuIFNlZQogKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nTW9kZWxPcHRpb25zIGBuZ01vZGVsT3B0aW9uc2B9IGZvciBtb3JlLgogKgogKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgc2hvd3MgaG93IHRvIHVzZSBgbmdNb2RlbGAgd2l0aCBhIGdldHRlci9zZXR0ZXI6CiAqCiAqIEBleGFtcGxlCiAqIDxleGFtcGxlIG5hbWU9Im5nTW9kZWwtZ2V0dGVyLXNldHRlciIgbW9kdWxlPSJnZXR0ZXJTZXR0ZXJFeGFtcGxlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgICA8Zm9ybSBuYW1lPSJ1c2VyRm9ybSI+CiAgICAgICAgICAgTmFtZToKICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idXNlck5hbWUiCiAgICAgICAgICAgICAgICAgIG5nLW1vZGVsPSJ1c2VyLm5hbWUiCiAgICAgICAgICAgICAgICAgIG5nLW1vZGVsLW9wdGlvbnM9InsgZ2V0dGVyU2V0dGVyOiB0cnVlIH0iIC8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPHByZT51c2VyLm5hbWUgPSA8c3BhbiBuZy1iaW5kPSJ1c2VyLm5hbWUoKSI+PC9zcGFuPjwvcHJlPgogICAgICAgPC9kaXY+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9ImFwcC5qcyI+CiAgICAgICBhbmd1bGFyLm1vZHVsZSgnZ2V0dGVyU2V0dGVyRXhhbXBsZScsIFtdKQogICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgIHZhciBfbmFtZSA9ICdCcmlhbic7CiAgICAgICAgICAgJHNjb3BlLnVzZXIgPSB7CiAgICAgICAgICAgICBuYW1lOiBmdW5jdGlvbiAobmV3TmFtZSkgewogICAgICAgICAgICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQobmV3TmFtZSkpIHsKICAgICAgICAgICAgICAgICBfbmFtZSA9IG5ld05hbWU7CiAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgcmV0dXJuIF9uYW1lOwogICAgICAgICAgICAgfQogICAgICAgICAgIH07CiAgICAgICAgIH1dKTsKICAgICA8L2ZpbGU+CiAqIDwvZXhhbXBsZT4KICovCnZhciBuZ01vZGVsRGlyZWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnQScsCiAgICByZXF1aXJlOiBbJ25nTW9kZWwnLCAnXj9mb3JtJywgJ14/bmdNb2RlbE9wdGlvbnMnXSwKICAgIGNvbnRyb2xsZXI6IE5nTW9kZWxDb250cm9sbGVyLAogICAgLy8gUHJlbGluayBuZWVkcyB0byBydW4gYmVmb3JlIGFueSBpbnB1dCBkaXJlY3RpdmUKICAgIC8vIHNvIHRoYXQgd2UgY2FuIHNldCB0aGUgTmdNb2RlbE9wdGlvbnMgaW4gTmdNb2RlbENvbnRyb2xsZXIKICAgIC8vIGJlZm9yZSBhbnlvbmUgZWxzZSB1c2VzIGl0LgogICAgcHJpb3JpdHk6IDEsCiAgICBjb21waWxlOiBmdW5jdGlvbiBuZ01vZGVsQ29tcGlsZShlbGVtZW50KSB7CiAgICAgIC8vIFNldHVwIGluaXRpYWwgc3RhdGUgb2YgdGhlIGNvbnRyb2wKICAgICAgZWxlbWVudC5hZGRDbGFzcyhQUklTVElORV9DTEFTUykuYWRkQ2xhc3MoVU5UT1VDSEVEX0NMQVNTKS5hZGRDbGFzcyhWQUxJRF9DTEFTUyk7CgogICAgICByZXR1cm4gewogICAgICAgIHByZTogZnVuY3Rpb24gbmdNb2RlbFByZUxpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmxzKSB7CiAgICAgICAgICB2YXIgbW9kZWxDdHJsID0gY3RybHNbMF0sCiAgICAgICAgICAgICAgZm9ybUN0cmwgPSBjdHJsc1sxXSB8fCBudWxsRm9ybUN0cmw7CgogICAgICAgICAgbW9kZWxDdHJsLiQkc2V0T3B0aW9ucyhjdHJsc1syXSAmJiBjdHJsc1syXS4kb3B0aW9ucyk7CgogICAgICAgICAgLy8gbm90aWZ5IG90aGVycywgZXNwZWNpYWxseSBwYXJlbnQgZm9ybXMKICAgICAgICAgIGZvcm1DdHJsLiRhZGRDb250cm9sKG1vZGVsQ3RybCk7CgogICAgICAgICAgYXR0ci4kb2JzZXJ2ZSgnbmFtZScsIGZ1bmN0aW9uKG5ld1ZhbHVlKSB7CiAgICAgICAgICAgIGlmIChtb2RlbEN0cmwuJG5hbWUgIT09IG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgZm9ybUN0cmwuJCRyZW5hbWVDb250cm9sKG1vZGVsQ3RybCwgbmV3VmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGZvcm1DdHJsLiRyZW1vdmVDb250cm9sKG1vZGVsQ3RybCk7CiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIHBvc3Q6IGZ1bmN0aW9uIG5nTW9kZWxQb3N0TGluayhzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybHMpIHsKICAgICAgICAgIHZhciBtb2RlbEN0cmwgPSBjdHJsc1swXTsKICAgICAgICAgIGlmIChtb2RlbEN0cmwuJG9wdGlvbnMgJiYgbW9kZWxDdHJsLiRvcHRpb25zLnVwZGF0ZU9uKSB7CiAgICAgICAgICAgIGVsZW1lbnQub24obW9kZWxDdHJsLiRvcHRpb25zLnVwZGF0ZU9uLCBmdW5jdGlvbihldikgewogICAgICAgICAgICAgIG1vZGVsQ3RybC4kJGRlYm91bmNlVmlld1ZhbHVlQ29tbWl0KGV2ICYmIGV2LnR5cGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBlbGVtZW50Lm9uKCdibHVyJywgZnVuY3Rpb24oZXYpIHsKICAgICAgICAgICAgaWYgKG1vZGVsQ3RybC4kdG91Y2hlZCkgcmV0dXJuOwoKICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIG1vZGVsQ3RybC4kc2V0VG91Y2hlZCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9Owp9OwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQ2hhbmdlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBFdmFsdWF0ZSB0aGUgZ2l2ZW4gZXhwcmVzc2lvbiB3aGVuIHRoZSB1c2VyIGNoYW5nZXMgdGhlIGlucHV0LgogKiBUaGUgZXhwcmVzc2lvbiBpcyBldmFsdWF0ZWQgaW1tZWRpYXRlbHksIHVubGlrZSB0aGUgSmF2YVNjcmlwdCBvbmNoYW5nZSBldmVudAogKiB3aGljaCBvbmx5IHRyaWdnZXJzIGF0IHRoZSBlbmQgb2YgYSBjaGFuZ2UgKHVzdWFsbHksIHdoZW4gdGhlIHVzZXIgbGVhdmVzIHRoZQogKiBmb3JtIGVsZW1lbnQgb3IgcHJlc3NlcyB0aGUgcmV0dXJuIGtleSkuCiAqCiAqIFRoZSBgbmdDaGFuZ2VgIGV4cHJlc3Npb24gaXMgb25seSBldmFsdWF0ZWQgd2hlbiBhIGNoYW5nZSBpbiB0aGUgaW5wdXQgdmFsdWUgY2F1c2VzCiAqIGEgbmV3IHZhbHVlIHRvIGJlIGNvbW1pdHRlZCB0byB0aGUgbW9kZWwuCiAqCiAqIEl0IHdpbGwgbm90IGJlIGV2YWx1YXRlZDoKICogKiBpZiB0aGUgdmFsdWUgcmV0dXJuZWQgZnJvbSB0aGUgYCRwYXJzZXJzYCB0cmFuc2Zvcm1hdGlvbiBwaXBlbGluZSBoYXMgbm90IGNoYW5nZWQKICogKiBpZiB0aGUgaW5wdXQgaGFzIGNvbnRpbnVlZCB0byBiZSBpbnZhbGlkIHNpbmNlIHRoZSBtb2RlbCB3aWxsIHN0YXkgYG51bGxgCiAqICogaWYgdGhlIG1vZGVsIGlzIGNoYW5nZWQgcHJvZ3JhbW1hdGljYWxseSBhbmQgbm90IGJ5IGEgY2hhbmdlIHRvIHRoZSBpbnB1dCB2YWx1ZQogKgogKgogKiBOb3RlLCB0aGlzIGRpcmVjdGl2ZSByZXF1aXJlcyBgbmdNb2RlbGAgdG8gYmUgcHJlc2VudC4KICoKICogQGVsZW1lbnQgaW5wdXQKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NoYW5nZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uIGNoYW5nZQogKiBpbiBpbnB1dCB2YWx1ZS4KICoKICogQGV4YW1wbGUKICogPGV4YW1wbGUgbmFtZT0ibmdDaGFuZ2UtZGlyZWN0aXZlIiBtb2R1bGU9ImNoYW5nZUV4YW1wbGUiPgogKiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogKiAgICAgPHNjcmlwdD4KICogICAgICAgYW5ndWxhci5tb2R1bGUoJ2NoYW5nZUV4YW1wbGUnLCBbXSkKICogICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogKiAgICAgICAgICAgJHNjb3BlLmNvdW50ZXIgPSAwOwogKiAgICAgICAgICAgJHNjb3BlLmNoYW5nZSA9IGZ1bmN0aW9uKCkgewogKiAgICAgICAgICAgICAkc2NvcGUuY291bnRlcisrOwogKiAgICAgICAgICAgfTsKICogICAgICAgICB9XSk7CiAqICAgICA8L3NjcmlwdD4KICogICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogKiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjb25maXJtZWQiIG5nLWNoYW5nZT0iY2hhbmdlKCkiIGlkPSJuZy1jaGFuZ2UtZXhhbXBsZTEiIC8+CiAqICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNvbmZpcm1lZCIgaWQ9Im5nLWNoYW5nZS1leGFtcGxlMiIgLz4KICogICAgICAgPGxhYmVsIGZvcj0ibmctY2hhbmdlLWV4YW1wbGUyIj5Db25maXJtZWQ8L2xhYmVsPjxiciAvPgogKiAgICAgICA8dHQ+ZGVidWcgPSB7e2NvbmZpcm1lZH19PC90dD48YnIvPgogKiAgICAgICA8dHQ+Y291bnRlciA9IHt7Y291bnRlcn19PC90dD48YnIvPgogKiAgICAgPC9kaXY+CiAqICAgPC9maWxlPgogKiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogKiAgICAgdmFyIGNvdW50ZXIgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ2NvdW50ZXInKSk7CiAqICAgICB2YXIgZGVidWcgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ2NvbmZpcm1lZCcpKTsKICoKICogICAgIGl0KCdzaG91bGQgZXZhbHVhdGUgdGhlIGV4cHJlc3Npb24gaWYgY2hhbmdpbmcgZnJvbSB2aWV3JywgZnVuY3Rpb24oKSB7CiAqICAgICAgIGV4cGVjdChjb3VudGVyLmdldFRleHQoKSkudG9Db250YWluKCcwJyk7CiAqCiAqICAgICAgIGVsZW1lbnQoYnkuaWQoJ25nLWNoYW5nZS1leGFtcGxlMScpKS5jbGljaygpOwogKgogKiAgICAgICBleHBlY3QoY291bnRlci5nZXRUZXh0KCkpLnRvQ29udGFpbignMScpOwogKiAgICAgICBleHBlY3QoZGVidWcuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICogICAgIH0pOwogKgogKiAgICAgaXQoJ3Nob3VsZCBub3QgZXZhbHVhdGUgdGhlIGV4cHJlc3Npb24gaWYgY2hhbmdpbmcgZnJvbSBtb2RlbCcsIGZ1bmN0aW9uKCkgewogKiAgICAgICBlbGVtZW50KGJ5LmlkKCduZy1jaGFuZ2UtZXhhbXBsZTInKSkuY2xpY2soKTsKCiAqICAgICAgIGV4cGVjdChjb3VudGVyLmdldFRleHQoKSkudG9Db250YWluKCcwJyk7CiAqICAgICAgIGV4cGVjdChkZWJ1Zy5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogKiAgICAgfSk7CiAqICAgPC9maWxlPgogKiA8L2V4YW1wbGU+CiAqLwp2YXIgbmdDaGFuZ2VEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICByZXN0cmljdDogJ0EnLAogIHJlcXVpcmU6ICduZ01vZGVsJywKICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgY3RybC4kdmlld0NoYW5nZUxpc3RlbmVycy5wdXNoKGZ1bmN0aW9uKCkgewogICAgICBzY29wZS4kZXZhbChhdHRyLm5nQ2hhbmdlKTsKICAgIH0pOwogIH0KfSk7CgoKdmFyIHJlcXVpcmVkRGlyZWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnQScsCiAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsbSwgYXR0ciwgY3RybCkgewogICAgICBpZiAoIWN0cmwpIHJldHVybjsKICAgICAgYXR0ci5yZXF1aXJlZCA9IHRydWU7IC8vIGZvcmNlIHRydXRoeSBpbiBjYXNlIHdlIGFyZSBvbiBub24gaW5wdXQgZWxlbWVudAoKICAgICAgY3RybC4kdmFsaWRhdG9ycy5yZXF1aXJlZCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuICFhdHRyLnJlcXVpcmVkIHx8ICFjdHJsLiRpc0VtcHR5KHZhbHVlKTsKICAgICAgfTsKCiAgICAgIGF0dHIuJG9ic2VydmUoJ3JlcXVpcmVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgY3RybC4kdmFsaWRhdGUoKTsKICAgICAgfSk7CiAgICB9CiAgfTsKfTsKCgp2YXIgcGF0dGVybkRpcmVjdGl2ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbG0sIGF0dHIsIGN0cmwpIHsKICAgICAgaWYgKCFjdHJsKSByZXR1cm47CgogICAgICB2YXIgcmVnZXhwLCBwYXR0ZXJuRXhwID0gYXR0ci5uZ1BhdHRlcm4gfHwgYXR0ci5wYXR0ZXJuOwogICAgICBhdHRyLiRvYnNlcnZlKCdwYXR0ZXJuJywgZnVuY3Rpb24ocmVnZXgpIHsKICAgICAgICBpZiAoaXNTdHJpbmcocmVnZXgpICYmIHJlZ2V4Lmxlbmd0aCA+IDApIHsKICAgICAgICAgIHJlZ2V4ID0gbmV3IFJlZ0V4cChyZWdleCk7CiAgICAgICAgfQoKICAgICAgICBpZiAocmVnZXggJiYgIXJlZ2V4LnRlc3QpIHsKICAgICAgICAgIHRocm93IG1pbkVycignbmdQYXR0ZXJuJykoJ25vcmVnZXhwJywKICAgICAgICAgICAgJ0V4cGVjdGVkIHswfSB0byBiZSBhIFJlZ0V4cCBidXQgd2FzIHsxfS4gRWxlbWVudDogezJ9JywgcGF0dGVybkV4cCwKICAgICAgICAgICAgcmVnZXgsIHN0YXJ0aW5nVGFnKGVsbSkpOwogICAgICAgIH0KCiAgICAgICAgcmVnZXhwID0gcmVnZXggfHwgdW5kZWZpbmVkOwogICAgICAgIGN0cmwuJHZhbGlkYXRlKCk7CiAgICAgIH0pOwoKICAgICAgY3RybC4kdmFsaWRhdG9ycy5wYXR0ZXJuID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgaXNVbmRlZmluZWQocmVnZXhwKSB8fCByZWdleHAudGVzdCh2YWx1ZSk7CiAgICAgIH07CiAgICB9CiAgfTsKfTsKCgp2YXIgbWF4bGVuZ3RoRGlyZWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnQScsCiAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsbSwgYXR0ciwgY3RybCkgewogICAgICBpZiAoIWN0cmwpIHJldHVybjsKCiAgICAgIHZhciBtYXhsZW5ndGggPSAwOwogICAgICBhdHRyLiRvYnNlcnZlKCdtYXhsZW5ndGgnLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIG1heGxlbmd0aCA9IGludCh2YWx1ZSkgfHwgMDsKICAgICAgICBjdHJsLiR2YWxpZGF0ZSgpOwogICAgICB9KTsKICAgICAgY3RybC4kdmFsaWRhdG9ycy5tYXhsZW5ndGggPSBmdW5jdGlvbihtb2RlbFZhbHVlLCB2aWV3VmFsdWUpIHsKICAgICAgICByZXR1cm4gY3RybC4kaXNFbXB0eShtb2RlbFZhbHVlKSB8fCB2aWV3VmFsdWUubGVuZ3RoIDw9IG1heGxlbmd0aDsKICAgICAgfTsKICAgIH0KICB9Owp9OwoKdmFyIG1pbmxlbmd0aERpcmVjdGl2ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbG0sIGF0dHIsIGN0cmwpIHsKICAgICAgaWYgKCFjdHJsKSByZXR1cm47CgogICAgICB2YXIgbWlubGVuZ3RoID0gMDsKICAgICAgYXR0ci4kb2JzZXJ2ZSgnbWlubGVuZ3RoJywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBtaW5sZW5ndGggPSBpbnQodmFsdWUpIHx8IDA7CiAgICAgICAgY3RybC4kdmFsaWRhdGUoKTsKICAgICAgfSk7CiAgICAgIGN0cmwuJHZhbGlkYXRvcnMubWlubGVuZ3RoID0gZnVuY3Rpb24obW9kZWxWYWx1ZSwgdmlld1ZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGN0cmwuJGlzRW1wdHkobW9kZWxWYWx1ZSkgfHwgdmlld1ZhbHVlLmxlbmd0aCA+PSBtaW5sZW5ndGg7CiAgICAgIH07CiAgICB9CiAgfTsKfTsKCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0xpc3QKICoKICogQGRlc2NyaXB0aW9uCiAqIFRleHQgaW5wdXQgdGhhdCBjb252ZXJ0cyBiZXR3ZWVuIGEgZGVsaW1pdGVkIHN0cmluZyBhbmQgYW4gYXJyYXkgb2Ygc3RyaW5ncy4gVGhlIGRlZmF1bHQKICogZGVsaW1pdGVyIGlzIGEgY29tbWEgZm9sbG93ZWQgYnkgYSBzcGFjZSAtIGVxdWl2YWxlbnQgdG8gYG5nLWxpc3Q9IiwgImAuIFlvdSBjYW4gc3BlY2lmeSBhIGN1c3RvbQogKiBkZWxpbWl0ZXIgYXMgdGhlIHZhbHVlIG9mIHRoZSBgbmdMaXN0YCBhdHRyaWJ1dGUgLSBmb3IgZXhhbXBsZSwgYG5nLWxpc3Q9IiB8ICJgLgogKgogKiBUaGUgYmVoYXZpb3VyIG9mIHRoZSBkaXJlY3RpdmUgaXMgYWZmZWN0ZWQgYnkgdGhlIHVzZSBvZiB0aGUgYG5nVHJpbWAgYXR0cmlidXRlLgogKiAqIElmIGBuZ1RyaW1gIGlzIHNldCB0byBgImZhbHNlImAgdGhlbiB3aGl0ZXNwYWNlIGFyb3VuZCBib3RoIHRoZSBzZXBhcmF0b3IgYW5kIGVhY2gKICogICBsaXN0IGl0ZW0gaXMgcmVzcGVjdGVkLiBUaGlzIGltcGxpZXMgdGhhdCB0aGUgdXNlciBvZiB0aGUgZGlyZWN0aXZlIGlzIHJlc3BvbnNpYmxlIGZvcgogKiAgIGRlYWxpbmcgd2l0aCB3aGl0ZXNwYWNlIGJ1dCBhbHNvIGFsbG93cyB5b3UgdG8gdXNlIHdoaXRlc3BhY2UgYXMgYSBkZWxpbWl0ZXIsIHN1Y2ggYXMgYQogKiAgIHRhYiBvciBuZXdsaW5lIGNoYXJhY3Rlci4KICogKiBPdGhlcndpc2Ugd2hpdGVzcGFjZSBhcm91bmQgdGhlIGRlbGltaXRlciBpcyBpZ25vcmVkIHdoZW4gc3BsaXR0aW5nIChhbHRob3VnaCBpdCBpcyByZXNwZWN0ZWQKICogICB3aGVuIGpvaW5pbmcgdGhlIGxpc3QgaXRlbXMgYmFjayB0b2dldGhlcikgYW5kIHdoaXRlc3BhY2UgYXJvdW5kIGVhY2ggbGlzdCBpdGVtIGlzIHN0cmlwcGVkCiAqICAgYmVmb3JlIGl0IGlzIGFkZGVkIHRvIHRoZSBtb2RlbC4KICoKICogIyMjIEV4YW1wbGUgd2l0aCBWYWxpZGF0aW9uCiAqCiAqIDxleGFtcGxlIG5hbWU9Im5nTGlzdC1kaXJlY3RpdmUiIG1vZHVsZT0ibGlzdEV4YW1wbGUiPgogKiAgIDxmaWxlIG5hbWU9ImFwcC5qcyI+CiAqICAgICAgYW5ndWxhci5tb2R1bGUoJ2xpc3RFeGFtcGxlJywgW10pCiAqICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogKiAgICAgICAgICAkc2NvcGUubmFtZXMgPSBbJ21vcnBoZXVzJywgJ25lbycsICd0cmluaXR5J107CiAqICAgICAgICB9XSk7CiAqICAgPC9maWxlPgogKiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogKiAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICogICAgICBMaXN0OiA8aW5wdXQgbmFtZT0ibmFtZXNJbnB1dCIgbmctbW9kZWw9Im5hbWVzIiBuZy1saXN0IHJlcXVpcmVkPgogKiAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLm5hbWVzSW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICogICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICogICAgICA8YnI+CiAqICAgICAgPHR0Pm5hbWVzID0ge3tuYW1lc319PC90dD48YnIvPgogKiAgICAgIDx0dD5teUZvcm0ubmFtZXNJbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZH19PC90dD48YnIvPgogKiAgICAgIDx0dD5teUZvcm0ubmFtZXNJbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5uYW1lc0lucHV0LiRlcnJvcn19PC90dD48YnIvPgogKiAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAqICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogKiAgICAgPC9mb3JtPgogKiAgIDwvZmlsZT4KICogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICogICAgIHZhciBsaXN0SW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCduYW1lcycpKTsKICogICAgIHZhciBuYW1lcyA9IGVsZW1lbnQoYnkuZXhhY3RCaW5kaW5nKCduYW1lcycpKTsKICogICAgIHZhciB2YWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLm5hbWVzSW5wdXQuJHZhbGlkJykpOwogKiAgICAgdmFyIGVycm9yID0gZWxlbWVudChieS5jc3MoJ3NwYW4uZXJyb3InKSk7CiAqCiAqICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICogICAgICAgZXhwZWN0KG5hbWVzLmdldFRleHQoKSkudG9Db250YWluKCdbIm1vcnBoZXVzIiwibmVvIiwidHJpbml0eSJdJyk7CiAqICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogKiAgICAgICBleHBlY3QoZXJyb3IuZ2V0Q3NzVmFsdWUoJ2Rpc3BsYXknKSkudG9CZSgnbm9uZScpOwogKiAgICAgfSk7CiAqCiAqICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICogICAgICAgbGlzdElucHV0LmNsZWFyKCk7CiAqICAgICAgIGxpc3RJbnB1dC5zZW5kS2V5cygnJyk7CiAqCiAqICAgICAgIGV4cGVjdChuYW1lcy5nZXRUZXh0KCkpLnRvQ29udGFpbignJyk7CiAqICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICogICAgICAgZXhwZWN0KGVycm9yLmdldENzc1ZhbHVlKCdkaXNwbGF5JykpLm5vdC50b0JlKCdub25lJyk7CiAqICAgICB9KTsKICogICA8L2ZpbGU+CiAqIDwvZXhhbXBsZT4KICoKICogIyMjIEV4YW1wbGUgLSBzcGxpdHRpbmcgb24gd2hpdGVzcGFjZQogKiA8ZXhhbXBsZSBuYW1lPSJuZ0xpc3QtZGlyZWN0aXZlLW5ld2xpbmVzIj4KICogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICogICAgPHRleHRhcmVhIG5nLW1vZGVsPSJsaXN0IiBuZy1saXN0PSImIzEwOyIgbmctdHJpbT0iZmFsc2UiPjwvdGV4dGFyZWE+CiAqICAgIDxwcmU+e3sgbGlzdCB8IGpzb24gfX08L3ByZT4KICogICA8L2ZpbGU+CiAqICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAqICAgICBpdCgic2hvdWxkIHNwbGl0IHRoZSB0ZXh0IGJ5IG5ld2xpbmVzIiwgZnVuY3Rpb24oKSB7CiAqICAgICAgIHZhciBsaXN0SW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCdsaXN0JykpOwogKiAgICAgICB2YXIgb3V0cHV0ID0gZWxlbWVudChieS5iaW5kaW5nKCdsaXN0IHwganNvbicpKTsKICogICAgICAgbGlzdElucHV0LnNlbmRLZXlzKCdhYmNcbmRlZlxuZ2hpJyk7CiAqICAgICAgIGV4cGVjdChvdXRwdXQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ1tcbiAgImFiYyIsXG4gICJkZWYiLFxuICAiZ2hpIlxuXScpOwogKiAgICAgfSk7CiAqICAgPC9maWxlPgogKiA8L2V4YW1wbGU+CiAqCiAqIEBlbGVtZW50IGlucHV0CiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdMaXN0IG9wdGlvbmFsIGRlbGltaXRlciB0aGF0IHNob3VsZCBiZSB1c2VkIHRvIHNwbGl0IHRoZSB2YWx1ZS4KICovCnZhciBuZ0xpc3REaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdBJywKICAgIHByaW9yaXR5OiAxMDAsCiAgICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAvLyBXZSB3YW50IHRvIGNvbnRyb2wgd2hpdGVzcGFjZSB0cmltbWluZyBzbyB3ZSB1c2UgdGhpcyBjb252b2x1dGVkIGFwcHJvYWNoCiAgICAgIC8vIHRvIGFjY2VzcyB0aGUgbmdMaXN0IGF0dHJpYnV0ZSwgd2hpY2ggZG9lc24ndCBwcmUtdHJpbSB0aGUgYXR0cmlidXRlCiAgICAgIHZhciBuZ0xpc3QgPSBlbGVtZW50LmF0dHIoYXR0ci4kYXR0ci5uZ0xpc3QpIHx8ICcsICc7CiAgICAgIHZhciB0cmltVmFsdWVzID0gYXR0ci5uZ1RyaW0gIT09ICdmYWxzZSc7CiAgICAgIHZhciBzZXBhcmF0b3IgPSB0cmltVmFsdWVzID8gdHJpbShuZ0xpc3QpIDogbmdMaXN0OwoKICAgICAgdmFyIHBhcnNlID0gZnVuY3Rpb24odmlld1ZhbHVlKSB7CiAgICAgICAgLy8gSWYgdGhlIHZpZXdWYWx1ZSBpcyBpbnZhbGlkIChzYXkgcmVxdWlyZWQgYnV0IGVtcHR5KSBpdCB3aWxsIGJlIGB1bmRlZmluZWRgCiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZpZXdWYWx1ZSkpIHJldHVybjsKCiAgICAgICAgdmFyIGxpc3QgPSBbXTsKCiAgICAgICAgaWYgKHZpZXdWYWx1ZSkgewogICAgICAgICAgZm9yRWFjaCh2aWV3VmFsdWUuc3BsaXQoc2VwYXJhdG9yKSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlKSBsaXN0LnB1c2godHJpbVZhbHVlcyA/IHRyaW0odmFsdWUpIDogdmFsdWUpOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgfTsKCiAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChwYXJzZSk7CiAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIHZhbHVlLmpvaW4obmdMaXN0KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIH0pOwoKICAgICAgLy8gT3ZlcnJpZGUgdGhlIHN0YW5kYXJkICRpc0VtcHR5IGJlY2F1c2UgYW4gZW1wdHkgYXJyYXkgbWVhbnMgdGhlIGlucHV0IGlzIGVtcHR5LgogICAgICBjdHJsLiRpc0VtcHR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gIXZhbHVlIHx8ICF2YWx1ZS5sZW5ndGg7CiAgICAgIH07CiAgICB9CiAgfTsKfTsKCgp2YXIgQ09OU1RBTlRfVkFMVUVfUkVHRVhQID0gL14odHJ1ZXxmYWxzZXxcZCspJC87Ci8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nVmFsdWUKICoKICogQGRlc2NyaXB0aW9uCiAqIEJpbmRzIHRoZSBnaXZlbiBleHByZXNzaW9uIHRvIHRoZSB2YWx1ZSBvZiBgaW5wdXRbc2VsZWN0XWAgb3IgYGlucHV0W3JhZGlvXWAsIHNvCiAqIHRoYXQgd2hlbiB0aGUgZWxlbWVudCBpcyBzZWxlY3RlZCwgdGhlIGBuZ01vZGVsYCBvZiB0aGF0IGVsZW1lbnQgaXMgc2V0IHRvIHRoZQogKiBib3VuZCB2YWx1ZS4KICoKICogYG5nVmFsdWVgIGlzIHVzZWZ1bCB3aGVuIGR5bmFtaWNhbGx5IGdlbmVyYXRpbmcgbGlzdHMgb2YgcmFkaW8gYnV0dG9ucyB1c2luZyBgbmctcmVwZWF0YCwgYXMKICogc2hvd24gYmVsb3cuCiAqCiAqIEBlbGVtZW50IGlucHV0CiAqIEBwYXJhbSB7c3RyaW5nPX0gbmdWYWx1ZSBhbmd1bGFyIGV4cHJlc3Npb24sIHdob3NlIHZhbHVlIHdpbGwgYmUgYm91bmQgdG8gdGhlIGB2YWx1ZWAgYXR0cmlidXRlCiAqICAgb2YgdGhlIGBpbnB1dGAgZWxlbWVudAogKgogKiBAZXhhbXBsZQogICAgPGV4YW1wbGUgbmFtZT0ibmdWYWx1ZS1kaXJlY3RpdmUiIG1vZHVsZT0idmFsdWVFeGFtcGxlIj4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ3ZhbHVlRXhhbXBsZScsIFtdKQogICAgICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAgICRzY29wZS5uYW1lcyA9IFsncGl6emEnLCAndW5pY29ybnMnLCAncm9ib3RzJ107CiAgICAgICAgICAgICAgJHNjb3BlLm15ID0geyBmYXZvcml0ZTogJ3VuaWNvcm5zJyB9OwogICAgICAgICAgICB9XSk7CiAgICAgICA8L3NjcmlwdD4KICAgICAgICA8Zm9ybSBuZy1jb250cm9sbGVyPSJFeGFtcGxlQ29udHJvbGxlciI+CiAgICAgICAgICA8aDI+V2hpY2ggaXMgeW91ciBmYXZvcml0ZT88L2gyPgogICAgICAgICAgICA8bGFiZWwgbmctcmVwZWF0PSJuYW1lIGluIG5hbWVzIiBmb3I9Int7bmFtZX19Ij4KICAgICAgICAgICAgICB7e25hbWV9fQogICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIKICAgICAgICAgICAgICAgICAgICAgbmctbW9kZWw9Im15LmZhdm9yaXRlIgogICAgICAgICAgICAgICAgICAgICBuZy12YWx1ZT0ibmFtZSIKICAgICAgICAgICAgICAgICAgICAgaWQ9Int7bmFtZX19IgogICAgICAgICAgICAgICAgICAgICBuYW1lPSJmYXZvcml0ZSI+CiAgICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgICA8ZGl2PllvdSBjaG9zZSB7e215LmZhdm9yaXRlfX08L2Rpdj4KICAgICAgICA8L2Zvcm0+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgdmFyIGZhdm9yaXRlID0gZWxlbWVudChieS5iaW5kaW5nKCdteS5mYXZvcml0ZScpKTsKCiAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZmF2b3JpdGUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3VuaWNvcm5zJyk7CiAgICAgICAgfSk7CiAgICAgICAgaXQoJ3Nob3VsZCBiaW5kIHRoZSB2YWx1ZXMgdG8gdGhlIGlucHV0cycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudC5hbGwoYnkubW9kZWwoJ215LmZhdm9yaXRlJykpLmdldCgwKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGZhdm9yaXRlLmdldFRleHQoKSkudG9Db250YWluKCdwaXp6YScpOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdWYWx1ZURpcmVjdGl2ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgcHJpb3JpdHk6IDEwMCwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRwbCwgdHBsQXR0cikgewogICAgICBpZiAoQ09OU1RBTlRfVkFMVUVfUkVHRVhQLnRlc3QodHBsQXR0ci5uZ1ZhbHVlKSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiBuZ1ZhbHVlQ29uc3RhbnRMaW5rKHNjb3BlLCBlbG0sIGF0dHIpIHsKICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBzY29wZS4kZXZhbChhdHRyLm5nVmFsdWUpKTsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmdW5jdGlvbiBuZ1ZhbHVlTGluayhzY29wZSwgZWxtLCBhdHRyKSB7CiAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1ZhbHVlLCBmdW5jdGlvbiB2YWx1ZVdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCB2YWx1ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfTsKfTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nTW9kZWxPcHRpb25zCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBbGxvd3MgdHVuaW5nIGhvdyBtb2RlbCB1cGRhdGVzIGFyZSBkb25lLiBVc2luZyBgbmdNb2RlbE9wdGlvbnNgIHlvdSBjYW4gc3BlY2lmeSBhIGN1c3RvbSBsaXN0IG9mCiAqIGV2ZW50cyB0aGF0IHdpbGwgdHJpZ2dlciBhIG1vZGVsIHVwZGF0ZSBhbmQvb3IgYSBkZWJvdW5jaW5nIGRlbGF5IHNvIHRoYXQgdGhlIGFjdHVhbCB1cGRhdGUgb25seQogKiB0YWtlcyBwbGFjZSB3aGVuIGEgdGltZXIgZXhwaXJlczsgdGhpcyB0aW1lciB3aWxsIGJlIHJlc2V0IGFmdGVyIGFub3RoZXIgY2hhbmdlIHRha2VzIHBsYWNlLgogKgogKiBHaXZlbiB0aGUgbmF0dXJlIG9mIGBuZ01vZGVsT3B0aW9uc2AsIHRoZSB2YWx1ZSBkaXNwbGF5ZWQgaW5zaWRlIGlucHV0IGZpZWxkcyBpbiB0aGUgdmlldyBtaWdodAogKiBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgdmFsdWUgaW4gdGhlIGFjdHVhbCBtb2RlbC4gVGhpcyBtZWFucyB0aGF0IGlmIHlvdSB1cGRhdGUgdGhlIG1vZGVsIHlvdQogKiBzaG91bGQgYWxzbyBpbnZva2Uge0BsaW5rIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIgYCRyb2xsYmFja1ZpZXdWYWx1ZWB9IG9uIHRoZSByZWxldmFudCBpbnB1dCBmaWVsZCBpbgogKiBvcmRlciB0byBtYWtlIHN1cmUgaXQgaXMgc3luY2hyb25pemVkIHdpdGggdGhlIG1vZGVsIGFuZCB0aGF0IGFueSBkZWJvdW5jZWQgYWN0aW9uIGlzIGNhbmNlbGVkLgogKgogKiBUaGUgZWFzaWVzdCB3YXkgdG8gcmVmZXJlbmNlIHRoZSBjb250cm9sJ3Mge0BsaW5rIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIgYCRyb2xsYmFja1ZpZXdWYWx1ZWB9CiAqIG1ldGhvZCBpcyBieSBtYWtpbmcgc3VyZSB0aGUgaW5wdXQgaXMgcGxhY2VkIGluc2lkZSBhIGZvcm0gdGhhdCBoYXMgYSBgbmFtZWAgYXR0cmlidXRlLiBUaGlzIGlzCiAqIGltcG9ydGFudCBiZWNhdXNlIGBmb3JtYCBjb250cm9sbGVycyBhcmUgcHVibGlzaGVkIHRvIHRoZSByZWxhdGVkIHNjb3BlIHVuZGVyIHRoZSBuYW1lIGluIHRoZWlyCiAqIGBuYW1lYCBhdHRyaWJ1dGUuCiAqCiAqIEFueSBwZW5kaW5nIGNoYW5nZXMgd2lsbCB0YWtlIHBsYWNlIGltbWVkaWF0ZWx5IHdoZW4gYW4gZW5jbG9zaW5nIGZvcm0gaXMgc3VibWl0dGVkIHZpYSB0aGUKICogYHN1Ym1pdGAgZXZlbnQuIE5vdGUgdGhhdCBgbmdDbGlja2AgZXZlbnRzIHdpbGwgb2NjdXIgYmVmb3JlIHRoZSBtb2RlbCBpcyB1cGRhdGVkLiBVc2UgYG5nU3VibWl0YAogKiB0byBoYXZlIGFjY2VzcyB0byB0aGUgdXBkYXRlZCBtb2RlbC4KICoKICogYG5nTW9kZWxPcHRpb25zYCBoYXMgYW4gZWZmZWN0IG9uIHRoZSBlbGVtZW50IGl0J3MgZGVjbGFyZWQgb24gYW5kIGl0cyBkZXNjZW5kYW50cy4KICoKICogQHBhcmFtIHtPYmplY3R9IG5nTW9kZWxPcHRpb25zIG9wdGlvbnMgdG8gYXBwbHkgdG8gdGhlIGN1cnJlbnQgbW9kZWwuIFZhbGlkIGtleXMgYXJlOgogKiAgIC0gYHVwZGF0ZU9uYDogc3RyaW5nIHNwZWNpZnlpbmcgd2hpY2ggZXZlbnQgc2hvdWxkIGJlIHRoZSBpbnB1dCBib3VuZCB0by4gWW91IGNhbiBzZXQgc2V2ZXJhbAogKiAgICAgZXZlbnRzIHVzaW5nIGFuIHNwYWNlIGRlbGltaXRlZCBsaXN0LiBUaGVyZSBpcyBhIHNwZWNpYWwgZXZlbnQgY2FsbGVkIGBkZWZhdWx0YCB0aGF0CiAqICAgICBtYXRjaGVzIHRoZSBkZWZhdWx0IGV2ZW50cyBiZWxvbmdpbmcgb2YgdGhlIGNvbnRyb2wuCiAqICAgLSBgZGVib3VuY2VgOiBpbnRlZ2VyIHZhbHVlIHdoaWNoIGNvbnRhaW5zIHRoZSBkZWJvdW5jZSBtb2RlbCB1cGRhdGUgdmFsdWUgaW4gbWlsbGlzZWNvbmRzLiBBCiAqICAgICB2YWx1ZSBvZiAwIHRyaWdnZXJzIGFuIGltbWVkaWF0ZSB1cGRhdGUuIElmIGFuIG9iamVjdCBpcyBzdXBwbGllZCBpbnN0ZWFkLCB5b3UgY2FuIHNwZWNpZnkgYQogKiAgICAgY3VzdG9tIHZhbHVlIGZvciBlYWNoIGV2ZW50LiBGb3IgZXhhbXBsZToKICogICAgIGBuZy1tb2RlbC1vcHRpb25zPSJ7IHVwZGF0ZU9uOiAnZGVmYXVsdCBibHVyJywgZGVib3VuY2U6IHsnZGVmYXVsdCc6IDUwMCwgJ2JsdXInOiAwfSB9ImAKICogICAtIGBhbGxvd0ludmFsaWRgOiBib29sZWFuIHZhbHVlIHdoaWNoIGluZGljYXRlcyB0aGF0IHRoZSBtb2RlbCBjYW4gYmUgc2V0IHdpdGggdmFsdWVzIHRoYXQgZGlkCiAqICAgICBub3QgdmFsaWRhdGUgY29ycmVjdGx5IGluc3RlYWQgb2YgdGhlIGRlZmF1bHQgYmVoYXZpb3Igb2Ygc2V0dGluZyB0aGUgbW9kZWwgdG8gdW5kZWZpbmVkLgogKiAgIC0gYGdldHRlclNldHRlcmA6IGJvb2xlYW4gdmFsdWUgd2hpY2ggZGV0ZXJtaW5lcyB3aGV0aGVyIG9yIG5vdCB0byB0cmVhdCBmdW5jdGlvbnMgYm91bmQgdG8KICAgICAgIGBuZ01vZGVsYCBhcyBnZXR0ZXJzL3NldHRlcnMuCiAqICAgLSBgdGltZXpvbmVgOiBEZWZpbmVzIHRoZSB0aW1lem9uZSB0byBiZSB1c2VkIHRvIHJlYWQvd3JpdGUgdGhlIGBEYXRlYCBpbnN0YW5jZSBpbiB0aGUgbW9kZWwgZm9yCiAqICAgICBgPGlucHV0IHR5cGU9ImRhdGUiPmAsIGA8aW5wdXQgdHlwZT0idGltZSI+YCwgLi4uIC4gUmlnaHQgbm93LCB0aGUgb25seSBzdXBwb3J0ZWQgdmFsdWUgaXMgYCdVVEMnYCwKICogICAgIG90aGVyd2lzZSB0aGUgZGVmYXVsdCB0aW1lem9uZSBvZiB0aGUgYnJvd3NlciB3aWxsIGJlIHVzZWQuCiAqCiAqIEBleGFtcGxlCgogIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzaG93cyBob3cgdG8gb3ZlcnJpZGUgaW1tZWRpYXRlIHVwZGF0ZXMuIENoYW5nZXMgb24gdGhlIGlucHV0cyB3aXRoaW4gdGhlCiAgZm9ybSB3aWxsIHVwZGF0ZSB0aGUgbW9kZWwgb25seSB3aGVuIHRoZSBjb250cm9sIGxvc2VzIGZvY3VzIChibHVyIGV2ZW50KS4gSWYgYGVzY2FwZWAga2V5IGlzCiAgcHJlc3NlZCB3aGlsZSB0aGUgaW5wdXQgZmllbGQgaXMgZm9jdXNlZCwgdGhlIHZhbHVlIGlzIHJlc2V0IHRvIHRoZSB2YWx1ZSBpbiB0aGUgY3VycmVudCBtb2RlbC4KCiAgPGV4YW1wbGUgbmFtZT0ibmdNb2RlbE9wdGlvbnMtZGlyZWN0aXZlLWJsdXIiIG1vZHVsZT0ib3B0aW9uc0V4YW1wbGUiPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgIDxmb3JtIG5hbWU9InVzZXJGb3JtIj4KICAgICAgICAgIE5hbWU6CiAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idXNlck5hbWUiCiAgICAgICAgICAgICAgICAgbmctbW9kZWw9InVzZXIubmFtZSIKICAgICAgICAgICAgICAgICBuZy1tb2RlbC1vcHRpb25zPSJ7IHVwZGF0ZU9uOiAnYmx1cicgfSIKICAgICAgICAgICAgICAgICBuZy1rZXl1cD0iY2FuY2VsKCRldmVudCkiIC8+PGJyIC8+CgogICAgICAgICAgT3RoZXIgZGF0YToKICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idXNlci5kYXRhIiAvPjxiciAvPgogICAgICAgIDwvZm9ybT4KICAgICAgICA8cHJlPnVzZXIubmFtZSA9IDxzcGFuIG5nLWJpbmQ9InVzZXIubmFtZSI+PC9zcGFuPjwvcHJlPgogICAgICA8L2Rpdj4KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImFwcC5qcyI+CiAgICAgIGFuZ3VsYXIubW9kdWxlKCdvcHRpb25zRXhhbXBsZScsIFtdKQogICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAkc2NvcGUudXNlciA9IHsgbmFtZTogJ3NheScsIGRhdGE6ICcnIH07CgogICAgICAgICAgJHNjb3BlLmNhbmNlbCA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIGlmIChlLmtleUNvZGUgPT0gMjcpIHsKICAgICAgICAgICAgICAkc2NvcGUudXNlckZvcm0udXNlck5hbWUuJHJvbGxiYWNrVmlld1ZhbHVlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfV0pOwogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgIHZhciBtb2RlbCA9IGVsZW1lbnQoYnkuYmluZGluZygndXNlci5uYW1lJykpOwogICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd1c2VyLm5hbWUnKSk7CiAgICAgIHZhciBvdGhlciA9IGVsZW1lbnQoYnkubW9kZWwoJ3VzZXIuZGF0YScpKTsKCiAgICAgIGl0KCdzaG91bGQgYWxsb3cgY3VzdG9tIGV2ZW50cycsIGZ1bmN0aW9uKCkgewogICAgICAgIGlucHV0LnNlbmRLZXlzKCcgaGVsbG8nKTsKICAgICAgICBpbnB1dC5jbGljaygpOwogICAgICAgIGV4cGVjdChtb2RlbC5nZXRUZXh0KCkpLnRvRXF1YWwoJ3NheScpOwogICAgICAgIG90aGVyLmNsaWNrKCk7CiAgICAgICAgZXhwZWN0KG1vZGVsLmdldFRleHQoKSkudG9FcXVhbCgnc2F5IGhlbGxvJyk7CiAgICAgIH0pOwoKICAgICAgaXQoJ3Nob3VsZCAkcm9sbGJhY2tWaWV3VmFsdWUgd2hlbiBtb2RlbCBjaGFuZ2VzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgaW5wdXQuc2VuZEtleXMoJyBoZWxsbycpOwogICAgICAgIGV4cGVjdChpbnB1dC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvRXF1YWwoJ3NheSBoZWxsbycpOwogICAgICAgIGlucHV0LnNlbmRLZXlzKHByb3RyYWN0b3IuS2V5LkVTQ0FQRSk7CiAgICAgICAgZXhwZWN0KGlucHV0LmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9FcXVhbCgnc2F5Jyk7CiAgICAgICAgb3RoZXIuY2xpY2soKTsKICAgICAgICBleHBlY3QobW9kZWwuZ2V0VGV4dCgpKS50b0VxdWFsKCdzYXknKTsKICAgICAgfSk7CiAgICA8L2ZpbGU+CiAgPC9leGFtcGxlPgoKICBUaGlzIG9uZSBzaG93cyBob3cgdG8gZGVib3VuY2UgbW9kZWwgY2hhbmdlcy4gTW9kZWwgd2lsbCBiZSB1cGRhdGVkIG9ubHkgMSBzZWMgYWZ0ZXIgbGFzdCBjaGFuZ2UuCiAgSWYgdGhlIGBDbGVhcmAgYnV0dG9uIGlzIHByZXNzZWQsIGFueSBkZWJvdW5jZWQgYWN0aW9uIGlzIGNhbmNlbGVkIGFuZCB0aGUgdmFsdWUgYmVjb21lcyBlbXB0eS4KCiAgPGV4YW1wbGUgbmFtZT0ibmdNb2RlbE9wdGlvbnMtZGlyZWN0aXZlLWRlYm91bmNlIiBtb2R1bGU9Im9wdGlvbnNFeGFtcGxlIj4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICA8Zm9ybSBuYW1lPSJ1c2VyRm9ybSI+CiAgICAgICAgICBOYW1lOgogICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InVzZXJOYW1lIgogICAgICAgICAgICAgICAgIG5nLW1vZGVsPSJ1c2VyLm5hbWUiCiAgICAgICAgICAgICAgICAgbmctbW9kZWwtb3B0aW9ucz0ieyBkZWJvdW5jZTogMTAwMCB9IiAvPgogICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0idXNlckZvcm0udXNlck5hbWUuJHJvbGxiYWNrVmlld1ZhbHVlKCk7IHVzZXIubmFtZT0nJyI+Q2xlYXI8L2J1dHRvbj48YnIgLz4KICAgICAgICA8L2Zvcm0+CiAgICAgICAgPHByZT51c2VyLm5hbWUgPSA8c3BhbiBuZy1iaW5kPSJ1c2VyLm5hbWUiPjwvc3Bhbj48L3ByZT4KICAgICAgPC9kaXY+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJhcHAuanMiPgogICAgICBhbmd1bGFyLm1vZHVsZSgnb3B0aW9uc0V4YW1wbGUnLCBbXSkKICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLnVzZXIgPSB7IG5hbWU6ICdzYXknIH07CiAgICAgICAgfV0pOwogICAgPC9maWxlPgogIDwvZXhhbXBsZT4KCiAgVGhpcyBvbmUgc2hvd3MgaG93IHRvIGJpbmQgdG8gZ2V0dGVyL3NldHRlcnM6CgogIDxleGFtcGxlIG5hbWU9Im5nTW9kZWxPcHRpb25zLWRpcmVjdGl2ZS1nZXR0ZXItc2V0dGVyIiBtb2R1bGU9ImdldHRlclNldHRlckV4YW1wbGUiPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgIDxmb3JtIG5hbWU9InVzZXJGb3JtIj4KICAgICAgICAgIE5hbWU6CiAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idXNlck5hbWUiCiAgICAgICAgICAgICAgICAgbmctbW9kZWw9InVzZXIubmFtZSIKICAgICAgICAgICAgICAgICBuZy1tb2RlbC1vcHRpb25zPSJ7IGdldHRlclNldHRlcjogdHJ1ZSB9IiAvPgogICAgICAgIDwvZm9ybT4KICAgICAgICA8cHJlPnVzZXIubmFtZSA9IDxzcGFuIG5nLWJpbmQ9InVzZXIubmFtZSgpIj48L3NwYW4+PC9wcmU+CiAgICAgIDwvZGl2PgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iYXBwLmpzIj4KICAgICAgYW5ndWxhci5tb2R1bGUoJ2dldHRlclNldHRlckV4YW1wbGUnLCBbXSkKICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgdmFyIF9uYW1lID0gJ0JyaWFuJzsKICAgICAgICAgICRzY29wZS51c2VyID0gewogICAgICAgICAgICBuYW1lOiBmdW5jdGlvbiAobmV3TmFtZSkgewogICAgICAgICAgICAgIHJldHVybiBhbmd1bGFyLmlzRGVmaW5lZChuZXdOYW1lKSA/IChfbmFtZSA9IG5ld05hbWUpIDogX25hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfV0pOwogICAgPC9maWxlPgogIDwvZXhhbXBsZT4KICovCnZhciBuZ01vZGVsT3B0aW9uc0RpcmVjdGl2ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGF0dHJzJywgZnVuY3Rpb24oJHNjb3BlLCAkYXR0cnMpIHsKICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICB0aGlzLiRvcHRpb25zID0gJHNjb3BlLiRldmFsKCRhdHRycy5uZ01vZGVsT3B0aW9ucyk7CiAgICAgIC8vIEFsbG93IGFkZGluZy9vdmVycmlkaW5nIGJvdW5kIGV2ZW50cwogICAgICBpZiAodGhpcy4kb3B0aW9ucy51cGRhdGVPbiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy4kb3B0aW9ucy51cGRhdGVPbkRlZmF1bHQgPSBmYWxzZTsKICAgICAgICAvLyBleHRyYWN0ICJkZWZhdWx0IiBwc2V1ZG8tZXZlbnQgZnJvbSBsaXN0IG9mIGV2ZW50cyB0aGF0IGNhbiB0cmlnZ2VyIGEgbW9kZWwgdXBkYXRlCiAgICAgICAgdGhpcy4kb3B0aW9ucy51cGRhdGVPbiA9IHRyaW0odGhpcy4kb3B0aW9ucy51cGRhdGVPbi5yZXBsYWNlKERFRkFVTFRfUkVHRVhQLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoYXQuJG9wdGlvbnMudXBkYXRlT25EZWZhdWx0ID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiAnICc7CiAgICAgICAgfSkpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuJG9wdGlvbnMudXBkYXRlT25EZWZhdWx0ID0gdHJ1ZTsKICAgICAgfQogICAgfV0KICB9Owp9OwoKLy8gaGVscGVyIG1ldGhvZHMKZnVuY3Rpb24gYWRkU2V0VmFsaWRpdHlNZXRob2QoY29udGV4dCkgewogIHZhciBjdHJsID0gY29udGV4dC5jdHJsLAogICAgICAkZWxlbWVudCA9IGNvbnRleHQuJGVsZW1lbnQsCiAgICAgIGNsYXNzQ2FjaGUgPSB7fSwKICAgICAgc2V0ID0gY29udGV4dC5zZXQsCiAgICAgIHVuc2V0ID0gY29udGV4dC51bnNldCwKICAgICAgcGFyZW50Rm9ybSA9IGNvbnRleHQucGFyZW50Rm9ybSwKICAgICAgJGFuaW1hdGUgPSBjb250ZXh0LiRhbmltYXRlOwoKICBjbGFzc0NhY2hlW0lOVkFMSURfQ0xBU1NdID0gIShjbGFzc0NhY2hlW1ZBTElEX0NMQVNTXSA9ICRlbGVtZW50Lmhhc0NsYXNzKFZBTElEX0NMQVNTKSk7CgogIGN0cmwuJHNldFZhbGlkaXR5ID0gc2V0VmFsaWRpdHk7CgogIGZ1bmN0aW9uIHNldFZhbGlkaXR5KHZhbGlkYXRpb25FcnJvcktleSwgc3RhdGUsIG9wdGlvbnMpIHsKICAgIGlmIChzdGF0ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGNyZWF0ZUFuZFNldCgnJHBlbmRpbmcnLCB2YWxpZGF0aW9uRXJyb3JLZXksIG9wdGlvbnMpOwogICAgfSBlbHNlIHsKICAgICAgdW5zZXRBbmRDbGVhbnVwKCckcGVuZGluZycsIHZhbGlkYXRpb25FcnJvcktleSwgb3B0aW9ucyk7CiAgICB9CiAgICBpZiAoIWlzQm9vbGVhbihzdGF0ZSkpIHsKICAgICAgdW5zZXQoY3RybC4kZXJyb3IsIHZhbGlkYXRpb25FcnJvcktleSwgb3B0aW9ucyk7CiAgICAgIHVuc2V0KGN0cmwuJCRzdWNjZXNzLCB2YWxpZGF0aW9uRXJyb3JLZXksIG9wdGlvbnMpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKHN0YXRlKSB7CiAgICAgICAgdW5zZXQoY3RybC4kZXJyb3IsIHZhbGlkYXRpb25FcnJvcktleSwgb3B0aW9ucyk7CiAgICAgICAgc2V0KGN0cmwuJCRzdWNjZXNzLCB2YWxpZGF0aW9uRXJyb3JLZXksIG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIHNldChjdHJsLiRlcnJvciwgdmFsaWRhdGlvbkVycm9yS2V5LCBvcHRpb25zKTsKICAgICAgICB1bnNldChjdHJsLiQkc3VjY2VzcywgdmFsaWRhdGlvbkVycm9yS2V5LCBvcHRpb25zKTsKICAgICAgfQogICAgfQogICAgaWYgKGN0cmwuJHBlbmRpbmcpIHsKICAgICAgY2FjaGVkVG9nZ2xlQ2xhc3MoUEVORElOR19DTEFTUywgdHJ1ZSk7CiAgICAgIGN0cmwuJHZhbGlkID0gY3RybC4kaW52YWxpZCA9IHVuZGVmaW5lZDsKICAgICAgdG9nZ2xlVmFsaWRhdGlvbkNzcygnJywgbnVsbCk7CiAgICB9IGVsc2UgewogICAgICBjYWNoZWRUb2dnbGVDbGFzcyhQRU5ESU5HX0NMQVNTLCBmYWxzZSk7CiAgICAgIGN0cmwuJHZhbGlkID0gaXNPYmplY3RFbXB0eShjdHJsLiRlcnJvcik7CiAgICAgIGN0cmwuJGludmFsaWQgPSAhY3RybC4kdmFsaWQ7CiAgICAgIHRvZ2dsZVZhbGlkYXRpb25Dc3MoJycsIGN0cmwuJHZhbGlkKTsKICAgIH0KCiAgICAvLyByZS1yZWFkIHRoZSBzdGF0ZSBhcyB0aGUgc2V0L3Vuc2V0IG1ldGhvZHMgY291bGQgaGF2ZQogICAgLy8gY29tYmluZWQgc3RhdGUgaW4gY3RybC4kZXJyb3JbdmFsaWRhdGlvbkVycm9yXSAodXNlZCBmb3IgZm9ybXMpLAogICAgLy8gd2hlcmUgc2V0dGluZy91bnNldHRpbmcgb25seSBpbmNyZW1lbnRzL2RlY3JlbWVudHMgdGhlIHZhbHVlLAogICAgLy8gYW5kIGRvZXMgbm90IHJlcGxhY2UgaXQuCiAgICB2YXIgY29tYmluZWRTdGF0ZTsKICAgIGlmIChjdHJsLiRwZW5kaW5nICYmIGN0cmwuJHBlbmRpbmdbdmFsaWRhdGlvbkVycm9yS2V5XSkgewogICAgICBjb21iaW5lZFN0YXRlID0gdW5kZWZpbmVkOwogICAgfSBlbHNlIGlmIChjdHJsLiRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldKSB7CiAgICAgIGNvbWJpbmVkU3RhdGUgPSBmYWxzZTsKICAgIH0gZWxzZSBpZiAoY3RybC4kJHN1Y2Nlc3NbdmFsaWRhdGlvbkVycm9yS2V5XSkgewogICAgICBjb21iaW5lZFN0YXRlID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbWJpbmVkU3RhdGUgPSBudWxsOwogICAgfQogICAgdG9nZ2xlVmFsaWRhdGlvbkNzcyh2YWxpZGF0aW9uRXJyb3JLZXksIGNvbWJpbmVkU3RhdGUpOwogICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvbkVycm9yS2V5LCBjb21iaW5lZFN0YXRlLCBjdHJsKTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUFuZFNldChuYW1lLCB2YWx1ZSwgb3B0aW9ucykgewogICAgaWYgKCFjdHJsW25hbWVdKSB7CiAgICAgIGN0cmxbbmFtZV0gPSB7fTsKICAgIH0KICAgIHNldChjdHJsW25hbWVdLCB2YWx1ZSwgb3B0aW9ucyk7CiAgfQoKICBmdW5jdGlvbiB1bnNldEFuZENsZWFudXAobmFtZSwgdmFsdWUsIG9wdGlvbnMpIHsKICAgIGlmIChjdHJsW25hbWVdKSB7CiAgICAgIHVuc2V0KGN0cmxbbmFtZV0sIHZhbHVlLCBvcHRpb25zKTsKICAgIH0KICAgIGlmIChpc09iamVjdEVtcHR5KGN0cmxbbmFtZV0pKSB7CiAgICAgIGN0cmxbbmFtZV0gPSB1bmRlZmluZWQ7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjYWNoZWRUb2dnbGVDbGFzcyhjbGFzc05hbWUsIHN3aXRjaFZhbHVlKSB7CiAgICBpZiAoc3dpdGNoVmFsdWUgJiYgIWNsYXNzQ2FjaGVbY2xhc3NOYW1lXSkgewogICAgICAkYW5pbWF0ZS5hZGRDbGFzcygkZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgY2xhc3NDYWNoZVtjbGFzc05hbWVdID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAoIXN3aXRjaFZhbHVlICYmIGNsYXNzQ2FjaGVbY2xhc3NOYW1lXSkgewogICAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcygkZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgY2xhc3NDYWNoZVtjbGFzc05hbWVdID0gZmFsc2U7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB0b2dnbGVWYWxpZGF0aW9uQ3NzKHZhbGlkYXRpb25FcnJvcktleSwgaXNWYWxpZCkgewogICAgdmFsaWRhdGlvbkVycm9yS2V5ID0gdmFsaWRhdGlvbkVycm9yS2V5ID8gJy0nICsgc25ha2VfY2FzZSh2YWxpZGF0aW9uRXJyb3JLZXksICctJykgOiAnJzsKCiAgICBjYWNoZWRUb2dnbGVDbGFzcyhWQUxJRF9DTEFTUyArIHZhbGlkYXRpb25FcnJvcktleSwgaXNWYWxpZCA9PT0gdHJ1ZSk7CiAgICBjYWNoZWRUb2dnbGVDbGFzcyhJTlZBTElEX0NMQVNTICsgdmFsaWRhdGlvbkVycm9yS2V5LCBpc1ZhbGlkID09PSBmYWxzZSk7CiAgfQp9CgpmdW5jdGlvbiBpc09iamVjdEVtcHR5KG9iaikgewogIGlmIChvYmopIHsKICAgIGZvciAodmFyIHByb3AgaW4gb2JqKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQmluZAogKiBAcmVzdHJpY3QgQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdCaW5kYCBhdHRyaWJ1dGUgdGVsbHMgQW5ndWxhciB0byByZXBsYWNlIHRoZSB0ZXh0IGNvbnRlbnQgb2YgdGhlIHNwZWNpZmllZCBIVE1MIGVsZW1lbnQKICogd2l0aCB0aGUgdmFsdWUgb2YgYSBnaXZlbiBleHByZXNzaW9uLCBhbmQgdG8gdXBkYXRlIHRoZSB0ZXh0IGNvbnRlbnQgd2hlbiB0aGUgdmFsdWUgb2YgdGhhdAogKiBleHByZXNzaW9uIGNoYW5nZXMuCiAqCiAqIFR5cGljYWxseSwgeW91IGRvbid0IHVzZSBgbmdCaW5kYCBkaXJlY3RseSwgYnV0IGluc3RlYWQgeW91IHVzZSB0aGUgZG91YmxlIGN1cmx5IG1hcmt1cCBsaWtlCiAqIGB7eyBleHByZXNzaW9uIH19YCB3aGljaCBpcyBzaW1pbGFyIGJ1dCBsZXNzIHZlcmJvc2UuCiAqCiAqIEl0IGlzIHByZWZlcmFibGUgdG8gdXNlIGBuZ0JpbmRgIGluc3RlYWQgb2YgYHt7IGV4cHJlc3Npb24gfX1gIGlmIGEgdGVtcGxhdGUgaXMgbW9tZW50YXJpbHkKICogZGlzcGxheWVkIGJ5IHRoZSBicm93c2VyIGluIGl0cyByYXcgc3RhdGUgYmVmb3JlIEFuZ3VsYXIgY29tcGlsZXMgaXQuIFNpbmNlIGBuZ0JpbmRgIGlzIGFuCiAqIGVsZW1lbnQgYXR0cmlidXRlLCBpdCBtYWtlcyB0aGUgYmluZGluZ3MgaW52aXNpYmxlIHRvIHRoZSB1c2VyIHdoaWxlIHRoZSBwYWdlIGlzIGxvYWRpbmcuCiAqCiAqIEFuIGFsdGVybmF0aXZlIHNvbHV0aW9uIHRvIHRoaXMgcHJvYmxlbSB3b3VsZCBiZSB1c2luZyB0aGUKICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Nsb2FrIG5nQ2xvYWt9IGRpcmVjdGl2ZS4KICoKICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdCaW5kIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlLgogKgogKiBAZXhhbXBsZQogKiBFbnRlciBhIG5hbWUgaW4gdGhlIExpdmUgUHJldmlldyB0ZXh0IGJveDsgdGhlIGdyZWV0aW5nIGJlbG93IHRoZSB0ZXh0IGJveCBjaGFuZ2VzIGluc3RhbnRseS4KICAgPGV4YW1wbGUgbW9kdWxlPSJiaW5kRXhhbXBsZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBhbmd1bGFyLm1vZHVsZSgnYmluZEV4YW1wbGUnLCBbXSkKICAgICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAnV2hpcmxlZCc7CiAgICAgICAgICAgfV0pOwogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgRW50ZXIgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIj48YnI+CiAgICAgICAgIEhlbGxvIDxzcGFuIG5nLWJpbmQ9Im5hbWUiPjwvc3Bhbj4hCiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWJpbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgdmFyIG5hbWVJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ25hbWUnKSk7CgogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCduYW1lJykpLmdldFRleHQoKSkudG9CZSgnV2hpcmxlZCcpOwogICAgICAgICBuYW1lSW5wdXQuY2xlYXIoKTsKICAgICAgICAgbmFtZUlucHV0LnNlbmRLZXlzKCd3b3JsZCcpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCduYW1lJykpLmdldFRleHQoKSkudG9CZSgnd29ybGQnKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KdmFyIG5nQmluZERpcmVjdGl2ZSA9IFsnJGNvbXBpbGUnLCBmdW5jdGlvbigkY29tcGlsZSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0FDJywKICAgIGNvbXBpbGU6IGZ1bmN0aW9uIG5nQmluZENvbXBpbGUodGVtcGxhdGVFbGVtZW50KSB7CiAgICAgICRjb21waWxlLiQkYWRkQmluZGluZ0NsYXNzKHRlbXBsYXRlRWxlbWVudCk7CiAgICAgIHJldHVybiBmdW5jdGlvbiBuZ0JpbmRMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgJGNvbXBpbGUuJCRhZGRCaW5kaW5nSW5mbyhlbGVtZW50LCBhdHRyLm5nQmluZCk7CiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnRbMF07CiAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdCaW5kLCBmdW5jdGlvbiBuZ0JpbmRXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgZWxlbWVudC50ZXh0Q29udGVudCA9IHZhbHVlID09PSB1bmRlZmluZWQgPyAnJyA6IHZhbHVlOwogICAgICAgIH0pOwogICAgICB9OwogICAgfQogIH07Cn1dOwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQmluZFRlbXBsYXRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nQmluZFRlbXBsYXRlYCBkaXJlY3RpdmUgc3BlY2lmaWVzIHRoYXQgdGhlIGVsZW1lbnQKICogdGV4dCBjb250ZW50IHNob3VsZCBiZSByZXBsYWNlZCB3aXRoIHRoZSBpbnRlcnBvbGF0aW9uIG9mIHRoZSB0ZW1wbGF0ZQogKiBpbiB0aGUgYG5nQmluZFRlbXBsYXRlYCBhdHRyaWJ1dGUuCiAqIFVubGlrZSBgbmdCaW5kYCwgdGhlIGBuZ0JpbmRUZW1wbGF0ZWAgY2FuIGNvbnRhaW4gbXVsdGlwbGUgYHt7YCBgfX1gCiAqIGV4cHJlc3Npb25zLiBUaGlzIGRpcmVjdGl2ZSBpcyBuZWVkZWQgc2luY2Ugc29tZSBIVE1MIGVsZW1lbnRzCiAqIChzdWNoIGFzIFRJVExFIGFuZCBPUFRJT04pIGNhbm5vdCBjb250YWluIFNQQU4gZWxlbWVudHMuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge3N0cmluZ30gbmdCaW5kVGVtcGxhdGUgdGVtcGxhdGUgb2YgZm9ybQogKiAgIDx0dD57ezwvdHQ+IDx0dD5leHByZXNzaW9uPC90dD4gPHR0Pn19PC90dD4gdG8gZXZhbC4KICoKICogQGV4YW1wbGUKICogVHJ5IGl0IGhlcmU6IGVudGVyIHRleHQgaW4gdGV4dCBib3ggYW5kIHdhdGNoIHRoZSBncmVldGluZyBjaGFuZ2UuCiAgIDxleGFtcGxlIG1vZHVsZT0iYmluZEV4YW1wbGUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ2JpbmRFeGFtcGxlJywgW10pCiAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbiAoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUuc2FsdXRhdGlvbiA9ICdIZWxsbyc7CiAgICAgICAgICAgICAkc2NvcGUubmFtZSA9ICdXb3JsZCc7CiAgICAgICAgICAgfV0pOwogICAgICAgPC9zY3JpcHQ+CiAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICBTYWx1dGF0aW9uOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InNhbHV0YXRpb24iPjxicj4KICAgICAgICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiPjxicj4KICAgICAgICA8cHJlIG5nLWJpbmQtdGVtcGxhdGU9Int7c2FsdXRhdGlvbn19IHt7bmFtZX19ISI+PC9wcmU+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWJpbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgdmFyIHNhbHV0YXRpb25FbGVtID0gZWxlbWVudChieS5iaW5kaW5nKCdzYWx1dGF0aW9uJykpOwogICAgICAgICB2YXIgc2FsdXRhdGlvbklucHV0ID0gZWxlbWVudChieS5tb2RlbCgnc2FsdXRhdGlvbicpKTsKICAgICAgICAgdmFyIG5hbWVJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ25hbWUnKSk7CgogICAgICAgICBleHBlY3Qoc2FsdXRhdGlvbkVsZW0uZ2V0VGV4dCgpKS50b0JlKCdIZWxsbyBXb3JsZCEnKTsKCiAgICAgICAgIHNhbHV0YXRpb25JbnB1dC5jbGVhcigpOwogICAgICAgICBzYWx1dGF0aW9uSW5wdXQuc2VuZEtleXMoJ0dyZWV0aW5ncycpOwogICAgICAgICBuYW1lSW5wdXQuY2xlYXIoKTsKICAgICAgICAgbmFtZUlucHV0LnNlbmRLZXlzKCd1c2VyJyk7CgogICAgICAgICBleHBlY3Qoc2FsdXRhdGlvbkVsZW0uZ2V0VGV4dCgpKS50b0JlKCdHcmVldGluZ3MgdXNlciEnKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KdmFyIG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlID0gWyckaW50ZXJwb2xhdGUnLCAnJGNvbXBpbGUnLCBmdW5jdGlvbigkaW50ZXJwb2xhdGUsICRjb21waWxlKSB7CiAgcmV0dXJuIHsKICAgIGNvbXBpbGU6IGZ1bmN0aW9uIG5nQmluZFRlbXBsYXRlQ29tcGlsZSh0ZW1wbGF0ZUVsZW1lbnQpIHsKICAgICAgJGNvbXBpbGUuJCRhZGRCaW5kaW5nQ2xhc3ModGVtcGxhdGVFbGVtZW50KTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIG5nQmluZFRlbXBsYXRlTGluayhzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLm5nQmluZFRlbXBsYXRlKSk7CiAgICAgICAgJGNvbXBpbGUuJCRhZGRCaW5kaW5nSW5mbyhlbGVtZW50LCBpbnRlcnBvbGF0ZUZuLmV4cHJlc3Npb25zKTsKICAgICAgICBlbGVtZW50ID0gZWxlbWVudFswXTsKICAgICAgICBhdHRyLiRvYnNlcnZlKCduZ0JpbmRUZW1wbGF0ZScsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gdmFsdWUgPT09IHVuZGVmaW5lZCA/ICcnIDogdmFsdWU7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9CiAgfTsKfV07CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdCaW5kSHRtbAogKgogKiBAZGVzY3JpcHRpb24KICogQ3JlYXRlcyBhIGJpbmRpbmcgdGhhdCB3aWxsIGlubmVySFRNTCB0aGUgcmVzdWx0IG9mIGV2YWx1YXRpbmcgdGhlIGBleHByZXNzaW9uYCBpbnRvIHRoZSBjdXJyZW50CiAqIGVsZW1lbnQgaW4gYSBzZWN1cmUgd2F5LiAgQnkgZGVmYXVsdCwgdGhlIGlubmVySFRNTC1lZCBjb250ZW50IHdpbGwgYmUgc2FuaXRpemVkIHVzaW5nIHRoZSB7QGxpbmsKICogbmdTYW5pdGl6ZS4kc2FuaXRpemUgJHNhbml0aXplfSBzZXJ2aWNlLiAgVG8gdXRpbGl6ZSB0aGlzIGZ1bmN0aW9uYWxpdHksIGVuc3VyZSB0aGF0IGAkc2FuaXRpemVgCiAqIGlzIGF2YWlsYWJsZSwgZm9yIGV4YW1wbGUsIGJ5IGluY2x1ZGluZyB7QGxpbmsgbmdTYW5pdGl6ZX0gaW4geW91ciBtb2R1bGUncyBkZXBlbmRlbmNpZXMgKG5vdCBpbgogKiBjb3JlIEFuZ3VsYXIpLiBJbiBvcmRlciB0byB1c2Uge0BsaW5rIG5nU2FuaXRpemV9IGluIHlvdXIgbW9kdWxlJ3MgZGVwZW5kZW5jaWVzLCB5b3UgbmVlZCB0bwogKiBpbmNsdWRlICJhbmd1bGFyLXNhbml0aXplLmpzIiBpbiB5b3VyIGFwcGxpY2F0aW9uLgogKgogKiBZb3UgbWF5IGFsc28gYnlwYXNzIHNhbml0aXphdGlvbiBmb3IgdmFsdWVzIHlvdSBrbm93IGFyZSBzYWZlLiBUbyBkbyBzbywgYmluZCB0bwogKiBhbiBleHBsaWNpdGx5IHRydXN0ZWQgdmFsdWUgdmlhIHtAbGluayBuZy4kc2NlI3RydXN0QXNIdG1sICRzY2UudHJ1c3RBc0h0bWx9LiAgU2VlIHRoZSBleGFtcGxlCiAqIHVuZGVyIHtAbGluayBuZy4kc2NlI3Nob3ctbWUtYW4tZXhhbXBsZS11c2luZy1zY2UtIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpfS4KICoKICogTm90ZTogSWYgYSBgJHNhbml0aXplYCBzZXJ2aWNlIGlzIHVuYXZhaWxhYmxlIGFuZCB0aGUgYm91bmQgdmFsdWUgaXNuJ3QgZXhwbGljaXRseSB0cnVzdGVkLCB5b3UKICogd2lsbCBoYXZlIGFuIGV4Y2VwdGlvbiAoaW5zdGVhZCBvZiBhbiBleHBsb2l0LikKICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdCaW5kSHRtbCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZS4KICoKICogQGV4YW1wbGUKCiAgIDxleGFtcGxlIG1vZHVsZT0iYmluZEh0bWxFeGFtcGxlIiBkZXBzPSJhbmd1bGFyLXNhbml0aXplLmpzIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgIDxwIG5nLWJpbmQtaHRtbD0ibXlIVE1MIj48L3A+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgICBhbmd1bGFyLm1vZHVsZSgnYmluZEh0bWxFeGFtcGxlJywgWyduZ1Nhbml0aXplJ10pCiAgICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLm15SFRNTCA9CiAgICAgICAgICAgICAgJ0kgYW0gYW4gPGNvZGU+SFRNTDwvY29kZT5zdHJpbmcgd2l0aCAnICsKICAgICAgICAgICAgICAnPGEgaHJlZj0iIyI+bGlua3MhPC9hPiBhbmQgb3RoZXIgPGVtPnN0dWZmPC9lbT4nOwogICAgICAgICB9XSk7CiAgICAgPC9maWxlPgoKICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctYmluZC1odG1sJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ215SFRNTCcpKS5nZXRUZXh0KCkpLnRvQmUoCiAgICAgICAgICAgICAnSSBhbSBhbiBIVE1Mc3RyaW5nIHdpdGggbGlua3MhIGFuZCBvdGhlciBzdHVmZicpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdCaW5kSHRtbERpcmVjdGl2ZSA9IFsnJHNjZScsICckcGFyc2UnLCAnJGNvbXBpbGUnLCBmdW5jdGlvbigkc2NlLCAkcGFyc2UsICRjb21waWxlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnQScsCiAgICBjb21waWxlOiBmdW5jdGlvbiBuZ0JpbmRIdG1sQ29tcGlsZSh0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgIHZhciBuZ0JpbmRIdG1sR2V0dGVyID0gJHBhcnNlKHRBdHRycy5uZ0JpbmRIdG1sKTsKICAgICAgdmFyIG5nQmluZEh0bWxXYXRjaCA9ICRwYXJzZSh0QXR0cnMubmdCaW5kSHRtbCwgZnVuY3Rpb24gZ2V0U3RyaW5nVmFsdWUodmFsdWUpIHsKICAgICAgICByZXR1cm4gKHZhbHVlIHx8ICcnKS50b1N0cmluZygpOwogICAgICB9KTsKICAgICAgJGNvbXBpbGUuJCRhZGRCaW5kaW5nQ2xhc3ModEVsZW1lbnQpOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uIG5nQmluZEh0bWxMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgJGNvbXBpbGUuJCRhZGRCaW5kaW5nSW5mbyhlbGVtZW50LCBhdHRyLm5nQmluZEh0bWwpOwoKICAgICAgICBzY29wZS4kd2F0Y2gobmdCaW5kSHRtbFdhdGNoLCBmdW5jdGlvbiBuZ0JpbmRIdG1sV2F0Y2hBY3Rpb24oKSB7CiAgICAgICAgICAvLyB3ZSByZS1ldmFsdWF0ZSB0aGUgZXhwciBiZWNhdXNlIHdlIHdhbnQgYSBUcnVzdGVkVmFsdWVIb2xkZXJUeXBlCiAgICAgICAgICAvLyBmb3IgJHNjZSwgbm90IGEgc3RyaW5nCiAgICAgICAgICBlbGVtZW50Lmh0bWwoJHNjZS5nZXRUcnVzdGVkSHRtbChuZ0JpbmRIdG1sR2V0dGVyKHNjb3BlKSkgfHwgJycpOwogICAgICAgIH0pOwogICAgICB9OwogICAgfQogIH07Cn1dOwoKZnVuY3Rpb24gY2xhc3NEaXJlY3RpdmUobmFtZSwgc2VsZWN0b3IpIHsKICBuYW1lID0gJ25nQ2xhc3MnICsgbmFtZTsKICByZXR1cm4gWyckYW5pbWF0ZScsIGZ1bmN0aW9uKCRhbmltYXRlKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0FDJywKICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICB2YXIgb2xkVmFsOwoKICAgICAgICBzY29wZS4kd2F0Y2goYXR0cltuYW1lXSwgbmdDbGFzc1dhdGNoQWN0aW9uLCB0cnVlKTsKCiAgICAgICAgYXR0ci4kb2JzZXJ2ZSgnY2xhc3MnLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgbmdDbGFzc1dhdGNoQWN0aW9uKHNjb3BlLiRldmFsKGF0dHJbbmFtZV0pKTsKICAgICAgICB9KTsKCgogICAgICAgIGlmIChuYW1lICE9PSAnbmdDbGFzcycpIHsKICAgICAgICAgIHNjb3BlLiR3YXRjaCgnJGluZGV4JywgZnVuY3Rpb24oJGluZGV4LCBvbGQkaW5kZXgpIHsKICAgICAgICAgICAgLy8ganNoaW50IGJpdHdpc2U6IGZhbHNlCiAgICAgICAgICAgIHZhciBtb2QgPSAkaW5kZXggJiAxOwogICAgICAgICAgICBpZiAobW9kICE9PSAob2xkJGluZGV4ICYgMSkpIHsKICAgICAgICAgICAgICB2YXIgY2xhc3NlcyA9IGFycmF5Q2xhc3NlcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgbW9kID09PSBzZWxlY3RvciA/CiAgICAgICAgICAgICAgICBhZGRDbGFzc2VzKGNsYXNzZXMpIDoKICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzZXMoY2xhc3Nlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYWRkQ2xhc3NlcyhjbGFzc2VzKSB7CiAgICAgICAgICB2YXIgbmV3Q2xhc3NlcyA9IGRpZ2VzdENsYXNzQ291bnRzKGNsYXNzZXMsIDEpOwogICAgICAgICAgYXR0ci4kYWRkQ2xhc3MobmV3Q2xhc3Nlcyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZW1vdmVDbGFzc2VzKGNsYXNzZXMpIHsKICAgICAgICAgIHZhciBuZXdDbGFzc2VzID0gZGlnZXN0Q2xhc3NDb3VudHMoY2xhc3NlcywgLTEpOwogICAgICAgICAgYXR0ci4kcmVtb3ZlQ2xhc3MobmV3Q2xhc3Nlcyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkaWdlc3RDbGFzc0NvdW50cyAoY2xhc3NlcywgY291bnQpIHsKICAgICAgICAgIHZhciBjbGFzc0NvdW50cyA9IGVsZW1lbnQuZGF0YSgnJGNsYXNzQ291bnRzJykgfHwge307CiAgICAgICAgICB2YXIgY2xhc3Nlc1RvVXBkYXRlID0gW107CiAgICAgICAgICBmb3JFYWNoKGNsYXNzZXMsIGZ1bmN0aW9uIChjbGFzc05hbWUpIHsKICAgICAgICAgICAgaWYgKGNvdW50ID4gMCB8fCBjbGFzc0NvdW50c1tjbGFzc05hbWVdKSB7CiAgICAgICAgICAgICAgY2xhc3NDb3VudHNbY2xhc3NOYW1lXSA9IChjbGFzc0NvdW50c1tjbGFzc05hbWVdIHx8IDApICsgY291bnQ7CiAgICAgICAgICAgICAgaWYgKGNsYXNzQ291bnRzW2NsYXNzTmFtZV0gPT09ICsoY291bnQgPiAwKSkgewogICAgICAgICAgICAgICAgY2xhc3Nlc1RvVXBkYXRlLnB1c2goY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgZWxlbWVudC5kYXRhKCckY2xhc3NDb3VudHMnLCBjbGFzc0NvdW50cyk7CiAgICAgICAgICByZXR1cm4gY2xhc3Nlc1RvVXBkYXRlLmpvaW4oJyAnKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNsYXNzZXMgKG9sZENsYXNzZXMsIG5ld0NsYXNzZXMpIHsKICAgICAgICAgIHZhciB0b0FkZCA9IGFycmF5RGlmZmVyZW5jZShuZXdDbGFzc2VzLCBvbGRDbGFzc2VzKTsKICAgICAgICAgIHZhciB0b1JlbW92ZSA9IGFycmF5RGlmZmVyZW5jZShvbGRDbGFzc2VzLCBuZXdDbGFzc2VzKTsKICAgICAgICAgIHRvQWRkID0gZGlnZXN0Q2xhc3NDb3VudHModG9BZGQsIDEpOwogICAgICAgICAgdG9SZW1vdmUgPSBkaWdlc3RDbGFzc0NvdW50cyh0b1JlbW92ZSwgLTEpOwogICAgICAgICAgaWYgKHRvQWRkICYmIHRvQWRkLmxlbmd0aCkgewogICAgICAgICAgICAkYW5pbWF0ZS5hZGRDbGFzcyhlbGVtZW50LCB0b0FkZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodG9SZW1vdmUgJiYgdG9SZW1vdmUubGVuZ3RoKSB7CiAgICAgICAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsIHRvUmVtb3ZlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG5nQ2xhc3NXYXRjaEFjdGlvbihuZXdWYWwpIHsKICAgICAgICAgIGlmIChzZWxlY3RvciA9PT0gdHJ1ZSB8fCBzY29wZS4kaW5kZXggJSAyID09PSBzZWxlY3RvcikgewogICAgICAgICAgICB2YXIgbmV3Q2xhc3NlcyA9IGFycmF5Q2xhc3NlcyhuZXdWYWwgfHwgW10pOwogICAgICAgICAgICBpZiAoIW9sZFZhbCkgewogICAgICAgICAgICAgIGFkZENsYXNzZXMobmV3Q2xhc3Nlcyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWVxdWFscyhuZXdWYWwsb2xkVmFsKSkgewogICAgICAgICAgICAgIHZhciBvbGRDbGFzc2VzID0gYXJyYXlDbGFzc2VzKG9sZFZhbCk7CiAgICAgICAgICAgICAgdXBkYXRlQ2xhc3NlcyhvbGRDbGFzc2VzLCBuZXdDbGFzc2VzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgb2xkVmFsID0gc2hhbGxvd0NvcHkobmV3VmFsKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgZnVuY3Rpb24gYXJyYXlEaWZmZXJlbmNlKHRva2VuczEsIHRva2VuczIpIHsKICAgICAgdmFyIHZhbHVlcyA9IFtdOwoKICAgICAgb3V0ZXI6CiAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCB0b2tlbnMxLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIHRva2VuID0gdG9rZW5zMVtpXTsKICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgdG9rZW5zMi5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYodG9rZW4gPT0gdG9rZW5zMltqXSkgY29udGludWUgb3V0ZXI7CiAgICAgICAgfQogICAgICAgIHZhbHVlcy5wdXNoKHRva2VuKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWVzOwogICAgfQoKICAgIGZ1bmN0aW9uIGFycmF5Q2xhc3NlcyAoY2xhc3NWYWwpIHsKICAgICAgaWYgKGlzQXJyYXkoY2xhc3NWYWwpKSB7CiAgICAgICAgcmV0dXJuIGNsYXNzVmFsOwogICAgICB9IGVsc2UgaWYgKGlzU3RyaW5nKGNsYXNzVmFsKSkgewogICAgICAgIHJldHVybiBjbGFzc1ZhbC5zcGxpdCgnICcpOwogICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KGNsYXNzVmFsKSkgewogICAgICAgIHZhciBjbGFzc2VzID0gW10sIGkgPSAwOwogICAgICAgIGZvckVhY2goY2xhc3NWYWwsIGZ1bmN0aW9uKHYsIGspIHsKICAgICAgICAgIGlmICh2KSB7CiAgICAgICAgICAgIGNsYXNzZXMgPSBjbGFzc2VzLmNvbmNhdChrLnNwbGl0KCcgJykpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBjbGFzc2VzOwogICAgICB9CiAgICAgIHJldHVybiBjbGFzc1ZhbDsKICAgIH0KICB9XTsKfQoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDbGFzcwogKiBAcmVzdHJpY3QgQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdDbGFzc2AgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gZHluYW1pY2FsbHkgc2V0IENTUyBjbGFzc2VzIG9uIGFuIEhUTUwgZWxlbWVudCBieSBkYXRhYmluZGluZwogKiBhbiBleHByZXNzaW9uIHRoYXQgcmVwcmVzZW50cyBhbGwgY2xhc3NlcyB0byBiZSBhZGRlZC4KICoKICogVGhlIGRpcmVjdGl2ZSBvcGVyYXRlcyBpbiB0aHJlZSBkaWZmZXJlbnQgd2F5cywgZGVwZW5kaW5nIG9uIHdoaWNoIG9mIHRocmVlIHR5cGVzIHRoZSBleHByZXNzaW9uCiAqIGV2YWx1YXRlcyB0bzoKICoKICogMS4gSWYgdGhlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgc3RyaW5nLCB0aGUgc3RyaW5nIHNob3VsZCBiZSBvbmUgb3IgbW9yZSBzcGFjZS1kZWxpbWl0ZWQgY2xhc3MKICogbmFtZXMuCiAqCiAqIDIuIElmIHRoZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhbiBhcnJheSwgZWFjaCBlbGVtZW50IG9mIHRoZSBhcnJheSBzaG91bGQgYmUgYSBzdHJpbmcgdGhhdCBpcwogKiBvbmUgb3IgbW9yZSBzcGFjZS1kZWxpbWl0ZWQgY2xhc3MgbmFtZXMuCiAqCiAqIDMuIElmIHRoZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhbiBvYmplY3QsIHRoZW4gZm9yIGVhY2gga2V5LXZhbHVlIHBhaXIgb2YgdGhlCiAqIG9iamVjdCB3aXRoIGEgdHJ1dGh5IHZhbHVlIHRoZSBjb3JyZXNwb25kaW5nIGtleSBpcyB1c2VkIGFzIGEgY2xhc3MgbmFtZS4KICoKICogVGhlIGRpcmVjdGl2ZSB3b24ndCBhZGQgZHVwbGljYXRlIGNsYXNzZXMgaWYgYSBwYXJ0aWN1bGFyIGNsYXNzIHdhcyBhbHJlYWR5IHNldC4KICoKICogV2hlbiB0aGUgZXhwcmVzc2lvbiBjaGFuZ2VzLCB0aGUgcHJldmlvdXNseSBhZGRlZCBjbGFzc2VzIGFyZSByZW1vdmVkIGFuZCBvbmx5IHRoZW4gdGhlCiAqIG5ldyBjbGFzc2VzIGFyZSBhZGRlZC4KICoKICogQGFuaW1hdGlvbnMKICogYWRkIC0gaGFwcGVucyBqdXN0IGJlZm9yZSB0aGUgY2xhc3MgaXMgYXBwbGllZCB0byB0aGUgZWxlbWVudAogKiByZW1vdmUgLSBoYXBwZW5zIGp1c3QgYmVmb3JlIHRoZSBjbGFzcyBpcyByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGFzcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLiBUaGUgcmVzdWx0CiAqICAgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MKICogICBuYW1lcywgYW4gYXJyYXksIG9yIGEgbWFwIG9mIGNsYXNzIG5hbWVzIHRvIGJvb2xlYW4gdmFsdWVzLiBJbiB0aGUgY2FzZSBvZiBhIG1hcCwgdGhlCiAqICAgbmFtZXMgb2YgdGhlIHByb3BlcnRpZXMgd2hvc2UgdmFsdWVzIGFyZSB0cnV0aHkgd2lsbCBiZSBhZGRlZCBhcyBjc3MgY2xhc3NlcyB0byB0aGUKICogICBlbGVtZW50LgogKgogKiBAZXhhbXBsZSBFeGFtcGxlIHRoYXQgZGVtb25zdHJhdGVzIGJhc2ljIGJpbmRpbmdzIHZpYSBuZ0NsYXNzIGRpcmVjdGl2ZS4KICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICA8cCBuZy1jbGFzcz0ie3N0cmlrZTogZGVsZXRlZCwgYm9sZDogaW1wb3J0YW50LCByZWQ6IGVycm9yfSI+TWFwIFN5bnRheCBFeGFtcGxlPC9wPgogICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iZGVsZXRlZCI+IGRlbGV0ZWQgKGFwcGx5ICJzdHJpa2UiIGNsYXNzKTxicj4KICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImltcG9ydGFudCI+IGltcG9ydGFudCAoYXBwbHkgImJvbGQiIGNsYXNzKTxicj4KICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImVycm9yIj4gZXJyb3IgKGFwcGx5ICJyZWQiIGNsYXNzKQogICAgICAgPGhyPgogICAgICAgPHAgbmctY2xhc3M9InN0eWxlIj5Vc2luZyBTdHJpbmcgU3ludGF4PC9wPgogICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzdHlsZSIgcGxhY2Vob2xkZXI9IlR5cGU6IGJvbGQgc3RyaWtlIHJlZCI+CiAgICAgICA8aHI+CiAgICAgICA8cCBuZy1jbGFzcz0iW3N0eWxlMSwgc3R5bGUyLCBzdHlsZTNdIj5Vc2luZyBBcnJheSBTeW50YXg8L3A+CiAgICAgICA8aW5wdXQgbmctbW9kZWw9InN0eWxlMSIgcGxhY2Vob2xkZXI9IlR5cGU6IGJvbGQsIHN0cmlrZSBvciByZWQiPjxicj4KICAgICAgIDxpbnB1dCBuZy1tb2RlbD0ic3R5bGUyIiBwbGFjZWhvbGRlcj0iVHlwZTogYm9sZCwgc3RyaWtlIG9yIHJlZCI+PGJyPgogICAgICAgPGlucHV0IG5nLW1vZGVsPSJzdHlsZTMiIHBsYWNlaG9sZGVyPSJUeXBlOiBib2xkLCBzdHJpa2Ugb3IgcmVkIj48YnI+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgICAuc3RyaWtlIHsKICAgICAgICAgdGV4dC1kZWNvcmF0aW9uOiBsaW5lLXRocm91Z2g7CiAgICAgICB9CiAgICAgICAuYm9sZCB7CiAgICAgICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICAgICB9CiAgICAgICAucmVkIHsKICAgICAgICAgICBjb2xvcjogcmVkOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIHZhciBwcyA9IGVsZW1lbnQuYWxsKGJ5LmNzcygncCcpKTsKCiAgICAgICBpdCgnc2hvdWxkIGxldCB5b3UgdG9nZ2xlIHRoZSBjbGFzcycsIGZ1bmN0aW9uKCkgewoKICAgICAgICAgZXhwZWN0KHBzLmZpcnN0KCkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS5ub3QudG9NYXRjaCgvYm9sZC8pOwogICAgICAgICBleHBlY3QocHMuZmlyc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLm5vdC50b01hdGNoKC9yZWQvKTsKCiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2ltcG9ydGFudCcpKS5jbGljaygpOwogICAgICAgICBleHBlY3QocHMuZmlyc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvTWF0Y2goL2JvbGQvKTsKCiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2Vycm9yJykpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChwcy5maXJzdCgpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkudG9NYXRjaCgvcmVkLyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIGxldCB5b3UgdG9nZ2xlIHN0cmluZyBleGFtcGxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChwcy5nZXQoMSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS50b0JlKCcnKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc3R5bGUnKSkuY2xlYXIoKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc3R5bGUnKSkuc2VuZEtleXMoJ3JlZCcpOwogICAgICAgICBleHBlY3QocHMuZ2V0KDEpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkudG9CZSgncmVkJyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnYXJyYXkgZXhhbXBsZSBzaG91bGQgaGF2ZSAzIGNsYXNzZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KHBzLmxhc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvQmUoJycpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdzdHlsZTEnKSkuc2VuZEtleXMoJ2JvbGQnKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc3R5bGUyJykpLnNlbmRLZXlzKCdzdHJpa2UnKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc3R5bGUzJykpLnNlbmRLZXlzKCdyZWQnKTsKICAgICAgICAgZXhwZWN0KHBzLmxhc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvQmUoJ2JvbGQgc3RyaWtlIHJlZCcpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CgogICAjIyBBbmltYXRpb25zCgogICBUaGUgZXhhbXBsZSBiZWxvdyBkZW1vbnN0cmF0ZXMgaG93IHRvIHBlcmZvcm0gYW5pbWF0aW9ucyB1c2luZyBuZ0NsYXNzLgoKICAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxpbnB1dCBpZD0ic2V0YnRuIiB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQiIG5nLWNsaWNrPSJteVZhcj0nbXktY2xhc3MnIj4KICAgICAgPGlucHV0IGlkPSJjbGVhcmJ0biIgdHlwZT0iYnV0dG9uIiB2YWx1ZT0iY2xlYXIiIG5nLWNsaWNrPSJteVZhcj0nJyI+CiAgICAgIDxicj4KICAgICAgPHNwYW4gY2xhc3M9ImJhc2UtY2xhc3MiIG5nLWNsYXNzPSJteVZhciI+U2FtcGxlIFRleHQ8L3NwYW4+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgICAuYmFzZS1jbGFzcyB7CiAgICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgICB0cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICB9CgogICAgICAgLmJhc2UtY2xhc3MubXktY2xhc3MgewogICAgICAgICBjb2xvcjogcmVkOwogICAgICAgICBmb250LXNpemU6M2VtOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcuYmFzZS1jbGFzcycpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLm5vdC4KICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwoKICAgICAgICAgZWxlbWVudChieS5pZCgnc2V0YnRuJykpLmNsaWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJy5iYXNlLWNsYXNzJykpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKCiAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ2NsZWFyYnRuJykpLmNsaWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJy5iYXNlLWNsYXNzJykpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkubm90LgogICAgICAgICAgIHRvTWF0Y2goL215LWNsYXNzLyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KCgogICAjIyBuZ0NsYXNzIGFuZCBwcmUtZXhpc3RpbmcgQ1NTMyBUcmFuc2l0aW9ucy9BbmltYXRpb25zCiAgIFRoZSBuZ0NsYXNzIGRpcmVjdGl2ZSBzdGlsbCBzdXBwb3J0cyBDU1MzIFRyYW5zaXRpb25zL0FuaW1hdGlvbnMgZXZlbiBpZiB0aGV5IGRvIG5vdCBmb2xsb3cgdGhlIG5nQW5pbWF0ZSBDU1MgbmFtaW5nIHN0cnVjdHVyZS4KICAgVXBvbiBhbmltYXRpb24gbmdBbmltYXRlIHdpbGwgYXBwbHkgc3VwcGxlbWVudGFyeSBDU1MgY2xhc3NlcyB0byB0cmFjayB0aGUgc3RhcnQgYW5kIGVuZCBvZiBhbiBhbmltYXRpb24sIGJ1dCB0aGlzIHdpbGwgbm90IGhpbmRlcgogICBhbnkgcHJlLWV4aXN0aW5nIENTUyB0cmFuc2l0aW9ucyBhbHJlYWR5IG9uIHRoZSBlbGVtZW50LiBUbyBnZXQgYW4gaWRlYSBvZiB3aGF0IGhhcHBlbnMgZHVyaW5nIGEgY2xhc3MtYmFzZWQgYW5pbWF0aW9uLCBiZSBzdXJlCiAgIHRvIHZpZXcgdGhlIHN0ZXAgYnkgc3RlcCBkZXRhaWxzIG9mIHtAbGluayBuZy4kYW5pbWF0ZSNhZGRDbGFzcyAkYW5pbWF0ZS5hZGRDbGFzc30gYW5kCiAgIHtAbGluayBuZy4kYW5pbWF0ZSNyZW1vdmVDbGFzcyAkYW5pbWF0ZS5yZW1vdmVDbGFzc30uCiAqLwp2YXIgbmdDbGFzc0RpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCcnLCB0cnVlKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQ2xhc3NPZGQKICogQHJlc3RyaWN0IEFDCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nQ2xhc3NPZGRgIGFuZCBgbmdDbGFzc0V2ZW5gIGRpcmVjdGl2ZXMgd29yayBleGFjdGx5IGFzCiAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGFzcyBuZ0NsYXNzfSwgZXhjZXB0IHRoZXkgd29yayBpbgogKiBjb25qdW5jdGlvbiB3aXRoIGBuZ1JlcGVhdGAgYW5kIHRha2UgZWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogKgogKiBUaGlzIGRpcmVjdGl2ZSBjYW4gYmUgYXBwbGllZCBvbmx5IHdpdGhpbiB0aGUgc2NvcGUgb2YgYW4KICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0uCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xhc3NPZGQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gVGhlIHJlc3VsdAogKiAgIG9mIHRoZSBldmFsdWF0aW9uIGNhbiBiZSBhIHN0cmluZyByZXByZXNlbnRpbmcgc3BhY2UgZGVsaW1pdGVkIGNsYXNzIG5hbWVzIG9yIGFuIGFycmF5LgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICA8b2wgbmctaW5pdD0ibmFtZXM9WydKb2huJywgJ01hcnknLCAnQ2F0ZScsICdTdXonXSI+CiAgICAgICAgICA8bGkgbmctcmVwZWF0PSJuYW1lIGluIG5hbWVzIj4KICAgICAgICAgICA8c3BhbiBuZy1jbGFzcy1vZGQ9IidvZGQnIiBuZy1jbGFzcy1ldmVuPSInZXZlbiciPgogICAgICAgICAgICAge3tuYW1lfX0KICAgICAgICAgICA8L3NwYW4+CiAgICAgICAgICA8L2xpPgogICAgICAgIDwvb2w+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgICAub2RkIHsKICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgIH0KICAgICAgIC5ldmVuIHsKICAgICAgICAgY29sb3I6IGJsdWU7CiAgICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGFzcy1vZGQgYW5kIG5nLWNsYXNzLWV2ZW4nLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkucmVwZWF0ZXIoJ25hbWUgaW4gbmFtZXMnKS5yb3coMCkuY29sdW1uKCduYW1lJykpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvb2RkLyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LnJlcGVhdGVyKCduYW1lIGluIG5hbWVzJykucm93KDEpLmNvbHVtbignbmFtZScpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLgogICAgICAgICAgIHRvTWF0Y2goL2V2ZW4vKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KdmFyIG5nQ2xhc3NPZGREaXJlY3RpdmUgPSBjbGFzc0RpcmVjdGl2ZSgnT2RkJywgMCk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0NsYXNzRXZlbgogKiBAcmVzdHJpY3QgQUMKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdDbGFzc09kZGAgYW5kIGBuZ0NsYXNzRXZlbmAgZGlyZWN0aXZlcyB3b3JrIGV4YWN0bHkgYXMKICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzIG5nQ2xhc3N9LCBleGNlcHQgdGhleSB3b3JrIGluCiAqIGNvbmp1bmN0aW9uIHdpdGggYG5nUmVwZWF0YCBhbmQgdGFrZSBlZmZlY3Qgb25seSBvbiBvZGQgKGV2ZW4pIHJvd3MuCiAqCiAqIFRoaXMgZGlyZWN0aXZlIGNhbiBiZSBhcHBsaWVkIG9ubHkgd2l0aGluIHRoZSBzY29wZSBvZiBhbgogKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fS4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGFzc0V2ZW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gVGhlCiAqICAgcmVzdWx0IG9mIHRoZSBldmFsdWF0aW9uIGNhbiBiZSBhIHN0cmluZyByZXByZXNlbnRpbmcgc3BhY2UgZGVsaW1pdGVkIGNsYXNzIG5hbWVzIG9yIGFuIGFycmF5LgogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICA8b2wgbmctaW5pdD0ibmFtZXM9WydKb2huJywgJ01hcnknLCAnQ2F0ZScsICdTdXonXSI+CiAgICAgICAgICA8bGkgbmctcmVwZWF0PSJuYW1lIGluIG5hbWVzIj4KICAgICAgICAgICA8c3BhbiBuZy1jbGFzcy1vZGQ9IidvZGQnIiBuZy1jbGFzcy1ldmVuPSInZXZlbiciPgogICAgICAgICAgICAge3tuYW1lfX0gJm5ic3A7ICZuYnNwOyAmbmJzcDsKICAgICAgICAgICA8L3NwYW4+CiAgICAgICAgICA8L2xpPgogICAgICAgIDwvb2w+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgICAub2RkIHsKICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgIH0KICAgICAgIC5ldmVuIHsKICAgICAgICAgY29sb3I6IGJsdWU7CiAgICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGFzcy1vZGQgYW5kIG5nLWNsYXNzLWV2ZW4nLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkucmVwZWF0ZXIoJ25hbWUgaW4gbmFtZXMnKS5yb3coMCkuY29sdW1uKCduYW1lJykpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvb2RkLyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LnJlcGVhdGVyKCduYW1lIGluIG5hbWVzJykucm93KDEpLmNvbHVtbignbmFtZScpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLgogICAgICAgICAgIHRvTWF0Y2goL2V2ZW4vKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KdmFyIG5nQ2xhc3NFdmVuRGlyZWN0aXZlID0gY2xhc3NEaXJlY3RpdmUoJ0V2ZW4nLCAxKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQ2xvYWsKICogQHJlc3RyaWN0IEFDCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nQ2xvYWtgIGRpcmVjdGl2ZSBpcyB1c2VkIHRvIHByZXZlbnQgdGhlIEFuZ3VsYXIgaHRtbCB0ZW1wbGF0ZSBmcm9tIGJlaW5nIGJyaWVmbHkKICogZGlzcGxheWVkIGJ5IHRoZSBicm93c2VyIGluIGl0cyByYXcgKHVuY29tcGlsZWQpIGZvcm0gd2hpbGUgeW91ciBhcHBsaWNhdGlvbiBpcyBsb2FkaW5nLiBVc2UgdGhpcwogKiBkaXJlY3RpdmUgdG8gYXZvaWQgdGhlIHVuZGVzaXJhYmxlIGZsaWNrZXIgZWZmZWN0IGNhdXNlZCBieSB0aGUgaHRtbCB0ZW1wbGF0ZSBkaXNwbGF5LgogKgogKiBUaGUgZGlyZWN0aXZlIGNhbiBiZSBhcHBsaWVkIHRvIHRoZSBgPGJvZHk+YCBlbGVtZW50LCBidXQgdGhlIHByZWZlcnJlZCB1c2FnZSBpcyB0byBhcHBseQogKiBtdWx0aXBsZSBgbmdDbG9ha2AgZGlyZWN0aXZlcyB0byBzbWFsbCBwb3J0aW9ucyBvZiB0aGUgcGFnZSB0byBwZXJtaXQgcHJvZ3Jlc3NpdmUgcmVuZGVyaW5nCiAqIG9mIHRoZSBicm93c2VyIHZpZXcuCiAqCiAqIGBuZ0Nsb2FrYCB3b3JrcyBpbiBjb29wZXJhdGlvbiB3aXRoIHRoZSBmb2xsb3dpbmcgY3NzIHJ1bGUgZW1iZWRkZWQgd2l0aGluIGBhbmd1bGFyLmpzYCBhbmQKICogYGFuZ3VsYXIubWluLmpzYC4KICogRm9yIENTUCBtb2RlIHBsZWFzZSBhZGQgYGFuZ3VsYXItY3NwLmNzc2AgdG8geW91ciBodG1sIGZpbGUgKHNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ3NwIG5nQ3NwfSkuCiAqCiAqIGBgYGNzcwogKiBbbmdcOmNsb2FrXSwgW25nLWNsb2FrXSwgW2RhdGEtbmctY2xvYWtdLCBbeC1uZy1jbG9ha10sIC5uZy1jbG9haywgLngtbmctY2xvYWsgewogKiAgIGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsKICogfQogKiBgYGAKICoKICogV2hlbiB0aGlzIGNzcyBydWxlIGlzIGxvYWRlZCBieSB0aGUgYnJvd3NlciwgYWxsIGh0bWwgZWxlbWVudHMgKGluY2x1ZGluZyB0aGVpciBjaGlsZHJlbikgdGhhdAogKiBhcmUgdGFnZ2VkIHdpdGggdGhlIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgYXJlIGhpZGRlbi4gV2hlbiBBbmd1bGFyIGVuY291bnRlcnMgdGhpcyBkaXJlY3RpdmUKICogZHVyaW5nIHRoZSBjb21waWxhdGlvbiBvZiB0aGUgdGVtcGxhdGUgaXQgZGVsZXRlcyB0aGUgYG5nQ2xvYWtgIGVsZW1lbnQgYXR0cmlidXRlLCBtYWtpbmcKICogdGhlIGNvbXBpbGVkIGVsZW1lbnQgdmlzaWJsZS4KICoKICogRm9yIHRoZSBiZXN0IHJlc3VsdCwgdGhlIGBhbmd1bGFyLmpzYCBzY3JpcHQgbXVzdCBiZSBsb2FkZWQgaW4gdGhlIGhlYWQgc2VjdGlvbiBvZiB0aGUgaHRtbAogKiBkb2N1bWVudDsgYWx0ZXJuYXRpdmVseSwgdGhlIGNzcyBydWxlIGFib3ZlIG11c3QgYmUgaW5jbHVkZWQgaW4gdGhlIGV4dGVybmFsIHN0eWxlc2hlZXQgb2YgdGhlCiAqIGFwcGxpY2F0aW9uLgogKgogKiBMZWdhY3kgYnJvd3NlcnMsIGxpa2UgSUU3LCBkbyBub3QgcHJvdmlkZSBhdHRyaWJ1dGUgc2VsZWN0b3Igc3VwcG9ydCAoYWRkZWQgaW4gQ1NTIDIuMSkgc28gdGhleQogKiBjYW5ub3QgbWF0Y2ggdGhlIGBbbmdcOmNsb2FrXWAgc2VsZWN0b3IuIFRvIHdvcmsgYXJvdW5kIHRoaXMgbGltaXRhdGlvbiwgeW91IG11c3QgYWRkIHRoZSBjc3MKICogY2xhc3MgYG5nLWNsb2FrYCBpbiBhZGRpdGlvbiB0byB0aGUgYG5nQ2xvYWtgIGRpcmVjdGl2ZSBhcyBzaG93biBpbiB0aGUgZXhhbXBsZSBiZWxvdy4KICoKICogQGVsZW1lbnQgQU5ZCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgIDxkaXYgaWQ9InRlbXBsYXRlMSIgbmctY2xvYWs+e3sgJ2hlbGxvJyB9fTwvZGl2PgogICAgICAgIDxkaXYgaWQ9InRlbXBsYXRlMiIgbmctY2xvYWsgY2xhc3M9Im5nLWNsb2FrIj57eyAnaGVsbG8gSUU3JyB9fTwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgcmVtb3ZlIHRoZSB0ZW1wbGF0ZSBkaXJlY3RpdmUgYW5kIGNzcyBjbGFzcycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoJCgnI3RlbXBsYXRlMScpLmdldEF0dHJpYnV0ZSgnbmctY2xvYWsnKSkuCiAgICAgICAgICAgdG9CZU51bGwoKTsKICAgICAgICAgZXhwZWN0KCQoJyN0ZW1wbGF0ZTInKS5nZXRBdHRyaWJ1dGUoJ25nLWNsb2FrJykpLgogICAgICAgICAgIHRvQmVOdWxsKCk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICoKICovCnZhciBuZ0Nsb2FrRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgIGF0dHIuJHNldCgnbmdDbG9haycsIHVuZGVmaW5lZCk7CiAgICBlbGVtZW50LnJlbW92ZUNsYXNzKCduZy1jbG9haycpOwogIH0KfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0NvbnRyb2xsZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUgYXR0YWNoZXMgYSBjb250cm9sbGVyIGNsYXNzIHRvIHRoZSB2aWV3LiBUaGlzIGlzIGEga2V5IGFzcGVjdCBvZiBob3cgYW5ndWxhcgogKiBzdXBwb3J0cyB0aGUgcHJpbmNpcGxlcyBiZWhpbmQgdGhlIE1vZGVsLVZpZXctQ29udHJvbGxlciBkZXNpZ24gcGF0dGVybi4KICoKICogTVZDIGNvbXBvbmVudHMgaW4gYW5ndWxhcjoKICoKICogKiBNb2RlbCDigJQgTW9kZWxzIGFyZSB0aGUgcHJvcGVydGllcyBvZiBhIHNjb3BlOyBzY29wZXMgYXJlIGF0dGFjaGVkIHRvIHRoZSBET00gd2hlcmUgc2NvcGUgcHJvcGVydGllcwogKiAgIGFyZSBhY2Nlc3NlZCB0aHJvdWdoIGJpbmRpbmdzLgogKiAqIFZpZXcg4oCUIFRoZSB0ZW1wbGF0ZSAoSFRNTCB3aXRoIGRhdGEgYmluZGluZ3MpIHRoYXQgaXMgcmVuZGVyZWQgaW50byB0aGUgVmlldy4KICogKiBDb250cm9sbGVyIOKAlCBUaGUgYG5nQ29udHJvbGxlcmAgZGlyZWN0aXZlIHNwZWNpZmllcyBhIENvbnRyb2xsZXIgY2xhc3M7IHRoZSBjbGFzcyBjb250YWlucyBidXNpbmVzcwogKiAgIGxvZ2ljIGJlaGluZCB0aGUgYXBwbGljYXRpb24gdG8gZGVjb3JhdGUgdGhlIHNjb3BlIHdpdGggZnVuY3Rpb25zIGFuZCB2YWx1ZXMKICoKICogTm90ZSB0aGF0IHlvdSBjYW4gYWxzbyBhdHRhY2ggY29udHJvbGxlcnMgdG8gdGhlIERPTSBieSBkZWNsYXJpbmcgaXQgaW4gYSByb3V0ZSBkZWZpbml0aW9uCiAqIHZpYSB0aGUge0BsaW5rIG5nUm91dGUuJHJvdXRlICRyb3V0ZX0gc2VydmljZS4gQSBjb21tb24gbWlzdGFrZSBpcyB0byBkZWNsYXJlIHRoZSBjb250cm9sbGVyCiAqIGFnYWluIHVzaW5nIGBuZy1jb250cm9sbGVyYCBpbiB0aGUgdGVtcGxhdGUgaXRzZWxmLiAgVGhpcyB3aWxsIGNhdXNlIHRoZSBjb250cm9sbGVyIHRvIGJlIGF0dGFjaGVkCiAqIGFuZCBleGVjdXRlZCB0d2ljZS4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBzY29wZQogKiBAcHJpb3JpdHkgNTAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDb250cm9sbGVyIE5hbWUgb2YgYSBjb25zdHJ1Y3RvciBmdW5jdGlvbiByZWdpc3RlcmVkIHdpdGggdGhlIGN1cnJlbnQKICoge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIgJGNvbnRyb2xsZXJQcm92aWRlcn0gb3IgYW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0KICogdGhhdCBvbiB0aGUgY3VycmVudCBzY29wZSBldmFsdWF0ZXMgdG8gYSBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICoKICogVGhlIGNvbnRyb2xsZXIgaW5zdGFuY2UgY2FuIGJlIHB1Ymxpc2hlZCBpbnRvIGEgc2NvcGUgcHJvcGVydHkgYnkgc3BlY2lmeWluZwogKiBgbmctY29udHJvbGxlcj0iYXMgcHJvcGVydHlOYW1lImAuCiAqCiAqIElmIHRoZSBjdXJyZW50IGAkY29udHJvbGxlclByb3ZpZGVyYCBpcyBjb25maWd1cmVkIHRvIHVzZSBnbG9iYWxzICh2aWEKICoge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjYWxsb3dHbG9iYWxzIGAkY29udHJvbGxlclByb3ZpZGVyLmFsbG93R2xvYmFscygpYCB9KSwgdGhpcyBtYXkKICogYWxzbyBiZSB0aGUgbmFtZSBvZiBhIGdsb2JhbGx5IGFjY2Vzc2libGUgY29uc3RydWN0b3IgZnVuY3Rpb24gKG5vdCByZWNvbW1lbmRlZCkuCiAqCiAqIEBleGFtcGxlCiAqIEhlcmUgaXMgYSBzaW1wbGUgZm9ybSBmb3IgZWRpdGluZyB1c2VyIGNvbnRhY3QgaW5mb3JtYXRpb24uIEFkZGluZywgcmVtb3ZpbmcsIGNsZWFyaW5nLCBhbmQKICogZ3JlZXRpbmcgYXJlIG1ldGhvZHMgZGVjbGFyZWQgb24gdGhlIGNvbnRyb2xsZXIgKHNlZSBzb3VyY2UgdGFiKS4gVGhlc2UgbWV0aG9kcyBjYW4KICogZWFzaWx5IGJlIGNhbGxlZCBmcm9tIHRoZSBhbmd1bGFyIG1hcmt1cC4gQW55IGNoYW5nZXMgdG8gdGhlIGRhdGEgYXJlIGF1dG9tYXRpY2FsbHkgcmVmbGVjdGVkCiAqIGluIHRoZSBWaWV3IHdpdGhvdXQgdGhlIG5lZWQgZm9yIGEgbWFudWFsIHVwZGF0ZS4KICoKICogVHdvIGRpZmZlcmVudCBkZWNsYXJhdGlvbiBzdHlsZXMgYXJlIGluY2x1ZGVkIGJlbG93OgogKgogKiAqIG9uZSBiaW5kcyBtZXRob2RzIGFuZCBwcm9wZXJ0aWVzIGRpcmVjdGx5IG9udG8gdGhlIGNvbnRyb2xsZXIgdXNpbmcgYHRoaXNgOgogKiBgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyMSBhcyBzZXR0aW5ncyJgCiAqICogb25lIGluamVjdHMgYCRzY29wZWAgaW50byB0aGUgY29udHJvbGxlcjoKICogYG5nLWNvbnRyb2xsZXI9IlNldHRpbmdzQ29udHJvbGxlcjIiYAogKgogKiBUaGUgc2Vjb25kIG9wdGlvbiBpcyBtb3JlIGNvbW1vbiBpbiB0aGUgQW5ndWxhciBjb21tdW5pdHksIGFuZCBpcyBnZW5lcmFsbHkgdXNlZCBpbiBib2lsZXJwbGF0ZXMKICogYW5kIGluIHRoaXMgZ3VpZGUuIEhvd2V2ZXIsIHRoZXJlIGFyZSBhZHZhbnRhZ2VzIHRvIGJpbmRpbmcgcHJvcGVydGllcyBkaXJlY3RseSB0byB0aGUgY29udHJvbGxlcgogKiBhbmQgYXZvaWRpbmcgc2NvcGUuCiAqCiAqICogVXNpbmcgYGNvbnRyb2xsZXIgYXNgIG1ha2VzIGl0IG9idmlvdXMgd2hpY2ggY29udHJvbGxlciB5b3UgYXJlIGFjY2Vzc2luZyBpbiB0aGUgdGVtcGxhdGUgd2hlbgogKiBtdWx0aXBsZSBjb250cm9sbGVycyBhcHBseSB0byBhbiBlbGVtZW50LgogKiAqIElmIHlvdSBhcmUgd3JpdGluZyB5b3VyIGNvbnRyb2xsZXJzIGFzIGNsYXNzZXMgeW91IGhhdmUgZWFzaWVyIGFjY2VzcyB0byB0aGUgcHJvcGVydGllcyBhbmQKICogbWV0aG9kcywgd2hpY2ggd2lsbCBhcHBlYXIgb24gdGhlIHNjb3BlLCBmcm9tIGluc2lkZSB0aGUgY29udHJvbGxlciBjb2RlLgogKiAqIFNpbmNlIHRoZXJlIGlzIGFsd2F5cyBhIGAuYCBpbiB0aGUgYmluZGluZ3MsIHlvdSBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IHByb3RvdHlwYWwKICogaW5oZXJpdGFuY2UgbWFza2luZyBwcmltaXRpdmVzLgogKgogKiBUaGlzIGV4YW1wbGUgZGVtb25zdHJhdGVzIHRoZSBgY29udHJvbGxlciBhc2Agc3ludGF4LgogKgogKiA8ZXhhbXBsZSBuYW1lPSJuZ0NvbnRyb2xsZXJBcyIgbW9kdWxlPSJjb250cm9sbGVyQXNFeGFtcGxlIj4KICogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICogICAgPGRpdiBpZD0iY3RybC1hcy1leG1wbCIgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyMSBhcyBzZXR0aW5ncyI+CiAqICAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzZXR0aW5ncy5uYW1lIi8+CiAqICAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJzZXR0aW5ncy5ncmVldCgpIj5ncmVldDwvYT4gXTxici8+CiAqICAgICAgQ29udGFjdDoKICogICAgICA8dWw+CiAqICAgICAgICA8bGkgbmctcmVwZWF0PSJjb250YWN0IGluIHNldHRpbmdzLmNvbnRhY3RzIj4KICogICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29udGFjdC50eXBlIj4KICogICAgICAgICAgICAgPG9wdGlvbj5waG9uZTwvb3B0aW9uPgogKiAgICAgICAgICAgICA8b3B0aW9uPmVtYWlsPC9vcHRpb24+CiAqICAgICAgICAgIDwvc2VsZWN0PgogKiAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9ImNvbnRhY3QudmFsdWUiLz4KICogICAgICAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJzZXR0aW5ncy5jbGVhckNvbnRhY3QoY29udGFjdCkiPmNsZWFyPC9hPgogKiAgICAgICAgICB8IDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLnJlbW92ZUNvbnRhY3QoY29udGFjdCkiPlg8L2E+IF0KICogICAgICAgIDwvbGk+CiAqICAgICAgICA8bGk+WyA8YSBocmVmPSIiIG5nLWNsaWNrPSJzZXR0aW5ncy5hZGRDb250YWN0KCkiPmFkZDwvYT4gXTwvbGk+CiAqICAgICA8L3VsPgogKiAgICA8L2Rpdj4KICogICA8L2ZpbGU+CiAqICAgPGZpbGUgbmFtZT0iYXBwLmpzIj4KICogICAgYW5ndWxhci5tb2R1bGUoJ2NvbnRyb2xsZXJBc0V4YW1wbGUnLCBbXSkKICogICAgICAuY29udHJvbGxlcignU2V0dGluZ3NDb250cm9sbGVyMScsIFNldHRpbmdzQ29udHJvbGxlcjEpOwogKgogKiAgICBmdW5jdGlvbiBTZXR0aW5nc0NvbnRyb2xsZXIxKCkgewogKiAgICAgIHRoaXMubmFtZSA9ICJKb2huIFNtaXRoIjsKICogICAgICB0aGlzLmNvbnRhY3RzID0gWwogKiAgICAgICAge3R5cGU6ICdwaG9uZScsIHZhbHVlOiAnNDA4IDU1NSAxMjEyJ30sCiAqICAgICAgICB7dHlwZTogJ2VtYWlsJywgdmFsdWU6ICdqb2huLnNtaXRoQGV4YW1wbGUub3JnJ30gXTsKICogICAgfQogKgogKiAgICBTZXR0aW5nc0NvbnRyb2xsZXIxLnByb3RvdHlwZS5ncmVldCA9IGZ1bmN0aW9uKCkgewogKiAgICAgIGFsZXJ0KHRoaXMubmFtZSk7CiAqICAgIH07CiAqCiAqICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLmFkZENvbnRhY3QgPSBmdW5jdGlvbigpIHsKICogICAgICB0aGlzLmNvbnRhY3RzLnB1c2goe3R5cGU6ICdlbWFpbCcsIHZhbHVlOiAneW91cm5hbWVAZXhhbXBsZS5vcmcnfSk7CiAqICAgIH07CiAqCiAqICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLnJlbW92ZUNvbnRhY3QgPSBmdW5jdGlvbihjb250YWN0VG9SZW1vdmUpIHsKICogICAgIHZhciBpbmRleCA9IHRoaXMuY29udGFjdHMuaW5kZXhPZihjb250YWN0VG9SZW1vdmUpOwogKiAgICAgIHRoaXMuY29udGFjdHMuc3BsaWNlKGluZGV4LCAxKTsKICogICAgfTsKICoKICogICAgU2V0dGluZ3NDb250cm9sbGVyMS5wcm90b3R5cGUuY2xlYXJDb250YWN0ID0gZnVuY3Rpb24oY29udGFjdCkgewogKiAgICAgIGNvbnRhY3QudHlwZSA9ICdwaG9uZSc7CiAqICAgICAgY29udGFjdC52YWx1ZSA9ICcnOwogKiAgICB9OwogKiAgIDwvZmlsZT4KICogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICogICAgIGl0KCdzaG91bGQgY2hlY2sgY29udHJvbGxlciBhcycsIGZ1bmN0aW9uKCkgewogKiAgICAgICB2YXIgY29udGFpbmVyID0gZWxlbWVudChieS5pZCgnY3RybC1hcy1leG1wbCcpKTsKICogICAgICAgICBleHBlY3QoY29udGFpbmVyLmVsZW1lbnQoYnkubW9kZWwoJ3NldHRpbmdzLm5hbWUnKSkKICogICAgICAgICAgIC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvQmUoJ0pvaG4gU21pdGgnKTsKICoKICogICAgICAgdmFyIGZpcnN0UmVwZWF0ID0KICogICAgICAgICAgIGNvbnRhaW5lci5lbGVtZW50KGJ5LnJlcGVhdGVyKCdjb250YWN0IGluIHNldHRpbmdzLmNvbnRhY3RzJykucm93KDApKTsKICogICAgICAgdmFyIHNlY29uZFJlcGVhdCA9CiAqICAgICAgICAgICBjb250YWluZXIuZWxlbWVudChieS5yZXBlYXRlcignY29udGFjdCBpbiBzZXR0aW5ncy5jb250YWN0cycpLnJvdygxKSk7CiAqCiAqICAgICAgIGV4cGVjdChmaXJzdFJlcGVhdC5lbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICogICAgICAgICAgIC50b0JlKCc0MDggNTU1IDEyMTInKTsKICoKICogICAgICAgZXhwZWN0KHNlY29uZFJlcGVhdC5lbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICogICAgICAgICAgIC50b0JlKCdqb2huLnNtaXRoQGV4YW1wbGUub3JnJyk7CiAqCiAqICAgICAgIGZpcnN0UmVwZWF0LmVsZW1lbnQoYnkubGlua1RleHQoJ2NsZWFyJykpLmNsaWNrKCk7CiAqCiAqICAgICAgIGV4cGVjdChmaXJzdFJlcGVhdC5lbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICogICAgICAgICAgIC50b0JlKCcnKTsKICoKICogICAgICAgY29udGFpbmVyLmVsZW1lbnQoYnkubGlua1RleHQoJ2FkZCcpKS5jbGljaygpOwogKgogKiAgICAgICBleHBlY3QoY29udGFpbmVyLmVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gc2V0dGluZ3MuY29udGFjdHMnKS5yb3coMikpCiAqICAgICAgICAgICAuZWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKQogKiAgICAgICAgICAgLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICogICAgICAgICAgIC50b0JlKCd5b3VybmFtZUBleGFtcGxlLm9yZycpOwogKiAgICAgfSk7CiAqICAgPC9maWxlPgogKiA8L2V4YW1wbGU+CiAqCiAqIFRoaXMgZXhhbXBsZSBkZW1vbnN0cmF0ZXMgdGhlICJhdHRhY2ggdG8gYCRzY29wZWAiIHN0eWxlIG9mIGNvbnRyb2xsZXIuCiAqCiAqIDxleGFtcGxlIG5hbWU9Im5nQ29udHJvbGxlciIgbW9kdWxlPSJjb250cm9sbGVyRXhhbXBsZSI+CiAqICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICogICA8ZGl2IGlkPSJjdHJsLWV4bXBsIiBuZy1jb250cm9sbGVyPSJTZXR0aW5nc0NvbnRyb2xsZXIyIj4KICogICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibmFtZSIvPgogKiAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJncmVldCgpIj5ncmVldDwvYT4gXTxici8+CiAqICAgICBDb250YWN0OgogKiAgICAgPHVsPgogKiAgICAgICA8bGkgbmctcmVwZWF0PSJjb250YWN0IGluIGNvbnRhY3RzIj4KICogICAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJjb250YWN0LnR5cGUiPgogKiAgICAgICAgICAgIDxvcHRpb24+cGhvbmU8L29wdGlvbj4KICogICAgICAgICAgICA8b3B0aW9uPmVtYWlsPC9vcHRpb24+CiAqICAgICAgICAgPC9zZWxlY3Q+CiAqICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJjb250YWN0LnZhbHVlIi8+CiAqICAgICAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJjbGVhckNvbnRhY3QoY29udGFjdCkiPmNsZWFyPC9hPgogKiAgICAgICAgIHwgPGEgaHJlZj0iIiBuZy1jbGljaz0icmVtb3ZlQ29udGFjdChjb250YWN0KSI+WDwvYT4gXQogKiAgICAgICA8L2xpPgogKiAgICAgICA8bGk+WyA8YSBocmVmPSIiIG5nLWNsaWNrPSJhZGRDb250YWN0KCkiPmFkZDwvYT4gXTwvbGk+CiAqICAgIDwvdWw+CiAqICAgPC9kaXY+CiAqICA8L2ZpbGU+CiAqICA8ZmlsZSBuYW1lPSJhcHAuanMiPgogKiAgIGFuZ3VsYXIubW9kdWxlKCdjb250cm9sbGVyRXhhbXBsZScsIFtdKQogKiAgICAgLmNvbnRyb2xsZXIoJ1NldHRpbmdzQ29udHJvbGxlcjInLCBbJyRzY29wZScsIFNldHRpbmdzQ29udHJvbGxlcjJdKTsKICoKICogICBmdW5jdGlvbiBTZXR0aW5nc0NvbnRyb2xsZXIyKCRzY29wZSkgewogKiAgICAgJHNjb3BlLm5hbWUgPSAiSm9obiBTbWl0aCI7CiAqICAgICAkc2NvcGUuY29udGFjdHMgPSBbCiAqICAgICAgIHt0eXBlOidwaG9uZScsIHZhbHVlOic0MDggNTU1IDEyMTInfSwKICogICAgICAge3R5cGU6J2VtYWlsJywgdmFsdWU6J2pvaG4uc21pdGhAZXhhbXBsZS5vcmcnfSBdOwogKgogKiAgICAgJHNjb3BlLmdyZWV0ID0gZnVuY3Rpb24oKSB7CiAqICAgICAgIGFsZXJ0KCRzY29wZS5uYW1lKTsKICogICAgIH07CiAqCiAqICAgICAkc2NvcGUuYWRkQ29udGFjdCA9IGZ1bmN0aW9uKCkgewogKiAgICAgICAkc2NvcGUuY29udGFjdHMucHVzaCh7dHlwZTonZW1haWwnLCB2YWx1ZToneW91cm5hbWVAZXhhbXBsZS5vcmcnfSk7CiAqICAgICB9OwogKgogKiAgICAgJHNjb3BlLnJlbW92ZUNvbnRhY3QgPSBmdW5jdGlvbihjb250YWN0VG9SZW1vdmUpIHsKICogICAgICAgdmFyIGluZGV4ID0gJHNjb3BlLmNvbnRhY3RzLmluZGV4T2YoY29udGFjdFRvUmVtb3ZlKTsKICogICAgICAgJHNjb3BlLmNvbnRhY3RzLnNwbGljZShpbmRleCwgMSk7CiAqICAgICB9OwogKgogKiAgICAgJHNjb3BlLmNsZWFyQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3QpIHsKICogICAgICAgY29udGFjdC50eXBlID0gJ3Bob25lJzsKICogICAgICAgY29udGFjdC52YWx1ZSA9ICcnOwogKiAgICAgfTsKICogICB9CiAqICA8L2ZpbGU+CiAqICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICogICAgaXQoJ3Nob3VsZCBjaGVjayBjb250cm9sbGVyJywgZnVuY3Rpb24oKSB7CiAqICAgICAgdmFyIGNvbnRhaW5lciA9IGVsZW1lbnQoYnkuaWQoJ2N0cmwtZXhtcGwnKSk7CiAqCiAqICAgICAgZXhwZWN0KGNvbnRhaW5lci5lbGVtZW50KGJ5Lm1vZGVsKCduYW1lJykpCiAqICAgICAgICAgIC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvQmUoJ0pvaG4gU21pdGgnKTsKICoKICogICAgICB2YXIgZmlyc3RSZXBlYXQgPQogKiAgICAgICAgICBjb250YWluZXIuZWxlbWVudChieS5yZXBlYXRlcignY29udGFjdCBpbiBjb250YWN0cycpLnJvdygwKSk7CiAqICAgICAgdmFyIHNlY29uZFJlcGVhdCA9CiAqICAgICAgICAgIGNvbnRhaW5lci5lbGVtZW50KGJ5LnJlcGVhdGVyKCdjb250YWN0IGluIGNvbnRhY3RzJykucm93KDEpKTsKICoKICogICAgICBleHBlY3QoZmlyc3RSZXBlYXQuZWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgIC50b0JlKCc0MDggNTU1IDEyMTInKTsKICogICAgICBleHBlY3Qoc2Vjb25kUmVwZWF0LmVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogKiAgICAgICAgICAudG9CZSgnam9obi5zbWl0aEBleGFtcGxlLm9yZycpOwogKgogKiAgICAgIGZpcnN0UmVwZWF0LmVsZW1lbnQoYnkubGlua1RleHQoJ2NsZWFyJykpLmNsaWNrKCk7CiAqCiAqICAgICAgZXhwZWN0KGZpcnN0UmVwZWF0LmVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogKiAgICAgICAgICAudG9CZSgnJyk7CiAqCiAqICAgICAgY29udGFpbmVyLmVsZW1lbnQoYnkubGlua1RleHQoJ2FkZCcpKS5jbGljaygpOwogKgogKiAgICAgIGV4cGVjdChjb250YWluZXIuZWxlbWVudChieS5yZXBlYXRlcignY29udGFjdCBpbiBjb250YWN0cycpLnJvdygyKSkKICogICAgICAgICAgLmVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkKICogICAgICAgICAgLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICogICAgICAgICAgLnRvQmUoJ3lvdXJuYW1lQGV4YW1wbGUub3JnJyk7CiAqICAgIH0pOwogKiAgPC9maWxlPgogKjwvZXhhbXBsZT4KCiAqLwp2YXIgbmdDb250cm9sbGVyRGlyZWN0aXZlID0gW2Z1bmN0aW9uKCkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgc2NvcGU6IHRydWUsCiAgICBjb250cm9sbGVyOiAnQCcsCiAgICBwcmlvcml0eTogNTAwCiAgfTsKfV07CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0NzcAogKgogKiBAZWxlbWVudCBodG1sCiAqIEBkZXNjcmlwdGlvbgogKiBFbmFibGVzIFtDU1AgKENvbnRlbnQgU2VjdXJpdHkgUG9saWN5KV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vU2VjdXJpdHkvQ1NQKSBzdXBwb3J0LgogKgogKiBUaGlzIGlzIG5lY2Vzc2FyeSB3aGVuIGRldmVsb3BpbmcgdGhpbmdzIGxpa2UgR29vZ2xlIENocm9tZSBFeHRlbnNpb25zIG9yIFVuaXZlcnNhbCBXaW5kb3dzIEFwcHMuCiAqCiAqIENTUCBmb3JiaWRzIGFwcHMgdG8gdXNlIGBldmFsYCBvciBgRnVuY3Rpb24oc3RyaW5nKWAgZ2VuZXJhdGVkIGZ1bmN0aW9ucyAoYW1vbmcgb3RoZXIgdGhpbmdzKS4KICogRm9yIEFuZ3VsYXIgdG8gYmUgQ1NQIGNvbXBhdGlibGUgdGhlcmUgYXJlIG9ubHkgdHdvIHRoaW5ncyB0aGF0IHdlIG5lZWQgdG8gZG8gZGlmZmVyZW50bHk6CiAqCiAqIC0gZG9uJ3QgdXNlIGBGdW5jdGlvbmAgY29uc3RydWN0b3IgdG8gZ2VuZXJhdGUgb3B0aW1pemVkIHZhbHVlIGdldHRlcnMKICogLSBkb24ndCBpbmplY3QgY3VzdG9tIHN0eWxlc2hlZXQgaW50byB0aGUgZG9jdW1lbnQKICoKICogQW5ndWxhckpTIHVzZXMgYEZ1bmN0aW9uKHN0cmluZylgIGdlbmVyYXRlZCBmdW5jdGlvbnMgYXMgYSBzcGVlZCBvcHRpbWl6YXRpb24uIEFwcGx5aW5nIHRoZSBgbmdDc3BgCiAqIGRpcmVjdGl2ZSB3aWxsIGNhdXNlIEFuZ3VsYXIgdG8gdXNlIENTUCBjb21wYXRpYmlsaXR5IG1vZGUuIFdoZW4gdGhpcyBtb2RlIGlzIG9uIEFuZ3VsYXJKUyB3aWxsCiAqIGV2YWx1YXRlIGFsbCBleHByZXNzaW9ucyB1cCB0byAzMCUgc2xvd2VyIHRoYW4gaW4gbm9uLUNTUCBtb2RlLCBidXQgbm8gc2VjdXJpdHkgdmlvbGF0aW9ucyB3aWxsCiAqIGJlIHJhaXNlZC4KICoKICogQ1NQIGZvcmJpZHMgSmF2YVNjcmlwdCB0byBpbmxpbmUgc3R5bGVzaGVldCBydWxlcy4gSW4gbm9uIENTUCBtb2RlIEFuZ3VsYXIgYXV0b21hdGljYWxseQogKiBpbmNsdWRlcyBzb21lIENTUyBydWxlcyAoZS5nLiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xvYWsgbmdDbG9ha30pLgogKiBUbyBtYWtlIHRob3NlIGRpcmVjdGl2ZXMgd29yayBpbiBDU1AgbW9kZSwgaW5jbHVkZSB0aGUgYGFuZ3VsYXItY3NwLmNzc2AgbWFudWFsbHkuCiAqCiAqIEFuZ3VsYXIgdHJpZXMgdG8gYXV0b2RldGVjdCBpZiBDU1AgaXMgYWN0aXZlIGFuZCBhdXRvbWF0aWNhbGx5IHR1cm4gb24gdGhlIENTUC1zYWZlIG1vZGUuIFRoaXMKICogYXV0b2RldGVjdGlvbiBob3dldmVyIHRyaWdnZXJzIGEgQ1NQIGVycm9yIHRvIGJlIGxvZ2dlZCBpbiB0aGUgY29uc29sZToKICoKICogYGBgCiAqIFJlZnVzZWQgdG8gZXZhbHVhdGUgYSBzdHJpbmcgYXMgSmF2YVNjcmlwdCBiZWNhdXNlICd1bnNhZmUtZXZhbCcgaXMgbm90IGFuIGFsbG93ZWQgc291cmNlIG9mCiAqIHNjcmlwdCBpbiB0aGUgZm9sbG93aW5nIENvbnRlbnQgU2VjdXJpdHkgUG9saWN5IGRpcmVjdGl2ZTogImRlZmF1bHQtc3JjICdzZWxmJyIuIE5vdGUgdGhhdAogKiAnc2NyaXB0LXNyYycgd2FzIG5vdCBleHBsaWNpdGx5IHNldCwgc28gJ2RlZmF1bHQtc3JjJyBpcyB1c2VkIGFzIGEgZmFsbGJhY2suCiAqIGBgYAogKgogKiBUaGlzIGVycm9yIGlzIGhhcm1sZXNzIGJ1dCBhbm5veWluZy4gVG8gcHJldmVudCB0aGUgZXJyb3IgZnJvbSBzaG93aW5nIHVwLCBwdXQgdGhlIGBuZ0NzcGAKICogZGlyZWN0aXZlIG9uIHRoZSByb290IGVsZW1lbnQgb2YgdGhlIGFwcGxpY2F0aW9uIG9yIG9uIHRoZSBgYW5ndWxhci5qc2Agc2NyaXB0IHRhZywgd2hpY2hldmVyCiAqIGFwcGVhcnMgZmlyc3QgaW4gdGhlIGh0bWwgZG9jdW1lbnQuCiAqCiAqICpOb3RlOiBUaGlzIGRpcmVjdGl2ZSBpcyBvbmx5IGF2YWlsYWJsZSBpbiB0aGUgYG5nLWNzcGAgYW5kIGBkYXRhLW5nLWNzcGAgYXR0cmlidXRlIGZvcm0uKgogKgogKiBAZXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IHRvIGFwcGx5IHRoZSBgbmdDc3BgIGRpcmVjdGl2ZSB0byB0aGUgYGh0bWxgIHRhZy4KICAgYGBgaHRtbAogICAgIDwhZG9jdHlwZSBodG1sPgogICAgIDxodG1sIG5nLWFwcCBuZy1jc3A+CiAgICAgLi4uCiAgICAgLi4uCiAgICAgPC9odG1sPgogICBgYGAKICAqIEBleGFtcGxlCiAgICAgIC8vIE5vdGU6IHRoZSBzdWZmaXggYC5jc3BgIGluIHRoZSBleGFtcGxlIG5hbWUgdHJpZ2dlcnMKICAgICAgLy8gY3NwIG1vZGUgaW4gb3VyIGh0dHAgc2VydmVyIQogICAgICA8ZXhhbXBsZSBuYW1lPSJleGFtcGxlLmNzcCIgbW9kdWxlPSJjc3BFeGFtcGxlIiBuZy1jc3A9InRydWUiPgogICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJNYWluQ29udHJvbGxlciBhcyBjdHJsIj4KICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJjdHJsLmluYygpIiBpZD0iaW5jIj5JbmNyZW1lbnQ8L2J1dHRvbj4KICAgICAgICAgICAgICA8c3BhbiBpZD0iY291bnRlciI+CiAgICAgICAgICAgICAgICB7e2N0cmwuY291bnRlcn19CiAgICAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iY3RybC5ldmlsKCkiIGlkPSJldmlsIj5FdmlsPC9idXR0b24+CiAgICAgICAgICAgICAgPHNwYW4gaWQ9ImV2aWxFcnJvciI+CiAgICAgICAgICAgICAgICB7e2N0cmwuZXZpbEVycm9yfX0KICAgICAgICAgICAgICA8L3NwYW4+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ2NzcEV4YW1wbGUnLCBbXSkKICAgICAgICAgICAgIC5jb250cm9sbGVyKCdNYWluQ29udHJvbGxlcicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhpcy5jb3VudGVyID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuaW5jID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuY291bnRlcisrOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHRoaXMuZXZpbCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAvLyBqc2hpbnQgZXZpbDp0cnVlCiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZXZhbCgnMSsyJyk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV2aWxFcnJvciA9IGUubWVzc2FnZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgICB2YXIgdXRpbCwgd2ViZHJpdmVyOwoKICAgICAgICAgIHZhciBpbmNCdG4gPSBlbGVtZW50KGJ5LmlkKCdpbmMnKSk7CiAgICAgICAgICB2YXIgY291bnRlciA9IGVsZW1lbnQoYnkuaWQoJ2NvdW50ZXInKSk7CiAgICAgICAgICB2YXIgZXZpbEJ0biA9IGVsZW1lbnQoYnkuaWQoJ2V2aWwnKSk7CiAgICAgICAgICB2YXIgZXZpbEVycm9yID0gZWxlbWVudChieS5pZCgnZXZpbEVycm9yJykpOwoKICAgICAgICAgIGZ1bmN0aW9uIGdldEFuZENsZWFyU2V2ZXJlRXJyb3JzKCkgewogICAgICAgICAgICByZXR1cm4gYnJvd3Nlci5tYW5hZ2UoKS5sb2dzKCkuZ2V0KCdicm93c2VyJykudGhlbihmdW5jdGlvbihicm93c2VyTG9nKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGJyb3dzZXJMb2cuZmlsdGVyKGZ1bmN0aW9uKGxvZ0VudHJ5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbG9nRW50cnkubGV2ZWwudmFsdWUgPiB3ZWJkcml2ZXIubG9nZ2luZy5MZXZlbC5XQVJOSU5HLnZhbHVlOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBjbGVhckVycm9ycygpIHsKICAgICAgICAgICAgZ2V0QW5kQ2xlYXJTZXZlcmVFcnJvcnMoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBleHBlY3ROb0Vycm9ycygpIHsKICAgICAgICAgICAgZ2V0QW5kQ2xlYXJTZXZlcmVFcnJvcnMoKS50aGVuKGZ1bmN0aW9uKGZpbHRlcmVkTG9nKSB7CiAgICAgICAgICAgICAgZXhwZWN0KGZpbHRlcmVkTG9nLmxlbmd0aCkudG9FcXVhbCgwKTsKICAgICAgICAgICAgICBpZiAoZmlsdGVyZWRMb2cubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnYnJvd3NlciBjb25zb2xlIGVycm9yczogJyArIHV0aWwuaW5zcGVjdChmaWx0ZXJlZExvZykpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gZXhwZWN0RXJyb3IocmVnZXgpIHsKICAgICAgICAgICAgZ2V0QW5kQ2xlYXJTZXZlcmVFcnJvcnMoKS50aGVuKGZ1bmN0aW9uKGZpbHRlcmVkTG9nKSB7CiAgICAgICAgICAgICAgdmFyIGZvdW5kID0gZmFsc2U7CiAgICAgICAgICAgICAgZmlsdGVyZWRMb2cuZm9yRWFjaChmdW5jdGlvbihsb2cpIHsKICAgICAgICAgICAgICAgIGlmIChsb2cubWVzc2FnZS5tYXRjaChyZWdleCkpIHsKICAgICAgICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignZXhwZWN0ZWQgYW4gZXJyb3IgdGhhdCBtYXRjaGVzICcgKyByZWdleCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBiZWZvcmVFYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1dGlsID0gcmVxdWlyZSgndXRpbCcpOwogICAgICAgICAgICB3ZWJkcml2ZXIgPSByZXF1aXJlKCdwcm90cmFjdG9yL25vZGVfbW9kdWxlcy9zZWxlbml1bS13ZWJkcml2ZXInKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIEZvciBub3csIHdlIG9ubHkgdGVzdCBvbiBDaHJvbWUsCiAgICAgICAgICAvLyBhcyBTYWZhcmkgZG9lcyBub3QgbG9hZCB0aGUgcGFnZSB3aXRoIFByb3RyYWN0b3IncyBpbmplY3RlZCBzY3JpcHRzLAogICAgICAgICAgLy8gYW5kIEZpcmVmb3ggd2ViZHJpdmVyIGFsd2F5cyBkaXNhYmxlcyBjb250ZW50IHNlY3VyaXR5IHBvbGljeSAoIzYzNTgpCiAgICAgICAgICBpZiAoYnJvd3Nlci5wYXJhbXMuYnJvd3NlciAhPT0gJ2Nocm9tZScpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGl0KCdzaG91bGQgbm90IHJlcG9ydCBlcnJvcnMgd2hlbiB0aGUgcGFnZSBpcyBsb2FkZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gY2xlYXIgZXJyb3JzIHNvIHdlIGFyZSBub3QgZGVwZW5kZW50IG9uIHByZXZpb3VzIHRlc3RzCiAgICAgICAgICAgIGNsZWFyRXJyb3JzKCk7CiAgICAgICAgICAgIC8vIE5lZWQgdG8gcmVsb2FkIHRoZSBwYWdlIGFzIHRoZSBwYWdlIGlzIGFscmVhZHkgbG9hZGVkIHdoZW4KICAgICAgICAgICAgLy8gd2UgY29tZSBoZXJlCiAgICAgICAgICAgIGJyb3dzZXIuZHJpdmVyLmdldEN1cnJlbnRVcmwoKS50aGVuKGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICAgIGJyb3dzZXIuZ2V0KHVybCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBleHBlY3ROb0Vycm9ycygpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCBldmFsdWF0ZSBleHByZXNzaW9ucycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoY291bnRlci5nZXRUZXh0KCkpLnRvRXF1YWwoJzAnKTsKICAgICAgICAgICAgaW5jQnRuLmNsaWNrKCk7CiAgICAgICAgICAgIGV4cGVjdChjb3VudGVyLmdldFRleHQoKSkudG9FcXVhbCgnMScpOwogICAgICAgICAgICBleHBlY3ROb0Vycm9ycygpOwogICAgICAgICAgfSk7CgogICAgICAgICAgaXQoJ3Nob3VsZCB0aHJvdyBhbmQgcmVwb3J0IGFuIGVycm9yIHdoZW4gdXNpbmcgImV2YWwiJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV2aWxCdG4uY2xpY2soKTsKICAgICAgICAgICAgZXhwZWN0KGV2aWxFcnJvci5nZXRUZXh0KCkpLnRvTWF0Y2goL0NvbnRlbnQgU2VjdXJpdHkgUG9saWN5Lyk7CiAgICAgICAgICAgIGV4cGVjdEVycm9yKC9Db250ZW50IFNlY3VyaXR5IFBvbGljeS8pOwogICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgKi8KCi8vIG5nQ3NwIGlzIG5vdCBpbXBsZW1lbnRlZCBhcyBhIHByb3BlciBkaXJlY3RpdmUgYW55IG1vcmUsIGJlY2F1c2Ugd2UgbmVlZCBpdCBiZSBwcm9jZXNzZWQgd2hpbGUgd2UKLy8gYm9vdHN0cmFwIHRoZSBzeXN0ZW0gKGJlZm9yZSAkcGFyc2UgaXMgaW5zdGFudGlhdGVkKSwgZm9yIHRoaXMgcmVhc29uIHdlIGp1c3QgaGF2ZQovLyB0aGUgY3NwLmlzQWN0aXZlKCkgZm4gdGhhdCBsb29rcyBmb3IgbmctY3NwIGF0dHJpYnV0ZSBhbnl3aGVyZSBpbiB0aGUgY3VycmVudCBkb2MKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQ2xpY2sKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBuZ0NsaWNrIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIHdoZW4KICogYW4gZWxlbWVudCBpcyBjbGlja2VkLgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsaWNrIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogY2xpY2suICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgIEluY3JlbWVudAogICAgICA8L2J1dHRvbj4KICAgICAgPHNwYW4+CiAgICAgICAgY291bnQ6IHt7Y291bnR9fQogICAgICA8L3NwYW4+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdjb3VudCcpKS5nZXRUZXh0KCkpLnRvTWF0Y2goJzAnKTsKICAgICAgICAgZWxlbWVudChieS5jc3MoJ2J1dHRvbicpKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdjb3VudCcpKS5nZXRUZXh0KCkpLnRvTWF0Y2goJzEnKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KLyoKICogQSBkaXJlY3RpdmUgdGhhdCBhbGxvd3MgY3JlYXRpb24gb2YgY3VzdG9tIG9uY2xpY2sgaGFuZGxlcnMgdGhhdCBhcmUgZGVmaW5lZCBhcyBhbmd1bGFyCiAqIGV4cHJlc3Npb25zIGFuZCBhcmUgY29tcGlsZWQgYW5kIGV4ZWN1dGVkIHdpdGhpbiB0aGUgY3VycmVudCBzY29wZS4KICoKICogRXZlbnRzIHRoYXQgYXJlIGhhbmRsZWQgdmlhIHRoZXNlIGhhbmRsZXIgYXJlIGFsd2F5cyBjb25maWd1cmVkIG5vdCB0byBwcm9wYWdhdGUgZnVydGhlci4KICovCnZhciBuZ0V2ZW50RGlyZWN0aXZlcyA9IHt9OwoKLy8gRm9yIGV2ZW50cyB0aGF0IG1pZ2h0IGZpcmUgc3luY2hyb25vdXNseSBkdXJpbmcgRE9NIG1hbmlwdWxhdGlvbgovLyB3ZSBuZWVkIHRvIGV4ZWN1dGUgdGhlaXIgZXZlbnQgaGFuZGxlcnMgYXN5bmNocm9ub3VzbHkgdXNpbmcgJGV2YWxBc3luYywKLy8gc28gdGhhdCB0aGV5IGFyZSBub3QgZXhlY3V0ZWQgaW4gYW4gaW5jb25zaXN0ZW50IHN0YXRlLgp2YXIgZm9yY2VBc3luY0V2ZW50cyA9IHsKICAnYmx1cic6IHRydWUsCiAgJ2ZvY3VzJzogdHJ1ZQp9Owpmb3JFYWNoKAogICdjbGljayBkYmxjbGljayBtb3VzZWRvd24gbW91c2V1cCBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2Vtb3ZlIG1vdXNlZW50ZXIgbW91c2VsZWF2ZSBrZXlkb3duIGtleXVwIGtleXByZXNzIHN1Ym1pdCBmb2N1cyBibHVyIGNvcHkgY3V0IHBhc3RlJy5zcGxpdCgnICcpLAogIGZ1bmN0aW9uKGV2ZW50TmFtZSkgewogICAgdmFyIGRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBldmVudE5hbWUpOwogICAgbmdFdmVudERpcmVjdGl2ZXNbZGlyZWN0aXZlTmFtZV0gPSBbJyRwYXJzZScsICckcm9vdFNjb3BlJywgZnVuY3Rpb24oJHBhcnNlLCAkcm9vdFNjb3BlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgYXR0cikgewogICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGF0dHJbZGlyZWN0aXZlTmFtZV0pOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIG5nRXZlbnRIYW5kbGVyKHNjb3BlLCBlbGVtZW50KSB7CiAgICAgICAgICAgIGVsZW1lbnQub24oZXZlbnROYW1lLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZm4oc2NvcGUsIHskZXZlbnQ6ZXZlbnR9KTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChmb3JjZUFzeW5jRXZlbnRzW2V2ZW50TmFtZV0gJiYgJHJvb3RTY29wZS4kJHBoYXNlKSB7CiAgICAgICAgICAgICAgICBzY29wZS4kZXZhbEFzeW5jKGNhbGxiYWNrKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGNhbGxiYWNrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH07CiAgICB9XTsKICB9Cik7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0RibGNsaWNrCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nRGJsY2xpY2tgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGEgZGJsY2xpY2sgZXZlbnQuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nRGJsY2xpY2sge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBhIGRibGNsaWNrLiAoVGhlIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8YnV0dG9uIG5nLWRibGNsaWNrPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgICAgICAgSW5jcmVtZW50IChvbiBkb3VibGUgY2xpY2spCiAgICAgIDwvYnV0dG9uPgogICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nTW91c2Vkb3duCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgbmdNb3VzZWRvd24gZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2Vkb3duIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlZG93biB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIG1vdXNlZG93bi4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8YnV0dG9uIG5nLW1vdXNlZG93bj0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgIEluY3JlbWVudCAob24gbW91c2UgZG93bikKICAgICAgPC9idXR0b24+CiAgICAgIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdNb3VzZXVwCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZXVwIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNldXAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBtb3VzZXVwLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxidXR0b24gbmctbW91c2V1cD0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgIEluY3JlbWVudCAob24gbW91c2UgdXApCiAgICAgIDwvYnV0dG9uPgogICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdNb3VzZW92ZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlb3ZlciBldmVudC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZW92ZXIge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBtb3VzZW92ZXIuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGJ1dHRvbiBuZy1tb3VzZW92ZXI9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAgICBJbmNyZW1lbnQgKHdoZW4gbW91c2UgaXMgb3ZlcikKICAgICAgPC9idXR0b24+CiAgICAgIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdNb3VzZWVudGVyCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWVudGVyIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlZW50ZXIge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBtb3VzZWVudGVyLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxidXR0b24gbmctbW91c2VlbnRlcj0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgIEluY3JlbWVudCAod2hlbiBtb3VzZSBlbnRlcnMpCiAgICAgIDwvYnV0dG9uPgogICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nTW91c2VsZWF2ZQogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VsZWF2ZSBldmVudC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWxlYXZlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogbW91c2VsZWF2ZS4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8YnV0dG9uIG5nLW1vdXNlbGVhdmU9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAgICBJbmNyZW1lbnQgKHdoZW4gbW91c2UgbGVhdmVzKQogICAgICA8L2J1dHRvbj4KICAgICAgY291bnQ6IHt7Y291bnR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ01vdXNlbW92ZQogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2Vtb3ZlIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlbW92ZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIG1vdXNlbW92ZS4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8YnV0dG9uIG5nLW1vdXNlbW92ZT0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgIEluY3JlbWVudCAod2hlbiBtb3VzZSBtb3ZlcykKICAgICAgPC9idXR0b24+CiAgICAgIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdLZXlkb3duCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBrZXlkb3duIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHByaW9yaXR5IDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleWRvd24ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBrZXlkb3duLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCBhbmQgY2FuIGJlIGludGVycm9nYXRlZCBmb3Iga2V5Q29kZSwgYWx0S2V5LCBldGMuKQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGlucHV0IG5nLWtleWRvd249ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAga2V5IGRvd24gY291bnQ6IHt7Y291bnR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0tleXVwCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBrZXl1cCBldmVudC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdLZXl1cCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIGtleXVwLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCBhbmQgY2FuIGJlIGludGVycm9nYXRlZCBmb3Iga2V5Q29kZSwgYWx0S2V5LCBldGMuKQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgIDxwPlR5cGluZyBpbiB0aGUgaW5wdXQgYm94IGJlbG93IHVwZGF0ZXMgdGhlIGtleSBjb3VudDwvcD4KICAgICAgIDxpbnB1dCBuZy1rZXl1cD0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPiBrZXkgdXAgY291bnQ6IHt7Y291bnR9fQoKICAgICAgIDxwPlR5cGluZyBpbiB0aGUgaW5wdXQgYm94IGJlbG93IHVwZGF0ZXMgdGhlIGtleWNvZGU8L3A+CiAgICAgICA8aW5wdXQgbmcta2V5dXA9ImV2ZW50PSRldmVudCI+CiAgICAgICA8cD5ldmVudCBrZXlDb2RlOiB7eyBldmVudC5rZXlDb2RlIH19PC9wPgogICAgICAgPHA+ZXZlbnQgYWx0S2V5OiB7eyBldmVudC5hbHRLZXkgfX08L3A+CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqLwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nS2V5cHJlc3MKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGtleXByZXNzIGV2ZW50LgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleXByZXNzIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICoga2V5cHJlc3MuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9CiAqIGFuZCBjYW4gYmUgaW50ZXJyb2dhdGVkIGZvciBrZXlDb2RlLCBhbHRLZXksIGV0Yy4pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8aW5wdXQgbmcta2V5cHJlc3M9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICAga2V5IHByZXNzIGNvdW50OiB7e2NvdW50fX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdTdWJtaXQKICoKICogQGRlc2NyaXB0aW9uCiAqIEVuYWJsZXMgYmluZGluZyBhbmd1bGFyIGV4cHJlc3Npb25zIHRvIG9uc3VibWl0IGV2ZW50cy4KICoKICogQWRkaXRpb25hbGx5IGl0IHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAod2hpY2ggZm9yIGZvcm0gbWVhbnMgc2VuZGluZyB0aGUgcmVxdWVzdCB0byB0aGUKICogc2VydmVyIGFuZCByZWxvYWRpbmcgdGhlIGN1cnJlbnQgcGFnZSksIGJ1dCBvbmx5IGlmIHRoZSBmb3JtIGRvZXMgbm90IGNvbnRhaW4gYGFjdGlvbmAsCiAqIGBkYXRhLWFjdGlvbmAsIG9yIGB4LWFjdGlvbmAgYXR0cmlidXRlcy4KICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAqICoqV2FybmluZzoqKiBCZSBjYXJlZnVsIG5vdCB0byBjYXVzZSAiZG91YmxlLXN1Ym1pc3Npb24iIGJ5IHVzaW5nIGJvdGggdGhlIGBuZ0NsaWNrYCBhbmQKICogYG5nU3VibWl0YCBoYW5kbGVycyB0b2dldGhlci4gU2VlIHRoZQogKiB7QGxpbmsgZm9ybSNzdWJtaXR0aW5nLWEtZm9ybS1hbmQtcHJldmVudGluZy10aGUtZGVmYXVsdC1hY3Rpb24gYGZvcm1gIGRpcmVjdGl2ZSBkb2N1bWVudGF0aW9ufQogKiBmb3IgYSBkZXRhaWxlZCBkaXNjdXNzaW9uIG9mIHdoZW4gYG5nU3VibWl0YCBtYXkgYmUgdHJpZ2dlcmVkLgogKiA8L2Rpdj4KICoKICogQGVsZW1lbnQgZm9ybQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU3VibWl0IHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuCiAqICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9InN1Ym1pdEV4YW1wbGUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8c2NyaXB0PgogICAgICAgIGFuZ3VsYXIubW9kdWxlKCdzdWJtaXRFeGFtcGxlJywgW10pCiAgICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAkc2NvcGUubGlzdCA9IFtdOwogICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdoZWxsbyc7CiAgICAgICAgICAgICRzY29wZS5zdWJtaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoJHNjb3BlLnRleHQpIHsKICAgICAgICAgICAgICAgICRzY29wZS5saXN0LnB1c2godGhpcy50ZXh0KTsKICAgICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJyc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfV0pOwogICAgICA8L3NjcmlwdD4KICAgICAgPGZvcm0gbmctc3VibWl0PSJzdWJtaXQoKSIgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgIEVudGVyIHRleHQgYW5kIGhpdCBlbnRlcjoKICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InRleHQiIG5hbWU9InRleHQiIC8+CiAgICAgICAgPGlucHV0IHR5cGU9InN1Ym1pdCIgaWQ9InN1Ym1pdCIgdmFsdWU9IlN1Ym1pdCIgLz4KICAgICAgICA8cHJlPmxpc3Q9e3tsaXN0fX08L3ByZT4KICAgICAgPC9mb3JtPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctc3VibWl0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2xpc3QnKSkuZ2V0VGV4dCgpKS50b0JlKCdsaXN0PVtdJyk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCcjc3VibWl0JykpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2xpc3QnKSkuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2hlbGxvJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5Lm1vZGVsKCd0ZXh0JykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9CZSgnJyk7CiAgICAgICB9KTsKICAgICAgIGl0KCdzaG91bGQgaWdub3JlIGVtcHR5IHN0cmluZ3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnbGlzdCcpKS5nZXRUZXh0KCkpLnRvQmUoJ2xpc3Q9W10nKTsKICAgICAgICAgZWxlbWVudChieS5jc3MoJyNzdWJtaXQnKSkuY2xpY2soKTsKICAgICAgICAgZWxlbWVudChieS5jc3MoJyNzdWJtaXQnKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnbGlzdCcpKS5nZXRUZXh0KCkpLnRvQ29udGFpbignaGVsbG8nKTsKICAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0ZvY3VzCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBmb2N1cyBldmVudC4KICoKICogTm90ZTogQXMgdGhlIGBmb2N1c2AgZXZlbnQgaXMgZXhlY3V0ZWQgc3luY2hyb25vdXNseSB3aGVuIGNhbGxpbmcgYGlucHV0LmZvY3VzKClgCiAqIEFuZ3VsYXJKUyBleGVjdXRlcyB0aGUgZXhwcmVzc2lvbiB1c2luZyBgc2NvcGUuJGV2YWxBc3luY2AgaWYgdGhlIGV2ZW50IGlzIGZpcmVkCiAqIGR1cmluZyBhbiBgJGFwcGx5YCB0byBlbnN1cmUgYSBjb25zaXN0ZW50IHN0YXRlLgogKgogKiBAZWxlbWVudCB3aW5kb3csIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdGb2N1cyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIGZvY3VzLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogKi8KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nQmx1cgogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gYmx1ciBldmVudC4KICoKICogQSBbYmx1ciBldmVudF0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvRXZlbnRzL2JsdXIpIGZpcmVzIHdoZW4KICogYW4gZWxlbWVudCBoYXMgbG9zdCBmb2N1cy4KICoKICogTm90ZTogQXMgdGhlIGBibHVyYCBldmVudCBpcyBleGVjdXRlZCBzeW5jaHJvbm91c2x5IGFsc28gZHVyaW5nIERPTSBtYW5pcHVsYXRpb25zCiAqIChlLmcuIHJlbW92aW5nIGEgZm9jdXNzZWQgaW5wdXQpLAogKiBBbmd1bGFySlMgZXhlY3V0ZXMgdGhlIGV4cHJlc3Npb24gdXNpbmcgYHNjb3BlLiRldmFsQXN5bmNgIGlmIHRoZSBldmVudCBpcyBmaXJlZAogKiBkdXJpbmcgYW4gYCRhcHBseWAgdG8gZW5zdXJlIGEgY29uc2lzdGVudCBzdGF0ZS4KICoKICogQGVsZW1lbnQgd2luZG93LCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYQogKiBAcHJpb3JpdHkgMAogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmx1ciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIGJsdXIuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAqLwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdDb3B5CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBjb3B5IGV2ZW50LgogKgogKiBAZWxlbWVudCB3aW5kb3csIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDb3B5IHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogY29weS4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8aW5wdXQgbmctY29weT0iY29waWVkPXRydWUiIG5nLWluaXQ9ImNvcGllZD1mYWxzZTsgdmFsdWU9J2NvcHkgbWUnIiBuZy1tb2RlbD0idmFsdWUiPgogICAgICBjb3BpZWQ6IHt7Y29waWVkfX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0N1dAogKgogKiBAZGVzY3JpcHRpb24KICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gY3V0IGV2ZW50LgogKgogKiBAZWxlbWVudCB3aW5kb3csIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDdXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBjdXQuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKgogKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPGlucHV0IG5nLWN1dD0iY3V0PXRydWUiIG5nLWluaXQ9ImN1dD1mYWxzZTsgdmFsdWU9J2N1dCBtZSciIG5nLW1vZGVsPSJ2YWx1ZSI+CiAgICAgIGN1dDoge3tjdXR9fQogICAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogKi8KCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nUGFzdGUKICoKICogQGRlc2NyaXB0aW9uCiAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIHBhc3RlIGV2ZW50LgogKgogKiBAZWxlbWVudCB3aW5kb3csIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhCiAqIEBwcmlvcml0eSAwCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdQYXN0ZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAqIHBhc3RlLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxpbnB1dCBuZy1wYXN0ZT0icGFzdGU9dHJ1ZSIgbmctaW5pdD0icGFzdGU9ZmFsc2UiIHBsYWNlaG9sZGVyPSdwYXN0ZSBoZXJlJz4KICAgICAgcGFzdGVkOiB7e3Bhc3RlfX0KICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ0lmCiAqIEByZXN0cmljdCBBCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nSWZgIGRpcmVjdGl2ZSByZW1vdmVzIG9yIHJlY3JlYXRlcyBhIHBvcnRpb24gb2YgdGhlIERPTSB0cmVlIGJhc2VkIG9uIGFuCiAqIHtleHByZXNzaW9ufS4gSWYgdGhlIGV4cHJlc3Npb24gYXNzaWduZWQgdG8gYG5nSWZgIGV2YWx1YXRlcyB0byBhIGZhbHNlCiAqIHZhbHVlIHRoZW4gdGhlIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBET00sIG90aGVyd2lzZSBhIGNsb25lIG9mIHRoZQogKiBlbGVtZW50IGlzIHJlaW5zZXJ0ZWQgaW50byB0aGUgRE9NLgogKgogKiBgbmdJZmAgZGlmZmVycyBmcm9tIGBuZ1Nob3dgIGFuZCBgbmdIaWRlYCBpbiB0aGF0IGBuZ0lmYCBjb21wbGV0ZWx5IHJlbW92ZXMgYW5kIHJlY3JlYXRlcyB0aGUKICogZWxlbWVudCBpbiB0aGUgRE9NIHJhdGhlciB0aGFuIGNoYW5naW5nIGl0cyB2aXNpYmlsaXR5IHZpYSB0aGUgYGRpc3BsYXlgIGNzcyBwcm9wZXJ0eS4gIEEgY29tbW9uCiAqIGNhc2Ugd2hlbiB0aGlzIGRpZmZlcmVuY2UgaXMgc2lnbmlmaWNhbnQgaXMgd2hlbiB1c2luZyBjc3Mgc2VsZWN0b3JzIHRoYXQgcmVseSBvbiBhbiBlbGVtZW50J3MKICogcG9zaXRpb24gd2l0aGluIHRoZSBET00sIHN1Y2ggYXMgdGhlIGA6Zmlyc3QtY2hpbGRgIG9yIGA6bGFzdC1jaGlsZGAgcHNldWRvLWNsYXNzZXMuCiAqCiAqIE5vdGUgdGhhdCB3aGVuIGFuIGVsZW1lbnQgaXMgcmVtb3ZlZCB1c2luZyBgbmdJZmAgaXRzIHNjb3BlIGlzIGRlc3Ryb3llZCBhbmQgYSBuZXcgc2NvcGUKICogaXMgY3JlYXRlZCB3aGVuIHRoZSBlbGVtZW50IGlzIHJlc3RvcmVkLiAgVGhlIHNjb3BlIGNyZWF0ZWQgd2l0aGluIGBuZ0lmYCBpbmhlcml0cyBmcm9tCiAqIGl0cyBwYXJlbnQgc2NvcGUgdXNpbmcKICogW3Byb3RvdHlwYWwgaW5oZXJpdGFuY2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvd2lraS9VbmRlcnN0YW5kaW5nLVNjb3BlcyNqYXZhc2NyaXB0LXByb3RvdHlwYWwtaW5oZXJpdGFuY2UpLgogKiBBbiBpbXBvcnRhbnQgaW1wbGljYXRpb24gb2YgdGhpcyBpcyBpZiBgbmdNb2RlbGAgaXMgdXNlZCB3aXRoaW4gYG5nSWZgIHRvIGJpbmQgdG8KICogYSBqYXZhc2NyaXB0IHByaW1pdGl2ZSBkZWZpbmVkIGluIHRoZSBwYXJlbnQgc2NvcGUuIEluIHRoaXMgY2FzZSBhbnkgbW9kaWZpY2F0aW9ucyBtYWRlIHRvIHRoZQogKiB2YXJpYWJsZSB3aXRoaW4gdGhlIGNoaWxkIHNjb3BlIHdpbGwgb3ZlcnJpZGUgKGhpZGUpIHRoZSB2YWx1ZSBpbiB0aGUgcGFyZW50IHNjb3BlLgogKgogKiBBbHNvLCBgbmdJZmAgcmVjcmVhdGVzIGVsZW1lbnRzIHVzaW5nIHRoZWlyIGNvbXBpbGVkIHN0YXRlLiBBbiBleGFtcGxlIG9mIHRoaXMgYmVoYXZpb3IKICogaXMgaWYgYW4gZWxlbWVudCdzIGNsYXNzIGF0dHJpYnV0ZSBpcyBkaXJlY3RseSBtb2RpZmllZCBhZnRlciBpdCdzIGNvbXBpbGVkLCB1c2luZyBzb21ldGhpbmcgbGlrZQogKiBqUXVlcnkncyBgLmFkZENsYXNzKClgIG1ldGhvZCwgYW5kIHRoZSBlbGVtZW50IGlzIGxhdGVyIHJlbW92ZWQuIFdoZW4gYG5nSWZgIHJlY3JlYXRlcyB0aGUgZWxlbWVudAogKiB0aGUgYWRkZWQgY2xhc3Mgd2lsbCBiZSBsb3N0IGJlY2F1c2UgdGhlIG9yaWdpbmFsIGNvbXBpbGVkIHN0YXRlIGlzIHVzZWQgdG8gcmVnZW5lcmF0ZSB0aGUgZWxlbWVudC4KICoKICogQWRkaXRpb25hbGx5LCB5b3UgY2FuIHByb3ZpZGUgYW5pbWF0aW9ucyB2aWEgdGhlIGBuZ0FuaW1hdGVgIG1vZHVsZSB0byBhbmltYXRlIHRoZSBgZW50ZXJgCiAqIGFuZCBgbGVhdmVgIGVmZmVjdHMuCiAqCiAqIEBhbmltYXRpb25zCiAqIGVudGVyIC0gaGFwcGVucyBqdXN0IGFmdGVyIHRoZSBgbmdJZmAgY29udGVudHMgY2hhbmdlIGFuZCBhIG5ldyBET00gZWxlbWVudCBpcyBjcmVhdGVkIGFuZCBpbmplY3RlZCBpbnRvIHRoZSBgbmdJZmAgY29udGFpbmVyCiAqIGxlYXZlIC0gaGFwcGVucyBqdXN0IGJlZm9yZSB0aGUgYG5nSWZgIGNvbnRlbnRzIGFyZSByZW1vdmVkIGZyb20gdGhlIERPTQogKgogKiBAZWxlbWVudCBBTlkKICogQHNjb3BlCiAqIEBwcmlvcml0eSA2MDAKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0lmIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyBmYWxzeSB0aGVuCiAqICAgICB0aGUgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTSB0cmVlLiBJZiBpdCBpcyB0cnV0aHkgYSBjb3B5IG9mIHRoZSBjb21waWxlZAogKiAgICAgZWxlbWVudCBpcyBhZGRlZCB0byB0aGUgRE9NIHRyZWUuCiAqCiAqIEBleGFtcGxlCiAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgQ2xpY2sgbWU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiIG5nLWluaXQ9ImNoZWNrZWQ9dHJ1ZSIgLz48YnIvPgogICAgICBTaG93IHdoZW4gY2hlY2tlZDoKICAgICAgPHNwYW4gbmctaWY9ImNoZWNrZWQiIGNsYXNzPSJhbmltYXRlLWlmIj4KICAgICAgICBUaGlzIGlzIHJlbW92ZWQgd2hlbiB0aGUgY2hlY2tib3ggaXMgdW5jaGVja2VkLgogICAgICA8L3NwYW4+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgIC5hbmltYXRlLWlmIHsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICB9CgogICAgICAuYW5pbWF0ZS1pZi5uZy1lbnRlciwgLmFuaW1hdGUtaWYubmctbGVhdmUgewogICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtaWYubmctZW50ZXIsCiAgICAgIC5hbmltYXRlLWlmLm5nLWxlYXZlLm5nLWxlYXZlLWFjdGl2ZSB7CiAgICAgICAgb3BhY2l0eTowOwogICAgICB9CgogICAgICAuYW5pbWF0ZS1pZi5uZy1sZWF2ZSwKICAgICAgLmFuaW1hdGUtaWYubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICAgICAgICBvcGFjaXR5OjE7CiAgICAgIH0KICAgIDwvZmlsZT4KICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdJZkRpcmVjdGl2ZSA9IFsnJGFuaW1hdGUnLCBmdW5jdGlvbigkYW5pbWF0ZSkgewogIHJldHVybiB7CiAgICBtdWx0aUVsZW1lbnQ6IHRydWUsCiAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICBwcmlvcml0eTogNjAwLAogICAgdGVybWluYWw6IHRydWUsCiAgICByZXN0cmljdDogJ0EnLAogICAgJCR0bGI6IHRydWUsCiAgICBsaW5rOiBmdW5jdGlvbiAoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmwsICR0cmFuc2NsdWRlKSB7CiAgICAgICAgdmFyIGJsb2NrLCBjaGlsZFNjb3BlLCBwcmV2aW91c0VsZW1lbnRzOwogICAgICAgICRzY29wZS4kd2F0Y2goJGF0dHIubmdJZiwgZnVuY3Rpb24gbmdJZldhdGNoQWN0aW9uKHZhbHVlKSB7CgogICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICghY2hpbGRTY29wZSkgewogICAgICAgICAgICAgICR0cmFuc2NsdWRlKGZ1bmN0aW9uIChjbG9uZSwgbmV3U2NvcGUpIHsKICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBuZXdTY29wZTsKICAgICAgICAgICAgICAgIGNsb25lW2Nsb25lLmxlbmd0aCsrXSA9IGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJyBlbmQgbmdJZjogJyArICRhdHRyLm5nSWYgKyAnICcpOwogICAgICAgICAgICAgICAgLy8gTm90ZTogV2Ugb25seSBuZWVkIHRoZSBmaXJzdC9sYXN0IG5vZGUgb2YgdGhlIGNsb25lZCBub2Rlcy4KICAgICAgICAgICAgICAgIC8vIEhvd2V2ZXIsIHdlIG5lZWQgdG8ga2VlcCB0aGUgcmVmZXJlbmNlIHRvIHRoZSBqcWxpdGUgd3JhcHBlciBhcyBpdCBtaWdodCBiZSBjaGFuZ2VkIGxhdGVyCiAgICAgICAgICAgICAgICAvLyBieSBhIGRpcmVjdGl2ZSB3aXRoIHRlbXBsYXRlVXJsIHdoZW4gaXRzIHRlbXBsYXRlIGFycml2ZXMuCiAgICAgICAgICAgICAgICBibG9jayA9IHsKICAgICAgICAgICAgICAgICAgY2xvbmU6IGNsb25lCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgJGFuaW1hdGUuZW50ZXIoY2xvbmUsICRlbGVtZW50LnBhcmVudCgpLCAkZWxlbWVudCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChwcmV2aW91c0VsZW1lbnRzKSB7CiAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50cy5yZW1vdmUoKTsKICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2hpbGRTY29wZSkgewogICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYmxvY2spIHsKICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzID0gZ2V0QmxvY2tOb2RlcyhibG9jay5jbG9uZSk7CiAgICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUocHJldmlvdXNFbGVtZW50cykudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudHMgPSBudWxsOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGJsb2NrID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQogIH07Cn1dOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdJbmNsdWRlCiAqIEByZXN0cmljdCBFQ0EKICoKICogQGRlc2NyaXB0aW9uCiAqIEZldGNoZXMsIGNvbXBpbGVzIGFuZCBpbmNsdWRlcyBhbiBleHRlcm5hbCBIVE1MIGZyYWdtZW50LgogKgogKiBCeSBkZWZhdWx0LCB0aGUgdGVtcGxhdGUgVVJMIGlzIHJlc3RyaWN0ZWQgdG8gdGhlIHNhbWUgZG9tYWluIGFuZCBwcm90b2NvbCBhcyB0aGUKICogYXBwbGljYXRpb24gZG9jdW1lbnQuIFRoaXMgaXMgZG9uZSBieSBjYWxsaW5nIHtAbGluayAkc2NlI2dldFRydXN0ZWRSZXNvdXJjZVVybAogKiAkc2NlLmdldFRydXN0ZWRSZXNvdXJjZVVybH0gb24gaXQuIFRvIGxvYWQgdGVtcGxhdGVzIGZyb20gb3RoZXIgZG9tYWlucyBvciBwcm90b2NvbHMKICogeW91IG1heSBlaXRoZXIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0IHdoaXRlbGlzdCB0aGVtfSBvcgogKiB7QGxpbmsgJHNjZSN0cnVzdEFzUmVzb3VyY2VVcmwgd3JhcCB0aGVtfSBhcyB0cnVzdGVkIHZhbHVlcy4gUmVmZXIgdG8gQW5ndWxhcidzIHtAbGluawogKiBuZy4kc2NlIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nfS4KICoKICogSW4gYWRkaXRpb24sIHRoZSBicm93c2VyJ3MKICogW1NhbWUgT3JpZ2luIFBvbGljeV0oaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9icm93c2Vyc2VjL3dpa2kvUGFydDIjU2FtZS1vcmlnaW5fcG9saWN5X2Zvcl9YTUxIdHRwUmVxdWVzdCkKICogYW5kIFtDcm9zcy1PcmlnaW4gUmVzb3VyY2UgU2hhcmluZyAoQ09SUyldKGh0dHA6Ly93d3cudzMub3JnL1RSL2NvcnMvKQogKiBwb2xpY3kgbWF5IGZ1cnRoZXIgcmVzdHJpY3Qgd2hldGhlciB0aGUgdGVtcGxhdGUgaXMgc3VjY2Vzc2Z1bGx5IGxvYWRlZC4KICogRm9yIGV4YW1wbGUsIGBuZ0luY2x1ZGVgIHdvbid0IHdvcmsgZm9yIGNyb3NzLWRvbWFpbiByZXF1ZXN0cyBvbiBhbGwgYnJvd3NlcnMgYW5kIGZvciBgZmlsZTovL2AKICogYWNjZXNzIG9uIHNvbWUgYnJvd3NlcnMuCiAqCiAqIEBhbmltYXRpb25zCiAqIGVudGVyIC0gYW5pbWF0aW9uIGlzIHVzZWQgdG8gYnJpbmcgbmV3IGNvbnRlbnQgaW50byB0aGUgYnJvd3Nlci4KICogbGVhdmUgLSBhbmltYXRpb24gaXMgdXNlZCB0byBhbmltYXRlIGV4aXN0aW5nIGNvbnRlbnQgYXdheS4KICoKICogVGhlIGVudGVyIGFuZCBsZWF2ZSBhbmltYXRpb24gb2NjdXIgY29uY3VycmVudGx5LgogKgogKiBAc2NvcGUKICogQHByaW9yaXR5IDQwMAogKgogKiBAcGFyYW0ge3N0cmluZ30gbmdJbmNsdWRlfHNyYyBhbmd1bGFyIGV4cHJlc3Npb24gZXZhbHVhdGluZyB0byBVUkwuIElmIHRoZSBzb3VyY2UgaXMgYSBzdHJpbmcgY29uc3RhbnQsCiAqICAgICAgICAgICAgICAgICBtYWtlIHN1cmUgeW91IHdyYXAgaXQgaW4gKipzaW5nbGUqKiBxdW90ZXMsIGUuZy4gYHNyYz0iJ215UGFydGlhbFRlbXBsYXRlLmh0bWwnImAuCiAqIEBwYXJhbSB7c3RyaW5nPX0gb25sb2FkIEV4cHJlc3Npb24gdG8gZXZhbHVhdGUgd2hlbiBhIG5ldyBwYXJ0aWFsIGlzIGxvYWRlZC4KICoKICogQHBhcmFtIHtzdHJpbmc9fSBhdXRvc2Nyb2xsIFdoZXRoZXIgYG5nSW5jbHVkZWAgc2hvdWxkIGNhbGwge0BsaW5rIG5nLiRhbmNob3JTY3JvbGwKICogICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsfSB0byBzY3JvbGwgdGhlIHZpZXdwb3J0IGFmdGVyIHRoZSBjb250ZW50IGlzIGxvYWRlZC4KICoKICogICAgICAgICAgICAgICAgICAtIElmIHRoZSBhdHRyaWJ1dGUgaXMgbm90IHNldCwgZGlzYWJsZSBzY3JvbGxpbmcuCiAqICAgICAgICAgICAgICAgICAgLSBJZiB0aGUgYXR0cmlidXRlIGlzIHNldCB3aXRob3V0IHZhbHVlLCBlbmFibGUgc2Nyb2xsaW5nLgogKiAgICAgICAgICAgICAgICAgIC0gT3RoZXJ3aXNlIGVuYWJsZSBzY3JvbGxpbmcgb25seSBpZiB0aGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1dGh5IHZhbHVlLgogKgogKiBAZXhhbXBsZQogIDxleGFtcGxlIG1vZHVsZT0iaW5jbHVkZUV4YW1wbGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgIDxzZWxlY3QgbmctbW9kZWw9InRlbXBsYXRlIiBuZy1vcHRpb25zPSJ0Lm5hbWUgZm9yIHQgaW4gdGVtcGxhdGVzIj4KICAgICAgICA8b3B0aW9uIHZhbHVlPSIiPihibGFuayk8L29wdGlvbj4KICAgICAgIDwvc2VsZWN0PgogICAgICAgdXJsIG9mIHRoZSB0ZW1wbGF0ZTogPHR0Pnt7dGVtcGxhdGUudXJsfX08L3R0PgogICAgICAgPGhyLz4KICAgICAgIDxkaXYgY2xhc3M9InNsaWRlLWFuaW1hdGUtY29udGFpbmVyIj4KICAgICAgICAgPGRpdiBjbGFzcz0ic2xpZGUtYW5pbWF0ZSIgbmctaW5jbHVkZT0idGVtcGxhdGUudXJsIj48L2Rpdj4KICAgICAgIDwvZGl2PgogICAgIDwvZGl2PgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgYW5ndWxhci5tb2R1bGUoJ2luY2x1ZGVFeGFtcGxlJywgWyduZ0FuaW1hdGUnXSkKICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLnRlbXBsYXRlcyA9CiAgICAgICAgICAgIFsgeyBuYW1lOiAndGVtcGxhdGUxLmh0bWwnLCB1cmw6ICd0ZW1wbGF0ZTEuaHRtbCd9LAogICAgICAgICAgICAgIHsgbmFtZTogJ3RlbXBsYXRlMi5odG1sJywgdXJsOiAndGVtcGxhdGUyLmh0bWwnfSBdOwogICAgICAgICAgJHNjb3BlLnRlbXBsYXRlID0gJHNjb3BlLnRlbXBsYXRlc1swXTsKICAgICAgICB9XSk7CiAgICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0idGVtcGxhdGUxLmh0bWwiPgogICAgICBDb250ZW50IG9mIHRlbXBsYXRlMS5odG1sCiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJ0ZW1wbGF0ZTIuaHRtbCI+CiAgICAgIENvbnRlbnQgb2YgdGVtcGxhdGUyLmh0bWwKICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImFuaW1hdGlvbnMuY3NzIj4KICAgICAgLnNsaWRlLWFuaW1hdGUtY29udGFpbmVyIHsKICAgICAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgaGVpZ2h0OjQwcHg7CiAgICAgICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgICB9CgogICAgICAuc2xpZGUtYW5pbWF0ZSB7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICB9CgogICAgICAuc2xpZGUtYW5pbWF0ZS5uZy1lbnRlciwgLnNsaWRlLWFuaW1hdGUubmctbGVhdmUgewogICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKCiAgICAgICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICAgICAgdG9wOjA7CiAgICAgICAgbGVmdDowOwogICAgICAgIHJpZ2h0OjA7CiAgICAgICAgYm90dG9tOjA7CiAgICAgICAgZGlzcGxheTpibG9jazsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgIH0KCiAgICAgIC5zbGlkZS1hbmltYXRlLm5nLWVudGVyIHsKICAgICAgICB0b3A6LTUwcHg7CiAgICAgIH0KICAgICAgLnNsaWRlLWFuaW1hdGUubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICAgICAgICB0b3A6MDsKICAgICAgfQoKICAgICAgLnNsaWRlLWFuaW1hdGUubmctbGVhdmUgewogICAgICAgIHRvcDowOwogICAgICB9CiAgICAgIC5zbGlkZS1hbmltYXRlLm5nLWxlYXZlLm5nLWxlYXZlLWFjdGl2ZSB7CiAgICAgICAgdG9wOjUwcHg7CiAgICAgIH0KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICB2YXIgdGVtcGxhdGVTZWxlY3QgPSBlbGVtZW50KGJ5Lm1vZGVsKCd0ZW1wbGF0ZScpKTsKICAgICAgdmFyIGluY2x1ZGVFbGVtID0gZWxlbWVudChieS5jc3MoJ1tuZy1pbmNsdWRlXScpKTsKCiAgICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZTEuaHRtbCcsIGZ1bmN0aW9uKCkgewogICAgICAgIGV4cGVjdChpbmNsdWRlRWxlbS5nZXRUZXh0KCkpLnRvTWF0Y2goL0NvbnRlbnQgb2YgdGVtcGxhdGUxLmh0bWwvKTsKICAgICAgfSk7CgogICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUyLmh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoYnJvd3Nlci5wYXJhbXMuYnJvd3NlciA9PSAnZmlyZWZveCcpIHsKICAgICAgICAgIC8vIEZpcmVmb3ggY2FuJ3QgaGFuZGxlIHVzaW5nIHNlbGVjdHMKICAgICAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9wcm90cmFjdG9yL2lzc3Vlcy80ODAKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGVtcGxhdGVTZWxlY3QuY2xpY2soKTsKICAgICAgICB0ZW1wbGF0ZVNlbGVjdC5hbGwoYnkuY3NzKCdvcHRpb24nKSkuZ2V0KDIpLmNsaWNrKCk7CiAgICAgICAgZXhwZWN0KGluY2x1ZGVFbGVtLmdldFRleHQoKSkudG9NYXRjaCgvQ29udGVudCBvZiB0ZW1wbGF0ZTIuaHRtbC8pOwogICAgICB9KTsKCiAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGJsYW5rJywgZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGJyb3dzZXIucGFyYW1zLmJyb3dzZXIgPT0gJ2ZpcmVmb3gnKSB7CiAgICAgICAgICAvLyBGaXJlZm94IGNhbid0IGhhbmRsZSB1c2luZyBzZWxlY3RzCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlU2VsZWN0LmNsaWNrKCk7CiAgICAgICAgdGVtcGxhdGVTZWxlY3QuYWxsKGJ5LmNzcygnb3B0aW9uJykpLmdldCgwKS5jbGljaygpOwogICAgICAgIGV4cGVjdChpbmNsdWRlRWxlbS5pc1ByZXNlbnQoKSkudG9CZShmYWxzZSk7CiAgICAgIH0pOwogICAgPC9maWxlPgogIDwvZXhhbXBsZT4KICovCgoKLyoqCiAqIEBuZ2RvYyBldmVudAogKiBAbmFtZSBuZ0luY2x1ZGUjJGluY2x1ZGVDb250ZW50UmVxdWVzdGVkCiAqIEBldmVudFR5cGUgZW1pdCBvbiB0aGUgc2NvcGUgbmdJbmNsdWRlIHdhcyBkZWNsYXJlZCBpbgogKiBAZGVzY3JpcHRpb24KICogRW1pdHRlZCBldmVyeSB0aW1lIHRoZSBuZ0luY2x1ZGUgY29udGVudCBpcyByZXF1ZXN0ZWQuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBhbmd1bGFyRXZlbnQgU3ludGhldGljIGV2ZW50IG9iamVjdC4KICogQHBhcmFtIHtTdHJpbmd9IHNyYyBVUkwgb2YgY29udGVudCB0byBsb2FkLgogKi8KCgovKioKICogQG5nZG9jIGV2ZW50CiAqIEBuYW1lIG5nSW5jbHVkZSMkaW5jbHVkZUNvbnRlbnRMb2FkZWQKICogQGV2ZW50VHlwZSBlbWl0IG9uIHRoZSBjdXJyZW50IG5nSW5jbHVkZSBzY29wZQogKiBAZGVzY3JpcHRpb24KICogRW1pdHRlZCBldmVyeSB0aW1lIHRoZSBuZ0luY2x1ZGUgY29udGVudCBpcyByZWxvYWRlZC4KICoKICogQHBhcmFtIHtPYmplY3R9IGFuZ3VsYXJFdmVudCBTeW50aGV0aWMgZXZlbnQgb2JqZWN0LgogKiBAcGFyYW0ge1N0cmluZ30gc3JjIFVSTCBvZiBjb250ZW50IHRvIGxvYWQuCiAqLwoKCi8qKgogKiBAbmdkb2MgZXZlbnQKICogQG5hbWUgbmdJbmNsdWRlIyRpbmNsdWRlQ29udGVudEVycm9yCiAqIEBldmVudFR5cGUgZW1pdCBvbiB0aGUgc2NvcGUgbmdJbmNsdWRlIHdhcyBkZWNsYXJlZCBpbgogKiBAZGVzY3JpcHRpb24KICogRW1pdHRlZCB3aGVuIGEgdGVtcGxhdGUgSFRUUCByZXF1ZXN0IHlpZWxkcyBhbiBlcnJvbm91cyByZXNwb25zZSAoc3RhdHVzIDwgMjAwIHx8IHN0YXR1cyA+IDI5OSkKICoKICogQHBhcmFtIHtPYmplY3R9IGFuZ3VsYXJFdmVudCBTeW50aGV0aWMgZXZlbnQgb2JqZWN0LgogKiBAcGFyYW0ge1N0cmluZ30gc3JjIFVSTCBvZiBjb250ZW50IHRvIGxvYWQuCiAqLwp2YXIgbmdJbmNsdWRlRGlyZWN0aXZlID0gWyckdGVtcGxhdGVSZXF1ZXN0JywgJyRhbmNob3JTY3JvbGwnLCAnJGFuaW1hdGUnLCAnJHNjZScsCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCR0ZW1wbGF0ZVJlcXVlc3QsICAgJGFuY2hvclNjcm9sbCwgICAkYW5pbWF0ZSwgICAkc2NlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRUNBJywKICAgIHByaW9yaXR5OiA0MDAsCiAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgIGNvbnRyb2xsZXI6IGFuZ3VsYXIubm9vcCwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgdmFyIHNyY0V4cCA9IGF0dHIubmdJbmNsdWRlIHx8IGF0dHIuc3JjLAogICAgICAgICAgb25sb2FkRXhwID0gYXR0ci5vbmxvYWQgfHwgJycsCiAgICAgICAgICBhdXRvU2Nyb2xsRXhwID0gYXR0ci5hdXRvc2Nyb2xsOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmwsICR0cmFuc2NsdWRlKSB7CiAgICAgICAgdmFyIGNoYW5nZUNvdW50ZXIgPSAwLAogICAgICAgICAgICBjdXJyZW50U2NvcGUsCiAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudCwKICAgICAgICAgICAgY3VycmVudEVsZW1lbnQ7CgogICAgICAgIHZhciBjbGVhbnVwTGFzdEluY2x1ZGVDb250ZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZihwcmV2aW91c0VsZW1lbnQpIHsKICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICBwcmV2aW91c0VsZW1lbnQgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYoY3VycmVudFNjb3BlKSB7CiAgICAgICAgICAgIGN1cnJlbnRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICBjdXJyZW50U2NvcGUgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYoY3VycmVudEVsZW1lbnQpIHsKICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoY3VycmVudEVsZW1lbnQpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50ID0gbnVsbDsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudCA9IGN1cnJlbnRFbGVtZW50OwogICAgICAgICAgICBjdXJyZW50RWxlbWVudCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgc2NvcGUuJHdhdGNoKCRzY2UucGFyc2VBc1Jlc291cmNlVXJsKHNyY0V4cCksIGZ1bmN0aW9uIG5nSW5jbHVkZVdhdGNoQWN0aW9uKHNyYykgewogICAgICAgICAgdmFyIGFmdGVyQW5pbWF0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQoYXV0b1Njcm9sbEV4cCkgJiYgKCFhdXRvU2Nyb2xsRXhwIHx8IHNjb3BlLiRldmFsKGF1dG9TY3JvbGxFeHApKSkgewogICAgICAgICAgICAgICRhbmNob3JTY3JvbGwoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHZhciB0aGlzQ2hhbmdlSWQgPSArK2NoYW5nZUNvdW50ZXI7CgogICAgICAgICAgaWYgKHNyYykgewogICAgICAgICAgICAvL3NldCB0aGUgMm5kIHBhcmFtIHRvIHRydWUgdG8gaWdub3JlIHRoZSB0ZW1wbGF0ZSByZXF1ZXN0IGVycm9yIHNvIHRoYXQgdGhlIGlubmVyCiAgICAgICAgICAgIC8vY29udGVudHMgYW5kIHNjb3BlIGNhbiBiZSBjbGVhbmVkIHVwLgogICAgICAgICAgICAkdGVtcGxhdGVSZXF1ZXN0KHNyYywgdHJ1ZSkudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgIGlmICh0aGlzQ2hhbmdlSWQgIT09IGNoYW5nZUNvdW50ZXIpIHJldHVybjsKICAgICAgICAgICAgICB2YXIgbmV3U2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgY3RybC50ZW1wbGF0ZSA9IHJlc3BvbnNlOwoKICAgICAgICAgICAgICAvLyBOb3RlOiBUaGlzIHdpbGwgYWxzbyBsaW5rIGFsbCBjaGlsZHJlbiBvZiBuZy1pbmNsdWRlIHRoYXQgd2VyZSBjb250YWluZWQgaW4gdGhlIG9yaWdpbmFsCiAgICAgICAgICAgICAgLy8gaHRtbC4gSWYgdGhhdCBjb250ZW50IGNvbnRhaW5zIGNvbnRyb2xsZXJzLCAuLi4gdGhleSBjb3VsZCBwb2xsdXRlL2NoYW5nZSB0aGUgc2NvcGUuCiAgICAgICAgICAgICAgLy8gSG93ZXZlciwgdXNpbmcgbmctaW5jbHVkZSBvbiBhbiBlbGVtZW50IHdpdGggYWRkaXRpb25hbCBjb250ZW50IGRvZXMgbm90IG1ha2Ugc2Vuc2UuLi4KICAgICAgICAgICAgICAvLyBOb3RlOiBXZSBjYW4ndCByZW1vdmUgdGhlbSBpbiB0aGUgY2xvbmVBdHRjaEZuIG9mICR0cmFuc2NsdWRlIGFzIHRoYXQKICAgICAgICAgICAgICAvLyBmdW5jdGlvbiBpcyBjYWxsZWQgYmVmb3JlIGxpbmtpbmcgdGhlIGNvbnRlbnQsIHdoaWNoIHdvdWxkIGFwcGx5IGNoaWxkCiAgICAgICAgICAgICAgLy8gZGlyZWN0aXZlcyB0byBub24gZXhpc3RpbmcgZWxlbWVudHMuCiAgICAgICAgICAgICAgdmFyIGNsb25lID0gJHRyYW5zY2x1ZGUobmV3U2NvcGUsIGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgICAgICAgICBjbGVhbnVwTGFzdEluY2x1ZGVDb250ZW50KCk7CiAgICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjbG9uZSwgbnVsbCwgJGVsZW1lbnQpLnRoZW4oYWZ0ZXJBbmltYXRpb24pOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjdXJyZW50U2NvcGUgPSBuZXdTY29wZTsKICAgICAgICAgICAgICBjdXJyZW50RWxlbWVudCA9IGNsb25lOwoKICAgICAgICAgICAgICBjdXJyZW50U2NvcGUuJGVtaXQoJyRpbmNsdWRlQ29udGVudExvYWRlZCcsIHNyYyk7CiAgICAgICAgICAgICAgc2NvcGUuJGV2YWwob25sb2FkRXhwKTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXNDaGFuZ2VJZCA9PT0gY2hhbmdlQ291bnRlcikgewogICAgICAgICAgICAgICAgY2xlYW51cExhc3RJbmNsdWRlQ29udGVudCgpOwogICAgICAgICAgICAgICAgc2NvcGUuJGVtaXQoJyRpbmNsdWRlQ29udGVudEVycm9yJywgc3JjKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzY29wZS4kZW1pdCgnJGluY2x1ZGVDb250ZW50UmVxdWVzdGVkJywgc3JjKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNsZWFudXBMYXN0SW5jbHVkZUNvbnRlbnQoKTsKICAgICAgICAgICAgY3RybC50ZW1wbGF0ZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9CiAgfTsKfV07CgovLyBUaGlzIGRpcmVjdGl2ZSBpcyBjYWxsZWQgZHVyaW5nIHRoZSAkdHJhbnNjbHVkZSBjYWxsIG9mIHRoZSBmaXJzdCBgbmdJbmNsdWRlYCBkaXJlY3RpdmUuCi8vIEl0IHdpbGwgcmVwbGFjZSBhbmQgY29tcGlsZSB0aGUgY29udGVudCBvZiB0aGUgZWxlbWVudCB3aXRoIHRoZSBsb2FkZWQgdGVtcGxhdGUuCi8vIFdlIG5lZWQgdGhpcyBkaXJlY3RpdmUgc28gdGhhdCB0aGUgZWxlbWVudCBjb250ZW50IGlzIGFscmVhZHkgZmlsbGVkIHdoZW4KLy8gdGhlIGxpbmsgZnVuY3Rpb24gb2YgYW5vdGhlciBkaXJlY3RpdmUgb24gdGhlIHNhbWUgZWxlbWVudCBhcyBuZ0luY2x1ZGUKLy8gaXMgY2FsbGVkLgp2YXIgbmdJbmNsdWRlRmlsbENvbnRlbnREaXJlY3RpdmUgPSBbJyRjb21waWxlJywKICBmdW5jdGlvbigkY29tcGlsZSkgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFQ0EnLAogICAgICBwcmlvcml0eTogLTQwMCwKICAgICAgcmVxdWlyZTogJ25nSW5jbHVkZScsCiAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmwpIHsKICAgICAgICBpZiAoL1NWRy8udGVzdCgkZWxlbWVudFswXS50b1N0cmluZygpKSkgewogICAgICAgICAgLy8gV2ViS2l0OiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MTM1Njk4IC0tLSBTVkcgZWxlbWVudHMgZG8gbm90CiAgICAgICAgICAvLyBzdXBwb3J0IGlubmVySFRNTCwgc28gZGV0ZWN0IHRoaXMgaGVyZSBhbmQgdHJ5IHRvIGdlbmVyYXRlIHRoZSBjb250ZW50cwogICAgICAgICAgLy8gc3BlY2lhbGx5LgogICAgICAgICAgJGVsZW1lbnQuZW1wdHkoKTsKICAgICAgICAgICRjb21waWxlKGpxTGl0ZUJ1aWxkRnJhZ21lbnQoY3RybC50ZW1wbGF0ZSwgZG9jdW1lbnQpLmNoaWxkTm9kZXMpKHNjb3BlLAogICAgICAgICAgICAgIGZ1bmN0aW9uIG5hbWVzcGFjZUFkYXB0ZWRDbG9uZShjbG9uZSkgewogICAgICAgICAgICAkZWxlbWVudC5hcHBlbmQoY2xvbmUpOwogICAgICAgICAgfSwgdW5kZWZpbmVkLCB1bmRlZmluZWQsICRlbGVtZW50KTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgICRlbGVtZW50Lmh0bWwoY3RybC50ZW1wbGF0ZSk7CiAgICAgICAgJGNvbXBpbGUoJGVsZW1lbnQuY29udGVudHMoKSkoc2NvcGUpOwogICAgICB9CiAgICB9OwogIH1dOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdJbml0CiAqIEByZXN0cmljdCBBQwogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ0luaXRgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIGV2YWx1YXRlIGFuIGV4cHJlc3Npb24gaW4gdGhlCiAqIGN1cnJlbnQgc2NvcGUuCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LWVycm9yIj4KICogVGhlIG9ubHkgYXBwcm9wcmlhdGUgdXNlIG9mIGBuZ0luaXRgIGlzIGZvciBhbGlhc2luZyBzcGVjaWFsIHByb3BlcnRpZXMgb2YKICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBgbmdSZXBlYXRgfSwgYXMgc2VlbiBpbiB0aGUgZGVtbyBiZWxvdy4gQmVzaWRlcyB0aGlzIGNhc2UsIHlvdQogKiBzaG91bGQgdXNlIHtAbGluayBndWlkZS9jb250cm9sbGVyIGNvbnRyb2xsZXJzfSByYXRoZXIgdGhhbiBgbmdJbml0YAogKiB0byBpbml0aWFsaXplIHZhbHVlcyBvbiBhIHNjb3BlLgogKiA8L2Rpdj4KICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAqICoqTm90ZSoqOiBJZiB5b3UgaGF2ZSBhc3NpZ25tZW50IGluIGBuZ0luaXRgIGFsb25nIHdpdGgge0BsaW5rIG5nLiRmaWx0ZXIgYCRmaWx0ZXJgfSwgbWFrZQogKiBzdXJlIHlvdSBoYXZlIHBhcmVudGhlc2lzIGZvciBjb3JyZWN0IHByZWNlZGVuY2U6CiAqIDxwcmUgY2xhc3M9InByZXR0eXByaW50Ij4KICogICA8ZGl2IG5nLWluaXQ9InRlc3QxID0gKGRhdGEgfCBvcmRlckJ5OiduYW1lJykiPjwvZGl2PgogKiA8L3ByZT4KICogPC9kaXY+CiAqCiAqIEBwcmlvcml0eSA0NTAKICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdJbml0IHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0iaW5pdEV4YW1wbGUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICAgIGFuZ3VsYXIubW9kdWxlKCdpbml0RXhhbXBsZScsIFtdKQogICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgJHNjb3BlLmxpc3QgPSBbWydhJywgJ2InXSwgWydjJywgJ2QnXV07CiAgICAgICB9XSk7CiAgIDwvc2NyaXB0PgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICA8ZGl2IG5nLXJlcGVhdD0iaW5uZXJMaXN0IGluIGxpc3QiIG5nLWluaXQ9Im91dGVySW5kZXggPSAkaW5kZXgiPgogICAgICAgPGRpdiBuZy1yZXBlYXQ9InZhbHVlIGluIGlubmVyTGlzdCIgbmctaW5pdD0iaW5uZXJJbmRleCA9ICRpbmRleCI+CiAgICAgICAgICA8c3BhbiBjbGFzcz0iZXhhbXBsZS1pbml0Ij5saXN0WyB7e291dGVySW5kZXh9fSBdWyB7e2lubmVySW5kZXh9fSBdID0ge3t2YWx1ZX19Ozwvc3Bhbj4KICAgICAgIDwvZGl2PgogICAgIDwvZGl2PgogICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGFsaWFzIGluZGV4IHBvc2l0aW9ucycsIGZ1bmN0aW9uKCkgewogICAgICAgICB2YXIgZWxlbWVudHMgPSBlbGVtZW50LmFsbChieS5jc3MoJy5leGFtcGxlLWluaXQnKSk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50cy5nZXQoMCkuZ2V0VGV4dCgpKS50b0JlKCdsaXN0WyAwIF1bIDAgXSA9IGE7Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50cy5nZXQoMSkuZ2V0VGV4dCgpKS50b0JlKCdsaXN0WyAwIF1bIDEgXSA9IGI7Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50cy5nZXQoMikuZ2V0VGV4dCgpKS50b0JlKCdsaXN0WyAxIF1bIDAgXSA9IGM7Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50cy5nZXQoMykuZ2V0VGV4dCgpKS50b0JlKCdsaXN0WyAxIF1bIDEgXSA9IGQ7Jyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCnZhciBuZ0luaXREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgcHJpb3JpdHk6IDQ1MCwKICBjb21waWxlOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIHByZTogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgc2NvcGUuJGV2YWwoYXR0cnMubmdJbml0KTsKICAgICAgfQogICAgfTsKICB9Cn0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdOb25CaW5kYWJsZQogKiBAcmVzdHJpY3QgQUMKICogQHByaW9yaXR5IDEwMDAKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdOb25CaW5kYWJsZWAgZGlyZWN0aXZlIHRlbGxzIEFuZ3VsYXIgbm90IHRvIGNvbXBpbGUgb3IgYmluZCB0aGUgY29udGVudHMgb2YgdGhlIGN1cnJlbnQKICogRE9NIGVsZW1lbnQuIFRoaXMgaXMgdXNlZnVsIGlmIHRoZSBlbGVtZW50IGNvbnRhaW5zIHdoYXQgYXBwZWFycyB0byBiZSBBbmd1bGFyIGRpcmVjdGl2ZXMgYW5kCiAqIGJpbmRpbmdzIGJ1dCB3aGljaCBzaG91bGQgYmUgaWdub3JlZCBieSBBbmd1bGFyLiBUaGlzIGNvdWxkIGJlIHRoZSBjYXNlIGlmIHlvdSBoYXZlIGEgc2l0ZSB0aGF0CiAqIGRpc3BsYXlzIHNuaXBwZXRzIG9mIGNvZGUsIGZvciBpbnN0YW5jZS4KICoKICogQGVsZW1lbnQgQU5ZCiAqCiAqIEBleGFtcGxlCiAqIEluIHRoaXMgZXhhbXBsZSB0aGVyZSBhcmUgdHdvIGxvY2F0aW9ucyB3aGVyZSBhIHNpbXBsZSBpbnRlcnBvbGF0aW9uIGJpbmRpbmcgKGB7e319YCkgaXMgcHJlc2VudCwKICogYnV0IHRoZSBvbmUgd3JhcHBlZCBpbiBgbmdOb25CaW5kYWJsZWAgaXMgbGVmdCBhbG9uZS4KICoKICogQGV4YW1wbGUKICAgIDxleGFtcGxlPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICA8ZGl2Pk5vcm1hbDoge3sxICsgMn19PC9kaXY+CiAgICAgICAgPGRpdiBuZy1ub24tYmluZGFibGU+SWdub3JlZDoge3sxICsgMn19PC9kaXY+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLW5vbi1iaW5kYWJsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCcxICsgMicpKS5nZXRUZXh0KCkpLnRvQ29udGFpbignMycpOwogICAgICAgICBleHBlY3QoZWxlbWVudC5hbGwoYnkuY3NzKCdkaXYnKSkubGFzdCgpLmdldFRleHQoKSkudG9NYXRjaCgvMSBcKyAyLyk7CiAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KdmFyIG5nTm9uQmluZGFibGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7IHRlcm1pbmFsOiB0cnVlLCBwcmlvcml0eTogMTAwMCB9KTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nUGx1cmFsaXplCiAqIEByZXN0cmljdCBFQQogKgogKiBAZGVzY3JpcHRpb24KICogYG5nUGx1cmFsaXplYCBpcyBhIGRpcmVjdGl2ZSB0aGF0IGRpc3BsYXlzIG1lc3NhZ2VzIGFjY29yZGluZyB0byBlbi1VUyBsb2NhbGl6YXRpb24gcnVsZXMuCiAqIFRoZXNlIHJ1bGVzIGFyZSBidW5kbGVkIHdpdGggYW5ndWxhci5qcywgYnV0IGNhbiBiZSBvdmVycmlkZGVuCiAqIChzZWUge0BsaW5rIGd1aWRlL2kxOG4gQW5ndWxhciBpMThufSBkZXYgZ3VpZGUpLiBZb3UgY29uZmlndXJlIG5nUGx1cmFsaXplIGRpcmVjdGl2ZQogKiBieSBzcGVjaWZ5aW5nIHRoZSBtYXBwaW5ncyBiZXR3ZWVuCiAqIFtwbHVyYWwgY2F0ZWdvcmllc10oaHR0cDovL3VuaWNvZGUub3JnL3JlcG9zL2NsZHItdG1wL3RydW5rL2RpZmYvc3VwcGxlbWVudGFsL2xhbmd1YWdlX3BsdXJhbF9ydWxlcy5odG1sKQogKiBhbmQgdGhlIHN0cmluZ3MgdG8gYmUgZGlzcGxheWVkLgogKgogKiAjIFBsdXJhbCBjYXRlZ29yaWVzIGFuZCBleHBsaWNpdCBudW1iZXIgcnVsZXMKICogVGhlcmUgYXJlIHR3bwogKiBbcGx1cmFsIGNhdGVnb3JpZXNdKGh0dHA6Ly91bmljb2RlLm9yZy9yZXBvcy9jbGRyLXRtcC90cnVuay9kaWZmL3N1cHBsZW1lbnRhbC9sYW5ndWFnZV9wbHVyYWxfcnVsZXMuaHRtbCkKICogaW4gQW5ndWxhcidzIGRlZmF1bHQgZW4tVVMgbG9jYWxlOiAib25lIiBhbmQgIm90aGVyIi4KICoKICogV2hpbGUgYSBwbHVyYWwgY2F0ZWdvcnkgbWF5IG1hdGNoIG1hbnkgbnVtYmVycyAoZm9yIGV4YW1wbGUsIGluIGVuLVVTIGxvY2FsZSwgIm90aGVyIiBjYW4gbWF0Y2gKICogYW55IG51bWJlciB0aGF0IGlzIG5vdCAxKSwgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUgY2FuIG9ubHkgbWF0Y2ggb25lIG51bWJlci4gRm9yIGV4YW1wbGUsIHRoZQogKiBleHBsaWNpdCBudW1iZXIgcnVsZSBmb3IgIjMiIG1hdGNoZXMgdGhlIG51bWJlciAzLiBUaGVyZSBhcmUgZXhhbXBsZXMgb2YgcGx1cmFsIGNhdGVnb3JpZXMKICogYW5kIGV4cGxpY2l0IG51bWJlciBydWxlcyB0aHJvdWdob3V0IHRoZSByZXN0IG9mIHRoaXMgZG9jdW1lbnRhdGlvbi4KICoKICogIyBDb25maWd1cmluZyBuZ1BsdXJhbGl6ZQogKiBZb3UgY29uZmlndXJlIG5nUGx1cmFsaXplIGJ5IHByb3ZpZGluZyAyIGF0dHJpYnV0ZXM6IGBjb3VudGAgYW5kIGB3aGVuYC4KICogWW91IGNhbiBhbHNvIHByb3ZpZGUgYW4gb3B0aW9uYWwgYXR0cmlidXRlLCBgb2Zmc2V0YC4KICoKICogVGhlIHZhbHVlIG9mIHRoZSBgY291bnRgIGF0dHJpYnV0ZSBjYW4gYmUgZWl0aGVyIGEgc3RyaW5nIG9yIGFuIHtAbGluayBndWlkZS9leHByZXNzaW9uCiAqIEFuZ3VsYXIgZXhwcmVzc2lvbn07IHRoZXNlIGFyZSBldmFsdWF0ZWQgb24gdGhlIGN1cnJlbnQgc2NvcGUgZm9yIGl0cyBib3VuZCB2YWx1ZS4KICoKICogVGhlIGB3aGVuYCBhdHRyaWJ1dGUgc3BlY2lmaWVzIHRoZSBtYXBwaW5ncyBiZXR3ZWVuIHBsdXJhbCBjYXRlZ29yaWVzIGFuZCB0aGUgYWN0dWFsCiAqIHN0cmluZyB0byBiZSBkaXNwbGF5ZWQuIFRoZSB2YWx1ZSBvZiB0aGUgYXR0cmlidXRlIHNob3VsZCBiZSBhIEpTT04gb2JqZWN0LgogKgogKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgc2hvd3MgaG93IHRvIGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZToKICoKICogYGBgaHRtbAogKiA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIKICAgICAgICAgICAgICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICcxIHBlcnNvbiBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogKiA8L25nLXBsdXJhbGl6ZT4KICpgYGAKICoKICogSW4gdGhlIGV4YW1wbGUsIGAiMDogTm9ib2R5IGlzIHZpZXdpbmcuImAgaXMgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUuIElmIHlvdSBkaWQgbm90CiAqIHNwZWNpZnkgdGhpcyBydWxlLCAwIHdvdWxkIGJlIG1hdGNoZWQgdG8gdGhlICJvdGhlciIgY2F0ZWdvcnkgYW5kICIwIHBlb3BsZSBhcmUgdmlld2luZyIKICogd291bGQgYmUgc2hvd24gaW5zdGVhZCBvZiAiTm9ib2R5IGlzIHZpZXdpbmciLiBZb3UgY2FuIHNwZWNpZnkgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUgZm9yCiAqIG90aGVyIG51bWJlcnMsIGZvciBleGFtcGxlIDEyLCBzbyB0aGF0IGluc3RlYWQgb2Ygc2hvd2luZyAiMTIgcGVvcGxlIGFyZSB2aWV3aW5nIiwgeW91IGNhbgogKiBzaG93ICJhIGRvemVuIHBlb3BsZSBhcmUgdmlld2luZyIuCiAqCiAqIFlvdSBjYW4gdXNlIGEgc2V0IG9mIGNsb3NlZCBicmFjZXMgKGB7fWApIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSBudW1iZXIgdGhhdCB5b3Ugd2FudCBzdWJzdGl0dXRlZAogKiBpbnRvIHBsdXJhbGl6ZWQgc3RyaW5ncy4gSW4gdGhlIHByZXZpb3VzIGV4YW1wbGUsIEFuZ3VsYXIgd2lsbCByZXBsYWNlIGB7fWAgd2l0aAogKiA8c3BhbiBuZy1ub24tYmluZGFibGU+YHt7cGVyc29uQ291bnR9fWA8L3NwYW4+LiBUaGUgY2xvc2VkIGJyYWNlcyBge31gIGlzIGEgcGxhY2Vob2xkZXIKICogZm9yIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57e251bWJlckV4cHJlc3Npb259fTwvc3Bhbj4uCiAqCiAqICMgQ29uZmlndXJpbmcgbmdQbHVyYWxpemUgd2l0aCBvZmZzZXQKICogVGhlIGBvZmZzZXRgIGF0dHJpYnV0ZSBhbGxvd3MgZnVydGhlciBjdXN0b21pemF0aW9uIG9mIHBsdXJhbGl6ZWQgdGV4dCwgd2hpY2ggY2FuIHJlc3VsdCBpbgogKiBhIGJldHRlciB1c2VyIGV4cGVyaWVuY2UuIEZvciBleGFtcGxlLCBpbnN0ZWFkIG9mIHRoZSBtZXNzYWdlICI0IHBlb3BsZSBhcmUgdmlld2luZyB0aGlzIGRvY3VtZW50IiwKICogeW91IG1pZ2h0IGRpc3BsYXkgIkpvaG4sIEthdGUgYW5kIDIgb3RoZXJzIGFyZSB2aWV3aW5nIHRoaXMgZG9jdW1lbnQiLgogKiBUaGUgb2Zmc2V0IGF0dHJpYnV0ZSBhbGxvd3MgeW91IHRvIG9mZnNldCBhIG51bWJlciBieSBhbnkgZGVzaXJlZCB2YWx1ZS4KICogTGV0J3MgdGFrZSBhIGxvb2sgYXQgYW4gZXhhbXBsZToKICoKICogYGBgaHRtbAogKiA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIgb2Zmc2V0PTIKICogICAgICAgICAgICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnMic6ICd7e3BlcnNvbjF9fSBhbmQge3twZXJzb24yfX0gYXJlIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICogPC9uZy1wbHVyYWxpemU+CiAqIGBgYAogKgogKiBOb3RpY2UgdGhhdCB3ZSBhcmUgc3RpbGwgdXNpbmcgdHdvIHBsdXJhbCBjYXRlZ29yaWVzKG9uZSwgb3RoZXIpLCBidXQgd2UgYWRkZWQKICogdGhyZWUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIDAsIDEgYW5kIDIuCiAqIFdoZW4gb25lIHBlcnNvbiwgcGVyaGFwcyBKb2huLCB2aWV3cyB0aGUgZG9jdW1lbnQsICJKb2huIGlzIHZpZXdpbmciIHdpbGwgYmUgc2hvd24uCiAqIFdoZW4gdGhyZWUgcGVvcGxlIHZpZXcgdGhlIGRvY3VtZW50LCBubyBleHBsaWNpdCBudW1iZXIgcnVsZSBpcyBmb3VuZCwgc28KICogYW4gb2Zmc2V0IG9mIDIgaXMgdGFrZW4gb2ZmIDMsIGFuZCBBbmd1bGFyIHVzZXMgMSB0byBkZWNpZGUgdGhlIHBsdXJhbCBjYXRlZ29yeS4KICogSW4gdGhpcyBjYXNlLCBwbHVyYWwgY2F0ZWdvcnkgJ29uZScgaXMgbWF0Y2hlZCBhbmQgIkpvaG4sIE1hcnkgYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmciCiAqIGlzIHNob3duLgogKgogKiBOb3RlIHRoYXQgd2hlbiB5b3Ugc3BlY2lmeSBvZmZzZXRzLCB5b3UgbXVzdCBwcm92aWRlIGV4cGxpY2l0IG51bWJlciBydWxlcyBmb3IKICogbnVtYmVycyBmcm9tIDAgdXAgdG8gYW5kIGluY2x1ZGluZyB0aGUgb2Zmc2V0LiBJZiB5b3UgdXNlIGFuIG9mZnNldCBvZiAzLCBmb3IgZXhhbXBsZSwKICogeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yIDAsIDEsIDIgYW5kIDMuIFlvdSBtdXN0IGFsc28gcHJvdmlkZSBwbHVyYWwgc3RyaW5ncyBmb3IKICogcGx1cmFsIGNhdGVnb3JpZXMgIm9uZSIgYW5kICJvdGhlciIuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfGV4cHJlc3Npb259IGNvdW50IFRoZSB2YXJpYWJsZSB0byBiZSBib3VuZCB0by4KICogQHBhcmFtIHtzdHJpbmd9IHdoZW4gVGhlIG1hcHBpbmcgYmV0d2VlbiBwbHVyYWwgY2F0ZWdvcnkgdG8gaXRzIGNvcnJlc3BvbmRpbmcgc3RyaW5ncy4KICogQHBhcmFtIHtudW1iZXI9fSBvZmZzZXQgT2Zmc2V0IHRvIGRlZHVjdCBmcm9tIHRoZSB0b3RhbCBudW1iZXIuCiAqCiAqIEBleGFtcGxlCiAgICA8ZXhhbXBsZSBtb2R1bGU9InBsdXJhbGl6ZUV4YW1wbGUiPgogICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICA8c2NyaXB0PgogICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ3BsdXJhbGl6ZUV4YW1wbGUnLCBbXSkKICAgICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgICAkc2NvcGUucGVyc29uMSA9ICdJZ29yJzsKICAgICAgICAgICAgICAkc2NvcGUucGVyc29uMiA9ICdNaXNrbyc7CiAgICAgICAgICAgICAgJHNjb3BlLnBlcnNvbkNvdW50ID0gMTsKICAgICAgICAgICAgfV0pOwogICAgICAgIDwvc2NyaXB0PgogICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgICAgUGVyc29uIDE6PGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJwZXJzb24xIiB2YWx1ZT0iSWdvciIgLz48YnIvPgogICAgICAgICAgUGVyc29uIDI6PGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJwZXJzb24yIiB2YWx1ZT0iTWlza28iIC8+PGJyLz4KICAgICAgICAgIE51bWJlciBvZiBQZW9wbGU6PGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJwZXJzb25Db3VudCIgdmFsdWU9IjEiIC8+PGJyLz4KCiAgICAgICAgICA8IS0tLSBFeGFtcGxlIHdpdGggc2ltcGxlIHBsdXJhbGl6YXRpb24gcnVsZXMgZm9yIGVuIGxvY2FsZSAtLS0+CiAgICAgICAgICBXaXRob3V0IE9mZnNldDoKICAgICAgICAgIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IgogICAgICAgICAgICAgICAgICAgICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAnMSBwZXJzb24gaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t9IHBlb3BsZSBhcmUgdmlld2luZy4nfSI+CiAgICAgICAgICA8L25nLXBsdXJhbGl6ZT48YnI+CgogICAgICAgICAgPCEtLS0gRXhhbXBsZSB3aXRoIG9mZnNldCAtLS0+CiAgICAgICAgICBXaXRoIE9mZnNldCgyKToKICAgICAgICAgIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IiBvZmZzZXQ9MgogICAgICAgICAgICAgICAgICAgICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcxJzogJ3t7cGVyc29uMX19IGlzIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcyJzogJ3t7cGVyc29uMX19IGFuZCB7e3BlcnNvbjJ9fSBhcmUgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIHt9IG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nfSI+CiAgICAgICAgICA8L25nLXBsdXJhbGl6ZT4KICAgICAgICA8L2Rpdj4KICAgICAgPC9maWxlPgogICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICBpdCgnc2hvdWxkIHNob3cgY29ycmVjdCBwbHVyYWxpemVkIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHdpdGhvdXRPZmZzZXQgPSBlbGVtZW50LmFsbChieS5jc3MoJ25nLXBsdXJhbGl6ZScpKS5nZXQoMCk7CiAgICAgICAgICB2YXIgd2l0aE9mZnNldCA9IGVsZW1lbnQuYWxsKGJ5LmNzcygnbmctcGx1cmFsaXplJykpLmdldCgxKTsKICAgICAgICAgIHZhciBjb3VudElucHV0ID0gZWxlbWVudChieS5tb2RlbCgncGVyc29uQ291bnQnKSk7CgogICAgICAgICAgZXhwZWN0KHdpdGhvdXRPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCcxIHBlcnNvbiBpcyB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdJZ29yIGlzIHZpZXdpbmcuJyk7CgogICAgICAgICAgY291bnRJbnB1dC5jbGVhcigpOwogICAgICAgICAgY291bnRJbnB1dC5zZW5kS2V5cygnMCcpOwoKICAgICAgICAgIGV4cGVjdCh3aXRob3V0T2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnTm9ib2R5IGlzIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3Qod2l0aE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJ05vYm9keSBpcyB2aWV3aW5nLicpOwoKICAgICAgICAgIGNvdW50SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIGNvdW50SW5wdXQuc2VuZEtleXMoJzInKTsKCiAgICAgICAgICBleHBlY3Qod2l0aG91dE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJzIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdJZ29yIGFuZCBNaXNrbyBhcmUgdmlld2luZy4nKTsKCiAgICAgICAgICBjb3VudElucHV0LmNsZWFyKCk7CiAgICAgICAgICBjb3VudElucHV0LnNlbmRLZXlzKCczJyk7CgogICAgICAgICAgZXhwZWN0KHdpdGhvdXRPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCczIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdCh3aXRoT2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnSWdvciwgTWlza28gYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgY291bnRJbnB1dC5jbGVhcigpOwogICAgICAgICAgY291bnRJbnB1dC5zZW5kS2V5cygnNCcpOwoKICAgICAgICAgIGV4cGVjdCh3aXRob3V0T2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnNCBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3Qod2l0aE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJ0lnb3IsIE1pc2tvIGFuZCAyIG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICB9KTsKICAgICAgICBpdCgnc2hvdWxkIHNob3cgZGF0YS1ib3VuZCBuYW1lcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHdpdGhPZmZzZXQgPSBlbGVtZW50LmFsbChieS5jc3MoJ25nLXBsdXJhbGl6ZScpKS5nZXQoMSk7CiAgICAgICAgICB2YXIgcGVyc29uQ291bnQgPSBlbGVtZW50KGJ5Lm1vZGVsKCdwZXJzb25Db3VudCcpKTsKICAgICAgICAgIHZhciBwZXJzb24xID0gZWxlbWVudChieS5tb2RlbCgncGVyc29uMScpKTsKICAgICAgICAgIHZhciBwZXJzb24yID0gZWxlbWVudChieS5tb2RlbCgncGVyc29uMicpKTsKICAgICAgICAgIHBlcnNvbkNvdW50LmNsZWFyKCk7CiAgICAgICAgICBwZXJzb25Db3VudC5zZW5kS2V5cygnNCcpOwogICAgICAgICAgcGVyc29uMS5jbGVhcigpOwogICAgICAgICAgcGVyc29uMS5zZW5kS2V5cygnRGknKTsKICAgICAgICAgIHBlcnNvbjIuY2xlYXIoKTsKICAgICAgICAgIHBlcnNvbjIuc2VuZEtleXMoJ1ZvanRhJyk7CiAgICAgICAgICBleHBlY3Qod2l0aE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJ0RpLCBWb2p0YSBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgfSk7CiAgICAgIDwvZmlsZT4KICAgIDwvZXhhbXBsZT4KICovCnZhciBuZ1BsdXJhbGl6ZURpcmVjdGl2ZSA9IFsnJGxvY2FsZScsICckaW50ZXJwb2xhdGUnLCBmdW5jdGlvbigkbG9jYWxlLCAkaW50ZXJwb2xhdGUpIHsKICB2YXIgQlJBQ0UgPSAve30vZzsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFQScsCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICB2YXIgbnVtYmVyRXhwID0gYXR0ci5jb3VudCwKICAgICAgICAgIHdoZW5FeHAgPSBhdHRyLiRhdHRyLndoZW4gJiYgZWxlbWVudC5hdHRyKGF0dHIuJGF0dHIud2hlbiksIC8vIHdlIGhhdmUge3t9fSBpbiBhdHRycwogICAgICAgICAgb2Zmc2V0ID0gYXR0ci5vZmZzZXQgfHwgMCwKICAgICAgICAgIHdoZW5zID0gc2NvcGUuJGV2YWwod2hlbkV4cCkgfHwge30sCiAgICAgICAgICB3aGVuc0V4cEZucyA9IHt9LAogICAgICAgICAgc3RhcnRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2woKSwKICAgICAgICAgIGVuZFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5lbmRTeW1ib2woKSwKICAgICAgICAgIGlzV2hlbiA9IC9ed2hlbihNaW51cyk/KC4rKSQvOwoKICAgICAgZm9yRWFjaChhdHRyLCBmdW5jdGlvbihleHByZXNzaW9uLCBhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgaWYgKGlzV2hlbi50ZXN0KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICB3aGVuc1tsb3dlcmNhc2UoYXR0cmlidXRlTmFtZS5yZXBsYWNlKCd3aGVuJywgJycpLnJlcGxhY2UoJ01pbnVzJywgJy0nKSldID0KICAgICAgICAgICAgZWxlbWVudC5hdHRyKGF0dHIuJGF0dHJbYXR0cmlidXRlTmFtZV0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGZvckVhY2god2hlbnMsIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGtleSkgewogICAgICAgIHdoZW5zRXhwRm5zW2tleV0gPQogICAgICAgICAgJGludGVycG9sYXRlKGV4cHJlc3Npb24ucmVwbGFjZShCUkFDRSwgc3RhcnRTeW1ib2wgKyBudW1iZXJFeHAgKyAnLScgKwogICAgICAgICAgICBvZmZzZXQgKyBlbmRTeW1ib2wpKTsKICAgICAgfSk7CgogICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24gbmdQbHVyYWxpemVXYXRjaCgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBwYXJzZUZsb2F0KHNjb3BlLiRldmFsKG51bWJlckV4cCkpOwoKICAgICAgICBpZiAoIWlzTmFOKHZhbHVlKSkgewogICAgICAgICAgLy9pZiBleHBsaWNpdCBudW1iZXIgcnVsZSBzdWNoIGFzIDEsIDIsIDMuLi4gaXMgZGVmaW5lZCwganVzdCB1c2UgaXQuIE90aGVyd2lzZSwKICAgICAgICAgIC8vY2hlY2sgaXQgYWdhaW5zdCBwbHVyYWxpemF0aW9uIHJ1bGVzIGluICRsb2NhbGUgc2VydmljZQogICAgICAgICAgaWYgKCEodmFsdWUgaW4gd2hlbnMpKSB2YWx1ZSA9ICRsb2NhbGUucGx1cmFsQ2F0KHZhbHVlIC0gb2Zmc2V0KTsKICAgICAgICAgICByZXR1cm4gd2hlbnNFeHBGbnNbdmFsdWVdKHNjb3BlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KICAgICAgfSwgZnVuY3Rpb24gbmdQbHVyYWxpemVXYXRjaEFjdGlvbihuZXdWYWwpIHsKICAgICAgICBlbGVtZW50LnRleHQobmV3VmFsKTsKICAgICAgfSk7CiAgICB9CiAgfTsKfV07CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1JlcGVhdAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZ1JlcGVhdGAgZGlyZWN0aXZlIGluc3RhbnRpYXRlcyBhIHRlbXBsYXRlIG9uY2UgcGVyIGl0ZW0gZnJvbSBhIGNvbGxlY3Rpb24uIEVhY2ggdGVtcGxhdGUKICogaW5zdGFuY2UgZ2V0cyBpdHMgb3duIHNjb3BlLCB3aGVyZSB0aGUgZ2l2ZW4gbG9vcCB2YXJpYWJsZSBpcyBzZXQgdG8gdGhlIGN1cnJlbnQgY29sbGVjdGlvbiBpdGVtLAogKiBhbmQgYCRpbmRleGAgaXMgc2V0IHRvIHRoZSBpdGVtIGluZGV4IG9yIGtleS4KICoKICogU3BlY2lhbCBwcm9wZXJ0aWVzIGFyZSBleHBvc2VkIG9uIHRoZSBsb2NhbCBzY29wZSBvZiBlYWNoIHRlbXBsYXRlIGluc3RhbmNlLCBpbmNsdWRpbmc6CiAqCiAqIHwgVmFyaWFibGUgIHwgVHlwZSAgICAgICAgICAgIHwgRGV0YWlscyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogfC0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogKiB8IGAkaW5kZXhgICB8IHtAdHlwZSBudW1iZXJ9ICB8IGl0ZXJhdG9yIG9mZnNldCBvZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCAoMC4ubGVuZ3RoLTEpICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwgYCRmaXJzdGAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBmaXJzdCBpbiB0aGUgaXRlcmF0b3IuICAgICAgICAgICAgICAgICAgICAgIHwKICogfCBgJG1pZGRsZWAgfCB7QHR5cGUgYm9vbGVhbn0gfCB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGJldHdlZW4gdGhlIGZpcnN0IGFuZCBsYXN0IGluIHRoZSBpdGVyYXRvci4gfAogKiB8IGAkbGFzdGAgICB8IHtAdHlwZSBib29sZWFufSB8IHRydWUgaWYgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaXMgbGFzdCBpbiB0aGUgaXRlcmF0b3IuICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwgYCRldmVuYCAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgaXRlcmF0b3IgcG9zaXRpb24gYCRpbmRleGAgaXMgZXZlbiAob3RoZXJ3aXNlIGZhbHNlKS4gICAgICAgICAgIHwKICogfCBgJG9kZGAgICAgfCB7QHR5cGUgYm9vbGVhbn0gfCB0cnVlIGlmIHRoZSBpdGVyYXRvciBwb3NpdGlvbiBgJGluZGV4YCBpcyBvZGQgKG90aGVyd2lzZSBmYWxzZSkuICAgICAgICAgICAgfAogKgogKiBDcmVhdGluZyBhbGlhc2VzIGZvciB0aGVzZSBwcm9wZXJ0aWVzIGlzIHBvc3NpYmxlIHdpdGgge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0luaXQgYG5nSW5pdGB9LgogKiBUaGlzIG1heSBiZSB1c2VmdWwgd2hlbiwgZm9yIGluc3RhbmNlLCBuZXN0aW5nIG5nUmVwZWF0cy4KICoKICogIyBTcGVjaWFsIHJlcGVhdCBzdGFydCBhbmQgZW5kIHBvaW50cwogKiBUbyByZXBlYXQgYSBzZXJpZXMgb2YgZWxlbWVudHMgaW5zdGVhZCBvZiBqdXN0IG9uZSBwYXJlbnQgZWxlbWVudCwgbmdSZXBlYXQgKGFzIHdlbGwgYXMgb3RoZXIgbmcgZGlyZWN0aXZlcykgc3VwcG9ydHMgZXh0ZW5kaW5nCiAqIHRoZSByYW5nZSBvZiB0aGUgcmVwZWF0ZXIgYnkgZGVmaW5pbmcgZXhwbGljaXQgc3RhcnQgYW5kIGVuZCBwb2ludHMgYnkgdXNpbmcgKipuZy1yZXBlYXQtc3RhcnQqKiBhbmQgKipuZy1yZXBlYXQtZW5kKiogcmVzcGVjdGl2ZWx5LgogKiBUaGUgKipuZy1yZXBlYXQtc3RhcnQqKiBkaXJlY3RpdmUgd29ya3MgdGhlIHNhbWUgYXMgKipuZy1yZXBlYXQqKiwgYnV0IHdpbGwgcmVwZWF0IGFsbCB0aGUgSFRNTCBjb2RlIChpbmNsdWRpbmcgdGhlIHRhZyBpdCdzIGRlZmluZWQgb24pCiAqIHVwIHRvIGFuZCBpbmNsdWRpbmcgdGhlIGVuZGluZyBIVE1MIHRhZyB3aGVyZSAqKm5nLXJlcGVhdC1lbmQqKiBpcyBwbGFjZWQuCiAqCiAqIFRoZSBleGFtcGxlIGJlbG93IG1ha2VzIHVzZSBvZiB0aGlzIGZlYXR1cmU6CiAqIGBgYGh0bWwKICogICA8aGVhZGVyIG5nLXJlcGVhdC1zdGFydD0iaXRlbSBpbiBpdGVtcyI+CiAqICAgICBIZWFkZXIge3sgaXRlbSB9fQogKiAgIDwvaGVhZGVyPgogKiAgIDxkaXYgY2xhc3M9ImJvZHkiPgogKiAgICAgQm9keSB7eyBpdGVtIH19CiAqICAgPC9kaXY+CiAqICAgPGZvb3RlciBuZy1yZXBlYXQtZW5kPgogKiAgICAgRm9vdGVyIHt7IGl0ZW0gfX0KICogICA8L2Zvb3Rlcj4KICogYGBgCiAqCiAqIEFuZCB3aXRoIGFuIGlucHV0IG9mIHtAdHlwZSBbJ0EnLCdCJ119IGZvciB0aGUgaXRlbXMgdmFyaWFibGUgaW4gdGhlIGV4YW1wbGUgYWJvdmUsIHRoZSBvdXRwdXQgd2lsbCBldmFsdWF0ZSB0bzoKICogYGBgaHRtbAogKiAgIDxoZWFkZXI+CiAqICAgICBIZWFkZXIgQQogKiAgIDwvaGVhZGVyPgogKiAgIDxkaXYgY2xhc3M9ImJvZHkiPgogKiAgICAgQm9keSBBCiAqICAgPC9kaXY+CiAqICAgPGZvb3Rlcj4KICogICAgIEZvb3RlciBBCiAqICAgPC9mb290ZXI+CiAqICAgPGhlYWRlcj4KICogICAgIEhlYWRlciBCCiAqICAgPC9oZWFkZXI+CiAqICAgPGRpdiBjbGFzcz0iYm9keSI+CiAqICAgICBCb2R5IEIKICogICA8L2Rpdj4KICogICA8Zm9vdGVyPgogKiAgICAgRm9vdGVyIEIKICogICA8L2Zvb3Rlcj4KICogYGBgCiAqCiAqIFRoZSBjdXN0b20gc3RhcnQgYW5kIGVuZCBwb2ludHMgZm9yIG5nUmVwZWF0IGFsc28gc3VwcG9ydCBhbGwgb3RoZXIgSFRNTCBkaXJlY3RpdmUgc3ludGF4IGZsYXZvcnMgcHJvdmlkZWQgaW4gQW5ndWxhckpTIChzdWNoCiAqIGFzICoqZGF0YS1uZy1yZXBlYXQtc3RhcnQqKiwgKip4LW5nLXJlcGVhdC1zdGFydCoqIGFuZCAqKm5nOnJlcGVhdC1zdGFydCoqKS4KICoKICogQGFuaW1hdGlvbnMKICogKiouZW50ZXIqKiAtIHdoZW4gYSBuZXcgaXRlbSBpcyBhZGRlZCB0byB0aGUgbGlzdCBvciB3aGVuIGFuIGl0ZW0gaXMgcmV2ZWFsZWQgYWZ0ZXIgYSBmaWx0ZXIKICoKICogKioubGVhdmUqKiAtIHdoZW4gYW4gaXRlbSBpcyByZW1vdmVkIGZyb20gdGhlIGxpc3Qgb3Igd2hlbiBhbiBpdGVtIGlzIGZpbHRlcmVkIG91dAogKgogKiAqKi5tb3ZlKiogLSB3aGVuIGFuIGFkamFjZW50IGl0ZW0gaXMgZmlsdGVyZWQgb3V0IGNhdXNpbmcgYSByZW9yZGVyIG9yIHdoZW4gdGhlIGl0ZW0gY29udGVudHMgYXJlIHJlb3JkZXJlZAogKgogKiBAZWxlbWVudCBBTlkKICogQHNjb3BlCiAqIEBwcmlvcml0eSAxMDAwCiAqIEBwYXJhbSB7cmVwZWF0X2V4cHJlc3Npb259IG5nUmVwZWF0IFRoZSBleHByZXNzaW9uIGluZGljYXRpbmcgaG93IHRvIGVudW1lcmF0ZSBhIGNvbGxlY3Rpb24uIFRoZXNlCiAqICAgZm9ybWF0cyBhcmUgY3VycmVudGx5IHN1cHBvcnRlZDoKICoKICogICAqIGB2YXJpYWJsZSBpbiBleHByZXNzaW9uYCDigJMgd2hlcmUgdmFyaWFibGUgaXMgdGhlIHVzZXIgZGVmaW5lZCBsb29wIHZhcmlhYmxlIGFuZCBgZXhwcmVzc2lvbmAKICogICAgIGlzIGEgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogKgogKiAgICAgRm9yIGV4YW1wbGU6IGBhbGJ1bSBpbiBhcnRpc3QuYWxidW1zYC4KICoKICogICAqIGAoa2V5LCB2YWx1ZSkgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIGBrZXlgIGFuZCBgdmFsdWVgIGNhbiBiZSBhbnkgdXNlciBkZWZpbmVkIGlkZW50aWZpZXJzLAogKiAgICAgYW5kIGBleHByZXNzaW9uYCBpcyB0aGUgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogKgogKiAgICAgRm9yIGV4YW1wbGU6IGAobmFtZSwgYWdlKSBpbiB7J2FkYW0nOjEwLCAnYW1hbGllJzoxMn1gLgogKgogKiAgICogYHZhcmlhYmxlIGluIGV4cHJlc3Npb24gdHJhY2sgYnkgdHJhY2tpbmdfZXhwcmVzc2lvbmAg4oCTIFlvdSBjYW4gYWxzbyBwcm92aWRlIGFuIG9wdGlvbmFsIHRyYWNraW5nIGZ1bmN0aW9uCiAqICAgICB3aGljaCBjYW4gYmUgdXNlZCB0byBhc3NvY2lhdGUgdGhlIG9iamVjdHMgaW4gdGhlIGNvbGxlY3Rpb24gd2l0aCB0aGUgRE9NIGVsZW1lbnRzLiBJZiBubyB0cmFja2luZyBmdW5jdGlvbgogKiAgICAgaXMgc3BlY2lmaWVkIHRoZSBuZy1yZXBlYXQgYXNzb2NpYXRlcyBlbGVtZW50cyBieSBpZGVudGl0eSBpbiB0aGUgY29sbGVjdGlvbi4gSXQgaXMgYW4gZXJyb3IgdG8gaGF2ZQogKiAgICAgbW9yZSB0aGFuIG9uZSB0cmFja2luZyBmdW5jdGlvbiB0byByZXNvbHZlIHRvIHRoZSBzYW1lIGtleS4gKFRoaXMgd291bGQgbWVhbiB0aGF0IHR3byBkaXN0aW5jdCBvYmplY3RzIGFyZQogKiAgICAgbWFwcGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LCB3aGljaCBpcyBub3QgcG9zc2libGUuKSAgRmlsdGVycyBzaG91bGQgYmUgYXBwbGllZCB0byB0aGUgZXhwcmVzc2lvbiwKICogICAgIGJlZm9yZSBzcGVjaWZ5aW5nIGEgdHJhY2tpbmcgZXhwcmVzc2lvbi4KICoKICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtc2AgaXMgZXF1aXZhbGVudCB0byBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSAkaWQoaXRlbSlgLiBUaGlzIGltcGxpZXMgdGhhdCB0aGUgRE9NIGVsZW1lbnRzCiAqICAgICB3aWxsIGJlIGFzc29jaWF0ZWQgYnkgaXRlbSBpZGVudGl0eSBpbiB0aGUgYXJyYXkuCiAqCiAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXMgdHJhY2sgYnkgJGlkKGl0ZW0pYC4gQSBidWlsdCBpbiBgJGlkKClgIGZ1bmN0aW9uIGNhbiBiZSB1c2VkIHRvIGFzc2lnbiBhIHVuaXF1ZQogKiAgICAgYCQkaGFzaEtleWAgcHJvcGVydHkgdG8gZWFjaCBpdGVtIGluIHRoZSBhcnJheS4gVGhpcyBwcm9wZXJ0eSBpcyB0aGVuIHVzZWQgYXMgYSBrZXkgdG8gYXNzb2NpYXRlZCBET00gZWxlbWVudHMKICogICAgIHdpdGggdGhlIGNvcnJlc3BvbmRpbmcgaXRlbSBpbiB0aGUgYXJyYXkgYnkgaWRlbnRpdHkuIE1vdmluZyB0aGUgc2FtZSBvYmplY3QgaW4gYXJyYXkgd291bGQgbW92ZSB0aGUgRE9NCiAqICAgICBlbGVtZW50IGluIHRoZSBzYW1lIHdheSBpbiB0aGUgRE9NLgogKgogKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zIHRyYWNrIGJ5IGl0ZW0uaWRgIGlzIGEgdHlwaWNhbCBwYXR0ZXJuIHdoZW4gdGhlIGl0ZW1zIGNvbWUgZnJvbSB0aGUgZGF0YWJhc2UuIEluIHRoaXMKICogICAgIGNhc2UgdGhlIG9iamVjdCBpZGVudGl0eSBkb2VzIG5vdCBtYXR0ZXIuIFR3byBvYmplY3RzIGFyZSBjb25zaWRlcmVkIGVxdWl2YWxlbnQgYXMgbG9uZyBhcyB0aGVpciBgaWRgCiAqICAgICBwcm9wZXJ0eSBpcyBzYW1lLgogKgogKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zIHwgZmlsdGVyOnNlYXJjaFRleHQgdHJhY2sgYnkgaXRlbS5pZGAgaXMgYSBwYXR0ZXJuIHRoYXQgbWlnaHQgYmUgdXNlZCB0byBhcHBseSBhIGZpbHRlcgogKiAgICAgdG8gaXRlbXMgaW4gY29uanVuY3Rpb24gd2l0aCBhIHRyYWNraW5nIGV4cHJlc3Npb24uCiAqCiAqICAgKiBgdmFyaWFibGUgaW4gZXhwcmVzc2lvbiBhcyBhbGlhc19leHByZXNzaW9uYCDigJMgWW91IGNhbiBhbHNvIHByb3ZpZGUgYW4gb3B0aW9uYWwgYWxpYXMgZXhwcmVzc2lvbiB3aGljaCB3aWxsIHRoZW4gc3RvcmUgdGhlCiAqICAgICBpbnRlcm1lZGlhdGUgcmVzdWx0cyBvZiB0aGUgcmVwZWF0ZXIgYWZ0ZXIgdGhlIGZpbHRlcnMgaGF2ZSBiZWVuIGFwcGxpZWQuIFR5cGljYWxseSB0aGlzIGlzIHVzZWQgdG8gcmVuZGVyIGEgc3BlY2lhbCBtZXNzYWdlCiAqICAgICB3aGVuIGEgZmlsdGVyIGlzIGFjdGl2ZSBvbiB0aGUgcmVwZWF0ZXIsIGJ1dCB0aGUgZmlsdGVyZWQgcmVzdWx0IHNldCBpcyBlbXB0eS4KICoKICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB8IGZpbHRlcjp4IGFzIHJlc3VsdHNgIHdpbGwgc3RvcmUgdGhlIGZyYWdtZW50IG9mIHRoZSByZXBlYXRlZCBpdGVtcyBhcyBgcmVzdWx0c2AsIGJ1dCBvbmx5IGFmdGVyCiAqICAgICB0aGUgaXRlbXMgaGF2ZSBiZWVuIHByb2Nlc3NlZCB0aHJvdWdoIHRoZSBmaWx0ZXIuCiAqCiAqIEBleGFtcGxlCiAqIFRoaXMgZXhhbXBsZSBpbml0aWFsaXplcyB0aGUgc2NvcGUgdG8gYSBsaXN0IG9mIG5hbWVzIGFuZAogKiB0aGVuIHVzZXMgYG5nUmVwZWF0YCB0byBkaXNwbGF5IGV2ZXJ5IHBlcnNvbjoKICA8ZXhhbXBsZSBtb2R1bGU9Im5nQW5pbWF0ZSIgZGVwcz0iYW5ndWxhci1hbmltYXRlLmpzIiBhbmltYXRpb25zPSJ0cnVlIj4KICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICA8ZGl2IG5nLWluaXQ9ImZyaWVuZHMgPSBbCiAgICAgICAge25hbWU6J0pvaG4nLCBhZ2U6MjUsIGdlbmRlcjonYm95J30sCiAgICAgICAge25hbWU6J0plc3NpZScsIGFnZTozMCwgZ2VuZGVyOidnaXJsJ30sCiAgICAgICAge25hbWU6J0pvaGFubmEnLCBhZ2U6MjgsIGdlbmRlcjonZ2lybCd9LAogICAgICAgIHtuYW1lOidKb3knLCBhZ2U6MTUsIGdlbmRlcjonZ2lybCd9LAogICAgICAgIHtuYW1lOidNYXJ5JywgYWdlOjI4LCBnZW5kZXI6J2dpcmwnfSwKICAgICAgICB7bmFtZTonUGV0ZXInLCBhZ2U6OTUsIGdlbmRlcjonYm95J30sCiAgICAgICAge25hbWU6J1NlYmFzdGlhbicsIGFnZTo1MCwgZ2VuZGVyOidib3knfSwKICAgICAgICB7bmFtZTonRXJpa2EnLCBhZ2U6MjcsIGdlbmRlcjonZ2lybCd9LAogICAgICAgIHtuYW1lOidQYXRyaWNrJywgYWdlOjQwLCBnZW5kZXI6J2JveSd9LAogICAgICAgIHtuYW1lOidTYW1hbnRoYScsIGFnZTo2MCwgZ2VuZGVyOidnaXJsJ30KICAgICAgXSI+CiAgICAgICAgSSBoYXZlIHt7ZnJpZW5kcy5sZW5ndGh9fSBmcmllbmRzLiBUaGV5IGFyZToKICAgICAgICA8aW5wdXQgdHlwZT0ic2VhcmNoIiBuZy1tb2RlbD0icSIgcGxhY2Vob2xkZXI9ImZpbHRlciBmcmllbmRzLi4uIiAvPgogICAgICAgIDx1bCBjbGFzcz0iZXhhbXBsZS1hbmltYXRlLWNvbnRhaW5lciI+CiAgICAgICAgICA8bGkgY2xhc3M9ImFuaW1hdGUtcmVwZWF0IiBuZy1yZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIHwgZmlsdGVyOnEgYXMgcmVzdWx0cyI+CiAgICAgICAgICAgIFt7eyRpbmRleCArIDF9fV0ge3tmcmllbmQubmFtZX19IHdobyBpcyB7e2ZyaWVuZC5hZ2V9fSB5ZWFycyBvbGQuCiAgICAgICAgICA8L2xpPgogICAgICAgICAgPGxpIGNsYXNzPSJhbmltYXRlLXJlcGVhdCIgbmctaWY9InJlc3VsdHMubGVuZ3RoID09IDAiPgogICAgICAgICAgICA8c3Ryb25nPk5vIHJlc3VsdHMgZm91bmQuLi48L3N0cm9uZz4KICAgICAgICAgIDwvbGk+CiAgICAgICAgPC91bD4KICAgICAgPC9kaXY+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgIC5leGFtcGxlLWFuaW1hdGUtY29udGFpbmVyIHsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgbGlzdC1zdHlsZTpub25lOwogICAgICAgIG1hcmdpbjowOwogICAgICAgIHBhZGRpbmc6MCAxMHB4OwogICAgICB9CgogICAgICAuYW5pbWF0ZS1yZXBlYXQgewogICAgICAgIGxpbmUtaGVpZ2h0OjQwcHg7CiAgICAgICAgbGlzdC1zdHlsZTpub25lOwogICAgICAgIGJveC1zaXppbmc6Ym9yZGVyLWJveDsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLW1vdmUsCiAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1lbnRlciwKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWxlYXZlIHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICB9CgogICAgICAuYW5pbWF0ZS1yZXBlYXQubmctbGVhdmUubmctbGVhdmUtYWN0aXZlLAogICAgICAuYW5pbWF0ZS1yZXBlYXQubmctbW92ZSwKICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWVudGVyIHsKICAgICAgICBvcGFjaXR5OjA7CiAgICAgICAgbWF4LWhlaWdodDowOwogICAgICB9CgogICAgICAuYW5pbWF0ZS1yZXBlYXQubmctbGVhdmUsCiAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1tb3ZlLm5nLW1vdmUtYWN0aXZlLAogICAgICAuYW5pbWF0ZS1yZXBlYXQubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICAgICAgICBvcGFjaXR5OjE7CiAgICAgICAgbWF4LWhlaWdodDo0MHB4OwogICAgICB9CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgdmFyIGZyaWVuZHMgPSBlbGVtZW50LmFsbChieS5yZXBlYXRlcignZnJpZW5kIGluIGZyaWVuZHMnKSk7CgogICAgICBpdCgnc2hvdWxkIHJlbmRlciBpbml0aWFsIGRhdGEgc2V0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KGZyaWVuZHMuY291bnQoKSkudG9CZSgxMCk7CiAgICAgICAgZXhwZWN0KGZyaWVuZHMuZ2V0KDApLmdldFRleHQoKSkudG9FcXVhbCgnWzFdIEpvaG4gd2hvIGlzIDI1IHllYXJzIG9sZC4nKTsKICAgICAgICBleHBlY3QoZnJpZW5kcy5nZXQoMSkuZ2V0VGV4dCgpKS50b0VxdWFsKCdbMl0gSmVzc2llIHdobyBpcyAzMCB5ZWFycyBvbGQuJyk7CiAgICAgICAgZXhwZWN0KGZyaWVuZHMubGFzdCgpLmdldFRleHQoKSkudG9FcXVhbCgnWzEwXSBTYW1hbnRoYSB3aG8gaXMgNjAgeWVhcnMgb2xkLicpOwogICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2ZyaWVuZHMubGVuZ3RoJykpLmdldFRleHQoKSkKICAgICAgICAgICAgLnRvTWF0Y2goIkkgaGF2ZSAxMCBmcmllbmRzLiBUaGV5IGFyZToiKTsKICAgICAgfSk7CgogICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgcmVwZWF0ZXIgd2hlbiBmaWx0ZXIgcHJlZGljYXRlIGNoYW5nZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGZyaWVuZHMuY291bnQoKSkudG9CZSgxMCk7CgogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdxJykpLnNlbmRLZXlzKCdtYScpOwoKICAgICAgICAgZXhwZWN0KGZyaWVuZHMuY291bnQoKSkudG9CZSgyKTsKICAgICAgICAgZXhwZWN0KGZyaWVuZHMuZ2V0KDApLmdldFRleHQoKSkudG9FcXVhbCgnWzFdIE1hcnkgd2hvIGlzIDI4IHllYXJzIG9sZC4nKTsKICAgICAgICAgZXhwZWN0KGZyaWVuZHMubGFzdCgpLmdldFRleHQoKSkudG9FcXVhbCgnWzJdIFNhbWFudGhhIHdobyBpcyA2MCB5ZWFycyBvbGQuJyk7CiAgICAgICB9KTsKICAgICAgPC9maWxlPgogICAgPC9leGFtcGxlPgogKi8KdmFyIG5nUmVwZWF0RGlyZWN0aXZlID0gWyckcGFyc2UnLCAnJGFuaW1hdGUnLCBmdW5jdGlvbigkcGFyc2UsICRhbmltYXRlKSB7CiAgdmFyIE5HX1JFTU9WRUQgPSAnJCROR19SRU1PVkVEJzsKICB2YXIgbmdSZXBlYXRNaW5FcnIgPSBtaW5FcnIoJ25nUmVwZWF0Jyk7CgogIHZhciB1cGRhdGVTY29wZSA9IGZ1bmN0aW9uKHNjb3BlLCBpbmRleCwgdmFsdWVJZGVudGlmaWVyLCB2YWx1ZSwga2V5SWRlbnRpZmllciwga2V5LCBhcnJheUxlbmd0aCkgewogICAgLy8gVE9ETyhwZXJmKTogZ2VuZXJhdGUgc2V0dGVycyB0byBzaGF2ZSBvZmYgfjQwbXMgb3IgMS0xLjUlCiAgICBzY29wZVt2YWx1ZUlkZW50aWZpZXJdID0gdmFsdWU7CiAgICBpZiAoa2V5SWRlbnRpZmllcikgc2NvcGVba2V5SWRlbnRpZmllcl0gPSBrZXk7CiAgICBzY29wZS4kaW5kZXggPSBpbmRleDsKICAgIHNjb3BlLiRmaXJzdCA9IChpbmRleCA9PT0gMCk7CiAgICBzY29wZS4kbGFzdCA9IChpbmRleCA9PT0gKGFycmF5TGVuZ3RoIC0gMSkpOwogICAgc2NvcGUuJG1pZGRsZSA9ICEoc2NvcGUuJGZpcnN0IHx8IHNjb3BlLiRsYXN0KTsKICAgIC8vIGpzaGludCBiaXR3aXNlOiBmYWxzZQogICAgc2NvcGUuJG9kZCA9ICEoc2NvcGUuJGV2ZW4gPSAoaW5kZXgmMSkgPT09IDApOwogICAgLy8ganNoaW50IGJpdHdpc2U6IHRydWUKICB9OwoKICB2YXIgZ2V0QmxvY2tTdGFydCA9IGZ1bmN0aW9uKGJsb2NrKSB7CiAgICByZXR1cm4gYmxvY2suY2xvbmVbMF07CiAgfTsKCiAgdmFyIGdldEJsb2NrRW5kID0gZnVuY3Rpb24oYmxvY2spIHsKICAgIHJldHVybiBibG9jay5jbG9uZVtibG9jay5jbG9uZS5sZW5ndGggLSAxXTsKICB9OwoKCiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnQScsCiAgICBtdWx0aUVsZW1lbnQ6IHRydWUsCiAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICBwcmlvcml0eTogMTAwMCwKICAgIHRlcm1pbmFsOiB0cnVlLAogICAgJCR0bGI6IHRydWUsCiAgICBjb21waWxlOiBmdW5jdGlvbiBuZ1JlcGVhdENvbXBpbGUoJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgIHZhciBleHByZXNzaW9uID0gJGF0dHIubmdSZXBlYXQ7CiAgICAgIHZhciBuZ1JlcGVhdEVuZENvbW1lbnQgPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KCcgZW5kIG5nUmVwZWF0OiAnICsgZXhwcmVzc2lvbiArICcgJyk7CgogICAgICB2YXIgbWF0Y2ggPSBleHByZXNzaW9uLm1hdGNoKC9eXHMqKFtcc1xTXSs/KVxzK2luXHMrKFtcc1xTXSs/KSg/OlxzK2FzXHMrKFtcc1xTXSs/KSk/KD86XHMrdHJhY2tccytieVxzKyhbXHNcU10rPykpP1xzKiQvKTsKCiAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICB0aHJvdyBuZ1JlcGVhdE1pbkVycignaWV4cCcsICJFeHBlY3RlZCBleHByZXNzaW9uIGluIGZvcm0gb2YgJ19pdGVtXyBpbiBfY29sbGVjdGlvbl9bIHRyYWNrIGJ5IF9pZF9dJyBidXQgZ290ICd7MH0nLiIsCiAgICAgICAgICAgIGV4cHJlc3Npb24pOwogICAgICB9CgogICAgICB2YXIgbGhzID0gbWF0Y2hbMV07CiAgICAgIHZhciByaHMgPSBtYXRjaFsyXTsKICAgICAgdmFyIGFsaWFzQXMgPSBtYXRjaFszXTsKICAgICAgdmFyIHRyYWNrQnlFeHAgPSBtYXRjaFs0XTsKCiAgICAgIG1hdGNoID0gbGhzLm1hdGNoKC9eKD86KFtcJFx3XSspfFwoKFtcJFx3XSspXHMqLFxzKihbXCRcd10rKVwpKSQvKTsKCiAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICB0aHJvdyBuZ1JlcGVhdE1pbkVycignaWlkZXhwJywgIidfaXRlbV8nIGluICdfaXRlbV8gaW4gX2NvbGxlY3Rpb25fJyBzaG91bGQgYmUgYW4gaWRlbnRpZmllciBvciAnKF9rZXlfLCBfdmFsdWVfKScgZXhwcmVzc2lvbiwgYnV0IGdvdCAnezB9Jy4iLAogICAgICAgICAgICBsaHMpOwogICAgICB9CiAgICAgIHZhciB2YWx1ZUlkZW50aWZpZXIgPSBtYXRjaFszXSB8fCBtYXRjaFsxXTsKICAgICAgdmFyIGtleUlkZW50aWZpZXIgPSBtYXRjaFsyXTsKCiAgICAgIGlmIChhbGlhc0FzICYmICghL15bJGEtekEtWl9dWyRhLXpBLVowLTlfXSokLy50ZXN0KGFsaWFzQXMpIHx8CiAgICAgICAgICAvXihudWxsfHVuZGVmaW5lZHx0aGlzfFwkaW5kZXh8XCRmaXJzdHxcJG1pZGRsZXxcJGxhc3R8XCRldmVufFwkb2RkfFwkcGFyZW50KSQvLnRlc3QoYWxpYXNBcykpKSB7CiAgICAgICAgdGhyb3cgbmdSZXBlYXRNaW5FcnIoJ2JhZGlkZW50JywgImFsaWFzICd7MH0nIGlzIGludmFsaWQgLS0tIG11c3QgYmUgYSB2YWxpZCBKUyBpZGVudGlmaWVyIHdoaWNoIGlzIG5vdCBhIHJlc2VydmVkIG5hbWUuIiwKICAgICAgICAgIGFsaWFzQXMpOwogICAgICB9CgogICAgICB2YXIgdHJhY2tCeUV4cEdldHRlciwgdHJhY2tCeUlkRXhwRm4sIHRyYWNrQnlJZEFycmF5Rm4sIHRyYWNrQnlJZE9iakZuOwogICAgICB2YXIgaGFzaEZuTG9jYWxzID0geyRpZDogaGFzaEtleX07CgogICAgICBpZiAodHJhY2tCeUV4cCkgewogICAgICAgIHRyYWNrQnlFeHBHZXR0ZXIgPSAkcGFyc2UodHJhY2tCeUV4cCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHJhY2tCeUlkQXJyYXlGbiA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gaGFzaEtleSh2YWx1ZSk7CiAgICAgICAgfTsKICAgICAgICB0cmFja0J5SWRPYmpGbiA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZ1bmN0aW9uIG5nUmVwZWF0TGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgY3RybCwgJHRyYW5zY2x1ZGUpIHsKCiAgICAgICAgaWYgKHRyYWNrQnlFeHBHZXR0ZXIpIHsKICAgICAgICAgIHRyYWNrQnlJZEV4cEZuID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgLy8gYXNzaWduIGtleSwgdmFsdWUsIGFuZCAkaW5kZXggdG8gdGhlIGxvY2FscyBzbyB0aGF0IHRoZXkgY2FuIGJlIHVzZWQgaW4gaGFzaCBmdW5jdGlvbnMKICAgICAgICAgICAgaWYgKGtleUlkZW50aWZpZXIpIGhhc2hGbkxvY2Fsc1trZXlJZGVudGlmaWVyXSA9IGtleTsKICAgICAgICAgICAgaGFzaEZuTG9jYWxzW3ZhbHVlSWRlbnRpZmllcl0gPSB2YWx1ZTsKICAgICAgICAgICAgaGFzaEZuTG9jYWxzLiRpbmRleCA9IGluZGV4OwogICAgICAgICAgICByZXR1cm4gdHJhY2tCeUV4cEdldHRlcigkc2NvcGUsIGhhc2hGbkxvY2Fscyk7CiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLy8gU3RvcmUgYSBsaXN0IG9mIGVsZW1lbnRzIGZyb20gcHJldmlvdXMgcnVuLiBUaGlzIGlzIGEgaGFzaCB3aGVyZSBrZXkgaXMgdGhlIGl0ZW0gZnJvbSB0aGUKICAgICAgICAvLyBpdGVyYXRvciwgYW5kIHRoZSB2YWx1ZSBpcyBvYmplY3RzIHdpdGggZm9sbG93aW5nIHByb3BlcnRpZXMuCiAgICAgICAgLy8gICAtIHNjb3BlOiBib3VuZCBzY29wZQogICAgICAgIC8vICAgLSBlbGVtZW50OiBwcmV2aW91cyBlbGVtZW50LgogICAgICAgIC8vICAgLSBpbmRleDogcG9zaXRpb24KICAgICAgICAvLwogICAgICAgIC8vIFdlIGFyZSB1c2luZyBuby1wcm90byBvYmplY3Qgc28gdGhhdCB3ZSBkb24ndCBuZWVkIHRvIGd1YXJkIGFnYWluc3QgaW5oZXJpdGVkIHByb3BzIHZpYQogICAgICAgIC8vIGhhc093blByb3BlcnR5LgogICAgICAgIHZhciBsYXN0QmxvY2tNYXAgPSBjcmVhdGVNYXAoKTsKCiAgICAgICAgLy93YXRjaCBwcm9wcwogICAgICAgICRzY29wZS4kd2F0Y2hDb2xsZWN0aW9uKHJocywgZnVuY3Rpb24gbmdSZXBlYXRBY3Rpb24oY29sbGVjdGlvbikgewogICAgICAgICAgdmFyIGluZGV4LCBsZW5ndGgsCiAgICAgICAgICAgICAgcHJldmlvdXNOb2RlID0gJGVsZW1lbnRbMF0sICAgICAvLyBub2RlIHRoYXQgY2xvbmVkIG5vZGVzIHNob3VsZCBiZSBpbnNlcnRlZCBhZnRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW5pdGlhbGl6ZWQgdG8gdGhlIGNvbW1lbnQgbm9kZSBhbmNob3IKICAgICAgICAgICAgICBuZXh0Tm9kZSwKICAgICAgICAgICAgICAvLyBTYW1lIGFzIGxhc3RCbG9ja01hcCBidXQgaXQgaGFzIHRoZSBjdXJyZW50IHN0YXRlLiBJdCB3aWxsIGJlY29tZSB0aGUKICAgICAgICAgICAgICAvLyBsYXN0QmxvY2tNYXAgb24gdGhlIG5leHQgaXRlcmF0aW9uLgogICAgICAgICAgICAgIG5leHRCbG9ja01hcCA9IGNyZWF0ZU1hcCgpLAogICAgICAgICAgICAgIGNvbGxlY3Rpb25MZW5ndGgsCiAgICAgICAgICAgICAga2V5LCB2YWx1ZSwgLy8ga2V5L3ZhbHVlIG9mIGl0ZXJhdGlvbgogICAgICAgICAgICAgIHRyYWNrQnlJZCwKICAgICAgICAgICAgICB0cmFja0J5SWRGbiwKICAgICAgICAgICAgICBjb2xsZWN0aW9uS2V5cywKICAgICAgICAgICAgICBibG9jaywgICAgICAgLy8gbGFzdCBvYmplY3QgaW5mb3JtYXRpb24ge3Njb3BlLCBlbGVtZW50LCBpZH0KICAgICAgICAgICAgICBuZXh0QmxvY2tPcmRlciwKICAgICAgICAgICAgICBlbGVtZW50c1RvUmVtb3ZlOwoKICAgICAgICAgIGlmIChhbGlhc0FzKSB7CiAgICAgICAgICAgICRzY29wZVthbGlhc0FzXSA9IGNvbGxlY3Rpb247CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGlzQXJyYXlMaWtlKGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgIGNvbGxlY3Rpb25LZXlzID0gY29sbGVjdGlvbjsKICAgICAgICAgICAgdHJhY2tCeUlkRm4gPSB0cmFja0J5SWRFeHBGbiB8fCB0cmFja0J5SWRBcnJheUZuOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdHJhY2tCeUlkRm4gPSB0cmFja0J5SWRFeHBGbiB8fCB0cmFja0J5SWRPYmpGbjsKICAgICAgICAgICAgLy8gaWYgb2JqZWN0LCBleHRyYWN0IGtleXMsIHNvcnQgdGhlbSBhbmQgdXNlIHRvIGRldGVybWluZSBvcmRlciBvZiBpdGVyYXRpb24gb3ZlciBvYmogcHJvcHMKICAgICAgICAgICAgY29sbGVjdGlvbktleXMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaXRlbUtleSBpbiBjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgaWYgKGNvbGxlY3Rpb24uaGFzT3duUHJvcGVydHkoaXRlbUtleSkgJiYgaXRlbUtleS5jaGFyQXQoMCkgIT0gJyQnKSB7CiAgICAgICAgICAgICAgICBjb2xsZWN0aW9uS2V5cy5wdXNoKGl0ZW1LZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb2xsZWN0aW9uS2V5cy5zb3J0KCk7CiAgICAgICAgICB9CgogICAgICAgICAgY29sbGVjdGlvbkxlbmd0aCA9IGNvbGxlY3Rpb25LZXlzLmxlbmd0aDsKICAgICAgICAgIG5leHRCbG9ja09yZGVyID0gbmV3IEFycmF5KGNvbGxlY3Rpb25MZW5ndGgpOwoKICAgICAgICAgIC8vIGxvY2F0ZSBleGlzdGluZyBpdGVtcwogICAgICAgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgY29sbGVjdGlvbkxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICBrZXkgPSAoY29sbGVjdGlvbiA9PT0gY29sbGVjdGlvbktleXMpID8gaW5kZXggOiBjb2xsZWN0aW9uS2V5c1tpbmRleF07CiAgICAgICAgICAgIHZhbHVlID0gY29sbGVjdGlvbltrZXldOwogICAgICAgICAgICB0cmFja0J5SWQgPSB0cmFja0J5SWRGbihrZXksIHZhbHVlLCBpbmRleCk7CiAgICAgICAgICAgIGlmIChsYXN0QmxvY2tNYXBbdHJhY2tCeUlkXSkgewogICAgICAgICAgICAgIC8vIGZvdW5kIHByZXZpb3VzbHkgc2VlbiBibG9jawogICAgICAgICAgICAgIGJsb2NrID0gbGFzdEJsb2NrTWFwW3RyYWNrQnlJZF07CiAgICAgICAgICAgICAgZGVsZXRlIGxhc3RCbG9ja01hcFt0cmFja0J5SWRdOwogICAgICAgICAgICAgIG5leHRCbG9ja01hcFt0cmFja0J5SWRdID0gYmxvY2s7CiAgICAgICAgICAgICAgbmV4dEJsb2NrT3JkZXJbaW5kZXhdID0gYmxvY2s7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobmV4dEJsb2NrTWFwW3RyYWNrQnlJZF0pIHsKICAgICAgICAgICAgICAvLyBpZiBjb2xsaXNpb24gZGV0ZWN0ZWQuIHJlc3RvcmUgbGFzdEJsb2NrTWFwIGFuZCB0aHJvdyBhbiBlcnJvcgogICAgICAgICAgICAgIGZvckVhY2gobmV4dEJsb2NrT3JkZXIsIGZ1bmN0aW9uIChibG9jaykgewogICAgICAgICAgICAgICAgaWYgKGJsb2NrICYmIGJsb2NrLnNjb3BlKSBsYXN0QmxvY2tNYXBbYmxvY2suaWRdID0gYmxvY2s7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdGhyb3cgbmdSZXBlYXRNaW5FcnIoJ2R1cGVzJywKICAgICAgICAgICAgICAgICAgIkR1cGxpY2F0ZXMgaW4gYSByZXBlYXRlciBhcmUgbm90IGFsbG93ZWQuIFVzZSAndHJhY2sgYnknIGV4cHJlc3Npb24gdG8gc3BlY2lmeSB1bmlxdWUga2V5cy4gUmVwZWF0ZXI6IHswfSwgRHVwbGljYXRlIGtleTogezF9LCBEdXBsaWNhdGUgdmFsdWU6IHsyfSIsCiAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24sIHRyYWNrQnlJZCwgdG9Kc29uKHZhbHVlKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gbmV3IG5ldmVyIGJlZm9yZSBzZWVuIGJsb2NrCiAgICAgICAgICAgICAgbmV4dEJsb2NrT3JkZXJbaW5kZXhdID0ge2lkOiB0cmFja0J5SWQsIHNjb3BlOiB1bmRlZmluZWQsIGNsb25lOiB1bmRlZmluZWR9OwogICAgICAgICAgICAgIG5leHRCbG9ja01hcFt0cmFja0J5SWRdID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIHJlbW92ZSBsZWZ0b3ZlciBpdGVtcwogICAgICAgICAgZm9yICh2YXIgYmxvY2tLZXkgaW4gbGFzdEJsb2NrTWFwKSB7CiAgICAgICAgICAgIGJsb2NrID0gbGFzdEJsb2NrTWFwW2Jsb2NrS2V5XTsKICAgICAgICAgICAgZWxlbWVudHNUb1JlbW92ZSA9IGdldEJsb2NrTm9kZXMoYmxvY2suY2xvbmUpOwogICAgICAgICAgICAkYW5pbWF0ZS5sZWF2ZShlbGVtZW50c1RvUmVtb3ZlKTsKICAgICAgICAgICAgaWYgKGVsZW1lbnRzVG9SZW1vdmVbMF0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgIC8vIGlmIHRoZSBlbGVtZW50IHdhcyBub3QgcmVtb3ZlZCB5ZXQgYmVjYXVzZSBvZiBwZW5kaW5nIGFuaW1hdGlvbiwgbWFyayBpdCBhcyBkZWxldGVkCiAgICAgICAgICAgICAgLy8gc28gdGhhdCB3ZSBjYW4gaWdub3JlIGl0IGxhdGVyCiAgICAgICAgICAgICAgZm9yIChpbmRleCA9IDAsIGxlbmd0aCA9IGVsZW1lbnRzVG9SZW1vdmUubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgZWxlbWVudHNUb1JlbW92ZVtpbmRleF1bTkdfUkVNT1ZFRF0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBibG9jay5zY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIHdlIGFyZSBub3QgdXNpbmcgZm9yRWFjaCBmb3IgcGVyZiByZWFzb25zICh0cnlpbmcgdG8gYXZvaWQgI2NhbGwpCiAgICAgICAgICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBjb2xsZWN0aW9uTGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgIGtleSA9IChjb2xsZWN0aW9uID09PSBjb2xsZWN0aW9uS2V5cykgPyBpbmRleCA6IGNvbGxlY3Rpb25LZXlzW2luZGV4XTsKICAgICAgICAgICAgdmFsdWUgPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgIGJsb2NrID0gbmV4dEJsb2NrT3JkZXJbaW5kZXhdOwoKICAgICAgICAgICAgaWYgKGJsb2NrLnNjb3BlKSB7CiAgICAgICAgICAgICAgLy8gaWYgd2UgaGF2ZSBhbHJlYWR5IHNlZW4gdGhpcyBvYmplY3QsIHRoZW4gd2UgbmVlZCB0byByZXVzZSB0aGUKICAgICAgICAgICAgICAvLyBhc3NvY2lhdGVkIHNjb3BlL2VsZW1lbnQKCiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBwcmV2aW91c05vZGU7CgogICAgICAgICAgICAgIC8vIHNraXAgbm9kZXMgdGhhdCBhcmUgYWxyZWFkeSBwZW5kaW5nIHJlbW92YWwgdmlhIGxlYXZlIGFuaW1hdGlvbgogICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIG5leHROb2RlID0gbmV4dE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgfSB3aGlsZSAobmV4dE5vZGUgJiYgbmV4dE5vZGVbTkdfUkVNT1ZFRF0pOwoKICAgICAgICAgICAgICBpZiAoZ2V0QmxvY2tTdGFydChibG9jaykgIT0gbmV4dE5vZGUpIHsKICAgICAgICAgICAgICAgIC8vIGV4aXN0aW5nIGl0ZW0gd2hpY2ggZ290IG1vdmVkCiAgICAgICAgICAgICAgICAkYW5pbWF0ZS5tb3ZlKGdldEJsb2NrTm9kZXMoYmxvY2suY2xvbmUpLCBudWxsLCBqcUxpdGUocHJldmlvdXNOb2RlKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzTm9kZSA9IGdldEJsb2NrRW5kKGJsb2NrKTsKICAgICAgICAgICAgICB1cGRhdGVTY29wZShibG9jay5zY29wZSwgaW5kZXgsIHZhbHVlSWRlbnRpZmllciwgdmFsdWUsIGtleUlkZW50aWZpZXIsIGtleSwgY29sbGVjdGlvbkxlbmd0aCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gbmV3IGl0ZW0gd2hpY2ggd2UgZG9uJ3Qga25vdyBhYm91dAogICAgICAgICAgICAgICR0cmFuc2NsdWRlKGZ1bmN0aW9uIG5nUmVwZWF0VHJhbnNjbHVkZShjbG9uZSwgc2NvcGUpIHsKICAgICAgICAgICAgICAgIGJsb2NrLnNjb3BlID0gc2NvcGU7CiAgICAgICAgICAgICAgICAvLyBodHRwOi8vanNwZXJmLmNvbS9jbG9uZS12cy1jcmVhdGVjb21tZW50CiAgICAgICAgICAgICAgICB2YXIgZW5kTm9kZSA9IG5nUmVwZWF0RW5kQ29tbWVudC5jbG9uZU5vZGUoZmFsc2UpOwogICAgICAgICAgICAgICAgY2xvbmVbY2xvbmUubGVuZ3RoKytdID0gZW5kTm9kZTsKCiAgICAgICAgICAgICAgICAvLyBUT0RPKHBlcmYpOiBzdXBwb3J0IG5ha2VkIHByZXZpb3VzTm9kZSBpbiBgZW50ZXJgIHRvIGF2b2lkIGNyZWF0aW9uIG9mIGpxTGl0ZSB3cmFwcGVyPwogICAgICAgICAgICAgICAgJGFuaW1hdGUuZW50ZXIoY2xvbmUsIG51bGwsIGpxTGl0ZShwcmV2aW91c05vZGUpKTsKICAgICAgICAgICAgICAgIHByZXZpb3VzTm9kZSA9IGVuZE5vZGU7CiAgICAgICAgICAgICAgICAvLyBOb3RlOiBXZSBvbmx5IG5lZWQgdGhlIGZpcnN0L2xhc3Qgbm9kZSBvZiB0aGUgY2xvbmVkIG5vZGVzLgogICAgICAgICAgICAgICAgLy8gSG93ZXZlciwgd2UgbmVlZCB0byBrZWVwIHRoZSByZWZlcmVuY2UgdG8gdGhlIGpxbGl0ZSB3cmFwcGVyIGFzIGl0IG1pZ2h0IGJlIGNoYW5nZWQgbGF0ZXIKICAgICAgICAgICAgICAgIC8vIGJ5IGEgZGlyZWN0aXZlIHdpdGggdGVtcGxhdGVVcmwgd2hlbiBpdHMgdGVtcGxhdGUgYXJyaXZlcy4KICAgICAgICAgICAgICAgIGJsb2NrLmNsb25lID0gY2xvbmU7CiAgICAgICAgICAgICAgICBuZXh0QmxvY2tNYXBbYmxvY2suaWRdID0gYmxvY2s7CiAgICAgICAgICAgICAgICB1cGRhdGVTY29wZShibG9jay5zY29wZSwgaW5kZXgsIHZhbHVlSWRlbnRpZmllciwgdmFsdWUsIGtleUlkZW50aWZpZXIsIGtleSwgY29sbGVjdGlvbkxlbmd0aCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGxhc3RCbG9ja01hcCA9IG5leHRCbG9ja01hcDsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0KICB9Owp9XTsKCnZhciBOR19ISURFX0NMQVNTID0gJ25nLWhpZGUnOwp2YXIgTkdfSElERV9JTl9QUk9HUkVTU19DTEFTUyA9ICduZy1oaWRlLWFuaW1hdGUnOwovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1Nob3cKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdTaG93YCBkaXJlY3RpdmUgc2hvd3Mgb3IgaGlkZXMgdGhlIGdpdmVuIEhUTUwgZWxlbWVudCBiYXNlZCBvbiB0aGUgZXhwcmVzc2lvbgogKiBwcm92aWRlZCB0byB0aGUgYG5nU2hvd2AgYXR0cmlidXRlLiBUaGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gYnkgcmVtb3Zpbmcgb3IgYWRkaW5nCiAqIHRoZSBgLm5nLWhpZGVgIENTUyBjbGFzcyBvbnRvIHRoZSBlbGVtZW50LiBUaGUgYC5uZy1oaWRlYCBDU1MgY2xhc3MgaXMgcHJlZGVmaW5lZAogKiBpbiBBbmd1bGFySlMgYW5kIHNldHMgdGhlIGRpc3BsYXkgc3R5bGUgdG8gbm9uZSAodXNpbmcgYW4gIWltcG9ydGFudCBmbGFnKS4KICogRm9yIENTUCBtb2RlIHBsZWFzZSBhZGQgYGFuZ3VsYXItY3NwLmNzc2AgdG8geW91ciBodG1sIGZpbGUgKHNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ3NwIG5nQ3NwfSkuCiAqCiAqIGBgYGh0bWwKICogPCEtLSB3aGVuICRzY29wZS5teVZhbHVlIGlzIHRydXRoeSAoZWxlbWVudCBpcyB2aXNpYmxlKSAtLT4KICogPGRpdiBuZy1zaG93PSJteVZhbHVlIj48L2Rpdj4KICoKICogPCEtLSB3aGVuICRzY29wZS5teVZhbHVlIGlzIGZhbHN5IChlbGVtZW50IGlzIGhpZGRlbikgLS0+CiAqIDxkaXYgbmctc2hvdz0ibXlWYWx1ZSIgY2xhc3M9Im5nLWhpZGUiPjwvZGl2PgogKiBgYGAKICoKICogV2hlbiB0aGUgYG5nU2hvd2AgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSBmYWxzeSB2YWx1ZSB0aGVuIHRoZSBgLm5nLWhpZGVgIENTUyBjbGFzcyBpcyBhZGRlZCB0byB0aGUgY2xhc3MKICogYXR0cmlidXRlIG9uIHRoZSBlbGVtZW50IGNhdXNpbmcgaXQgdG8gYmVjb21lIGhpZGRlbi4gV2hlbiB0cnV0aHksIHRoZSBgLm5nLWhpZGVgIENTUyBjbGFzcyBpcyByZW1vdmVkCiAqIGZyb20gdGhlIGVsZW1lbnQgY2F1c2luZyB0aGUgZWxlbWVudCBub3QgdG8gYXBwZWFyIGhpZGRlbi4KICoKICogIyMgV2h5IGlzICFpbXBvcnRhbnQgdXNlZD8KICoKICogWW91IG1heSBiZSB3b25kZXJpbmcgd2h5ICFpbXBvcnRhbnQgaXMgdXNlZCBmb3IgdGhlIGAubmctaGlkZWAgQ1NTIGNsYXNzLiBUaGlzIGlzIGJlY2F1c2UgdGhlIGAubmctaGlkZWAgc2VsZWN0b3IKICogY2FuIGJlIGVhc2lseSBvdmVycmlkZGVuIGJ5IGhlYXZpZXIgc2VsZWN0b3JzLiBGb3IgZXhhbXBsZSwgc29tZXRoaW5nIGFzIHNpbXBsZQogKiBhcyBjaGFuZ2luZyB0aGUgZGlzcGxheSBzdHlsZSBvbiBhIEhUTUwgbGlzdCBpdGVtIHdvdWxkIG1ha2UgaGlkZGVuIGVsZW1lbnRzIGFwcGVhciB2aXNpYmxlLgogKiBUaGlzIGFsc28gYmVjb21lcyBhIGJpZ2dlciBpc3N1ZSB3aGVuIGRlYWxpbmcgd2l0aCBDU1MgZnJhbWV3b3Jrcy4KICoKICogQnkgdXNpbmcgIWltcG9ydGFudCwgdGhlIHNob3cgYW5kIGhpZGUgYmVoYXZpb3Igd2lsbCB3b3JrIGFzIGV4cGVjdGVkIGRlc3BpdGUgYW55IGNsYXNoIGJldHdlZW4gQ1NTIHNlbGVjdG9yCiAqIHNwZWNpZmljaXR5ICh3aGVuICFpbXBvcnRhbnQgaXNuJ3QgdXNlZCB3aXRoIGFueSBjb25mbGljdGluZyBzdHlsZXMpLiBJZiBhIGRldmVsb3BlciBjaG9vc2VzIHRvIG92ZXJyaWRlIHRoZQogKiBzdHlsaW5nIHRvIGNoYW5nZSBob3cgdG8gaGlkZSBhbiBlbGVtZW50IHRoZW4gaXQgaXMganVzdCBhIG1hdHRlciBvZiB1c2luZyAhaW1wb3J0YW50IGluIHRoZWlyIG93biBDU1MgY29kZS4KICoKICogIyMjIE92ZXJyaWRpbmcgYC5uZy1oaWRlYAogKgogKiBCeSBkZWZhdWx0LCB0aGUgYC5uZy1oaWRlYCBjbGFzcyB3aWxsIHN0eWxlIHRoZSBlbGVtZW50IHdpdGggYGRpc3BsYXk6bm9uZSFpbXBvcnRhbnRgLiBJZiB5b3Ugd2lzaCB0byBjaGFuZ2UKICogdGhlIGhpZGUgYmVoYXZpb3Igd2l0aCBuZ1Nob3cvbmdIaWRlIHRoZW4gdGhpcyBjYW4gYmUgYWNoaWV2ZWQgYnkgcmVzdGF0aW5nIHRoZSBzdHlsZXMgZm9yIHRoZSBgLm5nLWhpZGVgCiAqIGNsYXNzIGluIENTUzoKICoKICogYGBgY3NzCiAqIC5uZy1oaWRlIHsKICogICAvJiM0MjsgdGhpcyBpcyBqdXN0IGFub3RoZXIgZm9ybSBvZiBoaWRpbmcgYW4gZWxlbWVudCAmIzQyOy8KICogICBkaXNwbGF5OmJsb2NrIWltcG9ydGFudDsKICogICBwb3NpdGlvbjphYnNvbHV0ZTsKICogICB0b3A6LTk5OTlweDsKICogICBsZWZ0Oi05OTk5cHg7CiAqIH0KICogYGBgCiAqCiAqIEJ5IGRlZmF1bHQgeW91IGRvbid0IG5lZWQgdG8gb3ZlcnJpZGUgaW4gQ1NTIGFueXRoaW5nIGFuZCB0aGUgYW5pbWF0aW9ucyB3aWxsIHdvcmsgYXJvdW5kIHRoZSBkaXNwbGF5IHN0eWxlLgogKgogKiAjIyBBIG5vdGUgYWJvdXQgYW5pbWF0aW9ucyB3aXRoIGBuZ1Nob3dgCiAqCiAqIEFuaW1hdGlvbnMgaW4gbmdTaG93L25nSGlkZSB3b3JrIHdpdGggdGhlIHNob3cgYW5kIGhpZGUgZXZlbnRzIHRoYXQgYXJlIHRyaWdnZXJlZCB3aGVuIHRoZSBkaXJlY3RpdmUgZXhwcmVzc2lvbgogKiBpcyB0cnVlIGFuZCBmYWxzZS4gVGhpcyBzeXN0ZW0gd29ya3MgbGlrZSB0aGUgYW5pbWF0aW9uIHN5c3RlbSBwcmVzZW50IHdpdGggbmdDbGFzcyBleGNlcHQgdGhhdAogKiB5b3UgbXVzdCBhbHNvIGluY2x1ZGUgdGhlICFpbXBvcnRhbnQgZmxhZyB0byBvdmVycmlkZSB0aGUgZGlzcGxheSBwcm9wZXJ0eQogKiBzbyB0aGF0IHlvdSBjYW4gcGVyZm9ybSBhbiBhbmltYXRpb24gd2hlbiB0aGUgZWxlbWVudCBpcyBoaWRkZW4gZHVyaW5nIHRoZSB0aW1lIG9mIHRoZSBhbmltYXRpb24uCiAqCiAqIGBgYGNzcwogKiAvLwogKiAvL2Egd29ya2luZyBleGFtcGxlIGNhbiBiZSBmb3VuZCBhdCB0aGUgYm90dG9tIG9mIHRoaXMgcGFnZQogKiAvLwogKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCwgLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgewogKiAgIC8mIzQyOyB0aGlzIGlzIHJlcXVpcmVkIGFzIG9mIDEuM3ggdG8gcHJvcGVybHkKICogICAgICBhcHBseSBhbGwgc3R5bGluZyBpbiBhIHNob3cvaGlkZSBhbmltYXRpb24gJiM0MjsvCiAqICAgdHJhbnNpdGlvbjowcyBsaW5lYXIgYWxsOwogKiB9CiAqCiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkLWFjdGl2ZSwKICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUtYWN0aXZlIHsKICogICAvJiM0MjsgdGhlIHRyYW5zaXRpb24gaXMgZGVmaW5lZCBpbiB0aGUgYWN0aXZlIGNsYXNzICYjNDI7LwogKiAgIHRyYW5zaXRpb246MXMgbGluZWFyIGFsbDsKICogfQogKgogKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCB7IC4uLiB9CiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkLm5nLWhpZGUtYWRkLWFjdGl2ZSB7IC4uLiB9CiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlIHsgLi4uIH0KICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUubmctaGlkZS1yZW1vdmUtYWN0aXZlIHsgLi4uIH0KICogYGBgCiAqCiAqIEtlZXAgaW4gbWluZCB0aGF0LCBhcyBvZiBBbmd1bGFySlMgdmVyc2lvbiAxLjMuMC1iZXRhLjExLCB0aGVyZSBpcyBubyBuZWVkIHRvIGNoYW5nZSB0aGUgZGlzcGxheQogKiBwcm9wZXJ0eSB0byBibG9jayBkdXJpbmcgYW5pbWF0aW9uIHN0YXRlcy0tbmdBbmltYXRlIHdpbGwgaGFuZGxlIHRoZSBzdHlsZSB0b2dnbGluZyBhdXRvbWF0aWNhbGx5IGZvciB5b3UuCiAqCiAqIEBhbmltYXRpb25zCiAqIGFkZENsYXNzOiBgLm5nLWhpZGVgIC0gaGFwcGVucyBhZnRlciB0aGUgYG5nU2hvd2AgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSB0cnV0aHkgdmFsdWUgYW5kIHRoZSBqdXN0IGJlZm9yZSBjb250ZW50cyBhcmUgc2V0IHRvIHZpc2libGUKICogcmVtb3ZlQ2xhc3M6IGAubmctaGlkZWAgLSBoYXBwZW5zIGFmdGVyIHRoZSBgbmdTaG93YCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhIG5vbiB0cnV0aHkgdmFsdWUgYW5kIGp1c3QgYmVmb3JlIHRoZSBjb250ZW50cyBhcmUgc2V0IHRvIGhpZGRlbgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1Nob3cgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeQogKiAgICAgdGhlbiB0aGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gcmVzcGVjdGl2ZWx5LgogKgogKiBAZXhhbXBsZQogIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIENsaWNrIG1lOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgICA8ZGl2PgogICAgICAgIFNob3c6CiAgICAgICAgPGRpdiBjbGFzcz0iY2hlY2stZWxlbWVudCBhbmltYXRlLXNob3ciIG5nLXNob3c9ImNoZWNrZWQiPgogICAgICAgICAgPHNwYW4gY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24tdGh1bWJzLXVwIj48L3NwYW4+IEkgc2hvdyB1cCB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXY+CiAgICAgICAgSGlkZToKICAgICAgICA8ZGl2IGNsYXNzPSJjaGVjay1lbGVtZW50IGFuaW1hdGUtc2hvdyIgbmctaGlkZT0iY2hlY2tlZCI+CiAgICAgICAgICA8c3BhbiBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi10aHVtYnMtZG93biI+PC9zcGFuPiBJIGhpZGUgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuCiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iZ2x5cGhpY29ucy5jc3MiPgogICAgICBAaW1wb3J0IHVybCgvL25ldGRuYS5ib290c3RyYXBjZG4uY29tL2Jvb3RzdHJhcC8zLjAuMC9jc3MvYm9vdHN0cmFwLWdseXBoaWNvbnMuY3NzKTsKICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9ImFuaW1hdGlvbnMuY3NzIj4KICAgICAgLmFuaW1hdGUtc2hvdyB7CiAgICAgICAgbGluZS1oZWlnaHQ6MjBweDsKICAgICAgICBvcGFjaXR5OjE7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtc2hvdy5uZy1oaWRlLWFkZC5uZy1oaWRlLWFkZC1hY3RpdmUsCiAgICAgIC5hbmltYXRlLXNob3cubmctaGlkZS1yZW1vdmUubmctaGlkZS1yZW1vdmUtYWN0aXZlIHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICB9CgogICAgICAuYW5pbWF0ZS1zaG93Lm5nLWhpZGUgewogICAgICAgIGxpbmUtaGVpZ2h0OjA7CiAgICAgICAgb3BhY2l0eTowOwogICAgICAgIHBhZGRpbmc6MCAxMHB4OwogICAgICB9CgogICAgICAuY2hlY2stZWxlbWVudCB7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgfQogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgIHZhciB0aHVtYnNVcCA9IGVsZW1lbnQoYnkuY3NzKCdzcGFuLmdseXBoaWNvbi10aHVtYnMtdXAnKSk7CiAgICAgIHZhciB0aHVtYnNEb3duID0gZWxlbWVudChieS5jc3MoJ3NwYW4uZ2x5cGhpY29uLXRodW1icy1kb3duJykpOwoKICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zaG93IC8gbmctaGlkZScsIGZ1bmN0aW9uKCkgewogICAgICAgIGV4cGVjdCh0aHVtYnNVcC5pc0Rpc3BsYXllZCgpKS50b0JlRmFsc3koKTsKICAgICAgICBleHBlY3QodGh1bWJzRG93bi5pc0Rpc3BsYXllZCgpKS50b0JlVHJ1dGh5KCk7CgogICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2NoZWNrZWQnKSkuY2xpY2soKTsKCiAgICAgICAgZXhwZWN0KHRodW1ic1VwLmlzRGlzcGxheWVkKCkpLnRvQmVUcnV0aHkoKTsKICAgICAgICBleHBlY3QodGh1bWJzRG93bi5pc0Rpc3BsYXllZCgpKS50b0JlRmFsc3koKTsKICAgICAgfSk7CiAgICA8L2ZpbGU+CiAgPC9leGFtcGxlPgogKi8KdmFyIG5nU2hvd0RpcmVjdGl2ZSA9IFsnJGFuaW1hdGUnLCBmdW5jdGlvbigkYW5pbWF0ZSkgewogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0EnLAogICAgbXVsdGlFbGVtZW50OiB0cnVlLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdTaG93LCBmdW5jdGlvbiBuZ1Nob3dXYXRjaEFjdGlvbih2YWx1ZSl7CiAgICAgICAgLy8gd2UncmUgYWRkaW5nIGEgdGVtcG9yYXJ5LCBhbmltYXRpb24tc3BlY2lmaWMgY2xhc3MgZm9yIG5nLWhpZGUgc2luY2UgdGhpcyB3YXkKICAgICAgICAvLyB3ZSBjYW4gY29udHJvbCB3aGVuIHRoZSBlbGVtZW50IGlzIGFjdHVhbGx5IGRpc3BsYXllZCBvbiBzY3JlZW4gd2l0aG91dCBoYXZpbmcKICAgICAgICAvLyB0byBoYXZlIGEgZ2xvYmFsL2dyZWVkeSBDU1Mgc2VsZWN0b3IgdGhhdCBicmVha3Mgd2hlbiBvdGhlciBhbmltYXRpb25zIGFyZSBydW4uCiAgICAgICAgLy8gUmVhZDogaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvOTEwMyNpc3N1ZWNvbW1lbnQtNTgzMzU4NDUKICAgICAgICAkYW5pbWF0ZVt2YWx1ZSA/ICdyZW1vdmVDbGFzcycgOiAnYWRkQ2xhc3MnXShlbGVtZW50LCBOR19ISURFX0NMQVNTLCB7CiAgICAgICAgICB0ZW1wQ2xhc3NlcyA6IE5HX0hJREVfSU5fUFJPR1JFU1NfQ0xBU1MKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfTsKfV07CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgbmdIaWRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nSGlkZWAgZGlyZWN0aXZlIHNob3dzIG9yIGhpZGVzIHRoZSBnaXZlbiBIVE1MIGVsZW1lbnQgYmFzZWQgb24gdGhlIGV4cHJlc3Npb24KICogcHJvdmlkZWQgdG8gdGhlIGBuZ0hpZGVgIGF0dHJpYnV0ZS4gVGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIGJ5IHJlbW92aW5nIG9yIGFkZGluZwogKiB0aGUgYG5nLWhpZGVgIENTUyBjbGFzcyBvbnRvIHRoZSBlbGVtZW50LiBUaGUgYC5uZy1oaWRlYCBDU1MgY2xhc3MgaXMgcHJlZGVmaW5lZAogKiBpbiBBbmd1bGFySlMgYW5kIHNldHMgdGhlIGRpc3BsYXkgc3R5bGUgdG8gbm9uZSAodXNpbmcgYW4gIWltcG9ydGFudCBmbGFnKS4KICogRm9yIENTUCBtb2RlIHBsZWFzZSBhZGQgYGFuZ3VsYXItY3NwLmNzc2AgdG8geW91ciBodG1sIGZpbGUgKHNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ3NwIG5nQ3NwfSkuCiAqCiAqIGBgYGh0bWwKICogPCEtLSB3aGVuICRzY29wZS5teVZhbHVlIGlzIHRydXRoeSAoZWxlbWVudCBpcyBoaWRkZW4pIC0tPgogKiA8ZGl2IG5nLWhpZGU9Im15VmFsdWUiIGNsYXNzPSJuZy1oaWRlIj48L2Rpdj4KICoKICogPCEtLSB3aGVuICRzY29wZS5teVZhbHVlIGlzIGZhbHN5IChlbGVtZW50IGlzIHZpc2libGUpIC0tPgogKiA8ZGl2IG5nLWhpZGU9Im15VmFsdWUiPjwvZGl2PgogKiBgYGAKICoKICogV2hlbiB0aGUgYG5nSGlkZWAgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSB0cnV0aHkgdmFsdWUgdGhlbiB0aGUgYC5uZy1oaWRlYCBDU1MgY2xhc3MgaXMgYWRkZWQgdG8gdGhlIGNsYXNzCiAqIGF0dHJpYnV0ZSBvbiB0aGUgZWxlbWVudCBjYXVzaW5nIGl0IHRvIGJlY29tZSBoaWRkZW4uIFdoZW4gZmFsc3ksIHRoZSBgLm5nLWhpZGVgIENTUyBjbGFzcyBpcyByZW1vdmVkCiAqIGZyb20gdGhlIGVsZW1lbnQgY2F1c2luZyB0aGUgZWxlbWVudCBub3QgdG8gYXBwZWFyIGhpZGRlbi4KICoKICogIyMgV2h5IGlzICFpbXBvcnRhbnQgdXNlZD8KICoKICogWW91IG1heSBiZSB3b25kZXJpbmcgd2h5ICFpbXBvcnRhbnQgaXMgdXNlZCBmb3IgdGhlIGAubmctaGlkZWAgQ1NTIGNsYXNzLiBUaGlzIGlzIGJlY2F1c2UgdGhlIGAubmctaGlkZWAgc2VsZWN0b3IKICogY2FuIGJlIGVhc2lseSBvdmVycmlkZGVuIGJ5IGhlYXZpZXIgc2VsZWN0b3JzLiBGb3IgZXhhbXBsZSwgc29tZXRoaW5nIGFzIHNpbXBsZQogKiBhcyBjaGFuZ2luZyB0aGUgZGlzcGxheSBzdHlsZSBvbiBhIEhUTUwgbGlzdCBpdGVtIHdvdWxkIG1ha2UgaGlkZGVuIGVsZW1lbnRzIGFwcGVhciB2aXNpYmxlLgogKiBUaGlzIGFsc28gYmVjb21lcyBhIGJpZ2dlciBpc3N1ZSB3aGVuIGRlYWxpbmcgd2l0aCBDU1MgZnJhbWV3b3Jrcy4KICoKICogQnkgdXNpbmcgIWltcG9ydGFudCwgdGhlIHNob3cgYW5kIGhpZGUgYmVoYXZpb3Igd2lsbCB3b3JrIGFzIGV4cGVjdGVkIGRlc3BpdGUgYW55IGNsYXNoIGJldHdlZW4gQ1NTIHNlbGVjdG9yCiAqIHNwZWNpZmljaXR5ICh3aGVuICFpbXBvcnRhbnQgaXNuJ3QgdXNlZCB3aXRoIGFueSBjb25mbGljdGluZyBzdHlsZXMpLiBJZiBhIGRldmVsb3BlciBjaG9vc2VzIHRvIG92ZXJyaWRlIHRoZQogKiBzdHlsaW5nIHRvIGNoYW5nZSBob3cgdG8gaGlkZSBhbiBlbGVtZW50IHRoZW4gaXQgaXMganVzdCBhIG1hdHRlciBvZiB1c2luZyAhaW1wb3J0YW50IGluIHRoZWlyIG93biBDU1MgY29kZS4KICoKICogIyMjIE92ZXJyaWRpbmcgYC5uZy1oaWRlYAogKgogKiBCeSBkZWZhdWx0LCB0aGUgYC5uZy1oaWRlYCBjbGFzcyB3aWxsIHN0eWxlIHRoZSBlbGVtZW50IHdpdGggYGRpc3BsYXk6bm9uZSFpbXBvcnRhbnRgLiBJZiB5b3Ugd2lzaCB0byBjaGFuZ2UKICogdGhlIGhpZGUgYmVoYXZpb3Igd2l0aCBuZ1Nob3cvbmdIaWRlIHRoZW4gdGhpcyBjYW4gYmUgYWNoaWV2ZWQgYnkgcmVzdGF0aW5nIHRoZSBzdHlsZXMgZm9yIHRoZSBgLm5nLWhpZGVgCiAqIGNsYXNzIGluIENTUzoKICoKICogYGBgY3NzCiAqIC5uZy1oaWRlIHsKICogICAvJiM0MjsgdGhpcyBpcyBqdXN0IGFub3RoZXIgZm9ybSBvZiBoaWRpbmcgYW4gZWxlbWVudCAmIzQyOy8KICogICBkaXNwbGF5OmJsb2NrIWltcG9ydGFudDsKICogICBwb3NpdGlvbjphYnNvbHV0ZTsKICogICB0b3A6LTk5OTlweDsKICogICBsZWZ0Oi05OTk5cHg7CiAqIH0KICogYGBgCiAqCiAqIEJ5IGRlZmF1bHQgeW91IGRvbid0IG5lZWQgdG8gb3ZlcnJpZGUgaW4gQ1NTIGFueXRoaW5nIGFuZCB0aGUgYW5pbWF0aW9ucyB3aWxsIHdvcmsgYXJvdW5kIHRoZSBkaXNwbGF5IHN0eWxlLgogKgogKiAjIyBBIG5vdGUgYWJvdXQgYW5pbWF0aW9ucyB3aXRoIGBuZ0hpZGVgCiAqCiAqIEFuaW1hdGlvbnMgaW4gbmdTaG93L25nSGlkZSB3b3JrIHdpdGggdGhlIHNob3cgYW5kIGhpZGUgZXZlbnRzIHRoYXQgYXJlIHRyaWdnZXJlZCB3aGVuIHRoZSBkaXJlY3RpdmUgZXhwcmVzc2lvbgogKiBpcyB0cnVlIGFuZCBmYWxzZS4gVGhpcyBzeXN0ZW0gd29ya3MgbGlrZSB0aGUgYW5pbWF0aW9uIHN5c3RlbSBwcmVzZW50IHdpdGggbmdDbGFzcywgZXhjZXB0IHRoYXQgdGhlIGAubmctaGlkZWAKICogQ1NTIGNsYXNzIGlzIGFkZGVkIGFuZCByZW1vdmVkIGZvciB5b3UgaW5zdGVhZCBvZiB5b3VyIG93biBDU1MgY2xhc3MuCiAqCiAqIGBgYGNzcwogKiAvLwogKiAvL2Egd29ya2luZyBleGFtcGxlIGNhbiBiZSBmb3VuZCBhdCB0aGUgYm90dG9tIG9mIHRoaXMgcGFnZQogKiAvLwogKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCwgLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgewogKiAgIHRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogKiB9CiAqCiAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkIHsgLi4uIH0KICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQubmctaGlkZS1hZGQtYWN0aXZlIHsgLi4uIH0KICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgeyAuLi4gfQogKiAubXktZWxlbWVudC5uZy1oaWRlLXJlbW92ZS5uZy1oaWRlLXJlbW92ZS1hY3RpdmUgeyAuLi4gfQogKiBgYGAKICoKICogS2VlcCBpbiBtaW5kIHRoYXQsIGFzIG9mIEFuZ3VsYXJKUyB2ZXJzaW9uIDEuMy4wLWJldGEuMTEsIHRoZXJlIGlzIG5vIG5lZWQgdG8gY2hhbmdlIHRoZSBkaXNwbGF5CiAqIHByb3BlcnR5IHRvIGJsb2NrIGR1cmluZyBhbmltYXRpb24gc3RhdGVzLS1uZ0FuaW1hdGUgd2lsbCBoYW5kbGUgdGhlIHN0eWxlIHRvZ2dsaW5nIGF1dG9tYXRpY2FsbHkgZm9yIHlvdS4KICoKICogQGFuaW1hdGlvbnMKICogcmVtb3ZlQ2xhc3M6IGAubmctaGlkZWAgLSBoYXBwZW5zIGFmdGVyIHRoZSBgbmdIaWRlYCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhIHRydXRoeSB2YWx1ZSBhbmQganVzdCBiZWZvcmUgdGhlIGNvbnRlbnRzIGFyZSBzZXQgdG8gaGlkZGVuCiAqIGFkZENsYXNzOiBgLm5nLWhpZGVgIC0gaGFwcGVucyBhZnRlciB0aGUgYG5nSGlkZWAgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSBub24gdHJ1dGh5IHZhbHVlIGFuZCBqdXN0IGJlZm9yZSB0aGUgY29udGVudHMgYXJlIHNldCB0byB2aXNpYmxlCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nSGlkZSBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5IHRoZW4KICogICAgIHRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiByZXNwZWN0aXZlbHkuCiAqCiAqIEBleGFtcGxlCiAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgQ2xpY2sgbWU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgIDxkaXY+CiAgICAgICAgU2hvdzoKICAgICAgICA8ZGl2IGNsYXNzPSJjaGVjay1lbGVtZW50IGFuaW1hdGUtaGlkZSIgbmctc2hvdz0iY2hlY2tlZCI+CiAgICAgICAgICA8c3BhbiBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi10aHVtYnMtdXAiPjwvc3Bhbj4gSSBzaG93IHVwIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGRpdj4KICAgICAgICBIaWRlOgogICAgICAgIDxkaXYgY2xhc3M9ImNoZWNrLWVsZW1lbnQgYW5pbWF0ZS1oaWRlIiBuZy1oaWRlPSJjaGVja2VkIj4KICAgICAgICAgIDxzcGFuIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLXRodW1icy1kb3duIj48L3NwYW4+IEkgaGlkZSB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJnbHlwaGljb25zLmNzcyI+CiAgICAgIEBpbXBvcnQgdXJsKC8vbmV0ZG5hLmJvb3RzdHJhcGNkbi5jb20vYm9vdHN0cmFwLzMuMC4wL2Nzcy9ib290c3RyYXAtZ2x5cGhpY29ucy5jc3MpOwogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAgICAuYW5pbWF0ZS1oaWRlIHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgIGxpbmUtaGVpZ2h0OjIwcHg7CiAgICAgICAgb3BhY2l0eToxOwogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgIH0KCiAgICAgIC5hbmltYXRlLWhpZGUubmctaGlkZSB7CiAgICAgICAgbGluZS1oZWlnaHQ6MDsKICAgICAgICBvcGFjaXR5OjA7CiAgICAgICAgcGFkZGluZzowIDEwcHg7CiAgICAgIH0KCiAgICAgIC5jaGVjay1lbGVtZW50IHsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgYm9yZGVyOjFweCBzb2xpZCBibGFjazsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICB9CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgdmFyIHRodW1ic1VwID0gZWxlbWVudChieS5jc3MoJ3NwYW4uZ2x5cGhpY29uLXRodW1icy11cCcpKTsKICAgICAgdmFyIHRodW1ic0Rvd24gPSBlbGVtZW50KGJ5LmNzcygnc3Bhbi5nbHlwaGljb24tdGh1bWJzLWRvd24nKSk7CgogICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXNob3cgLyBuZy1oaWRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KHRodW1ic1VwLmlzRGlzcGxheWVkKCkpLnRvQmVGYWxzeSgpOwogICAgICAgIGV4cGVjdCh0aHVtYnNEb3duLmlzRGlzcGxheWVkKCkpLnRvQmVUcnV0aHkoKTsKCiAgICAgICAgZWxlbWVudChieS5tb2RlbCgnY2hlY2tlZCcpKS5jbGljaygpOwoKICAgICAgICBleHBlY3QodGh1bWJzVXAuaXNEaXNwbGF5ZWQoKSkudG9CZVRydXRoeSgpOwogICAgICAgIGV4cGVjdCh0aHVtYnNEb3duLmlzRGlzcGxheWVkKCkpLnRvQmVGYWxzeSgpOwogICAgICB9KTsKICAgIDwvZmlsZT4KICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdIaWRlRGlyZWN0aXZlID0gWyckYW5pbWF0ZScsIGZ1bmN0aW9uKCRhbmltYXRlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnQScsCiAgICBtdWx0aUVsZW1lbnQ6IHRydWUsCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ0hpZGUsIGZ1bmN0aW9uIG5nSGlkZVdhdGNoQWN0aW9uKHZhbHVlKXsKICAgICAgICAvLyBUaGUgY29tbWVudCBpbnNpZGUgb2YgdGhlIG5nU2hvd0RpcmVjdGl2ZSBleHBsYWlucyB3aHkgd2UgYWRkIGFuZAogICAgICAgIC8vIHJlbW92ZSBhIHRlbXBvcmFyeSBjbGFzcyBmb3IgdGhlIHNob3cvaGlkZSBhbmltYXRpb24KICAgICAgICAkYW5pbWF0ZVt2YWx1ZSA/ICdhZGRDbGFzcycgOiAncmVtb3ZlQ2xhc3MnXShlbGVtZW50LE5HX0hJREVfQ0xBU1MsIHsKICAgICAgICAgIHRlbXBDbGFzc2VzIDogTkdfSElERV9JTl9QUk9HUkVTU19DTEFTUwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9Owp9XTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nU3R5bGUKICogQHJlc3RyaWN0IEFDCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nU3R5bGVgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNldCBDU1Mgc3R5bGUgb24gYW4gSFRNTCBlbGVtZW50IGNvbmRpdGlvbmFsbHkuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU3R5bGUKICoKICoge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gd2hpY2ggZXZhbHMgdG8gYW4KICogb2JqZWN0IHdob3NlIGtleXMgYXJlIENTUyBzdHlsZSBuYW1lcyBhbmQgdmFsdWVzIGFyZSBjb3JyZXNwb25kaW5nIHZhbHVlcyBmb3IgdGhvc2UgQ1NTCiAqIGtleXMuCiAqCiAqIFNpbmNlIHNvbWUgQ1NTIHN0eWxlIG5hbWVzIGFyZSBub3QgdmFsaWQga2V5cyBmb3IgYW4gb2JqZWN0LCB0aGV5IG11c3QgYmUgcXVvdGVkLgogKiBTZWUgdGhlICdiYWNrZ3JvdW5kLWNvbG9yJyBzdHlsZSBpbiB0aGUgZXhhbXBsZSBiZWxvdy4KICoKICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCBjb2xvciIgbmctY2xpY2s9Im15U3R5bGU9e2NvbG9yOidyZWQnfSI+CiAgICAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCBiYWNrZ3JvdW5kIiBuZy1jbGljaz0ibXlTdHlsZT17J2JhY2tncm91bmQtY29sb3InOidibHVlJ30iPgogICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJjbGVhciIgbmctY2xpY2s9Im15U3R5bGU9e30iPgogICAgICAgIDxici8+CiAgICAgICAgPHNwYW4gbmctc3R5bGU9Im15U3R5bGUiPlNhbXBsZSBUZXh0PC9zcGFuPgogICAgICAgIDxwcmU+bXlTdHlsZT17e215U3R5bGV9fTwvcHJlPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgc3BhbiB7CiAgICAgICAgIGNvbG9yOiBibGFjazsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICB2YXIgY29sb3JTcGFuID0gZWxlbWVudChieS5jc3MoJ3NwYW4nKSk7CgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zdHlsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoY29sb3JTcGFuLmdldENzc1ZhbHVlKCdjb2xvcicpKS50b0JlKCdyZ2JhKDAsIDAsIDAsIDEpJyk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCdpbnB1dFt2YWx1ZT1cJ3NldCBjb2xvclwnXScpKS5jbGljaygpOwogICAgICAgICBleHBlY3QoY29sb3JTcGFuLmdldENzc1ZhbHVlKCdjb2xvcicpKS50b0JlKCdyZ2JhKDI1NSwgMCwgMCwgMSknKTsKICAgICAgICAgZWxlbWVudChieS5jc3MoJ2lucHV0W3ZhbHVlPWNsZWFyXScpKS5jbGljaygpOwogICAgICAgICBleHBlY3QoY29sb3JTcGFuLmdldENzc1ZhbHVlKCdjb2xvcicpKS50b0JlKCdyZ2JhKDAsIDAsIDAsIDEpJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICovCnZhciBuZ1N0eWxlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICBzY29wZS4kd2F0Y2goYXR0ci5uZ1N0eWxlLCBmdW5jdGlvbiBuZ1N0eWxlV2F0Y2hBY3Rpb24obmV3U3R5bGVzLCBvbGRTdHlsZXMpIHsKICAgIGlmIChvbGRTdHlsZXMgJiYgKG5ld1N0eWxlcyAhPT0gb2xkU3R5bGVzKSkgewogICAgICBmb3JFYWNoKG9sZFN0eWxlcywgZnVuY3Rpb24odmFsLCBzdHlsZSkgeyBlbGVtZW50LmNzcyhzdHlsZSwgJycpO30pOwogICAgfQogICAgaWYgKG5ld1N0eWxlcykgZWxlbWVudC5jc3MobmV3U3R5bGVzKTsKICB9LCB0cnVlKTsKfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBuZ1N3aXRjaAogKiBAcmVzdHJpY3QgRUEKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmdTd2l0Y2hgIGRpcmVjdGl2ZSBpcyB1c2VkIHRvIGNvbmRpdGlvbmFsbHkgc3dhcCBET00gc3RydWN0dXJlIG9uIHlvdXIgdGVtcGxhdGUgYmFzZWQgb24gYSBzY29wZSBleHByZXNzaW9uLgogKiBFbGVtZW50cyB3aXRoaW4gYG5nU3dpdGNoYCBidXQgd2l0aG91dCBgbmdTd2l0Y2hXaGVuYCBvciBgbmdTd2l0Y2hEZWZhdWx0YCBkaXJlY3RpdmVzIHdpbGwgYmUgcHJlc2VydmVkIGF0IHRoZSBsb2NhdGlvbgogKiBhcyBzcGVjaWZpZWQgaW4gdGhlIHRlbXBsYXRlLgogKgogKiBUaGUgZGlyZWN0aXZlIGl0c2VsZiB3b3JrcyBzaW1pbGFyIHRvIG5nSW5jbHVkZSwgaG93ZXZlciwgaW5zdGVhZCBvZiBkb3dubG9hZGluZyB0ZW1wbGF0ZSBjb2RlIChvciBsb2FkaW5nIGl0CiAqIGZyb20gdGhlIHRlbXBsYXRlIGNhY2hlKSwgYG5nU3dpdGNoYCBzaW1wbHkgY2hvb3NlcyBvbmUgb2YgdGhlIG5lc3RlZCBlbGVtZW50cyBhbmQgbWFrZXMgaXQgdmlzaWJsZSBiYXNlZCBvbiB3aGljaCBlbGVtZW50CiAqIG1hdGNoZXMgdGhlIHZhbHVlIG9idGFpbmVkIGZyb20gdGhlIGV2YWx1YXRlZCBleHByZXNzaW9uLiBJbiBvdGhlciB3b3JkcywgeW91IGRlZmluZSBhIGNvbnRhaW5lciBlbGVtZW50CiAqICh3aGVyZSB5b3UgcGxhY2UgdGhlIGRpcmVjdGl2ZSksIHBsYWNlIGFuIGV4cHJlc3Npb24gb24gdGhlICoqYG9uPSIuLi4iYCBhdHRyaWJ1dGUqKgogKiAob3IgdGhlICoqYG5nLXN3aXRjaD0iLi4uImAgYXR0cmlidXRlKiopLCBkZWZpbmUgYW55IGlubmVyIGVsZW1lbnRzIGluc2lkZSBvZiB0aGUgZGlyZWN0aXZlIGFuZCBwbGFjZQogKiBhIHdoZW4gYXR0cmlidXRlIHBlciBlbGVtZW50LiBUaGUgd2hlbiBhdHRyaWJ1dGUgaXMgdXNlZCB0byBpbmZvcm0gbmdTd2l0Y2ggd2hpY2ggZWxlbWVudCB0byBkaXNwbGF5IHdoZW4gdGhlIG9uCiAqIGV4cHJlc3Npb24gaXMgZXZhbHVhdGVkLiBJZiBhIG1hdGNoaW5nIGV4cHJlc3Npb24gaXMgbm90IGZvdW5kIHZpYSBhIHdoZW4gYXR0cmlidXRlIHRoZW4gYW4gZWxlbWVudCB3aXRoIHRoZSBkZWZhdWx0CiAqIGF0dHJpYnV0ZSBpcyBkaXNwbGF5ZWQuCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LWluZm8iPgogKiBCZSBhd2FyZSB0aGF0IHRoZSBhdHRyaWJ1dGUgdmFsdWVzIHRvIG1hdGNoIGFnYWluc3QgY2Fubm90IGJlIGV4cHJlc3Npb25zLiBUaGV5IGFyZSBpbnRlcnByZXRlZAogKiBhcyBsaXRlcmFsIHN0cmluZyB2YWx1ZXMgdG8gbWF0Y2ggYWdhaW5zdC4KICogRm9yIGV4YW1wbGUsICoqYG5nLXN3aXRjaC13aGVuPSJzb21lVmFsImAqKiB3aWxsIG1hdGNoIGFnYWluc3QgdGhlIHN0cmluZyBgInNvbWVWYWwiYCBub3QgYWdhaW5zdCB0aGUKICogdmFsdWUgb2YgdGhlIGV4cHJlc3Npb24gYCRzY29wZS5zb21lVmFsYC4KICogPC9kaXY+CgogKiBAYW5pbWF0aW9ucwogKiBlbnRlciAtIGhhcHBlbnMgYWZ0ZXIgdGhlIG5nU3dpdGNoIGNvbnRlbnRzIGNoYW5nZSBhbmQgdGhlIG1hdGNoZWQgY2hpbGQgZWxlbWVudCBpcyBwbGFjZWQgaW5zaWRlIHRoZSBjb250YWluZXIKICogbGVhdmUgLSBoYXBwZW5zIGp1c3QgYWZ0ZXIgdGhlIG5nU3dpdGNoIGNvbnRlbnRzIGNoYW5nZSBhbmQganVzdCBiZWZvcmUgdGhlIGZvcm1lciBjb250ZW50cyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBET00KICoKICogQHVzYWdlCiAqCiAqIGBgYAogKiA8QU5ZIG5nLXN3aXRjaD0iZXhwcmVzc2lvbiI+CiAqICAgPEFOWSBuZy1zd2l0Y2gtd2hlbj0ibWF0Y2hWYWx1ZTEiPi4uLjwvQU5ZPgogKiAgIDxBTlkgbmctc3dpdGNoLXdoZW49Im1hdGNoVmFsdWUyIj4uLi48L0FOWT4KICogICA8QU5ZIG5nLXN3aXRjaC1kZWZhdWx0Pi4uLjwvQU5ZPgogKiA8L0FOWT4KICogYGBgCiAqCiAqCiAqIEBzY29wZQogKiBAcHJpb3JpdHkgMTIwMAogKiBAcGFyYW0geyp9IG5nU3dpdGNofG9uIGV4cHJlc3Npb24gdG8gbWF0Y2ggYWdhaW5zdCA8dHQ+bmctc3dpdGNoLXdoZW48L3R0Pi4KICogT24gY2hpbGQgZWxlbWVudHMgYWRkOgogKgogKiAqIGBuZ1N3aXRjaFdoZW5gOiB0aGUgY2FzZSBzdGF0ZW1lbnQgdG8gbWF0Y2ggYWdhaW5zdC4gSWYgbWF0Y2ggdGhlbiB0aGlzCiAqICAgY2FzZSB3aWxsIGJlIGRpc3BsYXllZC4gSWYgdGhlIHNhbWUgbWF0Y2ggYXBwZWFycyBtdWx0aXBsZSB0aW1lcywgYWxsIHRoZQogKiAgIGVsZW1lbnRzIHdpbGwgYmUgZGlzcGxheWVkLgogKiAqIGBuZ1N3aXRjaERlZmF1bHRgOiB0aGUgZGVmYXVsdCBjYXNlIHdoZW4gbm8gb3RoZXIgY2FzZSBtYXRjaC4gSWYgdGhlcmUKICogICBhcmUgbXVsdGlwbGUgZGVmYXVsdCBjYXNlcywgYWxsIG9mIHRoZW0gd2lsbCBiZSBkaXNwbGF5ZWQgd2hlbiBubyBvdGhlcgogKiAgIGNhc2UgbWF0Y2guCiAqCiAqCiAqIEBleGFtcGxlCiAgPGV4YW1wbGUgbW9kdWxlPSJzd2l0Y2hFeGFtcGxlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgIDxzZWxlY3QgbmctbW9kZWw9InNlbGVjdGlvbiIgbmctb3B0aW9ucz0iaXRlbSBmb3IgaXRlbSBpbiBpdGVtcyI+CiAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgPHR0PnNlbGVjdGlvbj17e3NlbGVjdGlvbn19PC90dD4KICAgICAgICA8aHIvPgogICAgICAgIDxkaXYgY2xhc3M9ImFuaW1hdGUtc3dpdGNoLWNvbnRhaW5lciIKICAgICAgICAgIG5nLXN3aXRjaCBvbj0ic2VsZWN0aW9uIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iYW5pbWF0ZS1zd2l0Y2giIG5nLXN3aXRjaC13aGVuPSJzZXR0aW5ncyI+U2V0dGluZ3MgRGl2PC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFuaW1hdGUtc3dpdGNoIiBuZy1zd2l0Y2gtd2hlbj0iaG9tZSI+SG9tZSBTcGFuPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFuaW1hdGUtc3dpdGNoIiBuZy1zd2l0Y2gtZGVmYXVsdD5kZWZhdWx0PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgYW5ndWxhci5tb2R1bGUoJ3N3aXRjaEV4YW1wbGUnLCBbJ25nQW5pbWF0ZSddKQogICAgICAgIC5jb250cm9sbGVyKCdFeGFtcGxlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAkc2NvcGUuaXRlbXMgPSBbJ3NldHRpbmdzJywgJ2hvbWUnLCAnb3RoZXInXTsKICAgICAgICAgICRzY29wZS5zZWxlY3Rpb24gPSAkc2NvcGUuaXRlbXNbMF07CiAgICAgICAgfV0pOwogICAgPC9maWxlPgogICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAgICAuYW5pbWF0ZS1zd2l0Y2gtY29udGFpbmVyIHsKICAgICAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgaGVpZ2h0OjQwcHg7CiAgICAgICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgICB9CgogICAgICAuYW5pbWF0ZS1zd2l0Y2ggewogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgfQoKICAgICAgLmFuaW1hdGUtc3dpdGNoLm5nLWFuaW1hdGUgewogICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKCiAgICAgICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICAgICAgdG9wOjA7CiAgICAgICAgbGVmdDowOwogICAgICAgIHJpZ2h0OjA7CiAgICAgICAgYm90dG9tOjA7CiAgICAgIH0KCiAgICAgIC5hbmltYXRlLXN3aXRjaC5uZy1sZWF2ZS5uZy1sZWF2ZS1hY3RpdmUsCiAgICAgIC5hbmltYXRlLXN3aXRjaC5uZy1lbnRlciB7CiAgICAgICAgdG9wOi01MHB4OwogICAgICB9CiAgICAgIC5hbmltYXRlLXN3aXRjaC5uZy1sZWF2ZSwKICAgICAgLmFuaW1hdGUtc3dpdGNoLm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7CiAgICAgICAgdG9wOjA7CiAgICAgIH0KICAgIDwvZmlsZT4KICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICB2YXIgc3dpdGNoRWxlbSA9IGVsZW1lbnQoYnkuY3NzKCdbbmctc3dpdGNoXScpKTsKICAgICAgdmFyIHNlbGVjdCA9IGVsZW1lbnQoYnkubW9kZWwoJ3NlbGVjdGlvbicpKTsKCiAgICAgIGl0KCdzaG91bGQgc3RhcnQgaW4gc2V0dGluZ3MnLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3Qoc3dpdGNoRWxlbS5nZXRUZXh0KCkpLnRvTWF0Y2goL1NldHRpbmdzIERpdi8pOwogICAgICB9KTsKICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2UgdG8gaG9tZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGVjdC5hbGwoYnkuY3NzKCdvcHRpb24nKSkuZ2V0KDEpLmNsaWNrKCk7CiAgICAgICAgZXhwZWN0KHN3aXRjaEVsZW0uZ2V0VGV4dCgpKS50b01hdGNoKC9Ib21lIFNwYW4vKTsKICAgICAgfSk7CiAgICAgIGl0KCdzaG91bGQgc2VsZWN0IGRlZmF1bHQnLCBmdW5jdGlvbigpIHsKICAgICAgICBzZWxlY3QuYWxsKGJ5LmNzcygnb3B0aW9uJykpLmdldCgyKS5jbGljaygpOwogICAgICAgIGV4cGVjdChzd2l0Y2hFbGVtLmdldFRleHQoKSkudG9NYXRjaCgvZGVmYXVsdC8pOwogICAgICB9KTsKICAgIDwvZmlsZT4KICA8L2V4YW1wbGU+CiAqLwp2YXIgbmdTd2l0Y2hEaXJlY3RpdmUgPSBbJyRhbmltYXRlJywgZnVuY3Rpb24oJGFuaW1hdGUpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFQScsCiAgICByZXF1aXJlOiAnbmdTd2l0Y2gnLAoKICAgIC8vIGFza3MgZm9yICRzY29wZSB0byBmb29sIHRoZSBCQyBjb250cm9sbGVyIG1vZHVsZQogICAgY29udHJvbGxlcjogWyckc2NvcGUnLCBmdW5jdGlvbiBuZ1N3aXRjaENvbnRyb2xsZXIoKSB7CiAgICAgdGhpcy5jYXNlcyA9IHt9OwogICAgfV0sCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgbmdTd2l0Y2hDb250cm9sbGVyKSB7CiAgICAgIHZhciB3YXRjaEV4cHIgPSBhdHRyLm5nU3dpdGNoIHx8IGF0dHIub24sCiAgICAgICAgICBzZWxlY3RlZFRyYW5zY2x1ZGVzID0gW10sCiAgICAgICAgICBzZWxlY3RlZEVsZW1lbnRzID0gW10sCiAgICAgICAgICBwcmV2aW91c0xlYXZlQW5pbWF0aW9ucyA9IFtdLAogICAgICAgICAgc2VsZWN0ZWRTY29wZXMgPSBbXTsKCiAgICAgIHZhciBzcGxpY2VGYWN0b3J5ID0gZnVuY3Rpb24oYXJyYXksIGluZGV4KSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7IGFycmF5LnNwbGljZShpbmRleCwgMSk7IH07CiAgICAgIH07CgogICAgICBzY29wZS4kd2F0Y2god2F0Y2hFeHByLCBmdW5jdGlvbiBuZ1N3aXRjaFdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIGksIGlpOwogICAgICAgIGZvciAoaSA9IDAsIGlpID0gcHJldmlvdXNMZWF2ZUFuaW1hdGlvbnMubGVuZ3RoOyBpIDwgaWk7ICsraSkgewogICAgICAgICAgJGFuaW1hdGUuY2FuY2VsKHByZXZpb3VzTGVhdmVBbmltYXRpb25zW2ldKTsKICAgICAgICB9CiAgICAgICAgcHJldmlvdXNMZWF2ZUFuaW1hdGlvbnMubGVuZ3RoID0gMDsKCiAgICAgICAgZm9yIChpID0gMCwgaWkgPSBzZWxlY3RlZFNjb3Blcy5sZW5ndGg7IGkgPCBpaTsgKytpKSB7CiAgICAgICAgICB2YXIgc2VsZWN0ZWQgPSBnZXRCbG9ja05vZGVzKHNlbGVjdGVkRWxlbWVudHNbaV0uY2xvbmUpOwogICAgICAgICAgc2VsZWN0ZWRTY29wZXNbaV0uJGRlc3Ryb3koKTsKICAgICAgICAgIHZhciBwcm9taXNlID0gcHJldmlvdXNMZWF2ZUFuaW1hdGlvbnNbaV0gPSAkYW5pbWF0ZS5sZWF2ZShzZWxlY3RlZCk7CiAgICAgICAgICBwcm9taXNlLnRoZW4oc3BsaWNlRmFjdG9yeShwcmV2aW91c0xlYXZlQW5pbWF0aW9ucywgaSkpOwogICAgICAgIH0KCiAgICAgICAgc2VsZWN0ZWRFbGVtZW50cy5sZW5ndGggPSAwOwogICAgICAgIHNlbGVjdGVkU2NvcGVzLmxlbmd0aCA9IDA7CgogICAgICAgIGlmICgoc2VsZWN0ZWRUcmFuc2NsdWRlcyA9IG5nU3dpdGNoQ29udHJvbGxlci5jYXNlc1snIScgKyB2YWx1ZV0gfHwgbmdTd2l0Y2hDb250cm9sbGVyLmNhc2VzWyc/J10pKSB7CiAgICAgICAgICBmb3JFYWNoKHNlbGVjdGVkVHJhbnNjbHVkZXMsIGZ1bmN0aW9uKHNlbGVjdGVkVHJhbnNjbHVkZSkgewogICAgICAgICAgICBzZWxlY3RlZFRyYW5zY2x1ZGUudHJhbnNjbHVkZShmdW5jdGlvbihjYXNlRWxlbWVudCwgc2VsZWN0ZWRTY29wZSkgewogICAgICAgICAgICAgIHNlbGVjdGVkU2NvcGVzLnB1c2goc2VsZWN0ZWRTY29wZSk7CiAgICAgICAgICAgICAgdmFyIGFuY2hvciA9IHNlbGVjdGVkVHJhbnNjbHVkZS5lbGVtZW50OwogICAgICAgICAgICAgIGNhc2VFbGVtZW50W2Nhc2VFbGVtZW50Lmxlbmd0aCsrXSA9IGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJyBlbmQgbmdTd2l0Y2hXaGVuOiAnKTsKICAgICAgICAgICAgICB2YXIgYmxvY2sgPSB7IGNsb25lOiBjYXNlRWxlbWVudCB9OwoKICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnRzLnB1c2goYmxvY2spOwogICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGNhc2VFbGVtZW50LCBhbmNob3IucGFyZW50KCksIGFuY2hvcik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9Owp9XTsKCnZhciBuZ1N3aXRjaFdoZW5EaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogIHByaW9yaXR5OiAxMjAwLAogIHJlcXVpcmU6ICdebmdTd2l0Y2gnLAogIG11bHRpRWxlbWVudDogdHJ1ZSwKICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIGN0cmwsICR0cmFuc2NsdWRlKSB7CiAgICBjdHJsLmNhc2VzWychJyArIGF0dHJzLm5nU3dpdGNoV2hlbl0gPSAoY3RybC5jYXNlc1snIScgKyBhdHRycy5uZ1N3aXRjaFdoZW5dIHx8IFtdKTsKICAgIGN0cmwuY2FzZXNbJyEnICsgYXR0cnMubmdTd2l0Y2hXaGVuXS5wdXNoKHsgdHJhbnNjbHVkZTogJHRyYW5zY2x1ZGUsIGVsZW1lbnQ6IGVsZW1lbnQgfSk7CiAgfQp9KTsKCnZhciBuZ1N3aXRjaERlZmF1bHREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogIHByaW9yaXR5OiAxMjAwLAogIHJlcXVpcmU6ICdebmdTd2l0Y2gnLAogIG11bHRpRWxlbWVudDogdHJ1ZSwKICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHRyYW5zY2x1ZGUpIHsKICAgIGN0cmwuY2FzZXNbJz8nXSA9IChjdHJsLmNhc2VzWyc/J10gfHwgW10pOwogICAgY3RybC5jYXNlc1snPyddLnB1c2goeyB0cmFuc2NsdWRlOiAkdHJhbnNjbHVkZSwgZWxlbWVudDogZWxlbWVudCB9KTsKICAgfQp9KTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIG5nVHJhbnNjbHVkZQogKiBAcmVzdHJpY3QgRUFDCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEaXJlY3RpdmUgdGhhdCBtYXJrcyB0aGUgaW5zZXJ0aW9uIHBvaW50IGZvciB0aGUgdHJhbnNjbHVkZWQgRE9NIG9mIHRoZSBuZWFyZXN0IHBhcmVudCBkaXJlY3RpdmUgdGhhdCB1c2VzIHRyYW5zY2x1c2lvbi4KICoKICogQW55IGV4aXN0aW5nIGNvbnRlbnQgb2YgdGhlIGVsZW1lbnQgdGhhdCB0aGlzIGRpcmVjdGl2ZSBpcyBwbGFjZWQgb24gd2lsbCBiZSByZW1vdmVkIGJlZm9yZSB0aGUgdHJhbnNjbHVkZWQgY29udGVudCBpcyBpbnNlcnRlZC4KICoKICogQGVsZW1lbnQgQU5ZCiAqCiAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0idHJhbnNjbHVkZUV4YW1wbGUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ3RyYW5zY2x1ZGVFeGFtcGxlJywgW10pCiAgICAgICAgICAuZGlyZWN0aXZlKCdwYW5lJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgICAgICAgIHNjb3BlOiB7IHRpdGxlOidAJyB9LAogICAgICAgICAgICAgICB0ZW1wbGF0ZTogJzxkaXYgc3R5bGU9ImJvcmRlcjogMXB4IHNvbGlkIGJsYWNrOyI+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiBncmF5Ij57e3RpdGxlfX08L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxuZy10cmFuc2NsdWRlPjwvbmctdHJhbnNjbHVkZT4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nCiAgICAgICAgICAgICB9OwogICAgICAgICB9KQogICAgICAgICAuY29udHJvbGxlcignRXhhbXBsZUNvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS50aXRsZSA9ICdMb3JlbSBJcHN1bSc7CiAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnTmVxdWUgcG9ycm8gcXVpc3F1YW0gZXN0IHF1aSBkb2xvcmVtIGlwc3VtIHF1aWEgZG9sb3IuLi4nOwogICAgICAgICB9XSk7CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRXhhbXBsZUNvbnRyb2xsZXIiPgogICAgICAgICA8aW5wdXQgbmctbW9kZWw9InRpdGxlIj48YnI+CiAgICAgICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0idGV4dCI+PC90ZXh0YXJlYT4gPGJyLz4KICAgICAgICAgPHBhbmUgdGl0bGU9Int7dGl0bGV9fSI+e3t0ZXh0fX08L3BhbmU+CiAgICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgaXQoJ3Nob3VsZCBoYXZlIHRyYW5zY2x1ZGVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdGl0bGVFbGVtZW50ID0gZWxlbWVudChieS5tb2RlbCgndGl0bGUnKSk7CiAgICAgICAgICB0aXRsZUVsZW1lbnQuY2xlYXIoKTsKICAgICAgICAgIHRpdGxlRWxlbWVudC5zZW5kS2V5cygnVElUTEUnKTsKICAgICAgICAgIHZhciB0ZXh0RWxlbWVudCA9IGVsZW1lbnQoYnkubW9kZWwoJ3RleHQnKSk7CiAgICAgICAgICB0ZXh0RWxlbWVudC5jbGVhcigpOwogICAgICAgICAgdGV4dEVsZW1lbnQuc2VuZEtleXMoJ1RFWFQnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3RpdGxlJykpLmdldFRleHQoKSkudG9FcXVhbCgnVElUTEUnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3RleHQnKSkuZ2V0VGV4dCgpKS50b0VxdWFsKCdURVhUJyk7CiAgICAgICAgfSk7CiAgICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAqCiAqLwp2YXIgbmdUcmFuc2NsdWRlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogIHJlc3RyaWN0OiAnRUFDJywKICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsIGNvbnRyb2xsZXIsICR0cmFuc2NsdWRlKSB7CiAgICBpZiAoISR0cmFuc2NsdWRlKSB7CiAgICAgIHRocm93IG1pbkVycignbmdUcmFuc2NsdWRlJykoJ29ycGhhbicsCiAgICAgICAnSWxsZWdhbCB1c2Ugb2YgbmdUcmFuc2NsdWRlIGRpcmVjdGl2ZSBpbiB0aGUgdGVtcGxhdGUhICcgKwogICAgICAgJ05vIHBhcmVudCBkaXJlY3RpdmUgdGhhdCByZXF1aXJlcyBhIHRyYW5zY2x1c2lvbiBmb3VuZC4gJyArCiAgICAgICAnRWxlbWVudDogezB9JywKICAgICAgIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgICB9CgogICAgJHRyYW5zY2x1ZGUoZnVuY3Rpb24oY2xvbmUpIHsKICAgICAgJGVsZW1lbnQuZW1wdHkoKTsKICAgICAgJGVsZW1lbnQuYXBwZW5kKGNsb25lKTsKICAgIH0pOwogIH0KfSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBzY3JpcHQKICogQHJlc3RyaWN0IEUKICoKICogQGRlc2NyaXB0aW9uCiAqIExvYWQgdGhlIGNvbnRlbnQgb2YgYSBgPHNjcmlwdD5gIGVsZW1lbnQgaW50byB7QGxpbmsgbmcuJHRlbXBsYXRlQ2FjaGUgYCR0ZW1wbGF0ZUNhY2hlYH0sIHNvIHRoYXQgdGhlCiAqIHRlbXBsYXRlIGNhbiBiZSB1c2VkIGJ5IHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlIGBuZ0luY2x1ZGVgfSwKICoge0BsaW5rIG5nUm91dGUuZGlyZWN0aXZlOm5nVmlldyBgbmdWaWV3YH0sIG9yIHtAbGluayBndWlkZS9kaXJlY3RpdmUgZGlyZWN0aXZlc30uIFRoZSB0eXBlIG9mIHRoZQogKiBgPHNjcmlwdD5gIGVsZW1lbnQgbXVzdCBiZSBzcGVjaWZpZWQgYXMgYHRleHQvbmctdGVtcGxhdGVgLCBhbmQgYSBjYWNoZSBuYW1lIGZvciB0aGUgdGVtcGxhdGUgbXVzdCBiZQogKiBhc3NpZ25lZCB0aHJvdWdoIHRoZSBlbGVtZW50J3MgYGlkYCwgd2hpY2ggY2FuIHRoZW4gYmUgdXNlZCBhcyBhIGRpcmVjdGl2ZSdzIGB0ZW1wbGF0ZVVybGAuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIE11c3QgYmUgc2V0IHRvIGAndGV4dC9uZy10ZW1wbGF0ZSdgLgogKiBAcGFyYW0ge3N0cmluZ30gaWQgQ2FjaGUgbmFtZSBvZiB0aGUgdGVtcGxhdGUuCiAqCiAqIEBleGFtcGxlCiAgPGV4YW1wbGU+CiAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0iL3RwbC5odG1sIj4KICAgICAgICBDb250ZW50IG9mIHRoZSB0ZW1wbGF0ZS4KICAgICAgPC9zY3JpcHQ+CgogICAgICA8YSBuZy1jbGljaz0iY3VycmVudFRwbD0nL3RwbC5odG1sJyIgaWQ9InRwbC1saW5rIj5Mb2FkIGlubGluZWQgdGVtcGxhdGU8L2E+CiAgICAgIDxkaXYgaWQ9InRwbC1jb250ZW50IiBuZy1pbmNsdWRlIHNyYz0iY3VycmVudFRwbCI+PC9kaXY+CiAgICA8L2ZpbGU+CiAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgaXQoJ3Nob3VsZCBsb2FkIHRlbXBsYXRlIGRlZmluZWQgaW5zaWRlIHNjcmlwdCB0YWcnLCBmdW5jdGlvbigpIHsKICAgICAgICBlbGVtZW50KGJ5LmNzcygnI3RwbC1saW5rJykpLmNsaWNrKCk7CiAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjdHBsLWNvbnRlbnQnKSkuZ2V0VGV4dCgpKS50b01hdGNoKC9Db250ZW50IG9mIHRoZSB0ZW1wbGF0ZS8pOwogICAgICB9KTsKICAgIDwvZmlsZT4KICA8L2V4YW1wbGU+CiAqLwp2YXIgc2NyaXB0RGlyZWN0aXZlID0gWyckdGVtcGxhdGVDYWNoZScsIGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgaWYgKGF0dHIudHlwZSA9PSAndGV4dC9uZy10ZW1wbGF0ZScpIHsKICAgICAgICB2YXIgdGVtcGxhdGVVcmwgPSBhdHRyLmlkLAogICAgICAgICAgICAvLyBJRSBpcyBub3QgY29uc2lzdGVudCwgaW4gc2NyaXB0cyB3ZSBoYXZlIHRvIHJlYWQgLnRleHQgYnV0IGluIG90aGVyIG5vZGVzIHdlIGhhdmUgdG8gcmVhZCAudGV4dENvbnRlbnQKICAgICAgICAgICAgdGV4dCA9IGVsZW1lbnRbMF0udGV4dDsKCiAgICAgICAgJHRlbXBsYXRlQ2FjaGUucHV0KHRlbXBsYXRlVXJsLCB0ZXh0KTsKICAgICAgfQogICAgfQogIH07Cn1dOwoKdmFyIG5nT3B0aW9uc01pbkVyciA9IG1pbkVycignbmdPcHRpb25zJyk7Ci8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIHNlbGVjdAogKiBAcmVzdHJpY3QgRQogKgogKiBAZGVzY3JpcHRpb24KICogSFRNTCBgU0VMRUNUYCBlbGVtZW50IHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuCiAqCiAqICMgYG5nT3B0aW9uc2AKICoKICogVGhlIGBuZ09wdGlvbnNgIGF0dHJpYnV0ZSBjYW4gYmUgdXNlZCB0byBkeW5hbWljYWxseSBnZW5lcmF0ZSBhIGxpc3Qgb2YgYDxvcHRpb24+YAogKiBlbGVtZW50cyBmb3IgdGhlIGA8c2VsZWN0PmAgZWxlbWVudCB1c2luZyB0aGUgYXJyYXkgb3Igb2JqZWN0IG9idGFpbmVkIGJ5IGV2YWx1YXRpbmcgdGhlCiAqIGBuZ09wdGlvbnNgIGNvbXByZWhlbnNpb25fZXhwcmVzc2lvbi4KICoKICogV2hlbiBhbiBpdGVtIGluIHRoZSBgPHNlbGVjdD5gIG1lbnUgaXMgc2VsZWN0ZWQsIHRoZSBhcnJheSBlbGVtZW50IG9yIG9iamVjdCBwcm9wZXJ0eQogKiByZXByZXNlbnRlZCBieSB0aGUgc2VsZWN0ZWQgb3B0aW9uIHdpbGwgYmUgYm91bmQgdG8gdGhlIG1vZGVsIGlkZW50aWZpZWQgYnkgdGhlIGBuZ01vZGVsYAogKiBkaXJlY3RpdmUuCiAqCiAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogKiAqKk5vdGU6KiogYG5nTW9kZWxgIGNvbXBhcmVzIGJ5IHJlZmVyZW5jZSwgbm90IHZhbHVlLiBUaGlzIGlzIGltcG9ydGFudCB3aGVuIGJpbmRpbmcgdG8gYW4KICogYXJyYXkgb2Ygb2JqZWN0cy4gU2VlIGFuIGV4YW1wbGUgW2luIHRoaXMganNmaWRkbGVdKGh0dHA6Ly9qc2ZpZGRsZS5uZXQvcVd6VGIvKS4KICogPC9kaXY+CiAqCiAqIE9wdGlvbmFsbHksIGEgc2luZ2xlIGhhcmQtY29kZWQgYDxvcHRpb24+YCBlbGVtZW50LCB3aXRoIHRoZSB2YWx1ZSBzZXQgdG8gYW4gZW1wdHkgc3RyaW5nLCBjYW4KICogYmUgbmVzdGVkIGludG8gdGhlIGA8c2VsZWN0PmAgZWxlbWVudC4gVGhpcyBlbGVtZW50IHdpbGwgdGhlbiByZXByZXNlbnQgdGhlIGBudWxsYCBvciAibm90IHNlbGVjdGVkIgogKiBvcHRpb24uIFNlZSBleGFtcGxlIGJlbG93IGZvciBkZW1vbnN0cmF0aW9uLgogKgogKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICogKipOb3RlOioqIGBuZ09wdGlvbnNgIHByb3ZpZGVzIGFuIGl0ZXJhdG9yIGZhY2lsaXR5IGZvciB0aGUgYDxvcHRpb24+YCBlbGVtZW50IHdoaWNoIHNob3VsZCBiZSB1c2VkIGluc3RlYWQKICogb2Yge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0gd2hlbiB5b3Ugd2FudCB0aGUKICogYHNlbGVjdGAgbW9kZWwgdG8gYmUgYm91bmQgdG8gYSBub24tc3RyaW5nIHZhbHVlLiBUaGlzIGlzIGJlY2F1c2UgYW4gb3B0aW9uIGVsZW1lbnQgY2FuIG9ubHkKICogYmUgYm91bmQgdG8gc3RyaW5nIHZhbHVlcyBhdCBwcmVzZW50LgogKiA8L2Rpdj4KICoKICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtaW5mbyI+CiAqICoqTm90ZToqKiBVc2luZyBgc2VsZWN0IGFzYCB3aWxsIGJpbmQgdGhlIHJlc3VsdCBvZiB0aGUgYHNlbGVjdCBhc2AgZXhwcmVzc2lvbiB0byB0aGUgbW9kZWwsIGJ1dAogKiB0aGUgdmFsdWUgb2YgdGhlIGA8c2VsZWN0PmAgYW5kIGA8b3B0aW9uPmAgaHRtbCBlbGVtZW50cyB3aWxsIGJlIGVpdGhlciB0aGUgaW5kZXggKGZvciBhcnJheSBkYXRhIHNvdXJjZXMpCiAqIG9yIHByb3BlcnR5IG5hbWUgKGZvciBvYmplY3QgZGF0YSBzb3VyY2VzKSBvZiB0aGUgdmFsdWUgd2l0aGluIHRoZSBjb2xsZWN0aW9uLgogKiA8L2Rpdj4KICoKICogKipOb3RlOioqIFVzaW5nIGBzZWxlY3QgYXNgIHRvZ2V0aGVyIHdpdGggYHRyYWNrZXhwcmAgaXMgbm90IHJlY29tbWVuZGVkLgogKiBSZWFzb25pbmc6CiAqIC0gRXhhbXBsZTogJmx0O3NlbGVjdCBuZy1vcHRpb25zPSJpdGVtLnN1Ykl0ZW0gYXMgaXRlbS5sYWJlbCBmb3IgaXRlbSBpbiB2YWx1ZXMgdHJhY2sgYnkgaXRlbS5pZCIgbmctbW9kZWw9InNlbGVjdGVkIiZndDsKICogICB2YWx1ZXM6IFt7aWQ6IDEsIGxhYmVsOiAnYUxhYmVsJywgc3ViSXRlbToge25hbWU6ICdhU3ViSXRlbSd9fSwge2lkOiAyLCBsYWJlbDogJ2JMYWJlbCcsIHN1Ykl0ZW06IHtuYW1lOiAnYlN1Ykl0ZW0nfX1dLAogKiAgICRzY29wZS5zZWxlY3RlZCA9IHtuYW1lOiAnYVN1Ykl0ZW0nfTsKICogLSB0cmFjayBieSBpcyBhbHdheXMgYXBwbGllZCB0byBgdmFsdWVgLCB3aXRoIHRoZSBwdXJwb3NlIG9mIHByZXNlcnZpbmcgdGhlIHNlbGVjdGlvbiwKICogICAodG8gYGl0ZW1gIGluIHRoaXMgY2FzZSkKICogLSB0byBjYWxjdWxhdGUgd2hldGhlciBhbiBpdGVtIGlzIHNlbGVjdGVkIHdlIGRvIHRoZSBmb2xsb3dpbmc6CiAqICAgMS4gYXBwbHkgYHRyYWNrIGJ5YCB0byB0aGUgdmFsdWVzIGluIHRoZSBhcnJheSwgZS5nLgogKiAgICAgIEluIHRoZSBleGFtcGxlOiBbMSwyXQogKiAgIDIuIGFwcGx5IGB0cmFjayBieWAgdG8gdGhlIGFscmVhZHkgc2VsZWN0ZWQgdmFsdWUgaW4gYG5nTW9kZWxgOgogKiAgICAgIEluIHRoZSBleGFtcGxlOiB0aGlzIGlzIG5vdCBwb3NzaWJsZSwgYXMgYHRyYWNrIGJ5YCByZWZlcnMgdG8gYGl0ZW0uaWRgLCBidXQgdGhlIHNlbGVjdGVkCiAqICAgICAgdmFsdWUgZnJvbSBgbmdNb2RlbGAgaXMgYHtuYW1lOiBhU3ViSXRlbX1gLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBUaGUgY29udHJvbCBpcyBjb25zaWRlcmVkIHZhbGlkIG9ubHkgaWYgdmFsdWUgaXMgZW50ZXJlZC4KICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogKiBAcGFyYW0ge2NvbXByZWhlbnNpb25fZXhwcmVzc2lvbj19IG5nT3B0aW9ucyBpbiBvbmUgb2YgdGhlIGZvbGxvd2luZyBmb3JtczoKICoKICogICAqIGZvciBhcnJheSBkYXRhIHNvdXJjZXM6CiAqICAgICAqIGBsYWJlbGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICogICAgICogYGxhYmVsYCAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgICoqYHRyYWNrIGJ5YCoqIGB0cmFja2V4cHJgCiAqICAgKiBmb3Igb2JqZWN0IGRhdGEgc291cmNlczoKICogICAgICogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICogICAgICogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvciAoYCoqYGtleWAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYAogKiAgICAgICAgICoqYGZvcmAgYChgKipga2V5YCoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICoKICogV2hlcmU6CiAqCiAqICAgKiBgYXJyYXlgIC8gYG9iamVjdGA6IGFuIGV4cHJlc3Npb24gd2hpY2ggZXZhbHVhdGVzIHRvIGFuIGFycmF5IC8gb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICogICAqIGB2YWx1ZWA6IGxvY2FsIHZhcmlhYmxlIHdoaWNoIHdpbGwgcmVmZXIgdG8gZWFjaCBpdGVtIGluIHRoZSBgYXJyYXlgIG9yIGVhY2ggcHJvcGVydHkgdmFsdWUKICogICAgICBvZiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogKiAgICogYGtleWA6IGxvY2FsIHZhcmlhYmxlIHdoaWNoIHdpbGwgcmVmZXIgdG8gYSBwcm9wZXJ0eSBuYW1lIGluIGBvYmplY3RgIGR1cmluZyBpdGVyYXRpb24uCiAqICAgKiBgbGFiZWxgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIHRoZSBsYWJlbCBmb3IgYDxvcHRpb24+YCBlbGVtZW50LiBUaGUKICogICAgIGBleHByZXNzaW9uYCB3aWxsIG1vc3QgbGlrZWx5IHJlZmVyIHRvIHRoZSBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4KICogICAqIGBzZWxlY3RgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIGJvdW5kIHRvIHRoZSBtb2RlbCBvZiB0aGUgcGFyZW50IGA8c2VsZWN0PmAKICogICAgICBlbGVtZW50LiBJZiBub3Qgc3BlY2lmaWVkLCBgc2VsZWN0YCBleHByZXNzaW9uIHdpbGwgZGVmYXVsdCB0byBgdmFsdWVgLgogKiAgICogYGdyb3VwYDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSB1c2VkIHRvIGdyb3VwIG9wdGlvbnMgdXNpbmcgdGhlIGA8b3B0Z3JvdXA+YAogKiAgICAgIERPTSBlbGVtZW50LgogKiAgICogYHRyYWNrZXhwcmA6IFVzZWQgd2hlbiB3b3JraW5nIHdpdGggYW4gYXJyYXkgb2Ygb2JqZWN0cy4gVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZQogKiAgICAgIHVzZWQgdG8gaWRlbnRpZnkgdGhlIG9iamVjdHMgaW4gdGhlIGFycmF5LiBUaGUgYHRyYWNrZXhwcmAgd2lsbCBtb3N0IGxpa2VseSByZWZlciB0byB0aGUKICogICAgIGB2YWx1ZWAgdmFyaWFibGUgKGUuZy4gYHZhbHVlLnByb3BlcnR5TmFtZWApLiBXaXRoIHRoaXMgdGhlIHNlbGVjdGlvbiBpcyBwcmVzZXJ2ZWQKICogICAgICBldmVuIHdoZW4gdGhlIG9wdGlvbnMgYXJlIHJlY3JlYXRlZCAoZS5nLiByZWxvYWRlZCBmcm9tIHRoZSBzZXJ2ZXIpLgogKgogKiBAZXhhbXBsZQogICAgPGV4YW1wbGUgbW9kdWxlPSJzZWxlY3RFeGFtcGxlIj4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPHNjcmlwdD4KICAgICAgICBhbmd1bGFyLm1vZHVsZSgnc2VsZWN0RXhhbXBsZScsIFtdKQogICAgICAgICAgLmNvbnRyb2xsZXIoJ0V4YW1wbGVDb250cm9sbGVyJywgWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLmNvbG9ycyA9IFsKICAgICAgICAgICAgICB7bmFtZTonYmxhY2snLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICAgIHtuYW1lOid3aGl0ZScsIHNoYWRlOidsaWdodCd9LAogICAgICAgICAgICAgIHtuYW1lOidyZWQnLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICAgIHtuYW1lOidibHVlJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAgICB7bmFtZToneWVsbG93Jywgc2hhZGU6J2xpZ2h0J30KICAgICAgICAgICAgXTsKICAgICAgICAgICAgJHNjb3BlLm15Q29sb3IgPSAkc2NvcGUuY29sb3JzWzJdOyAvLyByZWQKICAgICAgICAgIH1dKTsKICAgICAgICA8L3NjcmlwdD4KICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkV4YW1wbGVDb250cm9sbGVyIj4KICAgICAgICAgIDx1bD4KICAgICAgICAgICAgPGxpIG5nLXJlcGVhdD0iY29sb3IgaW4gY29sb3JzIj4KICAgICAgICAgICAgICBOYW1lOiA8aW5wdXQgbmctbW9kZWw9ImNvbG9yLm5hbWUiPgogICAgICAgICAgICAgIFs8YSBocmVmIG5nLWNsaWNrPSJjb2xvcnMuc3BsaWNlKCRpbmRleCwgMSkiPlg8L2E+XQogICAgICAgICAgICA8L2xpPgogICAgICAgICAgICA8bGk+CiAgICAgICAgICAgICAgWzxhIGhyZWYgbmctY2xpY2s9ImNvbG9ycy5wdXNoKHt9KSI+YWRkPC9hPl0KICAgICAgICAgICAgPC9saT4KICAgICAgICAgIDwvdWw+CiAgICAgICAgICA8aHIvPgogICAgICAgICAgQ29sb3IgKG51bGwgbm90IGFsbG93ZWQpOgogICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0ibXlDb2xvciIgbmctb3B0aW9ucz0iY29sb3IubmFtZSBmb3IgY29sb3IgaW4gY29sb3JzIj48L3NlbGVjdD48YnI+CgogICAgICAgICAgQ29sb3IgKG51bGwgYWxsb3dlZCk6CiAgICAgICAgICA8c3BhbiAgY2xhc3M9Im51bGxhYmxlIj4KICAgICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0ibXlDb2xvciIgbmctb3B0aW9ucz0iY29sb3IubmFtZSBmb3IgY29sb3IgaW4gY29sb3JzIj4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSIiPi0tIGNob29zZSBjb2xvciAtLTwvb3B0aW9uPgogICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgIDwvc3Bhbj48YnIvPgoKICAgICAgICAgIENvbG9yIGdyb3VwZWQgYnkgc2hhZGU6CiAgICAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJteUNvbG9yIiBuZy1vcHRpb25zPSJjb2xvci5uYW1lIGdyb3VwIGJ5IGNvbG9yLnNoYWRlIGZvciBjb2xvciBpbiBjb2xvcnMiPgogICAgICAgICAgPC9zZWxlY3Q+PGJyLz4KCgogICAgICAgICAgU2VsZWN0IDxhIGhyZWYgbmctY2xpY2s9Im15Q29sb3IgPSB7IG5hbWU6J25vdCBpbiBsaXN0Jywgc2hhZGU6ICdvdGhlcicgfSI+Ym9ndXM8L2E+Ljxicj4KICAgICAgICAgIDxoci8+CiAgICAgICAgICBDdXJyZW50bHkgc2VsZWN0ZWQ6IHt7IHtzZWxlY3RlZF9jb2xvcjpteUNvbG9yfSB9fQogICAgICAgICAgPGRpdiBzdHlsZT0iYm9yZGVyOnNvbGlkIDFweCBibGFjazsgaGVpZ2h0OjIwcHgiCiAgICAgICAgICAgICAgIG5nLXN0eWxlPSJ7J2JhY2tncm91bmQtY29sb3InOm15Q29sb3IubmFtZX0iPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZmlsZT4KICAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctb3B0aW9ucycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3tzZWxlY3RlZF9jb2xvcjpteUNvbG9yfScpKS5nZXRUZXh0KCkpLnRvTWF0Y2goJ3JlZCcpOwogICAgICAgICAgIGVsZW1lbnQuYWxsKGJ5Lm1vZGVsKCdteUNvbG9yJykpLmZpcnN0KCkuY2xpY2soKTsKICAgICAgICAgICBlbGVtZW50LmFsbChieS5jc3MoJ3NlbGVjdFtuZy1tb2RlbD0ibXlDb2xvciJdIG9wdGlvbicpKS5maXJzdCgpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygne3NlbGVjdGVkX2NvbG9yOm15Q29sb3J9JykpLmdldFRleHQoKSkudG9NYXRjaCgnYmxhY2snKTsKICAgICAgICAgICBlbGVtZW50KGJ5LmNzcygnLm51bGxhYmxlIHNlbGVjdFtuZy1tb2RlbD0ibXlDb2xvciJdJykpLmNsaWNrKCk7CiAgICAgICAgICAgZWxlbWVudC5hbGwoYnkuY3NzKCcubnVsbGFibGUgc2VsZWN0W25nLW1vZGVsPSJteUNvbG9yIl0gb3B0aW9uJykpLmZpcnN0KCkuY2xpY2soKTsKICAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6bXlDb2xvcn0nKSkuZ2V0VGV4dCgpKS50b01hdGNoKCdudWxsJyk7CiAgICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICA8L2V4YW1wbGU+CiAqLwoKdmFyIG5nT3B0aW9uc0RpcmVjdGl2ZSA9IHZhbHVlRm4oewogIHJlc3RyaWN0OiAnQScsCiAgdGVybWluYWw6IHRydWUKfSk7CgovLyBqc2hpbnQgbWF4bGVuOiBmYWxzZQp2YXIgc2VsZWN0RGlyZWN0aXZlID0gWyckY29tcGlsZScsICckcGFyc2UnLCBmdW5jdGlvbigkY29tcGlsZSwgICAkcGFyc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIC8vMDAwMDExMTExMTExMTEwMDAwMDAwMDAwMDIyMjIyMjIyMjIwMDAwMDAwMDAwMDAwMDAwMDAwMDAzMzMzMzMzMzMzMDAwMDAwMDAwMDAwMDA0NDQ0NDQ0NDQ0NDQ0NDQwMDAwMDAwMDA1NTU1NTU1NTU1NTU1NTUwMDAwMDAwNjY2NjY2NjY2NjY2NjY2MDAwMDAwMDAwMDAwMDAwNzc3Nzc3Nzc3NzAwMDAwMDAwMDAwMDAwMDAwMDA4ODg4ODg4ODg4CiAgdmFyIE5HX09QVElPTlNfUkVHRVhQID0gL15ccyooW1xzXFNdKz8pKD86XHMrYXNccysoW1xzXFNdKz8pKT8oPzpccytncm91cFxzK2J5XHMrKFtcc1xTXSs/KSk/XHMrZm9yXHMrKD86KFtcJFx3XVtcJFx3XSopfCg/OlwoXHMqKFtcJFx3XVtcJFx3XSopXHMqLFxzKihbXCRcd11bXCRcd10qKVxzKlwpKSlccytpblxzKyhbXHNcU10rPykoPzpccyt0cmFja1xzK2J5XHMrKFtcc1xTXSs/KSk/JC8sCiAgICAgIG51bGxNb2RlbEN0cmwgPSB7JHNldFZpZXdWYWx1ZTogbm9vcH07Ci8vIGpzaGludCBtYXhsZW46IDEwMAoKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIHJlcXVpcmU6IFsnc2VsZWN0JywgJz9uZ01vZGVsJ10sCiAgICBjb250cm9sbGVyOiBbJyRlbGVtZW50JywgJyRzY29wZScsICckYXR0cnMnLCBmdW5jdGlvbigkZWxlbWVudCwgJHNjb3BlLCAkYXR0cnMpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgb3B0aW9uc01hcCA9IHt9LAogICAgICAgICAgbmdNb2RlbEN0cmwgPSBudWxsTW9kZWxDdHJsLAogICAgICAgICAgbnVsbE9wdGlvbiwKICAgICAgICAgIHVua25vd25PcHRpb247CgoKICAgICAgc2VsZi5kYXRhYm91bmQgPSAkYXR0cnMubmdNb2RlbDsKCgogICAgICBzZWxmLmluaXQgPSBmdW5jdGlvbihuZ01vZGVsQ3RybF8sIG51bGxPcHRpb25fLCB1bmtub3duT3B0aW9uXykgewogICAgICAgIG5nTW9kZWxDdHJsID0gbmdNb2RlbEN0cmxfOwogICAgICAgIG51bGxPcHRpb24gPSBudWxsT3B0aW9uXzsKICAgICAgICB1bmtub3duT3B0aW9uID0gdW5rbm93bk9wdGlvbl87CiAgICAgIH07CgoKICAgICAgc2VsZi5hZGRPcHRpb24gPSBmdW5jdGlvbih2YWx1ZSwgZWxlbWVudCkgewogICAgICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KHZhbHVlLCAnIm9wdGlvbiB2YWx1ZSInKTsKICAgICAgICBvcHRpb25zTWFwW3ZhbHVlXSA9IHRydWU7CgogICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAkZWxlbWVudC52YWwodmFsdWUpOwogICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgfQogICAgICAgIC8vIFdvcmthcm91bmQgZm9yIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD0zODE0NTkKICAgICAgICAvLyBBZGRpbmcgYW4gPG9wdGlvbiBzZWxlY3RlZD0ic2VsZWN0ZWQiPiBlbGVtZW50IHRvIGEgPHNlbGVjdCByZXF1aXJlZD0icmVxdWlyZWQiPiBzaG91bGQKICAgICAgICAvLyBhdXRvbWF0aWNhbGx5IHNlbGVjdCB0aGUgbmV3IGVsZW1lbnQKICAgICAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50WzBdLmhhc0F0dHJpYnV0ZSgnc2VsZWN0ZWQnKSkgewogICAgICAgICAgZWxlbWVudFswXS5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9OwoKCiAgICAgIHNlbGYucmVtb3ZlT3B0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5oYXNPcHRpb24odmFsdWUpKSB7CiAgICAgICAgICBkZWxldGUgb3B0aW9uc01hcFt2YWx1ZV07CiAgICAgICAgICBpZiAobmdNb2RlbEN0cmwuJHZpZXdWYWx1ZSA9PSB2YWx1ZSkgewogICAgICAgICAgICB0aGlzLnJlbmRlclVua25vd25PcHRpb24odmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKCgogICAgICBzZWxmLnJlbmRlclVua25vd25PcHRpb24gPSBmdW5jdGlvbih2YWwpIHsKICAgICAgICB2YXIgdW5rbm93blZhbCA9ICc/ICcgKyBoYXNoS2V5KHZhbCkgKyAnID8nOwogICAgICAgIHVua25vd25PcHRpb24udmFsKHVua25vd25WYWwpOwogICAgICAgICRlbGVtZW50LnByZXBlbmQodW5rbm93bk9wdGlvbik7CiAgICAgICAgJGVsZW1lbnQudmFsKHVua25vd25WYWwpOwogICAgICAgIHVua25vd25PcHRpb24ucHJvcCgnc2VsZWN0ZWQnLCB0cnVlKTsgLy8gbmVlZGVkIGZvciBJRQogICAgICB9OwoKCiAgICAgIHNlbGYuaGFzT3B0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gb3B0aW9uc01hcC5oYXNPd25Qcm9wZXJ0eSh2YWx1ZSk7CiAgICAgIH07CgogICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgIC8vIGRpc2FibGUgdW5rbm93biBvcHRpb24gc28gdGhhdCB3ZSBkb24ndCBkbyB3b3JrIHdoZW4gdGhlIHdob2xlIHNlbGVjdCBpcyBiZWluZyBkZXN0cm95ZWQKICAgICAgICBzZWxmLnJlbmRlclVua25vd25PcHRpb24gPSBub29wOwogICAgICB9KTsKICAgIH1dLAoKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJscykgewogICAgICAvLyBpZiBuZ01vZGVsIGlzIG5vdCBkZWZpbmVkLCB3ZSBkb24ndCBuZWVkIHRvIGRvIGFueXRoaW5nCiAgICAgIGlmICghY3RybHNbMV0pIHJldHVybjsKCiAgICAgIHZhciBzZWxlY3RDdHJsID0gY3RybHNbMF0sCiAgICAgICAgICBuZ01vZGVsQ3RybCA9IGN0cmxzWzFdLAogICAgICAgICAgbXVsdGlwbGUgPSBhdHRyLm11bHRpcGxlLAogICAgICAgICAgb3B0aW9uc0V4cCA9IGF0dHIubmdPcHRpb25zLAogICAgICAgICAgbnVsbE9wdGlvbiA9IGZhbHNlLCAvLyBpZiBmYWxzZSwgdXNlciB3aWxsIG5vdCBiZSBhYmxlIHRvIHNlbGVjdCBpdCAodXNlZCBieSBuZ09wdGlvbnMpCiAgICAgICAgICBlbXB0eU9wdGlvbiwKICAgICAgICAgIHJlbmRlclNjaGVkdWxlZCA9IGZhbHNlLAogICAgICAgICAgLy8gd2UgY2FuJ3QganVzdCBqcUxpdGUoJzxvcHRpb24+Jykgc2luY2UganFMaXRlIGlzIG5vdCBzbWFydCBlbm91Z2gKICAgICAgICAgIC8vIHRvIGNyZWF0ZSBpdCBpbiA8c2VsZWN0PiBhbmQgSUUgYmFyZnMgb3RoZXJ3aXNlLgogICAgICAgICAgb3B0aW9uVGVtcGxhdGUgPSBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJykpLAogICAgICAgICAgb3B0R3JvdXBUZW1wbGF0ZSA9anFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGdyb3VwJykpLAogICAgICAgICAgdW5rbm93bk9wdGlvbiA9IG9wdGlvblRlbXBsYXRlLmNsb25lKCk7CgogICAgICAvLyBmaW5kICJudWxsIiBvcHRpb24KICAgICAgZm9yKHZhciBpID0gMCwgY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkcmVuKCksIGlpID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgIGlmIChjaGlsZHJlbltpXS52YWx1ZSA9PT0gJycpIHsKICAgICAgICAgIGVtcHR5T3B0aW9uID0gbnVsbE9wdGlvbiA9IGNoaWxkcmVuLmVxKGkpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICBzZWxlY3RDdHJsLmluaXQobmdNb2RlbEN0cmwsIG51bGxPcHRpb24sIHVua25vd25PcHRpb24pOwoKICAgICAgLy8gcmVxdWlyZWQgdmFsaWRhdG9yCiAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgIG5nTW9kZWxDdHJsLiRpc0VtcHR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAhdmFsdWUgfHwgdmFsdWUubGVuZ3RoID09PSAwOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zRXhwKSBzZXR1cEFzT3B0aW9ucyhzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwpOwogICAgICBlbHNlIGlmIChtdWx0aXBsZSkgc2V0dXBBc011bHRpcGxlKHNjb3BlLCBlbGVtZW50LCBuZ01vZGVsQ3RybCk7CiAgICAgIGVsc2Ugc2V0dXBBc1NpbmdsZShzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwsIHNlbGVjdEN0cmwpOwoKCiAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCgoKICAgICAgZnVuY3Rpb24gc2V0dXBBc1NpbmdsZShzY29wZSwgc2VsZWN0RWxlbWVudCwgbmdNb2RlbEN0cmwsIHNlbGVjdEN0cmwpIHsKICAgICAgICBuZ01vZGVsQ3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdmlld1ZhbHVlID0gbmdNb2RlbEN0cmwuJHZpZXdWYWx1ZTsKCiAgICAgICAgICBpZiAoc2VsZWN0Q3RybC5oYXNPcHRpb24odmlld1ZhbHVlKSkgewogICAgICAgICAgICBpZiAodW5rbm93bk9wdGlvbi5wYXJlbnQoKSkgdW5rbm93bk9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgc2VsZWN0RWxlbWVudC52YWwodmlld1ZhbHVlKTsKICAgICAgICAgICAgaWYgKHZpZXdWYWx1ZSA9PT0gJycpIGVtcHR5T3B0aW9uLnByb3AoJ3NlbGVjdGVkJywgdHJ1ZSk7IC8vIHRvIG1ha2UgSUU5IGhhcHB5CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmlld1ZhbHVlKSAmJiBlbXB0eU9wdGlvbikgewogICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQudmFsKCcnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWxlY3RDdHJsLnJlbmRlclVua25vd25PcHRpb24odmlld1ZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHNlbGVjdEVsZW1lbnQub24oJ2NoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodW5rbm93bk9wdGlvbi5wYXJlbnQoKSkgdW5rbm93bk9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHNldFZpZXdWYWx1ZShzZWxlY3RFbGVtZW50LnZhbCgpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBzZXR1cEFzTXVsdGlwbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIGN0cmwpIHsKICAgICAgICB2YXIgbGFzdFZpZXc7CiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgaXRlbXMgPSBuZXcgSGFzaE1hcChjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgZm9yRWFjaChzZWxlY3RFbGVtZW50LmZpbmQoJ29wdGlvbicpLCBmdW5jdGlvbihvcHRpb24pIHsKICAgICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gaXNEZWZpbmVkKGl0ZW1zLmdldChvcHRpb24udmFsdWUpKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIC8vIHdlIGhhdmUgdG8gZG8gaXQgb24gZWFjaCB3YXRjaCBzaW5jZSBuZ01vZGVsIHdhdGNoZXMgcmVmZXJlbmNlLCBidXQKICAgICAgICAvLyB3ZSBuZWVkIHRvIHdvcmsgb2YgYW4gYXJyYXksIHNvIHdlIG5lZWQgdG8gc2VlIGlmIGFueXRoaW5nIHdhcyBpbnNlcnRlZC9yZW1vdmVkCiAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIHNlbGVjdE11bHRpcGxlV2F0Y2goKSB7CiAgICAgICAgICBpZiAoIWVxdWFscyhsYXN0VmlldywgY3RybC4kdmlld1ZhbHVlKSkgewogICAgICAgICAgICBsYXN0VmlldyA9IHNoYWxsb3dDb3B5KGN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgICAgIGN0cmwuJHJlbmRlcigpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBzZWxlY3RFbGVtZW50Lm9uKCdjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgICAgICAgIGZvckVhY2goc2VsZWN0RWxlbWVudC5maW5kKCdvcHRpb24nKSwgZnVuY3Rpb24ob3B0aW9uKSB7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbi5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgYXJyYXkucHVzaChvcHRpb24udmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShhcnJheSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gc2V0dXBBc09wdGlvbnMoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIGN0cmwpIHsKICAgICAgICB2YXIgbWF0Y2g7CgogICAgICAgIGlmICghKG1hdGNoID0gb3B0aW9uc0V4cC5tYXRjaChOR19PUFRJT05TX1JFR0VYUCkpKSB7CiAgICAgICAgICB0aHJvdyBuZ09wdGlvbnNNaW5FcnIoJ2lleHAnLAogICAgICAgICAgICAiRXhwZWN0ZWQgZXhwcmVzc2lvbiBpbiBmb3JtIG9mICIgKwogICAgICAgICAgICAiJ19zZWxlY3RfIChhcyBfbGFiZWxfKT8gZm9yIChfa2V5XywpP192YWx1ZV8gaW4gX2NvbGxlY3Rpb25fJyIgKwogICAgICAgICAgICAiIGJ1dCBnb3QgJ3swfScuIEVsZW1lbnQ6IHsxfSIsCiAgICAgICAgICAgIG9wdGlvbnNFeHAsIHN0YXJ0aW5nVGFnKHNlbGVjdEVsZW1lbnQpKTsKICAgICAgICB9CgogICAgICAgIHZhciBkaXNwbGF5Rm4gPSAkcGFyc2UobWF0Y2hbMl0gfHwgbWF0Y2hbMV0pLAogICAgICAgICAgICB2YWx1ZU5hbWUgPSBtYXRjaFs0XSB8fCBtYXRjaFs2XSwKICAgICAgICAgICAgc2VsZWN0QXMgPSAvIGFzIC8udGVzdChtYXRjaFswXSkgJiYgbWF0Y2hbMV0sCiAgICAgICAgICAgIHNlbGVjdEFzRm4gPSBzZWxlY3RBcyA/ICRwYXJzZShzZWxlY3RBcykgOiBudWxsLAogICAgICAgICAgICBrZXlOYW1lID0gbWF0Y2hbNV0sCiAgICAgICAgICAgIGdyb3VwQnlGbiA9ICRwYXJzZShtYXRjaFszXSB8fCAnJyksCiAgICAgICAgICAgIHZhbHVlRm4gPSAkcGFyc2UobWF0Y2hbMl0gPyBtYXRjaFsxXSA6IHZhbHVlTmFtZSksCiAgICAgICAgICAgIHZhbHVlc0ZuID0gJHBhcnNlKG1hdGNoWzddKSwKICAgICAgICAgICAgdHJhY2sgPSBtYXRjaFs4XSwKICAgICAgICAgICAgdHJhY2tGbiA9IHRyYWNrID8gJHBhcnNlKG1hdGNoWzhdKSA6IG51bGwsCiAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgb2YgYXJyYXkgb2YgZXhpc3Rpbmcgb3B0aW9uIGdyb3VwcyBpbiBET00uCiAgICAgICAgICAgIC8vIFdlIHRyeSB0byByZXVzZSB0aGVzZSBpZiBwb3NzaWJsZQogICAgICAgICAgICAvLyAtIG9wdGlvbkdyb3Vwc0NhY2hlWzBdIGlzIHRoZSBvcHRpb25zIHdpdGggbm8gb3B0aW9uIGdyb3VwCiAgICAgICAgICAgIC8vIC0gb3B0aW9uR3JvdXBzQ2FjaGVbP11bMF0gaXMgdGhlIHBhcmVudDogZWl0aGVyIHRoZSBTRUxFQ1Qgb3IgT1BUR1JPVVAgZWxlbWVudAogICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZSA9IFtbe2VsZW1lbnQ6IHNlbGVjdEVsZW1lbnQsIGxhYmVsOicnfV1dLAogICAgICAgICAgICAvL3JlLXVzYWJsZSBvYmplY3QgdG8gcmVwcmVzZW50IG9wdGlvbidzIGxvY2FscwogICAgICAgICAgICBsb2NhbHMgPSB7fTsKCiAgICAgICAgaWYgKG51bGxPcHRpb24pIHsKICAgICAgICAgIC8vIGNvbXBpbGUgdGhlIGVsZW1lbnQgc2luY2UgdGhlcmUgbWlnaHQgYmUgYmluZGluZ3MgaW4gaXQKICAgICAgICAgICRjb21waWxlKG51bGxPcHRpb24pKHNjb3BlKTsKCiAgICAgICAgICAvLyByZW1vdmUgdGhlIGNsYXNzLCB3aGljaCBpcyBhZGRlZCBhdXRvbWF0aWNhbGx5IGJlY2F1c2Ugd2UgcmVjb21waWxlIHRoZSBlbGVtZW50IGFuZCBpdAogICAgICAgICAgLy8gYmVjb21lcyB0aGUgY29tcGlsYXRpb24gcm9vdAogICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmVDbGFzcygnbmctc2NvcGUnKTsKCiAgICAgICAgICAvLyB3ZSBuZWVkIHRvIHJlbW92ZSBpdCBiZWZvcmUgY2FsbGluZyBzZWxlY3RFbGVtZW50LmVtcHR5KCkgYmVjYXVzZSBvdGhlcndpc2UgSUUgd2lsbAogICAgICAgICAgLy8gcmVtb3ZlIHRoZSBsYWJlbCBmcm9tIHRoZSBlbGVtZW50LiB3dGY/CiAgICAgICAgICBudWxsT3B0aW9uLnJlbW92ZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gY2xlYXIgY29udGVudHMsIHdlJ2xsIGFkZCB3aGF0J3MgbmVlZGVkIGJhc2VkIG9uIHRoZSBtb2RlbAogICAgICAgIHNlbGVjdEVsZW1lbnQuZW1wdHkoKTsKCiAgICAgICAgc2VsZWN0RWxlbWVudC5vbignY2hhbmdlJywgc2VsZWN0aW9uQ2hhbmdlZCk7CgogICAgICAgIGN0cmwuJHJlbmRlciA9IHJlbmRlcjsKCiAgICAgICAgc2NvcGUuJHdhdGNoQ29sbGVjdGlvbih2YWx1ZXNGbiwgc2NoZWR1bGVSZW5kZXJpbmcpOwogICAgICAgIHNjb3BlLiR3YXRjaENvbGxlY3Rpb24oZ2V0TGFiZWxzLCBzY2hlZHVsZVJlbmRlcmluZyk7CgogICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgc2NvcGUuJHdhdGNoQ29sbGVjdGlvbihmdW5jdGlvbigpIHsgcmV0dXJuIGN0cmwuJG1vZGVsVmFsdWU7IH0sIHNjaGVkdWxlUmVuZGVyaW5nKTsKICAgICAgICB9CgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKICAgICAgICBmdW5jdGlvbiBjYWxsRXhwcmVzc2lvbihleHByRm4sIGtleSwgdmFsdWUpIHsKICAgICAgICAgIGxvY2Fsc1t2YWx1ZU5hbWVdID0gdmFsdWU7CiAgICAgICAgICBpZiAoa2V5TmFtZSkgbG9jYWxzW2tleU5hbWVdID0ga2V5OwogICAgICAgICAgcmV0dXJuIGV4cHJGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNlbGVjdGlvbkNoYW5nZWQoKSB7CiAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICAgIGNvbGxlY3Rpb24gPSB2YWx1ZXNGbihzY29wZSkgfHwgW10sCiAgICAgICAgICAgICAgICBrZXksIHZhbHVlLCBvcHRpb25FbGVtZW50LCBpbmRleCwgZ3JvdXBJbmRleCwgbGVuZ3RoLCBncm91cExlbmd0aCwgdHJhY2tJbmRleDsKICAgICAgICAgICAgdmFyIHZpZXdWYWx1ZTsKICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgICAgdmlld1ZhbHVlID0gW107CiAgICAgICAgICAgICAgZm9yRWFjaChzZWxlY3RFbGVtZW50LnZhbCgpLCBmdW5jdGlvbihzZWxlY3RlZEtleSkgewogICAgICAgICAgICAgICAgdmlld1ZhbHVlLnB1c2goZ2V0Vmlld1ZhbHVlKHNlbGVjdGVkS2V5LCBjb2xsZWN0aW9uW3NlbGVjdGVkS2V5XSkpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBzZWxlY3RlZEtleSA9IHNlbGVjdEVsZW1lbnQudmFsKCk7CiAgICAgICAgICAgICAgdmlld1ZhbHVlID0gZ2V0Vmlld1ZhbHVlKHNlbGVjdGVkS2V5LCBjb2xsZWN0aW9uW3NlbGVjdGVkS2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgIHJlbmRlcigpOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRWaWV3VmFsdWUoa2V5LCB2YWx1ZSkgewogICAgICAgICAgaWYgKGtleSA9PT0gJz8nKSB7CiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gJycpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdmlld1ZhbHVlRm4gPSBzZWxlY3RBc0ZuID8gc2VsZWN0QXNGbiA6IHZhbHVlRm47CiAgICAgICAgICAgIHJldHVybiBjYWxsRXhwcmVzc2lvbih2aWV3VmFsdWVGbiwga2V5LCB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRMYWJlbHMoKSB7CiAgICAgICAgICB2YXIgdmFsdWVzID0gdmFsdWVzRm4oc2NvcGUpOwogICAgICAgICAgdmFyIHRvRGlzcGxheTsKICAgICAgICAgIGlmICh2YWx1ZXMgJiYgaXNBcnJheSh2YWx1ZXMpKSB7CiAgICAgICAgICAgIHRvRGlzcGxheSA9IG5ldyBBcnJheSh2YWx1ZXMubGVuZ3RoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gdmFsdWVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICB0b0Rpc3BsYXlbaV0gPSBjYWxsRXhwcmVzc2lvbihkaXNwbGF5Rm4sIGksIHZhbHVlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRvRGlzcGxheTsKICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWVzKSB7CiAgICAgICAgICAgIC8vIFRPRE86IEFkZCBhIHRlc3QgZm9yIHRoaXMgY2FzZQogICAgICAgICAgICB0b0Rpc3BsYXkgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiB2YWx1ZXMpIHsKICAgICAgICAgICAgICBpZiAodmFsdWVzLmhhc093blByb3BlcnR5KHByb3ApKSB7CiAgICAgICAgICAgICAgICB0b0Rpc3BsYXlbcHJvcF0gPSBjYWxsRXhwcmVzc2lvbihkaXNwbGF5Rm4sIHByb3AsIHZhbHVlc1twcm9wXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdG9EaXNwbGF5OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSXNTZWxlY3RlZEZuKHZpZXdWYWx1ZSkgewogICAgICAgICAgdmFyIHNlbGVjdGVkU2V0OwogICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmICh0cmFja0ZuICYmIGlzQXJyYXkodmlld1ZhbHVlKSkgewoKICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IG5ldyBIYXNoTWFwKFtdKTsKICAgICAgICAgICAgICBmb3IgKHZhciB0cmFja0luZGV4ID0gMDsgdHJhY2tJbmRleCA8IHZpZXdWYWx1ZS5sZW5ndGg7IHRyYWNrSW5kZXgrKykgewogICAgICAgICAgICAgICAgLy8gdHJhY2tpbmcgYnkga2V5CiAgICAgICAgICAgICAgICBzZWxlY3RlZFNldC5wdXQoY2FsbEV4cHJlc3Npb24odHJhY2tGbiwgbnVsbCwgdmlld1ZhbHVlW3RyYWNrSW5kZXhdKSwgdHJ1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gbmV3IEhhc2hNYXAodmlld1ZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0cmFja0ZuKSB7CiAgICAgICAgICAgIHZpZXdWYWx1ZSA9IGNhbGxFeHByZXNzaW9uKHRyYWNrRm4sIG51bGwsIHZpZXdWYWx1ZSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGlzU2VsZWN0ZWQoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgY29tcGFyZVZhbHVlRm47CiAgICAgICAgICAgIGlmICh0cmFja0ZuKSB7CiAgICAgICAgICAgICAgY29tcGFyZVZhbHVlRm4gPSB0cmFja0ZuOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNlbGVjdEFzRm4pIHsKICAgICAgICAgICAgICBjb21wYXJlVmFsdWVGbiA9IHNlbGVjdEFzRm47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tcGFyZVZhbHVlRm4gPSB2YWx1ZUZuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICByZXR1cm4gaXNEZWZpbmVkKHNlbGVjdGVkU2V0LnJlbW92ZShjYWxsRXhwcmVzc2lvbihjb21wYXJlVmFsdWVGbiwga2V5LCB2YWx1ZSkpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gdmlld1ZhbHVlID09IGNhbGxFeHByZXNzaW9uKGNvbXBhcmVWYWx1ZUZuLCBrZXksIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlUmVuZGVyaW5nKCkgewogICAgICAgICAgaWYgKCFyZW5kZXJTY2hlZHVsZWQpIHsKICAgICAgICAgICAgc2NvcGUuJCRwb3N0RGlnZXN0KHJlbmRlcik7CiAgICAgICAgICAgIHJlbmRlclNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBBIG5ldyBsYWJlbE1hcCBpcyBjcmVhdGVkIHdpdGggZWFjaCByZW5kZXIuCiAgICAgICAgICogVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgZm9yIGVhY2ggZXhpc3Rpbmcgb3B0aW9uIHdpdGggYWRkZWQ9ZmFsc2UsCiAgICAgICAgICogYW5kIGVhY2ggbmV3IG9wdGlvbiB3aXRoIGFkZGVkPXRydWUuCiAgICAgICAgICogLSBMYWJlbHMgdGhhdCBhcmUgcGFzc2VkIHRvIHRoaXMgbWV0aG9kIHR3aWNlLAogICAgICAgICAqIChvbmNlIHdpdGggYWRkZWQ9dHJ1ZSBhbmQgb25jZSB3aXRoIGFkZGVkPWZhbHNlKSB3aWxsIGVuZCB1cCB3aXRoIGEgdmFsdWUgb2YgMCwgYW5kCiAgICAgICAgICogd2lsbCBjYXVzZSBubyBjaGFuZ2UgdG8gaGFwcGVuIHRvIHRoZSBjb3JyZXNwb25kaW5nIG9wdGlvbi4KICAgICAgICAgKiAtIExhYmVscyB0aGF0IGFyZSBwYXNzZWQgdG8gdGhpcyBtZXRob2Qgb25seSBvbmNlIHdpdGggYWRkZWQ9ZmFsc2Ugd2lsbCBlbmQgdXAgd2l0aCBhCiAgICAgICAgICogdmFsdWUgb2YgLTEgYW5kIHdpbGwgZXZlbnR1YWxseSBiZSBwYXNzZWQgdG8gc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24oKQogICAgICAgICAqIC0gTGFiZWxzIHRoYXQgYXJlIHBhc3NlZCB0byB0aGlzIG1ldGhvZCBvbmx5IG9uY2Ugd2l0aCBhZGRlZD10cnVlIHdpbGwgZW5kIHVwIHdpdGggYQogICAgICAgICAqIHZhbHVlIG9mIDEgYW5kIHdpbGwgZXZlbnR1YWxseSBiZSBwYXNzZWQgdG8gc2VsZWN0Q3RybC5hZGRPcHRpb24oKQogICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTGFiZWxNYXAobGFiZWxNYXAsIGxhYmVsLCBhZGRlZCkgewogICAgICAgICAgbGFiZWxNYXBbbGFiZWxdID0gbGFiZWxNYXBbbGFiZWxdIHx8IDA7CiAgICAgICAgICBsYWJlbE1hcFtsYWJlbF0gKz0gKGFkZGVkID8gMSA6IC0xKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICAgIHJlbmRlclNjaGVkdWxlZCA9IGZhbHNlOwoKICAgICAgICAgIC8vIFRlbXBvcmFyeSBsb2NhdGlvbiBmb3IgdGhlIG9wdGlvbiBncm91cHMgYmVmb3JlIHdlIHJlbmRlciB0aGVtCiAgICAgICAgICB2YXIgb3B0aW9uR3JvdXBzID0geycnOltdfSwKICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWVzID0gWycnXSwKICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUsCiAgICAgICAgICAgICAgb3B0aW9uR3JvdXAsCiAgICAgICAgICAgICAgb3B0aW9uLAogICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LCBleGlzdGluZ09wdGlvbnMsIGV4aXN0aW5nT3B0aW9uLAogICAgICAgICAgICAgIHZpZXdWYWx1ZSA9IGN0cmwuJHZpZXdWYWx1ZSwKICAgICAgICAgICAgICB2YWx1ZXMgPSB2YWx1ZXNGbihzY29wZSkgfHwgW10sCiAgICAgICAgICAgICAga2V5cyA9IGtleU5hbWUgPyBzb3J0ZWRLZXlzKHZhbHVlcykgOiB2YWx1ZXMsCiAgICAgICAgICAgICAga2V5LAogICAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICAgIGdyb3VwTGVuZ3RoLCBsZW5ndGgsCiAgICAgICAgICAgICAgZ3JvdXBJbmRleCwgaW5kZXgsCiAgICAgICAgICAgICAgbGFiZWxNYXAgPSB7fSwKICAgICAgICAgICAgICBzZWxlY3RlZCwKICAgICAgICAgICAgICBpc1NlbGVjdGVkID0gY3JlYXRlSXNTZWxlY3RlZEZuKHZpZXdWYWx1ZSksCiAgICAgICAgICAgICAgYW55U2VsZWN0ZWQgPSBmYWxzZSwKICAgICAgICAgICAgICBsYXN0RWxlbWVudCwKICAgICAgICAgICAgICBlbGVtZW50LAogICAgICAgICAgICAgIGxhYmVsOwoKICAgICAgICAgIC8vIFdlIG5vdyBidWlsZCB1cCB0aGUgbGlzdCBvZiBvcHRpb25zIHdlIG5lZWQgKHdlIG1lcmdlIGxhdGVyKQogICAgICAgICAgZm9yIChpbmRleCA9IDA7IGxlbmd0aCA9IGtleXMubGVuZ3RoLCBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICBrZXkgPSBpbmRleDsKICAgICAgICAgICAgaWYgKGtleU5hbWUpIHsKICAgICAgICAgICAgICBrZXkgPSBrZXlzW2luZGV4XTsKICAgICAgICAgICAgICBpZiAoIGtleS5jaGFyQXQoMCkgPT09ICckJyApIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhbHVlID0gdmFsdWVzW2tleV07CgogICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUgPSBjYWxsRXhwcmVzc2lvbihncm91cEJ5Rm4sIGtleSwgdmFsdWUpIHx8ICcnOwogICAgICAgICAgICBpZiAoIShvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdKSkgewogICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV0gPSBbXTsKICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWVzLnB1c2gob3B0aW9uR3JvdXBOYW1lKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2VsZWN0ZWQgPSBpc1NlbGVjdGVkKGtleSwgdmFsdWUpOwogICAgICAgICAgICBhbnlTZWxlY3RlZCA9IGFueVNlbGVjdGVkIHx8IHNlbGVjdGVkOwoKICAgICAgICAgICAgbGFiZWwgPSBjYWxsRXhwcmVzc2lvbihkaXNwbGF5Rm4sIGtleSwgdmFsdWUpOyAvLyB3aGF0IHdpbGwgYmUgc2VlbiBieSB0aGUgdXNlcgoKICAgICAgICAgICAgLy8gZG9pbmcgZGlzcGxheUZuKHNjb3BlLCBsb2NhbHMpIHx8ICcnIG92ZXJ3cml0ZXMgemVybyB2YWx1ZXMKICAgICAgICAgICAgbGFiZWwgPSBpc0RlZmluZWQobGFiZWwpID8gbGFiZWwgOiAnJzsKICAgICAgICAgICAgb3B0aW9uR3JvdXAucHVzaCh7CiAgICAgICAgICAgICAgLy8gZWl0aGVyIHRoZSBpbmRleCBpbnRvIGFycmF5IG9yIGtleSBmcm9tIG9iamVjdAogICAgICAgICAgICAgIGlkOiAoa2V5TmFtZSA/IGtleXNbaW5kZXhdIDogaW5kZXgpLAogICAgICAgICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICAgICAgICBzZWxlY3RlZDogc2VsZWN0ZWQgICAgICAgICAgICAgICAgICAgLy8gZGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBiZSBzZWxlY3RlZAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghbXVsdGlwbGUpIHsKICAgICAgICAgICAgaWYgKG51bGxPcHRpb24gfHwgdmlld1ZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgLy8gaW5zZXJ0IG51bGwgb3B0aW9uIGlmIHdlIGhhdmUgYSBwbGFjZWhvbGRlciwgb3IgdGhlIG1vZGVsIGlzIG51bGwKICAgICAgICAgICAgICBvcHRpb25Hcm91cHNbJyddLnVuc2hpZnQoe2lkOicnLCBsYWJlbDonJywgc2VsZWN0ZWQ6IWFueVNlbGVjdGVkfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWFueVNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgLy8gb3B0aW9uIGNvdWxkIG5vdCBiZSBmb3VuZCwgd2UgaGF2ZSB0byBpbnNlcnQgdGhlIHVuZGVmaW5lZCBpdGVtCiAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzWycnXS51bnNoaWZ0KHtpZDonPycsIGxhYmVsOicnLCBzZWxlY3RlZDp0cnVlfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBOb3cgd2UgbmVlZCB0byB1cGRhdGUgdGhlIGxpc3Qgb2YgRE9NIG5vZGVzIHRvIG1hdGNoIHRoZSBvcHRpb25Hcm91cHMgd2UgY29tcHV0ZWQgYWJvdmUKICAgICAgICAgIGZvciAoZ3JvdXBJbmRleCA9IDAsIGdyb3VwTGVuZ3RoID0gb3B0aW9uR3JvdXBOYW1lcy5sZW5ndGg7CiAgICAgICAgICAgICAgIGdyb3VwSW5kZXggPCBncm91cExlbmd0aDsKICAgICAgICAgICAgICAgZ3JvdXBJbmRleCsrKSB7CiAgICAgICAgICAgIC8vIGN1cnJlbnQgb3B0aW9uIGdyb3VwIG5hbWUgb3IgJycgaWYgbm8gZ3JvdXAKICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lID0gb3B0aW9uR3JvdXBOYW1lc1tncm91cEluZGV4XTsKCiAgICAgICAgICAgIC8vIGxpc3Qgb2Ygb3B0aW9ucyBmb3IgdGhhdCBncm91cC4gKGZpcnN0IGl0ZW0gaGFzIHRoZSBwYXJlbnQpCiAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV07CgogICAgICAgICAgICBpZiAob3B0aW9uR3JvdXBzQ2FjaGUubGVuZ3RoIDw9IGdyb3VwSW5kZXgpIHsKICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGdyb3cgdGhlIG9wdGlvbkdyb3VwcwogICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50ID0gewogICAgICAgICAgICAgICAgZWxlbWVudDogb3B0R3JvdXBUZW1wbGF0ZS5jbG9uZSgpLmF0dHIoJ2xhYmVsJywgb3B0aW9uR3JvdXBOYW1lKSwKICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb25Hcm91cC5sYWJlbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zID0gW2V4aXN0aW5nUGFyZW50XTsKICAgICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZS5wdXNoKGV4aXN0aW5nT3B0aW9ucyk7CiAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5hcHBlbmQoZXhpc3RpbmdQYXJlbnQuZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zID0gb3B0aW9uR3JvdXBzQ2FjaGVbZ3JvdXBJbmRleF07CiAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQgPSBleGlzdGluZ09wdGlvbnNbMF07ICAvLyBlaXRoZXIgU0VMRUNUIChubyBncm91cCkgb3IgT1BUR1JPVVAgZWxlbWVudAoKICAgICAgICAgICAgICAvLyB1cGRhdGUgdGhlIE9QVEdST1VQIGxhYmVsIGlmIG5vdCB0aGUgc2FtZS4KICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdQYXJlbnQubGFiZWwgIT0gb3B0aW9uR3JvdXBOYW1lKSB7CiAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudC5lbGVtZW50LmF0dHIoJ2xhYmVsJywgZXhpc3RpbmdQYXJlbnQubGFiZWwgPSBvcHRpb25Hcm91cE5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBudWxsOyAgLy8gc3RhcnQgYXQgdGhlIGJlZ2lubmluZwogICAgICAgICAgICBmb3IoaW5kZXggPSAwLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgb3B0aW9uID0gb3B0aW9uR3JvdXBbaW5kZXhdOwogICAgICAgICAgICAgIGlmICgoZXhpc3RpbmdPcHRpb24gPSBleGlzdGluZ09wdGlvbnNbaW5kZXgrMV0pKSB7CiAgICAgICAgICAgICAgICAvLyByZXVzZSBlbGVtZW50cwogICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBleGlzdGluZ09wdGlvbi5lbGVtZW50OwogICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uLmxhYmVsICE9PSBvcHRpb24ubGFiZWwpIHsKICAgICAgICAgICAgICAgICAgdXBkYXRlTGFiZWxNYXAobGFiZWxNYXAsIGV4aXN0aW5nT3B0aW9uLmxhYmVsLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZUxhYmVsTWFwKGxhYmVsTWFwLCBvcHRpb24ubGFiZWwsIHRydWUpOwogICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC50ZXh0KGV4aXN0aW5nT3B0aW9uLmxhYmVsID0gb3B0aW9uLmxhYmVsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ09wdGlvbi5pZCAhPT0gb3B0aW9uLmlkKSB7CiAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnZhbChleGlzdGluZ09wdGlvbi5pZCA9IG9wdGlvbi5pZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBsYXN0RWxlbWVudC5wcm9wKCdzZWxlY3RlZCcpIHByb3ZpZGVkIGJ5IGpRdWVyeSBoYXMgc2lkZS1lZmZlY3RzCiAgICAgICAgICAgICAgICBpZiAobGFzdEVsZW1lbnRbMF0uc2VsZWN0ZWQgIT09IG9wdGlvbi5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC5wcm9wKCdzZWxlY3RlZCcsIChleGlzdGluZ09wdGlvbi5zZWxlY3RlZCA9IG9wdGlvbi5zZWxlY3RlZCkpOwogICAgICAgICAgICAgICAgICBpZiAobXNpZSkgewogICAgICAgICAgICAgICAgICAgIC8vIFNlZSAjNzY5MgogICAgICAgICAgICAgICAgICAgIC8vIFRoZSBzZWxlY3RlZCBpdGVtIHdvdWxkbid0IHZpc3VhbGx5IHVwZGF0ZSBvbiBJRSB3aXRob3V0IHRoaXMuCiAgICAgICAgICAgICAgICAgICAgLy8gVGVzdGVkIG9uIFdpbjc6IElFOSwgSUUxMCBhbmQgSUUxMS4gRnV0dXJlIElFcyBzaG91bGQgYmUgdGVzdGVkIGFzIHdlbGwKICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC5wcm9wKCdzZWxlY3RlZCcsIGV4aXN0aW5nT3B0aW9uLnNlbGVjdGVkKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBncm93IGVsZW1lbnRzCgogICAgICAgICAgICAgICAgLy8gaWYgaXQncyBhIG51bGwgb3B0aW9uCiAgICAgICAgICAgICAgICBpZiAob3B0aW9uLmlkID09PSAnJyAmJiBudWxsT3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgIC8vIHB1dCBiYWNrIHRoZSBwcmUtY29tcGlsZWQgZWxlbWVudAogICAgICAgICAgICAgICAgICBlbGVtZW50ID0gbnVsbE9wdGlvbjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIC8vIGpRdWVyeSh2MS40LjIpIEJ1ZzogV2Ugc2hvdWxkIGJlIGFibGUgdG8gY2hhaW4gdGhlIG1ldGhvZCBjYWxscywgYnV0CiAgICAgICAgICAgICAgICAgIC8vIGluIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnkgb24gc29tZSBicm93c2VyIHRoZSAudGV4dCgpIHJldHVybnMgYSBzdHJpbmcKICAgICAgICAgICAgICAgICAgLy8gcmF0aGVyIHRoZW4gdGhlIGVsZW1lbnQuCiAgICAgICAgICAgICAgICAgIChlbGVtZW50ID0gb3B0aW9uVGVtcGxhdGUuY2xvbmUoKSkKICAgICAgICAgICAgICAgICAgICAgIC52YWwob3B0aW9uLmlkKQogICAgICAgICAgICAgICAgICAgICAgLnByb3AoJ3NlbGVjdGVkJywgb3B0aW9uLnNlbGVjdGVkKQogICAgICAgICAgICAgICAgICAgICAgLmF0dHIoJ3NlbGVjdGVkJywgb3B0aW9uLnNlbGVjdGVkKQogICAgICAgICAgICAgICAgICAgICAgLnRleHQob3B0aW9uLmxhYmVsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucHVzaChleGlzdGluZ09wdGlvbiA9IHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50OiBlbGVtZW50LAogICAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb24ubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgaWQ6IG9wdGlvbi5pZCwKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZDogb3B0aW9uLnNlbGVjdGVkCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHVwZGF0ZUxhYmVsTWFwKGxhYmVsTWFwLCBvcHRpb24ubGFiZWwsIHRydWUpOwogICAgICAgICAgICAgICAgaWYgKGxhc3RFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LmFmdGVyKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQuZWxlbWVudC5hcHBlbmQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHJlbW92ZSBhbnkgZXhjZXNzaXZlIE9QVElPTnMgaW4gYSBncm91cAogICAgICAgICAgICBpbmRleCsrOyAvLyBpbmNyZW1lbnQgc2luY2UgdGhlIGV4aXN0aW5nT3B0aW9uc1swXSBpcyBwYXJlbnQgZWxlbWVudCBub3QgT1BUSU9OCiAgICAgICAgICAgIHdoaWxlKGV4aXN0aW5nT3B0aW9ucy5sZW5ndGggPiBpbmRleCkgewogICAgICAgICAgICAgIG9wdGlvbiA9IGV4aXN0aW5nT3B0aW9ucy5wb3AoKTsKICAgICAgICAgICAgICB1cGRhdGVMYWJlbE1hcChsYWJlbE1hcCwgb3B0aW9uLmxhYmVsLCBmYWxzZSk7CiAgICAgICAgICAgICAgb3B0aW9uLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yRWFjaChsYWJlbE1hcCwgZnVuY3Rpb24gKGNvdW50LCBsYWJlbCkgewogICAgICAgICAgICAgIGlmIChjb3VudCA+IDApIHsKICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKGxhYmVsKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvdW50IDwgMCkgewogICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24obGFiZWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyByZW1vdmUgYW55IGV4Y2Vzc2l2ZSBPUFRHUk9VUHMgZnJvbSBzZWxlY3QKICAgICAgICAgIHdoaWxlKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA+IGdyb3VwSW5kZXgpIHsKICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUucG9wKClbMF0uZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Owp9XTsKCnZhciBvcHRpb25EaXJlY3RpdmUgPSBbJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRpbnRlcnBvbGF0ZSkgewogIHZhciBudWxsU2VsZWN0Q3RybCA9IHsKICAgIGFkZE9wdGlvbjogbm9vcCwKICAgIHJlbW92ZU9wdGlvbjogbm9vcAogIH07CgogIHJldHVybiB7CiAgICByZXN0cmljdDogJ0UnLAogICAgcHJpb3JpdHk6IDEwMCwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgaWYgKGlzVW5kZWZpbmVkKGF0dHIudmFsdWUpKSB7CiAgICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUoZWxlbWVudC50ZXh0KCksIHRydWUpOwogICAgICAgIGlmICghaW50ZXJwb2xhdGVGbikgewogICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIGVsZW1lbnQudGV4dCgpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICB2YXIgc2VsZWN0Q3RybE5hbWUgPSAnJHNlbGVjdENvbnRyb2xsZXInLAogICAgICAgICAgICBwYXJlbnQgPSBlbGVtZW50LnBhcmVudCgpLAogICAgICAgICAgICBzZWxlY3RDdHJsID0gcGFyZW50LmRhdGEoc2VsZWN0Q3RybE5hbWUpIHx8CiAgICAgICAgICAgICAgcGFyZW50LnBhcmVudCgpLmRhdGEoc2VsZWN0Q3RybE5hbWUpOyAvLyBpbiBjYXNlIHdlIGFyZSBpbiBvcHRncm91cAoKICAgICAgICBpZiAoIXNlbGVjdEN0cmwgfHwgIXNlbGVjdEN0cmwuZGF0YWJvdW5kKSB7CiAgICAgICAgICBzZWxlY3RDdHJsID0gbnVsbFNlbGVjdEN0cmw7CiAgICAgICAgfQoKICAgICAgICBpZiAoaW50ZXJwb2xhdGVGbikgewogICAgICAgICAgc2NvcGUuJHdhdGNoKGludGVycG9sYXRlRm4sIGZ1bmN0aW9uIGludGVycG9sYXRlV2F0Y2hBY3Rpb24obmV3VmFsLCBvbGRWYWwpIHsKICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIG5ld1ZhbCk7CiAgICAgICAgICAgIGlmIChvbGRWYWwgIT09IG5ld1ZhbCkgewogICAgICAgICAgICAgIHNlbGVjdEN0cmwucmVtb3ZlT3B0aW9uKG9sZFZhbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZWN0Q3RybC5hZGRPcHRpb24obmV3VmFsLCBlbGVtZW50KTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxlY3RDdHJsLmFkZE9wdGlvbihhdHRyLnZhbHVlLCBlbGVtZW50KTsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQub24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxlY3RDdHJsLnJlbW92ZU9wdGlvbihhdHRyLnZhbHVlKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0KICB9Owp9XTsKCnZhciBzdHlsZURpcmVjdGl2ZSA9IHZhbHVlRm4oewogIHJlc3RyaWN0OiAnRScsCiAgdGVybWluYWw6IGZhbHNlCn0pOwoKICBpZiAod2luZG93LmFuZ3VsYXIuYm9vdHN0cmFwKSB7CiAgICAvL0FuZ3VsYXJKUyBpcyBhbHJlYWR5IGxvYWRlZCwgc28gd2UgY2FuIHJldHVybiBoZXJlLi4uCiAgICBjb25zb2xlLmxvZygnV0FSTklORzogVHJpZWQgdG8gbG9hZCBhbmd1bGFyIG1vcmUgdGhhbiBvbmNlLicpOwogICAgcmV0dXJuOwogIH0KCiAgLy90cnkgdG8gYmluZCB0byBqcXVlcnkgbm93IHNvIHRoYXQgb25lIGNhbiB3cml0ZSBqcUxpdGUoZG9jdW1lbnQpLnJlYWR5KCkKICAvL2J1dCB3ZSB3aWxsIHJlYmluZCBvbiBib290c3RyYXAgYWdhaW4uCiAgYmluZEpRdWVyeSgpOwoKICBwdWJsaXNoRXh0ZXJuYWxBUEkoYW5ndWxhcik7CgogIGpxTGl0ZShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgICBhbmd1bGFySW5pdChkb2N1bWVudCwgYm9vdHN0cmFwKTsKICB9KTsKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwoKIXdpbmRvdy5hbmd1bGFyLiQkY3NwKCkgJiYgd2luZG93LmFuZ3VsYXIuZWxlbWVudChkb2N1bWVudCkuZmluZCgnaGVhZCcpLnByZXBlbmQoJzxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+QGNoYXJzZXQgIlVURi04IjtbbmdcXDpjbG9ha10sW25nLWNsb2FrXSxbZGF0YS1uZy1jbG9ha10sW3gtbmctY2xvYWtdLC5uZy1jbG9haywueC1uZy1jbG9haywubmctaGlkZTpub3QoLm5nLWhpZGUtYW5pbWF0ZSl7ZGlzcGxheTpub25lICFpbXBvcnRhbnQ7fW5nXFw6Zm9ybXtkaXNwbGF5OmJsb2NrO308L3N0eWxlPicpOwovKioKICogQGxpY2Vuc2UgQW5ndWxhckpTIHYxLjMuMAogKiAoYykgMjAxMC0yMDE0IEdvb2dsZSwgSW5jLiBodHRwOi8vYW5ndWxhcmpzLm9yZwogKiBMaWNlbnNlOiBNSVQKICovCihmdW5jdGlvbih3aW5kb3csIGFuZ3VsYXIsIHVuZGVmaW5lZCkgeyd1c2Ugc3RyaWN0JzsKCi8qIGpzaGludCBtYXhsZW46IGZhbHNlICovCgovKioKICogQG5nZG9jIG1vZHVsZQogKiBAbmFtZSBuZ0FuaW1hdGUKICogQGRlc2NyaXB0aW9uCiAqCiAqIFRoZSBgbmdBbmltYXRlYCBtb2R1bGUgcHJvdmlkZXMgc3VwcG9ydCBmb3IgSmF2YVNjcmlwdCwgQ1NTMyB0cmFuc2l0aW9uIGFuZCBDU1MzIGtleWZyYW1lIGFuaW1hdGlvbiBob29rcyB3aXRoaW4gZXhpc3RpbmcgY29yZSBhbmQgY3VzdG9tIGRpcmVjdGl2ZXMuCiAqCiAqIDxkaXYgZG9jLW1vZHVsZS1jb21wb25lbnRzPSJuZ0FuaW1hdGUiPjwvZGl2PgogKgogKiAjIFVzYWdlCiAqCiAqIFRvIHNlZSBhbmltYXRpb25zIGluIGFjdGlvbiwgYWxsIHRoYXQgaXMgcmVxdWlyZWQgaXMgdG8gZGVmaW5lIHRoZSBhcHByb3ByaWF0ZSBDU1MgY2xhc3NlcwogKiBvciB0byByZWdpc3RlciBhIEphdmFTY3JpcHQgYW5pbWF0aW9uIHZpYSB0aGUgbXlNb2R1bGUuYW5pbWF0aW9uKCkgZnVuY3Rpb24uIFRoZSBkaXJlY3RpdmVzIHRoYXQgc3VwcG9ydCBhbmltYXRpb24gYXV0b21hdGljYWxseSBhcmU6CiAqIGBuZ1JlcGVhdGAsIGBuZ0luY2x1ZGVgLCBgbmdJZmAsIGBuZ1N3aXRjaGAsIGBuZ1Nob3dgLCBgbmdIaWRlYCwgYG5nVmlld2AgYW5kIGBuZ0NsYXNzYC4gQ3VzdG9tIGRpcmVjdGl2ZXMgY2FuIHRha2UgYWR2YW50YWdlIG9mIGFuaW1hdGlvbgogKiBieSB1c2luZyB0aGUgYCRhbmltYXRlYCBzZXJ2aWNlLgogKgogKiBCZWxvdyBpcyBhIG1vcmUgZGV0YWlsZWQgYnJlYWtkb3duIG9mIHRoZSBzdXBwb3J0ZWQgYW5pbWF0aW9uIGV2ZW50cyBwcm92aWRlZCBieSBwcmUtZXhpc3RpbmcgbmcgZGlyZWN0aXZlczoKICoKICogfCBEaXJlY3RpdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IFN1cHBvcnRlZCBBbmltYXRpb25zICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQjYW5pbWF0aW9ucyBuZ1JlcGVhdH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgZW50ZXIsIGxlYXZlIGFuZCBtb3ZlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogfCB7QGxpbmsgbmdSb3V0ZS5kaXJlY3RpdmU6bmdWaWV3I2FuaW1hdGlvbnMgbmdWaWV3fSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGVudGVyIGFuZCBsZWF2ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUjYW5pbWF0aW9ucyBuZ0luY2x1ZGV9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBlbnRlciBhbmQgbGVhdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdTd2l0Y2gjYW5pbWF0aW9ucyBuZ1N3aXRjaH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgZW50ZXIgYW5kIGxlYXZlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSWYjYW5pbWF0aW9ucyBuZ0lmfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGVudGVyIGFuZCBsZWF2ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAqIHwge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzI2FuaW1hdGlvbnMgbmdDbGFzc30gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBhZGQgYW5kIHJlbW92ZSAodGhlIENTUyBjbGFzcyhlcykgcHJlc2VudCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdTaG93I2FuaW1hdGlvbnMgbmdTaG93fSAmIHtAbGluayBuZy5kaXJlY3RpdmU6bmdIaWRlI2FuaW1hdGlvbnMgbmdIaWRlfSAgICAgICAgICAgIHwgYWRkIGFuZCByZW1vdmUgKHRoZSBuZy1oaWRlIGNsYXNzIHZhbHVlKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0jYW5pbWF0aW9uLWhvb2tzIGZvcm19ICYge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ01vZGVsI2FuaW1hdGlvbi1ob29rcyBuZ01vZGVsfSAgICB8IGFkZCBhbmQgcmVtb3ZlIChkaXJ0eSwgcHJpc3RpbmUsIHZhbGlkLCBpbnZhbGlkICYgYWxsIG90aGVyIHZhbGlkYXRpb25zKSB8CiAqIHwge0BsaW5rIG1vZHVsZTpuZ01lc3NhZ2VzI2FuaW1hdGlvbnMgbmdNZXNzYWdlc30gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBhZGQgYW5kIHJlbW92ZSAobmctYWN0aXZlICYgbmctaW5hY3RpdmUpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogKiB8IHtAbGluayBtb2R1bGU6bmdNZXNzYWdlcyNhbmltYXRpb25zIG5nTWVzc2FnZX0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgZW50ZXIgYW5kIGxlYXZlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICoKICogWW91IGNhbiBmaW5kIG91dCBtb3JlIGluZm9ybWF0aW9uIGFib3V0IGFuaW1hdGlvbnMgdXBvbiB2aXNpdGluZyBlYWNoIGRpcmVjdGl2ZSBwYWdlLgogKgogKiBCZWxvdyBpcyBhbiBleGFtcGxlIG9mIGhvdyB0byBhcHBseSBhbmltYXRpb25zIHRvIGEgZGlyZWN0aXZlIHRoYXQgc3VwcG9ydHMgYW5pbWF0aW9uIGhvb2tzOgogKgogKiBgYGBodG1sCiAqIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAqIC5zbGlkZS5uZy1lbnRlciwgLnNsaWRlLm5nLWxlYXZlIHsKICogICAtd2Via2l0LXRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogKiAgIHRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogKiB9CiAqCiAqIC5zbGlkZS5uZy1lbnRlciB7IH0gICAgICAgIC8mIzQyOyBzdGFydGluZyBhbmltYXRpb25zIGZvciBlbnRlciAmIzQyOy8KICogLnNsaWRlLm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7IH0gLyYjNDI7IHRlcm1pbmFsIGFuaW1hdGlvbnMgZm9yIGVudGVyICYjNDI7LwogKiAuc2xpZGUubmctbGVhdmUgeyB9ICAgICAgICAvJiM0Mjsgc3RhcnRpbmcgYW5pbWF0aW9ucyBmb3IgbGVhdmUgJiM0MjsvCiAqIC5zbGlkZS5uZy1sZWF2ZS5uZy1sZWF2ZS1hY3RpdmUgeyB9IC8mIzQyOyB0ZXJtaW5hbCBhbmltYXRpb25zIGZvciBsZWF2ZSAmIzQyOy8KICogPC9zdHlsZT4KICoKICogPCEtLQogKiB0aGUgYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgYXV0b21hdGljYWxseSBhZGQgLm5nLWVudGVyIGFuZCAubmctbGVhdmUgdG8gdGhlIGVsZW1lbnQKICogdG8gdHJpZ2dlciB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9ucwogKiAtLT4KICogPEFOWSBjbGFzcz0ic2xpZGUiIG5nLWluY2x1ZGU9Ii4uLiI+PC9BTlk+CiAqIGBgYAogKgogKiBLZWVwIGluIG1pbmQgdGhhdCwgYnkgZGVmYXVsdCwgaWYgYW4gYW5pbWF0aW9uIGlzIHJ1bm5pbmcsIGFueSBjaGlsZCBlbGVtZW50cyBjYW5ub3QgYmUgYW5pbWF0ZWQKICogdW50aWwgdGhlIHBhcmVudCBlbGVtZW50J3MgYW5pbWF0aW9uIGhhcyBjb21wbGV0ZWQuIFRoaXMgYmxvY2tpbmcgZmVhdHVyZSBjYW4gYmUgb3ZlcnJpZGRlbiBieQogKiBwbGFjaW5nIHRoZSBgbmctYW5pbWF0ZS1jaGlsZHJlbmAgYXR0cmlidXRlIG9uIGEgcGFyZW50IGNvbnRhaW5lciB0YWcuCiAqCiAqIGBgYGh0bWwKICogPGRpdiBjbGFzcz0ic2xpZGUtYW5pbWF0aW9uIiBuZy1pZj0ib24iIG5nLWFuaW1hdGUtY2hpbGRyZW4+CiAqICAgPGRpdiBjbGFzcz0iZmFkZS1hbmltYXRpb24iIG5nLWlmPSJvbiI+CiAqICAgICA8ZGl2IGNsYXNzPSJleHBsb2RlLWFuaW1hdGlvbiIgbmctaWY9Im9uIj4KICogICAgICAgIC4uLgogKiAgICAgPC9kaXY+CiAqICAgPC9kaXY+CiAqIDwvZGl2PgogKiBgYGAKICoKICogV2hlbiB0aGUgYG9uYCBleHByZXNzaW9uIHZhbHVlIGNoYW5nZXMgYW5kIGFuIGFuaW1hdGlvbiBpcyB0cmlnZ2VyZWQgdGhlbiBlYWNoIG9mIHRoZSBlbGVtZW50cyB3aXRoaW4KICogd2lsbCBhbGwgYW5pbWF0ZSB3aXRob3V0IHRoZSBibG9jayBiZWluZyBhcHBsaWVkIHRvIGNoaWxkIGVsZW1lbnRzLgogKgogKiAjIyBBcmUgYW5pbWF0aW9ucyBydW4gd2hlbiB0aGUgYXBwbGljYXRpb24gc3RhcnRzPwogKiBObyB0aGV5IGFyZSBub3QuIFdoZW4gYW4gYXBwbGljYXRpb24gaXMgYm9vdHN0cmFwcGVkIEFuZ3VsYXIgd2lsbCBkaXNhYmxlIGFuaW1hdGlvbnMgZnJvbSBydW5uaW5nIHRvIGF2b2lkCiAqIGEgZnJlbnp5IG9mIGFuaW1hdGlvbnMgZnJvbSBiZWluZyB0cmlnZ2VyZWQgYXMgc29vbiBhcyB0aGUgYnJvd3NlciBoYXMgcmVuZGVyZWQgdGhlIHNjcmVlbi4gRm9yIHRoaXMgdG8gd29yaywKICogQW5ndWxhciB3aWxsIHdhaXQgZm9yIHR3byBkaWdlc3QgY3ljbGVzIHVudGlsIGVuYWJsaW5nIGFuaW1hdGlvbnMuIEZyb20gdGhlcmUgb24sIGFueSBhbmltYXRpb24tdHJpZ2dlcmluZwogKiBsYXlvdXQgY2hhbmdlcyBpbiB0aGUgYXBwbGljYXRpb24gd2lsbCB0cmlnZ2VyIGFuaW1hdGlvbnMgYXMgbm9ybWFsLgogKgogKiBJbiBhZGRpdGlvbiwgdXBvbiBib290c3RyYXAsIGlmIHRoZSByb3V0aW5nIHN5c3RlbSBvciBhbnkgZGlyZWN0aXZlcyBvciBsb2FkIHJlbW90ZSBkYXRhICh2aWEgJGh0dHApIHRoZW4gQW5ndWxhcgogKiB3aWxsIGF1dG9tYXRpY2FsbHkgZXh0ZW5kIHRoZSB3YWl0IHRpbWUgdG8gZW5hYmxlIGFuaW1hdGlvbnMgb25jZSAqKmFsbCoqIG9mIHRoZSBvdXRib3VuZCBIVFRQIHJlcXVlc3RzCiAqIGFyZSBjb21wbGV0ZS4KICoKICogIyMgQ1NTLWRlZmluZWQgQW5pbWF0aW9ucwogKiBUaGUgYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgYXV0b21hdGljYWxseSBhcHBseSB0d28gQ1NTIGNsYXNzZXMgdG8gdGhlIGFuaW1hdGVkIGVsZW1lbnQgYW5kIHRoZXNlIHR3byBDU1MgY2xhc3NlcwogKiBhcmUgZGVzaWduZWQgdG8gY29udGFpbiB0aGUgc3RhcnQgYW5kIGVuZCBDU1Mgc3R5bGluZy4gQm90aCBDU1MgdHJhbnNpdGlvbnMgYW5kIGtleWZyYW1lIGFuaW1hdGlvbnMgYXJlIHN1cHBvcnRlZAogKiBhbmQgY2FuIGJlIHVzZWQgdG8gcGxheSBhbG9uZyB3aXRoIHRoaXMgbmFtaW5nIHN0cnVjdHVyZS4KICoKICogVGhlIGZvbGxvd2luZyBjb2RlIGJlbG93IGRlbW9uc3RyYXRlcyBob3cgdG8gcGVyZm9ybSBhbmltYXRpb25zIHVzaW5nICoqQ1NTIHRyYW5zaXRpb25zKiogd2l0aCBBbmd1bGFyOgogKgogKiBgYGBodG1sCiAqIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAqIC8mIzQyOwogKiAgVGhlIGFuaW1hdGUgY2xhc3MgaXMgYXBhcnQgb2YgdGhlIGVsZW1lbnQgYW5kIHRoZSBuZy1lbnRlciBjbGFzcwogKiAgaXMgYXR0YWNoZWQgdG8gdGhlIGVsZW1lbnQgb25jZSB0aGUgZW50ZXIgYW5pbWF0aW9uIGV2ZW50IGlzIHRyaWdnZXJlZAogKiAmIzQyOy8KICogLnJldmVhbC1hbmltYXRpb24ubmctZW50ZXIgewogKiAgLXdlYmtpdC10cmFuc2l0aW9uOiAxcyBsaW5lYXIgYWxsOyAvJiM0MjsgU2FmYXJpL0Nocm9tZSAmIzQyOy8KICogIHRyYW5zaXRpb246IDFzIGxpbmVhciBhbGw7IC8mIzQyOyBBbGwgb3RoZXIgbW9kZXJuIGJyb3dzZXJzIGFuZCBJRTEwKyAmIzQyOy8KICoKICogIC8mIzQyOyBUaGUgYW5pbWF0aW9uIHByZXBhcmF0aW9uIGNvZGUgJiM0MjsvCiAqICBvcGFjaXR5OiAwOwogKiB9CiAqCiAqIC8mIzQyOwogKiAgS2VlcCBpbiBtaW5kIHRoYXQgeW91IHdhbnQgdG8gY29tYmluZSBib3RoIENTUwogKiAgY2xhc3NlcyB0b2dldGhlciB0byBhdm9pZCBhbnkgQ1NTLXNwZWNpZmljaXR5CiAqICBjb25mbGljdHMKICogJiM0MjsvCiAqIC5yZXZlYWwtYW5pbWF0aW9uLm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7CiAqICAvJiM0MjsgVGhlIGFuaW1hdGlvbiBjb2RlIGl0c2VsZiAmIzQyOy8KICogIG9wYWNpdHk6IDE7CiAqIH0KICogPC9zdHlsZT4KICoKICogPGRpdiBjbGFzcz0idmlldy1jb250YWluZXIiPgogKiAgIDxkaXYgbmctdmlldyBjbGFzcz0icmV2ZWFsLWFuaW1hdGlvbiI+PC9kaXY+CiAqIDwvZGl2PgogKiBgYGAKICoKICogVGhlIGZvbGxvd2luZyBjb2RlIGJlbG93IGRlbW9uc3RyYXRlcyBob3cgdG8gcGVyZm9ybSBhbmltYXRpb25zIHVzaW5nICoqQ1NTIGFuaW1hdGlvbnMqKiB3aXRoIEFuZ3VsYXI6CiAqCiAqIGBgYGh0bWwKICogPHN0eWxlIHR5cGU9InRleHQvY3NzIj4KICogLnJldmVhbC1hbmltYXRpb24ubmctZW50ZXIgewogKiAgIC13ZWJraXQtYW5pbWF0aW9uOiBlbnRlcl9zZXF1ZW5jZSAxcyBsaW5lYXI7IC8mIzQyOyBTYWZhcmkvQ2hyb21lICYjNDI7LwogKiAgIGFuaW1hdGlvbjogZW50ZXJfc2VxdWVuY2UgMXMgbGluZWFyOyAvJiM0MjsgSUUxMCsgYW5kIEZ1dHVyZSBCcm93c2VycyAmIzQyOy8KICogfQogKiBALXdlYmtpdC1rZXlmcmFtZXMgZW50ZXJfc2VxdWVuY2UgewogKiAgIGZyb20geyBvcGFjaXR5OjA7IH0KICogICB0byB7IG9wYWNpdHk6MTsgfQogKiB9CiAqIEBrZXlmcmFtZXMgZW50ZXJfc2VxdWVuY2UgewogKiAgIGZyb20geyBvcGFjaXR5OjA7IH0KICogICB0byB7IG9wYWNpdHk6MTsgfQogKiB9CiAqIDwvc3R5bGU+CiAqCiAqIDxkaXYgY2xhc3M9InZpZXctY29udGFpbmVyIj4KICogICA8ZGl2IG5nLXZpZXcgY2xhc3M9InJldmVhbC1hbmltYXRpb24iPjwvZGl2PgogKiA8L2Rpdj4KICogYGBgCiAqCiAqIEJvdGggQ1NTMyBhbmltYXRpb25zIGFuZCB0cmFuc2l0aW9ucyBjYW4gYmUgdXNlZCB0b2dldGhlciBhbmQgdGhlIGFuaW1hdGUgc2VydmljZSB3aWxsIGZpZ3VyZSBvdXQgdGhlIGNvcnJlY3QgZHVyYXRpb24gYW5kIGRlbGF5IHRpbWluZy4KICoKICogVXBvbiBET00gbXV0YXRpb24sIHRoZSBldmVudCBjbGFzcyBpcyBhZGRlZCBmaXJzdCAoc29tZXRoaW5nIGxpa2UgYG5nLWVudGVyYCksIHRoZW4gdGhlIGJyb3dzZXIgcHJlcGFyZXMgaXRzZWxmIHRvIGFkZAogKiB0aGUgYWN0aXZlIGNsYXNzIChpbiB0aGlzIGNhc2UgYG5nLWVudGVyLWFjdGl2ZWApIHdoaWNoIHRoZW4gdHJpZ2dlcnMgdGhlIGFuaW1hdGlvbi4gVGhlIGFuaW1hdGlvbiBtb2R1bGUgd2lsbCBhdXRvbWF0aWNhbGx5CiAqIGRldGVjdCB0aGUgQ1NTIGNvZGUgdG8gZGV0ZXJtaW5lIHdoZW4gdGhlIGFuaW1hdGlvbiBlbmRzLiBPbmNlIHRoZSBhbmltYXRpb24gaXMgb3ZlciB0aGVuIGJvdGggQ1NTIGNsYXNzZXMgd2lsbCBiZQogKiByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgYSBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgQ1NTIHRyYW5zaXRpb25zIG9yIENTUyBhbmltYXRpb25zIHRoZW4gdGhlIGFuaW1hdGlvbiB3aWxsIHN0YXJ0IGFuZCBlbmQKICogaW1tZWRpYXRlbHkgcmVzdWx0aW5nIGluIGEgRE9NIGVsZW1lbnQgdGhhdCBpcyBhdCBpdHMgZmluYWwgc3RhdGUuIFRoaXMgZmluYWwgc3RhdGUgaXMgd2hlbiB0aGUgRE9NIGVsZW1lbnQKICogaGFzIG5vIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBjbGFzc2VzIGFwcGxpZWQgdG8gaXQuCiAqCiAqICMjIyBTdHJ1Y3R1cmFsIHRyYW5zaXRpb24gYW5pbWF0aW9ucwogKgogKiBTdHJ1Y3R1cmFsIHRyYW5zaXRpb25zIChzdWNoIGFzIGVudGVyLCBsZWF2ZSBhbmQgbW92ZSkgd2lsbCBhbHdheXMgYXBwbHkgYSBgMHMgbm9uZWAgdHJhbnNpdGlvbgogKiB2YWx1ZSB0byBmb3JjZSB0aGUgYnJvd3NlciBpbnRvIHJlbmRlcmluZyB0aGUgc3R5bGVzIGRlZmluZWQgaW4gdGhlIHNldHVwICgubmctZW50ZXIsIC5uZy1sZWF2ZQogKiBvciAubmctbW92ZSkgY2xhc3MuIFRoaXMgbWVhbnMgdGhhdCBhbnkgYWN0aXZlIHRyYW5zaXRpb24gYW5pbWF0aW9ucyBvcGVyYXRpbmcgb24gdGhlIGVsZW1lbnQKICogd2lsbCBiZSBjdXQgb2ZmIHRvIG1ha2Ugd2F5IGZvciB0aGUgZW50ZXIsIGxlYXZlIG9yIG1vdmUgYW5pbWF0aW9uLgogKgogKiAjIyMgQ2xhc3MtYmFzZWQgdHJhbnNpdGlvbiBhbmltYXRpb25zCiAqCiAqIENsYXNzLWJhc2VkIHRyYW5zaXRpb25zIHJlZmVyIHRvIHRyYW5zaXRpb24gYW5pbWF0aW9ucyB0aGF0IGFyZSB0cmlnZ2VyZWQgd2hlbiBhIENTUyBjbGFzcyBpcwogKiBhZGRlZCB0byBvciByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgKHZpYSBgJGFuaW1hdGUuYWRkQ2xhc3NgLCBgJGFuaW1hdGUucmVtb3ZlQ2xhc3NgLAogKiBgJGFuaW1hdGUuc2V0Q2xhc3NgLCBvciBieSBkaXJlY3RpdmVzIHN1Y2ggYXMgYG5nQ2xhc3NgLCBgbmdNb2RlbGAgYW5kIGBmb3JtYCkuCiAqIFRoZXkgYXJlIGRpZmZlcmVudCB3aGVuIGNvbXBhcmVkIHRvIHN0cnVjdHVyYWwgYW5pbWF0aW9ucyBzaW5jZSB0aGV5ICoqZG8gbm90IGNhbmNlbCBleGlzdGluZwogKiBhbmltYXRpb25zKiogbm9yIGRvIHRoZXkgKipibG9jayBzdWNjZXNzaXZlIHRyYW5zaXRpb25zKiogZnJvbSByZW5kZXJpbmcgb24gdGhlIHNhbWUgZWxlbWVudC4KICogVGhpcyBkaXN0aW5jdGlvbiBhbGxvd3MgZm9yICoqbXVsdGlwbGUgY2xhc3MtYmFzZWQgdHJhbnNpdGlvbnMqKiB0byBiZSBwZXJmb3JtZWQgb24gdGhlIHNhbWUgZWxlbWVudC4KICoKICogSW4gYWRkaXRpb24gdG8gbmdBbmltYXRlIHN1cHBvcnRpbmcgdGhlIGRlZmF1bHQgKG5hdHVyYWwpIGZ1bmN0aW9uYWxpdHkgb2YgY2xhc3MtYmFzZWQgdHJhbnNpdGlvbgogKiBhbmltYXRpb25zLCBuZ0FuaW1hdGUgYWxzbyBkZWNvcmF0ZXMgdGhlIGVsZW1lbnQgd2l0aCBzdGFydGluZyBhbmQgZW5kaW5nIENTUyBjbGFzc2VzIHRvIGFpZCB0aGUKICogZGV2ZWxvcGVyIGluIGZ1cnRoZXIgc3R5bGluZyB0aGUgZWxlbWVudCB0aHJvdWdob3V0IHRoZSB0cmFuc2l0aW9uIGFuaW1hdGlvbi4gRWFybGllciB2ZXJzaW9ucwogKiBvZiBuZ0FuaW1hdGUgbWF5IGhhdmUgY2F1c2VkIG5hdHVyYWwgQ1NTIHRyYW5zaXRpb25zIHRvIGJyZWFrIGFuZCBub3QgcmVuZGVyIHByb3Blcmx5IGR1ZSB0bwogKiAkYW5pbWF0ZSB0ZW1wb3JhcmlseSBibG9ja2luZyB0cmFuc2l0aW9ucyB1c2luZyBgMHMgbm9uZWAgaW4gb3JkZXIgdG8gYWxsb3cgdGhlIHNldHVwIENTUyBjbGFzcwogKiAodGhlIGAtYWRkYCBvciBgLXJlbW92ZWAgY2xhc3MpIHRvIGJlIGFwcGxpZWQgd2l0aG91dCB0cmlnZ2VyaW5nIGFuIGFuaW1hdGlvbi4gSG93ZXZlciwgYXMgb2YKICogKip2ZXJzaW9uIDEuMyoqLCB0aGlzIHdvcmthcm91bmQgaGFzIGJlZW4gcmVtb3ZlZCB3aXRoIG5nQW5pbWF0ZSBhbmQgYWxsIG5vbi1uZ0FuaW1hdGUgQ1NTCiAqIGNsYXNzIHRyYW5zaXRpb25zIGFyZSBjb21wYXRpYmxlIHdpdGggbmdBbmltYXRlLgogKgogKiBUaGVyZSBpcywgaG93ZXZlciwgb25lIHNwZWNpYWwgY2FzZSB3aGVuIGRlYWxpbmcgd2l0aCBjbGFzcy1iYXNlZCB0cmFuc2l0aW9ucyBpbiBuZ0FuaW1hdGUuCiAqIFdoZW4gcmVuZGVyaW5nIGNsYXNzLWJhc2VkIHRyYW5zaXRpb25zIHRoYXQgbWFrZSB1c2Ugb2YgdGhlIHNldHVwIGFuZCBhY3RpdmUgQ1NTIGNsYXNzZXMKICogKGUuZy4gYC5mYWRlLWFkZGAgYW5kIGAuZmFkZS1hZGQtYWN0aXZlYCBmb3Igd2hlbiBgLmZhZGVgIGlzIGFkZGVkKSBiZSBzdXJlIHRvIGRlZmluZQogKiB0aGUgdHJhbnNpdGlvbiB2YWx1ZSAqKm9uIHRoZSBhY3RpdmUgQ1NTIGNsYXNzKiogYW5kIG5vdCB0aGUgc2V0dXAgY2xhc3MuCiAqCiAqIGBgYGNzcwogKiAuZmFkZS1hZGQgewogKiAgIC8mIzQyOyByZW1lbWJlciB0byBwbGFjZSBhIDBzIHRyYW5zaXRpb24gaGVyZQogKiAgICAgIHRvIGVuc3VyZSB0aGF0IHRoZSBzdHlsZXMgYXJlIGFwcGxpZWQgaW5zdGFudGx5CiAqICAgICAgZXZlbiBpZiB0aGUgZWxlbWVudCBhbHJlYWR5IGhhcyBhIHRyYW5zaXRpb24gc3R5bGUgJiM0MjsvCiAqICAgdHJhbnNpdGlvbjowcyBsaW5lYXIgYWxsOwogKgogKiAgIC8mIzQyOyBzdGFydGluZyBDU1Mgc3R5bGVzICYjNDI7LwogKiAgIG9wYWNpdHk6MTsKICogfQogKiAuZmFkZS1hZGQuZmFkZS1hZGQtYWN0aXZlIHsKICogICAvJiM0MjsgdGhpcyB3aWxsIGJlIHRoZSBsZW5ndGggb2YgdGhlIGFuaW1hdGlvbiAmIzQyOy8KICogICB0cmFuc2l0aW9uOjFzIGxpbmVhciBhbGw7CiAqICAgb3BhY2l0eTowOwogKiB9CiAqIGBgYAogKgogKiBUaGUgc2V0dXAgQ1NTIGNsYXNzIChpbiB0aGlzIGNhc2UgYC5mYWRlLWFkZGApIGFsc28gaGFzIGEgdHJhbnNpdGlvbiBzdHlsZSBwcm9wZXJ0eSwgaG93ZXZlciwgaXQKICogaGFzIGEgZHVyYXRpb24gb2YgemVyby4gVGhpcyBtYXkgbm90IGJlIHJlcXVpcmVkLCBob3dldmVyLCBpbmNhc2UgdGhlIGJyb3dzZXIgaXMgdW5hYmxlIHRvIHJlbmRlcgogKiB0aGUgc3R5bGluZyBwcmVzZW50IGluIHRoaXMgQ1NTIGNsYXNzIGluc3RhbnRseSB0aGVuIGl0IGNvdWxkIGJlIHRoYXQgdGhlIGJyb3dzZXIgaXMgYXR0ZW1wdGluZwogKiB0byBwZXJmb3JtIGFuIHVubmVjZXNzYXJ5IHRyYW5zaXRpb24uCiAqCiAqIFRoaXMgd29ya2Fyb3VuZCwgaG93ZXZlciwgZG9lcyBub3QgYXBwbHkgdG8gIHN0YW5kYXJkIGNsYXNzLWJhc2VkIHRyYW5zaXRpb25zIHRoYXQgYXJlIHJlbmRlcmVkCiAqIHdoZW4gYSBDU1MgY2xhc3MgY29udGFpbmluZyBhIHRyYW5zaXRpb24gaXMgYXBwbGllZCB0byBhbiBlbGVtZW50OgogKgogKiBgYGBjc3MKICogLmZhZGUgewogKiAgIC8mIzQyOyB0aGlzIHdvcmtzIGFzIGV4cGVjdGVkICYjNDI7LwogKiAgIHRyYW5zaXRpb246MXMgbGluZWFyIGFsbDsKICogICBvcGFjaXR5OjA7CiAqIH0KICogYGBgCiAqCiAqIFBsZWFzZSBrZWVwIHRoaXMgaW4gbWluZCB3aGVuIGNvZGluZyB0aGUgQ1NTIG1hcmt1cCB0aGF0IHdpbGwgYmUgdXNlZCB3aXRoaW4gY2xhc3MtYmFzZWQgdHJhbnNpdGlvbnMuCiAqIEFsc28sIHRyeSBub3QgdG8gbWl4IHRoZSB0d28gY2xhc3MtYmFzZWQgYW5pbWF0aW9uIGZsYXZvcnMgdG9nZXRoZXIgc2luY2UgdGhlIENTUyBjb2RlIG1heSBiZWNvbWUKICogb3Zlcmx5IGNvbXBsZXguCiAqCiAqICMjIyBDU1MgU3RhZ2dlcmluZyBBbmltYXRpb25zCiAqIEEgU3RhZ2dlcmluZyBhbmltYXRpb24gaXMgYSBjb2xsZWN0aW9uIG9mIGFuaW1hdGlvbnMgdGhhdCBhcmUgaXNzdWVkIHdpdGggYSBzbGlnaHQgZGVsYXkgaW4gYmV0d2VlbiBlYWNoIHN1Y2Nlc3NpdmUgb3BlcmF0aW9uIHJlc3VsdGluZyBpbiBhCiAqIGN1cnRhaW4tbGlrZSBlZmZlY3QuIFRoZSBuZ0FuaW1hdGUgbW9kdWxlICh2ZXJzaW9ucyA+PTEuMikgc3VwcG9ydHMgc3RhZ2dlcmluZyBhbmltYXRpb25zIGFuZCB0aGUgc3RhZ2dlciBlZmZlY3QgY2FuIGJlCiAqIHBlcmZvcm1lZCBieSBjcmVhdGluZyBhICoqbmctRVZFTlQtc3RhZ2dlcioqIENTUyBjbGFzcyBhbmQgYXR0YWNoaW5nIHRoYXQgY2xhc3MgdG8gdGhlIGJhc2UgQ1NTIGNsYXNzIHVzZWQgZm9yCiAqIHRoZSBhbmltYXRpb24uIFRoZSBzdHlsZSBwcm9wZXJ0eSBleHBlY3RlZCB3aXRoaW4gdGhlIHN0YWdnZXIgY2xhc3MgY2FuIGVpdGhlciBiZSBhICoqdHJhbnNpdGlvbi1kZWxheSoqIG9yIGFuCiAqICoqYW5pbWF0aW9uLWRlbGF5KiogcHJvcGVydHkgKG9yIGJvdGggaWYgeW91ciBhbmltYXRpb24gY29udGFpbnMgYm90aCB0cmFuc2l0aW9ucyBhbmQga2V5ZnJhbWUgYW5pbWF0aW9ucykuCiAqCiAqIGBgYGNzcwogKiAubXktYW5pbWF0aW9uLm5nLWVudGVyIHsKICogICAvJiM0Mjsgc3RhbmRhcmQgdHJhbnNpdGlvbiBjb2RlICYjNDI7LwogKiAgIC13ZWJraXQtdHJhbnNpdGlvbjogMXMgbGluZWFyIGFsbDsKICogICB0cmFuc2l0aW9uOiAxcyBsaW5lYXIgYWxsOwogKiAgIG9wYWNpdHk6MDsKICogfQogKiAubXktYW5pbWF0aW9uLm5nLWVudGVyLXN0YWdnZXIgewogKiAgIC8mIzQyOyB0aGlzIHdpbGwgaGF2ZSBhIDEwMG1zIGRlbGF5IGJldHdlZW4gZWFjaCBzdWNjZXNzaXZlIGxlYXZlIGFuaW1hdGlvbiAmIzQyOy8KICogICAtd2Via2l0LXRyYW5zaXRpb24tZGVsYXk6IDAuMXM7CiAqICAgdHJhbnNpdGlvbi1kZWxheTogMC4xczsKICoKICogICAvJiM0MjsgaW4gY2FzZSB0aGUgc3RhZ2dlciBkb2Vzbid0IHdvcmsgdGhlbiB0aGVzZSB0d28gdmFsdWVzCiAqICAgIG11c3QgYmUgc2V0IHRvIDAgdG8gYXZvaWQgYW4gYWNjaWRlbnRhbCBDU1MgaW5oZXJpdGFuY2UgJiM0MjsvCiAqICAgLXdlYmtpdC10cmFuc2l0aW9uLWR1cmF0aW9uOiAwczsKICogICB0cmFuc2l0aW9uLWR1cmF0aW9uOiAwczsKICogfQogKiAubXktYW5pbWF0aW9uLm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7CiAqICAgLyYjNDI7IHN0YW5kYXJkIHRyYW5zaXRpb24gc3R5bGVzICYjNDI7LwogKiAgIG9wYWNpdHk6MTsKICogfQogKiBgYGAKICoKICogU3RhZ2dlcmluZyBhbmltYXRpb25zIHdvcmsgYnkgZGVmYXVsdCBpbiBuZ1JlcGVhdCAoc28gbG9uZyBhcyB0aGUgQ1NTIGNsYXNzIGlzIGRlZmluZWQpLiBPdXRzaWRlIG9mIG5nUmVwZWF0LCB0byB1c2Ugc3RhZ2dlcmluZyBhbmltYXRpb25zCiAqIG9uIHlvdXIgb3duLCB0aGV5IGNhbiBiZSB0cmlnZ2VyZWQgYnkgZmlyaW5nIG11bHRpcGxlIGNhbGxzIHRvIHRoZSBzYW1lIGV2ZW50IG9uICRhbmltYXRlLiBIb3dldmVyLCB0aGUgcmVzdHJpY3Rpb25zIHN1cnJvdW5kaW5nIHRoaXMKICogYXJlIHRoYXQgZWFjaCBvZiB0aGUgZWxlbWVudHMgbXVzdCBoYXZlIHRoZSBzYW1lIENTUyBjbGFzc05hbWUgdmFsdWUgYXMgd2VsbCBhcyB0aGUgc2FtZSBwYXJlbnQgZWxlbWVudC4gQSBzdGFnZ2VyIG9wZXJhdGlvbgogKiB3aWxsIGFsc28gYmUgcmVzZXQgaWYgbW9yZSB0aGFuIDEwbXMgaGFzIHBhc3NlZCBhZnRlciB0aGUgbGFzdCBhbmltYXRpb24gaGFzIGJlZW4gZmlyZWQuCiAqCiAqIFRoZSBmb2xsb3dpbmcgY29kZSB3aWxsIGlzc3VlIHRoZSAqKm5nLWxlYXZlLXN0YWdnZXIqKiBldmVudCBvbiB0aGUgZWxlbWVudCBwcm92aWRlZDoKICoKICogYGBganMKICogdmFyIGtpZHMgPSBwYXJlbnQuY2hpbGRyZW4oKTsKICoKICogJGFuaW1hdGUubGVhdmUoa2lkc1swXSk7IC8vc3RhZ2dlciBpbmRleD0wCiAqICRhbmltYXRlLmxlYXZlKGtpZHNbMV0pOyAvL3N0YWdnZXIgaW5kZXg9MQogKiAkYW5pbWF0ZS5sZWF2ZShraWRzWzJdKTsgLy9zdGFnZ2VyIGluZGV4PTIKICogJGFuaW1hdGUubGVhdmUoa2lkc1szXSk7IC8vc3RhZ2dlciBpbmRleD0zCiAqICRhbmltYXRlLmxlYXZlKGtpZHNbNF0pOyAvL3N0YWdnZXIgaW5kZXg9NAogKgogKiAkdGltZW91dChmdW5jdGlvbigpIHsKICogICAvL3N0YWdnZXIgaGFzIHJlc2V0IGl0c2VsZgogKiAgICRhbmltYXRlLmxlYXZlKGtpZHNbNV0pOyAvL3N0YWdnZXIgaW5kZXg9MAogKiAgICRhbmltYXRlLmxlYXZlKGtpZHNbNl0pOyAvL3N0YWdnZXIgaW5kZXg9MQogKiB9LCAxMDAsIGZhbHNlKTsKICogYGBgCiAqCiAqIFN0YWdnZXIgYW5pbWF0aW9ucyBhcmUgY3VycmVudGx5IG9ubHkgc3VwcG9ydGVkIHdpdGhpbiBDU1MtZGVmaW5lZCBhbmltYXRpb25zLgogKgogKiAjIyBKYXZhU2NyaXB0LWRlZmluZWQgQW5pbWF0aW9ucwogKiBJbiB0aGUgZXZlbnQgdGhhdCB5b3UgZG8gbm90IHdhbnQgdG8gdXNlIENTUzMgdHJhbnNpdGlvbnMgb3IgQ1NTMyBhbmltYXRpb25zIG9yIGlmIHlvdSB3aXNoIHRvIG9mZmVyIGFuaW1hdGlvbnMgb24gYnJvd3NlcnMgdGhhdCBkbyBub3QKICogeWV0IHN1cHBvcnQgQ1NTIHRyYW5zaXRpb25zL2FuaW1hdGlvbnMsIHRoZW4geW91IGNhbiBtYWtlIHVzZSBvZiBKYXZhU2NyaXB0IGFuaW1hdGlvbnMgZGVmaW5lZCBpbnNpZGUgb2YgeW91ciBBbmd1bGFySlMgbW9kdWxlLgogKgogKiBgYGBqcwogKiAvLyFhbm5vdGF0ZT0iWW91ckFwcCIgWW91ciBBbmd1bGFySlMgTW9kdWxlfFJlcGxhY2UgdGhpcyBvciBuZ01vZHVsZSB3aXRoIHRoZSBtb2R1bGUgdGhhdCB5b3UgdXNlZCB0byBkZWZpbmUgeW91ciBhcHBsaWNhdGlvbi4KICogdmFyIG5nTW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ1lvdXJBcHAnLCBbJ25nQW5pbWF0ZSddKTsKICogbmdNb2R1bGUuYW5pbWF0aW9uKCcubXktY3JhenktYW5pbWF0aW9uJywgZnVuY3Rpb24oKSB7CiAqICAgcmV0dXJuIHsKICogICAgIGVudGVyOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7CiAqICAgICAgIC8vcnVuIHRoZSBhbmltYXRpb24gaGVyZSBhbmQgY2FsbCBkb25lIHdoZW4gdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZQogKiAgICAgICByZXR1cm4gZnVuY3Rpb24oY2FuY2VsbGVkKSB7CiAqICAgICAgICAgLy90aGlzIChvcHRpb25hbCkgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgYW5pbWF0aW9uCiAqICAgICAgICAgLy9jb21wbGV0ZXMgb3Igd2hlbiB0aGUgYW5pbWF0aW9uIGlzIGNhbmNlbGxlZCAodGhlIGNhbmNlbGxlZAogKiAgICAgICAgIC8vZmxhZyB3aWxsIGJlIHNldCB0byB0cnVlIGlmIGNhbmNlbGxlZCkuCiAqICAgICAgIH07CiAqICAgICB9LAogKiAgICAgbGVhdmU6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmUpIHsgfSwKICogICAgIG1vdmU6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmUpIHsgfSwKICoKICogICAgIC8vYW5pbWF0aW9uIHRoYXQgY2FuIGJlIHRyaWdnZXJlZCBiZWZvcmUgdGhlIGNsYXNzIGlzIGFkZGVkCiAqICAgICBiZWZvcmVBZGRDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7IH0sCiAqCiAqICAgICAvL2FuaW1hdGlvbiB0aGF0IGNhbiBiZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGNsYXNzIGlzIGFkZGVkCiAqICAgICBhZGRDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7IH0sCiAqCiAqICAgICAvL2FuaW1hdGlvbiB0aGF0IGNhbiBiZSB0cmlnZ2VyZWQgYmVmb3JlIHRoZSBjbGFzcyBpcyByZW1vdmVkCiAqICAgICBiZWZvcmVSZW1vdmVDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7IH0sCiAqCiAqICAgICAvL2FuaW1hdGlvbiB0aGF0IGNhbiBiZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGNsYXNzIGlzIHJlbW92ZWQKICogICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGRvbmUpIHsgfQogKiAgIH07CiAqIH0pOwogKiBgYGAKICoKICogSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgYXJlIGNyZWF0ZWQgd2l0aCBhIENTUy1saWtlIGNsYXNzIHNlbGVjdG9yIGFuZCBhIGNvbGxlY3Rpb24gb2YgZXZlbnRzIHdoaWNoIGFyZSBzZXQgdG8gcnVuCiAqIGEgamF2YXNjcmlwdCBjYWxsYmFjayBmdW5jdGlvbi4gV2hlbiBhbiBhbmltYXRpb24gaXMgdHJpZ2dlcmVkLCAkYW5pbWF0ZSB3aWxsIGxvb2sgZm9yIGEgbWF0Y2hpbmcgYW5pbWF0aW9uIHdoaWNoIGZpdHMKICogdGhlIGVsZW1lbnQncyBDU1MgY2xhc3MgYXR0cmlidXRlIHZhbHVlIGFuZCB0aGVuIHJ1biB0aGUgbWF0Y2hpbmcgYW5pbWF0aW9uIGV2ZW50IGZ1bmN0aW9uIChpZiBmb3VuZCkuCiAqIEluIG90aGVyIHdvcmRzLCBpZiB0aGUgQ1NTIGNsYXNzZXMgcHJlc2VudCBvbiB0aGUgYW5pbWF0ZWQgZWxlbWVudCBtYXRjaCBhbnkgb2YgdGhlIEphdmFTY3JpcHQgYW5pbWF0aW9ucyB0aGVuIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aWxsCiAqIGJlIGV4ZWN1dGVkLiBJdCBzaG91bGQgYmUgYWxzbyBub3RlZCB0aGF0IG9ubHkgc2ltcGxlLCBzaW5nbGUgY2xhc3Mgc2VsZWN0b3JzIGFyZSBhbGxvd2VkIChjb21wb3VuZCBjbGFzcyBzZWxlY3RvcnMgYXJlIG5vdCBzdXBwb3J0ZWQpLgogKgogKiBXaXRoaW4gYSBKYXZhU2NyaXB0IGFuaW1hdGlvbiwgYW4gb2JqZWN0IGNvbnRhaW5pbmcgdmFyaW91cyBldmVudCBjYWxsYmFjayBhbmltYXRpb24gZnVuY3Rpb25zIGlzIGV4cGVjdGVkIHRvIGJlIHJldHVybmVkLgogKiBBcyBleHBsYWluZWQgYWJvdmUsIHRoZXNlIGNhbGxiYWNrcyBhcmUgdHJpZ2dlcmVkIGJhc2VkIG9uIHRoZSBhbmltYXRpb24gZXZlbnQuIFRoZXJlZm9yZSBpZiBhbiBlbnRlciBhbmltYXRpb24gaXMgcnVuLAogKiBhbmQgdGhlIEphdmFTY3JpcHQgYW5pbWF0aW9uIGlzIGZvdW5kLCB0aGVuIHRoZSBlbnRlciBjYWxsYmFjayB3aWxsIGhhbmRsZSB0aGF0IGFuaW1hdGlvbiAoaW4gYWRkaXRpb24gdG8gdGhlIENTUyBrZXlmcmFtZSBhbmltYXRpb24KICogb3IgdHJhbnNpdGlvbiBjb2RlIHRoYXQgaXMgZGVmaW5lZCB2aWEgYSBzdHlsZXNoZWV0KS4KICoKICoKICogIyMjIEFwcGx5aW5nIERpcmVjdGl2ZS1zcGVjaWZpYyBTdHlsZXMgdG8gYW4gQW5pbWF0aW9uCiAqIEluIHNvbWUgY2FzZXMgYSBkaXJlY3RpdmUgb3Igc2VydmljZSBtYXkgd2FudCB0byBwcm92aWRlIGAkYW5pbWF0ZWAgd2l0aCBleHRyYSBkZXRhaWxzIHRoYXQgdGhlIGFuaW1hdGlvbiB3aWxsCiAqIGluY2x1ZGUgaW50byBpdHMgYW5pbWF0aW9uLiBMZXQncyBzYXkgZm9yIGV4YW1wbGUgd2Ugd2FudGVkIHRvIHJlbmRlciBhbiBhbmltYXRpb24gdGhhdCBhbmltYXRlcyBhbiBlbGVtZW50CiAqIHRvd2FyZHMgdGhlIG1vdXNlIGNvb3JkaW5hdGVzIGFzIHRvIHdoZXJlIHRoZSB1c2VyIGNsaWNrZWQgbGFzdC4gQnkgY29sbGVjdGluZyB0aGUgWC9ZIGNvb3JkaW5hdGVzIG9mIHRoZSBjbGljawogKiAodmlhIHRoZSBldmVudCBwYXJhbWV0ZXIpIHdlIGNhbiBzZXQgdGhlIGB0b3BgIGFuZCBgbGVmdGAgc3R5bGVzIGludG8gYW4gb2JqZWN0IGFuZCBwYXNzIHRoYXQgaW50byBvdXIgZnVuY3Rpb24KICogY2FsbCB0byBgJGFuaW1hdGUuYWRkQ2xhc3NgLgogKgogKiBgYGBqcwogKiBjYW52YXMub24oJ2NsaWNrJywgZnVuY3Rpb24oZSkgewogKiAgICRhbmltYXRlLmFkZENsYXNzKGVsZW1lbnQsICdvbicsIHsKICogICAgIHRvOiB7CiAqICAgICAgIGxlZnQgOiBlLmNsaWVudC54ICsgJ3B4JywKICogICAgICAgdG9wIDogZS5jbGllbnQueSArICdweCcKICogICAgIH0KICogICB9KToKICogfSk7CiAqIGBgYAogKgogKiBOb3cgd2hlbiB0aGUgYW5pbWF0aW9uIHJ1bnMsIGFuZCBhIHRyYW5zaXRpb24gb3Iga2V5ZnJhbWUgYW5pbWF0aW9uIGlzIHBpY2tlZCB1cCwgdGhlbiB0aGUgYW5pbWF0aW9uIGl0c2VsZiB3aWxsCiAqIGFsc28gaW5jbHVkZSBhbmQgdHJhbnNpdGlvbiB0aGUgc3R5bGluZyBvZiB0aGUgYGxlZnRgIGFuZCBgdG9wYCBwcm9wZXJ0aWVzIGludG8gaXRzIHJ1bm5pbmcgYW5pbWF0aW9uLiBJZiB3ZSB3YW50CiAqIHRvIHByb3ZpZGUgc29tZSBzdGFydGluZyBhbmltYXRpb24gdmFsdWVzIHRoZW4gd2UgY2FuIGRvIHNvIGJ5IHBsYWNpbmcgdGhlIHN0YXJ0aW5nIGFuaW1hdGlvbnMgc3R5bGVzIGludG8gYW4gb2JqZWN0CiAqIGNhbGxlZCBgZnJvbWAgaW4gdGhlIHNhbWUgb2JqZWN0IGFzIHRoZSBgdG9gIGFuaW1hdGlvbnMuCiAqCiAqIGBgYGpzCiAqIGNhbnZhcy5vbignY2xpY2snLCBmdW5jdGlvbihlKSB7CiAqICAgJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgJ29uJywgewogKiAgICAgZnJvbTogewogKiAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsCiAqICAgICAgICBsZWZ0OiAnMHB4JywKICogICAgICAgIHRvcDogJzBweCcKICogICAgIH0sCiAqICAgICB0bzogewogKiAgICAgICBsZWZ0IDogZS5jbGllbnQueCArICdweCcsCiAqICAgICAgIHRvcCA6IGUuY2xpZW50LnkgKyAncHgnCiAqICAgICB9CiAqICAgfSk6CiAqIH0pOwogKiBgYGAKICoKICogT25jZSB0aGUgYW5pbWF0aW9uIGlzIGNvbXBsZXRlIG9yIGNhbmNlbGxlZCB0aGVuIHRoZSB1bmlvbiBvZiBib3RoIHRoZSBiZWZvcmUgYW5kIGFmdGVyIHN0eWxlcyBhcmUgYXBwbGllZCB0byB0aGUKICogZWxlbWVudC4gSWYgYG5nQW5pbWF0ZWAgaXMgbm90IHByZXNlbnQgdGhlbiB0aGUgc3R5bGVzIHdpbGwgYmUgYXBwbGllZCBpbW1lZGlhdGVseS4KICoKICovCgphbmd1bGFyLm1vZHVsZSgnbmdBbmltYXRlJywgWyduZyddKQoKICAvKioKICAgKiBAbmdkb2MgcHJvdmlkZXIKICAgKiBAbmFtZSAkYW5pbWF0ZVByb3ZpZGVyCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBUaGUgYCRhbmltYXRlUHJvdmlkZXJgIGFsbG93cyBkZXZlbG9wZXJzIHRvIHJlZ2lzdGVyIEphdmFTY3JpcHQgYW5pbWF0aW9uIGV2ZW50IGhhbmRsZXJzIGRpcmVjdGx5IGluc2lkZSBvZiBhIG1vZHVsZS4KICAgKiBXaGVuIGFuIGFuaW1hdGlvbiBpcyB0cmlnZ2VyZWQsIHRoZSAkYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgcXVlcnkgdGhlICRhbmltYXRlIHNlcnZpY2UgdG8gZmluZCBhbnkgYW5pbWF0aW9ucyB0aGF0IG1hdGNoCiAgICogdGhlIHByb3ZpZGVkIG5hbWUgdmFsdWUuCiAgICoKICAgKiBSZXF1aXJlcyB0aGUge0BsaW5rIG5nQW5pbWF0ZSBgbmdBbmltYXRlYH0gbW9kdWxlIHRvIGJlIGluc3RhbGxlZC4KICAgKgogICAqIFBsZWFzZSB2aXNpdCB0aGUge0BsaW5rIG5nQW5pbWF0ZSBgbmdBbmltYXRlYH0gbW9kdWxlIG92ZXJ2aWV3IHBhZ2UgbGVhcm4gbW9yZSBhYm91dCBob3cgdG8gdXNlIGFuaW1hdGlvbnMgaW4geW91ciBhcHBsaWNhdGlvbi4KICAgKgogICAqLwogIC5kaXJlY3RpdmUoJ25nQW5pbWF0ZUNoaWxkcmVuJywgZnVuY3Rpb24oKSB7CiAgICB2YXIgTkdfQU5JTUFURV9DSElMRFJFTiA9ICckJG5nQW5pbWF0ZUNoaWxkcmVuJzsKICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgdmFyIHZhbCA9IGF0dHJzLm5nQW5pbWF0ZUNoaWxkcmVuOwogICAgICBpZiAoYW5ndWxhci5pc1N0cmluZyh2YWwpICYmIHZhbC5sZW5ndGggPT09IDApIHsgLy9lbXB0eSBhdHRyaWJ1dGUKICAgICAgICBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9DSElMRFJFTiwgdHJ1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2NvcGUuJHdhdGNoKHZhbCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NISUxEUkVOLCAhIXZhbHVlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICB9KQoKICAvL3RoaXMgcHJpdmF0ZSBzZXJ2aWNlIGlzIG9ubHkgdXNlZCB3aXRoaW4gQ1NTLWVuYWJsZWQgYW5pbWF0aW9ucwogIC8vSUU4ICsgSUU5IGRvIG5vdCBzdXBwb3J0IHJBRiBuYXRpdmVseSwgYnV0IHRoYXQgaXMgZmluZSBzaW5jZSB0aGV5CiAgLy9hbHNvIGRvbid0IHN1cHBvcnQgdHJhbnNpdGlvbnMgYW5kIGtleWZyYW1lcyB3aGljaCBtZWFucyB0aGF0IHRoZSBjb2RlCiAgLy9iZWxvdyB3aWxsIG5ldmVyIGJlIHVzZWQgYnkgdGhlIHR3byBicm93c2Vycy4KICAuZmFjdG9yeSgnJCRhbmltYXRlUmVmbG93JywgWyckJHJBRicsICckZG9jdW1lbnQnLCBmdW5jdGlvbigkJHJBRiwgJGRvY3VtZW50KSB7CiAgICB2YXIgYm9kID0gJGRvY3VtZW50WzBdLmJvZHk7CiAgICByZXR1cm4gZnVuY3Rpb24oZm4pIHsKICAgICAgLy90aGUgcmV0dXJuZWQgZnVuY3Rpb24gYWN0cyBhcyB0aGUgY2FuY2VsbGF0aW9uIGZ1bmN0aW9uCiAgICAgIHJldHVybiAkJHJBRihmdW5jdGlvbigpIHsKICAgICAgICAvL3RoZSBsaW5lIGJlbG93IHdpbGwgZm9yY2UgdGhlIGJyb3dzZXIgdG8gcGVyZm9ybSBhIHJlcGFpbnQKICAgICAgICAvL3NvIHRoYXQgYWxsIHRoZSBhbmltYXRlZCBlbGVtZW50cyB3aXRoaW4gdGhlIGFuaW1hdGlvbiBmcmFtZQogICAgICAgIC8vd2lsbCBiZSBwcm9wZXJseSB1cGRhdGVkIGFuZCBkcmF3biBvbiBzY3JlZW4uIFRoaXMgaXMKICAgICAgICAvL3JlcXVpcmVkIHRvIHBlcmZvcm0gbXVsdGktY2xhc3MgQ1NTIGJhc2VkIGFuaW1hdGlvbnMgd2l0aAogICAgICAgIC8vRmlyZWZveC4gRE8gTk9UIFJFTU9WRSBUSElTIExJTkUuCiAgICAgICAgdmFyIGEgPSBib2Qub2Zmc2V0V2lkdGggKyAxOwogICAgICAgIGZuKCk7CiAgICAgIH0pOwogICAgfTsKICB9XSkKCiAgLmNvbmZpZyhbJyRwcm92aWRlJywgJyRhbmltYXRlUHJvdmlkZXInLCBmdW5jdGlvbigkcHJvdmlkZSwgJGFuaW1hdGVQcm92aWRlcikgewogICAgdmFyIG5vb3AgPSBhbmd1bGFyLm5vb3A7CiAgICB2YXIgZm9yRWFjaCA9IGFuZ3VsYXIuZm9yRWFjaDsKICAgIHZhciBzZWxlY3RvcnMgPSAkYW5pbWF0ZVByb3ZpZGVyLiQkc2VsZWN0b3JzOwogICAgdmFyIGlzQXJyYXkgPSBhbmd1bGFyLmlzQXJyYXk7CiAgICB2YXIgaXNTdHJpbmcgPSBhbmd1bGFyLmlzU3RyaW5nOwogICAgdmFyIGlzT2JqZWN0ID0gYW5ndWxhci5pc09iamVjdDsKCiAgICB2YXIgRUxFTUVOVF9OT0RFID0gMTsKICAgIHZhciBOR19BTklNQVRFX1NUQVRFID0gJyQkbmdBbmltYXRlU3RhdGUnOwogICAgdmFyIE5HX0FOSU1BVEVfQ0hJTERSRU4gPSAnJCRuZ0FuaW1hdGVDaGlsZHJlbic7CiAgICB2YXIgTkdfQU5JTUFURV9DTEFTU19OQU1FID0gJ25nLWFuaW1hdGUnOwogICAgdmFyIHJvb3RBbmltYXRlU3RhdGUgPSB7cnVubmluZzogdHJ1ZX07CgogICAgZnVuY3Rpb24gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpIHsKICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGVsZW1lbnQubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgZWxtID0gZWxlbWVudFtpXTsKICAgICAgICBpZiAoZWxtLm5vZGVUeXBlID09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgcmV0dXJuIGVsbTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBwcmVwYXJlRWxlbWVudChlbGVtZW50KSB7CiAgICAgIHJldHVybiBlbGVtZW50ICYmIGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgIH0KCiAgICBmdW5jdGlvbiBzdHJpcENvbW1lbnRzRnJvbUVsZW1lbnQoZWxlbWVudCkgewogICAgICByZXR1cm4gYW5ndWxhci5lbGVtZW50KGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KSk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNNYXRjaGluZ0VsZW1lbnQoZWxtMSwgZWxtMikgewogICAgICByZXR1cm4gZXh0cmFjdEVsZW1lbnROb2RlKGVsbTEpID09IGV4dHJhY3RFbGVtZW50Tm9kZShlbG0yKTsKICAgIH0KCiAgICAkcHJvdmlkZS5kZWNvcmF0b3IoJyRhbmltYXRlJywKICAgICAgICBbJyRkZWxlZ2F0ZScsICckJHEnLCAnJGluamVjdG9yJywgJyRzbmlmZmVyJywgJyRyb290RWxlbWVudCcsICckJGFzeW5jQ2FsbGJhY2snLCAnJHJvb3RTY29wZScsICckZG9jdW1lbnQnLCAnJHRlbXBsYXRlUmVxdWVzdCcsCiBmdW5jdGlvbigkZGVsZWdhdGUsICAgJCRxLCAgICRpbmplY3RvciwgICAkc25pZmZlciwgICAkcm9vdEVsZW1lbnQsICAgJCRhc3luY0NhbGxiYWNrLCAgICRyb290U2NvcGUsICAgJGRvY3VtZW50LCAgICR0ZW1wbGF0ZVJlcXVlc3QpIHsKCiAgICAgICRyb290RWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUsIHJvb3RBbmltYXRlU3RhdGUpOwoKICAgICAgLy8gV2FpdCB1bnRpbCBhbGwgZGlyZWN0aXZlIGFuZCByb3V0ZS1yZWxhdGVkIHRlbXBsYXRlcyBhcmUgZG93bmxvYWRlZCBhbmQKICAgICAgLy8gY29tcGlsZWQuIFRoZSAkdGVtcGxhdGVSZXF1ZXN0LnRvdGFsUGVuZGluZ1JlcXVlc3RzIHZhcmlhYmxlIGtlZXBzIHRyYWNrIG9mCiAgICAgIC8vIGFsbCBvZiB0aGUgcmVtb3RlIHRlbXBsYXRlcyBiZWluZyBjdXJyZW50bHkgZG93bmxvYWRlZC4gSWYgdGhlcmUgYXJlIG5vCiAgICAgIC8vIHRlbXBsYXRlcyBjdXJyZW50bHkgZG93bmxvYWRpbmcgdGhlbiB0aGUgd2F0Y2hlciB3aWxsIHN0aWxsIGZpcmUgYW55d2F5LgogICAgICB2YXIgZGVyZWdpc3RlcldhdGNoID0gJHJvb3RTY29wZS4kd2F0Y2goCiAgICAgICAgZnVuY3Rpb24oKSB7IHJldHVybiAkdGVtcGxhdGVSZXF1ZXN0LnRvdGFsUGVuZGluZ1JlcXVlc3RzOyB9LAogICAgICAgIGZ1bmN0aW9uKHZhbCwgb2xkVmFsKSB7CiAgICAgICAgICBpZiAodmFsICE9PSAwKSByZXR1cm47CiAgICAgICAgICBkZXJlZ2lzdGVyV2F0Y2goKTsKCiAgICAgICAgICAvLyBOb3cgdGhhdCBhbGwgdGVtcGxhdGVzIGhhdmUgYmVlbiBkb3dubG9hZGVkLCAkYW5pbWF0ZSB3aWxsIHdhaXQgdW50aWwKICAgICAgICAgIC8vIHRoZSBwb3N0IGRpZ2VzdCBxdWV1ZSBpcyBlbXB0eSBiZWZvcmUgZW5hYmxpbmcgYW5pbWF0aW9ucy4gQnkgaGF2aW5nIHR3bwogICAgICAgICAgLy8gY2FsbHMgdG8gJHBvc3REaWdlc3QgY2FsbHMgd2UgY2FuIGVuc3VyZSB0aGF0IHRoZSBmbGFnIGlzIGVuYWJsZWQgYXQgdGhlCiAgICAgICAgICAvLyB2ZXJ5IGVuZCBvZiB0aGUgcG9zdCBkaWdlc3QgcXVldWUuIFNpbmNlIGFsbCBvZiB0aGUgYW5pbWF0aW9ucyBpbiAkYW5pbWF0ZQogICAgICAgICAgLy8gdXNlICRwb3N0RGlnZXN0LCBpdCdzIGltcG9ydGFudCB0aGF0IHRoZSBjb2RlIGJlbG93IGV4ZWN1dGVzIGF0IHRoZSBlbmQuCiAgICAgICAgICAvLyBUaGlzIGJhc2ljYWxseSBtZWFucyB0aGF0IHRoZSBwYWdlIGlzIGZ1bGx5IGRvd25sb2FkZWQgYW5kIGNvbXBpbGVkIGJlZm9yZQogICAgICAgICAgLy8gYW55IGFuaW1hdGlvbnMgYXJlIHRyaWdnZXJlZC4KICAgICAgICAgICRyb290U2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkcm9vdFNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByb290QW5pbWF0ZVN0YXRlLnJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICk7CgogICAgICB2YXIgZ2xvYmFsQW5pbWF0aW9uQ291bnRlciA9IDA7CiAgICAgIHZhciBjbGFzc05hbWVGaWx0ZXIgPSAkYW5pbWF0ZVByb3ZpZGVyLmNsYXNzTmFtZUZpbHRlcigpOwogICAgICB2YXIgaXNBbmltYXRhYmxlQ2xhc3NOYW1lID0gIWNsYXNzTmFtZUZpbHRlcgogICAgICAgICAgICAgID8gZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlOyB9CiAgICAgICAgICAgICAgOiBmdW5jdGlvbihjbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjbGFzc05hbWVGaWx0ZXIudGVzdChjbGFzc05hbWUpOwogICAgICAgICAgICAgIH07CgogICAgICBmdW5jdGlvbiBjbGFzc0Jhc2VkQW5pbWF0aW9uc0Jsb2NrZWQoZWxlbWVudCwgc2V0dGVyKSB7CiAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSkgfHwge307CiAgICAgICAgaWYgKHNldHRlcikgewogICAgICAgICAgZGF0YS5ydW5uaW5nID0gdHJ1ZTsKICAgICAgICAgIGRhdGEuc3RydWN0dXJhbCA9IHRydWU7CiAgICAgICAgICBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSwgZGF0YSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkYXRhLmRpc2FibGVkIHx8IChkYXRhLnJ1bm5pbmcgJiYgZGF0YS5zdHJ1Y3R1cmFsKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcnVuQW5pbWF0aW9uUG9zdERpZ2VzdChmbikgewogICAgICAgIHZhciBjYW5jZWxGbiwgZGVmZXIgPSAkJHEuZGVmZXIoKTsKICAgICAgICBkZWZlci5wcm9taXNlLiQkY2FuY2VsRm4gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGNhbmNlbEZuICYmIGNhbmNlbEZuKCk7CiAgICAgICAgfTsKICAgICAgICAkcm9vdFNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgIGNhbmNlbEZuID0gZm4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwYXJzZUFuaW1hdGVPcHRpb25zKG9wdGlvbnMpIHsKICAgICAgICAvLyBzb21lIHBsdWdpbiBjb2RlIG1heSBzdGlsbCBiZSBwYXNzaW5nIGluIHRoZSBjYWxsYmFjawogICAgICAgIC8vIGZ1bmN0aW9uIGFzIHRoZSBsYXN0IHBhcmFtIGZvciB0aGUgJGFuaW1hdGUgbWV0aG9kcyBzbwogICAgICAgIC8vIGl0J3MgYmVzdCB0byBvbmx5IGFsbG93IHN0cmluZyBvciBhcnJheSB2YWx1ZXMgZm9yIG5vdwogICAgICAgIGlmIChpc09iamVjdChvcHRpb25zKSkgewogICAgICAgICAgaWYgKG9wdGlvbnMudGVtcENsYXNzZXMgJiYgaXNTdHJpbmcob3B0aW9ucy50ZW1wQ2xhc3NlcykpIHsKICAgICAgICAgICAgb3B0aW9ucy50ZW1wQ2xhc3NlcyA9IG9wdGlvbnMudGVtcENsYXNzZXMuc3BsaXQoL1xzKy8pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG9wdGlvbnM7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiByZXNvbHZlRWxlbWVudENsYXNzZXMoZWxlbWVudCwgY2FjaGUsIHJ1bm5pbmdBbmltYXRpb25zKSB7CiAgICAgICAgcnVubmluZ0FuaW1hdGlvbnMgPSBydW5uaW5nQW5pbWF0aW9ucyB8fCB7fTsKCiAgICAgICAgdmFyIGxvb2t1cCA9IHt9OwogICAgICAgIGZvckVhY2gocnVubmluZ0FuaW1hdGlvbnMsIGZ1bmN0aW9uKGRhdGEsIHNlbGVjdG9yKSB7CiAgICAgICAgICBmb3JFYWNoKHNlbGVjdG9yLnNwbGl0KCcgJyksIGZ1bmN0aW9uKHMpIHsKICAgICAgICAgICAgbG9va3VwW3NdPWRhdGE7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgdmFyIGhhc0NsYXNzZXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIGZvckVhY2goKGVsZW1lbnQuYXR0cignY2xhc3MnKSB8fCAnJykuc3BsaXQoL1xzKy8pLCBmdW5jdGlvbihjbGFzc05hbWUpIHsKICAgICAgICAgIGhhc0NsYXNzZXNbY2xhc3NOYW1lXSA9IHRydWU7CiAgICAgICAgfSk7CgogICAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdOwogICAgICAgIGZvckVhY2goY2FjaGUuY2xhc3NlcywgZnVuY3Rpb24oc3RhdHVzLCBjbGFzc05hbWUpIHsKICAgICAgICAgIHZhciBoYXNDbGFzcyA9IGhhc0NsYXNzZXNbY2xhc3NOYW1lXTsKICAgICAgICAgIHZhciBtYXRjaGluZ0FuaW1hdGlvbiA9IGxvb2t1cFtjbGFzc05hbWVdIHx8IHt9OwoKICAgICAgICAgIC8vIFdoZW4gYWRkQ2xhc3MgYW5kIHJlbW92ZUNsYXNzIGlzIGNhbGxlZCB0aGVuICRhbmltYXRlIHdpbGwgY2hlY2sgdG8KICAgICAgICAgIC8vIHNlZSBpZiBhZGRDbGFzcyBhbmQgcmVtb3ZlQ2xhc3MgY2FuY2VsIGVhY2ggb3RoZXIgb3V0LiBXaGVuIHRoZXJlIGFyZQogICAgICAgICAgLy8gbW9yZSBjYWxscyB0byByZW1vdmVDbGFzcyB0aGFuIGFkZENsYXNzIHRoZW4gdGhlIGNvdW50IGZhbGxzIGJlbG93IDAKICAgICAgICAgIC8vIGFuZCB0aGVuIHRoZSByZW1vdmVDbGFzcyBhbmltYXRpb24gd2lsbCBiZSBhbGxvd2VkLiBPdGhlcndpc2UgaWYgdGhlCiAgICAgICAgICAvLyBjb3VudCBpcyBhYm92ZSAwIHRoZW4gdGhhdCBtZWFucyBhbiBhZGRDbGFzcyBhbmltYXRpb24gd2lsbCBjb21tZW5jZS4KICAgICAgICAgIC8vIE9uY2UgYW4gYW5pbWF0aW9uIGlzIGFsbG93ZWQgdGhlbiB0aGUgY29kZSB3aWxsIGFsc28gY2hlY2sgdG8gc2VlIGlmCiAgICAgICAgICAvLyB0aGVyZSBleGlzdHMgYW55IG9uLWdvaW5nIGFuaW1hdGlvbiB0aGF0IGlzIGFscmVhZHkgYWRkaW5nIG9yIHJlbXZvaW5nCiAgICAgICAgICAvLyB0aGUgbWF0Y2hpbmcgQ1NTIGNsYXNzLgogICAgICAgICAgaWYgKHN0YXR1cyA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgLy9kb2VzIGl0IGhhdmUgdGhlIGNsYXNzIG9yIHdpbGwgaXQgaGF2ZSB0aGUgY2xhc3MKICAgICAgICAgICAgaWYgKGhhc0NsYXNzIHx8IG1hdGNoaW5nQW5pbWF0aW9uLmV2ZW50ID09ICdhZGRDbGFzcycpIHsKICAgICAgICAgICAgICB0b1JlbW92ZS5wdXNoKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSB0cnVlKSB7CiAgICAgICAgICAgIC8vaXMgdGhlIGNsYXNzIG1pc3Npbmcgb3Igd2lsbCBpdCBiZSByZW1vdmVkPwogICAgICAgICAgICBpZiAoIWhhc0NsYXNzIHx8IG1hdGNoaW5nQW5pbWF0aW9uLmV2ZW50ID09ICdyZW1vdmVDbGFzcycpIHsKICAgICAgICAgICAgICB0b0FkZC5wdXNoKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuICh0b0FkZC5sZW5ndGggKyB0b1JlbW92ZS5sZW5ndGgpID4gMCAmJiBbdG9BZGQuam9pbignICcpLCB0b1JlbW92ZS5qb2luKCcgJyldOwogICAgICB9CgogICAgICBmdW5jdGlvbiBsb29rdXAobmFtZSkgewogICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICB2YXIgbWF0Y2hlcyA9IFtdLAogICAgICAgICAgICAgIGZsYWdNYXAgPSB7fSwKICAgICAgICAgICAgICBjbGFzc2VzID0gbmFtZS5zdWJzdHIoMSkuc3BsaXQoJy4nKTsKCiAgICAgICAgICAvL3RoZSBlbXB0eSBzdHJpbmcgdmFsdWUgaXMgdGhlIGRlZmF1bHQgYW5pbWF0aW9uCiAgICAgICAgICAvL29wZXJhdGlvbiB3aGljaCBwZXJmb3JtcyBDU1MgdHJhbnNpdGlvbiBhbmQga2V5ZnJhbWUKICAgICAgICAgIC8vYW5pbWF0aW9ucyBzbmlmZmluZy4gVGhpcyBpcyBhbHdheXMgaW5jbHVkZWQgZm9yIGVhY2gKICAgICAgICAgIC8vZWxlbWVudCBhbmltYXRpb24gcHJvY2VkdXJlIGlmIHRoZSBicm93c2VyIHN1cHBvcnRzCiAgICAgICAgICAvL3RyYW5zaXRpb25zIGFuZC9vciBrZXlmcmFtZSBhbmltYXRpb25zLiBUaGUgZGVmYXVsdAogICAgICAgICAgLy9hbmltYXRpb24gaXMgYWRkZWQgdG8gdGhlIHRvcCBvZiB0aGUgbGlzdCB0byBwcmV2ZW50CiAgICAgICAgICAvL2FueSBwcmV2aW91cyBhbmltYXRpb25zIGZyb20gYWZmZWN0aW5nIHRoZSBlbGVtZW50IHN0eWxpbmcKICAgICAgICAgIC8vcHJpb3IgdG8gdGhlIGVsZW1lbnQgYmVpbmcgYW5pbWF0ZWQuCiAgICAgICAgICBpZiAoJHNuaWZmZXIudHJhbnNpdGlvbnMgfHwgJHNuaWZmZXIuYW5pbWF0aW9ucykgewogICAgICAgICAgICBtYXRjaGVzLnB1c2goJGluamVjdG9yLmdldChzZWxlY3RvcnNbJyddKSk7CiAgICAgICAgICB9CgogICAgICAgICAgZm9yKHZhciBpPTA7IGkgPCBjbGFzc2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBrbGFzcyA9IGNsYXNzZXNbaV0sCiAgICAgICAgICAgICAgICBzZWxlY3RvckZhY3RvcnlOYW1lID0gc2VsZWN0b3JzW2tsYXNzXTsKICAgICAgICAgICAgaWYgKHNlbGVjdG9yRmFjdG9yeU5hbWUgJiYgIWZsYWdNYXBba2xhc3NdKSB7CiAgICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKCRpbmplY3Rvci5nZXQoc2VsZWN0b3JGYWN0b3J5TmFtZSkpOwogICAgICAgICAgICAgIGZsYWdNYXBba2xhc3NdID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoZXM7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBhbmltYXRpb25SdW5uZXIoZWxlbWVudCwgYW5pbWF0aW9uRXZlbnQsIGNsYXNzTmFtZSwgb3B0aW9ucykgewogICAgICAgIC8vdHJhbnNjbHVkZWQgZGlyZWN0aXZlcyBtYXkgc29tZXRpbWVzIGZpcmUgYW4gYW5pbWF0aW9uIHVzaW5nIG9ubHkgY29tbWVudCBub2RlcwogICAgICAgIC8vYmVzdCB0byBjYXRjaCB0aGlzIGVhcmx5IG9uIHRvIHByZXZlbnQgYW55IGFuaW1hdGlvbiBvcGVyYXRpb25zIGZyb20gb2NjdXJyaW5nCiAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50WzBdOwogICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKG9wdGlvbnMpIHsKICAgICAgICAgIG9wdGlvbnMudG8gPSBvcHRpb25zLnRvIHx8IHt9OwogICAgICAgICAgb3B0aW9ucy5mcm9tID0gb3B0aW9ucy5mcm9tIHx8IHt9OwogICAgICAgIH0KCiAgICAgICAgdmFyIGNsYXNzTmFtZUFkZDsKICAgICAgICB2YXIgY2xhc3NOYW1lUmVtb3ZlOwogICAgICAgIGlmIChpc0FycmF5KGNsYXNzTmFtZSkpIHsKICAgICAgICAgIGNsYXNzTmFtZUFkZCA9IGNsYXNzTmFtZVswXTsKICAgICAgICAgIGNsYXNzTmFtZVJlbW92ZSA9IGNsYXNzTmFtZVsxXTsKICAgICAgICAgIGlmICghY2xhc3NOYW1lQWRkKSB7CiAgICAgICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZVJlbW92ZTsKICAgICAgICAgICAgYW5pbWF0aW9uRXZlbnQgPSAncmVtb3ZlQ2xhc3MnOwogICAgICAgICAgfSBlbHNlIGlmICghY2xhc3NOYW1lUmVtb3ZlKSB7CiAgICAgICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZUFkZDsKICAgICAgICAgICAgYW5pbWF0aW9uRXZlbnQgPSAnYWRkQ2xhc3MnOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lQWRkICsgJyAnICsgY2xhc3NOYW1lUmVtb3ZlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGlzU2V0Q2xhc3NPcGVyYXRpb24gPSBhbmltYXRpb25FdmVudCA9PSAnc2V0Q2xhc3MnOwogICAgICAgIHZhciBpc0NsYXNzQmFzZWQgPSBpc1NldENsYXNzT3BlcmF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHx8IGFuaW1hdGlvbkV2ZW50ID09ICdhZGRDbGFzcycKICAgICAgICAgICAgICAgICAgICAgICAgICAgfHwgYW5pbWF0aW9uRXZlbnQgPT0gJ3JlbW92ZUNsYXNzJwogICAgICAgICAgICAgICAgICAgICAgICAgICB8fCBhbmltYXRpb25FdmVudCA9PSAnYW5pbWF0ZSc7CgogICAgICAgIHZhciBjdXJyZW50Q2xhc3NOYW1lID0gZWxlbWVudC5hdHRyKCdjbGFzcycpOwogICAgICAgIHZhciBjbGFzc2VzID0gY3VycmVudENsYXNzTmFtZSArICcgJyArIGNsYXNzTmFtZTsKICAgICAgICBpZiAoIWlzQW5pbWF0YWJsZUNsYXNzTmFtZShjbGFzc2VzKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGJlZm9yZUNvbXBsZXRlID0gbm9vcCwKICAgICAgICAgICAgYmVmb3JlQ2FuY2VsID0gW10sCiAgICAgICAgICAgIGJlZm9yZSA9IFtdLAogICAgICAgICAgICBhZnRlckNvbXBsZXRlID0gbm9vcCwKICAgICAgICAgICAgYWZ0ZXJDYW5jZWwgPSBbXSwKICAgICAgICAgICAgYWZ0ZXIgPSBbXTsKCiAgICAgICAgdmFyIGFuaW1hdGlvbkxvb2t1cCA9ICgnICcgKyBjbGFzc2VzKS5yZXBsYWNlKC9ccysvZywnLicpOwogICAgICAgIGZvckVhY2gobG9va3VwKGFuaW1hdGlvbkxvb2t1cCksIGZ1bmN0aW9uKGFuaW1hdGlvbkZhY3RvcnkpIHsKICAgICAgICAgIHZhciBjcmVhdGVkID0gcmVnaXN0ZXJBbmltYXRpb24oYW5pbWF0aW9uRmFjdG9yeSwgYW5pbWF0aW9uRXZlbnQpOwogICAgICAgICAgaWYgKCFjcmVhdGVkICYmIGlzU2V0Q2xhc3NPcGVyYXRpb24pIHsKICAgICAgICAgICAgcmVnaXN0ZXJBbmltYXRpb24oYW5pbWF0aW9uRmFjdG9yeSwgJ2FkZENsYXNzJyk7CiAgICAgICAgICAgIHJlZ2lzdGVyQW5pbWF0aW9uKGFuaW1hdGlvbkZhY3RvcnksICdyZW1vdmVDbGFzcycpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBmdW5jdGlvbiByZWdpc3RlckFuaW1hdGlvbihhbmltYXRpb25GYWN0b3J5LCBldmVudCkgewogICAgICAgICAgdmFyIGFmdGVyRm4gPSBhbmltYXRpb25GYWN0b3J5W2V2ZW50XTsKICAgICAgICAgIHZhciBiZWZvcmVGbiA9IGFuaW1hdGlvbkZhY3RvcnlbJ2JlZm9yZScgKyBldmVudC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGV2ZW50LnN1YnN0cigxKV07CiAgICAgICAgICBpZiAoYWZ0ZXJGbiB8fCBiZWZvcmVGbikgewogICAgICAgICAgICBpZiAoZXZlbnQgPT0gJ2xlYXZlJykgewogICAgICAgICAgICAgIGJlZm9yZUZuID0gYWZ0ZXJGbjsKICAgICAgICAgICAgICAvL3doZW4gc2V0IGFzIG51bGwgdGhlbiBhbmltYXRpb24ga25vd3MgdG8gc2tpcCB0aGlzIHBoYXNlCiAgICAgICAgICAgICAgYWZ0ZXJGbiA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWZ0ZXIucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQgOiBldmVudCwgZm4gOiBhZnRlckZuCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBiZWZvcmUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQgOiBldmVudCwgZm4gOiBiZWZvcmVGbgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBydW4oZm5zLCBjYW5jZWxsYXRpb25zLCBhbGxDb21wbGV0ZUZuKSB7CiAgICAgICAgICB2YXIgYW5pbWF0aW9ucyA9IFtdOwogICAgICAgICAgZm9yRWFjaChmbnMsIGZ1bmN0aW9uKGFuaW1hdGlvbikgewogICAgICAgICAgICBhbmltYXRpb24uZm4gJiYgYW5pbWF0aW9ucy5wdXNoKGFuaW1hdGlvbik7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB2YXIgY291bnQgPSAwOwogICAgICAgICAgZnVuY3Rpb24gYWZ0ZXJBbmltYXRpb25Db21wbGV0ZShpbmRleCkgewogICAgICAgICAgICBpZiAoY2FuY2VsbGF0aW9ucykgewogICAgICAgICAgICAgIChjYW5jZWxsYXRpb25zW2luZGV4XSB8fCBub29wKSgpOwogICAgICAgICAgICAgIGlmICgrK2NvdW50IDwgYW5pbWF0aW9ucy5sZW5ndGgpIHJldHVybjsKICAgICAgICAgICAgICBjYW5jZWxsYXRpb25zID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBhbGxDb21wbGV0ZUZuKCk7CiAgICAgICAgICB9CgogICAgICAgICAgLy9UaGUgY29kZSBiZWxvdyBhZGRzIGRpcmVjdGx5IHRvIHRoZSBhcnJheSBpbiBvcmRlciB0byB3b3JrIHdpdGgKICAgICAgICAgIC8vYm90aCBzeW5jIGFuZCBhc3luYyBhbmltYXRpb25zLiBTeW5jIGFuaW1hdGlvbnMgYXJlIHdoZW4gdGhlIGRvbmUoKQogICAgICAgICAgLy9vcGVyYXRpb24gaXMgY2FsbGVkIHJpZ2h0IGF3YXkuIERPIE5PVCBSRUZBQ1RPUiEKICAgICAgICAgIGZvckVhY2goYW5pbWF0aW9ucywgZnVuY3Rpb24oYW5pbWF0aW9uLCBpbmRleCkgewogICAgICAgICAgICB2YXIgcHJvZ3Jlc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBhZnRlckFuaW1hdGlvbkNvbXBsZXRlKGluZGV4KTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgc3dpdGNoKGFuaW1hdGlvbi5ldmVudCkgewogICAgICAgICAgICAgIGNhc2UgJ3NldENsYXNzJzoKICAgICAgICAgICAgICAgIGNhbmNlbGxhdGlvbnMucHVzaChhbmltYXRpb24uZm4oZWxlbWVudCwgY2xhc3NOYW1lQWRkLCBjbGFzc05hbWVSZW1vdmUsIHByb2dyZXNzLCBvcHRpb25zKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdhbmltYXRlJzoKICAgICAgICAgICAgICAgIGNhbmNlbGxhdGlvbnMucHVzaChhbmltYXRpb24uZm4oZWxlbWVudCwgY2xhc3NOYW1lLCBvcHRpb25zLmZyb20sIG9wdGlvbnMudG8sIHByb2dyZXNzKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdhZGRDbGFzcyc6CiAgICAgICAgICAgICAgICBjYW5jZWxsYXRpb25zLnB1c2goYW5pbWF0aW9uLmZuKGVsZW1lbnQsIGNsYXNzTmFtZUFkZCB8fCBjbGFzc05hbWUsICAgICBwcm9ncmVzcywgb3B0aW9ucykpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAncmVtb3ZlQ2xhc3MnOgogICAgICAgICAgICAgICAgY2FuY2VsbGF0aW9ucy5wdXNoKGFuaW1hdGlvbi5mbihlbGVtZW50LCBjbGFzc05hbWVSZW1vdmUgfHwgY2xhc3NOYW1lLCAgcHJvZ3Jlc3MsIG9wdGlvbnMpKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBjYW5jZWxsYXRpb25zLnB1c2goYW5pbWF0aW9uLmZuKGVsZW1lbnQsIHByb2dyZXNzLCBvcHRpb25zKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgaWYgKGNhbmNlbGxhdGlvbnMgJiYgY2FuY2VsbGF0aW9ucy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgYWxsQ29tcGxldGVGbigpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIG5vZGUgOiBub2RlLAogICAgICAgICAgZXZlbnQgOiBhbmltYXRpb25FdmVudCwKICAgICAgICAgIGNsYXNzTmFtZSA6IGNsYXNzTmFtZSwKICAgICAgICAgIGlzQ2xhc3NCYXNlZCA6IGlzQ2xhc3NCYXNlZCwKICAgICAgICAgIGlzU2V0Q2xhc3NPcGVyYXRpb24gOiBpc1NldENsYXNzT3BlcmF0aW9uLAogICAgICAgICAgYXBwbHlTdHlsZXMgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMpIHsKICAgICAgICAgICAgICBlbGVtZW50LmNzcyhhbmd1bGFyLmV4dGVuZChvcHRpb25zLmZyb20gfHwge30sIG9wdGlvbnMudG8gfHwge30pKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGJlZm9yZSA6IGZ1bmN0aW9uKGFsbENvbXBsZXRlRm4pIHsKICAgICAgICAgICAgYmVmb3JlQ29tcGxldGUgPSBhbGxDb21wbGV0ZUZuOwogICAgICAgICAgICBydW4oYmVmb3JlLCBiZWZvcmVDYW5jZWwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGJlZm9yZUNvbXBsZXRlID0gbm9vcDsKICAgICAgICAgICAgICBhbGxDb21wbGV0ZUZuKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIGFmdGVyIDogZnVuY3Rpb24oYWxsQ29tcGxldGVGbikgewogICAgICAgICAgICBhZnRlckNvbXBsZXRlID0gYWxsQ29tcGxldGVGbjsKICAgICAgICAgICAgcnVuKGFmdGVyLCBhZnRlckNhbmNlbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgYWZ0ZXJDb21wbGV0ZSA9IG5vb3A7CiAgICAgICAgICAgICAgYWxsQ29tcGxldGVGbigpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBjYW5jZWwgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGJlZm9yZUNhbmNlbCkgewogICAgICAgICAgICAgIGZvckVhY2goYmVmb3JlQ2FuY2VsLCBmdW5jdGlvbihjYW5jZWxGbikgewogICAgICAgICAgICAgICAgKGNhbmNlbEZuIHx8IG5vb3ApKHRydWUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGJlZm9yZUNvbXBsZXRlKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhZnRlckNhbmNlbCkgewogICAgICAgICAgICAgIGZvckVhY2goYWZ0ZXJDYW5jZWwsIGZ1bmN0aW9uKGNhbmNlbEZuKSB7CiAgICAgICAgICAgICAgICAoY2FuY2VsRm4gfHwgbm9vcCkodHJ1ZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgYWZ0ZXJDb21wbGV0ZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICAgKiBAbmFtZSAkYW5pbWF0ZQogICAgICAgKiBAa2luZCBvYmplY3QKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFRoZSBgJGFuaW1hdGVgIHNlcnZpY2UgcHJvdmlkZXMgYW5pbWF0aW9uIGRldGVjdGlvbiBzdXBwb3J0IHdoaWxlIHBlcmZvcm1pbmcgRE9NIG9wZXJhdGlvbnMgKGVudGVyLCBsZWF2ZSBhbmQgbW92ZSkgYXMgd2VsbCBhcyBkdXJpbmcgYWRkQ2xhc3MgYW5kIHJlbW92ZUNsYXNzIG9wZXJhdGlvbnMuCiAgICAgICAqIFdoZW4gYW55IG9mIHRoZXNlIG9wZXJhdGlvbnMgYXJlIHJ1biwgdGhlICRhbmltYXRlIHNlcnZpY2UKICAgICAgICogd2lsbCBleGFtaW5lIGFueSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyAod2hpY2ggYXJlIGRlZmluZWQgYnkgdXNpbmcgdGhlICRhbmltYXRlUHJvdmlkZXIgcHJvdmlkZXIgb2JqZWN0KQogICAgICAgKiBhcyB3ZWxsIGFzIGFueSBDU1MtZGVmaW5lZCBhbmltYXRpb25zIGFnYWluc3QgdGhlIENTUyBjbGFzc2VzIHByZXNlbnQgb24gdGhlIGVsZW1lbnQgb25jZSB0aGUgRE9NIG9wZXJhdGlvbiBpcyBydW4uCiAgICAgICAqCiAgICAgICAqIFRoZSBgJGFuaW1hdGVgIHNlcnZpY2UgaXMgdXNlZCBiZWhpbmQgdGhlIHNjZW5lcyB3aXRoIHByZS1leGlzdGluZyBkaXJlY3RpdmVzIGFuZCBhbmltYXRpb24gd2l0aCB0aGVzZSBkaXJlY3RpdmVzCiAgICAgICAqIHdpbGwgd29yayBvdXQgb2YgdGhlIGJveCB3aXRob3V0IGFueSBleHRyYSBjb25maWd1cmF0aW9uLgogICAgICAgKgogICAgICAgKiBSZXF1aXJlcyB0aGUge0BsaW5rIG5nQW5pbWF0ZSBgbmdBbmltYXRlYH0gbW9kdWxlIHRvIGJlIGluc3RhbGxlZC4KICAgICAgICoKICAgICAgICogUGxlYXNlIHZpc2l0IHRoZSB7QGxpbmsgbmdBbmltYXRlIGBuZ0FuaW1hdGVgfSBtb2R1bGUgb3ZlcnZpZXcgcGFnZSBsZWFybiBtb3JlIGFib3V0IGhvdyB0byB1c2UgYW5pbWF0aW9ucyBpbiB5b3VyIGFwcGxpY2F0aW9uLgogICAgICAgKiAjIyBDYWxsYmFjayBQcm9taXNlcwogICAgICAgKiBXaXRoIEFuZ3VsYXJKUyAxLjMsIGVhY2ggb2YgdGhlIGFuaW1hdGlvbiBtZXRob2RzLCBvbiB0aGUgYCRhbmltYXRlYCBzZXJ2aWNlLCByZXR1cm4gYSBwcm9taXNlIHdoZW4gY2FsbGVkLiBUaGUKICAgICAgICogcHJvbWlzZSBpdHNlbGYgaXMgdGhlbiByZXNvbHZlZCBvbmNlIHRoZSBhbmltYXRpb24gaGFzIGNvbXBsZXRlZCBpdHNlbGYsIGhhcyBiZWVuIGNhbmNlbGxlZCBvciBoYXMgYmVlbgogICAgICAgKiBza2lwcGVkIGR1ZSB0byBhbmltYXRpb25zIGJlaW5nIGRpc2FibGVkLiAoTm90ZSB0aGF0IGV2ZW4gaWYgdGhlIGFuaW1hdGlvbiBpcyBjYW5jZWxsZWQgaXQgd2lsbCBzdGlsbAogICAgICAgKiBjYWxsIHRoZSByZXNvbHZlIGZ1bmN0aW9uIG9mIHRoZSBhbmltYXRpb24uKQogICAgICAgKgogICAgICAgKiBgYGBqcwogICAgICAgKiAkYW5pbWF0ZS5lbnRlcihlbGVtZW50LCBjb250YWluZXIpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAqICAgLy8uLi50aGlzIGlzIGNhbGxlZCBvbmNlIHRoZSBhbmltYXRpb24gaXMgY29tcGxldGUuLi4KICAgICAgICogfSk7CiAgICAgICAqIGBgYAogICAgICAgKgogICAgICAgKiBBbHNvIG5vdGUgdGhhdCwgZHVlIHRvIHRoZSBuYXR1cmUgb2YgdGhlIGNhbGxiYWNrIHByb21pc2UsIGlmIGFueSBBbmd1bGFyLXNwZWNpZmljIGNvZGUgKGxpa2UgY2hhbmdpbmcgdGhlIHNjb3BlLAogICAgICAgKiBsb2NhdGlvbiBvZiB0aGUgcGFnZSwgZXRjLi4uKSBpcyBleGVjdXRlZCB3aXRoaW4gdGhlIGNhbGxiYWNrIHByb21pc2UgdGhlbiBiZSBzdXJlIHRvIHdyYXAgdGhlIGNvZGUgdXNpbmcKICAgICAgICogYCRzY29wZS4kYXBwbHkoLi4uKWA7CiAgICAgICAqCiAgICAgICAqIGBgYGpzCiAgICAgICAqICRhbmltYXRlLmxlYXZlKGVsZW1lbnQpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAqICAgJHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICogICAgICRsb2NhdGlvbi5wYXRoKCcvbmV3LXBhZ2UnKTsKICAgICAgICogICB9KTsKICAgICAgICogfSk7CiAgICAgICAqIGBgYAogICAgICAgKgogICAgICAgKiBBbiBhbmltYXRpb24gY2FuIGFsc28gYmUgY2FuY2VsbGVkIGJ5IGNhbGxpbmcgdGhlIGAkYW5pbWF0ZS5jYW5jZWwocHJvbWlzZSlgIG1ldGhvZCB3aXRoIHRoZSBwcm92aWRlZAogICAgICAgKiBwcm9taXNlIHRoYXQgd2FzIHJldHVybmVkIHdoZW4gdGhlIGFuaW1hdGlvbiB3YXMgc3RhcnRlZC4KICAgICAgICoKICAgICAgICogYGBganMKICAgICAgICogdmFyIHByb21pc2UgPSAkYW5pbWF0ZS5hZGRDbGFzcyhlbGVtZW50LCAnc3VwZXItbG9uZy1hbmltYXRpb24nKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgKiAgIC8vdGhpcyB3aWxsIHN0aWxsIGJlIGNhbGxlZCBldmVuIGlmIGNhbmNlbGxlZAogICAgICAgKiB9KTsKICAgICAgICoKICAgICAgICogZWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICogICAvL3Rvb28gbGF6eSB0byB3YWl0IGZvciB0aGUgYW5pbWF0aW9uIHRvIGVuZAogICAgICAgKiAgICRhbmltYXRlLmNhbmNlbChwcm9taXNlKTsKICAgICAgICogfSk7CiAgICAgICAqIGBgYAogICAgICAgKgogICAgICAgKiAoS2VlcCBpbiBtaW5kIHRoYXQgdGhlIHByb21pc2UgY2FuY2VsbGF0aW9uIGlzIHVuaXF1ZSB0byBgJGFuaW1hdGVgIHNpbmNlIHByb21pc2VzIGluCiAgICAgICAqIGdlbmVyYWwgY2Fubm90IGJlIGNhbmNlbGxlZC4pCiAgICAgICAqCiAgICAgICAqLwogICAgICByZXR1cm4gewogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNhbmltYXRlCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFBlcmZvcm1zIGFuIGlubGluZSBhbmltYXRpb24gb24gdGhlIGVsZW1lbnQgd2hpY2ggYXBwbGllcyB0aGUgcHJvdmlkZWQgYHRvYCBhbmQgYGZyb21gIENTUyBzdHlsZXMgdG8gdGhlIGVsZW1lbnQuCiAgICAgICAgICogSWYgYW55IGRldGVjdGVkIENTUyB0cmFuc2l0aW9uLCBrZXlmcmFtZSBvciBKYXZhU2NyaXB0IG1hdGNoZXMgdGhlIHByb3ZpZGVkIGBjbGFzc05hbWVgIHZhbHVlIHRoZW4gdGhlIGFuaW1hdGlvbgogICAgICAgICAqIHdpbGwgdGFrZSBvbiB0aGUgcHJvdmlkZWQgc3R5bGVzLiBGb3IgZXhhbXBsZSwgaWYgYSB0cmFuc2l0aW9uIGFuaW1hdGlvbiBpcyBzZXQgZm9yIHRoZSBnaXZlbiBjbGFzc05hbWUgdGhlbiB0aGUKICAgICAgICAgKiBwcm92aWRlZCBgZnJvbWAgYW5kIGB0b2Agc3R5bGVzIHdpbGwgYmUgYXBwbGllZCBhbG9uZ3NpZGUgdGhlIGdpdmVuIHRyYW5zaXRpb24uIElmIGEgSmF2YVNjcmlwdCBhbmltYXRpb24gaXMKICAgICAgICAgKiBkZXRlY3RlZCB0aGVuIHRoZSBwcm92aWRlZCBzdHlsZXMgd2lsbCBiZSBnaXZlbiBpbiBhcyBmdW5jdGlvbiBwYXJhbXRlcnMuCiAgICAgICAgICoKICAgICAgICAgKiBgYGBqcwogICAgICAgICAqIG5nTW9kdWxlLmFuaW1hdGlvbignLm15LWlubGluZS1hbmltYXRpb24nLCBmdW5jdGlvbigpIHsKICAgICAgICAgKiAgIHJldHVybiB7CiAgICAgICAgICogICAgIGFuaW1hdGUgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGZyb20sIHRvLCBkb25lKSB7CiAgICAgICAgICogICAgICAgLy9zdHlsZXMKICAgICAgICAgKiAgICAgfQogICAgICAgICAqICAgfQogICAgICAgICAqIH0pOwogICAgICAgICAqIGBgYAogICAgICAgICAqCiAgICAgICAgICogQmVsb3cgaXMgYSBicmVha2Rvd24gb2YgZWFjaCBzdGVwIHRoYXQgb2NjdXJzIGR1cmluZyB0aGUgYGFuaW1hdGVgIGFuaW1hdGlvbjoKICAgICAgICAgKgogICAgICAgICAqIHwgQW5pbWF0aW9uIFN0ZXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBXaGF0IHRoZSBlbGVtZW50IGNsYXNzIGF0dHJpYnV0ZSBsb29rcyBsaWtlICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgICAgICogfCAxLiAkYW5pbWF0ZS5hbmltYXRlKC4uLikgaXMgY2FsbGVkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMi4gJGFuaW1hdGUgd2FpdHMgZm9yIHRoZSBuZXh0IGRpZ2VzdCB0byBzdGFydCB0aGUgYW5pbWF0aW9uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUiICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDMuICRhbmltYXRlIHJ1bnMgdGhlIEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zIGRldGVjdGVkIG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIiAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA0LiB0aGUgY2xhc3NOYW1lIGNsYXNzIHZhbHVlIGlzIGFkZGVkIHRvIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBjbGFzc05hbWUiICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNS4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgY2xhc3NOYW1lIiAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDYuICRhbmltYXRlIGJsb2NrcyBhbGwgQ1NTIHRyYW5zaXRpb25zIG9uIHRoZSBlbGVtZW50IHRvIGVuc3VyZSB0aGUgLmNsYXNzTmFtZSBjbGFzcyBzdHlsaW5nIGlzIGFwcGxpZWQgcmlnaHQgYXdheXwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIGNsYXNzTmFtZSIgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA3LiAkYW5pbWF0ZSBhcHBsaWVzIHRoZSBwcm92aWRlZCBjb2xsZWN0aW9uIG9mIGBmcm9tYCBDU1Mgc3R5bGVzIHRvIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBjbGFzc05hbWUiICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgOC4gJGFuaW1hdGUgd2FpdHMgZm9yIGEgc2luZ2xlIGFuaW1hdGlvbiBmcmFtZSAodGhpcyBwZXJmb3JtcyBhIHJlZmxvdykgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgY2xhc3NOYW1lIiAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDkuICRhbmltYXRlIHJlbW92ZXMgdGhlIENTUyB0cmFuc2l0aW9uIGJsb2NrIHBsYWNlZCBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIGNsYXNzTmFtZSIgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAxMC4gdGhlIGNsYXNzTmFtZS1hY3RpdmUgY2xhc3MgaXMgYWRkZWQgKHRoaXMgdHJpZ2dlcnMgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbikgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBjbGFzc05hbWUgY2xhc3NOYW1lLWFjdGl2ZSIgfAogICAgICAgICAqIHwgMTEuICRhbmltYXRlIGFwcGxpZXMgdGhlIGNvbGxlY3Rpb24gb2YgYHRvYCBDU1Mgc3R5bGVzIHRvIHRoZSBlbGVtZW50IHdoaWNoIGFyZSB0aGVuIGhhbmRsZWQgYnkgdGhlIHRyYW5zaXRpb24gICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgY2xhc3NOYW1lIGNsYXNzTmFtZS1hY3RpdmUiIHwKICAgICAgICAgKiB8IDEyLiAkYW5pbWF0ZSB3YWl0cyBmb3IgdGhlIGFuaW1hdGlvbiB0byBjb21wbGV0ZSAodmlhIGV2ZW50cyBhbmQgdGltZW91dCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIGNsYXNzTmFtZSBjbGFzc05hbWUtYWN0aXZlIiB8CiAgICAgICAgICogfCAxMy4gVGhlIGFuaW1hdGlvbiBlbmRzIGFuZCBhbGwgZ2VuZXJhdGVkIENTUyBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMTQuIFRoZSByZXR1cm5lZCBwcm9taXNlIGlzIHJlc29sdmVkLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgdGhlIGZvY3VzIG9mIHRoZSBlbnRlciBhbmltYXRpb24KICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gZnJvbSBhIGNvbGxlY3Rpb24gb2YgQ1NTIHN0eWxlcyB0aGF0IHdpbGwgYmUgYXBwbGllZCB0byB0aGUgZWxlbWVudCBhdCB0aGUgc3RhcnQgb2YgdGhlIGFuaW1hdGlvbgogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSB0byBhIGNvbGxlY3Rpb24gb2YgQ1NTIHN0eWxlcyB0aGF0IHRoZSBlbGVtZW50IHdpbGwgYW5pbWF0ZSB0b3dhcmRzCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBjbGFzc05hbWUgYW4gb3B0aW9uYWwgQ1NTIGNsYXNzIHRoYXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudCBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSBhbmltYXRpb24gKHRoZSBkZWZhdWx0IGNsYXNzIGlzIGBuZy1pbmxpbmUtYW5pbWF0ZWApCiAgICAgICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIGFuIG9wdGlvbmFsIGNvbGxlY3Rpb24gb2Ygb3B0aW9ucyB0aGF0IHdpbGwgYmUgcGlja2VkIHVwIGJ5IHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24KICAgICAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSB0aGUgYW5pbWF0aW9uIGNhbGxiYWNrIHByb21pc2UKICAgICAgICAqLwogICAgICAgIGFuaW1hdGUgOiBmdW5jdGlvbihlbGVtZW50LCBmcm9tLCB0bywgY2xhc3NOYW1lLCBvcHRpb25zKSB7CiAgICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ25nLWlubGluZS1hbmltYXRlJzsKICAgICAgICAgIG9wdGlvbnMgPSBwYXJzZUFuaW1hdGVPcHRpb25zKG9wdGlvbnMpIHx8IHt9OwogICAgICAgICAgb3B0aW9ucy5mcm9tID0gdG8gPyBmcm9tIDogbnVsbDsKICAgICAgICAgIG9wdGlvbnMudG8gICA9IHRvID8gdG8gOiBmcm9tOwoKICAgICAgICAgIHJldHVybiBydW5BbmltYXRpb25Qb3N0RGlnZXN0KGZ1bmN0aW9uKGRvbmUpIHsKICAgICAgICAgICAgcmV0dXJuIHBlcmZvcm1BbmltYXRpb24oJ2FuaW1hdGUnLCBjbGFzc05hbWUsIHN0cmlwQ29tbWVudHNGcm9tRWxlbWVudChlbGVtZW50KSwgbnVsbCwgbnVsbCwgbm9vcCwgb3B0aW9ucywgZG9uZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjZW50ZXIKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQXBwZW5kcyB0aGUgZWxlbWVudCB0byB0aGUgcGFyZW50RWxlbWVudCBlbGVtZW50IHRoYXQgcmVzaWRlcyBpbiB0aGUgZG9jdW1lbnQgYW5kIHRoZW4gcnVucyB0aGUgZW50ZXIgYW5pbWF0aW9uLiBPbmNlCiAgICAgICAgICogdGhlIGFuaW1hdGlvbiBpcyBzdGFydGVkLCB0aGUgZm9sbG93aW5nIENTUyBjbGFzc2VzIHdpbGwgYmUgcHJlc2VudCBvbiB0aGUgZWxlbWVudCBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSBhbmltYXRpb246CiAgICAgICAgICoKICAgICAgICAgKiBCZWxvdyBpcyBhIGJyZWFrZG93biBvZiBlYWNoIHN0ZXAgdGhhdCBvY2N1cnMgZHVyaW5nIGVudGVyIGFuaW1hdGlvbjoKICAgICAgICAgKgogICAgICAgICAqIHwgQW5pbWF0aW9uIFN0ZXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBXaGF0IHRoZSBlbGVtZW50IGNsYXNzIGF0dHJpYnV0ZSBsb29rcyBsaWtlICAgICAgICAgICAgICB8CiAgICAgICAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAgICAgKiB8IDEuICRhbmltYXRlLmVudGVyKC4uLikgaXMgY2FsbGVkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMi4gZWxlbWVudCBpcyBpbnNlcnRlZCBpbnRvIHRoZSBwYXJlbnRFbGVtZW50IGVsZW1lbnQgb3IgYmVzaWRlIHRoZSBhZnRlckVsZW1lbnQgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAzLiAkYW5pbWF0ZSB3YWl0cyBmb3IgdGhlIG5leHQgZGlnZXN0IHRvIHN0YXJ0IHRoZSBhbmltYXRpb24gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSIgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDQuICRhbmltYXRlIHJ1bnMgdGhlIEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zIGRldGVjdGVkIG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIiAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNS4gdGhlIC5uZy1lbnRlciBjbGFzcyBpcyBhZGRlZCB0byB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctZW50ZXIiICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA2LiAkYW5pbWF0ZSBzY2FucyB0aGUgZWxlbWVudCBzdHlsZXMgdG8gZ2V0IHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24gZHVyYXRpb24gYW5kIGRlbGF5ICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1lbnRlciIgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDcuICRhbmltYXRlIGJsb2NrcyBhbGwgQ1NTIHRyYW5zaXRpb25zIG9uIHRoZSBlbGVtZW50IHRvIGVuc3VyZSB0aGUgLm5nLWVudGVyIGNsYXNzIHN0eWxpbmcgaXMgYXBwbGllZCByaWdodCBhd2F5IHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWVudGVyIiAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgOC4gJGFuaW1hdGUgd2FpdHMgZm9yIGEgc2luZ2xlIGFuaW1hdGlvbiBmcmFtZSAodGhpcyBwZXJmb3JtcyBhIHJlZmxvdykgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctZW50ZXIiICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA5LiAkYW5pbWF0ZSByZW1vdmVzIHRoZSBDU1MgdHJhbnNpdGlvbiBibG9jayBwbGFjZWQgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1lbnRlciIgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDEwLiB0aGUgLm5nLWVudGVyLWFjdGl2ZSBjbGFzcyBpcyBhZGRlZCAodGhpcyB0cmlnZ2VycyB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWVudGVyIG5nLWVudGVyLWFjdGl2ZSIgfAogICAgICAgICAqIHwgMTEuICRhbmltYXRlIHdhaXRzIGZvciB0aGUgYW5pbWF0aW9uIHRvIGNvbXBsZXRlICh2aWEgZXZlbnRzIGFuZCB0aW1lb3V0KSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctZW50ZXIgbmctZW50ZXItYWN0aXZlIiB8CiAgICAgICAgICogfCAxMi4gVGhlIGFuaW1hdGlvbiBlbmRzIGFuZCBhbGwgZ2VuZXJhdGVkIENTUyBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDEzLiBUaGUgcmV0dXJuZWQgcHJvbWlzZSBpcyByZXNvbHZlZC4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIGVudGVyIGFuaW1hdGlvbgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gcGFyZW50RWxlbWVudCB0aGUgcGFyZW50IGVsZW1lbnQgb2YgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgZW50ZXIgYW5pbWF0aW9uCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBhZnRlckVsZW1lbnQgdGhlIHNpYmxpbmcgZWxlbWVudCAod2hpY2ggaXMgdGhlIHByZXZpb3VzIGVsZW1lbnQpIG9mIHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIGVudGVyIGFuaW1hdGlvbgogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBhbiBvcHRpb25hbCBjb2xsZWN0aW9uIG9mIG9wdGlvbnMgdGhhdCB3aWxsIGJlIHBpY2tlZCB1cCBieSB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uCiAgICAgICAgICogQHJldHVybiB7UHJvbWlzZX0gdGhlIGFuaW1hdGlvbiBjYWxsYmFjayBwcm9taXNlCiAgICAgICAgKi8KICAgICAgICBlbnRlciA6IGZ1bmN0aW9uKGVsZW1lbnQsIHBhcmVudEVsZW1lbnQsIGFmdGVyRWxlbWVudCwgb3B0aW9ucykgewogICAgICAgICAgb3B0aW9ucyA9IHBhcnNlQW5pbWF0ZU9wdGlvbnMob3B0aW9ucyk7CiAgICAgICAgICBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgcGFyZW50RWxlbWVudCA9IHByZXBhcmVFbGVtZW50KHBhcmVudEVsZW1lbnQpOwogICAgICAgICAgYWZ0ZXJFbGVtZW50ID0gcHJlcGFyZUVsZW1lbnQoYWZ0ZXJFbGVtZW50KTsKCiAgICAgICAgICBjbGFzc0Jhc2VkQW5pbWF0aW9uc0Jsb2NrZWQoZWxlbWVudCwgdHJ1ZSk7CiAgICAgICAgICAkZGVsZWdhdGUuZW50ZXIoZWxlbWVudCwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50KTsKICAgICAgICAgIHJldHVybiBydW5BbmltYXRpb25Qb3N0RGlnZXN0KGZ1bmN0aW9uKGRvbmUpIHsKICAgICAgICAgICAgcmV0dXJuIHBlcmZvcm1BbmltYXRpb24oJ2VudGVyJywgJ25nLWVudGVyJywgc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpLCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQsIG5vb3AsIG9wdGlvbnMsIGRvbmUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI2xlYXZlCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJ1bnMgdGhlIGxlYXZlIGFuaW1hdGlvbiBvcGVyYXRpb24gYW5kLCB1cG9uIGNvbXBsZXRpb24sIHJlbW92ZXMgdGhlIGVsZW1lbnQgZnJvbSB0aGUgRE9NLiBPbmNlCiAgICAgICAgICogdGhlIGFuaW1hdGlvbiBpcyBzdGFydGVkLCB0aGUgZm9sbG93aW5nIENTUyBjbGFzc2VzIHdpbGwgYmUgYWRkZWQgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogQmVsb3cgaXMgYSBicmVha2Rvd24gb2YgZWFjaCBzdGVwIHRoYXQgb2NjdXJzIGR1cmluZyBsZWF2ZSBhbmltYXRpb246CiAgICAgICAgICoKICAgICAgICAgKiB8IEFuaW1hdGlvbiBTdGVwICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgV2hhdCB0aGUgZWxlbWVudCBjbGFzcyBhdHRyaWJ1dGUgbG9va3MgbGlrZSAgICAgICAgICAgICAgfAogICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgICAgICogfCAxLiAkYW5pbWF0ZS5sZWF2ZSguLi4pIGlzIGNhbGxlZCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDIuICRhbmltYXRlIHJ1bnMgdGhlIEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zIGRldGVjdGVkIG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIiAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMy4gJGFuaW1hdGUgd2FpdHMgZm9yIHRoZSBuZXh0IGRpZ2VzdCB0byBzdGFydCB0aGUgYW5pbWF0aW9uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUiICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA0LiB0aGUgLm5nLWxlYXZlIGNsYXNzIGlzIGFkZGVkIHRvIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1sZWF2ZSIgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDUuICRhbmltYXRlIHNjYW5zIHRoZSBlbGVtZW50IHN0eWxlcyB0byBnZXQgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBkdXJhdGlvbiBhbmQgZGVsYXkgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWxlYXZlIiAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNi4gJGFuaW1hdGUgYmxvY2tzIGFsbCBDU1MgdHJhbnNpdGlvbnMgb24gdGhlIGVsZW1lbnQgdG8gZW5zdXJlIHRoZSAubmctbGVhdmUgY2xhc3Mgc3R5bGluZyBpcyBhcHBsaWVkIHJpZ2h0IGF3YXkgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbGVhdmXigJ0gICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDcuICRhbmltYXRlIHdhaXRzIGZvciBhIHNpbmdsZSBhbmltYXRpb24gZnJhbWUgKHRoaXMgcGVyZm9ybXMgYSByZWZsb3cpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWxlYXZlIiAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgOC4gJGFuaW1hdGUgcmVtb3ZlcyB0aGUgQ1NTIHRyYW5zaXRpb24gYmxvY2sgcGxhY2VkIG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbGVhdmXigJ0gICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDkuIHRoZSAubmctbGVhdmUtYWN0aXZlIGNsYXNzIGlzIGFkZGVkICh0aGlzIHRyaWdnZXJzIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24pICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWxlYXZlIG5nLWxlYXZlLWFjdGl2ZSIgfAogICAgICAgICAqIHwgMTAuICRhbmltYXRlIHdhaXRzIGZvciB0aGUgYW5pbWF0aW9uIHRvIGNvbXBsZXRlICh2aWEgZXZlbnRzIGFuZCB0aW1lb3V0KSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbGVhdmUgbmctbGVhdmUtYWN0aXZlIiB8CiAgICAgICAgICogfCAxMS4gVGhlIGFuaW1hdGlvbiBlbmRzIGFuZCBhbGwgZ2VuZXJhdGVkIENTUyBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDEyLiBUaGUgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgLi4uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMTMuIFRoZSByZXR1cm5lZCBwcm9taXNlIGlzIHJlc29sdmVkLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCAuLi4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgbGVhdmUgYW5pbWF0aW9uCiAgICAgICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIGFuIG9wdGlvbmFsIGNvbGxlY3Rpb24gb2Ygc3R5bGVzIHRoYXQgd2lsbCBiZSBwaWNrZWQgdXAgYnkgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbgogICAgICAgICAqIEByZXR1cm4ge1Byb21pc2V9IHRoZSBhbmltYXRpb24gY2FsbGJhY2sgcHJvbWlzZQogICAgICAgICovCiAgICAgICAgbGVhdmUgOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gcGFyc2VBbmltYXRlT3B0aW9ucyhvcHRpb25zKTsKICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CgogICAgICAgICAgY2FuY2VsQ2hpbGRBbmltYXRpb25zKGVsZW1lbnQpOwogICAgICAgICAgY2xhc3NCYXNlZEFuaW1hdGlvbnNCbG9ja2VkKGVsZW1lbnQsIHRydWUpOwogICAgICAgICAgcmV0dXJuIHJ1bkFuaW1hdGlvblBvc3REaWdlc3QoZnVuY3Rpb24oZG9uZSkgewogICAgICAgICAgICByZXR1cm4gcGVyZm9ybUFuaW1hdGlvbignbGVhdmUnLCAnbmctbGVhdmUnLCBzdHJpcENvbW1lbnRzRnJvbUVsZW1lbnQoZWxlbWVudCksIG51bGwsIG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICRkZWxlZ2F0ZS5sZWF2ZShlbGVtZW50KTsKICAgICAgICAgICAgfSwgb3B0aW9ucywgZG9uZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjbW92ZQogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBGaXJlcyB0aGUgbW92ZSBET00gb3BlcmF0aW9uLiBKdXN0IGJlZm9yZSB0aGUgYW5pbWF0aW9uIHN0YXJ0cywgdGhlIGFuaW1hdGUgc2VydmljZSB3aWxsIGVpdGhlciBhcHBlbmQgaXQgaW50byB0aGUgcGFyZW50RWxlbWVudCBjb250YWluZXIgb3IKICAgICAgICAgKiBhZGQgdGhlIGVsZW1lbnQgZGlyZWN0bHkgYWZ0ZXIgdGhlIGFmdGVyRWxlbWVudCBlbGVtZW50IGlmIHByZXNlbnQuIFRoZW4gdGhlIG1vdmUgYW5pbWF0aW9uIHdpbGwgYmUgcnVuLiBPbmNlCiAgICAgICAgICogdGhlIGFuaW1hdGlvbiBpcyBzdGFydGVkLCB0aGUgZm9sbG93aW5nIENTUyBjbGFzc2VzIHdpbGwgYmUgYWRkZWQgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogQmVsb3cgaXMgYSBicmVha2Rvd24gb2YgZWFjaCBzdGVwIHRoYXQgb2NjdXJzIGR1cmluZyBtb3ZlIGFuaW1hdGlvbjoKICAgICAgICAgKgogICAgICAgICAqIHwgQW5pbWF0aW9uIFN0ZXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IFdoYXQgdGhlIGVsZW1lbnQgY2xhc3MgYXR0cmlidXRlIGxvb2tzIGxpa2UgICAgICAgICAgICB8CiAgICAgICAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAgICAgKiB8IDEuICRhbmltYXRlLm1vdmUoLi4uKSBpcyBjYWxsZWQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMi4gZWxlbWVudCBpcyBtb3ZlZCBpbnRvIHRoZSBwYXJlbnRFbGVtZW50IGVsZW1lbnQgb3IgYmVzaWRlIHRoZSBhZnRlckVsZW1lbnQgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAzLiAkYW5pbWF0ZSB3YWl0cyBmb3IgdGhlIG5leHQgZGlnZXN0IHRvIHN0YXJ0IHRoZSBhbmltYXRpb24gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDQuICRhbmltYXRlIHJ1bnMgdGhlIEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zIGRldGVjdGVkIG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUiICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNS4gdGhlIC5uZy1tb3ZlIGNsYXNzIGlzIGFkZGVkIHRvIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1tb3ZlIiAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA2LiAkYW5pbWF0ZSBzY2FucyB0aGUgZWxlbWVudCBzdHlsZXMgdG8gZ2V0IHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24gZHVyYXRpb24gYW5kIGRlbGF5ICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLW1vdmUiICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDcuICRhbmltYXRlIGJsb2NrcyBhbGwgQ1NTIHRyYW5zaXRpb25zIG9uIHRoZSBlbGVtZW50IHRvIGVuc3VyZSB0aGUgLm5nLW1vdmUgY2xhc3Mgc3R5bGluZyBpcyBhcHBsaWVkIHJpZ2h0IGF3YXkgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbW92ZeKAnSAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA4LiAkYW5pbWF0ZSB3YWl0cyBmb3IgYSBzaW5nbGUgYW5pbWF0aW9uIGZyYW1lICh0aGlzIHBlcmZvcm1zIGEgcmVmbG93KSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLW1vdmUiICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDkuICRhbmltYXRlIHJlbW92ZXMgdGhlIENTUyB0cmFuc2l0aW9uIGJsb2NrIHBsYWNlZCBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbW92ZeKAnSAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAxMC4gdGhlIC5uZy1tb3ZlLWFjdGl2ZSBjbGFzcyBpcyBhZGRlZCAodGhpcyB0cmlnZ2VycyB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLW1vdmUgbmctbW92ZS1hY3RpdmUiIHwKICAgICAgICAgKiB8IDExLiAkYW5pbWF0ZSB3YWl0cyBmb3IgdGhlIGFuaW1hdGlvbiB0byBjb21wbGV0ZSAodmlhIGV2ZW50cyBhbmQgdGltZW91dCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbW92ZSBuZy1tb3ZlLWFjdGl2ZSIgfAogICAgICAgICAqIHwgMTIuIFRoZSBhbmltYXRpb24gZW5kcyBhbmQgYWxsIGdlbmVyYXRlZCBDU1MgY2xhc3NlcyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAxMy4gVGhlIHJldHVybmVkIHByb21pc2UgaXMgcmVzb2x2ZWQuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgdGhlIGZvY3VzIG9mIHRoZSBtb3ZlIGFuaW1hdGlvbgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gcGFyZW50RWxlbWVudCB0aGUgcGFyZW50RWxlbWVudCBlbGVtZW50IG9mIHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIG1vdmUgYW5pbWF0aW9uCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBhZnRlckVsZW1lbnQgdGhlIHNpYmxpbmcgZWxlbWVudCAod2hpY2ggaXMgdGhlIHByZXZpb3VzIGVsZW1lbnQpIG9mIHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIG1vdmUgYW5pbWF0aW9uCiAgICAgICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIGFuIG9wdGlvbmFsIGNvbGxlY3Rpb24gb2Ygc3R5bGVzIHRoYXQgd2lsbCBiZSBwaWNrZWQgdXAgYnkgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbgogICAgICAgICAqIEByZXR1cm4ge1Byb21pc2V9IHRoZSBhbmltYXRpb24gY2FsbGJhY2sgcHJvbWlzZQogICAgICAgICovCiAgICAgICAgbW92ZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIHBhcmVudEVsZW1lbnQsIGFmdGVyRWxlbWVudCwgb3B0aW9ucykgewogICAgICAgICAgb3B0aW9ucyA9IHBhcnNlQW5pbWF0ZU9wdGlvbnMob3B0aW9ucyk7CiAgICAgICAgICBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgcGFyZW50RWxlbWVudCA9IHByZXBhcmVFbGVtZW50KHBhcmVudEVsZW1lbnQpOwogICAgICAgICAgYWZ0ZXJFbGVtZW50ID0gcHJlcGFyZUVsZW1lbnQoYWZ0ZXJFbGVtZW50KTsKCiAgICAgICAgICBjYW5jZWxDaGlsZEFuaW1hdGlvbnMoZWxlbWVudCk7CiAgICAgICAgICBjbGFzc0Jhc2VkQW5pbWF0aW9uc0Jsb2NrZWQoZWxlbWVudCwgdHJ1ZSk7CiAgICAgICAgICAkZGVsZWdhdGUubW92ZShlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQpOwogICAgICAgICAgcmV0dXJuIHJ1bkFuaW1hdGlvblBvc3REaWdlc3QoZnVuY3Rpb24oZG9uZSkgewogICAgICAgICAgICByZXR1cm4gcGVyZm9ybUFuaW1hdGlvbignbW92ZScsICduZy1tb3ZlJywgc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpLCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQsIG5vb3AsIG9wdGlvbnMsIGRvbmUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI2FkZENsYXNzCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUcmlnZ2VycyBhIGN1c3RvbSBhbmltYXRpb24gZXZlbnQgYmFzZWQgb2ZmIHRoZSBjbGFzc05hbWUgdmFyaWFibGUgYW5kIHRoZW4gYXR0YWNoZXMgdGhlIGNsYXNzTmFtZSB2YWx1ZSB0byB0aGUgZWxlbWVudCBhcyBhIENTUyBjbGFzcy4KICAgICAgICAgKiBVbmxpa2UgdGhlIG90aGVyIGFuaW1hdGlvbiBtZXRob2RzLCB0aGUgYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgc3VmZml4IHRoZSBjbGFzc05hbWUgdmFsdWUgd2l0aCB7QHR5cGUgLWFkZH0gaW4gb3JkZXIgdG8gcHJvdmlkZQogICAgICAgICAqIHRoZSBhbmltYXRlIHNlcnZpY2UgdGhlIHNldHVwIGFuZCBhY3RpdmUgQ1NTIGNsYXNzZXMgaW4gb3JkZXIgdG8gdHJpZ2dlciB0aGUgYW5pbWF0aW9uICh0aGlzIHdpbGwgYmUgc2tpcHBlZCBpZiBubyBDU1MgdHJhbnNpdGlvbnMKICAgICAgICAgKiBvciBrZXlmcmFtZXMgYXJlIGRlZmluZWQgb24gdGhlIC1hZGQtYWN0aXZlIG9yIGJhc2UgQ1NTIGNsYXNzKS4KICAgICAgICAgKgogICAgICAgICAqIEJlbG93IGlzIGEgYnJlYWtkb3duIG9mIGVhY2ggc3RlcCB0aGF0IG9jY3VycyBkdXJpbmcgYWRkQ2xhc3MgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogfCBBbmltYXRpb24gU3RlcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IFdoYXQgdGhlIGVsZW1lbnQgY2xhc3MgYXR0cmlidXRlIGxvb2tzIGxpa2UgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAgICAgKiB8IDEuICRhbmltYXRlLmFkZENsYXNzKGVsZW1lbnQsICdzdXBlcicpIGlzIGNhbGxlZCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAyLiAkYW5pbWF0ZSBydW5zIHRoZSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyBkZXRlY3RlZCBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMy4gdGhlIC5zdXBlci1hZGQgY2xhc3MgaXMgYWRkZWQgdG8gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgc3VwZXItYWRkIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDQuICRhbmltYXRlIHdhaXRzIGZvciBhIHNpbmdsZSBhbmltYXRpb24gZnJhbWUgKHRoaXMgcGVyZm9ybXMgYSByZWZsb3cpICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIHN1cGVyLWFkZCIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA1LiB0aGUgLnN1cGVyIGFuZCAuc3VwZXItYWRkLWFjdGl2ZSBjbGFzc2VzIGFyZSBhZGRlZCAodGhpcyB0cmlnZ2VycyB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uKSB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBzdXBlciBzdXBlci1hZGQgc3VwZXItYWRkLWFjdGl2ZSIgfAogICAgICAgICAqIHwgNi4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgc3VwZXItYWRkIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDcuICRhbmltYXRlIHdhaXRzIGZvciB0aGUgYW5pbWF0aW9uIHRvIGNvbXBsZXRlICh2aWEgZXZlbnRzIGFuZCB0aW1lb3V0KSAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBzdXBlci1hZGQgc3VwZXItYWRkLWFjdGl2ZSIgICAgICAgICAgICB8CiAgICAgICAgICogfCA4LiBUaGUgYW5pbWF0aW9uIGVuZHMgYW5kIGFsbCBnZW5lcmF0ZWQgQ1NTIGNsYXNzZXMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgOS4gVGhlIHN1cGVyIGNsYXNzIGlzIGtlcHQgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIHN1cGVyIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKiB8IDEwLiBUaGUgcmV0dXJuZWQgcHJvbWlzZSBpcyByZXNvbHZlZC4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIGFuaW1hdGVkCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzTmFtZSB0aGUgQ1NTIGNsYXNzIHRoYXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudCBhbmQgdGhlbiBhbmltYXRlZAogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBhbiBvcHRpb25hbCBjb2xsZWN0aW9uIG9mIHN0eWxlcyB0aGF0IHdpbGwgYmUgcGlja2VkIHVwIGJ5IHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24KICAgICAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSB0aGUgYW5pbWF0aW9uIGNhbGxiYWNrIHByb21pc2UKICAgICAgICAqLwogICAgICAgIGFkZENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBvcHRpb25zKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zZXRDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUsIFtdLCBvcHRpb25zKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjcmVtb3ZlQ2xhc3MKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRyaWdnZXJzIGEgY3VzdG9tIGFuaW1hdGlvbiBldmVudCBiYXNlZCBvZmYgdGhlIGNsYXNzTmFtZSB2YXJpYWJsZSBhbmQgdGhlbiByZW1vdmVzIHRoZSBDU1MgY2xhc3MgcHJvdmlkZWQgYnkgdGhlIGNsYXNzTmFtZSB2YWx1ZQogICAgICAgICAqIGZyb20gdGhlIGVsZW1lbnQuIFVubGlrZSB0aGUgb3RoZXIgYW5pbWF0aW9uIG1ldGhvZHMsIHRoZSBhbmltYXRlIHNlcnZpY2Ugd2lsbCBzdWZmaXggdGhlIGNsYXNzTmFtZSB2YWx1ZSB3aXRoIHtAdHlwZSAtcmVtb3ZlfSBpbgogICAgICAgICAqIG9yZGVyIHRvIHByb3ZpZGUgdGhlIGFuaW1hdGUgc2VydmljZSB0aGUgc2V0dXAgYW5kIGFjdGl2ZSBDU1MgY2xhc3NlcyBpbiBvcmRlciB0byB0cmlnZ2VyIHRoZSBhbmltYXRpb24gKHRoaXMgd2lsbCBiZSBza2lwcGVkIGlmCiAgICAgICAgICogbm8gQ1NTIHRyYW5zaXRpb25zIG9yIGtleWZyYW1lcyBhcmUgZGVmaW5lZCBvbiB0aGUgLXJlbW92ZSBvciBiYXNlIENTUyBjbGFzc2VzKS4KICAgICAgICAgKgogICAgICAgICAqIEJlbG93IGlzIGEgYnJlYWtkb3duIG9mIGVhY2ggc3RlcCB0aGF0IG9jY3VycyBkdXJpbmcgcmVtb3ZlQ2xhc3MgYW5pbWF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogfCBBbmltYXRpb24gU3RlcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgV2hhdCB0aGUgZWxlbWVudCBjbGFzcyBhdHRyaWJ1dGUgbG9va3MgbGlrZSAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgICAgICogfCAxLiAkYW5pbWF0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCAnc3VwZXInKSBpcyBjYWxsZWQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAyLiAkYW5pbWF0ZSBydW5zIHRoZSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyBkZXRlY3RlZCBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBuZy1hbmltYXRlIiAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCAzLiB0aGUgLnN1cGVyLXJlbW92ZSBjbGFzcyBpcyBhZGRlZCB0byB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBuZy1hbmltYXRlIHN1cGVyLXJlbW92ZSIgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA0LiAkYW5pbWF0ZSB3YWl0cyBmb3IgYSBzaW5nbGUgYW5pbWF0aW9uIGZyYW1lICh0aGlzIHBlcmZvcm1zIGEgcmVmbG93KSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBuZy1hbmltYXRlIHN1cGVyLXJlbW92ZSIgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA1LiB0aGUgLnN1cGVyLXJlbW92ZS1hY3RpdmUgY2xhc3NlcyBhcmUgYWRkZWQgYW5kIC5zdXBlciBpcyByZW1vdmVkICh0aGlzIHRyaWdnZXJzIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24pIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIHN1cGVyLXJlbW92ZSBzdXBlci1yZW1vdmUtYWN0aXZlIiB8CiAgICAgICAgICogfCA2LiAkYW5pbWF0ZSBzY2FucyB0aGUgZWxlbWVudCBzdHlsZXMgdG8gZ2V0IHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24gZHVyYXRpb24gYW5kIGRlbGF5ICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBuZy1hbmltYXRlIHN1cGVyLXJlbW92ZSIgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA3LiAkYW5pbWF0ZSB3YWl0cyBmb3IgdGhlIGFuaW1hdGlvbiB0byBjb21wbGV0ZSAodmlhIGV2ZW50cyBhbmQgdGltZW91dCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIHN1cGVyLXJlbW92ZSBzdXBlci1yZW1vdmUtYWN0aXZlIiB8CiAgICAgICAgICogfCA4LiBUaGUgYW5pbWF0aW9uIGVuZHMgYW5kIGFsbCBnZW5lcmF0ZWQgQ1NTIGNsYXNzZXMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICogfCA5LiBUaGUgcmV0dXJuZWQgcHJvbWlzZSBpcyByZXNvbHZlZC4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICoKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgYW5pbWF0ZWQKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lIHRoZSBDU1MgY2xhc3MgdGhhdCB3aWxsIGJlIGFuaW1hdGVkIGFuZCB0aGVuIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBhbiBvcHRpb25hbCBjb2xsZWN0aW9uIG9mIHN0eWxlcyB0aGF0IHdpbGwgYmUgcGlja2VkIHVwIGJ5IHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24KICAgICAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSB0aGUgYW5pbWF0aW9uIGNhbGxiYWNrIHByb21pc2UKICAgICAgICAqLwogICAgICAgIHJlbW92ZUNsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBvcHRpb25zKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zZXRDbGFzcyhlbGVtZW50LCBbXSwgY2xhc3NOYW1lLCBvcHRpb25zKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNzZXRDbGFzcwogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uIEFkZHMgYW5kL29yIHJlbW92ZXMgdGhlIGdpdmVuIENTUyBjbGFzc2VzIHRvIGFuZCBmcm9tIHRoZSBlbGVtZW50LgogICAgICAgICAqIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgICAqCiAgICAgICAgICogfCBBbmltYXRpb24gU3RlcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBXaGF0IHRoZSBlbGVtZW50IGNsYXNzIGF0dHJpYnV0ZSBsb29rcyBsaWtlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAgICAgKiB8IDEuICRhbmltYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsIOKAmG9u4oCZLCDigJhvZmbigJkpIGlzIGNhbGxlZCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBvZmbigJ0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMi4gJGFuaW1hdGUgcnVucyB0aGUgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgZGV0ZWN0ZWQgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBuZy1hbmltYXRlIG9mZuKAnSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgMy4gdGhlIC5vbi1hZGQgYW5kIC5vZmYtcmVtb3ZlIGNsYXNzZXMgYXJlIGFkZGVkIHRvIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG9uLWFkZCBvZmYtcmVtb3ZlIG9mZuKAnSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNC4gJGFuaW1hdGUgd2FpdHMgZm9yIGEgc2luZ2xlIGFuaW1hdGlvbiBmcmFtZSAodGhpcyBwZXJmb3JtcyBhIHJlZmxvdykgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG9uLWFkZCBvZmYtcmVtb3ZlIG9mZuKAnSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgNS4gdGhlIC5vbiwgLm9uLWFkZC1hY3RpdmUgYW5kIC5vZmYtcmVtb3ZlLWFjdGl2ZSBjbGFzc2VzIGFyZSBhZGRlZCBhbmQgLm9mZiBpcyByZW1vdmVkICh0aGlzIHRyaWdnZXJzIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24pIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG9uIG9uLWFkZCBvbi1hZGQtYWN0aXZlIG9mZi1yZW1vdmUgb2ZmLXJlbW92ZS1hY3RpdmXigJ0gfAogICAgICAgICAqIHwgNi4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG9uIG9uLWFkZCBvbi1hZGQtYWN0aXZlIG9mZi1yZW1vdmUgb2ZmLXJlbW92ZS1hY3RpdmUiIHwKICAgICAgICAgKiB8IDcuICRhbmltYXRlIHdhaXRzIGZvciB0aGUgYW5pbWF0aW9uIHRvIGNvbXBsZXRlICh2aWEgZXZlbnRzIGFuZCB0aW1lb3V0KSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBvbiBvbi1hZGQgb24tYWRkLWFjdGl2ZSBvZmYtcmVtb3ZlIG9mZi1yZW1vdmUtYWN0aXZlIiB8CiAgICAgICAgICogfCA4LiBUaGUgYW5pbWF0aW9uIGVuZHMgYW5kIGFsbCBnZW5lcmF0ZWQgQ1NTIGNsYXNzZXMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG9uIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAqIHwgOS4gVGhlIHJldHVybmVkIHByb21pc2UgaXMgcmVzb2x2ZWQuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBvbiIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGhhdmUgaXRzIENTUyBjbGFzc2VzIGNoYW5nZWQKICAgICAgICAgKiAgIHJlbW92ZWQgZnJvbSBpdAogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBhZGQgdGhlIENTUyBjbGFzc2VzIHdoaWNoIHdpbGwgYmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVtb3ZlIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICAgKiAgIENTUyBjbGFzc2VzIGhhdmUgYmVlbiBzZXQgb24gdGhlIGVsZW1lbnQKICAgICAgICAgKiBAcGFyYW0ge29iamVjdD19IG9wdGlvbnMgYW4gb3B0aW9uYWwgY29sbGVjdGlvbiBvZiBzdHlsZXMgdGhhdCB3aWxsIGJlIHBpY2tlZCB1cCBieSB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uCiAgICAgICAgICogQHJldHVybiB7UHJvbWlzZX0gdGhlIGFuaW1hdGlvbiBjYWxsYmFjayBwcm9taXNlCiAgICAgICAgICovCiAgICAgICAgc2V0Q2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBhZGQsIHJlbW92ZSwgb3B0aW9ucykgewogICAgICAgICAgb3B0aW9ucyA9IHBhcnNlQW5pbWF0ZU9wdGlvbnMob3B0aW9ucyk7CgogICAgICAgICAgdmFyIFNUT1JBR0VfS0VZID0gJyQkYW5pbWF0ZUNsYXNzZXMnOwogICAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgICAgICAgIGVsZW1lbnQgPSBzdHJpcENvbW1lbnRzRnJvbUVsZW1lbnQoZWxlbWVudCk7CgogICAgICAgICAgaWYgKGNsYXNzQmFzZWRBbmltYXRpb25zQmxvY2tlZChlbGVtZW50KSkgewogICAgICAgICAgICByZXR1cm4gJGRlbGVnYXRlLiQkc2V0Q2xhc3NJbW1lZGlhdGVseShlbGVtZW50LCBhZGQsIHJlbW92ZSwgb3B0aW9ucyk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gd2UncmUgdXNpbmcgYSBjb21iaW5lZCBhcnJheSBmb3IgYm90aCB0aGUgYWRkIGFuZCByZW1vdmUKICAgICAgICAgIC8vIG9wZXJhdGlvbnMgc2luY2UgdGhlIE9SREVSIE9GIGFkZENsYXNzIGFuZCByZW1vdmVDbGFzcyBtYXR0ZXJzCiAgICAgICAgICB2YXIgY2xhc3NlcywgY2FjaGUgPSBlbGVtZW50LmRhdGEoU1RPUkFHRV9LRVkpOwogICAgICAgICAgdmFyIGhhc0NhY2hlID0gISFjYWNoZTsKICAgICAgICAgIGlmICghY2FjaGUpIHsKICAgICAgICAgICAgY2FjaGUgPSB7fTsKICAgICAgICAgICAgY2FjaGUuY2xhc3NlcyA9IHt9OwogICAgICAgICAgfQogICAgICAgICAgY2xhc3NlcyA9IGNhY2hlLmNsYXNzZXM7CgogICAgICAgICAgYWRkID0gaXNBcnJheShhZGQpID8gYWRkIDogYWRkLnNwbGl0KCcgJyk7CiAgICAgICAgICBmb3JFYWNoKGFkZCwgZnVuY3Rpb24oYykgewogICAgICAgICAgICBpZiAoYyAmJiBjLmxlbmd0aCkgewogICAgICAgICAgICAgIGNsYXNzZXNbY10gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICByZW1vdmUgPSBpc0FycmF5KHJlbW92ZSkgPyByZW1vdmUgOiByZW1vdmUuc3BsaXQoJyAnKTsKICAgICAgICAgIGZvckVhY2gocmVtb3ZlLCBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgIGlmIChjICYmIGMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgY2xhc3Nlc1tjXSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpZiAoaGFzQ2FjaGUpIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgY2FjaGUub3B0aW9ucykgewogICAgICAgICAgICAgIGNhY2hlLm9wdGlvbnMgPSBhbmd1bGFyLmV4dGVuZChjYWNoZS5vcHRpb25zIHx8IHt9LCBvcHRpb25zKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy90aGUgZGlnZXN0IGN5Y2xlIHdpbGwgY29tYmluZSBhbGwgdGhlIGFuaW1hdGlvbnMgaW50byBvbmUgZnVuY3Rpb24KICAgICAgICAgICAgcmV0dXJuIGNhY2hlLnByb21pc2U7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbGVtZW50LmRhdGEoU1RPUkFHRV9LRVksIGNhY2hlID0gewogICAgICAgICAgICAgIGNsYXNzZXMgOiBjbGFzc2VzLAogICAgICAgICAgICAgIG9wdGlvbnMgOiBvcHRpb25zCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBjYWNoZS5wcm9taXNlID0gcnVuQW5pbWF0aW9uUG9zdERpZ2VzdChmdW5jdGlvbihkb25lKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRFbGVtZW50ID0gZWxlbWVudC5wYXJlbnQoKTsKICAgICAgICAgICAgdmFyIGVsZW1lbnROb2RlID0gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpOwogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IGVsZW1lbnROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIC8vIFRPRE8obWF0c2tvKTogbW92ZSB0aGlzIGNvZGUgaW50byB0aGUgYW5pbWF0aW9uc0Rpc2FibGVkKCkgZnVuY3Rpb24gb25jZSAjODA5MiBpcyBmaXhlZAogICAgICAgICAgICBpZiAoIXBhcmVudE5vZGUgfHwgcGFyZW50Tm9kZVsnJCROR19SRU1PVkVEJ10gfHwgZWxlbWVudE5vZGVbJyQkTkdfUkVNT1ZFRCddKSB7CiAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNhY2hlID0gZWxlbWVudC5kYXRhKFNUT1JBR0VfS0VZKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVEYXRhKFNUT1JBR0VfS0VZKTsKCiAgICAgICAgICAgIHZhciBzdGF0ZSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKSB8fCB7fTsKICAgICAgICAgICAgdmFyIGNsYXNzZXMgPSByZXNvbHZlRWxlbWVudENsYXNzZXMoZWxlbWVudCwgY2FjaGUsIHN0YXRlLmFjdGl2ZSk7CiAgICAgICAgICAgIHJldHVybiAhY2xhc3NlcwogICAgICAgICAgICAgID8gZG9uZSgpCiAgICAgICAgICAgICAgOiBwZXJmb3JtQW5pbWF0aW9uKCdzZXRDbGFzcycsIGNsYXNzZXMsIGVsZW1lbnQsIHBhcmVudEVsZW1lbnQsIG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoY2xhc3Nlc1swXSkgJGRlbGVnYXRlLiQkYWRkQ2xhc3NJbW1lZGlhdGVseShlbGVtZW50LCBjbGFzc2VzWzBdKTsKICAgICAgICAgICAgICAgICAgaWYgKGNsYXNzZXNbMV0pICRkZWxlZ2F0ZS4kJHJlbW92ZUNsYXNzSW1tZWRpYXRlbHkoZWxlbWVudCwgY2xhc3Nlc1sxXSk7CiAgICAgICAgICAgICAgICB9LCBjYWNoZS5vcHRpb25zLCBkb25lKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNjYW5jZWwKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtQcm9taXNlfSBhbmltYXRpb25Qcm9taXNlIFRoZSBhbmltYXRpb24gcHJvbWlzZSB0aGF0IGlzIHJldHVybmVkIHdoZW4gYW4gYW5pbWF0aW9uIGlzIHN0YXJ0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDYW5jZWxzIHRoZSBwcm92aWRlZCBhbmltYXRpb24uCiAgICAgICAgKi8KICAgICAgICBjYW5jZWwgOiBmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgICAgICBwcm9taXNlLiQkY2FuY2VsRm4oKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjZW5hYmxlZAogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSB2YWx1ZSBJZiBwcm92aWRlZCB0aGVuIHNldCB0aGUgYW5pbWF0aW9uIG9uIG9yIG9mZi4KICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnQ9fSBlbGVtZW50IElmIHByb3ZpZGVkIHRoZW4gdGhlIGVsZW1lbnQgd2lsbCBiZSB1c2VkIHRvIHJlcHJlc2VudCB0aGUgZW5hYmxlL2Rpc2FibGUgb3BlcmF0aW9uCiAgICAgICAgICogQHJldHVybiB7Ym9vbGVhbn0gQ3VycmVudCBhbmltYXRpb24gc3RhdGUuCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBHbG9iYWxseSBlbmFibGVzL2Rpc2FibGVzIGFuaW1hdGlvbnMuCiAgICAgICAgICoKICAgICAgICAqLwogICAgICAgIGVuYWJsZWQgOiBmdW5jdGlvbih2YWx1ZSwgZWxlbWVudCkgewogICAgICAgICAgc3dpdGNoKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgY2xlYW51cChlbGVtZW50KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSkgfHwge307CiAgICAgICAgICAgICAgICBkYXRhLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFLCBkYXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgIHJvb3RBbmltYXRlU3RhdGUuZGlzYWJsZWQgPSAhdmFsdWU7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB2YWx1ZSA9ICFyb290QW5pbWF0ZVN0YXRlLmRpc2FibGVkOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAhIXZhbHVlOwogICAgICAgICB9CiAgICAgIH07CgogICAgICAvKgogICAgICAgIGFsbCBhbmltYXRpb25zIGNhbGwgdGhpcyBzaGFyZWQgYW5pbWF0aW9uIHRyaWdnZXJpbmcgZnVuY3Rpb24gaW50ZXJuYWxseS4KICAgICAgICBUaGUgYW5pbWF0aW9uRXZlbnQgdmFyaWFibGUgcmVmZXJzIHRvIHRoZSBKYXZhU2NyaXB0IGFuaW1hdGlvbiBldmVudCB0aGF0IHdpbGwgYmUgdHJpZ2dlcmVkCiAgICAgICAgYW5kIHRoZSBjbGFzc05hbWUgdmFsdWUgaXMgdGhlIG5hbWUgb2YgdGhlIGFuaW1hdGlvbiB0aGF0IHdpbGwgYmUgYXBwbGllZCB3aXRoaW4gdGhlCiAgICAgICAgQ1NTIGNvZGUuIEVsZW1lbnQsIHBhcmVudEVsZW1lbnQgYW5kIGFmdGVyRWxlbWVudCBhcmUgcHJvdmlkZWQgRE9NIGVsZW1lbnRzIGZvciB0aGUgYW5pbWF0aW9uCiAgICAgICAgYW5kIHRoZSBvbkNvbXBsZXRlIGNhbGxiYWNrIHdpbGwgYmUgZmlyZWQgb25jZSB0aGUgYW5pbWF0aW9uIGlzIGZ1bGx5IGNvbXBsZXRlLgogICAgICAqLwogICAgICBmdW5jdGlvbiBwZXJmb3JtQW5pbWF0aW9uKGFuaW1hdGlvbkV2ZW50LCBjbGFzc05hbWUsIGVsZW1lbnQsIHBhcmVudEVsZW1lbnQsIGFmdGVyRWxlbWVudCwgZG9tT3BlcmF0aW9uLCBvcHRpb25zLCBkb25lQ2FsbGJhY2spIHsKICAgICAgICB2YXIgbm9vcENhbmNlbCA9IG5vb3A7CiAgICAgICAgdmFyIHJ1bm5lciA9IGFuaW1hdGlvblJ1bm5lcihlbGVtZW50LCBhbmltYXRpb25FdmVudCwgY2xhc3NOYW1lLCBvcHRpb25zKTsKICAgICAgICBpZiAoIXJ1bm5lcikgewogICAgICAgICAgZmlyZURPTU9wZXJhdGlvbigpOwogICAgICAgICAgZmlyZUJlZm9yZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIGNsb3NlQW5pbWF0aW9uKCk7CiAgICAgICAgICByZXR1cm4gbm9vcENhbmNlbDsKICAgICAgICB9CgogICAgICAgIGFuaW1hdGlvbkV2ZW50ID0gcnVubmVyLmV2ZW50OwogICAgICAgIGNsYXNzTmFtZSA9IHJ1bm5lci5jbGFzc05hbWU7CiAgICAgICAgdmFyIGVsZW1lbnRFdmVudHMgPSBhbmd1bGFyLmVsZW1lbnQuX2RhdGEocnVubmVyLm5vZGUpOwogICAgICAgIGVsZW1lbnRFdmVudHMgPSBlbGVtZW50RXZlbnRzICYmIGVsZW1lbnRFdmVudHMuZXZlbnRzOwoKICAgICAgICBpZiAoIXBhcmVudEVsZW1lbnQpIHsKICAgICAgICAgIHBhcmVudEVsZW1lbnQgPSBhZnRlckVsZW1lbnQgPyBhZnRlckVsZW1lbnQucGFyZW50KCkgOiBlbGVtZW50LnBhcmVudCgpOwogICAgICAgIH0KCiAgICAgICAgLy9za2lwIHRoZSBhbmltYXRpb24gaWYgYW5pbWF0aW9ucyBhcmUgZGlzYWJsZWQsIGEgcGFyZW50IGlzIGFscmVhZHkgYmVpbmcgYW5pbWF0ZWQsCiAgICAgICAgLy90aGUgZWxlbWVudCBpcyBub3QgY3VycmVudGx5IGF0dGFjaGVkIHRvIHRoZSBkb2N1bWVudCBib2R5IG9yIHRoZW4gY29tcGxldGVseSBjbG9zZQogICAgICAgIC8vdGhlIGFuaW1hdGlvbiBpZiBhbnkgbWF0Y2hpbmcgYW5pbWF0aW9ucyBhcmUgbm90IGZvdW5kIGF0IGFsbC4KICAgICAgICAvL05PVEU6IElFOCArIElFOSBzaG91bGQgY2xvc2UgcHJvcGVybHkgKHJ1biBjbG9zZUFuaW1hdGlvbigpKSBpbiBjYXNlIGFuIGFuaW1hdGlvbiB3YXMgZm91bmQuCiAgICAgICAgaWYgKGFuaW1hdGlvbnNEaXNhYmxlZChlbGVtZW50LCBwYXJlbnRFbGVtZW50KSkgewogICAgICAgICAgZmlyZURPTU9wZXJhdGlvbigpOwogICAgICAgICAgZmlyZUJlZm9yZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIGNsb3NlQW5pbWF0aW9uKCk7CiAgICAgICAgICByZXR1cm4gbm9vcENhbmNlbDsKICAgICAgICB9CgogICAgICAgIHZhciBuZ0FuaW1hdGVTdGF0ZSAgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSkgfHwge307CiAgICAgICAgdmFyIHJ1bm5pbmdBbmltYXRpb25zICAgICA9IG5nQW5pbWF0ZVN0YXRlLmFjdGl2ZSB8fCB7fTsKICAgICAgICB2YXIgdG90YWxBY3RpdmVBbmltYXRpb25zID0gbmdBbmltYXRlU3RhdGUudG90YWxBY3RpdmUgfHwgMDsKICAgICAgICB2YXIgbGFzdEFuaW1hdGlvbiAgICAgICAgID0gbmdBbmltYXRlU3RhdGUubGFzdDsKICAgICAgICB2YXIgc2tpcEFuaW1hdGlvbiA9IGZhbHNlOwoKICAgICAgICBpZiAodG90YWxBY3RpdmVBbmltYXRpb25zID4gMCkgewogICAgICAgICAgdmFyIGFuaW1hdGlvbnNUb0NhbmNlbCA9IFtdOwogICAgICAgICAgaWYgKCFydW5uZXIuaXNDbGFzc0Jhc2VkKSB7CiAgICAgICAgICAgIGlmIChhbmltYXRpb25FdmVudCA9PSAnbGVhdmUnICYmIHJ1bm5pbmdBbmltYXRpb25zWyduZy1sZWF2ZSddKSB7CiAgICAgICAgICAgICAgc2tpcEFuaW1hdGlvbiA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy9jYW5jZWwgYWxsIGFuaW1hdGlvbnMgd2hlbiBhIHN0cnVjdHVyYWwgYW5pbWF0aW9uIHRha2VzIHBsYWNlCiAgICAgICAgICAgICAgZm9yKHZhciBrbGFzcyBpbiBydW5uaW5nQW5pbWF0aW9ucykgewogICAgICAgICAgICAgICAgYW5pbWF0aW9uc1RvQ2FuY2VsLnB1c2gocnVubmluZ0FuaW1hdGlvbnNba2xhc3NdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbmdBbmltYXRlU3RhdGUgPSB7fTsKICAgICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGxhc3RBbmltYXRpb24uZXZlbnQgPT0gJ3NldENsYXNzJykgewogICAgICAgICAgICBhbmltYXRpb25zVG9DYW5jZWwucHVzaChsYXN0QW5pbWF0aW9uKTsKICAgICAgICAgICAgY2xlYW51cChlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAocnVubmluZ0FuaW1hdGlvbnNbY2xhc3NOYW1lXSkgewogICAgICAgICAgICB2YXIgY3VycmVudCA9IHJ1bm5pbmdBbmltYXRpb25zW2NsYXNzTmFtZV07CiAgICAgICAgICAgIGlmIChjdXJyZW50LmV2ZW50ID09IGFuaW1hdGlvbkV2ZW50KSB7CiAgICAgICAgICAgICAgc2tpcEFuaW1hdGlvbiA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYW5pbWF0aW9uc1RvQ2FuY2VsLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgY2xlYW51cChlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGFuaW1hdGlvbnNUb0NhbmNlbC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGZvckVhY2goYW5pbWF0aW9uc1RvQ2FuY2VsLCBmdW5jdGlvbihvcGVyYXRpb24pIHsKICAgICAgICAgICAgICBvcGVyYXRpb24uY2FuY2VsKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHJ1bm5lci5pc0NsYXNzQmFzZWQKICAgICAgICAgICAgJiYgIXJ1bm5lci5pc1NldENsYXNzT3BlcmF0aW9uCiAgICAgICAgICAgICYmIGFuaW1hdGlvbkV2ZW50ICE9ICdhbmltYXRlJwogICAgICAgICAgICAmJiAhc2tpcEFuaW1hdGlvbikgewogICAgICAgICAgc2tpcEFuaW1hdGlvbiA9IChhbmltYXRpb25FdmVudCA9PSAnYWRkQ2xhc3MnKSA9PSBlbGVtZW50Lmhhc0NsYXNzKGNsYXNzTmFtZSk7IC8vb3Bwb3NpdGUgb2YgWE9SCiAgICAgICAgfQoKICAgICAgICBpZiAoc2tpcEFuaW1hdGlvbikgewogICAgICAgICAgZmlyZURPTU9wZXJhdGlvbigpOwogICAgICAgICAgZmlyZUJlZm9yZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIGZpcmVEb25lQ2FsbGJhY2tBc3luYygpOwogICAgICAgICAgcmV0dXJuIG5vb3BDYW5jZWw7CiAgICAgICAgfQoKICAgICAgICBydW5uaW5nQW5pbWF0aW9ucyAgICAgPSBuZ0FuaW1hdGVTdGF0ZS5hY3RpdmUgfHwge307CiAgICAgICAgdG90YWxBY3RpdmVBbmltYXRpb25zID0gbmdBbmltYXRlU3RhdGUudG90YWxBY3RpdmUgfHwgMDsKCiAgICAgICAgaWYgKGFuaW1hdGlvbkV2ZW50ID09ICdsZWF2ZScpIHsKICAgICAgICAgIC8vdGhlcmUncyBubyBuZWVkIHRvIGV2ZXIgcmVtb3ZlIHRoZSBsaXN0ZW5lciBzaW5jZSB0aGUgZWxlbWVudAogICAgICAgICAgLy93aWxsIGJlIHJlbW92ZWQgKGRlc3Ryb3llZCkgYWZ0ZXIgdGhlIGxlYXZlIGFuaW1hdGlvbiBlbmRzIG9yCiAgICAgICAgICAvL2lzIGNhbmNlbGxlZCBtaWR3YXkKICAgICAgICAgIGVsZW1lbnQub25lKCckZGVzdHJveScsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQodGhpcyk7CiAgICAgICAgICAgIHZhciBzdGF0ZSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKTsKICAgICAgICAgICAgaWYgKHN0YXRlKSB7CiAgICAgICAgICAgICAgdmFyIGFjdGl2ZUxlYXZlQW5pbWF0aW9uID0gc3RhdGUuYWN0aXZlWyduZy1sZWF2ZSddOwogICAgICAgICAgICAgIGlmIChhY3RpdmVMZWF2ZUFuaW1hdGlvbikgewogICAgICAgICAgICAgICAgYWN0aXZlTGVhdmVBbmltYXRpb24uY2FuY2VsKCk7CiAgICAgICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQsICduZy1sZWF2ZScpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvL3RoZSBuZy1hbmltYXRlIGNsYXNzIGRvZXMgbm90aGluZywgYnV0IGl0J3MgaGVyZSB0byBhbGxvdyBmb3IKICAgICAgICAvL3BhcmVudCBhbmltYXRpb25zIHRvIGZpbmQgYW5kIGNhbmNlbCBjaGlsZCBhbmltYXRpb25zIHdoZW4gbmVlZGVkCiAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhOR19BTklNQVRFX0NMQVNTX05BTUUpOwogICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMudGVtcENsYXNzZXMpIHsKICAgICAgICAgIGZvckVhY2gob3B0aW9ucy50ZW1wQ2xhc3NlcywgZnVuY3Rpb24oY2xhc3NOYW1lKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdmFyIGxvY2FsQW5pbWF0aW9uQ291bnQgPSBnbG9iYWxBbmltYXRpb25Db3VudGVyKys7CiAgICAgICAgdG90YWxBY3RpdmVBbmltYXRpb25zKys7CiAgICAgICAgcnVubmluZ0FuaW1hdGlvbnNbY2xhc3NOYW1lXSA9IHJ1bm5lcjsKCiAgICAgICAgZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUsIHsKICAgICAgICAgIGxhc3QgOiBydW5uZXIsCiAgICAgICAgICBhY3RpdmUgOiBydW5uaW5nQW5pbWF0aW9ucywKICAgICAgICAgIGluZGV4IDogbG9jYWxBbmltYXRpb25Db3VudCwKICAgICAgICAgIHRvdGFsQWN0aXZlIDogdG90YWxBY3RpdmVBbmltYXRpb25zCiAgICAgICAgfSk7CgogICAgICAgIC8vZmlyc3Qgd2UgcnVuIHRoZSBiZWZvcmUgYW5pbWF0aW9ucyBhbmQgd2hlbiBhbGwgb2YgdGhvc2UgYXJlIGNvbXBsZXRlCiAgICAgICAgLy90aGVuIHdlIHBlcmZvcm0gdGhlIERPTSBvcGVyYXRpb24gYW5kIHJ1biB0aGUgbmV4dCBzZXQgb2YgYW5pbWF0aW9ucwogICAgICAgIGZpcmVCZWZvcmVDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgcnVubmVyLmJlZm9yZShmdW5jdGlvbihjYW5jZWxsZWQpIHsKICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpOwogICAgICAgICAgY2FuY2VsbGVkID0gY2FuY2VsbGVkIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICFkYXRhIHx8ICFkYXRhLmFjdGl2ZVtjbGFzc05hbWVdIHx8CiAgICAgICAgICAgICAgICAgICAgICAgIChydW5uZXIuaXNDbGFzc0Jhc2VkICYmIGRhdGEuYWN0aXZlW2NsYXNzTmFtZV0uZXZlbnQgIT0gYW5pbWF0aW9uRXZlbnQpOwoKICAgICAgICAgIGZpcmVET01PcGVyYXRpb24oKTsKICAgICAgICAgIGlmIChjYW5jZWxsZWQgPT09IHRydWUpIHsKICAgICAgICAgICAgY2xvc2VBbmltYXRpb24oKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgICAgcnVubmVyLmFmdGVyKGNsb3NlQW5pbWF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHJ1bm5lci5jYW5jZWw7CgogICAgICAgIGZ1bmN0aW9uIGZpcmVET01DYWxsYmFjayhhbmltYXRpb25QaGFzZSkgewogICAgICAgICAgdmFyIGV2ZW50TmFtZSA9ICckYW5pbWF0ZTonICsgYW5pbWF0aW9uUGhhc2U7CiAgICAgICAgICBpZiAoZWxlbWVudEV2ZW50cyAmJiBlbGVtZW50RXZlbnRzW2V2ZW50TmFtZV0gJiYgZWxlbWVudEV2ZW50c1tldmVudE5hbWVdLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgJCRhc3luY0NhbGxiYWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGVsZW1lbnQudHJpZ2dlckhhbmRsZXIoZXZlbnROYW1lLCB7CiAgICAgICAgICAgICAgICBldmVudCA6IGFuaW1hdGlvbkV2ZW50LAogICAgICAgICAgICAgICAgY2xhc3NOYW1lIDogY2xhc3NOYW1lCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZmlyZUJlZm9yZUNhbGxiYWNrQXN5bmMoKSB7CiAgICAgICAgICBmaXJlRE9NQ2FsbGJhY2soJ2JlZm9yZScpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZmlyZUFmdGVyQ2FsbGJhY2tBc3luYygpIHsKICAgICAgICAgIGZpcmVET01DYWxsYmFjaygnYWZ0ZXInKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZpcmVEb25lQ2FsbGJhY2tBc3luYygpIHsKICAgICAgICAgIGZpcmVET01DYWxsYmFjaygnY2xvc2UnKTsKICAgICAgICAgIGRvbmVDYWxsYmFjaygpOwogICAgICAgIH0KCiAgICAgICAgLy9pdCBpcyBsZXNzIGNvbXBsaWNhdGVkIHRvIHVzZSBhIGZsYWcgdGhhbiBtYW5hZ2luZyBhbmQgY2FuY2VsaW5nCiAgICAgICAgLy90aW1lb3V0cyBjb250YWluaW5nIG11bHRpcGxlIGNhbGxiYWNrcy4KICAgICAgICBmdW5jdGlvbiBmaXJlRE9NT3BlcmF0aW9uKCkgewogICAgICAgICAgaWYgKCFmaXJlRE9NT3BlcmF0aW9uLmhhc0JlZW5SdW4pIHsKICAgICAgICAgICAgZmlyZURPTU9wZXJhdGlvbi5oYXNCZWVuUnVuID0gdHJ1ZTsKICAgICAgICAgICAgZG9tT3BlcmF0aW9uKCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjbG9zZUFuaW1hdGlvbigpIHsKICAgICAgICAgIGlmICghY2xvc2VBbmltYXRpb24uaGFzQmVlblJ1bikgewogICAgICAgICAgICBpZiAocnVubmVyKSB7IC8vdGhlIHJ1bm5lciBkb2Vzbid0IGV4aXN0IGlmIGl0IGZhaWxzIHRvIGluc3RhbnRpYXRlCiAgICAgICAgICAgICAgcnVubmVyLmFwcGx5U3R5bGVzKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNsb3NlQW5pbWF0aW9uLmhhc0JlZW5SdW4gPSB0cnVlOwogICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnRlbXBDbGFzc2VzKSB7CiAgICAgICAgICAgICAgZm9yRWFjaChvcHRpb25zLnRlbXBDbGFzc2VzLCBmdW5jdGlvbihjbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSk7CiAgICAgICAgICAgIGlmIChkYXRhKSB7CgogICAgICAgICAgICAgIC8qIG9ubHkgc3RydWN0dXJhbCBhbmltYXRpb25zIHdhaXQgZm9yIHJlZmxvdyBiZWZvcmUgcmVtb3ZpbmcgYW4KICAgICAgICAgICAgICAgICBhbmltYXRpb24sIGJ1dCBjbGFzcy1iYXNlZCBhbmltYXRpb25zIGRvbid0LiBBbiBleGFtcGxlIG9mIHRoaXMKICAgICAgICAgICAgICAgICBmYWlsaW5nIHdvdWxkIGJlIHdoZW4gYSBwYXJlbnQgSFRNTCB0YWcgaGFzIGEgbmctY2xhc3MgYXR0cmlidXRlCiAgICAgICAgICAgICAgICAgY2F1c2luZyBBTEwgZGlyZWN0aXZlcyBiZWxvdyB0byBza2lwIGFuaW1hdGlvbnMgZHVyaW5nIHRoZSBkaWdlc3QgKi8KICAgICAgICAgICAgICBpZiAocnVubmVyICYmIHJ1bm5lci5pc0NsYXNzQmFzZWQpIHsKICAgICAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJCRhc3luY0NhbGxiYWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKSB8fCB7fTsKICAgICAgICAgICAgICAgICAgaWYgKGxvY2FsQW5pbWF0aW9uQ291bnQgPT0gZGF0YS5pbmRleCkgewogICAgICAgICAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCwgY2xhc3NOYW1lLCBhbmltYXRpb25FdmVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUsIGRhdGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaXJlRG9uZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNhbmNlbENoaWxkQW5pbWF0aW9ucyhlbGVtZW50KSB7CiAgICAgICAgdmFyIG5vZGUgPSBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCk7CiAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgIHZhciBub2RlcyA9IGFuZ3VsYXIuaXNGdW5jdGlvbihub2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUpID8KICAgICAgICAgICAgbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKE5HX0FOSU1BVEVfQ0xBU1NfTkFNRSkgOgogICAgICAgICAgICBub2RlLnF1ZXJ5U2VsZWN0b3JBbGwoJy4nICsgTkdfQU5JTUFURV9DTEFTU19OQU1FKTsKICAgICAgICAgIGZvckVhY2gobm9kZXMsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSk7CiAgICAgICAgICAgIGlmIChkYXRhICYmIGRhdGEuYWN0aXZlKSB7CiAgICAgICAgICAgICAgZm9yRWFjaChkYXRhLmFjdGl2ZSwgZnVuY3Rpb24ocnVubmVyKSB7CiAgICAgICAgICAgICAgICBydW5uZXIuY2FuY2VsKCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gY2xlYW51cChlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgICBpZiAoaXNNYXRjaGluZ0VsZW1lbnQoZWxlbWVudCwgJHJvb3RFbGVtZW50KSkgewogICAgICAgICAgaWYgKCFyb290QW5pbWF0ZVN0YXRlLmRpc2FibGVkKSB7CiAgICAgICAgICAgIHJvb3RBbmltYXRlU3RhdGUucnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICByb290QW5pbWF0ZVN0YXRlLnN0cnVjdHVyYWwgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGNsYXNzTmFtZSkgewogICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSkgfHwge307CgogICAgICAgICAgdmFyIHJlbW92ZUFuaW1hdGlvbnMgPSBjbGFzc05hbWUgPT09IHRydWU7CiAgICAgICAgICBpZiAoIXJlbW92ZUFuaW1hdGlvbnMgJiYgZGF0YS5hY3RpdmUgJiYgZGF0YS5hY3RpdmVbY2xhc3NOYW1lXSkgewogICAgICAgICAgICBkYXRhLnRvdGFsQWN0aXZlLS07CiAgICAgICAgICAgIGRlbGV0ZSBkYXRhLmFjdGl2ZVtjbGFzc05hbWVdOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChyZW1vdmVBbmltYXRpb25zIHx8ICFkYXRhLnRvdGFsQWN0aXZlKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoTkdfQU5JTUFURV9DTEFTU19OQU1FKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVEYXRhKE5HX0FOSU1BVEVfU1RBVEUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gYW5pbWF0aW9uc0Rpc2FibGVkKGVsZW1lbnQsIHBhcmVudEVsZW1lbnQpIHsKICAgICAgICBpZiAocm9vdEFuaW1hdGVTdGF0ZS5kaXNhYmxlZCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNNYXRjaGluZ0VsZW1lbnQoZWxlbWVudCwgJHJvb3RFbGVtZW50KSkgewogICAgICAgICAgcmV0dXJuIHJvb3RBbmltYXRlU3RhdGUucnVubmluZzsKICAgICAgICB9CgogICAgICAgIHZhciBhbGxvd0NoaWxkQW5pbWF0aW9ucywgcGFyZW50UnVubmluZ0FuaW1hdGlvbiwgaGFzUGFyZW50OwogICAgICAgIGRvIHsKICAgICAgICAgIC8vdGhlIGVsZW1lbnQgZGlkIG5vdCByZWFjaCB0aGUgcm9vdCBlbGVtZW50IHdoaWNoIG1lYW5zIHRoYXQgaXQKICAgICAgICAgIC8vaXMgbm90IGFwYXJ0IG9mIHRoZSBET00uIFRoZXJlZm9yZSB0aGVyZSBpcyBubyByZWFzb24gdG8gZG8KICAgICAgICAgIC8vYW55IGFuaW1hdGlvbnMgb24gaXQKICAgICAgICAgIGlmIChwYXJlbnRFbGVtZW50Lmxlbmd0aCA9PT0gMCkgYnJlYWs7CgogICAgICAgICAgdmFyIGlzUm9vdCA9IGlzTWF0Y2hpbmdFbGVtZW50KHBhcmVudEVsZW1lbnQsICRyb290RWxlbWVudCk7CiAgICAgICAgICB2YXIgc3RhdGUgPSBpc1Jvb3QgPyByb290QW5pbWF0ZVN0YXRlIDogKHBhcmVudEVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKSB8fCB7fSk7CiAgICAgICAgICBpZiAoc3RhdGUuZGlzYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgLy9ubyBtYXR0ZXIgd2hhdCwgZm9yIGFuIGFuaW1hdGlvbiB0byB3b3JrIGl0IG11c3QgcmVhY2ggdGhlIHJvb3QgZWxlbWVudAogICAgICAgICAgLy90aGlzIGltcGxpZXMgdGhhdCB0aGUgZWxlbWVudCBpcyBhdHRhY2hlZCB0byB0aGUgRE9NIHdoZW4gdGhlIGFuaW1hdGlvbiBpcyBydW4KICAgICAgICAgIGlmIChpc1Jvb3QpIHsKICAgICAgICAgICAgaGFzUGFyZW50ID0gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICAvL29uY2UgYSBmbGFnIGlzIGZvdW5kIHRoYXQgaXMgc3RyaWN0bHkgZmFsc2UgdGhlbiBldmVyeXRoaW5nIGJlZm9yZQogICAgICAgICAgLy9pdCB3aWxsIGJlIGRpc2NhcmRlZCBhbmQgYWxsIGNoaWxkIGFuaW1hdGlvbnMgd2lsbCBiZSByZXN0cmljdGVkCiAgICAgICAgICBpZiAoYWxsb3dDaGlsZEFuaW1hdGlvbnMgIT09IGZhbHNlKSB7CiAgICAgICAgICAgIHZhciBhbmltYXRlQ2hpbGRyZW5GbGFnID0gcGFyZW50RWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ0hJTERSRU4pOwogICAgICAgICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQoYW5pbWF0ZUNoaWxkcmVuRmxhZykpIHsKICAgICAgICAgICAgICBhbGxvd0NoaWxkQW5pbWF0aW9ucyA9IGFuaW1hdGVDaGlsZHJlbkZsYWc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBwYXJlbnRSdW5uaW5nQW5pbWF0aW9uID0gcGFyZW50UnVubmluZ0FuaW1hdGlvbiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnJ1bm5pbmcgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoc3RhdGUubGFzdCAmJiAhc3RhdGUubGFzdC5pc0NsYXNzQmFzZWQpOwogICAgICAgIH0KICAgICAgICB3aGlsZShwYXJlbnRFbGVtZW50ID0gcGFyZW50RWxlbWVudC5wYXJlbnQoKSk7CgogICAgICAgIHJldHVybiAhaGFzUGFyZW50IHx8ICghYWxsb3dDaGlsZEFuaW1hdGlvbnMgJiYgcGFyZW50UnVubmluZ0FuaW1hdGlvbik7CiAgICAgIH0KICAgIH1dKTsKCiAgICAkYW5pbWF0ZVByb3ZpZGVyLnJlZ2lzdGVyKCcnLCBbJyR3aW5kb3cnLCAnJHNuaWZmZXInLCAnJHRpbWVvdXQnLCAnJCRhbmltYXRlUmVmbG93JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oJHdpbmRvdywgICAkc25pZmZlciwgICAkdGltZW91dCwgICAkJGFuaW1hdGVSZWZsb3cpIHsKICAgICAgLy8gRGV0ZWN0IHByb3BlciB0cmFuc2l0aW9uZW5kL2FuaW1hdGlvbmVuZCBldmVudCBuYW1lcy4KICAgICAgdmFyIENTU19QUkVGSVggPSAnJywgVFJBTlNJVElPTl9QUk9QLCBUUkFOU0lUSU9ORU5EX0VWRU5ULCBBTklNQVRJT05fUFJPUCwgQU5JTUFUSU9ORU5EX0VWRU5UOwoKICAgICAgLy8gSWYgdW5wcmVmaXhlZCBldmVudHMgYXJlIG5vdCBzdXBwb3J0ZWQgYnV0IHdlYmtpdC1wcmVmaXhlZCBhcmUsIHVzZSB0aGUgbGF0dGVyLgogICAgICAvLyBPdGhlcndpc2UsIGp1c3QgdXNlIFczQyBuYW1lcywgYnJvd3NlcnMgbm90IHN1cHBvcnRpbmcgdGhlbSBhdCBhbGwgd2lsbCBqdXN0IGlnbm9yZSB0aGVtLgogICAgICAvLyBOb3RlOiBDaHJvbWUgaW1wbGVtZW50cyBgd2luZG93Lm9ud2Via2l0YW5pbWF0aW9uZW5kYCBhbmQgZG9lc24ndCBpbXBsZW1lbnQgYHdpbmRvdy5vbmFuaW1hdGlvbmVuZGAKICAgICAgLy8gYnV0IGF0IHRoZSBzYW1lIHRpbWUgZGlzcGF0Y2hlcyB0aGUgYGFuaW1hdGlvbmVuZGAgZXZlbnQgYW5kIG5vdCBgd2Via2l0QW5pbWF0aW9uRW5kYC4KICAgICAgLy8gUmVnaXN0ZXIgYm90aCBldmVudHMgaW4gY2FzZSBgd2luZG93Lm9uYW5pbWF0aW9uZW5kYCBpcyBub3Qgc3VwcG9ydGVkIGJlY2F1c2Ugb2YgdGhhdCwKICAgICAgLy8gZG8gdGhlIHNhbWUgZm9yIGB0cmFuc2l0aW9uZW5kYCBhcyBTYWZhcmkgaXMgbGlrZWx5IHRvIGV4aGliaXQgc2ltaWxhciBiZWhhdmlvci4KICAgICAgLy8gQWxzbywgdGhlIG9ubHkgbW9kZXJuIGJyb3dzZXIgdGhhdCB1c2VzIHZlbmRvciBwcmVmaXhlcyBmb3IgdHJhbnNpdGlvbnMva2V5ZnJhbWVzIGlzIHdlYmtpdAogICAgICAvLyB0aGVyZWZvcmUgdGhlcmUgaXMgbm8gcmVhc29uIHRvIHRlc3QgYW55bW9yZSBmb3Igb3RoZXIgdmVuZG9yIHByZWZpeGVzOiBodHRwOi8vY2FuaXVzZS5jb20vI3NlYXJjaD10cmFuc2l0aW9uCiAgICAgIGlmICh3aW5kb3cub250cmFuc2l0aW9uZW5kID09PSB1bmRlZmluZWQgJiYgd2luZG93Lm9ud2Via2l0dHJhbnNpdGlvbmVuZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgQ1NTX1BSRUZJWCA9ICctd2Via2l0LSc7CiAgICAgICAgVFJBTlNJVElPTl9QUk9QID0gJ1dlYmtpdFRyYW5zaXRpb24nOwogICAgICAgIFRSQU5TSVRJT05FTkRfRVZFTlQgPSAnd2Via2l0VHJhbnNpdGlvbkVuZCB0cmFuc2l0aW9uZW5kJzsKICAgICAgfSBlbHNlIHsKICAgICAgICBUUkFOU0lUSU9OX1BST1AgPSAndHJhbnNpdGlvbic7CiAgICAgICAgVFJBTlNJVElPTkVORF9FVkVOVCA9ICd0cmFuc2l0aW9uZW5kJzsKICAgICAgfQoKICAgICAgaWYgKHdpbmRvdy5vbmFuaW1hdGlvbmVuZCA9PT0gdW5kZWZpbmVkICYmIHdpbmRvdy5vbndlYmtpdGFuaW1hdGlvbmVuZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgQ1NTX1BSRUZJWCA9ICctd2Via2l0LSc7CiAgICAgICAgQU5JTUFUSU9OX1BST1AgPSAnV2Via2l0QW5pbWF0aW9uJzsKICAgICAgICBBTklNQVRJT05FTkRfRVZFTlQgPSAnd2Via2l0QW5pbWF0aW9uRW5kIGFuaW1hdGlvbmVuZCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgQU5JTUFUSU9OX1BST1AgPSAnYW5pbWF0aW9uJzsKICAgICAgICBBTklNQVRJT05FTkRfRVZFTlQgPSAnYW5pbWF0aW9uZW5kJzsKICAgICAgfQoKICAgICAgdmFyIERVUkFUSU9OX0tFWSA9ICdEdXJhdGlvbic7CiAgICAgIHZhciBQUk9QRVJUWV9LRVkgPSAnUHJvcGVydHknOwogICAgICB2YXIgREVMQVlfS0VZID0gJ0RlbGF5JzsKICAgICAgdmFyIEFOSU1BVElPTl9JVEVSQVRJT05fQ09VTlRfS0VZID0gJ0l0ZXJhdGlvbkNvdW50JzsKICAgICAgdmFyIEFOSU1BVElPTl9QTEFZU1RBVEVfS0VZID0gJ1BsYXlTdGF0ZSc7CiAgICAgIHZhciBOR19BTklNQVRFX1BBUkVOVF9LRVkgPSAnJCRuZ0FuaW1hdGVLZXknOwogICAgICB2YXIgTkdfQU5JTUFURV9DU1NfREFUQV9LRVkgPSAnJCRuZ0FuaW1hdGVDU1MzRGF0YSc7CiAgICAgIHZhciBFTEFQU0VEX1RJTUVfTUFYX0RFQ0lNQUxfUExBQ0VTID0gMzsKICAgICAgdmFyIENMT1NJTkdfVElNRV9CVUZGRVIgPSAxLjU7CiAgICAgIHZhciBPTkVfU0VDT05EID0gMTAwMDsKCiAgICAgIHZhciBsb29rdXBDYWNoZSA9IHt9OwogICAgICB2YXIgcGFyZW50Q291bnRlciA9IDA7CiAgICAgIHZhciBhbmltYXRpb25SZWZsb3dRdWV1ZSA9IFtdOwogICAgICB2YXIgY2FuY2VsQW5pbWF0aW9uUmVmbG93OwogICAgICBmdW5jdGlvbiBjbGVhckNhY2hlQWZ0ZXJSZWZsb3coKSB7CiAgICAgICAgaWYgKCFjYW5jZWxBbmltYXRpb25SZWZsb3cpIHsKICAgICAgICAgIGNhbmNlbEFuaW1hdGlvblJlZmxvdyA9ICQkYW5pbWF0ZVJlZmxvdyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgYW5pbWF0aW9uUmVmbG93UXVldWUgPSBbXTsKICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uUmVmbG93ID0gbnVsbDsKICAgICAgICAgICAgbG9va3VwQ2FjaGUgPSB7fTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gYWZ0ZXJSZWZsb3coZWxlbWVudCwgY2FsbGJhY2spIHsKICAgICAgICBpZiAoY2FuY2VsQW5pbWF0aW9uUmVmbG93KSB7CiAgICAgICAgICBjYW5jZWxBbmltYXRpb25SZWZsb3coKTsKICAgICAgICB9CiAgICAgICAgYW5pbWF0aW9uUmVmbG93UXVldWUucHVzaChjYWxsYmFjayk7CiAgICAgICAgY2FuY2VsQW5pbWF0aW9uUmVmbG93ID0gJCRhbmltYXRlUmVmbG93KGZ1bmN0aW9uKCkgewogICAgICAgICAgZm9yRWFjaChhbmltYXRpb25SZWZsb3dRdWV1ZSwgZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgZm4oKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGFuaW1hdGlvblJlZmxvd1F1ZXVlID0gW107CiAgICAgICAgICBjYW5jZWxBbmltYXRpb25SZWZsb3cgPSBudWxsOwogICAgICAgICAgbG9va3VwQ2FjaGUgPSB7fTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdmFyIGNsb3NpbmdUaW1lciA9IG51bGw7CiAgICAgIHZhciBjbG9zaW5nVGltZXN0YW1wID0gMDsKICAgICAgdmFyIGFuaW1hdGlvbkVsZW1lbnRRdWV1ZSA9IFtdOwogICAgICBmdW5jdGlvbiBhbmltYXRpb25DbG9zZUhhbmRsZXIoZWxlbWVudCwgdG90YWxUaW1lKSB7CiAgICAgICAgdmFyIG5vZGUgPSBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCk7CiAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChub2RlKTsKCiAgICAgICAgLy90aGlzIGl0ZW0gd2lsbCBiZSBnYXJiYWdlIGNvbGxlY3RlZCBieSB0aGUgY2xvc2luZwogICAgICAgIC8vYW5pbWF0aW9uIHRpbWVvdXQKICAgICAgICBhbmltYXRpb25FbGVtZW50UXVldWUucHVzaChlbGVtZW50KTsKCiAgICAgICAgLy9idXQgaXQgbWF5IG5vdCBuZWVkIHRvIGNhbmNlbCBvdXQgdGhlIGV4aXN0aW5nIHRpbWVvdXQKICAgICAgICAvL2lmIHRoZSB0aW1lc3RhbXAgaXMgbGVzcyB0aGFuIHRoZSBwcmV2aW91cyBvbmUKICAgICAgICB2YXIgZnV0dXJlVGltZXN0YW1wID0gRGF0ZS5ub3coKSArIHRvdGFsVGltZTsKICAgICAgICBpZiAoZnV0dXJlVGltZXN0YW1wIDw9IGNsb3NpbmdUaW1lc3RhbXApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgICR0aW1lb3V0LmNhbmNlbChjbG9zaW5nVGltZXIpOwoKICAgICAgICBjbG9zaW5nVGltZXN0YW1wID0gZnV0dXJlVGltZXN0YW1wOwogICAgICAgIGNsb3NpbmdUaW1lciA9ICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgY2xvc2VBbGxBbmltYXRpb25zKGFuaW1hdGlvbkVsZW1lbnRRdWV1ZSk7CiAgICAgICAgICBhbmltYXRpb25FbGVtZW50UXVldWUgPSBbXTsKICAgICAgICB9LCB0b3RhbFRpbWUsIGZhbHNlKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY2xvc2VBbGxBbmltYXRpb25zKGVsZW1lbnRzKSB7CiAgICAgICAgZm9yRWFjaChlbGVtZW50cywgZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgdmFyIGVsZW1lbnREYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKTsKICAgICAgICAgIGlmIChlbGVtZW50RGF0YSkgewogICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnREYXRhLmNsb3NlQW5pbWF0aW9uRm5zLCBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBnZXRFbGVtZW50QW5pbWF0aW9uRGV0YWlscyhlbGVtZW50LCBjYWNoZUtleSkgewogICAgICAgIHZhciBkYXRhID0gY2FjaGVLZXkgPyBsb29rdXBDYWNoZVtjYWNoZUtleV0gOiBudWxsOwogICAgICAgIGlmICghZGF0YSkgewogICAgICAgICAgdmFyIHRyYW5zaXRpb25EdXJhdGlvbiA9IDA7CiAgICAgICAgICB2YXIgdHJhbnNpdGlvbkRlbGF5ID0gMDsKICAgICAgICAgIHZhciBhbmltYXRpb25EdXJhdGlvbiA9IDA7CiAgICAgICAgICB2YXIgYW5pbWF0aW9uRGVsYXkgPSAwOwoKICAgICAgICAgIC8vd2Ugd2FudCBhbGwgdGhlIHN0eWxlcyBkZWZpbmVkIGJlZm9yZSBhbmQgYWZ0ZXIKICAgICAgICAgIGZvckVhY2goZWxlbWVudCwgZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgZWxlbWVudFN0eWxlcyA9ICR3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50KSB8fCB7fTsKCiAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb25EdXJhdGlvblN0eWxlID0gZWxlbWVudFN0eWxlc1tUUkFOU0lUSU9OX1BST1AgKyBEVVJBVElPTl9LRVldOwogICAgICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvbiA9IE1hdGgubWF4KHBhcnNlTWF4VGltZSh0cmFuc2l0aW9uRHVyYXRpb25TdHlsZSksIHRyYW5zaXRpb25EdXJhdGlvbik7CgogICAgICAgICAgICAgIHZhciB0cmFuc2l0aW9uRGVsYXlTdHlsZSA9IGVsZW1lbnRTdHlsZXNbVFJBTlNJVElPTl9QUk9QICsgREVMQVlfS0VZXTsKICAgICAgICAgICAgICB0cmFuc2l0aW9uRGVsYXkgID0gTWF0aC5tYXgocGFyc2VNYXhUaW1lKHRyYW5zaXRpb25EZWxheVN0eWxlKSwgdHJhbnNpdGlvbkRlbGF5KTsKCiAgICAgICAgICAgICAgdmFyIGFuaW1hdGlvbkRlbGF5U3R5bGUgPSBlbGVtZW50U3R5bGVzW0FOSU1BVElPTl9QUk9QICsgREVMQVlfS0VZXTsKICAgICAgICAgICAgICBhbmltYXRpb25EZWxheSAgID0gTWF0aC5tYXgocGFyc2VNYXhUaW1lKGVsZW1lbnRTdHlsZXNbQU5JTUFUSU9OX1BST1AgKyBERUxBWV9LRVldKSwgYW5pbWF0aW9uRGVsYXkpOwoKICAgICAgICAgICAgICB2YXIgYUR1cmF0aW9uICA9IHBhcnNlTWF4VGltZShlbGVtZW50U3R5bGVzW0FOSU1BVElPTl9QUk9QICsgRFVSQVRJT05fS0VZXSk7CgogICAgICAgICAgICAgIGlmIChhRHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgICBhRHVyYXRpb24gKj0gcGFyc2VJbnQoZWxlbWVudFN0eWxlc1tBTklNQVRJT05fUFJPUCArIEFOSU1BVElPTl9JVEVSQVRJT05fQ09VTlRfS0VZXSwgMTApIHx8IDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFuaW1hdGlvbkR1cmF0aW9uID0gTWF0aC5tYXgoYUR1cmF0aW9uLCBhbmltYXRpb25EdXJhdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgZGF0YSA9IHsKICAgICAgICAgICAgdG90YWwgOiAwLAogICAgICAgICAgICB0cmFuc2l0aW9uRGVsYXk6IHRyYW5zaXRpb25EZWxheSwKICAgICAgICAgICAgdHJhbnNpdGlvbkR1cmF0aW9uOiB0cmFuc2l0aW9uRHVyYXRpb24sCiAgICAgICAgICAgIGFuaW1hdGlvbkRlbGF5OiBhbmltYXRpb25EZWxheSwKICAgICAgICAgICAgYW5pbWF0aW9uRHVyYXRpb246IGFuaW1hdGlvbkR1cmF0aW9uCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGNhY2hlS2V5KSB7CiAgICAgICAgICAgIGxvb2t1cENhY2hlW2NhY2hlS2V5XSA9IGRhdGE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBkYXRhOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwYXJzZU1heFRpbWUoc3RyKSB7CiAgICAgICAgdmFyIG1heFZhbHVlID0gMDsKICAgICAgICB2YXIgdmFsdWVzID0gaXNTdHJpbmcoc3RyKSA/CiAgICAgICAgICBzdHIuc3BsaXQoL1xzKixccyovKSA6CiAgICAgICAgICBbXTsKICAgICAgICBmb3JFYWNoKHZhbHVlcywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIG1heFZhbHVlID0gTWF0aC5tYXgocGFyc2VGbG9hdCh2YWx1ZSkgfHwgMCwgbWF4VmFsdWUpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBtYXhWYWx1ZTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0Q2FjaGVLZXkoZWxlbWVudCkgewogICAgICAgIHZhciBwYXJlbnRFbGVtZW50ID0gZWxlbWVudC5wYXJlbnQoKTsKICAgICAgICB2YXIgcGFyZW50SUQgPSBwYXJlbnRFbGVtZW50LmRhdGEoTkdfQU5JTUFURV9QQVJFTlRfS0VZKTsKICAgICAgICBpZiAoIXBhcmVudElEKSB7CiAgICAgICAgICBwYXJlbnRFbGVtZW50LmRhdGEoTkdfQU5JTUFURV9QQVJFTlRfS0VZLCArK3BhcmVudENvdW50ZXIpOwogICAgICAgICAgcGFyZW50SUQgPSBwYXJlbnRDb3VudGVyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFyZW50SUQgKyAnLScgKyBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCkuZ2V0QXR0cmlidXRlKCdjbGFzcycpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBhbmltYXRlU2V0dXAoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgc3R5bGVzKSB7CiAgICAgICAgdmFyIHN0cnVjdHVyYWwgPSBbJ25nLWVudGVyJywnbmctbGVhdmUnLCduZy1tb3ZlJ10uaW5kZXhPZihjbGFzc05hbWUpID49IDA7CgogICAgICAgIHZhciBjYWNoZUtleSA9IGdldENhY2hlS2V5KGVsZW1lbnQpOwogICAgICAgIHZhciBldmVudENhY2hlS2V5ID0gY2FjaGVLZXkgKyAnICcgKyBjbGFzc05hbWU7CiAgICAgICAgdmFyIGl0ZW1JbmRleCA9IGxvb2t1cENhY2hlW2V2ZW50Q2FjaGVLZXldID8gKytsb29rdXBDYWNoZVtldmVudENhY2hlS2V5XS50b3RhbCA6IDA7CgogICAgICAgIHZhciBzdGFnZ2VyID0ge307CiAgICAgICAgaWYgKGl0ZW1JbmRleCA+IDApIHsKICAgICAgICAgIHZhciBzdGFnZ2VyQ2xhc3NOYW1lID0gY2xhc3NOYW1lICsgJy1zdGFnZ2VyJzsKICAgICAgICAgIHZhciBzdGFnZ2VyQ2FjaGVLZXkgPSBjYWNoZUtleSArICcgJyArIHN0YWdnZXJDbGFzc05hbWU7CiAgICAgICAgICB2YXIgYXBwbHlDbGFzc2VzID0gIWxvb2t1cENhY2hlW3N0YWdnZXJDYWNoZUtleV07CgogICAgICAgICAgYXBwbHlDbGFzc2VzICYmIGVsZW1lbnQuYWRkQ2xhc3Moc3RhZ2dlckNsYXNzTmFtZSk7CgogICAgICAgICAgc3RhZ2dlciA9IGdldEVsZW1lbnRBbmltYXRpb25EZXRhaWxzKGVsZW1lbnQsIHN0YWdnZXJDYWNoZUtleSk7CgogICAgICAgICAgYXBwbHlDbGFzc2VzICYmIGVsZW1lbnQucmVtb3ZlQ2xhc3Moc3RhZ2dlckNsYXNzTmFtZSk7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CgogICAgICAgIHZhciBmb3JtZXJEYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKSB8fCB7fTsKICAgICAgICB2YXIgdGltaW5ncyA9IGdldEVsZW1lbnRBbmltYXRpb25EZXRhaWxzKGVsZW1lbnQsIGV2ZW50Q2FjaGVLZXkpOwogICAgICAgIHZhciB0cmFuc2l0aW9uRHVyYXRpb24gPSB0aW1pbmdzLnRyYW5zaXRpb25EdXJhdGlvbjsKICAgICAgICB2YXIgYW5pbWF0aW9uRHVyYXRpb24gPSB0aW1pbmdzLmFuaW1hdGlvbkR1cmF0aW9uOwoKICAgICAgICBpZiAoc3RydWN0dXJhbCAmJiB0cmFuc2l0aW9uRHVyYXRpb24gPT09IDAgJiYgYW5pbWF0aW9uRHVyYXRpb24gPT09IDApIHsKICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHZhciBibG9ja1RyYW5zaXRpb24gPSBzdHlsZXMgfHwgKHN0cnVjdHVyYWwgJiYgdHJhbnNpdGlvbkR1cmF0aW9uID4gMCk7CiAgICAgICAgdmFyIGJsb2NrQW5pbWF0aW9uID0gYW5pbWF0aW9uRHVyYXRpb24gPiAwICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhZ2dlci5hbmltYXRpb25EZWxheSA+IDAgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFnZ2VyLmFuaW1hdGlvbkR1cmF0aW9uID09PSAwOwoKICAgICAgICB2YXIgY2xvc2VBbmltYXRpb25GbnMgPSBmb3JtZXJEYXRhLmNsb3NlQW5pbWF0aW9uRm5zIHx8IFtdOwogICAgICAgIGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSwgewogICAgICAgICAgc3RhZ2dlciA6IHN0YWdnZXIsCiAgICAgICAgICBjYWNoZUtleSA6IGV2ZW50Q2FjaGVLZXksCiAgICAgICAgICBydW5uaW5nIDogZm9ybWVyRGF0YS5ydW5uaW5nIHx8IDAsCiAgICAgICAgICBpdGVtSW5kZXggOiBpdGVtSW5kZXgsCiAgICAgICAgICBibG9ja1RyYW5zaXRpb24gOiBibG9ja1RyYW5zaXRpb24sCiAgICAgICAgICBjbG9zZUFuaW1hdGlvbkZucyA6IGNsb3NlQW5pbWF0aW9uRm5zCiAgICAgICAgfSk7CgogICAgICAgIHZhciBub2RlID0gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpOwoKICAgICAgICBpZiAoYmxvY2tUcmFuc2l0aW9uKSB7CiAgICAgICAgICBibG9ja1RyYW5zaXRpb25zKG5vZGUsIHRydWUpOwogICAgICAgICAgaWYgKHN0eWxlcykgewogICAgICAgICAgICBlbGVtZW50LmNzcyhzdHlsZXMpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGJsb2NrQW5pbWF0aW9uKSB7CiAgICAgICAgICBibG9ja0FuaW1hdGlvbnMobm9kZSwgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYW5pbWF0ZVJ1bihhbmltYXRpb25FdmVudCwgZWxlbWVudCwgY2xhc3NOYW1lLCBhY3RpdmVBbmltYXRpb25Db21wbGV0ZSwgc3R5bGVzKSB7CiAgICAgICAgdmFyIG5vZGUgPSBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCk7CiAgICAgICAgdmFyIGVsZW1lbnREYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKTsKICAgICAgICBpZiAobm9kZS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykuaW5kZXhPZihjbGFzc05hbWUpID09IC0xIHx8ICFlbGVtZW50RGF0YSkgewogICAgICAgICAgYWN0aXZlQW5pbWF0aW9uQ29tcGxldGUoKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBhY3RpdmVDbGFzc05hbWUgPSAnJzsKICAgICAgICB2YXIgcGVuZGluZ0NsYXNzTmFtZSA9ICcnOwogICAgICAgIGZvckVhY2goY2xhc3NOYW1lLnNwbGl0KCcgJyksIGZ1bmN0aW9uKGtsYXNzLCBpKSB7CiAgICAgICAgICB2YXIgcHJlZml4ID0gKGkgPiAwID8gJyAnIDogJycpICsga2xhc3M7CiAgICAgICAgICBhY3RpdmVDbGFzc05hbWUgKz0gcHJlZml4ICsgJy1hY3RpdmUnOwogICAgICAgICAgcGVuZGluZ0NsYXNzTmFtZSArPSBwcmVmaXggKyAnLXBlbmRpbmcnOwogICAgICAgIH0pOwoKICAgICAgICB2YXIgc3R5bGUgPSAnJzsKICAgICAgICB2YXIgYXBwbGllZFN0eWxlcyA9IFtdOwogICAgICAgIHZhciBpdGVtSW5kZXggPSBlbGVtZW50RGF0YS5pdGVtSW5kZXg7CiAgICAgICAgdmFyIHN0YWdnZXIgPSBlbGVtZW50RGF0YS5zdGFnZ2VyOwogICAgICAgIHZhciBzdGFnZ2VyVGltZSA9IDA7CiAgICAgICAgaWYgKGl0ZW1JbmRleCA+IDApIHsKICAgICAgICAgIHZhciB0cmFuc2l0aW9uU3RhZ2dlckRlbGF5ID0gMDsKICAgICAgICAgIGlmIChzdGFnZ2VyLnRyYW5zaXRpb25EZWxheSA+IDAgJiYgc3RhZ2dlci50cmFuc2l0aW9uRHVyYXRpb24gPT09IDApIHsKICAgICAgICAgICAgdHJhbnNpdGlvblN0YWdnZXJEZWxheSA9IHN0YWdnZXIudHJhbnNpdGlvbkRlbGF5ICogaXRlbUluZGV4OwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBhbmltYXRpb25TdGFnZ2VyRGVsYXkgPSAwOwogICAgICAgICAgaWYgKHN0YWdnZXIuYW5pbWF0aW9uRGVsYXkgPiAwICYmIHN0YWdnZXIuYW5pbWF0aW9uRHVyYXRpb24gPT09IDApIHsKICAgICAgICAgICAgYW5pbWF0aW9uU3RhZ2dlckRlbGF5ID0gc3RhZ2dlci5hbmltYXRpb25EZWxheSAqIGl0ZW1JbmRleDsKICAgICAgICAgICAgYXBwbGllZFN0eWxlcy5wdXNoKENTU19QUkVGSVggKyAnYW5pbWF0aW9uLXBsYXktc3RhdGUnKTsKICAgICAgICAgIH0KCiAgICAgICAgICBzdGFnZ2VyVGltZSA9IE1hdGgucm91bmQoTWF0aC5tYXgodHJhbnNpdGlvblN0YWdnZXJEZWxheSwgYW5pbWF0aW9uU3RhZ2dlckRlbGF5KSAqIDEwMCkgLyAxMDA7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXN0YWdnZXJUaW1lKSB7CiAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKGFjdGl2ZUNsYXNzTmFtZSk7CiAgICAgICAgICBpZiAoZWxlbWVudERhdGEuYmxvY2tUcmFuc2l0aW9uKSB7CiAgICAgICAgICAgIGJsb2NrVHJhbnNpdGlvbnMobm9kZSwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGV2ZW50Q2FjaGVLZXkgPSBlbGVtZW50RGF0YS5jYWNoZUtleSArICcgJyArIGFjdGl2ZUNsYXNzTmFtZTsKICAgICAgICB2YXIgdGltaW5ncyA9IGdldEVsZW1lbnRBbmltYXRpb25EZXRhaWxzKGVsZW1lbnQsIGV2ZW50Q2FjaGVLZXkpOwogICAgICAgIHZhciBtYXhEdXJhdGlvbiA9IE1hdGgubWF4KHRpbWluZ3MudHJhbnNpdGlvbkR1cmF0aW9uLCB0aW1pbmdzLmFuaW1hdGlvbkR1cmF0aW9uKTsKICAgICAgICBpZiAobWF4RHVyYXRpb24gPT09IDApIHsKICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoYWN0aXZlQ2xhc3NOYW1lKTsKICAgICAgICAgIGFuaW1hdGVDbG9zZShlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgYWN0aXZlQW5pbWF0aW9uQ29tcGxldGUoKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICghc3RhZ2dlclRpbWUgJiYgc3R5bGVzKSB7CiAgICAgICAgICBpZiAoIXRpbWluZ3MudHJhbnNpdGlvbkR1cmF0aW9uKSB7CiAgICAgICAgICAgIGVsZW1lbnQuY3NzKCd0cmFuc2l0aW9uJywgdGltaW5ncy5hbmltYXRpb25EdXJhdGlvbiArICdzIGxpbmVhciBhbGwnKTsKICAgICAgICAgICAgYXBwbGllZFN0eWxlcy5wdXNoKCd0cmFuc2l0aW9uJyk7CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50LmNzcyhzdHlsZXMpOwogICAgICAgIH0KCiAgICAgICAgdmFyIG1heERlbGF5ID0gTWF0aC5tYXgodGltaW5ncy50cmFuc2l0aW9uRGVsYXksIHRpbWluZ3MuYW5pbWF0aW9uRGVsYXkpOwogICAgICAgIHZhciBtYXhEZWxheVRpbWUgPSBtYXhEZWxheSAqIE9ORV9TRUNPTkQ7CgogICAgICAgIGlmIChhcHBsaWVkU3R5bGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIC8vdGhlIGVsZW1lbnQgYmVpbmcgYW5pbWF0ZWQgbWF5IHNvbWV0aW1lcyBjb250YWluIGNvbW1lbnQgbm9kZXMgaW4KICAgICAgICAgIC8vdGhlIGpxTGl0ZSBvYmplY3QsIHNvIHdlJ3JlIHNhZmUgdG8gdXNlIGEgc2luZ2xlIHZhcmlhYmxlIHRvIGhvdXNlCiAgICAgICAgICAvL3RoZSBzdHlsZXMgc2luY2UgdGhlcmUgaXMgYWx3YXlzIG9ubHkgb25lIGVsZW1lbnQgYmVpbmcgYW5pbWF0ZWQKICAgICAgICAgIHZhciBvbGRTdHlsZSA9IG5vZGUuZ2V0QXR0cmlidXRlKCdzdHlsZScpIHx8ICcnOwogICAgICAgICAgaWYgKG9sZFN0eWxlLmNoYXJBdChvbGRTdHlsZS5sZW5ndGgtMSkgIT09ICc7JykgewogICAgICAgICAgICBvbGRTdHlsZSArPSAnOyc7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZSgnc3R5bGUnLCBvbGRTdHlsZSArICcgJyArIHN0eWxlKTsKICAgICAgICB9CgogICAgICAgIHZhciBzdGFydFRpbWUgPSBEYXRlLm5vdygpOwogICAgICAgIHZhciBjc3MzQW5pbWF0aW9uRXZlbnRzID0gQU5JTUFUSU9ORU5EX0VWRU5UICsgJyAnICsgVFJBTlNJVElPTkVORF9FVkVOVDsKICAgICAgICB2YXIgYW5pbWF0aW9uVGltZSAgICAgPSAobWF4RGVsYXkgKyBtYXhEdXJhdGlvbikgKiBDTE9TSU5HX1RJTUVfQlVGRkVSOwogICAgICAgIHZhciB0b3RhbFRpbWUgICAgICAgICA9IChzdGFnZ2VyVGltZSArIGFuaW1hdGlvblRpbWUpICogT05FX1NFQ09ORDsKCiAgICAgICAgdmFyIHN0YWdnZXJUaW1lb3V0OwogICAgICAgIGlmIChzdGFnZ2VyVGltZSA+IDApIHsKICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MocGVuZGluZ0NsYXNzTmFtZSk7CiAgICAgICAgICBzdGFnZ2VyVGltZW91dCA9ICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzdGFnZ2VyVGltZW91dCA9IG51bGw7CgogICAgICAgICAgICBpZiAodGltaW5ncy50cmFuc2l0aW9uRHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgYmxvY2tUcmFuc2l0aW9ucyhub2RlLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRpbWluZ3MuYW5pbWF0aW9uRHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgYmxvY2tBbmltYXRpb25zKG5vZGUsIGZhbHNlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhhY3RpdmVDbGFzc05hbWUpOwogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKHBlbmRpbmdDbGFzc05hbWUpOwoKICAgICAgICAgICAgaWYgKHN0eWxlcykgewogICAgICAgICAgICAgIGlmICh0aW1pbmdzLnRyYW5zaXRpb25EdXJhdGlvbiA9PT0gMCkgewogICAgICAgICAgICAgICAgZWxlbWVudC5jc3MoJ3RyYW5zaXRpb24nLCB0aW1pbmdzLmFuaW1hdGlvbkR1cmF0aW9uICsgJ3MgbGluZWFyIGFsbCcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbGVtZW50LmNzcyhzdHlsZXMpOwogICAgICAgICAgICAgIGFwcGxpZWRTdHlsZXMucHVzaCgndHJhbnNpdGlvbicpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCBzdGFnZ2VyVGltZSAqIE9ORV9TRUNPTkQsIGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQub24oY3NzM0FuaW1hdGlvbkV2ZW50cywgb25BbmltYXRpb25Qcm9ncmVzcyk7CiAgICAgICAgZWxlbWVudERhdGEuY2xvc2VBbmltYXRpb25GbnMucHVzaChmdW5jdGlvbigpIHsKICAgICAgICAgIG9uRW5kKCk7CiAgICAgICAgICBhY3RpdmVBbmltYXRpb25Db21wbGV0ZSgpOwogICAgICAgIH0pOwoKICAgICAgICBlbGVtZW50RGF0YS5ydW5uaW5nKys7CiAgICAgICAgYW5pbWF0aW9uQ2xvc2VIYW5kbGVyKGVsZW1lbnQsIHRvdGFsVGltZSk7CiAgICAgICAgcmV0dXJuIG9uRW5kOwoKICAgICAgICAvLyBUaGlzIHdpbGwgYXV0b21hdGljYWxseSBiZSBjYWxsZWQgYnkgJGFuaW1hdGUgc28KICAgICAgICAvLyB0aGVyZSBpcyBubyBuZWVkIHRvIGF0dGFjaCB0aGlzIGludGVybmFsbHkgdG8gdGhlCiAgICAgICAgLy8gdGltZW91dCBkb25lIG1ldGhvZC4KICAgICAgICBmdW5jdGlvbiBvbkVuZCgpIHsKICAgICAgICAgIGVsZW1lbnQub2ZmKGNzczNBbmltYXRpb25FdmVudHMsIG9uQW5pbWF0aW9uUHJvZ3Jlc3MpOwogICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhhY3RpdmVDbGFzc05hbWUpOwogICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhwZW5kaW5nQ2xhc3NOYW1lKTsKICAgICAgICAgIGlmIChzdGFnZ2VyVGltZW91dCkgewogICAgICAgICAgICAkdGltZW91dC5jYW5jZWwoc3RhZ2dlclRpbWVvdXQpOwogICAgICAgICAgfQogICAgICAgICAgYW5pbWF0ZUNsb3NlKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICB2YXIgbm9kZSA9IGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KTsKICAgICAgICAgIGZvciAodmFyIGkgaW4gYXBwbGllZFN0eWxlcykgewogICAgICAgICAgICBub2RlLnN0eWxlLnJlbW92ZVByb3BlcnR5KGFwcGxpZWRTdHlsZXNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gb25BbmltYXRpb25Qcm9ncmVzcyhldmVudCkgewogICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICB2YXIgZXYgPSBldmVudC5vcmlnaW5hbEV2ZW50IHx8IGV2ZW50OwogICAgICAgICAgdmFyIHRpbWVTdGFtcCA9IGV2LiRtYW51YWxUaW1lU3RhbXAgfHwgZXYudGltZVN0YW1wIHx8IERhdGUubm93KCk7CgogICAgICAgICAgLyogRmlyZWZveCAob3IgcG9zc2libHkganVzdCBHZWNrbykgbGlrZXMgdG8gbm90IHJvdW5kIHZhbHVlcyB1cAogICAgICAgICAgICogd2hlbiBhIG1zIG1lYXN1cmVtZW50IGlzIHVzZWQgZm9yIHRoZSBhbmltYXRpb24gKi8KICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IHBhcnNlRmxvYXQoZXYuZWxhcHNlZFRpbWUudG9GaXhlZChFTEFQU0VEX1RJTUVfTUFYX0RFQ0lNQUxfUExBQ0VTKSk7CgogICAgICAgICAgLyogJG1hbnVhbFRpbWVTdGFtcCBpcyBhIG1vY2tlZCB0aW1lU3RhbXAgdmFsdWUgd2hpY2ggaXMgc2V0CiAgICAgICAgICAgKiB3aXRoaW4gYnJvd3NlclRyaWdnZXIoKS4gVGhpcyBpcyBvbmx5IGhlcmUgc28gdGhhdCB0ZXN0cyBjYW4KICAgICAgICAgICAqIG1vY2sgYW5pbWF0aW9ucyBwcm9wZXJseS4gUmVhbCBldmVudHMgZmFsbGJhY2sgdG8gZXZlbnQudGltZVN0YW1wLAogICAgICAgICAgICogb3IsIGlmIHRoZXkgZG9uJ3QsIHRoZW4gYSB0aW1lU3RhbXAgaXMgYXV0b21hdGljYWxseSBjcmVhdGVkIGZvciB0aGVtLgogICAgICAgICAgICogV2UncmUgY2hlY2tpbmcgdG8gc2VlIGlmIHRoZSB0aW1lU3RhbXAgc3VycGFzc2VzIHRoZSBleHBlY3RlZCBkZWxheSwKICAgICAgICAgICAqIGJ1dCB3ZSdyZSB1c2luZyBlbGFwc2VkVGltZSBpbnN0ZWFkIG9mIHRoZSB0aW1lU3RhbXAgb24gdGhlIDJuZAogICAgICAgICAgICogcHJlLWNvbmRpdGlvbiBzaW5jZSBhbmltYXRpb25zIHNvbWV0aW1lcyBjbG9zZSBvZmYgZWFybHkgKi8KICAgICAgICAgIGlmIChNYXRoLm1heCh0aW1lU3RhbXAgLSBzdGFydFRpbWUsIDApID49IG1heERlbGF5VGltZSAmJiBlbGFwc2VkVGltZSA+PSBtYXhEdXJhdGlvbikgewogICAgICAgICAgICBhY3RpdmVBbmltYXRpb25Db21wbGV0ZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gYmxvY2tUcmFuc2l0aW9ucyhub2RlLCBib29sKSB7CiAgICAgICAgbm9kZS5zdHlsZVtUUkFOU0lUSU9OX1BST1AgKyBQUk9QRVJUWV9LRVldID0gYm9vbCA/ICdub25lJyA6ICcnOwogICAgICB9CgogICAgICBmdW5jdGlvbiBibG9ja0FuaW1hdGlvbnMobm9kZSwgYm9vbCkgewogICAgICAgIG5vZGUuc3R5bGVbQU5JTUFUSU9OX1BST1AgKyBBTklNQVRJT05fUExBWVNUQVRFX0tFWV0gPSBib29sID8gJ3BhdXNlZCcgOiAnJzsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYW5pbWF0ZUJlZm9yZShhbmltYXRpb25FdmVudCwgZWxlbWVudCwgY2xhc3NOYW1lLCBzdHlsZXMpIHsKICAgICAgICBpZiAoYW5pbWF0ZVNldHVwKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIHN0eWxlcykpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbihjYW5jZWxsZWQpIHsKICAgICAgICAgICAgY2FuY2VsbGVkICYmIGFuaW1hdGVDbG9zZShlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFuaW1hdGVBZnRlcihhbmltYXRpb25FdmVudCwgZWxlbWVudCwgY2xhc3NOYW1lLCBhZnRlckFuaW1hdGlvbkNvbXBsZXRlLCBzdHlsZXMpIHsKICAgICAgICBpZiAoZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKSkgewogICAgICAgICAgcmV0dXJuIGFuaW1hdGVSdW4oYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgYWZ0ZXJBbmltYXRpb25Db21wbGV0ZSwgc3R5bGVzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYW5pbWF0ZUNsb3NlKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICBhZnRlckFuaW1hdGlvbkNvbXBsZXRlKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBhbmltYXRlKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlLCBvcHRpb25zKSB7CiAgICAgICAgLy9JZiB0aGUgYW5pbWF0ZVNldHVwIGZ1bmN0aW9uIGRvZXNuJ3QgYm90aGVyIHJldHVybmluZyBhCiAgICAgICAgLy9jYW5jZWxsYXRpb24gZnVuY3Rpb24gdGhlbiBpdCBtZWFucyB0aGF0IHRoZXJlIGlzIG5vIGFuaW1hdGlvbgogICAgICAgIC8vdG8gcGVyZm9ybSBhdCBhbGwKICAgICAgICB2YXIgcHJlUmVmbG93Q2FuY2VsbGF0aW9uID0gYW5pbWF0ZUJlZm9yZShhbmltYXRpb25FdmVudCwgZWxlbWVudCwgY2xhc3NOYW1lLCBvcHRpb25zLmZyb20pOwogICAgICAgIGlmICghcHJlUmVmbG93Q2FuY2VsbGF0aW9uKSB7CiAgICAgICAgICBjbGVhckNhY2hlQWZ0ZXJSZWZsb3coKTsKICAgICAgICAgIGFuaW1hdGlvbkNvbXBsZXRlKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvL1RoZXJlIGFyZSB0d28gY2FuY2VsbGF0aW9uIGZ1bmN0aW9uczogb25lIGlzIGJlZm9yZSB0aGUgZmlyc3QKICAgICAgICAvL3JlZmxvdyBhbmltYXRpb24gYW5kIHRoZSBzZWNvbmQgaXMgZHVyaW5nIHRoZSBhY3RpdmUgc3RhdGUKICAgICAgICAvL2FuaW1hdGlvbi4gVGhlIGZpcnN0IGZ1bmN0aW9uIHdpbGwgdGFrZSBjYXJlIG9mIHJlbW92aW5nIHRoZQogICAgICAgIC8vZGF0YSBmcm9tIHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgbm90IG1ha2UgdGhlIDJuZCBhbmltYXRpb24KICAgICAgICAvL2hhcHBlbiBpbiB0aGUgZmlyc3QgcGxhY2UKICAgICAgICB2YXIgY2FuY2VsID0gcHJlUmVmbG93Q2FuY2VsbGF0aW9uOwogICAgICAgIGFmdGVyUmVmbG93KGVsZW1lbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgLy9vbmNlIHRoZSByZWZsb3cgaXMgY29tcGxldGUgdGhlbiB3ZSBwb2ludCBjYW5jZWwgdG8KICAgICAgICAgIC8vdGhlIG5ldyBjYW5jZWxsYXRpb24gZnVuY3Rpb24gd2hpY2ggd2lsbCByZW1vdmUgYWxsIG9mIHRoZQogICAgICAgICAgLy9hbmltYXRpb24gcHJvcGVydGllcyBmcm9tIHRoZSBhY3RpdmUgYW5pbWF0aW9uCiAgICAgICAgICBjYW5jZWwgPSBhbmltYXRlQWZ0ZXIoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGUsIG9wdGlvbnMudG8pOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24oY2FuY2VsbGVkKSB7CiAgICAgICAgICAoY2FuY2VsIHx8IG5vb3ApKGNhbmNlbGxlZCk7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYW5pbWF0ZUNsb3NlKGVsZW1lbnQsIGNsYXNzTmFtZSkgewogICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSk7CiAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLnJ1bm5pbmcpIHsKICAgICAgICAgICAgZGF0YS5ydW5uaW5nLS07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWRhdGEucnVubmluZyB8fCBkYXRhLnJ1bm5pbmcgPT09IDApIHsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVEYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgYW5pbWF0ZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZnJvbSwgdG8sIGFuaW1hdGlvbkNvbXBsZXRlZCwgb3B0aW9ucykgewogICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICBvcHRpb25zLmZyb20gPSBmcm9tOwogICAgICAgICAgb3B0aW9ucy50byA9IHRvOwogICAgICAgICAgcmV0dXJuIGFuaW1hdGUoJ2FuaW1hdGUnLCBlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlZCwgb3B0aW9ucyk7CiAgICAgICAgfSwKCiAgICAgICAgZW50ZXIgOiBmdW5jdGlvbihlbGVtZW50LCBhbmltYXRpb25Db21wbGV0ZWQsIG9wdGlvbnMpIHsKICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgcmV0dXJuIGFuaW1hdGUoJ2VudGVyJywgZWxlbWVudCwgJ25nLWVudGVyJywgYW5pbWF0aW9uQ29tcGxldGVkLCBvcHRpb25zKTsKICAgICAgICB9LAoKICAgICAgICBsZWF2ZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGFuaW1hdGlvbkNvbXBsZXRlZCwgb3B0aW9ucykgewogICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICByZXR1cm4gYW5pbWF0ZSgnbGVhdmUnLCBlbGVtZW50LCAnbmctbGVhdmUnLCBhbmltYXRpb25Db21wbGV0ZWQsIG9wdGlvbnMpOwogICAgICAgIH0sCgogICAgICAgIG1vdmUgOiBmdW5jdGlvbihlbGVtZW50LCBhbmltYXRpb25Db21wbGV0ZWQsIG9wdGlvbnMpIHsKICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgcmV0dXJuIGFuaW1hdGUoJ21vdmUnLCBlbGVtZW50LCAnbmctbW92ZScsIGFuaW1hdGlvbkNvbXBsZXRlZCwgb3B0aW9ucyk7CiAgICAgICAgfSwKCiAgICAgICAgYmVmb3JlU2V0Q2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBhZGQsIHJlbW92ZSwgYW5pbWF0aW9uQ29tcGxldGVkLCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgIHZhciBjbGFzc05hbWUgPSBzdWZmaXhDbGFzc2VzKHJlbW92ZSwgJy1yZW1vdmUnKSArICcgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgc3VmZml4Q2xhc3NlcyhhZGQsICctYWRkJyk7CiAgICAgICAgICB2YXIgY2FuY2VsbGF0aW9uTWV0aG9kID0gYW5pbWF0ZUJlZm9yZSgnc2V0Q2xhc3MnLCBlbGVtZW50LCBjbGFzc05hbWUsIG9wdGlvbnMuZnJvbSk7CiAgICAgICAgICBpZiAoY2FuY2VsbGF0aW9uTWV0aG9kKSB7CiAgICAgICAgICAgIGFmdGVyUmVmbG93KGVsZW1lbnQsIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgICAgIHJldHVybiBjYW5jZWxsYXRpb25NZXRob2Q7CiAgICAgICAgICB9CiAgICAgICAgICBjbGVhckNhY2hlQWZ0ZXJSZWZsb3coKTsKICAgICAgICAgIGFuaW1hdGlvbkNvbXBsZXRlZCgpOwogICAgICAgIH0sCgogICAgICAgIGJlZm9yZUFkZENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBhbmltYXRpb25Db21wbGV0ZWQsIG9wdGlvbnMpIHsKICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgdmFyIGNhbmNlbGxhdGlvbk1ldGhvZCA9IGFuaW1hdGVCZWZvcmUoJ2FkZENsYXNzJywgZWxlbWVudCwgc3VmZml4Q2xhc3NlcyhjbGFzc05hbWUsICctYWRkJyksIG9wdGlvbnMuZnJvbSk7CiAgICAgICAgICBpZiAoY2FuY2VsbGF0aW9uTWV0aG9kKSB7CiAgICAgICAgICAgIGFmdGVyUmVmbG93KGVsZW1lbnQsIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgICAgIHJldHVybiBjYW5jZWxsYXRpb25NZXRob2Q7CiAgICAgICAgICB9CiAgICAgICAgICBjbGVhckNhY2hlQWZ0ZXJSZWZsb3coKTsKICAgICAgICAgIGFuaW1hdGlvbkNvbXBsZXRlZCgpOwogICAgICAgIH0sCgogICAgICAgIGJlZm9yZVJlbW92ZUNsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBhbmltYXRpb25Db21wbGV0ZWQsIG9wdGlvbnMpIHsKICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgdmFyIGNhbmNlbGxhdGlvbk1ldGhvZCA9IGFuaW1hdGVCZWZvcmUoJ3JlbW92ZUNsYXNzJywgZWxlbWVudCwgc3VmZml4Q2xhc3NlcyhjbGFzc05hbWUsICctcmVtb3ZlJyksIG9wdGlvbnMuZnJvbSk7CiAgICAgICAgICBpZiAoY2FuY2VsbGF0aW9uTWV0aG9kKSB7CiAgICAgICAgICAgIGFmdGVyUmVmbG93KGVsZW1lbnQsIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgICAgIHJldHVybiBjYW5jZWxsYXRpb25NZXRob2Q7CiAgICAgICAgICB9CiAgICAgICAgICBjbGVhckNhY2hlQWZ0ZXJSZWZsb3coKTsKICAgICAgICAgIGFuaW1hdGlvbkNvbXBsZXRlZCgpOwogICAgICAgIH0sCgogICAgICAgIHNldENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgYWRkLCByZW1vdmUsIGFuaW1hdGlvbkNvbXBsZXRlZCwgb3B0aW9ucykgewogICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICByZW1vdmUgPSBzdWZmaXhDbGFzc2VzKHJlbW92ZSwgJy1yZW1vdmUnKTsKICAgICAgICAgIGFkZCA9IHN1ZmZpeENsYXNzZXMoYWRkLCAnLWFkZCcpOwogICAgICAgICAgdmFyIGNsYXNzTmFtZSA9IHJlbW92ZSArICcgJyArIGFkZDsKICAgICAgICAgIHJldHVybiBhbmltYXRlQWZ0ZXIoJ3NldENsYXNzJywgZWxlbWVudCwgY2xhc3NOYW1lLCBhbmltYXRpb25Db21wbGV0ZWQsIG9wdGlvbnMudG8pOwogICAgICAgIH0sCgogICAgICAgIGFkZENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBhbmltYXRpb25Db21wbGV0ZWQsIG9wdGlvbnMpIHsKICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgcmV0dXJuIGFuaW1hdGVBZnRlcignYWRkQ2xhc3MnLCBlbGVtZW50LCBzdWZmaXhDbGFzc2VzKGNsYXNzTmFtZSwgJy1hZGQnKSwgYW5pbWF0aW9uQ29tcGxldGVkLCBvcHRpb25zLnRvKTsKICAgICAgICB9LAoKICAgICAgICByZW1vdmVDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGVkLCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgIHJldHVybiBhbmltYXRlQWZ0ZXIoJ3JlbW92ZUNsYXNzJywgZWxlbWVudCwgc3VmZml4Q2xhc3NlcyhjbGFzc05hbWUsICctcmVtb3ZlJyksIGFuaW1hdGlvbkNvbXBsZXRlZCwgb3B0aW9ucy50byk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgZnVuY3Rpb24gc3VmZml4Q2xhc3NlcyhjbGFzc2VzLCBzdWZmaXgpIHsKICAgICAgICB2YXIgY2xhc3NOYW1lID0gJyc7CiAgICAgICAgY2xhc3NlcyA9IGlzQXJyYXkoY2xhc3NlcykgPyBjbGFzc2VzIDogY2xhc3Nlcy5zcGxpdCgvXHMrLyk7CiAgICAgICAgZm9yRWFjaChjbGFzc2VzLCBmdW5jdGlvbihrbGFzcywgaSkgewogICAgICAgICAgaWYgKGtsYXNzICYmIGtsYXNzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgY2xhc3NOYW1lICs9IChpID4gMCA/ICcgJyA6ICcnKSArIGtsYXNzICsgc3VmZml4OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBjbGFzc05hbWU7CiAgICAgIH0KICAgIH1dKTsKICB9XSk7CgoKfSkod2luZG93LCB3aW5kb3cuYW5ndWxhcik7CgovKioKICogYW5ndWxhci1zdHJhcAogKiBAdmVyc2lvbiB2Mi4xLjIgLSAyMDE0LTEwLTE5CiAqIEBsaW5rIGh0dHA6Ly9tZ2NyZWEuZ2l0aHViLmlvL2FuZ3VsYXItc3RyYXAKICogQGF1dGhvciBPbGl2aWVyIExvdXZpZ25lcyAob2xpdmllckBtZy1jcmVhLmNvbSkKICogQGxpY2Vuc2UgTUlUIExpY2Vuc2UsIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUCiAqLwooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkKSB7Cid1c2Ugc3RyaWN0JzsKLy8gU291cmNlOiBtb2R1bGUuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwJywgWwogICdtZ2NyZWEubmdTdHJhcC5tb2RhbCcsCiAgJ21nY3JlYS5uZ1N0cmFwLmFzaWRlJywKICAnbWdjcmVhLm5nU3RyYXAuYWxlcnQnLAogICdtZ2NyZWEubmdTdHJhcC5idXR0b24nLAogICdtZ2NyZWEubmdTdHJhcC5zZWxlY3QnLAogICdtZ2NyZWEubmdTdHJhcC5kYXRlcGlja2VyJywKICAnbWdjcmVhLm5nU3RyYXAudGltZXBpY2tlcicsCiAgJ21nY3JlYS5uZ1N0cmFwLm5hdmJhcicsCiAgJ21nY3JlYS5uZ1N0cmFwLnRvb2x0aXAnLAogICdtZ2NyZWEubmdTdHJhcC5wb3BvdmVyJywKICAnbWdjcmVhLm5nU3RyYXAuZHJvcGRvd24nLAogICdtZ2NyZWEubmdTdHJhcC50eXBlYWhlYWQnLAogICdtZ2NyZWEubmdTdHJhcC5zY3JvbGxzcHknLAogICdtZ2NyZWEubmdTdHJhcC5hZmZpeCcsCiAgJ21nY3JlYS5uZ1N0cmFwLnRhYicsCiAgJ21nY3JlYS5uZ1N0cmFwLmNvbGxhcHNlJwpdKTsKCi8vIFNvdXJjZTogYWxlcnQuanMKLy8gQEJVRzogZm9sbG93aW5nIHNuaXBwZXQgd29uJ3QgY29tcGlsZSBjb3JyZWN0bHkKLy8gQFRPRE86IHN1Ym1pdCBpc3N1ZSB0byBjb3JlCi8vICc8c3BhbiBuZy1pZj0idGl0bGUiPjxzdHJvbmcgbmctYmluZD0idGl0bGUiPjwvc3Ryb25nPiZuYnNwOzwvc3Bhbj48c3BhbiBuZy1iaW5kLWh0bWw9ImNvbnRlbnQiPjwvc3Bhbj4nICsKCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5hbGVydCcsIFsnbWdjcmVhLm5nU3RyYXAubW9kYWwnXSkKCiAgLnByb3ZpZGVyKCckYWxlcnQnLCBmdW5jdGlvbigpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICBhbmltYXRpb246ICdhbS1mYWRlJywKICAgICAgcHJlZml4Q2xhc3M6ICdhbGVydCcsCiAgICAgIHByZWZpeEV2ZW50OiAnYWxlcnQnLAogICAgICBwbGFjZW1lbnQ6IG51bGwsCiAgICAgIHRlbXBsYXRlOiAnYWxlcnQvYWxlcnQudHBsLmh0bWwnLAogICAgICBjb250YWluZXI6IGZhbHNlLAogICAgICBlbGVtZW50OiBudWxsLAogICAgICBiYWNrZHJvcDogZmFsc2UsCiAgICAgIGtleWJvYXJkOiB0cnVlLAogICAgICBzaG93OiB0cnVlLAogICAgICAvLyBTcGVjaWZpYyBvcHRpb25zCiAgICAgIGR1cmF0aW9uOiBmYWxzZSwKICAgICAgdHlwZTogZmFsc2UsCiAgICAgIGRpc21pc3NhYmxlOiB0cnVlCiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsiJG1vZGFsIiwgIiR0aW1lb3V0IiwgZnVuY3Rpb24oJG1vZGFsLCAkdGltZW91dCkgewoKICAgICAgZnVuY3Rpb24gQWxlcnRGYWN0b3J5KGNvbmZpZykgewoKICAgICAgICB2YXIgJGFsZXJ0ID0ge307CgogICAgICAgIC8vIENvbW1vbiB2YXJzCiAgICAgICAgdmFyIG9wdGlvbnMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgZGVmYXVsdHMsIGNvbmZpZyk7CgogICAgICAgICRhbGVydCA9ICRtb2RhbChvcHRpb25zKTsKCiAgICAgICAgLy8gU3VwcG9ydCBzY29wZSBhcyBzdHJpbmcgb3B0aW9ucyBbLyp0aXRsZSwgY29udGVudCwgKi8gdHlwZSwgZGlzbWlzc2FibGVdCiAgICAgICAgJGFsZXJ0LiRzY29wZS5kaXNtaXNzYWJsZSA9ICEhb3B0aW9ucy5kaXNtaXNzYWJsZTsKICAgICAgICBpZihvcHRpb25zLnR5cGUpIHsKICAgICAgICAgICRhbGVydC4kc2NvcGUudHlwZSA9IG9wdGlvbnMudHlwZTsKICAgICAgICB9CgogICAgICAgIC8vIFN1cHBvcnQgYXV0by1jbG9zZSBkdXJhdGlvbgogICAgICAgIHZhciBzaG93ID0gJGFsZXJ0LnNob3c7CiAgICAgICAgaWYob3B0aW9ucy5kdXJhdGlvbikgewogICAgICAgICAgJGFsZXJ0LnNob3cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2hvdygpOwogICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAkYWxlcnQuaGlkZSgpOwogICAgICAgICAgICB9LCBvcHRpb25zLmR1cmF0aW9uICogMTAwMCk7CiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRhbGVydDsKCiAgICAgIH0KCiAgICAgIHJldHVybiBBbGVydEZhY3Rvcnk7CgogICAgfV07CgogIH0pCgogIC5kaXJlY3RpdmUoJ2JzQWxlcnQnLCBbIiR3aW5kb3ciLCAiJHNjZSIsICIkYWxlcnQiLCBmdW5jdGlvbigkd2luZG93LCAkc2NlLCAkYWxlcnQpIHsKCiAgICB2YXIgcmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gJHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgJHdpbmRvdy5zZXRUaW1lb3V0OwoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRUFDJywKICAgICAgc2NvcGU6IHRydWUsCiAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRyLCB0cmFuc2NsdXNpb24pIHsKCiAgICAgICAgLy8gRGlyZWN0aXZlIG9wdGlvbnMKICAgICAgICB2YXIgb3B0aW9ucyA9IHtzY29wZTogc2NvcGUsIGVsZW1lbnQ6IGVsZW1lbnQsIHNob3c6IGZhbHNlfTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goWyd0ZW1wbGF0ZScsICdwbGFjZW1lbnQnLCAna2V5Ym9hcmQnLCAnaHRtbCcsICdjb250YWluZXInLCAnYW5pbWF0aW9uJywgJ2R1cmF0aW9uJywgJ2Rpc21pc3NhYmxlJ10sIGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgaWYoYW5ndWxhci5pc0RlZmluZWQoYXR0cltrZXldKSkgb3B0aW9uc1trZXldID0gYXR0cltrZXldOwogICAgICAgIH0pOwoKICAgICAgICAvLyBTdXBwb3J0IHNjb3BlIGFzIGRhdGEtYXR0cnMKICAgICAgICBhbmd1bGFyLmZvckVhY2goWyd0aXRsZScsICdjb250ZW50JywgJ3R5cGUnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBhdHRyW2tleV0gJiYgYXR0ci4kb2JzZXJ2ZShrZXksIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICBzY29wZVtrZXldID0gJHNjZS50cnVzdEFzSHRtbChuZXdWYWx1ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gU3VwcG9ydCBzY29wZSBhcyBhbiBvYmplY3QKICAgICAgICBhdHRyLmJzQWxlcnQgJiYgc2NvcGUuJHdhdGNoKGF0dHIuYnNBbGVydCwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzT2JqZWN0KG5ld1ZhbHVlKSkgewogICAgICAgICAgICBhbmd1bGFyLmV4dGVuZChzY29wZSwgbmV3VmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2NvcGUuY29udGVudCA9IG5ld1ZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0sIHRydWUpOwoKICAgICAgICAvLyBJbml0aWFsaXplIGFsZXJ0CiAgICAgICAgdmFyIGFsZXJ0ID0gJGFsZXJ0KG9wdGlvbnMpOwoKICAgICAgICAvLyBUcmlnZ2VyCiAgICAgICAgZWxlbWVudC5vbihhdHRyLnRyaWdnZXIgfHwgJ2NsaWNrJywgYWxlcnQudG9nZ2xlKTsKCiAgICAgICAgLy8gR2FyYmFnZSBjb2xsZWN0aW9uCiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKGFsZXJ0KSBhbGVydC5kZXN0cm95KCk7CiAgICAgICAgICBvcHRpb25zID0gbnVsbDsKICAgICAgICAgIGFsZXJ0ID0gbnVsbDsKICAgICAgICB9KTsKCiAgICAgIH0KICAgIH07CgogIH1dKTsKCi8vIFNvdXJjZTogYWZmaXguanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLmFmZml4JywgWydtZ2NyZWEubmdTdHJhcC5oZWxwZXJzLmRpbWVuc2lvbnMnLCAnbWdjcmVhLm5nU3RyYXAuaGVscGVycy5kZWJvdW5jZSddKQoKICAucHJvdmlkZXIoJyRhZmZpeCcsIGZ1bmN0aW9uKCkgewoKICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgIG9mZnNldFRvcDogJ2F1dG8nCiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsiJHdpbmRvdyIsICJkZWJvdW5jZSIsICJkaW1lbnNpb25zIiwgZnVuY3Rpb24oJHdpbmRvdywgZGVib3VuY2UsIGRpbWVuc2lvbnMpIHsKCiAgICAgIHZhciBib2R5RWwgPSBhbmd1bGFyLmVsZW1lbnQoJHdpbmRvdy5kb2N1bWVudC5ib2R5KTsKICAgICAgdmFyIHdpbmRvd0VsID0gYW5ndWxhci5lbGVtZW50KCR3aW5kb3cpOwoKICAgICAgZnVuY3Rpb24gQWZmaXhGYWN0b3J5KGVsZW1lbnQsIGNvbmZpZykgewoKICAgICAgICB2YXIgJGFmZml4ID0ge307CgogICAgICAgIC8vIENvbW1vbiB2YXJzCiAgICAgICAgdmFyIG9wdGlvbnMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgZGVmYXVsdHMsIGNvbmZpZyk7CiAgICAgICAgdmFyIHRhcmdldEVsID0gb3B0aW9ucy50YXJnZXQ7CgogICAgICAgIC8vIEluaXRpYWwgcHJpdmF0ZSB2YXJzCiAgICAgICAgdmFyIHJlc2V0ID0gJ2FmZml4IGFmZml4LXRvcCBhZmZpeC1ib3R0b20nLAogICAgICAgICAgICBpbml0aWFsQWZmaXhUb3AgPSAwLAogICAgICAgICAgICBpbml0aWFsT2Zmc2V0VG9wID0gMCwKICAgICAgICAgICAgb2Zmc2V0VG9wID0gMCwKICAgICAgICAgICAgb2Zmc2V0Qm90dG9tID0gMCwKICAgICAgICAgICAgYWZmaXhlZCA9IG51bGwsCiAgICAgICAgICAgIHVucGluID0gbnVsbDsKCiAgICAgICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50KCk7CiAgICAgICAgLy8gT3B0aW9uczogY3VzdG9tIHBhcmVudAogICAgICAgIGlmIChvcHRpb25zLm9mZnNldFBhcmVudCkgewogICAgICAgICAgaWYgKG9wdGlvbnMub2Zmc2V0UGFyZW50Lm1hdGNoKC9eXGQrJC8pKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgKG9wdGlvbnMub2Zmc2V0UGFyZW50ICogMSkgLSAxOyBpKyspIHsKICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICBwYXJlbnQgPSBhbmd1bGFyLmVsZW1lbnQob3B0aW9ucy5vZmZzZXRQYXJlbnQpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgJGFmZml4LmluaXQgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAkYWZmaXguJHBhcnNlT2Zmc2V0cygpOwogICAgICAgICAgaW5pdGlhbE9mZnNldFRvcCA9IGRpbWVuc2lvbnMub2Zmc2V0KGVsZW1lbnRbMF0pLnRvcCArIGluaXRpYWxBZmZpeFRvcDsKCiAgICAgICAgICAvLyBCaW5kIGV2ZW50cwogICAgICAgICAgdGFyZ2V0RWwub24oJ3Njcm9sbCcsICRhZmZpeC5jaGVja1Bvc2l0aW9uKTsKICAgICAgICAgIHRhcmdldEVsLm9uKCdjbGljaycsICRhZmZpeC5jaGVja1Bvc2l0aW9uV2l0aEV2ZW50TG9vcCk7CiAgICAgICAgICB3aW5kb3dFbC5vbigncmVzaXplJywgJGFmZml4LiRkZWJvdW5jZWRPblJlc2l6ZSk7CgogICAgICAgICAgLy8gQm90aCBvZiB0aGVzZSBjaGVja1Bvc2l0aW9uKCkgY2FsbHMgYXJlIG5lY2Vzc2FyeSBmb3IgdGhlIGNhc2Ugd2hlcmUKICAgICAgICAgIC8vIHRoZSB1c2VyIGhpdHMgcmVmcmVzaCBhZnRlciBzY3JvbGxpbmcgdG8gdGhlIGJvdHRvbSBvZiB0aGUgcGFnZS4KICAgICAgICAgICRhZmZpeC5jaGVja1Bvc2l0aW9uKCk7CiAgICAgICAgICAkYWZmaXguY2hlY2tQb3NpdGlvbldpdGhFdmVudExvb3AoKTsKCiAgICAgICAgfTsKCiAgICAgICAgJGFmZml4LmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAvLyBVbmJpbmQgZXZlbnRzCiAgICAgICAgICB0YXJnZXRFbC5vZmYoJ3Njcm9sbCcsICRhZmZpeC5jaGVja1Bvc2l0aW9uKTsKICAgICAgICAgIHRhcmdldEVsLm9mZignY2xpY2snLCAkYWZmaXguY2hlY2tQb3NpdGlvbldpdGhFdmVudExvb3ApOwogICAgICAgICAgd2luZG93RWwub2ZmKCdyZXNpemUnLCAkYWZmaXguJGRlYm91bmNlZE9uUmVzaXplKTsKCiAgICAgICAgfTsKCiAgICAgICAgJGFmZml4LmNoZWNrUG9zaXRpb25XaXRoRXZlbnRMb29wID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgc2V0VGltZW91dCgkYWZmaXguY2hlY2tQb3NpdGlvbiwgMSk7CgogICAgICAgIH07CgogICAgICAgICRhZmZpeC5jaGVja1Bvc2l0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAvLyBpZiAoIXRoaXMuJGVsZW1lbnQuaXMoJzp2aXNpYmxlJykpIHJldHVybgoKICAgICAgICAgIHZhciBzY3JvbGxUb3AgPSBnZXRTY3JvbGxUb3AoKTsKICAgICAgICAgIHZhciBwb3NpdGlvbiA9IGRpbWVuc2lvbnMub2Zmc2V0KGVsZW1lbnRbMF0pOwogICAgICAgICAgdmFyIGVsZW1lbnRIZWlnaHQgPSBkaW1lbnNpb25zLmhlaWdodChlbGVtZW50WzBdKTsKCiAgICAgICAgICAvLyBHZXQgcmVxdWlyZWQgYWZmaXggY2xhc3MgYWNjb3JkaW5nIHRvIHBvc2l0aW9uCiAgICAgICAgICB2YXIgYWZmaXggPSBnZXRSZXF1aXJlZEFmZml4Q2xhc3ModW5waW4sIHBvc2l0aW9uLCBlbGVtZW50SGVpZ2h0KTsKCiAgICAgICAgICAvLyBEaWQgYWZmaXggc3RhdHVzIGNoYW5nZWQgdGhpcyBsYXN0IGNoZWNrPwogICAgICAgICAgaWYoYWZmaXhlZCA9PT0gYWZmaXgpIHJldHVybjsKICAgICAgICAgIGFmZml4ZWQgPSBhZmZpeDsKCiAgICAgICAgICAvLyBBZGQgcHJvcGVyIGFmZml4IGNsYXNzCiAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKHJlc2V0KS5hZGRDbGFzcygnYWZmaXgnICsgKChhZmZpeCAhPT0gJ21pZGRsZScpID8gJy0nICsgYWZmaXggOiAnJykpOwoKICAgICAgICAgIGlmKGFmZml4ID09PSAndG9wJykgewogICAgICAgICAgICB1bnBpbiA9IG51bGw7CiAgICAgICAgICAgIGVsZW1lbnQuY3NzKCdwb3NpdGlvbicsIChvcHRpb25zLm9mZnNldFBhcmVudCkgPyAnJyA6ICdyZWxhdGl2ZScpOwogICAgICAgICAgICBlbGVtZW50LmNzcygndG9wJywgJycpOwogICAgICAgICAgfSBlbHNlIGlmKGFmZml4ID09PSAnYm90dG9tJykgewogICAgICAgICAgICBpZiAob3B0aW9ucy5vZmZzZXRVbnBpbikgewogICAgICAgICAgICAgIHVucGluID0gLShvcHRpb25zLm9mZnNldFVucGluICogMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIHVucGluIHRocmVzaG9sZCB3aGVuIGFmZml4ZWQgdG8gYm90dG9tLgogICAgICAgICAgICAgIC8vIEhvcGVmdWxseSB0aGUgYnJvd3NlciBzY3JvbGxzIHBpeGVsIGJ5IHBpeGVsLgogICAgICAgICAgICAgIHVucGluID0gcG9zaXRpb24udG9wIC0gc2Nyb2xsVG9wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1lbnQuY3NzKCdwb3NpdGlvbicsIChvcHRpb25zLm9mZnNldFBhcmVudCkgPyAnJyA6ICdyZWxhdGl2ZScpOwogICAgICAgICAgICBlbGVtZW50LmNzcygndG9wJywgKG9wdGlvbnMub2Zmc2V0UGFyZW50KSA/ICcnIDogKChib2R5RWxbMF0ub2Zmc2V0SGVpZ2h0IC0gb2Zmc2V0Qm90dG9tIC0gZWxlbWVudEhlaWdodCAtIGluaXRpYWxPZmZzZXRUb3ApICsgJ3B4JykpOwogICAgICAgICAgfSBlbHNlIHsgLy8gYWZmaXggPT09ICdtaWRkbGUnCiAgICAgICAgICAgIHVucGluID0gbnVsbDsKICAgICAgICAgICAgZWxlbWVudC5jc3MoJ3Bvc2l0aW9uJywgJ2ZpeGVkJyk7CiAgICAgICAgICAgIGVsZW1lbnQuY3NzKCd0b3AnLCBpbml0aWFsQWZmaXhUb3AgKyAncHgnKTsKICAgICAgICAgIH0KCiAgICAgICAgfTsKCiAgICAgICAgJGFmZml4LiRvblJlc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgJGFmZml4LiRwYXJzZU9mZnNldHMoKTsKICAgICAgICAgICRhZmZpeC5jaGVja1Bvc2l0aW9uKCk7CiAgICAgICAgfTsKICAgICAgICAkYWZmaXguJGRlYm91bmNlZE9uUmVzaXplID0gZGVib3VuY2UoJGFmZml4LiRvblJlc2l6ZSwgNTApOwoKICAgICAgICAkYWZmaXguJHBhcnNlT2Zmc2V0cyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGluaXRpYWxQb3NpdGlvbiA9IGVsZW1lbnQuY3NzKCdwb3NpdGlvbicpOwogICAgICAgICAgLy8gUmVzZXQgcG9zaXRpb24gdG8gY2FsY3VsYXRlIGNvcnJlY3Qgb2Zmc2V0VG9wCiAgICAgICAgICBlbGVtZW50LmNzcygncG9zaXRpb24nLCAob3B0aW9ucy5vZmZzZXRQYXJlbnQpID8gJycgOiAncmVsYXRpdmUnKTsKCiAgICAgICAgICBpZihvcHRpb25zLm9mZnNldFRvcCkgewogICAgICAgICAgICBpZihvcHRpb25zLm9mZnNldFRvcCA9PT0gJ2F1dG8nKSB7CiAgICAgICAgICAgICAgb3B0aW9ucy5vZmZzZXRUb3AgPSAnKzAnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG9wdGlvbnMub2Zmc2V0VG9wLm1hdGNoKC9eWy0rXVxkKyQvKSkgewogICAgICAgICAgICAgIGluaXRpYWxBZmZpeFRvcCA9IC0gb3B0aW9ucy5vZmZzZXRUb3AgKiAxOwogICAgICAgICAgICAgIGlmKG9wdGlvbnMub2Zmc2V0UGFyZW50KSB7CiAgICAgICAgICAgICAgICBvZmZzZXRUb3AgPSBkaW1lbnNpb25zLm9mZnNldChwYXJlbnRbMF0pLnRvcCArIChvcHRpb25zLm9mZnNldFRvcCAqIDEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIG9mZnNldFRvcCA9IGRpbWVuc2lvbnMub2Zmc2V0KGVsZW1lbnRbMF0pLnRvcCAtIGRpbWVuc2lvbnMuY3NzKGVsZW1lbnRbMF0sICdtYXJnaW5Ub3AnLCB0cnVlKSArIChvcHRpb25zLm9mZnNldFRvcCAqIDEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBvZmZzZXRUb3AgPSBvcHRpb25zLm9mZnNldFRvcCAqIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZihvcHRpb25zLm9mZnNldEJvdHRvbSkgewogICAgICAgICAgICBpZihvcHRpb25zLm9mZnNldFBhcmVudCAmJiBvcHRpb25zLm9mZnNldEJvdHRvbS5tYXRjaCgvXlstK11cZCskLykpIHsKICAgICAgICAgICAgICAvLyBhZGQgMSBwaXhlbCBkdWUgdG8gcm91bmRpbmcgcHJvYmxlbXMuLi4KICAgICAgICAgICAgICBvZmZzZXRCb3R0b20gPSBnZXRTY3JvbGxIZWlnaHQoKSAtIChkaW1lbnNpb25zLm9mZnNldChwYXJlbnRbMF0pLnRvcCArIGRpbWVuc2lvbnMuaGVpZ2h0KHBhcmVudFswXSkpICsgKG9wdGlvbnMub2Zmc2V0Qm90dG9tICogMSkgKyAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIG9mZnNldEJvdHRvbSA9IG9wdGlvbnMub2Zmc2V0Qm90dG9tICogMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIEJyaW5nIGJhY2sgdGhlIGVsZW1lbnQncyBwb3NpdGlvbiBhZnRlciBjYWxjdWxhdGlvbnMKICAgICAgICAgIGVsZW1lbnQuY3NzKCdwb3NpdGlvbicsIGluaXRpYWxQb3NpdGlvbik7CiAgICAgICAgfTsKCiAgICAgICAgLy8gUHJpdmF0ZSBtZXRob2RzCgogICAgICAgIGZ1bmN0aW9uIGdldFJlcXVpcmVkQWZmaXhDbGFzcyh1bnBpbiwgcG9zaXRpb24sIGVsZW1lbnRIZWlnaHQpIHsKCiAgICAgICAgICB2YXIgc2Nyb2xsVG9wID0gZ2V0U2Nyb2xsVG9wKCk7CiAgICAgICAgICB2YXIgc2Nyb2xsSGVpZ2h0ID0gZ2V0U2Nyb2xsSGVpZ2h0KCk7CgogICAgICAgICAgaWYoc2Nyb2xsVG9wIDw9IG9mZnNldFRvcCkgewogICAgICAgICAgICByZXR1cm4gJ3RvcCc7CiAgICAgICAgICB9IGVsc2UgaWYodW5waW4gIT09IG51bGwgJiYgKHNjcm9sbFRvcCArIHVucGluIDw9IHBvc2l0aW9uLnRvcCkpIHsKICAgICAgICAgICAgcmV0dXJuICdtaWRkbGUnOwogICAgICAgICAgfSBlbHNlIGlmKG9mZnNldEJvdHRvbSAhPT0gbnVsbCAmJiAocG9zaXRpb24udG9wICsgZWxlbWVudEhlaWdodCArIGluaXRpYWxBZmZpeFRvcCA+PSBzY3JvbGxIZWlnaHQgLSBvZmZzZXRCb3R0b20pKSB7CiAgICAgICAgICAgIHJldHVybiAnYm90dG9tJzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAnbWlkZGxlJzsKICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRTY3JvbGxUb3AoKSB7CiAgICAgICAgICByZXR1cm4gdGFyZ2V0RWxbMF0gPT09ICR3aW5kb3cgPyAkd2luZG93LnBhZ2VZT2Zmc2V0IDogdGFyZ2V0RWxbMF0uc2Nyb2xsVG9wOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0U2Nyb2xsSGVpZ2h0KCkgewogICAgICAgICAgcmV0dXJuIHRhcmdldEVsWzBdID09PSAkd2luZG93ID8gJHdpbmRvdy5kb2N1bWVudC5ib2R5LnNjcm9sbEhlaWdodCA6IHRhcmdldEVsWzBdLnNjcm9sbEhlaWdodDsKICAgICAgICB9CgogICAgICAgICRhZmZpeC5pbml0KCk7CiAgICAgICAgcmV0dXJuICRhZmZpeDsKCiAgICAgIH0KCiAgICAgIHJldHVybiBBZmZpeEZhY3Rvcnk7CgogICAgfV07CgogIH0pCgogIC5kaXJlY3RpdmUoJ2JzQWZmaXgnLCBbIiRhZmZpeCIsICIkd2luZG93IiwgZnVuY3Rpb24oJGFmZml4LCAkd2luZG93KSB7CgogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFQUMnLAogICAgICByZXF1aXJlOiAnXj9ic0FmZml4VGFyZ2V0JywKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGFmZml4VGFyZ2V0KSB7CgogICAgICAgIHZhciBvcHRpb25zID0ge3Njb3BlOiBzY29wZSwgb2Zmc2V0VG9wOiAnYXV0bycsIHRhcmdldDogYWZmaXhUYXJnZXQgPyBhZmZpeFRhcmdldC4kZWxlbWVudCA6IGFuZ3VsYXIuZWxlbWVudCgkd2luZG93KX07CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsnb2Zmc2V0VG9wJywgJ29mZnNldEJvdHRvbScsICdvZmZzZXRQYXJlbnQnLCAnb2Zmc2V0VW5waW4nXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzRGVmaW5lZChhdHRyW2tleV0pKSBvcHRpb25zW2tleV0gPSBhdHRyW2tleV07CiAgICAgICAgfSk7CgogICAgICAgIHZhciBhZmZpeCA9ICRhZmZpeChlbGVtZW50LCBvcHRpb25zKTsKICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBhZmZpeCAmJiBhZmZpeC5kZXN0cm95KCk7CiAgICAgICAgICBvcHRpb25zID0gbnVsbDsKICAgICAgICAgIGFmZml4ID0gbnVsbDsKICAgICAgICB9KTsKCiAgICAgIH0KICAgIH07CgogIH1dKQoKICAuZGlyZWN0aXZlKCdic0FmZml4VGFyZ2V0JywgZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICBjb250cm9sbGVyOiBbIiRlbGVtZW50IiwgZnVuY3Rpb24oJGVsZW1lbnQpIHsKICAgICAgICB0aGlzLiRlbGVtZW50ID0gJGVsZW1lbnQ7CiAgICAgIH1dCiAgICB9OwogIH0pOwoKLy8gU291cmNlOiBhc2lkZS5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAuYXNpZGUnLCBbJ21nY3JlYS5uZ1N0cmFwLm1vZGFsJ10pCgogIC5wcm92aWRlcignJGFzaWRlJywgZnVuY3Rpb24oKSB7CgogICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgYW5pbWF0aW9uOiAnYW0tZmFkZS1hbmQtc2xpZGUtcmlnaHQnLAogICAgICBwcmVmaXhDbGFzczogJ2FzaWRlJywKICAgICAgcHJlZml4RXZlbnQ6ICdhc2lkZScsCiAgICAgIHBsYWNlbWVudDogJ3JpZ2h0JywKICAgICAgdGVtcGxhdGU6ICdhc2lkZS9hc2lkZS50cGwuaHRtbCcsCiAgICAgIGNvbnRlbnRUZW1wbGF0ZTogZmFsc2UsCiAgICAgIGNvbnRhaW5lcjogZmFsc2UsCiAgICAgIGVsZW1lbnQ6IG51bGwsCiAgICAgIGJhY2tkcm9wOiB0cnVlLAogICAgICBrZXlib2FyZDogdHJ1ZSwKICAgICAgaHRtbDogZmFsc2UsCiAgICAgIHNob3c6IHRydWUKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gWyIkbW9kYWwiLCBmdW5jdGlvbigkbW9kYWwpIHsKCiAgICAgIGZ1bmN0aW9uIEFzaWRlRmFjdG9yeShjb25maWcpIHsKCiAgICAgICAgdmFyICRhc2lkZSA9IHt9OwoKICAgICAgICAvLyBDb21tb24gdmFycwogICAgICAgIHZhciBvcHRpb25zID0gYW5ndWxhci5leHRlbmQoe30sIGRlZmF1bHRzLCBjb25maWcpOwoKICAgICAgICAkYXNpZGUgPSAkbW9kYWwob3B0aW9ucyk7CgogICAgICAgIHJldHVybiAkYXNpZGU7CgogICAgICB9CgogICAgICByZXR1cm4gQXNpZGVGYWN0b3J5OwoKICAgIH1dOwoKICB9KQoKICAuZGlyZWN0aXZlKCdic0FzaWRlJywgWyIkd2luZG93IiwgIiRzY2UiLCAiJGFzaWRlIiwgZnVuY3Rpb24oJHdpbmRvdywgJHNjZSwgJGFzaWRlKSB7CgogICAgdmFyIHJlcXVlc3RBbmltYXRpb25GcmFtZSA9ICR3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8ICR3aW5kb3cuc2V0VGltZW91dDsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0VBQycsCiAgICAgIHNjb3BlOiB0cnVlLAogICAgICBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgZWxlbWVudCwgYXR0ciwgdHJhbnNjbHVzaW9uKSB7CiAgICAgICAgLy8gRGlyZWN0aXZlIG9wdGlvbnMKICAgICAgICB2YXIgb3B0aW9ucyA9IHtzY29wZTogc2NvcGUsIGVsZW1lbnQ6IGVsZW1lbnQsIHNob3c6IGZhbHNlfTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goWyd0ZW1wbGF0ZScsICdjb250ZW50VGVtcGxhdGUnLCAncGxhY2VtZW50JywgJ2JhY2tkcm9wJywgJ2tleWJvYXJkJywgJ2h0bWwnLCAnY29udGFpbmVyJywgJ2FuaW1hdGlvbiddLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNEZWZpbmVkKGF0dHJba2V5XSkpIG9wdGlvbnNba2V5XSA9IGF0dHJba2V5XTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gU3VwcG9ydCBzY29wZSBhcyBkYXRhLWF0dHJzCiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsndGl0bGUnLCAnY29udGVudCddLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGF0dHJba2V5XSAmJiBhdHRyLiRvYnNlcnZlKGtleSwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgIHNjb3BlW2tleV0gPSAkc2NlLnRydXN0QXNIdG1sKG5ld1ZhbHVlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyBTdXBwb3J0IHNjb3BlIGFzIGFuIG9iamVjdAogICAgICAgIGF0dHIuYnNBc2lkZSAmJiBzY29wZS4kd2F0Y2goYXR0ci5ic0FzaWRlLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNPYmplY3QobmV3VmFsdWUpKSB7CiAgICAgICAgICAgIGFuZ3VsYXIuZXh0ZW5kKHNjb3BlLCBuZXdWYWx1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzY29wZS5jb250ZW50ID0gbmV3VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSwgdHJ1ZSk7CgogICAgICAgIC8vIEluaXRpYWxpemUgYXNpZGUKICAgICAgICB2YXIgYXNpZGUgPSAkYXNpZGUob3B0aW9ucyk7CgogICAgICAgIC8vIFRyaWdnZXIKICAgICAgICBlbGVtZW50Lm9uKGF0dHIudHJpZ2dlciB8fCAnY2xpY2snLCBhc2lkZS50b2dnbGUpOwoKICAgICAgICAvLyBHYXJiYWdlIGNvbGxlY3Rpb24KICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoYXNpZGUpIGFzaWRlLmRlc3Ryb3koKTsKICAgICAgICAgIG9wdGlvbnMgPSBudWxsOwogICAgICAgICAgYXNpZGUgPSBudWxsOwogICAgICAgIH0pOwoKICAgICAgfQogICAgfTsKCiAgfV0pOwoKLy8gU291cmNlOiBidXR0b24uanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLmJ1dHRvbicsIFtdKQoKICAucHJvdmlkZXIoJyRidXR0b24nLCBmdW5jdGlvbigpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICBhY3RpdmVDbGFzczonYWN0aXZlJywKICAgICAgdG9nZ2xlRXZlbnQ6J2NsaWNrJwogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHtkZWZhdWx0czogZGVmYXVsdHN9OwogICAgfTsKCiAgfSkKCiAgLmRpcmVjdGl2ZSgnYnNDaGVja2JveEdyb3VwJywgZnVuY3Rpb24oKSB7CgogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgICBjb21waWxlOiBmdW5jdGlvbiBwb3N0TGluayhlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgZWxlbWVudC5hdHRyKCdkYXRhLXRvZ2dsZScsICdidXR0b25zJyk7CiAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyKCduZy1tb2RlbCcpOwogICAgICAgIHZhciBjaGlsZHJlbiA9IGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvckFsbCgnaW5wdXRbdHlwZT0iY2hlY2tib3giXScpOwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChjaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICAgIHZhciBjaGlsZEVsID0gYW5ndWxhci5lbGVtZW50KGNoaWxkKTsKICAgICAgICAgIGNoaWxkRWwuYXR0cignYnMtY2hlY2tib3gnLCAnJyk7CiAgICAgICAgICBjaGlsZEVsLmF0dHIoJ25nLW1vZGVsJywgYXR0ci5uZ01vZGVsICsgJy4nICsgY2hpbGRFbC5hdHRyKCd2YWx1ZScpKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgIH07CgogIH0pCgogIC5kaXJlY3RpdmUoJ2JzQ2hlY2tib3gnLCBbIiRidXR0b24iLCAiJCRyQUYiLCBmdW5jdGlvbigkYnV0dG9uLCAkJHJBRikgewoKICAgIHZhciBkZWZhdWx0cyA9ICRidXR0b24uZGVmYXVsdHM7CiAgICB2YXIgY29uc3RhbnRWYWx1ZVJlZ0V4cCA9IC9eKHRydWV8ZmFsc2V8XGQrKSQvOwoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgIHJlcXVpcmU6ICduZ01vZGVsJywKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGNvbnRyb2xsZXIpIHsKCiAgICAgICAgdmFyIG9wdGlvbnMgPSBkZWZhdWx0czsKCiAgICAgICAgLy8gU3VwcG9ydCBsYWJlbCA+IGlucHV0W3R5cGU9ImNoZWNrYm94Il0KICAgICAgICB2YXIgaXNJbnB1dCA9IGVsZW1lbnRbMF0ubm9kZU5hbWUgPT09ICdJTlBVVCc7CiAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnQgPSBpc0lucHV0ID8gZWxlbWVudC5wYXJlbnQoKSA6IGVsZW1lbnQ7CgogICAgICAgIHZhciB0cnVlVmFsdWUgPSBhbmd1bGFyLmlzRGVmaW5lZChhdHRyLnRydWVWYWx1ZSkgPyBhdHRyLnRydWVWYWx1ZSA6IHRydWU7CiAgICAgICAgaWYoY29uc3RhbnRWYWx1ZVJlZ0V4cC50ZXN0KGF0dHIudHJ1ZVZhbHVlKSkgewogICAgICAgICAgdHJ1ZVZhbHVlID0gc2NvcGUuJGV2YWwoYXR0ci50cnVlVmFsdWUpOwogICAgICAgIH0KICAgICAgICB2YXIgZmFsc2VWYWx1ZSA9IGFuZ3VsYXIuaXNEZWZpbmVkKGF0dHIuZmFsc2VWYWx1ZSkgPyBhdHRyLmZhbHNlVmFsdWUgOiBmYWxzZTsKICAgICAgICBpZihjb25zdGFudFZhbHVlUmVnRXhwLnRlc3QoYXR0ci5mYWxzZVZhbHVlKSkgewogICAgICAgICAgZmFsc2VWYWx1ZSA9IHNjb3BlLiRldmFsKGF0dHIuZmFsc2VWYWx1ZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBQYXJzZSBleG90aWMgdmFsdWVzCiAgICAgICAgdmFyIGhhc0V4b3RpY1ZhbHVlcyA9IHR5cGVvZiB0cnVlVmFsdWUgIT09ICdib29sZWFuJyB8fCB0eXBlb2YgZmFsc2VWYWx1ZSAhPT0gJ2Jvb2xlYW4nOwogICAgICAgIGlmKGhhc0V4b3RpY1ZhbHVlcykgewogICAgICAgICAgY29udHJvbGxlci4kcGFyc2Vycy5wdXNoKGZ1bmN0aW9uKHZpZXdWYWx1ZSkgewogICAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRwYXJzZXInLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksICd2aWV3VmFsdWUnLCB2aWV3VmFsdWUpOwogICAgICAgICAgICByZXR1cm4gdmlld1ZhbHVlID8gdHJ1ZVZhbHVlIDogZmFsc2VWYWx1ZTsKICAgICAgICAgIH0pOwogICAgICAgICAgLy8gbW9kZWxWYWx1ZSAtPiAkZm9ybWF0dGVycyAtPiB2aWV3VmFsdWUKICAgICAgICAgIGNvbnRyb2xsZXIuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbihtb2RlbFZhbHVlKSB7CiAgICAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRmb3JtYXR0ZXIoIiVzIik6IG1vZGVsVmFsdWU9JW8gKCVvKScsIGVsZW1lbnQuYXR0cignbmctbW9kZWwnKSwgbW9kZWxWYWx1ZSwgdHlwZW9mIG1vZGVsVmFsdWUpOwogICAgICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuZXF1YWxzKG1vZGVsVmFsdWUsIHRydWVWYWx1ZSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIC8vIEZpeCByZW5kZXJpbmcgZm9yIGV4b3RpYyB2YWx1ZXMKICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nTW9kZWwsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICBjb250cm9sbGVyLiRyZW5kZXIoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gbW9kZWwgLT4gdmlldwogICAgICAgIGNvbnRyb2xsZXIuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2FybignJHJlbmRlcicsIGVsZW1lbnQuYXR0cignbmctbW9kZWwnKSwgJ2NvbnRyb2xsZXIuJG1vZGVsVmFsdWUnLCB0eXBlb2YgY29udHJvbGxlci4kbW9kZWxWYWx1ZSwgY29udHJvbGxlci4kbW9kZWxWYWx1ZSwgJ2NvbnRyb2xsZXIuJHZpZXdWYWx1ZScsIHR5cGVvZiBjb250cm9sbGVyLiR2aWV3VmFsdWUsIGNvbnRyb2xsZXIuJHZpZXdWYWx1ZSk7CiAgICAgICAgICB2YXIgaXNBY3RpdmUgPSBhbmd1bGFyLmVxdWFscyhjb250cm9sbGVyLiRtb2RlbFZhbHVlLCB0cnVlVmFsdWUpOwogICAgICAgICAgJCRyQUYoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKGlzSW5wdXQpIGVsZW1lbnRbMF0uY2hlY2tlZCA9IGlzQWN0aXZlOwogICAgICAgICAgICBhY3RpdmVFbGVtZW50LnRvZ2dsZUNsYXNzKG9wdGlvbnMuYWN0aXZlQ2xhc3MsIGlzQWN0aXZlKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIC8vIHZpZXcgLT4gbW9kZWwKICAgICAgICBlbGVtZW50LmJpbmQob3B0aW9ucy50b2dnbGVFdmVudCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyFjbGljaycsIGVsZW1lbnQuYXR0cignbmctbW9kZWwnKSwgJ2NvbnRyb2xsZXIuJHZpZXdWYWx1ZScsIHR5cGVvZiBjb250cm9sbGVyLiR2aWV3VmFsdWUsIGNvbnRyb2xsZXIuJHZpZXdWYWx1ZSwgJ2NvbnRyb2xsZXIuJG1vZGVsVmFsdWUnLCB0eXBlb2YgY29udHJvbGxlci4kbW9kZWxWYWx1ZSwgY29udHJvbGxlci4kbW9kZWxWYWx1ZSk7CiAgICAgICAgICAgIGlmKCFpc0lucHV0KSB7CiAgICAgICAgICAgICAgY29udHJvbGxlci4kc2V0Vmlld1ZhbHVlKCFhY3RpdmVFbGVtZW50Lmhhc0NsYXNzKCdhY3RpdmUnKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIWhhc0V4b3RpY1ZhbHVlcykgewogICAgICAgICAgICAgIGNvbnRyb2xsZXIuJHJlbmRlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgIH0KCiAgICB9OwoKICB9XSkKCiAgLmRpcmVjdGl2ZSgnYnNSYWRpb0dyb3VwJywgZnVuY3Rpb24oKSB7CgogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgICBjb21waWxlOiBmdW5jdGlvbiBwb3N0TGluayhlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgZWxlbWVudC5hdHRyKCdkYXRhLXRvZ2dsZScsICdidXR0b25zJyk7CiAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyKCduZy1tb2RlbCcpOwogICAgICAgIHZhciBjaGlsZHJlbiA9IGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvckFsbCgnaW5wdXRbdHlwZT0icmFkaW8iXScpOwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChjaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudChjaGlsZCkuYXR0cignYnMtcmFkaW8nLCAnJyk7CiAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoY2hpbGQpLmF0dHIoJ25nLW1vZGVsJywgYXR0ci5uZ01vZGVsKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgIH07CgogIH0pCgogIC5kaXJlY3RpdmUoJ2JzUmFkaW8nLCBbIiRidXR0b24iLCAiJCRyQUYiLCBmdW5jdGlvbigkYnV0dG9uLCAkJHJBRikgewoKICAgIHZhciBkZWZhdWx0cyA9ICRidXR0b24uZGVmYXVsdHM7CiAgICB2YXIgY29uc3RhbnRWYWx1ZVJlZ0V4cCA9IC9eKHRydWV8ZmFsc2V8XGQrKSQvOwoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgIHJlcXVpcmU6ICduZ01vZGVsJywKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGNvbnRyb2xsZXIpIHsKCiAgICAgICAgdmFyIG9wdGlvbnMgPSBkZWZhdWx0czsKCiAgICAgICAgLy8gU3VwcG9ydCBgbGFiZWwgPiBpbnB1dFt0eXBlPSJyYWRpbyJdYCBtYXJrdXAKICAgICAgICB2YXIgaXNJbnB1dCA9IGVsZW1lbnRbMF0ubm9kZU5hbWUgPT09ICdJTlBVVCc7CiAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnQgPSBpc0lucHV0ID8gZWxlbWVudC5wYXJlbnQoKSA6IGVsZW1lbnQ7CgogICAgICAgIHZhciB2YWx1ZSA9IGNvbnN0YW50VmFsdWVSZWdFeHAudGVzdChhdHRyLnZhbHVlKSA/IHNjb3BlLiRldmFsKGF0dHIudmFsdWUpIDogYXR0ci52YWx1ZTsKCiAgICAgICAgLy8gbW9kZWwgLT4gdmlldwogICAgICAgIGNvbnRyb2xsZXIuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2FybignJHJlbmRlcicsIGVsZW1lbnQuYXR0cigndmFsdWUnKSwgJ2NvbnRyb2xsZXIuJG1vZGVsVmFsdWUnLCB0eXBlb2YgY29udHJvbGxlci4kbW9kZWxWYWx1ZSwgY29udHJvbGxlci4kbW9kZWxWYWx1ZSwgJ2NvbnRyb2xsZXIuJHZpZXdWYWx1ZScsIHR5cGVvZiBjb250cm9sbGVyLiR2aWV3VmFsdWUsIGNvbnRyb2xsZXIuJHZpZXdWYWx1ZSk7CiAgICAgICAgICB2YXIgaXNBY3RpdmUgPSBhbmd1bGFyLmVxdWFscyhjb250cm9sbGVyLiRtb2RlbFZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICAkJHJBRihmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYoaXNJbnB1dCkgZWxlbWVudFswXS5jaGVja2VkID0gaXNBY3RpdmU7CiAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQudG9nZ2xlQ2xhc3Mob3B0aW9ucy5hY3RpdmVDbGFzcywgaXNBY3RpdmUpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gdmlldyAtPiBtb2RlbAogICAgICAgIGVsZW1lbnQuYmluZChvcHRpb25zLnRvZ2dsZUV2ZW50LCBmdW5jdGlvbigpIHsKICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vIGNvbnNvbGUud2FybignIWNsaWNrJywgZWxlbWVudC5hdHRyKCd2YWx1ZScpLCAnY29udHJvbGxlci4kdmlld1ZhbHVlJywgdHlwZW9mIGNvbnRyb2xsZXIuJHZpZXdWYWx1ZSwgY29udHJvbGxlci4kdmlld1ZhbHVlLCAnY29udHJvbGxlci4kbW9kZWxWYWx1ZScsIHR5cGVvZiBjb250cm9sbGVyLiRtb2RlbFZhbHVlLCBjb250cm9sbGVyLiRtb2RlbFZhbHVlKTsKICAgICAgICAgICAgY29udHJvbGxlci4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgY29udHJvbGxlci4kcmVuZGVyKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgIH0KCiAgICB9OwoKICB9XSk7CgovLyBTb3VyY2U6IGNvbGxhcHNlLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5jb2xsYXBzZScsIFtdKQoKICAucHJvdmlkZXIoJyRjb2xsYXBzZScsIGZ1bmN0aW9uKCkgewoKICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgIGFuaW1hdGlvbjogJ2FtLWNvbGxhcHNlJywKICAgICAgZGlzYWxsb3dUb2dnbGU6IGZhbHNlLAogICAgICBhY3RpdmVDbGFzczogJ2luJywKICAgICAgc3RhcnRDb2xsYXBzZWQ6IGZhbHNlCiAgICB9OwoKICAgIHZhciBjb250cm9sbGVyID0gdGhpcy5jb250cm9sbGVyID0gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIC8vIEF0dHJpYnV0ZXMgb3B0aW9ucwogICAgICBzZWxmLiRvcHRpb25zID0gYW5ndWxhci5jb3B5KGRlZmF1bHRzKTsKICAgICAgYW5ndWxhci5mb3JFYWNoKFsnYW5pbWF0aW9uJywgJ2Rpc2FsbG93VG9nZ2xlJywgJ2FjdGl2ZUNsYXNzJywgJ3N0YXJ0Q29sbGFwc2VkJ10sIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBpZihhbmd1bGFyLmlzRGVmaW5lZCgkYXR0cnNba2V5XSkpIHNlbGYuJG9wdGlvbnNba2V5XSA9ICRhdHRyc1trZXldOwogICAgICB9KTsKCiAgICAgIHNlbGYuJHRvZ2dsZXMgPSBbXTsKICAgICAgc2VsZi4kdGFyZ2V0cyA9IFtdOwoKICAgICAgc2VsZi4kdmlld0NoYW5nZUxpc3RlbmVycyA9IFtdOwoKICAgICAgc2VsZi4kcmVnaXN0ZXJUb2dnbGUgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgc2VsZi4kdG9nZ2xlcy5wdXNoKGVsZW1lbnQpOwogICAgICB9OwogICAgICBzZWxmLiRyZWdpc3RlclRhcmdldCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICBzZWxmLiR0YXJnZXRzLnB1c2goZWxlbWVudCk7CiAgICAgIH07CgogICAgICBzZWxmLiR0YXJnZXRzLiRhY3RpdmUgPSAhc2VsZi4kb3B0aW9ucy5zdGFydENvbGxhcHNlZCA/IDAgOiAtMTsKICAgICAgc2VsZi4kc2V0QWN0aXZlID0gJHNjb3BlLiRzZXRBY3RpdmUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmKCFzZWxmLiRvcHRpb25zLmRpc2FsbG93VG9nZ2xlKSB7CiAgICAgICAgICBzZWxmLiR0YXJnZXRzLiRhY3RpdmUgPSBzZWxmLiR0YXJnZXRzLiRhY3RpdmUgPT09IHZhbHVlID8gLTEgOiB2YWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi4kdGFyZ2V0cy4kYWN0aXZlID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHNlbGYuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbihmbikgewogICAgICAgICAgZm4oKTsKICAgICAgICB9KTsKICAgICAgfTsKCiAgICB9OwoKICAgIHRoaXMuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgJGNvbGxhcHNlID0ge307CiAgICAgICRjb2xsYXBzZS5kZWZhdWx0cyA9IGRlZmF1bHRzOwogICAgICAkY29sbGFwc2UuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7CiAgICAgIHJldHVybiAkY29sbGFwc2U7CiAgICB9OwoKICB9KQoKICAuZGlyZWN0aXZlKCdic0NvbGxhcHNlJywgWyIkd2luZG93IiwgIiRhbmltYXRlIiwgIiRjb2xsYXBzZSIsIGZ1bmN0aW9uKCR3aW5kb3csICRhbmltYXRlLCAkY29sbGFwc2UpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSAkY29sbGFwc2UuZGVmYXVsdHM7CgogICAgcmV0dXJuIHsKICAgICAgcmVxdWlyZTogWyc/bmdNb2RlbCcsICdic0NvbGxhcHNlJ10sCiAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgJyRhdHRycycsICRjb2xsYXBzZS5jb250cm9sbGVyXSwKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjb250cm9sbGVycykgewoKICAgICAgICB2YXIgbmdNb2RlbEN0cmwgPSBjb250cm9sbGVyc1swXTsKICAgICAgICB2YXIgYnNDb2xsYXBzZUN0cmwgPSBjb250cm9sbGVyc1sxXTsKCiAgICAgICAgaWYobmdNb2RlbEN0cmwpIHsKCiAgICAgICAgICAvLyBVcGRhdGUgdGhlIG1vZGVsVmFsdWUgZm9sbG93aW5nCiAgICAgICAgICBic0NvbGxhcHNlQ3RybC4kdmlld0NoYW5nZUxpc3RlbmVycy5wdXNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBuZ01vZGVsQ3RybC4kc2V0Vmlld1ZhbHVlKGJzQ29sbGFwc2VDdHJsLiR0YXJnZXRzLiRhY3RpdmUpOwogICAgICAgICAgfSk7CgogICAgICAgICAgLy8gbW9kZWxWYWx1ZSAtPiAkZm9ybWF0dGVycyAtPiB2aWV3VmFsdWUKICAgICAgICAgIG5nTW9kZWxDdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24obW9kZWxWYWx1ZSkgewogICAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRmb3JtYXR0ZXIoIiVzIik6IG1vZGVsVmFsdWU9JW8gKCVvKScsIGVsZW1lbnQuYXR0cignbmctbW9kZWwnKSwgbW9kZWxWYWx1ZSwgdHlwZW9mIG1vZGVsVmFsdWUpOwogICAgICAgICAgICBpZiAoYnNDb2xsYXBzZUN0cmwuJHRhcmdldHMuJGFjdGl2ZSAhPT0gbW9kZWxWYWx1ZSAqIDEpIHsKICAgICAgICAgICAgICBic0NvbGxhcHNlQ3RybC4kc2V0QWN0aXZlKG1vZGVsVmFsdWUgKiAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kZWxWYWx1ZTsKICAgICAgICAgIH0pOwoKICAgICAgICB9CgogICAgICB9CiAgICB9OwoKICB9XSkKCiAgLmRpcmVjdGl2ZSgnYnNDb2xsYXBzZVRvZ2dsZScsIGZ1bmN0aW9uKCkgewoKICAgIHJldHVybiB7CiAgICAgIHJlcXVpcmU6IFsnXj9uZ01vZGVsJywgJ15ic0NvbGxhcHNlJ10sCiAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcnMpIHsKCiAgICAgICAgdmFyIG5nTW9kZWxDdHJsID0gY29udHJvbGxlcnNbMF07CiAgICAgICAgdmFyIGJzQ29sbGFwc2VDdHJsID0gY29udHJvbGxlcnNbMV07CgogICAgICAgIC8vIEFkZCBiYXNlIGF0dHIKICAgICAgICBlbGVtZW50LmF0dHIoJ2RhdGEtdG9nZ2xlJywgJ2NvbGxhcHNlJyk7CgogICAgICAgIC8vIFB1c2ggcGFuZSB0byBwYXJlbnQgYnNDb2xsYXBzZSBjb250cm9sbGVyCiAgICAgICAgYnNDb2xsYXBzZUN0cmwuJHJlZ2lzdGVyVG9nZ2xlKGVsZW1lbnQpOwogICAgICAgIGVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBhdHRycy5ic0NvbGxhcHNlVG9nZ2xlIHx8IGJzQ29sbGFwc2VDdHJsLiR0b2dnbGVzLmluZGV4T2YoZWxlbWVudCk7CiAgICAgICAgICBic0NvbGxhcHNlQ3RybC4kc2V0QWN0aXZlKGluZGV4ICogMSk7CiAgICAgICAgICBzY29wZS4kYXBwbHkoKTsKICAgICAgICB9KTsKCiAgICAgIH0KICAgIH07CgogIH0pCgogIC5kaXJlY3RpdmUoJ2JzQ29sbGFwc2VUYXJnZXQnLCBbIiRhbmltYXRlIiwgZnVuY3Rpb24oJGFuaW1hdGUpIHsKCiAgICByZXR1cm4gewogICAgICByZXF1aXJlOiBbJ14/bmdNb2RlbCcsICdeYnNDb2xsYXBzZSddLAogICAgICAvLyBzY29wZTogdHJ1ZSwKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjb250cm9sbGVycykgewoKICAgICAgICB2YXIgbmdNb2RlbEN0cmwgPSBjb250cm9sbGVyc1swXTsKICAgICAgICB2YXIgYnNDb2xsYXBzZUN0cmwgPSBjb250cm9sbGVyc1sxXTsKCiAgICAgICAgLy8gQWRkIGJhc2UgY2xhc3MKICAgICAgICBlbGVtZW50LmFkZENsYXNzKCdjb2xsYXBzZScpOwoKICAgICAgICAvLyBBZGQgYW5pbWF0aW9uIGNsYXNzCiAgICAgICAgaWYoYnNDb2xsYXBzZUN0cmwuJG9wdGlvbnMuYW5pbWF0aW9uKSB7CiAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKGJzQ29sbGFwc2VDdHJsLiRvcHRpb25zLmFuaW1hdGlvbik7CiAgICAgICAgfQoKICAgICAgICAvLyBQdXNoIHBhbmUgdG8gcGFyZW50IGJzQ29sbGFwc2UgY29udHJvbGxlcgogICAgICAgIGJzQ29sbGFwc2VDdHJsLiRyZWdpc3RlclRhcmdldChlbGVtZW50KTsKCiAgICAgICAgZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgICAgdmFyIGluZGV4ID0gYnNDb2xsYXBzZUN0cmwuJHRhcmdldHMuaW5kZXhPZihlbGVtZW50KTsKICAgICAgICAgIHZhciBhY3RpdmUgPSBic0NvbGxhcHNlQ3RybC4kdGFyZ2V0cy4kYWN0aXZlOwogICAgICAgICAgJGFuaW1hdGVbaW5kZXggPT09IGFjdGl2ZSA/ICdhZGRDbGFzcycgOiAncmVtb3ZlQ2xhc3MnXShlbGVtZW50LCBic0NvbGxhcHNlQ3RybC4kb3B0aW9ucy5hY3RpdmVDbGFzcyk7CiAgICAgICAgfQoKICAgICAgICBic0NvbGxhcHNlQ3RybC4kdmlld0NoYW5nZUxpc3RlbmVycy5wdXNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgcmVuZGVyKCk7CiAgICAgICAgfSk7CiAgICAgICAgcmVuZGVyKCk7CgogICAgICB9CiAgICB9OwoKICB9XSk7CgovLyBTb3VyY2U6IGRhdGVwaWNrZXIuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLmRhdGVwaWNrZXInLCBbJ21nY3JlYS5uZ1N0cmFwLmhlbHBlcnMuZGF0ZVBhcnNlcicsICdtZ2NyZWEubmdTdHJhcC50b29sdGlwJ10pCgogIC5wcm92aWRlcignJGRhdGVwaWNrZXInLCBmdW5jdGlvbigpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICBhbmltYXRpb246ICdhbS1mYWRlJywKICAgICAgcHJlZml4Q2xhc3M6ICdkYXRlcGlja2VyJywKICAgICAgcGxhY2VtZW50OiAnYm90dG9tLWxlZnQnLAogICAgICB0ZW1wbGF0ZTogJ2RhdGVwaWNrZXIvZGF0ZXBpY2tlci50cGwuaHRtbCcsCiAgICAgIHRyaWdnZXI6ICdmb2N1cycsCiAgICAgIGNvbnRhaW5lcjogZmFsc2UsCiAgICAgIGtleWJvYXJkOiB0cnVlLAogICAgICBodG1sOiBmYWxzZSwKICAgICAgZGVsYXk6IDAsCiAgICAgIC8vIGxhbmc6ICRsb2NhbGUuaWQsCiAgICAgIHVzZU5hdGl2ZTogZmFsc2UsCiAgICAgIGRhdGVUeXBlOiAnZGF0ZScsCiAgICAgIGRhdGVGb3JtYXQ6ICdzaG9ydERhdGUnLAogICAgICBtb2RlbERhdGVGb3JtYXQ6IG51bGwsCiAgICAgIGRheUZvcm1hdDogJ2RkJywKICAgICAgc3RyaWN0Rm9ybWF0OiBmYWxzZSwKICAgICAgYXV0b2Nsb3NlOiBmYWxzZSwKICAgICAgbWluRGF0ZTogLUluZmluaXR5LAogICAgICBtYXhEYXRlOiArSW5maW5pdHksCiAgICAgIHN0YXJ0VmlldzogMCwKICAgICAgbWluVmlldzogMCwKICAgICAgc3RhcnRXZWVrOiAwLAogICAgICBkYXlzT2ZXZWVrRGlzYWJsZWQ6ICcnLAogICAgICBpY29uTGVmdDogJ2dseXBoaWNvbiBnbHlwaGljb24tY2hldnJvbi1sZWZ0JywKICAgICAgaWNvblJpZ2h0OiAnZ2x5cGhpY29uIGdseXBoaWNvbi1jaGV2cm9uLXJpZ2h0JwogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBbIiR3aW5kb3ciLCAiJGRvY3VtZW50IiwgIiRyb290U2NvcGUiLCAiJHNjZSIsICIkbG9jYWxlIiwgImRhdGVGaWx0ZXIiLCAiZGF0ZXBpY2tlclZpZXdzIiwgIiR0b29sdGlwIiwgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCAkcm9vdFNjb3BlLCAkc2NlLCAkbG9jYWxlLCBkYXRlRmlsdGVyLCBkYXRlcGlja2VyVmlld3MsICR0b29sdGlwKSB7CgogICAgICB2YXIgYm9keUVsID0gYW5ndWxhci5lbGVtZW50KCR3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgIHZhciBpc05hdGl2ZSA9IC8oaXAoYXxvKWR8aXBob25lfGFuZHJvaWQpL2lnLnRlc3QoJHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgdmFyIGlzVG91Y2ggPSAoJ2NyZWF0ZVRvdWNoJyBpbiAkd2luZG93LmRvY3VtZW50KSAmJiBpc05hdGl2ZTsKICAgICAgaWYoIWRlZmF1bHRzLmxhbmcpIGRlZmF1bHRzLmxhbmcgPSAkbG9jYWxlLmlkOwoKICAgICAgZnVuY3Rpb24gRGF0ZXBpY2tlckZhY3RvcnkoZWxlbWVudCwgY29udHJvbGxlciwgY29uZmlnKSB7CgogICAgICAgIHZhciAkZGF0ZXBpY2tlciA9ICR0b29sdGlwKGVsZW1lbnQsIGFuZ3VsYXIuZXh0ZW5kKHt9LCBkZWZhdWx0cywgY29uZmlnKSk7CiAgICAgICAgdmFyIHBhcmVudFNjb3BlID0gY29uZmlnLnNjb3BlOwogICAgICAgIHZhciBvcHRpb25zID0gJGRhdGVwaWNrZXIuJG9wdGlvbnM7CiAgICAgICAgdmFyIHNjb3BlID0gJGRhdGVwaWNrZXIuJHNjb3BlOwogICAgICAgIGlmKG9wdGlvbnMuc3RhcnRWaWV3KSBvcHRpb25zLnN0YXJ0VmlldyAtPSBvcHRpb25zLm1pblZpZXc7CgogICAgICAgIC8vIFZpZXcgdmFycwoKICAgICAgICB2YXIgcGlja2VyVmlld3MgPSBkYXRlcGlja2VyVmlld3MoJGRhdGVwaWNrZXIpOwogICAgICAgICRkYXRlcGlja2VyLiR2aWV3cyA9IHBpY2tlclZpZXdzLnZpZXdzOwogICAgICAgIHZhciB2aWV3RGF0ZSA9IHBpY2tlclZpZXdzLnZpZXdEYXRlOwogICAgICAgIHNjb3BlLiRtb2RlID0gb3B0aW9ucy5zdGFydFZpZXc7CiAgICAgICAgc2NvcGUuJGljb25MZWZ0ID0gb3B0aW9ucy5pY29uTGVmdDsKICAgICAgICBzY29wZS4kaWNvblJpZ2h0ID0gb3B0aW9ucy5pY29uUmlnaHQ7CiAgICAgICAgdmFyICRwaWNrZXIgPSAkZGF0ZXBpY2tlci4kdmlld3Nbc2NvcGUuJG1vZGVdOwoKICAgICAgICAvLyBTY29wZSBtZXRob2RzCgogICAgICAgIHNjb3BlLiRzZWxlY3QgPSBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAkZGF0ZXBpY2tlci5zZWxlY3QoZGF0ZSk7CiAgICAgICAgfTsKICAgICAgICBzY29wZS4kc2VsZWN0UGFuZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAkZGF0ZXBpY2tlci4kc2VsZWN0UGFuZSh2YWx1ZSk7CiAgICAgICAgfTsKICAgICAgICBzY29wZS4kdG9nZ2xlTW9kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgJGRhdGVwaWNrZXIuc2V0TW9kZSgoc2NvcGUuJG1vZGUgKyAxKSAlICRkYXRlcGlja2VyLiR2aWV3cy5sZW5ndGgpOwogICAgICAgIH07CgogICAgICAgIC8vIFB1YmxpYyBtZXRob2RzCgogICAgICAgICRkYXRlcGlja2VyLnVwZGF0ZSA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2FybignJGRhdGVwaWNrZXIudXBkYXRlKCkgbmV3VmFsdWU9JW8nLCBkYXRlKTsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNEYXRlKGRhdGUpICYmICFpc05hTihkYXRlLmdldFRpbWUoKSkpIHsKICAgICAgICAgICAgJGRhdGVwaWNrZXIuJGRhdGUgPSBkYXRlOwogICAgICAgICAgICAkcGlja2VyLnVwZGF0ZS5jYWxsKCRwaWNrZXIsIGRhdGUpOwogICAgICAgICAgfQogICAgICAgICAgLy8gQnVpbGQgb25seSBpZiBwcmlzdGluZQogICAgICAgICAgJGRhdGVwaWNrZXIuJGJ1aWxkKHRydWUpOwogICAgICAgIH07CgogICAgICAgICRkYXRlcGlja2VyLnVwZGF0ZURpc2FibGVkRGF0ZXMgPSBmdW5jdGlvbihkYXRlUmFuZ2VzKSB7CiAgICAgICAgICBvcHRpb25zLmRpc2FibGVkRGF0ZVJhbmdlcyA9IGRhdGVSYW5nZXM7CiAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsID0gc2NvcGUucm93cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHNjb3BlLnJvd3NbaV0sICRkYXRlcGlja2VyLiRzZXREaXNhYmxlZEVsKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAkZGF0ZXBpY2tlci5zZWxlY3QgPSBmdW5jdGlvbihkYXRlLCBrZWVwKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRkYXRlcGlja2VyLnNlbGVjdCcsIGRhdGUsIHNjb3BlLiRtb2RlKTsKICAgICAgICAgIGlmKCFhbmd1bGFyLmlzRGF0ZShjb250cm9sbGVyLiRkYXRlVmFsdWUpKSBjb250cm9sbGVyLiRkYXRlVmFsdWUgPSBuZXcgRGF0ZShkYXRlKTsKICAgICAgICAgIGlmKCFzY29wZS4kbW9kZSB8fCBrZWVwKSB7CiAgICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZpZXdWYWx1ZShhbmd1bGFyLmNvcHkoZGF0ZSkpOwogICAgICAgICAgICBjb250cm9sbGVyLiRyZW5kZXIoKTsKICAgICAgICAgICAgaWYob3B0aW9ucy5hdXRvY2xvc2UgJiYgIWtlZXApIHsKICAgICAgICAgICAgICAkZGF0ZXBpY2tlci5oaWRlKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhbmd1bGFyLmV4dGVuZCh2aWV3RGF0ZSwge3llYXI6IGRhdGUuZ2V0RnVsbFllYXIoKSwgbW9udGg6IGRhdGUuZ2V0TW9udGgoKSwgZGF0ZTogZGF0ZS5nZXREYXRlKCl9KTsKICAgICAgICAgICAgJGRhdGVwaWNrZXIuc2V0TW9kZShzY29wZS4kbW9kZSAtIDEpOwogICAgICAgICAgICAkZGF0ZXBpY2tlci4kYnVpbGQoKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAkZGF0ZXBpY2tlci5zZXRNb2RlID0gZnVuY3Rpb24obW9kZSkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCckZGF0ZXBpY2tlci5zZXRNb2RlJywgbW9kZSk7CiAgICAgICAgICBzY29wZS4kbW9kZSA9IG1vZGU7CiAgICAgICAgICAkcGlja2VyID0gJGRhdGVwaWNrZXIuJHZpZXdzW3Njb3BlLiRtb2RlXTsKICAgICAgICAgICRkYXRlcGlja2VyLiRidWlsZCgpOwogICAgICAgIH07CgogICAgICAgIC8vIFByb3RlY3RlZCBtZXRob2RzCgogICAgICAgICRkYXRlcGlja2VyLiRidWlsZCA9IGZ1bmN0aW9uKHByaXN0aW5lKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRkYXRlcGlja2VyLiRidWlsZCgpIHZpZXdEYXRlPSVvJywgdmlld0RhdGUpOwogICAgICAgICAgaWYocHJpc3RpbmUgPT09IHRydWUgJiYgJHBpY2tlci5idWlsdCkgcmV0dXJuOwogICAgICAgICAgaWYocHJpc3RpbmUgPT09IGZhbHNlICYmICEkcGlja2VyLmJ1aWx0KSByZXR1cm47CiAgICAgICAgICAkcGlja2VyLmJ1aWxkLmNhbGwoJHBpY2tlcik7CiAgICAgICAgfTsKCiAgICAgICAgJGRhdGVwaWNrZXIuJHVwZGF0ZVNlbGVjdGVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsID0gc2NvcGUucm93cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHNjb3BlLnJvd3NbaV0sIHVwZGF0ZVNlbGVjdGVkKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAkZGF0ZXBpY2tlci4kaXNTZWxlY3RlZCA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgIHJldHVybiAkcGlja2VyLmlzU2VsZWN0ZWQoZGF0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgJGRhdGVwaWNrZXIuJHNldERpc2FibGVkRWwgPSBmdW5jdGlvbihlbCkgewogICAgICAgICAgZWwuZGlzYWJsZWQgPSAkcGlja2VyLmlzRGlzYWJsZWQoZWwuZGF0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgJGRhdGVwaWNrZXIuJHNlbGVjdFBhbmUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgdmFyIHN0ZXBzID0gJHBpY2tlci5zdGVwczsKICAgICAgICAgIHZhciB0YXJnZXREYXRlID0gbmV3IERhdGUoRGF0ZS5VVEModmlld0RhdGUueWVhciArICgoc3RlcHMueWVhciB8fCAwKSAqIHZhbHVlKSwgdmlld0RhdGUubW9udGggKyAoKHN0ZXBzLm1vbnRoIHx8IDApICogdmFsdWUpLCB2aWV3RGF0ZS5kYXRlICsgKChzdGVwcy5kYXkgfHwgMCkgKiB2YWx1ZSkpKTsKICAgICAgICAgIGFuZ3VsYXIuZXh0ZW5kKHZpZXdEYXRlLCB7eWVhcjogdGFyZ2V0RGF0ZS5nZXRVVENGdWxsWWVhcigpLCBtb250aDogdGFyZ2V0RGF0ZS5nZXRVVENNb250aCgpLCBkYXRlOiB0YXJnZXREYXRlLmdldFVUQ0RhdGUoKX0pOwogICAgICAgICAgJGRhdGVwaWNrZXIuJGJ1aWxkKCk7CiAgICAgICAgfTsKCiAgICAgICAgJGRhdGVwaWNrZXIuJG9uTW91c2VEb3duID0gZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICAvLyBQcmV2ZW50IGJsdXIgb24gbW91c2Vkb3duIG9uIC5kcm9wZG93bi1tZW51CiAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIC8vIEVtdWxhdGUgY2xpY2sgZm9yIG1vYmlsZSBkZXZpY2VzCiAgICAgICAgICBpZihpc1RvdWNoKSB7CiAgICAgICAgICAgIHZhciB0YXJnZXRFbCA9IGFuZ3VsYXIuZWxlbWVudChldnQudGFyZ2V0KTsKICAgICAgICAgICAgaWYodGFyZ2V0RWxbMF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gJ2J1dHRvbicpIHsKICAgICAgICAgICAgICB0YXJnZXRFbCA9IHRhcmdldEVsLnBhcmVudCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRhcmdldEVsLnRyaWdnZXJIYW5kbGVyKCdjbGljaycpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgICRkYXRlcGlja2VyLiRvbktleURvd24gPSBmdW5jdGlvbihldnQpIHsKICAgICAgICAgIGlmICghLygzOHwzN3wzOXw0MHwxMykvLnRlc3QoZXZ0LmtleUNvZGUpIHx8IGV2dC5zaGlmdEtleSB8fCBldnQuYWx0S2V5KSByZXR1cm47CiAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKCiAgICAgICAgICBpZihldnQua2V5Q29kZSA9PT0gMTMpIHsKICAgICAgICAgICAgaWYoIXNjb3BlLiRtb2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuICRkYXRlcGlja2VyLmhpZGUodHJ1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsgJGRhdGVwaWNrZXIuc2V0TW9kZShzY29wZS4kbW9kZSAtIDEpOyB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIE5hdmlnYXRlIHdpdGgga2V5Ym9hcmQKICAgICAgICAgICRwaWNrZXIub25LZXlEb3duKGV2dCk7CiAgICAgICAgICBwYXJlbnRTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gUHJpdmF0ZQoKICAgICAgICBmdW5jdGlvbiB1cGRhdGVTZWxlY3RlZChlbCkgewogICAgICAgICAgZWwuc2VsZWN0ZWQgPSAkZGF0ZXBpY2tlci4kaXNTZWxlY3RlZChlbC5kYXRlKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZvY3VzRWxlbWVudCgpIHsKICAgICAgICAgIGVsZW1lbnRbMF0uZm9jdXMoKTsKICAgICAgICB9CgogICAgICAgIC8vIE92ZXJyaWRlcwoKICAgICAgICB2YXIgX2luaXQgPSAkZGF0ZXBpY2tlci5pbml0OwogICAgICAgICRkYXRlcGlja2VyLmluaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmKGlzTmF0aXZlICYmIG9wdGlvbnMudXNlTmF0aXZlKSB7CiAgICAgICAgICAgIGVsZW1lbnQucHJvcCgndHlwZScsICdkYXRlJyk7CiAgICAgICAgICAgIGVsZW1lbnQuY3NzKCctd2Via2l0LWFwcGVhcmFuY2UnLCAndGV4dGZpZWxkJyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gZWxzZSBpZihpc1RvdWNoKSB7CiAgICAgICAgICAgIGVsZW1lbnQucHJvcCgndHlwZScsICd0ZXh0Jyk7CiAgICAgICAgICAgIGVsZW1lbnQuYXR0cigncmVhZG9ubHknLCAndHJ1ZScpOwogICAgICAgICAgICBlbGVtZW50Lm9uKCdjbGljaycsIGZvY3VzRWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICBfaW5pdCgpOwogICAgICAgIH07CgogICAgICAgIHZhciBfZGVzdHJveSA9ICRkYXRlcGlja2VyLmRlc3Ryb3k7CiAgICAgICAgJGRhdGVwaWNrZXIuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYoaXNOYXRpdmUgJiYgb3B0aW9ucy51c2VOYXRpdmUpIHsKICAgICAgICAgICAgZWxlbWVudC5vZmYoJ2NsaWNrJywgZm9jdXNFbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIF9kZXN0cm95KCk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIF9zaG93ID0gJGRhdGVwaWNrZXIuc2hvdzsKICAgICAgICAkZGF0ZXBpY2tlci5zaG93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBfc2hvdygpOwogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJGRhdGVwaWNrZXIuJGVsZW1lbnQub24oaXNUb3VjaCA/ICd0b3VjaHN0YXJ0JyA6ICdtb3VzZWRvd24nLCAkZGF0ZXBpY2tlci4kb25Nb3VzZURvd24pOwogICAgICAgICAgICBpZihvcHRpb25zLmtleWJvYXJkKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5vbigna2V5ZG93bicsICRkYXRlcGlja2VyLiRvbktleURvd24pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICB2YXIgX2hpZGUgPSAkZGF0ZXBpY2tlci5oaWRlOwogICAgICAgICRkYXRlcGlja2VyLmhpZGUgPSBmdW5jdGlvbihibHVyKSB7CiAgICAgICAgICBpZighJGRhdGVwaWNrZXIuJGlzU2hvd24pIHJldHVybjsKICAgICAgICAgICRkYXRlcGlja2VyLiRlbGVtZW50Lm9mZihpc1RvdWNoID8gJ3RvdWNoc3RhcnQnIDogJ21vdXNlZG93bicsICRkYXRlcGlja2VyLiRvbk1vdXNlRG93bik7CiAgICAgICAgICBpZihvcHRpb25zLmtleWJvYXJkKSB7CiAgICAgICAgICAgIGVsZW1lbnQub2ZmKCdrZXlkb3duJywgJGRhdGVwaWNrZXIuJG9uS2V5RG93bik7CiAgICAgICAgICB9CiAgICAgICAgICBfaGlkZShibHVyKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gJGRhdGVwaWNrZXI7CgogICAgICB9CgogICAgICBEYXRlcGlja2VyRmFjdG9yeS5kZWZhdWx0cyA9IGRlZmF1bHRzOwogICAgICByZXR1cm4gRGF0ZXBpY2tlckZhY3Rvcnk7CgogICAgfV07CgogIH0pCgogIC5kaXJlY3RpdmUoJ2JzRGF0ZXBpY2tlcicsIFsiJHdpbmRvdyIsICIkcGFyc2UiLCAiJHEiLCAiJGxvY2FsZSIsICJkYXRlRmlsdGVyIiwgIiRkYXRlcGlja2VyIiwgIiRkYXRlUGFyc2VyIiwgIiR0aW1lb3V0IiwgZnVuY3Rpb24oJHdpbmRvdywgJHBhcnNlLCAkcSwgJGxvY2FsZSwgZGF0ZUZpbHRlciwgJGRhdGVwaWNrZXIsICRkYXRlUGFyc2VyLCAkdGltZW91dCkgewoKICAgIHZhciBkZWZhdWx0cyA9ICRkYXRlcGlja2VyLmRlZmF1bHRzOwogICAgdmFyIGlzTmF0aXZlID0gLyhpcChhfG8pZHxpcGhvbmV8YW5kcm9pZCkvaWcudGVzdCgkd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpOwoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRUFDJywKICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgICBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgZWxlbWVudCwgYXR0ciwgY29udHJvbGxlcikgewoKICAgICAgICAvLyBEaXJlY3RpdmUgb3B0aW9ucwogICAgICAgIHZhciBvcHRpb25zID0ge3Njb3BlOiBzY29wZSwgY29udHJvbGxlcjogY29udHJvbGxlcn07CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsncGxhY2VtZW50JywgJ2NvbnRhaW5lcicsICdkZWxheScsICd0cmlnZ2VyJywgJ2tleWJvYXJkJywgJ2h0bWwnLCAnYW5pbWF0aW9uJywgJ3RlbXBsYXRlJywgJ2F1dG9jbG9zZScsICdkYXRlVHlwZScsICdkYXRlRm9ybWF0JywgJ21vZGVsRGF0ZUZvcm1hdCcsICdkYXlGb3JtYXQnLCAnc3RyaWN0Rm9ybWF0JywgJ3N0YXJ0V2VlaycsICdzdGFydERhdGUnLCAndXNlTmF0aXZlJywgJ2xhbmcnLCAnc3RhcnRWaWV3JywgJ21pblZpZXcnLCAnaWNvbkxlZnQnLCAnaWNvblJpZ2h0JywgJ2RheXNPZldlZWtEaXNhYmxlZCddLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNEZWZpbmVkKGF0dHJba2V5XSkpIG9wdGlvbnNba2V5XSA9IGF0dHJba2V5XTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gVmlzaWJpbGl0eSBiaW5kaW5nIHN1cHBvcnQKICAgICAgICBhdHRyLmJzU2hvdyAmJiBzY29wZS4kd2F0Y2goYXR0ci5ic1Nob3csIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgaWYoIWRhdGVwaWNrZXIgfHwgIWFuZ3VsYXIuaXNEZWZpbmVkKG5ld1ZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgaWYoYW5ndWxhci5pc1N0cmluZyhuZXdWYWx1ZSkpIG5ld1ZhbHVlID0gISFuZXdWYWx1ZS5tYXRjaCgvdHJ1ZXwsPyhkYXRlcGlja2VyKSw/L2kpOwogICAgICAgICAgbmV3VmFsdWUgPT09IHRydWUgPyBkYXRlcGlja2VyLnNob3coKSA6IGRhdGVwaWNrZXIuaGlkZSgpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBJbml0aWFsaXplIGRhdGVwaWNrZXIKICAgICAgICB2YXIgZGF0ZXBpY2tlciA9ICRkYXRlcGlja2VyKGVsZW1lbnQsIGNvbnRyb2xsZXIsIG9wdGlvbnMpOwogICAgICAgIG9wdGlvbnMgPSBkYXRlcGlja2VyLiRvcHRpb25zOwogICAgICAgIC8vIFNldCBleHBlY3RlZCBpT1MgZm9ybWF0CiAgICAgICAgaWYoaXNOYXRpdmUgJiYgb3B0aW9ucy51c2VOYXRpdmUpIG9wdGlvbnMuZGF0ZUZvcm1hdCA9ICd5eXl5LU1NLWRkJzsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSBwYXJzZXIKICAgICAgICB2YXIgZGF0ZVBhcnNlciA9ICRkYXRlUGFyc2VyKHtmb3JtYXQ6IG9wdGlvbnMuZGF0ZUZvcm1hdCwgbGFuZzogb3B0aW9ucy5sYW5nLCBzdHJpY3Q6IG9wdGlvbnMuc3RyaWN0Rm9ybWF0fSk7CgogICAgICAgIC8vIE9ic2VydmUgYXR0cmlidXRlcyBmb3IgY2hhbmdlcwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ21pbkRhdGUnLCAnbWF4RGF0ZSddLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2FybignYXR0ci4kb2JzZXJ2ZSglcyknLCBrZXksIGF0dHJba2V5XSk7CiAgICAgICAgICBhbmd1bGFyLmlzRGVmaW5lZChhdHRyW2tleV0pICYmIGF0dHIuJG9ic2VydmUoa2V5LCBmdW5jdGlvbihuZXdWYWx1ZSkgewogICAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJ2F0dHIuJG9ic2VydmUoJXMpPSVvJywga2V5LCBuZXdWYWx1ZSk7CiAgICAgICAgICAgIGRhdGVwaWNrZXIuJG9wdGlvbnNba2V5XSA9IGRhdGVQYXJzZXIuZ2V0RGF0ZUZvckF0dHJpYnV0ZShrZXksIG5ld1ZhbHVlKTsKICAgICAgICAgICAgLy8gQnVpbGQgb25seSBpZiBkaXJ0eQogICAgICAgICAgICAhaXNOYU4oZGF0ZXBpY2tlci4kb3B0aW9uc1trZXldKSAmJiBkYXRlcGlja2VyLiRidWlsZChmYWxzZSk7CiAgICAgICAgICAgIHZhbGlkYXRlQWdhaW5zdE1pbk1heERhdGUoY29udHJvbGxlci4kZGF0ZVZhbHVlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyBXYXRjaCBtb2RlbCBmb3IgY2hhbmdlcwogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nTW9kZWwsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgZGF0ZXBpY2tlci51cGRhdGUoY29udHJvbGxlci4kZGF0ZVZhbHVlKTsKICAgICAgICB9LCB0cnVlKTsKCiAgICAgICAgLy8gTm9ybWFsaXplIHVuZGVmaW5lZC9udWxsL2VtcHR5IGFycmF5LAogICAgICAgIC8vIHNvIHRoYXQgd2UgZG9uJ3QgdHJlYXQgY2hhbmdpbmcgZnJvbSB1bmRlZmluZWQtPm51bGwgYXMgYSBjaGFuZ2UuCiAgICAgICAgZnVuY3Rpb24gbm9ybWFsaXplRGF0ZVJhbmdlcyhyYW5nZXMpIHsKICAgICAgICAgIGlmICghcmFuZ2VzIHx8ICFyYW5nZXMubGVuZ3RoKSByZXR1cm4gbnVsbDsKICAgICAgICAgIHJldHVybiByYW5nZXM7CiAgICAgICAgfQoKICAgICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQoYXR0ci5kaXNhYmxlZERhdGVzKSkgewogICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIuZGlzYWJsZWREYXRlcywgZnVuY3Rpb24oZGlzYWJsZWRSYW5nZXMsIHByZXZpb3VzVmFsdWUpIHsKICAgICAgICAgICAgZGlzYWJsZWRSYW5nZXMgPSBub3JtYWxpemVEYXRlUmFuZ2VzKGRpc2FibGVkUmFuZ2VzKTsKICAgICAgICAgICAgcHJldmlvdXNWYWx1ZSA9IG5vcm1hbGl6ZURhdGVSYW5nZXMocHJldmlvdXNWYWx1ZSk7CgogICAgICAgICAgICBpZiAoZGlzYWJsZWRSYW5nZXMpIHsKICAgICAgICAgICAgICBkYXRlcGlja2VyLnVwZGF0ZURpc2FibGVkRGF0ZXMoZGlzYWJsZWRSYW5nZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQWdhaW5zdE1pbk1heERhdGUocGFyc2VkRGF0ZSkgewogICAgICAgICAgaWYgKCFhbmd1bGFyLmlzRGF0ZShwYXJzZWREYXRlKSkgcmV0dXJuOwogICAgICAgICAgdmFyIGlzTWluVmFsaWQgPSBpc05hTihkYXRlcGlja2VyLiRvcHRpb25zLm1pbkRhdGUpIHx8IHBhcnNlZERhdGUuZ2V0VGltZSgpID49IGRhdGVwaWNrZXIuJG9wdGlvbnMubWluRGF0ZTsKICAgICAgICAgIHZhciBpc01heFZhbGlkID0gaXNOYU4oZGF0ZXBpY2tlci4kb3B0aW9ucy5tYXhEYXRlKSB8fCBwYXJzZWREYXRlLmdldFRpbWUoKSA8PSBkYXRlcGlja2VyLiRvcHRpb25zLm1heERhdGU7CiAgICAgICAgICB2YXIgaXNWYWxpZCA9IGlzTWluVmFsaWQgJiYgaXNNYXhWYWxpZDsKICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZhbGlkaXR5KCdkYXRlJywgaXNWYWxpZCk7CiAgICAgICAgICBjb250cm9sbGVyLiRzZXRWYWxpZGl0eSgnbWluJywgaXNNaW5WYWxpZCk7CiAgICAgICAgICBjb250cm9sbGVyLiRzZXRWYWxpZGl0eSgnbWF4JywgaXNNYXhWYWxpZCk7CiAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSB0aGUgbW9kZWwgd2hlbiB3ZSBoYXZlIGEgdmFsaWQgZGF0ZQogICAgICAgICAgaWYoaXNWYWxpZCkgY29udHJvbGxlci4kZGF0ZVZhbHVlID0gcGFyc2VkRGF0ZTsKICAgICAgICB9CgogICAgICAgIC8vIHZpZXdWYWx1ZSAtPiAkcGFyc2VycyAtPiBtb2RlbFZhbHVlCiAgICAgICAgY29udHJvbGxlci4kcGFyc2Vycy51bnNoaWZ0KGZ1bmN0aW9uKHZpZXdWYWx1ZSkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCckcGFyc2VyKCIlcyIpOiB2aWV3VmFsdWU9JW8nLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksIHZpZXdWYWx1ZSk7CiAgICAgICAgICAvLyBOdWxsIHZhbHVlcyBzaG91bGQgY29ycmVjdGx5IHJlc2V0IHRoZSBtb2RlbCB2YWx1ZSAmIHZhbGlkaXR5CiAgICAgICAgICBpZighdmlld1ZhbHVlKSB7CiAgICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZhbGlkaXR5KCdkYXRlJywgdHJ1ZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJzZWREYXRlID0gZGF0ZVBhcnNlci5wYXJzZSh2aWV3VmFsdWUsIGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSk7CiAgICAgICAgICBpZighcGFyc2VkRGF0ZSB8fCBpc05hTihwYXJzZWREYXRlLmdldFRpbWUoKSkpIHsKICAgICAgICAgICAgY29udHJvbGxlci4kc2V0VmFsaWRpdHkoJ2RhdGUnLCBmYWxzZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbGlkYXRlQWdhaW5zdE1pbk1heERhdGUocGFyc2VkRGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZihvcHRpb25zLmRhdGVUeXBlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICByZXR1cm4gZGF0ZUZpbHRlcihwYXJzZWREYXRlLCBvcHRpb25zLm1vZGVsRGF0ZUZvcm1hdCB8fCBvcHRpb25zLmRhdGVGb3JtYXQpOwogICAgICAgICAgfSBlbHNlIGlmKG9wdGlvbnMuZGF0ZVR5cGUgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHJldHVybiBjb250cm9sbGVyLiRkYXRlVmFsdWUuZ2V0VGltZSgpOwogICAgICAgICAgfSBlbHNlIGlmKG9wdGlvbnMuZGF0ZVR5cGUgPT09ICdpc28nKSB7CiAgICAgICAgICAgIHJldHVybiBjb250cm9sbGVyLiRkYXRlVmFsdWUudG9JU09TdHJpbmcoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShjb250cm9sbGVyLiRkYXRlVmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyBtb2RlbFZhbHVlIC0+ICRmb3JtYXR0ZXJzIC0+IHZpZXdWYWx1ZQogICAgICAgIGNvbnRyb2xsZXIuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbihtb2RlbFZhbHVlKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRmb3JtYXR0ZXIoIiVzIik6IG1vZGVsVmFsdWU9JW8gKCVvKScsIGVsZW1lbnQuYXR0cignbmctbW9kZWwnKSwgbW9kZWxWYWx1ZSwgdHlwZW9mIG1vZGVsVmFsdWUpOwogICAgICAgICAgdmFyIGRhdGU7CiAgICAgICAgICBpZihhbmd1bGFyLmlzVW5kZWZpbmVkKG1vZGVsVmFsdWUpIHx8IG1vZGVsVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgZGF0ZSA9IE5hTjsKICAgICAgICAgIH0gZWxzZSBpZihhbmd1bGFyLmlzRGF0ZShtb2RlbFZhbHVlKSkgewogICAgICAgICAgICBkYXRlID0gbW9kZWxWYWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZihvcHRpb25zLmRhdGVUeXBlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBkYXRlID0gZGF0ZVBhcnNlci5wYXJzZShtb2RlbFZhbHVlLCBudWxsLCBvcHRpb25zLm1vZGVsRGF0ZUZvcm1hdCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkYXRlID0gbmV3IERhdGUobW9kZWxWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBTZXR1cCBkZWZhdWx0IHZhbHVlPwogICAgICAgICAgLy8gaWYoaXNOYU4oZGF0ZS5nZXRUaW1lKCkpKSB7CiAgICAgICAgICAvLyAgIHZhciB0b2RheSA9IG5ldyBEYXRlKCk7CiAgICAgICAgICAvLyAgIGRhdGUgPSBuZXcgRGF0ZSh0b2RheS5nZXRGdWxsWWVhcigpLCB0b2RheS5nZXRNb250aCgpLCB0b2RheS5nZXREYXRlKCksIDAsIDAsIDAsIDApOwogICAgICAgICAgLy8gfQogICAgICAgICAgY29udHJvbGxlci4kZGF0ZVZhbHVlID0gZGF0ZTsKICAgICAgICAgIHJldHVybiBjb250cm9sbGVyLiRkYXRlVmFsdWU7CiAgICAgICAgfSk7CgogICAgICAgIC8vIHZpZXdWYWx1ZSAtPiBlbGVtZW50CiAgICAgICAgY29udHJvbGxlci4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRyZW5kZXIoIiVzIik6IHZpZXdWYWx1ZT0lbycsIGVsZW1lbnQuYXR0cignbmctbW9kZWwnKSwgY29udHJvbGxlci4kdmlld1ZhbHVlKTsKICAgICAgICAgIGVsZW1lbnQudmFsKCFjb250cm9sbGVyLiRkYXRlVmFsdWUgfHwgaXNOYU4oY29udHJvbGxlci4kZGF0ZVZhbHVlLmdldFRpbWUoKSkgPyAnJyA6IGRhdGVGaWx0ZXIoY29udHJvbGxlci4kZGF0ZVZhbHVlLCBvcHRpb25zLmRhdGVGb3JtYXQpKTsKICAgICAgICB9OwoKICAgICAgICAvLyBHYXJiYWdlIGNvbGxlY3Rpb24KICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZihkYXRlcGlja2VyKSBkYXRlcGlja2VyLmRlc3Ryb3koKTsKICAgICAgICAgIG9wdGlvbnMgPSBudWxsOwogICAgICAgICAgZGF0ZXBpY2tlciA9IG51bGw7CiAgICAgICAgfSk7CgogICAgICB9CiAgICB9OwoKICB9XSkKCiAgLnByb3ZpZGVyKCdkYXRlcGlja2VyVmlld3MnLCBmdW5jdGlvbigpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICBkYXlGb3JtYXQ6ICdkZCcsCiAgICAgIGRheVNwbGl0OiA3CiAgICB9OwoKICAgIC8vIFNwbGl0IGFycmF5IGludG8gc21hbGxlciBhcnJheXMKICAgIGZ1bmN0aW9uIHNwbGl0KGFyciwgc2l6ZSkgewogICAgICB2YXIgYXJyYXlzID0gW107CiAgICAgIHdoaWxlKGFyci5sZW5ndGggPiAwKSB7CiAgICAgICAgYXJyYXlzLnB1c2goYXJyLnNwbGljZSgwLCBzaXplKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5czsKICAgIH0KCiAgICAvLyBNb2R1bHVzIG9wZXJhdG9yCiAgICBmdW5jdGlvbiBtb2QobiwgbSkgewogICAgICByZXR1cm4gKChuICUgbSkgKyBtKSAlIG07CiAgICB9CgogICAgdGhpcy4kZ2V0ID0gWyIkbG9jYWxlIiwgIiRzY2UiLCAiZGF0ZUZpbHRlciIsICIkZGF0ZVBhcnNlciIsIGZ1bmN0aW9uKCRsb2NhbGUsICRzY2UsIGRhdGVGaWx0ZXIsICRkYXRlUGFyc2VyKSB7CgogICAgICByZXR1cm4gZnVuY3Rpb24ocGlja2VyKSB7CgogICAgICAgIHZhciBzY29wZSA9IHBpY2tlci4kc2NvcGU7CiAgICAgICAgdmFyIG9wdGlvbnMgPSBwaWNrZXIuJG9wdGlvbnM7CiAgICAgICAgdmFyIGRhdGVQYXJzZXIgPSAkZGF0ZVBhcnNlcigpOwoKICAgICAgICB2YXIgd2Vla0RheXNNaW4gPSAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFMuU0hPUlREQVk7CiAgICAgICAgdmFyIHdlZWtEYXlzTGFiZWxzID0gd2Vla0RheXNNaW4uc2xpY2Uob3B0aW9ucy5zdGFydFdlZWspLmNvbmNhdCh3ZWVrRGF5c01pbi5zbGljZSgwLCBvcHRpb25zLnN0YXJ0V2VlaykpOwogICAgICAgIHZhciB3ZWVrRGF5c0xhYmVsc0h0bWwgPSAkc2NlLnRydXN0QXNIdG1sKCc8dGggY2xhc3M9ImRvdyB0ZXh0LWNlbnRlciI+JyArIHdlZWtEYXlzTGFiZWxzLmpvaW4oJzwvdGg+PHRoIGNsYXNzPSJkb3cgdGV4dC1jZW50ZXIiPicpICsgJzwvdGg+Jyk7CgogICAgICAgIHZhciBzdGFydERhdGUgPSBwaWNrZXIuJGRhdGUgfHwgKG9wdGlvbnMuc3RhcnREYXRlID8gZGF0ZVBhcnNlci5nZXREYXRlRm9yQXR0cmlidXRlKCdzdGFydERhdGUnLCBvcHRpb25zLnN0YXJ0RGF0ZSkgOiBuZXcgRGF0ZSgpKTsKICAgICAgICB2YXIgdmlld0RhdGUgPSB7eWVhcjogc3RhcnREYXRlLmdldEZ1bGxZZWFyKCksIG1vbnRoOiBzdGFydERhdGUuZ2V0TW9udGgoKSwgZGF0ZTogc3RhcnREYXRlLmdldERhdGUoKX07CiAgICAgICAgdmFyIHRpbWV6b25lT2Zmc2V0ID0gc3RhcnREYXRlLmdldFRpbWV6b25lT2Zmc2V0KCkgKiA2ZTQ7CgogICAgICAgIHZhciB2aWV3cyA9IFt7CiAgICAgICAgICAgIGZvcm1hdDogb3B0aW9ucy5kYXlGb3JtYXQsCiAgICAgICAgICAgIHNwbGl0OiA3LAogICAgICAgICAgICBzdGVwczogeyBtb250aDogMSB9LAogICAgICAgICAgICB1cGRhdGU6IGZ1bmN0aW9uKGRhdGUsIGZvcmNlKSB7CiAgICAgICAgICAgICAgaWYoIXRoaXMuYnVpbHQgfHwgZm9yY2UgfHwgZGF0ZS5nZXRGdWxsWWVhcigpICE9PSB2aWV3RGF0ZS55ZWFyIHx8IGRhdGUuZ2V0TW9udGgoKSAhPT0gdmlld0RhdGUubW9udGgpIHsKICAgICAgICAgICAgICAgIGFuZ3VsYXIuZXh0ZW5kKHZpZXdEYXRlLCB7eWVhcjogcGlja2VyLiRkYXRlLmdldEZ1bGxZZWFyKCksIG1vbnRoOiBwaWNrZXIuJGRhdGUuZ2V0TW9udGgoKSwgZGF0ZTogcGlja2VyLiRkYXRlLmdldERhdGUoKX0pOwogICAgICAgICAgICAgICAgcGlja2VyLiRidWlsZCgpOwogICAgICAgICAgICAgIH0gZWxzZSBpZihkYXRlLmdldERhdGUoKSAhPT0gdmlld0RhdGUuZGF0ZSkgewogICAgICAgICAgICAgICAgdmlld0RhdGUuZGF0ZSA9IHBpY2tlci4kZGF0ZS5nZXREYXRlKCk7CiAgICAgICAgICAgICAgICBwaWNrZXIuJHVwZGF0ZVNlbGVjdGVkKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBidWlsZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0RGF5T2ZNb250aCA9IG5ldyBEYXRlKHZpZXdEYXRlLnllYXIsIHZpZXdEYXRlLm1vbnRoLCAxKSwgZmlyc3REYXlPZk1vbnRoT2Zmc2V0ID0gZmlyc3REYXlPZk1vbnRoLmdldFRpbWV6b25lT2Zmc2V0KCk7CiAgICAgICAgICAgICAgdmFyIGZpcnN0RGF0ZSA9IG5ldyBEYXRlKCtmaXJzdERheU9mTW9udGggLSBtb2QoZmlyc3REYXlPZk1vbnRoLmdldERheSgpIC0gb3B0aW9ucy5zdGFydFdlZWssIDcpICogODY0ZTUpLCBmaXJzdERhdGVPZmZzZXQgPSBmaXJzdERhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICAgICAgICAgICAgICB2YXIgdG9kYXkgPSBuZXcgRGF0ZSgpLnRvRGF0ZVN0cmluZygpOwogICAgICAgICAgICAgIC8vIEhhbmRsZSBkYXlsaWdodCB0aW1lIHN3aXRjaAogICAgICAgICAgICAgIGlmKGZpcnN0RGF0ZU9mZnNldCAhPT0gZmlyc3REYXlPZk1vbnRoT2Zmc2V0KSBmaXJzdERhdGUgPSBuZXcgRGF0ZSgrZmlyc3REYXRlICsgKGZpcnN0RGF0ZU9mZnNldCAtIGZpcnN0RGF5T2ZNb250aE9mZnNldCkgKiA2MGUzKTsKICAgICAgICAgICAgICB2YXIgZGF5cyA9IFtdLCBkYXk7CiAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IDQyOyBpKyspIHsgLy8gPCA3ICogNgogICAgICAgICAgICAgICAgZGF5ID0gbmV3IERhdGUoZmlyc3REYXRlLmdldEZ1bGxZZWFyKCksIGZpcnN0RGF0ZS5nZXRNb250aCgpLCBmaXJzdERhdGUuZ2V0RGF0ZSgpICsgaSk7CiAgICAgICAgICAgICAgICBkYXlzLnB1c2goe2RhdGU6IGRheSwgaXNUb2RheTogZGF5LnRvRGF0ZVN0cmluZygpID09PSB0b2RheSwgbGFiZWw6IGRhdGVGaWx0ZXIoZGF5LCB0aGlzLmZvcm1hdCksIHNlbGVjdGVkOiBwaWNrZXIuJGRhdGUgJiYgdGhpcy5pc1NlbGVjdGVkKGRheSksIG11dGVkOiBkYXkuZ2V0TW9udGgoKSAhPT0gdmlld0RhdGUubW9udGgsIGRpc2FibGVkOiB0aGlzLmlzRGlzYWJsZWQoZGF5KX0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzY29wZS50aXRsZSA9IGRhdGVGaWx0ZXIoZmlyc3REYXlPZk1vbnRoLCAnTU1NTSB5eXl5Jyk7CiAgICAgICAgICAgICAgc2NvcGUuc2hvd0xhYmVscyA9IHRydWU7CiAgICAgICAgICAgICAgc2NvcGUubGFiZWxzID0gd2Vla0RheXNMYWJlbHNIdG1sOwogICAgICAgICAgICAgIHNjb3BlLnJvd3MgPSBzcGxpdChkYXlzLCB0aGlzLnNwbGl0KTsKICAgICAgICAgICAgICB0aGlzLmJ1aWx0ID0gdHJ1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNTZWxlY3RlZDogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgIHJldHVybiBwaWNrZXIuJGRhdGUgJiYgZGF0ZS5nZXRGdWxsWWVhcigpID09PSBwaWNrZXIuJGRhdGUuZ2V0RnVsbFllYXIoKSAmJiBkYXRlLmdldE1vbnRoKCkgPT09IHBpY2tlci4kZGF0ZS5nZXRNb250aCgpICYmIGRhdGUuZ2V0RGF0ZSgpID09PSBwaWNrZXIuJGRhdGUuZ2V0RGF0ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc0Rpc2FibGVkOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgdmFyIHRpbWUgPSBkYXRlLmdldFRpbWUoKTsKCiAgICAgICAgICAgICAgLy8gRGlzYWJsZWQgYmVjYXVzZSBvZiBtaW4vbWF4IGRhdGUuCiAgICAgICAgICAgICAgaWYgKHRpbWUgPCBvcHRpb25zLm1pbkRhdGUgfHwgdGltZSA+IG9wdGlvbnMubWF4RGF0ZSkgcmV0dXJuIHRydWU7CgogICAgICAgICAgICAgIC8vIERpc2FibGVkIGR1ZSB0byBiZWluZyBhIGRpc2FibGVkIGRheSBvZiB0aGUgd2VlawogICAgICAgICAgICAgIGlmIChvcHRpb25zLmRheXNPZldlZWtEaXNhYmxlZC5pbmRleE9mKGRhdGUuZ2V0RGF5KCkpICE9PSAtMSkgcmV0dXJuIHRydWU7CgogICAgICAgICAgICAgIC8vIERpc2FibGVkIGJlY2F1c2Ugb2YgZGlzYWJsZWQgZGF0ZSByYW5nZS4KICAgICAgICAgICAgICBpZiAob3B0aW9ucy5kaXNhYmxlZERhdGVSYW5nZXMpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb3B0aW9ucy5kaXNhYmxlZERhdGVSYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKHRpbWUgPj0gb3B0aW9ucy5kaXNhYmxlZERhdGVSYW5nZXNbaV0uc3RhcnQgJiYgdGltZSA8PSBvcHRpb25zLmRpc2FibGVkRGF0ZVJhbmdlc1tpXS5lbmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvbktleURvd246IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgICAgIHZhciBhY3R1YWxUaW1lID0gcGlja2VyLiRkYXRlLmdldFRpbWUoKTsKICAgICAgICAgICAgICB2YXIgbmV3RGF0ZTsKCiAgICAgICAgICAgICAgaWYoZXZ0LmtleUNvZGUgPT09IDM3KSBuZXdEYXRlID0gbmV3IERhdGUoYWN0dWFsVGltZSAtIDEgKiA4NjRlNSk7CiAgICAgICAgICAgICAgZWxzZSBpZihldnQua2V5Q29kZSA9PT0gMzgpIG5ld0RhdGUgPSBuZXcgRGF0ZShhY3R1YWxUaW1lIC0gNyAqIDg2NGU1KTsKICAgICAgICAgICAgICBlbHNlIGlmKGV2dC5rZXlDb2RlID09PSAzOSkgbmV3RGF0ZSA9IG5ldyBEYXRlKGFjdHVhbFRpbWUgKyAxICogODY0ZTUpOwogICAgICAgICAgICAgIGVsc2UgaWYoZXZ0LmtleUNvZGUgPT09IDQwKSBuZXdEYXRlID0gbmV3IERhdGUoYWN0dWFsVGltZSArIDcgKiA4NjRlNSk7CgogICAgICAgICAgICAgIGlmICghdGhpcy5pc0Rpc2FibGVkKG5ld0RhdGUpKSBwaWNrZXIuc2VsZWN0KG5ld0RhdGUsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCB7CiAgICAgICAgICAgIG5hbWU6ICdtb250aCcsCiAgICAgICAgICAgIGZvcm1hdDogJ01NTScsCiAgICAgICAgICAgIHNwbGl0OiA0LAogICAgICAgICAgICBzdGVwczogeyB5ZWFyOiAxIH0sCiAgICAgICAgICAgIHVwZGF0ZTogZnVuY3Rpb24oZGF0ZSwgZm9yY2UpIHsKICAgICAgICAgICAgICBpZighdGhpcy5idWlsdCB8fCBkYXRlLmdldEZ1bGxZZWFyKCkgIT09IHZpZXdEYXRlLnllYXIpIHsKICAgICAgICAgICAgICAgIGFuZ3VsYXIuZXh0ZW5kKHZpZXdEYXRlLCB7eWVhcjogcGlja2VyLiRkYXRlLmdldEZ1bGxZZWFyKCksIG1vbnRoOiBwaWNrZXIuJGRhdGUuZ2V0TW9udGgoKSwgZGF0ZTogcGlja2VyLiRkYXRlLmdldERhdGUoKX0pOwogICAgICAgICAgICAgICAgcGlja2VyLiRidWlsZCgpOwogICAgICAgICAgICAgIH0gZWxzZSBpZihkYXRlLmdldE1vbnRoKCkgIT09IHZpZXdEYXRlLm1vbnRoKSB7CiAgICAgICAgICAgICAgICBhbmd1bGFyLmV4dGVuZCh2aWV3RGF0ZSwge21vbnRoOiBwaWNrZXIuJGRhdGUuZ2V0TW9udGgoKSwgZGF0ZTogcGlja2VyLiRkYXRlLmdldERhdGUoKX0pOwogICAgICAgICAgICAgICAgcGlja2VyLiR1cGRhdGVTZWxlY3RlZCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgYnVpbGQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBmaXJzdE1vbnRoID0gbmV3IERhdGUodmlld0RhdGUueWVhciwgMCwgMSk7CiAgICAgICAgICAgICAgdmFyIG1vbnRocyA9IFtdLCBtb250aDsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDEyOyBpKyspIHsKICAgICAgICAgICAgICAgIG1vbnRoID0gbmV3IERhdGUodmlld0RhdGUueWVhciwgaSwgMSk7CiAgICAgICAgICAgICAgICBtb250aHMucHVzaCh7ZGF0ZTogbW9udGgsIGxhYmVsOiBkYXRlRmlsdGVyKG1vbnRoLCB0aGlzLmZvcm1hdCksIHNlbGVjdGVkOiBwaWNrZXIuJGlzU2VsZWN0ZWQobW9udGgpLCBkaXNhYmxlZDogdGhpcy5pc0Rpc2FibGVkKG1vbnRoKX0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzY29wZS50aXRsZSA9IGRhdGVGaWx0ZXIobW9udGgsICd5eXl5Jyk7CiAgICAgICAgICAgICAgc2NvcGUuc2hvd0xhYmVscyA9IGZhbHNlOwogICAgICAgICAgICAgIHNjb3BlLnJvd3MgPSBzcGxpdChtb250aHMsIHRoaXMuc3BsaXQpOwogICAgICAgICAgICAgIHRoaXMuYnVpbHQgPSB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc1NlbGVjdGVkOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHBpY2tlci4kZGF0ZSAmJiBkYXRlLmdldEZ1bGxZZWFyKCkgPT09IHBpY2tlci4kZGF0ZS5nZXRGdWxsWWVhcigpICYmIGRhdGUuZ2V0TW9udGgoKSA9PT0gcGlja2VyLiRkYXRlLmdldE1vbnRoKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzRGlzYWJsZWQ6IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgICAgICB2YXIgbGFzdERhdGUgPSArbmV3IERhdGUoZGF0ZS5nZXRGdWxsWWVhcigpLCBkYXRlLmdldE1vbnRoKCkgKyAxLCAwKTsKICAgICAgICAgICAgICByZXR1cm4gbGFzdERhdGUgPCBvcHRpb25zLm1pbkRhdGUgfHwgZGF0ZS5nZXRUaW1lKCkgPiBvcHRpb25zLm1heERhdGU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uS2V5RG93bjogZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICAgICAgdmFyIGFjdHVhbE1vbnRoID0gcGlja2VyLiRkYXRlLmdldE1vbnRoKCk7CiAgICAgICAgICAgICAgdmFyIG5ld0RhdGUgPSBuZXcgRGF0ZShwaWNrZXIuJGRhdGUpOwoKICAgICAgICAgICAgICBpZihldnQua2V5Q29kZSA9PT0gMzcpIG5ld0RhdGUuc2V0TW9udGgoYWN0dWFsTW9udGggLSAxKTsKICAgICAgICAgICAgICBlbHNlIGlmKGV2dC5rZXlDb2RlID09PSAzOCkgbmV3RGF0ZS5zZXRNb250aChhY3R1YWxNb250aCAtIDQpOwogICAgICAgICAgICAgIGVsc2UgaWYoZXZ0LmtleUNvZGUgPT09IDM5KSBuZXdEYXRlLnNldE1vbnRoKGFjdHVhbE1vbnRoICsgMSk7CiAgICAgICAgICAgICAgZWxzZSBpZihldnQua2V5Q29kZSA9PT0gNDApIG5ld0RhdGUuc2V0TW9udGgoYWN0dWFsTW9udGggKyA0KTsKCiAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzRGlzYWJsZWQobmV3RGF0ZSkpIHBpY2tlci5zZWxlY3QobmV3RGF0ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIHsKICAgICAgICAgICAgbmFtZTogJ3llYXInLAogICAgICAgICAgICBmb3JtYXQ6ICd5eXl5JywKICAgICAgICAgICAgc3BsaXQ6IDQsCiAgICAgICAgICAgIHN0ZXBzOiB7IHllYXI6IDEyIH0sCiAgICAgICAgICAgIHVwZGF0ZTogZnVuY3Rpb24oZGF0ZSwgZm9yY2UpIHsKICAgICAgICAgICAgICBpZighdGhpcy5idWlsdCB8fCBmb3JjZSB8fCBwYXJzZUludChkYXRlLmdldEZ1bGxZZWFyKCkvMjAsIDEwKSAhPT0gcGFyc2VJbnQodmlld0RhdGUueWVhci8yMCwgMTApKSB7CiAgICAgICAgICAgICAgICBhbmd1bGFyLmV4dGVuZCh2aWV3RGF0ZSwge3llYXI6IHBpY2tlci4kZGF0ZS5nZXRGdWxsWWVhcigpLCBtb250aDogcGlja2VyLiRkYXRlLmdldE1vbnRoKCksIGRhdGU6IHBpY2tlci4kZGF0ZS5nZXREYXRlKCl9KTsKICAgICAgICAgICAgICAgIHBpY2tlci4kYnVpbGQoKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYoZGF0ZS5nZXRGdWxsWWVhcigpICE9PSB2aWV3RGF0ZS55ZWFyKSB7CiAgICAgICAgICAgICAgICBhbmd1bGFyLmV4dGVuZCh2aWV3RGF0ZSwge3llYXI6IHBpY2tlci4kZGF0ZS5nZXRGdWxsWWVhcigpLCBtb250aDogcGlja2VyLiRkYXRlLmdldE1vbnRoKCksIGRhdGU6IHBpY2tlci4kZGF0ZS5nZXREYXRlKCl9KTsKICAgICAgICAgICAgICAgIHBpY2tlci4kdXBkYXRlU2VsZWN0ZWQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJ1aWxkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgZmlyc3RZZWFyID0gdmlld0RhdGUueWVhciAtIHZpZXdEYXRlLnllYXIgJSAodGhpcy5zcGxpdCAqIDMpOwogICAgICAgICAgICAgIHZhciB5ZWFycyA9IFtdLCB5ZWFyOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTI7IGkrKykgewogICAgICAgICAgICAgICAgeWVhciA9IG5ldyBEYXRlKGZpcnN0WWVhciArIGksIDAsIDEpOwogICAgICAgICAgICAgICAgeWVhcnMucHVzaCh7ZGF0ZTogeWVhciwgbGFiZWw6IGRhdGVGaWx0ZXIoeWVhciwgdGhpcy5mb3JtYXQpLCBzZWxlY3RlZDogcGlja2VyLiRpc1NlbGVjdGVkKHllYXIpLCBkaXNhYmxlZDogdGhpcy5pc0Rpc2FibGVkKHllYXIpfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjb3BlLnRpdGxlID0geWVhcnNbMF0ubGFiZWwgKyAnLScgKyB5ZWFyc1t5ZWFycy5sZW5ndGggLSAxXS5sYWJlbDsKICAgICAgICAgICAgICBzY29wZS5zaG93TGFiZWxzID0gZmFsc2U7CiAgICAgICAgICAgICAgc2NvcGUucm93cyA9IHNwbGl0KHllYXJzLCB0aGlzLnNwbGl0KTsKICAgICAgICAgICAgICB0aGlzLmJ1aWx0ID0gdHJ1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNTZWxlY3RlZDogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgIHJldHVybiBwaWNrZXIuJGRhdGUgJiYgZGF0ZS5nZXRGdWxsWWVhcigpID09PSBwaWNrZXIuJGRhdGUuZ2V0RnVsbFllYXIoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNEaXNhYmxlZDogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgIHZhciBsYXN0RGF0ZSA9ICtuZXcgRGF0ZShkYXRlLmdldEZ1bGxZZWFyKCkgKyAxLCAwLCAwKTsKICAgICAgICAgICAgICByZXR1cm4gbGFzdERhdGUgPCBvcHRpb25zLm1pbkRhdGUgfHwgZGF0ZS5nZXRUaW1lKCkgPiBvcHRpb25zLm1heERhdGU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uS2V5RG93bjogZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICAgICAgdmFyIGFjdHVhbFllYXIgPSBwaWNrZXIuJGRhdGUuZ2V0RnVsbFllYXIoKSwKICAgICAgICAgICAgICAgICAgbmV3RGF0ZSA9IG5ldyBEYXRlKHBpY2tlci4kZGF0ZSk7CgogICAgICAgICAgICAgIGlmKGV2dC5rZXlDb2RlID09PSAzNykgbmV3RGF0ZS5zZXRZZWFyKGFjdHVhbFllYXIgLSAxKTsKICAgICAgICAgICAgICBlbHNlIGlmKGV2dC5rZXlDb2RlID09PSAzOCkgbmV3RGF0ZS5zZXRZZWFyKGFjdHVhbFllYXIgLSA0KTsKICAgICAgICAgICAgICBlbHNlIGlmKGV2dC5rZXlDb2RlID09PSAzOSkgbmV3RGF0ZS5zZXRZZWFyKGFjdHVhbFllYXIgKyAxKTsKICAgICAgICAgICAgICBlbHNlIGlmKGV2dC5rZXlDb2RlID09PSA0MCkgbmV3RGF0ZS5zZXRZZWFyKGFjdHVhbFllYXIgKyA0KTsKCiAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzRGlzYWJsZWQobmV3RGF0ZSkpIHBpY2tlci5zZWxlY3QobmV3RGF0ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH1dOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgdmlld3M6IG9wdGlvbnMubWluVmlldyA/IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHZpZXdzLCBvcHRpb25zLm1pblZpZXcpIDogdmlld3MsCiAgICAgICAgICB2aWV3RGF0ZTogdmlld0RhdGUKICAgICAgICB9OwoKICAgICAgfTsKCiAgICB9XTsKCiAgfSk7CgovLyBTb3VyY2U6IGRhdGUtcGFyc2VyLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5oZWxwZXJzLmRhdGVQYXJzZXInLCBbXSkKCi5wcm92aWRlcignJGRhdGVQYXJzZXInLCBbIiRsb2NhbGVQcm92aWRlciIsIGZ1bmN0aW9uKCRsb2NhbGVQcm92aWRlcikgewoKICAvLyBkZWZpbmUgYSBjdXN0b20gUGFyc2VEYXRlIG9iamVjdCB0byB1c2UgaW5zdGVhZCBvZiBuYXRpdmUgRGF0ZSAKICAvLyB0byBhdm9pZCBkYXRlIHZhbHVlcyB3cmFwcGluZyB3aGVuIHNldHRpbmcgZGF0ZSBjb21wb25lbnQgdmFsdWVzCiAgZnVuY3Rpb24gUGFyc2VEYXRlKCkgewogICAgdGhpcy55ZWFyID0gMTk3MDsKICAgIHRoaXMubW9udGggPSAwOwogICAgdGhpcy5kYXkgPSAxOwogICAgdGhpcy5ob3VycyA9IDA7CiAgICB0aGlzLm1pbnV0ZXMgPSAwOwogICAgdGhpcy5zZWNvbmRzID0gMDsKICAgIHRoaXMubWlsbGlzZWNvbmRzID0gMDsKICB9CgogIFBhcnNlRGF0ZS5wcm90b3R5cGUuc2V0TWlsbGlzZWNvbmRzID0gZnVuY3Rpb24odmFsdWUpIHsgdGhpcy5taWxsaXNlY29uZHMgPSB2YWx1ZTsgfTsKICBQYXJzZURhdGUucHJvdG90eXBlLnNldFNlY29uZHMgPSBmdW5jdGlvbih2YWx1ZSkgeyB0aGlzLnNlY29uZHMgPSB2YWx1ZTsgfTsKICBQYXJzZURhdGUucHJvdG90eXBlLnNldE1pbnV0ZXMgPSBmdW5jdGlvbih2YWx1ZSkgeyB0aGlzLm1pbnV0ZXMgPSB2YWx1ZTsgfTsKICBQYXJzZURhdGUucHJvdG90eXBlLnNldEhvdXJzID0gZnVuY3Rpb24odmFsdWUpIHsgdGhpcy5ob3VycyA9IHZhbHVlOyB9OwogIFBhcnNlRGF0ZS5wcm90b3R5cGUuZ2V0SG91cnMgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuaG91cnM7IH07CiAgUGFyc2VEYXRlLnByb3RvdHlwZS5zZXREYXRlID0gZnVuY3Rpb24odmFsdWUpIHsgdGhpcy5kYXkgPSB2YWx1ZTsgfTsKICBQYXJzZURhdGUucHJvdG90eXBlLnNldE1vbnRoID0gZnVuY3Rpb24odmFsdWUpIHsgdGhpcy5tb250aCA9IHZhbHVlOyB9OwogIFBhcnNlRGF0ZS5wcm90b3R5cGUuc2V0RnVsbFllYXIgPSBmdW5jdGlvbih2YWx1ZSkgeyB0aGlzLnllYXIgPSB2YWx1ZTsgfTsKICBQYXJzZURhdGUucHJvdG90eXBlLmZyb21EYXRlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHRoaXMueWVhciA9IHZhbHVlLmdldEZ1bGxZZWFyKCk7CiAgICB0aGlzLm1vbnRoID0gdmFsdWUuZ2V0TW9udGgoKTsKICAgIHRoaXMuZGF5ID0gdmFsdWUuZ2V0RGF0ZSgpOwogICAgdGhpcy5ob3VycyA9IHZhbHVlLmdldEhvdXJzKCk7CiAgICB0aGlzLm1pbnV0ZXMgPSB2YWx1ZS5nZXRNaW51dGVzKCk7CiAgICB0aGlzLnNlY29uZHMgPSB2YWx1ZS5nZXRTZWNvbmRzKCk7CiAgICB0aGlzLm1pbGxpc2Vjb25kcyA9IHZhbHVlLmdldE1pbGxpc2Vjb25kcygpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgUGFyc2VEYXRlLnByb3RvdHlwZS50b0RhdGUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgRGF0ZSh0aGlzLnllYXIsIHRoaXMubW9udGgsIHRoaXMuZGF5LCB0aGlzLmhvdXJzLCB0aGlzLm1pbnV0ZXMsIHRoaXMuc2Vjb25kcywgdGhpcy5taWxsaXNlY29uZHMpOwogIH07CgogIHZhciBwcm90byA9IFBhcnNlRGF0ZS5wcm90b3R5cGU7CgogIGZ1bmN0aW9uIG5vb3AoKSB7CiAgfQoKICBmdW5jdGlvbiBpc051bWVyaWMobikgewogICAgcmV0dXJuICFpc05hTihwYXJzZUZsb2F0KG4pKSAmJiBpc0Zpbml0ZShuKTsKICB9CgogIGZ1bmN0aW9uIGluZGV4T2ZDYXNlSW5zZW5zaXRpdmUoYXJyYXksIHZhbHVlKSB7CiAgICB2YXIgbGVuID0gYXJyYXkubGVuZ3RoLCBzdHI9dmFsdWUudG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpOwogICAgZm9yICh2YXIgaT0wOyBpPGxlbjsgaSsrKSB7CiAgICAgIGlmIChhcnJheVtpXS50b0xvd2VyQ2FzZSgpID09PSBzdHIpIHsgcmV0dXJuIGk7IH0KICAgIH0KICAgIHJldHVybiAtMTsgLy8gUmV0dXJuIC0xIHBlciB0aGUgIkFycmF5LmluZGV4T2YoKSIgbWV0aG9kLiAgICAKICB9CgogIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICBmb3JtYXQ6ICdzaG9ydERhdGUnLAogICAgc3RyaWN0OiBmYWxzZQogIH07CgogIHRoaXMuJGdldCA9IFsiJGxvY2FsZSIsICJkYXRlRmlsdGVyIiwgZnVuY3Rpb24oJGxvY2FsZSwgZGF0ZUZpbHRlcikgewoKICAgIHZhciBEYXRlUGFyc2VyRmFjdG9yeSA9IGZ1bmN0aW9uKGNvbmZpZykgewoKICAgICAgdmFyIG9wdGlvbnMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgZGVmYXVsdHMsIGNvbmZpZyk7CgogICAgICB2YXIgJGRhdGVQYXJzZXIgPSB7fTsKCiAgICAgIHZhciByZWdFeHBNYXAgPSB7CiAgICAgICAgJ3NzcycgICA6ICdbMC05XXszfScsCiAgICAgICAgJ3NzJyAgICA6ICdbMC01XVswLTldJywKICAgICAgICAncycgICAgIDogb3B0aW9ucy5zdHJpY3QgPyAnWzEtNV0/WzAtOV0nIDogJ1swLTldfFswLTVdWzAtOV0nLAogICAgICAgICdtbScgICAgOiAnWzAtNV1bMC05XScsCiAgICAgICAgJ20nICAgICA6IG9wdGlvbnMuc3RyaWN0ID8gJ1sxLTVdP1swLTldJyA6ICdbMC05XXxbMC01XVswLTldJywKICAgICAgICAnSEgnICAgIDogJ1swMV1bMC05XXwyWzAtM10nLAogICAgICAgICdIJyAgICAgOiBvcHRpb25zLnN0cmljdCA/ICcxP1swLTldfDJbMC0zXScgOiAnWzAxXT9bMC05XXwyWzAtM10nLAogICAgICAgICdoaCcgICAgOiAnWzBdWzEtOV18WzFdWzAxMl0nLAogICAgICAgICdoJyAgICAgOiBvcHRpb25zLnN0cmljdCA/ICdbMS05XXwxWzAxMl0nIDogJzA/WzEtOV18MVswMTJdJywKICAgICAgICAnYScgICAgIDogJ0FNfFBNJywKICAgICAgICAnRUVFRScgIDogJGxvY2FsZS5EQVRFVElNRV9GT1JNQVRTLkRBWS5qb2luKCd8JyksCiAgICAgICAgJ0VFRScgICA6ICRsb2NhbGUuREFURVRJTUVfRk9STUFUUy5TSE9SVERBWS5qb2luKCd8JyksCiAgICAgICAgJ2RkJyAgICA6ICcwWzEtOV18WzEyXVswLTldfDNbMDFdJywKICAgICAgICAnZCcgICAgIDogb3B0aW9ucy5zdHJpY3QgPyAnWzEtOV18WzEtMl1bMC05XXwzWzAxXScgOiAnMD9bMS05XXxbMS0yXVswLTldfDNbMDFdJywKICAgICAgICAnTU1NTScgIDogJGxvY2FsZS5EQVRFVElNRV9GT1JNQVRTLk1PTlRILmpvaW4oJ3wnKSwKICAgICAgICAnTU1NJyAgIDogJGxvY2FsZS5EQVRFVElNRV9GT1JNQVRTLlNIT1JUTU9OVEguam9pbignfCcpLAogICAgICAgICdNTScgICAgOiAnMFsxLTldfDFbMDEyXScsCiAgICAgICAgJ00nICAgICA6IG9wdGlvbnMuc3RyaWN0ID8gJ1sxLTldfDFbMDEyXScgOiAnMD9bMS05XXwxWzAxMl0nLAogICAgICAgICd5eXl5JyAgOiAnWzFdezF9WzAtOV17M318WzJdezF9WzAtOV17M30nLAogICAgICAgICd5eScgICAgOiAnWzAtOV17Mn0nLAogICAgICAgICd5JyAgICAgOiBvcHRpb25zLnN0cmljdCA/ICctPygwfFsxLTldWzAtOV17MCwzfSknIDogJy0/MCpbMC05XXsxLDR9JywKICAgICAgfTsKCiAgICAgIHZhciBzZXRGbk1hcCA9IHsKICAgICAgICAnc3NzJyAgIDogcHJvdG8uc2V0TWlsbGlzZWNvbmRzLAogICAgICAgICdzcycgICAgOiBwcm90by5zZXRTZWNvbmRzLAogICAgICAgICdzJyAgICAgOiBwcm90by5zZXRTZWNvbmRzLAogICAgICAgICdtbScgICAgOiBwcm90by5zZXRNaW51dGVzLAogICAgICAgICdtJyAgICAgOiBwcm90by5zZXRNaW51dGVzLAogICAgICAgICdISCcgICAgOiBwcm90by5zZXRIb3VycywKICAgICAgICAnSCcgICAgIDogcHJvdG8uc2V0SG91cnMsCiAgICAgICAgJ2hoJyAgICA6IHByb3RvLnNldEhvdXJzLAogICAgICAgICdoJyAgICAgOiBwcm90by5zZXRIb3VycywKICAgICAgICAnRUVFRScgIDogbm9vcCwKICAgICAgICAnRUVFJyAgIDogbm9vcCwKICAgICAgICAnZGQnICAgIDogcHJvdG8uc2V0RGF0ZSwKICAgICAgICAnZCcgICAgIDogcHJvdG8uc2V0RGF0ZSwKICAgICAgICAnYScgICAgIDogZnVuY3Rpb24odmFsdWUpIHsgdmFyIGhvdXJzID0gdGhpcy5nZXRIb3VycygpICUgMTI7IHJldHVybiB0aGlzLnNldEhvdXJzKHZhbHVlLm1hdGNoKC9wbS9pKSA/IGhvdXJzICsgMTIgOiBob3Vycyk7IH0sCiAgICAgICAgJ01NTU0nICA6IGZ1bmN0aW9uKHZhbHVlKSB7IHJldHVybiB0aGlzLnNldE1vbnRoKGluZGV4T2ZDYXNlSW5zZW5zaXRpdmUoJGxvY2FsZS5EQVRFVElNRV9GT1JNQVRTLk1PTlRILCB2YWx1ZSkpOyB9LAogICAgICAgICdNTU0nICAgOiBmdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdGhpcy5zZXRNb250aChpbmRleE9mQ2FzZUluc2Vuc2l0aXZlKCRsb2NhbGUuREFURVRJTUVfRk9STUFUUy5TSE9SVE1PTlRILCB2YWx1ZSkpOyB9LAogICAgICAgICdNTScgICAgOiBmdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdGhpcy5zZXRNb250aCgxICogdmFsdWUgLSAxKTsgfSwKICAgICAgICAnTScgICAgIDogZnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIHRoaXMuc2V0TW9udGgoMSAqIHZhbHVlIC0gMSk7IH0sCiAgICAgICAgJ3l5eXknICA6IHByb3RvLnNldEZ1bGxZZWFyLAogICAgICAgICd5eScgICAgOiBmdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdGhpcy5zZXRGdWxsWWVhcigyMDAwICsgMSAqIHZhbHVlKTsgfSwKICAgICAgICAneScgICAgIDogcHJvdG8uc2V0RnVsbFllYXIKICAgICAgfTsKCiAgICAgIHZhciByZWdleCwgc2V0TWFwOwoKICAgICAgJGRhdGVQYXJzZXIuaW5pdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICRkYXRlUGFyc2VyLiRmb3JtYXQgPSAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFNbb3B0aW9ucy5mb3JtYXRdIHx8IG9wdGlvbnMuZm9ybWF0OwogICAgICAgIHJlZ2V4ID0gcmVnRXhwRm9yRm9ybWF0KCRkYXRlUGFyc2VyLiRmb3JtYXQpOwogICAgICAgIHNldE1hcCA9IHNldE1hcEZvckZvcm1hdCgkZGF0ZVBhcnNlci4kZm9ybWF0KTsKICAgICAgfTsKCiAgICAgICRkYXRlUGFyc2VyLmlzVmFsaWQgPSBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgaWYoYW5ndWxhci5pc0RhdGUoZGF0ZSkpIHJldHVybiAhaXNOYU4oZGF0ZS5nZXRUaW1lKCkpOwogICAgICAgIHJldHVybiByZWdleC50ZXN0KGRhdGUpOwogICAgICB9OwoKICAgICAgJGRhdGVQYXJzZXIucGFyc2UgPSBmdW5jdGlvbih2YWx1ZSwgYmFzZURhdGUsIGZvcm1hdCkgewogICAgICAgIGlmKGFuZ3VsYXIuaXNEYXRlKHZhbHVlKSkgdmFsdWUgPSBkYXRlRmlsdGVyKHZhbHVlLCBmb3JtYXQgfHwgJGRhdGVQYXJzZXIuJGZvcm1hdCk7CiAgICAgICAgdmFyIGZvcm1hdFJlZ2V4ID0gZm9ybWF0ID8gcmVnRXhwRm9yRm9ybWF0KGZvcm1hdCkgOiByZWdleDsKICAgICAgICB2YXIgZm9ybWF0U2V0TWFwID0gZm9ybWF0ID8gc2V0TWFwRm9yRm9ybWF0KGZvcm1hdCkgOiBzZXRNYXA7CiAgICAgICAgdmFyIG1hdGNoZXMgPSBmb3JtYXRSZWdleC5leGVjKHZhbHVlKTsKICAgICAgICBpZighbWF0Y2hlcykgcmV0dXJuIGZhbHNlOwogICAgICAgIC8vIHVzZSBjdXN0b20gUGFyc2VEYXRlIG9iamVjdCB0byBzZXQgcGFyc2VkIHZhbHVlcwogICAgICAgIHZhciBkYXRlID0gYmFzZURhdGUgJiYgIWlzTmFOKGJhc2VEYXRlLmdldFRpbWUoKSkgPyBuZXcgUGFyc2VEYXRlKCkuZnJvbURhdGUoYmFzZURhdGUpIDogbmV3IFBhcnNlRGF0ZSgpLmZyb21EYXRlKG5ldyBEYXRlKDE5NzAsIDAsIDEsIDApKTsKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbWF0Y2hlcy5sZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgIGZvcm1hdFNldE1hcFtpXSAmJiBmb3JtYXRTZXRNYXBbaV0uY2FsbChkYXRlLCBtYXRjaGVzW2krMV0pOwogICAgICAgIH0KICAgICAgICAvLyBjb252ZXJ0IGJhY2sgdG8gbmF0aXZlIERhdGUgb2JqZWN0CiAgICAgICAgcmV0dXJuIGRhdGUudG9EYXRlKCk7CiAgICAgIH07CgogICAgICAkZGF0ZVBhcnNlci5nZXREYXRlRm9yQXR0cmlidXRlID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBkYXRlOwoKICAgICAgICBpZih2YWx1ZSA9PT0gJ3RvZGF5JykgewogICAgICAgICAgdmFyIHRvZGF5ID0gbmV3IERhdGUoKTsKICAgICAgICAgIGRhdGUgPSBuZXcgRGF0ZSh0b2RheS5nZXRGdWxsWWVhcigpLCB0b2RheS5nZXRNb250aCgpLCB0b2RheS5nZXREYXRlKCkgKyAoa2V5ID09PSAnbWF4RGF0ZScgPyAxIDogMCksIDAsIDAsIDAsIChrZXkgPT09ICdtaW5EYXRlJyA/IDAgOiAtMSkpOwogICAgICAgIH0gZWxzZSBpZihhbmd1bGFyLmlzU3RyaW5nKHZhbHVlKSAmJiB2YWx1ZS5tYXRjaCgvXiIuKyIkLykpIHsgLy8gU3VwcG9ydCB7eyBkYXRlT2JqIH19CiAgICAgICAgICBkYXRlID0gbmV3IERhdGUodmFsdWUuc3Vic3RyKDEsIHZhbHVlLmxlbmd0aCAtIDIpKTsKICAgICAgICB9IGVsc2UgaWYoaXNOdW1lcmljKHZhbHVlKSkgewogICAgICAgICAgZGF0ZSA9IG5ldyBEYXRlKHBhcnNlSW50KHZhbHVlLCAxMCkpOwogICAgICAgIH0gZWxzZSBpZiAoYW5ndWxhci5pc1N0cmluZyh2YWx1ZSkgJiYgMCA9PT0gdmFsdWUubGVuZ3RoKSB7IC8vIFJlc2V0IGRhdGUKICAgICAgICAgIGRhdGUgPSBrZXkgPT09ICdtaW5EYXRlJyA/IC1JbmZpbml0eSA6ICtJbmZpbml0eTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGF0ZSA9IG5ldyBEYXRlKHZhbHVlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBkYXRlOwogICAgICB9OwoKICAgICAgJGRhdGVQYXJzZXIuZ2V0VGltZUZvckF0dHJpYnV0ZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICB2YXIgdGltZTsKCiAgICAgICAgaWYodmFsdWUgPT09ICdub3cnKSB7CiAgICAgICAgICB0aW1lID0gbmV3IERhdGUoKS5zZXRGdWxsWWVhcigxOTcwLCAwLCAxKTsKICAgICAgICB9IGVsc2UgaWYoYW5ndWxhci5pc1N0cmluZyh2YWx1ZSkgJiYgdmFsdWUubWF0Y2goL14iLisiJC8pKSB7CiAgICAgICAgICB0aW1lID0gbmV3IERhdGUodmFsdWUuc3Vic3RyKDEsIHZhbHVlLmxlbmd0aCAtIDIpKS5zZXRGdWxsWWVhcigxOTcwLCAwLCAxKTsKICAgICAgICB9IGVsc2UgaWYoaXNOdW1lcmljKHZhbHVlKSkgewogICAgICAgICAgdGltZSA9IG5ldyBEYXRlKHBhcnNlSW50KHZhbHVlLCAxMCkpLnNldEZ1bGxZZWFyKDE5NzAsIDAsIDEpOwogICAgICAgIH0gZWxzZSBpZiAoYW5ndWxhci5pc1N0cmluZyh2YWx1ZSkgJiYgMCA9PT0gdmFsdWUubGVuZ3RoKSB7IC8vIFJlc2V0IHRpbWUKICAgICAgICAgIHRpbWUgPSBrZXkgPT09ICdtaW5UaW1lJyA/IC1JbmZpbml0eSA6ICtJbmZpbml0eTsKICAgICAgICB9IGVsc2UgeyAKICAgICAgICAgIHRpbWUgPSAkZGF0ZVBhcnNlci5wYXJzZSh2YWx1ZSwgbmV3IERhdGUoMTk3MCwgMCwgMSwgMCkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRpbWU7CiAgICAgIH07CgogICAgICAvLyBQcml2YXRlIGZ1bmN0aW9ucwoKICAgICAgZnVuY3Rpb24gc2V0TWFwRm9yRm9ybWF0KGZvcm1hdCkgewogICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoc2V0Rm5NYXApLCBpOwogICAgICAgIHZhciBtYXAgPSBbXSwgc29ydGVkTWFwID0gW107CiAgICAgICAgLy8gTWFwIHRvIHNldEZuCiAgICAgICAgdmFyIGNsb25lZEZvcm1hdCA9IGZvcm1hdDsKICAgICAgICBmb3IoaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZihmb3JtYXQuc3BsaXQoa2V5c1tpXSkubGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgaW5kZXggPSBjbG9uZWRGb3JtYXQuc2VhcmNoKGtleXNbaV0pOwogICAgICAgICAgICBmb3JtYXQgPSBmb3JtYXQuc3BsaXQoa2V5c1tpXSkuam9pbignJyk7CiAgICAgICAgICAgIGlmKHNldEZuTWFwW2tleXNbaV1dKSB7CiAgICAgICAgICAgICAgbWFwW2luZGV4XSA9IHNldEZuTWFwW2tleXNbaV1dOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIFNvcnQgcmVzdWx0IG1hcAogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChtYXAsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgIC8vIGNvbmRpdGlvbmFsIHJlcXVpcmVkIHNpbmNlIGFuZ3VsYXIuZm9yRWFjaCBicm9rZSBhcm91bmQgdjEuMi4yMQogICAgICAgICAgLy8gcmVsYXRlZCBwcjogaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9wdWxsLzg1MjUKICAgICAgICAgIGlmKHYpIHNvcnRlZE1hcC5wdXNoKHYpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBzb3J0ZWRNYXA7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGVzY2FwZVJlc2VydmVkU3ltYm9scyh0ZXh0KSB7CiAgICAgICAgcmV0dXJuIHRleHQucmVwbGFjZSgvXC8vZywgJ1tcXC9dJykucmVwbGFjZSgnLy0vZycsICdbLV0nKS5yZXBsYWNlKC9cLi9nLCAnWy5dJykucmVwbGFjZSgvXFxzL2csICdbXFxzXScpOwogICAgICB9CgogICAgICBmdW5jdGlvbiByZWdFeHBGb3JGb3JtYXQoZm9ybWF0KSB7CiAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhyZWdFeHBNYXApLCBpOwoKICAgICAgICB2YXIgcmUgPSBmb3JtYXQ7CiAgICAgICAgLy8gQWJzdHJhY3QgcmVwbGFjZXMgdG8gYXZvaWQgY29sbGlzaW9ucwogICAgICAgIGZvcihpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHJlID0gcmUuc3BsaXQoa2V5c1tpXSkuam9pbignJHsnICsgaSArICd9Jyk7CiAgICAgICAgfQogICAgICAgIC8vIFJlcGxhY2UgYWJzdHJhY3RlZCB2YWx1ZXMKICAgICAgICBmb3IoaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZSA9IHJlLnNwbGl0KCckeycgKyBpICsgJ30nKS5qb2luKCcoJyArIHJlZ0V4cE1hcFtrZXlzW2ldXSArICcpJyk7CiAgICAgICAgfQogICAgICAgIGZvcm1hdCA9IGVzY2FwZVJlc2VydmVkU3ltYm9scyhmb3JtYXQpOwoKICAgICAgICByZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyByZSArICckJywgWydpJ10pOwogICAgICB9CgogICAgICAkZGF0ZVBhcnNlci5pbml0KCk7CiAgICAgIHJldHVybiAkZGF0ZVBhcnNlcjsKCiAgICB9OwoKICAgIHJldHVybiBEYXRlUGFyc2VyRmFjdG9yeTsKCiAgfV07Cgp9XSk7CgovLyBTb3VyY2U6IGRlYm91bmNlLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5oZWxwZXJzLmRlYm91bmNlJywgW10pCgovLyBAc291cmNlIGphc2hrZW5hcy91bmRlcnNjb3JlCi8vIEB1cmwgaHR0cHM6Ly9naXRodWIuY29tL2phc2hrZW5hcy91bmRlcnNjb3JlL2Jsb2IvMS41LjIvdW5kZXJzY29yZS5qcyNMNjkzCi5mYWN0b3J5KCdkZWJvdW5jZScsIFsiJHRpbWVvdXQiLCBmdW5jdGlvbigkdGltZW91dCkgewogIHJldHVybiBmdW5jdGlvbihmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgIHZhciB0aW1lb3V0ID0gbnVsbDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLAogICAgICAgIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgY2FsbE5vdyA9IGltbWVkaWF0ZSAmJiAhdGltZW91dDsKICAgICAgaWYodGltZW91dCkgewogICAgICAgICR0aW1lb3V0LmNhbmNlbCh0aW1lb3V0KTsKICAgICAgfQogICAgICB0aW1lb3V0ID0gJHRpbWVvdXQoZnVuY3Rpb24gbGF0ZXIoKSB7CiAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgaWYoIWltbWVkaWF0ZSkgewogICAgICAgICAgZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICB9CiAgICAgIH0sIHdhaXQsIGZhbHNlKTsKICAgICAgaWYoY2FsbE5vdykgewogICAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRpbWVvdXQ7CiAgICB9OwogIH07Cn1dKQoKCi8vIEBzb3VyY2UgamFzaGtlbmFzL3VuZGVyc2NvcmUKLy8gQHVybCBodHRwczovL2dpdGh1Yi5jb20vamFzaGtlbmFzL3VuZGVyc2NvcmUvYmxvYi8xLjUuMi91bmRlcnNjb3JlLmpzI0w2NjEKLmZhY3RvcnkoJ3Rocm90dGxlJywgWyIkdGltZW91dCIsIGZ1bmN0aW9uKCR0aW1lb3V0KSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIG9wdGlvbnMpIHsKICAgIHZhciB0aW1lb3V0ID0gbnVsbDsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBjb250ZXh0ID0gdGhpcywKICAgICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICBpZighdGltZW91dCkgewogICAgICAgIGlmKG9wdGlvbnMubGVhZGluZyAhPT0gZmFsc2UpIHsKICAgICAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfQogICAgICAgIHRpbWVvdXQgPSAkdGltZW91dChmdW5jdGlvbiBsYXRlcigpIHsKICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgICAgaWYob3B0aW9ucy50cmFpbGluZyAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgIH0KICAgICAgICB9LCB3YWl0LCBmYWxzZSk7CiAgICAgIH0KICAgIH07CiAgfTsKfV0pOwoKLy8gU291cmNlOiBkaW1lbnNpb25zLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5oZWxwZXJzLmRpbWVuc2lvbnMnLCBbXSkKCiAgLmZhY3RvcnkoJ2RpbWVuc2lvbnMnLCBbIiRkb2N1bWVudCIsICIkd2luZG93IiwgZnVuY3Rpb24oJGRvY3VtZW50LCAkd2luZG93KSB7CgogICAgdmFyIGpxTGl0ZSA9IGFuZ3VsYXIuZWxlbWVudDsKICAgIHZhciBmbiA9IHt9OwoKICAgIC8qKgogICAgICogVGVzdCB0aGUgZWxlbWVudCBub2RlTmFtZQogICAgICogQHBhcmFtIGVsZW1lbnQKICAgICAqIEBwYXJhbSBuYW1lCiAgICAgKi8KICAgIHZhciBub2RlTmFtZSA9IGZuLm5vZGVOYW1lID0gZnVuY3Rpb24oZWxlbWVudCwgbmFtZSkgewogICAgICByZXR1cm4gZWxlbWVudC5ub2RlTmFtZSAmJiBlbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBlbGVtZW50IGNvbXB1dGVkIHN0eWxlCiAgICAgKiBAcGFyYW0gZWxlbWVudAogICAgICogQHBhcmFtIHByb3AKICAgICAqIEBwYXJhbSBleHRyYQogICAgICovCiAgICBmbi5jc3MgPSBmdW5jdGlvbihlbGVtZW50LCBwcm9wLCBleHRyYSkgewogICAgICB2YXIgdmFsdWU7CiAgICAgIGlmIChlbGVtZW50LmN1cnJlbnRTdHlsZSkgeyAvL0lFCiAgICAgICAgdmFsdWUgPSBlbGVtZW50LmN1cnJlbnRTdHlsZVtwcm9wXTsKICAgICAgfSBlbHNlIGlmICh3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSkgewogICAgICAgIHZhbHVlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudClbcHJvcF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgPSBlbGVtZW50LnN0eWxlW3Byb3BdOwogICAgICB9CiAgICAgIHJldHVybiBleHRyYSA9PT0gdHJ1ZSA/IHBhcnNlRmxvYXQodmFsdWUpIHx8IDAgOiB2YWx1ZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBQcm92aWRlcyByZWFkLW9ubHkgZXF1aXZhbGVudCBvZiBqUXVlcnkncyBvZmZzZXQgZnVuY3Rpb246CiAgICAgKiBAcmVxdWlyZWQtYnkgYm9vdHN0cmFwLXRvb2x0aXAsIGJvb3RzdHJhcC1hZmZpeAogICAgICogQHVybCBodHRwOi8vYXBpLmpxdWVyeS5jb20vb2Zmc2V0LwogICAgICogQHBhcmFtIGVsZW1lbnQKICAgICAqLwogICAgZm4ub2Zmc2V0ID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICB2YXIgYm94UmVjdCA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHZhciBkb2NFbGVtZW50ID0gZWxlbWVudC5vd25lckRvY3VtZW50OwogICAgICByZXR1cm4gewogICAgICAgIHdpZHRoOiBib3hSZWN0LndpZHRoIHx8IGVsZW1lbnQub2Zmc2V0V2lkdGgsCiAgICAgICAgaGVpZ2h0OiBib3hSZWN0LmhlaWdodCB8fCBlbGVtZW50Lm9mZnNldEhlaWdodCwKICAgICAgICB0b3A6IGJveFJlY3QudG9wICsgKHdpbmRvdy5wYWdlWU9mZnNldCB8fCBkb2NFbGVtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3ApIC0gKGRvY0VsZW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFRvcCB8fCAwKSwKICAgICAgICBsZWZ0OiBib3hSZWN0LmxlZnQgKyAod2luZG93LnBhZ2VYT2Zmc2V0IHx8IGRvY0VsZW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQpIC0gKGRvY0VsZW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudExlZnQgfHwgMCkKICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiBQcm92aWRlcyByZWFkLW9ubHkgZXF1aXZhbGVudCBvZiBqUXVlcnkncyBwb3NpdGlvbiBmdW5jdGlvbgogICAgICogQHJlcXVpcmVkLWJ5IGJvb3RzdHJhcC10b29sdGlwLCBib290c3RyYXAtYWZmaXgKICAgICAqIEB1cmwgaHR0cDovL2FwaS5qcXVlcnkuY29tL29mZnNldC8KICAgICAqIEBwYXJhbSBlbGVtZW50CiAgICAgKi8KICAgIGZuLnBvc2l0aW9uID0gZnVuY3Rpb24oZWxlbWVudCkgewoKICAgICAgdmFyIG9mZnNldFBhcmVudFJlY3QgPSB7dG9wOiAwLCBsZWZ0OiAwfSwKICAgICAgICAgIG9mZnNldFBhcmVudEVsZW1lbnQsCiAgICAgICAgICBvZmZzZXQ7CgogICAgICAvLyBGaXhlZCBlbGVtZW50cyBhcmUgb2Zmc2V0IGZyb20gd2luZG93IChwYXJlbnRPZmZzZXQgPSB7dG9wOjAsIGxlZnQ6IDB9LCBiZWNhdXNlIGl0IGlzIGl0J3Mgb25seSBvZmZzZXQgcGFyZW50CiAgICAgIGlmIChmbi5jc3MoZWxlbWVudCwgJ3Bvc2l0aW9uJykgPT09ICdmaXhlZCcpIHsKCiAgICAgICAgLy8gV2UgYXNzdW1lIHRoYXQgZ2V0Qm91bmRpbmdDbGllbnRSZWN0IGlzIGF2YWlsYWJsZSB3aGVuIGNvbXB1dGVkIHBvc2l0aW9uIGlzIGZpeGVkCiAgICAgICAgb2Zmc2V0ID0gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCiAgICAgIH0gZWxzZSB7CgogICAgICAgIC8vIEdldCAqcmVhbCogb2Zmc2V0UGFyZW50RWxlbWVudAogICAgICAgIG9mZnNldFBhcmVudEVsZW1lbnQgPSBvZmZzZXRQYXJlbnQoZWxlbWVudCk7CiAgICAgICAgb2Zmc2V0ID0gZm4ub2Zmc2V0KGVsZW1lbnQpOwoKICAgICAgICAvLyBHZXQgY29ycmVjdCBvZmZzZXRzCiAgICAgICAgb2Zmc2V0ID0gZm4ub2Zmc2V0KGVsZW1lbnQpOwogICAgICAgIGlmICghbm9kZU5hbWUob2Zmc2V0UGFyZW50RWxlbWVudCwgJ2h0bWwnKSkgewogICAgICAgICAgb2Zmc2V0UGFyZW50UmVjdCA9IGZuLm9mZnNldChvZmZzZXRQYXJlbnRFbGVtZW50KTsKICAgICAgICB9CgogICAgICAgIC8vIEFkZCBvZmZzZXRQYXJlbnQgYm9yZGVycwogICAgICAgIG9mZnNldFBhcmVudFJlY3QudG9wICs9IGZuLmNzcyhvZmZzZXRQYXJlbnRFbGVtZW50LCAnYm9yZGVyVG9wV2lkdGgnLCB0cnVlKTsKICAgICAgICBvZmZzZXRQYXJlbnRSZWN0LmxlZnQgKz0gZm4uY3NzKG9mZnNldFBhcmVudEVsZW1lbnQsICdib3JkZXJMZWZ0V2lkdGgnLCB0cnVlKTsKICAgICAgfQoKICAgICAgLy8gU3VidHJhY3QgcGFyZW50IG9mZnNldHMgYW5kIGVsZW1lbnQgbWFyZ2lucwogICAgICByZXR1cm4gewogICAgICAgIHdpZHRoOiBlbGVtZW50Lm9mZnNldFdpZHRoLAogICAgICAgIGhlaWdodDogZWxlbWVudC5vZmZzZXRIZWlnaHQsCiAgICAgICAgdG9wOiBvZmZzZXQudG9wIC0gb2Zmc2V0UGFyZW50UmVjdC50b3AgLSBmbi5jc3MoZWxlbWVudCwgJ21hcmdpblRvcCcsIHRydWUpLAogICAgICAgIGxlZnQ6IG9mZnNldC5sZWZ0IC0gb2Zmc2V0UGFyZW50UmVjdC5sZWZ0IC0gZm4uY3NzKGVsZW1lbnQsICdtYXJnaW5MZWZ0JywgdHJ1ZSkKICAgICAgfTsKCiAgICB9OwoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgY2xvc2VzdCwgbm9uLXN0YXRpY2FsbHkgcG9zaXRpb25lZCBvZmZzZXRQYXJlbnQgb2YgYSBnaXZlbiBlbGVtZW50CiAgICAgKiBAcmVxdWlyZWQtYnkgZm4ucG9zaXRpb24KICAgICAqIEBwYXJhbSBlbGVtZW50CiAgICAgKi8KICAgIHZhciBvZmZzZXRQYXJlbnQgPSBmdW5jdGlvbiBvZmZzZXRQYXJlbnRFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgdmFyIGRvY0VsZW1lbnQgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQ7CiAgICAgIHZhciBvZmZzZXRQYXJlbnQgPSBlbGVtZW50Lm9mZnNldFBhcmVudCB8fCBkb2NFbGVtZW50OwogICAgICBpZihub2RlTmFtZShvZmZzZXRQYXJlbnQsICcjZG9jdW1lbnQnKSkgcmV0dXJuIGRvY0VsZW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgICB3aGlsZShvZmZzZXRQYXJlbnQgJiYgIW5vZGVOYW1lKG9mZnNldFBhcmVudCwgJ2h0bWwnKSAmJiBmbi5jc3Mob2Zmc2V0UGFyZW50LCAncG9zaXRpb24nKSA9PT0gJ3N0YXRpYycpIHsKICAgICAgICBvZmZzZXRQYXJlbnQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICB9CiAgICAgIHJldHVybiBvZmZzZXRQYXJlbnQgfHwgZG9jRWxlbWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICB9OwoKICAgIC8qKgogICAgICogUHJvdmlkZXMgZXF1aXZhbGVudCBvZiBqUXVlcnkncyBoZWlnaHQgZnVuY3Rpb24KICAgICAqIEByZXF1aXJlZC1ieSBib290c3RyYXAtYWZmaXgKICAgICAqIEB1cmwgaHR0cDovL2FwaS5qcXVlcnkuY29tL2hlaWdodC8KICAgICAqIEBwYXJhbSBlbGVtZW50CiAgICAgKiBAcGFyYW0gb3V0ZXIKICAgICAqLwogICAgZm4uaGVpZ2h0ID0gZnVuY3Rpb24oZWxlbWVudCwgb3V0ZXIpIHsKICAgICAgdmFyIHZhbHVlID0gZWxlbWVudC5vZmZzZXRIZWlnaHQ7CiAgICAgIGlmKG91dGVyKSB7CiAgICAgICAgdmFsdWUgKz0gZm4uY3NzKGVsZW1lbnQsICdtYXJnaW5Ub3AnLCB0cnVlKSArIGZuLmNzcyhlbGVtZW50LCAnbWFyZ2luQm90dG9tJywgdHJ1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgLT0gZm4uY3NzKGVsZW1lbnQsICdwYWRkaW5nVG9wJywgdHJ1ZSkgKyBmbi5jc3MoZWxlbWVudCwgJ3BhZGRpbmdCb3R0b20nLCB0cnVlKSArIGZuLmNzcyhlbGVtZW50LCAnYm9yZGVyVG9wV2lkdGgnLCB0cnVlKSArIGZuLmNzcyhlbGVtZW50LCAnYm9yZGVyQm90dG9tV2lkdGgnLCB0cnVlKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwoKICAgIC8qKgogICAgICogUHJvdmlkZXMgZXF1aXZhbGVudCBvZiBqUXVlcnkncyB3aWR0aCBmdW5jdGlvbgogICAgICogQHJlcXVpcmVkLWJ5IGJvb3RzdHJhcC1hZmZpeAogICAgICogQHVybCBodHRwOi8vYXBpLmpxdWVyeS5jb20vd2lkdGgvCiAgICAgKiBAcGFyYW0gZWxlbWVudAogICAgICogQHBhcmFtIG91dGVyCiAgICAgKi8KICAgIGZuLndpZHRoID0gZnVuY3Rpb24oZWxlbWVudCwgb3V0ZXIpIHsKICAgICAgdmFyIHZhbHVlID0gZWxlbWVudC5vZmZzZXRXaWR0aDsKICAgICAgaWYob3V0ZXIpIHsKICAgICAgICB2YWx1ZSArPSBmbi5jc3MoZWxlbWVudCwgJ21hcmdpbkxlZnQnLCB0cnVlKSArIGZuLmNzcyhlbGVtZW50LCAnbWFyZ2luUmlnaHQnLCB0cnVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWx1ZSAtPSBmbi5jc3MoZWxlbWVudCwgJ3BhZGRpbmdMZWZ0JywgdHJ1ZSkgKyBmbi5jc3MoZWxlbWVudCwgJ3BhZGRpbmdSaWdodCcsIHRydWUpICsgZm4uY3NzKGVsZW1lbnQsICdib3JkZXJMZWZ0V2lkdGgnLCB0cnVlKSArIGZuLmNzcyhlbGVtZW50LCAnYm9yZGVyUmlnaHRXaWR0aCcsIHRydWUpOwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH07CgogICAgcmV0dXJuIGZuOwoKICB9XSk7CgovLyBTb3VyY2U6IHBhcnNlLW9wdGlvbnMuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLmhlbHBlcnMucGFyc2VPcHRpb25zJywgW10pCgogIC5wcm92aWRlcignJHBhcnNlT3B0aW9ucycsIGZ1bmN0aW9uKCkgewoKICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgIHJlZ2V4cDogL15ccyooLio/KSg/OlxzK2FzXHMrKC4qPykpPyg/OlxzK2dyb3VwXHMrYnlccysoLiopKT9ccytmb3JccysoPzooW1wkXHddW1wkXHddKil8KD86XChccyooW1wkXHddW1wkXHddKilccyosXHMqKFtcJFx3XVtcJFx3XSopXHMqXCkpKVxzK2luXHMrKC4qPykoPzpccyt0cmFja1xzK2J5XHMrKC4qPykpPyQvCiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsiJHBhcnNlIiwgIiRxIiwgZnVuY3Rpb24oJHBhcnNlLCAkcSkgewoKICAgICAgZnVuY3Rpb24gUGFyc2VPcHRpb25zRmFjdG9yeShhdHRyLCBjb25maWcpIHsKCiAgICAgICAgdmFyICRwYXJzZU9wdGlvbnMgPSB7fTsKCiAgICAgICAgLy8gQ29tbW9uIHZhcnMKICAgICAgICB2YXIgb3B0aW9ucyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBkZWZhdWx0cywgY29uZmlnKTsKICAgICAgICAkcGFyc2VPcHRpb25zLiR2YWx1ZXMgPSBbXTsKCiAgICAgICAgLy8gUHJpdmF0ZSB2YXJzCiAgICAgICAgdmFyIG1hdGNoLCBkaXNwbGF5Rm4sIHZhbHVlTmFtZSwga2V5TmFtZSwgZ3JvdXBCeUZuLCB2YWx1ZUZuLCB2YWx1ZXNGbjsKCiAgICAgICAgJHBhcnNlT3B0aW9ucy5pbml0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAkcGFyc2VPcHRpb25zLiRtYXRjaCA9IG1hdGNoID0gYXR0ci5tYXRjaChvcHRpb25zLnJlZ2V4cCk7CiAgICAgICAgICBkaXNwbGF5Rm4gPSAkcGFyc2UobWF0Y2hbMl0gfHwgbWF0Y2hbMV0pLAogICAgICAgICAgdmFsdWVOYW1lID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNl0sCiAgICAgICAgICBrZXlOYW1lID0gbWF0Y2hbNV0sCiAgICAgICAgICBncm91cEJ5Rm4gPSAkcGFyc2UobWF0Y2hbM10gfHwgJycpLAogICAgICAgICAgdmFsdWVGbiA9ICRwYXJzZShtYXRjaFsyXSA/IG1hdGNoWzFdIDogdmFsdWVOYW1lKSwKICAgICAgICAgIHZhbHVlc0ZuID0gJHBhcnNlKG1hdGNoWzddKTsKICAgICAgICB9OwoKICAgICAgICAkcGFyc2VPcHRpb25zLnZhbHVlc0ZuID0gZnVuY3Rpb24oc2NvcGUsIGNvbnRyb2xsZXIpIHsKICAgICAgICAgIHJldHVybiAkcS53aGVuKHZhbHVlc0ZuKHNjb3BlLCBjb250cm9sbGVyKSkKICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHZhbHVlcykgewogICAgICAgICAgICAkcGFyc2VPcHRpb25zLiR2YWx1ZXMgPSB2YWx1ZXMgPyBwYXJzZVZhbHVlcyh2YWx1ZXMsIHNjb3BlKSA6IHt9OwogICAgICAgICAgICByZXR1cm4gJHBhcnNlT3B0aW9ucy4kdmFsdWVzOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgJHBhcnNlT3B0aW9ucy5kaXNwbGF5VmFsdWUgPSBmdW5jdGlvbihtb2RlbFZhbHVlKSB7CiAgICAgICAgICB2YXIgc2NvcGUgPSB7fTsKICAgICAgICAgIHNjb3BlW3ZhbHVlTmFtZV0gPSBtb2RlbFZhbHVlOwogICAgICAgICAgcmV0dXJuIGRpc3BsYXlGbihzY29wZSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gUHJpdmF0ZSBmdW5jdGlvbnMKCiAgICAgICAgZnVuY3Rpb24gcGFyc2VWYWx1ZXModmFsdWVzLCBzY29wZSkgewogICAgICAgICAgcmV0dXJuIHZhbHVlcy5tYXAoZnVuY3Rpb24obWF0Y2gsIGluZGV4KSB7CiAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7fSwgbGFiZWwsIHZhbHVlOwogICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IG1hdGNoOwogICAgICAgICAgICBsYWJlbCA9IGRpc3BsYXlGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICByZXR1cm4ge2xhYmVsOiBsYWJlbCwgdmFsdWU6IHZhbHVlLCBpbmRleDogaW5kZXh9OwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAkcGFyc2VPcHRpb25zLmluaXQoKTsKICAgICAgICByZXR1cm4gJHBhcnNlT3B0aW9uczsKCiAgICAgIH0KCiAgICAgIHJldHVybiBQYXJzZU9wdGlvbnNGYWN0b3J5OwoKICAgIH1dOwoKICB9KTsKCi8vIFNvdXJjZTogcmFmLmpzCihhbmd1bGFyLnZlcnNpb24ubWlub3IgPCAzICYmIGFuZ3VsYXIudmVyc2lvbi5kb3QgPCAxNCkgJiYgYW5ndWxhci5tb2R1bGUoJ25nJykKCi5mYWN0b3J5KCckJHJBRicsIFsiJHdpbmRvdyIsICIkdGltZW91dCIsIGZ1bmN0aW9uKCR3aW5kb3csICR0aW1lb3V0KSB7CgogIHZhciByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSAkd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZTsKCiAgdmFyIGNhbmNlbEFuaW1hdGlvbkZyYW1lID0gJHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3aW5kb3cud2Via2l0Q2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2luZG93Lm1vekNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHdpbmRvdy53ZWJraXRDYW5jZWxSZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CgogIHZhciByYWZTdXBwb3J0ZWQgPSAhIXJlcXVlc3RBbmltYXRpb25GcmFtZTsKICB2YXIgcmFmID0gcmFmU3VwcG9ydGVkID8KICAgIGZ1bmN0aW9uKGZuKSB7CiAgICAgIHZhciBpZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShmbik7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShpZCk7CiAgICAgIH07CiAgICB9IDoKICAgIGZ1bmN0aW9uKGZuKSB7CiAgICAgIHZhciB0aW1lciA9ICR0aW1lb3V0KGZuLCAxNi42NiwgZmFsc2UpOyAvLyAxMDAwIC8gNjAgPSAxNi42NjYKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICR0aW1lb3V0LmNhbmNlbCh0aW1lcik7CiAgICAgIH07CiAgICB9OwoKICByYWYuc3VwcG9ydGVkID0gcmFmU3VwcG9ydGVkOwoKICByZXR1cm4gcmFmOwoKfV0pOwoKLy8gLmZhY3RvcnkoJyQkYW5pbWF0ZVJlZmxvdycsIGZ1bmN0aW9uKCQkckFGLCAkZG9jdW1lbnQpIHsKCi8vICAgdmFyIGJvZHlFbCA9ICRkb2N1bWVudFswXS5ib2R5OwoKLy8gICByZXR1cm4gZnVuY3Rpb24oZm4pIHsKLy8gICAgIC8vdGhlIHJldHVybmVkIGZ1bmN0aW9uIGFjdHMgYXMgdGhlIGNhbmNlbGxhdGlvbiBmdW5jdGlvbgovLyAgICAgcmV0dXJuICQkckFGKGZ1bmN0aW9uKCkgewovLyAgICAgICAvL3RoZSBsaW5lIGJlbG93IHdpbGwgZm9yY2UgdGhlIGJyb3dzZXIgdG8gcGVyZm9ybSBhIHJlcGFpbnQKLy8gICAgICAgLy9zbyB0aGF0IGFsbCB0aGUgYW5pbWF0ZWQgZWxlbWVudHMgd2l0aGluIHRoZSBhbmltYXRpb24gZnJhbWUKLy8gICAgICAgLy93aWxsIGJlIHByb3Blcmx5IHVwZGF0ZWQgYW5kIGRyYXduIG9uIHNjcmVlbi4gVGhpcyBpcwovLyAgICAgICAvL3JlcXVpcmVkIHRvIHBlcmZvcm0gbXVsdGktY2xhc3MgQ1NTIGJhc2VkIGFuaW1hdGlvbnMgd2l0aAovLyAgICAgICAvL0ZpcmVmb3guIERPIE5PVCBSRU1PVkUgVEhJUyBMSU5FLgovLyAgICAgICB2YXIgYSA9IGJvZHlFbC5vZmZzZXRXaWR0aCArIDE7Ci8vICAgICAgIGZuKCk7Ci8vICAgICB9KTsKLy8gICB9OwoKLy8gfSk7CgovLyBTb3VyY2U6IGRyb3Bkb3duLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5kcm9wZG93bicsIFsnbWdjcmVhLm5nU3RyYXAudG9vbHRpcCddKQoKICAucHJvdmlkZXIoJyRkcm9wZG93bicsIGZ1bmN0aW9uKCkgewoKICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgIGFuaW1hdGlvbjogJ2FtLWZhZGUnLAogICAgICBwcmVmaXhDbGFzczogJ2Ryb3Bkb3duJywKICAgICAgcGxhY2VtZW50OiAnYm90dG9tLWxlZnQnLAogICAgICB0ZW1wbGF0ZTogJ2Ryb3Bkb3duL2Ryb3Bkb3duLnRwbC5odG1sJywKICAgICAgdHJpZ2dlcjogJ2NsaWNrJywKICAgICAgY29udGFpbmVyOiBmYWxzZSwKICAgICAga2V5Ym9hcmQ6IHRydWUsCiAgICAgIGh0bWw6IGZhbHNlLAogICAgICBkZWxheTogMAogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBbIiR3aW5kb3ciLCAiJHJvb3RTY29wZSIsICIkdG9vbHRpcCIsIGZ1bmN0aW9uKCR3aW5kb3csICRyb290U2NvcGUsICR0b29sdGlwKSB7CgogICAgICB2YXIgYm9keUVsID0gYW5ndWxhci5lbGVtZW50KCR3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgIHZhciBtYXRjaGVzU2VsZWN0b3IgPSBFbGVtZW50LnByb3RvdHlwZS5tYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudC5wcm90b3R5cGUud2Via2l0TWF0Y2hlc1NlbGVjdG9yIHx8IEVsZW1lbnQucHJvdG90eXBlLm1vek1hdGNoZXNTZWxlY3RvciB8fCBFbGVtZW50LnByb3RvdHlwZS5tc01hdGNoZXNTZWxlY3RvciB8fCBFbGVtZW50LnByb3RvdHlwZS5vTWF0Y2hlc1NlbGVjdG9yOwoKICAgICAgZnVuY3Rpb24gRHJvcGRvd25GYWN0b3J5KGVsZW1lbnQsIGNvbmZpZykgewoKICAgICAgICB2YXIgJGRyb3Bkb3duID0ge307CgogICAgICAgIC8vIENvbW1vbiB2YXJzCiAgICAgICAgdmFyIG9wdGlvbnMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgZGVmYXVsdHMsIGNvbmZpZyk7CiAgICAgICAgdmFyIHNjb3BlID0gJGRyb3Bkb3duLiRzY29wZSA9IG9wdGlvbnMuc2NvcGUgJiYgb3B0aW9ucy5zY29wZS4kbmV3KCkgfHwgJHJvb3RTY29wZS4kbmV3KCk7CgogICAgICAgICRkcm9wZG93biA9ICR0b29sdGlwKGVsZW1lbnQsIG9wdGlvbnMpOwogICAgICAgIHZhciBwYXJlbnRFbCA9IGVsZW1lbnQucGFyZW50KCk7CgogICAgICAgIC8vIFByb3RlY3RlZCBtZXRob2RzCgogICAgICAgICRkcm9wZG93bi4kb25LZXlEb3duID0gZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICBpZiAoIS8oMzh8NDApLy50ZXN0KGV2dC5rZXlDb2RlKSkgcmV0dXJuOwogICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CgogICAgICAgICAgLy8gUmV0cmlldmUgZm9jdXNlZCBpbmRleAogICAgICAgICAgdmFyIGl0ZW1zID0gYW5ndWxhci5lbGVtZW50KCRkcm9wZG93bi4kZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yQWxsKCdsaTpub3QoLmRpdmlkZXIpIGEnKSk7CiAgICAgICAgICBpZighaXRlbXMubGVuZ3RoKSByZXR1cm47CiAgICAgICAgICB2YXIgaW5kZXg7CiAgICAgICAgICBhbmd1bGFyLmZvckVhY2goaXRlbXMsIGZ1bmN0aW9uKGVsLCBpKSB7CiAgICAgICAgICAgIGlmKG1hdGNoZXNTZWxlY3RvciAmJiBtYXRjaGVzU2VsZWN0b3IuY2FsbChlbCwgJzpmb2N1cycpKSBpbmRleCA9IGk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICAvLyBOYXZpZ2F0ZSB3aXRoIGtleWJvYXJkCiAgICAgICAgICBpZihldnQua2V5Q29kZSA9PT0gMzggJiYgaW5kZXggPiAwKSBpbmRleC0tOwogICAgICAgICAgZWxzZSBpZihldnQua2V5Q29kZSA9PT0gNDAgJiYgaW5kZXggPCBpdGVtcy5sZW5ndGggLSAxKSBpbmRleCsrOwogICAgICAgICAgZWxzZSBpZihhbmd1bGFyLmlzVW5kZWZpbmVkKGluZGV4KSkgaW5kZXggPSAwOwogICAgICAgICAgaXRlbXMuZXEoaW5kZXgpWzBdLmZvY3VzKCk7CgogICAgICAgIH07CgogICAgICAgIC8vIE92ZXJyaWRlcwoKICAgICAgICB2YXIgc2hvdyA9ICRkcm9wZG93bi5zaG93OwogICAgICAgICRkcm9wZG93bi5zaG93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBzaG93KCk7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBvcHRpb25zLmtleWJvYXJkICYmICRkcm9wZG93bi4kZWxlbWVudC5vbigna2V5ZG93bicsICRkcm9wZG93bi4kb25LZXlEb3duKTsKICAgICAgICAgICAgYm9keUVsLm9uKCdjbGljaycsIG9uQm9keUNsaWNrKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcGFyZW50RWwuaGFzQ2xhc3MoJ2Ryb3Bkb3duJykgJiYgcGFyZW50RWwuYWRkQ2xhc3MoJ29wZW4nKTsKICAgICAgICB9OwoKICAgICAgICB2YXIgaGlkZSA9ICRkcm9wZG93bi5oaWRlOwogICAgICAgICRkcm9wZG93bi5oaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZighJGRyb3Bkb3duLiRpc1Nob3duKSByZXR1cm47CiAgICAgICAgICBvcHRpb25zLmtleWJvYXJkICYmICRkcm9wZG93bi4kZWxlbWVudC5vZmYoJ2tleWRvd24nLCAkZHJvcGRvd24uJG9uS2V5RG93bik7CiAgICAgICAgICBib2R5RWwub2ZmKCdjbGljaycsIG9uQm9keUNsaWNrKTsKICAgICAgICAgIHBhcmVudEVsLmhhc0NsYXNzKCdkcm9wZG93bicpICYmIHBhcmVudEVsLnJlbW92ZUNsYXNzKCdvcGVuJyk7CiAgICAgICAgICBoaWRlKCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gUHJpdmF0ZSBmdW5jdGlvbnMKCiAgICAgICAgZnVuY3Rpb24gb25Cb2R5Q2xpY2soZXZ0KSB7CiAgICAgICAgICBpZihldnQudGFyZ2V0ID09PSBlbGVtZW50WzBdKSByZXR1cm47CiAgICAgICAgICByZXR1cm4gZXZ0LnRhcmdldCAhPT0gZWxlbWVudFswXSAmJiAkZHJvcGRvd24uaGlkZSgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRkcm9wZG93bjsKCiAgICAgIH0KCiAgICAgIHJldHVybiBEcm9wZG93bkZhY3Rvcnk7CgogICAgfV07CgogIH0pCgogIC5kaXJlY3RpdmUoJ2JzRHJvcGRvd24nLCBbIiR3aW5kb3ciLCAiJHNjZSIsICIkZHJvcGRvd24iLCBmdW5jdGlvbigkd2luZG93LCAkc2NlLCAkZHJvcGRvd24pIHsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0VBQycsCiAgICAgIHNjb3BlOiB0cnVlLAogICAgICBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgZWxlbWVudCwgYXR0ciwgdHJhbnNjbHVzaW9uKSB7CgogICAgICAgIC8vIERpcmVjdGl2ZSBvcHRpb25zCiAgICAgICAgdmFyIG9wdGlvbnMgPSB7c2NvcGU6IHNjb3BlfTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goWydwbGFjZW1lbnQnLCAnY29udGFpbmVyJywgJ2RlbGF5JywgJ3RyaWdnZXInLCAna2V5Ym9hcmQnLCAnaHRtbCcsICdhbmltYXRpb24nLCAndGVtcGxhdGUnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzRGVmaW5lZChhdHRyW2tleV0pKSBvcHRpb25zW2tleV0gPSBhdHRyW2tleV07CiAgICAgICAgfSk7CgogICAgICAgIC8vIFN1cHBvcnQgc2NvcGUgYXMgYW4gb2JqZWN0CiAgICAgICAgYXR0ci5ic0Ryb3Bkb3duICYmIHNjb3BlLiR3YXRjaChhdHRyLmJzRHJvcGRvd24sIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgc2NvcGUuY29udGVudCA9IG5ld1ZhbHVlOwogICAgICAgIH0sIHRydWUpOwoKICAgICAgICAvLyBWaXNpYmlsaXR5IGJpbmRpbmcgc3VwcG9ydAogICAgICAgIGF0dHIuYnNTaG93ICYmIHNjb3BlLiR3YXRjaChhdHRyLmJzU2hvdywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICBpZighZHJvcGRvd24gfHwgIWFuZ3VsYXIuaXNEZWZpbmVkKG5ld1ZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgaWYoYW5ndWxhci5pc1N0cmluZyhuZXdWYWx1ZSkpIG5ld1ZhbHVlID0gISFuZXdWYWx1ZS5tYXRjaCgvdHJ1ZXwsPyhkcm9wZG93biksPy9pKTsKICAgICAgICAgIG5ld1ZhbHVlID09PSB0cnVlID8gZHJvcGRvd24uc2hvdygpIDogZHJvcGRvd24uaGlkZSgpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBJbml0aWFsaXplIGRyb3Bkb3duCiAgICAgICAgdmFyIGRyb3Bkb3duID0gJGRyb3Bkb3duKGVsZW1lbnQsIG9wdGlvbnMpOwoKICAgICAgICAvLyBHYXJiYWdlIGNvbGxlY3Rpb24KICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoZHJvcGRvd24pIGRyb3Bkb3duLmRlc3Ryb3koKTsKICAgICAgICAgIG9wdGlvbnMgPSBudWxsOwogICAgICAgICAgZHJvcGRvd24gPSBudWxsOwogICAgICAgIH0pOwoKICAgICAgfQogICAgfTsKCiAgfV0pOwoKLy8gU291cmNlOiBtb2RhbC5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAubW9kYWwnLCBbJ21nY3JlYS5uZ1N0cmFwLmhlbHBlcnMuZGltZW5zaW9ucyddKQoKICAucHJvdmlkZXIoJyRtb2RhbCcsIGZ1bmN0aW9uKCkgewoKICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgIGFuaW1hdGlvbjogJ2FtLWZhZGUnLAogICAgICBiYWNrZHJvcEFuaW1hdGlvbjogJ2FtLWZhZGUnLAogICAgICBwcmVmaXhDbGFzczogJ21vZGFsJywKICAgICAgcHJlZml4RXZlbnQ6ICdtb2RhbCcsCiAgICAgIHBsYWNlbWVudDogJ3RvcCcsCiAgICAgIHRlbXBsYXRlOiAnbW9kYWwvbW9kYWwudHBsLmh0bWwnLAogICAgICBjb250ZW50VGVtcGxhdGU6IGZhbHNlLAogICAgICBjb250YWluZXI6IGZhbHNlLAogICAgICBlbGVtZW50OiBudWxsLAogICAgICBiYWNrZHJvcDogdHJ1ZSwKICAgICAga2V5Ym9hcmQ6IHRydWUsCiAgICAgIGh0bWw6IGZhbHNlLAogICAgICBzaG93OiB0cnVlCiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsiJHdpbmRvdyIsICIkcm9vdFNjb3BlIiwgIiRjb21waWxlIiwgIiRxIiwgIiR0ZW1wbGF0ZUNhY2hlIiwgIiRodHRwIiwgIiRhbmltYXRlIiwgIiR0aW1lb3V0IiwgIiRzY2UiLCAiZGltZW5zaW9ucyIsIGZ1bmN0aW9uKCR3aW5kb3csICRyb290U2NvcGUsICRjb21waWxlLCAkcSwgJHRlbXBsYXRlQ2FjaGUsICRodHRwLCAkYW5pbWF0ZSwgJHRpbWVvdXQsICRzY2UsIGRpbWVuc2lvbnMpIHsKCiAgICAgIHZhciBmb3JFYWNoID0gYW5ndWxhci5mb3JFYWNoOwogICAgICB2YXIgdHJpbSA9IFN0cmluZy5wcm90b3R5cGUudHJpbTsKICAgICAgdmFyIHJlcXVlc3RBbmltYXRpb25GcmFtZSA9ICR3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8ICR3aW5kb3cuc2V0VGltZW91dDsKICAgICAgdmFyIGJvZHlFbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KCR3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgIHZhciBodG1sUmVwbGFjZVJlZ0V4cCA9IC9uZy1iaW5kPSIvaWc7CgogICAgICBmdW5jdGlvbiBNb2RhbEZhY3RvcnkoY29uZmlnKSB7CgogICAgICAgIHZhciAkbW9kYWwgPSB7fTsKCiAgICAgICAgLy8gQ29tbW9uIHZhcnMKICAgICAgICB2YXIgb3B0aW9ucyA9ICRtb2RhbC4kb3B0aW9ucyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBkZWZhdWx0cywgY29uZmlnKTsKICAgICAgICAkbW9kYWwuJHByb21pc2UgPSBmZXRjaFRlbXBsYXRlKG9wdGlvbnMudGVtcGxhdGUpOwogICAgICAgIHZhciBzY29wZSA9ICRtb2RhbC4kc2NvcGUgPSBvcHRpb25zLnNjb3BlICYmIG9wdGlvbnMuc2NvcGUuJG5ldygpIHx8ICRyb290U2NvcGUuJG5ldygpOwogICAgICAgIGlmKCFvcHRpb25zLmVsZW1lbnQgJiYgIW9wdGlvbnMuY29udGFpbmVyKSB7CiAgICAgICAgICBvcHRpb25zLmNvbnRhaW5lciA9ICdib2R5JzsKICAgICAgICB9CgogICAgICAgIC8vIFN1cHBvcnQgc2NvcGUgYXMgc3RyaW5nIG9wdGlvbnMKICAgICAgICBmb3JFYWNoKFsndGl0bGUnLCAnY29udGVudCddLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGlmKG9wdGlvbnNba2V5XSkgc2NvcGVba2V5XSA9ICRzY2UudHJ1c3RBc0h0bWwob3B0aW9uc1trZXldKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gUHJvdmlkZSBzY29wZSBoZWxwZXJzCiAgICAgICAgc2NvcGUuJGhpZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJG1vZGFsLmhpZGUoKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgc2NvcGUuJHNob3cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJG1vZGFsLnNob3coKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgc2NvcGUuJHRvZ2dsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkbW9kYWwudG9nZ2xlKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICAvLyBTdXBwb3J0IGNvbnRlbnRUZW1wbGF0ZSBvcHRpb24KICAgICAgICBpZihvcHRpb25zLmNvbnRlbnRUZW1wbGF0ZSkgewogICAgICAgICAgJG1vZGFsLiRwcm9taXNlID0gJG1vZGFsLiRwcm9taXNlLnRoZW4oZnVuY3Rpb24odGVtcGxhdGUpIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlRWwgPSBhbmd1bGFyLmVsZW1lbnQodGVtcGxhdGUpOwogICAgICAgICAgICByZXR1cm4gZmV0Y2hUZW1wbGF0ZShvcHRpb25zLmNvbnRlbnRUZW1wbGF0ZSkKICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oY29udGVudFRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgdmFyIGNvbnRlbnRFbCA9IGZpbmRFbGVtZW50KCdbbmctYmluZD0iY29udGVudCJdJywgdGVtcGxhdGVFbFswXSkucmVtb3ZlQXR0cignbmctYmluZCcpLmh0bWwoY29udGVudFRlbXBsYXRlKTsKICAgICAgICAgICAgICAvLyBEcm9wIHRoZSBkZWZhdWx0IGZvb3RlciBhcyB5b3UgcHJvYmFibHkgZG9uJ3Qgd2FudCBpdCBpZiB5b3UgdXNlIGEgY3VzdG9tIGNvbnRlbnRUZW1wbGF0ZQogICAgICAgICAgICAgIGlmKCFjb25maWcudGVtcGxhdGUpIGNvbnRlbnRFbC5uZXh0KCkucmVtb3ZlKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlRWxbMF0ub3V0ZXJIVE1MOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gRmV0Y2gsIGNvbXBpbGUgdGhlbiBpbml0aWFsaXplIG1vZGFsCiAgICAgICAgdmFyIG1vZGFsTGlua2VyLCBtb2RhbEVsZW1lbnQ7CiAgICAgICAgdmFyIGJhY2tkcm9wRWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudCgnPGRpdiBjbGFzcz0iJyArIG9wdGlvbnMucHJlZml4Q2xhc3MgKyAnLWJhY2tkcm9wIi8+Jyk7CiAgICAgICAgJG1vZGFsLiRwcm9taXNlLnRoZW4oZnVuY3Rpb24odGVtcGxhdGUpIHsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNPYmplY3QodGVtcGxhdGUpKSB0ZW1wbGF0ZSA9IHRlbXBsYXRlLmRhdGE7CiAgICAgICAgICBpZihvcHRpb25zLmh0bWwpIHRlbXBsYXRlID0gdGVtcGxhdGUucmVwbGFjZShodG1sUmVwbGFjZVJlZ0V4cCwgJ25nLWJpbmQtaHRtbD0iJyk7CiAgICAgICAgICB0ZW1wbGF0ZSA9IHRyaW0uYXBwbHkodGVtcGxhdGUpOwogICAgICAgICAgbW9kYWxMaW5rZXIgPSAkY29tcGlsZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAkbW9kYWwuaW5pdCgpOwogICAgICAgIH0pOwoKICAgICAgICAkbW9kYWwuaW5pdCA9IGZ1bmN0aW9uKCkgewoKICAgICAgICAgIC8vIE9wdGlvbnM6IHNob3cKICAgICAgICAgIGlmKG9wdGlvbnMuc2hvdykgewogICAgICAgICAgICBzY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgJG1vZGFsLnNob3coKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgIH07CgogICAgICAgICRtb2RhbC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgLy8gUmVtb3ZlIGVsZW1lbnQKICAgICAgICAgIGlmKG1vZGFsRWxlbWVudCkgewogICAgICAgICAgICBtb2RhbEVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgIG1vZGFsRWxlbWVudCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZihiYWNrZHJvcEVsZW1lbnQpIHsKICAgICAgICAgICAgYmFja2Ryb3BFbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICBiYWNrZHJvcEVsZW1lbnQgPSBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIERlc3Ryb3kgc2NvcGUKICAgICAgICAgIHNjb3BlLiRkZXN0cm95KCk7CgogICAgICAgIH07CgogICAgICAgICRtb2RhbC5zaG93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZihzY29wZS4kaXNTaG93bikgcmV0dXJuOwoKICAgICAgICAgIGlmKHNjb3BlLiRlbWl0KG9wdGlvbnMucHJlZml4RXZlbnQgKyAnLnNob3cuYmVmb3JlJywgJG1vZGFsKS5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJlbnQ7CiAgICAgICAgICBpZihhbmd1bGFyLmlzRWxlbWVudChvcHRpb25zLmNvbnRhaW5lcikpIHsKICAgICAgICAgICAgcGFyZW50ID0gb3B0aW9ucy5jb250YWluZXI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYXJlbnQgPSBvcHRpb25zLmNvbnRhaW5lciA/IGZpbmRFbGVtZW50KG9wdGlvbnMuY29udGFpbmVyKSA6IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYWZ0ZXIgPSBvcHRpb25zLmNvbnRhaW5lciA/IG51bGwgOiBvcHRpb25zLmVsZW1lbnQ7CgogICAgICAgICAgLy8gRmV0Y2ggYSBjbG9uZWQgZWxlbWVudCBsaW5rZWQgZnJvbSB0ZW1wbGF0ZQogICAgICAgICAgbW9kYWxFbGVtZW50ID0gJG1vZGFsLiRlbGVtZW50ID0gbW9kYWxMaW5rZXIoc2NvcGUsIGZ1bmN0aW9uKGNsb25lZEVsZW1lbnQsIHNjb3BlKSB7fSk7CgogICAgICAgICAgLy8gU2V0IHRoZSBpbml0aWFsIHBvc2l0aW9uaW5nLgogICAgICAgICAgbW9kYWxFbGVtZW50LmNzcyh7ZGlzcGxheTogJ2Jsb2NrJ30pLmFkZENsYXNzKG9wdGlvbnMucGxhY2VtZW50KTsKCiAgICAgICAgICAvLyBPcHRpb25zOiBhbmltYXRpb24KICAgICAgICAgIGlmKG9wdGlvbnMuYW5pbWF0aW9uKSB7CiAgICAgICAgICAgIGlmKG9wdGlvbnMuYmFja2Ryb3ApIHsKICAgICAgICAgICAgICBiYWNrZHJvcEVsZW1lbnQuYWRkQ2xhc3Mob3B0aW9ucy5iYWNrZHJvcEFuaW1hdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbW9kYWxFbGVtZW50LmFkZENsYXNzKG9wdGlvbnMuYW5pbWF0aW9uKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZihvcHRpb25zLmJhY2tkcm9wKSB7CiAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGJhY2tkcm9wRWxlbWVudCwgYm9keUVsZW1lbnQsIG51bGwpOwogICAgICAgICAgfQogICAgICAgICAgLy8gU3VwcG9ydCB2MS4zKyAkYW5pbWF0ZQogICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9jb21taXQvYmYwZjU1MDJiMWJiZmRkYzVjZGQyZjEzOGVmZDkxODhiOGM2NTJhOQogICAgICAgICAgdmFyIHByb21pc2UgPSAkYW5pbWF0ZS5lbnRlcihtb2RhbEVsZW1lbnQsIHBhcmVudCwgYWZ0ZXIsIGVudGVyQW5pbWF0ZUNhbGxiYWNrKTsKICAgICAgICAgIGlmKHByb21pc2UgJiYgcHJvbWlzZS50aGVuKSBwcm9taXNlLnRoZW4oZW50ZXJBbmltYXRlQ2FsbGJhY2spOwoKICAgICAgICAgIHNjb3BlLiRpc1Nob3duID0gdHJ1ZTsKICAgICAgICAgIHNjb3BlLiQkcGhhc2UgfHwgKHNjb3BlLiRyb290ICYmIHNjb3BlLiRyb290LiQkcGhhc2UpIHx8IHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgIC8vIEZvY3VzIG9uY2UgdGhlIGVudGVyLWFuaW1hdGlvbiBoYXMgc3RhcnRlZAogICAgICAgICAgLy8gV2VpcmQgUGhhbnRvbUpTIGJ1ZyBoYWNrCiAgICAgICAgICB2YXIgZWwgPSBtb2RhbEVsZW1lbnRbMF07CiAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsLmZvY3VzKCk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBib2R5RWxlbWVudC5hZGRDbGFzcyhvcHRpb25zLnByZWZpeENsYXNzICsgJy1vcGVuJyk7CiAgICAgICAgICBpZihvcHRpb25zLmFuaW1hdGlvbikgewogICAgICAgICAgICBib2R5RWxlbWVudC5hZGRDbGFzcyhvcHRpb25zLnByZWZpeENsYXNzICsgJy13aXRoLScgKyBvcHRpb25zLmFuaW1hdGlvbik7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQmluZCBldmVudHMKICAgICAgICAgIGlmKG9wdGlvbnMuYmFja2Ryb3ApIHsKICAgICAgICAgICAgbW9kYWxFbGVtZW50Lm9uKCdjbGljaycsIGhpZGVPbkJhY2tkcm9wQ2xpY2spOwogICAgICAgICAgICBiYWNrZHJvcEVsZW1lbnQub24oJ2NsaWNrJywgaGlkZU9uQmFja2Ryb3BDbGljayk7CiAgICAgICAgICB9CiAgICAgICAgICBpZihvcHRpb25zLmtleWJvYXJkKSB7CiAgICAgICAgICAgIG1vZGFsRWxlbWVudC5vbigna2V5dXAnLCAkbW9kYWwuJG9uS2V5VXApOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIGVudGVyQW5pbWF0ZUNhbGxiYWNrKCkgewogICAgICAgICAgc2NvcGUuJGVtaXQob3B0aW9ucy5wcmVmaXhFdmVudCArICcuc2hvdycsICRtb2RhbCk7CiAgICAgICAgfQoKICAgICAgICAkbW9kYWwuaGlkZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYoIXNjb3BlLiRpc1Nob3duKSByZXR1cm47CgogICAgICAgICAgaWYoc2NvcGUuJGVtaXQob3B0aW9ucy5wcmVmaXhFdmVudCArICcuaGlkZS5iZWZvcmUnLCAkbW9kYWwpLmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb21pc2UgPSAkYW5pbWF0ZS5sZWF2ZShtb2RhbEVsZW1lbnQsIGxlYXZlQW5pbWF0ZUNhbGxiYWNrKTsKICAgICAgICAgIC8vIFN1cHBvcnQgdjEuMysgJGFuaW1hdGUKICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvY29tbWl0L2JmMGY1NTAyYjFiYmZkZGM1Y2RkMmYxMzhlZmQ5MTg4YjhjNjUyYTkKICAgICAgICAgIGlmKHByb21pc2UgJiYgcHJvbWlzZS50aGVuKSBwcm9taXNlLnRoZW4obGVhdmVBbmltYXRlQ2FsbGJhY2spOwoKICAgICAgICAgIGlmKG9wdGlvbnMuYmFja2Ryb3ApIHsKICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoYmFja2Ryb3BFbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHNjb3BlLiRpc1Nob3duID0gZmFsc2U7CiAgICAgICAgICBzY29wZS4kJHBoYXNlIHx8IChzY29wZS4kcm9vdCAmJiBzY29wZS4kcm9vdC4kJHBoYXNlKSB8fCBzY29wZS4kZGlnZXN0KCk7CgogICAgICAgICAgLy8gVW5iaW5kIGV2ZW50cwogICAgICAgICAgaWYob3B0aW9ucy5iYWNrZHJvcCkgewogICAgICAgICAgICBtb2RhbEVsZW1lbnQub2ZmKCdjbGljaycsIGhpZGVPbkJhY2tkcm9wQ2xpY2spOwogICAgICAgICAgICBiYWNrZHJvcEVsZW1lbnQub2ZmKCdjbGljaycsIGhpZGVPbkJhY2tkcm9wQ2xpY2spOwogICAgICAgICAgfQogICAgICAgICAgaWYob3B0aW9ucy5rZXlib2FyZCkgewogICAgICAgICAgICBtb2RhbEVsZW1lbnQub2ZmKCdrZXl1cCcsICRtb2RhbC4kb25LZXlVcCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gbGVhdmVBbmltYXRlQ2FsbGJhY2soKSB7CiAgICAgICAgICBzY29wZS4kZW1pdChvcHRpb25zLnByZWZpeEV2ZW50ICsgJy5oaWRlJywgJG1vZGFsKTsKICAgICAgICAgIGJvZHlFbGVtZW50LnJlbW92ZUNsYXNzKG9wdGlvbnMucHJlZml4Q2xhc3MgKyAnLW9wZW4nKTsKICAgICAgICAgIGlmKG9wdGlvbnMuYW5pbWF0aW9uKSB7CiAgICAgICAgICAgIGJvZHlFbGVtZW50LnJlbW92ZUNsYXNzKG9wdGlvbnMucHJlZml4Q2xhc3MgKyAnLXdpdGgtJyArIG9wdGlvbnMuYW5pbWF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgICRtb2RhbC50b2dnbGUgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICBzY29wZS4kaXNTaG93biA/ICRtb2RhbC5oaWRlKCkgOiAkbW9kYWwuc2hvdygpOwoKICAgICAgICB9OwoKICAgICAgICAkbW9kYWwuZm9jdXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIG1vZGFsRWxlbWVudFswXS5mb2N1cygpOwogICAgICAgIH07CgogICAgICAgIC8vIFByb3RlY3RlZCBtZXRob2RzCgogICAgICAgICRtb2RhbC4kb25LZXlVcCA9IGZ1bmN0aW9uKGV2dCkgewoKICAgICAgICAgIGlmIChldnQud2hpY2ggPT09IDI3ICYmIHNjb3BlLiRpc1Nob3duKSB7CiAgICAgICAgICAgICRtb2RhbC5oaWRlKCk7CiAgICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIH0KCiAgICAgICAgfTsKCiAgICAgICAgLy8gUHJpdmF0ZSBtZXRob2RzCgogICAgICAgIGZ1bmN0aW9uIGhpZGVPbkJhY2tkcm9wQ2xpY2soZXZ0KSB7CiAgICAgICAgICBpZihldnQudGFyZ2V0ICE9PSBldnQuY3VycmVudFRhcmdldCkgcmV0dXJuOwogICAgICAgICAgb3B0aW9ucy5iYWNrZHJvcCA9PT0gJ3N0YXRpYycgPyAkbW9kYWwuZm9jdXMoKSA6ICRtb2RhbC5oaWRlKCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJG1vZGFsOwoKICAgICAgfQoKICAgICAgLy8gSGVscGVyIGZ1bmN0aW9ucwoKICAgICAgZnVuY3Rpb24gZmluZEVsZW1lbnQocXVlcnksIGVsZW1lbnQpIHsKICAgICAgICByZXR1cm4gYW5ndWxhci5lbGVtZW50KChlbGVtZW50IHx8IGRvY3VtZW50KS5xdWVyeVNlbGVjdG9yQWxsKHF1ZXJ5KSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGZldGNoVGVtcGxhdGUodGVtcGxhdGUpIHsKICAgICAgICByZXR1cm4gJHEud2hlbigkdGVtcGxhdGVDYWNoZS5nZXQodGVtcGxhdGUpIHx8ICRodHRwLmdldCh0ZW1wbGF0ZSkpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzT2JqZWN0KHJlcykpIHsKICAgICAgICAgICAgJHRlbXBsYXRlQ2FjaGUucHV0KHRlbXBsYXRlLCByZXMuZGF0YSk7CiAgICAgICAgICAgIHJldHVybiByZXMuZGF0YTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXM7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBNb2RhbEZhY3Rvcnk7CgogICAgfV07CgogIH0pCgogIC5kaXJlY3RpdmUoJ2JzTW9kYWwnLCBbIiR3aW5kb3ciLCAiJHNjZSIsICIkbW9kYWwiLCBmdW5jdGlvbigkd2luZG93LCAkc2NlLCAkbW9kYWwpIHsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0VBQycsCiAgICAgIHNjb3BlOiB0cnVlLAogICAgICBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgZWxlbWVudCwgYXR0ciwgdHJhbnNjbHVzaW9uKSB7CgogICAgICAgIC8vIERpcmVjdGl2ZSBvcHRpb25zCiAgICAgICAgdmFyIG9wdGlvbnMgPSB7c2NvcGU6IHNjb3BlLCBlbGVtZW50OiBlbGVtZW50LCBzaG93OiBmYWxzZX07CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsndGVtcGxhdGUnLCAnY29udGVudFRlbXBsYXRlJywgJ3BsYWNlbWVudCcsICdiYWNrZHJvcCcsICdrZXlib2FyZCcsICdodG1sJywgJ2NvbnRhaW5lcicsICdhbmltYXRpb24nXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzRGVmaW5lZChhdHRyW2tleV0pKSBvcHRpb25zW2tleV0gPSBhdHRyW2tleV07CiAgICAgICAgfSk7CgogICAgICAgIC8vIFN1cHBvcnQgc2NvcGUgYXMgZGF0YS1hdHRycwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ3RpdGxlJywgJ2NvbnRlbnQnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBhdHRyW2tleV0gJiYgYXR0ci4kb2JzZXJ2ZShrZXksIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICBzY29wZVtrZXldID0gJHNjZS50cnVzdEFzSHRtbChuZXdWYWx1ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gU3VwcG9ydCBzY29wZSBhcyBhbiBvYmplY3QKICAgICAgICBhdHRyLmJzTW9kYWwgJiYgc2NvcGUuJHdhdGNoKGF0dHIuYnNNb2RhbCwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzT2JqZWN0KG5ld1ZhbHVlKSkgewogICAgICAgICAgICBhbmd1bGFyLmV4dGVuZChzY29wZSwgbmV3VmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2NvcGUuY29udGVudCA9IG5ld1ZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0sIHRydWUpOwoKICAgICAgICAvLyBJbml0aWFsaXplIG1vZGFsCiAgICAgICAgdmFyIG1vZGFsID0gJG1vZGFsKG9wdGlvbnMpOwoKICAgICAgICAvLyBUcmlnZ2VyCiAgICAgICAgZWxlbWVudC5vbihhdHRyLnRyaWdnZXIgfHwgJ2NsaWNrJywgbW9kYWwudG9nZ2xlKTsKCiAgICAgICAgLy8gR2FyYmFnZSBjb2xsZWN0aW9uCiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKG1vZGFsKSBtb2RhbC5kZXN0cm95KCk7CiAgICAgICAgICBvcHRpb25zID0gbnVsbDsKICAgICAgICAgIG1vZGFsID0gbnVsbDsKICAgICAgICB9KTsKCiAgICAgIH0KICAgIH07CgogIH1dKTsKCi8vIFNvdXJjZTogbmF2YmFyLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5uYXZiYXInLCBbXSkKCiAgLnByb3ZpZGVyKCckbmF2YmFyJywgZnVuY3Rpb24oKSB7CgogICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgYWN0aXZlQ2xhc3M6ICdhY3RpdmUnLAogICAgICByb3V0ZUF0dHI6ICdkYXRhLW1hdGNoLXJvdXRlJywKICAgICAgc3RyaWN0OiBmYWxzZQogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHtkZWZhdWx0czogZGVmYXVsdHN9OwogICAgfTsKCiAgfSkKCiAgLmRpcmVjdGl2ZSgnYnNOYXZiYXInLCBbIiR3aW5kb3ciLCAiJGxvY2F0aW9uIiwgIiRuYXZiYXIiLCBmdW5jdGlvbigkd2luZG93LCAkbG9jYXRpb24sICRuYXZiYXIpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSAkbmF2YmFyLmRlZmF1bHRzOwoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjb250cm9sbGVyKSB7CgogICAgICAgIC8vIERpcmVjdGl2ZSBvcHRpb25zCiAgICAgICAgdmFyIG9wdGlvbnMgPSBhbmd1bGFyLmNvcHkoZGVmYXVsdHMpOwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChPYmplY3Qua2V5cyhkZWZhdWx0cyksIGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgaWYoYW5ndWxhci5pc0RlZmluZWQoYXR0cltrZXldKSkgb3B0aW9uc1trZXldID0gYXR0cltrZXldOwogICAgICAgIH0pOwoKICAgICAgICAvLyBXYXRjaCBmb3IgdGhlICRsb2NhdGlvbgogICAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsKCiAgICAgICAgICByZXR1cm4gJGxvY2F0aW9uLnBhdGgoKTsKCiAgICAgICAgfSwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CgogICAgICAgICAgdmFyIGxpRWxlbWVudHMgPSBlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3JBbGwoJ2xpWycgKyBvcHRpb25zLnJvdXRlQXR0ciArICddJyk7CgogICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGxpRWxlbWVudHMsIGZ1bmN0aW9uKGxpKSB7CgogICAgICAgICAgICB2YXIgbGlFbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KGxpKTsKICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSBsaUVsZW1lbnQuYXR0cihvcHRpb25zLnJvdXRlQXR0cikucmVwbGFjZSgnLycsICdcXC8nKTsKICAgICAgICAgICAgaWYob3B0aW9ucy5zdHJpY3QpIHsKICAgICAgICAgICAgICBwYXR0ZXJuID0gJ14nICsgcGF0dGVybiArICckJzsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVnZXhwID0gbmV3IFJlZ0V4cChwYXR0ZXJuLCBbJ2knXSk7CgogICAgICAgICAgICBpZihyZWdleHAudGVzdChuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICBsaUVsZW1lbnQuYWRkQ2xhc3Mob3B0aW9ucy5hY3RpdmVDbGFzcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGlFbGVtZW50LnJlbW92ZUNsYXNzKG9wdGlvbnMuYWN0aXZlQ2xhc3MpOwogICAgICAgICAgICB9CgogICAgICAgICAgfSk7CgogICAgICAgIH0pOwoKICAgICAgfQoKICAgIH07CgogIH1dKTsKCi8vIFNvdXJjZTogcG9wb3Zlci5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAucG9wb3ZlcicsIFsnbWdjcmVhLm5nU3RyYXAudG9vbHRpcCddKQoKICAucHJvdmlkZXIoJyRwb3BvdmVyJywgZnVuY3Rpb24oKSB7CgogICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgYW5pbWF0aW9uOiAnYW0tZmFkZScsCiAgICAgIGN1c3RvbUNsYXNzOiAnJywKICAgICAgY29udGFpbmVyOiBmYWxzZSwKICAgICAgdGFyZ2V0OiBmYWxzZSwKICAgICAgcGxhY2VtZW50OiAncmlnaHQnLAogICAgICB0ZW1wbGF0ZTogJ3BvcG92ZXIvcG9wb3Zlci50cGwuaHRtbCcsCiAgICAgIGNvbnRlbnRUZW1wbGF0ZTogZmFsc2UsCiAgICAgIHRyaWdnZXI6ICdjbGljaycsCiAgICAgIGtleWJvYXJkOiB0cnVlLAogICAgICBodG1sOiBmYWxzZSwKICAgICAgdGl0bGU6ICcnLAogICAgICBjb250ZW50OiAnJywKICAgICAgZGVsYXk6IDAKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gWyIkdG9vbHRpcCIsIGZ1bmN0aW9uKCR0b29sdGlwKSB7CgogICAgICBmdW5jdGlvbiBQb3BvdmVyRmFjdG9yeShlbGVtZW50LCBjb25maWcpIHsKCiAgICAgICAgLy8gQ29tbW9uIHZhcnMKICAgICAgICB2YXIgb3B0aW9ucyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBkZWZhdWx0cywgY29uZmlnKTsKCiAgICAgICAgdmFyICRwb3BvdmVyID0gJHRvb2x0aXAoZWxlbWVudCwgb3B0aW9ucyk7CgogICAgICAgIC8vIFN1cHBvcnQgc2NvcGUgYXMgc3RyaW5nIG9wdGlvbnMgWy8qdGl0bGUsICovY29udGVudF0KICAgICAgICBpZihvcHRpb25zLmNvbnRlbnQpIHsKICAgICAgICAgICRwb3BvdmVyLiRzY29wZS5jb250ZW50ID0gb3B0aW9ucy5jb250ZW50OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRwb3BvdmVyOwoKICAgICAgfQoKICAgICAgcmV0dXJuIFBvcG92ZXJGYWN0b3J5OwoKICAgIH1dOwoKICB9KQoKICAuZGlyZWN0aXZlKCdic1BvcG92ZXInLCBbIiR3aW5kb3ciLCAiJHNjZSIsICIkcG9wb3ZlciIsIGZ1bmN0aW9uKCR3aW5kb3csICRzY2UsICRwb3BvdmVyKSB7CgogICAgdmFyIHJlcXVlc3RBbmltYXRpb25GcmFtZSA9ICR3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8ICR3aW5kb3cuc2V0VGltZW91dDsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0VBQycsCiAgICAgIHNjb3BlOiB0cnVlLAogICAgICBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgZWxlbWVudCwgYXR0cikgewoKICAgICAgICAvLyBEaXJlY3RpdmUgb3B0aW9ucwogICAgICAgIHZhciBvcHRpb25zID0ge3Njb3BlOiBzY29wZX07CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsndGVtcGxhdGUnLCAnY29udGVudFRlbXBsYXRlJywgJ3BsYWNlbWVudCcsICdjb250YWluZXInLCAndGFyZ2V0JywgJ2RlbGF5JywgJ3RyaWdnZXInLCAna2V5Ym9hcmQnLCAnaHRtbCcsICdhbmltYXRpb24nLCAnY3VzdG9tQ2xhc3MnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzRGVmaW5lZChhdHRyW2tleV0pKSBvcHRpb25zW2tleV0gPSBhdHRyW2tleV07CiAgICAgICAgfSk7CgogICAgICAgIC8vIFN1cHBvcnQgc2NvcGUgYXMgZGF0YS1hdHRycwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ3RpdGxlJywgJ2NvbnRlbnQnXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBhdHRyW2tleV0gJiYgYXR0ci4kb2JzZXJ2ZShrZXksIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICBzY29wZVtrZXldID0gJHNjZS50cnVzdEFzSHRtbChuZXdWYWx1ZSk7CiAgICAgICAgICAgIGFuZ3VsYXIuaXNEZWZpbmVkKG9sZFZhbHVlKSAmJiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcG9wb3ZlciAmJiBwb3BvdmVyLiRhcHBseVBsYWNlbWVudCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyBTdXBwb3J0IHNjb3BlIGFzIGFuIG9iamVjdAogICAgICAgIGF0dHIuYnNQb3BvdmVyICYmIHNjb3BlLiR3YXRjaChhdHRyLmJzUG9wb3ZlciwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzT2JqZWN0KG5ld1ZhbHVlKSkgewogICAgICAgICAgICBhbmd1bGFyLmV4dGVuZChzY29wZSwgbmV3VmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2NvcGUuY29udGVudCA9IG5ld1ZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgYW5ndWxhci5pc0RlZmluZWQob2xkVmFsdWUpICYmIHJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgcG9wb3ZlciAmJiBwb3BvdmVyLiRhcHBseVBsYWNlbWVudCgpOwogICAgICAgICAgfSk7CiAgICAgICAgfSwgdHJ1ZSk7CgogICAgICAgIC8vIFZpc2liaWxpdHkgYmluZGluZyBzdXBwb3J0CiAgICAgICAgYXR0ci5ic1Nob3cgJiYgc2NvcGUuJHdhdGNoKGF0dHIuYnNTaG93LCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgIGlmKCFwb3BvdmVyIHx8ICFhbmd1bGFyLmlzRGVmaW5lZChuZXdWYWx1ZSkpIHJldHVybjsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNTdHJpbmcobmV3VmFsdWUpKSBuZXdWYWx1ZSA9ICEhbmV3VmFsdWUubWF0Y2goL3RydWV8LD8ocG9wb3ZlciksPy9pKTsKICAgICAgICAgIG5ld1ZhbHVlID09PSB0cnVlID8gcG9wb3Zlci5zaG93KCkgOiBwb3BvdmVyLmhpZGUoKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSBwb3BvdmVyCiAgICAgICAgdmFyIHBvcG92ZXIgPSAkcG9wb3ZlcihlbGVtZW50LCBvcHRpb25zKTsKCiAgICAgICAgLy8gR2FyYmFnZSBjb2xsZWN0aW9uCiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHBvcG92ZXIpIHBvcG92ZXIuZGVzdHJveSgpOwogICAgICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICAgICAgICBwb3BvdmVyID0gbnVsbDsKICAgICAgICB9KTsKCiAgICAgIH0KICAgIH07CgogIH1dKTsKCi8vIFNvdXJjZTogc2Nyb2xsc3B5LmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5zY3JvbGxzcHknLCBbJ21nY3JlYS5uZ1N0cmFwLmhlbHBlcnMuZGVib3VuY2UnLCAnbWdjcmVhLm5nU3RyYXAuaGVscGVycy5kaW1lbnNpb25zJ10pCgogIC5wcm92aWRlcignJHNjcm9sbHNweScsIGZ1bmN0aW9uKCkgewoKICAgIC8vIFBvb2wgb2YgcmVnaXN0ZXJlZCBzcGllcwogICAgdmFyIHNwaWVzID0gdGhpcy4kJHNwaWVzID0ge307CgogICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgZGVib3VuY2U6IDE1MCwKICAgICAgdGhyb3R0bGU6IDEwMCwKICAgICAgb2Zmc2V0OiAxMDAKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gWyIkd2luZG93IiwgIiRkb2N1bWVudCIsICIkcm9vdFNjb3BlIiwgImRpbWVuc2lvbnMiLCAiZGVib3VuY2UiLCAidGhyb3R0bGUiLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsICRyb290U2NvcGUsIGRpbWVuc2lvbnMsIGRlYm91bmNlLCB0aHJvdHRsZSkgewoKICAgICAgdmFyIHdpbmRvd0VsID0gYW5ndWxhci5lbGVtZW50KCR3aW5kb3cpOwogICAgICB2YXIgZG9jRWwgPSBhbmd1bGFyLmVsZW1lbnQoJGRvY3VtZW50LnByb3AoJ2RvY3VtZW50RWxlbWVudCcpKTsKICAgICAgdmFyIGJvZHlFbCA9IGFuZ3VsYXIuZWxlbWVudCgkd2luZG93LmRvY3VtZW50LmJvZHkpOwoKICAgICAgLy8gSGVscGVyIGZ1bmN0aW9ucwoKICAgICAgZnVuY3Rpb24gbm9kZU5hbWUoZWxlbWVudCwgbmFtZSkgewogICAgICAgIHJldHVybiBlbGVtZW50WzBdLm5vZGVOYW1lICYmIGVsZW1lbnRbMF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBTY3JvbGxTcHlGYWN0b3J5KGNvbmZpZykgewoKICAgICAgICAvLyBDb21tb24gdmFycwogICAgICAgIHZhciBvcHRpb25zID0gYW5ndWxhci5leHRlbmQoe30sIGRlZmF1bHRzLCBjb25maWcpOwogICAgICAgIGlmKCFvcHRpb25zLmVsZW1lbnQpIG9wdGlvbnMuZWxlbWVudCA9IGJvZHlFbDsKICAgICAgICB2YXIgaXNXaW5kb3dTcHkgPSBub2RlTmFtZShvcHRpb25zLmVsZW1lbnQsICdib2R5Jyk7CiAgICAgICAgdmFyIHNjcm9sbEVsID0gaXNXaW5kb3dTcHkgPyB3aW5kb3dFbCA6IG9wdGlvbnMuZWxlbWVudDsKICAgICAgICB2YXIgc2Nyb2xsSWQgPSBpc1dpbmRvd1NweSA/ICd3aW5kb3cnIDogb3B0aW9ucy5pZDsKCiAgICAgICAgLy8gVXNlIGV4aXN0aW5nIHNweQogICAgICAgIGlmKHNwaWVzW3Njcm9sbElkXSkgewogICAgICAgICAgc3BpZXNbc2Nyb2xsSWRdLiQkY291bnQrKzsKICAgICAgICAgIHJldHVybiBzcGllc1tzY3JvbGxJZF07CiAgICAgICAgfQoKICAgICAgICB2YXIgJHNjcm9sbHNweSA9IHt9OwoKICAgICAgICAvLyBQcml2YXRlIHZhcnMKICAgICAgICB2YXIgdW5iaW5kVmlld0NvbnRlbnRMb2FkZWQsIHVuYmluZEluY2x1ZGVDb250ZW50TG9hZGVkOwogICAgICAgIHZhciB0cmFja2VkRWxlbWVudHMgPSAkc2Nyb2xsc3B5LiR0cmFja2VkRWxlbWVudHMgPSBbXTsKICAgICAgICB2YXIgc29ydGVkRWxlbWVudHMgPSBbXTsKICAgICAgICB2YXIgYWN0aXZlVGFyZ2V0OwogICAgICAgIHZhciBkZWJvdW5jZWRDaGVja1Bvc2l0aW9uOwogICAgICAgIHZhciB0aHJvdHRsZWRDaGVja1Bvc2l0aW9uOwogICAgICAgIHZhciBkZWJvdW5jZWRDaGVja09mZnNldHM7CiAgICAgICAgdmFyIHZpZXdwb3J0SGVpZ2h0OwogICAgICAgIHZhciBzY3JvbGxUb3A7CgogICAgICAgICRzY3JvbGxzcHkuaW5pdCA9IGZ1bmN0aW9uKCkgewoKICAgICAgICAgIC8vIFNldHVwIGludGVybmFsIHJlZiBjb3VudGVyCiAgICAgICAgICB0aGlzLiQkY291bnQgPSAxOwoKICAgICAgICAgIC8vIEJpbmQgZXZlbnRzCiAgICAgICAgICBkZWJvdW5jZWRDaGVja1Bvc2l0aW9uID0gZGVib3VuY2UodGhpcy5jaGVja1Bvc2l0aW9uLCBvcHRpb25zLmRlYm91bmNlKTsKICAgICAgICAgIHRocm90dGxlZENoZWNrUG9zaXRpb24gPSB0aHJvdHRsZSh0aGlzLmNoZWNrUG9zaXRpb24sIG9wdGlvbnMudGhyb3R0bGUpOwogICAgICAgICAgc2Nyb2xsRWwub24oJ2NsaWNrJywgdGhpcy5jaGVja1Bvc2l0aW9uV2l0aEV2ZW50TG9vcCk7CiAgICAgICAgICB3aW5kb3dFbC5vbigncmVzaXplJywgZGVib3VuY2VkQ2hlY2tQb3NpdGlvbik7CiAgICAgICAgICBzY3JvbGxFbC5vbignc2Nyb2xsJywgdGhyb3R0bGVkQ2hlY2tQb3NpdGlvbik7CgogICAgICAgICAgZGVib3VuY2VkQ2hlY2tPZmZzZXRzID0gZGVib3VuY2UodGhpcy5jaGVja09mZnNldHMsIG9wdGlvbnMuZGVib3VuY2UpOwogICAgICAgICAgdW5iaW5kVmlld0NvbnRlbnRMb2FkZWQgPSAkcm9vdFNjb3BlLiRvbignJHZpZXdDb250ZW50TG9hZGVkJywgZGVib3VuY2VkQ2hlY2tPZmZzZXRzKTsKICAgICAgICAgIHVuYmluZEluY2x1ZGVDb250ZW50TG9hZGVkID0gJHJvb3RTY29wZS4kb24oJyRpbmNsdWRlQ29udGVudExvYWRlZCcsIGRlYm91bmNlZENoZWNrT2Zmc2V0cyk7CiAgICAgICAgICBkZWJvdW5jZWRDaGVja09mZnNldHMoKTsKCiAgICAgICAgICAvLyBSZWdpc3RlciBzcHkgZm9yIHJldXNlCiAgICAgICAgICBpZihzY3JvbGxJZCkgewogICAgICAgICAgICBzcGllc1tzY3JvbGxJZF0gPSAkc2Nyb2xsc3B5OwogICAgICAgICAgfQoKICAgICAgICB9OwoKICAgICAgICAkc2Nyb2xsc3B5LmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAvLyBDaGVjayBpbnRlcm5hbCByZWYgY291bnRlcgogICAgICAgICAgdGhpcy4kJGNvdW50LS07CiAgICAgICAgICBpZih0aGlzLiQkY291bnQgPiAwKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBVbmJpbmQgZXZlbnRzCiAgICAgICAgICBzY3JvbGxFbC5vZmYoJ2NsaWNrJywgdGhpcy5jaGVja1Bvc2l0aW9uV2l0aEV2ZW50TG9vcCk7CiAgICAgICAgICB3aW5kb3dFbC5vZmYoJ3Jlc2l6ZScsIGRlYm91bmNlZENoZWNrUG9zaXRpb24pOwogICAgICAgICAgc2Nyb2xsRWwub2ZmKCdzY3JvbGwnLCBkZWJvdW5jZWRDaGVja1Bvc2l0aW9uKTsKICAgICAgICAgIHVuYmluZFZpZXdDb250ZW50TG9hZGVkKCk7CiAgICAgICAgICB1bmJpbmRJbmNsdWRlQ29udGVudExvYWRlZCgpOwogICAgICAgICAgaWYgKHNjcm9sbElkKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzcGllc1tzY3JvbGxJZF07CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgJHNjcm9sbHNweS5jaGVja1Bvc2l0aW9uID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgLy8gTm90IHJlYWR5IHlldAogICAgICAgICAgaWYoIXNvcnRlZEVsZW1lbnRzLmxlbmd0aCkgcmV0dXJuOwoKICAgICAgICAgIC8vIENhbGN1bGF0ZSB0aGUgc2Nyb2xsIHBvc2l0aW9uCiAgICAgICAgICBzY3JvbGxUb3AgPSAoaXNXaW5kb3dTcHkgPyAkd2luZG93LnBhZ2VZT2Zmc2V0IDogc2Nyb2xsRWwucHJvcCgnc2Nyb2xsVG9wJykpIHx8IDA7CgogICAgICAgICAgLy8gQ2FsY3VsYXRlIHRoZSB2aWV3cG9ydCBoZWlnaHQgZm9yIHVzZSBieSB0aGUgY29tcG9uZW50cwogICAgICAgICAgdmlld3BvcnRIZWlnaHQgPSBNYXRoLm1heCgkd2luZG93LmlubmVySGVpZ2h0LCBkb2NFbC5wcm9wKCdjbGllbnRIZWlnaHQnKSk7CgogICAgICAgICAgLy8gQWN0aXZhdGUgZmlyc3QgZWxlbWVudCBpZiBzY3JvbGwgaXMgc21hbGxlcgogICAgICAgICAgaWYoc2Nyb2xsVG9wIDwgc29ydGVkRWxlbWVudHNbMF0ub2Zmc2V0VG9wICYmIGFjdGl2ZVRhcmdldCAhPT0gc29ydGVkRWxlbWVudHNbMF0udGFyZ2V0KSB7CiAgICAgICAgICAgIHJldHVybiAkc2Nyb2xsc3B5LiRhY3RpdmF0ZUVsZW1lbnQoc29ydGVkRWxlbWVudHNbMF0pOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIEFjdGl2YXRlIHByb3BlciBlbGVtZW50CiAgICAgICAgICBmb3IgKHZhciBpID0gc29ydGVkRWxlbWVudHMubGVuZ3RoOyBpLS07KSB7CiAgICAgICAgICAgIGlmKGFuZ3VsYXIuaXNVbmRlZmluZWQoc29ydGVkRWxlbWVudHNbaV0ub2Zmc2V0VG9wKSB8fCBzb3J0ZWRFbGVtZW50c1tpXS5vZmZzZXRUb3AgPT09IG51bGwpIGNvbnRpbnVlOwogICAgICAgICAgICBpZihhY3RpdmVUYXJnZXQgPT09IHNvcnRlZEVsZW1lbnRzW2ldLnRhcmdldCkgY29udGludWU7CiAgICAgICAgICAgIGlmKHNjcm9sbFRvcCA8IHNvcnRlZEVsZW1lbnRzW2ldLm9mZnNldFRvcCkgY29udGludWU7CiAgICAgICAgICAgIGlmKHNvcnRlZEVsZW1lbnRzW2kgKyAxXSAmJiBzY3JvbGxUb3AgPiBzb3J0ZWRFbGVtZW50c1tpICsgMV0ub2Zmc2V0VG9wKSBjb250aW51ZTsKICAgICAgICAgICAgcmV0dXJuICRzY3JvbGxzcHkuJGFjdGl2YXRlRWxlbWVudChzb3J0ZWRFbGVtZW50c1tpXSk7CiAgICAgICAgICB9CgogICAgICAgIH07CgogICAgICAgICRzY3JvbGxzcHkuY2hlY2tQb3NpdGlvbldpdGhFdmVudExvb3AgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHNldFRpbWVvdXQodGhpcy5jaGVja1Bvc2l0aW9uLCAxKTsKICAgICAgICB9OwoKICAgICAgICAvLyBQcm90ZWN0ZWQgbWV0aG9kcwoKICAgICAgICAkc2Nyb2xsc3B5LiRhY3RpdmF0ZUVsZW1lbnQgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICBpZihhY3RpdmVUYXJnZXQpIHsKICAgICAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnQgPSAkc2Nyb2xsc3B5LiRnZXRUcmFja2VkRWxlbWVudChhY3RpdmVUYXJnZXQpOwogICAgICAgICAgICBpZihhY3RpdmVFbGVtZW50KSB7CiAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudC5zb3VyY2UucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgICAgICAgIGlmKG5vZGVOYW1lKGFjdGl2ZUVsZW1lbnQuc291cmNlLCAnbGknKSAmJiBub2RlTmFtZShhY3RpdmVFbGVtZW50LnNvdXJjZS5wYXJlbnQoKS5wYXJlbnQoKSwgJ2xpJykpIHsKICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQuc291cmNlLnBhcmVudCgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGFjdGl2ZVRhcmdldCA9IGVsZW1lbnQudGFyZ2V0OwogICAgICAgICAgZWxlbWVudC5zb3VyY2UuYWRkQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgICAgaWYobm9kZU5hbWUoZWxlbWVudC5zb3VyY2UsICdsaScpICYmIG5vZGVOYW1lKGVsZW1lbnQuc291cmNlLnBhcmVudCgpLnBhcmVudCgpLCAnbGknKSkgewogICAgICAgICAgICBlbGVtZW50LnNvdXJjZS5wYXJlbnQoKS5wYXJlbnQoKS5hZGRDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgJHNjcm9sbHNweS4kZ2V0VHJhY2tlZEVsZW1lbnQgPSBmdW5jdGlvbih0YXJnZXQpIHsKICAgICAgICAgIHJldHVybiB0cmFja2VkRWxlbWVudHMuZmlsdGVyKGZ1bmN0aW9uKG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqLnRhcmdldCA9PT0gdGFyZ2V0OwogICAgICAgICAgfSlbMF07CiAgICAgICAgfTsKCiAgICAgICAgLy8gVHJhY2sgb2Zmc2V0cyBiZWhhdmlvcgoKICAgICAgICAkc2Nyb2xsc3B5LmNoZWNrT2Zmc2V0cyA9IGZ1bmN0aW9uKCkgewoKICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0cmFja2VkRWxlbWVudHMsIGZ1bmN0aW9uKHRyYWNrZWRFbGVtZW50KSB7CiAgICAgICAgICAgIHZhciB0YXJnZXRFbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0cmFja2VkRWxlbWVudC50YXJnZXQpOwogICAgICAgICAgICB0cmFja2VkRWxlbWVudC5vZmZzZXRUb3AgPSB0YXJnZXRFbGVtZW50ID8gZGltZW5zaW9ucy5vZmZzZXQodGFyZ2V0RWxlbWVudCkudG9wIDogbnVsbDsKICAgICAgICAgICAgaWYob3B0aW9ucy5vZmZzZXQgJiYgdHJhY2tlZEVsZW1lbnQub2Zmc2V0VG9wICE9PSBudWxsKSB0cmFja2VkRWxlbWVudC5vZmZzZXRUb3AgLT0gb3B0aW9ucy5vZmZzZXQgKiAxOwogICAgICAgICAgfSk7CgogICAgICAgICAgc29ydGVkRWxlbWVudHMgPSB0cmFja2VkRWxlbWVudHMKICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgcmV0dXJuIGVsLm9mZnNldFRvcCAhPT0gbnVsbDsKICAgICAgICAgIH0pCiAgICAgICAgICAuc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhLm9mZnNldFRvcCAtIGIub2Zmc2V0VG9wOwogICAgICAgICAgfSk7CgogICAgICAgICAgZGVib3VuY2VkQ2hlY2tQb3NpdGlvbigpOwoKICAgICAgICB9OwoKICAgICAgICAkc2Nyb2xsc3B5LnRyYWNrRWxlbWVudCA9IGZ1bmN0aW9uKHRhcmdldCwgc291cmNlKSB7CiAgICAgICAgICB0cmFja2VkRWxlbWVudHMucHVzaCh7dGFyZ2V0OiB0YXJnZXQsIHNvdXJjZTogc291cmNlfSk7CiAgICAgICAgfTsKCiAgICAgICAgJHNjcm9sbHNweS51bnRyYWNrRWxlbWVudCA9IGZ1bmN0aW9uKHRhcmdldCwgc291cmNlKSB7CiAgICAgICAgICB2YXIgdG9EZWxldGU7CiAgICAgICAgICBmb3IgKHZhciBpID0gdHJhY2tlZEVsZW1lbnRzLmxlbmd0aDsgaS0tOykgewogICAgICAgICAgICBpZih0cmFja2VkRWxlbWVudHNbaV0udGFyZ2V0ID09PSB0YXJnZXQgJiYgdHJhY2tlZEVsZW1lbnRzW2ldLnNvdXJjZSA9PT0gc291cmNlKSB7CiAgICAgICAgICAgICAgdG9EZWxldGUgPSBpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0cmFja2VkRWxlbWVudHMgPSB0cmFja2VkRWxlbWVudHMuc3BsaWNlKHRvRGVsZXRlLCAxKTsKICAgICAgICB9OwoKICAgICAgICAkc2Nyb2xsc3B5LmFjdGl2YXRlID0gZnVuY3Rpb24oaSkgewogICAgICAgICAgdHJhY2tlZEVsZW1lbnRzW2ldLmFkZENsYXNzKCdhY3RpdmUnKTsKICAgICAgICB9OwoKICAgICAgICAvLyBJbml0aWFsaXplIHBsdWdpbgoKICAgICAgICAkc2Nyb2xsc3B5LmluaXQoKTsKICAgICAgICByZXR1cm4gJHNjcm9sbHNweTsKCiAgICAgIH0KCiAgICAgIHJldHVybiBTY3JvbGxTcHlGYWN0b3J5OwoKICAgIH1dOwoKICB9KQoKICAuZGlyZWN0aXZlKCdic1Njcm9sbHNweScsIFsiJHJvb3RTY29wZSIsICJkZWJvdW5jZSIsICJkaW1lbnNpb25zIiwgIiRzY3JvbGxzcHkiLCBmdW5jdGlvbigkcm9vdFNjb3BlLCBkZWJvdW5jZSwgZGltZW5zaW9ucywgJHNjcm9sbHNweSkgewoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRUFDJywKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKCiAgICAgICAgdmFyIG9wdGlvbnMgPSB7c2NvcGU6IHNjb3BlfTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goWydvZmZzZXQnLCAndGFyZ2V0J10sIGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgaWYoYW5ndWxhci5pc0RlZmluZWQoYXR0cltrZXldKSkgb3B0aW9uc1trZXldID0gYXR0cltrZXldOwogICAgICAgIH0pOwoKICAgICAgICB2YXIgc2Nyb2xsc3B5ID0gJHNjcm9sbHNweShvcHRpb25zKTsKICAgICAgICBzY3JvbGxzcHkudHJhY2tFbGVtZW50KG9wdGlvbnMudGFyZ2V0LCBlbGVtZW50KTsKCiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHNjcm9sbHNweSkgewogICAgICAgICAgICBzY3JvbGxzcHkudW50cmFja0VsZW1lbnQob3B0aW9ucy50YXJnZXQsIGVsZW1lbnQpOwogICAgICAgICAgICBzY3JvbGxzcHkuZGVzdHJveSgpOwogICAgICAgICAgfQogICAgICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICAgICAgICBzY3JvbGxzcHkgPSBudWxsOwogICAgICAgIH0pOwoKICAgICAgfQogICAgfTsKCiAgfV0pCgoKICAuZGlyZWN0aXZlKCdic1Njcm9sbHNweUxpc3QnLCBbIiRyb290U2NvcGUiLCAiZGVib3VuY2UiLCAiZGltZW5zaW9ucyIsICIkc2Nyb2xsc3B5IiwgZnVuY3Rpb24oJHJvb3RTY29wZSwgZGVib3VuY2UsIGRpbWVuc2lvbnMsICRzY3JvbGxzcHkpIHsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0EnLAogICAgICBjb21waWxlOiBmdW5jdGlvbiBwb3N0TGluayhlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgdmFyIGNoaWxkcmVuID0gZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yQWxsKCdsaSA+IGFbaHJlZl0nKTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICB2YXIgY2hpbGRFbCA9IGFuZ3VsYXIuZWxlbWVudChjaGlsZCk7CiAgICAgICAgICBjaGlsZEVsLnBhcmVudCgpLmF0dHIoJ2JzLXNjcm9sbHNweScsICcnKS5hdHRyKCdkYXRhLXRhcmdldCcsIGNoaWxkRWwuYXR0cignaHJlZicpKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgIH07CgogIH1dKTsKCi8vIFNvdXJjZTogc2VsZWN0LmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5zZWxlY3QnLCBbJ21nY3JlYS5uZ1N0cmFwLnRvb2x0aXAnLCAnbWdjcmVhLm5nU3RyYXAuaGVscGVycy5wYXJzZU9wdGlvbnMnXSkKCiAgLnByb3ZpZGVyKCckc2VsZWN0JywgZnVuY3Rpb24oKSB7CgogICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgYW5pbWF0aW9uOiAnYW0tZmFkZScsCiAgICAgIHByZWZpeENsYXNzOiAnc2VsZWN0JywKICAgICAgcHJlZml4RXZlbnQ6ICckc2VsZWN0JywKICAgICAgcGxhY2VtZW50OiAnYm90dG9tLWxlZnQnLAogICAgICB0ZW1wbGF0ZTogJ3NlbGVjdC9zZWxlY3QudHBsLmh0bWwnLAogICAgICB0cmlnZ2VyOiAnZm9jdXMnLAogICAgICBjb250YWluZXI6IGZhbHNlLAogICAgICBrZXlib2FyZDogdHJ1ZSwKICAgICAgaHRtbDogZmFsc2UsCiAgICAgIGRlbGF5OiAwLAogICAgICBtdWx0aXBsZTogZmFsc2UsCiAgICAgIGFsbE5vbmVCdXR0b25zOiBmYWxzZSwKICAgICAgc29ydDogdHJ1ZSwKICAgICAgY2FyZXRIdG1sOiAnJm5ic3A7PHNwYW4gY2xhc3M9ImNhcmV0Ij48L3NwYW4+JywKICAgICAgcGxhY2Vob2xkZXI6ICdDaG9vc2UgYW1vbmcgdGhlIGZvbGxvd2luZy4uLicsCiAgICAgIG1heExlbmd0aDogMywKICAgICAgbWF4TGVuZ3RoSHRtbDogJ3NlbGVjdGVkJywKICAgICAgaWNvbkNoZWNrbWFyazogJ2dseXBoaWNvbiBnbHlwaGljb24tb2snCiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsiJHdpbmRvdyIsICIkZG9jdW1lbnQiLCAiJHJvb3RTY29wZSIsICIkdG9vbHRpcCIsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgJHJvb3RTY29wZSwgJHRvb2x0aXApIHsKCiAgICAgIHZhciBib2R5RWwgPSBhbmd1bGFyLmVsZW1lbnQoJHdpbmRvdy5kb2N1bWVudC5ib2R5KTsKICAgICAgdmFyIGlzTmF0aXZlID0gLyhpcChhfG8pZHxpcGhvbmV8YW5kcm9pZCkvaWcudGVzdCgkd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpOwogICAgICB2YXIgaXNUb3VjaCA9ICgnY3JlYXRlVG91Y2gnIGluICR3aW5kb3cuZG9jdW1lbnQpICYmIGlzTmF0aXZlOwoKICAgICAgZnVuY3Rpb24gU2VsZWN0RmFjdG9yeShlbGVtZW50LCBjb250cm9sbGVyLCBjb25maWcpIHsKCiAgICAgICAgdmFyICRzZWxlY3QgPSB7fTsKCiAgICAgICAgLy8gQ29tbW9uIHZhcnMKICAgICAgICB2YXIgb3B0aW9ucyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBkZWZhdWx0cywgY29uZmlnKTsKCiAgICAgICAgJHNlbGVjdCA9ICR0b29sdGlwKGVsZW1lbnQsIG9wdGlvbnMpOwogICAgICAgIHZhciBzY29wZSA9ICRzZWxlY3QuJHNjb3BlOwoKICAgICAgICBzY29wZS4kbWF0Y2hlcyA9IFtdOwogICAgICAgIHNjb3BlLiRhY3RpdmVJbmRleCA9IDA7CiAgICAgICAgc2NvcGUuJGlzTXVsdGlwbGUgPSBvcHRpb25zLm11bHRpcGxlOwogICAgICAgIHNjb3BlLiRzaG93QWxsTm9uZUJ1dHRvbnMgPSBvcHRpb25zLmFsbE5vbmVCdXR0b25zICYmIG9wdGlvbnMubXVsdGlwbGU7CiAgICAgICAgc2NvcGUuJGljb25DaGVja21hcmsgPSBvcHRpb25zLmljb25DaGVja21hcms7CgogICAgICAgIHNjb3BlLiRhY3RpdmF0ZSA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICBzY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRzZWxlY3QuYWN0aXZhdGUoaW5kZXgpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgc2NvcGUuJHNlbGVjdCA9IGZ1bmN0aW9uKGluZGV4LCBldnQpIHsKICAgICAgICAgIHNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHNlbGVjdC5zZWxlY3QoaW5kZXgpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgc2NvcGUuJGlzVmlzaWJsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuICRzZWxlY3QuJGlzVmlzaWJsZSgpOwogICAgICAgIH07CgogICAgICAgIHNjb3BlLiRpc0FjdGl2ZSA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICByZXR1cm4gJHNlbGVjdC4kaXNBY3RpdmUoaW5kZXgpOwogICAgICAgIH07CgogICAgICAgIHNjb3BlLiRzZWxlY3RBbGwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNjb3BlLiRtYXRjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmICghc2NvcGUuJGlzQWN0aXZlKGkpKSB7CiAgICAgICAgICAgICAgc2NvcGUuJHNlbGVjdChpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHNjb3BlLiRzZWxlY3ROb25lID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzY29wZS4kbWF0Y2hlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoc2NvcGUuJGlzQWN0aXZlKGkpKSB7CiAgICAgICAgICAgICAgc2NvcGUuJHNlbGVjdChpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vIFB1YmxpYyBtZXRob2RzCgogICAgICAgICRzZWxlY3QudXBkYXRlID0gZnVuY3Rpb24obWF0Y2hlcykgewogICAgICAgICAgc2NvcGUuJG1hdGNoZXMgPSBtYXRjaGVzOwogICAgICAgICAgJHNlbGVjdC4kdXBkYXRlQWN0aXZlSW5kZXgoKTsKICAgICAgICB9OwoKICAgICAgICAkc2VsZWN0LmFjdGl2YXRlID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgIGlmKG9wdGlvbnMubXVsdGlwbGUpIHsKICAgICAgICAgICAgc2NvcGUuJGFjdGl2ZUluZGV4LnNvcnQoKTsKICAgICAgICAgICAgJHNlbGVjdC4kaXNBY3RpdmUoaW5kZXgpID8gc2NvcGUuJGFjdGl2ZUluZGV4LnNwbGljZShzY29wZS4kYWN0aXZlSW5kZXguaW5kZXhPZihpbmRleCksIDEpIDogc2NvcGUuJGFjdGl2ZUluZGV4LnB1c2goaW5kZXgpOwogICAgICAgICAgICBpZihvcHRpb25zLnNvcnQpIHNjb3BlLiRhY3RpdmVJbmRleC5zb3J0KCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzY29wZS4kYWN0aXZlSW5kZXggPSBpbmRleDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzY29wZS4kYWN0aXZlSW5kZXg7CiAgICAgICAgfTsKCiAgICAgICAgJHNlbGVjdC5zZWxlY3QgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgdmFyIHZhbHVlID0gc2NvcGUuJG1hdGNoZXNbaW5kZXhdLnZhbHVlOwogICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkc2VsZWN0LmFjdGl2YXRlKGluZGV4KTsKICAgICAgICAgICAgaWYob3B0aW9ucy5tdWx0aXBsZSkgewogICAgICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZpZXdWYWx1ZShzY29wZS4kYWN0aXZlSW5kZXgubWFwKGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuJG1hdGNoZXNbaW5kZXhdLnZhbHVlOwogICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb250cm9sbGVyLiRzZXRWaWV3VmFsdWUodmFsdWUpOwogICAgICAgICAgICAgIC8vIEhpZGUgaWYgc2luZ2xlIHNlbGVjdAogICAgICAgICAgICAgICRzZWxlY3QuaGlkZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIC8vIEVtaXQgZXZlbnQKICAgICAgICAgIHNjb3BlLiRlbWl0KG9wdGlvbnMucHJlZml4RXZlbnQgKyAnLnNlbGVjdCcsIHZhbHVlLCBpbmRleCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gUHJvdGVjdGVkIG1ldGhvZHMKCiAgICAgICAgJHNlbGVjdC4kdXBkYXRlQWN0aXZlSW5kZXggPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmKGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUgJiYgc2NvcGUuJG1hdGNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIGlmKG9wdGlvbnMubXVsdGlwbGUgJiYgYW5ndWxhci5pc0FycmF5KGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUpKSB7CiAgICAgICAgICAgICAgc2NvcGUuJGFjdGl2ZUluZGV4ID0gY29udHJvbGxlci4kbW9kZWxWYWx1ZS5tYXAoZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkc2VsZWN0LiRnZXRJbmRleCh2YWx1ZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2NvcGUuJGFjdGl2ZUluZGV4ID0gJHNlbGVjdC4kZ2V0SW5kZXgoY29udHJvbGxlci4kbW9kZWxWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZihzY29wZS4kYWN0aXZlSW5kZXggPj0gc2NvcGUuJG1hdGNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHNjb3BlLiRhY3RpdmVJbmRleCA9IG9wdGlvbnMubXVsdGlwbGUgPyBbXSA6IDA7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgJHNlbGVjdC4kaXNWaXNpYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZighb3B0aW9ucy5taW5MZW5ndGggfHwgIWNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRtYXRjaGVzLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIC8vIG1pbkxlbmd0aCBzdXBwb3J0CiAgICAgICAgICByZXR1cm4gc2NvcGUuJG1hdGNoZXMubGVuZ3RoICYmIGNvbnRyb2xsZXIuJHZpZXdWYWx1ZS5sZW5ndGggPj0gb3B0aW9ucy5taW5MZW5ndGg7CiAgICAgICAgfTsKCiAgICAgICAgJHNlbGVjdC4kaXNBY3RpdmUgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgaWYob3B0aW9ucy5tdWx0aXBsZSkgewogICAgICAgICAgICByZXR1cm4gc2NvcGUuJGFjdGl2ZUluZGV4LmluZGV4T2YoaW5kZXgpICE9PSAtMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBzY29wZS4kYWN0aXZlSW5kZXggPT09IGluZGV4OwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgICRzZWxlY3QuJGdldEluZGV4ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHZhciBsID0gc2NvcGUuJG1hdGNoZXMubGVuZ3RoLCBpID0gbDsKICAgICAgICAgIGlmKCFsKSByZXR1cm47CiAgICAgICAgICBmb3IoaSA9IGw7IGktLTspIHsKICAgICAgICAgICAgaWYoc2NvcGUuJG1hdGNoZXNbaV0udmFsdWUgPT09IHZhbHVlKSBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGlmKGkgPCAwKSByZXR1cm47CiAgICAgICAgICByZXR1cm4gaTsKICAgICAgICB9OwoKICAgICAgICAkc2VsZWN0LiRvbk1vdXNlRG93biA9IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgLy8gUHJldmVudCBibHVyIG9uIG1vdXNlZG93biBvbiAuZHJvcGRvd24tbWVudQogICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAvLyBFbXVsYXRlIGNsaWNrIGZvciBtb2JpbGUgZGV2aWNlcwogICAgICAgICAgaWYoaXNUb3VjaCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0RWwgPSBhbmd1bGFyLmVsZW1lbnQoZXZ0LnRhcmdldCk7CiAgICAgICAgICAgIHRhcmdldEVsLnRyaWdnZXJIYW5kbGVyKCdjbGljaycpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgICRzZWxlY3QuJG9uS2V5RG93biA9IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgaWYgKCEvKDl8MTN8Mzh8NDApLy50ZXN0KGV2dC5rZXlDb2RlKSkgcmV0dXJuOwogICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CgogICAgICAgICAgLy8gU2VsZWN0IHdpdGggZW50ZXIKICAgICAgICAgIGlmKCFvcHRpb25zLm11bHRpcGxlICYmIChldnQua2V5Q29kZSA9PT0gMTMgfHwgZXZ0LmtleUNvZGUgPT09IDkpKSB7CiAgICAgICAgICAgIHJldHVybiAkc2VsZWN0LnNlbGVjdChzY29wZS4kYWN0aXZlSW5kZXgpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIE5hdmlnYXRlIHdpdGgga2V5Ym9hcmQKICAgICAgICAgIGlmKGV2dC5rZXlDb2RlID09PSAzOCAmJiBzY29wZS4kYWN0aXZlSW5kZXggPiAwKSBzY29wZS4kYWN0aXZlSW5kZXgtLTsKICAgICAgICAgIGVsc2UgaWYoZXZ0LmtleUNvZGUgPT09IDQwICYmIHNjb3BlLiRhY3RpdmVJbmRleCA8IHNjb3BlLiRtYXRjaGVzLmxlbmd0aCAtIDEpIHNjb3BlLiRhY3RpdmVJbmRleCsrOwogICAgICAgICAgZWxzZSBpZihhbmd1bGFyLmlzVW5kZWZpbmVkKHNjb3BlLiRhY3RpdmVJbmRleCkpIHNjb3BlLiRhY3RpdmVJbmRleCA9IDA7CiAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gT3ZlcnJpZGVzCgogICAgICAgIHZhciBfc2hvdyA9ICRzZWxlY3Quc2hvdzsKICAgICAgICAkc2VsZWN0LnNob3cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIF9zaG93KCk7CiAgICAgICAgICBpZihvcHRpb25zLm11bHRpcGxlKSB7CiAgICAgICAgICAgICRzZWxlY3QuJGVsZW1lbnQuYWRkQ2xhc3MoJ3NlbGVjdC1tdWx0aXBsZScpOwogICAgICAgICAgfQogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHNlbGVjdC4kZWxlbWVudC5vbihpc1RvdWNoID8gJ3RvdWNoc3RhcnQnIDogJ21vdXNlZG93bicsICRzZWxlY3QuJG9uTW91c2VEb3duKTsKICAgICAgICAgICAgaWYob3B0aW9ucy5rZXlib2FyZCkgewogICAgICAgICAgICAgIGVsZW1lbnQub24oJ2tleWRvd24nLCAkc2VsZWN0LiRvbktleURvd24pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICB2YXIgX2hpZGUgPSAkc2VsZWN0LmhpZGU7CiAgICAgICAgJHNlbGVjdC5oaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAkc2VsZWN0LiRlbGVtZW50Lm9mZihpc1RvdWNoID8gJ3RvdWNoc3RhcnQnIDogJ21vdXNlZG93bicsICRzZWxlY3QuJG9uTW91c2VEb3duKTsKICAgICAgICAgIGlmKG9wdGlvbnMua2V5Ym9hcmQpIHsKICAgICAgICAgICAgZWxlbWVudC5vZmYoJ2tleWRvd24nLCAkc2VsZWN0LiRvbktleURvd24pOwogICAgICAgICAgfQogICAgICAgICAgX2hpZGUodHJ1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuICRzZWxlY3Q7CgogICAgICB9CgogICAgICBTZWxlY3RGYWN0b3J5LmRlZmF1bHRzID0gZGVmYXVsdHM7CiAgICAgIHJldHVybiBTZWxlY3RGYWN0b3J5OwoKICAgIH1dOwoKICB9KQoKICAuZGlyZWN0aXZlKCdic1NlbGVjdCcsIFsiJHdpbmRvdyIsICIkcGFyc2UiLCAiJHEiLCAiJHNlbGVjdCIsICIkcGFyc2VPcHRpb25zIiwgZnVuY3Rpb24oJHdpbmRvdywgJHBhcnNlLCAkcSwgJHNlbGVjdCwgJHBhcnNlT3B0aW9ucykgewoKICAgIHZhciBkZWZhdWx0cyA9ICRzZWxlY3QuZGVmYXVsdHM7CgogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFQUMnLAogICAgICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjb250cm9sbGVyKSB7CgogICAgICAgIC8vIERpcmVjdGl2ZSBvcHRpb25zCiAgICAgICAgdmFyIG9wdGlvbnMgPSB7c2NvcGU6IHNjb3BlLCBwbGFjZWhvbGRlcjogZGVmYXVsdHMucGxhY2Vob2xkZXJ9OwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ3BsYWNlbWVudCcsICdjb250YWluZXInLCAnZGVsYXknLCAndHJpZ2dlcicsICdrZXlib2FyZCcsICdodG1sJywgJ2FuaW1hdGlvbicsICd0ZW1wbGF0ZScsICdwbGFjZWhvbGRlcicsICdtdWx0aXBsZScsICdhbGxOb25lQnV0dG9ucycsICdtYXhMZW5ndGgnLCAnbWF4TGVuZ3RoSHRtbCddLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNEZWZpbmVkKGF0dHJba2V5XSkpIG9wdGlvbnNba2V5XSA9IGF0dHJba2V5XTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gQWRkIHN1cHBvcnQgZm9yIHNlbGVjdCBtYXJrdXAKICAgICAgICBpZihlbGVtZW50WzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdzZWxlY3QnKSB7CiAgICAgICAgICB2YXIgaW5wdXRFbCA9IGVsZW1lbnQ7CiAgICAgICAgICBpbnB1dEVsLmNzcygnZGlzcGxheScsICdub25lJyk7CiAgICAgICAgICBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KCc8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImJ0biBidG4tZGVmYXVsdCI+PC9idXR0b24+Jyk7CiAgICAgICAgICBpbnB1dEVsLmFmdGVyKGVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgLy8gQnVpbGQgcHJvcGVyIG5nT3B0aW9ucwogICAgICAgIHZhciBwYXJzZWRPcHRpb25zID0gJHBhcnNlT3B0aW9ucyhhdHRyLm5nT3B0aW9ucyk7CgogICAgICAgIC8vIEluaXRpYWxpemUgc2VsZWN0CiAgICAgICAgdmFyIHNlbGVjdCA9ICRzZWxlY3QoZWxlbWVudCwgY29udHJvbGxlciwgb3B0aW9ucyk7CgogICAgICAgIC8vIFdhdGNoIG5nT3B0aW9ucyB2YWx1ZXMgYmVmb3JlIGZpbHRlcmluZyBmb3IgY2hhbmdlcwogICAgICAgIHZhciB3YXRjaGVkT3B0aW9ucyA9IHBhcnNlZE9wdGlvbnMuJG1hdGNoWzddLnJlcGxhY2UoL1x8LisvLCAnJykudHJpbSgpOwogICAgICAgIHNjb3BlLiR3YXRjaCh3YXRjaGVkT3B0aW9ucywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJ3Njb3BlLiR3YXRjaCglcyknLCB3YXRjaGVkT3B0aW9ucywgbmV3VmFsdWUsIG9sZFZhbHVlKTsKICAgICAgICAgIHBhcnNlZE9wdGlvbnMudmFsdWVzRm4oc2NvcGUsIGNvbnRyb2xsZXIpCiAgICAgICAgICAudGhlbihmdW5jdGlvbih2YWx1ZXMpIHsKICAgICAgICAgICAgc2VsZWN0LnVwZGF0ZSh2YWx1ZXMpOwogICAgICAgICAgICBjb250cm9sbGVyLiRyZW5kZXIoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sIHRydWUpOwoKICAgICAgICAvLyBXYXRjaCBtb2RlbCBmb3IgY2hhbmdlcwogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nTW9kZWwsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCdzY29wZS4kd2F0Y2goJXMpJywgYXR0ci5uZ01vZGVsLCBuZXdWYWx1ZSwgb2xkVmFsdWUpOwogICAgICAgICAgc2VsZWN0LiR1cGRhdGVBY3RpdmVJbmRleCgpOwogICAgICAgICAgY29udHJvbGxlci4kcmVuZGVyKCk7CiAgICAgICAgfSwgdHJ1ZSk7CgogICAgICAgIC8vIE1vZGVsIHJlbmRlcmluZyBpbiB2aWV3CiAgICAgICAgY29udHJvbGxlci4kcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCckcmVuZGVyJywgZWxlbWVudC5hdHRyKCduZy1tb2RlbCcpLCAnY29udHJvbGxlci4kbW9kZWxWYWx1ZScsIHR5cGVvZiBjb250cm9sbGVyLiRtb2RlbFZhbHVlLCBjb250cm9sbGVyLiRtb2RlbFZhbHVlLCAnY29udHJvbGxlci4kdmlld1ZhbHVlJywgdHlwZW9mIGNvbnRyb2xsZXIuJHZpZXdWYWx1ZSwgY29udHJvbGxlci4kdmlld1ZhbHVlKTsKICAgICAgICAgIHZhciBzZWxlY3RlZCwgaW5kZXg7CiAgICAgICAgICBpZihvcHRpb25zLm11bHRpcGxlICYmIGFuZ3VsYXIuaXNBcnJheShjb250cm9sbGVyLiRtb2RlbFZhbHVlKSkgewogICAgICAgICAgICBzZWxlY3RlZCA9IGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUubWFwKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgaW5kZXggPSBzZWxlY3QuJGdldEluZGV4KHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gYW5ndWxhci5pc0RlZmluZWQoaW5kZXgpID8gc2VsZWN0LiRzY29wZS4kbWF0Y2hlc1tpbmRleF0ubGFiZWwgOiBmYWxzZTsKICAgICAgICAgICAgfSkuZmlsdGVyKGFuZ3VsYXIuaXNEZWZpbmVkKTsKICAgICAgICAgICAgaWYoc2VsZWN0ZWQubGVuZ3RoID4gKG9wdGlvbnMubWF4TGVuZ3RoIHx8IGRlZmF1bHRzLm1heExlbmd0aCkpIHsKICAgICAgICAgICAgICBzZWxlY3RlZCA9IHNlbGVjdGVkLmxlbmd0aCArICcgJyArIChvcHRpb25zLm1heExlbmd0aEh0bWwgfHwgZGVmYXVsdHMubWF4TGVuZ3RoSHRtbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZWN0ZWQgPSBzZWxlY3RlZC5qb2luKCcsICcpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpbmRleCA9IHNlbGVjdC4kZ2V0SW5kZXgoY29udHJvbGxlci4kbW9kZWxWYWx1ZSk7CiAgICAgICAgICAgIHNlbGVjdGVkID0gYW5ndWxhci5pc0RlZmluZWQoaW5kZXgpID8gc2VsZWN0LiRzY29wZS4kbWF0Y2hlc1tpbmRleF0ubGFiZWwgOiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW1lbnQuaHRtbCgoc2VsZWN0ZWQgPyBzZWxlY3RlZCA6IG9wdGlvbnMucGxhY2Vob2xkZXIpICsgZGVmYXVsdHMuY2FyZXRIdG1sKTsKICAgICAgICB9OwoKICAgICAgICAvLyBHYXJiYWdlIGNvbGxlY3Rpb24KICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoc2VsZWN0KSBzZWxlY3QuZGVzdHJveSgpOwogICAgICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICAgICAgICBzZWxlY3QgPSBudWxsOwogICAgICAgIH0pOwoKICAgICAgfQogICAgfTsKCiAgfV0pOwoKLy8gU291cmNlOiB0YWIuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLnRhYicsIFtdKQoKICAucHJvdmlkZXIoJyR0YWInLCBmdW5jdGlvbigpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICBhbmltYXRpb246ICdhbS1mYWRlJywKICAgICAgdGVtcGxhdGU6ICd0YWIvdGFiLnRwbC5odG1sJywKICAgICAgbmF2Q2xhc3M6ICduYXYtdGFicycsCiAgICAgIGFjdGl2ZUNsYXNzOiAnYWN0aXZlJwogICAgfTsKCiAgICB2YXIgY29udHJvbGxlciA9IHRoaXMuY29udHJvbGxlciA9IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAvLyBBdHRyaWJ1dGVzIG9wdGlvbnMKICAgICAgc2VsZi4kb3B0aW9ucyA9IGFuZ3VsYXIuY29weShkZWZhdWx0cyk7CiAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ2FuaW1hdGlvbicsICduYXZDbGFzcycsICdhY3RpdmVDbGFzcyddLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICBpZihhbmd1bGFyLmlzRGVmaW5lZCgkYXR0cnNba2V5XSkpIHNlbGYuJG9wdGlvbnNba2V5XSA9ICRhdHRyc1trZXldOwogICAgICB9KTsKCiAgICAgIC8vIFB1Ymxpc2ggb3B0aW9ucyBvbiBzY29wZQogICAgICAkc2NvcGUuJG5hdkNsYXNzID0gc2VsZi4kb3B0aW9ucy5uYXZDbGFzczsKICAgICAgJHNjb3BlLiRhY3RpdmVDbGFzcyA9IHNlbGYuJG9wdGlvbnMuYWN0aXZlQ2xhc3M7CgogICAgICBzZWxmLiRwYW5lcyA9ICRzY29wZS4kcGFuZXMgPSBbXTsKCiAgICAgIHNlbGYuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMgPSBbXTsKCiAgICAgIHNlbGYuJHB1c2ggPSBmdW5jdGlvbihwYW5lKSB7CiAgICAgICAgc2VsZi4kcGFuZXMucHVzaChwYW5lKTsKICAgICAgfTsKCiAgICAgIHNlbGYuJHJlbW92ZSA9IGZ1bmN0aW9uKHBhbmUpIHsKICAgICAgICB2YXIgaW5kZXggPSBzZWxmLiRwYW5lcy5pbmRleE9mKHBhbmUpOwogICAgICAgIHZhciBhY3RpdmVJbmRleCA9IHNlbGYuJHBhbmVzLiRhY3RpdmU7CgogICAgICAgIC8vIHJlbW92ZSBwYW5lIGZyb20gJHBhbmVzIGFycmF5CiAgICAgICAgc2VsZi4kcGFuZXMuc3BsaWNlKGluZGV4LCAxKTsKCiAgICAgICAgaWYgKGluZGV4IDwgYWN0aXZlSW5kZXgpIHsKICAgICAgICAgIC8vIHdlIHJlbW92ZWQgYSBwYW5lIGJlZm9yZSB0aGUgYWN0aXZlIHBhbmUsIHNvIHdlIG5lZWQgdG8gCiAgICAgICAgICAvLyBkZWNyZW1lbnQgdGhlIGFjdGl2ZSBwYW5lIGluZGV4CiAgICAgICAgICBhY3RpdmVJbmRleC0tOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChpbmRleCA9PT0gYWN0aXZlSW5kZXggJiYgYWN0aXZlSW5kZXggPT09IHNlbGYuJHBhbmVzLmxlbmd0aCkgewogICAgICAgICAgLy8gd2UgcmVtb3ZlIHRoZSBhY3RpdmUgcGFuZSBhbmQgaXQgd2FzIHRoZSBvbmUgYXQgdGhlIGVuZCwKICAgICAgICAgIC8vIHNvIHNlbGVjdCB0aGUgcHJldmlvdXMgb25lCiAgICAgICAgICBhY3RpdmVJbmRleC0tOwogICAgICAgIH0KICAgICAgICBzZWxmLiRzZXRBY3RpdmUoYWN0aXZlSW5kZXgpOwogICAgICB9OwoKICAgICAgc2VsZi4kcGFuZXMuJGFjdGl2ZSA9IDA7CiAgICAgIHNlbGYuJHNldEFjdGl2ZSA9ICRzY29wZS4kc2V0QWN0aXZlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBzZWxmLiRwYW5lcy4kYWN0aXZlID0gdmFsdWU7CiAgICAgICAgc2VsZi4kdmlld0NoYW5nZUxpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICBmbigpOwogICAgICAgIH0pOwogICAgICB9OwoKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciAkdGFiID0ge307CiAgICAgICR0YWIuZGVmYXVsdHMgPSBkZWZhdWx0czsKICAgICAgJHRhYi5jb250cm9sbGVyID0gY29udHJvbGxlcjsKICAgICAgcmV0dXJuICR0YWI7CiAgICB9OwoKICB9KQoKICAuZGlyZWN0aXZlKCdic1RhYnMnLCBbIiR3aW5kb3ciLCAiJGFuaW1hdGUiLCAiJHRhYiIsIGZ1bmN0aW9uKCR3aW5kb3csICRhbmltYXRlLCAkdGFiKSB7CgogICAgdmFyIGRlZmF1bHRzID0gJHRhYi5kZWZhdWx0czsKCiAgICByZXR1cm4gewogICAgICByZXF1aXJlOiBbJz9uZ01vZGVsJywgJ2JzVGFicyddLAogICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCAnJGF0dHJzJywgJHRhYi5jb250cm9sbGVyXSwKICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICByZXR1cm4gYXR0ci50ZW1wbGF0ZSB8fCBkZWZhdWx0cy50ZW1wbGF0ZTsKICAgICAgfSwKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjb250cm9sbGVycykgewoKICAgICAgICB2YXIgbmdNb2RlbEN0cmwgPSBjb250cm9sbGVyc1swXTsKICAgICAgICB2YXIgYnNUYWJzQ3RybCA9IGNvbnRyb2xsZXJzWzFdOwoKICAgICAgICBpZihuZ01vZGVsQ3RybCkgewoKICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgbW9kZWxWYWx1ZSBmb2xsb3dpbmcKICAgICAgICAgIGJzVGFic0N0cmwuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMucHVzaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHNldFZpZXdWYWx1ZShic1RhYnNDdHJsLiRwYW5lcy4kYWN0aXZlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIG1vZGVsVmFsdWUgLT4gJGZvcm1hdHRlcnMgLT4gdmlld1ZhbHVlCiAgICAgICAgICBuZ01vZGVsQ3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uKG1vZGVsVmFsdWUpIHsKICAgICAgICAgICAgLy8gY29uc29sZS53YXJuKCckZm9ybWF0dGVyKCIlcyIpOiBtb2RlbFZhbHVlPSVvICglbyknLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksIG1vZGVsVmFsdWUsIHR5cGVvZiBtb2RlbFZhbHVlKTsKICAgICAgICAgICAgYnNUYWJzQ3RybC4kc2V0QWN0aXZlKG1vZGVsVmFsdWUgKiAxKTsKICAgICAgICAgICAgcmV0dXJuIG1vZGVsVmFsdWU7CiAgICAgICAgICB9KTsKCiAgICAgICAgfQoKICAgICAgfQogICAgfTsKCiAgfV0pCgogIC5kaXJlY3RpdmUoJ2JzUGFuZScsIFsiJHdpbmRvdyIsICIkYW5pbWF0ZSIsICIkc2NlIiwgZnVuY3Rpb24oJHdpbmRvdywgJGFuaW1hdGUsICRzY2UpIHsKCiAgICByZXR1cm4gewogICAgICByZXF1aXJlOiBbJ14/bmdNb2RlbCcsICdeYnNUYWJzJ10sCiAgICAgIHNjb3BlOiB0cnVlLAogICAgICBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgZWxlbWVudCwgYXR0cnMsIGNvbnRyb2xsZXJzKSB7CgogICAgICAgIHZhciBuZ01vZGVsQ3RybCA9IGNvbnRyb2xsZXJzWzBdOwogICAgICAgIHZhciBic1RhYnNDdHJsID0gY29udHJvbGxlcnNbMV07CgogICAgICAgIC8vIEFkZCBiYXNlIGNsYXNzCiAgICAgICAgZWxlbWVudC5hZGRDbGFzcygndGFiLXBhbmUnKTsKCiAgICAgICAgLy8gT2JzZXJ2ZSB0aXRsZSBhdHRyaWJ1dGUgZm9yIGNoYW5nZQogICAgICAgIGF0dHJzLiRvYnNlcnZlKCd0aXRsZScsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgc2NvcGUudGl0bGUgPSAkc2NlLnRydXN0QXNIdG1sKG5ld1ZhbHVlKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gQWRkIGFuaW1hdGlvbiBjbGFzcwogICAgICAgIGlmKGJzVGFic0N0cmwuJG9wdGlvbnMuYW5pbWF0aW9uKSB7CiAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKGJzVGFic0N0cmwuJG9wdGlvbnMuYW5pbWF0aW9uKTsKICAgICAgICB9CgogICAgICAgIC8vIFB1c2ggcGFuZSB0byBwYXJlbnQgYnNUYWJzIGNvbnRyb2xsZXIKICAgICAgICBic1RhYnNDdHJsLiRwdXNoKHNjb3BlKTsKCiAgICAgICAgLy8gcmVtb3ZlIHBhbmUgZnJvbSB0YWIgY29udHJvbGxlciB3aGVuIHBhbmUgaXMgZGVzdHJveWVkCiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgYnNUYWJzQ3RybC4kcmVtb3ZlKHNjb3BlKTsKICAgICAgICB9KTsKCiAgICAgICAgZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgICAgdmFyIGluZGV4ID0gYnNUYWJzQ3RybC4kcGFuZXMuaW5kZXhPZihzY29wZSk7CiAgICAgICAgICB2YXIgYWN0aXZlID0gYnNUYWJzQ3RybC4kcGFuZXMuJGFjdGl2ZTsKICAgICAgICAgICRhbmltYXRlW2luZGV4ID09PSBhY3RpdmUgPyAnYWRkQ2xhc3MnIDogJ3JlbW92ZUNsYXNzJ10oZWxlbWVudCwgYnNUYWJzQ3RybC4kb3B0aW9ucy5hY3RpdmVDbGFzcyk7CiAgICAgICAgfQoKICAgICAgICBic1RhYnNDdHJsLiR2aWV3Q2hhbmdlTGlzdGVuZXJzLnB1c2goZnVuY3Rpb24oKSB7CiAgICAgICAgICByZW5kZXIoKTsKICAgICAgICB9KTsKICAgICAgICByZW5kZXIoKTsKCiAgICAgIH0KICAgIH07CgogIH1dKTsKCi8vIFNvdXJjZTogdGltZXBpY2tlci5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAudGltZXBpY2tlcicsIFsnbWdjcmVhLm5nU3RyYXAuaGVscGVycy5kYXRlUGFyc2VyJywgJ21nY3JlYS5uZ1N0cmFwLnRvb2x0aXAnXSkKCiAgLnByb3ZpZGVyKCckdGltZXBpY2tlcicsIGZ1bmN0aW9uKCkgewoKICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgIGFuaW1hdGlvbjogJ2FtLWZhZGUnLAogICAgICBwcmVmaXhDbGFzczogJ3RpbWVwaWNrZXInLAogICAgICBwbGFjZW1lbnQ6ICdib3R0b20tbGVmdCcsCiAgICAgIHRlbXBsYXRlOiAndGltZXBpY2tlci90aW1lcGlja2VyLnRwbC5odG1sJywKICAgICAgdHJpZ2dlcjogJ2ZvY3VzJywKICAgICAgY29udGFpbmVyOiBmYWxzZSwKICAgICAga2V5Ym9hcmQ6IHRydWUsCiAgICAgIGh0bWw6IGZhbHNlLAogICAgICBkZWxheTogMCwKICAgICAgLy8gbGFuZzogJGxvY2FsZS5pZCwKICAgICAgdXNlTmF0aXZlOiB0cnVlLAogICAgICB0aW1lVHlwZTogJ2RhdGUnLAogICAgICB0aW1lRm9ybWF0OiAnc2hvcnRUaW1lJywKICAgICAgbW9kZWxUaW1lRm9ybWF0OiBudWxsLAogICAgICBhdXRvY2xvc2U6IGZhbHNlLAogICAgICBtaW5UaW1lOiAtSW5maW5pdHksCiAgICAgIG1heFRpbWU6ICtJbmZpbml0eSwKICAgICAgbGVuZ3RoOiA1LAogICAgICBob3VyU3RlcDogMSwKICAgICAgbWludXRlU3RlcDogNSwKICAgICAgaWNvblVwOiAnZ2x5cGhpY29uIGdseXBoaWNvbi1jaGV2cm9uLXVwJywKICAgICAgaWNvbkRvd246ICdnbHlwaGljb24gZ2x5cGhpY29uLWNoZXZyb24tZG93bicsCiAgICAgIGFycm93QmVoYXZpb3I6ICdwYWdlcicKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gWyIkd2luZG93IiwgIiRkb2N1bWVudCIsICIkcm9vdFNjb3BlIiwgIiRzY2UiLCAiJGxvY2FsZSIsICJkYXRlRmlsdGVyIiwgIiR0b29sdGlwIiwgIiR0aW1lb3V0IiwgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCAkcm9vdFNjb3BlLCAkc2NlLCAkbG9jYWxlLCBkYXRlRmlsdGVyLCAkdG9vbHRpcCwgJHRpbWVvdXQpIHsKCiAgICAgIHZhciBib2R5RWwgPSBhbmd1bGFyLmVsZW1lbnQoJHdpbmRvdy5kb2N1bWVudC5ib2R5KTsKICAgICAgdmFyIGlzTmF0aXZlID0gLyhpcChhfG8pZHxpcGhvbmV8YW5kcm9pZCkvaWcudGVzdCgkd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpOwogICAgICB2YXIgaXNUb3VjaCA9ICgnY3JlYXRlVG91Y2gnIGluICR3aW5kb3cuZG9jdW1lbnQpICYmIGlzTmF0aXZlOwogICAgICBpZighZGVmYXVsdHMubGFuZykgZGVmYXVsdHMubGFuZyA9ICRsb2NhbGUuaWQ7CgogICAgICBmdW5jdGlvbiB0aW1lcGlja2VyRmFjdG9yeShlbGVtZW50LCBjb250cm9sbGVyLCBjb25maWcpIHsKCiAgICAgICAgdmFyICR0aW1lcGlja2VyID0gJHRvb2x0aXAoZWxlbWVudCwgYW5ndWxhci5leHRlbmQoe30sIGRlZmF1bHRzLCBjb25maWcpKTsKICAgICAgICB2YXIgcGFyZW50U2NvcGUgPSBjb25maWcuc2NvcGU7CiAgICAgICAgdmFyIG9wdGlvbnMgPSAkdGltZXBpY2tlci4kb3B0aW9uczsKICAgICAgICB2YXIgc2NvcGUgPSAkdGltZXBpY2tlci4kc2NvcGU7CgogICAgICAgIC8vIFZpZXcgdmFycwoKICAgICAgICB2YXIgc2VsZWN0ZWRJbmRleCA9IDA7CiAgICAgICAgdmFyIHN0YXJ0RGF0ZSA9IGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSB8fCBuZXcgRGF0ZSgpOwogICAgICAgIHZhciB2aWV3RGF0ZSA9IHtob3VyOiBzdGFydERhdGUuZ2V0SG91cnMoKSwgbWVyaWRpYW46IHN0YXJ0RGF0ZS5nZXRIb3VycygpIDwgMTIsIG1pbnV0ZTogc3RhcnREYXRlLmdldE1pbnV0ZXMoKSwgc2Vjb25kOiBzdGFydERhdGUuZ2V0U2Vjb25kcygpLCBtaWxsaXNlY29uZDogc3RhcnREYXRlLmdldE1pbGxpc2Vjb25kcygpfTsKCiAgICAgICAgdmFyIGZvcm1hdCA9ICRsb2NhbGUuREFURVRJTUVfRk9STUFUU1tvcHRpb25zLnRpbWVGb3JtYXRdIHx8IG9wdGlvbnMudGltZUZvcm1hdDsKICAgICAgICB2YXIgZm9ybWF0cyA9IC8oaCspKFs6XC5dKT8obSspWyBdPyhhPykvaS5leGVjKGZvcm1hdCkuc2xpY2UoMSk7CiAgICAgICAgc2NvcGUuJGljb25VcCA9IG9wdGlvbnMuaWNvblVwOwogICAgICAgIHNjb3BlLiRpY29uRG93biA9IG9wdGlvbnMuaWNvbkRvd247CgogICAgICAgIC8vIFNjb3BlIG1ldGhvZHMKCiAgICAgICAgc2NvcGUuJHNlbGVjdCA9IGZ1bmN0aW9uKGRhdGUsIGluZGV4KSB7CiAgICAgICAgICAkdGltZXBpY2tlci5zZWxlY3QoZGF0ZSwgaW5kZXgpOwogICAgICAgIH07CiAgICAgICAgc2NvcGUuJG1vdmVJbmRleCA9IGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICAgICAgJHRpbWVwaWNrZXIuJG1vdmVJbmRleCh2YWx1ZSwgaW5kZXgpOwogICAgICAgIH07CiAgICAgICAgc2NvcGUuJHN3aXRjaE1lcmlkaWFuID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgJHRpbWVwaWNrZXIuc3dpdGNoTWVyaWRpYW4oZGF0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gUHVibGljIG1ldGhvZHMKCiAgICAgICAgJHRpbWVwaWNrZXIudXBkYXRlID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCckdGltZXBpY2tlci51cGRhdGUoKSBuZXdWYWx1ZT0lbycsIGRhdGUpOwogICAgICAgICAgaWYoYW5ndWxhci5pc0RhdGUoZGF0ZSkgJiYgIWlzTmFOKGRhdGUuZ2V0VGltZSgpKSkgewogICAgICAgICAgICAkdGltZXBpY2tlci4kZGF0ZSA9IGRhdGU7CiAgICAgICAgICAgIGFuZ3VsYXIuZXh0ZW5kKHZpZXdEYXRlLCB7aG91cjogZGF0ZS5nZXRIb3VycygpLCBtaW51dGU6IGRhdGUuZ2V0TWludXRlcygpLCBzZWNvbmQ6IGRhdGUuZ2V0U2Vjb25kcygpLCBtaWxsaXNlY29uZDogZGF0ZS5nZXRNaWxsaXNlY29uZHMoKX0pOwogICAgICAgICAgICAkdGltZXBpY2tlci4kYnVpbGQoKTsKICAgICAgICAgIH0gZWxzZSBpZighJHRpbWVwaWNrZXIuJGlzQnVpbHQpIHsKICAgICAgICAgICAgJHRpbWVwaWNrZXIuJGJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgJHRpbWVwaWNrZXIuc2VsZWN0ID0gZnVuY3Rpb24oZGF0ZSwgaW5kZXgsIGtlZXApIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2FybignJHRpbWVwaWNrZXIuc2VsZWN0JywgZGF0ZSwgc2NvcGUuJG1vZGUpOwogICAgICAgICAgaWYoIWNvbnRyb2xsZXIuJGRhdGVWYWx1ZSB8fCBpc05hTihjb250cm9sbGVyLiRkYXRlVmFsdWUuZ2V0VGltZSgpKSkgY29udHJvbGxlci4kZGF0ZVZhbHVlID0gbmV3IERhdGUoMTk3MCwgMCwgMSk7CiAgICAgICAgICBpZighYW5ndWxhci5pc0RhdGUoZGF0ZSkpIGRhdGUgPSBuZXcgRGF0ZShkYXRlKTsKICAgICAgICAgIGlmKGluZGV4ID09PSAwKSBjb250cm9sbGVyLiRkYXRlVmFsdWUuc2V0SG91cnMoZGF0ZS5nZXRIb3VycygpKTsKICAgICAgICAgIGVsc2UgaWYoaW5kZXggPT09IDEpIGNvbnRyb2xsZXIuJGRhdGVWYWx1ZS5zZXRNaW51dGVzKGRhdGUuZ2V0TWludXRlcygpKTsKICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZpZXdWYWx1ZShjb250cm9sbGVyLiRkYXRlVmFsdWUpOwogICAgICAgICAgY29udHJvbGxlci4kcmVuZGVyKCk7CiAgICAgICAgICBpZihvcHRpb25zLmF1dG9jbG9zZSAmJiAha2VlcCkgewogICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsgJHRpbWVwaWNrZXIuaGlkZSh0cnVlKTsgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgJHRpbWVwaWNrZXIuc3dpdGNoTWVyaWRpYW4gPSBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICBpZiAoIWNvbnRyb2xsZXIuJGRhdGVWYWx1ZSB8fCBpc05hTihjb250cm9sbGVyLiRkYXRlVmFsdWUuZ2V0VGltZSgpKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaG91cnMgPSAoZGF0ZSB8fCBjb250cm9sbGVyLiRkYXRlVmFsdWUpLmdldEhvdXJzKCk7CiAgICAgICAgICBjb250cm9sbGVyLiRkYXRlVmFsdWUuc2V0SG91cnMoaG91cnMgPCAxMiA/IGhvdXJzICsgMTIgOiBob3VycyAtIDEyKTsKICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZpZXdWYWx1ZShjb250cm9sbGVyLiRkYXRlVmFsdWUpOwogICAgICAgICAgY29udHJvbGxlci4kcmVuZGVyKCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gUHJvdGVjdGVkIG1ldGhvZHMKCiAgICAgICAgJHRpbWVwaWNrZXIuJGJ1aWxkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyR0aW1lcGlja2VyLiRidWlsZCgpIHZpZXdEYXRlPSVvJywgdmlld0RhdGUpOwogICAgICAgICAgdmFyIGksIG1pZEluZGV4ID0gc2NvcGUubWlkSW5kZXggPSBwYXJzZUludChvcHRpb25zLmxlbmd0aCAvIDIsIDEwKTsKICAgICAgICAgIHZhciBob3VycyA9IFtdLCBob3VyOwogICAgICAgICAgZm9yKGkgPSAwOyBpIDwgb3B0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBob3VyID0gbmV3IERhdGUoMTk3MCwgMCwgMSwgdmlld0RhdGUuaG91ciAtIChtaWRJbmRleCAtIGkpICogb3B0aW9ucy5ob3VyU3RlcCk7CiAgICAgICAgICAgIGhvdXJzLnB1c2goe2RhdGU6IGhvdXIsIGxhYmVsOiBkYXRlRmlsdGVyKGhvdXIsIGZvcm1hdHNbMF0pLCBzZWxlY3RlZDogJHRpbWVwaWNrZXIuJGRhdGUgJiYgJHRpbWVwaWNrZXIuJGlzU2VsZWN0ZWQoaG91ciwgMCksIGRpc2FibGVkOiAkdGltZXBpY2tlci4kaXNEaXNhYmxlZChob3VyLCAwKX0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1pbnV0ZXMgPSBbXSwgbWludXRlOwogICAgICAgICAgZm9yKGkgPSAwOyBpIDwgb3B0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBtaW51dGUgPSBuZXcgRGF0ZSgxOTcwLCAwLCAxLCAwLCB2aWV3RGF0ZS5taW51dGUgLSAobWlkSW5kZXggLSBpKSAqIG9wdGlvbnMubWludXRlU3RlcCk7CiAgICAgICAgICAgIG1pbnV0ZXMucHVzaCh7ZGF0ZTogbWludXRlLCBsYWJlbDogZGF0ZUZpbHRlcihtaW51dGUsIGZvcm1hdHNbMl0pLCBzZWxlY3RlZDogJHRpbWVwaWNrZXIuJGRhdGUgJiYgJHRpbWVwaWNrZXIuJGlzU2VsZWN0ZWQobWludXRlLCAxKSwgZGlzYWJsZWQ6ICR0aW1lcGlja2VyLiRpc0Rpc2FibGVkKG1pbnV0ZSwgMSl9KTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgcm93cyA9IFtdOwogICAgICAgICAgZm9yKGkgPSAwOyBpIDwgb3B0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICByb3dzLnB1c2goW2hvdXJzW2ldLCBtaW51dGVzW2ldXSk7CiAgICAgICAgICB9CiAgICAgICAgICBzY29wZS5yb3dzID0gcm93czsKICAgICAgICAgIHNjb3BlLnNob3dBTSA9ICEhZm9ybWF0c1szXTsKICAgICAgICAgIHNjb3BlLmlzQU0gPSAoJHRpbWVwaWNrZXIuJGRhdGUgfHwgaG91cnNbbWlkSW5kZXhdLmRhdGUpLmdldEhvdXJzKCkgPCAxMjsKICAgICAgICAgIHNjb3BlLnRpbWVTZXBhcmF0b3IgPSBmb3JtYXRzWzFdOwogICAgICAgICAgJHRpbWVwaWNrZXIuJGlzQnVpbHQgPSB0cnVlOwogICAgICAgIH07CgogICAgICAgICR0aW1lcGlja2VyLiRpc1NlbGVjdGVkID0gZnVuY3Rpb24oZGF0ZSwgaW5kZXgpIHsKICAgICAgICAgIGlmKCEkdGltZXBpY2tlci4kZGF0ZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgZWxzZSBpZihpbmRleCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gZGF0ZS5nZXRIb3VycygpID09PSAkdGltZXBpY2tlci4kZGF0ZS5nZXRIb3VycygpOwogICAgICAgICAgfSBlbHNlIGlmKGluZGV4ID09PSAxKSB7CiAgICAgICAgICAgIHJldHVybiBkYXRlLmdldE1pbnV0ZXMoKSA9PT0gJHRpbWVwaWNrZXIuJGRhdGUuZ2V0TWludXRlcygpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgICR0aW1lcGlja2VyLiRpc0Rpc2FibGVkID0gZnVuY3Rpb24oZGF0ZSwgaW5kZXgpIHsKICAgICAgICAgIHZhciBzZWxlY3RlZFRpbWU7CiAgICAgICAgICBpZihpbmRleCA9PT0gMCkgewogICAgICAgICAgICBzZWxlY3RlZFRpbWUgPSBkYXRlLmdldFRpbWUoKSArIHZpZXdEYXRlLm1pbnV0ZSAqIDZlNDsKICAgICAgICAgIH0gZWxzZSBpZihpbmRleCA9PT0gMSkgewogICAgICAgICAgICBzZWxlY3RlZFRpbWUgPSBkYXRlLmdldFRpbWUoKSArIHZpZXdEYXRlLmhvdXIgKiAzNmU1OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHNlbGVjdGVkVGltZSA8IG9wdGlvbnMubWluVGltZSAqIDEgfHwgc2VsZWN0ZWRUaW1lID4gb3B0aW9ucy5tYXhUaW1lICogMTsKICAgICAgICB9OwoKICAgICAgICBzY29wZS4kYXJyb3dBY3Rpb24gPSBmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgICBpZiAob3B0aW9ucy5hcnJvd0JlaGF2aW9yID09PSAncGlja2VyJykgewogICAgICAgICAgICAkdGltZXBpY2tlci4kc2V0VGltZUJ5U3RlcCh2YWx1ZSxpbmRleCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkdGltZXBpY2tlci4kbW92ZUluZGV4KHZhbHVlLGluZGV4KTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAkdGltZXBpY2tlci4kc2V0VGltZUJ5U3RlcCA9IGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICAgICAgdmFyIG5ld0RhdGUgPSBuZXcgRGF0ZSgkdGltZXBpY2tlci4kZGF0ZSk7CiAgICAgICAgICB2YXIgaG91cnMgPSBuZXdEYXRlLmdldEhvdXJzKCksIGhvdXJzTGVuZ3RoID0gZGF0ZUZpbHRlcihuZXdEYXRlLCAnaCcpLmxlbmd0aDsKICAgICAgICAgIHZhciBtaW51dGVzID0gbmV3RGF0ZS5nZXRNaW51dGVzKCksIG1pbnV0ZXNMZW5ndGggPSBkYXRlRmlsdGVyKG5ld0RhdGUsICdtbScpLmxlbmd0aDsKICAgICAgICAgIGlmIChpbmRleCA9PT0gMCkgewogICAgICAgICAgICBuZXdEYXRlLnNldEhvdXJzKGhvdXJzIC0gKHBhcnNlSW50KG9wdGlvbnMuaG91clN0ZXAsIDEwKSAqIHZhbHVlKSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgbmV3RGF0ZS5zZXRNaW51dGVzKG1pbnV0ZXMgLSAocGFyc2VJbnQob3B0aW9ucy5taW51dGVTdGVwLCAxMCkgKiB2YWx1ZSkpOwogICAgICAgICAgfQogICAgICAgICAgJHRpbWVwaWNrZXIuc2VsZWN0KG5ld0RhdGUsIGluZGV4LCB0cnVlKTsKICAgICAgICAgIHBhcmVudFNjb3BlLiRkaWdlc3QoKTsKICAgICAgICB9OwoKICAgICAgICAkdGltZXBpY2tlci4kbW92ZUluZGV4ID0gZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0RGF0ZTsKICAgICAgICAgIGlmKGluZGV4ID09PSAwKSB7CiAgICAgICAgICAgIHRhcmdldERhdGUgPSBuZXcgRGF0ZSgxOTcwLCAwLCAxLCB2aWV3RGF0ZS5ob3VyICsgKHZhbHVlICogb3B0aW9ucy5sZW5ndGgpLCB2aWV3RGF0ZS5taW51dGUpOwogICAgICAgICAgICBhbmd1bGFyLmV4dGVuZCh2aWV3RGF0ZSwge2hvdXI6IHRhcmdldERhdGUuZ2V0SG91cnMoKX0pOwogICAgICAgICAgfSBlbHNlIGlmKGluZGV4ID09PSAxKSB7CiAgICAgICAgICAgIHRhcmdldERhdGUgPSBuZXcgRGF0ZSgxOTcwLCAwLCAxLCB2aWV3RGF0ZS5ob3VyLCB2aWV3RGF0ZS5taW51dGUgKyAodmFsdWUgKiBvcHRpb25zLmxlbmd0aCAqIG9wdGlvbnMubWludXRlU3RlcCkpOwogICAgICAgICAgICBhbmd1bGFyLmV4dGVuZCh2aWV3RGF0ZSwge21pbnV0ZTogdGFyZ2V0RGF0ZS5nZXRNaW51dGVzKCl9KTsKICAgICAgICAgIH0KICAgICAgICAgICR0aW1lcGlja2VyLiRidWlsZCgpOwogICAgICAgIH07CgogICAgICAgICR0aW1lcGlja2VyLiRvbk1vdXNlRG93biA9IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgLy8gUHJldmVudCBibHVyIG9uIG1vdXNlZG93biBvbiAuZHJvcGRvd24tbWVudQogICAgICAgICAgaWYoZXZ0LnRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAnaW5wdXQnKSBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIC8vIEVtdWxhdGUgY2xpY2sgZm9yIG1vYmlsZSBkZXZpY2VzCiAgICAgICAgICBpZihpc1RvdWNoKSB7CiAgICAgICAgICAgIHZhciB0YXJnZXRFbCA9IGFuZ3VsYXIuZWxlbWVudChldnQudGFyZ2V0KTsKICAgICAgICAgICAgaWYodGFyZ2V0RWxbMF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gJ2J1dHRvbicpIHsKICAgICAgICAgICAgICB0YXJnZXRFbCA9IHRhcmdldEVsLnBhcmVudCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRhcmdldEVsLnRyaWdnZXJIYW5kbGVyKCdjbGljaycpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgICR0aW1lcGlja2VyLiRvbktleURvd24gPSBmdW5jdGlvbihldnQpIHsKICAgICAgICAgIGlmICghLygzOHwzN3wzOXw0MHwxMykvLnRlc3QoZXZ0LmtleUNvZGUpIHx8IGV2dC5zaGlmdEtleSB8fCBldnQuYWx0S2V5KSByZXR1cm47CiAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKCiAgICAgICAgICAvLyBDbG9zZSBvbiBlbnRlcgogICAgICAgICAgaWYoZXZ0LmtleUNvZGUgPT09IDEzKSByZXR1cm4gJHRpbWVwaWNrZXIuaGlkZSh0cnVlKTsKCiAgICAgICAgICAvLyBOYXZpZ2F0ZSB3aXRoIGtleWJvYXJkCiAgICAgICAgICB2YXIgbmV3RGF0ZSA9IG5ldyBEYXRlKCR0aW1lcGlja2VyLiRkYXRlKTsKICAgICAgICAgIHZhciBob3VycyA9IG5ld0RhdGUuZ2V0SG91cnMoKSwgaG91cnNMZW5ndGggPSBkYXRlRmlsdGVyKG5ld0RhdGUsICdoJykubGVuZ3RoOwogICAgICAgICAgdmFyIG1pbnV0ZXMgPSBuZXdEYXRlLmdldE1pbnV0ZXMoKSwgbWludXRlc0xlbmd0aCA9IGRhdGVGaWx0ZXIobmV3RGF0ZSwgJ21tJykubGVuZ3RoOwogICAgICAgICAgdmFyIGxhdGVyYWxNb3ZlID0gLygzN3wzOSkvLnRlc3QoZXZ0LmtleUNvZGUpOwogICAgICAgICAgdmFyIGNvdW50ID0gMiArICEhZm9ybWF0c1szXSAqIDE7CgogICAgICAgICAgLy8gTmF2aWdhdGUgaW5kZXhlcyAobGVmdCwgcmlnaHQpCiAgICAgICAgICBpZiAobGF0ZXJhbE1vdmUpIHsKICAgICAgICAgICAgaWYoZXZ0LmtleUNvZGUgPT09IDM3KSBzZWxlY3RlZEluZGV4ID0gc2VsZWN0ZWRJbmRleCA8IDEgPyBjb3VudCAtIDEgOiBzZWxlY3RlZEluZGV4IC0gMTsKICAgICAgICAgICAgZWxzZSBpZihldnQua2V5Q29kZSA9PT0gMzkpIHNlbGVjdGVkSW5kZXggPSBzZWxlY3RlZEluZGV4IDwgY291bnQgLSAxID8gc2VsZWN0ZWRJbmRleCArIDEgOiAwOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFVwZGF0ZSB2YWx1ZXMgKHVwLCBkb3duKQogICAgICAgICAgdmFyIHNlbGVjdFJhbmdlID0gWzAsIGhvdXJzTGVuZ3RoXTsKICAgICAgICAgIGlmKHNlbGVjdGVkSW5kZXggPT09IDApIHsKICAgICAgICAgICAgaWYoZXZ0LmtleUNvZGUgPT09IDM4KSBuZXdEYXRlLnNldEhvdXJzKGhvdXJzIC0gcGFyc2VJbnQob3B0aW9ucy5ob3VyU3RlcCwgMTApKTsKICAgICAgICAgICAgZWxzZSBpZihldnQua2V5Q29kZSA9PT0gNDApIG5ld0RhdGUuc2V0SG91cnMoaG91cnMgKyBwYXJzZUludChvcHRpb25zLmhvdXJTdGVwLCAxMCkpOwogICAgICAgICAgICBzZWxlY3RSYW5nZSA9IFswLCBob3Vyc0xlbmd0aF07CiAgICAgICAgICB9IGVsc2UgaWYoc2VsZWN0ZWRJbmRleCA9PT0gMSkgewogICAgICAgICAgICBpZihldnQua2V5Q29kZSA9PT0gMzgpIG5ld0RhdGUuc2V0TWludXRlcyhtaW51dGVzIC0gcGFyc2VJbnQob3B0aW9ucy5taW51dGVTdGVwLCAxMCkpOwogICAgICAgICAgICBlbHNlIGlmKGV2dC5rZXlDb2RlID09PSA0MCkgbmV3RGF0ZS5zZXRNaW51dGVzKG1pbnV0ZXMgKyBwYXJzZUludChvcHRpb25zLm1pbnV0ZVN0ZXAsIDEwKSk7CiAgICAgICAgICAgIHNlbGVjdFJhbmdlID0gW2hvdXJzTGVuZ3RoICsgMSwgaG91cnNMZW5ndGggKyAxICsgbWludXRlc0xlbmd0aF07CiAgICAgICAgICB9IGVsc2UgaWYoc2VsZWN0ZWRJbmRleCA9PT0gMikgewogICAgICAgICAgICBpZighbGF0ZXJhbE1vdmUpICR0aW1lcGlja2VyLnN3aXRjaE1lcmlkaWFuKCk7CiAgICAgICAgICAgIHNlbGVjdFJhbmdlID0gW2hvdXJzTGVuZ3RoICsgMSArIG1pbnV0ZXNMZW5ndGggKyAxLCBob3Vyc0xlbmd0aCArIDEgKyBtaW51dGVzTGVuZ3RoICsgM107CiAgICAgICAgICB9CiAgICAgICAgICAkdGltZXBpY2tlci5zZWxlY3QobmV3RGF0ZSwgc2VsZWN0ZWRJbmRleCwgdHJ1ZSk7CiAgICAgICAgICBjcmVhdGVTZWxlY3Rpb24oc2VsZWN0UmFuZ2VbMF0sIHNlbGVjdFJhbmdlWzFdKTsKICAgICAgICAgIHBhcmVudFNjb3BlLiRkaWdlc3QoKTsKICAgICAgICB9OwoKICAgICAgICAvLyBQcml2YXRlCgogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNlbGVjdGlvbihzdGFydCwgZW5kKSB7CiAgICAgICAgICBpZihlbGVtZW50WzBdLmNyZWF0ZVRleHRSYW5nZSkgewogICAgICAgICAgICB2YXIgc2VsUmFuZ2UgPSBlbGVtZW50WzBdLmNyZWF0ZVRleHRSYW5nZSgpOwogICAgICAgICAgICBzZWxSYW5nZS5jb2xsYXBzZSh0cnVlKTsKICAgICAgICAgICAgc2VsUmFuZ2UubW92ZVN0YXJ0KCdjaGFyYWN0ZXInLCBzdGFydCk7CiAgICAgICAgICAgIHNlbFJhbmdlLm1vdmVFbmQoJ2NoYXJhY3RlcicsIGVuZCk7CiAgICAgICAgICAgIHNlbFJhbmdlLnNlbGVjdCgpOwogICAgICAgICAgfSBlbHNlIGlmKGVsZW1lbnRbMF0uc2V0U2VsZWN0aW9uUmFuZ2UpIHsKICAgICAgICAgICAgZWxlbWVudFswXS5zZXRTZWxlY3Rpb25SYW5nZShzdGFydCwgZW5kKTsKICAgICAgICAgIH0gZWxzZSBpZihhbmd1bGFyLmlzVW5kZWZpbmVkKGVsZW1lbnRbMF0uc2VsZWN0aW9uU3RhcnQpKSB7CiAgICAgICAgICAgIGVsZW1lbnRbMF0uc2VsZWN0aW9uU3RhcnQgPSBzdGFydDsKICAgICAgICAgICAgZWxlbWVudFswXS5zZWxlY3Rpb25FbmQgPSBlbmQ7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmb2N1c0VsZW1lbnQoKSB7CiAgICAgICAgICBlbGVtZW50WzBdLmZvY3VzKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBPdmVycmlkZXMKCiAgICAgICAgdmFyIF9pbml0ID0gJHRpbWVwaWNrZXIuaW5pdDsKICAgICAgICAkdGltZXBpY2tlci5pbml0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZihpc05hdGl2ZSAmJiBvcHRpb25zLnVzZU5hdGl2ZSkgewogICAgICAgICAgICBlbGVtZW50LnByb3AoJ3R5cGUnLCAndGltZScpOwogICAgICAgICAgICBlbGVtZW50LmNzcygnLXdlYmtpdC1hcHBlYXJhbmNlJywgJ3RleHRmaWVsZCcpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9IGVsc2UgaWYoaXNUb3VjaCkgewogICAgICAgICAgICBlbGVtZW50LnByb3AoJ3R5cGUnLCAndGV4dCcpOwogICAgICAgICAgICBlbGVtZW50LmF0dHIoJ3JlYWRvbmx5JywgJ3RydWUnKTsKICAgICAgICAgICAgZWxlbWVudC5vbignY2xpY2snLCBmb2N1c0VsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgX2luaXQoKTsKICAgICAgICB9OwoKICAgICAgICB2YXIgX2Rlc3Ryb3kgPSAkdGltZXBpY2tlci5kZXN0cm95OwogICAgICAgICR0aW1lcGlja2VyLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmKGlzTmF0aXZlICYmIG9wdGlvbnMudXNlTmF0aXZlKSB7CiAgICAgICAgICAgIGVsZW1lbnQub2ZmKCdjbGljaycsIGZvY3VzRWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICBfZGVzdHJveSgpOwogICAgICAgIH07CgogICAgICAgIHZhciBfc2hvdyA9ICR0aW1lcGlja2VyLnNob3c7CiAgICAgICAgJHRpbWVwaWNrZXIuc2hvdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgX3Nob3coKTsKICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICR0aW1lcGlja2VyLiRlbGVtZW50Lm9uKGlzVG91Y2ggPyAndG91Y2hzdGFydCcgOiAnbW91c2Vkb3duJywgJHRpbWVwaWNrZXIuJG9uTW91c2VEb3duKTsKICAgICAgICAgICAgaWYob3B0aW9ucy5rZXlib2FyZCkgewogICAgICAgICAgICAgIGVsZW1lbnQub24oJ2tleWRvd24nLCAkdGltZXBpY2tlci4kb25LZXlEb3duKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIF9oaWRlID0gJHRpbWVwaWNrZXIuaGlkZTsKICAgICAgICAkdGltZXBpY2tlci5oaWRlID0gZnVuY3Rpb24oYmx1cikgewogICAgICAgICAgaWYoISR0aW1lcGlja2VyLiRpc1Nob3duKSByZXR1cm47CiAgICAgICAgICAkdGltZXBpY2tlci4kZWxlbWVudC5vZmYoaXNUb3VjaCA/ICd0b3VjaHN0YXJ0JyA6ICdtb3VzZWRvd24nLCAkdGltZXBpY2tlci4kb25Nb3VzZURvd24pOwogICAgICAgICAgaWYob3B0aW9ucy5rZXlib2FyZCkgewogICAgICAgICAgICBlbGVtZW50Lm9mZigna2V5ZG93bicsICR0aW1lcGlja2VyLiRvbktleURvd24pOwogICAgICAgICAgfQogICAgICAgICAgX2hpZGUoYmx1cik7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuICR0aW1lcGlja2VyOwoKICAgICAgfQoKICAgICAgdGltZXBpY2tlckZhY3RvcnkuZGVmYXVsdHMgPSBkZWZhdWx0czsKICAgICAgcmV0dXJuIHRpbWVwaWNrZXJGYWN0b3J5OwoKICAgIH1dOwoKICB9KQoKCiAgLmRpcmVjdGl2ZSgnYnNUaW1lcGlja2VyJywgWyIkd2luZG93IiwgIiRwYXJzZSIsICIkcSIsICIkbG9jYWxlIiwgImRhdGVGaWx0ZXIiLCAiJHRpbWVwaWNrZXIiLCAiJGRhdGVQYXJzZXIiLCAiJHRpbWVvdXQiLCBmdW5jdGlvbigkd2luZG93LCAkcGFyc2UsICRxLCAkbG9jYWxlLCBkYXRlRmlsdGVyLCAkdGltZXBpY2tlciwgJGRhdGVQYXJzZXIsICR0aW1lb3V0KSB7CgogICAgdmFyIGRlZmF1bHRzID0gJHRpbWVwaWNrZXIuZGVmYXVsdHM7CiAgICB2YXIgaXNOYXRpdmUgPSAvKGlwKGF8bylkfGlwaG9uZXxhbmRyb2lkKS9pZy50ZXN0KCR3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudCk7CiAgICB2YXIgcmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gJHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgJHdpbmRvdy5zZXRUaW1lb3V0OwoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRUFDJywKICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgICBsaW5rOiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgZWxlbWVudCwgYXR0ciwgY29udHJvbGxlcikgewoKICAgICAgICAvLyBEaXJlY3RpdmUgb3B0aW9ucwogICAgICAgIHZhciBvcHRpb25zID0ge3Njb3BlOiBzY29wZSwgY29udHJvbGxlcjogY29udHJvbGxlcn07CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsncGxhY2VtZW50JywgJ2NvbnRhaW5lcicsICdkZWxheScsICd0cmlnZ2VyJywgJ2tleWJvYXJkJywgJ2h0bWwnLCAnYW5pbWF0aW9uJywgJ3RlbXBsYXRlJywgJ2F1dG9jbG9zZScsICd0aW1lVHlwZScsICd0aW1lRm9ybWF0JywgJ21vZGVsVGltZUZvcm1hdCcsICd1c2VOYXRpdmUnLCAnaG91clN0ZXAnLCAnbWludXRlU3RlcCcsICdsZW5ndGgnLCAnYXJyb3dCZWhhdmlvcicsICdpY29uVXAnLCAnaWNvbkRvd24nXSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzRGVmaW5lZChhdHRyW2tleV0pKSBvcHRpb25zW2tleV0gPSBhdHRyW2tleV07CiAgICAgICAgfSk7CgogICAgICAgIC8vIFZpc2liaWxpdHkgYmluZGluZyBzdXBwb3J0CiAgICAgICAgYXR0ci5ic1Nob3cgJiYgc2NvcGUuJHdhdGNoKGF0dHIuYnNTaG93LCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgIGlmKCF0aW1lcGlja2VyIHx8ICFhbmd1bGFyLmlzRGVmaW5lZChuZXdWYWx1ZSkpIHJldHVybjsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNTdHJpbmcobmV3VmFsdWUpKSBuZXdWYWx1ZSA9ICEhbmV3VmFsdWUubWF0Y2goL3RydWV8LD8odGltZXBpY2tlciksPy9pKTsKICAgICAgICAgIG5ld1ZhbHVlID09PSB0cnVlID8gdGltZXBpY2tlci5zaG93KCkgOiB0aW1lcGlja2VyLmhpZGUoKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSB0aW1lcGlja2VyCiAgICAgICAgaWYoaXNOYXRpdmUgJiYgKG9wdGlvbnMudXNlTmF0aXZlIHx8IGRlZmF1bHRzLnVzZU5hdGl2ZSkpIG9wdGlvbnMudGltZUZvcm1hdCA9ICdISDptbSc7CiAgICAgICAgdmFyIHRpbWVwaWNrZXIgPSAkdGltZXBpY2tlcihlbGVtZW50LCBjb250cm9sbGVyLCBvcHRpb25zKTsKICAgICAgICBvcHRpb25zID0gdGltZXBpY2tlci4kb3B0aW9uczsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSBwYXJzZXIKICAgICAgICB2YXIgZGF0ZVBhcnNlciA9ICRkYXRlUGFyc2VyKHtmb3JtYXQ6IG9wdGlvbnMudGltZUZvcm1hdCwgbGFuZzogb3B0aW9ucy5sYW5nfSk7CgogICAgICAgIC8vIE9ic2VydmUgYXR0cmlidXRlcyBmb3IgY2hhbmdlcwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ21pblRpbWUnLCAnbWF4VGltZSddLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2FybignYXR0ci4kb2JzZXJ2ZSglcyknLCBrZXksIGF0dHJba2V5XSk7CiAgICAgICAgICBhbmd1bGFyLmlzRGVmaW5lZChhdHRyW2tleV0pICYmIGF0dHIuJG9ic2VydmUoa2V5LCBmdW5jdGlvbihuZXdWYWx1ZSkgewogICAgICAgICAgICB0aW1lcGlja2VyLiRvcHRpb25zW2tleV0gPSBkYXRlUGFyc2VyLmdldFRpbWVGb3JBdHRyaWJ1dGUoa2V5LCBuZXdWYWx1ZSk7CiAgICAgICAgICAgICFpc05hTih0aW1lcGlja2VyLiRvcHRpb25zW2tleV0pICYmIHRpbWVwaWNrZXIuJGJ1aWxkKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gV2F0Y2ggbW9kZWwgZm9yIGNoYW5nZXMKICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ01vZGVsLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2Fybignc2NvcGUuJHdhdGNoKCVzKScsIGF0dHIubmdNb2RlbCwgbmV3VmFsdWUsIG9sZFZhbHVlLCBjb250cm9sbGVyLiRkYXRlVmFsdWUpOwogICAgICAgICAgdGltZXBpY2tlci51cGRhdGUoY29udHJvbGxlci4kZGF0ZVZhbHVlKTsKICAgICAgICB9LCB0cnVlKTsKCiAgICAgICAgLy8gdmlld1ZhbHVlIC0+ICRwYXJzZXJzIC0+IG1vZGVsVmFsdWUKICAgICAgICBjb250cm9sbGVyLiRwYXJzZXJzLnVuc2hpZnQoZnVuY3Rpb24odmlld1ZhbHVlKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRwYXJzZXIoIiVzIik6IHZpZXdWYWx1ZT0lbycsIGVsZW1lbnQuYXR0cignbmctbW9kZWwnKSwgdmlld1ZhbHVlKTsKICAgICAgICAgIC8vIE51bGwgdmFsdWVzIHNob3VsZCBjb3JyZWN0bHkgcmVzZXQgdGhlIG1vZGVsIHZhbHVlICYgdmFsaWRpdHkKICAgICAgICAgIGlmKCF2aWV3VmFsdWUpIHsKICAgICAgICAgICAgY29udHJvbGxlci4kc2V0VmFsaWRpdHkoJ2RhdGUnLCB0cnVlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhcnNlZFRpbWUgPSBhbmd1bGFyLmlzRGF0ZSh2aWV3VmFsdWUpID8gdmlld1ZhbHVlIDogZGF0ZVBhcnNlci5wYXJzZSh2aWV3VmFsdWUsIGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSk7CiAgICAgICAgICBpZighcGFyc2VkVGltZSB8fCBpc05hTihwYXJzZWRUaW1lLmdldFRpbWUoKSkpIHsKICAgICAgICAgICAgY29udHJvbGxlci4kc2V0VmFsaWRpdHkoJ2RhdGUnLCBmYWxzZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGlzTWluVmFsaWQgPSBpc05hTihvcHRpb25zLm1pblRpbWUpIHx8IHBhcnNlZFRpbWUuZ2V0VGltZSgpID49IG9wdGlvbnMubWluVGltZTsKICAgICAgICAgICAgICB2YXIgaXNNYXhWYWxpZCA9IGlzTmFOKG9wdGlvbnMubWF4VGltZSkgfHwgcGFyc2VkVGltZS5nZXRUaW1lKCkgPD0gb3B0aW9ucy5tYXhUaW1lOwogICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gaXNNaW5WYWxpZCAmJiBpc01heFZhbGlkOwogICAgICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZhbGlkaXR5KCdkYXRlJywgaXNWYWxpZCk7CiAgICAgICAgICAgICAgY29udHJvbGxlci4kc2V0VmFsaWRpdHkoJ21pbicsIGlzTWluVmFsaWQpOwogICAgICAgICAgICAgIGNvbnRyb2xsZXIuJHNldFZhbGlkaXR5KCdtYXgnLCBpc01heFZhbGlkKTsKICAgICAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSB0aGUgbW9kZWwgd2hlbiB3ZSBoYXZlIGEgdmFsaWQgZGF0ZQogICAgICAgICAgICAgIGlmKCFpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29udHJvbGxlci4kZGF0ZVZhbHVlID0gcGFyc2VkVGltZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmKG9wdGlvbnMudGltZVR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHJldHVybiBkYXRlRmlsdGVyKHBhcnNlZFRpbWUsIG9wdGlvbnMubW9kZWxUaW1lRm9ybWF0IHx8IG9wdGlvbnMudGltZUZvcm1hdCk7CiAgICAgICAgICB9IGVsc2UgaWYob3B0aW9ucy50aW1lVHlwZSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRyb2xsZXIuJGRhdGVWYWx1ZS5nZXRUaW1lKCk7CiAgICAgICAgICB9IGVsc2UgaWYob3B0aW9ucy50aW1lVHlwZSA9PT0gJ2lzbycpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRyb2xsZXIuJGRhdGVWYWx1ZS50b0lTT1N0cmluZygpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIC8vIG1vZGVsVmFsdWUgLT4gJGZvcm1hdHRlcnMgLT4gdmlld1ZhbHVlCiAgICAgICAgY29udHJvbGxlci4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uKG1vZGVsVmFsdWUpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2FybignJGZvcm1hdHRlcigiJXMiKTogbW9kZWxWYWx1ZT0lbyAoJW8pJywgZWxlbWVudC5hdHRyKCduZy1tb2RlbCcpLCBtb2RlbFZhbHVlLCB0eXBlb2YgbW9kZWxWYWx1ZSk7CiAgICAgICAgICB2YXIgZGF0ZTsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNVbmRlZmluZWQobW9kZWxWYWx1ZSkgfHwgbW9kZWxWYWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBkYXRlID0gTmFOOwogICAgICAgICAgfSBlbHNlIGlmKGFuZ3VsYXIuaXNEYXRlKG1vZGVsVmFsdWUpKSB7CiAgICAgICAgICAgIGRhdGUgPSBtb2RlbFZhbHVlOwogICAgICAgICAgfSBlbHNlIGlmKG9wdGlvbnMudGltZVR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGRhdGUgPSBkYXRlUGFyc2VyLnBhcnNlKG1vZGVsVmFsdWUsIG51bGwsIG9wdGlvbnMubW9kZWxUaW1lRm9ybWF0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRhdGUgPSBuZXcgRGF0ZShtb2RlbFZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFNldHVwIGRlZmF1bHQgdmFsdWU/CiAgICAgICAgICAvLyBpZihpc05hTihkYXRlLmdldFRpbWUoKSkpIGRhdGUgPSBuZXcgRGF0ZShuZXcgRGF0ZSgpLnNldE1pbnV0ZXMoMCkgKyAzNmU1KTsKICAgICAgICAgIGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSA9IGRhdGU7CiAgICAgICAgICByZXR1cm4gY29udHJvbGxlci4kZGF0ZVZhbHVlOwogICAgICAgIH0pOwoKICAgICAgICAvLyB2aWV3VmFsdWUgLT4gZWxlbWVudAogICAgICAgIGNvbnRyb2xsZXIuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gY29uc29sZS53YXJuKCckcmVuZGVyKCIlcyIpOiB2aWV3VmFsdWU9JW8nLCBlbGVtZW50LmF0dHIoJ25nLW1vZGVsJyksIGNvbnRyb2xsZXIuJHZpZXdWYWx1ZSk7CiAgICAgICAgICBlbGVtZW50LnZhbCghY29udHJvbGxlci4kZGF0ZVZhbHVlIHx8IGlzTmFOKGNvbnRyb2xsZXIuJGRhdGVWYWx1ZS5nZXRUaW1lKCkpID8gJycgOiBkYXRlRmlsdGVyKGNvbnRyb2xsZXIuJGRhdGVWYWx1ZSwgb3B0aW9ucy50aW1lRm9ybWF0KSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gR2FyYmFnZSBjb2xsZWN0aW9uCiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHRpbWVwaWNrZXIpIHRpbWVwaWNrZXIuZGVzdHJveSgpOwogICAgICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICAgICAgICB0aW1lcGlja2VyID0gbnVsbDsKICAgICAgICB9KTsKCiAgICAgIH0KICAgIH07CgogIH1dKTsKCi8vIFNvdXJjZTogdG9vbHRpcC5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAudG9vbHRpcCcsIFsnbWdjcmVhLm5nU3RyYXAuaGVscGVycy5kaW1lbnNpb25zJ10pCgogIC5wcm92aWRlcignJHRvb2x0aXAnLCBmdW5jdGlvbigpIHsKCiAgICB2YXIgZGVmYXVsdHMgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICBhbmltYXRpb246ICdhbS1mYWRlJywKICAgICAgY3VzdG9tQ2xhc3M6ICcnLAogICAgICBwcmVmaXhDbGFzczogJ3Rvb2x0aXAnLAogICAgICBwcmVmaXhFdmVudDogJ3Rvb2x0aXAnLAogICAgICBjb250YWluZXI6IGZhbHNlLAogICAgICB0YXJnZXQ6IGZhbHNlLAogICAgICBwbGFjZW1lbnQ6ICd0b3AnLAogICAgICB0ZW1wbGF0ZTogJ3Rvb2x0aXAvdG9vbHRpcC50cGwuaHRtbCcsCiAgICAgIGNvbnRlbnRUZW1wbGF0ZTogZmFsc2UsCiAgICAgIHRyaWdnZXI6ICdob3ZlciBmb2N1cycsCiAgICAgIGtleWJvYXJkOiBmYWxzZSwKICAgICAgaHRtbDogZmFsc2UsCiAgICAgIHNob3c6IGZhbHNlLAogICAgICB0aXRsZTogJycsCiAgICAgIHR5cGU6ICcnLAogICAgICBkZWxheTogMAogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBbIiR3aW5kb3ciLCAiJHJvb3RTY29wZSIsICIkY29tcGlsZSIsICIkcSIsICIkdGVtcGxhdGVDYWNoZSIsICIkaHR0cCIsICIkYW5pbWF0ZSIsICJkaW1lbnNpb25zIiwgIiQkckFGIiwgZnVuY3Rpb24oJHdpbmRvdywgJHJvb3RTY29wZSwgJGNvbXBpbGUsICRxLCAkdGVtcGxhdGVDYWNoZSwgJGh0dHAsICRhbmltYXRlLCBkaW1lbnNpb25zLCAkJHJBRikgewoKICAgICAgdmFyIHRyaW0gPSBTdHJpbmcucHJvdG90eXBlLnRyaW07CiAgICAgIHZhciBpc1RvdWNoID0gJ2NyZWF0ZVRvdWNoJyBpbiAkd2luZG93LmRvY3VtZW50OwogICAgICB2YXIgaHRtbFJlcGxhY2VSZWdFeHAgPSAvbmctYmluZD0iL2lnOwoKICAgICAgZnVuY3Rpb24gVG9vbHRpcEZhY3RvcnkoZWxlbWVudCwgY29uZmlnKSB7CgogICAgICAgIHZhciAkdG9vbHRpcCA9IHt9OwoKICAgICAgICAvLyBDb21tb24gdmFycwogICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW1lbnRbMF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICB2YXIgb3B0aW9ucyA9ICR0b29sdGlwLiRvcHRpb25zID0gYW5ndWxhci5leHRlbmQoe30sIGRlZmF1bHRzLCBjb25maWcpOwogICAgICAgICR0b29sdGlwLiRwcm9taXNlID0gZmV0Y2hUZW1wbGF0ZShvcHRpb25zLnRlbXBsYXRlKTsKICAgICAgICB2YXIgc2NvcGUgPSAkdG9vbHRpcC4kc2NvcGUgPSBvcHRpb25zLnNjb3BlICYmIG9wdGlvbnMuc2NvcGUuJG5ldygpIHx8ICRyb290U2NvcGUuJG5ldygpOwogICAgICAgIGlmKG9wdGlvbnMuZGVsYXkgJiYgYW5ndWxhci5pc1N0cmluZyhvcHRpb25zLmRlbGF5KSkgewogICAgICAgICAgdmFyIHNwbGl0ID0gb3B0aW9ucy5kZWxheS5zcGxpdCgnLCcpLm1hcChwYXJzZUZsb2F0KTsKICAgICAgICAgIG9wdGlvbnMuZGVsYXkgPSBzcGxpdC5sZW5ndGggPiAxID8ge3Nob3c6IHNwbGl0WzBdLCBoaWRlOiBzcGxpdFsxXX0gOiBzcGxpdFswXTsKICAgICAgICB9CgogICAgICAgIC8vIFN1cHBvcnQgc2NvcGUgYXMgc3RyaW5nIG9wdGlvbnMKICAgICAgICBpZihvcHRpb25zLnRpdGxlKSB7CiAgICAgICAgICAkdG9vbHRpcC4kc2NvcGUudGl0bGUgPSBvcHRpb25zLnRpdGxlOwogICAgICAgIH0KCiAgICAgICAgLy8gUHJvdmlkZSBzY29wZSBoZWxwZXJzCiAgICAgICAgc2NvcGUuJGhpZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHRvb2x0aXAuaGlkZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICBzY29wZS4kc2hvdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkdG9vbHRpcC5zaG93KCk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIHNjb3BlLiR0b2dnbGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHRvb2x0aXAudG9nZ2xlKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgICR0b29sdGlwLiRpc1Nob3duID0gc2NvcGUuJGlzU2hvd24gPSBmYWxzZTsKCiAgICAgICAgLy8gUHJpdmF0ZSB2YXJzCiAgICAgICAgdmFyIHRpbWVvdXQsIGhvdmVyU3RhdGU7CgogICAgICAgIC8vIFN1cHBvcnQgY29udGVudFRlbXBsYXRlIG9wdGlvbgogICAgICAgIGlmKG9wdGlvbnMuY29udGVudFRlbXBsYXRlKSB7CiAgICAgICAgICAkdG9vbHRpcC4kcHJvbWlzZSA9ICR0b29sdGlwLiRwcm9taXNlLnRoZW4oZnVuY3Rpb24odGVtcGxhdGUpIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlRWwgPSBhbmd1bGFyLmVsZW1lbnQodGVtcGxhdGUpOwogICAgICAgICAgICByZXR1cm4gZmV0Y2hUZW1wbGF0ZShvcHRpb25zLmNvbnRlbnRUZW1wbGF0ZSkKICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oY29udGVudFRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgdmFyIGNvbnRlbnRFbCA9IGZpbmRFbGVtZW50KCdbbmctYmluZD0iY29udGVudCJdJywgdGVtcGxhdGVFbFswXSk7CiAgICAgICAgICAgICAgaWYoIWNvbnRlbnRFbC5sZW5ndGgpIGNvbnRlbnRFbCA9IGZpbmRFbGVtZW50KCdbbmctYmluZD0idGl0bGUiXScsIHRlbXBsYXRlRWxbMF0pOwogICAgICAgICAgICAgIGNvbnRlbnRFbC5yZW1vdmVBdHRyKCduZy1iaW5kJykuaHRtbChjb250ZW50VGVtcGxhdGUpOwogICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZUVsWzBdLm91dGVySFRNTDsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEZldGNoLCBjb21waWxlIHRoZW4gaW5pdGlhbGl6ZSB0b29sdGlwCiAgICAgICAgdmFyIHRpcExpbmtlciwgdGlwRWxlbWVudCwgdGlwVGVtcGxhdGUsIHRpcENvbnRhaW5lcjsKICAgICAgICAkdG9vbHRpcC4kcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHRlbXBsYXRlKSB7CiAgICAgICAgICBpZihhbmd1bGFyLmlzT2JqZWN0KHRlbXBsYXRlKSkgdGVtcGxhdGUgPSB0ZW1wbGF0ZS5kYXRhOwogICAgICAgICAgaWYob3B0aW9ucy5odG1sKSB0ZW1wbGF0ZSA9IHRlbXBsYXRlLnJlcGxhY2UoaHRtbFJlcGxhY2VSZWdFeHAsICduZy1iaW5kLWh0bWw9IicpOwogICAgICAgICAgdGVtcGxhdGUgPSB0cmltLmFwcGx5KHRlbXBsYXRlKTsKICAgICAgICAgIHRpcFRlbXBsYXRlID0gdGVtcGxhdGU7CiAgICAgICAgICB0aXBMaW5rZXIgPSAkY29tcGlsZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAkdG9vbHRpcC5pbml0KCk7CiAgICAgICAgfSk7CgogICAgICAgICR0b29sdGlwLmluaXQgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAvLyBPcHRpb25zOiBkZWxheQogICAgICAgICAgaWYgKG9wdGlvbnMuZGVsYXkgJiYgYW5ndWxhci5pc051bWJlcihvcHRpb25zLmRlbGF5KSkgewogICAgICAgICAgICBvcHRpb25zLmRlbGF5ID0gewogICAgICAgICAgICAgIHNob3c6IG9wdGlvbnMuZGVsYXksCiAgICAgICAgICAgICAgaGlkZTogb3B0aW9ucy5kZWxheQogICAgICAgICAgICB9OwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFJlcGxhY2UgdHJpZ2dlciBvbiB0b3VjaCBkZXZpY2VzID8KICAgICAgICAgIC8vIGlmKGlzVG91Y2ggJiYgb3B0aW9ucy50cmlnZ2VyID09PSBkZWZhdWx0cy50cmlnZ2VyKSB7CiAgICAgICAgICAvLyAgIG9wdGlvbnMudHJpZ2dlci5yZXBsYWNlKC9ob3Zlci9nLCAnY2xpY2snKTsKICAgICAgICAgIC8vIH0KCiAgICAgICAgICAvLyBPcHRpb25zIDogY29udGFpbmVyCiAgICAgICAgICBpZihvcHRpb25zLmNvbnRhaW5lciA9PT0gJ3NlbGYnKSB7CiAgICAgICAgICAgIHRpcENvbnRhaW5lciA9IGVsZW1lbnQ7CiAgICAgICAgICB9IGVsc2UgaWYoYW5ndWxhci5pc0VsZW1lbnQob3B0aW9ucy5jb250YWluZXIpKSB7CiAgICAgICAgICAgIHRpcENvbnRhaW5lciA9IG9wdGlvbnMuY29udGFpbmVyOwogICAgICAgICAgfSBlbHNlIGlmKG9wdGlvbnMuY29udGFpbmVyKSB7CiAgICAgICAgICAgIHRpcENvbnRhaW5lciA9IGZpbmRFbGVtZW50KG9wdGlvbnMuY29udGFpbmVyKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBPcHRpb25zOiB0cmlnZ2VyCiAgICAgICAgICB2YXIgdHJpZ2dlcnMgPSBvcHRpb25zLnRyaWdnZXIuc3BsaXQoJyAnKTsKICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0cmlnZ2VycywgZnVuY3Rpb24odHJpZ2dlcikgewogICAgICAgICAgICBpZih0cmlnZ2VyID09PSAnY2xpY2snKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5vbignY2xpY2snLCAkdG9vbHRpcC50b2dnbGUpOwogICAgICAgICAgICB9IGVsc2UgaWYodHJpZ2dlciAhPT0gJ21hbnVhbCcpIHsKICAgICAgICAgICAgICBlbGVtZW50Lm9uKHRyaWdnZXIgPT09ICdob3ZlcicgPyAnbW91c2VlbnRlcicgOiAnZm9jdXMnLCAkdG9vbHRpcC5lbnRlcik7CiAgICAgICAgICAgICAgZWxlbWVudC5vbih0cmlnZ2VyID09PSAnaG92ZXInID8gJ21vdXNlbGVhdmUnIDogJ2JsdXInLCAkdG9vbHRpcC5sZWF2ZSk7CiAgICAgICAgICAgICAgbm9kZU5hbWUgPT09ICdidXR0b24nICYmIHRyaWdnZXIgIT09ICdob3ZlcicgJiYgZWxlbWVudC5vbihpc1RvdWNoID8gJ3RvdWNoc3RhcnQnIDogJ21vdXNlZG93bicsICR0b29sdGlwLiRvbkZvY3VzRWxlbWVudE1vdXNlRG93bik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIE9wdGlvbnM6IHRhcmdldAogICAgICAgICAgaWYob3B0aW9ucy50YXJnZXQpIHsKICAgICAgICAgICAgb3B0aW9ucy50YXJnZXQgPSBhbmd1bGFyLmlzRWxlbWVudChvcHRpb25zLnRhcmdldCkgPyBvcHRpb25zLnRhcmdldCA6IGZpbmRFbGVtZW50KG9wdGlvbnMudGFyZ2V0KTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBPcHRpb25zOiBzaG93CiAgICAgICAgICBpZihvcHRpb25zLnNob3cpIHsKICAgICAgICAgICAgc2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIG9wdGlvbnMudHJpZ2dlciA9PT0gJ2ZvY3VzJyA/IGVsZW1lbnRbMF0uZm9jdXMoKSA6ICR0b29sdGlwLnNob3coKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgIH07CgogICAgICAgICR0b29sdGlwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAvLyBVbmJpbmQgZXZlbnRzCiAgICAgICAgICB2YXIgdHJpZ2dlcnMgPSBvcHRpb25zLnRyaWdnZXIuc3BsaXQoJyAnKTsKICAgICAgICAgIGZvciAodmFyIGkgPSB0cmlnZ2Vycy5sZW5ndGg7IGktLTspIHsKICAgICAgICAgICAgdmFyIHRyaWdnZXIgPSB0cmlnZ2Vyc1tpXTsKICAgICAgICAgICAgaWYodHJpZ2dlciA9PT0gJ2NsaWNrJykgewogICAgICAgICAgICAgIGVsZW1lbnQub2ZmKCdjbGljaycsICR0b29sdGlwLnRvZ2dsZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZih0cmlnZ2VyICE9PSAnbWFudWFsJykgewogICAgICAgICAgICAgIGVsZW1lbnQub2ZmKHRyaWdnZXIgPT09ICdob3ZlcicgPyAnbW91c2VlbnRlcicgOiAnZm9jdXMnLCAkdG9vbHRpcC5lbnRlcik7CiAgICAgICAgICAgICAgZWxlbWVudC5vZmYodHJpZ2dlciA9PT0gJ2hvdmVyJyA/ICdtb3VzZWxlYXZlJyA6ICdibHVyJywgJHRvb2x0aXAubGVhdmUpOwogICAgICAgICAgICAgIG5vZGVOYW1lID09PSAnYnV0dG9uJyAmJiB0cmlnZ2VyICE9PSAnaG92ZXInICYmIGVsZW1lbnQub2ZmKGlzVG91Y2ggPyAndG91Y2hzdGFydCcgOiAnbW91c2Vkb3duJywgJHRvb2x0aXAuJG9uRm9jdXNFbGVtZW50TW91c2VEb3duKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIFJlbW92ZSBlbGVtZW50CiAgICAgICAgICBpZih0aXBFbGVtZW50KSB7CiAgICAgICAgICAgIHRpcEVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgIHRpcEVsZW1lbnQgPSBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIENhbmNlbCBwZW5kaW5nIGNhbGxiYWNrcwogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwoKICAgICAgICAgIC8vIERlc3Ryb3kgc2NvcGUKICAgICAgICAgIHNjb3BlLiRkZXN0cm95KCk7CgogICAgICAgIH07CgogICAgICAgICR0b29sdGlwLmVudGVyID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgICAgaG92ZXJTdGF0ZSA9ICdpbic7CiAgICAgICAgICBpZiAoIW9wdGlvbnMuZGVsYXkgfHwgIW9wdGlvbnMuZGVsYXkuc2hvdykgewogICAgICAgICAgICByZXR1cm4gJHRvb2x0aXAuc2hvdygpOwogICAgICAgICAgfQoKICAgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoaG92ZXJTdGF0ZSA9PT0naW4nKSAkdG9vbHRpcC5zaG93KCk7CiAgICAgICAgICB9LCBvcHRpb25zLmRlbGF5LnNob3cpOwoKICAgICAgICB9OwoKICAgICAgICAkdG9vbHRpcC5zaG93ID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgc2NvcGUuJGVtaXQob3B0aW9ucy5wcmVmaXhFdmVudCArICcuc2hvdy5iZWZvcmUnLCAkdG9vbHRpcCk7CiAgICAgICAgICB2YXIgcGFyZW50ID0gb3B0aW9ucy5jb250YWluZXIgPyB0aXBDb250YWluZXIgOiBudWxsOwogICAgICAgICAgdmFyIGFmdGVyID0gb3B0aW9ucy5jb250YWluZXIgPyBudWxsIDogZWxlbWVudDsKCiAgICAgICAgICAvLyBIaWRlIGFueSBleGlzdGluZyB0aXBFbGVtZW50CiAgICAgICAgICBpZih0aXBFbGVtZW50KSB0aXBFbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgLy8gRmV0Y2ggYSBjbG9uZWQgZWxlbWVudCBsaW5rZWQgZnJvbSB0ZW1wbGF0ZQogICAgICAgICAgdGlwRWxlbWVudCA9ICR0b29sdGlwLiRlbGVtZW50ID0gdGlwTGlua2VyKHNjb3BlLCBmdW5jdGlvbihjbG9uZWRFbGVtZW50LCBzY29wZSkge30pOwoKICAgICAgICAgIC8vIFNldCB0aGUgaW5pdGlhbCBwb3NpdGlvbmluZy4gIE1ha2UgdGhlIHRvb2x0aXAgaW52aXNpYmxlCiAgICAgICAgICAvLyBzbyBJRSBkb2Vzbid0IHRyeSB0byBmb2N1cyBvbiBpdCBvZmYgc2NyZWVuLgogICAgICAgICAgdGlwRWxlbWVudC5jc3Moe3RvcDogJy05OTk5cHgnLCBsZWZ0OiAnLTk5OTlweCcsIGRpc3BsYXk6ICdibG9jaycsIHZpc2liaWxpdHk6ICdoaWRkZW4nfSkuYWRkQ2xhc3Mob3B0aW9ucy5wbGFjZW1lbnQpOwoKICAgICAgICAgIC8vIE9wdGlvbnM6IGFuaW1hdGlvbgogICAgICAgICAgaWYob3B0aW9ucy5hbmltYXRpb24pIHRpcEVsZW1lbnQuYWRkQ2xhc3Mob3B0aW9ucy5hbmltYXRpb24pOwogICAgICAgICAgLy8gT3B0aW9uczogdHlwZQogICAgICAgICAgaWYob3B0aW9ucy50eXBlKSB0aXBFbGVtZW50LmFkZENsYXNzKG9wdGlvbnMucHJlZml4Q2xhc3MgKyAnLScgKyBvcHRpb25zLnR5cGUpOwogICAgICAgICAgLy8gT3B0aW9uczogY3VzdG9tIGNsYXNzZXMKICAgICAgICAgIGlmKG9wdGlvbnMuY3VzdG9tQ2xhc3MpIHRpcEVsZW1lbnQuYWRkQ2xhc3Mob3B0aW9ucy5jdXN0b21DbGFzcyk7CgogICAgICAgICAgLy8gU3VwcG9ydCB2MS4zKyAkYW5pbWF0ZQogICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9jb21taXQvYmYwZjU1MDJiMWJiZmRkYzVjZGQyZjEzOGVmZDkxODhiOGM2NTJhOQogICAgICAgICAgdmFyIHByb21pc2UgPSAkYW5pbWF0ZS5lbnRlcih0aXBFbGVtZW50LCBwYXJlbnQsIGFmdGVyLCBlbnRlckFuaW1hdGVDYWxsYmFjayk7CiAgICAgICAgICBpZihwcm9taXNlICYmIHByb21pc2UudGhlbikgcHJvbWlzZS50aGVuKGVudGVyQW5pbWF0ZUNhbGxiYWNrKTsKCiAgICAgICAgICAkdG9vbHRpcC4kaXNTaG93biA9IHNjb3BlLiRpc1Nob3duID0gdHJ1ZTsKICAgICAgICAgIHNjb3BlLiQkcGhhc2UgfHwgKHNjb3BlLiRyb290ICYmIHNjb3BlLiRyb290LiQkcGhhc2UpIHx8IHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICQkckFGKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgJHRvb2x0aXAuJGFwcGx5UGxhY2VtZW50KCk7CgogICAgICAgICAgICAvLyBPbmNlIHBsYWNlZCwgbWFrZSB0aGUgdG9vbHRpcCB2aXNpYmxlCiAgICAgICAgICAgIHRpcEVsZW1lbnQuY3NzKHt2aXNpYmlsaXR5OiAndmlzaWJsZSd9KTsKICAgICAgICAgIH0pOyAvLyB2YXIgYSA9IGJvZHlFbC5vZmZzZXRXaWR0aCArIDE7ID8KCiAgICAgICAgICAvLyBCaW5kIGV2ZW50cwogICAgICAgICAgaWYob3B0aW9ucy5rZXlib2FyZCkgewogICAgICAgICAgICBpZihvcHRpb25zLnRyaWdnZXIgIT09ICdmb2N1cycpIHsKICAgICAgICAgICAgICAkdG9vbHRpcC5mb2N1cygpOwogICAgICAgICAgICAgIHRpcEVsZW1lbnQub24oJ2tleXVwJywgJHRvb2x0aXAuJG9uS2V5VXApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVsZW1lbnQub24oJ2tleXVwJywgJHRvb2x0aXAuJG9uRm9jdXNLZXlVcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gZW50ZXJBbmltYXRlQ2FsbGJhY2soKSB7CiAgICAgICAgICBzY29wZS4kZW1pdChvcHRpb25zLnByZWZpeEV2ZW50ICsgJy5zaG93JywgJHRvb2x0aXApOwogICAgICAgIH0KCiAgICAgICAgJHRvb2x0aXAubGVhdmUgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgICAgICBob3ZlclN0YXRlID0gJ291dCc7CiAgICAgICAgICBpZiAoIW9wdGlvbnMuZGVsYXkgfHwgIW9wdGlvbnMuZGVsYXkuaGlkZSkgewogICAgICAgICAgICByZXR1cm4gJHRvb2x0aXAuaGlkZSgpOwogICAgICAgICAgfQogICAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoaG92ZXJTdGF0ZSA9PT0gJ291dCcpIHsKICAgICAgICAgICAgICAkdG9vbHRpcC5oaWRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIG9wdGlvbnMuZGVsYXkuaGlkZSk7CgogICAgICAgIH07CgogICAgICAgICR0b29sdGlwLmhpZGUgPSBmdW5jdGlvbihibHVyKSB7CgogICAgICAgICAgaWYoISR0b29sdGlwLiRpc1Nob3duKSByZXR1cm47CiAgICAgICAgICBzY29wZS4kZW1pdChvcHRpb25zLnByZWZpeEV2ZW50ICsgJy5oaWRlLmJlZm9yZScsICR0b29sdGlwKTsKCiAgICAgICAgICAvLyBTdXBwb3J0IHYxLjMrICRhbmltYXRlCiAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2NvbW1pdC9iZjBmNTUwMmIxYmJmZGRjNWNkZDJmMTM4ZWZkOTE4OGI4YzY1MmE5CiAgICAgICAgICB2YXIgcHJvbWlzZSA9ICRhbmltYXRlLmxlYXZlKHRpcEVsZW1lbnQsIGxlYXZlQW5pbWF0ZUNhbGxiYWNrKTsKICAgICAgICAgIGlmKHByb21pc2UgJiYgcHJvbWlzZS50aGVuKSBwcm9taXNlLnRoZW4obGVhdmVBbmltYXRlQ2FsbGJhY2spOwoKICAgICAgICAgICR0b29sdGlwLiRpc1Nob3duID0gc2NvcGUuJGlzU2hvd24gPSBmYWxzZTsKICAgICAgICAgIHNjb3BlLiQkcGhhc2UgfHwgKHNjb3BlLiRyb290ICYmIHNjb3BlLiRyb290LiQkcGhhc2UpIHx8IHNjb3BlLiRkaWdlc3QoKTsKCiAgICAgICAgICAvLyBVbmJpbmQgZXZlbnRzCiAgICAgICAgICBpZihvcHRpb25zLmtleWJvYXJkICYmIHRpcEVsZW1lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgdGlwRWxlbWVudC5vZmYoJ2tleXVwJywgJHRvb2x0aXAuJG9uS2V5VXApOwogICAgICAgICAgfQoKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBsZWF2ZUFuaW1hdGVDYWxsYmFjaygpIHsKICAgICAgICAgIHNjb3BlLiRlbWl0KG9wdGlvbnMucHJlZml4RXZlbnQgKyAnLmhpZGUnLCAkdG9vbHRpcCk7CiAgICAgICAgICAvLyBBbGxvdyB0byBibHVyIHRoZSBpbnB1dCB3aGVuIGhpZGRlbiwgbGlrZSB3aGVuIHByZXNzaW5nIGVudGVyIGtleQogICAgICAgICAgaWYoYmx1ciAmJiBvcHRpb25zLnRyaWdnZXIgPT09ICdmb2N1cycpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnRbMF0uYmx1cigpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgJHRvb2x0aXAudG9nZ2xlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAkdG9vbHRpcC4kaXNTaG93biA/ICR0b29sdGlwLmxlYXZlKCkgOiAkdG9vbHRpcC5lbnRlcigpOwogICAgICAgIH07CgogICAgICAgICR0b29sdGlwLmZvY3VzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aXBFbGVtZW50WzBdLmZvY3VzKCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gUHJvdGVjdGVkIG1ldGhvZHMKCiAgICAgICAgJHRvb2x0aXAuJGFwcGx5UGxhY2VtZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZighdGlwRWxlbWVudCkgcmV0dXJuOwoKICAgICAgICAgIC8vIEdldCB0aGUgcG9zaXRpb24gb2YgdGhlIHRvb2x0aXAgZWxlbWVudC4KICAgICAgICAgIHZhciBlbGVtZW50UG9zaXRpb24gPSBnZXRQb3NpdGlvbigpOwoKICAgICAgICAgIC8vIEdldCB0aGUgaGVpZ2h0IGFuZCB3aWR0aCBvZiB0aGUgdG9vbHRpcCBzbyB3ZSBjYW4gY2VudGVyIGl0LgogICAgICAgICAgdmFyIHRpcFdpZHRoID0gdGlwRWxlbWVudC5wcm9wKCdvZmZzZXRXaWR0aCcpLAogICAgICAgICAgICAgIHRpcEhlaWdodCA9IHRpcEVsZW1lbnQucHJvcCgnb2Zmc2V0SGVpZ2h0Jyk7CgogICAgICAgICAgLy8gR2V0IHRoZSB0b29sdGlwJ3MgdG9wIGFuZCBsZWZ0IGNvb3JkaW5hdGVzIHRvIGNlbnRlciBpdCB3aXRoIHRoaXMgZGlyZWN0aXZlLgogICAgICAgICAgdmFyIHRpcFBvc2l0aW9uID0gZ2V0Q2FsY3VsYXRlZE9mZnNldChvcHRpb25zLnBsYWNlbWVudCwgZWxlbWVudFBvc2l0aW9uLCB0aXBXaWR0aCwgdGlwSGVpZ2h0KTsKCiAgICAgICAgICAvLyBOb3cgc2V0IHRoZSBjYWxjdWxhdGVkIHBvc2l0aW9uaW5nLgogICAgICAgICAgdGlwUG9zaXRpb24udG9wICs9ICdweCc7CiAgICAgICAgICB0aXBQb3NpdGlvbi5sZWZ0ICs9ICdweCc7CiAgICAgICAgICB0aXBFbGVtZW50LmNzcyh0aXBQb3NpdGlvbik7CgogICAgICAgIH07CgogICAgICAgICR0b29sdGlwLiRvbktleVVwID0gZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICBpZiAoZXZ0LndoaWNoID09PSAyNyAmJiAkdG9vbHRpcC4kaXNTaG93bikgewogICAgICAgICAgICAkdG9vbHRpcC5oaWRlKCk7CiAgICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAkdG9vbHRpcC4kb25Gb2N1c0tleVVwID0gZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICBpZiAoZXZ0LndoaWNoID09PSAyNykgewogICAgICAgICAgICBlbGVtZW50WzBdLmJsdXIoKTsKICAgICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgICR0b29sdGlwLiRvbkZvY3VzRWxlbWVudE1vdXNlRG93biA9IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAvLyBTb21lIGJyb3dzZXJzIGRvIG5vdCBhdXRvLWZvY3VzIGJ1dHRvbnMgKGVnLiBTYWZhcmkpCiAgICAgICAgICAkdG9vbHRpcC4kaXNTaG93biA/IGVsZW1lbnRbMF0uYmx1cigpIDogZWxlbWVudFswXS5mb2N1cygpOwogICAgICAgIH07CgogICAgICAgIC8vIFByaXZhdGUgbWV0aG9kcwoKICAgICAgICBmdW5jdGlvbiBnZXRQb3NpdGlvbigpIHsKICAgICAgICAgIGlmKG9wdGlvbnMuY29udGFpbmVyID09PSAnYm9keScpIHsKICAgICAgICAgICAgcmV0dXJuIGRpbWVuc2lvbnMub2Zmc2V0KG9wdGlvbnMudGFyZ2V0WzBdIHx8IGVsZW1lbnRbMF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGRpbWVuc2lvbnMucG9zaXRpb24ob3B0aW9ucy50YXJnZXRbMF0gfHwgZWxlbWVudFswXSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRDYWxjdWxhdGVkT2Zmc2V0KHBsYWNlbWVudCwgcG9zaXRpb24sIGFjdHVhbFdpZHRoLCBhY3R1YWxIZWlnaHQpIHsKICAgICAgICAgIHZhciBvZmZzZXQ7CiAgICAgICAgICB2YXIgc3BsaXQgPSBwbGFjZW1lbnQuc3BsaXQoJy0nKTsKCiAgICAgICAgICBzd2l0Y2ggKHNwbGl0WzBdKSB7CiAgICAgICAgICBjYXNlICdyaWdodCc6CiAgICAgICAgICAgIG9mZnNldCA9IHsKICAgICAgICAgICAgICB0b3A6IHBvc2l0aW9uLnRvcCArIHBvc2l0aW9uLmhlaWdodCAvIDIgLSBhY3R1YWxIZWlnaHQgLyAyLAogICAgICAgICAgICAgIGxlZnQ6IHBvc2l0aW9uLmxlZnQgKyBwb3NpdGlvbi53aWR0aAogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ2JvdHRvbSc6CiAgICAgICAgICAgIG9mZnNldCA9IHsKICAgICAgICAgICAgICB0b3A6IHBvc2l0aW9uLnRvcCArIHBvc2l0aW9uLmhlaWdodCwKICAgICAgICAgICAgICBsZWZ0OiBwb3NpdGlvbi5sZWZ0ICsgcG9zaXRpb24ud2lkdGggLyAyIC0gYWN0dWFsV2lkdGggLyAyCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnbGVmdCc6CiAgICAgICAgICAgIG9mZnNldCA9IHsKICAgICAgICAgICAgICB0b3A6IHBvc2l0aW9uLnRvcCArIHBvc2l0aW9uLmhlaWdodCAvIDIgLSBhY3R1YWxIZWlnaHQgLyAyLAogICAgICAgICAgICAgIGxlZnQ6IHBvc2l0aW9uLmxlZnQgLSBhY3R1YWxXaWR0aAogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIG9mZnNldCA9IHsKICAgICAgICAgICAgICB0b3A6IHBvc2l0aW9uLnRvcCAtIGFjdHVhbEhlaWdodCwKICAgICAgICAgICAgICBsZWZ0OiBwb3NpdGlvbi5sZWZ0ICsgcG9zaXRpb24ud2lkdGggLyAyIC0gYWN0dWFsV2lkdGggLyAyCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICAgIGlmKCFzcGxpdFsxXSkgewogICAgICAgICAgICByZXR1cm4gb2Zmc2V0OwogICAgICAgICAgfQoKICAgICAgICAgIC8vIEFkZCBzdXBwb3J0IGZvciBjb3JuZXJzIEB0b2RvIGNzcwogICAgICAgICAgaWYoc3BsaXRbMF0gPT09ICd0b3AnIHx8IHNwbGl0WzBdID09PSAnYm90dG9tJykgewogICAgICAgICAgICBzd2l0Y2ggKHNwbGl0WzFdKSB7CiAgICAgICAgICAgIGNhc2UgJ2xlZnQnOgogICAgICAgICAgICAgIG9mZnNldC5sZWZ0ID0gcG9zaXRpb24ubGVmdDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAncmlnaHQnOgogICAgICAgICAgICAgIG9mZnNldC5sZWZ0ID0gIHBvc2l0aW9uLmxlZnQgKyBwb3NpdGlvbi53aWR0aCAtIGFjdHVhbFdpZHRoOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYoc3BsaXRbMF0gPT09ICdsZWZ0JyB8fCBzcGxpdFswXSA9PT0gJ3JpZ2h0JykgewogICAgICAgICAgICBzd2l0Y2ggKHNwbGl0WzFdKSB7CiAgICAgICAgICAgIGNhc2UgJ3RvcCc6CiAgICAgICAgICAgICAgb2Zmc2V0LnRvcCA9IHBvc2l0aW9uLnRvcCAtIGFjdHVhbEhlaWdodDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnYm90dG9tJzoKICAgICAgICAgICAgICBvZmZzZXQudG9wID0gcG9zaXRpb24udG9wICsgcG9zaXRpb24uaGVpZ2h0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkdG9vbHRpcDsKCiAgICAgIH0KCiAgICAgIC8vIEhlbHBlciBmdW5jdGlvbnMKCiAgICAgIGZ1bmN0aW9uIGZpbmRFbGVtZW50KHF1ZXJ5LCBlbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIGFuZ3VsYXIuZWxlbWVudCgoZWxlbWVudCB8fCBkb2N1bWVudCkucXVlcnlTZWxlY3RvckFsbChxdWVyeSkpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBmZXRjaFRlbXBsYXRlKHRlbXBsYXRlKSB7CiAgICAgICAgcmV0dXJuICRxLndoZW4oJHRlbXBsYXRlQ2FjaGUuZ2V0KHRlbXBsYXRlKSB8fCAkaHR0cC5nZXQodGVtcGxhdGUpKQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgaWYoYW5ndWxhci5pc09iamVjdChyZXMpKSB7CiAgICAgICAgICAgICR0ZW1wbGF0ZUNhY2hlLnB1dCh0ZW1wbGF0ZSwgcmVzLmRhdGEpOwogICAgICAgICAgICByZXR1cm4gcmVzLmRhdGE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzOwogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gVG9vbHRpcEZhY3Rvcnk7CgogICAgfV07CgogIH0pCgogIC5kaXJlY3RpdmUoJ2JzVG9vbHRpcCcsIFsiJHdpbmRvdyIsICIkbG9jYXRpb24iLCAiJHNjZSIsICIkdG9vbHRpcCIsICIkJHJBRiIsIGZ1bmN0aW9uKCR3aW5kb3csICRsb2NhdGlvbiwgJHNjZSwgJHRvb2x0aXAsICQkckFGKSB7CgogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFQUMnLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIHRyYW5zY2x1c2lvbikgewoKICAgICAgICAvLyBEaXJlY3RpdmUgb3B0aW9ucwogICAgICAgIHZhciBvcHRpb25zID0ge3Njb3BlOiBzY29wZX07CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsndGVtcGxhdGUnLCAnY29udGVudFRlbXBsYXRlJywgJ3BsYWNlbWVudCcsICdjb250YWluZXInLCAndGFyZ2V0JywgJ2RlbGF5JywgJ3RyaWdnZXInLCAna2V5Ym9hcmQnLCAnaHRtbCcsICdhbmltYXRpb24nLCAndHlwZScsICdjdXN0b21DbGFzcyddLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNEZWZpbmVkKGF0dHJba2V5XSkpIG9wdGlvbnNba2V5XSA9IGF0dHJba2V5XTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gT2JzZXJ2ZSBzY29wZSBhdHRyaWJ1dGVzIGZvciBjaGFuZ2UKICAgICAgICBhdHRyLiRvYnNlcnZlKCd0aXRsZScsIGZ1bmN0aW9uKG5ld1ZhbHVlKSB7CiAgICAgICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQobmV3VmFsdWUpIHx8ICFzY29wZS5oYXNPd25Qcm9wZXJ0eSgndGl0bGUnKSkgewogICAgICAgICAgICB2YXIgb2xkVmFsdWUgPSBzY29wZS50aXRsZTsKICAgICAgICAgICAgc2NvcGUudGl0bGUgPSAkc2NlLnRydXN0QXNIdG1sKG5ld1ZhbHVlKTsKICAgICAgICAgICAgYW5ndWxhci5pc0RlZmluZWQob2xkVmFsdWUpICYmICQkckFGKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRvb2x0aXAgJiYgdG9vbHRpcC4kYXBwbHlQbGFjZW1lbnQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIC8vIFN1cHBvcnQgc2NvcGUgYXMgYW4gb2JqZWN0CiAgICAgICAgYXR0ci5ic1Rvb2x0aXAgJiYgc2NvcGUuJHdhdGNoKGF0dHIuYnNUb29sdGlwLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNPYmplY3QobmV3VmFsdWUpKSB7CiAgICAgICAgICAgIGFuZ3VsYXIuZXh0ZW5kKHNjb3BlLCBuZXdWYWx1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzY29wZS50aXRsZSA9IG5ld1ZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgYW5ndWxhci5pc0RlZmluZWQob2xkVmFsdWUpICYmICQkckFGKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0b29sdGlwICYmIHRvb2x0aXAuJGFwcGx5UGxhY2VtZW50KCk7CiAgICAgICAgICB9KTsKICAgICAgICB9LCB0cnVlKTsKCiAgICAgICAgLy8gVmlzaWJpbGl0eSBiaW5kaW5nIHN1cHBvcnQKICAgICAgICBhdHRyLmJzU2hvdyAmJiBzY29wZS4kd2F0Y2goYXR0ci5ic1Nob3csIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgaWYoIXRvb2x0aXAgfHwgIWFuZ3VsYXIuaXNEZWZpbmVkKG5ld1ZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgaWYoYW5ndWxhci5pc1N0cmluZyhuZXdWYWx1ZSkpIG5ld1ZhbHVlID0gISFuZXdWYWx1ZS5tYXRjaCgvdHJ1ZXwsPyh0b29sdGlwKSw/L2kpOwogICAgICAgICAgbmV3VmFsdWUgPT09IHRydWUgPyB0b29sdGlwLnNob3coKSA6IHRvb2x0aXAuaGlkZSgpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBJbml0aWFsaXplIHBvcG92ZXIKICAgICAgICB2YXIgdG9vbHRpcCA9ICR0b29sdGlwKGVsZW1lbnQsIG9wdGlvbnMpOwoKICAgICAgICAvLyBHYXJiYWdlIGNvbGxlY3Rpb24KICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZih0b29sdGlwKSB0b29sdGlwLmRlc3Ryb3koKTsKICAgICAgICAgIG9wdGlvbnMgPSBudWxsOwogICAgICAgICAgdG9vbHRpcCA9IG51bGw7CiAgICAgICAgfSk7CgogICAgICB9CiAgICB9OwoKICB9XSk7CgovLyBTb3VyY2U6IHR5cGVhaGVhZC5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAudHlwZWFoZWFkJywgWydtZ2NyZWEubmdTdHJhcC50b29sdGlwJywgJ21nY3JlYS5uZ1N0cmFwLmhlbHBlcnMucGFyc2VPcHRpb25zJ10pCgogIC5wcm92aWRlcignJHR5cGVhaGVhZCcsIGZ1bmN0aW9uKCkgewoKICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgIGFuaW1hdGlvbjogJ2FtLWZhZGUnLAogICAgICBwcmVmaXhDbGFzczogJ3R5cGVhaGVhZCcsCiAgICAgIHByZWZpeEV2ZW50OiAnJHR5cGVhaGVhZCcsCiAgICAgIHBsYWNlbWVudDogJ2JvdHRvbS1sZWZ0JywKICAgICAgdGVtcGxhdGU6ICd0eXBlYWhlYWQvdHlwZWFoZWFkLnRwbC5odG1sJywKICAgICAgdHJpZ2dlcjogJ2ZvY3VzJywKICAgICAgY29udGFpbmVyOiBmYWxzZSwKICAgICAga2V5Ym9hcmQ6IHRydWUsCiAgICAgIGh0bWw6IGZhbHNlLAogICAgICBkZWxheTogMCwKICAgICAgbWluTGVuZ3RoOiAxLAogICAgICBmaWx0ZXI6ICdmaWx0ZXInLAogICAgICBsaW1pdDogNgogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBbIiR3aW5kb3ciLCAiJHJvb3RTY29wZSIsICIkdG9vbHRpcCIsIGZ1bmN0aW9uKCR3aW5kb3csICRyb290U2NvcGUsICR0b29sdGlwKSB7CgogICAgICB2YXIgYm9keUVsID0gYW5ndWxhci5lbGVtZW50KCR3aW5kb3cuZG9jdW1lbnQuYm9keSk7CgogICAgICBmdW5jdGlvbiBUeXBlYWhlYWRGYWN0b3J5KGVsZW1lbnQsIGNvbnRyb2xsZXIsIGNvbmZpZykgewoKICAgICAgICB2YXIgJHR5cGVhaGVhZCA9IHt9OwoKICAgICAgICAvLyBDb21tb24gdmFycwogICAgICAgIHZhciBvcHRpb25zID0gYW5ndWxhci5leHRlbmQoe30sIGRlZmF1bHRzLCBjb25maWcpOwoKICAgICAgICAkdHlwZWFoZWFkID0gJHRvb2x0aXAoZWxlbWVudCwgb3B0aW9ucyk7CiAgICAgICAgdmFyIHBhcmVudFNjb3BlID0gY29uZmlnLnNjb3BlOwogICAgICAgIHZhciBzY29wZSA9ICR0eXBlYWhlYWQuJHNjb3BlOwoKICAgICAgICBzY29wZS4kcmVzZXRNYXRjaGVzID0gZnVuY3Rpb24oKXsKICAgICAgICAgIHNjb3BlLiRtYXRjaGVzID0gW107CiAgICAgICAgICBzY29wZS4kYWN0aXZlSW5kZXggPSAwOwogICAgICAgIH07CiAgICAgICAgc2NvcGUuJHJlc2V0TWF0Y2hlcygpOwoKICAgICAgICBzY29wZS4kYWN0aXZhdGUgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgc2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkdHlwZWFoZWFkLmFjdGl2YXRlKGluZGV4KTsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHNjb3BlLiRzZWxlY3QgPSBmdW5jdGlvbihpbmRleCwgZXZ0KSB7CiAgICAgICAgICBzY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICR0eXBlYWhlYWQuc2VsZWN0KGluZGV4KTsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHNjb3BlLiRpc1Zpc2libGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiAkdHlwZWFoZWFkLiRpc1Zpc2libGUoKTsKICAgICAgICB9OwoKICAgICAgICAvLyBQdWJsaWMgbWV0aG9kcwoKICAgICAgICAkdHlwZWFoZWFkLnVwZGF0ZSA9IGZ1bmN0aW9uKG1hdGNoZXMpIHsKICAgICAgICAgIHNjb3BlLiRtYXRjaGVzID0gbWF0Y2hlczsKICAgICAgICAgIGlmKHNjb3BlLiRhY3RpdmVJbmRleCA+PSBtYXRjaGVzLmxlbmd0aCkgewogICAgICAgICAgICBzY29wZS4kYWN0aXZlSW5kZXggPSAwOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgICR0eXBlYWhlYWQuYWN0aXZhdGUgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgc2NvcGUuJGFjdGl2ZUluZGV4ID0gaW5kZXg7CiAgICAgICAgfTsKCiAgICAgICAgJHR5cGVhaGVhZC5zZWxlY3QgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgdmFyIHZhbHVlID0gc2NvcGUuJG1hdGNoZXNbaW5kZXhdLnZhbHVlOwogICAgICAgICAgLy8gY29uc29sZS5sb2coJyRzZXRWaWV3VmFsdWUnLCB2YWx1ZSk7CiAgICAgICAgICBjb250cm9sbGVyLiRzZXRWaWV3VmFsdWUodmFsdWUpOwogICAgICAgICAgY29udHJvbGxlci4kcmVuZGVyKCk7CiAgICAgICAgICBzY29wZS4kcmVzZXRNYXRjaGVzKCk7CiAgICAgICAgICBpZihwYXJlbnRTY29wZSkgcGFyZW50U2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgLy8gRW1pdCBldmVudAogICAgICAgICAgc2NvcGUuJGVtaXQob3B0aW9ucy5wcmVmaXhFdmVudCArICcuc2VsZWN0JywgdmFsdWUsIGluZGV4KTsKICAgICAgICB9OwoKICAgICAgICAvLyBQcm90ZWN0ZWQgbWV0aG9kcwoKICAgICAgICAkdHlwZWFoZWFkLiRpc1Zpc2libGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmKCFvcHRpb25zLm1pbkxlbmd0aCB8fCAhY29udHJvbGxlcikgewogICAgICAgICAgICByZXR1cm4gISFzY29wZS4kbWF0Y2hlcy5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBtaW5MZW5ndGggc3VwcG9ydAogICAgICAgICAgcmV0dXJuIHNjb3BlLiRtYXRjaGVzLmxlbmd0aCAmJiBhbmd1bGFyLmlzU3RyaW5nKGNvbnRyb2xsZXIuJHZpZXdWYWx1ZSkgJiYgY29udHJvbGxlci4kdmlld1ZhbHVlLmxlbmd0aCA+PSBvcHRpb25zLm1pbkxlbmd0aDsKICAgICAgICB9OwoKICAgICAgICAkdHlwZWFoZWFkLiRnZXRJbmRleCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICB2YXIgbCA9IHNjb3BlLiRtYXRjaGVzLmxlbmd0aCwgaSA9IGw7CiAgICAgICAgICBpZighbCkgcmV0dXJuOwogICAgICAgICAgZm9yKGkgPSBsOyBpLS07KSB7CiAgICAgICAgICAgIGlmKHNjb3BlLiRtYXRjaGVzW2ldLnZhbHVlID09PSB2YWx1ZSkgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZihpIDwgMCkgcmV0dXJuOwogICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgfTsKCiAgICAgICAgJHR5cGVhaGVhZC4kb25Nb3VzZURvd24gPSBmdW5jdGlvbihldnQpIHsKICAgICAgICAgIC8vIFByZXZlbnQgYmx1ciBvbiBtb3VzZWRvd24KICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgIH07CgogICAgICAgICR0eXBlYWhlYWQuJG9uS2V5RG93biA9IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgaWYoIS8oMzh8NDB8MTMpLy50ZXN0KGV2dC5rZXlDb2RlKSkgcmV0dXJuOwoKICAgICAgICAgIC8vIExldCBuZ1N1Ym1pdCBwYXNzIGlmIHRoZSB0eXBlYWhlYWQgdGlwIGlzIGhpZGRlbgogICAgICAgICAgaWYoJHR5cGVhaGVhZC4kaXNWaXNpYmxlKCkpIHsKICAgICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBTZWxlY3Qgd2l0aCBlbnRlcgogICAgICAgICAgaWYoZXZ0LmtleUNvZGUgPT09IDEzICYmIHNjb3BlLiRtYXRjaGVzLmxlbmd0aCkgewogICAgICAgICAgICAkdHlwZWFoZWFkLnNlbGVjdChzY29wZS4kYWN0aXZlSW5kZXgpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIE5hdmlnYXRlIHdpdGgga2V5Ym9hcmQKICAgICAgICAgIGVsc2UgaWYoZXZ0LmtleUNvZGUgPT09IDM4ICYmIHNjb3BlLiRhY3RpdmVJbmRleCA+IDApIHNjb3BlLiRhY3RpdmVJbmRleC0tOwogICAgICAgICAgZWxzZSBpZihldnQua2V5Q29kZSA9PT0gNDAgJiYgc2NvcGUuJGFjdGl2ZUluZGV4IDwgc2NvcGUuJG1hdGNoZXMubGVuZ3RoIC0gMSkgc2NvcGUuJGFjdGl2ZUluZGV4Kys7CiAgICAgICAgICBlbHNlIGlmKGFuZ3VsYXIuaXNVbmRlZmluZWQoc2NvcGUuJGFjdGl2ZUluZGV4KSkgc2NvcGUuJGFjdGl2ZUluZGV4ID0gMDsKICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICB9OwoKICAgICAgICAvLyBPdmVycmlkZXMKCiAgICAgICAgdmFyIHNob3cgPSAkdHlwZWFoZWFkLnNob3c7CiAgICAgICAgJHR5cGVhaGVhZC5zaG93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBzaG93KCk7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkdHlwZWFoZWFkLiRlbGVtZW50Lm9uKCdtb3VzZWRvd24nLCAkdHlwZWFoZWFkLiRvbk1vdXNlRG93bik7CiAgICAgICAgICAgIGlmKG9wdGlvbnMua2V5Ym9hcmQpIHsKICAgICAgICAgICAgICBlbGVtZW50Lm9uKCdrZXlkb3duJywgJHR5cGVhaGVhZC4kb25LZXlEb3duKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIGhpZGUgPSAkdHlwZWFoZWFkLmhpZGU7CiAgICAgICAgJHR5cGVhaGVhZC5oaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAkdHlwZWFoZWFkLiRlbGVtZW50Lm9mZignbW91c2Vkb3duJywgJHR5cGVhaGVhZC4kb25Nb3VzZURvd24pOwogICAgICAgICAgaWYob3B0aW9ucy5rZXlib2FyZCkgewogICAgICAgICAgICBlbGVtZW50Lm9mZigna2V5ZG93bicsICR0eXBlYWhlYWQuJG9uS2V5RG93bik7CiAgICAgICAgICB9CiAgICAgICAgICBoaWRlKCk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuICR0eXBlYWhlYWQ7CgogICAgICB9CgogICAgICBUeXBlYWhlYWRGYWN0b3J5LmRlZmF1bHRzID0gZGVmYXVsdHM7CiAgICAgIHJldHVybiBUeXBlYWhlYWRGYWN0b3J5OwoKICAgIH1dOwoKICB9KQoKICAuZGlyZWN0aXZlKCdic1R5cGVhaGVhZCcsIFsiJHdpbmRvdyIsICIkcGFyc2UiLCAiJHEiLCAiJHR5cGVhaGVhZCIsICIkcGFyc2VPcHRpb25zIiwgZnVuY3Rpb24oJHdpbmRvdywgJHBhcnNlLCAkcSwgJHR5cGVhaGVhZCwgJHBhcnNlT3B0aW9ucykgewoKICAgIHZhciBkZWZhdWx0cyA9ICR0eXBlYWhlYWQuZGVmYXVsdHM7CgogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFQUMnLAogICAgICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjb250cm9sbGVyKSB7CgogICAgICAgIC8vIERpcmVjdGl2ZSBvcHRpb25zCiAgICAgICAgdmFyIG9wdGlvbnMgPSB7c2NvcGU6IHNjb3BlfTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goWydwbGFjZW1lbnQnLCAnY29udGFpbmVyJywgJ2RlbGF5JywgJ3RyaWdnZXInLCAna2V5Ym9hcmQnLCAnaHRtbCcsICdhbmltYXRpb24nLCAndGVtcGxhdGUnLCAnZmlsdGVyJywgJ2xpbWl0JywgJ21pbkxlbmd0aCcsICd3YXRjaE9wdGlvbnMnLCAnc2VsZWN0TW9kZSddLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGlmKGFuZ3VsYXIuaXNEZWZpbmVkKGF0dHJba2V5XSkpIG9wdGlvbnNba2V5XSA9IGF0dHJba2V5XTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gQnVpbGQgcHJvcGVyIG5nT3B0aW9ucwogICAgICAgIHZhciBmaWx0ZXIgPSBvcHRpb25zLmZpbHRlciB8fCBkZWZhdWx0cy5maWx0ZXI7CiAgICAgICAgdmFyIGxpbWl0ID0gb3B0aW9ucy5saW1pdCB8fCBkZWZhdWx0cy5saW1pdDsKICAgICAgICB2YXIgbmdPcHRpb25zID0gYXR0ci5uZ09wdGlvbnM7CiAgICAgICAgaWYoZmlsdGVyKSBuZ09wdGlvbnMgKz0gJyB8ICcgKyBmaWx0ZXIgKyAnOiR2aWV3VmFsdWUnOwogICAgICAgIGlmKGxpbWl0KSBuZ09wdGlvbnMgKz0gJyB8IGxpbWl0VG86JyArIGxpbWl0OwogICAgICAgIHZhciBwYXJzZWRPcHRpb25zID0gJHBhcnNlT3B0aW9ucyhuZ09wdGlvbnMpOwoKICAgICAgICAvLyBJbml0aWFsaXplIHR5cGVhaGVhZAogICAgICAgIHZhciB0eXBlYWhlYWQgPSAkdHlwZWFoZWFkKGVsZW1lbnQsIGNvbnRyb2xsZXIsIG9wdGlvbnMpOwoKICAgICAgICAvLyBXYXRjaCBvcHRpb25zIG9uIGRlbWFuZAogICAgICAgIGlmKG9wdGlvbnMud2F0Y2hPcHRpb25zKSB7CiAgICAgICAgICAvLyBXYXRjaCBuZ09wdGlvbnMgdmFsdWVzIGJlZm9yZSBmaWx0ZXJpbmcgZm9yIGNoYW5nZXMsIGRyb3AgZnVuY3Rpb24gY2FsbHMKICAgICAgICAgIHZhciB3YXRjaGVkT3B0aW9ucyA9IHBhcnNlZE9wdGlvbnMuJG1hdGNoWzddLnJlcGxhY2UoL1x8LisvLCAnJykucmVwbGFjZSgvXCguKlwpL2csICcnKS50cmltKCk7CiAgICAgICAgICBzY29wZS4kd2F0Y2god2F0Y2hlZE9wdGlvbnMsIGZ1bmN0aW9uIChuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgLy8gY29uc29sZS53YXJuKCdzY29wZS4kd2F0Y2goJXMpJywgd2F0Y2hlZE9wdGlvbnMsIG5ld1ZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgIHBhcnNlZE9wdGlvbnMudmFsdWVzRm4oc2NvcGUsIGNvbnRyb2xsZXIpLnRoZW4oZnVuY3Rpb24gKHZhbHVlcykgewogICAgICAgICAgICAgIHR5cGVhaGVhZC51cGRhdGUodmFsdWVzKTsKICAgICAgICAgICAgICBjb250cm9sbGVyLiRyZW5kZXIoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LCB0cnVlKTsKICAgICAgICB9CgogICAgICAgIC8vIFdhdGNoIG1vZGVsIGZvciBjaGFuZ2VzCiAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdNb2RlbCwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyR3YXRjaCcsIGVsZW1lbnQuYXR0cignbmctbW9kZWwnKSwgbmV3VmFsdWUpOwogICAgICAgICAgc2NvcGUuJG1vZGVsVmFsdWUgPSBuZXdWYWx1ZTsgLy8gUHVibGlzaCBtb2RlbFZhbHVlIG9uIHNjb3BlIGZvciBjdXN0b20gdGVtcGxhdGVzCiAgICAgICAgICBwYXJzZWRPcHRpb25zLnZhbHVlc0ZuKHNjb3BlLCBjb250cm9sbGVyKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24odmFsdWVzKSB7CiAgICAgICAgICAgIC8vIFByZXZlbnQgaW5wdXQgd2l0aCBubyBmdXR1cmUgcHJvc3BlY3QgaWYgc2VsZWN0TW9kZSBpcyB0cnV0aHkKICAgICAgICAgICAgLy8gQFRPRE8gdGVzdCBzZWxlY3RNb2RlCiAgICAgICAgICAgIGlmKG9wdGlvbnMuc2VsZWN0TW9kZSAmJiAhdmFsdWVzLmxlbmd0aCAmJiBuZXdWYWx1ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgY29udHJvbGxlci4kc2V0Vmlld1ZhbHVlKGNvbnRyb2xsZXIuJHZpZXdWYWx1ZS5zdWJzdHJpbmcoMCwgY29udHJvbGxlci4kdmlld1ZhbHVlLmxlbmd0aCAtIDEpKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodmFsdWVzLmxlbmd0aCA+IGxpbWl0KSB2YWx1ZXMgPSB2YWx1ZXMuc2xpY2UoMCwgbGltaXQpOwogICAgICAgICAgICB2YXIgaXNWaXNpYmxlID0gdHlwZWFoZWFkLiRpc1Zpc2libGUoKTsKICAgICAgICAgICAgaXNWaXNpYmxlICYmIHR5cGVhaGVhZC51cGRhdGUodmFsdWVzKTsKICAgICAgICAgICAgLy8gRG8gbm90IHJlLXF1ZXVlIGFuIHVwZGF0ZSBpZiBhIGNvcnJlY3QgdmFsdWUgaGFzIGJlZW4gc2VsZWN0ZWQKICAgICAgICAgICAgaWYodmFsdWVzLmxlbmd0aCA9PT0gMSAmJiB2YWx1ZXNbMF0udmFsdWUgPT09IG5ld1ZhbHVlKSByZXR1cm47CiAgICAgICAgICAgICFpc1Zpc2libGUgJiYgdHlwZWFoZWFkLnVwZGF0ZSh2YWx1ZXMpOwogICAgICAgICAgICAvLyBRdWV1ZSBhIG5ldyByZW5kZXJpbmcgdGhhdCB3aWxsIGxldmVyYWdlIGNvbGxlY3Rpb24gbG9hZGluZwogICAgICAgICAgICBjb250cm9sbGVyLiRyZW5kZXIoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyBtb2RlbFZhbHVlIC0+ICRmb3JtYXR0ZXJzIC0+IHZpZXdWYWx1ZQogICAgICAgIGNvbnRyb2xsZXIuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbihtb2RlbFZhbHVlKSB7CiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJyRmb3JtYXR0ZXIoIiVzIik6IG1vZGVsVmFsdWU9JW8gKCVvKScsIGVsZW1lbnQuYXR0cignbmctbW9kZWwnKSwgbW9kZWxWYWx1ZSwgdHlwZW9mIG1vZGVsVmFsdWUpOwogICAgICAgICAgcmV0dXJuIHBhcnNlZE9wdGlvbnMuZGlzcGxheVZhbHVlKG1vZGVsVmFsdWUpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBNb2RlbCByZW5kZXJpbmcgaW4gdmlldwogICAgICAgIGNvbnRyb2xsZXIuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIGNvbnNvbGUud2FybignJHJlbmRlcicsIGVsZW1lbnQuYXR0cignbmctbW9kZWwnKSwgJ2NvbnRyb2xsZXIuJG1vZGVsVmFsdWUnLCB0eXBlb2YgY29udHJvbGxlci4kbW9kZWxWYWx1ZSwgY29udHJvbGxlci4kbW9kZWxWYWx1ZSwgJ2NvbnRyb2xsZXIuJHZpZXdWYWx1ZScsIHR5cGVvZiBjb250cm9sbGVyLiR2aWV3VmFsdWUsIGNvbnRyb2xsZXIuJHZpZXdWYWx1ZSk7CiAgICAgICAgICBpZihjb250cm9sbGVyLiRpc0VtcHR5KGNvbnRyb2xsZXIuJHZpZXdWYWx1ZSkpIHJldHVybiBlbGVtZW50LnZhbCgnJyk7CiAgICAgICAgICB2YXIgaW5kZXggPSB0eXBlYWhlYWQuJGdldEluZGV4KGNvbnRyb2xsZXIuJG1vZGVsVmFsdWUpOwogICAgICAgICAgdmFyIHNlbGVjdGVkID0gYW5ndWxhci5pc0RlZmluZWQoaW5kZXgpID8gdHlwZWFoZWFkLiRzY29wZS4kbWF0Y2hlc1tpbmRleF0ubGFiZWwgOiBjb250cm9sbGVyLiR2aWV3VmFsdWU7CiAgICAgICAgICBzZWxlY3RlZCA9IGFuZ3VsYXIuaXNPYmplY3Qoc2VsZWN0ZWQpID8gc2VsZWN0ZWQubGFiZWwgOiBzZWxlY3RlZDsKICAgICAgICAgIGVsZW1lbnQudmFsKHNlbGVjdGVkID8gc2VsZWN0ZWQucmVwbGFjZSgvPCg/Oi58XG4pKj8+L2dtLCAnJykudHJpbSgpIDogJycpOwogICAgICAgIH07CgogICAgICAgIC8vIEdhcmJhZ2UgY29sbGVjdGlvbgogICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICh0eXBlYWhlYWQpIHR5cGVhaGVhZC5kZXN0cm95KCk7CiAgICAgICAgICBvcHRpb25zID0gbnVsbDsKICAgICAgICAgIHR5cGVhaGVhZCA9IG51bGw7CiAgICAgICAgfSk7CgogICAgICB9CiAgICB9OwoKICB9XSk7Cgp9KSh3aW5kb3csIGRvY3VtZW50KTsKCi8qKgogKiBhbmd1bGFyLXN0cmFwCiAqIEB2ZXJzaW9uIHYyLjEuMiAtIDIwMTQtMTAtMTkKICogQGxpbmsgaHR0cDovL21nY3JlYS5naXRodWIuaW8vYW5ndWxhci1zdHJhcAogKiBAYXV0aG9yIE9saXZpZXIgTG91dmlnbmVzIChvbGl2aWVyQG1nLWNyZWEuY29tKQogKiBAbGljZW5zZSBNSVQgTGljZW5zZSwgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9NSVQKICovCihmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQpIHsKJ3VzZSBzdHJpY3QnOwoKLy8gU291cmNlOiBhbGVydC50cGwuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLmFsZXJ0JykucnVuKFsnJHRlbXBsYXRlQ2FjaGUnLCBmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewoKICAkdGVtcGxhdGVDYWNoZS5wdXQoJ2FsZXJ0L2FsZXJ0LnRwbC5odG1sJywgJzxkaXYgY2xhc3M9ImFsZXJ0IiBuZy1jbGFzcz0iW3R5cGUgPyBcJ2FsZXJ0LVwnICsgdHlwZSA6IG51bGxdIj48YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImNsb3NlIiBuZy1pZj0iZGlzbWlzc2FibGUiIG5nLWNsaWNrPSIkaGlkZSgpIj4mdGltZXM7PC9idXR0b24+IDxzdHJvbmcgbmctYmluZD0idGl0bGUiPjwvc3Ryb25nPiZuYnNwOzxzcGFuIG5nLWJpbmQtaHRtbD0iY29udGVudCI+PC9zcGFuPjwvZGl2PicpOwoKfV0pOwoKLy8gU291cmNlOiBhc2lkZS50cGwuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLmFzaWRlJykucnVuKFsnJHRlbXBsYXRlQ2FjaGUnLCBmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewoKICAkdGVtcGxhdGVDYWNoZS5wdXQoJ2FzaWRlL2FzaWRlLnRwbC5odG1sJywgJzxkaXYgY2xhc3M9ImFzaWRlIiB0YWJpbmRleD0iLTEiIHJvbGU9ImRpYWxvZyI+PGRpdiBjbGFzcz0iYXNpZGUtZGlhbG9nIj48ZGl2IGNsYXNzPSJhc2lkZS1jb250ZW50Ij48ZGl2IGNsYXNzPSJhc2lkZS1oZWFkZXIiIG5nLXNob3c9InRpdGxlIj48YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImNsb3NlIiBuZy1jbGljaz0iJGhpZGUoKSI+JnRpbWVzOzwvYnV0dG9uPjxoNCBjbGFzcz0iYXNpZGUtdGl0bGUiIG5nLWJpbmQ9InRpdGxlIj48L2g0PjwvZGl2PjxkaXYgY2xhc3M9ImFzaWRlLWJvZHkiIG5nLWJpbmQ9ImNvbnRlbnQiPjwvZGl2PjxkaXYgY2xhc3M9ImFzaWRlLWZvb3RlciI+PGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQiIG5nLWNsaWNrPSIkaGlkZSgpIj5DbG9zZTwvYnV0dG9uPjwvZGl2PjwvZGl2PjwvZGl2PjwvZGl2PicpOwoKfV0pOwoKLy8gU291cmNlOiBkcm9wZG93bi50cGwuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLmRyb3Bkb3duJykucnVuKFsnJHRlbXBsYXRlQ2FjaGUnLCBmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewoKICAkdGVtcGxhdGVDYWNoZS5wdXQoJ2Ryb3Bkb3duL2Ryb3Bkb3duLnRwbC5odG1sJywgJzx1bCB0YWJpbmRleD0iLTEiIGNsYXNzPSJkcm9wZG93bi1tZW51IiByb2xlPSJtZW51Ij48bGkgcm9sZT0icHJlc2VudGF0aW9uIiBuZy1jbGFzcz0ie2RpdmlkZXI6IGl0ZW0uZGl2aWRlcn0iIG5nLXJlcGVhdD0iaXRlbSBpbiBjb250ZW50Ij48YSByb2xlPSJtZW51aXRlbSIgdGFiaW5kZXg9Ii0xIiBuZy1ocmVmPSJ7e2l0ZW0uaHJlZn19IiBuZy1pZj0iIWl0ZW0uZGl2aWRlciAmJiBpdGVtLmhyZWYiIHRhcmdldD0ie3tpdGVtLnRhcmdldCB8fCBcJ1wnfX0iIG5nLWJpbmQ9Iml0ZW0udGV4dCI+PC9hPiA8YSByb2xlPSJtZW51aXRlbSIgdGFiaW5kZXg9Ii0xIiBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIG5nLWlmPSIhaXRlbS5kaXZpZGVyICYmIGl0ZW0uY2xpY2siIG5nLWNsaWNrPSIkZXZhbChpdGVtLmNsaWNrKTskaGlkZSgpIiBuZy1iaW5kPSJpdGVtLnRleHQiPjwvYT48L2xpPjwvdWw+Jyk7Cgp9XSk7CgovLyBTb3VyY2U6IGRhdGVwaWNrZXIudHBsLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5kYXRlcGlja2VyJykucnVuKFsnJHRlbXBsYXRlQ2FjaGUnLCBmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewoKICAkdGVtcGxhdGVDYWNoZS5wdXQoJ2RhdGVwaWNrZXIvZGF0ZXBpY2tlci50cGwuaHRtbCcsICc8ZGl2IGNsYXNzPSJkcm9wZG93bi1tZW51IGRhdGVwaWNrZXIiIG5nLWNsYXNzPSJcJ2RhdGVwaWNrZXItbW9kZS1cJyArICRtb2RlIiBzdHlsZT0ibWF4LXdpZHRoOiAzMjBweCI+PHRhYmxlIHN0eWxlPSJ0YWJsZS1sYXlvdXQ6IGZpeGVkOyBoZWlnaHQ6IDEwMCU7IHdpZHRoOiAxMDAlIj48dGhlYWQ+PHRyIGNsYXNzPSJ0ZXh0LWNlbnRlciI+PHRoPjxidXR0b24gdGFiaW5kZXg9Ii0xIiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQgcHVsbC1sZWZ0IiBuZy1jbGljaz0iJHNlbGVjdFBhbmUoLTEpIj48aSBjbGFzcz0ie3skaWNvbkxlZnR9fSI+PC9pPjwvYnV0dG9uPjwvdGg+PHRoIGNvbHNwYW49Int7IHJvd3NbMF0ubGVuZ3RoIC0gMiB9fSI+PGJ1dHRvbiB0YWJpbmRleD0iLTEiIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImJ0biBidG4tZGVmYXVsdCBidG4tYmxvY2sgdGV4dC1zdHJvbmciIG5nLWNsaWNrPSIkdG9nZ2xlTW9kZSgpIj48c3Ryb25nIHN0eWxlPSJ0ZXh0LXRyYW5zZm9ybTogY2FwaXRhbGl6ZSIgbmctYmluZD0idGl0bGUiPjwvc3Ryb25nPjwvYnV0dG9uPjwvdGg+PHRoPjxidXR0b24gdGFiaW5kZXg9Ii0xIiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQgcHVsbC1yaWdodCIgbmctY2xpY2s9IiRzZWxlY3RQYW5lKCsxKSI+PGkgY2xhc3M9Int7JGljb25SaWdodH19Ij48L2k+PC9idXR0b24+PC90aD48L3RyPjx0ciBuZy1zaG93PSJzaG93TGFiZWxzIiBuZy1iaW5kLWh0bWw9ImxhYmVscyI+PC90cj48L3RoZWFkPjx0Ym9keT48dHIgbmctcmVwZWF0PSIoaSwgcm93KSBpbiByb3dzIiBoZWlnaHQ9Int7IDEwMCAvIHJvd3MubGVuZ3RoIH19JSI+PHRkIGNsYXNzPSJ0ZXh0LWNlbnRlciIgbmctcmVwZWF0PSIoaiwgZWwpIGluIHJvdyI+PGJ1dHRvbiB0YWJpbmRleD0iLTEiIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImJ0biBidG4tZGVmYXVsdCIgc3R5bGU9IndpZHRoOiAxMDAlIiBuZy1jbGFzcz0ie1wnYnRuLXByaW1hcnlcJzogZWwuc2VsZWN0ZWQsIFwnYnRuLWluZm8gYnRuLXRvZGF5XCc6IGVsLmlzVG9kYXkgJiYgIWVsLnNlbGVjdGVkfSIgbmctY2xpY2s9IiRzZWxlY3QoZWwuZGF0ZSkiIG5nLWRpc2FibGVkPSJlbC5kaXNhYmxlZCI+PHNwYW4gbmctY2xhc3M9IntcJ3RleHQtbXV0ZWRcJzogZWwubXV0ZWR9IiBuZy1iaW5kPSJlbC5sYWJlbCI+PC9zcGFuPjwvYnV0dG9uPjwvdGQ+PC90cj48L3Rib2R5PjwvdGFibGU+PC9kaXY+Jyk7Cgp9XSk7CgovLyBTb3VyY2U6IG1vZGFsLnRwbC5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAubW9kYWwnKS5ydW4oWyckdGVtcGxhdGVDYWNoZScsIGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CgogICR0ZW1wbGF0ZUNhY2hlLnB1dCgnbW9kYWwvbW9kYWwudHBsLmh0bWwnLCAnPGRpdiBjbGFzcz0ibW9kYWwiIHRhYmluZGV4PSItMSIgcm9sZT0iZGlhbG9nIj48ZGl2IGNsYXNzPSJtb2RhbC1kaWFsb2ciPjxkaXYgY2xhc3M9Im1vZGFsLWNvbnRlbnQiPjxkaXYgY2xhc3M9Im1vZGFsLWhlYWRlciIgbmctc2hvdz0idGl0bGUiPjxidXR0b24gdHlwZT0iYnV0dG9uIiBjbGFzcz0iY2xvc2UiIG5nLWNsaWNrPSIkaGlkZSgpIj4mdGltZXM7PC9idXR0b24+PGg0IGNsYXNzPSJtb2RhbC10aXRsZSIgbmctYmluZD0idGl0bGUiPjwvaDQ+PC9kaXY+PGRpdiBjbGFzcz0ibW9kYWwtYm9keSIgbmctYmluZD0iY29udGVudCI+PC9kaXY+PGRpdiBjbGFzcz0ibW9kYWwtZm9vdGVyIj48YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImJ0biBidG4tZGVmYXVsdCIgbmctY2xpY2s9IiRoaWRlKCkiPkNsb3NlPC9idXR0b24+PC9kaXY+PC9kaXY+PC9kaXY+PC9kaXY+Jyk7Cgp9XSk7CgovLyBTb3VyY2U6IHBvcG92ZXIudHBsLmpzCmFuZ3VsYXIubW9kdWxlKCdtZ2NyZWEubmdTdHJhcC5wb3BvdmVyJykucnVuKFsnJHRlbXBsYXRlQ2FjaGUnLCBmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewoKICAkdGVtcGxhdGVDYWNoZS5wdXQoJ3BvcG92ZXIvcG9wb3Zlci50cGwuaHRtbCcsICc8ZGl2IGNsYXNzPSJwb3BvdmVyIj48ZGl2IGNsYXNzPSJhcnJvdyI+PC9kaXY+PGgzIGNsYXNzPSJwb3BvdmVyLXRpdGxlIiBuZy1iaW5kPSJ0aXRsZSIgbmctc2hvdz0idGl0bGUiPjwvaDM+PGRpdiBjbGFzcz0icG9wb3Zlci1jb250ZW50IiBuZy1iaW5kPSJjb250ZW50Ij48L2Rpdj48L2Rpdj4nKTsKCn1dKTsKCi8vIFNvdXJjZTogc2VsZWN0LnRwbC5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAuc2VsZWN0JykucnVuKFsnJHRlbXBsYXRlQ2FjaGUnLCBmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewoKICAkdGVtcGxhdGVDYWNoZS5wdXQoJ3NlbGVjdC9zZWxlY3QudHBsLmh0bWwnLCAnPHVsIHRhYmluZGV4PSItMSIgY2xhc3M9InNlbGVjdCBkcm9wZG93bi1tZW51IiBuZy1zaG93PSIkaXNWaXNpYmxlKCkiIHJvbGU9InNlbGVjdCI+PGxpIG5nLWlmPSIkc2hvd0FsbE5vbmVCdXR0b25zIj48ZGl2IGNsYXNzPSJidG4tZ3JvdXAiIHN0eWxlPSJtYXJnaW4tYm90dG9tOiA1cHg7IG1hcmdpbi1sZWZ0OiA1cHgiPjxidXR0b24gY2xhc3M9ImJ0biBidG4tZGVmYXVsdCBidG4teHMiIG5nLWNsaWNrPSIkc2VsZWN0QWxsKCkiPkFsbDwvYnV0dG9uPiA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQgYnRuLXhzIiBuZy1jbGljaz0iJHNlbGVjdE5vbmUoKSI+Tm9uZTwvYnV0dG9uPjwvZGl2PjwvbGk+PGxpIHJvbGU9InByZXNlbnRhdGlvbiIgbmctcmVwZWF0PSJtYXRjaCBpbiAkbWF0Y2hlcyIgbmctY2xhc3M9InthY3RpdmU6ICRpc0FjdGl2ZSgkaW5kZXgpfSI+PGEgc3R5bGU9ImN1cnNvcjogZGVmYXVsdCIgcm9sZT0ibWVudWl0ZW0iIHRhYmluZGV4PSItMSIgbmctY2xpY2s9IiRzZWxlY3QoJGluZGV4LCAkZXZlbnQpIj48c3BhbiBuZy1iaW5kPSJtYXRjaC5sYWJlbCI+PC9zcGFuPiA8aSBjbGFzcz0ie3skaWNvbkNoZWNrbWFya319IHB1bGwtcmlnaHQiIG5nLWlmPSIkaXNNdWx0aXBsZSAmJiAkaXNBY3RpdmUoJGluZGV4KSI+PC9pPjwvYT48L2xpPjwvdWw+Jyk7Cgp9XSk7CgovLyBTb3VyY2U6IHRhYi50cGwuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLnRhYicpLnJ1bihbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKCiAgJHRlbXBsYXRlQ2FjaGUucHV0KCd0YWIvdGFiLnRwbC5odG1sJywgJzx1bCBjbGFzcz0ibmF2IiBuZy1jbGFzcz0iJG5hdkNsYXNzIiByb2xlPSJ0YWJsaXN0Ij48bGkgbmctcmVwZWF0PSIkcGFuZSBpbiAkcGFuZXMiIG5nLWNsYXNzPSIkaW5kZXggPT0gJHBhbmVzLiRhY3RpdmUgPyAkYWN0aXZlQ2xhc3MgOiBcJ1wnIj48YSByb2xlPSJ0YWIiIGRhdGEtdG9nZ2xlPSJ0YWIiIG5nLWNsaWNrPSIkc2V0QWN0aXZlKCRpbmRleCkiIGRhdGEtaW5kZXg9Int7ICRpbmRleCB9fSIgbmctYmluZC1odG1sPSIkcGFuZS50aXRsZSI+PC9hPjwvbGk+PC91bD48ZGl2IG5nLXRyYW5zY2x1ZGUgY2xhc3M9InRhYi1jb250ZW50Ij48L2Rpdj4nKTsKCn1dKTsKCi8vIFNvdXJjZTogdGltZXBpY2tlci50cGwuanMKYW5ndWxhci5tb2R1bGUoJ21nY3JlYS5uZ1N0cmFwLnRpbWVwaWNrZXInKS5ydW4oWyckdGVtcGxhdGVDYWNoZScsIGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CgogICR0ZW1wbGF0ZUNhY2hlLnB1dCgndGltZXBpY2tlci90aW1lcGlja2VyLnRwbC5odG1sJywgJzxkaXYgY2xhc3M9ImRyb3Bkb3duLW1lbnUgdGltZXBpY2tlciIgc3R5bGU9Im1pbi13aWR0aDogMHB4O3dpZHRoOiBhdXRvIj48dGFibGUgaGVpZ2h0PSIxMDAlIj48dGhlYWQ+PHRyIGNsYXNzPSJ0ZXh0LWNlbnRlciI+PHRoPjxidXR0b24gdGFiaW5kZXg9Ii0xIiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQgcHVsbC1sZWZ0IiBuZy1jbGljaz0iJGFycm93QWN0aW9uKC0xLCAwKSI+PGkgY2xhc3M9Int7ICRpY29uVXAgfX0iPjwvaT48L2J1dHRvbj48L3RoPjx0aD4mbmJzcDs8L3RoPjx0aD48YnV0dG9uIHRhYmluZGV4PSItMSIgdHlwZT0iYnV0dG9uIiBjbGFzcz0iYnRuIGJ0bi1kZWZhdWx0IHB1bGwtbGVmdCIgbmctY2xpY2s9IiRhcnJvd0FjdGlvbigtMSwgMSkiPjxpIGNsYXNzPSJ7eyAkaWNvblVwIH19Ij48L2k+PC9idXR0b24+PC90aD48L3RyPjwvdGhlYWQ+PHRib2R5Pjx0ciBuZy1yZXBlYXQ9IihpLCByb3cpIGluIHJvd3MiPjx0ZCBjbGFzcz0idGV4dC1jZW50ZXIiPjxidXR0b24gdGFiaW5kZXg9Ii0xIiBzdHlsZT0id2lkdGg6IDEwMCUiIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImJ0biBidG4tZGVmYXVsdCIgbmctY2xhc3M9IntcJ2J0bi1wcmltYXJ5XCc6IHJvd1swXS5zZWxlY3RlZH0iIG5nLWNsaWNrPSIkc2VsZWN0KHJvd1swXS5kYXRlLCAwKSIgbmctZGlzYWJsZWQ9InJvd1swXS5kaXNhYmxlZCI+PHNwYW4gbmctY2xhc3M9IntcJ3RleHQtbXV0ZWRcJzogcm93WzBdLm11dGVkfSIgbmctYmluZD0icm93WzBdLmxhYmVsIj48L3NwYW4+PC9idXR0b24+PC90ZD48dGQ+PHNwYW4gbmctYmluZD0iaSA9PSBtaWRJbmRleCA/IHRpbWVTZXBhcmF0b3IgOiBcJyBcJyI+PC9zcGFuPjwvdGQ+PHRkIGNsYXNzPSJ0ZXh0LWNlbnRlciI+PGJ1dHRvbiB0YWJpbmRleD0iLTEiIG5nLWlmPSJyb3dbMV0uZGF0ZSIgc3R5bGU9IndpZHRoOiAxMDAlIiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQiIG5nLWNsYXNzPSJ7XCdidG4tcHJpbWFyeVwnOiByb3dbMV0uc2VsZWN0ZWR9IiBuZy1jbGljaz0iJHNlbGVjdChyb3dbMV0uZGF0ZSwgMSkiIG5nLWRpc2FibGVkPSJyb3dbMV0uZGlzYWJsZWQiPjxzcGFuIG5nLWNsYXNzPSJ7XCd0ZXh0LW11dGVkXCc6IHJvd1sxXS5tdXRlZH0iIG5nLWJpbmQ9InJvd1sxXS5sYWJlbCI+PC9zcGFuPjwvYnV0dG9uPjwvdGQ+PHRkIG5nLWlmPSJzaG93QU0iPiZuYnNwOzwvdGQ+PHRkIG5nLWlmPSJzaG93QU0iPjxidXR0b24gdGFiaW5kZXg9Ii0xIiBuZy1zaG93PSJpID09IG1pZEluZGV4IC0gIWlzQU0gKiAxIiBzdHlsZT0id2lkdGg6IDEwMCUiIHR5cGU9ImJ1dHRvbiIgbmctY2xhc3M9IntcJ2J0bi1wcmltYXJ5XCc6ICEhaXNBTX0iIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQiIG5nLWNsaWNrPSIkc3dpdGNoTWVyaWRpYW4oKSIgbmctZGlzYWJsZWQ9ImVsLmRpc2FibGVkIj5BTTwvYnV0dG9uPiA8YnV0dG9uIHRhYmluZGV4PSItMSIgbmctc2hvdz0iaSA9PSBtaWRJbmRleCArIDEgLSAhaXNBTSAqIDEiIHN0eWxlPSJ3aWR0aDogMTAwJSIgdHlwZT0iYnV0dG9uIiBuZy1jbGFzcz0ie1wnYnRuLXByaW1hcnlcJzogIWlzQU19IiBjbGFzcz0iYnRuIGJ0bi1kZWZhdWx0IiBuZy1jbGljaz0iJHN3aXRjaE1lcmlkaWFuKCkiIG5nLWRpc2FibGVkPSJlbC5kaXNhYmxlZCI+UE08L2J1dHRvbj48L3RkPjwvdHI+PC90Ym9keT48dGZvb3Q+PHRyIGNsYXNzPSJ0ZXh0LWNlbnRlciI+PHRoPjxidXR0b24gdGFiaW5kZXg9Ii0xIiB0eXBlPSJidXR0b24iIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQgcHVsbC1sZWZ0IiBuZy1jbGljaz0iJGFycm93QWN0aW9uKDEsIDApIj48aSBjbGFzcz0ie3sgJGljb25Eb3duIH19Ij48L2k+PC9idXR0b24+PC90aD48dGg+Jm5ic3A7PC90aD48dGg+PGJ1dHRvbiB0YWJpbmRleD0iLTEiIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImJ0biBidG4tZGVmYXVsdCBwdWxsLWxlZnQiIG5nLWNsaWNrPSIkYXJyb3dBY3Rpb24oMSwgMSkiPjxpIGNsYXNzPSJ7eyAkaWNvbkRvd24gfX0iPjwvaT48L2J1dHRvbj48L3RoPjwvdHI+PC90Zm9vdD48L3RhYmxlPjwvZGl2PicpOwoKfV0pOwoKLy8gU291cmNlOiB0b29sdGlwLnRwbC5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAudG9vbHRpcCcpLnJ1bihbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKCiAgJHRlbXBsYXRlQ2FjaGUucHV0KCd0b29sdGlwL3Rvb2x0aXAudHBsLmh0bWwnLCAnPGRpdiBjbGFzcz0idG9vbHRpcCBpbiIgbmctc2hvdz0idGl0bGUiPjxkaXYgY2xhc3M9InRvb2x0aXAtYXJyb3ciPjwvZGl2PjxkaXYgY2xhc3M9InRvb2x0aXAtaW5uZXIiIG5nLWJpbmQ9InRpdGxlIj48L2Rpdj48L2Rpdj4nKTsKCn1dKTsKCi8vIFNvdXJjZTogdHlwZWFoZWFkLnRwbC5qcwphbmd1bGFyLm1vZHVsZSgnbWdjcmVhLm5nU3RyYXAudHlwZWFoZWFkJykucnVuKFsnJHRlbXBsYXRlQ2FjaGUnLCBmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewoKICAkdGVtcGxhdGVDYWNoZS5wdXQoJ3R5cGVhaGVhZC90eXBlYWhlYWQudHBsLmh0bWwnLCAnPHVsIHRhYmluZGV4PSItMSIgY2xhc3M9InR5cGVhaGVhZCBkcm9wZG93bi1tZW51IiBuZy1zaG93PSIkaXNWaXNpYmxlKCkiIHJvbGU9InNlbGVjdCI+PGxpIHJvbGU9InByZXNlbnRhdGlvbiIgbmctcmVwZWF0PSJtYXRjaCBpbiAkbWF0Y2hlcyIgbmctY2xhc3M9InthY3RpdmU6ICRpbmRleCA9PSAkYWN0aXZlSW5kZXh9Ij48YSByb2xlPSJtZW51aXRlbSIgdGFiaW5kZXg9Ii0xIiBuZy1jbGljaz0iJHNlbGVjdCgkaW5kZXgsICRldmVudCkiIG5nLWJpbmQ9Im1hdGNoLmxhYmVsIj48L2E+PC9saT48L3VsPicpOwoKfV0pOwoKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwoKLy8hIG1vbWVudC5qcwovLyEgdmVyc2lvbiA6IDIuOC4zCi8vISBhdXRob3JzIDogVGltIFdvb2QsIElza3JlbiBDaGVybmV2LCBNb21lbnQuanMgY29udHJpYnV0b3JzCi8vISBsaWNlbnNlIDogTUlUCi8vISBtb21lbnRqcy5jb20KCihmdW5jdGlvbiAodW5kZWZpbmVkKSB7CiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgQ29uc3RhbnRzCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgogICAgdmFyIG1vbWVudCwKICAgICAgICBWRVJTSU9OID0gJzIuOC4zJywKICAgICAgICAvLyB0aGUgZ2xvYmFsLXNjb3BlIHRoaXMgaXMgTk9UIHRoZSBnbG9iYWwgb2JqZWN0IGluIE5vZGUuanMKICAgICAgICBnbG9iYWxTY29wZSA9IHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnID8gZ2xvYmFsIDogdGhpcywKICAgICAgICBvbGRHbG9iYWxNb21lbnQsCiAgICAgICAgcm91bmQgPSBNYXRoLnJvdW5kLAogICAgICAgIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwKICAgICAgICBpLAoKICAgICAgICBZRUFSID0gMCwKICAgICAgICBNT05USCA9IDEsCiAgICAgICAgREFURSA9IDIsCiAgICAgICAgSE9VUiA9IDMsCiAgICAgICAgTUlOVVRFID0gNCwKICAgICAgICBTRUNPTkQgPSA1LAogICAgICAgIE1JTExJU0VDT05EID0gNiwKCiAgICAgICAgLy8gaW50ZXJuYWwgc3RvcmFnZSBmb3IgbG9jYWxlIGNvbmZpZyBmaWxlcwogICAgICAgIGxvY2FsZXMgPSB7fSwKCiAgICAgICAgLy8gZXh0cmEgbW9tZW50IGludGVybmFsIHByb3BlcnRpZXMgKHBsdWdpbnMgcmVnaXN0ZXIgcHJvcHMgaGVyZSkKICAgICAgICBtb21lbnRQcm9wZXJ0aWVzID0gW10sCgogICAgICAgIC8vIGNoZWNrIGZvciBub2RlSlMKICAgICAgICBoYXNNb2R1bGUgPSAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpLAoKICAgICAgICAvLyBBU1AuTkVUIGpzb24gZGF0ZSBmb3JtYXQgcmVnZXgKICAgICAgICBhc3BOZXRKc29uUmVnZXggPSAvXlwvP0RhdGVcKChcLT9cZCspL2ksCiAgICAgICAgYXNwTmV0VGltZVNwYW5Kc29uUmVnZXggPSAvKFwtKT8oPzooXGQqKVwuKT8oXGQrKVw6KFxkKykoPzpcOihcZCspXC4/KFxkezN9KT8pPy8sCgogICAgICAgIC8vIGZyb20gaHR0cDovL2RvY3MuY2xvc3VyZS1saWJyYXJ5Lmdvb2dsZWNvZGUuY29tL2dpdC9jbG9zdXJlX2dvb2dfZGF0ZV9kYXRlLmpzLnNvdXJjZS5odG1sCiAgICAgICAgLy8gc29tZXdoYXQgbW9yZSBpbiBsaW5lIHdpdGggNC40LjMuMiAyMDA0IHNwZWMsIGJ1dCBhbGxvd3MgZGVjaW1hbCBhbnl3aGVyZQogICAgICAgIGlzb0R1cmF0aW9uUmVnZXggPSAvXigtKT9QKD86KD86KFswLTksLl0qKVkpPyg/OihbMC05LC5dKilNKT8oPzooWzAtOSwuXSopRCk/KD86VCg/OihbMC05LC5dKilIKT8oPzooWzAtOSwuXSopTSk/KD86KFswLTksLl0qKVMpPyk/fChbMC05LC5dKilXKSQvLAoKICAgICAgICAvLyBmb3JtYXQgdG9rZW5zCiAgICAgICAgZm9ybWF0dGluZ1Rva2VucyA9IC8oXFtbXlxbXSpcXSl8KFxcKT8oTW98TU0/TT9NP3xEb3xERERvfEREP0Q/RD98ZGRkP2Q/fGRvP3x3W298d10/fFdbb3xXXT98UXxZWVlZWVl8WVlZWVl8WVlZWXxZWXxnZyhnZ2c/KT98R0coR0dHPyk/fGV8RXxhfEF8aGg/fEhIP3xtbT98c3M/fFN7MSw0fXxYfHp6P3xaWj98LikvZywKICAgICAgICBsb2NhbEZvcm1hdHRpbmdUb2tlbnMgPSAvKFxbW15cW10qXF0pfChcXCk/KExUfExMP0w/TD98bHsxLDR9KS9nLAoKICAgICAgICAvLyBwYXJzaW5nIHRva2VuIHJlZ2V4ZXMKICAgICAgICBwYXJzZVRva2VuT25lT3JUd29EaWdpdHMgPSAvXGRcZD8vLCAvLyAwIC0gOTkKICAgICAgICBwYXJzZVRva2VuT25lVG9UaHJlZURpZ2l0cyA9IC9cZHsxLDN9LywgLy8gMCAtIDk5OQogICAgICAgIHBhcnNlVG9rZW5PbmVUb0ZvdXJEaWdpdHMgPSAvXGR7MSw0fS8sIC8vIDAgLSA5OTk5CiAgICAgICAgcGFyc2VUb2tlbk9uZVRvU2l4RGlnaXRzID0gL1srXC1dP1xkezEsNn0vLCAvLyAtOTk5LDk5OSAtIDk5OSw5OTkKICAgICAgICBwYXJzZVRva2VuRGlnaXRzID0gL1xkKy8sIC8vIG5vbnplcm8gbnVtYmVyIG9mIGRpZ2l0cwogICAgICAgIHBhcnNlVG9rZW5Xb3JkID0gL1swLTldKlsnYS16XHUwMEEwLVx1MDVGRlx1MDcwMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0rfFtcdTA2MDAtXHUwNkZGXC9dKyhccyo/W1x1MDYwMC1cdTA2RkZdKyl7MSwyfS9pLCAvLyBhbnkgd29yZCAob3IgdHdvKSBjaGFyYWN0ZXJzIG9yIG51bWJlcnMgaW5jbHVkaW5nIHR3by90aHJlZSB3b3JkIG1vbnRoIGluIGFyYWJpYy4KICAgICAgICBwYXJzZVRva2VuVGltZXpvbmUgPSAvWnxbXCtcLV1cZFxkOj9cZFxkL2dpLCAvLyArMDA6MDAgLTAwOjAwICswMDAwIC0wMDAwIG9yIFoKICAgICAgICBwYXJzZVRva2VuVCA9IC9UL2ksIC8vIFQgKElTTyBzZXBhcmF0b3IpCiAgICAgICAgcGFyc2VUb2tlblRpbWVzdGFtcE1zID0gL1tcK1wtXT9cZCsoXC5cZHsxLDN9KT8vLCAvLyAxMjM0NTY3ODkgMTIzNDU2Nzg5LjEyMwogICAgICAgIHBhcnNlVG9rZW5PcmRpbmFsID0gL1xkezEsMn0vLAoKICAgICAgICAvL3N0cmljdCBwYXJzaW5nIHJlZ2V4ZXMKICAgICAgICBwYXJzZVRva2VuT25lRGlnaXQgPSAvXGQvLCAvLyAwIC0gOQogICAgICAgIHBhcnNlVG9rZW5Ud29EaWdpdHMgPSAvXGRcZC8sIC8vIDAwIC0gOTkKICAgICAgICBwYXJzZVRva2VuVGhyZWVEaWdpdHMgPSAvXGR7M30vLCAvLyAwMDAgLSA5OTkKICAgICAgICBwYXJzZVRva2VuRm91ckRpZ2l0cyA9IC9cZHs0fS8sIC8vIDAwMDAgLSA5OTk5CiAgICAgICAgcGFyc2VUb2tlblNpeERpZ2l0cyA9IC9bKy1dP1xkezZ9LywgLy8gLTk5OSw5OTkgLSA5OTksOTk5CiAgICAgICAgcGFyc2VUb2tlblNpZ25lZE51bWJlciA9IC9bKy1dP1xkKy8sIC8vIC1pbmYgLSBpbmYKCiAgICAgICAgLy8gaXNvIDg2MDEgcmVnZXgKICAgICAgICAvLyAwMDAwLTAwLTAwIDAwMDAtVzAwIG9yIDAwMDAtVzAwLTAgKyBUICsgMDAgb3IgMDA6MDAgb3IgMDA6MDA6MDAgb3IgMDA6MDA6MDAuMDAwICsgKzAwOjAwIG9yICswMDAwIG9yICswMCkKICAgICAgICBpc29SZWdleCA9IC9eXHMqKD86WystXVxkezZ9fFxkezR9KS0oPzooXGRcZC1cZFxkKXwoV1xkXGQkKXwoV1xkXGQtXGQpfChcZFxkXGQpKSgoVHwgKShcZFxkKDpcZFxkKDpcZFxkKFwuXGQrKT8pPyk/KT8oW1wrXC1dXGRcZCg/Ojo/XGRcZCk/fFxzKlopPyk/JC8sCgogICAgICAgIGlzb0Zvcm1hdCA9ICdZWVlZLU1NLUREVEhIOm1tOnNzWicsCgogICAgICAgIGlzb0RhdGVzID0gWwogICAgICAgICAgICBbJ1lZWVlZWS1NTS1ERCcsIC9bKy1dXGR7Nn0tXGR7Mn0tXGR7Mn0vXSwKICAgICAgICAgICAgWydZWVlZLU1NLUREJywgL1xkezR9LVxkezJ9LVxkezJ9L10sCiAgICAgICAgICAgIFsnR0dHRy1bV11XVy1FJywgL1xkezR9LVdcZHsyfS1cZC9dLAogICAgICAgICAgICBbJ0dHR0ctW1ddV1cnLCAvXGR7NH0tV1xkezJ9L10sCiAgICAgICAgICAgIFsnWVlZWS1EREQnLCAvXGR7NH0tXGR7M30vXQogICAgICAgIF0sCgogICAgICAgIC8vIGlzbyB0aW1lIGZvcm1hdHMgYW5kIHJlZ2V4ZXMKICAgICAgICBpc29UaW1lcyA9IFsKICAgICAgICAgICAgWydISDptbTpzcy5TU1NTJywgLyhUfCApXGRcZDpcZFxkOlxkXGRcLlxkKy9dLAogICAgICAgICAgICBbJ0hIOm1tOnNzJywgLyhUfCApXGRcZDpcZFxkOlxkXGQvXSwKICAgICAgICAgICAgWydISDptbScsIC8oVHwgKVxkXGQ6XGRcZC9dLAogICAgICAgICAgICBbJ0hIJywgLyhUfCApXGRcZC9dCiAgICAgICAgXSwKCiAgICAgICAgLy8gdGltZXpvbmUgY2h1bmtlciAnKzEwOjAwJyA+IFsnMTAnLCAnMDAnXSBvciAnLTE1MzAnID4gWyctMTUnLCAnMzAnXQogICAgICAgIHBhcnNlVGltZXpvbmVDaHVua2VyID0gLyhbXCtcLV18XGRcZCkvZ2ksCgogICAgICAgIC8vIGdldHRlciBhbmQgc2V0dGVyIG5hbWVzCiAgICAgICAgcHJveHlHZXR0ZXJzQW5kU2V0dGVycyA9ICdEYXRlfEhvdXJzfE1pbnV0ZXN8U2Vjb25kc3xNaWxsaXNlY29uZHMnLnNwbGl0KCd8JyksCiAgICAgICAgdW5pdE1pbGxpc2Vjb25kRmFjdG9ycyA9IHsKICAgICAgICAgICAgJ01pbGxpc2Vjb25kcycgOiAxLAogICAgICAgICAgICAnU2Vjb25kcycgOiAxZTMsCiAgICAgICAgICAgICdNaW51dGVzJyA6IDZlNCwKICAgICAgICAgICAgJ0hvdXJzJyA6IDM2ZTUsCiAgICAgICAgICAgICdEYXlzJyA6IDg2NGU1LAogICAgICAgICAgICAnTW9udGhzJyA6IDI1OTJlNiwKICAgICAgICAgICAgJ1llYXJzJyA6IDMxNTM2ZTYKICAgICAgICB9LAoKICAgICAgICB1bml0QWxpYXNlcyA9IHsKICAgICAgICAgICAgbXMgOiAnbWlsbGlzZWNvbmQnLAogICAgICAgICAgICBzIDogJ3NlY29uZCcsCiAgICAgICAgICAgIG0gOiAnbWludXRlJywKICAgICAgICAgICAgaCA6ICdob3VyJywKICAgICAgICAgICAgZCA6ICdkYXknLAogICAgICAgICAgICBEIDogJ2RhdGUnLAogICAgICAgICAgICB3IDogJ3dlZWsnLAogICAgICAgICAgICBXIDogJ2lzb1dlZWsnLAogICAgICAgICAgICBNIDogJ21vbnRoJywKICAgICAgICAgICAgUSA6ICdxdWFydGVyJywKICAgICAgICAgICAgeSA6ICd5ZWFyJywKICAgICAgICAgICAgREREIDogJ2RheU9mWWVhcicsCiAgICAgICAgICAgIGUgOiAnd2Vla2RheScsCiAgICAgICAgICAgIEUgOiAnaXNvV2Vla2RheScsCiAgICAgICAgICAgIGdnOiAnd2Vla1llYXInLAogICAgICAgICAgICBHRzogJ2lzb1dlZWtZZWFyJwogICAgICAgIH0sCgogICAgICAgIGNhbWVsRnVuY3Rpb25zID0gewogICAgICAgICAgICBkYXlvZnllYXIgOiAnZGF5T2ZZZWFyJywKICAgICAgICAgICAgaXNvd2Vla2RheSA6ICdpc29XZWVrZGF5JywKICAgICAgICAgICAgaXNvd2VlayA6ICdpc29XZWVrJywKICAgICAgICAgICAgd2Vla3llYXIgOiAnd2Vla1llYXInLAogICAgICAgICAgICBpc293ZWVreWVhciA6ICdpc29XZWVrWWVhcicKICAgICAgICB9LAoKICAgICAgICAvLyBmb3JtYXQgZnVuY3Rpb24gc3RyaW5ncwogICAgICAgIGZvcm1hdEZ1bmN0aW9ucyA9IHt9LAoKICAgICAgICAvLyBkZWZhdWx0IHJlbGF0aXZlIHRpbWUgdGhyZXNob2xkcwogICAgICAgIHJlbGF0aXZlVGltZVRocmVzaG9sZHMgPSB7CiAgICAgICAgICAgIHM6IDQ1LCAgLy8gc2Vjb25kcyB0byBtaW51dGUKICAgICAgICAgICAgbTogNDUsICAvLyBtaW51dGVzIHRvIGhvdXIKICAgICAgICAgICAgaDogMjIsICAvLyBob3VycyB0byBkYXkKICAgICAgICAgICAgZDogMjYsICAvLyBkYXlzIHRvIG1vbnRoCiAgICAgICAgICAgIE06IDExICAgLy8gbW9udGhzIHRvIHllYXIKICAgICAgICB9LAoKICAgICAgICAvLyB0b2tlbnMgdG8gb3JkaW5hbGl6ZSBhbmQgcGFkCiAgICAgICAgb3JkaW5hbGl6ZVRva2VucyA9ICdEREQgdyBXIE0gRCBkJy5zcGxpdCgnICcpLAogICAgICAgIHBhZGRlZFRva2VucyA9ICdNIEQgSCBoIG0gcyB3IFcnLnNwbGl0KCcgJyksCgogICAgICAgIGZvcm1hdFRva2VuRnVuY3Rpb25zID0gewogICAgICAgICAgICBNICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubW9udGgoKSArIDE7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIE1NTSAgOiBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkubW9udGhzU2hvcnQodGhpcywgZm9ybWF0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgTU1NTSA6IGZ1bmN0aW9uIChmb3JtYXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS5tb250aHModGhpcywgZm9ybWF0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgRCAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRhdGUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgREREICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRheU9mWWVhcigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF5KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRkICAgOiBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkud2Vla2RheXNNaW4odGhpcywgZm9ybWF0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGRkICA6IGZ1bmN0aW9uIChmb3JtYXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS53ZWVrZGF5c1Nob3J0KHRoaXMsIGZvcm1hdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRkZGQgOiBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkud2Vla2RheXModGhpcywgZm9ybWF0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdyAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLndlZWsoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgVyAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlzb1dlZWsoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgWVkgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy55ZWFyKCkgJSAxMDAsIDIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBZWVlZIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLnllYXIoKSwgNCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFlZWVlZIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLnllYXIoKSwgNSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFlZWVlZWSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciB5ID0gdGhpcy55ZWFyKCksIHNpZ24gPSB5ID49IDAgPyAnKycgOiAnLSc7CiAgICAgICAgICAgICAgICByZXR1cm4gc2lnbiArIGxlZnRaZXJvRmlsbChNYXRoLmFicyh5KSwgNik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdnICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKHRoaXMud2Vla1llYXIoKSAlIDEwMCwgMik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdnZ2cgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKHRoaXMud2Vla1llYXIoKSwgNCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdnZ2dnIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLndlZWtZZWFyKCksIDUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBHRyAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLmlzb1dlZWtZZWFyKCkgJSAxMDAsIDIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBHR0dHIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLmlzb1dlZWtZZWFyKCksIDQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBHR0dHRyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy5pc29XZWVrWWVhcigpLCA1KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLndlZWtkYXkoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgRSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlzb1dlZWtkYXkoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYSAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS5tZXJpZGllbSh0aGlzLmhvdXJzKCksIHRoaXMubWludXRlcygpLCB0cnVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgQSAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS5tZXJpZGllbSh0aGlzLmhvdXJzKCksIHRoaXMubWludXRlcygpLCBmYWxzZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEggICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ob3VycygpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBoICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaG91cnMoKSAlIDEyIHx8IDEyOwogICAgICAgICAgICB9LAogICAgICAgICAgICBtICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubWludXRlcygpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2Vjb25kcygpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBTICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRvSW50KHRoaXMubWlsbGlzZWNvbmRzKCkgLyAxMDApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBTUyAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0b0ludCh0aGlzLm1pbGxpc2Vjb25kcygpIC8gMTApLCAyKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgU1NTICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy5taWxsaXNlY29uZHMoKSwgMyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFNTU1MgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKHRoaXMubWlsbGlzZWNvbmRzKCksIDMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBaICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGEgPSAtdGhpcy56b25lKCksCiAgICAgICAgICAgICAgICAgICAgYiA9ICcrJzsKICAgICAgICAgICAgICAgIGlmIChhIDwgMCkgewogICAgICAgICAgICAgICAgICAgIGEgPSAtYTsKICAgICAgICAgICAgICAgICAgICBiID0gJy0nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGIgKyBsZWZ0WmVyb0ZpbGwodG9JbnQoYSAvIDYwKSwgMikgKyAnOicgKyBsZWZ0WmVyb0ZpbGwodG9JbnQoYSkgJSA2MCwgMik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFpaICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYSA9IC10aGlzLnpvbmUoKSwKICAgICAgICAgICAgICAgICAgICBiID0gJysnOwogICAgICAgICAgICAgICAgaWYgKGEgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgYSA9IC1hOwogICAgICAgICAgICAgICAgICAgIGIgPSAnLSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYiArIGxlZnRaZXJvRmlsbCh0b0ludChhIC8gNjApLCAyKSArIGxlZnRaZXJvRmlsbCh0b0ludChhKSAlIDYwLCAyKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgeiA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnpvbmVBYmJyKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHp6IDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuem9uZU5hbWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgWCAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnVuaXgoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgUSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnF1YXJ0ZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGRlcHJlY2F0aW9ucyA9IHt9LAoKICAgICAgICBsaXN0cyA9IFsnbW9udGhzJywgJ21vbnRoc1Nob3J0JywgJ3dlZWtkYXlzJywgJ3dlZWtkYXlzU2hvcnQnLCAnd2Vla2RheXNNaW4nXTsKCiAgICAvLyBQaWNrIHRoZSBmaXJzdCBkZWZpbmVkIG9mIHR3byBvciB0aHJlZSBhcmd1bWVudHMuIGRmbCBjb21lcyBmcm9tCiAgICAvLyBkZWZhdWx0LgogICAgZnVuY3Rpb24gZGZsKGEsIGIsIGMpIHsKICAgICAgICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgY2FzZSAyOiByZXR1cm4gYSAhPSBudWxsID8gYSA6IGI7CiAgICAgICAgICAgIGNhc2UgMzogcmV0dXJuIGEgIT0gbnVsbCA/IGEgOiBiICE9IG51bGwgPyBiIDogYzsKICAgICAgICAgICAgZGVmYXVsdDogdGhyb3cgbmV3IEVycm9yKCdJbXBsZW1lbnQgbWUnKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaGFzT3duUHJvcChhLCBiKSB7CiAgICAgICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwoYSwgYik7CiAgICB9CgogICAgZnVuY3Rpb24gZGVmYXVsdFBhcnNpbmdGbGFncygpIHsKICAgICAgICAvLyBXZSBuZWVkIHRvIGRlZXAgY2xvbmUgdGhpcyBvYmplY3QsIGFuZCBlczUgc3RhbmRhcmQgaXMgbm90IHZlcnkKICAgICAgICAvLyBoZWxwZnVsLgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGVtcHR5IDogZmFsc2UsCiAgICAgICAgICAgIHVudXNlZFRva2VucyA6IFtdLAogICAgICAgICAgICB1bnVzZWRJbnB1dCA6IFtdLAogICAgICAgICAgICBvdmVyZmxvdyA6IC0yLAogICAgICAgICAgICBjaGFyc0xlZnRPdmVyIDogMCwKICAgICAgICAgICAgbnVsbElucHV0IDogZmFsc2UsCiAgICAgICAgICAgIGludmFsaWRNb250aCA6IG51bGwsCiAgICAgICAgICAgIGludmFsaWRGb3JtYXQgOiBmYWxzZSwKICAgICAgICAgICAgdXNlckludmFsaWRhdGVkIDogZmFsc2UsCiAgICAgICAgICAgIGlzbzogZmFsc2UKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIHByaW50TXNnKG1zZykgewogICAgICAgIGlmIChtb21lbnQuc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmdzID09PSBmYWxzZSAmJgogICAgICAgICAgICAgICAgdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnICYmIGNvbnNvbGUud2FybikgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ0RlcHJlY2F0aW9uIHdhcm5pbmc6ICcgKyBtc2cpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBkZXByZWNhdGUobXNnLCBmbikgewogICAgICAgIHZhciBmaXJzdFRpbWUgPSB0cnVlOwogICAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoZmlyc3RUaW1lKSB7CiAgICAgICAgICAgICAgICBwcmludE1zZyhtc2cpOwogICAgICAgICAgICAgICAgZmlyc3RUaW1lID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwgZm4pOwogICAgfQoKICAgIGZ1bmN0aW9uIGRlcHJlY2F0ZVNpbXBsZShuYW1lLCBtc2cpIHsKICAgICAgICBpZiAoIWRlcHJlY2F0aW9uc1tuYW1lXSkgewogICAgICAgICAgICBwcmludE1zZyhtc2cpOwogICAgICAgICAgICBkZXByZWNhdGlvbnNbbmFtZV0gPSB0cnVlOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBwYWRUb2tlbihmdW5jLCBjb3VudCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKGZ1bmMuY2FsbCh0aGlzLCBhKSwgY291bnQpOwogICAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBvcmRpbmFsaXplVG9rZW4oZnVuYywgcGVyaW9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS5vcmRpbmFsKGZ1bmMuY2FsbCh0aGlzLCBhKSwgcGVyaW9kKTsKICAgICAgICB9OwogICAgfQoKICAgIHdoaWxlIChvcmRpbmFsaXplVG9rZW5zLmxlbmd0aCkgewogICAgICAgIGkgPSBvcmRpbmFsaXplVG9rZW5zLnBvcCgpOwogICAgICAgIGZvcm1hdFRva2VuRnVuY3Rpb25zW2kgKyAnbyddID0gb3JkaW5hbGl6ZVRva2VuKGZvcm1hdFRva2VuRnVuY3Rpb25zW2ldLCBpKTsKICAgIH0KICAgIHdoaWxlIChwYWRkZWRUb2tlbnMubGVuZ3RoKSB7CiAgICAgICAgaSA9IHBhZGRlZFRva2Vucy5wb3AoKTsKICAgICAgICBmb3JtYXRUb2tlbkZ1bmN0aW9uc1tpICsgaV0gPSBwYWRUb2tlbihmb3JtYXRUb2tlbkZ1bmN0aW9uc1tpXSwgMik7CiAgICB9CiAgICBmb3JtYXRUb2tlbkZ1bmN0aW9ucy5EREREID0gcGFkVG9rZW4oZm9ybWF0VG9rZW5GdW5jdGlvbnMuRERELCAzKTsKCgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIENvbnN0cnVjdG9ycwogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKICAgIGZ1bmN0aW9uIExvY2FsZSgpIHsKICAgIH0KCiAgICAvLyBNb21lbnQgcHJvdG90eXBlIG9iamVjdAogICAgZnVuY3Rpb24gTW9tZW50KGNvbmZpZywgc2tpcE92ZXJmbG93KSB7CiAgICAgICAgaWYgKHNraXBPdmVyZmxvdyAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgY2hlY2tPdmVyZmxvdyhjb25maWcpOwogICAgICAgIH0KICAgICAgICBjb3B5Q29uZmlnKHRoaXMsIGNvbmZpZyk7CiAgICAgICAgdGhpcy5fZCA9IG5ldyBEYXRlKCtjb25maWcuX2QpOwogICAgfQoKICAgIC8vIER1cmF0aW9uIENvbnN0cnVjdG9yCiAgICBmdW5jdGlvbiBEdXJhdGlvbihkdXJhdGlvbikgewogICAgICAgIHZhciBub3JtYWxpemVkSW5wdXQgPSBub3JtYWxpemVPYmplY3RVbml0cyhkdXJhdGlvbiksCiAgICAgICAgICAgIHllYXJzID0gbm9ybWFsaXplZElucHV0LnllYXIgfHwgMCwKICAgICAgICAgICAgcXVhcnRlcnMgPSBub3JtYWxpemVkSW5wdXQucXVhcnRlciB8fCAwLAogICAgICAgICAgICBtb250aHMgPSBub3JtYWxpemVkSW5wdXQubW9udGggfHwgMCwKICAgICAgICAgICAgd2Vla3MgPSBub3JtYWxpemVkSW5wdXQud2VlayB8fCAwLAogICAgICAgICAgICBkYXlzID0gbm9ybWFsaXplZElucHV0LmRheSB8fCAwLAogICAgICAgICAgICBob3VycyA9IG5vcm1hbGl6ZWRJbnB1dC5ob3VyIHx8IDAsCiAgICAgICAgICAgIG1pbnV0ZXMgPSBub3JtYWxpemVkSW5wdXQubWludXRlIHx8IDAsCiAgICAgICAgICAgIHNlY29uZHMgPSBub3JtYWxpemVkSW5wdXQuc2Vjb25kIHx8IDAsCiAgICAgICAgICAgIG1pbGxpc2Vjb25kcyA9IG5vcm1hbGl6ZWRJbnB1dC5taWxsaXNlY29uZCB8fCAwOwoKICAgICAgICAvLyByZXByZXNlbnRhdGlvbiBmb3IgZGF0ZUFkZFJlbW92ZQogICAgICAgIHRoaXMuX21pbGxpc2Vjb25kcyA9ICttaWxsaXNlY29uZHMgKwogICAgICAgICAgICBzZWNvbmRzICogMWUzICsgLy8gMTAwMAogICAgICAgICAgICBtaW51dGVzICogNmU0ICsgLy8gMTAwMCAqIDYwCiAgICAgICAgICAgIGhvdXJzICogMzZlNTsgLy8gMTAwMCAqIDYwICogNjAKICAgICAgICAvLyBCZWNhdXNlIG9mIGRhdGVBZGRSZW1vdmUgdHJlYXRzIDI0IGhvdXJzIGFzIGRpZmZlcmVudCBmcm9tIGEKICAgICAgICAvLyBkYXkgd2hlbiB3b3JraW5nIGFyb3VuZCBEU1QsIHdlIG5lZWQgdG8gc3RvcmUgdGhlbSBzZXBhcmF0ZWx5CiAgICAgICAgdGhpcy5fZGF5cyA9ICtkYXlzICsKICAgICAgICAgICAgd2Vla3MgKiA3OwogICAgICAgIC8vIEl0IGlzIGltcG9zc2libGUgdHJhbnNsYXRlIG1vbnRocyBpbnRvIGRheXMgd2l0aG91dCBrbm93aW5nCiAgICAgICAgLy8gd2hpY2ggbW9udGhzIHlvdSBhcmUgYXJlIHRhbGtpbmcgYWJvdXQsIHNvIHdlIGhhdmUgdG8gc3RvcmUKICAgICAgICAvLyBpdCBzZXBhcmF0ZWx5LgogICAgICAgIHRoaXMuX21vbnRocyA9ICttb250aHMgKwogICAgICAgICAgICBxdWFydGVycyAqIDMgKwogICAgICAgICAgICB5ZWFycyAqIDEyOwoKICAgICAgICB0aGlzLl9kYXRhID0ge307CgogICAgICAgIHRoaXMuX2xvY2FsZSA9IG1vbWVudC5sb2NhbGVEYXRhKCk7CgogICAgICAgIHRoaXMuX2J1YmJsZSgpOwogICAgfQoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBIZWxwZXJzCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoKICAgIGZ1bmN0aW9uIGV4dGVuZChhLCBiKSB7CiAgICAgICAgZm9yICh2YXIgaSBpbiBiKSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wKGIsIGkpKSB7CiAgICAgICAgICAgICAgICBhW2ldID0gYltpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGhhc093blByb3AoYiwgJ3RvU3RyaW5nJykpIHsKICAgICAgICAgICAgYS50b1N0cmluZyA9IGIudG9TdHJpbmc7CiAgICAgICAgfQoKICAgICAgICBpZiAoaGFzT3duUHJvcChiLCAndmFsdWVPZicpKSB7CiAgICAgICAgICAgIGEudmFsdWVPZiA9IGIudmFsdWVPZjsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvcHlDb25maWcodG8sIGZyb20pIHsKICAgICAgICB2YXIgaSwgcHJvcCwgdmFsOwoKICAgICAgICBpZiAodHlwZW9mIGZyb20uX2lzQU1vbWVudE9iamVjdCAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgdG8uX2lzQU1vbWVudE9iamVjdCA9IGZyb20uX2lzQU1vbWVudE9iamVjdDsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBmcm9tLl9pICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICB0by5faSA9IGZyb20uX2k7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZnJvbS5fZiAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgdG8uX2YgPSBmcm9tLl9mOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGZyb20uX2wgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHRvLl9sID0gZnJvbS5fbDsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBmcm9tLl9zdHJpY3QgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHRvLl9zdHJpY3QgPSBmcm9tLl9zdHJpY3Q7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZnJvbS5fdHptICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICB0by5fdHptID0gZnJvbS5fdHptOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGZyb20uX2lzVVRDICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICB0by5faXNVVEMgPSBmcm9tLl9pc1VUQzsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBmcm9tLl9vZmZzZXQgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHRvLl9vZmZzZXQgPSBmcm9tLl9vZmZzZXQ7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZnJvbS5fcGYgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHRvLl9wZiA9IGZyb20uX3BmOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGZyb20uX2xvY2FsZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgdG8uX2xvY2FsZSA9IGZyb20uX2xvY2FsZTsKICAgICAgICB9CgogICAgICAgIGlmIChtb21lbnRQcm9wZXJ0aWVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgZm9yIChpIGluIG1vbWVudFByb3BlcnRpZXMpIHsKICAgICAgICAgICAgICAgIHByb3AgPSBtb21lbnRQcm9wZXJ0aWVzW2ldOwogICAgICAgICAgICAgICAgdmFsID0gZnJvbVtwcm9wXTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgICAgIHRvW3Byb3BdID0gdmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdG87CiAgICB9CgogICAgZnVuY3Rpb24gYWJzUm91bmQobnVtYmVyKSB7CiAgICAgICAgaWYgKG51bWJlciA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGguY2VpbChudW1iZXIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKG51bWJlcik7CiAgICAgICAgfQogICAgfQoKICAgIC8vIGxlZnQgemVybyBmaWxsIGEgbnVtYmVyCiAgICAvLyBzZWUgaHR0cDovL2pzcGVyZi5jb20vbGVmdC16ZXJvLWZpbGxpbmcgZm9yIHBlcmZvcm1hbmNlIGNvbXBhcmlzb24KICAgIGZ1bmN0aW9uIGxlZnRaZXJvRmlsbChudW1iZXIsIHRhcmdldExlbmd0aCwgZm9yY2VTaWduKSB7CiAgICAgICAgdmFyIG91dHB1dCA9ICcnICsgTWF0aC5hYnMobnVtYmVyKSwKICAgICAgICAgICAgc2lnbiA9IG51bWJlciA+PSAwOwoKICAgICAgICB3aGlsZSAob3V0cHV0Lmxlbmd0aCA8IHRhcmdldExlbmd0aCkgewogICAgICAgICAgICBvdXRwdXQgPSAnMCcgKyBvdXRwdXQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiAoc2lnbiA/IChmb3JjZVNpZ24gPyAnKycgOiAnJykgOiAnLScpICsgb3V0cHV0OwogICAgfQoKICAgIGZ1bmN0aW9uIHBvc2l0aXZlTW9tZW50c0RpZmZlcmVuY2UoYmFzZSwgb3RoZXIpIHsKICAgICAgICB2YXIgcmVzID0ge21pbGxpc2Vjb25kczogMCwgbW9udGhzOiAwfTsKCiAgICAgICAgcmVzLm1vbnRocyA9IG90aGVyLm1vbnRoKCkgLSBiYXNlLm1vbnRoKCkgKwogICAgICAgICAgICAob3RoZXIueWVhcigpIC0gYmFzZS55ZWFyKCkpICogMTI7CiAgICAgICAgaWYgKGJhc2UuY2xvbmUoKS5hZGQocmVzLm1vbnRocywgJ00nKS5pc0FmdGVyKG90aGVyKSkgewogICAgICAgICAgICAtLXJlcy5tb250aHM7CiAgICAgICAgfQoKICAgICAgICByZXMubWlsbGlzZWNvbmRzID0gK290aGVyIC0gKyhiYXNlLmNsb25lKCkuYWRkKHJlcy5tb250aHMsICdNJykpOwoKICAgICAgICByZXR1cm4gcmVzOwogICAgfQoKICAgIGZ1bmN0aW9uIG1vbWVudHNEaWZmZXJlbmNlKGJhc2UsIG90aGVyKSB7CiAgICAgICAgdmFyIHJlczsKICAgICAgICBvdGhlciA9IG1ha2VBcyhvdGhlciwgYmFzZSk7CiAgICAgICAgaWYgKGJhc2UuaXNCZWZvcmUob3RoZXIpKSB7CiAgICAgICAgICAgIHJlcyA9IHBvc2l0aXZlTW9tZW50c0RpZmZlcmVuY2UoYmFzZSwgb3RoZXIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlcyA9IHBvc2l0aXZlTW9tZW50c0RpZmZlcmVuY2Uob3RoZXIsIGJhc2UpOwogICAgICAgICAgICByZXMubWlsbGlzZWNvbmRzID0gLXJlcy5taWxsaXNlY29uZHM7CiAgICAgICAgICAgIHJlcy5tb250aHMgPSAtcmVzLm1vbnRoczsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXM7CiAgICB9CgogICAgLy8gVE9ETzogcmVtb3ZlICduYW1lJyBhcmcgYWZ0ZXIgZGVwcmVjYXRpb24gaXMgcmVtb3ZlZAogICAgZnVuY3Rpb24gY3JlYXRlQWRkZXIoZGlyZWN0aW9uLCBuYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWwsIHBlcmlvZCkgewogICAgICAgICAgICB2YXIgZHVyLCB0bXA7CiAgICAgICAgICAgIC8vaW52ZXJ0IHRoZSBhcmd1bWVudHMsIGJ1dCBjb21wbGFpbiBhYm91dCBpdAogICAgICAgICAgICBpZiAocGVyaW9kICE9PSBudWxsICYmICFpc05hTigrcGVyaW9kKSkgewogICAgICAgICAgICAgICAgZGVwcmVjYXRlU2ltcGxlKG5hbWUsICdtb21lbnQoKS4nICsgbmFtZSAgKyAnKHBlcmlvZCwgbnVtYmVyKSBpcyBkZXByZWNhdGVkLiBQbGVhc2UgdXNlIG1vbWVudCgpLicgKyBuYW1lICsgJyhudW1iZXIsIHBlcmlvZCkuJyk7CiAgICAgICAgICAgICAgICB0bXAgPSB2YWw7IHZhbCA9IHBlcmlvZDsgcGVyaW9kID0gdG1wOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YWwgPSB0eXBlb2YgdmFsID09PSAnc3RyaW5nJyA/ICt2YWwgOiB2YWw7CiAgICAgICAgICAgIGR1ciA9IG1vbWVudC5kdXJhdGlvbih2YWwsIHBlcmlvZCk7CiAgICAgICAgICAgIGFkZE9yU3VidHJhY3REdXJhdGlvbkZyb21Nb21lbnQodGhpcywgZHVyLCBkaXJlY3Rpb24pOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGFkZE9yU3VidHJhY3REdXJhdGlvbkZyb21Nb21lbnQobW9tLCBkdXJhdGlvbiwgaXNBZGRpbmcsIHVwZGF0ZU9mZnNldCkgewogICAgICAgIHZhciBtaWxsaXNlY29uZHMgPSBkdXJhdGlvbi5fbWlsbGlzZWNvbmRzLAogICAgICAgICAgICBkYXlzID0gZHVyYXRpb24uX2RheXMsCiAgICAgICAgICAgIG1vbnRocyA9IGR1cmF0aW9uLl9tb250aHM7CiAgICAgICAgdXBkYXRlT2Zmc2V0ID0gdXBkYXRlT2Zmc2V0ID09IG51bGwgPyB0cnVlIDogdXBkYXRlT2Zmc2V0OwoKICAgICAgICBpZiAobWlsbGlzZWNvbmRzKSB7CiAgICAgICAgICAgIG1vbS5fZC5zZXRUaW1lKCttb20uX2QgKyBtaWxsaXNlY29uZHMgKiBpc0FkZGluZyk7CiAgICAgICAgfQogICAgICAgIGlmIChkYXlzKSB7CiAgICAgICAgICAgIHJhd1NldHRlcihtb20sICdEYXRlJywgcmF3R2V0dGVyKG1vbSwgJ0RhdGUnKSArIGRheXMgKiBpc0FkZGluZyk7CiAgICAgICAgfQogICAgICAgIGlmIChtb250aHMpIHsKICAgICAgICAgICAgcmF3TW9udGhTZXR0ZXIobW9tLCByYXdHZXR0ZXIobW9tLCAnTW9udGgnKSArIG1vbnRocyAqIGlzQWRkaW5nKTsKICAgICAgICB9CiAgICAgICAgaWYgKHVwZGF0ZU9mZnNldCkgewogICAgICAgICAgICBtb21lbnQudXBkYXRlT2Zmc2V0KG1vbSwgZGF5cyB8fCBtb250aHMpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBjaGVjayBpZiBpcyBhbiBhcnJheQogICAgZnVuY3Rpb24gaXNBcnJheShpbnB1dCkgewogICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaW5wdXQpID09PSAnW29iamVjdCBBcnJheV0nOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzRGF0ZShpbnB1dCkgewogICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaW5wdXQpID09PSAnW29iamVjdCBEYXRlXScgfHwKICAgICAgICAgICAgaW5wdXQgaW5zdGFuY2VvZiBEYXRlOwogICAgfQoKICAgIC8vIGNvbXBhcmUgdHdvIGFycmF5cywgcmV0dXJuIHRoZSBudW1iZXIgb2YgZGlmZmVyZW5jZXMKICAgIGZ1bmN0aW9uIGNvbXBhcmVBcnJheXMoYXJyYXkxLCBhcnJheTIsIGRvbnRDb252ZXJ0KSB7CiAgICAgICAgdmFyIGxlbiA9IE1hdGgubWluKGFycmF5MS5sZW5ndGgsIGFycmF5Mi5sZW5ndGgpLAogICAgICAgICAgICBsZW5ndGhEaWZmID0gTWF0aC5hYnMoYXJyYXkxLmxlbmd0aCAtIGFycmF5Mi5sZW5ndGgpLAogICAgICAgICAgICBkaWZmcyA9IDAsCiAgICAgICAgICAgIGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmICgoZG9udENvbnZlcnQgJiYgYXJyYXkxW2ldICE9PSBhcnJheTJbaV0pIHx8CiAgICAgICAgICAgICAgICAoIWRvbnRDb252ZXJ0ICYmIHRvSW50KGFycmF5MVtpXSkgIT09IHRvSW50KGFycmF5MltpXSkpKSB7CiAgICAgICAgICAgICAgICBkaWZmcysrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBkaWZmcyArIGxlbmd0aERpZmY7CiAgICB9CgogICAgZnVuY3Rpb24gbm9ybWFsaXplVW5pdHModW5pdHMpIHsKICAgICAgICBpZiAodW5pdHMpIHsKICAgICAgICAgICAgdmFyIGxvd2VyZWQgPSB1bml0cy50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoLyguKXMkLywgJyQxJyk7CiAgICAgICAgICAgIHVuaXRzID0gdW5pdEFsaWFzZXNbdW5pdHNdIHx8IGNhbWVsRnVuY3Rpb25zW2xvd2VyZWRdIHx8IGxvd2VyZWQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1bml0czsKICAgIH0KCiAgICBmdW5jdGlvbiBub3JtYWxpemVPYmplY3RVbml0cyhpbnB1dE9iamVjdCkgewogICAgICAgIHZhciBub3JtYWxpemVkSW5wdXQgPSB7fSwKICAgICAgICAgICAgbm9ybWFsaXplZFByb3AsCiAgICAgICAgICAgIHByb3A7CgogICAgICAgIGZvciAocHJvcCBpbiBpbnB1dE9iamVjdCkgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcChpbnB1dE9iamVjdCwgcHJvcCkpIHsKICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRQcm9wID0gbm9ybWFsaXplVW5pdHMocHJvcCk7CiAgICAgICAgICAgICAgICBpZiAobm9ybWFsaXplZFByb3ApIHsKICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVkSW5wdXRbbm9ybWFsaXplZFByb3BdID0gaW5wdXRPYmplY3RbcHJvcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBub3JtYWxpemVkSW5wdXQ7CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZUxpc3QoZmllbGQpIHsKICAgICAgICB2YXIgY291bnQsIHNldHRlcjsKCiAgICAgICAgaWYgKGZpZWxkLmluZGV4T2YoJ3dlZWsnKSA9PT0gMCkgewogICAgICAgICAgICBjb3VudCA9IDc7CiAgICAgICAgICAgIHNldHRlciA9ICdkYXknOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChmaWVsZC5pbmRleE9mKCdtb250aCcpID09PSAwKSB7CiAgICAgICAgICAgIGNvdW50ID0gMTI7CiAgICAgICAgICAgIHNldHRlciA9ICdtb250aCc7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBtb21lbnRbZmllbGRdID0gZnVuY3Rpb24gKGZvcm1hdCwgaW5kZXgpIHsKICAgICAgICAgICAgdmFyIGksIGdldHRlciwKICAgICAgICAgICAgICAgIG1ldGhvZCA9IG1vbWVudC5fbG9jYWxlW2ZpZWxkXSwKICAgICAgICAgICAgICAgIHJlc3VsdHMgPSBbXTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgZm9ybWF0ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgaW5kZXggPSBmb3JtYXQ7CiAgICAgICAgICAgICAgICBmb3JtYXQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGdldHRlciA9IGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICAgICAgICB2YXIgbSA9IG1vbWVudCgpLnV0YygpLnNldChzZXR0ZXIsIGkpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1ldGhvZC5jYWxsKG1vbWVudC5fbG9jYWxlLCBtLCBmb3JtYXQgfHwgJycpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGluZGV4ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBnZXR0ZXIoaW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goZ2V0dGVyKGkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiB0b0ludChhcmd1bWVudEZvckNvZXJjaW9uKSB7CiAgICAgICAgdmFyIGNvZXJjZWROdW1iZXIgPSArYXJndW1lbnRGb3JDb2VyY2lvbiwKICAgICAgICAgICAgdmFsdWUgPSAwOwoKICAgICAgICBpZiAoY29lcmNlZE51bWJlciAhPT0gMCAmJiBpc0Zpbml0ZShjb2VyY2VkTnVtYmVyKSkgewogICAgICAgICAgICBpZiAoY29lcmNlZE51bWJlciA+PSAwKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IE1hdGguZmxvb3IoY29lcmNlZE51bWJlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IE1hdGguY2VpbChjb2VyY2VkTnVtYmVyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGRheXNJbk1vbnRoKHllYXIsIG1vbnRoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKHllYXIsIG1vbnRoICsgMSwgMCkpLmdldFVUQ0RhdGUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiB3ZWVrc0luWWVhcih5ZWFyLCBkb3csIGRveSkgewogICAgICAgIHJldHVybiB3ZWVrT2ZZZWFyKG1vbWVudChbeWVhciwgMTEsIDMxICsgZG93IC0gZG95XSksIGRvdywgZG95KS53ZWVrOwogICAgfQoKICAgIGZ1bmN0aW9uIGRheXNJblllYXIoeWVhcikgewogICAgICAgIHJldHVybiBpc0xlYXBZZWFyKHllYXIpID8gMzY2IDogMzY1OwogICAgfQoKICAgIGZ1bmN0aW9uIGlzTGVhcFllYXIoeWVhcikgewogICAgICAgIHJldHVybiAoeWVhciAlIDQgPT09IDAgJiYgeWVhciAlIDEwMCAhPT0gMCkgfHwgeWVhciAlIDQwMCA9PT0gMDsKICAgIH0KCiAgICBmdW5jdGlvbiBjaGVja092ZXJmbG93KG0pIHsKICAgICAgICB2YXIgb3ZlcmZsb3c7CiAgICAgICAgaWYgKG0uX2EgJiYgbS5fcGYub3ZlcmZsb3cgPT09IC0yKSB7CiAgICAgICAgICAgIG92ZXJmbG93ID0KICAgICAgICAgICAgICAgIG0uX2FbTU9OVEhdIDwgMCB8fCBtLl9hW01PTlRIXSA+IDExID8gTU9OVEggOgogICAgICAgICAgICAgICAgbS5fYVtEQVRFXSA8IDEgfHwgbS5fYVtEQVRFXSA+IGRheXNJbk1vbnRoKG0uX2FbWUVBUl0sIG0uX2FbTU9OVEhdKSA/IERBVEUgOgogICAgICAgICAgICAgICAgbS5fYVtIT1VSXSA8IDAgfHwgbS5fYVtIT1VSXSA+IDIzID8gSE9VUiA6CiAgICAgICAgICAgICAgICBtLl9hW01JTlVURV0gPCAwIHx8IG0uX2FbTUlOVVRFXSA+IDU5ID8gTUlOVVRFIDoKICAgICAgICAgICAgICAgIG0uX2FbU0VDT05EXSA8IDAgfHwgbS5fYVtTRUNPTkRdID4gNTkgPyBTRUNPTkQgOgogICAgICAgICAgICAgICAgbS5fYVtNSUxMSVNFQ09ORF0gPCAwIHx8IG0uX2FbTUlMTElTRUNPTkRdID4gOTk5ID8gTUlMTElTRUNPTkQgOgogICAgICAgICAgICAgICAgLTE7CgogICAgICAgICAgICBpZiAobS5fcGYuX292ZXJmbG93RGF5T2ZZZWFyICYmIChvdmVyZmxvdyA8IFlFQVIgfHwgb3ZlcmZsb3cgPiBEQVRFKSkgewogICAgICAgICAgICAgICAgb3ZlcmZsb3cgPSBEQVRFOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtLl9wZi5vdmVyZmxvdyA9IG92ZXJmbG93OwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc1ZhbGlkKG0pIHsKICAgICAgICBpZiAobS5faXNWYWxpZCA9PSBudWxsKSB7CiAgICAgICAgICAgIG0uX2lzVmFsaWQgPSAhaXNOYU4obS5fZC5nZXRUaW1lKCkpICYmCiAgICAgICAgICAgICAgICBtLl9wZi5vdmVyZmxvdyA8IDAgJiYKICAgICAgICAgICAgICAgICFtLl9wZi5lbXB0eSAmJgogICAgICAgICAgICAgICAgIW0uX3BmLmludmFsaWRNb250aCAmJgogICAgICAgICAgICAgICAgIW0uX3BmLm51bGxJbnB1dCAmJgogICAgICAgICAgICAgICAgIW0uX3BmLmludmFsaWRGb3JtYXQgJiYKICAgICAgICAgICAgICAgICFtLl9wZi51c2VySW52YWxpZGF0ZWQ7CgogICAgICAgICAgICBpZiAobS5fc3RyaWN0KSB7CiAgICAgICAgICAgICAgICBtLl9pc1ZhbGlkID0gbS5faXNWYWxpZCAmJgogICAgICAgICAgICAgICAgICAgIG0uX3BmLmNoYXJzTGVmdE92ZXIgPT09IDAgJiYKICAgICAgICAgICAgICAgICAgICBtLl9wZi51bnVzZWRUb2tlbnMubGVuZ3RoID09PSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBtLl9pc1ZhbGlkOwogICAgfQoKICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZUxvY2FsZShrZXkpIHsKICAgICAgICByZXR1cm4ga2V5ID8ga2V5LnRvTG93ZXJDYXNlKCkucmVwbGFjZSgnXycsICctJykgOiBrZXk7CiAgICB9CgogICAgLy8gcGljayB0aGUgbG9jYWxlIGZyb20gdGhlIGFycmF5CiAgICAvLyB0cnkgWydlbi1hdScsICdlbi1nYiddIGFzICdlbi1hdScsICdlbi1nYicsICdlbicsIGFzIGluIG1vdmUgdGhyb3VnaCB0aGUgbGlzdCB0cnlpbmcgZWFjaAogICAgLy8gc3Vic3RyaW5nIGZyb20gbW9zdCBzcGVjaWZpYyB0byBsZWFzdCwgYnV0IG1vdmUgdG8gdGhlIG5leHQgYXJyYXkgaXRlbSBpZiBpdCdzIGEgbW9yZSBzcGVjaWZpYyB2YXJpYW50IHRoYW4gdGhlIGN1cnJlbnQgcm9vdAogICAgZnVuY3Rpb24gY2hvb3NlTG9jYWxlKG5hbWVzKSB7CiAgICAgICAgdmFyIGkgPSAwLCBqLCBuZXh0LCBsb2NhbGUsIHNwbGl0OwoKICAgICAgICB3aGlsZSAoaSA8IG5hbWVzLmxlbmd0aCkgewogICAgICAgICAgICBzcGxpdCA9IG5vcm1hbGl6ZUxvY2FsZShuYW1lc1tpXSkuc3BsaXQoJy0nKTsKICAgICAgICAgICAgaiA9IHNwbGl0Lmxlbmd0aDsKICAgICAgICAgICAgbmV4dCA9IG5vcm1hbGl6ZUxvY2FsZShuYW1lc1tpICsgMV0pOwogICAgICAgICAgICBuZXh0ID0gbmV4dCA/IG5leHQuc3BsaXQoJy0nKSA6IG51bGw7CiAgICAgICAgICAgIHdoaWxlIChqID4gMCkgewogICAgICAgICAgICAgICAgbG9jYWxlID0gbG9hZExvY2FsZShzcGxpdC5zbGljZSgwLCBqKS5qb2luKCctJykpOwogICAgICAgICAgICAgICAgaWYgKGxvY2FsZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2NhbGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobmV4dCAmJiBuZXh0Lmxlbmd0aCA+PSBqICYmIGNvbXBhcmVBcnJheXMoc3BsaXQsIG5leHQsIHRydWUpID49IGogLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgLy90aGUgbmV4dCBhcnJheSBpdGVtIGlzIGJldHRlciB0aGFuIGEgc2hhbGxvd2VyIHN1YnN0cmluZyBvZiB0aGlzIG9uZQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgai0tOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGkrKzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gbG9hZExvY2FsZShuYW1lKSB7CiAgICAgICAgdmFyIG9sZExvY2FsZSA9IG51bGw7CiAgICAgICAgaWYgKCFsb2NhbGVzW25hbWVdICYmIGhhc01vZHVsZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgb2xkTG9jYWxlID0gbW9tZW50LmxvY2FsZSgpOwogICAgICAgICAgICAgICAgcmVxdWlyZSgnLi9sb2NhbGUvJyArIG5hbWUpOwogICAgICAgICAgICAgICAgLy8gYmVjYXVzZSBkZWZpbmVMb2NhbGUgY3VycmVudGx5IGFsc28gc2V0cyB0aGUgZ2xvYmFsIGxvY2FsZSwgd2Ugd2FudCB0byB1bmRvIHRoYXQgZm9yIGxhenkgbG9hZGVkIGxvY2FsZXMKICAgICAgICAgICAgICAgIG1vbWVudC5sb2NhbGUob2xkTG9jYWxlKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgeyB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBsb2NhbGVzW25hbWVdOwogICAgfQoKICAgIC8vIFJldHVybiBhIG1vbWVudCBmcm9tIGlucHV0LCB0aGF0IGlzIGxvY2FsL3V0Yy96b25lIGVxdWl2YWxlbnQgdG8gbW9kZWwuCiAgICBmdW5jdGlvbiBtYWtlQXMoaW5wdXQsIG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLl9pc1VUQyA/IG1vbWVudChpbnB1dCkuem9uZShtb2RlbC5fb2Zmc2V0IHx8IDApIDoKICAgICAgICAgICAgbW9tZW50KGlucHV0KS5sb2NhbCgpOwogICAgfQoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBMb2NhbGUKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgZXh0ZW5kKExvY2FsZS5wcm90b3R5cGUsIHsKCiAgICAgICAgc2V0IDogZnVuY3Rpb24gKGNvbmZpZykgewogICAgICAgICAgICB2YXIgcHJvcCwgaTsKICAgICAgICAgICAgZm9yIChpIGluIGNvbmZpZykgewogICAgICAgICAgICAgICAgcHJvcCA9IGNvbmZpZ1tpXTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgIHRoaXNbaV0gPSBwcm9wOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzWydfJyArIGldID0gcHJvcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9tb250aHMgOiAnSmFudWFyeV9GZWJydWFyeV9NYXJjaF9BcHJpbF9NYXlfSnVuZV9KdWx5X0F1Z3VzdF9TZXB0ZW1iZXJfT2N0b2Jlcl9Ob3ZlbWJlcl9EZWNlbWJlcicuc3BsaXQoJ18nKSwKICAgICAgICBtb250aHMgOiBmdW5jdGlvbiAobSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbW9udGhzW20ubW9udGgoKV07CiAgICAgICAgfSwKCiAgICAgICAgX21vbnRoc1Nob3J0IDogJ0phbl9GZWJfTWFyX0Fwcl9NYXlfSnVuX0p1bF9BdWdfU2VwX09jdF9Ob3ZfRGVjJy5zcGxpdCgnXycpLAogICAgICAgIG1vbnRoc1Nob3J0IDogZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21vbnRoc1Nob3J0W20ubW9udGgoKV07CiAgICAgICAgfSwKCiAgICAgICAgbW9udGhzUGFyc2UgOiBmdW5jdGlvbiAobW9udGhOYW1lKSB7CiAgICAgICAgICAgIHZhciBpLCBtb20sIHJlZ2V4OwoKICAgICAgICAgICAgaWYgKCF0aGlzLl9tb250aHNQYXJzZSkgewogICAgICAgICAgICAgICAgdGhpcy5fbW9udGhzUGFyc2UgPSBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IDEyOyBpKyspIHsKICAgICAgICAgICAgICAgIC8vIG1ha2UgdGhlIHJlZ2V4IGlmIHdlIGRvbid0IGhhdmUgaXQgYWxyZWFkeQogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9tb250aHNQYXJzZVtpXSkgewogICAgICAgICAgICAgICAgICAgIG1vbSA9IG1vbWVudC51dGMoWzIwMDAsIGldKTsKICAgICAgICAgICAgICAgICAgICByZWdleCA9ICdeJyArIHRoaXMubW9udGhzKG1vbSwgJycpICsgJ3xeJyArIHRoaXMubW9udGhzU2hvcnQobW9tLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbW9udGhzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKHJlZ2V4LnJlcGxhY2UoJy4nLCAnJyksICdpJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyB0ZXN0IHRoZSByZWdleAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX21vbnRoc1BhcnNlW2ldLnRlc3QobW9udGhOYW1lKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX3dlZWtkYXlzIDogJ1N1bmRheV9Nb25kYXlfVHVlc2RheV9XZWRuZXNkYXlfVGh1cnNkYXlfRnJpZGF5X1NhdHVyZGF5Jy5zcGxpdCgnXycpLAogICAgICAgIHdlZWtkYXlzIDogZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3dlZWtkYXlzW20uZGF5KCldOwogICAgICAgIH0sCgogICAgICAgIF93ZWVrZGF5c1Nob3J0IDogJ1N1bl9Nb25fVHVlX1dlZF9UaHVfRnJpX1NhdCcuc3BsaXQoJ18nKSwKICAgICAgICB3ZWVrZGF5c1Nob3J0IDogZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3dlZWtkYXlzU2hvcnRbbS5kYXkoKV07CiAgICAgICAgfSwKCiAgICAgICAgX3dlZWtkYXlzTWluIDogJ1N1X01vX1R1X1dlX1RoX0ZyX1NhJy5zcGxpdCgnXycpLAogICAgICAgIHdlZWtkYXlzTWluIDogZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3dlZWtkYXlzTWluW20uZGF5KCldOwogICAgICAgIH0sCgogICAgICAgIHdlZWtkYXlzUGFyc2UgOiBmdW5jdGlvbiAod2Vla2RheU5hbWUpIHsKICAgICAgICAgICAgdmFyIGksIG1vbSwgcmVnZXg7CgogICAgICAgICAgICBpZiAoIXRoaXMuX3dlZWtkYXlzUGFyc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3dlZWtkYXlzUGFyc2UgPSBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IDc7IGkrKykgewogICAgICAgICAgICAgICAgLy8gbWFrZSB0aGUgcmVnZXggaWYgd2UgZG9uJ3QgaGF2ZSBpdCBhbHJlYWR5CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX3dlZWtkYXlzUGFyc2VbaV0pIHsKICAgICAgICAgICAgICAgICAgICBtb20gPSBtb21lbnQoWzIwMDAsIDFdKS5kYXkoaSk7CiAgICAgICAgICAgICAgICAgICAgcmVnZXggPSAnXicgKyB0aGlzLndlZWtkYXlzKG1vbSwgJycpICsgJ3xeJyArIHRoaXMud2Vla2RheXNTaG9ydChtb20sICcnKSArICd8XicgKyB0aGlzLndlZWtkYXlzTWluKG1vbSwgJycpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3dlZWtkYXlzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKHJlZ2V4LnJlcGxhY2UoJy4nLCAnJyksICdpJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyB0ZXN0IHRoZSByZWdleAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3dlZWtkYXlzUGFyc2VbaV0udGVzdCh3ZWVrZGF5TmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9sb25nRGF0ZUZvcm1hdCA6IHsKICAgICAgICAgICAgTFQgOiAnaDptbSBBJywKICAgICAgICAgICAgTCA6ICdNTS9ERC9ZWVlZJywKICAgICAgICAgICAgTEwgOiAnTU1NTSBELCBZWVlZJywKICAgICAgICAgICAgTExMIDogJ01NTU0gRCwgWVlZWSBMVCcsCiAgICAgICAgICAgIExMTEwgOiAnZGRkZCwgTU1NTSBELCBZWVlZIExUJwogICAgICAgIH0sCiAgICAgICAgbG9uZ0RhdGVGb3JtYXQgOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSB0aGlzLl9sb25nRGF0ZUZvcm1hdFtrZXldOwogICAgICAgICAgICBpZiAoIW91dHB1dCAmJiB0aGlzLl9sb25nRGF0ZUZvcm1hdFtrZXkudG9VcHBlckNhc2UoKV0pIHsKICAgICAgICAgICAgICAgIG91dHB1dCA9IHRoaXMuX2xvbmdEYXRlRm9ybWF0W2tleS50b1VwcGVyQ2FzZSgpXS5yZXBsYWNlKC9NTU1NfE1NfEREfGRkZGQvZywgZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWwuc2xpY2UoMSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuX2xvbmdEYXRlRm9ybWF0W2tleV0gPSBvdXRwdXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICB9LAoKICAgICAgICBpc1BNIDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIC8vIElFOCBRdWlya3MgTW9kZSAmIElFNyBTdGFuZGFyZHMgTW9kZSBkbyBub3QgYWxsb3cgYWNjZXNzaW5nIHN0cmluZ3MgbGlrZSBhcnJheXMKICAgICAgICAgICAgLy8gVXNpbmcgY2hhckF0IHNob3VsZCBiZSBtb3JlIGNvbXBhdGlibGUuCiAgICAgICAgICAgIHJldHVybiAoKGlucHV0ICsgJycpLnRvTG93ZXJDYXNlKCkuY2hhckF0KDApID09PSAncCcpOwogICAgICAgIH0sCgogICAgICAgIF9tZXJpZGllbVBhcnNlIDogL1thcF1cLj9tP1wuPy9pLAogICAgICAgIG1lcmlkaWVtIDogZnVuY3Rpb24gKGhvdXJzLCBtaW51dGVzLCBpc0xvd2VyKSB7CiAgICAgICAgICAgIGlmIChob3VycyA+IDExKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNMb3dlciA/ICdwbScgOiAnUE0nOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGlzTG93ZXIgPyAnYW0nIDogJ0FNJzsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9jYWxlbmRhciA6IHsKICAgICAgICAgICAgc2FtZURheSA6ICdbVG9kYXkgYXRdIExUJywKICAgICAgICAgICAgbmV4dERheSA6ICdbVG9tb3Jyb3cgYXRdIExUJywKICAgICAgICAgICAgbmV4dFdlZWsgOiAnZGRkZCBbYXRdIExUJywKICAgICAgICAgICAgbGFzdERheSA6ICdbWWVzdGVyZGF5IGF0XSBMVCcsCiAgICAgICAgICAgIGxhc3RXZWVrIDogJ1tMYXN0XSBkZGRkIFthdF0gTFQnLAogICAgICAgICAgICBzYW1lRWxzZSA6ICdMJwogICAgICAgIH0sCiAgICAgICAgY2FsZW5kYXIgOiBmdW5jdGlvbiAoa2V5LCBtb20pIHsKICAgICAgICAgICAgdmFyIG91dHB1dCA9IHRoaXMuX2NhbGVuZGFyW2tleV07CiAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb3V0cHV0ID09PSAnZnVuY3Rpb24nID8gb3V0cHV0LmFwcGx5KG1vbSkgOiBvdXRwdXQ7CiAgICAgICAgfSwKCiAgICAgICAgX3JlbGF0aXZlVGltZSA6IHsKICAgICAgICAgICAgZnV0dXJlIDogJ2luICVzJywKICAgICAgICAgICAgcGFzdCA6ICclcyBhZ28nLAogICAgICAgICAgICBzIDogJ2EgZmV3IHNlY29uZHMnLAogICAgICAgICAgICBtIDogJ2EgbWludXRlJywKICAgICAgICAgICAgbW0gOiAnJWQgbWludXRlcycsCiAgICAgICAgICAgIGggOiAnYW4gaG91cicsCiAgICAgICAgICAgIGhoIDogJyVkIGhvdXJzJywKICAgICAgICAgICAgZCA6ICdhIGRheScsCiAgICAgICAgICAgIGRkIDogJyVkIGRheXMnLAogICAgICAgICAgICBNIDogJ2EgbW9udGgnLAogICAgICAgICAgICBNTSA6ICclZCBtb250aHMnLAogICAgICAgICAgICB5IDogJ2EgeWVhcicsCiAgICAgICAgICAgIHl5IDogJyVkIHllYXJzJwogICAgICAgIH0sCgogICAgICAgIHJlbGF0aXZlVGltZSA6IGZ1bmN0aW9uIChudW1iZXIsIHdpdGhvdXRTdWZmaXgsIHN0cmluZywgaXNGdXR1cmUpIHsKICAgICAgICAgICAgdmFyIG91dHB1dCA9IHRoaXMuX3JlbGF0aXZlVGltZVtzdHJpbmddOwogICAgICAgICAgICByZXR1cm4gKHR5cGVvZiBvdXRwdXQgPT09ICdmdW5jdGlvbicpID8KICAgICAgICAgICAgICAgIG91dHB1dChudW1iZXIsIHdpdGhvdXRTdWZmaXgsIHN0cmluZywgaXNGdXR1cmUpIDoKICAgICAgICAgICAgICAgIG91dHB1dC5yZXBsYWNlKC8lZC9pLCBudW1iZXIpOwogICAgICAgIH0sCgogICAgICAgIHBhc3RGdXR1cmUgOiBmdW5jdGlvbiAoZGlmZiwgb3V0cHV0KSB7CiAgICAgICAgICAgIHZhciBmb3JtYXQgPSB0aGlzLl9yZWxhdGl2ZVRpbWVbZGlmZiA+IDAgPyAnZnV0dXJlJyA6ICdwYXN0J107CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgZm9ybWF0ID09PSAnZnVuY3Rpb24nID8gZm9ybWF0KG91dHB1dCkgOiBmb3JtYXQucmVwbGFjZSgvJXMvaSwgb3V0cHV0KTsKICAgICAgICB9LAoKICAgICAgICBvcmRpbmFsIDogZnVuY3Rpb24gKG51bWJlcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fb3JkaW5hbC5yZXBsYWNlKCclZCcsIG51bWJlcik7CiAgICAgICAgfSwKICAgICAgICBfb3JkaW5hbCA6ICclZCcsCgogICAgICAgIHByZXBhcnNlIDogZnVuY3Rpb24gKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH0sCgogICAgICAgIHBvc3Rmb3JtYXQgOiBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiBzdHJpbmc7CiAgICAgICAgfSwKCiAgICAgICAgd2VlayA6IGZ1bmN0aW9uIChtb20pIHsKICAgICAgICAgICAgcmV0dXJuIHdlZWtPZlllYXIobW9tLCB0aGlzLl93ZWVrLmRvdywgdGhpcy5fd2Vlay5kb3kpLndlZWs7CiAgICAgICAgfSwKCiAgICAgICAgX3dlZWsgOiB7CiAgICAgICAgICAgIGRvdyA6IDAsIC8vIFN1bmRheSBpcyB0aGUgZmlyc3QgZGF5IG9mIHRoZSB3ZWVrLgogICAgICAgICAgICBkb3kgOiA2ICAvLyBUaGUgd2VlayB0aGF0IGNvbnRhaW5zIEphbiAxc3QgaXMgdGhlIGZpcnN0IHdlZWsgb2YgdGhlIHllYXIuCiAgICAgICAgfSwKCiAgICAgICAgX2ludmFsaWREYXRlOiAnSW52YWxpZCBkYXRlJywKICAgICAgICBpbnZhbGlkRGF0ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faW52YWxpZERhdGU7CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIEZvcm1hdHRpbmcKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgZnVuY3Rpb24gcmVtb3ZlRm9ybWF0dGluZ1Rva2VucyhpbnB1dCkgewogICAgICAgIGlmIChpbnB1dC5tYXRjaCgvXFtbXHNcU10vKSkgewogICAgICAgICAgICByZXR1cm4gaW5wdXQucmVwbGFjZSgvXlxbfFxdJC9nLCAnJyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbnB1dC5yZXBsYWNlKC9cXC9nLCAnJyk7CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZUZvcm1hdEZ1bmN0aW9uKGZvcm1hdCkgewogICAgICAgIHZhciBhcnJheSA9IGZvcm1hdC5tYXRjaChmb3JtYXR0aW5nVG9rZW5zKSwgaSwgbGVuZ3RoOwoKICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoZm9ybWF0VG9rZW5GdW5jdGlvbnNbYXJyYXlbaV1dKSB7CiAgICAgICAgICAgICAgICBhcnJheVtpXSA9IGZvcm1hdFRva2VuRnVuY3Rpb25zW2FycmF5W2ldXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFycmF5W2ldID0gcmVtb3ZlRm9ybWF0dGluZ1Rva2VucyhhcnJheVtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAobW9tKSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSAnJzsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvdXRwdXQgKz0gYXJyYXlbaV0gaW5zdGFuY2VvZiBGdW5jdGlvbiA/IGFycmF5W2ldLmNhbGwobW9tLCBmb3JtYXQpIDogYXJyYXlbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICB9OwogICAgfQoKICAgIC8vIGZvcm1hdCBkYXRlIHVzaW5nIG5hdGl2ZSBkYXRlIG9iamVjdAogICAgZnVuY3Rpb24gZm9ybWF0TW9tZW50KG0sIGZvcm1hdCkgewogICAgICAgIGlmICghbS5pc1ZhbGlkKCkpIHsKICAgICAgICAgICAgcmV0dXJuIG0ubG9jYWxlRGF0YSgpLmludmFsaWREYXRlKCk7CiAgICAgICAgfQoKICAgICAgICBmb3JtYXQgPSBleHBhbmRGb3JtYXQoZm9ybWF0LCBtLmxvY2FsZURhdGEoKSk7CgogICAgICAgIGlmICghZm9ybWF0RnVuY3Rpb25zW2Zvcm1hdF0pIHsKICAgICAgICAgICAgZm9ybWF0RnVuY3Rpb25zW2Zvcm1hdF0gPSBtYWtlRm9ybWF0RnVuY3Rpb24oZm9ybWF0KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmb3JtYXRGdW5jdGlvbnNbZm9ybWF0XShtKTsKICAgIH0KCiAgICBmdW5jdGlvbiBleHBhbmRGb3JtYXQoZm9ybWF0LCBsb2NhbGUpIHsKICAgICAgICB2YXIgaSA9IDU7CgogICAgICAgIGZ1bmN0aW9uIHJlcGxhY2VMb25nRGF0ZUZvcm1hdFRva2VucyhpbnB1dCkgewogICAgICAgICAgICByZXR1cm4gbG9jYWxlLmxvbmdEYXRlRm9ybWF0KGlucHV0KSB8fCBpbnB1dDsKICAgICAgICB9CgogICAgICAgIGxvY2FsRm9ybWF0dGluZ1Rva2Vucy5sYXN0SW5kZXggPSAwOwogICAgICAgIHdoaWxlIChpID49IDAgJiYgbG9jYWxGb3JtYXR0aW5nVG9rZW5zLnRlc3QoZm9ybWF0KSkgewogICAgICAgICAgICBmb3JtYXQgPSBmb3JtYXQucmVwbGFjZShsb2NhbEZvcm1hdHRpbmdUb2tlbnMsIHJlcGxhY2VMb25nRGF0ZUZvcm1hdFRva2Vucyk7CiAgICAgICAgICAgIGxvY2FsRm9ybWF0dGluZ1Rva2Vucy5sYXN0SW5kZXggPSAwOwogICAgICAgICAgICBpIC09IDE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZm9ybWF0OwogICAgfQoKCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgUGFyc2luZwogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCiAgICAvLyBnZXQgdGhlIHJlZ2V4IHRvIGZpbmQgdGhlIG5leHQgdG9rZW4KICAgIGZ1bmN0aW9uIGdldFBhcnNlUmVnZXhGb3JUb2tlbih0b2tlbiwgY29uZmlnKSB7CiAgICAgICAgdmFyIGEsIHN0cmljdCA9IGNvbmZpZy5fc3RyaWN0OwogICAgICAgIHN3aXRjaCAodG9rZW4pIHsKICAgICAgICBjYXNlICdRJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5PbmVEaWdpdDsKICAgICAgICBjYXNlICdEREREJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5UaHJlZURpZ2l0czsKICAgICAgICBjYXNlICdZWVlZJzoKICAgICAgICBjYXNlICdHR0dHJzoKICAgICAgICBjYXNlICdnZ2dnJzoKICAgICAgICAgICAgcmV0dXJuIHN0cmljdCA/IHBhcnNlVG9rZW5Gb3VyRGlnaXRzIDogcGFyc2VUb2tlbk9uZVRvRm91ckRpZ2l0czsKICAgICAgICBjYXNlICdZJzoKICAgICAgICBjYXNlICdHJzoKICAgICAgICBjYXNlICdnJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5TaWduZWROdW1iZXI7CiAgICAgICAgY2FzZSAnWVlZWVlZJzoKICAgICAgICBjYXNlICdZWVlZWSc6CiAgICAgICAgY2FzZSAnR0dHR0cnOgogICAgICAgIGNhc2UgJ2dnZ2dnJzoKICAgICAgICAgICAgcmV0dXJuIHN0cmljdCA/IHBhcnNlVG9rZW5TaXhEaWdpdHMgOiBwYXJzZVRva2VuT25lVG9TaXhEaWdpdHM7CiAgICAgICAgY2FzZSAnUyc6CiAgICAgICAgICAgIGlmIChzdHJpY3QpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuT25lRGlnaXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgIGNhc2UgJ1NTJzoKICAgICAgICAgICAgaWYgKHN0cmljdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5Ud29EaWdpdHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgIGNhc2UgJ1NTUyc6CiAgICAgICAgICAgIGlmIChzdHJpY3QpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuVGhyZWVEaWdpdHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgIGNhc2UgJ0RERCc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuT25lVG9UaHJlZURpZ2l0czsKICAgICAgICBjYXNlICdNTU0nOgogICAgICAgIGNhc2UgJ01NTU0nOgogICAgICAgIGNhc2UgJ2RkJzoKICAgICAgICBjYXNlICdkZGQnOgogICAgICAgIGNhc2UgJ2RkZGQnOgogICAgICAgICAgICByZXR1cm4gcGFyc2VUb2tlbldvcmQ7CiAgICAgICAgY2FzZSAnYSc6CiAgICAgICAgY2FzZSAnQSc6CiAgICAgICAgICAgIHJldHVybiBjb25maWcuX2xvY2FsZS5fbWVyaWRpZW1QYXJzZTsKICAgICAgICBjYXNlICdYJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5UaW1lc3RhbXBNczsKICAgICAgICBjYXNlICdaJzoKICAgICAgICBjYXNlICdaWic6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuVGltZXpvbmU7CiAgICAgICAgY2FzZSAnVCc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuVDsKICAgICAgICBjYXNlICdTU1NTJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5EaWdpdHM7CiAgICAgICAgY2FzZSAnTU0nOgogICAgICAgIGNhc2UgJ0REJzoKICAgICAgICBjYXNlICdZWSc6CiAgICAgICAgY2FzZSAnR0cnOgogICAgICAgIGNhc2UgJ2dnJzoKICAgICAgICBjYXNlICdISCc6CiAgICAgICAgY2FzZSAnaGgnOgogICAgICAgIGNhc2UgJ21tJzoKICAgICAgICBjYXNlICdzcyc6CiAgICAgICAgY2FzZSAnd3cnOgogICAgICAgIGNhc2UgJ1dXJzoKICAgICAgICAgICAgcmV0dXJuIHN0cmljdCA/IHBhcnNlVG9rZW5Ud29EaWdpdHMgOiBwYXJzZVRva2VuT25lT3JUd29EaWdpdHM7CiAgICAgICAgY2FzZSAnTSc6CiAgICAgICAgY2FzZSAnRCc6CiAgICAgICAgY2FzZSAnZCc6CiAgICAgICAgY2FzZSAnSCc6CiAgICAgICAgY2FzZSAnaCc6CiAgICAgICAgY2FzZSAnbSc6CiAgICAgICAgY2FzZSAncyc6CiAgICAgICAgY2FzZSAndyc6CiAgICAgICAgY2FzZSAnVyc6CiAgICAgICAgY2FzZSAnZSc6CiAgICAgICAgY2FzZSAnRSc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuT25lT3JUd29EaWdpdHM7CiAgICAgICAgY2FzZSAnRG8nOgogICAgICAgICAgICByZXR1cm4gcGFyc2VUb2tlbk9yZGluYWw7CiAgICAgICAgZGVmYXVsdCA6CiAgICAgICAgICAgIGEgPSBuZXcgUmVnRXhwKHJlZ2V4cEVzY2FwZSh1bmVzY2FwZUZvcm1hdCh0b2tlbi5yZXBsYWNlKCdcXCcsICcnKSksICdpJykpOwogICAgICAgICAgICByZXR1cm4gYTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdGltZXpvbmVNaW51dGVzRnJvbVN0cmluZyhzdHJpbmcpIHsKICAgICAgICBzdHJpbmcgPSBzdHJpbmcgfHwgJyc7CiAgICAgICAgdmFyIHBvc3NpYmxlVHpNYXRjaGVzID0gKHN0cmluZy5tYXRjaChwYXJzZVRva2VuVGltZXpvbmUpIHx8IFtdKSwKICAgICAgICAgICAgdHpDaHVuayA9IHBvc3NpYmxlVHpNYXRjaGVzW3Bvc3NpYmxlVHpNYXRjaGVzLmxlbmd0aCAtIDFdIHx8IFtdLAogICAgICAgICAgICBwYXJ0cyA9ICh0ekNodW5rICsgJycpLm1hdGNoKHBhcnNlVGltZXpvbmVDaHVua2VyKSB8fCBbJy0nLCAwLCAwXSwKICAgICAgICAgICAgbWludXRlcyA9ICsocGFydHNbMV0gKiA2MCkgKyB0b0ludChwYXJ0c1syXSk7CgogICAgICAgIHJldHVybiBwYXJ0c1swXSA9PT0gJysnID8gLW1pbnV0ZXMgOiBtaW51dGVzOwogICAgfQoKICAgIC8vIGZ1bmN0aW9uIHRvIGNvbnZlcnQgc3RyaW5nIGlucHV0IHRvIGRhdGUKICAgIGZ1bmN0aW9uIGFkZFRpbWVUb0FycmF5RnJvbVRva2VuKHRva2VuLCBpbnB1dCwgY29uZmlnKSB7CiAgICAgICAgdmFyIGEsIGRhdGVQYXJ0QXJyYXkgPSBjb25maWcuX2E7CgogICAgICAgIHN3aXRjaCAodG9rZW4pIHsKICAgICAgICAvLyBRVUFSVEVSCiAgICAgICAgY2FzZSAnUSc6CiAgICAgICAgICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBkYXRlUGFydEFycmF5W01PTlRIXSA9ICh0b0ludChpbnB1dCkgLSAxKSAqIDM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gTU9OVEgKICAgICAgICBjYXNlICdNJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBNTQogICAgICAgIGNhc2UgJ01NJyA6CiAgICAgICAgICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBkYXRlUGFydEFycmF5W01PTlRIXSA9IHRvSW50KGlucHV0KSAtIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnTU1NJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBNTU1NCiAgICAgICAgY2FzZSAnTU1NTScgOgogICAgICAgICAgICBhID0gY29uZmlnLl9sb2NhbGUubW9udGhzUGFyc2UoaW5wdXQpOwogICAgICAgICAgICAvLyBpZiB3ZSBkaWRuJ3QgZmluZCBhIG1vbnRoIG5hbWUsIG1hcmsgdGhlIGRhdGUgYXMgaW52YWxpZC4KICAgICAgICAgICAgaWYgKGEgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGF0ZVBhcnRBcnJheVtNT05USF0gPSBhOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uZmlnLl9wZi5pbnZhbGlkTW9udGggPSBpbnB1dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyBEQVkgT0YgTU9OVEgKICAgICAgICBjYXNlICdEJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBERAogICAgICAgIGNhc2UgJ0REJyA6CiAgICAgICAgICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBkYXRlUGFydEFycmF5W0RBVEVdID0gdG9JbnQoaW5wdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ0RvJyA6CiAgICAgICAgICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBkYXRlUGFydEFycmF5W0RBVEVdID0gdG9JbnQocGFyc2VJbnQoaW5wdXQsIDEwKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gREFZIE9GIFlFQVIKICAgICAgICBjYXNlICdEREQnIDogLy8gZmFsbCB0aHJvdWdoIHRvIEREREQKICAgICAgICBjYXNlICdEREREJyA6CiAgICAgICAgICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBjb25maWcuX2RheU9mWWVhciA9IHRvSW50KGlucHV0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gWUVBUgogICAgICAgIGNhc2UgJ1lZJyA6CiAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbWUVBUl0gPSBtb21lbnQucGFyc2VUd29EaWdpdFllYXIoaW5wdXQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdZWVlZJyA6CiAgICAgICAgY2FzZSAnWVlZWVknIDoKICAgICAgICBjYXNlICdZWVlZWVknIDoKICAgICAgICAgICAgZGF0ZVBhcnRBcnJheVtZRUFSXSA9IHRvSW50KGlucHV0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gQU0gLyBQTQogICAgICAgIGNhc2UgJ2EnIDogLy8gZmFsbCB0aHJvdWdoIHRvIEEKICAgICAgICBjYXNlICdBJyA6CiAgICAgICAgICAgIGNvbmZpZy5faXNQbSA9IGNvbmZpZy5fbG9jYWxlLmlzUE0oaW5wdXQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyAyNCBIT1VSCiAgICAgICAgY2FzZSAnSCcgOiAvLyBmYWxsIHRocm91Z2ggdG8gaGgKICAgICAgICBjYXNlICdISCcgOiAvLyBmYWxsIHRocm91Z2ggdG8gaGgKICAgICAgICBjYXNlICdoJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBoaAogICAgICAgIGNhc2UgJ2hoJyA6CiAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbSE9VUl0gPSB0b0ludChpbnB1dCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIE1JTlVURQogICAgICAgIGNhc2UgJ20nIDogLy8gZmFsbCB0aHJvdWdoIHRvIG1tCiAgICAgICAgY2FzZSAnbW0nIDoKICAgICAgICAgICAgZGF0ZVBhcnRBcnJheVtNSU5VVEVdID0gdG9JbnQoaW5wdXQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyBTRUNPTkQKICAgICAgICBjYXNlICdzJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBzcwogICAgICAgIGNhc2UgJ3NzJyA6CiAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbU0VDT05EXSA9IHRvSW50KGlucHV0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gTUlMTElTRUNPTkQKICAgICAgICBjYXNlICdTJyA6CiAgICAgICAgY2FzZSAnU1MnIDoKICAgICAgICBjYXNlICdTU1MnIDoKICAgICAgICBjYXNlICdTU1NTJyA6CiAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbTUlMTElTRUNPTkRdID0gdG9JbnQoKCcwLicgKyBpbnB1dCkgKiAxMDAwKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gVU5JWCBUSU1FU1RBTVAgV0lUSCBNUwogICAgICAgIGNhc2UgJ1gnOgogICAgICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShwYXJzZUZsb2F0KGlucHV0KSAqIDEwMDApOwogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyBUSU1FWk9ORQogICAgICAgIGNhc2UgJ1onIDogLy8gZmFsbCB0aHJvdWdoIHRvIFpaCiAgICAgICAgY2FzZSAnWlonIDoKICAgICAgICAgICAgY29uZmlnLl91c2VVVEMgPSB0cnVlOwogICAgICAgICAgICBjb25maWcuX3R6bSA9IHRpbWV6b25lTWludXRlc0Zyb21TdHJpbmcoaW5wdXQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyBXRUVLREFZIC0gaHVtYW4KICAgICAgICBjYXNlICdkZCc6CiAgICAgICAgY2FzZSAnZGRkJzoKICAgICAgICBjYXNlICdkZGRkJzoKICAgICAgICAgICAgYSA9IGNvbmZpZy5fbG9jYWxlLndlZWtkYXlzUGFyc2UoaW5wdXQpOwogICAgICAgICAgICAvLyBpZiB3ZSBkaWRuJ3QgZ2V0IGEgd2Vla2RheSBuYW1lLCBtYXJrIHRoZSBkYXRlIGFzIGludmFsaWQKICAgICAgICAgICAgaWYgKGEgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29uZmlnLl93ID0gY29uZmlnLl93IHx8IHt9OwogICAgICAgICAgICAgICAgY29uZmlnLl93WydkJ10gPSBhOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uZmlnLl9wZi5pbnZhbGlkV2Vla2RheSA9IGlucHV0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIFdFRUssIFdFRUsgREFZIC0gbnVtZXJpYwogICAgICAgIGNhc2UgJ3cnOgogICAgICAgIGNhc2UgJ3d3JzoKICAgICAgICBjYXNlICdXJzoKICAgICAgICBjYXNlICdXVyc6CiAgICAgICAgY2FzZSAnZCc6CiAgICAgICAgY2FzZSAnZSc6CiAgICAgICAgY2FzZSAnRSc6CiAgICAgICAgICAgIHRva2VuID0gdG9rZW4uc3Vic3RyKDAsIDEpOwogICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgY2FzZSAnZ2dnZyc6CiAgICAgICAgY2FzZSAnR0dHRyc6CiAgICAgICAgY2FzZSAnR0dHR0cnOgogICAgICAgICAgICB0b2tlbiA9IHRva2VuLnN1YnN0cigwLCAyKTsKICAgICAgICAgICAgaWYgKGlucHV0KSB7CiAgICAgICAgICAgICAgICBjb25maWcuX3cgPSBjb25maWcuX3cgfHwge307CiAgICAgICAgICAgICAgICBjb25maWcuX3dbdG9rZW5dID0gdG9JbnQoaW5wdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2dnJzoKICAgICAgICBjYXNlICdHRyc6CiAgICAgICAgICAgIGNvbmZpZy5fdyA9IGNvbmZpZy5fdyB8fCB7fTsKICAgICAgICAgICAgY29uZmlnLl93W3Rva2VuXSA9IG1vbWVudC5wYXJzZVR3b0RpZ2l0WWVhcihpbnB1dCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGRheU9mWWVhckZyb21XZWVrSW5mbyhjb25maWcpIHsKICAgICAgICB2YXIgdywgd2Vla1llYXIsIHdlZWssIHdlZWtkYXksIGRvdywgZG95LCB0ZW1wOwoKICAgICAgICB3ID0gY29uZmlnLl93OwogICAgICAgIGlmICh3LkdHICE9IG51bGwgfHwgdy5XICE9IG51bGwgfHwgdy5FICE9IG51bGwpIHsKICAgICAgICAgICAgZG93ID0gMTsKICAgICAgICAgICAgZG95ID0gNDsKCiAgICAgICAgICAgIC8vIFRPRE86IFdlIG5lZWQgdG8gdGFrZSB0aGUgY3VycmVudCBpc29XZWVrWWVhciwgYnV0IHRoYXQgZGVwZW5kcyBvbgogICAgICAgICAgICAvLyBob3cgd2UgaW50ZXJwcmV0IG5vdyAobG9jYWwsIHV0YywgZml4ZWQgb2Zmc2V0KS4gU28gY3JlYXRlCiAgICAgICAgICAgIC8vIGEgbm93IHZlcnNpb24gb2YgY3VycmVudCBjb25maWcgKHRha2UgbG9jYWwvdXRjL29mZnNldCBmbGFncywgYW5kCiAgICAgICAgICAgIC8vIGNyZWF0ZSBub3cpLgogICAgICAgICAgICB3ZWVrWWVhciA9IGRmbCh3LkdHLCBjb25maWcuX2FbWUVBUl0sIHdlZWtPZlllYXIobW9tZW50KCksIDEsIDQpLnllYXIpOwogICAgICAgICAgICB3ZWVrID0gZGZsKHcuVywgMSk7CiAgICAgICAgICAgIHdlZWtkYXkgPSBkZmwody5FLCAxKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkb3cgPSBjb25maWcuX2xvY2FsZS5fd2Vlay5kb3c7CiAgICAgICAgICAgIGRveSA9IGNvbmZpZy5fbG9jYWxlLl93ZWVrLmRveTsKCiAgICAgICAgICAgIHdlZWtZZWFyID0gZGZsKHcuZ2csIGNvbmZpZy5fYVtZRUFSXSwgd2Vla09mWWVhcihtb21lbnQoKSwgZG93LCBkb3kpLnllYXIpOwogICAgICAgICAgICB3ZWVrID0gZGZsKHcudywgMSk7CgogICAgICAgICAgICBpZiAody5kICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIC8vIHdlZWtkYXkgLS0gbG93IGRheSBudW1iZXJzIGFyZSBjb25zaWRlcmVkIG5leHQgd2VlawogICAgICAgICAgICAgICAgd2Vla2RheSA9IHcuZDsKICAgICAgICAgICAgICAgIGlmICh3ZWVrZGF5IDwgZG93KSB7CiAgICAgICAgICAgICAgICAgICAgKyt3ZWVrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHcuZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAvLyBsb2NhbCB3ZWVrZGF5IC0tIGNvdW50aW5nIHN0YXJ0cyBmcm9tIGJlZ2luaW5nIG9mIHdlZWsKICAgICAgICAgICAgICAgIHdlZWtkYXkgPSB3LmUgKyBkb3c7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBkZWZhdWx0IHRvIGJlZ2luaW5nIG9mIHdlZWsKICAgICAgICAgICAgICAgIHdlZWtkYXkgPSBkb3c7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGVtcCA9IGRheU9mWWVhckZyb21XZWVrcyh3ZWVrWWVhciwgd2Vlaywgd2Vla2RheSwgZG95LCBkb3cpOwoKICAgICAgICBjb25maWcuX2FbWUVBUl0gPSB0ZW1wLnllYXI7CiAgICAgICAgY29uZmlnLl9kYXlPZlllYXIgPSB0ZW1wLmRheU9mWWVhcjsKICAgIH0KCiAgICAvLyBjb252ZXJ0IGFuIGFycmF5IHRvIGEgZGF0ZS4KICAgIC8vIHRoZSBhcnJheSBzaG91bGQgbWlycm9yIHRoZSBwYXJhbWV0ZXJzIGJlbG93CiAgICAvLyBub3RlOiBhbGwgdmFsdWVzIHBhc3QgdGhlIHllYXIgYXJlIG9wdGlvbmFsIGFuZCB3aWxsIGRlZmF1bHQgdG8gdGhlIGxvd2VzdCBwb3NzaWJsZSB2YWx1ZS4KICAgIC8vIFt5ZWFyLCBtb250aCwgZGF5ICwgaG91ciwgbWludXRlLCBzZWNvbmQsIG1pbGxpc2Vjb25kXQogICAgZnVuY3Rpb24gZGF0ZUZyb21Db25maWcoY29uZmlnKSB7CiAgICAgICAgdmFyIGksIGRhdGUsIGlucHV0ID0gW10sIGN1cnJlbnREYXRlLCB5ZWFyVG9Vc2U7CgogICAgICAgIGlmIChjb25maWcuX2QpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY3VycmVudERhdGUgPSBjdXJyZW50RGF0ZUFycmF5KGNvbmZpZyk7CgogICAgICAgIC8vY29tcHV0ZSBkYXkgb2YgdGhlIHllYXIgZnJvbSB3ZWVrcyBhbmQgd2Vla2RheXMKICAgICAgICBpZiAoY29uZmlnLl93ICYmIGNvbmZpZy5fYVtEQVRFXSA9PSBudWxsICYmIGNvbmZpZy5fYVtNT05USF0gPT0gbnVsbCkgewogICAgICAgICAgICBkYXlPZlllYXJGcm9tV2Vla0luZm8oY29uZmlnKTsKICAgICAgICB9CgogICAgICAgIC8vaWYgdGhlIGRheSBvZiB0aGUgeWVhciBpcyBzZXQsIGZpZ3VyZSBvdXQgd2hhdCBpdCBpcwogICAgICAgIGlmIChjb25maWcuX2RheU9mWWVhcikgewogICAgICAgICAgICB5ZWFyVG9Vc2UgPSBkZmwoY29uZmlnLl9hW1lFQVJdLCBjdXJyZW50RGF0ZVtZRUFSXSk7CgogICAgICAgICAgICBpZiAoY29uZmlnLl9kYXlPZlllYXIgPiBkYXlzSW5ZZWFyKHllYXJUb1VzZSkpIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5fcGYuX292ZXJmbG93RGF5T2ZZZWFyID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGF0ZSA9IG1ha2VVVENEYXRlKHllYXJUb1VzZSwgMCwgY29uZmlnLl9kYXlPZlllYXIpOwogICAgICAgICAgICBjb25maWcuX2FbTU9OVEhdID0gZGF0ZS5nZXRVVENNb250aCgpOwogICAgICAgICAgICBjb25maWcuX2FbREFURV0gPSBkYXRlLmdldFVUQ0RhdGUoKTsKICAgICAgICB9CgogICAgICAgIC8vIERlZmF1bHQgdG8gY3VycmVudCBkYXRlLgogICAgICAgIC8vICogaWYgbm8geWVhciwgbW9udGgsIGRheSBvZiBtb250aCBhcmUgZ2l2ZW4sIGRlZmF1bHQgdG8gdG9kYXkKICAgICAgICAvLyAqIGlmIGRheSBvZiBtb250aCBpcyBnaXZlbiwgZGVmYXVsdCBtb250aCBhbmQgeWVhcgogICAgICAgIC8vICogaWYgbW9udGggaXMgZ2l2ZW4sIGRlZmF1bHQgb25seSB5ZWFyCiAgICAgICAgLy8gKiBpZiB5ZWFyIGlzIGdpdmVuLCBkb24ndCBkZWZhdWx0IGFueXRoaW5nCiAgICAgICAgZm9yIChpID0gMDsgaSA8IDMgJiYgY29uZmlnLl9hW2ldID09IG51bGw7ICsraSkgewogICAgICAgICAgICBjb25maWcuX2FbaV0gPSBpbnB1dFtpXSA9IGN1cnJlbnREYXRlW2ldOwogICAgICAgIH0KCiAgICAgICAgLy8gWmVybyBvdXQgd2hhdGV2ZXIgd2FzIG5vdCBkZWZhdWx0ZWQsIGluY2x1ZGluZyB0aW1lCiAgICAgICAgZm9yICg7IGkgPCA3OyBpKyspIHsKICAgICAgICAgICAgY29uZmlnLl9hW2ldID0gaW5wdXRbaV0gPSAoY29uZmlnLl9hW2ldID09IG51bGwpID8gKGkgPT09IDIgPyAxIDogMCkgOiBjb25maWcuX2FbaV07CiAgICAgICAgfQoKICAgICAgICBjb25maWcuX2QgPSAoY29uZmlnLl91c2VVVEMgPyBtYWtlVVRDRGF0ZSA6IG1ha2VEYXRlKS5hcHBseShudWxsLCBpbnB1dCk7CiAgICAgICAgLy8gQXBwbHkgdGltZXpvbmUgb2Zmc2V0IGZyb20gaW5wdXQuIFRoZSBhY3R1YWwgem9uZSBjYW4gYmUgY2hhbmdlZAogICAgICAgIC8vIHdpdGggcGFyc2Vab25lLgogICAgICAgIGlmIChjb25maWcuX3R6bSAhPSBudWxsKSB7CiAgICAgICAgICAgIGNvbmZpZy5fZC5zZXRVVENNaW51dGVzKGNvbmZpZy5fZC5nZXRVVENNaW51dGVzKCkgKyBjb25maWcuX3R6bSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGRhdGVGcm9tT2JqZWN0KGNvbmZpZykgewogICAgICAgIHZhciBub3JtYWxpemVkSW5wdXQ7CgogICAgICAgIGlmIChjb25maWcuX2QpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgbm9ybWFsaXplZElucHV0ID0gbm9ybWFsaXplT2JqZWN0VW5pdHMoY29uZmlnLl9pKTsKICAgICAgICBjb25maWcuX2EgPSBbCiAgICAgICAgICAgIG5vcm1hbGl6ZWRJbnB1dC55ZWFyLAogICAgICAgICAgICBub3JtYWxpemVkSW5wdXQubW9udGgsCiAgICAgICAgICAgIG5vcm1hbGl6ZWRJbnB1dC5kYXksCiAgICAgICAgICAgIG5vcm1hbGl6ZWRJbnB1dC5ob3VyLAogICAgICAgICAgICBub3JtYWxpemVkSW5wdXQubWludXRlLAogICAgICAgICAgICBub3JtYWxpemVkSW5wdXQuc2Vjb25kLAogICAgICAgICAgICBub3JtYWxpemVkSW5wdXQubWlsbGlzZWNvbmQKICAgICAgICBdOwoKICAgICAgICBkYXRlRnJvbUNvbmZpZyhjb25maWcpOwogICAgfQoKICAgIGZ1bmN0aW9uIGN1cnJlbnREYXRlQXJyYXkoY29uZmlnKSB7CiAgICAgICAgdmFyIG5vdyA9IG5ldyBEYXRlKCk7CiAgICAgICAgaWYgKGNvbmZpZy5fdXNlVVRDKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBub3cuZ2V0VVRDRnVsbFllYXIoKSwKICAgICAgICAgICAgICAgIG5vdy5nZXRVVENNb250aCgpLAogICAgICAgICAgICAgICAgbm93LmdldFVUQ0RhdGUoKQogICAgICAgICAgICBdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBbbm93LmdldEZ1bGxZZWFyKCksIG5vdy5nZXRNb250aCgpLCBub3cuZ2V0RGF0ZSgpXTsKICAgICAgICB9CiAgICB9CgogICAgLy8gZGF0ZSBmcm9tIHN0cmluZyBhbmQgZm9ybWF0IHN0cmluZwogICAgZnVuY3Rpb24gbWFrZURhdGVGcm9tU3RyaW5nQW5kRm9ybWF0KGNvbmZpZykgewogICAgICAgIGlmIChjb25maWcuX2YgPT09IG1vbWVudC5JU09fODYwMSkgewogICAgICAgICAgICBwYXJzZUlTTyhjb25maWcpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25maWcuX2EgPSBbXTsKICAgICAgICBjb25maWcuX3BmLmVtcHR5ID0gdHJ1ZTsKCiAgICAgICAgLy8gVGhpcyBhcnJheSBpcyB1c2VkIHRvIG1ha2UgYSBEYXRlLCBlaXRoZXIgd2l0aCBgbmV3IERhdGVgIG9yIGBEYXRlLlVUQ2AKICAgICAgICB2YXIgc3RyaW5nID0gJycgKyBjb25maWcuX2ksCiAgICAgICAgICAgIGksIHBhcnNlZElucHV0LCB0b2tlbnMsIHRva2VuLCBza2lwcGVkLAogICAgICAgICAgICBzdHJpbmdMZW5ndGggPSBzdHJpbmcubGVuZ3RoLAogICAgICAgICAgICB0b3RhbFBhcnNlZElucHV0TGVuZ3RoID0gMDsKCiAgICAgICAgdG9rZW5zID0gZXhwYW5kRm9ybWF0KGNvbmZpZy5fZiwgY29uZmlnLl9sb2NhbGUpLm1hdGNoKGZvcm1hdHRpbmdUb2tlbnMpIHx8IFtdOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHRva2VuID0gdG9rZW5zW2ldOwogICAgICAgICAgICBwYXJzZWRJbnB1dCA9IChzdHJpbmcubWF0Y2goZ2V0UGFyc2VSZWdleEZvclRva2VuKHRva2VuLCBjb25maWcpKSB8fCBbXSlbMF07CiAgICAgICAgICAgIGlmIChwYXJzZWRJbnB1dCkgewogICAgICAgICAgICAgICAgc2tpcHBlZCA9IHN0cmluZy5zdWJzdHIoMCwgc3RyaW5nLmluZGV4T2YocGFyc2VkSW5wdXQpKTsKICAgICAgICAgICAgICAgIGlmIChza2lwcGVkLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25maWcuX3BmLnVudXNlZElucHV0LnB1c2goc2tpcHBlZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcuc2xpY2Uoc3RyaW5nLmluZGV4T2YocGFyc2VkSW5wdXQpICsgcGFyc2VkSW5wdXQubGVuZ3RoKTsKICAgICAgICAgICAgICAgIHRvdGFsUGFyc2VkSW5wdXRMZW5ndGggKz0gcGFyc2VkSW5wdXQubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGRvbid0IHBhcnNlIGlmIGl0J3Mgbm90IGEga25vd24gdG9rZW4KICAgICAgICAgICAgaWYgKGZvcm1hdFRva2VuRnVuY3Rpb25zW3Rva2VuXSkgewogICAgICAgICAgICAgICAgaWYgKHBhcnNlZElucHV0KSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLl9wZi5lbXB0eSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLl9wZi51bnVzZWRUb2tlbnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhZGRUaW1lVG9BcnJheUZyb21Ub2tlbih0b2tlbiwgcGFyc2VkSW5wdXQsIGNvbmZpZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoY29uZmlnLl9zdHJpY3QgJiYgIXBhcnNlZElucHV0KSB7CiAgICAgICAgICAgICAgICBjb25maWcuX3BmLnVudXNlZFRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gYWRkIHJlbWFpbmluZyB1bnBhcnNlZCBpbnB1dCBsZW5ndGggdG8gdGhlIHN0cmluZwogICAgICAgIGNvbmZpZy5fcGYuY2hhcnNMZWZ0T3ZlciA9IHN0cmluZ0xlbmd0aCAtIHRvdGFsUGFyc2VkSW5wdXRMZW5ndGg7CiAgICAgICAgaWYgKHN0cmluZy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbmZpZy5fcGYudW51c2VkSW5wdXQucHVzaChzdHJpbmcpOwogICAgICAgIH0KCiAgICAgICAgLy8gaGFuZGxlIGFtIHBtCiAgICAgICAgaWYgKGNvbmZpZy5faXNQbSAmJiBjb25maWcuX2FbSE9VUl0gPCAxMikgewogICAgICAgICAgICBjb25maWcuX2FbSE9VUl0gKz0gMTI7CiAgICAgICAgfQogICAgICAgIC8vIGlmIGlzIDEyIGFtLCBjaGFuZ2UgaG91cnMgdG8gMAogICAgICAgIGlmIChjb25maWcuX2lzUG0gPT09IGZhbHNlICYmIGNvbmZpZy5fYVtIT1VSXSA9PT0gMTIpIHsKICAgICAgICAgICAgY29uZmlnLl9hW0hPVVJdID0gMDsKICAgICAgICB9CgogICAgICAgIGRhdGVGcm9tQ29uZmlnKGNvbmZpZyk7CiAgICAgICAgY2hlY2tPdmVyZmxvdyhjb25maWcpOwogICAgfQoKICAgIGZ1bmN0aW9uIHVuZXNjYXBlRm9ybWF0KHMpIHsKICAgICAgICByZXR1cm4gcy5yZXBsYWNlKC9cXChcWyl8XFwoXF0pfFxbKFteXF1cW10qKVxdfFxcKC4pL2csIGZ1bmN0aW9uIChtYXRjaGVkLCBwMSwgcDIsIHAzLCBwNCkgewogICAgICAgICAgICByZXR1cm4gcDEgfHwgcDIgfHwgcDMgfHwgcDQ7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gQ29kZSBmcm9tIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzU2MTQ5My9pcy10aGVyZS1hLXJlZ2V4cC1lc2NhcGUtZnVuY3Rpb24taW4tamF2YXNjcmlwdAogICAgZnVuY3Rpb24gcmVnZXhwRXNjYXBlKHMpIHsKICAgICAgICByZXR1cm4gcy5yZXBsYWNlKC9bLVwvXFxeJCorPy4oKXxbXF17fV0vZywgJ1xcJCYnKTsKICAgIH0KCiAgICAvLyBkYXRlIGZyb20gc3RyaW5nIGFuZCBhcnJheSBvZiBmb3JtYXQgc3RyaW5ncwogICAgZnVuY3Rpb24gbWFrZURhdGVGcm9tU3RyaW5nQW5kQXJyYXkoY29uZmlnKSB7CiAgICAgICAgdmFyIHRlbXBDb25maWcsCiAgICAgICAgICAgIGJlc3RNb21lbnQsCgogICAgICAgICAgICBzY29yZVRvQmVhdCwKICAgICAgICAgICAgaSwKICAgICAgICAgICAgY3VycmVudFNjb3JlOwoKICAgICAgICBpZiAoY29uZmlnLl9mLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBjb25maWcuX3BmLmludmFsaWRGb3JtYXQgPSB0cnVlOwogICAgICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShOYU4pOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29uZmlnLl9mLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGN1cnJlbnRTY29yZSA9IDA7CiAgICAgICAgICAgIHRlbXBDb25maWcgPSBjb3B5Q29uZmlnKHt9LCBjb25maWcpOwogICAgICAgICAgICBpZiAoY29uZmlnLl91c2VVVEMgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGVtcENvbmZpZy5fdXNlVVRDID0gY29uZmlnLl91c2VVVEM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGVtcENvbmZpZy5fcGYgPSBkZWZhdWx0UGFyc2luZ0ZsYWdzKCk7CiAgICAgICAgICAgIHRlbXBDb25maWcuX2YgPSBjb25maWcuX2ZbaV07CiAgICAgICAgICAgIG1ha2VEYXRlRnJvbVN0cmluZ0FuZEZvcm1hdCh0ZW1wQ29uZmlnKTsKCiAgICAgICAgICAgIGlmICghaXNWYWxpZCh0ZW1wQ29uZmlnKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGlmIHRoZXJlIGlzIGFueSBpbnB1dCB0aGF0IHdhcyBub3QgcGFyc2VkIGFkZCBhIHBlbmFsdHkgZm9yIHRoYXQgZm9ybWF0CiAgICAgICAgICAgIGN1cnJlbnRTY29yZSArPSB0ZW1wQ29uZmlnLl9wZi5jaGFyc0xlZnRPdmVyOwoKICAgICAgICAgICAgLy9vciB0b2tlbnMKICAgICAgICAgICAgY3VycmVudFNjb3JlICs9IHRlbXBDb25maWcuX3BmLnVudXNlZFRva2Vucy5sZW5ndGggKiAxMDsKCiAgICAgICAgICAgIHRlbXBDb25maWcuX3BmLnNjb3JlID0gY3VycmVudFNjb3JlOwoKICAgICAgICAgICAgaWYgKHNjb3JlVG9CZWF0ID09IG51bGwgfHwgY3VycmVudFNjb3JlIDwgc2NvcmVUb0JlYXQpIHsKICAgICAgICAgICAgICAgIHNjb3JlVG9CZWF0ID0gY3VycmVudFNjb3JlOwogICAgICAgICAgICAgICAgYmVzdE1vbWVudCA9IHRlbXBDb25maWc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGV4dGVuZChjb25maWcsIGJlc3RNb21lbnQgfHwgdGVtcENvbmZpZyk7CiAgICB9CgogICAgLy8gZGF0ZSBmcm9tIGlzbyBmb3JtYXQKICAgIGZ1bmN0aW9uIHBhcnNlSVNPKGNvbmZpZykgewogICAgICAgIHZhciBpLCBsLAogICAgICAgICAgICBzdHJpbmcgPSBjb25maWcuX2ksCiAgICAgICAgICAgIG1hdGNoID0gaXNvUmVnZXguZXhlYyhzdHJpbmcpOwoKICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgY29uZmlnLl9wZi5pc28gPSB0cnVlOwogICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gaXNvRGF0ZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNvRGF0ZXNbaV1bMV0uZXhlYyhzdHJpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gbWF0Y2hbNV0gc2hvdWxkIGJlICdUJyBvciB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICBjb25maWcuX2YgPSBpc29EYXRlc1tpXVswXSArIChtYXRjaFs2XSB8fCAnICcpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBpc29UaW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChpc29UaW1lc1tpXVsxXS5leGVjKHN0cmluZykpIHsKICAgICAgICAgICAgICAgICAgICBjb25maWcuX2YgKz0gaXNvVGltZXNbaV1bMF07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN0cmluZy5tYXRjaChwYXJzZVRva2VuVGltZXpvbmUpKSB7CiAgICAgICAgICAgICAgICBjb25maWcuX2YgKz0gJ1onOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1ha2VEYXRlRnJvbVN0cmluZ0FuZEZvcm1hdChjb25maWcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZy5faXNWYWxpZCA9IGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBkYXRlIGZyb20gaXNvIGZvcm1hdCBvciBmYWxsYmFjawogICAgZnVuY3Rpb24gbWFrZURhdGVGcm9tU3RyaW5nKGNvbmZpZykgewogICAgICAgIHBhcnNlSVNPKGNvbmZpZyk7CiAgICAgICAgaWYgKGNvbmZpZy5faXNWYWxpZCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgZGVsZXRlIGNvbmZpZy5faXNWYWxpZDsKICAgICAgICAgICAgbW9tZW50LmNyZWF0ZUZyb21JbnB1dEZhbGxiYWNrKGNvbmZpZyk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG1hcChhcnIsIGZuKSB7CiAgICAgICAgdmFyIHJlcyA9IFtdLCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgcmVzLnB1c2goZm4oYXJyW2ldLCBpKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXM7CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZURhdGVGcm9tSW5wdXQoY29uZmlnKSB7CiAgICAgICAgdmFyIGlucHV0ID0gY29uZmlnLl9pLCBtYXRjaGVkOwogICAgICAgIGlmIChpbnB1dCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGNvbmZpZy5fZCA9IG5ldyBEYXRlKCk7CiAgICAgICAgfSBlbHNlIGlmIChpc0RhdGUoaW5wdXQpKSB7CiAgICAgICAgICAgIGNvbmZpZy5fZCA9IG5ldyBEYXRlKCtpbnB1dCk7CiAgICAgICAgfSBlbHNlIGlmICgobWF0Y2hlZCA9IGFzcE5ldEpzb25SZWdleC5leGVjKGlucHV0KSkgIT09IG51bGwpIHsKICAgICAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoK21hdGNoZWRbMV0pOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGlucHV0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBtYWtlRGF0ZUZyb21TdHJpbmcoY29uZmlnKTsKICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkoaW5wdXQpKSB7CiAgICAgICAgICAgIGNvbmZpZy5fYSA9IG1hcChpbnB1dC5zbGljZSgwKSwgZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlSW50KG9iaiwgMTApOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZGF0ZUZyb21Db25maWcoY29uZmlnKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZihpbnB1dCkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIGRhdGVGcm9tT2JqZWN0KGNvbmZpZyk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YoaW5wdXQpID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAvLyBmcm9tIG1pbGxpc2Vjb25kcwogICAgICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShpbnB1dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbW9tZW50LmNyZWF0ZUZyb21JbnB1dEZhbGxiYWNrKGNvbmZpZyk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VEYXRlKHksIG0sIGQsIGgsIE0sIHMsIG1zKSB7CiAgICAgICAgLy9jYW4ndCBqdXN0IGFwcGx5KCkgdG8gY3JlYXRlIGEgZGF0ZToKICAgICAgICAvL2h0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTgxMzQ4L2luc3RhbnRpYXRpbmctYS1qYXZhc2NyaXB0LW9iamVjdC1ieS1jYWxsaW5nLXByb3RvdHlwZS1jb25zdHJ1Y3Rvci1hcHBseQogICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoeSwgbSwgZCwgaCwgTSwgcywgbXMpOwoKICAgICAgICAvL3RoZSBkYXRlIGNvbnN0cnVjdG9yIGRvZXNuJ3QgYWNjZXB0IHllYXJzIDwgMTk3MAogICAgICAgIGlmICh5IDwgMTk3MCkgewogICAgICAgICAgICBkYXRlLnNldEZ1bGxZZWFyKHkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGF0ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYWtlVVRDRGF0ZSh5KSB7CiAgICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZShEYXRlLlVUQy5hcHBseShudWxsLCBhcmd1bWVudHMpKTsKICAgICAgICBpZiAoeSA8IDE5NzApIHsKICAgICAgICAgICAgZGF0ZS5zZXRVVENGdWxsWWVhcih5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRhdGU7CiAgICB9CgogICAgZnVuY3Rpb24gcGFyc2VXZWVrZGF5KGlucHV0LCBsb2NhbGUpIHsKICAgICAgICBpZiAodHlwZW9mIGlucHV0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBpZiAoIWlzTmFOKGlucHV0KSkgewogICAgICAgICAgICAgICAgaW5wdXQgPSBwYXJzZUludChpbnB1dCwgMTApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgaW5wdXQgPSBsb2NhbGUud2Vla2RheXNQYXJzZShpbnB1dCk7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGlucHV0ICE9PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbnB1dDsKICAgIH0KCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgUmVsYXRpdmUgVGltZQogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCiAgICAvLyBoZWxwZXIgZnVuY3Rpb24gZm9yIG1vbWVudC5mbi5mcm9tLCBtb21lbnQuZm4uZnJvbU5vdywgYW5kIG1vbWVudC5kdXJhdGlvbi5mbi5odW1hbml6ZQogICAgZnVuY3Rpb24gc3Vic3RpdHV0ZVRpbWVBZ28oc3RyaW5nLCBudW1iZXIsIHdpdGhvdXRTdWZmaXgsIGlzRnV0dXJlLCBsb2NhbGUpIHsKICAgICAgICByZXR1cm4gbG9jYWxlLnJlbGF0aXZlVGltZShudW1iZXIgfHwgMSwgISF3aXRob3V0U3VmZml4LCBzdHJpbmcsIGlzRnV0dXJlKTsKICAgIH0KCiAgICBmdW5jdGlvbiByZWxhdGl2ZVRpbWUocG9zTmVnRHVyYXRpb24sIHdpdGhvdXRTdWZmaXgsIGxvY2FsZSkgewogICAgICAgIHZhciBkdXJhdGlvbiA9IG1vbWVudC5kdXJhdGlvbihwb3NOZWdEdXJhdGlvbikuYWJzKCksCiAgICAgICAgICAgIHNlY29uZHMgPSByb3VuZChkdXJhdGlvbi5hcygncycpKSwKICAgICAgICAgICAgbWludXRlcyA9IHJvdW5kKGR1cmF0aW9uLmFzKCdtJykpLAogICAgICAgICAgICBob3VycyA9IHJvdW5kKGR1cmF0aW9uLmFzKCdoJykpLAogICAgICAgICAgICBkYXlzID0gcm91bmQoZHVyYXRpb24uYXMoJ2QnKSksCiAgICAgICAgICAgIG1vbnRocyA9IHJvdW5kKGR1cmF0aW9uLmFzKCdNJykpLAogICAgICAgICAgICB5ZWFycyA9IHJvdW5kKGR1cmF0aW9uLmFzKCd5JykpLAoKICAgICAgICAgICAgYXJncyA9IHNlY29uZHMgPCByZWxhdGl2ZVRpbWVUaHJlc2hvbGRzLnMgJiYgWydzJywgc2Vjb25kc10gfHwKICAgICAgICAgICAgICAgIG1pbnV0ZXMgPT09IDEgJiYgWydtJ10gfHwKICAgICAgICAgICAgICAgIG1pbnV0ZXMgPCByZWxhdGl2ZVRpbWVUaHJlc2hvbGRzLm0gJiYgWydtbScsIG1pbnV0ZXNdIHx8CiAgICAgICAgICAgICAgICBob3VycyA9PT0gMSAmJiBbJ2gnXSB8fAogICAgICAgICAgICAgICAgaG91cnMgPCByZWxhdGl2ZVRpbWVUaHJlc2hvbGRzLmggJiYgWydoaCcsIGhvdXJzXSB8fAogICAgICAgICAgICAgICAgZGF5cyA9PT0gMSAmJiBbJ2QnXSB8fAogICAgICAgICAgICAgICAgZGF5cyA8IHJlbGF0aXZlVGltZVRocmVzaG9sZHMuZCAmJiBbJ2RkJywgZGF5c10gfHwKICAgICAgICAgICAgICAgIG1vbnRocyA9PT0gMSAmJiBbJ00nXSB8fAogICAgICAgICAgICAgICAgbW9udGhzIDwgcmVsYXRpdmVUaW1lVGhyZXNob2xkcy5NICYmIFsnTU0nLCBtb250aHNdIHx8CiAgICAgICAgICAgICAgICB5ZWFycyA9PT0gMSAmJiBbJ3knXSB8fCBbJ3l5JywgeWVhcnNdOwoKICAgICAgICBhcmdzWzJdID0gd2l0aG91dFN1ZmZpeDsKICAgICAgICBhcmdzWzNdID0gK3Bvc05lZ0R1cmF0aW9uID4gMDsKICAgICAgICBhcmdzWzRdID0gbG9jYWxlOwogICAgICAgIHJldHVybiBzdWJzdGl0dXRlVGltZUFnby5hcHBseSh7fSwgYXJncyk7CiAgICB9CgoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBXZWVrIG9mIFllYXIKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgLy8gZmlyc3REYXlPZldlZWsgICAgICAgMCA9IHN1biwgNiA9IHNhdAogICAgLy8gICAgICAgICAgICAgICAgICAgICAgdGhlIGRheSBvZiB0aGUgd2VlayB0aGF0IHN0YXJ0cyB0aGUgd2VlawogICAgLy8gICAgICAgICAgICAgICAgICAgICAgKHVzdWFsbHkgc3VuZGF5IG9yIG1vbmRheSkKICAgIC8vIGZpcnN0RGF5T2ZXZWVrT2ZZZWFyIDAgPSBzdW4sIDYgPSBzYXQKICAgIC8vICAgICAgICAgICAgICAgICAgICAgIHRoZSBmaXJzdCB3ZWVrIGlzIHRoZSB3ZWVrIHRoYXQgY29udGFpbnMgdGhlIGZpcnN0CiAgICAvLyAgICAgICAgICAgICAgICAgICAgICBvZiB0aGlzIGRheSBvZiB0aGUgd2VlawogICAgLy8gICAgICAgICAgICAgICAgICAgICAgKGVnLiBJU08gd2Vla3MgdXNlIHRodXJzZGF5ICg0KSkKICAgIGZ1bmN0aW9uIHdlZWtPZlllYXIobW9tLCBmaXJzdERheU9mV2VlaywgZmlyc3REYXlPZldlZWtPZlllYXIpIHsKICAgICAgICB2YXIgZW5kID0gZmlyc3REYXlPZldlZWtPZlllYXIgLSBmaXJzdERheU9mV2VlaywKICAgICAgICAgICAgZGF5c1RvRGF5T2ZXZWVrID0gZmlyc3REYXlPZldlZWtPZlllYXIgLSBtb20uZGF5KCksCiAgICAgICAgICAgIGFkanVzdGVkTW9tZW50OwoKCiAgICAgICAgaWYgKGRheXNUb0RheU9mV2VlayA+IGVuZCkgewogICAgICAgICAgICBkYXlzVG9EYXlPZldlZWsgLT0gNzsKICAgICAgICB9CgogICAgICAgIGlmIChkYXlzVG9EYXlPZldlZWsgPCBlbmQgLSA3KSB7CiAgICAgICAgICAgIGRheXNUb0RheU9mV2VlayArPSA3OwogICAgICAgIH0KCiAgICAgICAgYWRqdXN0ZWRNb21lbnQgPSBtb21lbnQobW9tKS5hZGQoZGF5c1RvRGF5T2ZXZWVrLCAnZCcpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHdlZWs6IE1hdGguY2VpbChhZGp1c3RlZE1vbWVudC5kYXlPZlllYXIoKSAvIDcpLAogICAgICAgICAgICB5ZWFyOiBhZGp1c3RlZE1vbWVudC55ZWFyKCkKICAgICAgICB9OwogICAgfQoKICAgIC8vaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9JU09fd2Vla19kYXRlI0NhbGN1bGF0aW5nX2FfZGF0ZV9naXZlbl90aGVfeWVhci4yQ193ZWVrX251bWJlcl9hbmRfd2Vla2RheQogICAgZnVuY3Rpb24gZGF5T2ZZZWFyRnJvbVdlZWtzKHllYXIsIHdlZWssIHdlZWtkYXksIGZpcnN0RGF5T2ZXZWVrT2ZZZWFyLCBmaXJzdERheU9mV2VlaykgewogICAgICAgIHZhciBkID0gbWFrZVVUQ0RhdGUoeWVhciwgMCwgMSkuZ2V0VVRDRGF5KCksIGRheXNUb0FkZCwgZGF5T2ZZZWFyOwoKICAgICAgICBkID0gZCA9PT0gMCA/IDcgOiBkOwogICAgICAgIHdlZWtkYXkgPSB3ZWVrZGF5ICE9IG51bGwgPyB3ZWVrZGF5IDogZmlyc3REYXlPZldlZWs7CiAgICAgICAgZGF5c1RvQWRkID0gZmlyc3REYXlPZldlZWsgLSBkICsgKGQgPiBmaXJzdERheU9mV2Vla09mWWVhciA/IDcgOiAwKSAtIChkIDwgZmlyc3REYXlPZldlZWsgPyA3IDogMCk7CiAgICAgICAgZGF5T2ZZZWFyID0gNyAqICh3ZWVrIC0gMSkgKyAod2Vla2RheSAtIGZpcnN0RGF5T2ZXZWVrKSArIGRheXNUb0FkZCArIDE7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHllYXI6IGRheU9mWWVhciA+IDAgPyB5ZWFyIDogeWVhciAtIDEsCiAgICAgICAgICAgIGRheU9mWWVhcjogZGF5T2ZZZWFyID4gMCA/ICBkYXlPZlllYXIgOiBkYXlzSW5ZZWFyKHllYXIgLSAxKSArIGRheU9mWWVhcgogICAgICAgIH07CiAgICB9CgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIFRvcCBMZXZlbCBGdW5jdGlvbnMKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCiAgICBmdW5jdGlvbiBtYWtlTW9tZW50KGNvbmZpZykgewogICAgICAgIHZhciBpbnB1dCA9IGNvbmZpZy5faSwKICAgICAgICAgICAgZm9ybWF0ID0gY29uZmlnLl9mOwoKICAgICAgICBjb25maWcuX2xvY2FsZSA9IGNvbmZpZy5fbG9jYWxlIHx8IG1vbWVudC5sb2NhbGVEYXRhKGNvbmZpZy5fbCk7CgogICAgICAgIGlmIChpbnB1dCA9PT0gbnVsbCB8fCAoZm9ybWF0ID09PSB1bmRlZmluZWQgJiYgaW5wdXQgPT09ICcnKSkgewogICAgICAgICAgICByZXR1cm4gbW9tZW50LmludmFsaWQoe251bGxJbnB1dDogdHJ1ZX0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgY29uZmlnLl9pID0gaW5wdXQgPSBjb25maWcuX2xvY2FsZS5wcmVwYXJzZShpbnB1dCk7CiAgICAgICAgfQoKICAgICAgICBpZiAobW9tZW50LmlzTW9tZW50KGlucHV0KSkgewogICAgICAgICAgICByZXR1cm4gbmV3IE1vbWVudChpbnB1dCwgdHJ1ZSk7CiAgICAgICAgfSBlbHNlIGlmIChmb3JtYXQpIHsKICAgICAgICAgICAgaWYgKGlzQXJyYXkoZm9ybWF0KSkgewogICAgICAgICAgICAgICAgbWFrZURhdGVGcm9tU3RyaW5nQW5kQXJyYXkoY29uZmlnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1ha2VEYXRlRnJvbVN0cmluZ0FuZEZvcm1hdChjb25maWcpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbWFrZURhdGVGcm9tSW5wdXQoY29uZmlnKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBuZXcgTW9tZW50KGNvbmZpZyk7CiAgICB9CgogICAgbW9tZW50ID0gZnVuY3Rpb24gKGlucHV0LCBmb3JtYXQsIGxvY2FsZSwgc3RyaWN0KSB7CiAgICAgICAgdmFyIGM7CgogICAgICAgIGlmICh0eXBlb2YobG9jYWxlKSA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICAgIHN0cmljdCA9IGxvY2FsZTsKICAgICAgICAgICAgbG9jYWxlID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICAvLyBvYmplY3QgY29uc3RydWN0aW9uIG11c3QgYmUgZG9uZSB0aGlzIHdheS4KICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbW9tZW50L21vbWVudC9pc3N1ZXMvMTQyMwogICAgICAgIGMgPSB7fTsKICAgICAgICBjLl9pc0FNb21lbnRPYmplY3QgPSB0cnVlOwogICAgICAgIGMuX2kgPSBpbnB1dDsKICAgICAgICBjLl9mID0gZm9ybWF0OwogICAgICAgIGMuX2wgPSBsb2NhbGU7CiAgICAgICAgYy5fc3RyaWN0ID0gc3RyaWN0OwogICAgICAgIGMuX2lzVVRDID0gZmFsc2U7CiAgICAgICAgYy5fcGYgPSBkZWZhdWx0UGFyc2luZ0ZsYWdzKCk7CgogICAgICAgIHJldHVybiBtYWtlTW9tZW50KGMpOwogICAgfTsKCiAgICBtb21lbnQuc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmdzID0gZmFsc2U7CgogICAgbW9tZW50LmNyZWF0ZUZyb21JbnB1dEZhbGxiYWNrID0gZGVwcmVjYXRlKAogICAgICAgICdtb21lbnQgY29uc3RydWN0aW9uIGZhbGxzIGJhY2sgdG8ganMgRGF0ZS4gVGhpcyBpcyAnICsKICAgICAgICAnZGlzY291cmFnZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB1cGNvbWluZyBtYWpvciAnICsKICAgICAgICAncmVsZWFzZS4gUGxlYXNlIHJlZmVyIHRvICcgKwogICAgICAgICdodHRwczovL2dpdGh1Yi5jb20vbW9tZW50L21vbWVudC9pc3N1ZXMvMTQwNyBmb3IgbW9yZSBpbmZvLicsCiAgICAgICAgZnVuY3Rpb24gKGNvbmZpZykgewogICAgICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShjb25maWcuX2kpOwogICAgICAgIH0KICAgICk7CgogICAgLy8gUGljayBhIG1vbWVudCBtIGZyb20gbW9tZW50cyBzbyB0aGF0IG1bZm5dKG90aGVyKSBpcyB0cnVlIGZvciBhbGwKICAgIC8vIG90aGVyLiBUaGlzIHJlbGllcyBvbiB0aGUgZnVuY3Rpb24gZm4gdG8gYmUgdHJhbnNpdGl2ZS4KICAgIC8vCiAgICAvLyBtb21lbnRzIHNob3VsZCBlaXRoZXIgYmUgYW4gYXJyYXkgb2YgbW9tZW50IG9iamVjdHMgb3IgYW4gYXJyYXksIHdob3NlCiAgICAvLyBmaXJzdCBlbGVtZW50IGlzIGFuIGFycmF5IG9mIG1vbWVudCBvYmplY3RzLgogICAgZnVuY3Rpb24gcGlja0J5KGZuLCBtb21lbnRzKSB7CiAgICAgICAgdmFyIHJlcywgaTsKICAgICAgICBpZiAobW9tZW50cy5sZW5ndGggPT09IDEgJiYgaXNBcnJheShtb21lbnRzWzBdKSkgewogICAgICAgICAgICBtb21lbnRzID0gbW9tZW50c1swXTsKICAgICAgICB9CiAgICAgICAgaWYgKCFtb21lbnRzLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gbW9tZW50KCk7CiAgICAgICAgfQogICAgICAgIHJlcyA9IG1vbWVudHNbMF07CiAgICAgICAgZm9yIChpID0gMTsgaSA8IG1vbWVudHMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgaWYgKG1vbWVudHNbaV1bZm5dKHJlcykpIHsKICAgICAgICAgICAgICAgIHJlcyA9IG1vbWVudHNbaV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICBtb21lbnQubWluID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwoKICAgICAgICByZXR1cm4gcGlja0J5KCdpc0JlZm9yZScsIGFyZ3MpOwogICAgfTsKCiAgICBtb21lbnQubWF4ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwoKICAgICAgICByZXR1cm4gcGlja0J5KCdpc0FmdGVyJywgYXJncyk7CiAgICB9OwoKICAgIC8vIGNyZWF0aW5nIHdpdGggdXRjCiAgICBtb21lbnQudXRjID0gZnVuY3Rpb24gKGlucHV0LCBmb3JtYXQsIGxvY2FsZSwgc3RyaWN0KSB7CiAgICAgICAgdmFyIGM7CgogICAgICAgIGlmICh0eXBlb2YobG9jYWxlKSA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICAgIHN0cmljdCA9IGxvY2FsZTsKICAgICAgICAgICAgbG9jYWxlID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICAvLyBvYmplY3QgY29uc3RydWN0aW9uIG11c3QgYmUgZG9uZSB0aGlzIHdheS4KICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbW9tZW50L21vbWVudC9pc3N1ZXMvMTQyMwogICAgICAgIGMgPSB7fTsKICAgICAgICBjLl9pc0FNb21lbnRPYmplY3QgPSB0cnVlOwogICAgICAgIGMuX3VzZVVUQyA9IHRydWU7CiAgICAgICAgYy5faXNVVEMgPSB0cnVlOwogICAgICAgIGMuX2wgPSBsb2NhbGU7CiAgICAgICAgYy5faSA9IGlucHV0OwogICAgICAgIGMuX2YgPSBmb3JtYXQ7CiAgICAgICAgYy5fc3RyaWN0ID0gc3RyaWN0OwogICAgICAgIGMuX3BmID0gZGVmYXVsdFBhcnNpbmdGbGFncygpOwoKICAgICAgICByZXR1cm4gbWFrZU1vbWVudChjKS51dGMoKTsKICAgIH07CgogICAgLy8gY3JlYXRpbmcgd2l0aCB1bml4IHRpbWVzdGFtcCAoaW4gc2Vjb25kcykKICAgIG1vbWVudC51bml4ID0gZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgcmV0dXJuIG1vbWVudChpbnB1dCAqIDEwMDApOwogICAgfTsKCiAgICAvLyBkdXJhdGlvbgogICAgbW9tZW50LmR1cmF0aW9uID0gZnVuY3Rpb24gKGlucHV0LCBrZXkpIHsKICAgICAgICB2YXIgZHVyYXRpb24gPSBpbnB1dCwKICAgICAgICAgICAgLy8gbWF0Y2hpbmcgYWdhaW5zdCByZWdleHAgaXMgZXhwZW5zaXZlLCBkbyBpdCBvbiBkZW1hbmQKICAgICAgICAgICAgbWF0Y2ggPSBudWxsLAogICAgICAgICAgICBzaWduLAogICAgICAgICAgICByZXQsCiAgICAgICAgICAgIHBhcnNlSXNvLAogICAgICAgICAgICBkaWZmUmVzOwoKICAgICAgICBpZiAobW9tZW50LmlzRHVyYXRpb24oaW5wdXQpKSB7CiAgICAgICAgICAgIGR1cmF0aW9uID0gewogICAgICAgICAgICAgICAgbXM6IGlucHV0Ll9taWxsaXNlY29uZHMsCiAgICAgICAgICAgICAgICBkOiBpbnB1dC5fZGF5cywKICAgICAgICAgICAgICAgIE06IGlucHV0Ll9tb250aHMKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgZHVyYXRpb24gPSB7fTsKICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgZHVyYXRpb25ba2V5XSA9IGlucHV0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZHVyYXRpb24ubWlsbGlzZWNvbmRzID0gaW5wdXQ7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCEhKG1hdGNoID0gYXNwTmV0VGltZVNwYW5Kc29uUmVnZXguZXhlYyhpbnB1dCkpKSB7CiAgICAgICAgICAgIHNpZ24gPSAobWF0Y2hbMV0gPT09ICctJykgPyAtMSA6IDE7CiAgICAgICAgICAgIGR1cmF0aW9uID0gewogICAgICAgICAgICAgICAgeTogMCwKICAgICAgICAgICAgICAgIGQ6IHRvSW50KG1hdGNoW0RBVEVdKSAqIHNpZ24sCiAgICAgICAgICAgICAgICBoOiB0b0ludChtYXRjaFtIT1VSXSkgKiBzaWduLAogICAgICAgICAgICAgICAgbTogdG9JbnQobWF0Y2hbTUlOVVRFXSkgKiBzaWduLAogICAgICAgICAgICAgICAgczogdG9JbnQobWF0Y2hbU0VDT05EXSkgKiBzaWduLAogICAgICAgICAgICAgICAgbXM6IHRvSW50KG1hdGNoW01JTExJU0VDT05EXSkgKiBzaWduCiAgICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIGlmICghIShtYXRjaCA9IGlzb0R1cmF0aW9uUmVnZXguZXhlYyhpbnB1dCkpKSB7CiAgICAgICAgICAgIHNpZ24gPSAobWF0Y2hbMV0gPT09ICctJykgPyAtMSA6IDE7CiAgICAgICAgICAgIHBhcnNlSXNvID0gZnVuY3Rpb24gKGlucCkgewogICAgICAgICAgICAgICAgLy8gV2UnZCBub3JtYWxseSB1c2Ugfn5pbnAgZm9yIHRoaXMsIGJ1dCB1bmZvcnR1bmF0ZWx5IGl0IGFsc28KICAgICAgICAgICAgICAgIC8vIGNvbnZlcnRzIGZsb2F0cyB0byBpbnRzLgogICAgICAgICAgICAgICAgLy8gaW5wIG1heSBiZSB1bmRlZmluZWQsIHNvIGNhcmVmdWwgY2FsbGluZyByZXBsYWNlIG9uIGl0LgogICAgICAgICAgICAgICAgdmFyIHJlcyA9IGlucCAmJiBwYXJzZUZsb2F0KGlucC5yZXBsYWNlKCcsJywgJy4nKSk7CiAgICAgICAgICAgICAgICAvLyBhcHBseSBzaWduIHdoaWxlIHdlJ3JlIGF0IGl0CiAgICAgICAgICAgICAgICByZXR1cm4gKGlzTmFOKHJlcykgPyAwIDogcmVzKSAqIHNpZ247CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGR1cmF0aW9uID0gewogICAgICAgICAgICAgICAgeTogcGFyc2VJc28obWF0Y2hbMl0pLAogICAgICAgICAgICAgICAgTTogcGFyc2VJc28obWF0Y2hbM10pLAogICAgICAgICAgICAgICAgZDogcGFyc2VJc28obWF0Y2hbNF0pLAogICAgICAgICAgICAgICAgaDogcGFyc2VJc28obWF0Y2hbNV0pLAogICAgICAgICAgICAgICAgbTogcGFyc2VJc28obWF0Y2hbNl0pLAogICAgICAgICAgICAgICAgczogcGFyc2VJc28obWF0Y2hbN10pLAogICAgICAgICAgICAgICAgdzogcGFyc2VJc28obWF0Y2hbOF0pCiAgICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZHVyYXRpb24gPT09ICdvYmplY3QnICYmCiAgICAgICAgICAgICAgICAoJ2Zyb20nIGluIGR1cmF0aW9uIHx8ICd0bycgaW4gZHVyYXRpb24pKSB7CiAgICAgICAgICAgIGRpZmZSZXMgPSBtb21lbnRzRGlmZmVyZW5jZShtb21lbnQoZHVyYXRpb24uZnJvbSksIG1vbWVudChkdXJhdGlvbi50bykpOwoKICAgICAgICAgICAgZHVyYXRpb24gPSB7fTsKICAgICAgICAgICAgZHVyYXRpb24ubXMgPSBkaWZmUmVzLm1pbGxpc2Vjb25kczsKICAgICAgICAgICAgZHVyYXRpb24uTSA9IGRpZmZSZXMubW9udGhzOwogICAgICAgIH0KCiAgICAgICAgcmV0ID0gbmV3IER1cmF0aW9uKGR1cmF0aW9uKTsKCiAgICAgICAgaWYgKG1vbWVudC5pc0R1cmF0aW9uKGlucHV0KSAmJiBoYXNPd25Qcm9wKGlucHV0LCAnX2xvY2FsZScpKSB7CiAgICAgICAgICAgIHJldC5fbG9jYWxlID0gaW5wdXQuX2xvY2FsZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXQ7CiAgICB9OwoKICAgIC8vIHZlcnNpb24gbnVtYmVyCiAgICBtb21lbnQudmVyc2lvbiA9IFZFUlNJT047CgogICAgLy8gZGVmYXVsdCBmb3JtYXQKICAgIG1vbWVudC5kZWZhdWx0Rm9ybWF0ID0gaXNvRm9ybWF0OwoKICAgIC8vIGNvbnN0YW50IHRoYXQgcmVmZXJzIHRvIHRoZSBJU08gc3RhbmRhcmQKICAgIG1vbWVudC5JU09fODYwMSA9IGZ1bmN0aW9uICgpIHt9OwoKICAgIC8vIFBsdWdpbnMgdGhhdCBhZGQgcHJvcGVydGllcyBzaG91bGQgYWxzbyBhZGQgdGhlIGtleSBoZXJlIChudWxsIHZhbHVlKSwKICAgIC8vIHNvIHdlIGNhbiBwcm9wZXJseSBjbG9uZSBvdXJzZWx2ZXMuCiAgICBtb21lbnQubW9tZW50UHJvcGVydGllcyA9IG1vbWVudFByb3BlcnRpZXM7CgogICAgLy8gVGhpcyBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciBhIG1vbWVudCBpcyBtdXRhdGVkLgogICAgLy8gSXQgaXMgaW50ZW5kZWQgdG8ga2VlcCB0aGUgb2Zmc2V0IGluIHN5bmMgd2l0aCB0aGUgdGltZXpvbmUuCiAgICBtb21lbnQudXBkYXRlT2Zmc2V0ID0gZnVuY3Rpb24gKCkge307CgogICAgLy8gVGhpcyBmdW5jdGlvbiBhbGxvd3MgeW91IHRvIHNldCBhIHRocmVzaG9sZCBmb3IgcmVsYXRpdmUgdGltZSBzdHJpbmdzCiAgICBtb21lbnQucmVsYXRpdmVUaW1lVGhyZXNob2xkID0gZnVuY3Rpb24gKHRocmVzaG9sZCwgbGltaXQpIHsKICAgICAgICBpZiAocmVsYXRpdmVUaW1lVGhyZXNob2xkc1t0aHJlc2hvbGRdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAobGltaXQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gcmVsYXRpdmVUaW1lVGhyZXNob2xkc1t0aHJlc2hvbGRdOwogICAgICAgIH0KICAgICAgICByZWxhdGl2ZVRpbWVUaHJlc2hvbGRzW3RocmVzaG9sZF0gPSBsaW1pdDsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CgogICAgbW9tZW50LmxhbmcgPSBkZXByZWNhdGUoCiAgICAgICAgJ21vbWVudC5sYW5nIGlzIGRlcHJlY2F0ZWQuIFVzZSBtb21lbnQubG9jYWxlIGluc3RlYWQuJywKICAgICAgICBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gbW9tZW50LmxvY2FsZShrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICApOwoKICAgIC8vIFRoaXMgZnVuY3Rpb24gd2lsbCBsb2FkIGxvY2FsZSBhbmQgdGhlbiBzZXQgdGhlIGdsb2JhbCBsb2NhbGUuICBJZgogICAgLy8gbm8gYXJndW1lbnRzIGFyZSBwYXNzZWQgaW4sIGl0IHdpbGwgc2ltcGx5IHJldHVybiB0aGUgY3VycmVudCBnbG9iYWwKICAgIC8vIGxvY2FsZSBrZXkuCiAgICBtb21lbnQubG9jYWxlID0gZnVuY3Rpb24gKGtleSwgdmFsdWVzKSB7CiAgICAgICAgdmFyIGRhdGE7CiAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICBpZiAodHlwZW9mKHZhbHVlcykgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICBkYXRhID0gbW9tZW50LmRlZmluZUxvY2FsZShrZXksIHZhbHVlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBkYXRhID0gbW9tZW50LmxvY2FsZURhdGEoa2V5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgICAgICAgIG1vbWVudC5kdXJhdGlvbi5fbG9jYWxlID0gbW9tZW50Ll9sb2NhbGUgPSBkYXRhOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbW9tZW50Ll9sb2NhbGUuX2FiYnI7CiAgICB9OwoKICAgIG1vbWVudC5kZWZpbmVMb2NhbGUgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWVzKSB7CiAgICAgICAgaWYgKHZhbHVlcyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YWx1ZXMuYWJiciA9IG5hbWU7CiAgICAgICAgICAgIGlmICghbG9jYWxlc1tuYW1lXSkgewogICAgICAgICAgICAgICAgbG9jYWxlc1tuYW1lXSA9IG5ldyBMb2NhbGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsb2NhbGVzW25hbWVdLnNldCh2YWx1ZXMpOwoKICAgICAgICAgICAgLy8gYmFja3dhcmRzIGNvbXBhdCBmb3Igbm93OiBhbHNvIHNldCB0aGUgbG9jYWxlCiAgICAgICAgICAgIG1vbWVudC5sb2NhbGUobmFtZSk7CgogICAgICAgICAgICByZXR1cm4gbG9jYWxlc1tuYW1lXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyB1c2VmdWwgZm9yIHRlc3RpbmcKICAgICAgICAgICAgZGVsZXRlIGxvY2FsZXNbbmFtZV07CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH07CgogICAgbW9tZW50LmxhbmdEYXRhID0gZGVwcmVjYXRlKAogICAgICAgICdtb21lbnQubGFuZ0RhdGEgaXMgZGVwcmVjYXRlZC4gVXNlIG1vbWVudC5sb2NhbGVEYXRhIGluc3RlYWQuJywKICAgICAgICBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBtb21lbnQubG9jYWxlRGF0YShrZXkpOwogICAgICAgIH0KICAgICk7CgogICAgLy8gcmV0dXJucyBsb2NhbGUgZGF0YQogICAgbW9tZW50LmxvY2FsZURhdGEgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdmFyIGxvY2FsZTsKCiAgICAgICAgaWYgKGtleSAmJiBrZXkuX2xvY2FsZSAmJiBrZXkuX2xvY2FsZS5fYWJicikgewogICAgICAgICAgICBrZXkgPSBrZXkuX2xvY2FsZS5fYWJicjsKICAgICAgICB9CgogICAgICAgIGlmICgha2V5KSB7CiAgICAgICAgICAgIHJldHVybiBtb21lbnQuX2xvY2FsZTsKICAgICAgICB9CgogICAgICAgIGlmICghaXNBcnJheShrZXkpKSB7CiAgICAgICAgICAgIC8vc2hvcnQtY2lyY3VpdCBldmVyeXRoaW5nIGVsc2UKICAgICAgICAgICAgbG9jYWxlID0gbG9hZExvY2FsZShrZXkpOwogICAgICAgICAgICBpZiAobG9jYWxlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbG9jYWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGtleSA9IFtrZXldOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGNob29zZUxvY2FsZShrZXkpOwogICAgfTsKCiAgICAvLyBjb21wYXJlIG1vbWVudCBvYmplY3QKICAgIG1vbWVudC5pc01vbWVudCA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgTW9tZW50IHx8CiAgICAgICAgICAgIChvYmogIT0gbnVsbCAmJiBoYXNPd25Qcm9wKG9iaiwgJ19pc0FNb21lbnRPYmplY3QnKSk7CiAgICB9OwoKICAgIC8vIGZvciB0eXBlY2hlY2tpbmcgRHVyYXRpb24gb2JqZWN0cwogICAgbW9tZW50LmlzRHVyYXRpb24gPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIER1cmF0aW9uOwogICAgfTsKCiAgICBmb3IgKGkgPSBsaXN0cy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgIG1ha2VMaXN0KGxpc3RzW2ldKTsKICAgIH0KCiAgICBtb21lbnQubm9ybWFsaXplVW5pdHMgPSBmdW5jdGlvbiAodW5pdHMpIHsKICAgICAgICByZXR1cm4gbm9ybWFsaXplVW5pdHModW5pdHMpOwogICAgfTsKCiAgICBtb21lbnQuaW52YWxpZCA9IGZ1bmN0aW9uIChmbGFncykgewogICAgICAgIHZhciBtID0gbW9tZW50LnV0YyhOYU4pOwogICAgICAgIGlmIChmbGFncyAhPSBudWxsKSB7CiAgICAgICAgICAgIGV4dGVuZChtLl9wZiwgZmxhZ3MpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgbS5fcGYudXNlckludmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBtOwogICAgfTsKCiAgICBtb21lbnQucGFyc2Vab25lID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBtb21lbnQuYXBwbHkobnVsbCwgYXJndW1lbnRzKS5wYXJzZVpvbmUoKTsKICAgIH07CgogICAgbW9tZW50LnBhcnNlVHdvRGlnaXRZZWFyID0gZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgcmV0dXJuIHRvSW50KGlucHV0KSArICh0b0ludChpbnB1dCkgPiA2OCA/IDE5MDAgOiAyMDAwKTsKICAgIH07CgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIE1vbWVudCBQcm90b3R5cGUKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgZXh0ZW5kKG1vbWVudC5mbiA9IE1vbWVudC5wcm90b3R5cGUsIHsKCiAgICAgICAgY2xvbmUgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBtb21lbnQodGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgdmFsdWVPZiA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuICt0aGlzLl9kICsgKCh0aGlzLl9vZmZzZXQgfHwgMCkgKiA2MDAwMCk7CiAgICAgICAgfSwKCiAgICAgICAgdW5peCA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoK3RoaXMgLyAxMDAwKTsKICAgICAgICB9LAoKICAgICAgICB0b1N0cmluZyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2xvbmUoKS5sb2NhbGUoJ2VuJykuZm9ybWF0KCdkZGQgTU1NIEREIFlZWVkgSEg6bW06c3MgW0dNVF1aWicpOwogICAgICAgIH0sCgogICAgICAgIHRvRGF0ZSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29mZnNldCA/IG5ldyBEYXRlKCt0aGlzKSA6IHRoaXMuX2Q7CiAgICAgICAgfSwKCiAgICAgICAgdG9JU09TdHJpbmcgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBtID0gbW9tZW50KHRoaXMpLnV0YygpOwogICAgICAgICAgICBpZiAoMCA8IG0ueWVhcigpICYmIG0ueWVhcigpIDw9IDk5OTkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmb3JtYXRNb21lbnQobSwgJ1lZWVktTU0tRERbVF1ISDptbTpzcy5TU1NbWl0nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBmb3JtYXRNb21lbnQobSwgJ1lZWVlZWS1NTS1ERFtUXUhIOm1tOnNzLlNTU1taXScpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgdG9BcnJheSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG0gPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgbS55ZWFyKCksCiAgICAgICAgICAgICAgICBtLm1vbnRoKCksCiAgICAgICAgICAgICAgICBtLmRhdGUoKSwKICAgICAgICAgICAgICAgIG0uaG91cnMoKSwKICAgICAgICAgICAgICAgIG0ubWludXRlcygpLAogICAgICAgICAgICAgICAgbS5zZWNvbmRzKCksCiAgICAgICAgICAgICAgICBtLm1pbGxpc2Vjb25kcygpCiAgICAgICAgICAgIF07CiAgICAgICAgfSwKCiAgICAgICAgaXNWYWxpZCA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGlzVmFsaWQodGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgaXNEU1RTaGlmdGVkIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAodGhpcy5fYSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXNWYWxpZCgpICYmIGNvbXBhcmVBcnJheXModGhpcy5fYSwgKHRoaXMuX2lzVVRDID8gbW9tZW50LnV0Yyh0aGlzLl9hKSA6IG1vbWVudCh0aGlzLl9hKSkudG9BcnJheSgpKSA+IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICBwYXJzaW5nRmxhZ3MgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBleHRlbmQoe30sIHRoaXMuX3BmKTsKICAgICAgICB9LAoKICAgICAgICBpbnZhbGlkQXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BmLm92ZXJmbG93OwogICAgICAgIH0sCgogICAgICAgIHV0YyA6IGZ1bmN0aW9uIChrZWVwTG9jYWxUaW1lKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnpvbmUoMCwga2VlcExvY2FsVGltZSk7CiAgICAgICAgfSwKCiAgICAgICAgbG9jYWwgOiBmdW5jdGlvbiAoa2VlcExvY2FsVGltZSkgewogICAgICAgICAgICBpZiAodGhpcy5faXNVVEMpIHsKICAgICAgICAgICAgICAgIHRoaXMuem9uZSgwLCBrZWVwTG9jYWxUaW1lKTsKICAgICAgICAgICAgICAgIHRoaXMuX2lzVVRDID0gZmFsc2U7CgogICAgICAgICAgICAgICAgaWYgKGtlZXBMb2NhbFRpbWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZCh0aGlzLl9kYXRlVHpPZmZzZXQoKSwgJ20nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICBmb3JtYXQgOiBmdW5jdGlvbiAoaW5wdXRTdHJpbmcpIHsKICAgICAgICAgICAgdmFyIG91dHB1dCA9IGZvcm1hdE1vbWVudCh0aGlzLCBpbnB1dFN0cmluZyB8fCBtb21lbnQuZGVmYXVsdEZvcm1hdCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS5wb3N0Zm9ybWF0KG91dHB1dCk7CiAgICAgICAgfSwKCiAgICAgICAgYWRkIDogY3JlYXRlQWRkZXIoMSwgJ2FkZCcpLAoKICAgICAgICBzdWJ0cmFjdCA6IGNyZWF0ZUFkZGVyKC0xLCAnc3VidHJhY3QnKSwKCiAgICAgICAgZGlmZiA6IGZ1bmN0aW9uIChpbnB1dCwgdW5pdHMsIGFzRmxvYXQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSBtYWtlQXMoaW5wdXQsIHRoaXMpLAogICAgICAgICAgICAgICAgem9uZURpZmYgPSAodGhpcy56b25lKCkgLSB0aGF0LnpvbmUoKSkgKiA2ZTQsCiAgICAgICAgICAgICAgICBkaWZmLCBvdXRwdXQsIGRheXNBZGp1c3Q7CgogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKCiAgICAgICAgICAgIGlmICh1bml0cyA9PT0gJ3llYXInIHx8IHVuaXRzID09PSAnbW9udGgnKSB7CiAgICAgICAgICAgICAgICAvLyBhdmVyYWdlIG51bWJlciBvZiBkYXlzIGluIHRoZSBtb250aHMgaW4gdGhlIGdpdmVuIGRhdGVzCiAgICAgICAgICAgICAgICBkaWZmID0gKHRoaXMuZGF5c0luTW9udGgoKSArIHRoYXQuZGF5c0luTW9udGgoKSkgKiA0MzJlNTsgLy8gMjQgKiA2MCAqIDYwICogMTAwMCAvIDIKICAgICAgICAgICAgICAgIC8vIGRpZmZlcmVuY2UgaW4gbW9udGhzCiAgICAgICAgICAgICAgICBvdXRwdXQgPSAoKHRoaXMueWVhcigpIC0gdGhhdC55ZWFyKCkpICogMTIpICsgKHRoaXMubW9udGgoKSAtIHRoYXQubW9udGgoKSk7CiAgICAgICAgICAgICAgICAvLyBhZGp1c3QgYnkgdGFraW5nIGRpZmZlcmVuY2UgaW4gZGF5cywgYXZlcmFnZSBudW1iZXIgb2YgZGF5cwogICAgICAgICAgICAgICAgLy8gYW5kIGRzdCBpbiB0aGUgZ2l2ZW4gbW9udGhzLgogICAgICAgICAgICAgICAgZGF5c0FkanVzdCA9ICh0aGlzIC0gbW9tZW50KHRoaXMpLnN0YXJ0T2YoJ21vbnRoJykpIC0KICAgICAgICAgICAgICAgICAgICAodGhhdCAtIG1vbWVudCh0aGF0KS5zdGFydE9mKCdtb250aCcpKTsKICAgICAgICAgICAgICAgIC8vIHNhbWUgYXMgYWJvdmUgYnV0IHdpdGggem9uZXMsIHRvIG5lZ2F0ZSBhbGwgZHN0CiAgICAgICAgICAgICAgICBkYXlzQWRqdXN0IC09ICgodGhpcy56b25lKCkgLSBtb21lbnQodGhpcykuc3RhcnRPZignbW9udGgnKS56b25lKCkpIC0KICAgICAgICAgICAgICAgICAgICAgICAgKHRoYXQuem9uZSgpIC0gbW9tZW50KHRoYXQpLnN0YXJ0T2YoJ21vbnRoJykuem9uZSgpKSkgKiA2ZTQ7CiAgICAgICAgICAgICAgICBvdXRwdXQgKz0gZGF5c0FkanVzdCAvIGRpZmY7CiAgICAgICAgICAgICAgICBpZiAodW5pdHMgPT09ICd5ZWFyJykgewogICAgICAgICAgICAgICAgICAgIG91dHB1dCA9IG91dHB1dCAvIDEyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGlmZiA9ICh0aGlzIC0gdGhhdCk7CiAgICAgICAgICAgICAgICBvdXRwdXQgPSB1bml0cyA9PT0gJ3NlY29uZCcgPyBkaWZmIC8gMWUzIDogLy8gMTAwMAogICAgICAgICAgICAgICAgICAgIHVuaXRzID09PSAnbWludXRlJyA/IGRpZmYgLyA2ZTQgOiAvLyAxMDAwICogNjAKICAgICAgICAgICAgICAgICAgICB1bml0cyA9PT0gJ2hvdXInID8gZGlmZiAvIDM2ZTUgOiAvLyAxMDAwICogNjAgKiA2MAogICAgICAgICAgICAgICAgICAgIHVuaXRzID09PSAnZGF5JyA/IChkaWZmIC0gem9uZURpZmYpIC8gODY0ZTUgOiAvLyAxMDAwICogNjAgKiA2MCAqIDI0LCBuZWdhdGUgZHN0CiAgICAgICAgICAgICAgICAgICAgdW5pdHMgPT09ICd3ZWVrJyA/IChkaWZmIC0gem9uZURpZmYpIC8gNjA0OGU1IDogLy8gMTAwMCAqIDYwICogNjAgKiAyNCAqIDcsIG5lZ2F0ZSBkc3QKICAgICAgICAgICAgICAgICAgICBkaWZmOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhc0Zsb2F0ID8gb3V0cHV0IDogYWJzUm91bmQob3V0cHV0KTsKICAgICAgICB9LAoKICAgICAgICBmcm9tIDogZnVuY3Rpb24gKHRpbWUsIHdpdGhvdXRTdWZmaXgpIHsKICAgICAgICAgICAgcmV0dXJuIG1vbWVudC5kdXJhdGlvbih7dG86IHRoaXMsIGZyb206IHRpbWV9KS5sb2NhbGUodGhpcy5sb2NhbGUoKSkuaHVtYW5pemUoIXdpdGhvdXRTdWZmaXgpOwogICAgICAgIH0sCgogICAgICAgIGZyb21Ob3cgOiBmdW5jdGlvbiAod2l0aG91dFN1ZmZpeCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5mcm9tKG1vbWVudCgpLCB3aXRob3V0U3VmZml4KTsKICAgICAgICB9LAoKICAgICAgICBjYWxlbmRhciA6IGZ1bmN0aW9uICh0aW1lKSB7CiAgICAgICAgICAgIC8vIFdlIHdhbnQgdG8gY29tcGFyZSB0aGUgc3RhcnQgb2YgdG9kYXksIHZzIHRoaXMuCiAgICAgICAgICAgIC8vIEdldHRpbmcgc3RhcnQtb2YtdG9kYXkgZGVwZW5kcyBvbiB3aGV0aGVyIHdlJ3JlIHpvbmUnZCBvciBub3QuCiAgICAgICAgICAgIHZhciBub3cgPSB0aW1lIHx8IG1vbWVudCgpLAogICAgICAgICAgICAgICAgc29kID0gbWFrZUFzKG5vdywgdGhpcykuc3RhcnRPZignZGF5JyksCiAgICAgICAgICAgICAgICBkaWZmID0gdGhpcy5kaWZmKHNvZCwgJ2RheXMnLCB0cnVlKSwKICAgICAgICAgICAgICAgIGZvcm1hdCA9IGRpZmYgPCAtNiA/ICdzYW1lRWxzZScgOgogICAgICAgICAgICAgICAgICAgIGRpZmYgPCAtMSA/ICdsYXN0V2VlaycgOgogICAgICAgICAgICAgICAgICAgIGRpZmYgPCAwID8gJ2xhc3REYXknIDoKICAgICAgICAgICAgICAgICAgICBkaWZmIDwgMSA/ICdzYW1lRGF5JyA6CiAgICAgICAgICAgICAgICAgICAgZGlmZiA8IDIgPyAnbmV4dERheScgOgogICAgICAgICAgICAgICAgICAgIGRpZmYgPCA3ID8gJ25leHRXZWVrJyA6ICdzYW1lRWxzZSc7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdCh0aGlzLmxvY2FsZURhdGEoKS5jYWxlbmRhcihmb3JtYXQsIHRoaXMpKTsKICAgICAgICB9LAoKICAgICAgICBpc0xlYXBZZWFyIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gaXNMZWFwWWVhcih0aGlzLnllYXIoKSk7CiAgICAgICAgfSwKCiAgICAgICAgaXNEU1QgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiAodGhpcy56b25lKCkgPCB0aGlzLmNsb25lKCkubW9udGgoMCkuem9uZSgpIHx8CiAgICAgICAgICAgICAgICB0aGlzLnpvbmUoKSA8IHRoaXMuY2xvbmUoKS5tb250aCg1KS56b25lKCkpOwogICAgICAgIH0sCgogICAgICAgIGRheSA6IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgICB2YXIgZGF5ID0gdGhpcy5faXNVVEMgPyB0aGlzLl9kLmdldFVUQ0RheSgpIDogdGhpcy5fZC5nZXREYXkoKTsKICAgICAgICAgICAgaWYgKGlucHV0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gcGFyc2VXZWVrZGF5KGlucHV0LCB0aGlzLmxvY2FsZURhdGEoKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZGQoaW5wdXQgLSBkYXksICdkJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF5OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgbW9udGggOiBtYWtlQWNjZXNzb3IoJ01vbnRoJywgdHJ1ZSksCgogICAgICAgIHN0YXJ0T2YgOiBmdW5jdGlvbiAodW5pdHMpIHsKICAgICAgICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CiAgICAgICAgICAgIC8vIHRoZSBmb2xsb3dpbmcgc3dpdGNoIGludGVudGlvbmFsbHkgb21pdHMgYnJlYWsga2V5d29yZHMKICAgICAgICAgICAgLy8gdG8gdXRpbGl6ZSBmYWxsaW5nIHRocm91Z2ggdGhlIGNhc2VzLgogICAgICAgICAgICBzd2l0Y2ggKHVuaXRzKSB7CiAgICAgICAgICAgIGNhc2UgJ3llYXInOgogICAgICAgICAgICAgICAgdGhpcy5tb250aCgwKTsKICAgICAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICAgICAgY2FzZSAncXVhcnRlcic6CiAgICAgICAgICAgIGNhc2UgJ21vbnRoJzoKICAgICAgICAgICAgICAgIHRoaXMuZGF0ZSgxKTsKICAgICAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICAgICAgY2FzZSAnd2Vlayc6CiAgICAgICAgICAgIGNhc2UgJ2lzb1dlZWsnOgogICAgICAgICAgICBjYXNlICdkYXknOgogICAgICAgICAgICAgICAgdGhpcy5ob3VycygwKTsKICAgICAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICAgICAgY2FzZSAnaG91cic6CiAgICAgICAgICAgICAgICB0aGlzLm1pbnV0ZXMoMCk7CiAgICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgIGNhc2UgJ21pbnV0ZSc6CiAgICAgICAgICAgICAgICB0aGlzLnNlY29uZHMoMCk7CiAgICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgIGNhc2UgJ3NlY29uZCc6CiAgICAgICAgICAgICAgICB0aGlzLm1pbGxpc2Vjb25kcygwKTsKICAgICAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gd2Vla3MgYXJlIGEgc3BlY2lhbCBjYXNlCiAgICAgICAgICAgIGlmICh1bml0cyA9PT0gJ3dlZWsnKSB7CiAgICAgICAgICAgICAgICB0aGlzLndlZWtkYXkoMCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodW5pdHMgPT09ICdpc29XZWVrJykgewogICAgICAgICAgICAgICAgdGhpcy5pc29XZWVrZGF5KDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBxdWFydGVycyBhcmUgYWxzbyBzcGVjaWFsCiAgICAgICAgICAgIGlmICh1bml0cyA9PT0gJ3F1YXJ0ZXInKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vbnRoKE1hdGguZmxvb3IodGhpcy5tb250aCgpIC8gMykgKiAzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgZW5kT2Y6IGZ1bmN0aW9uICh1bml0cykgewogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RhcnRPZih1bml0cykuYWRkKDEsICh1bml0cyA9PT0gJ2lzb1dlZWsnID8gJ3dlZWsnIDogdW5pdHMpKS5zdWJ0cmFjdCgxLCAnbXMnKTsKICAgICAgICB9LAoKICAgICAgICBpc0FmdGVyOiBmdW5jdGlvbiAoaW5wdXQsIHVuaXRzKSB7CiAgICAgICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModHlwZW9mIHVuaXRzICE9PSAndW5kZWZpbmVkJyA/IHVuaXRzIDogJ21pbGxpc2Vjb25kJyk7CiAgICAgICAgICAgIGlmICh1bml0cyA9PT0gJ21pbGxpc2Vjb25kJykgewogICAgICAgICAgICAgICAgaW5wdXQgPSBtb21lbnQuaXNNb21lbnQoaW5wdXQpID8gaW5wdXQgOiBtb21lbnQoaW5wdXQpOwogICAgICAgICAgICAgICAgcmV0dXJuICt0aGlzID4gK2lucHV0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuICt0aGlzLmNsb25lKCkuc3RhcnRPZih1bml0cykgPiArbW9tZW50KGlucHV0KS5zdGFydE9mKHVuaXRzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGlzQmVmb3JlOiBmdW5jdGlvbiAoaW5wdXQsIHVuaXRzKSB7CiAgICAgICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModHlwZW9mIHVuaXRzICE9PSAndW5kZWZpbmVkJyA/IHVuaXRzIDogJ21pbGxpc2Vjb25kJyk7CiAgICAgICAgICAgIGlmICh1bml0cyA9PT0gJ21pbGxpc2Vjb25kJykgewogICAgICAgICAgICAgICAgaW5wdXQgPSBtb21lbnQuaXNNb21lbnQoaW5wdXQpID8gaW5wdXQgOiBtb21lbnQoaW5wdXQpOwogICAgICAgICAgICAgICAgcmV0dXJuICt0aGlzIDwgK2lucHV0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuICt0aGlzLmNsb25lKCkuc3RhcnRPZih1bml0cykgPCArbW9tZW50KGlucHV0KS5zdGFydE9mKHVuaXRzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGlzU2FtZTogZnVuY3Rpb24gKGlucHV0LCB1bml0cykgewogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzIHx8ICdtaWxsaXNlY29uZCcpOwogICAgICAgICAgICBpZiAodW5pdHMgPT09ICdtaWxsaXNlY29uZCcpIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gbW9tZW50LmlzTW9tZW50KGlucHV0KSA/IGlucHV0IDogbW9tZW50KGlucHV0KTsKICAgICAgICAgICAgICAgIHJldHVybiArdGhpcyA9PT0gK2lucHV0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuICt0aGlzLmNsb25lKCkuc3RhcnRPZih1bml0cykgPT09ICttYWtlQXMoaW5wdXQsIHRoaXMpLnN0YXJ0T2YodW5pdHMpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgbWluOiBkZXByZWNhdGUoCiAgICAgICAgICAgICAgICAgJ21vbWVudCgpLm1pbiBpcyBkZXByZWNhdGVkLCB1c2UgbW9tZW50Lm1pbiBpbnN0ZWFkLiBodHRwczovL2dpdGh1Yi5jb20vbW9tZW50L21vbWVudC9pc3N1ZXMvMTU0OCcsCiAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKG90aGVyKSB7CiAgICAgICAgICAgICAgICAgICAgIG90aGVyID0gbW9tZW50LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvdGhlciA8IHRoaXMgPyB0aGlzIDogb3RoZXI7CiAgICAgICAgICAgICAgICAgfQogICAgICAgICApLAoKICAgICAgICBtYXg6IGRlcHJlY2F0ZSgKICAgICAgICAgICAgICAgICdtb21lbnQoKS5tYXggaXMgZGVwcmVjYXRlZCwgdXNlIG1vbWVudC5tYXggaW5zdGVhZC4gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudC9tb21lbnQvaXNzdWVzLzE1NDgnLAogICAgICAgICAgICAgICAgZnVuY3Rpb24gKG90aGVyKSB7CiAgICAgICAgICAgICAgICAgICAgb3RoZXIgPSBtb21lbnQuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3RoZXIgPiB0aGlzID8gdGhpcyA6IG90aGVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICksCgogICAgICAgIC8vIGtlZXBMb2NhbFRpbWUgPSB0cnVlIG1lYW5zIG9ubHkgY2hhbmdlIHRoZSB0aW1lem9uZSwgd2l0aG91dAogICAgICAgIC8vIGFmZmVjdGluZyB0aGUgbG9jYWwgaG91ci4gU28gNTozMToyNiArMDMwMCAtLVt6b25lKDIsIHRydWUpXS0tPgogICAgICAgIC8vIDU6MzE6MjYgKzAyMDAgSXQgaXMgcG9zc2libGUgdGhhdCA1OjMxOjI2IGRvZXNuJ3QgZXhpc3QgaW50IHpvbmUKICAgICAgICAvLyArMDIwMCwgc28gd2UgYWRqdXN0IHRoZSB0aW1lIGFzIG5lZWRlZCwgdG8gYmUgdmFsaWQuCiAgICAgICAgLy8KICAgICAgICAvLyBLZWVwaW5nIHRoZSB0aW1lIGFjdHVhbGx5IGFkZHMvc3VidHJhY3RzIChvbmUgaG91cikKICAgICAgICAvLyBmcm9tIHRoZSBhY3R1YWwgcmVwcmVzZW50ZWQgdGltZS4gVGhhdCBpcyB3aHkgd2UgY2FsbCB1cGRhdGVPZmZzZXQKICAgICAgICAvLyBhIHNlY29uZCB0aW1lLiBJbiBjYXNlIGl0IHdhbnRzIHVzIHRvIGNoYW5nZSB0aGUgb2Zmc2V0IGFnYWluCiAgICAgICAgLy8gX2NoYW5nZUluUHJvZ3Jlc3MgPT0gdHJ1ZSBjYXNlLCB0aGVuIHdlIGhhdmUgdG8gYWRqdXN0LCBiZWNhdXNlCiAgICAgICAgLy8gdGhlcmUgaXMgbm8gc3VjaCB0aW1lIGluIHRoZSBnaXZlbiB0aW1lem9uZS4KICAgICAgICB6b25lIDogZnVuY3Rpb24gKGlucHV0LCBrZWVwTG9jYWxUaW1lKSB7CiAgICAgICAgICAgIHZhciBvZmZzZXQgPSB0aGlzLl9vZmZzZXQgfHwgMCwKICAgICAgICAgICAgICAgIGxvY2FsQWRqdXN0OwogICAgICAgICAgICBpZiAoaW5wdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBpbnB1dCA9IHRpbWV6b25lTWludXRlc0Zyb21TdHJpbmcoaW5wdXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGlucHV0KSA8IDE2KSB7CiAgICAgICAgICAgICAgICAgICAgaW5wdXQgPSBpbnB1dCAqIDYwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9pc1VUQyAmJiBrZWVwTG9jYWxUaW1lKSB7CiAgICAgICAgICAgICAgICAgICAgbG9jYWxBZGp1c3QgPSB0aGlzLl9kYXRlVHpPZmZzZXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX29mZnNldCA9IGlucHV0OwogICAgICAgICAgICAgICAgdGhpcy5faXNVVEMgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKGxvY2FsQWRqdXN0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN1YnRyYWN0KGxvY2FsQWRqdXN0LCAnbScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9mZnNldCAhPT0gaW5wdXQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWtlZXBMb2NhbFRpbWUgfHwgdGhpcy5fY2hhbmdlSW5Qcm9ncmVzcykgewogICAgICAgICAgICAgICAgICAgICAgICBhZGRPclN1YnRyYWN0RHVyYXRpb25Gcm9tTW9tZW50KHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50LmR1cmF0aW9uKG9mZnNldCAtIGlucHV0LCAnbScpLCAxLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5fY2hhbmdlSW5Qcm9ncmVzcykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VJblByb2dyZXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50LnVwZGF0ZU9mZnNldCh0aGlzLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2lzVVRDID8gb2Zmc2V0IDogdGhpcy5fZGF0ZVR6T2Zmc2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgem9uZUFiYnIgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pc1VUQyA/ICdVVEMnIDogJyc7CiAgICAgICAgfSwKCiAgICAgICAgem9uZU5hbWUgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pc1VUQyA/ICdDb29yZGluYXRlZCBVbml2ZXJzYWwgVGltZScgOiAnJzsKICAgICAgICB9LAoKICAgICAgICBwYXJzZVpvbmUgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl90em0pIHsKICAgICAgICAgICAgICAgIHRoaXMuem9uZSh0aGlzLl90em0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0aGlzLl9pID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgdGhpcy56b25lKHRoaXMuX2kpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIGhhc0FsaWduZWRIb3VyT2Zmc2V0IDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIGlmICghaW5wdXQpIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gbW9tZW50KGlucHV0KS56b25lKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAodGhpcy56b25lKCkgLSBpbnB1dCkgJSA2MCA9PT0gMDsKICAgICAgICB9LAoKICAgICAgICBkYXlzSW5Nb250aCA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGRheXNJbk1vbnRoKHRoaXMueWVhcigpLCB0aGlzLm1vbnRoKCkpOwogICAgICAgIH0sCgogICAgICAgIGRheU9mWWVhciA6IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgICB2YXIgZGF5T2ZZZWFyID0gcm91bmQoKG1vbWVudCh0aGlzKS5zdGFydE9mKCdkYXknKSAtIG1vbWVudCh0aGlzKS5zdGFydE9mKCd5ZWFyJykpIC8gODY0ZTUpICsgMTsKICAgICAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyBkYXlPZlllYXIgOiB0aGlzLmFkZCgoaW5wdXQgLSBkYXlPZlllYXIpLCAnZCcpOwogICAgICAgIH0sCgogICAgICAgIHF1YXJ0ZXIgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyBNYXRoLmNlaWwoKHRoaXMubW9udGgoKSArIDEpIC8gMykgOiB0aGlzLm1vbnRoKChpbnB1dCAtIDEpICogMyArIHRoaXMubW9udGgoKSAlIDMpOwogICAgICAgIH0sCgogICAgICAgIHdlZWtZZWFyIDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIHZhciB5ZWFyID0gd2Vla09mWWVhcih0aGlzLCB0aGlzLmxvY2FsZURhdGEoKS5fd2Vlay5kb3csIHRoaXMubG9jYWxlRGF0YSgpLl93ZWVrLmRveSkueWVhcjsKICAgICAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB5ZWFyIDogdGhpcy5hZGQoKGlucHV0IC0geWVhciksICd5Jyk7CiAgICAgICAgfSwKCiAgICAgICAgaXNvV2Vla1llYXIgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgdmFyIHllYXIgPSB3ZWVrT2ZZZWFyKHRoaXMsIDEsIDQpLnllYXI7CiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8geWVhciA6IHRoaXMuYWRkKChpbnB1dCAtIHllYXIpLCAneScpOwogICAgICAgIH0sCgogICAgICAgIHdlZWsgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgdmFyIHdlZWsgPSB0aGlzLmxvY2FsZURhdGEoKS53ZWVrKHRoaXMpOwogICAgICAgICAgICByZXR1cm4gaW5wdXQgPT0gbnVsbCA/IHdlZWsgOiB0aGlzLmFkZCgoaW5wdXQgLSB3ZWVrKSAqIDcsICdkJyk7CiAgICAgICAgfSwKCiAgICAgICAgaXNvV2VlayA6IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgICB2YXIgd2VlayA9IHdlZWtPZlllYXIodGhpcywgMSwgNCkud2VlazsKICAgICAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB3ZWVrIDogdGhpcy5hZGQoKGlucHV0IC0gd2VlaykgKiA3LCAnZCcpOwogICAgICAgIH0sCgogICAgICAgIHdlZWtkYXkgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgdmFyIHdlZWtkYXkgPSAodGhpcy5kYXkoKSArIDcgLSB0aGlzLmxvY2FsZURhdGEoKS5fd2Vlay5kb3cpICUgNzsKICAgICAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB3ZWVrZGF5IDogdGhpcy5hZGQoaW5wdXQgLSB3ZWVrZGF5LCAnZCcpOwogICAgICAgIH0sCgogICAgICAgIGlzb1dlZWtkYXkgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgLy8gYmVoYXZlcyB0aGUgc2FtZSBhcyBtb21lbnQjZGF5IGV4Y2VwdAogICAgICAgICAgICAvLyBhcyBhIGdldHRlciwgcmV0dXJucyA3IGluc3RlYWQgb2YgMCAoMS03IHJhbmdlIGluc3RlYWQgb2YgMC02KQogICAgICAgICAgICAvLyBhcyBhIHNldHRlciwgc3VuZGF5IHNob3VsZCBiZWxvbmcgdG8gdGhlIHByZXZpb3VzIHdlZWsuCiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gdGhpcy5kYXkoKSB8fCA3IDogdGhpcy5kYXkodGhpcy5kYXkoKSAlIDcgPyBpbnB1dCA6IGlucHV0IC0gNyk7CiAgICAgICAgfSwKCiAgICAgICAgaXNvV2Vla3NJblllYXIgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB3ZWVrc0luWWVhcih0aGlzLnllYXIoKSwgMSwgNCk7CiAgICAgICAgfSwKCiAgICAgICAgd2Vla3NJblllYXIgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB3ZWVrSW5mbyA9IHRoaXMubG9jYWxlRGF0YSgpLl93ZWVrOwogICAgICAgICAgICByZXR1cm4gd2Vla3NJblllYXIodGhpcy55ZWFyKCksIHdlZWtJbmZvLmRvdywgd2Vla0luZm8uZG95KTsKICAgICAgICB9LAoKICAgICAgICBnZXQgOiBmdW5jdGlvbiAodW5pdHMpIHsKICAgICAgICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzW3VuaXRzXSgpOwogICAgICAgIH0sCgogICAgICAgIHNldCA6IGZ1bmN0aW9uICh1bml0cywgdmFsdWUpIHsKICAgICAgICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpc1t1bml0c10gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHRoaXNbdW5pdHNdKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAvLyBJZiBwYXNzZWQgYSBsb2NhbGUga2V5LCBpdCB3aWxsIHNldCB0aGUgbG9jYWxlIGZvciB0aGlzCiAgICAgICAgLy8gaW5zdGFuY2UuICBPdGhlcndpc2UsIGl0IHdpbGwgcmV0dXJuIHRoZSBsb2NhbGUgY29uZmlndXJhdGlvbgogICAgICAgIC8vIHZhcmlhYmxlcyBmb3IgdGhpcyBpbnN0YW5jZS4KICAgICAgICBsb2NhbGUgOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHZhciBuZXdMb2NhbGVEYXRhOwoKICAgICAgICAgICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbG9jYWxlLl9hYmJyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3TG9jYWxlRGF0YSA9IG1vbWVudC5sb2NhbGVEYXRhKGtleSk7CiAgICAgICAgICAgICAgICBpZiAobmV3TG9jYWxlRGF0YSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9jYWxlID0gbmV3TG9jYWxlRGF0YTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgbGFuZyA6IGRlcHJlY2F0ZSgKICAgICAgICAgICAgJ21vbWVudCgpLmxhbmcoKSBpcyBkZXByZWNhdGVkLiBVc2UgbW9tZW50KCkubG9jYWxlRGF0YSgpIGluc3RlYWQuJywKICAgICAgICAgICAgZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGUoa2V5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICksCgogICAgICAgIGxvY2FsZURhdGEgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9sb2NhbGU7CiAgICAgICAgfSwKCiAgICAgICAgX2RhdGVUek9mZnNldCA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy8gT24gRmlyZWZveC4yNCBEYXRlI2dldFRpbWV6b25lT2Zmc2V0IHJldHVybnMgYSBmbG9hdGluZyBwb2ludC4KICAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudC9tb21lbnQvcHVsbC8xODcxCiAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHRoaXMuX2QuZ2V0VGltZXpvbmVPZmZzZXQoKSAvIDE1KSAqIDE1OwogICAgICAgIH0KICAgIH0pOwoKICAgIGZ1bmN0aW9uIHJhd01vbnRoU2V0dGVyKG1vbSwgdmFsdWUpIHsKICAgICAgICB2YXIgZGF5T2ZNb250aDsKCiAgICAgICAgLy8gVE9ETzogTW92ZSB0aGlzIG91dCBvZiBoZXJlIQogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHZhbHVlID0gbW9tLmxvY2FsZURhdGEoKS5tb250aHNQYXJzZSh2YWx1ZSk7CiAgICAgICAgICAgIC8vIFRPRE86IEFub3RoZXIgc2lsZW50IGZhaWx1cmU/CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW9tOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBkYXlPZk1vbnRoID0gTWF0aC5taW4obW9tLmRhdGUoKSwKICAgICAgICAgICAgICAgIGRheXNJbk1vbnRoKG1vbS55ZWFyKCksIHZhbHVlKSk7CiAgICAgICAgbW9tLl9kWydzZXQnICsgKG1vbS5faXNVVEMgPyAnVVRDJyA6ICcnKSArICdNb250aCddKHZhbHVlLCBkYXlPZk1vbnRoKTsKICAgICAgICByZXR1cm4gbW9tOwogICAgfQoKICAgIGZ1bmN0aW9uIHJhd0dldHRlcihtb20sIHVuaXQpIHsKICAgICAgICByZXR1cm4gbW9tLl9kWydnZXQnICsgKG1vbS5faXNVVEMgPyAnVVRDJyA6ICcnKSArIHVuaXRdKCk7CiAgICB9CgogICAgZnVuY3Rpb24gcmF3U2V0dGVyKG1vbSwgdW5pdCwgdmFsdWUpIHsKICAgICAgICBpZiAodW5pdCA9PT0gJ01vbnRoJykgewogICAgICAgICAgICByZXR1cm4gcmF3TW9udGhTZXR0ZXIobW9tLCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG1vbS5fZFsnc2V0JyArIChtb20uX2lzVVRDID8gJ1VUQycgOiAnJykgKyB1bml0XSh2YWx1ZSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VBY2Nlc3Nvcih1bml0LCBrZWVwVGltZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJhd1NldHRlcih0aGlzLCB1bml0LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBtb21lbnQudXBkYXRlT2Zmc2V0KHRoaXMsIGtlZXBUaW1lKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHJhd0dldHRlcih0aGlzLCB1bml0KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgogICAgbW9tZW50LmZuLm1pbGxpc2Vjb25kID0gbW9tZW50LmZuLm1pbGxpc2Vjb25kcyA9IG1ha2VBY2Nlc3NvcignTWlsbGlzZWNvbmRzJywgZmFsc2UpOwogICAgbW9tZW50LmZuLnNlY29uZCA9IG1vbWVudC5mbi5zZWNvbmRzID0gbWFrZUFjY2Vzc29yKCdTZWNvbmRzJywgZmFsc2UpOwogICAgbW9tZW50LmZuLm1pbnV0ZSA9IG1vbWVudC5mbi5taW51dGVzID0gbWFrZUFjY2Vzc29yKCdNaW51dGVzJywgZmFsc2UpOwogICAgLy8gU2V0dGluZyB0aGUgaG91ciBzaG91bGQga2VlcCB0aGUgdGltZSwgYmVjYXVzZSB0aGUgdXNlciBleHBsaWNpdGx5CiAgICAvLyBzcGVjaWZpZWQgd2hpY2ggaG91ciBoZSB3YW50cy4gU28gdHJ5aW5nIHRvIG1haW50YWluIHRoZSBzYW1lIGhvdXIgKGluCiAgICAvLyBhIG5ldyB0aW1lem9uZSkgbWFrZXMgc2Vuc2UuIEFkZGluZy9zdWJ0cmFjdGluZyBob3VycyBkb2VzIG5vdCBmb2xsb3cKICAgIC8vIHRoaXMgcnVsZS4KICAgIG1vbWVudC5mbi5ob3VyID0gbW9tZW50LmZuLmhvdXJzID0gbWFrZUFjY2Vzc29yKCdIb3VycycsIHRydWUpOwogICAgLy8gbW9tZW50LmZuLm1vbnRoIGlzIGRlZmluZWQgc2VwYXJhdGVseQogICAgbW9tZW50LmZuLmRhdGUgPSBtYWtlQWNjZXNzb3IoJ0RhdGUnLCB0cnVlKTsKICAgIG1vbWVudC5mbi5kYXRlcyA9IGRlcHJlY2F0ZSgnZGF0ZXMgYWNjZXNzb3IgaXMgZGVwcmVjYXRlZC4gVXNlIGRhdGUgaW5zdGVhZC4nLCBtYWtlQWNjZXNzb3IoJ0RhdGUnLCB0cnVlKSk7CiAgICBtb21lbnQuZm4ueWVhciA9IG1ha2VBY2Nlc3NvcignRnVsbFllYXInLCB0cnVlKTsKICAgIG1vbWVudC5mbi55ZWFycyA9IGRlcHJlY2F0ZSgneWVhcnMgYWNjZXNzb3IgaXMgZGVwcmVjYXRlZC4gVXNlIHllYXIgaW5zdGVhZC4nLCBtYWtlQWNjZXNzb3IoJ0Z1bGxZZWFyJywgdHJ1ZSkpOwoKICAgIC8vIGFkZCBwbHVyYWwgbWV0aG9kcwogICAgbW9tZW50LmZuLmRheXMgPSBtb21lbnQuZm4uZGF5OwogICAgbW9tZW50LmZuLm1vbnRocyA9IG1vbWVudC5mbi5tb250aDsKICAgIG1vbWVudC5mbi53ZWVrcyA9IG1vbWVudC5mbi53ZWVrOwogICAgbW9tZW50LmZuLmlzb1dlZWtzID0gbW9tZW50LmZuLmlzb1dlZWs7CiAgICBtb21lbnQuZm4ucXVhcnRlcnMgPSBtb21lbnQuZm4ucXVhcnRlcjsKCiAgICAvLyBhZGQgYWxpYXNlZCBmb3JtYXQgbWV0aG9kcwogICAgbW9tZW50LmZuLnRvSlNPTiA9IG1vbWVudC5mbi50b0lTT1N0cmluZzsKCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgRHVyYXRpb24gUHJvdG90eXBlCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoKICAgIGZ1bmN0aW9uIGRheXNUb1llYXJzIChkYXlzKSB7CiAgICAgICAgLy8gNDAwIHllYXJzIGhhdmUgMTQ2MDk3IGRheXMgKHRha2luZyBpbnRvIGFjY291bnQgbGVhcCB5ZWFyIHJ1bGVzKQogICAgICAgIHJldHVybiBkYXlzICogNDAwIC8gMTQ2MDk3OwogICAgfQoKICAgIGZ1bmN0aW9uIHllYXJzVG9EYXlzICh5ZWFycykgewogICAgICAgIC8vIHllYXJzICogMzY1ICsgYWJzUm91bmQoeWVhcnMgLyA0KSAtCiAgICAgICAgLy8gICAgIGFic1JvdW5kKHllYXJzIC8gMTAwKSArIGFic1JvdW5kKHllYXJzIC8gNDAwKTsKICAgICAgICByZXR1cm4geWVhcnMgKiAxNDYwOTcgLyA0MDA7CiAgICB9CgogICAgZXh0ZW5kKG1vbWVudC5kdXJhdGlvbi5mbiA9IER1cmF0aW9uLnByb3RvdHlwZSwgewoKICAgICAgICBfYnViYmxlIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgbWlsbGlzZWNvbmRzID0gdGhpcy5fbWlsbGlzZWNvbmRzLAogICAgICAgICAgICAgICAgZGF5cyA9IHRoaXMuX2RheXMsCiAgICAgICAgICAgICAgICBtb250aHMgPSB0aGlzLl9tb250aHMsCiAgICAgICAgICAgICAgICBkYXRhID0gdGhpcy5fZGF0YSwKICAgICAgICAgICAgICAgIHNlY29uZHMsIG1pbnV0ZXMsIGhvdXJzLCB5ZWFycyA9IDA7CgogICAgICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGNvZGUgYnViYmxlcyB1cCB2YWx1ZXMsIHNlZSB0aGUgdGVzdHMgZm9yCiAgICAgICAgICAgIC8vIGV4YW1wbGVzIG9mIHdoYXQgdGhhdCBtZWFucy4KICAgICAgICAgICAgZGF0YS5taWxsaXNlY29uZHMgPSBtaWxsaXNlY29uZHMgJSAxMDAwOwoKICAgICAgICAgICAgc2Vjb25kcyA9IGFic1JvdW5kKG1pbGxpc2Vjb25kcyAvIDEwMDApOwogICAgICAgICAgICBkYXRhLnNlY29uZHMgPSBzZWNvbmRzICUgNjA7CgogICAgICAgICAgICBtaW51dGVzID0gYWJzUm91bmQoc2Vjb25kcyAvIDYwKTsKICAgICAgICAgICAgZGF0YS5taW51dGVzID0gbWludXRlcyAlIDYwOwoKICAgICAgICAgICAgaG91cnMgPSBhYnNSb3VuZChtaW51dGVzIC8gNjApOwogICAgICAgICAgICBkYXRhLmhvdXJzID0gaG91cnMgJSAyNDsKCiAgICAgICAgICAgIGRheXMgKz0gYWJzUm91bmQoaG91cnMgLyAyNCk7CgogICAgICAgICAgICAvLyBBY2N1cmF0ZWx5IGNvbnZlcnQgZGF5cyB0byB5ZWFycywgYXNzdW1lIHN0YXJ0IGZyb20geWVhciAwLgogICAgICAgICAgICB5ZWFycyA9IGFic1JvdW5kKGRheXNUb1llYXJzKGRheXMpKTsKICAgICAgICAgICAgZGF5cyAtPSBhYnNSb3VuZCh5ZWFyc1RvRGF5cyh5ZWFycykpOwoKICAgICAgICAgICAgLy8gMzAgZGF5cyB0byBhIG1vbnRoCiAgICAgICAgICAgIC8vIFRPRE8gKGlza3Jlbik6IFVzZSBhbmNob3IgZGF0ZSAobGlrZSAxc3QgSmFuKSB0byBjb21wdXRlIHRoaXMuCiAgICAgICAgICAgIG1vbnRocyArPSBhYnNSb3VuZChkYXlzIC8gMzApOwogICAgICAgICAgICBkYXlzICU9IDMwOwoKICAgICAgICAgICAgLy8gMTIgbW9udGhzIC0+IDEgeWVhcgogICAgICAgICAgICB5ZWFycyArPSBhYnNSb3VuZChtb250aHMgLyAxMik7CiAgICAgICAgICAgIG1vbnRocyAlPSAxMjsKCiAgICAgICAgICAgIGRhdGEuZGF5cyA9IGRheXM7CiAgICAgICAgICAgIGRhdGEubW9udGhzID0gbW9udGhzOwogICAgICAgICAgICBkYXRhLnllYXJzID0geWVhcnM7CiAgICAgICAgfSwKCiAgICAgICAgYWJzIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLl9taWxsaXNlY29uZHMgPSBNYXRoLmFicyh0aGlzLl9taWxsaXNlY29uZHMpOwogICAgICAgICAgICB0aGlzLl9kYXlzID0gTWF0aC5hYnModGhpcy5fZGF5cyk7CiAgICAgICAgICAgIHRoaXMuX21vbnRocyA9IE1hdGguYWJzKHRoaXMuX21vbnRocyk7CgogICAgICAgICAgICB0aGlzLl9kYXRhLm1pbGxpc2Vjb25kcyA9IE1hdGguYWJzKHRoaXMuX2RhdGEubWlsbGlzZWNvbmRzKTsKICAgICAgICAgICAgdGhpcy5fZGF0YS5zZWNvbmRzID0gTWF0aC5hYnModGhpcy5fZGF0YS5zZWNvbmRzKTsKICAgICAgICAgICAgdGhpcy5fZGF0YS5taW51dGVzID0gTWF0aC5hYnModGhpcy5fZGF0YS5taW51dGVzKTsKICAgICAgICAgICAgdGhpcy5fZGF0YS5ob3VycyA9IE1hdGguYWJzKHRoaXMuX2RhdGEuaG91cnMpOwogICAgICAgICAgICB0aGlzLl9kYXRhLm1vbnRocyA9IE1hdGguYWJzKHRoaXMuX2RhdGEubW9udGhzKTsKICAgICAgICAgICAgdGhpcy5fZGF0YS55ZWFycyA9IE1hdGguYWJzKHRoaXMuX2RhdGEueWVhcnMpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgd2Vla3MgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBhYnNSb3VuZCh0aGlzLmRheXMoKSAvIDcpOwogICAgICAgIH0sCgogICAgICAgIHZhbHVlT2YgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9taWxsaXNlY29uZHMgKwogICAgICAgICAgICAgIHRoaXMuX2RheXMgKiA4NjRlNSArCiAgICAgICAgICAgICAgKHRoaXMuX21vbnRocyAlIDEyKSAqIDI1OTJlNiArCiAgICAgICAgICAgICAgdG9JbnQodGhpcy5fbW9udGhzIC8gMTIpICogMzE1MzZlNjsKICAgICAgICB9LAoKICAgICAgICBodW1hbml6ZSA6IGZ1bmN0aW9uICh3aXRoU3VmZml4KSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSByZWxhdGl2ZVRpbWUodGhpcywgIXdpdGhTdWZmaXgsIHRoaXMubG9jYWxlRGF0YSgpKTsKCiAgICAgICAgICAgIGlmICh3aXRoU3VmZml4KSB7CiAgICAgICAgICAgICAgICBvdXRwdXQgPSB0aGlzLmxvY2FsZURhdGEoKS5wYXN0RnV0dXJlKCt0aGlzLCBvdXRwdXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkucG9zdGZvcm1hdChvdXRwdXQpOwogICAgICAgIH0sCgogICAgICAgIGFkZCA6IGZ1bmN0aW9uIChpbnB1dCwgdmFsKSB7CiAgICAgICAgICAgIC8vIHN1cHBvcnRzIG9ubHkgMi4wLXN0eWxlIGFkZCgxLCAncycpIG9yIGFkZChtb21lbnQpCiAgICAgICAgICAgIHZhciBkdXIgPSBtb21lbnQuZHVyYXRpb24oaW5wdXQsIHZhbCk7CgogICAgICAgICAgICB0aGlzLl9taWxsaXNlY29uZHMgKz0gZHVyLl9taWxsaXNlY29uZHM7CiAgICAgICAgICAgIHRoaXMuX2RheXMgKz0gZHVyLl9kYXlzOwogICAgICAgICAgICB0aGlzLl9tb250aHMgKz0gZHVyLl9tb250aHM7CgogICAgICAgICAgICB0aGlzLl9idWJibGUoKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHN1YnRyYWN0IDogZnVuY3Rpb24gKGlucHV0LCB2YWwpIHsKICAgICAgICAgICAgdmFyIGR1ciA9IG1vbWVudC5kdXJhdGlvbihpbnB1dCwgdmFsKTsKCiAgICAgICAgICAgIHRoaXMuX21pbGxpc2Vjb25kcyAtPSBkdXIuX21pbGxpc2Vjb25kczsKICAgICAgICAgICAgdGhpcy5fZGF5cyAtPSBkdXIuX2RheXM7CiAgICAgICAgICAgIHRoaXMuX21vbnRocyAtPSBkdXIuX21vbnRoczsKCiAgICAgICAgICAgIHRoaXMuX2J1YmJsZSgpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgZ2V0IDogZnVuY3Rpb24gKHVuaXRzKSB7CiAgICAgICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwogICAgICAgICAgICByZXR1cm4gdGhpc1t1bml0cy50b0xvd2VyQ2FzZSgpICsgJ3MnXSgpOwogICAgICAgIH0sCgogICAgICAgIGFzIDogZnVuY3Rpb24gKHVuaXRzKSB7CiAgICAgICAgICAgIHZhciBkYXlzLCBtb250aHM7CiAgICAgICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwoKICAgICAgICAgICAgaWYgKHVuaXRzID09PSAnbW9udGgnIHx8IHVuaXRzID09PSAneWVhcicpIHsKICAgICAgICAgICAgICAgIGRheXMgPSB0aGlzLl9kYXlzICsgdGhpcy5fbWlsbGlzZWNvbmRzIC8gODY0ZTU7CiAgICAgICAgICAgICAgICBtb250aHMgPSB0aGlzLl9tb250aHMgKyBkYXlzVG9ZZWFycyhkYXlzKSAqIDEyOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuaXRzID09PSAnbW9udGgnID8gbW9udGhzIDogbW9udGhzIC8gMTI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBoYW5kbGUgbWlsbGlzZWNvbmRzIHNlcGFyYXRlbHkgYmVjYXVzZSBvZiBmbG9hdGluZyBwb2ludCBtYXRoIGVycm9ycyAoaXNzdWUgIzE4NjcpCiAgICAgICAgICAgICAgICBkYXlzID0gdGhpcy5fZGF5cyArIHllYXJzVG9EYXlzKHRoaXMuX21vbnRocyAvIDEyKTsKICAgICAgICAgICAgICAgIHN3aXRjaCAodW5pdHMpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICd3ZWVrJzogcmV0dXJuIGRheXMgLyA3ICsgdGhpcy5fbWlsbGlzZWNvbmRzIC8gNjA0OGU1OwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ2RheSc6IHJldHVybiBkYXlzICsgdGhpcy5fbWlsbGlzZWNvbmRzIC8gODY0ZTU7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnaG91cic6IHJldHVybiBkYXlzICogMjQgKyB0aGlzLl9taWxsaXNlY29uZHMgLyAzNmU1OwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ21pbnV0ZSc6IHJldHVybiBkYXlzICogMjQgKiA2MCArIHRoaXMuX21pbGxpc2Vjb25kcyAvIDZlNDsKICAgICAgICAgICAgICAgICAgICBjYXNlICdzZWNvbmQnOiByZXR1cm4gZGF5cyAqIDI0ICogNjAgKiA2MCArIHRoaXMuX21pbGxpc2Vjb25kcyAvIDEwMDA7CiAgICAgICAgICAgICAgICAgICAgLy8gTWF0aC5mbG9vciBwcmV2ZW50cyBmbG9hdGluZyBwb2ludCBtYXRoIGVycm9ycyBoZXJlCiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbWlsbGlzZWNvbmQnOiByZXR1cm4gTWF0aC5mbG9vcihkYXlzICogMjQgKiA2MCAqIDYwICogMTAwMCkgKyB0aGlzLl9taWxsaXNlY29uZHM7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDogdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHVuaXQgJyArIHVuaXRzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGxhbmcgOiBtb21lbnQuZm4ubGFuZywKICAgICAgICBsb2NhbGUgOiBtb21lbnQuZm4ubG9jYWxlLAoKICAgICAgICB0b0lzb1N0cmluZyA6IGRlcHJlY2F0ZSgKICAgICAgICAgICAgJ3RvSXNvU3RyaW5nKCkgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHVzZSB0b0lTT1N0cmluZygpIGluc3RlYWQgJyArCiAgICAgICAgICAgICcobm90aWNlIHRoZSBjYXBpdGFscyknLAogICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50b0lTT1N0cmluZygpOwogICAgICAgICAgICB9CiAgICAgICAgKSwKCiAgICAgICAgdG9JU09TdHJpbmcgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vIGluc3BpcmVkIGJ5IGh0dHBzOi8vZ2l0aHViLmNvbS9kb3JkaWxsZS9tb21lbnQtaXNvZHVyYXRpb24vYmxvYi9tYXN0ZXIvbW9tZW50Lmlzb2R1cmF0aW9uLmpzCiAgICAgICAgICAgIHZhciB5ZWFycyA9IE1hdGguYWJzKHRoaXMueWVhcnMoKSksCiAgICAgICAgICAgICAgICBtb250aHMgPSBNYXRoLmFicyh0aGlzLm1vbnRocygpKSwKICAgICAgICAgICAgICAgIGRheXMgPSBNYXRoLmFicyh0aGlzLmRheXMoKSksCiAgICAgICAgICAgICAgICBob3VycyA9IE1hdGguYWJzKHRoaXMuaG91cnMoKSksCiAgICAgICAgICAgICAgICBtaW51dGVzID0gTWF0aC5hYnModGhpcy5taW51dGVzKCkpLAogICAgICAgICAgICAgICAgc2Vjb25kcyA9IE1hdGguYWJzKHRoaXMuc2Vjb25kcygpICsgdGhpcy5taWxsaXNlY29uZHMoKSAvIDEwMDApOwoKICAgICAgICAgICAgaWYgKCF0aGlzLmFzU2Vjb25kcygpKSB7CiAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIHRoZSBzYW1lIGFzIEMjJ3MgKE5vZGEpIGFuZCBweXRob24gKGlzb2RhdGUpLi4uCiAgICAgICAgICAgICAgICAvLyBidXQgbm90IG90aGVyIEpTIChnb29nLmRhdGUpCiAgICAgICAgICAgICAgICByZXR1cm4gJ1AwRCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAodGhpcy5hc1NlY29uZHMoKSA8IDAgPyAnLScgOiAnJykgKwogICAgICAgICAgICAgICAgJ1AnICsKICAgICAgICAgICAgICAgICh5ZWFycyA/IHllYXJzICsgJ1knIDogJycpICsKICAgICAgICAgICAgICAgIChtb250aHMgPyBtb250aHMgKyAnTScgOiAnJykgKwogICAgICAgICAgICAgICAgKGRheXMgPyBkYXlzICsgJ0QnIDogJycpICsKICAgICAgICAgICAgICAgICgoaG91cnMgfHwgbWludXRlcyB8fCBzZWNvbmRzKSA/ICdUJyA6ICcnKSArCiAgICAgICAgICAgICAgICAoaG91cnMgPyBob3VycyArICdIJyA6ICcnKSArCiAgICAgICAgICAgICAgICAobWludXRlcyA/IG1pbnV0ZXMgKyAnTScgOiAnJykgKwogICAgICAgICAgICAgICAgKHNlY29uZHMgPyBzZWNvbmRzICsgJ1MnIDogJycpOwogICAgICAgIH0sCgogICAgICAgIGxvY2FsZURhdGEgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9sb2NhbGU7CiAgICAgICAgfQogICAgfSk7CgogICAgbW9tZW50LmR1cmF0aW9uLmZuLnRvU3RyaW5nID0gbW9tZW50LmR1cmF0aW9uLmZuLnRvSVNPU3RyaW5nOwoKICAgIGZ1bmN0aW9uIG1ha2VEdXJhdGlvbkdldHRlcihuYW1lKSB7CiAgICAgICAgbW9tZW50LmR1cmF0aW9uLmZuW25hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZGF0YVtuYW1lXTsKICAgICAgICB9OwogICAgfQoKICAgIGZvciAoaSBpbiB1bml0TWlsbGlzZWNvbmRGYWN0b3JzKSB7CiAgICAgICAgaWYgKGhhc093blByb3AodW5pdE1pbGxpc2Vjb25kRmFjdG9ycywgaSkpIHsKICAgICAgICAgICAgbWFrZUR1cmF0aW9uR2V0dGVyKGkudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIG1vbWVudC5kdXJhdGlvbi5mbi5hc01pbGxpc2Vjb25kcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hcygnbXMnKTsKICAgIH07CiAgICBtb21lbnQuZHVyYXRpb24uZm4uYXNTZWNvbmRzID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmFzKCdzJyk7CiAgICB9OwogICAgbW9tZW50LmR1cmF0aW9uLmZuLmFzTWludXRlcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hcygnbScpOwogICAgfTsKICAgIG1vbWVudC5kdXJhdGlvbi5mbi5hc0hvdXJzID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmFzKCdoJyk7CiAgICB9OwogICAgbW9tZW50LmR1cmF0aW9uLmZuLmFzRGF5cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hcygnZCcpOwogICAgfTsKICAgIG1vbWVudC5kdXJhdGlvbi5mbi5hc1dlZWtzID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmFzKCd3ZWVrcycpOwogICAgfTsKICAgIG1vbWVudC5kdXJhdGlvbi5mbi5hc01vbnRocyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hcygnTScpOwogICAgfTsKICAgIG1vbWVudC5kdXJhdGlvbi5mbi5hc1llYXJzID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmFzKCd5Jyk7CiAgICB9OwoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBEZWZhdWx0IExvY2FsZQogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCiAgICAvLyBTZXQgZGVmYXVsdCBsb2NhbGUsIG90aGVyIGxvY2FsZSB3aWxsIGluaGVyaXQgZnJvbSBFbmdsaXNoLgogICAgbW9tZW50LmxvY2FsZSgnZW4nLCB7CiAgICAgICAgb3JkaW5hbCA6IGZ1bmN0aW9uIChudW1iZXIpIHsKICAgICAgICAgICAgdmFyIGIgPSBudW1iZXIgJSAxMCwKICAgICAgICAgICAgICAgIG91dHB1dCA9ICh0b0ludChudW1iZXIgJSAxMDAgLyAxMCkgPT09IDEpID8gJ3RoJyA6CiAgICAgICAgICAgICAgICAoYiA9PT0gMSkgPyAnc3QnIDoKICAgICAgICAgICAgICAgIChiID09PSAyKSA/ICduZCcgOgogICAgICAgICAgICAgICAgKGIgPT09IDMpID8gJ3JkJyA6ICd0aCc7CiAgICAgICAgICAgIHJldHVybiBudW1iZXIgKyBvdXRwdXQ7CiAgICAgICAgfQogICAgfSk7CgogICAgLyogRU1CRURfTE9DQUxFUyAqLwoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBFeHBvc2luZyBNb21lbnQKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCiAgICBmdW5jdGlvbiBtYWtlR2xvYmFsKHNob3VsZERlcHJlY2F0ZSkgewogICAgICAgIC8qZ2xvYmFsIGVuZGVyOmZhbHNlICovCiAgICAgICAgaWYgKHR5cGVvZiBlbmRlciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBvbGRHbG9iYWxNb21lbnQgPSBnbG9iYWxTY29wZS5tb21lbnQ7CiAgICAgICAgaWYgKHNob3VsZERlcHJlY2F0ZSkgewogICAgICAgICAgICBnbG9iYWxTY29wZS5tb21lbnQgPSBkZXByZWNhdGUoCiAgICAgICAgICAgICAgICAgICAgJ0FjY2Vzc2luZyBNb21lbnQgdGhyb3VnaCB0aGUgZ2xvYmFsIHNjb3BlIGlzICcgKwogICAgICAgICAgICAgICAgICAgICdkZXByZWNhdGVkLCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGFuIHVwY29taW5nICcgKwogICAgICAgICAgICAgICAgICAgICdyZWxlYXNlLicsCiAgICAgICAgICAgICAgICAgICAgbW9tZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnbG9iYWxTY29wZS5tb21lbnQgPSBtb21lbnQ7CiAgICAgICAgfQogICAgfQoKICAgIC8vIENvbW1vbkpTIG1vZHVsZSBpcyBkZWZpbmVkCiAgICBpZiAoaGFzTW9kdWxlKSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBtb21lbnQ7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIGRlZmluZSgnbW9tZW50JywgZnVuY3Rpb24gKHJlcXVpcmUsIGV4cG9ydHMsIG1vZHVsZSkgewogICAgICAgICAgICBpZiAobW9kdWxlLmNvbmZpZyAmJiBtb2R1bGUuY29uZmlnKCkgJiYgbW9kdWxlLmNvbmZpZygpLm5vR2xvYmFsID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAvLyByZWxlYXNlIHRoZSBnbG9iYWwgdmFyaWFibGUKICAgICAgICAgICAgICAgIGdsb2JhbFNjb3BlLm1vbWVudCA9IG9sZEdsb2JhbE1vbWVudDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIG1vbWVudDsKICAgICAgICB9KTsKICAgICAgICBtYWtlR2xvYmFsKHRydWUpOwogICAgfSBlbHNlIHsKICAgICAgICBtYWtlR2xvYmFsKCk7CiAgICB9Cn0pLmNhbGwodGhpcyk7CgovKiBhbmd1bGFyLW1vbWVudC5qcyAvIHYwLjguMiAvIChjKSAyMDEzLCAyMDE0IFVyaSBTaGFrZWQgLyBNSVQgTGljZW5jZSAqLwoKLyogZ2xvYmFsIGRlZmluZSAqLwoKKGZ1bmN0aW9uICgpIHsKCSd1c2Ugc3RyaWN0JzsKCglmdW5jdGlvbiBhbmd1bGFyTW9tZW50KGFuZ3VsYXIsIG1vbWVudCkgewoKCQkvKioKCQkgKiBAbmdkb2Mgb3ZlcnZpZXcKCQkgKiBAbmFtZSBhbmd1bGFyTW9tZW50CgkJICoKCQkgKiBAZGVzY3JpcHRpb24KCQkgKiBhbmd1bGFyTW9tZW50IG1vZHVsZSBwcm92aWRlcyBtb21lbnQuanMgZnVuY3Rpb25hbGl0eSBmb3IgYW5ndWxhci5qcyBhcHBzLgoJCSAqLwoJCXJldHVybiBhbmd1bGFyLm1vZHVsZSgnYW5ndWxhck1vbWVudCcsIFtdKQoKCQkvKioKCQkgKiBAbmdkb2Mgb2JqZWN0CgkJICogQG5hbWUgYW5ndWxhck1vbWVudC5jb25maWc6YW5ndWxhck1vbWVudENvbmZpZwoJCSAqCgkJICogQGRlc2NyaXB0aW9uCgkJICogQ29tbW9uIGNvbmZpZ3VyYXRpb24gb2YgdGhlIGFuZ3VsYXJNb21lbnQgbW9kdWxlCgkJICovCgkJCS5jb25zdGFudCgnYW5ndWxhck1vbWVudENvbmZpZycsIHsKCQkJCS8qKgoJCQkJICogQG5nZG9jIHByb3BlcnR5CgkJCQkgKiBAbmFtZSBhbmd1bGFyTW9tZW50LmNvbmZpZy5hbmd1bGFyTW9tZW50Q29uZmlnI3ByZXByb2Nlc3MKCQkJCSAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXJNb21lbnQuY29uZmlnOmFuZ3VsYXJNb21lbnRDb25maWcKCQkJCSAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBkZWZhdWx0IHByZXByb2Nlc3NvciB0byBhcHBseQoJCQkJICoKCQkJCSAqIEBkZXNjcmlwdGlvbgoJCQkJICogRGVmaW5lcyBhIGRlZmF1bHQgcHJlcHJvY2Vzc29yIHRvIGFwcGx5IChlLmcuICd1bml4JywgJ2V0YycsIC4uLikuIFRoZSBkZWZhdWx0IHZhbHVlIGlzIG51bGwsCgkJCQkgKiBpLmUuIG5vIHByZXByb2Nlc3NvciB3aWxsIGJlIGFwcGxpZWQuCgkJCQkgKi8KCQkJCXByZXByb2Nlc3M6IG51bGwsIC8vIGUuZy4gJ3VuaXgnLCAndXRjJywgLi4uCgoJCQkJLyoqCgkJCQkgKiBAbmdkb2MgcHJvcGVydHkKCQkJCSAqIEBuYW1lIGFuZ3VsYXJNb21lbnQuY29uZmlnLmFuZ3VsYXJNb21lbnRDb25maWcjdGltZXpvbmUKCQkJCSAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXJNb21lbnQuY29uZmlnOmFuZ3VsYXJNb21lbnRDb25maWcKCQkJCSAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBkZWZhdWx0IHRpbWV6b25lCgkJCQkgKgoJCQkJICogQGRlc2NyaXB0aW9uCgkJCQkgKiBUaGUgZGVmYXVsdCB0aW1lem9uZSAoZS5nLiAnRXVyb3BlL0xvbmRvbicpLiBFbXB0eSBzdHJpbmcgYnkgZGVmYXVsdCAoZG9lcyBub3QgYXBwbHkKCQkJCSAqIGFueSB0aW1lem9uZSBzaGlmdCkuCgkJCQkgKi8KCQkJCXRpbWV6b25lOiAnJywKCgkJCQkvKioKCQkJCSAqIEBuZ2RvYyBwcm9wZXJ0eQoJCQkJICogQG5hbWUgYW5ndWxhck1vbWVudC5jb25maWcuYW5ndWxhck1vbWVudENvbmZpZyNmb3JtYXQKCQkJCSAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXJNb21lbnQuY29uZmlnOmFuZ3VsYXJNb21lbnRDb25maWcKCQkJCSAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBwcmUtY29udmVyc2lvbiBmb3JtYXQgb2YgdGhlIGRhdGUKCQkJCSAqCgkJCQkgKiBAZGVzY3JpcHRpb24KCQkJCSAqIFNwZWNpZnkgdGhlIGZvcm1hdCBvZiB0aGUgaW5wdXQgZGF0ZS4gRXNzZW50aWFsbHkgaXQncyBhCgkJCQkgKiBkZWZhdWx0IGFuZCBzYXZlcyB5b3UgZnJvbSBzcGVjaWZ5aW5nIGEgZm9ybWF0IGluIGV2ZXJ5CgkJCQkgKiBlbGVtZW50LiBPdmVycmlkZGVuIGJ5IGVsZW1lbnQgYXR0ci4gTnVsbCBieSBkZWZhdWx0LgoJCQkJICovCgkJCQlmb3JtYXQ6IG51bGwKCQkJfSkKCgkJLyoqCgkJICogQG5nZG9jIG9iamVjdAoJCSAqIEBuYW1lIGFuZ3VsYXJNb21lbnQub2JqZWN0Om1vbWVudAoJCSAqCgkJICogQGRlc2NyaXB0aW9uCgkJICogbW9tZW50IGdsb2JhbCAoYXMgcHJvdmlkZWQgYnkgdGhlIG1vbWVudC5qcyBsaWJyYXJ5KQoJCSAqLwoJCQkuY29uc3RhbnQoJ21vbWVudCcsIG1vbWVudCkKCgkJLyoqCgkJICogQG5nZG9jIG9iamVjdAoJCSAqIEBuYW1lIGFuZ3VsYXJNb21lbnQuY29uZmlnOmFtVGltZUFnb0NvbmZpZwoJCSAqIEBtb2R1bGUgYW5ndWxhck1vbWVudAoJCSAqCgkJICogQGRlc2NyaXB0aW9uCgkJICogY29uZmlndXJhdGlvbiBzcGVjaWZpYyB0byB0aGUgYW1UaW1lQWdvIGRpcmVjdGl2ZQoJCSAqLwoJCQkuY29uc3RhbnQoJ2FtVGltZUFnb0NvbmZpZycsIHsKCQkJCS8qKgoJCQkJICogQG5nZG9jIHByb3BlcnR5CgkJCQkgKiBAbmFtZSBhbmd1bGFyTW9tZW50LmNvbmZpZy5hbVRpbWVBZ29Db25maWcjd2l0aG91dFN1ZmZpeAoJCQkJICogQHByb3BlcnR5T2YgYW5ndWxhck1vbWVudC5jb25maWc6YW1UaW1lQWdvQ29uZmlnCgkJCQkgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB0byBpbmNsdWRlIGEgc3VmZml4IGluIGFtLXRpbWUtYWdvIGRpcmVjdGl2ZQoJCQkJICoKCQkJCSAqIEBkZXNjcmlwdGlvbgoJCQkJICogRGVmYXVsdHMgdG8gZmFsc2UuCgkJCQkgKi8KCQkJCXdpdGhvdXRTdWZmaXg6IGZhbHNlLAoKCQkJCS8qKgoJCQkJICogQG5nZG9jIHByb3BlcnR5CgkJCQkgKiBAbmFtZSBhbmd1bGFyTW9tZW50LmNvbmZpZy5hbVRpbWVBZ29Db25maWcjc2VydmVyVGltZQoJCQkJICogQHByb3BlcnR5T2YgYW5ndWxhck1vbWVudC5jb25maWc6YW1UaW1lQWdvQ29uZmlnCgkJCQkgKiBAcmV0dXJucyB7bnVtYmVyfSBTZXJ2ZXIgdGltZSBpbiBtaWxsaXNlY29uZHMgc2luY2UgdGhlIGVwb2NoCgkJCQkgKgoJCQkJICogQGRlc2NyaXB0aW9uCgkJCQkgKiBJZiBzZXQsIHRpbWUgYWdvIHdpbGwgYmUgY2FsY3VsYXRlZCByZWxhdGl2ZSB0byB0aGUgZ2l2ZW4gdmFsdWUuCgkJCQkgKiBJZiBudWxsLCBsb2NhbCB0aW1lIHdpbGwgYmUgdXNlZC4gRGVmYXVsdHMgdG8gbnVsbC4KCQkJCSAqLwoJCQkJc2VydmVyVGltZTogbnVsbAoJCQl9KQoKCQkvKioKCQkgKiBAbmdkb2MgZGlyZWN0aXZlCgkJICogQG5hbWUgYW5ndWxhck1vbWVudC5kaXJlY3RpdmU6YW1UaW1lQWdvCgkJICogQG1vZHVsZSBhbmd1bGFyTW9tZW50CgkJICoKCQkgKiBAcmVzdHJpY3QgQQoJCSAqLwoJCQkuZGlyZWN0aXZlKCdhbVRpbWVBZ28nLCBbJyR3aW5kb3cnLCAnbW9tZW50JywgJ2FtTW9tZW50JywgJ2FtVGltZUFnb0NvbmZpZycsICdhbmd1bGFyTW9tZW50Q29uZmlnJywgZnVuY3Rpb24gKCR3aW5kb3csIG1vbWVudCwgYW1Nb21lbnQsIGFtVGltZUFnb0NvbmZpZywgYW5ndWxhck1vbWVudENvbmZpZykgewoKCQkJCXJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKCQkJCQl2YXIgYWN0aXZlVGltZW91dCA9IG51bGw7CgkJCQkJdmFyIGN1cnJlbnRWYWx1ZTsKCQkJCQl2YXIgY3VycmVudEZvcm1hdCA9IGFuZ3VsYXJNb21lbnRDb25maWcuZm9ybWF0OwoJCQkJCXZhciB3aXRob3V0U3VmZml4ID0gYW1UaW1lQWdvQ29uZmlnLndpdGhvdXRTdWZmaXg7CgkJCQkJdmFyIGxvY2FsRGF0ZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoJCQkJCXZhciBwcmVwcm9jZXNzID0gYW5ndWxhck1vbWVudENvbmZpZy5wcmVwcm9jZXNzOwoJCQkJCXZhciBtb2RlbE5hbWUgPSBhdHRyLmFtVGltZUFnby5yZXBsYWNlKC9eOjovLCAnJyk7CgkJCQkJdmFyIGlzQmluZE9uY2UgPSAoYXR0ci5hbVRpbWVBZ28uaW5kZXhPZignOjonKSA9PT0gMCk7CgkJCQkJdmFyIGlzVGltZUVsZW1lbnQgPSAoJ1RJTUUnID09PSBlbGVtZW50WzBdLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCkpOwoJCQkJCXZhciB1bndhdGNoQ2hhbmdlczsKCgkJCQkJZnVuY3Rpb24gZ2V0Tm93KCkgewoJCQkJCQl2YXIgbm93OwoJCQkJCQlpZiAoYW1UaW1lQWdvQ29uZmlnLnNlcnZlclRpbWUpIHsKCQkJCQkJCXZhciBsb2NhbE5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoJCQkJCQkJdmFyIG5vd01pbGxpcyA9IGxvY2FsTm93IC0gbG9jYWxEYXRlICsgYW1UaW1lQWdvQ29uZmlnLnNlcnZlclRpbWU7CgkJCQkJCQlub3cgPSBtb21lbnQobm93TWlsbGlzKTsKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJCW5vdyA9IG1vbWVudCgpOwoJCQkJCQl9CgkJCQkJCXJldHVybiBub3c7CgkJCQkJfQoKCQkJCQlmdW5jdGlvbiBjYW5jZWxUaW1lcigpIHsKCQkJCQkJaWYgKGFjdGl2ZVRpbWVvdXQpIHsKCQkJCQkJCSR3aW5kb3cuY2xlYXJUaW1lb3V0KGFjdGl2ZVRpbWVvdXQpOwoJCQkJCQkJYWN0aXZlVGltZW91dCA9IG51bGw7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWZ1bmN0aW9uIHVwZGF0ZVRpbWUobW9tZW50SW5zdGFuY2UpIHsKCQkJCQkJZWxlbWVudC50ZXh0KG1vbWVudEluc3RhbmNlLmZyb20oZ2V0Tm93KCksIHdpdGhvdXRTdWZmaXgpKTsKCQkJCQkJaWYgKCFpc0JpbmRPbmNlKSB7CgoJCQkJCQkJdmFyIGhvd09sZCA9IE1hdGguYWJzKGdldE5vdygpLmRpZmYobW9tZW50SW5zdGFuY2UsICdtaW51dGUnKSk7CgkJCQkJCQl2YXIgc2Vjb25kc1VudGlsVXBkYXRlID0gMzYwMDsKCQkJCQkJCWlmIChob3dPbGQgPCAxKSB7CgkJCQkJCQkJc2Vjb25kc1VudGlsVXBkYXRlID0gMTsKCQkJCQkJCX0gZWxzZSBpZiAoaG93T2xkIDwgNjApIHsKCQkJCQkJCQlzZWNvbmRzVW50aWxVcGRhdGUgPSAzMDsKCQkJCQkJCX0gZWxzZSBpZiAoaG93T2xkIDwgMTgwKSB7CgkJCQkJCQkJc2Vjb25kc1VudGlsVXBkYXRlID0gMzAwOwoJCQkJCQkJfQoKCQkJCQkJCWFjdGl2ZVRpbWVvdXQgPSAkd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewoJCQkJCQkJCXVwZGF0ZVRpbWUobW9tZW50SW5zdGFuY2UpOwoJCQkJCQkJfSwgc2Vjb25kc1VudGlsVXBkYXRlICogMTAwMCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWZ1bmN0aW9uIHVwZGF0ZURhdGVUaW1lQXR0cih2YWx1ZSkgewoJCQkJCQlpZiAoaXNUaW1lRWxlbWVudCkgewoJCQkJCQkJZWxlbWVudC5hdHRyKCdkYXRldGltZScsIHZhbHVlKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJZnVuY3Rpb24gdXBkYXRlTW9tZW50KCkgewoJCQkJCQljYW5jZWxUaW1lcigpOwoJCQkJCQlpZiAoY3VycmVudFZhbHVlKSB7CgkJCQkJCQl2YXIgbW9tZW50VmFsdWUgPSBhbU1vbWVudC5wcmVwcm9jZXNzRGF0ZShjdXJyZW50VmFsdWUsIHByZXByb2Nlc3MsIGN1cnJlbnRGb3JtYXQpOwoJCQkJCQkJdXBkYXRlVGltZShtb21lbnRWYWx1ZSk7CgkJCQkJCQl1cGRhdGVEYXRlVGltZUF0dHIobW9tZW50VmFsdWUudG9JU09TdHJpbmcoKSk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCXVud2F0Y2hDaGFuZ2VzID0gc2NvcGUuJHdhdGNoKG1vZGVsTmFtZSwgZnVuY3Rpb24gKHZhbHVlKSB7CgkJCQkJCWlmICgodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJykgfHwgKHZhbHVlID09PSBudWxsKSB8fCAodmFsdWUgPT09ICcnKSkgewoJCQkJCQkJY2FuY2VsVGltZXIoKTsKCQkJCQkJCWlmIChjdXJyZW50VmFsdWUpIHsKCQkJCQkJCQllbGVtZW50LnRleHQoJycpOwoJCQkJCQkJCXVwZGF0ZURhdGVUaW1lQXR0cignJyk7CgkJCQkJCQkJY3VycmVudFZhbHVlID0gbnVsbDsKCQkJCQkJCX0KCQkJCQkJCXJldHVybjsKCQkJCQkJfQoKCQkJCQkJY3VycmVudFZhbHVlID0gdmFsdWU7CgkJCQkJCXVwZGF0ZU1vbWVudCgpOwoKCQkJCQkJaWYgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgaXNCaW5kT25jZSkgewoJCQkJCQkJdW53YXRjaENoYW5nZXMoKTsKCQkJCQkJfQoJCQkJCX0pOwoKCQkJCQlpZiAoYW5ndWxhci5pc0RlZmluZWQoYXR0ci5hbVdpdGhvdXRTdWZmaXgpKSB7CgkJCQkJCXNjb3BlLiR3YXRjaChhdHRyLmFtV2l0aG91dFN1ZmZpeCwgZnVuY3Rpb24gKHZhbHVlKSB7CgkJCQkJCQlpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHsKCQkJCQkJCQl3aXRob3V0U3VmZml4ID0gdmFsdWU7CgkJCQkJCQkJdXBkYXRlTW9tZW50KCk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCXdpdGhvdXRTdWZmaXggPSBhbVRpbWVBZ29Db25maWcud2l0aG91dFN1ZmZpeDsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQlhdHRyLiRvYnNlcnZlKCdhbUZvcm1hdCcsIGZ1bmN0aW9uIChmb3JtYXQpIHsKCQkJCQkJaWYgKHR5cGVvZiBmb3JtYXQgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCQljdXJyZW50Rm9ybWF0ID0gZm9ybWF0OwoJCQkJCQkJdXBkYXRlTW9tZW50KCk7CgkJCQkJCX0KCQkJCQl9KTsKCgkJCQkJYXR0ci4kb2JzZXJ2ZSgnYW1QcmVwcm9jZXNzJywgZnVuY3Rpb24gKG5ld1ZhbHVlKSB7CgkJCQkJCXByZXByb2Nlc3MgPSBuZXdWYWx1ZTsKCQkJCQkJdXBkYXRlTW9tZW50KCk7CgkJCQkJfSk7CgoJCQkJCXNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbiAoKSB7CgkJCQkJCWNhbmNlbFRpbWVyKCk7CgkJCQkJfSk7CgoJCQkJCXNjb3BlLiRvbignYW1Nb21lbnQ6bG9jYWxlQ2hhbmdlZCcsIGZ1bmN0aW9uICgpIHsKCQkJCQkJdXBkYXRlTW9tZW50KCk7CgkJCQkJfSk7CgkJCQl9OwoJCQl9XSkKCgkJLyoqCgkJICogQG5nZG9jIHNlcnZpY2UKCQkgKiBAbmFtZSBhbmd1bGFyTW9tZW50LnNlcnZpY2UuYW1Nb21lbnQKCQkgKiBAbW9kdWxlIGFuZ3VsYXJNb21lbnQKCQkgKi8KCQkJLnNlcnZpY2UoJ2FtTW9tZW50JywgWydtb21lbnQnLCAnJHJvb3RTY29wZScsICckbG9nJywgJ2FuZ3VsYXJNb21lbnRDb25maWcnLCBmdW5jdGlvbiAobW9tZW50LCAkcm9vdFNjb3BlLCAkbG9nLCBhbmd1bGFyTW9tZW50Q29uZmlnKSB7CgkJCQl2YXIgdGhhdCA9IHRoaXM7CgkJCQkvKioKCQkJCSAqIEBuZ2RvYyBwcm9wZXJ0eQoJCQkJICogQG5hbWUgYW5ndWxhck1vbWVudDphbU1vbWVudCNwcmVwcm9jZXNzb3JzCgkJCQkgKiBAbW9kdWxlIGFuZ3VsYXJNb21lbnQKCQkJCSAqCgkJCQkgKiBAZGVzY3JpcHRpb24KCQkJCSAqIERlZmluZXMgdGhlIHByZXByb2Nlc3NvcnMgZm9yIHRoZSBwcmVwcm9jZXNzRGF0ZSBtZXRob2QuIEJ5IGRlZmF1bHQsIHRoZSBmb2xsb3dpbmcgcHJlcHJvY2Vzc29ycwoJCQkJICogYXJlIGRlZmluZWQ6IHV0YywgdW5peC4KCQkJCSAqLwoJCQkJdGhpcy5wcmVwcm9jZXNzb3JzID0gewoJCQkJCXV0YzogbW9tZW50LnV0YywKCQkJCQl1bml4OiBtb21lbnQudW5peAoJCQkJfTsKCgkJCQkvKioKCQkJCSAqIEBuZ2RvYyBmdW5jdGlvbgoJCQkJICogQG5hbWUgYW5ndWxhck1vbWVudC5zZXJ2aWNlLmFtTW9tZW50I2NoYW5nZUxvY2FsZQoJCQkJICogQG1ldGhvZE9mIGFuZ3VsYXJNb21lbnQuc2VydmljZS5hbU1vbWVudAoJCQkJICoKCQkJCSAqIEBkZXNjcmlwdGlvbgoJCQkJICogQ2hhbmdlcyB0aGUgbG9jYWxlIGZvciBtb21lbnQuanMgYW5kIHVwZGF0ZXMgYWxsIHRoZSBhbS10aW1lLWFnbyBkaXJlY3RpdmUgaW5zdGFuY2VzCgkJCQkgKiB3aXRoIHRoZSBuZXcgbG9jYWxlLiBBbHNvIGJyb2FkY2FzdHMgYSBgYW1Nb21lbnQ6bG9jYWxlQ2hhbmdlZGAgZXZlbnQgb24gJHJvb3RTY29wZS4KCQkJCSAqCgkJCQkgKiBAcGFyYW0ge3N0cmluZ30gbG9jYWxlIDItbGV0dGVyIGxhbmd1YWdlIGNvZGUgKGUuZy4gZW4sIGVzLCBydSwgZXRjLikKCQkJCSAqLwoJCQkJdGhpcy5jaGFuZ2VMb2NhbGUgPSBmdW5jdGlvbiAobG9jYWxlKSB7CgkJCQkJdmFyIHJlc3VsdCA9IChtb21lbnQubG9jYWxlfHxtb21lbnQubGFuZykobG9jYWxlKTsKCQkJCQlpZiAoYW5ndWxhci5pc0RlZmluZWQobG9jYWxlKSkgewoJCQkJCQkkcm9vdFNjb3BlLiRicm9hZGNhc3QoJ2FtTW9tZW50OmxvY2FsZUNoYW5nZWQnKTsKCgkJCQkJCS8vIFRoZSBmb2xsb3dpbmcgZXZlbnQgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGFuIHVwY29taW5nCgkJCQkJCS8vIG1ham9yIHJlbGVhc2UuCgkJCQkJCSRyb290U2NvcGUuJGJyb2FkY2FzdCgnYW1Nb21lbnQ6bGFuZ3VhZ2VDaGFuZ2UnKTsKCQkJCQl9CgkJCQkJcmV0dXJuIHJlc3VsdDsKCQkJCX07CgoJCQkJLyoqCgkJCQkgKiBAbmdkb2MgZnVuY3Rpb24KCQkJCSAqIEBuYW1lIGFuZ3VsYXJNb21lbnQuc2VydmljZS5hbU1vbWVudCNjaGFuZ2VMYW5ndWFnZQoJCQkJICogQG1ldGhvZE9mIGFuZ3VsYXJNb21lbnQuc2VydmljZS5hbU1vbWVudAoJCQkJICogQGRlcHJlY2F0ZWQgUGxlYXNlIHVzZSBjaGFuZ2VMb2NhbGUoKSBpbnN0ZWFkLgoJCQkJICoKCQkJCSAqIEBkZXNjcmlwdGlvbgoJCQkJICogRGVwcmVjYXRlZC4gUGxlYXNlIHVzZSBjaGFuZ2VMb2NhbGUoKSBpbnN0ZWFkLgoJCQkJICovCgkJCQl0aGlzLmNoYW5nZUxhbmd1YWdlID0gZnVuY3Rpb24gKGxhbmcpIHsKCQkJCQkkbG9nLndhcm4oJ2FuZ3VsYXItbW9tZW50OiBVc2FnZSBvZiBhbU1vbWVudC5jaGFuZ2VMYW5ndWFnZSgpIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgY2hhbmdlTG9jYWxlKCknKTsKCQkJCQlyZXR1cm4gdGhhdC5jaGFuZ2VMb2NhbGUobGFuZyk7CgkJCQl9OwoKCQkJCS8qKgoJCQkJICogQG5nZG9jIGZ1bmN0aW9uCgkJCQkgKiBAbmFtZSBhbmd1bGFyTW9tZW50LnNlcnZpY2UuYW1Nb21lbnQjcHJlcHJvY2Vzc0RhdGUKCQkJCSAqIEBtZXRob2RPZiBhbmd1bGFyTW9tZW50LnNlcnZpY2UuYW1Nb21lbnQKCQkJCSAqCgkJCQkgKiBAZGVzY3JpcHRpb24KCQkJCSAqIFByZXByb2Nlc3MgYSBnaXZlbiB2YWx1ZSBhbmQgY29udmVydCBpdCBpbnRvIGEgTW9tZW50IGluc3RhbmNlIGFwcHJvcHJpYXRlIGZvciB1c2UgaW4gdGhlCgkJCQkgKiBhbS10aW1lLWFnbyBkaXJlY3RpdmUgYW5kIHRoZSBmaWx0ZXJzLgoJCQkJICoKCQkJCSAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGJlIHByZXByb2Nlc3NlZAoJCQkJICogQHBhcmFtIHtzdHJpbmd9IHByZXByb2Nlc3MgVGhlIG5hbWUgb2YgdGhlIHByZXByb2Nlc3NvciB0aGUgYXBwbHkgKGUuZy4gdXRjLCB1bml4KQoJCQkJICogQHBhcmFtIHtzdHJpbmc9fSBmb3JtYXQgU3BlY2lmaWVzIGhvdyB0byBwYXJzZSB0aGUgdmFsdWUgKHNlZSB7QGxpbmsgaHR0cDovL21vbWVudGpzLmNvbS9kb2NzLyMvcGFyc2luZy9zdHJpbmctZm9ybWF0L30pCgkJCQkgKiBAcmV0dXJuIHtNb21lbnR9IEEgdmFsdWUgdGhhdCBjYW4gYmUgcGFyc2VkIGJ5IHRoZSBtb21lbnQgbGlicmFyeQoJCQkJICovCgkJCQl0aGlzLnByZXByb2Nlc3NEYXRlID0gZnVuY3Rpb24gKHZhbHVlLCBwcmVwcm9jZXNzLCBmb3JtYXQpIHsKCQkJCQlpZiAoYW5ndWxhci5pc1VuZGVmaW5lZChwcmVwcm9jZXNzKSkgewoJCQkJCQlwcmVwcm9jZXNzID0gYW5ndWxhck1vbWVudENvbmZpZy5wcmVwcm9jZXNzOwoJCQkJCX0KCQkJCQlpZiAodGhpcy5wcmVwcm9jZXNzb3JzW3ByZXByb2Nlc3NdKSB7CgkJCQkJCXJldHVybiB0aGlzLnByZXByb2Nlc3NvcnNbcHJlcHJvY2Vzc10odmFsdWUsIGZvcm1hdCk7CgkJCQkJfQoJCQkJCWlmIChwcmVwcm9jZXNzKSB7CgkJCQkJCSRsb2cud2FybignYW5ndWxhci1tb21lbnQ6IElnbm9yaW5nIHVuc3VwcG9ydGVkIHZhbHVlIGZvciBwcmVwcm9jZXNzOiAnICsgcHJlcHJvY2Vzcyk7CgkJCQkJfQoJCQkJCWlmICghaXNOYU4ocGFyc2VGbG9hdCh2YWx1ZSkpICYmIGlzRmluaXRlKHZhbHVlKSkgewoJCQkJCQkvLyBNaWxsaXNlY29uZHMgc2luY2UgdGhlIGVwb2NoCgkJCQkJCXJldHVybiBtb21lbnQocGFyc2VJbnQodmFsdWUsIDEwKSk7CgkJCQkJfQoJCQkJCS8vIGVsc2UganVzdCByZXR1cm5zIHRoZSB2YWx1ZSBhcy1pcy4KCQkJCQlyZXR1cm4gbW9tZW50KHZhbHVlLCBmb3JtYXQpOwoJCQkJfTsKCgkJCQkvKioKCQkJCSAqIEBuZ2RvYyBmdW5jdGlvbgoJCQkJICogQG5hbWUgYW5ndWxhck1vbWVudC5zZXJ2aWNlLmFtTW9tZW50I2FwcGx5VGltZXpvbmUKCQkJCSAqIEBtZXRob2RPZiBhbmd1bGFyTW9tZW50LnNlcnZpY2UuYW1Nb21lbnQKCQkJCSAqCgkJCQkgKiBAZGVzY3JpcHRpb24KCQkJCSAqIEFwcGx5IGEgdGltZXpvbmUgb250byBhIGdpdmVuIG1vbWVudCBvYmplY3QgLSBpZiBtb21lbnQtdGltZXpvbmUuanMgaXMgaW5jbHVkZWQKCQkJCSAqIE90aGVyd2lzZSwgaXQnbGwgbm90IGFwcGx5IGFueSB0aW1lem9uZSBzaGlmdC4KCQkJCSAqCgkJCQkgKiBAcGFyYW0ge01vbWVudH0gYU1vbWVudCBhIG1vbWVudCgpIGluc3RhbmNlIHRvIGFwcGx5IHRoZSB0aW1lem9uZSBzaGlmdCB0bwoJCQkJICogQHJldHVybnMge01vbWVudH0gVGhlIGdpdmVuIG1vbWVudCB3aXRoIHRoZSB0aW1lem9uZSBzaGlmdCBhcHBsaWVkCgkJCQkgKi8KCQkJCXRoaXMuYXBwbHlUaW1lem9uZSA9IGZ1bmN0aW9uIChhTW9tZW50KSB7CgkJCQkJdmFyIHRpbWV6b25lID0gYW5ndWxhck1vbWVudENvbmZpZy50aW1lem9uZTsKCQkJCQlpZiAoYU1vbWVudCAmJiB0aW1lem9uZSkgewoJCQkJCQlpZiAoYU1vbWVudC50eikgewoJCQkJCQkJYU1vbWVudCA9IGFNb21lbnQudHoodGltZXpvbmUpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJJGxvZy53YXJuKCdhbmd1bGFyLW1vbWVudDogdGltZXpvbmUgc3BlY2lmaWVkIGJ1dCBtb21lbnQudHooKSBpcyB1bmRlZmluZWQuIERpZCB5b3UgZm9yZ2V0IHRvIGluY2x1ZGUgbW9tZW50LXRpbWV6b25lLmpzPycpOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldHVybiBhTW9tZW50OwoJCQkJfTsKCQkJfV0pCgoJCS8qKgoJCSAqIEBuZ2RvYyBmaWx0ZXIKCQkgKiBAbmFtZSBhbmd1bGFyTW9tZW50LmZpbHRlcjphbUNhbGVuZGFyCgkJICogQG1vZHVsZSBhbmd1bGFyTW9tZW50CgkJICovCgkJCS5maWx0ZXIoJ2FtQ2FsZW5kYXInLCBbJ21vbWVudCcsICdhbU1vbWVudCcsIGZ1bmN0aW9uIChtb21lbnQsIGFtTW9tZW50KSB7CgkJCQlyZXR1cm4gZnVuY3Rpb24gKHZhbHVlLCBwcmVwcm9jZXNzKSB7CgkJCQkJaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWUgPT09IG51bGwpIHsKCQkJCQkJcmV0dXJuICcnOwoJCQkJCX0KCgkJCQkJdmFsdWUgPSBhbU1vbWVudC5wcmVwcm9jZXNzRGF0ZSh2YWx1ZSwgcHJlcHJvY2Vzcyk7CgkJCQkJdmFyIGRhdGUgPSBtb21lbnQodmFsdWUpOwoJCQkJCWlmICghZGF0ZS5pc1ZhbGlkKCkpIHsKCQkJCQkJcmV0dXJuICcnOwoJCQkJCX0KCgkJCQkJcmV0dXJuIGFtTW9tZW50LmFwcGx5VGltZXpvbmUoZGF0ZSkuY2FsZW5kYXIoKTsKCQkJCX07CgkJCX1dKQoKCQkvKioKCQkgKiBAbmdkb2MgZmlsdGVyCgkJICogQG5hbWUgYW5ndWxhck1vbWVudC5maWx0ZXI6YW1EYXRlRm9ybWF0CgkJICogQG1vZHVsZSBhbmd1bGFyTW9tZW50CgkJICogQGZ1bmN0aW9uCgkJICovCgkJCS5maWx0ZXIoJ2FtRGF0ZUZvcm1hdCcsIFsnbW9tZW50JywgJ2FtTW9tZW50JywgZnVuY3Rpb24gKG1vbWVudCwgYW1Nb21lbnQpIHsKCQkJCXJldHVybiBmdW5jdGlvbiAodmFsdWUsIGZvcm1hdCwgcHJlcHJvY2VzcykgewoJCQkJCWlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IHZhbHVlID09PSBudWxsKSB7CgkJCQkJCXJldHVybiAnJzsKCQkJCQl9CgoJCQkJCXZhbHVlID0gYW1Nb21lbnQucHJlcHJvY2Vzc0RhdGUodmFsdWUsIHByZXByb2Nlc3MpOwoJCQkJCXZhciBkYXRlID0gbW9tZW50KHZhbHVlKTsKCQkJCQlpZiAoIWRhdGUuaXNWYWxpZCgpKSB7CgkJCQkJCXJldHVybiAnJzsKCQkJCQl9CgoJCQkJCXJldHVybiBhbU1vbWVudC5hcHBseVRpbWV6b25lKGRhdGUpLmZvcm1hdChmb3JtYXQpOwoJCQkJfTsKCQkJfV0pCgoJCS8qKgoJCSAqIEBuZ2RvYyBmaWx0ZXIKCQkgKiBAbmFtZSBhbmd1bGFyTW9tZW50LmZpbHRlcjphbUR1cmF0aW9uRm9ybWF0CgkJICogQG1vZHVsZSBhbmd1bGFyTW9tZW50CgkJICogQGZ1bmN0aW9uCgkJICovCgkJCS5maWx0ZXIoJ2FtRHVyYXRpb25Gb3JtYXQnLCBbJ21vbWVudCcsIGZ1bmN0aW9uIChtb21lbnQpIHsKCQkJCXJldHVybiBmdW5jdGlvbiAodmFsdWUsIGZvcm1hdCwgc3VmZml4KSB7CgkJCQkJaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWUgPT09IG51bGwpIHsKCQkJCQkJcmV0dXJuICcnOwoJCQkJCX0KCgkJCQkJcmV0dXJuIG1vbWVudC5kdXJhdGlvbih2YWx1ZSwgZm9ybWF0KS5odW1hbml6ZShzdWZmaXgpOwoJCQkJfTsKCQkJfV0pOwoJfQoKCWlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKCQlkZWZpbmUoJ2FuZ3VsYXItbW9tZW50JywgWydhbmd1bGFyJywgJ21vbWVudCddLCBhbmd1bGFyTW9tZW50KTsKCX0gZWxzZSB7CgkJYW5ndWxhck1vbWVudChhbmd1bGFyLCB3aW5kb3cubW9tZW50KTsKCX0KfSkoKTsKCgovKgpQcm9qZWN0OiBhbmd1bGFyLWdhbnR0IGZvciBBbmd1bGFySlMKQXV0aG9yOiBNYXJjbyBTY2h3ZWlnaGF1c2VyCkNvbnRyaWJ1dG9yczogUsOpbWkgQWx2ZXJnbmF0CkxpY2Vuc2U6IE1JVC4KR2l0aHViOiBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci1nYW50dC9hbmd1bGFyLWdhbnR0CiovCid1c2Ugc3RyaWN0JzsKCgp2YXIgZ2FudHQgPSBhbmd1bGFyLm1vZHVsZSgnZ2FudHQnLCBbJ2dhbnR0VGVtcGxhdGVzJywgJ2FuZ3VsYXJNb21lbnQnXSk7CmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHQnLCBbJ0dhbnR0JywgJ2dhbnR0T3B0aW9ucycsICdHYW50dENhbGVuZGFyJywgJ21vbWVudCcsICdnYW50dE1vdXNlT2Zmc2V0JywgJ2dhbnR0RGVib3VuY2UnLCAnZ2FudHRFbmFibGVOZ0FuaW1hdGUnLCBmdW5jdGlvbihHYW50dCwgT3B0aW9ucywgQ2FsZW5kYXIsIG1vbWVudCwgbW91c2VPZmZzZXQsIGRlYm91bmNlLCBlbmFibGVOZ0FuaW1hdGUpIHsKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFQScsCiAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICB0ZW1wbGF0ZVVybDogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICAgICAgICBpZiAodEF0dHJzLnRlbXBsYXRlVXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAndGVtcGxhdGUvZGVmYXVsdC5nYW50dC50bXBsLmh0bWwnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRBdHRycy50ZW1wbGF0ZVVybDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc2NvcGU6IHsKICAgICAgICAgICAgc29ydE1vZGU6ICc9PycsIC8vIFBvc3NpYmxlIG1vZGVzOiAnbmFtZScsICdkYXRlJywgJ2N1c3RvbScKICAgICAgICAgICAgZmlsdGVyVGFzazogJz0/JywgLy8gVGFzayBmaWx0ZXIgYXMgYSBhbmd1bGFySlMgZXhwcmVzc2lvbgogICAgICAgICAgICBmaWx0ZXJUYXNrQ29tcGFyYXRvcjogJz0/JywgLy8gQ29tcGFyYXRvciB0byB1c2UgZm9yIHRoZSB0YXNrIGZpbHRlcgogICAgICAgICAgICBmaWx0ZXJSb3c6ICc9PycsIC8vIFJvdyBmaWx0ZXIgYXMgYSBhbmd1bGFySlMgZXhwcmVzc2lvbgogICAgICAgICAgICBmaWx0ZXJSb3dDb21wYXJhdG9yOiAnPT8nLCAvLyBDb21wYXJhdG9yIHRvIHVzZSBmb3IgdGhlIHJvdyBmaWx0ZXIKICAgICAgICAgICAgdmlld1NjYWxlOiAnPT8nLCAvLyBQb3NzaWJsZSBzY2FsZXM6ICdob3VyJywgJ2RheScsICd3ZWVrJywgJ21vbnRoJwogICAgICAgICAgICBjb2x1bW5XaWR0aDogJz0/JywgLy8gRGVmaW5lcyB0aGUgc2l6ZSBvZiBhIGNvbHVtbiwgMSBiZWluZyAxZW0gcGVyIHVuaXQgKGhvdXIgb3IgZGF5LCAuLiBkZXBlbmRpbmcgb24gc2NhbGUpLAogICAgICAgICAgICBhbGxvd0xhYmVsc1Jlc2l6aW5nOiAnPT8nLCAvLyBTZXQgdG8gdHJ1ZSBpZiB0aGUgdXNlciBzaG91bGQgYmUgYWJsZSB0byByZXNpemUgdGhlIGxhYmVsIHNlY3Rpb24uCiAgICAgICAgICAgIGZyb21EYXRlOiAnPT8nLCAvLyBJZiBub3Qgc3BlY2lmaWVkIHdpbGwgdXNlIHRoZSBlYXJsaWVzdCB0YXNrIGRhdGUgKG5vdGU6IGFzIG9mIG5vdyB0aGlzIGNhbiBvbmx5IGV4cGFuZCBub3Qgc2hyaW5rKQogICAgICAgICAgICB0b0RhdGU6ICc9PycsIC8vIElmIG5vdCBzcGVjaWZpZWQgd2lsbCB1c2UgdGhlIGxhdGVzdCB0YXNrIGRhdGUgKG5vdGU6IGFzIG9mIG5vdyB0aGlzIGNhbiBvbmx5IGV4cGFuZCBub3Qgc2hyaW5rKQogICAgICAgICAgICBjdXJyZW50RGF0ZVZhbHVlOiAnPT8nLCAvLyBJZiBzcGVjaWZpZWQsIHRoZSBjdXJyZW50IGRhdGUgd2lsbCBiZSBkaXNwbGF5ZWQKICAgICAgICAgICAgY3VycmVudERhdGU6ICc9PycsIC8vIFRoZSBkaXNwbGF5IG9mIGN1cnJlbnREYXRlICgnbm9uZScsICdsaW5lJyBvciAnY29sdW1uJykuCiAgICAgICAgICAgIGF1dG9FeHBhbmQ6ICc9PycsIC8vIFNldCB0aGlzIGJvdGgsIGxlZnQgb3IgcmlnaHQgaWYgdGhlIGRhdGUgcmFuZ2Ugc2hhbGwgZXhwYW5kIGlmIHRoZSB1c2VyIHNjcm9sbCB0byB0aGUgbGVmdCBvciByaWdodCBlbmQuIE90aGVyd2lzZSBzZXQgdG8gZmFsc2Ugb3Igbm9uZS4KICAgICAgICAgICAgdGFza091dE9mUmFuZ2U6ICc9PycsIC8vIFNldCB0aGlzIHRvIGV4cGFuZCBvciB0cnVuY2F0ZSB0byBkZWZpbmUgdGhlIGJlaGF2aW9yIG9mIHRhc2tzIGdvaW5nIG91dCBvZiB2aXNpYmxlIHJhbmdlLgogICAgICAgICAgICBtYXhIZWlnaHQ6ICc9PycsIC8vIERlZmluZSB0aGUgbWF4aW11bSBoZWlnaHQgb2YgdGhlIEdhbnR0IGluIFBYLiA+IDAgdG8gYWN0aXZhdGUgbWF4IGhlaWdodCBiZWhhdmlvdXIuCiAgICAgICAgICAgIGxhYmVsc1dpZHRoOiAnPT8nLCAvLyBEZWZpbmUgdGhlIHdpZHRoIG9mIHRoZSBsYWJlbHMgc2VjdGlvbi4gQ2hhbmdlcyB3aGVuIHRoZSB1c2VyIGlzIHJlc2l6aW5nIHRoZSBsYWJlbHMgd2lkdGgKICAgICAgICAgICAgc2hvd0xhYmVsc0NvbHVtbjogJz0/JywgLy8gV2hldGhlciB0byBzaG93IGNvbHVtbiB3aXRoIGxhYmVscyBvciBub3QuIERlZmF1bHQgKHRydWUpCiAgICAgICAgICAgIHNob3dUb29sdGlwczogJz0/JywgLy8gVHJ1ZSB3aGVuIHRvb2x0aXBzIHNoYWxsIGJlIGVuYWJsZWQuIERlZmF1bHQgKHRydWUpCiAgICAgICAgICAgIGhlYWRlcnM6ICc9PycsIC8vIEFuIGFycmF5IG9mIHVuaXRzIGZvciBoZWFkZXJzLgogICAgICAgICAgICBoZWFkZXJzRm9ybWF0czogJz0/JywgLy8gQW4gYXJyYXkgb2YgY29ycmVzcG9uZGluZyBmb3JtYXRzIGZvciBoZWFkZXJzLgogICAgICAgICAgICB0aW1lRnJhbWVzOiAnPT8nLAogICAgICAgICAgICBkYXRlRnJhbWVzOiAnPT8nLAogICAgICAgICAgICB0aW1lRnJhbWVzV29ya2luZ01vZGU6ICc9PycsCiAgICAgICAgICAgIHRpbWVGcmFtZXNOb25Xb3JraW5nTW9kZTogJz0/JywKICAgICAgICAgICAgdG9vbHRpcERhdGVGb3JtYXQ6ICc9PycsCiAgICAgICAgICAgIHRpbWVzcGFuczogJz0/JywKICAgICAgICAgICAgY29sdW1uTWFnbmV0OiAnPT8nLAogICAgICAgICAgICBkYXRhOiAnPT8nLAogICAgICAgICAgICBhcGk6ICc9PycsCiAgICAgICAgICAgIG9wdGlvbnM6ICc9PycKICAgICAgICB9LAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICBmb3IgKHZhciBvcHRpb24gaW4gJHNjb3BlLm9wdGlvbnMpIHsKICAgICAgICAgICAgICAgICRzY29wZVtvcHRpb25dID0gJHNjb3BlLm9wdGlvbnNbb3B0aW9uXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgT3B0aW9ucy5pbml0aWFsaXplKCRzY29wZSk7CgogICAgICAgICAgICAvLyBEaXNhYmxlIGFuaW1hdGlvbiBpZiBuZ0FuaW1hdGUgaXMgcHJlc2VudCwgYXMgaXQgZHJvcHMgZG93biBwZXJmb3JtYW5jZS4KICAgICAgICAgICAgZW5hYmxlTmdBbmltYXRlKGZhbHNlLCAkZWxlbWVudCk7CgogICAgICAgICAgICAkc2NvcGUuZ2FudHQgPSBuZXcgR2FudHQoJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgIHRoaXMuZ2FudHQgPSAkc2NvcGUuZ2FudHQ7CiAgICAgICAgfV0sCiAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQpIHsKICAgICAgICAgICAgLy8gR2FudHQgaXMgaW5pdGlhbGl6ZWQuIFNpZ25hbCB0aGF0IHRoZSBHYW50dCBpcyByZWFkeS4KICAgICAgICAgICAgc2NvcGUuZ2FudHQuYXBpLmNvcmUucmFpc2UucmVhZHkoc2NvcGUuZ2FudHQuYXBpKTsKCiAgICAgICAgICAgIHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLm5ldygnZ2FudHQnLCBzY29wZSwgZWxlbWVudCk7CiAgICAgICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLmRlc3Ryb3koJ2dhbnR0Jywgc2NvcGUsIGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9Owp9XSk7CgoKLy8gVGhpcyBmaWxlIGlzIGFkYXB0ZWQgZnJvbSBBbmd1bGFyIFVJIG5nR3JpZCBwcm9qZWN0Ci8vIE1JVCBMaWNlbnNlCi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyLXVpL25nLWdyaWQvYmxvYi92My4wLjAtcmMuMTIvc3JjL2pzL2NvcmUvZmFjdG9yaWVzL0dyaWRBcGkuanMKKGZ1bmN0aW9uKCkgewoKICAgIGFuZ3VsYXIubW9kdWxlKCdnYW50dCcpCiAgICAgICAgLmZhY3RvcnkoJ0dhbnR0QXBpJywgWyckcScsICckcm9vdFNjb3BlJywgJ2dhbnR0VXRpbHMnLAogICAgICAgICAgICBmdW5jdGlvbigkcSwgJHJvb3RTY29wZSwgdXRpbHMpIHsKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBnYW50dC5jbGFzczpHYW50dEFwaQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uIEdhbnR0QXBpIHByb3ZpZGVzIHRoZSBhYmlsaXR5IHRvIHJlZ2lzdGVyIHB1YmxpYyBtZXRob2RzIGV2ZW50cyBpbnNpZGUgdGhlIGdhbnR0IGFuZCBhbGxvdwogICAgICAgICAgICAgICAgICogZm9yIG90aGVyIGNvbXBvbmVudHMgdG8gdXNlIHRoZSBhcGkgdmlhIGZlYXR1cmVOYW1lLm1ldGhvZE5hbWUgYW5kIGZlYXR1cmVOYW1lLm9uLmV2ZW50TmFtZShmdW5jdGlvbihhcmdzKXt9CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gZ2FudHQgZ2FudHQgdGhhdCBvd25zIGFwaQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB2YXIgR2FudHRBcGkgPSBmdW5jdGlvbiBHYW50dEFwaShnYW50dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FudHQgPSBnYW50dDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3RlbmVycyA9IFtdOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBpSWQgPSB1dGlscy5uZXdJZCgpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgZ2FudHQuY2xhc3M6c3VwcHJlc3NFdmVudHMKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBnYW50dC5jbGFzczpHYW50dEFwaQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uIFVzZWQgdG8gZXhlY3V0ZSBhIGZ1bmN0aW9uIHdoaWxlIGRpc2FibGluZyB0aGUgc3BlY2lmaWVkIGV2ZW50IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAqIERpc2FibGVzIHRoZSBsaXN0ZW5lckZ1bmN0aW9ucywgZXhlY3V0ZXMgdGhlIGNhbGxiYWNrRm4sIGFuZCB0aGVuIGVuYWJsZXMKICAgICAgICAgICAgICAgICAqIHRoZSBsaXN0ZW5lckZ1bmN0aW9ucyBhZ2FpbgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGxpc3RlbmVyRnVuY3MgbGlzdGVuZXJGdW5jIG9yIGFycmF5IG9mIGxpc3RlbmVyRnVuY3MgdG8gc3VwcHJlc3MuIFRoZXNlIG11c3QgYmUgdGhlIHNhbWUKICAgICAgICAgICAgICAgICAqIGZ1bmN0aW9ucyB0aGF0IHdlcmUgdXNlZCBpbiB0aGUgLm9uLmV2ZW50TmFtZSBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjYWxsQmFja0ZuIGZ1bmN0aW9uIHRvIGV4ZWN1dGUKICAgICAgICAgICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogICAgdmFyIG5hdmlnYXRlID0gZnVuY3Rpb24gKG5ld1Jvd0NvbCwgb2xkUm93Q29sKXsKICAgICAgICAgICAgICAgICAqICAgICAgIC8vZG8gc29tZXRoaW5nIG9uIG5hdmlnYXRlCiAgICAgICAgICAgICAgICAgKiAgICB9CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAgZ2FudHRBcGkuY2VsbE5hdi5vbi5uYXZpZ2F0ZShzY29wZSxuYXZpZ2F0ZSk7CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgIC8vY2FsbCB0aGUgc2Nyb2xsVG8gZXZlbnQgYW5kIHN1cHByZXNzIG91ciBuYXZpZ2F0ZSBsaXN0ZW5lcgogICAgICAgICAgICAgICAgICogICAgLy9zY3JvbGxUbyB3aWxsIHN0aWxsIHJhaXNlIHRoZSBldmVudCBmb3Igb3RoZXIgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICAgKiAgICBnYW50dEFwaS5zdXBwcmVzc0V2ZW50cyhuYXZpZ2F0ZSwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAqICAgICAgIGdhbnR0QXBpLmNlbGxOYXYuc2Nyb2xsVG8oYVJvdywgYUNvbCk7CiAgICAgICAgICAgICAgICAgKiAgICB9KTsKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgR2FudHRBcGkucHJvdG90eXBlLnN1cHByZXNzRXZlbnRzID0gZnVuY3Rpb24obGlzdGVuZXJGdW5jcywgY2FsbEJhY2tGbikgewogICAgICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gYW5ndWxhci5pc0FycmF5KGxpc3RlbmVyRnVuY3MpID8gbGlzdGVuZXJGdW5jcyA6IFtsaXN0ZW5lckZ1bmNzXTsKCiAgICAgICAgICAgICAgICAgICAgLy9maW5kIGFsbCByZWdpc3RlcmVkIGxpc3RlbmVycwogICAgICAgICAgICAgICAgICAgIHZhciBmb3VuZExpc3RlbmVycyA9IFtdOwogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uKGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRMaXN0ZW5lcnMgPSBzZWxmLmxpc3RlbmVycy5maWx0ZXIoZnVuY3Rpb24obHN0bnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsID09PSBsc3Ruci5oYW5kbGVyOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgLy9kZXJlZ2lzdGVyIGFsbCB0aGUgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICAgICAgZm91bmRMaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbihsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGwuZGVyZWcoKTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgY2FsbEJhY2tGbigpOwoKICAgICAgICAgICAgICAgICAgICAvL3JlcmVnaXN0ZXIgYWxsIHRoZSBsaXN0ZW5lcnMKICAgICAgICAgICAgICAgICAgICBmb3VuZExpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uKGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbC5kZXJlZyA9IHJlZ2lzdGVyRXZlbnRXaXRoQW5ndWxhcihsLnNjb3BlLCBsLmV2ZW50SWQsIGwuaGFuZGxlciwgc2VsZi5nYW50dCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgcmVnaXN0ZXJFdmVudAogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGdhbnR0LmNsYXNzOkdhbnR0QXBpCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24gUmVnaXN0ZXJzIGEgbmV3IGV2ZW50IGZvciB0aGUgZ2l2ZW4gZmVhdHVyZQogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGZlYXR1cmVOYW1lIG5hbWUgb2YgdGhlIGZlYXR1cmUgdGhhdCByYWlzZXMgdGhlIGV2ZW50CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lICBuYW1lIG9mIHRoZSBldmVudAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBHYW50dEFwaS5wcm90b3R5cGUucmVnaXN0ZXJFdmVudCA9IGZ1bmN0aW9uKGZlYXR1cmVOYW1lLCBldmVudE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzZWxmW2ZlYXR1cmVOYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmW2ZlYXR1cmVOYW1lXSA9IHt9OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIGZlYXR1cmUgPSBzZWxmW2ZlYXR1cmVOYW1lXTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWZlYXR1cmUub24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmVhdHVyZS5vbiA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlLnJhaXNlID0ge307CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRJZCA9ICdldmVudDpnYW50dDonICsgdGhpcy5hcGlJZCArICc6JyArIGZlYXR1cmVOYW1lICsgJzonICsgZXZlbnROYW1lOwoKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlLnJhaXNlW2V2ZW50TmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0LmFwcGx5KCRyb290U2NvcGUsIFtldmVudElkXS5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGZlYXR1cmUub25bZXZlbnROYW1lXSA9IGZ1bmN0aW9uKHNjb3BlLCBoYW5kbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkZXJlZyA9IHJlZ2lzdGVyRXZlbnRXaXRoQW5ndWxhcihzY29wZSwgZXZlbnRJZCwgaGFuZGxlciwgc2VsZi5nYW50dCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvL3RyYWNrIG91ciBsaXN0ZW5lciBzbyB3ZSBjYW4gdHVybiBvZmYgYW5kIG9uCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsaXN0ZW5lciA9IHtoYW5kbGVyOiBoYW5kbGVyLCBkZXJlZzogZGVyZWcsIGV2ZW50SWQ6IGV2ZW50SWQsIHNjb3BlOiBzY29wZX07CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubGlzdGVuZXJzLnB1c2gobGlzdGVuZXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy9kZXN0cm95IHRyYWNraW5nIHdoZW4gc2NvcGUgaXMgZGVzdHJveWVkCiAgICAgICAgICAgICAgICAgICAgICAgIC8vd2FudGVkIHRvIHJlbW92ZSB0aGUgbGlzdGVuZXIgZnJvbSB0aGUgYXJyYXkgYnV0IGFuZ3VsYXIgZG9lcwogICAgICAgICAgICAgICAgICAgICAgICAvL3N0cmFuZ2UgdGhpbmdzIGluIHNjb3BlLiRkZXN0cm95IHNvIEkgY291bGQgbm90IGFjY2VzcyB0aGUgbGlzdGVuZXIgYXJyYXkKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIuZGVyZWcgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIuaGFuZGxlciA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lci5ldmVudElkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyLnNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudFdpdGhBbmd1bGFyKHNjb3BlLCBldmVudElkLCBoYW5kbGVyLCBnYW50dCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS4kb24oZXZlbnRJZCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5zcGxpY2UoMCwgMSk7IC8vcmVtb3ZlIGV2dCBhcmd1bWVudAogICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLmFwcGx5KGdhbnR0LmFwaSwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIHJlZ2lzdGVyRXZlbnRzRnJvbU9iamVjdAogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGdhbnR0LmNsYXNzOkdhbnR0QXBpCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24gUmVnaXN0ZXJzIGZlYXR1cmVzIGFuZCBldmVudHMgZnJvbSBhIHNpbXBsZSBvYmplY3RNYXAuCiAgICAgICAgICAgICAgICAgKiBldmVudE9iamVjdE1hcCBtdXN0IGJlIGluIHRoaXMgZm9ybWF0IChtdWx0aXBsZSBmZWF0dXJlcyBhbGxvd2VkKQogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqIHtmZWF0dXJlTmFtZToKICAgICAgICAgICAgICAgICAqICAgICAgICB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgICBldmVudE5hbWVPbmU6ZnVuY3Rpb24oYXJncyl7fSwKICAgICAgICAgICAgICAgICAqICAgICAgICAgIGV2ZW50TmFtZVR3bzpmdW5jdGlvbihhcmdzKXt9CiAgICAgICAgICAgICAgICAgKiAgICAgICAgfQogICAgICAgICAgICAgICAgICogIH0KICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGV2ZW50T2JqZWN0TWFwIG1hcCBvZiBmZWF0dXJlL2V2ZW50IG5hbWVzCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIEdhbnR0QXBpLnByb3RvdHlwZS5yZWdpc3RlckV2ZW50c0Zyb21PYmplY3QgPSBmdW5jdGlvbihldmVudE9iamVjdE1hcCkgewogICAgICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgICAgICAgICB2YXIgZmVhdHVyZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goZXZlbnRPYmplY3RNYXAsIGZ1bmN0aW9uKGZlYXRQcm9wLCBmZWF0UHJvcE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZlYXR1cmUgPSB7bmFtZTogZmVhdFByb3BOYW1lLCBldmVudHM6IFtdfTsKICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGZlYXRQcm9wLCBmdW5jdGlvbihwcm9wLCBwcm9wTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVhdHVyZS5ldmVudHMucHVzaChwcm9wTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlcy5wdXNoKGZlYXR1cmUpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlcy5mb3JFYWNoKGZ1bmN0aW9uKGZlYXR1cmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmVhdHVyZS5ldmVudHMuZm9yRWFjaChmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWdpc3RlckV2ZW50KGZlYXR1cmUubmFtZSwgZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSByZWdpc3Rlck1ldGhvZAogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGdhbnR0LmNsYXNzOkdhbnR0QXBpCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24gUmVnaXN0ZXJzIGEgbmV3IGV2ZW50IGZvciB0aGUgZ2l2ZW4gZmVhdHVyZQogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGZlYXR1cmVOYW1lIG5hbWUgb2YgdGhlIGZlYXR1cmUKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2ROYW1lICBuYW1lIG9mIHRoZSBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjYWxsQmFja0ZuIGZ1bmN0aW9uIHRvIGV4ZWN1dGUKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSB0aGlzQXJnIGJpbmRzIGNhbGxCYWNrRm4gJ3RoaXMnIHRvIHRoaXNBcmcuICBEZWZhdWx0cyB0byBnYW50dEFwaS5nYW50dAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBHYW50dEFwaS5wcm90b3R5cGUucmVnaXN0ZXJNZXRob2QgPSBmdW5jdGlvbihmZWF0dXJlTmFtZSwgbWV0aG9kTmFtZSwgY2FsbEJhY2tGbiwgdGhpc0FyZykgewogICAgICAgICAgICAgICAgICAgIGlmICghdGhpc1tmZWF0dXJlTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tmZWF0dXJlTmFtZV0gPSB7fTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBmZWF0dXJlID0gdGhpc1tmZWF0dXJlTmFtZV07CgogICAgICAgICAgICAgICAgICAgIGZlYXR1cmVbbWV0aG9kTmFtZV0gPSB1dGlscy5jcmVhdGVCb3VuZGVkV3JhcHBlcih0aGlzQXJnIHx8IHRoaXMuZ2FudHQsIGNhbGxCYWNrRm4pOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgcmVnaXN0ZXJNZXRob2RzRnJvbU9iamVjdAogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGdhbnR0LmNsYXNzOkdhbnR0QXBpCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24gUmVnaXN0ZXJzIGZlYXR1cmVzIGFuZCBtZXRob2RzIGZyb20gYSBzaW1wbGUgb2JqZWN0TWFwLgogICAgICAgICAgICAgICAgICogZXZlbnRPYmplY3RNYXAgbXVzdCBiZSBpbiB0aGlzIGZvcm1hdCAobXVsdGlwbGUgZmVhdHVyZXMgYWxsb3dlZCkKICAgICAgICAgICAgICAgICAqIDxicj4KICAgICAgICAgICAgICAgICAqIHtmZWF0dXJlTmFtZToKICAgICAgICAgICAgICAgICAqICAgICAgICB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgICBtZXRob2ROYW1lT25lOmZ1bmN0aW9uKGFyZ3Mpe30sCiAgICAgICAgICAgICAgICAgKiAgICAgICAgICBtZXRob2ROYW1lVHdvOmZ1bmN0aW9uKGFyZ3Mpe30KICAgICAgICAgICAgICAgICAqICAgICAgICB9CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gZXZlbnRPYmplY3RNYXAgbWFwIG9mIGZlYXR1cmUvZXZlbnQgbmFtZXMKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSB0aGlzQXJnIGJpbmRzIHRoaXMgdG8gdGhpc0FyZyBmb3IgYWxsIGZ1bmN0aW9ucy4gIERlZmF1bHRzIHRvIEdhbnR0QXBpLmdhbnR0CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIEdhbnR0QXBpLnByb3RvdHlwZS5yZWdpc3Rlck1ldGhvZHNGcm9tT2JqZWN0ID0gZnVuY3Rpb24obWV0aG9kTWFwLCB0aGlzQXJnKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgIHZhciBmZWF0dXJlcyA9IFtdOwogICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChtZXRob2RNYXAsIGZ1bmN0aW9uKGZlYXRQcm9wLCBmZWF0UHJvcE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZlYXR1cmUgPSB7bmFtZTogZmVhdFByb3BOYW1lLCBtZXRob2RzOiBbXX07CiAgICAgICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChmZWF0UHJvcCwgZnVuY3Rpb24ocHJvcCwgcHJvcE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmUubWV0aG9kcy5wdXNoKHtuYW1lOiBwcm9wTmFtZSwgZm46IHByb3B9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmVzLnB1c2goZmVhdHVyZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIGZlYXR1cmVzLmZvckVhY2goZnVuY3Rpb24oZmVhdHVyZSkgewogICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlLm1ldGhvZHMuZm9yRWFjaChmdW5jdGlvbihtZXRob2QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucmVnaXN0ZXJNZXRob2QoZmVhdHVyZS5uYW1lLCBtZXRob2QubmFtZSwgbWV0aG9kLmZuLCB0aGlzQXJnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICByZXR1cm4gR2FudHRBcGk7CgogICAgICAgICAgICB9XSk7Cgp9KSgpOwoKCmdhbnR0LmZhY3RvcnkoJ2dhbnR0T3B0aW9ucycsIFsnbW9tZW50JywgZnVuY3Rpb24obW9tZW50KSB7CiAgICByZXR1cm4ge2luaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zLmFwaSA9IG9wdGlvbnMuYXBpIHx8IGFuZ3VsYXIubm9vcCgpOwoKICAgICAgICBvcHRpb25zLmRhdGEgPSBvcHRpb25zLmRhdGEgfHwgW107CgogICAgICAgIG9wdGlvbnMudGltZXNwYW5zID0gb3B0aW9ucy50aW1lc3BhbnMgfHwgW107CgogICAgICAgIG9wdGlvbnMuc29ydE1vZGUgPSBvcHRpb25zLnNvcnRNb2RlIHx8ICduYW1lJzsKCiAgICAgICAgb3B0aW9ucy5maWx0ZXJUYXNrID0gb3B0aW9ucy5maWx0ZXJUYXNrIHx8IHVuZGVmaW5lZDsKICAgICAgICBvcHRpb25zLmZpbHRlclRhc2tDb21wYXJhdG9yID0gb3B0aW9ucy5maWx0ZXJUYXNrQ29tcGFyYXRvciB8fCB1bmRlZmluZWQ7CgogICAgICAgIG9wdGlvbnMuZmlsdGVyUm93ID0gb3B0aW9ucy5maWx0ZXJSb3cgfHwgdW5kZWZpbmVkOwogICAgICAgIG9wdGlvbnMuZmlsdGVyUm93Q29tcGFyYXRvciA9IG9wdGlvbnMuZmlsdGVyUm93Q29tcGFyYXRvciB8fCB1bmRlZmluZWQ7CgogICAgICAgIG9wdGlvbnMudmlld1NjYWxlID0gb3B0aW9ucy52aWV3U2NhbGUgfHwgJ2RheSc7CiAgICAgICAgb3B0aW9ucy5jb2x1bW5NYWduZXQgPSBvcHRpb25zLmNvbHVtbk1hZ25ldCB8fCAnMTUgbWludXRlcyc7CiAgICAgICAgb3B0aW9ucy5jb2x1bW5XaWR0aCA9IG9wdGlvbnMuY29sdW1uV2lkdGggfHwgdW5kZWZpbmVkOwoKICAgICAgICBvcHRpb25zLmZyb21EYXRlID0gb3B0aW9ucy5mcm9tRGF0ZSB8fCB1bmRlZmluZWQ7CiAgICAgICAgb3B0aW9ucy50b0RhdGUgPSBvcHRpb25zLnRvRGF0ZSB8fCB1bmRlZmluZWQ7CgogICAgICAgIG9wdGlvbnMuYWxsb3dMYWJlbHNSZXNpemluZyA9IG9wdGlvbnMuYWxsb3dMYWJlbHNSZXNpemluZyAhPT0gdW5kZWZpbmVkID8gISFvcHRpb25zLmFsbG93TGFiZWxzUmVzaXppbmcgOiB0cnVlOwoKICAgICAgICBvcHRpb25zLmN1cnJlbnREYXRlID0gb3B0aW9ucy5jdXJyZW50RGF0ZSB8fCAnbGluZSc7CiAgICAgICAgb3B0aW9ucy5jdXJyZW50RGF0ZVZhbHVlID0gb3B0aW9ucy5jdXJyZW50RGF0ZVZhbHVlIHx8IG1vbWVudCgpOwoKICAgICAgICBvcHRpb25zLmF1dG9FeHBhbmQgPSBvcHRpb25zLmF1dG9FeHBhbmQgfHwgJ25vbmUnOwogICAgICAgIG9wdGlvbnMudGFza091dE9mUmFuZ2UgPSBvcHRpb25zLnRhc2tPdXRPZlJhbmdlIHx8ICd0cnVuY2F0ZSc7CgogICAgICAgIG9wdGlvbnMubWF4SGVpZ2h0ID0gb3B0aW9ucy5tYXhIZWlnaHQgfHwgMDsKCiAgICAgICAgb3B0aW9ucy5sYWJlbHNXaWR0aCA9IG9wdGlvbnMubGFiZWxzV2lkdGggfHwgdW5kZWZpbmVkOwoKICAgICAgICBvcHRpb25zLnNob3dMYWJlbHNDb2x1bW4gPSBvcHRpb25zLnNob3dMYWJlbHNDb2x1bW4gIT09IHVuZGVmaW5lZCA/ICEhb3B0aW9ucy5zaG93TGFiZWxzQ29sdW1uIDogdHJ1ZTsKICAgICAgICBvcHRpb25zLnNob3dUb29sdGlwcyA9IG9wdGlvbnMuc2hvd1Rvb2x0aXBzICE9PSB1bmRlZmluZWQgPyAhIW9wdGlvbnMuc2hvd1Rvb2x0aXBzIDogdHJ1ZTsKCiAgICAgICAgb3B0aW9ucy5oZWFkZXJzID0gb3B0aW9ucy5oZWFkZXJzIHx8IHVuZGVmaW5lZDsKICAgICAgICBvcHRpb25zLmhlYWRlcnNGb3JtYXRzID0gb3B0aW9ucy5oZWFkZXJzRm9ybWF0cyB8fCB1bmRlZmluZWQ7CgogICAgICAgIG9wdGlvbnMudGltZUZyYW1lcyA9IG9wdGlvbnMudGltZUZyYW1lcyB8fCBbXTsKICAgICAgICBvcHRpb25zLmRhdGVGcmFtZXMgPSBvcHRpb25zLmRhdGVGcmFtZXMgfHwgW107CgogICAgICAgIG9wdGlvbnMudGltZUZyYW1lc1dvcmtpbmdNb2RlID0gb3B0aW9ucy50aW1lRnJhbWVzV29ya2luZ01vZGUgfHwgJ2hpZGRlbic7CiAgICAgICAgb3B0aW9ucy50aW1lRnJhbWVzTm9uV29ya2luZ01vZGUgPSBvcHRpb25zLnRpbWVGcmFtZXNOb25Xb3JraW5nTW9kZSB8fCAndmlzaWJsZSc7CgogICAgICAgIG9wdGlvbnMudG9vbHRpcERhdGVGb3JtYXQgPSBvcHRpb25zLnRvb2x0aXBEYXRlRm9ybWF0IHx8ICdNTU0gREQsIEhIOm1tJzsKCiAgICAgICAgcmV0dXJuIG9wdGlvbnM7CiAgICB9CiAgICB9Owp9XSk7CgoKLyoqCiAqIENhbGVuZGFyIGZhY3RvcnkgaXMgdXNlZCB0byBkZWZpbmUgd29ya2luZyBwZXJpb2RzLCBub24gd29ya2luZyBwZXJpb2RzLCBhbmQgb3RoZXIgc3BlY2lmaWMgcGVyaW9kIG9mIHRpbWUsCiAqIGFuZCByZXRyaWV2ZSBlZmZlY3RpdmUgdGltZUZyYW1lcyBmb3IgZWFjaCBkYXkgb2YgdGhlIGdhbnR0LgogKi8KZ2FudHQuZmFjdG9yeSgnR2FudHRDYWxlbmRhcicsIFsnJGZpbHRlcicsIGZ1bmN0aW9uKCRmaWx0ZXIpIHsKICAgIC8qKgogICAgICogVGltZUZyYW1lIHJlcHJlc2VudHMgdGltZSBmcmFtZSBpbiBhbnkgZGF5LiBwYXJhbWV0ZXJzIGFyZSBnaXZlbiB1c2luZyBvcHRpb25zIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge21vbWVudHxzdHJpbmd9IHN0YXJ0IHN0YXJ0IG9mIHRpbWVGcmFtZS4gSWYgYSBzdHJpbmcgaXMgZ2l2ZW4sIGl0IHdpbGwgYmUgcGFyc2VkIGFzIGEgbW9tZW50LgogICAgICogQHBhcmFtIHttb21lbnR8c3RyaW5nfSBlbmQgZW5kIG9mIHRpbWVGcmFtZS4gSWYgYSBzdHJpbmcgaXMgZ2l2ZW4sIGl0IHdpbGwgYmUgcGFyc2VkIGFzIGEgbW9tZW50LgogICAgICogQHBhcmFtIHtib29sZWFufSB3b3JraW5nIGlzIHRoaXMgdGltZUZyYW1lIGZsYWdnZWQgYXMgd29ya2luZy4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZGVmYXVsdCBpcyB0aGlzIHRpbWVGcmFtZSB3aWxsIGJlIHVzZWQgYXMgZGVmYXVsdC4KICAgICAqIEBwYXJhbSB7Y29sb3J9IGNzcyBjb2xvciBhdHRhY2hlZCB0byB0aGlzIHRpbWVGcmFtZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc2VzIGNzcyBjbGFzc2VzIGF0dGFjaGVkIHRvIHRoaXMgdGltZUZyYW1lLgogICAgICoKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICovCiAgICB2YXIgVGltZUZyYW1lID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdGFydCA9IG9wdGlvbnMuc3RhcnQ7CiAgICAgICAgdGhpcy5lbmQgPSBvcHRpb25zLmVuZDsKICAgICAgICB0aGlzLndvcmtpbmcgPSBvcHRpb25zLndvcmtpbmc7CiAgICAgICAgdGhpcy5kZWZhdWx0ID0gb3B0aW9ucy5kZWZhdWx0OwogICAgICAgIHRoaXMuY29sb3IgPSBvcHRpb25zLmNvbG9yOwogICAgICAgIHRoaXMuY2xhc3NlcyA9IG9wdGlvbnMuY2xhc3NlczsKICAgIH07CgoKICAgIFRpbWVGcmFtZS5wcm90b3R5cGUuZ2V0RHVyYXRpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbmQuZGlmZih0aGlzLnN0YXJ0LCAnbWlsbGlzZWNvbmRzJyk7CiAgICB9OwoKICAgIFRpbWVGcmFtZS5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IFRpbWVGcmFtZSh0aGlzKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBUaW1lRnJhbWVNYXBwaW5nIGRlZmluZXMgaG93IHRpbWVGcmFtZXMgd2lsbCBiZSBwbGFjZWQgZm9yIGVhY2ggZGF5cy4gcGFyYW1ldGVycyBhcmUgZ2l2ZW4gdXNpbmcgb3B0aW9ucyBvYmplY3QuCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZnVuYyBhIGZ1bmN0aW9uIHdpdGggZGF0ZSBwYXJhbWV0ZXIsIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQgZm9yIGVhY2ggZGlzdGluY3QgZGF5IG9mIHRoZSBnYW50dC4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgdGhpcyBmdW5jdGlvbiBtdXN0IHJldHVybiBhbiBhcnJheSBvZiB0aW1lRnJhbWUgbmFtZXMgdG8gYXBwbHkuCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqLwogICAgdmFyIFRpbWVGcmFtZU1hcHBpbmcgPSBmdW5jdGlvbihmdW5jKSB7CiAgICAgICAgdGhpcy5mdW5jID0gZnVuYzsKICAgIH07CgogICAgVGltZUZyYW1lTWFwcGluZy5wcm90b3R5cGUuZ2V0VGltZUZyYW1lcyA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICB2YXIgcmV0ID0gdGhpcy5mdW5jKGRhdGUpOwogICAgICAgIGlmICghKHJldCBpbnN0YW5jZW9mIEFycmF5KSkgewogICAgICAgICAgICByZXQgPSBbcmV0XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH07CgogICAgVGltZUZyYW1lTWFwcGluZy5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IFRpbWVGcmFtZU1hcHBpbmcodGhpcy5mdW5jKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBBIERhdGVGcmFtZSBpcyBkYXRlIHJhbmdlIHRoYXQgd2lsbCB1c2UgYSBzcGVjaWZpYyBUaW1lRnJhbWVNYXBwaW5nLCBjb25maWd1cmVkIHVzaW5nIGEgZnVuY3Rpb24gKGV2YWx1YXRvciksCiAgICAgKiBhIGRhdGUgKGRhdGUpIG9yIGEgZGF0ZSByYW5nZSAoc3RhcnQsIGVuZCkuIHBhcmFtZXRlcnMgYXJlIGdpdmVuIHVzaW5nIG9wdGlvbnMgb2JqZWN0LgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGV2YWx1YXRvciBhIGZ1bmN0aW9uIHdpdGggZGF0ZSBwYXJhbWV0ZXIsIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQgZm9yIGVhY2ggZGlzdGluY3QgZGF5IG9mIHRoZSBnYW50dC4KICAgICAqICAgICAgICAgICAgICAgICAgIHRoaXMgZnVuY3Rpb24gbXVzdCByZXR1cm4gYSBib29sZWFuIHJlcHJlc2VudGluZyBtYXRjaGluZyBvZiB0aGlzIGRhdGVGcmFtZSBvciBub3QuCiAgICAgKiBAcGFyYW0ge21vbWVudH0gZGF0ZSBkYXRlIG9mIGRhdGVGcmFtZS4KICAgICAqIEBwYXJhbSB7bW9tZW50fSBzdGFydCBzdGFydCBvZiBkYXRlIGZyYW1lLgogICAgICogQHBhcmFtIHttb21lbnR9IGVuZCBlbmQgb2YgZGF0ZSBmcmFtZS4KICAgICAqIEBwYXJhbSB7YXJyYXl9IHRhcmdldHMgYXJyYXkgb2YgVGltZUZyYW1lTWFwcGluZ3MvVGltZUZyYW1lcyBuYW1lcyB0byB1c2UgZm9yIHRoaXMgZGF0ZSBmcmFtZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZGVmYXVsdCBpcyB0aGlzIGRhdGVGcmFtZSB3aWxsIGJlIHVzZWQgYXMgZGVmYXVsdC4KICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICovCiAgICB2YXIgRGF0ZUZyYW1lID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIHRoaXMuZXZhbHVhdG9yID0gb3B0aW9ucy5ldmFsdWF0b3I7CiAgICAgICAgaWYgKG9wdGlvbnMuZGF0ZSkgewogICAgICAgICAgICB0aGlzLnN0YXJ0ID0gbW9tZW50KG9wdGlvbnMuZGF0ZSkuc3RhcnRPZignZGF5Jyk7CiAgICAgICAgICAgIHRoaXMuZW5kID0gbW9tZW50KG9wdGlvbnMuZGF0ZSkuZW5kT2YoJ2RheScpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuc3RhcnQgPSBvcHRpb25zLnN0YXJ0OwogICAgICAgICAgICB0aGlzLmVuZCA9IG9wdGlvbnMuZW5kOwogICAgICAgIH0KICAgICAgICBpZiAob3B0aW9ucy50YXJnZXRzIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgICAgdGhpcy50YXJnZXRzID0gb3B0aW9ucy50YXJnZXRzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0cyA9IFtvcHRpb25zLnRhcmdldHNdOwogICAgICAgIH0KICAgICAgICB0aGlzLmRlZmF1bHQgPSBvcHRpb25zLmRlZmF1bHQ7CiAgICB9OwoKICAgIERhdGVGcmFtZS5wcm90b3R5cGUuZGF0ZU1hdGNoID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgIGlmICh0aGlzLmV2YWx1YXRvcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ldmFsdWF0b3IoZGF0ZSk7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXJ0ICYmIHRoaXMuZW5kKSB7CiAgICAgICAgICAgIHJldHVybiBkYXRlID49IHRoaXMuc3RhcnQgJiYgZGF0ZSA8PSB0aGlzLmVuZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfTsKCiAgICBEYXRlRnJhbWUucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlRnJhbWUodGhpcyk7CiAgICB9OwoKCgogICAgLyoqCiAgICAgKiBSZWdpc3RlciBUaW1lRnJhbWUsIFRpbWVGcmFtZU1hcHBpbmcgYW5kIERhdGVNYXBwaW5nIG9iamVjdHMgaW50byBDYWxlbmRhciBvYmplY3QsCiAgICAgKiBhbmQgdXNlIENhbGVuZGFyI2dldFRpbWVGcmFtZXMoZGF0ZSkgZnVuY3Rpb24gdG8gcmV0cmlldmUgZWZmZWN0aXZlIHRpbWVGcmFtZXMgZm9yIGEgc3BlY2lmaWMgZGF5LgogICAgICoKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICovCiAgICB2YXIgQ2FsZW5kYXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnRpbWVGcmFtZXMgPSB7fTsKICAgICAgICB0aGlzLnRpbWVGcmFtZU1hcHBpbmdzID0ge307CiAgICAgICAgdGhpcy5kYXRlRnJhbWVzID0ge307CiAgICB9OwoKICAgIC8qKgogICAgICogUmVtb3ZlIGFsbCBvYmplY3RzLgogICAgICovCiAgICBDYWxlbmRhci5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnRpbWVGcmFtZXMgPSB7fTsKICAgICAgICB0aGlzLnRpbWVGcmFtZU1hcHBpbmdzID0ge307CiAgICAgICAgdGhpcy5kYXRlRnJhbWVzID0ge307CiAgICB9OwoKICAgIC8qKgogICAgICogUmVnaXN0ZXIgVGltZUZyYW1lIG9iamVjdHMuCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IHRpbWVGcmFtZXMgd2l0aCBuYW1lcyBvZiB0aW1lRnJhbWVzIGZvciBrZXlzIGFuZCBUaW1lRnJhbWUgb2JqZWN0cyBmb3IgdmFsdWVzLgogICAgICovCiAgICBDYWxlbmRhci5wcm90b3R5cGUucmVnaXN0ZXJUaW1lRnJhbWVzID0gZnVuY3Rpb24odGltZUZyYW1lcykgewogICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aW1lRnJhbWVzLCBmdW5jdGlvbih0aW1lRnJhbWUsIG5hbWUpIHsKICAgICAgICAgICAgdGhpcy50aW1lRnJhbWVzW25hbWVdID0gbmV3IFRpbWVGcmFtZSh0aW1lRnJhbWUpOwogICAgICAgIH0sIHRoaXMpOwogICAgfTsKCiAgICAvKioKICAgICAqIFJlbW92ZXMgVGltZUZyYW1lIG9iamVjdHMuCiAgICAgKgogICAgICogQHBhcmFtIHthcnJheX0gdGltZUZyYW1lcyBuYW1lcyBvZiB0aW1lRnJhbWVzIHRvIHJlbW92ZS4KICAgICAqLwogICAgQ2FsZW5kYXIucHJvdG90eXBlLnJlbW92ZVRpbWVGcmFtZXMgPSBmdW5jdGlvbih0aW1lRnJhbWVzKSB7CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRpbWVGcmFtZXMsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMudGltZUZyYW1lc1tuYW1lXTsKICAgICAgICB9LCB0aGlzKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBSZW1vdmUgYWxsIFRpbWVGcmFtZSBvYmplY3RzLgogICAgICovCiAgICBDYWxlbmRhci5wcm90b3R5cGUuY2xlYXJUaW1lRnJhbWVzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy50aW1lRnJhbWVzID0ge307CiAgICB9OwoKICAgIC8qKgogICAgICogUmVnaXN0ZXIgVGltZUZyYW1lTWFwcGluZyBvYmplY3RzLgogICAgICoKICAgICAqIEBwYXJhbSB7b2JqZWN0fSBtYXBwaW5ncyBvYmplY3Qgd2l0aCBuYW1lcyBvZiB0aW1lRnJhbWVzIG1hcHBpbmdzIGZvciBrZXlzIGFuZCBUaW1lRnJhbWVNYXBwaW5nIG9iamVjdHMgZm9yIHZhbHVlcy4KICAgICAqLwogICAgQ2FsZW5kYXIucHJvdG90eXBlLnJlZ2lzdGVyVGltZUZyYW1lTWFwcGluZ3MgPSBmdW5jdGlvbihtYXBwaW5ncykgewogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChtYXBwaW5ncywgZnVuY3Rpb24odGltZUZyYW1lTWFwcGluZywgbmFtZSkgewogICAgICAgICAgICB0aGlzLnRpbWVGcmFtZU1hcHBpbmdzW25hbWVdID0gbmV3IFRpbWVGcmFtZU1hcHBpbmcodGltZUZyYW1lTWFwcGluZyk7CiAgICAgICAgfSwgdGhpcyk7CiAgICB9OwoKICAgIC8qKgogICAgICogUmVtb3ZlcyBUaW1lRnJhbWVNYXBwaW5nIG9iamVjdHMuCiAgICAgKgogICAgICogQHBhcmFtIHthcnJheX0gbWFwcGluZ3MgbmFtZXMgb2YgdGltZUZyYW1lIG1hcHBpbmdzIHRvIHJlbW92ZS4KICAgICAqLwogICAgQ2FsZW5kYXIucHJvdG90eXBlLnJlbW92ZVRpbWVGcmFtZU1hcHBpbmdzID0gZnVuY3Rpb24obWFwcGluZ3MpIHsKICAgICAgICBhbmd1bGFyLmZvckVhY2gobWFwcGluZ3MsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMudGltZUZyYW1lTWFwcGluZ3NbbmFtZV07CiAgICAgICAgfSwgdGhpcyk7CiAgICB9OwoKICAgIC8qKgogICAgICogUmVtb3ZlcyBhbGwgVGltZUZyYW1lTWFwcGluZyBvYmplY3RzLgogICAgICovCiAgICBDYWxlbmRhci5wcm90b3R5cGUuY2xlYXJUaW1lRnJhbWVNYXBwaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudGltZUZyYW1lTWFwcGluZ3MgPSB7fTsKICAgIH07CgogICAgLyoqCiAgICAgKiBSZWdpc3RlciBEYXRlRnJhbWUgb2JqZWN0cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0ZUZyYW1lcyBvYmplY3Qgd2l0aCBuYW1lcyBvZiBkYXRlRnJhbWVzIGZvciBrZXlzIGFuZCBEYXRlRnJhbWUgb2JqZWN0cyBmb3IgdmFsdWVzLgogICAgICovCiAgICBDYWxlbmRhci5wcm90b3R5cGUucmVnaXN0ZXJEYXRlRnJhbWVzID0gZnVuY3Rpb24oZGF0ZUZyYW1lcykgewogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChkYXRlRnJhbWVzLCBmdW5jdGlvbihkYXRlRnJhbWUsIG5hbWUpIHsKICAgICAgICAgICAgdGhpcy5kYXRlRnJhbWVzW25hbWVdID0gbmV3IERhdGVGcmFtZShkYXRlRnJhbWUpOwogICAgICAgIH0sIHRoaXMpOwogICAgfTsKCiAgICAvKioKICAgICAqIFJlbW92ZSBEYXRlRnJhbWUgb2JqZWN0cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge2FycmF5fSBtYXBwaW5ncyBuYW1lcyBvZiBkYXRlIGZyYW1lcyB0byByZW1vdmUuCiAgICAgKi8KICAgIENhbGVuZGFyLnByb3RvdHlwZS5yZW1vdmVEYXRlRnJhbWVzID0gZnVuY3Rpb24oZGF0ZUZyYW1lcykgewogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChkYXRlRnJhbWVzLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmRhdGVGcmFtZXNbbmFtZV07CiAgICAgICAgfSwgdGhpcyk7CiAgICB9OwoKICAgIC8qKgogICAgICogUmVtb3ZlcyBhbGwgRGF0ZUZyYW1lIG9iamVjdHMuCiAgICAgKi8KICAgIENhbGVuZGFyLnByb3RvdHlwZS5jbGVhckRhdGVGcmFtZXMgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmRhdGVGcmFtZXMgPSB7fTsKICAgIH07CgogICAgdmFyIGZpbHRlckRhdGVGcmFtZXMgPSBmdW5jdGlvbihpbnB1dERhdGVGcmFtZXMsIGRhdGUpIHsKICAgICAgICB2YXIgZGF0ZUZyYW1lcyA9IFtdOwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChpbnB1dERhdGVGcmFtZXMsIGZ1bmN0aW9uKGRhdGVGcmFtZSkgewogICAgICAgICAgICBpZiAoZGF0ZUZyYW1lLmRhdGVNYXRjaChkYXRlKSkgewogICAgICAgICAgICAgICAgZGF0ZUZyYW1lcy5wdXNoKGRhdGVGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBpZiAoZGF0ZUZyYW1lcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGlucHV0RGF0ZUZyYW1lcywgZnVuY3Rpb24oZGF0ZUZyYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAoZGF0ZUZyYW1lLmRlZmF1bHQpIHsKICAgICAgICAgICAgICAgICAgICBkYXRlRnJhbWVzLnB1c2goZGF0ZUZyYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkYXRlRnJhbWVzOwogICAgfTsKCiAgICAvKioKICAgICAqIFJldHJpZXZlcyBUaW1lRnJhbWUgb2JqZWN0cyBmb3IgYSBnaXZlbiBkYXRlLCB1c2luZyB3aG9sZSBjb25maWd1cmF0aW9uIGZvciB0aGlzIENhbGVuZGFyIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge21vbWVudH0gZGF0ZQogICAgICoKICAgICAqIEByZXR1cm4ge2FycmF5fSBhbiBhcnJheSBvZiBUaW1lRnJhbWUgb2JqZWN0cy4KICAgICAqLwogICAgQ2FsZW5kYXIucHJvdG90eXBlLmdldFRpbWVGcmFtZXMgPSBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgdmFyIHRpbWVGcmFtZXMgPSBbXTsKICAgICAgICB2YXIgZGF0ZUZyYW1lcyA9IGZpbHRlckRhdGVGcmFtZXModGhpcy5kYXRlRnJhbWVzLCBkYXRlKTsKCiAgICAgICAgYW5ndWxhci5mb3JFYWNoKGRhdGVGcmFtZXMsIGZ1bmN0aW9uKGRhdGVGcmFtZSkgewogICAgICAgICAgICBpZiAoZGF0ZUZyYW1lICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChkYXRlRnJhbWUudGFyZ2V0cywgZnVuY3Rpb24odGltZUZyYW1lTWFwcGluZ05hbWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGltZUZyYW1lTWFwcGluZyA9IHRoaXMudGltZUZyYW1lTWFwcGluZ3NbdGltZUZyYW1lTWFwcGluZ05hbWVdOwogICAgICAgICAgICAgICAgICAgIGlmICh0aW1lRnJhbWVNYXBwaW5nICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgYSB0aW1lRnJhbWUgbWFwcGluZyBpcyBmb3VuZAogICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWVzLnB1c2godGltZUZyYW1lTWFwcGluZy5nZXRUaW1lRnJhbWVzKCkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIG5vIHRpbWVGcmFtZSBtYXBwaW5nIGlzIGZvdW5kLCB0cnkgdXNpbmcgZGlyZWN0IHRpbWVGcmFtZQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGltZUZyYW1lID0gdGhpcy50aW1lRnJhbWVzW3RpbWVGcmFtZU1hcHBpbmdOYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRpbWVGcmFtZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWVzLnB1c2godGltZUZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgfSwgdGhpcyk7CgogICAgICAgIHZhciBkYXRlWWVhciA9IGRhdGUueWVhcigpOwogICAgICAgIHZhciBkYXRlTW9udGggPSBkYXRlLm1vbnRoKCk7CiAgICAgICAgdmFyIGRhdGVEYXRlID0gZGF0ZS5kYXRlKCk7CgogICAgICAgIHZhciB2YWxpZGF0ZWRUaW1lRnJhbWVzID0gW107CiAgICAgICAgaWYgKHRpbWVGcmFtZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLnRpbWVGcmFtZXMsIGZ1bmN0aW9uKHRpbWVGcmFtZSkgewogICAgICAgICAgICAgICAgaWYgKHRpbWVGcmFtZS5kZWZhdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgdGltZUZyYW1lcy5wdXNoKHRpbWVGcmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRpbWVGcmFtZXMsIGZ1bmN0aW9uKHRpbWVGcmFtZSkgewogICAgICAgICAgICB0aW1lRnJhbWUgPSB0aW1lRnJhbWUuY2xvbmUoKTsKCiAgICAgICAgICAgIGlmICh0aW1lRnJhbWUuc3RhcnQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGltZUZyYW1lLnN0YXJ0LnllYXIoZGF0ZVllYXIpOwogICAgICAgICAgICAgICAgdGltZUZyYW1lLnN0YXJ0Lm1vbnRoKGRhdGVNb250aCk7CiAgICAgICAgICAgICAgICB0aW1lRnJhbWUuc3RhcnQuZGF0ZShkYXRlRGF0ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aW1lRnJhbWUuZW5kICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRpbWVGcmFtZS5lbmQueWVhcihkYXRlWWVhcik7CiAgICAgICAgICAgICAgICB0aW1lRnJhbWUuZW5kLm1vbnRoKGRhdGVNb250aCk7CiAgICAgICAgICAgICAgICB0aW1lRnJhbWUuZW5kLmRhdGUoZGF0ZURhdGUpOwoKICAgICAgICAgICAgICAgIGlmIChtb21lbnQodGltZUZyYW1lLmVuZCkuc3RhcnRPZignZGF5JykgPT09IHRpbWVGcmFtZS5lbmQpIHsKICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUuZW5kLmFkZCgxLCAnZGF5Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhbGlkYXRlZFRpbWVGcmFtZXMucHVzaCh0aW1lRnJhbWUpOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gdmFsaWRhdGVkVGltZUZyYW1lczsKICAgIH07CgogICAgLyoqCiAgICAgKiBTb2x2ZSB0aW1lRnJhbWVzIHVzaW5nIHR3byBydWxlcy4KICAgICAqCiAgICAgKiAxKSBJZiBhdCBsZWFzdCBvbmUgd29ya2luZyB0aW1lRnJhbWUgaXMgZGVmaW5lZCwgZXZlcnl0aGluZyBvdXRzaWRlCiAgICAgKiBkZWZpbmVkIHRpbWVGcmFtZXMgaXMgY29uc2lkZXJlZCBhcyBub24td29ya2luZy4gRWxzZSBpdCdzIGNvbnNpZGVyZWQKICAgICAqIGFzIHdvcmtpbmcuCiAgICAgKgogICAgICogMikgU21hbGxlciB0aW1lRnJhbWVzIGhhdmUgcHJpb3JpdHkgb3ZlciBsYXJnZXIgb25lLgogICAgICoKICAgICAqIEBwYXJhbSB7YXJyYXl9IHRpbWVGcmFtZXMgQXJyYXkgb2YgdGltZUZyYW1lcyB0byBzb2x2ZQogICAgICogQHBhcmFtIHttb21lbnR9IHN0YXJ0RGF0ZQogICAgICogQHBhcmFtIHttb21lbnR9IGVuZERhdGUKICAgICAqLwogICAgQ2FsZW5kYXIucHJvdG90eXBlLnNvbHZlID0gZnVuY3Rpb24odGltZUZyYW1lcywgc3RhcnREYXRlLCBlbmREYXRlKSB7CiAgICAgICAgdmFyIGRlZmF1bHRXb3JraW5nID0gdGltZUZyYW1lcy5sZW5ndGggPT09IDA7CiAgICAgICAgdmFyIGNvbG9yOwogICAgICAgIHZhciBjbGFzc2VzOwogICAgICAgIHZhciBtaW5EYXRlOwogICAgICAgIHZhciBtYXhEYXRlOwoKICAgICAgICBhbmd1bGFyLmZvckVhY2godGltZUZyYW1lcywgZnVuY3Rpb24odGltZUZyYW1lKSB7CiAgICAgICAgICAgIGlmIChtaW5EYXRlID09PSB1bmRlZmluZWQgfHwgbWluRGF0ZSA+IHRpbWVGcmFtZS5zdGFydCkgewogICAgICAgICAgICAgICAgbWluRGF0ZSA9IHRpbWVGcmFtZS5zdGFydDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobWF4RGF0ZSA9PT0gdW5kZWZpbmVkIHx8IG1heERhdGUgPCB0aW1lRnJhbWUuZW5kKSB7CiAgICAgICAgICAgICAgICBtYXhEYXRlID0gdGltZUZyYW1lLmVuZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29sb3IgPT09IHVuZGVmaW5lZCAmJiB0aW1lRnJhbWUuY29sb3IpIHsKICAgICAgICAgICAgICAgIGNvbG9yID0gdGltZUZyYW1lLmNvbG9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aW1lRnJhbWUuY2xhc3NlcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBpZiAoY2xhc3NlcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgY2xhc3NlcyA9IFtdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2xhc3NlcyA9IGNsYXNzZXMuY29uY2F0KHRpbWVGcmFtZS5jbGFzc2VzKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBpZiAoc3RhcnREYXRlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgc3RhcnREYXRlID0gbWluRGF0ZTsKICAgICAgICB9CgogICAgICAgIGlmIChlbmREYXRlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgZW5kRGF0ZSA9IG1heERhdGU7CiAgICAgICAgfQoKICAgICAgICB2YXIgc29sdmVkVGltZUZyYW1lcyA9IFtuZXcgVGltZUZyYW1lKHtzdGFydDogc3RhcnREYXRlLCBlbmQ6IGVuZERhdGUsIHdvcmtpbmc6IGRlZmF1bHRXb3JraW5nLCBjb2xvcjogY29sb3IsIGNsYXNzZXM6IGNsYXNzZXN9KV07CgogICAgICAgIHZhciBvcmRlcmVkVGltZUZyYW1lcyA9ICRmaWx0ZXIoJ29yZGVyQnknKSh0aW1lRnJhbWVzLCBmdW5jdGlvbih0aW1lRnJhbWUpIHsKICAgICAgICAgICAgcmV0dXJuIC10aW1lRnJhbWUuZ2V0RHVyYXRpb24oKTsKICAgICAgICB9KTsKCiAgICAgICAgYW5ndWxhci5mb3JFYWNoKG9yZGVyZWRUaW1lRnJhbWVzLCBmdW5jdGlvbih0aW1lRnJhbWUpIHsKICAgICAgICAgICAgdmFyIHRtcFNvbHZlZFRpbWVGcmFtZXMgPSBzb2x2ZWRUaW1lRnJhbWVzLnNsaWNlKCk7CgogICAgICAgICAgICB2YXIgaT0wOwogICAgICAgICAgICB2YXIgZGlzcGF0Y2hlZCA9IGZhbHNlOwogICAgICAgICAgICB2YXIgdHJlYXRlZCA9IGZhbHNlOwogICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goc29sdmVkVGltZUZyYW1lcywgZnVuY3Rpb24oc29sdmVkVGltZUZyYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRyZWF0ZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGltZUZyYW1lLmVuZCA+IHNvbHZlZFRpbWVGcmFtZS5zdGFydCAmJiB0aW1lRnJhbWUuc3RhcnQgPCBzb2x2ZWRUaW1lRnJhbWUuZW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRpbWVGcmFtZSBpcyBpbmNsdWRlZCBpbiB0aGlzIHNvbHZlZFRpbWVGcmFtZS4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gc29sdmVkVGltZUZyYW1lOnxzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3NzfAogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICB0aW1lRnJhbWU6ICAgICAgICAgIHx0dHR0dHR8CiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgIHJlc3VsdDp8c3Nzc3Nzc3NzfHR0dHR0dHxzc3Nzc3Nzc3Nzc3Nzc3Nzc3wKCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZSA9IHRpbWVGcmFtZS5jbG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3U29sdmVkVGltZUZyYW1lID0gc29sdmVkVGltZUZyYW1lLmNsb25lKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBzb2x2ZWRUaW1lRnJhbWUuZW5kID0gbW9tZW50KHRpbWVGcmFtZS5zdGFydCk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1NvbHZlZFRpbWVGcmFtZS5zdGFydCA9IG1vbWVudCh0aW1lRnJhbWUuZW5kKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRtcFNvbHZlZFRpbWVGcmFtZXMuc3BsaWNlKGkgKyAxLCAwLCB0aW1lRnJhbWUuY2xvbmUoKSwgbmV3U29sdmVkVGltZUZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgdHJlYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghZGlzcGF0Y2hlZCAmJiB0aW1lRnJhbWUuc3RhcnQgPCBzb2x2ZWRUaW1lRnJhbWUuZW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRpbWVGcmFtZSBpcyBkaXNwYXRjaGVkIG9uIHR3byBzb2x2ZWRUaW1lRnJhbWUuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpcnN0IHBhcnQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc29sdmVkVGltZUZyYW1lOnxzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3xzKzE7cysxO3MrMTtzKzE7cysxO3MrMXwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgdGltZUZyYW1lOiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfHR0dHR0dHwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICAgcmVzdWx0Onxzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3NzfHR0dHR0dHw7cysxO3MrMTtzKzE7cysxO3MrMXwKCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZSA9IHRpbWVGcmFtZS5jbG9uZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgc29sdmVkVGltZUZyYW1lLmVuZCA9IG1vbWVudCh0aW1lRnJhbWUuc3RhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICB0bXBTb2x2ZWRUaW1lRnJhbWVzLnNwbGljZShpICsgMSwgMCwgdGltZUZyYW1lKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BhdGNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGlzcGF0Y2hlZCAmJiB0aW1lRnJhbWUuZW5kID4gc29sdmVkVGltZUZyYW1lLnN0YXJ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRpbWVGcmFtZSBpcyBkaXNwYXRjaGVkIG9uIHR3byBzb2x2ZWRUaW1lRnJhbWUuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNlY29uZCBwYXJ0CgogICAgICAgICAgICAgICAgICAgICAgICBzb2x2ZWRUaW1lRnJhbWUuc3RhcnQgPSBtb21lbnQodGltZUZyYW1lLmVuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BhdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdHJlYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBzb2x2ZWRUaW1lRnJhbWVzID0gdG1wU29sdmVkVGltZUZyYW1lczsKICAgICAgICB9KTsKCiAgICAgICAgc29sdmVkVGltZUZyYW1lcyA9ICRmaWx0ZXIoJ2ZpbHRlcicpKHNvbHZlZFRpbWVGcmFtZXMsIGZ1bmN0aW9uKHRpbWVGcmFtZSkgewogICAgICAgICAgICByZXR1cm4gKHRpbWVGcmFtZS5zdGFydCA9PT0gdW5kZWZpbmVkIHx8IHRpbWVGcmFtZS5zdGFydCA8IGVuZERhdGUpICYmICh0aW1lRnJhbWUuZW5kID09PSB1bmRlZmluZWQgfHwgdGltZUZyYW1lLmVuZCA+IHN0YXJ0RGF0ZSk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBzb2x2ZWRUaW1lRnJhbWVzOwoKICAgIH07CgogICAgcmV0dXJuIENhbGVuZGFyOwp9XSk7CgoKZ2FudHQuZmFjdG9yeSgnR2FudHRDdXJyZW50RGF0ZU1hbmFnZXInLCBbZnVuY3Rpb24oKSB7CiAgICB2YXIgR2FudHRDdXJyZW50RGF0ZU1hbmFnZXIgPSBmdW5jdGlvbihnYW50dCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgdGhpcy5nYW50dCA9IGdhbnR0OwoKICAgICAgICB0aGlzLmRhdGUgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLmN1cnJlbnREYXRlQ29sdW1uID0gdW5kZWZpbmVkOwoKICAgICAgICB0aGlzLmdhbnR0LiRzY29wZS4kd2F0Y2hHcm91cChbJ2N1cnJlbnREYXRlJywgJ2N1cnJlbnREYXRlVmFsdWUnXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNlbGYuc2V0Q3VycmVudERhdGUoc2VsZi5nYW50dC4kc2NvcGUuY3VycmVudERhdGVWYWx1ZSk7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIEdhbnR0Q3VycmVudERhdGVNYW5hZ2VyLnByb3RvdHlwZS5zZXRDdXJyZW50RGF0ZSA9IGZ1bmN0aW9uKGN1cnJlbnREYXRlKSB7CiAgICAgICAgdGhpcy5kYXRlID0gY3VycmVudERhdGU7CiAgICAgICAgaWYgKHRoaXMuY3VycmVudERhdGVDb2x1bW4gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aGlzLmN1cnJlbnREYXRlQ29sdW1uLmN1cnJlbnREYXRlID0gdW5kZWZpbmVkOwogICAgICAgICAgICBkZWxldGUgdGhpcy5jdXJyZW50RGF0ZUNvbHVtbjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmRhdGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB2YXIgY29sdW1uID0gdGhpcy5nYW50dC5jb2x1bW5zTWFuYWdlci5nZXRDb2x1bW5CeURhdGUodGhpcy5kYXRlKTsKICAgICAgICAgICAgaWYgKGNvbHVtbiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBjb2x1bW4uY3VycmVudERhdGUgPSB0aGlzLmRhdGU7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnREYXRlQ29sdW1uID0gY29sdW1uOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnBvc2l0aW9uID0gdGhpcy5nYW50dC5nZXRQb3NpdGlvbkJ5RGF0ZSh0aGlzLmRhdGUpOwogICAgfTsKICAgIHJldHVybiBHYW50dEN1cnJlbnREYXRlTWFuYWdlcjsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0Q29sdW1uJywgWyAnbW9tZW50JywgZnVuY3Rpb24obW9tZW50KSB7CiAgICAvLyBVc2VkIHRvIGRpc3BsYXkgdGhlIEdhbnR0IGdyaWQgYW5kIGhlYWRlci4KICAgIC8vIFRoZSBjb2x1bW5zIGFyZSBnZW5lcmF0ZWQgYnkgdGhlIGNvbHVtbiBnZW5lcmF0b3IuCiAgICB2YXIgQ29sdW1uID0gZnVuY3Rpb24oZGF0ZSwgZW5kRGF0ZSwgbGVmdCwgd2lkdGgsIGNhbGVuZGFyLCB0aW1lRnJhbWVzV29ya2luZ01vZGUsIHRpbWVGcmFtZXNOb25Xb3JraW5nTW9kZSwgY29sdW1uTWFnbmV0VmFsdWUsIGNvbHVtbk1hZ25ldFVuaXQpIHsKICAgICAgICB0aGlzLmRhdGUgPSBkYXRlOwogICAgICAgIHRoaXMuZW5kRGF0ZSA9IGVuZERhdGU7CiAgICAgICAgdGhpcy5sZWZ0ID0gbGVmdDsKICAgICAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICAgICAgdGhpcy5jYWxlbmRhciA9IGNhbGVuZGFyOwogICAgICAgIHRoaXMuZHVyYXRpb24gPSB0aGlzLmVuZERhdGUuZGlmZih0aGlzLmRhdGUsICdtaWxsaXNlY29uZHMnKTsKICAgICAgICB0aGlzLnRpbWVGcmFtZXNXb3JraW5nTW9kZSA9IHRpbWVGcmFtZXNXb3JraW5nTW9kZTsKICAgICAgICB0aGlzLnRpbWVGcmFtZXNOb25Xb3JraW5nTW9kZSA9IHRpbWVGcmFtZXNOb25Xb3JraW5nTW9kZTsKICAgICAgICB0aGlzLnRpbWVGcmFtZXMgPSBbXTsKICAgICAgICB0aGlzLnZpc2libGVUaW1lRnJhbWVzID0gW107CiAgICAgICAgdGhpcy5kYXlzVGltZUZyYW1lcyA9IHt9OwogICAgICAgIHRoaXMuY3JvcHBlZCA9IGZhbHNlOwogICAgICAgIHRoaXMuY29sdW1uTWFnbmV0VmFsdWUgPSBjb2x1bW5NYWduZXRWYWx1ZTsKICAgICAgICB0aGlzLmNvbHVtbk1hZ25ldFVuaXQgPSBjb2x1bW5NYWduZXRVbml0OwogICAgICAgIHRoaXMub3JpZ2luYWxTaXplID0ge2xlZnQ6IHRoaXMubGVmdCwgd2lkdGg6IHRoaXMud2lkdGh9OwogICAgICAgIHRoaXMudXBkYXRlVGltZUZyYW1lcygpOwogICAgfTsKCiAgICB2YXIgZ2V0RGF0ZUtleSA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICByZXR1cm4gZGF0ZS55ZWFyKCkgKyAnLScgKyBkYXRlLm1vbnRoKCkgKyAnLScgKyBkYXRlLmRhdGUoKTsKICAgIH07CgogICAgQ29sdW1uLnByb3RvdHlwZS51cGRhdGVUaW1lRnJhbWVzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBpZiAoc2VsZi5jYWxlbmRhciAhPT0gdW5kZWZpbmVkICYmIChzZWxmLnRpbWVGcmFtZXNOb25Xb3JraW5nTW9kZSAhPT0gJ2hpZGRlbicgfHwgc2VsZi50aW1lRnJhbWVzV29ya2luZ01vZGUgIT09ICdoaWRkZW4nKSkgewogICAgICAgICAgICB2YXIgYnVpbGRQdXNoVGltZUZyYW1lcyA9IGZ1bmN0aW9uKHRpbWVGcmFtZXMsIHN0YXJ0RGF0ZSwgZW5kRGF0ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHRpbWVGcmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IHRpbWVGcmFtZS5zdGFydDsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RhcnQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHN0YXJ0RGF0ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBlbmQgPSB0aW1lRnJhbWUuZW5kOwogICAgICAgICAgICAgICAgICAgIGlmIChlbmQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBlbmQgPSBlbmREYXRlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXJ0IDwgc2VsZi5kYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gc2VsZi5kYXRlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGVuZCA+IHNlbGYuZW5kRGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbmQgPSBzZWxmLmVuZERhdGU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUgPSB0aW1lRnJhbWUuY2xvbmUoKTsKCiAgICAgICAgICAgICAgICAgICAgdGltZUZyYW1lLnN0YXJ0ID0gbW9tZW50KHN0YXJ0KTsKICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUuZW5kID0gbW9tZW50KGVuZCk7CgogICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZXMucHVzaCh0aW1lRnJhbWUpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciBjRGF0ZSA9IHNlbGYuZGF0ZTsKICAgICAgICAgICAgdmFyIGNEYXRlU3RhcnRPZkRheSA9IG1vbWVudChjRGF0ZSkuc3RhcnRPZignZGF5Jyk7CiAgICAgICAgICAgIHZhciBjRGF0ZU5leHREYXkgPSBjRGF0ZVN0YXJ0T2ZEYXkuYWRkKDEsICdkYXknKTsKICAgICAgICAgICAgd2hpbGUgKGNEYXRlIDwgc2VsZi5lbmREYXRlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZUZyYW1lcyA9IHNlbGYuY2FsZW5kYXIuZ2V0VGltZUZyYW1lcyhjRGF0ZSk7CiAgICAgICAgICAgICAgICB2YXIgbmV4dENEYXRlID0gbW9tZW50Lm1pbihjRGF0ZU5leHREYXksIHNlbGYuZW5kRGF0ZSk7CiAgICAgICAgICAgICAgICB0aW1lRnJhbWVzID0gc2VsZi5jYWxlbmRhci5zb2x2ZSh0aW1lRnJhbWVzLCBjRGF0ZSwgbmV4dENEYXRlKTsKICAgICAgICAgICAgICAgIHZhciBjVGltZUZyYW1lcyA9IFtdOwogICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRpbWVGcmFtZXMsIGJ1aWxkUHVzaFRpbWVGcmFtZXMoY1RpbWVGcmFtZXMsIGNEYXRlLCBuZXh0Q0RhdGUpKTsKICAgICAgICAgICAgICAgIHNlbGYudGltZUZyYW1lcyA9IHNlbGYudGltZUZyYW1lcy5jb25jYXQoY1RpbWVGcmFtZXMpOwoKICAgICAgICAgICAgICAgIHZhciBjRGF0ZUtleSA9IGdldERhdGVLZXkoY0RhdGUpOwogICAgICAgICAgICAgICAgc2VsZi5kYXlzVGltZUZyYW1lc1tjRGF0ZUtleV0gPSBjVGltZUZyYW1lczsKCiAgICAgICAgICAgICAgICBjRGF0ZSA9IG5leHRDRGF0ZTsKICAgICAgICAgICAgICAgIGNEYXRlU3RhcnRPZkRheSA9IG1vbWVudChjRGF0ZSkuc3RhcnRPZignZGF5Jyk7CiAgICAgICAgICAgICAgICBjRGF0ZU5leHREYXkgPSBjRGF0ZVN0YXJ0T2ZEYXkuYWRkKDEsICdkYXknKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHNlbGYudGltZUZyYW1lcywgZnVuY3Rpb24odGltZUZyYW1lKSB7CiAgICAgICAgICAgICAgICB2YXIgcG9zaXRpb25EdXJhdGlvbiA9IHRpbWVGcmFtZS5zdGFydC5kaWZmKHNlbGYuZGF0ZSwgJ21pbGxpc2Vjb25kcycpOwogICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9uID0gcG9zaXRpb25EdXJhdGlvbiAvIHNlbGYuZHVyYXRpb24gKiBzZWxmLndpZHRoOwoKICAgICAgICAgICAgICAgIHZhciB0aW1lRnJhbWVEdXJhdGlvbiA9IHRpbWVGcmFtZS5lbmQuZGlmZih0aW1lRnJhbWUuc3RhcnQsICdtaWxsaXNlY29uZHMnKTsKICAgICAgICAgICAgICAgIHZhciB0aW1lRnJhbWVQb3NpdGlvbiA9IHRpbWVGcmFtZUR1cmF0aW9uIC8gc2VsZi5kdXJhdGlvbiAqIHNlbGYud2lkdGg7CgogICAgICAgICAgICAgICAgdmFyIGhpZGRlbiA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHRpbWVGcmFtZS53b3JraW5nICYmIHNlbGYudGltZUZyYW1lc1dvcmtpbmdNb2RlICE9PSAndmlzaWJsZScpIHsKICAgICAgICAgICAgICAgICAgICBoaWRkZW4gPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGltZUZyYW1lLndvcmtpbmcgJiYgc2VsZi50aW1lRnJhbWVzTm9uV29ya2luZ01vZGUgIT09ICd2aXNpYmxlJykgewogICAgICAgICAgICAgICAgICAgIGhpZGRlbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFoaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLnZpc2libGVUaW1lRnJhbWVzLnB1c2godGltZUZyYW1lKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aW1lRnJhbWUuaGlkZGVuID0gaGlkZGVuOwogICAgICAgICAgICAgICAgdGltZUZyYW1lLmxlZnQgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgIHRpbWVGcmFtZS53aWR0aCA9IHRpbWVGcmFtZVBvc2l0aW9uOwogICAgICAgICAgICAgICAgdGltZUZyYW1lLm9yaWdpbmFsU2l6ZSA9IHtsZWZ0OiB0aW1lRnJhbWUubGVmdCwgd2lkdGg6IHRpbWVGcmFtZS53aWR0aH07CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKHNlbGYudGltZUZyYW1lc05vbldvcmtpbmdNb2RlID09PSAnY3JvcHBlZCcgfHwgc2VsZi50aW1lRnJhbWVzV29ya2luZ01vZGUgPT09ICdjcm9wcGVkJykgewogICAgICAgICAgICAgICAgdmFyIHRpbWVGcmFtZXNXaWR0aCA9IDA7CiAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goc2VsZi50aW1lRnJhbWVzLCBmdW5jdGlvbih0aW1lRnJhbWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRpbWVGcmFtZS53b3JraW5nICYmIHNlbGYudGltZUZyYW1lc05vbldvcmtpbmdNb2RlICE9PSAnY3JvcHBlZCcgfHwKICAgICAgICAgICAgICAgICAgICAgICAgdGltZUZyYW1lLndvcmtpbmcgJiYgc2VsZi50aW1lRnJhbWVzV29ya2luZ01vZGUgIT09ICdjcm9wcGVkJykgewogICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWVzV2lkdGggKz0gdGltZUZyYW1lLndpZHRoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlmICh0aW1lRnJhbWVzV2lkdGggIT09IHNlbGYud2lkdGgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY3JvcHBlZFJhdGlvID0gc2VsZi53aWR0aCAvIHRpbWVGcmFtZXNXaWR0aDsKICAgICAgICAgICAgICAgICAgICB2YXIgY3JvcHBlZFdpZHRoID0gMDsKICAgICAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxDcm9wcGVkV2lkdGggPSAwOwoKICAgICAgICAgICAgICAgICAgICB2YXIgYWxsQ3JvcHBlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChzZWxmLnRpbWVGcmFtZXMsIGZ1bmN0aW9uKHRpbWVGcmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRpbWVGcmFtZS53b3JraW5nICYmIHNlbGYudGltZUZyYW1lc05vbldvcmtpbmdNb2RlICE9PSAnY3JvcHBlZCcgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZS53b3JraW5nICYmIHNlbGYudGltZUZyYW1lc1dvcmtpbmdNb2RlICE9PSAnY3JvcHBlZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZS5sZWZ0ID0gKHRpbWVGcmFtZS5sZWZ0IC0gY3JvcHBlZFdpZHRoKSAqIGNyb3BwZWRSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZS53aWR0aCA9IHRpbWVGcmFtZS53aWR0aCAqIGNyb3BwZWRSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZS5vcmlnaW5hbFNpemUubGVmdCA9ICh0aW1lRnJhbWUub3JpZ2luYWxTaXplLmxlZnQgLSBvcmlnaW5hbENyb3BwZWRXaWR0aCkgKiBjcm9wcGVkUmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUub3JpZ2luYWxTaXplLndpZHRoID0gdGltZUZyYW1lLm9yaWdpbmFsU2l6ZS53aWR0aCAqIGNyb3BwZWRSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZS5jcm9wcGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxDcm9wcGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcm9wcGVkV2lkdGggKz0gdGltZUZyYW1lLndpZHRoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxDcm9wcGVkV2lkdGggKz0gdGltZUZyYW1lLm9yaWdpbmFsU2l6ZS53aWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZS5sZWZ0ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZUZyYW1lLndpZHRoID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZS5vcmlnaW5hbFNpemUgPSB7bGVmdDogdW5kZWZpbmVkLCB3aWR0aDogMH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lRnJhbWUuY3JvcHBlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jcm9wcGVkID0gYWxsQ3JvcHBlZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jcm9wcGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIENvbHVtbi5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IENvbHVtbihtb21lbnQodGhpcy5kYXRlKSwgbW9tZW50KHRoaXMuZW5kRGF0ZSksIHRoaXMubGVmdCwgdGhpcy53aWR0aCwgdGhpcy5jYWxlbmRhcik7CiAgICB9OwoKICAgIENvbHVtbi5wcm90b3R5cGUuY29udGFpbnNEYXRlID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgIHJldHVybiBkYXRlID4gdGhpcy5kYXRlICYmIGRhdGUgPD0gdGhpcy5lbmREYXRlOwogICAgfTsKCiAgICBDb2x1bW4ucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGF0ZSA9PT0gb3RoZXIuZGF0ZTsKICAgIH07CgogICAgQ29sdW1uLnByb3RvdHlwZS5nZXRNYWduZXREYXRlID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgIGlmICh0aGlzLmNvbHVtbk1hZ25ldFZhbHVlID4gMCAmJiB0aGlzLmNvbHVtbk1hZ25ldFVuaXQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBkYXRlID0gbW9tZW50KGRhdGUpOwogICAgICAgICAgICB2YXIgdmFsdWUgPSBkYXRlLmdldCh0aGlzLmNvbHVtbk1hZ25ldFVuaXQpOwogICAgICAgICAgICB2YXIgbWFnbmV0VmFsdWUgPSBNYXRoLnJvdW5kKHZhbHVlL3RoaXMuY29sdW1uTWFnbmV0VmFsdWUpICogdGhpcy5jb2x1bW5NYWduZXRWYWx1ZTsKICAgICAgICAgICAgZGF0ZS5zdGFydE9mKHRoaXMuY29sdW1uTWFnbmV0VW5pdCk7CiAgICAgICAgICAgIGRhdGUuc2V0KHRoaXMuY29sdW1uTWFnbmV0VW5pdCwgbWFnbmV0VmFsdWUpOwogICAgICAgICAgICByZXR1cm4gZGF0ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRhdGU7CiAgICB9OwoKICAgIHZhciBnZXREYXRlQnlQb3NpdGlvblVzaW5nVGltZUZyYW1lcyA9IGZ1bmN0aW9uKHRpbWVGcmFtZXMsIHBvc2l0aW9uKSB7CiAgICAgICAgZm9yICh2YXIgaT0wOyBpIDwgdGltZUZyYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAvLyBUT0RPOiBwZXJmb3JtYW5jZSBvcHRpbWl6YXRpb24gY291bGQgYmUgZG9uZS4KICAgICAgICAgICAgdmFyIHRpbWVGcmFtZSA9IHRpbWVGcmFtZXNbaV07CiAgICAgICAgICAgIGlmICghdGltZUZyYW1lLmNyb3BwZWQgJiYgcG9zaXRpb24gPj0gdGltZUZyYW1lLmxlZnQgJiYgcG9zaXRpb24gPD0gdGltZUZyYW1lLmxlZnQgKyB0aW1lRnJhbWUud2lkdGgpIHsKICAgICAgICAgICAgICAgIHZhciBwb3NpdGlvbkR1cmF0aW9uID0gdGltZUZyYW1lLmdldER1cmF0aW9uKCkgLyB0aW1lRnJhbWUud2lkdGggKiAocG9zaXRpb24gLSB0aW1lRnJhbWUubGVmdCk7CiAgICAgICAgICAgICAgICB2YXIgZGF0ZSA9IG1vbWVudCh0aW1lRnJhbWUuc3RhcnQpLmFkZChwb3NpdGlvbkR1cmF0aW9uLCAnbWlsbGlzZWNvbmRzJyk7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgQ29sdW1uLnByb3RvdHlwZS5nZXREYXRlQnlQb3NpdGlvbiA9IGZ1bmN0aW9uKHBvc2l0aW9uLCBtYWduZXQpIHsKICAgICAgICB2YXIgcG9zaXRpb25EdXJhdGlvbjsKICAgICAgICB2YXIgZGF0ZTsKCiAgICAgICAgaWYgKHBvc2l0aW9uIDwgMCkgewogICAgICAgICAgICBwb3NpdGlvbiA9IDA7CiAgICAgICAgfQogICAgICAgIGlmIChwb3NpdGlvbiA+IHRoaXMud2lkdGgpIHsKICAgICAgICAgICAgcG9zaXRpb24gPSB0aGlzLndpZHRoOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMudGltZUZyYW1lc05vbldvcmtpbmdNb2RlID09PSAnY3JvcHBlZCcgfHwgdGhpcy50aW1lRnJhbWVzV29ya2luZ01vZGUgPT09ICdjcm9wcGVkJykgewogICAgICAgICAgICBkYXRlID0gZ2V0RGF0ZUJ5UG9zaXRpb25Vc2luZ1RpbWVGcmFtZXModGhpcy50aW1lRnJhbWVzLCBwb3NpdGlvbik7CiAgICAgICAgfQoKICAgICAgICBpZiAoZGF0ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHBvc2l0aW9uRHVyYXRpb24gPSB0aGlzLmR1cmF0aW9uIC8gdGhpcy53aWR0aCAqIHBvc2l0aW9uOwogICAgICAgICAgICBkYXRlID0gbW9tZW50KHRoaXMuZGF0ZSkuYWRkKHBvc2l0aW9uRHVyYXRpb24sICdtaWxsaXNlY29uZHMnKTsKICAgICAgICB9CgogICAgICAgIGlmIChtYWduZXQpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TWFnbmV0RGF0ZShkYXRlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBkYXRlOwogICAgfTsKCiAgICBDb2x1bW4ucHJvdG90eXBlLmdldERheVRpbWVGcmFtZSA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICB2YXIgZHRmID0gdGhpcy5kYXlzVGltZUZyYW1lc1tnZXREYXRlS2V5KGRhdGUpXTsKICAgICAgICBpZiAoZHRmID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZHRmOwogICAgfTsKCiAgICBDb2x1bW4ucHJvdG90eXBlLmdldFBvc2l0aW9uQnlEYXRlID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgIHZhciBwb3NpdGlvbkR1cmF0aW9uOwogICAgICAgIHZhciBwb3NpdGlvbjsKCiAgICAgICAgaWYgKHRoaXMudGltZUZyYW1lc05vbldvcmtpbmdNb2RlID09PSAnY3JvcHBlZCcgfHwgdGhpcy50aW1lRnJhbWVzV29ya2luZ01vZGUgPT09ICdjcm9wcGVkJykgewogICAgICAgICAgICB2YXIgY3JvcHBlZERhdGUgPSBkYXRlOwogICAgICAgICAgICB2YXIgdGltZUZyYW1lcyA9IHRoaXMuZ2V0RGF5VGltZUZyYW1lKGNyb3BwZWREYXRlKTsKICAgICAgICAgICAgZm9yICh2YXIgaT0wOyBpIDwgdGltZUZyYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHRpbWVGcmFtZSA9IHRpbWVGcmFtZXNbaV07CiAgICAgICAgICAgICAgICBpZiAoY3JvcHBlZERhdGUgPj0gdGltZUZyYW1lLnN0YXJ0ICYmIGNyb3BwZWREYXRlIDw9IHRpbWVGcmFtZS5lbmQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGltZUZyYW1lLmNyb3BwZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRpbWVGcmFtZXMubGVuZ3RoID4gaSsxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcm9wcGVkRGF0ZSA9IHRpbWVGcmFtZXNbaSsxXS5zdGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyb3BwZWREYXRlID0gdGltZUZyYW1lLmVuZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uRHVyYXRpb24gPSBjcm9wcGVkRGF0ZS5kaWZmKHRpbWVGcmFtZS5zdGFydCwgJ21pbGxpc2Vjb25kcycpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IHBvc2l0aW9uRHVyYXRpb24gLyB0aW1lRnJhbWUuZ2V0RHVyYXRpb24oKSAqIHRpbWVGcmFtZS53aWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubGVmdCArIHRpbWVGcmFtZS5sZWZ0ICsgcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBwb3NpdGlvbkR1cmF0aW9uID0gZGF0ZS5kaWZmKHRoaXMuZGF0ZSwgJ21pbGxpc2Vjb25kcycpOwogICAgICAgIHBvc2l0aW9uID0gcG9zaXRpb25EdXJhdGlvbiAvIHRoaXMuZHVyYXRpb24gKiB0aGlzLndpZHRoOwoKICAgICAgICBpZiAocG9zaXRpb24gPCAwKSB7CiAgICAgICAgICAgIHBvc2l0aW9uID0gMDsKICAgICAgICB9CgogICAgICAgIGlmIChwb3NpdGlvbiA+IHRoaXMud2lkdGgpIHsKICAgICAgICAgICAgcG9zaXRpb24gPSB0aGlzLndpZHRoOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMubGVmdCArIHBvc2l0aW9uOwogICAgfTsKCiAgICByZXR1cm4gQ29sdW1uOwp9XSk7CgoKZ2FudHQuZmFjdG9yeSgnR2FudHRDb2x1bW5HZW5lcmF0b3InLCBbICdHYW50dENvbHVtbicsICdtb21lbnQnLCBmdW5jdGlvbihDb2x1bW4sIG1vbWVudCkgewogICAgdmFyIENvbHVtbkdlbmVyYXRvciA9IGZ1bmN0aW9uKGNvbHVtbnNNYW5hZ2VyKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICB2YXIgY29sdW1uV2lkdGggPSBjb2x1bW5zTWFuYWdlci5nYW50dC4kc2NvcGUuY29sdW1uV2lkdGg7CiAgICAgICAgaWYgKGNvbHVtbldpZHRoID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgY29sdW1uV2lkdGggPSAyMDsKICAgICAgICB9CiAgICAgICAgdmFyIHVuaXQgPSBjb2x1bW5zTWFuYWdlci5nYW50dC4kc2NvcGUudmlld1NjYWxlOwogICAgICAgIHZhciBjYWxlbmRhciA9IGNvbHVtbnNNYW5hZ2VyLmdhbnR0LmNhbGVuZGFyOwogICAgICAgIHZhciB0aW1lRnJhbWVzV29ya2luZ01vZGUgPSBjb2x1bW5zTWFuYWdlci5nYW50dC4kc2NvcGUudGltZUZyYW1lc1dvcmtpbmdNb2RlOwogICAgICAgIHZhciB0aW1lRnJhbWVzTm9uV29ya2luZ01vZGUgPSBjb2x1bW5zTWFuYWdlci5nYW50dC4kc2NvcGUudGltZUZyYW1lc05vbldvcmtpbmdNb2RlOwoKICAgICAgICB2YXIgY29sdW1uTWFnbmV0VmFsdWU7CiAgICAgICAgdmFyIGNvbHVtbk1hZ25ldFVuaXQ7CgogICAgICAgIGlmIChjb2x1bW5zTWFuYWdlci5nYW50dC4kc2NvcGUuY29sdW1uTWFnbmV0KSB7CiAgICAgICAgICAgIHZhciBzcGxpdHRlZENvbHVtbk1hZ25ldCA9IGNvbHVtbnNNYW5hZ2VyLmdhbnR0LiRzY29wZS5jb2x1bW5NYWduZXQudHJpbSgpLnNwbGl0KCcgJyk7CiAgICAgICAgICAgIGlmIChzcGxpdHRlZENvbHVtbk1hZ25ldC5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICBjb2x1bW5NYWduZXRWYWx1ZSA9IHBhcnNlSW50KHNwbGl0dGVkQ29sdW1uTWFnbmV0WzBdKTsKICAgICAgICAgICAgICAgIGNvbHVtbk1hZ25ldFVuaXQgPSBzcGxpdHRlZENvbHVtbk1hZ25ldFtzcGxpdHRlZENvbHVtbk1hZ25ldC5sZW5ndGgtMV07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEdlbmVyYXRlcyBvbmUgY29sdW1uIGZvciBlYWNoIHRpbWUgdW5pdCBiZXR3ZWVuIHRoZSBnaXZlbiBmcm9tIGFuZCB0byBkYXRlLgogICAgICAgIHNlbGYuZ2VuZXJhdGUgPSBmdW5jdGlvbihmcm9tLCB0bywgbWF4aW11bVdpZHRoLCBsZWZ0T2Zmc2V0LCByZXZlcnNlKSB7CiAgICAgICAgICAgIGlmICghdG8gJiYgIW1heGltdW1XaWR0aCkgewogICAgICAgICAgICAgICAgdGhyb3cgJ3RvIG9yIG1heGltdW1XaWR0aCBtdXN0IGJlIGRlZmluZWQnOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZXhjbHVkZVRvID0gZmFsc2U7CiAgICAgICAgICAgIGZyb20gPSBtb21lbnQoZnJvbSkuc3RhcnRPZih1bml0KTsKICAgICAgICAgICAgaWYgKHRvKSB7CiAgICAgICAgICAgICAgICBleGNsdWRlVG8gPSBpc1RvRGF0ZVRvRXhjbHVkZSh0byk7CiAgICAgICAgICAgICAgICB0byA9IG1vbWVudCh0bykuc3RhcnRPZih1bml0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGRhdGUgPSBtb21lbnQoZnJvbSkuc3RhcnRPZih1bml0KTsKICAgICAgICAgICAgdmFyIGdlbmVyYXRlZENvbHMgPSBbXTsKICAgICAgICAgICAgdmFyIGxlZnQgPSAwOwoKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIGlmIChtYXhpbXVtV2lkdGggJiYgTWF0aC5hYnMobGVmdCkgPiBtYXhpbXVtV2lkdGggKyBjb2x1bW5XaWR0aCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBzdGFydERhdGUgPSBtb21lbnQoZGF0ZSk7CiAgICAgICAgICAgICAgICB2YXIgZW5kRGF0ZSA9IG1vbWVudChzdGFydERhdGUpLmFkZCgxLCB1bml0KTsKCiAgICAgICAgICAgICAgICB2YXIgY29sdW1uID0gbmV3IENvbHVtbihzdGFydERhdGUsIGVuZERhdGUsIGxlZnRPZmZzZXQgPyBsZWZ0ICsgbGVmdE9mZnNldCA6IGxlZnQsIGNvbHVtbldpZHRoLCBjYWxlbmRhciwgdGltZUZyYW1lc1dvcmtpbmdNb2RlLCB0aW1lRnJhbWVzTm9uV29ya2luZ01vZGUsIGNvbHVtbk1hZ25ldFZhbHVlLCBjb2x1bW5NYWduZXRVbml0KTsKICAgICAgICAgICAgICAgIGlmICghY29sdW1uLmNyb3BwZWQpIHsKICAgICAgICAgICAgICAgICAgICBnZW5lcmF0ZWRDb2xzLnB1c2goY29sdW1uKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmV2ZXJzZSkgewogICAgICAgICAgICAgICAgICAgICAgICBsZWZ0IC09IGNvbHVtbldpZHRoOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQgKz0gY29sdW1uV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAodG8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJldmVyc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlVG8gJiYgZGF0ZSA8IHRvIHx8ICFleGNsdWRlVG8gJiYgZGF0ZSA8PSB0bykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVUbyAmJiBkYXRlID4gdG8gfHwgIWV4Y2x1ZGVUbyAmJiBkYXRlID49IHRvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkYXRlLmFkZChyZXZlcnNlID8gLTEgOiAxLCB1bml0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHJldmVyc2UpIHsKICAgICAgICAgICAgICAgIGlmIChpc1RvRGF0ZVRvRXhjbHVkZShmcm9tKSkgewogICAgICAgICAgICAgICAgICAgIGdlbmVyYXRlZENvbHMuc2hpZnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGdlbmVyYXRlZENvbHMucmV2ZXJzZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZ2VuZXJhdGVkQ29sczsKICAgICAgICB9OwoKICAgICAgICAvLyBDb2x1bW5zIGFyZSBnZW5lcmF0ZWQgaW5jbHVkaW5nIG9yIGV4Y2x1ZGluZyB0aGUgdG8gZGF0ZS4KICAgICAgICAvLyBJZiB0aGUgVG8gZGF0ZSBpcyB0aGUgZmlyc3QgZGF5IG9mIG1vbnRoIGFuZCB0aGUgdGltZSBpcyAwMDowMCB0aGVuIG5vIG5ldyBjb2x1bW4gaXMgZ2VuZXJhdGVkIGZvciB0aGlzIG1vbnRoLgoKICAgICAgICB2YXIgaXNUb0RhdGVUb0V4Y2x1ZGUgPSBmdW5jdGlvbih0bykgewogICAgICAgICAgICByZXR1cm4gbW9tZW50KHRvKS5hZGQoMSwgdW5pdCkuc3RhcnRPZih1bml0KSA9PT0gdG87CiAgICAgICAgfTsKICAgIH07CiAgICByZXR1cm4gQ29sdW1uR2VuZXJhdG9yOwp9XSk7CgoKZ2FudHQuZmFjdG9yeSgnR2FudHRDb2x1bW5IZWFkZXInLCBbICdtb21lbnQnLCAnR2FudHRDb2x1bW4nLCBmdW5jdGlvbihtb21lbnQsIENvbHVtbikgewogICAgLy8gVXNlZCB0byBkaXNwbGF5IHRoZSBHYW50dCBncmlkIGFuZCBoZWFkZXIuCiAgICAvLyBUaGUgY29sdW1ucyBhcmUgZ2VuZXJhdGVkIGJ5IHRoZSBjb2x1bW4gZ2VuZXJhdG9yLgoKICAgIHZhciBDb2x1bW5IZWFkZXIgPSBmdW5jdGlvbihkYXRlLCB1bml0LCBsZWZ0LCB3aWR0aCwgbGFiZWwpIHsKICAgICAgICB2YXIgc3RhcnREYXRlID0gbW9tZW50KGRhdGUpOwogICAgICAgIHZhciBlbmREYXRlID0gbW9tZW50KHN0YXJ0RGF0ZSkuYWRkKDEsIHVuaXQpOwoKICAgICAgICB2YXIgY29sdW1uID0gbmV3IENvbHVtbihzdGFydERhdGUsIGVuZERhdGUsIGxlZnQsIHdpZHRoKTsKICAgICAgICBjb2x1bW4udW5pdCA9IHVuaXQ7CiAgICAgICAgY29sdW1uLmxhYmVsID0gbGFiZWw7CgogICAgICAgIHJldHVybiBjb2x1bW47CiAgICB9OwogICAgcmV0dXJuIENvbHVtbkhlYWRlcjsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0Q29sdW1uc01hbmFnZXInLCBbJ0dhbnR0Q29sdW1uR2VuZXJhdG9yJywgJ0dhbnR0SGVhZGVyR2VuZXJhdG9yJywgJyRmaWx0ZXInLCAnZ2FudHRMYXlvdXQnLCAnZ2FudHRCaW5hcnlTZWFyY2gnLCBmdW5jdGlvbihDb2x1bW5HZW5lcmF0b3IsIEhlYWRlckdlbmVyYXRvciwgJGZpbHRlciwgbGF5b3V0LCBicykgewogICAgdmFyIENvbHVtbnNNYW5hZ2VyID0gZnVuY3Rpb24oZ2FudHQpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHRoaXMuZ2FudHQgPSBnYW50dDsKCiAgICAgICAgdGhpcy5mcm9tID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMudG8gPSB1bmRlZmluZWQ7CgogICAgICAgIHRoaXMuY29sdW1ucyA9IFtdOwogICAgICAgIHRoaXMudmlzaWJsZUNvbHVtbnMgPSBbXTsKICAgICAgICB0aGlzLnByZXZpb3VzQ29sdW1ucyA9IFtdOwogICAgICAgIHRoaXMubmV4dENvbHVtbnMgPSBbXTsKCiAgICAgICAgdGhpcy5oZWFkZXJzID0ge307CiAgICAgICAgdGhpcy52aXNpYmxlSGVhZGVycyA9IHt9OwoKICAgICAgICB0aGlzLnNjcm9sbEFuY2hvciA9IHVuZGVmaW5lZDsKCiAgICAgICAgLy8gQWRkIGEgd2F0Y2hlciBpZiBhIHZpZXcgcmVsYXRlZCBzZXR0aW5nIGNoYW5nZWQgZnJvbSBvdXRzaWRlIG9mIHRoZSBHYW50dC4gVXBkYXRlIHRoZSBnYW50dCBhY2NvcmRpbmdseSBpZiBzby4KICAgICAgICAvLyBBbGwgdGhvc2UgY2hhbmdlcyBuZWVkIGEgcmVjYWxjdWxhdGlvbiBvZiB0aGUgaGVhZGVyIGNvbHVtbnMKICAgICAgICB0aGlzLmdhbnR0LiRzY29wZS4kd2F0Y2hHcm91cChbJ3ZpZXdTY2FsZScsICdjb2x1bW5XaWR0aCcsICd0aW1lRnJhbWVzV29ya2luZ01vZGUnLCAndGltZUZyYW1lc05vbldvcmtpbmdNb2RlJywgJ2NvbHVtbk1hZ25ldCcsICdmcm9tRGF0ZScsICd0b0RhdGUnLCAnYXV0b0V4cGFuZCcsICd0YXNrT3V0T2ZSYW5nZSddLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi5nZW5lcmF0ZUNvbHVtbnMoKTsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5nYW50dC4kc2NvcGUuJHdhdGNoQ29sbGVjdGlvbignaGVhZGVycycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzZWxmLmdlbmVyYXRlQ29sdW1ucygpOwogICAgICAgIH0pOwoKICAgICAgICB0aGlzLmdhbnR0LiRzY29wZS4kd2F0Y2hDb2xsZWN0aW9uKCdoZWFkZXJzRm9ybWF0cycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzZWxmLmdlbmVyYXRlQ29sdW1ucygpOwogICAgICAgIH0pOwoKICAgICAgICB0aGlzLmdhbnR0LiRzY29wZS4kd2F0Y2hHcm91cChbJ2dhbnR0RWxlbWVudFdpZHRoJywgJ2xhYmVsc1dpZHRoJywgJ3Nob3dMYWJlbHNDb2x1bW4nLCAnbWF4SGVpZ2h0J10sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzZWxmLnVwZGF0ZUNvbHVtbnNNZXRhKCk7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuZ2FudHQuJHNjb3BlLiR3YXRjaEdyb3VwKFsnc2Nyb2xsTGVmdCcsICdzY3JvbGxXaWR0aCddLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi51cGRhdGVWaXNpYmxlQ29sdW1ucygpOwogICAgICAgIH0pOwoKICAgICAgICB0aGlzLmdhbnR0LmFwaS5kYXRhLm9uLmxvYWQodGhpcy5nYW50dC4kc2NvcGUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoc2VsZi5mcm9tID4gc2VsZi5nYW50dC5yb3dzTWFuYWdlci5nZXREZWZhdWx0RnJvbSgpIHx8CiAgICAgICAgICAgICAgICBzZWxmLnRvIDwgc2VsZi5nYW50dC5yb3dzTWFuYWdlci5nZXREZWZhdWx0VG8oKSkgewogICAgICAgICAgICAgICAgc2VsZi5nZW5lcmF0ZUNvbHVtbnMoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2VsZi5nYW50dC5yb3dzTWFuYWdlci5zb3J0Um93cygpOwogICAgICAgIH0pOwoKICAgICAgICB0aGlzLmdhbnR0LmFwaS5kYXRhLm9uLnJlbW92ZSh0aGlzLmdhbnR0LiRzY29wZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNlbGYuZ2FudHQucm93c01hbmFnZXIuc29ydFJvd3MoKTsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJNZXRob2QoJ2NvbHVtbnMnLCAnY2xlYXInLCB0aGlzLmNsZWFyQ29sdW1ucywgdGhpcyk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJNZXRob2QoJ2NvbHVtbnMnLCAnZ2VuZXJhdGUnLCB0aGlzLmdlbmVyYXRlQ29sdW1ucywgdGhpcyk7CgogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyRXZlbnQoJ2NvbHVtbnMnLCAnZ2VuZXJhdGUnKTsKICAgIH07CgogICAgQ29sdW1uc01hbmFnZXIucHJvdG90eXBlLnNldFNjcm9sbEFuY2hvciA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmdhbnR0LnNjcm9sbC4kZWxlbWVudCAmJiB0aGlzLmNvbHVtbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZWwgPSB0aGlzLmdhbnR0LnNjcm9sbC4kZWxlbWVudFswXTsKICAgICAgICAgICAgdmFyIGNlbnRlciA9IGVsLnNjcm9sbExlZnQgKyBlbC5vZmZzZXRXaWR0aCAvIDI7CgogICAgICAgICAgICB0aGlzLnNjcm9sbEFuY2hvciA9IHRoaXMuZ2FudHQuZ2V0RGF0ZUJ5UG9zaXRpb24oY2VudGVyKTsKICAgICAgICB9CiAgICB9OwoKICAgIENvbHVtbnNNYW5hZ2VyLnByb3RvdHlwZS5zY3JvbGxUb1Njcm9sbEFuY2hvciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgaWYgKHRoaXMuY29sdW1ucy5sZW5ndGggPiAwICYmIHRoaXMuc2Nyb2xsQW5jaG9yICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgLy8gVWdseSBidXQgcHJldmVudHMgc2NyZWVuIGZsaWNrZXJpbmcgKHVubGlrZSAkdGltZW91dCkKICAgICAgICAgICAgdGhpcy5nYW50dC4kc2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2VsZi5nYW50dC5hcGkuc2Nyb2xsLnRvRGF0ZShzZWxmLnNjcm9sbEFuY2hvcik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07CgogICAgQ29sdW1uc01hbmFnZXIucHJvdG90eXBlLmNsZWFyQ29sdW1ucyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2V0U2Nyb2xsQW5jaG9yKCk7CgogICAgICAgIHRoaXMuZnJvbSA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLnRvID0gdW5kZWZpbmVkOwoKICAgICAgICB0aGlzLmNvbHVtbnMgPSBbXTsKICAgICAgICB0aGlzLnZpc2libGVDb2x1bW5zID0gW107CiAgICAgICAgdGhpcy5wcmV2aW91c0NvbHVtbnMgPSBbXTsKICAgICAgICB0aGlzLm5leHRDb2x1bW5zID0gW107CgogICAgICAgIHRoaXMuaGVhZGVycyA9IFtdOwogICAgICAgIHRoaXMudmlzaWJsZUhlYWRlcnMgPSB7fTsKCiAgICAgICAgdGhpcy5nYW50dC5hcGkuY29sdW1ucy5yYWlzZS5jbGVhcigpOwogICAgfTsKCiAgICBDb2x1bW5zTWFuYWdlci5wcm90b3R5cGUuZ2VuZXJhdGVDb2x1bW5zID0gZnVuY3Rpb24oZnJvbSwgdG8pIHsKICAgICAgICBpZiAoIWZyb20pIHsKICAgICAgICAgICAgZnJvbSA9IHRoaXMuZ2FudHQuJHNjb3BlLmZyb21EYXRlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0bykgewogICAgICAgICAgICB0byA9IHRoaXMuZ2FudHQuJHNjb3BlLnRvRGF0ZTsKICAgICAgICB9CgogICAgICAgIGlmICghZnJvbSkgewogICAgICAgICAgICBmcm9tID0gdGhpcy5nYW50dC5yb3dzTWFuYWdlci5nZXREZWZhdWx0RnJvbSgpOwogICAgICAgICAgICBpZiAoIWZyb20pIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCF0bykgewogICAgICAgICAgICB0byA9IHRoaXMuZ2FudHQucm93c01hbmFnZXIuZ2V0RGVmYXVsdFRvKCk7CiAgICAgICAgICAgIGlmICghdG8pIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FudHQuJHNjb3BlLnRhc2tPdXRPZlJhbmdlID09PSAnZXhwYW5kJykgewogICAgICAgICAgICBmcm9tID0gdGhpcy5nYW50dC5yb3dzTWFuYWdlci5nZXRFeHBhbmRlZEZyb20oZnJvbSk7CiAgICAgICAgICAgIHRvID0gdGhpcy5nYW50dC5yb3dzTWFuYWdlci5nZXRFeHBhbmRlZFRvKHRvKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc2V0U2Nyb2xsQW5jaG9yKCk7CgogICAgICAgIHRoaXMuZnJvbSA9IGZyb207CiAgICAgICAgdGhpcy50byA9IHRvOwoKICAgICAgICB2YXIgY29sdW1uR2VuZXJhdG9yID0gbmV3IENvbHVtbkdlbmVyYXRvcih0aGlzKTsKICAgICAgICB2YXIgaGVhZGVyR2VuZXJhdG9yID0gbmV3IEhlYWRlckdlbmVyYXRvcih0aGlzKTsKCiAgICAgICAgdGhpcy5jb2x1bW5zID0gY29sdW1uR2VuZXJhdG9yLmdlbmVyYXRlKGZyb20sIHRvKTsKICAgICAgICB0aGlzLmhlYWRlcnMgPSBoZWFkZXJHZW5lcmF0b3IuZ2VuZXJhdGUodGhpcy5jb2x1bW5zKTsKICAgICAgICB0aGlzLnByZXZpb3VzQ29sdW1ucyA9IFtdOwogICAgICAgIHRoaXMubmV4dENvbHVtbnMgPSBbXTsKCiAgICAgICAgdGhpcy51cGRhdGVDb2x1bW5zTWV0YSgpOwogICAgICAgIHRoaXMuc2Nyb2xsVG9TY3JvbGxBbmNob3IoKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5jb2x1bW5zLnJhaXNlLmdlbmVyYXRlKHRoaXMuY29sdW1ucywgdGhpcy5oZWFkZXJzKTsKICAgIH07CgogICAgQ29sdW1uc01hbmFnZXIucHJvdG90eXBlLnVwZGF0ZUNvbHVtbnNNZXRhID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGxhc3RDb2x1bW4gPSB0aGlzLmdldExhc3RDb2x1bW4oKTsKICAgICAgICB0aGlzLmdhbnR0Lm9yaWdpbmFsV2lkdGggPSBsYXN0Q29sdW1uICE9PSB1bmRlZmluZWQgPyBsYXN0Q29sdW1uLm9yaWdpbmFsU2l6ZS5sZWZ0ICsgbGFzdENvbHVtbi5vcmlnaW5hbFNpemUud2lkdGggOiAwOwoKICAgICAgICBpZiAodGhpcy5nYW50dC4kc2NvcGUuY29sdW1uV2lkdGggPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB2YXIgbmV3V2lkdGggPSB0aGlzLmdhbnR0LiRzY29wZS5nYW50dEVsZW1lbnRXaWR0aCAtICh0aGlzLmdhbnR0LiRzY29wZS5zaG93TGFiZWxzQ29sdW1uID8gdGhpcy5nYW50dC4kc2NvcGUubGFiZWxzV2lkdGggOiAwKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmdhbnR0LiRzY29wZS5tYXhIZWlnaHQgPiAwKSB7CiAgICAgICAgICAgICAgICBuZXdXaWR0aCA9IG5ld1dpZHRoIC0gbGF5b3V0LmdldFNjcm9sbEJhcldpZHRoKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxheW91dC5zZXRDb2x1bW5zV2lkdGgobmV3V2lkdGgsIHRoaXMuZ2FudHQub3JpZ2luYWxXaWR0aCwgdGhpcy5wcmV2aW91c0NvbHVtbnMpOwogICAgICAgICAgICBsYXlvdXQuc2V0Q29sdW1uc1dpZHRoKG5ld1dpZHRoLCB0aGlzLmdhbnR0Lm9yaWdpbmFsV2lkdGgsIHRoaXMuY29sdW1ucyk7CiAgICAgICAgICAgIGxheW91dC5zZXRDb2x1bW5zV2lkdGgobmV3V2lkdGgsIHRoaXMuZ2FudHQub3JpZ2luYWxXaWR0aCwgdGhpcy5uZXh0Q29sdW1ucyk7CgogICAgICAgICAgICBhbmd1bGFyLmZvckVhY2godGhpcy5oZWFkZXJzLCBmdW5jdGlvbihoZWFkZXIpIHsKICAgICAgICAgICAgICAgIGxheW91dC5zZXRDb2x1bW5zV2lkdGgobmV3V2lkdGgsIHRoaXMuZ2FudHQub3JpZ2luYWxXaWR0aCwgaGVhZGVyKTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmdhbnR0LndpZHRoID0gbGFzdENvbHVtbiAhPT0gdW5kZWZpbmVkID8gbGFzdENvbHVtbi5sZWZ0ICsgbGFzdENvbHVtbi53aWR0aCA6IDA7CgogICAgICAgIHRoaXMuZ2FudHQucm93c01hbmFnZXIudXBkYXRlVGFza3NQb3NBbmRTaXplKCk7CiAgICAgICAgdGhpcy5nYW50dC50aW1lc3BhbnNNYW5hZ2VyLnVwZGF0ZVRpbWVzcGFuc1Bvc0FuZFNpemUoKTsKCiAgICAgICAgdGhpcy51cGRhdGVWaXNpYmxlQ29sdW1ucygpOwogICAgICAgIHRoaXMuZ2FudHQucm93c01hbmFnZXIudXBkYXRlVmlzaWJsZU9iamVjdHMoKTsKCiAgICAgICAgdGhpcy5nYW50dC5jdXJyZW50RGF0ZU1hbmFnZXIuc2V0Q3VycmVudERhdGUodGhpcy5nYW50dC4kc2NvcGUuY3VycmVudERhdGVWYWx1ZSk7CiAgICB9OwoKICAgIC8vIFJldHVybnMgdGhlIGxhc3QgR2FudHQgY29sdW1uIG9yIHVuZGVmaW5lZAogICAgQ29sdW1uc01hbmFnZXIucHJvdG90eXBlLmdldExhc3RDb2x1bW4gPSBmdW5jdGlvbihleHRlbmRlZCkgewogICAgICAgIHZhciBjb2x1bW5zID0gdGhpcy5jb2x1bW5zOwogICAgICAgIGlmIChleHRlbmRlZCkgewogICAgICAgICAgICBjb2x1bW5zID0gdGhpcy5uZXh0Q29sdW1uczsKICAgICAgICB9CiAgICAgICAgaWYgKGNvbHVtbnMgJiYgY29sdW1ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHJldHVybiBjb2x1bW5zW2NvbHVtbnMubGVuZ3RoIC0gMV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIFJldHVybnMgdGhlIGZpcnN0IEdhbnR0IGNvbHVtbiBvciB1bmRlZmluZWQKICAgIENvbHVtbnNNYW5hZ2VyLnByb3RvdHlwZS5nZXRGaXJzdENvbHVtbiA9IGZ1bmN0aW9uKGV4dGVuZGVkKSB7CiAgICAgICAgdmFyIGNvbHVtbnMgPSB0aGlzLmNvbHVtbnM7CiAgICAgICAgaWYgKGV4dGVuZGVkKSB7CiAgICAgICAgICAgIGNvbHVtbnMgPSB0aGlzLnByZXZpb3VzQ29sdW1uczsKICAgICAgICB9CgogICAgICAgIGlmIChjb2x1bW5zICYmIGNvbHVtbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICByZXR1cm4gY29sdW1uc1swXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0KICAgIH07CgogICAgLy8gUmV0dXJucyB0aGUgY29sdW1uIGF0IHRoZSBnaXZlbiBvciBuZXh0IHBvc3NpYmxlIGRhdGUKICAgIENvbHVtbnNNYW5hZ2VyLnByb3RvdHlwZS5nZXRDb2x1bW5CeURhdGUgPSBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgdGhpcy5leHBhbmRFeHRlbmRlZENvbHVtbnNGb3JEYXRlKGRhdGUpOwogICAgICAgIHZhciBleHRlbmRlZENvbHVtbnMgPSB0aGlzLnByZXZpb3VzQ29sdW1ucy5jb25jYXQodGhpcy5jb2x1bW5zLCB0aGlzLm5leHRDb2x1bW5zKTsKICAgICAgICB2YXIgY29sdW1ucyA9IGJzLmdldChleHRlbmRlZENvbHVtbnMsIGRhdGUsIGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgcmV0dXJuIGMuZGF0ZTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gY29sdW1uc1swXSAhPT0gdW5kZWZpbmVkID8gY29sdW1uc1swXSA6IGNvbHVtbnNbMV07CiAgICB9OwoKICAgIC8vIFJldHVybnMgdGhlIGNvbHVtbiBhdCB0aGUgZ2l2ZW4gcG9zaXRpb24geCAoaW4gZW0pCiAgICBDb2x1bW5zTWFuYWdlci5wcm90b3R5cGUuZ2V0Q29sdW1uQnlQb3NpdGlvbiA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICB0aGlzLmV4cGFuZEV4dGVuZGVkQ29sdW1uc0ZvclBvc2l0aW9uKHgpOwogICAgICAgIHZhciBleHRlbmRlZENvbHVtbnMgPSB0aGlzLnByZXZpb3VzQ29sdW1ucy5jb25jYXQodGhpcy5jb2x1bW5zLCB0aGlzLm5leHRDb2x1bW5zKTsKICAgICAgICByZXR1cm4gYnMuZ2V0KGV4dGVuZGVkQ29sdW1ucywgeCwgZnVuY3Rpb24oYykgewogICAgICAgICAgICByZXR1cm4gYy5sZWZ0OwogICAgICAgIH0pWzBdOwogICAgfTsKCiAgICBDb2x1bW5zTWFuYWdlci5wcm90b3R5cGUuZXhwYW5kRXh0ZW5kZWRDb2x1bW5zRm9yUG9zaXRpb24gPSBmdW5jdGlvbih4KSB7CiAgICAgICAgaWYgKHggPCAwKSB7CiAgICAgICAgICAgIHZhciBmaXJzdENvbHVtbiA9IHRoaXMuZ2V0Rmlyc3RDb2x1bW4oKTsKICAgICAgICAgICAgdmFyIGZyb20gPSBmaXJzdENvbHVtbi5kYXRlOwogICAgICAgICAgICB2YXIgZmlyc3RFeHRlbmRlZENvbHVtbiA9IHRoaXMuZ2V0Rmlyc3RDb2x1bW4odHJ1ZSk7CiAgICAgICAgICAgIGlmICghZmlyc3RFeHRlbmRlZENvbHVtbiB8fCBmaXJzdEV4dGVuZGVkQ29sdW1uLmxlZnQgPiB4KSB7CiAgICAgICAgICAgICAgICB0aGlzLnByZXZpb3VzQ29sdW1ucyA9IG5ldyBDb2x1bW5HZW5lcmF0b3IodGhpcykuZ2VuZXJhdGUoZnJvbSwgdW5kZWZpbmVkLCAteCwgMCwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIGlmICh4ID4gdGhpcy53aWR0aCkgewogICAgICAgICAgICB2YXIgbGFzdENvbHVtbiA9IHRoaXMuZ2V0TGFzdENvbHVtbigpOwogICAgICAgICAgICB2YXIgZW5kRGF0ZSA9IGxhc3RDb2x1bW4uZ2V0RGF0ZUJ5UG9zaXRpb24obGFzdENvbHVtbi53aWR0aCk7CiAgICAgICAgICAgIHZhciBsYXN0RXh0ZW5kZWRDb2x1bW4gPSB0aGlzLmdldExhc3RDb2x1bW4odHJ1ZSk7CiAgICAgICAgICAgIGlmICghbGFzdEV4dGVuZGVkQ29sdW1uIHx8IGxhc3RFeHRlbmRlZENvbHVtbi5sZWZ0ICsgbGFzdEV4dGVuZGVkQ29sdW1uLndpZHRoIDwgeCkgewogICAgICAgICAgICAgICAgdGhpcy5uZXh0Q29sdW1ucyA9IG5ldyBDb2x1bW5HZW5lcmF0b3IodGhpcykuZ2VuZXJhdGUoZW5kRGF0ZSwgdW5kZWZpbmVkLCB4IC0gdGhpcy53aWR0aCwgdGhpcy53aWR0aCwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIENvbHVtbnNNYW5hZ2VyLnByb3RvdHlwZS5leHBhbmRFeHRlbmRlZENvbHVtbnNGb3JEYXRlID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgIHZhciBmaXJzdENvbHVtbiA9IHRoaXMuZ2V0Rmlyc3RDb2x1bW4oKTsKICAgICAgICB2YXIgZnJvbTsKICAgICAgICBpZiAoZmlyc3RDb2x1bW4pIHsKICAgICAgICAgICAgZnJvbSA9IGZpcnN0Q29sdW1uLmRhdGU7CiAgICAgICAgfQoKICAgICAgICB2YXIgbGFzdENvbHVtbiA9IHRoaXMuZ2V0TGFzdENvbHVtbigpOwogICAgICAgIHZhciBlbmREYXRlOwogICAgICAgIGlmIChsYXN0Q29sdW1uKSB7CiAgICAgICAgICAgIGVuZERhdGUgPSBsYXN0Q29sdW1uLmdldERhdGVCeVBvc2l0aW9uKGxhc3RDb2x1bW4ud2lkdGgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGZyb20gJiYgZGF0ZSA8IGZyb20pIHsKICAgICAgICAgICAgdmFyIGZpcnN0RXh0ZW5kZWRDb2x1bW4gPSB0aGlzLmdldEZpcnN0Q29sdW1uKHRydWUpOwogICAgICAgICAgICBpZiAoIWZpcnN0RXh0ZW5kZWRDb2x1bW4gfHwgZmlyc3RFeHRlbmRlZENvbHVtbi5kYXRlID4gZGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy5wcmV2aW91c0NvbHVtbnMgPSBuZXcgQ29sdW1uR2VuZXJhdG9yKHRoaXMpLmdlbmVyYXRlKGZyb20sIGRhdGUsIHVuZGVmaW5lZCwgMCwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIGlmIChlbmREYXRlICYmIGRhdGUgPiBlbmREYXRlKSB7CiAgICAgICAgICAgIHZhciBsYXN0RXh0ZW5kZWRDb2x1bW4gPSB0aGlzLmdldExhc3RDb2x1bW4odHJ1ZSk7CiAgICAgICAgICAgIGlmICghbGFzdEV4dGVuZGVkQ29sdW1uIHx8IGVuZERhdGUgPCBsYXN0RXh0ZW5kZWRDb2x1bW4pIHsKICAgICAgICAgICAgICAgIHRoaXMubmV4dENvbHVtbnMgPSBuZXcgQ29sdW1uR2VuZXJhdG9yKHRoaXMpLmdlbmVyYXRlKGVuZERhdGUsIGRhdGUsIHVuZGVmaW5lZCwgdGhpcy53aWR0aCwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIC8vIFJldHVybnMgdGhlIG51bWJlciBvZiBhY3RpdmUgaGVhZGVycwogICAgQ29sdW1uc01hbmFnZXIucHJvdG90eXBlLmdldEFjdGl2ZUhlYWRlcnNDb3VudCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzaXplID0gMCwga2V5OwogICAgICAgIGZvciAoa2V5IGluIHRoaXMuaGVhZGVycykgewogICAgICAgICAgICBpZiAodGhpcy5oZWFkZXJzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgIHNpemUrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2l6ZTsKICAgIH07CgogICAgQ29sdW1uc01hbmFnZXIucHJvdG90eXBlLnVwZGF0ZVZpc2libGVDb2x1bW5zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy52aXNpYmxlQ29sdW1ucyA9ICRmaWx0ZXIoJ2dhbnR0Q29sdW1uTGltaXQnKSh0aGlzLmNvbHVtbnMsIHRoaXMuZ2FudHQuJHNjb3BlLnNjcm9sbExlZnQsIHRoaXMuZ2FudHQuJHNjb3BlLnNjcm9sbFdpZHRoKTsKCiAgICAgICAgdGhpcy52aXNpYmxlSGVhZGVycyA9IHt9OwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmhlYWRlcnMsIGZ1bmN0aW9uKGhlYWRlcnMsIGtleSkgewogICAgICAgICAgICBpZiAodGhpcy5oZWFkZXJzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgIHRoaXMudmlzaWJsZUhlYWRlcnNba2V5XSA9ICRmaWx0ZXIoJ2dhbnR0Q29sdW1uTGltaXQnKShoZWFkZXJzLCB0aGlzLmdhbnR0LiRzY29wZS5zY3JvbGxMZWZ0LCB0aGlzLmdhbnR0LiRzY29wZS5zY3JvbGxXaWR0aCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LCB0aGlzKTsKICAgIH07CgogICAgdmFyIGRlZmF1bHRIZWFkZXJzRm9ybWF0cyA9IHsneWVhcic6ICdZWVlZJywgJ3F1YXJ0ZXInOiAnW1FdUSBZWVlZJywgbW9udGg6ICdNTU1NIFlZWVknLCB3ZWVrOiAndycsIGRheTogJ0QnLCBob3VyOiAnSCcsIG1pbnV0ZTonSEg6bW0nfTsKICAgIHZhciBkZWZhdWx0RGF5SGVhZGVyc0Zvcm1hdHMgPSB7ZGF5OiAnTEwnLCBob3VyOiAnSCcsIG1pbnV0ZTonSEg6bW0nfTsKICAgIHZhciBkZWZhdWx0WWVhckhlYWRlcnNGb3JtYXRzID0geyd5ZWFyJzogJ1lZWVknLCAncXVhcnRlcic6ICdbUV1RJywgbW9udGg6ICdNTU1NJ307CgogICAgQ29sdW1uc01hbmFnZXIucHJvdG90eXBlLmdldEhlYWRlckZvcm1hdCA9IGZ1bmN0aW9uKHVuaXQpIHsKICAgICAgICB2YXIgZm9ybWF0OwogICAgICAgIGlmICh0aGlzLmdhbnR0LiRzY29wZS5oZWFkZXJzRm9ybWF0cyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGZvcm1hdCA9IHRoaXMuZ2FudHQuJHNjb3BlLmhlYWRlcnNGb3JtYXRzW3VuaXRdOwogICAgICAgIH0KICAgICAgICBpZiAoZm9ybWF0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgaWYgKFsnbWlsbGlzZWNvbmQnLCAnc2Vjb25kJywgJ21pbnV0ZScsICdob3VyJ10uaW5kZXhPZih0aGlzLmdhbnR0LiRzY29wZS52aWV3U2NhbGUpID4gLTEpIHsKICAgICAgICAgICAgICAgIGZvcm1hdCA9IGRlZmF1bHREYXlIZWFkZXJzRm9ybWF0c1t1bml0XTsKICAgICAgICAgICAgfSBlbHNlIGlmIChbJ21vbnRoJywgJ3F1YXJ0ZXInLCAneWVhciddLmluZGV4T2YodGhpcy5nYW50dC4kc2NvcGUudmlld1NjYWxlKSA+IC0xKSB7CiAgICAgICAgICAgICAgICBmb3JtYXQgPSBkZWZhdWx0WWVhckhlYWRlcnNGb3JtYXRzW3VuaXRdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmb3JtYXQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgZm9ybWF0ID0gZGVmYXVsdEhlYWRlcnNGb3JtYXRzW3VuaXRdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmb3JtYXQ7CiAgICB9OwoKICAgIHJldHVybiBDb2x1bW5zTWFuYWdlcjsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0SGVhZGVyR2VuZXJhdG9yJywgWydHYW50dENvbHVtbkhlYWRlcicsIGZ1bmN0aW9uKENvbHVtbkhlYWRlcikgewogICAgdmFyIGdlbmVyYXRlSGVhZGVyID0gZnVuY3Rpb24oY29sdW1uc01hbmFnZXIsIGNvbHVtbnMsIHVuaXQpIHsKICAgICAgICB2YXIgZ2VuZXJhdGVkSGVhZGVycyA9IFtdOwogICAgICAgIHZhciBoZWFkZXI7CiAgICAgICAgdmFyIHByZXZDb2xEYXRlVmFsOwoKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNvbHVtbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBjb2wgPSBjb2x1bW5zW2ldOwogICAgICAgICAgICB2YXIgY29sRGF0ZVZhbCA9IGNvbC5kYXRlLmdldCh1bml0KTsKICAgICAgICAgICAgaWYgKGkgPT09IDAgfHwgcHJldkNvbERhdGVWYWwgIT09IGNvbERhdGVWYWwpIHsKICAgICAgICAgICAgICAgIHByZXZDb2xEYXRlVmFsID0gY29sRGF0ZVZhbDsKICAgICAgICAgICAgICAgIHZhciBsYWJlbCA9IGNvbC5kYXRlLmZvcm1hdChjb2x1bW5zTWFuYWdlci5nZXRIZWFkZXJGb3JtYXQodW5pdCkpOwoKICAgICAgICAgICAgICAgIGhlYWRlciA9IG5ldyBDb2x1bW5IZWFkZXIoY29sLmRhdGUsIHVuaXQsIGNvbC5vcmlnaW5hbFNpemUubGVmdCwgY29sLm9yaWdpbmFsU2l6ZS53aWR0aCwgbGFiZWwpOwogICAgICAgICAgICAgICAgaGVhZGVyLmxlZnQgPSBjb2wubGVmdDsKICAgICAgICAgICAgICAgIGhlYWRlci53aWR0aCA9IGNvbC53aWR0aDsKICAgICAgICAgICAgICAgIGdlbmVyYXRlZEhlYWRlcnMucHVzaChoZWFkZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaGVhZGVyLm9yaWdpbmFsU2l6ZS53aWR0aCArPSBjb2wub3JpZ2luYWxTaXplLndpZHRoOwogICAgICAgICAgICAgICAgaGVhZGVyLndpZHRoICs9IGNvbC53aWR0aDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VuZXJhdGVkSGVhZGVyczsKCiAgICB9OwoKICAgIHJldHVybiBmdW5jdGlvbihjb2x1bW5zTWFuYWdlcikgewogICAgICAgIHRoaXMuZ2VuZXJhdGUgPSBmdW5jdGlvbihjb2x1bW5zKSB7CiAgICAgICAgICAgIHZhciB1bml0cyA9IFtdOwogICAgICAgICAgICBpZiAoY29sdW1uc01hbmFnZXIuZ2FudHQuJHNjb3BlLmhlYWRlcnMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdW5pdHMgPSBbXTsKICAgICAgICAgICAgICAgIGlmIChbJ3llYXInLCAncXVhcnRlcicsICdtb250aCddLmluZGV4T2YoY29sdW1uc01hbmFnZXIuZ2FudHQuJHNjb3BlLnZpZXdTY2FsZSkgPiAtMSkgewogICAgICAgICAgICAgICAgICAgIHVuaXRzLnB1c2goJ3llYXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChbJ3F1YXJ0ZXInXS5pbmRleE9mKGNvbHVtbnNNYW5hZ2VyLmdhbnR0LiRzY29wZS52aWV3U2NhbGUpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICB1bml0cy5wdXNoKCdxdWFydGVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoWydkYXknLCAnd2VlaycsICdtb250aCddLmluZGV4T2YoY29sdW1uc01hbmFnZXIuZ2FudHQuJHNjb3BlLnZpZXdTY2FsZSkgPiAtMSkgewogICAgICAgICAgICAgICAgICAgIHVuaXRzLnB1c2goJ21vbnRoJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoWydkYXknLCAnd2VlayddLmluZGV4T2YoY29sdW1uc01hbmFnZXIuZ2FudHQuJHNjb3BlLnZpZXdTY2FsZSkgPiAtMSkgewogICAgICAgICAgICAgICAgICAgIHVuaXRzLnB1c2goJ3dlZWsnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChbJ2hvdXInLCAnZGF5J10uaW5kZXhPZihjb2x1bW5zTWFuYWdlci5nYW50dC4kc2NvcGUudmlld1NjYWxlKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdW5pdHMucHVzaCgnZGF5Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoWydob3VyJywgJ21pbnV0ZScsICdzZWNvbmQnXS5pbmRleE9mKGNvbHVtbnNNYW5hZ2VyLmdhbnR0LiRzY29wZS52aWV3U2NhbGUpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICB1bml0cy5wdXNoKCdob3VyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoWydtaW51dGUnLCAnc2Vjb25kJ10uaW5kZXhPZihjb2x1bW5zTWFuYWdlci5nYW50dC4kc2NvcGUudmlld1NjYWxlKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdW5pdHMucHVzaCgnbWludXRlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoWydzZWNvbmQnXS5pbmRleE9mKGNvbHVtbnNNYW5hZ2VyLmdhbnR0LiRzY29wZS52aWV3U2NhbGUpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICB1bml0cy5wdXNoKCdzZWNvbmQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1bml0cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB1bml0cy5wdXNoKGNvbHVtbnNNYW5hZ2VyLmdhbnR0LiRzY29wZS52aWV3U2NhbGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdW5pdHMgPSBjb2x1bW5zTWFuYWdlci5nYW50dC4kc2NvcGUuaGVhZGVyczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGhlYWRlcnMgPSBbXTsKICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHVuaXRzLCBmdW5jdGlvbih1bml0KSB7CiAgICAgICAgICAgICAgICBoZWFkZXJzLnB1c2goZ2VuZXJhdGVIZWFkZXIoY29sdW1uc01hbmFnZXIsIGNvbHVtbnMsIHVuaXQpKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gaGVhZGVyczsKICAgICAgICB9OwogICAgfTsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0JywgWwogICAgJ0dhbnR0QXBpJywgJ0dhbnR0Q2FsZW5kYXInLCAnR2FudHRTY3JvbGwnLCAnR2FudHRCb2R5JywgJ0dhbnR0Um93SGVhZGVyJywgJ0dhbnR0SGVhZGVyJywgJ0dhbnR0TGFiZWxzJywgJ0dhbnR0Um93c01hbmFnZXInLCAnR2FudHRDb2x1bW5zTWFuYWdlcicsICdHYW50dFRpbWVzcGFuc01hbmFnZXInLCAnR2FudHRDdXJyZW50RGF0ZU1hbmFnZXInLAogICAgZnVuY3Rpb24oR2FudHRBcGksIENhbGVuZGFyLCBTY3JvbGwsIEJvZHksIFJvd0hlYWRlciwgSGVhZGVyLCBMYWJlbHMsIFJvd3NNYW5hZ2VyLCBDb2x1bW5zTWFuYWdlciwgVGltZXNwYW5zTWFuYWdlciwgQ3VycmVudERhdGVNYW5hZ2VyKSB7CiAgICAgICAgLy8gR2FudHQgbG9naWMuIE1hbmFnZXMgdGhlIGNvbHVtbnMsIHJvd3MgYW5kIHNvcnRpbmcgZnVuY3Rpb25hbGl0eS4KICAgICAgICB2YXIgR2FudHQgPSBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuJHNjb3BlID0gJHNjb3BlOwogICAgICAgICAgICB0aGlzLiRlbGVtZW50ID0gJGVsZW1lbnQ7CgogICAgICAgICAgICB0aGlzLmFwaSA9IG5ldyBHYW50dEFwaSh0aGlzKTsKCiAgICAgICAgICAgIHRoaXMuYXBpLnJlZ2lzdGVyRXZlbnQoJ2NvcmUnLCAncmVhZHknKTsKCiAgICAgICAgICAgIHRoaXMuYXBpLnJlZ2lzdGVyRXZlbnQoJ2RpcmVjdGl2ZXMnLCAnbmV3Jyk7CiAgICAgICAgICAgIHRoaXMuYXBpLnJlZ2lzdGVyRXZlbnQoJ2RpcmVjdGl2ZXMnLCAnZGVzdHJveScpOwoKICAgICAgICAgICAgdGhpcy5hcGkucmVnaXN0ZXJFdmVudCgnZGF0YScsICdsb2FkJyk7CiAgICAgICAgICAgIHRoaXMuYXBpLnJlZ2lzdGVyRXZlbnQoJ2RhdGEnLCAncmVtb3ZlJyk7CiAgICAgICAgICAgIHRoaXMuYXBpLnJlZ2lzdGVyRXZlbnQoJ2RhdGEnLCAnY2xlYXInLCB0aGlzLmNsZWFyRGF0YSwgdGhpcyk7CgogICAgICAgICAgICB0aGlzLmFwaS5yZWdpc3Rlck1ldGhvZCgnY29yZScsICdnZXREYXRlQnlQb3NpdGlvbicsIHRoaXMuZ2V0RGF0ZUJ5UG9zaXRpb24sIHRoaXMpOwogICAgICAgICAgICB0aGlzLmFwaS5yZWdpc3Rlck1ldGhvZCgnY29yZScsICdnZXRQb3NpdGlvbkJ5RGF0ZScsIHRoaXMuZ2V0UG9zaXRpb25CeURhdGUsIHRoaXMpOwoKICAgICAgICAgICAgdGhpcy5hcGkucmVnaXN0ZXJNZXRob2QoJ2RhdGEnLCAnbG9hZCcsIHRoaXMubG9hZERhdGEsIHRoaXMpOwogICAgICAgICAgICB0aGlzLmFwaS5yZWdpc3Rlck1ldGhvZCgnZGF0YScsICdyZW1vdmUnLCB0aGlzLnJlbW92ZURhdGEsIHRoaXMpOwogICAgICAgICAgICB0aGlzLmFwaS5yZWdpc3Rlck1ldGhvZCgnZGF0YScsICdjbGVhcicsIHRoaXMuY2xlYXJEYXRhLCB0aGlzKTsKCiAgICAgICAgICAgIHRoaXMuY2FsZW5kYXIgPSBuZXcgQ2FsZW5kYXIodGhpcyk7CiAgICAgICAgICAgIHRoaXMuY2FsZW5kYXIucmVnaXN0ZXJUaW1lRnJhbWVzKHRoaXMuJHNjb3BlLnRpbWVGcmFtZXMpOwogICAgICAgICAgICB0aGlzLmNhbGVuZGFyLnJlZ2lzdGVyRGF0ZUZyYW1lcyh0aGlzLiRzY29wZS5kYXRlRnJhbWVzKTsKCiAgICAgICAgICAgIHRoaXMuYXBpLnJlZ2lzdGVyTWV0aG9kKCd0aW1lZnJhbWVzJywgJ3JlZ2lzdGVyVGltZUZyYW1lcycsIHRoaXMuY2FsZW5kYXIucmVnaXN0ZXJUaW1lRnJhbWVzLCB0aGlzLmNhbGVuZGFyKTsKICAgICAgICAgICAgdGhpcy5hcGkucmVnaXN0ZXJNZXRob2QoJ3RpbWVmcmFtZXMnLCAnY2xlYXJUaW1lZnJhbWVzJywgdGhpcy5jYWxlbmRhci5jbGVhclRpbWVGcmFtZXMsIHRoaXMuY2FsZW5kYXIpOwogICAgICAgICAgICB0aGlzLmFwaS5yZWdpc3Rlck1ldGhvZCgndGltZWZyYW1lcycsICdyZWdpc3RlckRhdGVGcmFtZXMnLCB0aGlzLmNhbGVuZGFyLnJlZ2lzdGVyRGF0ZUZyYW1lcywgdGhpcy5jYWxlbmRhcik7CiAgICAgICAgICAgIHRoaXMuYXBpLnJlZ2lzdGVyTWV0aG9kKCd0aW1lZnJhbWVzJywgJ2NsZWFyRGF0ZUZyYW1lcycsIHRoaXMuY2FsZW5kYXIuY2xlYXJEYXRlRnJhbWVzLCB0aGlzLmNhbGVuZGFyKTsKICAgICAgICAgICAgdGhpcy5hcGkucmVnaXN0ZXJNZXRob2QoJ3RpbWVmcmFtZXMnLCAncmVnaXN0ZXJUaW1lRnJhbWVNYXBwaW5ncycsIHRoaXMuY2FsZW5kYXIucmVnaXN0ZXJUaW1lRnJhbWVNYXBwaW5ncywgdGhpcy5jYWxlbmRhcik7CiAgICAgICAgICAgIHRoaXMuYXBpLnJlZ2lzdGVyTWV0aG9kKCd0aW1lZnJhbWVzJywgJ2NsZWFyVGltZUZyYW1lTWFwcGluZ3MnLCB0aGlzLmNhbGVuZGFyLmNsZWFyVGltZUZyYW1lTWFwcGluZ3MsIHRoaXMuY2FsZW5kYXIpOwoKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgndGltZUZyYW1lcycsIGZ1bmN0aW9uKG5ld1ZhbHVlcywgb2xkVmFsdWVzKSB7CiAgICAgICAgICAgICAgICBpZiAoIWFuZ3VsYXIuZXF1YWxzKG5ld1ZhbHVlcywgb2xkVmFsdWVzKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FsZW5kYXIuY2xlYXJUaW1lRnJhbWVzKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYWxlbmRhci5yZWdpc3RlclRpbWVGcmFtZXMoJHNjb3BlLnRpbWVGcmFtZXMpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sdW1uc01hbmFnZXIuZ2VuZXJhdGVDb2x1bW5zKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnZGF0ZUZyYW1lcycsIGZ1bmN0aW9uKG5ld1ZhbHVlcywgb2xkVmFsdWVzKSB7CiAgICAgICAgICAgICAgICBpZiAoIWFuZ3VsYXIuZXF1YWxzKG5ld1ZhbHVlcywgb2xkVmFsdWVzKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2FsZW5kYXIuY2xlYXJUaW1lRnJhbWVzKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYWxlbmRhci5yZWdpc3RlclRpbWVGcmFtZXMoJHNjb3BlLnRpbWVGcmFtZXMpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sdW1uc01hbmFnZXIuZ2VuZXJhdGVDb2x1bW5zKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5zY3JvbGwgPSBuZXcgU2Nyb2xsKHRoaXMpOwogICAgICAgICAgICB0aGlzLmJvZHkgPSBuZXcgQm9keSh0aGlzKTsKICAgICAgICAgICAgdGhpcy5yb3dIZWFkZXIgPSBuZXcgUm93SGVhZGVyKHRoaXMpOwogICAgICAgICAgICB0aGlzLmhlYWRlciA9IG5ldyBIZWFkZXIodGhpcyk7CiAgICAgICAgICAgIHRoaXMubGFiZWxzID0gbmV3IExhYmVscyh0aGlzKTsKCiAgICAgICAgICAgIHRoaXMucm93c01hbmFnZXIgPSBuZXcgUm93c01hbmFnZXIodGhpcyk7CiAgICAgICAgICAgIHRoaXMuY29sdW1uc01hbmFnZXIgPSBuZXcgQ29sdW1uc01hbmFnZXIodGhpcyk7CiAgICAgICAgICAgIHRoaXMudGltZXNwYW5zTWFuYWdlciA9IG5ldyBUaW1lc3BhbnNNYW5hZ2VyKHRoaXMpOwogICAgICAgICAgICB0aGlzLmN1cnJlbnREYXRlTWFuYWdlciA9IG5ldyBDdXJyZW50RGF0ZU1hbmFnZXIodGhpcyk7CgogICAgICAgICAgICB0aGlzLm9yaWdpbmFsV2lkdGggPSAwOwogICAgICAgICAgICB0aGlzLndpZHRoID0gMDsKCiAgICAgICAgICAgIHRoaXMuJHNjb3BlLiR3YXRjaCgnZGF0YScsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFhbmd1bGFyLmVxdWFscyhuZXdWYWx1ZSwgb2xkVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jbGVhckRhdGEoKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvYWREYXRhKG5ld1ZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoYW5ndWxhci5pc0Z1bmN0aW9uKHRoaXMuJHNjb3BlLmFwaSkpIHsKICAgICAgICAgICAgICAgIHRoaXMuJHNjb3BlLmFwaSh0aGlzLmFwaSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLyBSZXR1cm5zIHRoZSBleGFjdCBjb2x1bW4gZGF0ZSBhdCB0aGUgZ2l2ZW4gcG9zaXRpb24geCAoaW4gZW0pCiAgICAgICAgR2FudHQucHJvdG90eXBlLmdldERhdGVCeVBvc2l0aW9uID0gZnVuY3Rpb24oeCwgbWFnbmV0KSB7CiAgICAgICAgICAgIHZhciBjb2x1bW4gPSB0aGlzLmNvbHVtbnNNYW5hZ2VyLmdldENvbHVtbkJ5UG9zaXRpb24oeCk7CiAgICAgICAgICAgIGlmIChjb2x1bW4gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbHVtbi5nZXREYXRlQnlQb3NpdGlvbih4IC0gY29sdW1uLmxlZnQsIG1hZ25ldCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gUmV0dXJucyB0aGUgcG9zaXRpb24gaW5zaWRlIHRoZSBHYW50dCBjYWxjdWxhdGVkIGJ5IHRoZSBnaXZlbiBkYXRlCiAgICAgICAgR2FudHQucHJvdG90eXBlLmdldFBvc2l0aW9uQnlEYXRlID0gZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICBpZiAoZGF0ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIW1vbWVudC5pc01vbWVudChtb21lbnQpKSB7CiAgICAgICAgICAgICAgICBkYXRlID0gbW9tZW50KGRhdGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY29sdW1uID0gdGhpcy5jb2x1bW5zTWFuYWdlci5nZXRDb2x1bW5CeURhdGUoZGF0ZSk7CiAgICAgICAgICAgIGlmIChjb2x1bW4gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbHVtbi5nZXRQb3NpdGlvbkJ5RGF0ZShkYXRlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLyBBZGRzIG9yIHVwZGF0ZSByb3dzIGFuZCB0YXNrcy4KICAgICAgICBHYW50dC5wcm90b3R5cGUubG9hZERhdGEgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgIGlmICghYW5ndWxhci5pc0FycmF5KGRhdGEpKSB7CiAgICAgICAgICAgICAgICBkYXRhID0gW2RhdGFdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGRhdGEubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgcm93RGF0YSA9IGRhdGFbaV07CiAgICAgICAgICAgICAgICB0aGlzLnJvd3NNYW5hZ2VyLmFkZFJvdyhyb3dEYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFwaS5kYXRhLnJhaXNlLmxvYWQodGhpcy4kc2NvcGUsIGRhdGEpOwogICAgICAgIH07CgogICAgICAgIC8vIFJlbW92ZXMgc3BlY2lmaWVkIHJvd3Mgb3IgdGFza3MuCiAgICAgICAgLy8gSWYgYSByb3cgaGFzIG5vIHRhc2tzIGluc2lkZSB0aGUgY29tcGxldGUgcm93IHdpbGwgYmUgZGVsZXRlZC4KICAgICAgICBHYW50dC5wcm90b3R5cGUucmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgaWYgKCFhbmd1bGFyLmlzQXJyYXkoZGF0YSkpIHsKICAgICAgICAgICAgICAgIGRhdGEgPSBbZGF0YV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucm93c01hbmFnZXIucmVtb3ZlRGF0YShkYXRhKTsKICAgICAgICAgICAgdGhpcy5hcGkuZGF0YS5yYWlzZS5yZW1vdmUodGhpcy4kc2NvcGUsIGRhdGEpOwogICAgICAgIH07CgogICAgICAgIC8vIFJlbW92ZXMgYWxsIHJvd3MgYW5kIHRhc2tzCiAgICAgICAgR2FudHQucHJvdG90eXBlLmNsZWFyRGF0YSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnJvd3NNYW5hZ2VyLnJlbW92ZUFsbCgpOwogICAgICAgICAgICB0aGlzLmFwaS5kYXRhLnJhaXNlLmNsZWFyKHRoaXMuJHNjb3BlKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gR2FudHQ7CiAgICB9XSk7CgoKZ2FudHQuZmFjdG9yeSgnR2FudHRSb3cnLCBbJ0dhbnR0VGFzaycsICdtb21lbnQnLCAnJGZpbHRlcicsIGZ1bmN0aW9uKFRhc2ssIG1vbWVudCwgJGZpbHRlcikgewogICAgdmFyIFJvdyA9IGZ1bmN0aW9uKGlkLCByb3dzTWFuYWdlciwgbmFtZSwgb3JkZXIsIGhlaWdodCwgY29sb3IsIGNsYXNzZXMsIGRhdGEpIHsKICAgICAgICB0aGlzLmlkID0gaWQ7CiAgICAgICAgdGhpcy5yb3dzTWFuYWdlciA9IHJvd3NNYW5hZ2VyOwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5vcmRlciA9IG9yZGVyOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHRoaXMuY29sb3IgPSBjb2xvcjsKICAgICAgICB0aGlzLmNsYXNzZXMgPSBjbGFzc2VzOwogICAgICAgIHRoaXMuZnJvbSA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLnRvID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMudGFza3NNYXAgPSB7fTsKICAgICAgICB0aGlzLnRhc2tzID0gW107CiAgICAgICAgdGhpcy5maWx0ZXJlZFRhc2tzID0gW107CiAgICAgICAgdGhpcy52aXNpYmxlVGFza3MgPSBbXTsKICAgICAgICB0aGlzLmRhdGEgPSBkYXRhOwogICAgfTsKCiAgICAvLyBBZGRzIGEgdGFzayB0byBhIHNwZWNpZmljIHJvdy4gTWVyZ2VzIHRoZSB0YXNrIGlmIHRoZXJlIGlzIGFscmVhZHkgb25lIHdpdGggdGhlIHNhbWUgaWQKICAgIFJvdy5wcm90b3R5cGUuYWRkVGFzayA9IGZ1bmN0aW9uKHRhc2tEYXRhKSB7CiAgICAgICAgLy8gQ29weSB0byBuZXcgdGFzayAoYWRkKSBvciBtZXJnZSB3aXRoIGV4aXN0aW5nICh1cGRhdGUpCiAgICAgICAgdmFyIHRhc2s7CgogICAgICAgIGlmICh0YXNrRGF0YS5pZCBpbiB0aGlzLnRhc2tzTWFwKSB7CiAgICAgICAgICAgIHRhc2sgPSB0aGlzLnRhc2tzTWFwW3Rhc2tEYXRhLmlkXTsKICAgICAgICAgICAgdGFzay5jb3B5KHRhc2tEYXRhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0YXNrID0gbmV3IFRhc2sodGFza0RhdGEuaWQsIHRoaXMsIHRhc2tEYXRhLm5hbWUsIHRhc2tEYXRhLmNvbG9yLCB0YXNrRGF0YS5jbGFzc2VzLCB0YXNrRGF0YS5wcmlvcml0eSwgdGFza0RhdGEuZnJvbSwgdGFza0RhdGEudG8sIHRhc2tEYXRhLmRhdGEsIHRhc2tEYXRhLmVzdCwgdGFza0RhdGEubGN0LCB0YXNrRGF0YS5wcm9ncmVzcyk7CiAgICAgICAgICAgIHRoaXMudGFza3NNYXBbdGFza0RhdGEuaWRdID0gdGFzazsKICAgICAgICAgICAgdGhpcy50YXNrcy5wdXNoKHRhc2spOwogICAgICAgICAgICB0aGlzLmZpbHRlcmVkVGFza3MucHVzaCh0YXNrKTsKICAgICAgICAgICAgdGhpcy52aXNpYmxlVGFza3MucHVzaCh0YXNrKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc29ydFRhc2tzKCk7CiAgICAgICAgdGhpcy5zZXRGcm9tVG9CeVRhc2sodGFzayk7CiAgICAgICAgdGhpcy5yb3dzTWFuYWdlci5nYW50dC5hcGkudGFza3MucmFpc2UuYWRkKHRhc2spOwogICAgICAgIHJldHVybiB0YXNrOwogICAgfTsKCiAgICAvLyBSZW1vdmVzIHRoZSB0YXNrIGZyb20gdGhlIGV4aXN0aW5nIHJvdyBhbmQgYWRkcyBpdCB0byBoZSBjdXJyZW50IG9uZQogICAgUm93LnByb3RvdHlwZS5tb3ZlVGFza1RvUm93ID0gZnVuY3Rpb24odGFzaykgewogICAgICAgIHZhciBvbGRSb3cgPSB0YXNrLnJvdzsKICAgICAgICBvbGRSb3cucmVtb3ZlVGFzayh0YXNrLmlkLCB0cnVlKTsKICAgICAgICBvbGRSb3cudXBkYXRlVmlzaWJsZVRhc2tzKCk7CgogICAgICAgIHRoaXMudGFza3NNYXBbdGFzay5pZF0gPSB0YXNrOwogICAgICAgIHRoaXMudGFza3MucHVzaCh0YXNrKTsKICAgICAgICB0aGlzLmZpbHRlcmVkVGFza3MucHVzaCh0YXNrKTsKICAgICAgICB0aGlzLnZpc2libGVUYXNrcy5wdXNoKHRhc2spOwogICAgICAgIHRhc2sucm93ID0gdGhpczsKCiAgICAgICAgdGhpcy5zb3J0VGFza3MoKTsKICAgICAgICB0aGlzLnNldEZyb21Ub0J5VGFzayh0YXNrKTsKCiAgICAgICAgdGFzay51cGRhdGVQb3NBbmRTaXplKCk7CiAgICAgICAgdGhpcy51cGRhdGVWaXNpYmxlVGFza3MoKTsKCiAgICAgICAgdGhpcy5yb3dzTWFuYWdlci5nYW50dC5hcGkudGFza3MucmFpc2UubW92ZSh0YXNrLCBvbGRSb3cpOwoKICAgIH07CgogICAgUm93LnByb3RvdHlwZS51cGRhdGVWaXNpYmxlVGFza3MgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5yb3dzTWFuYWdlci5nYW50dC4kc2NvcGUuZmlsdGVyVGFzaykgewogICAgICAgICAgICB0aGlzLmZpbHRlcmVkVGFza3MgPSAkZmlsdGVyKCdmaWx0ZXInKSh0aGlzLnRhc2tzLCB0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LiRzY29wZS5maWx0ZXJUYXNrLCB0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LiRzY29wZS5maWx0ZXJUYXNrQ29tcGFyYXRvcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5maWx0ZXJlZFRhc2tzID0gdGhpcy50YXNrcy5zbGljZSgwKTsKICAgICAgICB9CiAgICAgICAgdGhpcy52aXNpYmxlVGFza3MgPSAkZmlsdGVyKCdnYW50dFRhc2tMaW1pdCcpKHRoaXMuZmlsdGVyZWRUYXNrcywgdGhpcy5yb3dzTWFuYWdlci5nYW50dCk7CiAgICB9OwoKICAgIFJvdy5wcm90b3R5cGUudXBkYXRlVGFza3NQb3NBbmRTaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaiA9IDAsIGsgPSB0aGlzLnRhc2tzLmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICB0aGlzLnRhc2tzW2pdLnVwZGF0ZVBvc0FuZFNpemUoKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIFJlbW92ZSB0aGUgc3BlY2lmaWVkIHRhc2sgZnJvbSB0aGUgcm93CiAgICBSb3cucHJvdG90eXBlLnJlbW92ZVRhc2sgPSBmdW5jdGlvbih0YXNrSWQsIGRpc2FibGVFbWl0KSB7CiAgICAgICAgaWYgKHRhc2tJZCBpbiB0aGlzLnRhc2tzTWFwKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnRhc2tzTWFwW3Rhc2tJZF07IC8vIFJlbW92ZSBmcm9tIG1hcAoKICAgICAgICAgICAgdmFyIHRhc2s7CiAgICAgICAgICAgIHZhciByZW1vdmVkVGFzazsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMudGFza3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIHRhc2sgPSB0aGlzLnRhc2tzW2ldOwogICAgICAgICAgICAgICAgaWYgKHRhc2suaWQgPT09IHRhc2tJZCkgewogICAgICAgICAgICAgICAgICAgIHJlbW92ZWRUYXNrID0gdGFzazsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRhc2tzLnNwbGljZShpLCAxKTsgLy8gUmVtb3ZlIGZyb20gYXJyYXkKCiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIGVhcmxpZXN0IG9yIGxhdGVzdCBkYXRlIGluZm8gYXMgdGhpcyBtYXkgY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZnJvbSAtIHRhc2suZnJvbSA9PT0gMCB8fCB0aGlzLnRvIC0gdGFzay50byA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEZyb21UbygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gdGhpcy5maWx0ZXJlZFRhc2tzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0YXNrID0gdGhpcy5maWx0ZXJlZFRhc2tzW2ldOwogICAgICAgICAgICAgICAgaWYgKHRhc2suaWQgPT09IHRhc2tJZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyZWRUYXNrcy5zcGxpY2UoaSwgMSk7IC8vIFJlbW92ZSBmcm9tIGZpbHRlcmVkIGFycmF5CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaSA9IHRoaXMudmlzaWJsZVRhc2tzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB0YXNrID0gdGhpcy52aXNpYmxlVGFza3NbaV07CiAgICAgICAgICAgICAgICBpZiAodGFzay5pZCA9PT0gdGFza0lkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aXNpYmxlVGFza3Muc3BsaWNlKGksIDEpOyAvLyBSZW1vdmUgZnJvbSB2aXNpYmxlIGFycmF5CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghZGlzYWJsZUVtaXQpIHsKICAgICAgICAgICAgICAgIHRoaXMucm93c01hbmFnZXIuZ2FudHQuYXBpLnRhc2tzLnJhaXNlLnJlbW92ZShyZW1vdmVkVGFzayk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZW1vdmVkVGFzazsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIENhbGN1bGF0ZSB0aGUgZWFybGllc3QgZnJvbSBhbmQgbGF0ZXN0IHRvIGRhdGUgb2YgYWxsIHRhc2tzIGluIGEgcm93CiAgICBSb3cucHJvdG90eXBlLnNldEZyb21UbyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZnJvbSA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLnRvID0gdW5kZWZpbmVkOwogICAgICAgIGZvciAodmFyIGogPSAwLCBrID0gdGhpcy50YXNrcy5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgdGhpcy5zZXRGcm9tVG9CeVRhc2sodGhpcy50YXNrc1tqXSk7CiAgICAgICAgfQogICAgfTsKCiAgICBSb3cucHJvdG90eXBlLnNldEZyb21Ub0J5VGFzayA9IGZ1bmN0aW9uKHRhc2spIHsKICAgICAgICBpZiAodGhpcy5mcm9tID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy5mcm9tID0gbW9tZW50KHRhc2suZnJvbSk7CiAgICAgICAgfSBlbHNlIGlmICh0YXNrLmZyb20gPCB0aGlzLmZyb20pIHsKICAgICAgICAgICAgdGhpcy5mcm9tID0gbW9tZW50KHRhc2suZnJvbSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy50byA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRoaXMudG8gPSBtb21lbnQodGFzay50byk7CiAgICAgICAgfSBlbHNlIGlmICh0YXNrLnRvID4gdGhpcy50bykgewogICAgICAgICAgICB0aGlzLnRvID0gbW9tZW50KHRhc2sudG8pOwogICAgICAgIH0KICAgIH07CgogICAgUm93LnByb3RvdHlwZS5zb3J0VGFza3MgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnRhc2tzLnNvcnQoZnVuY3Rpb24odDEsIHQyKSB7CiAgICAgICAgICAgIHJldHVybiB0MS5sZWZ0IC0gdDIubGVmdDsKICAgICAgICB9KTsKICAgIH07CgogICAgUm93LnByb3RvdHlwZS5jb3B5ID0gZnVuY3Rpb24ocm93KSB7CiAgICAgICAgdGhpcy5uYW1lID0gcm93Lm5hbWU7CiAgICAgICAgdGhpcy5oZWlnaHQgPSByb3cuaGVpZ2h0OwogICAgICAgIHRoaXMuY29sb3IgPSByb3cuY29sb3I7CiAgICAgICAgdGhpcy5jbGFzc2VzID0gcm93LmNsYXNzZXM7CiAgICAgICAgdGhpcy5kYXRhID0gcm93LmRhdGE7CgogICAgICAgIGlmIChyb3cub3JkZXIgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aGlzLm9yZGVyID0gcm93Lm9yZGVyOwogICAgICAgIH0KICAgIH07CgogICAgUm93LnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjbG9uZSA9IG5ldyBSb3codGhpcy5pZCwgdGhpcy5yb3dzTWFuYWdlciwgdGhpcy5uYW1lLCB0aGlzLm9yZGVyLCB0aGlzLmhlaWdodCwgdGhpcy5jb2xvciwgdGhpcy5jbGFzc2VzLCB0aGlzLmRhdGEpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy50YXNrcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgY2xvbmUuYWRkVGFzayh0aGlzLnRhc2tzW2ldLmNsb25lKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY2xvbmU7CiAgICB9OwoKICAgIHJldHVybiBSb3c7Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdHYW50dFJvd0hlYWRlcicsIFtmdW5jdGlvbigpIHsKICAgIHZhciBSb3dIZWFkZXIgPSBmdW5jdGlvbihnYW50dCkgewogICAgICAgIHRoaXMuZ2FudHQgPSBnYW50dDsKICAgIH07CiAgICByZXR1cm4gUm93SGVhZGVyOwp9XSk7CgoKZ2FudHQuZmFjdG9yeSgnR2FudHRSb3dzTWFuYWdlcicsIFsnR2FudHRSb3cnLCAnJGZpbHRlcicsICdtb21lbnQnLCBmdW5jdGlvbihSb3csICRmaWx0ZXIsIG1vbWVudCkgewogICAgdmFyIFJvd3NNYW5hZ2VyID0gZnVuY3Rpb24oZ2FudHQpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHRoaXMuZ2FudHQgPSBnYW50dDsKCiAgICAgICAgdGhpcy5yb3dzTWFwID0ge307CiAgICAgICAgdGhpcy5yb3dzID0gW107CiAgICAgICAgdGhpcy5maWx0ZXJlZFJvd3MgPSBbXTsKICAgICAgICB0aGlzLnZpc2libGVSb3dzID0gW107CgogICAgICAgIHRoaXMuZ2FudHQuJHNjb3BlLiR3YXRjaEdyb3VwKFsnc2Nyb2xsTGVmdCcsICdzY3JvbGxXaWR0aCddLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi51cGRhdGVWaXNpYmxlVGFza3MoKTsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5nYW50dC4kc2NvcGUuJHdhdGNoR3JvdXAoWydmaWx0ZXJUYXNrJywgJ2ZpbHRlclRhc2tDb21wYXJhdG9yJ10sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzZWxmLnVwZGF0ZVZpc2libGVUYXNrcygpOwogICAgICAgIH0pOwoKICAgICAgICB0aGlzLmdhbnR0LiRzY29wZS4kd2F0Y2hHcm91cChbJ2ZpbHRlclJvdycsICdmaWx0ZXJSb3dDb21wYXJhdG9yJ10sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzZWxmLnVwZGF0ZVZpc2libGVSb3dzKCk7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuZ2FudHQuJHNjb3BlLiR3YXRjaCgnc29ydE1vZGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi5zb3J0Um93cygpOwogICAgICAgIH0pOwoKICAgICAgICB0aGlzLnVwZGF0ZVZpc2libGVPYmplY3RzKCk7CgogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyTWV0aG9kKCdyb3dzJywgJ3NvcnQnLCBSb3dzTWFuYWdlci5wcm90b3R5cGUuc29ydFJvd3MsIHRoaXMpOwogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyTWV0aG9kKCdyb3dzJywgJ3N3YXAnLCBSb3dzTWFuYWdlci5wcm90b3R5cGUuc3dhcFJvd3MsIHRoaXMpOwoKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3RlckV2ZW50KCd0YXNrcycsICdhZGQnKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3RlckV2ZW50KCd0YXNrcycsICdjaGFuZ2UnKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3RlckV2ZW50KCd0YXNrcycsICdyZW1vdmUnKTsKCiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJFdmVudCgndGFza3MnLCAnZmlsdGVyJyk7CgogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyRXZlbnQoJ3Jvd3MnLCAnYWRkJyk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJFdmVudCgncm93cycsICdjaGFuZ2UnKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3RlckV2ZW50KCdyb3dzJywgJ3JlbW92ZScpOwogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyRXZlbnQoJ3Jvd3MnLCAnb3JkZXJDaGFuZ2UnKTsKCiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJFdmVudCgncm93cycsICdmaWx0ZXInKTsKCiAgICB9OwoKICAgIFJvd3NNYW5hZ2VyLnByb3RvdHlwZS5hZGRSb3cgPSBmdW5jdGlvbihyb3dEYXRhKSB7CiAgICAgICAgLy8gQ29weSB0byBuZXcgcm93IChhZGQpIG9yIG1lcmdlIHdpdGggZXhpc3RpbmcgKHVwZGF0ZSkKICAgICAgICB2YXIgcm93LCBpc1VwZGF0ZSA9IGZhbHNlOwoKICAgICAgICBpZiAocm93RGF0YS5pZCBpbiB0aGlzLnJvd3NNYXApIHsKICAgICAgICAgICAgcm93ID0gdGhpcy5yb3dzTWFwW3Jvd0RhdGEuaWRdOwogICAgICAgICAgICByb3cuY29weShyb3dEYXRhKTsKICAgICAgICAgICAgaXNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmdhbnR0LmFwaS5yb3dzLnJhaXNlLmNoYW5nZShyb3cpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBvcmRlciA9IHJvd0RhdGEub3JkZXI7CgogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgcm93IGhhcyBhIG9yZGVyIHByZWRlZmluZWQuIElmIG5vdCBhc3NpZ24gb25lCiAgICAgICAgICAgIGlmIChvcmRlciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBvcmRlciA9IHRoaXMuaGlnaGVzdFJvd09yZGVyOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3JkZXIgPj0gdGhpcy5oaWdoZXN0Um93T3JkZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlnaGVzdFJvd09yZGVyID0gb3JkZXIgKyAxOwogICAgICAgICAgICB9CgogICAgICAgICAgICByb3cgPSBuZXcgUm93KHJvd0RhdGEuaWQsIHRoaXMsIHJvd0RhdGEubmFtZSwgb3JkZXIsIHJvd0RhdGEuaGVpZ2h0LCByb3dEYXRhLmNvbG9yLCByb3dEYXRhLmNsYXNzZXMsIHJvd0RhdGEuZGF0YSk7CiAgICAgICAgICAgIHRoaXMucm93c01hcFtyb3dEYXRhLmlkXSA9IHJvdzsKICAgICAgICAgICAgdGhpcy5yb3dzLnB1c2gocm93KTsKICAgICAgICAgICAgdGhpcy5maWx0ZXJlZFJvd3MucHVzaChyb3cpOwogICAgICAgICAgICB0aGlzLnZpc2libGVSb3dzLnB1c2gocm93KTsKICAgICAgICAgICAgdGhpcy5nYW50dC5hcGkucm93cy5yYWlzZS5hZGQocm93KTsKICAgICAgICB9CgogICAgICAgIGlmIChyb3dEYXRhLnRhc2tzICE9PSB1bmRlZmluZWQgJiYgcm93RGF0YS50YXNrcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gcm93RGF0YS50YXNrcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIHJvdy5hZGRUYXNrKHJvd0RhdGEudGFza3NbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBpc1VwZGF0ZTsKICAgIH07CgogICAgUm93c01hbmFnZXIucHJvdG90eXBlLnJlbW92ZVJvdyA9IGZ1bmN0aW9uKHJvd0lkKSB7CiAgICAgICAgaWYgKHJvd0lkIGluIHRoaXMucm93c01hcCkgewogICAgICAgICAgICBkZWxldGUgdGhpcy5yb3dzTWFwW3Jvd0lkXTsgLy8gUmVtb3ZlIGZyb20gbWFwCgogICAgICAgICAgICB2YXIgcmVtb3ZlZFJvdzsKICAgICAgICAgICAgdmFyIHJvdzsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMucm93cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgcm93ID0gdGhpcy5yb3dzW2ldOwogICAgICAgICAgICAgICAgaWYgKHJvdy5pZCA9PT0gcm93SWQpIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVkUm93ID0gcm93OwogICAgICAgICAgICAgICAgICAgIHRoaXMucm93cy5zcGxpY2UoaSwgMSk7IC8vIFJlbW92ZSBmcm9tIGFycmF5CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaSA9IHRoaXMuZmlsdGVyZWRSb3dzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICByb3cgPSB0aGlzLmZpbHRlcmVkUm93c1tpXTsKICAgICAgICAgICAgICAgIGlmIChyb3cuaWQgPT09IHJvd0lkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJlZFJvd3Muc3BsaWNlKGksIDEpOyAvLyBSZW1vdmUgZnJvbSBmaWx0ZXJlZCBhcnJheQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKGkgPSB0aGlzLnZpc2libGVSb3dzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICByb3cgPSB0aGlzLnZpc2libGVSb3dzW2ldOwogICAgICAgICAgICAgICAgaWYgKHJvdy5pZCA9PT0gcm93SWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpc2libGVSb3dzLnNwbGljZShpLCAxKTsgLy8gUmVtb3ZlIGZyb20gdmlzaWJsZSBhcnJheQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmdhbnR0LmFwaS5yb3dzLnJhaXNlLnJlbW92ZShyZW1vdmVkUm93KTsKICAgICAgICAgICAgcmV0dXJuIHJvdzsKICAgICAgICB9CgogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9OwoKICAgIFJvd3NNYW5hZ2VyLnByb3RvdHlwZS5yZW1vdmVEYXRhID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gZGF0YS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdmFyIHJvd0RhdGEgPSBkYXRhW2ldOwogICAgICAgICAgICB2YXIgcm93OwoKICAgICAgICAgICAgaWYgKHJvd0RhdGEudGFza3MgIT09IHVuZGVmaW5lZCAmJiByb3dEYXRhLnRhc2tzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIC8vIE9ubHkgZGVsZXRlIHRoZSBzcGVjaWZpZWQgdGFza3MgYnV0IG5vdCB0aGUgcm93IGFuZCB0aGUgb3RoZXIgdGFza3MKCiAgICAgICAgICAgICAgICBpZiAocm93RGF0YS5pZCBpbiB0aGlzLnJvd3NNYXApIHsKICAgICAgICAgICAgICAgICAgICByb3cgPSB0aGlzLnJvd3NNYXBbcm93RGF0YS5pZF07CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBrID0gcm93RGF0YS50YXNrcy5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgcm93LnJlbW92ZVRhc2socm93RGF0YS50YXNrc1tqXS5pZCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbnR0LmFwaS5yb3dzLnJhaXNlLmNoYW5nZShyb3cpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRGVsZXRlIHRoZSBjb21wbGV0ZSByb3cKICAgICAgICAgICAgICAgIHJvdyA9IHRoaXMucmVtb3ZlUm93KHJvd0RhdGEuaWQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMudXBkYXRlVmlzaWJsZU9iamVjdHMoKTsKICAgIH07CgogICAgUm93c01hbmFnZXIucHJvdG90eXBlLnJlbW92ZUFsbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucm93c01hcCA9IHt9OwogICAgICAgIHRoaXMucm93cyA9IFtdOwogICAgICAgIHRoaXMuZmlsdGVyZWRSb3dzID0gW107CiAgICAgICAgdGhpcy52aXNpYmxlUm93cyA9IFtdOwogICAgfTsKCiAgICBSb3dzTWFuYWdlci5wcm90b3R5cGUuc29ydFJvd3MgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IHRoaXMuZ2FudHQuJHNjb3BlLnNvcnRNb2RlOwoKICAgICAgICB2YXIgcmV2ZXJzZSA9IGZhbHNlOwogICAgICAgIGlmIChleHByZXNzaW9uLmNoYXJBdCgwKSA9PT0gJy0nKSB7CiAgICAgICAgICAgIHJldmVyc2UgPSB0cnVlOwogICAgICAgICAgICBleHByZXNzaW9uID0gZXhwcmVzc2lvbi5zdWJzdHIoMSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgYW5ndWxhck9yZGVyQnkgPSAkZmlsdGVyKCdvcmRlckJ5Jyk7CiAgICAgICAgaWYgKGV4cHJlc3Npb24gPT09ICdjdXN0b20nKSB7CiAgICAgICAgICAgIHRoaXMucm93cyA9IGFuZ3VsYXJPcmRlckJ5KHRoaXMucm93cywgJ29yZGVyJywgcmV2ZXJzZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5yb3dzID0gYW5ndWxhck9yZGVyQnkodGhpcy5yb3dzLCBleHByZXNzaW9uLCByZXZlcnNlKTsKICAgICAgICB9CgogICAgICAgIHRoaXMudXBkYXRlVmlzaWJsZVJvd3MoKTsKICAgIH07CgogICAgLy8gU3dhcHMgdHdvIHJvd3MgYW5kIGNoYW5nZXMgdGhlIHNvcnQgb3JkZXIgdG8gY3VzdG9tIHRvIGRpc3BsYXkgdGhlIHN3YXBwZWQgcm93cwogICAgUm93c01hbmFnZXIucHJvdG90eXBlLnN3YXBSb3dzID0gZnVuY3Rpb24oYSwgYikgewogICAgICAgIC8vIFN3YXAgdGhlIHR3byByb3dzCiAgICAgICAgdmFyIG9yZGVyID0gYS5vcmRlcjsKICAgICAgICBhLm9yZGVyID0gYi5vcmRlcjsKICAgICAgICBiLm9yZGVyID0gb3JkZXI7CgogICAgICAgIC8vIFJhaXNlIGNoYW5nZSBldmVudHMKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yb3dzLnJhaXNlLmNoYW5nZShhKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yb3dzLnJhaXNlLm9yZGVyQ2hhbmdlKGEpOwogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJvd3MucmFpc2UuY2hhbmdlKGIpOwogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJvd3MucmFpc2Uub3JkZXJDaGFuZ2UoYik7CgogICAgICAgIC8vIFN3aXRjaCB0byBjdXN0b20gc29ydCBtb2RlIGFuZCB0cmlnZ2VyIHNvcnQKICAgICAgICBpZiAodGhpcy5nYW50dC4kc2NvcGUuc29ydE1vZGUgIT09ICdjdXN0b20nKSB7CiAgICAgICAgICAgIHRoaXMuZ2FudHQuJHNjb3BlLnNvcnRNb2RlID0gJ2N1c3RvbSc7IC8vIFNvcnQgd2lsbCBiZSB0cmlnZ2VyZWQgYnkgdGhlIHdhdGNoZXIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNvcnRSb3dzKCk7CiAgICAgICAgfQogICAgfTsKCiAgICBSb3dzTWFuYWdlci5wcm90b3R5cGUudXBkYXRlVmlzaWJsZU9iamVjdHMgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnVwZGF0ZVZpc2libGVSb3dzKCk7CiAgICAgICAgdGhpcy51cGRhdGVWaXNpYmxlVGFza3MoKTsKICAgIH07CgogICAgUm93c01hbmFnZXIucHJvdG90eXBlLnVwZGF0ZVZpc2libGVSb3dzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG9sZEZpbHRlcmVkUm93cyA9IHRoaXMuZmlsdGVyZWRSb3dzOwogICAgICAgIGlmICh0aGlzLmdhbnR0LiRzY29wZS5maWx0ZXJSb3cpIHsKICAgICAgICAgICAgdGhpcy5maWx0ZXJlZFJvd3MgPSAkZmlsdGVyKCdmaWx0ZXInKSh0aGlzLnJvd3MsIHRoaXMuZ2FudHQuJHNjb3BlLmZpbHRlclJvdywgdGhpcy5nYW50dC4kc2NvcGUuZmlsdGVyUm93Q29tcGFyYXRvcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5maWx0ZXJlZFJvd3MgPSB0aGlzLnJvd3Muc2xpY2UoMCk7CiAgICAgICAgfQoKCiAgICAgICAgdmFyIHJhaXNlRXZlbnQgPSAhYW5ndWxhci5lcXVhbHMob2xkRmlsdGVyZWRSb3dzLCB0aGlzLmZpbHRlcmVkUm93cyk7CgogICAgICAgIC8vIFRPRE86IEltcGxlbWVudCByb3dMaW1pdCBsaWtlIGNvbHVtbkxpbWl0IHRvIGVuaGFuY2UgcGVyZm9ybWFuY2UgZm9yIGdhbnR0IHdpdGggbWFueSByb3dzCiAgICAgICAgdGhpcy52aXNpYmxlUm93cyA9IHRoaXMuZmlsdGVyZWRSb3dzOwogICAgICAgIGlmIChyYWlzZUV2ZW50KSB7CiAgICAgICAgICAgIHRoaXMuZ2FudHQuYXBpLnJvd3MucmFpc2UuZmlsdGVyKHRoaXMucm93cywgdGhpcy5maWx0ZXJlZFJvd3MpOwogICAgICAgIH0KICAgIH07CgogICAgUm93c01hbmFnZXIucHJvdG90eXBlLnVwZGF0ZVZpc2libGVUYXNrcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBvbGRGaWx0ZXJlZFRhc2tzID0gW107CiAgICAgICAgdmFyIGZpbHRlcmVkVGFza3MgPSBbXTsKICAgICAgICB2YXIgdGFza3MgPSBbXTsKCiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRoaXMuZmlsdGVyZWRSb3dzLCBmdW5jdGlvbihyb3cpIHsKICAgICAgICAgICAgb2xkRmlsdGVyZWRUYXNrcyA9IG9sZEZpbHRlcmVkVGFza3MuY29uY2F0KHJvdy5maWx0ZXJlZFRhc2tzKTsKICAgICAgICAgICAgcm93LnVwZGF0ZVZpc2libGVUYXNrcygpOwogICAgICAgICAgICBmaWx0ZXJlZFRhc2tzID0gZmlsdGVyZWRUYXNrcy5jb25jYXQocm93LmZpbHRlcmVkVGFza3MpOwogICAgICAgICAgICB0YXNrcyA9IHRhc2tzLmNvbmNhdChyb3cudGFza3MpOwogICAgICAgIH0pOwoKICAgICAgICB2YXIgZmlsdGVyRXZlbnQgPSAhYW5ndWxhci5lcXVhbHMob2xkRmlsdGVyZWRUYXNrcywgZmlsdGVyZWRUYXNrcyk7CgogICAgICAgIGlmIChmaWx0ZXJFdmVudCkgewogICAgICAgICAgICB0aGlzLmdhbnR0LmFwaS50YXNrcy5yYWlzZS5maWx0ZXIodGFza3MsIGZpbHRlcmVkVGFza3MpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gVXBkYXRlIHRoZSBwb3NpdGlvbi9zaXplIG9mIGFsbCB0YXNrcyBpbiB0aGUgR2FudHQKICAgIFJvd3NNYW5hZ2VyLnByb3RvdHlwZS51cGRhdGVUYXNrc1Bvc0FuZFNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMucm93cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5yb3dzW2ldLnVwZGF0ZVRhc2tzUG9zQW5kU2l6ZSgpOwogICAgICAgIH0KICAgIH07CgogICAgUm93c01hbmFnZXIucHJvdG90eXBlLmdldEV4cGFuZGVkRnJvbSA9IGZ1bmN0aW9uKGZyb20pIHsKICAgICAgICBmcm9tID0gZnJvbSA/IG1vbWVudChmcm9tKSA6IGZyb207CgogICAgICAgIHZhciBtaW5Sb3dGcm9tID0gZnJvbTsKICAgICAgICBhbmd1bGFyLmZvckVhY2godGhpcy5yb3dzLCBmdW5jdGlvbihyb3cpIHsKICAgICAgICAgICAgaWYgKG1pblJvd0Zyb20gPT09IHVuZGVmaW5lZCB8fCBtaW5Sb3dGcm9tID4gcm93LmZyb20pIHsKICAgICAgICAgICAgICAgIG1pblJvd0Zyb20gPSByb3cuZnJvbTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmIChtaW5Sb3dGcm9tICYmICghZnJvbSB8fCBtaW5Sb3dGcm9tIDwgZnJvbSkpIHsKICAgICAgICAgICAgcmV0dXJuIG1pblJvd0Zyb207CiAgICAgICAgfQogICAgICAgIHJldHVybiBmcm9tOwogICAgfTsKCiAgICBSb3dzTWFuYWdlci5wcm90b3R5cGUuZ2V0RXhwYW5kZWRUbyA9IGZ1bmN0aW9uKHRvKSB7CiAgICAgICAgdG8gPSB0byA/IG1vbWVudCh0bykgOiB0bzsKCiAgICAgICAgdmFyIG1heFJvd1RvID0gdG87CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRoaXMucm93cywgZnVuY3Rpb24ocm93KSB7CiAgICAgICAgICAgIGlmIChtYXhSb3dUbyA9PT0gdW5kZWZpbmVkIHx8IG1heFJvd1RvIDwgcm93LnRvKSB7CiAgICAgICAgICAgICAgICBtYXhSb3dUbyA9IHJvdy50bzsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmIChtYXhSb3dUbyAmJiAoIXRoaXMuZ2FudHQuJHNjb3BlLnRvRGF0ZSB8fCBtYXhSb3dUbyA+IHRoaXMuZ2FudHQuJHNjb3BlLnRvRGF0ZSkpIHsKICAgICAgICAgICAgcmV0dXJuIG1heFJvd1RvOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG87CiAgICB9OwoKICAgIFJvd3NNYW5hZ2VyLnByb3RvdHlwZS5nZXREZWZhdWx0RnJvbSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBkZWZhdWx0RnJvbTsKICAgICAgICBhbmd1bGFyLmZvckVhY2godGhpcy5yb3dzLCBmdW5jdGlvbihyb3cpIHsKICAgICAgICAgICAgaWYgKGRlZmF1bHRGcm9tID09PSB1bmRlZmluZWQgfHwgcm93LmZyb20gPCBkZWZhdWx0RnJvbSkgewogICAgICAgICAgICAgICAgZGVmYXVsdEZyb20gPSByb3cuZnJvbTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBkZWZhdWx0RnJvbTsKICAgIH07CgogICAgUm93c01hbmFnZXIucHJvdG90eXBlLmdldERlZmF1bHRUbyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBkZWZhdWx0VG87CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRoaXMucm93cywgZnVuY3Rpb24ocm93KSB7CiAgICAgICAgICAgIGlmIChkZWZhdWx0VG8gPT09IHVuZGVmaW5lZCB8fCByb3cudG8gPiBkZWZhdWx0VG8pIHsKICAgICAgICAgICAgICAgIGRlZmF1bHRUbyA9IHJvdy50bzsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBkZWZhdWx0VG87CiAgICB9OwoKICAgIHJldHVybiBSb3dzTWFuYWdlcjsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0VGFzaycsIFsnbW9tZW50JywgJ0dhbnR0VGFza1Byb2dyZXNzJywgZnVuY3Rpb24obW9tZW50LCBUYXNrUHJvZ3Jlc3MpIHsKICAgIHZhciBUYXNrID0gZnVuY3Rpb24oaWQsIHJvdywgbmFtZSwgY29sb3IsIGNsYXNzZXMsIHByaW9yaXR5LCBmcm9tLCB0bywgZGF0YSwgZXN0LCBsY3QsIHByb2dyZXNzKSB7CiAgICAgICAgdGhpcy5pZCA9IGlkOwogICAgICAgIHRoaXMucm93c01hbmFnZXIgPSByb3cucm93c01hbmFnZXI7CiAgICAgICAgdGhpcy5yb3cgPSByb3c7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLmNvbG9yID0gY29sb3I7CiAgICAgICAgdGhpcy5jbGFzc2VzID0gY2xhc3NlczsKICAgICAgICB0aGlzLnByaW9yaXR5ID0gcHJpb3JpdHk7CiAgICAgICAgdGhpcy5mcm9tID0gbW9tZW50KGZyb20pOwogICAgICAgIHRoaXMudG8gPSBtb21lbnQodG8pOwogICAgICAgIHRoaXMudHJ1bmNhdGVkTGVmdCA9IGZhbHNlOwogICAgICAgIHRoaXMudHJ1bmNhdGVkUmlnaHQgPSBmYWxzZTsKICAgICAgICB0aGlzLmRhdGEgPSBkYXRhOwoKICAgICAgICBpZiAocHJvZ3Jlc3MgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBpZiAodHlwZW9mIHByb2dyZXNzID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgdGhpcy5wcm9ncmVzcyA9IG5ldyBUYXNrUHJvZ3Jlc3ModGhpcywgcHJvZ3Jlc3MucGVyY2VudCwgcHJvZ3Jlc3MuY29sb3IsIHByb2dyZXNzLmNsYXNzZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5wcm9ncmVzcyA9IG5ldyBUYXNrUHJvZ3Jlc3ModGhpcywgcHJvZ3Jlc3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoZXN0ICE9PSB1bmRlZmluZWQgJiYgbGN0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy5lc3QgPSBtb21lbnQoZXN0KTsgIC8vRWFybGllc3QgU3RhcnQgVGltZQogICAgICAgICAgICB0aGlzLmxjdCA9IG1vbWVudChsY3QpOyAgLy9MYXRlc3QgQ29tcGxldGlvbiBUaW1lCiAgICAgICAgfQoKICAgICAgICB0aGlzLl9mcm9tTGFiZWwgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5fdG9MYWJlbCA9IHVuZGVmaW5lZDsKICAgIH07CgoKICAgIFRhc2sucHJvdG90eXBlLmdldEZyb21MYWJlbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLl9mcm9tTGFiZWwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aGlzLl9mcm9tTGFiZWwgPSB0aGlzLmZyb20uZm9ybWF0KHRoaXMucm93c01hbmFnZXIuZ2FudHQuJHNjb3BlLnRvb2x0aXBEYXRlRm9ybWF0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuX2Zyb21MYWJlbDsKICAgIH07CgogICAgVGFzay5wcm90b3R5cGUuZ2V0VG9MYWJlbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLl90b0xhYmVsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy5fdG9MYWJlbCA9IHRoaXMudG8uZm9ybWF0KHRoaXMucm93c01hbmFnZXIuZ2FudHQuJHNjb3BlLnRvb2x0aXBEYXRlRm9ybWF0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuX3RvTGFiZWw7CiAgICB9OwoKICAgIFRhc2sucHJvdG90eXBlLmNoZWNrSWZNaWxlc3RvbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmlzTWlsZXN0b25lID0gdGhpcy5mcm9tIC0gdGhpcy50byA9PT0gMDsKICAgIH07CgogICAgVGFzay5wcm90b3R5cGUuY2hlY2tJZk1pbGVzdG9uZSgpOwoKICAgIC8vIFVwZGF0ZXMgdGhlIHBvcyBhbmQgc2l6ZSBvZiB0aGUgdGFzayBhY2NvcmRpbmcgdG8gdGhlIGZyb20gLSB0byBkYXRlCiAgICBUYXNrLnByb3RvdHlwZS51cGRhdGVQb3NBbmRTaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5tb2RlbExlZnQgPSB0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LmdldFBvc2l0aW9uQnlEYXRlKHRoaXMuZnJvbSk7CiAgICAgICAgdGhpcy5tb2RlbFdpZHRoID0gdGhpcy5yb3dzTWFuYWdlci5nYW50dC5nZXRQb3NpdGlvbkJ5RGF0ZSh0aGlzLnRvKSAtIHRoaXMubW9kZWxMZWZ0OwoKICAgICAgICB0aGlzLm91dE9mUmFuZ2UgPSB0aGlzLm1vZGVsTGVmdCArIHRoaXMubW9kZWxXaWR0aCA8IDAgfHwgdGhpcy5tb2RlbExlZnQgPiB0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LndpZHRoOwoKICAgICAgICB0aGlzLmxlZnQgPSBNYXRoLm1pbihNYXRoLm1heCh0aGlzLm1vZGVsTGVmdCwgMCksIHRoaXMucm93c01hbmFnZXIuZ2FudHQud2lkdGgpOwogICAgICAgIGlmICh0aGlzLm1vZGVsTGVmdCA8IDApIHsKICAgICAgICAgICAgdGhpcy50cnVuY2F0ZWRMZWZ0ID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHRoaXMubW9kZWxXaWR0aCArIHRoaXMubW9kZWxMZWZ0ID4gdGhpcy5yb3dzTWFuYWdlci5nYW50dC53aWR0aCkgewogICAgICAgICAgICAgICAgdGhpcy50cnVuY2F0ZWRSaWdodCA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5yb3dzTWFuYWdlci5nYW50dC53aWR0aDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMudHJ1bmNhdGVkUmlnaHQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMud2lkdGggPSB0aGlzLm1vZGVsV2lkdGggKyB0aGlzLm1vZGVsTGVmdDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAodGhpcy5tb2RlbFdpZHRoICsgdGhpcy5tb2RlbExlZnQgPiB0aGlzLnJvd3NNYW5hZ2VyLmdhbnR0LndpZHRoKSB7CiAgICAgICAgICAgIHRoaXMudHJ1bmNhdGVkUmlnaHQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnRydW5jYXRlZExlZnQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IHRoaXMucm93c01hbmFnZXIuZ2FudHQud2lkdGggLSB0aGlzLm1vZGVsTGVmdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnRydW5jYXRlZExlZnQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy50cnVuY2F0ZWRSaWdodCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5tb2RlbFdpZHRoOwogICAgICAgIH0KICAgIH07CgogICAgLy8gRXhwYW5kcyB0aGUgc3RhcnQgb2YgdGhlIHRhc2sgdG8gdGhlIHNwZWNpZmllZCBwb3NpdGlvbiAoaW4gZW0pCiAgICBUYXNrLnByb3RvdHlwZS5zZXRGcm9tID0gZnVuY3Rpb24oeCkgewogICAgICAgIHRoaXMuZnJvbSA9IHRoaXMucm93c01hbmFnZXIuZ2FudHQuZ2V0RGF0ZUJ5UG9zaXRpb24oeCwgdHJ1ZSk7CiAgICAgICAgdGhpcy5fZnJvbUxhYmVsID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMucm93LnNldEZyb21Ub0J5VGFzayh0aGlzKTsKICAgICAgICB0aGlzLnVwZGF0ZVBvc0FuZFNpemUoKTsKICAgICAgICB0aGlzLmNoZWNrSWZNaWxlc3RvbmUoKTsKICAgIH07CgogICAgLy8gRXhwYW5kcyB0aGUgZW5kIG9mIHRoZSB0YXNrIHRvIHRoZSBzcGVjaWZpZWQgcG9zaXRpb24gKGluIGVtKQogICAgVGFzay5wcm90b3R5cGUuc2V0VG8gPSBmdW5jdGlvbih4KSB7CiAgICAgICAgdGhpcy50byA9IHRoaXMucm93c01hbmFnZXIuZ2FudHQuZ2V0RGF0ZUJ5UG9zaXRpb24oeCwgdHJ1ZSk7CiAgICAgICAgdGhpcy5fdG9MYWJlbCA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLnJvdy5zZXRGcm9tVG9CeVRhc2sodGhpcyk7CiAgICAgICAgdGhpcy51cGRhdGVQb3NBbmRTaXplKCk7CiAgICAgICAgdGhpcy5jaGVja0lmTWlsZXN0b25lKCk7CiAgICB9OwoKICAgIC8vIE1vdmVzIHRoZSB0YXNrIHRvIHRoZSBzcGVjaWZpZWQgcG9zaXRpb24gKGluIGVtKQogICAgVGFzay5wcm90b3R5cGUubW92ZVRvID0gZnVuY3Rpb24oeCkgewogICAgICAgIHRoaXMuZnJvbSA9IHRoaXMucm93c01hbmFnZXIuZ2FudHQuZ2V0RGF0ZUJ5UG9zaXRpb24oeCwgdHJ1ZSk7CiAgICAgICAgdGhpcy5fZnJvbUxhYmVsID0gdW5kZWZpbmVkOwogICAgICAgIHZhciBuZXdUYXNrTGVmdCA9IHRoaXMucm93c01hbmFnZXIuZ2FudHQuZ2V0UG9zaXRpb25CeURhdGUodGhpcy5mcm9tKTsKICAgICAgICB0aGlzLnRvID0gdGhpcy5yb3dzTWFuYWdlci5nYW50dC5nZXREYXRlQnlQb3NpdGlvbihuZXdUYXNrTGVmdCArIHRoaXMubW9kZWxXaWR0aCwgdHJ1ZSk7CiAgICAgICAgdGhpcy5fdG9MYWJlbCA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLnJvdy5zZXRGcm9tVG9CeVRhc2sodGhpcyk7CiAgICAgICAgdGhpcy51cGRhdGVQb3NBbmRTaXplKCk7CiAgICB9OwoKICAgIFRhc2sucHJvdG90eXBlLmNvcHkgPSBmdW5jdGlvbih0YXNrKSB7CiAgICAgICAgdGhpcy5uYW1lID0gdGFzay5uYW1lOwogICAgICAgIHRoaXMuY29sb3IgPSB0YXNrLmNvbG9yOwogICAgICAgIHRoaXMuY2xhc3NlcyA9IHRhc2suY2xhc3NlczsKICAgICAgICB0aGlzLnByaW9yaXR5ID0gdGFzay5wcmlvcml0eTsKICAgICAgICB0aGlzLmZyb20gPSBtb21lbnQodGFzay5mcm9tKTsKICAgICAgICB0aGlzLnRvID0gbW9tZW50KHRhc2sudG8pOwogICAgICAgIHRoaXMuZXN0ID0gdGFzay5lc3QgIT09IHVuZGVmaW5lZCA/IG1vbWVudCh0YXNrLmVzdCkgOiB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5sY3QgPSB0YXNrLmxjdCAhPT0gdW5kZWZpbmVkID8gbW9tZW50KHRhc2subGN0KSA6IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLmRhdGEgPSB0YXNrLmRhdGE7CiAgICAgICAgdGhpcy5pc01pbGVzdG9uZSA9IHRhc2suaXNNaWxlc3RvbmU7CiAgICB9OwoKICAgIFRhc2sucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBUYXNrKHRoaXMuaWQsIHRoaXMucm93LCB0aGlzLm5hbWUsIHRoaXMuY29sb3IsIHRoaXMuY2xhc3NlcywgdGhpcy5wcmlvcml0eSwgdGhpcy5mcm9tLCB0aGlzLnRvLCB0aGlzLmRhdGEsIHRoaXMuZXN0LCB0aGlzLmxjdCwgdGhpcy5wcm9ncmVzcyk7CiAgICB9OwoKICAgIHJldHVybiBUYXNrOwp9XSk7CgoKZ2FudHQuZmFjdG9yeSgnR2FudHRUYXNrUHJvZ3Jlc3MnLCBbZnVuY3Rpb24oKSB7CiAgICB2YXIgVGFza1Byb2dyZXNzID0gZnVuY3Rpb24odGFzaywgcGVyY2VudCwgY29sb3IsIGNsYXNzZXMpIHsKICAgICAgICB0aGlzLnRhc2sgPSB0YXNrOwogICAgICAgIHRoaXMucGVyY2VudCA9IHBlcmNlbnQ7CiAgICAgICAgdGhpcy5jb2xvciA9IGNvbG9yOwogICAgICAgIHRoaXMuY2xhc3NlcyA9IGNsYXNzZXM7CiAgICB9OwoKICAgIFRhc2tQcm9ncmVzcy5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IFRhc2tQcm9ncmVzcyh0aGlzLnRhc2ssIHRoaXMucGVyY2VudCwgdGhpcy5jb2xvciwgdGhpcy5jbGFzc2VzKTsKICAgIH07CgogICAgcmV0dXJuIFRhc2tQcm9ncmVzczsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0Qm9keScsIFsnR2FudHRCb2R5Q29sdW1ucycsICdHYW50dEJvZHlSb3dzJywgZnVuY3Rpb24oQm9keUNvbHVtbnMsIEJvZHlSb3dzKSB7CiAgICB2YXIgQm9keT0gZnVuY3Rpb24oZ2FudHQpIHsKICAgICAgICB0aGlzLmdhbnR0ID0gZ2FudHQ7CgogICAgICAgIHRoaXMuY29sdW1ucyA9IG5ldyBCb2R5Q29sdW1ucyh0aGlzKTsKICAgICAgICB0aGlzLnJvd3MgPSBuZXcgQm9keVJvd3ModGhpcyk7CiAgICB9OwogICAgcmV0dXJuIEJvZHk7Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdHYW50dEJvZHlDb2x1bW5zJywgW2Z1bmN0aW9uKCkgewogICAgdmFyIEJvZHlDb2x1bW5zID0gZnVuY3Rpb24oJGVsZW1lbnQpIHsKICAgICAgICB0aGlzLiRlbGVtZW50ID0gJGVsZW1lbnQ7CiAgICB9OwogICAgcmV0dXJuIEJvZHlDb2x1bW5zOwp9XSk7CgoKZ2FudHQuZmFjdG9yeSgnR2FudHRCb2R5Um93cycsIFtmdW5jdGlvbigpIHsKICAgIHZhciBCb2R5Um93cyA9IGZ1bmN0aW9uKCRlbGVtZW50KSB7CiAgICAgICAgdGhpcy4kZWxlbWVudCA9ICRlbGVtZW50OwogICAgfTsKICAgIHJldHVybiBCb2R5Um93czsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0SGVhZGVyJywgWydHYW50dEhlYWRlckNvbHVtbnMnLCBmdW5jdGlvbihIZWFkZXJDb2x1bW5zKSB7CiAgICB2YXIgSGVhZGVyID0gZnVuY3Rpb24oZ2FudHQpIHsKICAgICAgICB0aGlzLmdhbnR0ID0gZ2FudHQ7CiAgICAgICAgdGhpcy5jb2x1bW5zID0gbmV3IEhlYWRlckNvbHVtbnModGhpcyk7CgogICAgICAgIHRoaXMuZ2V0SGVpZ2h0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLiRlbGVtZW50WzBdLm9mZnNldEhlaWdodDsKICAgICAgICB9OwogICAgfTsKICAgIHJldHVybiBIZWFkZXI7Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdHYW50dEhlYWRlckNvbHVtbnMnLCBbZnVuY3Rpb24oKSB7CiAgICB2YXIgSGVhZGVyQ29sdW1ucyA9IGZ1bmN0aW9uKCRlbGVtZW50KSB7CiAgICAgICAgdGhpcy4kZWxlbWVudCA9ICRlbGVtZW50OwogICAgfTsKICAgIHJldHVybiBIZWFkZXJDb2x1bW5zOwp9XSk7CgoKZ2FudHQuZmFjdG9yeSgnR2FudHRMYWJlbHMnLCBbZnVuY3Rpb24oKSB7CiAgICB2YXIgTGFiZWxzPSBmdW5jdGlvbihnYW50dCkgewogICAgICAgIHRoaXMuZ2FudHQgPSBnYW50dDsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3RlckV2ZW50KCdsYWJlbHMnLCAncmVzaXplJyk7CiAgICB9OwogICAgcmV0dXJuIExhYmVsczsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0U2Nyb2xsJywgW2Z1bmN0aW9uKCkgewogICAgdmFyIFNjcm9sbCA9IGZ1bmN0aW9uKGdhbnR0KSB7CiAgICAgICAgdGhpcy5nYW50dCA9IGdhbnR0OwoKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3RlckV2ZW50KCdzY3JvbGwnLCAnc2Nyb2xsJyk7CgogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyTWV0aG9kKCdzY3JvbGwnLCAndG8nLCBTY3JvbGwucHJvdG90eXBlLnNjcm9sbFRvLCB0aGlzKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3Rlck1ldGhvZCgnc2Nyb2xsJywgJ3RvRGF0ZScsIFNjcm9sbC5wcm90b3R5cGUuc2Nyb2xsVG9EYXRlLCB0aGlzKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3Rlck1ldGhvZCgnc2Nyb2xsJywgJ2xlZnQnLCBTY3JvbGwucHJvdG90eXBlLnNjcm9sbFRvTGVmdCwgdGhpcyk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJNZXRob2QoJ3Njcm9sbCcsICdyaWdodCcsIFNjcm9sbC5wcm90b3R5cGUuc2Nyb2xsVG9SaWdodCwgdGhpcyk7CiAgICB9OwoKICAgIC8qKgogICAgICogU2Nyb2xsIHRvIGEgcG9zaXRpb24KICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gcG9zaXRpb24gUG9zaXRpb24gdG8gc2Nyb2xsIHRvLgogICAgICovCiAgICBTY3JvbGwucHJvdG90eXBlLnNjcm9sbFRvID0gZnVuY3Rpb24ocG9zaXRpb24pIHsKICAgICAgICB0aGlzLiRlbGVtZW50WzBdLnNjcm9sbExlZnQgPSBwb3NpdGlvbjsKICAgICAgICB0aGlzLiRlbGVtZW50LnRyaWdnZXJIYW5kbGVyKCdzY3JvbGwnKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTY3JvbGwgdG8gdGhlIGxlZnQgc2lkZQogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBvZmZzZXQgT2Zmc2V0IHRvIHNjcm9sbC4KICAgICAqLwogICAgU2Nyb2xsLnByb3RvdHlwZS5zY3JvbGxUb0xlZnQgPSBmdW5jdGlvbihvZmZzZXQpIHsKICAgICAgICB0aGlzLiRlbGVtZW50WzBdLnNjcm9sbExlZnQgLT0gb2Zmc2V0OwogICAgICAgIHRoaXMuJGVsZW1lbnQudHJpZ2dlckhhbmRsZXIoJ3Njcm9sbCcpOwogICAgfTsKCiAgICAvKioKICAgICAqIFNjcm9sbCB0byB0aGUgcmlnaHQgc2lkZQogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBvZmZzZXQgT2Zmc2V0IHRvIHNjcm9sbC4KICAgICAqLwogICAgU2Nyb2xsLnByb3RvdHlwZS5zY3JvbGxUb1JpZ2h0ID0gZnVuY3Rpb24ob2Zmc2V0KSB7CiAgICAgICAgdGhpcy4kZWxlbWVudFswXS5zY3JvbGxMZWZ0ICs9IG9mZnNldDsKICAgICAgICB0aGlzLiRlbGVtZW50LnRyaWdnZXJIYW5kbGVyKCdzY3JvbGwnKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTY3JvbGwgdG8gYSBkYXRlCiAgICAgKgogICAgICogQHBhcmFtIHttb21lbnR9IGRhdGUgbW9tZW50IHRvIHNjcm9sbCB0by4KICAgICAqLwogICAgU2Nyb2xsLnByb3RvdHlwZS5zY3JvbGxUb0RhdGUgPSBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgdmFyIHBvc2l0aW9uID0gdGhpcy5nYW50dC5nZXRQb3NpdGlvbkJ5RGF0ZShkYXRlKTsKCiAgICAgICAgaWYgKHBvc2l0aW9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy4kZWxlbWVudFswXS5zY3JvbGxMZWZ0ID0gcG9zaXRpb24gLSB0aGlzLiRlbGVtZW50WzBdLm9mZnNldFdpZHRoIC8gMjsKICAgICAgICB9CiAgICB9OwoKICAgIHJldHVybiBTY3JvbGw7Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdHYW50dFRpbWVzcGFuJywgWydtb21lbnQnLCBmdW5jdGlvbihtb21lbnQpIHsKICAgIHZhciBUaW1lc3BhbiA9IGZ1bmN0aW9uKGlkLCBnYW50dCwgbmFtZSwgY29sb3IsIGNsYXNzZXMsIHByaW9yaXR5LCBmcm9tLCB0bywgZGF0YSwgZXN0LCBsY3QpIHsKICAgICAgICB0aGlzLmlkID0gaWQ7CiAgICAgICAgdGhpcy5nYW50dCA9IGdhbnR0OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5jb2xvciA9IGNvbG9yOwogICAgICAgIHRoaXMuY2xhc3NlcyA9IGNsYXNzZXM7CiAgICAgICAgdGhpcy5wcmlvcml0eSA9IHByaW9yaXR5OwogICAgICAgIHRoaXMuZnJvbSA9IG1vbWVudChmcm9tKTsKICAgICAgICB0aGlzLnRvID0gbW9tZW50KHRvKTsKICAgICAgICB0aGlzLmRhdGEgPSBkYXRhOwoKICAgICAgICBpZiAoZXN0ICE9PSB1bmRlZmluZWQgJiYgbGN0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy5lc3QgPSBtb21lbnQoZXN0KTsgIC8vRWFybGllc3QgU3RhcnQgVGltZQogICAgICAgICAgICB0aGlzLmxjdCA9IG1vbWVudChsY3QpOyAgLy9MYXRlc3QgQ29tcGxldGlvbiBUaW1lCiAgICAgICAgfQogICAgfTsKCiAgICAvLyBVcGRhdGVzIHRoZSBwb3MgYW5kIHNpemUgb2YgdGhlIHRpbWVzcGFuIGFjY29yZGluZyB0byB0aGUgZnJvbSAtIHRvIGRhdGUKICAgIFRpbWVzcGFuLnByb3RvdHlwZS51cGRhdGVQb3NBbmRTaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5sZWZ0ID0gdGhpcy5nYW50dC5nZXRQb3NpdGlvbkJ5RGF0ZSh0aGlzLmZyb20pOwogICAgICAgIHRoaXMud2lkdGggPSB0aGlzLmdhbnR0LmdldFBvc2l0aW9uQnlEYXRlKHRoaXMudG8pIC0gdGhpcy5sZWZ0OwogICAgfTsKCiAgICAvLyBFeHBhbmRzIHRoZSBzdGFydCBvZiB0aGUgdGltZXNwYW4gdG8gdGhlIHNwZWNpZmllZCBwb3NpdGlvbiAoaW4gZW0pCiAgICBUaW1lc3Bhbi5wcm90b3R5cGUuc2V0RnJvbSA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICB0aGlzLmZyb20gPSB0aGlzLmdhbnR0LmdldERhdGVCeVBvc2l0aW9uKHgpOwogICAgICAgIHRoaXMudXBkYXRlUG9zQW5kU2l6ZSgpOwogICAgfTsKCiAgICAvLyBFeHBhbmRzIHRoZSBlbmQgb2YgdGhlIHRpbWVzcGFuIHRvIHRoZSBzcGVjaWZpZWQgcG9zaXRpb24gKGluIGVtKQogICAgVGltZXNwYW4ucHJvdG90eXBlLnNldFRvID0gZnVuY3Rpb24oeCkgewogICAgICAgIHRoaXMudG8gPSB0aGlzLmdhbnR0LmdldERhdGVCeVBvc2l0aW9uKHgpOwogICAgICAgIHRoaXMudXBkYXRlUG9zQW5kU2l6ZSgpOwogICAgfTsKCiAgICAvLyBNb3ZlcyB0aGUgdGltZXNwYW4gdG8gdGhlIHNwZWNpZmllZCBwb3NpdGlvbiAoaW4gZW0pCiAgICBUaW1lc3Bhbi5wcm90b3R5cGUubW92ZVRvID0gZnVuY3Rpb24oeCkgewogICAgICAgIHRoaXMuZnJvbSA9IHRoaXMuZ2FudHQuZ2V0RGF0ZUJ5UG9zaXRpb24oeCk7CiAgICAgICAgdGhpcy50byA9IHRoaXMuZ2FudHQuZ2V0RGF0ZUJ5UG9zaXRpb24oeCArIHRoaXMud2lkdGgpOwogICAgICAgIHRoaXMudXBkYXRlUG9zQW5kU2l6ZSgpOwogICAgfTsKCiAgICBUaW1lc3Bhbi5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uKHRpbWVzcGFuKSB7CiAgICAgICAgdGhpcy5uYW1lID0gdGltZXNwYW4ubmFtZTsKICAgICAgICB0aGlzLmNvbG9yID0gdGltZXNwYW4uY29sb3I7CiAgICAgICAgdGhpcy5jbGFzc2VzID0gdGltZXNwYW4uY2xhc3NlczsKICAgICAgICB0aGlzLnByaW9yaXR5ID0gdGltZXNwYW4ucHJpb3JpdHk7CiAgICAgICAgdGhpcy5mcm9tID0gbW9tZW50KHRpbWVzcGFuLmZyb20pOwogICAgICAgIHRoaXMudG8gPSBtb21lbnQodGltZXNwYW4udG8pOwogICAgICAgIHRoaXMuZXN0ID0gdGltZXNwYW4uZXN0ICE9PSB1bmRlZmluZWQgPyBtb21lbnQodGltZXNwYW4uZXN0KSA6IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLmxjdCA9IHRpbWVzcGFuLmxjdCAhPT0gdW5kZWZpbmVkID8gbW9tZW50KHRpbWVzcGFuLmxjdCkgOiB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5kYXRhID0gdGltZXNwYW4uZGF0YTsKICAgIH07CgogICAgVGltZXNwYW4ucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBUaW1lc3Bhbih0aGlzLmlkLCB0aGlzLmdhbnR0LCB0aGlzLm5hbWUsIHRoaXMuY29sb3IsIHRoaXMuY2xhc3NlcywgdGhpcy5wcmlvcml0eSwgdGhpcy5mcm9tLCB0aGlzLnRvLCB0aGlzLmRhdGEsIHRoaXMuZXN0LCB0aGlzLmxjdCk7CiAgICB9OwoKICAgIHJldHVybiBUaW1lc3BhbjsKfV0pOwoKCmdhbnR0LmZhY3RvcnkoJ0dhbnR0VGltZXNwYW5zTWFuYWdlcicsIFsnR2FudHRUaW1lc3BhbicsIGZ1bmN0aW9uKFRpbWVzcGFuKSB7CiAgICB2YXIgR2FudHRUaW1lc3BhbnNNYW5hZ2VyID0gZnVuY3Rpb24oZ2FudHQpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHRoaXMuZ2FudHQgPSBnYW50dDsKCiAgICAgICAgdGhpcy50aW1lc3BhbnNNYXAgPSB7fTsKICAgICAgICB0aGlzLnRpbWVzcGFucyA9IFtdOwoKICAgICAgICB0aGlzLmdhbnR0LiRzY29wZS4kd2F0Y2goJ3RpbWVzcGFucycsIGZ1bmN0aW9uKG5ld1ZhbHVlKSB7CiAgICAgICAgICAgIHNlbGYuY2xlYXJUaW1lc3BhbnMoKTsKICAgICAgICAgICAgc2VsZi5sb2FkVGltZXNwYW5zKG5ld1ZhbHVlKTsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJNZXRob2QoJ3RpbWVzcGFucycsICdsb2FkJywgdGhpcy5sb2FkVGltZXNwYW5zLCB0aGlzKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3Rlck1ldGhvZCgndGltZXNwYW5zJywgJ3JlbW92ZScsIHRoaXMucmVtb3ZlVGltZXNwYW5zLCB0aGlzKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3Rlck1ldGhvZCgndGltZXNwYW5zJywgJ2NsZWFyJywgdGhpcy5jbGVhclRpbWVzcGFucywgdGhpcyk7CgogICAgICAgIHRoaXMuZ2FudHQuYXBpLnJlZ2lzdGVyRXZlbnQoJ3RpbWVzcGFucycsICdhZGQnKTsKICAgICAgICB0aGlzLmdhbnR0LmFwaS5yZWdpc3RlckV2ZW50KCd0aW1lc3BhbnMnLCAncmVtb3ZlJyk7CiAgICAgICAgdGhpcy5nYW50dC5hcGkucmVnaXN0ZXJFdmVudCgndGltZXNwYW5zJywgJ2NoYW5nZScpOwogICAgfTsKCiAgICAvLyBBZGRzIG9yIHVwZGF0ZXMgdGltZXNwYW5zCiAgICBHYW50dFRpbWVzcGFuc01hbmFnZXIucHJvdG90eXBlLmxvYWRUaW1lc3BhbnMgPSBmdW5jdGlvbih0aW1lc3BhbnMpIHsKICAgICAgICBpZiAoIWFuZ3VsYXIuaXNBcnJheSh0aW1lc3BhbnMpKSB7CiAgICAgICAgICAgIHRpbWVzcGFucyA9IFt0aW1lc3BhbnNdOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aW1lc3BhbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHZhciB0aW1lc3BhbkRhdGEgPSB0aW1lc3BhbnNbaV07CiAgICAgICAgICAgIHRoaXMubG9hZFRpbWVzcGFuKHRpbWVzcGFuRGF0YSk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBBZGRzIGEgdGltZXNwYW4gb3IgbWVyZ2VzIHRoZSB0aW1lc3BhbiBpZiB0aGVyZSBpcyBhbHJlYWR5IG9uZSB3aXRoIHRoZSBzYW1lIGlkCiAgICBHYW50dFRpbWVzcGFuc01hbmFnZXIucHJvdG90eXBlLmxvYWRUaW1lc3BhbiA9IGZ1bmN0aW9uKHRpbWVzcGFuRGF0YSkgewogICAgICAgIC8vIENvcHkgdG8gbmV3IHRpbWVzcGFuIChhZGQpIG9yIG1lcmdlIHdpdGggZXhpc3RpbmcgKHVwZGF0ZSkKICAgICAgICB2YXIgdGltZXNwYW4sIGlzVXBkYXRlID0gZmFsc2U7CgogICAgICAgIGlmICh0aW1lc3BhbkRhdGEuaWQgaW4gdGhpcy50aW1lc3BhbnNNYXApIHsKICAgICAgICAgICAgdGltZXNwYW4gPSB0aGlzLnRpbWVzcGFuc01hcFt0aW1lc3BhbkRhdGEuaWRdOwogICAgICAgICAgICB0aW1lc3Bhbi5jb3B5KHRpbWVzcGFuRGF0YSk7CiAgICAgICAgICAgIGlzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5nYW50dC5hcGkudGltZXNwYW5zLnJhaXNlLmNoYW5nZSh0aW1lc3Bhbik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGltZXNwYW4gPSBuZXcgVGltZXNwYW4odGltZXNwYW5EYXRhLmlkLCB0aGlzLmdhbnR0LCB0aW1lc3BhbkRhdGEubmFtZSwgdGltZXNwYW5EYXRhLmNvbG9yLAogICAgICAgICAgICAgICAgdGltZXNwYW5EYXRhLmNsYXNzZXMsIHRpbWVzcGFuRGF0YS5wcmlvcml0eSwgdGltZXNwYW5EYXRhLmZyb20sIHRpbWVzcGFuRGF0YS50bywgdGltZXNwYW5EYXRhLmRhdGEpOwogICAgICAgICAgICB0aGlzLnRpbWVzcGFuc01hcFt0aW1lc3BhbkRhdGEuaWRdID0gdGltZXNwYW47CiAgICAgICAgICAgIHRoaXMudGltZXNwYW5zLnB1c2godGltZXNwYW4pOwogICAgICAgICAgICB0aGlzLmdhbnR0LmFwaS50aW1lc3BhbnMucmFpc2UuYWRkKHRpbWVzcGFuKTsKICAgICAgICB9CgogICAgICAgIHRpbWVzcGFuLnVwZGF0ZVBvc0FuZFNpemUoKTsKICAgICAgICByZXR1cm4gaXNVcGRhdGU7CiAgICB9OwoKICAgIEdhbnR0VGltZXNwYW5zTWFuYWdlci5wcm90b3R5cGUucmVtb3ZlVGltZXNwYW5zID0gZnVuY3Rpb24odGltZXNwYW5zKSB7CiAgICAgICAgaWYgKCFhbmd1bGFyLmlzQXJyYXkodGltZXNwYW5zKSkgewogICAgICAgICAgICB0aW1lc3BhbnMgPSBbdGltZXNwYW5zXTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGltZXNwYW5zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB2YXIgdGltZXNwYW5EYXRhID0gdGltZXNwYW5zW2ldOwogICAgICAgICAgICAvLyBEZWxldGUgdGhlIHRpbWVzcGFuCiAgICAgICAgICAgIHRoaXMucmVtb3ZlVGltZXNwYW4odGltZXNwYW5EYXRhLmlkKTsKICAgICAgICB9CiAgICAgICAgdGhpcy51cGRhdGVWaXNpYmxlT2JqZWN0cygpOwogICAgfTsKCiAgICBHYW50dFRpbWVzcGFuc01hbmFnZXIucHJvdG90eXBlLnJlbW92ZVRpbWVzcGFuID0gZnVuY3Rpb24odGltZXNwYW5JZCkgewogICAgICAgIGlmICh0aW1lc3BhbklkIGluIHRoaXMudGltZXNwYW5zTWFwKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnRpbWVzcGFuc01hcFt0aW1lc3BhbklkXTsgLy8gUmVtb3ZlIGZyb20gbWFwCgogICAgICAgICAgICB2YXIgcmVtb3ZlZFRpbWVzcGFuOwogICAgICAgICAgICB2YXIgdGltZXNwYW47CiAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLnRpbWVzcGFucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgdGltZXNwYW4gPSB0aGlzLnRpbWVzcGFuc1tpXTsKICAgICAgICAgICAgICAgIGlmICh0aW1lc3Bhbi5pZCA9PT0gdGltZXNwYW5JZCkgewogICAgICAgICAgICAgICAgICAgIHJlbW92ZWRUaW1lc3BhbiA9IHRpbWVzcGFuOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGltZXNwYW5zLnNwbGljZShpLCAxKTsgLy8gUmVtb3ZlIGZyb20gYXJyYXkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5nYW50dC5hcGkudGltZXNwYW5zLnJhaXNlLnJlbW92ZShyZW1vdmVkVGltZXNwYW4pOwogICAgICAgICAgICByZXR1cm4gcmVtb3ZlZFRpbWVzcGFuOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH07CgogICAgLy8gUmVtb3ZlcyBhbGwgdGltZXNwYW5zCiAgICBHYW50dFRpbWVzcGFuc01hbmFnZXIucHJvdG90eXBlLmNsZWFyVGltZXNwYW5zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy50aW1lc3BhbnNNYXAgPSB7fTsKICAgICAgICB0aGlzLnRpbWVzcGFucyA9IFtdOwogICAgfTsKCiAgICBHYW50dFRpbWVzcGFuc01hbmFnZXIucHJvdG90eXBlLnVwZGF0ZVRpbWVzcGFuc1Bvc0FuZFNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMudGltZXNwYW5zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLnRpbWVzcGFuc1tpXS51cGRhdGVQb3NBbmRTaXplKCk7CiAgICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gR2FudHRUaW1lc3BhbnNNYW5hZ2VyOwp9XSk7CgoKZ2FudHQuc2VydmljZSgnZ2FudHRCaW5hcnlTZWFyY2gnLCBbIGZ1bmN0aW9uKCkgewogICAgLy8gUmV0dXJucyB0aGUgb2JqZWN0IG9uIHRoZSBsZWZ0IGFuZCByaWdodCBpbiBhbiBhcnJheSB1c2luZyB0aGUgZ2l2ZW4gY21wIGZ1bmN0aW9uLgogICAgLy8gVGhlIGNvbXBhcmUgZnVuY3Rpb24gZGVmaW5lZCB3aGljaCBwcm9wZXJ0eSBvZiB0aGUgdmFsdWUgdG8gY29tcGFyZSAoZS5nLjogYyA9PiBjLmxlZnQpCgogICAgcmV0dXJuIHsKICAgICAgICBnZXRJbmRpY2VzT25seTogZnVuY3Rpb24oaW5wdXQsIHZhbHVlLCBjb21wYXJlcikgewogICAgICAgICAgICB2YXIgbG8gPSAtMSwgaGkgPSBpbnB1dC5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChoaSAtIGxvID4gMSkgewogICAgICAgICAgICAgICAgdmFyIG1pZCA9IE1hdGguZmxvb3IoKGxvICsgaGkpIC8gMik7CiAgICAgICAgICAgICAgICBpZiAoY29tcGFyZXIoaW5wdXRbbWlkXSkgPD0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBsbyA9IG1pZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaGkgPSBtaWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlucHV0W2xvXSAhPT0gdW5kZWZpbmVkICYmIGNvbXBhcmVyKGlucHV0W2xvXSkgPT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICBoaSA9IGxvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBbbG8sIGhpXTsKICAgICAgICB9LAogICAgICAgIGdldDogZnVuY3Rpb24oaW5wdXQsIHZhbHVlLCBjb21wYXJlcikgewogICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5nZXRJbmRpY2VzT25seShpbnB1dCwgdmFsdWUsIGNvbXBhcmVyKTsKICAgICAgICAgICAgcmV0dXJuIFtpbnB1dFtyZXNbMF1dLCBpbnB1dFtyZXNbMV1dXTsKICAgICAgICB9CiAgICB9Owp9XSk7CgpnYW50dC5zZXJ2aWNlKCdnYW50dFV0aWxzJywgW2Z1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgICBjcmVhdGVCb3VuZGVkV3JhcHBlcjogZnVuY3Rpb24ob2JqZWN0LCBtZXRob2QpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseShvYmplY3QsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBuZXdJZDogKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgc2VlZElkID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZWVkSWQgKz0gMTsKICAgICAgICAgICAgfTsKICAgICAgICB9KSgpCiAgICB9Owp9XSk7CgoKZ2FudHQuZmlsdGVyKCdnYW50dENvbHVtbkxpbWl0JywgWyAnZ2FudHRCaW5hcnlTZWFyY2gnLCBmdW5jdGlvbihicykgewogICAgLy8gUmV0dXJucyBvbmx5IHRoZSBjb2x1bW5zIHdoaWNoIGFyZSB2aXNpYmxlIG9uIHRoZSBzY3JlZW4KCiAgICByZXR1cm4gZnVuY3Rpb24oaW5wdXQsIHNjcm9sbExlZnQsIHNjcm9sbFdpZHRoKSB7CiAgICAgICAgdmFyIGNtcCA9IGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgcmV0dXJuIGMubGVmdDsKICAgICAgICB9OwogICAgICAgIHZhciBzdGFydCA9IGJzLmdldEluZGljZXNPbmx5KGlucHV0LCBzY3JvbGxMZWZ0LCBjbXApWzBdOwogICAgICAgIHZhciBlbmQgPSBicy5nZXRJbmRpY2VzT25seShpbnB1dCwgc2Nyb2xsTGVmdCArIHNjcm9sbFdpZHRoLCBjbXApWzFdOwogICAgICAgIHJldHVybiBpbnB1dC5zbGljZShzdGFydCwgZW5kKTsKICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0TGltaXRVcGRhdGVyJywgWyckdGltZW91dCcsICdnYW50dERlYm91bmNlJywgZnVuY3Rpb24oJHRpbWVvdXQsIGRlYm91bmNlKSB7CiAgICAvLyBVcGRhdGVzIHRoZSBsaW1pdCBmaWx0ZXJzIGlmIHRoZSB1c2VyIHNjcm9sbHMgdGhlIGdhbnR0IGNoYXJ0CgogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0EnLAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICB2YXIgZWwgPSAkZWxlbWVudFswXTsKICAgICAgICAgICAgdmFyIHNjcm9sbFVwZGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLnNjcm9sbExlZnQgPSBlbC5zY3JvbGxMZWZ0OwogICAgICAgICAgICAgICAgJHNjb3BlLnNjcm9sbFdpZHRoID0gZWwub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAkZWxlbWVudC5iaW5kKCdzY3JvbGwnLCBkZWJvdW5jZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNjcm9sbFVwZGF0ZSgpOwogICAgICAgICAgICB9LCA1KSk7CgogICAgICAgICAgICAkc2NvcGUuJHdhdGNoKCdnYW50dC53aWR0aCcsIGRlYm91bmNlKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2Nyb2xsVXBkYXRlKCk7CiAgICAgICAgICAgIH0sIDIwKSk7CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5maWx0ZXIoJ2dhbnR0VGFza0xpbWl0JywgW2Z1bmN0aW9uKCkgewogICAgLy8gUmV0dXJucyBvbmx5IHRoZSB0YXNrcyB3aGljaCBhcmUgdmlzaWJsZSBvbiB0aGUgc2NyZWVuCiAgICAvLyBVc2UgdGhlIHRhc2sgd2lkdGggYW5kIHBvc2l0aW9uIHRvIGRlY2lkZSBpZiBhIHRhc2sgaXMgc3RpbGwgdmlzaWJsZQoKICAgIHJldHVybiBmdW5jdGlvbihpbnB1dCwgZ2FudHQpIHsKICAgICAgICB2YXIgcmVzID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBpbnB1dC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdmFyIHRhc2sgPSBpbnB1dFtpXTsKICAgICAgICAgICAgLy8gSWYgdGhlIHRhc2sgY2FuIGJlIGRyYXduIHdpdGggZ2FudHQgY29sdW1ucyBvbmx5LgogICAgICAgICAgICBpZiAodGFzay50byA+IGdhbnR0LmNvbHVtbnNNYW5hZ2VyLmdldEZpcnN0Q29sdW1uKCkuZGF0ZSAmJiB0YXNrLmZyb20gPCBnYW50dC5jb2x1bW5zTWFuYWdlci5nZXRMYXN0Q29sdW1uKCkuZW5kRGF0ZSkgewoKICAgICAgICAgICAgICAgIHZhciBzY3JvbGxMZWZ0ID0gZ2FudHQuJHNjb3BlLnNjcm9sbExlZnQ7CiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsV2lkdGggPSBnYW50dC4kc2NvcGUuc2Nyb2xsV2lkdGg7CgogICAgICAgICAgICAgICAgLy8gSWYgdGFzayBoYXMgYSB2aXNpYmxlIHBhcnQgb24gdGhlIHNjcmVlbgogICAgICAgICAgICAgICAgaWYgKHRhc2subGVmdCA+PSBzY3JvbGxMZWZ0ICYmIHRhc2subGVmdCA8PSBzY3JvbGxMZWZ0ICsgc2Nyb2xsV2lkdGggfHwKICAgICAgICAgICAgICAgICAgICB0YXNrLmxlZnQgKyB0YXNrLndpZHRoID49IHNjcm9sbExlZnQgJiYgdGFzay5sZWZ0ICsgdGFzay53aWR0aCA8PSBzY3JvbGxMZWZ0ICsgc2Nyb2xsV2lkdGggfHwKICAgICAgICAgICAgICAgICAgICB0YXNrLmxlZnQgPCBzY3JvbGxMZWZ0ICYmIHRhc2subGVmdCArIHRhc2sud2lkdGggPiBzY3JvbGxMZWZ0ICsgc2Nyb2xsV2lkdGgpIHsKCiAgICAgICAgICAgICAgICAgICAgcmVzLnB1c2godGFzayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzOwogICAgfTsKfV0pOwoKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRMYWJlbHNSZXNpemUnLCBbJyRkb2N1bWVudCcsICdnYW50dERlYm91bmNlJywgJ2dhbnR0TW91c2VPZmZzZXQnLCBmdW5jdGlvbigkZG9jdW1lbnQsIGRlYm91bmNlLCBtb3VzZU9mZnNldCkgewoKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgICBzY29wZTogeyBlbmFibGVkOiAnPWdhbnR0TGFiZWxzUmVzaXplJywKICAgICAgICAgICAgd2lkdGg6ICc9Z2FudHRMYWJlbHNSZXNpemVXaWR0aCcsCiAgICAgICAgICAgIG1pbldpZHRoOiAnPWdhbnR0TGFiZWxzUmVzaXplTWluV2lkdGgnfSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIHJlc2l6ZUFyZWFXaWR0aCA9IDU7CiAgICAgICAgICAgIHZhciBjdXJzb3IgPSAnZXctcmVzaXplJzsKICAgICAgICAgICAgdmFyIG9yaWdpbmFsUG9zOwoKICAgICAgICAgICAgJGVsZW1lbnQuYmluZCgnbW91c2Vkb3duJywgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgaWYgKCRzY29wZS5lbmFibGVkICYmIGlzSW5SZXNpemVBcmVhKGUpKSB7CiAgICAgICAgICAgICAgICAgICAgZW5hYmxlUmVzaXplTW9kZShlKTsKICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgJGVsZW1lbnQuYmluZCgnbW91c2Vtb3ZlJywgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgaWYgKCRzY29wZS5lbmFibGVkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSW5SZXNpemVBcmVhKGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LmNzcygnY3Vyc29yJywgY3Vyc29yKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC5jc3MoJ2N1cnNvcicsICcnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIHJlc2l6ZSA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICAgICAgICAgIGlmICgkc2NvcGUud2lkdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUud2lkdGggPSAkZWxlbWVudFswXS5vZmZzZXRXaWR0aDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkc2NvcGUud2lkdGggKz0geCAtIG9yaWdpbmFsUG9zOwogICAgICAgICAgICAgICAgaWYgKCRzY29wZS53aWR0aCA8ICRzY29wZS5taW5XaWR0aCkgewogICAgICAgICAgICAgICAgICAgICRzY29wZS53aWR0aCA9ICRzY29wZS5taW5XaWR0aDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBvcmlnaW5hbFBvcyA9IHg7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgaXNJblJlc2l6ZUFyZWEgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgeCA9IG1vdXNlT2Zmc2V0LmdldE9mZnNldChlKS54OwoKICAgICAgICAgICAgICAgIHJldHVybiB4ID4gJGVsZW1lbnRbMF0ub2Zmc2V0V2lkdGggLSByZXNpemVBcmVhV2lkdGg7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgZW5hYmxlUmVzaXplTW9kZSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIG9yaWdpbmFsUG9zID0gZS5zY3JlZW5YOwoKICAgICAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudCgkZG9jdW1lbnRbMF0uYm9keSkuY3NzKHsKICAgICAgICAgICAgICAgICAgICAnLW1vei11c2VyLXNlbGVjdCc6ICctbW96LW5vbmUnLAogICAgICAgICAgICAgICAgICAgICctd2Via2l0LXVzZXItc2VsZWN0JzogJ25vbmUnLAogICAgICAgICAgICAgICAgICAgICctbXMtdXNlci1zZWxlY3QnOiAnbm9uZScsCiAgICAgICAgICAgICAgICAgICAgJ3VzZXItc2VsZWN0JzogJ25vbmUnLAogICAgICAgICAgICAgICAgICAgICdjdXJzb3InOiBjdXJzb3IKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHZhciBtb3ZlSGFuZGxlciA9IGRlYm91bmNlKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICByZXNpemUoZS5zY3JlZW5YKTsKICAgICAgICAgICAgICAgIH0sIDUpOwoKICAgICAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudCgkZG9jdW1lbnRbMF0uYm9keSkuYmluZCgnbW91c2Vtb3ZlJywgbW92ZUhhbmRsZXIpOwoKICAgICAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudCgkZG9jdW1lbnRbMF0uYm9keSkub25lKCdtb3VzZXVwJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5lbGVtZW50KCRkb2N1bWVudFswXS5ib2R5KS51bmJpbmQoJ21vdXNlbW92ZScsIG1vdmVIYW5kbGVyKTsKICAgICAgICAgICAgICAgICAgICBkaXNhYmxlUmVzaXplTW9kZSgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgZGlzYWJsZVJlc2l6ZU1vZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRlbGVtZW50LmNzcygnY3Vyc29yJywgJycpOwoKICAgICAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudCgkZG9jdW1lbnRbMF0uYm9keSkuY3NzKHsKICAgICAgICAgICAgICAgICAgICAnLW1vei11c2VyLXNlbGVjdCc6ICcnLAogICAgICAgICAgICAgICAgICAgICctd2Via2l0LXVzZXItc2VsZWN0JzogJycsCiAgICAgICAgICAgICAgICAgICAgJy1tcy11c2VyLXNlbGVjdCc6ICcnLAogICAgICAgICAgICAgICAgICAgICd1c2VyLXNlbGVjdCc6ICcnLAogICAgICAgICAgICAgICAgICAgICdjdXJzb3InOiAnJwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5sYWJlbHMucmFpc2UucmVzaXplKCRzY29wZS53aWR0aCk7CiAgICAgICAgICAgIH07CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0UmlnaHRDbGljaycsIFsnJHBhcnNlJywgZnVuY3Rpb24oJHBhcnNlKSB7CgogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0EnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIHZhciBmbiA9ICRwYXJzZShhdHRyLmdhbnR0UmlnaHRDbGljayk7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQub24oJ2NvbnRleHRtZW51JywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuKHNjb3BlLCB7JGV2ZW50OiBldmVudH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfTsKfV0pOwoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dEhvcml6b250YWxTY3JvbGxSZWNlaXZlcicsIGZ1bmN0aW9uKCkgewogICAgLy8gVGhlIGVsZW1lbnQgd2l0aCB0aGlzIGF0dHJpYnV0ZSB3aWxsIHNjcm9sbCBhdCB0aGUgc2FtZSB0aW1lIGFzIHRoZSBzY3JvbGxTZW5kZXIgZWxlbWVudAoKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgICByZXF1aXJlOiAnXmdhbnR0U2Nyb2xsTWFuYWdlcicsCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICRzY29wZS5zY3JvbGxNYW5hZ2VyLmhvcml6b250YWwucHVzaCgkZWxlbWVudFswXSk7CiAgICAgICAgfV0KICAgIH07Cn0pOwoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dFNjcm9sbE1hbmFnZXInLCBmdW5jdGlvbigpIHsKICAgIC8vIFRoZSBlbGVtZW50IHdpdGggdGhpcyBhdHRyaWJ1dGUgd2lsbCBzY3JvbGwgYXQgdGhlIHNhbWUgdGltZSBhcyB0aGUgc2Nyb2xsU2VuZGVyIGVsZW1lbnQKCiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgICAgcmVxdWlyZTogJ15nYW50dCcsCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLnNjcm9sbE1hbmFnZXIgPSB7CiAgICAgICAgICAgICAgICBob3Jpem9udGFsOiBbXSwKICAgICAgICAgICAgICAgIHZlcnRpY2FsOiBbXQogICAgICAgICAgICB9OwogICAgICAgIH1dCiAgICB9Owp9KTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0U2Nyb2xsU2VuZGVyJywgWyckdGltZW91dCcsICdnYW50dERlYm91bmNlJywgZnVuY3Rpb24oJHRpbWVvdXQsIGRlYm91bmNlKSB7CiAgICAvLyBVcGRhdGVzIHRoZSBlbGVtZW50IHdoaWNoIGFyZSByZWdpc3RlcmVkIGZvciB0aGUgaG9yaXpvbnRhbCBvciB2ZXJ0aWNhbCBzY3JvbGwgZXZlbnQKCiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgICAgcmVxdWlyZTogJ15nYW50dFNjcm9sbE1hbmFnZXInLAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICB2YXIgZWwgPSAkZWxlbWVudFswXTsKICAgICAgICAgICAgdmFyIHVwZGF0ZUxpc3RlbmVycyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGksIGw7CgogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9ICRzY29wZS5zY3JvbGxNYW5hZ2VyLnZlcnRpY2FsLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciB2RWxlbWVudCA9ICRzY29wZS5zY3JvbGxNYW5hZ2VyLnZlcnRpY2FsW2ldOwogICAgICAgICAgICAgICAgICAgIGlmICh2RWxlbWVudC5zdHlsZS50b3AgIT09IC1lbC5zY3JvbGxUb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdkVsZW1lbnQuc3R5bGUudG9wID0gLWVsLnNjcm9sbFRvcCArICdweCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHZFbGVtZW50LnN0eWxlLmhlaWdodCA9IGVsLnNjcm9sbEhlaWdodCArICdweCc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSAkc2NvcGUuc2Nyb2xsTWFuYWdlci5ob3Jpem9udGFsLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBoRWxlbWVudCA9ICRzY29wZS5zY3JvbGxNYW5hZ2VyLmhvcml6b250YWxbaV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGhFbGVtZW50LnN0eWxlLmxlZnQgIT09IC1lbC5zY3JvbGxMZWZ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhFbGVtZW50LnN0eWxlLmxlZnQgPSAtZWwuc2Nyb2xsTGVmdCArICdweCc7CiAgICAgICAgICAgICAgICAgICAgICAgIGhFbGVtZW50LnN0eWxlLndpZHRoID0gZWwuc2Nyb2xsV2lkdGggKyAncHgnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICRlbGVtZW50LmJpbmQoJ3Njcm9sbCcsIHVwZGF0ZUxpc3RlbmVycyk7CiAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkucm93cy5vbi5jaGFuZ2UoJHNjb3BlLCBkZWJvdW5jZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZUxpc3RlbmVycygpOwogICAgICAgICAgICB9LCA1KSk7CgogICAgICAgICAgICAkc2NvcGUuJHdhdGNoKCdnYW50dC53aWR0aCcsIGZ1bmN0aW9uKG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAobmV3VmFsdWUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlTGlzdGVuZXJzKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dFNjcm9sbGFibGUnLCBbJ2dhbnR0RGVib3VuY2UnLCAnZ2FudHRMYXlvdXQnLCBmdW5jdGlvbihkZWJvdW5jZSwgbGF5b3V0KSB7CiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHRlbXBsYXRlVXJsOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgICAgICAgIGlmICh0QXR0cnMudGVtcGxhdGVVcmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICd0ZW1wbGF0ZS9kZWZhdWx0LnNjcm9sbGFibGUudG1wbC5odG1sJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0QXR0cnMudGVtcGxhdGVVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICAkc2NvcGUuZ2FudHQuc2Nyb2xsLiRlbGVtZW50ID0gJGVsZW1lbnQ7CgogICAgICAgICAgICB2YXIgc2Nyb2xsQmFyV2lkdGggPSBsYXlvdXQuZ2V0U2Nyb2xsQmFyV2lkdGgoKTsKICAgICAgICAgICAgdmFyIGxhc3RTY3JvbGxMZWZ0OwoKICAgICAgICAgICAgdmFyIGxhc3RBdXRvRXhwYW5kOwogICAgICAgICAgICB2YXIgYXV0b0V4cGFuZENvb2xEb3duUGVyaW9kID0gNTAwOwogICAgICAgICAgICB2YXIgYXV0b0V4cGFuZENvbHVtbnMgPSBmdW5jdGlvbihlbCwgZGF0ZSwgZGlyZWN0aW9uKSB7CiAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLmF1dG9FeHBhbmQgIT09ICdib3RoJyAmJiAkc2NvcGUuYXV0b0V4cGFuZCAhPT0gdHJ1ZSAmJiAkc2NvcGUuYXV0b0V4cGFuZCAhPT0gZGlyZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChEYXRlLm5vdygpIC0gbGFzdEF1dG9FeHBhbmQgPCBhdXRvRXhwYW5kQ29vbERvd25QZXJpb2QpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIGZyb20sIHRvOwogICAgICAgICAgICAgICAgdmFyIGV4cGFuZEhvdXIgPSAxLCBleHBhbmREYXkgPSAzMTsKCiAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAnbGVmdCcpIHsKICAgICAgICAgICAgICAgICAgICBmcm9tID0gJHNjb3BlLnZpZXdTY2FsZSA9PT0gJ2hvdXInID8gbW9tZW50KGRhdGUpLmFkZCgtZXhwYW5kSG91ciwgJ2RheScpIDogbW9tZW50KGRhdGUpLmFkZCgtZXhwYW5kRGF5LCAnZGF5Jyk7CiAgICAgICAgICAgICAgICAgICAgdG8gPSBkYXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmcm9tID0gZGF0ZTsKICAgICAgICAgICAgICAgICAgICB0byA9ICRzY29wZS52aWV3U2NhbGUgPT09ICdob3VyJyA/IG1vbWVudChkYXRlKS5hZGQoZXhwYW5kSG91ciwgJ2RheScpIDogbW9tZW50KGRhdGUpLmFkZChleHBhbmREYXksICdkYXknKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkc2NvcGUuZnJvbURhdGUgPSBmcm9tOwogICAgICAgICAgICAgICAgJHNjb3BlLnRvRGF0ZSA9IHRvOwogICAgICAgICAgICAgICAgbGFzdEF1dG9FeHBhbmQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJGVsZW1lbnQuYmluZCgnc2Nyb2xsJywgZGVib3VuY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgZWwgPSAkZWxlbWVudFswXTsKICAgICAgICAgICAgICAgIHZhciBkaXJlY3Rpb247CiAgICAgICAgICAgICAgICB2YXIgZGF0ZTsKCiAgICAgICAgICAgICAgICBpZiAoZWwuc2Nyb2xsTGVmdCA8IGxhc3RTY3JvbGxMZWZ0ICYmIGVsLnNjcm9sbExlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBkaXJlY3Rpb24gPSAnbGVmdCc7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9ICRzY29wZS5nYW50dC5jb2x1bW5zTWFuYWdlci5mcm9tOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbC5zY3JvbGxMZWZ0ID4gbGFzdFNjcm9sbExlZnQgJiYgZWwub2Zmc2V0V2lkdGggKyBlbC5zY3JvbGxMZWZ0ID49IGVsLnNjcm9sbFdpZHRoIC0gMSkgewogICAgICAgICAgICAgICAgICAgIGRpcmVjdGlvbiA9ICdyaWdodCc7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9ICRzY29wZS5nYW50dC5jb2x1bW5zTWFuYWdlci50bzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBsYXN0U2Nyb2xsTGVmdCA9IGVsLnNjcm9sbExlZnQ7CgogICAgICAgICAgICAgICAgaWYgKGRhdGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGF1dG9FeHBhbmRDb2x1bW5zKGVsLCBkYXRlLCBkaXJlY3Rpb24pOwogICAgICAgICAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuc2Nyb2xsLnJhaXNlLnNjcm9sbChlbC5zY3JvbGxMZWZ0LCBkYXRlLCBkaXJlY3Rpb24pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLnNjcm9sbC5yYWlzZS5zY3JvbGwoZWwuc2Nyb2xsTGVmdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDUpKTsKCiAgICAgICAgICAgICRzY29wZS5nZXRTY3JvbGxhYmxlQ3NzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgY3NzID0ge307CgogICAgICAgICAgICAgICAgaWYgKCRzY29wZS5nYW50dEVsZW1lbnRXaWR0aCAtICgkc2NvcGUuc2hvd0xhYmVsc0NvbHVtbiA/ICRzY29wZS5sYWJlbHNXaWR0aCA6IDApID4gJHNjb3BlLmdhbnR0LndpZHRoICsgc2Nyb2xsQmFyV2lkdGgpIHsKICAgICAgICAgICAgICAgICAgICBjc3Mud2lkdGggPSAkc2NvcGUuZ2FudHQud2lkdGggKyBzY3JvbGxCYXJXaWR0aCArICdweCc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCRzY29wZS5tYXhIZWlnaHQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY3NzWydtYXgtaGVpZ2h0J10gPSAkc2NvcGUubWF4SGVpZ2h0IC0gJHNjb3BlLmdhbnR0LmhlYWRlci5nZXRIZWlnaHQoKSArICdweCc7CiAgICAgICAgICAgICAgICAgICAgY3NzWydvdmVyZmxvdy15J10gPSAnYXV0byc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNzc1snb3ZlcmZsb3cteSddID0gJ2hpZGRlbic7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGNzczsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0U2Nyb2xsYWJsZScsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLmRlc3Ryb3koJ2dhbnR0U2Nyb2xsYWJsZScsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfTsKfV0pOwoKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRWZXJ0aWNhbFNjcm9sbFJlY2VpdmVyJywgZnVuY3Rpb24oKSB7CiAgICAvLyBUaGUgZWxlbWVudCB3aXRoIHRoaXMgYXR0cmlidXRlIHdpbGwgc2Nyb2xsIGF0IHRoZSBzYW1lIHRpbWUgYXMgdGhlIHNjcm9sbFNlbmRlciBlbGVtZW50CgogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0EnLAogICAgICAgIHJlcXVpcmU6ICdeZ2FudHRTY3JvbGxNYW5hZ2VyJywKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHNjb3BlLnNjcm9sbE1hbmFnZXIudmVydGljYWwucHVzaCgkZWxlbWVudFswXSk7CiAgICAgICAgfV0KICAgIH07Cn0pOwoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dEVsZW1lbnRXaWR0aExpc3RlbmVyJywgW2Z1bmN0aW9uKCkgewogICAgLy8gVXBkYXRlcyB0aGUgbGltaXQgZmlsdGVycyBpZiB0aGUgdXNlciBzY3JvbGxzIHRoZSBnYW50dCBjaGFydAoKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsICckYXR0cnMnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMpIHsKICAgICAgICAgICAgdmFyIHNjb3BlVmFyaWFibGUgPSAkYXR0cnMuZ2FudHRFbGVtZW50V2lkdGhMaXN0ZW5lcjsKICAgICAgICAgICAgaWYgKHNjb3BlVmFyaWFibGUgPT09ICcnKSB7CiAgICAgICAgICAgICAgICBzY29wZVZhcmlhYmxlID0gJ2dhbnR0RWxlbWVudFdpZHRoJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGVmZmVjdGl2ZVNjb3BlID0gJHNjb3BlOwoKICAgICAgICAgICAgd2hpbGUoc2NvcGVWYXJpYWJsZS5pbmRleE9mKCckcGFyZW50LicpID09PSAwKSB7CiAgICAgICAgICAgICAgICBzY29wZVZhcmlhYmxlID0gc2NvcGVWYXJpYWJsZS5zdWJzdHJpbmcoJyRwYXJlbnQuJy5sZW5ndGgpOwogICAgICAgICAgICAgICAgZWZmZWN0aXZlU2NvcGUgPSAkc2NvcGUuJHBhcmVudDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZWZmZWN0aXZlU2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZWZmZWN0aXZlU2NvcGVbc2NvcGVWYXJpYWJsZV0gPSAkZWxlbWVudFswXS5vZmZzZXRXaWR0aDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0Qm91bmRzJywgW2Z1bmN0aW9uKCkgewogICAgLy8gRGlzcGxheXMgYSBib3ggcmVwcmVzZW50aW5nIHRoZSBlYXJsaWVzdCBhbGxvd2FibGUgc3RhcnQgdGltZSBhbmQgbGF0ZXN0IGNvbXBsZXRpb24gdGltZSBmb3IgYSBqb2IKCiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgaWYgKHRBdHRycy50ZW1wbGF0ZVVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3RlbXBsYXRlL2RlZmF1bHQuYm91bmRzLnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHNjb3BlOiB7dGFzazogJz1uZ01vZGVsJ30sCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBjc3MgPSB7fTsKCiAgICAgICAgICAgICRzY29wZS4kd2F0Y2hHcm91cChbJ3Rhc2suZXN0JywgJ3Rhc2subGN0J10sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKCRzY29wZS50YXNrLmVzdCAhPT0gdW5kZWZpbmVkICYmICRzY29wZS50YXNrLmxjdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmJvdW5kcyA9IHt9OwogICAgICAgICAgICAgICAgICAgICRzY29wZS5ib3VuZHMubGVmdCA9ICRzY29wZS50YXNrLnJvd3NNYW5hZ2VyLmdhbnR0LmdldFBvc2l0aW9uQnlEYXRlKCRzY29wZS50YXNrLmVzdCk7CiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmJvdW5kcy53aWR0aCA9ICRzY29wZS50YXNrLnJvd3NNYW5hZ2VyLmdhbnR0LmdldFBvc2l0aW9uQnlEYXRlKCRzY29wZS50YXNrLmxjdCkgLSAkc2NvcGUuYm91bmRzLmxlZnQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICRzY29wZS5ib3VuZHMgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgJHNjb3BlLnRhc2suJGVsZW1lbnQuYmluZCgnbW91c2VlbnRlcicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUuaXNUYXNrTW91c2VPdmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICRzY29wZS50YXNrLiRlbGVtZW50LmJpbmQoJ21vdXNlbGVhdmUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmlzVGFza01vdXNlT3ZlciA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgJHNjb3BlLmdldENzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKCRzY29wZS5ib3VuZHMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGNzcy53aWR0aCA9ICRzY29wZS5ib3VuZHMud2lkdGggKyAncHgnOwoKICAgICAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLnRhc2suaXNNaWxlc3RvbmUgPT09IHRydWUgfHwgJHNjb3BlLnRhc2sud2lkdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3NzLmxlZnQgPSAoJHNjb3BlLmJvdW5kcy5sZWZ0IC0gKCRzY29wZS50YXNrLmxlZnQgLSAwLjMpKSArICdweCc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3NzLmxlZnQgPSAoJHNjb3BlLmJvdW5kcy5sZWZ0IC0gJHNjb3BlLnRhc2subGVmdCkgKyAncHgnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gY3NzOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJHNjb3BlLmdldENsYXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLnRhc2suZXN0ID09PSB1bmRlZmluZWQgfHwgJHNjb3BlLnRhc2subGN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ2dhbnR0LXRhc2stYm91bmRzLWluJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJHNjb3BlLnRhc2suZXN0ID4gJHNjb3BlLnRhc2suZnJvbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAnZ2FudHQtdGFzay1ib3VuZHMtb3V0JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKCRzY29wZS50YXNrLmxjdCA8ICRzY29wZS50YXNrLnRvKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdnYW50dC10YXNrLWJvdW5kcy1vdXQnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdnYW50dC10YXNrLWJvdW5kcy1pbic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAkc2NvcGUudGFzay5yb3dzTWFuYWdlci5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0Qm91bmRzJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUudGFzay5yb3dzTWFuYWdlci5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5kZXN0cm95KCdnYW50dEJvdW5kcycsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfTsKfV0pOwoKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRUYXNrUHJvZ3Jlc3MnLCBbZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVxdWlyZXM6ICdeZ2FudHRUYXNrJywKICAgICAgICB0ZW1wbGF0ZVVybDogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICAgICAgICBpZiAodEF0dHJzLnRlbXBsYXRlVXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAndGVtcGxhdGUvZGVmYXVsdC50YXNrUHJvZ3Jlc3MudG1wbC5odG1sJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0QXR0cnMudGVtcGxhdGVVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICRzY29wZS5nZXRDc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBjc3MgPSB7fTsKCiAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLnRhc2sucHJvZ3Jlc3MuY29sb3IpIHsKICAgICAgICAgICAgICAgICAgICBjc3NbJ2JhY2tncm91bmQtY29sb3InXSA9ICRzY29wZS50YXNrLnByb2dyZXNzLmNvbG9yOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjc3NbJ2JhY2tncm91bmQtY29sb3InXSA9ICcjNkJDNDQzJzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjc3Mud2lkdGggPSAkc2NvcGUudGFzay5wcm9ncmVzcy5wZXJjZW50ICsgJyUnOwoKICAgICAgICAgICAgICAgIHJldHVybiBjc3M7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAkc2NvcGUudGFzay5yb3dzTWFuYWdlci5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0VGFza1Byb2dyZXNzJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUudGFzay5yb3dzTWFuYWdlci5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5kZXN0cm95KCdnYW50dFRhc2tQcm9ncmVzcycsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfTsKfV0pOwoKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRUYXNrJywgW2Z1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcXVpcmU6ICdeZ2FudHRSb3cnLAogICAgICAgIHRlbXBsYXRlVXJsOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgICAgICAgIGlmICh0QXR0cnMudGVtcGxhdGVVcmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICd0ZW1wbGF0ZS9kZWZhdWx0LnRhc2sudG1wbC5odG1sJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0QXR0cnMudGVtcGxhdGVVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICRzY29wZS50YXNrLiRlbGVtZW50ID0gJGVsZW1lbnQ7CgogICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UubmV3KCdnYW50dFRhc2snLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5kZXN0cm95KCdnYW50dFRhc2snLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0VG9vbHRpcCcsIFsnJHRpbWVvdXQnLCAnJGRvY3VtZW50JywgJ2dhbnR0RGVib3VuY2UnLCAnZ2FudHRTbWFydEV2ZW50JywgZnVuY3Rpb24oJHRpbWVvdXQsICRkb2N1bWVudCwgZGVib3VuY2UsIHNtYXJ0RXZlbnQpIHsKICAgIC8vIFRoaXMgdG9vbHRpcCBkaXNwbGF5cyBtb3JlIGluZm9ybWF0aW9uIGFib3V0IGEgdGFzawoKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICB0ZW1wbGF0ZVVybDogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICAgICAgICBpZiAodEF0dHJzLnRlbXBsYXRlVXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAndGVtcGxhdGUvZGVmYXVsdC50b29sdGlwLnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICB2YXIgYm9keUVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoJGRvY3VtZW50WzBdLmJvZHkpOwogICAgICAgICAgICB2YXIgcGFyZW50RWxlbWVudCA9ICRlbGVtZW50LnBhcmVudCgpOwogICAgICAgICAgICB2YXIgc2hvd1Rvb2x0aXBQcm9taXNlOwogICAgICAgICAgICB2YXIgbW91c2VQb3NpdGlvblg7CgogICAgICAgICAgICAkc2NvcGUuY3NzID0ge307CgogICAgICAgICAgICAkc2NvcGUuJHdhdGNoKCdpc1Rhc2tNb3VzZU92ZXInLCBmdW5jdGlvbihuZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKHNob3dUb29sdGlwUHJvbWlzZSkgewogICAgICAgICAgICAgICAgICAgICR0aW1lb3V0LmNhbmNlbChzaG93VG9vbHRpcFByb21pc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG5ld1ZhbHVlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgc2hvd1Rvb2x0aXBQcm9taXNlID0gJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dUb29sdGlwKG1vdXNlUG9zaXRpb25YKTsKICAgICAgICAgICAgICAgICAgICB9LCA1MDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoISRzY29wZS50YXNrLmlzTW92aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhpZGVUb29sdGlwKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICRzY29wZS50YXNrLiRlbGVtZW50LmJpbmQoJ21vdXNlbW92ZScsIGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgICAgICAgbW91c2VQb3NpdGlvblggPSBldnQuY2xpZW50WDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAkc2NvcGUudGFzay4kZWxlbWVudC5iaW5kKCdtb3VzZWVudGVyJywgZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICRzY29wZS5tb3VzZUVudGVyWCA9IGV2dC5jbGllbnRYOwogICAgICAgICAgICAgICAgICAgICRzY29wZS5pc1Rhc2tNb3VzZU92ZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgJHNjb3BlLnRhc2suJGVsZW1lbnQuYmluZCgnbW91c2VsZWF2ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUubW91c2VFbnRlclggPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmlzVGFza01vdXNlT3ZlciA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIG1vdXNlTW92ZUhhbmRsZXIgPSBzbWFydEV2ZW50KCRzY29wZSwgYm9keUVsZW1lbnQsICdtb3VzZW1vdmUnLCBkZWJvdW5jZShmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVUb29sdGlwKGUuY2xpZW50WCk7CiAgICAgICAgICAgIH0sIDUsIGZhbHNlKSk7CgogICAgICAgICAgICAkc2NvcGUuJHdhdGNoKCd0YXNrLmlzTW92aW5nJywgZnVuY3Rpb24obmV3VmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChuZXdWYWx1ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIG1vdXNlTW92ZUhhbmRsZXIuYmluZCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXdWYWx1ZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICBtb3VzZU1vdmVIYW5kbGVyLnVuYmluZCgpOwogICAgICAgICAgICAgICAgICAgIGhpZGVUb29sdGlwKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIGdldFZpZXdQb3J0V2lkdGggPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBkID0gJGRvY3VtZW50WzBdOwogICAgICAgICAgICAgICAgcmV0dXJuIGQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoIHx8IGQuZG9jdW1lbnRFbGVtZW50LmdldEVsZW1lbnRCeUlkKCdib2R5JylbMF0uY2xpZW50V2lkdGg7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgc2hvd1Rvb2x0aXAgPSBmdW5jdGlvbih4KSB7CiAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB1cGRhdGVUb29sdGlwKHgpOwoKICAgICAgICAgICAgICAgICAgICAkc2NvcGUuY3NzLnRvcCA9IHBhcmVudEVsZW1lbnRbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wICsgJ3B4JzsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUuY3NzLm1hcmdpblRvcCA9IC0kZWxlbWVudFswXS5vZmZzZXRIZWlnaHQgLSA4ICsgJ3B4JzsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUuY3NzLm9wYWNpdHkgPSAxOwogICAgICAgICAgICAgICAgfSwgMCwgdHJ1ZSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgdXBkYXRlVG9vbHRpcCA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGluZm8gaXMgb3ZlcmxhcHBpbmcgd2l0aCB2aWV3IHBvcnQKICAgICAgICAgICAgICAgIGlmICh4ICsgJGVsZW1lbnRbMF0ub2Zmc2V0V2lkdGggPiBnZXRWaWV3UG9ydFdpZHRoKCkpIHsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUuY3NzLmxlZnQgPSAoeCArIDIwIC0gJGVsZW1lbnRbMF0ub2Zmc2V0V2lkdGgpICsgJ3B4JzsKICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcygnZ2FudHQtdGFzay1pbmZvQXJyb3dSJyk7IC8vIFJpZ2h0IGFsaWduZWQgaW5mbwogICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnJlbW92ZUNsYXNzKCdnYW50dC10YXNrLWluZm9BcnJvdycpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkc2NvcGUuY3NzLmxlZnQgPSAoeCAtIDIwKSArICdweCc7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoJ2dhbnR0LXRhc2staW5mb0Fycm93Jyk7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQucmVtb3ZlQ2xhc3MoJ2dhbnR0LXRhc2staW5mb0Fycm93UicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGhpZGVUb29sdGlwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuY3NzLm9wYWNpdHkgPSAwOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLm5ldygnZ2FudHRUb29sdGlwJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UuZGVzdHJveSgnZ2FudHRUb29sdGlwJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dEJvZHknLCBbZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVxdWlyZTogJ15nYW50dCcsCiAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHRlbXBsYXRlVXJsOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgICAgICAgIGlmICh0QXR0cnMudGVtcGxhdGVVcmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICd0ZW1wbGF0ZS9kZWZhdWx0LmJvZHkudG1wbC5odG1sJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0QXR0cnMudGVtcGxhdGVVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICAkc2NvcGUuZ2FudHQuYm9keS4kZWxlbWVudCA9ICRlbGVtZW50OwoKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLm5ldygnZ2FudHRCb2R5JywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UuZGVzdHJveSgnZ2FudHRCb2R5JywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dEJvZHlDb2x1bW5zJywgW2Z1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcXVpcmU6ICdeZ2FudHRCb2R5JywKICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgaWYgKHRBdHRycy50ZW1wbGF0ZVVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3RlbXBsYXRlL2RlZmF1bHQuYm9keUNvbHVtbnMudG1wbC5odG1sJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0QXR0cnMudGVtcGxhdGVVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICAkc2NvcGUuZ2FudHQuYm9keS5jb2x1bW5zLiRlbGVtZW50ID0gJGVsZW1lbnQ7CgogICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UubmV3KCdnYW50dEJvZHlDb2x1bW5zJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UuZGVzdHJveSgnZ2FudHRCb2R5Q29sdW1ucycsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfTsKfV0pOwoKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRCb2R5Um93cycsIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXF1aXJlOiAnXmdhbnR0Qm9keScsCiAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHRlbXBsYXRlVXJsOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgICAgICAgIGlmICh0QXR0cnMudGVtcGxhdGVVcmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICd0ZW1wbGF0ZS9kZWZhdWx0LmJvZHlSb3dzLnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmJvZHkucm93cy4kZWxlbWVudCA9ICRlbGVtZW50OwoKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLm5ldygnZ2FudHRCb2R5Um93cycsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLmRlc3Ryb3koJ2dhbnR0Qm9keVJvd3MnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0Q29sdW1uJywgW2Z1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcXVpcmU6ICdeZ2FudHRCb2R5Q29sdW1ucycsCiAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHRlbXBsYXRlVXJsOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgICAgICAgIGlmICh0QXR0cnMudGVtcGxhdGVVcmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICd0ZW1wbGF0ZS9kZWZhdWx0LmNvbHVtbi50bXBsLmh0bWwnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRBdHRycy50ZW1wbGF0ZVVybDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICRzY29wZS5jb2x1bW4uJGVsZW1lbnQgPSAkZWxlbWVudDsKCiAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0Q29sdW1uJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UuZGVzdHJveSgnZ2FudHRDb2x1bW4nLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0Q29sdW1uSGVhZGVyJywgW2Z1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICB0ZW1wbGF0ZVVybDogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICAgICAgICBpZiAodEF0dHJzLnRlbXBsYXRlVXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAndGVtcGxhdGUvZGVmYXVsdC5jb2x1bW5IZWFkZXIudG1wbC5odG1sJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0QXR0cnMudGVtcGxhdGVVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UubmV3KCdnYW50dENvbHVtbkhlYWRlcicsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLmRlc3Ryb3koJ2dhbnR0Q29sdW1uSGVhZGVyJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dEhlYWRlcicsIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXF1aXJlOiAnXmdhbnR0JywKICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgaWYgKHRBdHRycy50ZW1wbGF0ZVVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3RlbXBsYXRlL2RlZmF1bHQuaGVhZGVyLnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmhlYWRlci4kZWxlbWVudCA9ICRlbGVtZW50OwoKICAgICAgICAgICAgJHNjb3BlLmdldEhlYWRlckNzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGNzcyA9IHt9OwoKICAgICAgICAgICAgICAgIGlmICgkc2NvcGUuZ2FudHRFbGVtZW50V2lkdGggLSAoJHNjb3BlLnNob3dMYWJlbHNDb2x1bW4gPyAkc2NvcGUubGFiZWxzV2lkdGggOiAwKSA+ICRzY29wZS5nYW50dC53aWR0aCkgewogICAgICAgICAgICAgICAgICAgIGNzcy53aWR0aCA9ICRzY29wZS5nYW50dC53aWR0aCArICdweCc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGNzczsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5uZXcoJ2dhbnR0SGVhZGVyJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UuZGVzdHJveSgnZ2FudHRIZWFkZXInLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0SGVhZGVyQ29sdW1ucycsIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXF1aXJlOiAnXmdhbnR0SGVhZGVyJywKICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgaWYgKHRBdHRycy50ZW1wbGF0ZVVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3RlbXBsYXRlL2RlZmF1bHQuaGVhZGVyQ29sdW1ucy50bXBsLmh0bWwnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRBdHRycy50ZW1wbGF0ZVVybDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICRzY29wZS5nYW50dC5oZWFkZXIuY29sdW1ucy4kZWxlbWVudCA9ICRlbGVtZW50OwoKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLm5ldygnZ2FudHRIZWFkZXJDb2x1bW5zJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UuZGVzdHJveSgnZ2FudHRIZWFkZXJDb2x1bW5zJywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dExhYmVscycsIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXF1aXJlOiAnXmdhbnR0JywKICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgaWYgKHRBdHRycy50ZW1wbGF0ZVVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3RlbXBsYXRlL2RlZmF1bHQubGFiZWxzLnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmxhYmVscy4kZWxlbWVudCA9ICRlbGVtZW50OwoKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLm5ldygnZ2FudHRMYWJlbHMnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5kZXN0cm95KCdnYW50dExhYmVscycsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfTsKfV0pOwoKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRSb3cnLCBbZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVxdWlyZTogJ15nYW50dEJvZHknLAogICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICB0ZW1wbGF0ZVVybDogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICAgICAgICBpZiAodEF0dHJzLnRlbXBsYXRlVXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAndGVtcGxhdGUvZGVmYXVsdC5yb3cudG1wbC5odG1sJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0QXR0cnMudGVtcGxhdGVVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICAkc2NvcGUucm93LiRlbGVtZW50ID0gJGVsZW1lbnQ7CgogICAgICAgICAgICAkc2NvcGUuZ2FudHQuYXBpLmRpcmVjdGl2ZXMucmFpc2UubmV3KCdnYW50dFJvdycsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLmRlc3Ryb3koJ2dhbnR0Um93JywgJHNjb3BlLCAkZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dCiAgICB9Owp9XSk7CgoKZ2FudHQuZGlyZWN0aXZlKCdnYW50dFJvd0hlYWRlcicsIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgaWYgKHRBdHRycy50ZW1wbGF0ZVVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3RlbXBsYXRlL2RlZmF1bHQucm93SGVhZGVyLnRtcGwuaHRtbCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdEF0dHJzLnRlbXBsYXRlVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LnJvd0hlYWRlci4kZWxlbWVudCA9ICRlbGVtZW50OwoKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLm5ldygnZ2FudHRSb3dIZWFkZXInLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5kZXN0cm95KCdnYW50dFJvd0hlYWRlcicsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfTsKfV0pOwoKCmdhbnR0LmRpcmVjdGl2ZSgnZ2FudHRSb3dMYWJlbCcsIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgdGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgaWYgKHRBdHRycy50ZW1wbGF0ZVVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3RlbXBsYXRlL2RlZmF1bHQucm93TGFiZWwudG1wbC5odG1sJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0QXR0cnMudGVtcGxhdGVVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewoKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLm5ldygnZ2FudHRSb3dMYWJlbCcsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLmRlc3Ryb3koJ2dhbnR0Um93TGFiZWwnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0VGltZUZyYW1lJywgW2Z1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcXVpcmU6ICdeZ2FudHRDb2x1bW4nLAogICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICB0ZW1wbGF0ZVVybDogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICAgICAgICBpZiAodEF0dHJzLnRlbXBsYXRlVXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAndGVtcGxhdGUvZGVmYXVsdC50aW1lRnJhbWUudG1wbC5odG1sJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0QXR0cnMudGVtcGxhdGVVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICAkc2NvcGUudGltZUZyYW1lLiRlbGVtZW50ID0gJGVsZW1lbnQ7CgogICAgICAgICAgICAkc2NvcGUuZ2V0Q2xhc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBjbGFzc2VzID0gWydnYW50dC10aW1lZnJhbWUnICsgKCRzY29wZS50aW1lRnJhbWUud29ya2luZyA/ICcnIDogJy1ub24nKSArICctd29ya2luZyddOwoKICAgICAgICAgICAgICAgIGlmICgkc2NvcGUudGltZUZyYW1lLmNsYXNzZXMpIHsKICAgICAgICAgICAgICAgICAgICBjbGFzc2VzID0gY2xhc3Nlcy5jb25jYXQoJHNjb3BlLnRpbWVGcmFtZS5jbGFzc2VzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjbGFzc2VzOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJHNjb3BlLmdhbnR0LmFwaS5kaXJlY3RpdmVzLnJhaXNlLm5ldygnZ2FudHRUaW1lRnJhbWUnLCAkc2NvcGUsICRlbGVtZW50KTsKICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS5nYW50dC5hcGkuZGlyZWN0aXZlcy5yYWlzZS5kZXN0cm95KCdnYW50dFRpbWVGcmFtZScsICRzY29wZSwgJGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgfV0KICAgIH07Cn1dKTsKCgpnYW50dC5mYWN0b3J5KCdnYW50dERlYm91bmNlJywgWyckdGltZW91dCcsIGZ1bmN0aW9uKCR0aW1lb3V0KSB7CiAgICBmdW5jdGlvbiBkZWJvdW5jZShmbiwgdGltZW91dCwgaW52b2tlQXBwbHkpIHsKICAgICAgICB2YXIgbnRoQ2FsbCA9IDA7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgIHZhciBhcmd6ID0gYXJndW1lbnRzOwogICAgICAgICAgICBudGhDYWxsKys7CiAgICAgICAgICAgIHZhciBsYXRlciA9IChmdW5jdGlvbih2ZXJzaW9uKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHZlcnNpb24gPT09IG50aENhbGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3opOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pKG50aENhbGwpOwogICAgICAgICAgICByZXR1cm4gJHRpbWVvdXQobGF0ZXIsIHRpbWVvdXQsIGludm9rZUFwcGx5ID09PSB1bmRlZmluZWQgPyB0cnVlOiBpbnZva2VBcHBseSk7CiAgICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gZGVib3VuY2U7Cn1dKTsKCmdhbnR0LnNlcnZpY2UoJ2dhbnR0RW5hYmxlTmdBbmltYXRlJywgWyckaW5qZWN0b3InLCBmdW5jdGlvbigkaW5qZWN0b3IpIHsKICAgIHZhciBuZ0FuaW1hdGU7CiAgICB0cnkgewogICAgICAgIG5nQW5pbWF0ZSA9ICRpbmplY3Rvci5nZXQoJyRhbmltYXRlJyk7CiAgICB9IGNhdGNoIChlKSB7CiAgICB9CgogICAgaWYgKG5nQW5pbWF0ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGVuYWJsZWQsIGVsZW1lbnQpIHsKICAgICAgICAgICAgbmdBbmltYXRlLmVuYWJsZWQoZmFsc2UsIGVsZW1lbnQpOwogICAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHt9OwogICAgfQoKCn1dKTsKCgpnYW50dC5zZXJ2aWNlKCdnYW50dExheW91dCcsIFsnJGRvY3VtZW50JywgZnVuY3Rpb24oJGRvY3VtZW50KSB7CiAgICByZXR1cm4gewogICAgICAgIC8qKgogICAgICAgICAqIENvbXB1dGUgdGhlIHdpZHRoIG9mIHNjcm9sbGJhci4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IHdpZHRoIG9mIHRoZSBzY3JvbGxiYXIsIGluIHB4LgogICAgICAgICAqLwogICAgICAgIGdldFNjcm9sbEJhcldpZHRoOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGlubmVyID0gJGRvY3VtZW50WzBdLmNyZWF0ZUVsZW1lbnQoJ3AnKTsKICAgICAgICAgICAgaW5uZXIuc3R5bGUud2lkdGggPSAnMTAwJSc7CiAgICAgICAgICAgIGlubmVyLnN0eWxlLmhlaWdodCA9ICcyMDBweCc7CgogICAgICAgICAgICB2YXIgb3V0ZXIgPSAkZG9jdW1lbnRbMF0uY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIG91dGVyLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgICAgICAgb3V0ZXIuc3R5bGUudG9wID0gJzBweCc7CiAgICAgICAgICAgIG91dGVyLnN0eWxlLmxlZnQgPSAnMHB4JzsKICAgICAgICAgICAgb3V0ZXIuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwogICAgICAgICAgICBvdXRlci5zdHlsZS53aWR0aCA9ICcyMDBweCc7CiAgICAgICAgICAgIG91dGVyLnN0eWxlLmhlaWdodCA9ICcxNTBweCc7CiAgICAgICAgICAgIG91dGVyLnN0eWxlLm92ZXJmbG93ID0gJ2hpZGRlbic7CiAgICAgICAgICAgIG91dGVyLmFwcGVuZENoaWxkIChpbm5lcik7CgogICAgICAgICAgICAkZG9jdW1lbnRbMF0uYm9keS5hcHBlbmRDaGlsZCAob3V0ZXIpOwogICAgICAgICAgICB2YXIgdzEgPSBpbm5lci5vZmZzZXRXaWR0aDsKICAgICAgICAgICAgb3V0ZXIuc3R5bGUub3ZlcmZsb3cgPSAnc2Nyb2xsJzsKICAgICAgICAgICAgdmFyIHcyID0gaW5uZXIub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgIGlmICh3MSA9PT0gdzIpIHsKICAgICAgICAgICAgICAgIHcyID0gb3V0ZXIuY2xpZW50V2lkdGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJGRvY3VtZW50WzBdLmJvZHkucmVtb3ZlQ2hpbGQgKG91dGVyKTsKCiAgICAgICAgICAgIHJldHVybiAodzEgLSB3Mik7CiAgICAgICAgfSwKCiAgICAgICAgc2V0Q29sdW1uc1dpZHRoOiBmdW5jdGlvbih3aWR0aCwgb3JpZ2luYWxXaWR0aCwgY29sdW1ucykgewogICAgICAgICAgICBpZiAod2lkdGggJiYgb3JpZ2luYWxXaWR0aCAmJiBjb2x1bW5zKSB7CgogICAgICAgICAgICAgICAgdmFyIHdpZHRoRmFjdG9yID0gTWF0aC5hYnMod2lkdGggLyBvcmlnaW5hbFdpZHRoKTsKCiAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goY29sdW1ucywgZnVuY3Rpb24oY29sdW1uKSB7CiAgICAgICAgICAgICAgICAgICAgY29sdW1uLmxlZnQgPSB3aWR0aEZhY3RvciAqIGNvbHVtbi5vcmlnaW5hbFNpemUubGVmdDsKICAgICAgICAgICAgICAgICAgICBjb2x1bW4ud2lkdGggPSB3aWR0aEZhY3RvciAqIGNvbHVtbi5vcmlnaW5hbFNpemUud2lkdGg7CgogICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChjb2x1bW4udGltZUZyYW1lcywgZnVuY3Rpb24odGltZUZyYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZS5sZWZ0ID0gd2lkdGhGYWN0b3IgKiB0aW1lRnJhbWUub3JpZ2luYWxTaXplLmxlZnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGcmFtZS53aWR0aCA9IHdpZHRoRmFjdG9yICogdGltZUZyYW1lLm9yaWdpbmFsU2l6ZS53aWR0aDsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKfV0pOwoKCmdhbnR0LnNlcnZpY2UoJ2dhbnR0TW91c2VCdXR0b24nLCBbIGZ1bmN0aW9uKCkgewogICAgLy8gTW91c2UgYnV0dG9uIGNyb3NzIGJyb3dzZXIgbm9ybWFsaXphdGlvbgoKICAgIHJldHVybiB7CiAgICAgICAgZ2V0QnV0dG9uOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIGUgPSBlIHx8IHdpbmRvdy5ldmVudDsKCiAgICAgICAgICAgIGlmICghZS53aGljaCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGUuYnV0dG9uIDwgMiA/IDEgOiBlLmJ1dHRvbiA9PT0gNCA/IDIgOiAzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGUud2hpY2g7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9XSk7CgpnYW50dC5zZXJ2aWNlKCdnYW50dE1vdXNlT2Zmc2V0JywgWyBmdW5jdGlvbigpIHsKICAgIC8vIE1vdXNlIG9mZnNldCBzdXBwb3J0IGZvciBsZXNzZXIgYnJvd3NlcnMgKHJlYWQgSUUgOCkKCiAgICByZXR1cm4gewogICAgICAgIGdldE9mZnNldDogZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICAgIGlmIChldnQub2Zmc2V0WCAmJiBldnQub2Zmc2V0WSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsgeDogZXZ0Lm9mZnNldFgsIHk6IGV2dC5vZmZzZXRZIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV2dC5sYXllclggJiYgZXZ0LmxheWVyWSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsgeDogZXZ0LmxheWVyWCwgeTogZXZ0LmxheWVyWSB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0T2Zmc2V0Rm9yRWxlbWVudChldnQudGFyZ2V0LCBldnQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBnZXRPZmZzZXRGb3JFbGVtZW50OiBmdW5jdGlvbihlbCwgZXZ0KSB7CiAgICAgICAgICAgIHZhciBiYiA9IGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICByZXR1cm4geyB4OiBldnQuY2xpZW50WCAtIGJiLmxlZnQsIHk6IGV2dC5jbGllbnRZIC0gYmIudG9wIH07CiAgICAgICAgfQogICAgfTsKfV0pOwoKZ2FudHQuZmFjdG9yeSgnZ2FudHRTbWFydEV2ZW50JywgW2Z1bmN0aW9uKCkgewogICAgLy8gQXV0byByZWxlYXNlZCB0aGUgYmluZGluZyB3aGVuIHRoZSBzY29wZSBpcyBkZXN0cm95ZWQuIFVzZSBpZiBhbiBldmVudCBpcyByZWdpc3RlcmVkIG9uIGFub3RoZXIgZWxlbWVudCB0aGFuIHRoZSBzY29wZS4KCiAgICBmdW5jdGlvbiBzbWFydEV2ZW50KCRzY29wZSwgJGVsZW1lbnQsIGV2ZW50LCBmbikgewogICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRlbGVtZW50LnVuYmluZChldmVudCwgZm4pOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBiaW5kT25jZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5vbmUoZXZlbnQsIGZuKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYmluZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5iaW5kKGV2ZW50LCBmbik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuYmluZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC51bmJpbmQoZXZlbnQsIGZuKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgogICAgcmV0dXJuIHNtYXJ0RXZlbnQ7Cn1dKTsKYW5ndWxhci5tb2R1bGUoJ2dhbnR0VGVtcGxhdGVzJywgW10pLnJ1bihbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKICAgICR0ZW1wbGF0ZUNhY2hlLnB1dCgndGVtcGxhdGUvZGVmYXVsdC5nYW50dC50bXBsLmh0bWwnLAogICAgICAgICc8ZGl2IGNsYXNzPSJnYW50dCB1bnNlbGVjdGFibGUiIG5nLWNsb2FrIGdhbnR0LXNjcm9sbC1tYW5hZ2VyIGdhbnR0LWVsZW1lbnQtd2lkdGgtbGlzdGVuZXI+XG4nICsKICAgICAgICAnICAgIDxnYW50dC1sYWJlbHM+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IGNsYXNzPSJnYW50dC1sYWJlbHMtaGVhZGVyIj5cbicgKwogICAgICAgICcgICAgICAgICAgICA8Z2FudHQtcm93LWhlYWRlcj48L2dhbnR0LXJvdy1oZWFkZXI+XG4nICsKICAgICAgICAnICAgICAgICA8L2Rpdj5cbicgKwogICAgICAgICcgICAgICAgIDxkaXYgY2xhc3M9ImdhbnR0LWxhYmVscy1ib2R5IlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBuZy1zdHlsZT0iKG1heEhlaWdodCA+IDAgJiYge1wnbWF4LWhlaWdodFwnOiAobWF4SGVpZ2h0IC0gZ2FudHQuaGVhZGVyLmdldEhlaWdodCgpKStcJ3B4XCd9IHx8IHt9KSJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctc2hvdz0iZ2FudHQuY29sdW1uc01hbmFnZXIuY29sdW1ucy5sZW5ndGggPiAwIj5cbicgKwogICAgICAgICcgICAgICAgICAgICA8ZGl2IGdhbnR0LXZlcnRpY2FsLXNjcm9sbC1yZWNlaXZlciBzdHlsZT0icG9zaXRpb246IHJlbGF0aXZlIj5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgPGdhbnR0LXJvdy1sYWJlbCBuZy1yZXBlYXQ9InJvdyBpbiBnYW50dC5yb3dzTWFuYWdlci52aXNpYmxlUm93cyB0cmFjayBieSAkaW5kZXgiPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImdhbnR0LWxhYmVscy10ZXh0Ij57eyByb3cubmFtZSB9fTwvc3Bhbj5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgPC9nYW50dC1yb3ctbGFiZWw+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPC9kaXY+XG4nICsKICAgICAgICAnICAgICAgICA8L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9nYW50dC1sYWJlbHM+XG4nICsKICAgICAgICAnICAgIDxnYW50dC1oZWFkZXI+XG4nICsKICAgICAgICAnICAgICAgICA8Z2FudHQtaGVhZGVyLWNvbHVtbnM+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPGRpdiBuZy1yZXBlYXQ9ImhlYWRlciBpbiBnYW50dC5jb2x1bW5zTWFuYWdlci52aXNpYmxlSGVhZGVycyI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImdhbnR0LWhlYWRlci1yb3cgZ2FudHQtaGVhZGVyLXJvdy1ib3R0b20iPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgPGdhbnR0LWNvbHVtbi1oZWFkZXIgbmctcmVwZWF0PSJjb2x1bW4gaW4gaGVhZGVyIHRyYWNrIGJ5ICRpbmRleCI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgICAgICAgICAge3sgY29sdW1uLmxhYmVsIH19XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgICAgICA8L2dhbnR0LWNvbHVtbi1oZWFkZXI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgIDwvZGl2PlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDwvZGl2PlxuJyArCiAgICAgICAgJyAgICAgICAgPC9nYW50dC1oZWFkZXItY29sdW1ucz5cbicgKwogICAgICAgICcgICAgPC9nYW50dC1oZWFkZXI+XG4nICsKICAgICAgICAnICAgIDxnYW50dC1zY3JvbGxhYmxlPlxuJyArCiAgICAgICAgJyAgICAgICAgPGdhbnR0LWJvZHk+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPGRpdiBjbGFzcz0iZ2FudHQtYm9keS1iYWNrZ3JvdW5kIj5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZ2FudHQtcm93LWhlaWdodCJcbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgICBuZy1jbGFzcy1vZGQ9IlwnZ2FudHQtYmFja2dyb3VuZC1yb3dcJyJcbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgICBuZy1jbGFzcy1ldmVuPSJcJ2dhbnR0LWJhY2tncm91bmQtcm93LWFsdFwnIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgIG5nLWNsYXNzPSJyb3cuY2xhc3NlcyJcbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgICBuZy1zdHlsZT0ie1wnYmFja2dyb3VuZC1jb2xvclwnOiByb3cuY29sb3IsIFwnaGVpZ2h0XCc6IHJvdy5oZWlnaHR9IlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgIG5nLXJlcGVhdD0icm93IGluIGdhbnR0LnJvd3NNYW5hZ2VyLnZpc2libGVSb3dzIHRyYWNrIGJ5ICRpbmRleCI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgIDwvZGl2PlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDwvZGl2PlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDxkaXYgY2xhc3M9ImdhbnR0LWJvZHktZm9yZWdyb3VuZCI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImdhbnR0LWN1cnJlbnQtZGF0ZS1saW5lIiBuZy1pZj0iY3VycmVudERhdGUgPT09IFwnbGluZVwnICYmIGdhbnR0LmN1cnJlbnREYXRlTWFuYWdlci5wb3NpdGlvbiA+PSAwICYmIGdhbnR0LmN1cnJlbnREYXRlTWFuYWdlci5wb3NpdGlvbiA8PSBnYW50dC53aWR0aCIgbmctc3R5bGU9IntcJ2xlZnRcJzogZ2FudHQuY3VycmVudERhdGVNYW5hZ2VyLnBvc2l0aW9uICsgXCdweFwnIH0iPjwvZGl2PlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDwvZGl2PlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDxnYW50dC1ib2R5LWNvbHVtbnMgY2xhc3M9ImdhbnR0LWJvZHktY29sdW1ucyI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgIDxnYW50dC1jb2x1bW4gbmctcmVwZWF0PSJjb2x1bW4gaW4gZ2FudHQuY29sdW1uc01hbmFnZXIudmlzaWJsZUNvbHVtbnMgdHJhY2sgYnkgJGluZGV4Ij5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgIDxnYW50dC10aW1lLWZyYW1lIG5nLXJlcGVhdD0idGltZUZyYW1lIGluIGNvbHVtbi52aXNpYmxlVGltZUZyYW1lcyI+PC9nYW50dC10aW1lLWZyYW1lPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICA8L2dhbnR0LWNvbHVtbj5cbicgKwogICAgICAgICcgICAgICAgICAgICA8L2dhbnR0LWJvZHktY29sdW1ucz5cbicgKwogICAgICAgICcgICAgICAgICAgICA8Z2FudHQtYm9keS1yb3dzPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJnYW50dC10aW1lc3BhbiJcbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgICBuZy1zdHlsZT0ie1wnbGVmdFwnOiAoKHRpbWVzcGFuLmxlZnQtMC4zKSB8fCB0aW1lc3Bhbi5sZWZ0KStcJ3B4XCcsIFwnd2lkdGhcJzogdGltZXNwYW4ud2lkdGggK1wncHhcJywgXCd6LWluZGV4XCc6ICh0aW1lc3Bhbi5wcmlvcml0eSB8fCAwKX0iXG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgICAgICAgbmctY2xhc3M9InRpbWVzcGFuLmNsYXNzZXMiXG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgICAgICAgbmctcmVwZWF0PSJ0aW1lc3BhbiBpbiBnYW50dC50aW1lc3BhbnNNYW5hZ2VyLnRpbWVzcGFucyI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgICAgICA8Z2FudHQtdG9vbHRpcCBuZy1tb2RlbD0idGltZXNwYW4iIGRhdGUtZm9ybWF0PSJcJ01NTSBkXCciPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImdhbnR0LXRhc2stY29udGVudCI+PHNwYW4+e3sgdGltZXNwYW4ubmFtZSB9fTwvc3Bhbj48L2Rpdj5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgIDwvZ2FudHQtdG9vbHRpcD5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgPC9kaXY+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgIDxnYW50dC1yb3cgbmctcmVwZWF0PSJyb3cgaW4gZ2FudHQucm93c01hbmFnZXIudmlzaWJsZVJvd3MgdHJhY2sgYnkgJGluZGV4Ij5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICAgIDxnYW50dC10YXNrIG5nLXJlcGVhdD0idGFzayBpbiByb3cudmlzaWJsZVRhc2tzIHRyYWNrIGJ5IHRhc2suaWQiPjwvZ2FudHQtdGFzaz5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgPC9nYW50dC1yb3c+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPC9nYW50dC1ib2R5LXJvd3M+XG4nICsKICAgICAgICAnICAgICAgICA8L2dhbnR0LWJvZHk+XG4nICsKICAgICAgICAnICAgIDwvZ2FudHQtc2Nyb2xsYWJsZT5cbicgKwogICAgICAgICdcbicgKwogICAgICAgICcgICAgPCEtLSBQbHVnaW5zIC0tPlxuJyArCiAgICAgICAgJyAgICA8bmctdHJhbnNjbHVkZT48L25nLXRyYW5zY2x1ZGU+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS1cbicgKwogICAgICAgICcgICAgKioqKioqKiBJbmxpbmUgdGVtcGxhdGVzICoqKioqKipcbicgKwogICAgICAgICcgICAgWW91IGNhbiBzcGVjaWZ5IHlvdXIgb3duIHRlbXBsYXRlcyBieSBlaXRoZXIgY2hhbmdpbmcgdGhlIGRlZmF1bHQgb25lcyBiZWxvdyBvciBieVxuJyArCiAgICAgICAgJyAgICBhZGRpbmcgYW4gYXR0cmlidXRlIHRlbXBsYXRlLXVybD0iPHVybCB0byB5b3VyIHRlbXBsYXRlPiIgb24gdGhlIHNwZWNpZmljIGVsZW1lbnQuXG4nICsKICAgICAgICAnICAgIC0tPlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8IS0tIEJvZHkgdGVtcGxhdGUgLS0+XG4nICsKICAgICAgICAnICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlL2RlZmF1bHQuYm9keS50bXBsLmh0bWwiPlxuJyArCiAgICAgICAgJyAgICAgICAgPGRpdiBuZy10cmFuc2NsdWRlIGNsYXNzPSJnYW50dC1ib2R5IlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBuZy1zdHlsZT0ie1wnd2lkdGhcJzogZ2FudHQud2lkdGggK1wncHhcJ30iPjwvZGl2PlxuJyArCiAgICAgICAgJyAgICA8L3NjcmlwdD5cbicgKwogICAgICAgICdcbicgKwogICAgICAgICcgICAgPCEtLSBIZWFkZXIgdGVtcGxhdGUgLS0+XG4nICsKICAgICAgICAnICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlL2RlZmF1bHQuaGVhZGVyLnRtcGwuaHRtbCI+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IG5nLXRyYW5zY2x1ZGUgY2xhc3M9ImdhbnR0LWhlYWRlciJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctc2hvdz0iZ2FudHQuY29sdW1uc01hbmFnZXIuY29sdW1ucy5sZW5ndGggPiAwICYmIGdhbnR0LmNvbHVtbnNNYW5hZ2VyLmdldEFjdGl2ZUhlYWRlcnNDb3VudCgpID4gMCJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctc3R5bGU9ImdldEhlYWRlckNzcygpIj48L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS0gUm93IGxhYmVsIHRlbXBsYXRlIC0tPlxuJyArCiAgICAgICAgJyAgICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSJ0ZW1wbGF0ZS9kZWZhdWx0LnJvd0xhYmVsLnRtcGwuaHRtbCI+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IG5nLXRyYW5zY2x1ZGUgY2xhc3M9ImdhbnR0LWxhYmVscy1yb3cgZ2FudHQtcm93LWhlaWdodCJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctY2xhc3Mtb2RkPSJcJ2dhbnR0LWJhY2tncm91bmQtcm93XCciXG4nICsKICAgICAgICAnICAgICAgICAgICAgIG5nLWNsYXNzLWV2ZW49IlwnZ2FudHQtYmFja2dyb3VuZC1yb3ctYWx0XCciXG4nICsKICAgICAgICAnICAgICAgICAgICAgIG5nLWNsYXNzPSJyb3cuY2xhc3NlcyIgbmctc3R5bGU9IntcJ2JhY2tncm91bmQtY29sb3JcJzogcm93LmNvbG9yLCBcJ2hlaWdodFwnOiByb3cuaGVpZ2h0fSI+XG4nICsKICAgICAgICAnICAgICAgICA8L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS0gUm93IGhlYWRlciB0ZW1wbGF0ZSAtLT5cbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC5yb3dIZWFkZXIudG1wbC5odG1sIj5cbicgKwogICAgICAgICcgICAgICAgIDxkaXYgY2xhc3M9ImdhbnR0LWxhYmVscy1oZWFkZXItcm93IlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBuZy1zaG93PSJnYW50dC5jb2x1bW5zTWFuYWdlci5jb2x1bW5zLmxlbmd0aCA+IDAgJiYgZ2FudHQuY29sdW1uc01hbmFnZXIuZ2V0QWN0aXZlSGVhZGVyc0NvdW50KCkgPiAwIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBuZy1zdHlsZT0ie1wnbWFyZ2luLXRvcFwnOiAoKGdhbnR0LmNvbHVtbnNNYW5hZ2VyLmdldEFjdGl2ZUhlYWRlcnNDb3VudCgpLTEpKjIpK1wnZW1cJ30iPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDxzcGFuPk5hbWU8L3NwYW4+XG4nICsKICAgICAgICAnICAgICAgICA8L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS0gTGFiZWxzIHRlbXBsYXRlIC0tPlxuJyArCiAgICAgICAgJyAgICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSJ0ZW1wbGF0ZS9kZWZhdWx0LmxhYmVscy50bXBsLmh0bWwiPlxuJyArCiAgICAgICAgJyAgICAgICAgPGRpdiBuZy10cmFuc2NsdWRlIG5nLWlmPSJzaG93TGFiZWxzQ29sdW1uIiBjbGFzcz0iZ2FudHQtbGFiZWxzIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBuZy1zdHlsZT0iKGxhYmVsc1dpZHRoID4gMCAmJiB7XCd3aWR0aFwnOiBsYWJlbHNXaWR0aCtcJ3B4XCd9IHx8IHt9KSJcbicgKwogICAgICAgICcgICAgICAgICAgICAgZ2FudHQtbGFiZWxzLXJlc2l6ZT0iJHBhcmVudC5hbGxvd0xhYmVsc1Jlc2l6aW5nIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBnYW50dC1sYWJlbHMtcmVzaXplLXdpZHRoPSIkcGFyZW50LmxhYmVsc1dpZHRoIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBnYW50dC1sYWJlbHMtcmVzaXplLW1pbi13aWR0aD0iNTAiXG4nICsKICAgICAgICAnICAgICAgICAgICAgIGdhbnR0LWVsZW1lbnQtd2lkdGgtbGlzdGVuZXI9IiRwYXJlbnQubGFiZWxzV2lkdGgiPjwvZGl2PlxuJyArCiAgICAgICAgJyAgICA8L3NjcmlwdD5cbicgKwogICAgICAgICdcbicgKwogICAgICAgICcgICAgPCEtLSBIZWFkZXIgY29sdW1ucyB0ZW1wbGF0ZSAtLT5cbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC5oZWFkZXJDb2x1bW5zLnRtcGwuaHRtbCI+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IG5nLXRyYW5zY2x1ZGUgY2xhc3M9ImdhbnR0LWhlYWRlci1jb2x1bW5zIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgZ2FudHQtaG9yaXpvbnRhbC1zY3JvbGwtcmVjZWl2ZXI+PC9kaXY+XG4nICsKICAgICAgICAnICAgIDwvc2NyaXB0PlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSJ0ZW1wbGF0ZS9kZWZhdWx0LmNvbHVtbkhlYWRlci50bXBsLmh0bWwiPlxuJyArCiAgICAgICAgJyAgICAgICAgPGRpdiBuZy10cmFuc2NsdWRlIGNsYXNzPSJnYW50dC1jb2x1bW4taGVhZGVyIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgbmctc3R5bGU9IntcJ2xlZnRcJzogY29sdW1uLmxlZnQrXCdweFwnLCBcJ3dpZHRoXCc6IGNvbHVtbi53aWR0aCtcJ3B4XCd9Ij48L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS0gQm9keSBjb2x1bW5zIHRlbXBsYXRlIC0tPlxuJyArCiAgICAgICAgJyAgICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSJ0ZW1wbGF0ZS9kZWZhdWx0LmJvZHlDb2x1bW5zLnRtcGwuaHRtbCI+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IG5nLXRyYW5zY2x1ZGUgY2xhc3M9ImdhbnR0LWJvZHktY29sdW1ucyI+PC9kaXY+XG4nICsKICAgICAgICAnICAgIDwvc2NyaXB0PlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSJ0ZW1wbGF0ZS9kZWZhdWx0LmNvbHVtbi50bXBsLmh0bWwiPlxuJyArCiAgICAgICAgJyAgICAgICAgPGRpdiBuZy10cmFuc2NsdWRlIGNsYXNzPSJnYW50dC1jb2x1bW4iXG4nICsKICAgICAgICAnICAgICAgICAgICAgIG5nLWNsYXNzPSIoY29sdW1uLmN1cnJlbnREYXRlICYmIGN1cnJlbnREYXRlID09PSBcJ2NvbHVtblwnKSAmJiBcJ2dhbnR0LWZvcmVncm91bmQtY29sLWN1cnJlbnQtZGF0ZVwnIHx8IFwnZ2FudHQtZm9yZWdyb3VuZC1jb2xcJyJcbicgKwogICAgICAgICcgICAgICAgICAgICAgbmctc3R5bGU9IntcJ2xlZnRcJzogY29sdW1uLmxlZnQrXCdweFwnLCBcJ3dpZHRoXCc6IGNvbHVtbi53aWR0aCtcJ3B4XCd9Ij48L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9InRlbXBsYXRlL2RlZmF1bHQudGltZUZyYW1lLnRtcGwuaHRtbCI+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IGNsYXNzPSJnYW50dC10aW1lZnJhbWUiXG4nICsKICAgICAgICAnICAgICAgICAgICAgIG5nLWNsYXNzPSJnZXRDbGFzcygpIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBuZy1zdHlsZT0ie1wnbGVmdFwnOiB0aW1lRnJhbWUubGVmdCArIFwncHhcJywgXCd3aWR0aFwnOiB0aW1lRnJhbWUud2lkdGggKyBcJ3B4XCcsIFwnYmFja2dyb3VuZC1jb2xvclwnOiB0aW1lRnJhbWUuY29sb3IgJiYgdGltZUZyYW1lLmNvbG9yIHx8IFwnXCd9Ij48L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS0gU2Nyb2xsYWJsZSB0ZW1wbGF0ZSAtLT5cbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC5zY3JvbGxhYmxlLnRtcGwuaHRtbCI+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IG5nLXRyYW5zY2x1ZGUgY2xhc3M9ImdhbnR0LXNjcm9sbGFibGUiIGdhbnR0LXNjcm9sbC1zZW5kZXIgZ2FudHQtbGltaXQtdXBkYXRlclxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBuZy1zdHlsZT0iZ2V0U2Nyb2xsYWJsZUNzcygpIj48L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS0gUm93cyB0ZW1wbGF0ZSAtLT5cbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC5ib2R5Um93cy50bXBsLmh0bWwiPlxuJyArCiAgICAgICAgJyAgICAgICAgPGRpdiBuZy10cmFuc2NsdWRlIGNsYXNzPSJnYW50dC1ib2R5LXJvd3MiPjwvZGl2PlxuJyArCiAgICAgICAgJyAgICA8L3NjcmlwdD5cbicgKwogICAgICAgICdcbicgKwogICAgICAgICcgICAgPCEtLSBUYXNrIHRlbXBsYXRlIC0tPlxuJyArCiAgICAgICAgJyAgICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSJ0ZW1wbGF0ZS9kZWZhdWx0LnRhc2sudG1wbC5odG1sIj5cbicgKwogICAgICAgICcgICAgICAgIDxkaXYgbmctY2xhc3M9Iih0YXNrLmlzTWlsZXN0b25lID09PSB0cnVlICYmIFtcJ2dhbnR0LXRhc2stbWlsZXN0b25lXCddIHx8IFtcJ2dhbnR0LXRhc2tcJ10pLmNvbmNhdCh0YXNrLmNsYXNzZXMpIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBuZy1zdHlsZT0ie1wnbGVmdFwnOiAoKHRhc2suaXNNaWxlc3RvbmUgPT09IHRydWUgfHwgdGFzay53aWR0aCA9PT0gMCkgJiYgKHRhc2subGVmdC0wLjMpIHx8IHRhc2subGVmdCkrXCdweFwnLCBcJ3dpZHRoXCc6IHRhc2sud2lkdGggK1wncHhcJywgXCd6LWluZGV4XCc6ICh0YXNrLmlzTW92aW5nID09PSB0cnVlICYmIDEgIHx8IHRhc2sucHJpb3JpdHkgfHwgXCdcJyksIFwnYmFja2dyb3VuZC1jb2xvclwnOiB0YXNrLmNvbG9yfSI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPGdhbnR0LWJvdW5kcyBuZy1tb2RlbD0idGFzayI+PC9nYW50dC1ib3VuZHM+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPGdhbnR0LXRvb2x0aXAgbmctbW9kZWw9InRhc2siPjwvZ2FudHQtdG9vbHRpcD5cbicgKwogICAgICAgICcgICAgICAgICAgICA8ZGl2IG5nLWlmPSJ0YXNrLnRydW5jYXRlZExlZnQiIGNsYXNzPSJnYW50dC10YXNrLXRydW5jYXRlZC1sZWZ0Ij48c3Bhbj4mbHQ7PC9zcGFuPjwvZGl2PlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDxkaXYgY2xhc3M9ImdhbnR0LXRhc2stY29udGVudCI+PHNwYW4+e3sgKHRhc2suaXNNaWxlc3RvbmUgPT09IHRydWUgJiYgXCcmbmJzcDtcJyB8fCB0YXNrLm5hbWUpIH19PC9zcGFuPjwvZGl2PlxuJyArCiAgICAgICAgJyAgICAgICAgICAgIDxkaXYgbmctaWY9InRhc2sudHJ1bmNhdGVkUmlnaHQiIGNsYXNzPSJnYW50dC10YXNrLXRydW5jYXRlZC1yaWdodCI+PHNwYW4+Jmd0Ozwvc3Bhbj48L2Rpdj5cbicgKwogICAgICAgICcgICAgICAgICAgICA8Z2FudHQtdGFzay1wcm9ncmVzcyBuZy1pZj0idGFzay5wcm9ncmVzcyAhPT0gdW5kZWZpbmVkIj48L2dhbnR0LXRhc2stcHJvZ3Jlc3M+XG4nICsKICAgICAgICAnICAgICAgICA8L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS0gVG9vbHRpcCB0ZW1wbGF0ZSAtLT5cbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC50b29sdGlwLnRtcGwuaHRtbCI+XG4nICsKICAgICAgICAnICAgICAgICA8ZGl2IG5nLXNob3c9InNob3dUb29sdGlwcyIgY2xhc3M9ImdhbnR0LXRhc2staW5mbyIgbmctc3R5bGU9ImNzcyI+XG4nICsKICAgICAgICAnICAgICAgICAgICAgPGRpdiBjbGFzcz0iZ2FudHQtdGFzay1pbmZvLWNvbnRlbnQiPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICB7eyB0YXNrLm5hbWUgfX08L2JyPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICA8c21hbGw+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICAgICAgICB7e1xuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgdGFzay5pc01pbGVzdG9uZSA9PT0gdHJ1ZSAmJiAodGFzay5nZXRGcm9tTGFiZWwoKSkgfHwgKHRhc2suZ2V0RnJvbUxhYmVsKCkgKyBcJyAtIFwnICsgdGFzay5nZXRUb0xhYmVsKCkpO1xuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgfX1cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgPC9zbWFsbD5cbicgKwogICAgICAgICcgICAgICAgICAgICA8L2Rpdj5cbicgKwogICAgICAgICcgICAgICAgIDwvZGl2PlxuJyArCiAgICAgICAgJyAgICA8L3NjcmlwdD5cbicgKwogICAgICAgICdcbicgKwogICAgICAgICcgICAgPCEtLSBUYXNrIGJvdW5kcyB0ZW1wbGF0ZSAtLT5cbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC5ib3VuZHMudG1wbC5odG1sIj5cbicgKwogICAgICAgICcgICAgICAgIDxkaXYgbmctc2hvdz0iYm91bmRzICYmIGlzVGFza01vdXNlT3ZlciIgY2xhc3M9ImdhbnR0LXRhc2stYm91bmRzIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICBuZy1zdHlsZT0iZ2V0Q3NzKCkiIG5nLWNsYXNzPSJnZXRDbGFzcygpIj48L2Rpdj5cbicgKwogICAgICAgICcgICAgPC9zY3JpcHQ+XG4nICsKICAgICAgICAnXG4nICsKICAgICAgICAnICAgIDwhLS0gVGFzayBwcm9ncmVzcyB0ZW1wbGF0ZSAtLT5cbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC50YXNrUHJvZ3Jlc3MudG1wbC5odG1sIj5cbicgKwogICAgICAgICcgICAgICAgIDxkaXYgY2xhc3M9XCdnYW50dC10YXNrLXByb2dyZXNzXCcgbmctc3R5bGU9ImdldENzcygpIiBuZy1jbGFzcz0icHJvZ3Jlc3MuY2xhc3NlcyI+PC9kaXY+XG4nICsKICAgICAgICAnICAgIDwvc2NyaXB0PlxuJyArCiAgICAgICAgJ1xuJyArCiAgICAgICAgJyAgICA8IS0tIFJvdyB0ZW1wbGF0ZSAtLT5cbicgKwogICAgICAgICcgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGUvZGVmYXVsdC5yb3cudG1wbC5odG1sIj5cbicgKwogICAgICAgICcgICAgICAgIDxkaXYgbmctdHJhbnNjbHVkZSBjbGFzcz0iZ2FudHQtcm93IGdhbnR0LXJvdy1oZWlnaHQiIG5nLXN0eWxlPSJ7XCdoZWlnaHRcJzogcm93LmhlaWdodH0iPjwvZGl2PlxuJyArCiAgICAgICAgJyAgICA8L3NjcmlwdD5cbicgKwogICAgICAgICdcbicgKwogICAgICAgICc8L2Rpdj5cbicgKwogICAgICAgICcnKTsKfV0pOwoKLy8jIHNvdXJjZU1hcHBpbmdVUkw9YW5ndWxhci1nYW50dC5qcy5tYXAKLyoKUHJvamVjdDogYW5ndWxhci1nYW50dCBmb3IgQW5ndWxhckpTCkF1dGhvcjogTWFyY28gU2Nod2VpZ2hhdXNlcgpDb250cmlidXRvcnM6IFLDqW1pIEFsdmVyZ25hdApMaWNlbnNlOiBNSVQuCkdpdGh1YjogaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXItZ2FudHQvYW5ndWxhci1nYW50dAoqLwondXNlIHN0cmljdCc7CgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0TW92YWJsZScsIFsnZ2FudHRNb3VzZUJ1dHRvbicsICdnYW50dE1vdXNlT2Zmc2V0JywgJ2dhbnR0RGVib3VuY2UnLCAnZ2FudHRTbWFydEV2ZW50JywgJ2dhbnR0TW92YWJsZU9wdGlvbnMnLCAnJHdpbmRvdycsICckZG9jdW1lbnQnLCAnJHRpbWVvdXQnLAogICAgZnVuY3Rpb24obW91c2VCdXR0b24sIG1vdXNlT2Zmc2V0LCBkZWJvdW5jZSwgc21hcnRFdmVudCwgbW92YWJsZU9wdGlvbnMsICR3aW5kb3csICRkb2N1bWVudCwgJHRpbWVvdXQpIHsKICAgICAgICAvLyBQcm92aWRlcyBtb3ZpbmcgYW5kIHJlc2l6aW5nIG9mIHRhc2tzCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgcmVxdWlyZTogJ15nYW50dCcsCiAgICAgICAgICAgIHNjb3BlOiB7CiAgICAgICAgICAgICAgICBhbGxvd01vdmluZzogJz0/JywKICAgICAgICAgICAgICAgIGFsbG93UmVzaXppbmc6ICc9PycsCiAgICAgICAgICAgICAgICBhbGxvd1Jvd1N3aXRjaGluZzogJz0/JwogICAgICAgICAgICB9LAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIGdhbnR0Q3RybCkgewogICAgICAgICAgICAgICAgdmFyIGFwaSA9IGdhbnR0Q3RybC5nYW50dC5hcGk7CgogICAgICAgICAgICAgICAgYXBpLnJlZ2lzdGVyRXZlbnQoJ3Rhc2tzJywgJ21vdmUnKTsKICAgICAgICAgICAgICAgIGFwaS5yZWdpc3RlckV2ZW50KCd0YXNrcycsICdtb3ZlQmVnaW4nKTsKICAgICAgICAgICAgICAgIGFwaS5yZWdpc3RlckV2ZW50KCd0YXNrcycsICdtb3ZlRW5kJyk7CiAgICAgICAgICAgICAgICBhcGkucmVnaXN0ZXJFdmVudCgndGFza3MnLCAncmVzaXplJyk7CiAgICAgICAgICAgICAgICBhcGkucmVnaXN0ZXJFdmVudCgndGFza3MnLCAncmVzaXplQmVnaW4nKTsKICAgICAgICAgICAgICAgIGFwaS5yZWdpc3RlckV2ZW50KCd0YXNrcycsICdyZXNpemVFbmQnKTsKCiAgICAgICAgICAgICAgICBpZiAoc2NvcGUub3B0aW9ucyAmJiB0eXBlb2Yoc2NvcGUub3B0aW9ucy5tb3ZhYmxlKSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBvcHRpb24gaW4gc2NvcGUub3B0aW9ucy5tb3ZhYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlW29wdGlvbl0gPSBzY29wZS5vcHRpb25zW29wdGlvbl07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG1vdmFibGVPcHRpb25zLmluaXRpYWxpemUoc2NvcGUpOwoKICAgICAgICAgICAgICAgIGFwaS5kaXJlY3RpdmVzLm9uLm5ldyhzY29wZSwgZnVuY3Rpb24oZGlyZWN0aXZlTmFtZSwgdGFza1Njb3BlLCB0YXNrRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmVOYW1lID09PSAnZ2FudHRUYXNrJykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzaXplQXJlYVdpZHRoQmlnID0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc2l6ZUFyZWFXaWR0aFNtYWxsID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjcm9sbFNwZWVkID0gMTU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzY3JvbGxUcmlnZ2VyRGlzdGFuY2UgPSA1OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHdpbmRvd0VsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoJHdpbmRvdyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBnYW50dFJvd0VsZW1lbnQgPSB0YXNrU2NvcGUucm93LiRlbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ2FudHRCb2R5RWxlbWVudCA9IHRhc2tTY29wZS5yb3cucm93c01hbmFnZXIuZ2FudHQuYm9keS4kZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdhbnR0U2Nyb2xsRWxlbWVudCA9IHRhc2tTY29wZS5yb3cucm93c01hbmFnZXIuZ2FudHQuc2Nyb2xsLiRlbGVtZW50OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhc2tIYXNCZWVuQ2hhbmdlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW91c2VPZmZzZXRJbkVtOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW92ZVN0YXJ0WDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjcm9sbEludGVydmFsOwoKICAgICAgICAgICAgICAgICAgICAgICAgdGFza0VsZW1lbnQuYmluZCgnbW91c2Vkb3duJywgZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2RlID0gZ2V0TW92ZU1vZGUoZXZ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobW9kZSAhPT0gJycgJiYgbW91c2VCdXR0b24uZ2V0QnV0dG9uKGV2dCkgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9mZnNldFggPSBtb3VzZU9mZnNldC5nZXRPZmZzZXRGb3JFbGVtZW50KGdhbnR0Qm9keUVsZW1lbnRbMF0sIGV2dCkueDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5hYmxlTW92ZU1vZGUobW9kZSwgb2Zmc2V0WCwgZXZ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICB0YXNrRWxlbWVudC5iaW5kKCdtb3VzZW1vdmUnLCBkZWJvdW5jZShmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kZSA9IGdldE1vdmVNb2RlKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGUgIT09ICcnICYmICh0YXNrU2NvcGUudGFzay5pc01vdmluZyB8fCBtb2RlICE9PSAnTScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza0VsZW1lbnQuY3NzKCdjdXJzb3InLCBnZXRDdXJzb3IobW9kZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrRWxlbWVudC5jc3MoJ2N1cnNvcicsICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSwgNSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhhbmRsZU1vdmUgPSBmdW5jdGlvbihtb2RlLCBldnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXNrU2NvcGUudGFzay5pc01vdmluZyA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZVRhc2sobW9kZSwgZXZ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbFNjcmVlbihtb2RlLCBldnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vdmVUYXNrID0gZnVuY3Rpb24obW9kZSwgZXZ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW91c2VQb3MgPSBtb3VzZU9mZnNldC5nZXRPZmZzZXRGb3JFbGVtZW50KGdhbnR0Qm9keUVsZW1lbnRbMF0sIGV2dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUudGFzay5tb3VzZU9mZnNldFggPSBtb3VzZVBvcy54OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHggPSBtb3VzZVBvcy54OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdNJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzY29wZS5hbGxvd1Jvd1N3aXRjaGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0Um93ID0gZ2V0Um93QnlZKG1vdXNlUG9zLnkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0Um93ICE9PSB1bmRlZmluZWQgJiYgdGFza1Njb3BlLnRhc2sucm93LmlkICE9PSB0YXJnZXRSb3cuaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFJvdy5tb3ZlVGFza1RvUm93KHRhc2tTY29wZS50YXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjb3BlLmFsbG93TW92aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggPSB4IC0gbW91c2VPZmZzZXRJbkVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFza1Njb3BlLnRhc2tPdXRPZlJhbmdlICE9PSAndHJ1bmNhdGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoeCA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoeCArIHRhc2tTY29wZS50YXNrLndpZHRoID49IHRhc2tTY29wZS5nYW50dC53aWR0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggPSB0YXNrU2NvcGUuZ2FudHQud2lkdGggLSB0YXNrU2NvcGUudGFzay53aWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUudGFzay5tb3ZlVG8oeCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tTY29wZS5yb3cucm93c01hbmFnZXIuZ2FudHQuYXBpLnRhc2tzLnJhaXNlLm1vdmUodGFza1Njb3BlLnRhc2spOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gJ0UnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhc2tTY29wZS50YXNrT3V0T2ZSYW5nZSAhPT0gJ3RydW5jYXRlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoeCA8IHRhc2tTY29wZS50YXNrLmxlZnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggPSB0YXNrU2NvcGUudGFzay5sZWZ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHggPiB0YXNrU2NvcGUuZ2FudHQud2lkdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggPSB0YXNrU2NvcGUuZ2FudHQud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnRhc2suc2V0VG8oeCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnJvdy5yb3dzTWFuYWdlci5nYW50dC5hcGkudGFza3MucmFpc2UucmVzaXplKHRhc2tTY29wZS50YXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhc2tTY29wZS50YXNrT3V0T2ZSYW5nZSAhPT0gJ3RydW5jYXRlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoeCA+IHRhc2tTY29wZS50YXNrLmxlZnQgKyB0YXNrU2NvcGUudGFzay53aWR0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeCA9IHRhc2tTY29wZS50YXNrLmxlZnQgKyB0YXNrU2NvcGUudGFzay53aWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh4IDwgMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnRhc2suc2V0RnJvbSh4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUucm93LnJvd3NNYW5hZ2VyLmdhbnR0LmFwaS50YXNrcy5yYWlzZS5yZXNpemUodGFza1Njb3BlLnRhc2spOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tIYXNCZWVuQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsU2NyZWVuID0gZnVuY3Rpb24obW9kZSwgZXZ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW91c2VQb3MgPSBtb3VzZU9mZnNldC5nZXRPZmZzZXRGb3JFbGVtZW50KGdhbnR0Qm9keUVsZW1lbnRbMF0sIGV2dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGVmdFNjcmVlbkJvcmRlciA9IGdhbnR0U2Nyb2xsRWxlbWVudFswXS5zY3JvbGxMZWZ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGtlZXBPblNjcm9sbGluZyA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb3VzZVBvcy54IDwgbW92ZVN0YXJ0WCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNjcm9sbCB0byB0aGUgbGVmdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb3VzZVBvcy54IDw9IGxlZnRTY3JlZW5Cb3JkZXIgKyBzY3JvbGxUcmlnZ2VyRGlzdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW91c2VQb3MueCAtPSBzY3JvbGxTcGVlZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2VlcE9uU2Nyb2xsaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnJvdy5yb3dzTWFuYWdlci5nYW50dC5hcGkuc2Nyb2xsLmxlZnQoc2Nyb2xsU3BlZWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2Nyb2xsIHRvIHRoZSByaWdodAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzY3JlZW5XaWR0aCA9IGdhbnR0U2Nyb2xsRWxlbWVudFswXS5vZmZzZXRXaWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmlnaHRTY3JlZW5Cb3JkZXIgPSBsZWZ0U2NyZWVuQm9yZGVyICsgc2NyZWVuV2lkdGg7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb3VzZVBvcy54ID49IHJpZ2h0U2NyZWVuQm9yZGVyIC0gc2Nyb2xsVHJpZ2dlckRpc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdXNlUG9zLnggKz0gc2Nyb2xsU3BlZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtlZXBPblNjcm9sbGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tTY29wZS5yb3cucm93c01hbmFnZXIuZ2FudHQuYXBpLnNjcm9sbC5yaWdodChzY3JvbGxTcGVlZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZWVwT25TY3JvbGxpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxJbnRlcnZhbCA9ICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVNb3ZlKG1vZGUsIGV2dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMTAwLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjbGVhclNjcm9sbEludGVydmFsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2Nyb2xsSW50ZXJ2YWwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0aW1lb3V0LmNhbmNlbChzY3JvbGxJbnRlcnZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsSW50ZXJ2YWwgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0Um93QnlZID0gZnVuY3Rpb24oeSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHkgPj0gZ2FudHRSb3dFbGVtZW50WzBdLm9mZnNldFRvcCAmJiB5IDw9IGdhbnR0Um93RWxlbWVudFswXS5vZmZzZXRUb3AgKyBnYW50dFJvd0VsZW1lbnRbMF0ub2Zmc2V0SGVpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhc2tTY29wZS50YXNrLnJvdzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZpc2libGVSb3dzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRhc2tTY29wZS50YXNrLnJvdy5yb3dzTWFuYWdlci5yb3dzLCBmdW5jdGlvbihyb3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyb3cuaGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aXNpYmxlUm93cy5wdXNoKHJvdyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm93SGVpZ2h0ID0gZ2FudHRCb2R5RWxlbWVudFswXS5vZmZzZXRIZWlnaHQgLyB2aXNpYmxlUm93cy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBvcyA9IE1hdGguZmxvb3IoeSAvIHJvd0hlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZpc2libGVSb3dzW3Bvc107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0TW92ZU1vZGUgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgeCA9IG1vdXNlT2Zmc2V0LmdldE9mZnNldChlKS54OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXN0YW5jZSA9IDA7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmaW5lIHJlc2l6ZSZtb3ZlIGFyZWEuIE1ha2Ugc3VyZSB0aGUgbW92ZSBhcmVhIGRvZXMgbm90IGdldCB0b28gc21hbGwuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NvcGUuYWxsb3dSZXNpemluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3RhbmNlID0gdGFza0VsZW1lbnRbMF0ub2Zmc2V0V2lkdGggPCAxMCA/IHJlc2l6ZUFyZWFXaWR0aFNtYWxsIDogcmVzaXplQXJlYVdpZHRoQmlnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzY29wZS5hbGxvd1Jlc2l6aW5nICYmIHggPiB0YXNrRWxlbWVudFswXS5vZmZzZXRXaWR0aCAtIGRpc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdFJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2NvcGUuYWxsb3dSZXNpemluZyAmJiB4IDwgZGlzdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ1cnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoc2NvcGUuYWxsb3dNb3ZpbmcgfHwgc2NvcGUuYWxsb3dSb3dTd2l0Y2hpbmcpICYmIHggPj0gZGlzdGFuY2UgJiYgeCA8PSB0YXNrRWxlbWVudFswXS5vZmZzZXRXaWR0aCAtIGRpc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdNJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdldEN1cnNvciA9IGZ1bmN0aW9uKG1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAobW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ0UnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ2UtcmVzaXplJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdXJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd3LXJlc2l6ZSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnTSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnbW92ZSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW5hYmxlTW92ZU1vZGUgPSBmdW5jdGlvbihtb2RlLCB4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSYWlzZSB0YXNrIG1vdmUgc3RhcnQgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGFza1Njb3BlLnRhc2suaXNNb3ZpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobW9kZSA9PT0gJ00nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tTY29wZS5yb3cucm93c01hbmFnZXIuZ2FudHQuYXBpLnRhc2tzLnJhaXNlLm1vdmVCZWdpbih0YXNrU2NvcGUudGFzayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnJvdy5yb3dzTWFuYWdlci5nYW50dC5hcGkudGFza3MucmFpc2UucmVzaXplQmVnaW4odGFza1Njb3BlLnRhc2spOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbml0IHRhc2sgbW92ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza0hhc0JlZW5DaGFuZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUudGFzay5tb3ZlTW9kZSA9IG1vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUudGFzay5pc01vdmluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlU3RhcnRYID0geDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdXNlT2Zmc2V0SW5FbSA9IHggLSB0YXNrU2NvcGUudGFzay5tb2RlbExlZnQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWRkIG1vdmUgZXZlbnQgaGFuZGxlcnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YXNrTW92ZUhhbmRsZXIgPSBkZWJvdW5jZShmdW5jdGlvbihldnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFza1Njb3BlLnRhc2suaXNNb3ZpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXMgdGhpcyBmdW5jdGlvbiBpcyBkZWZlcmVkLCBkaXNhYmxlTW92ZU1vZGUgbWF5IGhhdmUgYmVlbiBjYWxsZWQgYmVmb3JlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXaXRob3V0IHRoaXMgY2hlY2ssIHRhc2suY2hhbmdlZCBldmVudCBpcyBub3QgZmlyZWQgZm9yIGZhc3RlciBtb3Zlcy4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2VlIGdpdGh1YiBpc3N1ZSAjMTkwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyU2Nyb2xsSW50ZXJ2YWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlTW92ZShtb2RlLCBldnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc21hcnRFdmVudCh0YXNrU2NvcGUsIHdpbmRvd0VsZW1lbnQsICdtb3VzZW1vdmUnLCB0YXNrTW92ZUhhbmRsZXIpLmJpbmQoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbWFydEV2ZW50KHRhc2tTY29wZSwgd2luZG93RWxlbWVudCwgJ21vdXNldXAnLCBmdW5jdGlvbihldnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3dFbGVtZW50LnVuYmluZCgnbW91c2Vtb3ZlJywgdGFza01vdmVIYW5kbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZU1vdmVNb2RlKGV2dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5iaW5kT25jZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNob3cgbW91c2UgbW92ZS9yZXNpemUgY3Vyc29yCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrRWxlbWVudC5jc3MoJ2N1cnNvcicsIGdldEN1cnNvcihtb2RlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoJGRvY3VtZW50WzBdLmJvZHkpLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJy1tb3otdXNlci1zZWxlY3QnOiAnLW1vei1ub25lJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLXdlYmtpdC11c2VyLXNlbGVjdCc6ICdub25lJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLW1zLXVzZXItc2VsZWN0JzogJ25vbmUnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd1c2VyLXNlbGVjdCc6ICdub25lJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY3Vyc29yJzogZ2V0Q3Vyc29yKG1vZGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXNhYmxlTW92ZU1vZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tTY29wZS50YXNrLmlzTW92aW5nID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RvcCBhbnkgYWN0aXZlIGF1dG8gc2Nyb2xsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclNjcm9sbEludGVydmFsKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2V0IG1vdXNlIGN1cnNvciBiYWNrIHRvIGRlZmF1bHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tFbGVtZW50LmNzcygnY3Vyc29yJywgJycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5lbGVtZW50KCRkb2N1bWVudFswXS5ib2R5KS5jc3MoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICctbW96LXVzZXItc2VsZWN0JzogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJy13ZWJraXQtdXNlci1zZWxlY3QnOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLW1zLXVzZXItc2VsZWN0JzogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3VzZXItc2VsZWN0JzogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2N1cnNvcic6ICcnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSYWlzZSBtb3ZlIGVuZCBldmVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhc2tTY29wZS50YXNrLm1vdmVNb2RlID09PSAnTScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUucm93LnJvd3NNYW5hZ2VyLmdhbnR0LmFwaS50YXNrcy5yYWlzZS5tb3ZlRW5kKHRhc2tTY29wZS50YXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnJvdy5yb3dzTWFuYWdlci5nYW50dC5hcGkudGFza3MucmFpc2UucmVzaXplRW5kKHRhc2tTY29wZS50YXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUudGFzay5tb3ZlTW9kZSA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSYWlzZSB0YXNrIGNoYW5nZWQgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXNrSGFzQmVlbkNoYW5nZWQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrSGFzQmVlbkNoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrU2NvcGUudGFzay5yb3cuc29ydFRhc2tzKCk7IC8vIFNvcnQgdGFza3Mgc28gdGhleSBoYXZlIHRoZSByaWdodCB6LW9yZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza1Njb3BlLnJvdy5yb3dzTWFuYWdlci5nYW50dC5hcGkudGFza3MucmFpc2UuY2hhbmdlKHRhc2tTY29wZS50YXNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXNrU2NvcGUudGFzay5pc0NyZWF0aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGFza1Njb3BlLnRhc2suaXNDcmVhdGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuYWJsZU1vdmVNb2RlKCdFJywgdGFza1Njb3BlLnRhc2subW91c2VPZmZzZXRYKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YXNrU2NvcGUudGFzay5pc01vdmluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW4gY2FzZSB0aGUgdGFzayBoYXMgYmVlbiBtb3ZlZCB0byBhbm90aGVyIHJvdyBhIG5ldyBjb250cm9sbGVyIGlzIGlzIGNyZWF0ZWQgYnkgYW5ndWxhci4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVuYWJsZSB0aGUgbW92ZSBtb2RlIGFnYWluIGlmIHRoaXMgd2FzIHRoZSBjYXNlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5hYmxlTW92ZU1vZGUoJ00nLCB0YXNrU2NvcGUudGFzay5tb3VzZU9mZnNldFgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9XSk7CgoKZ2FudHQuZmFjdG9yeSgnZ2FudHRNb3ZhYmxlT3B0aW9ucycsIFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewoKICAgICAgICAgICAgb3B0aW9ucy5hbGxvd01vdmluZyA9IG9wdGlvbnMuYWxsb3dNb3ZpbmcgIT09IHVuZGVmaW5lZCA/ICEhb3B0aW9ucy5hbGxvd01vdmluZyA6IHRydWU7CiAgICAgICAgICAgIG9wdGlvbnMuYWxsb3dSZXNpemluZyA9IG9wdGlvbnMuYWxsb3dSZXNpemluZyAhPT0gdW5kZWZpbmVkID8gISFvcHRpb25zLmFsbG93UmVzaXppbmcgOiB0cnVlOwogICAgICAgICAgICBvcHRpb25zLmFsbG93Um93U3dpdGNoaW5nID0gb3B0aW9ucy5hbGxvd1Jvd1N3aXRjaGluZyAhPT0gdW5kZWZpbmVkID8gISFvcHRpb25zLmFsbG93Um93U3dpdGNoaW5nIDogdHJ1ZTsKCiAgICAgICAgICAgIHJldHVybiBvcHRpb25zOwogICAgICAgIH0KICAgIH07Cn1dKTsKCgpnYW50dC5kaXJlY3RpdmUoJ2dhbnR0U29ydGFibGUnLCBbJyRkb2N1bWVudCcsIGZ1bmN0aW9uKCRkb2N1bWVudCkgewogICAgLy8gUHJvdmlkZXMgdGhlIHJvdyBzb3J0IGZ1bmN0aW9uYWxpdHkgdG8gYW55IEdhbnR0IHJvdwogICAgLy8gVXNlcyB0aGUgc29ydGFibGVTdGF0ZSB0byBzaGFyZSB0aGUgY3VycmVudCByb3cKCiAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVxdWlyZTogJ15nYW50dCcsCiAgICAgICAgc2NvcGU6IHsKICAgICAgICAgICAgZW5hYmxlZDogJz0/JwogICAgICAgIH0sCiAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBnYW50dEN0cmwpIHsKICAgICAgICAgICAgdmFyIGFwaSA9IGdhbnR0Q3RybC5nYW50dC5hcGk7CgogICAgICAgICAgICBpZiAoc2NvcGUuZW5hYmxlZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBzY29wZS5lbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYXBpLmRpcmVjdGl2ZXMub24ubmV3KHNjb3BlLCBmdW5jdGlvbihkaXJlY3RpdmVOYW1lLCByb3dTY29wZSwgcm93RWxlbWVudCkgewogICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZU5hbWUgPT09ICdnYW50dFJvd0xhYmVsJykgewogICAgICAgICAgICAgICAgICAgIHJvd0VsZW1lbnQuYmluZCgnbW91c2Vkb3duJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2NvcGUuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBlbmFibGVEcmFnTW9kZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpc2FibGVIYW5kbGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3dTY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5lbGVtZW50KCRkb2N1bWVudFswXS5ib2R5KS51bmJpbmQoJ21vdXNldXAnLCBkaXNhYmxlSGFuZGxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZURyYWdNb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5lbGVtZW50KCRkb2N1bWVudFswXS5ib2R5KS5iaW5kKCdtb3VzZXVwJywgZGlzYWJsZUhhbmRsZXIpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICByb3dFbGVtZW50LmJpbmQoJ21vdXNlbW92ZScsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzSW5EcmFnTW9kZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbWVudEJlbG93TW91c2UgPSAkZG9jdW1lbnRbMF0uZWxlbWVudEZyb21Qb2ludChlLmNsaWVudFgsIGUuY2xpZW50WSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50QmVsb3dNb3VzZSA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50QmVsb3dNb3VzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0Um93ID0gZWxlbWVudEJlbG93TW91c2Uuc2NvcGUoKS5yb3c7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldFJvdy5pZCAhPT0gc2NvcGUuc3RhcnRSb3cuaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3dTY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3dTY29wZS5yb3cucm93c01hbmFnZXIuc3dhcFJvd3ModGFyZ2V0Um93LCBzY29wZS5zdGFydFJvdyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGlzSW5EcmFnTW9kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuc3RhcnRSb3cgIT09IHVuZGVmaW5lZCAmJiAhYW5ndWxhci5lcXVhbHMocm93U2NvcGUucm93LCBzY29wZS5zdGFydFJvdyk7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGVuYWJsZURyYWdNb2RlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLnN0YXJ0Um93ID0gcm93U2NvcGUucm93OwogICAgICAgICAgICAgICAgICAgICAgICByb3dFbGVtZW50LmNzcygnY3Vyc29yJywgJ21vdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5lbGVtZW50KCRkb2N1bWVudFswXS5ib2R5KS5jc3MoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJy1tb3otdXNlci1zZWxlY3QnOiAnLW1vei1ub25lJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICctd2Via2l0LXVzZXItc2VsZWN0JzogJ25vbmUnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJy1tcy11c2VyLXNlbGVjdCc6ICdub25lJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICd1c2VyLXNlbGVjdCc6ICdub25lJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjdXJzb3InOiAnbm8tZHJvcCcKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGRpc2FibGVEcmFnTW9kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5zdGFydFJvdyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgcm93RWxlbWVudC5jc3MoJ2N1cnNvcicsICdwb2ludGVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudCgkZG9jdW1lbnRbMF0uYm9keSkuY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICctbW96LXVzZXItc2VsZWN0JzogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLXdlYmtpdC11c2VyLXNlbGVjdCc6ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJy1tcy11c2VyLXNlbGVjdCc6ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3VzZXItc2VsZWN0JzogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY3Vyc29yJzogJ2F1dG8nCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICB9CiAgICB9Owp9XSk7CgovLyMgc291cmNlTWFwcGluZ1VSTD1hbmd1bGFyLWdhbnR0LXBsdWdpbnMuanMubWFw",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 07:45:10 GMT",
                    "Content-Length": "1462383",
                    "Date": "Thu, 06 Nov 2014 07:45:11 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}