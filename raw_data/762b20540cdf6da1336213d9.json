{
    "url": "http://localhost:9999/david-driscoll/thrust/dist/thrust.all.libraries.0.1.5.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>parent.name</b> and written to <b>the 'name' property of a DOM element</b> via the following statement:<ul><li>this.name = parent.name;</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/david-driscoll/thrust/dist/thrust.all.libraries.0.1.5.js",
                "path": "/david-driscoll/thrust/dist/thrust.all.libraries.0.1.5.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9kYXZpZC1kcmlzY29sbC90aHJ1c3QvZGlzdC90aHJ1c3QuYWxsLmxpYnJhcmllcy4wLjEuNS5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNjQ2NjU0DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBTYXQsIDA4IE5vdiAyMDE0IDIwOjA1OjI4IEdNVA0KTGFzdC1Nb2RpZmllZDogU2F0LCAwOCBOb3YgMjAxNCAyMDowNToyNyBHTVQNCg0KLyohIHRocnVzdC1qcyAtIHYwLjEuNSAtIDIwMTMtMDEtMjcgKi87KGZ1bmN0aW9uKHdpbmRvdywgdW5kZWZpbmVkKSB7CgogIC8qKiBEZXRlY3QgZnJlZSB2YXJpYWJsZSBgZXhwb3J0c2AgKi8KICB2YXIgZnJlZUV4cG9ydHMgPSB0eXBlb2YgZXhwb3J0cyA9PSAnb2JqZWN0JyAmJiBleHBvcnRzOwoKICAvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGUgYGdsb2JhbGAgYW5kIHVzZSBpdCBhcyBgd2luZG93YCAqLwogIHZhciBmcmVlR2xvYmFsID0gdHlwZW9mIGdsb2JhbCA9PSAnb2JqZWN0JyAmJiBnbG9iYWw7CiAgaWYgKGZyZWVHbG9iYWwuZ2xvYmFsID09PSBmcmVlR2xvYmFsKSB7CiAgICB3aW5kb3cgPSBmcmVlR2xvYmFsOwogIH0KCiAgLyoqIFVzZWQgZm9yIGFycmF5IGFuZCBvYmplY3QgbWV0aG9kIHJlZmVyZW5jZXMgKi8KICB2YXIgYXJyYXlSZWYgPSBbXSwKICAgICAgb2JqZWN0UmVmID0ge307CgogIC8qKiBVc2VkIHRvIGdlbmVyYXRlIHVuaXF1ZSBJRHMgKi8KICB2YXIgaWRDb3VudGVyID0gMDsKCiAgLyoqIFVzZWQgaW50ZXJuYWxseSB0byBpbmRpY2F0ZSB2YXJpb3VzIHRoaW5ncyAqLwogIHZhciBpbmRpY2F0b3JPYmplY3QgPSBvYmplY3RSZWY7CgogIC8qKiBVc2VkIGJ5IGBjYWNoZWRDb250YWluc2AgYXMgdGhlIGRlZmF1bHQgc2l6ZSB3aGVuIG9wdGltaXphdGlvbnMgYXJlIGVuYWJsZWQgZm9yIGxhcmdlIGFycmF5cyAqLwogIHZhciBsYXJnZUFycmF5U2l6ZSA9IDMwOwoKICAvKiogVXNlZCB0byByZXN0b3JlIHRoZSBvcmlnaW5hbCBgX2AgcmVmZXJlbmNlIGluIGBub0NvbmZsaWN0YCAqLwogIHZhciBvbGREYXNoID0gd2luZG93Ll87CgogIC8qKiBVc2VkIHRvIG1hdGNoIEhUTUwgZW50aXRpZXMgKi8KICB2YXIgcmVFc2NhcGVkSHRtbCA9IC8mKD86YW1wfGx0fGd0fHF1b3R8I3gyNyk7L2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoIGVtcHR5IHN0cmluZyBsaXRlcmFscyBpbiBjb21waWxlZCB0ZW1wbGF0ZSBzb3VyY2UgKi8KICB2YXIgcmVFbXB0eVN0cmluZ0xlYWRpbmcgPSAvXGJfX3AgXCs9ICcnOy9nLAogICAgICByZUVtcHR5U3RyaW5nTWlkZGxlID0gL1xiKF9fcCBcKz0pICcnIFwrL2csCiAgICAgIHJlRW1wdHlTdHJpbmdUcmFpbGluZyA9IC8oX19lXCguKj9cKXxcYl9fdFwpKSBcK1xuJyc7L2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoIHJlZ2V4cCBmbGFncyBmcm9tIHRoZWlyIGNvZXJjZWQgc3RyaW5nIHZhbHVlcyAqLwogIHZhciByZUZsYWdzID0gL1x3KiQvOwoKICAvKiogVXNlZCB0byBkZXRlY3QgaWYgYSBtZXRob2QgaXMgbmF0aXZlICovCiAgdmFyIHJlTmF0aXZlID0gUmVnRXhwKCdeJyArCiAgICAob2JqZWN0UmVmLnZhbHVlT2YgKyAnJykKICAgICAgLnJlcGxhY2UoL1suKis/Xj0hOiR7fSgpfFtcXVwvXFxdL2csICdcXCQmJykKICAgICAgLnJlcGxhY2UoL3ZhbHVlT2Z8Zm9yIFteXF1dKy9nLCAnLis/JykgKyAnJCcKICApOwoKICAvKioKICAgKiBVc2VkIHRvIG1hdGNoIEVTNiB0ZW1wbGF0ZSBkZWxpbWl0ZXJzCiAgICogaHR0cDovL3Blb3BsZS5tb3ppbGxhLm9yZy9+am9yZW5kb3JmZi9lczYtZHJhZnQuaHRtbCNzZWMtNy44LjYKICAgKi8KICB2YXIgcmVFc1RlbXBsYXRlID0gL1wkXHsoKD86KD89XFw/KVxcP1tcc1xTXSkqPyl9L2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoICJpbnRlcnBvbGF0ZSIgdGVtcGxhdGUgZGVsaW1pdGVycyAqLwogIHZhciByZUludGVycG9sYXRlID0gLzwlPShbXHNcU10rPyklPi9nOwoKICAvKiogVXNlZCB0byBlbnN1cmUgY2FwdHVyaW5nIG9yZGVyIG9mIHRlbXBsYXRlIGRlbGltaXRlcnMgKi8KICB2YXIgcmVOb01hdGNoID0gLygkXikvOwoKICAvKiogVXNlZCB0byBtYXRjaCBIVE1MIGNoYXJhY3RlcnMgKi8KICB2YXIgcmVVbmVzY2FwZWRIdG1sID0gL1smPD4iJ10vZzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggdW5lc2NhcGVkIGNoYXJhY3RlcnMgaW4gY29tcGlsZWQgc3RyaW5nIGxpdGVyYWxzICovCiAgdmFyIHJlVW5lc2NhcGVkU3RyaW5nID0gL1snXG5cclx0XHUyMDI4XHUyMDI5XFxdL2c7CgogIC8qKiBVc2VkIHRvIGZpeCB0aGUgSlNjcmlwdCBbW0RvbnRFbnVtXV0gYnVnICovCiAgdmFyIHNoYWRvd2VkID0gWwogICAgJ2NvbnN0cnVjdG9yJywgJ2hhc093blByb3BlcnR5JywgJ2lzUHJvdG90eXBlT2YnLCAncHJvcGVydHlJc0VudW1lcmFibGUnLAogICAgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvU3RyaW5nJywgJ3ZhbHVlT2YnCiAgXTsKCiAgLyoqIFVzZWQgdG8gbWFrZSB0ZW1wbGF0ZSBzb3VyY2VVUkxzIGVhc2llciB0byBpZGVudGlmeSAqLwogIHZhciB0ZW1wbGF0ZUNvdW50ZXIgPSAwOwoKICAvKiogTmF0aXZlIG1ldGhvZCBzaG9ydGN1dHMgKi8KICB2YXIgY2VpbCA9IE1hdGguY2VpbCwKICAgICAgY29uY2F0ID0gYXJyYXlSZWYuY29uY2F0LAogICAgICBmbG9vciA9IE1hdGguZmxvb3IsCiAgICAgIGdldFByb3RvdHlwZU9mID0gcmVOYXRpdmUudGVzdChnZXRQcm90b3R5cGVPZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZikgJiYgZ2V0UHJvdG90eXBlT2YsCiAgICAgIGhhc093blByb3BlcnR5ID0gb2JqZWN0UmVmLmhhc093blByb3BlcnR5LAogICAgICBwdXNoID0gYXJyYXlSZWYucHVzaCwKICAgICAgcHJvcGVydHlJc0VudW1lcmFibGUgPSBvYmplY3RSZWYucHJvcGVydHlJc0VudW1lcmFibGUsCiAgICAgIHRvU3RyaW5nID0gb2JqZWN0UmVmLnRvU3RyaW5nOwoKICAvKiBOYXRpdmUgbWV0aG9kIHNob3J0Y3V0cyBmb3IgbWV0aG9kcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXMgb3RoZXIgYGxvZGFzaGAgbWV0aG9kcyAqLwogIHZhciBuYXRpdmVCaW5kID0gcmVOYXRpdmUudGVzdChuYXRpdmVCaW5kID0gc2xpY2UuYmluZCkgJiYgbmF0aXZlQmluZCwKICAgICAgbmF0aXZlSXNBcnJheSA9IHJlTmF0aXZlLnRlc3QobmF0aXZlSXNBcnJheSA9IEFycmF5LmlzQXJyYXkpICYmIG5hdGl2ZUlzQXJyYXksCiAgICAgIG5hdGl2ZUlzRmluaXRlID0gd2luZG93LmlzRmluaXRlLAogICAgICBuYXRpdmVJc05hTiA9IHdpbmRvdy5pc05hTiwKICAgICAgbmF0aXZlS2V5cyA9IHJlTmF0aXZlLnRlc3QobmF0aXZlS2V5cyA9IE9iamVjdC5rZXlzKSAmJiBuYXRpdmVLZXlzLAogICAgICBuYXRpdmVNYXggPSBNYXRoLm1heCwKICAgICAgbmF0aXZlTWluID0gTWF0aC5taW4sCiAgICAgIG5hdGl2ZVJhbmRvbSA9IE1hdGgucmFuZG9tOwoKICAvKiogYE9iamVjdCN0b1N0cmluZ2AgcmVzdWx0IHNob3J0Y3V0cyAqLwogIHZhciBhcmdzQ2xhc3MgPSAnW29iamVjdCBBcmd1bWVudHNdJywKICAgICAgYXJyYXlDbGFzcyA9ICdbb2JqZWN0IEFycmF5XScsCiAgICAgIGJvb2xDbGFzcyA9ICdbb2JqZWN0IEJvb2xlYW5dJywKICAgICAgZGF0ZUNsYXNzID0gJ1tvYmplY3QgRGF0ZV0nLAogICAgICBmdW5jQ2xhc3MgPSAnW29iamVjdCBGdW5jdGlvbl0nLAogICAgICBudW1iZXJDbGFzcyA9ICdbb2JqZWN0IE51bWJlcl0nLAogICAgICBvYmplY3RDbGFzcyA9ICdbb2JqZWN0IE9iamVjdF0nLAogICAgICByZWdleHBDbGFzcyA9ICdbb2JqZWN0IFJlZ0V4cF0nLAogICAgICBzdHJpbmdDbGFzcyA9ICdbb2JqZWN0IFN0cmluZ10nOwoKICAvKiogRGV0ZWN0IHZhcmlvdXMgZW52aXJvbm1lbnRzICovCiAgdmFyIGlzSWVPcGVyYSA9ICEhd2luZG93LmF0dGFjaEV2ZW50LAogICAgICBpc1Y4ID0gbmF0aXZlQmluZCAmJiAhL1xufHRydWUvLnRlc3QobmF0aXZlQmluZCArIGlzSWVPcGVyYSk7CgogIC8qIERldGVjdCBpZiBgRnVuY3Rpb24jYmluZGAgZXhpc3RzIGFuZCBpcyBpbmZlcnJlZCB0byBiZSBmYXN0IChhbGwgYnV0IFY4KSAqLwogIHZhciBpc0JpbmRGYXN0ID0gbmF0aXZlQmluZCAmJiAhaXNWODsKCiAgLyogRGV0ZWN0IGlmIGBPYmplY3Qua2V5c2AgZXhpc3RzIGFuZCBpcyBpbmZlcnJlZCB0byBiZSBmYXN0IChJRSwgT3BlcmEsIFY4KSAqLwogIHZhciBpc0tleXNGYXN0ID0gbmF0aXZlS2V5cyAmJiAoaXNJZU9wZXJhIHx8IGlzVjgpOwoKICAvKioKICAgKiBEZXRlY3QgdGhlIEpTY3JpcHQgW1tEb250RW51bV1dIGJ1ZzoKICAgKgogICAqIEluIElFIDwgOSBhbiBvYmplY3RzIG93biBwcm9wZXJ0aWVzLCBzaGFkb3dpbmcgbm9uLWVudW1lcmFibGUgb25lcywgYXJlCiAgICogbWFkZSBub24tZW51bWVyYWJsZSBhcyB3ZWxsLgogICAqLwogIHZhciBoYXNEb250RW51bUJ1ZzsKCiAgLyoqIERldGVjdCBpZiBvd24gcHJvcGVydGllcyBhcmUgaXRlcmF0ZWQgYWZ0ZXIgaW5oZXJpdGVkIHByb3BlcnRpZXMgKElFIDwgOSkgKi8KICB2YXIgaXRlcmF0ZXNPd25MYXN0OwoKICAvKioKICAgKiBEZXRlY3QgaWYgYEFycmF5I3NoaWZ0YCBhbmQgYEFycmF5I3NwbGljZWAgYXVnbWVudCBhcnJheS1saWtlIG9iamVjdHMKICAgKiBpbmNvcnJlY3RseToKICAgKgogICAqIEZpcmVmb3ggPCAxMCwgSUUgY29tcGF0aWJpbGl0eSBtb2RlLCBhbmQgSUUgPCA5IGhhdmUgYnVnZ3kgQXJyYXkgYHNoaWZ0KClgCiAgICogYW5kIGBzcGxpY2UoKWAgZnVuY3Rpb25zIHRoYXQgZmFpbCB0byByZW1vdmUgdGhlIGxhc3QgZWxlbWVudCwgYHZhbHVlWzBdYCwKICAgKiBvZiBhcnJheS1saWtlIG9iamVjdHMgZXZlbiB0aG91Z2ggdGhlIGBsZW5ndGhgIHByb3BlcnR5IGlzIHNldCB0byBgMGAuCiAgICogVGhlIGBzaGlmdCgpYCBtZXRob2QgaXMgYnVnZ3kgaW4gSUUgOCBjb21wYXRpYmlsaXR5IG1vZGUsIHdoaWxlIGBzcGxpY2UoKWAKICAgKiBpcyBidWdneSByZWdhcmRsZXNzIG9mIG1vZGUgaW4gSUUgPCA5IGFuZCBidWdneSBpbiBjb21wYXRpYmlsaXR5IG1vZGUgaW4gSUUgOS4KICAgKi8KICB2YXIgaGFzT2JqZWN0U3BsaWNlQnVnID0gKGhhc09iamVjdFNwbGljZUJ1ZyA9IHsgJzAnOiAxLCAnbGVuZ3RoJzogMSB9LAogICAgYXJyYXlSZWYuc3BsaWNlLmNhbGwoaGFzT2JqZWN0U3BsaWNlQnVnLCAwLCAxKSwgaGFzT2JqZWN0U3BsaWNlQnVnWzBdKTsKCiAgLyoqIERldGVjdCBpZiBhbiBgYXJndW1lbnRzYCBvYmplY3QncyBpbmRleGVzIGFyZSBub24tZW51bWVyYWJsZSAoSUUgPCA5KSAqLwogIHZhciBub25FbnVtQXJncyA9IHRydWU7CgogIChmdW5jdGlvbigpIHsKICAgIHZhciBwcm9wcyA9IFtdOwogICAgZnVuY3Rpb24gY3RvcigpIHsgdGhpcy54ID0gMTsgfQogICAgY3Rvci5wcm90b3R5cGUgPSB7ICd2YWx1ZU9mJzogMSwgJ3knOiAxIH07CiAgICBmb3IgKHZhciBwcm9wIGluIG5ldyBjdG9yKSB7IHByb3BzLnB1c2gocHJvcCk7IH0KICAgIGZvciAocHJvcCBpbiBhcmd1bWVudHMpIHsgbm9uRW51bUFyZ3MgPSAhcHJvcDsgfQoKICAgIGhhc0RvbnRFbnVtQnVnID0gIS92YWx1ZU9mLy50ZXN0KHByb3BzKTsKICAgIGl0ZXJhdGVzT3duTGFzdCA9IHByb3BzWzBdICE9ICd4JzsKICB9KDEpKTsKCiAgLyoqIERldGVjdCBpZiBgYXJndW1lbnRzYCBvYmplY3RzIGFyZSBgT2JqZWN0YCBvYmplY3RzIChhbGwgYnV0IE9wZXJhIDwgMTAuNSkgKi8KICB2YXIgYXJnc0FyZU9iamVjdHMgPSBhcmd1bWVudHMuY29uc3RydWN0b3IgPT0gT2JqZWN0OwoKICAvKiogRGV0ZWN0IGlmIGBhcmd1bWVudHNgIG9iamVjdHMgW1tDbGFzc11dIGlzIHVucmVzb2x2YWJsZSAoRmlyZWZveCA8IDQsIElFIDwgOSkgKi8KICB2YXIgbm9BcmdzQ2xhc3MgPSAhaXNBcmd1bWVudHMoYXJndW1lbnRzKTsKCiAgLyoqCiAgICogRGV0ZWN0IGxhY2sgb2Ygc3VwcG9ydCBmb3IgYWNjZXNzaW5nIHN0cmluZyBjaGFyYWN0ZXJzIGJ5IGluZGV4OgogICAqCiAgICogSUUgPCA4IGNhbid0IGFjY2VzcyBjaGFyYWN0ZXJzIGJ5IGluZGV4IGFuZCBJRSA4IGNhbiBvbmx5IGFjY2VzcwogICAqIGNoYXJhY3RlcnMgYnkgaW5kZXggb24gc3RyaW5nIGxpdGVyYWxzLgogICAqLwogIHZhciBub0NoYXJCeUluZGV4ID0gKCd4J1swXSArIE9iamVjdCgneCcpWzBdKSAhPSAneHgnOwoKICAvKioKICAgKiBEZXRlY3QgaWYgYSBub2RlJ3MgW1tDbGFzc11dIGlzIHVucmVzb2x2YWJsZSAoSUUgPCA5KQogICAqIGFuZCB0aGF0IHRoZSBKUyBlbmdpbmUgd29uJ3QgZXJyb3Igd2hlbiBhdHRlbXB0aW5nIHRvIGNvZXJjZSBhbiBvYmplY3QgdG8KICAgKiBhIHN0cmluZyB3aXRob3V0IGEgYHRvU3RyaW5nYCBmdW5jdGlvbi4KICAgKi8KICB0cnkgewogICAgdmFyIG5vTm9kZUNsYXNzID0gdG9TdHJpbmcuY2FsbChkb2N1bWVudCkgPT0gb2JqZWN0Q2xhc3MgJiYgISh7ICd0b1N0cmluZyc6IDAgfSArICcnKTsKICB9IGNhdGNoKGUpIHsgfQoKICAvKiogVXNlZCB0byBpZGVudGlmeSBvYmplY3QgY2xhc3NpZmljYXRpb25zIHRoYXQgYF8uY2xvbmVgIHN1cHBvcnRzICovCiAgdmFyIGNsb25lYWJsZUNsYXNzZXMgPSB7fTsKICBjbG9uZWFibGVDbGFzc2VzW2Z1bmNDbGFzc10gPSBmYWxzZTsKICBjbG9uZWFibGVDbGFzc2VzW2FyZ3NDbGFzc10gPSBjbG9uZWFibGVDbGFzc2VzW2FycmF5Q2xhc3NdID0KICBjbG9uZWFibGVDbGFzc2VzW2Jvb2xDbGFzc10gPSBjbG9uZWFibGVDbGFzc2VzW2RhdGVDbGFzc10gPQogIGNsb25lYWJsZUNsYXNzZXNbbnVtYmVyQ2xhc3NdID0gY2xvbmVhYmxlQ2xhc3Nlc1tvYmplY3RDbGFzc10gPQogIGNsb25lYWJsZUNsYXNzZXNbcmVnZXhwQ2xhc3NdID0gY2xvbmVhYmxlQ2xhc3Nlc1tzdHJpbmdDbGFzc10gPSB0cnVlOwoKICAvKiogVXNlZCB0byBsb29rdXAgYSBidWlsdC1pbiBjb25zdHJ1Y3RvciBieSBbW0NsYXNzXV0gKi8KICB2YXIgY3RvckJ5Q2xhc3MgPSB7fTsKICBjdG9yQnlDbGFzc1thcnJheUNsYXNzXSA9IEFycmF5OwogIGN0b3JCeUNsYXNzW2Jvb2xDbGFzc10gPSBCb29sZWFuOwogIGN0b3JCeUNsYXNzW2RhdGVDbGFzc10gPSBEYXRlOwogIGN0b3JCeUNsYXNzW29iamVjdENsYXNzXSA9IE9iamVjdDsKICBjdG9yQnlDbGFzc1tudW1iZXJDbGFzc10gPSBOdW1iZXI7CiAgY3RvckJ5Q2xhc3NbcmVnZXhwQ2xhc3NdID0gUmVnRXhwOwogIGN0b3JCeUNsYXNzW3N0cmluZ0NsYXNzXSA9IFN0cmluZzsKCiAgLyoqIFVzZWQgdG8gZGV0ZXJtaW5lIGlmIHZhbHVlcyBhcmUgb2YgdGhlIGxhbmd1YWdlIHR5cGUgT2JqZWN0ICovCiAgdmFyIG9iamVjdFR5cGVzID0gewogICAgJ2Jvb2xlYW4nOiBmYWxzZSwKICAgICdmdW5jdGlvbic6IHRydWUsCiAgICAnb2JqZWN0JzogdHJ1ZSwKICAgICdudW1iZXInOiBmYWxzZSwKICAgICdzdHJpbmcnOiBmYWxzZSwKICAgICd1bmRlZmluZWQnOiBmYWxzZQogIH07CgogIC8qKiBVc2VkIHRvIGVzY2FwZSBjaGFyYWN0ZXJzIGZvciBpbmNsdXNpb24gaW4gY29tcGlsZWQgc3RyaW5nIGxpdGVyYWxzICovCiAgdmFyIHN0cmluZ0VzY2FwZXMgPSB7CiAgICAnXFwnOiAnXFwnLAogICAgIiciOiAiJyIsCiAgICAnXG4nOiAnbicsCiAgICAnXHInOiAncicsCiAgICAnXHQnOiAndCcsCiAgICAnXHUyMDI4JzogJ3UyMDI4JywKICAgICdcdTIwMjknOiAndTIwMjknCiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZXMgYSBgbG9kYXNoYCBvYmplY3QsIHRoYXQgd3JhcHMgdGhlIGdpdmVuIGB2YWx1ZWAsIHRvIGVuYWJsZSBtZXRob2QKICAgKiBjaGFpbmluZy4KICAgKgogICAqIEluIGFkZGl0aW9uIHRvIExvLURhc2ggbWV0aG9kcywgd3JhcHBlcnMgYWxzbyBoYXZlIHRoZSBmb2xsb3dpbmcgYEFycmF5YCBtZXRob2RzOgogICAqIGBjb25jYXRgLCBgam9pbmAsIGBwb3BgLCBgcHVzaGAsIGByZXZlcnNlYCwgYHNoaWZ0YCwgYHNsaWNlYCwgYHNvcnRgLCBgc3BsaWNlYCwKICAgKiBhbmQgYHVuc2hpZnRgCiAgICoKICAgKiBUaGUgY2hhaW5hYmxlIHdyYXBwZXIgZnVuY3Rpb25zIGFyZToKICAgKiBgYWZ0ZXJgLCBgYXNzaWduYCwgYGJpbmRgLCBgYmluZEFsbGAsIGBiaW5kS2V5YCwgYGNoYWluYCwgYGNvbXBhY3RgLCBgY29tcG9zZWAsCiAgICogYGNvbmNhdGAsIGBjb3VudEJ5YCwgYGRlYm91bmNlYCwgYGRlZmF1bHRzYCwgYGRlZmVyYCwgYGRlbGF5YCwgYGRpZmZlcmVuY2VgLAogICAqIGBmaWx0ZXJgLCBgZmxhdHRlbmAsIGBmb3JFYWNoYCwgYGZvckluYCwgYGZvck93bmAsIGBmdW5jdGlvbnNgLCBgZ3JvdXBCeWAsCiAgICogYGluaXRpYWxgLCBgaW50ZXJzZWN0aW9uYCwgYGludmVydGAsIGBpbnZva2VgLCBga2V5c2AsIGBtYXBgLCBgbWF4YCwgYG1lbW9pemVgLAogICAqIGBtZXJnZWAsIGBtaW5gLCBgb2JqZWN0YCwgYG9taXRgLCBgb25jZWAsIGBwYWlyc2AsIGBwYXJ0aWFsYCwgYHBhcnRpYWxSaWdodGAsCiAgICogYHBpY2tgLCBgcGx1Y2tgLCBgcHVzaGAsIGByYW5nZWAsIGByZWplY3RgLCBgcmVzdGAsIGByZXZlcnNlYCwgYHNodWZmbGVgLAogICAqIGBzbGljZWAsIGBzb3J0YCwgYHNvcnRCeWAsIGBzcGxpY2VgLCBgdGFwYCwgYHRocm90dGxlYCwgYHRpbWVzYCwgYHRvQXJyYXlgLAogICAqIGB1bmlvbmAsIGB1bmlxYCwgYHVuc2hpZnRgLCBgdmFsdWVzYCwgYHdoZXJlYCwgYHdpdGhvdXRgLCBgd3JhcGAsIGFuZCBgemlwYAogICAqCiAgICogVGhlIG5vbi1jaGFpbmFibGUgd3JhcHBlciBmdW5jdGlvbnMgYXJlOgogICAqIGBjbG9uZWAsIGBjbG9uZURlZXBgLCBgY29udGFpbnNgLCBgZXNjYXBlYCwgYGV2ZXJ5YCwgYGZpbmRgLCBgaGFzYCwgYGlkZW50aXR5YCwKICAgKiBgaW5kZXhPZmAsIGBpc0FyZ3VtZW50c2AsIGBpc0FycmF5YCwgYGlzQm9vbGVhbmAsIGBpc0RhdGVgLCBgaXNFbGVtZW50YCwgYGlzRW1wdHlgLAogICAqIGBpc0VxdWFsYCwgYGlzRmluaXRlYCwgYGlzRnVuY3Rpb25gLCBgaXNOYU5gLCBgaXNOdWxsYCwgYGlzTnVtYmVyYCwgYGlzT2JqZWN0YCwKICAgKiBgaXNQbGFpbk9iamVjdGAsIGBpc1JlZ0V4cGAsIGBpc1N0cmluZ2AsIGBpc1VuZGVmaW5lZGAsIGBqb2luYCwgYGxhc3RJbmRleE9mYCwKICAgKiBgbWl4aW5gLCBgbm9Db25mbGljdGAsIGBwb3BgLCBgcmFuZG9tYCwgYHJlZHVjZWAsIGByZWR1Y2VSaWdodGAsIGByZXN1bHRgLAogICAqIGBzaGlmdGAsIGBzaXplYCwgYHNvbWVgLCBgc29ydGVkSW5kZXhgLCBgdGVtcGxhdGVgLCBgdW5lc2NhcGVgLCBhbmQgYHVuaXF1ZUlkYAogICAqCiAgICogVGhlIHdyYXBwZXIgZnVuY3Rpb25zIGBmaXJzdGAgYW5kIGBsYXN0YCByZXR1cm4gd3JhcHBlZCB2YWx1ZXMgd2hlbiBgbmAgaXMKICAgKiBwYXNzZWQsIG90aGVyd2lzZSB0aGV5IHJldHVybiB1bndyYXBwZWQgdmFsdWVzLgogICAqCiAgICogQG5hbWUgXwogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwIGluIGEgYGxvZGFzaGAgaW5zdGFuY2UuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhIGBsb2Rhc2hgIGluc3RhbmNlLgogICAqLwogIGZ1bmN0aW9uIGxvZGFzaCh2YWx1ZSkgewogICAgLy8gZXhpdCBlYXJseSBpZiBhbHJlYWR5IHdyYXBwZWQsIGV2ZW4gaWYgd3JhcHBlZCBieSBhIGRpZmZlcmVudCBgbG9kYXNoYCBjb25zdHJ1Y3RvcgogICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiB2YWx1ZS5fX3dyYXBwZWRfXykgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICAvLyBhbGxvdyBpbnZva2luZyBgbG9kYXNoYCB3aXRob3V0IHRoZSBgbmV3YCBvcGVyYXRvcgogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGxvZGFzaCkpIHsKICAgICAgcmV0dXJuIG5ldyBsb2Rhc2godmFsdWUpOwogICAgfQogICAgdGhpcy5fX3dyYXBwZWRfXyA9IHZhbHVlOwogIH0KCiAgLyoqCiAgICogQnkgZGVmYXVsdCwgdGhlIHRlbXBsYXRlIGRlbGltaXRlcnMgdXNlZCBieSBMby1EYXNoIGFyZSBzaW1pbGFyIHRvIHRob3NlIGluCiAgICogZW1iZWRkZWQgUnVieSAoRVJCKS4gQ2hhbmdlIHRoZSBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlCiAgICogZGVsaW1pdGVycy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEB0eXBlIE9iamVjdAogICAqLwogIGxvZGFzaC50ZW1wbGF0ZVNldHRpbmdzID0gewoKICAgIC8qKgogICAgICogVXNlZCB0byBkZXRlY3QgYGRhdGFgIHByb3BlcnR5IHZhbHVlcyB0byBiZSBIVE1MLWVzY2FwZWQuCiAgICAgKgogICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICogQHR5cGUgUmVnRXhwCiAgICAgKi8KICAgICdlc2NhcGUnOiAvPCUtKFtcc1xTXSs/KSU+L2csCgogICAgLyoqCiAgICAgKiBVc2VkIHRvIGRldGVjdCBjb2RlIHRvIGJlIGV2YWx1YXRlZC4KICAgICAqCiAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgKiBAdHlwZSBSZWdFeHAKICAgICAqLwogICAgJ2V2YWx1YXRlJzogLzwlKFtcc1xTXSs/KSU+L2csCgogICAgLyoqCiAgICAgKiBVc2VkIHRvIGRldGVjdCBgZGF0YWAgcHJvcGVydHkgdmFsdWVzIHRvIGluamVjdC4KICAgICAqCiAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgKiBAdHlwZSBSZWdFeHAKICAgICAqLwogICAgJ2ludGVycG9sYXRlJzogcmVJbnRlcnBvbGF0ZSwKCiAgICAvKioKICAgICAqIFVzZWQgdG8gcmVmZXJlbmNlIHRoZSBkYXRhIG9iamVjdCBpbiB0aGUgdGVtcGxhdGUgdGV4dC4KICAgICAqCiAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAqLwogICAgJ3ZhcmlhYmxlJzogJycsCgogICAgLyoqCiAgICAgKiBVc2VkIHRvIGltcG9ydCB2YXJpYWJsZXMgaW50byB0aGUgY29tcGlsZWQgdGVtcGxhdGUuCiAgICAgKgogICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICogQHR5cGUgT2JqZWN0CiAgICAgKi8KICAgICdpbXBvcnRzJzogewoKICAgICAgLyoqCiAgICAgICAqIEEgcmVmZXJlbmNlIHRvIHRoZSBgbG9kYXNoYCBmdW5jdGlvbi4KICAgICAgICoKICAgICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncy5pbXBvcnRzCiAgICAgICAqIEB0eXBlIEZ1bmN0aW9uCiAgICAgICAqLwogICAgICAnXyc6IGxvZGFzaAogICAgfQogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBUaGUgdGVtcGxhdGUgdXNlZCB0byBjcmVhdGUgaXRlcmF0b3IgZnVuY3Rpb25zLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge09iZWN0fSBkYXRhIFRoZSBkYXRhIG9iamVjdCB1c2VkIHRvIHBvcHVsYXRlIHRoZSB0ZXh0LgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgdGhlIGludGVycG9sYXRlZCB0ZXh0LgogICAqLwogIHZhciBpdGVyYXRvclRlbXBsYXRlID0gdGVtcGxhdGUoCiAgICAvLyB0aGUgYGl0ZXJhYmxlYCBtYXkgYmUgcmVhc3NpZ25lZCBieSB0aGUgYHRvcGAgc25pcHBldAogICAgJ3ZhciBpbmRleCwgaXRlcmFibGUgPSA8JT0gZmlyc3RBcmcgJT4sICcgKwogICAgLy8gYXNzaWduIHRoZSBgcmVzdWx0YCB2YXJpYWJsZSBhbiBpbml0aWFsIHZhbHVlCiAgICAncmVzdWx0ID0gPCU9IGZpcnN0QXJnICU+O1xuJyArCiAgICAvLyBleGl0IGVhcmx5IGlmIHRoZSBmaXJzdCBhcmd1bWVudCBpcyBmYWxzZXkKICAgICdpZiAoITwlPSBmaXJzdEFyZyAlPikgcmV0dXJuIHJlc3VsdDtcbicgKwogICAgLy8gYWRkIGNvZGUgYmVmb3JlIHRoZSBpdGVyYXRpb24gYnJhbmNoZXMKICAgICc8JT0gdG9wICU+O1xuJyArCgogICAgLy8gYXJyYXktbGlrZSBpdGVyYXRpb246CiAgICAnPCUgaWYgKGFycmF5cykgeyAlPicgKwogICAgJ3ZhciBsZW5ndGggPSBpdGVyYWJsZS5sZW5ndGg7IGluZGV4ID0gLTE7XG4nICsKICAgICJpZiAoPCU9IGFycmF5cyAlPikgeyIgKwoKICAgIC8vIGFkZCBzdXBwb3J0IGZvciBhY2Nlc3Npbmcgc3RyaW5nIGNoYXJhY3RlcnMgYnkgaW5kZXggaWYgbmVlZGVkCiAgICAnICA8JSBpZiAobm9DaGFyQnlJbmRleCkgeyAlPlxuJyArCiAgICAnICBpZiAoaXNTdHJpbmcoaXRlcmFibGUpKSB7XG4nICsKICAgICIgICAgaXRlcmFibGUgPSBpdGVyYWJsZS5zcGxpdCgnJylcbiIgKwogICAgJyAgfScgKwogICAgJyAgPCUgfSAlPlxuJyArCgogICAgLy8gaXRlcmF0ZSBvdmVyIHRoZSBhcnJheS1saWtlIHZhbHVlCiAgICAnICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkge1xuJyArCiAgICAnICAgIDwlPSBsb29wICU+XG4nICsKICAgICcgIH1cbicgKwogICAgJ31cbicgKwogICAgJ2Vsc2UgeycgKwoKICAgIC8vIG9iamVjdCBpdGVyYXRpb246CiAgICAvLyBhZGQgc3VwcG9ydCBmb3IgaXRlcmF0aW5nIG92ZXIgYGFyZ3VtZW50c2Agb2JqZWN0cyBpZiBuZWVkZWQKICAgICcgIDwlICB9IGVsc2UgaWYgKG5vbkVudW1BcmdzKSB7ICU+XG4nICsKICAgICcgIHZhciBsZW5ndGggPSBpdGVyYWJsZS5sZW5ndGg7IGluZGV4ID0gLTE7XG4nICsKICAgICcgIGlmIChsZW5ndGggJiYgaXNBcmd1bWVudHMoaXRlcmFibGUpKSB7XG4nICsKICAgICcgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHtcbicgKwogICAgIiAgICAgIGluZGV4ICs9ICcnO1xuIiArCiAgICAnICAgICAgPCU9IGxvb3AgJT5cbicgKwogICAgJyAgICB9XG4nICsKICAgICcgIH0gZWxzZSB7JyArCiAgICAnICA8JSB9ICU+JyArCgogICAgLy8gRmlyZWZveCA8IDMuNiwgT3BlcmEgPiA5LjUwIC0gT3BlcmEgPCAxMS42MCwgYW5kIFNhZmFyaSA8IDUuMQogICAgLy8gKGlmIHRoZSBwcm90b3R5cGUgb3IgYSBwcm9wZXJ0eSBvbiB0aGUgcHJvdG90eXBlIGhhcyBiZWVuIHNldCkKICAgIC8vIGluY29ycmVjdGx5IHNldHMgYSBmdW5jdGlvbidzIGBwcm90b3R5cGVgIHByb3BlcnR5IFtbRW51bWVyYWJsZV1dCiAgICAvLyB2YWx1ZSB0byBgdHJ1ZWAuIEJlY2F1c2Ugb2YgdGhpcyBMby1EYXNoIHN0YW5kYXJkaXplcyBvbiBza2lwcGluZwogICAgLy8gdGhlIHRoZSBgcHJvdG90eXBlYCBwcm9wZXJ0eSBvZiBmdW5jdGlvbnMgcmVnYXJkbGVzcyBvZiBpdHMKICAgIC8vIFtbRW51bWVyYWJsZV1dIHZhbHVlLgogICAgJyAgPCUgaWYgKCFoYXNEb250RW51bUJ1ZykgeyAlPlxuJyArCiAgICAiICB2YXIgc2tpcFByb3RvID0gdHlwZW9mIGl0ZXJhYmxlID09ICdmdW5jdGlvbicgJiYgXG4iICsKICAgICIgICAgcHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChpdGVyYWJsZSwgJ3Byb3RvdHlwZScpO1xuIiArCiAgICAnICA8JSB9ICU+JyArCgogICAgLy8gaXRlcmF0ZSBvd24gcHJvcGVydGllcyB1c2luZyBgT2JqZWN0LmtleXNgIGlmIGl0J3MgZmFzdAogICAgJyAgPCUgaWYgKGlzS2V5c0Zhc3QgJiYgdXNlSGFzKSB7ICU+XG4nICsKICAgICcgIHZhciBvd25JbmRleCA9IC0xLFxuJyArCiAgICAnICAgICAgb3duUHJvcHMgPSBvYmplY3RUeXBlc1t0eXBlb2YgaXRlcmFibGVdID8gbmF0aXZlS2V5cyhpdGVyYWJsZSkgOiBbXSxcbicgKwogICAgJyAgICAgIGxlbmd0aCA9IG93blByb3BzLmxlbmd0aDtcblxuJyArCiAgICAnICB3aGlsZSAoKytvd25JbmRleCA8IGxlbmd0aCkge1xuJyArCiAgICAnICAgIGluZGV4ID0gb3duUHJvcHNbb3duSW5kZXhdO1xuJyArCiAgICAiICAgIDwlIGlmICghaGFzRG9udEVudW1CdWcpIHsgJT5pZiAoIShza2lwUHJvdG8gJiYgaW5kZXggPT0gJ3Byb3RvdHlwZScpKSB7XG4gIDwlIH0gJT4iICsKICAgICcgICAgPCU9IGxvb3AgJT5cbicgKwogICAgJyAgICA8JSBpZiAoIWhhc0RvbnRFbnVtQnVnKSB7ICU+fVxuPCUgfSAlPicgKwogICAgJyAgfScgKwoKICAgIC8vIGVsc2UgdXNpbmcgYSBmb3ItaW4gbG9vcAogICAgJyAgPCUgfSBlbHNlIHsgJT5cbicgKwogICAgJyAgZm9yIChpbmRleCBpbiBpdGVyYWJsZSkgezwlJyArCiAgICAnICAgIGlmICghaGFzRG9udEVudW1CdWcgfHwgdXNlSGFzKSB7ICU+XG4gICAgaWYgKDwlJyArCiAgICAiICAgICAgaWYgKCFoYXNEb250RW51bUJ1ZykgeyAlPiEoc2tpcFByb3RvICYmIGluZGV4ID09ICdwcm90b3R5cGUnKTwlIH0iICsKICAgICcgICAgICBpZiAoIWhhc0RvbnRFbnVtQnVnICYmIHVzZUhhcykgeyAlPiAmJiA8JSB9JyArCiAgICAnICAgICAgaWYgKHVzZUhhcykgeyAlPmhhc093blByb3BlcnR5LmNhbGwoaXRlcmFibGUsIGluZGV4KTwlIH0nICsKICAgICcgICAgJT4pIHsnICsKICAgICcgICAgPCUgfSAlPlxuJyArCiAgICAnICAgIDwlPSBsb29wICU+OycgKwogICAgJyAgICA8JSBpZiAoIWhhc0RvbnRFbnVtQnVnIHx8IHVzZUhhcykgeyAlPlxuICAgIH08JSB9ICU+XG4nICsKICAgICcgIH0nICsKICAgICcgIDwlIH0gJT4nICsKCiAgICAvLyBCZWNhdXNlIElFIDwgOSBjYW4ndCBzZXQgdGhlIGBbW0VudW1lcmFibGVdXWAgYXR0cmlidXRlIG9mIGFuCiAgICAvLyBleGlzdGluZyBwcm9wZXJ0eSBhbmQgdGhlIGBjb25zdHJ1Y3RvcmAgcHJvcGVydHkgb2YgYSBwcm90b3R5cGUKICAgIC8vIGRlZmF1bHRzIHRvIG5vbi1lbnVtZXJhYmxlLCBMby1EYXNoIHNraXBzIHRoZSBgY29uc3RydWN0b3JgCiAgICAvLyBwcm9wZXJ0eSB3aGVuIGl0IGluZmVycyBpdCdzIGl0ZXJhdGluZyBvdmVyIGEgYHByb3RvdHlwZWAgb2JqZWN0LgogICAgJyAgPCUgaWYgKGhhc0RvbnRFbnVtQnVnKSB7ICU+XG5cbicgKwogICAgJyAgdmFyIGN0b3IgPSBpdGVyYWJsZS5jb25zdHJ1Y3RvcjtcbicgKwogICAgJyAgICA8JSBmb3IgKHZhciBrID0gMDsgayA8IDc7IGsrKykgeyAlPlxuJyArCiAgICAiICBpbmRleCA9ICc8JT0gc2hhZG93ZWRba10gJT4nO1xuIiArCiAgICAnICBpZiAoPCUnICsKICAgICIgICAgICBpZiAoc2hhZG93ZWRba10gPT0gJ2NvbnN0cnVjdG9yJykgeyIgKwogICAgJyAgICAgICAgJT4hKGN0b3IgJiYgY3Rvci5wcm90b3R5cGUgPT09IGl0ZXJhYmxlKSAmJiA8JScgKwogICAgJyAgICAgIH0gJT5oYXNPd25Qcm9wZXJ0eS5jYWxsKGl0ZXJhYmxlLCBpbmRleCkpIHtcbicgKwogICAgJyAgICA8JT0gbG9vcCAlPlxuJyArCiAgICAnICB9JyArCiAgICAnICAgIDwlIH0gJT4nICsKICAgICcgIDwlIH0gJT4nICsKICAgICcgIDwlIGlmIChhcnJheXMgfHwgbm9uRW51bUFyZ3MpIHsgJT5cbn08JSB9ICU+XG4nICsKCiAgICAvLyBhZGQgY29kZSB0byB0aGUgYm90dG9tIG9mIHRoZSBpdGVyYXRpb24gZnVuY3Rpb24KICAgICc8JT0gYm90dG9tICU+O1xuJyArCiAgICAvLyBmaW5hbGx5LCByZXR1cm4gdGhlIGByZXN1bHRgCiAgICAncmV0dXJuIHJlc3VsdCcKICApOwoKICAvKiogUmV1c2FibGUgaXRlcmF0b3Igb3B0aW9ucyBmb3IgYGFzc2lnbmAgYW5kIGBkZWZhdWx0c2AgKi8KICB2YXIgYXNzaWduSXRlcmF0b3JPcHRpb25zID0gewogICAgJ2FyZ3MnOiAnb2JqZWN0LCBzb3VyY2UsIGd1YXJkJywKICAgICd0b3AnOgogICAgICAndmFyIGFyZ3NJbmRleCA9IDAsXG4nICsKICAgICAgIiAgICBhcmdzTGVuZ3RoID0gdHlwZW9mIGd1YXJkID09ICdudW1iZXInID8gMiA6IGFyZ3VtZW50cy5sZW5ndGg7XG4iICsKICAgICAgJ3doaWxlICgrK2FyZ3NJbmRleCA8IGFyZ3NMZW5ndGgpIHtcbicgKwogICAgICAnICBpZiAoKGl0ZXJhYmxlID0gYXJndW1lbnRzW2FyZ3NJbmRleF0pKSB7JywKICAgICdsb29wJzogJ3Jlc3VsdFtpbmRleF0gPSBpdGVyYWJsZVtpbmRleF0nLAogICAgJ2JvdHRvbSc6ICcgIH1cbn0nCiAgfTsKCiAgLyoqIFJldXNhYmxlIGl0ZXJhdG9yIG9wdGlvbnMgc2hhcmVkIGJ5IGBlYWNoYCwgYGZvckluYCwgYW5kIGBmb3JPd25gICovCiAgdmFyIGVhY2hJdGVyYXRvck9wdGlvbnMgPSB7CiAgICAnYXJncyc6ICdjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZycsCiAgICAndG9wJzogImNhbGxiYWNrID0gY2FsbGJhY2sgJiYgdHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgPyBjYWxsYmFjayA6IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKSIsCiAgICAnYXJyYXlzJzogInR5cGVvZiBsZW5ndGggPT0gJ251bWJlciciLAogICAgJ2xvb3AnOiAnaWYgKGNhbGxiYWNrKGl0ZXJhYmxlW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pID09PSBmYWxzZSkgcmV0dXJuIHJlc3VsdCcKICB9OwoKICAvKiogUmV1c2FibGUgaXRlcmF0b3Igb3B0aW9ucyBmb3IgYGZvckluYCBhbmQgYGZvck93bmAgKi8KICB2YXIgZm9yT3duSXRlcmF0b3JPcHRpb25zID0gewogICAgJ2FycmF5cyc6IGZhbHNlCiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiBvcHRpbWl6ZWQgdG8gc2VhcmNoIGxhcmdlIGFycmF5cyBmb3IgYSBnaXZlbiBgdmFsdWVgLAogICAqIHN0YXJ0aW5nIGF0IGBmcm9tSW5kZXhgLCB1c2luZyBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2VhcmNoLgogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAqIEBwYXJhbSB7TnVtYmVyfSBbZnJvbUluZGV4PTBdIFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgKiBAcGFyYW0ge051bWJlcn0gW2xhcmdlU2l6ZT0zMF0gVGhlIGxlbmd0aCBhdCB3aGljaCBhbiBhcnJheSBpcyBjb25zaWRlcmVkIGxhcmdlLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgYHZhbHVlYCBpcyBmb3VuZCwgZWxzZSBgZmFsc2VgLgogICAqLwogIGZ1bmN0aW9uIGNhY2hlZENvbnRhaW5zKGFycmF5LCBmcm9tSW5kZXgsIGxhcmdlU2l6ZSkgewogICAgZnJvbUluZGV4IHx8IChmcm9tSW5kZXggPSAwKTsKCiAgICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoLAogICAgICAgIGlzTGFyZ2UgPSAobGVuZ3RoIC0gZnJvbUluZGV4KSA+PSAobGFyZ2VTaXplIHx8IGxhcmdlQXJyYXlTaXplKTsKCiAgICBpZiAoaXNMYXJnZSkgewogICAgICB2YXIgY2FjaGUgPSB7fSwKICAgICAgICAgIGluZGV4ID0gZnJvbUluZGV4IC0gMTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgLy8gbWFudWFsbHkgY29lcmNlIGB2YWx1ZWAgdG8gYSBzdHJpbmcgYmVjYXVzZSBgaGFzT3duUHJvcGVydHlgLCBpbiBzb21lCiAgICAgICAgLy8gb2xkZXIgdmVyc2lvbnMgb2YgRmlyZWZveCwgY29lcmNlcyBvYmplY3RzIGluY29ycmVjdGx5CiAgICAgICAgdmFyIGtleSA9IGFycmF5W2luZGV4XSArICcnOwogICAgICAgIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlLCBrZXkpID8gY2FjaGVba2V5XSA6IChjYWNoZVtrZXldID0gW10pKS5wdXNoKGFycmF5W2luZGV4XSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoaXNMYXJnZSkgewogICAgICAgIHZhciBrZXkgPSB2YWx1ZSArICcnOwogICAgICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlLCBrZXkpICYmIGluZGV4T2YoY2FjaGVba2V5XSwgdmFsdWUpID4gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIGluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpID4gLTE7CiAgICB9CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGBfLm1heGAgYW5kIGBfLm1pbmAgYXMgdGhlIGRlZmF1bHQgYGNhbGxiYWNrYCB3aGVuIGEgZ2l2ZW4KICAgKiBgY29sbGVjdGlvbmAgaXMgYSBzdHJpbmcgdmFsdWUuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSBUaGUgY2hhcmFjdGVyIHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgY29kZSB1bml0IG9mIGdpdmVuIGNoYXJhY3Rlci4KICAgKi8KICBmdW5jdGlvbiBjaGFyQXRDYWxsYmFjayh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlLmNoYXJDb2RlQXQoMCk7CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGBzb3J0QnlgIHRvIGNvbXBhcmUgdHJhbnNmb3JtZWQgYGNvbGxlY3Rpb25gIHZhbHVlcywgc3RhYmxlIHNvcnRpbmcKICAgKiB0aGVtIGluIGFzY2VuZGluZyBvcmRlci4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IGEgVGhlIG9iamVjdCB0byBjb21wYXJlIHRvIGBiYC4KICAgKiBAcGFyYW0ge09iamVjdH0gYiBUaGUgb2JqZWN0IHRvIGNvbXBhcmUgdG8gYGFgLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIHNvcnQgb3JkZXIgaW5kaWNhdG9yIG9mIGAxYCBvciBgLTFgLgogICAqLwogIGZ1bmN0aW9uIGNvbXBhcmVBc2NlbmRpbmcoYSwgYikgewogICAgdmFyIGFpID0gYS5pbmRleCwKICAgICAgICBiaSA9IGIuaW5kZXg7CgogICAgYSA9IGEuY3JpdGVyaWE7CiAgICBiID0gYi5jcml0ZXJpYTsKCiAgICAvLyBlbnN1cmUgYSBzdGFibGUgc29ydCBpbiBWOCBhbmQgb3RoZXIgZW5naW5lcwogICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL3Y4L2lzc3Vlcy9kZXRhaWw/aWQ9OTAKICAgIGlmIChhICE9PSBiKSB7CiAgICAgIGlmIChhID4gYiB8fCB0eXBlb2YgYSA9PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiAxOwogICAgICB9CiAgICAgIGlmIChhIDwgYiB8fCB0eXBlb2YgYiA9PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiAtMTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGFpIDwgYmkgPyAtMSA6IDE7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgYGZ1bmNgIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nCiAgICogb2YgYHRoaXNBcmdgIGFuZCBwcmVwZW5kcyBhbnkgYHBhcnRpYWxBcmdzYCB0byB0aGUgYXJndW1lbnRzIHBhc3NlZCB0byB0aGUKICAgKiBib3VuZCBmdW5jdGlvbi4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGJpbmQgb3IgdGhlIG1ldGhvZCBuYW1lLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgLgogICAqIEBwYXJhbSB7QXJyYXl9IHBhcnRpYWxBcmdzIEFuIGFycmF5IG9mIGFyZ3VtZW50cyB0byBiZSBwYXJ0aWFsbHkgYXBwbGllZC4KICAgKiBAcGFyYW0ge09iamVjdH0gW3JpZ2h0XSBVc2VkIHRvIGluZGljYXRlIHBhcnRpYWxseSBhcHBseWluZyBhcmd1bWVudHMgZnJvbSB0aGUgcmlnaHQuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgYm91bmQgZnVuY3Rpb24uCiAgICovCiAgZnVuY3Rpb24gY3JlYXRlQm91bmQoZnVuYywgdGhpc0FyZywgcGFydGlhbEFyZ3MsIHJpZ2h0KSB7CiAgICB2YXIgaXNGdW5jID0gaXNGdW5jdGlvbihmdW5jKSwKICAgICAgICBpc1BhcnRpYWwgPSAhcGFydGlhbEFyZ3MsCiAgICAgICAga2V5ID0gdGhpc0FyZzsKCiAgICAvLyBqdWdnbGUgYXJndW1lbnRzCiAgICBpZiAoaXNQYXJ0aWFsKSB7CiAgICAgIHBhcnRpYWxBcmdzID0gdGhpc0FyZzsKICAgIH0KICAgIGlmICghaXNGdW5jKSB7CiAgICAgIHRoaXNBcmcgPSBmdW5jOwogICAgfQoKICAgIGZ1bmN0aW9uIGJvdW5kKCkgewogICAgICAvLyBgRnVuY3Rpb24jYmluZGAgc3BlYwogICAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxNS4zLjQuNQogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgIHRoaXNCaW5kaW5nID0gaXNQYXJ0aWFsID8gdGhpcyA6IHRoaXNBcmc7CgogICAgICBpZiAoIWlzRnVuYykgewogICAgICAgIGZ1bmMgPSB0aGlzQXJnW2tleV07CiAgICAgIH0KICAgICAgaWYgKHBhcnRpYWxBcmdzLmxlbmd0aCkgewogICAgICAgIGFyZ3MgPSBhcmdzLmxlbmd0aAogICAgICAgICAgPyAoYXJncyA9IHNsaWNlKGFyZ3MpLCByaWdodCA/IGFyZ3MuY29uY2F0KHBhcnRpYWxBcmdzKSA6IHBhcnRpYWxBcmdzLmNvbmNhdChhcmdzKSkKICAgICAgICAgIDogcGFydGlhbEFyZ3M7CiAgICAgIH0KICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkgewogICAgICAgIC8vIGVuc3VyZSBgbmV3IGJvdW5kYCBpcyBhbiBpbnN0YW5jZSBvZiBgYm91bmRgIGFuZCBgZnVuY2AKICAgICAgICBub29wLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwogICAgICAgIHRoaXNCaW5kaW5nID0gbmV3IG5vb3A7CiAgICAgICAgbm9vcC5wcm90b3R5cGUgPSBudWxsOwoKICAgICAgICAvLyBtaW1pYyB0aGUgY29uc3RydWN0b3IncyBgcmV0dXJuYCBiZWhhdmlvcgogICAgICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmNvbS8jeDEzLjIuMgogICAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNCaW5kaW5nLCBhcmdzKTsKICAgICAgICByZXR1cm4gaXNPYmplY3QocmVzdWx0KSA/IHJlc3VsdCA6IHRoaXNCaW5kaW5nOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXNCaW5kaW5nLCBhcmdzKTsKICAgIH0KICAgIHJldHVybiBib3VuZDsKICB9CgogIC8qKgogICAqIFByb2R1Y2VzIGFuIGl0ZXJhdGlvbiBjYWxsYmFjayBib3VuZCB0byBhbiBvcHRpb25hbCBgdGhpc0FyZ2AuIElmIGBmdW5jYCBpcwogICAqIGEgcHJvcGVydHkgbmFtZSwgdGhlIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBmb3IgYSBnaXZlbiBlbGVtZW50LgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gW2Z1bmM9aWRlbnRpdHl8cHJvcGVydHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyCiAgICogaXRlcmF0aW9uIG9yIHByb3BlcnR5IG5hbWUgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEBwYXJhbSB7T2JqZWN0fSBbYWNjdW11bGF0aW5nXSBVc2VkIHRvIGluZGljYXRlIHRoYXQgdGhlIGNhbGxiYWNrIHNob3VsZAogICAqICBhY2NlcHQgYW4gYGFjY3VtdWxhdG9yYCBhcmd1bWVudC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgYSBjYWxsYmFjayBmdW5jdGlvbi4KICAgKi8KICBmdW5jdGlvbiBjcmVhdGVDYWxsYmFjayhmdW5jLCB0aGlzQXJnLCBhY2N1bXVsYXRpbmcpIHsKICAgIGlmICghZnVuYykgewogICAgICByZXR1cm4gaWRlbnRpdHk7CiAgICB9CiAgICB2YXIgdHlwZSA9IHR5cGVvZiBmdW5jOwogICAgaWYgKHR5cGUgIT0gJ2Z1bmN0aW9uJykgewogICAgICBpZiAodHlwZSAhPSAnb2JqZWN0JykgewogICAgICAgIHJldHVybiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgIHJldHVybiBvYmplY3RbZnVuY107CiAgICAgICAgfTsKICAgICAgfQogICAgICB2YXIgcHJvcHMgPSBrZXlzKGZ1bmMpOwogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICAgICAgcmVzdWx0ID0gZmFsc2U7CiAgICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBpc0VxdWFsKG9iamVjdFtwcm9wc1tsZW5ndGhdXSwgZnVuY1twcm9wc1tsZW5ndGhdXSkpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfQogICAgaWYgKHR5cGVvZiB0aGlzQXJnICE9ICd1bmRlZmluZWQnKSB7CiAgICAgIGlmIChhY2N1bXVsYXRpbmcpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgICByZXR1cm4gZnVuYy5jYWxsKHRoaXNBcmcsIGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIG9iamVjdCk7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUsIGluZGV4LCBvYmplY3QpIHsKICAgICAgICByZXR1cm4gZnVuYy5jYWxsKHRoaXNBcmcsIHZhbHVlLCBpbmRleCwgb2JqZWN0KTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBmdW5jOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBjb21waWxlZCBpdGVyYXRpb24gZnVuY3Rpb25zLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnMxLCBvcHRpb25zMiwgLi4uXSBUaGUgY29tcGlsZSBvcHRpb25zIG9iamVjdChzKS4KICAgKiAgYXJyYXlzIC0gQSBzdHJpbmcgb2YgY29kZSB0byBkZXRlcm1pbmUgaWYgdGhlIGl0ZXJhYmxlIGlzIGFuIGFycmF5IG9yIGFycmF5LWxpa2UuCiAgICogIHVzZUhhcyAtIEEgYm9vbGVhbiB0byBzcGVjaWZ5IHVzaW5nIGBoYXNPd25Qcm9wZXJ0eWAgY2hlY2tzIGluIHRoZSBvYmplY3QgbG9vcC4KICAgKiAgYXJncyAtIEEgc3RyaW5nIG9mIGNvbW1hIHNlcGFyYXRlZCBhcmd1bWVudHMgdGhlIGl0ZXJhdGlvbiBmdW5jdGlvbiB3aWxsIGFjY2VwdC4KICAgKiAgdG9wIC0gQSBzdHJpbmcgb2YgY29kZSB0byBleGVjdXRlIGJlZm9yZSB0aGUgaXRlcmF0aW9uIGJyYW5jaGVzLgogICAqICBsb29wIC0gQSBzdHJpbmcgb2YgY29kZSB0byBleGVjdXRlIGluIHRoZSBvYmplY3QgbG9vcC4KICAgKiAgYm90dG9tIC0gQSBzdHJpbmcgb2YgY29kZSB0byBleGVjdXRlIGFmdGVyIHRoZSBpdGVyYXRpb24gYnJhbmNoZXMuCiAgICoKICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uLgogICAqLwogIGZ1bmN0aW9uIGNyZWF0ZUl0ZXJhdG9yKCkgewogICAgdmFyIGRhdGEgPSB7CiAgICAgIC8vIHN1cHBvcnQgcHJvcGVydGllcwogICAgICAnaGFzRG9udEVudW1CdWcnOiBoYXNEb250RW51bUJ1ZywKICAgICAgJ2lzS2V5c0Zhc3QnOiBpc0tleXNGYXN0LAogICAgICAnbm9uRW51bUFyZ3MnOiBub25FbnVtQXJncywKICAgICAgJ25vQ2hhckJ5SW5kZXgnOiBub0NoYXJCeUluZGV4LAogICAgICAnc2hhZG93ZWQnOiBzaGFkb3dlZCwKCiAgICAgIC8vIGl0ZXJhdG9yIG9wdGlvbnMKICAgICAgJ2FycmF5cyc6ICdpc0FycmF5KGl0ZXJhYmxlKScsCiAgICAgICdib3R0b20nOiAnJywKICAgICAgJ2xvb3AnOiAnJywKICAgICAgJ3RvcCc6ICcnLAogICAgICAndXNlSGFzJzogdHJ1ZQogICAgfTsKCiAgICAvLyBtZXJnZSBvcHRpb25zIGludG8gYSB0ZW1wbGF0ZSBkYXRhIG9iamVjdAogICAgZm9yICh2YXIgb2JqZWN0LCBpbmRleCA9IDA7IG9iamVjdCA9IGFyZ3VtZW50c1tpbmRleF07IGluZGV4KyspIHsKICAgICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgewogICAgICAgIGRhdGFba2V5XSA9IG9iamVjdFtrZXldOwogICAgICB9CiAgICB9CiAgICB2YXIgYXJncyA9IGRhdGEuYXJnczsKICAgIGRhdGEuZmlyc3RBcmcgPSAvXlteLF0rLy5leGVjKGFyZ3MpWzBdOwoKICAgIC8vIGNyZWF0ZSB0aGUgZnVuY3Rpb24gZmFjdG9yeQogICAgdmFyIGZhY3RvcnkgPSBGdW5jdGlvbigKICAgICAgICAnY3JlYXRlQ2FsbGJhY2ssIGhhc093blByb3BlcnR5LCBpc0FyZ3VtZW50cywgaXNBcnJheSwgaXNTdHJpbmcsICcgKwogICAgICAgICdvYmplY3RUeXBlcywgbmF0aXZlS2V5cywgcHJvcGVydHlJc0VudW1lcmFibGUnLAogICAgICAncmV0dXJuIGZ1bmN0aW9uKCcgKyBhcmdzICsgJykge1xuJyArIGl0ZXJhdG9yVGVtcGxhdGUoZGF0YSkgKyAnXG59JwogICAgKTsKICAgIC8vIHJldHVybiB0aGUgY29tcGlsZWQgZnVuY3Rpb24KICAgIHJldHVybiBmYWN0b3J5KAogICAgICBjcmVhdGVDYWxsYmFjaywgaGFzT3duUHJvcGVydHksIGlzQXJndW1lbnRzLCBpc0FycmF5LCBpc1N0cmluZywKICAgICAgb2JqZWN0VHlwZXMsIG5hdGl2ZUtleXMsIHByb3BlcnR5SXNFbnVtZXJhYmxlCiAgICApOwogIH0KCiAgLyoqCiAgICogQSBmdW5jdGlvbiBjb21waWxlZCB0byBpdGVyYXRlIGBhcmd1bWVudHNgIG9iamVjdHMsIGFycmF5cywgb2JqZWN0cywgYW5kCiAgICogc3RyaW5ncyBjb25zaXN0ZW5seSBhY3Jvc3MgZW52aXJvbm1lbnRzLCBleGVjdXRpbmcgdGhlIGBjYWxsYmFja2AgZm9yIGVhY2gKICAgKiBlbGVtZW50IGluIHRoZSBgY29sbGVjdGlvbmAuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZAogICAqIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuIENhbGxiYWNrcyBtYXkgZXhpdAogICAqIGl0ZXJhdGlvbiBlYXJseSBieSBleHBsaWNpdGx5IHJldHVybmluZyBgZmFsc2VgLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl8T2JqZWN0fFN0cmluZ30gUmV0dXJucyBgY29sbGVjdGlvbmAuCiAgICovCiAgdmFyIGVhY2ggPSBjcmVhdGVJdGVyYXRvcihlYWNoSXRlcmF0b3JPcHRpb25zKTsKCiAgLyoqCiAgICogVXNlZCBieSBgdGVtcGxhdGVgIHRvIGVzY2FwZSBjaGFyYWN0ZXJzIGZvciBpbmNsdXNpb24gaW4gY29tcGlsZWQKICAgKiBzdHJpbmcgbGl0ZXJhbHMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7U3RyaW5nfSBtYXRjaCBUaGUgbWF0Y2hlZCBjaGFyYWN0ZXIgdG8gZXNjYXBlLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgdGhlIGVzY2FwZWQgY2hhcmFjdGVyLgogICAqLwogIGZ1bmN0aW9uIGVzY2FwZVN0cmluZ0NoYXIobWF0Y2gpIHsKICAgIHJldHVybiAnXFwnICsgc3RyaW5nRXNjYXBlc1ttYXRjaF07CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGBlc2NhcGVgIHRvIGNvbnZlcnQgY2hhcmFjdGVycyB0byBIVE1MIGVudGl0aWVzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge1N0cmluZ30gbWF0Y2ggVGhlIG1hdGNoZWQgY2hhcmFjdGVyIHRvIGVzY2FwZS4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSBlc2NhcGVkIGNoYXJhY3Rlci4KICAgKi8KICBmdW5jdGlvbiBlc2NhcGVIdG1sQ2hhcihtYXRjaCkgewogICAgcmV0dXJuIGh0bWxFc2NhcGVzW21hdGNoXTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgRE9NIG5vZGUgaW4gSUUgPCA5LgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgRE9NIG5vZGUsIGVsc2UgYGZhbHNlYC4KICAgKi8KICBmdW5jdGlvbiBpc05vZGUodmFsdWUpIHsKICAgIC8vIElFIDwgOSBwcmVzZW50cyBET00gbm9kZXMgYXMgYE9iamVjdGAgb2JqZWN0cyBleGNlcHQgdGhleSBoYXZlIGB0b1N0cmluZ2AKICAgIC8vIG1ldGhvZHMgdGhhdCBhcmUgYHR5cGVvZmAgInN0cmluZyIgYW5kIHN0aWxsIGNhbiBjb2VyY2Ugbm9kZXMgdG8gc3RyaW5ncwogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZS50b1N0cmluZyAhPSAnZnVuY3Rpb24nICYmIHR5cGVvZiAodmFsdWUgKyAnJykgPT0gJ3N0cmluZyc7CiAgfQoKICAvKioKICAgKiBBIG5vLW9wZXJhdGlvbiBmdW5jdGlvbi4KICAgKgogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gbm9vcCgpIHsKICAgIC8vIG5vIG9wZXJhdGlvbiBwZXJmb3JtZWQKICB9CgogIC8qKgogICAqIFNsaWNlcyB0aGUgYGNvbGxlY3Rpb25gIGZyb20gdGhlIGBzdGFydGAgaW5kZXggdXAgdG8sIGJ1dCBub3QgaW5jbHVkaW5nLAogICAqIHRoZSBgZW5kYCBpbmRleC4KICAgKgogICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgdXNlZCwgaW5zdGVhZCBvZiBgQXJyYXkjc2xpY2VgLCB0byBzdXBwb3J0IG5vZGUgbGlzdHMKICAgKiBpbiBJRSA8IDkgYW5kIHRvIGVuc3VyZSBkZW5zZSBhcnJheXMgYXJlIHJldHVybmVkLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gc2xpY2UuCiAgICogQHBhcmFtIHtOdW1iZXJ9IHN0YXJ0IFRoZSBzdGFydCBpbmRleC4KICAgKiBAcGFyYW0ge051bWJlcn0gZW5kIFRoZSBlbmQgaW5kZXguCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgYXJyYXkuCiAgICovCiAgZnVuY3Rpb24gc2xpY2UoYXJyYXksIHN0YXJ0LCBlbmQpIHsKICAgIHN0YXJ0IHx8IChzdGFydCA9IDApOwogICAgaWYgKHR5cGVvZiBlbmQgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgZW5kID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwogICAgfQogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gZW5kIC0gc3RhcnQgfHwgMCwKICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGggPCAwID8gMCA6IGxlbmd0aCk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0W2luZGV4XSA9IGFycmF5W3N0YXJ0ICsgaW5kZXhdOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFVzZWQgYnkgYHVuZXNjYXBlYCB0byBjb252ZXJ0IEhUTUwgZW50aXRpZXMgdG8gY2hhcmFjdGVycy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtTdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byB1bmVzY2FwZS4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSB1bmVzY2FwZWQgY2hhcmFjdGVyLgogICAqLwogIGZ1bmN0aW9uIHVuZXNjYXBlSHRtbENoYXIobWF0Y2gpIHsKICAgIHJldHVybiBodG1sVW5lc2NhcGVzW21hdGNoXTsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhbiBgYXJndW1lbnRzYCBvYmplY3QuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGFuIGBhcmd1bWVudHNgIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiAoZnVuY3Rpb24oKSB7IHJldHVybiBfLmlzQXJndW1lbnRzKGFyZ3VtZW50cyk7IH0pKDEsIDIsIDMpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNBcmd1bWVudHMoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGlzQXJndW1lbnRzKHZhbHVlKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gYXJnc0NsYXNzOwogIH0KICAvLyBmYWxsYmFjayBmb3IgYnJvd3NlcnMgdGhhdCBjYW4ndCBkZXRlY3QgYGFyZ3VtZW50c2Agb2JqZWN0cyBieSBbW0NsYXNzXV0KICBpZiAobm9BcmdzQ2xhc3MpIHsKICAgIGlzQXJndW1lbnRzID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID8gaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgJ2NhbGxlZScpIDogZmFsc2U7CiAgICB9OwogIH0KCiAgLyoqCiAgICogSXRlcmF0ZXMgb3ZlciBgb2JqZWN0YCdzIG93biBhbmQgaW5oZXJpdGVkIGVudW1lcmFibGUgcHJvcGVydGllcywgZXhlY3V0aW5nCiAgICogdGhlIGBjYWxsYmFja2AgZm9yIGVhY2ggcHJvcGVydHkuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQKICAgKiBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGtleSwgb2JqZWN0KS4gQ2FsbGJhY2tzIG1heSBleGl0IGl0ZXJhdGlvbgogICAqIGVhcmx5IGJ5IGV4cGxpY2l0bHkgcmV0dXJuaW5nIGBmYWxzZWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIGZ1bmN0aW9uIERvZyhuYW1lKSB7CiAgICogICB0aGlzLm5hbWUgPSBuYW1lOwogICAqIH0KICAgKgogICAqIERvZy5wcm90b3R5cGUuYmFyayA9IGZ1bmN0aW9uKCkgewogICAqICAgYWxlcnQoJ1dvb2YsIHdvb2YhJyk7CiAgICogfTsKICAgKgogICAqIF8uZm9ySW4obmV3IERvZygnRGFnbnknKSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAqICAgYWxlcnQoa2V5KTsKICAgKiB9KTsKICAgKiAvLyA9PiBhbGVydHMgJ25hbWUnIGFuZCAnYmFyaycgKG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAqLwogIHZhciBmb3JJbiA9IGNyZWF0ZUl0ZXJhdG9yKGVhY2hJdGVyYXRvck9wdGlvbnMsIGZvck93bkl0ZXJhdG9yT3B0aW9ucywgewogICAgJ3VzZUhhcyc6IGZhbHNlCiAgfSk7CgogIC8qKgogICAqIEl0ZXJhdGVzIG92ZXIgYW4gb2JqZWN0J3Mgb3duIGVudW1lcmFibGUgcHJvcGVydGllcywgZXhlY3V0aW5nIHRoZSBgY2FsbGJhY2tgCiAgICogZm9yIGVhY2ggcHJvcGVydHkuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICogYXJndW1lbnRzOyAodmFsdWUsIGtleSwgb2JqZWN0KS4gQ2FsbGJhY2tzIG1heSBleGl0IGl0ZXJhdGlvbiBlYXJseSBieSBleHBsaWNpdGx5CiAgICogcmV0dXJuaW5nIGBmYWxzZWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZm9yT3duKHsgJzAnOiAnemVybycsICcxJzogJ29uZScsICdsZW5ndGgnOiAyIH0sIGZ1bmN0aW9uKG51bSwga2V5KSB7CiAgICogICBhbGVydChrZXkpOwogICAqIH0pOwogICAqIC8vID0+IGFsZXJ0cyAnMCcsICcxJywgYW5kICdsZW5ndGgnIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICB2YXIgZm9yT3duID0gY3JlYXRlSXRlcmF0b3IoZWFjaEl0ZXJhdG9yT3B0aW9ucywgZm9yT3duSXRlcmF0b3JPcHRpb25zKTsKCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYW4gYXJyYXkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGFuIGFycmF5LCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIChmdW5jdGlvbigpIHsgcmV0dXJuIF8uaXNBcnJheShhcmd1bWVudHMpOyB9KSgpOwogICAqIC8vID0+IGZhbHNlCiAgICoKICAgKiBfLmlzQXJyYXkoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgdmFyIGlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAvLyBgaW5zdGFuY2VvZmAgbWF5IGNhdXNlIGEgbWVtb3J5IGxlYWsgaW4gSUUgNyBpZiBgdmFsdWVgIGlzIGEgaG9zdCBvYmplY3QKICAgIC8vIGh0dHA6Ly9hamF4aWFuLmNvbS9hcmNoaXZlcy93b3JraW5nLWFyb3VuZy10aGUtaW5zdGFuY2VvZi1tZW1vcnktbGVhawogICAgcmV0dXJuIChhcmdzQXJlT2JqZWN0cyAmJiB2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBhcnJheUNsYXNzOwogIH07CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgY29tcG9zZWQgb2YgdGhlIG93biBlbnVtZXJhYmxlIHByb3BlcnR5IG5hbWVzIG9mIGBvYmplY3RgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ua2V5cyh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgKiAvLyA9PiBbJ29uZScsICd0d28nLCAndGhyZWUnXSAob3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpCiAgICovCiAgdmFyIGtleXMgPSAhbmF0aXZlS2V5cyA/IHNoaW1LZXlzIDogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAvLyBhdm9pZCBpdGVyYXRpbmcgb3ZlciB0aGUgYHByb3RvdHlwZWAgcHJvcGVydHkKICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09ICdmdW5jdGlvbicgJiYgcHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChvYmplY3QsICdwcm90b3R5cGUnKQogICAgICA/IHNoaW1LZXlzKG9iamVjdCkKICAgICAgOiAoaXNPYmplY3Qob2JqZWN0KSA/IG5hdGl2ZUtleXMob2JqZWN0KSA6IFtdKTsKICB9OwoKICAvKioKICAgKiBBIGZhbGxiYWNrIGltcGxlbWVudGF0aW9uIG9mIGBpc1BsYWluT2JqZWN0YCB0aGF0IGNoZWNrcyBpZiBhIGdpdmVuIGB2YWx1ZWAKICAgKiBpcyBhbiBvYmplY3QgY3JlYXRlZCBieSB0aGUgYE9iamVjdGAgY29uc3RydWN0b3IsIGFzc3VtaW5nIG9iamVjdHMgY3JlYXRlZAogICAqIGJ5IHRoZSBgT2JqZWN0YCBjb25zdHJ1Y3RvciBoYXZlIG5vIGluaGVyaXRlZCBlbnVtZXJhYmxlIHByb3BlcnRpZXMgYW5kIHRoYXQKICAgKiB0aGVyZSBhcmUgbm8gYE9iamVjdC5wcm90b3R5cGVgIGV4dGVuc2lvbnMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIGB2YWx1ZWAgaXMgYSBwbGFpbiBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgKi8KICBmdW5jdGlvbiBzaGltSXNQbGFpbk9iamVjdCh2YWx1ZSkgewogICAgLy8gYXZvaWQgbm9uLW9iamVjdHMgYW5kIGZhbHNlIHBvc2l0aXZlcyBmb3IgYGFyZ3VtZW50c2Agb2JqZWN0cwogICAgdmFyIHJlc3VsdCA9IGZhbHNlOwogICAgaWYgKCEodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnKSB8fCBpc0FyZ3VtZW50cyh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8vIGNoZWNrIHRoYXQgdGhlIGNvbnN0cnVjdG9yIGlzIGBPYmplY3RgIChpLmUuIGBPYmplY3QgaW5zdGFuY2VvZiBPYmplY3RgKQogICAgdmFyIGN0b3IgPSB2YWx1ZS5jb25zdHJ1Y3RvcjsKICAgIGlmICgoIWlzRnVuY3Rpb24oY3RvcikgJiYgKCFub05vZGVDbGFzcyB8fCAhaXNOb2RlKHZhbHVlKSkpIHx8IGN0b3IgaW5zdGFuY2VvZiBjdG9yKSB7CiAgICAgIC8vIElFIDwgOSBpdGVyYXRlcyBpbmhlcml0ZWQgcHJvcGVydGllcyBiZWZvcmUgb3duIHByb3BlcnRpZXMuIElmIHRoZSBmaXJzdAogICAgICAvLyBpdGVyYXRlZCBwcm9wZXJ0eSBpcyBhbiBvYmplY3QncyBvd24gcHJvcGVydHkgdGhlbiB0aGVyZSBhcmUgbm8gaW5oZXJpdGVkCiAgICAgIC8vIGVudW1lcmFibGUgcHJvcGVydGllcy4KICAgICAgaWYgKGl0ZXJhdGVzT3duTGFzdCkgewogICAgICAgIGZvckluKHZhbHVlLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICAgIHJlc3VsdCA9ICFoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0ID09PSBmYWxzZTsKICAgICAgfQogICAgICAvLyBJbiBtb3N0IGVudmlyb25tZW50cyBhbiBvYmplY3QncyBvd24gcHJvcGVydGllcyBhcmUgaXRlcmF0ZWQgYmVmb3JlCiAgICAgIC8vIGl0cyBpbmhlcml0ZWQgcHJvcGVydGllcy4gSWYgdGhlIGxhc3QgaXRlcmF0ZWQgcHJvcGVydHkgaXMgYW4gb2JqZWN0J3MKICAgICAgLy8gb3duIHByb3BlcnR5IHRoZW4gdGhlcmUgYXJlIG5vIGluaGVyaXRlZCBlbnVtZXJhYmxlIHByb3BlcnRpZXMuCiAgICAgIGZvckluKHZhbHVlLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgcmVzdWx0ID0ga2V5OwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdCA9PT0gZmFsc2UgfHwgaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgcmVzdWx0KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBBIGZhbGxiYWNrIGltcGxlbWVudGF0aW9uIG9mIGBPYmplY3Qua2V5c2AgdGhhdCBwcm9kdWNlcyBhbiBhcnJheSBvZiB0aGUKICAgKiBnaXZlbiBvYmplY3QncyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0eSBuYW1lcy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHByb3BlcnR5IG5hbWVzLgogICAqLwogIGZ1bmN0aW9uIHNoaW1LZXlzKG9iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yT3duKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICByZXN1bHQucHVzaChrZXkpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogVXNlZCB0byBjb252ZXJ0IGNoYXJhY3RlcnMgdG8gSFRNTCBlbnRpdGllczoKICAgKgogICAqIFRob3VnaCB0aGUgYD5gIGNoYXJhY3RlciBpcyBlc2NhcGVkIGZvciBzeW1tZXRyeSwgY2hhcmFjdGVycyBsaWtlIGA+YCBhbmQgYC9gCiAgICogZG9uJ3QgcmVxdWlyZSBlc2NhcGluZyBpbiBIVE1MIGFuZCBoYXZlIG5vIHNwZWNpYWwgbWVhbmluZyB1bmxlc3MgdGhleSdyZSBwYXJ0CiAgICogb2YgYSB0YWcgb3IgYW4gdW5xdW90ZWQgYXR0cmlidXRlIHZhbHVlLgogICAqIGh0dHA6Ly9tYXRoaWFzYnluZW5zLmJlL25vdGVzL2FtYmlndW91cy1hbXBlcnNhbmRzICh1bmRlciAic2VtaS1yZWxhdGVkIGZ1biBmYWN0IikKICAgKi8KICB2YXIgaHRtbEVzY2FwZXMgPSB7CiAgICAnJic6ICcmYW1wOycsCiAgICAnPCc6ICcmbHQ7JywKICAgICc+JzogJyZndDsnLAogICAgJyInOiAnJnF1b3Q7JywKICAgICInIjogJyYjeDI3OycKICB9OwoKICAvKiogVXNlZCB0byBjb252ZXJ0IEhUTUwgZW50aXRpZXMgdG8gY2hhcmFjdGVycyAqLwogIHZhciBodG1sVW5lc2NhcGVzID0gaW52ZXJ0KGh0bWxFc2NhcGVzKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIEFzc2lnbnMgb3duIGVudW1lcmFibGUgcHJvcGVydGllcyBvZiBzb3VyY2Ugb2JqZWN0KHMpIHRvIHRoZSBgZGVzdGluYXRpb25gCiAgICogb2JqZWN0LiBTdWJzZXF1ZW50IHNvdXJjZXMgd2lsbCBvdmVyd3JpdGUgcHJvcGVyeSBhc3NpZ25tZW50cyBvZiBwcmV2aW91cwogICAqIHNvdXJjZXMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgZXh0ZW5kCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICogQHBhcmFtIHtPYmplY3R9IFtzb3VyY2UxLCBzb3VyY2UyLCAuLi5dIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gSW50ZXJuYWxseSB1c2VkIHRvIGFsbG93IHRoaXMgbWV0aG9kIHRvIHdvcmsgd2l0aAogICAqICBgXy5yZWR1Y2VgIHdpdGhvdXQgdXNpbmcgaXRzIGNhbGxiYWNrJ3MgYGtleSBhbmQgYG9iamVjdGAgYXJndW1lbnRzIGFzIHNvdXJjZXMuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmFzc2lnbih7ICduYW1lJzogJ21vZScgfSwgeyAnYWdlJzogNDAgfSk7CiAgICogLy8gPT4geyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfQogICAqLwogIHZhciBhc3NpZ24gPSBjcmVhdGVJdGVyYXRvcihhc3NpZ25JdGVyYXRvck9wdGlvbnMpOwoKICAvKioKICAgKiBDcmVhdGVzIGEgY2xvbmUgb2YgYHZhbHVlYC4gSWYgYGRlZXBgIGlzIGB0cnVlYCwgbmVzdGVkIG9iamVjdHMgd2lsbCBhbHNvCiAgICogYmUgY2xvbmVkLCBvdGhlcndpc2UgdGhleSB3aWxsIGJlIGFzc2lnbmVkIGJ5IHJlZmVyZW5jZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNsb25lLgogICAqIEBwYXJhbSB7Qm9vbGVhbn0gZGVlcCBBIGZsYWcgdG8gaW5kaWNhdGUgYSBkZWVwIGNsb25lLgogICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBJbnRlcm5hbGx5IHVzZWQgdG8gYWxsb3cgdGhpcyBtZXRob2QgdG8gd29yayB3aXRoCiAgICogIG90aGVycyBsaWtlIGBfLm1hcGAgd2l0aG91dCB1c2luZyB0aGVpciBjYWxsYmFjayBgaW5kZXhgIGFyZ3VtZW50IGZvciBgZGVlcGAuCiAgICogQHBhcmFtLSB7QXJyYXl9IFtzdGFja0E9W11dIEludGVybmFsbHkgdXNlZCB0byB0cmFjayB0cmF2ZXJzZWQgc291cmNlIG9iamVjdHMuCiAgICogQHBhcmFtLSB7QXJyYXl9IFtzdGFja0I9W11dIEludGVybmFsbHkgdXNlZCB0byBhc3NvY2lhdGUgY2xvbmVzIHdpdGggdGhlaXIKICAgKiAgc291cmNlIGNvdW50ZXJwYXJ0cy4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGNsb25lZCBgdmFsdWVgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICogICB7ICduYW1lJzogJ2xhcnJ5JywgJ2FnZSc6IDUwIH0sCiAgICogICB7ICduYW1lJzogJ2N1cmx5JywgJ2FnZSc6IDYwIH0KICAgKiBdOwogICAqCiAgICogdmFyIHNoYWxsb3cgPSBfLmNsb25lKHN0b29nZXMpOwogICAqIHNoYWxsb3dbMF0gPT09IHN0b29nZXNbMF07CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogdmFyIGRlZXAgPSBfLmNsb25lKHN0b29nZXMsIHRydWUpOwogICAqIGRlZXBbMF0gPT09IHN0b29nZXNbMF07CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBjbG9uZSh2YWx1ZSwgZGVlcCwgZ3VhcmQsIHN0YWNrQSwgc3RhY2tCKSB7CiAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBpZiAoZ3VhcmQpIHsKICAgICAgZGVlcCA9IGZhbHNlOwogICAgfQogICAgLy8gaW5zcGVjdCBbW0NsYXNzXV0KICAgIHZhciBpc09iaiA9IGlzT2JqZWN0KHZhbHVlKTsKICAgIGlmIChpc09iaikgewogICAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbCh2YWx1ZSk7CiAgICAgIGlmICghY2xvbmVhYmxlQ2xhc3Nlc1tjbGFzc05hbWVdIHx8IChub05vZGVDbGFzcyAmJiBpc05vZGUodmFsdWUpKSkgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICB2YXIgaXNBcnIgPSBpc0FycmF5KHZhbHVlKTsKICAgIH0KICAgIC8vIHNoYWxsb3cgY2xvbmUKICAgIGlmICghaXNPYmogfHwgIWRlZXApIHsKICAgICAgcmV0dXJuIGlzT2JqCiAgICAgICAgPyAoaXNBcnIgPyBzbGljZSh2YWx1ZSkgOiBhc3NpZ24oe30sIHZhbHVlKSkKICAgICAgICA6IHZhbHVlOwogICAgfQogICAgdmFyIGN0b3IgPSBjdG9yQnlDbGFzc1tjbGFzc05hbWVdOwogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgICAgY2FzZSBib29sQ2xhc3M6CiAgICAgIGNhc2UgZGF0ZUNsYXNzOgogICAgICAgIHJldHVybiBuZXcgY3RvcigrdmFsdWUpOwoKICAgICAgY2FzZSBudW1iZXJDbGFzczoKICAgICAgY2FzZSBzdHJpbmdDbGFzczoKICAgICAgICByZXR1cm4gbmV3IGN0b3IodmFsdWUpOwoKICAgICAgY2FzZSByZWdleHBDbGFzczoKICAgICAgICByZXR1cm4gY3Rvcih2YWx1ZS5zb3VyY2UsIHJlRmxhZ3MuZXhlYyh2YWx1ZSkpOwogICAgfQogICAgLy8gY2hlY2sgZm9yIGNpcmN1bGFyIHJlZmVyZW5jZXMgYW5kIHJldHVybiBjb3JyZXNwb25kaW5nIGNsb25lCiAgICBzdGFja0EgfHwgKHN0YWNrQSA9IFtdKTsKICAgIHN0YWNrQiB8fCAoc3RhY2tCID0gW10pOwoKICAgIHZhciBsZW5ndGggPSBzdGFja0EubGVuZ3RoOwogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIGlmIChzdGFja0FbbGVuZ3RoXSA9PSB2YWx1ZSkgewogICAgICAgIHJldHVybiBzdGFja0JbbGVuZ3RoXTsKICAgICAgfQogICAgfQogICAgLy8gaW5pdCBjbG9uZWQgb2JqZWN0CiAgICB2YXIgcmVzdWx0ID0gaXNBcnIgPyBjdG9yKHZhbHVlLmxlbmd0aCkgOiB7fTsKCiAgICAvLyBhZGQgdGhlIHNvdXJjZSB2YWx1ZSB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMKICAgIC8vIGFuZCBhc3NvY2lhdGUgaXQgd2l0aCBpdHMgY2xvbmUKICAgIHN0YWNrQS5wdXNoKHZhbHVlKTsKICAgIHN0YWNrQi5wdXNoKHJlc3VsdCk7CgogICAgLy8gcmVjdXJzaXZlbHkgcG9wdWxhdGUgY2xvbmUgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKQogICAgKGlzQXJyID8gZm9yRWFjaCA6IGZvck93bikodmFsdWUsIGZ1bmN0aW9uKG9ialZhbHVlLCBrZXkpIHsKICAgICAgcmVzdWx0W2tleV0gPSBjbG9uZShvYmpWYWx1ZSwgZGVlcCwgbnVsbCwgc3RhY2tBLCBzdGFja0IpOwogICAgfSk7CgogICAgLy8gYWRkIGFycmF5IHByb3BlcnRpZXMgYXNzaWduZWQgYnkgYFJlZ0V4cCNleGVjYAogICAgaWYgKGlzQXJyKSB7CiAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCAnaW5kZXgnKSkgewogICAgICAgIHJlc3VsdC5pbmRleCA9IHZhbHVlLmluZGV4OwogICAgICB9CiAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCAnaW5wdXQnKSkgewogICAgICAgIHJlc3VsdC5pbnB1dCA9IHZhbHVlLmlucHV0OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIGRlZXAgY2xvbmUgb2YgYHZhbHVlYC4gRnVuY3Rpb25zIGFuZCBET00gbm9kZXMgYXJlICoqbm90KiogY2xvbmVkLgogICAqIFRoZSBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2YgYGFyZ3VtZW50c2Agb2JqZWN0cyBhbmQgb2JqZWN0cyBjcmVhdGVkIGJ5CiAgICogY29uc3RydWN0b3JzIG90aGVyIHRoYW4gYE9iamVjdGAgYXJlIGNsb25lZCB0byBwbGFpbiBgT2JqZWN0YCBvYmplY3RzLgogICAqCiAgICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyBsb29zZWx5IGJhc2VkIG9uIHRoZSBzdHJ1Y3R1cmVkIGNsb25lIGFsZ29yaXRobS4KICAgKiBTZWUgaHR0cDovL3d3dy53My5vcmcvVFIvaHRtbDUvaW5mcmFzdHJ1Y3R1cmUuaHRtbCNpbnRlcm5hbC1zdHJ1Y3R1cmVkLWNsb25pbmctYWxnb3JpdGhtLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gZGVlcCBjbG9uZS4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGRlZXAgY2xvbmVkIGB2YWx1ZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBzdG9vZ2VzID0gWwogICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfSwKICAgKiAgIHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfQogICAqIF07CiAgICoKICAgKiB2YXIgZGVlcCA9IF8uY2xvbmVEZWVwKHN0b29nZXMpOwogICAqIGRlZXBbMF0gPT09IHN0b29nZXNbMF07CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBjbG9uZURlZXAodmFsdWUpIHsKICAgIHJldHVybiBjbG9uZSh2YWx1ZSwgdHJ1ZSk7CiAgfQoKICAvKioKICAgKiBBc3NpZ25zIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2Ygc291cmNlIG9iamVjdChzKSB0byB0aGUgYGRlc3RpbmF0aW9uYAogICAqIG9iamVjdCBmb3IgYWxsIGBkZXN0aW5hdGlvbmAgcHJvcGVydGllcyB0aGF0IHJlc29sdmUgdG8gYG51bGxgL2B1bmRlZmluZWRgLgogICAqIE9uY2UgYSBwcm9wZXJ0eSBpcyBzZXQsIGFkZGl0aW9uYWwgZGVmYXVsdHMgb2YgdGhlIHNhbWUgcHJvcGVydHkgd2lsbCBiZQogICAqIGlnbm9yZWQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgKiBAcGFyYW0ge09iamVjdH0gW3NvdXJjZTEsIHNvdXJjZTIsIC4uLl0gVGhlIHNvdXJjZSBvYmplY3RzLgogICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBJbnRlcm5hbGx5IHVzZWQgdG8gYWxsb3cgdGhpcyBtZXRob2QgdG8gd29yayB3aXRoCiAgICogIGBfLnJlZHVjZWAgd2l0aG91dCB1c2luZyBpdHMgY2FsbGJhY2sncyBga2V5YCBhbmQgYG9iamVjdGAgYXJndW1lbnRzIGFzIHNvdXJjZXMuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgaWNlQ3JlYW0gPSB7ICdmbGF2b3InOiAnY2hvY29sYXRlJyB9OwogICAqIF8uZGVmYXVsdHMoaWNlQ3JlYW0sIHsgJ2ZsYXZvcic6ICd2YW5pbGxhJywgJ3Nwcmlua2xlcyc6ICdyYWluYm93JyB9KTsKICAgKiAvLyA9PiB7ICdmbGF2b3InOiAnY2hvY29sYXRlJywgJ3Nwcmlua2xlcyc6ICdyYWluYm93JyB9CiAgICovCiAgdmFyIGRlZmF1bHRzID0gY3JlYXRlSXRlcmF0b3IoYXNzaWduSXRlcmF0b3JPcHRpb25zLCB7CiAgICAnbG9vcCc6ICdpZiAocmVzdWx0W2luZGV4XSA9PSBudWxsKSAnICsgYXNzaWduSXRlcmF0b3JPcHRpb25zLmxvb3AKICB9KTsKCiAgLyoqCiAgICogQ3JlYXRlcyBhIHNvcnRlZCBhcnJheSBvZiBhbGwgZW51bWVyYWJsZSBwcm9wZXJ0aWVzLCBvd24gYW5kIGluaGVyaXRlZCwKICAgKiBvZiBgb2JqZWN0YCB0aGF0IGhhdmUgZnVuY3Rpb24gdmFsdWVzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIG1ldGhvZHMKICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcyB0aGF0IGhhdmUgZnVuY3Rpb24gdmFsdWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmZ1bmN0aW9ucyhfKTsKICAgKiAvLyA9PiBbJ2FsbCcsICdhbnknLCAnYmluZCcsICdiaW5kQWxsJywgJ2Nsb25lJywgJ2NvbXBhY3QnLCAnY29tcG9zZScsIC4uLl0KICAgKi8KICBmdW5jdGlvbiBmdW5jdGlvbnMob2JqZWN0KSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBmb3JJbihvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnNvcnQoKTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBgcHJvcGVydHlgIGV4aXN0cyBhbmQgaXMgYSBkaXJlY3QgcHJvcGVydHksCiAgICogaW5zdGVhZCBvZiBhbiBpbmhlcml0ZWQgcHJvcGVydHkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBjaGVjay4KICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgVGhlIHByb3BlcnR5IHRvIGNoZWNrIGZvci4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYga2V5IGlzIGEgZGlyZWN0IHByb3BlcnR5LCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaGFzKHsgJ2EnOiAxLCAnYic6IDIsICdjJzogMyB9LCAnYicpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBoYXMob2JqZWN0LCBwcm9wZXJ0eSkgewogICAgcmV0dXJuIG9iamVjdCA/IGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBwcm9wZXJ0eSkgOiBmYWxzZTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIHRoZSBpbnZlcnRlZCBrZXlzIGFuZCB2YWx1ZXMgb2YgdGhlIGdpdmVuIGBvYmplY3RgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW52ZXJ0LgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGNyZWF0ZWQgaW52ZXJ0ZWQgb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgXy5pbnZlcnQoeyAnZmlyc3QnOiAnTW9lJywgJ3NlY29uZCc6ICdMYXJyeScsICd0aGlyZCc6ICdDdXJseScgfSk7CiAgICogLy8gPT4geyAnTW9lJzogJ2ZpcnN0JywgJ0xhcnJ5JzogJ3NlY29uZCcsICdDdXJseSc6ICd0aGlyZCcgfSAob3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpCiAgICovCiAgZnVuY3Rpb24gaW52ZXJ0KG9iamVjdCkgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgcHJvcHMgPSBrZXlzKG9iamVjdCksCiAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoLAogICAgICAgIHJlc3VsdCA9IHt9OwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciBrZXkgPSBwcm9wc1tpbmRleF07CiAgICAgIHJlc3VsdFtvYmplY3Rba2V5XV0gPSBrZXk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBib29sZWFuIHZhbHVlLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhIGJvb2xlYW4gdmFsdWUsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc0Jvb2xlYW4obnVsbCk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gYm9vbENsYXNzOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBkYXRlLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhIGRhdGUsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc0RhdGUobmV3IERhdGUpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc0RhdGUodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIERhdGUgfHwgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gZGF0ZUNsYXNzOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBET00gZWxlbWVudC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYSBET00gZWxlbWVudCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzRWxlbWVudChkb2N1bWVudC5ib2R5KTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNFbGVtZW50KHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPyB2YWx1ZS5ub2RlVHlwZSA9PT0gMSA6IGZhbHNlOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgZW1wdHkuIEFycmF5cywgc3RyaW5ncywgb3IgYGFyZ3VtZW50c2Agb2JqZWN0cyB3aXRoIGEKICAgKiBsZW5ndGggb2YgYDBgIGFuZCBvYmplY3RzIHdpdGggbm8gb3duIGVudW1lcmFibGUgcHJvcGVydGllcyBhcmUgY29uc2lkZXJlZAogICAqICJlbXB0eSIuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gdmFsdWUgVGhlIHZhbHVlIHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBlbXB0eSwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzRW1wdHkoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc0VtcHR5KHt9KTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzRW1wdHkoJycpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc0VtcHR5KHZhbHVlKSB7CiAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgIGlmICghdmFsdWUpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKHZhbHVlKSwKICAgICAgICBsZW5ndGggPSB2YWx1ZS5sZW5ndGg7CgogICAgaWYgKChjbGFzc05hbWUgPT0gYXJyYXlDbGFzcyB8fCBjbGFzc05hbWUgPT0gc3RyaW5nQ2xhc3MgfHwKICAgICAgICBjbGFzc05hbWUgPT0gYXJnc0NsYXNzIHx8IChub0FyZ3NDbGFzcyAmJiBpc0FyZ3VtZW50cyh2YWx1ZSkpKSB8fAogICAgICAgIChjbGFzc05hbWUgPT0gb2JqZWN0Q2xhc3MgJiYgdHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyAmJiBpc0Z1bmN0aW9uKHZhbHVlLnNwbGljZSkpKSB7CiAgICAgIHJldHVybiAhbGVuZ3RoOwogICAgfQogICAgZm9yT3duKHZhbHVlLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIChyZXN1bHQgPSBmYWxzZSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBQZXJmb3JtcyBhIGRlZXAgY29tcGFyaXNvbiBiZXR3ZWVuIHR3byB2YWx1ZXMgdG8gZGV0ZXJtaW5lIGlmIHRoZXkgYXJlCiAgICogZXF1aXZhbGVudCB0byBlYWNoIG90aGVyLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSBhIFRoZSB2YWx1ZSB0byBjb21wYXJlLgogICAqIEBwYXJhbSB7TWl4ZWR9IGIgVGhlIG90aGVyIHZhbHVlIHRvIGNvbXBhcmUuCiAgICogQHBhcmFtLSB7T2JqZWN0fSBbc3RhY2tBPVtdXSBJbnRlcm5hbGx5IHVzZWQgdHJhY2sgdHJhdmVyc2VkIGBhYCBvYmplY3RzLgogICAqIEBwYXJhbS0ge09iamVjdH0gW3N0YWNrQj1bXV0gSW50ZXJuYWxseSB1c2VkIHRyYWNrIHRyYXZlcnNlZCBgYmAgb2JqZWN0cy4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSB2YWx1ZXMgYXJlIGVxdXZhbGVudCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbW9lID0geyAnbmFtZSc6ICdtb2UnLCAnbHVja3lOdW1iZXJzJzogWzEzLCAyNywgMzRdIH07CiAgICogdmFyIGNsb25lID0geyAnbmFtZSc6ICdtb2UnLCAnbHVja3lOdW1iZXJzJzogWzEzLCAyNywgMzRdIH07CiAgICoKICAgKiBtb2UgPT0gY2xvbmU7CiAgICogLy8gPT4gZmFsc2UKICAgKgogICAqIF8uaXNFcXVhbChtb2UsIGNsb25lKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNFcXVhbChhLCBiLCBzdGFja0EsIHN0YWNrQikgewogICAgLy8gZXhpdCBlYXJseSBmb3IgaWRlbnRpY2FsIHZhbHVlcwogICAgaWYgKGEgPT09IGIpIHsKICAgICAgLy8gdHJlYXQgYCswYCB2cy4gYC0wYCBhcyBub3QgZXF1YWwKICAgICAgcmV0dXJuIGEgIT09IDAgfHwgKDEgLyBhID09IDEgLyBiKTsKICAgIH0KICAgIC8vIGV4aXQgZWFybHkgZm9yIHVubGlrZSBgbnVsbGAgb3IgYHVuZGVmaW5lZGAgdmFsdWVzCiAgICBpZiAoYSA9PSBudWxsIHx8IGIgPT0gbnVsbCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvLyBjb21wYXJlIFtbQ2xhc3NdXSBuYW1lcwogICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSksCiAgICAgICAgb3RoZXJOYW1lID0gdG9TdHJpbmcuY2FsbChiKTsKCiAgICBpZiAoY2xhc3NOYW1lID09IGFyZ3NDbGFzcykgewogICAgICBjbGFzc05hbWUgPSBvYmplY3RDbGFzczsKICAgIH0KICAgIGlmIChvdGhlck5hbWUgPT0gYXJnc0NsYXNzKSB7CiAgICAgIG90aGVyTmFtZSA9IG9iamVjdENsYXNzOwogICAgfQogICAgaWYgKGNsYXNzTmFtZSAhPSBvdGhlck5hbWUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgICAgY2FzZSBib29sQ2xhc3M6CiAgICAgIGNhc2UgZGF0ZUNsYXNzOgogICAgICAgIC8vIGNvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtYmVycywgZGF0ZXMgdG8gbWlsbGlzZWNvbmRzIGFuZCBib29sZWFucwogICAgICAgIC8vIHRvIGAxYCBvciBgMGAsIHRyZWF0aW5nIGludmFsaWQgZGF0ZXMgY29lcmNlZCB0byBgTmFOYCBhcyBub3QgZXF1YWwKICAgICAgICByZXR1cm4gK2EgPT0gK2I7CgogICAgICBjYXNlIG51bWJlckNsYXNzOgogICAgICAgIC8vIHRyZWF0IGBOYU5gIHZzLiBgTmFOYCBhcyBlcXVhbAogICAgICAgIHJldHVybiBhICE9ICthCiAgICAgICAgICA/IGIgIT0gK2IKICAgICAgICAgIC8vIGJ1dCB0cmVhdCBgKzBgIHZzLiBgLTBgIGFzIG5vdCBlcXVhbAogICAgICAgICAgOiAoYSA9PSAwID8gKDEgLyBhID09IDEgLyBiKSA6IGEgPT0gK2IpOwoKICAgICAgY2FzZSByZWdleHBDbGFzczoKICAgICAgY2FzZSBzdHJpbmdDbGFzczoKICAgICAgICAvLyBjb2VyY2UgcmVnZXhlcyB0byBzdHJpbmdzIChodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxNS4xMC42LjQpCiAgICAgICAgLy8gdHJlYXQgc3RyaW5nIHByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IGluc3RhbmNlcyBhcyBlcXVhbAogICAgICAgIHJldHVybiBhID09IGIgKyAnJzsKICAgIH0KICAgIHZhciBpc0FyciA9IGNsYXNzTmFtZSA9PSBhcnJheUNsYXNzOwogICAgaWYgKCFpc0FycikgewogICAgICAvLyB1bndyYXAgYW55IGBsb2Rhc2hgIHdyYXBwZWQgdmFsdWVzCiAgICAgIGlmIChhLl9fd3JhcHBlZF9fIHx8IGIuX193cmFwcGVkX18pIHsKICAgICAgICByZXR1cm4gaXNFcXVhbChhLl9fd3JhcHBlZF9fIHx8IGEsIGIuX193cmFwcGVkX18gfHwgYik7CiAgICAgIH0KICAgICAgLy8gZXhpdCBmb3IgZnVuY3Rpb25zIGFuZCBET00gbm9kZXMKICAgICAgaWYgKGNsYXNzTmFtZSAhPSBvYmplY3RDbGFzcyB8fCAobm9Ob2RlQ2xhc3MgJiYgKGlzTm9kZShhKSB8fCBpc05vZGUoYikpKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBpbiBvbGRlciB2ZXJzaW9ucyBvZiBPcGVyYSwgYGFyZ3VtZW50c2Agb2JqZWN0cyBoYXZlIGBBcnJheWAgY29uc3RydWN0b3JzCiAgICAgIHZhciBjdG9yQSA9ICFhcmdzQXJlT2JqZWN0cyAmJiBpc0FyZ3VtZW50cyhhKSA/IE9iamVjdCA6IGEuY29uc3RydWN0b3IsCiAgICAgICAgICBjdG9yQiA9ICFhcmdzQXJlT2JqZWN0cyAmJiBpc0FyZ3VtZW50cyhiKSA/IE9iamVjdCA6IGIuY29uc3RydWN0b3I7CgogICAgICAvLyBub24gYE9iamVjdGAgb2JqZWN0IGluc3RhbmNlcyB3aXRoIGRpZmZlcmVudCBjb25zdHJ1Y3RvcnMgYXJlIG5vdCBlcXVhbAogICAgICBpZiAoY3RvckEgIT0gY3RvckIgJiYgISgKICAgICAgICAgICAgaXNGdW5jdGlvbihjdG9yQSkgJiYgY3RvckEgaW5zdGFuY2VvZiBjdG9yQSAmJgogICAgICAgICAgICBpc0Z1bmN0aW9uKGN0b3JCKSAmJiBjdG9yQiBpbnN0YW5jZW9mIGN0b3JCCiAgICAgICAgICApKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICAvLyBhc3N1bWUgY3ljbGljIHN0cnVjdHVyZXMgYXJlIGVxdWFsCiAgICAvLyB0aGUgYWxnb3JpdGhtIGZvciBkZXRlY3RpbmcgY3ljbGljIHN0cnVjdHVyZXMgaXMgYWRhcHRlZCBmcm9tIEVTIDUuMQogICAgLy8gc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYCAoaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuMTIuMykKICAgIHN0YWNrQSB8fCAoc3RhY2tBID0gW10pOwogICAgc3RhY2tCIHx8IChzdGFja0IgPSBbXSk7CgogICAgdmFyIGxlbmd0aCA9IHN0YWNrQS5sZW5ndGg7CiAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgaWYgKHN0YWNrQVtsZW5ndGhdID09IGEpIHsKICAgICAgICByZXR1cm4gc3RhY2tCW2xlbmd0aF0gPT0gYjsKICAgICAgfQogICAgfQogICAgdmFyIHJlc3VsdCA9IHRydWUsCiAgICAgICAgc2l6ZSA9IDA7CgogICAgLy8gYWRkIGBhYCBhbmQgYGJgIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgc3RhY2tBLnB1c2goYSk7CiAgICBzdGFja0IucHVzaChiKTsKCiAgICAvLyByZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cyAoc3VzY2VwdGlibGUgdG8gY2FsbCBzdGFjayBsaW1pdHMpCiAgICBpZiAoaXNBcnIpIHsKICAgICAgLy8gY29tcGFyZSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkKICAgICAgc2l6ZSA9IGEubGVuZ3RoOwogICAgICByZXN1bHQgPSBzaXplID09IGIubGVuZ3RoOwoKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIC8vIGRlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMKICAgICAgICB3aGlsZSAoc2l6ZS0tKSB7CiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBpc0VxdWFsKGFbc2l6ZV0sIGJbc2l6ZV0sIHN0YWNrQSwgc3RhY2tCKSkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvLyBkZWVwIGNvbXBhcmUgb2JqZWN0cyB1c2luZyBgZm9ySW5gLCBpbnN0ZWFkIG9mIGBmb3JPd25gLCB0byBhdm9pZCBgT2JqZWN0LmtleXNgCiAgICAvLyB3aGljaCwgaW4gdGhpcyBjYXNlLCBpcyBtb3JlIGNvc3RseQogICAgZm9ySW4oYSwgZnVuY3Rpb24odmFsdWUsIGtleSwgYSkgewogICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChhLCBrZXkpKSB7CiAgICAgICAgLy8gY291bnQgdGhlIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICAgIHNpemUrKzsKICAgICAgICAvLyBkZWVwIGNvbXBhcmUgZWFjaCBwcm9wZXJ0eSB2YWx1ZS4KICAgICAgICByZXR1cm4gKHJlc3VsdCA9IGhhc093blByb3BlcnR5LmNhbGwoYiwga2V5KSAmJiBpc0VxdWFsKHZhbHVlLCBiW2tleV0sIHN0YWNrQSwgc3RhY2tCKSk7CiAgICAgIH0KICAgIH0pOwoKICAgIGlmIChyZXN1bHQpIHsKICAgICAgLy8gZW5zdXJlIGJvdGggb2JqZWN0cyBoYXZlIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzCiAgICAgIGZvckluKGIsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGIpIHsKICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChiLCBrZXkpKSB7CiAgICAgICAgICAvLyBgc2l6ZWAgd2lsbCBiZSBgLTFgIGlmIGBiYCBoYXMgbW9yZSBwcm9wZXJ0aWVzIHRoYW4gYGFgCiAgICAgICAgICByZXR1cm4gKHJlc3VsdCA9IC0tc2l6ZSA+IC0xKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzLCBvciBjYW4gYmUgY29lcmNlZCB0bywgYSBmaW5pdGUgbnVtYmVyLgogICAqCiAgICogTm90ZTogVGhpcyBpcyBub3QgdGhlIHNhbWUgYXMgbmF0aXZlIGBpc0Zpbml0ZWAsIHdoaWNoIHdpbGwgcmV0dXJuIHRydWUgZm9yCiAgICogYm9vbGVhbnMgYW5kIGVtcHR5IHN0cmluZ3MuIFNlZSBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxNS4xLjIuNS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgZmluaXRlLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNGaW5pdGUoLTEwMSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc0Zpbml0ZSgnMTAnKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzRmluaXRlKHRydWUpOwogICAqIC8vID0+IGZhbHNlCiAgICoKICAgKiBfLmlzRmluaXRlKCcnKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc0Zpbml0ZShJbmZpbml0eSk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc0Zpbml0ZSh2YWx1ZSkgewogICAgcmV0dXJuIG5hdGl2ZUlzRmluaXRlKHZhbHVlKSAmJiAhbmF0aXZlSXNOYU4ocGFyc2VGbG9hdCh2YWx1ZSkpOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBmdW5jdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYSBmdW5jdGlvbiwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzRnVuY3Rpb24oXyk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ2Z1bmN0aW9uJzsKICB9CiAgLy8gZmFsbGJhY2sgZm9yIG9sZGVyIHZlcnNpb25zIG9mIENocm9tZSBhbmQgU2FmYXJpCiAgaWYgKGlzRnVuY3Rpb24oL3gvKSkgewogICAgaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIEZ1bmN0aW9uIHx8IHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGZ1bmNDbGFzczsKICAgIH07CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyB0aGUgbGFuZ3VhZ2UgdHlwZSBvZiBPYmplY3QuCiAgICogKGUuZy4gYXJyYXlzLCBmdW5jdGlvbnMsIG9iamVjdHMsIHJlZ2V4ZXMsIGBuZXcgTnVtYmVyKDApYCwgYW5kIGBuZXcgU3RyaW5nKCcnKWApCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGFuIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzT2JqZWN0KHt9KTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzT2JqZWN0KFsxLCAyLCAzXSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc09iamVjdCgxKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7CiAgICAvLyBjaGVjayBpZiB0aGUgdmFsdWUgaXMgdGhlIEVDTUFTY3JpcHQgbGFuZ3VhZ2UgdHlwZSBvZiBPYmplY3QKICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmNvbS8jeDgKICAgIC8vIGFuZCBhdm9pZCBhIFY4IGJ1ZwogICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL3Y4L2lzc3Vlcy9kZXRhaWw/aWQ9MjI5MQogICAgcmV0dXJuIHZhbHVlID8gb2JqZWN0VHlwZXNbdHlwZW9mIHZhbHVlXSA6IGZhbHNlOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYE5hTmAuCiAgICoKICAgKiBOb3RlOiBUaGlzIGlzIG5vdCB0aGUgc2FtZSBhcyBuYXRpdmUgYGlzTmFOYCwgd2hpY2ggd2lsbCByZXR1cm4gYHRydWVgIGZvcgogICAqIGB1bmRlZmluZWRgIGFuZCBvdGhlciB2YWx1ZXMuIFNlZSBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxNS4xLjIuNC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYE5hTmAsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc05hTihOYU4pOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNOYU4obmV3IE51bWJlcihOYU4pKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBpc05hTih1bmRlZmluZWQpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNOYU4odW5kZWZpbmVkKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGlzTmFOKHZhbHVlKSB7CiAgICAvLyBgTmFOYCBhcyBhIHByaW1pdGl2ZSBpcyB0aGUgb25seSB2YWx1ZSB0aGF0IGlzIG5vdCBlcXVhbCB0byBpdHNlbGYKICAgIC8vIChwZXJmb3JtIHRoZSBbW0NsYXNzXV0gY2hlY2sgZmlyc3QgdG8gYXZvaWQgZXJyb3JzIHdpdGggc29tZSBob3N0IG9iamVjdHMgaW4gSUUpCiAgICByZXR1cm4gaXNOdW1iZXIodmFsdWUpICYmIHZhbHVlICE9ICt2YWx1ZQogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYG51bGxgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBgbnVsbGAsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc051bGwobnVsbCk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc051bGwodW5kZWZpbmVkKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGlzTnVsbCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09PSBudWxsOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBudW1iZXIuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGEgbnVtYmVyLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNOdW1iZXIoOC40ICogNSk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzTnVtYmVyKHZhbHVlKSB7CiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInIHx8IHRvU3RyaW5nLmNhbGwodmFsdWUpID09IG51bWJlckNsYXNzOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGEgZ2l2ZW4gYHZhbHVlYCBpcyBhbiBvYmplY3QgY3JlYXRlZCBieSB0aGUgYE9iamVjdGAgY29uc3RydWN0b3IuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIGB2YWx1ZWAgaXMgYSBwbGFpbiBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogZnVuY3Rpb24gU3Rvb2dlKG5hbWUsIGFnZSkgewogICAqICAgdGhpcy5uYW1lID0gbmFtZTsKICAgKiAgIHRoaXMuYWdlID0gYWdlOwogICAqIH0KICAgKgogICAqIF8uaXNQbGFpbk9iamVjdChuZXcgU3Rvb2dlKCdtb2UnLCA0MCkpOwogICAqIC8vID0+IGZhbHNlCiAgICoKICAgKiBfLmlzUGxhaW5PYmplY3QoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc1BsYWluT2JqZWN0KHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0pOwogICAqIC8vID0+IHRydWUKICAgKi8KICB2YXIgaXNQbGFpbk9iamVjdCA9ICFnZXRQcm90b3R5cGVPZiA/IHNoaW1Jc1BsYWluT2JqZWN0IDogZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmICghKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JykpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdmFyIHZhbHVlT2YgPSB2YWx1ZS52YWx1ZU9mLAogICAgICAgIG9ialByb3RvID0gdHlwZW9mIHZhbHVlT2YgPT0gJ2Z1bmN0aW9uJyAmJiAob2JqUHJvdG8gPSBnZXRQcm90b3R5cGVPZih2YWx1ZU9mKSkgJiYgZ2V0UHJvdG90eXBlT2Yob2JqUHJvdG8pOwoKICAgIHJldHVybiBvYmpQcm90bwogICAgICA/IHZhbHVlID09IG9ialByb3RvIHx8IChnZXRQcm90b3R5cGVPZih2YWx1ZSkgPT0gb2JqUHJvdG8gJiYgIWlzQXJndW1lbnRzKHZhbHVlKSkKICAgICAgOiBzaGltSXNQbGFpbk9iamVjdCh2YWx1ZSk7CiAgfTsKCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSByZWd1bGFyIGV4cHJlc3Npb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGEgcmVndWxhciBleHByZXNzaW9uLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNSZWdFeHAoL21vZS8pOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc1JlZ0V4cCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUmVnRXhwIHx8IHRvU3RyaW5nLmNhbGwodmFsdWUpID09IHJlZ2V4cENsYXNzOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBzdHJpbmcuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGEgc3RyaW5nLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNTdHJpbmcoJ21vZScpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJyB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBzdHJpbmdDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGB1bmRlZmluZWRgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBgdW5kZWZpbmVkYCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzVW5kZWZpbmVkKHZvaWQgMCk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzVW5kZWZpbmVkKHZhbHVlKSB7CiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICd1bmRlZmluZWQnOwogIH0KCiAgLyoqCiAgICogUmVjdXJzaXZlbHkgbWVyZ2VzIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2YgdGhlIHNvdXJjZSBvYmplY3QocyksIHRoYXQKICAgKiBkb24ndCByZXNvbHZlIHRvIGB1bmRlZmluZWRgLCBpbnRvIHRoZSBgZGVzdGluYXRpb25gIG9iamVjdC4gU3Vic2VxdWVudCBzb3VyY2VzCiAgICogd2lsbCBvdmVyd3JpdGUgcHJvcGVyeSBhc3NpZ25tZW50cyBvZiBwcmV2aW91cyBzb3VyY2VzLiBJZiBhIGBjYWxsYmFja2AgZnVuY3Rpb24KICAgKiBpcyBwYXNzZWQsIGl0IHdpbGwgYmUgZXhlY3V0ZWQgdG8gcHJvZHVjZSB0aGUgbWVyZ2VkIHZhbHVlcyBvZiB0aGUgZGVzdGluYXRpb24KICAgKiBhbmQgc291cmNlIG9iamVjdCBwcm9wZXJ0aWVzLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgKiB3aXRoIHR3byBhcmd1bWVudHM7IChvYmplY3RWYWx1ZSwgc291cmNlVmFsdWUpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICogQHBhcmFtIHtPYmplY3R9IFtzb3VyY2UxLCBzb3VyY2UyLCAuLi5dIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiBjYWxsZWQgZm9yIGVhY2ggcHJvcGVydHkgdG8gbWVyZ2UuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEBwYXJhbS0ge09iamVjdH0gW2luZGljYXRvcl0gSW50ZXJuYWxseSB1c2VkIHRvIGluZGljYXRlIHRoYXQgdGhlIGBzdGFja2AKICAgKiAgYXJndW1lbnQgaXMgYW4gYXJyYXkgb2YgdHJhdmVyc2VkIG9iamVjdHMgaW5zdGVhZCBvZiBhbm90aGVyIHNvdXJjZSBvYmplY3QuCiAgICogQHBhcmFtLSB7QXJyYXl9IFtzdGFja0E9W11dIEludGVybmFsbHkgdXNlZCB0byB0cmFjayB0cmF2ZXJzZWQgc291cmNlIG9iamVjdHMuCiAgICogQHBhcmFtLSB7QXJyYXl9IFtzdGFja0I9W11dIEludGVybmFsbHkgdXNlZCB0byBhc3NvY2lhdGUgdmFsdWVzIHdpdGggdGhlaXIKICAgKiAgc291cmNlIGNvdW50ZXJwYXJ0cy4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBuYW1lcyA9IHsKICAgKiAgICdzdG9vZ2VzJzogWwogICAqICAgICB7ICduYW1lJzogJ21vZScgfSwKICAgKiAgICAgeyAnbmFtZSc6ICdsYXJyeScgfQogICAqICAgXQogICAqIH07CiAgICoKICAgKiB2YXIgYWdlcyA9IHsKICAgKiAgICdzdG9vZ2VzJzogWwogICAqICAgICB7ICdhZ2UnOiA0MCB9LAogICAqICAgICB7ICdhZ2UnOiA1MCB9CiAgICogICBdCiAgICogfTsKICAgKgogICAqIF8ubWVyZ2UobmFtZXMsIGFnZXMpOwogICAqIC8vID0+IHsgJ3N0b29nZXMnOiBbeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9XSB9CiAgICovCiAgZnVuY3Rpb24gbWVyZ2Uob2JqZWN0LCBzb3VyY2UsIGluZGljYXRvcikgewogICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgaW5kZXggPSAwLAogICAgICAgIGxlbmd0aCA9IDI7CgogICAgaWYgKCFvYmplY3QpIHsKICAgICAgcmV0dXJuIG9iamVjdDsKICAgIH0KICAgIGlmIChpbmRpY2F0b3IgPT09IGluZGljYXRvck9iamVjdCkgewogICAgICB2YXIgY2FsbGJhY2sgPSBhcmdzWzNdLAogICAgICAgICAgc3RhY2tBID0gYXJnc1s0XSwKICAgICAgICAgIHN0YWNrQiA9IGFyZ3NbNV07CiAgICB9CiAgICBlbHNlIHsKICAgICAgc3RhY2tBID0gW107CiAgICAgIHN0YWNrQiA9IFtdOwogICAgICBpZiAodHlwZW9mIGluZGljYXRvciAhPSAnbnVtYmVyJykgewogICAgICAgIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOwogICAgICAgIGNhbGxiYWNrID0gdHlwZW9mIChjYWxsYmFjayA9IGFyZ3NbbGVuZ3RoIC0gMl0pID09ICdmdW5jdGlvbicKICAgICAgICAgID8gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGFyZ3NbLS1sZW5ndGhdKQogICAgICAgICAgOiAodHlwZW9mIChjYWxsYmFjayA9IGFyZ3NbbGVuZ3RoIC0gMV0pID09ICdmdW5jdGlvbicgJiYgY2FsbGJhY2spOwogICAgICB9CiAgICB9CiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIgaXNBcnIgPSBpc0FycmF5KGFyZ3NbaW5kZXhdKTsKICAgICAgKGlzQXJyID8gZm9yRWFjaCA6IGZvck93bikoYXJnc1tpbmRleF0sIGZ1bmN0aW9uKHNvdXJjZSwga2V5KSB7CiAgICAgICAgdmFyIGZvdW5kLAogICAgICAgICAgICBpc09iaiwKICAgICAgICAgICAgdmFsdWUgPSBvYmplY3Rba2V5XTsKCiAgICAgICAgaWYgKHNvdXJjZSAmJiAoKGlzT2JqID0gaXNQbGFpbk9iamVjdChzb3VyY2UpKSB8fCBpc0FycmF5KHNvdXJjZSkpKSB7CiAgICAgICAgICAvLyBhdm9pZCBtZXJnaW5nIHByZXZpb3VzbHkgbWVyZ2VkIGN5Y2xpYyBzb3VyY2VzCiAgICAgICAgICB2YXIgc3RhY2tMZW5ndGggPSBzdGFja0EubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKHN0YWNrTGVuZ3RoLS0pIHsKICAgICAgICAgICAgaWYgKChmb3VuZCA9IHN0YWNrQVtzdGFja0xlbmd0aF0gPT0gc291cmNlKSkgewogICAgICAgICAgICAgIHZhbHVlID0gc3RhY2tCW3N0YWNrTGVuZ3RoXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFmb3VuZCkgewogICAgICAgICAgICB2YWx1ZSA9IGlzT2JqCiAgICAgICAgICAgICAgPyAoaXNQbGFpbk9iamVjdCh2YWx1ZSkgPyB2YWx1ZSA6IHt9KQogICAgICAgICAgICAgIDogKGlzQXJyYXkodmFsdWUpID8gdmFsdWUgOiBbXSk7CgogICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKHZhbHVlLCBzb3VyY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGFkZCBgc291cmNlYCBhbmQgYXNzb2NpYXRlZCBgdmFsdWVgIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgICAgICAgICBzdGFja0EucHVzaChzb3VyY2UpOwogICAgICAgICAgICBzdGFja0IucHVzaCh2YWx1ZSk7CgogICAgICAgICAgICAvLyByZWN1cnNpdmVseSBtZXJnZSBvYmplY3RzIGFuZCBhcnJheXMgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKQogICAgICAgICAgICB2YWx1ZSA9IHZhbHVlICYmIG1lcmdlKHZhbHVlLCBzb3VyY2UsIGluZGljYXRvck9iamVjdCwgY2FsbGJhY2ssIHN0YWNrQSwgc3RhY2tCKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgIHZhbHVlID0gY2FsbGJhY2sodmFsdWUsIHNvdXJjZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGlzQXJyIHx8IHR5cGVvZiBzb3VyY2UgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHZhbHVlID0gc291cmNlOwogICAgICAgIH0KICAgICAgICBvYmplY3Rba2V5XSA9IHZhbHVlOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBvYmplY3Q7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgc2hhbGxvdyBjbG9uZSBvZiBgb2JqZWN0YCBleGNsdWRpbmcgdGhlIHNwZWNpZmllZCBwcm9wZXJ0aWVzLgogICAqIFByb3BlcnR5IG5hbWVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzIG9mCiAgICogcHJvcGVydHkgbmFtZXMuIElmIGBjYWxsYmFja2AgaXMgcGFzc2VkLCBpdCB3aWxsIGJlIGV4ZWN1dGVkIGZvciBlYWNoIHByb3BlcnR5CiAgICogaW4gdGhlIGBvYmplY3RgLCBvbWl0dGluZyB0aGUgcHJvcGVydGllcyBgY2FsbGJhY2tgIHJldHVybnMgdHJ1dGh5IGZvci4gVGhlCiAgICogYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwga2V5LCBvYmplY3QpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBzb3VyY2Ugb2JqZWN0LgogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBjYWxsYmFja3xbcHJvcDEsIHByb3AyLCAuLi5dIFRoZSBwcm9wZXJ0aWVzIHRvIG9taXQKICAgKiAgb3IgdGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCB3aXRob3V0IHRoZSBvbWl0dGVkIHByb3BlcnRpZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ub21pdCh7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCwgJ3VzZXJpZCc6ICdtb2UxJyB9LCAndXNlcmlkJyk7CiAgICogLy8gPT4geyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfQogICAqCiAgICogXy5vbWl0KHsgJ25hbWUnOiAnbW9lJywgJ19oaW50JzogJ2tudWNrbGVoZWFkJywgJ19zZWVkJzogJzk2YzRlYicgfSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAqICAgcmV0dXJuIGtleS5jaGFyQXQoMCkgPT0gJ18nOwogICAqIH0pOwogICAqIC8vID0+IHsgJ25hbWUnOiAnbW9lJyB9CiAgICovCiAgZnVuY3Rpb24gb21pdChvYmplY3QsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgaXNGdW5jID0gdHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicsCiAgICAgICAgcmVzdWx0ID0ge307CgogICAgaWYgKGlzRnVuYykgewogICAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBwcm9wcyA9IGNvbmNhdC5hcHBseShhcnJheVJlZiwgYXJndW1lbnRzKTsKICAgIH0KICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSwgb2JqZWN0KSB7CiAgICAgIGlmIChpc0Z1bmMKICAgICAgICAgICAgPyAhY2FsbGJhY2sodmFsdWUsIGtleSwgb2JqZWN0KQogICAgICAgICAgICA6IGluZGV4T2YocHJvcHMsIGtleSwgMSkgPCAwCiAgICAgICAgICApIHsKICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgdHdvIGRpbWVuc2lvbmFsIGFycmF5IG9mIHRoZSBnaXZlbiBvYmplY3QncyBrZXktdmFsdWUgcGFpcnMsCiAgICogaS5lLiBgW1trZXkxLCB2YWx1ZTFdLCBba2V5MiwgdmFsdWUyXV1gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgbmV3IGFycmF5IG9mIGtleS12YWx1ZSBwYWlycy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5wYWlycyh7ICdtb2UnOiAzMCwgJ2xhcnJ5JzogNDAsICdjdXJseSc6IDUwIH0pOwogICAqIC8vID0+IFtbJ21vZScsIDMwXSwgWydsYXJyeScsIDQwXSwgWydjdXJseScsIDUwXV0gKG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAqLwogIGZ1bmN0aW9uIHBhaXJzKG9iamVjdCkgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgcHJvcHMgPSBrZXlzKG9iamVjdCksCiAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIGtleSA9IHByb3BzW2luZGV4XTsKICAgICAgcmVzdWx0W2luZGV4XSA9IFtrZXksIG9iamVjdFtrZXldXTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgc2hhbGxvdyBjbG9uZSBvZiBgb2JqZWN0YCBjb21wb3NlZCBvZiB0aGUgc3BlY2lmaWVkIHByb3BlcnRpZXMuCiAgICogUHJvcGVydHkgbmFtZXMgbWF5IGJlIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIGFyZ3VtZW50cyBvciBhcyBhcnJheXMgb2YgcHJvcGVydHkKICAgKiBuYW1lcy4gSWYgYGNhbGxiYWNrYCBpcyBwYXNzZWQsIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yIGVhY2ggcHJvcGVydHkgaW4gdGhlCiAgICogYG9iamVjdGAsIHBpY2tpbmcgdGhlIHByb3BlcnRpZXMgYGNhbGxiYWNrYCByZXR1cm5zIHRydXRoeSBmb3IuIFRoZSBgY2FsbGJhY2tgCiAgICogaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGtleSwgb2JqZWN0KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgc291cmNlIG9iamVjdC4KICAgKiBAcGFyYW0ge0FycmF5fEZ1bmN0aW9ufFN0cmluZ30gY2FsbGJhY2t8W3Byb3AxLCBwcm9wMiwgLi4uXSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICogIHBlciBpdGVyYXRpb24gb3IgcHJvcGVydGllcyB0byBwaWNrLCBlaXRoZXIgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXJyYXlzLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgcGlja2VkIHByb3BlcnRpZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ucGljayh7ICduYW1lJzogJ21vZScsICdfdXNlcmlkJzogJ21vZTEnIH0sICduYW1lJyk7CiAgICogLy8gPT4geyAnbmFtZSc6ICdtb2UnIH0KICAgKgogICAqIF8ucGljayh7ICduYW1lJzogJ21vZScsICdfdXNlcmlkJzogJ21vZTEnIH0sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgKiAgIHJldHVybiBrZXkuY2hhckF0KDApICE9ICdfJzsKICAgKiB9KTsKICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScgfQogICAqLwogIGZ1bmN0aW9uIHBpY2sob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAnZnVuY3Rpb24nKSB7CiAgICAgIHZhciBpbmRleCA9IDAsCiAgICAgICAgICBwcm9wcyA9IGNvbmNhdC5hcHBseShhcnJheVJlZiwgYXJndW1lbnRzKSwKICAgICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGtleSA9IHByb3BzW2luZGV4XTsKICAgICAgICBpZiAoa2V5IGluIG9iamVjdCkgewogICAgICAgICAgcmVzdWx0W2tleV0gPSBvYmplY3Rba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgICBmb3JJbihvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIG9iamVjdCkgewogICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwga2V5LCBvYmplY3QpKSB7CiAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBhcnJheSBjb21wb3NlZCBvZiB0aGUgb3duIGVudW1lcmFibGUgcHJvcGVydHkgdmFsdWVzIG9mIGBvYmplY3RgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgdmFsdWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnZhbHVlcyh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKi8KICBmdW5jdGlvbiB2YWx1ZXMob2JqZWN0KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBwcm9wcyA9IGtleXMob2JqZWN0KSwKICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGgsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICByZXN1bHRbaW5kZXhdID0gb2JqZWN0W3Byb3BzW2luZGV4XV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgZWxlbWVudHMgZnJvbSB0aGUgc3BlY2lmaWVkIGluZGV4KGVzKSwgb3Iga2V5cywgb2YgdGhlCiAgICogYGNvbGxlY3Rpb25gLiBJbmRleGVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzCiAgICogb2YgaW5kZXhlcy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtBcnJheXxOdW1iZXJ8U3RyaW5nfSBbaW5kZXgxLCBpbmRleDIsIC4uLl0gVGhlIGluZGV4KGVzKSBvZgogICAqICBgY29sbGVjdGlvbmAgdG8gcmV0cmlldmUsIGVpdGhlciBhcyBpbmRpdmlkdWFsIGFyZ3VtZW50cyBvciBhcnJheXMuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIGNvcnJlc3BvbmRpbmcgdG8gdGhlCiAgICogIHByb3ZpZGVkIGluZGV4ZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uYXQoWydhJywgJ2InLCAnYycsICdkJywgJ2UnXSwgWzAsIDIsIDRdKTsKICAgKiAvLyA9PiBbJ2EnLCAnYycsICdlJ10KICAgKgogICAqIF8uYXQoWydtb2UnLCAnbGFycnknLCAnY3VybHknXSwgMCwgMik7CiAgICogLy8gPT4gWydtb2UnLCAnY3VybHknXQogICAqLwogIGZ1bmN0aW9uIGF0KGNvbGxlY3Rpb24pIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIHByb3BzID0gY29uY2F0LmFwcGx5KGFycmF5UmVmLCBzbGljZShhcmd1bWVudHMsIDEpKSwKICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGgsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICBpZiAobm9DaGFyQnlJbmRleCAmJiBpc1N0cmluZyhjb2xsZWN0aW9uKSkgewogICAgICBjb2xsZWN0aW9uID0gY29sbGVjdGlvbi5zcGxpdCgnJyk7CiAgICB9CiAgICB3aGlsZSgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHJlc3VsdFtpbmRleF0gPSBjb2xsZWN0aW9uW3Byb3BzW2luZGV4XV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGEgZ2l2ZW4gYHRhcmdldGAgZWxlbWVudCBpcyBwcmVzZW50IGluIGEgYGNvbGxlY3Rpb25gIHVzaW5nIHN0cmljdAogICAqIGVxdWFsaXR5IGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4gSWYgYGZyb21JbmRleGAgaXMgbmVnYXRpdmUsIGl0IGlzIHVzZWQKICAgKiBhcyB0aGUgb2Zmc2V0IGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBpbmNsdWRlCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge01peGVkfSB0YXJnZXQgVGhlIHZhbHVlIHRvIGNoZWNrIGZvci4KICAgKiBAcGFyYW0ge051bWJlcn0gW2Zyb21JbmRleD0wXSBUaGUgaW5kZXggdG8gc2VhcmNoIGZyb20uCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdGFyZ2V0YCBlbGVtZW50IGlzIGZvdW5kLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uY29udGFpbnMoWzEsIDIsIDNdLCAxKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmNvbnRhaW5zKFsxLCAyLCAzXSwgMSwgMik7CiAgICogLy8gPT4gZmFsc2UKICAgKgogICAqIF8uY29udGFpbnMoeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwgJ21vZScpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uY29udGFpbnMoJ2N1cmx5JywgJ3VyJyk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGNvbnRhaW5zKGNvbGxlY3Rpb24sIHRhcmdldCwgZnJvbUluZGV4KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgIHJlc3VsdCA9IGZhbHNlOwoKICAgIGZyb21JbmRleCA9IChmcm9tSW5kZXggPCAwID8gbmF0aXZlTWF4KDAsIGxlbmd0aCArIGZyb21JbmRleCkgOiBmcm9tSW5kZXgpIHx8IDA7CiAgICBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICByZXN1bHQgPSAoaXNTdHJpbmcoY29sbGVjdGlvbikKICAgICAgICA/IGNvbGxlY3Rpb24uaW5kZXhPZih0YXJnZXQsIGZyb21JbmRleCkKICAgICAgICA6IGluZGV4T2YoY29sbGVjdGlvbiwgdGFyZ2V0LCBmcm9tSW5kZXgpCiAgICAgICkgPiAtMTsKICAgIH0gZWxzZSB7CiAgICAgIGVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAoKytpbmRleCA+PSBmcm9tSW5kZXgpIHsKICAgICAgICAgIHJldHVybiAhKHJlc3VsdCA9IHZhbHVlID09PSB0YXJnZXQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2Yga2V5cyByZXR1cm5lZCBmcm9tIHJ1bm5pbmcgZWFjaCBlbGVtZW50IG9mCiAgICogYGNvbGxlY3Rpb25gIHRocm91Z2ggYSBgY2FsbGJhY2tgLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZSBvZiBlYWNoIGtleSBpcwogICAqIHRoZSBudW1iZXIgb2YgdGltZXMgdGhlIGtleSB3YXMgcmV0dXJuZWQgYnkgYGNhbGxiYWNrYC4gVGhlIGBjYWxsYmFja2AgaXMKICAgKiBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKiBUaGUgYGNhbGxiYWNrYCBhcmd1bWVudCBtYXkgYWxzbyBiZSB0aGUgbmFtZSBvZiBhIHByb3BlcnR5IHRvIGNvdW50IGJ5IChlLmcuICdsZW5ndGgnKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IGNhbGxiYWNrfHByb3BlcnR5IFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbgogICAqICBvciBwcm9wZXJ0eSBuYW1lIHRvIGNvdW50IGJ5LgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjb21wb3NlZCBhZ2dyZWdhdGUgb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmNvdW50QnkoWzQuMywgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguZmxvb3IobnVtKTsgfSk7CiAgICogLy8gPT4geyAnNCc6IDEsICc2JzogMiB9CiAgICoKICAgKiBfLmNvdW50QnkoWzQuMywgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuZmxvb3IobnVtKTsgfSwgTWF0aCk7CiAgICogLy8gPT4geyAnNCc6IDEsICc2JzogMiB9CiAgICoKICAgKiBfLmNvdW50QnkoWydvbmUnLCAndHdvJywgJ3RocmVlJ10sICdsZW5ndGgnKTsKICAgKiAvLyA9PiB7ICczJzogMiwgJzUnOiAxIH0KICAgKi8KICBmdW5jdGlvbiBjb3VudEJ5KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKCiAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAga2V5ID0gY2FsbGJhY2sodmFsdWUsIGtleSwgY29sbGVjdGlvbikgKyAnJzsKICAgICAgKGhhc093blByb3BlcnR5LmNhbGwocmVzdWx0LCBrZXkpID8gcmVzdWx0W2tleV0rKyA6IHJlc3VsdFtrZXldID0gMSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgdGhlIGBjYWxsYmFja2AgcmV0dXJucyBhIHRydXRoeSB2YWx1ZSBmb3IgKiphbGwqKiBlbGVtZW50cyBvZiBhCiAgICogYGNvbGxlY3Rpb25gLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZQogICAqIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGFsbAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBhbGwgZWxlbWVudHMgcGFzcyB0aGUgY2FsbGJhY2sgY2hlY2ssCiAgICogIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5ldmVyeShbdHJ1ZSwgMSwgbnVsbCwgJ3llcyddLCBCb29sZWFuKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGV2ZXJ5KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwoKICAgIGlmIChpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGlmICghKHJlc3VsdCA9ICEhY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSkpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICByZXR1cm4gKHJlc3VsdCA9ICEhY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSk7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEV4YW1pbmVzIGVhY2ggZWxlbWVudCBpbiBhIGBjb2xsZWN0aW9uYCwgcmV0dXJuaW5nIGFuIGFycmF5IG9mIGFsbCBlbGVtZW50cwogICAqIHRoZSBgY2FsbGJhY2tgIHJldHVybnMgdHJ1dGh5IGZvci4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZAogICAqIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBzZWxlY3QKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZWxlbWVudHMgdGhhdCBwYXNzZWQgdGhlIGNhbGxiYWNrIGNoZWNrLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgZXZlbnMgPSBfLmZpbHRlcihbMSwgMiwgMywgNCwgNSwgNl0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICUgMiA9PSAwOyB9KTsKICAgKiAvLyA9PiBbMiwgNCwgNl0KICAgKi8KICBmdW5jdGlvbiBmaWx0ZXIoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwoKICAgIGlmIChpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciB2YWx1ZSA9IGNvbGxlY3Rpb25baW5kZXhdOwogICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBFeGFtaW5lcyBlYWNoIGVsZW1lbnQgaW4gYSBgY29sbGVjdGlvbmAsIHJldHVybmluZyB0aGUgZmlyc3Qgb25lIHRoZSBgY2FsbGJhY2tgCiAgICogcmV0dXJucyB0cnV0aHkgZm9yLiBUaGUgZnVuY3Rpb24gcmV0dXJucyBhcyBzb29uIGFzIGl0IGZpbmRzIGFuIGFjY2VwdGFibGUKICAgKiBlbGVtZW50LCBhbmQgZG9lcyBub3QgaXRlcmF0ZSBvdmVyIHRoZSBlbnRpcmUgYGNvbGxlY3Rpb25gLiBUaGUgYGNhbGxiYWNrYCBpcwogICAqIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGRldGVjdAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgZWxlbWVudCB0aGF0IHBhc3NlZCB0aGUgY2FsbGJhY2sgY2hlY2ssCiAgICogIGVsc2UgYHVuZGVmaW5lZGAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBldmVuID0gXy5maW5kKFsxLCAyLCAzLCA0LCA1LCA2XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAqIC8vID0+IDIKICAgKi8KICBmdW5jdGlvbiBmaW5kKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgcmVzdWx0OwogICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CgogICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpIHsKICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEl0ZXJhdGVzIG92ZXIgYSBgY29sbGVjdGlvbmAsIGV4ZWN1dGluZyB0aGUgYGNhbGxiYWNrYCBmb3IgZWFjaCBlbGVtZW50IGluCiAgICogdGhlIGBjb2xsZWN0aW9uYC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUKICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4gQ2FsbGJhY2tzIG1heSBleGl0IGl0ZXJhdGlvbiBlYXJseQogICAqIGJ5IGV4cGxpY2l0bHkgcmV0dXJuaW5nIGBmYWxzZWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgZWFjaAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtBcnJheXxPYmplY3R8U3RyaW5nfSBSZXR1cm5zIGBjb2xsZWN0aW9uYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXyhbMSwgMiwgM10pLmZvckVhY2goYWxlcnQpLmpvaW4oJywnKTsKICAgKiAvLyA9PiBhbGVydHMgZWFjaCBudW1iZXIgYW5kIHJldHVybnMgJzEsMiwzJwogICAqCiAgICogXy5mb3JFYWNoKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0sIGFsZXJ0KTsKICAgKiAvLyA9PiBhbGVydHMgZWFjaCBudW1iZXIgdmFsdWUgKG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAqLwogIGZ1bmN0aW9uIGZvckVhY2goY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIGlmIChjYWxsYmFjayAmJiB0eXBlb2YgdGhpc0FyZyA9PSAndW5kZWZpbmVkJyAmJiBpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGlmIChjYWxsYmFjayhjb2xsZWN0aW9uW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pID09PSBmYWxzZSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlYWNoKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgIH0KICAgIHJldHVybiBjb2xsZWN0aW9uOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2Yga2V5cyByZXR1cm5lZCBmcm9tIHJ1bm5pbmcgZWFjaCBlbGVtZW50IG9mCiAgICogYGNvbGxlY3Rpb25gIHRocm91Z2ggYSBgY2FsbGJhY2tgLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZSBvZiBlYWNoIGtleSBpcyBhbgogICAqIGFycmF5IG9mIGVsZW1lbnRzIHBhc3NlZCB0byBgY2FsbGJhY2tgIHRoYXQgcmV0dXJuZWQgdGhlIGtleS4gVGhlIGBjYWxsYmFja2AKICAgKiBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKiBUaGUgYGNhbGxiYWNrYCBhcmd1bWVudCBtYXkgYWxzbyBiZSB0aGUgbmFtZSBvZiBhIHByb3BlcnR5IHRvIGdyb3VwIGJ5IChlLmcuICdsZW5ndGgnKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IGNhbGxiYWNrfHByb3BlcnR5IFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbgogICAqICBvciBwcm9wZXJ0eSBuYW1lIHRvIGdyb3VwIGJ5LgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjb21wb3NlZCBhZ2dyZWdhdGUgb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmdyb3VwQnkoWzQuMiwgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguZmxvb3IobnVtKTsgfSk7CiAgICogLy8gPT4geyAnNCc6IFs0LjJdLCAnNic6IFs2LjEsIDYuNF0gfQogICAqCiAgICogXy5ncm91cEJ5KFs0LjIsIDYuMSwgNi40XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiB0aGlzLmZsb29yKG51bSk7IH0sIE1hdGgpOwogICAqIC8vID0+IHsgJzQnOiBbNC4yXSwgJzYnOiBbNi4xLCA2LjRdIH0KICAgKgogICAqIF8uZ3JvdXBCeShbJ29uZScsICd0d28nLCAndGhyZWUnXSwgJ2xlbmd0aCcpOwogICAqIC8vID0+IHsgJzMnOiBbJ29uZScsICd0d28nXSwgJzUnOiBbJ3RocmVlJ10gfQogICAqLwogIGZ1bmN0aW9uIGdyb3VwQnkoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwoKICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGtleSwgY29sbGVjdGlvbikgewogICAgICBrZXkgPSBjYWxsYmFjayh2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSArICcnOwogICAgICAoaGFzT3duUHJvcGVydHkuY2FsbChyZXN1bHQsIGtleSkgPyByZXN1bHRba2V5XSA6IHJlc3VsdFtrZXldID0gW10pLnB1c2godmFsdWUpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogSW52b2tlcyB0aGUgbWV0aG9kIG5hbWVkIGJ5IGBtZXRob2ROYW1lYCBvbiBlYWNoIGVsZW1lbnQgaW4gdGhlIGBjb2xsZWN0aW9uYCwKICAgKiByZXR1cm5pbmcgYW4gYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBpbnZva2VkIG1ldGhvZC4gQWRkaXRpb25hbCBhcmd1bWVudHMKICAgKiB3aWxsIGJlIHBhc3NlZCB0byBlYWNoIGludm9rZWQgbWV0aG9kLiBJZiBgbWV0aG9kTmFtZWAgaXMgYSBmdW5jdGlvbiwgaXQgd2lsbAogICAqIGJlIGludm9rZWQgZm9yLCBhbmQgYHRoaXNgIGJvdW5kIHRvLCBlYWNoIGVsZW1lbnQgaW4gdGhlIGBjb2xsZWN0aW9uYC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IG1ldGhvZE5hbWUgVGhlIG5hbWUgb2YgdGhlIG1ldGhvZCB0byBpbnZva2Ugb3IKICAgKiAgdGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbYXJnMSwgYXJnMiwgLi4uXSBBcmd1bWVudHMgdG8gaW52b2tlIHRoZSBtZXRob2Qgd2l0aC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBpbnZva2VkIG1ldGhvZC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pbnZva2UoW1s1LCAxLCA3XSwgWzMsIDIsIDFdXSwgJ3NvcnQnKTsKICAgKiAvLyA9PiBbWzEsIDUsIDddLCBbMSwgMiwgM11dCiAgICoKICAgKiBfLmludm9rZShbMTIzLCA0NTZdLCBTdHJpbmcucHJvdG90eXBlLnNwbGl0LCAnJyk7CiAgICogLy8gPT4gW1snMScsICcyJywgJzMnXSwgWyc0JywgJzUnLCAnNiddXQogICAqLwogIGZ1bmN0aW9uIGludm9rZShjb2xsZWN0aW9uLCBtZXRob2ROYW1lKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlKGFyZ3VtZW50cywgMiksCiAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICBpc0Z1bmMgPSB0eXBlb2YgbWV0aG9kTmFtZSA9PSAnZnVuY3Rpb24nLAogICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmVzdWx0WysraW5kZXhdID0gKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiB2YWx1ZVttZXRob2ROYW1lXSkuYXBwbHkodmFsdWUsIGFyZ3MpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiB2YWx1ZXMgYnkgcnVubmluZyBlYWNoIGVsZW1lbnQgaW4gdGhlIGBjb2xsZWN0aW9uYAogICAqIHRocm91Z2ggYSBgY2FsbGJhY2tgLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aAogICAqIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGNvbGxlY3QKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBgY2FsbGJhY2tgIGV4ZWN1dGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5tYXAoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAqIDM7IH0pOwogICAqIC8vID0+IFszLCA2LCA5XQogICAqCiAgICogXy5tYXAoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiAzOyB9KTsKICAgKiAvLyA9PiBbMywgNiwgOV0gKG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAqLwogIGZ1bmN0aW9uIG1hcChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMCwKICAgICAgICByZXN1bHQgPSBBcnJheSh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInID8gbGVuZ3RoIDogMCk7CgogICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CiAgICBpZiAoaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHJlc3VsdFtpbmRleF0gPSBjYWxsYmFjayhjb2xsZWN0aW9uW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAgICByZXN1bHRbKytpbmRleF0gPSBjYWxsYmFjayh2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogUmV0cmlldmVzIHRoZSBtYXhpbXVtIHZhbHVlIG9mIGFuIGBhcnJheWAuIElmIGBjYWxsYmFja2AgaXMgcGFzc2VkLAogICAqIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yIGVhY2ggdmFsdWUgaW4gdGhlIGBhcnJheWAgdG8gZ2VuZXJhdGUgdGhlCiAgICogY3JpdGVyaW9uIGJ5IHdoaWNoIHRoZSB2YWx1ZSBpcyByYW5rZWQuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvCiAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgbWF4aW11bSB2YWx1ZS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIHN0b29nZXMgPSBbCiAgICogICB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9LAogICAqICAgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9LAogICAqICAgeyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9CiAgICogXTsKICAgKgogICAqIF8ubWF4KHN0b29nZXMsIGZ1bmN0aW9uKHN0b29nZSkgeyByZXR1cm4gc3Rvb2dlLmFnZTsgfSk7CiAgICogLy8gPT4geyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9OwogICAqLwogIGZ1bmN0aW9uIG1heChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIGNvbXB1dGVkID0gLUluZmluaXR5LAogICAgICAgIHJlc3VsdCA9IGNvbXB1dGVkOwoKICAgIGlmICghY2FsbGJhY2sgJiYgaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBjb2xsZWN0aW9uW2luZGV4XTsKICAgICAgICBpZiAodmFsdWUgPiByZXN1bHQpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSAhY2FsbGJhY2sgJiYgaXNTdHJpbmcoY29sbGVjdGlvbikKICAgICAgICA/IGNoYXJBdENhbGxiYWNrCiAgICAgICAgOiBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CgogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIHZhciBjdXJyZW50ID0gY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICBpZiAoY3VycmVudCA+IGNvbXB1dGVkKSB7CiAgICAgICAgICBjb21wdXRlZCA9IGN1cnJlbnQ7CiAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFJldHJpZXZlcyB0aGUgbWluaW11bSB2YWx1ZSBvZiBhbiBgYXJyYXlgLiBJZiBgY2FsbGJhY2tgIGlzIHBhc3NlZCwKICAgKiBpdCB3aWxsIGJlIGV4ZWN1dGVkIGZvciBlYWNoIHZhbHVlIGluIHRoZSBgYXJyYXlgIHRvIGdlbmVyYXRlIHRoZQogICAqIGNyaXRlcmlvbiBieSB3aGljaCB0aGUgdmFsdWUgaXMgcmFua2VkLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AKICAgKiBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIG1pbmltdW0gdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ubWluKFsxMCwgNSwgMTAwLCAyLCAxMDAwXSk7CiAgICogLy8gPT4gMgogICAqLwogIGZ1bmN0aW9uIG1pbihjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIGNvbXB1dGVkID0gSW5maW5pdHksCiAgICAgICAgcmVzdWx0ID0gY29tcHV0ZWQ7CgogICAgaWYgKCFjYWxsYmFjayAmJiBpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciB2YWx1ZSA9IGNvbGxlY3Rpb25baW5kZXhdOwogICAgICAgIGlmICh2YWx1ZSA8IHJlc3VsdCkgewogICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjYWxsYmFjayA9ICFjYWxsYmFjayAmJiBpc1N0cmluZyhjb2xsZWN0aW9uKQogICAgICAgID8gY2hhckF0Q2FsbGJhY2sKICAgICAgICA6IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKCiAgICAgIGVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgdmFyIGN1cnJlbnQgPSBjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICAgIGlmIChjdXJyZW50IDwgY29tcHV0ZWQpIHsKICAgICAgICAgIGNvbXB1dGVkID0gY3VycmVudDsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogUmV0cmlldmVzIHRoZSB2YWx1ZSBvZiBhIHNwZWNpZmllZCBwcm9wZXJ0eSBmcm9tIGFsbCBlbGVtZW50cyBpbgogICAqIHRoZSBgY29sbGVjdGlvbmAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eSBUaGUgcHJvcGVydHkgdG8gcGx1Y2suCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHByb3BlcnR5IHZhbHVlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIHN0b29nZXMgPSBbCiAgICogICB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9LAogICAqICAgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9LAogICAqICAgeyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9CiAgICogXTsKICAgKgogICAqIF8ucGx1Y2soc3Rvb2dlcywgJ25hbWUnKTsKICAgKiAvLyA9PiBbJ21vZScsICdsYXJyeScsICdjdXJseSddCiAgICovCiAgZnVuY3Rpb24gcGx1Y2soY29sbGVjdGlvbiwgcHJvcGVydHkpIHsKICAgIHJldHVybiBtYXAoY29sbGVjdGlvbiwgcHJvcGVydHkgKyAnJyk7CiAgfQoKICAvKioKICAgKiBSZWR1Y2VzIGEgYGNvbGxlY3Rpb25gIHRvIGEgc2luZ2xlIHZhbHVlLiBUaGUgaW5pdGlhbCBzdGF0ZSBvZiB0aGUgcmVkdWN0aW9uCiAgICogaXMgYGFjY3VtdWxhdG9yYCBhbmQgZWFjaCBzdWNjZXNzaXZlIHN0ZXAgb2YgaXQgc2hvdWxkIGJlIHJldHVybmVkIGJ5IHRoZQogICAqIGBjYWxsYmFja2AuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIGZvdXIKICAgKiBhcmd1bWVudHM7IGZvciBhcnJheXMgdGhleSBhcmUgKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBmb2xkbCwgaW5qZWN0CiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbYWNjdW11bGF0b3JdIEluaXRpYWwgdmFsdWUgb2YgdGhlIGFjY3VtdWxhdG9yLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGFjY3VtdWxhdGVkIHZhbHVlLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgc3VtID0gXy5yZWR1Y2UoWzEsIDIsIDNdLCBmdW5jdGlvbihtZW1vLCBudW0pIHsgcmV0dXJuIG1lbW8gKyBudW07IH0pOwogICAqIC8vID0+IDYKICAgKi8KICBmdW5jdGlvbiByZWR1Y2UoY29sbGVjdGlvbiwgY2FsbGJhY2ssIGFjY3VtdWxhdG9yLCB0aGlzQXJnKSB7CiAgICB2YXIgbm9hY2N1bSA9IGFyZ3VtZW50cy5sZW5ndGggPCAzOwogICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgaW5kaWNhdG9yT2JqZWN0KTsKCiAgICBpZiAoaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgaWYgKG5vYWNjdW0pIHsKICAgICAgICBhY2N1bXVsYXRvciA9IGNvbGxlY3Rpb25bKytpbmRleF07CiAgICAgIH0KICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBhY2N1bXVsYXRvciA9IGNhbGxiYWNrKGFjY3VtdWxhdG9yLCBjb2xsZWN0aW9uW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIGFjY3VtdWxhdG9yID0gbm9hY2N1bQogICAgICAgICAgPyAobm9hY2N1bSA9IGZhbHNlLCB2YWx1ZSkKICAgICAgICAgIDogY2FsbGJhY2soYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgfQoKICAvKioKICAgKiBUaGlzIG1ldGhvZCBpcyBzaW1pbGFyIHRvIGBfLnJlZHVjZWAsIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgYQogICAqIGBjb2xsZWN0aW9uYCBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgZm9sZHIKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthY2N1bXVsYXRvcl0gSW5pdGlhbCB2YWx1ZSBvZiB0aGUgYWNjdW11bGF0b3IuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgYWNjdW11bGF0ZWQgdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBsaXN0ID0gW1swLCAxXSwgWzIsIDNdLCBbNCwgNV1dOwogICAqIHZhciBmbGF0ID0gXy5yZWR1Y2VSaWdodChsaXN0LCBmdW5jdGlvbihhLCBiKSB7IHJldHVybiBhLmNvbmNhdChiKTsgfSwgW10pOwogICAqIC8vID0+IFs0LCA1LCAyLCAzLCAwLCAxXQogICAqLwogIGZ1bmN0aW9uIHJlZHVjZVJpZ2h0KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCBhY2N1bXVsYXRvciwgdGhpc0FyZykgewogICAgdmFyIGl0ZXJhYmxlID0gY29sbGVjdGlvbiwKICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgIG5vYWNjdW0gPSBhcmd1bWVudHMubGVuZ3RoIDwgMzsKCiAgICBpZiAodHlwZW9mIGxlbmd0aCAhPSAnbnVtYmVyJykgewogICAgICB2YXIgcHJvcHMgPSBrZXlzKGNvbGxlY3Rpb24pOwogICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CiAgICB9IGVsc2UgaWYgKG5vQ2hhckJ5SW5kZXggJiYgaXNTdHJpbmcoY29sbGVjdGlvbikpIHsKICAgICAgaXRlcmFibGUgPSBjb2xsZWN0aW9uLnNwbGl0KCcnKTsKICAgIH0KICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIGluZGljYXRvck9iamVjdCk7CiAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICBpbmRleCA9IHByb3BzID8gcHJvcHNbLS1sZW5ndGhdIDogLS1sZW5ndGg7CiAgICAgIGFjY3VtdWxhdG9yID0gbm9hY2N1bQogICAgICAgID8gKG5vYWNjdW0gPSBmYWxzZSwgaXRlcmFibGVbaW5kZXhdKQogICAgICAgIDogY2FsbGJhY2soYWNjdW11bGF0b3IsIGl0ZXJhYmxlW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgfSk7CiAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgfQoKICAvKioKICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uZmlsdGVyYCwgdGhpcyBtZXRob2QgcmV0dXJucyB0aGUgZWxlbWVudHMgb2YgYQogICAqIGBjb2xsZWN0aW9uYCB0aGF0IGBjYWxsYmFja2AgZG9lcyAqKm5vdCoqIHJldHVybiB0cnV0aHkgZm9yLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIHRoYXQgZGlkICoqbm90KiogcGFzcyB0aGUKICAgKiAgY2FsbGJhY2sgY2hlY2suCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBvZGRzID0gXy5yZWplY3QoWzEsIDIsIDMsIDQsIDUsIDZdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAlIDIgPT0gMDsgfSk7CiAgICogLy8gPT4gWzEsIDMsIDVdCiAgICovCiAgZnVuY3Rpb24gcmVqZWN0KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgIHJldHVybiBmaWx0ZXIoY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgIHJldHVybiAhY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgIH0pOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiBzaHVmZmxlZCBgYXJyYXlgIHZhbHVlcywgdXNpbmcgYSB2ZXJzaW9uIG9mIHRoZQogICAqIEZpc2hlci1ZYXRlcyBzaHVmZmxlLiBTZWUgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9GaXNoZXItWWF0ZXNfc2h1ZmZsZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBzaHVmZmxlLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBzaHVmZmxlZCBjb2xsZWN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnNodWZmbGUoWzEsIDIsIDMsIDQsIDUsIDZdKTsKICAgKiAvLyA9PiBbNCwgMSwgNiwgMywgNSwgMl0KICAgKi8KICBmdW5jdGlvbiBzaHVmZmxlKGNvbGxlY3Rpb24pIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIHJhbmQgPSBmbG9vcihuYXRpdmVSYW5kb20oKSAqICgrK2luZGV4ICsgMSkpOwogICAgICByZXN1bHRbaW5kZXhdID0gcmVzdWx0W3JhbmRdOwogICAgICByZXN1bHRbcmFuZF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIHNpemUgb2YgdGhlIGBjb2xsZWN0aW9uYCBieSByZXR1cm5pbmcgYGNvbGxlY3Rpb24ubGVuZ3RoYCBmb3IgYXJyYXlzCiAgICogYW5kIGFycmF5LWxpa2Ugb2JqZWN0cyBvciB0aGUgbnVtYmVyIG9mIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgZm9yIG9iamVjdHMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7TnVtYmVyfSBSZXR1cm5zIGBjb2xsZWN0aW9uLmxlbmd0aGAgb3IgbnVtYmVyIG9mIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uc2l6ZShbMSwgMl0pOwogICAqIC8vID0+IDIKICAgKgogICAqIF8uc2l6ZSh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgKiAvLyA9PiAzCiAgICoKICAgKiBfLnNpemUoJ2N1cmx5Jyk7CiAgICogLy8gPT4gNQogICAqLwogIGZ1bmN0aW9uIHNpemUoY29sbGVjdGlvbikgewogICAgdmFyIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CiAgICByZXR1cm4gdHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IGtleXMoY29sbGVjdGlvbikubGVuZ3RoOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBgY2FsbGJhY2tgIHJldHVybnMgYSB0cnV0aHkgdmFsdWUgZm9yICoqYW55KiogZWxlbWVudCBvZiBhCiAgICogYGNvbGxlY3Rpb25gLiBUaGUgZnVuY3Rpb24gcmV0dXJucyBhcyBzb29uIGFzIGl0IGZpbmRzIHBhc3NpbmcgdmFsdWUsIGFuZAogICAqIGRvZXMgbm90IGl0ZXJhdGUgb3ZlciB0aGUgZW50aXJlIGBjb2xsZWN0aW9uYC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8KICAgKiBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBhbnkKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYW55IGVsZW1lbnQgcGFzc2VzIHRoZSBjYWxsYmFjayBjaGVjaywKICAgKiAgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnNvbWUoW251bGwsIDAsICd5ZXMnLCBmYWxzZV0sIEJvb2xlYW4pOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBzb21lKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgcmVzdWx0OwogICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CgogICAgaWYgKGlzQXJyYXkoY29sbGVjdGlvbikpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgaWYgKChyZXN1bHQgPSBjYWxsYmFjayhjb2xsZWN0aW9uW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pKSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIHJldHVybiAhKHJlc3VsdCA9IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiAhIXJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXksIHN0YWJsZSBzb3J0ZWQgaW4gYXNjZW5kaW5nIG9yZGVyIGJ5IHRoZSByZXN1bHRzIG9mCiAgICogcnVubmluZyBlYWNoIGVsZW1lbnQgb2YgYGNvbGxlY3Rpb25gIHRocm91Z2ggYSBgY2FsbGJhY2tgLiBUaGUgYGNhbGxiYWNrYAogICAqIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqIFRoZSBgY2FsbGJhY2tgIGFyZ3VtZW50IG1heSBhbHNvIGJlIHRoZSBuYW1lIG9mIGEgcHJvcGVydHkgdG8gc29ydCBieSAoZS5nLiAnbGVuZ3RoJykuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBjYWxsYmFja3xwcm9wZXJ0eSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24KICAgKiAgb3IgcHJvcGVydHkgbmFtZSB0byBzb3J0IGJ5LgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2Ygc29ydGVkIGVsZW1lbnRzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnNvcnRCeShbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gTWF0aC5zaW4obnVtKTsgfSk7CiAgICogLy8gPT4gWzMsIDEsIDJdCiAgICoKICAgKiBfLnNvcnRCeShbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gdGhpcy5zaW4obnVtKTsgfSwgTWF0aCk7CiAgICogLy8gPT4gWzMsIDEsIDJdCiAgICoKICAgKiBfLnNvcnRCeShbJ2xhcnJ5JywgJ2JyZW5kYW4nLCAnbW9lJ10sICdsZW5ndGgnKTsKICAgKiAvLyA9PiBbJ21vZScsICdsYXJyeScsICdicmVuZGFuJ10KICAgKi8KICBmdW5jdGlvbiBzb3J0QnkoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSB7CiAgICAgIHJlc3VsdFsrK2luZGV4XSA9IHsKICAgICAgICAnY3JpdGVyaWEnOiBjYWxsYmFjayh2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSwKICAgICAgICAnaW5kZXgnOiBpbmRleCwKICAgICAgICAndmFsdWUnOiB2YWx1ZQogICAgICB9OwogICAgfSk7CgogICAgbGVuZ3RoID0gcmVzdWx0Lmxlbmd0aDsKICAgIHJlc3VsdC5zb3J0KGNvbXBhcmVBc2NlbmRpbmcpOwogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIHJlc3VsdFtsZW5ndGhdID0gcmVzdWx0W2xlbmd0aF0udmFsdWU7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ29udmVydHMgdGhlIGBjb2xsZWN0aW9uYCB0byBhbiBhcnJheS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBjb252ZXJ0LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGNvbnZlcnRlZCBhcnJheS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogKGZ1bmN0aW9uKCkgeyByZXR1cm4gXy50b0FycmF5KGFyZ3VtZW50cykuc2xpY2UoMSk7IH0pKDEsIDIsIDMsIDQpOwogICAqIC8vID0+IFsyLCAzLCA0XQogICAqLwogIGZ1bmN0aW9uIHRvQXJyYXkoY29sbGVjdGlvbikgewogICAgaWYgKGNvbGxlY3Rpb24gJiYgdHlwZW9mIGNvbGxlY3Rpb24ubGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgIHJldHVybiBub0NoYXJCeUluZGV4ICYmIGlzU3RyaW5nKGNvbGxlY3Rpb24pCiAgICAgICAgPyBjb2xsZWN0aW9uLnNwbGl0KCcnKQogICAgICAgIDogc2xpY2UoY29sbGVjdGlvbik7CiAgICB9CiAgICByZXR1cm4gdmFsdWVzKGNvbGxlY3Rpb24pOwogIH0KCiAgLyoqCiAgICogRXhhbWluZXMgZWFjaCBlbGVtZW50IGluIGEgYGNvbGxlY3Rpb25gLCByZXR1cm5pbmcgYW4gYXJyYXkgb2YgYWxsIGVsZW1lbnRzCiAgICogdGhhdCBjb250YWluIHRoZSBnaXZlbiBgcHJvcGVydGllc2AuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wZXJ0aWVzIFRoZSBvYmplY3Qgb2YgcHJvcGVydHkgdmFsdWVzIHRvIGZpbHRlciBieS4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZWxlbWVudHMgdGhhdCBjb250YWluIHRoZSBnaXZlbiBgcHJvcGVydGllc2AuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBzdG9vZ2VzID0gWwogICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfSwKICAgKiAgIHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfQogICAqIF07CiAgICoKICAgKiBfLndoZXJlKHN0b29nZXMsIHsgJ2FnZSc6IDQwIH0pOwogICAqIC8vID0+IFt7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9XQogICAqLwogIGZ1bmN0aW9uIHdoZXJlKGNvbGxlY3Rpb24sIHByb3BlcnRpZXMpIHsKICAgIHJldHVybiBmaWx0ZXIoY29sbGVjdGlvbiwgcHJvcGVydGllcyk7CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBhcnJheSB3aXRoIGFsbCBmYWxzZXkgdmFsdWVzIG9mIGBhcnJheWAgcmVtb3ZlZC4gVGhlIHZhbHVlcwogICAqIGBmYWxzZWAsIGBudWxsYCwgYDBgLCBgIiJgLCBgdW5kZWZpbmVkYCBhbmQgYE5hTmAgYXJlIGFsbCBmYWxzZXkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGNvbXBhY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGZpbHRlcmVkIGFycmF5LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmNvbXBhY3QoWzAsIDEsIGZhbHNlLCAyLCAnJywgM10pOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqLwogIGZ1bmN0aW9uIGNvbXBhY3QoYXJyYXkpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICByZXN1bHQgPSBbXTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF07CiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgYGFycmF5YCBlbGVtZW50cyBub3QgcHJlc2VudCBpbiB0aGUgb3RoZXIgYXJyYXlzCiAgICogdXNpbmcgc3RyaWN0IGVxdWFsaXR5IGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcHJvY2Vzcy4KICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXkxLCBhcnJheTIsIC4uLl0gQXJyYXlzIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBgYXJyYXlgIGVsZW1lbnRzIG5vdCBwcmVzZW50IGluIHRoZQogICAqICBvdGhlciBhcnJheXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZGlmZmVyZW5jZShbMSwgMiwgMywgNCwgNV0sIFs1LCAyLCAxMF0pOwogICAqIC8vID0+IFsxLCAzLCA0XQogICAqLwogIGZ1bmN0aW9uIGRpZmZlcmVuY2UoYXJyYXkpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICBmbGF0dGVuZWQgPSBjb25jYXQuYXBwbHkoYXJyYXlSZWYsIGFyZ3VtZW50cyksCiAgICAgICAgY29udGFpbnMgPSBjYWNoZWRDb250YWlucyhmbGF0dGVuZWQsIGxlbmd0aCksCiAgICAgICAgcmVzdWx0ID0gW107CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICBpZiAoIWNvbnRhaW5zKHZhbHVlKSkgewogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIGZpcnN0IGVsZW1lbnQgb2YgdGhlIGBhcnJheWAuIElmIGEgbnVtYmVyIGBuYCBpcyBwYXNzZWQsIHRoZSBmaXJzdAogICAqIGBuYCBlbGVtZW50cyBvZiB0aGUgYGFycmF5YCBhcmUgcmV0dXJuZWQuIElmIGEgYGNhbGxiYWNrYCBmdW5jdGlvbiBpcyBwYXNzZWQsCiAgICogdGhlIGZpcnN0IGVsZW1lbnRzIHRoZSBgY2FsbGJhY2tgIHJldHVybnMgdHJ1dGh5IGZvciBhcmUgcmV0dXJuZWQuIFRoZSBgY2FsbGJhY2tgCiAgICogaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgaGVhZCwgdGFrZQogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxOdW1iZXJ9IFtjYWxsYmFja3xuXSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBlbGVtZW50IG9yCiAgICogIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gcmV0dXJuLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGZpcnN0IGVsZW1lbnQocykgb2YgYGFycmF5YC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5maXJzdChbMSwgMiwgM10pOwogICAqIC8vID0+IDEKICAgKgogICAqIF8uZmlyc3QoWzEsIDIsIDNdLCAyKTsKICAgKiAvLyA9PiBbMSwgMl0KICAgKgogICAqIF8uZmlyc3QoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsKICAgKiAgIHJldHVybiBudW0gPCAzOwogICAqIH0pOwogICAqIC8vID0+IFsxLCAyXQogICAqLwogIGZ1bmN0aW9uIGZpcnN0KGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgaWYgKGFycmF5KSB7CiAgICAgIHZhciBuID0gMCwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKCiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHZhciBpbmRleCA9IC0xOwogICAgICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoICYmIGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgbisrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBuID0gY2FsbGJhY2s7CiAgICAgICAgaWYgKG4gPT0gbnVsbCB8fCB0aGlzQXJnKSB7CiAgICAgICAgICByZXR1cm4gYXJyYXlbMF07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzbGljZShhcnJheSwgMCwgbmF0aXZlTWluKG5hdGl2ZU1heCgwLCBuKSwgbGVuZ3RoKSk7CiAgICB9CiAgfQoKICAvKioKICAgKiBGbGF0dGVucyBhIG5lc3RlZCBhcnJheSAodGhlIG5lc3RpbmcgY2FuIGJlIHRvIGFueSBkZXB0aCkuIElmIGBzaGFsbG93YCBpcwogICAqIHRydXRoeSwgYGFycmF5YCB3aWxsIG9ubHkgYmUgZmxhdHRlbmVkIGEgc2luZ2xlIGxldmVsLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBjb21wYWN0LgogICAqIEBwYXJhbSB7Qm9vbGVhbn0gc2hhbGxvdyBBIGZsYWcgdG8gaW5kaWNhdGUgb25seSBmbGF0dGVuaW5nIGEgc2luZ2xlIGxldmVsLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBmbGF0dGVuZWQgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZmxhdHRlbihbMSwgWzJdLCBbMywgW1s0XV1dXSk7CiAgICogLy8gPT4gWzEsIDIsIDMsIDRdOwogICAqCiAgICogXy5mbGF0dGVuKFsxLCBbMl0sIFszLCBbWzRdXV1dLCB0cnVlKTsKICAgKiAvLyA9PiBbMSwgMiwgMywgW1s0XV1dOwogICAqLwogIGZ1bmN0aW9uIGZsYXR0ZW4oYXJyYXksIHNoYWxsb3cpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICByZXN1bHQgPSBbXTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF07CgogICAgICAvLyByZWN1cnNpdmVseSBmbGF0dGVuIGFycmF5cyAoc3VzY2VwdGlibGUgdG8gY2FsbCBzdGFjayBsaW1pdHMpCiAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgIHB1c2guYXBwbHkocmVzdWx0LCBzaGFsbG93ID8gdmFsdWUgOiBmbGF0dGVuKHZhbHVlKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogR2V0cyB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIGZpcnN0IG9jY3VycmVuY2Ugb2YgYHZhbHVlYCBpcyBmb3VuZCB1c2luZwogICAqIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIHRoZSBgYXJyYXlgIGlzIGFscmVhZHkKICAgKiBzb3J0ZWQsIHBhc3NpbmcgYHRydWVgIGZvciBgZnJvbUluZGV4YCB3aWxsIHJ1biBhIGZhc3RlciBiaW5hcnkgc2VhcmNoLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzZWFyY2guCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICogQHBhcmFtIHtCb29sZWFufE51bWJlcn0gW2Zyb21JbmRleD0wXSBUaGUgaW5kZXggdG8gc2VhcmNoIGZyb20gb3IgYHRydWVgIHRvCiAgICogIHBlcmZvcm0gYSBiaW5hcnkgc2VhcmNoIG9uIGEgc29ydGVkIGBhcnJheWAuCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIG1hdGNoZWQgdmFsdWUgb3IgYC0xYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pbmRleE9mKFsxLCAyLCAzLCAxLCAyLCAzXSwgMik7CiAgICogLy8gPT4gMQogICAqCiAgICogXy5pbmRleE9mKFsxLCAyLCAzLCAxLCAyLCAzXSwgMiwgMyk7CiAgICogLy8gPT4gNAogICAqCiAgICogXy5pbmRleE9mKFsxLCAxLCAyLCAyLCAzLCAzXSwgMiwgdHJ1ZSk7CiAgICogLy8gPT4gMgogICAqLwogIGZ1bmN0aW9uIGluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICBpZiAodHlwZW9mIGZyb21JbmRleCA9PSAnbnVtYmVyJykgewogICAgICBpbmRleCA9IChmcm9tSW5kZXggPCAwID8gbmF0aXZlTWF4KDAsIGxlbmd0aCArIGZyb21JbmRleCkgOiBmcm9tSW5kZXggfHwgMCkgLSAxOwogICAgfSBlbHNlIGlmIChmcm9tSW5kZXgpIHsKICAgICAgaW5kZXggPSBzb3J0ZWRJbmRleChhcnJheSwgdmFsdWUpOwogICAgICByZXR1cm4gYXJyYXlbaW5kZXhdID09PSB2YWx1ZSA/IGluZGV4IDogLTE7CiAgICB9CiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICBpZiAoYXJyYXlbaW5kZXhdID09PSB2YWx1ZSkgewogICAgICAgIHJldHVybiBpbmRleDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIC0xOwogIH0KCiAgLyoqCiAgICogR2V0cyBhbGwgYnV0IHRoZSBsYXN0IGVsZW1lbnQgb2YgYGFycmF5YC4gSWYgYSBudW1iZXIgYG5gIGlzIHBhc3NlZCwgdGhlCiAgICogbGFzdCBgbmAgZWxlbWVudHMgYXJlIGV4Y2x1ZGVkIGZyb20gdGhlIHJlc3VsdC4gSWYgYSBgY2FsbGJhY2tgIGZ1bmN0aW9uCiAgICogaXMgcGFzc2VkLCB0aGUgbGFzdCBlbGVtZW50cyB0aGUgYGNhbGxiYWNrYCByZXR1cm5zIHRydXRoeSBmb3IgYXJlIGV4Y2x1ZGVkCiAgICogZnJvbSB0aGUgcmVzdWx0LiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZQogICAqIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE51bWJlcn0gW2NhbGxiYWNrfG49MV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgZWxlbWVudCBvcgogICAqICB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIGV4Y2x1ZGUuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIHNsaWNlIG9mIGBhcnJheWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaW5pdGlhbChbMSwgMiwgM10pOwogICAqIC8vID0+IFsxLCAyXQogICAqCiAgICogXy5pbml0aWFsKFsxLCAyLCAzXSwgMik7CiAgICogLy8gPT4gWzFdCiAgICoKICAgKiBfLmluaXRpYWwoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsKICAgKiAgIHJldHVybiBudW0gPiAxOwogICAqIH0pOwogICAqIC8vID0+IFsxXQogICAqLwogIGZ1bmN0aW9uIGluaXRpYWwoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICBpZiAoIWFycmF5KSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KICAgIHZhciBuID0gMCwKICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgogICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHZhciBpbmRleCA9IGxlbmd0aDsKICAgICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CiAgICAgIHdoaWxlIChpbmRleC0tICYmIGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgIG4rKzsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgbiA9IChjYWxsYmFjayA9PSBudWxsIHx8IHRoaXNBcmcpID8gMSA6IGNhbGxiYWNrIHx8IG47CiAgICB9CiAgICByZXR1cm4gc2xpY2UoYXJyYXksIDAsIG5hdGl2ZU1pbihuYXRpdmVNYXgoMCwgbGVuZ3RoIC0gbiksIGxlbmd0aCkpOwogIH0KCiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIGludGVyc2VjdGlvbiBvZiBhbGwgdGhlIHBhc3NlZC1pbiBhcnJheXMgdXNpbmcgc3RyaWN0IGVxdWFsaXR5CiAgICogZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheTEsIGFycmF5MiwgLi4uXSBBcnJheXMgdG8gcHJvY2Vzcy4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdW5pcXVlIGVsZW1lbnRzIHRoYXQgYXJlIHByZXNlbnQKICAgKiAgaW4gKiphbGwqKiBvZiB0aGUgYXJyYXlzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmludGVyc2VjdGlvbihbMSwgMiwgM10sIFsxMDEsIDIsIDEsIDEwXSwgWzIsIDFdKTsKICAgKiAvLyA9PiBbMSwgMl0KICAgKi8KICBmdW5jdGlvbiBpbnRlcnNlY3Rpb24oYXJyYXkpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgIGFyZ3NMZW5ndGggPSBhcmdzLmxlbmd0aCwKICAgICAgICBjYWNoZSA9IHsgJzAnOiB7fSB9LAogICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwLAogICAgICAgIGlzTGFyZ2UgPSBsZW5ndGggPj0gMTAwLAogICAgICAgIHJlc3VsdCA9IFtdLAogICAgICAgIHNlZW4gPSByZXN1bHQ7CgogICAgb3V0ZXI6CiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF07CiAgICAgIGlmIChpc0xhcmdlKSB7CiAgICAgICAgdmFyIGtleSA9IHZhbHVlICsgJyc7CiAgICAgICAgdmFyIGluaXRlZCA9IGhhc093blByb3BlcnR5LmNhbGwoY2FjaGVbMF0sIGtleSkKICAgICAgICAgID8gIShzZWVuID0gY2FjaGVbMF1ba2V5XSkKICAgICAgICAgIDogKHNlZW4gPSBjYWNoZVswXVtrZXldID0gW10pOwogICAgICB9CiAgICAgIGlmIChpbml0ZWQgfHwgaW5kZXhPZihzZWVuLCB2YWx1ZSkgPCAwKSB7CiAgICAgICAgaWYgKGlzTGFyZ2UpIHsKICAgICAgICAgIHNlZW4ucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHZhciBhcmdzSW5kZXggPSBhcmdzTGVuZ3RoOwogICAgICAgIHdoaWxlICgtLWFyZ3NJbmRleCkgewogICAgICAgICAgaWYgKCEoY2FjaGVbYXJnc0luZGV4XSB8fCAoY2FjaGVbYXJnc0luZGV4XSA9IGNhY2hlZENvbnRhaW5zKGFyZ3NbYXJnc0luZGV4XSwgMCwgMTAwKSkpKHZhbHVlKSkgewogICAgICAgICAgICBjb250aW51ZSBvdXRlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogR2V0cyB0aGUgbGFzdCBlbGVtZW50IG9mIHRoZSBgYXJyYXlgLiBJZiBhIG51bWJlciBgbmAgaXMgcGFzc2VkLCB0aGUgbGFzdAogICAqIGBuYCBlbGVtZW50cyBvZiB0aGUgYGFycmF5YCBhcmUgcmV0dXJuZWQuIElmIGEgYGNhbGxiYWNrYCBmdW5jdGlvbiBpcyBwYXNzZWQsCiAgICogdGhlIGxhc3QgZWxlbWVudHMgdGhlIGBjYWxsYmFja2AgcmV0dXJucyB0cnV0aHkgZm9yIGFyZSByZXR1cm5lZC4gVGhlIGBjYWxsYmFja2AKICAgKiBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxOdW1iZXJ9IFtjYWxsYmFja3xuXSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBlbGVtZW50IG9yCiAgICogIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gcmV0dXJuLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGxhc3QgZWxlbWVudChzKSBvZiBgYXJyYXlgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmxhc3QoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiAzCiAgICoKICAgKiBfLmxhc3QoWzEsIDIsIDNdLCAyKTsKICAgKiAvLyA9PiBbMiwgM10KICAgKgogICAqIF8ubGFzdChbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgewogICAqICAgcmV0dXJuIG51bSA+IDE7CiAgICogfSk7CiAgICogLy8gPT4gWzIsIDNdCiAgICovCiAgZnVuY3Rpb24gbGFzdChhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIGlmIChhcnJheSkgewogICAgICB2YXIgbiA9IDAsCiAgICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicpIHsKICAgICAgICB2YXIgaW5kZXggPSBsZW5ndGg7CiAgICAgICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CiAgICAgICAgd2hpbGUgKGluZGV4LS0gJiYgY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpKSB7CiAgICAgICAgICBuKys7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG4gPSBjYWxsYmFjazsKICAgICAgICBpZiAobiA9PSBudWxsIHx8IHRoaXNBcmcpIHsKICAgICAgICAgIHJldHVybiBhcnJheVtsZW5ndGggLSAxXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHNsaWNlKGFycmF5LCBuYXRpdmVNYXgoMCwgbGVuZ3RoIC0gbikpOwogICAgfQogIH0KCiAgLyoqCiAgICogR2V0cyB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIGxhc3Qgb2NjdXJyZW5jZSBvZiBgdmFsdWVgIGlzIGZvdW5kIHVzaW5nIHN0cmljdAogICAqIGVxdWFsaXR5IGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4gSWYgYGZyb21JbmRleGAgaXMgbmVnYXRpdmUsIGl0IGlzIHVzZWQKICAgKiBhcyB0aGUgb2Zmc2V0IGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2VhcmNoLgogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAqIEBwYXJhbSB7TnVtYmVyfSBbZnJvbUluZGV4PWFycmF5Lmxlbmd0aC0xXSBUaGUgaW5kZXggdG8gc2VhcmNoIGZyb20uCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIG1hdGNoZWQgdmFsdWUgb3IgYC0xYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5sYXN0SW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIpOwogICAqIC8vID0+IDQKICAgKgogICAqIF8ubGFzdEluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyLCAzKTsKICAgKiAvLyA9PiAxCiAgICovCiAgZnVuY3Rpb24gbGFzdEluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpIHsKICAgIHZhciBpbmRleCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKICAgIGlmICh0eXBlb2YgZnJvbUluZGV4ID09ICdudW1iZXInKSB7CiAgICAgIGluZGV4ID0gKGZyb21JbmRleCA8IDAgPyBuYXRpdmVNYXgoMCwgaW5kZXggKyBmcm9tSW5kZXgpIDogbmF0aXZlTWluKGZyb21JbmRleCwgaW5kZXggLSAxKSkgKyAxOwogICAgfQogICAgd2hpbGUgKGluZGV4LS0pIHsKICAgICAgaWYgKGFycmF5W2luZGV4XSA9PT0gdmFsdWUpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIGZyb20gYXJyYXlzIG9mIGBrZXlzYCBhbmQgYHZhbHVlc2AuIFBhc3MgZWl0aGVyCiAgICogYSBzaW5nbGUgdHdvIGRpbWVuc2lvbmFsIGFycmF5LCBpLmUuIGBbW2tleTEsIHZhbHVlMV0sIFtrZXkyLCB2YWx1ZTJdXWAsIG9yCiAgICogdHdvIGFycmF5cywgb25lIG9mIGBrZXlzYCBhbmQgb25lIG9mIGNvcnJlc3BvbmRpbmcgYHZhbHVlc2AuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0ga2V5cyBUaGUgYXJyYXkgb2Yga2V5cy4KICAgKiBAcGFyYW0ge0FycmF5fSBbdmFsdWVzPVtdXSBUaGUgYXJyYXkgb2YgdmFsdWVzLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIHRoZSBnaXZlbiBrZXlzIGFuZAogICAqICBjb3JyZXNwb25kaW5nIHZhbHVlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5vYmplY3QoWydtb2UnLCAnbGFycnknLCAnY3VybHknXSwgWzMwLCA0MCwgNTBdKTsKICAgKiAvLyA9PiB7ICdtb2UnOiAzMCwgJ2xhcnJ5JzogNDAsICdjdXJseSc6IDUwIH0KICAgKi8KICBmdW5jdGlvbiBvYmplY3Qoa2V5cywgdmFsdWVzKSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBrZXlzID8ga2V5cy5sZW5ndGggOiAwLAogICAgICAgIHJlc3VsdCA9IHt9OwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2luZGV4XTsKICAgICAgaWYgKHZhbHVlcykgewogICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWVzW2luZGV4XTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRba2V5WzBdXSA9IGtleVsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgbnVtYmVycyAocG9zaXRpdmUgYW5kL29yIG5lZ2F0aXZlKSBwcm9ncmVzc2luZyBmcm9tCiAgICogYHN0YXJ0YCB1cCB0byBidXQgbm90IGluY2x1ZGluZyBgZW5kYC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge051bWJlcn0gW3N0YXJ0PTBdIFRoZSBzdGFydCBvZiB0aGUgcmFuZ2UuCiAgICogQHBhcmFtIHtOdW1iZXJ9IGVuZCBUaGUgZW5kIG9mIHRoZSByYW5nZS4KICAgKiBAcGFyYW0ge051bWJlcn0gW3N0ZXA9MV0gVGhlIHZhbHVlIHRvIGluY3JlbWVudCBvciBkZXNjcmVtZW50IGJ5LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyByYW5nZSBhcnJheS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5yYW5nZSgxMCk7CiAgICogLy8gPT4gWzAsIDEsIDIsIDMsIDQsIDUsIDYsIDcsIDgsIDldCiAgICoKICAgKiBfLnJhbmdlKDEsIDExKTsKICAgKiAvLyA9PiBbMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgOSwgMTBdCiAgICoKICAgKiBfLnJhbmdlKDAsIDMwLCA1KTsKICAgKiAvLyA9PiBbMCwgNSwgMTAsIDE1LCAyMCwgMjVdCiAgICoKICAgKiBfLnJhbmdlKDAsIC0xMCwgLTEpOwogICAqIC8vID0+IFswLCAtMSwgLTIsIC0zLCAtNCwgLTUsIC02LCAtNywgLTgsIC05XQogICAqCiAgICogXy5yYW5nZSgwKTsKICAgKiAvLyA9PiBbXQogICAqLwogIGZ1bmN0aW9uIHJhbmdlKHN0YXJ0LCBlbmQsIHN0ZXApIHsKICAgIHN0YXJ0ID0gK3N0YXJ0IHx8IDA7CiAgICBzdGVwID0gK3N0ZXAgfHwgMTsKCiAgICBpZiAoZW5kID09IG51bGwpIHsKICAgICAgZW5kID0gc3RhcnQ7CiAgICAgIHN0YXJ0ID0gMDsKICAgIH0KICAgIC8vIHVzZSBgQXJyYXkobGVuZ3RoKWAgc28gVjggd2lsbCBhdm9pZCB0aGUgc2xvd2VyICJkaWN0aW9uYXJ5IiBtb2RlCiAgICAvLyBodHRwOi8veW91dHUuYmUvWEFxSXBHVThaWmsjdD0xN20yNXMKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IG5hdGl2ZU1heCgwLCBjZWlsKChlbmQgLSBzdGFydCkgLyBzdGVwKSksCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICByZXN1bHRbaW5kZXhdID0gc3RhcnQ7CiAgICAgIHN0YXJ0ICs9IHN0ZXA7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogVGhlIG9wcG9zaXRlIG9mIGBfLmluaXRpYWxgLCB0aGlzIG1ldGhvZCBnZXRzIGFsbCBidXQgdGhlIGZpcnN0IHZhbHVlIG9mIGBhcnJheWAuCiAgICogSWYgYSBudW1iZXIgYG5gIGlzIHBhc3NlZCwgdGhlIGZpcnN0IGBuYCB2YWx1ZXMgYXJlIGV4Y2x1ZGVkIGZyb20gdGhlIHJlc3VsdC4KICAgKiBJZiBhIGBjYWxsYmFja2AgZnVuY3Rpb24gaXMgcGFzc2VkLCB0aGUgZmlyc3QgZWxlbWVudHMgdGhlIGBjYWxsYmFja2AgcmV0dXJucwogICAqIHRydXRoeSBmb3IgYXJlIGV4Y2x1ZGVkIGZyb20gdGhlIHJlc3VsdC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgCiAgICogYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBkcm9wLCB0YWlsCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE51bWJlcn0gW2NhbGxiYWNrfG49MV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgZWxlbWVudCBvcgogICAqICB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIGV4Y2x1ZGUuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIHNsaWNlIG9mIGBhcnJheWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ucmVzdChbMSwgMiwgM10pOwogICAqIC8vID0+IFsyLCAzXQogICAqCiAgICogXy5yZXN0KFsxLCAyLCAzXSwgMik7CiAgICogLy8gPT4gWzNdCiAgICoKICAgKiBfLnJlc3QoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsKICAgKiAgIHJldHVybiBudW0gPCAzOwogICAqIH0pOwogICAqIC8vID0+IFszXQogICAqLwogIGZ1bmN0aW9uIHJlc3QoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicpIHsKICAgICAgdmFyIG4gPSAwLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCAmJiBjYWxsYmFjayhhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSkpIHsKICAgICAgICBuKys7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG4gPSAoY2FsbGJhY2sgPT0gbnVsbCB8fCB0aGlzQXJnKSA/IDEgOiBuYXRpdmVNYXgoMCwgY2FsbGJhY2spOwogICAgfQogICAgcmV0dXJuIHNsaWNlKGFycmF5LCBuKTsKICB9CgogIC8qKgogICAqIFVzZXMgYSBiaW5hcnkgc2VhcmNoIHRvIGRldGVybWluZSB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2ggdGhlIGB2YWx1ZWAKICAgKiBzaG91bGQgYmUgaW5zZXJ0ZWQgaW50byBgYXJyYXlgIGluIG9yZGVyIHRvIG1haW50YWluIHRoZSBzb3J0IG9yZGVyIG9mIHRoZQogICAqIHNvcnRlZCBgYXJyYXlgLiBJZiBgY2FsbGJhY2tgIGlzIHBhc3NlZCwgaXQgd2lsbCBiZSBleGVjdXRlZCBmb3IgYHZhbHVlYCBhbmQKICAgKiBlYWNoIGVsZW1lbnQgaW4gYGFycmF5YCB0byBjb21wdXRlIHRoZWlyIHNvcnQgcmFua2luZy4gVGhlIGBjYWxsYmFja2AgaXMKICAgKiBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCBvbmUgYXJndW1lbnQ7ICh2YWx1ZSkuIFRoZSBgY2FsbGJhY2tgCiAgICogYXJndW1lbnQgbWF5IGFsc28gYmUgdGhlIG5hbWUgb2YgYSBwcm9wZXJ0eSB0byBvcmRlciBieS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBldmFsdWF0ZS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5fHByb3BlcnR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICogIHBlciBpdGVyYXRpb24gb3IgcHJvcGVydHkgbmFtZSB0byBvcmRlciBieS4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIHZhbHVlIHNob3VsZCBiZSBpbnNlcnRlZAogICAqICBpbnRvIGBhcnJheWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uc29ydGVkSW5kZXgoWzIwLCAzMCwgNTBdLCA0MCk7CiAgICogLy8gPT4gMgogICAqCiAgICogXy5zb3J0ZWRJbmRleChbeyAneCc6IDIwIH0sIHsgJ3gnOiAzMCB9LCB7ICd4JzogNTAgfV0sIHsgJ3gnOiA0MCB9LCAneCcpOwogICAqIC8vID0+IDIKICAgKgogICAqIHZhciBkaWN0ID0gewogICAqICAgJ3dvcmRUb051bWJlcic6IHsgJ3R3ZW50eSc6IDIwLCAndGhpcnR5JzogMzAsICdmb3VydHknOiA0MCwgJ2ZpZnR5JzogNTAgfQogICAqIH07CiAgICoKICAgKiBfLnNvcnRlZEluZGV4KFsndHdlbnR5JywgJ3RoaXJ0eScsICdmaWZ0eSddLCAnZm91cnR5JywgZnVuY3Rpb24od29yZCkgewogICAqICAgcmV0dXJuIGRpY3Qud29yZFRvTnVtYmVyW3dvcmRdOwogICAqIH0pOwogICAqIC8vID0+IDIKICAgKgogICAqIF8uc29ydGVkSW5kZXgoWyd0d2VudHknLCAndGhpcnR5JywgJ2ZpZnR5J10sICdmb3VydHknLCBmdW5jdGlvbih3b3JkKSB7CiAgICogICByZXR1cm4gdGhpcy53b3JkVG9OdW1iZXJbd29yZF07CiAgICogfSwgZGljdCk7CiAgICogLy8gPT4gMgogICAqLwogIGZ1bmN0aW9uIHNvcnRlZEluZGV4KGFycmF5LCB2YWx1ZSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBsb3cgPSAwLAogICAgICAgIGhpZ2ggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IGxvdzsKCiAgICAvLyBleHBsaWNpdGx5IHJlZmVyZW5jZSBgaWRlbnRpdHlgIGZvciBiZXR0ZXIgaW5saW5pbmcgaW4gRmlyZWZveAogICAgY2FsbGJhY2sgPSBjYWxsYmFjayA/IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKSA6IGlkZW50aXR5OwogICAgdmFsdWUgPSBjYWxsYmFjayh2YWx1ZSk7CgogICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgdmFyIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMTsKICAgICAgY2FsbGJhY2soYXJyYXlbbWlkXSkgPCB2YWx1ZQogICAgICAgID8gbG93ID0gbWlkICsgMQogICAgICAgIDogaGlnaCA9IG1pZDsKICAgIH0KICAgIHJldHVybiBsb3c7CiAgfQoKICAvKioKICAgKiBDb21wdXRlcyB0aGUgdW5pb24gb2YgdGhlIHBhc3NlZC1pbiBhcnJheXMgdXNpbmcgc3RyaWN0IGVxdWFsaXR5IGZvcgogICAqIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheTEsIGFycmF5MiwgLi4uXSBBcnJheXMgdG8gcHJvY2Vzcy4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdW5pcXVlIHZhbHVlcywgaW4gb3JkZXIsIHRoYXQgYXJlCiAgICogIHByZXNlbnQgaW4gb25lIG9yIG1vcmUgb2YgdGhlIGFycmF5cy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy51bmlvbihbMSwgMiwgM10sIFsxMDEsIDIsIDEsIDEwXSwgWzIsIDFdKTsKICAgKiAvLyA9PiBbMSwgMiwgMywgMTAxLCAxMF0KICAgKi8KICBmdW5jdGlvbiB1bmlvbigpIHsKICAgIHJldHVybiB1bmlxKGNvbmNhdC5hcHBseShhcnJheVJlZiwgYXJndW1lbnRzKSk7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZHVwbGljYXRlLXZhbHVlLWZyZWUgdmVyc2lvbiBvZiB0aGUgYGFycmF5YCB1c2luZyBzdHJpY3QgZXF1YWxpdHkKICAgKiBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIHRoZSBgYXJyYXlgIGlzIGFscmVhZHkgc29ydGVkLCBwYXNzaW5nIGB0cnVlYAogICAqIGZvciBgaXNTb3J0ZWRgIHdpbGwgcnVuIGEgZmFzdGVyIGFsZ29yaXRobS4gSWYgYGNhbGxiYWNrYCBpcyBwYXNzZWQsIGVhY2gKICAgKiBlbGVtZW50IG9mIGBhcnJheWAgaXMgcGFzc2VkIHRocm91Z2ggYSBjYWxsYmFja2AgYmVmb3JlIHVuaXF1ZW5lc3MgaXMgY29tcHV0ZWQuCiAgICogVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgdW5pcXVlCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBwcm9jZXNzLgogICAqIEBwYXJhbSB7Qm9vbGVhbn0gW2lzU29ydGVkPWZhbHNlXSBBIGZsYWcgdG8gaW5kaWNhdGUgdGhhdCB0aGUgYGFycmF5YCBpcyBhbHJlYWR5IHNvcnRlZC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgZHVwbGljYXRlLXZhbHVlLWZyZWUgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8udW5pcShbMSwgMiwgMSwgMywgMV0pOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqCiAgICogXy51bmlxKFsxLCAxLCAyLCAyLCAzXSwgdHJ1ZSk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICoKICAgKiBfLnVuaXEoWzEsIDIsIDEuNSwgMywgMi41XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBNYXRoLmZsb29yKG51bSk7IH0pOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqCiAgICogXy51bmlxKFsxLCAyLCAxLjUsIDMsIDIuNV0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gdGhpcy5mbG9vcihudW0pOyB9LCBNYXRoKTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKi8KICBmdW5jdGlvbiB1bmlxKGFycmF5LCBpc1NvcnRlZCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICByZXN1bHQgPSBbXSwKICAgICAgICBzZWVuID0gcmVzdWx0OwoKICAgIC8vIGp1Z2dsZSBhcmd1bWVudHMKICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aGlzQXJnID0gY2FsbGJhY2s7CiAgICAgIGNhbGxiYWNrID0gaXNTb3J0ZWQ7CiAgICAgIGlzU29ydGVkID0gZmFsc2U7CiAgICB9CiAgICAvLyBpbml0IHZhbHVlIGNhY2hlIGZvciBsYXJnZSBhcnJheXMKICAgIHZhciBpc0xhcmdlID0gIWlzU29ydGVkICYmIGxlbmd0aCA+PSA3NTsKICAgIGlmIChpc0xhcmdlKSB7CiAgICAgIHZhciBjYWNoZSA9IHt9OwogICAgfQogICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgIHNlZW4gPSBbXTsKICAgICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CiAgICB9CiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF0sCiAgICAgICAgICBjb21wdXRlZCA9IGNhbGxiYWNrID8gY2FsbGJhY2sodmFsdWUsIGluZGV4LCBhcnJheSkgOiB2YWx1ZTsKCiAgICAgIGlmIChpc0xhcmdlKSB7CiAgICAgICAgdmFyIGtleSA9IGNvbXB1dGVkICsgJyc7CiAgICAgICAgdmFyIGluaXRlZCA9IGhhc093blByb3BlcnR5LmNhbGwoY2FjaGUsIGtleSkKICAgICAgICAgID8gIShzZWVuID0gY2FjaGVba2V5XSkKICAgICAgICAgIDogKHNlZW4gPSBjYWNoZVtrZXldID0gW10pOwogICAgICB9CiAgICAgIGlmIChpc1NvcnRlZAogICAgICAgICAgICA/ICFpbmRleCB8fCBzZWVuW3NlZW4ubGVuZ3RoIC0gMV0gIT09IGNvbXB1dGVkCiAgICAgICAgICAgIDogaW5pdGVkIHx8IGluZGV4T2Yoc2VlbiwgY29tcHV0ZWQpIDwgMAogICAgICAgICAgKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrIHx8IGlzTGFyZ2UpIHsKICAgICAgICAgIHNlZW4ucHVzaChjb21wdXRlZCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgd2l0aCBhbGwgb2NjdXJyZW5jZXMgb2YgdGhlIHBhc3NlZCB2YWx1ZXMgcmVtb3ZlZCB1c2luZwogICAqIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGZpbHRlci4KICAgKiBAcGFyYW0ge01peGVkfSBbdmFsdWUxLCB2YWx1ZTIsIC4uLl0gVmFsdWVzIHRvIHJlbW92ZS4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgZmlsdGVyZWQgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ud2l0aG91dChbMSwgMiwgMSwgMCwgMywgMSwgNF0sIDAsIDEpOwogICAqIC8vID0+IFsyLCAzLCA0XQogICAqLwogIGZ1bmN0aW9uIHdpdGhvdXQoYXJyYXkpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICBjb250YWlucyA9IGNhY2hlZENvbnRhaW5zKGFyZ3VtZW50cywgMSksCiAgICAgICAgcmVzdWx0ID0gW107CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICBpZiAoIWNvbnRhaW5zKHZhbHVlKSkgewogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdyb3VwcyB0aGUgZWxlbWVudHMgb2YgZWFjaCBhcnJheSBhdCB0aGVpciBjb3JyZXNwb25kaW5nIGluZGV4ZXMuIFVzZWZ1bCBmb3IKICAgKiBzZXBhcmF0ZSBkYXRhIHNvdXJjZXMgdGhhdCBhcmUgY29vcmRpbmF0ZWQgdGhyb3VnaCBtYXRjaGluZyBhcnJheSBpbmRleGVzLgogICAqIEZvciBhIG1hdHJpeCBvZiBuZXN0ZWQgYXJyYXlzLCBgXy56aXAuYXBwbHkoLi4uKWAgY2FuIHRyYW5zcG9zZSB0aGUgbWF0cml4CiAgICogaW4gYSBzaW1pbGFyIGZhc2hpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5MSwgYXJyYXkyLCAuLi5dIEFycmF5cyB0byBwcm9jZXNzLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBncm91cGVkIGVsZW1lbnRzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnppcChbJ21vZScsICdsYXJyeScsICdjdXJseSddLCBbMzAsIDQwLCA1MF0sIFt0cnVlLCBmYWxzZSwgZmFsc2VdKTsKICAgKiAvLyA9PiBbWydtb2UnLCAzMCwgdHJ1ZV0sIFsnbGFycnknLCA0MCwgZmFsc2VdLCBbJ2N1cmx5JywgNTAsIGZhbHNlXV0KICAgKi8KICBmdW5jdGlvbiB6aXAoYXJyYXkpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gbWF4KHBsdWNrKGFyZ3VtZW50cywgJ2xlbmd0aCcpKSA6IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICByZXN1bHRbaW5kZXhdID0gcGx1Y2soYXJndW1lbnRzLCBpbmRleCk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGlzIHJlc3RyaWN0ZWQgdG8gZXhlY3V0aW5nIGBmdW5jYCBvbmx5IGFmdGVyIGl0IGlzCiAgICogY2FsbGVkIGBuYCB0aW1lcy4gVGhlIGBmdW5jYCBpcyBleGVjdXRlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUKICAgKiBjcmVhdGVkIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7TnVtYmVyfSBuIFRoZSBudW1iZXIgb2YgdGltZXMgdGhlIGZ1bmN0aW9uIG11c3QgYmUgY2FsbGVkIGJlZm9yZQogICAqIGl0IGlzIGV4ZWN1dGVkLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHJlc3RyaWN0LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHJlc3RyaWN0ZWQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciByZW5kZXJOb3RlcyA9IF8uYWZ0ZXIobm90ZXMubGVuZ3RoLCByZW5kZXIpOwogICAqIF8uZm9yRWFjaChub3RlcywgZnVuY3Rpb24obm90ZSkgewogICAqICAgbm90ZS5hc3luY1NhdmUoeyAnc3VjY2Vzcyc6IHJlbmRlck5vdGVzIH0pOwogICAqIH0pOwogICAqIC8vIGByZW5kZXJOb3Rlc2AgaXMgcnVuIG9uY2UsIGFmdGVyIGFsbCBub3RlcyBoYXZlIHNhdmVkCiAgICovCiAgZnVuY3Rpb24gYWZ0ZXIobiwgZnVuYykgewogICAgaWYgKG4gPCAxKSB7CiAgICAgIHJldHVybiBmdW5jKCk7CiAgICB9CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmICgtLW4gPCAxKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgaW52b2tlcyBgZnVuY2Agd2l0aCB0aGUgYHRoaXNgCiAgICogYmluZGluZyBvZiBgdGhpc0FyZ2AgYW5kIHByZXBlbmRzIGFueSBhZGRpdGlvbmFsIGBiaW5kYCBhcmd1bWVudHMgdG8gdGhvc2UKICAgKiBwYXNzZWQgdG8gdGhlIGJvdW5kIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGJpbmQuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgZnVuY2AuCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGJlIHBhcnRpYWxseSBhcHBsaWVkLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGJvdW5kIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgZnVuYyA9IGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICogICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyB0aGlzLm5hbWU7CiAgICogfTsKICAgKgogICAqIGZ1bmMgPSBfLmJpbmQoZnVuYywgeyAnbmFtZSc6ICdtb2UnIH0sICdoaScpOwogICAqIGZ1bmMoKTsKICAgKiAvLyA9PiAnaGkgbW9lJwogICAqLwogIGZ1bmN0aW9uIGJpbmQoZnVuYywgdGhpc0FyZykgewogICAgLy8gdXNlIGBGdW5jdGlvbiNiaW5kYCBpZiBpdCBleGlzdHMgYW5kIGlzIGZhc3QKICAgIC8vIChpbiBWOCBgRnVuY3Rpb24jYmluZGAgaXMgc2xvd2VyIGV4Y2VwdCB3aGVuIHBhcnRpYWxseSBhcHBsaWVkKQogICAgcmV0dXJuIGlzQmluZEZhc3QgfHwgKG5hdGl2ZUJpbmQgJiYgYXJndW1lbnRzLmxlbmd0aCA+IDIpCiAgICAgID8gbmF0aXZlQmluZC5jYWxsLmFwcGx5KG5hdGl2ZUJpbmQsIGFyZ3VtZW50cykKICAgICAgOiBjcmVhdGVCb3VuZChmdW5jLCB0aGlzQXJnLCBzbGljZShhcmd1bWVudHMsIDIpKTsKICB9CgogIC8qKgogICAqIEJpbmRzIG1ldGhvZHMgb24gYG9iamVjdGAgdG8gYG9iamVjdGAsIG92ZXJ3cml0aW5nIHRoZSBleGlzdGluZyBtZXRob2QuCiAgICogTWV0aG9kIG5hbWVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzIG9mIG1ldGhvZAogICAqIG5hbWVzLiBJZiBubyBtZXRob2QgbmFtZXMgYXJlIHByb3ZpZGVkLCBhbGwgdGhlIGZ1bmN0aW9uIHByb3BlcnRpZXMgb2YgYG9iamVjdGAKICAgKiB3aWxsIGJlIGJvdW5kLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBiaW5kIGFuZCBhc3NpZ24gdGhlIGJvdW5kIG1ldGhvZHMgdG8uCiAgICogQHBhcmFtIHtTdHJpbmd9IFttZXRob2ROYW1lMSwgbWV0aG9kTmFtZTIsIC4uLl0gTWV0aG9kIG5hbWVzIG9uIHRoZSBvYmplY3QgdG8gYmluZC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgYnV0dG9uVmlldyA9IHsKICAgKiAgJ2xhYmVsJzogJ2xvZGFzaCcsCiAgICogICdvbkNsaWNrJzogZnVuY3Rpb24oKSB7IGFsZXJ0KCdjbGlja2VkOiAnICsgdGhpcy5sYWJlbCk7IH0KICAgKiB9OwogICAqCiAgICogXy5iaW5kQWxsKGJ1dHRvblZpZXcpOwogICAqIGpRdWVyeSgnI2xvZGFzaF9idXR0b24nKS5vbignY2xpY2snLCBidXR0b25WaWV3Lm9uQ2xpY2spOwogICAqIC8vID0+IFdoZW4gdGhlIGJ1dHRvbiBpcyBjbGlja2VkLCBgdGhpcy5sYWJlbGAgd2lsbCBoYXZlIHRoZSBjb3JyZWN0IHZhbHVlCiAgICovCiAgZnVuY3Rpb24gYmluZEFsbChvYmplY3QpIHsKICAgIHZhciBmdW5jcyA9IGNvbmNhdC5hcHBseShhcnJheVJlZiwgYXJndW1lbnRzKSwKICAgICAgICBpbmRleCA9IGZ1bmNzLmxlbmd0aCA+IDEgPyAwIDogKGZ1bmNzID0gZnVuY3Rpb25zKG9iamVjdCksIC0xKSwKICAgICAgICBsZW5ndGggPSBmdW5jcy5sZW5ndGg7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIGtleSA9IGZ1bmNzW2luZGV4XTsKICAgICAgb2JqZWN0W2tleV0gPSBiaW5kKG9iamVjdFtrZXldLCBvYmplY3QpOwogICAgfQogICAgcmV0dXJuIG9iamVjdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgaW52b2tlcyB0aGUgbWV0aG9kIGF0IGBvYmplY3Rba2V5XWAKICAgKiBhbmQgcHJlcGVuZHMgYW55IGFkZGl0aW9uYWwgYGJpbmRLZXlgIGFyZ3VtZW50cyB0byB0aG9zZSBwYXNzZWQgdG8gdGhlIGJvdW5kCiAgICogZnVuY3Rpb24uIFRoaXMgbWV0aG9kIGRpZmZlcnMgZnJvbSBgXy5iaW5kYCBieSBhbGxvd2luZyBib3VuZCBmdW5jdGlvbnMgdG8KICAgKiByZWZlcmVuY2UgbWV0aG9kcyB0aGF0IHdpbGwgYmUgcmVkZWZpbmVkIG9yIGRvbid0IHlldCBleGlzdC4KICAgKiBTZWUgaHR0cDovL21pY2hhdXguY2EvYXJ0aWNsZXMvbGF6eS1mdW5jdGlvbi1kZWZpbml0aW9uLXBhdHRlcm4uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRoZSBtZXRob2QgYmVsb25ncyB0by4KICAgKiBAcGFyYW0ge1N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIG1ldGhvZC4KICAgKiBAcGFyYW0ge01peGVkfSBbYXJnMSwgYXJnMiwgLi4uXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgYm91bmQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBvYmplY3QgPSB7CiAgICogICAnbmFtZSc6ICdtb2UnLAogICAqICAgJ2dyZWV0JzogZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICAgKiAgICAgcmV0dXJuIGdyZWV0aW5nICsgJyAnICsgdGhpcy5uYW1lOwogICAqICAgfQogICAqIH07CiAgICoKICAgKiB2YXIgZnVuYyA9IF8uYmluZEtleShvYmplY3QsICdncmVldCcsICdoaScpOwogICAqIGZ1bmMoKTsKICAgKiAvLyA9PiAnaGkgbW9lJwogICAqCiAgICogb2JqZWN0LmdyZWV0ID0gZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICAgKiAgIHJldHVybiBncmVldGluZyArICcsICcgKyB0aGlzLm5hbWUgKyAnISc7CiAgICogfTsKICAgKgogICAqIGZ1bmMoKTsKICAgKiAvLyA9PiAnaGksIG1vZSEnCiAgICovCiAgZnVuY3Rpb24gYmluZEtleShvYmplY3QsIGtleSkgewogICAgcmV0dXJuIGNyZWF0ZUJvdW5kKG9iamVjdCwga2V5LCBzbGljZShhcmd1bWVudHMsIDIpKTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGlzIHRoZSBjb21wb3NpdGlvbiBvZiB0aGUgcGFzc2VkIGZ1bmN0aW9ucywKICAgKiB3aGVyZSBlYWNoIGZ1bmN0aW9uIGNvbnN1bWVzIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KICAgKiBGb3IgZXhhbXBsZSwgY29tcG9zaW5nIHRoZSBmdW5jdGlvbnMgYGYoKWAsIGBnKClgLCBhbmQgYGgoKWAgcHJvZHVjZXMgYGYoZyhoKCkpKWAuCiAgICogRWFjaCBmdW5jdGlvbiBpcyBleGVjdXRlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgY29tcG9zZWQgZnVuY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2Z1bmMxLCBmdW5jMiwgLi4uXSBGdW5jdGlvbnMgdG8gY29tcG9zZS4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBjb21wb3NlZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGdyZWV0ID0gZnVuY3Rpb24obmFtZSkgeyByZXR1cm4gJ2hpOiAnICsgbmFtZTsgfTsKICAgKiB2YXIgZXhjbGFpbSA9IGZ1bmN0aW9uKHN0YXRlbWVudCkgeyByZXR1cm4gc3RhdGVtZW50ICsgJyEnOyB9OwogICAqIHZhciB3ZWxjb21lID0gXy5jb21wb3NlKGV4Y2xhaW0sIGdyZWV0KTsKICAgKiB3ZWxjb21lKCdtb2UnKTsKICAgKiAvLyA9PiAnaGk6IG1vZSEnCiAgICovCiAgZnVuY3Rpb24gY29tcG9zZSgpIHsKICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50czsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICBsZW5ndGggPSBmdW5jcy5sZW5ndGg7CgogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICBhcmdzID0gW2Z1bmNzW2xlbmd0aF0uYXBwbHkodGhpcywgYXJncyldOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzWzBdOwogICAgfTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgZGVsYXkgdGhlIGV4ZWN1dGlvbiBvZiBgZnVuY2AgdW50aWwgYWZ0ZXIKICAgKiBgd2FpdGAgbWlsbGlzZWNvbmRzIGhhdmUgZWxhcHNlZCBzaW5jZSB0aGUgbGFzdCB0aW1lIGl0IHdhcyBpbnZva2VkLiBQYXNzCiAgICogYHRydWVgIGZvciBgaW1tZWRpYXRlYCB0byBjYXVzZSBkZWJvdW5jZSB0byBpbnZva2UgYGZ1bmNgIG9uIHRoZSBsZWFkaW5nLAogICAqIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLCBlZGdlIG9mIHRoZSBgd2FpdGAgdGltZW91dC4gU3Vic2VxdWVudCBjYWxscyB0bwogICAqIHRoZSBkZWJvdW5jZWQgZnVuY3Rpb24gd2lsbCByZXR1cm4gdGhlIHJlc3VsdCBvZiB0aGUgbGFzdCBgZnVuY2AgY2FsbC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBkZWJvdW5jZS4KICAgKiBAcGFyYW0ge051bWJlcn0gd2FpdCBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byBkZWxheS4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IGltbWVkaWF0ZSBBIGZsYWcgdG8gaW5kaWNhdGUgZXhlY3V0aW9uIGlzIG9uIHRoZSBsZWFkaW5nCiAgICogIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZGVib3VuY2VkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbGF6eUxheW91dCA9IF8uZGVib3VuY2UoY2FsY3VsYXRlTGF5b3V0LCAzMDApOwogICAqIGpRdWVyeSh3aW5kb3cpLm9uKCdyZXNpemUnLCBsYXp5TGF5b3V0KTsKICAgKi8KICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgIHZhciBhcmdzLAogICAgICAgIHJlc3VsdCwKICAgICAgICB0aGlzQXJnLAogICAgICAgIHRpbWVvdXRJZDsKCiAgICBmdW5jdGlvbiBkZWxheWVkKCkgewogICAgICB0aW1lb3V0SWQgPSBudWxsOwogICAgICBpZiAoIWltbWVkaWF0ZSkgewogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGlzSW1tZWRpYXRlID0gaW1tZWRpYXRlICYmICF0aW1lb3V0SWQ7CiAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHRoaXNBcmcgPSB0aGlzOwoKICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZGVsYXllZCwgd2FpdCk7CgogICAgICBpZiAoaXNJbW1lZGlhdGUpIHsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KCiAgLyoqCiAgICogRXhlY3V0ZXMgdGhlIGBmdW5jYCBmdW5jdGlvbiBhZnRlciBgd2FpdGAgbWlsbGlzZWNvbmRzLiBBZGRpdGlvbmFsIGFyZ3VtZW50cwogICAqIHdpbGwgYmUgcGFzc2VkIHRvIGBmdW5jYCB3aGVuIGl0IGlzIGludm9rZWQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gZGVsYXkuCiAgICogQHBhcmFtIHtOdW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gZGVsYXkgZXhlY3V0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBpbnZva2UgdGhlIGZ1bmN0aW9uIHdpdGguCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgYHNldFRpbWVvdXRgIHRpbWVvdXQgaWQuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBsb2cgPSBfLmJpbmQoY29uc29sZS5sb2csIGNvbnNvbGUpOwogICAqIF8uZGVsYXkobG9nLCAxMDAwLCAnbG9nZ2VkIGxhdGVyJyk7CiAgICogLy8gPT4gJ2xvZ2dlZCBsYXRlcicgKEFwcGVhcnMgYWZ0ZXIgb25lIHNlY29uZC4pCiAgICovCiAgZnVuY3Rpb24gZGVsYXkoZnVuYywgd2FpdCkgewogICAgdmFyIGFyZ3MgPSBzbGljZShhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGZ1bmMuYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsgfSwgd2FpdCk7CiAgfQoKICAvKioKICAgKiBEZWZlcnMgZXhlY3V0aW5nIHRoZSBgZnVuY2AgZnVuY3Rpb24gdW50aWwgdGhlIGN1cnJlbnQgY2FsbCBzdGFjayBoYXMgY2xlYXJlZC4KICAgKiBBZGRpdGlvbmFsIGFyZ3VtZW50cyB3aWxsIGJlIHBhc3NlZCB0byBgZnVuY2Agd2hlbiBpdCBpcyBpbnZva2VkLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGRlZmVyLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBpbnZva2UgdGhlIGZ1bmN0aW9uIHdpdGguCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgYHNldFRpbWVvdXRgIHRpbWVvdXQgaWQuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZGVmZXIoZnVuY3Rpb24oKSB7IGFsZXJ0KCdkZWZlcnJlZCcpOyB9KTsKICAgKiAvLyByZXR1cm5zIGZyb20gdGhlIGZ1bmN0aW9uIGJlZm9yZSBgYWxlcnRgIGlzIGNhbGxlZAogICAqLwogIGZ1bmN0aW9uIGRlZmVyKGZ1bmMpIHsKICAgIHZhciBhcmdzID0gc2xpY2UoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBmdW5jLmFwcGx5KHVuZGVmaW5lZCwgYXJncyk7IH0sIDEpOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgbWVtb2l6ZXMgdGhlIHJlc3VsdCBvZiBgZnVuY2AuIElmIGByZXNvbHZlcmAgaXMKICAgKiBwYXNzZWQsIGl0IHdpbGwgYmUgdXNlZCB0byBkZXRlcm1pbmUgdGhlIGNhY2hlIGtleSBmb3Igc3RvcmluZyB0aGUgcmVzdWx0CiAgICogYmFzZWQgb24gdGhlIGFyZ3VtZW50cyBwYXNzZWQgdG8gdGhlIG1lbW9pemVkIGZ1bmN0aW9uLiBCeSBkZWZhdWx0LCB0aGUgZmlyc3QKICAgKiBhcmd1bWVudCBwYXNzZWQgdG8gdGhlIG1lbW9pemVkIGZ1bmN0aW9uIGlzIHVzZWQgYXMgdGhlIGNhY2hlIGtleS4gVGhlIGBmdW5jYAogICAqIGlzIGV4ZWN1dGVkIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBtZW1vaXplZCBmdW5jdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBoYXZlIGl0cyBvdXRwdXQgbWVtb2l6ZWQuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW3Jlc29sdmVyXSBBIGZ1bmN0aW9uIHVzZWQgdG8gcmVzb2x2ZSB0aGUgY2FjaGUga2V5LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IG1lbW9pemluZyBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGZpYm9uYWNjaSA9IF8ubWVtb2l6ZShmdW5jdGlvbihuKSB7CiAgICogICByZXR1cm4gbiA8IDIgPyBuIDogZmlib25hY2NpKG4gLSAxKSArIGZpYm9uYWNjaShuIC0gMik7CiAgICogfSk7CiAgICovCiAgZnVuY3Rpb24gbWVtb2l6ZShmdW5jLCByZXNvbHZlcikgewogICAgdmFyIGNhY2hlID0ge307CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBrZXkgPSAocmVzb2x2ZXIgPyByZXNvbHZlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogYXJndW1lbnRzWzBdKSArICcnOwogICAgICByZXR1cm4gaGFzT3duUHJvcGVydHkuY2FsbChjYWNoZSwga2V5KQogICAgICAgID8gY2FjaGVba2V5XQogICAgICAgIDogKGNhY2hlW2tleV0gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGlzIHJlc3RyaWN0ZWQgdG8gZXhlY3V0ZSBgZnVuY2Agb25jZS4gUmVwZWF0IGNhbGxzIHRvCiAgICogdGhlIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIHRoZSB2YWx1ZSBvZiB0aGUgZmlyc3QgY2FsbC4gVGhlIGBmdW5jYCBpcyBleGVjdXRlZAogICAqIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBjcmVhdGVkIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHJlc3RyaWN0LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHJlc3RyaWN0ZWQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBpbml0aWFsaXplID0gXy5vbmNlKGNyZWF0ZUFwcGxpY2F0aW9uKTsKICAgKiBpbml0aWFsaXplKCk7CiAgICogaW5pdGlhbGl6ZSgpOwogICAqIC8vIGBpbml0aWFsaXplYCBleGVjdXRlcyBgY3JlYXRlQXBwbGljYXRpb25gIG9uY2UKICAgKi8KICBmdW5jdGlvbiBvbmNlKGZ1bmMpIHsKICAgIHZhciByYW4sCiAgICAgICAgcmVzdWx0OwoKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHJhbikgewogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgcmFuID0gdHJ1ZTsKICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgLy8gY2xlYXIgdGhlIGBmdW5jYCB2YXJpYWJsZSBzbyB0aGUgZnVuY3Rpb24gbWF5IGJlIGdhcmJhZ2UgY29sbGVjdGVkCiAgICAgIGZ1bmMgPSBudWxsOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgaW52b2tlcyBgZnVuY2Agd2l0aCBhbnkgYWRkaXRpb25hbAogICAqIGBwYXJ0aWFsYCBhcmd1bWVudHMgcHJlcGVuZGVkIHRvIHRob3NlIHBhc3NlZCB0byB0aGUgbmV3IGZ1bmN0aW9uLiBUaGlzCiAgICogbWV0aG9kIGlzIHNpbWlsYXIgdG8gYF8uYmluZGAsIGV4Y2VwdCBpdCBkb2VzICoqbm90KiogYWx0ZXIgdGhlIGB0aGlzYCBiaW5kaW5nLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHBhcnRpYWxseSBhcHBseSBhcmd1bWVudHMgdG8uCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGJlIHBhcnRpYWxseSBhcHBsaWVkLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHBhcnRpYWxseSBhcHBsaWVkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgZ3JlZXQgPSBmdW5jdGlvbihncmVldGluZywgbmFtZSkgeyByZXR1cm4gZ3JlZXRpbmcgKyAnOiAnICsgbmFtZTsgfTsKICAgKiB2YXIgaGkgPSBfLnBhcnRpYWwoZ3JlZXQsICdoaScpOwogICAqIGhpKCdtb2UnKTsKICAgKiAvLyA9PiAnaGk6IG1vZScKICAgKi8KICBmdW5jdGlvbiBwYXJ0aWFsKGZ1bmMpIHsKICAgIHJldHVybiBjcmVhdGVCb3VuZChmdW5jLCBzbGljZShhcmd1bWVudHMsIDEpKTsKICB9CgogIC8qKgogICAqIFRoaXMgbWV0aG9kIGlzIHNpbWlsYXIgdG8gYF8ucGFydGlhbGAsIGV4Y2VwdCB0aGF0IGBwYXJ0aWFsYCBhcmd1bWVudHMgYXJlCiAgICogYXBwZW5kZWQgdG8gdGhvc2UgcGFzc2VkIHRvIHRoZSBuZXcgZnVuY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcGFydGlhbGx5IGFwcGx5IGFyZ3VtZW50cyB0by4KICAgKiBAcGFyYW0ge01peGVkfSBbYXJnMSwgYXJnMiwgLi4uXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgcGFydGlhbGx5IGFwcGxpZWQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ubWl4aW4oewogICAqICAgJ2RlZmF1bHRzRGVlcCc6IF8ucGFydGlhbFJpZ2h0KF8ubWVyZ2UsIF8uZGVmYXVsdHMpCiAgICogfSk7CiAgICoKICAgKiB2YXIgb3B0aW9ucyA9IHsKICAgKiAgICd2YXJpYWJsZSc6ICdkYXRhJywKICAgKiAgICdpbXBvcnRzJzogeyAnanEnOiAkIH0KICAgKiB9OwogICAqCiAgICogXy5kZWZhdWx0c0RlZXAob3B0aW9ucywgXy50ZW1wbGF0ZVNldHRpbmdzKTsKICAgKgogICAqIG9wdGlvbnMudmFyaWFibGUKICAgKiAvLyA9PiAnZGF0YScKICAgKgogICAqIG9wdGlvbnMuaW1wb3J0cwogICAqIC8vID0+IHsgJ18nOiBfLCAnanEnOiAkIH0KICAgKi8KICBmdW5jdGlvbiBwYXJ0aWFsUmlnaHQoZnVuYykgewogICAgcmV0dXJuIGNyZWF0ZUJvdW5kKGZ1bmMsIHNsaWNlKGFyZ3VtZW50cywgMSksIG51bGwsIGluZGljYXRvck9iamVjdCk7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBleGVjdXRlZCwgd2lsbCBvbmx5IGNhbGwgdGhlIGBmdW5jYAogICAqIGZ1bmN0aW9uIGF0IG1vc3Qgb25jZSBwZXIgZXZlcnkgYHdhaXRgIG1pbGxpc2Vjb25kcy4gSWYgdGhlIHRocm90dGxlZAogICAqIGZ1bmN0aW9uIGlzIGludm9rZWQgbW9yZSB0aGFuIG9uY2UgZHVyaW5nIHRoZSBgd2FpdGAgdGltZW91dCwgYGZ1bmNgIHdpbGwKICAgKiBhbHNvIGJlIGNhbGxlZCBvbiB0aGUgdHJhaWxpbmcgZWRnZSBvZiB0aGUgdGltZW91dC4gU3Vic2VxdWVudCBjYWxscyB0byB0aGUKICAgKiB0aHJvdHRsZWQgZnVuY3Rpb24gd2lsbCByZXR1cm4gdGhlIHJlc3VsdCBvZiB0aGUgbGFzdCBgZnVuY2AgY2FsbC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byB0aHJvdHRsZS4KICAgKiBAcGFyYW0ge051bWJlcn0gd2FpdCBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB0aHJvdHRsZSBleGVjdXRpb25zIHRvLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHRocm90dGxlZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIHRocm90dGxlZCA9IF8udGhyb3R0bGUodXBkYXRlUG9zaXRpb24sIDEwMCk7CiAgICogalF1ZXJ5KHdpbmRvdykub24oJ3Njcm9sbCcsIHRocm90dGxlZCk7CiAgICovCiAgZnVuY3Rpb24gdGhyb3R0bGUoZnVuYywgd2FpdCkgewogICAgdmFyIGFyZ3MsCiAgICAgICAgcmVzdWx0LAogICAgICAgIHRoaXNBcmcsCiAgICAgICAgdGltZW91dElkLAogICAgICAgIGxhc3RDYWxsZWQgPSAwOwoKICAgIGZ1bmN0aW9uIHRyYWlsaW5nQ2FsbCgpIHsKICAgICAgbGFzdENhbGxlZCA9IG5ldyBEYXRlOwogICAgICB0aW1lb3V0SWQgPSBudWxsOwogICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbm93ID0gbmV3IERhdGUsCiAgICAgICAgICByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIGxhc3RDYWxsZWQpOwoKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdGhpc0FyZyA9IHRoaXM7CgogICAgICBpZiAocmVtYWluaW5nIDw9IDApIHsKICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTsKICAgICAgICB0aW1lb3V0SWQgPSBudWxsOwogICAgICAgIGxhc3RDYWxsZWQgPSBub3c7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgICAgfQogICAgICBlbHNlIGlmICghdGltZW91dElkKSB7CiAgICAgICAgdGltZW91dElkID0gc2V0VGltZW91dCh0cmFpbGluZ0NhbGwsIHJlbWFpbmluZyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBwYXNzZXMgYHZhbHVlYCB0byB0aGUgYHdyYXBwZXJgIGZ1bmN0aW9uIGFzIGl0cwogICAqIGZpcnN0IGFyZ3VtZW50LiBBZGRpdGlvbmFsIGFyZ3VtZW50cyBwYXNzZWQgdG8gdGhlIGZ1bmN0aW9uIGFyZSBhcHBlbmRlZAogICAqIHRvIHRob3NlIHBhc3NlZCB0byB0aGUgYHdyYXBwZXJgIGZ1bmN0aW9uLiBUaGUgYHdyYXBwZXJgIGlzIGV4ZWN1dGVkIHdpdGgKICAgKiB0aGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlIGNyZWF0ZWQgZnVuY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHdyYXAuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gd3JhcHBlciBUaGUgd3JhcHBlciBmdW5jdGlvbi4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGhlbGxvID0gZnVuY3Rpb24obmFtZSkgeyByZXR1cm4gJ2hlbGxvICcgKyBuYW1lOyB9OwogICAqIGhlbGxvID0gXy53cmFwKGhlbGxvLCBmdW5jdGlvbihmdW5jKSB7CiAgICogICByZXR1cm4gJ2JlZm9yZSwgJyArIGZ1bmMoJ21vZScpICsgJywgYWZ0ZXInOwogICAqIH0pOwogICAqIGhlbGxvKCk7CiAgICogLy8gPT4gJ2JlZm9yZSwgaGVsbG8gbW9lLCBhZnRlcicKICAgKi8KICBmdW5jdGlvbiB3cmFwKHZhbHVlLCB3cmFwcGVyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gW3ZhbHVlXTsKICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gd3JhcHBlci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH07CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogQ29udmVydHMgdGhlIGNoYXJhY3RlcnMgYCZgLCBgPGAsIGA+YCwgYCJgLCBhbmQgYCdgIGluIGBzdHJpbmdgIHRvIHRoZWlyCiAgICogY29ycmVzcG9uZGluZyBIVE1MIGVudGl0aWVzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJpbmcgVGhlIHN0cmluZyB0byBlc2NhcGUuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyB0aGUgZXNjYXBlZCBzdHJpbmcuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZXNjYXBlKCdNb2UsIExhcnJ5ICYgQ3VybHknKTsKICAgKiAvLyA9PiAnTW9lLCBMYXJyeSAmYW1wOyBDdXJseScKICAgKi8KICBmdW5jdGlvbiBlc2NhcGUoc3RyaW5nKSB7CiAgICByZXR1cm4gc3RyaW5nID09IG51bGwgPyAnJyA6IChzdHJpbmcgKyAnJykucmVwbGFjZShyZVVuZXNjYXBlZEh0bWwsIGVzY2FwZUh0bWxDaGFyKTsKICB9CgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gcmV0dXJucyB0aGUgZmlyc3QgYXJndW1lbnQgcGFzc2VkIHRvIGl0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIEFueSB2YWx1ZS4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgYHZhbHVlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIG1vZSA9IHsgJ25hbWUnOiAnbW9lJyB9OwogICAqIG1vZSA9PT0gXy5pZGVudGl0eShtb2UpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpZGVudGl0eSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KCiAgLyoqCiAgICogQWRkcyBmdW5jdGlvbnMgcHJvcGVydGllcyBvZiBgb2JqZWN0YCB0byB0aGUgYGxvZGFzaGAgZnVuY3Rpb24gYW5kIGNoYWluYWJsZQogICAqIHdyYXBwZXIuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IG9mIGZ1bmN0aW9uIHByb3BlcnRpZXMgdG8gYWRkIHRvIGBsb2Rhc2hgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLm1peGluKHsKICAgKiAgICdjYXBpdGFsaXplJzogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICogICAgIHJldHVybiBzdHJpbmcuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHJpbmcuc2xpY2UoMSkudG9Mb3dlckNhc2UoKTsKICAgKiAgIH0KICAgKiB9KTsKICAgKgogICAqIF8uY2FwaXRhbGl6ZSgnbGFycnknKTsKICAgKiAvLyA9PiAnTGFycnknCiAgICoKICAgKiBfKCdjdXJseScpLmNhcGl0YWxpemUoKTsKICAgKiAvLyA9PiAnQ3VybHknCiAgICovCiAgZnVuY3Rpb24gbWl4aW4ob2JqZWN0KSB7CiAgICBmb3JFYWNoKGZ1bmN0aW9ucyhvYmplY3QpLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgIHZhciBmdW5jID0gbG9kYXNoW21ldGhvZE5hbWVdID0gb2JqZWN0W21ldGhvZE5hbWVdOwoKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX193cmFwcGVkX19dOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gbmV3IGxvZGFzaChmdW5jLmFwcGx5KGxvZGFzaCwgYXJncykpOwogICAgICB9OwogICAgfSk7CiAgfQoKICAvKioKICAgKiBSZXZlcnRzIHRoZSAnXycgdmFyaWFibGUgdG8gaXRzIHByZXZpb3VzIHZhbHVlIGFuZCByZXR1cm5zIGEgcmVmZXJlbmNlIHRvCiAgICogdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgYGxvZGFzaGAgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBsb2Rhc2ggPSBfLm5vQ29uZmxpY3QoKTsKICAgKi8KICBmdW5jdGlvbiBub0NvbmZsaWN0KCkgewogICAgd2luZG93Ll8gPSBvbGREYXNoOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvKioKICAgKiBQcm9kdWNlcyBhIHJhbmRvbSBudW1iZXIgYmV0d2VlbiBgbWluYCBhbmQgYG1heGAgKGluY2x1c2l2ZSkuIElmIG9ubHkgb25lCiAgICogYXJndW1lbnQgaXMgcGFzc2VkLCBhIG51bWJlciBiZXR3ZWVuIGAwYCBhbmQgdGhlIGdpdmVuIG51bWJlciB3aWxsIGJlIHJldHVybmVkLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7TnVtYmVyfSBbbWluPTBdIFRoZSBtaW5pbXVtIHBvc3NpYmxlIHZhbHVlLgogICAqIEBwYXJhbSB7TnVtYmVyfSBbbWF4PTFdIFRoZSBtYXhpbXVtIHBvc3NpYmxlIHZhbHVlLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgYSByYW5kb20gbnVtYmVyLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnJhbmRvbSgwLCA1KTsKICAgKiAvLyA9PiBhIG51bWJlciBiZXR3ZWVuIDAgYW5kIDUKICAgKgogICAqIF8ucmFuZG9tKDUpOwogICAqIC8vID0+IGFsc28gYSBudW1iZXIgYmV0d2VlbiAwIGFuZCA1CiAgICovCiAgZnVuY3Rpb24gcmFuZG9tKG1pbiwgbWF4KSB7CiAgICBpZiAobWluID09IG51bGwgJiYgbWF4ID09IG51bGwpIHsKICAgICAgbWF4ID0gMTsKICAgIH0KICAgIG1pbiA9ICttaW4gfHwgMDsKICAgIGlmIChtYXggPT0gbnVsbCkgewogICAgICBtYXggPSBtaW47CiAgICAgIG1pbiA9IDA7CiAgICB9CiAgICByZXR1cm4gbWluICsgZmxvb3IobmF0aXZlUmFuZG9tKCkgKiAoKCttYXggfHwgMCkgLSBtaW4gKyAxKSk7CiAgfQoKICAvKioKICAgKiBSZXNvbHZlcyB0aGUgdmFsdWUgb2YgYHByb3BlcnR5YCBvbiBgb2JqZWN0YC4gSWYgYHByb3BlcnR5YCBpcyBhIGZ1bmN0aW9uLAogICAqIGl0IHdpbGwgYmUgaW52b2tlZCBhbmQgaXRzIHJlc3VsdCByZXR1cm5lZCwgZWxzZSB0aGUgcHJvcGVydHkgdmFsdWUgaXMKICAgKiByZXR1cm5lZC4gSWYgYG9iamVjdGAgaXMgZmFsc2V5LCB0aGVuIGBudWxsYCBpcyByZXR1cm5lZC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgVGhlIHByb3BlcnR5IHRvIGdldCB0aGUgdmFsdWUgb2YuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSByZXNvbHZlZCB2YWx1ZS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIG9iamVjdCA9IHsKICAgKiAgICdjaGVlc2UnOiAnY3J1bXBldHMnLAogICAqICAgJ3N0dWZmJzogZnVuY3Rpb24oKSB7CiAgICogICAgIHJldHVybiAnbm9uc2Vuc2UnOwogICAqICAgfQogICAqIH07CiAgICoKICAgKiBfLnJlc3VsdChvYmplY3QsICdjaGVlc2UnKTsKICAgKiAvLyA9PiAnY3J1bXBldHMnCiAgICoKICAgKiBfLnJlc3VsdChvYmplY3QsICdzdHVmZicpOwogICAqIC8vID0+ICdub25zZW5zZScKICAgKi8KICBmdW5jdGlvbiByZXN1bHQob2JqZWN0LCBwcm9wZXJ0eSkgewogICAgLy8gYmFzZWQgb24gQmFja2JvbmUncyBwcml2YXRlIGBnZXRWYWx1ZWAgZnVuY3Rpb24KICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9kb2N1bWVudGNsb3VkL2JhY2tib25lL2Jsb2IvMC45LjIvYmFja2JvbmUuanMjTDE0MTktMTQyNAogICAgdmFyIHZhbHVlID0gb2JqZWN0ID8gb2JqZWN0W3Byb3BlcnR5XSA6IG51bGw7CiAgICByZXR1cm4gaXNGdW5jdGlvbih2YWx1ZSkgPyBvYmplY3RbcHJvcGVydHldKCkgOiB2YWx1ZTsKICB9CgogIC8qKgogICAqIEEgbWljcm8tdGVtcGxhdGluZyBtZXRob2QgdGhhdCBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMKICAgKiB3aGl0ZXNwYWNlLCBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KICAgKgogICAqIE5vdGU6IEluIHRoZSBkZXZlbG9wbWVudCBidWlsZCBgXy50ZW1wbGF0ZWAgdXRpbGl6ZXMgc291cmNlVVJMcyBmb3IgZWFzaWVyCiAgICogZGVidWdnaW5nLiBTZWUgaHR0cDovL3d3dy5odG1sNXJvY2tzLmNvbS9lbi90dXRvcmlhbHMvZGV2ZWxvcGVydG9vbHMvc291cmNlbWFwcy8jdG9jLXNvdXJjZXVybAogICAqCiAgICogTm90ZTogTG8tRGFzaCBtYXkgYmUgdXNlZCBpbiBDaHJvbWUgZXh0ZW5zaW9ucyBieSBlaXRoZXIgY3JlYXRpbmcgYSBgbG9kYXNoIGNzcGAKICAgKiBidWlsZCBhbmQgYXZvaWRpbmcgYF8udGVtcGxhdGVgIHVzZSwgb3IgbG9hZGluZyBMby1EYXNoIGluIGEgc2FuZGJveGVkIHBhZ2UuCiAgICogU2VlIGh0dHA6Ly9kZXZlbG9wZXIuY2hyb21lLmNvbS90cnVuay9leHRlbnNpb25zL3NhbmRib3hpbmdFdmFsLmh0bWwKICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge1N0cmluZ30gdGV4dCBUaGUgdGVtcGxhdGUgdGV4dC4KICAgKiBAcGFyYW0ge09iZWN0fSBkYXRhIFRoZSBkYXRhIG9iamVjdCB1c2VkIHRvIHBvcHVsYXRlIHRoZSB0ZXh0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSBvcHRpb25zIG9iamVjdC4KICAgKiAgZXNjYXBlIC0gVGhlICJlc2NhcGUiIGRlbGltaXRlciByZWdleHAuCiAgICogIGV2YWx1YXRlIC0gVGhlICJldmFsdWF0ZSIgZGVsaW1pdGVyIHJlZ2V4cC4KICAgKiAgaW50ZXJwb2xhdGUgLSBUaGUgImludGVycG9sYXRlIiBkZWxpbWl0ZXIgcmVnZXhwLgogICAqICBzb3VyY2VVUkwgLSBUaGUgc291cmNlVVJMIG9mIHRoZSB0ZW1wbGF0ZSdzIGNvbXBpbGVkIHNvdXJjZS4KICAgKiAgdmFyaWFibGUgLSBUaGUgZGF0YSBvYmplY3QgdmFyaWFibGUgbmFtZS4KICAgKgogICAqIEByZXR1cm5zIHtGdW5jdGlvbnxTdHJpbmd9IFJldHVybnMgYSBjb21waWxlZCBmdW5jdGlvbiB3aGVuIG5vIGBkYXRhYCBvYmplY3QKICAgKiAgaXMgZ2l2ZW4sIGVsc2UgaXQgcmV0dXJucyB0aGUgaW50ZXJwb2xhdGVkIHRleHQuCiAgICogQGV4YW1wbGUKICAgKgogICAqIC8vIHVzaW5nIGEgY29tcGlsZWQgdGVtcGxhdGUKICAgKiB2YXIgY29tcGlsZWQgPSBfLnRlbXBsYXRlKCdoZWxsbyA8JT0gbmFtZSAlPicpOwogICAqIGNvbXBpbGVkKHsgJ25hbWUnOiAnbW9lJyB9KTsKICAgKiAvLyA9PiAnaGVsbG8gbW9lJwogICAqCiAgICogdmFyIGxpc3QgPSAnPCUgXy5mb3JFYWNoKHBlb3BsZSwgZnVuY3Rpb24obmFtZSkgeyAlPjxsaT48JT0gbmFtZSAlPjwvbGk+PCUgfSk7ICU+JzsKICAgKiBfLnRlbXBsYXRlKGxpc3QsIHsgJ3Blb3BsZSc6IFsnbW9lJywgJ2xhcnJ5JywgJ2N1cmx5J10gfSk7CiAgICogLy8gPT4gJzxsaT5tb2U8L2xpPjxsaT5sYXJyeTwvbGk+PGxpPmN1cmx5PC9saT4nCiAgICoKICAgKiAvLyB1c2luZyB0aGUgImVzY2FwZSIgZGVsaW1pdGVyIHRvIGVzY2FwZSBIVE1MIGluIGRhdGEgcHJvcGVydHkgdmFsdWVzCiAgICogXy50ZW1wbGF0ZSgnPGI+PCUtIHZhbHVlICU+PC9iPicsIHsgJ3ZhbHVlJzogJzxzY3JpcHQ+JyB9KTsKICAgKiAvLyA9PiAnPGI+Jmx0O3NjcmlwdCZndDs8L2I+JwogICAqCiAgICogLy8gdXNpbmcgdGhlIEVTNiBkZWxpbWl0ZXIgYXMgYW4gYWx0ZXJuYXRpdmUgdG8gdGhlIGRlZmF1bHQgImludGVycG9sYXRlIiBkZWxpbWl0ZXIKICAgKiBfLnRlbXBsYXRlKCdoZWxsbyAkeyBuYW1lIH0nLCB7ICduYW1lJzogJ2N1cmx5JyB9KTsKICAgKiAvLyA9PiAnaGVsbG8gY3VybHknCiAgICoKICAgKiAvLyB1c2luZyB0aGUgaW50ZXJuYWwgYHByaW50YCBmdW5jdGlvbiBpbiAiZXZhbHVhdGUiIGRlbGltaXRlcnMKICAgKiBfLnRlbXBsYXRlKCc8JSBwcmludCgiaGVsbG8gIiArIGVwaXRoZXQpOyAlPiEnLCB7ICdlcGl0aGV0JzogJ3N0b29nZScgfSk7CiAgICogLy8gPT4gJ2hlbGxvIHN0b29nZSEnCiAgICoKICAgKiAvLyB1c2luZyBjdXN0b20gdGVtcGxhdGUgZGVsaW1pdGVycwogICAqIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgKiAgICdpbnRlcnBvbGF0ZSc6IC97eyhbXHNcU10rPyl9fS9nCiAgICogfTsKICAgKgogICAqIF8udGVtcGxhdGUoJ2hlbGxvIHt7IG5hbWUgfX0hJywgeyAnbmFtZSc6ICdtdXN0YWNoZScgfSk7CiAgICogLy8gPT4gJ2hlbGxvIG11c3RhY2hlIScKICAgKgogICAqIC8vIHVzaW5nIHRoZSBgc291cmNlVVJMYCBvcHRpb24gdG8gc3BlY2lmeSBhIGN1c3RvbSBzb3VyY2VVUkwgZm9yIHRoZSB0ZW1wbGF0ZQogICAqIHZhciBjb21waWxlZCA9IF8udGVtcGxhdGUoJ2hlbGxvIDwlPSBuYW1lICU+JywgbnVsbCwgeyAnc291cmNlVVJMJzogJy9iYXNpYy9ncmVldGluZy5qc3QnIH0pOwogICAqIGNvbXBpbGVkKGRhdGEpOwogICAqIC8vID0+IGZpbmQgdGhlIHNvdXJjZSBvZiAiZ3JlZXRpbmcuanN0IiB1bmRlciB0aGUgU291cmNlcyB0YWIgb3IgUmVzb3VyY2VzIHBhbmVsIG9mIHRoZSB3ZWIgaW5zcGVjdG9yCiAgICoKICAgKiAvLyB1c2luZyB0aGUgYHZhcmlhYmxlYCBvcHRpb24gdG8gZW5zdXJlIGEgd2l0aC1zdGF0ZW1lbnQgaXNuJ3QgdXNlZCBpbiB0aGUgY29tcGlsZWQgdGVtcGxhdGUKICAgKiB2YXIgY29tcGlsZWQgPSBfLnRlbXBsYXRlKCdoZWxsbyA8JT0gZGF0YS5uYW1lICU+IScsIG51bGwsIHsgJ3ZhcmlhYmxlJzogJ2RhdGEnIH0pOwogICAqIGNvbXBpbGVkLnNvdXJjZTsKICAgKiAvLyA9PiBmdW5jdGlvbihkYXRhKSB7CiAgICogICB2YXIgX190LCBfX3AgPSAnJywgX19lID0gXy5lc2NhcGU7CiAgICogICBfX3AgKz0gJ2hlbGxvICcgKyAoKF9fdCA9ICggZGF0YS5uYW1lICkpID09IG51bGwgPyAnJyA6IF9fdCkgKyAnISc7CiAgICogICByZXR1cm4gX19wOwogICAqIH0KICAgKgogICAqIC8vIHVzaW5nIHRoZSBgc291cmNlYCBwcm9wZXJ0eSB0byBpbmxpbmUgY29tcGlsZWQgdGVtcGxhdGVzIGZvciBtZWFuaW5nZnVsCiAgICogLy8gbGluZSBudW1iZXJzIGluIGVycm9yIG1lc3NhZ2VzIGFuZCBhIHN0YWNrIHRyYWNlCiAgICogZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4oY3dkLCAnanN0LmpzJyksICdcCiAgICogICB2YXIgSlNUID0ge1wKICAgKiAgICAgIm1haW4iOiAnICsgXy50ZW1wbGF0ZShtYWluVGV4dCkuc291cmNlICsgJ1wKICAgKiAgIH07XAogICAqICcpOwogICAqLwogIGZ1bmN0aW9uIHRlbXBsYXRlKHRleHQsIGRhdGEsIG9wdGlvbnMpIHsKICAgIC8vIGJhc2VkIG9uIEpvaG4gUmVzaWcncyBgdG1wbGAgaW1wbGVtZW50YXRpb24KICAgIC8vIGh0dHA6Ly9lam9obi5vcmcvYmxvZy9qYXZhc2NyaXB0LW1pY3JvLXRlbXBsYXRpbmcvCiAgICAvLyBhbmQgTGF1cmEgRG9rdG9yb3ZhJ3MgZG9ULmpzCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vb2xhZG8vZG9UCiAgICB2YXIgc2V0dGluZ3MgPSBsb2Rhc2gudGVtcGxhdGVTZXR0aW5nczsKICAgIHRleHQgfHwgKHRleHQgPSAnJyk7CgogICAgLy8gYXZvaWQgbWlzc2luZyBkZXBlbmRlbmNpZXMgd2hlbiBgaXRlcmF0b3JUZW1wbGF0ZWAgaXMgbm90IGRlZmluZWQKICAgIG9wdGlvbnMgPSBpdGVyYXRvclRlbXBsYXRlID8gZGVmYXVsdHMoe30sIG9wdGlvbnMsIHNldHRpbmdzKSA6IHNldHRpbmdzOwoKICAgIHZhciBpbXBvcnRzID0gaXRlcmF0b3JUZW1wbGF0ZSAmJiBkZWZhdWx0cyh7fSwgb3B0aW9ucy5pbXBvcnRzLCBzZXR0aW5ncy5pbXBvcnRzKSwKICAgICAgICBpbXBvcnRzS2V5cyA9IGl0ZXJhdG9yVGVtcGxhdGUgPyBrZXlzKGltcG9ydHMpIDogWydfJ10sCiAgICAgICAgaW1wb3J0c1ZhbHVlcyA9IGl0ZXJhdG9yVGVtcGxhdGUgPyB2YWx1ZXMoaW1wb3J0cykgOiBbbG9kYXNoXTsKCiAgICB2YXIgaXNFdmFsdWF0aW5nLAogICAgICAgIGluZGV4ID0gMCwKICAgICAgICBpbnRlcnBvbGF0ZSA9IG9wdGlvbnMuaW50ZXJwb2xhdGUgfHwgcmVOb01hdGNoLAogICAgICAgIHNvdXJjZSA9ICJfX3AgKz0gJyI7CgogICAgLy8gY29tcGlsZSByZWdleHAgdG8gbWF0Y2ggZWFjaCBkZWxpbWl0ZXIKICAgIHZhciByZURlbGltaXRlcnMgPSBSZWdFeHAoCiAgICAgIChvcHRpb25zLmVzY2FwZSB8fCByZU5vTWF0Y2gpLnNvdXJjZSArICd8JyArCiAgICAgIGludGVycG9sYXRlLnNvdXJjZSArICd8JyArCiAgICAgIChpbnRlcnBvbGF0ZSA9PT0gcmVJbnRlcnBvbGF0ZSA/IHJlRXNUZW1wbGF0ZSA6IHJlTm9NYXRjaCkuc291cmNlICsgJ3wnICsKICAgICAgKG9wdGlvbnMuZXZhbHVhdGUgfHwgcmVOb01hdGNoKS5zb3VyY2UgKyAnfCQnCiAgICAsICdnJyk7CgogICAgdGV4dC5yZXBsYWNlKHJlRGVsaW1pdGVycywgZnVuY3Rpb24obWF0Y2gsIGVzY2FwZVZhbHVlLCBpbnRlcnBvbGF0ZVZhbHVlLCBlc1RlbXBsYXRlVmFsdWUsIGV2YWx1YXRlVmFsdWUsIG9mZnNldCkgewogICAgICBpbnRlcnBvbGF0ZVZhbHVlIHx8IChpbnRlcnBvbGF0ZVZhbHVlID0gZXNUZW1wbGF0ZVZhbHVlKTsKCiAgICAgIC8vIGVzY2FwZSBjaGFyYWN0ZXJzIHRoYXQgY2Fubm90IGJlIGluY2x1ZGVkIGluIHN0cmluZyBsaXRlcmFscwogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KS5yZXBsYWNlKHJlVW5lc2NhcGVkU3RyaW5nLCBlc2NhcGVTdHJpbmdDaGFyKTsKCiAgICAgIC8vIHJlcGxhY2UgZGVsaW1pdGVycyB3aXRoIHNuaXBwZXRzCiAgICAgIGlmIChlc2NhcGVWYWx1ZSkgewogICAgICAgIHNvdXJjZSArPSAiJyArXG5fX2UoIiArIGVzY2FwZVZhbHVlICsgIikgK1xuJyI7CiAgICAgIH0KICAgICAgaWYgKGV2YWx1YXRlVmFsdWUpIHsKICAgICAgICBpc0V2YWx1YXRpbmcgPSB0cnVlOwogICAgICAgIHNvdXJjZSArPSAiJztcbiIgKyBldmFsdWF0ZVZhbHVlICsgIjtcbl9fcCArPSAnIjsKICAgICAgfQogICAgICBpZiAoaW50ZXJwb2xhdGVWYWx1ZSkgewogICAgICAgIHNvdXJjZSArPSAiJyArXG4oKF9fdCA9ICgiICsgaW50ZXJwb2xhdGVWYWx1ZSArICIpKSA9PSBudWxsID8gJycgOiBfX3QpICtcbiciOwogICAgICB9CiAgICAgIGluZGV4ID0gb2Zmc2V0ICsgbWF0Y2gubGVuZ3RoOwoKICAgICAgLy8gdGhlIEpTIGVuZ2luZSBlbWJlZGRlZCBpbiBBZG9iZSBwcm9kdWN0cyByZXF1aXJlcyByZXR1cm5pbmcgdGhlIGBtYXRjaGAKICAgICAgLy8gc3RyaW5nIGluIG9yZGVyIHRvIHByb2R1Y2UgdGhlIGNvcnJlY3QgYG9mZnNldGAgdmFsdWUKICAgICAgcmV0dXJuIG1hdGNoOwogICAgfSk7CgogICAgc291cmNlICs9ICInO1xuIjsKCiAgICAvLyBpZiBgdmFyaWFibGVgIGlzIG5vdCBzcGVjaWZpZWQgYW5kIHRoZSB0ZW1wbGF0ZSBjb250YWlucyAiZXZhbHVhdGUiCiAgICAvLyBkZWxpbWl0ZXJzLCB3cmFwIGEgd2l0aC1zdGF0ZW1lbnQgYXJvdW5kIHRoZSBnZW5lcmF0ZWQgY29kZSB0byBhZGQgdGhlCiAgICAvLyBkYXRhIG9iamVjdCB0byB0aGUgdG9wIG9mIHRoZSBzY29wZSBjaGFpbgogICAgdmFyIHZhcmlhYmxlID0gb3B0aW9ucy52YXJpYWJsZSwKICAgICAgICBoYXNWYXJpYWJsZSA9IHZhcmlhYmxlOwoKICAgIGlmICghaGFzVmFyaWFibGUpIHsKICAgICAgdmFyaWFibGUgPSAnb2JqJzsKICAgICAgc291cmNlID0gJ3dpdGggKCcgKyB2YXJpYWJsZSArICcpIHtcbicgKyBzb3VyY2UgKyAnXG59XG4nOwogICAgfQogICAgLy8gY2xlYW51cCBjb2RlIGJ5IHN0cmlwcGluZyBlbXB0eSBzdHJpbmdzCiAgICBzb3VyY2UgPSAoaXNFdmFsdWF0aW5nID8gc291cmNlLnJlcGxhY2UocmVFbXB0eVN0cmluZ0xlYWRpbmcsICcnKSA6IHNvdXJjZSkKICAgICAgLnJlcGxhY2UocmVFbXB0eVN0cmluZ01pZGRsZSwgJyQxJykKICAgICAgLnJlcGxhY2UocmVFbXB0eVN0cmluZ1RyYWlsaW5nLCAnJDE7Jyk7CgogICAgLy8gZnJhbWUgY29kZSBhcyB0aGUgZnVuY3Rpb24gYm9keQogICAgc291cmNlID0gJ2Z1bmN0aW9uKCcgKyB2YXJpYWJsZSArICcpIHtcbicgKwogICAgICAoaGFzVmFyaWFibGUgPyAnJyA6IHZhcmlhYmxlICsgJyB8fCAoJyArIHZhcmlhYmxlICsgJyA9IHt9KTtcbicpICsKICAgICAgInZhciBfX3QsIF9fcCA9ICcnLCBfX2UgPSBfLmVzY2FwZSIgKwogICAgICAoaXNFdmFsdWF0aW5nCiAgICAgICAgPyAnLCBfX2ogPSBBcnJheS5wcm90b3R5cGUuam9pbjtcbicgKwogICAgICAgICAgImZ1bmN0aW9uIHByaW50KCkgeyBfX3AgKz0gX19qLmNhbGwoYXJndW1lbnRzLCAnJykgfVxuIgogICAgICAgIDogKGhhc1ZhcmlhYmxlID8gJycgOiAnLCBfX2QgPSAnICsgdmFyaWFibGUgKyAnLicgKyB2YXJpYWJsZSArICcgfHwgJyArIHZhcmlhYmxlKSArICc7XG4nCiAgICAgICkgKwogICAgICBzb3VyY2UgKwogICAgICAncmV0dXJuIF9fcFxufSc7CgogICAgLy8gVXNlIGEgc291cmNlVVJMIGZvciBlYXNpZXIgZGVidWdnaW5nIGFuZCB3cmFwIGluIGEgbXVsdGktbGluZSBjb21tZW50IHRvCiAgICAvLyBhdm9pZCBpc3N1ZXMgd2l0aCBOYXJ3aGFsLCBJRSBjb25kaXRpb25hbCBjb21waWxhdGlvbiwgYW5kIHRoZSBKUyBlbmdpbmUKICAgIC8vIGVtYmVkZGVkIGluIEFkb2JlIHByb2R1Y3RzLgogICAgLy8gaHR0cDovL3d3dy5odG1sNXJvY2tzLmNvbS9lbi90dXRvcmlhbHMvZGV2ZWxvcGVydG9vbHMvc291cmNlbWFwcy8jdG9jLXNvdXJjZXVybAogICAgdmFyIHNvdXJjZVVSTCA9ICdcbi8qXG4vL0Agc291cmNlVVJMPScgKyAob3B0aW9ucy5zb3VyY2VVUkwgfHwgJy9sb2Rhc2gvdGVtcGxhdGUvc291cmNlWycgKyAodGVtcGxhdGVDb3VudGVyKyspICsgJ10nKSArICdcbiovJzsKCiAgICB0cnkgewogICAgICB2YXIgcmVzdWx0ID0gRnVuY3Rpb24oaW1wb3J0c0tleXMsICdyZXR1cm4gJyArIHNvdXJjZSArIHNvdXJjZVVSTCkuYXBwbHkodW5kZWZpbmVkLCBpbXBvcnRzVmFsdWVzKTsKICAgIH0gY2F0Y2goZSkgewogICAgICBlLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgdGhyb3cgZTsKICAgIH0KICAgIGlmIChkYXRhKSB7CiAgICAgIHJldHVybiByZXN1bHQoZGF0YSk7CiAgICB9CiAgICAvLyBwcm92aWRlIHRoZSBjb21waWxlZCBmdW5jdGlvbidzIHNvdXJjZSB2aWEgaXRzIGB0b1N0cmluZ2AgbWV0aG9kLCBpbgogICAgLy8gc3VwcG9ydGVkIGVudmlyb25tZW50cywgb3IgdGhlIGBzb3VyY2VgIHByb3BlcnR5IGFzIGEgY29udmVuaWVuY2UgZm9yCiAgICAvLyBpbmxpbmluZyBjb21waWxlZCB0ZW1wbGF0ZXMgZHVyaW5nIHRoZSBidWlsZCBwcm9jZXNzCiAgICByZXN1bHQuc291cmNlID0gc291cmNlOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEV4ZWN1dGVzIHRoZSBgY2FsbGJhY2tgIGZ1bmN0aW9uIGBuYCB0aW1lcywgcmV0dXJuaW5nIGFuIGFycmF5IG9mIHRoZSByZXN1bHRzCiAgICogb2YgZWFjaCBgY2FsbGJhY2tgIGV4ZWN1dGlvbi4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkCiAgICogd2l0aCBvbmUgYXJndW1lbnQ7IChpbmRleCkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHBhcmFtIHtOdW1iZXJ9IG4gVGhlIG51bWJlciBvZiB0aW1lcyB0byBleGVjdXRlIHRoZSBjYWxsYmFjay4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiB0aGUgcmVzdWx0cyBvZiBlYWNoIGBjYWxsYmFja2AgZXhlY3V0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgZGljZVJvbGxzID0gXy50aW1lcygzLCBfLnBhcnRpYWwoXy5yYW5kb20sIDEsIDYpKTsKICAgKiAvLyA9PiBbMywgNiwgNF0KICAgKgogICAqIF8udGltZXMoMywgZnVuY3Rpb24obikgeyBtYWdlLmNhc3RTcGVsbChuKTsgfSk7CiAgICogLy8gPT4gY2FsbHMgYG1hZ2UuY2FzdFNwZWxsKG4pYCB0aHJlZSB0aW1lcywgcGFzc2luZyBgbmAgb2YgYDBgLCBgMWAsIGFuZCBgMmAgcmVzcGVjdGl2ZWx5CiAgICoKICAgKiBfLnRpbWVzKDMsIGZ1bmN0aW9uKG4pIHsgdGhpcy5jYXN0KG4pOyB9LCBtYWdlKTsKICAgKiAvLyA9PiBhbHNvIGNhbGxzIGBtYWdlLmNhc3RTcGVsbChuKWAgdGhyZWUgdGltZXMKICAgKi8KICBmdW5jdGlvbiB0aW1lcyhuLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgbiA9ICtuIHx8IDA7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICByZXN1bHQgPSBBcnJheShuKTsKCiAgICB3aGlsZSAoKytpbmRleCA8IG4pIHsKICAgICAgcmVzdWx0W2luZGV4XSA9IGNhbGxiYWNrLmNhbGwodGhpc0FyZywgaW5kZXgpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFRoZSBvcHBvc2l0ZSBvZiBgXy5lc2NhcGVgLCB0aGlzIG1ldGhvZCBjb252ZXJ0cyB0aGUgSFRNTCBlbnRpdGllcwogICAqIGAmYW1wO2AsIGAmbHQ7YCwgYCZndDtgLCBgJnF1b3Q7YCwgYW5kIGAmI3gyNztgIGluIGBzdHJpbmdgIHRvIHRoZWlyCiAgICogY29ycmVzcG9uZGluZyBjaGFyYWN0ZXJzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJpbmcgVGhlIHN0cmluZyB0byB1bmVzY2FwZS4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSB1bmVzY2FwZWQgc3RyaW5nLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnVuZXNjYXBlKCdNb2UsIExhcnJ5ICZhbXA7IEN1cmx5Jyk7CiAgICogLy8gPT4gJ01vZSwgTGFycnkgJiBDdXJseScKICAgKi8KICBmdW5jdGlvbiB1bmVzY2FwZShzdHJpbmcpIHsKICAgIHJldHVybiBzdHJpbmcgPT0gbnVsbCA/ICcnIDogKHN0cmluZyArICcnKS5yZXBsYWNlKHJlRXNjYXBlZEh0bWwsIHVuZXNjYXBlSHRtbENoYXIpOwogIH0KCiAgLyoqCiAgICogR2VuZXJhdGVzIGEgdW5pcXVlIElELiBJZiBgcHJlZml4YCBpcyBwYXNzZWQsIHRoZSBJRCB3aWxsIGJlIGFwcGVuZGVkIHRvIGl0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7U3RyaW5nfSBbcHJlZml4XSBUaGUgdmFsdWUgdG8gcHJlZml4IHRoZSBJRCB3aXRoLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgdGhlIHVuaXF1ZSBJRC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy51bmlxdWVJZCgnY29udGFjdF8nKTsKICAgKiAvLyA9PiAnY29udGFjdF8xMDQnCiAgICoKICAgKiBfLnVuaXF1ZUlkKCk7CiAgICogLy8gPT4gJzEwNScKICAgKi8KICBmdW5jdGlvbiB1bmlxdWVJZChwcmVmaXgpIHsKICAgIHZhciBpZCA9ICsraWRDb3VudGVyOwogICAgcmV0dXJuIChwcmVmaXggPT0gbnVsbCA/ICcnIDogcHJlZml4ICsgJycpICsgaWQ7CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogSW52b2tlcyBgaW50ZXJjZXB0b3JgIHdpdGggdGhlIGB2YWx1ZWAgYXMgdGhlIGZpcnN0IGFyZ3VtZW50LCBhbmQgdGhlbgogICAqIHJldHVybnMgYHZhbHVlYC4gVGhlIHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwKICAgKiBpbiBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBwYXNzIHRvIGBpbnRlcmNlcHRvcmAuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gaW50ZXJjZXB0b3IgVGhlIGZ1bmN0aW9uIHRvIGludm9rZS4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgYHZhbHVlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXyhbMSwgMiwgMywgNF0pCiAgICogIC5maWx0ZXIoZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pCiAgICogIC50YXAoYWxlcnQpCiAgICogIC5tYXAoZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiBudW07IH0pCiAgICogIC52YWx1ZSgpOwogICAqIC8vID0+IC8vIFsyLCA0XSAoYWxlcnRlZCkKICAgKiAvLyA9PiBbNCwgMTZdCiAgICovCiAgZnVuY3Rpb24gdGFwKHZhbHVlLCBpbnRlcmNlcHRvcikgewogICAgaW50ZXJjZXB0b3IodmFsdWUpOwogICAgcmV0dXJuIHZhbHVlOwogIH0KCiAgLyoqCiAgICogUHJvZHVjZXMgdGhlIGB0b1N0cmluZ2AgcmVzdWx0IG9mIHRoZSB3cmFwcGVkIHZhbHVlLgogICAqCiAgICogQG5hbWUgdG9TdHJpbmcKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgdGhlIHN0cmluZyByZXN1bHQuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8oWzEsIDIsIDNdKS50b1N0cmluZygpOwogICAqIC8vID0+ICcxLDIsMycKICAgKi8KICBmdW5jdGlvbiB3cmFwcGVyVG9TdHJpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5fX3dyYXBwZWRfXyArICcnOwogIH0KCiAgLyoqCiAgICogRXh0cmFjdHMgdGhlIHdyYXBwZWQgdmFsdWUuCiAgICoKICAgKiBAbmFtZSB2YWx1ZU9mCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgdmFsdWUKICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIHdyYXBwZWQgdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8oWzEsIDIsIDNdKS52YWx1ZU9mKCk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICovCiAgZnVuY3Rpb24gd3JhcHBlclZhbHVlT2YoKSB7CiAgICByZXR1cm4gdGhpcy5fX3dyYXBwZWRfXzsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvLyBhZGQgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIHdyYXBwZWQgdmFsdWVzIHdoZW4gY2hhaW5pbmcKICBsb2Rhc2guYWZ0ZXIgPSBhZnRlcjsKICBsb2Rhc2guYXNzaWduID0gYXNzaWduOwogIGxvZGFzaC5hdCA9IGF0OwogIGxvZGFzaC5iaW5kID0gYmluZDsKICBsb2Rhc2guYmluZEFsbCA9IGJpbmRBbGw7CiAgbG9kYXNoLmJpbmRLZXkgPSBiaW5kS2V5OwogIGxvZGFzaC5jb21wYWN0ID0gY29tcGFjdDsKICBsb2Rhc2guY29tcG9zZSA9IGNvbXBvc2U7CiAgbG9kYXNoLmNvdW50QnkgPSBjb3VudEJ5OwogIGxvZGFzaC5kZWJvdW5jZSA9IGRlYm91bmNlOwogIGxvZGFzaC5kZWZhdWx0cyA9IGRlZmF1bHRzOwogIGxvZGFzaC5kZWZlciA9IGRlZmVyOwogIGxvZGFzaC5kZWxheSA9IGRlbGF5OwogIGxvZGFzaC5kaWZmZXJlbmNlID0gZGlmZmVyZW5jZTsKICBsb2Rhc2guZmlsdGVyID0gZmlsdGVyOwogIGxvZGFzaC5mbGF0dGVuID0gZmxhdHRlbjsKICBsb2Rhc2guZm9yRWFjaCA9IGZvckVhY2g7CiAgbG9kYXNoLmZvckluID0gZm9ySW47CiAgbG9kYXNoLmZvck93biA9IGZvck93bjsKICBsb2Rhc2guZnVuY3Rpb25zID0gZnVuY3Rpb25zOwogIGxvZGFzaC5ncm91cEJ5ID0gZ3JvdXBCeTsKICBsb2Rhc2guaW5pdGlhbCA9IGluaXRpYWw7CiAgbG9kYXNoLmludGVyc2VjdGlvbiA9IGludGVyc2VjdGlvbjsKICBsb2Rhc2guaW52ZXJ0ID0gaW52ZXJ0OwogIGxvZGFzaC5pbnZva2UgPSBpbnZva2U7CiAgbG9kYXNoLmtleXMgPSBrZXlzOwogIGxvZGFzaC5tYXAgPSBtYXA7CiAgbG9kYXNoLm1heCA9IG1heDsKICBsb2Rhc2gubWVtb2l6ZSA9IG1lbW9pemU7CiAgbG9kYXNoLm1lcmdlID0gbWVyZ2U7CiAgbG9kYXNoLm1pbiA9IG1pbjsKICBsb2Rhc2gub2JqZWN0ID0gb2JqZWN0OwogIGxvZGFzaC5vbWl0ID0gb21pdDsKICBsb2Rhc2gub25jZSA9IG9uY2U7CiAgbG9kYXNoLnBhaXJzID0gcGFpcnM7CiAgbG9kYXNoLnBhcnRpYWwgPSBwYXJ0aWFsOwogIGxvZGFzaC5wYXJ0aWFsUmlnaHQgPSBwYXJ0aWFsUmlnaHQ7CiAgbG9kYXNoLnBpY2sgPSBwaWNrOwogIGxvZGFzaC5wbHVjayA9IHBsdWNrOwogIGxvZGFzaC5yYW5nZSA9IHJhbmdlOwogIGxvZGFzaC5yZWplY3QgPSByZWplY3Q7CiAgbG9kYXNoLnJlc3QgPSByZXN0OwogIGxvZGFzaC5zaHVmZmxlID0gc2h1ZmZsZTsKICBsb2Rhc2guc29ydEJ5ID0gc29ydEJ5OwogIGxvZGFzaC50YXAgPSB0YXA7CiAgbG9kYXNoLnRocm90dGxlID0gdGhyb3R0bGU7CiAgbG9kYXNoLnRpbWVzID0gdGltZXM7CiAgbG9kYXNoLnRvQXJyYXkgPSB0b0FycmF5OwogIGxvZGFzaC51bmlvbiA9IHVuaW9uOwogIGxvZGFzaC51bmlxID0gdW5pcTsKICBsb2Rhc2gudmFsdWVzID0gdmFsdWVzOwogIGxvZGFzaC53aGVyZSA9IHdoZXJlOwogIGxvZGFzaC53aXRob3V0ID0gd2l0aG91dDsKICBsb2Rhc2gud3JhcCA9IHdyYXA7CiAgbG9kYXNoLnppcCA9IHppcDsKCiAgLy8gYWRkIGFsaWFzZXMKICBsb2Rhc2guY29sbGVjdCA9IG1hcDsKICBsb2Rhc2guZHJvcCA9IHJlc3Q7CiAgbG9kYXNoLmVhY2ggPSBmb3JFYWNoOwogIGxvZGFzaC5leHRlbmQgPSBhc3NpZ247CiAgbG9kYXNoLm1ldGhvZHMgPSBmdW5jdGlvbnM7CiAgbG9kYXNoLnNlbGVjdCA9IGZpbHRlcjsKICBsb2Rhc2gudGFpbCA9IHJlc3Q7CiAgbG9kYXNoLnVuaXF1ZSA9IHVuaXE7CgogIC8vIGFkZCBmdW5jdGlvbnMgdG8gYGxvZGFzaC5wcm90b3R5cGVgCiAgbWl4aW4obG9kYXNoKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8vIGFkZCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gdW53cmFwcGVkIHZhbHVlcyB3aGVuIGNoYWluaW5nCiAgbG9kYXNoLmNsb25lID0gY2xvbmU7CiAgbG9kYXNoLmNsb25lRGVlcCA9IGNsb25lRGVlcDsKICBsb2Rhc2guY29udGFpbnMgPSBjb250YWluczsKICBsb2Rhc2guZXNjYXBlID0gZXNjYXBlOwogIGxvZGFzaC5ldmVyeSA9IGV2ZXJ5OwogIGxvZGFzaC5maW5kID0gZmluZDsKICBsb2Rhc2guaGFzID0gaGFzOwogIGxvZGFzaC5pZGVudGl0eSA9IGlkZW50aXR5OwogIGxvZGFzaC5pbmRleE9mID0gaW5kZXhPZjsKICBsb2Rhc2guaXNBcmd1bWVudHMgPSBpc0FyZ3VtZW50czsKICBsb2Rhc2guaXNBcnJheSA9IGlzQXJyYXk7CiAgbG9kYXNoLmlzQm9vbGVhbiA9IGlzQm9vbGVhbjsKICBsb2Rhc2guaXNEYXRlID0gaXNEYXRlOwogIGxvZGFzaC5pc0VsZW1lbnQgPSBpc0VsZW1lbnQ7CiAgbG9kYXNoLmlzRW1wdHkgPSBpc0VtcHR5OwogIGxvZGFzaC5pc0VxdWFsID0gaXNFcXVhbDsKICBsb2Rhc2guaXNGaW5pdGUgPSBpc0Zpbml0ZTsKICBsb2Rhc2guaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb247CiAgbG9kYXNoLmlzTmFOID0gaXNOYU47CiAgbG9kYXNoLmlzTnVsbCA9IGlzTnVsbDsKICBsb2Rhc2guaXNOdW1iZXIgPSBpc051bWJlcjsKICBsb2Rhc2guaXNPYmplY3QgPSBpc09iamVjdDsKICBsb2Rhc2guaXNQbGFpbk9iamVjdCA9IGlzUGxhaW5PYmplY3Q7CiAgbG9kYXNoLmlzUmVnRXhwID0gaXNSZWdFeHA7CiAgbG9kYXNoLmlzU3RyaW5nID0gaXNTdHJpbmc7CiAgbG9kYXNoLmlzVW5kZWZpbmVkID0gaXNVbmRlZmluZWQ7CiAgbG9kYXNoLmxhc3RJbmRleE9mID0gbGFzdEluZGV4T2Y7CiAgbG9kYXNoLm1peGluID0gbWl4aW47CiAgbG9kYXNoLm5vQ29uZmxpY3QgPSBub0NvbmZsaWN0OwogIGxvZGFzaC5yYW5kb20gPSByYW5kb207CiAgbG9kYXNoLnJlZHVjZSA9IHJlZHVjZTsKICBsb2Rhc2gucmVkdWNlUmlnaHQgPSByZWR1Y2VSaWdodDsKICBsb2Rhc2gucmVzdWx0ID0gcmVzdWx0OwogIGxvZGFzaC5zaXplID0gc2l6ZTsKICBsb2Rhc2guc29tZSA9IHNvbWU7CiAgbG9kYXNoLnNvcnRlZEluZGV4ID0gc29ydGVkSW5kZXg7CiAgbG9kYXNoLnRlbXBsYXRlID0gdGVtcGxhdGU7CiAgbG9kYXNoLnVuZXNjYXBlID0gdW5lc2NhcGU7CiAgbG9kYXNoLnVuaXF1ZUlkID0gdW5pcXVlSWQ7CgogIC8vIGFkZCBhbGlhc2VzCiAgbG9kYXNoLmFsbCA9IGV2ZXJ5OwogIGxvZGFzaC5hbnkgPSBzb21lOwogIGxvZGFzaC5kZXRlY3QgPSBmaW5kOwogIGxvZGFzaC5mb2xkbCA9IHJlZHVjZTsKICBsb2Rhc2guZm9sZHIgPSByZWR1Y2VSaWdodDsKICBsb2Rhc2guaW5jbHVkZSA9IGNvbnRhaW5zOwogIGxvZGFzaC5pbmplY3QgPSByZWR1Y2U7CgogIGZvck93bihsb2Rhc2gsIGZ1bmN0aW9uKGZ1bmMsIG1ldGhvZE5hbWUpIHsKICAgIGlmICghbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSkgewogICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbdGhpcy5fX3dyYXBwZWRfX107CiAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KGxvZGFzaCwgYXJncyk7CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvLyBhZGQgZnVuY3Rpb25zIGNhcGFibGUgb2YgcmV0dXJuaW5nIHdyYXBwZWQgYW5kIHVud3JhcHBlZCB2YWx1ZXMgd2hlbiBjaGFpbmluZwogIGxvZGFzaC5maXJzdCA9IGZpcnN0OwogIGxvZGFzaC5sYXN0ID0gbGFzdDsKCiAgLy8gYWRkIGFsaWFzZXMKICBsb2Rhc2gudGFrZSA9IGZpcnN0OwogIGxvZGFzaC5oZWFkID0gZmlyc3Q7CgogIGZvck93bihsb2Rhc2gsIGZ1bmN0aW9uKGZ1bmMsIG1ldGhvZE5hbWUpIHsKICAgIGlmICghbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSkgewogICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdPSBmdW5jdGlvbihjYWxsYmFjaywgdGhpc0FyZykgewogICAgICAgIHZhciByZXN1bHQgPSBmdW5jKHRoaXMuX193cmFwcGVkX18sIGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgICAgICByZXR1cm4gY2FsbGJhY2sgPT0gbnVsbCB8fCAodGhpc0FyZyAmJiB0eXBlb2YgY2FsbGJhY2sgIT0gJ2Z1bmN0aW9uJykKICAgICAgICAgID8gcmVzdWx0CiAgICAgICAgICA6IG5ldyBsb2Rhc2gocmVzdWx0KTsKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIFRoZSBzZW1hbnRpYyB2ZXJzaW9uIG51bWJlci4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEB0eXBlIFN0cmluZwogICAqLwogIGxvZGFzaC5WRVJTSU9OID0gJzEuMC4wLXJjLjMnOwoKICAvLyBhZGQgIkNoYWluaW5nIiBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIKICBsb2Rhc2gucHJvdG90eXBlLnRvU3RyaW5nID0gd3JhcHBlclRvU3RyaW5nOwogIGxvZGFzaC5wcm90b3R5cGUudmFsdWUgPSB3cmFwcGVyVmFsdWVPZjsKICBsb2Rhc2gucHJvdG90eXBlLnZhbHVlT2YgPSB3cmFwcGVyVmFsdWVPZjsKCiAgLy8gYWRkIGBBcnJheWAgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIHVud3JhcHBlZCB2YWx1ZXMKICBlYWNoKFsnam9pbicsICdwb3AnLCAnc2hpZnQnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgdmFyIGZ1bmMgPSBhcnJheVJlZlttZXRob2ROYW1lXTsKICAgIGxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcy5fX3dyYXBwZWRfXywgYXJndW1lbnRzKTsKICAgIH07CiAgfSk7CgogIC8vIGFkZCBgQXJyYXlgIGZ1bmN0aW9ucyB0aGF0IHJldHVybiB0aGUgd3JhcHBlZCB2YWx1ZQogIGVhY2goWydwdXNoJywgJ3JldmVyc2UnLCAnc29ydCcsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgIHZhciBmdW5jID0gYXJyYXlSZWZbbWV0aG9kTmFtZV07CiAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgIGZ1bmMuYXBwbHkodGhpcy5fX3dyYXBwZWRfXywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogIH0pOwoKICAvLyBhZGQgYEFycmF5YCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gbmV3IHdyYXBwZWQgdmFsdWVzCiAgZWFjaChbJ2NvbmNhdCcsICdzbGljZScsICdzcGxpY2UnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgdmFyIGZ1bmMgPSBhcnJheVJlZlttZXRob2ROYW1lXTsKICAgIGxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyBsb2Rhc2goZnVuYy5hcHBseSh0aGlzLl9fd3JhcHBlZF9fLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CgogIC8vIGF2b2lkIGFycmF5LWxpa2Ugb2JqZWN0IGJ1Z3Mgd2l0aCBgQXJyYXkjc2hpZnRgIGFuZCBgQXJyYXkjc3BsaWNlYAogIC8vIGluIEZpcmVmb3ggPCAxMCBhbmQgSUUgPCA5CiAgaWYgKGhhc09iamVjdFNwbGljZUJ1ZykgewogICAgZWFjaChbJ3BvcCcsICdzaGlmdCcsICdzcGxpY2UnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICB2YXIgZnVuYyA9IGFycmF5UmVmW21ldGhvZE5hbWVdLAogICAgICAgICAgaXNTcGxpY2UgPSBtZXRob2ROYW1lID09ICdzcGxpY2UnOwoKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuX193cmFwcGVkX18sCiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodmFsdWUsIGFyZ3VtZW50cyk7CgogICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICAgIGRlbGV0ZSB2YWx1ZVswXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzU3BsaWNlID8gbmV3IGxvZGFzaChyZXN1bHQpIDogcmVzdWx0OwogICAgICB9OwogICAgfSk7CiAgfQoKICAvLyBhZGQgcHNldWRvIHByaXZhdGUgcHJvcGVydHkgdG8gYmUgdXNlZCBhbmQgcmVtb3ZlZCBkdXJpbmcgdGhlIGJ1aWxkIHByb2Nlc3MKICBsb2Rhc2guX2VhY2ggPSBlYWNoOwogIGxvZGFzaC5faXRlcmF0b3JUZW1wbGF0ZSA9IGl0ZXJhdG9yVGVtcGxhdGU7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvLyBleHBvc2UgTG8tRGFzaAogIC8vIHNvbWUgQU1EIGJ1aWxkIG9wdGltaXplcnMsIGxpa2Ugci5qcywgY2hlY2sgZm9yIHNwZWNpZmljIGNvbmRpdGlvbiBwYXR0ZXJucyBsaWtlIHRoZSBmb2xsb3dpbmc6CiAgaWYgKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgZGVmaW5lLmFtZCA9PSAnb2JqZWN0JyAmJiBkZWZpbmUuYW1kKSB7CiAgICAvLyBFeHBvc2UgTG8tRGFzaCB0byB0aGUgZ2xvYmFsIG9iamVjdCBldmVuIHdoZW4gYW4gQU1EIGxvYWRlciBpcyBwcmVzZW50IGluCiAgICAvLyBjYXNlIExvLURhc2ggd2FzIGluamVjdGVkIGJ5IGEgdGhpcmQtcGFydHkgc2NyaXB0IGFuZCBub3QgaW50ZW5kZWQgdG8gYmUKICAgIC8vIGxvYWRlZCBhcyBhIG1vZHVsZS4gVGhlIGdsb2JhbCBhc3NpZ25tZW50IGNhbiBiZSByZXZlcnRlZCBpbiB0aGUgTG8tRGFzaAogICAgLy8gbW9kdWxlIHZpYSBpdHMgYG5vQ29uZmxpY3QoKWAgbWV0aG9kLgogICAgd2luZG93Ll8gPSBsb2Rhc2g7CgogICAgLy8gZGVmaW5lIGFzIGFuIGFub255bW91cyBtb2R1bGUgc28sIHRocm91Z2ggcGF0aCBtYXBwaW5nLCBpdCBjYW4gYmUKICAgIC8vIHJlZmVyZW5jZWQgYXMgdGhlICJ1bmRlcnNjb3JlIiBtb2R1bGUKICAgIGRlZmluZSgnbG9kYXNoJyxbXSxmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGxvZGFzaDsKICAgIH0pOwogIH0KICAvLyBjaGVjayBmb3IgYGV4cG9ydHNgIGFmdGVyIGBkZWZpbmVgIGluIGNhc2UgYSBidWlsZCBvcHRpbWl6ZXIgYWRkcyBhbiBgZXhwb3J0c2Agb2JqZWN0CiAgZWxzZSBpZiAoZnJlZUV4cG9ydHMpIHsKICAgIC8vIGluIE5vZGUuanMgb3IgUmluZ29KUyB2MC44LjArCiAgICBpZiAodHlwZW9mIG1vZHVsZSA9PSAnb2JqZWN0JyAmJiBtb2R1bGUgJiYgbW9kdWxlLmV4cG9ydHMgPT0gZnJlZUV4cG9ydHMpIHsKICAgICAgKG1vZHVsZS5leHBvcnRzID0gbG9kYXNoKS5fID0gbG9kYXNoOwogICAgfQogICAgLy8gaW4gTmFyd2hhbCBvciBSaW5nb0pTIHYwLjcuMC0KICAgIGVsc2UgewogICAgICBmcmVlRXhwb3J0cy5fID0gbG9kYXNoOwogICAgfQogIH0KICBlbHNlIHsKICAgIC8vIGluIGEgYnJvd3NlciBvciBSaGlubwogICAgd2luZG93Ll8gPSBsb2Rhc2g7CiAgfQp9KHRoaXMpKTsKCi8vICBVbmRlcnNjb3JlLnN0cmluZwovLyAgKGMpIDIwMTAgRXNhLU1hdHRpIFN1dXJvbmVuIDxlc2EtbWF0dGkgYWV0IHN1dXJvbmVuIGRvdCBvcmc+Ci8vICBVbmRlcnNjb3JlLnN0cmluZyBpcyBmcmVlbHkgZGlzdHJpYnV0YWJsZSB1bmRlciB0aGUgdGVybXMgb2YgdGhlIE1JVCBsaWNlbnNlLgovLyAgRG9jdW1lbnRhdGlvbjogaHR0cHM6Ly9naXRodWIuY29tL2VwZWxpL3VuZGVyc2NvcmUuc3RyaW5nCi8vICBTb21lIGNvZGUgaXMgYm9ycm93ZWQgZnJvbSBNb29Ub29scyBhbmQgQWxleGFuZHJ1IE1hcmFzdGVhbnUuCi8vICBWZXJzaW9uICcyLjMuMScKCiFmdW5jdGlvbihyb290LCBTdHJpbmcpewogIAoKICAvLyBEZWZpbmluZyBoZWxwZXIgZnVuY3Rpb25zLgoKICB2YXIgbmF0aXZlVHJpbSA9IFN0cmluZy5wcm90b3R5cGUudHJpbTsKICB2YXIgbmF0aXZlVHJpbVJpZ2h0ID0gU3RyaW5nLnByb3RvdHlwZS50cmltUmlnaHQ7CiAgdmFyIG5hdGl2ZVRyaW1MZWZ0ID0gU3RyaW5nLnByb3RvdHlwZS50cmltTGVmdDsKCiAgdmFyIHBhcnNlTnVtYmVyID0gZnVuY3Rpb24oc291cmNlKSB7IHJldHVybiBzb3VyY2UgKiAxIHx8IDA7IH07CgogIHZhciBzdHJSZXBlYXQgPSBmdW5jdGlvbihzdHIsIHF0eSl7CiAgICBpZiAocXR5IDwgMSkgcmV0dXJuICcnOwogICAgdmFyIHJlc3VsdCA9ICcnOwogICAgd2hpbGUgKHF0eSA+IDApIHsKICAgICAgaWYgKHF0eSAmIDEpIHJlc3VsdCArPSBzdHI7CiAgICAgIHF0eSA+Pj0gMSwgc3RyICs9IHN0cjsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgdmFyIHNsaWNlID0gW10uc2xpY2U7CgogIHZhciBkZWZhdWx0VG9XaGl0ZVNwYWNlID0gZnVuY3Rpb24oY2hhcmFjdGVycykgewogICAgaWYgKGNoYXJhY3RlcnMgPT0gbnVsbCkKICAgICAgcmV0dXJuICdcXHMnOwogICAgZWxzZSBpZiAoY2hhcmFjdGVycy5zb3VyY2UpCiAgICAgIHJldHVybiBjaGFyYWN0ZXJzLnNvdXJjZTsKICAgIGVsc2UKICAgICAgcmV0dXJuICdbJyArIF9zLmVzY2FwZVJlZ0V4cChjaGFyYWN0ZXJzKSArICddJzsKICB9OwoKICB2YXIgZXNjYXBlQ2hhcnMgPSB7CiAgICBsdDogJzwnLAogICAgZ3Q6ICc+JywKICAgIHF1b3Q6ICciJywKICAgIGFtcDogJyYnLAogICAgYXBvczogIiciCiAgfTsKCiAgdmFyIHJldmVyc2VkRXNjYXBlQ2hhcnMgPSB7fTsKICBmb3IodmFyIGtleSBpbiBlc2NhcGVDaGFycykgcmV2ZXJzZWRFc2NhcGVDaGFyc1tlc2NhcGVDaGFyc1trZXldXSA9IGtleTsKICByZXZlcnNlZEVzY2FwZUNoYXJzWyInIl0gPSAnIzM5JzsKCiAgLy8gc3ByaW50ZigpIGZvciBKYXZhU2NyaXB0IDAuNy1iZXRhMQogIC8vIGh0dHA6Ly93d3cuZGl2ZWludG9qYXZhc2NyaXB0LmNvbS9wcm9qZWN0cy9qYXZhc2NyaXB0LXNwcmludGYKICAvLwogIC8vIENvcHlyaWdodCAoYykgQWxleGFuZHJ1IE1hcmFzdGVhbnUgPGFsZXhhaG9saWMgW2F0KSBnbWFpbCAoZG90XSBjb20+CiAgLy8gQWxsIHJpZ2h0cyByZXNlcnZlZC4KCiAgdmFyIHNwcmludGYgPSAoZnVuY3Rpb24oKSB7CiAgICBmdW5jdGlvbiBnZXRfdHlwZSh2YXJpYWJsZSkgewogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhcmlhYmxlKS5zbGljZSg4LCAtMSkudG9Mb3dlckNhc2UoKTsKICAgIH0KCiAgICB2YXIgc3RyX3JlcGVhdCA9IHN0clJlcGVhdDsKCiAgICB2YXIgc3RyX2Zvcm1hdCA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXN0cl9mb3JtYXQuY2FjaGUuaGFzT3duUHJvcGVydHkoYXJndW1lbnRzWzBdKSkgewogICAgICAgIHN0cl9mb3JtYXQuY2FjaGVbYXJndW1lbnRzWzBdXSA9IHN0cl9mb3JtYXQucGFyc2UoYXJndW1lbnRzWzBdKTsKICAgICAgfQogICAgICByZXR1cm4gc3RyX2Zvcm1hdC5mb3JtYXQuY2FsbChudWxsLCBzdHJfZm9ybWF0LmNhY2hlW2FyZ3VtZW50c1swXV0sIGFyZ3VtZW50cyk7CiAgICB9OwoKICAgIHN0cl9mb3JtYXQuZm9ybWF0ID0gZnVuY3Rpb24ocGFyc2VfdHJlZSwgYXJndikgewogICAgICB2YXIgY3Vyc29yID0gMSwgdHJlZV9sZW5ndGggPSBwYXJzZV90cmVlLmxlbmd0aCwgbm9kZV90eXBlID0gJycsIGFyZywgb3V0cHV0ID0gW10sIGksIGssIG1hdGNoLCBwYWQsIHBhZF9jaGFyYWN0ZXIsIHBhZF9sZW5ndGg7CiAgICAgIGZvciAoaSA9IDA7IGkgPCB0cmVlX2xlbmd0aDsgaSsrKSB7CiAgICAgICAgbm9kZV90eXBlID0gZ2V0X3R5cGUocGFyc2VfdHJlZVtpXSk7CiAgICAgICAgaWYgKG5vZGVfdHlwZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIG91dHB1dC5wdXNoKHBhcnNlX3RyZWVbaV0pOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChub2RlX3R5cGUgPT09ICdhcnJheScpIHsKICAgICAgICAgIG1hdGNoID0gcGFyc2VfdHJlZVtpXTsgLy8gY29udmVuaWVuY2UgcHVycG9zZXMgb25seQogICAgICAgICAgaWYgKG1hdGNoWzJdKSB7IC8vIGtleXdvcmQgYXJndW1lbnQKICAgICAgICAgICAgYXJnID0gYXJndltjdXJzb3JdOwogICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgbWF0Y2hbMl0ubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICBpZiAoIWFyZy5oYXNPd25Qcm9wZXJ0eShtYXRjaFsyXVtrXSkpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihzcHJpbnRmKCdbXy5zcHJpbnRmXSBwcm9wZXJ0eSAiJXMiIGRvZXMgbm90IGV4aXN0JywgbWF0Y2hbMl1ba10pKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXJnID0gYXJnW21hdGNoWzJdW2tdXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChtYXRjaFsxXSkgeyAvLyBwb3NpdGlvbmFsIGFyZ3VtZW50IChleHBsaWNpdCkKICAgICAgICAgICAgYXJnID0gYXJndlttYXRjaFsxXV07CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsgLy8gcG9zaXRpb25hbCBhcmd1bWVudCAoaW1wbGljaXQpCiAgICAgICAgICAgIGFyZyA9IGFyZ3ZbY3Vyc29yKytdOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICgvW15zXS8udGVzdChtYXRjaFs4XSkgJiYgKGdldF90eXBlKGFyZykgIT0gJ251bWJlcicpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihzcHJpbnRmKCdbXy5zcHJpbnRmXSBleHBlY3RpbmcgbnVtYmVyIGJ1dCBmb3VuZCAlcycsIGdldF90eXBlKGFyZykpKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAobWF0Y2hbOF0pIHsKICAgICAgICAgICAgY2FzZSAnYic6IGFyZyA9IGFyZy50b1N0cmluZygyKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2MnOiBhcmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGFyZyk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdkJzogYXJnID0gcGFyc2VJbnQoYXJnLCAxMCk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdlJzogYXJnID0gbWF0Y2hbN10gPyBhcmcudG9FeHBvbmVudGlhbChtYXRjaFs3XSkgOiBhcmcudG9FeHBvbmVudGlhbCgpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnZic6IGFyZyA9IG1hdGNoWzddID8gcGFyc2VGbG9hdChhcmcpLnRvRml4ZWQobWF0Y2hbN10pIDogcGFyc2VGbG9hdChhcmcpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnbyc6IGFyZyA9IGFyZy50b1N0cmluZyg4KTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3MnOiBhcmcgPSAoKGFyZyA9IFN0cmluZyhhcmcpKSAmJiBtYXRjaFs3XSA/IGFyZy5zdWJzdHJpbmcoMCwgbWF0Y2hbN10pIDogYXJnKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3UnOiBhcmcgPSBNYXRoLmFicyhhcmcpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAneCc6IGFyZyA9IGFyZy50b1N0cmluZygxNik7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdYJzogYXJnID0gYXJnLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpOyBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGFyZyA9ICgvW2RlZl0vLnRlc3QobWF0Y2hbOF0pICYmIG1hdGNoWzNdICYmIGFyZyA+PSAwID8gJysnKyBhcmcgOiBhcmcpOwogICAgICAgICAgcGFkX2NoYXJhY3RlciA9IG1hdGNoWzRdID8gbWF0Y2hbNF0gPT0gJzAnID8gJzAnIDogbWF0Y2hbNF0uY2hhckF0KDEpIDogJyAnOwogICAgICAgICAgcGFkX2xlbmd0aCA9IG1hdGNoWzZdIC0gU3RyaW5nKGFyZykubGVuZ3RoOwogICAgICAgICAgcGFkID0gbWF0Y2hbNl0gPyBzdHJfcmVwZWF0KHBhZF9jaGFyYWN0ZXIsIHBhZF9sZW5ndGgpIDogJyc7CiAgICAgICAgICBvdXRwdXQucHVzaChtYXRjaFs1XSA/IGFyZyArIHBhZCA6IHBhZCArIGFyZyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvdXRwdXQuam9pbignJyk7CiAgICB9OwoKICAgIHN0cl9mb3JtYXQuY2FjaGUgPSB7fTsKCiAgICBzdHJfZm9ybWF0LnBhcnNlID0gZnVuY3Rpb24oZm10KSB7CiAgICAgIHZhciBfZm10ID0gZm10LCBtYXRjaCA9IFtdLCBwYXJzZV90cmVlID0gW10sIGFyZ19uYW1lcyA9IDA7CiAgICAgIHdoaWxlIChfZm10KSB7CiAgICAgICAgaWYgKChtYXRjaCA9IC9eW15ceDI1XSsvLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CiAgICAgICAgICBwYXJzZV90cmVlLnB1c2gobWF0Y2hbMF0pOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgobWF0Y2ggPSAvXlx4MjV7Mn0vLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CiAgICAgICAgICBwYXJzZV90cmVlLnB1c2goJyUnKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoKG1hdGNoID0gL15ceDI1KD86KFsxLTldXGQqKVwkfFwoKFteXCldKylcKSk/KFwrKT8oMHwnW14kXSk/KC0pPyhcZCspPyg/OlwuKFxkKykpPyhbYi1mb3N1eFhdKS8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKICAgICAgICAgIGlmIChtYXRjaFsyXSkgewogICAgICAgICAgICBhcmdfbmFtZXMgfD0gMTsKICAgICAgICAgICAgdmFyIGZpZWxkX2xpc3QgPSBbXSwgcmVwbGFjZW1lbnRfZmllbGQgPSBtYXRjaFsyXSwgZmllbGRfbWF0Y2ggPSBbXTsKICAgICAgICAgICAgaWYgKChmaWVsZF9tYXRjaCA9IC9eKFthLXpfXVthLXpfXGRdKikvaS5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwogICAgICAgICAgICAgIHdoaWxlICgocmVwbGFjZW1lbnRfZmllbGQgPSByZXBsYWNlbWVudF9maWVsZC5zdWJzdHJpbmcoZmllbGRfbWF0Y2hbMF0ubGVuZ3RoKSkgIT09ICcnKSB7CiAgICAgICAgICAgICAgICBpZiAoKGZpZWxkX21hdGNoID0gL15cLihbYS16X11bYS16X1xkXSopL2kuZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICgoZmllbGRfbWF0Y2ggPSAvXlxbKFxkKylcXS8uZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdbXy5zcHJpbnRmXSBodWg/Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignW18uc3ByaW50Zl0gaHVoPycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hdGNoWzJdID0gZmllbGRfbGlzdDsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICBhcmdfbmFtZXMgfD0gMjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhcmdfbmFtZXMgPT09IDMpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdbXy5zcHJpbnRmXSBtaXhpbmcgcG9zaXRpb25hbCBhbmQgbmFtZWQgcGxhY2Vob2xkZXJzIGlzIG5vdCAoeWV0KSBzdXBwb3J0ZWQnKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhcnNlX3RyZWUucHVzaChtYXRjaCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdbXy5zcHJpbnRmXSBodWg/Jyk7CiAgICAgICAgfQogICAgICAgIF9mbXQgPSBfZm10LnN1YnN0cmluZyhtYXRjaFswXS5sZW5ndGgpOwogICAgICB9CiAgICAgIHJldHVybiBwYXJzZV90cmVlOwogICAgfTsKCiAgICByZXR1cm4gc3RyX2Zvcm1hdDsKICB9KSgpOwoKCgogIC8vIERlZmluaW5nIHVuZGVyc2NvcmUuc3RyaW5nCgogIHZhciBfcyA9IHsKCiAgICBWRVJTSU9OOiAnMi4zLjEnLAoKICAgIGlzQmxhbms6IGZ1bmN0aW9uKHN0cil7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgc3RyID0gJyc7CiAgICAgIHJldHVybiAoL15ccyokLykudGVzdChzdHIpOwogICAgfSwKCiAgICBzdHJpcFRhZ3M6IGZ1bmN0aW9uKHN0cil7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikucmVwbGFjZSgvPFwvP1tePl0rPi9nLCAnJyk7CiAgICB9LAoKICAgIGNhcGl0YWxpemUgOiBmdW5jdGlvbihzdHIpewogICAgICBzdHIgPSBzdHIgPT0gbnVsbCA/ICcnIDogU3RyaW5nKHN0cik7CiAgICAgIHJldHVybiBzdHIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc2xpY2UoMSk7CiAgICB9LAoKICAgIGNob3A6IGZ1bmN0aW9uKHN0ciwgc3RlcCl7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuIFtdOwogICAgICBzdHIgPSBTdHJpbmcoc3RyKTsKICAgICAgc3RlcCA9IH5+c3RlcDsKICAgICAgcmV0dXJuIHN0ZXAgPiAwID8gc3RyLm1hdGNoKG5ldyBSZWdFeHAoJy57MSwnICsgc3RlcCArICd9JywgJ2cnKSkgOiBbc3RyXTsKICAgIH0sCgogICAgY2xlYW46IGZ1bmN0aW9uKHN0cil7CiAgICAgIHJldHVybiBfcy5zdHJpcChzdHIpLnJlcGxhY2UoL1xzKy9nLCAnICcpOwogICAgfSwKCiAgICBjb3VudDogZnVuY3Rpb24oc3RyLCBzdWJzdHIpewogICAgICBpZiAoc3RyID09IG51bGwgfHwgc3Vic3RyID09IG51bGwpIHJldHVybiAwOwoKICAgICAgc3RyID0gU3RyaW5nKHN0cik7CiAgICAgIHN1YnN0ciA9IFN0cmluZyhzdWJzdHIpOwoKICAgICAgdmFyIGNvdW50ID0gMCwKICAgICAgICBwb3MgPSAwLAogICAgICAgIGxlbmd0aCA9IHN1YnN0ci5sZW5ndGg7CgogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIHBvcyA9IHN0ci5pbmRleE9mKHN1YnN0ciwgcG9zKTsKICAgICAgICBpZiAocG9zID09PSAtMSkgYnJlYWs7CiAgICAgICAgY291bnQrKzsKICAgICAgICBwb3MgKz0gbGVuZ3RoOwogICAgICB9CgogICAgICByZXR1cm4gY291bnQ7CiAgICB9LAoKICAgIGNoYXJzOiBmdW5jdGlvbihzdHIpIHsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gW107CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5zcGxpdCgnJyk7CiAgICB9LAoKICAgIHN3YXBDYXNlOiBmdW5jdGlvbihzdHIpIHsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKC9cUy9nLCBmdW5jdGlvbihjKXsKICAgICAgICByZXR1cm4gYyA9PT0gYy50b1VwcGVyQ2FzZSgpID8gYy50b0xvd2VyQ2FzZSgpIDogYy50b1VwcGVyQ2FzZSgpOwogICAgICB9KTsKICAgIH0sCgogICAgZXNjYXBlSFRNTDogZnVuY3Rpb24oc3RyKSB7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikucmVwbGFjZSgvWyY8PiInXS9nLCBmdW5jdGlvbihtKXsgcmV0dXJuICcmJyArIHJldmVyc2VkRXNjYXBlQ2hhcnNbbV0gKyAnOyc7IH0pOwogICAgfSwKCiAgICB1bmVzY2FwZUhUTUw6IGZ1bmN0aW9uKHN0cikgewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UoL1wmKFteO10rKTsvZywgZnVuY3Rpb24oZW50aXR5LCBlbnRpdHlDb2RlKXsKICAgICAgICB2YXIgbWF0Y2g7CgogICAgICAgIGlmIChlbnRpdHlDb2RlIGluIGVzY2FwZUNoYXJzKSB7CiAgICAgICAgICByZXR1cm4gZXNjYXBlQ2hhcnNbZW50aXR5Q29kZV07CiAgICAgICAgfSBlbHNlIGlmIChtYXRjaCA9IGVudGl0eUNvZGUubWF0Y2goL14jeChbXGRhLWZBLUZdKykkLykpIHsKICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KG1hdGNoWzFdLCAxNikpOwogICAgICAgIH0gZWxzZSBpZiAobWF0Y2ggPSBlbnRpdHlDb2RlLm1hdGNoKC9eIyhcZCspJC8pKSB7CiAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSh+fm1hdGNoWzFdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGVudGl0eTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICBlc2NhcGVSZWdFeHA6IGZ1bmN0aW9uKHN0cil7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikucmVwbGFjZSgvKFsuKis/Xj0hOiR7fSgpfFtcXVwvXFxdKS9nLCAnXFwkMScpOwogICAgfSwKCiAgICBzcGxpY2U6IGZ1bmN0aW9uKHN0ciwgaSwgaG93bWFueSwgc3Vic3RyKXsKICAgICAgdmFyIGFyciA9IF9zLmNoYXJzKHN0cik7CiAgICAgIGFyci5zcGxpY2Uofn5pLCB+fmhvd21hbnksIHN1YnN0cik7CiAgICAgIHJldHVybiBhcnIuam9pbignJyk7CiAgICB9LAoKICAgIGluc2VydDogZnVuY3Rpb24oc3RyLCBpLCBzdWJzdHIpewogICAgICByZXR1cm4gX3Muc3BsaWNlKHN0ciwgaSwgMCwgc3Vic3RyKTsKICAgIH0sCgogICAgaW5jbHVkZTogZnVuY3Rpb24oc3RyLCBuZWVkbGUpewogICAgICBpZiAobmVlZGxlID09PSAnJykgcmV0dXJuIHRydWU7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikuaW5kZXhPZihuZWVkbGUpICE9PSAtMTsKICAgIH0sCgogICAgam9pbjogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpLAogICAgICAgIHNlcGFyYXRvciA9IGFyZ3Muc2hpZnQoKTsKCiAgICAgIGlmIChzZXBhcmF0b3IgPT0gbnVsbCkgc2VwYXJhdG9yID0gJyc7CgogICAgICByZXR1cm4gYXJncy5qb2luKHNlcGFyYXRvcik7CiAgICB9LAoKICAgIGxpbmVzOiBmdW5jdGlvbihzdHIpIHsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gW107CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5zcGxpdCgiXG4iKTsKICAgIH0sCgogICAgcmV2ZXJzZTogZnVuY3Rpb24oc3RyKXsKICAgICAgcmV0dXJuIF9zLmNoYXJzKHN0cikucmV2ZXJzZSgpLmpvaW4oJycpOwogICAgfSwKCiAgICBzdGFydHNXaXRoOiBmdW5jdGlvbihzdHIsIHN0YXJ0cyl7CiAgICAgIGlmIChzdGFydHMgPT09ICcnKSByZXR1cm4gdHJ1ZTsKICAgICAgaWYgKHN0ciA9PSBudWxsIHx8IHN0YXJ0cyA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOyBzdGFydHMgPSBTdHJpbmcoc3RhcnRzKTsKICAgICAgcmV0dXJuIHN0ci5sZW5ndGggPj0gc3RhcnRzLmxlbmd0aCAmJiBzdHIuc2xpY2UoMCwgc3RhcnRzLmxlbmd0aCkgPT09IHN0YXJ0czsKICAgIH0sCgogICAgZW5kc1dpdGg6IGZ1bmN0aW9uKHN0ciwgZW5kcyl7CiAgICAgIGlmIChlbmRzID09PSAnJykgcmV0dXJuIHRydWU7CiAgICAgIGlmIChzdHIgPT0gbnVsbCB8fCBlbmRzID09IG51bGwpIHJldHVybiBmYWxzZTsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7IGVuZHMgPSBTdHJpbmcoZW5kcyk7CiAgICAgIHJldHVybiBzdHIubGVuZ3RoID49IGVuZHMubGVuZ3RoICYmIHN0ci5zbGljZShzdHIubGVuZ3RoIC0gZW5kcy5sZW5ndGgpID09PSBlbmRzOwogICAgfSwKCiAgICBzdWNjOiBmdW5jdGlvbihzdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7CiAgICAgIHJldHVybiBzdHIuc2xpY2UoMCwgLTEpICsgU3RyaW5nLmZyb21DaGFyQ29kZShzdHIuY2hhckNvZGVBdChzdHIubGVuZ3RoLTEpICsgMSk7CiAgICB9LAoKICAgIHRpdGxlaXplOiBmdW5jdGlvbihzdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UoLyg/Ol58XHMpXFMvZywgZnVuY3Rpb24oYyl7IHJldHVybiBjLnRvVXBwZXJDYXNlKCk7IH0pOwogICAgfSwKCiAgICBjYW1lbGl6ZTogZnVuY3Rpb24oc3RyKXsKICAgICAgcmV0dXJuIF9zLnRyaW0oc3RyKS5yZXBsYWNlKC9bLV9cc10rKC4pPy9nLCBmdW5jdGlvbihtYXRjaCwgYyl7IHJldHVybiBjLnRvVXBwZXJDYXNlKCk7IH0pOwogICAgfSwKCiAgICB1bmRlcnNjb3JlZDogZnVuY3Rpb24oc3RyKXsKICAgICAgcmV0dXJuIF9zLnRyaW0oc3RyKS5yZXBsYWNlKC8oW2EtelxkXSkoW0EtWl0rKS9nLCAnJDFfJDInKS5yZXBsYWNlKC9bLVxzXSsvZywgJ18nKS50b0xvd2VyQ2FzZSgpOwogICAgfSwKCiAgICBkYXNoZXJpemU6IGZ1bmN0aW9uKHN0cil7CiAgICAgIHJldHVybiBfcy50cmltKHN0cikucmVwbGFjZSgvKFtBLVpdKS9nLCAnLSQxJykucmVwbGFjZSgvWy1fXHNdKy9nLCAnLScpLnRvTG93ZXJDYXNlKCk7CiAgICB9LAoKICAgIGNsYXNzaWZ5OiBmdW5jdGlvbihzdHIpewogICAgICByZXR1cm4gX3MudGl0bGVpemUoU3RyaW5nKHN0cikucmVwbGFjZSgvW1xXX10vZywgJyAnKSkucmVwbGFjZSgvXHMvZywgJycpOwogICAgfSwKCiAgICBodW1hbml6ZTogZnVuY3Rpb24oc3RyKXsKICAgICAgcmV0dXJuIF9zLmNhcGl0YWxpemUoX3MudW5kZXJzY29yZWQoc3RyKS5yZXBsYWNlKC9faWQkLywnJykucmVwbGFjZSgvXy9nLCAnICcpKTsKICAgIH0sCgogICAgdHJpbTogZnVuY3Rpb24oc3RyLCBjaGFyYWN0ZXJzKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIGlmICghY2hhcmFjdGVycyAmJiBuYXRpdmVUcmltKSByZXR1cm4gbmF0aXZlVHJpbS5jYWxsKHN0cik7CiAgICAgIGNoYXJhY3RlcnMgPSBkZWZhdWx0VG9XaGl0ZVNwYWNlKGNoYXJhY3RlcnMpOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikucmVwbGFjZShuZXcgUmVnRXhwKCdcXicgKyBjaGFyYWN0ZXJzICsgJyt8JyArIGNoYXJhY3RlcnMgKyAnKyQnLCAnZycpLCAnJyk7CiAgICB9LAoKICAgIGx0cmltOiBmdW5jdGlvbihzdHIsIGNoYXJhY3RlcnMpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgaWYgKCFjaGFyYWN0ZXJzICYmIG5hdGl2ZVRyaW1MZWZ0KSByZXR1cm4gbmF0aXZlVHJpbUxlZnQuY2FsbChzdHIpOwogICAgICBjaGFyYWN0ZXJzID0gZGVmYXVsdFRvV2hpdGVTcGFjZShjaGFyYWN0ZXJzKTsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UobmV3IFJlZ0V4cCgnXicgKyBjaGFyYWN0ZXJzICsgJysnKSwgJycpOwogICAgfSwKCiAgICBydHJpbTogZnVuY3Rpb24oc3RyLCBjaGFyYWN0ZXJzKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIGlmICghY2hhcmFjdGVycyAmJiBuYXRpdmVUcmltUmlnaHQpIHJldHVybiBuYXRpdmVUcmltUmlnaHQuY2FsbChzdHIpOwogICAgICBjaGFyYWN0ZXJzID0gZGVmYXVsdFRvV2hpdGVTcGFjZShjaGFyYWN0ZXJzKTsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UobmV3IFJlZ0V4cChjaGFyYWN0ZXJzICsgJyskJyksICcnKTsKICAgIH0sCgogICAgdHJ1bmNhdGU6IGZ1bmN0aW9uKHN0ciwgbGVuZ3RoLCB0cnVuY2F0ZVN0cil7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICBzdHIgPSBTdHJpbmcoc3RyKTsgdHJ1bmNhdGVTdHIgPSB0cnVuY2F0ZVN0ciB8fCAnLi4uJzsKICAgICAgbGVuZ3RoID0gfn5sZW5ndGg7CiAgICAgIHJldHVybiBzdHIubGVuZ3RoID4gbGVuZ3RoID8gc3RyLnNsaWNlKDAsIGxlbmd0aCkgKyB0cnVuY2F0ZVN0ciA6IHN0cjsKICAgIH0sCgogICAgLyoqCiAgICAgKiBfcy5wcnVuZTogYSBtb3JlIGVsZWdhbnQgdmVyc2lvbiBvZiB0cnVuY2F0ZQogICAgICogcHJ1bmUgZXh0cmEgY2hhcnMsIG5ldmVyIGxlYXZpbmcgYSBoYWxmLWNob3BwZWQgd29yZC4KICAgICAqIEBhdXRob3IgZ2l0aHViLmNvbS9yd3oKICAgICAqLwogICAgcHJ1bmU6IGZ1bmN0aW9uKHN0ciwgbGVuZ3RoLCBwcnVuZVN0cil7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwoKICAgICAgc3RyID0gU3RyaW5nKHN0cik7IGxlbmd0aCA9IH5+bGVuZ3RoOwogICAgICBwcnVuZVN0ciA9IHBydW5lU3RyICE9IG51bGwgPyBTdHJpbmcocHJ1bmVTdHIpIDogJy4uLic7CgogICAgICBpZiAoc3RyLmxlbmd0aCA8PSBsZW5ndGgpIHJldHVybiBzdHI7CgogICAgICB2YXIgdG1wbCA9IGZ1bmN0aW9uKGMpeyByZXR1cm4gYy50b1VwcGVyQ2FzZSgpICE9PSBjLnRvTG93ZXJDYXNlKCkgPyAnQScgOiAnICc7IH0sCiAgICAgICAgdGVtcGxhdGUgPSBzdHIuc2xpY2UoMCwgbGVuZ3RoKzEpLnJlcGxhY2UoLy4oPz1cVypcdyokKS9nLCB0bXBsKTsgLy8gJ0hlbGxvLCB3b3JsZCcgLT4gJ0hlbGxBQSBBQUFBQScKCiAgICAgIGlmICh0ZW1wbGF0ZS5zbGljZSh0ZW1wbGF0ZS5sZW5ndGgtMikubWF0Y2goL1x3XHcvKSkKICAgICAgICB0ZW1wbGF0ZSA9IHRlbXBsYXRlLnJlcGxhY2UoL1xzKlxTKyQvLCAnJyk7CiAgICAgIGVsc2UKICAgICAgICB0ZW1wbGF0ZSA9IF9zLnJ0cmltKHRlbXBsYXRlLnNsaWNlKDAsIHRlbXBsYXRlLmxlbmd0aC0xKSk7CgogICAgICByZXR1cm4gKHRlbXBsYXRlK3BydW5lU3RyKS5sZW5ndGggPiBzdHIubGVuZ3RoID8gc3RyIDogc3RyLnNsaWNlKDAsIHRlbXBsYXRlLmxlbmd0aCkrcHJ1bmVTdHI7CiAgICB9LAoKICAgIHdvcmRzOiBmdW5jdGlvbihzdHIsIGRlbGltaXRlcikgewogICAgICBpZiAoX3MuaXNCbGFuayhzdHIpKSByZXR1cm4gW107CiAgICAgIHJldHVybiBfcy50cmltKHN0ciwgZGVsaW1pdGVyKS5zcGxpdChkZWxpbWl0ZXIgfHwgL1xzKy8pOwogICAgfSwKCiAgICBwYWQ6IGZ1bmN0aW9uKHN0ciwgbGVuZ3RoLCBwYWRTdHIsIHR5cGUpIHsKICAgICAgc3RyID0gc3RyID09IG51bGwgPyAnJyA6IFN0cmluZyhzdHIpOwogICAgICBsZW5ndGggPSB+fmxlbmd0aDsKCiAgICAgIHZhciBwYWRsZW4gID0gMDsKCiAgICAgIGlmICghcGFkU3RyKQogICAgICAgIHBhZFN0ciA9ICcgJzsKICAgICAgZWxzZSBpZiAocGFkU3RyLmxlbmd0aCA+IDEpCiAgICAgICAgcGFkU3RyID0gcGFkU3RyLmNoYXJBdCgwKTsKCiAgICAgIHN3aXRjaCh0eXBlKSB7CiAgICAgICAgY2FzZSAncmlnaHQnOgogICAgICAgICAgcGFkbGVuID0gbGVuZ3RoIC0gc3RyLmxlbmd0aDsKICAgICAgICAgIHJldHVybiBzdHIgKyBzdHJSZXBlYXQocGFkU3RyLCBwYWRsZW4pOwogICAgICAgIGNhc2UgJ2JvdGgnOgogICAgICAgICAgcGFkbGVuID0gbGVuZ3RoIC0gc3RyLmxlbmd0aDsKICAgICAgICAgIHJldHVybiBzdHJSZXBlYXQocGFkU3RyLCBNYXRoLmNlaWwocGFkbGVuLzIpKSArIHN0cgogICAgICAgICAgICAgICAgICArIHN0clJlcGVhdChwYWRTdHIsIE1hdGguZmxvb3IocGFkbGVuLzIpKTsKICAgICAgICBkZWZhdWx0OiAvLyAnbGVmdCcKICAgICAgICAgIHBhZGxlbiA9IGxlbmd0aCAtIHN0ci5sZW5ndGg7CiAgICAgICAgICByZXR1cm4gc3RyUmVwZWF0KHBhZFN0ciwgcGFkbGVuKSArIHN0cjsKICAgICAgICB9CiAgICB9LAoKICAgIGxwYWQ6IGZ1bmN0aW9uKHN0ciwgbGVuZ3RoLCBwYWRTdHIpIHsKICAgICAgcmV0dXJuIF9zLnBhZChzdHIsIGxlbmd0aCwgcGFkU3RyKTsKICAgIH0sCgogICAgcnBhZDogZnVuY3Rpb24oc3RyLCBsZW5ndGgsIHBhZFN0cikgewogICAgICByZXR1cm4gX3MucGFkKHN0ciwgbGVuZ3RoLCBwYWRTdHIsICdyaWdodCcpOwogICAgfSwKCiAgICBscnBhZDogZnVuY3Rpb24oc3RyLCBsZW5ndGgsIHBhZFN0cikgewogICAgICByZXR1cm4gX3MucGFkKHN0ciwgbGVuZ3RoLCBwYWRTdHIsICdib3RoJyk7CiAgICB9LAoKICAgIHNwcmludGY6IHNwcmludGYsCgogICAgdnNwcmludGY6IGZ1bmN0aW9uKGZtdCwgYXJndil7CiAgICAgIGFyZ3YudW5zaGlmdChmbXQpOwogICAgICByZXR1cm4gc3ByaW50Zi5hcHBseShudWxsLCBhcmd2KTsKICAgIH0sCgogICAgdG9OdW1iZXI6IGZ1bmN0aW9uKHN0ciwgZGVjaW1hbHMpIHsKICAgICAgaWYgKCFzdHIpIHJldHVybiAwOwogICAgICBzdHIgPSBfcy50cmltKHN0cik7CiAgICAgIGlmICghc3RyLm1hdGNoKC9eLT9cZCsoPzpcLlxkKyk/JC8pKSByZXR1cm4gTmFOOwogICAgICByZXR1cm4gcGFyc2VOdW1iZXIocGFyc2VOdW1iZXIoc3RyKS50b0ZpeGVkKH5+ZGVjaW1hbHMpKTsKICAgIH0sCgogICAgbnVtYmVyRm9ybWF0IDogZnVuY3Rpb24obnVtYmVyLCBkZWMsIGRzZXAsIHRzZXApIHsKICAgICAgaWYgKGlzTmFOKG51bWJlcikgfHwgbnVtYmVyID09IG51bGwpIHJldHVybiAnJzsKCiAgICAgIG51bWJlciA9IG51bWJlci50b0ZpeGVkKH5+ZGVjKTsKICAgICAgdHNlcCA9IHR5cGVvZiB0c2VwID09ICdzdHJpbmcnID8gdHNlcCA6ICcsJzsKCiAgICAgIHZhciBwYXJ0cyA9IG51bWJlci5zcGxpdCgnLicpLCBmbnVtcyA9IHBhcnRzWzBdLAogICAgICAgIGRlY2ltYWxzID0gcGFydHNbMV0gPyAoZHNlcCB8fCAnLicpICsgcGFydHNbMV0gOiAnJzsKCiAgICAgIHJldHVybiBmbnVtcy5yZXBsYWNlKC8oXGQpKD89KD86XGR7M30pKyQpL2csICckMScgKyB0c2VwKSArIGRlY2ltYWxzOwogICAgfSwKCiAgICBzdHJSaWdodDogZnVuY3Rpb24oc3RyLCBzZXApewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7IHNlcCA9IHNlcCAhPSBudWxsID8gU3RyaW5nKHNlcCkgOiBzZXA7CiAgICAgIHZhciBwb3MgPSAhc2VwID8gLTEgOiBzdHIuaW5kZXhPZihzZXApOwogICAgICByZXR1cm4gfnBvcyA/IHN0ci5zbGljZShwb3Mrc2VwLmxlbmd0aCwgc3RyLmxlbmd0aCkgOiBzdHI7CiAgICB9LAoKICAgIHN0clJpZ2h0QmFjazogZnVuY3Rpb24oc3RyLCBzZXApewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7IHNlcCA9IHNlcCAhPSBudWxsID8gU3RyaW5nKHNlcCkgOiBzZXA7CiAgICAgIHZhciBwb3MgPSAhc2VwID8gLTEgOiBzdHIubGFzdEluZGV4T2Yoc2VwKTsKICAgICAgcmV0dXJuIH5wb3MgPyBzdHIuc2xpY2UocG9zK3NlcC5sZW5ndGgsIHN0ci5sZW5ndGgpIDogc3RyOwogICAgfSwKCiAgICBzdHJMZWZ0OiBmdW5jdGlvbihzdHIsIHNlcCl7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICBzdHIgPSBTdHJpbmcoc3RyKTsgc2VwID0gc2VwICE9IG51bGwgPyBTdHJpbmcoc2VwKSA6IHNlcDsKICAgICAgdmFyIHBvcyA9ICFzZXAgPyAtMSA6IHN0ci5pbmRleE9mKHNlcCk7CiAgICAgIHJldHVybiB+cG9zID8gc3RyLnNsaWNlKDAsIHBvcykgOiBzdHI7CiAgICB9LAoKICAgIHN0ckxlZnRCYWNrOiBmdW5jdGlvbihzdHIsIHNlcCl7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICBzdHIgKz0gJyc7IHNlcCA9IHNlcCAhPSBudWxsID8gJycrc2VwIDogc2VwOwogICAgICB2YXIgcG9zID0gc3RyLmxhc3RJbmRleE9mKHNlcCk7CiAgICAgIHJldHVybiB+cG9zID8gc3RyLnNsaWNlKDAsIHBvcykgOiBzdHI7CiAgICB9LAoKICAgIHRvU2VudGVuY2U6IGZ1bmN0aW9uKGFycmF5LCBzZXBhcmF0b3IsIGxhc3RTZXBhcmF0b3IsIHNlcmlhbCkgewogICAgICBzZXBhcmF0b3IgPSBzZXBhcmF0b3IgfHwgJywgJwogICAgICBsYXN0U2VwYXJhdG9yID0gbGFzdFNlcGFyYXRvciB8fCAnIGFuZCAnCiAgICAgIHZhciBhID0gYXJyYXkuc2xpY2UoKSwgbGFzdE1lbWJlciA9IGEucG9wKCk7CgogICAgICBpZiAoYXJyYXkubGVuZ3RoID4gMiAmJiBzZXJpYWwpIGxhc3RTZXBhcmF0b3IgPSBfcy5ydHJpbShzZXBhcmF0b3IpICsgbGFzdFNlcGFyYXRvcjsKCiAgICAgIHJldHVybiBhLmxlbmd0aCA/IGEuam9pbihzZXBhcmF0b3IpICsgbGFzdFNlcGFyYXRvciArIGxhc3RNZW1iZXIgOiBsYXN0TWVtYmVyOwogICAgfSwKCiAgICB0b1NlbnRlbmNlU2VyaWFsOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3NbM10gPSB0cnVlOwogICAgICByZXR1cm4gX3MudG9TZW50ZW5jZS5hcHBseShfcywgYXJncyk7CiAgICB9LAoKICAgIHNsdWdpZnk6IGZ1bmN0aW9uKHN0cikgewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKCiAgICAgIHZhciBmcm9tICA9ICLEhcOgw6HDpMOiw6PDpcOmxIfEmcOow6nDq8Oqw6zDrcOvw67FgsWEw7LDs8O2w7TDtcO4w7nDusO8w7vDscOnxbzFuiIsCiAgICAgICAgICB0byAgICA9ICJhYWFhYWFhYWNlZWVlZWlpaWlsbm9vb29vb3V1dXVuY3p6IiwKICAgICAgICAgIHJlZ2V4ID0gbmV3IFJlZ0V4cChkZWZhdWx0VG9XaGl0ZVNwYWNlKGZyb20pLCAnZycpOwoKICAgICAgc3RyID0gU3RyaW5nKHN0cikudG9Mb3dlckNhc2UoKS5yZXBsYWNlKHJlZ2V4LCBmdW5jdGlvbihjKXsKICAgICAgICB2YXIgaW5kZXggPSBmcm9tLmluZGV4T2YoYyk7CiAgICAgICAgcmV0dXJuIHRvLmNoYXJBdChpbmRleCkgfHwgJy0nOwogICAgICB9KTsKCiAgICAgIHJldHVybiBfcy5kYXNoZXJpemUoc3RyLnJlcGxhY2UoL1teXHdccy1dL2csICcnKSk7CiAgICB9LAoKICAgIHN1cnJvdW5kOiBmdW5jdGlvbihzdHIsIHdyYXBwZXIpIHsKICAgICAgcmV0dXJuIFt3cmFwcGVyLCBzdHIsIHdyYXBwZXJdLmpvaW4oJycpOwogICAgfSwKCiAgICBxdW90ZTogZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiBfcy5zdXJyb3VuZChzdHIsICciJyk7CiAgICB9LAoKICAgIGV4cG9ydHM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgcmVzdWx0ID0ge307CgogICAgICBmb3IgKHZhciBwcm9wIGluIHRoaXMpIHsKICAgICAgICBpZiAoIXRoaXMuaGFzT3duUHJvcGVydHkocHJvcCkgfHwgcHJvcC5tYXRjaCgvXig/OmluY2x1ZGV8Y29udGFpbnN8cmV2ZXJzZSkkLykpIGNvbnRpbnVlOwogICAgICAgIHJlc3VsdFtwcm9wXSA9IHRoaXNbcHJvcF07CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAoKICAgIHJlcGVhdDogZnVuY3Rpb24oc3RyLCBxdHksIHNlcGFyYXRvcil7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwoKICAgICAgcXR5ID0gfn5xdHk7CgogICAgICAvLyB1c2luZyBmYXN0ZXIgaW1wbGVtZW50YXRpb24gaWYgc2VwYXJhdG9yIGlzIG5vdCBuZWVkZWQ7CiAgICAgIGlmIChzZXBhcmF0b3IgPT0gbnVsbCkgcmV0dXJuIHN0clJlcGVhdChTdHJpbmcoc3RyKSwgcXR5KTsKCiAgICAgIC8vIHRoaXMgb25lIGlzIGFib3V0IDMwMHggc2xvd2VyIGluIEdvb2dsZSBDaHJvbWUKICAgICAgZm9yICh2YXIgcmVwZWF0ID0gW107IHF0eSA+IDA7IHJlcGVhdFstLXF0eV0gPSBzdHIpIHt9CiAgICAgIHJldHVybiByZXBlYXQuam9pbihzZXBhcmF0b3IpOwogICAgfSwKCiAgICBsZXZlbnNodGVpbjogZnVuY3Rpb24oc3RyMSwgc3RyMikgewogICAgICBpZiAoc3RyMSA9PSBudWxsICYmIHN0cjIgPT0gbnVsbCkgcmV0dXJuIDA7CiAgICAgIGlmIChzdHIxID09IG51bGwpIHJldHVybiBTdHJpbmcoc3RyMikubGVuZ3RoOwogICAgICBpZiAoc3RyMiA9PSBudWxsKSByZXR1cm4gU3RyaW5nKHN0cjEpLmxlbmd0aDsKCiAgICAgIHN0cjEgPSBTdHJpbmcoc3RyMSk7IHN0cjIgPSBTdHJpbmcoc3RyMik7CgogICAgICB2YXIgY3VycmVudCA9IFtdLCBwcmV2LCB2YWx1ZTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IHN0cjIubGVuZ3RoOyBpKyspCiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPD0gc3RyMS5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKGkgJiYgaikKICAgICAgICAgICAgaWYgKHN0cjEuY2hhckF0KGogLSAxKSA9PT0gc3RyMi5jaGFyQXQoaSAtIDEpKQogICAgICAgICAgICAgIHZhbHVlID0gcHJldjsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgIHZhbHVlID0gTWF0aC5taW4oY3VycmVudFtqXSwgY3VycmVudFtqIC0gMV0sIHByZXYpICsgMTsKICAgICAgICAgIGVsc2UKICAgICAgICAgICAgdmFsdWUgPSBpICsgajsKCiAgICAgICAgICBwcmV2ID0gY3VycmVudFtqXTsKICAgICAgICAgIGN1cnJlbnRbal0gPSB2YWx1ZTsKICAgICAgICB9CgogICAgICByZXR1cm4gY3VycmVudC5wb3AoKTsKICAgIH0KICB9OwoKICAvLyBBbGlhc2VzCgogIF9zLnN0cmlwICAgID0gX3MudHJpbTsKICBfcy5sc3RyaXAgICA9IF9zLmx0cmltOwogIF9zLnJzdHJpcCAgID0gX3MucnRyaW07CiAgX3MuY2VudGVyICAgPSBfcy5scnBhZDsKICBfcy5yanVzdCAgICA9IF9zLmxwYWQ7CiAgX3MubGp1c3QgICAgPSBfcy5ycGFkOwogIF9zLmNvbnRhaW5zID0gX3MuaW5jbHVkZTsKICBfcy5xICAgICAgICA9IF9zLnF1b3RlOwoKICAvLyBFeHBvcnRpbmcKCiAgLy8gQ29tbW9uSlMgbW9kdWxlIGlzIGRlZmluZWQKICBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpCiAgICAgIG1vZHVsZS5leHBvcnRzID0gX3M7CgogICAgZXhwb3J0cy5fcyA9IF9zOwogIH0KCiAgLy8gUmVnaXN0ZXIgYXMgYSBuYW1lZCBtb2R1bGUgd2l0aCBBTUQuCiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkKICAgIGRlZmluZSgndW5kZXJzY29yZS5zdHJpbmcnLCBbXSwgZnVuY3Rpb24oKXsgcmV0dXJuIF9zOyB9KTsKCgogIC8vIEludGVncmF0ZSB3aXRoIFVuZGVyc2NvcmUuanMgaWYgZGVmaW5lZAogIC8vIG9yIGNyZWF0ZSBvdXIgb3duIHVuZGVyc2NvcmUgb2JqZWN0LgogIHJvb3QuXyA9IHJvb3QuXyB8fCB7fTsKICByb290Ll8uc3RyaW5nID0gcm9vdC5fLnN0ciA9IF9zOwp9KHRoaXMsIFN0cmluZyk7CgovLyAgICAgbm9kZS11dWlkL3V1aWQuanMKLy8KLy8gICAgIENvcHlyaWdodCAoYykgMjAxMCBSb2JlcnQgS2llZmZlcgovLyAgICAgRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vICAgICBEb2N1bWVudGF0aW9uIGFuZCBkZXRhaWxzIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9icm9vZmEvbm9kZS11dWlkCihmdW5jdGlvbigpIHsKICB2YXIgX2dsb2JhbCA9IHRoaXM7CgogIC8vIFVuaXF1ZSBJRCBjcmVhdGlvbiByZXF1aXJlcyBhIGhpZ2ggcXVhbGl0eSByYW5kb20gIyBnZW5lcmF0b3IsIGJ1dAogIC8vIE1hdGgucmFuZG9tKCkgZG9lcyBub3QgZ3VhcmFudGVlICJjcnlwdG9ncmFwaGljIHF1YWxpdHkiLiAgU28gd2UgZmVhdHVyZQogIC8vIGRldGVjdCBmb3IgbW9yZSByb2J1c3QgQVBJcywgbm9ybWFsaXppbmcgZWFjaCBtZXRob2QgdG8gcmV0dXJuIDEyOC1iaXRzCiAgLy8gKDE2IGJ5dGVzKSBvZiByYW5kb20gZGF0YS4KICB2YXIgbWF0aFJORywgbm9kZVJORywgd2hhdHdnUk5HOwoKICAvLyBNYXRoLnJhbmRvbSgpLWJhc2VkIFJORy4gIEFsbCBwbGF0Zm9ybXMsIHZlcnkgZmFzdCwgdW5rbm93biBxdWFsaXR5CiAgdmFyIF9ybmRCeXRlcyA9IG5ldyBBcnJheSgxNik7CiAgbWF0aFJORyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHIsIGIgPSBfcm5kQnl0ZXMsIGkgPSAwOwoKICAgIGZvciAodmFyIGkgPSAwLCByOyBpIDwgMTY7IGkrKykgewogICAgICBpZiAoKGkgJiAweDAzKSA9PSAwKSByID0gTWF0aC5yYW5kb20oKSAqIDB4MTAwMDAwMDAwOwogICAgICBiW2ldID0gciA+Pj4gKChpICYgMHgwMykgPDwgMykgJiAweGZmOwogICAgfQoKICAgIHJldHVybiBiOwogIH0KCiAgLy8gV0hBVFdHIGNyeXB0by1iYXNlZCBSTkcgLSBodHRwOi8vd2lraS53aGF0d2cub3JnL3dpa2kvQ3J5cHRvCiAgLy8gV2ViS2l0IG9ubHkgKGN1cnJlbnRseSksIG1vZGVyYXRlbHkgZmFzdCwgaGlnaCBxdWFsaXR5CiAgaWYgKF9nbG9iYWwuY3J5cHRvICYmIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMpIHsKICAgIHZhciBfcm5kcyA9IG5ldyBVaW50MzJBcnJheSg0KTsKICAgIHdoYXR3Z1JORyA9IGZ1bmN0aW9uKCkgewogICAgICBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKF9ybmRzKTsKCiAgICAgIGZvciAodmFyIGMgPSAwIDsgYyA8IDE2OyBjKyspIHsKICAgICAgICBfcm5kQnl0ZXNbY10gPSBfcm5kc1tjID4+IDJdID4+PiAoKGMgJiAweDAzKSAqIDgpICYgMHhmZjsKICAgICAgfQogICAgICByZXR1cm4gX3JuZEJ5dGVzOwogICAgfQogIH0KCiAgLy8gTm9kZS5qcyBjcnlwdG8tYmFzZWQgUk5HIC0gaHR0cDovL25vZGVqcy5vcmcvZG9jcy92MC42LjIvYXBpL2NyeXB0by5odG1sCiAgLy8gTm9kZS5qcyBvbmx5LCBtb2RlcmF0ZWx5IGZhc3QsIGhpZ2ggcXVhbGl0eQogIHRyeSB7CiAgICB2YXIgX3JiID0gcmVxdWlyZSgnY3J5cHRvJykucmFuZG9tQnl0ZXM7CiAgICBub2RlUk5HID0gX3JiICYmIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gX3JiKDE2KTsKICAgIH07CiAgfSBjYXRjaCAoZSkge30KCiAgLy8gU2VsZWN0IFJORyB3aXRoIGJlc3QgcXVhbGl0eQogIHZhciBfcm5nID0gbm9kZVJORyB8fCB3aGF0d2dSTkcgfHwgbWF0aFJORzsKCiAgLy8gQnVmZmVyIGNsYXNzIHRvIHVzZQogIHZhciBCdWZmZXJDbGFzcyA9IHR5cGVvZihCdWZmZXIpID09ICdmdW5jdGlvbicgPyBCdWZmZXIgOiBBcnJheTsKCiAgLy8gTWFwcyBmb3IgbnVtYmVyIDwtPiBoZXggc3RyaW5nIGNvbnZlcnNpb24KICB2YXIgX2J5dGVUb0hleCA9IFtdOwogIHZhciBfaGV4VG9CeXRlID0ge307CiAgZm9yICh2YXIgaSA9IDA7IGkgPCAyNTY7IGkrKykgewogICAgX2J5dGVUb0hleFtpXSA9IChpICsgMHgxMDApLnRvU3RyaW5nKDE2KS5zdWJzdHIoMSk7CiAgICBfaGV4VG9CeXRlW19ieXRlVG9IZXhbaV1dID0gaTsKICB9CgogIC8vICoqYHBhcnNlKClgIC0gUGFyc2UgYSBVVUlEIGludG8gaXQncyBjb21wb25lbnQgYnl0ZXMqKgogIGZ1bmN0aW9uIHBhcnNlKHMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgaSA9IChidWYgJiYgb2Zmc2V0KSB8fCAwLCBpaSA9IDA7CgogICAgYnVmID0gYnVmIHx8IFtdOwogICAgcy50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1swLTlhLWZdezJ9L2csIGZ1bmN0aW9uKGJ5dGUpIHsKICAgICAgaWYgKGlpIDwgMTYpIHsgLy8gRG9uJ3Qgb3ZlcmZsb3chCiAgICAgICAgYnVmW2kgKyBpaSsrXSA9IF9oZXhUb0J5dGVbYnl0ZV07CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIFplcm8gb3V0IHJlbWFpbmluZyBieXRlcyBpZiBzdHJpbmcgd2FzIHNob3J0CiAgICB3aGlsZSAoaWkgPCAxNikgewogICAgICBidWZbaSArIGlpKytdID0gMDsKICAgIH0KCiAgICByZXR1cm4gYnVmOwogIH0KCiAgLy8gKipgdW5wYXJzZSgpYCAtIENvbnZlcnQgVVVJRCBieXRlIGFycmF5IChhbGEgcGFyc2UoKSkgaW50byBhIHN0cmluZyoqCiAgZnVuY3Rpb24gdW5wYXJzZShidWYsIG9mZnNldCkgewogICAgdmFyIGkgPSBvZmZzZXQgfHwgMCwgYnRoID0gX2J5dGVUb0hleDsKICAgIHJldHVybiAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArICctJyArCiAgICAgICAgICAgIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsgJy0nICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKyAnLScgKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArICctJyArCiAgICAgICAgICAgIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXTsKICB9CgogIC8vICoqYHYxKClgIC0gR2VuZXJhdGUgdGltZS1iYXNlZCBVVUlEKioKICAvLwogIC8vIEluc3BpcmVkIGJ5IGh0dHBzOi8vZ2l0aHViLmNvbS9MaW9zSy9VVUlELmpzCiAgLy8gYW5kIGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS91dWlkLmh0bWwKCiAgLy8gcmFuZG9tICMncyB3ZSBuZWVkIHRvIGluaXQgbm9kZSBhbmQgY2xvY2tzZXEKICB2YXIgX3NlZWRCeXRlcyA9IF9ybmcoKTsKCiAgLy8gUGVyIDQuNSwgY3JlYXRlIGFuZCA0OC1iaXQgbm9kZSBpZCwgKDQ3IHJhbmRvbSBiaXRzICsgbXVsdGljYXN0IGJpdCA9IDEpCiAgdmFyIF9ub2RlSWQgPSBbCiAgICBfc2VlZEJ5dGVzWzBdIHwgMHgwMSwKICAgIF9zZWVkQnl0ZXNbMV0sIF9zZWVkQnl0ZXNbMl0sIF9zZWVkQnl0ZXNbM10sIF9zZWVkQnl0ZXNbNF0sIF9zZWVkQnl0ZXNbNV0KICBdOwoKICAvLyBQZXIgNC4yLjIsIHJhbmRvbWl6ZSAoMTQgYml0KSBjbG9ja3NlcQogIHZhciBfY2xvY2tzZXEgPSAoX3NlZWRCeXRlc1s2XSA8PCA4IHwgX3NlZWRCeXRlc1s3XSkgJiAweDNmZmY7CgogIC8vIFByZXZpb3VzIHV1aWQgY3JlYXRpb24gdGltZQogIHZhciBfbGFzdE1TZWNzID0gMCwgX2xhc3ROU2VjcyA9IDA7CgogIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYnJvb2ZhL25vZGUtdXVpZCBmb3IgQVBJIGRldGFpbHMKICBmdW5jdGlvbiB2MShvcHRpb25zLCBidWYsIG9mZnNldCkgewogICAgdmFyIGkgPSBidWYgJiYgb2Zmc2V0IHx8IDA7CiAgICB2YXIgYiA9IGJ1ZiB8fCBbXTsKCiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICB2YXIgY2xvY2tzZXEgPSBvcHRpb25zLmNsb2Nrc2VxICE9IG51bGwgPyBvcHRpb25zLmNsb2Nrc2VxIDogX2Nsb2Nrc2VxOwoKICAgIC8vIFVVSUQgdGltZXN0YW1wcyBhcmUgMTAwIG5hbm8tc2Vjb25kIHVuaXRzIHNpbmNlIHRoZSBHcmVnb3JpYW4gZXBvY2gsCiAgICAvLyAoMTU4Mi0xMC0xNSAwMDowMCkuICBKU051bWJlcnMgYXJlbid0IHByZWNpc2UgZW5vdWdoIGZvciB0aGlzLCBzbwogICAgLy8gdGltZSBpcyBoYW5kbGVkIGludGVybmFsbHkgYXMgJ21zZWNzJyAoaW50ZWdlciBtaWxsaXNlY29uZHMpIGFuZCAnbnNlY3MnCiAgICAvLyAoMTAwLW5hbm9zZWNvbmRzIG9mZnNldCBmcm9tIG1zZWNzKSBzaW5jZSB1bml4IGVwb2NoLCAxOTcwLTAxLTAxIDAwOjAwLgogICAgdmFyIG1zZWNzID0gb3B0aW9ucy5tc2VjcyAhPSBudWxsID8gb3B0aW9ucy5tc2VjcyA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoKICAgIC8vIFBlciA0LjIuMS4yLCB1c2UgY291bnQgb2YgdXVpZCdzIGdlbmVyYXRlZCBkdXJpbmcgdGhlIGN1cnJlbnQgY2xvY2sKICAgIC8vIGN5Y2xlIHRvIHNpbXVsYXRlIGhpZ2hlciByZXNvbHV0aW9uIGNsb2NrCiAgICB2YXIgbnNlY3MgPSBvcHRpb25zLm5zZWNzICE9IG51bGwgPyBvcHRpb25zLm5zZWNzIDogX2xhc3ROU2VjcyArIDE7CgogICAgLy8gVGltZSBzaW5jZSBsYXN0IHV1aWQgY3JlYXRpb24gKGluIG1zZWNzKQogICAgdmFyIGR0ID0gKG1zZWNzIC0gX2xhc3RNU2VjcykgKyAobnNlY3MgLSBfbGFzdE5TZWNzKS8xMDAwMDsKCiAgICAvLyBQZXIgNC4yLjEuMiwgQnVtcCBjbG9ja3NlcSBvbiBjbG9jayByZWdyZXNzaW9uCiAgICBpZiAoZHQgPCAwICYmIG9wdGlvbnMuY2xvY2tzZXEgPT0gbnVsbCkgewogICAgICBjbG9ja3NlcSA9IGNsb2Nrc2VxICsgMSAmIDB4M2ZmZjsKICAgIH0KCiAgICAvLyBSZXNldCBuc2VjcyBpZiBjbG9jayByZWdyZXNzZXMgKG5ldyBjbG9ja3NlcSkgb3Igd2UndmUgbW92ZWQgb250byBhIG5ldwogICAgLy8gdGltZSBpbnRlcnZhbAogICAgaWYgKChkdCA8IDAgfHwgbXNlY3MgPiBfbGFzdE1TZWNzKSAmJiBvcHRpb25zLm5zZWNzID09IG51bGwpIHsKICAgICAgbnNlY3MgPSAwOwogICAgfQoKICAgIC8vIFBlciA0LjIuMS4yIFRocm93IGVycm9yIGlmIHRvbyBtYW55IHV1aWRzIGFyZSByZXF1ZXN0ZWQKICAgIGlmIChuc2VjcyA+PSAxMDAwMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3V1aWQudjEoKTogQ2FuXCd0IGNyZWF0ZSBtb3JlIHRoYW4gMTBNIHV1aWRzL3NlYycpOwogICAgfQoKICAgIF9sYXN0TVNlY3MgPSBtc2VjczsKICAgIF9sYXN0TlNlY3MgPSBuc2VjczsKICAgIF9jbG9ja3NlcSA9IGNsb2Nrc2VxOwoKICAgIC8vIFBlciA0LjEuNCAtIENvbnZlcnQgZnJvbSB1bml4IGVwb2NoIHRvIEdyZWdvcmlhbiBlcG9jaAogICAgbXNlY3MgKz0gMTIyMTkyOTI4MDAwMDA7CgogICAgLy8gYHRpbWVfbG93YAogICAgdmFyIHRsID0gKChtc2VjcyAmIDB4ZmZmZmZmZikgKiAxMDAwMCArIG5zZWNzKSAlIDB4MTAwMDAwMDAwOwogICAgYltpKytdID0gdGwgPj4+IDI0ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRsID4+PiAxNiAmIDB4ZmY7CiAgICBiW2krK10gPSB0bCA+Pj4gOCAmIDB4ZmY7CiAgICBiW2krK10gPSB0bCAmIDB4ZmY7CgogICAgLy8gYHRpbWVfbWlkYAogICAgdmFyIHRtaCA9IChtc2VjcyAvIDB4MTAwMDAwMDAwICogMTAwMDApICYgMHhmZmZmZmZmOwogICAgYltpKytdID0gdG1oID4+PiA4ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRtaCAmIDB4ZmY7CgogICAgLy8gYHRpbWVfaGlnaF9hbmRfdmVyc2lvbmAKICAgIGJbaSsrXSA9IHRtaCA+Pj4gMjQgJiAweGYgfCAweDEwOyAvLyBpbmNsdWRlIHZlcnNpb24KICAgIGJbaSsrXSA9IHRtaCA+Pj4gMTYgJiAweGZmOwoKICAgIC8vIGBjbG9ja19zZXFfaGlfYW5kX3Jlc2VydmVkYCAoUGVyIDQuMi4yIC0gaW5jbHVkZSB2YXJpYW50KQogICAgYltpKytdID0gY2xvY2tzZXEgPj4+IDggfCAweDgwOwoKICAgIC8vIGBjbG9ja19zZXFfbG93YAogICAgYltpKytdID0gY2xvY2tzZXEgJiAweGZmOwoKICAgIC8vIGBub2RlYAogICAgdmFyIG5vZGUgPSBvcHRpb25zLm5vZGUgfHwgX25vZGVJZDsKICAgIGZvciAodmFyIG4gPSAwOyBuIDwgNjsgbisrKSB7CiAgICAgIGJbaSArIG5dID0gbm9kZVtuXTsKICAgIH0KCiAgICByZXR1cm4gYnVmID8gYnVmIDogdW5wYXJzZShiKTsKICB9CgogIC8vICoqYHY0KClgIC0gR2VuZXJhdGUgcmFuZG9tIFVVSUQqKgoKICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2Jyb29mYS9ub2RlLXV1aWQgZm9yIEFQSSBkZXRhaWxzCiAgZnVuY3Rpb24gdjQob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICAgIC8vIERlcHJlY2F0ZWQgLSAnZm9ybWF0JyBhcmd1bWVudCwgYXMgc3VwcG9ydGVkIGluIHYxLjIKICAgIHZhciBpID0gYnVmICYmIG9mZnNldCB8fCAwOwoKICAgIGlmICh0eXBlb2Yob3B0aW9ucykgPT0gJ3N0cmluZycpIHsKICAgICAgYnVmID0gb3B0aW9ucyA9PSAnYmluYXJ5JyA/IG5ldyBCdWZmZXJDbGFzcygxNikgOiBudWxsOwogICAgICBvcHRpb25zID0gbnVsbDsKICAgIH0KICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgIHZhciBybmRzID0gb3B0aW9ucy5yYW5kb20gfHwgKG9wdGlvbnMucm5nIHx8IF9ybmcpKCk7CgogICAgLy8gUGVyIDQuNCwgc2V0IGJpdHMgZm9yIHZlcnNpb24gYW5kIGBjbG9ja19zZXFfaGlfYW5kX3Jlc2VydmVkYAogICAgcm5kc1s2XSA9IChybmRzWzZdICYgMHgwZikgfCAweDQwOwogICAgcm5kc1s4XSA9IChybmRzWzhdICYgMHgzZikgfCAweDgwOwoKICAgIC8vIENvcHkgYnl0ZXMgdG8gYnVmZmVyLCBpZiBwcm92aWRlZAogICAgaWYgKGJ1ZikgewogICAgICBmb3IgKHZhciBpaSA9IDA7IGlpIDwgMTY7IGlpKyspIHsKICAgICAgICBidWZbaSArIGlpXSA9IHJuZHNbaWldOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGJ1ZiB8fCB1bnBhcnNlKHJuZHMpOwogIH0KCiAgLy8gRXhwb3J0IHB1YmxpYyBBUEkKICB2YXIgdXVpZCA9IHY0OwogIHV1aWQudjEgPSB2MTsKICB1dWlkLnY0ID0gdjQ7CiAgdXVpZC5wYXJzZSA9IHBhcnNlOwogIHV1aWQudW5wYXJzZSA9IHVucGFyc2U7CiAgdXVpZC5CdWZmZXJDbGFzcyA9IEJ1ZmZlckNsYXNzOwoKICAvLyBFeHBvcnQgUk5HIG9wdGlvbnMKICB1dWlkLm1hdGhSTkcgPSBtYXRoUk5HOwogIHV1aWQubm9kZVJORyA9IG5vZGVSTkc7CiAgdXVpZC53aGF0d2dSTkcgPSB3aGF0d2dSTkc7CgogIGlmICh0eXBlb2YobW9kdWxlKSAhPSAndW5kZWZpbmVkJykgewogICAgLy8gUGxheSBuaWNlIHdpdGggbm9kZS5qcwogICAgbW9kdWxlLmV4cG9ydHMgPSB1dWlkOwogIH0gZWxzZSB7CiAgICAvLyBQbGF5IG5pY2Ugd2l0aCBicm93c2VycwogICAgdmFyIF9wcmV2aW91c1Jvb3QgPSBfZ2xvYmFsLnV1aWQ7CgogICAgLy8gKipgbm9Db25mbGljdCgpYCAtIChicm93c2VyIG9ubHkpIHRvIHJlc2V0IGdsb2JhbCAndXVpZCcgdmFyKioKICAgIHV1aWQubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgICBfZ2xvYmFsLnV1aWQgPSBfcHJldmlvdXNSb290OwogICAgICByZXR1cm4gdXVpZDsKICAgIH0KICAgIF9nbG9iYWwudXVpZCA9IHV1aWQ7CiAgfQp9KCkpOwoKZGVmaW5lKCJ1dWlkIiwgZnVuY3Rpb24oKXt9KTsKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qKgogKiBBIGxpZ2h0d2VpZ2h0IENvbW1vbkpTIFByb21pc2VzL0EgYW5kIHdoZW4oKSBpbXBsZW1lbnRhdGlvbgogKiB3aGVuIGlzIHBhcnQgb2YgdGhlIGN1am8uanMgZmFtaWx5IG9mIGxpYnJhcmllcyAoaHR0cDovL2N1am9qcy5jb20vKQogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UgYXQ6CiAqIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwCiAqCiAqIEB2ZXJzaW9uIDEuNy4xCiAqLwoKKGZ1bmN0aW9uKGRlZmluZSkgeyAKZGVmaW5lKCd3aGVuL3doZW4nLFtdLGZ1bmN0aW9uICgpIHsKCXZhciByZWR1Y2VBcnJheSwgc2xpY2UsIHVuZGVmOwoKCS8vCgkvLyBQdWJsaWMgQVBJCgkvLwoKCXdoZW4uZGVmZXIgICAgID0gZGVmZXI7ICAgICAvLyBDcmVhdGUgYSBkZWZlcnJlZAoJd2hlbi5yZXNvbHZlICAgPSByZXNvbHZlOyAgIC8vIENyZWF0ZSBhIHJlc29sdmVkIHByb21pc2UKCXdoZW4ucmVqZWN0ICAgID0gcmVqZWN0OyAgICAvLyBDcmVhdGUgYSByZWplY3RlZCBwcm9taXNlCgoJd2hlbi5qb2luICAgICAgPSBqb2luOyAgICAgIC8vIEpvaW4gMiBvciBtb3JlIHByb21pc2VzCgoJd2hlbi5hbGwgICAgICAgPSBhbGw7ICAgICAgIC8vIFJlc29sdmUgYSBsaXN0IG9mIHByb21pc2VzCgl3aGVuLm1hcCAgICAgICA9IG1hcDsgICAgICAgLy8gQXJyYXkubWFwKCkgZm9yIHByb21pc2VzCgl3aGVuLnJlZHVjZSAgICA9IHJlZHVjZTsgICAgLy8gQXJyYXkucmVkdWNlKCkgZm9yIHByb21pc2VzCgoJd2hlbi5hbnkgICAgICAgPSBhbnk7ICAgICAgIC8vIE9uZS13aW5uZXIgcmFjZQoJd2hlbi5zb21lICAgICAgPSBzb21lOyAgICAgIC8vIE11bHRpLXdpbm5lciByYWNlCgoJd2hlbi5jaGFpbiAgICAgPSBjaGFpbjsgICAgIC8vIE1ha2UgYSBwcm9taXNlIHRyaWdnZXIgYW5vdGhlciByZXNvbHZlcgoKCXdoZW4uaXNQcm9taXNlID0gaXNQcm9taXNlOyAvLyBEZXRlcm1pbmUgaWYgYSB0aGluZyBpcyBhIHByb21pc2UKCgkvKioKCSAqIFJlZ2lzdGVyIGFuIG9ic2VydmVyIGZvciBhIHByb21pc2Ugb3IgaW1tZWRpYXRlIHZhbHVlLgoJICoKCSAqIEBwYXJhbSB7Kn0gcHJvbWlzZU9yVmFsdWUKCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRdIGNhbGxiYWNrIHRvIGJlIGNhbGxlZCB3aGVuIHByb21pc2VPclZhbHVlIGlzCgkgKiAgIHN1Y2Nlc3NmdWxseSBmdWxmaWxsZWQuICBJZiBwcm9taXNlT3JWYWx1ZSBpcyBhbiBpbW1lZGlhdGUgdmFsdWUsIGNhbGxiYWNrCgkgKiAgIHdpbGwgYmUgaW52b2tlZCBpbW1lZGlhdGVseS4KCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25SZWplY3RlZF0gY2FsbGJhY2sgdG8gYmUgY2FsbGVkIHdoZW4gcHJvbWlzZU9yVmFsdWUgaXMKCSAqICAgcmVqZWN0ZWQuCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUHJvZ3Jlc3NdIGNhbGxiYWNrIHRvIGJlIGNhbGxlZCB3aGVuIHByb2dyZXNzIHVwZGF0ZXMKCSAqICAgYXJlIGlzc3VlZCBmb3IgcHJvbWlzZU9yVmFsdWUuCgkgKiBAcmV0dXJucyB7UHJvbWlzZX0gYSBuZXcge0BsaW5rIFByb21pc2V9IHRoYXQgd2lsbCBjb21wbGV0ZSB3aXRoIHRoZSByZXR1cm4KCSAqICAgdmFsdWUgb2YgY2FsbGJhY2sgb3IgZXJyYmFjayBvciB0aGUgY29tcGxldGlvbiB2YWx1ZSBvZiBwcm9taXNlT3JWYWx1ZSBpZgoJICogICBjYWxsYmFjayBhbmQvb3IgZXJyYmFjayBpcyBub3Qgc3VwcGxpZWQuCgkgKi8KCWZ1bmN0aW9uIHdoZW4ocHJvbWlzZU9yVmFsdWUsIG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKSB7CgkJLy8gR2V0IGEgdHJ1c3RlZCBwcm9taXNlIGZvciB0aGUgaW5wdXQgcHJvbWlzZU9yVmFsdWUsIGFuZCB0aGVuCgkJLy8gcmVnaXN0ZXIgcHJvbWlzZSBoYW5kbGVycwoJCXJldHVybiByZXNvbHZlKHByb21pc2VPclZhbHVlKS50aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKTsKCX0KCgkvKioKCSAqIFJldHVybnMgcHJvbWlzZU9yVmFsdWUgaWYgcHJvbWlzZU9yVmFsdWUgaXMgYSB7QGxpbmsgUHJvbWlzZX0sIGEgbmV3IFByb21pc2UgaWYKCSAqIHByb21pc2VPclZhbHVlIGlzIGEgZm9yZWlnbiBwcm9taXNlLCBvciBhIG5ldywgYWxyZWFkeS1mdWxmaWxsZWQge0BsaW5rIFByb21pc2V9CgkgKiB3aG9zZSB2YWx1ZSBpcyBwcm9taXNlT3JWYWx1ZSBpZiBwcm9taXNlT3JWYWx1ZSBpcyBhbiBpbW1lZGlhdGUgdmFsdWUuCgkgKgoJICogQHBhcmFtIHsqfSBwcm9taXNlT3JWYWx1ZQoJICogQHJldHVybnMgR3VhcmFudGVlZCB0byByZXR1cm4gYSB0cnVzdGVkIFByb21pc2UuICBJZiBwcm9taXNlT3JWYWx1ZSBpcyBhIHdoZW4uanMge0BsaW5rIFByb21pc2V9CgkgKiAgIHJldHVybnMgcHJvbWlzZU9yVmFsdWUsIG90aGVyd2lzZSwgcmV0dXJucyBhIG5ldywgYWxyZWFkeS1yZXNvbHZlZCwgd2hlbi5qcyB7QGxpbmsgUHJvbWlzZX0KCSAqICAgd2hvc2UgcmVzb2x1dGlvbiB2YWx1ZSBpczoKCSAqICAgKiB0aGUgcmVzb2x1dGlvbiB2YWx1ZSBvZiBwcm9taXNlT3JWYWx1ZSBpZiBpdCdzIGEgZm9yZWlnbiBwcm9taXNlLCBvcgoJICogICAqIHByb21pc2VPclZhbHVlIGlmIGl0J3MgYSB2YWx1ZQoJICovCglmdW5jdGlvbiByZXNvbHZlKHByb21pc2VPclZhbHVlKSB7CgkJdmFyIHByb21pc2UsIGRlZmVycmVkOwoKCQlpZihwcm9taXNlT3JWYWx1ZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKCQkJLy8gSXQncyBhIHdoZW4uanMgcHJvbWlzZSwgc28gd2UgdHJ1c3QgaXQKCQkJcHJvbWlzZSA9IHByb21pc2VPclZhbHVlOwoKCQl9IGVsc2UgewoJCQkvLyBJdCdzIG5vdCBhIHdoZW4uanMgcHJvbWlzZS4gU2VlIGlmIGl0J3MgYSBmb3JlaWduIHByb21pc2Ugb3IgYSB2YWx1ZS4KCQkJaWYoaXNQcm9taXNlKHByb21pc2VPclZhbHVlKSkgewoJCQkJLy8gSXQncyBhIHRoZW5hYmxlLCBidXQgd2UgZG9uJ3Qga25vdyB3aGVyZSBpdCBjYW1lIGZyb20sIHNvIGRvbid0IHRydXN0CgkJCQkvLyBpdHMgaW1wbGVtZW50YXRpb24gZW50aXJlbHkuICBJbnRyb2R1Y2UgYSB0cnVzdGVkIG1pZGRsZW1hbiB3aGVuLmpzIHByb21pc2UKCQkJCWRlZmVycmVkID0gZGVmZXIoKTsKCgkJCQkvLyBJTVBPUlRBTlQ6IFRoaXMgaXMgdGhlIG9ubHkgcGxhY2Ugd2hlbi5qcyBzaG91bGQgZXZlciBjYWxsIC50aGVuKCkgb24gYW4KCQkJCS8vIHVudHJ1c3RlZCBwcm9taXNlLiBEb24ndCBleHBvc2UgdGhlIHJldHVybiB2YWx1ZSB0byB0aGUgdW50cnVzdGVkIHByb21pc2UKCQkJCXByb21pc2VPclZhbHVlLnRoZW4oCgkJCQkJZnVuY3Rpb24odmFsdWUpICB7IGRlZmVycmVkLnJlc29sdmUodmFsdWUpOyB9LAoJCQkJCWZ1bmN0aW9uKHJlYXNvbikgeyBkZWZlcnJlZC5yZWplY3QocmVhc29uKTsgfSwKCQkJCQlmdW5jdGlvbih1cGRhdGUpIHsgZGVmZXJyZWQucHJvZ3Jlc3ModXBkYXRlKTsgfQoJCQkJKTsKCgkJCQlwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZTsKCgkJCX0gZWxzZSB7CgkJCQkvLyBJdCdzIGEgdmFsdWUsIG5vdCBhIHByb21pc2UuICBDcmVhdGUgYSByZXNvbHZlZCBwcm9taXNlIGZvciBpdC4KCQkJCXByb21pc2UgPSBmdWxmaWxsZWQocHJvbWlzZU9yVmFsdWUpOwoJCQl9CgkJfQoKCQlyZXR1cm4gcHJvbWlzZTsKCX0KCgkvKioKCSAqIFJldHVybnMgYSByZWplY3RlZCBwcm9taXNlIGZvciB0aGUgc3VwcGxpZWQgcHJvbWlzZU9yVmFsdWUuICBUaGUgcmV0dXJuZWQKCSAqIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCB3aXRoOgoJICogLSBwcm9taXNlT3JWYWx1ZSwgaWYgaXQgaXMgYSB2YWx1ZSwgb3IKCSAqIC0gaWYgcHJvbWlzZU9yVmFsdWUgaXMgYSBwcm9taXNlCgkgKiAgIC0gcHJvbWlzZU9yVmFsdWUncyB2YWx1ZSBhZnRlciBpdCBpcyBmdWxmaWxsZWQKCSAqICAgLSBwcm9taXNlT3JWYWx1ZSdzIHJlYXNvbiBhZnRlciBpdCBpcyByZWplY3RlZAoJICogQHBhcmFtIHsqfSBwcm9taXNlT3JWYWx1ZSB0aGUgcmVqZWN0ZWQgdmFsdWUgb2YgdGhlIHJldHVybmVkIHtAbGluayBQcm9taXNlfQoJICogQHJldHVybiB7UHJvbWlzZX0gcmVqZWN0ZWQge0BsaW5rIFByb21pc2V9CgkgKi8KCWZ1bmN0aW9uIHJlamVjdChwcm9taXNlT3JWYWx1ZSkgewoJCXJldHVybiB3aGVuKHByb21pc2VPclZhbHVlLCByZWplY3RlZCk7Cgl9CgoJLyoqCgkgKiBUcnVzdGVkIFByb21pc2UgY29uc3RydWN0b3IuICBBIFByb21pc2UgY3JlYXRlZCBmcm9tIHRoaXMgY29uc3RydWN0b3IgaXMKCSAqIGEgdHJ1c3RlZCB3aGVuLmpzIHByb21pc2UuICBBbnkgb3RoZXIgZHVjay10eXBlZCBwcm9taXNlIGlzIGNvbnNpZGVyZWQKCSAqIHVudHJ1c3RlZC4KCSAqIEBjb25zdHJ1Y3RvcgoJICogQG5hbWUgUHJvbWlzZQoJICovCglmdW5jdGlvbiBQcm9taXNlKHRoZW4pIHsKCQl0aGlzLnRoZW4gPSB0aGVuOwoJfQoKCVByb21pc2UucHJvdG90eXBlID0gewoJCS8qKgoJCSAqIFJlZ2lzdGVyIGEgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIGEgcHJvbWlzZSBpcwoJCSAqIGZ1bGZpbGxlZCBvciByZWplY3RlZC4gIE9wdGlvbmFsbHkgYWxzbyByZWdpc3RlciBhIHByb2dyZXNzIGhhbmRsZXIuCgkJICogU2hvcnRjdXQgZm9yIC50aGVuKG9uRnVsZmlsbGVkT3JSZWplY3RlZCwgb25GdWxmaWxsZWRPclJlamVjdGVkLCBvblByb2dyZXNzKQoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRPclJlamVjdGVkXQoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25Qcm9ncmVzc10KCQkgKiBAcmV0dXJuIHtQcm9taXNlfQoJCSAqLwoJCWFsd2F5czogZnVuY3Rpb24ob25GdWxmaWxsZWRPclJlamVjdGVkLCBvblByb2dyZXNzKSB7CgkJCXJldHVybiB0aGlzLnRoZW4ob25GdWxmaWxsZWRPclJlamVjdGVkLCBvbkZ1bGZpbGxlZE9yUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MpOwoJCX0sCgoJCS8qKgoJCSAqIFJlZ2lzdGVyIGEgcmVqZWN0aW9uIGhhbmRsZXIuICBTaG9ydGN1dCBmb3IgLnRoZW4odW5kZWZpbmVkLCBvblJlamVjdGVkKQoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBvblJlamVjdGVkCgkJICogQHJldHVybiB7UHJvbWlzZX0KCQkgKi8KCQlvdGhlcndpc2U6IGZ1bmN0aW9uKG9uUmVqZWN0ZWQpIHsKCQkJcmV0dXJuIHRoaXMudGhlbih1bmRlZiwgb25SZWplY3RlZCk7CgkJfSwKCgkJLyoqCgkJICogU2hvcnRjdXQgZm9yIC50aGVuKGZ1bmN0aW9uKCkgeyByZXR1cm4gdmFsdWU7IH0pCgkJICogQHBhcmFtICB7Kn0gdmFsdWUKCQkgKiBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgdGhhdDoKCQkgKiAgLSBpcyBmdWxmaWxsZWQgaWYgdmFsdWUgaXMgbm90IGEgcHJvbWlzZSwgb3IKCQkgKiAgLSBpZiB2YWx1ZSBpcyBhIHByb21pc2UsIHdpbGwgZnVsZmlsbCB3aXRoIGl0cyB2YWx1ZSwgb3IgcmVqZWN0CgkJICogICAgd2l0aCBpdHMgcmVhc29uLgoJCSAqLwoJCXlpZWxkOiBmdW5jdGlvbih2YWx1ZSkgewoJCQlyZXR1cm4gdGhpcy50aGVuKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHZhbHVlOwoJCQl9KTsKCQl9LAoKCQkvKioKCQkgKiBBc3N1bWVzIHRoYXQgdGhpcyBwcm9taXNlIHdpbGwgZnVsZmlsbCB3aXRoIGFuIGFycmF5LCBhbmQgYXJyYW5nZXMKCQkgKiBmb3IgdGhlIG9uRnVsZmlsbGVkIHRvIGJlIGNhbGxlZCB3aXRoIHRoZSBhcnJheSBhcyBpdHMgYXJndW1lbnQgbGlzdAoJCSAqIGkuZS4gb25GdWxmaWxsZWQuc3ByZWFkKHVuZGVmaW5lZCwgYXJyYXkpLgoJCSAqIEBwYXJhbSB7ZnVuY3Rpb259IG9uRnVsZmlsbGVkIGZ1bmN0aW9uIHRvIHJlY2VpdmUgc3ByZWFkIGFyZ3VtZW50cwoJCSAqIEByZXR1cm4ge1Byb21pc2V9CgkJICovCgkJc3ByZWFkOiBmdW5jdGlvbihvbkZ1bGZpbGxlZCkgewoJCQlyZXR1cm4gdGhpcy50aGVuKGZ1bmN0aW9uKGFycmF5KSB7CgkJCQkvLyBhcnJheSBtYXkgY29udGFpbiBwcm9taXNlcywgc28gcmVzb2x2ZSBpdHMgY29udGVudHMuCgkJCQlyZXR1cm4gYWxsKGFycmF5LCBmdW5jdGlvbihhcnJheSkgewoJCQkJCXJldHVybiBvbkZ1bGZpbGxlZC5hcHBseSh1bmRlZiwgYXJyYXkpOwoJCQkJfSk7CgkJCX0pOwoJCX0KCX07CgoJLyoqCgkgKiBDcmVhdGUgYW4gYWxyZWFkeS1yZXNvbHZlZCBwcm9taXNlIGZvciB0aGUgc3VwcGxpZWQgdmFsdWUKCSAqIEBwcml2YXRlCgkgKgoJICogQHBhcmFtIHsqfSB2YWx1ZQoJICogQHJldHVybiB7UHJvbWlzZX0gZnVsZmlsbGVkIHByb21pc2UKCSAqLwoJZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7CgkJdmFyIHAgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihvbkZ1bGZpbGxlZCkgewoJCQkvLyBUT0RPOiBQcm9taXNlcy9BKyBjaGVjayB0eXBlb2Ygb25GdWxmaWxsZWQKCQkJdHJ5IHsKCQkJCXJldHVybiByZXNvbHZlKG9uRnVsZmlsbGVkID8gb25GdWxmaWxsZWQodmFsdWUpIDogdmFsdWUpOwoJCQl9IGNhdGNoKGUpIHsKCQkJCXJldHVybiByZWplY3RlZChlKTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gcDsKCX0KCgkvKioKCSAqIENyZWF0ZSBhbiBhbHJlYWR5LXJlamVjdGVkIHtAbGluayBQcm9taXNlfSB3aXRoIHRoZSBzdXBwbGllZAoJICogcmVqZWN0aW9uIHJlYXNvbi4KCSAqIEBwcml2YXRlCgkgKgoJICogQHBhcmFtIHsqfSByZWFzb24KCSAqIEByZXR1cm4ge1Byb21pc2V9IHJlamVjdGVkIHByb21pc2UKCSAqLwoJZnVuY3Rpb24gcmVqZWN0ZWQocmVhc29uKSB7CgkJdmFyIHAgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihfLCBvblJlamVjdGVkKSB7CgkJCS8vIFRPRE86IFByb21pc2VzL0ErIGNoZWNrIHR5cGVvZiBvblJlamVjdGVkCgkJCXRyeSB7CgkJCQlyZXR1cm4gb25SZWplY3RlZCA/IHJlc29sdmUob25SZWplY3RlZChyZWFzb24pKSA6IHJlamVjdGVkKHJlYXNvbik7CgkJCX0gY2F0Y2goZSkgewoJCQkJcmV0dXJuIHJlamVjdGVkKGUpOwoJCQl9CgkJfSk7CgoJCXJldHVybiBwOwoJfQoKCS8qKgoJICogQ3JlYXRlcyBhIG5ldywgRGVmZXJyZWQgd2l0aCBmdWxseSBpc29sYXRlZCByZXNvbHZlciBhbmQgcHJvbWlzZSBwYXJ0cywKCSAqIGVpdGhlciBvciBib3RoIG9mIHdoaWNoIG1heSBiZSBnaXZlbiBvdXQgc2FmZWx5IHRvIGNvbnN1bWVycy4KCSAqIFRoZSBEZWZlcnJlZCBpdHNlbGYgaGFzIHRoZSBmdWxsIEFQSTogcmVzb2x2ZSwgcmVqZWN0LCBwcm9ncmVzcywgYW5kCgkgKiB0aGVuLiBUaGUgcmVzb2x2ZXIgaGFzIHJlc29sdmUsIHJlamVjdCwgYW5kIHByb2dyZXNzLiAgVGhlIHByb21pc2UKCSAqIG9ubHkgaGFzIHRoZW4uCgkgKgoJICogQHJldHVybiB7RGVmZXJyZWR9CgkgKi8KCWZ1bmN0aW9uIGRlZmVyKCkgewoJCXZhciBkZWZlcnJlZCwgcHJvbWlzZSwgaGFuZGxlcnMsIHByb2dyZXNzSGFuZGxlcnMsCgkJCV90aGVuLCBfcHJvZ3Jlc3MsIF9yZXNvbHZlOwoKCQkvKioKCQkgKiBUaGUgcHJvbWlzZSBmb3IgdGhlIG5ldyBkZWZlcnJlZAoJCSAqIEB0eXBlIHtQcm9taXNlfQoJCSAqLwoJCXByb21pc2UgPSBuZXcgUHJvbWlzZSh0aGVuKTsKCgkJLyoqCgkJICogVGhlIGZ1bGwgRGVmZXJyZWQgb2JqZWN0LCB3aXRoIHtAbGluayBQcm9taXNlfSBhbmQge0BsaW5rIFJlc29sdmVyfSBwYXJ0cwoJCSAqIEBjbGFzcyBEZWZlcnJlZAoJCSAqIEBuYW1lIERlZmVycmVkCgkJICovCgkJZGVmZXJyZWQgPSB7CgkJCXRoZW46ICAgICB0aGVuLCAvLyBERVBSRUNBVEVEOiB1c2UgZGVmZXJyZWQucHJvbWlzZS50aGVuCgkJCXJlc29sdmU6ICBwcm9taXNlUmVzb2x2ZSwKCQkJcmVqZWN0OiAgIHByb21pc2VSZWplY3QsCgkJCS8vIFRPRE86IENvbnNpZGVyIHJlbmFtaW5nIHByb2dyZXNzKCkgdG8gbm90aWZ5KCkKCQkJcHJvZ3Jlc3M6IHByb21pc2VQcm9ncmVzcywKCgkJCXByb21pc2U6ICBwcm9taXNlLAoKCQkJcmVzb2x2ZXI6IHsKCQkJCXJlc29sdmU6ICBwcm9taXNlUmVzb2x2ZSwKCQkJCXJlamVjdDogICBwcm9taXNlUmVqZWN0LAoJCQkJcHJvZ3Jlc3M6IHByb21pc2VQcm9ncmVzcwoJCQl9CgkJfTsKCgkJaGFuZGxlcnMgPSBbXTsKCQlwcm9ncmVzc0hhbmRsZXJzID0gW107CgoJCS8qKgoJCSAqIFByZS1yZXNvbHV0aW9uIHRoZW4oKSB0aGF0IGFkZHMgdGhlIHN1cHBsaWVkIGNhbGxiYWNrLCBlcnJiYWNrLCBhbmQgcHJvZ2JhY2sKCQkgKiBmdW5jdGlvbnMgdG8gdGhlIHJlZ2lzdGVyZWQgbGlzdGVuZXJzCgkJICogQHByaXZhdGUKCQkgKgoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRdIHJlc29sdXRpb24gaGFuZGxlcgoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25SZWplY3RlZF0gcmVqZWN0aW9uIGhhbmRsZXIKCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUHJvZ3Jlc3NdIHByb2dyZXNzIGhhbmRsZXIKCQkgKi8KCQlfdGhlbiA9IGZ1bmN0aW9uKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKSB7CgkJCS8vIFRPRE86IFByb21pc2VzL0ErIGNoZWNrIHR5cGVvZiBvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcwoJCQl2YXIgZGVmZXJyZWQsIHByb2dyZXNzSGFuZGxlcjsKCgkJCWRlZmVycmVkID0gZGVmZXIoKTsKCgkJCXByb2dyZXNzSGFuZGxlciA9IHR5cGVvZiBvblByb2dyZXNzID09PSAnZnVuY3Rpb24nCgkJCQk/IGZ1bmN0aW9uKHVwZGF0ZSkgewoJCQkJCXRyeSB7CgkJCQkJCS8vIEFsbG93IHByb2dyZXNzIGhhbmRsZXIgdG8gdHJhbnNmb3JtIHByb2dyZXNzIGV2ZW50CgkJCQkJCWRlZmVycmVkLnByb2dyZXNzKG9uUHJvZ3Jlc3ModXBkYXRlKSk7CgkJCQkJfSBjYXRjaChlKSB7CgkJCQkJCS8vIFVzZSBjYXVnaHQgdmFsdWUgYXMgcHJvZ3Jlc3MKCQkJCQkJZGVmZXJyZWQucHJvZ3Jlc3MoZSk7CgkJCQkJfQoJCQkJfQoJCQkJOiBmdW5jdGlvbih1cGRhdGUpIHsgZGVmZXJyZWQucHJvZ3Jlc3ModXBkYXRlKTsgfTsKCgkJCWhhbmRsZXJzLnB1c2goZnVuY3Rpb24ocHJvbWlzZSkgewoJCQkJcHJvbWlzZS50aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKQoJCQkJCS50aGVuKGRlZmVycmVkLnJlc29sdmUsIGRlZmVycmVkLnJlamVjdCwgcHJvZ3Jlc3NIYW5kbGVyKTsKCQkJfSk7CgoJCQlwcm9ncmVzc0hhbmRsZXJzLnB1c2gocHJvZ3Jlc3NIYW5kbGVyKTsKCgkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlOwoJCX07CgoJCS8qKgoJCSAqIElzc3VlIGEgcHJvZ3Jlc3MgZXZlbnQsIG5vdGlmeWluZyBhbGwgcHJvZ3Jlc3MgbGlzdGVuZXJzCgkJICogQHByaXZhdGUKCQkgKiBAcGFyYW0geyp9IHVwZGF0ZSBwcm9ncmVzcyBldmVudCBwYXlsb2FkIHRvIHBhc3MgdG8gYWxsIGxpc3RlbmVycwoJCSAqLwoJCV9wcm9ncmVzcyA9IGZ1bmN0aW9uKHVwZGF0ZSkgewoJCQlwcm9jZXNzUXVldWUocHJvZ3Jlc3NIYW5kbGVycywgdXBkYXRlKTsKCQkJcmV0dXJuIHVwZGF0ZTsKCQl9OwoKCQkvKioKCQkgKiBUcmFuc2l0aW9uIGZyb20gcHJlLXJlc29sdXRpb24gc3RhdGUgdG8gcG9zdC1yZXNvbHV0aW9uIHN0YXRlLCBub3RpZnlpbmcKCQkgKiBhbGwgbGlzdGVuZXJzIG9mIHRoZSByZXNvbHV0aW9uIG9yIHJlamVjdGlvbgoJCSAqIEBwcml2YXRlCgkJICogQHBhcmFtIHsqfSB2YWx1ZSB0aGUgdmFsdWUgb2YgdGhpcyBkZWZlcnJlZAoJCSAqLwoJCV9yZXNvbHZlID0gZnVuY3Rpb24odmFsdWUpIHsKCQkJdmFsdWUgPSByZXNvbHZlKHZhbHVlKTsKCgkJCS8vIFJlcGxhY2UgX3RoZW4gd2l0aCBvbmUgdGhhdCBkaXJlY3RseSBub3RpZmllcyB3aXRoIHRoZSByZXN1bHQuCgkJCV90aGVuID0gdmFsdWUudGhlbjsKCQkJLy8gUmVwbGFjZSBfcmVzb2x2ZSBzbyB0aGF0IHRoaXMgRGVmZXJyZWQgY2FuIG9ubHkgYmUgcmVzb2x2ZWQgb25jZQoJCQlfcmVzb2x2ZSA9IHJlc29sdmU7CgkJCS8vIE1ha2UgX3Byb2dyZXNzIGEgbm9vcCwgdG8gZGlzYWxsb3cgcHJvZ3Jlc3MgZm9yIHRoZSByZXNvbHZlZCBwcm9taXNlLgoJCQlfcHJvZ3Jlc3MgPSBub29wOwoKCQkJLy8gTm90aWZ5IGhhbmRsZXJzCgkJCXByb2Nlc3NRdWV1ZShoYW5kbGVycywgdmFsdWUpOwoKCQkJLy8gRnJlZSBwcm9ncmVzc0hhbmRsZXJzIGFycmF5IHNpbmNlIHdlJ2xsIG5ldmVyIGlzc3VlIHByb2dyZXNzIGV2ZW50cwoJCQlwcm9ncmVzc0hhbmRsZXJzID0gaGFuZGxlcnMgPSB1bmRlZjsKCgkJCXJldHVybiB2YWx1ZTsKCQl9OwoKCQlyZXR1cm4gZGVmZXJyZWQ7CgoJCS8qKgoJCSAqIFdyYXBwZXIgdG8gYWxsb3cgX3RoZW4gdG8gYmUgcmVwbGFjZWQgc2FmZWx5CgkJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvbkZ1bGZpbGxlZF0gcmVzb2x1dGlvbiBoYW5kbGVyCgkJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblJlamVjdGVkXSByZWplY3Rpb24gaGFuZGxlcgoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25Qcm9ncmVzc10gcHJvZ3Jlc3MgaGFuZGxlcgoJCSAqIEByZXR1cm4ge1Byb21pc2V9IG5ldyBwcm9taXNlCgkJICovCgkJZnVuY3Rpb24gdGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcykgewoJCQkvLyBUT0RPOiBQcm9taXNlcy9BKyBjaGVjayB0eXBlb2Ygb25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MKCQkJcmV0dXJuIF90aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKTsKCQl9CgoJCS8qKgoJCSAqIFdyYXBwZXIgdG8gYWxsb3cgX3Jlc29sdmUgdG8gYmUgcmVwbGFjZWQKCQkgKi8KCQlmdW5jdGlvbiBwcm9taXNlUmVzb2x2ZSh2YWwpIHsKCQkJcmV0dXJuIF9yZXNvbHZlKHZhbCk7CgkJfQoKCQkvKioKCQkgKiBXcmFwcGVyIHRvIGFsbG93IF9yZWplY3QgdG8gYmUgcmVwbGFjZWQKCQkgKi8KCQlmdW5jdGlvbiBwcm9taXNlUmVqZWN0KGVycikgewoJCQlyZXR1cm4gX3Jlc29sdmUocmVqZWN0ZWQoZXJyKSk7CgkJfQoKCQkvKioKCQkgKiBXcmFwcGVyIHRvIGFsbG93IF9wcm9ncmVzcyB0byBiZSByZXBsYWNlZAoJCSAqLwoJCWZ1bmN0aW9uIHByb21pc2VQcm9ncmVzcyh1cGRhdGUpIHsKCQkJcmV0dXJuIF9wcm9ncmVzcyh1cGRhdGUpOwoJCX0KCX0KCgkvKioKCSAqIERldGVybWluZXMgaWYgcHJvbWlzZU9yVmFsdWUgaXMgYSBwcm9taXNlIG9yIG5vdC4gIFVzZXMgdGhlIGZlYXR1cmUKCSAqIHRlc3QgZnJvbSBodHRwOi8vd2lraS5jb21tb25qcy5vcmcvd2lraS9Qcm9taXNlcy9BIHRvIGRldGVybWluZSBpZgoJICogcHJvbWlzZU9yVmFsdWUgaXMgYSBwcm9taXNlLgoJICoKCSAqIEBwYXJhbSB7Kn0gcHJvbWlzZU9yVmFsdWUgYW55dGhpbmcKCSAqIEByZXR1cm5zIHtib29sZWFufSB0cnVlIGlmIHByb21pc2VPclZhbHVlIGlzIGEge0BsaW5rIFByb21pc2V9CgkgKi8KCWZ1bmN0aW9uIGlzUHJvbWlzZShwcm9taXNlT3JWYWx1ZSkgewoJCXJldHVybiBwcm9taXNlT3JWYWx1ZSAmJiB0eXBlb2YgcHJvbWlzZU9yVmFsdWUudGhlbiA9PT0gJ2Z1bmN0aW9uJzsKCX0KCgkvKioKCSAqIEluaXRpYXRlcyBhIGNvbXBldGl0aXZlIHJhY2UsIHJldHVybmluZyBhIHByb21pc2UgdGhhdCB3aWxsIHJlc29sdmUgd2hlbgoJICogaG93TWFueSBvZiB0aGUgc3VwcGxpZWQgcHJvbWlzZXNPclZhbHVlcyBoYXZlIHJlc29sdmVkLCBvciB3aWxsIHJlamVjdCB3aGVuCgkgKiBpdCBiZWNvbWVzIGltcG9zc2libGUgZm9yIGhvd01hbnkgdG8gcmVzb2x2ZSwgZm9yIGV4YW1wbGUsIHdoZW4KCSAqIChwcm9taXNlc09yVmFsdWVzLmxlbmd0aCAtIGhvd01hbnkpICsgMSBpbnB1dCBwcm9taXNlcyByZWplY3QuCgkgKgoJICogQHBhcmFtIHtBcnJheX0gcHJvbWlzZXNPclZhbHVlcyBhcnJheSBvZiBhbnl0aGluZywgbWF5IGNvbnRhaW4gYSBtaXgKCSAqICAgICAgb2YgcHJvbWlzZXMgYW5kIHZhbHVlcwoJICogQHBhcmFtIGhvd01hbnkge251bWJlcn0gbnVtYmVyIG9mIHByb21pc2VzT3JWYWx1ZXMgdG8gcmVzb2x2ZQoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvbkZ1bGZpbGxlZF0gcmVzb2x1dGlvbiBoYW5kbGVyCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUmVqZWN0ZWRdIHJlamVjdGlvbiBoYW5kbGVyCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUHJvZ3Jlc3NdIHByb2dyZXNzIGhhbmRsZXIKCSAqIEByZXR1cm5zIHtQcm9taXNlfSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIHRvIGFuIGFycmF5IG9mIGhvd01hbnkgdmFsdWVzIHRoYXQKCSAqIHJlc29sdmVkIGZpcnN0LCBvciB3aWxsIHJlamVjdCB3aXRoIGFuIGFycmF5IG9mIChwcm9taXNlc09yVmFsdWVzLmxlbmd0aCAtIGhvd01hbnkpICsgMQoJICogcmVqZWN0aW9uIHJlYXNvbnMuCgkgKi8KCWZ1bmN0aW9uIHNvbWUocHJvbWlzZXNPclZhbHVlcywgaG93TWFueSwgb25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MpIHsKCgkJY2hlY2tDYWxsYmFja3MoMiwgYXJndW1lbnRzKTsKCgkJcmV0dXJuIHdoZW4ocHJvbWlzZXNPclZhbHVlcywgZnVuY3Rpb24ocHJvbWlzZXNPclZhbHVlcykgewoKCQkJdmFyIHRvUmVzb2x2ZSwgdG9SZWplY3QsIHZhbHVlcywgcmVhc29ucywgZGVmZXJyZWQsIGZ1bGZpbGxPbmUsIHJlamVjdE9uZSwgcHJvZ3Jlc3MsIGxlbiwgaTsKCgkJCWxlbiA9IHByb21pc2VzT3JWYWx1ZXMubGVuZ3RoID4+PiAwOwoKCQkJdG9SZXNvbHZlID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oaG93TWFueSwgbGVuKSk7CgkJCXZhbHVlcyA9IFtdOwoKCQkJdG9SZWplY3QgPSAobGVuIC0gdG9SZXNvbHZlKSArIDE7CgkJCXJlYXNvbnMgPSBbXTsKCgkJCWRlZmVycmVkID0gZGVmZXIoKTsKCgkJCS8vIE5vIGl0ZW1zIGluIHRoZSBpbnB1dCwgcmVzb2x2ZSBpbW1lZGlhdGVseQoJCQlpZiAoIXRvUmVzb2x2ZSkgewoJCQkJZGVmZXJyZWQucmVzb2x2ZSh2YWx1ZXMpOwoKCQkJfSBlbHNlIHsKCQkJCXByb2dyZXNzID0gZGVmZXJyZWQucHJvZ3Jlc3M7CgoJCQkJcmVqZWN0T25lID0gZnVuY3Rpb24ocmVhc29uKSB7CgkJCQkJcmVhc29ucy5wdXNoKHJlYXNvbik7CgkJCQkJaWYoIS0tdG9SZWplY3QpIHsKCQkJCQkJZnVsZmlsbE9uZSA9IHJlamVjdE9uZSA9IG5vb3A7CgkJCQkJCWRlZmVycmVkLnJlamVjdChyZWFzb25zKTsKCQkJCQl9CgkJCQl9OwoKCQkJCWZ1bGZpbGxPbmUgPSBmdW5jdGlvbih2YWwpIHsKCQkJCQkvLyBUaGlzIG9yZGVycyB0aGUgdmFsdWVzIGJhc2VkIG9uIHByb21pc2UgcmVzb2x1dGlvbiBvcmRlcgoJCQkJCS8vIEFub3RoZXIgc3RyYXRlZ3kgd291bGQgYmUgdG8gdXNlIHRoZSBvcmlnaW5hbCBwb3NpdGlvbiBvZgoJCQkJCS8vIHRoZSBjb3JyZXNwb25kaW5nIHByb21pc2UuCgkJCQkJdmFsdWVzLnB1c2godmFsKTsKCgkJCQkJaWYgKCEtLXRvUmVzb2x2ZSkgewoJCQkJCQlmdWxmaWxsT25lID0gcmVqZWN0T25lID0gbm9vcDsKCQkJCQkJZGVmZXJyZWQucmVzb2x2ZSh2YWx1ZXMpOwoJCQkJCX0KCQkJCX07CgoJCQkJZm9yKGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKCQkJCQlpZihpIGluIHByb21pc2VzT3JWYWx1ZXMpIHsKCQkJCQkJd2hlbihwcm9taXNlc09yVmFsdWVzW2ldLCBmdWxmaWxsZXIsIHJlamVjdGVyLCBwcm9ncmVzcyk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gZGVmZXJyZWQudGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcyk7CgoJCQlmdW5jdGlvbiByZWplY3RlcihyZWFzb24pIHsKCQkJCXJlamVjdE9uZShyZWFzb24pOwoJCQl9CgoJCQlmdW5jdGlvbiBmdWxmaWxsZXIodmFsKSB7CgkJCQlmdWxmaWxsT25lKHZhbCk7CgkJCX0KCgkJfSk7Cgl9CgoJLyoqCgkgKiBJbml0aWF0ZXMgYSBjb21wZXRpdGl2ZSByYWNlLCByZXR1cm5pbmcgYSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIHdoZW4KCSAqIGFueSBvbmUgb2YgdGhlIHN1cHBsaWVkIHByb21pc2VzT3JWYWx1ZXMgaGFzIHJlc29sdmVkIG9yIHdpbGwgcmVqZWN0IHdoZW4KCSAqICphbGwqIHByb21pc2VzT3JWYWx1ZXMgaGF2ZSByZWplY3RlZC4KCSAqCgkgKiBAcGFyYW0ge0FycmF5fFByb21pc2V9IHByb21pc2VzT3JWYWx1ZXMgYXJyYXkgb2YgYW55dGhpbmcsIG1heSBjb250YWluIGEgbWl4CgkgKiAgICAgIG9mIHtAbGluayBQcm9taXNlfXMgYW5kIHZhbHVlcwoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvbkZ1bGZpbGxlZF0gcmVzb2x1dGlvbiBoYW5kbGVyCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUmVqZWN0ZWRdIHJlamVjdGlvbiBoYW5kbGVyCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUHJvZ3Jlc3NdIHByb2dyZXNzIGhhbmRsZXIKCSAqIEByZXR1cm5zIHtQcm9taXNlfSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIHRvIHRoZSB2YWx1ZSB0aGF0IHJlc29sdmVkIGZpcnN0LCBvcgoJICogd2lsbCByZWplY3Qgd2l0aCBhbiBhcnJheSBvZiBhbGwgcmVqZWN0ZWQgaW5wdXRzLgoJICovCglmdW5jdGlvbiBhbnkocHJvbWlzZXNPclZhbHVlcywgb25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MpIHsKCgkJZnVuY3Rpb24gdW53cmFwU2luZ2xlUmVzdWx0KHZhbCkgewoJCQlyZXR1cm4gb25GdWxmaWxsZWQgPyBvbkZ1bGZpbGxlZCh2YWxbMF0pIDogdmFsWzBdOwoJCX0KCgkJcmV0dXJuIHNvbWUocHJvbWlzZXNPclZhbHVlcywgMSwgdW53cmFwU2luZ2xlUmVzdWx0LCBvblJlamVjdGVkLCBvblByb2dyZXNzKTsKCX0KCgkvKioKCSAqIFJldHVybiBhIHByb21pc2UgdGhhdCB3aWxsIHJlc29sdmUgb25seSBvbmNlIGFsbCB0aGUgc3VwcGxpZWQgcHJvbWlzZXNPclZhbHVlcwoJICogaGF2ZSByZXNvbHZlZC4gVGhlIHJlc29sdXRpb24gdmFsdWUgb2YgdGhlIHJldHVybmVkIHByb21pc2Ugd2lsbCBiZSBhbiBhcnJheQoJICogY29udGFpbmluZyB0aGUgcmVzb2x1dGlvbiB2YWx1ZXMgb2YgZWFjaCBvZiB0aGUgcHJvbWlzZXNPclZhbHVlcy4KCSAqIEBtZW1iZXJPZiB3aGVuCgkgKgoJICogQHBhcmFtIHtBcnJheXxQcm9taXNlfSBwcm9taXNlc09yVmFsdWVzIGFycmF5IG9mIGFueXRoaW5nLCBtYXkgY29udGFpbiBhIG1peAoJICogICAgICBvZiB7QGxpbmsgUHJvbWlzZX1zIGFuZCB2YWx1ZXMKCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRdIHJlc29sdXRpb24gaGFuZGxlcgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblJlamVjdGVkXSByZWplY3Rpb24gaGFuZGxlcgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblByb2dyZXNzXSBwcm9ncmVzcyBoYW5kbGVyCgkgKiBAcmV0dXJucyB7UHJvbWlzZX0KCSAqLwoJZnVuY3Rpb24gYWxsKHByb21pc2VzT3JWYWx1ZXMsIG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKSB7CgkJY2hlY2tDYWxsYmFja3MoMSwgYXJndW1lbnRzKTsKCQlyZXR1cm4gbWFwKHByb21pc2VzT3JWYWx1ZXMsIGlkZW50aXR5KS50aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKTsKCX0KCgkvKioKCSAqIEpvaW5zIG11bHRpcGxlIHByb21pc2VzIGludG8gYSBzaW5nbGUgcmV0dXJuZWQgcHJvbWlzZS4KCSAqIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSB0aGF0IHdpbGwgZnVsZmlsbCB3aGVuICphbGwqIHRoZSBpbnB1dCBwcm9taXNlcwoJICogaGF2ZSBmdWxmaWxsZWQsIG9yIHdpbGwgcmVqZWN0IHdoZW4gKmFueSBvbmUqIG9mIHRoZSBpbnB1dCBwcm9taXNlcyByZWplY3RzLgoJICovCglmdW5jdGlvbiBqb2luKC8qIC4uLnByb21pc2VzICovKSB7CgkJcmV0dXJuIG1hcChhcmd1bWVudHMsIGlkZW50aXR5KTsKCX0KCgkvKioKCSAqIFRyYWRpdGlvbmFsIG1hcCBmdW5jdGlvbiwgc2ltaWxhciB0byBgQXJyYXkucHJvdG90eXBlLm1hcCgpYCwgYnV0IGFsbG93cwoJICogaW5wdXQgdG8gY29udGFpbiB7QGxpbmsgUHJvbWlzZX1zIGFuZC9vciB2YWx1ZXMsIGFuZCBtYXBGdW5jIG1heSByZXR1cm4KCSAqIGVpdGhlciBhIHZhbHVlIG9yIGEge0BsaW5rIFByb21pc2V9CgkgKgoJICogQHBhcmFtIHtBcnJheXxQcm9taXNlfSBwcm9taXNlIGFycmF5IG9mIGFueXRoaW5nLCBtYXkgY29udGFpbiBhIG1peAoJICogICAgICBvZiB7QGxpbmsgUHJvbWlzZX1zIGFuZCB2YWx1ZXMKCSAqIEBwYXJhbSB7ZnVuY3Rpb259IG1hcEZ1bmMgbWFwcGluZyBmdW5jdGlvbiBtYXBGdW5jKHZhbHVlKSB3aGljaCBtYXkgcmV0dXJuCgkgKiAgICAgIGVpdGhlciBhIHtAbGluayBQcm9taXNlfSBvciB2YWx1ZQoJICogQHJldHVybnMge1Byb21pc2V9IGEge0BsaW5rIFByb21pc2V9IHRoYXQgd2lsbCByZXNvbHZlIHRvIGFuIGFycmF5IGNvbnRhaW5pbmcKCSAqICAgICAgdGhlIG1hcHBlZCBvdXRwdXQgdmFsdWVzLgoJICovCglmdW5jdGlvbiBtYXAocHJvbWlzZSwgbWFwRnVuYykgewoJCXJldHVybiB3aGVuKHByb21pc2UsIGZ1bmN0aW9uKGFycmF5KSB7CgkJCXZhciByZXN1bHRzLCBsZW4sIHRvUmVzb2x2ZSwgcmVzb2x2ZSwgaSwgZDsKCgkJCS8vIFNpbmNlIHdlIGtub3cgdGhlIHJlc3VsdGluZyBsZW5ndGgsIHdlIGNhbiBwcmVhbGxvY2F0ZSB0aGUgcmVzdWx0cwoJCQkvLyBhcnJheSB0byBhdm9pZCBhcnJheSBleHBhbnNpb25zLgoJCQl0b1Jlc29sdmUgPSBsZW4gPSBhcnJheS5sZW5ndGggPj4+IDA7CgkJCXJlc3VsdHMgPSBbXTsKCQkJZCA9IGRlZmVyKCk7CgoJCQlpZighdG9SZXNvbHZlKSB7CgkJCQlkLnJlc29sdmUocmVzdWx0cyk7CgkJCX0gZWxzZSB7CgoJCQkJcmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmVPbmUoaXRlbSwgaSkgewoJCQkJCXdoZW4oaXRlbSwgbWFwRnVuYykudGhlbihmdW5jdGlvbihtYXBwZWQpIHsKCQkJCQkJcmVzdWx0c1tpXSA9IG1hcHBlZDsKCgkJCQkJCWlmKCEtLXRvUmVzb2x2ZSkgewoJCQkJCQkJZC5yZXNvbHZlKHJlc3VsdHMpOwoJCQkJCQl9CgkJCQkJfSwgZC5yZWplY3QpOwoJCQkJfTsKCgkJCQkvLyBTaW5jZSBtYXBGdW5jIG1heSBiZSBhc3luYywgZ2V0IGFsbCBpbnZvY2F0aW9ucyBvZiBpdCBpbnRvIGZsaWdodAoJCQkJZm9yKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKCQkJCQlpZihpIGluIGFycmF5KSB7CgkJCQkJCXJlc29sdmUoYXJyYXlbaV0sIGkpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCS0tdG9SZXNvbHZlOwoJCQkJCX0KCQkJCX0KCgkJCX0KCgkJCXJldHVybiBkLnByb21pc2U7CgoJCX0pOwoJfQoKCS8qKgoJICogVHJhZGl0aW9uYWwgcmVkdWNlIGZ1bmN0aW9uLCBzaW1pbGFyIHRvIGBBcnJheS5wcm90b3R5cGUucmVkdWNlKClgLCBidXQKCSAqIGlucHV0IG1heSBjb250YWluIHByb21pc2VzIGFuZC9vciB2YWx1ZXMsIGFuZCByZWR1Y2VGdW5jCgkgKiBtYXkgcmV0dXJuIGVpdGhlciBhIHZhbHVlIG9yIGEgcHJvbWlzZSwgKmFuZCogaW5pdGlhbFZhbHVlIG1heQoJICogYmUgYSBwcm9taXNlIGZvciB0aGUgc3RhcnRpbmcgdmFsdWUuCgkgKgoJICogQHBhcmFtIHtBcnJheXxQcm9taXNlfSBwcm9taXNlIGFycmF5IG9yIHByb21pc2UgZm9yIGFuIGFycmF5IG9mIGFueXRoaW5nLAoJICogICAgICBtYXkgY29udGFpbiBhIG1peCBvZiBwcm9taXNlcyBhbmQgdmFsdWVzLgoJICogQHBhcmFtIHtmdW5jdGlvbn0gcmVkdWNlRnVuYyByZWR1Y2UgZnVuY3Rpb24gcmVkdWNlKGN1cnJlbnRWYWx1ZSwgbmV4dFZhbHVlLCBpbmRleCwgdG90YWwpLAoJICogICAgICB3aGVyZSB0b3RhbCBpcyB0aGUgdG90YWwgbnVtYmVyIG9mIGl0ZW1zIGJlaW5nIHJlZHVjZWQsIGFuZCB3aWxsIGJlIHRoZSBzYW1lCgkgKiAgICAgIGluIGVhY2ggY2FsbCB0byByZWR1Y2VGdW5jLgoJICogQHJldHVybnMge1Byb21pc2V9IHRoYXQgd2lsbCByZXNvbHZlIHRvIHRoZSBmaW5hbCByZWR1Y2VkIHZhbHVlCgkgKi8KCWZ1bmN0aW9uIHJlZHVjZShwcm9taXNlLCByZWR1Y2VGdW5jIC8qLCBpbml0aWFsVmFsdWUgKi8pIHsKCQl2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCgkJcmV0dXJuIHdoZW4ocHJvbWlzZSwgZnVuY3Rpb24oYXJyYXkpIHsKCQkJdmFyIHRvdGFsOwoKCQkJdG90YWwgPSBhcnJheS5sZW5ndGg7CgoJCQkvLyBXcmFwIHRoZSBzdXBwbGllZCByZWR1Y2VGdW5jIHdpdGggb25lIHRoYXQgaGFuZGxlcyBwcm9taXNlcyBhbmQgdGhlbgoJCQkvLyBkZWxlZ2F0ZXMgdG8gdGhlIHN1cHBsaWVkLgoJCQlhcmdzWzBdID0gZnVuY3Rpb24gKGN1cnJlbnQsIHZhbCwgaSkgewoJCQkJcmV0dXJuIHdoZW4oY3VycmVudCwgZnVuY3Rpb24gKGMpIHsKCQkJCQlyZXR1cm4gd2hlbih2YWwsIGZ1bmN0aW9uICh2YWx1ZSkgewoJCQkJCQlyZXR1cm4gcmVkdWNlRnVuYyhjLCB2YWx1ZSwgaSwgdG90YWwpOwoJCQkJCX0pOwoJCQkJfSk7CgkJCX07CgoJCQlyZXR1cm4gcmVkdWNlQXJyYXkuYXBwbHkoYXJyYXksIGFyZ3MpOwoJCX0pOwoJfQoKCS8qKgoJICogRW5zdXJlIHRoYXQgcmVzb2x1dGlvbiBvZiBwcm9taXNlT3JWYWx1ZSB3aWxsIHRyaWdnZXIgcmVzb2x2ZXIgd2l0aCB0aGUKCSAqIHZhbHVlIG9yIHJlYXNvbiBvZiBwcm9taXNlT3JWYWx1ZSwgb3IgaW5zdGVhZCB3aXRoIHJlc29sdmVWYWx1ZSBpZiBpdCBpcyBwcm92aWRlZC4KCSAqCgkgKiBAcGFyYW0gcHJvbWlzZU9yVmFsdWUKCSAqIEBwYXJhbSB7T2JqZWN0fSByZXNvbHZlcgoJICogQHBhcmFtIHtmdW5jdGlvbn0gcmVzb2x2ZXIucmVzb2x2ZQoJICogQHBhcmFtIHtmdW5jdGlvbn0gcmVzb2x2ZXIucmVqZWN0CgkgKiBAcGFyYW0geyp9IFtyZXNvbHZlVmFsdWVdCgkgKiBAcmV0dXJucyB7UHJvbWlzZX0KCSAqLwoJZnVuY3Rpb24gY2hhaW4ocHJvbWlzZU9yVmFsdWUsIHJlc29sdmVyLCByZXNvbHZlVmFsdWUpIHsKCQl2YXIgdXNlUmVzb2x2ZVZhbHVlID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CgoJCXJldHVybiB3aGVuKHByb21pc2VPclZhbHVlLAoJCQlmdW5jdGlvbih2YWwpIHsKCQkJCXZhbCA9IHVzZVJlc29sdmVWYWx1ZSA/IHJlc29sdmVWYWx1ZSA6IHZhbDsKCQkJCXJlc29sdmVyLnJlc29sdmUodmFsKTsKCQkJCXJldHVybiB2YWw7CgkJCX0sCgkJCWZ1bmN0aW9uKHJlYXNvbikgewoJCQkJcmVzb2x2ZXIucmVqZWN0KHJlYXNvbik7CgkJCQlyZXR1cm4gcmVqZWN0ZWQocmVhc29uKTsKCQkJfSwKCQkJcmVzb2x2ZXIucHJvZ3Jlc3MKCQkpOwoJfQoKCS8vCgkvLyBVdGlsaXR5IGZ1bmN0aW9ucwoJLy8KCgkvKioKCSAqIEFwcGx5IGFsbCBmdW5jdGlvbnMgaW4gcXVldWUgdG8gdmFsdWUKCSAqIEBwYXJhbSB7QXJyYXl9IHF1ZXVlIGFycmF5IG9mIGZ1bmN0aW9ucyB0byBleGVjdXRlCgkgKiBAcGFyYW0geyp9IHZhbHVlIGFyZ3VtZW50IHBhc3NlZCB0byBlYWNoIGZ1bmN0aW9uCgkgKi8KCWZ1bmN0aW9uIHByb2Nlc3NRdWV1ZShxdWV1ZSwgdmFsdWUpIHsKCQl2YXIgaGFuZGxlciwgaSA9IDA7CgoJCXdoaWxlIChoYW5kbGVyID0gcXVldWVbaSsrXSkgewoJCQloYW5kbGVyKHZhbHVlKTsKCQl9Cgl9CgoJLyoqCgkgKiBIZWxwZXIgdGhhdCBjaGVja3MgYXJyYXlPZkNhbGxiYWNrcyB0byBlbnN1cmUgdGhhdCBlYWNoIGVsZW1lbnQgaXMgZWl0aGVyCgkgKiBhIGZ1bmN0aW9uLCBvciBudWxsIG9yIHVuZGVmaW5lZC4KCSAqIEBwcml2YXRlCgkgKiBAcGFyYW0ge251bWJlcn0gc3RhcnQgaW5kZXggYXQgd2hpY2ggdG8gc3RhcnQgY2hlY2tpbmcgaXRlbXMgaW4gYXJyYXlPZkNhbGxiYWNrcwoJICogQHBhcmFtIHtBcnJheX0gYXJyYXlPZkNhbGxiYWNrcyBhcnJheSB0byBjaGVjawoJICogQHRocm93cyB7RXJyb3J9IGlmIGFueSBlbGVtZW50IG9mIGFycmF5T2ZDYWxsYmFja3MgaXMgc29tZXRoaW5nIG90aGVyIHRoYW4KCSAqIGEgZnVuY3Rpb25zLCBudWxsLCBvciB1bmRlZmluZWQuCgkgKi8KCWZ1bmN0aW9uIGNoZWNrQ2FsbGJhY2tzKHN0YXJ0LCBhcnJheU9mQ2FsbGJhY2tzKSB7CgkJLy8gVE9ETzogUHJvbWlzZXMvQSsgdXBkYXRlIHR5cGUgY2hlY2tpbmcgYW5kIGRvY3MKCQl2YXIgYXJnLCBpID0gYXJyYXlPZkNhbGxiYWNrcy5sZW5ndGg7CgoJCXdoaWxlKGkgPiBzdGFydCkgewoJCQlhcmcgPSBhcnJheU9mQ2FsbGJhY2tzWy0taV07CgoJCQlpZiAoYXJnICE9IG51bGwgJiYgdHlwZW9mIGFyZyAhPSAnZnVuY3Rpb24nKSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoJ2FyZyAnK2krJyBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKCQkJfQoJCX0KCX0KCgkvKioKCSAqIE5vLU9wIGZ1bmN0aW9uIHVzZWQgaW4gbWV0aG9kIHJlcGxhY2VtZW50CgkgKiBAcHJpdmF0ZQoJICovCglmdW5jdGlvbiBub29wKCkge30KCglzbGljZSA9IFtdLnNsaWNlOwoKCS8vIEVTNSByZWR1Y2UgaW1wbGVtZW50YXRpb24gaWYgbmF0aXZlIG5vdCBhdmFpbGFibGUKCS8vIFNlZTogaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuNC40LjIxIGFzIHRoZXJlIGFyZSBtYW55CgkvLyBzcGVjaWZpY3MgYW5kIGVkZ2UgY2FzZXMuCglyZWR1Y2VBcnJheSA9IFtdLnJlZHVjZSB8fAoJCWZ1bmN0aW9uKHJlZHVjZUZ1bmMgLyosIGluaXRpYWxWYWx1ZSAqLykgewoJCQkvKmpzaGludCBtYXhjb21wbGV4aXR5OiA3Ki8KCgkJCS8vIEVTNSBkaWN0YXRlcyB0aGF0IHJlZHVjZS5sZW5ndGggPT09IDEKCgkJCS8vIFRoaXMgaW1wbGVtZW50YXRpb24gZGV2aWF0ZXMgZnJvbSBFUzUgc3BlYyBpbiB0aGUgZm9sbG93aW5nIHdheXM6CgkJCS8vIDEuIEl0IGRvZXMgbm90IGNoZWNrIGlmIHJlZHVjZUZ1bmMgaXMgYSBDYWxsYWJsZQoKCQkJdmFyIGFyciwgYXJncywgcmVkdWNlZCwgbGVuLCBpOwoKCQkJaSA9IDA7CgkJCS8vIFRoaXMgZ2VuZXJhdGVzIGEganNoaW50IHdhcm5pbmcsIGRlc3BpdGUgYmVpbmcgdmFsaWQKCQkJLy8gIk1pc3NpbmcgJ25ldycgcHJlZml4IHdoZW4gaW52b2tpbmcgYSBjb25zdHJ1Y3Rvci4iCgkJCS8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanNoaW50L2pzaGludC9pc3N1ZXMvMzkyCgkJCWFyciA9IE9iamVjdCh0aGlzKTsKCQkJbGVuID0gYXJyLmxlbmd0aCA+Pj4gMDsKCQkJYXJncyA9IGFyZ3VtZW50czsKCgkJCS8vIElmIG5vIGluaXRpYWxWYWx1ZSwgdXNlIGZpcnN0IGl0ZW0gb2YgYXJyYXkgKHdlIGtub3cgbGVuZ3RoICE9PSAwIGhlcmUpCgkJCS8vIGFuZCBhZGp1c3QgaSB0byBzdGFydCBhdCBzZWNvbmQgaXRlbQoJCQlpZihhcmdzLmxlbmd0aCA8PSAxKSB7CgkJCQkvLyBTa2lwIHRvIHRoZSBmaXJzdCByZWFsIGVsZW1lbnQgaW4gdGhlIGFycmF5CgkJCQlmb3IoOzspIHsKCQkJCQlpZihpIGluIGFycikgewoJCQkJCQlyZWR1Y2VkID0gYXJyW2krK107CgkJCQkJCWJyZWFrOwoJCQkJCX0KCgkJCQkJLy8gSWYgd2UgcmVhY2hlZCB0aGUgZW5kIG9mIHRoZSBhcnJheSB3aXRob3V0IGZpbmRpbmcgYW55IHJlYWwKCQkJCQkvLyBlbGVtZW50cywgaXQncyBhIFR5cGVFcnJvcgoJCQkJCWlmKCsraSA+PSBsZW4pIHsKCQkJCQkJdGhyb3cgbmV3IFR5cGVFcnJvcigpOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCS8vIElmIGluaXRpYWxWYWx1ZSBwcm92aWRlZCwgdXNlIGl0CgkJCQlyZWR1Y2VkID0gYXJnc1sxXTsKCQkJfQoKCQkJLy8gRG8gdGhlIGFjdHVhbCByZWR1Y2UKCQkJZm9yKDtpIDwgbGVuOyArK2kpIHsKCQkJCS8vIFNraXAgaG9sZXMKCQkJCWlmKGkgaW4gYXJyKSB7CgkJCQkJcmVkdWNlZCA9IHJlZHVjZUZ1bmMocmVkdWNlZCwgYXJyW2ldLCBpLCBhcnIpOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gcmVkdWNlZDsKCQl9OwoKCWZ1bmN0aW9uIGlkZW50aXR5KHgpIHsKCQlyZXR1cm4geDsKCX0KCglyZXR1cm4gd2hlbjsKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kCgk/IGRlZmluZQoJOiBmdW5jdGlvbiAoZmFjdG9yeSkgeyB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcKCQk/IChtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKSkKCQk6ICh0aGlzLndoZW4gICAgICA9IGZhY3RvcnkoKSk7Cgl9CgkvLyBCb2lsZXJwbGF0ZSBmb3IgQU1ELCBOb2RlLCBhbmQgYnJvd3NlciBnbG9iYWwKKTsKCmRlZmluZSgnd2hlbicsIFsnd2hlbi93aGVuJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qKgogKiBhcHBseS5qcwogKiBIZWxwZXIgZm9yIHVzaW5nIGFyZ3VtZW50cy1iYXNlZCBhbmQgdmFyaWFkaWMgY2FsbGJhY2tzIHdpdGggYW55CiAqIHtAbGluayBQcm9taXNlfSB0aGF0IHJlc29sdmVzIHRvIGFuIGFycmF5LgogKgogKiBAYXV0aG9yIGJyaWFuQGhvdmVyY3JhZnRzdHVkaW9zLmNvbQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL2FwcGx5JyxbXSxmdW5jdGlvbigpIHsKCiAgICB2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogICAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYSBmdW5jdGlvbiB0aGF0IHRha2VzIGluZGl2aWR1YWwKICAgICAqIGFyZ3VtZW50cyAoaXQgY2FuIGJlIHZhcmlhZGljLCB0b28pLCBhbmQgcmV0dXJucyBhIG5ldyBmdW5jdGlvbiB0aGF0CiAgICAgKiB0YWtlcyBhIHNpbmdsZSBhcnJheSBhcyBpdHMgb25seSBwYXJhbToKICAgICAqCiAgICAgKiBmdW5jdGlvbiBhcmdCYXNlZChhLCBiLCBjKSB7CiAgICAgKiAgIHJldHVybiBhICsgYiArIGM7CiAgICAgKiB9CiAgICAgKgogICAgICogYXJnQmFzZWQoMSwgMiwgMyk7IC8vIDYKICAgICAqCiAgICAgKiAvLyBDcmVhdGUgYW4gYXJyYXktYmFzZWQgdmVyc2lvbiBvZiBhcmdCYXNlZAogICAgICogdmFyIGFycmF5QmFzZWQgPSBhcHBseShhcmdCYXNlZCk7CiAgICAgKiB2YXIgaW5wdXRzID0gWzEsIDIsIDNdOwogICAgICoKICAgICAqIGFycmF5QmFzZWQoaW5wdXRzKTsgLy8gNgogICAgICoKICAgICAqIFdpdGggcHJvbWlzZXM6CiAgICAgKgogICAgICogdmFyIGQgPSB3aGVuLmRlZmVyKCk7CiAgICAgKiBkLnByb21pc2UudGhlbihhcnJheUJhc2VkKTsKICAgICAqCiAgICAgKiBkLnJlc29sdmUoWzEsIDIsIDNdKTsgLy8gYXJyYXlCYXNlZCBjYWxsZWQgd2l0aCBhcmdzIDEsIDIsIDMgLT4gNgogICAgICoKICAgICAqIEBwYXJhbSBmIHtGdW5jdGlvbn0gYXJndW1lbnRzLWJhc2VkIGZ1bmN0aW9uCiAgICAgKgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBhIG5ldyBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYW4gYXJyYXkKICAgICAqLwogICAgcmV0dXJuIGZ1bmN0aW9uKGYpIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0gYXJyYXkge0FycmF5fSBtdXN0IGJlIGFuIGFycmF5IG9mIGFyZ3VtZW50cyB0byB1c2UgdG8gYXBwbHkgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB0aGUgcmVzdWx0IG9mIGFwcGx5aW5nIGYgd2l0aCB0aGUgYXJndW1lbnRzIGluIGFycmF5LgogICAgICAgICAqLwogICAgICAgIHJldHVybiBmdW5jdGlvbihhcnJheSkgewogICAgICAgICAgICAvLyBJdCBiZXR0ZXIgYmUgYW4gYXJyYXkKICAgICAgICAgICAgaWYodG9TdHJpbmcuY2FsbChhcnJheSkgIT0gJ1tvYmplY3QgQXJyYXldJykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdhcHBseSBjYWxsZWQgd2l0aCBub24tYXJyYXkgYXJnJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmLmFwcGx5KG51bGwsIGFycmF5KTsKICAgICAgICB9OwogICAgfTsKCn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicKICAgID8gZGVmaW5lCiAgICA6IGZ1bmN0aW9uIChmYWN0b3J5KSB7IHR5cGVvZiBtb2R1bGUgIT0gJ3VuZGVmaW5lZCcKICAgICAgICA/IChtb2R1bGUuZXhwb3J0cyAgPSBmYWN0b3J5KCkpCiAgICAgICAgOiAodGhpcy53aGVuX2FwcGx5ID0gZmFjdG9yeSgpKTsKICAgIH0KICAgIC8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKmdsb2JhbCBzZXRUaW1lb3V0OnRydWUqLwoKLyoqCiAqIGRlbGF5LmpzCiAqCiAqIEhlbHBlciB0aGF0IHJldHVybnMgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgYWZ0ZXIgYSBkZWxheS4KICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9kZWxheScsWycuL3doZW4nXSwgZnVuY3Rpb24od2hlbikgewoKICAgIHZhciB1bmRlZjsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSBhZnRlciBhIG1zZWMgZGVsYXkuICBJZiBwcm9taXNlCiAgICAgKiBpcyBzdXBwbGllZCwgdGhlIGRlbGF5IHdpbGwgc3RhcnQgKmFmdGVyKiB0aGUgc3VwcGxpZWQgcHJvbWlzZSBpcyByZXNvbHZlZC4KICAgICAqCiAgICAgKiBVc2FnZToKICAgICAqIC8vIERvIHNvbWV0aGluZyBhZnRlciAxIHNlY29uZCwgc2ltaWxhciB0byB1c2luZyBzZXRUaW1lb3V0CiAgICAgKiBkZWxheSgxMDAwKS50aGVuKGRvU29tZXRoaW5nKTsKICAgICAqIC8vIG9yCiAgICAgKiB3aGVuKGRlbGF5KDEwMDApLCBkb1NvbWV0aGluZyk7CiAgICAgKgogICAgICogLy8gRG8gc29tZXRoaW5nIDEgc2Vjb25kIGFmdGVyIHRyaWdnZXJpbmdQcm9taXNlIHJlc29sdmVzCiAgICAgKiBkZWxheSh0cmlnZ2VyaW5nUHJvbWlzZSwgMTAwMCkudGhlbihkb1NvbWV0aGluZywgaGFuZGxlUmVqZWN0aW9uKTsKICAgICAqIC8vIG9yCiAgICAgKiB3aGVuKGRlbGF5KHRyaWdnZXJpbmdQcm9taXNlLCAxMDAwKSwgZG9Tb21ldGhpbmcsIGhhbmRsZVJlamVjdGlvbik7CiAgICAgKgogICAgICogQHBhcmFtIFtwcm9taXNlXSBhbnl0aGluZyAtIGFueSBwcm9taXNlIG9yIHZhbHVlIGFmdGVyIHdoaWNoIHRoZSBkZWxheSB3aWxsIHN0YXJ0CiAgICAgKiBAcGFyYW0gbXNlYyB7TnVtYmVyfSBkZWxheSBpbiBtaWxsaXNlY29uZHMKICAgICAqLwogICAgcmV0dXJuIGZ1bmN0aW9uIGRlbGF5KHByb21pc2UsIG1zZWMpIHsKICAgICAgICBpZihhcmd1bWVudHMubGVuZ3RoIDwgMikgewogICAgICAgICAgICBtc2VjID0gcHJvbWlzZSA+Pj4gMDsKICAgICAgICAgICAgcHJvbWlzZSA9IHVuZGVmOwogICAgICAgIH0KCiAgICAgICAgdmFyIGRlZmVycmVkID0gd2hlbi5kZWZlcigpOwoKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHByb21pc2UpOwogICAgICAgIH0sIG1zZWMpOwoKICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICAgIH07Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nCiAgICA/IGRlZmluZQogICAgOiBmdW5jdGlvbiAoZGVwcywgZmFjdG9yeSkgeyB0eXBlb2YgbW9kdWxlICE9ICd1bmRlZmluZWQnCiAgICAgICAgPyAobW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoJy4vd2hlbicpKSkKICAgICAgICA6ICh0aGlzLndoZW5fZGVsYXkgPSBmYWN0b3J5KHRoaXMud2hlbikpOwogICAgfQogICAgLy8gQm9pbGVycGxhdGUgZm9yIEFNRCwgTm9kZSwgYW5kIGJyb3dzZXIgZ2xvYmFsCik7CgoKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qZ2xvYmFsIHNldFRpbWVvdXQ6dHJ1ZSwgY2xlYXJUaW1lb3V0OnRydWUqLwoKLyoqCiAqIHRpbWVvdXQuanMKICoKICogSGVscGVyIHRoYXQgcmV0dXJucyBhIHByb21pc2UgdGhhdCByZWplY3RzIGFmdGVyIGEgc3BlY2lmaWVkIHRpbWVvdXQsCiAqIGlmIG5vdCBleHBsaWNpdGx5IHJlc29sdmVkIG9yIHJlamVjdGVkIGJlZm9yZSB0aGF0LgogKgogKiBAYXV0aG9yIGJyaWFuQGhvdmVyY3JhZnRzdHVkaW9zLmNvbQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL3RpbWVvdXQnLFsnLi93aGVuJ10sIGZ1bmN0aW9uKHdoZW4pIHsKCiAgICB2YXIgdW5kZWY7CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgbmV3IHByb21pc2UgdGhhdCB3aWxsIGF1dG9tYXRpY2FsbHkgcmVqZWN0IGFmdGVyIG1zZWMgaWYKICAgICAqIHRoZSBzdXBwbGllZCBwcm9taXNlIGRvZXNuJ3QgcmVzb2x2ZSBvciByZWplY3QgYmVmb3JlIHRoYXQuCiAgICAgKgogICAgICogVXNhZ2U6CiAgICAgKgogICAgICogdmFyIGQgPSB3aGVuLmRlZmVyKCk7CiAgICAgKiAvLyBTZXR1cCBkIGhvd2V2ZXIgeW91IG5lZWQKICAgICAqCiAgICAgKiAvLyByZXR1cm4gYSBuZXcgcHJvbWlzZSB0aGF0IHdpbGwgdGltZW91dCBpZiBkIGRvZXNuJ3QgcmVzb2x2ZS9yZWplY3QgZmlyc3QKICAgICAqIHJldHVybiB0aW1lb3V0KGQucHJvbWlzZSwgMTAwMCk7CiAgICAgKgogICAgICogQHBhcmFtIHByb21pc2UgYW55dGhpbmcgLSBhbnkgcHJvbWlzZSBvciB2YWx1ZSB0aGF0IHNob3VsZCB0cmlnZ2VyCiAgICAgKiAgdGhlIHJldHVybmVkIHByb21pc2UgdG8gcmVzb2x2ZSBvciByZWplY3QgYmVmb3JlIHRoZSBtc2VjIHRpbWVvdXQKICAgICAqIEBwYXJhbSBtc2VjIHtOdW1iZXJ9IHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzCiAgICAgKgogICAgICogQHJldHVybnMge1Byb21pc2V9CiAgICAgKi8KICAgIHJldHVybiBmdW5jdGlvbiB0aW1lb3V0KHByb21pc2UsIG1zZWMpIHsKICAgICAgICB2YXIgZGVmZXJyZWQsIHRpbWVvdXRSZWY7CgogICAgICAgIGRlZmVycmVkID0gd2hlbi5kZWZlcigpOwoKICAgICAgICB0aW1lb3V0UmVmID0gc2V0VGltZW91dChmdW5jdGlvbiBvblRpbWVvdXQoKSB7CiAgICAgICAgICAgIHRpbWVvdXRSZWYgJiYgZGVmZXJyZWQucmVqZWN0KG5ldyBFcnJvcigndGltZWQgb3V0JykpOwogICAgICAgIH0sIG1zZWMpOwoKICAgICAgICBmdW5jdGlvbiBjYW5jZWxUaW1lb3V0KCkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dFJlZik7CiAgICAgICAgICAgIHRpbWVvdXRSZWYgPSB1bmRlZjsKICAgICAgICB9CgogICAgICAgIHdoZW4ocHJvbWlzZSwKICAgICAgICAgICAgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGNhbmNlbFRpbWVvdXQoKTsKICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgICAgIGNhbmNlbFRpbWVvdXQoKTsKICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChyZWFzb24pOwogICAgICAgICAgICB9CiAgICAgICAgKTsKCiAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICB9OwoKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJwogICAgPyBkZWZpbmUKICAgIDogZnVuY3Rpb24gKGRlcHMsIGZhY3RvcnkpIHsgdHlwZW9mIG1vZHVsZSAhPSAndW5kZWZpbmVkJwogICAgICAgID8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCcuL3doZW4nKSkpCiAgICAgICAgOiAodGhpcy53aGVuX3RpbWVvdXQgPSBmYWN0b3J5KHRoaXMud2hlbikpOwogICAgfQogICAgLy8gQm9pbGVycGxhdGUgZm9yIEFNRCwgTm9kZSwgYW5kIGJyb3dzZXIgZ2xvYmFsCik7CgoKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qKgogKiBwYXJhbGxlbC5qcwogKgogKiBSdW4gYSBzZXQgb2YgdGFzayBmdW5jdGlvbnMgaW4gcGFyYWxsZWwuICBBbGwgdGFza3Mgd2lsbAogKiByZWNlaXZlIHRoZSBzYW1lIGFyZ3MKICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9wYXJhbGxlbCcsWycuL3doZW4nXSwgZnVuY3Rpb24od2hlbikgewoKCS8qKgoJICogUnVuIGFycmF5IG9mIHRhc2tzIGluIHBhcmFsbGVsCgkgKiBAcGFyYW0gdGFza3Mge0FycmF5fFByb21pc2V9IGFycmF5IG9yIHByb21pc2VGb3JBcnJheSBvZiB0YXNrIGZ1bmN0aW9ucwoJICogQHBhcmFtIFthcmdzXSB7Kn0gYXJndW1lbnRzIHRvIGJlIHBhc3NlZCB0byBhbGwgdGFza3MKCSAqIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UgZm9yIGFycmF5IGNvbnRhaW5pbmcgdGhlCgkgKiByZXN1bHQgb2YgZWFjaCB0YXNrIGluIHRoZSBhcnJheSBwb3NpdGlvbiBjb3JyZXNwb25kaW5nCgkgKiB0byBwb3NpdGlvbiBvZiB0aGUgdGFzayBpbiB0aGUgdGFza3MgYXJyYXkKCSAqLwoJcmV0dXJuIGZ1bmN0aW9uIHBhcmFsbGVsKHRhc2tzIC8qLCBhcmdzLi4uICovKSB7CgkJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoJCXJldHVybiB3aGVuLm1hcCh0YXNrcywgZnVuY3Rpb24odGFzaykgewoJCQlyZXR1cm4gdGFzay5hcHBseShudWxsLCBhcmdzKTsKCQl9KTsKCX07Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQKCT8gZGVmaW5lCgk6IGZ1bmN0aW9uIChkZXBzLCBmYWN0b3J5KSB7IHR5cGVvZiBleHBvcnRzID09ICdvYmplY3QnCgkJPyAobW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoJy4vd2hlbicpKSkKCQk6ICh0aGlzLndoZW5fcGFyYWxsZWwgPSBmYWN0b3J5KHRoaXMud2hlbikpOwoJfQoJLy8gQm9pbGVycGxhdGUgZm9yIEFNRCwgTm9kZSwgYW5kIGJyb3dzZXIgZ2xvYmFsCik7CgoKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qKgogKiBwaXBlbGluZS5qcwogKgogKiBSdW4gYSBzZXQgb2YgdGFzayBmdW5jdGlvbnMgaW4gc2VxdWVuY2UsIHBhc3NpbmcgdGhlIHJlc3VsdAogKiBvZiB0aGUgcHJldmlvdXMgYXMgYW4gYXJndW1lbnQgdG8gdGhlIG5leHQuICBMaWtlIGEgc2hlbGwKICogcGlwZWxpbmUsIGUuZy4gYGNhdCBmaWxlLnR4dCB8IGdyZXAgJ2ZvbycgfCBzZWQgLWUgJ3MvZm9vL2Jhci9nJwogKgogKiBAYXV0aG9yIGJyaWFuQGhvdmVyY3JhZnRzdHVkaW9zLmNvbQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL3BpcGVsaW5lJyxbJy4vd2hlbiddLCBmdW5jdGlvbih3aGVuKSB7CgoJLyoqCgkgKiBSdW4gYXJyYXkgb2YgdGFza3MgaW4gYSBwaXBlbGluZSB3aGVyZSB0aGUgbmV4dAoJICogdGFza3MgcmVjZWl2ZXMgdGhlIHJlc3VsdCBvZiB0aGUgcHJldmlvdXMuICBUaGUgZmlyc3QgdGFzawoJICogd2lsbCByZWNlaXZlIHRoZSBpbml0aWFsQXJncyBhcyBpdHMgYXJndW1lbnQgbGlzdC4KCSAqIEBwYXJhbSB0YXNrcyB7QXJyYXl8UHJvbWlzZX0gYXJyYXkgb3IgcHJvbWlzZSBmb3IgYXJyYXkgb2YgdGFzayBmdW5jdGlvbnMKCSAqIEBwYXJhbSBbaW5pdGlhbEFyZ3MuLi5dIHsqfSBhcmd1bWVudHMgdG8gYmUgcGFzc2VkIHRvIHRoZSBmaXJzdCB0YXNrCgkgKiBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIGZvciByZXR1cm4gdmFsdWUgb2YgdGhlIGZpbmFsIHRhc2sKCSAqLwoJcmV0dXJuIGZ1bmN0aW9uIHBpcGVsaW5lKHRhc2tzIC8qIGluaXRpYWxBcmdzLi4uICovKSB7CgkJdmFyIGluaXRpYWxBcmdzLCBydW5UYXNrOwoKCQlpbml0aWFsQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgoJCS8vIFNlbGYtb3B0aW1pemluZyBmdW5jdGlvbiB0byBydW4gZmlyc3QgdGFzayB3aXRoIG11bHRpcGxlCgkJLy8gYXJncyB1c2luZyBhcHBseSwgYnV0IHN1YnNlcXVlbmNlIHRhc2tzIHZpYSBkaXJlY3QgaW52b2NhdGlvbgoJCXJ1blRhc2sgPSBmdW5jdGlvbih0YXNrLCBhcmdzKSB7CgkJCXJ1blRhc2sgPSBmdW5jdGlvbih0YXNrLCBhcmcpIHsKCQkJCXJldHVybiB0YXNrKGFyZyk7CgkJCX07CgkJCQoJCQlyZXR1cm4gdGFzay5hcHBseShudWxsLCBhcmdzKTsKCQl9OwoKCQlyZXR1cm4gd2hlbi5yZWR1Y2UodGFza3MsCgkJCWZ1bmN0aW9uKGFyZ3MsIHRhc2spIHsKCQkJCXJldHVybiBydW5UYXNrKHRhc2ssIGFyZ3MpOwoJCQl9LAoJCQlpbml0aWFsQXJncwoJCSk7Cgl9OwoKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kCgk/IGRlZmluZQoJOiBmdW5jdGlvbiAoZGVwcywgZmFjdG9yeSkgeyB0eXBlb2YgZXhwb3J0cyA9PSAnb2JqZWN0JwoJCT8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCcuL3doZW4nKSkpCgkJOiAodGhpcy53aGVuX3BpcGVsaW5lID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKCX0KCS8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogc2VxdWVuY2UuanMKICoKICogUnVuIGEgc2V0IG9mIHRhc2sgZnVuY3Rpb25zIGluIHNlcXVlbmNlLiAgQWxsIHRhc2tzIHdpbGwKICogcmVjZWl2ZSB0aGUgc2FtZSBhcmdzLgogKgogKiBAYXV0aG9yIGJyaWFuQGhvdmVyY3JhZnRzdHVkaW9zLmNvbQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL3NlcXVlbmNlJyxbJy4vd2hlbiddLCBmdW5jdGlvbih3aGVuKSB7CgoJLyoqCgkgKiBSdW4gYXJyYXkgb2YgdGFza3MgaW4gc2VxdWVuY2Ugd2l0aCBubyBvdmVybGFwCgkgKiBAcGFyYW0gdGFza3Mge0FycmF5fFByb21pc2V9IGFycmF5IG9yIHByb21pc2VGb3JBcnJheSBvZiB0YXNrIGZ1bmN0aW9ucwoJICogQHBhcmFtIFthcmdzXSB7Kn0gYXJndW1lbnRzIHRvIGJlIHBhc3NlZCB0byBhbGwgdGFza3MKCSAqIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UgZm9yIGFuIGFycmF5IGNvbnRhaW5pbmcKCSAqIHRoZSByZXN1bHQgb2YgZWFjaCB0YXNrIGluIHRoZSBhcnJheSBwb3NpdGlvbiBjb3JyZXNwb25kaW5nCgkgKiB0byBwb3NpdGlvbiBvZiB0aGUgdGFzayBpbiB0aGUgdGFza3MgYXJyYXkKCSAqLwoJcmV0dXJuIGZ1bmN0aW9uIHNlcXVlbmNlKHRhc2tzIC8qLCBhcmdzLi4uICovKSB7CgkJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoJCXJldHVybiB3aGVuLnJlZHVjZSh0YXNrcywgZnVuY3Rpb24ocmVzdWx0cywgdGFzaykgewoJCQlyZXR1cm4gd2hlbih0YXNrLmFwcGx5KG51bGwsIGFyZ3MpLCBmdW5jdGlvbihyZXN1bHQpIHsKCQkJCXJlc3VsdHMucHVzaChyZXN1bHQpOwoJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCX0pOwoJCX0sIFtdKTsKCX07Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQKCT8gZGVmaW5lCgk6IGZ1bmN0aW9uIChkZXBzLCBmYWN0b3J5KSB7IHR5cGVvZiBleHBvcnRzID09ICdvYmplY3QnCgkJPyAobW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoJy4vd2hlbicpKSkKCQk6ICh0aGlzLndoZW5fc2VxdWVuY2UgPSBmYWN0b3J5KHRoaXMud2hlbikpOwoJfQoJLy8gQm9pbGVycGxhdGUgZm9yIEFNRCwgTm9kZSwgYW5kIGJyb3dzZXIgZ2xvYmFsCik7CgoKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qKgogKiBjYW5jZWxhYmxlLmpzCiAqCiAqIERlY29yYXRvciB0aGF0IG1ha2VzIGEgZGVmZXJyZWQgImNhbmNlbGFibGUiLiAgSXQgYWRkcyBhIGNhbmNlbCgpIG1ldGhvZCB0aGF0CiAqIHdpbGwgY2FsbCBhIHNwZWNpYWwgY2FuY2VsIGhhbmRsZXIgZnVuY3Rpb24gYW5kIHRoZW4gcmVqZWN0IHRoZSBkZWZlcnJlZC4gIFRoZQogKiBjYW5jZWwgaGFuZGxlciBjYW4gYmUgdXNlZCB0byBkbyByZXNvdXJjZSBjbGVhbnVwLCBvciBhbnl0aGluZyBlbHNlIHRoYXQgc2hvdWxkCiAqIGJlIGRvbmUgYmVmb3JlIGFueSBvdGhlciByZWplY3Rpb24gaGFuZGxlcnMgYXJlIGV4ZWN1dGVkLgogKgogKiBVc2FnZToKICoKICogdmFyIGNhbmNlbGFibGVEZWZlcnJlZCA9IGNhbmNlbGFibGUod2hlbi5kZWZlcigpLCBteUNhbmNlbEhhbmRsZXIpOwogKgogKiBAYXV0aG9yIGJyaWFuQGhvdmVyY3JhZnRzdHVkaW9zLmNvbQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL2NhbmNlbGFibGUnLFsnLi93aGVuJ10sIGZ1bmN0aW9uKHdoZW4pIHsKCiAgICAvKioKICAgICAqIE1ha2VzIGRlZmVycmVkIGNhbmNlbGFibGUsIGFkZGluZyBhIGNhbmNlbCgpIG1ldGhvZC4KICAgICAqCiAgICAgKiBAcGFyYW0gZGVmZXJyZWQge0RlZmVycmVkfSB0aGUge0BsaW5rIERlZmVycmVkfSB0byBtYWtlIGNhbmNlbGFibGUKICAgICAqIEBwYXJhbSBjYW5jZWxlciB7RnVuY3Rpb259IGNhbmNlbCBoYW5kbGVyIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiB0aGlzIGRlZmVycmVkIGlzIGNhbmNlbGVkLiAgVGhpcwogICAgICogaXMgZ3VhcmFudGVlZCB0byBydW4gYmVmb3JlIGFsbCBvdGhlciByZWplY3Rpb24gaGFuZGxlcnMuICBUaGUgY2FuY2VsZXIgd2lsbCBOT1QgYmUgZXhlY3V0ZWQgaWYgdGhlCiAgICAgKiBkZWZlcnJlZCBpcyByZWplY3RlZCBpbiB0aGUgc3RhbmRhcmQgd2F5LCBpLmUuIGRlZmVycmVkLnJlamVjdCgpLiAgSXQgT05MWSBleGVjdXRlcyBpZiB0aGUgZGVmZXJyZWQKICAgICAqIGlzIGNhbmNlbGVkLCBpLmUuIGRlZmVycmVkLmNhbmNlbCgpCiAgICAgKgogICAgICogQHJldHVybnMgZGVmZXJyZWQsIHdpdGggYW4gYWRkZWQgY2FuY2VsKCkgbWV0aG9kLgogICAgICovCiAgICByZXR1cm4gZnVuY3Rpb24oZGVmZXJyZWQsIGNhbmNlbGVyKSB7CgogICAgICAgIHZhciBkZWxlZ2F0ZSA9IHdoZW4uZGVmZXIoKTsKCiAgICAgICAgLy8gQWRkIGEgY2FuY2VsIG1ldGhvZCB0byB0aGUgZGVmZXJyZWQgdG8gcmVqZWN0IHRoZSBkZWxlZ2F0ZQogICAgICAgIC8vIHdpdGggdGhlIHNwZWNpYWwgY2FuY2VsZWQgaW5kaWNhdG9yLgogICAgICAgIGRlZmVycmVkLmNhbmNlbCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZGVsZWdhdGUucmVqZWN0KGNhbmNlbGVyKGRlZmVycmVkKSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gRW5zdXJlIHRoYXQgdGhlIG9yaWdpbmFsIHJlc29sdmUsIHJlamVjdCwgYW5kIHByb2dyZXNzIGFsbCBmb3J3YXJkCiAgICAgICAgLy8gdG8gdGhlIGRlbGVnYXRlCiAgICAgICAgZGVmZXJyZWQucHJvbWlzZS50aGVuKGRlbGVnYXRlLnJlc29sdmUsIGRlbGVnYXRlLnJlamVjdCwgZGVsZWdhdGUucHJvZ3Jlc3MpOwoKICAgICAgICAvLyBSZXBsYWNlIGRlZmVycmVkJ3MgcHJvbWlzZSB3aXRoIHRoZSBkZWxlZ2F0ZSBwcm9taXNlCiAgICAgICAgZGVmZXJyZWQucHJvbWlzZSA9IGRlbGVnYXRlLnByb21pc2U7CgogICAgICAgIC8vIEFsc28gcmVwbGFjZSBkZWZlcnJlZC50aGVuIHRvIGFsbG93IGl0IHRvIGJlIGNhbGxlZCBzYWZlbHkgYW5kCiAgICAgICAgLy8gb2JzZXJ2ZSB0aGUgY2FuY2VsbGF0aW9uCgkJLy8gVE9ETzogUmVtb3ZlIG9uY2UgZGVmZXJyZWQudGhlbiBpcyByZW1vdmVkCiAgICAgICAgZGVmZXJyZWQudGhlbiA9IGRlbGVnYXRlLnByb21pc2UudGhlbjsKCiAgICAgICAgcmV0dXJuIGRlZmVycmVkOwogICAgfTsKCn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicKICAgID8gZGVmaW5lCiAgICA6IGZ1bmN0aW9uIChkZXBzLCBmYWN0b3J5KSB7IHR5cGVvZiBtb2R1bGUgIT0gJ3VuZGVmaW5lZCcKICAgICAgICA/IChtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnLi93aGVuJykpKQogICAgICAgIDogKHRoaXMud2hlbl9jYW5jZWxhYmxlID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKICAgIH0KICAgIC8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgpkZWZpbmUoJ3RocnVzdC91dGlsL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ2xvZGFzaCcsICd1bmRlcnNjb3JlLnN0cmluZycsICd1dWlkJywgJ3doZW4nLCAnd2hlbi9hcHBseScsICd3aGVuL2RlbGF5JywgJ3doZW4vdGltZW91dCcsICd3aGVuL3BhcmFsbGVsJywgJ3doZW4vcGlwZWxpbmUnLCAnd2hlbi9zZXF1ZW5jZScsICd3aGVuL2NhbmNlbGFibGUnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19fX19fLCBfX19zX18sIF9fdXVpZF9fLCBfX3dfXywgX193aGVuQXBwbHlfXywgX193aGVuRGVsYXlfXywgX193aGVuVGltZW91dF9fLCBfX3doZW5QYXJhbGxlbF9fLCBfX3doZW5QaXBlbGluZV9fLCBfX3doZW5TZXF1ZW5jZV9fLCBfX3doZW5DYW5jZWxhYmxlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIHV0aWwgeyovCiAgICB2YXIgX18gPSBfX19fX187CgogICAgdmFyIF9zID0gX19fc19fOwoKICAgIHZhciB1dWlkID0gX191dWlkX187CgogICAgCiAgICBfXy5taXhpbihfcyk7CiAgICBleHBvcnRzLl8gPSBfXzsKICAgIC8vI3JlZ2lvbiBmdW5jdGlvbgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwogICAgLyoqCiAgICBBIGZ1bmN0aW9uIHRoYXQgZG9lcyBub3RoaW5nLCBvciBubyBvcGVyYXRpb24uICBIZW5jZSB0aGUgbmFtZSBub29wLgogICAgCiAgICBAbWV0aG9kIG5vb3AKICAgICoqLwogICAgZnVuY3Rpb24gbm9vcCgpIHsKICAgIH0KICAgIGV4cG9ydHMubm9vcCA9IG5vb3A7CiAgICB2YXIgcHJvcGVydHlJc0VudW1lcmFibGUgPSBub29wLnByb3BlcnR5SXNFbnVtZXJhYmxlOwogICAgLyoqCiAgICBBdHRlbXB0cyB0byBpbnZva2UsIHNpbWlsYXIgdG8gXy5pbnZva2UsIGJ1dCBpbiB0aGlzIGNhc2UgaXQgdmVyaWZpZXMgdGhhdCB0aGUgcHJvcGVydHkgZXhpc3QsCiAgICBhbmQgYWxzbyB2ZXJpZmllcyB0aGF0IGl0IGlzIGEgZnVuY3Rpb24sIGFuZCBub3QgdGhlIG5vb3AgbWV0aG9kIGF2YWlsYWJsZSBpbiB0aHJ1c3QuCiAgICAKICAgIFRoZSBpbnRlbnQgaXMgYSBtZXRob2QgdGhhdCBhbGxvd3Mgb3ZlcnJpZGUgb2YgZnVuY3Rpb25zLCB3aXRob3V0IGNyZWF0aW5nIGN1c3RvbSBjb2RlLgogICAgCiAgICBAbWV0aG9kIHNhdmVJbnZva2UKICAgIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb250YWluZXIgdGhhdCBoYXMgdGhlIGl0ZW1zCiAgICBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gbWV0aG9kIFRoZSBtZXRob2QgbmFtZSBvbiBldmVyeSBpdGVtLCBvciB0aGUgbWV0aG9kIHRvIGludm9rZSBhZ2FpbnN0IGVhY2ggaXRlbS4KICAgIEBwYXJhbSB7T2JqZWN0fSBbYXJnc10qIFRoZSBhZGRpdGlvbmFsIGFyZ3VtZW50cyB0byBwYXNzIG9udG8gdGhlIG1ldGhvZC4KICAgICoqLwogICAgZnVuY3Rpb24gc2FmZUludm9rZShjb2xsZWN0aW9uLCBtZXRob2ROYW1lKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAyKTsgX2krKykgewogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDJdOwogICAgICAgIH0KICAgICAgICAvKmpzaGludCBiaXR3aXNlOmZhbHNlICovCiAgICAgICAgICAgICAgICB2YXIgaW5kZXgsIGl0ZXJhdGVlID0gY29sbGVjdGlvbiwgcmVzdWx0OwogICAgICAgIGlmKCFjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9CiAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMiksIGlzRnVuYyA9IHR5cGVvZiBtZXRob2ROYW1lID09ICdmdW5jdGlvbicsIG1ldGhvZEV4aXN0czsKICAgICAgICB2YXIgbGVuZ3RoID0gaXRlcmF0ZWUubGVuZ3RoOwogICAgICAgIGluZGV4ID0gLTE7CiAgICAgICAgaWYobGVuZ3RoID09PSBsZW5ndGggPj4+IDApIHsKICAgICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKICAgICAgICAgICAgd2hpbGUoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzID0gKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiBpdGVyYXRlZVtpbmRleF1bbWV0aG9kTmFtZV0pOwogICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzICYmIG1ldGhvZEV4aXN0cyAhPT0gbm9vcCAmJiAocmVzdWx0W2luZGV4XSA9IG1ldGhvZEV4aXN0cy5hcHBseShpdGVyYXRlZVtpbmRleF0sIGFyZ3MpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBza2lwUHJvdG8gPSB0eXBlb2YgaXRlcmF0ZWUgPT0gJ2Z1bmN0aW9uJyAmJiBwcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGl0ZXJhdGVlLCAncHJvdG90eXBlJyk7CiAgICAgICAgICAgIHZhciBwcm9wcyA9IGV4cG9ydHMuXy5rZXlzKGl0ZXJhdGVlKSwgcHJvcEluZGV4ID0gLTEsIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKICAgICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKICAgICAgICAgICAgd2hpbGUoKytwcm9wSW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gcHJvcHNbcHJvcEluZGV4XTsKICAgICAgICAgICAgICAgIGlmKCEoc2tpcFByb3RvICYmIGluZGV4ID09ICdwcm90b3R5cGUnKSkgewogICAgICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyA9IChpc0Z1bmMgPyBtZXRob2ROYW1lIDogaXRlcmF0ZWVbaW5kZXhdW21ldGhvZE5hbWVdKTsKICAgICAgICAgICAgICAgICAgICBtZXRob2RFeGlzdHMgJiYgbWV0aG9kRXhpc3RzICE9PSBub29wICYmIChyZXN1bHRbcHJvcEluZGV4XSA9ICgoaXNGdW5jID8gbWV0aG9kTmFtZSA6IGl0ZXJhdGVlW2luZGV4XVttZXRob2ROYW1lXSkuYXBwbHkoaXRlcmF0ZWVbaW5kZXhdLCBhcmdzKSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLnNhZmVJbnZva2UgPSBzYWZlSW52b2tlOwogICAgLyoqCiAgICAqIENvbnN0cnVjdG9yIHVzZWQgdG8gYmVnZXQgb2JqZWN0cyB0aGF0IHdpcmUgbmVlZHMgdG8gY3JlYXRlIHVzaW5nIG5ldy4KICAgICogQHBhcmFtIGN0b3Ige0Z1bmN0aW9ufSByZWFsIGNvbnN0cnVjdG9yIHRvIGJlIGludm9rZWQKICAgICogQHBhcmFtIGFyZ3Mge0FycmF5fSBhcmd1bWVudHMgdG8gYmUgc3VwcGxpZWQgdG8gY3RvcgogICAgKi8KICAgIGZ1bmN0aW9uIER5bmFtaWNseUNyZWF0ZWQoY3RvciwgYXJncykgewogICAgICAgIHJldHVybiBjdG9yLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfQogICAgLyoqCiAgICAqIENyZWF0ZXMgYW4gb2JqZWN0IGJ5IGVpdGhlciBpbnZva2luZyBjdG9yIGFzIGEgZnVuY3Rpb24gYW5kIHJldHVybmluZyB0aGUgcmVzdWx0LAogICAgKiBvciBieSBjYWxsaW5nIG5ldyBjdG9yKCkuICBJdCB1c2VzIGEgc2ltcGxlIGhldXJpc3RpYyB0byB0cnkgdG8gZ3Vlc3Mgd2hpY2ggYXBwcm9hY2gKICAgICogaXMgdGhlICJyaWdodCIgb25lLgogICAgKgogICAgKiBAcGFyYW0gY3RvciB7RnVuY3Rpb259IGZ1bmN0aW9uIG9yIGNvbnN0cnVjdG9yIHRvIGludm9rZQogICAgKiBAcGFyYW0gYXJncyB7QXJyYXl9IGFycmF5IG9mIGFyZ3VtZW50cyB0byBwYXNzIHRvIGN0b3IgaW4gZWl0aGVyIGNhc2UKICAgICoKICAgICogQHJldHVybnMgVGhlIHJlc3VsdCBvZiBpbnZva2luZyBjdG9yIHdpdGggYXJncywgd2l0aCBvciB3aXRob3V0IG5ldywgZGVwZW5kaW5nIG9uCiAgICAqIHRoZSBzdHJhdGVneSBzZWxlY3RlZC4KICAgICovCiAgICBmdW5jdGlvbiBpbnN0YW50aWF0ZShjdG9yLCBhcmdzLCBuYW1lKSB7CiAgICAgICAgRHluYW1pY2x5Q3JlYXRlZC5wcm90b3R5cGUgPSBjdG9yLnByb3RvdHlwZTsKICAgICAgICBEeW5hbWljbHlDcmVhdGVkLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGN0b3I7CiAgICAgICAgdmFyIGJlZ290dGVuID0gbmV3IER5bmFtaWNseUNyZWF0ZWQoY3RvciwgYXJncyk7CiAgICAgICAgRHluYW1pY2x5Q3JlYXRlZC5wcm90b3R5cGUgPSB2b2lkIDA7CiAgICAgICAgcmV0dXJuIGJlZ290dGVuOwogICAgfQogICAgZXhwb3J0cy5pbnN0YW50aWF0ZSA9IGluc3RhbnRpYXRlOwogICAgLyoqCiAgICBGbGF0dGVuIGFuZCBmaWx0ZXIgYXJyYXlzIGRvd24gdG8ganVzdCB0aGUgZXhpc3RpbmcgcHJvbWlzZXMuCiAgICAKICAgIEBtZXRob2QgZmxhdHRlblRvUHJvbWlzZXMKICAgIEBwYXJhbSB7QXJyYXl9IEFycmF5IHRvIGZsYXR0ZW4sIGFuZCBmaWx0ZXIuCiAgICBAcmV0dXJucyB7QXJyYXkgb2YgUHJvbWlzZXN9CiAgICAqKi8KICAgIGZ1bmN0aW9uIGZsYXR0ZW5Ub1Byb21pc2VzKGFycmF5KSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5mbGF0dGVuKGFycmF5KS5maWx0ZXIoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuIHdoZW4uaXNQcm9taXNlKHgpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5mbGF0dGVuVG9Qcm9taXNlcyA9IGZsYXR0ZW5Ub1Byb21pc2VzOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gb2JqZWN0CiAgICAvKioKICAgIEludmVydHMgYW4gb2JqZWN0LiAgVGhlIGtleXMgYmVjb21lIHZhbHVlcywgYW5kIHRoZSB2YWx1ZXMgYmVjb21lIGtleXMuCiAgICBEb2VzIG5vdCBkbyBhbnkgY29weWluZy4KICAgIAogICAgQG1ldGhvZCBpbnZlcnQKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byBpbnZlcnQuCiAgICBAcmV0dXJucyB7T2JqZWN0fSBUaGUgaW52ZXJ0ZWQgb2JqZWN0LgogICAgKiovCiAgICB2YXIgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgIGZ1bmN0aW9uIGludmVydChvYmopIHsKICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgIH07CiAgICAgICAgZm9yKHZhciBpIGluIG9iaikgewogICAgICAgICAgICBpZihoYXNPd24uY2FsbChvYmosIGkpKSB7CiAgICAgICAgICAgICAgICByZXN1bHRbb2JqW2ldXSA9IGk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGV4cG9ydHMuaW52ZXJ0ID0gaW52ZXJ0OwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gdHlwZS50cwogICAgLyoqCiAgICBDaGVja3MgaXMgdGhlIG9iamVjdCBpcyBhcnJheSBsaWtlLCBsaWtlIHRoZSBhcnVndW1lbnRzIG9iamVjdCwgYnV0IG5vdCBhIHN0cmluZywgb2UgYXJyYXkuCiAgICBqUXVlcnkgb2JqZWN0cyBmb3IgZXhhbXBsZSB3b3VsZCByZXBvcnQgYXMgYXJyYXkgbGlrZS4KICAgIEFzIHdlbGwgYXMga25vY2tvdXQgb2JzZXJ2YWJsZSBhcnJheXMgcmVwb3J0IGFzIGFycmF5IGxpa2UuCiAgICAKICAgIEBtZXRob2QgaXNBcnJheUxpa2UKICAgIEBwYXJhbSB7T2JqZWN0fSBvIFRoZSBvYmplY3QgdG8gY2hlY2sKICAgIEByZXR1cm5zIHtCb29sZWFufSBJcyBpdCB0cnVlIG9yIGZhbHNlLgogICAgKiovCiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZShvKSB7CiAgICAgICAgcmV0dXJuIChvICYmICFleHBvcnRzLl8uaXNTdHJpbmcobykgJiYgby5sZW5ndGggIT09IHVuZGVmaW5lZCkgfHwgZmFsc2U7CiAgICB9CiAgICBleHBvcnRzLmlzQXJyYXlMaWtlID0gaXNBcnJheUxpa2U7CiAgICAvKioKICAgIENoZWNrcyBpZiB0aGUgZ2l2ZW4gb2JqZWN0IGlzIGFycmF5IG9yIGFycmF5IGxpa2UuCiAgICAKICAgIEBtZXRob2QgaXNBcnJheU9yQXJyYXlMaWtlCiAgICBAcGFyYW0ge09iamVjdH0gbyBUaGUgb2JqZWN0IHRvIGNoZWNrCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSXMgaXQgdHJ1ZSBvciBmYWxzZS4KICAgICoqLwogICAgZnVuY3Rpb24gaXNBcnJheU9yQXJyYXlMaWtlKG8pIHsKICAgICAgICByZXR1cm4gZXhwb3J0cy5fLmlzQXJyYXkobykgfHwgKGlzQXJyYXlMaWtlKG8pKTsKICAgIH0KICAgIGV4cG9ydHMuaXNBcnJheU9yQXJyYXlMaWtlID0gaXNBcnJheU9yQXJyYXlMaWtlOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gdXVpZAogICAgICAgIHZhciBndWlkUmVnZXggPSAvXihce3swLDF9KFswLTlhLWZBLUZdKXs4fS0oWzAtOWEtZkEtRl0pezR9LShbMC05YS1mQS1GXSl7NH0tKFswLTlhLWZBLUZdKXs0fS0oWzAtOWEtZkEtRl0pezEyfVx9ezAsMX0pJC8sIGVtdHB0eUd1aWQgPSAnMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwJzsKICAgIC8qKgogICAgUmV0dXJucyBhIG5ldyBzdWRvIGd1aWQsIGxpbWlhdGlvbnMgaW4gSmF2YVNjcmlwdCBtYWtlIG11c3QgbW9yZSByZWxpYWJsZSBndWlkcyBmYWlybHkgZGlmZmljdWx0IHRvIGNyZWF0ZS4KICAgIAogICAgQGZvciB0aHJ1c3QudXRpbAogICAgQG1ldGhvZCBuZXdHdWlkCiAgICBAcmV0dXJucyB7R3VpZH0gVGhlIG5ldyBndWlkLgogICAgKiovCiAgICBmdW5jdGlvbiBuZXdHdWlkKCkgewogICAgICAgIHJldHVybiB1dWlkLnY0KCk7CiAgICB9CiAgICBleHBvcnRzLm5ld0d1aWQgPSBuZXdHdWlkOwogICAgLyoqCiAgICBSZXR1cm5zIGFuIGVtcHR5IGd1aWQuCiAgICAKICAgIEBtZXRob2QgZW1wdHlHdWlkCiAgICBAcmV0dXJucyB7R3VpZH0gVGhlIGVtdHB0eSBndWlkLgogICAgKiovCiAgICBmdW5jdGlvbiBlbXB0eUd1aWQoKSB7CiAgICAgICAgcmV0dXJuIGVtdHB0eUd1aWQ7CiAgICB9CiAgICBleHBvcnRzLmVtcHR5R3VpZCA9IGVtcHR5R3VpZDsKICAgIC8qKgogICAgQ2hlY2tzIGlmIHRoZSBnaXZlbiBzdHJpbmcgaXMgYSBndWlkLgogICAgCiAgICBAbWV0aG9kIGlzR3VpZAogICAgQHBhcmFtIHtHdWlkfSBndWlkCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSWYgdGhlIGd1aWQgaXMgYSBndWlkIG9yIG5vdC4KICAgICoqLwogICAgZnVuY3Rpb24gaXNHdWlkKGd1aWQpIHsKICAgICAgICByZXR1cm4gZXhwb3J0cy5fLmlzU3RyaW5nKGd1aWQpID8gZ3VpZFJlZ2V4LnRlc3QoZ3VpZCkgOiBmYWxzZTsKICAgIH0KICAgIGV4cG9ydHMuaXNHdWlkID0gaXNHdWlkOwogICAgLyoqCiAgICBDaGVja3MgaWYgdGhlIEd1aWQgaXMgYW4gRW1wdHkgR3VpZAogICAgCiAgICBAbWV0aG9kIGlzRW1wdHlHdWlkCiAgICBAcGFyYW0ge0d1aWR9IGd1aWQKICAgIEByZXR1cm5zIHtCb29sZWFufSBJZiB0aGUgZ3VpZCBpcyBhIGd1aWQgb3Igbm90LgogICAgKiovCiAgICBmdW5jdGlvbiBpc0VtcHR5R3VpZChndWlkKSB7CiAgICAgICAgcmV0dXJuIGd1aWQgPT09IGVtdHB0eUd1aWQ7CiAgICB9CiAgICBleHBvcnRzLmlzRW1wdHlHdWlkID0gaXNFbXB0eUd1aWQ7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vI3JlZ2lvbiBzdHJpbmcKICAgICAgICB2YXIgb2JqZWN0Q3VybHlSZWdleCA9IC9ce1x7fFx9XH18XHsoLio/KVx9L2csIG51bWJlckN1cmx5UmVnZXggPSAvXHtce3xcfVx9fFx7KFxkKylcfS9nOwogICAgLyoqCiAgICBDIyBzdHlsZSBzdHJpbmcgZm9ybWF0LgogICAgCiAgICBAZm9yIHRocnVzdC51dGlsCiAgICBAbWV0aG9kIGZvcm1hdAogICAgKiovCiAgICBmdW5jdGlvbiBmb3JtYXQoc3RyKSB7CiAgICAgICAgdmFyIGZvcm1hdEFyZ3MgPSBbXTsKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICBmb3JtYXRBcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgIH0KICAgICAgICBpZih0eXBlb2YgZm9ybWF0QXJnc1swXSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgdmFyIGEgPSBmb3JtYXRBcmdzWzBdOwogICAgICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2Uob2JqZWN0Q3VybHlSZWdleCwgZnVuY3Rpb24gKG0sIG4pIHsKICAgICAgICAgICAgICAgIGlmKG0gPT0gJ3t7JykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAneyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihtID09ICd9fScpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ30nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGEgJiYgYVtuXSB8fCAnJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHIucmVwbGFjZShudW1iZXJDdXJseVJlZ2V4LCBmdW5jdGlvbiAobSwgbikgewogICAgICAgICAgICBpZihtID09ICd7eycpIHsKICAgICAgICAgICAgICAgIHJldHVybiAneyc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobSA9PSAnfX0nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ30nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmb3JtYXRBcmdzW25dIHx8ICcnOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5mb3JtYXQgPSBmb3JtYXQ7CiAgICBmdW5jdGlvbiBnZXRNb2R1bGVOYW1lRm9yUGF0aChuYW1lKSB7CiAgICAgICAgcmV0dXJuIChuYW1lLmxhc3RJbmRleE9mKCcvJykgPiAtMSA/IG5hbWUuc3Vic3RyaW5nKG5hbWUubGFzdEluZGV4T2YoJy8nKSArIDEpIDogbmFtZSkucmVwbGFjZSgvXC4vZywgJy0nKTsKICAgIH0KICAgIGV4cG9ydHMuZ2V0TW9kdWxlTmFtZUZvclBhdGggPSBnZXRNb2R1bGVOYW1lRm9yUGF0aDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHVybAogICAgICAgIHZhciBkb3VibGVTbGFzaFJlZ2V4ID0gL1wvXC8vZywgcjIwID0gLyUyMC9nLCByYnJhY2tldCA9IC9cW1xdJC87CiAgICAvKioKICAgIGpRdWVyeSBwYXJhbSBtZXRob2QgdG8gZW5jb2RlIGZvcm0gcGFyYW1ldGVycy4KICAgIAogICAgQGZvciB0aHJ1c3QudXRpbC51cmwKICAgIEBtZXRob2QgcGFyYW0KICAgICoqLwogICAgZnVuY3Rpb24gcGFyYW0oYSwgdHJhZGl0aW9uYWwpIHsKICAgICAgICB2YXIgcHJlZml4LCBzID0gW10sIGFkZCA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIC8vIElmIHZhbHVlIGlzIGEgZnVuY3Rpb24sIGludm9rZSBpdCBhbmQgcmV0dXJuIGl0cyB2YWx1ZQogICAgICAgICAgICB2YWx1ZSA9IGV4cG9ydHMuXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlKCkgOiAodmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUpOwogICAgICAgICAgICBzW3MubGVuZ3RoXSA9IGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgICB9OwogICAgICAgIC8vIFNldCB0cmFkaXRpb25hbCB0byB0cnVlIGZvciBqUXVlcnkgPD0gMS4zLjIgYmVoYXZpb3IuCiAgICAgICAgLyppZiAodHJhZGl0aW9uYWwgPT09IHVuZGVmaW5lZCkKICAgICAgICB7CiAgICAgICAgLy8gVE9ETyBTdXBwb3J0IGZvciB0cmFkaXRpb25hbEVuY29kaW5nCiAgICAgICAgLy90cmFkaXRpb25hbCA9ICEhbS5jb25maWcoKS50cmFkaXRpb25hbEVuY29kaW5nOwogICAgICAgIH0qLwogICAgICAgIC8vIElmIGFuIGFycmF5IHdhcyBwYXNzZWQgaW4sIGFzc3VtZSB0aGF0IGl0IGlzIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMuCiAgICAgICAgaWYoaXNBcnJheU9yQXJyYXlMaWtlKGEpKSB7CiAgICAgICAgICAgIC8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwogICAgICAgICAgICBleHBvcnRzLl8uZWFjaChhLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgYWRkKHgubmFtZSwgeC52YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIElmIHRyYWRpdGlvbmFsLCBlbmNvZGUgdGhlICJvbGQiIHdheSAodGhlIHdheSAxLjMuMiBvciBvbGRlcgogICAgICAgICAgICAvLyBkaWQgaXQpLCBvdGhlcndpc2UgZW5jb2RlIHBhcmFtcyByZWN1cnNpdmVseS4KICAgICAgICAgICAgZm9yKHByZWZpeCBpbiBhKSB7CiAgICAgICAgICAgICAgICBidWlsZFBhcmFtcyhwcmVmaXgsIGFbcHJlZml4XSwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbgogICAgICAgIHJldHVybiBzLmpvaW4oIiYiKS5yZXBsYWNlKHIyMCwgIisiKTsKICAgIH0KICAgIGV4cG9ydHMucGFyYW0gPSBwYXJhbTsKICAgIGZ1bmN0aW9uIGJ1aWxkUGFyYW1zKHByZWZpeCwgb2JqLCB0cmFkaXRpb25hbCwgYWRkKSB7CiAgICAgICAgaWYoZXhwb3J0cy5fLmlzQXJyYXkob2JqKSkgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgYXJyYXkgaXRlbS4KICAgICAgICAgICAgZXhwb3J0cy5fLmVhY2gob2JqLCBmdW5jdGlvbiAoaSwgdikgewogICAgICAgICAgICAgICAgaWYodHJhZGl0aW9uYWwgfHwgcmJyYWNrZXQudGVzdChwcmVmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVHJlYXQgZWFjaCBhcnJheSBpdGVtIGFzIGEgc2NhbGFyLgogICAgICAgICAgICAgICAgICAgIGFkZChwcmVmaXgsIHYpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBJZiBhcnJheSBpdGVtIGlzIG5vbi1zY2FsYXIgKGFycmF5IG9yIG9iamVjdCksIGVuY29kZSBpdHMKICAgICAgICAgICAgICAgICAgICAvLyBudW1lcmljIGluZGV4IHRvIHJlc29sdmUgZGVzZXJpYWxpemF0aW9uIGFtYmlndWl0eSBpc3N1ZXMuCiAgICAgICAgICAgICAgICAgICAgLy8gTm90ZSB0aGF0IHJhY2sgKGFzIG9mIDEuMC4wKSBjYW4ndCBjdXJyZW50bHkgZGVzZXJpYWxpemUKICAgICAgICAgICAgICAgICAgICAvLyBuZXN0ZWQgYXJyYXlzIHByb3Blcmx5LCBhbmQgYXR0ZW1wdGluZyB0byBkbyBzbyBtYXkgY2F1c2UKICAgICAgICAgICAgICAgICAgICAvLyBhIHNlcnZlciBlcnJvci4gUG9zc2libGUgZml4ZXMgYXJlIHRvIG1vZGlmeSByYWNrJ3MKICAgICAgICAgICAgICAgICAgICAvLyBkZXNlcmlhbGl6YXRpb24gYWxnb3JpdGhtIG9yIHRvIHByb3ZpZGUgYW4gb3B0aW9uIG9yIGZsYWcKICAgICAgICAgICAgICAgICAgICAvLyB0byBmb3JjZSBhcnJheSBzZXJpYWxpemF0aW9uIHRvIGJlIHNoYWxsb3cuCiAgICAgICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4ICsgIlsiICsgKHR5cGVvZiB2ID09PSAib2JqZWN0IiB8fCBleHBvcnRzLl8uaXNBcnJheSh2KSA/IGkgOiAiIikgKyAiXSIsIHYsIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYoIXRyYWRpdGlvbmFsICYmIG9iaiAhPSBudWxsICYmIHR5cGVvZiBvYmogPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIC8vIFNlcmlhbGl6ZSBvYmplY3QgaXRlbS4KICAgICAgICAgICAgZm9yKHZhciBuYW1lIGluIG9iaikgewogICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4ICsgIlsiICsgbmFtZSArICJdIiwgb2JqW25hbWVdLCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFNlcmlhbGl6ZSBzY2FsYXIgaXRlbS4KICAgICAgICAgICAgYWRkKHByZWZpeCwgb2JqKTsKICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIENsZWFucyB1cCBkb3VibGUgc2xhc2hzIGluIGEgdXJsLCB1c2VkIGJ5IHRocnVzdC9kYXRhCiAgICAKICAgIEBtZXRob2QgY2xlYW5VcmwKICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBjbGVhbgogICAgQHJldHJ1c24ge1N0cmluZ30gVGhlIGNsZWFuZWQgdXJsCiAgICAqKi8KICAgIGZ1bmN0aW9uIGNsZWFuVXJsKHVybCkgewogICAgICAgIHJldHVybiB1cmwucmVwbGFjZShkb3VibGVTbGFzaFJlZ2V4LCAnLycpOwogICAgfQogICAgZXhwb3J0cy5jbGVhblVybCA9IGNsZWFuVXJsOwogICAgLyoqCiAgICBDaGVja3MgZm9yIGV4aXN0YW5jZSBvZiBhcHBsaWNhdGlvbiBwYXRoIGluIHRoZSB1cmwsIG9yIGh0dHAgaWYgdGhlIHVybCBpcyBzdXBwb3NlZCB0byBnbyB0byBhbm90aGVyIGxvY2F0aW9uLgogICAgCiAgICBAbWV0aG9kIGZpeHVwVXJsCiAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZml4dXAKICAgIEByZXRydXNuIHtTdHJpbmd9IFRoZSBmaXhlZCB1cmwKICAgICoqLwogICAgZnVuY3Rpb24gZml4dXBVcmwodXJsLCB1cmxQYXRoKSB7CiAgICAgICAgaWYodXJsLmluZGV4T2YoJ2h0dHAnKSA9PT0gLTEpIHsKICAgICAgICAgICAgdmFyIHBhdGggPSB1cmxQYXRoLmxhc3RJbmRleE9mKCcvJykgPT09IHVybFBhdGgubGVuZ3RoIC0gMSA/IHVybFBhdGguc3Vic3RyaW5nKDAsIC0xKSA6IHVybFBhdGg7CiAgICAgICAgICAgIGlmKHVybC5pbmRleE9mKHBhdGgpID09PSAtMSkgewogICAgICAgICAgICAgICAgdXJsID0gcGF0aCArIHVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cmwgPSBjbGVhblVybCh1cmwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdXJsOwogICAgfQogICAgZXhwb3J0cy5maXh1cFVybCA9IGZpeHVwVXJsOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gd2hlbgogICAgdmFyIHcgPSBfX3dfXzsKCiAgICAvL2ltcG9ydCB3ID0gbW9kdWxlKCd3aGVuL2RlYnVnJyk7CiAgICB2YXIgd2hlbkFwcGx5ID0gX193aGVuQXBwbHlfXzsKCiAgICB2YXIgd2hlbkRlbGF5ID0gX193aGVuRGVsYXlfXzsKCiAgICB2YXIgd2hlblRpbWVvdXQgPSBfX3doZW5UaW1lb3V0X187CgogICAgdmFyIHdoZW5QYXJhbGxlbCA9IF9fd2hlblBhcmFsbGVsX187CgogICAgdmFyIHdoZW5QaXBlbGluZSA9IF9fd2hlblBpcGVsaW5lX187CgogICAgdmFyIHdoZW5TZXF1ZW5jZSA9IF9fd2hlblNlcXVlbmNlX187CgogICAgdmFyIHdoZW5DYW5jZWxhYmxlID0gX193aGVuQ2FuY2VsYWJsZV9fOwoKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QudXRpbAogICAgQHN1Ym1vZHVsZSB0aHJ1c3QudXRpbC53aGVuCiAgICAqKi8KICAgIChmdW5jdGlvbiAod2hlbikgewogICAgICAgIHdoZW4ud2hlbiA9IHc7CiAgICAgICAgLyoqCiAgICAgICAgd2hlbi5hcHBseSwgdXNlZCB0byBhcHBseSB3aGVuIHJlc3VsdHMgb3ZlciBhIGZ1bmN0aW9uLCBzaW1pbGFyIHRvIGpRdWVyeXMgRGVmZXJyZWQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1hcHBseV0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1hcHBseSkKICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC51dGlsLndoZW4KICAgICAgICBAbWV0aG9kIHdoZW4uYXBwbHkKICAgICAgICAqKi8KICAgICAgICB3aGVuLmFwcGx5ID0gd2hlbkFwcGx5OwogICAgICAgIC8qKgogICAgICAgIHdoZW4uZGVsYXksIGNyZWF0ZXMgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgaW4geCBtcywgdXNpbmcgc2V0VGltZW91dC4KICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLWRlbGF5XShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLWRlbGF5KQogICAgICAgIAogICAgICAgIEBtZXRob2Qgd2hlbi5kZWxheQogICAgICAgICoqLwogICAgICAgIHdoZW4uZGVsYXkgPSB3aGVuRGVsYXk7CiAgICAgICAgLyoqCiAgICAgICAgd2hlbi50aW1lb3V0LCBjcmVhdGVzIGEgcHJvbWlzZSB0aGF0IHdpbGwgdGltZW91dCBpZiB4IG1zIGlmIG5vdCByZXNvbHZlZC4KICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXRpbWVvdXRdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tdGltZW91dCkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4udGltZW91dAogICAgICAgICoqLwogICAgICAgIHdoZW4udGltZW91dCA9IHdoZW5UaW1lb3V0OwogICAgICAgIC8qKgogICAgICAgIHdoZW4ucGFyYWxsZWwKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBhcmFsbGVsXShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBhcmFsbGVsKQogICAgICAgIAogICAgICAgIEBtZXRob2Qgd2hlbi5wYXJhbGxlbAogICAgICAgICoqLwogICAgICAgIHdoZW4ucGFyYWxsZWwgPSB3aGVuUGFyYWxsZWw7CiAgICAgICAgLyoqCiAgICAgICAgd2hlbi5waXBlbGluZQogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tcGlwZWxpbmVdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tcGlwZWxpbmUpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnBpcGVsaW5lCiAgICAgICAgKiovCiAgICAgICAgd2hlbi5waXBlbGluZSA9IHdoZW5QaXBlbGluZTsKICAgICAgICAvKioKICAgICAgICB3aGVuLnNlcXVlbmNlCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1zZXF1ZW5jZV0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1zZXF1ZW5jZSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uc2VxdWVuY2UKICAgICAgICAqKi8KICAgICAgICB3aGVuLnNlcXVlbmNlID0gd2hlblNlcXVlbmNlOwogICAgICAgIC8qKgogICAgICAgIHdoZW4uY2FuY2VsYWJsZQogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tY2FuY2VsYWJsZV0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1jYW5jZWxhYmxlKQogICAgICAgIAogICAgICAgIEBtZXRob2Qgd2hlbi5jYW5jZWxhYmxlCiAgICAgICAgKiovCiAgICAgICAgd2hlbi5jYW5jZWxhYmxlID0gd2hlbkNhbmNlbGFibGU7CiAgICAgICAgd2hlbi5hbGwgPSB3aGVuLndoZW4uYWxsOwogICAgICAgIHdoZW4uYW55ID0gd2hlbi53aGVuLmFueTsKICAgICAgICB3aGVuLmNoYWluID0gd2hlbi53aGVuLmNoYWluOwogICAgICAgIHdoZW4uZGVmZXIgPSB3aGVuLndoZW4uZGVmZXI7CiAgICAgICAgd2hlbi5pc1Byb21pc2UgPSB3aGVuLndoZW4uaXNQcm9taXNlOwogICAgICAgIHdoZW4ubWFwID0gd2hlbi53aGVuLm1hcDsKICAgICAgICB3aGVuLnJlZHVjZSA9IHdoZW4ud2hlbi5yZWR1Y2U7CiAgICAgICAgd2hlbi5zb21lID0gd2hlbi53aGVuLnNvbWU7CiAgICAgICAgd2hlbi5yZXNvbHZlID0gd2hlbi53aGVuLnJlc29sdmU7CiAgICAgICAgd2hlbi5yZWplY3QgPSB3aGVuLndoZW4ucmVqZWN0OwogICAgICAgIHdoZW4uam9pbiA9IHdoZW4ud2hlbi5qb2luOwogICAgfSkoZXhwb3J0cy53aGVuIHx8IChleHBvcnRzLndoZW4gPSB7fSkpOwogICAgdmFyIHdoZW4gPSBleHBvcnRzLndoZW47CiAgICAvLyNlbmRyZWdpb24KICAgIC8vI3JlZ2lvbiBjYW1lbENhc2UKICAgICAgICB2YXIgcm1zUHJlZml4ID0gL14tbXMtLywgcmRhc2hBbHBoYSA9IC8tKFtcZGEtel0pL2dpLCBmY2FtZWxDYXNlID0gZnVuY3Rpb24gKGFsbCwgbGV0dGVyKSB7CiAgICAgICAgcmV0dXJuIChsZXR0ZXIgKyAiIikudG9VcHBlckNhc2UoKTsKICAgIH07CiAgICBmdW5jdGlvbiBjYW1lbENhc2Uoc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKHJtc1ByZWZpeCwgIm1zLSIpLnJlcGxhY2UocmRhc2hBbHBoYSwgZmNhbWVsQ2FzZSk7CiAgICB9CiAgICBleHBvcnRzLmNhbWVsQ2FzZSA9IGNhbWVsQ2FzZTsKICAgIGZ1bmN0aW9uIHVuQ2FtZWxDYXNlKHN0cikgewogICAgICAgIHJldHVybiBzdHIucmVwbGFjZSgvKFtBLVpdKS9nLCBmdW5jdGlvbiAoYWxsLCBzKSB7CiAgICAgICAgICAgIHJldHVybiAnLScgKyBzLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLnVuQ2FtZWxDYXNlID0gdW5DYW1lbENhc2U7CiAgICAvLyNlbmRyZWcKICAgIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdXRpbCcsIFsndGhydXN0L3V0aWwvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7Cgo7KGZ1bmN0aW9uKGcpewoKICAgIC8vIHN1bW1hcnk6IEEgc2ltcGxlIGZlYXR1cmUgZGV0ZWN0aW9uIGZ1bmN0aW9uL2ZyYW1ld29yay4KICAgIC8vCiAgICAvLyBuYW1lOiBTdHJpbmcKICAgIC8vICAgICAgVGhlIG5hbWUgb2YgdGhlIGZlYXR1cmUgdG8gZGV0ZWN0LCBhcyBkZWZpbmVkIGJ5IHRoZSBvdmVyYWxsIGBoYXNgIHRlc3RzLgogICAgLy8gICAgICBUZXN0cyBjYW4gYmUgcmVnaXN0ZXJlZCB2aWEgYGhhcy5hZGQodGVzdG5hbWUsIHRlc3RmdW5jdGlvbilgLgogICAgLy8KICAgIC8vIGV4YW1wbGU6CiAgICAvLyAgICAgIG15bGlicmFyeS5iaW5kID0gaGFzKCJuYXRpdmUtYmluZCIpID8gZnVuY3Rpb24oZm4sIGNvbnRleHQpewogICAgLy8gICAgICAgICAgcmV0dXJuIGZuLmJpbmQoY29udGV4dCk7CiAgICAvLyAgICAgIH0gOiBmdW5jdGlvbihmbiwgY29udGV4dCl7CiAgICAvLyAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgIC8vICAgICAgICAgICAgICBmbi5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpOwogICAgLy8gICAgICAgICAgfQogICAgLy8gICAgICB9CgogICAgdmFyIE5PTl9IT1NUX1RZUEVTID0geyAiYm9vbGVhbiI6IDEsICJudW1iZXIiOiAxLCAic3RyaW5nIjogMSwgInVuZGVmaW5lZCI6IDEgfSwKICAgICAgICBWRU5ET1JfUFJFRklYRVMgPSBbIldlYmtpdCIsICJNb3oiLCAiTyIsICJtcyIsICJLaHRtbCJdLAogICAgICAgIGQgPSBpc0hvc3RUeXBlKGcsICJkb2N1bWVudCIpICYmIGcuZG9jdW1lbnQsCiAgICAgICAgZWwgPSBkICYmIGlzSG9zdFR5cGUoZCwgImNyZWF0ZUVsZW1lbnQiKSAmJiBkLmNyZWF0ZUVsZW1lbnQoIkRpViIpLAogICAgICAgIGZyZWVFeHBvcnRzID0gdHlwZW9mIGV4cG9ydHMgPT0gIm9iamVjdCIgJiYgZXhwb3J0cywKICAgICAgICBmcmVlTW9kdWxlID0gdHlwZW9mIG1vZHVsZSA9PSAib2JqZWN0IiAmJiBtb2R1bGUsCiAgICAgICAgdGVzdENhY2hlID0ge30KICAgIDsKCiAgICBmdW5jdGlvbiBoYXMoLyogU3RyaW5nICovbmFtZSl7CiAgICAgICAgaWYodHlwZW9mIHRlc3RDYWNoZVtuYW1lXSA9PSAiZnVuY3Rpb24iKXsKICAgICAgICAgICAgdGVzdENhY2hlW25hbWVdID0gdGVzdENhY2hlW25hbWVdKGcsIGQsIGVsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRlc3RDYWNoZVtuYW1lXTsgLy8gQm9vbGVhbgogICAgfQoKICAgIGZ1bmN0aW9uIGFkZCgvKiBTdHJpbmcgKi9uYW1lLCAvKiBGdW5jdGlvbiAqL3Rlc3QsIC8qIEJvb2xlYW4/ICovbm93KXsKICAgICAgICAvLyBzdW1tYXJ5OiBSZWdpc3RlciBhIG5ldyBmZWF0dXJlIGRldGVjdGlvbiB0ZXN0IGZvciBzb21lIG5hbWVkIGZlYXR1cmUKICAgICAgICAvLwogICAgICAgIC8vIG5hbWU6IFN0cmluZwogICAgICAgIC8vICAgICAgVGhlIG5hbWUgb2YgdGhlIGZlYXR1cmUgdG8gdGVzdC4KICAgICAgICAvLwogICAgICAgIC8vIHRlc3Q6IEZ1bmN0aW9uCiAgICAgICAgLy8gICAgICBBIHRlc3QgZnVuY3Rpb24gdG8gcmVnaXN0ZXIuIElmIGEgZnVuY3Rpb24sIHF1ZXVlZCBmb3IgdGVzdGluZyB1bnRpbCBhY3R1YWxseQogICAgICAgIC8vICAgICAgbmVlZGVkLiBUaGUgdGVzdCBmdW5jdGlvbiBzaG91bGQgcmV0dXJuIGEgYm9vbGVhbiBpbmRpY2F0aW5nCiAgICAgICAgLy8gICAgICB0aGUgcHJlc2VuY2Ugb2YgYSBmZWF0dXJlIG9yIGJ1Zy4KICAgICAgICAvLwogICAgICAgIC8vIG5vdzogQm9vbGVhbj8KICAgICAgICAvLyAgICAgIE9wdGlvbmFsLiBPbWl0IGlmIGB0ZXN0YCBpcyBub3QgYSBmdW5jdGlvbi4gUHJvdmlkZXMgYSB3YXkgdG8gaW1tZWRpYXRlbHkKICAgICAgICAvLyAgICAgIHJ1biB0aGUgdGVzdCBhbmQgY2FjaGUgdGhlIHJlc3VsdC4KICAgICAgICAvLyBleGFtcGxlOgogICAgICAgIC8vICAgICAgQSByZWR1bmRhbnQgdGVzdCwgdGVzdEZuIHdpdGggaW1tZWRpYXRlIGV4ZWN1dGlvbjoKICAgICAgICAvLyAgfCAgICAgICBoYXMuYWRkKCJqYXZhc2NyaXB0IiwgZnVuY3Rpb24oKXsgcmV0dXJuIHRydWU7IH0sIHRydWUpOwogICAgICAgIC8vCiAgICAgICAgLy8gZXhhbXBsZToKICAgICAgICAvLyAgICAgIEFnYWluIHdpdGggdGhlIHJlZHVuZGFudG5lc3MuIFlvdSBjYW4gZG8gdGhpcyBpbiB5b3VyIHRlc3RzLCBidXQgd2Ugc2hvdWxkCiAgICAgICAgLy8gICAgICBub3QgYmUgZG9pbmcgdGhpcyBpbiBhbnkgaW50ZXJuYWwgaGFzLmpzIHRlc3RzCiAgICAgICAgLy8gIHwgICAgICAgaGFzLmFkZCgiamF2YXNjcmlwdCIsIHRydWUpOwogICAgICAgIC8vCiAgICAgICAgLy8gZXhhbXBsZToKICAgICAgICAvLyAgICAgIFRocmVlIHRoaW5ncyBhcmUgcGFzc2VkIHRvIHRoZSB0ZXN0RnVuY3Rpb24uIGBnbG9iYWxgLCBgZG9jdW1lbnRgLCBhbmQgYSBnZW5lcmljIGVsZW1lbnQKICAgICAgICAvLyAgICAgIGZyb20gd2hpY2ggdG8gd29yayB5b3VyIHRlc3Qgc2hvdWxkIHRoZSBuZWVkIGFyaXNlLgogICAgICAgIC8vICB8ICAgICAgIGhhcy5hZGQoImJ1Zy1ieWlkIiwgZnVuY3Rpb24oZywgZCwgZWwpewogICAgICAgIC8vICB8ICAgICAgICAgICAvLyBnICA9PSBnbG9iYWwsIHR5cGljYWxseSB3aW5kb3csIHlhZGRhIHlhZGRhCiAgICAgICAgLy8gIHwgICAgICAgICAgIC8vIGQgID09IGRvY3VtZW50IG9iamVjdAogICAgICAgIC8vICB8ICAgICAgICAgICAvLyBlbCA9PSB0aGUgZ2VuZXJpYyBlbGVtZW50LiBhIGBoYXNgIGVsZW1lbnQuCiAgICAgICAgLy8gIHwgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gZmFrZSB0ZXN0LCBieWlkLXdoZW4tZm9ybS1oYXMtbmFtZS1tYXRjaGluZy1hbi1pZCBpcyBzbGlnaHRseSBsb25nZXIKICAgICAgICAvLyAgfCAgICAgICB9KTsKICAgICAgICB0ZXN0Q2FjaGVbbmFtZV0gPSBub3cgPyB0ZXN0KGcsIGQsIGVsKSA6IHRlc3Q7CiAgICB9CgogICAgLy8gY3NzcHJvcCBhZGFwdGVkIGZyb20gaHR0cDovL2dpc3QuZ2l0aHViLmNvbS81OTgwMDggKHRoYW5rcywgXnBpKQogICAgZnVuY3Rpb24gY3NzcHJvcChuYW1lLCBlbCl7CiAgICAgICAgdmFyIHN1cHBvcnRlZCA9IGZhbHNlLAogICAgICAgICAgICBjYXBpdGFsaXplZCA9IG5hbWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBuYW1lLnNsaWNlKDEpLAogICAgICAgICAgICBsZW5ndGggPSBWRU5ET1JfUFJFRklYRVMubGVuZ3RoLAogICAgICAgICAgICBzdHlsZSA9IGVsLnN0eWxlOwoKICAgICAgICBpZih0eXBlb2Ygc3R5bGVbbmFtZV0gPT0gInN0cmluZyIpewogICAgICAgICAgICBzdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB3aGlsZShsZW5ndGgtLSl7CiAgICAgICAgICAgICAgICBpZih0eXBlb2Ygc3R5bGVbVkVORE9SX1BSRUZJWEVTW2xlbmd0aF0gKyBjYXBpdGFsaXplZF0gPT0gInN0cmluZyIpewogICAgICAgICAgICAgICAgICAgIHN1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN1cHBvcnRlZDsKICAgIH0KCiAgICBmdW5jdGlvbiBjbGVhckVsZW1lbnQoZWwpewogICAgICAgIGlmKGVsKXsKICAgICAgICAgICAgd2hpbGUoZWwubGFzdENoaWxkKXsKICAgICAgICAgICAgICAgIGVsLnJlbW92ZUNoaWxkKGVsLmxhc3RDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGVsOwogICAgfQoKICAgIC8vIEhvc3Qgb2JqZWN0cyBjYW4gcmV0dXJuIHR5cGUgdmFsdWVzIHRoYXQgYXJlIGRpZmZlcmVudCBmcm9tIHRoZWlyIGFjdHVhbAogICAgLy8gZGF0YSB0eXBlLiBUaGUgb2JqZWN0cyB3ZSBhcmUgY29uY2VybmVkIHdpdGggdXN1YWxseSByZXR1cm4gbm9uLXByaW1pdGl2ZQogICAgLy8gdHlwZXMgb2Ygb2JqZWN0LCBmdW5jdGlvbiwgb3IgdW5rbm93bi4KICAgIGZ1bmN0aW9uIGlzSG9zdFR5cGUob2JqZWN0LCBwcm9wZXJ0eSl7CiAgICAgICAgdmFyIHR5cGUgPSB0eXBlb2Ygb2JqZWN0W3Byb3BlcnR5XTsKICAgICAgICByZXR1cm4gdHlwZSA9PSAib2JqZWN0IiA/ICEhb2JqZWN0W3Byb3BlcnR5XSA6ICFOT05fSE9TVF9UWVBFU1t0eXBlXTsKICAgIH0KCiAgICAgICAgaGFzLmFkZCA9IGFkZDsKICAgIGhhcy5jbGVhckVsZW1lbnQgPSBjbGVhckVsZW1lbnQ7CiAgICBoYXMuY3NzcHJvcCA9IGNzc3Byb3A7CiAgICBoYXMuaXNIb3N0VHlwZSA9IGlzSG9zdFR5cGU7CiAgICBoYXMuX3Rlc3RzID0gdGVzdENhY2hlOwoKICAgIGhhcy5hZGQoImRvbSIsIGZ1bmN0aW9uKGcsIGQsIGVsKXsKICAgICAgICByZXR1cm4gZCAmJiBlbCAmJiBpc0hvc3RUeXBlKGcsICJsb2NhdGlvbiIpICYmIGlzSG9zdFR5cGUoZCwgImRvY3VtZW50RWxlbWVudCIpICYmCiAgICAgICAgICAgIGlzSG9zdFR5cGUoZCwgImdldEVsZW1lbnRCeUlkIikgJiYgaXNIb3N0VHlwZShkLCAiZ2V0RWxlbWVudHNCeU5hbWUiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGQsICJnZXRFbGVtZW50c0J5VGFnTmFtZSIpICYmIGlzSG9zdFR5cGUoZCwgImNyZWF0ZUNvbW1lbnQiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGQsICJjcmVhdGVFbGVtZW50IikgJiYgaXNIb3N0VHlwZShkLCAiY3JlYXRlVGV4dE5vZGUiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGVsLCAiYXBwZW5kQ2hpbGQiKSAmJiBpc0hvc3RUeXBlKGVsLCAiaW5zZXJ0QmVmb3JlIikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShlbCwgInJlbW92ZUNoaWxkIikgJiYgaXNIb3N0VHlwZShlbCwgImdldEF0dHJpYnV0ZSIpICYmCiAgICAgICAgICAgIGlzSG9zdFR5cGUoZWwsICJzZXRBdHRyaWJ1dGUiKSAmJiBpc0hvc3RUeXBlKGVsLCAicmVtb3ZlQXR0cmlidXRlIikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShlbCwgInN0eWxlIikgJiYgdHlwZW9mIGVsLnN0eWxlLmNzc1RleHQgPT0gInN0cmluZyI7CiAgICB9KTsKCiAgICAvLyBTdG9wIHJlcGVhdCBiYWNrZ3JvdW5kLWltYWdlIHJlcXVlc3RzIGFuZCByZWR1Y2UgbWVtb3J5IGNvbnN1bXB0aW9uIGluIElFNiBTUDEKICAgIC8vIGh0dHA6Ly9taXN0ZXJwaXhlbC5ibG9nc3BvdC5jb20vMjAwNi8wOS9mb3JlbnNpYy1hbmFseXNpcy1vZi1pZTYuaHRtbAogICAgLy8gaHR0cDovL2Jsb2dzLm1zZG4uY29tL2IvY3dpbHNvL2FyY2hpdmUvMjAwNi8xMS8wNy9pZS1yZS1kb3dubG9hZGluZy1iYWNrZ3JvdW5kLWltYWdlcy5hc3B4P1BhZ2VJbmRleD0xCiAgICAvLyBodHRwOi8vc3VwcG9ydC5taWNyb3NvZnQuY29tL2tiLzgyMzcyNwogICAgdHJ5ewogICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJCYWNrZ3JvdW5kSW1hZ2VDYWNoZSIsIGZhbHNlLCB0cnVlKTsKICAgIH1jYXRjaChlKXt9CgogICAgLy8gRXhwb3NlIGhhcygpCiAgICAvLyBzb21lIEFNRCBidWlsZCBvcHRpbWl6ZXJzLCBsaWtlIHIuanMsIGNoZWNrIGZvciBzcGVjaWZpYyBjb25kaXRpb24gcGF0dGVybnMgbGlrZSB0aGUgZm9sbG93aW5nOgogICAgaWYodHlwZW9mIGRlZmluZSA9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBkZWZpbmUuYW1kID09ICJvYmplY3QiICYmIGRlZmluZS5hbWQpewogICAgICAgIGRlZmluZSgiaGFzIixbXSwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgcmV0dXJuIGhhczsKICAgICAgICB9KTsKICAgIH0KICAgIC8vIGNoZWNrIGZvciBgZXhwb3J0c2AgYWZ0ZXIgYGRlZmluZWAgaW4gY2FzZSBhIGJ1aWxkIG9wdGltaXplciBhZGRzIGFuIGBleHBvcnRzYCBvYmplY3QKICAgIGVsc2UgaWYoZnJlZUV4cG9ydHMpewogICAgICAgIC8vIGluIE5vZGUuanMgb3IgUmluZ29KUyB2MC44LjArCiAgICAgICAgaWYoZnJlZU1vZHVsZSAmJiBmcmVlTW9kdWxlLmV4cG9ydHMgPT0gZnJlZUV4cG9ydHMpewogICAgICAgICAgKGZyZWVNb2R1bGUuZXhwb3J0cyA9IGhhcykuaGFzID0gaGFzOwogICAgICAgIH0KICAgICAgICAvLyBpbiBOYXJ3aGFsIG9yIFJpbmdvSlMgdjAuNy4wLQogICAgICAgIGVsc2V7CiAgICAgICAgICBmcmVlRXhwb3J0cy5oYXMgPSBoYXM7CiAgICAgICAgfQogICAgfQogICAgLy8gaW4gYSBicm93c2VyIG9yIFJoaW5vCiAgICBlbHNlewogICAgICAgIC8vIHVzZSBzcXVhcmUgYnJhY2tldCBub3RhdGlvbiBzbyBDbG9zdXJlIENvbXBpbGVyIHdvbid0IG11bmdlIGBoYXNgCiAgICAgICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9jbG9zdXJlL2NvbXBpbGVyL2RvY3MvYXBpLXR1dG9yaWFsMy5odG1sI2V4cG9ydAogICAgICAgIGdbImhhcyJdID0gaGFzOwogICAgfQp9KSh0aGlzKTsKCmRlZmluZSgndGhydXN0L2NhcHN1bGUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJy4vbG9nJywgJ2hhcyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGVhY2ggPSBfLmVhY2gsIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgZXh0ZW5kID0gXy5leHRlbmQsIHdoZW4gPSB1dGlsLndoZW4sIGZsYXR0ZW4gPSBfLmZsYXR0ZW4sIHBsdWNrID0gXy5wbHVjaywgZmxhdHRlblRvUHJvbWlzZXMgPSB1dGlsLmZsYXR0ZW5Ub1Byb21pc2VzLCB0aHJ1c3RDYWNoZSA9IHsKICAgIH0sIF9fb3B0aW9uYWxNZXRob2RzID0gWwogICAgICAgIC8vIE9wdGlvbmFsIG1ldGhvZHMgdGhhdCBtYXkgYmUgb24gYSBtb2R1bGUKICAgICAgICAnc3RhcnQnLCAKICAgICAgICAnc3RvcCcsIAogICAgICAgICdyZWFkeScsIAogICAgICAgICdjb25maWcnLCAKICAgICAgICAKICAgIF0sIF9fcmVxdWlyZWRNZXRob2RzID0gWwogICAgICAgIC8vIFJlcXVpcmVkIG1ldGhvZHMgdGhhdCBtdXN0IGJlIG9uIGV2ZXJ5IG1vZHVsZQogICAgICAgICdpbml0JywgCiAgICAgICAgJ2Rlc3Ryb3knLCAKICAgICAgICAKICAgIF07CiAgICAvKioKICAgIE1vdmVzIGFsbCBwcm9wZXJ0aWVzLCB0aGF0IHNob3VsZCBleGlzdCBvdXRzaWRlIG9mIHRoZSBtb2R1bGUsIGludG8gYSBwcml2YXRlIG9iamVjdCBmb3IgaG9sZGluZy4KICAgIAogICAgQG1ldGhvZCBtb3ZlVG9UaHJ1c3RDYWNoZQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7T2JqZWN0fSBmcm9tIE9iamVjdCB0byBleHRyYWN0IGl0ZW1zIGZyb20KICAgIEBwYXJhbSB7T2JqZWN0fSB0byBPYmplY3QgdG8gcGxhY2UgaXRlbXMgb24KICAgIEBwYXJhbSB7QXJyYXl9IGxpc3QgSXRlbXMgdG8gbW92ZSBmcm9tIHRvIHRoZSBvdGhlciBvYmplY3QKICAgICoqLwogICAgZnVuY3Rpb24gbW92ZVRvVGhydXN0Q2FjaGUoZnJvbSwgdG8sIGxpc3QpIHsKICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gbGlzdC5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgdG9bbGlzdFtpXV0gPSBmcm9tW2xpc3RbaV1dOwogICAgICAgICAgICBkZWxldGUgZnJvbVtsaXN0W2ldXTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBnZXRFdmVudE5hbWVzcGFjZShuYW1lLCBwcmVmaXgpIHsKICAgICAgICBpZighcHJlZml4KSB7CiAgICAgICAgICAgIHByZWZpeCA9ICdtb2R1bGUtJzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICcuJyArIChuYW1lID09PSAnZ2xvYmFsJyA/ICdnbG9iYWwnIDogcHJlZml4ICsgbmFtZS5yZXBsYWNlKC9cLi9nLCAnLScpKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNhbGxGYWNhZGVNZXRob2RzKG1ldGhvZCwgbW9kdWxlQ2FjaGUpIHsKICAgICAgICB2YXIgbSA9IG1vZHVsZUNhY2hlLm1vZHVsZTsKICAgICAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgICAgIF8uZm9yT3duKG1vZHVsZUNhY2hlLmZhY2FkZXMsIGZ1bmN0aW9uIChmYWNhZGUsIGkpIHsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgndGhydXN0L2NhcHN1bGU6IENhbGxpbmcgZmFjYWRlICJ7MH0iIHsxfSgpJywgaSwgbWV0aG9kKSk7CiAgICAgICAgICAgIGlmKGZhY2FkZVttZXRob2RdICYmIGlzT2JqZWN0KGZhY2FkZSkpIHsKICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChmYWNhZGVbbWV0aG9kXS5jYWxsKGZhY2FkZSwgbSkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmVzdWx0cy5wdXNoKHV0aWwuc2FmZUludm9rZSgobS50aHJ1c3QpLl9fdGhydXN0Q29udmVudGlvbnMsIG1ldGhvZCwgbSwgbW9kdWxlQ2FjaGUuZmFjYWRlcykpOwogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgfQogICAgLyoqCiAgICBUaGUgbW9kdWxlIGlzIHRoZSBoZWFydCBvZiB0aGUgdGhydXN0LCBldmVyeSBtb2R1bGUgZ2V0cyBvbmUgZmFjYWRlIHBlciBtb2R1bGUuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICBAY2xhc3MgdGhydXN0Lk1vZHVsZQogICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlCiAgICBAcGFyYW0ge09iamVjdH0gZGVmIFRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgQHBhcmFtIHtTdHJpbmd9IFtuYW1lXSBUaGUgbW9kdWxlIG5hbWUuCiAgICAqKi8KICAgIHZhciBNb2R1bGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vdmFyIE1vZHVsZSA9CiAgICAgICAgZnVuY3Rpb24gTW9kdWxlKHRocnVzdCwgZGVmLCBuYW1lKSB7CiAgICAgICAgICAgIG5hbWUgPSB0aGlzLm5hbWUgPSAobmFtZSB8fCBkZWYubmFtZSk7CiAgICAgICAgICAgIGlmKHR5cGVvZiBkZWYgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGRlZiA9IGRlZihuYW1lKTsKICAgICAgICAgICAgICAgIGRlZi5uYW1lID0gbmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbWlkID0gdGhpcy5taWQgPSB0aHJ1c3QubmFtZSArICc6JyArIG5hbWU7CiAgICAgICAgICAgIHZhciB0Q2FjaGUgPSB0aHJ1c3RDYWNoZVtkZWYuaGFzaCB8fCBtaWRdOwogICAgICAgICAgICAvLyBDbGVhciBhbnkgcG90ZW50aWFsIGNhY2hlZCBjb25maWcgb2JqZWN0cywgdG8gbWFrZSBzdXJlIHRoZXkgcmVmcmVzaCBpZiB0aGUgbW9kdWxlIGlzIHJlZGVmaW5lZC4KICAgICAgICAgICAgaWYodENhY2hlKSB7CiAgICAgICAgICAgICAgICBfLmtleXModENhY2hlKS5maWx0ZXIoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geC5pbmRleE9mKCdjb25maWcuJykgPT09IDA7CiAgICAgICAgICAgICAgICB9KS5mb3JFYWNoKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZSB0Q2FjaGVbeF07CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmluc3RhbmNlID0gZXh0ZW5kKGRlZiwgdENhY2hlICYmIHRDYWNoZS5pbnN0YW5jZSB8fCB7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmluc3RhbmNlLm5hbWUgPSAodGhpcy5pbnN0YW5jZS5uYW1lIHx8IG5hbWUpOwogICAgICAgICAgICB0aGlzLmluc3RhbmNlLm1pZCA9IG1pZDsKICAgICAgICAgICAgaWYoIXRoaXMuaW5zdGFuY2UubmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBbGwgTW9kdWxlcyBtdXN0IGhhdmUgYSBuYW1lIScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vZHVsZXMgbXVzdCBoYXZlIGFuIGluaXQgbWV0aG9kIGFuZCBhIGRlc3Ryb3kgbWV0aG9kLCBpdCdzIHVwIHRvIHRoZSBtb2R1bGUgZGV2ZWxvcGVyIHRvIHBvcHVsYXRlIHRoZXNlIG1ldGhvZHMuCiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBfX3JlcXVpcmVkTWV0aG9kcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmKCFkZWZbX19yZXF1aXJlZE1ldGhvZHNbaV1dKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnUmVxdWlyZWQgInswfSIgbWV0aG9kIG5vdCBmb3VuZCBvbiBtb2R1bGUgInsxfSIhJywgX19yZXF1aXJlZE1ldGhvZHNbaV0sIG5hbWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBJZiB0aGUgbW9kdWxlIG5hbWUgaXMgdW5kZWZpbmVkLCBicmluZyB0aGUgbmFtZSBpbnRvIHRoZSBtb2R1bGUuCiAgICAgICAgICAgIGlmKHR5cGVvZiBkZWYubmFtZSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIGRlZi5uYW1lID0gbmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhydXN0TW9kdWxlQ2FjaGVJdGVtID0gdGhydXN0Q2FjaGVbbWlkXSA9IGV4dGVuZCh0Q2FjaGUgfHwgewogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBfc3RhcnRlZDogZmFsc2UsCiAgICAgICAgICAgICAgICBuYW1lOiB1dGlsLmdldE1vZHVsZU5hbWVGb3JQYXRoKG5hbWUpLAogICAgICAgICAgICAgICAgbW9kdWxlOiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkZWxldGUgdGhydXN0Q2FjaGVbZGVmLmhhc2hdOwogICAgICAgICAgICB2YXIgZmFjYWRlcyA9IHRocnVzdE1vZHVsZUNhY2hlSXRlbS5mYWNhZGVzIHx8ICh0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uZmFjYWRlcyA9IHsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKCF0aHJ1c3QuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUpIHsKICAgICAgICAgICAgICAgIHRocnVzdC5fX2NvbnZlbnRpb25QbHVja1Byb3BlcnRpZXNDYWNoZSA9IGZsYXR0ZW4ocGx1Y2sodGhydXN0Ll9fY29udmVudGlvbnMgfHwgW10sICdwcm9wZXJ0aWVzJykpLmZpbHRlcihmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB4LmluZGV4T2YoJ2NvbmZpZy4nKSAhPT0gMDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vdmUgYWxsIHNwZWNpYWwgcHJvcGVydGllcyBvZmYgdG8gdGhlIHRocnVzdCdzIGludGVybmFsIG1ldGhvZC4KICAgICAgICAgICAgbW92ZVRvVGhydXN0Q2FjaGUodGhpcy5pbnN0YW5jZSwgdGhydXN0TW9kdWxlQ2FjaGVJdGVtLCBfX3JlcXVpcmVkTWV0aG9kcyk7CiAgICAgICAgICAgIG1vdmVUb1RocnVzdENhY2hlKHRoaXMuaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbSwgX19vcHRpb25hbE1ldGhvZHMpOwogICAgICAgICAgICBtb3ZlVG9UaHJ1c3RDYWNoZSh0aGlzLmluc3RhbmNlLCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0sIHRocnVzdC5fX2NvbnZlbnRpb25QbHVja1Byb3BlcnRpZXNDYWNoZSk7CiAgICAgICAgICAgIHV0aWwuc2FmZUludm9rZSh0aHJ1c3QsICdjcmVhdGVGYWNhZGUnLCB0aHJ1c3QsIHRoaXMuaW5zdGFuY2UsIGZhY2FkZXMpOwogICAgICAgICAgICB0aGlzLl9fbmFtZXNwYWNlID0gZ2V0RXZlbnROYW1lc3BhY2UodGhpcy5pbnN0YW5jZS5uYW1lKTsKICAgICAgICAgICAgdGhpcy50aHJ1c3QgPSB0aHJ1c3Q7CiAgICAgICAgICAgIHRoaXMuY2FjaGUgPSB0aHJ1c3RDYWNoZVttaWRdOwogICAgICAgIH0KICAgICAgICBNb2R1bGUudGhydXN0Q2FjaGUgPSB0aHJ1c3RDYWNoZTsKICAgICAgICBNb2R1bGUucHJvdG90eXBlLmNvbnZlbnRpb24gPSAvKioKICAgICAgICBHZXR0ZXIvU2V0dGVyIGZvciBjb252ZW50aW9uIG1ldGhvZHMuCiAgICAgICAgR2V0cyB0aGUgdmFsdWUgY29udmVudGlvbiBwcm9wZXJ0eSAoZGVmaW5lZCBpbiB0aGUgcHJvcGVydGllcyBhcnJheSBvZiBhIGZhY2FkZSkuCiAgICAgICAgU2V0cyB0aGUgdmFsdWUgb2YgYSBjb252ZW50aW9uIHByb3BlcnR5IChmb3Igc3RvcmluZyBjb252ZW50aW9uIGNvbmZpZ3VyYXRpb24pCiAgICAgICAgCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IFRoZSBwcm9wZXJ0eSB0byBnZXQgb3Igc2V0CiAgICAgICAgQHBhcmFtIHtvYmplY3R9IFt2YWx1ZV0gVGhlIHZhbHVlIHRvIHNldAogICAgICAgIEBtZXRob2QgY29udmVudGlvbgogICAgICAgIEByZXR1cm5zIHtPYmplY3R9IFRoZSB2YWxhdWUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHByb3BlcnR5LCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgdGMgPSB0aGlzLmNhY2hlOwogICAgICAgICAgICBpZihwcm9wZXJ0eS5pbmRleE9mKCdjb25maWcuJykgPT09IDApIHsKICAgICAgICAgICAgICAgIGlmKHR5cGVvZiB0Y1twcm9wZXJ0eV0gPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGNbcHJvcGVydHldID0gdGhpcy5nZXRWYWx1ZUZyb21QYXRoKHByb3BlcnR5LCB0YykgfHwgZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgdGNbcHJvcGVydHldID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRjW3Byb3BlcnR5XTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuZ2V0VmFsdWVGcm9tUGF0aCA9IGZ1bmN0aW9uIChwYXRoLCBvYmplY3QpIHsKICAgICAgICAgICAgdmFyIHBhdGhzID0gcGF0aC5zcGxpdCgnLicpLCB2ID0gb2JqZWN0OwogICAgICAgICAgICBfLmVhY2gocGF0aHMsIGZ1bmN0aW9uIChwKSB7CiAgICAgICAgICAgICAgICB2ID0gdiAmJiB2W3BdOwogICAgICAgICAgICAgICAgaWYoIXYpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUudGhydXN0Q3JlYXRlID0gLyoqCiAgICAgICAgSW5qZWN0cyB0aGlzIG1vZHVsZSBpbnRvIHRoZSBnaXZlbiB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB0aHJ1c3RDcmVhdGUKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB0aHJ1c3QuX19pbmplY3RNb2R1bGUodGhpcyk7CiAgICAgICAgfTsKICAgICAgICBNb2R1bGUucHJvdG90eXBlLnRocnVzdENhbGwgPSAvKioKICAgICAgICBNYWtlcyBhIGNhbGwgdG8gYWxsIHRoZSBtb2R1bGVzIGZhY2FkZXMKICAgICAgICBUaGUgb3JkZXIgb2YgdGhlIGNhbGwgZGVwZW5kcyBvbiB0aGUgb3JkZXIgcmVxdWlyZWQuCiAgICAgICAgRHVyaW5nIHRoZSBzdGFydHVwIHN0YWdlIChpbml0LCBzdGFydCwgcmVhZHkpIGZhY2FkZXMgYXJlIGNhbGxlZCBmaXJzdC4KICAgICAgICBEdXJpbmcgdGhlIHNodXRkb3duIHN0YXRlIChzdG9wLCBkZXN0cm95KSBmYWNhZGVzIGFyZSBjYWxsZWQgbGFzdC4KICAgICAgICBUaGlzIGFsbG93cyBtb2R1bGVzIHRvIHN0YXJ0dXAgYW5kIHNodXRkb3duIHdpbGwgYWxsIHRoZSB0b29scyBpdCBoYWQgdG8gYmVnaW4gd2l0aC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHRocnVzdENhbGwKICAgICAgICBAcHJvdGVjdGVkCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZCB0aGUgbWV0aG9kIHRvIGNhbGwKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IGZhY2FkZUFmdGVyIGNhbGxzIGZhY2FkZSBtZXRob2RzIGJlZm9yZSBvciBhZnRlciBtb2R1bGUgbWV0aG9kLgogICAgICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgQXJncyB0byBiZSBwYXNzZWQgb250byB0aGUgbW9kdWxlIG1ldGhvZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobWV0aG9kLCBmYWNhZGVBZnRlciwgYXJncykgewogICAgICAgICAgICB2YXIgc2VxID0gW10sIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCd0aHJ1c3QvY2Fwc3VsZTogQ2FsbGluZyBmYWNhZGVzIGZvciAiezB9IicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICB2YXIgY2FjaGUgPSB0aGlzLmNhY2hlLCBtID0gY2FjaGVbbWV0aG9kXTsKICAgICAgICAgICAgc2VxLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxGYWNhZGVNZXRob2RzKG1ldGhvZCwgY2FjaGUpOwogICAgICAgICAgICAgICAgaWYocmVzdWx0ICYmIHJlc3VsdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlblRvUHJvbWlzZXMocmVzdWx0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihtKSB7CiAgICAgICAgICAgICAgICBzZXEucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IG0uYXBwbHkodGhhdC5pbnN0YW5jZSwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgaWYocmVzdWx0ICYmIHJlc3VsdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW5Ub1Byb21pc2VzKHJlc3VsdCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGZhY2FkZUFmdGVyKSB7CiAgICAgICAgICAgICAgICBzZXEucHVzaChzZXEuc2hpZnQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdoZW4uc2VxdWVuY2Uoc2VxKTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuc3RhcnQgPSAvKioKICAgICAgICBTdGFydCB0aGUgbW9kdWxlLCBpbnNpZGUgdGhlIHRocnVzdCBjb250YWluZXIgaXQgd2FzIGNyZWF0ZWQgb24uCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC50aHJ1c3Quc3RhcnQodGhhdC5uYW1lKTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuc3RvcCA9IC8qKgogICAgICAgIFN0b3AgdGhlIG1vZHVsZSwgaW5zaWRlIHRoZSB0aHJ1c3QgY29udGFpbmVyIGl0IHdhcyBjcmVhdGVkIG9uLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoYXQudGhydXN0LnN0b3AodGhhdC5uYW1lKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBNb2R1bGU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5Nb2R1bGUgPSBNb2R1bGU7ICAgIAogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBtb2R1bGUgaW5zdGFuY2UuCiAgICBGb3JtYXQ6CiAgICB0aHJ1c3QvY2Fwc3VsZSF7aW5zdGFuY2V9Onttb2R1bGVOYW1lfQogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICBmdW5jdGlvbiBsb2FkKG5hbWUsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwgaW5zdGFuY2VOYW1lID0gcGFydHNbMF0sIG1vZHVsZU5hbWUgPSBwYXJ0c1sxXTsKICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgJ3RocnVzdCEnICsgaW5zdGFuY2VOYW1lCiAgICAgICAgXSwgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgbW9kdWxlID0gdGhydXN0Lm1vZHVsZXNbbW9kdWxlTmFtZV07CiAgICAgICAgICAgIGlmKCFtb2R1bGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ01vZHVsZSAiezB9IiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgInsxfSIuJywgbW9kdWxlTmFtZSwgaW5zdGFuY2VOYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbG9hZChtb2R1bGUpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y2Fwc3VsZS5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9pbnN0YW5jZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2NhcHN1bGUnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fY2Fwc3VsZV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAvKioKICAgIEdldHMgdGhlIHRocnVzdCBpbnN0YW5jZXMuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIHdoZW4gPSB1dGlsLndoZW47CiAgICB2YXIgY2Fwc3VsZSA9IF9fY2Fwc3VsZV9fOwoKICAgIC8qKgogICAgVGhlIGF2YWlsYWJsZSB0aHJ1c3QgaW5zdGFuY2VzCiAgICBpbmRleCBieSBuYW1lCiAgICAKICAgIEBmb3IgdGhydXN0Lmluc3RhbmNlCiAgICBAcHJvcGVydHkgaW5zdGFuY2VzCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBleHBvcnRzLmluc3RhbmNlcyA9IHsKICAgIH07CiAgICAvKioKICAgIFRoZSBsb2FkaW5nIHRodXJzdCBpbnN0YW5jZXMuCiAgICBpbmRleCBieSBuYW1lCiAgICAKICAgIEBwcm9wZXJ0eSBsb2FkaW5nSW5zdGFuY2VzCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXMgPSB7CiAgICB9OwogICAgLyoqCiAgICBHZXRzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICAKICAgIEBtZXRob2QgZ2V0SW5zdGFuY2UKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICBAcmV0dXJucyB7VGhydXN0fSBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGdldEluc3RhbmNlKG5hbWUpIHsKICAgICAgICByZXR1cm4gZXhwb3J0cy5pbnN0YW5jZXNbbmFtZV0gfHwgbnVsbDsKICAgIH0KICAgIGV4cG9ydHMuZ2V0SW5zdGFuY2UgPSBnZXRJbnN0YW5jZTsKICAgIC8qKgogICAgRmV0Y2hzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICBUaGlzIGxvYWRzIGFzeW5jcm9ub3VzbHksIGFzIHRoZSBpbnN0YW5jZSBtYXkgbm90IGJlIGxvYWRlZAogICAgCiAgICBAbWV0aG9kIGZldGNoSW5zdGFuY2UKICAgIEBzdGF0aWMKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgaW5zdGFuY2UgbmFtZQogICAgQHJldHVybnMge1Byb21pc2V9IFRvIGEgdGhydXN0IGluc3RhbmNlIHNwZWMKICAgICoqLwogICAgZnVuY3Rpb24gZmV0Y2hJbnN0YW5jZShuYW1lKSB7CiAgICAgICAgdmFyIGRlZmVyID0gZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzW25hbWVdIHx8IChleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXNbbmFtZV0gPSB3aGVuLmRlZmVyKCkpOwogICAgICAgIHJldHVybiBkZWZlcjsKICAgIH0KICAgIGV4cG9ydHMuZmV0Y2hJbnN0YW5jZSA9IGZldGNoSW5zdGFuY2U7CiAgICAvKioKICAgIENsZWFycyB0aGUgVGhydXN0IEluc3RhbmNlIGNhY2hlLCB0aGlzIGlzIHVzZWQgZm9yIHVuaXQgdGVzdGluZywgYW5kIGNsZWFyaW5nIGFsbCB0aGUgY2FjaGUgZGF0YSBlYWNoIHJ1bi4KICAgIAogICAgQG1ldGhvZCBjbGVhckNhY2hlCiAgICBAc3RhdGljCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBmdW5jdGlvbiBjbGVhckNhY2hlKCkgewogICAgICAgIHV0aWwuXy5lYWNoKHV0aWwuXy5rZXlzKGV4cG9ydHMuaW5zdGFuY2VzKSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgZXhwb3J0cy5pbnN0YW5jZXNbeF0gPSBudWxsOwogICAgICAgICAgICBkZWxldGUgZXhwb3J0cy5pbnN0YW5jZXNbeF07CiAgICAgICAgfSk7CiAgICAgICAgdXRpbC5fLmVhY2godXRpbC5fLmtleXMoZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzKSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzW3hdID0gbnVsbDsKICAgICAgICAgICAgZGVsZXRlIGV4cG9ydHMubG9hZGluZ0luc3RhbmNlc1t4XTsKICAgICAgICB9KTsKICAgICAgICB1dGlsLl8uZWFjaCh1dGlsLl8ua2V5cyhjYXBzdWxlLk1vZHVsZS50aHJ1c3RDYWNoZSksIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIGNhcHN1bGUuTW9kdWxlLnRocnVzdENhY2hlW3hdID0gbnVsbDsKICAgICAgICAgICAgZGVsZXRlIGNhcHN1bGUuTW9kdWxlLnRocnVzdENhY2hlW3hdOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5jbGVhckNhY2hlID0gY2xlYXJDYWNoZTsKICAgIC8qfSovIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWluc3RhbmNlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2NvbmZpZycsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnLi9pbnN0YW5jZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3RocnVzdEluc3RhbmNlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGNvbmZpZyB7Ki8KICAgIAogICAgdmFyIHRocnVzdEluc3RhbmNlID0gX190aHJ1c3RJbnN0YW5jZV9fOwoKICAgIC8qKgogICAgUHJvdmlkZXMgdGhydXN0IGNvbmZpZ3VyYXRpb24KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBzdWJtb2R1bGUgdGhydXN0LmNvbmZpZwogICAgKiovCiAgICAvKioKICAgIFRoaXMgcHJvcGVydHksIHRlbGxzIHRoZSBmcmFtZXdvcmsgaWYgaXQgc2hvdWxkIHRocm93IGVycm9ycyBvciBub3QuCiAgICBJbiBwcm9kdWN0aW9uIGl0J3MgcmVjb21tZW5kZWQgbm90IHRvIHRocm93IGVycm9ycywgdGhhdCB3YXkgaWYgYSBjb21wb25lbnQgZmFpbHMKICAgIHRoZXJlIGlzIGEgY2hhbmNlIHRoZSBhcHBsaWNhdGlvbiBjYW4gc3RpbGwgcmVjb3Zlci4KICAgIAogICAgQGZvciB0aHJ1c3QuY29uZmlnCiAgICBAcHJvcGVydHkgdGhyb3dFcnJvcnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCBmYWxzZQogICAgKiovCiAgICBleHBvcnRzLnRocm93RXJyb3JzID0gdHJ1ZTsKICAgIC8qKgogICAgVGVsbHMgdGhlIGZyYW1ld29yayB0byBydW4gaW4gYXN5bmMgbW9kZSwgdGhpcyBtYXkgZGVsYXkgc3RhcnQgdXAsIGJ1dCB3aWxsIG1ha2UgaW1hZ2UgbG9hZGluZyBhbmQgaW5pdGFsIHJ1bm5pbmcgYXBwZWFyIGZhc3Rlci4KICAgIAogICAgQHByb3BlcnR5IGFzeW5jCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtCb29sZWFufQogICAgQGRlZmF1bHQgdHJ1ZQogICAgKiovCiAgICBleHBvcnRzLmFzeW5jID0gdHJ1ZTsKICAgIC8qKgogICAgVGVsbHMgdGhydXN0IHRvIGV4cG9zZSBlYWNoIGluc3RhbmNlIGFzIGEgZ2xvYmFsLCB0aGlzIGFsbG93cyBsZWdhY3kgY29tcG9uZW50cyB0byB1dGlsaXplIHBhcnRzIG9mIHRocnVzdCwgb3IgZWFzaWx5CiAgICBnZXQgYXQgeW91ciB0aHJ1c3QgaW5zdGFuY2UgZHVyaW5nIGRlYnVnZ2luZy4KICAgIAogICAgQHByb3BlcnR5IGV4cG9zZUdsb2JhbHMKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuZXhwb3NlR2xvYmFscyA9IHRydWU7CiAgICBleHBvcnRzLnVybCA9IHsKICAgICAgICBwYXRoOiAvKioKICAgICAgICBUaGlzIHByb3BlcnR5LCBnaXZlcyB0aGUgZnJhbWV3b3JrIGl0J3MgZGVmYXVsdCBwYXRoLCBpZiBkaWZmZXJlbnQgdGhhbiAnLycKICAgICAgICAKICAgICAgICBAcHJvcGVydHkgdXJsLnBhdGgKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7U3RyaW5nfQogICAgICAgIEBkZWZhdWx0ICIvIgogICAgICAgICoqLwogICAgICAgICcvJywKICAgICAgICB0cmFkaXRpb25hbEVuY29kaW5nOiAvKioKICAgICAgICBUaGlzIHByb3BlcnR5LCB0ZWxscyB0aGUgZnJhbWV3b3JrIGhvdyBpdCBzaG91bGQgZW5jb2RlIGFycmF5IGZvcm0gZGF0YS4KICAgICAgICBJbiBnZW5lcmFsLCBmb3IgQVNQLk5FVCBiYXNlZCBhcHBsaWNhdGlvbnMsIHRyYWRpdGlvbmFsIHNob3VsZCBiZSB0cnVlLgogICAgICAgIEZvciBSdWJ5L1B5dGhvbiBiYXNlZCBhcHBsaWNhdGlvbnMsIHRoaXMgc2hvdWxkIGJlIGZhbHNlLgogICAgICAgIAogICAgICAgIEBwcm9wZXJ0eSB1cmwudHJhZGl0aW9uYWxFbmNvZGluZwogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtCb29sZWFufQogICAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgICAgKiovCiAgICAgICAgdHJ1ZQogICAgfTsKICAgIGV4cG9ydHMubG9nID0gewogICAgICAgIGxldmVsOiAvKioKICAgICAgICBUaGlzIGxlbmRzIHRvIHRoZSBsb2cgbGV2ZWwgb2YgdGhydXN0LgogICAgICAgIAogICAgICAgIEVSUk9SOiAxCiAgICAgICAgV0FSTjogMgogICAgICAgIElORk86IDMKICAgICAgICBERUJVRzogNAogICAgICAgIAogICAgICAgIEBwcm9wZXJ0eSBsb2cubGV2ZWwKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7U3RyaW5nfQogICAgICAgIEBkZWZhdWx0IDEKICAgICAgICAqKi8KICAgICAgICA0LAogICAgICAgIGVuYWJsZWQ6IC8qKgogICAgICAgIFRoaXMgdG9nZ2xlcyBlbmFibGluZyBvbiBvciBvZmYuCiAgICAgICAgCiAgICAgICAgQHByb3BlcnR5IGxvZy5lbmFibGVkCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgICAqKi8KICAgICAgICB0cnVlCiAgICB9OwogICAgLyoqCiAgICBQbHVnaW5zIGZvciB0aHJ1c3QgdG8gbG9hZCwgb3ZlcnJpZGUgd2l0aCB5b3VyIG93biBzZXQgaWYgeW91IGhhdmUgYSBkaWZmZXJlbnQgc2V0LgogICAgCiAgICBAcHJvcGVydHkgcGx1Z2lucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucGx1Z2lucyA9IFtdOwogICAgLyoqCiAgICAqIFRoZSBzZXQgb2YgbW9kdWxlcyB0byBwcmVsb2FkIHdpdGggdGhlIGluaXRhbCB3aXJldXAgb2YgdGhlIFRocnVzdCBpbnN0YW5jZS4KICAgICoKICAgICogQWNjZXB0cyB0aGUgbW9kdWxlIHBhdGggYSBzdHJpbmcgb3IgdGhlIG1vZHVsZSBhcyBhbiBvYmplY3QgaW4gdGhlIGZvbGxvd2luZyBmb3JtYXQuCiAgICAqICAgV2hlcmUgYXJncyB3aWxsIGJlIGhhbmRlZCBvZmYgdG8gdGhlIG1vZHVsZSBsaWZlIGN5Y2xlIG1ldGhvZHMuCiAgICAqCiAgICAqICAgIHsKICAgICogICAgICAgIHBhdGg6ICcnLAogICAgKiAgICAgICAgYXJnczogW10KICAgICogICAgfQogICAgKgogICAgKiBAcHJvcGVydHkgbW9kdWxlcwogICAgKiBAcmVhZE9ubHkKICAgICogQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLm1vZHVsZXMgPSBbXTsKICAgIC8qKgogICAgVXNlZCBpbnRlcm5hbGx5IGJ5IHRocnVzdCB0byBkZXRlcm1pbmUgaWYgdGhlIGxpZmUtY3ljbGUgaXMgY29udHJvbGxlZCBieSB0aHJ1c3QsIG9yIGEgcGFyZW50IGluc3RhbmNlLgogICAgCiAgICBAcHJvcGVydHkgY2hpbGRJbnN0YW5jZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICoqLwogICAgZXhwb3J0cy5jaGlsZEluc3RhbmNlID0gZmFsc2U7CiAgICAvKioKICAgIFVzZWQgaW50ZXJuYWxseSBieSB0aHJ1c3QgdG8gZGV0ZXJtaW5lIGlmIHRocnVzdCBzaG91bGQgY29udHJvbCB0aGUgbGlmZS1jeWNsZSwgb3IgdGhlIGNvbnN1bWVyCiAgICAKICAgIEBwcm9wZXJ0eSBhdXRvbWF0aWNMaWZlY3ljbGUKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICAqKi8KICAgIGV4cG9ydHMuYXV0b21hdGljTGlmZWN5Y2xlID0gdHJ1ZTsKICAgIC8qKgogICAgVXNlZCBpbnRlcm5hbGx5IGJ5IHRocnVzdCB0byBkZXRlcm1pbiBpZiB0aGUgdGhydXN0IGluc3RhbmNlIHNob3VsZCBhdXRvbWF0aWNhbGx5IHN0YXJ0IHVwb24gY3JlYXRpb24uCiAgICAKICAgIEBwcm9wZXJ0eSBhdXRvU3RhcnQKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICAqKi8KICAgIGV4cG9ydHMuYXV0b1N0YXJ0ID0gZmFsc2U7CiAgICAvKioKICAgIERlZmluZSB0aGUgY29udmVudGlvbnMgdGhhdCB1bmlxdWUgdG8gdGhydXN0LCB0aGV5IGFyZSBub3Qgc3BlY2lmaWMgdG8gYW55IG9uZSBwbHVnaW4uCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lcicsIAogICAgICAgICd0aHJ1c3QvY29udmVudGlvbi9hdXRvc3RhcnQnLCAKICAgICAgICAndGhydXN0L2NvbnZlbnRpb24vZGVwZW5kZW50Lm1vZHVsZXMnCiAgICBdOwogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBjdXJyZW50IGNvbmZpZyBmb3IgdGhlIGN1cnJlbnQgdGhydXN0IGluc3RhbmNlLCBvciB0aGUgY29uZmlnIG9mIHRoZSBnaXZlbiBwbHVnaW4uCiAgICBBZGRpbmcgdGhlIDogY2hhcmFjdGVyIHJlcXVlc3RzIGEgc3BlY2lmaWMgY29uZmlnIHBsdWdpbi4KICAgIHRocnVzdC9jb25maWchZ2xvYmFsID0gdGhydXN0IWdsb2JhbDpjb25maWcgPSBUaHJ1c3QgaW5zdGFuY2UgY29uZmlnIGZyb20gdGhlIGluc3RhbmNlIG5hbWVkIGdsb2JhbC4KICAgIAogICAgQG1ldGhvZCBsb2FkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgZnVuY3Rpb24gbG9hZChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksIHJlYWxOYW1lID0gcGFydHNbMF0sIHBsdWdpbk5hbWUgPSBwYXJ0c1sxXSB8fCBmYWxzZTsKICAgICAgICB2YXIgaW5zdGFuY2VEZWZlcnJlZCA9IHRocnVzdEluc3RhbmNlLmZldGNoSW5zdGFuY2UocmVhbE5hbWUpOwogICAgICAgIGluc3RhbmNlRGVmZXJyZWQucHJvbWlzZS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBwbHVnaW4gPSBwbHVnaW5OYW1lICYmIGNvbnRleHQuY2ZnW3BsdWdpbk5hbWVdIHx8IGNvbnRleHQuY29uZmlnOwogICAgICAgICAgICBpZighcGx1Z2luKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BsdWdpbiAiJyArIHBsdWdpbk5hbWUgKyAnIiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgIicgKyByZWFsTmFtZSArICciLicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvYWQocGx1Z2luKTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMubG9hZCA9IGxvYWQ7CiAgICAvKn0qLyB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbG9nJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL2NvbmZpZycsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3RDb25maWdfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIC8qKgogICAgQSBiYXNpYyBsb2dnZXIgZm9yIHRoZSB0aHJ1c3QgZnJhbWV3b3JrLgogICAgRGlzYWJsZXMgZGVidWcgbG9nZ2luZyB3aGVuIHRocnVzdCBpcyBub3QgaW4gZGVidWcgbW9kZS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIAogICAgKiovCiAgICAKICAgIC8vIExvZyBsZXZlbHMKICAgIHZhciBMRVZFTCA9IHsKICAgICAgICBERUJVRzogNCwKICAgICAgICBJTkZPOiAzLAogICAgICAgIFdBUk46IDIsCiAgICAgICAgRVJST1I6IDEKICAgIH07CiAgICAvLyBEZWNsYXJlIG91ciB2YXJpYWJsZXMKICAgICAgICB2YXIgY29uc29sZSA9IHdpbmRvdy5jb25zb2xlLCB0aW1lcnMgPSB7CiAgICB9LCBjTG9nID0gKGNvbnNvbGUgJiYgY29uc29sZS5sb2cpIHx8IGZhbHNlLCBjV2FybiA9IChjb25zb2xlICYmIGNvbnNvbGUud2FybikgfHwgZmFsc2UsIGNJbmZvID0gKGNvbnNvbGUgJiYgY29uc29sZS5pbmZvKSB8fCBmYWxzZSwgY0Vycm9yID0gKGNvbnNvbGUgJiYgY29uc29sZS5lcnJvcikgfHwgZmFsc2UsIGNUaW1lID0gKGNvbnNvbGUgJiYgY29uc29sZVsndGltZSddKSB8fCBmYWxzZSwgY1RpbWVFbmQgPSAoY29uc29sZSAmJiBjb25zb2xlWyd0aW1lRW5kJ10pIHx8IGZhbHNlLCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgY29uZmlnTGV2ZWwgPSB0Q29uZmlnLmxvZy5sZXZlbCB8fCBMRVZFTC5FUlJPUiwgbG9nTGV2ZWwgPSBMRVZFTFtjb25maWdMZXZlbF0gfHwgKHR5cGVvZiBjb25maWdMZXZlbCA9PT0gJ3N0cmluZycgJiYgTEVWRUxbY29uZmlnTGV2ZWwudG9VcHBlckNhc2UoKV0pIHx8ICh0eXBlb2YgY29uZmlnTGV2ZWwgPT09ICdudW1iZXInICYmIGNvbmZpZ0xldmVsKSB8fCBMRVZFTC5FUlJPUjsKICAgIC8vIFZhcmlvdXMgbG9nZ2VycyB0byBoYW5kbGUgSUU4Lzkgc3VwcG9ydC4KICAgIHZhciBsb2dSdW5uZXIgPSBmdW5jdGlvbiAoY29uc29sZU1ldGhvZCwgbG9nVHlwZSkgewogICAgICAgIC8vIFNob3cgbG9ncyB3aGVuIGVuYWJsZWQgb3IgaWYgdGhleSBhcmUgZXJyb3JzCiAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgaWYoY29uc29sZU1ldGhvZCkgewogICAgICAgICAgICBpZihjb25zb2xlTWV0aG9kLmFwcGx5KSB7CiAgICAgICAgICAgICAgICBjb25zb2xlTWV0aG9kLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc29sZU1ldGhvZChhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZighY29uc29sZU1ldGhvZCAmJiBjTG9nKSB7CiAgICAgICAgICAgIGlmKGNMb2cuYXBwbHkpIHsKICAgICAgICAgICAgICAgIGNMb2cuYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjTG9nKGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIC8qKgogICAgQSBiYXNpYyBsb2dnZXIgZm9yIHRoZSB0aHJ1c3QgZnJhbWV3b3JrLgogICAgRGlzYWJsZXMgZGVidWcgbG9nZ2luZyB3aGVuIHRocnVzdCBpcyBub3QgaW4gZGVidWcgbW9kZS4KICAgIAogICAgQGNsYXNzIHRocnVzdC5Mb2cKICAgICoqLwogICAgLyoqCiAgICBMb2dzIGEgZGVidWcgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGxvZyBtZXRob2QKICAgIAogICAgQG1ldGhvZCBkZWJ1ZwogICAgKiovCiAgICBmdW5jdGlvbiBkZWJ1ZygpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDApOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjTG9nKTsKICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICdsb2cnKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmRlYnVnID0gZGVidWc7CiAgICAvKioKICAgIExvZ3MgYSBpbmZvIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSBpbmZvIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2QgaW5mbwogICAgKiovCiAgICBmdW5jdGlvbiBpbmZvKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5JTkZPKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY0luZm8pOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ2luZm8nKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmluZm8gPSBpbmZvOwogICAgLyoqCiAgICBMb2dzIGEgd2FybiB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgd2FybiBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgogICAgCiAgICBAbWV0aG9kIHdhcm4KICAgICoqLwogICAgZnVuY3Rpb24gd2FybigpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDApOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuV0FSTikgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGNXYXJuKTsKICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICd3YXJuJyk7CiAgICAgICAgfQogICAgfQogICAgZXhwb3J0cy53YXJuID0gd2FybjsKICAgIC8qKgogICAgTG9ncyBhIGVycm9yIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSBlcnJvciBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgogICAgCiAgICBAbWV0aG9kIGVycm9yCiAgICAqKi8KICAgIGZ1bmN0aW9uIGVycm9yKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5FUlJPUikgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGNFcnJvcik7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzLCAnZXJyb3InKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmVycm9yID0gZXJyb3I7CiAgICAvKioKICAgIExvZ3MgYSB0aW1lIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSB0aW1lIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2QgdGltZQogICAgKiovCiAgICBmdW5jdGlvbiB0aW1lKG1lc3NhZ2UpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpIHsKICAgICAgICAgICAgdGltZXJzW21lc3NhZ2VdID0gewogICAgICAgICAgICAgICAgc3RhcnQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBtc2cgPSB1dGlsLmZvcm1hdCgnezB9OiB0aW1lciBzdGFydGVkJywgbWVzc2FnZSksIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChtc2cpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY1RpbWUpOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQogICAgfQogICAgZXhwb3J0cy50aW1lID0gdGltZTsKICAgIC8qKgogICAgTG9ncyBhIHRpbWVFbmQgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIHRpbWVFbmQgbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KICAgIENhdXNlcyB0aGUgdGltZXIgdG8gZW5kLCBmb3IgdGhlIGdpdmVuIG1lc3NhZ2UuCiAgICAKICAgIEBtZXRob2QgdGltZUVuZAogICAgKiovCiAgICBmdW5jdGlvbiB0aW1lRW5kKG1lc3NhZ2UpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpIHsKICAgICAgICAgICAgdGltZXJzW21lc3NhZ2VdLmVuZCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CiAgICAgICAgICAgIHZhciB0aW1lID0gdGltZXJzW21lc3NhZ2VdLmVuZCAtIHRpbWVyc1ttZXNzYWdlXS5zdGFydCwgbXNnID0gdXRpbC5mb3JtYXQoJ3swfTogezF9bXMnLCBtZXNzYWdlLCB0aW1lKTsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChtc2cpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY1RpbWVFbmQpOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQogICAgfQogICAgZXhwb3J0cy50aW1lRW5kID0gdGltZUVuZDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bG9nLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2lnbml0ZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnbW9kdWxlJywgJ3RocnVzdC91dGlsJywgJy4vY29uZmlnJywgJy4vY2Fwc3VsZScsICcuL2luc3RhbmNlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fcmVxdWlyZU1vZHVsZV9fLCBfX3V0aWxfXywgX19jb25maWdfXywgX190bV9fLCBfX2luc3RhbmNlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHJlcXVpcmVNb2R1bGUgPSBfX3JlcXVpcmVNb2R1bGVfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICB2YXIgdG0gPSBfX3RtX187CgogICAgdmFyIGluc3RhbmNlID0gX19pbnN0YW5jZV9fOwoKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgaXNBcnJheSA9IF8uaXNBcnJheSwgdG9BcnJheSA9IF8udG9BcnJheSwgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgZWFjaCA9IF8uZWFjaCwgbWFwID0gXy5tYXAsIGFueSA9IF8uYW55LCBhbGwgPSBfLmFsbCwgd2hlbiA9IHV0aWwud2hlbiwgZXh0ZW5kID0gXy5leHRlbmQsIGZsYXR0ZW4gPSBfLmZsYXR0ZW4sIHBsdWNrID0gXy5wbHVjaywgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBrZXlzID0gXy5rZXlzLCB1bmlvbiA9IF8udW5pb247CiAgICAvKmZ1bmN0aW9uIHJlY29uY2lsZUFycmF5cyhjb25maWcsIHNldHRpbmdzLCB0bykKICAgIHsKICAgIHZhciBrZXlzID0gXy5rZXlzKGNvbmZpZyk7CiAgICBpZiAoc2V0dGluZ3MpCiAgICB7CiAgICBrZXlzID0gdW5pb24oXy5rZXlzKHNldHRpbmdzKSwga2V5cyk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICBzZXR0aW5ncyA9IHt9OwogICAgfQogICAgZWFjaChrZXlzLCBmdW5jdGlvbiAoaSkKICAgIHsKICAgIHZhciB4ID0gc2V0dGluZ3NbaV0gfHwgY29uZmlnW2ldOwogICAgaWYgKGlzQXJyYXkoeCkpCiAgICB7CiAgICB0b1tpXSA9IHRvQXJyYXkoc2V0dGluZ3NbaV0gfHwgdG9baV0pOwogICAgfQogICAgZWxzZSBpZiAoaXNPYmplY3QoeCkgJiYgIWlzRnVuY3Rpb24oeCkpCiAgICB7CiAgICByZWNvbmNpbGVBcnJheXMoeCwgbnVsbCwgdG9baV0pOwogICAgfQogICAgfSk7CiAgICB9Ki8KICAgIGZ1bmN0aW9uIG1lcmdlU2V0dGluZ3Moc2V0dGluZ3MpIHsKICAgICAgICBpZigoc2V0dGluZ3MpLl9fc2V0dGluZ3NNZXJnZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHNldHRpbmdzOwogICAgICAgIH0KICAgICAgICB2YXIgcmVxdWlyZUNvbmZpZyA9IHJlcXVpcmVNb2R1bGUuY29uZmlnKCksIHBsdWdpbnMgPSBbCiAgICAgICAgICAgICd0aHJ1c3QvbWVkaWF0b3InCiAgICAgICAgXS5jb25jYXQoc2V0dGluZ3MucGx1Z2lucyB8fCByZXF1aXJlQ29uZmlnLnBsdWdpbnMgfHwgY29uZmlnLnBsdWdpbnMgfHwgW10pLCBjb252ZW50aW9ucyA9IFtdLmNvbmNhdChzZXR0aW5ncy5jb252ZW50aW9ucyB8fCByZXF1aXJlTW9kdWxlLmNvbmZpZygpLmNvbnZlbnRpb25zIHx8IGNvbmZpZy5wbHVnaW5zIHx8IFtdKTsKICAgICAgICBzZXR0aW5ncyA9IF8ubWVyZ2UoewogICAgICAgIH0sIGNvbmZpZywgcmVxdWlyZU1vZHVsZS5jb25maWcoKSwgc2V0dGluZ3MsIHsKICAgICAgICAgICAgX19zZXR0aW5nc01lcmdlZDogdHJ1ZSwKICAgICAgICAgICAgcGx1Z2luczogcGx1Z2lucywKICAgICAgICAgICAgY29udmVudGlvbnM6IGNvbnZlbnRpb25zCiAgICAgICAgfSk7CiAgICAgICAgc2V0dGluZ3MucGx1Z2lucyA9IHBsdWdpbnM7CiAgICAgICAgc2V0dGluZ3MuY29udmVudGlvbnMgPSBjb252ZW50aW9uczsKICAgICAgICByZXR1cm4gc2V0dGluZ3M7CiAgICB9CiAgICBleHBvcnRzLm1lcmdlU2V0dGluZ3MgPSBtZXJnZVNldHRpbmdzOwogICAgZnVuY3Rpb24gZnVzZShzZXR0aW5ncykgewogICAgICAgIHZhciBwaXBlID0gW107CiAgICAgICAgc2V0dGluZ3MgPSBtZXJnZVNldHRpbmdzKHNldHRpbmdzKTsKICAgICAgICBpZighaW5zdGFuY2UuaW5zdGFuY2VzW3NldHRpbmdzLm5hbWVdKSB7CiAgICAgICAgICAgIHBpcGUucHVzaChzdGFnZU9uZSk7CiAgICAgICAgfQogICAgICAgIHBpcGUucHVzaChzdGFnZVR3byk7CiAgICAgICAgaWYoc2V0dGluZ3MubW9kdWxlcyAmJiBzZXR0aW5ncy5tb2R1bGVzLmxlbmd0aCkgewogICAgICAgICAgICBwaXBlLnB1c2goc3RhZ2VUaHJlZSk7CiAgICAgICAgfQogICAgICAgIHZhciBwcm9taXNlID0gd2hlbi5waXBlbGluZShwaXBlLCBzZXR0aW5ncyk7CiAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9CiAgICBleHBvcnRzLmZ1c2UgPSBmdXNlOwogICAgLyoqCiAgICBDb250cnVjdHMgYSB3aXJlIHNwZWMgZm9yIHRocnVzdCB0byBsYXVuY2ggZnJvbS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgLyoqCiAgICBNZXJnZXMgYSBhbGwgdGhlIHBsdWdpbnMgY29uZmlndXJhdGlvbnMsIHdpdGggdGhlIGRlZmF1bHQgY29uZmlnLCBhbmQgdGhlbiBmaW5hbGx5IHdpdGgKICAgIGFueSBjdXN0b21pemVkIGNvbmZpZyBmcm9tIHJlcXVpcmVqcwogICAgCiAgICBAbWV0aG9kIHN0YWdlT25lCiAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbnRzIHRvIHBhc3Mgb250byB0aGUgdGhydXN0IGluc3RhbmNlIGJlaW5nIGNyZWF0ZWQuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHN0YWdlT25lKHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICAgICAgICAgIHZhciBwbHVnaW5zID0gc2V0dGluZ3MucGx1Z2lucywgcmVxdWlyZUNvbmZpZyA9IHJlcXVpcmVNb2R1bGUuY29uZmlnKCksIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgIHNldHRpbmdzLnBsdWdpbnMgPSBwbHVnaW5zOwogICAgICAgIHJlcXVpcmUocGx1Z2lucy5tYXAoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuIHg7CiAgICAgICAgfSksIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICAgIHBsdWdpbnMuZm9yRWFjaChmdW5jdGlvbiAocGx1Z2luLCBpKSB7CiAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxKSwgcGx1Z2luU2V0dGluZ3MgPSBzZXR0aW5nc1tuYW1lXSB8fCB7CiAgICAgICAgICAgICAgICB9LCBwbHVnaW5SZXF1aXJlQ29uZmlnID0gcmVxdWlyZUNvbmZpZ1tuYW1lXSB8fCB7CiAgICAgICAgICAgICAgICB9LCBwbHVnaW5DbGFzcyA9IGFyZ3NbaV1bYXJnc1tpXS5jbGFzc05hbWVdOwogICAgICAgICAgICAgICAgaWYoIWNvbmZpZ1tuYW1lXSkgewogICAgICAgICAgICAgICAgICAgIGNvbmZpZ1tuYW1lXSA9IF8ubWVyZ2UocGx1Z2luQ2xhc3MuY29uZmlnLCBwbHVnaW5SZXF1aXJlQ29uZmlnIHx8IHsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjb252ZW50aW9ucyA9IFtdLmNvbmNhdChwbHVnaW5TZXR0aW5ncy5jb252ZW50aW9ucyB8fCBwbHVnaW5SZXF1aXJlQ29uZmlnLmNvbnZlbnRpb25zIHx8IGNvbmZpZ1tuYW1lXS5jb252ZW50aW9ucyB8fCBbXSk7CiAgICAgICAgICAgICAgICBzZXR0aW5nc1tuYW1lXSA9IF8ubWVyZ2UoewogICAgICAgICAgICAgICAgfSwgY29uZmlnW25hbWVdLCBwbHVnaW5TZXR0aW5ncyB8fCB7CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgY29udmVudGlvbnM6IGNvbnZlbnRpb25zCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHNldHRpbmdzW25hbWVdLmNvbnZlbnRpb25zID0gY29udmVudGlvbnM7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkZWZlci5yZXNvbHZlKHNldHRpbmdzKTsKICAgICAgICB9LCBkZWZlci5yZWplY3QpOwogICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgfQogICAgZXhwb3J0cy5zdGFnZU9uZSA9IHN0YWdlT25lOwogICAgLyoqCiAgICBDcmVhdGVzIGEgdGhydXN0IGluc3RhbmNlLCBmcm9tIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgIEluY2x1ZGluZyB0aGUgcGx1Z2lucy4KICAgIAogICAgQG1ldGhvZCBzdGFnZVR3bwogICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW50cyB0byBwYXNzIG9udG8gdGhlIHRocnVzdCBpbnN0YW5jZSBiZWluZyBjcmVhdGVkLgogICAgKiovCiAgICBmdW5jdGlvbiBzdGFnZVR3byhzZXR0aW5ncykgewogICAgICAgIC8qanNoaW50IGxvb3BmdW5jOnRydWUgKi8KICAgICAgICAvLyBHZXQgdGhlIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgIHZhciBsb2NhbENvbmZpZyA9IHNldHRpbmdzLCBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAvLyBNZWRpYXRvciBpcyBhIHJlcXVpcmVkIHBsdWdpbiwgaW5jbHVkZSBhbGwgdGhlIG90aGVycyBpbiBhZGRpdGlvbiB0byBpdC4KICAgICAgICAgICAgICAgIHZhciBwbHVnaW5zID0gbG9jYWxDb25maWcucGx1Z2lucywgbW9kdWxlc1RvTG9hZCA9IC8vIFRoZSBtb2R1bGVzIHRvIGxvYWQKICAgICAgICBbXSwgdGhydXN0Q29udmVudGlvbnMgPSBzZXR0aW5ncy5jb252ZW50aW9ucyB8fCBbXSwgbW9kdWxlc0NvbmZpZ3VyYXRpb25zID0gLy8gVGhlIG1vZHVsZSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgIHsKICAgICAgICAgICAgdGhydXN0OiAndGhydXN0JwogICAgICAgIH07CiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGx1Z2lucywgY3JlYXRpbmcgYSBwcm9wZXIgZGVwZW5kYW5jeSBsaXN0LgogICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBwbHVnaW5zLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICB2YXIgcGx1Z2luID0gcGx1Z2luc1tpXSwgbmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxKSwgcGx1Z2luQ29uZmlnID0gbG9jYWxDb25maWdbbmFtZV07CiAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaChwbHVnaW4pOwogICAgICAgICAgICBtb2R1bGVzVG9Mb2FkLnB1c2gocGx1Z2luQ29uZmlnICYmIHBsdWdpbkNvbmZpZy5jb252ZW50aW9ucyB8fCBbXSk7CiAgICAgICAgICAgIG1vZHVsZXNDb25maWd1cmF0aW9uc1twbHVnaW5dID0gcGx1Z2luQ29uZmlnOwogICAgICAgIH0KICAgICAgICAvLyBOYW1lIGFuZCBjZmcgYXJlIGRlZmF1bHQgcHJvcGVydGllcyBvZiB0aGUgY29uZmlndXJhdGlvbiBjb250ZXh0CiAgICAgICAgICAgICAgICB2YXIgb3JkZXJlZFBsdWdpbnMgPSBbCiAgICAgICAgICAgICduYW1lJywgCiAgICAgICAgICAgICdjZmcnCiAgICAgICAgXSwgcmVsb29wID0gLy8gV2UgbG9vcCB0aHJvdWdoIHVudGlsIGFsbCB0aGUgcGx1Z2lucyBhcmUgaW4gcHJvcGVyIG9yZGVyLgogICAgICAgIHRydWUsIGlMZW4gPSBtb2R1bGVzVG9Mb2FkLmxlbmd0aCwgaSA9IDA7CiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGx1Z2lucyB1bnRpbCB3ZSBoYXZlIGEgc2V0IHRoYXQgd2lsbCBsb2FkIGluIHByb3BlciBvcmRlci4KICAgICAgICB3aGlsZShpIDwgaUxlbikgewogICAgICAgICAgICAvLyBUaGUgcGx1Z2luCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwbHVnaW4gPSBtb2R1bGVzVG9Mb2FkW2ldLCBuYW1lID0gLy8gVGhlIGltcGxpZWQgcGx1Z2luIG5hbWUKICAgICAgICAgICAgcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCBwbHVnaW5Db25maWcgPSAvLyBUaGUgcGx1Z2lucyBjb25maWd1cmF0aW9uCiAgICAgICAgICAgIGxvY2FsQ29uZmlnW25hbWVdOwogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgcGx1Z2luIGhhcyB0byByZXNvbHZlIGFueSBvdGhlciBwbHVnaW5zCiAgICAgICAgICAgIGlmKHBsdWdpbkNvbmZpZyAmJiBwbHVnaW5Db25maWcucmVzb2x2ZSAmJiBwbHVnaW5Db25maWcucmVzb2x2ZS5sZW5ndGggPiAwICYmICFhbGwocGx1Z2luQ29uZmlnLnJlc29sdmUsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYW55KG9yZGVyZWRQbHVnaW5zLCBmdW5jdGlvbiAoeikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB4ID09PSB6IHx8IHggPT09IHo7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkpIHsKICAgICAgICAgICAgICAgIC8vIFRoZSBtb2R1bGVzIHRvIGxvYWQuCiAgICAgICAgICAgICAgICAvLyBBbHNvIGluY2x1ZGVzIGFueSBjb252ZW50aW9ucy4KICAgICAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaC5hcHBseShtb2R1bGVzVG9Mb2FkLCBtb2R1bGVzVG9Mb2FkLnNwbGljZShpLCAyKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyByZW9yZGVyIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgICAgICAgIG9yZGVyZWRQbHVnaW5zLnB1c2gobmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gVGhlIG1vZHVsZXMgY29uZmlnCiAgICAgICAgdmFyIG1vZHVsZXMgPSBsb2NhbENvbmZpZy5tb2R1bGVzIHx8IFtdOwogICAgICAgIC8vIFRocnVzdCBhbmQgdGhydXN0L2NhcHN1bGUgYWxzbyBuZWVkIHRvIGJlIGxvYWRlZC4KICAgICAgICBtb2R1bGVzVG9Mb2FkLnB1c2guYXBwbHkobW9kdWxlc1RvTG9hZCwgWwogICAgICAgICAgICAndGhydXN0JywgCiAgICAgICAgICAgIHNldHRpbmdzLmNvbnZlbnRpb25zIHx8IFtdCiAgICAgICAgXSk7CiAgICAgICAgLy8gRmxhdHRlbiB0aGUgcmVzdWx0YW50IGFycmF5CiAgICAgICAgbW9kdWxlc1RvTG9hZCA9IGZsYXR0ZW4obW9kdWxlc1RvTG9hZCk7CiAgICAgICAgLy8gQ3JlYXRlIHRoZSBjb25maWd1cmF0aW9uIHNwZWMKICAgICAgICB2YXIgc3BlYyA9IHsKICAgICAgICAgICAgbmFtZTogbG9jYWxDb25maWcubmFtZSB8fCAnZ2xvYmFsJywKICAgICAgICAgICAgY2ZnOiBsb2NhbENvbmZpZwogICAgICAgIH07CiAgICAgICAgLy8gTG9hZCBldmVyeXRoaW5nCiAgICAgICAgcmVxdWlyZShtb2R1bGVzVG9Mb2FkLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDApOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEdldCByZWFkeSB0byBsb29wCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50UGx1Z2luID0gbnVsbCwgYWxsQ29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgbW9kdWxlcyBiZWluZyBsb2FkZWQKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG1vZHVsZXNUb0xvYWQubGVuZ3RoOyBpIDwgaUxlbiAtIHRocnVzdENvbnZlbnRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgcGx1Z2luIGFuZCBjb25maWd1cmF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbiA9IG1vZHVsZXNUb0xvYWRbaV0sIG1Db25maWcgPSBtb2R1bGVzQ29uZmlndXJhdGlvbnNbcGx1Z2luXTsKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHdlIGhhdmUgYSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgaWYobUNvbmZpZykgewogICAgICAgICAgICAgICAgICAgIC8vIExvYWQgYSBuZXcgcGx1Z2luLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbk9iamVjdCA9IGFyZ3NbaV0sIG5hbWUgPSAvLyBHZXQgdGhlIHBsdWdpbiBuYW1lCiAgICAgICAgICAgICAgICAgICAgcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCByZXNvbHZlSXRlbXMgPSAvLyBSZXNvbHZlIGFsbCB0aGUgcmVxdWlyZWQgaXRlbXMuCiAgICAgICAgICAgICAgICAgICAgbWFwKG1Db25maWcucmVzb2x2ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNwZWNbeF07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbkNsYXNzID0gcGx1Z2luT2JqZWN0W3BsdWdpbk9iamVjdC5jbGFzc05hbWVdOwogICAgICAgICAgICAgICAgICAgIC8vIEluc3RhbnRpYXRlIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGx1Z2luID0gc3BlY1tuYW1lXSA9IHV0aWwuaW5zdGFudGlhdGUocGx1Z2luQ2xhc3MsIHJlc29sdmVJdGVtcyk7CiAgICAgICAgICAgICAgICAgICAgLy8gU2V0dXAgdGhlIGNvbnZlbnRpb25zCiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBsdWdpbi5fX2NvbnZlbnRpb25zID0gW107CiAgICAgICAgICAgICAgICB9IGVsc2UgLy8gTG9hZCBhbGwgdGhlIGNvbnZlbnRpb25zCiAgICAgICAgICAgICAgICBpZihjdXJyZW50UGx1Z2luKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCB0aGUgY29udmVudGlvbnMgaW50byB0aGUgcGx1Z2luCiAgICAgICAgICAgICAgICAgICAgXy5mb3JPd24oYXJnc1tpXSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRQbHVnaW4uX19jb252ZW50aW9ucy5wdXNoKHgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIC8vIExvYWQgdGhlIGNvbnZlbnRpb25zIGludG8gdGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICAgICAgICAgICAgICBfLmZvck93bihhcmdzW2ldLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWxsQ29udmVudGlvbnMucHVzaCh4KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBUaGUgbGFzdCBjdXJyZW50IHBsdWdpbiwgd2lsbCBhbHdheXMgYmUgdGhydXN0LgogICAgICAgICAgICBjdXJyZW50UGx1Z2luLl9fY29udmVudGlvbnMgPSBhbGxDb252ZW50aW9uczsKICAgICAgICAgICAgdmFyIHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucyA9IGFyZ3Muc2xpY2UobW9kdWxlc1RvTG9hZC5sZW5ndGggLSB0aHJ1c3RDb252ZW50aW9ucy5sZW5ndGgpOwogICAgICAgICAgICB0aHJ1c3RDb252ZW50aW9uRGVmaW5pdGlvbnMgPSBmbGF0dGVuKG1hcCh0aHJ1c3RDb252ZW50aW9uRGVmaW5pdGlvbnMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWFwKHgsIGZ1bmN0aW9uICh6KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHo7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkpOwogICAgICAgICAgICBjdXJyZW50UGx1Z2luLl9fdGhydXN0Q29udmVudGlvbnMgPSB0aHJ1c3RDb252ZW50aW9uRGVmaW5pdGlvbnM7CiAgICAgICAgICAgIGFsbENvbnZlbnRpb25zLnB1c2guYXBwbHkoYWxsQ29udmVudGlvbnMsIHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucyk7CiAgICAgICAgICAgIC8vIEV4dGVuZCB0aHJ1c3Qgd2l0aCB0aGUgc3BlYwogICAgICAgICAgICBleHRlbmQoY3VycmVudFBsdWdpbiwgc3BlYyk7CiAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoc3BlYyk7CiAgICAgICAgfSwgZGVmZXIucmVqZWN0KTsKICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTsKICAgIH0KICAgIGV4cG9ydHMuc3RhZ2VUd28gPSBzdGFnZVR3bzsKICAgIC8qKgogICAgTG9hZHMgdXAgdGhlIGRlZmF1bHQgbW9kdWxlcyBhcyBpbmRpY2F0ZWQgdG8gdGhydXN0LgogICAgCiAgICBAbWV0aG9kIHN0YWdlVGhyZWUKICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIHVzZSB0byBsb2FkIHRoZSBtb2R1bGVzLgogICAgKiovCiAgICBmdW5jdGlvbiBzdGFnZVRocmVlKGNvbnRleHQpIHsKICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3QsIGRlZmVyID0gd2hlbi5kZWZlcigpLCBtb2R1bGVzID0gY29udGV4dC5jZmcubW9kdWxlczsKICAgICAgICBtb2R1bGVzID0gXy5maWx0ZXIobW9kdWxlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuICF0aHJ1c3QubW9kdWxlc1t4XTsKICAgICAgICB9KTsKICAgICAgICByZXF1aXJlKG1vZHVsZXMsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIE1vZHVsZSA9IHRtLk1vZHVsZTsKICAgICAgICAgICAgLy8gR2V0IHRoZSBkZWZpbml0aW9ucwogICAgICAgICAgICB2YXIgbW9kdWxlRGVmaW5pdGlvbnMgPSBhcmdzOwogICAgICAgICAgICAvLyBMb29wIG92ZXIgYWxsIHRoZSBtb2R1bGVzCiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBtb2R1bGVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgLy8gR2V0IHRoZSBtb2R1bGUgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2QgPSBtb2R1bGVzW2ldLCBkZWZpbml0aW9uID0gLy8gR2V0IHRoZSBkZWZpbml0aW9uCiAgICAgICAgICAgICAgICBtb2R1bGVEZWZpbml0aW9uc1tpXTsKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSB0aGUgaW5zdGFuY2UKICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IG5ldyBNb2R1bGUodGhydXN0LCBkZWZpbml0aW9uLCBtb2QpOwogICAgICAgICAgICAgICAgLy8gSW5qZWN0IGl0IGludG8gdGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgICAgICAgICAgbW9kdWxlSW5zdGFuY2UudGhydXN0Q3JlYXRlKHRocnVzdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmZXIucmVzb2x2ZShjb250ZXh0KTsKICAgICAgICB9LCBkZWZlci5yZWplY3QpOwogICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgfQogICAgZXhwb3J0cy5zdGFnZVRocmVlID0gc3RhZ2VUaHJlZTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9aWduaXRlLmpzLm1hcAo7Ci8qKgogKiBAbGljZW5zZSBSZXF1aXJlSlMgZG9tUmVhZHkgMi4wLjEgQ29weXJpZ2h0IChjKSAyMDEwLTIwMTIsIFRoZSBEb2pvIEZvdW5kYXRpb24gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICogQXZhaWxhYmxlIHZpYSB0aGUgTUlUIG9yIG5ldyBCU0QgbGljZW5zZS4KICogc2VlOiBodHRwOi8vZ2l0aHViLmNvbS9yZXF1aXJlanMvZG9tUmVhZHkgZm9yIGRldGFpbHMKICovCi8qanNsaW50ICovCi8qZ2xvYmFsIHJlcXVpcmU6IGZhbHNlLCBkZWZpbmU6IGZhbHNlLCByZXF1aXJlanM6IGZhbHNlLAogIHdpbmRvdzogZmFsc2UsIGNsZWFySW50ZXJ2YWw6IGZhbHNlLCBkb2N1bWVudDogZmFsc2UsCiAgc2VsZjogZmFsc2UsIHNldEludGVydmFsOiBmYWxzZSAqLwoKCmRlZmluZSgnZG9tUmVhZHknLFtdLGZ1bmN0aW9uICgpIHsKICAgIAoKICAgIHZhciBpc1RvcCwgdGVzdERpdiwgc2Nyb2xsSW50ZXJ2YWxJZCwKICAgICAgICBpc0Jyb3dzZXIgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuZG9jdW1lbnQsCiAgICAgICAgaXNQYWdlTG9hZGVkID0gIWlzQnJvd3NlciwKICAgICAgICBkb2MgPSBpc0Jyb3dzZXIgPyBkb2N1bWVudCA6IG51bGwsCiAgICAgICAgcmVhZHlDYWxscyA9IFtdOwoKICAgIGZ1bmN0aW9uIHJ1bkNhbGxiYWNrcyhjYWxsYmFja3MpIHsKICAgICAgICB2YXIgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY2FsbGJhY2tzLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgIGNhbGxiYWNrc1tpXShkb2MpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjYWxsUmVhZHkoKSB7CiAgICAgICAgdmFyIGNhbGxiYWNrcyA9IHJlYWR5Q2FsbHM7CgogICAgICAgIGlmIChpc1BhZ2VMb2FkZWQpIHsKICAgICAgICAgICAgLy9DYWxsIHRoZSBET00gcmVhZHkgY2FsbGJhY2tzCiAgICAgICAgICAgIGlmIChjYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZWFkeUNhbGxzID0gW107CiAgICAgICAgICAgICAgICBydW5DYWxsYmFja3MoY2FsbGJhY2tzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNldHMgdGhlIHBhZ2UgYXMgbG9hZGVkLgogICAgICovCiAgICBmdW5jdGlvbiBwYWdlTG9hZGVkKCkgewogICAgICAgIGlmICghaXNQYWdlTG9hZGVkKSB7CiAgICAgICAgICAgIGlzUGFnZUxvYWRlZCA9IHRydWU7CiAgICAgICAgICAgIGlmIChzY3JvbGxJbnRlcnZhbElkKSB7CiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHNjcm9sbEludGVydmFsSWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjYWxsUmVhZHkoKTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKGlzQnJvd3NlcikgewogICAgICAgIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgIC8vU3RhbmRhcmRzLiBIb29yYXkhIEFzc3VtcHRpb24gaGVyZSB0aGF0IGlmIHN0YW5kYXJkcyBiYXNlZCwKICAgICAgICAgICAgLy9pdCBrbm93cyBhYm91dCBET01Db250ZW50TG9hZGVkLgogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgcGFnZUxvYWRlZCwgZmFsc2UpOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibG9hZCIsIHBhZ2VMb2FkZWQsIGZhbHNlKTsKICAgICAgICB9IGVsc2UgaWYgKHdpbmRvdy5hdHRhY2hFdmVudCkgewogICAgICAgICAgICB3aW5kb3cuYXR0YWNoRXZlbnQoIm9ubG9hZCIsIHBhZ2VMb2FkZWQpOwoKICAgICAgICAgICAgdGVzdERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaXNUb3AgPSB3aW5kb3cuZnJhbWVFbGVtZW50ID09PSBudWxsOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7fQoKICAgICAgICAgICAgLy9ET01Db250ZW50TG9hZGVkIGFwcHJveGltYXRpb24gdGhhdCB1c2VzIGEgZG9TY3JvbGwsIGFzIGZvdW5kIGJ5CiAgICAgICAgICAgIC8vRGllZ28gUGVyaW5pOiBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLywKICAgICAgICAgICAgLy9idXQgbW9kaWZpZWQgYnkgb3RoZXIgY29udHJpYnV0b3JzLCBpbmNsdWRpbmcgamRhbHRvbgogICAgICAgICAgICBpZiAodGVzdERpdi5kb1Njcm9sbCAmJiBpc1RvcCAmJiB3aW5kb3cuZXh0ZXJuYWwpIHsKICAgICAgICAgICAgICAgIHNjcm9sbEludGVydmFsSWQgPSBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGVzdERpdi5kb1Njcm9sbCgpOwogICAgICAgICAgICAgICAgICAgICAgICBwYWdlTG9hZGVkKCk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgICAgIH0sIDMwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy9DaGVjayBpZiBkb2N1bWVudCBhbHJlYWR5IGNvbXBsZXRlLCBhbmQgaWYgc28sIGp1c3QgdHJpZ2dlciBwYWdlIGxvYWQKICAgICAgICAvL2xpc3RlbmVycy4gTGF0ZXN0IHdlYmtpdCBicm93c2VycyBhbHNvIHVzZSAiaW50ZXJhY3RpdmUiLCBhbmQKICAgICAgICAvL3dpbGwgZmlyZSB0aGUgb25ET01Db250ZW50TG9hZGVkIGJlZm9yZSAiaW50ZXJhY3RpdmUiIGJ1dCBub3QgYWZ0ZXIKICAgICAgICAvL2VudGVyaW5nICJpbnRlcmFjdGl2ZSIgb3IgImNvbXBsZXRlIi4gTW9yZSBkZXRhaWxzOgogICAgICAgIC8vaHR0cDovL2Rldi53My5vcmcvaHRtbDUvc3BlYy90aGUtZW5kLmh0bWwjdGhlLWVuZAogICAgICAgIC8vaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zNjY1NTYxL2RvY3VtZW50LXJlYWR5c3RhdGUtb2YtaW50ZXJhY3RpdmUtdnMtb25kb21jb250ZW50bG9hZGVkCiAgICAgICAgLy9IbW0sIHRoaXMgaXMgbW9yZSBjb21wbGljYXRlZCBvbiBmdXJ0aGVyIHVzZSwgc2VlICJmaXJpbmcgdG9vIGVhcmx5IgogICAgICAgIC8vYnVnOiBodHRwczovL2dpdGh1Yi5jb20vcmVxdWlyZWpzL2RvbVJlYWR5L2lzc3Vlcy8xCiAgICAgICAgLy9zbyByZW1vdmluZyB0aGUgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImludGVyYWN0aXZlIiB0ZXN0LgogICAgICAgIC8vVGhlcmUgaXMgc3RpbGwgYSB3aW5kb3cub25sb2FkIGJpbmRpbmcgdGhhdCBzaG91bGQgZ2V0IGZpcmVkIGlmCiAgICAgICAgLy9ET01Db250ZW50TG9hZGVkIGlzIG1pc3NlZC4KICAgICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIikgewogICAgICAgICAgICBwYWdlTG9hZGVkKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKiBTVEFSVCBPRiBQVUJMSUMgQVBJICoqLwoKICAgIC8qKgogICAgICogUmVnaXN0ZXJzIGEgY2FsbGJhY2sgZm9yIERPTSByZWFkeS4gSWYgRE9NIGlzIGFscmVhZHkgcmVhZHksIHRoZQogICAgICogY2FsbGJhY2sgaXMgY2FsbGVkIGltbWVkaWF0ZWx5LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICAgICAqLwogICAgZnVuY3Rpb24gZG9tUmVhZHkoY2FsbGJhY2spIHsKICAgICAgICBpZiAoaXNQYWdlTG9hZGVkKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKGRvYyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVhZHlDYWxscy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRvbVJlYWR5OwogICAgfQoKICAgIGRvbVJlYWR5LnZlcnNpb24gPSAnMi4wLjEnOwoKICAgIC8qKgogICAgICogTG9hZGVyIFBsdWdpbiBBUEkgbWV0aG9kCiAgICAgKi8KICAgIGRvbVJlYWR5LmxvYWQgPSBmdW5jdGlvbiAobmFtZSwgcmVxLCBvbkxvYWQsIGNvbmZpZykgewogICAgICAgIGlmIChjb25maWcuaXNCdWlsZCkgewogICAgICAgICAgICBvbkxvYWQobnVsbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZG9tUmVhZHkob25Mb2FkKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKiBFTkQgT0YgUFVCTElDIEFQSSAqKi8KCiAgICByZXR1cm4gZG9tUmVhZHk7Cn0pOwoKZGVmaW5lKCd0aHJ1c3QvbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAnLi9sb2cnLCAnLi9pbnN0YW5jZScsICcuL2lnbml0ZScsICcuL2NhcHN1bGUnLCAnZG9tUmVhZHknLCAnaGFzJywgJ3RocnVzdC9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fbG9nX18sIF9fdGhydXN0SW5zdGFuY2VfXywgX19pZ25pdGVTcGVjX18sIF9fbV9fLCBfX2RvbVJlYWR5X18sIF9faGFzX18sIF9fdENvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciB0aHJ1c3RJbnN0YW5jZSA9IF9fdGhydXN0SW5zdGFuY2VfXzsKCiAgICB2YXIgaWduaXRlU3BlYyA9IF9faWduaXRlU3BlY19fOwoKICAgIHZhciBtID0gX19tX187CgogICAgdmFyIE1vZHVsZSA9IG0uTW9kdWxlOwogICAgdmFyIGRvbVJlYWR5ID0gX19kb21SZWFkeV9fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciB0Q29uZmlnID0gX190Q29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnVGhydXN0JzsKICAgIC8qKgogICAgVGhlIHRocnVzdCBhcHBsaWNhdGlvbiEKICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBtYWluIHRocnVzdAogICAgKiovCiAgICAgICAgdmFyIElOSVQgPSAnaW5pdCcsIFNUQVJUID0gJ3N0YXJ0JywgUkVBRFkgPSAncmVhZHknLCBTVE9QID0gJ3N0b3AnLCBERVNUUk9ZID0gJ2Rlc3Ryb3knLCBDT1VOVERPV04gPSAnY291bnRkb3duJywgSUdOSVRFID0gJ2lnbml0ZScsIE9SQklUID0gJ29yYml0JywgREVQTE9ZID0gJ2RlcGxveScsIERFT1JCSVQgPSAnZGVvcmJpdCcsIFNQTEFTSERPV04gPSAnc3BsYXNoZG93bicsIElOT1JCSVQgPSAnaW5PcmJpdCcsIG1lbW9pemUgPSBfLm1lbW9pemUsIGVhY2ggPSBfLmVhY2gsIG1hcCA9IF8ubWFwLCBleHRlbmQgPSBfLmV4dGVuZCwgd2hlbiA9IHV0aWwud2hlbiwgYmluZCA9IF8uYmluZCwgaXNBcnJheSA9IF8uaXNBcnJheSwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIHRvQXJyYXkgPSBfLnRvQXJyYXksIG1lcmdlID0gXy5tZXJnZSwgZmxhdHRlbiA9IF8uZmxhdHRlbiwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIHJlc29sdmVNZXRob2RzID0gWwogICAgICAgIElOSVQsIAogICAgICAgIFNUQVJULCAKICAgICAgICBSRUFEWSwgCiAgICAgICAgU1RPUCwgCiAgICAgICAgREVTVFJPWQogICAgXSwgaW5zdGFuY2VzID0gdGhydXN0SW5zdGFuY2UuaW5zdGFuY2VzLCBsb2FkaW5nSW5zdGFuY2VzID0gdGhydXN0SW5zdGFuY2UubG9hZGluZ0luc3RhbmNlcywgc2FmZUludm9rZSA9IHV0aWwuc2FmZUludm9rZTsKICAgIC8vI3JlZ2lvbiBSdW5uZXIgRmFjdG9yaWVzCiAgICB2YXIgcnVuUnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHZhciBjb252ZW50aW9uTWV0aG9kID0gKG1ldGhvZCA9PT0gU1RPUCAmJiBTVEFSVCkgfHwgKG1ldGhvZCA9PT0gREVTVFJPWSAmJiBJTklUKSB8fCBtZXRob2QsIGNvbnZlbnRpb25WYWx1ZSA9ICEobWV0aG9kID09PSBTVE9QIHx8IG1ldGhvZCA9PT0gREVTVFJPWSksIHVuc2V0UmVhZHkgPSBtZXRob2QgPT09IFNUT1AsIGNvbnZlbnRpb25DaGVjayA9IGNvbnZlbnRpb25NZXRob2QgIT09IG1ldGhvZCwgY29udmVudGlvbk5hbWUgPSBmb3JtYXQoJ3swfS1zdGF0dXMnLCBjb252ZW50aW9uTWV0aG9kKSwgcnVubmVyID0gcnVubmVyRmFjdG9yeShtZXRob2QsIGNvbnZlbnRpb25OYW1lLCBjb252ZW50aW9uVmFsdWUsIHVuc2V0UmVhZHkpLCBsb2dNZXNzYWdlID0gZm9ybWF0KCdUaHJ1c3Q6IHswfWluZyBtb2R1bGUgInt7MH19IiBmYWlsZWQhJywgbWV0aG9kKSwgcnVubmluZ01lc3NhZ2UgPSBmb3JtYXQoJ1RocnVzdDogUnVubmluZyB7MH0gZm9yIG1vZHVsZSAie3swfX0iLicsIG1ldGhvZCk7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lcykgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCFpc0FycmF5KG5hbWVzKSkgewogICAgICAgICAgICAgICAgbmFtZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgbmFtZXMKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3MsIHJlc3VsdHMgPSBbXTsKICAgICAgICAgICAgZWFjaChuYW1lcywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQocnVubmluZ01lc3NhZ2UsIG5hbWUpKTsKICAgICAgICAgICAgICAgIHZhciBtb2QgPSB0aGF0Lm1vZHVsZXNbbmFtZV07CiAgICAgICAgICAgICAgICBpZighbW9kICYmICF0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAvLyB0cnkgdG8gZmV0Y2ggdGhlIG1vZHVsZS4KICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm5pbmcgdGhlIHByb3BlciBkZWZlciBpbiBpdCdzIHBsYWNlCiAgICAgICAgICAgICAgICAgICAgdmFyIGxvYWRlckRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgICAgICBuYW1lCiAgICAgICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKG1vZHVsZURlZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jcmVhdGVNb2R1bGUobW9kdWxlRGVmbiAmJiBtb2R1bGVEZWZuLm5hbWUgfHwgbmFtZSwgbW9kdWxlRGVmbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBydW5SdW5uZXJGYWN0b3J5KG1ldGhvZCkuYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlRGVmbi5uYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2hlbi5jaGFpbih3aGVuLmFsbChmbGF0dGVuKHJlc3VsdCkpLCBsb2FkZXJEZWZlcik7CiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBsb2FkZXJEZWZlci5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGxvYWRlckRlZmVyLnByb21pc2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKChjb252ZW50aW9uQ2hlY2sgJiYgbW9kLmNvbnZlbnRpb24oY29udmVudGlvbk5hbWUpKSB8fCAhbW9kLmNvbnZlbnRpb24oY29udmVudGlvbk5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoZmFsc2UgJiYgdENvbmZpZy50aHJvd0Vycm9ycykgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocnVubmVyKHRoYXQsIG5hbWUsIG1vZCwgYXJncykpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHJ1bm5lcih0aGF0LCBuYW1lLCBtb2QsIGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmVycm9yKGZvcm1hdChsb2dNZXNzYWdlLCBuYW1lKSwgZSwgZS5zdGFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0cy5sZW5ndGggJiYgcmVzdWx0czsKICAgICAgICB9OwogICAgfSk7CiAgICB2YXIgcnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCwgY29udmVudGlvbk5hbWUsIGNvbnZlbnRpb25WYWx1ZSwgdW5zZXRSZWFkeSkgewogICAgICAgIHZhciBldmVudE5hbWUgPSBmb3JtYXQoJ3RocnVzdC9tb2R1bGUvezB9JywgbWV0aG9kKSwgaW5mb0Zvcm1hdCA9IGZvcm1hdCgnVGhydXN0OiB7MH1pbmcgbW9kdWxlICJ7ezB9fSInLCBtZXRob2QuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBtZXRob2Quc3Vic3RyaW5nKDEpKSwgZGVidWdGb3JtYXQgPSBmb3JtYXQoJ1RocnVzdDogQ2FsbGluZyBtb2R1bGUgInt7MH19IiB7MH0oKScsIG1ldGhvZCksIGNvbXBBZnRlciA9IG1ldGhvZCA9PT0gU1RPUCB8fCBtZXRob2QgPT09IERFU1RST1kgfHwgZmFsc2U7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0aGF0LCBuYW1lLCBtb2QsIGFyZ3MpIHsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmluZm8oZm9ybWF0KGluZm9Gb3JtYXQsIG5hbWUpKTsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdChjb252ZW50aW9uTmFtZSwgbmFtZSkpOwogICAgICAgICAgICByZXR1cm4gbW9kLnRocnVzdENhbGwobWV0aG9kLCBjb21wQWZ0ZXIsIF9fZ2V0TW9kdWxlQXJncyh0aGF0Lm5hbWUsIG5hbWUsIGFyZ3MpKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoYXQubWVkaWF0b3IgJiYgdGhhdC5tZWRpYXRvci5maXJlKGV2ZW50TmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihjb252ZW50aW9uTmFtZSwgY29udmVudGlvblZhbHVlKTsKICAgICAgICAgICAgICAgIGlmKHVuc2V0UmVhZHkpIHsKICAgICAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihSRUFEWSArICctc3RhdHVzJywgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgfSk7CiAgICB2YXIgYWxsUnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHZhciBpbmZvRm9ybWF0ID0gZm9ybWF0KCdUaHJ1c3Q6IHswfWluZyBhbGwgbW9kdWxlcy4uLiBbe3swfX1dJywgbWV0aG9kLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbWV0aG9kLnN1YnN0cmluZygxKSksIHBsdXJhbE5hbWUgPSBmb3JtYXQoJ3RocnVzdC9tb2R1bGUvYWxsL3swfScsIG1ldGhvZCksIGNoZWNrQXV0b1N0YXJ0ID0gbWV0aG9kID09PSBJTklUIHx8IG1ldGhvZCA9PT0gU1RBUlQgfHwgbWV0aG9kID09PSBSRUFEWTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRoYXQpIHsKICAgICAgICAgICAgdGhhdC5tZWRpYXRvciAmJiB0aGF0Lm1lZGlhdG9yLmZpcmUocGx1cmFsTmFtZSk7CiAgICAgICAgICAgIHZhciBtb2R1bGVzID0gdGhhdC5tb2R1bGVzLCByZXN1bHRzID0gW107CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCBtYXAobW9kdWxlcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB4LmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpICYmIGk7CiAgICAgICAgICAgIH0pLmpvaW4oJywgJykpKTsKICAgICAgICAgICAgZWFjaChtb2R1bGVzLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgaWYoIWNoZWNrQXV0b1N0YXJ0IHx8IChjaGVja0F1dG9TdGFydCAmJiB4LmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpKSkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaCh0aGF0W21ldGhvZF0oaSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYodGhhdC5zdGFydGluZ01vZHVsZXMgJiYgY2hlY2tBdXRvU3RhcnQpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCB0aGF0LnN0YXJ0aW5nTW9kdWxlcy5qb2luKCcsICcpKSk7CiAgICAgICAgICAgICAgICB0aGF0W21ldGhvZF0odGhhdC5zdGFydGluZ01vZHVsZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChyZXN1bHRzKTsKICAgICAgICB9OwogICAgfSk7CiAgICBmdW5jdGlvbiBmaXJlVGhydXN0RXZlbnQodGhhdCwgZXZlbnQpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGF0Lm1lZGlhdG9yICYmIHRoYXQubWVkaWF0b3IuZmlyZShldmVudCk7CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBtZXRob2QsIHN0b3BwaW5nKSB7CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgZWFjaCh0aGF0LmNoaWxkcmVuLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgaWYoc3RvcHBpbmcpIHsKICAgICAgICAgICAgICAgIGNoaWxkLl9fcHJldmlvdXNTdGF0ZSA9IGNoaWxkLnN0YXJ0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoY2hpbGQuY2ZnLmF1dG9TdGFydCB8fCAoIXN0b3BwaW5nICYmIGNoaWxkLl9fcHJldmlvdXNTdGF0ZSkgfHwgKHN0b3BwaW5nICYmIGNoaWxkLnN0YXJ0ZWQpKSB7CiAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKGNoaWxkW21ldGhvZF0oZmFsc2UsIHRydWUpKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmKGl0ZW1zLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoaXRlbXMpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgYXJyKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuZmxhdHRlblRvUHJvbWlzZXMoYXJyLmNvbmNhdCh0aGF0LmNmZy5hc3luYyAmJiBbCiAgICAgICAgICAgIHdoZW4uZGVsYXkoMCkKICAgICAgICBdIHx8IFtdKSk7CiAgICB9CiAgICB2YXIgdGhydXN0TG9nRXZlbnQ7CiAgICBpZihmYWxzZSkgewogICAgICAgIHRocnVzdExvZ0V2ZW50ID0gZnVuY3Rpb24gKG1lc3NhZ2UsIG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGxvZy5kZWJ1Zyhmb3JtYXQuYXBwbHkoZm9ybWF0LCBbCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZQogICAgICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSkpOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAgIHRocnVzdExvZ0V2ZW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdXRpbC5ub29wOwogICAgICAgIH07CiAgICB9CiAgICB2YXIgdGhydXN0U2hvdWxkRXhlY3V0ZSA9IGZ1bmN0aW9uICh0aGF0LCBjYWxsZWRCeVBhcmVudCwgc3RvcHBpbmcpIHsKICAgICAgICBpZih0aGF0LnBhcmVudCAmJiB0aGF0LmNmZy5jaGlsZEluc3RhbmNlICYmICF0aGF0LnBhcmVudC5zdGFydGVkICYmICFjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICBsb2cud2Fybihmb3JtYXQoJ0Nhbm5vdCBleGVjdXRlIG9uIGNoaWxkIGluc3RhbmNlICJ7MH0iIHBhcmVudCBpbnN0YW5jZSAiezF9IiBtdXN0IGJlIHN0YXJ0ZWQgZmlyc3QuJywgdGhhdC5uYW1lLCB0aGF0LnBhcmVudC5uYW1lKSk7CiAgICAgICAgfQogICAgICAgIGlmKCFzdG9wcGluZyAmJiB0aGF0LnN0YXJ0ZWQgfHwgc3RvcHBpbmcgJiYgIXRoYXQuc3RhcnRlZCkgewogICAgICAgICAgICBsb2cud2Fybihmb3JtYXQoJ0Nhbm5vdCBzdGFydCB0aHJ1c3QgaW5zdGFuY2UgInswfSIgc2luY2UgaXQgYWxyZWFkeSBzdGFydGVkJywgdGhhdC5uYW1lKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfTsKICAgIC8qKgogICAgR2V0cyB0aGUgbW9kdWxlcyBhcmd1bWVudHMgZnJvbSB0aGUgcmVnaXN0cmF0aW9ucy4KICAgIAogICAgSWYgb3JpZ2luYWwgYXJncyBjb250YWlucyBhbnl0aGluZyBpdCBpcyBwYXNzZWQgaW5zdGVhZCBvZiB0aGUgcmVnaXN0cmF0aW9ucy4KICAgIElmIHRoZSByZWdpc3RyYXRpb25zIGFyZSBpbiBwbGFjZSBpdCB3aWxsIHJldHVybiB0aGVtLgogICAgCiAgICBAbWV0aG9kIF9fZ2V0TW9kdWxlQXJncwogICAgQHN0YXRpYwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lCiAgICBAcGFyYW0ge0FycmF5fSBvcmlnaW5hbEFyZ3MgVGhlIG9yaWdpbmFsIGFyZ3VtZW50cyBwYXNzZWQgaW50byB0aGUgY2FsbGluZyBtZXRob2QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIF9fZ2V0TW9kdWxlQXJncyhpbnN0YW5jZU5hbWUsIG5hbWUsIG9yaWdpbmFsQXJncykgewogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShvcmlnaW5hbEFyZ3MpOwogICAgICAgIGlmKGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBhcmdzOwogICAgICAgIH0KICAgICAgICB2YXIgaW5zdGFuY2VSZWdpc3RyYXRpb25zID0gVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdOwogICAgICAgIGlmKGluc3RhbmNlUmVnaXN0cmF0aW9ucyAmJiBpbnN0YW5jZVJlZ2lzdHJhdGlvbnNbbmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlUmVnaXN0cmF0aW9uc1tuYW1lXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICB9CiAgICAvLyNlbmRyZWdpb24KICAgIC8qKgogICAgVGhlIHByaW1hcnkgdGhydXN0IGNsYXNzLgogICAgCiAgICBAY2xhc3MgdGhydXN0LlRocnVzdAogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGlzIHRocnVzdCBpbnN0YW5jZQogICAgQHJldHVybnMge1RocnVzdH0KICAgICoqLwogICAgdmFyIFRocnVzdCA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gVGhydXN0KG5hbWUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gW107CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9fdGhydXN0Q29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5jZmcgPSBtZXJnZSh0Q29uZmlnLCB7CiAgICAgICAgICAgICAgICBhdXRvU3RhcnQ6IGZhbHNlLAogICAgICAgICAgICAgICAgYXN5bmM6IGZhbHNlLAogICAgICAgICAgICAgICAgY2hpbGRJbnN0YW5jZTogZmFsc2UsCiAgICAgICAgICAgICAgICBhdXRvbWF0aWNMaWZlY3ljbGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gbWVyZ2UodENvbmZpZywgewogICAgICAgICAgICAgICAgYXV0b1N0YXJ0OiBmYWxzZSwKICAgICAgICAgICAgICAgIGFzeW5jOiBmYWxzZSwKICAgICAgICAgICAgICAgIGNoaWxkSW5zdGFuY2U6IGZhbHNlLAogICAgICAgICAgICAgICAgYXV0b21hdGljTGlmZWN5Y2xlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB0aGlzLm1vZHVsZXMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZmFpbGVkTW9kdWxlcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdOwogICAgICAgICAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9ucyA9IHsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY3JlYXRlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyB0aHJ1c3QgbW9kdWxlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHVuaXF1ZSBtb2R1bGUgbmFtZS4KICAgICAgICBAcGFyYW0ge09iamVjdH0gbW9kdWxlIFRoZSBtb2R1bGUgZGVmaW50aW9uLgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gcHJlQnVpbGQgSGFzIHRoaXMgbW9kdWxlIGJlZW4gcHJlYnVpbHQsIGluIG90aGVyIHdvcmRzIGhhcyBpdCBiZWVuIGNyZWF0ZWQsIGJ5IHdpcmUuanMgYW5kIG5lZWRzIHRvIGJlIGluamVjdGVkLgogICAgICAgIEByZXR1cm5zIHtNb2R1bGV9IFRoZSBuZXcgbW9kdWxlIGluc3RhbmNlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCBtb2QsIHByZUJ1aWx0KSB7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ1RocnVzdDogQ3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mICJ7MH0iJywgbmFtZSkpOwogICAgICAgICAgICB2YXIgb2xkTW9kdWxlLCB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYocHJlQnVpbHQpIHsKICAgICAgICAgICAgICAgIG9sZE1vZHVsZSA9IG1vZDsKICAgICAgICAgICAgICAgIG1vZCA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighcHJlQnVpbHQpIHsKICAgICAgICAgICAgICAgIG1vZCA9IG5ldyBtLk1vZHVsZSh0aGF0LCBtb2QsIG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbW9kID0gb2xkTW9kdWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vZHVsZXMgY2Fubm90IGhhdmUgZHVwbGljYXRlIG5hbWVzLCBjaG9vc2UgYSBuZXcgb25lLgogICAgICAgICAgICBpZih0aGF0Lm1vZHVsZXNbbW9kLm5hbWVdKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdEdXBsaWNhdGUgbW9kdWxlIG5hbWUgInswfSIuJywgbmFtZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG0gaXMgdGhlIG1lZGlhdG9ycyBpbnRlcm5hbCBtb2R1bGUuCiAgICAgICAgICAgIHRoYXQubW9kdWxlc1ttb2QubmFtZV0gPSBtb2Q7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdCgnVGhydXN0OiBDcmVhdGVkIG1vZHVsZSAiezB9IicsIG5hbWUpKTsKICAgICAgICAgICAgLy8gTm90aWZ5IHRoZSBtZWRpYXRvciB0aGF0IGEgbW9kdWxlIGhhcyBiZWVuIGNyZWF0ZWQuCiAgICAgICAgICAgIHRoYXQubWVkaWF0b3IuZmlyZSgndGhydXN0L21vZHVsZS9jcmVhdGUnLCBuYW1lKTsKICAgICAgICAgICAgaWYodGhhdCAmJiB0aGF0LnN0YXJ0ZWQgJiYgbW9kLmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpKSB7CiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0KG1vZC5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdGFydHVwID0gLy8jcmVnaW9uIEdsb2JhbCBSdW5uZXJzCiAgICAgICAgZnVuY3Rpb24gKGV2ZW50LCBldmVudFR5cGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIGV2ZW50LCB0aGF0KSwgCiAgICAgICAgICAgICAgICB0aGF0W2V2ZW50VHlwZV0oKSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgZXZlbnQpCiAgICAgICAgICAgIF0pKTsKICAgICAgICAgICAgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKGZpcmVUaHJ1c3RFdmVudCh0aGF0LCAndGhydXN0LycgKyBldmVudFR5cGUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLl9jb3VudGRvd24gPSBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxzZSAmJiB0aHJ1c3RMb2dFdmVudCgnTGF1bmNoIGluc3RhbmNlICJ7MH0iIGluIDUuLi4gNC4uLiAzLi4uIDIuLi4gMS4uLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zdGFydHVwKENPVU5URE9XTiwgSU5JVCk7CiAgICAgICAgICAgIGZhbHNlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGhhcyBiZWVuIGluaXRhbGl6ZWQuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5jb3VudGRvd24gPSAvKioKICAgICAgICBCZWdpbnMgdGhlIGNvdW50ZG93biB0byB0aHJ1c3RzIHN0YXJ0LgogICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNvdW50ZG93bgogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBjb3VudGRvd24gaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoYXQuY2ZnLmF1dG9tYXRpY0xpZmVjeWNsZSAmJiAoIXRoYXQuY2ZnLmNoaWxkSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gVGhydXN0LmxhdW5jaFNlcXVlbmNlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhhdC5fY291bnRkb3duKGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaWduaXRlID0gLyoqCiAgICAgICAgQmVnaW5zIHRoZSBpbmdpdGlvbiBhcyB0aHJ1c3Qgc3RhcnRzIHVwLgogICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGlnbml0ZQogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBpbmdpdGlvbiBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFsc2UgJiYgdGhydXN0TG9nRXZlbnQoJ0ZpcmluZyByb2NrZXRzIGZvciB0aHVyc3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnN0YXJ0dXAoSUdOSVRFLCBTVEFSVCk7CiAgICAgICAgICAgIGZhbHNlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGhhcyBiZWVuIHN0YXJ0ZWQuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5vcmJpdCA9IC8qKgogICAgICAgIFRocnVzdCBwcmVwYXJlcyBmb3Igb3JiaXQuCiAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgb3JiaXQKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aHJ1c3QgaXMgaW4gb3JiaXQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFsc2UgJiYgdGhydXN0TG9nRXZlbnQoJ0ZpcmluZyBzdGFnZSB0d28gdGhydXN0ZXJzIGZvciB0aHJ1c3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKSgpOwogICAgICAgICAgICB2YXIgZG9tUmVhZHlEZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgZG9tUmVhZHlEZWZlci5wcm9taXNlLnRoZW4oZmlyZVRocnVzdEV2ZW50KHRoYXQsICd0aHJ1c3QvZG9tL3JlYWR5JykpOwogICAgICAgICAgICBkb21SZWFkeShkb21SZWFkeURlZmVyLnJlc29sdmUpOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgZG9tUmVhZHlEZWZlci5wcm9taXNlLCAKICAgICAgICAgICAgICAgIHNhZmVJbnZva2UodGhhdC5fX2NvbnZlbnRpb25zLCBPUkJJVCwgdGhhdCksIAogICAgICAgICAgICAgICAgY2hpbGRyZW5DYWxsTWV0aG9kKHRoYXQsIE9SQklUKQogICAgICAgICAgICBdKSk7CiAgICAgICAgICAgIGZhbHNlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGlzIGFsbW9zdCByZWFkeS4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlcGxveSA9IC8qKgogICAgICAgIFRocnVzdCBkZXBsb3lzIGNvbXBvbmVudHMgaW4gb3JiaXQKICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBkZXBsb3kKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aHJ1c3QgaGFzIGZ1bGx5IGRlcGxveWVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGZhbHNlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZVN0YXJ0ID0gdGhhdC5jb25maWcuZGVidWcudGltZVN0YXJ0LCB0aW1lRW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCksIHN0YXJ0VGltZSA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KSwgdHRvRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R0bycpOwogICAgICAgICAgICAgICAgaWYodHRvRGl2KSB7CiAgICAgICAgICAgICAgICAgICAgdHRvRGl2LmlubmVySFRNTCA9IHN0YXJ0VGltZSArICdtcyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIHRoYXQucmVhZHkoKSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgREVQTE9ZKQogICAgICAgICAgICBdKSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC9yZWFkeScpKTsKICAgICAgICAgICAgZmFsc2UgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IHJlYWR5LicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaW5PcmJpdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGF0LnN0YXJ0ZWQgPSB0cnVlOwogICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgSU5PUkJJVCk7CiAgICAgICAgICAgIGlmKGZhbHNlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZVN0YXJ0ID0gdGhhdC5jb25maWcuZGVidWcudGltZVN0YXJ0LCB0aW1lRW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCksIHN0YXJ0VGltZSA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KTsKICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdTdGFydGVkIGluICcgKyBzdGFydFRpbWUgKyAnbXMnKTsKICAgICAgICAgICAgICAgIHZhciB0dHJEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHRyJyk7CiAgICAgICAgICAgICAgICBpZih0dHJEaXYpIHsKICAgICAgICAgICAgICAgICAgICB0dHJEaXYuaW5uZXJIVE1MID0gc3RhcnRUaW1lICsgJ21zJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zaHV0ZG93biA9IGZ1bmN0aW9uIChldmVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBldmVudCwgdHJ1ZSksIAogICAgICAgICAgICAgICAgdGhhdFtldmVudFR5cGVdKCksIAogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIGV2ZW50LCB0aGF0KQogICAgICAgICAgICBdKSk7CiAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC8nICsgZXZlbnRUeXBlKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fZGVvcmJpdCA9IGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50LCB0cnVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZhbHNlICYmIHRocnVzdExvZ0V2ZW50KCdSZWVudGVyaW5nIGVhcnRocyBhdG1vc3BoZXJlIGZvciB0aHJ1c3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnNodXRkb3duKERFT1JCSVQsIFNUT1ApOwogICAgICAgICAgICBmYWxzZSAmJiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4odGhydXN0TG9nRXZlbnQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBpcyBub3cgc3RvcHBlZC4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlb3JiaXQgPSAvKioKICAgICAgICBCZWdpbnMgdGhlIGRlb3JiaXQgYXMgdGhydXN0IHNodXRkb3duLgogICAgICAgIFNodXRkb3duIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBkZW9yYml0CiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGluZ2l0aW9uIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCwgdHJ1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGF0LmNmZy5hdXRvbWF0aWNMaWZlY3ljbGUgJiYgKCF0aGF0LmNmZy5jaGlsZEluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uc2VxdWVuY2UoWwogICAgICAgICAgICAgICAgICAgIF8uYmluZCh0aGF0Ll9kZW9yYml0LCB0aGF0KSwgCiAgICAgICAgICAgICAgICAgICAgXy5iaW5kKHRoYXQuc3BsYXNoZG93biwgdGhhdCkKICAgICAgICAgICAgICAgIF0sIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhhdC5fZGVvcmJpdChjYWxsZWRCeVBhcmVudCk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnNwbGFzaGRvd24gPSAvKioKICAgICAgICBCZWdpbnMgdGhlIHNwbGFzaGRvd24gYXMgdGhydXN0IHNodXRkb3duLgogICAgICAgIFNodXRkb3duIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzcGxhc2hkb3duCiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGluZ2l0aW9uIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCwgdHJ1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxzZSAmJiB0aHJ1c3RMb2dFdmVudCgnTGFuZGluZyBpbiB0aGUgbWlkZGxlIG9mIHRoZSBhdGxhbnRpYyBmb3IgdGhydXN0IGluc3RhbmNlICJ7MH0iLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zaHV0ZG93bihTUExBU0hET1dOLCBERVNUUk9ZKTsKICAgICAgICAgICAgZmFsc2UgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IGJlaW5nIGRlc3Ryb3llZCcsIHRoYXQubmFtZSkpOwogICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhhdC5zdGFydGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUubW9kdWxlTWV0aG9kID0gZnVuY3Rpb24gKG1ldGhvZCwgbmFtZSwgYXJncywgcmV2ZXJzZSwgZGVwZW5kZW50TWV0aG9kcywgc3RhcnRlZE1ldGhvZHMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBwaXBlID0gW107CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gYWxsUnVubmVyRmFjdG9yeShtZXRob2QpKHRoYXQpOwogICAgICAgICAgICAgICAgaWYocmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICAgICAgaWYoIWlzQXJyYXkobmFtZSkpIHsKICAgICAgICAgICAgICAgIG5hbWVzID0gWwogICAgICAgICAgICAgICAgICAgIG5hbWUKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuYW1lcyA9IChuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihkZXBlbmRlbnRNZXRob2RzICYmIGRlcGVuZGVudE1ldGhvZHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG5hbWVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBuID0gbmFtZXNbaV0sIG1vZCA9IHRoYXQubW9kdWxlc1tuXTsKICAgICAgICAgICAgICAgICAgICBlYWNoKGRlcGVuZGVudE1ldGhvZHMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFpdGVtc1t4XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZighcmV2ZXJzZSAmJiAoIW1vZCB8fCAhbW9kLmNvbnZlbnRpb24oeCArICctc3RhdHVzJykpIHx8IChyZXZlcnNlICYmIG1vZC5jb252ZW50aW9uKHggKyAnLXN0YXR1cycpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0ucHVzaChuKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWFjaChkZXBlbmRlbnRNZXRob2RzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIGlmKGl0ZW1zW3hdICYmIGl0ZW1zW3hdLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4odGhhdFt4XS5hcHBseSh0aGF0LCBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4ocnVuUnVubmVyRmFjdG9yeShtZXRob2QpLmFwcGx5KHRoYXQsIFsKICAgICAgICAgICAgICAgICAgICBuYW1lcwogICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZih0aGF0LnN0YXJ0ZWQgJiYgc3RhcnRlZE1ldGhvZHMgJiYgc3RhcnRlZE1ldGhvZHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBlYWNoKHN0YXJ0ZWRNZXRob2RzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChmbGF0dGVuKHRoYXRbeF0uYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZXMKICAgICAgICAgICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5waXBlbGluZShwaXBlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoYXQubW9kdWxlTWV0aG9kKElOSVQsIG5hbWUsIGFyZ3MsIGZhbHNlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChTVEFSVCwgbmFtZSwgYXJncywgZmFsc2UsIFsKICAgICAgICAgICAgICAgIElOSVQKICAgICAgICAgICAgXSwgWwogICAgICAgICAgICAgICAgUkVBRFkKICAgICAgICAgICAgXSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnJlYWR5ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoUkVBRFksIG5hbWUsIGFyZ3MsIGZhbHNlLCBbCiAgICAgICAgICAgICAgICBJTklULCAKICAgICAgICAgICAgICAgIFNUQVJUCiAgICAgICAgICAgIF0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdG9wID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoU1RPUCwgbmFtZSwgYXJncywgdHJ1ZSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1ldGhvZCA9IERFU1RST1k7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChERVNUUk9ZLCBuYW1lLCBhcmdzLCB0cnVlLCBbCiAgICAgICAgICAgICAgICBTVE9QCiAgICAgICAgICAgIF0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fX2luamVjdE1vZHVsZSA9IC8vI2VuZHJlZ2lvbgogICAgICAgIC8qKgogICAgICAgIEluamVjdHMgYSBwcmVjb25zdHJ1Y3RlZCBtb2R1bGUgaW50byB0aGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgX19pbmplY3RNb2R1bGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBpbmplY3QuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgICAgICAgICB0aGlzLmNyZWF0ZShtb2R1bGUubmFtZSwgbW9kdWxlLCB0cnVlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY3JlYXRlTW9kdWxlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG1vZHVsZSBmcm9tIHRoZSBnaXZlbiBkZWZpbml0aW9uIG9iamVjdCwgd2l0aCB0aGUgZ2l2ZW4gbmFtZS4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNyZWF0ZU1vZHVsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGVEZWZuIFRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCBtb2R1bGVEZWZuKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYodGhhdC5tb2R1bGVzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVzW25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtb2R1bGUgPSBuZXcgTW9kdWxlKHRoYXQsIG1vZHVsZURlZm4sIG5hbWUpOwogICAgICAgICAgICB0aGF0Ll9faW5qZWN0TW9kdWxlKG1vZHVsZSk7CiAgICAgICAgICAgIHJldHVybiBtb2R1bGU7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnNwYXduID0gLyoqCiAgICAgICAgTGF1bmNoZXMgYW5vdGhlciBjaGlsZCBtb2R1bGUgZm9yIHRocnVzdC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHNwYXduCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgb25jZSB0aGUgY2hpbGQgaW5zdGFuY2UgaGFzIGZ1bGx5IGxvYWRlZC4gIFJlc29sdmVzIHdpdGggdGhlIGNvbnRleHQgdGhhdCBjb250YWlucyB0aGUgdGhydXN0IGluc3RhbmNlIGFuZCBhbGwgcGx1Z2lucyB0aGF0IHdlcmUgbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChzZXR0aW5ncykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiBUaHJ1c3QubGF1bmNoKGV4dGVuZCh7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGNoaWxkSW5zdGFuY2U6IHRydWUKICAgICAgICAgICAgfSwgc2V0dGluZ3MpLCB0cnVlKS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3Q7CiAgICAgICAgICAgICAgICB0aGF0LmNoaWxkcmVuLnB1c2godGhydXN0KTsKICAgICAgICAgICAgICAgIHRocnVzdC5wYXJlbnQgPSB0aGF0OwogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5yZWdpc3Rlck1vZHVsZSA9IC8qKgogICAgICAgIFJlZ2lzdGVycyBhIHNwZWNpZmljIG1vZHVsZSBuYW1lLCBhbmQgYXJndW1lbnRzLiAgVGhlIGFyZ3VtZW50cyB3aWxsIGJlIHVzZWQgd2hlbiBpbml0YW50aWF0aW5nIHRoZSBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWdpc3Rlck1vZHVsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZSB0byBhc3NpZ24gdGhlIGFyZ3VtZW50cyB3aXRoLgogICAgICAgIEBwYXJhbSB7T2JqZWN0Kn0gYXJndW1lbnRzLCBhZGRpdGlvbmFsIGFyZ3VtZW50cyB0aGF0IHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIG1vdWRsZQogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgVGhydXN0LnJlZ2lzdGVyTW9kdWxlLmFwcGx5KFRocnVzdCwgWwogICAgICAgICAgICAgICAgdGhhdC5uYW1lCiAgICAgICAgICAgIF0uY29uY2F0KHRvQXJyYXkoYXJndW1lbnRzKSkpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmxhdW5jaFNlcXVlbmNlID0gZnVuY3Rpb24gbGF1bmNoU2VxdWVuY2UoaW5zdGFuY2UsIGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHJldHVybiB3aGVuLnNlcXVlbmNlKFsKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5fY291bnRkb3duLCBpbnN0YW5jZSksIAogICAgICAgICAgICAgICAgXy5iaW5kKGluc3RhbmNlLmlnbml0ZSwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5vcmJpdCwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5kZXBsb3ksIGluc3RhbmNlKSwgCiAgICAgICAgICAgICAgICBfLmJpbmQoaW5zdGFuY2UuaW5PcmJpdCwgaW5zdGFuY2UpCiAgICAgICAgICAgIF0sIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5sYXVuY2ggPSAvKioKICAgICAgICBJbml0YWxpemVzIGEgbmV3IFRocnVzdCBpbnN0YW5jZSBiYXNlZCBvbiB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBsYXVuY2gKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBtb2R1bGUgdG8gaW5qZWN0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gbGF1bmNoKHNldHRpbmdzLCBjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICBpZighc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gewogICAgICAgICAgICAgICAgICAgIG5hbWU6ICdnbG9iYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncy5uYW1lKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy5uYW1lID0gJ2dsb2JhbCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZmFsc2UpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzLmRlYnVnID0gewogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFydDogbmV3IERhdGUoKS5nZXRUaW1lKCkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0dGluZ3MgPSBpZ25pdGVTcGVjLm1lcmdlU2V0dGluZ3Moc2V0dGluZ3MpOwogICAgICAgICAgICB2YXIgcGlwZSA9IFsKICAgICAgICAgICAgICAgIGlnbml0ZVNwZWMuZnVzZQogICAgICAgICAgICBdOwogICAgICAgICAgICB2YXIgc2V0dXBEZWZlciA9IFRocnVzdC5fX2ZldGNoSW5zdGFuY2Uoc2V0dGluZ3MubmFtZSk7CiAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICAgICAgdmFyIHRocnVzdCA9IGNvbnRleHQudGhydXN0LCBtb2R1bGVzID0gdGhydXN0LnN0YXJ0aW5nTW9kdWxlcyA9IGNvbnRleHQuY2ZnLm1vZHVsZXMsIGNvbmZpZyA9IHRocnVzdC5jb25maWcgPSB0aHJ1c3QuY2ZnOwogICAgICAgICAgICAgICAgaW5zdGFuY2VzW3RocnVzdC5uYW1lXSA9IHRocnVzdDsKICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYoc2V0dGluZ3MuYXV0b21hdGljTGlmZWN5Y2xlKSB7CiAgICAgICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3QsIGQgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgVGhydXN0LmxhdW5jaFNlcXVlbmNlKHRocnVzdCwgY2FsbGVkQnlQYXJlbnQpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZC5yZXNvbHZlKGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBkLnByb21pc2U7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcGlwZWxpbmUgPSB3aGVuLnBpcGVsaW5lKHBpcGUsIHNldHRpbmdzKS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2V0dXBEZWZlci5yZXNvbHZlKGNvbnRleHQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gV2UncmUgb25seSBnb2luZyB0byBleHBvc2UgZ2xvYmFscyBpZiByZXF1ZXN0ZWQuICBUaGlzIGlzIGEgcG90ZW50aWFsIHVzZWNhc2UgdGhhdCBtYXkgYmUgbmVlZGVkIGZvciBzb21lIHRlYW1zLgogICAgICAgICAgICBpZih0Q29uZmlnLmV4cG9zZUdsb2JhbHMpIHsKICAgICAgICAgICAgICAgIGlmKCF3aW5kb3dbJ1RocnVzdCddKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93WydUaHJ1c3QnXSA9IFRocnVzdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBpcGVsaW5lLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3dbc2V0dGluZ3MubmFtZV0gPSBjb250ZXh0OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBpcGVsaW5lOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmdldEluc3RhbmNlID0gLyoqCiAgICAgICAgR2V0cyBhIG5hbWVkIHRocnVzdCBzdGFuY2UgaWYgaXQgZXhpc3RzLgogICAgICAgIAogICAgICAgIEBtZXRob2QgZ2V0SW5zdGFuY2UKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGluc3RhbmNlIG5hbWUKICAgICAgICBAcmV0dXJucyB7VGhydXN0fSBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2UobmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhydXN0SW5zdGFuY2UuZ2V0SW5zdGFuY2UobmFtZSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QuX19mZXRjaEluc3RhbmNlID0gLyoqCiAgICAgICAgRmV0Y2hzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICAgICAgVGhpcyBsb2FkcyBhc3luY3Jvbm91c2x5LCBhcyB0aGUgaW5zdGFuY2UgbWF5IG5vdCBiZSBsb2FkZWQKICAgICAgICAKICAgICAgICBAbWV0aG9kIF9fZmV0Y2hJbnN0YW5jZQogICAgICAgIEBzdGF0aWMKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRvIGEgdGhydXN0IGluc3RhbmNlIHNwZWMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiBfX2ZldGNoSW5zdGFuY2UobmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhydXN0SW5zdGFuY2UuZmV0Y2hJbnN0YW5jZShuYW1lKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5jcmVhdGVNb2R1bGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbmV3IG1vZHVsZSBhbmQgaGFuZHMgaXQgb2ZmIHRvIHRoZSBnaXZlbiBpbnN0YW5jZSwgaWYgdGhhdCBpbnN0YW5jZSBleGlzdHMuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBjcmVhdGVNb2R1bGUKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlTmFtZSBUaGUgdGhydXN0IGluc3RhbmNlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbW9kdWxlIG5hbWUKICAgICAgICBAcGFyYW0ge09iamVjdH0gbW9kdWxlRGVmbiBUaGUgbW9kdWxlIGRlZmluaXRpb24KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiBjcmVhdGVNb2R1bGUoaW5zdGFuY2VOYW1lLCBuYW1lLCBtb2R1bGVEZWZuKSB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IFRocnVzdC5nZXRJbnN0YW5jZShpbnN0YW5jZU5hbWUpOwogICAgICAgICAgICBpZihpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdmFyIG1vZHVsZSA9IG5ldyBNb2R1bGUoaW5zdGFuY2UsIG1vZHVsZURlZm4sIG5hbWUpOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuX19pbmplY3RNb2R1bGUobW9kdWxlKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb2R1bGU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFRocnVzdC5yZWdpc3Rlck1vZHVsZSA9IC8qKgogICAgICAgIFJlZ2lzdGVycyBhIHNwZWNpZmljIG1vZHVsZSBuYW1lLCBhbmQgYXJndW1lbnRzLiAgVGhlIGFyZ3VtZW50cyB3aWxsIGJlIHVzZWQgd2hlbiBpbml0YW50aWF0aW5nIHRoZSBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWdpc3Rlck1vZHVsZQogICAgICAgIEBzdGF0aWMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VOYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgdGhlIG1vZHVsZSBpcyB0byBiZSBhc3NvY2lhdGVkIHdpdGguCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lIHRvIGFzc2lnbiB0aGUgYXJndW1lbnRzIHdpdGguCiAgICAgICAgQHBhcmFtIHtPYmplY3QqfSBhcmd1bWVudHMsIGFkZGl0aW9uYWwgYXJndW1lbnRzIHRoYXQgd2lsbCBiZSBwYXNzZWQgb250byB0aGUgbW91ZGxlCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJNb2R1bGUoaW5zdGFuY2VOYW1lLCBuYW1lKSB7CiAgICAgICAgICAgIGlmKCFpbnN0YW5jZU5hbWUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignaW5zdGFuY2VOYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25hbWUgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIVRocnVzdC5fX21vZHVsZVJlZ2lzdHJhdGlvbnNbaW5zdGFuY2VOYW1lXSkgewogICAgICAgICAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdID0gewogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKS5zbGljZSgyKTsKICAgICAgICAgICAgaWYoVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdW25hbWVdKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdNb2R1bGUgInswfSIgYWxyZWFkeSByZWdpc3RlcmVkIHRvIGluc3RhbmNlICJ7MX0iJywgbmFtZSwgaW5zdGFuY2VOYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdW25hbWVdID0gYXJncyB8fCBbXTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5fX2dldE1vZHVsZUFyZ3MgPSBfX2dldE1vZHVsZUFyZ3M7CiAgICAgICAgcmV0dXJuIFRocnVzdDsKICAgIH0pKCk7CiAgICBleHBvcnRzLlRocnVzdCA9IFRocnVzdDsgICAgCiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIGN1cnJlbnQgdGh1cnN0IGluc3RhbmNlLCBieSBleHBlY3RlZCBuYW1lLgogICAgQWRkaW5nIHRoZSA6IGNoYXJhY3RlciByZXF1ZXN0cyBhIHNwZWNpZmljIHBsdWdpbi4KICAgIHRocnVzdCFnbG9iYWwgPSBUaHJ1c3QgaW5zdGFuY2UKICAgIHRocnVzdCFnbG9iYWw6ZG9tID0gVGhlIHRocnVzdCBkb20gcGx1Z2luIGluc3RhbmNlCiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkIEFsbG93cyB0aGUgbG9hZCB0byBpbmZvcm0gdGhhdCBBTUQgZm9yIHRoZSB2YWx1ZSB0byBoYW5kIG9mZgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAqKi8KICAgIGZ1bmN0aW9uIGxvYWQobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKSB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLCByZWFsTmFtZSA9IHBhcnRzWzBdLCBwbHVnaW5OYW1lID0gcGFydHNbMV0gfHwgJ3RocnVzdCc7CiAgICAgICAgdmFyIGluc3RhbmNlUHJvbWlzZSA9IFRocnVzdC5fX2ZldGNoSW5zdGFuY2UocmVhbE5hbWUpOwogICAgICAgIGluc3RhbmNlUHJvbWlzZS5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHBsdWdpbiA9IGNvbnRleHRbcGx1Z2luTmFtZV07CiAgICAgICAgICAgIGlmKCFwbHVnaW4pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ1BsdWdpbiAiezB9IiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgInsxfSIuJywgcGx1Z2luTmFtZSwgcmVhbE5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsb2FkKHBsdWdpbik7CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmxvYWQgPSBsb2FkOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0JywgWyd0aHJ1c3QvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgQSBDb252ZW50aW9uIGFsbG93cyB0aHJ1c3QgdG8gYmUgYXMgZXh0ZW5kYWJsZSBhcyBwb3NzaWJsZSwgYnkgZ2l2aW5nIGV4dGVuc2lvbiBwb2ludHMgYXQgZXZlcnkgc3RlcCBhbG9uZyB0aGUgd2F5LgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgKiovCiAgICB2YXIgbWV0aG9kcyA9IFsKICAgICAgICAnY3JlYXRlJywgCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnc3RhcnQnLCAKICAgICAgICAncmVhZHknLCAKICAgICAgICAnc3RvcCcsIAogICAgICAgICdkZXN0cm95JywgCiAgICAgICAgJ2NvdW50ZG93bicsIAogICAgICAgICdpZ25pdGUnLCAKICAgICAgICAnb3JiaXQnLCAKICAgICAgICAnZGVvcmJpdCcsIAogICAgICAgICdzcGxhc2hkb3duJwogICAgXTsKICAgIC8qKgogICAgVGhlIGNvbnZlbnRpb24gY2xhc3MsIHRha2VzIGFuIG92ZXJsb2FkZWQgc2V0IG9mIG1ldGhvZHMsIGZvciBhbnkgbWV0aG9kIHRoYXQgbmVlZHMgdG8gYmUgb3ZlcmxvYWRlZC4KICAgIAogICAgQGNsYXNzIHRocnVzdC5Db252ZW50aW9uCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7T2JqZWN0fSBtZXRob2RzIEFuIG9iamVjdCBvZiBhcHBsaWNhYmxlIG1ldGhvZHMuCiAgICAqKi8KICAgIHZhciBDb252ZW50aW9uID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBDb252ZW50aW9uKG1ldGhvZE92ZXJyaWRlcykgewogICAgICAgICAgICBfLmV4dGVuZCh0aGlzLCBtZXRob2RPdmVycmlkZXMpOwogICAgICAgICAgICB2YXIga2V5cyA9IF8uZGlmZmVyZW5jZShtZXRob2RzLCBfLmludGVyc2VjdGlvbihtZXRob2RzLCBfLmtleXMobWV0aG9kT3ZlcnJpZGVzKSkpOwogICAgICAgICAgICBfLmVhY2goa2V5cywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIGlmKF8uaXNGdW5jdGlvbih0aGlzW3hdKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG5vb3AgaXMgdXNlZCBpbiBzYWZlaW52b2tlLCBhcyBhIHNhZmUgaWdub3JlIGZ1bmN0aW9uLCBubyBvdGhlciBub29wIHdpbGwgd29yayBjb3JyZWN0bHkuCiAgICAgICAgICAgICAgICAgICAgdGhpc1t4XSA9IHV0aWwubm9vcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmNyZWF0ZSA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyBjcmVhdGUgb2YgYSBtb2R1bGUsIGdlbmVyYWxseSB1c2VkIHRvIGNyZWF0ZSBhIGZhY2FkZSwgdGhhdCBpcyB0aGVuIGJvdW5kIHRvIHRoZSBtb2R1bGUuCiAgICAgICAgQG1ldGhvZCBjcmVhdGUKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHBhcmFtIHtNb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIGluc3RhbmNlLgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIEFsbCB0aGUgZmFjYWRlcyBhbHJlYWR5IGF0dGFjaGVkIHRvIHRoZSBtb2R1bGUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5pbml0ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IGluaXQgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3MgaW5pdCBwaGFzZQogICAgICAgIAogICAgICAgIEBtZXRob2QgaW5pdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnN0YXJ0ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IHN0YXJ0IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIHN0YXJ0IHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnJlYWR5ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IHJlYWR5IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIHJlYWR5IHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWFkeQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnN0b3AgPSAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3Qgc3RvcCBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBzdG9wIHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdG9wCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuZGVzdHJveSA9IC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCBkZXN0cm95IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIGRlc3Ryb3kgcGhhc2UKICAgICAgICAKICAgICAgICBAbWV0aG9kIGRlc3Ryb3kKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5jb3VudGRvd24gPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIGluaXQgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBjb3VudGRvd24KICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuaWduaXRlID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBzdGFydCBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIGlnbml0ZQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5vcmJpdCA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgcmVhZHkgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBvcmJpdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5kZW9yYml0ID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBzdG9wIHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2QgZGVvcmJpdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5zcGxhc2hkb3duID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBkZXN0cm95IHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2Qgc3BsYXNoZG93bgogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gQ29udmVudGlvbjsKICAgIH0pKCk7CiAgICBleHBvcnRzLkNvbnZlbnRpb24gPSBDb252ZW50aW9uOyAgICAKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29udmVudGlvbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9ldmVudHMnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJy4vbG9nJywgJy4vY29uZmlnJywgJ2hhcycsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2xvZ19fLCBfX3RDb25maWdfXywgX19oYXNfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLy8gICAgIEJhY2tib25lLmpzIDAuOS4xCiAgICAvLyAgICAgKGMpIDIwMTAtMjAxMiBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgogICAgLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogICAgLy8gICAgIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKICAgIC8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKICAgIC8qKgogICAgVGhydXN0IEV2ZW50cyBhcmUgYmFzZWQgb2ZmIG9mIHRoZSBCYWNrYm9uZSBldmVudCBtb2RlbCwgd2l0aCBzcGVjaWFsIGFkZGl0aW9ucy4KICAgIAogICAgKiBFdmVudHMgY2FuIGJlIGZpcmVkIGFzeW5jcm9ub3VzbHkuCiAgICAqIEV2ZW50cyBjYW4gYmUgbmFtZXNwYWNlZC4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIEV2ZW50Tm9kZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gRXZlbnROb2RlKCkgewogICAgICAgICAgICB0aGlzLnRhaWwgPSBudWxsOwogICAgICAgICAgICB0aGlzLm5leHQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5uYW1lc3BhY2UgPSAnJzsKICAgICAgICAgICAgdGhpcy5vbmNlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBFdmVudE5vZGU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5FdmVudE5vZGUgPSBFdmVudE5vZGU7ICAgIAogICAgdmFyIGNyZWF0ZUFzeW5jRXZlbnQgPSBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICAgICAgdmFyIGYgPSBmdW5jdGlvbiBmKGV2ZW50cykgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfdHJpZ2dlci5hcHBseShvYmplY3QsIFsKICAgICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgIF0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIH07CiAgICAgICAgZi5hc3luYyA9IGZ1bmN0aW9uIChldmVudHMpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3RyaWdnZXIuYXBwbHkob2JqZWN0LCBbCiAgICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgIF0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGY7CiAgICB9OwogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBhc3luY0ZpcmUsIG5vb3AgPSB1dGlsLm5vb3AsIHdoZW4gPSB1dGlsLndoZW4sIHNpemUgPSBfLnNpemUsIGVhY2ggPSBfLmVhY2gsIGRlZmVyID0gXy5kZWZlciwgYmluZCA9IF8uYmluZCwgZXh0ZW5kID0gXy5leHRlbmQsIGZvcm1hdCA9IHV0aWwuZm9ybWF0OwogICAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLywgQUxMID0gJ2FsbCcsIFNUQVJBTEwgPSAnKmFsbCc7CiAgICAvKioKICAgIE5vcm1hbGl6ZXMgdGhlIGdpdmVuIGV2ZW50cyB0byB0aGUgZXhwZWN0ZWQgbmFtZXNwYWNlLgogICAgCiAgICBAbWV0aG9kIG5vcm1hbGl6ZUV2ZW50cwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgVGhlIGV2ZW50cyBkZWxpbWl0ZWQgYnkgYSBzcGFjZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZSBUaGUgbmFtZXNwYWNlLCBpbmNsdWRpbmcgcHJlZml4ZWQgJy4nCiAgICAqKi8KICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIG5hbWVzcGFjZSkgewogICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gZXZlbnRzQXJyYXkubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmKGV2ZW50c0FycmF5W2ldLmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIGV2ZW50c0FycmF5W2ldID0gZXZlbnRzQXJyYXlbaV0gKyBuYW1lc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2ZW50c0FycmF5LmpvaW4oJyAnKTsKICAgIH0KICAgIC8qKgogICAgVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgCiAgICBAbWV0aG9kIF90cmlnZ2VyCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtCb29sZWFufSBhc3luYyBGaXJlIGV2ZW50IGFzeW5jIG9yIHN5bmMKICAgIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgVGhlIGV2ZW50cyB0byBiZSBmaXJlZC4KICAgIGRlbGltaXRlZCBieSBhIHNwYWNlLgogICAgQHBhcmFtIFthcmdzXSogVGhlIGFyZ3VtZW50cyB0byBwYXNzIG9udG8gdGhlIGNhbGxiYWNrIG1ldGhvZHMuCiAgICBAcmV0dXJucyBJZiBhc3luYyB0aGVuIHJldHVybnMgYSBQcm9taXNlLCB3aGVyZSB0aGUgZmlyc3QgYXJndW1lbnQgY29udGFpbnMgYWxsIHRoZSByZXR1cm5lZCB2YWx1ZXMsIGFzIGFuIGFycmF5CiAgICBJZiBzeW5jIHRoZW4gcmV0dXJucyBhbiBhcnJheSBvZiB0aGUgcmV0dXJuIHZhbHVlcy4KICAgIElmIG1vcmUgdGhhbiBvbmUgZXZlbnQsIHJldHVybnMgYW4gb2JqZWN0IG9mIGFycmF5cyBvciBwcm9taXNlcywgd2l0aCB0aGUga2V5IGZvciBlYWNoIGV2ZW50LgogICAgKiovCiAgICBmdW5jdGlvbiBfdHJpZ2dlcihhc3luYywgZXZlbnRzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgZXZlbnQsIG5vZGUsIGNhbGxzLCB0YWlsLCBhcmdzLCBhbGwsIHJlc3QsIG5hbWVzcGFjZSwgb25jZU5vZGVzOwogICAgICAgIGlmKCEoY2FsbHMgPSB0aGlzLl9jYWxsYmFja3MpKSB7CiAgICAgICAgICAgIHJldHVybiB0aGF0OwogICAgICAgIH0KICAgICAgICBhbGwgPSBjYWxscy5hbGw7CiAgICAgICAgdmFyIGV2ZW50c0FycmF5ID0gZXZlbnRzLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHJlc3QgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICAgICAgd2hpbGUoZXZlbnQgPSBldmVudHNBcnJheS5zaGlmdCgpKSB7CiAgICAgICAgICAgIGlmKG5vZGUgPSBjYWxsc1tldmVudF0pIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJOb2Rlcyh0aGF0LCBldmVudCwgYXN5bmMsIG5vZGUsIHJlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG5vZGUgPSBhbGwpIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJOb2Rlcyh0aGF0LCBBTEwsIGFzeW5jLCBub2RlLCBbCiAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgIF0uY29uY2F0KHJlc3QpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIC8qKgogICAgVHJpZ2dlcnMgYWxsIGV2ZW50cyBvbiBhIG5vZGUuCiAgICBBbHNvIHVuYmluZHMgYW55IG5vZGUgdGhhdCBpcyBzZXQgdG8gb25seSBiZSBjYWxsZWQgb25jZS4KICAgIAogICAgQG1ldGhvZCB0cmlnZ2VyTm9kZXMKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gdGhhdCBUaGUgZXZlbnQgY29udGFpbmVyIGNvbnRleHQuCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnQgVGhlIGV2ZW50IHRvIGJlIGJvdW5kIG9yIHVuYm91bmQuCiAgICBAcGFyYW0ge0Jvb2xlYW59IGFzeW5jIEZpcmUgZXZlbnQgYXN5bmMgb3Igc3luYwogICAgQHBhcmFtIHtPYmplY3R9IG5vZGUgVGhlIG5vZGUgbGlua2VkIGxpc3QuCiAgICBAcGFyYW0ge0FycmF5fSBhcmdzIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSB0cmlnZ2VyZWQgbm9kZXMKICAgIAogICAgKiovCiAgICBmdW5jdGlvbiB0cmlnZ2VyTm9kZXModGhhdCwgZXZlbnQsIGFzeW5jLCBub2RlTGlzdCwgYXJncykgewogICAgICAgIHZhciB0YWlsLCBvbmNlTm9kZXMgPSBbXTsKICAgICAgICBmYWxzZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ3swfTogdHJpZ2dlcmluZyB7MX0gZXZlbnQgInsyfSInLCB0aGF0Ll9fcHViU3ViTmFtZSwgYXN5bmMgJiYgJ2FzeW5jJyB8fCAnJywgZXZlbnQpKTsKICAgICAgICBlYWNoKG5vZGVMaXN0LCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgICAgICB3aGlsZSgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJDYWxsYmFjayhhc3luYywgbm9kZS5jYWxsYmFjaywgbm9kZS5jb250ZXh0IHx8IHRoYXQsIGFyZ3MpOwogICAgICAgICAgICAgICAgbm9kZS5vbmNlICYmIG9uY2VOb2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgaWYob25jZU5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICBlYWNoKG9uY2VOb2RlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHRoYXQudW5zdWJzY3JpYmUoZXZlbnQsIHguY2FsbGJhY2ssIHguY29udGV4dCwgeC5uYW1lc3BhY2UpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIEludm9rZXMgYSB0cmlnZ2VyIGNhbGxiYWNrCiAgICAKICAgIEBtZXRob2QgdHJpZ2dlckNhbGxiYWNrCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtCb29sZWFufSBhc3luYyBGaXJlIGV2ZW50IGFzeW5jIG9yIHN5bmMKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QKICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjYWxsaW5nIGNvbnRleHQKICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBjYWxsIHRoZSBjYWxsYmFjayB3aXRoLgogICAgQHJldHVybnMge09iamVjdH0gVGhlIHJldHVybmVkIHZhbHVlLgogICAgRm9yIGFzeW5jIGNhbGxzLCB0aGlzIGlzIGEgcHJvbWlzZQogICAgRm9yIHN5bmMgY2FsbHMgdGhpcyBpcyB0aGUgdmFsdWUgZnJvbSB0aGUgbWV0aG9kLgogICAgKiovCiAgICBmdW5jdGlvbiB0cmlnZ2VyQ2FsbGJhY2soYXN5bmMsIGNhbGxiYWNrLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgICAgaWYoYXN5bmMpIHsKICAgICAgICAgICAgZGVmZXIodHJpZ2dlckFzeW5jQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQsIGFyZ3MpLCAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0cnkgIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgaWYodENvbmZpZy50aHJvd0Vycm9ycykgewogICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIENyZWF0ZXMgYW4gYXN5bmMgZXZlbnQgaGFuZGxlcgogICAgCiAgICBAbWV0aG9kIGFzeW5jRXZlbnRGYWN0b3J5CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZAogICAgQHBhcmFtIHtPYmplY3R9IHRoYXQgVGhlIGNhbGxpbmcgY29udGV4dAogICAgQHBhcmFtIHtBcnJheX0gYXJncyBUaGUgYXJndW1lbnRzIHRvIGNhbGwgdGhlIGNhbGxiYWNrIHdpdGguCiAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBjYWxsYmFjayBmb3IgdGhlIGdpdmVuIGFyZ3VtZW50cy4KICAgICoqLwogICAgZnVuY3Rpb24gdHJpZ2dlckFzeW5jQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQsIGFyZ3MpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgUmVzdWJzY3JpYmVzIHRvIHRoZSBhcHByb3ByaWF0ZSBldmVudHMKICAgIAogICAgQG1ldGhvZCBfb2ZmUHJvY2Vzc05vZGUKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gdGhhdCBUaGUgZXZlbnQgY29udGV4dAogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBldmVudAogICAgQHBhcmFtIHtPYmplY3R9IG5vZGUgVGhlIG5vZGUgbGlua2VkIGxpc3QuCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBldmVudCBjYWxsYmFjayB0byB1bnN1YnNjcmliZQogICAgQHBhcmFtIHtPYmplY3R9IFtjb250ZXh0XSBUaGUgZXZlbnQgY29udGV4dCB0byB1bnN1YnNjcmliZQogICAgQHBhcmFtIHtTdHJpbmd9IFtuYW1lc3BhY2VdIFRoZSBuYW1lc3BhY2UgdG8gdW5zdWJzY3JpYmUKICAgICoqLwogICAgZnVuY3Rpb24gX29mZlByb2Nlc3NOb2RlKHRoYXQsIGV2ZW50LCBub2RlLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIHZhciB0YWlsLCBjYiwgY3R4LCBuczsKICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgIHdoaWxlKChub2RlID0gbm9kZS5uZXh0KSAhPT0gdGFpbCkgewogICAgICAgICAgICBjYiA9IG5vZGUuY2FsbGJhY2s7CiAgICAgICAgICAgIGN0eCA9IG5vZGUuY29udGV4dDsKICAgICAgICAgICAgbnMgPSBub2RlLm5hbWVzcGFjZTsKICAgICAgICAgICAgaWYoKGNhbGxiYWNrICYmIGNiICE9PSBjYWxsYmFjaykgfHwgKGNvbnRleHQgJiYgY3R4ICE9PSBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgdGhhdC5zdWJzY3JpYmUoZXZlbnQgKyAobnMgJiYgKCcuJyArIG5zKSB8fCAnJyksIGNiLCBjdHgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBHZXRzIHRoZSBuYW1lc3BhY2UgaW5mb3JtYXRpb24sIHRoZSByZWFsIGV2ZW50IHRvIHBhc3MgYmFjayBvbnRvIHRoZSBtZXRob2RzLgogICAgCiAgICBAbWV0aG9kIGdldE5hbWVzcGFjZURhdGEKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnQgVGhlIGV2ZW50IHRvIGNhcHR1cmUgbmFtZXNwYWNlIGRhdGEgZnJvbS4KICAgIEByZXR1cm5zIHtPYmplY3R9IENvbnRhaW5pbmcgZXZlbnQgYW5kIG5hbWVzcGFjZS4KICAgICoqLwogICAgZnVuY3Rpb24gZ2V0TmFtZXNwYWNlRGF0YShldmVudCkgewogICAgICAgIHZhciBuc0luZGV4ID0gKGV2ZW50IHx8ICcnKS5pbmRleE9mKCcuJyksIGhhc05zID0gbnNJbmRleCA+IC0xLCBuYW1lc3BhY2UgPSBoYXNOcyA/IGV2ZW50LnN1YnN0cmluZyhuc0luZGV4ICsgMSkgOiB1bmRlZmluZWQsIGV2ZW50ID0gaGFzTnMgPyBldmVudC5zdWJzdHJpbmcoMCwgbnNJbmRleCkgOiBldmVudDsKICAgICAgICBpZihuc0luZGV4ID09PSAwKSB7CiAgICAgICAgICAgIGV2ZW50ID0gU1RBUkFMTDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LAogICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZQogICAgICAgIH07CiAgICB9CiAgICAvKioKICAgIFRocnVzdCBFdmVudHMgYXJlIGJhc2VkIG9mZiBvZiB0aGUgQmFja2JvbmUgZXZlbnQgbW9kZWwsIHdpdGggc3BlY2lhbCBhZGRpdGlvbnMuCiAgICAKICAgICogRXZlbnRzIGNhbiBiZSBmaXJlZCBhc3luY3Jvbm91c2x5LgogICAgKiBFdmVudHMgY2FuIGJlIG5hbWVzcGFjZWQuCiAgICAKICAgIEBjbGFzcyB0aHJ1c3QuRXZlbnRzCiAgICAqKi8KICAgIGV4cG9ydHMuRXZlbnRzID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZXZlbnRzID0gewogICAgICAgICAgICBzdWJzY3JpYmU6IC8qKgogICAgICAgICAgICBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIGBldmVudHNgLCB0byBhIGBjYWxsYmFja2AKICAgICAgICAgICAgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICAgICAgICAgIAogICAgICAgICAgICBAbWV0aG9kIHN1YnNjcmliZQogICAgICAgICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnRzIFNwYXZlIHNlcGVyYXRlZCBldmVudHMKICAgICAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnRzIGFyZSBmaXJlZC4KICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gYmluZCB0aGUgY2FsbGluZyBmdW5jdGlvbiB0by4KICAgICAgICAgICAgQHBhcmFtIHtCb29sZWFufSBvbmNlIENhbGwgdGhpcyBldmVudCBvbmx5IG9uY2UuCiAgICAgICAgICAgIEBjaGFpbmFibGUKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbHMsIGV2ZW50LCBub2RlLCB0YWlsLCBsaXN0LCBuZDsKICAgICAgICAgICAgICAgIHRoaXMuX19uYW1lc3BhY2UgJiYgKGV2ZW50cyA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoaXMuX19uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgICAgICAgICAgIGNhbGxzID0gdGhpcy5fY2FsbGJhY2tzIHx8ICh0aGlzLl9jYWxsYmFja3MgPSB7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhbiBpbW11dGFibGUgY2FsbGJhY2sgbGlzdCwgYWxsb3dpbmcgdHJhdmVyc2FsIGR1cmluZwogICAgICAgICAgICAgICAgLy8gbW9kaWZpY2F0aW9uLiAgVGhlIHRhaWwgaXMgYW4gZW1wdHkgb2JqZWN0IHRoYXQgd2lsbCBhbHdheXMgYmUgdXNlZAogICAgICAgICAgICAgICAgLy8gYXMgdGhlIG5leHQgbm9kZS4KICAgICAgICAgICAgICAgIHdoaWxlKGV2ZW50ID0gZXZlbnRzQXJyYXkuc2hpZnQoKSkgewogICAgICAgICAgICAgICAgICAgIG5kID0gZ2V0TmFtZXNwYWNlRGF0YShldmVudCk7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSBuZC5ldmVudDsKICAgICAgICAgICAgICAgICAgICBsaXN0ID0gY2FsbHNbZXZlbnRdIHx8IChjYWxsc1tldmVudF0gPSB7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgbGlzdCA9IGxpc3RbbmQubmFtZXNwYWNlXTsKICAgICAgICAgICAgICAgICAgICBub2RlID0gbGlzdCA/IGxpc3QudGFpbCA6IG5ldyBFdmVudE5vZGUoKTsKICAgICAgICAgICAgICAgICAgICBub2RlLm5leHQgPSB0YWlsID0gbmV3IEV2ZW50Tm9kZSgpOwogICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGV4dCA9IGNvbnRleHQgfHwgdGhpcy5fX2RlZmF1bHRDb250ZXh0IHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBub2RlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgICAgaWYobmQubmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubmFtZXNwYWNlID0gbmQubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZihvbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUub25jZSA9IG9uY2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhbGxzW2V2ZW50XVtuZC5uYW1lc3BhY2VdID0gewogICAgICAgICAgICAgICAgICAgICAgICB0YWlsOiB0YWlsLAogICAgICAgICAgICAgICAgICAgICAgICBuZXh0OiBsaXN0ID8gbGlzdC5uZXh0IDogbm9kZQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25jZTogLyoqCiAgICAgICAgICAgIEJpbmQgb25lIG9yIG1vcmUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50cywgYGV2ZW50c2AsIHRvIGEgYGNhbGxiYWNrYAogICAgICAgICAgICBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8gYWxsIGV2ZW50cyBmaXJlZC4KICAgICAgICAgICAgCiAgICAgICAgICAgIEVhY2ggZXZlbnQgd2lsbCBvbmx5IGJlIGNhbGxlZCBvbmNlLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBvbmNlCiAgICAgICAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgU3BhdmUgc2VwZXJhdGVkIGV2ZW50cwogICAgICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudHMgYXJlIGZpcmVkLgogICAgICAgICAgICBAcGFyYW0ge09iamVjdH0gY29udGV4dCBUaGUgY29udGV4dCB0byBiaW5kIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIHRvLgogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3Vic2NyaWJlKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIHRydWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN1YnNjcmliZTogLyoqCiAgICAgICAgICAgIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbCBjYWxsYmFja3MKICAgICAgICAgICAgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGNhbGxiYWNrcyBmb3IgdGhlCiAgICAgICAgICAgIGV2ZW50LiBJZiBgZXZlbnRgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgdW5zdWJzY3JpYmUKICAgICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50cyBTcGF2ZSBzZXBlcmF0ZWQgZXZlbnRzCiAgICAgICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50cyBhcmUgZmlyZWQuCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGJpbmQgdGhlIGNhbGxpbmcgZnVuY3Rpb24gdG8uCiAgICAgICAgICAgIEBjaGFpbmFibGUKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnQsIGNhbGxzLCBub2RlLCBuZCwgb3VyTnMsIG5hbWVzcGFjZSwgdGhhdCA9IHRoaXMsIGhhc05zOwogICAgICAgICAgICAgICAgb3VyTnMgPSB0aGF0Ll9fbmFtZXNwYWNlOwogICAgICAgICAgICAgICAgb3VyTnMgJiYgKG91ck5zID0gb3VyTnMuc3Vic3RyaW5nKDEpKTsKICAgICAgICAgICAgICAgIC8vIE5vIGV2ZW50cywgb3IgcmVtb3ZpbmcgKmFsbCogZXZlbnRzLgogICAgICAgICAgICAgICAgaWYoIShjYWxscyA9IHRoYXQuX2NhbGxiYWNrcykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZighKGV2ZW50cyB8fCBjYWxsYmFjayB8fCBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgIGlmKCFvdXJOcykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhhdC5fY2FsbGJhY2tzOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYnMgPSB0aGF0Ll9jYWxsYmFja3M7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSBpbiBjYnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYnNbaV1bb3VyTnNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2l6ZShjYnNbaV0pID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNic1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIExvb3AgdGhyb3VnaCB0aGUgbGlzdGVkIGV2ZW50cyBhbmQgY29udGV4dHMsIHNwbGljaW5nIHRoZW0gb3V0IG9mIHRoZQogICAgICAgICAgICAgICAgLy8gbGlua2VkIGxpc3Qgb2YgY2FsbGJhY2tzIGlmIGFwcHJvcHJpYXRlLgogICAgICAgICAgICAgICAgb3VyTnMgJiYgKGV2ZW50cyA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoYXQuX19uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cyA/IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKSA6IF8ua2V5cyhjYWxscyk7CiAgICAgICAgICAgICAgICB3aGlsZShldmVudCA9IGV2ZW50c0FycmF5LnNoaWZ0KCkpIHsKICAgICAgICAgICAgICAgICAgICBuZCA9IGdldE5hbWVzcGFjZURhdGEoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gbmQuZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlID0gbmQubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIGhhc05zID0gISFuYW1lc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgaWYoIW91ck5zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGNhbGxzW2V2ZW50XSkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbZXZlbnRdW291ck5zXTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XVtvdXJOc107CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNpemUoY2FsbHNbZXZlbnRdKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZighbm9kZSB8fCAhKGNhbGxiYWNrIHx8IGNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvKmlmIChldmVudCAhPT0gU1RBUkFMTCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgIGlmICghbm9kZSkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfSovCiAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnQgIT09IFNUQVJBTEwgJiYgIWNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBldmVudCwgbm9kZSwgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihldmVudCA9PT0gQUxMIHx8ICFjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgaW4gY2FsbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGhhc05zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBpLCBub2RlLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBfb2ZmUHJvY2Vzc05vZGUodGhhdCwgZXZlbnQsIG5vZGUsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX19wdWJTdWJOYW1lOiAvKioKICAgICAgICAgICAgVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAgICAgICAgIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAgICAgICAgICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgICAgICAgICAgcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBmaXJlCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgVGhlIGV2ZW50cyB0byBiZSBmaXJlZC4KICAgICAgICAgICAgZGVsaW1pdGVkIGJ5IGEgc3BhY2UuCiAgICAgICAgICAgIEBwYXJhbSBbYXJnc10qIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBjYWxsYmFjayBtZXRob2RzLgogICAgICAgICAgICBAcmV0dXJucyB7QXJyYXkgb2YgVmFsdWVzfSBJZiBtb3JlIHRoYW4gb24gZXZlbnQgaXMgZmlyZWQsIGFuIE9iamVjdCBvZiBBcnJheXMgaXMgcmV0dXJuZWQuCiAgICAgICAgICAgICoqLwogICAgICAgICAgICAnRXZlbnRzJywKICAgICAgICAgICAgaW5pdEV2ZW50czogLyoqCiAgICAgICAgICAgIEluaXQncyB0aGUgRXZlbnQgbW9kdWxlLgogICAgICAgICAgICBUaGlzIGlzIG9ubHkgcmVxdWlyZWQgaWYgeW91IHdpc2ggdG8gdXNlIGZpcmUuYXN5bmMsIGFuZCBuYW1lc3BhY2luZy4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgaW5pdEV2ZW50cwogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZGVmYXVsdENvbnRleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZSA9IHRoaXMucHVibGlzaCA9IGNyZWF0ZUFzeW5jRXZlbnQodGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLmluaXRFdmVudHMgPSBub29wOwogICAgICAgICAgICAgICAgdGhpcy5fX3B1YlN1Yk5hbWUgPSB0aGlzLm5hbWUgfHwgJ0V2ZW50cyc7CiAgICAgICAgICAgICAgICBpZih0aGlzLm5hbWUgJiYgIXRoaXMuX19uYW1lc3BhY2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9fbmFtZXNwYWNlID0gJy4nICsgdGhpcy5uYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fX2RlZmF1bHRDb250ZXh0ID0gZGVmYXVsdENvbnRleHQ7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZXh0ZW5kOiAvKioKICAgICAgICAgICAgRXh0ZW5kcyBFdmVudHMgaW50byB0aGUgZ2l2ZW4gb2JqZWN0LgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBleHRlbmQKICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IHRvIFRoZSBvYmplY3Qgb3QgZXh0ZW5kIGV2ZW50cyBvbnRvCiAgICAgICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gW2luaXRdIE9wdGlvbmFsbHkgaW5pdCB0aGUgZXZlbnRzLgogICAgICAgICAgICAqKi8KICAgICAgICAgICAgZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgICAgICBfLmV4dGVuZCh0bywgZXhwb3J0cy5FdmVudHMpOwogICAgICAgICAgICAgICAgZGVsZXRlIHRvLmV4dGVuZDsKICAgICAgICAgICAgICAgIGluaXQgJiYgdG8uaW5pdEV2ZW50cygpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRvOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBldmVudHMuZmlyZSA9IGV2ZW50cy5wdWJsaXNoID0gY3JlYXRlQXN5bmNFdmVudCh7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGV2ZW50czsKICAgIH0pKCk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWV2ZW50cy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9mYWNhZGUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJy4vY2Fwc3VsZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX190bV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgdG0gPSBfX3RtX187CgogICAgdmFyIE1vZHVsZSA9IHRtLk1vZHVsZTsKICAgIC8qKgogICAgCiAgICBUaGUgRmFjYWRlIG1vZHVsZSBvZmZlcnMgdGhlIGFiaWxpdHkgdG8gY3JlYXRlIGFuIGludGVyZmFjZSBvciBzaW1pbGFyIGNvbmNlcHQuCiAgICBXaXRoIHRoZSBGYWNhZGUgaW4gdGhydXN0LCBpdCBhbGxvd3MgeW91IHRvIGNhcHR1cmUgZXZlbnRzIGZyb20gYSBtb2R1bGUsIHdoZW4gbG9hZGVkIHZpYSBjb252ZW50aW9uLgogICAgRmFjYWRlcyBhcmUgbWFpbmx5IGZvciB1c2UgaW4gdGhydXN0IHBsdWdpbnMuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlcyBhcmUgbWFpbmx5IGZvciB1c2UgaW4gdGhydXN0IHBsdWdpbnMuCiAgICAKICAgIEZhY2FkZSBoYXMgdGhlc2UgYnVpbHQgaW4gbWV0aG9kczoKICAgICogaW5pdAogICAgKiBzdGFydAogICAgKiByZWFkeQogICAgKiBzdG9wCiAgICAqIGRlc3Ryb3kKICAgIAogICAgQmVoaW5kIHRoZSBzY2VuZXMgdGhlIGZhY2FkZSBtZXRob2RzLCBpbnZva2UgYW55IGNvbnZlbnRpb25zIGxvYWRlZCBmb3IgdGhlIHBsdWdpbi4KICAgIAogICAgQGNsYXNzIHRocnVzdC5GYWNhZGUKICAgICoqLwogICAgdmFyIHRocnVzdENhY2hlID0gTW9kdWxlLnRocnVzdENhY2hlOwogICAgdmFyIGZhY2FkZU1ldGhvZHMgPSBbCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnc3RhcnQnLCAKICAgICAgICAncmVhZHknLCAKICAgICAgICAnc3RvcCcsIAogICAgICAgICdkZXN0cm95JwogICAgXSwgZGVmYXVsdFByb3RvdHlwZSA9IHsKICAgIH07CiAgICBmdW5jdGlvbiBjb252ZW50aW9uRnVuY3Rpb25GYWN0b3J5KG5hbWUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcmV0dXJuVmFsdWVzID0gW107CiAgICAgICAgICAgIGlmKG0gJiYgISgobSkuY29udmVudGlvbikpIHsKICAgICAgICAgICAgICAgIG0gPSB0aHJ1c3RDYWNoZVttLm1pZF0ubW9kdWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoYXQuX19jb252ZW50aW9ucykgewogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIG5hbWUsIG0sIHRoYXQpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIG1ldGhvZFdyYXAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgZi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9OwogICAgfQogICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGZhY2FkZU1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IGZhY2FkZU1ldGhvZHNbaV07CiAgICAgICAgZGVmYXVsdFByb3RvdHlwZVttZXRob2RdID0gY29udmVudGlvbkZ1bmN0aW9uRmFjdG9yeShtZXRob2QpOwogICAgfQogICAgLyoqCiAgICBGYWNhZGUgaW5pdAogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgaW5pdAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgc3RhcnQKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgc3RhcnQgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KICAgIAogICAgQG1ldGhvZCBzdGFydAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgcmVhZHkKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgcmVhZHkgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KICAgIAogICAgQG1ldGhvZCByZWFkeQogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgc3RvcAogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2Qgc3RvcAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgZGVzdHJveQogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBkZXN0cm95IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgZGVzdHJveQogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBtb2R1bGUgaW5zdGFuY2UKICAgIAogICAgRm9ybWF0OgogICAgdGhydXN0L2NhcHN1bGUhe2luc3RhbmNlfTp7cGx1Z2luTmFtZX06e2hhc2hLZXl9CiAgICAKICAgIGhhc0tleTogaXMgYSB1bmlxdWUga2V5LCB0aGF0IHRoZSBtb2R1bGUgc2hhcmVzIHdpdGggdGhlIGZhY2FkZSwgYWxsb3dzIGZvciBkZWZpbmluZyBkZXBlbmRlbmNpZXMKICAgIGluIHlvdXIgZGVmaW5lIGJsb2NrLCBhbmQgZ2V0IGFjY2VzcyB0byB0aGUgbW9kdWxlcyBmYWNhZGUuCiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQG9ic29sZXRlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgZnVuY3Rpb24gbG9hZChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksIGluc3RhbmNlTmFtZSA9IHBhcnRzWzBdLCBwbHVnaW4gPSBwYXJ0c1sxXSwgcGx1Z2luTmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxIHx8IDApLCBoYXNoS2V5ID0gcGFydHNbMl07CiAgICAgICAgaWYoIWluc3RhbmNlTmFtZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2luc3RhbmNlTmFtZSBpcyByZXF1aXJlZCEnKTsKICAgICAgICB9CiAgICAgICAgaWYoIXBsdWdpbk5hbWUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwbHVnaW5OYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgIH0KICAgICAgICBpZighaGFzaEtleSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2hhc2hLZXkgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgfQogICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAndGhydXN0IScgKyBpbnN0YW5jZU5hbWUKICAgICAgICBdLCBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciB0aHJ1c3RQbHVnaW4gPSB0aHJ1c3RbcGx1Z2luTmFtZV07CiAgICAgICAgICAgIGlmKCF0aHJ1c3RQbHVnaW4pIHsKICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgIHBsdWdpbgogICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKHApIHsKICAgICAgICAgICAgICAgICAgICBsb2FkKHApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRocnVzdE1vZHVsZUNhY2hlSXRlbSA9IHRocnVzdENhY2hlW2hhc2hLZXldIHx8ICh0aHJ1c3RDYWNoZVtoYXNoS2V5XSA9IHsKICAgICAgICAgICAgICAgIGZhY2FkZXM6IHsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnN0YW5jZTogewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIGZhY2FkZSA9IHRocnVzdFBsdWdpbi5jcmVhdGVGYWNhZGUodGhydXN0LCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbS5mYWNhZGVzKTsKICAgICAgICAgICAgbG9hZChmYWNhZGUpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKICAgIGZ1bmN0aW9uIGNyZWF0ZUZhY2FkZShpbml0TWV0aG9kKSB7CiAgICAgICAgdmFyIGYgPSAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgRmFjYWRlID0gZnVuY3Rpb24gKG1vZCkgewogICAgICAgICAgICAgICAgaW5pdE1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGZhY2FkZU1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGZhY2FkZU1ldGhvZHNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYodGhpc1ttZXRob2RdICE9PSBkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1ttZXRob2RdID0gXy53cmFwKHRoaXNbbWV0aG9kXSwgbWV0aG9kV3JhcChkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLm1vZCA9IG1vZDsKICAgICAgICAgICAgICAgIC8vdGhpcy5pbml0KG1vZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICBGYWNhZGUucHJvdG90eXBlID0gXy5leHRlbmQoewogICAgICAgICAgICAgICAgdXBkYXRlRmFjYWRlOiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgICAgICAgICBpbml0TWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGRlZmF1bHRQcm90b3R5cGUpOwogICAgICAgICAgICByZXR1cm4gRmFjYWRlOwogICAgICAgIH0pKCk7CiAgICAgICAgcmV0dXJuIGY7CiAgICB9CiAgICBleHBvcnRzLmNyZWF0ZUZhY2FkZSA9IGNyZWF0ZUZhY2FkZTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZmFjYWRlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2NvbnZlbnRpb24vYXV0b3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbiddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAvKioKICAgICogIyBfX3RocnVzdC9tZWRpYXRvcl9fIENvbnZlbnRpb24gLSBBdXRvIFN0YXJ0CiAgICAqCiAgICAqIFRoZSBhdXRvIHN0YXJ0IHByb3BlcnR5IGFsbG93cyBmb3IgYSBtb2R1bGUsIHRvIGJlIGF1dG9tYXRpY2FsbHkgc3RhcnRlZCBvbmNlIGl0IGlzCiAgICAqIGluY2x1ZGVkIGludG8gYSB0aHJ1c3QgaW5zdG5hY2UsIHdpdGhvdXQgaGF2aW5nIHRvIGV4cGxpY2l0eSBjYWxsIHN0YXJ0IG9uIHRoZSBtb2R1bGUuCiAgICAqCiAgICAqCiAgICAqIFRoaXMgaXMgdXNlZnVsIGZvciBjZXJ0aWFuIHR5cGVzIG9mIG1vZHVsZXMsIHVzdWFsbHkgcGVyc2lzdGFudCBvbmVzIHRoYXQgYWx3YXlzIG5lZWQgdG8gbG9hZCByZWdhcmRsZXNzLgogICAgKiBGb3IgZXhhbXBsZSBhIG5hdmlnYXRpb24gbW9kdWxlLCBvciB1c2VyIHNldHRpbmdzIG1vZHVsZS4KICAgICoKICAgICogQGZvciB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgYXV0b1N0YXJ0CiAgICAqKi8KICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgJ2NvbmZpZy5hdXRvU3RhcnQnCiAgICAgICAgXQogICAgfTsKICAgIGV4cG9ydHMuYXV0b3N0YXJ0ID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWF1dG9zdGFydC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lcicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIGFueUNvbnRhaW5lcjogJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lci9hbnknLAogICAgICAgIGNoYW5nZUNvbnRhaW5lcjogJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lci9jaGFuZ2UnCiAgICB9LCBhbnkgPSBfLmFueSwgYmluZCA9IF8uYmluZCwgQ09OVEFJTkVSID0gJ2NvbmZpZy5jb250YWluZXInLCBTVEFSVCA9ICdzdGFydC1zdGF0dXMnLCBkZWZlciA9IF8uZGVmZXI7CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIENPTlRBSU5FUgogICAgICAgIF0sCiAgICAgICAgY2hhbmdlOiBmdW5jdGlvbiAobW9kLCBjb250YWluZXIpIHsKICAgICAgICAgICAgdmFyIGNvbnRhaW5lclZhbHVlID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKTsKICAgICAgICAgICAgaWYoY29udGFpbmVyVmFsdWUgJiYgY29udGFpbmVyICYmIGNvbnRhaW5lclZhbHVlID09PSBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGlmKG1vZC5jb252ZW50aW9uKFNUQVJUKSkgewogICAgICAgICAgICAgICAgICAgIGRlZmVyKGJpbmQobW9kLnN0b3AsIG1vZCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGNvbnRhaW5lclZhbHVlID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKTsKICAgICAgICAgICAgaWYoY29udGFpbmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMubWVkaWF0b3IuZmlyZShldmVudC5jaGFuZ2VDb250YWluZXIsIGNvbnRhaW5lclZhbHVlKTsKICAgICAgICAgICAgICAgIC8vIFN1YnNjcmlwdGlvbnMgZ2V0IHVuc3Vic2NyaWJlZCB3aGVuIHN0b3BwaW5nIGEgbW9kdWxlLCBzbyB3ZSBuZWVkIHRvIHJlc3Vic2NyaWJlIGV2ZXJ5IHRpbWUgaGVyZS4KICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgcHJvYmFibHkgYmV0dGVyLCBhcyB0aGUgZXZlbnRzIHdpbGwgYmUgbGVzcyBjaGF0dHkuCiAgICAgICAgICAgICAgICBmYWNhZGVzLm1lZGlhdG9yLnN1YnNjcmliZShldmVudC5jaGFuZ2VDb250YWluZXIsIGJpbmQodGhhdC5jaGFuZ2UsIHRoYXQsIG1vZCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuY29udGFpbmVyID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbnRhaW5lci5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2RlcGVuZGVudC5tb2R1bGVzJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0Lm1lZGlhdG9yCiAgICBAc3VibW9kdWxlIHRocnVzdC5tZWRpYXRvci5jb252ZW50aW9uCiAgICAqKi8KICAgICAgICB2YXIgYW55ID0gXy5hbnksIG1hcCA9IF8ubWFwLCBETU9EVUxFUyA9ICdjb25maWcuZGVwZW5kZW50TW9kdWxlcycsIENNT0RVTEVTID0gJ2NvbmZpZy5jaGlsZE1vZHVsZXMnLCBTVEFSVCA9ICdzdGFydC1zdGF0dXMnLCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQ7CiAgICB2YXIgaW52b2tlZGVwZW5kZW50TW9kdWxlcyA9IGZ1bmN0aW9uIChtb2QsIG1ldGhvZCkgewogICAgICAgIHZhciByZXF1aXJlZE1vZHVsZXMgPSBtb2QuY29udmVudGlvbihETU9EVUxFUyk7CiAgICAgICAgaWYocmVxdWlyZWRNb2R1bGVzKSB7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0W21ldGhvZF0ocmVxdWlyZWRNb2R1bGVzKTsKICAgICAgICB9CiAgICB9OwogICAgdmFyIGludm9rZUNoaWxkTW9kdWxlcyA9IGZ1bmN0aW9uIChtb2QsIG1ldGhvZCkgewogICAgICAgIHZhciByZXF1aXJlZE1vZHVsZXMgPSBtb2QuY29udmVudGlvbihDTU9EVUxFUyk7CiAgICAgICAgaWYocmVxdWlyZWRNb2R1bGVzKSB7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0W21ldGhvZF0ocmVxdWlyZWRNb2R1bGVzKTsKICAgICAgICB9CiAgICB9OwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBETU9EVUxFUywgCiAgICAgICAgICAgIENNT0RVTEVTCiAgICAgICAgXSwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgaW52b2tlZGVwZW5kZW50TW9kdWxlcyhtb2QsICdzdGFydCcpLCAKICAgICAgICAgICAgICAgIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdzdGFydCcpCiAgICAgICAgICAgIF07CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZighbW9kLnRocnVzdC5zdGFydGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgIGludm9rZWRlcGVuZGVudE1vZHVsZXMobW9kLCAncmVhZHknKSwgCiAgICAgICAgICAgICAgICAgICAgaW52b2tlQ2hpbGRNb2R1bGVzKG1vZCwgJ3JlYWR5JykKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdzdG9wJyk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIHJldHVybiBpbnZva2VDaGlsZE1vZHVsZXMobW9kLCAnZGVzdHJveScpOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmRlcGVuZGVudE1vZHVsZXMgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZGVwZW5kZW50Lm1vZHVsZXMuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnY2ZnJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L21lZGlhdG9yLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nCiAgICBdOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9jb252ZW50aW9uL3N1YnNjcmlwdGlvbi5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgVGhlIGZhY2FkZSBjb252ZW50aW9uLCBjcmVhdGVzIHRoZSBtZWRpYXRvciBmYWNhZGUgZm9yIGVhY2ggbW9kdWxlLgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIFNVQlNDUklQVElPTlMgPSAnY29uZmlnLm1lZGlhdG9yLnN1YnNjcmlwdGlvbnMnLCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBpc1N0cmluZyA9IF8uaXNTdHJpbmcsIGlzQXJyYXkgPSBfLmlzQXJyYXksIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgaXNQbGFpbk9iamVjdCA9IF8uaXNQbGFpbk9iamVjdCwgZm9yT3duID0gXy5mb3JPd24sIGVhY2ggPSBfLmVhY2g7CiAgICB2YXIgYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciA9IFsKICAgICAgICAnaGFuZGxlcicsIAogICAgICAgICdjb250ZXh0JwogICAgXTsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgU1VCU0NSSVBUSU9OUwogICAgICAgIF0sCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgc3Vic2NyaXB0aW9ucyA9IG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpOwogICAgICAgICAgICBpZihzdWJzY3JpcHRpb25zICYmICEoc3Vic2NyaXB0aW9ucykuX3N1YnNjcmlwdGlvbnNTZXQpIHsKICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgICAgIGZvck93bihzdWJzY3JpcHRpb25zLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uQ29sbGVjdGlvbiwgc3Vic2NyaXB0aW9uTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmKCFpc0FycmF5KHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihzdWJzY3JpcHRpb25Db2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoc3Vic2NyaXB0aW9uQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoc3Vic2NyaXB0aW9uQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25Db2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVhY2goc3Vic2NyaXB0aW9uQ29sbGVjdGlvbiwgZnVuY3Rpb24gKHN1YnNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KHN1YnNjcmlwdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vbmV3U3Vic2NyaXB0aW9uLnB1c2guYXBwbHkobmV3U3Vic2NyaXB0aW9uLCBzdWJzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWFjaChzdWJzY3JpcHRpb24sIGZ1bmN0aW9uIChoYW5kbGVyT2JqZWN0LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1N1YnNjcmlwdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uTmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcoaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3RdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc3Vic2NyaXB0aW9uW2kgKyAxXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goc3Vic2NyaXB0aW9uW2kgKyAxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9yZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzRnVuY3Rpb24oaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goaGFuZGxlck9iamVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbltpICsgMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKHN1YnNjcmlwdGlvbltpICsgMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc1BsYWluT2JqZWN0KGhhbmRsZXJPYmplY3QpICYmICgnbW9kdWxlSGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCB8fCAnaGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9uZXdTdWJzY3JpcHRpb24gPSBbc3Vic2NyaXB0aW9uTmFtZV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdtb2R1bGVIYW5kbGVyJyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChtb2QuaW5zdGFuY2VbaGFuZGxlck9iamVjdC5tb2R1bGVIYW5kbGVyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoJ2hhbmRsZXInIGluIGhhbmRsZXJPYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKGhhbmRsZXJPYmplY3QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3QuaGFuZGxlcl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChoYW5kbGVyT2JqZWN0LmhhbmRsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdjb250ZXh0JyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChoYW5kbGVyT2JqZWN0LmNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5ld1N1YnNjcmlwdGlvbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhY2FkZS5zdWJzY3JpYmUuYXBwbHkoZmFjYWRlLCBuZXdTdWJzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpLl9zdWJzY3JpcHRpb25zU2V0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBzdWJzY3JpcHRpb25zID0gbW9kLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUyk7CiAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbnMgJiYgc3Vic2NyaXB0aW9ucy5fc3Vic2NyaXB0aW9uc1NldCkgewogICAgICAgICAgICAgICAgbW9kLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUykuX3N1YnNjcmlwdGlvbnNTZXQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnN1YnNjcmlwdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdWJzY3JpcHRpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFByb3ZpZGVzIHRocnVzdCBjb25maWd1cmF0aW9uCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LmRhdGEKICAgIEBzdWJtb2R1bGUgdGhydXN0LmRhdGEuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicsIAogICAgICAgICdjZmcnCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvZG9tLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvZGF0YS9jb252ZW50aW9uL3N0YXJ0JwogICAgXTsKICAgIC8qKgogICAgRGVjaWRlcyBpZiBgdGhydXN0L2RhdGFgIHNob3VsZCBjYWNoZSByZXF1ZXN0cyBvciBub3QuCiAgICAKICAgIFlvdSBzaG91bGQgdHVybiB0aGlzIHRvIGBmYWxzZWAsIGlmIHlvdSBhcmUgZXhwZXJpZW5jaW5nIGNhY2hpbmcgaXNzdWVzIGFuZCBuZWVkIHRvIGRlYnVnLgogICAgCiAgICBAcHJvcGVydHkgY2FjaGUKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuY2FjaGUgPSB0cnVlOwogICAgLyoqCiAgICAqCiAgICAqIGBzdGFydFRpbWVvdXRgIGlzIHBhcnQgb2YgcXVldWVpbmcgYnVpbHQgaW50byBgdGhydXN0L2RhdGFgLiAgSXQgZGVmaW5lcyB0aGUgd2FpdCB0aW1lIGJlZm9yZSByZXF1ZXN0cwogICAgKiBhcmUgc3RhcnRlZC4KICAgICoKICAgICoKICAgICogVGhlIHF1ZXVlaW5nIHN5c3RlbSB3b3JrcyBpbiB0aGUgZm9sbG93aWcgbWFubmVyLiAgQWxsIHJlcXVlc3RzIHRoYXQgYXJlIHF1ZXVlZCB0b2dldGhlciBwZXIgSFRUUAogICAgKiByZXF1ZXN0IG1ldGhvZCAoYEdFVGAsIGBQT1NUYCwgYFBVVGAsIGBERUxFVEVgLCBgUEFUQ0hgLCBldGMpLiAgQWZ0ZXIgdGhlIGZpcnN0IHJlcXVlc3QsIHRoZSB0aW1lcgogICAgKiBzdGFydHMsIG9uY2UgdGhlIHRpbWVvdXQgZWxhcHNlcywgYWxsIHRoZSByZXF1ZXN0cyBhcmUgc2hpcHBlZCBvZmYgYXQgb25jZS4KICAgICoKICAgICoKICAgICogVGhpcyBjb3VudGVyIGludHVpdGl2ZSBpZiB5b3UncmUgbG9va2luZyB0byBnZXQgdGhlIHJlcXVlc3QgYmFjayBpbW1lZGlhdGVseSwgYnV0IGZyb20gYSBVWCBwZXJzcGVjdGl2ZQogICAgKiB0aGlzIGFsbG93cyB0aGUgVUkgdG8gc3RheSBpbiBzeW5jIGFuZCBnaXZlIHRoZSB1c2VyIGEgY29oZXNpdmUsIGluc3RlYWQgb2Ygc2VlaW5nIGxvYWRlcnMsIHNob3cgdXAgYW5kCiAgICAqIGRpc2FwcGVhciBhdCBzZWVtaW5nbHkgcmFuZG9tIGludGVydmFscywgdGhlIHVzZXIgZG9lcyBhbiBhY3Rpb24sIGFuZCB0aGVuIHNlZXMgYSByZXNwb25zZS4KICAgICoKICAgICoKICAgICogQHByb3BlcnR5IHN0YXJ0VGltZW91dAogICAgKiBAcmVhZE9ubHkKICAgICogQHR5cGUge051bWJlcn0KICAgICogQGRlZmF1bHQgNTAwCiAgICAqKi8KICAgIGV4cG9ydHMuc3RhcnRUaW1lb3V0ID0gMTAwOwogICAgLyoqCiAgICAqCiAgICAqIGBmaW5pc2hUaW1lb3V0YCBpcyBwYXJ0IG9mIHF1ZXVlaW5nIGJ1aWx0IGludG8gYHRocnVzdC9kYXRhYC4gIEl0IGRlZmluZXMgdGhlIHdhaXQgdGltZSBiZWZvcmUgdGhlCiAgICAqIHF1ZXVlIGlzIGNvbXBsZXRlZC4gIElmIGFsbCB0aGUgcmVxdWVzdHMgZmluaXNoIGVhcmx5LCB0aGUgdGltZW91dCBpcyBjYW5jZWxlZC4KICAgICoKICAgICoKICAgICogVGhlIHF1ZXVlaW5nIHN5c3RlbSB3b3JrcyBpbiB0aGUgZm9sbG93aWcgbWFubmVyLiAgQWxsIHJlcXVlc3RzIHRoYXQgYXJlIHF1ZXVlZCB0b2dldGhlciBwZXIgSFRUUAogICAgKiByZXF1ZXN0IG1ldGhvZCAoYEdFVGAsIGBQT1NUYCwgYFBVVGAsIGBERUxFVEVgLCBgUEFUQ0hgLCBldGMpLiAgQWZ0ZXIgdGhlIHJlcXVlc3RzIGFyZSBmaXJlZCBvZmYKICAgICogYHRocnVzdC9kYXRhYCB3aWxsIHdhaXQgdW50aWwgaXQgZ2V0cyBhIHJlc3BvbnNlIGZyb20gZXZlcnlvbmUgb2YgdGhlbS4gIElmIGZvciBzb21lIHJlYXNvbiBhIHJlcXVlc3QKICAgICogdGFrZXMgdG8gbG9uZywgYW5kIHRoZSB0aW1lb3V0IGlzIGhpdCwgYWxsIHRoZSByZXF1ZXN0cyB0aGF0IGhhdmUgY29tcGxldGVkLCB3aWxsIGJlIHJlbGVhc2VlZCwgYWxsb3dpbmcKICAgICogdGhlIGFwcGxpY2F0aW9uIHRvIGNvbnRpbnVlIHVuZGlzcnVwdGVkLgogICAgKgogICAgKgogICAgKiBUaGlzIGNvdW50ZXIgaW50dWl0aXZlIGlmIHlvdSdyZSBsb29raW5nIHRvIGdldCB0aGUgcmVxdWVzdCBiYWNrIGltbWVkaWF0ZWx5LCBidXQgZnJvbSBhIFVYIHBlcnNwZWN0aXZlCiAgICAqIHRoaXMgYWxsb3dzIHRoZSBVSSB0byBzdGF5IGluIHN5bmMgYW5kIGdpdmUgdGhlIHVzZXIgYSBjb2hlc2l2ZSwgaW5zdGVhZCBvZiBzZWVpbmcgbG9hZGVycywgc2hvdyB1cCBhbmQKICAgICogZGlzYXBwZWFyIGF0IHNlZW1pbmdseSByYW5kb20gaW50ZXJ2YWxzLCB0aGUgdXNlciBkb2VzIGFuIGFjdGlvbiwgYW5kIHRoZW4gc2VlcyBhIHJlc3BvbnNlLgogICAgKgogICAgKgogICAgQHByb3BlcnR5IGZpbmlzaFRpbWVvdXQKICAgIEByZWFkT25seQogICAgQHR5cGUge051bWJlcn0KICAgIEBkZWZhdWx0IDIwMDAKICAgICoqLwogICAgZXhwb3J0cy5maW5pc2hUaW1lb3V0ID0gMjAwMDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RhdGEvZXZlbnQudHlwZXMnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8qKgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5kYXRhCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICAqKi8KICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS93YWl0YCBldmVudCBpcyBmaXJlZCBvbmNlIGEgZGF0YSBjYWxsIGlzIG1hZGUuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS93YWl0CiAgICBAcGFyYW0ge1N0cmluZ30gcXVlcnlJZCBUaGUgaW50ZXJuYWwgaWQgb2YgdGhlIG91dGJvdW5kIHF1ZXVlLgogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIG91dGJvdW5kIGV2ZW50IHF1ZXVlIChHZXQvUG9zdC9ldGMpCiAgICAqKi8KICAgIGV4cG9ydHMud2FpdCA9ICd0aHJ1c3QvZGF0YS93YWl0JzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdGFydGAgZXZlbnQgaXMgZmlyZWQgdGhlIHF1ZXVlIGlzIHN0YXJ0ZWQuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGFydAogICAgQHBhcmFtIHtTdHJpbmd9IHF1ZXJ5SWQgVGhlIGludGVybmFsIGlkIG9mIHRoZSBvdXRib3VuZCBxdWV1ZS4KICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIHRoZSBvdXRib3VuZCBldmVudCBxdWV1ZSAoR2V0L1Bvc3QvZXRjKQogICAgQHBhcmFtIHtOdW1iZXJ9IGNvdW50IFRoZSBvdXRnb2luZyBjYWxsIGNvdW50CiAgICAqKi8KICAgIGV4cG9ydHMuc3RhcnQgPSAndGhydXN0L2RhdGEvc3RhcnQnOwogICAgLyoqCiAgICBUaGUgYHRocnVzdC9kYXRhL3N0YXR1c2AgZXZlbnQgaXMgZmlyZWQgZm9yIGV2ZXJ5IGl0ZW0gdGhhdCByZXR1cm5zIGZyb20gdGhlIHF1ZXVlLgogICAgCiAgICBOT1RFOiBJdCBpcyBlbnRpcmVseSBwb3NzaWJsZSBmb3IgYHRocnVzdC9kYXRhL3N0YXR1cyoqIHRvIGJlIGNhbGxlZCBhZnRlciBgdGhydXN0L2RhdGEvc3RvcCoqIGlmIHNldmVyYWwKICAgIGNhbGxzIHRha2UgdG8gbG9uZyB0byBjb21wbGV0ZS4gIFRoaXMgaXMgaW50ZW5kZWQsIGFuZCBwb3RlbnRpYWxseSB1c2VmdWwgaW5mb3JtYXRpb24uCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGF0dXMKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgY3VycmVudCBjb21wbGV0ZWQgY2FsbCBjb3VudCBmb3IgdGhpcyBxdWV1ZS4KICAgICoqLwogICAgZXhwb3J0cy5zdGF0dXMgPSAndGhydXN0L2RhdGEvc3RhdHVzJzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdG9wYCBldmVudCBpcyBmaXJlZCB3aGVuIGFsbCBpdGVtcyBpbiB0aGUgcXVldWUgcmV0dXJuLCBvciB0aGUgZmluaXNoZWRUaW1lb3V0IHNldHRpbmcgZWxhcHNlcy4KICAgIAogICAgQGV2ZW50IHRocnVzdC9kYXRhL3N0b3AKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgKGN1cnJlbnQpIGNvbXBsZXRlZCBjYWxsIGNvdW50IGZvciB0aGlzIHF1ZXVlLgogICAgKiovCiAgICBleHBvcnRzLnN0b3AgPSAndGhydXN0L2RhdGEvc3RvcCc7CiAgICBleHBvcnRzLmV2ZW50ID0gewogICAgICAgIGJlZm9yZVNlbmQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvYmVmb3JlLXNlbmRgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9iZWZvcmUtc2VuZAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L2JlZm9yZS1zZW5kJywKICAgICAgICBzdGFydDogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9zdGFydGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N0YXJ0CiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvc3RhcnQnLAogICAgICAgIHNlbmQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc2VuZGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3NlbmQKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zZW5kJywKICAgICAgICBlcnJvcjogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9lcnJvcmAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L2Vycm9yCiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvZXJyb3InLAogICAgICAgIHN1Y2Nlc3M6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc3VjY2Vzc2AgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N1Y2Nlc3MKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zdWNlc3MnLAogICAgICAgIGNvbXBsZXRlOiAvKioKICAgICAgICBUaGUgYHRocnVzdC9kYXRhL2V2ZW50L2NvbXBsZXRlYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvY29tcGxldGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9jb21wbGV0ZScsCiAgICAgICAgc3RvcDogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9zdG9wYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvc3RvcAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L3N0b3AnCiAgICB9Owp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1ldmVudC50eXBlcy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kYXRhL2V2ZW50LmZhY3RvcnknLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJy4vZXZlbnQudHlwZXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2V2ZW50VHlwZXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vanF1ZXJ5LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnRUeXBlcyA9IF9fZXZlbnRUeXBlc19fOwoKICAgIHZhciBjYW1lbENhc2UgPSB1dGlsLmNhbWVsQ2FzZSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGJpbmQgPSBfLmJpbmQsIGRhdGFFdmVudHMgPSBldmVudFR5cGVzLmV2ZW50LCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgbWVtb2l6ZSA9IF8ubWVtb2l6ZTsKICAgIC8qKgogICAgVGhlIGV2ZW50IGZhY3RvcnkgbGlua3MgalF1ZXJ5IEV2ZW50cyB1cCB0byB0aHJ1c3QgY2VudHJpYyBldmVudHMuCiAgICBUaGUgZXZlbnQgZmFjdG9yeSB3b3VsZCBiZSByZXBsYWNlZCBpZiB3ZSB3ZXJlIGV2ZXIgbW92ZWQgb2ZmIG9mIHRoZSBqUXVlcnkgZGVwZW5kYW5jeS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QuZGF0YQogICAgKiovCiAgICB2YXIgZXZlbnRIYW5kbGVycyA9IHsKICAgICAgICAnYmVmb3JlLXNlbmQnOiAvLyBTdXBwb3J0ZWQgZXZlbnQgaGFuZGxlcnMKICAgICAgICB0cnVlLAogICAgICAgICdzZW5kJzogdHJ1ZSwKICAgICAgICAnZXJyb3InOiB0cnVlLAogICAgICAgICdzdWNjZXNzJzogdHJ1ZSwKICAgICAgICAnY29tcGxldGUnOiB0cnVlLAogICAgICAgICdzdGFydCc6IHRydWUsCiAgICAgICAgJ3N0b3AnOiB0cnVlCiAgICB9OwogICAgLyoqCiAgICBXcmFwcyBiZWZvcmVTZW5kLCB3aGljaCBpcyBhIGN1c3RvbSBwcm9wZXJ0eSBvbiB0aGUgalF1ZXJ5IGFqYXggZGF0YSBjYWxsLgogICAgCiAgICBAbWV0aG9kIGJlZm9yZVNlbmRNZXRob2QKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGJlZm9yZVNlbmRNZXRob2QoanFYSFIsIHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICB0aGlzLmZpcmUoZGF0YUV2ZW50c1snYmVmb3JlU2VuZCddLCBqcVhIUiwgc2V0dGluZ3MpOwogICAgfQogICAgZXhwb3J0cy5iZWZvcmVTZW5kTWV0aG9kID0gYmVmb3JlU2VuZE1ldGhvZDsKICAgIHZhciBldmVudEZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHZhciBldnQgPSBkYXRhRXZlbnRzW2V2ZW50XTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGV2dCk7CiAgICAgICAgICAgIHRoaXMuZmlyZS5hcHBseSh0aGlzLmZpcmUuYXN5bmMsIGFyZ3MpOwogICAgICAgIH07CiAgICB9KTsKICAgIHZhciBub3JtYWxpemVFdmVudHMgPSBmdW5jdGlvbiAoZXZ0cykgewogICAgICAgIGV2dHMgPSBldnRzLnNwbGl0KCcgJyk7CiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGV2dHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmKCFldmVudEhhbmRsZXJzW2V2dHNbaV1dKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdFdmVudCAiezB9IiBpcyBub3QgYSB2YWxpZCBkYXRhIGV2ZW50JywgZXZ0c1tpXSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2dHNbaV0gPSBkYXRhRXZlbnRzW2V2dHNbaV1dOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZ0cy5qb2luKCcgJyk7CiAgICB9OwogICAgdmFyIHNlbmRFdmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoaSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXZlbnQsIGpxWEhSLCBzZXR0aW5ncykgewogICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgICAgICBpZighc2V0dGluZ3MuX19tZWRpYXRvcl9kYXRhX2ZpcmVkX18pIHsKICAgICAgICAgICAgICAgIGpxWEhSLmFib3J0KCk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCwgYWxsIGFqYXggY2FsbHMgbXVzdCBwYXNzIHRocm91Z2ggdGhydXN0LWRhdGEuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXNldHRpbmdzLnNpbGVudCkgewogICAgICAgICAgICAgICAgZXZlbnRGYWN0b3J5KGkpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKICAgIC8qKgogICAgQmluZHMgYWxsIHRoZSBqUXVlcnkgZGF0YSBldmVudHMgYW5kIGNyZWF0ZXMgZXZlbnQgbmF0aXZlIHRocnVzdCBldmVudHMgb3V0IG9mIHRoZW0uCiAgICAKICAgIEBmb3IgdGhydXN0LmRhdGEKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGluaXQKICAgIEBwYXJhbSB7alF1ZXJ5fSBBIGpRdWVyeSBpbnN0YW5jZSB3cmFwcGluZyAnZG9jdW1lbnQnCiAgICAqKi8KICAgIGZ1bmN0aW9uIGluaXQoakRvYykgewogICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgICAgICAgZm9yKHZhciBpIGluIGV2ZW50SGFuZGxlcnMpIHsKICAgICAgICAgICAgdmFyIGpxRXZ0ID0gJ2FqYXgtJyArIGksIG1ldGhvZCA9IGV2ZW50RmFjdG9yeShpKTsKICAgICAgICAgICAgaWYoaSA9PT0gJ3NlbmQnKSB7CiAgICAgICAgICAgICAgICBtZXRob2QgPSBiaW5kKHNlbmRFdmVudEZhY3RvcnkoaSksIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGpEb2Mub24oY2FtZWxDYXNlKGpxRXZ0KSArIHRoaXMubmFtZXNwYWNlLCBtZXRob2QpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaW5pdCA9IGluaXQ7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWV2ZW50LmZhY3RvcnkuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9yZXNwb25zZS5xdWV1ZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAnLi9ldmVudC50eXBlcycsICdqcXVlcnknLCAndGhydXN0L2xvZycsICdoYXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2V2ZW50VHlwZXNfXywgX19qUXVlcnlfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9qcXVlcnkuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBldmVudFR5cGVzID0gX19ldmVudFR5cGVzX187CgogICAgdmFyIGpRdWVyeSA9IF9falF1ZXJ5X187CgogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gXy5leHRlbmQsIHdoZW4gPSB1dGlsLndoZW4sIHVpZCA9IF8udW5pcXVlSWQsIGFqYXggPSBqUXVlcnkuYWpheCwgZGF0YUV2ZW50V2FpdCA9IGV2ZW50VHlwZXMud2FpdCwgZGF0YUV2ZW50U3RhcnQgPSBldmVudFR5cGVzLnN0YXJ0LCBkYXRhRXZlbnRTdG9wID0gZXZlbnRUeXBlcy5zdG9wLCBkYXRhRXZlbnRTdGF0dXMgPSBldmVudFR5cGVzLnN0YXR1cywgcXVldWUgPSB7CiAgICB9LCB1cGRhdGVYSFJJbnRlcm5hbHMgPSBmdW5jdGlvbiAoZGZvLCB4aHIpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZighZGZvLl94aHIpIHsKICAgICAgICAgICAgICAgIGRmby5feGhyID0geGhyOwogICAgICAgICAgICAgICAgZGZvLmdldEFsbFJlc3BvbnNlSGVhZGVycyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZGZvLmdldFJlc3BvbnNlSGVhZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZm8uX3hoci5nZXRBbGxSZXNwb25zZUhlYWRlcnNnZXRSZXNwb25zZUhlYWRlcigpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGRmby5hYm9ydCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBkZm8uc2V0UmVxdWVzdEhlYWRlciA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZm8uX3hoci5zZXRSZXF1ZXN0SGVhZGVyKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGZvLnJlc3BvbnNlVGV4dCA9IHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgIGRmby5yZXNwb25zZVhNTCA9IHhoci5yZXNwb25zZVhNTDsKICAgICAgICAgICAgZGZvLnJlYWR5U3RhdGUgPSB4aHIucmVhZHlTdGF0ZTsKICAgICAgICAgICAgZGZvLnN0YXR1cyA9IHhoci5zdGF0dXM7CiAgICAgICAgICAgIGRmby5zdGF0dXNUZXh0ID0geGhyLnN0YXR1c1RleHQ7CiAgICAgICAgfTsKICAgIH0sIGFyZ3VtZW50UmVzb2x2ZXIgPSBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgfTsKICAgIH0sIGRlZmVyQ29udHJvbGxlckl0ZW1DYWxsYmFjayA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzLCBhcmd1bWVudHNbMF1bMF0pOwogICAgICAgIH07CiAgICB9OwogICAgLyoqCiAgICBUaGUgcmVzcG9uc2UgcXVldWUgY2xhc3MgaGFuZGxlcyBjcmVhdGlvbiBvZiBhIHF1ZXVlIG9yIGJhdGNoaW5nIHN5c3RlbS4KICAgIFdpdGggdGhpcyBzeXN0ZW0sIHdlIGNhbiBiYXRjaCB1cCBhbGwgb3VyIHNlcnZlciByZXF1ZXN0cywgYW5kIHJlcXVlc3QgdGhlbSBmcm9tIHRoZSBzZXJ2ZXIgYWxsIGFyb3VuZCB0aGUgc2FtZSB0aW1lLgogICAgSW4gYWRkaXRpb24gdG8gdGhhdCwgd2hlbiB0aGUgcmVxdWVzdHMgY29tZSBiYWNrIHdlIGNhbiBhbHNvIHNwb29sIHRoZW0gdG9nZXRoZXIsIHNvIHRoYXQgdGhlIGNhbGxzIGRvbid0IHJlc29sdmUgdW50aWwKICAgIGVpdGhlciBhbGwgdGhlIGNhbGxzIGNvbWUgYmFjaywgb3IgYSBzcGVjaWZpYyB0aW1lIGhhcyBlbGFwc2VkLgogICAgCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICBAY2xhc3MgdGhydXN0LmRhdGEuUmVzcG9uc2VRdWV1ZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgcmVzcG9uc2UgcXVldWUgZm9yCiAgICBAcGFyYW0ge051bWJlcn0gc3RhcnRUaW1lb3V0IFRoZSB0aW1lIHRvIHdhaXQgZm9yIGFkZGl0aW9uYWwgcmVxdWVzdHMuCiAgICBAcGFyYW0ge051bWJlcn0gZmluaXNoVGltZW91dCBUaGUgbWF4aW11bSB0aW1lIHRvIHdhaXQgZm9yIHJlcXVlc3RzIHRvIHJldHVybi4KICAgICoqLwogICAgdmFyIFJlc3BvbnNlUXVldWUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFJlc3BvbnNlUXVldWUobW9kdWxlLCBzdGFydFRpbWVvdXQsIGZpbmlzaFRpbWVvdXQpIHsKICAgICAgICAgICAgdGhpcy5zdGFydFRpbWVvdXQgPSBzdGFydFRpbWVvdXQ7CiAgICAgICAgICAgIHRoaXMuZmluaXNoVGltZW91dCA9IGZpbmlzaFRpbWVvdXQ7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLm5hbWVzcGFjZSA9IG1vZHVsZS5uYW1lc3BhY2U7CiAgICAgICAgfQogICAgICAgIFJlc3BvbnNlUXVldWUucHJvdG90eXBlLmFkZFRvUXVldWUgPSAvKioKICAgICAgICBBZGRzIGEgcmVxdWVzdCB0byB0aGUgcXVldWUKICAgICAgICBRdWV1ZXMgYXJlIHNwbGl0IHVwIGJ5IEhUVFAgdHlwZSwgc28gR0VUIHJlcXVlc3RzIGdvIHdpdGggR0VUIHJlcXVlc3RzIGFuZCBQT1NUIHJlcXVlc3RzIGdvIHdpdGggUE9TVCByZXF1ZXN0cy4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGFkZFRvUXVldWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgcmVxdWVzdCB0eXBlIChQT1NULCBHRVQsIGV0YykKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSByZXF1ZXN0IHVybCB0byBxdWV1ZSB1cAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSByZXF1ZXN0IG9wdGlvbnMuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIG9yIHJlamVjdCwgd2hlbiB0aGUgcmVxdWVzdCBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHR5cGUsIHVybCwgb3B0aW9ucykgewogICAgICAgICAgICB2YXIgZGZvID0gd2hlbi5kZWZlcigpLCB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYob3B0aW9ucy5iZWZvcmVTZW5kKSB7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgICAgICAgICAgIGRmby5wcm9ncmVzcyhmdW5jdGlvbiAoZXZlbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnRUeXBlICYmIGV2ZW50VHlwZSA9PSAnYmVmb3JlLXNlbmQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVTZW5kLmFwcGx5KGJlZm9yZVNlbmQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLmNvbXBsZXRlKSB7CiAgICAgICAgICAgICAgICBkZm8ucHJvbWlzZS5hbHdheXMob3B0aW9ucy5jb21wbGV0ZSk7CiAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy5jb21wbGV0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIGRmby5wcm9taXNlLnRoZW4ob3B0aW9ucy5zdWNjZXNzKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYob3B0aW9ucy5lcnJvcikgewogICAgICAgICAgICAgICAgZGZvLnByb21pc2Uub3RoZXJ3aXNlKG9wdGlvbnMuZXJyb3IpOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc1F1ZXVlID0gISFxdWV1ZVt0eXBlXSwgbGlzdCA9IHF1ZXVlW3R5cGVdIHx8IChxdWV1ZVt0eXBlXSA9IHsKICAgICAgICAgICAgfSksIHRhaWwgPSBsaXN0LnRhaWwgfHwgKGxpc3QudGFpbCA9IGxpc3QubmV4dCA9IHsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGV4dGVuZCh0YWlsLCB7CiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgICAgICAgICBkZm86IGRmbwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGlzdC50YWlsID0gdGFpbC5uZXh0ID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICBpZighaGFzUXVldWUpIHsKICAgICAgICAgICAgICAgIHdoZW4uZGVsYXkodGhhdC5zdGFydFRpbWVvdXQpLnRoZW4odGhhdC5wcm9jZXNzKHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGZvLnByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBSZXNwb25zZVF1ZXVlLnByb3RvdHlwZS5wcm9jZXNzID0gLyoqCiAgICAgICAgUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0IHdpbGwgcHJvY2VzcyB0aGUgZ2l2ZW4gcXVldWUgYWZ0ZXIgdGhlIHN0YXJ0IHRpbWUgaGFzIGVsYXBzZWQuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBwcm9jZXNzCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHF1ZXVlIHR5cGUsIHRvIHByb2Nlc3MuCiAgICAgICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgZnVuY3Rpb24gdGhhdCB3aWxsIGRvIHRoZSB3b3JrIG9uIHRoZSBxdWV1ZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gcXVldWVbdHlwZV0sIG5vZGUgPSBwYXJlbnQsIHRoYXQgPSB0aGlzLCBxdWVyeUlkID0gdWlkKCdkcScpOwogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEYXRhW3swfV06IENyZWF0aW5nIHF1ZXVlIGZvciB0eXBlICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHR5cGUpKTsKICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRXYWl0LCBxdWVyeUlkLCB0eXBlKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RhdGFbezB9XTogUHJvY2Vzc2luZyBxdWV1ZSBmb3IgdHlwZSAiezF9IicsIHRoYXQubmFtZXNwYWNlLCB0eXBlKSk7CiAgICAgICAgICAgICAgICB2YXIgd2hlblF1ZXVlID0gW10sIGRlZmVyQ29udHJvbGxlciA9IHdoZW4uZGVmZXIoKSwgcmV0dXJuQ291bnQgPSAwOwogICAgICAgICAgICAgICAgZGVmZXJDb250cm9sbGVyLnByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRGF0YVt7MH1dOiBGaW5pc2hpbmcgcXVldWUgZm9yIHR5cGUgInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdHlwZSkpOwogICAgICAgICAgICAgICAgICAgIHRoYXQubW9kdWxlLmZpcmUoZGF0YUV2ZW50U3RvcCwgcXVlcnlJZCwgdHlwZSwgcmV0dXJuQ291bnQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBkZWxldGUgcXVldWVbdHlwZV07CiAgICAgICAgICAgICAgICB2YXIgdGFpbCA9IG5vZGUudGFpbCwgc3RhdHVzQ2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRTdGF0dXMsIHF1ZXJ5SWQsIHR5cGUsICsrcmV0dXJuQ291bnQpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHdoaWxlKChub2RlID0gbm9kZS5uZXh0KSAhPT0gdGFpbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZm8gPSBub2RlLmRmbywgb3B0aW9ucyA9IGV4dGVuZCh7CiAgICAgICAgICAgICAgICAgICAgfSwgbm9kZS5vcHRpb25zKSwgeGhyRGZvID0gd2hlbi5kZWZlcigpLCB4aHIgPSBub2RlLnhociA9IGFqYXgobm9kZS51cmwsIG9wdGlvbnMpLnRoZW4oYXJndW1lbnRSZXNvbHZlcih4aHJEZm8ucmVzb2x2ZSksIGFyZ3VtZW50UmVzb2x2ZXIoeGhyRGZvLnJlamVjdCkpOwogICAgICAgICAgICAgICAgICAgIHhockRmby5wcm9taXNlLnRoZW4oc3RhdHVzQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIHdoZW5RdWV1ZS5wdXNoKHhocik7CiAgICAgICAgICAgICAgICAgICAgd2hlbi5hbGwoWwogICAgICAgICAgICAgICAgICAgICAgICB4aHJEZm8sIAogICAgICAgICAgICAgICAgICAgICAgICBkZWZlckNvbnRyb2xsZXIucHJvbWlzZQogICAgICAgICAgICAgICAgICAgIF0sIHdoZW4uYXBwbHkoZGZvLnJlc29sdmUpLCB3aGVuLmFwcGx5KGRmby5yZWplY3QpLCB1cGRhdGVYSFJJbnRlcm5hbHMoZGZvLCB4aHIpKTsKICAgICAgICAgICAgICAgICAgICBkZm8ucHJvZ3Jlc3MoJ2JlZm9yZS1zZW5kJywgWwogICAgICAgICAgICAgICAgICAgICAgICBkZm8sIAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGF0Lm1vZHVsZS5maXJlKGRhdGFFdmVudFN0YXJ0LCBxdWVyeUlkLCB0eXBlLCB3aGVuUXVldWUubGVuZ3RoKTsKICAgICAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgICAgICB3aGVuLmFsbCh3aGVuUXVldWUpLCAKICAgICAgICAgICAgICAgICAgICB3aGVuLmRlbGF5KHRoYXQuZmluaXNoVGltZW91dCkKICAgICAgICAgICAgICAgIF0sIGRlZmVyQ29udHJvbGxlci5yZXNvbHZlLCBkZWZlckNvbnRyb2xsZXIucmVzb2x2ZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gUmVzcG9uc2VRdWV1ZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLlJlc3BvbnNlUXVldWUgPSBSZXNwb25zZVF1ZXVlOyAgICAKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9cmVzcG9uc2UucXVldWUuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9jb252ZW50aW9uL3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZGF0YS9kYXRhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbjsKICAgIHZhciB3aGVuUXVldWUgPSBbXTsKICAgIGZ1bmN0aW9uIHdhaXRDYWxsYmFjayh1aWQpIHsKICAgICAgICB2YXIgZCA9IHdoZW4uZGVmZXIoKTsKICAgICAgICBkLnJlc29sdmVyWyd1aWQnXSA9IHVpZDsKICAgICAgICB3aGVuUXVldWUucHVzaCh7CiAgICAgICAgICAgIHVpZDogdWlkLAogICAgICAgICAgICByZXNvbHZlcjogZC5yZXNvbHZlcgogICAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gc3RvcENhbGxiYWNrKHVpZCkgewogICAgICAgIHZhciBpdGVtID0gXy5maW5kKHdoZW5RdWV1ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuIHgudWlkID09PSB1aWQ7CiAgICAgICAgfSk7CiAgICAgICAgd2hlblF1ZXVlID0gXy53aXRob3V0KHdoZW5RdWV1ZSwgaXRlbSk7CiAgICAgICAgaXRlbS5yZXNvbHZlci5yZXNvbHZlKCk7CiAgICB9CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBjb3VudGRvd246IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgLy8gU3Vic2NyaWJlIHRvIHRoZSB3YWl0IGFuZCBzdG9wIGV2ZW50cwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3dhaXQnLCB3YWl0Q2FsbGJhY2spOwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3N0b3AnLCBzdG9wQ2FsbGJhY2spOwogICAgICAgIH0sCiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgLy8gVW5zdWJzY3JpYmUgZnJvbSB0aGUgd2FpdCBhbmQgc3RvcCBldmVudHMKICAgICAgICAgICAgdGhydXN0LmRhdGEudW5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3dhaXQnLCB3YWl0Q2FsbGJhY2spOwogICAgICAgICAgICB0aHJ1c3QuZGF0YS51bnN1YnNjcmliZSgndGhydXN0L2RhdGEvc3RvcCcsIHN0b3BDYWxsYmFjayk7CiAgICAgICAgICAgIC8vIGRlZmVyIHVudGlsIGFueSBvZiB0aGUgZXZlbnRzIHRoYXQgd2VyZSBjYXB0dXJlZCBhcmUgcmVzb2x2ZWQsIG9yIHRoZSBkZWxheSBwYXNzZXMuCiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgaWYodGhydXN0LmNmZy5kYXRhLmZpbmlzaFRpbWVvdXQgPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbCh3aGVuUXVldWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICB3aGVuLmFsbCh3aGVuUXVldWUpLCAKICAgICAgICAgICAgICAgIHdoZW4uZGVsYXkodGhydXN0LmNmZy5kYXRhLmZpbmlzaFRpbWVvdXQpCiAgICAgICAgICAgIF0sIGRlZmVyLnJlc29sdmUsIGRlZmVyLnJlamVjdCk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuc3Vic2NyaXB0aW9uID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXN0YXJ0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0LmRvbS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicKICAgIF07CiAgICAvKioKICAgIFRoZSBzZXQgb2YgY29udmVudGlvbnMgdG8gbG9hZCBpbnRvIHRocnVzdC9kb20uCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9kb20vY29udmVudGlvbi9hY3Rpb24nLCAKICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2NvbnRleHQnLCAKICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JwogICAgXTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9zdWJqcXVlcnknLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ2pxdWVyeScsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ2hhcyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2pRdWVyeV9fLCBfX3V0aWxfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBqUXVlcnkgPSBfX2pRdWVyeV9fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGVhY2ggPSBfLmVhY2gsIGV4dGVuZCA9IF8uZXh0ZW5kLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBHTE9CQUwgPSAnLmdsb2JhbCc7CiAgICB2YXIgalF1ZXJ5Rm5NZXRob2RCbGFja0xpc3QgPSBbCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ2V4dGVuZCcsIAogICAgICAgICdxdWV1ZScsIAogICAgICAgICdkZXF1ZXVlJywgCiAgICAgICAgJ2NsZWFyUXVldWUnLCAKICAgICAgICAncHJvbWlzZScsIAogICAgICAgICdiaW5kJywgCiAgICAgICAgJ3VuYmluZCcsIAogICAgICAgICdsaXZlJywgCiAgICAgICAgJ2RpZScsIAogICAgICAgICdkZWxlZ2F0ZScsIAogICAgICAgICd1bmRlbGVnYXRlJywgCiAgICAgICAgJ2JsdXInLCAKICAgICAgICAnZm9jdXMnLCAKICAgICAgICAnZm9jdXNpbicsIAogICAgICAgICdmb2N1c291dCcsIAogICAgICAgICdsb2FkJywgCiAgICAgICAgJ3Jlc2l6ZScsIAogICAgICAgICdzY3JvbGwnLCAKICAgICAgICAndW5sb2FkJywgCiAgICAgICAgJ2NsaWNrJywgCiAgICAgICAgJ2RibGNsaWNrJywgCiAgICAgICAgJ21vdXNlZG93bicsIAogICAgICAgICdtb3VzZXVwJywgCiAgICAgICAgJ21vdXNlbW92ZScsIAogICAgICAgICdtb3VzZW92ZXInLCAKICAgICAgICAnbW91c2VvdXQnLCAKICAgICAgICAnbW91c2VlbnRlcicsIAogICAgICAgICdtb3VzZWxlYXZlJywgCiAgICAgICAgJ2NoYW5nZScsIAogICAgICAgICdzZWxlY3QnLCAKICAgICAgICAnc3VibWl0JywgCiAgICAgICAgJ2tleWRvd24nLCAKICAgICAgICAna2V5cHJlc3MnLCAKICAgICAgICAna2V5dXAnLCAKICAgICAgICAnZXJyb3InLCAKICAgICAgICAnc2VyaWFsaXplJywgCiAgICAgICAgJ3NlcmlhbGl6ZUFycmF5JywgCiAgICAgICAgJ2FqYXhTdGFydCcsIAogICAgICAgICdhamF4U3RvcCcsIAogICAgICAgICdhamF4Q29tcGxldGUnLCAKICAgICAgICAnYWpheEVycm9yJywgCiAgICAgICAgJ2FqYXhTdWNjZXNzJywgCiAgICAgICAgJ2FqYXhTZW5kJywgCiAgICAgICAgJ190b2dnbGUnLCAKICAgICAgICAnZmFkZVRvJywgCiAgICAgICAgJ3N0b3AnLCAKICAgICAgICAnc2xpZGVEb3duJywgCiAgICAgICAgJ3NsaWRlVXAnLCAKICAgICAgICAnc2xpZGVUb2dnbGUnLCAKICAgICAgICAnZmFkZUluJywgCiAgICAgICAgJ2ZhZGVPdXQnLCAKICAgICAgICAnZmFkZVRvZ2dsZScvKiwgJ29uJywgJ29mZicsICdvbmUnKi8gCiAgICBdOwogICAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnRzKGV2ZW50cywgbmFtZXNwYWNlKSB7CiAgICAgICAgaWYoIW5hbWVzcGFjZSkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRzOwogICAgICAgIH0KICAgICAgICBpZihpc09iamVjdChldmVudHMpKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBuZXcgb2JqZWN0LCBzbyB0aGF0IG9yaWdpbmFsIG9iamVjdCB3aWxsIG5vdCBiZSBtb2RpZmllZCB3aGVuIGJpbmRpbmcuCiAgICAgICAgICAgIGV2ZW50cyA9IGV4dGVuZCh7CiAgICAgICAgICAgIH0sIGV2ZW50cyk7CiAgICAgICAgICAgIGZvcih2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgICAgICAgICAgaWYoa2V5LmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBldmVudHNba2V5ICsgbmFtZXNwYWNlXSA9IGV2ZW50c1trZXldOwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXZlbnRzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmKCFldmVudHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuYW1lc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KCcgJyk7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBldmVudHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZ0ID0gZXZlbnRzW2ldOwogICAgICAgICAgICAgICAgaWYoZXZ0LmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBldmVudHNbaV0gPSBldnQgKyBuYW1lc3BhY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50cy5qb2luKCcgJyk7CiAgICAgICAgfQogICAgfQogICAgLyoKICAgIENsb25lIGpxdWVyeQogICAgUmVtb3ZlIGFsbCBleGNlc3MgbWV0aG9kcyB3ZSBkb24ndCB3YW50IHRvIGV4cG9zZSBuYXRpdmVseS4KICAgIG92ZXJybG9hZCBhbnkgbWV0aG9kcyB3ZSB3YW50IHRvIGNoYW5nZSBiZWhhdmlvciBvZiAobm90ZWFibHkgb24sIG9uZSwgYW5kIG9mZikKICAgIAogICAgSW5zdGVhZCBvZiBkdXBsaWNhdGluZyB0aGUganF1ZXJ5IGJlaGF2aW9yIHdlIGluc3RlYWQgcmVhbGlnbiBpdCB0byBvdXIgb3duLgogICAgKi8KICAgIC8vIGpRdWVyeSBzdWIKICAgIGZ1bmN0aW9uIHN1YkpRdWVyeSgpIHsKICAgICAgICB2YXIgdFF1ZXJ5ID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyB0UXVlcnkucHJvdG90eXBlLmluaXQoc2VsZWN0b3IsIGNvbnRleHQsIG5hbWVzcGFjZSB8fCAodGhpcyAmJiB0aGlzLm5hbWVzcGFjZSkpOwogICAgICAgIH07CiAgICAgICAgXy5tZXJnZSh0UXVlcnksIGpRdWVyeSk7CiAgICAgICAgLy8gRG8gbm90IGxpa2UKICAgICAgICAvLyBwcm9iYWJseSBuZWVkZWQgaW4gc29tZSBzcGVjaWFsIHVuaXF1ZSBjYXNlcwogICAgICAgIHRRdWVyeS5qUXVlcnkgPSBqUXVlcnk7CiAgICAgICAgLy8gZXhwb3NlIGV2ZW50cyBmb3IgZG9pbmcgc3BlY2lhbCBldmVudHMgYXMgcmVxdWlyZWQuCiAgICAgICAgdFF1ZXJ5LmV2ZW50ID0gKGpRdWVyeSkuZXZlbnQ7CiAgICAgICAgdFF1ZXJ5LmZuID0gdFF1ZXJ5LnByb3RvdHlwZSA9IGV4dGVuZCh7CiAgICAgICAgfSwgalF1ZXJ5LmZuKTsKICAgICAgICB0UXVlcnkuZm4uY29uc3RydWN0b3IgPSB0UXVlcnk7CiAgICAgICAgdFF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiBpbml0KHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgdmFyIGlvRG9tID0gY29udGV4dCBpbnN0YW5jZW9mIHRRdWVyeTsKICAgICAgICAgICAgaWYoY29udGV4dCAmJiBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ICYmICEoaW9Eb20pKSB7CiAgICAgICAgICAgICAgICBjb250ZXh0ID0gdFF1ZXJ5KGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBqUXVlcnkuZm4uaW5pdC5jYWxsKHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCB0UXVlcnlSb290KTsKICAgICAgICAgICAgaWYobmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICByZXN1bHQubmFtZXNwYWNlID0gbmFtZXNwYWNlOwogICAgICAgICAgICB9IGVsc2UgaWYoaW9Eb20pIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5uYW1lc3BhY2UgPSBjb250ZXh0Lm5hbWVzcGFjZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CiAgICAgICAgdFF1ZXJ5LmZuLmluaXQucHJvdG90eXBlID0gdFF1ZXJ5LmZuOwogICAgICAgIHZhciB0UXVlcnlSb290ID0gdFF1ZXJ5KGRvY3VtZW50KTsKICAgICAgICAvLyByZW1vdmUgYWxsIG5vdCBhcHBsaWNhYmxlIG1ldGhvZHMgb2ZmIG9mIGZuLgogICAgICAgIGVhY2goalF1ZXJ5Rm5NZXRob2RCbGFja0xpc3QsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIGlmKHRRdWVyeS5mblt4XSkgewogICAgICAgICAgICAgICAgdFF1ZXJ5LmZuW3hdID0gbnVsbDsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0UXVlcnkuZm5beF07CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBfLmVhY2goWwogICAgICAgICAgICAnb24nLCAKICAgICAgICAgICAgJ29uZScsIAogICAgICAgICAgICAnb2ZmJwogICAgICAgIF0sIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHRRdWVyeS5mblt4XSA9IF8ud3JhcCh0UXVlcnkuZm5beF0sIGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgndFF1ZXJ5W3swfV06IEJpbmRpbmcgJyArIHggKyAnIGV2ZW50cy4uLicsIHRoaXMubmFtZXNwYWNlKSk7CiAgICAgICAgICAgICAgICBhcmdzWzBdID0gbm9ybWFsaXplRXZlbnRzKGFyZ3NbMF0sIHRoaXMubmFtZXNwYWNlKTsKICAgICAgICAgICAgICAgIHJldHVybiBmLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICB0UXVlcnkuZm4ucXVlcnkgPSB0UXVlcnkuZm4uJCA9IHRRdWVyeS5mbi5maW5kOwogICAgICAgIHJldHVybiB0UXVlcnk7CiAgICB9CiAgICBleHBvcnRzLnRRdWVyeSA9IHN1YkpRdWVyeSgpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdWJqcXVlcnkuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYWN0aW9uJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuLi9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2FjdGlvbi5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyICQgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBBQ1RJT05TID0gJ2NvbmZpZy5kb20uYWN0aW9ucycsIEFDVElPTlNTSU5HTEUgPSAnYWN0aW9ucycsIFNUUklORyA9ICdzdHJpbmcnLCBSRUdJU1RSQVRJT05TID0gJ19yZWdpc3RyYXRpb25zJywgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNTdHJpbmcgPSBfLmlzU3RyaW5nLCBpc0FycmF5ID0gXy5pc0FycmF5OwogICAgdmFyIGdldEFjdGlvbkF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgICAgICByZXR1cm4gJ2RhdGEtYWN0aW9uLScgKyBldmVudE5hbWU7CiAgICB9OwogICAgdmFyIEFjdGlvbkhhbmRsZXIgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEFjdGlvbkhhbmRsZXIoKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gewogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBBY3Rpb25IYW5kbGVyLnByb3RvdHlwZS5yZWdpc3RlciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGFjdGlvbk5hbWUsIGFjdGlvbikgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gdGhpcy5ldmVudHM7CiAgICAgICAgICAgIGlmKCFldmVudHNbZXZlbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV0gPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFldmVudHNbZXZlbnROYW1lXVthY3Rpb25OYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0gPSBhY3Rpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdUaGUgYWN0aW9uIHsxfSBoYW5kbGVyICJ7MH0iIGhhcyBhbHJlYWR5IGJlZW4gdGFrZW4hJywgYWN0aW9uTmFtZSwgZXZlbnROYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIEFjdGlvbkhhbmRsZXIucHJvdG90eXBlLnVucmVnaXN0ZXIgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBhY3Rpb25OYW1lKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50czsKICAgICAgICAgICAgaWYoZXZlbnRzW2V2ZW50TmFtZV0gJiYgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0pIHsKICAgICAgICAgICAgICAgIGV2ZW50c1tldmVudE5hbWVdW2FjdGlvbk5hbWVdID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5wcm90b3R5cGUuY2FsbGJhY2tGb3IgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCByZXR1cm5SZXN1bHRzKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50cywgYWN0aW9uQXR0cmlidXRlID0gZ2V0QWN0aW9uQXR0cmlidXRlKGV2ZW50TmFtZSksIHJldHVyblJlc3VsdHNEZWZpbmVkID0gdHlwZW9mIHJldHVyblJlc3VsdHMgIT09ICd1bmRlZmluZWQnOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZVZhbHVlID0gJCh0aGlzKS5hdHRyKGFjdGlvbkF0dHJpYnV0ZSk7CiAgICAgICAgICAgICAgICBpZih0eXBlb2YgYXR0cmlidXRlVmFsdWUgPT09IFNUUklORykgewogICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSBldmVudHNbZXZlbnROYW1lXVthdHRyaWJ1dGVWYWx1ZV07CiAgICAgICAgICAgICAgICAgICAgaWYoYWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbi5oYW5kbGVyLmFwcGx5KGFjdGlvbi5jb250ZXh0IHx8IHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmKHJldHVyblJlc3VsdHNEZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5SZXN1bHRzOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBBY3Rpb25IYW5kbGVyLmFjdGlvbkhhbmRsZXJzID0gewogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5nZXRGb3IgPSBmdW5jdGlvbiBnZXRGb3IobmFtZSkgewogICAgICAgICAgICBpZih0aGlzLmFjdGlvbkhhbmRsZXJzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hY3Rpb25IYW5kbGVyc1tuYW1lXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKHRoaXMuYWN0aW9uSGFuZGxlcnNbbmFtZV0gPSBuZXcgQWN0aW9uSGFuZGxlcigpKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBBY3Rpb25IYW5kbGVyOwogICAgfSkoKTsgICAgCiAgICB2YXIgZXZlbnRzID0gewogICAgICAgIGNsaWNrOiBbCiAgICAgICAgICAgICdhJywgCiAgICAgICAgICAgICdidXR0b24nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9ImJ1dHRvbiJdJywgCiAgICAgICAgICAgICdpbnB1dFt0eXBlPSJzdWJtaXQiXScKICAgICAgICBdLAogICAgICAgIGRibGNsaWNrOiBbCiAgICAgICAgICAgICdhJywgCiAgICAgICAgICAgICdidXR0b24nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9ImJ1dHRvbiJdJywgCiAgICAgICAgICAgICdpbnB1dFt0eXBlPSJzdWJtaXQiXScKICAgICAgICBdLAogICAgICAgIG1vdXNlZW50ZXI6IFsKICAgICAgICAgICAgJycKICAgICAgICBdLAogICAgICAgIG1vdXNlbGVhdmU6IFsKICAgICAgICAgICAgJycKICAgICAgICBdLAogICAgICAgIGZvY3VzOiBbCiAgICAgICAgICAgICdpbnB1dCcKICAgICAgICBdLAogICAgICAgIGJsdXI6IFsKICAgICAgICAgICAgJ2lucHV0JwogICAgICAgIF0KICAgIH07CiAgICB2YXIgYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdoYW5kbGVyJywgCiAgICAgICAgJ2NvbnRleHQnCiAgICBdOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBBQ1RJT05TCiAgICAgICAgXSwKICAgICAgICBpZ25pdGU6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdmFyIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcih0aHJ1c3QubmFtZSk7CiAgICAgICAgICAgIHRocnVzdC5kb20uYWN0aW9uSGFuZGxlciA9IGFjdGlvbkhhbmRsZXI7CiAgICAgICAgICAgIHZhciAkYm9keSA9ICQod2luZG93LmRvY3VtZW50LmJvZHkpOwogICAgICAgICAgICBfLmVhY2goZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRTZWxlY3RvcnMsIGV2ZW50TmFtZSkgewogICAgICAgICAgICAgICAgLy8gdXNpbmcgdGhydXN0IG5hbWUsIGFzIGNhbGxiYWNrIG5lZWRzIHRvIGJlIHBlciB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICAgICAgICAgIC8vIGluIHRoZSBldmVudCBvZiBtdWx0aXBsZSB0aHJ1c3QgaW5zdGFuY2VzLgogICAgICAgICAgICAgICAgJGJvZHkub24oZXZlbnROYW1lICsgJy4nICsgQUNUSU9OU1NJTkdMRSArIHRocnVzdC5uYW1lLCBldmVudFNlbGVjdG9ycy5qb2luKGdldEFjdGlvbkF0dHJpYnV0ZShldmVudE5hbWUpICsgJywgJyksIGFjdGlvbkhhbmRsZXIuY2FsbGJhY2tGb3IoZXZlbnROYW1lLCB0cnVlKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgZGVvcmJpdDogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgYWN0aW9uSGFuZGxlciA9IEFjdGlvbkhhbmRsZXIuZ2V0Rm9yKHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgdmFyICRib2R5ID0gJCh3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgICAgICAgIF8uZWFjaChldmVudHMsIGZ1bmN0aW9uIChldmVudFNlbGVjdG9ycywgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAkYm9keS5vZmYoJy4nICsgQUNUSU9OU1NJTkdMRSArIHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gbW9kLmNvbnZlbnRpb24oQUNUSU9OUyksIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcihtb2QudGhydXN0Lm5hbWUpLCBkb20gPSBmYWNhZGUsIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICBfLmZvck93bihhY3Rpb25zLCBmdW5jdGlvbiAoYWN0aW9uQ29sbGVjdGlvbiwgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoIWlzQXJyYXkoYWN0aW9uQ29sbGVjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkNvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoYWN0aW9uQ29sbGVjdGlvbi5sZW5ndGggJiYgKCFpc0FycmF5KGFjdGlvbkNvbGxlY3Rpb25bMF0pIHx8IGlzU3RyaW5nKGFjdGlvbkNvbGxlY3Rpb25bMF0pKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Db2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBfLmVhY2goYWN0aW9uQ29sbGVjdGlvbiwgZnVuY3Rpb24gKGFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KGFjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdBY3Rpb24gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGFycmF5U2hvcnRIYW5kQXJnc0luT3JkZXIsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeCA9PT0gJ2hhbmRsZXInICYmIGlzU3RyaW5nKGFjdGlvbltpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uW2ldID0gbW9kLmluc3RhbmNlW2FjdGlvbltpXV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0FjdGlvblt4XSA9IGFjdGlvbltpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb25OYW1lID0gYWN0aW9uLm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFhY3Rpb24uaGFuZGxlciAmJiBhY3Rpb24ubW9kdWxlSGFuZGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uLmhhbmRsZXIgPSBtb2QuaW5zdGFuY2VbYWN0aW9uLm1vZHVsZUhhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoIWFjdGlvbi5oYW5kbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ011c3QgZGVmaW5lIGVpdGhlciBhIGhhbmRsZXIgb3IgbW9kdWxlIGhhbmRsZXIuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uSGFuZGxlci5yZWdpc3RlcihldmVudE5hbWUsIGFjdGlvbk5hbWUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gbW9kLmNvbnZlbnRpb24oQUNUSU9OUyksIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcihtb2QudGhydXN0Lm5hbWUpLCBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgaWYoYWN0aW9ucykgewogICAgICAgICAgICAgICAgZm9yKHZhciBhY3Rpb25FdmVudCBpbiBhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbkNvbGxlY3Rpb24gPSBhY3Rpb25zW2FjdGlvbkV2ZW50XTsKICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGFjdGlvbk5hbWUgaW4gYWN0aW9uQ29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25IYW5kbGVyLnVucmVnaXN0ZXIoYWN0aW9uRXZlbnQsIGFjdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmFjdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hY3Rpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYW5pbWF0ZS5jb250YWluZXInLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vY29udmVudGlvbi9jb250ZXh0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgYW55Q29udGFpbmVyOiAndGhydXN0LWNvbnZlbnRpb24tY29udGFpbmVyLWFueScsCiAgICAgICAgY2hhbmdlQ29udGFpbmVyOiAndGhydXN0LWNvbnZlbnRpb24tY29udGFpbmVyLWNoYW5nZScKICAgIH0sIGFueSA9IF8uYW55LCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQsIFNUQVJUID0gJ3N0YXJ0LXN0YXR1cycsIEFOSU1BVEUgPSAnYW5pbWF0ZScsIENPTlRBSU5FUiA9ICdjb250YWluZXInLCBDT05URVhUID0gJ2NvbnRleHQnOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBBTklNQVRFCiAgICAgICAgXSwKICAgICAgICBpbml0OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBtZWRpYXRvciA9IG1vZC5pbnN0YW5jZS5tZWRpYXRvcjsKICAgICAgICAgICAgbWVkaWF0b3Iuc3Vic2NyaWJlKGV2ZW50LmNoYW5nZUNvbnRhaW5lciwgYmluZCh0aGF0LmNoYW5nZSwgdGhhdCwgbW9kKSk7CiAgICAgICAgfSwKICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uIChtb2R1bGUsIGNvbnRhaW5lcikgewogICAgICAgICAgICBpZihtb2R1bGUuY29udmVudGlvbihDT05UQUlORVIpID09PSBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGlmKG1vZHVsZS5jb252ZW50aW9uKFNUQVJUKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBhbmltYXRlID0gbW9kdWxlLmNvbnZlbnRpb24oQU5JTUFURSk7CiAgICAgICAgICAgICAgICAgICAgaWYoYW5pbWF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGV4dE5vZGUgPSBtb2R1bGUuaW5zdGFuY2UuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHROb2RlLnJlbW92ZUNsYXNzKGFuaW1hdGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGFuaW1hdGUgPSBtb2QuY29udmVudGlvbihBTklNQVRFKSwgY29udGFpbmVyID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKSwgY29udGV4dCA9IG1vZC5jb252ZW50aW9uKENPTlRFWFQpLCBkb20gPSBmYWNhZGU7CiAgICAgICAgICAgIGlmKGFuaW1hdGUgJiYgY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSBkb20uY29udGV4dC5jbG9uZSgpLmFwcGVuZFRvKGRvbS5jb250ZXh0LnBhcmVudCgpKTsKICAgICAgICAgICAgICAgIGNsb25lLmFkZENsYXNzKGFuaW1hdGUucmVwbGFjZSgvXC4vZywgJyAnKS50cmltKCkpOwogICAgICAgICAgICAgICAgbW9kLmluc3RhbmNlLmRvbSA9IG1vZC5pbnN0YW5jZS4kID0gY2xvbmU7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGJpbmQodGhhdC5jbGVhbnVwLCB0aGF0LCBkb20uY29udGV4dC5wYXJlbnQoKSwgYW5pbWF0ZSwgY29udGV4dCksIDIwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjbGVhbnVwOiBmdW5jdGlvbiAoY29udGFpbmVyLCBhbmltYXRlLCBjb250ZXh0KSB7CiAgICAgICAgICAgIGNvbnRhaW5lci5maW5kKGNvbnRleHQpLmZpbHRlcignOm5vdCgnICsgYW5pbWF0ZSArICcpJykucmVtb3ZlKCk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuYW5pbWF0ZUNvbnRhaW5lciA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hbmltYXRlLmNvbnRhaW5lci5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vY29udmVudGlvbi9jb250ZXh0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuLi9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2NvbnRleHQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBzdWJqcXVlcnkgPSBfX3N1YmpxdWVyeV9fOwoKICAgIHZhciB0UXVlcnkgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIENPTlRFWFQgPSAnY29uZmlnLmRvbS5jb250ZXh0JzsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgQ09OVEVYVAogICAgICAgIF0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgY29udGV4dCA9IG1vZC5jb252ZW50aW9uKENPTlRFWFQpOwogICAgICAgICAgICBpZihjb250ZXh0KSB7CiAgICAgICAgICAgICAgICBtb2QuaW5zdGFuY2UuZG9tID0gbW9kLmluc3RhbmNlLiQgPSB0UXVlcnkoY29udGV4dCwgZmFjYWRlLmNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuY29udGV4dCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb250ZXh0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2NvbnZlbnRpb24vZXZlbnQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBDT05URVhUID0gJ2NvbmZpZy5kb20uY29udGV4dCcsIEVWRU5UUyA9ICdjb25maWcuZG9tLmV2ZW50cycsIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIGlzU3RyaW5nID0gXy5pc1N0cmluZywgaXNBcnJheSA9IF8uaXNBcnJheTsKICAgIHZhciBldmVudFByb3BlcnR5TG9hZE9yZGVyID0gWwogICAgICAgICdzZWxlY3RvcicsIAogICAgICAgICdkYXRhJywgCiAgICAgICAgJ2hhbmRsZXInCiAgICBdOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBFVkVOVFMKICAgICAgICBdLAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IG1vZC5jb252ZW50aW9uKEVWRU5UUyksICRjb250ZXh0ID0gZmFjYWRlLmNvbnRleHQsIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihldmVudHMpIHsKICAgICAgICAgICAgICAgIF8uZm9ySW4oZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRzQ29sbGVjdGlvbiwgZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvL3ZhciBldmVudHNDb2xsZWN0aW9uID0gZXZlbnRzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBpZighaXNBcnJheShldmVudHNDb2xsZWN0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihldmVudHNDb2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoZXZlbnRzQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoZXZlbnRzQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c0NvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF8uZWFjaChldmVudHNDb2xsZWN0aW9uLCBmdW5jdGlvbiAoZGVmaW5pdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZEV2ZW50ID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNBcnJheShkZWZpbml0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZEV2ZW50LnB1c2guYXBwbHkoYmluZEV2ZW50LCBkZWZpbml0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGhhdmUgb25lIGVkZ2VjYXNlIGhlcmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBzaG9ydCBoYW5kIGFycmF5LCBoYXMgYSBjb250ZXh0IHRoYXQgaXMgYSBzdHJpbmcgb3IgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBpdCBkb2VzbnQgaGF2ZSBpbmZvcm1hdGlvbiBmb3IgYm90aCBzZWxlY3RvciBhbmQgZGF0YSwgdGhpcyB3aWxsIGZhaWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGNhbiByZWNvdmVyIHdoZW4gYWxsIDUgcG9zc2libGUgaXRlbXMgYXJlIGRlZmluZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlciA9IGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSB3ZXJlIGFza2VkIGZvciBhIG1ldGhvZCBvbiB0aGUgbW9kdWxlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcoaGFuZGxlcikgJiYgYmluZEV2ZW50Lmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV0gPSBtb2QuaW5zdGFuY2VbaGFuZGxlcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgLy8gV2UgZGlkbnQgZmluZCBhIGZ1bmN0aW9uIDooCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgRURHRSBDQVNFOiBJZiBjb250ZXh0IGlzIGEgZnVuY3Rpb24sIHdlIHdpbGwgYXNzdW1lIGFsbCBpcyB3ZWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAgRXZlbiBpZiB0aGUgaGFuZGxlciBpcyBhIHN0cmluZyB0aGF0IG5lZWRzIHRvIGJlIHJlZmVyZW5jZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXb3JrIGFycm91bmRzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICBTaG9ydGhhbmQ6IGFkZCBudWxsL2VtcHR5IHZhbHVlcyBmb3Igc2VsZWN0b3IgYW5kIGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgTG9uZ2hhbmQ6IHN3aXRjaCB0byBsb25nIGhhbmQgYXMgaXQgaGFzIG1vcmUgZXhwbGljaXQgc3ludGF4LgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWlzU3RyaW5nKGhhbmRsZXIpICYmICFpc0Z1bmN0aW9uKGhhbmRsZXIpICYmIGJpbmRFdmVudC5sZW5ndGggPiAyIHx8IGJpbmRFdmVudC5sZW5ndGggPT09IDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gYmluZEV2ZW50W2JpbmRFdmVudC5sZW5ndGggLSAyXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1N0cmluZyhoYW5kbGVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdID0gbW9kLmluc3RhbmNlW2hhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdID0gXy5iaW5kKGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMl0sIGJpbmRFdmVudC5wb3AoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNTdHJpbmcoaGFuZGxlcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDFdID0gbW9kLmluc3RhbmNlW2hhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGV2ZW50UHJvcGVydHlMb2FkT3JkZXIsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZGVmaW5pdGlvblt4XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBkZWZpbml0aW9uW3hdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih4ID09PSAnaGFuZGxlcicgJiYgZGVmaW5pdGlvbi5jb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IF8uYmluZCh2YWx1ZSwgZGVmaW5pdGlvbi5jb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FsbCB0aGUgb24gbWV0aG9kLCB3aXRoIG91ciBhcmd1bWVudHMuCiAgICAgICAgICAgICAgICAgICAgICAgICRjb250ZXh0Lm9uLmFwcGx5KCRjb250ZXh0LCBiaW5kRXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gbW9kLmNvbnZlbnRpb24oRVZFTlRTKSwgJGNvbnRleHQgPSBmYWNhZGUuY29udGV4dDsKICAgICAgICAgICAgaWYoJGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICRjb250ZXh0Lm9mZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuZXZlbnQgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZXZlbnQuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC50ZW1wbGF0ZQogICAgQHN1Ym1vZHVsZSB0aHJ1c3QudGVtcGxhdGUuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ2NmZycsIAogICAgICAgICdkYXRhJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L3RlbXBsYXRlLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi90ZW1wbGF0ZScsIAogICAgICAgICd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi9rbm9ja291dC5lbmdpbmUnCiAgICBdOwogICAgLyoqCiAgICBNYXBzIHRoZSBhdmFpbGFibGUgdGVtcGxhdGVzLCB0byB0aGVpciBhcHByb3ByaWF0ZSBtb2R1bGUgbmFtZS4KICAgIAogICAgKipwcmVjb21waWxlZCBpcyBhIHNwZWNpYWwgY2FzZSwgYW5kIHRob3NlIG1ldGhvZHMgYXJlIGV4cGVjdGVkIHRvIGJlIGNvZGUgYnVpbHQgZnVuY3Rpb25zLgogICAgCiAgICBAcHJvcGVydHkgdHlwZXMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy50eXBlcyA9IHsKICAgICAgICAnZG9UJzogJ2RvVCcsCiAgICAgICAgJ3ByZWNvbXBpbGVkJzogdHJ1ZQogICAgfTsKICAgIC8qKgogICAgTWFwcyB0aGUgdGVtcGxhdGUgZXZhbHVhdG9ycywgc28gdGhhdCB3aGVuIGNyZWF0aW5nIGEgdGVtcGxhdGUgZm9yIGtub2Nrb3V0LCBpdCBrbm93cyBob3cgdG8gcHJvcGVybHkgb3V0cHV0IHRoZSBpbmZvcm1hdGlvbi4KICAgIAogICAgQHByb3BlcnR5IGV2YWx1YXRvcnMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy5ldmFsdWF0b3JzID0gewogICAgICAgICdkb1QnOiB7CiAgICAgICAgICAgIGxlZnQ6ICd7ez0gJywKICAgICAgICAgICAgcmlnaHQ6ICd9fScKICAgICAgICB9CiAgICB9OwogICAgLyoqCiAgICBUaGUgZGVmYXVsdCB0ZW1wbGF0ZSB0eXBlLCB1c2VkIHdoZW4gZXh0ZW5zaW9uIGlzbid0IGdpdmVuLgogICAgCiAgICBAcHJvcGVydHkgZGVmYXVsdFR5cGUKICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgIEBkZWZhdWx0ICdkb1QnCiAgICAqKi8KICAgIGV4cG9ydHMuZGVmYXVsdFR5cGUgPSAnZG9UJzsKICAgIC8qKgogICAgVGhlIGJhc2UgbG9jYXRpb24sIHJlbGF0aXZlIHRvIHRoZSBhcHBsaWNhdGlvbiBwYXRoIGZvciB0ZW1wbGF0ZSBsb2NhdGlvbi4KICAgIElmIHRlbXBsYXRlIHBhdGhzIGFyZSBnaXZlbiByZWxhdGl2ZSB0byBhcHBsaWNhdGlvbiBwYXRoLCB0aGlzIGNhbiBiZSBsZWZ0IGVtcHR5LgogICAgCiAgICBAcHJvcGVydHkgYmFzZVVybAogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQgJycKICAgICoqLwogICAgZXhwb3J0cy5iYXNlVXJsID0gJyc7CiAgICAvKioKICAgIERlZmluZXMgdGhlIGV4dGVuc2lvbiB1c2VkIGZvciB0ZW1wbGF0ZXMgc3RvcmVkIG9uIHRoZSBzZXJ2ZXIuCiAgICAKICAgIEBwcm9wZXJ0eSBleHRlbnNpb24KICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgIEBkZWZhdWx0ICcudG1wbCcKICAgICoqLwogICAgZXhwb3J0cy5leHRlbnNpb24gPSAnLnRtcGwnOwogICAgLyoqCiAgICBEZWZpbmVzIHRoZSBBTUQgcGF0aHMgdG8gZmluZCB0aGUgZ2l2ZW4gdGVtcGxhdGUgdHlwZQogICAgCiAgICBAcHJvcGVydHkgdGVtcGxhdGVQYXRocwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQge30KICAgICoqLwogICAgZXhwb3J0cy50ZW1wbGF0ZVBhdGhzID0gewogICAgICAgICdkb1QnOiAnZG9UJwogICAgfTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7Ci8vIEtub2Nrb3V0IEphdmFTY3JpcHQgbGlicmFyeSB2Mi4yLjAKLy8gKGMpIFN0ZXZlbiBTYW5kZXJzb24gLSBodHRwOi8va25vY2tvdXRqcy5jb20vCi8vIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgooZnVuY3Rpb24oKXsKdmFyIERFQlVHPXRydWU7CihmdW5jdGlvbih3aW5kb3csZG9jdW1lbnQsbmF2aWdhdG9yLGpRdWVyeSx1bmRlZmluZWQpewohZnVuY3Rpb24oZmFjdG9yeSkgewogICAgLy8gU3VwcG9ydCB0aHJlZSBtb2R1bGUgbG9hZGluZyBzY2VuYXJpb3MKICAgIGlmICh0eXBlb2YgcmVxdWlyZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAvLyBbMV0gQ29tbW9uSlMvTm9kZS5qcwogICAgICAgIHZhciB0YXJnZXQgPSBtb2R1bGVbJ2V4cG9ydHMnXSB8fCBleHBvcnRzOyAvLyBtb2R1bGUuZXhwb3J0cyBpcyBmb3IgTm9kZS5qcwogICAgICAgIGZhY3RvcnkodGFyZ2V0KTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmVbJ2FtZCddKSB7CiAgICAgICAgLy8gWzJdIEFNRCBhbm9ueW1vdXMgbW9kdWxlCiAgICAgICAgZGVmaW5lKCdrbm9ja291dCcsWydleHBvcnRzJ10sIGZhY3RvcnkpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBbM10gTm8gbW9kdWxlIGxvYWRlciAocGxhaW4gPHNjcmlwdD4gdGFnKSAtIHB1dCBkaXJlY3RseSBpbiBnbG9iYWwgbmFtZXNwYWNlCiAgICAgICAgZmFjdG9yeSh3aW5kb3dbJ2tvJ10gPSB7fSk7CiAgICB9Cn0oZnVuY3Rpb24oa29FeHBvcnRzKXsKLy8gSW50ZXJuYWxseSwgYWxsIEtPIG9iamVjdHMgYXJlIGF0dGFjaGVkIHRvIGtvRXhwb3J0cyAoZXZlbiB0aGUgbm9uLWV4cG9ydGVkIG9uZXMgd2hvc2UgbmFtZXMgd2lsbCBiZSBtaW5pZmllZCBieSB0aGUgY2xvc3VyZSBjb21waWxlcikuCi8vIEluIHRoZSBmdXR1cmUsIHRoZSBmb2xsb3dpbmcgImtvIiB2YXJpYWJsZSBtYXkgYmUgbWFkZSBkaXN0aW5jdCBmcm9tICJrb0V4cG9ydHMiIHNvIHRoYXQgcHJpdmF0ZSBvYmplY3RzIGFyZSBub3QgZXh0ZXJuYWxseSByZWFjaGFibGUuCnZhciBrbyA9IHR5cGVvZiBrb0V4cG9ydHMgIT09ICd1bmRlZmluZWQnID8ga29FeHBvcnRzIDoge307Ci8vIEdvb2dsZSBDbG9zdXJlIENvbXBpbGVyIGhlbHBlcnMgKHVzZWQgb25seSB0byBtYWtlIHRoZSBtaW5pZmllZCBmaWxlIHNtYWxsZXIpCmtvLmV4cG9ydFN5bWJvbCA9IGZ1bmN0aW9uKGtvUGF0aCwgb2JqZWN0KSB7Cgl2YXIgdG9rZW5zID0ga29QYXRoLnNwbGl0KCIuIik7CgoJLy8gSW4gdGhlIGZ1dHVyZSwgImtvIiBtYXkgYmVjb21lIGRpc3RpbmN0IGZyb20gImtvRXhwb3J0cyIgKHNvIHRoYXQgbm9uLWV4cG9ydGVkIG9iamVjdHMgYXJlIG5vdCByZWFjaGFibGUpCgkvLyBBdCB0aGF0IHBvaW50LCAidGFyZ2V0IiB3b3VsZCBiZSBzZXQgdG86ICh0eXBlb2Yga29FeHBvcnRzICE9PSAidW5kZWZpbmVkIiA/IGtvRXhwb3J0cyA6IGtvKQoJdmFyIHRhcmdldCA9IGtvOwoKCWZvciAodmFyIGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aCAtIDE7IGkrKykKCQl0YXJnZXQgPSB0YXJnZXRbdG9rZW5zW2ldXTsKCXRhcmdldFt0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdXSA9IG9iamVjdDsKfTsKa28uZXhwb3J0UHJvcGVydHkgPSBmdW5jdGlvbihvd25lciwgcHVibGljTmFtZSwgb2JqZWN0KSB7CiAgb3duZXJbcHVibGljTmFtZV0gPSBvYmplY3Q7Cn07CmtvLnZlcnNpb24gPSAiMi4yLjAiOwoKa28uZXhwb3J0U3ltYm9sKCd2ZXJzaW9uJywga28udmVyc2lvbik7CmtvLnV0aWxzID0gbmV3IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgc3RyaW5nVHJpbVJlZ2V4ID0gL14oXHN8XHUwMEEwKSt8KFxzfFx1MDBBMCkrJC9nOwoKICAgIC8vIFJlcHJlc2VudCB0aGUga25vd24gZXZlbnQgdHlwZXMgaW4gYSBjb21wYWN0IHdheSwgdGhlbiBhdCBydW50aW1lIHRyYW5zZm9ybSBpdCBpbnRvIGEgaGFzaCB3aXRoIGV2ZW50IG5hbWUgYXMga2V5IChmb3IgZmFzdCBsb29rdXApCiAgICB2YXIga25vd25FdmVudHMgPSB7fSwga25vd25FdmVudFR5cGVzQnlFdmVudE5hbWUgPSB7fTsKICAgIHZhciBrZXlFdmVudFR5cGVOYW1lID0gL0ZpcmVmb3hcLzIvaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpID8gJ0tleWJvYXJkRXZlbnQnIDogJ1VJRXZlbnRzJzsKICAgIGtub3duRXZlbnRzW2tleUV2ZW50VHlwZU5hbWVdID0gWydrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJ107CiAgICBrbm93bkV2ZW50c1snTW91c2VFdmVudHMnXSA9IFsnY2xpY2snLCAnZGJsY2xpY2snLCAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsICdtb3VzZWVudGVyJywgJ21vdXNlbGVhdmUnXTsKICAgIGZvciAodmFyIGV2ZW50VHlwZSBpbiBrbm93bkV2ZW50cykgewogICAgICAgIHZhciBrbm93bkV2ZW50c0ZvclR5cGUgPSBrbm93bkV2ZW50c1tldmVudFR5cGVdOwogICAgICAgIGlmIChrbm93bkV2ZW50c0ZvclR5cGUubGVuZ3RoKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0ga25vd25FdmVudHNGb3JUeXBlLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIGtub3duRXZlbnRUeXBlc0J5RXZlbnROYW1lW2tub3duRXZlbnRzRm9yVHlwZVtpXV0gPSBldmVudFR5cGU7CiAgICAgICAgfQogICAgfQogICAgdmFyIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudCA9IHsgJ3Byb3BlcnR5Y2hhbmdlJzogdHJ1ZSB9OyAvLyBXb3JrYXJvdW5kIGZvciBhbiBJRTkgaXNzdWUgLSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzQwNgoKICAgIC8vIERldGVjdCBJRSB2ZXJzaW9ucyBmb3IgYnVnIHdvcmthcm91bmRzICh1c2VzIElFIGNvbmRpdGlvbmFscywgbm90IFVBIHN0cmluZywgZm9yIHJvYnVzdG5lc3MpCiAgICAvLyBOb3RlIHRoYXQsIHNpbmNlIElFIDEwIGRvZXMgbm90IHN1cHBvcnQgY29uZGl0aW9uYWwgY29tbWVudHMsIHRoZSBmb2xsb3dpbmcgbG9naWMgb25seSBkZXRlY3RzIElFIDwgMTAuCiAgICAvLyBDdXJyZW50bHkgdGhpcyBpcyBieSBkZXNpZ24sIHNpbmNlIElFIDEwKyBiZWhhdmVzIGNvcnJlY3RseSB3aGVuIHRyZWF0ZWQgYXMgYSBzdGFuZGFyZCBicm93c2VyLgogICAgLy8gSWYgdGhlcmUgaXMgYSBmdXR1cmUgbmVlZCB0byBkZXRlY3Qgc3BlY2lmaWMgdmVyc2lvbnMgb2YgSUUxMCssIHdlIHdpbGwgYW1lbmQgdGhpcy4KICAgIHZhciBpZVZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHZlcnNpb24gPSAzLCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgaUVsZW1zID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpJyk7CgogICAgICAgIC8vIEtlZXAgY29uc3RydWN0aW5nIGNvbmRpdGlvbmFsIEhUTUwgYmxvY2tzIHVudGlsIHdlIGhpdCBvbmUgdGhhdCByZXNvbHZlcyB0byBhbiBlbXB0eSBmcmFnbWVudAogICAgICAgIHdoaWxlICgKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8IS0tW2lmIGd0IElFICcgKyAoKyt2ZXJzaW9uKSArICddPjxpPjwvaT48IVtlbmRpZl0tLT4nLAogICAgICAgICAgICBpRWxlbXNbMF0KICAgICAgICApOwogICAgICAgIHJldHVybiB2ZXJzaW9uID4gNCA/IHZlcnNpb24gOiB1bmRlZmluZWQ7CiAgICB9KCkpOwogICAgdmFyIGlzSWU2ID0gaWVWZXJzaW9uID09PSA2LAogICAgICAgIGlzSWU3ID0gaWVWZXJzaW9uID09PSA3OwoKICAgIGZ1bmN0aW9uIGlzQ2xpY2tPbkNoZWNrYWJsZUVsZW1lbnQoZWxlbWVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgaWYgKChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT09ICJpbnB1dCIpIHx8ICFlbGVtZW50LnR5cGUpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoZXZlbnRUeXBlLnRvTG93ZXJDYXNlKCkgIT0gImNsaWNrIikgcmV0dXJuIGZhbHNlOwogICAgICAgIHZhciBpbnB1dFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgcmV0dXJuIChpbnB1dFR5cGUgPT0gImNoZWNrYm94IikgfHwgKGlucHV0VHlwZSA9PSAicmFkaW8iKTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICAgIGZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0OiBbJ2F1dGhlbnRpY2l0eV90b2tlbicsIC9eX19SZXF1ZXN0VmVyaWZpY2F0aW9uVG9rZW4oXy4qKT8kL10sCgogICAgICAgIGFycmF5Rm9yRWFjaDogZnVuY3Rpb24gKGFycmF5LCBhY3Rpb24pIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBhY3Rpb24oYXJyYXlbaV0pOwogICAgICAgIH0sCgogICAgICAgIGFycmF5SW5kZXhPZjogZnVuY3Rpb24gKGFycmF5LCBpdGVtKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGFycmF5LCBpdGVtKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9LAoKICAgICAgICBhcnJheUZpcnN0OiBmdW5jdGlvbiAoYXJyYXksIHByZWRpY2F0ZSwgcHJlZGljYXRlT3duZXIpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBpZiAocHJlZGljYXRlLmNhbGwocHJlZGljYXRlT3duZXIsIGFycmF5W2ldKSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXlbaV07CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCgogICAgICAgIGFycmF5UmVtb3ZlSXRlbTogZnVuY3Rpb24gKGFycmF5LCBpdGVtVG9SZW1vdmUpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGFycmF5LCBpdGVtVG9SZW1vdmUpOwogICAgICAgICAgICBpZiAoaW5kZXggPj0gMCkKICAgICAgICAgICAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfSwKCiAgICAgICAgYXJyYXlHZXREaXN0aW5jdFZhbHVlczogZnVuY3Rpb24gKGFycmF5KSB7CiAgICAgICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YocmVzdWx0LCBhcnJheVtpXSkgPCAwKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIGFycmF5TWFwOiBmdW5jdGlvbiAoYXJyYXksIG1hcHBpbmcpIHsKICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG1hcHBpbmcoYXJyYXlbaV0pKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBhcnJheUZpbHRlcjogZnVuY3Rpb24gKGFycmF5LCBwcmVkaWNhdGUpIHsKICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIGlmIChwcmVkaWNhdGUoYXJyYXlbaV0pKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBhcnJheVB1c2hBbGw6IGZ1bmN0aW9uIChhcnJheSwgdmFsdWVzVG9QdXNoKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZXNUb1B1c2ggaW5zdGFuY2VvZiBBcnJheSkKICAgICAgICAgICAgICAgIGFycmF5LnB1c2guYXBwbHkoYXJyYXksIHZhbHVlc1RvUHVzaCk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmFsdWVzVG9QdXNoLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlc1RvUHVzaFtpXSk7CiAgICAgICAgICAgIHJldHVybiBhcnJheTsKICAgICAgICB9LAoKICAgICAgICBleHRlbmQ6IGZ1bmN0aW9uICh0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgICAgICAgICBmb3IodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoc291cmNlLmhhc093blByb3BlcnR5KHByb3ApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9LAoKICAgICAgICBlbXB0eURvbU5vZGU6IGZ1bmN0aW9uIChkb21Ob2RlKSB7CiAgICAgICAgICAgIHdoaWxlIChkb21Ob2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIGtvLnJlbW92ZU5vZGUoZG9tTm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIG1vdmVDbGVhbmVkTm9kZXNUb0NvbnRhaW5lckVsZW1lbnQ6IGZ1bmN0aW9uKG5vZGVzKSB7CiAgICAgICAgICAgIC8vIEVuc3VyZSBpdCdzIGEgcmVhbCBhcnJheSwgYXMgd2UncmUgYWJvdXQgdG8gcmVwYXJlbnQgdGhlIG5vZGVzIGFuZAogICAgICAgICAgICAvLyB3ZSBkb24ndCB3YW50IHRoZSB1bmRlcmx5aW5nIGNvbGxlY3Rpb24gdG8gY2hhbmdlIHdoaWxlIHdlJ3JlIGRvaW5nIHRoYXQuCiAgICAgICAgICAgIHZhciBub2Rlc0FycmF5ID0ga28udXRpbHMubWFrZUFycmF5KG5vZGVzKTsKCiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBub2Rlc0FycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGtvLmNsZWFuTm9kZShub2Rlc0FycmF5W2ldKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjsKICAgICAgICB9LAoKICAgICAgICBjbG9uZU5vZGVzOiBmdW5jdGlvbiAobm9kZXNBcnJheSwgc2hvdWxkQ2xlYW5Ob2RlcykgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzQXJyYXkubGVuZ3RoLCBuZXdOb2Rlc0FycmF5ID0gW107IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjbG9uZWROb2RlID0gbm9kZXNBcnJheVtpXS5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgICAgICAgICBuZXdOb2Rlc0FycmF5LnB1c2goc2hvdWxkQ2xlYW5Ob2RlcyA/IGtvLmNsZWFuTm9kZShjbG9uZWROb2RlKSA6IGNsb25lZE5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdOb2Rlc0FycmF5OwogICAgICAgIH0sCgogICAgICAgIHNldERvbU5vZGVDaGlsZHJlbjogZnVuY3Rpb24gKGRvbU5vZGUsIGNoaWxkTm9kZXMpIHsKICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKGRvbU5vZGUpOwogICAgICAgICAgICBpZiAoY2hpbGROb2RlcykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBjaGlsZE5vZGVzLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBkb21Ob2RlLmFwcGVuZENoaWxkKGNoaWxkTm9kZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcmVwbGFjZURvbU5vZGVzOiBmdW5jdGlvbiAobm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5LCBuZXdOb2Rlc0FycmF5KSB7CiAgICAgICAgICAgIHZhciBub2Rlc1RvUmVwbGFjZUFycmF5ID0gbm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gW25vZGVUb1JlcGxhY2VPck5vZGVBcnJheV0gOiBub2RlVG9SZXBsYWNlT3JOb2RlQXJyYXk7CiAgICAgICAgICAgIGlmIChub2Rlc1RvUmVwbGFjZUFycmF5Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBpbnNlcnRpb25Qb2ludCA9IG5vZGVzVG9SZXBsYWNlQXJyYXlbMF07CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gaW5zZXJ0aW9uUG9pbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gbmV3Tm9kZXNBcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShuZXdOb2Rlc0FycmF5W2ldLCBpbnNlcnRpb25Qb2ludCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzVG9SZXBsYWNlQXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAga28ucmVtb3ZlTm9kZShub2Rlc1RvUmVwbGFjZUFycmF5W2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZTogZnVuY3Rpb24gKG9wdGlvbk5vZGUsIGlzU2VsZWN0ZWQpIHsKICAgICAgICAgICAgLy8gSUU2IHNvbWV0aW1lcyB0aHJvd3MgInVua25vd24gZXJyb3IiIGlmIHlvdSB0cnkgdG8gd3JpdGUgdG8gLnNlbGVjdGVkIGRpcmVjdGx5LCB3aGVyZWFzIEZpcmVmb3ggc3RydWdnbGVzIHdpdGggc2V0QXR0cmlidXRlLiBQaWNrIG9uZSBiYXNlZCBvbiBicm93c2VyLgogICAgICAgICAgICBpZiAoaWVWZXJzaW9uIDwgNykKICAgICAgICAgICAgICAgIG9wdGlvbk5vZGUuc2V0QXR0cmlidXRlKCJzZWxlY3RlZCIsIGlzU2VsZWN0ZWQpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBvcHRpb25Ob2RlLnNlbGVjdGVkID0gaXNTZWxlY3RlZDsKICAgICAgICB9LAoKICAgICAgICBzdHJpbmdUcmltOiBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiAoc3RyaW5nIHx8ICIiKS5yZXBsYWNlKHN0cmluZ1RyaW1SZWdleCwgIiIpOwogICAgICAgIH0sCgogICAgICAgIHN0cmluZ1Rva2VuaXplOiBmdW5jdGlvbiAoc3RyaW5nLCBkZWxpbWl0ZXIpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICB2YXIgdG9rZW5zID0gKHN0cmluZyB8fCAiIikuc3BsaXQoZGVsaW1pdGVyKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSB0b2tlbnMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdHJpbW1lZCA9IGtvLnV0aWxzLnN0cmluZ1RyaW0odG9rZW5zW2ldKTsKICAgICAgICAgICAgICAgIGlmICh0cmltbWVkICE9PSAiIikKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh0cmltbWVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIHN0cmluZ1N0YXJ0c1dpdGg6IGZ1bmN0aW9uIChzdHJpbmcsIHN0YXJ0c1dpdGgpIHsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nIHx8ICIiOwogICAgICAgICAgICBpZiAoc3RhcnRzV2l0aC5sZW5ndGggPiBzdHJpbmcubGVuZ3RoKQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnN1YnN0cmluZygwLCBzdGFydHNXaXRoLmxlbmd0aCkgPT09IHN0YXJ0c1dpdGg7CiAgICAgICAgfSwKCiAgICAgICAgZG9tTm9kZUlzQ29udGFpbmVkQnk6IGZ1bmN0aW9uIChub2RlLCBjb250YWluZWRCeU5vZGUpIHsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lZEJ5Tm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikKICAgICAgICAgICAgICAgIHJldHVybiAoY29udGFpbmVkQnlOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG5vZGUpICYgMTYpID09IDE2OwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZSA9PSBjb250YWluZWRCeU5vZGUpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICBkb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQ6IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBrby51dGlscy5kb21Ob2RlSXNDb250YWluZWRCeShub2RlLCBub2RlLm93bmVyRG9jdW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIHRhZ05hbWVMb3dlcjogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICAvLyBGb3IgSFRNTCBlbGVtZW50cywgdGFnTmFtZSB3aWxsIGFsd2F5cyBiZSB1cHBlciBjYXNlOyBmb3IgWEhUTUwgZWxlbWVudHMsIGl0J2xsIGJlIGxvd2VyIGNhc2UuCiAgICAgICAgICAgIC8vIFBvc3NpYmxlIGZ1dHVyZSBvcHRpbWl6YXRpb246IElmIHdlIGtub3cgaXQncyBhbiBlbGVtZW50IGZyb20gYW4gWEhUTUwgZG9jdW1lbnQgKG5vdCBIVE1MKSwKICAgICAgICAgICAgLy8gd2UgZG9uJ3QgbmVlZCB0byBkbyB0aGUgLnRvTG93ZXJDYXNlKCkgYXMgaXQgd2lsbCBhbHdheXMgYmUgbG93ZXIgY2FzZSBhbnl3YXkuCiAgICAgICAgICAgIHJldHVybiBlbGVtZW50ICYmIGVsZW1lbnQudGFnTmFtZSAmJiBlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICB9LAoKICAgICAgICByZWdpc3RlckV2ZW50SGFuZGxlcjogZnVuY3Rpb24gKGVsZW1lbnQsIGV2ZW50VHlwZSwgaGFuZGxlcikgewogICAgICAgICAgICB2YXIgbXVzdFVzZUF0dGFjaEV2ZW50ID0gaWVWZXJzaW9uICYmIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudFtldmVudFR5cGVdOwogICAgICAgICAgICBpZiAoIW11c3RVc2VBdHRhY2hFdmVudCAmJiB0eXBlb2YgalF1ZXJ5ICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRm9yIGNsaWNrIGV2ZW50cyBvbiBjaGVja2JveGVzLCBqUXVlcnkgaW50ZXJmZXJlcyB3aXRoIHRoZSBldmVudCBoYW5kbGluZyBpbiBhbiBhd2t3YXJkIHdheToKICAgICAgICAgICAgICAgICAgICAvLyBpdCB0b2dnbGVzIHRoZSBlbGVtZW50IGNoZWNrZWQgc3RhdGUgKmFmdGVyKiB0aGUgY2xpY2sgZXZlbnQgaGFuZGxlcnMgcnVuLCB3aGVyZWFzIG5hdGl2ZQogICAgICAgICAgICAgICAgICAgIC8vIGNsaWNrIGV2ZW50cyB0b2dnbGUgdGhlIGNoZWNrZWQgc3RhdGUgKmJlZm9yZSogdGhlIGV2ZW50IGhhbmRsZXIuCiAgICAgICAgICAgICAgICAgICAgLy8gRml4IHRoaXMgYnkgaW50ZWNlcHRpbmcgdGhlIGhhbmRsZXIgYW5kIGFwcGx5aW5nIHRoZSBjb3JyZWN0IGNoZWNrZWRuZXNzIGJlZm9yZSBpdCBydW5zLgogICAgICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbEhhbmRsZXIgPSBoYW5kbGVyOwogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBmdW5jdGlvbihldmVudCwgZXZlbnREYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBqUXVlcnlTdXBwbGllZENoZWNrZWRTdGF0ZSA9IHRoaXMuY2hlY2tlZDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50RGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IGV2ZW50RGF0YS5jaGVja2VkU3RhdGVCZWZvcmVFdmVudCAhPT0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxIYW5kbGVyLmNhbGwodGhpcywgZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoZWNrZWQgPSBqUXVlcnlTdXBwbGllZENoZWNrZWRTdGF0ZTsgLy8gUmVzdG9yZSB0aGUgc3RhdGUgalF1ZXJ5IGFwcGxpZWQKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgalF1ZXJ5KGVsZW1lbnQpWydiaW5kJ10oZXZlbnRUeXBlLCBoYW5kbGVyKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghbXVzdFVzZUF0dGFjaEV2ZW50ICYmIHR5cGVvZiBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIgPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGhhbmRsZXIsIGZhbHNlKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIGVsZW1lbnQuYXR0YWNoRXZlbnQgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICBlbGVtZW50LmF0dGFjaEV2ZW50KCJvbiIgKyBldmVudFR5cGUsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuY2FsbChlbGVtZW50LCBldmVudCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJCcm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBhZGRFdmVudExpc3RlbmVyIG9yIGF0dGFjaEV2ZW50Iik7CiAgICAgICAgfSwKCiAgICAgICAgdHJpZ2dlckV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIGlmICghKGVsZW1lbnQgJiYgZWxlbWVudC5ub2RlVHlwZSkpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImVsZW1lbnQgbXVzdCBiZSBhIERPTSBub2RlIHdoZW4gY2FsbGluZyB0cmlnZ2VyRXZlbnQiKTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgalF1ZXJ5ICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnREYXRhID0gW107CiAgICAgICAgICAgICAgICBpZiAoaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV29yayBhcm91bmQgdGhlIGpRdWVyeSAiY2xpY2sgZXZlbnRzIG9uIGNoZWNrYm94ZXMiIGlzc3VlIGRlc2NyaWJlZCBhYm92ZSBieSBzdG9yaW5nIHRoZSBvcmlnaW5hbCBjaGVja2VkIHN0YXRlIGJlZm9yZSB0cmlnZ2VyaW5nIHRoZSBoYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgZXZlbnREYXRhLnB1c2goeyBjaGVja2VkU3RhdGVCZWZvcmVFdmVudDogZWxlbWVudC5jaGVja2VkIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgalF1ZXJ5KGVsZW1lbnQpWyd0cmlnZ2VyJ10oZXZlbnRUeXBlLCBldmVudERhdGEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkb2N1bWVudC5jcmVhdGVFdmVudCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQuZGlzcGF0Y2hFdmVudCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50Q2F0ZWdvcnkgPSBrbm93bkV2ZW50VHlwZXNCeUV2ZW50TmFtZVtldmVudFR5cGVdIHx8ICJIVE1MRXZlbnRzIjsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChldmVudENhdGVnb3J5KTsKICAgICAgICAgICAgICAgICAgICBldmVudC5pbml0RXZlbnQoZXZlbnRUeXBlLCB0cnVlLCB0cnVlLCB3aW5kb3csIDAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIHN1cHBsaWVkIGVsZW1lbnQgZG9lc24ndCBzdXBwb3J0IGRpc3BhdGNoRXZlbnQiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZWxlbWVudC5maXJlRXZlbnQgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIC8vIFVubGlrZSBvdGhlciBicm93c2VycywgSUUgZG9lc24ndCBjaGFuZ2UgdGhlIGNoZWNrZWQgc3RhdGUgb2YgY2hlY2tib3hlcy9yYWRpb2J1dHRvbnMgd2hlbiB5b3UgdHJpZ2dlciB0aGVpciAiY2xpY2siIGV2ZW50CiAgICAgICAgICAgICAgICAvLyBzbyB0byBtYWtlIGl0IGNvbnNpc3RlbnQsIHdlJ2xsIGRvIGl0IG1hbnVhbGx5IGhlcmUKICAgICAgICAgICAgICAgIGlmIChpc0NsaWNrT25DaGVja2FibGVFbGVtZW50KGVsZW1lbnQsIGV2ZW50VHlwZSkpCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0gZWxlbWVudC5jaGVja2VkICE9PSB0cnVlOwogICAgICAgICAgICAgICAgZWxlbWVudC5maXJlRXZlbnQoIm9uIiArIGV2ZW50VHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJCcm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCB0cmlnZ2VyaW5nIGV2ZW50cyIpOwogICAgICAgIH0sCgogICAgICAgIHVud3JhcE9ic2VydmFibGU6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4ga28uaXNPYnNlcnZhYmxlKHZhbHVlKSA/IHZhbHVlKCkgOiB2YWx1ZTsKICAgICAgICB9LAoKICAgICAgICBwZWVrT2JzZXJ2YWJsZTogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBrby5pc09ic2VydmFibGUodmFsdWUpID8gdmFsdWUucGVlaygpIDogdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgdG9nZ2xlRG9tTm9kZUNzc0NsYXNzOiBmdW5jdGlvbiAobm9kZSwgY2xhc3NOYW1lcywgc2hvdWxkSGF2ZUNsYXNzKSB7CiAgICAgICAgICAgIGlmIChjbGFzc05hbWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgY3NzQ2xhc3NOYW1lUmVnZXggPSAvW1x3LV0rL2csCiAgICAgICAgICAgICAgICAgICAgY3VycmVudENsYXNzTmFtZXMgPSBub2RlLmNsYXNzTmFtZS5tYXRjaChjc3NDbGFzc05hbWVSZWdleCkgfHwgW107CiAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goY2xhc3NOYW1lcy5tYXRjaChjc3NDbGFzc05hbWVSZWdleCksIGZ1bmN0aW9uKGNsYXNzTmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbmRleE9mQ2xhc3MgPSBrby51dGlscy5hcnJheUluZGV4T2YoY3VycmVudENsYXNzTmFtZXMsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4T2ZDbGFzcyA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2hvdWxkSGF2ZUNsYXNzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudENsYXNzTmFtZXMuc3BsaWNlKGluZGV4T2ZDbGFzcywgMSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZEhhdmVDbGFzcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDbGFzc05hbWVzLnB1c2goY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIG5vZGUuY2xhc3NOYW1lID0gY3VycmVudENsYXNzTmFtZXMuam9pbigiICIpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgc2V0VGV4dENvbnRlbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHRleHRDb250ZW50KSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodGV4dENvbnRlbnQpOwogICAgICAgICAgICBpZiAoKHZhbHVlID09PSBudWxsKSB8fCAodmFsdWUgPT09IHVuZGVmaW5lZCkpCiAgICAgICAgICAgICAgICB2YWx1ZSA9ICIiOwoKICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDMpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuZGF0YSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gV2UgbmVlZCB0aGVyZSB0byBiZSBleGFjdGx5IG9uZSBjaGlsZDogYSB0ZXh0IG5vZGUuCiAgICAgICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgbm8gY2hpbGRyZW4sIG1vcmUgdGhhbiBvbmUsIG9yIGlmIGl0J3Mgbm90IGEgdGV4dCBub2RlLAogICAgICAgICAgICAgICAgLy8gd2UnbGwgY2xlYXIgZXZlcnl0aGluZyBhbmQgY3JlYXRlIGEgc2luZ2xlIHRleHQgbm9kZS4KICAgICAgICAgICAgICAgIHZhciBpbm5lclRleHROb2RlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICBpZiAoIWlubmVyVGV4dE5vZGUgfHwgaW5uZXJUZXh0Tm9kZS5ub2RlVHlwZSAhPSAzIHx8IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhpbm5lclRleHROb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4oZWxlbWVudCwgW2RvY3VtZW50LmNyZWF0ZVRleHROb2RlKHZhbHVlKV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpbm5lclRleHROb2RlLmRhdGEgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBrby51dGlscy5mb3JjZVJlZnJlc2goZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzZXRFbGVtZW50TmFtZTogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSkgewogICAgICAgICAgICBlbGVtZW50Lm5hbWUgPSBuYW1lOwoKICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBJRSA2LzcgaXNzdWUKICAgICAgICAgICAgLy8gLSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzE5NwogICAgICAgICAgICAvLyAtIGh0dHA6Ly93d3cubWF0dHM0MTEuY29tL3Bvc3Qvc2V0dGluZ190aGVfbmFtZV9hdHRyaWJ1dGVfaW5faWVfZG9tLwogICAgICAgICAgICBpZiAoaWVWZXJzaW9uIDw9IDcpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5tZXJnZUF0dHJpYnV0ZXMoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiPGlucHV0IG5hbWU9JyIgKyBlbGVtZW50Lm5hbWUgKyAiJy8+IiksIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGNoKGUpIHt9IC8vIEZvciBJRTkgd2l0aCBkb2MgbW9kZSAiSUU5IFN0YW5kYXJkcyIgYW5kIGJyb3dzZXIgbW9kZSAiSUU5IENvbXBhdGliaWxpdHkgVmlldyIKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGZvcmNlUmVmcmVzaDogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBhbiBJRTkgcmVuZGVyaW5nIGJ1ZyAtIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMjA5CiAgICAgICAgICAgIGlmIChpZVZlcnNpb24gPj0gOSkgewogICAgICAgICAgICAgICAgLy8gRm9yIHRleHQgbm9kZXMgYW5kIGNvbW1lbnQgbm9kZXMgKG1vc3QgbGlrZWx5IHZpcnR1YWwgZWxlbWVudHMpLCB3ZSB3aWxsIGhhdmUgdG8gcmVmcmVzaCB0aGUgY29udGFpbmVyCiAgICAgICAgICAgICAgICB2YXIgZWxlbSA9IG5vZGUubm9kZVR5cGUgPT0gMSA/IG5vZGUgOiBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICBpZiAoZWxlbS5zdHlsZSkKICAgICAgICAgICAgICAgICAgICBlbGVtLnN0eWxlLnpvb20gPSBlbGVtLnN0eWxlLnpvb207CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBlbnN1cmVTZWxlY3RFbGVtZW50SXNSZW5kZXJlZENvcnJlY3RseTogZnVuY3Rpb24oc2VsZWN0RWxlbWVudCkgewogICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBJRTkgcmVuZGVyaW5nIGJ1ZyAtIGl0IGRvZXNuJ3QgcmVsaWFibHkgZGlzcGxheSBhbGwgdGhlIHRleHQgaW4gZHluYW1pY2FsbHktYWRkZWQgc2VsZWN0IGJveGVzIHVubGVzcyB5b3UgZm9yY2UgaXQgdG8gcmUtcmVuZGVyIGJ5IHVwZGF0aW5nIHRoZSB3aWR0aC4KICAgICAgICAgICAgLy8gKFNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzMxMiwgaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy81OTA4NDk0L3NlbGVjdC1vbmx5LXNob3dzLWZpcnN0LWNoYXItb2Ytc2VsZWN0ZWQtb3B0aW9uKQogICAgICAgICAgICBpZiAoaWVWZXJzaW9uID49IDkpIHsKICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbFdpZHRoID0gc2VsZWN0RWxlbWVudC5zdHlsZS53aWR0aDsKICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuc3R5bGUud2lkdGggPSAwOwogICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5zdHlsZS53aWR0aCA9IG9yaWdpbmFsV2lkdGg7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICByYW5nZTogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CiAgICAgICAgICAgIG1pbiA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobWluKTsKICAgICAgICAgICAgbWF4ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtYXgpOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBtaW47IGkgPD0gbWF4OyBpKyspCiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBtYWtlQXJyYXk6IGZ1bmN0aW9uKGFycmF5TGlrZU9iamVjdCkgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXlMaWtlT2JqZWN0Lmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goYXJyYXlMaWtlT2JqZWN0W2ldKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBpc0llNiA6IGlzSWU2LAogICAgICAgIGlzSWU3IDogaXNJZTcsCiAgICAgICAgaWVWZXJzaW9uIDogaWVWZXJzaW9uLAoKICAgICAgICBnZXRGb3JtRmllbGRzOiBmdW5jdGlvbihmb3JtLCBmaWVsZE5hbWUpIHsKICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtvLnV0aWxzLm1ha2VBcnJheShmb3JtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpbnB1dCIpKS5jb25jYXQoa28udXRpbHMubWFrZUFycmF5KGZvcm0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRleHRhcmVhIikpKTsKICAgICAgICAgICAgdmFyIGlzTWF0Y2hpbmdGaWVsZCA9ICh0eXBlb2YgZmllbGROYW1lID09ICdzdHJpbmcnKQogICAgICAgICAgICAgICAgPyBmdW5jdGlvbihmaWVsZCkgeyByZXR1cm4gZmllbGQubmFtZSA9PT0gZmllbGROYW1lIH0KICAgICAgICAgICAgICAgIDogZnVuY3Rpb24oZmllbGQpIHsgcmV0dXJuIGZpZWxkTmFtZS50ZXN0KGZpZWxkLm5hbWUpIH07IC8vIFRyZWF0IGZpZWxkTmFtZSBhcyByZWdleCBvciBvYmplY3QgY29udGFpbmluZyBwcmVkaWNhdGUKICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IGZpZWxkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdGaWVsZChmaWVsZHNbaV0pKQogICAgICAgICAgICAgICAgICAgIG1hdGNoZXMucHVzaChmaWVsZHNbaV0pOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gbWF0Y2hlczsKICAgICAgICB9LAoKICAgICAgICBwYXJzZUpzb246IGZ1bmN0aW9uIChqc29uU3RyaW5nKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YganNvblN0cmluZyA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAganNvblN0cmluZyA9IGtvLnV0aWxzLnN0cmluZ1RyaW0oanNvblN0cmluZyk7CiAgICAgICAgICAgICAgICBpZiAoanNvblN0cmluZykgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuSlNPTiAmJiB3aW5kb3cuSlNPTi5wYXJzZSkgLy8gVXNlIG5hdGl2ZSBwYXJzaW5nIHdoZXJlIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93LkpTT04ucGFyc2UoanNvblN0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChuZXcgRnVuY3Rpb24oInJldHVybiAiICsganNvblN0cmluZykpKCk7IC8vIEZhbGxiYWNrIG9uIGxlc3Mgc2FmZSBwYXJzaW5nIGZvciBvbGRlciBicm93c2VycwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCgogICAgICAgIHN0cmluZ2lmeUpzb246IGZ1bmN0aW9uIChkYXRhLCByZXBsYWNlciwgc3BhY2UpIHsgICAvLyByZXBsYWNlciBhbmQgc3BhY2UgYXJlIG9wdGlvbmFsCiAgICAgICAgICAgIGlmICgodHlwZW9mIEpTT04gPT0gInVuZGVmaW5lZCIpIHx8ICh0eXBlb2YgSlNPTi5zdHJpbmdpZnkgPT0gInVuZGVmaW5lZCIpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmluZCBKU09OLnN0cmluZ2lmeSgpLiBTb21lIGJyb3dzZXJzIChlLmcuLCBJRSA8IDgpIGRvbid0IHN1cHBvcnQgaXQgbmF0aXZlbHksIGJ1dCB5b3UgY2FuIG92ZXJjb21lIHRoaXMgYnkgYWRkaW5nIGEgc2NyaXB0IHJlZmVyZW5jZSB0byBqc29uMi5qcywgZG93bmxvYWRhYmxlIGZyb20gaHR0cDovL3d3dy5qc29uLm9yZy9qc29uMi5qcyIpOwogICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhKSwgcmVwbGFjZXIsIHNwYWNlKTsKICAgICAgICB9LAoKICAgICAgICBwb3N0SnNvbjogZnVuY3Rpb24gKHVybE9yRm9ybSwgZGF0YSwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgdmFyIHBhcmFtcyA9IG9wdGlvbnNbJ3BhcmFtcyddIHx8IHt9OwogICAgICAgICAgICB2YXIgaW5jbHVkZUZpZWxkcyA9IG9wdGlvbnNbJ2luY2x1ZGVGaWVsZHMnXSB8fCB0aGlzLmZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0OwogICAgICAgICAgICB2YXIgdXJsID0gdXJsT3JGb3JtOwoKICAgICAgICAgICAgLy8gSWYgd2Ugd2VyZSBnaXZlbiBhIGZvcm0sIHVzZSBpdHMgJ2FjdGlvbicgVVJMIGFuZCBwaWNrIG91dCBhbnkgcmVxdWVzdGVkIGZpZWxkIHZhbHVlcwogICAgICAgICAgICBpZigodHlwZW9mIHVybE9yRm9ybSA9PSAnb2JqZWN0JykgJiYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcih1cmxPckZvcm0pID09PSAiZm9ybSIpKSB7CiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxGb3JtID0gdXJsT3JGb3JtOwogICAgICAgICAgICAgICAgdXJsID0gb3JpZ2luYWxGb3JtLmFjdGlvbjsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBpbmNsdWRlRmllbGRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtvLnV0aWxzLmdldEZvcm1GaWVsZHMob3JpZ2luYWxGb3JtLCBpbmNsdWRlRmllbGRzW2ldKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gZmllbGRzLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tKQogICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXNbZmllbGRzW2pdLm5hbWVdID0gZmllbGRzW2pdLnZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBkYXRhID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhKTsKICAgICAgICAgICAgdmFyIGZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmb3JtIik7CiAgICAgICAgICAgIGZvcm0uc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgZm9ybS5hY3Rpb24gPSB1cmw7CiAgICAgICAgICAgIGZvcm0ubWV0aG9kID0gInBvc3QiOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgICAgICAgICAgIGlucHV0Lm5hbWUgPSBrZXk7CiAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IGtvLnV0aWxzLnN0cmluZ2lmeUpzb24oa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhW2tleV0pKTsKICAgICAgICAgICAgICAgIGZvcm0uYXBwZW5kQ2hpbGQoaW5wdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwYXJhbXMpIHsKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICAgICAgICBpbnB1dC5uYW1lID0ga2V5OwogICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBwYXJhbXNba2V5XTsKICAgICAgICAgICAgICAgIGZvcm0uYXBwZW5kQ2hpbGQoaW5wdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZm9ybSk7CiAgICAgICAgICAgIG9wdGlvbnNbJ3N1Ym1pdHRlciddID8gb3B0aW9uc1snc3VibWl0dGVyJ10oZm9ybSkgOiBmb3JtLnN1Ym1pdCgpOwogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgZm9ybS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGZvcm0pOyB9LCAwKTsKICAgICAgICB9CiAgICB9Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ3V0aWxzJywga28udXRpbHMpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5Rm9yRWFjaCcsIGtvLnV0aWxzLmFycmF5Rm9yRWFjaCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlGaXJzdCcsIGtvLnV0aWxzLmFycmF5Rmlyc3QpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5RmlsdGVyJywga28udXRpbHMuYXJyYXlGaWx0ZXIpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5R2V0RGlzdGluY3RWYWx1ZXMnLCBrby51dGlscy5hcnJheUdldERpc3RpbmN0VmFsdWVzKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheUluZGV4T2YnLCBrby51dGlscy5hcnJheUluZGV4T2YpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5TWFwJywga28udXRpbHMuYXJyYXlNYXApOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5UHVzaEFsbCcsIGtvLnV0aWxzLmFycmF5UHVzaEFsbCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlSZW1vdmVJdGVtJywga28udXRpbHMuYXJyYXlSZW1vdmVJdGVtKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5leHRlbmQnLCBrby51dGlscy5leHRlbmQpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0Jywga28udXRpbHMuZmllbGRzSW5jbHVkZWRXaXRoSnNvblBvc3QpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmdldEZvcm1GaWVsZHMnLCBrby51dGlscy5nZXRGb3JtRmllbGRzKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wZWVrT2JzZXJ2YWJsZScsIGtvLnV0aWxzLnBlZWtPYnNlcnZhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wb3N0SnNvbicsIGtvLnV0aWxzLnBvc3RKc29uKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wYXJzZUpzb24nLCBrby51dGlscy5wYXJzZUpzb24pOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyJywga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnN0cmluZ2lmeUpzb24nLCBrby51dGlscy5zdHJpbmdpZnlKc29uKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5yYW5nZScsIGtvLnV0aWxzLnJhbmdlKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MnLCBrby51dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnRyaWdnZXJFdmVudCcsIGtvLnV0aWxzLnRyaWdnZXJFdmVudCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMudW53cmFwT2JzZXJ2YWJsZScsIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUpOwoKaWYgKCFGdW5jdGlvbi5wcm90b3R5cGVbJ2JpbmQnXSkgewogICAgLy8gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgaXMgYSBzdGFuZGFyZCBwYXJ0IG9mIEVDTUFTY3JpcHQgNXRoIEVkaXRpb24gKERlY2VtYmVyIDIwMDksIGh0dHA6Ly93d3cuZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9wdWJsaWNhdGlvbnMvZmlsZXMvRUNNQS1TVC9FQ01BLTI2Mi5wZGYpCiAgICAvLyBJbiBjYXNlIHRoZSBicm93c2VyIGRvZXNuJ3QgaW1wbGVtZW50IGl0IG5hdGl2ZWx5LCBwcm92aWRlIGEgSmF2YVNjcmlwdCBpbXBsZW1lbnRhdGlvbi4gVGhpcyBpbXBsZW1lbnRhdGlvbiBpcyBiYXNlZCBvbiB0aGUgb25lIGluIHByb3RvdHlwZS5qcwogICAgRnVuY3Rpb24ucHJvdG90eXBlWydiaW5kJ10gPSBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICAgICAgdmFyIG9yaWdpbmFsRnVuY3Rpb24gPSB0aGlzLCBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSwgb2JqZWN0ID0gYXJncy5zaGlmdCgpOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbEZ1bmN0aW9uLmFwcGx5KG9iamVjdCwgYXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgIH07CiAgICB9Owp9Cgprby51dGlscy5kb21EYXRhID0gbmV3IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgdW5pcXVlSWQgPSAwOwogICAgdmFyIGRhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWUgPSAiX19rb19fIiArIChuZXcgRGF0ZSkuZ2V0VGltZSgpOwogICAgdmFyIGRhdGFTdG9yZSA9IHt9OwogICAgcmV0dXJuIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChub2RlLCBrZXkpIHsKICAgICAgICAgICAgdmFyIGFsbERhdGFGb3JOb2RlID0ga28udXRpbHMuZG9tRGF0YS5nZXRBbGwobm9kZSwgZmFsc2UpOwogICAgICAgICAgICByZXR1cm4gYWxsRGF0YUZvck5vZGUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IGFsbERhdGFGb3JOb2RlW2tleV07CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIChub2RlLCBrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgd2UgZG9uJ3QgYWN0dWFsbHkgY3JlYXRlIGEgbmV3IGRvbURhdGEga2V5IGlmIHdlIGFyZSBhY3R1YWxseSBkZWxldGluZyBhIHZhbHVlCiAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuZG9tRGF0YS5nZXRBbGwobm9kZSwgZmFsc2UpID09PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbGxEYXRhRm9yTm9kZSA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0QWxsKG5vZGUsIHRydWUpOwogICAgICAgICAgICBhbGxEYXRhRm9yTm9kZVtrZXldID0gdmFsdWU7CiAgICAgICAgfSwKICAgICAgICBnZXRBbGw6IGZ1bmN0aW9uIChub2RlLCBjcmVhdGVJZk5vdEZvdW5kKSB7CiAgICAgICAgICAgIHZhciBkYXRhU3RvcmVLZXkgPSBub2RlW2RhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWVdOwogICAgICAgICAgICB2YXIgaGFzRXhpc3RpbmdEYXRhU3RvcmUgPSBkYXRhU3RvcmVLZXkgJiYgKGRhdGFTdG9yZUtleSAhPT0gIm51bGwiKSAmJiBkYXRhU3RvcmVbZGF0YVN0b3JlS2V5XTsKICAgICAgICAgICAgaWYgKCFoYXNFeGlzdGluZ0RhdGFTdG9yZSkgewogICAgICAgICAgICAgICAgaWYgKCFjcmVhdGVJZk5vdEZvdW5kKQogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICBkYXRhU3RvcmVLZXkgPSBub2RlW2RhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWVdID0gImtvIiArIHVuaXF1ZUlkKys7CiAgICAgICAgICAgICAgICBkYXRhU3RvcmVbZGF0YVN0b3JlS2V5XSA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkYXRhU3RvcmVbZGF0YVN0b3JlS2V5XTsKICAgICAgICB9LAogICAgICAgIGNsZWFyOiBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICB2YXIgZGF0YVN0b3JlS2V5ID0gbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXTsKICAgICAgICAgICAgaWYgKGRhdGFTdG9yZUtleSkgewogICAgICAgICAgICAgICAgZGVsZXRlIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldOwogICAgICAgICAgICAgICAgbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXSA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gRXhwb3NpbmcgImRpZCBjbGVhbiIgZmxhZyBwdXJlbHkgc28gc3BlY3MgY2FuIGluZmVyIHdoZXRoZXIgdGhpbmdzIGhhdmUgYmVlbiBjbGVhbmVkIHVwIGFzIGludGVuZGVkCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tRGF0YScsIGtvLnV0aWxzLmRvbURhdGEpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbURhdGEuY2xlYXInLCBrby51dGlscy5kb21EYXRhLmNsZWFyKTsgLy8gRXhwb3J0aW5nIG9ubHkgc28gc3BlY3MgY2FuIGNsZWFyIHVwIGFmdGVyIHRoZW1zZWx2ZXMgZnVsbHkKCmtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbCA9IG5ldyAoZnVuY3Rpb24gKCkgewogICAgdmFyIGRvbURhdGFLZXkgPSAiX19rb19kb21Ob2RlRGlzcG9zYWxfXyIgKyAobmV3IERhdGUpLmdldFRpbWUoKTsKICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXMgPSB7IDE6IHRydWUsIDg6IHRydWUsIDk6IHRydWUgfTsgICAgICAgLy8gRWxlbWVudCwgQ29tbWVudCwgRG9jdW1lbnQKICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXNXaXRoRGVzY2VuZGFudHMgPSB7IDE6IHRydWUsIDk6IHRydWUgfTsgLy8gRWxlbWVudCwgRG9jdW1lbnQKCiAgICBmdW5jdGlvbiBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBjcmVhdGVJZk5vdEZvdW5kKSB7CiAgICAgICAgdmFyIGFsbERpc3Bvc2VDYWxsYmFja3MgPSBrby51dGlscy5kb21EYXRhLmdldChub2RlLCBkb21EYXRhS2V5KTsKICAgICAgICBpZiAoKGFsbERpc3Bvc2VDYWxsYmFja3MgPT09IHVuZGVmaW5lZCkgJiYgY3JlYXRlSWZOb3RGb3VuZCkgewogICAgICAgICAgICBhbGxEaXNwb3NlQ2FsbGJhY2tzID0gW107CiAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIGRvbURhdGFLZXksIGFsbERpc3Bvc2VDYWxsYmFja3MpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYWxsRGlzcG9zZUNhbGxiYWNrczsKICAgIH0KICAgIGZ1bmN0aW9uIGRlc3Ryb3lDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUpIHsKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChub2RlLCBkb21EYXRhS2V5LCB1bmRlZmluZWQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsZWFuU2luZ2xlTm9kZShub2RlKSB7CiAgICAgICAgLy8gUnVuIGFsbCB0aGUgZGlzcG9zZSBjYWxsYmFja3MKICAgICAgICB2YXIgY2FsbGJhY2tzID0gZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgZmFsc2UpOwogICAgICAgIGlmIChjYWxsYmFja3MpIHsKICAgICAgICAgICAgY2FsbGJhY2tzID0gY2FsbGJhY2tzLnNsaWNlKDApOyAvLyBDbG9uZSwgYXMgdGhlIGFycmF5IG1heSBiZSBtb2RpZmllZCBkdXJpbmcgaXRlcmF0aW9uICh0eXBpY2FsbHksIGNhbGxiYWNrcyB3aWxsIHJlbW92ZSB0aGVtc2VsdmVzKQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhbGxiYWNrcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tpXShub2RlKTsKICAgICAgICB9CgogICAgICAgIC8vIEFsc28gZXJhc2UgdGhlIERPTSBkYXRhCiAgICAgICAga28udXRpbHMuZG9tRGF0YS5jbGVhcihub2RlKTsKCiAgICAgICAgLy8gU3BlY2lhbCBzdXBwb3J0IGZvciBqUXVlcnkgaGVyZSBiZWNhdXNlIGl0J3Mgc28gY29tbW9ubHkgdXNlZC4KICAgICAgICAvLyBNYW55IGpRdWVyeSBwbHVnaW5zIChpbmNsdWRpbmcganF1ZXJ5LnRtcGwpIHN0b3JlIGRhdGEgdXNpbmcgalF1ZXJ5J3MgZXF1aXZhbGVudCBvZiBkb21EYXRhCiAgICAgICAgLy8gc28gbm90aWZ5IGl0IHRvIHRlYXIgZG93biBhbnkgcmVzb3VyY2VzIGFzc29jaWF0ZWQgd2l0aCB0aGUgbm9kZSAmIGRlc2NlbmRhbnRzIGhlcmUuCiAgICAgICAgaWYgKCh0eXBlb2YgalF1ZXJ5ID09ICJmdW5jdGlvbiIpICYmICh0eXBlb2YgalF1ZXJ5WydjbGVhbkRhdGEnXSA9PSAiZnVuY3Rpb24iKSkKICAgICAgICAgICAgalF1ZXJ5WydjbGVhbkRhdGEnXShbbm9kZV0pOwoKICAgICAgICAvLyBBbHNvIGNsZWFyIGFueSBpbW1lZGlhdGUtY2hpbGQgY29tbWVudCBub2RlcywgYXMgdGhlc2Ugd291bGRuJ3QgaGF2ZSBiZWVuIGZvdW5kIGJ5CiAgICAgICAgLy8gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpIGluIGNsZWFuTm9kZSgpIChjb21tZW50IG5vZGVzIGFyZW4ndCBlbGVtZW50cykKICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKQogICAgICAgICAgICBjbGVhbkltbWVkaWF0ZUNvbW1lbnRUeXBlQ2hpbGRyZW4obm9kZSk7CiAgICB9CgogICAgZnVuY3Rpb24gY2xlYW5JbW1lZGlhdGVDb21tZW50VHlwZUNoaWxkcmVuKG5vZGVXaXRoQ2hpbGRyZW4pIHsKICAgICAgICB2YXIgY2hpbGQsIG5leHRDaGlsZCA9IG5vZGVXaXRoQ2hpbGRyZW4uZmlyc3RDaGlsZDsKICAgICAgICB3aGlsZSAoY2hpbGQgPSBuZXh0Q2hpbGQpIHsKICAgICAgICAgICAgbmV4dENoaWxkID0gY2hpbGQubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIGlmIChjaGlsZC5ub2RlVHlwZSA9PT0gOCkKICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShjaGlsZCk7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgICAgYWRkRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYWxsYmFjayBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICAgICAgZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgdHJ1ZSkucHVzaChjYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGNhbGxiYWNrc0NvbGxlY3Rpb24gPSBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBmYWxzZSk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3NDb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVJlbW92ZUl0ZW0oY2FsbGJhY2tzQ29sbGVjdGlvbiwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc0NvbGxlY3Rpb24ubGVuZ3RoID09IDApCiAgICAgICAgICAgICAgICAgICAgZGVzdHJveUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBjbGVhbk5vZGUgOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIC8vIEZpcnN0IGNsZWFuIHRoaXMgbm9kZSwgd2hlcmUgYXBwbGljYWJsZQogICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzW25vZGUubm9kZVR5cGVdKSB7CiAgICAgICAgICAgICAgICBjbGVhblNpbmdsZU5vZGUobm9kZSk7CgogICAgICAgICAgICAgICAgLy8gLi4uIHRoZW4gaXRzIGRlc2NlbmRhbnRzLCB3aGVyZSBhcHBsaWNhYmxlCiAgICAgICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIGRlc2NlbmRhbnRzIGxpc3QgaW4gY2FzZSBpdCBjaGFuZ2VzIGR1cmluZyBpdGVyYXRpb24KICAgICAgICAgICAgICAgICAgICB2YXIgZGVzY2VuZGFudHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoZGVzY2VuZGFudHMsIG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSk7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBkZXNjZW5kYW50cy5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShkZXNjZW5kYW50c1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlTm9kZSA6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAga28uY2xlYW5Ob2RlKG5vZGUpOwogICAgICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlKQogICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICAgIH0KICAgIH0KfSkoKTsKa28uY2xlYW5Ob2RlID0ga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmNsZWFuTm9kZTsgLy8gU2hvcnRoYW5kIG5hbWUgZm9yIGNvbnZlbmllbmNlCmtvLnJlbW92ZU5vZGUgPSBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlTm9kZTsgLy8gU2hvcnRoYW5kIG5hbWUgZm9yIGNvbnZlbmllbmNlCmtvLmV4cG9ydFN5bWJvbCgnY2xlYW5Ob2RlJywga28uY2xlYW5Ob2RlKTsKa28uZXhwb3J0U3ltYm9sKCdyZW1vdmVOb2RlJywga28ucmVtb3ZlTm9kZSk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tTm9kZURpc3Bvc2FsJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tTm9kZURpc3Bvc2FsLnJlbW92ZURpc3Bvc2VDYWxsYmFjaycsIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5yZW1vdmVEaXNwb3NlQ2FsbGJhY2spOwooZnVuY3Rpb24gKCkgewogICAgdmFyIGxlYWRpbmdDb21tZW50UmVnZXggPSAvXihccyopPCEtLSguKj8pLS0+LzsKCiAgICBmdW5jdGlvbiBzaW1wbGVIdG1sUGFyc2UoaHRtbCkgewogICAgICAgIC8vIEJhc2VkIG9uIGpRdWVyeSdzICJjbGVhbiIgZnVuY3Rpb24sIGJ1dCBvbmx5IGFjY291bnRpbmcgZm9yIHRhYmxlLXJlbGF0ZWQgZWxlbWVudHMuCiAgICAgICAgLy8gSWYgeW91IGhhdmUgcmVmZXJlbmNlZCBqUXVlcnksIHRoaXMgd29uJ3QgYmUgdXNlZCBhbnl3YXkgLSBLTyB3aWxsIHVzZSBqUXVlcnkncyAiY2xlYW4iIGZ1bmN0aW9uIGRpcmVjdGx5CgogICAgICAgIC8vIE5vdGUgdGhhdCB0aGVyZSdzIHN0aWxsIGFuIGlzc3VlIGluIElFIDwgOSB3aGVyZWJ5IGl0IHdpbGwgZGlzY2FyZCBjb21tZW50IG5vZGVzIHRoYXQgYXJlIHRoZSBmaXJzdCBjaGlsZCBvZgogICAgICAgIC8vIGEgZGVzY2VuZGFudCBub2RlLiBGb3IgZXhhbXBsZTogIjxkaXY+PCEtLSBteWNvbW1lbnQgLS0+YWJjPC9kaXY+IiB3aWxsIGdldCBwYXJzZWQgYXMgIjxkaXY+YWJjPC9kaXY+IgogICAgICAgIC8vIFRoaXMgd29uJ3QgYWZmZWN0IGFueW9uZSB3aG8gaGFzIHJlZmVyZW5jZWQgalF1ZXJ5LCBhbmQgdGhlcmUncyBhbHdheXMgdGhlIHdvcmthcm91bmQgb2YgaW5zZXJ0aW5nIGEgZHVtbXkgbm9kZQogICAgICAgIC8vIChwb3NzaWJseSBhIHRleHQgbm9kZSkgaW4gZnJvbnQgb2YgdGhlIGNvbW1lbnQuIFNvLCBLTyBkb2VzIG5vdCBhdHRlbXB0IHRvIHdvcmthcm91bmQgdGhpcyBJRSBpc3N1ZSBhdXRvbWF0aWNhbGx5IGF0IHByZXNlbnQuCgogICAgICAgIC8vIFRyaW0gd2hpdGVzcGFjZSwgb3RoZXJ3aXNlIGluZGV4T2Ygd29uJ3Qgd29yayBhcyBleHBlY3RlZAogICAgICAgIHZhciB0YWdzID0ga28udXRpbHMuc3RyaW5nVHJpbShodG1sKS50b0xvd2VyQ2FzZSgpLCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCiAgICAgICAgLy8gRmluZHMgdGhlIGZpcnN0IG1hdGNoIGZyb20gdGhlIGxlZnQgY29sdW1uLCBhbmQgcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyAid3JhcCIgZGF0YSBmcm9tIHRoZSByaWdodCBjb2x1bW4KICAgICAgICB2YXIgd3JhcCA9IHRhZ3MubWF0Y2goL148KHRoZWFkfHRib2R5fHRmb290KS8pICAgICAgICAgICAgICAmJiBbMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iXSB8fAogICAgICAgICAgICAgICAgICAgIXRhZ3MuaW5kZXhPZigiPHRyIikgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIFsyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiJdIHx8CiAgICAgICAgICAgICAgICAgICAoIXRhZ3MuaW5kZXhPZigiPHRkIikgfHwgIXRhZ3MuaW5kZXhPZigiPHRoIikpICAgJiYgWzMsICI8dGFibGU+PHRib2R5Pjx0cj4iLCAiPC90cj48L3Rib2R5PjwvdGFibGU+Il0gfHwKICAgICAgICAgICAgICAgICAgIC8qIGFueXRoaW5nIGVsc2UgKi8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbMCwgIiIsICIiXTsKCiAgICAgICAgLy8gR28gdG8gaHRtbCBhbmQgYmFjaywgdGhlbiBwZWVsIG9mZiBleHRyYSB3cmFwcGVycwogICAgICAgIC8vIE5vdGUgdGhhdCB3ZSBhbHdheXMgcHJlZml4IHdpdGggc29tZSBkdW1teSB0ZXh0LCBiZWNhdXNlIG90aGVyd2lzZSwgSUU8OSB3aWxsIHN0cmlwIG91dCBsZWFkaW5nIGNvbW1lbnQgbm9kZXMgaW4gZGVzY2VuZGFudHMuIFRvdGFsIG1hZG5lc3MuCiAgICAgICAgdmFyIG1hcmt1cCA9ICJpZ25vcmVkPGRpdj4iICsgd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdICsgIjwvZGl2PiI7CiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3dbJ2lubmVyU2hpdiddID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgZGl2LmFwcGVuZENoaWxkKHdpbmRvd1snaW5uZXJTaGl2J10obWFya3VwKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9IG1hcmt1cDsKICAgICAgICB9CgogICAgICAgIC8vIE1vdmUgdG8gdGhlIHJpZ2h0IGRlcHRoCiAgICAgICAgd2hpbGUgKHdyYXBbMF0tLSkKICAgICAgICAgICAgZGl2ID0gZGl2Lmxhc3RDaGlsZDsKCiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLm1ha2VBcnJheShkaXYubGFzdENoaWxkLmNoaWxkTm9kZXMpOwogICAgfQoKICAgIGZ1bmN0aW9uIGpRdWVyeUh0bWxQYXJzZShodG1sKSB7CiAgICAgICAgdmFyIGVsZW1zID0galF1ZXJ5WydjbGVhbiddKFtodG1sXSk7CgogICAgICAgIC8vIEFzIG9mIGpRdWVyeSAxLjcuMSwgalF1ZXJ5IHBhcnNlcyB0aGUgSFRNTCBieSBhcHBlbmRpbmcgaXQgdG8gc29tZSBkdW1teSBwYXJlbnQgbm9kZXMgaGVsZCBpbiBhbiBpbi1tZW1vcnkgZG9jdW1lbnQgZnJhZ21lbnQuCiAgICAgICAgLy8gVW5mb3J0dW5hdGVseSwgaXQgbmV2ZXIgY2xlYXJzIHRoZSBkdW1teSBwYXJlbnQgbm9kZXMgZnJvbSB0aGUgZG9jdW1lbnQgZnJhZ21lbnQsIHNvIGl0IGxlYWtzIG1lbW9yeSBvdmVyIHRpbWUuCiAgICAgICAgLy8gRml4IHRoaXMgYnkgZmluZGluZyB0aGUgdG9wLW1vc3QgZHVtbXkgcGFyZW50IGVsZW1lbnQsIGFuZCBkZXRhY2hpbmcgaXQgZnJvbSBpdHMgb3duZXIgZnJhZ21lbnQuCiAgICAgICAgaWYgKGVsZW1zICYmIGVsZW1zWzBdKSB7CiAgICAgICAgICAgIC8vIEZpbmQgdGhlIHRvcC1tb3N0IHBhcmVudCBlbGVtZW50IHRoYXQncyBhIGRpcmVjdCBjaGlsZCBvZiBhIGRvY3VtZW50IGZyYWdtZW50CiAgICAgICAgICAgIHZhciBlbGVtID0gZWxlbXNbMF07CiAgICAgICAgICAgIHdoaWxlIChlbGVtLnBhcmVudE5vZGUgJiYgZWxlbS5wYXJlbnROb2RlLm5vZGVUeXBlICE9PSAxMSAvKiBpLmUuLCBEb2N1bWVudEZyYWdtZW50ICovKQogICAgICAgICAgICAgICAgZWxlbSA9IGVsZW0ucGFyZW50Tm9kZTsKICAgICAgICAgICAgLy8gLi4uIHRoZW4gZGV0YWNoIGl0CiAgICAgICAgICAgIGlmIChlbGVtLnBhcmVudE5vZGUpCiAgICAgICAgICAgICAgICBlbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZWxlbXM7CiAgICB9CgogICAga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQgPSBmdW5jdGlvbihodG1sKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBqUXVlcnkgIT0gJ3VuZGVmaW5lZCcgPyBqUXVlcnlIdG1sUGFyc2UoaHRtbCkgICAvLyBBcyBiZWxvdywgYmVuZWZpdCBmcm9tIGpRdWVyeSdzIG9wdGltaXNhdGlvbnMgd2hlcmUgcG9zc2libGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHNpbXBsZUh0bWxQYXJzZShodG1sKTsgIC8vIC4uLiBvdGhlcndpc2UsIHRoaXMgc2ltcGxlIGxvZ2ljIHdpbGwgZG8gaW4gbW9zdCBjb21tb24gY2FzZXMuCiAgICB9OwoKICAgIGtvLnV0aWxzLnNldEh0bWwgPSBmdW5jdGlvbihub2RlLCBodG1sKSB7CiAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKG5vZGUpOwoKICAgICAgICAvLyBUaGVyZSdzIG5vIGxlZ2l0aW1hdGUgcmVhc29uIHRvIGRpc3BsYXkgYSBzdHJpbmdpZmllZCBvYnNlcnZhYmxlIHdpdGhvdXQgdW53cmFwcGluZyBpdCwgc28gd2UnbGwgdW53cmFwIGl0CiAgICAgICAgaHRtbCA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoaHRtbCk7CgogICAgICAgIGlmICgoaHRtbCAhPT0gbnVsbCkgJiYgKGh0bWwgIT09IHVuZGVmaW5lZCkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBodG1sICE9ICdzdHJpbmcnKQogICAgICAgICAgICAgICAgaHRtbCA9IGh0bWwudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIC8vIGpRdWVyeSBjb250YWlucyBhIGxvdCBvZiBzb3BoaXN0aWNhdGVkIGNvZGUgdG8gcGFyc2UgYXJiaXRyYXJ5IEhUTUwgZnJhZ21lbnRzLAogICAgICAgICAgICAvLyBmb3IgZXhhbXBsZSA8dHI+IGVsZW1lbnRzIHdoaWNoIGFyZSBub3Qgbm9ybWFsbHkgYWxsb3dlZCB0byBleGlzdCBvbiB0aGVpciBvd24uCiAgICAgICAgICAgIC8vIElmIHlvdSd2ZSByZWZlcmVuY2VkIGpRdWVyeSB3ZSdsbCB1c2UgdGhhdCByYXRoZXIgdGhhbiBkdXBsaWNhdGluZyBpdHMgY29kZS4KICAgICAgICAgICAgaWYgKHR5cGVvZiBqUXVlcnkgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIGpRdWVyeShub2RlKVsnaHRtbCddKGh0bWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gLi4uIG90aGVyd2lzZSwgdXNlIEtPJ3Mgb3duIHBhcnNpbmcgbG9naWMuCiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkTm9kZXMgPSBrby51dGlscy5wYXJzZUh0bWxGcmFnbWVudChodG1sKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyc2VkTm9kZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChwYXJzZWROb2Rlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wYXJzZUh0bWxGcmFnbWVudCcsIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXRIdG1sJywga28udXRpbHMuc2V0SHRtbCk7Cgprby5tZW1vaXphdGlvbiA9IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgbWVtb3MgPSB7fTsKCiAgICBmdW5jdGlvbiByYW5kb21NYXg4SGV4Q2hhcnMoKSB7CiAgICAgICAgcmV0dXJuICgoKDEgKyBNYXRoLnJhbmRvbSgpKSAqIDB4MTAwMDAwMDAwKSB8IDApLnRvU3RyaW5nKDE2KS5zdWJzdHJpbmcoMSk7CiAgICB9CiAgICBmdW5jdGlvbiBnZW5lcmF0ZVJhbmRvbUlkKCkgewogICAgICAgIHJldHVybiByYW5kb21NYXg4SGV4Q2hhcnMoKSArIHJhbmRvbU1heDhIZXhDaGFycygpOwogICAgfQogICAgZnVuY3Rpb24gZmluZE1lbW9Ob2Rlcyhyb290Tm9kZSwgYXBwZW5kVG9BcnJheSkgewogICAgICAgIGlmICghcm9vdE5vZGUpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBpZiAocm9vdE5vZGUubm9kZVR5cGUgPT0gOCkgewogICAgICAgICAgICB2YXIgbWVtb0lkID0ga28ubWVtb2l6YXRpb24ucGFyc2VNZW1vVGV4dChyb290Tm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICBpZiAobWVtb0lkICE9IG51bGwpCiAgICAgICAgICAgICAgICBhcHBlbmRUb0FycmF5LnB1c2goeyBkb21Ob2RlOiByb290Tm9kZSwgbWVtb0lkOiBtZW1vSWQgfSk7CiAgICAgICAgfSBlbHNlIGlmIChyb290Tm9kZS5ub2RlVHlwZSA9PSAxKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZE5vZGVzID0gcm9vdE5vZGUuY2hpbGROb2RlcywgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgZmluZE1lbW9Ob2RlcyhjaGlsZE5vZGVzW2ldLCBhcHBlbmRUb0FycmF5KTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBtZW1vaXplOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgY2FuIG9ubHkgcGFzcyBhIGZ1bmN0aW9uIHRvIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoKSIpOwogICAgICAgICAgICB2YXIgbWVtb0lkID0gZ2VuZXJhdGVSYW5kb21JZCgpOwogICAgICAgICAgICBtZW1vc1ttZW1vSWRdID0gY2FsbGJhY2s7CiAgICAgICAgICAgIHJldHVybiAiPCEtLVtrb19tZW1vOiIgKyBtZW1vSWQgKyAiXS0tPiI7CiAgICAgICAgfSwKCiAgICAgICAgdW5tZW1vaXplOiBmdW5jdGlvbiAobWVtb0lkLCBjYWxsYmFja1BhcmFtcykgewogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBtZW1vc1ttZW1vSWRdOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ291bGRuJ3QgZmluZCBhbnkgbWVtbyB3aXRoIElEICIgKyBtZW1vSWQgKyAiLiBQZXJoYXBzIGl0J3MgYWxyZWFkeSBiZWVuIHVubWVtb2l6ZWQuIik7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShudWxsLCBjYWxsYmFja1BhcmFtcyB8fCBbXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5hbGx5IHsgZGVsZXRlIG1lbW9zW21lbW9JZF07IH0KICAgICAgICB9LAoKICAgICAgICB1bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHM6IGZ1bmN0aW9uIChkb21Ob2RlLCBleHRyYUNhbGxiYWNrUGFyYW1zQXJyYXkpIHsKICAgICAgICAgICAgdmFyIG1lbW9zID0gW107CiAgICAgICAgICAgIGZpbmRNZW1vTm9kZXMoZG9tTm9kZSwgbWVtb3MpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG1lbW9zLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBtZW1vc1tpXS5kb21Ob2RlOwogICAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkUGFyYW1zID0gW25vZGVdOwogICAgICAgICAgICAgICAgaWYgKGV4dHJhQ2FsbGJhY2tQYXJhbXNBcnJheSkKICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoY29tYmluZWRQYXJhbXMsIGV4dHJhQ2FsbGJhY2tQYXJhbXNBcnJheSk7CiAgICAgICAgICAgICAgICBrby5tZW1vaXphdGlvbi51bm1lbW9pemUobWVtb3NbaV0ubWVtb0lkLCBjb21iaW5lZFBhcmFtcyk7CiAgICAgICAgICAgICAgICBub2RlLm5vZGVWYWx1ZSA9ICIiOyAvLyBOZXV0ZXIgdGhpcyBub2RlIHNvIHdlIGRvbid0IHRyeSB0byB1bm1lbW9pemUgaXQgYWdhaW4KICAgICAgICAgICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpCiAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOyAvLyBJZiBwb3NzaWJsZSwgZXJhc2UgaXQgdG90YWxseSAobm90IGFsd2F5cyBwb3NzaWJsZSAtIHNvbWVvbmUgZWxzZSBtaWdodCBqdXN0IGhvbGQgYSByZWZlcmVuY2UgdG8gaXQgdGhlbiBjYWxsIHVubWVtb2l6ZURvbU5vZGVBbmREZXNjZW5kYW50cyBhZ2FpbikKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHBhcnNlTWVtb1RleHQ6IGZ1bmN0aW9uIChtZW1vVGV4dCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBtZW1vVGV4dC5tYXRjaCgvXlxba29fbWVtb1w6KC4qPylcXSQvKTsKICAgICAgICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBudWxsOwogICAgICAgIH0KICAgIH07Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uJywga28ubWVtb2l6YXRpb24pOwprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLm1lbW9pemUnLCBrby5tZW1vaXphdGlvbi5tZW1vaXplKTsKa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi51bm1lbW9pemUnLCBrby5tZW1vaXphdGlvbi51bm1lbW9pemUpOwprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLnBhcnNlTWVtb1RleHQnLCBrby5tZW1vaXphdGlvbi5wYXJzZU1lbW9UZXh0KTsKa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMnLCBrby5tZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMpOwprby5leHRlbmRlcnMgPSB7CiAgICAndGhyb3R0bGUnOiBmdW5jdGlvbih0YXJnZXQsIHRpbWVvdXQpIHsKICAgICAgICAvLyBUaHJvdHRsaW5nIG1lYW5zIHR3byB0aGluZ3M6CgogICAgICAgIC8vICgxKSBGb3IgZGVwZW5kZW50IG9ic2VydmFibGVzLCB3ZSB0aHJvdHRsZSAqZXZhbHVhdGlvbnMqIHNvIHRoYXQsIG5vIG1hdHRlciBob3cgZmFzdCBpdHMgZGVwZW5kZW5jaWVzCiAgICAgICAgLy8gICAgIG5vdGlmeSB1cGRhdGVzLCB0aGUgdGFyZ2V0IGRvZXNuJ3QgcmUtZXZhbHVhdGUgKGFuZCBoZW5jZSBkb2Vzbid0IG5vdGlmeSkgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKICAgICAgICB0YXJnZXRbJ3Rocm90dGxlRXZhbHVhdGlvbiddID0gdGltZW91dDsKCiAgICAgICAgLy8gKDIpIEZvciB3cml0YWJsZSB0YXJnZXRzIChvYnNlcnZhYmxlcywgb3Igd3JpdGFibGUgZGVwZW5kZW50IG9ic2VydmFibGVzKSwgd2UgdGhyb3R0bGUgKndyaXRlcyoKICAgICAgICAvLyAgICAgc28gdGhlIHRhcmdldCBjYW5ub3QgY2hhbmdlIHZhbHVlIHN5bmNocm9ub3VzbHkgb3IgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKICAgICAgICB2YXIgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwogICAgICAgIHJldHVybiBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKHsKICAgICAgICAgICAgJ3JlYWQnOiB0YXJnZXQsCiAgICAgICAgICAgICd3cml0ZSc6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQod3JpdGVUaW1lb3V0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKCiAgICAnbm90aWZ5JzogZnVuY3Rpb24odGFyZ2V0LCBub3RpZnlXaGVuKSB7CiAgICAgICAgdGFyZ2V0WyJlcXVhbGl0eUNvbXBhcmVyIl0gPSBub3RpZnlXaGVuID09ICJhbHdheXMiCiAgICAgICAgICAgID8gZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZSB9IC8vIFRyZWF0IGFsbCB2YWx1ZXMgYXMgbm90IGVxdWFsCiAgICAgICAgICAgIDoga28ub2JzZXJ2YWJsZVsiZm4iXVsiZXF1YWxpdHlDb21wYXJlciJdOwogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9Cn07CgpmdW5jdGlvbiBhcHBseUV4dGVuZGVycyhyZXF1ZXN0ZWRFeHRlbmRlcnMpIHsKICAgIHZhciB0YXJnZXQgPSB0aGlzOwogICAgaWYgKHJlcXVlc3RlZEV4dGVuZGVycykgewogICAgICAgIGZvciAodmFyIGtleSBpbiByZXF1ZXN0ZWRFeHRlbmRlcnMpIHsKICAgICAgICAgICAgdmFyIGV4dGVuZGVySGFuZGxlciA9IGtvLmV4dGVuZGVyc1trZXldOwogICAgICAgICAgICBpZiAodHlwZW9mIGV4dGVuZGVySGFuZGxlciA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSBleHRlbmRlckhhbmRsZXIodGFyZ2V0LCByZXF1ZXN0ZWRFeHRlbmRlcnNba2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdGFyZ2V0Owp9Cgprby5leHBvcnRTeW1ib2woJ2V4dGVuZGVycycsIGtvLmV4dGVuZGVycyk7Cgprby5zdWJzY3JpcHRpb24gPSBmdW5jdGlvbiAodGFyZ2V0LCBjYWxsYmFjaywgZGlzcG9zZUNhbGxiYWNrKSB7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgIHRoaXMuZGlzcG9zZUNhbGxiYWNrID0gZGlzcG9zZUNhbGxiYWNrOwogICAga28uZXhwb3J0UHJvcGVydHkodGhpcywgJ2Rpc3Bvc2UnLCB0aGlzLmRpc3Bvc2UpOwp9Owprby5zdWJzY3JpcHRpb24ucHJvdG90eXBlLmRpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLmlzRGlzcG9zZWQgPSB0cnVlOwogICAgdGhpcy5kaXNwb3NlQ2FsbGJhY2soKTsKfTsKCmtvLnN1YnNjcmliYWJsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSB7fTsKCiAgICBrby51dGlscy5leHRlbmQodGhpcywga28uc3Vic2NyaWJhYmxlWydmbiddKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KHRoaXMsICdzdWJzY3JpYmUnLCB0aGlzLnN1YnNjcmliZSk7CiAgICBrby5leHBvcnRQcm9wZXJ0eSh0aGlzLCAnZXh0ZW5kJywgdGhpcy5leHRlbmQpOwogICAga28uZXhwb3J0UHJvcGVydHkodGhpcywgJ2dldFN1YnNjcmlwdGlvbnNDb3VudCcsIHRoaXMuZ2V0U3Vic2NyaXB0aW9uc0NvdW50KTsKfQoKdmFyIGRlZmF1bHRFdmVudCA9ICJjaGFuZ2UiOwoKa28uc3Vic2NyaWJhYmxlWydmbiddID0gewogICAgc3Vic2NyaWJlOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNhbGxiYWNrVGFyZ2V0LCBldmVudCkgewogICAgICAgIGV2ZW50ID0gZXZlbnQgfHwgZGVmYXVsdEV2ZW50OwogICAgICAgIHZhciBib3VuZENhbGxiYWNrID0gY2FsbGJhY2tUYXJnZXQgPyBjYWxsYmFjay5iaW5kKGNhbGxiYWNrVGFyZ2V0KSA6IGNhbGxiYWNrOwoKICAgICAgICB2YXIgc3Vic2NyaXB0aW9uID0gbmV3IGtvLnN1YnNjcmlwdGlvbih0aGlzLCBib3VuZENhbGxiYWNrLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbSh0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XSwgc3Vic2NyaXB0aW9uKTsKICAgICAgICB9LmJpbmQodGhpcykpOwoKICAgICAgICBpZiAoIXRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdKQogICAgICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XSA9IFtdOwogICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLnB1c2goc3Vic2NyaXB0aW9uKTsKICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9uOwogICAgfSwKCiAgICAibm90aWZ5U3Vic2NyaWJlcnMiOiBmdW5jdGlvbiAodmFsdWVUb05vdGlmeSwgZXZlbnQpIHsKICAgICAgICBldmVudCA9IGV2ZW50IHx8IGRlZmF1bHRFdmVudDsKICAgICAgICBpZiAodGhpcy5fc3Vic2NyaXB0aW9uc1tldmVudF0pIHsKICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2godGhpcy5fc3Vic2NyaXB0aW9uc1tldmVudF0uc2xpY2UoMCksIGZ1bmN0aW9uIChzdWJzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbiBjYXNlIGEgc3Vic2NyaXB0aW9uIHdhcyBkaXNwb3NlZCBkdXJpbmcgdGhlIGFycmF5Rm9yRWFjaCBjeWNsZSwgY2hlY2sKICAgICAgICAgICAgICAgICAgICAvLyBmb3IgaXNEaXNwb3NlZCBvbiBlYWNoIHN1YnNjcmlwdGlvbiBiZWZvcmUgaW52b2tpbmcgaXRzIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbiAmJiAoc3Vic2NyaXB0aW9uLmlzRGlzcG9zZWQgIT09IHRydWUpKQogICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb24uY2FsbGJhY2sodmFsdWVUb05vdGlmeSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICBnZXRTdWJzY3JpcHRpb25zQ291bnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdG90YWwgPSAwOwogICAgICAgIGZvciAodmFyIGV2ZW50TmFtZSBpbiB0aGlzLl9zdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9zdWJzY3JpcHRpb25zLmhhc093blByb3BlcnR5KGV2ZW50TmFtZSkpCiAgICAgICAgICAgICAgICB0b3RhbCArPSB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50TmFtZV0ubGVuZ3RoOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG90YWw7CiAgICB9LAoKICAgIGV4dGVuZDogYXBwbHlFeHRlbmRlcnMKfTsKCgprby5pc1N1YnNjcmliYWJsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkgewogICAgcmV0dXJuIHR5cGVvZiBpbnN0YW5jZS5zdWJzY3JpYmUgPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2VbIm5vdGlmeVN1YnNjcmliZXJzIl0gPT0gImZ1bmN0aW9uIjsKfTsKCmtvLmV4cG9ydFN5bWJvbCgnc3Vic2NyaWJhYmxlJywga28uc3Vic2NyaWJhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCdpc1N1YnNjcmliYWJsZScsIGtvLmlzU3Vic2NyaWJhYmxlKTsKCmtvLmRlcGVuZGVuY3lEZXRlY3Rpb24gPSAoZnVuY3Rpb24gKCkgewogICAgdmFyIF9mcmFtZXMgPSBbXTsKCiAgICByZXR1cm4gewogICAgICAgIGJlZ2luOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgX2ZyYW1lcy5wdXNoKHsgY2FsbGJhY2s6IGNhbGxiYWNrLCBkaXN0aW5jdERlcGVuZGVuY2llczpbXSB9KTsKICAgICAgICB9LAoKICAgICAgICBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgX2ZyYW1lcy5wb3AoKTsKICAgICAgICB9LAoKICAgICAgICByZWdpc3RlckRlcGVuZGVuY3k6IGZ1bmN0aW9uIChzdWJzY3JpYmFibGUpIHsKICAgICAgICAgICAgaWYgKCFrby5pc1N1YnNjcmliYWJsZShzdWJzY3JpYmFibGUpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPbmx5IHN1YnNjcmliYWJsZSB0aGluZ3MgY2FuIGFjdCBhcyBkZXBlbmRlbmNpZXMiKTsKICAgICAgICAgICAgaWYgKF9mcmFtZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIHRvcEZyYW1lID0gX2ZyYW1lc1tfZnJhbWVzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgaWYgKCF0b3BGcmFtZSB8fCBrby51dGlscy5hcnJheUluZGV4T2YodG9wRnJhbWUuZGlzdGluY3REZXBlbmRlbmNpZXMsIHN1YnNjcmliYWJsZSkgPj0gMCkKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB0b3BGcmFtZS5kaXN0aW5jdERlcGVuZGVuY2llcy5wdXNoKHN1YnNjcmliYWJsZSk7CiAgICAgICAgICAgICAgICB0b3BGcmFtZS5jYWxsYmFjayhzdWJzY3JpYmFibGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgaWdub3JlOiBmdW5jdGlvbihjYWxsYmFjaywgY2FsbGJhY2tUYXJnZXQsIGNhbGxiYWNrQXJncykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgX2ZyYW1lcy5wdXNoKG51bGwpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KGNhbGxiYWNrVGFyZ2V0LCBjYWxsYmFja0FyZ3MgfHwgW10pOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgX2ZyYW1lcy5wb3AoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7CnZhciBwcmltaXRpdmVUeXBlcyA9IHsgJ3VuZGVmaW5lZCc6dHJ1ZSwgJ2Jvb2xlYW4nOnRydWUsICdudW1iZXInOnRydWUsICdzdHJpbmcnOnRydWUgfTsKCmtvLm9ic2VydmFibGUgPSBmdW5jdGlvbiAoaW5pdGlhbFZhbHVlKSB7CiAgICB2YXIgX2xhdGVzdFZhbHVlID0gaW5pdGlhbFZhbHVlOwoKICAgIGZ1bmN0aW9uIG9ic2VydmFibGUoKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIC8vIFdyaXRlCgogICAgICAgICAgICAvLyBJZ25vcmUgd3JpdGVzIGlmIHRoZSB2YWx1ZSBoYXNuJ3QgY2hhbmdlZAogICAgICAgICAgICBpZiAoKCFvYnNlcnZhYmxlWydlcXVhbGl0eUNvbXBhcmVyJ10pIHx8ICFvYnNlcnZhYmxlWydlcXVhbGl0eUNvbXBhcmVyJ10oX2xhdGVzdFZhbHVlLCBhcmd1bWVudHNbMF0pKSB7CiAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSgpOwogICAgICAgICAgICAgICAgX2xhdGVzdFZhbHVlID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICAgICAgaWYgKERFQlVHKSBvYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKICAgICAgICAgICAgICAgIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7IC8vIFBlcm1pdHMgY2hhaW5lZCBhc3NpZ25tZW50cwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgLy8gUmVhZAogICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLnJlZ2lzdGVyRGVwZW5kZW5jeShvYnNlcnZhYmxlKTsgLy8gVGhlIGNhbGxlciBvbmx5IG5lZWRzIHRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgaWYgdGhleSBkaWQgYSAicmVhZCIgb3BlcmF0aW9uCiAgICAgICAgICAgIHJldHVybiBfbGF0ZXN0VmFsdWU7CiAgICAgICAgfQogICAgfQogICAgaWYgKERFQlVHKSBvYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKICAgIGtvLnN1YnNjcmliYWJsZS5jYWxsKG9ic2VydmFibGUpOwogICAgb2JzZXJ2YWJsZS5wZWVrID0gZnVuY3Rpb24oKSB7IHJldHVybiBfbGF0ZXN0VmFsdWUgfTsKICAgIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkID0gZnVuY3Rpb24gKCkgeyBvYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSk7IH0KICAgIG9ic2VydmFibGUudmFsdWVXaWxsTXV0YXRlID0gZnVuY3Rpb24gKCkgeyBvYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOyB9CiAgICBrby51dGlscy5leHRlbmQob2JzZXJ2YWJsZSwga28ub2JzZXJ2YWJsZVsnZm4nXSk7CgogICAga28uZXhwb3J0UHJvcGVydHkob2JzZXJ2YWJsZSwgJ3BlZWsnLCBvYnNlcnZhYmxlLnBlZWspOwogICAga28uZXhwb3J0UHJvcGVydHkob2JzZXJ2YWJsZSwgInZhbHVlSGFzTXV0YXRlZCIsIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KG9ic2VydmFibGUsICJ2YWx1ZVdpbGxNdXRhdGUiLCBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSk7CgogICAgcmV0dXJuIG9ic2VydmFibGU7Cn0KCmtvLm9ic2VydmFibGVbJ2ZuJ10gPSB7CiAgICAiZXF1YWxpdHlDb21wYXJlciI6IGZ1bmN0aW9uIHZhbHVlc0FyZVByaW1pdGl2ZUFuZEVxdWFsKGEsIGIpIHsKICAgICAgICB2YXIgb2xkVmFsdWVJc1ByaW1pdGl2ZSA9IChhID09PSBudWxsKSB8fCAodHlwZW9mKGEpIGluIHByaW1pdGl2ZVR5cGVzKTsKICAgICAgICByZXR1cm4gb2xkVmFsdWVJc1ByaW1pdGl2ZSA/IChhID09PSBiKSA6IGZhbHNlOwogICAgfQp9OwoKdmFyIHByb3RvUHJvcGVydHkgPSBrby5vYnNlcnZhYmxlLnByb3RvUHJvcGVydHkgPSAiX19rb19wcm90b19fIjsKa28ub2JzZXJ2YWJsZVsnZm4nXVtwcm90b1Byb3BlcnR5XSA9IGtvLm9ic2VydmFibGU7Cgprby5oYXNQcm90b3R5cGUgPSBmdW5jdGlvbihpbnN0YW5jZSwgcHJvdG90eXBlKSB7CiAgICBpZiAoKGluc3RhbmNlID09PSBudWxsKSB8fCAoaW5zdGFuY2UgPT09IHVuZGVmaW5lZCkgfHwgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSB1bmRlZmluZWQpKSByZXR1cm4gZmFsc2U7CiAgICBpZiAoaW5zdGFuY2VbcHJvdG9Qcm9wZXJ0eV0gPT09IHByb3RvdHlwZSkgcmV0dXJuIHRydWU7CiAgICByZXR1cm4ga28uaGFzUHJvdG90eXBlKGluc3RhbmNlW3Byb3RvUHJvcGVydHldLCBwcm90b3R5cGUpOyAvLyBXYWxrIHRoZSBwcm90b3R5cGUgY2hhaW4KfTsKCmtvLmlzT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkgewogICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28ub2JzZXJ2YWJsZSk7Cn0Ka28uaXNXcml0ZWFibGVPYnNlcnZhYmxlID0gZnVuY3Rpb24gKGluc3RhbmNlKSB7CiAgICAvLyBPYnNlcnZhYmxlCiAgICBpZiAoKHR5cGVvZiBpbnN0YW5jZSA9PSAiZnVuY3Rpb24iKSAmJiBpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0ga28ub2JzZXJ2YWJsZSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIC8vIFdyaXRlYWJsZSBkZXBlbmRlbnQgb2JzZXJ2YWJsZQogICAgaWYgKCh0eXBlb2YgaW5zdGFuY2UgPT0gImZ1bmN0aW9uIikgJiYgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKSAmJiAoaW5zdGFuY2UuaGFzV3JpdGVGdW5jdGlvbikpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAvLyBBbnl0aGluZyBlbHNlCiAgICByZXR1cm4gZmFsc2U7Cn0KCgprby5leHBvcnRTeW1ib2woJ29ic2VydmFibGUnLCBrby5vYnNlcnZhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCdpc09ic2VydmFibGUnLCBrby5pc09ic2VydmFibGUpOwprby5leHBvcnRTeW1ib2woJ2lzV3JpdGVhYmxlT2JzZXJ2YWJsZScsIGtvLmlzV3JpdGVhYmxlT2JzZXJ2YWJsZSk7CmtvLm9ic2VydmFibGVBcnJheSA9IGZ1bmN0aW9uIChpbml0aWFsVmFsdWVzKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgLy8gWmVyby1wYXJhbWV0ZXIgY29uc3RydWN0b3IgaW5pdGlhbGl6ZXMgdG8gZW1wdHkgYXJyYXkKICAgICAgICBpbml0aWFsVmFsdWVzID0gW107CiAgICB9CiAgICBpZiAoKGluaXRpYWxWYWx1ZXMgIT09IG51bGwpICYmIChpbml0aWFsVmFsdWVzICE9PSB1bmRlZmluZWQpICYmICEoJ2xlbmd0aCcgaW4gaW5pdGlhbFZhbHVlcykpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgYXJndW1lbnQgcGFzc2VkIHdoZW4gaW5pdGlhbGl6aW5nIGFuIG9ic2VydmFibGUgYXJyYXkgbXVzdCBiZSBhbiBhcnJheSwgb3IgbnVsbCwgb3IgdW5kZWZpbmVkLiIpOwoKICAgIHZhciByZXN1bHQgPSBrby5vYnNlcnZhYmxlKGluaXRpYWxWYWx1ZXMpOwogICAga28udXRpbHMuZXh0ZW5kKHJlc3VsdCwga28ub2JzZXJ2YWJsZUFycmF5WydmbiddKTsKICAgIHJldHVybiByZXN1bHQ7Cn0KCmtvLm9ic2VydmFibGVBcnJheVsnZm4nXSA9IHsKICAgICdyZW1vdmUnOiBmdW5jdGlvbiAodmFsdWVPclByZWRpY2F0ZSkgewogICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzLnBlZWsoKTsKICAgICAgICB2YXIgcmVtb3ZlZFZhbHVlcyA9IFtdOwogICAgICAgIHZhciBwcmVkaWNhdGUgPSB0eXBlb2YgdmFsdWVPclByZWRpY2F0ZSA9PSAiZnVuY3Rpb24iID8gdmFsdWVPclByZWRpY2F0ZSA6IGZ1bmN0aW9uICh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgPT09IHZhbHVlT3JQcmVkaWNhdGU7IH07CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1bmRlcmx5aW5nQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdW5kZXJseWluZ0FycmF5W2ldOwogICAgICAgICAgICBpZiAocHJlZGljYXRlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgaWYgKHJlbW92ZWRWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlbW92ZWRWYWx1ZXMucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB1bmRlcmx5aW5nQXJyYXkuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChyZW1vdmVkVmFsdWVzLmxlbmd0aCkgewogICAgICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVtb3ZlZFZhbHVlczsKICAgIH0sCgogICAgJ3JlbW92ZUFsbCc6IGZ1bmN0aW9uIChhcnJheU9mVmFsdWVzKSB7CiAgICAgICAgLy8gSWYgeW91IHBhc3NlZCB6ZXJvIGFyZ3MsIHdlIHJlbW92ZSBldmVyeXRoaW5nCiAgICAgICAgaWYgKGFycmF5T2ZWYWx1ZXMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CiAgICAgICAgICAgIHZhciBhbGxWYWx1ZXMgPSB1bmRlcmx5aW5nQXJyYXkuc2xpY2UoMCk7CiAgICAgICAgICAgIHRoaXMudmFsdWVXaWxsTXV0YXRlKCk7CiAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheS5zcGxpY2UoMCwgdW5kZXJseWluZ0FycmF5Lmxlbmd0aCk7CiAgICAgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CiAgICAgICAgICAgIHJldHVybiBhbGxWYWx1ZXM7CiAgICAgICAgfQogICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byByZW1vdmUKICAgICAgICBpZiAoIWFycmF5T2ZWYWx1ZXMpCiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICByZXR1cm4gdGhpc1sncmVtb3ZlJ10oZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBrby51dGlscy5hcnJheUluZGV4T2YoYXJyYXlPZlZhbHVlcywgdmFsdWUpID49IDA7CiAgICAgICAgfSk7CiAgICB9LAoKICAgICdkZXN0cm95JzogZnVuY3Rpb24gKHZhbHVlT3JQcmVkaWNhdGUpIHsKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CiAgICAgICAgdmFyIHByZWRpY2F0ZSA9IHR5cGVvZiB2YWx1ZU9yUHJlZGljYXRlID09ICJmdW5jdGlvbiIgPyB2YWx1ZU9yUHJlZGljYXRlIDogZnVuY3Rpb24gKHZhbHVlKSB7IHJldHVybiB2YWx1ZSA9PT0gdmFsdWVPclByZWRpY2F0ZTsgfTsKICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwogICAgICAgIGZvciAodmFyIGkgPSB1bmRlcmx5aW5nQXJyYXkubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdW5kZXJseWluZ0FycmF5W2ldOwogICAgICAgICAgICBpZiAocHJlZGljYXRlKHZhbHVlKSkKICAgICAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheVtpXVsiX2Rlc3Ryb3kiXSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CiAgICB9LAoKICAgICdkZXN0cm95QWxsJzogZnVuY3Rpb24gKGFycmF5T2ZWYWx1ZXMpIHsKICAgICAgICAvLyBJZiB5b3UgcGFzc2VkIHplcm8gYXJncywgd2UgZGVzdHJveSBldmVyeXRoaW5nCiAgICAgICAgaWYgKGFycmF5T2ZWYWx1ZXMgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbigpIHsgcmV0dXJuIHRydWUgfSk7CgogICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byBkZXN0cm95CiAgICAgICAgaWYgKCFhcnJheU9mVmFsdWVzKQogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZihhcnJheU9mVmFsdWVzLCB2YWx1ZSkgPj0gMDsKICAgICAgICB9KTsKICAgIH0sCgogICAgJ2luZGV4T2YnOiBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzKCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZih1bmRlcmx5aW5nQXJyYXksIGl0ZW0pOwogICAgfSwKCiAgICAncmVwbGFjZSc6IGZ1bmN0aW9uKG9sZEl0ZW0sIG5ld0l0ZW0pIHsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzWydpbmRleE9mJ10ob2xkSXRlbSk7CiAgICAgICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICAgICAgdGhpcy5wZWVrKClbaW5kZXhdID0gbmV3SXRlbTsKICAgICAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKICAgICAgICB9CiAgICB9Cn0KCi8vIFBvcHVsYXRlIGtvLm9ic2VydmFibGVBcnJheS5mbiB3aXRoIHJlYWQvd3JpdGUgZnVuY3Rpb25zIGZyb20gbmF0aXZlIGFycmF5cwovLyBJbXBvcnRhbnQ6IERvIG5vdCBhZGQgYW55IGFkZGl0aW9uYWwgZnVuY3Rpb25zIGhlcmUgdGhhdCBtYXkgcmVhc29uYWJseSBiZSB1c2VkIHRvICpyZWFkKiBkYXRhIGZyb20gdGhlIGFycmF5Ci8vIGJlY2F1c2Ugd2UnbGwgZXZhbCB0aGVtIHdpdGhvdXQgY2F1c2luZyBzdWJzY3JpcHRpb25zLCBzbyBrby5jb21wdXRlZCBvdXRwdXQgY291bGQgZW5kIHVwIGdldHRpbmcgc3RhbGUKa28udXRpbHMuYXJyYXlGb3JFYWNoKFsicG9wIiwgInB1c2giLCAicmV2ZXJzZSIsICJzaGlmdCIsICJzb3J0IiwgInNwbGljZSIsICJ1bnNoaWZ0Il0sIGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CiAgICBrby5vYnNlcnZhYmxlQXJyYXlbJ2ZuJ11bbWV0aG9kTmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gVXNlICJwZWVrIiB0byBhdm9pZCBjcmVhdGluZyBhIHN1YnNjcmlwdGlvbiBpbiBhbnkgY29tcHV0ZWQgdGhhdCB3ZSdyZSBleGVjdXRpbmcgaW4gdGhlIGNvbnRleHQgb2YKICAgICAgICAvLyAoZm9yIGNvbnNpc3RlbmN5IHdpdGggbXV0YXRpbmcgcmVndWxhciBvYnNlcnZhYmxlcykKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CiAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICB2YXIgbWV0aG9kQ2FsbFJlc3VsdCA9IHVuZGVybHlpbmdBcnJheVttZXRob2ROYW1lXS5hcHBseSh1bmRlcmx5aW5nQXJyYXksIGFyZ3VtZW50cyk7CiAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKICAgICAgICByZXR1cm4gbWV0aG9kQ2FsbFJlc3VsdDsKICAgIH07Cn0pOwoKLy8gUG9wdWxhdGUga28ub2JzZXJ2YWJsZUFycmF5LmZuIHdpdGggcmVhZC1vbmx5IGZ1bmN0aW9ucyBmcm9tIG5hdGl2ZSBhcnJheXMKa28udXRpbHMuYXJyYXlGb3JFYWNoKFsic2xpY2UiXSwgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgIGtvLm9ic2VydmFibGVBcnJheVsnZm4nXVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcygpOwogICAgICAgIHJldHVybiB1bmRlcmx5aW5nQXJyYXlbbWV0aG9kTmFtZV0uYXBwbHkodW5kZXJseWluZ0FycmF5LCBhcmd1bWVudHMpOwogICAgfTsKfSk7Cgprby5leHBvcnRTeW1ib2woJ29ic2VydmFibGVBcnJheScsIGtvLm9ic2VydmFibGVBcnJheSk7CmtvLmRlcGVuZGVudE9ic2VydmFibGUgPSBmdW5jdGlvbiAoZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMsIGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0LCBvcHRpb25zKSB7CiAgICB2YXIgX2xhdGVzdFZhbHVlLAogICAgICAgIF9oYXNCZWVuRXZhbHVhdGVkID0gZmFsc2UsCiAgICAgICAgX2lzQmVpbmdFdmFsdWF0ZWQgPSBmYWxzZSwKICAgICAgICByZWFkRnVuY3Rpb24gPSBldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9uczsKCiAgICBpZiAocmVhZEZ1bmN0aW9uICYmIHR5cGVvZiByZWFkRnVuY3Rpb24gPT0gIm9iamVjdCIpIHsKICAgICAgICAvLyBTaW5nbGUtcGFyYW1ldGVyIHN5bnRheCAtIGV2ZXJ5dGhpbmcgaXMgb24gdGhpcyAib3B0aW9ucyIgcGFyYW0KICAgICAgICBvcHRpb25zID0gcmVhZEZ1bmN0aW9uOwogICAgICAgIHJlYWRGdW5jdGlvbiA9IG9wdGlvbnNbInJlYWQiXTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gTXVsdGktcGFyYW1ldGVyIHN5bnRheCAtIGNvbnN0cnVjdCB0aGUgb3B0aW9ucyBhY2NvcmRpbmcgdG8gdGhlIHBhcmFtcyBwYXNzZWQKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICBpZiAoIXJlYWRGdW5jdGlvbikKICAgICAgICAgICAgcmVhZEZ1bmN0aW9uID0gb3B0aW9uc1sicmVhZCJdOwogICAgfQogICAgaWYgKHR5cGVvZiByZWFkRnVuY3Rpb24gIT0gImZ1bmN0aW9uIikKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBhc3MgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBrby5jb21wdXRlZCIpOwoKICAgIGZ1bmN0aW9uIGFkZFN1YnNjcmlwdGlvblRvRGVwZW5kZW5jeShzdWJzY3JpYmFibGUpIHsKICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLnB1c2goc3Vic2NyaWJhYmxlLnN1YnNjcmliZShldmFsdWF0ZVBvc3NpYmx5QXN5bmMpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCkgewogICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uKSB7CiAgICAgICAgICAgIHN1YnNjcmlwdGlvbi5kaXNwb3NlKCk7CiAgICAgICAgfSk7CiAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcyA9IFtdOwogICAgfQoKICAgIGZ1bmN0aW9uIGV2YWx1YXRlUG9zc2libHlBc3luYygpIHsKICAgICAgICB2YXIgdGhyb3R0bGVFdmFsdWF0aW9uVGltZW91dCA9IGRlcGVuZGVudE9ic2VydmFibGVbJ3Rocm90dGxlRXZhbHVhdGlvbiddOwogICAgICAgIGlmICh0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0ICYmIHRocm90dGxlRXZhbHVhdGlvblRpbWVvdXQgPj0gMCkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQoZXZhbHVhdGlvblRpbWVvdXRJbnN0YW5jZSk7CiAgICAgICAgICAgIGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGV2YWx1YXRlSW1tZWRpYXRlLCB0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0KTsKICAgICAgICB9IGVsc2UKICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBldmFsdWF0ZUltbWVkaWF0ZSgpIHsKICAgICAgICBpZiAoX2lzQmVpbmdFdmFsdWF0ZWQpIHsKICAgICAgICAgICAgLy8gSWYgdGhlIGV2YWx1YXRpb24gb2YgYSBrby5jb21wdXRlZCBjYXVzZXMgc2lkZSBlZmZlY3RzLCBpdCdzIHBvc3NpYmxlIHRoYXQgaXQgd2lsbCB0cmlnZ2VyIGl0cyBvd24gcmUtZXZhbHVhdGlvbi4KICAgICAgICAgICAgLy8gVGhpcyBpcyBub3QgZGVzaXJhYmxlIChpdCdzIGhhcmQgZm9yIGEgZGV2ZWxvcGVyIHRvIHJlYWxpc2UgYSBjaGFpbiBvZiBkZXBlbmRlbmNpZXMgbWlnaHQgY2F1c2UgdGhpcywgYW5kIHRoZXkgYWxtb3N0CiAgICAgICAgICAgIC8vIGNlcnRhaW5seSBkaWRuJ3QgaW50ZW5kIGluZmluaXRlIHJlLWV2YWx1YXRpb25zKS4gU28sIGZvciBwcmVkaWN0YWJpbGl0eSwgd2Ugc2ltcGx5IHByZXZlbnQga28uY29tcHV0ZWRzIGZyb20gY2F1c2luZwogICAgICAgICAgICAvLyB0aGVpciBvd24gcmUtZXZhbHVhdGlvbi4gRnVydGhlciBkaXNjdXNzaW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9wdWxsLzM4NwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBEb24ndCBkaXNwb3NlIG9uIGZpcnN0IGV2YWx1YXRpb24sIGJlY2F1c2UgdGhlICJkaXNwb3NlV2hlbiIgY2FsbGJhY2sgbWlnaHQKICAgICAgICAvLyBlLmcuLCBkaXNwb3NlIHdoZW4gdGhlIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnQgaXNuJ3QgaW4gdGhlIGRvYywgYW5kIGl0J3Mgbm90CiAgICAgICAgLy8gZ29pbmcgdG8gYmUgaW4gdGhlIGRvYyB1bnRpbCAqYWZ0ZXIqIHRoZSBmaXJzdCBldmFsdWF0aW9uCiAgICAgICAgaWYgKF9oYXNCZWVuRXZhbHVhdGVkICYmIGRpc3Bvc2VXaGVuKCkpIHsKICAgICAgICAgICAgZGlzcG9zZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBfaXNCZWluZ0V2YWx1YXRlZCA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gSW5pdGlhbGx5LCB3ZSBhc3N1bWUgdGhhdCBub25lIG9mIHRoZSBzdWJzY3JpcHRpb25zIGFyZSBzdGlsbCBiZWluZyB1c2VkIChpLmUuLCBhbGwgYXJlIGNhbmRpZGF0ZXMgZm9yIGRpc3Bvc2FsKS4KICAgICAgICAgICAgLy8gVGhlbiwgZHVyaW5nIGV2YWx1YXRpb24sIHdlIGNyb3NzIG9mZiBhbnkgdGhhdCBhcmUgaW4gZmFjdCBzdGlsbCBiZWluZyB1c2VkLgogICAgICAgICAgICB2YXIgZGlzcG9zYWxDYW5kaWRhdGVzID0ga28udXRpbHMuYXJyYXlNYXAoX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcywgZnVuY3Rpb24oaXRlbSkge3JldHVybiBpdGVtLnRhcmdldDt9KTsKCiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uYmVnaW4oZnVuY3Rpb24oc3Vic2NyaWJhYmxlKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5PbGQ7CiAgICAgICAgICAgICAgICBpZiAoKGluT2xkID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGRpc3Bvc2FsQ2FuZGlkYXRlcywgc3Vic2NyaWJhYmxlKSkgPj0gMCkKICAgICAgICAgICAgICAgICAgICBkaXNwb3NhbENhbmRpZGF0ZXNbaW5PbGRdID0gdW5kZWZpbmVkOyAvLyBEb24ndCB3YW50IHRvIGRpc3Bvc2UgdGhpcyBzdWJzY3JpcHRpb24sIGFzIGl0J3Mgc3RpbGwgYmVpbmcgdXNlZAogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGFkZFN1YnNjcmlwdGlvblRvRGVwZW5kZW5jeShzdWJzY3JpYmFibGUpOyAvLyBCcmFuZCBuZXcgc3Vic2NyaXB0aW9uIC0gYWRkIGl0CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcmVhZEZ1bmN0aW9uLmNhbGwoZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpOwoKICAgICAgICAgICAgLy8gRm9yIGVhY2ggc3Vic2NyaXB0aW9uIG5vIGxvbmdlciBiZWluZyB1c2VkLCByZW1vdmUgaXQgZnJvbSB0aGUgYWN0aXZlIHN1YnNjcmlwdGlvbnMgbGlzdCBhbmQgZGlzcG9zZSBpdAogICAgICAgICAgICBmb3IgKHZhciBpID0gZGlzcG9zYWxDYW5kaWRhdGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBpZiAoZGlzcG9zYWxDYW5kaWRhdGVzW2ldKQogICAgICAgICAgICAgICAgICAgIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMuc3BsaWNlKGksIDEpWzBdLmRpc3Bvc2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfaGFzQmVlbkV2YWx1YXRlZCA9IHRydWU7CgogICAgICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOwogICAgICAgICAgICBfbGF0ZXN0VmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgaWYgKERFQlVHKSBkZXBlbmRlbnRPYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmVuZCgpOwogICAgICAgIH0KCiAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZVsibm90aWZ5U3Vic2NyaWJlcnMiXShfbGF0ZXN0VmFsdWUpOwogICAgICAgIF9pc0JlaW5nRXZhbHVhdGVkID0gZmFsc2U7CiAgICAgICAgaWYgKCFfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLmxlbmd0aCkKICAgICAgICAgICAgZGlzcG9zZSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGRlcGVuZGVudE9ic2VydmFibGUoKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygd3JpdGVGdW5jdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgLy8gV3JpdGluZyBhIHZhbHVlCiAgICAgICAgICAgICAgICB3cml0ZUZ1bmN0aW9uLmFwcGx5KGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0LCBhcmd1bWVudHMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgd3JpdGUgYSB2YWx1ZSB0byBhIGtvLmNvbXB1dGVkIHVubGVzcyB5b3Ugc3BlY2lmeSBhICd3cml0ZScgb3B0aW9uLiBJZiB5b3Ugd2lzaCB0byByZWFkIHRoZSBjdXJyZW50IHZhbHVlLCBkb24ndCBwYXNzIGFueSBwYXJhbWV0ZXJzLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOyAvLyBQZXJtaXRzIGNoYWluZWQgYXNzaWdubWVudHMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBSZWFkaW5nIHRoZSB2YWx1ZQogICAgICAgICAgICBpZiAoIV9oYXNCZWVuRXZhbHVhdGVkKQogICAgICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5yZWdpc3RlckRlcGVuZGVuY3koZGVwZW5kZW50T2JzZXJ2YWJsZSk7CiAgICAgICAgICAgIHJldHVybiBfbGF0ZXN0VmFsdWU7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHBlZWsoKSB7CiAgICAgICAgaWYgKCFfaGFzQmVlbkV2YWx1YXRlZCkKICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKICAgICAgICByZXR1cm4gX2xhdGVzdFZhbHVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzQWN0aXZlKCkgewogICAgICAgIHJldHVybiAhX2hhc0JlZW5FdmFsdWF0ZWQgfHwgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcy5sZW5ndGggPiAwOwogICAgfQoKICAgIC8vIEJ5IGhlcmUsICJvcHRpb25zIiBpcyBhbHdheXMgbm9uLW51bGwKICAgIHZhciB3cml0ZUZ1bmN0aW9uID0gb3B0aW9uc1sid3JpdGUiXSwKICAgICAgICBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQgPSBvcHRpb25zWyJkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQiXSB8fCBvcHRpb25zLmRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCB8fCBudWxsLAogICAgICAgIGRpc3Bvc2VXaGVuID0gb3B0aW9uc1siZGlzcG9zZVdoZW4iXSB8fCBvcHRpb25zLmRpc3Bvc2VXaGVuIHx8IGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH0sCiAgICAgICAgZGlzcG9zZSA9IGRpc3Bvc2VBbGxTdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMsCiAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcyA9IFtdLAogICAgICAgIGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UgPSBudWxsOwoKICAgIGlmICghZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpCiAgICAgICAgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQgPSBvcHRpb25zWyJvd25lciJdOwoKICAgIGRlcGVuZGVudE9ic2VydmFibGUucGVlayA9IHBlZWs7CiAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmdldERlcGVuZGVuY2llc0NvdW50ID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcy5sZW5ndGg7IH07CiAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmhhc1dyaXRlRnVuY3Rpb24gPSB0eXBlb2Ygb3B0aW9uc1sid3JpdGUiXSA9PT0gImZ1bmN0aW9uIjsKICAgIGRlcGVuZGVudE9ic2VydmFibGUuZGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgZGlzcG9zZSgpOyB9OwogICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5pc0FjdGl2ZSA9IGlzQWN0aXZlOwoKICAgIGtvLnN1YnNjcmliYWJsZS5jYWxsKGRlcGVuZGVudE9ic2VydmFibGUpOwogICAga28udXRpbHMuZXh0ZW5kKGRlcGVuZGVudE9ic2VydmFibGUsIGtvLmRlcGVuZGVudE9ic2VydmFibGVbJ2ZuJ10pOwoKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdwZWVrJywgZGVwZW5kZW50T2JzZXJ2YWJsZS5wZWVrKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdkaXNwb3NlJywgZGVwZW5kZW50T2JzZXJ2YWJsZS5kaXNwb3NlKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdpc0FjdGl2ZScsIGRlcGVuZGVudE9ic2VydmFibGUuaXNBY3RpdmUpOwogICAga28uZXhwb3J0UHJvcGVydHkoZGVwZW5kZW50T2JzZXJ2YWJsZSwgJ2dldERlcGVuZGVuY2llc0NvdW50JywgZGVwZW5kZW50T2JzZXJ2YWJsZS5nZXREZXBlbmRlbmNpZXNDb3VudCk7CgogICAgLy8gRXZhbHVhdGUsIHVubGVzcyBkZWZlckV2YWx1YXRpb24gaXMgdHJ1ZQogICAgaWYgKG9wdGlvbnNbJ2RlZmVyRXZhbHVhdGlvbiddICE9PSB0cnVlKQogICAgICAgIGV2YWx1YXRlSW1tZWRpYXRlKCk7CgogICAgLy8gQnVpbGQgImRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCIgYW5kICJkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWRDYWxsYmFjayIgb3B0aW9uIHZhbHVlcy4KICAgIC8vIEJ1dCBza2lwIGlmIGlzQWN0aXZlIGlzIGZhbHNlICh0aGVyZSB3aWxsIG5ldmVyIGJlIGFueSBkZXBlbmRlbmNpZXMgdG8gZGlzcG9zZSkuCiAgICAvLyAoTm90ZTogImRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCIgb3B0aW9uIGJvdGggcHJvYWN0aXZlbHkgZGlzcG9zZXMgYXMgc29vbiBhcyB0aGUgbm9kZSBpcyByZW1vdmVkIHVzaW5nIGtvLnJlbW92ZU5vZGUoKSwKICAgIC8vIHBsdXMgYWRkcyBhICJkaXNwb3NlV2hlbiIgY2FsbGJhY2sgdGhhdCwgb24gZWFjaCBldmFsdWF0aW9uLCBkaXNwb3NlcyBpZiB0aGUgbm9kZSB3YXMgcmVtb3ZlZCBieSBzb21lIG90aGVyIG1lYW5zLikKICAgIGlmIChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQgJiYgaXNBY3RpdmUoKSkgewogICAgICAgIGRpc3Bvc2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLnJlbW92ZURpc3Bvc2VDYWxsYmFjayhkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQsIGFyZ3VtZW50cy5jYWxsZWUpOwogICAgICAgICAgICBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCk7CiAgICAgICAgfTsKICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCwgZGlzcG9zZSk7CiAgICAgICAgdmFyIGV4aXN0aW5nRGlzcG9zZVdoZW5GdW5jdGlvbiA9IGRpc3Bvc2VXaGVuOwogICAgICAgIGRpc3Bvc2VXaGVuID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gIWtvLnV0aWxzLmRvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQpIHx8IGV4aXN0aW5nRGlzcG9zZVdoZW5GdW5jdGlvbigpOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZGVwZW5kZW50T2JzZXJ2YWJsZTsKfTsKCmtvLmlzQ29tcHV0ZWQgPSBmdW5jdGlvbihpbnN0YW5jZSkgewogICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7Cn07Cgp2YXIgcHJvdG9Qcm9wID0ga28ub2JzZXJ2YWJsZS5wcm90b1Byb3BlcnR5OyAvLyA9PSAiX19rb19wcm90b19fIgprby5kZXBlbmRlbnRPYnNlcnZhYmxlW3Byb3RvUHJvcF0gPSBrby5vYnNlcnZhYmxlOwoKa28uZGVwZW5kZW50T2JzZXJ2YWJsZVsnZm4nXSA9IHt9Owprby5kZXBlbmRlbnRPYnNlcnZhYmxlWydmbiddW3Byb3RvUHJvcF0gPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlOwoKa28uZXhwb3J0U3ltYm9sKCdkZXBlbmRlbnRPYnNlcnZhYmxlJywga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7CmtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWQnLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKTsgLy8gTWFrZSAia28uY29tcHV0ZWQiIGFuIGFsaWFzIGZvciAia28uZGVwZW5kZW50T2JzZXJ2YWJsZSIKa28uZXhwb3J0U3ltYm9sKCdpc0NvbXB1dGVkJywga28uaXNDb21wdXRlZCk7CgooZnVuY3Rpb24oKSB7CiAgICB2YXIgbWF4TmVzdGVkT2JzZXJ2YWJsZURlcHRoID0gMTA7IC8vIEVzY2FwZSB0aGUgKHVubGlrZWx5KSBwYXRoYWxvZ2ljYWwgY2FzZSB3aGVyZSBhbiBvYnNlcnZhYmxlJ3MgY3VycmVudCB2YWx1ZSBpcyBpdHNlbGYgKG9yIHNpbWlsYXIgcmVmZXJlbmNlIGN5Y2xlKQoKICAgIGtvLnRvSlMgPSBmdW5jdGlvbihyb290T2JqZWN0KSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXaGVuIGNhbGxpbmcga28udG9KUywgcGFzcyB0aGUgb2JqZWN0IHlvdSB3YW50IHRvIGNvbnZlcnQuIik7CgogICAgICAgIC8vIFdlIGp1c3QgdW53cmFwIGV2ZXJ5dGhpbmcgYXQgZXZlcnkgbGV2ZWwgaW4gdGhlIG9iamVjdCBncmFwaAogICAgICAgIHJldHVybiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIGZ1bmN0aW9uKHZhbHVlVG9NYXApIHsKICAgICAgICAgICAgLy8gTG9vcCBiZWNhdXNlIGFuIG9ic2VydmFibGUncyB2YWx1ZSBtaWdodCBpbiB0dXJuIGJlIGFub3RoZXIgb2JzZXJ2YWJsZSB3cmFwcGVyCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBrby5pc09ic2VydmFibGUodmFsdWVUb01hcCkgJiYgKGkgPCBtYXhOZXN0ZWRPYnNlcnZhYmxlRGVwdGgpOyBpKyspCiAgICAgICAgICAgICAgICB2YWx1ZVRvTWFwID0gdmFsdWVUb01hcCgpOwogICAgICAgICAgICByZXR1cm4gdmFsdWVUb01hcDsKICAgICAgICB9KTsKICAgIH07CgogICAga28udG9KU09OID0gZnVuY3Rpb24ocm9vdE9iamVjdCwgcmVwbGFjZXIsIHNwYWNlKSB7ICAgICAvLyByZXBsYWNlciBhbmQgc3BhY2UgYXJlIG9wdGlvbmFsCiAgICAgICAgdmFyIHBsYWluSmF2YVNjcmlwdE9iamVjdCA9IGtvLnRvSlMocm9vdE9iamVjdCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnN0cmluZ2lmeUpzb24ocGxhaW5KYXZhU2NyaXB0T2JqZWN0LCByZXBsYWNlciwgc3BhY2UpOwogICAgfTsKCiAgICBmdW5jdGlvbiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIG1hcElucHV0Q2FsbGJhY2ssIHZpc2l0ZWRPYmplY3RzKSB7CiAgICAgICAgdmlzaXRlZE9iamVjdHMgPSB2aXNpdGVkT2JqZWN0cyB8fCBuZXcgb2JqZWN0TG9va3VwKCk7CgogICAgICAgIHJvb3RPYmplY3QgPSBtYXBJbnB1dENhbGxiYWNrKHJvb3RPYmplY3QpOwogICAgICAgIHZhciBjYW5IYXZlUHJvcGVydGllcyA9ICh0eXBlb2Ygcm9vdE9iamVjdCA9PSAib2JqZWN0IikgJiYgKHJvb3RPYmplY3QgIT09IG51bGwpICYmIChyb290T2JqZWN0ICE9PSB1bmRlZmluZWQpICYmICghKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBEYXRlKSk7CiAgICAgICAgaWYgKCFjYW5IYXZlUHJvcGVydGllcykKICAgICAgICAgICAgcmV0dXJuIHJvb3RPYmplY3Q7CgogICAgICAgIHZhciBvdXRwdXRQcm9wZXJ0aWVzID0gcm9vdE9iamVjdCBpbnN0YW5jZW9mIEFycmF5ID8gW10gOiB7fTsKICAgICAgICB2aXNpdGVkT2JqZWN0cy5zYXZlKHJvb3RPYmplY3QsIG91dHB1dFByb3BlcnRpZXMpOwoKICAgICAgICB2aXNpdFByb3BlcnRpZXNPckFycmF5RW50cmllcyhyb290T2JqZWN0LCBmdW5jdGlvbihpbmRleGVyKSB7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eVZhbHVlID0gbWFwSW5wdXRDYWxsYmFjayhyb290T2JqZWN0W2luZGV4ZXJdKTsKCiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHByb3BlcnR5VmFsdWUpIHsKICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0UHJvcGVydGllc1tpbmRleGVyXSA9IHByb3BlcnR5VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNseU1hcHBlZFZhbHVlID0gdmlzaXRlZE9iamVjdHMuZ2V0KHByb3BlcnR5VmFsdWUpOwogICAgICAgICAgICAgICAgICAgIG91dHB1dFByb3BlcnRpZXNbaW5kZXhlcl0gPSAocHJldmlvdXNseU1hcHBlZFZhbHVlICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgICAgID8gcHJldmlvdXNseU1hcHBlZFZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgIDogbWFwSnNPYmplY3RHcmFwaChwcm9wZXJ0eVZhbHVlLCBtYXBJbnB1dENhbGxiYWNrLCB2aXNpdGVkT2JqZWN0cyk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIG91dHB1dFByb3BlcnRpZXM7CiAgICB9CgogICAgZnVuY3Rpb24gdmlzaXRQcm9wZXJ0aWVzT3JBcnJheUVudHJpZXMocm9vdE9iamVjdCwgdmlzaXRvckNhbGxiYWNrKSB7CiAgICAgICAgaWYgKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvb3RPYmplY3QubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2soaSk7CgogICAgICAgICAgICAvLyBGb3IgYXJyYXlzLCBhbHNvIHJlc3BlY3QgdG9KU09OIHByb3BlcnR5IGZvciBjdXN0b20gbWFwcGluZ3MgKGZpeGVzICMyNzgpCiAgICAgICAgICAgIGlmICh0eXBlb2Ygcm9vdE9iamVjdFsndG9KU09OJ10gPT0gJ2Z1bmN0aW9uJykKICAgICAgICAgICAgICAgIHZpc2l0b3JDYWxsYmFjaygndG9KU09OJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlOYW1lIGluIHJvb3RPYmplY3QpCiAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2socHJvcGVydHlOYW1lKTsKICAgICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIG9iamVjdExvb2t1cCgpIHsKICAgICAgICB2YXIga2V5cyA9IFtdOwogICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgICB0aGlzLnNhdmUgPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBleGlzdGluZ0luZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGtleXMsIGtleSk7CiAgICAgICAgICAgIGlmIChleGlzdGluZ0luZGV4ID49IDApCiAgICAgICAgICAgICAgICB2YWx1ZXNbZXhpc3RpbmdJbmRleF0gPSB2YWx1ZTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdGhpcy5nZXQgPSBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nSW5kZXggPSBrby51dGlscy5hcnJheUluZGV4T2Yoa2V5cywga2V5KTsKICAgICAgICAgICAgcmV0dXJuIChleGlzdGluZ0luZGV4ID49IDApID8gdmFsdWVzW2V4aXN0aW5nSW5kZXhdIDogdW5kZWZpbmVkOwogICAgICAgIH07CiAgICB9Owp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd0b0pTJywga28udG9KUyk7CmtvLmV4cG9ydFN5bWJvbCgndG9KU09OJywga28udG9KU09OKTsKKGZ1bmN0aW9uICgpIHsKICAgIHZhciBoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5ID0gJ19fa29fX2hhc0RvbURhdGFPcHRpb25WYWx1ZV9fJzsKCiAgICAvLyBOb3JtYWxseSwgU0VMRUNUIGVsZW1lbnRzIGFuZCB0aGVpciBPUFRJT05zIGNhbiBvbmx5IHRha2UgdmFsdWUgb2YgdHlwZSAnc3RyaW5nJyAoYmVjYXVzZSB0aGUgdmFsdWVzCiAgICAvLyBhcmUgc3RvcmVkIG9uIERPTSBhdHRyaWJ1dGVzKS4ga28uc2VsZWN0RXh0ZW5zaW9ucyBwcm92aWRlcyBhIHdheSBmb3IgU0VMRUNUcy9PUFRJT05zIHRvIGhhdmUgdmFsdWVzCiAgICAvLyB0aGF0IGFyZSBhcmJpdHJhcnkgb2JqZWN0cy4gVGhpcyBpcyB2ZXJ5IGNvbnZlbmllbnQgd2hlbiBpbXBsZW1lbnRpbmcgdGhpbmdzIGxpa2UgY2FzY2FkaW5nIGRyb3Bkb3ducy4KICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMgPSB7CiAgICAgICAgcmVhZFZhbHVlIDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewogICAgICAgICAgICAgICAgY2FzZSAnb3B0aW9uJzoKICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XSA9PT0gdHJ1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmllVmVyc2lvbiA8PSA3CiAgICAgICAgICAgICAgICAgICAgICAgID8gKGVsZW1lbnQuZ2V0QXR0cmlidXRlTm9kZSgndmFsdWUnKS5zcGVjaWZpZWQgPyBlbGVtZW50LnZhbHVlIDogZWxlbWVudC50ZXh0KQogICAgICAgICAgICAgICAgICAgICAgICA6IGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnNlbGVjdGVkSW5kZXggPj0gMCA/IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tlbGVtZW50LnNlbGVjdGVkSW5kZXhdKSA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICB3cml0ZVZhbHVlOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewogICAgICAgICAgICAgICAgY2FzZSAnb3B0aW9uJzoKICAgICAgICAgICAgICAgICAgICBzd2l0Y2godHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnMub3B0aW9ucy5vcHRpb25WYWx1ZURvbURhdGFLZXksIHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzRG9tRGF0YUV4cGFuZG9Qcm9wZXJ0eSBpbiBlbGVtZW50KSB7IC8vIElFIDw9IDggdGhyb3dzIGVycm9ycyBpZiB5b3UgZGVsZXRlIG5vbi1leGlzdGVudCBwcm9wZXJ0aWVzIGZyb20gYSBET00gbm9kZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBlbGVtZW50W2hhc0RvbURhdGFFeHBhbmRvUHJvcGVydHldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9yZSBhcmJpdHJhcnkgb2JqZWN0IHVzaW5nIERvbURhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3BlY2lhbCB0cmVhdG1lbnQgb2YgbnVtYmVycyBpcyBqdXN0IGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LiBLTyAxLjIuMSB3cm90ZSBudW1lcmljYWwgdmFsdWVzIHRvIGVsZW1lbnQudmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiA/IHZhbHVlIDogIiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBlbGVtZW50Lm9wdGlvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tpXSkgPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc2VsZWN0ZWRJbmRleCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gbnVsbCkgfHwgKHZhbHVlID09PSB1bmRlZmluZWQpKQogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICIiOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ3NlbGVjdEV4dGVuc2lvbnMnLCBrby5zZWxlY3RFeHRlbnNpb25zKTsKa28uZXhwb3J0U3ltYm9sKCdzZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZScsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKTsKa28uZXhwb3J0U3ltYm9sKCdzZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUnLCBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUpOwprby5leHByZXNzaW9uUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciByZXN0b3JlQ2FwdHVyZWRUb2tlbnNSZWdleCA9IC9cQGtvX3Rva2VuXyhcZCspXEAvZzsKICAgIHZhciBqYXZhU2NyaXB0UmVzZXJ2ZWRXb3JkcyA9IFsidHJ1ZSIsICJmYWxzZSJdOwoKICAgIC8vIE1hdGNoZXMgc29tZXRoaW5nIHRoYXQgY2FuIGJlIGFzc2lnbmVkIHRvLS1laXRoZXIgYW4gaXNvbGF0ZWQgaWRlbnRpZmllciBvciBzb21ldGhpbmcgZW5kaW5nIHdpdGggYSBwcm9wZXJ0eSBhY2Nlc3NvcgogICAgLy8gVGhpcyBpcyBkZXNpZ25lZCB0byBiZSBzaW1wbGUgYW5kIGF2b2lkIGZhbHNlIG5lZ2F0aXZlcywgYnV0IGNvdWxkIHByb2R1Y2UgZmFsc2UgcG9zaXRpdmVzIChlLmcuLCBhK2IuYykuCiAgICB2YXIgamF2YVNjcmlwdEFzc2lnbm1lbnRUYXJnZXQgPSAvXig/OlskX2Etel1bJFx3XSp8KC4rKShcLlxzKlskX2Etel1bJFx3XSp8XFsuK1xdKSkkL2k7CgogICAgZnVuY3Rpb24gcmVzdG9yZVRva2VucyhzdHJpbmcsIHRva2VucykgewogICAgICAgIHZhciBwcmV2VmFsdWUgPSBudWxsOwogICAgICAgIHdoaWxlIChzdHJpbmcgIT0gcHJldlZhbHVlKSB7IC8vIEtlZXAgcmVzdG9yaW5nIHRva2VucyB1bnRpbCBpdCBubyBsb25nZXIgbWFrZXMgYSBkaWZmZXJlbmNlICh0aGV5IG1heSBiZSBuZXN0ZWQpCiAgICAgICAgICAgIHByZXZWYWx1ZSA9IHN0cmluZzsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UocmVzdG9yZUNhcHR1cmVkVG9rZW5zUmVnZXgsIGZ1bmN0aW9uIChtYXRjaCwgdG9rZW5JbmRleCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRva2Vuc1t0b2tlbkluZGV4XTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHJpbmc7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0V3JpdGVhYmxlVmFsdWUoZXhwcmVzc2lvbikgewogICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YoamF2YVNjcmlwdFJlc2VydmVkV29yZHMsIGtvLnV0aWxzLnN0cmluZ1RyaW0oZXhwcmVzc2lvbikudG9Mb3dlckNhc2UoKSkgPj0gMCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHZhciBtYXRjaCA9IGV4cHJlc3Npb24ubWF0Y2goamF2YVNjcmlwdEFzc2lnbm1lbnRUYXJnZXQpOwogICAgICAgIHJldHVybiBtYXRjaCA9PT0gbnVsbCA/IGZhbHNlIDogbWF0Y2hbMV0gPyAoJ09iamVjdCgnICsgbWF0Y2hbMV0gKyAnKScgKyBtYXRjaFsyXSkgOiBleHByZXNzaW9uOwogICAgfQoKICAgIGZ1bmN0aW9uIGVuc3VyZVF1b3RlZChrZXkpIHsKICAgICAgICB2YXIgdHJpbW1lZEtleSA9IGtvLnV0aWxzLnN0cmluZ1RyaW0oa2V5KTsKICAgICAgICBzd2l0Y2ggKHRyaW1tZWRLZXkubGVuZ3RoICYmIHRyaW1tZWRLZXkuY2hhckF0KDApKSB7CiAgICAgICAgICAgIGNhc2UgIiciOgogICAgICAgICAgICBjYXNlICciJzoKICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gIiciICsgdHJpbW1lZEtleSArICInIjsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBiaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnM6IFtdLAoKICAgICAgICBwYXJzZU9iamVjdExpdGVyYWw6IGZ1bmN0aW9uKG9iamVjdExpdGVyYWxTdHJpbmcpIHsKICAgICAgICAgICAgLy8gQSBmdWxsIHRva2VuaXNlcitsZXhlciB3b3VsZCBhZGQgdG9vIG11Y2ggd2VpZ2h0IHRvIHRoaXMgbGlicmFyeSwgc28gaGVyZSdzIGEgc2ltcGxlIHBhcnNlcgogICAgICAgICAgICAvLyB0aGF0IGlzIHN1ZmZpY2llbnQganVzdCB0byBzcGxpdCBhbiBvYmplY3QgbGl0ZXJhbCBzdHJpbmcgaW50byBhIHNldCBvZiB0b3AtbGV2ZWwga2V5LXZhbHVlIHBhaXJzCgogICAgICAgICAgICB2YXIgc3RyID0ga28udXRpbHMuc3RyaW5nVHJpbShvYmplY3RMaXRlcmFsU3RyaW5nKTsKICAgICAgICAgICAgaWYgKHN0ci5sZW5ndGggPCAzKQogICAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICBpZiAoc3RyLmNoYXJBdCgwKSA9PT0gInsiKS8vIElnbm9yZSBhbnkgYnJhY2VzIHN1cnJvdW5kaW5nIHRoZSB3aG9sZSBvYmplY3QgbGl0ZXJhbAogICAgICAgICAgICAgICAgc3RyID0gc3RyLnN1YnN0cmluZygxLCBzdHIubGVuZ3RoIC0gMSk7CgogICAgICAgICAgICAvLyBQdWxsIG91dCBhbnkgc3RyaW5nIGxpdGVyYWxzIGFuZCByZWdleCBsaXRlcmFscwogICAgICAgICAgICB2YXIgdG9rZW5zID0gW107CiAgICAgICAgICAgIHZhciB0b2tlblN0YXJ0ID0gbnVsbCwgdG9rZW5FbmRDaGFyOwogICAgICAgICAgICBmb3IgKHZhciBwb3NpdGlvbiA9IDA7IHBvc2l0aW9uIDwgc3RyLmxlbmd0aDsgcG9zaXRpb24rKykgewogICAgICAgICAgICAgICAgdmFyIGMgPSBzdHIuY2hhckF0KHBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh0b2tlblN0YXJ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJyInOgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICInIjoKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiLyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlblN0YXJ0ID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbkVuZENoYXIgPSBjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoYyA9PSB0b2tlbkVuZENoYXIpICYmIChzdHIuY2hhckF0KHBvc2l0aW9uIC0gMSkgIT09ICJcXCIpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gc3RyLnN1YnN0cmluZyh0b2tlblN0YXJ0LCBwb3NpdGlvbiArIDEpOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVwbGFjZW1lbnQgPSAiQGtvX3Rva2VuXyIgKyAodG9rZW5zLmxlbmd0aCAtIDEpICsgIkAiOwogICAgICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoMCwgdG9rZW5TdGFydCkgKyByZXBsYWNlbWVudCArIHN0ci5zdWJzdHJpbmcocG9zaXRpb24gKyAxKTsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiAtPSAodG9rZW4ubGVuZ3RoIC0gcmVwbGFjZW1lbnQubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICB0b2tlblN0YXJ0ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTmV4dCBwdWxsIG91dCBiYWxhbmNlZCBwYXJlbiwgYnJhY2UsIGFuZCBicmFja2V0IGJsb2NrcwogICAgICAgICAgICB0b2tlblN0YXJ0ID0gbnVsbDsKICAgICAgICAgICAgdG9rZW5FbmRDaGFyID0gbnVsbDsKICAgICAgICAgICAgdmFyIHRva2VuRGVwdGggPSAwLCB0b2tlblN0YXJ0Q2hhciA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIHBvc2l0aW9uID0gMDsgcG9zaXRpb24gPCBzdHIubGVuZ3RoOyBwb3NpdGlvbisrKSB7CiAgICAgICAgICAgICAgICB2YXIgYyA9IHN0ci5jaGFyQXQocG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRva2VuU3RhcnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAieyI6IHRva2VuU3RhcnQgPSBwb3NpdGlvbjsgdG9rZW5TdGFydENoYXIgPSBjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5FbmRDaGFyID0gIn0iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIigiOiB0b2tlblN0YXJ0ID0gcG9zaXRpb247IHRva2VuU3RhcnRDaGFyID0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuRW5kQ2hhciA9ICIpIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJbIjogdG9rZW5TdGFydCA9IHBvc2l0aW9uOyB0b2tlblN0YXJ0Q2hhciA9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbkVuZENoYXIgPSAiXSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGMgPT09IHRva2VuU3RhcnRDaGFyKQogICAgICAgICAgICAgICAgICAgIHRva2VuRGVwdGgrKzsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGMgPT09IHRva2VuRW5kQ2hhcikgewogICAgICAgICAgICAgICAgICAgIHRva2VuRGVwdGgtLTsKICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW5EZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBzdHIuc3Vic3RyaW5nKHRva2VuU3RhcnQsIHBvc2l0aW9uICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlcGxhY2VtZW50ID0gIkBrb190b2tlbl8iICsgKHRva2Vucy5sZW5ndGggLSAxKSArICJAIjsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyLnN1YnN0cmluZygwLCB0b2tlblN0YXJ0KSArIHJlcGxhY2VtZW50ICsgc3RyLnN1YnN0cmluZyhwb3NpdGlvbiArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiAtPSAodG9rZW4ubGVuZ3RoIC0gcmVwbGFjZW1lbnQubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5TdGFydCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOb3cgd2UgY2FuIHNhZmVseSBzcGxpdCBvbiBjb21tYXMgdG8gZ2V0IHRoZSBrZXkvdmFsdWUgcGFpcnMKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICB2YXIga2V5VmFsdWVQYWlycyA9IHN0ci5zcGxpdCgiLCIpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGtleVZhbHVlUGFpcnMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFpciA9IGtleVZhbHVlUGFpcnNbaV07CiAgICAgICAgICAgICAgICB2YXIgY29sb25Qb3MgPSBwYWlyLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgICAgIGlmICgoY29sb25Qb3MgPiAwKSAmJiAoY29sb25Qb3MgPCBwYWlyLmxlbmd0aCAtIDEpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IHBhaXIuc3Vic3RyaW5nKDAsIGNvbG9uUG9zKTsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBwYWlyLnN1YnN0cmluZyhjb2xvblBvcyArIDEpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHsgJ2tleSc6IHJlc3RvcmVUb2tlbnMoa2V5LCB0b2tlbnMpLCAndmFsdWUnOiByZXN0b3JlVG9rZW5zKHZhbHVlLCB0b2tlbnMpIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh7ICd1bmtub3duJzogcmVzdG9yZVRva2VucyhwYWlyLCB0b2tlbnMpIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAgcHJlUHJvY2Vzc0JpbmRpbmdzOiBmdW5jdGlvbiAob2JqZWN0TGl0ZXJhbFN0cmluZ09yS2V5VmFsdWVBcnJheSkgewogICAgICAgICAgICB2YXIga2V5VmFsdWVBcnJheSA9IHR5cGVvZiBvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5ID09PSAic3RyaW5nIgogICAgICAgICAgICAgICAgPyBrby5leHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbChvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5KQogICAgICAgICAgICAgICAgOiBvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5OwogICAgICAgICAgICB2YXIgcmVzdWx0U3RyaW5ncyA9IFtdLCBwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncyA9IFtdOwoKICAgICAgICAgICAgdmFyIGtleVZhbHVlRW50cnk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBrZXlWYWx1ZUVudHJ5ID0ga2V5VmFsdWVBcnJheVtpXTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0U3RyaW5ncy5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCgiLCIpOwoKICAgICAgICAgICAgICAgIGlmIChrZXlWYWx1ZUVudHJ5WydrZXknXSkgewogICAgICAgICAgICAgICAgICAgIHZhciBxdW90ZWRLZXkgPSBlbnN1cmVRdW90ZWQoa2V5VmFsdWVFbnRyeVsna2V5J10pLCB2YWwgPSBrZXlWYWx1ZUVudHJ5Wyd2YWx1ZSddOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaChxdW90ZWRLZXkpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCgiOiIpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCh2YWwpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodmFsID0gZ2V0V3JpdGVhYmxlVmFsdWUoa28udXRpbHMuc3RyaW5nVHJpbSh2YWwpKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3MubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLnB1c2goIiwgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLnB1c2gocXVvdGVkS2V5ICsgIiA6IGZ1bmN0aW9uKF9fa29fdmFsdWUpIHsgIiArIHZhbCArICIgPSBfX2tvX3ZhbHVlOyB9Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXlWYWx1ZUVudHJ5Wyd1bmtub3duJ10pIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmdzLnB1c2goa2V5VmFsdWVFbnRyeVsndW5rbm93biddKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNvbWJpbmVkUmVzdWx0ID0gcmVzdWx0U3RyaW5ncy5qb2luKCIiKTsKICAgICAgICAgICAgaWYgKHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBhbGxQcm9wZXJ0eUFjY2Vzc29ycyA9IHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLmpvaW4oIiIpOwogICAgICAgICAgICAgICAgY29tYmluZWRSZXN1bHQgPSBjb21iaW5lZFJlc3VsdCArICIsICdfa29fcHJvcGVydHlfd3JpdGVycycgOiB7ICIgKyBhbGxQcm9wZXJ0eUFjY2Vzc29ycyArICIgfSAiOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gY29tYmluZWRSZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAga2V5VmFsdWVBcnJheUNvbnRhaW5zS2V5OiBmdW5jdGlvbihrZXlWYWx1ZUFycmF5LCBrZXkpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlWYWx1ZUFycmF5Lmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLnN0cmluZ1RyaW0oa2V5VmFsdWVBcnJheVtpXVsna2V5J10pID09IGtleSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8vIEludGVybmFsLCBwcml2YXRlIEtPIHV0aWxpdHkgZm9yIHVwZGF0aW5nIG1vZGVsIHByb3BlcnRpZXMgZnJvbSB3aXRoaW4gYmluZGluZ3MKICAgICAgICAvLyBwcm9wZXJ0eTogICAgICAgICAgICBJZiB0aGUgcHJvcGVydHkgYmVpbmcgdXBkYXRlZCBpcyAob3IgbWlnaHQgYmUpIGFuIG9ic2VydmFibGUsIHBhc3MgaXQgaGVyZQogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIElmIGl0IHR1cm5zIG91dCB0byBiZSBhIHdyaXRhYmxlIG9ic2VydmFibGUsIGl0IHdpbGwgYmUgd3JpdHRlbiB0byBkaXJlY3RseQogICAgICAgIC8vIGFsbEJpbmRpbmdzQWNjZXNzb3I6IEFsbCBiaW5kaW5ncyBpbiB0aGUgY3VycmVudCBleGVjdXRpb24gY29udGV4dC4KICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgICBUaGlzIHdpbGwgYmUgc2VhcmNoZWQgZm9yIGEgJ19rb19wcm9wZXJ0eV93cml0ZXJzJyBwcm9wZXJ0eSBpbiBjYXNlIHlvdSdyZSB3cml0aW5nIHRvIGEgbm9uLW9ic2VydmFibGUKICAgICAgICAvLyBrZXk6ICAgICAgICAgICAgICAgICBUaGUga2V5IGlkZW50aWZ5aW5nIHRoZSBwcm9wZXJ0eSB0byBiZSB3cml0dGVuLiBFeGFtcGxlOiBmb3IgeyBoYXNGb2N1czogbXlWYWx1ZSB9LCB3cml0ZSB0byAnbXlWYWx1ZScgYnkgc3BlY2lmeWluZyB0aGUga2V5ICdoYXNGb2N1cycKICAgICAgICAvLyB2YWx1ZTogICAgICAgICAgICAgICBUaGUgdmFsdWUgdG8gYmUgd3JpdHRlbgogICAgICAgIC8vIGNoZWNrSWZEaWZmZXJlbnQ6ICAgIElmIHRydWUsIGFuZCBpZiB0aGUgcHJvcGVydHkgYmVpbmcgd3JpdHRlbiBpcyBhIHdyaXRhYmxlIG9ic2VydmFibGUsIHRoZSB2YWx1ZSB3aWxsIG9ubHkgYmUgd3JpdHRlbiBpZgogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIGl0IGlzICE9PSBleGlzdGluZyB2YWx1ZSBvbiB0aGF0IHdyaXRhYmxlIG9ic2VydmFibGUKICAgICAgICB3cml0ZVZhbHVlVG9Qcm9wZXJ0eTogZnVuY3Rpb24ocHJvcGVydHksIGFsbEJpbmRpbmdzQWNjZXNzb3IsIGtleSwgdmFsdWUsIGNoZWNrSWZEaWZmZXJlbnQpIHsKICAgICAgICAgICAgaWYgKCFwcm9wZXJ0eSB8fCAha28uaXNXcml0ZWFibGVPYnNlcnZhYmxlKHByb3BlcnR5KSkgewogICAgICAgICAgICAgICAgdmFyIHByb3BXcml0ZXJzID0gYWxsQmluZGluZ3NBY2Nlc3NvcigpWydfa29fcHJvcGVydHlfd3JpdGVycyddOwogICAgICAgICAgICAgICAgaWYgKHByb3BXcml0ZXJzICYmIHByb3BXcml0ZXJzW2tleV0pCiAgICAgICAgICAgICAgICAgICAgcHJvcFdyaXRlcnNba2V5XSh2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWNoZWNrSWZEaWZmZXJlbnQgfHwgcHJvcGVydHkucGVlaygpICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgcHJvcGVydHkodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgnZXhwcmVzc2lvblJld3JpdGluZycsIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcpOwprby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzJywga28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnMpOwprby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wYXJzZU9iamVjdExpdGVyYWwpOwprby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcucHJlUHJvY2Vzc0JpbmRpbmdzJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MpOwoKLy8gRm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIGRlZmluZSB0aGUgZm9sbG93aW5nIGFsaWFzZXMuIChQcmV2aW91c2x5LCB0aGVzZSBmdW5jdGlvbiBuYW1lcyB3ZXJlIG1pc2xlYWRpbmcgYmVjYXVzZQovLyB0aGV5IHJlZmVycmVkIHRvIEpTT04gc3BlY2lmaWNhbGx5LCBldmVuIHRob3VnaCB0aGV5IGFjdHVhbGx5IHdvcmsgd2l0aCBhcmJpdHJhcnkgSmF2YVNjcmlwdCBvYmplY3QgbGl0ZXJhbCBleHByZXNzaW9ucy4pCmtvLmV4cG9ydFN5bWJvbCgnanNvbkV4cHJlc3Npb25SZXdyaXRpbmcnLCBrby5leHByZXNzaW9uUmV3cml0aW5nKTsKa28uZXhwb3J0U3ltYm9sKCdqc29uRXhwcmVzc2lvblJld3JpdGluZy5pbnNlcnRQcm9wZXJ0eUFjY2Vzc29yc0ludG9Kc29uJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MpOyhmdW5jdGlvbigpIHsKICAgIC8vICJWaXJ0dWFsIGVsZW1lbnRzIiBpcyBhbiBhYnN0cmFjdGlvbiBvbiB0b3Agb2YgdGhlIHVzdWFsIERPTSBBUEkgd2hpY2ggdW5kZXJzdGFuZHMgdGhlIG5vdGlvbiB0aGF0IGNvbW1lbnQgbm9kZXMKICAgIC8vIG1heSBiZSB1c2VkIHRvIHJlcHJlc2VudCBoaWVyYXJjaHkgKGluIGFkZGl0aW9uIHRvIHRoZSBET00ncyBuYXR1cmFsIGhpZXJhcmNoeSkuCiAgICAvLyBJZiB5b3UgY2FsbCB0aGUgRE9NLW1hbmlwdWxhdGluZyBmdW5jdGlvbnMgb24ga28udmlydHVhbEVsZW1lbnRzLCB5b3Ugd2lsbCBiZSBhYmxlIHRvIHJlYWQgYW5kIHdyaXRlIHRoZSBzdGF0ZQogICAgLy8gb2YgdGhhdCB2aXJ0dWFsIGhpZXJhcmNoeQogICAgLy8KICAgIC8vIFRoZSBwb2ludCBvZiBhbGwgdGhpcyBpcyB0byBzdXBwb3J0IGNvbnRhaW5lcmxlc3MgdGVtcGxhdGVzIChlLmcuLCA8IS0tIGtvIGZvcmVhY2g6c29tZUNvbGxlY3Rpb24gLS0+YmxhaDwhLS0gL2tvIC0tPikKICAgIC8vIHdpdGhvdXQgaGF2aW5nIHRvIHNjYXR0ZXIgc3BlY2lhbCBjYXNlcyBhbGwgb3ZlciB0aGUgYmluZGluZyBhbmQgdGVtcGxhdGluZyBjb2RlLgoKICAgIC8vIElFIDkgY2Fubm90IHJlbGlhYmx5IHJlYWQgdGhlICJub2RlVmFsdWUiIHByb3BlcnR5IG9mIGEgY29tbWVudCBub2RlIChzZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8xODYpCiAgICAvLyBidXQgaXQgZG9lcyBnaXZlIHRoZW0gYSBub25zdGFuZGFyZCBhbHRlcm5hdGl2ZSBwcm9wZXJ0eSBjYWxsZWQgInRleHQiIHRoYXQgaXQgY2FuIHJlYWQgcmVsaWFibHkuIE90aGVyIGJyb3dzZXJzIGRvbid0IGhhdmUgdGhhdCBwcm9wZXJ0eS4KICAgIC8vIFNvLCB1c2Ugbm9kZS50ZXh0IHdoZXJlIGF2YWlsYWJsZSwgYW5kIG5vZGUubm9kZVZhbHVlIGVsc2V3aGVyZQogICAgdmFyIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KCJ0ZXN0IikudGV4dCA9PT0gIjwhLS10ZXN0LS0+IjsKCiAgICB2YXIgc3RhcnRDb21tZW50UmVnZXggPSBjb21tZW50Tm9kZXNIYXZlVGV4dFByb3BlcnR5ID8gL148IS0tXHMqa28oPzpccysoLitccypcOltcc1xTXSopKT9ccyotLT4kLyA6IC9eXHMqa28oPzpccysoLitccypcOltcc1xTXSopKT9ccyokLzsKICAgIHZhciBlbmRDb21tZW50UmVnZXggPSAgIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyAvXjwhLS1ccypcL2tvXHMqLS0+JC8gOiAvXlxzKlwva29ccyokLzsKICAgIHZhciBodG1sVGFnc1dpdGhPcHRpb25hbGx5Q2xvc2luZ0NoaWxkcmVuID0geyAndWwnOiB0cnVlLCAnb2wnOiB0cnVlIH07CgogICAgZnVuY3Rpb24gaXNTdGFydENvbW1lbnQobm9kZSkgewogICAgICAgIHJldHVybiAobm9kZS5ub2RlVHlwZSA9PSA4KSAmJiAoY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IG5vZGUudGV4dCA6IG5vZGUubm9kZVZhbHVlKS5tYXRjaChzdGFydENvbW1lbnRSZWdleCk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNFbmRDb21tZW50KG5vZGUpIHsKICAgICAgICByZXR1cm4gKG5vZGUubm9kZVR5cGUgPT0gOCkgJiYgKGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyBub2RlLnRleHQgOiBub2RlLm5vZGVWYWx1ZSkubWF0Y2goZW5kQ29tbWVudFJlZ2V4KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRWaXJ0dWFsQ2hpbGRyZW4oc3RhcnRDb21tZW50LCBhbGxvd1VuYmFsYW5jZWQpIHsKICAgICAgICB2YXIgY3VycmVudE5vZGUgPSBzdGFydENvbW1lbnQ7CiAgICAgICAgdmFyIGRlcHRoID0gMTsKICAgICAgICB2YXIgY2hpbGRyZW4gPSBbXTsKICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICBpZiAoaXNFbmRDb21tZW50KGN1cnJlbnROb2RlKSkgewogICAgICAgICAgICAgICAgZGVwdGgtLTsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goY3VycmVudE5vZGUpOwoKICAgICAgICAgICAgaWYgKGlzU3RhcnRDb21tZW50KGN1cnJlbnROb2RlKSkKICAgICAgICAgICAgICAgIGRlcHRoKys7CiAgICAgICAgfQogICAgICAgIGlmICghYWxsb3dVbmJhbGFuY2VkKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmaW5kIGNsb3NpbmcgY29tbWVudCB0YWcgdG8gbWF0Y2g6ICIgKyBzdGFydENvbW1lbnQubm9kZVZhbHVlKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRNYXRjaGluZ0VuZENvbW1lbnQoc3RhcnRDb21tZW50LCBhbGxvd1VuYmFsYW5jZWQpIHsKICAgICAgICB2YXIgYWxsVmlydHVhbENoaWxkcmVuID0gZ2V0VmlydHVhbENoaWxkcmVuKHN0YXJ0Q29tbWVudCwgYWxsb3dVbmJhbGFuY2VkKTsKICAgICAgICBpZiAoYWxsVmlydHVhbENoaWxkcmVuKSB7CiAgICAgICAgICAgIGlmIChhbGxWaXJ0dWFsQ2hpbGRyZW4ubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgIHJldHVybiBhbGxWaXJ0dWFsQ2hpbGRyZW5bYWxsVmlydHVhbENoaWxkcmVuLmxlbmd0aCAtIDFdLm5leHRTaWJsaW5nOwogICAgICAgICAgICByZXR1cm4gc3RhcnRDb21tZW50Lm5leHRTaWJsaW5nOwogICAgICAgIH0gZWxzZQogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gTXVzdCBoYXZlIG5vIG1hdGNoaW5nIGVuZCBjb21tZW50LCBhbmQgYWxsb3dVbmJhbGFuY2VkIGlzIHRydWUKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRVbmJhbGFuY2VkQ2hpbGRUYWdzKG5vZGUpIHsKICAgICAgICAvLyBlLmcuLCBmcm9tIDxkaXY+T0s8L2Rpdj48IS0tIGtvIGJsYWggLS0+PHNwYW4+QW5vdGhlcjwvc3Bhbj4sIHJldHVybnM6IDwhLS0ga28gYmxhaCAtLT48c3Bhbj5Bbm90aGVyPC9zcGFuPgogICAgICAgIC8vICAgICAgIGZyb20gPGRpdj5PSzwvZGl2PjwhLS0gL2tvIC0tPjwhLS0gL2tvIC0tPiwgICAgICAgICAgICAgcmV0dXJuczogPCEtLSAva28gLS0+PCEtLSAva28gLS0+CiAgICAgICAgdmFyIGNoaWxkTm9kZSA9IG5vZGUuZmlyc3RDaGlsZCwgY2FwdHVyZVJlbWFpbmluZyA9IG51bGw7CiAgICAgICAgaWYgKGNoaWxkTm9kZSkgewogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBpZiAoY2FwdHVyZVJlbWFpbmluZykgICAgICAgICAgICAgICAgICAgLy8gV2UgYWxyZWFkeSBoaXQgYW4gdW5iYWxhbmNlZCBub2RlIGFuZCBhcmUgbm93IGp1c3Qgc2Nvb3BpbmcgdXAgYWxsIHN1YnNlcXVlbnQgbm9kZXMKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nLnB1c2goY2hpbGROb2RlKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzU3RhcnRDb21tZW50KGNoaWxkTm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2hpbmdFbmRDb21tZW50ID0gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KGNoaWxkTm9kZSwgLyogYWxsb3dVbmJhbGFuY2VkOiAqLyB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hpbmdFbmRDb21tZW50KSAgICAgICAgICAgICAvLyBJdCdzIGEgYmFsYW5jZWQgdGFnLCBzbyBza2lwIGltbWVkaWF0ZWx5IHRvIHRoZSBlbmQgb2YgdGhpcyB2aXJ0dWFsIHNldAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUgPSBtYXRjaGluZ0VuZENvbW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nID0gW2NoaWxkTm9kZV07IC8vIEl0J3MgdW5iYWxhbmNlZCwgc28gc3RhcnQgY2FwdHVyaW5nIGZyb20gdGhpcyBwb2ludAogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0VuZENvbW1lbnQoY2hpbGROb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVSZW1haW5pbmcgPSBbY2hpbGROb2RlXTsgICAgIC8vIEl0J3MgdW5iYWxhbmNlZCAoaWYgaXQgd2Fzbid0LCB3ZSdkIGhhdmUgc2tpcHBlZCBvdmVyIGl0IGFscmVhZHkpLCBzbyBzdGFydCBjYXB0dXJpbmcKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoY2hpbGROb2RlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhcHR1cmVSZW1haW5pbmc7CiAgICB9CgogICAga28udmlydHVhbEVsZW1lbnRzID0gewogICAgICAgIGFsbG93ZWRCaW5kaW5nczoge30sCgogICAgICAgIGNoaWxkTm9kZXM6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGlzU3RhcnRDb21tZW50KG5vZGUpID8gZ2V0VmlydHVhbENoaWxkcmVuKG5vZGUpIDogbm9kZS5jaGlsZE5vZGVzOwogICAgICAgIH0sCgogICAgICAgIGVtcHR5Tm9kZTogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KG5vZGUpKQogICAgICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKG5vZGUpOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB2aXJ0dWFsQ2hpbGRyZW4gPSBrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2Rlcyhub2RlKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmlydHVhbENoaWxkcmVuLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBrby5yZW1vdmVOb2RlKHZpcnR1YWxDaGlsZHJlbltpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzZXREb21Ob2RlQ2hpbGRyZW46IGZ1bmN0aW9uKG5vZGUsIGNoaWxkTm9kZXMpIHsKICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChub2RlKSkKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbihub2RlLCBjaGlsZE5vZGVzKTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKG5vZGUpOwogICAgICAgICAgICAgICAgdmFyIGVuZENvbW1lbnROb2RlID0gbm9kZS5uZXh0U2libGluZzsgLy8gTXVzdCBiZSB0aGUgbmV4dCBzaWJsaW5nLCBhcyB3ZSBqdXN0IGVtcHRpZWQgdGhlIGNoaWxkcmVuCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgICAgIGVuZENvbW1lbnROb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkTm9kZXNbaV0sIGVuZENvbW1lbnROb2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHByZXBlbmQ6IGZ1bmN0aW9uKGNvbnRhaW5lck5vZGUsIG5vZGVUb1ByZXBlbmQpIHsKICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChjb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lck5vZGUuZmlyc3RDaGlsZCkKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmluc2VydEJlZm9yZShub2RlVG9QcmVwZW5kLCBjb250YWluZXJOb2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuYXBwZW5kQ2hpbGQobm9kZVRvUHJlcGVuZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTdGFydCBjb21tZW50cyBtdXN0IGFsd2F5cyBoYXZlIGEgcGFyZW50IGFuZCBhdCBsZWFzdCBvbmUgZm9sbG93aW5nIHNpYmxpbmcgKHRoZSBlbmQgY29tbWVudCkKICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvUHJlcGVuZCwgY29udGFpbmVyTm9kZS5uZXh0U2libGluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBpbnNlcnRBZnRlcjogZnVuY3Rpb24oY29udGFpbmVyTm9kZSwgbm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUpIHsKICAgICAgICAgICAgaWYgKCFpbnNlcnRBZnRlck5vZGUpIHsKICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5wcmVwZW5kKGNvbnRhaW5lck5vZGUsIG5vZGVUb0luc2VydCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzU3RhcnRDb21tZW50KGNvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgICAgICAvLyBJbnNlcnQgYWZ0ZXIgaW5zZXJ0aW9uIHBvaW50CiAgICAgICAgICAgICAgICBpZiAoaW5zZXJ0QWZ0ZXJOb2RlLm5leHRTaWJsaW5nKQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuaW5zZXJ0QmVmb3JlKG5vZGVUb0luc2VydCwgaW5zZXJ0QWZ0ZXJOb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmFwcGVuZENoaWxkKG5vZGVUb0luc2VydCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBDaGlsZHJlbiBvZiBzdGFydCBjb21tZW50cyBtdXN0IGFsd2F5cyBoYXZlIGEgcGFyZW50IGFuZCBhdCBsZWFzdCBvbmUgZm9sbG93aW5nIHNpYmxpbmcgKHRoZSBlbmQgY29tbWVudCkKICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUubmV4dFNpYmxpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZmlyc3RDaGlsZDogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KG5vZGUpKQogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgICAgaWYgKCFub2RlLm5leHRTaWJsaW5nIHx8IGlzRW5kQ29tbWVudChub2RlLm5leHRTaWJsaW5nKSkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gbm9kZS5uZXh0U2libGluZzsKICAgICAgICB9LAoKICAgICAgICBuZXh0U2libGluZzogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBpZiAoaXNTdGFydENvbW1lbnQobm9kZSkpCiAgICAgICAgICAgICAgICBub2RlID0gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KG5vZGUpOwogICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyAmJiBpc0VuZENvbW1lbnQobm9kZS5uZXh0U2libGluZykpCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgfSwKCiAgICAgICAgdmlydHVhbE5vZGVCaW5kaW5nVmFsdWU6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgdmFyIHJlZ2V4TWF0Y2ggPSBpc1N0YXJ0Q29tbWVudChub2RlKTsKICAgICAgICAgICAgcmV0dXJuIHJlZ2V4TWF0Y2ggPyByZWdleE1hdGNoWzFdIDogbnVsbDsKICAgICAgICB9LAoKICAgICAgICBub3JtYWxpc2VWaXJ0dWFsRWxlbWVudERvbVN0cnVjdHVyZTogZnVuY3Rpb24oZWxlbWVudFZlcmlmaWVkKSB7CiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTU1CiAgICAgICAgICAgIC8vIChJRSA8PSA4IG9yIElFIDkgcXVpcmtzIG1vZGUgcGFyc2VzIHlvdXIgSFRNTCB3ZWlyZGx5LCB0cmVhdGluZyBjbG9zaW5nIDwvbGk+IHRhZ3MgYXMgaWYgdGhleSBkb24ndCBleGlzdCwgdGhlcmVieSBtb3ZpbmcgY29tbWVudCBub2RlcwogICAgICAgICAgICAvLyB0aGF0IGFyZSBkaXJlY3QgZGVzY2VuZGFudHMgb2YgPHVsPiBpbnRvIHRoZSBwcmVjZWRpbmcgPGxpPikKICAgICAgICAgICAgaWYgKCFodG1sVGFnc1dpdGhPcHRpb25hbGx5Q2xvc2luZ0NoaWxkcmVuW2tvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50VmVyaWZpZWQpXSkKICAgICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNjYW4gaW1tZWRpYXRlIGNoaWxkcmVuIHRvIHNlZSBpZiB0aGV5IGNvbnRhaW4gdW5iYWxhbmNlZCBjb21tZW50IHRhZ3MuIElmIHRoZXkgZG8sIHRob3NlIGNvbW1lbnQgdGFncwogICAgICAgICAgICAvLyBtdXN0IGJlIGludGVuZGVkIHRvIGFwcGVhciAqYWZ0ZXIqIHRoYXQgY2hpbGQsIHNvIG1vdmUgdGhlbSB0aGVyZS4KICAgICAgICAgICAgdmFyIGNoaWxkTm9kZSA9IGVsZW1lbnRWZXJpZmllZC5maXJzdENoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGROb2RlKSB7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkTm9kZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdW5iYWxhbmNlZFRhZ3MgPSBnZXRVbmJhbGFuY2VkQ2hpbGRUYWdzKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmJhbGFuY2VkVGFncykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRml4IHVwIHRoZSBET00gYnkgbW92aW5nIHRoZSB1bmJhbGFuY2VkIHRhZ3MgdG8gd2hlcmUgdGhleSBtb3N0IGxpa2VseSB3ZXJlIGludGVuZGVkIHRvIGJlIHBsYWNlZCAtICphZnRlciogdGhlIGNoaWxkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZVRvSW5zZXJ0QmVmb3JlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1bmJhbGFuY2VkVGFncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlVG9JbnNlcnRCZWZvcmUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRWZXJpZmllZC5pbnNlcnRCZWZvcmUodW5iYWxhbmNlZFRhZ3NbaV0sIG5vZGVUb0luc2VydEJlZm9yZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50VmVyaWZpZWQuYXBwZW5kQ2hpbGQodW5iYWxhbmNlZFRhZ3NbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSB3aGlsZSAoY2hpbGROb2RlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7CmtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzJywga28udmlydHVhbEVsZW1lbnRzKTsKa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzJywga28udmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5ncyk7CmtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZScsIGtvLnZpcnR1YWxFbGVtZW50cy5lbXB0eU5vZGUpOwovL2tvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQnLCBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZCk7ICAgICAvLyBmaXJzdENoaWxkIGlzIG5vdCBtaW5pZmllZAprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcicsIGtvLnZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcik7Ci8va28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcnLCBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcpOyAgIC8vIG5leHRTaWJsaW5nIGlzIG5vdCBtaW5pZmllZAprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5wcmVwZW5kJywga28udmlydHVhbEVsZW1lbnRzLnByZXBlbmQpOwprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4nLCBrby52aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuKTsKKGZ1bmN0aW9uKCkgewogICAgdmFyIGRlZmF1bHRCaW5kaW5nQXR0cmlidXRlTmFtZSA9ICJkYXRhLWJpbmQiOwoKICAgIGtvLmJpbmRpbmdQcm92aWRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYmluZGluZ0NhY2hlID0ge307CiAgICB9OwoKICAgIGtvLnV0aWxzLmV4dGVuZChrby5iaW5kaW5nUHJvdmlkZXIucHJvdG90eXBlLCB7CiAgICAgICAgJ25vZGVIYXNCaW5kaW5ncyc6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgc3dpdGNoIChub2RlLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUpICE9IG51bGw7ICAgLy8gRWxlbWVudAogICAgICAgICAgICAgICAgY2FzZSA4OiByZXR1cm4ga28udmlydHVhbEVsZW1lbnRzLnZpcnR1YWxOb2RlQmluZGluZ1ZhbHVlKG5vZGUpICE9IG51bGw7IC8vIENvbW1lbnQgbm9kZQogICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgJ2dldEJpbmRpbmdzJzogZnVuY3Rpb24obm9kZSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgdmFyIGJpbmRpbmdzU3RyaW5nID0gdGhpc1snZ2V0QmluZGluZ3NTdHJpbmcnXShub2RlLCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIHJldHVybiBiaW5kaW5nc1N0cmluZyA/IHRoaXNbJ3BhcnNlQmluZGluZ3NTdHJpbmcnXShiaW5kaW5nc1N0cmluZywgYmluZGluZ0NvbnRleHQsIG5vZGUpIDogbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIGlzIG9ubHkgdXNlZCBpbnRlcm5hbGx5IGJ5IHRoaXMgZGVmYXVsdCBwcm92aWRlci4KICAgICAgICAvLyBJdCdzIG5vdCBwYXJ0IG9mIHRoZSBpbnRlcmZhY2UgZGVmaW5pdGlvbiBmb3IgYSBnZW5lcmFsIGJpbmRpbmcgcHJvdmlkZXIuCiAgICAgICAgJ2dldEJpbmRpbmdzU3RyaW5nJzogZnVuY3Rpb24obm9kZSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgc3dpdGNoIChub2RlLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUpOyAgIC8vIEVsZW1lbnQKICAgICAgICAgICAgICAgIGNhc2UgODogcmV0dXJuIGtvLnZpcnR1YWxFbGVtZW50cy52aXJ0dWFsTm9kZUJpbmRpbmdWYWx1ZShub2RlKTsgLy8gQ29tbWVudCBub2RlCiAgICAgICAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gaXMgb25seSB1c2VkIGludGVybmFsbHkgYnkgdGhpcyBkZWZhdWx0IHByb3ZpZGVyLgogICAgICAgIC8vIEl0J3Mgbm90IHBhcnQgb2YgdGhlIGludGVyZmFjZSBkZWZpbml0aW9uIGZvciBhIGdlbmVyYWwgYmluZGluZyBwcm92aWRlci4KICAgICAgICAncGFyc2VCaW5kaW5nc1N0cmluZyc6IGZ1bmN0aW9uKGJpbmRpbmdzU3RyaW5nLCBiaW5kaW5nQ29udGV4dCwgbm9kZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdGdW5jdGlvbiA9IGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yVmlhQ2FjaGUoYmluZGluZ3NTdHJpbmcsIHRoaXMuYmluZGluZ0NhY2hlKTsKICAgICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nRnVuY3Rpb24oYmluZGluZ0NvbnRleHQsIG5vZGUpOwogICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gcGFyc2UgYmluZGluZ3MuXG5NZXNzYWdlOiAiICsgZXggKyAiO1xuQmluZGluZ3MgdmFsdWU6ICIgKyBiaW5kaW5nc1N0cmluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCiAgICBrby5iaW5kaW5nUHJvdmlkZXJbJ2luc3RhbmNlJ10gPSBuZXcga28uYmluZGluZ1Byb3ZpZGVyKCk7CgogICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ3NTdHJpbmdFdmFsdWF0b3JWaWFDYWNoZShiaW5kaW5nc1N0cmluZywgY2FjaGUpIHsKICAgICAgICB2YXIgY2FjaGVLZXkgPSBiaW5kaW5nc1N0cmluZzsKICAgICAgICByZXR1cm4gY2FjaGVbY2FjaGVLZXldCiAgICAgICAgICAgIHx8IChjYWNoZVtjYWNoZUtleV0gPSBjcmVhdGVCaW5kaW5nc1N0cmluZ0V2YWx1YXRvcihiaW5kaW5nc1N0cmluZykpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yKGJpbmRpbmdzU3RyaW5nKSB7CiAgICAgICAgLy8gQnVpbGQgdGhlIHNvdXJjZSBmb3IgYSBmdW5jdGlvbiB0aGF0IGV2YWx1YXRlcyAiZXhwcmVzc2lvbiIKICAgICAgICAvLyBGb3IgZWFjaCBzY29wZSB2YXJpYWJsZSwgYWRkIGFuIGV4dHJhIGxldmVsIG9mICJ3aXRoIiBuZXN0aW5nCiAgICAgICAgLy8gRXhhbXBsZSByZXN1bHQ6IHdpdGgoc2MxKSB7IHdpdGgoc2MwKSB7IHJldHVybiAoZXhwcmVzc2lvbikgfSB9CiAgICAgICAgdmFyIHJld3JpdHRlbkJpbmRpbmdzID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MoYmluZGluZ3NTdHJpbmcpLAogICAgICAgICAgICBmdW5jdGlvbkJvZHkgPSAid2l0aCgkY29udGV4dCl7d2l0aCgkZGF0YXx8e30pe3JldHVybnsiICsgcmV3cml0dGVuQmluZGluZ3MgKyAifX19IjsKICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCIkY29udGV4dCIsICIkZWxlbWVudCIsIGZ1bmN0aW9uQm9keSk7CiAgICB9Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ2JpbmRpbmdQcm92aWRlcicsIGtvLmJpbmRpbmdQcm92aWRlcik7CihmdW5jdGlvbiAoKSB7CiAgICBrby5iaW5kaW5nSGFuZGxlcnMgPSB7fTsKCiAgICBrby5iaW5kaW5nQ29udGV4dCA9IGZ1bmN0aW9uKGRhdGFJdGVtLCBwYXJlbnRCaW5kaW5nQ29udGV4dCwgZGF0YUl0ZW1BbGlhcykgewogICAgICAgIGlmIChwYXJlbnRCaW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICBrby51dGlscy5leHRlbmQodGhpcywgcGFyZW50QmluZGluZ0NvbnRleHQpOyAvLyBJbmhlcml0ICRyb290IGFuZCBhbnkgY3VzdG9tIHByb3BlcnRpZXMKICAgICAgICAgICAgdGhpc1snJHBhcmVudENvbnRleHQnXSA9IHBhcmVudEJpbmRpbmdDb250ZXh0OwogICAgICAgICAgICB0aGlzWyckcGFyZW50J10gPSBwYXJlbnRCaW5kaW5nQ29udGV4dFsnJGRhdGEnXTsKICAgICAgICAgICAgdGhpc1snJHBhcmVudHMnXSA9IChwYXJlbnRCaW5kaW5nQ29udGV4dFsnJHBhcmVudHMnXSB8fCBbXSkuc2xpY2UoMCk7CiAgICAgICAgICAgIHRoaXNbJyRwYXJlbnRzJ10udW5zaGlmdCh0aGlzWyckcGFyZW50J10pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXNbJyRwYXJlbnRzJ10gPSBbXTsKICAgICAgICAgICAgdGhpc1snJHJvb3QnXSA9IGRhdGFJdGVtOwogICAgICAgICAgICAvLyBFeHBvcnQgJ2tvJyBpbiB0aGUgYmluZGluZyBjb250ZXh0IHNvIGl0IHdpbGwgYmUgYXZhaWxhYmxlIGluIGJpbmRpbmdzIGFuZCB0ZW1wbGF0ZXMKICAgICAgICAgICAgLy8gZXZlbiBpZiAna28nIGlzbid0IGV4cG9ydGVkIGFzIGEgZ2xvYmFsLCBzdWNoIGFzIHdoZW4gdXNpbmcgYW4gQU1EIGxvYWRlci4KICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvNDkwCiAgICAgICAgICAgIHRoaXNbJ2tvJ10gPSBrbzsKICAgICAgICB9CiAgICAgICAgdGhpc1snJGRhdGEnXSA9IGRhdGFJdGVtOwogICAgICAgIGlmIChkYXRhSXRlbUFsaWFzKQogICAgICAgICAgICB0aGlzW2RhdGFJdGVtQWxpYXNdID0gZGF0YUl0ZW07CiAgICB9CiAgICBrby5iaW5kaW5nQ29udGV4dC5wcm90b3R5cGVbJ2NyZWF0ZUNoaWxkQ29udGV4dCddID0gZnVuY3Rpb24gKGRhdGFJdGVtLCBkYXRhSXRlbUFsaWFzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBrby5iaW5kaW5nQ29udGV4dChkYXRhSXRlbSwgdGhpcywgZGF0YUl0ZW1BbGlhcyk7CiAgICB9OwogICAga28uYmluZGluZ0NvbnRleHQucHJvdG90eXBlWydleHRlbmQnXSA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpIHsKICAgICAgICB2YXIgY2xvbmUgPSBrby51dGlscy5leHRlbmQobmV3IGtvLmJpbmRpbmdDb250ZXh0KCksIHRoaXMpOwogICAgICAgIHJldHVybiBrby51dGlscy5leHRlbmQoY2xvbmUsIHByb3BlcnRpZXMpOwogICAgfTsKCiAgICBmdW5jdGlvbiB2YWxpZGF0ZVRoYXRCaW5kaW5nSXNBbGxvd2VkRm9yVmlydHVhbEVsZW1lbnRzKGJpbmRpbmdOYW1lKSB7CiAgICAgICAgdmFyIHZhbGlkYXRvciA9IGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbYmluZGluZ05hbWVdOwogICAgICAgIGlmICghdmFsaWRhdG9yKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBiaW5kaW5nICciICsgYmluZGluZ05hbWUgKyAiJyBjYW5ub3QgYmUgdXNlZCB3aXRoIHZpcnR1YWwgZWxlbWVudHMiKQogICAgfQoKICAgIGZ1bmN0aW9uIGFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzSW50ZXJuYWwgKHZpZXdNb2RlbCwgZWxlbWVudE9yVmlydHVhbEVsZW1lbnQsIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CiAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCwgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZChlbGVtZW50T3JWaXJ0dWFsRWxlbWVudCk7CiAgICAgICAgd2hpbGUgKGN1cnJlbnRDaGlsZCA9IG5leHRJblF1ZXVlKSB7CiAgICAgICAgICAgIC8vIEtlZXAgYSByZWNvcmQgb2YgdGhlIG5leHQgY2hpbGQgKmJlZm9yZSogYXBwbHlpbmcgYmluZGluZ3MsIGluIGNhc2UgdGhlIGJpbmRpbmcgcmVtb3ZlcyB0aGUgY3VycmVudCBjaGlsZCBmcm9tIGl0cyBwb3NpdGlvbgogICAgICAgICAgICBuZXh0SW5RdWV1ZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhjdXJyZW50Q2hpbGQpOwogICAgICAgICAgICBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIGN1cnJlbnRDaGlsZCwgYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCAodmlld01vZGVsLCBub2RlVmVyaWZpZWQsIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpIHsKICAgICAgICB2YXIgc2hvdWxkQmluZERlc2NlbmRhbnRzID0gdHJ1ZTsKCiAgICAgICAgLy8gUGVyZiBvcHRpbWlzYXRpb246IEFwcGx5IGJpbmRpbmdzIG9ubHkgaWYuLi4KICAgICAgICAvLyAoMSkgV2UgbmVlZCB0byBzdG9yZSB0aGUgYmluZGluZyBjb250ZXh0IG9uIHRoaXMgbm9kZSAoYmVjYXVzZSBpdCBtYXkgZGlmZmVyIGZyb20gdGhlIERPTSBwYXJlbnQgbm9kZSdzIGJpbmRpbmcgY29udGV4dCkKICAgICAgICAvLyAgICAgTm90ZSB0aGF0IHdlIGNhbid0IHN0b3JlIGJpbmRpbmcgY29udGV4dHMgb24gbm9uLWVsZW1lbnRzIChlLmcuLCB0ZXh0IG5vZGVzKSwgYXMgSUUgZG9lc24ndCBhbGxvdyBleHBhbmRvIHByb3BlcnRpZXMgZm9yIHRob3NlCiAgICAgICAgLy8gKDIpIEl0IG1pZ2h0IGhhdmUgYmluZGluZ3MgKGUuZy4sIGl0IGhhcyBhIGRhdGEtYmluZCBhdHRyaWJ1dGUsIG9yIGl0J3MgYSBtYXJrZXIgZm9yIGEgY29udGFpbmVybGVzcyB0ZW1wbGF0ZSkKICAgICAgICB2YXIgaXNFbGVtZW50ID0gKG5vZGVWZXJpZmllZC5ub2RlVHlwZSA9PT0gMSk7CiAgICAgICAgaWYgKGlzRWxlbWVudCkgLy8gV29ya2Fyb3VuZCBJRSA8PSA4IEhUTUwgcGFyc2luZyB3ZWlyZG5lc3MKICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLm5vcm1hbGlzZVZpcnR1YWxFbGVtZW50RG9tU3RydWN0dXJlKG5vZGVWZXJpZmllZCk7CgogICAgICAgIHZhciBzaG91bGRBcHBseUJpbmRpbmdzID0gKGlzRWxlbWVudCAmJiBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSAgICAgICAgICAgICAvLyBDYXNlICgxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfHwga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddWydub2RlSGFzQmluZGluZ3MnXShub2RlVmVyaWZpZWQpOyAgICAgICAvLyBDYXNlICgyKQogICAgICAgIGlmIChzaG91bGRBcHBseUJpbmRpbmdzKQogICAgICAgICAgICBzaG91bGRCaW5kRGVzY2VuZGFudHMgPSBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwobm9kZVZlcmlmaWVkLCBudWxsLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpLnNob3VsZEJpbmREZXNjZW5kYW50czsKCiAgICAgICAgaWYgKHNob3VsZEJpbmREZXNjZW5kYW50cykgewogICAgICAgICAgICAvLyBXZSdyZSByZWN1cnNpbmcgYXV0b21hdGljYWxseSBpbnRvIChyZWFsIG9yIHZpcnR1YWwpIGNoaWxkIG5vZGVzIHdpdGhvdXQgY2hhbmdpbmcgYmluZGluZyBjb250ZXh0cy4gU28sCiAgICAgICAgICAgIC8vICAqIEZvciBjaGlsZHJlbiBvZiBhICpyZWFsKiBlbGVtZW50LCB0aGUgYmluZGluZyBjb250ZXh0IGlzIGNlcnRhaW5seSB0aGUgc2FtZSBhcyBvbiB0aGVpciBET00gLnBhcmVudE5vZGUsCiAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIGZhbHNlCiAgICAgICAgICAgIC8vICAqIEZvciBjaGlsZHJlbiBvZiBhICp2aXJ0dWFsKiBlbGVtZW50LCB3ZSBjYW4ndCBiZSBzdXJlLiBFdmFsdWF0aW5nIC5wYXJlbnROb2RlIG9uIHRob3NlIGNoaWxkcmVuIG1heQogICAgICAgICAgICAvLyAgICBza2lwIG92ZXIgYW55IG51bWJlciBvZiBpbnRlcm1lZGlhdGUgdmlydHVhbCBlbGVtZW50cywgYW55IG9mIHdoaWNoIG1pZ2h0IGRlZmluZSBhIGN1c3RvbSBiaW5kaW5nIGNvbnRleHQsCiAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIHRydWUKICAgICAgICAgICAgYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIG5vZGVWZXJpZmllZCwgLyogYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQ6ICovICFpc0VsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwgKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0LCBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CiAgICAgICAgLy8gTmVlZCB0byBiZSBzdXJlIHRoYXQgaW5pdHMgYXJlIG9ubHkgcnVuIG9uY2UsIGFuZCB1cGRhdGVzIG5ldmVyIHJ1biB1bnRpbCBhbGwgdGhlIGluaXRzIGhhdmUgYmVlbiBydW4KICAgICAgICB2YXIgaW5pdFBoYXNlID0gMDsgLy8gMCA9IGJlZm9yZSBhbGwgaW5pdHMsIDEgPSBkdXJpbmcgaW5pdHMsIDIgPSBhZnRlciBhbGwgaW5pdHMKCiAgICAgICAgLy8gRWFjaCB0aW1lIHRoZSBkZXBlbmRlbnRPYnNlcnZhYmxlIGlzIGV2YWx1YXRlZCAoYWZ0ZXIgZGF0YSBjaGFuZ2VzKSwKICAgICAgICAvLyB0aGUgYmluZGluZyBhdHRyaWJ1dGUgaXMgcmVwYXJzZWQgc28gdGhhdCBpdCBjYW4gcGljayBvdXQgdGhlIGNvcnJlY3QKICAgICAgICAvLyBtb2RlbCBwcm9wZXJ0aWVzIGluIHRoZSBjb250ZXh0IG9mIHRoZSBjaGFuZ2VkIGRhdGEuCiAgICAgICAgLy8gRE9NIGV2ZW50IGNhbGxiYWNrcyBuZWVkIHRvIGJlIGFibGUgdG8gYWNjZXNzIHRoaXMgY2hhbmdlZCBkYXRhLAogICAgICAgIC8vIHNvIHdlIG5lZWQgYSBzaW5nbGUgcGFyc2VkQmluZGluZ3MgdmFyaWFibGUgKHNoYXJlZCBieSBhbGwgY2FsbGJhY2tzCiAgICAgICAgLy8gYXNzb2NpYXRlZCB3aXRoIHRoaXMgbm9kZSdzIGJpbmRpbmdzKSB0aGF0IGFsbCB0aGUgY2xvc3VyZXMgY2FuIGFjY2Vzcy4KICAgICAgICB2YXIgcGFyc2VkQmluZGluZ3M7CiAgICAgICAgZnVuY3Rpb24gbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgeyByZXR1cm4gcGFyc2VkQmluZGluZ3NbYmluZGluZ0tleV0gfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZWRCaW5kaW5nc0FjY2Vzc29yKCkgewogICAgICAgICAgICByZXR1cm4gcGFyc2VkQmluZGluZ3M7CiAgICAgICAgfQoKICAgICAgICB2YXIgYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3M7CiAgICAgICAga28uZGVwZW5kZW50T2JzZXJ2YWJsZSgKICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgYSBub25udWxsIGJpbmRpbmcgY29udGV4dCB0byB3b3JrIHdpdGgKICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nQ29udGV4dEluc3RhbmNlID0gdmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCAmJiAodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCBpbnN0YW5jZW9mIGtvLmJpbmRpbmdDb250ZXh0KQogICAgICAgICAgICAgICAgICAgID8gdmlld01vZGVsT3JCaW5kaW5nQ29udGV4dAogICAgICAgICAgICAgICAgICAgIDogbmV3IGtvLmJpbmRpbmdDb250ZXh0KGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCkpOwogICAgICAgICAgICAgICAgdmFyIHZpZXdNb2RlbCA9IGJpbmRpbmdDb250ZXh0SW5zdGFuY2VbJyRkYXRhJ107CgogICAgICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBEb24ndCBzdG9yZSB0aGUgYmluZGluZyBjb250ZXh0IG9uIHRoaXMgbm9kZSBpZiBpdCdzIGRlZmluaXRlbHkgdGhlIHNhbWUgYXMgb24gbm9kZS5wYXJlbnROb2RlLCBiZWNhdXNlCiAgICAgICAgICAgICAgICAvLyB3ZSBjYW4gZWFzaWx5IHJlY292ZXIgaXQganVzdCBieSBzY2FubmluZyB1cCB0aGUgbm9kZSdzIGFuY2VzdG9ycyBpbiB0aGUgRE9NCiAgICAgICAgICAgICAgICAvLyAobm90ZTogaGVyZSwgcGFyZW50IG5vZGUgbWVhbnMgInJlYWwgRE9NIHBhcmVudCIgbm90ICJ2aXJ0dWFsIHBhcmVudCIsIGFzIHRoZXJlJ3Mgbm8gTygxKSB3YXkgdG8gZmluZCB0aGUgdmlydHVhbCBwYXJlbnQpCiAgICAgICAgICAgICAgICBpZiAoYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkKICAgICAgICAgICAgICAgICAgICBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUobm9kZSwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CgogICAgICAgICAgICAgICAgLy8gVXNlIGV2YWx1YXRlZEJpbmRpbmdzIGlmIGdpdmVuLCBvdGhlcndpc2UgZmFsbCBiYWNrIG9uIGFza2luZyB0aGUgYmluZGluZ3MgcHJvdmlkZXIgdG8gZ2l2ZSB1cyBzb21lIGJpbmRpbmdzCiAgICAgICAgICAgICAgICB2YXIgZXZhbHVhdGVkQmluZGluZ3MgPSAodHlwZW9mIGJpbmRpbmdzID09ICJmdW5jdGlvbiIpID8gYmluZGluZ3MoYmluZGluZ0NvbnRleHRJbnN0YW5jZSwgbm9kZSkgOiBiaW5kaW5nczsKICAgICAgICAgICAgICAgIHBhcnNlZEJpbmRpbmdzID0gZXZhbHVhdGVkQmluZGluZ3MgfHwga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddWydnZXRCaW5kaW5ncyddKG5vZGUsIGJpbmRpbmdDb250ZXh0SW5zdGFuY2UpOwoKICAgICAgICAgICAgICAgIGlmIChwYXJzZWRCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgIC8vIEZpcnN0IHJ1biBhbGwgdGhlIGluaXRzLCBzbyBiaW5kaW5ncyBjYW4gcmVnaXN0ZXIgZm9yIG5vdGlmaWNhdGlvbiBvbiBjaGFuZ2VzCiAgICAgICAgICAgICAgICAgICAgaWYgKGluaXRQaGFzZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbml0UGhhc2UgPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBiaW5kaW5nS2V5IGluIHBhcnNlZEJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nICYmIG5vZGUubm9kZVR5cGUgPT09IDgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVUaGF0QmluZGluZ0lzQWxsb3dlZEZvclZpcnR1YWxFbGVtZW50cyhiaW5kaW5nS2V5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZyAmJiB0eXBlb2YgYmluZGluZ1siaW5pdCJdID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlckluaXRGbiA9IGJpbmRpbmdbImluaXQiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5pdFJlc3VsdCA9IGhhbmRsZXJJbml0Rm4obm9kZSwgbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSksIHBhcnNlZEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgYmluZGluZyBoYW5kbGVyIGNsYWltcyB0byBjb250cm9sIGRlc2NlbmRhbnQgYmluZGluZ3MsIG1ha2UgYSBub3RlIG9mIHRoaXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5pdFJlc3VsdCAmJiBpbml0UmVzdWx0Wydjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNdWx0aXBsZSBiaW5kaW5ncyAoIiArIGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzICsgIiBhbmQgIiArIGJpbmRpbmdLZXkgKyAiKSBhcmUgdHJ5aW5nIHRvIGNvbnRyb2wgZGVzY2VuZGFudCBiaW5kaW5ncyBvZiB0aGUgc2FtZSBlbGVtZW50LiBZb3UgY2Fubm90IHVzZSB0aGVzZSBiaW5kaW5ncyB0b2dldGhlciBvbiB0aGUgc2FtZSBlbGVtZW50LiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyA9IGJpbmRpbmdLZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRQaGFzZSA9IDI7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyAuLi4gdGhlbiBydW4gYWxsIHRoZSB1cGRhdGVzLCB3aGljaCBtaWdodCB0cmlnZ2VyIGNoYW5nZXMgZXZlbiBvbiB0aGUgZmlyc3QgZXZhbHVhdGlvbgogICAgICAgICAgICAgICAgICAgIGlmIChpbml0UGhhc2UgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgYmluZGluZ0tleSBpbiBwYXJzZWRCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBrby5iaW5kaW5nSGFuZGxlcnNbYmluZGluZ0tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZyAmJiB0eXBlb2YgYmluZGluZ1sidXBkYXRlIl0gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyVXBkYXRlRm4gPSBiaW5kaW5nWyJ1cGRhdGUiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyVXBkYXRlRm4obm9kZSwgbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSksIHBhcnNlZEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIDogbm9kZSB9CiAgICAgICAgKTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgc2hvdWxkQmluZERlc2NlbmRhbnRzOiBiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyA9PT0gdW5kZWZpbmVkCiAgICAgICAgfTsKICAgIH07CgogICAgdmFyIHN0b3JlZEJpbmRpbmdDb250ZXh0RG9tRGF0YUtleSA9ICJfX2tvX2JpbmRpbmdDb250ZXh0X18iOwogICAga28uc3RvcmVkQmluZGluZ0NvbnRleHRGb3JOb2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQobm9kZSwgc3RvcmVkQmluZGluZ0NvbnRleHREb21EYXRhS2V5LCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4ga28udXRpbHMuZG9tRGF0YS5nZXQobm9kZSwgc3RvcmVkQmluZGluZ0NvbnRleHREb21EYXRhS2V5KTsKICAgIH0KCiAgICBrby5hcHBseUJpbmRpbmdzVG9Ob2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWwpIHsKICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgLy8gSWYgaXQncyBhbiBlbGVtZW50LCB3b3JrYXJvdW5kIElFIDw9IDggSFRNTCBwYXJzaW5nIHdlaXJkbmVzcwogICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMubm9ybWFsaXNlVmlydHVhbEVsZW1lbnREb21TdHJ1Y3R1cmUobm9kZSk7CiAgICAgICAgcmV0dXJuIGFwcGx5QmluZGluZ3NUb05vZGVJbnRlcm5hbChub2RlLCBiaW5kaW5ncywgdmlld01vZGVsLCB0cnVlKTsKICAgIH07CgogICAga28uYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHMgPSBmdW5jdGlvbih2aWV3TW9kZWwsIHJvb3ROb2RlKSB7CiAgICAgICAgaWYgKHJvb3ROb2RlLm5vZGVUeXBlID09PSAxIHx8IHJvb3ROb2RlLm5vZGVUeXBlID09PSA4KQogICAgICAgICAgICBhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50c0ludGVybmFsKHZpZXdNb2RlbCwgcm9vdE5vZGUsIHRydWUpOwogICAgfTsKCiAgICBrby5hcHBseUJpbmRpbmdzID0gZnVuY3Rpb24gKHZpZXdNb2RlbCwgcm9vdE5vZGUpIHsKICAgICAgICBpZiAocm9vdE5vZGUgJiYgKHJvb3ROb2RlLm5vZGVUeXBlICE9PSAxKSAmJiAocm9vdE5vZGUubm9kZVR5cGUgIT09IDgpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImtvLmFwcGx5QmluZGluZ3M6IGZpcnN0IHBhcmFtZXRlciBzaG91bGQgYmUgeW91ciB2aWV3IG1vZGVsOyBzZWNvbmQgcGFyYW1ldGVyIHNob3VsZCBiZSBhIERPTSBub2RlIik7CiAgICAgICAgcm9vdE5vZGUgPSByb290Tm9kZSB8fCB3aW5kb3cuZG9jdW1lbnQuYm9keTsgLy8gTWFrZSAicm9vdE5vZGUiIHBhcmFtZXRlciBvcHRpb25hbAoKICAgICAgICBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIHJvb3ROb2RlLCB0cnVlKTsKICAgIH07CgogICAgLy8gUmV0cmlldmluZyBiaW5kaW5nIGNvbnRleHQgZnJvbSBhcmJpdHJhcnkgbm9kZXMKICAgIGtvLmNvbnRleHRGb3IgPSBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgLy8gV2UgY2FuIG9ubHkgZG8gc29tZXRoaW5nIG1lYW5pbmdmdWwgZm9yIGVsZW1lbnRzIGFuZCBjb21tZW50IG5vZGVzIChpbiBwYXJ0aWN1bGFyLCBub3QgdGV4dCBub2RlcywgYXMgSUUgY2FuJ3Qgc3RvcmUgZG9tZGF0YSBmb3IgdGhlbSkKICAgICAgICBzd2l0Y2ggKG5vZGUubm9kZVR5cGUpIHsKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IGtvLnN0b3JlZEJpbmRpbmdDb250ZXh0Rm9yTm9kZShub2RlKTsKICAgICAgICAgICAgICAgIGlmIChjb250ZXh0KSByZXR1cm4gY29udGV4dDsKICAgICAgICAgICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpIHJldHVybiBrby5jb250ZXh0Rm9yKG5vZGUucGFyZW50Tm9kZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH07CiAgICBrby5kYXRhRm9yID0gZnVuY3Rpb24obm9kZSkgewogICAgICAgIHZhciBjb250ZXh0ID0ga28uY29udGV4dEZvcihub2RlKTsKICAgICAgICByZXR1cm4gY29udGV4dCA/IGNvbnRleHRbJyRkYXRhJ10gOiB1bmRlZmluZWQ7CiAgICB9OwoKICAgIGtvLmV4cG9ydFN5bWJvbCgnYmluZGluZ0hhbmRsZXJzJywga28uYmluZGluZ0hhbmRsZXJzKTsKICAgIGtvLmV4cG9ydFN5bWJvbCgnYXBwbHlCaW5kaW5ncycsIGtvLmFwcGx5QmluZGluZ3MpOwogICAga28uZXhwb3J0U3ltYm9sKCdhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cycsIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzKTsKICAgIGtvLmV4cG9ydFN5bWJvbCgnYXBwbHlCaW5kaW5nc1RvTm9kZScsIGtvLmFwcGx5QmluZGluZ3NUb05vZGUpOwogICAga28uZXhwb3J0U3ltYm9sKCdjb250ZXh0Rm9yJywga28uY29udGV4dEZvcik7CiAgICBrby5leHBvcnRTeW1ib2woJ2RhdGFGb3InLCBrby5kYXRhRm9yKTsKfSkoKTsKdmFyIGF0dHJIdG1sVG9KYXZhc2NyaXB0TWFwID0geyAnY2xhc3MnOiAnY2xhc3NOYW1lJywgJ2Zvcic6ICdodG1sRm9yJyB9Owprby5iaW5kaW5nSGFuZGxlcnNbJ2F0dHInXSA9IHsKICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpIHx8IHt9OwogICAgICAgIGZvciAodmFyIGF0dHJOYW1lIGluIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXR0ck5hbWUgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHZhciBhdHRyVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlW2F0dHJOYW1lXSk7CgogICAgICAgICAgICAgICAgLy8gVG8gY292ZXIgY2FzZXMgbGlrZSAiYXR0cjogeyBjaGVja2VkOnNvbWVQcm9wIH0iLCB3ZSB3YW50IHRvIHJlbW92ZSB0aGUgYXR0cmlidXRlIGVudGlyZWx5CiAgICAgICAgICAgICAgICAvLyB3aGVuIHNvbWVQcm9wIGlzIGEgIm5vIHZhbHVlIi1saWtlIHZhbHVlIChzdHJpY3RseSBudWxsLCBmYWxzZSwgb3IgdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgLy8gKGJlY2F1c2UgdGhlIGFic2VuY2Ugb2YgdGhlICJjaGVja2VkIiBhdHRyIGlzIGhvdyB0byBtYXJrIGFuIGVsZW1lbnQgYXMgbm90IGNoZWNrZWQsIGV0Yy4pCiAgICAgICAgICAgICAgICB2YXIgdG9SZW1vdmUgPSAoYXR0clZhbHVlID09PSBmYWxzZSkgfHwgKGF0dHJWYWx1ZSA9PT0gbnVsbCkgfHwgKGF0dHJWYWx1ZSA9PT0gdW5kZWZpbmVkKTsKICAgICAgICAgICAgICAgIGlmICh0b1JlbW92ZSkKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShhdHRyTmFtZSk7CgogICAgICAgICAgICAgICAgLy8gSW4gSUUgPD0gNyBhbmQgSUU4IFF1aXJrcyBNb2RlLCB5b3UgaGF2ZSB0byB1c2UgdGhlIEphdmFzY3JpcHQgcHJvcGVydHkgbmFtZSBpbnN0ZWFkIG9mIHRoZQogICAgICAgICAgICAgICAgLy8gSFRNTCBhdHRyaWJ1dGUgbmFtZSBmb3IgY2VydGFpbiBhdHRyaWJ1dGVzLiBJRTggU3RhbmRhcmRzIE1vZGUgc3VwcG9ydHMgdGhlIGNvcnJlY3QgYmVoYXZpb3IsCiAgICAgICAgICAgICAgICAvLyBidXQgaW5zdGVhZCBvZiBmaWd1cmluZyBvdXQgdGhlIG1vZGUsIHdlJ2xsIGp1c3Qgc2V0IHRoZSBhdHRyaWJ1dGUgdGhyb3VnaCB0aGUgSmF2YXNjcmlwdAogICAgICAgICAgICAgICAgLy8gcHJvcGVydHkgZm9yIElFIDw9IDguCiAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuaWVWZXJzaW9uIDw9IDggJiYgYXR0ck5hbWUgaW4gYXR0ckh0bWxUb0phdmFzY3JpcHRNYXApIHsKICAgICAgICAgICAgICAgICAgICBhdHRyTmFtZSA9IGF0dHJIdG1sVG9KYXZhc2NyaXB0TWFwW2F0dHJOYW1lXTsKICAgICAgICAgICAgICAgICAgICBpZiAodG9SZW1vdmUpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGF0dHJOYW1lKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbYXR0ck5hbWVdID0gYXR0clZhbHVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdG9SZW1vdmUpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgYXR0clZhbHVlLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFRyZWF0ICJuYW1lIiBzcGVjaWFsbHkgLSBhbHRob3VnaCB5b3UgY2FuIHRoaW5rIG9mIGl0IGFzIGFuIGF0dHJpYnV0ZSwgaXQgYWxzbyBuZWVkcwogICAgICAgICAgICAgICAgLy8gc3BlY2lhbCBoYW5kbGluZyBvbiBvbGRlciB2ZXJzaW9ucyBvZiBJRSAoaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvMzMzKQogICAgICAgICAgICAgICAgLy8gRGVsaWJlcmF0ZWx5IGJlaW5nIGNhc2Utc2Vuc2l0aXZlIGhlcmUgYmVjYXVzZSBYSFRNTCB3b3VsZCByZWdhcmQgIk5hbWUiIGFzIGEgZGlmZmVyZW50IHRoaW5nCiAgICAgICAgICAgICAgICAvLyBlbnRpcmVseSwgYW5kIHRoZXJlJ3Mgbm8gc3Ryb25nIHJlYXNvbiB0byBhbGxvdyBmb3Igc3VjaCBjYXNpbmcgaW4gSFRNTC4KICAgICAgICAgICAgICAgIGlmIChhdHRyTmFtZSA9PT0gIm5hbWUiKSB7CiAgICAgICAgICAgICAgICAgICAga28udXRpbHMuc2V0RWxlbWVudE5hbWUoZWxlbWVudCwgdG9SZW1vdmUgPyAiIiA6IGF0dHJWYWx1ZS50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWydjaGVja2VkJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgdmFyIHVwZGF0ZUhhbmRsZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PSAiY2hlY2tib3giKSB7CiAgICAgICAgICAgICAgICB2YWx1ZVRvV3JpdGUgPSBlbGVtZW50LmNoZWNrZWQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKGVsZW1lbnQudHlwZSA9PSAicmFkaW8iKSAmJiAoZWxlbWVudC5jaGVja2VkKSkgewogICAgICAgICAgICAgICAgdmFsdWVUb1dyaXRlID0gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybjsgLy8gImNoZWNrZWQiIGJpbmRpbmcgb25seSByZXNwb25kcyB0byBjaGVja2JveGVzIGFuZCBzZWxlY3RlZCByYWRpbyBidXR0b25zCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLCB1bndyYXBwZWRWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobW9kZWxWYWx1ZSk7CiAgICAgICAgICAgIGlmICgoZWxlbWVudC50eXBlID09ICJjaGVja2JveCIpICYmICh1bndyYXBwZWRWYWx1ZSBpbnN0YW5jZW9mIEFycmF5KSkgewogICAgICAgICAgICAgICAgLy8gRm9yIGNoZWNrYm94ZXMgYm91bmQgdG8gYW4gYXJyYXksIHdlIGFkZC9yZW1vdmUgdGhlIGNoZWNrYm94IHZhbHVlIHRvIHRoYXQgYXJyYXkKICAgICAgICAgICAgICAgIC8vIFRoaXMgd29ya3MgZm9yIGJvdGggb2JzZXJ2YWJsZSBhbmQgbm9uLW9ic2VydmFibGUgYXJyYXlzCiAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmdFbnRyeUluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKHVud3JhcHBlZFZhbHVlLCBlbGVtZW50LnZhbHVlKTsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LmNoZWNrZWQgJiYgKGV4aXN0aW5nRW50cnlJbmRleCA8IDApKQogICAgICAgICAgICAgICAgICAgIG1vZGVsVmFsdWUucHVzaChlbGVtZW50LnZhbHVlKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKCghZWxlbWVudC5jaGVja2VkKSAmJiAoZXhpc3RpbmdFbnRyeUluZGV4ID49IDApKQogICAgICAgICAgICAgICAgICAgIG1vZGVsVmFsdWUuc3BsaWNlKGV4aXN0aW5nRW50cnlJbmRleCwgMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzQWNjZXNzb3IsICdjaGVja2VkJywgdmFsdWVUb1dyaXRlLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImNsaWNrIiwgdXBkYXRlSGFuZGxlcik7CgogICAgICAgIC8vIElFIDYgd29uJ3QgYWxsb3cgcmFkaW8gYnV0dG9ucyB0byBiZSBzZWxlY3RlZCB1bmxlc3MgdGhleSBoYXZlIGEgbmFtZQogICAgICAgIGlmICgoZWxlbWVudC50eXBlID09ICJyYWRpbyIpICYmICFlbGVtZW50Lm5hbWUpCiAgICAgICAgICAgIGtvLmJpbmRpbmdIYW5kbGVyc1sndW5pcXVlTmFtZSddWydpbml0J10oZWxlbWVudCwgZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlIH0pOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCiAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PSAiY2hlY2tib3giKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAvLyBXaGVuIGJvdW5kIHRvIGFuIGFycmF5LCB0aGUgY2hlY2tib3ggYmVpbmcgY2hlY2tlZCByZXByZXNlbnRzIGl0cyB2YWx1ZSBiZWluZyBwcmVzZW50IGluIHRoYXQgYXJyYXkKICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZih2YWx1ZSwgZWxlbWVudC52YWx1ZSkgPj0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFdoZW4gYm91bmQgdG8gYW55dGhpbmcgb3RoZXIgdmFsdWUgKG5vdCBhbiBhcnJheSksIHRoZSBjaGVja2JveCBiZWluZyBjaGVja2VkIHJlcHJlc2VudHMgdGhlIHZhbHVlIGJlaW5nIHRydWVpc2gKICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50LnR5cGUgPT0gInJhZGlvIikgewogICAgICAgICAgICBlbGVtZW50LmNoZWNrZWQgPSAoZWxlbWVudC52YWx1ZSA9PSB2YWx1ZSk7CiAgICAgICAgfQogICAgfQp9Owp2YXIgY2xhc3Nlc1dyaXR0ZW5CeUJpbmRpbmdLZXkgPSAnX19rb19fY3NzVmFsdWUnOwprby5iaW5kaW5nSGFuZGxlcnNbJ2NzcyddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgZm9yICh2YXIgY2xhc3NOYW1lIGluIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgc2hvdWxkSGF2ZUNsYXNzID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZVtjbGFzc05hbWVdKTsKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUsIHNob3VsZEhhdmVDbGFzcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9IFN0cmluZyh2YWx1ZSB8fCAnJyk7IC8vIE1ha2Ugc3VyZSB3ZSBkb24ndCB0cnkgdG8gc3RvcmUgb3Igc2V0IGEgbm9uLXN0cmluZyB2YWx1ZQogICAgICAgICAgICBrby51dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MoZWxlbWVudCwgZWxlbWVudFtjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleV0sIGZhbHNlKTsKICAgICAgICAgICAgZWxlbWVudFtjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleV0gPSB2YWx1ZTsKICAgICAgICAgICAga28udXRpbHMudG9nZ2xlRG9tTm9kZUNzc0NsYXNzKGVsZW1lbnQsIHZhbHVlLCB0cnVlKTsKICAgICAgICB9CiAgICB9Cn07CmtvLmJpbmRpbmdIYW5kbGVyc1snZW5hYmxlJ10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgaWYgKHZhbHVlICYmIGVsZW1lbnQuZGlzYWJsZWQpCiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCJkaXNhYmxlZCIpOwogICAgICAgIGVsc2UgaWYgKCghdmFsdWUpICYmICghZWxlbWVudC5kaXNhYmxlZCkpCiAgICAgICAgICAgIGVsZW1lbnQuZGlzYWJsZWQgPSB0cnVlOwogICAgfQp9OwoKa28uYmluZGluZ0hhbmRsZXJzWydkaXNhYmxlJ10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBrby5iaW5kaW5nSGFuZGxlcnNbJ2VuYWJsZSddWyd1cGRhdGUnXShlbGVtZW50LCBmdW5jdGlvbigpIHsgcmV0dXJuICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSkgfSk7CiAgICB9Cn07Ci8vIEZvciBjZXJ0YWluIGNvbW1vbiBldmVudHMgKGN1cnJlbnRseSBqdXN0ICdjbGljaycpLCBhbGxvdyBhIHNpbXBsaWZpZWQgZGF0YS1iaW5kaW5nIHN5bnRheAovLyBlLmcuIGNsaWNrOmhhbmRsZXIgaW5zdGVhZCBvZiB0aGUgdXN1YWwgZnVsbC1sZW5ndGggZXZlbnQ6e2NsaWNrOmhhbmRsZXJ9CmZ1bmN0aW9uIG1ha2VFdmVudEhhbmRsZXJTaG9ydGN1dChldmVudE5hbWUpIHsKICAgIGtvLmJpbmRpbmdIYW5kbGVyc1tldmVudE5hbWVdID0gewogICAgICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsKSB7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZUFjY2Vzc29yID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgcmVzdWx0W2V2ZW50TmFtZV0gPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWydldmVudCddWydpbml0J10uY2FsbCh0aGlzLCBlbGVtZW50LCBuZXdWYWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwpOwogICAgICAgIH0KICAgIH0KfQoKa28uYmluZGluZ0hhbmRsZXJzWydldmVudCddID0gewogICAgJ2luaXQnIDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCkgewogICAgICAgIHZhciBldmVudHNUb0hhbmRsZSA9IHZhbHVlQWNjZXNzb3IoKSB8fCB7fTsKICAgICAgICBmb3IodmFyIGV2ZW50TmFtZU91dHNpZGVDbG9zdXJlIGluIGV2ZW50c1RvSGFuZGxlKSB7CiAgICAgICAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBldmVudE5hbWVPdXRzaWRlQ2xvc3VyZTsgLy8gU2VwYXJhdGUgdmFyaWFibGUgdG8gYmUgY2FwdHVyZWQgYnkgZXZlbnQgaGFuZGxlciBjbG9zdXJlCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGV2ZW50TmFtZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50TmFtZSwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyUmV0dXJuVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyRnVuY3Rpb24gPSB2YWx1ZUFjY2Vzc29yKClbZXZlbnROYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFoYW5kbGVyRnVuY3Rpb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhbGxCaW5kaW5ncyA9IGFsbEJpbmRpbmdzQWNjZXNzb3IoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUYWtlIGFsbCB0aGUgZXZlbnQgYXJncywgYW5kIHByZWZpeCB3aXRoIHRoZSB2aWV3bW9kZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzRm9ySGFuZGxlciA9IGtvLnV0aWxzLm1ha2VBcnJheShhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnc0ZvckhhbmRsZXIudW5zaGlmdCh2aWV3TW9kZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlclJldHVyblZhbHVlID0gaGFuZGxlckZ1bmN0aW9uLmFwcGx5KHZpZXdNb2RlbCwgYXJnc0ZvckhhbmRsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXJSZXR1cm5WYWx1ZSAhPT0gdHJ1ZSkgeyAvLyBOb3JtYWxseSB3ZSB3YW50IHRvIHByZXZlbnQgZGVmYXVsdCBhY3Rpb24uIERldmVsb3BlciBjYW4gb3ZlcnJpZGUgdGhpcyBiZSBleHBsaWNpdGx5IHJldHVybmluZyB0cnVlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBidWJibGUgPSBhbGxCaW5kaW5nc1tldmVudE5hbWUgKyAnQnViYmxlJ10gIT09IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWJ1YmJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkoKTsKICAgICAgICB9CiAgICB9Cn07Ci8vICJmb3JlYWNoOiBzb21lRXhwcmVzc2lvbiIgaXMgZXF1aXZhbGVudCB0byAidGVtcGxhdGU6IHsgZm9yZWFjaDogc29tZUV4cHJlc3Npb24gfSIKLy8gImZvcmVhY2g6IHsgZGF0YTogc29tZUV4cHJlc3Npb24sIGFmdGVyQWRkOiBteWZuIH0iIGlzIGVxdWl2YWxlbnQgdG8gInRlbXBsYXRlOiB7IGZvcmVhY2g6IHNvbWVFeHByZXNzaW9uLCBhZnRlckFkZDogbXlmbiB9Igprby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXSA9IHsKICAgIG1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3I6IGZ1bmN0aW9uKHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLAogICAgICAgICAgICAgICAgdW53cmFwcGVkVmFsdWUgPSBrby51dGlscy5wZWVrT2JzZXJ2YWJsZShtb2RlbFZhbHVlKTsgICAgLy8gVW53cmFwIHdpdGhvdXQgc2V0dGluZyBhIGRlcGVuZGVuY3kgaGVyZQoKICAgICAgICAgICAgLy8gSWYgdW53cmFwcGVkVmFsdWUgaXMgdGhlIGFycmF5LCBwYXNzIGluIHRoZSB3cmFwcGVkIHZhbHVlIG9uIGl0cyBvd24KICAgICAgICAgICAgLy8gVGhlIHZhbHVlIHdpbGwgYmUgdW53cmFwcGVkIGFuZCB0cmFja2VkIHdpdGhpbiB0aGUgdGVtcGxhdGUgYmluZGluZwogICAgICAgICAgICAvLyAoU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvNTIzKQogICAgICAgICAgICBpZiAoKCF1bndyYXBwZWRWYWx1ZSkgfHwgdHlwZW9mIHVud3JhcHBlZFZhbHVlLmxlbmd0aCA9PSAibnVtYmVyIikKICAgICAgICAgICAgICAgIHJldHVybiB7ICdmb3JlYWNoJzogbW9kZWxWYWx1ZSwgJ3RlbXBsYXRlRW5naW5lJzoga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UgfTsKCiAgICAgICAgICAgIC8vIElmIHVud3JhcHBlZFZhbHVlLmRhdGEgaXMgdGhlIGFycmF5LCBwcmVzZXJ2ZSBhbGwgcmVsZXZhbnQgb3B0aW9ucyBhbmQgdW53cmFwIGFnYWluIHZhbHVlIHNvIHdlIGdldCB1cGRhdGVzCiAgICAgICAgICAgIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobW9kZWxWYWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAnZm9yZWFjaCc6IHVud3JhcHBlZFZhbHVlWydkYXRhJ10sCiAgICAgICAgICAgICAgICAnYXMnOiB1bndyYXBwZWRWYWx1ZVsnYXMnXSwKICAgICAgICAgICAgICAgICdpbmNsdWRlRGVzdHJveWVkJzogdW53cmFwcGVkVmFsdWVbJ2luY2x1ZGVEZXN0cm95ZWQnXSwKICAgICAgICAgICAgICAgICdhZnRlckFkZCc6IHVud3JhcHBlZFZhbHVlWydhZnRlckFkZCddLAogICAgICAgICAgICAgICAgJ2JlZm9yZVJlbW92ZSc6IHVud3JhcHBlZFZhbHVlWydiZWZvcmVSZW1vdmUnXSwKICAgICAgICAgICAgICAgICdhZnRlclJlbmRlcic6IHVud3JhcHBlZFZhbHVlWydhZnRlclJlbmRlciddLAogICAgICAgICAgICAgICAgJ2JlZm9yZU1vdmUnOiB1bndyYXBwZWRWYWx1ZVsnYmVmb3JlTW92ZSddLAogICAgICAgICAgICAgICAgJ2FmdGVyTW92ZSc6IHVud3JhcHBlZFZhbHVlWydhZnRlck1vdmUnXSwKICAgICAgICAgICAgICAgICd0ZW1wbGF0ZUVuZ2luZSc6IGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLmluc3RhbmNlCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0sCiAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWydpbml0J10oZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzWydmb3JlYWNoJ10ubWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3Nvcih2YWx1ZUFjY2Vzc29yKSk7CiAgICB9LAogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWyd1cGRhdGUnXShlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KTsKICAgIH0KfTsKa28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnNbJ2ZvcmVhY2gnXSA9IGZhbHNlOyAvLyBDYW4ndCByZXdyaXRlIGNvbnRyb2wgZmxvdyBiaW5kaW5ncwprby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWydmb3JlYWNoJ10gPSB0cnVlOwp2YXIgaGFzZm9jdXNVcGRhdGluZ1Byb3BlcnR5ID0gJ19fa29faGFzZm9jdXNVcGRhdGluZyc7CmtvLmJpbmRpbmdIYW5kbGVyc1snaGFzZm9jdXMnXSA9IHsKICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIHZhciBoYW5kbGVFbGVtZW50Rm9jdXNDaGFuZ2UgPSBmdW5jdGlvbihpc0ZvY3VzZWQpIHsKICAgICAgICAgICAgLy8gV2hlcmUgcG9zc2libGUsIGlnbm9yZSB3aGljaCBldmVudCB3YXMgcmFpc2VkIGFuZCBkZXRlcm1pbmUgZm9jdXMgc3RhdGUgdXNpbmcgYWN0aXZlRWxlbWVudCwKICAgICAgICAgICAgLy8gYXMgdGhpcyBhdm9pZHMgcGhhbnRvbSBmb2N1cy9ibHVyIGV2ZW50cyByYWlzZWQgd2hlbiBjaGFuZ2luZyB0YWJzIGluIG1vZGVybiBicm93c2Vycy4KICAgICAgICAgICAgLy8gSG93ZXZlciwgbm90IGFsbCBLTy10YXJnZXRlZCBicm93c2VycyAoRmlyZWZveCAyKSBzdXBwb3J0IGFjdGl2ZUVsZW1lbnQuIEZvciB0aG9zZSBicm93c2VycywKICAgICAgICAgICAgLy8gcHJldmVudCBhIGxvc3Mgb2YgZm9jdXMgd2hlbiBjaGFuZ2luZyB0YWJzL3dpbmRvd3MgYnkgc2V0dGluZyBhIGZsYWcgdGhhdCBwcmV2ZW50cyBoYXNmb2N1cwogICAgICAgICAgICAvLyBmcm9tIGNhbGxpbmcgJ2JsdXIoKScgb24gdGhlIGVsZW1lbnQgd2hlbiBpdCBsb3NlcyBmb2N1cy4KICAgICAgICAgICAgLy8gRGlzY3Vzc2lvbiBhdCBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvcHVsbC8zNTIKICAgICAgICAgICAgZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIG93bmVyRG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50OwogICAgICAgICAgICBpZiAoImFjdGl2ZUVsZW1lbnQiIGluIG93bmVyRG9jKSB7CiAgICAgICAgICAgICAgICBpc0ZvY3VzZWQgPSAob3duZXJEb2MuYWN0aXZlRWxlbWVudCA9PT0gZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkobW9kZWxWYWx1ZSwgYWxsQmluZGluZ3NBY2Nlc3NvciwgJ2hhc2ZvY3VzJywgaXNGb2N1c2VkLCB0cnVlKTsKICAgICAgICAgICAgZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldID0gZmFsc2U7CiAgICAgICAgfTsKICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzSW4gPSBoYW5kbGVFbGVtZW50Rm9jdXNDaGFuZ2UuYmluZChudWxsLCB0cnVlKTsKICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzT3V0ID0gaGFuZGxlRWxlbWVudEZvY3VzQ2hhbmdlLmJpbmQobnVsbCwgZmFsc2UpOwoKICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiZm9jdXMiLCBoYW5kbGVFbGVtZW50Rm9jdXNJbik7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3VzaW4iLCBoYW5kbGVFbGVtZW50Rm9jdXNJbik7IC8vIEZvciBJRQogICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJibHVyIiwgIGhhbmRsZUVsZW1lbnRGb2N1c091dCk7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3Vzb3V0IiwgIGhhbmRsZUVsZW1lbnRGb2N1c091dCk7IC8vIEZvciBJRQogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIGlmICghZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldKSB7CiAgICAgICAgICAgIHZhbHVlID8gZWxlbWVudC5mb2N1cygpIDogZWxlbWVudC5ibHVyKCk7CiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsIHZhbHVlID8gImZvY3VzaW4iIDogImZvY3Vzb3V0Il0pOyAvLyBGb3IgSUUsIHdoaWNoIGRvZXNuJ3QgcmVsaWFibHkgZmlyZSAiZm9jdXMiIG9yICJibHVyIiBldmVudHMgc3luY2hyb25vdXNseQogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWydodG1sJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIFByZXZlbnQgYmluZGluZyBvbiB0aGUgZHluYW1pY2FsbHktaW5qZWN0ZWQgSFRNTCAoYXMgZGV2ZWxvcGVycyBhcmUgdW5saWtlbHkgdG8gZXhwZWN0IHRoYXQsIGFuZCBpdCBoYXMgc2VjdXJpdHkgaW1wbGljYXRpb25zKQogICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICAvLyBzZXRIdG1sIHdpbGwgdW53cmFwIHRoZSB2YWx1ZSBpZiBuZWVkZWQKICAgICAgICBrby51dGlscy5zZXRIdG1sKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IoKSk7CiAgICB9Cn07CnZhciB3aXRoSWZEb21EYXRhS2V5ID0gJ19fa29fd2l0aElmQmluZGluZ0RhdGEnOwovLyBNYWtlcyBhIGJpbmRpbmcgbGlrZSB3aXRoIG9yIGlmCmZ1bmN0aW9uIG1ha2VXaXRoSWZCaW5kaW5nKGJpbmRpbmdLZXksIGlzV2l0aCwgaXNOb3QsIG1ha2VDb250ZXh0Q2FsbGJhY2spIHsKICAgIGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XSA9IHsKICAgICAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQoZWxlbWVudCwgd2l0aElmRG9tRGF0YUtleSwge30pOwogICAgICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CiAgICAgICAgfSwKICAgICAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICB2YXIgd2l0aElmRGF0YSA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIHdpdGhJZkRvbURhdGFLZXkpLAogICAgICAgICAgICAgICAgZGF0YVZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpLAogICAgICAgICAgICAgICAgc2hvdWxkRGlzcGxheSA9ICFpc05vdCAhPT0gIWRhdGFWYWx1ZSwgLy8gZXF1aXZhbGVudCB0byBpc05vdCA/ICFkYXRhVmFsdWUgOiAhIWRhdGFWYWx1ZQogICAgICAgICAgICAgICAgaXNGaXJzdFJlbmRlciA9ICF3aXRoSWZEYXRhLnNhdmVkTm9kZXMsCiAgICAgICAgICAgICAgICBuZWVkc1JlZnJlc2ggPSBpc0ZpcnN0UmVuZGVyIHx8IGlzV2l0aCB8fCAoc2hvdWxkRGlzcGxheSAhPT0gd2l0aElmRGF0YS5kaWREaXNwbGF5T25MYXN0VXBkYXRlKTsKCiAgICAgICAgICAgIGlmIChuZWVkc1JlZnJlc2gpIHsKICAgICAgICAgICAgICAgIGlmIChpc0ZpcnN0UmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgd2l0aElmRGF0YS5zYXZlZE5vZGVzID0ga28udXRpbHMuY2xvbmVOb2Rlcyhrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2RlcyhlbGVtZW50KSwgdHJ1ZSAvKiBzaG91bGRDbGVhbk5vZGVzICovKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkRGlzcGxheSkgewogICAgICAgICAgICAgICAgICAgIGlmICghaXNGaXJzdFJlbmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuKGVsZW1lbnQsIGtvLnV0aWxzLmNsb25lTm9kZXMod2l0aElmRGF0YS5zYXZlZE5vZGVzKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzKG1ha2VDb250ZXh0Q2FsbGJhY2sgPyBtYWtlQ29udGV4dENhbGxiYWNrKGJpbmRpbmdDb250ZXh0LCBkYXRhVmFsdWUpIDogYmluZGluZ0NvbnRleHQsIGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHdpdGhJZkRhdGEuZGlkRGlzcGxheU9uTGFzdFVwZGF0ZSA9IHNob3VsZERpc3BsYXk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAga28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnNbYmluZGluZ0tleV0gPSBmYWxzZTsgLy8gQ2FuJ3QgcmV3cml0ZSBjb250cm9sIGZsb3cgYmluZGluZ3MKICAgIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbYmluZGluZ0tleV0gPSB0cnVlOwp9CgovLyBDb25zdHJ1Y3QgdGhlIGFjdHVhbCBiaW5kaW5nIGhhbmRsZXJzCm1ha2VXaXRoSWZCaW5kaW5nKCdpZicpOwptYWtlV2l0aElmQmluZGluZygnaWZub3QnLCBmYWxzZSAvKiBpc1dpdGggKi8sIHRydWUgLyogaXNOb3QgKi8pOwptYWtlV2l0aElmQmluZGluZygnd2l0aCcsIHRydWUgLyogaXNXaXRoICovLCBmYWxzZSAvKiBpc05vdCAqLywKICAgIGZ1bmN0aW9uKGJpbmRpbmdDb250ZXh0LCBkYXRhVmFsdWUpIHsKICAgICAgICByZXR1cm4gYmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGRhdGFWYWx1ZSk7CiAgICB9Cik7CmZ1bmN0aW9uIGVuc3VyZURyb3Bkb3duU2VsZWN0aW9uSXNDb25zaXN0ZW50V2l0aE1vZGVsVmFsdWUoZWxlbWVudCwgbW9kZWxWYWx1ZSwgcHJlZmVyTW9kZWxWYWx1ZSkgewogICAgaWYgKHByZWZlck1vZGVsVmFsdWUpIHsKICAgICAgICBpZiAobW9kZWxWYWx1ZSAhPT0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCkpCiAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBtb2RlbFZhbHVlKTsKICAgIH0KCiAgICAvLyBObyBtYXR0ZXIgd2hpY2ggZGlyZWN0aW9uIHdlJ3JlIHN5bmNpbmcgaW4sIHdlIHdhbnQgdGhlIGVuZCByZXN1bHQgdG8gYmUgZXF1YWxpdHkgYmV0d2VlbiBkcm9wZG93biB2YWx1ZSBhbmQgbW9kZWwgdmFsdWUuCiAgICAvLyBJZiB0aGV5IGFyZW4ndCBlcXVhbCwgZWl0aGVyIHdlIHByZWZlciB0aGUgZHJvcGRvd24gdmFsdWUsIG9yIHRoZSBtb2RlbCB2YWx1ZSBjb3VsZG4ndCBiZSByZXByZXNlbnRlZCwgc28gZWl0aGVyIHdheSwKICAgIC8vIGNoYW5nZSB0aGUgbW9kZWwgdmFsdWUgdG8gbWF0Y2ggdGhlIGRyb3Bkb3duLgogICAgaWYgKG1vZGVsVmFsdWUgIT09IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpKQogICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsICJjaGFuZ2UiXSk7Cn07Cgprby5iaW5kaW5nSGFuZGxlcnNbJ29wdGlvbnMnXSA9IHsKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIGlmIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT09ICJzZWxlY3QiKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIm9wdGlvbnMgYmluZGluZyBhcHBsaWVzIG9ubHkgdG8gU0VMRUNUIGVsZW1lbnRzIik7CgogICAgICAgIHZhciBzZWxlY3RXYXNQcmV2aW91c2x5RW1wdHkgPSBlbGVtZW50Lmxlbmd0aCA9PSAwOwogICAgICAgIHZhciBwcmV2aW91c1NlbGVjdGVkVmFsdWVzID0ga28udXRpbHMuYXJyYXlNYXAoa28udXRpbHMuYXJyYXlGaWx0ZXIoZWxlbWVudC5jaGlsZE5vZGVzLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZS50YWdOYW1lICYmIChrby51dGlscy50YWdOYW1lTG93ZXIobm9kZSkgPT09ICJvcHRpb24iKSAmJiBub2RlLnNlbGVjdGVkOwogICAgICAgIH0pLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUobm9kZSkgfHwgbm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudDsKICAgICAgICB9KTsKICAgICAgICB2YXIgcHJldmlvdXNTY3JvbGxUb3AgPSBlbGVtZW50LnNjcm9sbFRvcDsKCiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBzZWxlY3RlZFZhbHVlID0gZWxlbWVudC52YWx1ZTsKCiAgICAgICAgLy8gUmVtb3ZlIGFsbCBleGlzdGluZyA8b3B0aW9uPnMuCiAgICAgICAgLy8gTmVlZCB0byB1c2UgLnJlbW92ZSgpIHJhdGhlciB0aGFuIC5yZW1vdmVDaGlsZCgpIGZvciA8b3B0aW9uPnMgb3RoZXJ3aXNlIElFIGJlaGF2ZXMgb2RkbHkgKGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTM0KQogICAgICAgIHdoaWxlIChlbGVtZW50Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAga28uY2xlYW5Ob2RlKGVsZW1lbnQub3B0aW9uc1swXSk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlKDApOwogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBhbGxCaW5kaW5ncyA9IGFsbEJpbmRpbmdzQWNjZXNzb3IoKSwKICAgICAgICAgICAgICAgIGluY2x1ZGVEZXN0cm95ZWQgPSBhbGxCaW5kaW5nc1snb3B0aW9uc0luY2x1ZGVEZXN0cm95ZWQnXTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUubGVuZ3RoICE9ICJudW1iZXIiKQogICAgICAgICAgICAgICAgdmFsdWUgPSBbdmFsdWVdOwogICAgICAgICAgICBpZiAoYWxsQmluZGluZ3NbJ29wdGlvbnNDYXB0aW9uJ10pIHsKICAgICAgICAgICAgICAgIHZhciBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKTsKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldEh0bWwob3B0aW9uLCBhbGxCaW5kaW5nc1snb3B0aW9uc0NhcHRpb24nXSk7CiAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUob3B0aW9uLCB1bmRlZmluZWQpOwogICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChvcHRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IHZhbHVlLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgLy8gU2tpcCBkZXN0cm95ZWQgaXRlbXMKICAgICAgICAgICAgICAgIHZhciBhcnJheUVudHJ5ID0gdmFsdWVbaV07CiAgICAgICAgICAgICAgICBpZiAoYXJyYXlFbnRyeSAmJiBhcnJheUVudHJ5WydfZGVzdHJveSddICYmICFpbmNsdWRlRGVzdHJveWVkKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIHZhciBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKTsKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhcHBseVRvT2JqZWN0KG9iamVjdCwgcHJlZGljYXRlLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJlZGljYXRlVHlwZSA9IHR5cGVvZiBwcmVkaWNhdGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZVR5cGUgPT0gImZ1bmN0aW9uIikgICAgLy8gR2l2ZW4gYSBmdW5jdGlvbjsgcnVuIGl0IGFnYWluc3QgdGhlIGRhdGEgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByZWRpY2F0ZShvYmplY3QpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHByZWRpY2F0ZVR5cGUgPT0gInN0cmluZyIpIC8vIEdpdmVuIGEgc3RyaW5nOyB0cmVhdCBpdCBhcyBhIHByb3BlcnR5IG5hbWUgb24gdGhlIGRhdGEgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdFtwcmVkaWNhdGVdOwogICAgICAgICAgICAgICAgICAgIGVsc2UgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdpdmVuIG5vIG9wdGlvbnNUZXh0IGFyZzsgdXNlIHRoZSBkYXRhIHZhbHVlIGl0c2VsZgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGEgdmFsdWUgdG8gdGhlIG9wdGlvbiBlbGVtZW50CiAgICAgICAgICAgICAgICB2YXIgb3B0aW9uVmFsdWUgPSBhcHBseVRvT2JqZWN0KGFycmF5RW50cnksIGFsbEJpbmRpbmdzWydvcHRpb25zVmFsdWUnXSwgYXJyYXlFbnRyeSk7CiAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUob3B0aW9uLCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9wdGlvblZhbHVlKSk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgc29tZSB0ZXh0IHRvIHRoZSBvcHRpb24gZWxlbWVudAogICAgICAgICAgICAgICAgdmFyIG9wdGlvblRleHQgPSBhcHBseVRvT2JqZWN0KGFycmF5RW50cnksIGFsbEJpbmRpbmdzWydvcHRpb25zVGV4dCddLCBvcHRpb25WYWx1ZSk7CiAgICAgICAgICAgICAgICBrby51dGlscy5zZXRUZXh0Q29udGVudChvcHRpb24sIG9wdGlvblRleHQpOwoKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQob3B0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSUU2IGRvZXNuJ3QgbGlrZSB1cyB0byBhc3NpZ24gc2VsZWN0aW9uIHRvIE9QVElPTiBub2RlcyBiZWZvcmUgdGhleSdyZSBhZGRlZCB0byB0aGUgZG9jdW1lbnQuCiAgICAgICAgICAgIC8vIFRoYXQncyB3aHkgd2UgZmlyc3QgYWRkZWQgdGhlbSB3aXRob3V0IHNlbGVjdGlvbi4gTm93IGl0J3MgdGltZSB0byBzZXQgdGhlIHNlbGVjdGlvbi4KICAgICAgICAgICAgdmFyIG5ld09wdGlvbnMgPSBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJvcHRpb24iKTsKICAgICAgICAgICAgdmFyIGNvdW50U2VsZWN0aW9uc1JldGFpbmVkID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBuZXdPcHRpb25zLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmFycmF5SW5kZXhPZihwcmV2aW91c1NlbGVjdGVkVmFsdWVzLCBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShuZXdPcHRpb25zW2ldKSkgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZShuZXdPcHRpb25zW2ldLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBjb3VudFNlbGVjdGlvbnNSZXRhaW5lZCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBlbGVtZW50LnNjcm9sbFRvcCA9IHByZXZpb3VzU2Nyb2xsVG9wOwoKICAgICAgICAgICAgaWYgKHNlbGVjdFdhc1ByZXZpb3VzbHlFbXB0eSAmJiAoJ3ZhbHVlJyBpbiBhbGxCaW5kaW5ncykpIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBjb25zaXN0ZW5jeSBiZXR3ZWVuIG1vZGVsIHZhbHVlIGFuZCBzZWxlY3RlZCBvcHRpb24uCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgZHJvcGRvd24gaXMgYmVpbmcgcG9wdWxhdGVkIGZvciB0aGUgZmlyc3QgdGltZSBoZXJlIChvciB3YXMgb3RoZXJ3aXNlIHByZXZpb3VzbHkgZW1wdHkpLAogICAgICAgICAgICAgICAgLy8gdGhlIGRyb3Bkb3duIHNlbGVjdGlvbiBzdGF0ZSBpcyBtZWFuaW5nbGVzcywgc28gd2UgcHJlc2VydmUgdGhlIG1vZGVsIHZhbHVlLgogICAgICAgICAgICAgICAgZW5zdXJlRHJvcGRvd25TZWxlY3Rpb25Jc0NvbnNpc3RlbnRXaXRoTW9kZWxWYWx1ZShlbGVtZW50LCBrby51dGlscy5wZWVrT2JzZXJ2YWJsZShhbGxCaW5kaW5nc1sndmFsdWUnXSksIC8qIHByZWZlck1vZGVsVmFsdWUgKi8gdHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIElFOSBidWcKICAgICAgICAgICAga28udXRpbHMuZW5zdXJlU2VsZWN0RWxlbWVudElzUmVuZGVyZWRDb3JyZWN0bHkoZWxlbWVudCk7CiAgICAgICAgfQogICAgfQp9Owprby5iaW5kaW5nSGFuZGxlcnNbJ29wdGlvbnMnXS5vcHRpb25WYWx1ZURvbURhdGFLZXkgPSAnX19rby5vcHRpb25WYWx1ZURvbURhdGFfXyc7CmtvLmJpbmRpbmdIYW5kbGVyc1snc2VsZWN0ZWRPcHRpb25zJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImNoYW5nZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLCB2YWx1ZVRvV3JpdGUgPSBbXTsKICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9wdGlvbiIpLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5zZWxlY3RlZCkKICAgICAgICAgICAgICAgICAgICB2YWx1ZVRvV3JpdGUucHVzaChrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShub2RlKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KHZhbHVlLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCAndmFsdWUnLCB2YWx1ZVRvV3JpdGUpOwogICAgICAgIH0pOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIGlmIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT0gInNlbGVjdCIpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidmFsdWVzIGJpbmRpbmcgYXBwbGllcyBvbmx5IHRvIFNFTEVDVCBlbGVtZW50cyIpOwoKICAgICAgICB2YXIgbmV3VmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgaWYgKG5ld1ZhbHVlICYmIHR5cGVvZiBuZXdWYWx1ZS5sZW5ndGggPT0gIm51bWJlciIpIHsKICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9wdGlvbiIpLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNTZWxlY3RlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihuZXdWYWx1ZSwga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUobm9kZSkpID49IDA7CiAgICAgICAgICAgICAgICBrby51dGlscy5zZXRPcHRpb25Ob2RlU2VsZWN0aW9uU3RhdGUobm9kZSwgaXNTZWxlY3RlZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWydzdHlsZSddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkgfHwge30pOwogICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiB2YWx1ZSkgewogICAgICAgICAgICBpZiAodHlwZW9mIHN0eWxlTmFtZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdmFyIHN0eWxlVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlW3N0eWxlTmFtZV0pOwogICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZVtzdHlsZU5hbWVdID0gc3R5bGVWYWx1ZSB8fCAiIjsgLy8gRW1wdHkgc3RyaW5nIHJlbW92ZXMgdGhlIHZhbHVlLCB3aGVyZWFzIG51bGwvdW5kZWZpbmVkIGhhdmUgbm8gZWZmZWN0CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn07CmtvLmJpbmRpbmdIYW5kbGVyc1snc3VibWl0J10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwpIHsKICAgICAgICBpZiAodHlwZW9mIHZhbHVlQWNjZXNzb3IoKSAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSB2YWx1ZSBmb3IgYSBzdWJtaXQgYmluZGluZyBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAic3VibWl0IiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBoYW5kbGVyUmV0dXJuVmFsdWU7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKICAgICAgICAgICAgdHJ5IHsgaGFuZGxlclJldHVyblZhbHVlID0gdmFsdWUuY2FsbCh2aWV3TW9kZWwsIGVsZW1lbnQpOyB9CiAgICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICAgICAgaWYgKGhhbmRsZXJSZXR1cm5WYWx1ZSAhPT0gdHJ1ZSkgeyAvLyBOb3JtYWxseSB3ZSB3YW50IHRvIHByZXZlbnQgZGVmYXVsdCBhY3Rpb24uIERldmVsb3BlciBjYW4gb3ZlcnJpZGUgdGhpcyBiZSBleHBsaWNpdGx5IHJldHVybmluZyB0cnVlLgogICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWyd0ZXh0J10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBrby51dGlscy5zZXRUZXh0Q29udGVudChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKCkpOwogICAgfQp9Owprby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWyd0ZXh0J10gPSB0cnVlOwprby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXSA9IHsKICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBpZiAodmFsdWVBY2Nlc3NvcigpKSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gImtvX3VuaXF1ZV8iICsgKCsra28uYmluZGluZ0hhbmRsZXJzWyd1bmlxdWVOYW1lJ10uY3VycmVudEluZGV4KTsKICAgICAgICAgICAga28udXRpbHMuc2V0RWxlbWVudE5hbWUoZWxlbWVudCwgbmFtZSk7CiAgICAgICAgfQogICAgfQp9Owprby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXS5jdXJyZW50SW5kZXggPSAwOwprby5iaW5kaW5nSGFuZGxlcnNbJ3ZhbHVlJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgLy8gQWx3YXlzIGNhdGNoICJjaGFuZ2UiIGV2ZW50OyBwb3NzaWJseSBvdGhlciBldmVudHMgdG9vIGlmIGFza2VkCiAgICAgICAgdmFyIGV2ZW50c1RvQ2F0Y2ggPSBbImNoYW5nZSJdOwogICAgICAgIHZhciByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoID0gYWxsQmluZGluZ3NBY2Nlc3NvcigpWyJ2YWx1ZVVwZGF0ZSJdOwogICAgICAgIHZhciBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IGZhbHNlOwogICAgICAgIGlmIChyZXF1ZXN0ZWRFdmVudHNUb0NhdGNoKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCA9PSAic3RyaW5nIikgLy8gQWxsb3cgYm90aCBpbmRpdmlkdWFsIGV2ZW50IG5hbWVzLCBhbmQgYXJyYXlzIG9mIGV2ZW50IG5hbWVzCiAgICAgICAgICAgICAgICByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoID0gW3JlcXVlc3RlZEV2ZW50c1RvQ2F0Y2hdOwogICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoZXZlbnRzVG9DYXRjaCwgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCk7CiAgICAgICAgICAgIGV2ZW50c1RvQ2F0Y2ggPSBrby51dGlscy5hcnJheUdldERpc3RpbmN0VmFsdWVzKGV2ZW50c1RvQ2F0Y2gpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHZhbHVlVXBkYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IGZhbHNlOwogICAgICAgICAgICB2YXIgbW9kZWxWYWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKICAgICAgICAgICAgdmFyIGVsZW1lbnRWYWx1ZSA9IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpOwogICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzQWNjZXNzb3IsICd2YWx1ZScsIGVsZW1lbnRWYWx1ZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzEyMgogICAgICAgIC8vIElFIGRvZXNuJ3QgZmlyZSAiY2hhbmdlIiBldmVudHMgb24gdGV4dGJveGVzIGlmIHRoZSB1c2VyIHNlbGVjdHMgYSB2YWx1ZSBmcm9tIGl0cyBhdXRvY29tcGxldGUgbGlzdAogICAgICAgIHZhciBpZUF1dG9Db21wbGV0ZUhhY2tOZWVkZWQgPSBrby51dGlscy5pZVZlcnNpb24gJiYgZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImlucHV0IiAmJiBlbGVtZW50LnR5cGUgPT0gInRleHQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIGVsZW1lbnQuYXV0b2NvbXBsZXRlICE9ICJvZmYiICYmICghZWxlbWVudC5mb3JtIHx8IGVsZW1lbnQuZm9ybS5hdXRvY29tcGxldGUgIT0gIm9mZiIpOwogICAgICAgIGlmIChpZUF1dG9Db21wbGV0ZUhhY2tOZWVkZWQgJiYga28udXRpbHMuYXJyYXlJbmRleE9mKGV2ZW50c1RvQ2F0Y2gsICJwcm9wZXJ0eWNoYW5nZSIpID09IC0xKSB7CiAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJwcm9wZXJ0eWNoYW5nZSIsIGZ1bmN0aW9uICgpIHsgcHJvcGVydHlDaGFuZ2VkRmlyZWQgPSB0cnVlIH0pOwogICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiYmx1ciIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5Q2hhbmdlZEZpcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWVVcGRhdGVIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGV2ZW50c1RvQ2F0Y2gsIGZ1bmN0aW9uKGV2ZW50TmFtZSkgewogICAgICAgICAgICAvLyBUaGUgc3ludGF4ICJhZnRlcjxldmVudG5hbWU+IiBtZWFucyAicnVuIHRoZSBoYW5kbGVyIGFzeW5jaHJvbm91c2x5IGFmdGVyIHRoZSBldmVudCIKICAgICAgICAgICAgLy8gVGhpcyBpcyB1c2VmdWwsIGZvciBleGFtcGxlLCB0byBjYXRjaCAia2V5ZG93biIgZXZlbnRzIGFmdGVyIHRoZSBicm93c2VyIGhhcyB1cGRhdGVkIHRoZSBjb250cm9sCiAgICAgICAgICAgIC8vIChvdGhlcndpc2UsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKHRoaXMpIHdpbGwgcmVjZWl2ZSB0aGUgY29udHJvbCdzIHZhbHVlICpiZWZvcmUqIHRoZSBrZXkgZXZlbnQpCiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdmFsdWVVcGRhdGVIYW5kbGVyOwogICAgICAgICAgICBpZiAoa28udXRpbHMuc3RyaW5nU3RhcnRzV2l0aChldmVudE5hbWUsICJhZnRlciIpKSB7CiAgICAgICAgICAgICAgICBoYW5kbGVyID0gZnVuY3Rpb24oKSB7IHNldFRpbWVvdXQodmFsdWVVcGRhdGVIYW5kbGVyLCAwKSB9OwogICAgICAgICAgICAgICAgZXZlbnROYW1lID0gZXZlbnROYW1lLnN1YnN0cmluZygiYWZ0ZXIiLmxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnROYW1lLCBoYW5kbGVyKTsKICAgICAgICB9KTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWVJc1NlbGVjdE9wdGlvbiA9IGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSA9PT0gInNlbGVjdCI7CiAgICAgICAgdmFyIG5ld1ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBlbGVtZW50VmFsdWUgPSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50KTsKICAgICAgICB2YXIgdmFsdWVIYXNDaGFuZ2VkID0gKG5ld1ZhbHVlICE9IGVsZW1lbnRWYWx1ZSk7CgogICAgICAgIC8vIEphdmFTY3JpcHQncyAwID09ICIiIGJlaGF2aW91cyBpcyB1bmZvcnR1bmF0ZSBoZXJlIGFzIGl0IHByZXZlbnRzIHdyaXRpbmcgMCB0byBhbiBlbXB0eSB0ZXh0IGJveCAobG9vc2UgZXF1YWxpdHkgc3VnZ2VzdHMgdGhlIHZhbHVlcyBhcmUgdGhlIHNhbWUpLgogICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdG8gZG8gYSBzdHJpY3QgZXF1YWxpdHkgY29tcGFyaXNvbiBhcyB0aGF0IGlzIG1vcmUgY29uZnVzaW5nIGZvciBkZXZlbG9wZXJzIGluIGNlcnRhaW4gY2FzZXMsIHNvIHdlIHNwZWNpZmljYWxseSBzcGVjaWFsIGNhc2UgMCAhPSAiIiBoZXJlLgogICAgICAgIGlmICgobmV3VmFsdWUgPT09IDApICYmIChlbGVtZW50VmFsdWUgIT09IDApICYmIChlbGVtZW50VmFsdWUgIT09ICIwIikpCiAgICAgICAgICAgIHZhbHVlSGFzQ2hhbmdlZCA9IHRydWU7CgogICAgICAgIGlmICh2YWx1ZUhhc0NoYW5nZWQpIHsKICAgICAgICAgICAgdmFyIGFwcGx5VmFsdWVBY3Rpb24gPSBmdW5jdGlvbiAoKSB7IGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSk7IH07CiAgICAgICAgICAgIGFwcGx5VmFsdWVBY3Rpb24oKTsKCiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIElFNiBidWc6IEl0IHdvbid0IHJlbGlhYmx5IGFwcGx5IHZhbHVlcyB0byBTRUxFQ1Qgbm9kZXMgZHVyaW5nIHRoZSBzYW1lIGV4ZWN1dGlvbiB0aHJlYWQKICAgICAgICAgICAgLy8gcmlnaHQgYWZ0ZXIgeW91J3ZlIGNoYW5nZWQgdGhlIHNldCBvZiBPUFRJT04gbm9kZXMgb24gaXQuIFNvIGZvciB0aGF0IG5vZGUgdHlwZSwgd2UnbGwgc2NoZWR1bGUgYSBzZWNvbmQgdGhyZWFkCiAgICAgICAgICAgIC8vIHRvIGFwcGx5IHRoZSB2YWx1ZSBhcyB3ZWxsLgogICAgICAgICAgICB2YXIgYWxzb0FwcGx5QXN5bmNocm9ub3VzbHkgPSB2YWx1ZUlzU2VsZWN0T3B0aW9uOwogICAgICAgICAgICBpZiAoYWxzb0FwcGx5QXN5bmNocm9ub3VzbHkpCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGFwcGx5VmFsdWVBY3Rpb24sIDApOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgeW91IHRyeSB0byBzZXQgYSBtb2RlbCB2YWx1ZSB0aGF0IGNhbid0IGJlIHJlcHJlc2VudGVkIGluIGFuIGFscmVhZHktcG9wdWxhdGVkIGRyb3Bkb3duLCByZWplY3QgdGhhdCBjaGFuZ2UsCiAgICAgICAgLy8gYmVjYXVzZSB5b3UncmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBhIG1vZGVsIHZhbHVlIHRoYXQgZGlzYWdyZWVzIHdpdGggYSB2aXNpYmxlIFVJIHNlbGVjdGlvbi4KICAgICAgICBpZiAodmFsdWVJc1NlbGVjdE9wdGlvbiAmJiAoZWxlbWVudC5sZW5ndGggPiAwKSkKICAgICAgICAgICAgZW5zdXJlRHJvcGRvd25TZWxlY3Rpb25Jc0NvbnNpc3RlbnRXaXRoTW9kZWxWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSwgLyogcHJlZmVyTW9kZWxWYWx1ZSAqLyBmYWxzZSk7CiAgICB9Cn07CmtvLmJpbmRpbmdIYW5kbGVyc1sndmlzaWJsZSddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBpc0N1cnJlbnRseVZpc2libGUgPSAhKGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9PSAibm9uZSIpOwogICAgICAgIGlmICh2YWx1ZSAmJiAhaXNDdXJyZW50bHlWaXNpYmxlKQogICAgICAgICAgICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAiIjsKICAgICAgICBlbHNlIGlmICgoIXZhbHVlKSAmJiBpc0N1cnJlbnRseVZpc2libGUpCiAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIH0KfTsKLy8gJ2NsaWNrJyBpcyBqdXN0IGEgc2hvcnRoYW5kIGZvciB0aGUgdXN1YWwgZnVsbC1sZW5ndGggZXZlbnQ6e2NsaWNrOmhhbmRsZXJ9Cm1ha2VFdmVudEhhbmRsZXJTaG9ydGN1dCgnY2xpY2snKTsKLy8gSWYgeW91IHdhbnQgdG8gbWFrZSBhIGN1c3RvbSB0ZW1wbGF0ZSBlbmdpbmUsCi8vCi8vIFsxXSBJbmhlcml0IGZyb20gdGhpcyBjbGFzcyAobGlrZSBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSBkb2VzKQovLyBbMl0gT3ZlcnJpZGUgJ3JlbmRlclRlbXBsYXRlU291cmNlJywgc3VwcGx5aW5nIGEgZnVuY3Rpb24gd2l0aCB0aGlzIHNpZ25hdHVyZToKLy8KLy8gICAgICAgIGZ1bmN0aW9uICh0ZW1wbGF0ZVNvdXJjZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpIHsKLy8gICAgICAgICAgICAvLyAtIHRlbXBsYXRlU291cmNlLnRleHQoKSBpcyB0aGUgdGV4dCBvZiB0aGUgdGVtcGxhdGUgeW91IHNob3VsZCByZW5kZXIKLy8gICAgICAgICAgICAvLyAtIGJpbmRpbmdDb250ZXh0LiRkYXRhIGlzIHRoZSBkYXRhIHlvdSBzaG91bGQgcGFzcyBpbnRvIHRoZSB0ZW1wbGF0ZQovLyAgICAgICAgICAgIC8vICAgLSB5b3UgbWlnaHQgYWxzbyB3YW50IHRvIG1ha2UgYmluZGluZ0NvbnRleHQuJHBhcmVudCwgYmluZGluZ0NvbnRleHQuJHBhcmVudHMsCi8vICAgICAgICAgICAgLy8gICAgIGFuZCBiaW5kaW5nQ29udGV4dC4kcm9vdCBhdmFpbGFibGUgaW4gdGhlIHRlbXBsYXRlIHRvbwovLyAgICAgICAgICAgIC8vIC0gb3B0aW9ucyBnaXZlcyB5b3UgYWNjZXNzIHRvIGFueSBvdGhlciBwcm9wZXJ0aWVzIHNldCBvbiAiZGF0YS1iaW5kOiB7IHRlbXBsYXRlOiBvcHRpb25zIH0iCi8vICAgICAgICAgICAgLy8KLy8gICAgICAgICAgICAvLyBSZXR1cm4gdmFsdWU6IGFuIGFycmF5IG9mIERPTSBub2RlcwovLyAgICAgICAgfQovLwovLyBbM10gT3ZlcnJpZGUgJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jaycsIHN1cHBseWluZyBhIGZ1bmN0aW9uIHdpdGggdGhpcyBzaWduYXR1cmU6Ci8vCi8vICAgICAgICBmdW5jdGlvbiAoc2NyaXB0KSB7Ci8vICAgICAgICAgICAgLy8gUmV0dXJuIHZhbHVlOiBXaGF0ZXZlciBzeW50YXggbWVhbnMgIkV2YWx1YXRlIHRoZSBKYXZhU2NyaXB0IHN0YXRlbWVudCAnc2NyaXB0JyBhbmQgb3V0cHV0IHRoZSByZXN1bHQiCi8vICAgICAgICAgICAgLy8gICAgICAgICAgICAgICBGb3IgZXhhbXBsZSwgdGhlIGpxdWVyeS50bXBsIHRlbXBsYXRlIGVuZ2luZSBjb252ZXJ0cyAnc29tZVNjcmlwdCcgdG8gJyR7IHNvbWVTY3JpcHQgfScKLy8gICAgICAgIH0KLy8KLy8gICAgIFRoaXMgaXMgb25seSBuZWNlc3NhcnkgaWYgeW91IHdhbnQgdG8gYWxsb3cgZGF0YS1iaW5kIGF0dHJpYnV0ZXMgdG8gcmVmZXJlbmNlIGFyYml0cmFyeSB0ZW1wbGF0ZSB2YXJpYWJsZXMuCi8vICAgICBJZiB5b3UgZG9uJ3Qgd2FudCB0byBhbGxvdyB0aGF0LCB5b3UgY2FuIHNldCB0aGUgcHJvcGVydHkgJ2FsbG93VGVtcGxhdGVSZXdyaXRpbmcnIHRvIGZhbHNlIChsaWtlIGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lIGRvZXMpCi8vICAgICBhbmQgdGhlbiB5b3UgZG9uJ3QgbmVlZCB0byBvdmVycmlkZSAnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJy4KCmtvLnRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgeyB9OwoKa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddID0gZnVuY3Rpb24gKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewogICAgdGhyb3cgbmV3IEVycm9yKCJPdmVycmlkZSByZW5kZXJUZW1wbGF0ZVNvdXJjZSIpOwp9OwoKa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2snXSA9IGZ1bmN0aW9uIChzY3JpcHQpIHsKICAgIHRocm93IG5ldyBFcnJvcigiT3ZlcnJpZGUgY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrIik7Cn07Cgprby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ21ha2VUZW1wbGF0ZVNvdXJjZSddID0gZnVuY3Rpb24odGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIC8vIE5hbWVkIHRlbXBsYXRlCiAgICBpZiAodHlwZW9mIHRlbXBsYXRlID09ICJzdHJpbmciKSB7CiAgICAgICAgdGVtcGxhdGVEb2N1bWVudCA9IHRlbXBsYXRlRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgdmFyIGVsZW0gPSB0ZW1wbGF0ZURvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRlbXBsYXRlKTsKICAgICAgICBpZiAoIWVsZW0pCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgdGVtcGxhdGUgd2l0aCBJRCAiICsgdGVtcGxhdGUpOwogICAgICAgIHJldHVybiBuZXcga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQoZWxlbSk7CiAgICB9IGVsc2UgaWYgKCh0ZW1wbGF0ZS5ub2RlVHlwZSA9PSAxKSB8fCAodGVtcGxhdGUubm9kZVR5cGUgPT0gOCkpIHsKICAgICAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGUKICAgICAgICByZXR1cm4gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZSh0ZW1wbGF0ZSk7CiAgICB9IGVsc2UKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdGVtcGxhdGUgdHlwZTogIiArIHRlbXBsYXRlKTsKfTsKCmtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmVuZGVyVGVtcGxhdGUnXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIHZhciB0ZW1wbGF0ZVNvdXJjZSA9IHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgIHJldHVybiB0aGlzWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucyk7Cn07Cgprby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ2lzVGVtcGxhdGVSZXdyaXR0ZW4nXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkgewogICAgLy8gU2tpcCByZXdyaXRpbmcgaWYgcmVxdWVzdGVkCiAgICBpZiAodGhpc1snYWxsb3dUZW1wbGF0ZVJld3JpdGluZyddID09PSBmYWxzZSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIHJldHVybiB0aGlzWydtYWtlVGVtcGxhdGVTb3VyY2UnXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudClbJ2RhdGEnXSgiaXNSZXdyaXR0ZW4iKTsKfTsKCmtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmV3cml0ZVRlbXBsYXRlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGUsIHJld3JpdGVyQ2FsbGJhY2ssIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIHZhciB0ZW1wbGF0ZVNvdXJjZSA9IHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgIHZhciByZXdyaXR0ZW4gPSByZXdyaXRlckNhbGxiYWNrKHRlbXBsYXRlU291cmNlWyd0ZXh0J10oKSk7CiAgICB0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKHJld3JpdHRlbik7CiAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCJpc1Jld3JpdHRlbiIsIHRydWUpOwp9OwoKa28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZUVuZ2luZScsIGtvLnRlbXBsYXRlRW5naW5lKTsKCmtvLnRlbXBsYXRlUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCA9IC8oPFthLXpdK1xkKihccysoPyFkYXRhLWJpbmQ9KVthLXowLTlcLV0rKD0oXCJbXlwiXSpcInxcJ1teXCddKlwnKSk/KSpccyspZGF0YS1iaW5kPShbIiddKShbXHNcU10qPylcNS9naTsKICAgIHZhciBtZW1vaXplVmlydHVhbENvbnRhaW5lckJpbmRpbmdTeW50YXhSZWdleCA9IC88IS0tXHMqa29cYlxzKihbXHNcU10qPylccyotLT4vZzsKCiAgICBmdW5jdGlvbiB2YWxpZGF0ZURhdGFCaW5kVmFsdWVzRm9yUmV3cml0aW5nKGtleVZhbHVlQXJyYXkpIHsKICAgICAgICB2YXIgYWxsVmFsaWRhdG9ycyA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5VmFsdWVBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIga2V5ID0ga2V5VmFsdWVBcnJheVtpXVsna2V5J107CiAgICAgICAgICAgIGlmIChhbGxWYWxpZGF0b3JzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgIHZhciB2YWxpZGF0b3IgPSBhbGxWYWxpZGF0b3JzW2tleV07CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWxpZGF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcG9zc2libGVFcnJvck1lc3NhZ2UgPSB2YWxpZGF0b3Ioa2V5VmFsdWVBcnJheVtpXVsndmFsdWUnXSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlRXJyb3JNZXNzYWdlKQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IocG9zc2libGVFcnJvck1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdmFsaWRhdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHRlbXBsYXRlIGVuZ2luZSBkb2VzIG5vdCBzdXBwb3J0IHRoZSAnIiArIGtleSArICInIGJpbmRpbmcgd2l0aGluIGl0cyB0ZW1wbGF0ZXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjb25zdHJ1Y3RNZW1vaXplZFRhZ1JlcGxhY2VtZW50KGRhdGFCaW5kQXR0cmlidXRlVmFsdWUsIHRhZ1RvUmV0YWluLCB0ZW1wbGF0ZUVuZ2luZSkgewogICAgICAgIHZhciBkYXRhQmluZEtleVZhbHVlQXJyYXkgPSBrby5leHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbChkYXRhQmluZEF0dHJpYnV0ZVZhbHVlKTsKICAgICAgICB2YWxpZGF0ZURhdGFCaW5kVmFsdWVzRm9yUmV3cml0aW5nKGRhdGFCaW5kS2V5VmFsdWVBcnJheSk7CiAgICAgICAgdmFyIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgPSBrby5leHByZXNzaW9uUmV3cml0aW5nLnByZVByb2Nlc3NCaW5kaW5ncyhkYXRhQmluZEtleVZhbHVlQXJyYXkpOwoKICAgICAgICAvLyBGb3Igbm8gb2J2aW91cyByZWFzb24sIE9wZXJhIGZhaWxzIHRvIGV2YWx1YXRlIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgdW5sZXNzIGl0J3Mgd3JhcHBlZCBpbiBhbiBhZGRpdGlvbmFsCiAgICAgICAgLy8gYW5vbnltb3VzIGZ1bmN0aW9uLCBldmVuIHRob3VnaCBPcGVyYSdzIGJ1aWx0LWluIGRlYnVnZ2VyIGNhbiBldmFsdWF0ZSBpdCBhbnl3YXkuIE5vIG90aGVyIGJyb3dzZXIgcmVxdWlyZXMgdGhpcwogICAgICAgIC8vIGV4dHJhIGluZGlyZWN0aW9uLgogICAgICAgIHZhciBhcHBseUJpbmRpbmdzVG9OZXh0U2libGluZ1NjcmlwdCA9CiAgICAgICAgICAgICJrby5fX3RyX2FtYnRucyhmdW5jdGlvbigkY29udGV4dCwkZWxlbWVudCl7cmV0dXJuKGZ1bmN0aW9uKCl7cmV0dXJueyAiICsgcmV3cml0dGVuRGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSArICIgfSB9KSgpfSkiOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZUVuZ2luZVsnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10oYXBwbHlCaW5kaW5nc1RvTmV4dFNpYmxpbmdTY3JpcHQpICsgdGFnVG9SZXRhaW47CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBlbnN1cmVUZW1wbGF0ZUlzUmV3cml0dGVuOiBmdW5jdGlvbiAodGVtcGxhdGUsIHRlbXBsYXRlRW5naW5lLCB0ZW1wbGF0ZURvY3VtZW50KSB7CiAgICAgICAgICAgIGlmICghdGVtcGxhdGVFbmdpbmVbJ2lzVGVtcGxhdGVSZXdyaXR0ZW4nXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkpCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZUVuZ2luZVsncmV3cml0ZVRlbXBsYXRlJ10odGVtcGxhdGUsIGZ1bmN0aW9uIChodG1sU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnRlbXBsYXRlUmV3cml0aW5nLm1lbW9pemVCaW5kaW5nQXR0cmlidXRlU3ludGF4KGh0bWxTdHJpbmcsIHRlbXBsYXRlRW5naW5lKTsKICAgICAgICAgICAgICAgIH0sIHRlbXBsYXRlRG9jdW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIG1lbW9pemVCaW5kaW5nQXR0cmlidXRlU3ludGF4OiBmdW5jdGlvbiAoaHRtbFN0cmluZywgdGVtcGxhdGVFbmdpbmUpIHsKICAgICAgICAgICAgcmV0dXJuIGh0bWxTdHJpbmcucmVwbGFjZShtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzZdLCAvKiB0YWdUb1JldGFpbjogKi8gYXJndW1lbnRzWzFdLCB0ZW1wbGF0ZUVuZ2luZSk7CiAgICAgICAgICAgIH0pLnJlcGxhY2UobWVtb2l6ZVZpcnR1YWxDb250YWluZXJCaW5kaW5nU3ludGF4UmVnZXgsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzFdLCAvKiB0YWdUb1JldGFpbjogKi8gIjwhLS0ga28gLS0+IiwgdGVtcGxhdGVFbmdpbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBhcHBseU1lbW9pemVkQmluZGluZ3NUb05leHRTaWJsaW5nOiBmdW5jdGlvbiAoYmluZGluZ3MpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoZnVuY3Rpb24gKGRvbU5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoZG9tTm9kZS5uZXh0U2libGluZykKICAgICAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdzVG9Ob2RlKGRvbU5vZGUubmV4dFNpYmxpbmcsIGJpbmRpbmdzLCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KfSkoKTsKCgovLyBFeHBvcnRlZCBvbmx5IGJlY2F1c2UgaXQgaGFzIHRvIGJlIHJlZmVyZW5jZWQgYnkgc3RyaW5nIGxvb2t1cCBmcm9tIHdpdGhpbiByZXdyaXR0ZW4gdGVtcGxhdGUKa28uZXhwb3J0U3ltYm9sKCdfX3RyX2FtYnRucycsIGtvLnRlbXBsYXRlUmV3cml0aW5nLmFwcGx5TWVtb2l6ZWRCaW5kaW5nc1RvTmV4dFNpYmxpbmcpOwooZnVuY3Rpb24oKSB7CiAgICAvLyBBIHRlbXBsYXRlIHNvdXJjZSByZXByZXNlbnRzIGEgcmVhZC93cml0ZSB3YXkgb2YgYWNjZXNzaW5nIGEgdGVtcGxhdGUuIFRoaXMgaXMgdG8gZWxpbWluYXRlIHRoZSBuZWVkIGZvciB0ZW1wbGF0ZSBsb2FkaW5nL3NhdmluZwogICAgLy8gbG9naWMgdG8gYmUgZHVwbGljYXRlZCBpbiBldmVyeSB0ZW1wbGF0ZSBlbmdpbmUgKGFuZCBtZWFucyB0aGV5IGNhbiBhbGwgd29yayB3aXRoIGFub255bW91cyB0ZW1wbGF0ZXMsIGV0Yy4pCiAgICAvLwogICAgLy8gVHdvIGFyZSBwcm92aWRlZCBieSBkZWZhdWx0OgogICAgLy8gIDEuIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ICAgICAgIC0gcmVhZHMvd3JpdGVzIHRoZSB0ZXh0IGNvbnRlbnQgb2YgYW4gYXJiaXRyYXJ5IERPTSBlbGVtZW50CiAgICAvLyAgMi4ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c0VsZW1lbnQgLSB1c2VzIGtvLnV0aWxzLmRvbURhdGEgdG8gcmVhZC93cml0ZSB0ZXh0ICphc3NvY2lhdGVkKiB3aXRoIHRoZSBET00gZWxlbWVudCwgYnV0CiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRob3V0IHJlYWRpbmcvd3JpdGluZyB0aGUgYWN0dWFsIGVsZW1lbnQgdGV4dCBjb250ZW50LCBzaW5jZSBpdCB3aWxsIGJlIG92ZXJ3cml0dGVuCiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIHRoZSByZW5kZXJlZCB0ZW1wbGF0ZSBvdXRwdXQuCiAgICAvLyBZb3UgY2FuIGltcGxlbWVudCB5b3VyIG93biB0ZW1wbGF0ZSBzb3VyY2UgaWYgeW91IHdhbnQgdG8gZmV0Y2gvc3RvcmUgdGVtcGxhdGVzIHNvbWV3aGVyZSBvdGhlciB0aGFuIGluIERPTSBlbGVtZW50cy4KICAgIC8vIFRlbXBsYXRlIHNvdXJjZXMgbmVlZCB0byBoYXZlIHRoZSBmb2xsb3dpbmcgZnVuY3Rpb25zOgogICAgLy8gICB0ZXh0KCkgCQkJLSByZXR1cm5zIHRoZSB0ZW1wbGF0ZSB0ZXh0IGZyb20geW91ciBzdG9yYWdlIGxvY2F0aW9uCiAgICAvLyAgIHRleHQodmFsdWUpCQktIHdyaXRlcyB0aGUgc3VwcGxpZWQgdGVtcGxhdGUgdGV4dCB0byB5b3VyIHN0b3JhZ2UgbG9jYXRpb24KICAgIC8vICAgZGF0YShrZXkpCQkJLSByZWFkcyB2YWx1ZXMgc3RvcmVkIHVzaW5nIGRhdGEoa2V5LCB2YWx1ZSkgLSBzZWUgYmVsb3cKICAgIC8vICAgZGF0YShrZXksIHZhbHVlKQktIGFzc29jaWF0ZXMgInZhbHVlIiB3aXRoIHRoaXMgdGVtcGxhdGUgYW5kIHRoZSBrZXkgImtleSIuIElzIHVzZWQgdG8gc3RvcmUgaW5mb3JtYXRpb24gbGlrZSAiaXNSZXdyaXR0ZW4iLgogICAgLy8KICAgIC8vIE9wdGlvbmFsbHksIHRlbXBsYXRlIHNvdXJjZXMgY2FuIGFsc28gaGF2ZSB0aGUgZm9sbG93aW5nIGZ1bmN0aW9uczoKICAgIC8vICAgbm9kZXMoKSAgICAgICAgICAgIC0gcmV0dXJucyBhIERPTSBlbGVtZW50IGNvbnRhaW5pbmcgdGhlIG5vZGVzIG9mIHRoaXMgdGVtcGxhdGUsIHdoZXJlIGF2YWlsYWJsZQogICAgLy8gICBub2Rlcyh2YWx1ZSkgICAgICAgLSB3cml0ZXMgdGhlIGdpdmVuIERPTSBlbGVtZW50IHRvIHlvdXIgc3RvcmFnZSBsb2NhdGlvbgogICAgLy8gSWYgYSBET00gZWxlbWVudCBpcyBhdmFpbGFibGUgZm9yIGEgZ2l2ZW4gdGVtcGxhdGUgc291cmNlLCB0ZW1wbGF0ZSBlbmdpbmVzIGFyZSBlbmNvdXJhZ2VkIHRvIHVzZSBpdCBpbiBwcmVmZXJlbmNlIG92ZXIgdGV4dCgpCiAgICAvLyBmb3IgaW1wcm92ZWQgc3BlZWQuIEhvd2V2ZXIsIGFsbCB0ZW1wbGF0ZVNvdXJjZXMgbXVzdCBzdXBwbHkgdGV4dCgpIGV2ZW4gaWYgdGhleSBkb24ndCBzdXBwbHkgbm9kZXMoKS4KICAgIC8vCiAgICAvLyBPbmNlIHlvdSd2ZSBpbXBsZW1lbnRlZCBhIHRlbXBsYXRlU291cmNlLCBtYWtlIHlvdXIgdGVtcGxhdGUgZW5naW5lIHVzZSBpdCBieSBzdWJjbGFzc2luZyB3aGF0ZXZlciB0ZW1wbGF0ZSBlbmdpbmUgeW91IHdlcmUKICAgIC8vIHVzaW5nIGFuZCBvdmVycmlkaW5nICJtYWtlVGVtcGxhdGVTb3VyY2UiIHRvIHJldHVybiBhbiBpbnN0YW5jZSBvZiB5b3VyIGN1c3RvbSB0ZW1wbGF0ZSBzb3VyY2UuCgogICAga28udGVtcGxhdGVTb3VyY2VzID0ge307CgogICAgLy8gLS0tLSBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCAtLS0tLQoKICAgIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHRoaXMuZG9tRWxlbWVudCA9IGVsZW1lbnQ7CiAgICB9CgogICAga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICB2YXIgdGFnTmFtZUxvd2VyID0ga28udXRpbHMudGFnTmFtZUxvd2VyKHRoaXMuZG9tRWxlbWVudCksCiAgICAgICAgICAgIGVsZW1Db250ZW50c1Byb3BlcnR5ID0gdGFnTmFtZUxvd2VyID09PSAic2NyaXB0IiA/ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHRhZ05hbWVMb3dlciA9PT0gInRleHRhcmVhIiA/ICJ2YWx1ZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAiaW5uZXJIVE1MIjsKCiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kb21FbGVtZW50W2VsZW1Db250ZW50c1Byb3BlcnR5XTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdmFsdWVUb1dyaXRlID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICBpZiAoZWxlbUNvbnRlbnRzUHJvcGVydHkgPT09ICJpbm5lckhUTUwiKQogICAgICAgICAgICAgICAga28udXRpbHMuc2V0SHRtbCh0aGlzLmRvbUVsZW1lbnQsIHZhbHVlVG9Xcml0ZSk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHRoaXMuZG9tRWxlbWVudFtlbGVtQ29udGVudHNQcm9wZXJ0eV0gPSB2YWx1ZVRvV3JpdGU7CiAgICAgICAgfQogICAgfTsKCiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudC5wcm90b3R5cGVbJ2RhdGEnXSA9IGZ1bmN0aW9uKGtleSAvKiwgdmFsdWVUb1dyaXRlICovKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KHRoaXMuZG9tRWxlbWVudCwgInRlbXBsYXRlU291cmNlRGF0YV8iICsga2V5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldCh0aGlzLmRvbUVsZW1lbnQsICJ0ZW1wbGF0ZVNvdXJjZURhdGFfIiArIGtleSwgYXJndW1lbnRzWzFdKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIC0tLS0ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlIC0tLS0tCiAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGVzIGFyZSBub3JtYWxseSBzYXZlZC9yZXRyaWV2ZWQgYXMgRE9NIG5vZGVzIHRocm91Z2ggIm5vZGVzIi4KICAgIC8vIEZvciBjb21wYXRpYmlsaXR5LCB5b3UgY2FuIGFsc28gcmVhZCAidGV4dCI7IGl0IHdpbGwgYmUgc2VyaWFsaXplZCBmcm9tIHRoZSBub2RlcyBvbiBkZW1hbmQuCiAgICAvLyBXcml0aW5nIHRvICJ0ZXh0IiBpcyBzdGlsbCBzdXBwb3J0ZWQsIGJ1dCB0aGVuIHRoZSB0ZW1wbGF0ZSBkYXRhIHdpbGwgbm90IGJlIGF2YWlsYWJsZSBhcyBET00gbm9kZXMuCgogICAgdmFyIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkgPSAiX19rb19hbm9uX3RlbXBsYXRlX18iOwogICAga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHRoaXMuZG9tRWxlbWVudCA9IGVsZW1lbnQ7CiAgICB9CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlID0gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50KCk7CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBrby51dGlscy5kb21EYXRhLmdldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkpIHx8IHt9OwogICAgICAgICAgICBpZiAodGVtcGxhdGVEYXRhLnRleHREYXRhID09PSB1bmRlZmluZWQgJiYgdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGEpCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZURhdGEudGV4dERhdGEgPSB0ZW1wbGF0ZURhdGEuY29udGFpbmVyRGF0YS5pbm5lckhUTUw7CiAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZURhdGEudGV4dERhdGE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5LCB7dGV4dERhdGE6IHZhbHVlVG9Xcml0ZX0pOwogICAgICAgIH0KICAgIH07CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudC5wcm90b3R5cGVbJ25vZGVzJ10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBrby51dGlscy5kb21EYXRhLmdldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkpIHx8IHt9OwogICAgICAgICAgICByZXR1cm4gdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5LCB7Y29udGFpbmVyRGF0YTogdmFsdWVUb1dyaXRlfSk7CiAgICAgICAgfQogICAgfTsKCiAgICBrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlU291cmNlcycsIGtvLnRlbXBsYXRlU291cmNlcyk7CiAgICBrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlU291cmNlcy5kb21FbGVtZW50Jywga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQpOwogICAga28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUnLCBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUpOwp9KSgpOwooZnVuY3Rpb24gKCkgewogICAgdmFyIF90ZW1wbGF0ZUVuZ2luZTsKICAgIGtvLnNldFRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKHRlbXBsYXRlRW5naW5lKSB7CiAgICAgICAgaWYgKCh0ZW1wbGF0ZUVuZ2luZSAhPSB1bmRlZmluZWQpICYmICEodGVtcGxhdGVFbmdpbmUgaW5zdGFuY2VvZiBrby50ZW1wbGF0ZUVuZ2luZSkpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidGVtcGxhdGVFbmdpbmUgbXVzdCBpbmhlcml0IGZyb20ga28udGVtcGxhdGVFbmdpbmUiKTsKICAgICAgICBfdGVtcGxhdGVFbmdpbmUgPSB0ZW1wbGF0ZUVuZ2luZTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbnZva2VGb3JFYWNoTm9kZU9yQ29tbWVudEluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGFjdGlvbikgewogICAgICAgIHZhciBub2RlLCBuZXh0SW5RdWV1ZSA9IGZpcnN0Tm9kZSwgZmlyc3RPdXRPZlJhbmdlTm9kZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhsYXN0Tm9kZSk7CiAgICAgICAgd2hpbGUgKG5leHRJblF1ZXVlICYmICgobm9kZSA9IG5leHRJblF1ZXVlKSAhPT0gZmlyc3RPdXRPZlJhbmdlTm9kZSkpIHsKICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcobm9kZSk7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxIHx8IG5vZGUubm9kZVR5cGUgPT09IDgpCiAgICAgICAgICAgICAgICBhY3Rpb24obm9kZSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGFjdGl2YXRlQmluZGluZ3NPbkNvbnRpbnVvdXNOb2RlQXJyYXkoY29udGludW91c05vZGVBcnJheSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAvLyBUbyBiZSB1c2VkIG9uIGFueSBub2RlcyB0aGF0IGhhdmUgYmVlbiByZW5kZXJlZCBieSBhIHRlbXBsYXRlIGFuZCBoYXZlIGJlZW4gaW5zZXJ0ZWQgaW50byBzb21lIHBhcmVudCBlbGVtZW50CiAgICAgICAgLy8gV2Fsa3MgdGhyb3VnaCBjb250aW51b3VzTm9kZUFycmF5ICh3aGljaCAqbXVzdCogYmUgY29udGludW91cywgaS5lLiwgYW4gdW5pbnRlcnJ1cHRlZCBzZXF1ZW5jZSBvZiBzaWJsaW5nIG5vZGVzLCBiZWNhdXNlCiAgICAgICAgLy8gdGhlIGFsZ29yaXRobSBmb3Igd2Fsa2luZyB0aGVtIHJlbGllcyBvbiB0aGlzKSwgYW5kIGZvciBlYWNoIHRvcC1sZXZlbCBpdGVtIGluIHRoZSB2aXJ0dWFsLWVsZW1lbnQgc2Vuc2UsCiAgICAgICAgLy8gKDEpIERvZXMgYSByZWd1bGFyICJhcHBseUJpbmRpbmdzIiB0byBhc3NvY2lhdGUgYmluZGluZ0NvbnRleHQgd2l0aCB0aGlzIG5vZGUgYW5kIHRvIGFjdGl2YXRlIGFueSBub24tbWVtb2l6ZWQgYmluZGluZ3MKICAgICAgICAvLyAoMikgVW5tZW1vaXplcyBhbnkgbWVtb3MgaW4gdGhlIERPTSBzdWJ0cmVlIChlLmcuLCB0byBhY3RpdmF0ZSBiaW5kaW5ncyB0aGF0IGhhZCBiZWVuIG1lbW9pemVkIGR1cmluZyB0ZW1wbGF0ZSByZXdyaXRpbmcpCgogICAgICAgIGlmIChjb250aW51b3VzTm9kZUFycmF5Lmxlbmd0aCkgewogICAgICAgICAgICB2YXIgZmlyc3ROb2RlID0gY29udGludW91c05vZGVBcnJheVswXSwgbGFzdE5vZGUgPSBjb250aW51b3VzTm9kZUFycmF5W2NvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoIC0gMV07CgogICAgICAgICAgICAvLyBOZWVkIHRvIGFwcGx5QmluZGluZ3MgKmJlZm9yZSogdW5tZW1vemlhdGlvbiwgYmVjYXVzZSB1bm1lbW9pemF0aW9uIG1pZ2h0IGludHJvZHVjZSBleHRyYSBub2RlcyAodGhhdCB3ZSBkb24ndCB3YW50IHRvIHJlLWJpbmQpCiAgICAgICAgICAgIC8vIHdoZXJlYXMgYSByZWd1bGFyIGFwcGx5QmluZGluZ3Mgd29uJ3QgaW50cm9kdWNlIG5ldyBtZW1vaXplZCBub2RlcwogICAgICAgICAgICBpbnZva2VGb3JFYWNoTm9kZU9yQ29tbWVudEluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ3MoYmluZGluZ0NvbnRleHQsIG5vZGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaW52b2tlRm9yRWFjaE5vZGVPckNvbW1lbnRJbkNvbnRpbnVvdXNSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICBrby5tZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMobm9kZSwgW2JpbmRpbmdDb250ZXh0XSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheShub2RlT3JOb2RlQXJyYXkpIHsKICAgICAgICByZXR1cm4gbm9kZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gbm9kZU9yTm9kZUFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG5vZGVPck5vZGVBcnJheS5sZW5ndGggPiAwID8gbm9kZU9yTm9kZUFycmF5WzBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gZXhlY3V0ZVRlbXBsYXRlKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSwgdGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdmFyIGZpcnN0VGFyZ2V0Tm9kZSA9IHRhcmdldE5vZGVPck5vZGVBcnJheSAmJiBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheSh0YXJnZXROb2RlT3JOb2RlQXJyYXkpOwogICAgICAgIHZhciB0ZW1wbGF0ZURvY3VtZW50ID0gZmlyc3RUYXJnZXROb2RlICYmIGZpcnN0VGFyZ2V0Tm9kZS5vd25lckRvY3VtZW50OwogICAgICAgIHZhciB0ZW1wbGF0ZUVuZ2luZVRvVXNlID0gKG9wdGlvbnNbJ3RlbXBsYXRlRW5naW5lJ10gfHwgX3RlbXBsYXRlRW5naW5lKTsKICAgICAgICBrby50ZW1wbGF0ZVJld3JpdGluZy5lbnN1cmVUZW1wbGF0ZUlzUmV3cml0dGVuKHRlbXBsYXRlLCB0ZW1wbGF0ZUVuZ2luZVRvVXNlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgICAgICB2YXIgcmVuZGVyZWROb2Rlc0FycmF5ID0gdGVtcGxhdGVFbmdpbmVUb1VzZVsncmVuZGVyVGVtcGxhdGUnXSh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRlbXBsYXRlRG9jdW1lbnQpOwoKICAgICAgICAvLyBMb29zZWx5IGNoZWNrIHJlc3VsdCBpcyBhbiBhcnJheSBvZiBET00gbm9kZXMKICAgICAgICBpZiAoKHR5cGVvZiByZW5kZXJlZE5vZGVzQXJyYXkubGVuZ3RoICE9ICJudW1iZXIiKSB8fCAocmVuZGVyZWROb2Rlc0FycmF5Lmxlbmd0aCA+IDAgJiYgdHlwZW9mIHJlbmRlcmVkTm9kZXNBcnJheVswXS5ub2RlVHlwZSAhPSAibnVtYmVyIikpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGVtcGxhdGUgZW5naW5lIG11c3QgcmV0dXJuIGFuIGFycmF5IG9mIERPTSBub2RlcyIpOwoKICAgICAgICB2YXIgaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCA9IGZhbHNlOwogICAgICAgIHN3aXRjaCAocmVuZGVyTW9kZSkgewogICAgICAgICAgICBjYXNlICJyZXBsYWNlQ2hpbGRyZW4iOgogICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbih0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlcmVkTm9kZXNBcnJheSk7CiAgICAgICAgICAgICAgICBoYXZlQWRkZWROb2Rlc1RvUGFyZW50ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJyZXBsYWNlTm9kZSI6CiAgICAgICAgICAgICAgICBrby51dGlscy5yZXBsYWNlRG9tTm9kZXModGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJlZE5vZGVzQXJyYXkpOwogICAgICAgICAgICAgICAgaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaWdub3JlVGFyZ2V0Tm9kZSI6IGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHJlbmRlck1vZGU6ICIgKyByZW5kZXJNb2RlKTsKICAgICAgICB9CgogICAgICAgIGlmIChoYXZlQWRkZWROb2Rlc1RvUGFyZW50KSB7CiAgICAgICAgICAgIGFjdGl2YXRlQmluZGluZ3NPbkNvbnRpbnVvdXNOb2RlQXJyYXkocmVuZGVyZWROb2Rlc0FycmF5LCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIGlmIChvcHRpb25zWydhZnRlclJlbmRlciddKQogICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSwgbnVsbCwgW3JlbmRlcmVkTm9kZXNBcnJheSwgYmluZGluZ0NvbnRleHRbJyRkYXRhJ11dKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZW5kZXJlZE5vZGVzQXJyYXk7CiAgICB9CgogICAga28ucmVuZGVyVGVtcGxhdGUgPSBmdW5jdGlvbiAodGVtcGxhdGUsIGRhdGFPckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCB0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlck1vZGUpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICBpZiAoKG9wdGlvbnNbJ3RlbXBsYXRlRW5naW5lJ10gfHwgX3RlbXBsYXRlRW5naW5lKSA9PSB1bmRlZmluZWQpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2V0IGEgdGVtcGxhdGUgZW5naW5lIGJlZm9yZSBjYWxsaW5nIHJlbmRlclRlbXBsYXRlIik7CiAgICAgICAgcmVuZGVyTW9kZSA9IHJlbmRlck1vZGUgfHwgInJlcGxhY2VDaGlsZHJlbiI7CgogICAgICAgIGlmICh0YXJnZXROb2RlT3JOb2RlQXJyYXkpIHsKICAgICAgICAgICAgdmFyIGZpcnN0VGFyZ2V0Tm9kZSA9IGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CgogICAgICAgICAgICB2YXIgd2hlblRvRGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICghZmlyc3RUYXJnZXROb2RlKSB8fCAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KGZpcnN0VGFyZ2V0Tm9kZSk7IH07IC8vIFBhc3NpdmUgZGlzcG9zYWwgKG9uIG5leHQgZXZhbHVhdGlvbikKICAgICAgICAgICAgdmFyIGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkID0gKGZpcnN0VGFyZ2V0Tm9kZSAmJiByZW5kZXJNb2RlID09ICJyZXBsYWNlTm9kZSIpID8gZmlyc3RUYXJnZXROb2RlLnBhcmVudE5vZGUgOiBmaXJzdFRhcmdldE5vZGU7CgogICAgICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZSggLy8gU28gdGhlIERPTSBpcyBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgd2hlbiBhbnkgZGVwZW5kZW5jeSBjaGFuZ2VzCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIHdlJ3ZlIGdvdCBhIHByb3BlciBiaW5kaW5nIGNvbnRleHQgdG8gd29yayB3aXRoCiAgICAgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdDb250ZXh0ID0gKGRhdGFPckJpbmRpbmdDb250ZXh0ICYmIChkYXRhT3JCaW5kaW5nQ29udGV4dCBpbnN0YW5jZW9mIGtvLmJpbmRpbmdDb250ZXh0KSkKICAgICAgICAgICAgICAgICAgICAgICAgPyBkYXRhT3JCaW5kaW5nQ29udGV4dAogICAgICAgICAgICAgICAgICAgICAgICA6IG5ldyBrby5iaW5kaW5nQ29udGV4dChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGFPckJpbmRpbmdDb250ZXh0KSk7CgogICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQgc2VsZWN0aW5nIHRlbXBsYXRlIGFzIGEgZnVuY3Rpb24gb2YgdGhlIGRhdGEgYmVpbmcgcmVuZGVyZWQKICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVOYW1lID0gdHlwZW9mKHRlbXBsYXRlKSA9PSAnZnVuY3Rpb24nID8gdGVtcGxhdGUoYmluZGluZ0NvbnRleHRbJyRkYXRhJ10sIGJpbmRpbmdDb250ZXh0KSA6IHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWROb2Rlc0FycmF5ID0gZXhlY3V0ZVRlbXBsYXRlKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSwgdGVtcGxhdGVOYW1lLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlck1vZGUgPT0gInJlcGxhY2VOb2RlIikgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXROb2RlT3JOb2RlQXJyYXkgPSByZW5kZXJlZE5vZGVzQXJyYXk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0VGFyZ2V0Tm9kZSA9IGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICB7IGRpc3Bvc2VXaGVuOiB3aGVuVG9EaXNwb3NlLCBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIH0KICAgICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBXZSBkb24ndCB5ZXQgaGF2ZSBhIERPTSBub2RlIHRvIGV2YWx1YXRlLCBzbyB1c2UgYSBtZW1vIGFuZCByZW5kZXIgdGhlIHRlbXBsYXRlIGxhdGVyIHdoZW4gdGhlcmUgaXMgYSBET00gbm9kZQogICAgICAgICAgICByZXR1cm4ga28ubWVtb2l6YXRpb24ubWVtb2l6ZShmdW5jdGlvbiAoZG9tTm9kZSkgewogICAgICAgICAgICAgICAga28ucmVuZGVyVGVtcGxhdGUodGVtcGxhdGUsIGRhdGFPckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCBkb21Ob2RlLCAicmVwbGFjZU5vZGUiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfTsKCiAgICBrby5yZW5kZXJUZW1wbGF0ZUZvckVhY2ggPSBmdW5jdGlvbiAodGVtcGxhdGUsIGFycmF5T3JPYnNlcnZhYmxlQXJyYXksIG9wdGlvbnMsIHRhcmdldE5vZGUsIHBhcmVudEJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgLy8gU2luY2Ugc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyBhbHdheXMgY2FsbHMgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtIGFuZCB0aGVuCiAgICAgICAgLy8gYWN0aXZhdGVCaW5kaW5nc0NhbGxiYWNrIGZvciBhZGRlZCBpdGVtcywgd2UgY2FuIHN0b3JlIHRoZSBiaW5kaW5nIGNvbnRleHQgaW4gdGhlIGZvcm1lciB0byB1c2UgaW4gdGhlIGxhdHRlci4KICAgICAgICB2YXIgYXJyYXlJdGVtQ29udGV4dDsKCiAgICAgICAgLy8gVGhpcyB3aWxsIGJlIGNhbGxlZCBieSBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIHRvIGdldCB0aGUgbm9kZXMgdG8gYWRkIHRvIHRhcmdldE5vZGUKICAgICAgICB2YXIgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtID0gZnVuY3Rpb24gKGFycmF5VmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgIC8vIFN1cHBvcnQgc2VsZWN0aW5nIHRlbXBsYXRlIGFzIGEgZnVuY3Rpb24gb2YgdGhlIGRhdGEgYmVpbmcgcmVuZGVyZWQKICAgICAgICAgICAgYXJyYXlJdGVtQ29udGV4dCA9IHBhcmVudEJpbmRpbmdDb250ZXh0WydjcmVhdGVDaGlsZENvbnRleHQnXShrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFycmF5VmFsdWUpLCBvcHRpb25zWydhcyddKTsKICAgICAgICAgICAgYXJyYXlJdGVtQ29udGV4dFsnJGluZGV4J10gPSBpbmRleDsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlTmFtZSA9IHR5cGVvZih0ZW1wbGF0ZSkgPT0gJ2Z1bmN0aW9uJyA/IHRlbXBsYXRlKGFycmF5VmFsdWUsIGFycmF5SXRlbUNvbnRleHQpIDogdGVtcGxhdGU7CiAgICAgICAgICAgIHJldHVybiBleGVjdXRlVGVtcGxhdGUobnVsbCwgImlnbm9yZVRhcmdldE5vZGUiLCB0ZW1wbGF0ZU5hbWUsIGFycmF5SXRlbUNvbnRleHQsIG9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgLy8gVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIGhhcyBhZGRlZCBub2RlcyB0byB0YXJnZXROb2RlCiAgICAgICAgdmFyIGFjdGl2YXRlQmluZGluZ3NDYWxsYmFjayA9IGZ1bmN0aW9uKGFycmF5VmFsdWUsIGFkZGVkTm9kZXNBcnJheSwgaW5kZXgpIHsKICAgICAgICAgICAgYWN0aXZhdGVCaW5kaW5nc09uQ29udGludW91c05vZGVBcnJheShhZGRlZE5vZGVzQXJyYXksIGFycmF5SXRlbUNvbnRleHQpOwogICAgICAgICAgICBpZiAob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSkKICAgICAgICAgICAgICAgIG9wdGlvbnNbJ2FmdGVyUmVuZGVyJ10oYWRkZWROb2Rlc0FycmF5LCBhcnJheVZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB1bndyYXBwZWRBcnJheSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYXJyYXlPck9ic2VydmFibGVBcnJheSkgfHwgW107CiAgICAgICAgICAgIGlmICh0eXBlb2YgdW53cmFwcGVkQXJyYXkubGVuZ3RoID09ICJ1bmRlZmluZWQiKSAvLyBDb2VyY2Ugc2luZ2xlIHZhbHVlIGludG8gYXJyYXkKICAgICAgICAgICAgICAgIHVud3JhcHBlZEFycmF5ID0gW3Vud3JhcHBlZEFycmF5XTsKCiAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgYW55IGVudHJpZXMgbWFya2VkIGFzIGRlc3Ryb3llZAogICAgICAgICAgICB2YXIgZmlsdGVyZWRBcnJheSA9IGtvLnV0aWxzLmFycmF5RmlsdGVyKHVud3JhcHBlZEFycmF5LCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uc1snaW5jbHVkZURlc3Ryb3llZCddIHx8IGl0ZW0gPT09IHVuZGVmaW5lZCB8fCBpdGVtID09PSBudWxsIHx8ICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGl0ZW1bJ19kZXN0cm95J10pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIENhbGwgc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZywgaWdub3JpbmcgYW55IG9ic2VydmFibGVzIHVud3JhcHBlZCB3aXRoaW4gKG1vc3QgbGlrZWx5IGZyb20gYSBjYWxsYmFjayBmdW5jdGlvbikuCiAgICAgICAgICAgIC8vIElmIHRoZSBhcnJheSBpdGVtcyBhcmUgb2JzZXJ2YWJsZXMsIHRob3VnaCwgdGhleSB3aWxsIGJlIHVud3JhcHBlZCBpbiBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0gYW5kIG1hbmFnZWQgd2l0aGluIHNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcuCiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcsIG51bGwsIFt0YXJnZXROb2RlLCBmaWx0ZXJlZEFycmF5LCBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0sIG9wdGlvbnMsIGFjdGl2YXRlQmluZGluZ3NDYWxsYmFja10pOwoKICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogdGFyZ2V0Tm9kZSB9KTsKICAgIH07CgogICAgdmFyIHRlbXBsYXRlQ29tcHV0ZWREb21EYXRhS2V5ID0gJ19fa29fX3RlbXBsYXRlQ29tcHV0ZWREb21EYXRhS2V5X18nOwogICAgZnVuY3Rpb24gZGlzcG9zZU9sZENvbXB1dGVkQW5kU3RvcmVOZXdPbmUoZWxlbWVudCwgbmV3Q29tcHV0ZWQpIHsKICAgICAgICB2YXIgb2xkQ29tcHV0ZWQgPSBrby51dGlscy5kb21EYXRhLmdldChlbGVtZW50LCB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSk7CiAgICAgICAgaWYgKG9sZENvbXB1dGVkICYmICh0eXBlb2Yob2xkQ29tcHV0ZWQuZGlzcG9zZSkgPT0gJ2Z1bmN0aW9uJykpCiAgICAgICAgICAgIG9sZENvbXB1dGVkLmRpc3Bvc2UoKTsKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSwgKG5ld0NvbXB1dGVkICYmIG5ld0NvbXB1dGVkLmlzQWN0aXZlKCkpID8gbmV3Q29tcHV0ZWQgOiB1bmRlZmluZWQpOwogICAgfQoKICAgIGtvLmJpbmRpbmdIYW5kbGVyc1sndGVtcGxhdGUnXSA9IHsKICAgICAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICAgICAgLy8gU3VwcG9ydCBhbm9ueW1vdXMgdGVtcGxhdGVzCiAgICAgICAgICAgIHZhciBiaW5kaW5nVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgICAgIGlmICgodHlwZW9mIGJpbmRpbmdWYWx1ZSAhPSAic3RyaW5nIikgJiYgKCFiaW5kaW5nVmFsdWVbJ25hbWUnXSkgJiYgKGVsZW1lbnQubm9kZVR5cGUgPT0gMSB8fCBlbGVtZW50Lm5vZGVUeXBlID09IDgpKSB7CiAgICAgICAgICAgICAgICAvLyBJdCdzIGFuIGFub255bW91cyB0ZW1wbGF0ZSAtIHN0b3JlIHRoZSBlbGVtZW50IGNvbnRlbnRzLCB0aGVuIGNsZWFyIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVOb2RlcyA9IGVsZW1lbnQubm9kZVR5cGUgPT0gMSA/IGVsZW1lbnQuY2hpbGROb2RlcyA6IGtvLnZpcnR1YWxFbGVtZW50cy5jaGlsZE5vZGVzKGVsZW1lbnQpLAogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lciA9IGtvLnV0aWxzLm1vdmVDbGVhbmVkTm9kZXNUb0NvbnRhaW5lckVsZW1lbnQodGVtcGxhdGVOb2Rlcyk7IC8vIFRoaXMgYWxzbyByZW1vdmVzIHRoZSBub2RlcyBmcm9tIHRoZWlyIGN1cnJlbnQgcGFyZW50CiAgICAgICAgICAgICAgICBuZXcga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlKGVsZW1lbnQpWydub2RlcyddKGNvbnRhaW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHsgJ2NvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzJzogdHJ1ZSB9OwogICAgICAgIH0sCiAgICAgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZU5hbWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSksCiAgICAgICAgICAgICAgICBvcHRpb25zID0ge30sCiAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0gdHJ1ZSwKICAgICAgICAgICAgICAgIGRhdGFWYWx1ZSwKICAgICAgICAgICAgICAgIHRlbXBsYXRlQ29tcHV0ZWQgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZU5hbWUgIT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB0ZW1wbGF0ZU5hbWU7CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZU5hbWUgPSBvcHRpb25zWyduYW1lJ107CgogICAgICAgICAgICAgICAgLy8gU3VwcG9ydCAiaWYiLyJpZm5vdCIgY29uZGl0aW9ucwogICAgICAgICAgICAgICAgaWYgKCdpZicgaW4gb3B0aW9ucykKICAgICAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShvcHRpb25zWydpZiddKTsKICAgICAgICAgICAgICAgIGlmIChzaG91bGREaXNwbGF5ICYmICdpZm5vdCcgaW4gb3B0aW9ucykKICAgICAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0gIWtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUob3B0aW9uc1snaWZub3QnXSk7CgogICAgICAgICAgICAgICAgZGF0YVZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShvcHRpb25zWydkYXRhJ10pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoJ2ZvcmVhY2gnIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIC8vIFJlbmRlciBvbmNlIGZvciBlYWNoIGRhdGEgcG9pbnQgKHRyZWF0aW5nIGRhdGEgc2V0IGFzIGVtcHR5IGlmIHNob3VsZERpc3BsYXk9PWZhbHNlKQogICAgICAgICAgICAgICAgdmFyIGRhdGFBcnJheSA9IChzaG91bGREaXNwbGF5ICYmIG9wdGlvbnNbJ2ZvcmVhY2gnXSkgfHwgW107CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZUNvbXB1dGVkID0ga28ucmVuZGVyVGVtcGxhdGVGb3JFYWNoKHRlbXBsYXRlTmFtZSB8fCBlbGVtZW50LCBkYXRhQXJyYXksIG9wdGlvbnMsIGVsZW1lbnQsIGJpbmRpbmdDb250ZXh0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICghc2hvdWxkRGlzcGxheSkgewogICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZShlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJlbmRlciBvbmNlIGZvciB0aGlzIHNpbmdsZSBkYXRhIHBvaW50IChvciB1c2UgdGhlIHZpZXdNb2RlbCBpZiBubyBkYXRhIHdhcyBwcm92aWRlZCkKICAgICAgICAgICAgICAgIHZhciBpbm5lckJpbmRpbmdDb250ZXh0ID0gKCdkYXRhJyBpbiBvcHRpb25zKSA/CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGRhdGFWYWx1ZSwgb3B0aW9uc1snYXMnXSkgOiAgLy8gR2l2ZW4gYW4gZXhwbGl0aXQgJ2RhdGEnIHZhbHVlLCB3ZSBjcmVhdGUgYSBjaGlsZCBiaW5kaW5nIGNvbnRleHQgZm9yIGl0CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ0NvbnRleHQ7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBHaXZlbiBubyBleHBsaWNpdCAnZGF0YScgdmFsdWUsIHdlIHJldGFpbiB0aGUgc2FtZSBiaW5kaW5nIGNvbnRleHQKICAgICAgICAgICAgICAgIHRlbXBsYXRlQ29tcHV0ZWQgPSBrby5yZW5kZXJUZW1wbGF0ZSh0ZW1wbGF0ZU5hbWUgfHwgZWxlbWVudCwgaW5uZXJCaW5kaW5nQ29udGV4dCwgb3B0aW9ucywgZWxlbWVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEl0IG9ubHkgbWFrZXMgc2Vuc2UgdG8gaGF2ZSBhIHNpbmdsZSB0ZW1wbGF0ZSBjb21wdXRlZCBwZXIgZWxlbWVudCAob3RoZXJ3aXNlIHdoaWNoIG9uZSBzaG91bGQgaGF2ZSBpdHMgb3V0cHV0IGRpc3BsYXllZD8pCiAgICAgICAgICAgIGRpc3Bvc2VPbGRDb21wdXRlZEFuZFN0b3JlTmV3T25lKGVsZW1lbnQsIHRlbXBsYXRlQ29tcHV0ZWQpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gQW5vbnltb3VzIHRlbXBsYXRlcyBjYW4ndCBiZSByZXdyaXR0ZW4uIEdpdmUgYSBuaWNlIGVycm9yIG1lc3NhZ2UgaWYgeW91IHRyeSB0byBkbyBpdC4KICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzWyd0ZW1wbGF0ZSddID0gZnVuY3Rpb24oYmluZGluZ1ZhbHVlKSB7CiAgICAgICAgdmFyIHBhcnNlZEJpbmRpbmdWYWx1ZSA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsKGJpbmRpbmdWYWx1ZSk7CgogICAgICAgIGlmICgocGFyc2VkQmluZGluZ1ZhbHVlLmxlbmd0aCA9PSAxKSAmJiBwYXJzZWRCaW5kaW5nVmFsdWVbMF1bJ3Vua25vd24nXSkKICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIEl0IGxvb2tzIGxpa2UgYSBzdHJpbmcgbGl0ZXJhbCwgbm90IGFuIG9iamVjdCBsaXRlcmFsLCBzbyB0cmVhdCBpdCBhcyBhIG5hbWVkIHRlbXBsYXRlICh3aGljaCBpcyBhbGxvd2VkIGZvciByZXdyaXRpbmcpCgogICAgICAgIGlmIChrby5leHByZXNzaW9uUmV3cml0aW5nLmtleVZhbHVlQXJyYXlDb250YWluc0tleShwYXJzZWRCaW5kaW5nVmFsdWUsICJuYW1lIikpCiAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBOYW1lZCB0ZW1wbGF0ZXMgY2FuIGJlIHJld3JpdHRlbiwgc28gcmV0dXJuICJubyBlcnJvciIKICAgICAgICByZXR1cm4gIlRoaXMgdGVtcGxhdGUgZW5naW5lIGRvZXMgbm90IHN1cHBvcnQgYW5vbnltb3VzIHRlbXBsYXRlcyBuZXN0ZWQgd2l0aGluIGl0cyB0ZW1wbGF0ZXMiOwogICAgfTsKCiAgICBrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWyd0ZW1wbGF0ZSddID0gdHJ1ZTsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgnc2V0VGVtcGxhdGVFbmdpbmUnLCBrby5zZXRUZW1wbGF0ZUVuZ2luZSk7CmtvLmV4cG9ydFN5bWJvbCgncmVuZGVyVGVtcGxhdGUnLCBrby5yZW5kZXJUZW1wbGF0ZSk7Cgprby51dGlscy5jb21wYXJlQXJyYXlzID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBzdGF0dXNOb3RJbk9sZCA9ICdhZGRlZCcsIHN0YXR1c05vdEluTmV3ID0gJ2RlbGV0ZWQnOwoKICAgIC8vIFNpbXBsZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBMZXZlbnNodGVpbiBkaXN0YW5jZS4KICAgIGZ1bmN0aW9uIGNvbXBhcmVBcnJheXMob2xkQXJyYXksIG5ld0FycmF5LCBkb250TGltaXRNb3ZlcykgewogICAgICAgIG9sZEFycmF5ID0gb2xkQXJyYXkgfHwgW107CiAgICAgICAgbmV3QXJyYXkgPSBuZXdBcnJheSB8fCBbXTsKCiAgICAgICAgaWYgKG9sZEFycmF5Lmxlbmd0aCA8PSBuZXdBcnJheS5sZW5ndGgpCiAgICAgICAgICAgIHJldHVybiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkob2xkQXJyYXksIG5ld0FycmF5LCBzdGF0dXNOb3RJbk9sZCwgc3RhdHVzTm90SW5OZXcsIGRvbnRMaW1pdE1vdmVzKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkobmV3QXJyYXksIG9sZEFycmF5LCBzdGF0dXNOb3RJbk5ldywgc3RhdHVzTm90SW5PbGQsIGRvbnRMaW1pdE1vdmVzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkoc21sQXJyYXksIGJpZ0FycmF5LCBzdGF0dXNOb3RJblNtbCwgc3RhdHVzTm90SW5CaWcsIGRvbnRMaW1pdE1vdmVzKSB7CiAgICAgICAgdmFyIG15TWluID0gTWF0aC5taW4sCiAgICAgICAgICAgIG15TWF4ID0gTWF0aC5tYXgsCiAgICAgICAgICAgIGVkaXREaXN0YW5jZU1hdHJpeCA9IFtdLAogICAgICAgICAgICBzbWxJbmRleCwgc21sSW5kZXhNYXggPSBzbWxBcnJheS5sZW5ndGgsCiAgICAgICAgICAgIGJpZ0luZGV4LCBiaWdJbmRleE1heCA9IGJpZ0FycmF5Lmxlbmd0aCwKICAgICAgICAgICAgY29tcGFyZVJhbmdlID0gKGJpZ0luZGV4TWF4IC0gc21sSW5kZXhNYXgpIHx8IDEsCiAgICAgICAgICAgIG1heERpc3RhbmNlID0gc21sSW5kZXhNYXggKyBiaWdJbmRleE1heCArIDEsCiAgICAgICAgICAgIHRoaXNSb3csIGxhc3RSb3csCiAgICAgICAgICAgIGJpZ0luZGV4TWF4Rm9yUm93LCBiaWdJbmRleE1pbkZvclJvdzsKCiAgICAgICAgZm9yIChzbWxJbmRleCA9IDA7IHNtbEluZGV4IDw9IHNtbEluZGV4TWF4OyBzbWxJbmRleCsrKSB7CiAgICAgICAgICAgIGxhc3RSb3cgPSB0aGlzUm93OwogICAgICAgICAgICBlZGl0RGlzdGFuY2VNYXRyaXgucHVzaCh0aGlzUm93ID0gW10pOwogICAgICAgICAgICBiaWdJbmRleE1heEZvclJvdyA9IG15TWluKGJpZ0luZGV4TWF4LCBzbWxJbmRleCArIGNvbXBhcmVSYW5nZSk7CiAgICAgICAgICAgIGJpZ0luZGV4TWluRm9yUm93ID0gbXlNYXgoMCwgc21sSW5kZXggLSAxKTsKICAgICAgICAgICAgZm9yIChiaWdJbmRleCA9IGJpZ0luZGV4TWluRm9yUm93OyBiaWdJbmRleCA8PSBiaWdJbmRleE1heEZvclJvdzsgYmlnSW5kZXgrKykgewogICAgICAgICAgICAgICAgaWYgKCFiaWdJbmRleCkKICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IHNtbEluZGV4ICsgMTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFzbWxJbmRleCkgIC8vIFRvcCByb3cgLSB0cmFuc2Zvcm0gZW1wdHkgYXJyYXkgaW50byBuZXcgYXJyYXkgdmlhIGFkZGl0aW9ucwogICAgICAgICAgICAgICAgICAgIHRoaXNSb3dbYmlnSW5kZXhdID0gYmlnSW5kZXggKyAxOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoc21sQXJyYXlbc21sSW5kZXggLSAxXSA9PT0gYmlnQXJyYXlbYmlnSW5kZXggLSAxXSkKICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IGxhc3RSb3dbYmlnSW5kZXggLSAxXTsgICAgICAgICAgICAgICAgICAvLyBjb3B5IHZhbHVlIChubyBlZGl0KQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5vcnRoRGlzdGFuY2UgPSBsYXN0Um93W2JpZ0luZGV4XSB8fCBtYXhEaXN0YW5jZTsgICAgICAgLy8gbm90IGluIGJpZyAoZGVsZXRpb24pCiAgICAgICAgICAgICAgICAgICAgdmFyIHdlc3REaXN0YW5jZSA9IHRoaXNSb3dbYmlnSW5kZXggLSAxXSB8fCBtYXhEaXN0YW5jZTsgICAgLy8gbm90IGluIHNtYWxsIChhZGRpdGlvbikKICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IG15TWluKG5vcnRoRGlzdGFuY2UsIHdlc3REaXN0YW5jZSkgKyAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgZWRpdFNjcmlwdCA9IFtdLCBtZU1pbnVzT25lLCBub3RJblNtbCA9IFtdLCBub3RJbkJpZyA9IFtdOwogICAgICAgIGZvciAoc21sSW5kZXggPSBzbWxJbmRleE1heCwgYmlnSW5kZXggPSBiaWdJbmRleE1heDsgc21sSW5kZXggfHwgYmlnSW5kZXg7KSB7CiAgICAgICAgICAgIG1lTWludXNPbmUgPSBlZGl0RGlzdGFuY2VNYXRyaXhbc21sSW5kZXhdW2JpZ0luZGV4XSAtIDE7CiAgICAgICAgICAgIGlmIChiaWdJbmRleCAmJiBtZU1pbnVzT25lID09PSBlZGl0RGlzdGFuY2VNYXRyaXhbc21sSW5kZXhdW2JpZ0luZGV4LTFdKSB7CiAgICAgICAgICAgICAgICBub3RJblNtbC5wdXNoKGVkaXRTY3JpcHRbZWRpdFNjcmlwdC5sZW5ndGhdID0geyAgICAgLy8gYWRkZWQKICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJzogc3RhdHVzTm90SW5TbWwsCiAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogYmlnQXJyYXlbLS1iaWdJbmRleF0sCiAgICAgICAgICAgICAgICAgICAgJ2luZGV4JzogYmlnSW5kZXggfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc21sSW5kZXggJiYgbWVNaW51c09uZSA9PT0gZWRpdERpc3RhbmNlTWF0cml4W3NtbEluZGV4IC0gMV1bYmlnSW5kZXhdKSB7CiAgICAgICAgICAgICAgICBub3RJbkJpZy5wdXNoKGVkaXRTY3JpcHRbZWRpdFNjcmlwdC5sZW5ndGhdID0geyAgICAgLy8gZGVsZXRlZAogICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiBzdGF0dXNOb3RJbkJpZywKICAgICAgICAgICAgICAgICAgICAndmFsdWUnOiBzbWxBcnJheVstLXNtbEluZGV4XSwKICAgICAgICAgICAgICAgICAgICAnaW5kZXgnOiBzbWxJbmRleCB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVkaXRTY3JpcHQucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cyc6ICJyZXRhaW5lZCIsCiAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogYmlnQXJyYXlbLS1iaWdJbmRleF0gfSk7CiAgICAgICAgICAgICAgICAtLXNtbEluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobm90SW5TbWwubGVuZ3RoICYmIG5vdEluQmlnLmxlbmd0aCkgewogICAgICAgICAgICAvLyBTZXQgYSBsaW1pdCBvbiB0aGUgbnVtYmVyIG9mIGNvbnNlY3V0aXZlIG5vbi1tYXRjaGluZyBjb21wYXJpc29uczsgaGF2aW5nIGl0IGEgbXVsdGlwbGUgb2YKICAgICAgICAgICAgLy8gc21sSW5kZXhNYXgga2VlcHMgdGhlIHRpbWUgY29tcGxleGl0eSBvZiB0aGlzIGFsZ29yaXRobSBsaW5lYXIuCiAgICAgICAgICAgIHZhciBsaW1pdEZhaWxlZENvbXBhcmVzID0gc21sSW5kZXhNYXggKiAxMCwgZmFpbGVkQ29tcGFyZXMsCiAgICAgICAgICAgICAgICBhLCBkLCBub3RJblNtbEl0ZW0sIG5vdEluQmlnSXRlbTsKICAgICAgICAgICAgLy8gR28gdGhyb3VnaCB0aGUgaXRlbXMgdGhhdCBoYXZlIGJlZW4gYWRkZWQgYW5kIGRlbGV0ZWQgYW5kIHRyeSB0byBmaW5kIG1hdGNoZXMgYmV0d2VlbiB0aGVtLgogICAgICAgICAgICBmb3IgKGZhaWxlZENvbXBhcmVzID0gYSA9IDA7IChkb250TGltaXRNb3ZlcyB8fCBmYWlsZWRDb21wYXJlcyA8IGxpbWl0RmFpbGVkQ29tcGFyZXMpICYmIChub3RJblNtbEl0ZW0gPSBub3RJblNtbFthXSk7IGErKykgewogICAgICAgICAgICAgICAgZm9yIChkID0gMDsgbm90SW5CaWdJdGVtID0gbm90SW5CaWdbZF07IGQrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChub3RJblNtbEl0ZW1bJ3ZhbHVlJ10gPT09IG5vdEluQmlnSXRlbVsndmFsdWUnXSkgewogICAgICAgICAgICAgICAgICAgICAgICBub3RJblNtbEl0ZW1bJ21vdmVkJ10gPSBub3RJbkJpZ0l0ZW1bJ2luZGV4J107CiAgICAgICAgICAgICAgICAgICAgICAgIG5vdEluQmlnSXRlbVsnbW92ZWQnXSA9IG5vdEluU21sSXRlbVsnaW5kZXgnXTsKICAgICAgICAgICAgICAgICAgICAgICAgbm90SW5CaWcuc3BsaWNlKGQsMSk7ICAgICAgIC8vIFRoaXMgaXRlbSBpcyBtYXJrZWQgYXMgbW92ZWQ7IHNvIHJlbW92ZSBpdCBmcm9tIG5vdEluQmlnIGxpc3QKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkQ29tcGFyZXMgPSBkID0gMDsgICAgIC8vIFJlc2V0IGZhaWxlZCBjb21wYXJlcyBjb3VudCBiZWNhdXNlIHdlJ3JlIGNoZWNraW5nIGZvciBjb25zZWN1dGl2ZSBmYWlsdXJlcwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmYWlsZWRDb21wYXJlcyArPSBkOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBlZGl0U2NyaXB0LnJldmVyc2UoKTsKICAgIH0KCiAgICByZXR1cm4gY29tcGFyZUFycmF5czsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuY29tcGFyZUFycmF5cycsIGtvLnV0aWxzLmNvbXBhcmVBcnJheXMpOwoKKGZ1bmN0aW9uICgpIHsKICAgIC8vIE9iamVjdGl2ZToKICAgIC8vICogR2l2ZW4gYW4gaW5wdXQgYXJyYXksIGEgY29udGFpbmVyIERPTSBub2RlLCBhbmQgYSBmdW5jdGlvbiBmcm9tIGFycmF5IGVsZW1lbnRzIHRvIGFycmF5cyBvZiBET00gbm9kZXMsCiAgICAvLyAgIG1hcCB0aGUgYXJyYXkgZWxlbWVudHMgdG8gYXJyYXlzIG9mIERPTSBub2RlcywgY29uY2F0ZW5hdGUgdG9nZXRoZXIgYWxsIHRoZXNlIGFycmF5cywgYW5kIHVzZSB0aGVtIHRvIHBvcHVsYXRlIHRoZSBjb250YWluZXIgRE9NIG5vZGUKICAgIC8vICogTmV4dCB0aW1lIHdlJ3JlIGdpdmVuIHRoZSBzYW1lIGNvbWJpbmF0aW9uIG9mIHRoaW5ncyAod2l0aCB0aGUgYXJyYXkgcG9zc2libHkgaGF2aW5nIG11dGF0ZWQpLCB1cGRhdGUgdGhlIGNvbnRhaW5lciBET00gbm9kZQogICAgLy8gICBzbyB0aGF0IGl0cyBjaGlsZHJlbiBpcyBhZ2FpbiB0aGUgY29uY2F0ZW5hdGlvbiBvZiB0aGUgbWFwcGluZ3Mgb2YgdGhlIGFycmF5IGVsZW1lbnRzLCBidXQgZG9uJ3QgcmUtbWFwIGFueSBhcnJheSBlbGVtZW50cyB0aGF0IHdlCiAgICAvLyAgIHByZXZpb3VzbHkgbWFwcGVkIC0gcmV0YWluIHRob3NlIG5vZGVzLCBhbmQganVzdCBpbnNlcnQvZGVsZXRlIG90aGVyIG9uZXMKCiAgICAvLyAiY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzIiB3aWxsIGJlIGludm9rZWQgYWZ0ZXIgYW55ICJtYXBwaW5nIi1nZW5lcmF0ZWQgbm9kZXMgYXJlIGluc2VydGVkIGludG8gdGhlIGNvbnRhaW5lciBub2RlCiAgICAvLyBZb3UgY2FuIHVzZSB0aGlzLCBmb3IgZXhhbXBsZSwgdG8gYWN0aXZhdGUgYmluZGluZ3Mgb24gdGhvc2Ugbm9kZXMuCgogICAgZnVuY3Rpb24gZml4VXBOb2Rlc1RvQmVNb3ZlZE9yUmVtb3ZlZChjb250aWd1b3VzTm9kZUFycmF5KSB7CiAgICAgICAgLy8gQmVmb3JlIG1vdmluZywgZGVsZXRpbmcsIG9yIHJlcGxhY2luZyBhIHNldCBvZiBub2RlcyB0aGF0IHdlcmUgcHJldmlvdXNseSBvdXRwdXR0ZWQgYnkgdGhlICJtYXAiIGZ1bmN0aW9uLCB3ZSBoYXZlIHRvIHJlY29uY2lsZQogICAgICAgIC8vIHRoZW0gYWdhaW5zdCB3aGF0IGlzIGluIHRoZSBET00gcmlnaHQgbm93LiBJdCBtYXkgYmUgdGhhdCBzb21lIG9mIHRoZSBub2RlcyBoYXZlIGFscmVhZHkgYmVlbiByZW1vdmVkIGZyb20gdGhlIGRvY3VtZW50LAogICAgICAgIC8vIG9yIHRoYXQgbmV3IG5vZGVzIG1pZ2h0IGhhdmUgYmVlbiBpbnNlcnRlZCBpbiB0aGUgbWlkZGxlLCBmb3IgZXhhbXBsZSBieSBhIGJpbmRpbmcuIEFsc28sIHRoZXJlIG1heSBwcmV2aW91c2x5IGhhdmUgYmVlbgogICAgICAgIC8vIGxlYWRpbmcgY29tbWVudCBub2RlcyAoY3JlYXRlZCBieSByZXdyaXR0ZW4gc3RyaW5nLWJhc2VkIHRlbXBsYXRlcykgdGhhdCBoYXZlIHNpbmNlIGJlZW4gcmVtb3ZlZCBkdXJpbmcgYmluZGluZy4KICAgICAgICAvLyBTbywgdGhpcyBmdW5jdGlvbiB0cmFuc2xhdGVzIHRoZSBvbGQgIm1hcCIgb3V0cHV0IGFycmF5IGludG8gaXRzIGJlc3QgZ3Vlc3Mgb2Ygd2hhdCBzZXQgb2YgY3VycmVudCBET00gbm9kZXMgc2hvdWxkIGJlIHJlbW92ZWQuCiAgICAgICAgLy8KICAgICAgICAvLyBSdWxlczoKICAgICAgICAvLyAgIFtBXSBBbnkgbGVhZGluZyBub2RlcyB0aGF0IGFyZW4ndCBpbiB0aGUgZG9jdW1lbnQgYW55IG1vcmUgc2hvdWxkIGJlIGlnbm9yZWQKICAgICAgICAvLyAgICAgICBUaGVzZSBtb3N0IGxpa2VseSBjb3JyZXNwb25kIHRvIG1lbW9pemF0aW9uIG5vZGVzIHRoYXQgd2VyZSBhbHJlYWR5IHJlbW92ZWQgZHVyaW5nIGJpbmRpbmcKICAgICAgICAvLyAgICAgICBTZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvNDQwCiAgICAgICAgLy8gICBbQl0gV2Ugd2FudCB0byBvdXRwdXQgYSBjb250aWd1b3VzIHNlcmllcyBvZiBub2RlcyB0aGF0IGFyZSBzdGlsbCBpbiB0aGUgZG9jdW1lbnQuIFNvLCBpZ25vcmUgYW55IG5vZGVzIHRoYXQKICAgICAgICAvLyAgICAgICBoYXZlIGFscmVhZHkgYmVlbiByZW1vdmVkLCBhbmQgaW5jbHVkZSBhbnkgbm9kZXMgdGhhdCBoYXZlIGJlZW4gaW5zZXJ0ZWQgYW1vbmcgdGhlIHByZXZpb3VzIGNvbGxlY3Rpb24KCiAgICAgICAgLy8gUnVsZSBbQV0KICAgICAgICB3aGlsZSAoY29udGlndW91c05vZGVBcnJheS5sZW5ndGggJiYgIWtvLnV0aWxzLmRvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChjb250aWd1b3VzTm9kZUFycmF5WzBdKSkKICAgICAgICAgICAgY29udGlndW91c05vZGVBcnJheS5zcGxpY2UoMCwgMSk7CgogICAgICAgIC8vIFJ1bGUgW0JdCiAgICAgICAgaWYgKGNvbnRpZ3VvdXNOb2RlQXJyYXkubGVuZ3RoID4gMSkgewogICAgICAgICAgICAvLyBCdWlsZCB1cCB0aGUgYWN0dWFsIG5ldyBjb250aWd1b3VzIG5vZGUgc2V0CiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gY29udGlndW91c05vZGVBcnJheVswXSwgbGFzdCA9IGNvbnRpZ3VvdXNOb2RlQXJyYXlbY29udGlndW91c05vZGVBcnJheS5sZW5ndGggLSAxXSwgbmV3Q29udGlndW91c1NldCA9IFtjdXJyZW50XTsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgIT09IGxhc3QpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50Lm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgaWYgKCFjdXJyZW50KSAvLyBXb24ndCBoYXBwZW4sIGV4Y2VwdCBpZiB0aGUgZGV2ZWxvcGVyIGhhcyBtYW51YWxseSByZW1vdmVkIHNvbWUgRE9NIGVsZW1lbnRzICh0aGVuIHdlJ3JlIGluIGFuIHVuZGVmaW5lZCBzY2VuYXJpbykKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBuZXdDb250aWd1b3VzU2V0LnB1c2goY3VycmVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC4uLiB0aGVuIG11dGF0ZSB0aGUgaW5wdXQgYXJyYXkgdG8gbWF0Y2ggdGhpcy4KICAgICAgICAgICAgLy8gKFRoZSBmb2xsb3dpbmcgbGluZSByZXBsYWNlcyB0aGUgY29udGVudHMgb2YgY29udGlndW91c05vZGVBcnJheSB3aXRoIG5ld0NvbnRpZ3VvdXNTZXQpCiAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UuYXBwbHkoY29udGlndW91c05vZGVBcnJheSwgWzAsIGNvbnRpZ3VvdXNOb2RlQXJyYXkubGVuZ3RoXS5jb25jYXQobmV3Q29udGlndW91c1NldCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29udGlndW91c05vZGVBcnJheTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYXBOb2RlQW5kUmVmcmVzaFdoZW5DaGFuZ2VkKGNvbnRhaW5lck5vZGUsIG1hcHBpbmcsIHZhbHVlVG9NYXAsIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgaW5kZXgpIHsKICAgICAgICAvLyBNYXAgdGhpcyBhcnJheSB2YWx1ZSBpbnNpZGUgYSBkZXBlbmRlbnRPYnNlcnZhYmxlIHNvIHdlIHJlLW1hcCB3aGVuIGFueSBkZXBlbmRlbmN5IGNoYW5nZXMKICAgICAgICB2YXIgbWFwcGVkTm9kZXMgPSBbXTsKICAgICAgICB2YXIgZGVwZW5kZW50T2JzZXJ2YWJsZSA9IGtvLmRlcGVuZGVudE9ic2VydmFibGUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBuZXdNYXBwZWROb2RlcyA9IG1hcHBpbmcodmFsdWVUb01hcCwgaW5kZXgpIHx8IFtdOwoKICAgICAgICAgICAgLy8gT24gc3Vic2VxdWVudCBldmFsdWF0aW9ucywganVzdCByZXBsYWNlIHRoZSBwcmV2aW91c2x5LWluc2VydGVkIERPTSBub2RlcwogICAgICAgICAgICBpZiAobWFwcGVkTm9kZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAga28udXRpbHMucmVwbGFjZURvbU5vZGVzKGZpeFVwTm9kZXNUb0JlTW92ZWRPclJlbW92ZWQobWFwcGVkTm9kZXMpLCBuZXdNYXBwZWROb2Rlcyk7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKQogICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgbnVsbCwgW3ZhbHVlVG9NYXAsIG5ld01hcHBlZE5vZGVzLCBpbmRleF0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXBsYWNlIHRoZSBjb250ZW50cyBvZiB0aGUgbWFwcGVkTm9kZXMgYXJyYXksIHRoZXJlYnkgdXBkYXRpbmcgdGhlIHJlY29yZAogICAgICAgICAgICAvLyBvZiB3aGljaCBub2RlcyB3b3VsZCBiZSBkZWxldGVkIGlmIHZhbHVlVG9NYXAgd2FzIGl0c2VsZiBsYXRlciByZW1vdmVkCiAgICAgICAgICAgIG1hcHBlZE5vZGVzLnNwbGljZSgwLCBtYXBwZWROb2Rlcy5sZW5ndGgpOwogICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwobWFwcGVkTm9kZXMsIG5ld01hcHBlZE5vZGVzKTsKICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogY29udGFpbmVyTm9kZSwgZGlzcG9zZVdoZW46IGZ1bmN0aW9uKCkgeyByZXR1cm4gKG1hcHBlZE5vZGVzLmxlbmd0aCA9PSAwKSB8fCAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KG1hcHBlZE5vZGVzWzBdKSB9IH0pOwogICAgICAgIHJldHVybiB7IG1hcHBlZE5vZGVzIDogbWFwcGVkTm9kZXMsIGRlcGVuZGVudE9ic2VydmFibGUgOiAoZGVwZW5kZW50T2JzZXJ2YWJsZS5pc0FjdGl2ZSgpID8gZGVwZW5kZW50T2JzZXJ2YWJsZSA6IHVuZGVmaW5lZCkgfTsKICAgIH0KCiAgICB2YXIgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5ID0gInNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmdfbGFzdE1hcHBpbmdSZXN1bHQiOwoKICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcgPSBmdW5jdGlvbiAoZG9tTm9kZSwgYXJyYXksIG1hcHBpbmcsIG9wdGlvbnMsIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcykgewogICAgICAgIC8vIENvbXBhcmUgdGhlIHByb3ZpZGVkIGFycmF5IGFnYWluc3QgdGhlIHByZXZpb3VzIG9uZQogICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdmFyIGlzRmlyc3RFeGVjdXRpb24gPSBrby51dGlscy5kb21EYXRhLmdldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXkpID09PSB1bmRlZmluZWQ7CiAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0ID0ga28udXRpbHMuZG9tRGF0YS5nZXQoZG9tTm9kZSwgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5KSB8fCBbXTsKICAgICAgICB2YXIgbGFzdEFycmF5ID0ga28udXRpbHMuYXJyYXlNYXAobGFzdE1hcHBpbmdSZXN1bHQsIGZ1bmN0aW9uICh4KSB7IHJldHVybiB4LmFycmF5RW50cnk7IH0pOwogICAgICAgIHZhciBlZGl0U2NyaXB0ID0ga28udXRpbHMuY29tcGFyZUFycmF5cyhsYXN0QXJyYXksIGFycmF5KTsKCiAgICAgICAgLy8gQnVpbGQgdGhlIG5ldyBtYXBwaW5nIHJlc3VsdAogICAgICAgIHZhciBuZXdNYXBwaW5nUmVzdWx0ID0gW107CiAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwogICAgICAgIHZhciBuZXdNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwoKICAgICAgICB2YXIgbm9kZXNUb0RlbGV0ZSA9IFtdOwogICAgICAgIHZhciBpdGVtc1RvUHJvY2VzcyA9IFtdOwogICAgICAgIHZhciBpdGVtc0ZvckJlZm9yZVJlbW92ZUNhbGxiYWNrcyA9IFtdOwogICAgICAgIHZhciBpdGVtc0Zvck1vdmVDYWxsYmFja3MgPSBbXTsKICAgICAgICB2YXIgaXRlbXNGb3JBZnRlckFkZENhbGxiYWNrcyA9IFtdOwogICAgICAgIHZhciBtYXBEYXRhOwoKICAgICAgICBmdW5jdGlvbiBpdGVtTW92ZWRPclJldGFpbmVkKGVkaXRTY3JpcHRJbmRleCwgb2xkUG9zaXRpb24pIHsKICAgICAgICAgICAgbWFwRGF0YSA9IGxhc3RNYXBwaW5nUmVzdWx0W29sZFBvc2l0aW9uXTsKICAgICAgICAgICAgaWYgKG5ld01hcHBpbmdSZXN1bHRJbmRleCAhPT0gb2xkUG9zaXRpb24pCiAgICAgICAgICAgICAgICBpdGVtc0Zvck1vdmVDYWxsYmFja3NbZWRpdFNjcmlwdEluZGV4XSA9IG1hcERhdGE7CiAgICAgICAgICAgIC8vIFNpbmNlIHVwZGF0aW5nIHRoZSBpbmRleCBtaWdodCBjaGFuZ2UgdGhlIG5vZGVzLCBkbyBzbyBiZWZvcmUgY2FsbGluZyBmaXhVcE5vZGVzVG9CZU1vdmVkT3JSZW1vdmVkCiAgICAgICAgICAgIG1hcERhdGEuaW5kZXhPYnNlcnZhYmxlKG5ld01hcHBpbmdSZXN1bHRJbmRleCsrKTsKICAgICAgICAgICAgZml4VXBOb2Rlc1RvQmVNb3ZlZE9yUmVtb3ZlZChtYXBEYXRhLm1hcHBlZE5vZGVzKTsKICAgICAgICAgICAgbmV3TWFwcGluZ1Jlc3VsdC5wdXNoKG1hcERhdGEpOwogICAgICAgICAgICBpdGVtc1RvUHJvY2Vzcy5wdXNoKG1hcERhdGEpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrKGNhbGxiYWNrLCBpdGVtcykgewogICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBuID0gaXRlbXMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1zW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChpdGVtc1tpXS5tYXBwZWROb2RlcywgZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobm9kZSwgaSwgaXRlbXNbaV0uYXJyYXlFbnRyeSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGVkaXRTY3JpcHRJdGVtLCBtb3ZlZEluZGV4OyBlZGl0U2NyaXB0SXRlbSA9IGVkaXRTY3JpcHRbaV07IGkrKykgewogICAgICAgICAgICBtb3ZlZEluZGV4ID0gZWRpdFNjcmlwdEl0ZW1bJ21vdmVkJ107CiAgICAgICAgICAgIHN3aXRjaCAoZWRpdFNjcmlwdEl0ZW1bJ3N0YXR1cyddKSB7CiAgICAgICAgICAgICAgICBjYXNlICJkZWxldGVkIjoKICAgICAgICAgICAgICAgICAgICBpZiAobW92ZWRJbmRleCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEgPSBsYXN0TWFwcGluZ1Jlc3VsdFtsYXN0TWFwcGluZ1Jlc3VsdEluZGV4XTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgdHJhY2tpbmcgY2hhbmdlcyB0byB0aGUgbWFwcGluZyBmb3IgdGhlc2Ugbm9kZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hcERhdGEuZGVwZW5kZW50T2JzZXJ2YWJsZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEuZGVwZW5kZW50T2JzZXJ2YWJsZS5kaXNwb3NlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBRdWV1ZSB0aGVzZSBub2RlcyBmb3IgbGF0ZXIgcmVtb3ZhbAogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvRGVsZXRlLnB1c2guYXBwbHkobm9kZXNUb0RlbGV0ZSwgZml4VXBOb2Rlc1RvQmVNb3ZlZE9yUmVtb3ZlZChtYXBEYXRhLm1hcHBlZE5vZGVzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zWydiZWZvcmVSZW1vdmUnXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNGb3JCZWZvcmVSZW1vdmVDYWxsYmFja3NbaV0gPSBtYXBEYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNUb1Byb2Nlc3MucHVzaChtYXBEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBsYXN0TWFwcGluZ1Jlc3VsdEluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAicmV0YWluZWQiOgogICAgICAgICAgICAgICAgICAgIGl0ZW1Nb3ZlZE9yUmV0YWluZWQoaSwgbGFzdE1hcHBpbmdSZXN1bHRJbmRleCsrKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlICJhZGRlZCI6CiAgICAgICAgICAgICAgICAgICAgaWYgKG1vdmVkSW5kZXggIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpdGVtTW92ZWRPclJldGFpbmVkKGksIG1vdmVkSW5kZXgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEgPSB7IGFycmF5RW50cnk6IGVkaXRTY3JpcHRJdGVtWyd2YWx1ZSddLCBpbmRleE9ic2VydmFibGU6IGtvLm9ic2VydmFibGUobmV3TWFwcGluZ1Jlc3VsdEluZGV4KyspIH07CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld01hcHBpbmdSZXN1bHQucHVzaChtYXBEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNUb1Byb2Nlc3MucHVzaChtYXBEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0ZpcnN0RXhlY3V0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNGb3JBZnRlckFkZENhbGxiYWNrc1tpXSA9IG1hcERhdGE7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxsIGJlZm9yZU1vdmUgZmlyc3QgYmVmb3JlIGFueSBjaGFuZ2VzIGhhdmUgYmVlbiBtYWRlIHRvIHRoZSBET00KICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYmVmb3JlTW92ZSddLCBpdGVtc0Zvck1vdmVDYWxsYmFja3MpOwoKICAgICAgICAvLyBOZXh0IHJlbW92ZSBub2RlcyBmb3IgZGVsZXRlZCBpdGVtcyAob3IganVzdCBjbGVhbiBpZiB0aGVyZSdzIGEgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrKQogICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChub2Rlc1RvRGVsZXRlLCBvcHRpb25zWydiZWZvcmVSZW1vdmUnXSA/IGtvLmNsZWFuTm9kZSA6IGtvLnJlbW92ZU5vZGUpOwoKICAgICAgICAvLyBOZXh0IGFkZC9yZW9yZGVyIHRoZSByZW1haW5pbmcgaXRlbXMgKHdpbGwgaW5jbHVkZSBkZWxldGVkIGl0ZW1zIGlmIHRoZXJlJ3MgYSBiZWZvcmVSZW1vdmUgY2FsbGJhY2spCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5leHROb2RlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZG9tTm9kZSksIGxhc3ROb2RlLCBub2RlOyBtYXBEYXRhID0gaXRlbXNUb1Byb2Nlc3NbaV07IGkrKykgewogICAgICAgICAgICAvLyBHZXQgbm9kZXMgZm9yIG5ld2x5IGFkZGVkIGl0ZW1zCiAgICAgICAgICAgIGlmICghbWFwRGF0YS5tYXBwZWROb2RlcykKICAgICAgICAgICAgICAgIGtvLnV0aWxzLmV4dGVuZChtYXBEYXRhLCBtYXBOb2RlQW5kUmVmcmVzaFdoZW5DaGFuZ2VkKGRvbU5vZGUsIG1hcHBpbmcsIG1hcERhdGEuYXJyYXlFbnRyeSwgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzLCBtYXBEYXRhLmluZGV4T2JzZXJ2YWJsZSkpOwoKICAgICAgICAgICAgLy8gUHV0IG5vZGVzIGluIHRoZSByaWdodCBwbGFjZSBpZiB0aGV5IGFyZW4ndCB0aGVyZSBhbHJlYWR5CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBub2RlID0gbWFwRGF0YS5tYXBwZWROb2Rlc1tqXTsgbmV4dE5vZGUgPSBub2RlLm5leHRTaWJsaW5nLCBsYXN0Tm9kZSA9IG5vZGUsIGorKykgewogICAgICAgICAgICAgICAgaWYgKG5vZGUgIT09IG5leHROb2RlKQogICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcihkb21Ob2RlLCBub2RlLCBsYXN0Tm9kZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJ1biB0aGUgY2FsbGJhY2tzIGZvciBuZXdseSBhZGRlZCBub2RlcyAoZm9yIGV4YW1wbGUsIHRvIGFwcGx5IGJpbmRpbmdzLCBldGMuKQogICAgICAgICAgICBpZiAoIW1hcERhdGEuaW5pdGlhbGl6ZWQgJiYgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMobWFwRGF0YS5hcnJheUVudHJ5LCBtYXBEYXRhLm1hcHBlZE5vZGVzLCBtYXBEYXRhLmluZGV4T2JzZXJ2YWJsZSk7CiAgICAgICAgICAgICAgICBtYXBEYXRhLmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gSWYgdGhlcmUncyBhIGJlZm9yZVJlbW92ZSBjYWxsYmFjaywgY2FsbCBpdCBhZnRlciByZW9yZGVyaW5nLgogICAgICAgIC8vIE5vdGUgdGhhdCB3ZSBhc3N1bWUgdGhhdCB0aGUgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrIHdpbGwgdXN1YWxseSBiZSB1c2VkIHRvIHJlbW92ZSB0aGUgbm9kZXMgdXNpbmcKICAgICAgICAvLyBzb21lIHNvcnQgb2YgYW5pbWF0aW9uLCB3aGljaCBpcyB3aHkgd2UgZmlyc3QgcmVvcmRlciB0aGUgbm9kZXMgdGhhdCB3aWxsIGJlIHJlbW92ZWQuIElmIHRoZQogICAgICAgIC8vIGNhbGxiYWNrIGluc3RlYWQgcmVtb3ZlcyB0aGUgbm9kZXMgcmlnaHQgYXdheSwgaXQgd291bGQgYmUgbW9yZSBlZmZpY2llbnQgdG8gc2tpcCByZW9yZGVyaW5nIHRoZW0uCiAgICAgICAgLy8gUGVyaGFwcyB3ZSdsbCBtYWtlIHRoYXQgY2hhbmdlIGluIHRoZSBmdXR1cmUgaWYgdGhpcyBzY2VuYXJpbyBiZWNvbWVzIG1vcmUgY29tbW9uLgogICAgICAgIGNhbGxDYWxsYmFjayhvcHRpb25zWydiZWZvcmVSZW1vdmUnXSwgaXRlbXNGb3JCZWZvcmVSZW1vdmVDYWxsYmFja3MpOwoKICAgICAgICAvLyBGaW5hbGx5IGNhbGwgYWZ0ZXJNb3ZlIGFuZCBhZnRlckFkZCBjYWxsYmFja3MKICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYWZ0ZXJNb3ZlJ10sIGl0ZW1zRm9yTW92ZUNhbGxiYWNrcyk7CiAgICAgICAgY2FsbENhbGxiYWNrKG9wdGlvbnNbJ2FmdGVyQWRkJ10sIGl0ZW1zRm9yQWZ0ZXJBZGRDYWxsYmFja3MpOwoKICAgICAgICAvLyBTdG9yZSBhIGNvcHkgb2YgdGhlIGFycmF5IGl0ZW1zIHdlIGp1c3QgY29uc2lkZXJlZCBzbyB3ZSBjYW4gZGlmZmVyZW5jZSBpdCBuZXh0IHRpbWUKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXksIG5ld01hcHBpbmdSZXN1bHQpOwogICAgfQp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nJywga28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyk7CmtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewogICAgdGhpc1snYWxsb3dUZW1wbGF0ZVJld3JpdGluZyddID0gZmFsc2U7Cn0KCmtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IG5ldyBrby50ZW1wbGF0ZUVuZ2luZSgpOwprby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICB2YXIgdXNlTm9kZXNJZkF2YWlsYWJsZSA9ICEoa28udXRpbHMuaWVWZXJzaW9uIDwgOSksIC8vIElFPDkgY2xvbmVOb2RlIGRvZXNuJ3Qgd29yayBwcm9wZXJseQogICAgICAgIHRlbXBsYXRlTm9kZXNGdW5jID0gdXNlTm9kZXNJZkF2YWlsYWJsZSA/IHRlbXBsYXRlU291cmNlWydub2RlcyddIDogbnVsbCwKICAgICAgICB0ZW1wbGF0ZU5vZGVzID0gdGVtcGxhdGVOb2Rlc0Z1bmMgPyB0ZW1wbGF0ZVNvdXJjZVsnbm9kZXMnXSgpIDogbnVsbDsKCiAgICBpZiAodGVtcGxhdGVOb2RlcykgewogICAgICAgIHJldHVybiBrby51dGlscy5tYWtlQXJyYXkodGVtcGxhdGVOb2Rlcy5jbG9uZU5vZGUodHJ1ZSkuY2hpbGROb2Rlcyk7CiAgICB9IGVsc2UgewogICAgICAgIHZhciB0ZW1wbGF0ZVRleHQgPSB0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KHRlbXBsYXRlVGV4dCk7CiAgICB9Cn07Cgprby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSA9IG5ldyBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSgpOwprby5zZXRUZW1wbGF0ZUVuZ2luZShrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSk7Cgprby5leHBvcnRTeW1ib2woJ25hdGl2ZVRlbXBsYXRlRW5naW5lJywga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUpOwooZnVuY3Rpb24oKSB7CiAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gRGV0ZWN0IHdoaWNoIHZlcnNpb24gb2YganF1ZXJ5LXRtcGwgeW91J3JlIHVzaW5nLiBVbmZvcnR1bmF0ZWx5IGpxdWVyeS10bXBsCiAgICAgICAgLy8gZG9lc24ndCBleHBvc2UgYSB2ZXJzaW9uIG51bWJlciwgc28gd2UgaGF2ZSB0byBpbmZlciBpdC4KICAgICAgICAvLyBOb3RlIHRoYXQgYXMgb2YgS25vY2tvdXQgMS4zLCB3ZSBvbmx5IHN1cHBvcnQgalF1ZXJ5LnRtcGwgMS4wLjBwcmUgYW5kIGxhdGVyLAogICAgICAgIC8vIHdoaWNoIEtPIGludGVybmFsbHkgcmVmZXJzIHRvIGFzIHZlcnNpb24gIjIiLCBzbyBvbGRlciB2ZXJzaW9ucyBhcmUgbm8gbG9uZ2VyIGRldGVjdGVkLgogICAgICAgIHZhciBqUXVlcnlUbXBsVmVyc2lvbiA9IHRoaXMualF1ZXJ5VG1wbFZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICgodHlwZW9mKGpRdWVyeSkgPT0gInVuZGVmaW5lZCIpIHx8ICEoalF1ZXJ5Wyd0bXBsJ10pKQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIC8vIFNpbmNlIGl0IGV4cG9zZXMgbm8gb2ZmaWNpYWwgdmVyc2lvbiBudW1iZXIsIHdlIHVzZSBvdXIgb3duIG51bWJlcmluZyBzeXN0ZW0uIFRvIGJlIHVwZGF0ZWQgYXMganF1ZXJ5LXRtcGwgZXZvbHZlcy4KICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChqUXVlcnlbJ3RtcGwnXVsndGFnJ11bJ3RtcGwnXVsnb3BlbiddLnRvU3RyaW5nKCkuaW5kZXhPZignX18nKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU2luY2UgMS4wLjBwcmUsIGN1c3RvbSB0YWdzIHNob3VsZCBhcHBlbmQgbWFya3VwIHRvIGFuIGFycmF5IGNhbGxlZCAiX18iCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDI7IC8vIEZpbmFsIHZlcnNpb24gb2YganF1ZXJ5LnRtcGwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaChleCkgeyAvKiBBcHBhcmVudGx5IG5vdCB0aGUgdmVyc2lvbiB3ZSB3ZXJlIGxvb2tpbmcgZm9yICovIH0KCiAgICAgICAgICAgIHJldHVybiAxOyAvLyBBbnkgb2xkZXIgdmVyc2lvbiB0aGF0IHdlIGRvbid0IHN1cHBvcnQKICAgICAgICB9KSgpOwoKICAgICAgICBmdW5jdGlvbiBlbnN1cmVIYXNSZWZlcmVuY2VkSlF1ZXJ5VGVtcGxhdGVzKCkgewogICAgICAgICAgICBpZiAoalF1ZXJ5VG1wbFZlcnNpb24gPCAyKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3VyIHZlcnNpb24gb2YgalF1ZXJ5LnRtcGwgaXMgdG9vIG9sZC4gUGxlYXNlIHVwZ3JhZGUgdG8galF1ZXJ5LnRtcGwgMS4wLjBwcmUgb3IgbGF0ZXIuIik7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBleGVjdXRlVGVtcGxhdGUoY29tcGlsZWRUZW1wbGF0ZSwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnlbJ3RtcGwnXShjb21waWxlZFRlbXBsYXRlLCBkYXRhLCBqUXVlcnlUZW1wbGF0ZU9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgdGhpc1sncmVuZGVyVGVtcGxhdGVTb3VyY2UnXSA9IGZ1bmN0aW9uKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgZW5zdXJlSGFzUmVmZXJlbmNlZEpRdWVyeVRlbXBsYXRlcygpOwoKICAgICAgICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgc3RvcmVkIGEgcHJlY29tcGlsZWQgdmVyc2lvbiBvZiB0aGlzIHRlbXBsYXRlIChkb24ndCB3YW50IHRvIHJlcGFyc2Ugb24gZXZlcnkgcmVuZGVyKQogICAgICAgICAgICB2YXIgcHJlY29tcGlsZWQgPSB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcpOwogICAgICAgICAgICBpZiAoIXByZWNvbXBpbGVkKSB7CiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVUZXh0ID0gdGVtcGxhdGVTb3VyY2VbJ3RleHQnXSgpIHx8ICIiOwogICAgICAgICAgICAgICAgLy8gV3JhcCBpbiAid2l0aCgkd2hhdGV2ZXIua29CaW5kaW5nQ29udGV4dCkgeyAuLi4gfSIKICAgICAgICAgICAgICAgIHRlbXBsYXRlVGV4dCA9ICJ7e2tvX3dpdGggJGl0ZW0ua29CaW5kaW5nQ29udGV4dH19IiArIHRlbXBsYXRlVGV4dCArICJ7ey9rb193aXRofX0iOwoKICAgICAgICAgICAgICAgIHByZWNvbXBpbGVkID0galF1ZXJ5Wyd0ZW1wbGF0ZSddKG51bGwsIHRlbXBsYXRlVGV4dCk7CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcsIHByZWNvbXBpbGVkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGRhdGEgPSBbYmluZGluZ0NvbnRleHRbJyRkYXRhJ11dOyAvLyBQcmV3cmFwIHRoZSBkYXRhIGluIGFuIGFycmF5IHRvIHN0b3AganF1ZXJ5LnRtcGwgZnJvbSB0cnlpbmcgdG8gdW53cmFwIGFueSBhcnJheXMKICAgICAgICAgICAgdmFyIGpRdWVyeVRlbXBsYXRlT3B0aW9ucyA9IGpRdWVyeVsnZXh0ZW5kJ10oeyAna29CaW5kaW5nQ29udGV4dCc6IGJpbmRpbmdDb250ZXh0IH0sIG9wdGlvbnNbJ3RlbXBsYXRlT3B0aW9ucyddKTsKCiAgICAgICAgICAgIHZhciByZXN1bHROb2RlcyA9IGV4ZWN1dGVUZW1wbGF0ZShwcmVjb21waWxlZCwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKTsKICAgICAgICAgICAgcmVzdWx0Tm9kZXNbJ2FwcGVuZFRvJ10oZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikpOyAvLyBVc2luZyAiYXBwZW5kVG8iIGZvcmNlcyBqUXVlcnkvalF1ZXJ5LnRtcGwgdG8gcGVyZm9ybSBuZWNlc3NhcnkgY2xlYW51cCB3b3JrCgogICAgICAgICAgICBqUXVlcnlbJ2ZyYWdtZW50cyddID0ge307IC8vIENsZWFyIGpRdWVyeSdzIGZyYWdtZW50IGNhY2hlIHRvIGF2b2lkIGEgbWVtb3J5IGxlYWsgYWZ0ZXIgYSBsYXJnZSBudW1iZXIgb2YgdGVtcGxhdGUgcmVuZGVycwogICAgICAgICAgICByZXR1cm4gcmVzdWx0Tm9kZXM7CiAgICAgICAgfTsKCiAgICAgICAgdGhpc1snY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10gPSBmdW5jdGlvbihzY3JpcHQpIHsKICAgICAgICAgICAgcmV0dXJuICJ7e2tvX2NvZGUgKChmdW5jdGlvbigpIHsgcmV0dXJuICIgKyBzY3JpcHQgKyAiIH0pKCkpIH19IjsKICAgICAgICB9OwoKICAgICAgICB0aGlzWydhZGRUZW1wbGF0ZSddID0gZnVuY3Rpb24odGVtcGxhdGVOYW1lLCB0ZW1wbGF0ZU1hcmt1cCkgewogICAgICAgICAgICBkb2N1bWVudC53cml0ZSgiPHNjcmlwdCB0eXBlPSd0ZXh0L2h0bWwnIGlkPSciICsgdGVtcGxhdGVOYW1lICsgIic+IiArIHRlbXBsYXRlTWFya3VwICsgIjwvc2NyaXB0PiIpOwogICAgICAgIH07CgogICAgICAgIGlmIChqUXVlcnlUbXBsVmVyc2lvbiA+IDApIHsKICAgICAgICAgICAgalF1ZXJ5Wyd0bXBsJ11bJ3RhZyddWydrb19jb2RlJ10gPSB7CiAgICAgICAgICAgICAgICBvcGVuOiAiX18ucHVzaCgkMSB8fCAnJyk7IgogICAgICAgICAgICB9OwogICAgICAgICAgICBqUXVlcnlbJ3RtcGwnXVsndGFnJ11bJ2tvX3dpdGgnXSA9IHsKICAgICAgICAgICAgICAgIG9wZW46ICJ3aXRoKCQxKSB7IiwKICAgICAgICAgICAgICAgIGNsb3NlOiAifSAiCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfTsKCiAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlID0gbmV3IGtvLnRlbXBsYXRlRW5naW5lKCk7CgogICAgLy8gVXNlIHRoaXMgb25lIGJ5IGRlZmF1bHQgKm9ubHkgaWYganF1ZXJ5LnRtcGwgaXMgcmVmZXJlbmNlZCoKICAgIHZhciBqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZSA9IG5ldyBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUoKTsKICAgIGlmIChqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZS5qUXVlcnlUbXBsVmVyc2lvbiA+IDApCiAgICAgICAga28uc2V0VGVtcGxhdGVFbmdpbmUoanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lSW5zdGFuY2UpOwoKICAgIGtvLmV4cG9ydFN5bWJvbCgnanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lJywga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lKTsKfSkoKTsKfSk7Cn0pKHdpbmRvdyxkb2N1bWVudCxuYXZpZ2F0b3Isd2luZG93WyJqUXVlcnkiXSk7Cn0pKCk7CgpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZS9jb252ZW50aW9uL2tub2Nrb3V0LmVuZ2luZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAna25vY2tvdXQnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2tvX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIga28gPSBfX2tvX187CgogICAgdmFyIHdoZW4gPSB1dGlsLndoZW4sIGVhY2ggPSBfLmVhY2gsIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksIGZpbmQgPSBfLmZpbmQsIGtub2Nrb3V0VGVtcGxhdGVzID0gewogICAgfTsKICAgIHZhciBpbml0S25vY2tvdXRJbnRlZ3JhdGlvbiA9IGZ1bmN0aW9uICh0ZW1wbGF0ZU1hbmFnZXIpIHsKICAgICAgICB2YXIgVGhydXN0VGVtcGxhdGVTb3VyY2UgPSAoa28pLnRlbXBsYXRlU291cmNlcy50aHJ1c3RUZW1wbGF0ZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSkgewogICAgICAgICAgICB0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3RUZW1wbGF0ZVNvdXJjZS5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgIHRleHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC50ZW1wbGF0ZS5odG1sOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRlbXBsYXRlLmh0bWwgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoJ1RocnVzdCBUZW1wbGF0ZSBkb2VzIG5vdCBzdXBwb3J0IHJld3JpdGluZy4uLicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LnRlbXBsYXRlLmRhdGEpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRlbXBsYXRlLmRhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC50ZW1wbGF0ZS5kYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoYXQudGVtcGxhdGUuZGF0YVtrZXldID0gYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICAvLyBCZWdpbiBpbnRlZ3JhdGlvbiBvZiB0ZW1wbGF0ZSBwbHVnaW4sIHdpdGggS25vY2tvdXQuCiAgICAgICAgdmFyIG9sZEVuZ2luZSA9IChrbykubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2U7CiAgICAgICAgdmFyIGNvbnZlbnRpb25UZW1wbGF0ZUVuZ2luZSA9IChrbykuY29udmVudGlvblRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewogICAgICAgIH07CiAgICAgICAgY29udmVudGlvblRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IGtvLnV0aWxzLmV4dGVuZChuZXcgKGtvKS50ZW1wbGF0ZUVuZ2luZSgpLCB7CiAgICAgICAgICAgIHJlbmRlclRlbXBsYXRlU291cmNlOiBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBpZih0ZW1wbGF0ZVNvdXJjZS50ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBldmFsdWF0b3JzID0gdGhpcy5ldmFsdWF0b3JzOwogICAgICAgICAgICAgICAgICAgIGlmKCFldmFsdWF0b3JzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZhbHVhdG9ycyA9IGV2YWx1YXRvcnMgPSB0ZW1wbGF0ZU1hbmFnZXIuY29uZmlnLmV2YWx1YXRvcnNbdGVtcGxhdGVNYW5hZ2VyLmNvbmZpZy5kZWZhdWx0VHlwZV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBwcmVjb21waWxlZCA9IHRlbXBsYXRlU291cmNlWydkYXRhJ10oJ3ByZWNvbXBpbGVkJyk7CiAgICAgICAgICAgICAgICAgICAgaWYoIXByZWNvbXBpbGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZWNvbXBpbGVkID0gdGVtcGxhdGVNYW5hZ2VyLmNvbXBpbGUoJ3t7IHdpdGgoJGRhdGEpIHsgfX0gJyArIHRlbXBsYXRlU291cmNlLnRleHQoKSArICIge3sgfSB9fSIpOwogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcsIHByZWNvbXBpbGVkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gUnVuIHRoZSB0ZW1wbGF0ZSBhbmQgcGFyc2UgaXRzIG91dHB1dCBpbnRvIGFuIGFycmF5IG9mIERPTSBlbGVtZW50cwogICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJlZE1hcmt1cCA9IHRlbXBsYXRlU291cmNlLnRlbXBsYXRlLmNvbXBpbGVkKGJpbmRpbmdDb250ZXh0KS5yZXBsYWNlKC9ccysvZywgIiAiKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGtvKS51dGlscy5wYXJzZUh0bWxGcmFnbWVudChyZW5kZXJlZE1hcmt1cCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gb2xkRW5naW5lLnJlbmRlclRlbXBsYXRlU291cmNlLmFwcGx5KG9sZEVuZ2luZSwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrOiBmdW5jdGlvbiAoc2NyaXB0KSB7CiAgICAgICAgICAgICAgICBpZighdGhpcy5ldmFsdWF0b3JDYWNoZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBldmFsdWF0b3JzID0gdGVtcGxhdGVNYW5hZ2VyLmNvbmZpZy5ldmFsdWF0b3JzW3RlbXBsYXRlTWFuYWdlci5jb25maWcuZGVmYXVsdFR5cGVdOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXZhbHVhdG9yQ2FjaGUgPSBldmFsdWF0b3JzLmxlZnQgKyBzY3JpcHQgKyBldmFsdWF0b3JzLnJpZ2h0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdG9yQ2FjaGU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1ha2VUZW1wbGF0ZVNvdXJjZTogZnVuY3Rpb24gKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KSB7CiAgICAgICAgICAgICAgICAvLyBOYW1lZCB0ZW1wbGF0ZQogICAgICAgICAgICAgICAgaWYodHlwZW9mIHRlbXBsYXRlID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRlZmluaXRpb24gPSB0ZW1wbGF0ZU1hbmFnZXIuZ2V0KHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICBpZihkZWZpbml0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGhydXN0VGVtcGxhdGVTb3VyY2UoZGVmaW5pdGlvbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9sZEVuZ2luZS5tYWtlVGVtcGxhdGVTb3VyY2UuYXBwbHkob2xkRW5naW5lLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgKGtvKS5zZXRUZW1wbGF0ZUVuZ2luZShuZXcgKGtvKS5jb252ZW50aW9uVGVtcGxhdGVFbmdpbmUoKSk7CiAgICB9OwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgY291bnRkb3duOiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIGluaXRLbm9ja291dEludGVncmF0aW9uKHRocnVzdC50ZW1wbGF0ZSk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMua25vY2tvdXRFbmdpbmUgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9a25vY2tvdXQuZW5naW5lLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3RlbXBsYXRlL2NvbnZlbnRpb24vdGVtcGxhdGUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90ZW1wbGF0ZS90ZW1wbGF0ZS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBURU1QTEFURVMgPSAndGVtcGxhdGVzJywgd2hlbiA9IHV0aWwud2hlbiwgZWFjaCA9IF8uZWFjaCwgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwgZmluZCA9IF8uZmluZDsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgVEVNUExBVEVTCiAgICAgICAgXSwKICAgICAgICBpbml0OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICB2YXIgdGVtcGxhdGVzID0gbW9kLmNvbnZlbnRpb24oVEVNUExBVEVTKSwgaW52ZXJ0ZWRUZW1wbGF0ZXMgPSB1dGlsLmludmVydCh0ZW1wbGF0ZXMpLCBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgaWYodGVtcGxhdGVzKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVmZXJzID0gW107CiAgICAgICAgICAgICAgICBlYWNoKHRlbXBsYXRlcywgZnVuY3Rpb24gKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIHRlbXBsYXRlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnMucHVzaChmYWNhZGUuZmV0Y2godGVtcGxhdGUpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZhY2FkZS5sb2FkaW5nUHJvbWlzZSA9IHdoZW4uYWxsKGRlZmVycykudGhlbihmdW5jdGlvbiAobG9hZGVkVGVtcGxhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgLypqc2hpbnQgbG9vcGZ1bmM6dHJ1ZSAqLwogICAgICAgICAgICAgICAgICAgIF8uZWFjaChpbnZlcnRlZFRlbXBsYXRlcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gXy5maW5kKGxvYWRlZFRlbXBsYXRlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB4LnNob3J0TmFtZSA9PT0gaSB8fCB4Lm5hbWUgPT09IGk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGVJbnN0YW5jZS50ZW1wbGF0ZXNbaV0gPSB0ZW1wbGF0ZS5jb21waWxlZDsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWNhZGUubG9hZGluZ1Byb21pc2UgfHwgdW5kZWZpbmVkOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnRlbXBsYXRlID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXRlbXBsYXRlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3NwYS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFByb3ZpZGVzIHRocnVzdCBjb25maWd1cmF0aW9uCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LnNwYQogICAgQHN1Ym1vZHVsZSB0aHJ1c3Quc3BhLmNvbmZpZwogICAgKiovCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0LnNwYS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnY2ZnJywgCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnbWVkaWF0b3InCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvbWVkaWF0b3IuCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9zcGEvY29udmVudGlvbi9zdGFydCcsIAogICAgICAgICd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3BhbGluaycKICAgIF07CiAgICAvKioKICAgIERlZmluZXMgdGhlIHZhbHVlIG9mIGN1c3RvbSBwYXJhbWV0ZXJzLgogICAgWW91IGNhbiBhbHNvIGRlZmluZSBjdXN0b20gcGFyYW1ldGVycyB0byBiZSBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgYW5kIHRoZW4gdXNlIHRoZW0gaW4geW91ciByb3V0ZXMKICAgIAogICAgQHByb3BlcnR5IHBhcmFtcwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7T2JqZWN0fQogICAgKiovCiAgICBleHBvcnRzLnBhcmFtcyA9IHsKICAgIH07CiAgICAvKioKICAgIFRoZSBwcmVkZmluZWQgcm91dGVzIHRvIGJlIHVzZWQgYnkgc3BhLgogICAgCiAgICBAcHJvcGVydHkgcm91dGVzCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtPYmplY3R9CiAgICAqKi8KICAgIGV4cG9ydHMucm91dGVzID0gewogICAgfTsKICAgIC8qKgogICAgVGhlIGZpbGUgZXhzdGVuaW9uIHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQgd2hlbiByZXNvbHZpbmcgcm91dGVzIGFuZCBzdGFydGluZyBtb2R1bGVzLgogICAgCiAgICBAcHJvcGVydHkgZmlsZUV4dGVuc2lvbgogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgKiovCiAgICBleHBvcnRzLmZpbGVFeHRlbnNpb24gPSAnLmh0bWwnOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3BhbGluaycsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2RvbS9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvc3BhL3NwYS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBzdWJqcXVlcnkgPSBfX3N1YmpxdWVyeV9fOwoKICAgIHZhciAkID0gc3VianF1ZXJ5LnRRdWVyeTsKICAgIHZhciBwYXJzZUZ1bGxIcmVmID0gZnVuY3Rpb24gKGhyZWYpIHsKICAgICAgICB2YXIgYmFzZVVybCA9IGxvY2F0aW9uLnBhdGhuYW1lLnN1YnN0cmluZygwLCBsb2NhdGlvbi5wYXRobmFtZS5sYXN0SW5kZXhPZignLycpKTsKICAgICAgICBpZihocmVmLmluZGV4T2YoJy8nKSAhPSAtMSkgewogICAgICAgICAgICBocmVmID0gaHJlZi5zdWJzdHJpbmcoaHJlZi5sYXN0SW5kZXhPZignLycpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBocmVmID0gJy8nICsgaHJlZjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJhc2VVcmwgKyBocmVmOwogICAgfTsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QuZG9tCiAgICBAc3VibW9kdWxlIHRocnVzdC5kb20uY29udmVudGlvbgogICAgKiovCiAgICAvKioKICAgICogIyBfX3RocnVzdC9kb21fXyBDb252ZW50aW9uIC0gU2luZ2xlIFBhZ2UgQXBwIExpbmsKICAgICoKICAgICogUmVxdWlyZXMgdGhydXN0L2RvbQogICAgKgogICAgKiBAZm9yIHRocnVzdC5kb20uY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgc3BhO2luawogICAgKiovCiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBvcmJpdDogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgY29uZmlnID0gdGhydXN0LmNvbmZpZywgc3BhID0gdGhydXN0LnNwYTsKICAgICAgICAgICAgJC5vbignY2xpY2snLCAnYScsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICB2YXIgbGluayA9IHBhcnNlRnVsbEhyZWYodGhpcy5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSk7CiAgICAgICAgICAgICAgICBpZihsaW5rLmluZGV4T2YoY29uZmlnLnVybC5wYXRoKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHNwYS5uYXZpZ2F0ZShsaW5rKTsKICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnNwYWxpbmsgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9c3BhbGluay5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9zcGEvY29udmVudGlvbi9zdGFydCcsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3NwYS9zcGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnNwYQogICAgQHN1Ym1vZHVsZSB0aHJ1c3Quc3BhLmNvbnZlbnRpb24KICAgICoqLwogICAgLyoqCiAgICAqICMgX190aHJ1c3Qvc3BhX18gQ29udmVudGlvbiAtIFN0YXJ0CiAgICAqCiAgICAqIFRoZSBzaW5nbGUgcGFnZSBhcHAgc3RhcnQgY29udmVudGlvbiwgZG9lcyB0aGUgYWN0dWFsIHN0YXJ0aW5nIG9mIHRoZSBwbHVnaW4sIGluIGFkZGl0aW9uIGl0IGFsc28gZGVsYXlzCiAgICAqIGZ1bGwgb3JiaXQsIHVudGlsIGFueSBtb2R1bGUgaXQgaGFzIHN0YXJ0ZWQgaGFzIGJlZW4gbG9hZGVkLgogICAgKgogICAgKiBAZm9yIHRocnVzdC5zcGEuY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgc3RhcnQKICAgICoqLwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdmFyIHJvdXRlciA9IHRocnVzdC5zcGE7CiAgICAgICAgICAgIHJvdXRlci5zdGFydCgpOwogICAgICAgICAgICByZXR1cm4gdGhydXN0LnNwYS5zdGFydGluZ01vZHVsZVByb21pc2UgfHwgbnVsbDsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5zdGFydCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdGFydC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9tZWRpYXRvci9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ3RocnVzdC9ldmVudHMnLCAndGhydXN0L2ZhY2FkZScsICdoYXMnLCAndGhydXN0L2NvbmZpZycsICcuL2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19sb2dfXywgX19ldmVudHNfXywgX19mYWNhZGVfXywgX19oYXNfXywgX19jb25maWdfXywgX19tZWRpYXRvckNvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9oYXMuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgLy9pbXBvcnQgZXZlbnRzID0gbW9kdWxlKCd0aHJ1c3QvZXZlbnRzJyk7CiAgICB2YXIgZXZlbnRzID0gX19ldmVudHNfXzsKCiAgICB2YXIgRXZlbnRzID0gZXZlbnRzLkV2ZW50czsKICAgIHZhciBmYWNhZGUgPSBfX2ZhY2FkZV9fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIHZhciBtZWRpYXRvckNvbmZpZyA9IF9fbWVkaWF0b3JDb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdNZWRpYXRvcic7CiAgICAvLyBWYXJpYWJsZSBkZWNsYXJhdGlvbi4KICAgICAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGV4dGVuZCA9IC8vIHN0cmluZyBmb3JtYXQgbWV0aG9kCiAgICBfLmV4dGVuZCwgd2hlbiA9IC8vIG9iamVjdCBleHRlbnNpb24gbWV0aG9kCiAgICB1dGlsLndoZW4sIG1lbW9pemUgPSBfLm1lbW9pemUsIG1lZGlhdG9yLCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIHZhciBjID0gY29uZmlnOwogICAgLy8jcmVnaW9uIEZhY2FkZQogICAgLyoqCiAgICBDcmVhdGVzIGEgbmV3IG1lZGlhdG9yIGZhY2FkZSBmb3IgdGhlIGdpdmVuIG1vZHVsZS4KICAgIAogICAgQGZvciB0aHJ1c3QubWVkaWF0b3IKICAgIEBjbGFzcyB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3JGYWNhZGUKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgIEBwYXJhbSB7dGhydXN0Lk1lZGlhdG9yfSBwYXJlbnQgVGhlIHBhcmVudCBtZWRpYXRvciB0byBjcmVhdGUgdGhlIGZhY2FkZSBvbi4KICAgICoqLwogICAgdmFyIE1lZGlhdG9yRmFjYWRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbWVkaWF0b3JGYWNhZGUgPSBmYWNhZGUuY3JlYXRlRmFjYWRlKGZ1bmN0aW9uIChtb2R1bGUsIHBhcmVudCkgewogICAgICAgICAgICB0aGlzLm5hbWUgPSBtb2R1bGUubmFtZTsKICAgICAgICAgICAgdGhpcy5tb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gcGFyZW50Ll9jYWxsYmFja3M7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cyhtb2R1bGUpOwogICAgICAgIH0pOwogICAgICAgIF8uZXh0ZW5kKG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZSwgRXZlbnRzKTsKICAgICAgICAvKioKICAgICAgICBEdXJpbmcgdGhlIHN0YXJ0IG9mIGEgbWVkaWF0b3IgZmFjYWRlLCBzdGFydCBjcmVhdGVzIHRoZSBpbnRlcm5hbCBzdWJzY3JpcHRpb25zIGFycmF5LgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yRmFjYWRlCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgaWYoIXRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucykgewogICAgICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuc3RhcnQgPSBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuaW5pdDsKICAgICAgICAvKioKICAgICAgICBPdmVycmlkZXMgdGhlIHN1YnNjcmliZSBtZXRob2QsIGFuZCB0cmFja3MgdGhlIGFueSBldmVudCB0aGF0IGlzIGJvdW5kLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yRmFjYWRlCiAgICAgICAgQG1ldGhvZCBzdWJzY3JpYmUKICAgICAgICAqKi8KICAgICAgICAobWVkaWF0b3JGYWNhZGUpLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICBldmVudHM6IGV2ZW50cywKICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjaywKICAgICAgICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIEV2ZW50cy5zdWJzY3JpYmUuY2FsbCh0aGlzLCBldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICB9OwogICAgICAgIC8qKgogICAgICAgIFVuc3Vic2NyaWJlcyBmcm9tIGFsbCBldmVudHMgdGhhdCB3ZXJlIHN1YnNjcmliZWQgdG8uCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3JGYWNhZGUKICAgICAgICBAbWV0aG9kIHN0b3AKICAgICAgICAqKi8KICAgICAgICBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuc3RvcCA9IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIGlmKHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucykgewogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN1YiA9IHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9uc1tpXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKHN1Yi5ldmVudHMsIHN1Yi5jYWxsYmFjaywgc3ViLmNvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIHJldHVybiBtZWRpYXRvckZhY2FkZTsKICAgIH0pKCk7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vIE91ciBkZWZhdWx0IG5hbWVzcGFjZSBwcmVmaXguCiAgICAvKioKICAgIE1lZGlhdG9yIGNsYXNzLgogICAgVGhpcyBjcmVhdGVzIGEgaW5zdGFuY2Ugb2YgdGhlIG1lZGlhdG9yLCBmb3IgdXNlIGluc2lkZSB0aHJ1c3QuCiAgICAKICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yCiAgICBAY2xhc3MgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBtZWRpYXRvci4KICAgICoqLwogICAgdmFyIE1lZGlhdG9yID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyNlbmRyZWdpb24KICAgICAgICBmdW5jdGlvbiBNZWRpYXRvcihuYW1lLCBjb25maWcpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBhcHBQYXRoID0gY29uZmlnICYmIGNvbmZpZy51cmwgJiYgY29uZmlnLnVybC5wYXRoOwogICAgICAgICAgICB0aGF0Lm5hbWUgPSBuYW1lOwogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdNZWRpYXRvcjogQ3JlYXRpbmcgbmV3IE1lZGlhdG9yIHswfScsIG5hbWUpKTsKICAgICAgICAgICAgdGhhdC5pbml0RXZlbnRzKCk7CiAgICAgICAgICAgIHRoYXQuc3Vic2NyaWJlKCd0aHJ1c3QvcmVhZHknLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBmYWxzZSAmJiBsb2cuaW5mbygnTWVkaWF0b3I6IFJlYWR5IScpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLmluaXRFdmVudHMgPSAvLyNyZWdpb24gRXZlbnRzCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uICh0bywgaW5pdCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCwgb25jZSkgewogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgaWYoZmFjYWRlcy5tZWRpYXRvciAmJiAhKGZhY2FkZXMubWVkaWF0b3IgaW5zdGFuY2VvZiBNZWRpYXRvckZhY2FkZSkpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignIm1lZGlhdG9yIiBpcyBhIHJlc2VydmVkIHByb3BlcnR5Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1lZGlhdG9yOwogICAgICAgICAgICBpZihmYWNhZGVzLm1lZGlhdG9yKSB7CiAgICAgICAgICAgICAgICBmYWNhZGVzLm1lZGlhdG9yLnVwZGF0ZUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICAgICAgbWVkaWF0b3IgPSBmYWNhZGVzLm1lZGlhdG9yOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbWVkaWF0b3IgPSBmYWNhZGVzLm1lZGlhdG9yID0gKG1vZCkubWVkaWF0b3IgPSBuZXcgTWVkaWF0b3JGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWVkaWF0b3I7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5jb25maWcgPSBtZWRpYXRvckNvbmZpZzsKICAgICAgICByZXR1cm4gTWVkaWF0b3I7CiAgICB9KSgpOwogICAgZXhwb3J0cy5NZWRpYXRvciA9IE1lZGlhdG9yOyAgICAKICAgIC8vIEdldCB0aGUgYWN0dWFsIGV2ZW50IG1ldGhvZHMgb250byB0aGUgTWVkaWF0b3IKICAgIF8uZXh0ZW5kKE1lZGlhdG9yLnByb3RvdHlwZSwgRXZlbnRzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9tZWRpYXRvcicsIFsndGhydXN0L21lZGlhdG9yL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3QvZGF0YS9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICdqcXVlcnknLCAndGhydXN0L2xvZycsICcuL2NvbmZpZycsICd0aHJ1c3QvY29uZmlnJywgJy4vZXZlbnQuZmFjdG9yeScsICcuL3Jlc3BvbnNlLnF1ZXVlJywgJ3RocnVzdC9ldmVudHMnLCAndGhydXN0L2ZhY2FkZScsICcuL2V2ZW50LnR5cGVzJywgJ2hhcyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18sIF9falF1ZXJ5X18sIF9fbG9nX18sIF9fY29uZmlnX18sIF9fdENvbmZpZ19fLCBfX2V2ZW50RmFjdG9yeV9fLCBfX3Jlc3BvbnNlUXVldWVfXywgX19ldmVudHNfXywgX19mYWNhZGVfXywgX19ldmVudFR5cGVzX18sIF9faGFzX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvZGF0YS9kYXRhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9qcXVlcnkuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBqUXVlcnkgPSBfX2pRdWVyeV9fOwoKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIHZhciB0Q29uZmlnID0gX190Q29uZmlnX187CgogICAgdmFyIGV2ZW50RmFjdG9yeSA9IF9fZXZlbnRGYWN0b3J5X187CgogICAgdmFyIHJlc3BvbnNlUXVldWUgPSBfX3Jlc3BvbnNlUXVldWVfXzsKCiAgICB2YXIgUmVzcG9uc2VRdWV1ZSA9IHJlc3BvbnNlUXVldWUuUmVzcG9uc2VRdWV1ZTsKICAgIHZhciBldmVudHMgPSBfX2V2ZW50c19fOwoKICAgIHZhciBFdmVudHMgPSBldmVudHMuRXZlbnRzOwogICAgdmFyIGZhY2FkZSA9IF9fZmFjYWRlX187CgogICAgdmFyIGV2ZW50VHlwZXMgPSBfX2V2ZW50VHlwZXNfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdEYXRhJzsKICAgIGNvbmZpZzsKICAgIC8vIFZhcmlhYmxlIGRlY2xhcmF0aW9uLgogICAgICAgIHZhciBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gXy5leHRlbmQsIHdoZW4gPSB1dGlsLndoZW4sIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBhamF4ID0galF1ZXJ5LmFqYXgsIHVpZCA9IF8udW5pcXVlSWQsIGRhdGFFdmVudFdhaXQgPSBldmVudFR5cGVzWyd3YWl0J10sIGRhdGFFdmVudFN0YXJ0ID0gZXZlbnRUeXBlc1snc3RhcnQnXSwgZGF0YUV2ZW50U3RvcCA9IGV2ZW50VHlwZXNbJ3N0b3AnXSwgZGF0YUV2ZW50U3RhdHVzID0gZXZlbnRUeXBlc1snc3RhdHVzJ10sIGFyZ3VtZW50UmVzb2x2ZXIgPSBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgfTsKICAgIH07CiAgICBqUXVlcnkuYWpheFNldHRpbmdzLnRyYWRpdGlvbmFsID0gISF0Q29uZmlnLnVybC50cmFkaXRpb25hbEVuY29kaW5nOwogICAgdmFyIGpEb2MgPSBqUXVlcnkoZG9jdW1lbnQpOwogICAgZXZlbnRGYWN0b3J5LmluaXQoakRvYyk7CiAgICAvLyNyZWdpb24gRGF0YUZhY2FkZQogICAgLyoqCiAgICBUaGUgZGF0YSBmYWNhZGUgdGhhdCBpcyBoYW5kZWQgb2ZmIHRvIG1vZHVsZXMuCiAgICAKICAgIAogICAgRW5hYmxlcyBkYXRhIHRyYW5zcG9ydCwgdXNpbmcgalF1ZXJ5IGZvciB0aHJ1c3QuCiAgICAKICAgIEBmb3IgdGhydXN0LmRhdGEKICAgIEBjbGFzcyB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgQHBhcmFtIHt0aHJ1c3QuZGF0YS5EYXRhfSBwYXJlbnQgVGhlIHBhcmVudCB0aHJ1c3QgZGF0YSBvYmplY3QgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yLgogICAgQGNvbnN0cnVjdG9yCiAgICAqKi8KICAgIHZhciBEYXRhRmFjYWRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZGF0YUZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZHVsZSwgcGFyZW50KSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG1vZHVsZS5uYW1lICsgJy1kYXRhJzsKICAgICAgICAgICAgdGhpcy5tb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gcGFyZW50Ll9jYWxsYmFja3M7CiAgICAgICAgICAgIHRoaXMucmVzcG9uc2VRdWV1ZSA9IHBhcmVudC5yZXNwb25zZVF1ZXVlOwogICAgICAgICAgICB0aGlzLmluaXRFdmVudHMoKTsKICAgICAgICAgICAgdGhpcy5kZWZhdWx0cyA9IHBhcmVudC5kZWZhdWx0czsKICAgICAgICAgICAgdGhpcy5hcHBQYXRoID0gcGFyZW50LmFwcFBhdGg7CiAgICAgICAgfSk7CiAgICAgICAgXy5leHRlbmQoZGF0YUZhY2FkZS5wcm90b3R5cGUsIGV2ZW50cyk7CiAgICAgICAgcmV0dXJuIGRhdGFGYWNhZGU7CiAgICB9KSgpOwogICAgLy8jZW5kcmVnaW9uCiAgICAvKioKICAgIFRoZSBtYXN0ZXIgZGF0YSBwbHVnaW4uCiAgICAKICAgIAogICAgRW5hYmxlcyBkYXRhIHRyYW5zcG9ydCwgdXNpbmcgalF1ZXJ5IGZvciB0aHJ1c3QuCiAgICAKICAgIEBmb3IgdGhydXN0LmRhdGEKICAgIEBjbGFzcyB0aHJ1c3QuZGF0YS5EYXRhCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGhydXN0IGluc3RhbmNlIG5hbWUuCiAgICBAcGFyYW0ge3RocnVzdC5tZWRpYXRvci5NZWRpYXRvcn0gbWVkaWF0b3IgVGhlIHRocnVzdCBtZWRpYXRvciBpbnN0YW5jZS4KICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIHRocnVzdCBpbnN0YW5jZSBjb25maWd1cmF0aW9uLgogICAgQGNvbnN0cnVjdG9yCiAgICAqKi8KICAgIHZhciBEYXRhID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyNlbmRyZWdpb24KICAgICAgICBmdW5jdGlvbiBEYXRhKG5hbWUsIG1lZGlhdG9yLCBjb25maWcpIHsKICAgICAgICAgICAgaWYoIW5hbWUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRGF0YTogbW9kdWxlIG5hbWUgbXVzdCBiZSBkZWZpbmVkLicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIHRoaXMucmVzcG9uc2VRdWV1ZSA9IG5ldyBSZXNwb25zZVF1ZXVlKHRoaXMsIGNvbmZpZy5kYXRhLnN0YXJ0VGltZW91dCwgY29uZmlnLmRhdGEuZmluaXNoVGltZW91dCk7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1ZygnRGF0YTogQ3JlYXRpbmcgbmV3IERhdGEnKTsKICAgICAgICAgICAgdGhpcy5tZWRpYXRvciA9IG1lZGlhdG9yOwogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSAodGhpcykubWVkaWF0b3IuX2NhbGxiYWNrczsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnRzKCk7CiAgICAgICAgICAgIHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgICAgICAgICAgICBjYWNoZTogY29uZmlnLmRhdGEuY2FjaGUsCiAgICAgICAgICAgICAgICBiZWZvcmVTZW5kOiBldmVudEZhY3RvcnkuYmVmb3JlU2VuZE1ldGhvZCwKICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbicsCiAgICAgICAgICAgICAgICB0eXBlOiAnUE9TVCcsCiAgICAgICAgICAgICAgICB1cmw6ICcnLAogICAgICAgICAgICAgICAgZGF0YTogJycsCiAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLAogICAgICAgICAgICAgICAgX19tZWRpYXRvcl9kYXRhX2ZpcmVkX186IHRydWUsCiAgICAgICAgICAgICAgICBzaWxlbnQ6IGZhbHNlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuYXBwUGF0aCA9IGNvbmZpZy51cmwucGF0aCArICcvJzsKICAgICAgICB9CiAgICAgICAgRGF0YS5wcm90b3R5cGUuaW5pdEV2ZW50cyA9IC8vI3JlZ2lvbiBFdmVudHMKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbiAodG8sIGluaXQpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCwgb25jZSkgewogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgRGF0YUZhY2FkZSBmb3IgdGhlIGdpdmVuIG1vZHVsZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZhY2FkZQogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBhdmFpbGFibGUgZmFjYWRlcwogICAgICAgIEByZXR1cm5zIHtEYXRhRmFjYWRlfSBUaGUgbmV3IERhdGFGYWNhZGUKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgaWYobW9kLmRhdGEgJiYgIShmYWNhZGVzLmRhdGEgaW5zdGFuY2VvZiBEYXRhRmFjYWRlKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCciZGF0YSIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkYXRhOwogICAgICAgICAgICBpZihmYWNhZGVzLmRhdGEpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMuZGF0YS51cGRhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgICAgIGRhdGEgPSBmYWNhZGVzLmRhdGE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkYXRhID0gZmFjYWRlcy5kYXRhID0gbW9kLmRhdGEgPSBuZXcgRGF0YUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuZ2V0RGF0YSA9IC8qKgogICAgICAgIERvZXMgYSBHRVQgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIGdldERhdGEKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIHBhc3MgdG8gdGhlIGdpdmVuIHVybAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGEgR0VUIHRvIHRoZSBzZXJ2ZXIsIGZvciB0aGUgZ2l2ZW4gZGF0YSBhbmQgc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBnZXREYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgc2V0dGluZ3MgPSAhc2V0dGluZ3MgPyB7CiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0gOiBleHRlbmQoc2V0dGluZ3MsIHsKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldCh1cmwsIHNldHRpbmdzKTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLnBvc3REYXRhID0gLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIHBvc3REYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIHBvc3REYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgc2V0dGluZ3MgPSAhc2V0dGluZ3MgPyB7CiAgICAgICAgICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeShkYXRhKQogICAgICAgICAgICB9IDogZXh0ZW5kKHNldHRpbmdzLCB7CiAgICAgICAgICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeShkYXRhKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9zdCh1cmwsIHNldHRpbmdzKTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLmdldCA9IC8qKgogICAgICAgIERvZXMgYSBHRVQgdG8gdGhlIHNlcnZlciwgdXNpbmcgdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIERhdGEgbXVzdCBiZSBwYXNzZWQgaW4gdXNpbmcgc2V0dGluZ3M6IHsgZGF0YToge30gfSBvdGhlcndpc2UgdXNlIGdldERhdGEuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBnZXQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGEgR0VUIHRvIHRoZSBzZXJ2ZXIsIHVzaW5nIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBEYXRhIG11c3QgYmUgcGFzc2VkIGluIHVzaW5nIHNldHRpbmdzOiB7IGRhdGE6IHt9IH0gb3RoZXJ3aXNlIHVzZSBnZXREYXRhLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgICAgIEBtZXRob2QgZ2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgaWYoc2V0dGluZ3MgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgdXJsID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB1cmw7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodXJsID09PSB1bmRlZmluZWQgJiYgc2V0dGluZ3MudXJsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyB1cmwgaXMgZGVmaW5lZCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCBleHRlbmQoc2V0dGluZ3MgfHwgewogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICB0eXBlOiAnZ2V0JwogICAgICAgICAgICB9KSk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5wb3N0ID0gLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgdXNpbmcgdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIERhdGEgbXVzdCBiZSBwYXNzZWQgaW4gdXNpbmcgc2V0dGluZ3M6IHsgZGF0YToge30gfSBvdGhlcndpc2UgdXNlIHBvc3REYXRhLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgcG9zdAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIERvZXMgYSBQT1NUIHRvIHRoZSBzZXJ2ZXIsIHVzaW5nIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBEYXRhIG11c3QgYmUgcGFzc2VkIGluIHVzaW5nIHNldHRpbmdzOiB7IGRhdGE6IHt9IH0gb3RoZXJ3aXNlIHVzZSBwb3N0RGF0YS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIHBvc3QKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodXJsLCBzZXR0aW5ncykgewogICAgICAgICAgICBpZihzZXR0aW5ncyA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHVybDsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy51cmwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHVybCBpcyBkZWZpbmVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsIGV4dGVuZChzZXR0aW5ncyB8fCB7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIHR5cGU6ICdwb3N0JwogICAgICAgICAgICB9KSk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5hamF4ID0gLyoqCiAgICAgICAgRG9lcyBhbiBhamF4IGNhbGwgdG8gdGhlIGdpdmVuIHVybCwgd2l0aCB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBhamF4CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhbiBhamF4IGNhbGwgdG8gdGhlIGdpdmVuIHVybCwgd2l0aCB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBhamF4CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBvcHRpb25zLCB0eXBlLCBiZWZvcmVTZW5kOwogICAgICAgICAgICBmYWxzZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ0RhdGFbezB9XTogRmV0Y2hpbmcgZGF0YSBmcm9tICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHVybCkpOwogICAgICAgICAgICBpZihzZXR0aW5ncyA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHVybDsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gewogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy51cmwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVybCA9IHV0aWwuZml4dXBVcmwodXJsLCB0aGF0LmFwcFBhdGgpOwogICAgICAgICAgICBpZihzZXR0aW5ncy5zaWxlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBkZm8gPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgcXVlcnlJZCA9IHVpZCgnZHEnKTsKICAgICAgICAgICAgICAgIHR5cGUgPSBzZXR0aW5ncy50eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKHsKICAgICAgICAgICAgICAgIH0sIHRoYXQuZGVmYXVsdHMsIHsKICAgICAgICAgICAgICAgICAgICBiZWZvcmVTZW5kOiB1dGlsLm5vb3AKICAgICAgICAgICAgICAgIH0sIHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIGFqYXgodXJsLCBvcHRpb25zKS50aGVuKGFyZ3VtZW50UmVzb2x2ZXIoZGZvLnJlc29sdmUpLCBhcmd1bWVudFJlc29sdmVyKGRmby5yZWplY3QpKTsKICAgICAgICAgICAgICAgIHJldHVybiBkZm8ucHJvbWlzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKHsKICAgICAgICAgICAgfSwgdGhhdC5kZWZhdWx0cywgc2V0dGluZ3MsIHsKICAgICAgICAgICAgICAgIGJlZm9yZVNlbmQ6IGV2ZW50RmFjdG9yeS5iZWZvcmVTZW5kTWV0aG9kCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0eXBlID0gb3B0aW9ucy50eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc3BvbnNlUXVldWUuYWRkVG9RdWV1ZSh0eXBlLCB1cmwsIG9wdGlvbnMpOwogICAgICAgIH07CiAgICAgICAgRGF0YS5jb25maWcgPSBjb25maWc7CiAgICAgICAgcmV0dXJuIERhdGE7CiAgICB9KSgpOwogICAgZXhwb3J0cy5EYXRhID0gRGF0YTsgICAgCiAgICBfLmV4dGVuZChEYXRhLnByb3RvdHlwZSwgRXZlbnRzKTsKICAgIF8uZXh0ZW5kKERhdGFGYWNhZGUucHJvdG90eXBlLCBEYXRhLnByb3RvdHlwZSk7CiAgICAvLyBUYWtlIGEgaG9sZCBvZiBqUXVlcnkuLi4gdGhpcyBpcyBzdXJlIHRvIGJlIGNvbnRyYXZlc2lhbAogICAgalF1ZXJ5LmFqYXggPSAoRGF0YSkucHJvdG90eXBlLmFqYXg7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YScsIFsndGhydXN0L2RhdGEvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9kb20vbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnLi9zdWJqcXVlcnknLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2xvZycsICd0aHJ1c3QvZmFjYWRlJywgJ2hhcycsICd0aHJ1c3QvaW5zdGFuY2UnLCAnLi9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19zdWJqcXVlcnlfXywgX191dGlsX18sIF9fbG9nX18sIF9fZmFjYWRlX18sIF9faGFzX18sIF9faW5zdGFuY2VfXywgX19jb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyIHRRdWVyeSA9IHN1YmpxdWVyeS50UXVlcnk7CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGZhY2FkZSA9IF9fZmFjYWRlX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGluc3RhbmNlID0gX19pbnN0YW5jZV9fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ0RvbSc7CiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGV4dGVuZCA9IF8uZXh0ZW5kLCBiaW5kID0gXy5iaW5kLCBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LCBpc09iamVjdCA9IF8uaXNPYmplY3QsIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCB3aGVuID0gdXRpbC53aGVuLCBpc0FycmF5ID0gXy5pc0FycmF5OwogICAgLy8jcmVnaW9uIERvbUZhY2FkZQogICAgdmFyIERvbUZhY2FkZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGRvbUZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZCwgcGFyZW50KSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IHBhcmVudC5uYW1lOwogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gdFF1ZXJ5KGRvY3VtZW50LCB1bmRlZmluZWQsIHRoaXMubmFtZSk7CiAgICAgICAgfSk7CiAgICAgICAgZG9tRmFjYWRlLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKGZha2UpIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxFdmVudHMgPSB0aGlzLl9pbnRlcm5hbEV2ZW50cyB8fCBbXTsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRG9tW3swfV06IEluaXRhbGl6aW5nIHsxfURvbSBmYWNhZGUnLCB0aGlzLm5hbWUsIGZha2UgPyAnZmFrZSAnIDogJycpKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLnN0YXJ0ID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRG9tW3swfV06IFN0YXJ0aW5nIERvbSBmYWNhZGUnLCB0aGlzLm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogU3RvcHBpbmcgRG9tIGZhY2FkZScsIHRoaXMubmFtZSkpOwogICAgICAgICAgICBmb3IodmFyIGkgPSB0aGlzLl9pbnRlcm5hbEV2ZW50cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgdmFyIHN1YiA9IHRoaXMuX2ludGVybmFsRXZlbnRzW2ldOwogICAgICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxFdmVudHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgc3ViLmNvbnRleHQub2ZmLmFwcGx5KHRoaXMsIChpc0FycmF5KHN1YikpID8gc3ViIDogKGlzQXJyYXkoc3ViLmFyZ3MpKSA/IHN1Yi5hcmdzIDogW10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgZG9tRmFjYWRlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRG9tW3swfV06IERlc3Ryb3lpbmcgRG9tIGZhY2FkZScsIHRoaXMubmFtZSkpOwogICAgICAgICAgICBkZWxldGUgdGhpcy5faW50ZXJuYWxFdmVudHM7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGRvbUZhY2FkZTsKICAgIH0pKCk7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vI3JlZ2lvbiBEb20KICAgIHZhciBEb20gPSAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vI2VuZHJlZ2lvbgogICAgICAgIGZ1bmN0aW9uIERvbShuYW1lLCBtZWRpYXRvcikgewogICAgICAgICAgICBpZighbmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEb206IG1vZHVsZSBuYW1lIG11c3QgYmUgZGVmaW5lZC4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoJ0RhdGE6IENyZWF0aW5nIG5ldyBEYXRhJyk7CiAgICAgICAgICAgIHRoaXMubWVkaWF0b3IgPSBtZWRpYXRvcjsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gKG1lZGlhdG9yKS5fY2FsbGJhY2tzOwogICAgICAgICAgICB0aGlzLmluaXRFdmVudHMoKTsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpbnN0YW5jZS5mZXRjaEluc3RhbmNlKG5hbWUpLnByb21pc2UudGhlbihmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgICAgICB2YXIgbW9kID0gewogICAgICAgICAgICAgICAgfSwgZmFjYWRlID0gdGhhdC5jcmVhdGVGYWNhZGUodGhydXN0LCBtb2QsIHsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIERvbS5wcm90b3R5cGUuaW5pdEV2ZW50cyA9IC8vI3JlZ2lvbiBFdmVudHMKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBEb20ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uICh0bywgaW5pdCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIERvbS5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIG9uY2UpIHsKICAgICAgICB9OwogICAgICAgIERvbS5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgRG9tLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIERvbS5jb25maWcgPSBjb25maWc7CiAgICAgICAgRG9tLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgaWYoZmFjYWRlcy5kb20gJiYgIShmYWNhZGVzLmRvbSBpbnN0YW5jZW9mIERvbUZhY2FkZSkpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignImRvbSIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkb207CiAgICAgICAgICAgIGlmKGZhY2FkZXMuZG9tKSB7CiAgICAgICAgICAgICAgICBmYWNhZGVzLmRvbS51cGRhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgICAgIGRvbSA9IGZhY2FkZXMuZG9tOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZG9tID0gZmFjYWRlcy5kb20gPSBuZXcgRG9tRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRvbTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBEb207CiAgICB9KSgpOwogICAgZXhwb3J0cy5Eb20gPSBEb207ICAgIAogICAgLy8jZW5kcmVnaW9uCiAgICB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbScsIFsndGhydXN0L2RvbS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L3RlbXBsYXRlL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJ2RvbVJlYWR5JywgJ3RocnVzdC9mYWNhZGUnLCAnLi9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fZG9tUmVhZHlfXywgX19mYWNhZGVfXywgX19jb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgCiAgICAKICAgIHZhciBkb21SZWFkeSA9IF9fZG9tUmVhZHlfXzsKCiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdUZW1wbGF0ZSc7CiAgICBjb25maWc7CiAgICB2YXIgTE9ORyA9ICdsb25nJywgU0hPUlQgPSAnc2hvcnQnLCBJRCA9ICdpZCcsIGRlZXBDb3B5ID0gXy5tZXJnZSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGVhY2ggPSBfLmVhY2gsIGJpbmQgPSBfLmJpbmQsIHdoZW4gPSB1dGlsLndoZW4sIHJlZHVjZSA9IF8ucmVkdWNlLCBtZW1vaXplID0gXy5tZW1vaXplLCBtYXAgPSBfLm1hcCwgZXh0ZW5kID0gXy5leHRlbmQsIGdldExvbmdOYW1lID0gZnVuY3Rpb24gKG5hbWUsIHR5cGUpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHJlc3VsdCA9ICh0aGF0LnNob3J0TmFtZShuYW1lKSArICcuJyArICh0eXBlIHx8IHRoYXQuY29uZmlnLmRlZmF1bHRUeXBlKSArIHRoYXQuY29uZmlnLmV4dGVuc2lvbikudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwgZ2V0U2hvcnROYW1lID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHJlc3VsdCA9IHJlZHVjZSh0aGF0LnRlbXBsYXRlVHlwZXMsIGZ1bmN0aW9uIChtZW1vLCB4KSB7CiAgICAgICAgICAgIHJldHVybiBtZW1vLnJlcGxhY2UoJy4nICsgeC50b0xvd2VyQ2FzZSgpICsgdGhhdC5jb25maWcuZXh0ZW5zaW9uLCAnJyk7CiAgICAgICAgfSwgbmFtZS50b0xvd2VyQ2FzZSgpKS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LCBnZXRUZW1wbGF0ZUlkID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHJlc3VsdCA9IHRoYXQuc2hvcnROYW1lKG5hbWUpLnJlcGxhY2UoL1wvL2csICctJyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnRlbXBsYXRlCiAgICBAcmVxdWlyZXMgdGhydXN0LmRhdGEKICAgICoqLwogICAgLyoqCiAgICBUaGUgdGVtcGxhdGUgcGx1Z2luIGNvbnN0dXJjdG9yLgogICAgCiAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZQogICAgQGNsYXNzIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdGhydXN0IGNvbmZpZyBvYmplY3QKICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSB0aHJ1c3QgZGF0YSBpbnN0YW5jZQogICAgQHVzZXMgdGhydXN0LmRhdGEuRGF0YQogICAgQGNvbnN0cnVjdG9yCiAgICAqKi8KICAgIHZhciBUZW1wbGF0ZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gVGVtcGxhdGUoY29uZmlnLCBkYXRhKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdGVtcGxhdGVDb25maWcgPSB0aGlzLmNvbmZpZyA9IGNvbmZpZy50ZW1wbGF0ZTsKICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZVR5cGVzID0gbWFwKHRlbXBsYXRlQ29uZmlnLnR5cGVzLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGF0LnRlbXBsYXRlcyA9IHsKICAgICAgICAgICAgICAgIGxvbmc6IHsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzaG9ydDogewogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGlkOiB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoYXQubG9uZ05hbWUgPSBtZW1vaXplKGJpbmQoZ2V0TG9uZ05hbWUsIHRoYXQpKTsKICAgICAgICAgICAgdGhhdC5zaG9ydE5hbWUgPSBtZW1vaXplKGJpbmQoZ2V0U2hvcnROYW1lLCB0aGF0KSk7CiAgICAgICAgICAgIHRoYXQudGVtcGxhdGVJZCA9IG1lbW9pemUoYmluZChnZXRUZW1wbGF0ZUlkLCB0aGF0KSk7CiAgICAgICAgICAgIHRoYXQuZW5naW5lcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhhdC5kYXRhID0gZGF0YTsKICAgICAgICAgICAgcmVxdWlyZShbCiAgICAgICAgICAgICAgICAodGVtcGxhdGVDb25maWcudGVtcGxhdGVQYXRoc1t0ZW1wbGF0ZUNvbmZpZy5kZWZhdWx0VHlwZV0gfHwgJ3RocnVzdC90ZW1wbGF0ZS8nICsgdGVtcGxhdGVDb25maWcuZGVmYXVsdFR5cGUpCiAgICAgICAgICAgIF0sIGZ1bmN0aW9uIChlbmdpbmUpIHsKICAgICAgICAgICAgICAgIHRoYXQuZW5naW5lc1t0ZW1wbGF0ZUNvbmZpZy5kZWZhdWx0VHlwZV0gPSBlbmdpbmU7CiAgICAgICAgICAgICAgICBkb21SZWFkeShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgKF8oZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpKSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhIXguZ2V0QXR0cmlidXRlKCdkYXRhLXRlbXBsYXRlJyk7CiAgICAgICAgICAgICAgICAgICAgfSkuZWFjaChiaW5kKHRoYXQuY3JlYXRlRnJvbURvbU5vZGUsIHRoYXQpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmdldCA9IC8qKgogICAgICAgIEdldHMgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBjYWNoZSBpZiBpdCBoYXMgYmVlbiBmZXRjaGVkLiBGYWxzZSBvdGhlcndpc2UuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGdldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lIHRvIHRyeSBhbmQgZ2V0LgogICAgICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIHRlbXBsYXRlIG9iamVjdAogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIEdldHMgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBjYWNoZSBpZiBpdCBoYXMgYmVlbiBmZXRjaGVkLiBGYWxzZSBvdGhlcndpc2UuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgICAgICBAbWV0aG9kIGdldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lIHRvIHRyeSBhbmQgZ2V0LgogICAgICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIHRlbXBsYXRlIG9iamVjdAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IG51bGwsIHRoYXQgPSB0aGlzLCB0ZW1wbGF0ZXMgPSB0aGF0LnRlbXBsYXRlczsKICAgICAgICAgICAgaWYodGVtcGxhdGUgPSB0ZW1wbGF0ZXMubG9uZ1t0aGF0LmxvbmdOYW1lKG5hbWUpXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgICAgICAgICB9IGVsc2UgaWYodGVtcGxhdGUgPSB0ZW1wbGF0ZXMuc2hvcnRbdGhhdC5zaG9ydE5hbWUobmFtZSldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICAgICAgICAgIH0gZWxzZSBpZih0ZW1wbGF0ZSA9IHRlbXBsYXRlcy5pZFt0aGF0LnRlbXBsYXRlSWQobmFtZSldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuc2V0ID0gLyoqCiAgICAgICAgU2V0cyBhIHRlbXBsYXRlIHRvIHRoZSBjYWNoZSwgd2l0aCB0aGUgZ2l2ZW4gaW5mb3JtYXRpb24KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2Qgc2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdGVtcGxhdGUgZW5naW5lIHR5cGUKICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjb21waWxlZFRlbXBsYXRlIFRoZSBjb21waWxlZCB0ZW1wbGF0ZSBtZXRob2QKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaHRtbCBUaGUgdGVtcGxhdGUgSFRNTC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSwgdHlwZSwgY29tcGlsZWRUZW1wbGF0ZSwgaHRtbCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHNob3J0TmFtZSA9IHRoYXQuc2hvcnROYW1lKG5hbWUpLCB0ZW1wbGF0ZUlkID0gdGhhdC50ZW1wbGF0ZUlkKG5hbWUpLCBsb25nTmFtZSA9IHRoYXQubG9uZ05hbWUobmFtZSwgdHlwZSksIHRlbXBsYXRlcyA9IHRoYXQudGVtcGxhdGVzOwogICAgICAgICAgICB0ZW1wbGF0ZXMubG9uZ1tsb25nTmFtZV0gPSB0ZW1wbGF0ZXMuc2hvcnRbc2hvcnROYW1lXSA9IHRlbXBsYXRlcy5pZFt0ZW1wbGF0ZUlkXSA9IHsKICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICBzaG9ydE5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICBpZDogdGVtcGxhdGVJZCwKICAgICAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgICBodG1sOiBodG1sLAogICAgICAgICAgICAgICAgY29tcGlsZWQ6IGNvbXBpbGVkVGVtcGxhdGUKICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5oYXMgPSAvKioKICAgICAgICBDaGVja3MgaWYgdGhlIHRlbXBsYXRlIGV4aXN0cyBpbiB0aGUgY2FjaGUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGhhcwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHJldHVybnMge0Jvb2xlYW59IFdldGhlciB0aGUgdGVtcGxhdGUgZXhpc3RzIG9yIG5vdC4KICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBDaGVja3MgaWYgdGhlIHRlbXBsYXRlIGV4aXN0cyBpbiB0aGUgY2FjaGUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgICAgICBAbWV0aG9kIGhhcwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHJldHVybnMge0Jvb2xlYW59IFdldGhlciB0aGUgdGVtcGxhdGUgZXhpc3RzIG9yIG5vdC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiAhIXRoYXQuZ2V0KG5hbWUpOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLm5ld1RlbXBsYXRlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyB0ZW1wbGF0ZSBnaXZlbiB0aGUgaW5mb3JtYXRpb24KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgbmV3VGVtcGxhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0ZW1wbGF0ZSBlbmdpbmUgdHlwZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBodG1sIFRoZSB0ZW1wbGF0ZSBIVE1MLgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBlbmdpbmUgVGhlIHRlbXBsYXRlIGVuZ2luZQogICAgICAgIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXcgdGVtcGxhdGUgaW5zdGFuY2UuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUsIHR5cGUsIGh0bWwsIGVuZ2luZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHRlbXBsYXRlID0gdGhhdC5nZXQobmFtZSk7CiAgICAgICAgICAgIGlmKCF0ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgaWYodHlwZSA9PSAncHJlY29tcGlsZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5zZXQobmFtZSwgdHlwZSwgaHRtbCwgaHRtbC50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRpbmdNZXRob2Q7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBpbGVkVGVtcGxhdGUgPSB0aGlzLmNvbXBpbGUoaHRtbCwgZW5naW5lKTsKICAgICAgICAgICAgICAgICAgICB0aGF0LnNldChuYW1lLCB0eXBlLCBjb21waWxlZFRlbXBsYXRlLCBodG1sKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhhdC5nZXQobmFtZSk7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuY29tcGlsZSA9IC8qKgogICAgICAgIENvbXBpbGVzIGEgdGVtcGxhdGUgZ2l2ZW4gdGhlIGh0bWwgYW5kIHRoZSBlbmdpbmUgdHlwZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgY29tcGlsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBodG1sIFRoZSBodG1sIHRvIGdlbmVyYXRlIHRoZSB0ZW1wbGF0ZSBmcm9tCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGVuZ2luZSBUaGUgdGVtcGxhdGUgZW5naW5lIHRoYXQgaXMgYmVpbmcgdXNlZC4KICAgICAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBjb21waWxlZCB0ZW1wbGF0ZSBtZXRob2QKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoaHRtbCwgZW5naW5lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdGVtcGxhdGluZ01ldGhvZDsKICAgICAgICAgICAgaWYoIWVuZ2luZSkgewogICAgICAgICAgICAgICAgZW5naW5lID0gdGhhdC5lbmdpbmVzW3RoYXQuY29uZmlnLmRlZmF1bHRUeXBlXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0eXBlb2YgZW5naW5lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0ZW1wbGF0aW5nTWV0aG9kID0gZW5naW5lOwogICAgICAgICAgICB9IGVsc2UgaWYodHlwZW9mIGVuZ2luZS50ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgdGVtcGxhdGluZ01ldGhvZCA9IGVuZ2luZS50ZW1wbGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGVtcGxhdGluZ01ldGhvZChodG1sKTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5mZXRjaCA9IC8qKgogICAgICAgIEZldGNocyBhIHRlbXBsYXRlIGZyb20gdGhlIHNlcnZlciwgb3IgdGVtcGxhdGUgc3RvcmUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGZldGNoCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gW3R5cGVdIFRoZSB0ZW1wbGF0ZSB0eXBlIGlmIG5vdCB0aGUgZGVmYXVsdAogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBmb3Igd2hlbiB0aGUgdGVtcGxhdGUgaGFzIGJlZW4gbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIEZldGNocyBhIHRlbXBsYXRlIGZyb20gdGhlIHNlcnZlciwgb3IgdGVtcGxhdGUgc3RvcmUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgICAgICBAbWV0aG9kIGZldGNoCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gW3R5cGVdIFRoZSB0ZW1wbGF0ZSB0eXBlIGlmIG5vdCB0aGUgZGVmYXVsdAogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBmb3Igd2hlbiB0aGUgdGVtcGxhdGUgaGFzIGJlZW4gbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCB0eXBlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdHlwZSA9IHR5cGUgfHwgdGhhdC5jb25maWcuZGVmYXVsdFR5cGUsIHNob3J0TmFtZSA9IHRoYXQuc2hvcnROYW1lKG5hbWUpLCBsb25nTmFtZSA9IHRoYXQubG9uZ05hbWUobmFtZSwgdHlwZSksIHRlbXBsYXRlOwogICAgICAgICAgICB2YXIgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgIGlmKHRlbXBsYXRlID0gdGhhdC5nZXQobmFtZSkpIHsKICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhhdC5kYXRhLmdldCh0aGF0LmNvbmZpZy5iYXNlVXJsICsgbG9uZ05hbWUsIHsKICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAndGV4dC9wbGFpbicsCiAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ3RleHQnLAogICAgICAgICAgICAgICAgc2lsZW50OiB0cnVlCiAgICAgICAgICAgIH0pLnRoZW4od2hlbi5hcHBseShmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgaWYodHlwZSA9PSAncHJlY29tcGlsZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhhdC5uZXdUZW1wbGF0ZShuYW1lLCB0eXBlLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYodGhhdC5lbmdpbmVzW3R5cGVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoYXQubmV3VGVtcGxhdGUobmFtZSwgdHlwZSwgZGF0YSwgdGhhdC5lbmdpbmVzW3R5cGVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhhdC5jb25maWcudGVtcGxhdGVQYXRoc1t0eXBlXSB8fCAndGhydXN0L3RlbXBsYXRlLycgKyB0eXBlKQogICAgICAgICAgICAgICAgICAgICAgICBdLCBmdW5jdGlvbiAoZW5naW5lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmVuZ2luZXNbdHlwZV0gPSBlbmdpbmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB0aGF0Lm5ld1RlbXBsYXRlKG5hbWUsIHR5cGUsIGRhdGEsIGVuZ2luZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSwgZGVmZXIucmVqZWN0KTsKICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuY3JlYXRlRnJvbURvbU5vZGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbmV3IHRlbXBsYXRlIGZyb20gdGhlIGdpdmVuIERPTSBOb2RlCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZyb21Eb21Ob2RlCiAgICAgICAgQHByb3RlY3RlZAogICAgICAgIEBwYXJhbSB7Tm9kZX0gZWxlbWVudCBUSGUgZG9tZSBlbGVtZW50LgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdGhhdC5uZXdUZW1wbGF0ZShlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10ZW1wbGF0ZScpLCBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10eXBlJyksIGVsZW1lbnQudGV4dCk7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuY3JlYXRlRmFjYWRlID0gLyoqCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZhY2FkZQogICAgICAgIEBwYXJhbSB7dGhydXN0LlRocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGFscmVhZHkgYWRkZWQgZm9yIHRoaXMgbW9kdWxlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICB2YXIgdGVtcGxhdGVJbnN0YW5jZSA9IHRocnVzdC50ZW1wbGF0ZTsKICAgICAgICAgICAgdmFyIGZhY2FkZSA9IGZhY2FkZXMudGVtcGxhdGUgPSBuZXcgVGVtcGxhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgbW9kLnRlbXBsYXRlcyA9IHsKICAgICAgICAgICAgICAgIGZldGNoOiBiaW5kKHRlbXBsYXRlSW5zdGFuY2UuZmV0Y2gsIHRlbXBsYXRlSW5zdGFuY2UpLAogICAgICAgICAgICAgICAgZ2V0OiBiaW5kKHRlbXBsYXRlSW5zdGFuY2UuZ2V0LCB0ZW1wbGF0ZUluc3RhbmNlKSwKICAgICAgICAgICAgICAgIGhhczogYmluZCh0ZW1wbGF0ZUluc3RhbmNlLmhhcywgdGVtcGxhdGVJbnN0YW5jZSkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGZhY2FkZTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLmNvbmZpZyA9IGNvbmZpZzsKICAgICAgICByZXR1cm4gVGVtcGxhdGU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5UZW1wbGF0ZSA9IFRlbXBsYXRlOyAgICAKICAgIC8qKgogICAgCiAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZQogICAgQGNsYXNzIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZUZhY2FkZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgQHBhcmFtIHt0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGV9IHBhcmVudCBUaGUgdGVtcGxhdGUgaW5zdGFuY2UgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yLgogICAgKiovCiAgICB2YXIgVGVtcGxhdGVGYWNhZGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0ZW1wbGF0ZUZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZHVsZSwgcGFyZW50KSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG1vZHVsZS5uYW1lICsgJy10ZW1wbGF0ZSc7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gcGFyZW50Ll9fY29udmVudGlvbnM7CiAgICAgICAgICAgIGV4dGVuZCh0aGlzLCB7CiAgICAgICAgICAgICAgICBmZXRjaDogYmluZChwYXJlbnQuZmV0Y2gsIHBhcmVudCksCiAgICAgICAgICAgICAgICBnZXQ6IGJpbmQocGFyZW50LmdldCwgcGFyZW50KSwKICAgICAgICAgICAgICAgIGhhczogYmluZChwYXJlbnQuaGFzLCBwYXJlbnQpCiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZUZhY2FkZTsKICAgIH0pKCk7CiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIHRocnVzdC90ZW1wbGF0ZSBieSBwYXRoLgogICAgUmVxdWlyZXMgdGhlIGluc3RhbmNlLCB0aGF0IHRoZSB0ZW1wbGF0ZSBpcyBleHBlY3RlZCB0byBjb21lIGZyb20uCiAgICB0aHJ1c3RJbnN0YW5jZVs6ZW5naW5lTmFtZV06dGVtcGxhdGVQYXRoCiAgICAKICAgIFByZWZpeCB3aXRoIDxlbmdpbmVOYW1lPjogdG8gc2VsZWN0IGEgc3BlY2lmaWMgdGVtcGxhdGUgZW5naW5lLgogICAgdGhydXN0L3RlbXBsYXRlIWdsb2JhbDp0ZW1wbGF0ZXMvbXlUZW1wbGF0ZS50bXBsID0gU3BlY2lmaWMgdGVtcGxhdGUKICAgIHRocnVzdC90ZW1wbGF0ZSFpbnN0YW5jZTI6dGVtcGxhdGVzL215VGVtcGxhdGUgPSBVc2VzIGRlZmF1bHQgZXh0ZW5zaW9uIGZyb20gY29uZmlnCiAgICB0aHJ1c3QvdGVtcGxhdGUhaW5zdGFuY2UyOmtlbmRvOnRlbXBsYXRlcy9teVRlbXBsYXRlLnRtcGwgPSBVc2VzIHRoZSBrZW5kbyB0ZW1wbGF0ZSBlbmdpbmUuCiAgICB0aHJ1c3QvdGVtcGxhdGUhaW5zdGFuY2UzOmtlbmRvOnRlbXBsYXRlcy9teVRlbXBsYXRlLnRtcGwgPSBVc2VzIHRoZSBrZW5kbyB0ZW1wbGF0ZSBlbmdpbmUgd2l0aCB0aGUgZGVmYXVsdCBleHRlbnNpb24KICAgIAogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSB0ZW1wbGF0ZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICAvLyBOb3QgY29tcGxldGVkIHlldAogICAgLy8gU2hvdWxkIGJlaGF2ZSBzaW1pbGFybHkgdG8gdGV4dCEKICAgIC8vZXhwb3J0IGZ1bmN0aW9uIGxvYWQobmFtZTogc3RyaW5nLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpCiAgICAvL3sKICAgIC8vICAgIHZhciB0ZW1wbGF0ZVBhdGggPSBuYW1lLAogICAgLy8gICAgICAgIHRlbXBsYXRlRW5naW5lLAogICAgLy8gICAgICAgIGNvbG9uID0gdGVtcGxhdGVQYXRoLmluZGV4T2YoJzonKTsKICAgIC8vCXZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwKICAgIC8vICAgICAgICBpbnN0YW5jZU5hbWUgPSBwYXJ0c1swXSwKICAgIC8vCQl0ZW1wbGF0ZUVuZ2luZSA9IHBhcnRzWzFdLAogICAgLy8JCXRlbXBsYXRlUGF0aCA9IHBhcnRzWzJdIHx8IHRlbXBsYXRlRW5naW5lOwogICAgLy8gICAgaWYgKHBhcnRzLmxlbmd0aCA9PT0gMikKICAgIC8vICAgICAgICB0ZW1wbGF0ZUVuZ2luZSA9IG51bGw7CiAgICAvLwkvL3ZhciBpbnN0YW5jZVByb21pc2UgPSBUaHJ1c3QuX19mZXRjaEluc3RhbmNlKHJlYWxOYW1lKTsKICAgIC8vICAgIC8vIEdldCB0aGUgZGF0YSBwbHVnaW4uCiAgICAvLyAgICBwYXJlbnRSZXF1aXJlKFsndGhydXN0IWRhdGE6JyArIGluc3RhbmNlTmFtZV0sIChkYXRhUGx1Z2luKSA9PgogICAgLy8gICAgewogICAgLy8gICAgICAgIHZhciBkYXRhUGx1Z2luID0gZGF0YVBsdWdpbgogICAgLy8gICAgfSk7CiAgICAvL30KICAgIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUnLCBbJ3RocnVzdC90ZW1wbGF0ZS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCgoKLy8KLy8gR2VuZXJhdGVkIG9uIFN1biBEZWMgMTYgMjAxMiAyMjo0NzowNSBHTVQtMDUwMCAoRVNUKSBieSBOb2Rlaml0c3UsIEluYyAoVXNpbmcgQ29kZXN1cmdlb24pLgovLyBWZXJzaW9uIDEuMS45Ci8vCgooZnVuY3Rpb24gKGV4cG9ydHMpIHsKCgovKgogKiBicm93c2VyLmpzOiBCcm93c2VyIHNwZWNpZmljIGZ1bmN0aW9uYWxpdHkgZm9yIGRpcmVjdG9yLgogKgogKiAoQykgMjAxMSwgTm9kZWppdHN1IEluYy4KICogTUlUIExJQ0VOU0UKICoKICovCgppZiAoIUFycmF5LnByb3RvdHlwZS5maWx0ZXIpIHsKICBBcnJheS5wcm90b3R5cGUuZmlsdGVyID0gZnVuY3Rpb24oZmlsdGVyLCB0aGF0KSB7CiAgICB2YXIgb3RoZXIgPSBbXSwgdjsKICAgIGZvciAodmFyIGkgPSAwLCBuID0gdGhpcy5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgaWYgKGkgaW4gdGhpcyAmJiBmaWx0ZXIuY2FsbCh0aGF0LCB2ID0gdGhpc1tpXSwgaSwgdGhpcykpIHsKICAgICAgICBvdGhlci5wdXNoKHYpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gb3RoZXI7CiAgfTsKfQoKaWYgKCFBcnJheS5pc0FycmF5KXsKICBBcnJheS5pc0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKfQoKdmFyIGRsb2MgPSBkb2N1bWVudC5sb2NhdGlvbjsKCmZ1bmN0aW9uIGRsb2NIYXNoRW1wdHkoKSB7CiAgLy8gTm9uLUlFIGJyb3dzZXJzIHJldHVybiAnJyB3aGVuIHRoZSBhZGRyZXNzIGJhciBzaG93cyAnIyc7IERpcmVjdG9yJ3MgbG9naWMKICAvLyBhc3N1bWVzIGJvdGggbWVhbiBlbXB0eS4KICByZXR1cm4gZGxvYy5oYXNoID09PSAnJyB8fCBkbG9jLmhhc2ggPT09ICcjJzsKfQoKdmFyIGxpc3RlbmVyID0gewogIG1vZGU6ICdtb2Rlcm4nLAogIGhhc2g6IGRsb2MuaGFzaCwKICBoaXN0b3J5OiBmYWxzZSwKCiAgY2hlY2s6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBoID0gZGxvYy5oYXNoOwogICAgaWYgKGggIT0gdGhpcy5oYXNoKSB7CiAgICAgIHRoaXMuaGFzaCA9IGg7CiAgICAgIHRoaXMub25IYXNoQ2hhbmdlZCgpOwogICAgfQogIH0sCgogIGZpcmU6IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLm1vZGUgPT09ICdtb2Rlcm4nKSB7CiAgICAgIHRoaXMuaGlzdG9yeSA9PT0gdHJ1ZSA/IHdpbmRvdy5vbnBvcHN0YXRlKCkgOiB3aW5kb3cub25oYXNoY2hhbmdlKCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgdGhpcy5vbkhhc2hDaGFuZ2VkKCk7CiAgICB9CiAgfSwKCiAgaW5pdDogZnVuY3Rpb24gKGZuLCBoaXN0b3J5KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoKICAgIGlmICghUm91dGVyLmxpc3RlbmVycykgewogICAgICBSb3V0ZXIubGlzdGVuZXJzID0gW107CiAgICB9CgogICAgZnVuY3Rpb24gb25jaGFuZ2Uob25DaGFuZ2VFdmVudCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IFJvdXRlci5saXN0ZW5lcnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgUm91dGVyLmxpc3RlbmVyc1tpXShvbkNoYW5nZUV2ZW50KTsKICAgICAgfQogICAgfQoKICAgIC8vbm90ZSBJRTggaXMgYmVpbmcgY291bnRlZCBhcyAnbW9kZXJuJyBiZWNhdXNlIGl0IGhhcyB0aGUgaGFzaGNoYW5nZSBldmVudAogICAgaWYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdyAmJiAoZG9jdW1lbnQuZG9jdW1lbnRNb2RlID09PSB1bmRlZmluZWQKICAgICAgfHwgZG9jdW1lbnQuZG9jdW1lbnRNb2RlID4gNykpIHsKICAgICAgLy8gQXQgbGVhc3QgZm9yIG5vdyBIVE1MNSBoaXN0b3J5IGlzIGF2YWlsYWJsZSBmb3IgJ21vZGVybicgYnJvd3NlcnMgb25seQogICAgICBpZiAodGhpcy5oaXN0b3J5ID09PSB0cnVlKSB7CiAgICAgICAgLy8gVGhlcmUgaXMgYW4gb2xkIGJ1ZyBpbiBDaHJvbWUgdGhhdCBjYXVzZXMgb25wb3BzdGF0ZSB0byBmaXJlIGV2ZW4KICAgICAgICAvLyB1cG9uIGluaXRpYWwgcGFnZSBsb2FkLiBTaW5jZSB0aGUgaGFuZGxlciBpcyBydW4gbWFudWFsbHkgaW4gaW5pdCgpLAogICAgICAgIC8vIHRoaXMgd291bGQgY2F1c2UgQ2hyb21lIHRvIHJ1biBpdCB0d2lzZS4gQ3VycmVudGx5IHRoZSBvbmx5CiAgICAgICAgLy8gd29ya2Fyb3VuZCBzZWVtcyB0byBiZSB0byBzZXQgdGhlIGhhbmRsZXIgYWZ0ZXIgdGhlIGluaXRpYWwgcGFnZSBsb2FkCiAgICAgICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NjMwNDAKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgd2luZG93Lm9ucG9wc3RhdGUgPSBvbmNoYW5nZTsKICAgICAgICB9LCA1MDApOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIHdpbmRvdy5vbmhhc2hjaGFuZ2UgPSBvbmNoYW5nZTsKICAgICAgfQogICAgICB0aGlzLm1vZGUgPSAnbW9kZXJuJzsKICAgIH0KICAgIGVsc2UgewogICAgICAvLwogICAgICAvLyBJRSBzdXBwb3J0LCBiYXNlZCBvbiBhIGNvbmNlcHQgYnkgRXJpayBBcnZpZHNvbiAuLi4KICAgICAgLy8KICAgICAgdmFyIGZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CiAgICAgIGZyYW1lLmlkID0gJ3N0YXRlLWZyYW1lJzsKICAgICAgZnJhbWUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmcmFtZSk7CiAgICAgIHRoaXMud3JpdGVGcmFtZSgnJyk7CgogICAgICBpZiAoJ29ucHJvcGVydHljaGFuZ2UnIGluIGRvY3VtZW50ICYmICdhdHRhY2hFdmVudCcgaW4gZG9jdW1lbnQpIHsKICAgICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgnb25wcm9wZXJ0eWNoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChldmVudC5wcm9wZXJ0eU5hbWUgPT09ICdsb2NhdGlvbicpIHsKICAgICAgICAgICAgc2VsZi5jaGVjaygpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgeyBzZWxmLmNoZWNrKCk7IH0sIDUwKTsKCiAgICAgIHRoaXMub25IYXNoQ2hhbmdlZCA9IG9uY2hhbmdlOwogICAgICB0aGlzLm1vZGUgPSAnbGVnYWN5JzsKICAgIH0KCiAgICBSb3V0ZXIubGlzdGVuZXJzLnB1c2goZm4pOwoKICAgIHJldHVybiB0aGlzLm1vZGU7CiAgfSwKCiAgZGVzdHJveTogZnVuY3Rpb24gKGZuKSB7CiAgICBpZiAoIVJvdXRlciB8fCAhUm91dGVyLmxpc3RlbmVycykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGxpc3RlbmVycyA9IFJvdXRlci5saXN0ZW5lcnM7CgogICAgZm9yICh2YXIgaSA9IGxpc3RlbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBpZiAobGlzdGVuZXJzW2ldID09PSBmbikgewogICAgICAgIGxpc3RlbmVycy5zcGxpY2UoaSwgMSk7CiAgICAgIH0KICAgIH0KICB9LAoKICBzZXRIYXNoOiBmdW5jdGlvbiAocykgewogICAgLy8gTW96aWxsYSBhbHdheXMgYWRkcyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeQogICAgaWYgKHRoaXMubW9kZSA9PT0gJ2xlZ2FjeScpIHsKICAgICAgdGhpcy53cml0ZUZyYW1lKHMpOwogICAgfQoKICAgIGlmICh0aGlzLmhpc3RvcnkgPT09IHRydWUpIHsKICAgICAgd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgcyk7CiAgICAgIC8vIEZpcmUgYW4gb25wb3BzdGF0ZSBldmVudCBtYW51YWxseSBzaW5jZSBwdXNoaW5nIGRvZXMgbm90IG9idmlvdXNseQogICAgICAvLyB0cmlnZ2VyIHRoZSBwb3AgZXZlbnQuCiAgICAgIHRoaXMuZmlyZSgpOwogICAgfSBlbHNlIHsKICAgICAgZGxvYy5oYXNoID0gKHNbMF0gPT09ICcvJykgPyBzIDogJy8nICsgczsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0sCgogIHdyaXRlRnJhbWU6IGZ1bmN0aW9uIChzKSB7CiAgICAvLyBJRSBzdXBwb3J0Li4uCiAgICB2YXIgZiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0ZS1mcmFtZScpOwogICAgdmFyIGQgPSBmLmNvbnRlbnREb2N1bWVudCB8fCBmLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQ7CiAgICBkLm9wZW4oKTsKICAgIGQud3JpdGUoIjxzY3JpcHQ+X2hhc2ggPSAnIiArIHMgKyAiJzsgb25sb2FkID0gcGFyZW50Lmxpc3RlbmVyLnN5bmNIYXNoOzxzY3JpcHQ+Iik7CiAgICBkLmNsb3NlKCk7CiAgfSwKCiAgc3luY0hhc2g6IGZ1bmN0aW9uICgpIHsKICAgIC8vIElFIHN1cHBvcnQuLi4KICAgIHZhciBzID0gdGhpcy5faGFzaDsKICAgIGlmIChzICE9IGRsb2MuaGFzaCkgewogICAgICBkbG9jLmhhc2ggPSBzOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgb25IYXNoQ2hhbmdlZDogZnVuY3Rpb24gKCkge30KfTsKCnZhciBSb3V0ZXIgPSBleHBvcnRzLlJvdXRlciA9IGZ1bmN0aW9uIChyb3V0ZXMpIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUm91dGVyKSkgcmV0dXJuIG5ldyBSb3V0ZXIocm91dGVzKTsKCiAgdGhpcy5wYXJhbXMgICA9IHt9OwogIHRoaXMucm91dGVzICAgPSB7fTsKICB0aGlzLm1ldGhvZHMgID0gWydvbicsICdvbmNlJywgJ2FmdGVyJywgJ2JlZm9yZSddOwogIHRoaXMuc2NvcGUgICAgPSBbXTsKICB0aGlzLl9tZXRob2RzID0ge307CgogIHRoaXMuX2luc2VydCA9IHRoaXMuaW5zZXJ0OwogIHRoaXMuaW5zZXJ0ID0gdGhpcy5pbnNlcnRFeDsKCiAgdGhpcy5oaXN0b3J5U3VwcG9ydCA9ICh3aW5kb3cuaGlzdG9yeSAhPSBudWxsID8gd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlIDogbnVsbCkgIT0gbnVsbAoKICB0aGlzLmNvbmZpZ3VyZSgpOwogIHRoaXMubW91bnQocm91dGVzIHx8IHt9KTsKfTsKClJvdXRlci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChyKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHRoaXMuaGFuZGxlciA9IGZ1bmN0aW9uKG9uQ2hhbmdlRXZlbnQpIHsKICAgIHZhciBuZXdVUkwgPSBvbkNoYW5nZUV2ZW50ICYmIG9uQ2hhbmdlRXZlbnQubmV3VVJMIHx8IHdpbmRvdy5sb2NhdGlvbi5oYXNoOwogICAgdmFyIHVybCA9IHNlbGYuaGlzdG9yeSA9PT0gdHJ1ZSA/IHNlbGYuZ2V0UGF0aCgpIDogbmV3VVJMLnJlcGxhY2UoLy4qIy8sICcnKTsKICAgIHNlbGYuZGlzcGF0Y2goJ29uJywgdXJsKTsKICB9OwoKICBsaXN0ZW5lci5pbml0KHRoaXMuaGFuZGxlciwgdGhpcy5oaXN0b3J5KTsKCiAgaWYgKHRoaXMuaGlzdG9yeSA9PT0gZmFsc2UpIHsKICAgIGlmIChkbG9jSGFzaEVtcHR5KCkgJiYgcikgewogICAgICBkbG9jLmhhc2ggPSByOwogICAgfSBlbHNlIGlmICghZGxvY0hhc2hFbXB0eSgpKSB7CiAgICAgIHNlbGYuZGlzcGF0Y2goJ29uJywgZGxvYy5oYXNoLnJlcGxhY2UoL14jLywgJycpKTsKICAgIH0KICB9CiAgZWxzZSB7CiAgICB2YXIgcm91dGVUbyA9IGRsb2NIYXNoRW1wdHkoKSAmJiByID8gciA6ICFkbG9jSGFzaEVtcHR5KCkgPyBkbG9jLmhhc2gucmVwbGFjZSgvXiMvLCAnJykgOiBudWxsOwogICAgaWYgKHJvdXRlVG8pIHsKICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgcm91dGVUbyk7CiAgICB9CgogICAgLy8gUm91dGVyIGhhcyBiZWVuIGluaXRpYWxpemVkLCBidXQgZHVlIHRvIHRoZSBjaHJvbWUgYnVnIGl0IHdpbGwgbm90CiAgICAvLyB5ZXQgYWN0dWFsbHkgcm91dGUgSFRNTDUgaGlzdG9yeSBzdGF0ZSBjaGFuZ2VzLiBUaHVzLCBkZWNpZGUgaWYgc2hvdWxkIHJvdXRlLgogICAgaWYgKHJvdXRlVG8gfHwgdGhpcy5ydW5faW5faW5pdCA9PT0gdHJ1ZSkgewogICAgICB0aGlzLmhhbmRsZXIoKTsKICAgIH0KICB9CgogIHJldHVybiB0aGlzOwp9OwoKUm91dGVyLnByb3RvdHlwZS5leHBsb2RlID0gZnVuY3Rpb24gKCkgewogIHZhciB2ID0gdGhpcy5oaXN0b3J5ID09PSB0cnVlID8gdGhpcy5nZXRQYXRoKCkgOiBkbG9jLmhhc2g7CiAgaWYgKHYuY2hhckF0KDEpID09PSAnLycpIHsgdj12LnNsaWNlKDEpIH0KICByZXR1cm4gdi5zbGljZSgxLCB2Lmxlbmd0aCkuc3BsaXQoIi8iKTsKfTsKClJvdXRlci5wcm90b3R5cGUuc2V0Um91dGUgPSBmdW5jdGlvbiAoaSwgdiwgdmFsKSB7CiAgdmFyIHVybCA9IHRoaXMuZXhwbG9kZSgpOwoKICBpZiAodHlwZW9mIGkgPT09ICdudW1iZXInICYmIHR5cGVvZiB2ID09PSAnc3RyaW5nJykgewogICAgdXJsW2ldID0gdjsKICB9CiAgZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgIHVybC5zcGxpY2UoaSwgdiwgcyk7CiAgfQogIGVsc2UgewogICAgdXJsID0gW2ldOwogIH0KCiAgbGlzdGVuZXIuc2V0SGFzaCh1cmwuam9pbignLycpKTsKICByZXR1cm4gdXJsOwp9OwoKLy8KLy8gIyMjIGZ1bmN0aW9uIGluc2VydEV4KG1ldGhvZCwgcGF0aCwgcm91dGUsIHBhcmVudCkKLy8gIyMjIyBAbWV0aG9kIHtzdHJpbmd9IE1ldGhvZCB0byBpbnNlcnQgdGhlIHNwZWNpZmljIGByb3V0ZWAuCi8vICMjIyMgQHBhdGgge0FycmF5fSBQYXJzZWQgcGF0aCB0byBpbnNlcnQgdGhlIGByb3V0ZWAgYXQuCi8vICMjIyMgQHJvdXRlIHtBcnJheXxmdW5jdGlvbn0gUm91dGUgaGFuZGxlcnMgdG8gaW5zZXJ0LgovLyAjIyMjIEBwYXJlbnQge09iamVjdH0gKipPcHRpb25hbCoqIFBhcmVudCAicm91dGVzIiB0byBpbnNlcnQgaW50by4KLy8gaW5zZXJ0IGEgY2FsbGJhY2sgdGhhdCB3aWxsIG9ubHkgb2NjdXIgb25jZSBwZXIgdGhlIG1hdGNoZWQgcm91dGUuCi8vClJvdXRlci5wcm90b3R5cGUuaW5zZXJ0RXggPSBmdW5jdGlvbihtZXRob2QsIHBhdGgsIHJvdXRlLCBwYXJlbnQpIHsKICBpZiAobWV0aG9kID09PSAib25jZSIpIHsKICAgIG1ldGhvZCA9ICJvbiI7CiAgICByb3V0ZSA9IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHZhciBvbmNlID0gZmFsc2U7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAob25jZSkgcmV0dXJuOwogICAgICAgIG9uY2UgPSB0cnVlOwogICAgICAgIHJldHVybiByb3V0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfShyb3V0ZSk7CiAgfQogIHJldHVybiB0aGlzLl9pbnNlcnQobWV0aG9kLCBwYXRoLCByb3V0ZSwgcGFyZW50KTsKfTsKClJvdXRlci5wcm90b3R5cGUuZ2V0Um91dGUgPSBmdW5jdGlvbiAodikgewogIHZhciByZXQgPSB2OwoKICBpZiAodHlwZW9mIHYgPT09ICJudW1iZXIiKSB7CiAgICByZXQgPSB0aGlzLmV4cGxvZGUoKVt2XTsKICB9CiAgZWxzZSBpZiAodHlwZW9mIHYgPT09ICJzdHJpbmciKXsKICAgIHZhciBoID0gdGhpcy5leHBsb2RlKCk7CiAgICByZXQgPSBoLmluZGV4T2Yodik7CiAgfQogIGVsc2UgewogICAgcmV0ID0gdGhpcy5leHBsb2RlKCk7CiAgfQoKICByZXR1cm4gcmV0Owp9OwoKUm91dGVyLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogIGxpc3RlbmVyLmRlc3Ryb3kodGhpcy5oYW5kbGVyKTsKICByZXR1cm4gdGhpczsKfTsKClJvdXRlci5wcm90b3R5cGUuZ2V0UGF0aCA9IGZ1bmN0aW9uICgpIHsKICB2YXIgcGF0aCA9IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZTsKICBpZiAocGF0aC5zdWJzdHIoMCwgMSkgIT09ICcvJykgewogICAgcGF0aCA9ICcvJyArIHBhdGg7CiAgfQogIHJldHVybiBwYXRoOwp9OwpmdW5jdGlvbiBfZXZlcnkoYXJyLCBpdGVyYXRvcikgewogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSArPSAxKSB7CiAgICBpZiAoaXRlcmF0b3IoYXJyW2ldLCBpLCBhcnIpID09PSBmYWxzZSkgewogICAgICByZXR1cm47CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBfZmxhdHRlbihhcnIpIHsKICB2YXIgZmxhdCA9IFtdOwogIGZvciAodmFyIGkgPSAwLCBuID0gYXJyLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgZmxhdCA9IGZsYXQuY29uY2F0KGFycltpXSk7CiAgfQogIHJldHVybiBmbGF0Owp9CgpmdW5jdGlvbiBfYXN5bmNFdmVyeVNlcmllcyhhcnIsIGl0ZXJhdG9yLCBjYWxsYmFjaykgewogIGlmICghYXJyLmxlbmd0aCkgewogICAgcmV0dXJuIGNhbGxiYWNrKCk7CiAgfQogIHZhciBjb21wbGV0ZWQgPSAwOwogIChmdW5jdGlvbiBpdGVyYXRlKCkgewogICAgaXRlcmF0b3IoYXJyW2NvbXBsZXRlZF0sIGZ1bmN0aW9uKGVycikgewogICAgICBpZiAoZXJyIHx8IGVyciA9PT0gZmFsc2UpIHsKICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb21wbGV0ZWQgKz0gMTsKICAgICAgICBpZiAoY29tcGxldGVkID09PSBhcnIubGVuZ3RoKSB7CiAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpdGVyYXRlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9KSgpOwp9CgpmdW5jdGlvbiBwYXJhbWlmeVN0cmluZyhzdHIsIHBhcmFtcywgbW9kKSB7CiAgbW9kID0gc3RyOwogIGZvciAodmFyIHBhcmFtIGluIHBhcmFtcykgewogICAgaWYgKHBhcmFtcy5oYXNPd25Qcm9wZXJ0eShwYXJhbSkpIHsKICAgICAgbW9kID0gcGFyYW1zW3BhcmFtXShzdHIpOwogICAgICBpZiAobW9kICE9PSBzdHIpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gbW9kID09PSBzdHIgPyAiKFsuX2EtekEtWjAtOS1dKykiIDogbW9kOwp9CgpmdW5jdGlvbiByZWdpZnlTdHJpbmcoc3RyLCBwYXJhbXMpIHsKICB2YXIgbWF0Y2hlcywgbGFzdCA9IDAsIG91dCA9ICIiOwogIHdoaWxlIChtYXRjaGVzID0gc3RyLnN1YnN0cihsYXN0KS5tYXRjaCgvW15cd1xkXC0gJUAmXSpcKlteXHdcZFwtICVAJl0qLykpIHsKICAgIGxhc3QgPSBtYXRjaGVzLmluZGV4ICsgbWF0Y2hlc1swXS5sZW5ndGg7CiAgICBtYXRjaGVzWzBdID0gbWF0Y2hlc1swXS5yZXBsYWNlKC9eXCovLCAiKFtfLigpIVxcICVAJmEtekEtWjAtOS1dKykiKTsKICAgIG91dCArPSBzdHIuc3Vic3RyKDAsIG1hdGNoZXMuaW5kZXgpICsgbWF0Y2hlc1swXTsKICB9CiAgc3RyID0gb3V0ICs9IHN0ci5zdWJzdHIobGFzdCk7CiAgdmFyIGNhcHR1cmVzID0gc3RyLm1hdGNoKC86KFteXC9dKykvaWcpLCBsZW5ndGg7CiAgaWYgKGNhcHR1cmVzKSB7CiAgICBsZW5ndGggPSBjYXB0dXJlcy5sZW5ndGg7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKGNhcHR1cmVzW2ldLCBwYXJhbWlmeVN0cmluZyhjYXB0dXJlc1tpXSwgcGFyYW1zKSk7CiAgICB9CiAgfQogIHJldHVybiBzdHI7Cn0KCmZ1bmN0aW9uIHRlcm1pbmF0b3Iocm91dGVzLCBkZWxpbWl0ZXIsIHN0YXJ0LCBzdG9wKSB7CiAgdmFyIGxhc3QgPSAwLCBsZWZ0ID0gMCwgcmlnaHQgPSAwLCBzdGFydCA9IChzdGFydCB8fCAiKCIpLnRvU3RyaW5nKCksIHN0b3AgPSAoc3RvcCB8fCAiKSIpLnRvU3RyaW5nKCksIGk7CiAgZm9yIChpID0gMDsgaSA8IHJvdXRlcy5sZW5ndGg7IGkrKykgewogICAgdmFyIGNodW5rID0gcm91dGVzW2ldOwogICAgaWYgKGNodW5rLmluZGV4T2Yoc3RhcnQsIGxhc3QpID4gY2h1bmsuaW5kZXhPZihzdG9wLCBsYXN0KSB8fCB+Y2h1bmsuaW5kZXhPZihzdGFydCwgbGFzdCkgJiYgIX5jaHVuay5pbmRleE9mKHN0b3AsIGxhc3QpIHx8ICF+Y2h1bmsuaW5kZXhPZihzdGFydCwgbGFzdCkgJiYgfmNodW5rLmluZGV4T2Yoc3RvcCwgbGFzdCkpIHsKICAgICAgbGVmdCA9IGNodW5rLmluZGV4T2Yoc3RhcnQsIGxhc3QpOwogICAgICByaWdodCA9IGNodW5rLmluZGV4T2Yoc3RvcCwgbGFzdCk7CiAgICAgIGlmICh+bGVmdCAmJiAhfnJpZ2h0IHx8ICF+bGVmdCAmJiB+cmlnaHQpIHsKICAgICAgICB2YXIgdG1wID0gcm91dGVzLnNsaWNlKDAsIChpIHx8IDEpICsgMSkuam9pbihkZWxpbWl0ZXIpOwogICAgICAgIHJvdXRlcyA9IFsgdG1wIF0uY29uY2F0KHJvdXRlcy5zbGljZSgoaSB8fCAxKSArIDEpKTsKICAgICAgfQogICAgICBsYXN0ID0gKHJpZ2h0ID4gbGVmdCA/IHJpZ2h0IDogbGVmdCkgKyAxOwogICAgICBpID0gMDsKICAgIH0gZWxzZSB7CiAgICAgIGxhc3QgPSAwOwogICAgfQogIH0KICByZXR1cm4gcm91dGVzOwp9CgpSb3V0ZXIucHJvdG90eXBlLmNvbmZpZ3VyZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubWV0aG9kcy5sZW5ndGg7IGkrKykgewogICAgdGhpcy5fbWV0aG9kc1t0aGlzLm1ldGhvZHNbaV1dID0gdHJ1ZTsKICB9CiAgdGhpcy5yZWN1cnNlID0gb3B0aW9ucy5yZWN1cnNlIHx8IHRoaXMucmVjdXJzZSB8fCBmYWxzZTsKICB0aGlzLmFzeW5jID0gb3B0aW9ucy5hc3luYyB8fCBmYWxzZTsKICB0aGlzLmRlbGltaXRlciA9IG9wdGlvbnMuZGVsaW1pdGVyIHx8ICIvIjsKICB0aGlzLnN0cmljdCA9IHR5cGVvZiBvcHRpb25zLnN0cmljdCA9PT0gInVuZGVmaW5lZCIgPyB0cnVlIDogb3B0aW9ucy5zdHJpY3Q7CiAgdGhpcy5ub3Rmb3VuZCA9IG9wdGlvbnMubm90Zm91bmQ7CiAgdGhpcy5yZXNvdXJjZSA9IG9wdGlvbnMucmVzb3VyY2U7CiAgdGhpcy5oaXN0b3J5ID0gb3B0aW9ucy5odG1sNWhpc3RvcnkgJiYgdGhpcy5oaXN0b3J5U3VwcG9ydCB8fCBmYWxzZTsKICB0aGlzLnJ1bl9pbl9pbml0ID0gdGhpcy5oaXN0b3J5ID09PSB0cnVlICYmIG9wdGlvbnMucnVuX2hhbmRsZXJfaW5faW5pdCAhPT0gZmFsc2U7CiAgdGhpcy5ldmVyeSA9IHsKICAgIGFmdGVyOiBvcHRpb25zLmFmdGVyIHx8IG51bGwsCiAgICBiZWZvcmU6IG9wdGlvbnMuYmVmb3JlIHx8IG51bGwsCiAgICBvbjogb3B0aW9ucy5vbiB8fCBudWxsCiAgfTsKICByZXR1cm4gdGhpczsKfTsKClJvdXRlci5wcm90b3R5cGUucGFyYW0gPSBmdW5jdGlvbih0b2tlbiwgbWF0Y2hlcikgewogIGlmICh0b2tlblswXSAhPT0gIjoiKSB7CiAgICB0b2tlbiA9ICI6IiArIHRva2VuOwogIH0KICB2YXIgY29tcGlsZWQgPSBuZXcgUmVnRXhwKHRva2VuLCAiZyIpOwogIHRoaXMucGFyYW1zW3Rva2VuXSA9IGZ1bmN0aW9uKHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKGNvbXBpbGVkLCBtYXRjaGVyLnNvdXJjZSB8fCBtYXRjaGVyKTsKICB9Owp9OwoKUm91dGVyLnByb3RvdHlwZS5vbiA9IFJvdXRlci5wcm90b3R5cGUucm91dGUgPSBmdW5jdGlvbihtZXRob2QsIHBhdGgsIHJvdXRlKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIGlmICghcm91dGUgJiYgdHlwZW9mIHBhdGggPT0gImZ1bmN0aW9uIikgewogICAgcm91dGUgPSBwYXRoOwogICAgcGF0aCA9IG1ldGhvZDsKICAgIG1ldGhvZCA9ICJvbiI7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KHBhdGgpKSB7CiAgICByZXR1cm4gcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKHApIHsKICAgICAgc2VsZi5vbihtZXRob2QsIHAsIHJvdXRlKTsKICAgIH0pOwogIH0KICBpZiAocGF0aC5zb3VyY2UpIHsKICAgIHBhdGggPSBwYXRoLnNvdXJjZS5yZXBsYWNlKC9cXFwvL2lnLCAiLyIpOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheShtZXRob2QpKSB7CiAgICByZXR1cm4gbWV0aG9kLmZvckVhY2goZnVuY3Rpb24obSkgewogICAgICBzZWxmLm9uKG0udG9Mb3dlckNhc2UoKSwgcGF0aCwgcm91dGUpOwogICAgfSk7CiAgfQogIHBhdGggPSBwYXRoLnNwbGl0KG5ldyBSZWdFeHAodGhpcy5kZWxpbWl0ZXIpKTsKICBwYXRoID0gdGVybWluYXRvcihwYXRoLCB0aGlzLmRlbGltaXRlcik7CiAgdGhpcy5pbnNlcnQobWV0aG9kLCB0aGlzLnNjb3BlLmNvbmNhdChwYXRoKSwgcm91dGUpOwp9OwoKUm91dGVyLnByb3RvdHlwZS5kaXNwYXRjaCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGF0aCwgY2FsbGJhY2spIHsKICB2YXIgc2VsZiA9IHRoaXMsIGZucyA9IHRoaXMudHJhdmVyc2UobWV0aG9kLCBwYXRoLCB0aGlzLnJvdXRlcywgIiIpLCBpbnZva2VkID0gdGhpcy5faW52b2tlZCwgYWZ0ZXI7CiAgdGhpcy5faW52b2tlZCA9IHRydWU7CiAgaWYgKCFmbnMgfHwgZm5zLmxlbmd0aCA9PT0gMCkgewogICAgdGhpcy5sYXN0ID0gW107CiAgICBpZiAodHlwZW9mIHRoaXMubm90Zm91bmQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhpcy5pbnZva2UoWyB0aGlzLm5vdGZvdW5kIF0sIHsKICAgICAgICBtZXRob2Q6IG1ldGhvZCwKICAgICAgICBwYXRoOiBwYXRoCiAgICAgIH0sIGNhbGxiYWNrKTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKHRoaXMucmVjdXJzZSA9PT0gImZvcndhcmQiKSB7CiAgICBmbnMgPSBmbnMucmV2ZXJzZSgpOwogIH0KICBmdW5jdGlvbiB1cGRhdGVBbmRJbnZva2UoKSB7CiAgICBzZWxmLmxhc3QgPSBmbnMuYWZ0ZXI7CiAgICBzZWxmLmludm9rZShzZWxmLnJ1bmxpc3QoZm5zKSwgc2VsZiwgY2FsbGJhY2spOwogIH0KICBhZnRlciA9IHRoaXMuZXZlcnkgJiYgdGhpcy5ldmVyeS5hZnRlciA/IFsgdGhpcy5ldmVyeS5hZnRlciBdLmNvbmNhdCh0aGlzLmxhc3QpIDogWyB0aGlzLmxhc3QgXTsKICBpZiAoYWZ0ZXIgJiYgYWZ0ZXIubGVuZ3RoID4gMCAmJiBpbnZva2VkKSB7CiAgICBpZiAodGhpcy5hc3luYykgewogICAgICB0aGlzLmludm9rZShhZnRlciwgdGhpcywgdXBkYXRlQW5kSW52b2tlKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuaW52b2tlKGFmdGVyLCB0aGlzKTsKICAgICAgdXBkYXRlQW5kSW52b2tlKCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgdXBkYXRlQW5kSW52b2tlKCk7CiAgcmV0dXJuIHRydWU7Cn07CgpSb3V0ZXIucHJvdG90eXBlLmludm9rZSA9IGZ1bmN0aW9uKGZucywgdGhpc0FyZywgY2FsbGJhY2spIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgaWYgKHRoaXMuYXN5bmMpIHsKICAgIF9hc3luY0V2ZXJ5U2VyaWVzKGZucywgZnVuY3Rpb24gYXBwbHkoZm4sIG5leHQpIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZm4pKSB7CiAgICAgICAgcmV0dXJuIF9hc3luY0V2ZXJ5U2VyaWVzKGZuLCBhcHBseSwgbmV4dCk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZuID09ICJmdW5jdGlvbiIpIHsKICAgICAgICBmbi5hcHBseSh0aGlzQXJnLCBmbnMuY2FwdHVyZXMuY29uY2F0KG5leHQpKTsKICAgICAgfQogICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXNBcmcsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH0pOwogIH0gZWxzZSB7CiAgICBfZXZlcnkoZm5zLCBmdW5jdGlvbiBhcHBseShmbikgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShmbikpIHsKICAgICAgICByZXR1cm4gX2V2ZXJ5KGZuLCBhcHBseSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXNBcmcsIGZucy5jYXB0dXJlcyB8fCBbXSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZuID09PSAic3RyaW5nIiAmJiBzZWxmLnJlc291cmNlKSB7CiAgICAgICAgc2VsZi5yZXNvdXJjZVtmbl0uYXBwbHkodGhpc0FyZywgZm5zLmNhcHR1cmVzIHx8IFtdKTsKICAgICAgfQogICAgfSk7CiAgfQp9OwoKUm91dGVyLnByb3RvdHlwZS50cmF2ZXJzZSA9IGZ1bmN0aW9uKG1ldGhvZCwgcGF0aCwgcm91dGVzLCByZWdleHAsIGZpbHRlcikgewogIHZhciBmbnMgPSBbXSwgY3VycmVudCwgZXhhY3QsIG1hdGNoLCBuZXh0LCB0aGF0OwogIGZ1bmN0aW9uIGZpbHRlclJvdXRlcyhyb3V0ZXMpIHsKICAgIGlmICghZmlsdGVyKSB7CiAgICAgIHJldHVybiByb3V0ZXM7CiAgICB9CiAgICBmdW5jdGlvbiBkZWVwQ29weShzb3VyY2UpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvdXJjZS5sZW5ndGg7IGkrKykgewogICAgICAgIHJlc3VsdFtpXSA9IEFycmF5LmlzQXJyYXkoc291cmNlW2ldKSA/IGRlZXBDb3B5KHNvdXJjZVtpXSkgOiBzb3VyY2VbaV07CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIGFwcGx5RmlsdGVyKGZucykgewogICAgICBmb3IgKHZhciBpID0gZm5zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZm5zW2ldKSkgewogICAgICAgICAgYXBwbHlGaWx0ZXIoZm5zW2ldKTsKICAgICAgICAgIGlmIChmbnNbaV0ubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGZucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghZmlsdGVyKGZuc1tpXSkpIHsKICAgICAgICAgICAgZm5zLnNwbGljZShpLCAxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHZhciBuZXdSb3V0ZXMgPSBkZWVwQ29weShyb3V0ZXMpOwogICAgbmV3Um91dGVzLm1hdGNoZWQgPSByb3V0ZXMubWF0Y2hlZDsKICAgIG5ld1JvdXRlcy5jYXB0dXJlcyA9IHJvdXRlcy5jYXB0dXJlczsKICAgIG5ld1JvdXRlcy5hZnRlciA9IHJvdXRlcy5hZnRlci5maWx0ZXIoZmlsdGVyKTsKICAgIGFwcGx5RmlsdGVyKG5ld1JvdXRlcyk7CiAgICByZXR1cm4gbmV3Um91dGVzOwogIH0KICBpZiAocGF0aCA9PT0gdGhpcy5kZWxpbWl0ZXIgJiYgcm91dGVzW21ldGhvZF0pIHsKICAgIG5leHQgPSBbIFsgcm91dGVzLmJlZm9yZSwgcm91dGVzW21ldGhvZF0gXS5maWx0ZXIoQm9vbGVhbikgXTsKICAgIG5leHQuYWZ0ZXIgPSBbIHJvdXRlcy5hZnRlciBdLmZpbHRlcihCb29sZWFuKTsKICAgIG5leHQubWF0Y2hlZCA9IHRydWU7CiAgICBuZXh0LmNhcHR1cmVzID0gW107CiAgICByZXR1cm4gZmlsdGVyUm91dGVzKG5leHQpOwogIH0KICBmb3IgKHZhciByIGluIHJvdXRlcykgewogICAgaWYgKHJvdXRlcy5oYXNPd25Qcm9wZXJ0eShyKSAmJiAoIXRoaXMuX21ldGhvZHNbcl0gfHwgdGhpcy5fbWV0aG9kc1tyXSAmJiB0eXBlb2Ygcm91dGVzW3JdID09PSAib2JqZWN0IiAmJiAhQXJyYXkuaXNBcnJheShyb3V0ZXNbcl0pKSkgewogICAgICBjdXJyZW50ID0gZXhhY3QgPSByZWdleHAgKyB0aGlzLmRlbGltaXRlciArIHI7CiAgICAgIGlmICghdGhpcy5zdHJpY3QpIHsKICAgICAgICBleGFjdCArPSAiWyIgKyB0aGlzLmRlbGltaXRlciArICJdPyI7CiAgICAgIH0KICAgICAgbWF0Y2ggPSBwYXRoLm1hdGNoKG5ldyBSZWdFeHAoIl4iICsgZXhhY3QpKTsKICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmIChtYXRjaFswXSAmJiBtYXRjaFswXSA9PSBwYXRoICYmIHJvdXRlc1tyXVttZXRob2RdKSB7CiAgICAgICAgbmV4dCA9IFsgWyByb3V0ZXNbcl0uYmVmb3JlLCByb3V0ZXNbcl1bbWV0aG9kXSBdLmZpbHRlcihCb29sZWFuKSBdOwogICAgICAgIG5leHQuYWZ0ZXIgPSBbIHJvdXRlc1tyXS5hZnRlciBdLmZpbHRlcihCb29sZWFuKTsKICAgICAgICBuZXh0Lm1hdGNoZWQgPSB0cnVlOwogICAgICAgIG5leHQuY2FwdHVyZXMgPSBtYXRjaC5zbGljZSgxKTsKICAgICAgICBpZiAodGhpcy5yZWN1cnNlICYmIHJvdXRlcyA9PT0gdGhpcy5yb3V0ZXMpIHsKICAgICAgICAgIG5leHQucHVzaChbIHJvdXRlcy5iZWZvcmUsIHJvdXRlcy5vbiBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICBuZXh0LmFmdGVyID0gbmV4dC5hZnRlci5jb25jYXQoWyByb3V0ZXMuYWZ0ZXIgXS5maWx0ZXIoQm9vbGVhbikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmlsdGVyUm91dGVzKG5leHQpOwogICAgICB9CiAgICAgIG5leHQgPSB0aGlzLnRyYXZlcnNlKG1ldGhvZCwgcGF0aCwgcm91dGVzW3JdLCBjdXJyZW50KTsKICAgICAgaWYgKG5leHQubWF0Y2hlZCkgewogICAgICAgIGlmIChuZXh0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgIGZucyA9IGZucy5jb25jYXQobmV4dCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnJlY3Vyc2UpIHsKICAgICAgICAgIGZucy5wdXNoKFsgcm91dGVzW3JdLmJlZm9yZSwgcm91dGVzW3JdLm9uIF0uZmlsdGVyKEJvb2xlYW4pKTsKICAgICAgICAgIG5leHQuYWZ0ZXIgPSBuZXh0LmFmdGVyLmNvbmNhdChbIHJvdXRlc1tyXS5hZnRlciBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICBpZiAocm91dGVzID09PSB0aGlzLnJvdXRlcykgewogICAgICAgICAgICBmbnMucHVzaChbIHJvdXRlc1siYmVmb3JlIl0sIHJvdXRlc1sib24iXSBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICAgIG5leHQuYWZ0ZXIgPSBuZXh0LmFmdGVyLmNvbmNhdChbIHJvdXRlc1siYWZ0ZXIiXSBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZucy5tYXRjaGVkID0gdHJ1ZTsKICAgICAgICBmbnMuY2FwdHVyZXMgPSBuZXh0LmNhcHR1cmVzOwogICAgICAgIGZucy5hZnRlciA9IG5leHQuYWZ0ZXI7CiAgICAgICAgcmV0dXJuIGZpbHRlclJvdXRlcyhmbnMpOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfTsKClJvdXRlci5wcm90b3R5cGUuaW5zZXJ0ID0gZnVuY3Rpb24obWV0aG9kLCBwYXRoLCByb3V0ZSwgcGFyZW50KSB7CiAgdmFyIG1ldGhvZFR5cGUsIHBhcmVudFR5cGUsIGlzQXJyYXksIG5lc3RlZCwgcGFydDsKICBwYXRoID0gcGF0aC5maWx0ZXIoZnVuY3Rpb24ocCkgewogICAgcmV0dXJuIHAgJiYgcC5sZW5ndGggPiAwOwogIH0pOwogIHBhcmVudCA9IHBhcmVudCB8fCB0aGlzLnJvdXRlczsKICBwYXJ0ID0gcGF0aC5zaGlmdCgpOwogIGlmICgvXDp8XCovLnRlc3QocGFydCkgJiYgIS9cXGR8XFx3Ly50ZXN0KHBhcnQpKSB7CiAgICBwYXJ0ID0gcmVnaWZ5U3RyaW5nKHBhcnQsIHRoaXMucGFyYW1zKTsKICB9CiAgaWYgKHBhdGgubGVuZ3RoID4gMCkgewogICAgcGFyZW50W3BhcnRdID0gcGFyZW50W3BhcnRdIHx8IHt9OwogICAgcmV0dXJuIHRoaXMuaW5zZXJ0KG1ldGhvZCwgcGF0aCwgcm91dGUsIHBhcmVudFtwYXJ0XSk7CiAgfQogIGlmICghcGFydCAmJiAhcGF0aC5sZW5ndGggJiYgcGFyZW50ID09PSB0aGlzLnJvdXRlcykgewogICAgbWV0aG9kVHlwZSA9IHR5cGVvZiBwYXJlbnRbbWV0aG9kXTsKICAgIHN3aXRjaCAobWV0aG9kVHlwZSkgewogICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgcGFyZW50W21ldGhvZF0gPSBbIHBhcmVudFttZXRob2RdLCByb3V0ZSBdOwogICAgICByZXR1cm47CiAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgcGFyZW50W21ldGhvZF0ucHVzaChyb3V0ZSk7CiAgICAgIHJldHVybjsKICAgICBjYXNlICJ1bmRlZmluZWQiOgogICAgICBwYXJlbnRbbWV0aG9kXSA9IHJvdXRlOwogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm47CiAgfQogIHBhcmVudFR5cGUgPSB0eXBlb2YgcGFyZW50W3BhcnRdOwogIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5KHBhcmVudFtwYXJ0XSk7CiAgaWYgKHBhcmVudFtwYXJ0XSAmJiAhaXNBcnJheSAmJiBwYXJlbnRUeXBlID09ICJvYmplY3QiKSB7CiAgICBtZXRob2RUeXBlID0gdHlwZW9mIHBhcmVudFtwYXJ0XVttZXRob2RdOwogICAgc3dpdGNoIChtZXRob2RUeXBlKSB7CiAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICBwYXJlbnRbcGFydF1bbWV0aG9kXSA9IFsgcGFyZW50W3BhcnRdW21ldGhvZF0sIHJvdXRlIF07CiAgICAgIHJldHVybjsKICAgICBjYXNlICJvYmplY3QiOgogICAgICBwYXJlbnRbcGFydF1bbWV0aG9kXS5wdXNoKHJvdXRlKTsKICAgICAgcmV0dXJuOwogICAgIGNhc2UgInVuZGVmaW5lZCI6CiAgICAgIHBhcmVudFtwYXJ0XVttZXRob2RdID0gcm91dGU7CiAgICAgIHJldHVybjsKICAgIH0KICB9IGVsc2UgaWYgKHBhcmVudFR5cGUgPT0gInVuZGVmaW5lZCIpIHsKICAgIG5lc3RlZCA9IHt9OwogICAgbmVzdGVkW21ldGhvZF0gPSByb3V0ZTsKICAgIHBhcmVudFtwYXJ0XSA9IG5lc3RlZDsKICAgIHJldHVybjsKICB9CiAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHJvdXRlIGNvbnRleHQ6ICIgKyBwYXJlbnRUeXBlKTsKfTsKCgoKUm91dGVyLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbihtZXRob2RzKSB7CiAgdmFyIHNlbGYgPSB0aGlzLCBsZW4gPSBtZXRob2RzLmxlbmd0aCwgaTsKICBmdW5jdGlvbiBleHRlbmQobWV0aG9kKSB7CiAgICBzZWxmLl9tZXRob2RzW21ldGhvZF0gPSB0cnVlOwogICAgc2VsZlttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBleHRyYSA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyBbIG1ldGhvZCwgIiIgXSA6IFsgbWV0aG9kIF07CiAgICAgIHNlbGYub24uYXBwbHkoc2VsZiwgZXh0cmEuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgIH07CiAgfQogIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgZXh0ZW5kKG1ldGhvZHNbaV0pOwogIH0KfTsKClJvdXRlci5wcm90b3R5cGUucnVubGlzdCA9IGZ1bmN0aW9uKGZucykgewogIHZhciBydW5saXN0ID0gdGhpcy5ldmVyeSAmJiB0aGlzLmV2ZXJ5LmJlZm9yZSA/IFsgdGhpcy5ldmVyeS5iZWZvcmUgXS5jb25jYXQoX2ZsYXR0ZW4oZm5zKSkgOiBfZmxhdHRlbihmbnMpOwogIGlmICh0aGlzLmV2ZXJ5ICYmIHRoaXMuZXZlcnkub24pIHsKICAgIHJ1bmxpc3QucHVzaCh0aGlzLmV2ZXJ5Lm9uKTsKICB9CiAgcnVubGlzdC5jYXB0dXJlcyA9IGZucy5jYXB0dXJlczsKICBydW5saXN0LnNvdXJjZSA9IGZucy5zb3VyY2U7CiAgcmV0dXJuIHJ1bmxpc3Q7Cn07CgpSb3V0ZXIucHJvdG90eXBlLm1vdW50ID0gZnVuY3Rpb24ocm91dGVzLCBwYXRoKSB7CiAgaWYgKCFyb3V0ZXMgfHwgdHlwZW9mIHJvdXRlcyAhPT0gIm9iamVjdCIgfHwgQXJyYXkuaXNBcnJheShyb3V0ZXMpKSB7CiAgICByZXR1cm47CiAgfQogIHZhciBzZWxmID0gdGhpczsKICBwYXRoID0gcGF0aCB8fCBbXTsKICBpZiAoIUFycmF5LmlzQXJyYXkocGF0aCkpIHsKICAgIHBhdGggPSBwYXRoLnNwbGl0KHNlbGYuZGVsaW1pdGVyKTsKICB9CiAgZnVuY3Rpb24gaW5zZXJ0T3JNb3VudChyb3V0ZSwgbG9jYWwpIHsKICAgIHZhciByZW5hbWUgPSByb3V0ZSwgcGFydHMgPSByb3V0ZS5zcGxpdChzZWxmLmRlbGltaXRlciksIHJvdXRlVHlwZSA9IHR5cGVvZiByb3V0ZXNbcm91dGVdLCBpc1JvdXRlID0gcGFydHNbMF0gPT09ICIiIHx8ICFzZWxmLl9tZXRob2RzW3BhcnRzWzBdXSwgZXZlbnQgPSBpc1JvdXRlID8gIm9uIiA6IHJlbmFtZTsKICAgIGlmIChpc1JvdXRlKSB7CiAgICAgIHJlbmFtZSA9IHJlbmFtZS5zbGljZSgocmVuYW1lLm1hdGNoKG5ldyBSZWdFeHAoc2VsZi5kZWxpbWl0ZXIpKSB8fCBbICIiIF0pWzBdLmxlbmd0aCk7CiAgICAgIHBhcnRzLnNoaWZ0KCk7CiAgICB9CiAgICBpZiAoaXNSb3V0ZSAmJiByb3V0ZVR5cGUgPT09ICJvYmplY3QiICYmICFBcnJheS5pc0FycmF5KHJvdXRlc1tyb3V0ZV0pKSB7CiAgICAgIGxvY2FsID0gbG9jYWwuY29uY2F0KHBhcnRzKTsKICAgICAgc2VsZi5tb3VudChyb3V0ZXNbcm91dGVdLCBsb2NhbCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpc1JvdXRlKSB7CiAgICAgIGxvY2FsID0gbG9jYWwuY29uY2F0KHJlbmFtZS5zcGxpdChzZWxmLmRlbGltaXRlcikpOwogICAgICBsb2NhbCA9IHRlcm1pbmF0b3IobG9jYWwsIHNlbGYuZGVsaW1pdGVyKTsKICAgIH0KICAgIHNlbGYuaW5zZXJ0KGV2ZW50LCBsb2NhbCwgcm91dGVzW3JvdXRlXSk7CiAgfQogIGZvciAodmFyIHJvdXRlIGluIHJvdXRlcykgewogICAgaWYgKHJvdXRlcy5oYXNPd25Qcm9wZXJ0eShyb3V0ZSkpIHsKICAgICAgaW5zZXJ0T3JNb3VudChyb3V0ZSwgcGF0aC5zbGljZSgwKSk7CiAgICB9CiAgfQp9OwoKCgp9KHR5cGVvZiBleHBvcnRzID09PSAib2JqZWN0IiA/IGV4cG9ydHMgOiB3aW5kb3cpKTsKZGVmaW5lKCJmbGF0aXJvbi9kaXJlY3RvciIsIChmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciByZXQsIGZuOwogICAgICAgIHJldHVybiByZXQgfHwgZ2xvYmFsLlJvdXRlcjsKICAgIH07Cn0odGhpcykpKTsKCmRlZmluZSgndGhydXN0L3NwYS9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QnLCAndGhydXN0L2xvZycsICdoYXMnLCAnZmxhdGlyb24vZGlyZWN0b3InLCAndGhydXN0L2luc3RhbmNlJywgJy4vY29uZmlnJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX3RocnVzdF9fLCBfX2xvZ19fLCBfX2hhc19fLCBfX2ZsYXRpcm9uUm91dGVyX18sIF9faW5zdGFuY2VfXywgX19jb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9zcGEvc3BhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciB0aHJ1c3QgPSBfX3RocnVzdF9fOwoKICAgIHZhciBUaHJ1c3QgPSB0aHJ1c3QuVGhydXN0OwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGZsYXRpcm9uUm91dGVyID0gX19mbGF0aXJvblJvdXRlcl9fOwoKICAgIHZhciBSb3V0ZXIgPSBmbGF0aXJvblJvdXRlci5Sb3V0ZXIgfHwgZmxhdGlyb25Sb3V0ZXI7CiAgICAKICAgIHZhciBpbnN0YW5jZSA9IF9faW5zdGFuY2VfXzsKCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdTaW5nbGVQYWdlQXBwbGljYXRpb24nOwogICAgY29uZmlnOwogICAgdmFyIGVhY2ggPSBfLmVhY2gsIGlzU3RyaW5nID0gXy5pc1N0cmluZywgaXNBcnJheSA9IF8uaXNBcnJheSwgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBpc1JlZ0V4cCA9IF8uaXNSZWdFeHAsIGV4dGVuZCA9IF8uZXh0ZW5kLCBvbmNlID0gXy5vbmNlLCB3aGVuID0gdXRpbC53aGVuLCBiaW5kID0gXy5iaW5kLCBpbnZva2UgPSBfLmludm9rZSwgcGx1Y2sgPSBfLnBsdWNrLCBtYXAgPSBfLm1hcCwgZGVmZXIgPSBfLmRlZmVyLCByZWR1Y2UgPSBfLnJlZHVjZSwgbWVtb2l6ZSA9IF8ubWVtb2l6ZSwgdG9BcnJheSA9IF8udG9BcnJheSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIFNUQVJUID0gJ3N0YXJ0JzsKICAgIHZhciBleHRyYWN0UGFyYW1zID0gZnVuY3Rpb24gKHJvdXRlKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IFtdLCBpbmRleCA9IHJvdXRlLmluZGV4T2YoJzonKSwgc2xhc2hJbmRleDsKICAgICAgICB3aGlsZShpbmRleCA+IC0xKSB7CiAgICAgICAgICAgIHNsYXNoSW5kZXggPSByb3V0ZS5pbmRleE9mKCcvJywgaW5kZXgpOwogICAgICAgICAgICBpZihzbGFzaEluZGV4ID09PSAtMSkgewogICAgICAgICAgICAgICAgc2xhc2hJbmRleCA9IHJvdXRlLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChyb3V0ZS5zdWJzdHJpbmcoaW5kZXgsIHNsYXNoSW5kZXggLSBpbmRleCArIDEpKTsKICAgICAgICAgICAgcm91dGUgPSByb3V0ZS5zdWJzdHJpbmcoc2xhc2hJbmRleCk7CiAgICAgICAgICAgIGluZGV4ID0gcm91dGUuaW5kZXhPZignOicpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFyYW1zOwogICAgfTsKICAgIHZhciBldmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoZXZlbnQsIG1lZGlhdG9yKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRmlyaW5nIHNwYSAiezB9IiB3aXRoIFt7MX1dJywgZXZlbnQsIHRvQXJyYXkoYXJndW1lbnRzKS5qb2luKCcsJykpKTsKICAgICAgICAgICAgbWVkaWF0b3IuZmlyZS5hc3luYy5hcHBseShtZWRpYXRvciwgWwogICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSk7CiAgICAgICAgfTsKICAgIH07CiAgICAvKioKICAgIAogICAgQGZvciB0aHJ1c3Quc3BhCiAgICBAY2xhc3MgdGhydXN0LnNwYS5TaW5nbGVQYWdlQXBwCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIHRocnVzdCBpbnN0YW5jZSBjb25maWd1cmF0aW9uCiAgICBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VOYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgbmFtZQogICAgQHBhcmFtIHt0aHJ1c3QubWVkaWF0b3JNZWRpYXRvcn0gbWVkaWF0b3IgVGhlIHRocnVzdCBpbnN0YW5jZSBtZWRpYXRvcgogICAgKiovCiAgICB2YXIgU2luZ2xlUGFnZUFwcGxpY2F0aW9uID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBTaW5nbGVQYWdlQXBwbGljYXRpb24oY29uZmlnLCBpbnN0YW5jZU5hbWUsIG1lZGlhdG9yKSB7CiAgICAgICAgICAgIHRoaXMuc3RhcnRpbmdNb2R1bGVQcm9taXNlID0gbnVsbDsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGF0LmJhc2VVcmwgPSBjb25maWcudXJsLnBhdGg7CiAgICAgICAgICAgIHZhciBzcGFDb25maWcgPSBjb25maWcuc3BhOwogICAgICAgICAgICB0aGF0LmZpbGVFeHRlbnNpb24gPSBzcGFDb25maWcuZmlsZUV4dGVuc2lvbjsKICAgICAgICAgICAgdmFyIHJvdXRlcyA9IHRoYXQuY29uZmlndXJlUm91dGVzKHNwYUNvbmZpZy5yb3V0ZXMpLCBwYXJhbXMgPSBzcGFDb25maWcucGFyYW1zOwogICAgICAgICAgICB2YXIgZXZlbnRGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRmlyaW5nIHNwYSAiezB9IiB3aXRoIFt7MX1dJywgZXZlbnQsIHRvQXJyYXkoYXJndW1lbnRzKS5qb2luKCcsJykpKTsKICAgICAgICAgICAgICAgICAgICBtZWRpYXRvci5maXJlLmFzeW5jLmFwcGx5KG1lZGlhdG9yLCBbCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIHJvdXRlciA9IHRoYXQucm91dGVyID0gbmV3IFJvdXRlcihyb3V0ZXMpLmNvbmZpZ3VyZSh7CiAgICAgICAgICAgICAgICByZWN1cnNlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHN0cmljdDogZmFsc2UsCiAgICAgICAgICAgICAgICBhc3luYzogZmFsc2UsCiAgICAgICAgICAgICAgICBodG1sNWhpc3Rvcnk6IHRydWUsCiAgICAgICAgICAgICAgICBub3Rmb3VuZDogZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JvdXRlL25vdGZvdW5kJyksCiAgICAgICAgICAgICAgICBiZWZvcmU6IGV2ZW50RmFjdG9yeSgndGhydXN0L3NwYS9yb3V0ZS9iZWZvcmUnKSwKICAgICAgICAgICAgICAgIG9uOiBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcm91dGUvcnVuJyksCiAgICAgICAgICAgICAgICBhZnRlcjogZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JvdXRlL2FmdGVyJykKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIF8uZWFjaChwYXJhbXMsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICByb3V0ZXIucGFyYW0oaSwgeCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvKioKICAgICAgICAgICAgU3RhcnQgdGhlIHNpbmdsZSBwYWdlIGFwcCByb3V0ZXIuCiAgICAgICAgICAgIAogICAgICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgICAgICoqLwogICAgICAgICAgICB0aGF0LnN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhhdC50aHJ1c3QgPSBpbnN0YW5jZS5nZXRJbnN0YW5jZShpbnN0YW5jZU5hbWUpOwogICAgICAgICAgICAgICAgdGhhdC5yb3V0ZXIuaW5pdCgpOwogICAgICAgICAgICAgICAgbWVkaWF0b3IuZmlyZS5hc3luYygndGhydXN0L3NwYS9zdGFydCcpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGF0Lm5hdmlnYXRlID0gdGhhdC5uYXZpZ2F0ZS5iaW5kKHRoYXQpOwogICAgICAgIH0KICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLm5hdmlnYXRlID0gLyoqCiAgICAgICAgTmF2aWdhdGVzIHRvIHRoZSBnaXZlbiB1cmwuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBuYXZpZ2F0ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBsb2NhdGlvbiBUaGUgbG9jYXRpb24gdG8gbmF2aWdhdGUgdG8uCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGxvY2F0aW9uKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdmFyIHVybCA9IHV0aWwuZml4dXBVcmwobG9jYXRpb24sIHRoYXQuYmFzZVVybCk7CiAgICAgICAgICAgIHRoYXQucm91dGVyLnNldFJvdXRlKHVybCk7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLnN0YXJ0ID0gLyoqCiAgICAgICAgU3RhcnQgdGhlIHNpbmdsZSBwYWdlIGFwcCByb3V0ZXIuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy50aHJ1c3QgPSBpbnN0YW5jZS5nZXRJbnN0YW5jZSh0aGlzLmluc3RhbmNlTmFtZSk7CiAgICAgICAgICAgIHRoaXMucm91dGVyLmluaXQoKTsKICAgICAgICAgICAgdGhpcy50aHJ1c3QubWVkaWF0b3IuZmlyZS5hc3luYygndGhydXN0L3NwYS9zdGFydCcpOwogICAgICAgIH07CiAgICAgICAgU2luZ2xlUGFnZUFwcGxpY2F0aW9uLnByb3RvdHlwZS5jb25maWd1cmVSb3V0ZXMgPSAvKioKICAgICAgICBDb25maWd1cmVzIHRoZSByb3V0ZSBvYmplY3QgZm9yIHRoZSBzcGEgaW5zdGFuY2UKICAgICAgICAKICAgICAgICBSb3V0ZXMgY2FuIGJlIGluIDQgZm9ybXMKICAgICAgICAKICAgICAgICB7CiAgICAgICAgJy9wYXRoL3RvLzpmb28nOiAncGF0aC90by9tb2R1bGUnLAogICAgICAgICcvcGF0aC90by86YmFyJzogWydwYXRoL3RvL21vZHVsZTEnLCAncGF0aC90by9tb2R1bGUyJ10sCiAgICAgICAgJy9wYXRoL3RvLzpmYic6IHsgcGF0aDogJ3BhdGgvdG8vbW9kdWxlJywgYXJnczogWydhcmdzJywgJ3RvJywgJ2hhbmQgb2ZmIHRvIHN0YXJ0J10gfQogICAgICAgICcvcGF0aC90by86Zm9vLzpiYXInOiBmdW5jdGlvbihmb28sIGJhcil7ICBjdXN0b20gaGFuZGxlciB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIEBtZXRob2QgY29uZmlndXJlUm91dGVzCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHJvdXRlcyBPYmplY3Qgb2Ygcm91dGVzLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChyb3V0ZXMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBjb25maWd1cmVkUm91dGVzID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICAvLyBlYWNoKHJvdXRlcywgZnVuY3Rpb24gKHZhbHVlLCByb3V0ZSkgewogICAgICAgICAgICBmb3IodmFyIHJvdXRlIGluIHJvdXRlcykgewogICAgICAgICAgICAgICAgaWYoXy5oYXMocm91dGVzLCByb3V0ZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSByb3V0ZXNbcm91dGVdOwogICAgICAgICAgICAgICAgICAgIHZhciByZWFsUm91dGUgPSB1dGlsLmZpeHVwVXJsKHJvdXRlLCB0aGF0LmJhc2VVcmwpOwogICAgICAgICAgICAgICAgICAgIGlmKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyZWRSb3V0ZXNbcmVhbFJvdXRlXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kdWxlcyA9IFtdLCBtZXRob2RzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSB2YWx1ZS5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2ID0gdmFsdWVbdl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1N0cmluZyh2KSB8fCBpc09iamVjdCh2KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZXMucHVzaCh2KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc0Z1bmN0aW9uKHYpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kcy5wdXNoKHYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVDYWxsYmFjayA9IHRoYXQubW9kdWxlU3RhcnRDYWxsYmFjayhyb3V0ZSwgbW9kdWxlcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZHMucHVzaChtb2R1bGVDYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyZWRSb3V0ZXNbcmVhbFJvdXRlXSA9IG1ldGhvZHM7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kdWxlQ2FsbGJhY2sgPSB0aGF0Lm1vZHVsZVN0YXJ0Q2FsbGJhY2socm91dGUsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJlZFJvdXRlc1tyZWFsUm91dGVdID0gbW9kdWxlQ2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vfSk7CiAgICAgICAgICAgIHJldHVybiBjb25maWd1cmVkUm91dGVzOwogICAgICAgIH07CiAgICAgICAgU2luZ2xlUGFnZUFwcGxpY2F0aW9uLnByb3RvdHlwZS5tb2R1bGVTdGFydENhbGxiYWNrID0gLyoqCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBtb2R1bGVTdGFydENhbGxiYWNrCiAgICAgICAgQHByaXZhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZyB8IEFycmF5IHwgT2JqZWN0fSBtb2R1bGVzIFN0cmluZyB0byBzdGFydCBhIHNpbmdsZSBtb2R1bGUsIEFycmF5IHRvIHN0YXJ0IG1hbnkgbW9kdWxlcywgT2JqZWN0IHRvIHN0YXJ0IGEgbW9kdWxlIHdpdGggc3BlY2lmaWMgYXJndW1lbnRzLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChyb3V0ZSwgbW9kdWxlcykgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdLCBwYXJhbXMgPSBleHRyYWN0UGFyYW1zKHJvdXRlKSwgdGhhdCA9IHRoaXMsIGZpbGVFeHRlbnNpb24gPSB0aGF0LmZpbGVFeHRlbnNpb247CiAgICAgICAgICAgIGlmKGlzT2JqZWN0KG1vZHVsZXMpKSB7CiAgICAgICAgICAgICAgICBhcmdzID0gbW9kdWxlcy5hcmdzIHx8IGFyZ3M7CiAgICAgICAgICAgICAgICBtb2R1bGVzID0gbW9kdWxlcy5wYXRoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGlzU3RyaW5nKG1vZHVsZXMpKSB7CiAgICAgICAgICAgICAgICBtb2R1bGVzID0gWwogICAgICAgICAgICAgICAgICAgIG1vZHVsZXMKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBhciA9IHRvQXJyYXkoYXJndW1lbnRzKSwgdGhydXN0ID0gdGhhdC50aHJ1c3QsIG1hcHBlZE1vZHVsZXMgPSBtYXAobW9kdWxlcywgZnVuY3Rpb24gKG1vZHVsZVBhdGgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVkdWNlKGFyLCBmdW5jdGlvbiAobWVtbywgYXJnLCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtZW1vLnJlcGxhY2UocGFyYW1zW2ldLCBhcmcudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgfSwgbW9kdWxlUGF0aCkucmVwbGFjZShmaWxlRXh0ZW5zaW9uLCAnJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhydXN0LnN0YXJ0LmFwcGx5KHRocnVzdCwgWwogICAgICAgICAgICAgICAgICAgIG1hcHBlZE1vZHVsZXMKICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LnRocnVzdC5zdGFydGVkKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhydXN0LnJlYWR5KG1hcHBlZE1vZHVsZXMsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhhdC5zdGFydGluZ01vZHVsZVByb21pc2UgPSBwcm9taXNlOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgU2luZ2xlUGFnZUFwcGxpY2F0aW9uLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSAvKioKICAgICAgICBIYW5kcyB0aGUgbmF2aWdhdGUgbWV0aG9kIG9mZiB0byB0aGUgbW9kdWxlLCBzbyBhbnkgbW9kdWxlIGNhbiB0cmlnZ2VyIGEgbmF2aWdhdGlvbiBldmVudC4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5zcGEuU2luZ2xlUGFnZUFwcAogICAgICAgIEBtZXRob2QgY3JlYXRlRmFjYWRlCiAgICAgICAgQHBhcmFtIHt0aHJ1c3QuVGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgIEBwYXJhbSB7dGhydXN0Lk1vZHVsZX0gbW9kIFRoZSBtb2R1bGUgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgYWxyZWFkeSBhZGRlZCBmb3IgdGhpcyBtb2R1bGUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYobW9kLm5hdmlnYXRlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJyJuYXZpZ2F0ZSIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEFscmVhZHkgcHJlIGJvdW5kLCBzbyB3ZSBvbmx5IHBhc3MgYXJvdW5kIDEgZnVuY3Rpb24gcGVyIGluc3RhbmNlLgogICAgICAgICAgICBtb2QubmF2aWdhdGUgPSB0aGF0Lm5hdmlnYXRlLmJpbmQodGhhdCk7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgU2luZ2xlUGFnZUFwcGxpY2F0aW9uLmNvbmZpZyA9IGNvbmZpZzsKICAgICAgICByZXR1cm4gU2luZ2xlUGFnZUFwcGxpY2F0aW9uOwogICAgfSkoKTsKICAgIGV4cG9ydHMuU2luZ2xlUGFnZUFwcGxpY2F0aW9uID0gU2luZ2xlUGFnZUFwcGxpY2F0aW9uOyAgICAKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9zcGEnLCBbJ3RocnVzdC9zcGEvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7Cg==",
                "body": "LyohIHRocnVzdC1qcyAtIHYwLjEuNSAtIDIwMTMtMDEtMjcgKi87KGZ1bmN0aW9uKHdpbmRvdywgdW5kZWZpbmVkKSB7CgogIC8qKiBEZXRlY3QgZnJlZSB2YXJpYWJsZSBgZXhwb3J0c2AgKi8KICB2YXIgZnJlZUV4cG9ydHMgPSB0eXBlb2YgZXhwb3J0cyA9PSAnb2JqZWN0JyAmJiBleHBvcnRzOwoKICAvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGUgYGdsb2JhbGAgYW5kIHVzZSBpdCBhcyBgd2luZG93YCAqLwogIHZhciBmcmVlR2xvYmFsID0gdHlwZW9mIGdsb2JhbCA9PSAnb2JqZWN0JyAmJiBnbG9iYWw7CiAgaWYgKGZyZWVHbG9iYWwuZ2xvYmFsID09PSBmcmVlR2xvYmFsKSB7CiAgICB3aW5kb3cgPSBmcmVlR2xvYmFsOwogIH0KCiAgLyoqIFVzZWQgZm9yIGFycmF5IGFuZCBvYmplY3QgbWV0aG9kIHJlZmVyZW5jZXMgKi8KICB2YXIgYXJyYXlSZWYgPSBbXSwKICAgICAgb2JqZWN0UmVmID0ge307CgogIC8qKiBVc2VkIHRvIGdlbmVyYXRlIHVuaXF1ZSBJRHMgKi8KICB2YXIgaWRDb3VudGVyID0gMDsKCiAgLyoqIFVzZWQgaW50ZXJuYWxseSB0byBpbmRpY2F0ZSB2YXJpb3VzIHRoaW5ncyAqLwogIHZhciBpbmRpY2F0b3JPYmplY3QgPSBvYmplY3RSZWY7CgogIC8qKiBVc2VkIGJ5IGBjYWNoZWRDb250YWluc2AgYXMgdGhlIGRlZmF1bHQgc2l6ZSB3aGVuIG9wdGltaXphdGlvbnMgYXJlIGVuYWJsZWQgZm9yIGxhcmdlIGFycmF5cyAqLwogIHZhciBsYXJnZUFycmF5U2l6ZSA9IDMwOwoKICAvKiogVXNlZCB0byByZXN0b3JlIHRoZSBvcmlnaW5hbCBgX2AgcmVmZXJlbmNlIGluIGBub0NvbmZsaWN0YCAqLwogIHZhciBvbGREYXNoID0gd2luZG93Ll87CgogIC8qKiBVc2VkIHRvIG1hdGNoIEhUTUwgZW50aXRpZXMgKi8KICB2YXIgcmVFc2NhcGVkSHRtbCA9IC8mKD86YW1wfGx0fGd0fHF1b3R8I3gyNyk7L2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoIGVtcHR5IHN0cmluZyBsaXRlcmFscyBpbiBjb21waWxlZCB0ZW1wbGF0ZSBzb3VyY2UgKi8KICB2YXIgcmVFbXB0eVN0cmluZ0xlYWRpbmcgPSAvXGJfX3AgXCs9ICcnOy9nLAogICAgICByZUVtcHR5U3RyaW5nTWlkZGxlID0gL1xiKF9fcCBcKz0pICcnIFwrL2csCiAgICAgIHJlRW1wdHlTdHJpbmdUcmFpbGluZyA9IC8oX19lXCguKj9cKXxcYl9fdFwpKSBcK1xuJyc7L2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoIHJlZ2V4cCBmbGFncyBmcm9tIHRoZWlyIGNvZXJjZWQgc3RyaW5nIHZhbHVlcyAqLwogIHZhciByZUZsYWdzID0gL1x3KiQvOwoKICAvKiogVXNlZCB0byBkZXRlY3QgaWYgYSBtZXRob2QgaXMgbmF0aXZlICovCiAgdmFyIHJlTmF0aXZlID0gUmVnRXhwKCdeJyArCiAgICAob2JqZWN0UmVmLnZhbHVlT2YgKyAnJykKICAgICAgLnJlcGxhY2UoL1suKis/Xj0hOiR7fSgpfFtcXVwvXFxdL2csICdcXCQmJykKICAgICAgLnJlcGxhY2UoL3ZhbHVlT2Z8Zm9yIFteXF1dKy9nLCAnLis/JykgKyAnJCcKICApOwoKICAvKioKICAgKiBVc2VkIHRvIG1hdGNoIEVTNiB0ZW1wbGF0ZSBkZWxpbWl0ZXJzCiAgICogaHR0cDovL3Blb3BsZS5tb3ppbGxhLm9yZy9+am9yZW5kb3JmZi9lczYtZHJhZnQuaHRtbCNzZWMtNy44LjYKICAgKi8KICB2YXIgcmVFc1RlbXBsYXRlID0gL1wkXHsoKD86KD89XFw/KVxcP1tcc1xTXSkqPyl9L2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoICJpbnRlcnBvbGF0ZSIgdGVtcGxhdGUgZGVsaW1pdGVycyAqLwogIHZhciByZUludGVycG9sYXRlID0gLzwlPShbXHNcU10rPyklPi9nOwoKICAvKiogVXNlZCB0byBlbnN1cmUgY2FwdHVyaW5nIG9yZGVyIG9mIHRlbXBsYXRlIGRlbGltaXRlcnMgKi8KICB2YXIgcmVOb01hdGNoID0gLygkXikvOwoKICAvKiogVXNlZCB0byBtYXRjaCBIVE1MIGNoYXJhY3RlcnMgKi8KICB2YXIgcmVVbmVzY2FwZWRIdG1sID0gL1smPD4iJ10vZzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggdW5lc2NhcGVkIGNoYXJhY3RlcnMgaW4gY29tcGlsZWQgc3RyaW5nIGxpdGVyYWxzICovCiAgdmFyIHJlVW5lc2NhcGVkU3RyaW5nID0gL1snXG5cclx0XHUyMDI4XHUyMDI5XFxdL2c7CgogIC8qKiBVc2VkIHRvIGZpeCB0aGUgSlNjcmlwdCBbW0RvbnRFbnVtXV0gYnVnICovCiAgdmFyIHNoYWRvd2VkID0gWwogICAgJ2NvbnN0cnVjdG9yJywgJ2hhc093blByb3BlcnR5JywgJ2lzUHJvdG90eXBlT2YnLCAncHJvcGVydHlJc0VudW1lcmFibGUnLAogICAgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvU3RyaW5nJywgJ3ZhbHVlT2YnCiAgXTsKCiAgLyoqIFVzZWQgdG8gbWFrZSB0ZW1wbGF0ZSBzb3VyY2VVUkxzIGVhc2llciB0byBpZGVudGlmeSAqLwogIHZhciB0ZW1wbGF0ZUNvdW50ZXIgPSAwOwoKICAvKiogTmF0aXZlIG1ldGhvZCBzaG9ydGN1dHMgKi8KICB2YXIgY2VpbCA9IE1hdGguY2VpbCwKICAgICAgY29uY2F0ID0gYXJyYXlSZWYuY29uY2F0LAogICAgICBmbG9vciA9IE1hdGguZmxvb3IsCiAgICAgIGdldFByb3RvdHlwZU9mID0gcmVOYXRpdmUudGVzdChnZXRQcm90b3R5cGVPZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZikgJiYgZ2V0UHJvdG90eXBlT2YsCiAgICAgIGhhc093blByb3BlcnR5ID0gb2JqZWN0UmVmLmhhc093blByb3BlcnR5LAogICAgICBwdXNoID0gYXJyYXlSZWYucHVzaCwKICAgICAgcHJvcGVydHlJc0VudW1lcmFibGUgPSBvYmplY3RSZWYucHJvcGVydHlJc0VudW1lcmFibGUsCiAgICAgIHRvU3RyaW5nID0gb2JqZWN0UmVmLnRvU3RyaW5nOwoKICAvKiBOYXRpdmUgbWV0aG9kIHNob3J0Y3V0cyBmb3IgbWV0aG9kcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXMgb3RoZXIgYGxvZGFzaGAgbWV0aG9kcyAqLwogIHZhciBuYXRpdmVCaW5kID0gcmVOYXRpdmUudGVzdChuYXRpdmVCaW5kID0gc2xpY2UuYmluZCkgJiYgbmF0aXZlQmluZCwKICAgICAgbmF0aXZlSXNBcnJheSA9IHJlTmF0aXZlLnRlc3QobmF0aXZlSXNBcnJheSA9IEFycmF5LmlzQXJyYXkpICYmIG5hdGl2ZUlzQXJyYXksCiAgICAgIG5hdGl2ZUlzRmluaXRlID0gd2luZG93LmlzRmluaXRlLAogICAgICBuYXRpdmVJc05hTiA9IHdpbmRvdy5pc05hTiwKICAgICAgbmF0aXZlS2V5cyA9IHJlTmF0aXZlLnRlc3QobmF0aXZlS2V5cyA9IE9iamVjdC5rZXlzKSAmJiBuYXRpdmVLZXlzLAogICAgICBuYXRpdmVNYXggPSBNYXRoLm1heCwKICAgICAgbmF0aXZlTWluID0gTWF0aC5taW4sCiAgICAgIG5hdGl2ZVJhbmRvbSA9IE1hdGgucmFuZG9tOwoKICAvKiogYE9iamVjdCN0b1N0cmluZ2AgcmVzdWx0IHNob3J0Y3V0cyAqLwogIHZhciBhcmdzQ2xhc3MgPSAnW29iamVjdCBBcmd1bWVudHNdJywKICAgICAgYXJyYXlDbGFzcyA9ICdbb2JqZWN0IEFycmF5XScsCiAgICAgIGJvb2xDbGFzcyA9ICdbb2JqZWN0IEJvb2xlYW5dJywKICAgICAgZGF0ZUNsYXNzID0gJ1tvYmplY3QgRGF0ZV0nLAogICAgICBmdW5jQ2xhc3MgPSAnW29iamVjdCBGdW5jdGlvbl0nLAogICAgICBudW1iZXJDbGFzcyA9ICdbb2JqZWN0IE51bWJlcl0nLAogICAgICBvYmplY3RDbGFzcyA9ICdbb2JqZWN0IE9iamVjdF0nLAogICAgICByZWdleHBDbGFzcyA9ICdbb2JqZWN0IFJlZ0V4cF0nLAogICAgICBzdHJpbmdDbGFzcyA9ICdbb2JqZWN0IFN0cmluZ10nOwoKICAvKiogRGV0ZWN0IHZhcmlvdXMgZW52aXJvbm1lbnRzICovCiAgdmFyIGlzSWVPcGVyYSA9ICEhd2luZG93LmF0dGFjaEV2ZW50LAogICAgICBpc1Y4ID0gbmF0aXZlQmluZCAmJiAhL1xufHRydWUvLnRlc3QobmF0aXZlQmluZCArIGlzSWVPcGVyYSk7CgogIC8qIERldGVjdCBpZiBgRnVuY3Rpb24jYmluZGAgZXhpc3RzIGFuZCBpcyBpbmZlcnJlZCB0byBiZSBmYXN0IChhbGwgYnV0IFY4KSAqLwogIHZhciBpc0JpbmRGYXN0ID0gbmF0aXZlQmluZCAmJiAhaXNWODsKCiAgLyogRGV0ZWN0IGlmIGBPYmplY3Qua2V5c2AgZXhpc3RzIGFuZCBpcyBpbmZlcnJlZCB0byBiZSBmYXN0IChJRSwgT3BlcmEsIFY4KSAqLwogIHZhciBpc0tleXNGYXN0ID0gbmF0aXZlS2V5cyAmJiAoaXNJZU9wZXJhIHx8IGlzVjgpOwoKICAvKioKICAgKiBEZXRlY3QgdGhlIEpTY3JpcHQgW1tEb250RW51bV1dIGJ1ZzoKICAgKgogICAqIEluIElFIDwgOSBhbiBvYmplY3RzIG93biBwcm9wZXJ0aWVzLCBzaGFkb3dpbmcgbm9uLWVudW1lcmFibGUgb25lcywgYXJlCiAgICogbWFkZSBub24tZW51bWVyYWJsZSBhcyB3ZWxsLgogICAqLwogIHZhciBoYXNEb250RW51bUJ1ZzsKCiAgLyoqIERldGVjdCBpZiBvd24gcHJvcGVydGllcyBhcmUgaXRlcmF0ZWQgYWZ0ZXIgaW5oZXJpdGVkIHByb3BlcnRpZXMgKElFIDwgOSkgKi8KICB2YXIgaXRlcmF0ZXNPd25MYXN0OwoKICAvKioKICAgKiBEZXRlY3QgaWYgYEFycmF5I3NoaWZ0YCBhbmQgYEFycmF5I3NwbGljZWAgYXVnbWVudCBhcnJheS1saWtlIG9iamVjdHMKICAgKiBpbmNvcnJlY3RseToKICAgKgogICAqIEZpcmVmb3ggPCAxMCwgSUUgY29tcGF0aWJpbGl0eSBtb2RlLCBhbmQgSUUgPCA5IGhhdmUgYnVnZ3kgQXJyYXkgYHNoaWZ0KClgCiAgICogYW5kIGBzcGxpY2UoKWAgZnVuY3Rpb25zIHRoYXQgZmFpbCB0byByZW1vdmUgdGhlIGxhc3QgZWxlbWVudCwgYHZhbHVlWzBdYCwKICAgKiBvZiBhcnJheS1saWtlIG9iamVjdHMgZXZlbiB0aG91Z2ggdGhlIGBsZW5ndGhgIHByb3BlcnR5IGlzIHNldCB0byBgMGAuCiAgICogVGhlIGBzaGlmdCgpYCBtZXRob2QgaXMgYnVnZ3kgaW4gSUUgOCBjb21wYXRpYmlsaXR5IG1vZGUsIHdoaWxlIGBzcGxpY2UoKWAKICAgKiBpcyBidWdneSByZWdhcmRsZXNzIG9mIG1vZGUgaW4gSUUgPCA5IGFuZCBidWdneSBpbiBjb21wYXRpYmlsaXR5IG1vZGUgaW4gSUUgOS4KICAgKi8KICB2YXIgaGFzT2JqZWN0U3BsaWNlQnVnID0gKGhhc09iamVjdFNwbGljZUJ1ZyA9IHsgJzAnOiAxLCAnbGVuZ3RoJzogMSB9LAogICAgYXJyYXlSZWYuc3BsaWNlLmNhbGwoaGFzT2JqZWN0U3BsaWNlQnVnLCAwLCAxKSwgaGFzT2JqZWN0U3BsaWNlQnVnWzBdKTsKCiAgLyoqIERldGVjdCBpZiBhbiBgYXJndW1lbnRzYCBvYmplY3QncyBpbmRleGVzIGFyZSBub24tZW51bWVyYWJsZSAoSUUgPCA5KSAqLwogIHZhciBub25FbnVtQXJncyA9IHRydWU7CgogIChmdW5jdGlvbigpIHsKICAgIHZhciBwcm9wcyA9IFtdOwogICAgZnVuY3Rpb24gY3RvcigpIHsgdGhpcy54ID0gMTsgfQogICAgY3Rvci5wcm90b3R5cGUgPSB7ICd2YWx1ZU9mJzogMSwgJ3knOiAxIH07CiAgICBmb3IgKHZhciBwcm9wIGluIG5ldyBjdG9yKSB7IHByb3BzLnB1c2gocHJvcCk7IH0KICAgIGZvciAocHJvcCBpbiBhcmd1bWVudHMpIHsgbm9uRW51bUFyZ3MgPSAhcHJvcDsgfQoKICAgIGhhc0RvbnRFbnVtQnVnID0gIS92YWx1ZU9mLy50ZXN0KHByb3BzKTsKICAgIGl0ZXJhdGVzT3duTGFzdCA9IHByb3BzWzBdICE9ICd4JzsKICB9KDEpKTsKCiAgLyoqIERldGVjdCBpZiBgYXJndW1lbnRzYCBvYmplY3RzIGFyZSBgT2JqZWN0YCBvYmplY3RzIChhbGwgYnV0IE9wZXJhIDwgMTAuNSkgKi8KICB2YXIgYXJnc0FyZU9iamVjdHMgPSBhcmd1bWVudHMuY29uc3RydWN0b3IgPT0gT2JqZWN0OwoKICAvKiogRGV0ZWN0IGlmIGBhcmd1bWVudHNgIG9iamVjdHMgW1tDbGFzc11dIGlzIHVucmVzb2x2YWJsZSAoRmlyZWZveCA8IDQsIElFIDwgOSkgKi8KICB2YXIgbm9BcmdzQ2xhc3MgPSAhaXNBcmd1bWVudHMoYXJndW1lbnRzKTsKCiAgLyoqCiAgICogRGV0ZWN0IGxhY2sgb2Ygc3VwcG9ydCBmb3IgYWNjZXNzaW5nIHN0cmluZyBjaGFyYWN0ZXJzIGJ5IGluZGV4OgogICAqCiAgICogSUUgPCA4IGNhbid0IGFjY2VzcyBjaGFyYWN0ZXJzIGJ5IGluZGV4IGFuZCBJRSA4IGNhbiBvbmx5IGFjY2VzcwogICAqIGNoYXJhY3RlcnMgYnkgaW5kZXggb24gc3RyaW5nIGxpdGVyYWxzLgogICAqLwogIHZhciBub0NoYXJCeUluZGV4ID0gKCd4J1swXSArIE9iamVjdCgneCcpWzBdKSAhPSAneHgnOwoKICAvKioKICAgKiBEZXRlY3QgaWYgYSBub2RlJ3MgW1tDbGFzc11dIGlzIHVucmVzb2x2YWJsZSAoSUUgPCA5KQogICAqIGFuZCB0aGF0IHRoZSBKUyBlbmdpbmUgd29uJ3QgZXJyb3Igd2hlbiBhdHRlbXB0aW5nIHRvIGNvZXJjZSBhbiBvYmplY3QgdG8KICAgKiBhIHN0cmluZyB3aXRob3V0IGEgYHRvU3RyaW5nYCBmdW5jdGlvbi4KICAgKi8KICB0cnkgewogICAgdmFyIG5vTm9kZUNsYXNzID0gdG9TdHJpbmcuY2FsbChkb2N1bWVudCkgPT0gb2JqZWN0Q2xhc3MgJiYgISh7ICd0b1N0cmluZyc6IDAgfSArICcnKTsKICB9IGNhdGNoKGUpIHsgfQoKICAvKiogVXNlZCB0byBpZGVudGlmeSBvYmplY3QgY2xhc3NpZmljYXRpb25zIHRoYXQgYF8uY2xvbmVgIHN1cHBvcnRzICovCiAgdmFyIGNsb25lYWJsZUNsYXNzZXMgPSB7fTsKICBjbG9uZWFibGVDbGFzc2VzW2Z1bmNDbGFzc10gPSBmYWxzZTsKICBjbG9uZWFibGVDbGFzc2VzW2FyZ3NDbGFzc10gPSBjbG9uZWFibGVDbGFzc2VzW2FycmF5Q2xhc3NdID0KICBjbG9uZWFibGVDbGFzc2VzW2Jvb2xDbGFzc10gPSBjbG9uZWFibGVDbGFzc2VzW2RhdGVDbGFzc10gPQogIGNsb25lYWJsZUNsYXNzZXNbbnVtYmVyQ2xhc3NdID0gY2xvbmVhYmxlQ2xhc3Nlc1tvYmplY3RDbGFzc10gPQogIGNsb25lYWJsZUNsYXNzZXNbcmVnZXhwQ2xhc3NdID0gY2xvbmVhYmxlQ2xhc3Nlc1tzdHJpbmdDbGFzc10gPSB0cnVlOwoKICAvKiogVXNlZCB0byBsb29rdXAgYSBidWlsdC1pbiBjb25zdHJ1Y3RvciBieSBbW0NsYXNzXV0gKi8KICB2YXIgY3RvckJ5Q2xhc3MgPSB7fTsKICBjdG9yQnlDbGFzc1thcnJheUNsYXNzXSA9IEFycmF5OwogIGN0b3JCeUNsYXNzW2Jvb2xDbGFzc10gPSBCb29sZWFuOwogIGN0b3JCeUNsYXNzW2RhdGVDbGFzc10gPSBEYXRlOwogIGN0b3JCeUNsYXNzW29iamVjdENsYXNzXSA9IE9iamVjdDsKICBjdG9yQnlDbGFzc1tudW1iZXJDbGFzc10gPSBOdW1iZXI7CiAgY3RvckJ5Q2xhc3NbcmVnZXhwQ2xhc3NdID0gUmVnRXhwOwogIGN0b3JCeUNsYXNzW3N0cmluZ0NsYXNzXSA9IFN0cmluZzsKCiAgLyoqIFVzZWQgdG8gZGV0ZXJtaW5lIGlmIHZhbHVlcyBhcmUgb2YgdGhlIGxhbmd1YWdlIHR5cGUgT2JqZWN0ICovCiAgdmFyIG9iamVjdFR5cGVzID0gewogICAgJ2Jvb2xlYW4nOiBmYWxzZSwKICAgICdmdW5jdGlvbic6IHRydWUsCiAgICAnb2JqZWN0JzogdHJ1ZSwKICAgICdudW1iZXInOiBmYWxzZSwKICAgICdzdHJpbmcnOiBmYWxzZSwKICAgICd1bmRlZmluZWQnOiBmYWxzZQogIH07CgogIC8qKiBVc2VkIHRvIGVzY2FwZSBjaGFyYWN0ZXJzIGZvciBpbmNsdXNpb24gaW4gY29tcGlsZWQgc3RyaW5nIGxpdGVyYWxzICovCiAgdmFyIHN0cmluZ0VzY2FwZXMgPSB7CiAgICAnXFwnOiAnXFwnLAogICAgIiciOiAiJyIsCiAgICAnXG4nOiAnbicsCiAgICAnXHInOiAncicsCiAgICAnXHQnOiAndCcsCiAgICAnXHUyMDI4JzogJ3UyMDI4JywKICAgICdcdTIwMjknOiAndTIwMjknCiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZXMgYSBgbG9kYXNoYCBvYmplY3QsIHRoYXQgd3JhcHMgdGhlIGdpdmVuIGB2YWx1ZWAsIHRvIGVuYWJsZSBtZXRob2QKICAgKiBjaGFpbmluZy4KICAgKgogICAqIEluIGFkZGl0aW9uIHRvIExvLURhc2ggbWV0aG9kcywgd3JhcHBlcnMgYWxzbyBoYXZlIHRoZSBmb2xsb3dpbmcgYEFycmF5YCBtZXRob2RzOgogICAqIGBjb25jYXRgLCBgam9pbmAsIGBwb3BgLCBgcHVzaGAsIGByZXZlcnNlYCwgYHNoaWZ0YCwgYHNsaWNlYCwgYHNvcnRgLCBgc3BsaWNlYCwKICAgKiBhbmQgYHVuc2hpZnRgCiAgICoKICAgKiBUaGUgY2hhaW5hYmxlIHdyYXBwZXIgZnVuY3Rpb25zIGFyZToKICAgKiBgYWZ0ZXJgLCBgYXNzaWduYCwgYGJpbmRgLCBgYmluZEFsbGAsIGBiaW5kS2V5YCwgYGNoYWluYCwgYGNvbXBhY3RgLCBgY29tcG9zZWAsCiAgICogYGNvbmNhdGAsIGBjb3VudEJ5YCwgYGRlYm91bmNlYCwgYGRlZmF1bHRzYCwgYGRlZmVyYCwgYGRlbGF5YCwgYGRpZmZlcmVuY2VgLAogICAqIGBmaWx0ZXJgLCBgZmxhdHRlbmAsIGBmb3JFYWNoYCwgYGZvckluYCwgYGZvck93bmAsIGBmdW5jdGlvbnNgLCBgZ3JvdXBCeWAsCiAgICogYGluaXRpYWxgLCBgaW50ZXJzZWN0aW9uYCwgYGludmVydGAsIGBpbnZva2VgLCBga2V5c2AsIGBtYXBgLCBgbWF4YCwgYG1lbW9pemVgLAogICAqIGBtZXJnZWAsIGBtaW5gLCBgb2JqZWN0YCwgYG9taXRgLCBgb25jZWAsIGBwYWlyc2AsIGBwYXJ0aWFsYCwgYHBhcnRpYWxSaWdodGAsCiAgICogYHBpY2tgLCBgcGx1Y2tgLCBgcHVzaGAsIGByYW5nZWAsIGByZWplY3RgLCBgcmVzdGAsIGByZXZlcnNlYCwgYHNodWZmbGVgLAogICAqIGBzbGljZWAsIGBzb3J0YCwgYHNvcnRCeWAsIGBzcGxpY2VgLCBgdGFwYCwgYHRocm90dGxlYCwgYHRpbWVzYCwgYHRvQXJyYXlgLAogICAqIGB1bmlvbmAsIGB1bmlxYCwgYHVuc2hpZnRgLCBgdmFsdWVzYCwgYHdoZXJlYCwgYHdpdGhvdXRgLCBgd3JhcGAsIGFuZCBgemlwYAogICAqCiAgICogVGhlIG5vbi1jaGFpbmFibGUgd3JhcHBlciBmdW5jdGlvbnMgYXJlOgogICAqIGBjbG9uZWAsIGBjbG9uZURlZXBgLCBgY29udGFpbnNgLCBgZXNjYXBlYCwgYGV2ZXJ5YCwgYGZpbmRgLCBgaGFzYCwgYGlkZW50aXR5YCwKICAgKiBgaW5kZXhPZmAsIGBpc0FyZ3VtZW50c2AsIGBpc0FycmF5YCwgYGlzQm9vbGVhbmAsIGBpc0RhdGVgLCBgaXNFbGVtZW50YCwgYGlzRW1wdHlgLAogICAqIGBpc0VxdWFsYCwgYGlzRmluaXRlYCwgYGlzRnVuY3Rpb25gLCBgaXNOYU5gLCBgaXNOdWxsYCwgYGlzTnVtYmVyYCwgYGlzT2JqZWN0YCwKICAgKiBgaXNQbGFpbk9iamVjdGAsIGBpc1JlZ0V4cGAsIGBpc1N0cmluZ2AsIGBpc1VuZGVmaW5lZGAsIGBqb2luYCwgYGxhc3RJbmRleE9mYCwKICAgKiBgbWl4aW5gLCBgbm9Db25mbGljdGAsIGBwb3BgLCBgcmFuZG9tYCwgYHJlZHVjZWAsIGByZWR1Y2VSaWdodGAsIGByZXN1bHRgLAogICAqIGBzaGlmdGAsIGBzaXplYCwgYHNvbWVgLCBgc29ydGVkSW5kZXhgLCBgdGVtcGxhdGVgLCBgdW5lc2NhcGVgLCBhbmQgYHVuaXF1ZUlkYAogICAqCiAgICogVGhlIHdyYXBwZXIgZnVuY3Rpb25zIGBmaXJzdGAgYW5kIGBsYXN0YCByZXR1cm4gd3JhcHBlZCB2YWx1ZXMgd2hlbiBgbmAgaXMKICAgKiBwYXNzZWQsIG90aGVyd2lzZSB0aGV5IHJldHVybiB1bndyYXBwZWQgdmFsdWVzLgogICAqCiAgICogQG5hbWUgXwogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwIGluIGEgYGxvZGFzaGAgaW5zdGFuY2UuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhIGBsb2Rhc2hgIGluc3RhbmNlLgogICAqLwogIGZ1bmN0aW9uIGxvZGFzaCh2YWx1ZSkgewogICAgLy8gZXhpdCBlYXJseSBpZiBhbHJlYWR5IHdyYXBwZWQsIGV2ZW4gaWYgd3JhcHBlZCBieSBhIGRpZmZlcmVudCBgbG9kYXNoYCBjb25zdHJ1Y3RvcgogICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiB2YWx1ZS5fX3dyYXBwZWRfXykgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICAvLyBhbGxvdyBpbnZva2luZyBgbG9kYXNoYCB3aXRob3V0IHRoZSBgbmV3YCBvcGVyYXRvcgogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGxvZGFzaCkpIHsKICAgICAgcmV0dXJuIG5ldyBsb2Rhc2godmFsdWUpOwogICAgfQogICAgdGhpcy5fX3dyYXBwZWRfXyA9IHZhbHVlOwogIH0KCiAgLyoqCiAgICogQnkgZGVmYXVsdCwgdGhlIHRlbXBsYXRlIGRlbGltaXRlcnMgdXNlZCBieSBMby1EYXNoIGFyZSBzaW1pbGFyIHRvIHRob3NlIGluCiAgICogZW1iZWRkZWQgUnVieSAoRVJCKS4gQ2hhbmdlIHRoZSBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlCiAgICogZGVsaW1pdGVycy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEB0eXBlIE9iamVjdAogICAqLwogIGxvZGFzaC50ZW1wbGF0ZVNldHRpbmdzID0gewoKICAgIC8qKgogICAgICogVXNlZCB0byBkZXRlY3QgYGRhdGFgIHByb3BlcnR5IHZhbHVlcyB0byBiZSBIVE1MLWVzY2FwZWQuCiAgICAgKgogICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICogQHR5cGUgUmVnRXhwCiAgICAgKi8KICAgICdlc2NhcGUnOiAvPCUtKFtcc1xTXSs/KSU+L2csCgogICAgLyoqCiAgICAgKiBVc2VkIHRvIGRldGVjdCBjb2RlIHRvIGJlIGV2YWx1YXRlZC4KICAgICAqCiAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgKiBAdHlwZSBSZWdFeHAKICAgICAqLwogICAgJ2V2YWx1YXRlJzogLzwlKFtcc1xTXSs/KSU+L2csCgogICAgLyoqCiAgICAgKiBVc2VkIHRvIGRldGVjdCBgZGF0YWAgcHJvcGVydHkgdmFsdWVzIHRvIGluamVjdC4KICAgICAqCiAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgKiBAdHlwZSBSZWdFeHAKICAgICAqLwogICAgJ2ludGVycG9sYXRlJzogcmVJbnRlcnBvbGF0ZSwKCiAgICAvKioKICAgICAqIFVzZWQgdG8gcmVmZXJlbmNlIHRoZSBkYXRhIG9iamVjdCBpbiB0aGUgdGVtcGxhdGUgdGV4dC4KICAgICAqCiAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAqLwogICAgJ3ZhcmlhYmxlJzogJycsCgogICAgLyoqCiAgICAgKiBVc2VkIHRvIGltcG9ydCB2YXJpYWJsZXMgaW50byB0aGUgY29tcGlsZWQgdGVtcGxhdGUuCiAgICAgKgogICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICogQHR5cGUgT2JqZWN0CiAgICAgKi8KICAgICdpbXBvcnRzJzogewoKICAgICAgLyoqCiAgICAgICAqIEEgcmVmZXJlbmNlIHRvIHRoZSBgbG9kYXNoYCBmdW5jdGlvbi4KICAgICAgICoKICAgICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncy5pbXBvcnRzCiAgICAgICAqIEB0eXBlIEZ1bmN0aW9uCiAgICAgICAqLwogICAgICAnXyc6IGxvZGFzaAogICAgfQogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBUaGUgdGVtcGxhdGUgdXNlZCB0byBjcmVhdGUgaXRlcmF0b3IgZnVuY3Rpb25zLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge09iZWN0fSBkYXRhIFRoZSBkYXRhIG9iamVjdCB1c2VkIHRvIHBvcHVsYXRlIHRoZSB0ZXh0LgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgdGhlIGludGVycG9sYXRlZCB0ZXh0LgogICAqLwogIHZhciBpdGVyYXRvclRlbXBsYXRlID0gdGVtcGxhdGUoCiAgICAvLyB0aGUgYGl0ZXJhYmxlYCBtYXkgYmUgcmVhc3NpZ25lZCBieSB0aGUgYHRvcGAgc25pcHBldAogICAgJ3ZhciBpbmRleCwgaXRlcmFibGUgPSA8JT0gZmlyc3RBcmcgJT4sICcgKwogICAgLy8gYXNzaWduIHRoZSBgcmVzdWx0YCB2YXJpYWJsZSBhbiBpbml0aWFsIHZhbHVlCiAgICAncmVzdWx0ID0gPCU9IGZpcnN0QXJnICU+O1xuJyArCiAgICAvLyBleGl0IGVhcmx5IGlmIHRoZSBmaXJzdCBhcmd1bWVudCBpcyBmYWxzZXkKICAgICdpZiAoITwlPSBmaXJzdEFyZyAlPikgcmV0dXJuIHJlc3VsdDtcbicgKwogICAgLy8gYWRkIGNvZGUgYmVmb3JlIHRoZSBpdGVyYXRpb24gYnJhbmNoZXMKICAgICc8JT0gdG9wICU+O1xuJyArCgogICAgLy8gYXJyYXktbGlrZSBpdGVyYXRpb246CiAgICAnPCUgaWYgKGFycmF5cykgeyAlPicgKwogICAgJ3ZhciBsZW5ndGggPSBpdGVyYWJsZS5sZW5ndGg7IGluZGV4ID0gLTE7XG4nICsKICAgICJpZiAoPCU9IGFycmF5cyAlPikgeyIgKwoKICAgIC8vIGFkZCBzdXBwb3J0IGZvciBhY2Nlc3Npbmcgc3RyaW5nIGNoYXJhY3RlcnMgYnkgaW5kZXggaWYgbmVlZGVkCiAgICAnICA8JSBpZiAobm9DaGFyQnlJbmRleCkgeyAlPlxuJyArCiAgICAnICBpZiAoaXNTdHJpbmcoaXRlcmFibGUpKSB7XG4nICsKICAgICIgICAgaXRlcmFibGUgPSBpdGVyYWJsZS5zcGxpdCgnJylcbiIgKwogICAgJyAgfScgKwogICAgJyAgPCUgfSAlPlxuJyArCgogICAgLy8gaXRlcmF0ZSBvdmVyIHRoZSBhcnJheS1saWtlIHZhbHVlCiAgICAnICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkge1xuJyArCiAgICAnICAgIDwlPSBsb29wICU+XG4nICsKICAgICcgIH1cbicgKwogICAgJ31cbicgKwogICAgJ2Vsc2UgeycgKwoKICAgIC8vIG9iamVjdCBpdGVyYXRpb246CiAgICAvLyBhZGQgc3VwcG9ydCBmb3IgaXRlcmF0aW5nIG92ZXIgYGFyZ3VtZW50c2Agb2JqZWN0cyBpZiBuZWVkZWQKICAgICcgIDwlICB9IGVsc2UgaWYgKG5vbkVudW1BcmdzKSB7ICU+XG4nICsKICAgICcgIHZhciBsZW5ndGggPSBpdGVyYWJsZS5sZW5ndGg7IGluZGV4ID0gLTE7XG4nICsKICAgICcgIGlmIChsZW5ndGggJiYgaXNBcmd1bWVudHMoaXRlcmFibGUpKSB7XG4nICsKICAgICcgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHtcbicgKwogICAgIiAgICAgIGluZGV4ICs9ICcnO1xuIiArCiAgICAnICAgICAgPCU9IGxvb3AgJT5cbicgKwogICAgJyAgICB9XG4nICsKICAgICcgIH0gZWxzZSB7JyArCiAgICAnICA8JSB9ICU+JyArCgogICAgLy8gRmlyZWZveCA8IDMuNiwgT3BlcmEgPiA5LjUwIC0gT3BlcmEgPCAxMS42MCwgYW5kIFNhZmFyaSA8IDUuMQogICAgLy8gKGlmIHRoZSBwcm90b3R5cGUgb3IgYSBwcm9wZXJ0eSBvbiB0aGUgcHJvdG90eXBlIGhhcyBiZWVuIHNldCkKICAgIC8vIGluY29ycmVjdGx5IHNldHMgYSBmdW5jdGlvbidzIGBwcm90b3R5cGVgIHByb3BlcnR5IFtbRW51bWVyYWJsZV1dCiAgICAvLyB2YWx1ZSB0byBgdHJ1ZWAuIEJlY2F1c2Ugb2YgdGhpcyBMby1EYXNoIHN0YW5kYXJkaXplcyBvbiBza2lwcGluZwogICAgLy8gdGhlIHRoZSBgcHJvdG90eXBlYCBwcm9wZXJ0eSBvZiBmdW5jdGlvbnMgcmVnYXJkbGVzcyBvZiBpdHMKICAgIC8vIFtbRW51bWVyYWJsZV1dIHZhbHVlLgogICAgJyAgPCUgaWYgKCFoYXNEb250RW51bUJ1ZykgeyAlPlxuJyArCiAgICAiICB2YXIgc2tpcFByb3RvID0gdHlwZW9mIGl0ZXJhYmxlID09ICdmdW5jdGlvbicgJiYgXG4iICsKICAgICIgICAgcHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChpdGVyYWJsZSwgJ3Byb3RvdHlwZScpO1xuIiArCiAgICAnICA8JSB9ICU+JyArCgogICAgLy8gaXRlcmF0ZSBvd24gcHJvcGVydGllcyB1c2luZyBgT2JqZWN0LmtleXNgIGlmIGl0J3MgZmFzdAogICAgJyAgPCUgaWYgKGlzS2V5c0Zhc3QgJiYgdXNlSGFzKSB7ICU+XG4nICsKICAgICcgIHZhciBvd25JbmRleCA9IC0xLFxuJyArCiAgICAnICAgICAgb3duUHJvcHMgPSBvYmplY3RUeXBlc1t0eXBlb2YgaXRlcmFibGVdID8gbmF0aXZlS2V5cyhpdGVyYWJsZSkgOiBbXSxcbicgKwogICAgJyAgICAgIGxlbmd0aCA9IG93blByb3BzLmxlbmd0aDtcblxuJyArCiAgICAnICB3aGlsZSAoKytvd25JbmRleCA8IGxlbmd0aCkge1xuJyArCiAgICAnICAgIGluZGV4ID0gb3duUHJvcHNbb3duSW5kZXhdO1xuJyArCiAgICAiICAgIDwlIGlmICghaGFzRG9udEVudW1CdWcpIHsgJT5pZiAoIShza2lwUHJvdG8gJiYgaW5kZXggPT0gJ3Byb3RvdHlwZScpKSB7XG4gIDwlIH0gJT4iICsKICAgICcgICAgPCU9IGxvb3AgJT5cbicgKwogICAgJyAgICA8JSBpZiAoIWhhc0RvbnRFbnVtQnVnKSB7ICU+fVxuPCUgfSAlPicgKwogICAgJyAgfScgKwoKICAgIC8vIGVsc2UgdXNpbmcgYSBmb3ItaW4gbG9vcAogICAgJyAgPCUgfSBlbHNlIHsgJT5cbicgKwogICAgJyAgZm9yIChpbmRleCBpbiBpdGVyYWJsZSkgezwlJyArCiAgICAnICAgIGlmICghaGFzRG9udEVudW1CdWcgfHwgdXNlSGFzKSB7ICU+XG4gICAgaWYgKDwlJyArCiAgICAiICAgICAgaWYgKCFoYXNEb250RW51bUJ1ZykgeyAlPiEoc2tpcFByb3RvICYmIGluZGV4ID09ICdwcm90b3R5cGUnKTwlIH0iICsKICAgICcgICAgICBpZiAoIWhhc0RvbnRFbnVtQnVnICYmIHVzZUhhcykgeyAlPiAmJiA8JSB9JyArCiAgICAnICAgICAgaWYgKHVzZUhhcykgeyAlPmhhc093blByb3BlcnR5LmNhbGwoaXRlcmFibGUsIGluZGV4KTwlIH0nICsKICAgICcgICAgJT4pIHsnICsKICAgICcgICAgPCUgfSAlPlxuJyArCiAgICAnICAgIDwlPSBsb29wICU+OycgKwogICAgJyAgICA8JSBpZiAoIWhhc0RvbnRFbnVtQnVnIHx8IHVzZUhhcykgeyAlPlxuICAgIH08JSB9ICU+XG4nICsKICAgICcgIH0nICsKICAgICcgIDwlIH0gJT4nICsKCiAgICAvLyBCZWNhdXNlIElFIDwgOSBjYW4ndCBzZXQgdGhlIGBbW0VudW1lcmFibGVdXWAgYXR0cmlidXRlIG9mIGFuCiAgICAvLyBleGlzdGluZyBwcm9wZXJ0eSBhbmQgdGhlIGBjb25zdHJ1Y3RvcmAgcHJvcGVydHkgb2YgYSBwcm90b3R5cGUKICAgIC8vIGRlZmF1bHRzIHRvIG5vbi1lbnVtZXJhYmxlLCBMby1EYXNoIHNraXBzIHRoZSBgY29uc3RydWN0b3JgCiAgICAvLyBwcm9wZXJ0eSB3aGVuIGl0IGluZmVycyBpdCdzIGl0ZXJhdGluZyBvdmVyIGEgYHByb3RvdHlwZWAgb2JqZWN0LgogICAgJyAgPCUgaWYgKGhhc0RvbnRFbnVtQnVnKSB7ICU+XG5cbicgKwogICAgJyAgdmFyIGN0b3IgPSBpdGVyYWJsZS5jb25zdHJ1Y3RvcjtcbicgKwogICAgJyAgICA8JSBmb3IgKHZhciBrID0gMDsgayA8IDc7IGsrKykgeyAlPlxuJyArCiAgICAiICBpbmRleCA9ICc8JT0gc2hhZG93ZWRba10gJT4nO1xuIiArCiAgICAnICBpZiAoPCUnICsKICAgICIgICAgICBpZiAoc2hhZG93ZWRba10gPT0gJ2NvbnN0cnVjdG9yJykgeyIgKwogICAgJyAgICAgICAgJT4hKGN0b3IgJiYgY3Rvci5wcm90b3R5cGUgPT09IGl0ZXJhYmxlKSAmJiA8JScgKwogICAgJyAgICAgIH0gJT5oYXNPd25Qcm9wZXJ0eS5jYWxsKGl0ZXJhYmxlLCBpbmRleCkpIHtcbicgKwogICAgJyAgICA8JT0gbG9vcCAlPlxuJyArCiAgICAnICB9JyArCiAgICAnICAgIDwlIH0gJT4nICsKICAgICcgIDwlIH0gJT4nICsKICAgICcgIDwlIGlmIChhcnJheXMgfHwgbm9uRW51bUFyZ3MpIHsgJT5cbn08JSB9ICU+XG4nICsKCiAgICAvLyBhZGQgY29kZSB0byB0aGUgYm90dG9tIG9mIHRoZSBpdGVyYXRpb24gZnVuY3Rpb24KICAgICc8JT0gYm90dG9tICU+O1xuJyArCiAgICAvLyBmaW5hbGx5LCByZXR1cm4gdGhlIGByZXN1bHRgCiAgICAncmV0dXJuIHJlc3VsdCcKICApOwoKICAvKiogUmV1c2FibGUgaXRlcmF0b3Igb3B0aW9ucyBmb3IgYGFzc2lnbmAgYW5kIGBkZWZhdWx0c2AgKi8KICB2YXIgYXNzaWduSXRlcmF0b3JPcHRpb25zID0gewogICAgJ2FyZ3MnOiAnb2JqZWN0LCBzb3VyY2UsIGd1YXJkJywKICAgICd0b3AnOgogICAgICAndmFyIGFyZ3NJbmRleCA9IDAsXG4nICsKICAgICAgIiAgICBhcmdzTGVuZ3RoID0gdHlwZW9mIGd1YXJkID09ICdudW1iZXInID8gMiA6IGFyZ3VtZW50cy5sZW5ndGg7XG4iICsKICAgICAgJ3doaWxlICgrK2FyZ3NJbmRleCA8IGFyZ3NMZW5ndGgpIHtcbicgKwogICAgICAnICBpZiAoKGl0ZXJhYmxlID0gYXJndW1lbnRzW2FyZ3NJbmRleF0pKSB7JywKICAgICdsb29wJzogJ3Jlc3VsdFtpbmRleF0gPSBpdGVyYWJsZVtpbmRleF0nLAogICAgJ2JvdHRvbSc6ICcgIH1cbn0nCiAgfTsKCiAgLyoqIFJldXNhYmxlIGl0ZXJhdG9yIG9wdGlvbnMgc2hhcmVkIGJ5IGBlYWNoYCwgYGZvckluYCwgYW5kIGBmb3JPd25gICovCiAgdmFyIGVhY2hJdGVyYXRvck9wdGlvbnMgPSB7CiAgICAnYXJncyc6ICdjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZycsCiAgICAndG9wJzogImNhbGxiYWNrID0gY2FsbGJhY2sgJiYgdHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgPyBjYWxsYmFjayA6IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKSIsCiAgICAnYXJyYXlzJzogInR5cGVvZiBsZW5ndGggPT0gJ251bWJlciciLAogICAgJ2xvb3AnOiAnaWYgKGNhbGxiYWNrKGl0ZXJhYmxlW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pID09PSBmYWxzZSkgcmV0dXJuIHJlc3VsdCcKICB9OwoKICAvKiogUmV1c2FibGUgaXRlcmF0b3Igb3B0aW9ucyBmb3IgYGZvckluYCBhbmQgYGZvck93bmAgKi8KICB2YXIgZm9yT3duSXRlcmF0b3JPcHRpb25zID0gewogICAgJ2FycmF5cyc6IGZhbHNlCiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiBvcHRpbWl6ZWQgdG8gc2VhcmNoIGxhcmdlIGFycmF5cyBmb3IgYSBnaXZlbiBgdmFsdWVgLAogICAqIHN0YXJ0aW5nIGF0IGBmcm9tSW5kZXhgLCB1c2luZyBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2VhcmNoLgogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAqIEBwYXJhbSB7TnVtYmVyfSBbZnJvbUluZGV4PTBdIFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgKiBAcGFyYW0ge051bWJlcn0gW2xhcmdlU2l6ZT0zMF0gVGhlIGxlbmd0aCBhdCB3aGljaCBhbiBhcnJheSBpcyBjb25zaWRlcmVkIGxhcmdlLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgYHZhbHVlYCBpcyBmb3VuZCwgZWxzZSBgZmFsc2VgLgogICAqLwogIGZ1bmN0aW9uIGNhY2hlZENvbnRhaW5zKGFycmF5LCBmcm9tSW5kZXgsIGxhcmdlU2l6ZSkgewogICAgZnJvbUluZGV4IHx8IChmcm9tSW5kZXggPSAwKTsKCiAgICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoLAogICAgICAgIGlzTGFyZ2UgPSAobGVuZ3RoIC0gZnJvbUluZGV4KSA+PSAobGFyZ2VTaXplIHx8IGxhcmdlQXJyYXlTaXplKTsKCiAgICBpZiAoaXNMYXJnZSkgewogICAgICB2YXIgY2FjaGUgPSB7fSwKICAgICAgICAgIGluZGV4ID0gZnJvbUluZGV4IC0gMTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgLy8gbWFudWFsbHkgY29lcmNlIGB2YWx1ZWAgdG8gYSBzdHJpbmcgYmVjYXVzZSBgaGFzT3duUHJvcGVydHlgLCBpbiBzb21lCiAgICAgICAgLy8gb2xkZXIgdmVyc2lvbnMgb2YgRmlyZWZveCwgY29lcmNlcyBvYmplY3RzIGluY29ycmVjdGx5CiAgICAgICAgdmFyIGtleSA9IGFycmF5W2luZGV4XSArICcnOwogICAgICAgIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlLCBrZXkpID8gY2FjaGVba2V5XSA6IChjYWNoZVtrZXldID0gW10pKS5wdXNoKGFycmF5W2luZGV4XSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoaXNMYXJnZSkgewogICAgICAgIHZhciBrZXkgPSB2YWx1ZSArICcnOwogICAgICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlLCBrZXkpICYmIGluZGV4T2YoY2FjaGVba2V5XSwgdmFsdWUpID4gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIGluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpID4gLTE7CiAgICB9CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGBfLm1heGAgYW5kIGBfLm1pbmAgYXMgdGhlIGRlZmF1bHQgYGNhbGxiYWNrYCB3aGVuIGEgZ2l2ZW4KICAgKiBgY29sbGVjdGlvbmAgaXMgYSBzdHJpbmcgdmFsdWUuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSBUaGUgY2hhcmFjdGVyIHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgY29kZSB1bml0IG9mIGdpdmVuIGNoYXJhY3Rlci4KICAgKi8KICBmdW5jdGlvbiBjaGFyQXRDYWxsYmFjayh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlLmNoYXJDb2RlQXQoMCk7CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGBzb3J0QnlgIHRvIGNvbXBhcmUgdHJhbnNmb3JtZWQgYGNvbGxlY3Rpb25gIHZhbHVlcywgc3RhYmxlIHNvcnRpbmcKICAgKiB0aGVtIGluIGFzY2VuZGluZyBvcmRlci4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IGEgVGhlIG9iamVjdCB0byBjb21wYXJlIHRvIGBiYC4KICAgKiBAcGFyYW0ge09iamVjdH0gYiBUaGUgb2JqZWN0IHRvIGNvbXBhcmUgdG8gYGFgLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIHNvcnQgb3JkZXIgaW5kaWNhdG9yIG9mIGAxYCBvciBgLTFgLgogICAqLwogIGZ1bmN0aW9uIGNvbXBhcmVBc2NlbmRpbmcoYSwgYikgewogICAgdmFyIGFpID0gYS5pbmRleCwKICAgICAgICBiaSA9IGIuaW5kZXg7CgogICAgYSA9IGEuY3JpdGVyaWE7CiAgICBiID0gYi5jcml0ZXJpYTsKCiAgICAvLyBlbnN1cmUgYSBzdGFibGUgc29ydCBpbiBWOCBhbmQgb3RoZXIgZW5naW5lcwogICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL3Y4L2lzc3Vlcy9kZXRhaWw/aWQ9OTAKICAgIGlmIChhICE9PSBiKSB7CiAgICAgIGlmIChhID4gYiB8fCB0eXBlb2YgYSA9PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiAxOwogICAgICB9CiAgICAgIGlmIChhIDwgYiB8fCB0eXBlb2YgYiA9PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiAtMTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGFpIDwgYmkgPyAtMSA6IDE7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgYGZ1bmNgIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nCiAgICogb2YgYHRoaXNBcmdgIGFuZCBwcmVwZW5kcyBhbnkgYHBhcnRpYWxBcmdzYCB0byB0aGUgYXJndW1lbnRzIHBhc3NlZCB0byB0aGUKICAgKiBib3VuZCBmdW5jdGlvbi4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGJpbmQgb3IgdGhlIG1ldGhvZCBuYW1lLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgLgogICAqIEBwYXJhbSB7QXJyYXl9IHBhcnRpYWxBcmdzIEFuIGFycmF5IG9mIGFyZ3VtZW50cyB0byBiZSBwYXJ0aWFsbHkgYXBwbGllZC4KICAgKiBAcGFyYW0ge09iamVjdH0gW3JpZ2h0XSBVc2VkIHRvIGluZGljYXRlIHBhcnRpYWxseSBhcHBseWluZyBhcmd1bWVudHMgZnJvbSB0aGUgcmlnaHQuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgYm91bmQgZnVuY3Rpb24uCiAgICovCiAgZnVuY3Rpb24gY3JlYXRlQm91bmQoZnVuYywgdGhpc0FyZywgcGFydGlhbEFyZ3MsIHJpZ2h0KSB7CiAgICB2YXIgaXNGdW5jID0gaXNGdW5jdGlvbihmdW5jKSwKICAgICAgICBpc1BhcnRpYWwgPSAhcGFydGlhbEFyZ3MsCiAgICAgICAga2V5ID0gdGhpc0FyZzsKCiAgICAvLyBqdWdnbGUgYXJndW1lbnRzCiAgICBpZiAoaXNQYXJ0aWFsKSB7CiAgICAgIHBhcnRpYWxBcmdzID0gdGhpc0FyZzsKICAgIH0KICAgIGlmICghaXNGdW5jKSB7CiAgICAgIHRoaXNBcmcgPSBmdW5jOwogICAgfQoKICAgIGZ1bmN0aW9uIGJvdW5kKCkgewogICAgICAvLyBgRnVuY3Rpb24jYmluZGAgc3BlYwogICAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxNS4zLjQuNQogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgIHRoaXNCaW5kaW5nID0gaXNQYXJ0aWFsID8gdGhpcyA6IHRoaXNBcmc7CgogICAgICBpZiAoIWlzRnVuYykgewogICAgICAgIGZ1bmMgPSB0aGlzQXJnW2tleV07CiAgICAgIH0KICAgICAgaWYgKHBhcnRpYWxBcmdzLmxlbmd0aCkgewogICAgICAgIGFyZ3MgPSBhcmdzLmxlbmd0aAogICAgICAgICAgPyAoYXJncyA9IHNsaWNlKGFyZ3MpLCByaWdodCA/IGFyZ3MuY29uY2F0KHBhcnRpYWxBcmdzKSA6IHBhcnRpYWxBcmdzLmNvbmNhdChhcmdzKSkKICAgICAgICAgIDogcGFydGlhbEFyZ3M7CiAgICAgIH0KICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkgewogICAgICAgIC8vIGVuc3VyZSBgbmV3IGJvdW5kYCBpcyBhbiBpbnN0YW5jZSBvZiBgYm91bmRgIGFuZCBgZnVuY2AKICAgICAgICBub29wLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwogICAgICAgIHRoaXNCaW5kaW5nID0gbmV3IG5vb3A7CiAgICAgICAgbm9vcC5wcm90b3R5cGUgPSBudWxsOwoKICAgICAgICAvLyBtaW1pYyB0aGUgY29uc3RydWN0b3IncyBgcmV0dXJuYCBiZWhhdmlvcgogICAgICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmNvbS8jeDEzLjIuMgogICAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNCaW5kaW5nLCBhcmdzKTsKICAgICAgICByZXR1cm4gaXNPYmplY3QocmVzdWx0KSA/IHJlc3VsdCA6IHRoaXNCaW5kaW5nOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXNCaW5kaW5nLCBhcmdzKTsKICAgIH0KICAgIHJldHVybiBib3VuZDsKICB9CgogIC8qKgogICAqIFByb2R1Y2VzIGFuIGl0ZXJhdGlvbiBjYWxsYmFjayBib3VuZCB0byBhbiBvcHRpb25hbCBgdGhpc0FyZ2AuIElmIGBmdW5jYCBpcwogICAqIGEgcHJvcGVydHkgbmFtZSwgdGhlIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBmb3IgYSBnaXZlbiBlbGVtZW50LgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gW2Z1bmM9aWRlbnRpdHl8cHJvcGVydHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyCiAgICogaXRlcmF0aW9uIG9yIHByb3BlcnR5IG5hbWUgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEBwYXJhbSB7T2JqZWN0fSBbYWNjdW11bGF0aW5nXSBVc2VkIHRvIGluZGljYXRlIHRoYXQgdGhlIGNhbGxiYWNrIHNob3VsZAogICAqICBhY2NlcHQgYW4gYGFjY3VtdWxhdG9yYCBhcmd1bWVudC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgYSBjYWxsYmFjayBmdW5jdGlvbi4KICAgKi8KICBmdW5jdGlvbiBjcmVhdGVDYWxsYmFjayhmdW5jLCB0aGlzQXJnLCBhY2N1bXVsYXRpbmcpIHsKICAgIGlmICghZnVuYykgewogICAgICByZXR1cm4gaWRlbnRpdHk7CiAgICB9CiAgICB2YXIgdHlwZSA9IHR5cGVvZiBmdW5jOwogICAgaWYgKHR5cGUgIT0gJ2Z1bmN0aW9uJykgewogICAgICBpZiAodHlwZSAhPSAnb2JqZWN0JykgewogICAgICAgIHJldHVybiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgIHJldHVybiBvYmplY3RbZnVuY107CiAgICAgICAgfTsKICAgICAgfQogICAgICB2YXIgcHJvcHMgPSBrZXlzKGZ1bmMpOwogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICAgICAgcmVzdWx0ID0gZmFsc2U7CiAgICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBpc0VxdWFsKG9iamVjdFtwcm9wc1tsZW5ndGhdXSwgZnVuY1twcm9wc1tsZW5ndGhdXSkpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfQogICAgaWYgKHR5cGVvZiB0aGlzQXJnICE9ICd1bmRlZmluZWQnKSB7CiAgICAgIGlmIChhY2N1bXVsYXRpbmcpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgICByZXR1cm4gZnVuYy5jYWxsKHRoaXNBcmcsIGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIG9iamVjdCk7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUsIGluZGV4LCBvYmplY3QpIHsKICAgICAgICByZXR1cm4gZnVuYy5jYWxsKHRoaXNBcmcsIHZhbHVlLCBpbmRleCwgb2JqZWN0KTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBmdW5jOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBjb21waWxlZCBpdGVyYXRpb24gZnVuY3Rpb25zLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnMxLCBvcHRpb25zMiwgLi4uXSBUaGUgY29tcGlsZSBvcHRpb25zIG9iamVjdChzKS4KICAgKiAgYXJyYXlzIC0gQSBzdHJpbmcgb2YgY29kZSB0byBkZXRlcm1pbmUgaWYgdGhlIGl0ZXJhYmxlIGlzIGFuIGFycmF5IG9yIGFycmF5LWxpa2UuCiAgICogIHVzZUhhcyAtIEEgYm9vbGVhbiB0byBzcGVjaWZ5IHVzaW5nIGBoYXNPd25Qcm9wZXJ0eWAgY2hlY2tzIGluIHRoZSBvYmplY3QgbG9vcC4KICAgKiAgYXJncyAtIEEgc3RyaW5nIG9mIGNvbW1hIHNlcGFyYXRlZCBhcmd1bWVudHMgdGhlIGl0ZXJhdGlvbiBmdW5jdGlvbiB3aWxsIGFjY2VwdC4KICAgKiAgdG9wIC0gQSBzdHJpbmcgb2YgY29kZSB0byBleGVjdXRlIGJlZm9yZSB0aGUgaXRlcmF0aW9uIGJyYW5jaGVzLgogICAqICBsb29wIC0gQSBzdHJpbmcgb2YgY29kZSB0byBleGVjdXRlIGluIHRoZSBvYmplY3QgbG9vcC4KICAgKiAgYm90dG9tIC0gQSBzdHJpbmcgb2YgY29kZSB0byBleGVjdXRlIGFmdGVyIHRoZSBpdGVyYXRpb24gYnJhbmNoZXMuCiAgICoKICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uLgogICAqLwogIGZ1bmN0aW9uIGNyZWF0ZUl0ZXJhdG9yKCkgewogICAgdmFyIGRhdGEgPSB7CiAgICAgIC8vIHN1cHBvcnQgcHJvcGVydGllcwogICAgICAnaGFzRG9udEVudW1CdWcnOiBoYXNEb250RW51bUJ1ZywKICAgICAgJ2lzS2V5c0Zhc3QnOiBpc0tleXNGYXN0LAogICAgICAnbm9uRW51bUFyZ3MnOiBub25FbnVtQXJncywKICAgICAgJ25vQ2hhckJ5SW5kZXgnOiBub0NoYXJCeUluZGV4LAogICAgICAnc2hhZG93ZWQnOiBzaGFkb3dlZCwKCiAgICAgIC8vIGl0ZXJhdG9yIG9wdGlvbnMKICAgICAgJ2FycmF5cyc6ICdpc0FycmF5KGl0ZXJhYmxlKScsCiAgICAgICdib3R0b20nOiAnJywKICAgICAgJ2xvb3AnOiAnJywKICAgICAgJ3RvcCc6ICcnLAogICAgICAndXNlSGFzJzogdHJ1ZQogICAgfTsKCiAgICAvLyBtZXJnZSBvcHRpb25zIGludG8gYSB0ZW1wbGF0ZSBkYXRhIG9iamVjdAogICAgZm9yICh2YXIgb2JqZWN0LCBpbmRleCA9IDA7IG9iamVjdCA9IGFyZ3VtZW50c1tpbmRleF07IGluZGV4KyspIHsKICAgICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgewogICAgICAgIGRhdGFba2V5XSA9IG9iamVjdFtrZXldOwogICAgICB9CiAgICB9CiAgICB2YXIgYXJncyA9IGRhdGEuYXJnczsKICAgIGRhdGEuZmlyc3RBcmcgPSAvXlteLF0rLy5leGVjKGFyZ3MpWzBdOwoKICAgIC8vIGNyZWF0ZSB0aGUgZnVuY3Rpb24gZmFjdG9yeQogICAgdmFyIGZhY3RvcnkgPSBGdW5jdGlvbigKICAgICAgICAnY3JlYXRlQ2FsbGJhY2ssIGhhc093blByb3BlcnR5LCBpc0FyZ3VtZW50cywgaXNBcnJheSwgaXNTdHJpbmcsICcgKwogICAgICAgICdvYmplY3RUeXBlcywgbmF0aXZlS2V5cywgcHJvcGVydHlJc0VudW1lcmFibGUnLAogICAgICAncmV0dXJuIGZ1bmN0aW9uKCcgKyBhcmdzICsgJykge1xuJyArIGl0ZXJhdG9yVGVtcGxhdGUoZGF0YSkgKyAnXG59JwogICAgKTsKICAgIC8vIHJldHVybiB0aGUgY29tcGlsZWQgZnVuY3Rpb24KICAgIHJldHVybiBmYWN0b3J5KAogICAgICBjcmVhdGVDYWxsYmFjaywgaGFzT3duUHJvcGVydHksIGlzQXJndW1lbnRzLCBpc0FycmF5LCBpc1N0cmluZywKICAgICAgb2JqZWN0VHlwZXMsIG5hdGl2ZUtleXMsIHByb3BlcnR5SXNFbnVtZXJhYmxlCiAgICApOwogIH0KCiAgLyoqCiAgICogQSBmdW5jdGlvbiBjb21waWxlZCB0byBpdGVyYXRlIGBhcmd1bWVudHNgIG9iamVjdHMsIGFycmF5cywgb2JqZWN0cywgYW5kCiAgICogc3RyaW5ncyBjb25zaXN0ZW5seSBhY3Jvc3MgZW52aXJvbm1lbnRzLCBleGVjdXRpbmcgdGhlIGBjYWxsYmFja2AgZm9yIGVhY2gKICAgKiBlbGVtZW50IGluIHRoZSBgY29sbGVjdGlvbmAuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZAogICAqIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuIENhbGxiYWNrcyBtYXkgZXhpdAogICAqIGl0ZXJhdGlvbiBlYXJseSBieSBleHBsaWNpdGx5IHJldHVybmluZyBgZmFsc2VgLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl8T2JqZWN0fFN0cmluZ30gUmV0dXJucyBgY29sbGVjdGlvbmAuCiAgICovCiAgdmFyIGVhY2ggPSBjcmVhdGVJdGVyYXRvcihlYWNoSXRlcmF0b3JPcHRpb25zKTsKCiAgLyoqCiAgICogVXNlZCBieSBgdGVtcGxhdGVgIHRvIGVzY2FwZSBjaGFyYWN0ZXJzIGZvciBpbmNsdXNpb24gaW4gY29tcGlsZWQKICAgKiBzdHJpbmcgbGl0ZXJhbHMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7U3RyaW5nfSBtYXRjaCBUaGUgbWF0Y2hlZCBjaGFyYWN0ZXIgdG8gZXNjYXBlLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgdGhlIGVzY2FwZWQgY2hhcmFjdGVyLgogICAqLwogIGZ1bmN0aW9uIGVzY2FwZVN0cmluZ0NoYXIobWF0Y2gpIHsKICAgIHJldHVybiAnXFwnICsgc3RyaW5nRXNjYXBlc1ttYXRjaF07CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGBlc2NhcGVgIHRvIGNvbnZlcnQgY2hhcmFjdGVycyB0byBIVE1MIGVudGl0aWVzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge1N0cmluZ30gbWF0Y2ggVGhlIG1hdGNoZWQgY2hhcmFjdGVyIHRvIGVzY2FwZS4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSBlc2NhcGVkIGNoYXJhY3Rlci4KICAgKi8KICBmdW5jdGlvbiBlc2NhcGVIdG1sQ2hhcihtYXRjaCkgewogICAgcmV0dXJuIGh0bWxFc2NhcGVzW21hdGNoXTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgRE9NIG5vZGUgaW4gSUUgPCA5LgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgRE9NIG5vZGUsIGVsc2UgYGZhbHNlYC4KICAgKi8KICBmdW5jdGlvbiBpc05vZGUodmFsdWUpIHsKICAgIC8vIElFIDwgOSBwcmVzZW50cyBET00gbm9kZXMgYXMgYE9iamVjdGAgb2JqZWN0cyBleGNlcHQgdGhleSBoYXZlIGB0b1N0cmluZ2AKICAgIC8vIG1ldGhvZHMgdGhhdCBhcmUgYHR5cGVvZmAgInN0cmluZyIgYW5kIHN0aWxsIGNhbiBjb2VyY2Ugbm9kZXMgdG8gc3RyaW5ncwogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZS50b1N0cmluZyAhPSAnZnVuY3Rpb24nICYmIHR5cGVvZiAodmFsdWUgKyAnJykgPT0gJ3N0cmluZyc7CiAgfQoKICAvKioKICAgKiBBIG5vLW9wZXJhdGlvbiBmdW5jdGlvbi4KICAgKgogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gbm9vcCgpIHsKICAgIC8vIG5vIG9wZXJhdGlvbiBwZXJmb3JtZWQKICB9CgogIC8qKgogICAqIFNsaWNlcyB0aGUgYGNvbGxlY3Rpb25gIGZyb20gdGhlIGBzdGFydGAgaW5kZXggdXAgdG8sIGJ1dCBub3QgaW5jbHVkaW5nLAogICAqIHRoZSBgZW5kYCBpbmRleC4KICAgKgogICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgdXNlZCwgaW5zdGVhZCBvZiBgQXJyYXkjc2xpY2VgLCB0byBzdXBwb3J0IG5vZGUgbGlzdHMKICAgKiBpbiBJRSA8IDkgYW5kIHRvIGVuc3VyZSBkZW5zZSBhcnJheXMgYXJlIHJldHVybmVkLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gc2xpY2UuCiAgICogQHBhcmFtIHtOdW1iZXJ9IHN0YXJ0IFRoZSBzdGFydCBpbmRleC4KICAgKiBAcGFyYW0ge051bWJlcn0gZW5kIFRoZSBlbmQgaW5kZXguCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgYXJyYXkuCiAgICovCiAgZnVuY3Rpb24gc2xpY2UoYXJyYXksIHN0YXJ0LCBlbmQpIHsKICAgIHN0YXJ0IHx8IChzdGFydCA9IDApOwogICAgaWYgKHR5cGVvZiBlbmQgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgZW5kID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwogICAgfQogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gZW5kIC0gc3RhcnQgfHwgMCwKICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGggPCAwID8gMCA6IGxlbmd0aCk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0W2luZGV4XSA9IGFycmF5W3N0YXJ0ICsgaW5kZXhdOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFVzZWQgYnkgYHVuZXNjYXBlYCB0byBjb252ZXJ0IEhUTUwgZW50aXRpZXMgdG8gY2hhcmFjdGVycy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtTdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byB1bmVzY2FwZS4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSB1bmVzY2FwZWQgY2hhcmFjdGVyLgogICAqLwogIGZ1bmN0aW9uIHVuZXNjYXBlSHRtbENoYXIobWF0Y2gpIHsKICAgIHJldHVybiBodG1sVW5lc2NhcGVzW21hdGNoXTsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhbiBgYXJndW1lbnRzYCBvYmplY3QuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGFuIGBhcmd1bWVudHNgIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiAoZnVuY3Rpb24oKSB7IHJldHVybiBfLmlzQXJndW1lbnRzKGFyZ3VtZW50cyk7IH0pKDEsIDIsIDMpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNBcmd1bWVudHMoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGlzQXJndW1lbnRzKHZhbHVlKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gYXJnc0NsYXNzOwogIH0KICAvLyBmYWxsYmFjayBmb3IgYnJvd3NlcnMgdGhhdCBjYW4ndCBkZXRlY3QgYGFyZ3VtZW50c2Agb2JqZWN0cyBieSBbW0NsYXNzXV0KICBpZiAobm9BcmdzQ2xhc3MpIHsKICAgIGlzQXJndW1lbnRzID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID8gaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgJ2NhbGxlZScpIDogZmFsc2U7CiAgICB9OwogIH0KCiAgLyoqCiAgICogSXRlcmF0ZXMgb3ZlciBgb2JqZWN0YCdzIG93biBhbmQgaW5oZXJpdGVkIGVudW1lcmFibGUgcHJvcGVydGllcywgZXhlY3V0aW5nCiAgICogdGhlIGBjYWxsYmFja2AgZm9yIGVhY2ggcHJvcGVydHkuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQKICAgKiBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGtleSwgb2JqZWN0KS4gQ2FsbGJhY2tzIG1heSBleGl0IGl0ZXJhdGlvbgogICAqIGVhcmx5IGJ5IGV4cGxpY2l0bHkgcmV0dXJuaW5nIGBmYWxzZWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIGZ1bmN0aW9uIERvZyhuYW1lKSB7CiAgICogICB0aGlzLm5hbWUgPSBuYW1lOwogICAqIH0KICAgKgogICAqIERvZy5wcm90b3R5cGUuYmFyayA9IGZ1bmN0aW9uKCkgewogICAqICAgYWxlcnQoJ1dvb2YsIHdvb2YhJyk7CiAgICogfTsKICAgKgogICAqIF8uZm9ySW4obmV3IERvZygnRGFnbnknKSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAqICAgYWxlcnQoa2V5KTsKICAgKiB9KTsKICAgKiAvLyA9PiBhbGVydHMgJ25hbWUnIGFuZCAnYmFyaycgKG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAqLwogIHZhciBmb3JJbiA9IGNyZWF0ZUl0ZXJhdG9yKGVhY2hJdGVyYXRvck9wdGlvbnMsIGZvck93bkl0ZXJhdG9yT3B0aW9ucywgewogICAgJ3VzZUhhcyc6IGZhbHNlCiAgfSk7CgogIC8qKgogICAqIEl0ZXJhdGVzIG92ZXIgYW4gb2JqZWN0J3Mgb3duIGVudW1lcmFibGUgcHJvcGVydGllcywgZXhlY3V0aW5nIHRoZSBgY2FsbGJhY2tgCiAgICogZm9yIGVhY2ggcHJvcGVydHkuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICogYXJndW1lbnRzOyAodmFsdWUsIGtleSwgb2JqZWN0KS4gQ2FsbGJhY2tzIG1heSBleGl0IGl0ZXJhdGlvbiBlYXJseSBieSBleHBsaWNpdGx5CiAgICogcmV0dXJuaW5nIGBmYWxzZWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZm9yT3duKHsgJzAnOiAnemVybycsICcxJzogJ29uZScsICdsZW5ndGgnOiAyIH0sIGZ1bmN0aW9uKG51bSwga2V5KSB7CiAgICogICBhbGVydChrZXkpOwogICAqIH0pOwogICAqIC8vID0+IGFsZXJ0cyAnMCcsICcxJywgYW5kICdsZW5ndGgnIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICB2YXIgZm9yT3duID0gY3JlYXRlSXRlcmF0b3IoZWFjaEl0ZXJhdG9yT3B0aW9ucywgZm9yT3duSXRlcmF0b3JPcHRpb25zKTsKCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYW4gYXJyYXkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGFuIGFycmF5LCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIChmdW5jdGlvbigpIHsgcmV0dXJuIF8uaXNBcnJheShhcmd1bWVudHMpOyB9KSgpOwogICAqIC8vID0+IGZhbHNlCiAgICoKICAgKiBfLmlzQXJyYXkoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgdmFyIGlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAvLyBgaW5zdGFuY2VvZmAgbWF5IGNhdXNlIGEgbWVtb3J5IGxlYWsgaW4gSUUgNyBpZiBgdmFsdWVgIGlzIGEgaG9zdCBvYmplY3QKICAgIC8vIGh0dHA6Ly9hamF4aWFuLmNvbS9hcmNoaXZlcy93b3JraW5nLWFyb3VuZy10aGUtaW5zdGFuY2VvZi1tZW1vcnktbGVhawogICAgcmV0dXJuIChhcmdzQXJlT2JqZWN0cyAmJiB2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBhcnJheUNsYXNzOwogIH07CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgY29tcG9zZWQgb2YgdGhlIG93biBlbnVtZXJhYmxlIHByb3BlcnR5IG5hbWVzIG9mIGBvYmplY3RgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ua2V5cyh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgKiAvLyA9PiBbJ29uZScsICd0d28nLCAndGhyZWUnXSAob3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpCiAgICovCiAgdmFyIGtleXMgPSAhbmF0aXZlS2V5cyA/IHNoaW1LZXlzIDogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAvLyBhdm9pZCBpdGVyYXRpbmcgb3ZlciB0aGUgYHByb3RvdHlwZWAgcHJvcGVydHkKICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09ICdmdW5jdGlvbicgJiYgcHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChvYmplY3QsICdwcm90b3R5cGUnKQogICAgICA/IHNoaW1LZXlzKG9iamVjdCkKICAgICAgOiAoaXNPYmplY3Qob2JqZWN0KSA/IG5hdGl2ZUtleXMob2JqZWN0KSA6IFtdKTsKICB9OwoKICAvKioKICAgKiBBIGZhbGxiYWNrIGltcGxlbWVudGF0aW9uIG9mIGBpc1BsYWluT2JqZWN0YCB0aGF0IGNoZWNrcyBpZiBhIGdpdmVuIGB2YWx1ZWAKICAgKiBpcyBhbiBvYmplY3QgY3JlYXRlZCBieSB0aGUgYE9iamVjdGAgY29uc3RydWN0b3IsIGFzc3VtaW5nIG9iamVjdHMgY3JlYXRlZAogICAqIGJ5IHRoZSBgT2JqZWN0YCBjb25zdHJ1Y3RvciBoYXZlIG5vIGluaGVyaXRlZCBlbnVtZXJhYmxlIHByb3BlcnRpZXMgYW5kIHRoYXQKICAgKiB0aGVyZSBhcmUgbm8gYE9iamVjdC5wcm90b3R5cGVgIGV4dGVuc2lvbnMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIGB2YWx1ZWAgaXMgYSBwbGFpbiBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgKi8KICBmdW5jdGlvbiBzaGltSXNQbGFpbk9iamVjdCh2YWx1ZSkgewogICAgLy8gYXZvaWQgbm9uLW9iamVjdHMgYW5kIGZhbHNlIHBvc2l0aXZlcyBmb3IgYGFyZ3VtZW50c2Agb2JqZWN0cwogICAgdmFyIHJlc3VsdCA9IGZhbHNlOwogICAgaWYgKCEodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnKSB8fCBpc0FyZ3VtZW50cyh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8vIGNoZWNrIHRoYXQgdGhlIGNvbnN0cnVjdG9yIGlzIGBPYmplY3RgIChpLmUuIGBPYmplY3QgaW5zdGFuY2VvZiBPYmplY3RgKQogICAgdmFyIGN0b3IgPSB2YWx1ZS5jb25zdHJ1Y3RvcjsKICAgIGlmICgoIWlzRnVuY3Rpb24oY3RvcikgJiYgKCFub05vZGVDbGFzcyB8fCAhaXNOb2RlKHZhbHVlKSkpIHx8IGN0b3IgaW5zdGFuY2VvZiBjdG9yKSB7CiAgICAgIC8vIElFIDwgOSBpdGVyYXRlcyBpbmhlcml0ZWQgcHJvcGVydGllcyBiZWZvcmUgb3duIHByb3BlcnRpZXMuIElmIHRoZSBmaXJzdAogICAgICAvLyBpdGVyYXRlZCBwcm9wZXJ0eSBpcyBhbiBvYmplY3QncyBvd24gcHJvcGVydHkgdGhlbiB0aGVyZSBhcmUgbm8gaW5oZXJpdGVkCiAgICAgIC8vIGVudW1lcmFibGUgcHJvcGVydGllcy4KICAgICAgaWYgKGl0ZXJhdGVzT3duTGFzdCkgewogICAgICAgIGZvckluKHZhbHVlLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICAgIHJlc3VsdCA9ICFoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0ID09PSBmYWxzZTsKICAgICAgfQogICAgICAvLyBJbiBtb3N0IGVudmlyb25tZW50cyBhbiBvYmplY3QncyBvd24gcHJvcGVydGllcyBhcmUgaXRlcmF0ZWQgYmVmb3JlCiAgICAgIC8vIGl0cyBpbmhlcml0ZWQgcHJvcGVydGllcy4gSWYgdGhlIGxhc3QgaXRlcmF0ZWQgcHJvcGVydHkgaXMgYW4gb2JqZWN0J3MKICAgICAgLy8gb3duIHByb3BlcnR5IHRoZW4gdGhlcmUgYXJlIG5vIGluaGVyaXRlZCBlbnVtZXJhYmxlIHByb3BlcnRpZXMuCiAgICAgIGZvckluKHZhbHVlLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgcmVzdWx0ID0ga2V5OwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdCA9PT0gZmFsc2UgfHwgaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgcmVzdWx0KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBBIGZhbGxiYWNrIGltcGxlbWVudGF0aW9uIG9mIGBPYmplY3Qua2V5c2AgdGhhdCBwcm9kdWNlcyBhbiBhcnJheSBvZiB0aGUKICAgKiBnaXZlbiBvYmplY3QncyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0eSBuYW1lcy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHByb3BlcnR5IG5hbWVzLgogICAqLwogIGZ1bmN0aW9uIHNoaW1LZXlzKG9iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yT3duKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICByZXN1bHQucHVzaChrZXkpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogVXNlZCB0byBjb252ZXJ0IGNoYXJhY3RlcnMgdG8gSFRNTCBlbnRpdGllczoKICAgKgogICAqIFRob3VnaCB0aGUgYD5gIGNoYXJhY3RlciBpcyBlc2NhcGVkIGZvciBzeW1tZXRyeSwgY2hhcmFjdGVycyBsaWtlIGA+YCBhbmQgYC9gCiAgICogZG9uJ3QgcmVxdWlyZSBlc2NhcGluZyBpbiBIVE1MIGFuZCBoYXZlIG5vIHNwZWNpYWwgbWVhbmluZyB1bmxlc3MgdGhleSdyZSBwYXJ0CiAgICogb2YgYSB0YWcgb3IgYW4gdW5xdW90ZWQgYXR0cmlidXRlIHZhbHVlLgogICAqIGh0dHA6Ly9tYXRoaWFzYnluZW5zLmJlL25vdGVzL2FtYmlndW91cy1hbXBlcnNhbmRzICh1bmRlciAic2VtaS1yZWxhdGVkIGZ1biBmYWN0IikKICAgKi8KICB2YXIgaHRtbEVzY2FwZXMgPSB7CiAgICAnJic6ICcmYW1wOycsCiAgICAnPCc6ICcmbHQ7JywKICAgICc+JzogJyZndDsnLAogICAgJyInOiAnJnF1b3Q7JywKICAgICInIjogJyYjeDI3OycKICB9OwoKICAvKiogVXNlZCB0byBjb252ZXJ0IEhUTUwgZW50aXRpZXMgdG8gY2hhcmFjdGVycyAqLwogIHZhciBodG1sVW5lc2NhcGVzID0gaW52ZXJ0KGh0bWxFc2NhcGVzKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIEFzc2lnbnMgb3duIGVudW1lcmFibGUgcHJvcGVydGllcyBvZiBzb3VyY2Ugb2JqZWN0KHMpIHRvIHRoZSBgZGVzdGluYXRpb25gCiAgICogb2JqZWN0LiBTdWJzZXF1ZW50IHNvdXJjZXMgd2lsbCBvdmVyd3JpdGUgcHJvcGVyeSBhc3NpZ25tZW50cyBvZiBwcmV2aW91cwogICAqIHNvdXJjZXMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgZXh0ZW5kCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICogQHBhcmFtIHtPYmplY3R9IFtzb3VyY2UxLCBzb3VyY2UyLCAuLi5dIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gSW50ZXJuYWxseSB1c2VkIHRvIGFsbG93IHRoaXMgbWV0aG9kIHRvIHdvcmsgd2l0aAogICAqICBgXy5yZWR1Y2VgIHdpdGhvdXQgdXNpbmcgaXRzIGNhbGxiYWNrJ3MgYGtleSBhbmQgYG9iamVjdGAgYXJndW1lbnRzIGFzIHNvdXJjZXMuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmFzc2lnbih7ICduYW1lJzogJ21vZScgfSwgeyAnYWdlJzogNDAgfSk7CiAgICogLy8gPT4geyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfQogICAqLwogIHZhciBhc3NpZ24gPSBjcmVhdGVJdGVyYXRvcihhc3NpZ25JdGVyYXRvck9wdGlvbnMpOwoKICAvKioKICAgKiBDcmVhdGVzIGEgY2xvbmUgb2YgYHZhbHVlYC4gSWYgYGRlZXBgIGlzIGB0cnVlYCwgbmVzdGVkIG9iamVjdHMgd2lsbCBhbHNvCiAgICogYmUgY2xvbmVkLCBvdGhlcndpc2UgdGhleSB3aWxsIGJlIGFzc2lnbmVkIGJ5IHJlZmVyZW5jZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNsb25lLgogICAqIEBwYXJhbSB7Qm9vbGVhbn0gZGVlcCBBIGZsYWcgdG8gaW5kaWNhdGUgYSBkZWVwIGNsb25lLgogICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBJbnRlcm5hbGx5IHVzZWQgdG8gYWxsb3cgdGhpcyBtZXRob2QgdG8gd29yayB3aXRoCiAgICogIG90aGVycyBsaWtlIGBfLm1hcGAgd2l0aG91dCB1c2luZyB0aGVpciBjYWxsYmFjayBgaW5kZXhgIGFyZ3VtZW50IGZvciBgZGVlcGAuCiAgICogQHBhcmFtLSB7QXJyYXl9IFtzdGFja0E9W11dIEludGVybmFsbHkgdXNlZCB0byB0cmFjayB0cmF2ZXJzZWQgc291cmNlIG9iamVjdHMuCiAgICogQHBhcmFtLSB7QXJyYXl9IFtzdGFja0I9W11dIEludGVybmFsbHkgdXNlZCB0byBhc3NvY2lhdGUgY2xvbmVzIHdpdGggdGhlaXIKICAgKiAgc291cmNlIGNvdW50ZXJwYXJ0cy4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGNsb25lZCBgdmFsdWVgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICogICB7ICduYW1lJzogJ2xhcnJ5JywgJ2FnZSc6IDUwIH0sCiAgICogICB7ICduYW1lJzogJ2N1cmx5JywgJ2FnZSc6IDYwIH0KICAgKiBdOwogICAqCiAgICogdmFyIHNoYWxsb3cgPSBfLmNsb25lKHN0b29nZXMpOwogICAqIHNoYWxsb3dbMF0gPT09IHN0b29nZXNbMF07CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogdmFyIGRlZXAgPSBfLmNsb25lKHN0b29nZXMsIHRydWUpOwogICAqIGRlZXBbMF0gPT09IHN0b29nZXNbMF07CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBjbG9uZSh2YWx1ZSwgZGVlcCwgZ3VhcmQsIHN0YWNrQSwgc3RhY2tCKSB7CiAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBpZiAoZ3VhcmQpIHsKICAgICAgZGVlcCA9IGZhbHNlOwogICAgfQogICAgLy8gaW5zcGVjdCBbW0NsYXNzXV0KICAgIHZhciBpc09iaiA9IGlzT2JqZWN0KHZhbHVlKTsKICAgIGlmIChpc09iaikgewogICAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbCh2YWx1ZSk7CiAgICAgIGlmICghY2xvbmVhYmxlQ2xhc3Nlc1tjbGFzc05hbWVdIHx8IChub05vZGVDbGFzcyAmJiBpc05vZGUodmFsdWUpKSkgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICB2YXIgaXNBcnIgPSBpc0FycmF5KHZhbHVlKTsKICAgIH0KICAgIC8vIHNoYWxsb3cgY2xvbmUKICAgIGlmICghaXNPYmogfHwgIWRlZXApIHsKICAgICAgcmV0dXJuIGlzT2JqCiAgICAgICAgPyAoaXNBcnIgPyBzbGljZSh2YWx1ZSkgOiBhc3NpZ24oe30sIHZhbHVlKSkKICAgICAgICA6IHZhbHVlOwogICAgfQogICAgdmFyIGN0b3IgPSBjdG9yQnlDbGFzc1tjbGFzc05hbWVdOwogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgICAgY2FzZSBib29sQ2xhc3M6CiAgICAgIGNhc2UgZGF0ZUNsYXNzOgogICAgICAgIHJldHVybiBuZXcgY3RvcigrdmFsdWUpOwoKICAgICAgY2FzZSBudW1iZXJDbGFzczoKICAgICAgY2FzZSBzdHJpbmdDbGFzczoKICAgICAgICByZXR1cm4gbmV3IGN0b3IodmFsdWUpOwoKICAgICAgY2FzZSByZWdleHBDbGFzczoKICAgICAgICByZXR1cm4gY3Rvcih2YWx1ZS5zb3VyY2UsIHJlRmxhZ3MuZXhlYyh2YWx1ZSkpOwogICAgfQogICAgLy8gY2hlY2sgZm9yIGNpcmN1bGFyIHJlZmVyZW5jZXMgYW5kIHJldHVybiBjb3JyZXNwb25kaW5nIGNsb25lCiAgICBzdGFja0EgfHwgKHN0YWNrQSA9IFtdKTsKICAgIHN0YWNrQiB8fCAoc3RhY2tCID0gW10pOwoKICAgIHZhciBsZW5ndGggPSBzdGFja0EubGVuZ3RoOwogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIGlmIChzdGFja0FbbGVuZ3RoXSA9PSB2YWx1ZSkgewogICAgICAgIHJldHVybiBzdGFja0JbbGVuZ3RoXTsKICAgICAgfQogICAgfQogICAgLy8gaW5pdCBjbG9uZWQgb2JqZWN0CiAgICB2YXIgcmVzdWx0ID0gaXNBcnIgPyBjdG9yKHZhbHVlLmxlbmd0aCkgOiB7fTsKCiAgICAvLyBhZGQgdGhlIHNvdXJjZSB2YWx1ZSB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMKICAgIC8vIGFuZCBhc3NvY2lhdGUgaXQgd2l0aCBpdHMgY2xvbmUKICAgIHN0YWNrQS5wdXNoKHZhbHVlKTsKICAgIHN0YWNrQi5wdXNoKHJlc3VsdCk7CgogICAgLy8gcmVjdXJzaXZlbHkgcG9wdWxhdGUgY2xvbmUgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKQogICAgKGlzQXJyID8gZm9yRWFjaCA6IGZvck93bikodmFsdWUsIGZ1bmN0aW9uKG9ialZhbHVlLCBrZXkpIHsKICAgICAgcmVzdWx0W2tleV0gPSBjbG9uZShvYmpWYWx1ZSwgZGVlcCwgbnVsbCwgc3RhY2tBLCBzdGFja0IpOwogICAgfSk7CgogICAgLy8gYWRkIGFycmF5IHByb3BlcnRpZXMgYXNzaWduZWQgYnkgYFJlZ0V4cCNleGVjYAogICAgaWYgKGlzQXJyKSB7CiAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCAnaW5kZXgnKSkgewogICAgICAgIHJlc3VsdC5pbmRleCA9IHZhbHVlLmluZGV4OwogICAgICB9CiAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCAnaW5wdXQnKSkgewogICAgICAgIHJlc3VsdC5pbnB1dCA9IHZhbHVlLmlucHV0OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIGRlZXAgY2xvbmUgb2YgYHZhbHVlYC4gRnVuY3Rpb25zIGFuZCBET00gbm9kZXMgYXJlICoqbm90KiogY2xvbmVkLgogICAqIFRoZSBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2YgYGFyZ3VtZW50c2Agb2JqZWN0cyBhbmQgb2JqZWN0cyBjcmVhdGVkIGJ5CiAgICogY29uc3RydWN0b3JzIG90aGVyIHRoYW4gYE9iamVjdGAgYXJlIGNsb25lZCB0byBwbGFpbiBgT2JqZWN0YCBvYmplY3RzLgogICAqCiAgICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyBsb29zZWx5IGJhc2VkIG9uIHRoZSBzdHJ1Y3R1cmVkIGNsb25lIGFsZ29yaXRobS4KICAgKiBTZWUgaHR0cDovL3d3dy53My5vcmcvVFIvaHRtbDUvaW5mcmFzdHJ1Y3R1cmUuaHRtbCNpbnRlcm5hbC1zdHJ1Y3R1cmVkLWNsb25pbmctYWxnb3JpdGhtLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gZGVlcCBjbG9uZS4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGRlZXAgY2xvbmVkIGB2YWx1ZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBzdG9vZ2VzID0gWwogICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfSwKICAgKiAgIHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfQogICAqIF07CiAgICoKICAgKiB2YXIgZGVlcCA9IF8uY2xvbmVEZWVwKHN0b29nZXMpOwogICAqIGRlZXBbMF0gPT09IHN0b29nZXNbMF07CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBjbG9uZURlZXAodmFsdWUpIHsKICAgIHJldHVybiBjbG9uZSh2YWx1ZSwgdHJ1ZSk7CiAgfQoKICAvKioKICAgKiBBc3NpZ25zIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2Ygc291cmNlIG9iamVjdChzKSB0byB0aGUgYGRlc3RpbmF0aW9uYAogICAqIG9iamVjdCBmb3IgYWxsIGBkZXN0aW5hdGlvbmAgcHJvcGVydGllcyB0aGF0IHJlc29sdmUgdG8gYG51bGxgL2B1bmRlZmluZWRgLgogICAqIE9uY2UgYSBwcm9wZXJ0eSBpcyBzZXQsIGFkZGl0aW9uYWwgZGVmYXVsdHMgb2YgdGhlIHNhbWUgcHJvcGVydHkgd2lsbCBiZQogICAqIGlnbm9yZWQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgKiBAcGFyYW0ge09iamVjdH0gW3NvdXJjZTEsIHNvdXJjZTIsIC4uLl0gVGhlIHNvdXJjZSBvYmplY3RzLgogICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBJbnRlcm5hbGx5IHVzZWQgdG8gYWxsb3cgdGhpcyBtZXRob2QgdG8gd29yayB3aXRoCiAgICogIGBfLnJlZHVjZWAgd2l0aG91dCB1c2luZyBpdHMgY2FsbGJhY2sncyBga2V5YCBhbmQgYG9iamVjdGAgYXJndW1lbnRzIGFzIHNvdXJjZXMuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgaWNlQ3JlYW0gPSB7ICdmbGF2b3InOiAnY2hvY29sYXRlJyB9OwogICAqIF8uZGVmYXVsdHMoaWNlQ3JlYW0sIHsgJ2ZsYXZvcic6ICd2YW5pbGxhJywgJ3Nwcmlua2xlcyc6ICdyYWluYm93JyB9KTsKICAgKiAvLyA9PiB7ICdmbGF2b3InOiAnY2hvY29sYXRlJywgJ3Nwcmlua2xlcyc6ICdyYWluYm93JyB9CiAgICovCiAgdmFyIGRlZmF1bHRzID0gY3JlYXRlSXRlcmF0b3IoYXNzaWduSXRlcmF0b3JPcHRpb25zLCB7CiAgICAnbG9vcCc6ICdpZiAocmVzdWx0W2luZGV4XSA9PSBudWxsKSAnICsgYXNzaWduSXRlcmF0b3JPcHRpb25zLmxvb3AKICB9KTsKCiAgLyoqCiAgICogQ3JlYXRlcyBhIHNvcnRlZCBhcnJheSBvZiBhbGwgZW51bWVyYWJsZSBwcm9wZXJ0aWVzLCBvd24gYW5kIGluaGVyaXRlZCwKICAgKiBvZiBgb2JqZWN0YCB0aGF0IGhhdmUgZnVuY3Rpb24gdmFsdWVzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIG1ldGhvZHMKICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcyB0aGF0IGhhdmUgZnVuY3Rpb24gdmFsdWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmZ1bmN0aW9ucyhfKTsKICAgKiAvLyA9PiBbJ2FsbCcsICdhbnknLCAnYmluZCcsICdiaW5kQWxsJywgJ2Nsb25lJywgJ2NvbXBhY3QnLCAnY29tcG9zZScsIC4uLl0KICAgKi8KICBmdW5jdGlvbiBmdW5jdGlvbnMob2JqZWN0KSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBmb3JJbihvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnNvcnQoKTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBgcHJvcGVydHlgIGV4aXN0cyBhbmQgaXMgYSBkaXJlY3QgcHJvcGVydHksCiAgICogaW5zdGVhZCBvZiBhbiBpbmhlcml0ZWQgcHJvcGVydHkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBjaGVjay4KICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgVGhlIHByb3BlcnR5IHRvIGNoZWNrIGZvci4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYga2V5IGlzIGEgZGlyZWN0IHByb3BlcnR5LCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaGFzKHsgJ2EnOiAxLCAnYic6IDIsICdjJzogMyB9LCAnYicpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBoYXMob2JqZWN0LCBwcm9wZXJ0eSkgewogICAgcmV0dXJuIG9iamVjdCA/IGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBwcm9wZXJ0eSkgOiBmYWxzZTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIHRoZSBpbnZlcnRlZCBrZXlzIGFuZCB2YWx1ZXMgb2YgdGhlIGdpdmVuIGBvYmplY3RgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW52ZXJ0LgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGNyZWF0ZWQgaW52ZXJ0ZWQgb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgXy5pbnZlcnQoeyAnZmlyc3QnOiAnTW9lJywgJ3NlY29uZCc6ICdMYXJyeScsICd0aGlyZCc6ICdDdXJseScgfSk7CiAgICogLy8gPT4geyAnTW9lJzogJ2ZpcnN0JywgJ0xhcnJ5JzogJ3NlY29uZCcsICdDdXJseSc6ICd0aGlyZCcgfSAob3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpCiAgICovCiAgZnVuY3Rpb24gaW52ZXJ0KG9iamVjdCkgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgcHJvcHMgPSBrZXlzKG9iamVjdCksCiAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoLAogICAgICAgIHJlc3VsdCA9IHt9OwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciBrZXkgPSBwcm9wc1tpbmRleF07CiAgICAgIHJlc3VsdFtvYmplY3Rba2V5XV0gPSBrZXk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBib29sZWFuIHZhbHVlLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhIGJvb2xlYW4gdmFsdWUsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc0Jvb2xlYW4obnVsbCk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gYm9vbENsYXNzOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBkYXRlLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBhIGRhdGUsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc0RhdGUobmV3IERhdGUpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc0RhdGUodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIERhdGUgfHwgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gZGF0ZUNsYXNzOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBET00gZWxlbWVudC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYSBET00gZWxlbWVudCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzRWxlbWVudChkb2N1bWVudC5ib2R5KTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNFbGVtZW50KHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPyB2YWx1ZS5ub2RlVHlwZSA9PT0gMSA6IGZhbHNlOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgZW1wdHkuIEFycmF5cywgc3RyaW5ncywgb3IgYGFyZ3VtZW50c2Agb2JqZWN0cyB3aXRoIGEKICAgKiBsZW5ndGggb2YgYDBgIGFuZCBvYmplY3RzIHdpdGggbm8gb3duIGVudW1lcmFibGUgcHJvcGVydGllcyBhcmUgY29uc2lkZXJlZAogICAqICJlbXB0eSIuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gdmFsdWUgVGhlIHZhbHVlIHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBlbXB0eSwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzRW1wdHkoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc0VtcHR5KHt9KTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzRW1wdHkoJycpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc0VtcHR5KHZhbHVlKSB7CiAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgIGlmICghdmFsdWUpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKHZhbHVlKSwKICAgICAgICBsZW5ndGggPSB2YWx1ZS5sZW5ndGg7CgogICAgaWYgKChjbGFzc05hbWUgPT0gYXJyYXlDbGFzcyB8fCBjbGFzc05hbWUgPT0gc3RyaW5nQ2xhc3MgfHwKICAgICAgICBjbGFzc05hbWUgPT0gYXJnc0NsYXNzIHx8IChub0FyZ3NDbGFzcyAmJiBpc0FyZ3VtZW50cyh2YWx1ZSkpKSB8fAogICAgICAgIChjbGFzc05hbWUgPT0gb2JqZWN0Q2xhc3MgJiYgdHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyAmJiBpc0Z1bmN0aW9uKHZhbHVlLnNwbGljZSkpKSB7CiAgICAgIHJldHVybiAhbGVuZ3RoOwogICAgfQogICAgZm9yT3duKHZhbHVlLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIChyZXN1bHQgPSBmYWxzZSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBQZXJmb3JtcyBhIGRlZXAgY29tcGFyaXNvbiBiZXR3ZWVuIHR3byB2YWx1ZXMgdG8gZGV0ZXJtaW5lIGlmIHRoZXkgYXJlCiAgICogZXF1aXZhbGVudCB0byBlYWNoIG90aGVyLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSBhIFRoZSB2YWx1ZSB0byBjb21wYXJlLgogICAqIEBwYXJhbSB7TWl4ZWR9IGIgVGhlIG90aGVyIHZhbHVlIHRvIGNvbXBhcmUuCiAgICogQHBhcmFtLSB7T2JqZWN0fSBbc3RhY2tBPVtdXSBJbnRlcm5hbGx5IHVzZWQgdHJhY2sgdHJhdmVyc2VkIGBhYCBvYmplY3RzLgogICAqIEBwYXJhbS0ge09iamVjdH0gW3N0YWNrQj1bXV0gSW50ZXJuYWxseSB1c2VkIHRyYWNrIHRyYXZlcnNlZCBgYmAgb2JqZWN0cy4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSB2YWx1ZXMgYXJlIGVxdXZhbGVudCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbW9lID0geyAnbmFtZSc6ICdtb2UnLCAnbHVja3lOdW1iZXJzJzogWzEzLCAyNywgMzRdIH07CiAgICogdmFyIGNsb25lID0geyAnbmFtZSc6ICdtb2UnLCAnbHVja3lOdW1iZXJzJzogWzEzLCAyNywgMzRdIH07CiAgICoKICAgKiBtb2UgPT0gY2xvbmU7CiAgICogLy8gPT4gZmFsc2UKICAgKgogICAqIF8uaXNFcXVhbChtb2UsIGNsb25lKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNFcXVhbChhLCBiLCBzdGFja0EsIHN0YWNrQikgewogICAgLy8gZXhpdCBlYXJseSBmb3IgaWRlbnRpY2FsIHZhbHVlcwogICAgaWYgKGEgPT09IGIpIHsKICAgICAgLy8gdHJlYXQgYCswYCB2cy4gYC0wYCBhcyBub3QgZXF1YWwKICAgICAgcmV0dXJuIGEgIT09IDAgfHwgKDEgLyBhID09IDEgLyBiKTsKICAgIH0KICAgIC8vIGV4aXQgZWFybHkgZm9yIHVubGlrZSBgbnVsbGAgb3IgYHVuZGVmaW5lZGAgdmFsdWVzCiAgICBpZiAoYSA9PSBudWxsIHx8IGIgPT0gbnVsbCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvLyBjb21wYXJlIFtbQ2xhc3NdXSBuYW1lcwogICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSksCiAgICAgICAgb3RoZXJOYW1lID0gdG9TdHJpbmcuY2FsbChiKTsKCiAgICBpZiAoY2xhc3NOYW1lID09IGFyZ3NDbGFzcykgewogICAgICBjbGFzc05hbWUgPSBvYmplY3RDbGFzczsKICAgIH0KICAgIGlmIChvdGhlck5hbWUgPT0gYXJnc0NsYXNzKSB7CiAgICAgIG90aGVyTmFtZSA9IG9iamVjdENsYXNzOwogICAgfQogICAgaWYgKGNsYXNzTmFtZSAhPSBvdGhlck5hbWUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgICAgY2FzZSBib29sQ2xhc3M6CiAgICAgIGNhc2UgZGF0ZUNsYXNzOgogICAgICAgIC8vIGNvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtYmVycywgZGF0ZXMgdG8gbWlsbGlzZWNvbmRzIGFuZCBib29sZWFucwogICAgICAgIC8vIHRvIGAxYCBvciBgMGAsIHRyZWF0aW5nIGludmFsaWQgZGF0ZXMgY29lcmNlZCB0byBgTmFOYCBhcyBub3QgZXF1YWwKICAgICAgICByZXR1cm4gK2EgPT0gK2I7CgogICAgICBjYXNlIG51bWJlckNsYXNzOgogICAgICAgIC8vIHRyZWF0IGBOYU5gIHZzLiBgTmFOYCBhcyBlcXVhbAogICAgICAgIHJldHVybiBhICE9ICthCiAgICAgICAgICA/IGIgIT0gK2IKICAgICAgICAgIC8vIGJ1dCB0cmVhdCBgKzBgIHZzLiBgLTBgIGFzIG5vdCBlcXVhbAogICAgICAgICAgOiAoYSA9PSAwID8gKDEgLyBhID09IDEgLyBiKSA6IGEgPT0gK2IpOwoKICAgICAgY2FzZSByZWdleHBDbGFzczoKICAgICAgY2FzZSBzdHJpbmdDbGFzczoKICAgICAgICAvLyBjb2VyY2UgcmVnZXhlcyB0byBzdHJpbmdzIChodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxNS4xMC42LjQpCiAgICAgICAgLy8gdHJlYXQgc3RyaW5nIHByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IGluc3RhbmNlcyBhcyBlcXVhbAogICAgICAgIHJldHVybiBhID09IGIgKyAnJzsKICAgIH0KICAgIHZhciBpc0FyciA9IGNsYXNzTmFtZSA9PSBhcnJheUNsYXNzOwogICAgaWYgKCFpc0FycikgewogICAgICAvLyB1bndyYXAgYW55IGBsb2Rhc2hgIHdyYXBwZWQgdmFsdWVzCiAgICAgIGlmIChhLl9fd3JhcHBlZF9fIHx8IGIuX193cmFwcGVkX18pIHsKICAgICAgICByZXR1cm4gaXNFcXVhbChhLl9fd3JhcHBlZF9fIHx8IGEsIGIuX193cmFwcGVkX18gfHwgYik7CiAgICAgIH0KICAgICAgLy8gZXhpdCBmb3IgZnVuY3Rpb25zIGFuZCBET00gbm9kZXMKICAgICAgaWYgKGNsYXNzTmFtZSAhPSBvYmplY3RDbGFzcyB8fCAobm9Ob2RlQ2xhc3MgJiYgKGlzTm9kZShhKSB8fCBpc05vZGUoYikpKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBpbiBvbGRlciB2ZXJzaW9ucyBvZiBPcGVyYSwgYGFyZ3VtZW50c2Agb2JqZWN0cyBoYXZlIGBBcnJheWAgY29uc3RydWN0b3JzCiAgICAgIHZhciBjdG9yQSA9ICFhcmdzQXJlT2JqZWN0cyAmJiBpc0FyZ3VtZW50cyhhKSA/IE9iamVjdCA6IGEuY29uc3RydWN0b3IsCiAgICAgICAgICBjdG9yQiA9ICFhcmdzQXJlT2JqZWN0cyAmJiBpc0FyZ3VtZW50cyhiKSA/IE9iamVjdCA6IGIuY29uc3RydWN0b3I7CgogICAgICAvLyBub24gYE9iamVjdGAgb2JqZWN0IGluc3RhbmNlcyB3aXRoIGRpZmZlcmVudCBjb25zdHJ1Y3RvcnMgYXJlIG5vdCBlcXVhbAogICAgICBpZiAoY3RvckEgIT0gY3RvckIgJiYgISgKICAgICAgICAgICAgaXNGdW5jdGlvbihjdG9yQSkgJiYgY3RvckEgaW5zdGFuY2VvZiBjdG9yQSAmJgogICAgICAgICAgICBpc0Z1bmN0aW9uKGN0b3JCKSAmJiBjdG9yQiBpbnN0YW5jZW9mIGN0b3JCCiAgICAgICAgICApKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICAvLyBhc3N1bWUgY3ljbGljIHN0cnVjdHVyZXMgYXJlIGVxdWFsCiAgICAvLyB0aGUgYWxnb3JpdGhtIGZvciBkZXRlY3RpbmcgY3ljbGljIHN0cnVjdHVyZXMgaXMgYWRhcHRlZCBmcm9tIEVTIDUuMQogICAgLy8gc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYCAoaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuMTIuMykKICAgIHN0YWNrQSB8fCAoc3RhY2tBID0gW10pOwogICAgc3RhY2tCIHx8IChzdGFja0IgPSBbXSk7CgogICAgdmFyIGxlbmd0aCA9IHN0YWNrQS5sZW5ndGg7CiAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgaWYgKHN0YWNrQVtsZW5ndGhdID09IGEpIHsKICAgICAgICByZXR1cm4gc3RhY2tCW2xlbmd0aF0gPT0gYjsKICAgICAgfQogICAgfQogICAgdmFyIHJlc3VsdCA9IHRydWUsCiAgICAgICAgc2l6ZSA9IDA7CgogICAgLy8gYWRkIGBhYCBhbmQgYGJgIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgc3RhY2tBLnB1c2goYSk7CiAgICBzdGFja0IucHVzaChiKTsKCiAgICAvLyByZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cyAoc3VzY2VwdGlibGUgdG8gY2FsbCBzdGFjayBsaW1pdHMpCiAgICBpZiAoaXNBcnIpIHsKICAgICAgLy8gY29tcGFyZSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkKICAgICAgc2l6ZSA9IGEubGVuZ3RoOwogICAgICByZXN1bHQgPSBzaXplID09IGIubGVuZ3RoOwoKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIC8vIGRlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMKICAgICAgICB3aGlsZSAoc2l6ZS0tKSB7CiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBpc0VxdWFsKGFbc2l6ZV0sIGJbc2l6ZV0sIHN0YWNrQSwgc3RhY2tCKSkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvLyBkZWVwIGNvbXBhcmUgb2JqZWN0cyB1c2luZyBgZm9ySW5gLCBpbnN0ZWFkIG9mIGBmb3JPd25gLCB0byBhdm9pZCBgT2JqZWN0LmtleXNgCiAgICAvLyB3aGljaCwgaW4gdGhpcyBjYXNlLCBpcyBtb3JlIGNvc3RseQogICAgZm9ySW4oYSwgZnVuY3Rpb24odmFsdWUsIGtleSwgYSkgewogICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChhLCBrZXkpKSB7CiAgICAgICAgLy8gY291bnQgdGhlIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICAgIHNpemUrKzsKICAgICAgICAvLyBkZWVwIGNvbXBhcmUgZWFjaCBwcm9wZXJ0eSB2YWx1ZS4KICAgICAgICByZXR1cm4gKHJlc3VsdCA9IGhhc093blByb3BlcnR5LmNhbGwoYiwga2V5KSAmJiBpc0VxdWFsKHZhbHVlLCBiW2tleV0sIHN0YWNrQSwgc3RhY2tCKSk7CiAgICAgIH0KICAgIH0pOwoKICAgIGlmIChyZXN1bHQpIHsKICAgICAgLy8gZW5zdXJlIGJvdGggb2JqZWN0cyBoYXZlIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzCiAgICAgIGZvckluKGIsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGIpIHsKICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChiLCBrZXkpKSB7CiAgICAgICAgICAvLyBgc2l6ZWAgd2lsbCBiZSBgLTFgIGlmIGBiYCBoYXMgbW9yZSBwcm9wZXJ0aWVzIHRoYW4gYGFgCiAgICAgICAgICByZXR1cm4gKHJlc3VsdCA9IC0tc2l6ZSA+IC0xKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzLCBvciBjYW4gYmUgY29lcmNlZCB0bywgYSBmaW5pdGUgbnVtYmVyLgogICAqCiAgICogTm90ZTogVGhpcyBpcyBub3QgdGhlIHNhbWUgYXMgbmF0aXZlIGBpc0Zpbml0ZWAsIHdoaWNoIHdpbGwgcmV0dXJuIHRydWUgZm9yCiAgICogYm9vbGVhbnMgYW5kIGVtcHR5IHN0cmluZ3MuIFNlZSBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxNS4xLjIuNS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgZmluaXRlLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNGaW5pdGUoLTEwMSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc0Zpbml0ZSgnMTAnKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzRmluaXRlKHRydWUpOwogICAqIC8vID0+IGZhbHNlCiAgICoKICAgKiBfLmlzRmluaXRlKCcnKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc0Zpbml0ZShJbmZpbml0eSk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc0Zpbml0ZSh2YWx1ZSkgewogICAgcmV0dXJuIG5hdGl2ZUlzRmluaXRlKHZhbHVlKSAmJiAhbmF0aXZlSXNOYU4ocGFyc2VGbG9hdCh2YWx1ZSkpOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBmdW5jdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYSBmdW5jdGlvbiwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzRnVuY3Rpb24oXyk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ2Z1bmN0aW9uJzsKICB9CiAgLy8gZmFsbGJhY2sgZm9yIG9sZGVyIHZlcnNpb25zIG9mIENocm9tZSBhbmQgU2FmYXJpCiAgaWYgKGlzRnVuY3Rpb24oL3gvKSkgewogICAgaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIEZ1bmN0aW9uIHx8IHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGZ1bmNDbGFzczsKICAgIH07CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyB0aGUgbGFuZ3VhZ2UgdHlwZSBvZiBPYmplY3QuCiAgICogKGUuZy4gYXJyYXlzLCBmdW5jdGlvbnMsIG9iamVjdHMsIHJlZ2V4ZXMsIGBuZXcgTnVtYmVyKDApYCwgYW5kIGBuZXcgU3RyaW5nKCcnKWApCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGFuIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzT2JqZWN0KHt9KTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzT2JqZWN0KFsxLCAyLCAzXSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc09iamVjdCgxKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7CiAgICAvLyBjaGVjayBpZiB0aGUgdmFsdWUgaXMgdGhlIEVDTUFTY3JpcHQgbGFuZ3VhZ2UgdHlwZSBvZiBPYmplY3QKICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmNvbS8jeDgKICAgIC8vIGFuZCBhdm9pZCBhIFY4IGJ1ZwogICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL3Y4L2lzc3Vlcy9kZXRhaWw/aWQ9MjI5MQogICAgcmV0dXJuIHZhbHVlID8gb2JqZWN0VHlwZXNbdHlwZW9mIHZhbHVlXSA6IGZhbHNlOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYE5hTmAuCiAgICoKICAgKiBOb3RlOiBUaGlzIGlzIG5vdCB0aGUgc2FtZSBhcyBuYXRpdmUgYGlzTmFOYCwgd2hpY2ggd2lsbCByZXR1cm4gYHRydWVgIGZvcgogICAqIGB1bmRlZmluZWRgIGFuZCBvdGhlciB2YWx1ZXMuIFNlZSBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxNS4xLjIuNC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCwgaWYgdGhlIGB2YWx1ZWAgaXMgYE5hTmAsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc05hTihOYU4pOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNOYU4obmV3IE51bWJlcihOYU4pKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBpc05hTih1bmRlZmluZWQpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNOYU4odW5kZWZpbmVkKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGlzTmFOKHZhbHVlKSB7CiAgICAvLyBgTmFOYCBhcyBhIHByaW1pdGl2ZSBpcyB0aGUgb25seSB2YWx1ZSB0aGF0IGlzIG5vdCBlcXVhbCB0byBpdHNlbGYKICAgIC8vIChwZXJmb3JtIHRoZSBbW0NsYXNzXV0gY2hlY2sgZmlyc3QgdG8gYXZvaWQgZXJyb3JzIHdpdGggc29tZSBob3N0IG9iamVjdHMgaW4gSUUpCiAgICByZXR1cm4gaXNOdW1iZXIodmFsdWUpICYmIHZhbHVlICE9ICt2YWx1ZQogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYG51bGxgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBgbnVsbGAsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc051bGwobnVsbCk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc051bGwodW5kZWZpbmVkKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGlzTnVsbCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09PSBudWxsOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBudW1iZXIuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGEgbnVtYmVyLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNOdW1iZXIoOC40ICogNSk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzTnVtYmVyKHZhbHVlKSB7CiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInIHx8IHRvU3RyaW5nLmNhbGwodmFsdWUpID09IG51bWJlckNsYXNzOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGEgZ2l2ZW4gYHZhbHVlYCBpcyBhbiBvYmplY3QgY3JlYXRlZCBieSB0aGUgYE9iamVjdGAgY29uc3RydWN0b3IuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIGB2YWx1ZWAgaXMgYSBwbGFpbiBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogZnVuY3Rpb24gU3Rvb2dlKG5hbWUsIGFnZSkgewogICAqICAgdGhpcy5uYW1lID0gbmFtZTsKICAgKiAgIHRoaXMuYWdlID0gYWdlOwogICAqIH0KICAgKgogICAqIF8uaXNQbGFpbk9iamVjdChuZXcgU3Rvb2dlKCdtb2UnLCA0MCkpOwogICAqIC8vID0+IGZhbHNlCiAgICoKICAgKiBfLmlzUGxhaW5PYmplY3QoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc1BsYWluT2JqZWN0KHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0pOwogICAqIC8vID0+IHRydWUKICAgKi8KICB2YXIgaXNQbGFpbk9iamVjdCA9ICFnZXRQcm90b3R5cGVPZiA/IHNoaW1Jc1BsYWluT2JqZWN0IDogZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmICghKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JykpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdmFyIHZhbHVlT2YgPSB2YWx1ZS52YWx1ZU9mLAogICAgICAgIG9ialByb3RvID0gdHlwZW9mIHZhbHVlT2YgPT0gJ2Z1bmN0aW9uJyAmJiAob2JqUHJvdG8gPSBnZXRQcm90b3R5cGVPZih2YWx1ZU9mKSkgJiYgZ2V0UHJvdG90eXBlT2Yob2JqUHJvdG8pOwoKICAgIHJldHVybiBvYmpQcm90bwogICAgICA/IHZhbHVlID09IG9ialByb3RvIHx8IChnZXRQcm90b3R5cGVPZih2YWx1ZSkgPT0gb2JqUHJvdG8gJiYgIWlzQXJndW1lbnRzKHZhbHVlKSkKICAgICAgOiBzaGltSXNQbGFpbk9iamVjdCh2YWx1ZSk7CiAgfTsKCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSByZWd1bGFyIGV4cHJlc3Npb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGEgcmVndWxhciBleHByZXNzaW9uLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNSZWdFeHAoL21vZS8pOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc1JlZ0V4cCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUmVnRXhwIHx8IHRvU3RyaW5nLmNhbGwodmFsdWUpID09IHJlZ2V4cENsYXNzOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBzdHJpbmcuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAsIGlmIHRoZSBgdmFsdWVgIGlzIGEgc3RyaW5nLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNTdHJpbmcoJ21vZScpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJyB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBzdHJpbmdDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGB1bmRlZmluZWRgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgLCBpZiB0aGUgYHZhbHVlYCBpcyBgdW5kZWZpbmVkYCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzVW5kZWZpbmVkKHZvaWQgMCk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzVW5kZWZpbmVkKHZhbHVlKSB7CiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICd1bmRlZmluZWQnOwogIH0KCiAgLyoqCiAgICogUmVjdXJzaXZlbHkgbWVyZ2VzIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2YgdGhlIHNvdXJjZSBvYmplY3QocyksIHRoYXQKICAgKiBkb24ndCByZXNvbHZlIHRvIGB1bmRlZmluZWRgLCBpbnRvIHRoZSBgZGVzdGluYXRpb25gIG9iamVjdC4gU3Vic2VxdWVudCBzb3VyY2VzCiAgICogd2lsbCBvdmVyd3JpdGUgcHJvcGVyeSBhc3NpZ25tZW50cyBvZiBwcmV2aW91cyBzb3VyY2VzLiBJZiBhIGBjYWxsYmFja2AgZnVuY3Rpb24KICAgKiBpcyBwYXNzZWQsIGl0IHdpbGwgYmUgZXhlY3V0ZWQgdG8gcHJvZHVjZSB0aGUgbWVyZ2VkIHZhbHVlcyBvZiB0aGUgZGVzdGluYXRpb24KICAgKiBhbmQgc291cmNlIG9iamVjdCBwcm9wZXJ0aWVzLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgKiB3aXRoIHR3byBhcmd1bWVudHM7IChvYmplY3RWYWx1ZSwgc291cmNlVmFsdWUpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICogQHBhcmFtIHtPYmplY3R9IFtzb3VyY2UxLCBzb3VyY2UyLCAuLi5dIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiBjYWxsZWQgZm9yIGVhY2ggcHJvcGVydHkgdG8gbWVyZ2UuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEBwYXJhbS0ge09iamVjdH0gW2luZGljYXRvcl0gSW50ZXJuYWxseSB1c2VkIHRvIGluZGljYXRlIHRoYXQgdGhlIGBzdGFja2AKICAgKiAgYXJndW1lbnQgaXMgYW4gYXJyYXkgb2YgdHJhdmVyc2VkIG9iamVjdHMgaW5zdGVhZCBvZiBhbm90aGVyIHNvdXJjZSBvYmplY3QuCiAgICogQHBhcmFtLSB7QXJyYXl9IFtzdGFja0E9W11dIEludGVybmFsbHkgdXNlZCB0byB0cmFjayB0cmF2ZXJzZWQgc291cmNlIG9iamVjdHMuCiAgICogQHBhcmFtLSB7QXJyYXl9IFtzdGFja0I9W11dIEludGVybmFsbHkgdXNlZCB0byBhc3NvY2lhdGUgdmFsdWVzIHdpdGggdGhlaXIKICAgKiAgc291cmNlIGNvdW50ZXJwYXJ0cy4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBuYW1lcyA9IHsKICAgKiAgICdzdG9vZ2VzJzogWwogICAqICAgICB7ICduYW1lJzogJ21vZScgfSwKICAgKiAgICAgeyAnbmFtZSc6ICdsYXJyeScgfQogICAqICAgXQogICAqIH07CiAgICoKICAgKiB2YXIgYWdlcyA9IHsKICAgKiAgICdzdG9vZ2VzJzogWwogICAqICAgICB7ICdhZ2UnOiA0MCB9LAogICAqICAgICB7ICdhZ2UnOiA1MCB9CiAgICogICBdCiAgICogfTsKICAgKgogICAqIF8ubWVyZ2UobmFtZXMsIGFnZXMpOwogICAqIC8vID0+IHsgJ3N0b29nZXMnOiBbeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9XSB9CiAgICovCiAgZnVuY3Rpb24gbWVyZ2Uob2JqZWN0LCBzb3VyY2UsIGluZGljYXRvcikgewogICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgaW5kZXggPSAwLAogICAgICAgIGxlbmd0aCA9IDI7CgogICAgaWYgKCFvYmplY3QpIHsKICAgICAgcmV0dXJuIG9iamVjdDsKICAgIH0KICAgIGlmIChpbmRpY2F0b3IgPT09IGluZGljYXRvck9iamVjdCkgewogICAgICB2YXIgY2FsbGJhY2sgPSBhcmdzWzNdLAogICAgICAgICAgc3RhY2tBID0gYXJnc1s0XSwKICAgICAgICAgIHN0YWNrQiA9IGFyZ3NbNV07CiAgICB9CiAgICBlbHNlIHsKICAgICAgc3RhY2tBID0gW107CiAgICAgIHN0YWNrQiA9IFtdOwogICAgICBpZiAodHlwZW9mIGluZGljYXRvciAhPSAnbnVtYmVyJykgewogICAgICAgIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOwogICAgICAgIGNhbGxiYWNrID0gdHlwZW9mIChjYWxsYmFjayA9IGFyZ3NbbGVuZ3RoIC0gMl0pID09ICdmdW5jdGlvbicKICAgICAgICAgID8gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGFyZ3NbLS1sZW5ndGhdKQogICAgICAgICAgOiAodHlwZW9mIChjYWxsYmFjayA9IGFyZ3NbbGVuZ3RoIC0gMV0pID09ICdmdW5jdGlvbicgJiYgY2FsbGJhY2spOwogICAgICB9CiAgICB9CiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIgaXNBcnIgPSBpc0FycmF5KGFyZ3NbaW5kZXhdKTsKICAgICAgKGlzQXJyID8gZm9yRWFjaCA6IGZvck93bikoYXJnc1tpbmRleF0sIGZ1bmN0aW9uKHNvdXJjZSwga2V5KSB7CiAgICAgICAgdmFyIGZvdW5kLAogICAgICAgICAgICBpc09iaiwKICAgICAgICAgICAgdmFsdWUgPSBvYmplY3Rba2V5XTsKCiAgICAgICAgaWYgKHNvdXJjZSAmJiAoKGlzT2JqID0gaXNQbGFpbk9iamVjdChzb3VyY2UpKSB8fCBpc0FycmF5KHNvdXJjZSkpKSB7CiAgICAgICAgICAvLyBhdm9pZCBtZXJnaW5nIHByZXZpb3VzbHkgbWVyZ2VkIGN5Y2xpYyBzb3VyY2VzCiAgICAgICAgICB2YXIgc3RhY2tMZW5ndGggPSBzdGFja0EubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKHN0YWNrTGVuZ3RoLS0pIHsKICAgICAgICAgICAgaWYgKChmb3VuZCA9IHN0YWNrQVtzdGFja0xlbmd0aF0gPT0gc291cmNlKSkgewogICAgICAgICAgICAgIHZhbHVlID0gc3RhY2tCW3N0YWNrTGVuZ3RoXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFmb3VuZCkgewogICAgICAgICAgICB2YWx1ZSA9IGlzT2JqCiAgICAgICAgICAgICAgPyAoaXNQbGFpbk9iamVjdCh2YWx1ZSkgPyB2YWx1ZSA6IHt9KQogICAgICAgICAgICAgIDogKGlzQXJyYXkodmFsdWUpID8gdmFsdWUgOiBbXSk7CgogICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKHZhbHVlLCBzb3VyY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGFkZCBgc291cmNlYCBhbmQgYXNzb2NpYXRlZCBgdmFsdWVgIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgICAgICAgICBzdGFja0EucHVzaChzb3VyY2UpOwogICAgICAgICAgICBzdGFja0IucHVzaCh2YWx1ZSk7CgogICAgICAgICAgICAvLyByZWN1cnNpdmVseSBtZXJnZSBvYmplY3RzIGFuZCBhcnJheXMgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKQogICAgICAgICAgICB2YWx1ZSA9IHZhbHVlICYmIG1lcmdlKHZhbHVlLCBzb3VyY2UsIGluZGljYXRvck9iamVjdCwgY2FsbGJhY2ssIHN0YWNrQSwgc3RhY2tCKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgIHZhbHVlID0gY2FsbGJhY2sodmFsdWUsIHNvdXJjZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGlzQXJyIHx8IHR5cGVvZiBzb3VyY2UgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHZhbHVlID0gc291cmNlOwogICAgICAgIH0KICAgICAgICBvYmplY3Rba2V5XSA9IHZhbHVlOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBvYmplY3Q7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgc2hhbGxvdyBjbG9uZSBvZiBgb2JqZWN0YCBleGNsdWRpbmcgdGhlIHNwZWNpZmllZCBwcm9wZXJ0aWVzLgogICAqIFByb3BlcnR5IG5hbWVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzIG9mCiAgICogcHJvcGVydHkgbmFtZXMuIElmIGBjYWxsYmFja2AgaXMgcGFzc2VkLCBpdCB3aWxsIGJlIGV4ZWN1dGVkIGZvciBlYWNoIHByb3BlcnR5CiAgICogaW4gdGhlIGBvYmplY3RgLCBvbWl0dGluZyB0aGUgcHJvcGVydGllcyBgY2FsbGJhY2tgIHJldHVybnMgdHJ1dGh5IGZvci4gVGhlCiAgICogYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwga2V5LCBvYmplY3QpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBzb3VyY2Ugb2JqZWN0LgogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBjYWxsYmFja3xbcHJvcDEsIHByb3AyLCAuLi5dIFRoZSBwcm9wZXJ0aWVzIHRvIG9taXQKICAgKiAgb3IgdGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCB3aXRob3V0IHRoZSBvbWl0dGVkIHByb3BlcnRpZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ub21pdCh7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCwgJ3VzZXJpZCc6ICdtb2UxJyB9LCAndXNlcmlkJyk7CiAgICogLy8gPT4geyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfQogICAqCiAgICogXy5vbWl0KHsgJ25hbWUnOiAnbW9lJywgJ19oaW50JzogJ2tudWNrbGVoZWFkJywgJ19zZWVkJzogJzk2YzRlYicgfSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAqICAgcmV0dXJuIGtleS5jaGFyQXQoMCkgPT0gJ18nOwogICAqIH0pOwogICAqIC8vID0+IHsgJ25hbWUnOiAnbW9lJyB9CiAgICovCiAgZnVuY3Rpb24gb21pdChvYmplY3QsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgaXNGdW5jID0gdHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicsCiAgICAgICAgcmVzdWx0ID0ge307CgogICAgaWYgKGlzRnVuYykgewogICAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBwcm9wcyA9IGNvbmNhdC5hcHBseShhcnJheVJlZiwgYXJndW1lbnRzKTsKICAgIH0KICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSwgb2JqZWN0KSB7CiAgICAgIGlmIChpc0Z1bmMKICAgICAgICAgICAgPyAhY2FsbGJhY2sodmFsdWUsIGtleSwgb2JqZWN0KQogICAgICAgICAgICA6IGluZGV4T2YocHJvcHMsIGtleSwgMSkgPCAwCiAgICAgICAgICApIHsKICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgdHdvIGRpbWVuc2lvbmFsIGFycmF5IG9mIHRoZSBnaXZlbiBvYmplY3QncyBrZXktdmFsdWUgcGFpcnMsCiAgICogaS5lLiBgW1trZXkxLCB2YWx1ZTFdLCBba2V5MiwgdmFsdWUyXV1gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgbmV3IGFycmF5IG9mIGtleS12YWx1ZSBwYWlycy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5wYWlycyh7ICdtb2UnOiAzMCwgJ2xhcnJ5JzogNDAsICdjdXJseSc6IDUwIH0pOwogICAqIC8vID0+IFtbJ21vZScsIDMwXSwgWydsYXJyeScsIDQwXSwgWydjdXJseScsIDUwXV0gKG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAqLwogIGZ1bmN0aW9uIHBhaXJzKG9iamVjdCkgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgcHJvcHMgPSBrZXlzKG9iamVjdCksCiAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIGtleSA9IHByb3BzW2luZGV4XTsKICAgICAgcmVzdWx0W2luZGV4XSA9IFtrZXksIG9iamVjdFtrZXldXTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgc2hhbGxvdyBjbG9uZSBvZiBgb2JqZWN0YCBjb21wb3NlZCBvZiB0aGUgc3BlY2lmaWVkIHByb3BlcnRpZXMuCiAgICogUHJvcGVydHkgbmFtZXMgbWF5IGJlIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIGFyZ3VtZW50cyBvciBhcyBhcnJheXMgb2YgcHJvcGVydHkKICAgKiBuYW1lcy4gSWYgYGNhbGxiYWNrYCBpcyBwYXNzZWQsIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yIGVhY2ggcHJvcGVydHkgaW4gdGhlCiAgICogYG9iamVjdGAsIHBpY2tpbmcgdGhlIHByb3BlcnRpZXMgYGNhbGxiYWNrYCByZXR1cm5zIHRydXRoeSBmb3IuIFRoZSBgY2FsbGJhY2tgCiAgICogaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGtleSwgb2JqZWN0KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgc291cmNlIG9iamVjdC4KICAgKiBAcGFyYW0ge0FycmF5fEZ1bmN0aW9ufFN0cmluZ30gY2FsbGJhY2t8W3Byb3AxLCBwcm9wMiwgLi4uXSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICogIHBlciBpdGVyYXRpb24gb3IgcHJvcGVydGllcyB0byBwaWNrLCBlaXRoZXIgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXJyYXlzLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgcGlja2VkIHByb3BlcnRpZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ucGljayh7ICduYW1lJzogJ21vZScsICdfdXNlcmlkJzogJ21vZTEnIH0sICduYW1lJyk7CiAgICogLy8gPT4geyAnbmFtZSc6ICdtb2UnIH0KICAgKgogICAqIF8ucGljayh7ICduYW1lJzogJ21vZScsICdfdXNlcmlkJzogJ21vZTEnIH0sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgKiAgIHJldHVybiBrZXkuY2hhckF0KDApICE9ICdfJzsKICAgKiB9KTsKICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScgfQogICAqLwogIGZ1bmN0aW9uIHBpY2sob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAnZnVuY3Rpb24nKSB7CiAgICAgIHZhciBpbmRleCA9IDAsCiAgICAgICAgICBwcm9wcyA9IGNvbmNhdC5hcHBseShhcnJheVJlZiwgYXJndW1lbnRzKSwKICAgICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGtleSA9IHByb3BzW2luZGV4XTsKICAgICAgICBpZiAoa2V5IGluIG9iamVjdCkgewogICAgICAgICAgcmVzdWx0W2tleV0gPSBvYmplY3Rba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgICBmb3JJbihvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIG9iamVjdCkgewogICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwga2V5LCBvYmplY3QpKSB7CiAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBhcnJheSBjb21wb3NlZCBvZiB0aGUgb3duIGVudW1lcmFibGUgcHJvcGVydHkgdmFsdWVzIG9mIGBvYmplY3RgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgdmFsdWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnZhbHVlcyh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKi8KICBmdW5jdGlvbiB2YWx1ZXMob2JqZWN0KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBwcm9wcyA9IGtleXMob2JqZWN0KSwKICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGgsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICByZXN1bHRbaW5kZXhdID0gb2JqZWN0W3Byb3BzW2luZGV4XV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgZWxlbWVudHMgZnJvbSB0aGUgc3BlY2lmaWVkIGluZGV4KGVzKSwgb3Iga2V5cywgb2YgdGhlCiAgICogYGNvbGxlY3Rpb25gLiBJbmRleGVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzCiAgICogb2YgaW5kZXhlcy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtBcnJheXxOdW1iZXJ8U3RyaW5nfSBbaW5kZXgxLCBpbmRleDIsIC4uLl0gVGhlIGluZGV4KGVzKSBvZgogICAqICBgY29sbGVjdGlvbmAgdG8gcmV0cmlldmUsIGVpdGhlciBhcyBpbmRpdmlkdWFsIGFyZ3VtZW50cyBvciBhcnJheXMuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIGNvcnJlc3BvbmRpbmcgdG8gdGhlCiAgICogIHByb3ZpZGVkIGluZGV4ZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uYXQoWydhJywgJ2InLCAnYycsICdkJywgJ2UnXSwgWzAsIDIsIDRdKTsKICAgKiAvLyA9PiBbJ2EnLCAnYycsICdlJ10KICAgKgogICAqIF8uYXQoWydtb2UnLCAnbGFycnknLCAnY3VybHknXSwgMCwgMik7CiAgICogLy8gPT4gWydtb2UnLCAnY3VybHknXQogICAqLwogIGZ1bmN0aW9uIGF0KGNvbGxlY3Rpb24pIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIHByb3BzID0gY29uY2F0LmFwcGx5KGFycmF5UmVmLCBzbGljZShhcmd1bWVudHMsIDEpKSwKICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGgsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICBpZiAobm9DaGFyQnlJbmRleCAmJiBpc1N0cmluZyhjb2xsZWN0aW9uKSkgewogICAgICBjb2xsZWN0aW9uID0gY29sbGVjdGlvbi5zcGxpdCgnJyk7CiAgICB9CiAgICB3aGlsZSgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHJlc3VsdFtpbmRleF0gPSBjb2xsZWN0aW9uW3Byb3BzW2luZGV4XV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGEgZ2l2ZW4gYHRhcmdldGAgZWxlbWVudCBpcyBwcmVzZW50IGluIGEgYGNvbGxlY3Rpb25gIHVzaW5nIHN0cmljdAogICAqIGVxdWFsaXR5IGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4gSWYgYGZyb21JbmRleGAgaXMgbmVnYXRpdmUsIGl0IGlzIHVzZWQKICAgKiBhcyB0aGUgb2Zmc2V0IGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBpbmNsdWRlCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge01peGVkfSB0YXJnZXQgVGhlIHZhbHVlIHRvIGNoZWNrIGZvci4KICAgKiBAcGFyYW0ge051bWJlcn0gW2Zyb21JbmRleD0wXSBUaGUgaW5kZXggdG8gc2VhcmNoIGZyb20uCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdGFyZ2V0YCBlbGVtZW50IGlzIGZvdW5kLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uY29udGFpbnMoWzEsIDIsIDNdLCAxKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmNvbnRhaW5zKFsxLCAyLCAzXSwgMSwgMik7CiAgICogLy8gPT4gZmFsc2UKICAgKgogICAqIF8uY29udGFpbnMoeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwgJ21vZScpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uY29udGFpbnMoJ2N1cmx5JywgJ3VyJyk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGNvbnRhaW5zKGNvbGxlY3Rpb24sIHRhcmdldCwgZnJvbUluZGV4KSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgIHJlc3VsdCA9IGZhbHNlOwoKICAgIGZyb21JbmRleCA9IChmcm9tSW5kZXggPCAwID8gbmF0aXZlTWF4KDAsIGxlbmd0aCArIGZyb21JbmRleCkgOiBmcm9tSW5kZXgpIHx8IDA7CiAgICBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICByZXN1bHQgPSAoaXNTdHJpbmcoY29sbGVjdGlvbikKICAgICAgICA/IGNvbGxlY3Rpb24uaW5kZXhPZih0YXJnZXQsIGZyb21JbmRleCkKICAgICAgICA6IGluZGV4T2YoY29sbGVjdGlvbiwgdGFyZ2V0LCBmcm9tSW5kZXgpCiAgICAgICkgPiAtMTsKICAgIH0gZWxzZSB7CiAgICAgIGVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAoKytpbmRleCA+PSBmcm9tSW5kZXgpIHsKICAgICAgICAgIHJldHVybiAhKHJlc3VsdCA9IHZhbHVlID09PSB0YXJnZXQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2Yga2V5cyByZXR1cm5lZCBmcm9tIHJ1bm5pbmcgZWFjaCBlbGVtZW50IG9mCiAgICogYGNvbGxlY3Rpb25gIHRocm91Z2ggYSBgY2FsbGJhY2tgLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZSBvZiBlYWNoIGtleSBpcwogICAqIHRoZSBudW1iZXIgb2YgdGltZXMgdGhlIGtleSB3YXMgcmV0dXJuZWQgYnkgYGNhbGxiYWNrYC4gVGhlIGBjYWxsYmFja2AgaXMKICAgKiBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKiBUaGUgYGNhbGxiYWNrYCBhcmd1bWVudCBtYXkgYWxzbyBiZSB0aGUgbmFtZSBvZiBhIHByb3BlcnR5IHRvIGNvdW50IGJ5IChlLmcuICdsZW5ndGgnKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IGNhbGxiYWNrfHByb3BlcnR5IFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbgogICAqICBvciBwcm9wZXJ0eSBuYW1lIHRvIGNvdW50IGJ5LgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjb21wb3NlZCBhZ2dyZWdhdGUgb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmNvdW50QnkoWzQuMywgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguZmxvb3IobnVtKTsgfSk7CiAgICogLy8gPT4geyAnNCc6IDEsICc2JzogMiB9CiAgICoKICAgKiBfLmNvdW50QnkoWzQuMywgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuZmxvb3IobnVtKTsgfSwgTWF0aCk7CiAgICogLy8gPT4geyAnNCc6IDEsICc2JzogMiB9CiAgICoKICAgKiBfLmNvdW50QnkoWydvbmUnLCAndHdvJywgJ3RocmVlJ10sICdsZW5ndGgnKTsKICAgKiAvLyA9PiB7ICczJzogMiwgJzUnOiAxIH0KICAgKi8KICBmdW5jdGlvbiBjb3VudEJ5KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKCiAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAga2V5ID0gY2FsbGJhY2sodmFsdWUsIGtleSwgY29sbGVjdGlvbikgKyAnJzsKICAgICAgKGhhc093blByb3BlcnR5LmNhbGwocmVzdWx0LCBrZXkpID8gcmVzdWx0W2tleV0rKyA6IHJlc3VsdFtrZXldID0gMSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgdGhlIGBjYWxsYmFja2AgcmV0dXJucyBhIHRydXRoeSB2YWx1ZSBmb3IgKiphbGwqKiBlbGVtZW50cyBvZiBhCiAgICogYGNvbGxlY3Rpb25gLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZQogICAqIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGFsbAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBhbGwgZWxlbWVudHMgcGFzcyB0aGUgY2FsbGJhY2sgY2hlY2ssCiAgICogIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5ldmVyeShbdHJ1ZSwgMSwgbnVsbCwgJ3llcyddLCBCb29sZWFuKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGV2ZXJ5KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwoKICAgIGlmIChpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGlmICghKHJlc3VsdCA9ICEhY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSkpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICByZXR1cm4gKHJlc3VsdCA9ICEhY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSk7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEV4YW1pbmVzIGVhY2ggZWxlbWVudCBpbiBhIGBjb2xsZWN0aW9uYCwgcmV0dXJuaW5nIGFuIGFycmF5IG9mIGFsbCBlbGVtZW50cwogICAqIHRoZSBgY2FsbGJhY2tgIHJldHVybnMgdHJ1dGh5IGZvci4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZAogICAqIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBzZWxlY3QKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZWxlbWVudHMgdGhhdCBwYXNzZWQgdGhlIGNhbGxiYWNrIGNoZWNrLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgZXZlbnMgPSBfLmZpbHRlcihbMSwgMiwgMywgNCwgNSwgNl0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICUgMiA9PSAwOyB9KTsKICAgKiAvLyA9PiBbMiwgNCwgNl0KICAgKi8KICBmdW5jdGlvbiBmaWx0ZXIoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwoKICAgIGlmIChpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciB2YWx1ZSA9IGNvbGxlY3Rpb25baW5kZXhdOwogICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBFeGFtaW5lcyBlYWNoIGVsZW1lbnQgaW4gYSBgY29sbGVjdGlvbmAsIHJldHVybmluZyB0aGUgZmlyc3Qgb25lIHRoZSBgY2FsbGJhY2tgCiAgICogcmV0dXJucyB0cnV0aHkgZm9yLiBUaGUgZnVuY3Rpb24gcmV0dXJucyBhcyBzb29uIGFzIGl0IGZpbmRzIGFuIGFjY2VwdGFibGUKICAgKiBlbGVtZW50LCBhbmQgZG9lcyBub3QgaXRlcmF0ZSBvdmVyIHRoZSBlbnRpcmUgYGNvbGxlY3Rpb25gLiBUaGUgYGNhbGxiYWNrYCBpcwogICAqIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGRldGVjdAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgZWxlbWVudCB0aGF0IHBhc3NlZCB0aGUgY2FsbGJhY2sgY2hlY2ssCiAgICogIGVsc2UgYHVuZGVmaW5lZGAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBldmVuID0gXy5maW5kKFsxLCAyLCAzLCA0LCA1LCA2XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAqIC8vID0+IDIKICAgKi8KICBmdW5jdGlvbiBmaW5kKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgcmVzdWx0OwogICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CgogICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpIHsKICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEl0ZXJhdGVzIG92ZXIgYSBgY29sbGVjdGlvbmAsIGV4ZWN1dGluZyB0aGUgYGNhbGxiYWNrYCBmb3IgZWFjaCBlbGVtZW50IGluCiAgICogdGhlIGBjb2xsZWN0aW9uYC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUKICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4gQ2FsbGJhY2tzIG1heSBleGl0IGl0ZXJhdGlvbiBlYXJseQogICAqIGJ5IGV4cGxpY2l0bHkgcmV0dXJuaW5nIGBmYWxzZWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgZWFjaAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtBcnJheXxPYmplY3R8U3RyaW5nfSBSZXR1cm5zIGBjb2xsZWN0aW9uYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXyhbMSwgMiwgM10pLmZvckVhY2goYWxlcnQpLmpvaW4oJywnKTsKICAgKiAvLyA9PiBhbGVydHMgZWFjaCBudW1iZXIgYW5kIHJldHVybnMgJzEsMiwzJwogICAqCiAgICogXy5mb3JFYWNoKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0sIGFsZXJ0KTsKICAgKiAvLyA9PiBhbGVydHMgZWFjaCBudW1iZXIgdmFsdWUgKG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAqLwogIGZ1bmN0aW9uIGZvckVhY2goY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIGlmIChjYWxsYmFjayAmJiB0eXBlb2YgdGhpc0FyZyA9PSAndW5kZWZpbmVkJyAmJiBpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGlmIChjYWxsYmFjayhjb2xsZWN0aW9uW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pID09PSBmYWxzZSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlYWNoKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgIH0KICAgIHJldHVybiBjb2xsZWN0aW9uOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2Yga2V5cyByZXR1cm5lZCBmcm9tIHJ1bm5pbmcgZWFjaCBlbGVtZW50IG9mCiAgICogYGNvbGxlY3Rpb25gIHRocm91Z2ggYSBgY2FsbGJhY2tgLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZSBvZiBlYWNoIGtleSBpcyBhbgogICAqIGFycmF5IG9mIGVsZW1lbnRzIHBhc3NlZCB0byBgY2FsbGJhY2tgIHRoYXQgcmV0dXJuZWQgdGhlIGtleS4gVGhlIGBjYWxsYmFja2AKICAgKiBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKiBUaGUgYGNhbGxiYWNrYCBhcmd1bWVudCBtYXkgYWxzbyBiZSB0aGUgbmFtZSBvZiBhIHByb3BlcnR5IHRvIGdyb3VwIGJ5IChlLmcuICdsZW5ndGgnKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IGNhbGxiYWNrfHByb3BlcnR5IFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbgogICAqICBvciBwcm9wZXJ0eSBuYW1lIHRvIGdyb3VwIGJ5LgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjb21wb3NlZCBhZ2dyZWdhdGUgb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmdyb3VwQnkoWzQuMiwgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguZmxvb3IobnVtKTsgfSk7CiAgICogLy8gPT4geyAnNCc6IFs0LjJdLCAnNic6IFs2LjEsIDYuNF0gfQogICAqCiAgICogXy5ncm91cEJ5KFs0LjIsIDYuMSwgNi40XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiB0aGlzLmZsb29yKG51bSk7IH0sIE1hdGgpOwogICAqIC8vID0+IHsgJzQnOiBbNC4yXSwgJzYnOiBbNi4xLCA2LjRdIH0KICAgKgogICAqIF8uZ3JvdXBCeShbJ29uZScsICd0d28nLCAndGhyZWUnXSwgJ2xlbmd0aCcpOwogICAqIC8vID0+IHsgJzMnOiBbJ29uZScsICd0d28nXSwgJzUnOiBbJ3RocmVlJ10gfQogICAqLwogIGZ1bmN0aW9uIGdyb3VwQnkoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwoKICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGtleSwgY29sbGVjdGlvbikgewogICAgICBrZXkgPSBjYWxsYmFjayh2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSArICcnOwogICAgICAoaGFzT3duUHJvcGVydHkuY2FsbChyZXN1bHQsIGtleSkgPyByZXN1bHRba2V5XSA6IHJlc3VsdFtrZXldID0gW10pLnB1c2godmFsdWUpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogSW52b2tlcyB0aGUgbWV0aG9kIG5hbWVkIGJ5IGBtZXRob2ROYW1lYCBvbiBlYWNoIGVsZW1lbnQgaW4gdGhlIGBjb2xsZWN0aW9uYCwKICAgKiByZXR1cm5pbmcgYW4gYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBpbnZva2VkIG1ldGhvZC4gQWRkaXRpb25hbCBhcmd1bWVudHMKICAgKiB3aWxsIGJlIHBhc3NlZCB0byBlYWNoIGludm9rZWQgbWV0aG9kLiBJZiBgbWV0aG9kTmFtZWAgaXMgYSBmdW5jdGlvbiwgaXQgd2lsbAogICAqIGJlIGludm9rZWQgZm9yLCBhbmQgYHRoaXNgIGJvdW5kIHRvLCBlYWNoIGVsZW1lbnQgaW4gdGhlIGBjb2xsZWN0aW9uYC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IG1ldGhvZE5hbWUgVGhlIG5hbWUgb2YgdGhlIG1ldGhvZCB0byBpbnZva2Ugb3IKICAgKiAgdGhlIGZ1bmN0aW9uIGludm9rZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbYXJnMSwgYXJnMiwgLi4uXSBBcmd1bWVudHMgdG8gaW52b2tlIHRoZSBtZXRob2Qgd2l0aC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBpbnZva2VkIG1ldGhvZC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pbnZva2UoW1s1LCAxLCA3XSwgWzMsIDIsIDFdXSwgJ3NvcnQnKTsKICAgKiAvLyA9PiBbWzEsIDUsIDddLCBbMSwgMiwgM11dCiAgICoKICAgKiBfLmludm9rZShbMTIzLCA0NTZdLCBTdHJpbmcucHJvdG90eXBlLnNwbGl0LCAnJyk7CiAgICogLy8gPT4gW1snMScsICcyJywgJzMnXSwgWyc0JywgJzUnLCAnNiddXQogICAqLwogIGZ1bmN0aW9uIGludm9rZShjb2xsZWN0aW9uLCBtZXRob2ROYW1lKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlKGFyZ3VtZW50cywgMiksCiAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICBpc0Z1bmMgPSB0eXBlb2YgbWV0aG9kTmFtZSA9PSAnZnVuY3Rpb24nLAogICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmVzdWx0WysraW5kZXhdID0gKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiB2YWx1ZVttZXRob2ROYW1lXSkuYXBwbHkodmFsdWUsIGFyZ3MpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiB2YWx1ZXMgYnkgcnVubmluZyBlYWNoIGVsZW1lbnQgaW4gdGhlIGBjb2xsZWN0aW9uYAogICAqIHRocm91Z2ggYSBgY2FsbGJhY2tgLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aAogICAqIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGNvbGxlY3QKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBgY2FsbGJhY2tgIGV4ZWN1dGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5tYXAoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAqIDM7IH0pOwogICAqIC8vID0+IFszLCA2LCA5XQogICAqCiAgICogXy5tYXAoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiAzOyB9KTsKICAgKiAvLyA9PiBbMywgNiwgOV0gKG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAqLwogIGZ1bmN0aW9uIG1hcChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMCwKICAgICAgICByZXN1bHQgPSBBcnJheSh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInID8gbGVuZ3RoIDogMCk7CgogICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CiAgICBpZiAoaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHJlc3VsdFtpbmRleF0gPSBjYWxsYmFjayhjb2xsZWN0aW9uW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAgICByZXN1bHRbKytpbmRleF0gPSBjYWxsYmFjayh2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogUmV0cmlldmVzIHRoZSBtYXhpbXVtIHZhbHVlIG9mIGFuIGBhcnJheWAuIElmIGBjYWxsYmFja2AgaXMgcGFzc2VkLAogICAqIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yIGVhY2ggdmFsdWUgaW4gdGhlIGBhcnJheWAgdG8gZ2VuZXJhdGUgdGhlCiAgICogY3JpdGVyaW9uIGJ5IHdoaWNoIHRoZSB2YWx1ZSBpcyByYW5rZWQuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvCiAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgbWF4aW11bSB2YWx1ZS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIHN0b29nZXMgPSBbCiAgICogICB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9LAogICAqICAgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9LAogICAqICAgeyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9CiAgICogXTsKICAgKgogICAqIF8ubWF4KHN0b29nZXMsIGZ1bmN0aW9uKHN0b29nZSkgeyByZXR1cm4gc3Rvb2dlLmFnZTsgfSk7CiAgICogLy8gPT4geyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9OwogICAqLwogIGZ1bmN0aW9uIG1heChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIGNvbXB1dGVkID0gLUluZmluaXR5LAogICAgICAgIHJlc3VsdCA9IGNvbXB1dGVkOwoKICAgIGlmICghY2FsbGJhY2sgJiYgaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBjb2xsZWN0aW9uW2luZGV4XTsKICAgICAgICBpZiAodmFsdWUgPiByZXN1bHQpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSAhY2FsbGJhY2sgJiYgaXNTdHJpbmcoY29sbGVjdGlvbikKICAgICAgICA/IGNoYXJBdENhbGxiYWNrCiAgICAgICAgOiBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CgogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIHZhciBjdXJyZW50ID0gY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICBpZiAoY3VycmVudCA+IGNvbXB1dGVkKSB7CiAgICAgICAgICBjb21wdXRlZCA9IGN1cnJlbnQ7CiAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFJldHJpZXZlcyB0aGUgbWluaW11bSB2YWx1ZSBvZiBhbiBgYXJyYXlgLiBJZiBgY2FsbGJhY2tgIGlzIHBhc3NlZCwKICAgKiBpdCB3aWxsIGJlIGV4ZWN1dGVkIGZvciBlYWNoIHZhbHVlIGluIHRoZSBgYXJyYXlgIHRvIGdlbmVyYXRlIHRoZQogICAqIGNyaXRlcmlvbiBieSB3aGljaCB0aGUgdmFsdWUgaXMgcmFua2VkLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AKICAgKiBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIG1pbmltdW0gdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ubWluKFsxMCwgNSwgMTAwLCAyLCAxMDAwXSk7CiAgICogLy8gPT4gMgogICAqLwogIGZ1bmN0aW9uIG1pbihjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIGNvbXB1dGVkID0gSW5maW5pdHksCiAgICAgICAgcmVzdWx0ID0gY29tcHV0ZWQ7CgogICAgaWYgKCFjYWxsYmFjayAmJiBpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciB2YWx1ZSA9IGNvbGxlY3Rpb25baW5kZXhdOwogICAgICAgIGlmICh2YWx1ZSA8IHJlc3VsdCkgewogICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjYWxsYmFjayA9ICFjYWxsYmFjayAmJiBpc1N0cmluZyhjb2xsZWN0aW9uKQogICAgICAgID8gY2hhckF0Q2FsbGJhY2sKICAgICAgICA6IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKCiAgICAgIGVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgdmFyIGN1cnJlbnQgPSBjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICAgIGlmIChjdXJyZW50IDwgY29tcHV0ZWQpIHsKICAgICAgICAgIGNvbXB1dGVkID0gY3VycmVudDsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogUmV0cmlldmVzIHRoZSB2YWx1ZSBvZiBhIHNwZWNpZmllZCBwcm9wZXJ0eSBmcm9tIGFsbCBlbGVtZW50cyBpbgogICAqIHRoZSBgY29sbGVjdGlvbmAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eSBUaGUgcHJvcGVydHkgdG8gcGx1Y2suCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHByb3BlcnR5IHZhbHVlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIHN0b29nZXMgPSBbCiAgICogICB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9LAogICAqICAgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9LAogICAqICAgeyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9CiAgICogXTsKICAgKgogICAqIF8ucGx1Y2soc3Rvb2dlcywgJ25hbWUnKTsKICAgKiAvLyA9PiBbJ21vZScsICdsYXJyeScsICdjdXJseSddCiAgICovCiAgZnVuY3Rpb24gcGx1Y2soY29sbGVjdGlvbiwgcHJvcGVydHkpIHsKICAgIHJldHVybiBtYXAoY29sbGVjdGlvbiwgcHJvcGVydHkgKyAnJyk7CiAgfQoKICAvKioKICAgKiBSZWR1Y2VzIGEgYGNvbGxlY3Rpb25gIHRvIGEgc2luZ2xlIHZhbHVlLiBUaGUgaW5pdGlhbCBzdGF0ZSBvZiB0aGUgcmVkdWN0aW9uCiAgICogaXMgYGFjY3VtdWxhdG9yYCBhbmQgZWFjaCBzdWNjZXNzaXZlIHN0ZXAgb2YgaXQgc2hvdWxkIGJlIHJldHVybmVkIGJ5IHRoZQogICAqIGBjYWxsYmFja2AuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIGZvdXIKICAgKiBhcmd1bWVudHM7IGZvciBhcnJheXMgdGhleSBhcmUgKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBmb2xkbCwgaW5qZWN0CiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbYWNjdW11bGF0b3JdIEluaXRpYWwgdmFsdWUgb2YgdGhlIGFjY3VtdWxhdG9yLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGFjY3VtdWxhdGVkIHZhbHVlLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgc3VtID0gXy5yZWR1Y2UoWzEsIDIsIDNdLCBmdW5jdGlvbihtZW1vLCBudW0pIHsgcmV0dXJuIG1lbW8gKyBudW07IH0pOwogICAqIC8vID0+IDYKICAgKi8KICBmdW5jdGlvbiByZWR1Y2UoY29sbGVjdGlvbiwgY2FsbGJhY2ssIGFjY3VtdWxhdG9yLCB0aGlzQXJnKSB7CiAgICB2YXIgbm9hY2N1bSA9IGFyZ3VtZW50cy5sZW5ndGggPCAzOwogICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgaW5kaWNhdG9yT2JqZWN0KTsKCiAgICBpZiAoaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgaWYgKG5vYWNjdW0pIHsKICAgICAgICBhY2N1bXVsYXRvciA9IGNvbGxlY3Rpb25bKytpbmRleF07CiAgICAgIH0KICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBhY2N1bXVsYXRvciA9IGNhbGxiYWNrKGFjY3VtdWxhdG9yLCBjb2xsZWN0aW9uW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIGFjY3VtdWxhdG9yID0gbm9hY2N1bQogICAgICAgICAgPyAobm9hY2N1bSA9IGZhbHNlLCB2YWx1ZSkKICAgICAgICAgIDogY2FsbGJhY2soYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgfQoKICAvKioKICAgKiBUaGlzIG1ldGhvZCBpcyBzaW1pbGFyIHRvIGBfLnJlZHVjZWAsIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgYQogICAqIGBjb2xsZWN0aW9uYCBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgZm9sZHIKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthY2N1bXVsYXRvcl0gSW5pdGlhbCB2YWx1ZSBvZiB0aGUgYWNjdW11bGF0b3IuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgYWNjdW11bGF0ZWQgdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBsaXN0ID0gW1swLCAxXSwgWzIsIDNdLCBbNCwgNV1dOwogICAqIHZhciBmbGF0ID0gXy5yZWR1Y2VSaWdodChsaXN0LCBmdW5jdGlvbihhLCBiKSB7IHJldHVybiBhLmNvbmNhdChiKTsgfSwgW10pOwogICAqIC8vID0+IFs0LCA1LCAyLCAzLCAwLCAxXQogICAqLwogIGZ1bmN0aW9uIHJlZHVjZVJpZ2h0KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCBhY2N1bXVsYXRvciwgdGhpc0FyZykgewogICAgdmFyIGl0ZXJhYmxlID0gY29sbGVjdGlvbiwKICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgIG5vYWNjdW0gPSBhcmd1bWVudHMubGVuZ3RoIDwgMzsKCiAgICBpZiAodHlwZW9mIGxlbmd0aCAhPSAnbnVtYmVyJykgewogICAgICB2YXIgcHJvcHMgPSBrZXlzKGNvbGxlY3Rpb24pOwogICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CiAgICB9IGVsc2UgaWYgKG5vQ2hhckJ5SW5kZXggJiYgaXNTdHJpbmcoY29sbGVjdGlvbikpIHsKICAgICAgaXRlcmFibGUgPSBjb2xsZWN0aW9uLnNwbGl0KCcnKTsKICAgIH0KICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIGluZGljYXRvck9iamVjdCk7CiAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICBpbmRleCA9IHByb3BzID8gcHJvcHNbLS1sZW5ndGhdIDogLS1sZW5ndGg7CiAgICAgIGFjY3VtdWxhdG9yID0gbm9hY2N1bQogICAgICAgID8gKG5vYWNjdW0gPSBmYWxzZSwgaXRlcmFibGVbaW5kZXhdKQogICAgICAgIDogY2FsbGJhY2soYWNjdW11bGF0b3IsIGl0ZXJhYmxlW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgfSk7CiAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgfQoKICAvKioKICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uZmlsdGVyYCwgdGhpcyBtZXRob2QgcmV0dXJucyB0aGUgZWxlbWVudHMgb2YgYQogICAqIGBjb2xsZWN0aW9uYCB0aGF0IGBjYWxsYmFja2AgZG9lcyAqKm5vdCoqIHJldHVybiB0cnV0aHkgZm9yLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIHRoYXQgZGlkICoqbm90KiogcGFzcyB0aGUKICAgKiAgY2FsbGJhY2sgY2hlY2suCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBvZGRzID0gXy5yZWplY3QoWzEsIDIsIDMsIDQsIDUsIDZdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAlIDIgPT0gMDsgfSk7CiAgICogLy8gPT4gWzEsIDMsIDVdCiAgICovCiAgZnVuY3Rpb24gcmVqZWN0KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICBjYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgIHJldHVybiBmaWx0ZXIoY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgIHJldHVybiAhY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgIH0pOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiBzaHVmZmxlZCBgYXJyYXlgIHZhbHVlcywgdXNpbmcgYSB2ZXJzaW9uIG9mIHRoZQogICAqIEZpc2hlci1ZYXRlcyBzaHVmZmxlLiBTZWUgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9GaXNoZXItWWF0ZXNfc2h1ZmZsZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBzaHVmZmxlLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBzaHVmZmxlZCBjb2xsZWN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnNodWZmbGUoWzEsIDIsIDMsIDQsIDUsIDZdKTsKICAgKiAvLyA9PiBbNCwgMSwgNiwgMywgNSwgMl0KICAgKi8KICBmdW5jdGlvbiBzaHVmZmxlKGNvbGxlY3Rpb24pIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIHJhbmQgPSBmbG9vcihuYXRpdmVSYW5kb20oKSAqICgrK2luZGV4ICsgMSkpOwogICAgICByZXN1bHRbaW5kZXhdID0gcmVzdWx0W3JhbmRdOwogICAgICByZXN1bHRbcmFuZF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIHNpemUgb2YgdGhlIGBjb2xsZWN0aW9uYCBieSByZXR1cm5pbmcgYGNvbGxlY3Rpb24ubGVuZ3RoYCBmb3IgYXJyYXlzCiAgICogYW5kIGFycmF5LWxpa2Ugb2JqZWN0cyBvciB0aGUgbnVtYmVyIG9mIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgZm9yIG9iamVjdHMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7TnVtYmVyfSBSZXR1cm5zIGBjb2xsZWN0aW9uLmxlbmd0aGAgb3IgbnVtYmVyIG9mIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uc2l6ZShbMSwgMl0pOwogICAqIC8vID0+IDIKICAgKgogICAqIF8uc2l6ZSh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgKiAvLyA9PiAzCiAgICoKICAgKiBfLnNpemUoJ2N1cmx5Jyk7CiAgICogLy8gPT4gNQogICAqLwogIGZ1bmN0aW9uIHNpemUoY29sbGVjdGlvbikgewogICAgdmFyIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CiAgICByZXR1cm4gdHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IGtleXMoY29sbGVjdGlvbikubGVuZ3RoOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBgY2FsbGJhY2tgIHJldHVybnMgYSB0cnV0aHkgdmFsdWUgZm9yICoqYW55KiogZWxlbWVudCBvZiBhCiAgICogYGNvbGxlY3Rpb25gLiBUaGUgZnVuY3Rpb24gcmV0dXJucyBhcyBzb29uIGFzIGl0IGZpbmRzIHBhc3NpbmcgdmFsdWUsIGFuZAogICAqIGRvZXMgbm90IGl0ZXJhdGUgb3ZlciB0aGUgZW50aXJlIGBjb2xsZWN0aW9uYC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8KICAgKiBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBhbnkKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYW55IGVsZW1lbnQgcGFzc2VzIHRoZSBjYWxsYmFjayBjaGVjaywKICAgKiAgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnNvbWUoW251bGwsIDAsICd5ZXMnLCBmYWxzZV0sIEJvb2xlYW4pOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBzb21lKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgcmVzdWx0OwogICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CgogICAgaWYgKGlzQXJyYXkoY29sbGVjdGlvbikpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgaWYgKChyZXN1bHQgPSBjYWxsYmFjayhjb2xsZWN0aW9uW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pKSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIHJldHVybiAhKHJlc3VsdCA9IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiAhIXJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXksIHN0YWJsZSBzb3J0ZWQgaW4gYXNjZW5kaW5nIG9yZGVyIGJ5IHRoZSByZXN1bHRzIG9mCiAgICogcnVubmluZyBlYWNoIGVsZW1lbnQgb2YgYGNvbGxlY3Rpb25gIHRocm91Z2ggYSBgY2FsbGJhY2tgLiBUaGUgYGNhbGxiYWNrYAogICAqIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqIFRoZSBgY2FsbGJhY2tgIGFyZ3VtZW50IG1heSBhbHNvIGJlIHRoZSBuYW1lIG9mIGEgcHJvcGVydHkgdG8gc29ydCBieSAoZS5nLiAnbGVuZ3RoJykuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBjYWxsYmFja3xwcm9wZXJ0eSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24KICAgKiAgb3IgcHJvcGVydHkgbmFtZSB0byBzb3J0IGJ5LgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2Ygc29ydGVkIGVsZW1lbnRzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnNvcnRCeShbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gTWF0aC5zaW4obnVtKTsgfSk7CiAgICogLy8gPT4gWzMsIDEsIDJdCiAgICoKICAgKiBfLnNvcnRCeShbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gdGhpcy5zaW4obnVtKTsgfSwgTWF0aCk7CiAgICogLy8gPT4gWzMsIDEsIDJdCiAgICoKICAgKiBfLnNvcnRCeShbJ2xhcnJ5JywgJ2JyZW5kYW4nLCAnbW9lJ10sICdsZW5ndGgnKTsKICAgKiAvLyA9PiBbJ21vZScsICdsYXJyeScsICdicmVuZGFuJ10KICAgKi8KICBmdW5jdGlvbiBzb3J0QnkoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSB7CiAgICAgIHJlc3VsdFsrK2luZGV4XSA9IHsKICAgICAgICAnY3JpdGVyaWEnOiBjYWxsYmFjayh2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSwKICAgICAgICAnaW5kZXgnOiBpbmRleCwKICAgICAgICAndmFsdWUnOiB2YWx1ZQogICAgICB9OwogICAgfSk7CgogICAgbGVuZ3RoID0gcmVzdWx0Lmxlbmd0aDsKICAgIHJlc3VsdC5zb3J0KGNvbXBhcmVBc2NlbmRpbmcpOwogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIHJlc3VsdFtsZW5ndGhdID0gcmVzdWx0W2xlbmd0aF0udmFsdWU7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ29udmVydHMgdGhlIGBjb2xsZWN0aW9uYCB0byBhbiBhcnJheS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBjb252ZXJ0LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGNvbnZlcnRlZCBhcnJheS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogKGZ1bmN0aW9uKCkgeyByZXR1cm4gXy50b0FycmF5KGFyZ3VtZW50cykuc2xpY2UoMSk7IH0pKDEsIDIsIDMsIDQpOwogICAqIC8vID0+IFsyLCAzLCA0XQogICAqLwogIGZ1bmN0aW9uIHRvQXJyYXkoY29sbGVjdGlvbikgewogICAgaWYgKGNvbGxlY3Rpb24gJiYgdHlwZW9mIGNvbGxlY3Rpb24ubGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgIHJldHVybiBub0NoYXJCeUluZGV4ICYmIGlzU3RyaW5nKGNvbGxlY3Rpb24pCiAgICAgICAgPyBjb2xsZWN0aW9uLnNwbGl0KCcnKQogICAgICAgIDogc2xpY2UoY29sbGVjdGlvbik7CiAgICB9CiAgICByZXR1cm4gdmFsdWVzKGNvbGxlY3Rpb24pOwogIH0KCiAgLyoqCiAgICogRXhhbWluZXMgZWFjaCBlbGVtZW50IGluIGEgYGNvbGxlY3Rpb25gLCByZXR1cm5pbmcgYW4gYXJyYXkgb2YgYWxsIGVsZW1lbnRzCiAgICogdGhhdCBjb250YWluIHRoZSBnaXZlbiBgcHJvcGVydGllc2AuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wZXJ0aWVzIFRoZSBvYmplY3Qgb2YgcHJvcGVydHkgdmFsdWVzIHRvIGZpbHRlciBieS4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZWxlbWVudHMgdGhhdCBjb250YWluIHRoZSBnaXZlbiBgcHJvcGVydGllc2AuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBzdG9vZ2VzID0gWwogICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfSwKICAgKiAgIHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfQogICAqIF07CiAgICoKICAgKiBfLndoZXJlKHN0b29nZXMsIHsgJ2FnZSc6IDQwIH0pOwogICAqIC8vID0+IFt7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9XQogICAqLwogIGZ1bmN0aW9uIHdoZXJlKGNvbGxlY3Rpb24sIHByb3BlcnRpZXMpIHsKICAgIHJldHVybiBmaWx0ZXIoY29sbGVjdGlvbiwgcHJvcGVydGllcyk7CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBhcnJheSB3aXRoIGFsbCBmYWxzZXkgdmFsdWVzIG9mIGBhcnJheWAgcmVtb3ZlZC4gVGhlIHZhbHVlcwogICAqIGBmYWxzZWAsIGBudWxsYCwgYDBgLCBgIiJgLCBgdW5kZWZpbmVkYCBhbmQgYE5hTmAgYXJlIGFsbCBmYWxzZXkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGNvbXBhY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGZpbHRlcmVkIGFycmF5LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmNvbXBhY3QoWzAsIDEsIGZhbHNlLCAyLCAnJywgM10pOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqLwogIGZ1bmN0aW9uIGNvbXBhY3QoYXJyYXkpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICByZXN1bHQgPSBbXTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF07CiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgYGFycmF5YCBlbGVtZW50cyBub3QgcHJlc2VudCBpbiB0aGUgb3RoZXIgYXJyYXlzCiAgICogdXNpbmcgc3RyaWN0IGVxdWFsaXR5IGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcHJvY2Vzcy4KICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXkxLCBhcnJheTIsIC4uLl0gQXJyYXlzIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBgYXJyYXlgIGVsZW1lbnRzIG5vdCBwcmVzZW50IGluIHRoZQogICAqICBvdGhlciBhcnJheXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZGlmZmVyZW5jZShbMSwgMiwgMywgNCwgNV0sIFs1LCAyLCAxMF0pOwogICAqIC8vID0+IFsxLCAzLCA0XQogICAqLwogIGZ1bmN0aW9uIGRpZmZlcmVuY2UoYXJyYXkpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICBmbGF0dGVuZWQgPSBjb25jYXQuYXBwbHkoYXJyYXlSZWYsIGFyZ3VtZW50cyksCiAgICAgICAgY29udGFpbnMgPSBjYWNoZWRDb250YWlucyhmbGF0dGVuZWQsIGxlbmd0aCksCiAgICAgICAgcmVzdWx0ID0gW107CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICBpZiAoIWNvbnRhaW5zKHZhbHVlKSkgewogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIGZpcnN0IGVsZW1lbnQgb2YgdGhlIGBhcnJheWAuIElmIGEgbnVtYmVyIGBuYCBpcyBwYXNzZWQsIHRoZSBmaXJzdAogICAqIGBuYCBlbGVtZW50cyBvZiB0aGUgYGFycmF5YCBhcmUgcmV0dXJuZWQuIElmIGEgYGNhbGxiYWNrYCBmdW5jdGlvbiBpcyBwYXNzZWQsCiAgICogdGhlIGZpcnN0IGVsZW1lbnRzIHRoZSBgY2FsbGJhY2tgIHJldHVybnMgdHJ1dGh5IGZvciBhcmUgcmV0dXJuZWQuIFRoZSBgY2FsbGJhY2tgCiAgICogaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgaGVhZCwgdGFrZQogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxOdW1iZXJ9IFtjYWxsYmFja3xuXSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBlbGVtZW50IG9yCiAgICogIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gcmV0dXJuLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGZpcnN0IGVsZW1lbnQocykgb2YgYGFycmF5YC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5maXJzdChbMSwgMiwgM10pOwogICAqIC8vID0+IDEKICAgKgogICAqIF8uZmlyc3QoWzEsIDIsIDNdLCAyKTsKICAgKiAvLyA9PiBbMSwgMl0KICAgKgogICAqIF8uZmlyc3QoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsKICAgKiAgIHJldHVybiBudW0gPCAzOwogICAqIH0pOwogICAqIC8vID0+IFsxLCAyXQogICAqLwogIGZ1bmN0aW9uIGZpcnN0KGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgaWYgKGFycmF5KSB7CiAgICAgIHZhciBuID0gMCwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKCiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHZhciBpbmRleCA9IC0xOwogICAgICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoICYmIGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgbisrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBuID0gY2FsbGJhY2s7CiAgICAgICAgaWYgKG4gPT0gbnVsbCB8fCB0aGlzQXJnKSB7CiAgICAgICAgICByZXR1cm4gYXJyYXlbMF07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzbGljZShhcnJheSwgMCwgbmF0aXZlTWluKG5hdGl2ZU1heCgwLCBuKSwgbGVuZ3RoKSk7CiAgICB9CiAgfQoKICAvKioKICAgKiBGbGF0dGVucyBhIG5lc3RlZCBhcnJheSAodGhlIG5lc3RpbmcgY2FuIGJlIHRvIGFueSBkZXB0aCkuIElmIGBzaGFsbG93YCBpcwogICAqIHRydXRoeSwgYGFycmF5YCB3aWxsIG9ubHkgYmUgZmxhdHRlbmVkIGEgc2luZ2xlIGxldmVsLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBjb21wYWN0LgogICAqIEBwYXJhbSB7Qm9vbGVhbn0gc2hhbGxvdyBBIGZsYWcgdG8gaW5kaWNhdGUgb25seSBmbGF0dGVuaW5nIGEgc2luZ2xlIGxldmVsLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBmbGF0dGVuZWQgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZmxhdHRlbihbMSwgWzJdLCBbMywgW1s0XV1dXSk7CiAgICogLy8gPT4gWzEsIDIsIDMsIDRdOwogICAqCiAgICogXy5mbGF0dGVuKFsxLCBbMl0sIFszLCBbWzRdXV1dLCB0cnVlKTsKICAgKiAvLyA9PiBbMSwgMiwgMywgW1s0XV1dOwogICAqLwogIGZ1bmN0aW9uIGZsYXR0ZW4oYXJyYXksIHNoYWxsb3cpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICByZXN1bHQgPSBbXTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF07CgogICAgICAvLyByZWN1cnNpdmVseSBmbGF0dGVuIGFycmF5cyAoc3VzY2VwdGlibGUgdG8gY2FsbCBzdGFjayBsaW1pdHMpCiAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgIHB1c2guYXBwbHkocmVzdWx0LCBzaGFsbG93ID8gdmFsdWUgOiBmbGF0dGVuKHZhbHVlKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogR2V0cyB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIGZpcnN0IG9jY3VycmVuY2Ugb2YgYHZhbHVlYCBpcyBmb3VuZCB1c2luZwogICAqIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIHRoZSBgYXJyYXlgIGlzIGFscmVhZHkKICAgKiBzb3J0ZWQsIHBhc3NpbmcgYHRydWVgIGZvciBgZnJvbUluZGV4YCB3aWxsIHJ1biBhIGZhc3RlciBiaW5hcnkgc2VhcmNoLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzZWFyY2guCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICogQHBhcmFtIHtCb29sZWFufE51bWJlcn0gW2Zyb21JbmRleD0wXSBUaGUgaW5kZXggdG8gc2VhcmNoIGZyb20gb3IgYHRydWVgIHRvCiAgICogIHBlcmZvcm0gYSBiaW5hcnkgc2VhcmNoIG9uIGEgc29ydGVkIGBhcnJheWAuCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIG1hdGNoZWQgdmFsdWUgb3IgYC0xYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pbmRleE9mKFsxLCAyLCAzLCAxLCAyLCAzXSwgMik7CiAgICogLy8gPT4gMQogICAqCiAgICogXy5pbmRleE9mKFsxLCAyLCAzLCAxLCAyLCAzXSwgMiwgMyk7CiAgICogLy8gPT4gNAogICAqCiAgICogXy5pbmRleE9mKFsxLCAxLCAyLCAyLCAzLCAzXSwgMiwgdHJ1ZSk7CiAgICogLy8gPT4gMgogICAqLwogIGZ1bmN0aW9uIGluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICBpZiAodHlwZW9mIGZyb21JbmRleCA9PSAnbnVtYmVyJykgewogICAgICBpbmRleCA9IChmcm9tSW5kZXggPCAwID8gbmF0aXZlTWF4KDAsIGxlbmd0aCArIGZyb21JbmRleCkgOiBmcm9tSW5kZXggfHwgMCkgLSAxOwogICAgfSBlbHNlIGlmIChmcm9tSW5kZXgpIHsKICAgICAgaW5kZXggPSBzb3J0ZWRJbmRleChhcnJheSwgdmFsdWUpOwogICAgICByZXR1cm4gYXJyYXlbaW5kZXhdID09PSB2YWx1ZSA/IGluZGV4IDogLTE7CiAgICB9CiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICBpZiAoYXJyYXlbaW5kZXhdID09PSB2YWx1ZSkgewogICAgICAgIHJldHVybiBpbmRleDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIC0xOwogIH0KCiAgLyoqCiAgICogR2V0cyBhbGwgYnV0IHRoZSBsYXN0IGVsZW1lbnQgb2YgYGFycmF5YC4gSWYgYSBudW1iZXIgYG5gIGlzIHBhc3NlZCwgdGhlCiAgICogbGFzdCBgbmAgZWxlbWVudHMgYXJlIGV4Y2x1ZGVkIGZyb20gdGhlIHJlc3VsdC4gSWYgYSBgY2FsbGJhY2tgIGZ1bmN0aW9uCiAgICogaXMgcGFzc2VkLCB0aGUgbGFzdCBlbGVtZW50cyB0aGUgYGNhbGxiYWNrYCByZXR1cm5zIHRydXRoeSBmb3IgYXJlIGV4Y2x1ZGVkCiAgICogZnJvbSB0aGUgcmVzdWx0LiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZQogICAqIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE51bWJlcn0gW2NhbGxiYWNrfG49MV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgZWxlbWVudCBvcgogICAqICB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIGV4Y2x1ZGUuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIHNsaWNlIG9mIGBhcnJheWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaW5pdGlhbChbMSwgMiwgM10pOwogICAqIC8vID0+IFsxLCAyXQogICAqCiAgICogXy5pbml0aWFsKFsxLCAyLCAzXSwgMik7CiAgICogLy8gPT4gWzFdCiAgICoKICAgKiBfLmluaXRpYWwoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsKICAgKiAgIHJldHVybiBudW0gPiAxOwogICAqIH0pOwogICAqIC8vID0+IFsxXQogICAqLwogIGZ1bmN0aW9uIGluaXRpYWwoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICBpZiAoIWFycmF5KSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KICAgIHZhciBuID0gMCwKICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgogICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHZhciBpbmRleCA9IGxlbmd0aDsKICAgICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CiAgICAgIHdoaWxlIChpbmRleC0tICYmIGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgIG4rKzsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgbiA9IChjYWxsYmFjayA9PSBudWxsIHx8IHRoaXNBcmcpID8gMSA6IGNhbGxiYWNrIHx8IG47CiAgICB9CiAgICByZXR1cm4gc2xpY2UoYXJyYXksIDAsIG5hdGl2ZU1pbihuYXRpdmVNYXgoMCwgbGVuZ3RoIC0gbiksIGxlbmd0aCkpOwogIH0KCiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIGludGVyc2VjdGlvbiBvZiBhbGwgdGhlIHBhc3NlZC1pbiBhcnJheXMgdXNpbmcgc3RyaWN0IGVxdWFsaXR5CiAgICogZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheTEsIGFycmF5MiwgLi4uXSBBcnJheXMgdG8gcHJvY2Vzcy4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdW5pcXVlIGVsZW1lbnRzIHRoYXQgYXJlIHByZXNlbnQKICAgKiAgaW4gKiphbGwqKiBvZiB0aGUgYXJyYXlzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmludGVyc2VjdGlvbihbMSwgMiwgM10sIFsxMDEsIDIsIDEsIDEwXSwgWzIsIDFdKTsKICAgKiAvLyA9PiBbMSwgMl0KICAgKi8KICBmdW5jdGlvbiBpbnRlcnNlY3Rpb24oYXJyYXkpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgIGFyZ3NMZW5ndGggPSBhcmdzLmxlbmd0aCwKICAgICAgICBjYWNoZSA9IHsgJzAnOiB7fSB9LAogICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwLAogICAgICAgIGlzTGFyZ2UgPSBsZW5ndGggPj0gMTAwLAogICAgICAgIHJlc3VsdCA9IFtdLAogICAgICAgIHNlZW4gPSByZXN1bHQ7CgogICAgb3V0ZXI6CiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF07CiAgICAgIGlmIChpc0xhcmdlKSB7CiAgICAgICAgdmFyIGtleSA9IHZhbHVlICsgJyc7CiAgICAgICAgdmFyIGluaXRlZCA9IGhhc093blByb3BlcnR5LmNhbGwoY2FjaGVbMF0sIGtleSkKICAgICAgICAgID8gIShzZWVuID0gY2FjaGVbMF1ba2V5XSkKICAgICAgICAgIDogKHNlZW4gPSBjYWNoZVswXVtrZXldID0gW10pOwogICAgICB9CiAgICAgIGlmIChpbml0ZWQgfHwgaW5kZXhPZihzZWVuLCB2YWx1ZSkgPCAwKSB7CiAgICAgICAgaWYgKGlzTGFyZ2UpIHsKICAgICAgICAgIHNlZW4ucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHZhciBhcmdzSW5kZXggPSBhcmdzTGVuZ3RoOwogICAgICAgIHdoaWxlICgtLWFyZ3NJbmRleCkgewogICAgICAgICAgaWYgKCEoY2FjaGVbYXJnc0luZGV4XSB8fCAoY2FjaGVbYXJnc0luZGV4XSA9IGNhY2hlZENvbnRhaW5zKGFyZ3NbYXJnc0luZGV4XSwgMCwgMTAwKSkpKHZhbHVlKSkgewogICAgICAgICAgICBjb250aW51ZSBvdXRlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogR2V0cyB0aGUgbGFzdCBlbGVtZW50IG9mIHRoZSBgYXJyYXlgLiBJZiBhIG51bWJlciBgbmAgaXMgcGFzc2VkLCB0aGUgbGFzdAogICAqIGBuYCBlbGVtZW50cyBvZiB0aGUgYGFycmF5YCBhcmUgcmV0dXJuZWQuIElmIGEgYGNhbGxiYWNrYCBmdW5jdGlvbiBpcyBwYXNzZWQsCiAgICogdGhlIGxhc3QgZWxlbWVudHMgdGhlIGBjYWxsYmFja2AgcmV0dXJucyB0cnV0aHkgZm9yIGFyZSByZXR1cm5lZC4gVGhlIGBjYWxsYmFja2AKICAgKiBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtGdW5jdGlvbnxOdW1iZXJ9IFtjYWxsYmFja3xuXSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBlbGVtZW50IG9yCiAgICogIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gcmV0dXJuLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGxhc3QgZWxlbWVudChzKSBvZiBgYXJyYXlgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmxhc3QoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiAzCiAgICoKICAgKiBfLmxhc3QoWzEsIDIsIDNdLCAyKTsKICAgKiAvLyA9PiBbMiwgM10KICAgKgogICAqIF8ubGFzdChbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgewogICAqICAgcmV0dXJuIG51bSA+IDE7CiAgICogfSk7CiAgICogLy8gPT4gWzIsIDNdCiAgICovCiAgZnVuY3Rpb24gbGFzdChhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIGlmIChhcnJheSkgewogICAgICB2YXIgbiA9IDAsCiAgICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicpIHsKICAgICAgICB2YXIgaW5kZXggPSBsZW5ndGg7CiAgICAgICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CiAgICAgICAgd2hpbGUgKGluZGV4LS0gJiYgY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpKSB7CiAgICAgICAgICBuKys7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG4gPSBjYWxsYmFjazsKICAgICAgICBpZiAobiA9PSBudWxsIHx8IHRoaXNBcmcpIHsKICAgICAgICAgIHJldHVybiBhcnJheVtsZW5ndGggLSAxXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHNsaWNlKGFycmF5LCBuYXRpdmVNYXgoMCwgbGVuZ3RoIC0gbikpOwogICAgfQogIH0KCiAgLyoqCiAgICogR2V0cyB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIGxhc3Qgb2NjdXJyZW5jZSBvZiBgdmFsdWVgIGlzIGZvdW5kIHVzaW5nIHN0cmljdAogICAqIGVxdWFsaXR5IGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4gSWYgYGZyb21JbmRleGAgaXMgbmVnYXRpdmUsIGl0IGlzIHVzZWQKICAgKiBhcyB0aGUgb2Zmc2V0IGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2VhcmNoLgogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAqIEBwYXJhbSB7TnVtYmVyfSBbZnJvbUluZGV4PWFycmF5Lmxlbmd0aC0xXSBUaGUgaW5kZXggdG8gc2VhcmNoIGZyb20uCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIG1hdGNoZWQgdmFsdWUgb3IgYC0xYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5sYXN0SW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIpOwogICAqIC8vID0+IDQKICAgKgogICAqIF8ubGFzdEluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyLCAzKTsKICAgKiAvLyA9PiAxCiAgICovCiAgZnVuY3Rpb24gbGFzdEluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpIHsKICAgIHZhciBpbmRleCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKICAgIGlmICh0eXBlb2YgZnJvbUluZGV4ID09ICdudW1iZXInKSB7CiAgICAgIGluZGV4ID0gKGZyb21JbmRleCA8IDAgPyBuYXRpdmVNYXgoMCwgaW5kZXggKyBmcm9tSW5kZXgpIDogbmF0aXZlTWluKGZyb21JbmRleCwgaW5kZXggLSAxKSkgKyAxOwogICAgfQogICAgd2hpbGUgKGluZGV4LS0pIHsKICAgICAgaWYgKGFycmF5W2luZGV4XSA9PT0gdmFsdWUpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIGZyb20gYXJyYXlzIG9mIGBrZXlzYCBhbmQgYHZhbHVlc2AuIFBhc3MgZWl0aGVyCiAgICogYSBzaW5nbGUgdHdvIGRpbWVuc2lvbmFsIGFycmF5LCBpLmUuIGBbW2tleTEsIHZhbHVlMV0sIFtrZXkyLCB2YWx1ZTJdXWAsIG9yCiAgICogdHdvIGFycmF5cywgb25lIG9mIGBrZXlzYCBhbmQgb25lIG9mIGNvcnJlc3BvbmRpbmcgYHZhbHVlc2AuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0ga2V5cyBUaGUgYXJyYXkgb2Yga2V5cy4KICAgKiBAcGFyYW0ge0FycmF5fSBbdmFsdWVzPVtdXSBUaGUgYXJyYXkgb2YgdmFsdWVzLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIHRoZSBnaXZlbiBrZXlzIGFuZAogICAqICBjb3JyZXNwb25kaW5nIHZhbHVlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5vYmplY3QoWydtb2UnLCAnbGFycnknLCAnY3VybHknXSwgWzMwLCA0MCwgNTBdKTsKICAgKiAvLyA9PiB7ICdtb2UnOiAzMCwgJ2xhcnJ5JzogNDAsICdjdXJseSc6IDUwIH0KICAgKi8KICBmdW5jdGlvbiBvYmplY3Qoa2V5cywgdmFsdWVzKSB7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBrZXlzID8ga2V5cy5sZW5ndGggOiAwLAogICAgICAgIHJlc3VsdCA9IHt9OwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2luZGV4XTsKICAgICAgaWYgKHZhbHVlcykgewogICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWVzW2luZGV4XTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRba2V5WzBdXSA9IGtleVsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgbnVtYmVycyAocG9zaXRpdmUgYW5kL29yIG5lZ2F0aXZlKSBwcm9ncmVzc2luZyBmcm9tCiAgICogYHN0YXJ0YCB1cCB0byBidXQgbm90IGluY2x1ZGluZyBgZW5kYC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge051bWJlcn0gW3N0YXJ0PTBdIFRoZSBzdGFydCBvZiB0aGUgcmFuZ2UuCiAgICogQHBhcmFtIHtOdW1iZXJ9IGVuZCBUaGUgZW5kIG9mIHRoZSByYW5nZS4KICAgKiBAcGFyYW0ge051bWJlcn0gW3N0ZXA9MV0gVGhlIHZhbHVlIHRvIGluY3JlbWVudCBvciBkZXNjcmVtZW50IGJ5LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyByYW5nZSBhcnJheS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5yYW5nZSgxMCk7CiAgICogLy8gPT4gWzAsIDEsIDIsIDMsIDQsIDUsIDYsIDcsIDgsIDldCiAgICoKICAgKiBfLnJhbmdlKDEsIDExKTsKICAgKiAvLyA9PiBbMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgOSwgMTBdCiAgICoKICAgKiBfLnJhbmdlKDAsIDMwLCA1KTsKICAgKiAvLyA9PiBbMCwgNSwgMTAsIDE1LCAyMCwgMjVdCiAgICoKICAgKiBfLnJhbmdlKDAsIC0xMCwgLTEpOwogICAqIC8vID0+IFswLCAtMSwgLTIsIC0zLCAtNCwgLTUsIC02LCAtNywgLTgsIC05XQogICAqCiAgICogXy5yYW5nZSgwKTsKICAgKiAvLyA9PiBbXQogICAqLwogIGZ1bmN0aW9uIHJhbmdlKHN0YXJ0LCBlbmQsIHN0ZXApIHsKICAgIHN0YXJ0ID0gK3N0YXJ0IHx8IDA7CiAgICBzdGVwID0gK3N0ZXAgfHwgMTsKCiAgICBpZiAoZW5kID09IG51bGwpIHsKICAgICAgZW5kID0gc3RhcnQ7CiAgICAgIHN0YXJ0ID0gMDsKICAgIH0KICAgIC8vIHVzZSBgQXJyYXkobGVuZ3RoKWAgc28gVjggd2lsbCBhdm9pZCB0aGUgc2xvd2VyICJkaWN0aW9uYXJ5IiBtb2RlCiAgICAvLyBodHRwOi8veW91dHUuYmUvWEFxSXBHVThaWmsjdD0xN20yNXMKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IG5hdGl2ZU1heCgwLCBjZWlsKChlbmQgLSBzdGFydCkgLyBzdGVwKSksCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICByZXN1bHRbaW5kZXhdID0gc3RhcnQ7CiAgICAgIHN0YXJ0ICs9IHN0ZXA7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogVGhlIG9wcG9zaXRlIG9mIGBfLmluaXRpYWxgLCB0aGlzIG1ldGhvZCBnZXRzIGFsbCBidXQgdGhlIGZpcnN0IHZhbHVlIG9mIGBhcnJheWAuCiAgICogSWYgYSBudW1iZXIgYG5gIGlzIHBhc3NlZCwgdGhlIGZpcnN0IGBuYCB2YWx1ZXMgYXJlIGV4Y2x1ZGVkIGZyb20gdGhlIHJlc3VsdC4KICAgKiBJZiBhIGBjYWxsYmFja2AgZnVuY3Rpb24gaXMgcGFzc2VkLCB0aGUgZmlyc3QgZWxlbWVudHMgdGhlIGBjYWxsYmFja2AgcmV0dXJucwogICAqIHRydXRoeSBmb3IgYXJlIGV4Y2x1ZGVkIGZyb20gdGhlIHJlc3VsdC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgCiAgICogYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBkcm9wLCB0YWlsCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE51bWJlcn0gW2NhbGxiYWNrfG49MV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgZWxlbWVudCBvcgogICAqICB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIGV4Y2x1ZGUuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIHNsaWNlIG9mIGBhcnJheWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ucmVzdChbMSwgMiwgM10pOwogICAqIC8vID0+IFsyLCAzXQogICAqCiAgICogXy5yZXN0KFsxLCAyLCAzXSwgMik7CiAgICogLy8gPT4gWzNdCiAgICoKICAgKiBfLnJlc3QoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsKICAgKiAgIHJldHVybiBudW0gPCAzOwogICAqIH0pOwogICAqIC8vID0+IFszXQogICAqLwogIGZ1bmN0aW9uIHJlc3QoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicpIHsKICAgICAgdmFyIG4gPSAwLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICAgIGNhbGxiYWNrID0gY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCAmJiBjYWxsYmFjayhhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSkpIHsKICAgICAgICBuKys7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG4gPSAoY2FsbGJhY2sgPT0gbnVsbCB8fCB0aGlzQXJnKSA/IDEgOiBuYXRpdmVNYXgoMCwgY2FsbGJhY2spOwogICAgfQogICAgcmV0dXJuIHNsaWNlKGFycmF5LCBuKTsKICB9CgogIC8qKgogICAqIFVzZXMgYSBiaW5hcnkgc2VhcmNoIHRvIGRldGVybWluZSB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2ggdGhlIGB2YWx1ZWAKICAgKiBzaG91bGQgYmUgaW5zZXJ0ZWQgaW50byBgYXJyYXlgIGluIG9yZGVyIHRvIG1haW50YWluIHRoZSBzb3J0IG9yZGVyIG9mIHRoZQogICAqIHNvcnRlZCBgYXJyYXlgLiBJZiBgY2FsbGJhY2tgIGlzIHBhc3NlZCwgaXQgd2lsbCBiZSBleGVjdXRlZCBmb3IgYHZhbHVlYCBhbmQKICAgKiBlYWNoIGVsZW1lbnQgaW4gYGFycmF5YCB0byBjb21wdXRlIHRoZWlyIHNvcnQgcmFua2luZy4gVGhlIGBjYWxsYmFja2AgaXMKICAgKiBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCBvbmUgYXJndW1lbnQ7ICh2YWx1ZSkuIFRoZSBgY2FsbGJhY2tgCiAgICogYXJndW1lbnQgbWF5IGFsc28gYmUgdGhlIG5hbWUgb2YgYSBwcm9wZXJ0eSB0byBvcmRlciBieS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBldmFsdWF0ZS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5fHByb3BlcnR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICogIHBlciBpdGVyYXRpb24gb3IgcHJvcGVydHkgbmFtZSB0byBvcmRlciBieS4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIHZhbHVlIHNob3VsZCBiZSBpbnNlcnRlZAogICAqICBpbnRvIGBhcnJheWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uc29ydGVkSW5kZXgoWzIwLCAzMCwgNTBdLCA0MCk7CiAgICogLy8gPT4gMgogICAqCiAgICogXy5zb3J0ZWRJbmRleChbeyAneCc6IDIwIH0sIHsgJ3gnOiAzMCB9LCB7ICd4JzogNTAgfV0sIHsgJ3gnOiA0MCB9LCAneCcpOwogICAqIC8vID0+IDIKICAgKgogICAqIHZhciBkaWN0ID0gewogICAqICAgJ3dvcmRUb051bWJlcic6IHsgJ3R3ZW50eSc6IDIwLCAndGhpcnR5JzogMzAsICdmb3VydHknOiA0MCwgJ2ZpZnR5JzogNTAgfQogICAqIH07CiAgICoKICAgKiBfLnNvcnRlZEluZGV4KFsndHdlbnR5JywgJ3RoaXJ0eScsICdmaWZ0eSddLCAnZm91cnR5JywgZnVuY3Rpb24od29yZCkgewogICAqICAgcmV0dXJuIGRpY3Qud29yZFRvTnVtYmVyW3dvcmRdOwogICAqIH0pOwogICAqIC8vID0+IDIKICAgKgogICAqIF8uc29ydGVkSW5kZXgoWyd0d2VudHknLCAndGhpcnR5JywgJ2ZpZnR5J10sICdmb3VydHknLCBmdW5jdGlvbih3b3JkKSB7CiAgICogICByZXR1cm4gdGhpcy53b3JkVG9OdW1iZXJbd29yZF07CiAgICogfSwgZGljdCk7CiAgICogLy8gPT4gMgogICAqLwogIGZ1bmN0aW9uIHNvcnRlZEluZGV4KGFycmF5LCB2YWx1ZSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBsb3cgPSAwLAogICAgICAgIGhpZ2ggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IGxvdzsKCiAgICAvLyBleHBsaWNpdGx5IHJlZmVyZW5jZSBgaWRlbnRpdHlgIGZvciBiZXR0ZXIgaW5saW5pbmcgaW4gRmlyZWZveAogICAgY2FsbGJhY2sgPSBjYWxsYmFjayA/IGNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnKSA6IGlkZW50aXR5OwogICAgdmFsdWUgPSBjYWxsYmFjayh2YWx1ZSk7CgogICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgdmFyIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMTsKICAgICAgY2FsbGJhY2soYXJyYXlbbWlkXSkgPCB2YWx1ZQogICAgICAgID8gbG93ID0gbWlkICsgMQogICAgICAgIDogaGlnaCA9IG1pZDsKICAgIH0KICAgIHJldHVybiBsb3c7CiAgfQoKICAvKioKICAgKiBDb21wdXRlcyB0aGUgdW5pb24gb2YgdGhlIHBhc3NlZC1pbiBhcnJheXMgdXNpbmcgc3RyaWN0IGVxdWFsaXR5IGZvcgogICAqIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheTEsIGFycmF5MiwgLi4uXSBBcnJheXMgdG8gcHJvY2Vzcy4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdW5pcXVlIHZhbHVlcywgaW4gb3JkZXIsIHRoYXQgYXJlCiAgICogIHByZXNlbnQgaW4gb25lIG9yIG1vcmUgb2YgdGhlIGFycmF5cy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy51bmlvbihbMSwgMiwgM10sIFsxMDEsIDIsIDEsIDEwXSwgWzIsIDFdKTsKICAgKiAvLyA9PiBbMSwgMiwgMywgMTAxLCAxMF0KICAgKi8KICBmdW5jdGlvbiB1bmlvbigpIHsKICAgIHJldHVybiB1bmlxKGNvbmNhdC5hcHBseShhcnJheVJlZiwgYXJndW1lbnRzKSk7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZHVwbGljYXRlLXZhbHVlLWZyZWUgdmVyc2lvbiBvZiB0aGUgYGFycmF5YCB1c2luZyBzdHJpY3QgZXF1YWxpdHkKICAgKiBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIHRoZSBgYXJyYXlgIGlzIGFscmVhZHkgc29ydGVkLCBwYXNzaW5nIGB0cnVlYAogICAqIGZvciBgaXNTb3J0ZWRgIHdpbGwgcnVuIGEgZmFzdGVyIGFsZ29yaXRobS4gSWYgYGNhbGxiYWNrYCBpcyBwYXNzZWQsIGVhY2gKICAgKiBlbGVtZW50IG9mIGBhcnJheWAgaXMgcGFzc2VkIHRocm91Z2ggYSBjYWxsYmFja2AgYmVmb3JlIHVuaXF1ZW5lc3MgaXMgY29tcHV0ZWQuCiAgICogVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgdW5pcXVlCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBwcm9jZXNzLgogICAqIEBwYXJhbSB7Qm9vbGVhbn0gW2lzU29ydGVkPWZhbHNlXSBBIGZsYWcgdG8gaW5kaWNhdGUgdGhhdCB0aGUgYGFycmF5YCBpcyBhbHJlYWR5IHNvcnRlZC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgZHVwbGljYXRlLXZhbHVlLWZyZWUgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8udW5pcShbMSwgMiwgMSwgMywgMV0pOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqCiAgICogXy51bmlxKFsxLCAxLCAyLCAyLCAzXSwgdHJ1ZSk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICoKICAgKiBfLnVuaXEoWzEsIDIsIDEuNSwgMywgMi41XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBNYXRoLmZsb29yKG51bSk7IH0pOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqCiAgICogXy51bmlxKFsxLCAyLCAxLjUsIDMsIDIuNV0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gdGhpcy5mbG9vcihudW0pOyB9LCBNYXRoKTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKi8KICBmdW5jdGlvbiB1bmlxKGFycmF5LCBpc1NvcnRlZCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICByZXN1bHQgPSBbXSwKICAgICAgICBzZWVuID0gcmVzdWx0OwoKICAgIC8vIGp1Z2dsZSBhcmd1bWVudHMKICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aGlzQXJnID0gY2FsbGJhY2s7CiAgICAgIGNhbGxiYWNrID0gaXNTb3J0ZWQ7CiAgICAgIGlzU29ydGVkID0gZmFsc2U7CiAgICB9CiAgICAvLyBpbml0IHZhbHVlIGNhY2hlIGZvciBsYXJnZSBhcnJheXMKICAgIHZhciBpc0xhcmdlID0gIWlzU29ydGVkICYmIGxlbmd0aCA+PSA3NTsKICAgIGlmIChpc0xhcmdlKSB7CiAgICAgIHZhciBjYWNoZSA9IHt9OwogICAgfQogICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgIHNlZW4gPSBbXTsKICAgICAgY2FsbGJhY2sgPSBjcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZyk7CiAgICB9CiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF0sCiAgICAgICAgICBjb21wdXRlZCA9IGNhbGxiYWNrID8gY2FsbGJhY2sodmFsdWUsIGluZGV4LCBhcnJheSkgOiB2YWx1ZTsKCiAgICAgIGlmIChpc0xhcmdlKSB7CiAgICAgICAgdmFyIGtleSA9IGNvbXB1dGVkICsgJyc7CiAgICAgICAgdmFyIGluaXRlZCA9IGhhc093blByb3BlcnR5LmNhbGwoY2FjaGUsIGtleSkKICAgICAgICAgID8gIShzZWVuID0gY2FjaGVba2V5XSkKICAgICAgICAgIDogKHNlZW4gPSBjYWNoZVtrZXldID0gW10pOwogICAgICB9CiAgICAgIGlmIChpc1NvcnRlZAogICAgICAgICAgICA/ICFpbmRleCB8fCBzZWVuW3NlZW4ubGVuZ3RoIC0gMV0gIT09IGNvbXB1dGVkCiAgICAgICAgICAgIDogaW5pdGVkIHx8IGluZGV4T2Yoc2VlbiwgY29tcHV0ZWQpIDwgMAogICAgICAgICAgKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrIHx8IGlzTGFyZ2UpIHsKICAgICAgICAgIHNlZW4ucHVzaChjb21wdXRlZCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgd2l0aCBhbGwgb2NjdXJyZW5jZXMgb2YgdGhlIHBhc3NlZCB2YWx1ZXMgcmVtb3ZlZCB1c2luZwogICAqIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGZpbHRlci4KICAgKiBAcGFyYW0ge01peGVkfSBbdmFsdWUxLCB2YWx1ZTIsIC4uLl0gVmFsdWVzIHRvIHJlbW92ZS4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgZmlsdGVyZWQgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ud2l0aG91dChbMSwgMiwgMSwgMCwgMywgMSwgNF0sIDAsIDEpOwogICAqIC8vID0+IFsyLCAzLCA0XQogICAqLwogIGZ1bmN0aW9uIHdpdGhvdXQoYXJyYXkpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICBjb250YWlucyA9IGNhY2hlZENvbnRhaW5zKGFyZ3VtZW50cywgMSksCiAgICAgICAgcmVzdWx0ID0gW107CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICBpZiAoIWNvbnRhaW5zKHZhbHVlKSkgewogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdyb3VwcyB0aGUgZWxlbWVudHMgb2YgZWFjaCBhcnJheSBhdCB0aGVpciBjb3JyZXNwb25kaW5nIGluZGV4ZXMuIFVzZWZ1bCBmb3IKICAgKiBzZXBhcmF0ZSBkYXRhIHNvdXJjZXMgdGhhdCBhcmUgY29vcmRpbmF0ZWQgdGhyb3VnaCBtYXRjaGluZyBhcnJheSBpbmRleGVzLgogICAqIEZvciBhIG1hdHJpeCBvZiBuZXN0ZWQgYXJyYXlzLCBgXy56aXAuYXBwbHkoLi4uKWAgY2FuIHRyYW5zcG9zZSB0aGUgbWF0cml4CiAgICogaW4gYSBzaW1pbGFyIGZhc2hpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5MSwgYXJyYXkyLCAuLi5dIEFycmF5cyB0byBwcm9jZXNzLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBncm91cGVkIGVsZW1lbnRzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnppcChbJ21vZScsICdsYXJyeScsICdjdXJseSddLCBbMzAsIDQwLCA1MF0sIFt0cnVlLCBmYWxzZSwgZmFsc2VdKTsKICAgKiAvLyA9PiBbWydtb2UnLCAzMCwgdHJ1ZV0sIFsnbGFycnknLCA0MCwgZmFsc2VdLCBbJ2N1cmx5JywgNTAsIGZhbHNlXV0KICAgKi8KICBmdW5jdGlvbiB6aXAoYXJyYXkpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gbWF4KHBsdWNrKGFyZ3VtZW50cywgJ2xlbmd0aCcpKSA6IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICByZXN1bHRbaW5kZXhdID0gcGx1Y2soYXJndW1lbnRzLCBpbmRleCk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGlzIHJlc3RyaWN0ZWQgdG8gZXhlY3V0aW5nIGBmdW5jYCBvbmx5IGFmdGVyIGl0IGlzCiAgICogY2FsbGVkIGBuYCB0aW1lcy4gVGhlIGBmdW5jYCBpcyBleGVjdXRlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUKICAgKiBjcmVhdGVkIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7TnVtYmVyfSBuIFRoZSBudW1iZXIgb2YgdGltZXMgdGhlIGZ1bmN0aW9uIG11c3QgYmUgY2FsbGVkIGJlZm9yZQogICAqIGl0IGlzIGV4ZWN1dGVkLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHJlc3RyaWN0LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHJlc3RyaWN0ZWQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciByZW5kZXJOb3RlcyA9IF8uYWZ0ZXIobm90ZXMubGVuZ3RoLCByZW5kZXIpOwogICAqIF8uZm9yRWFjaChub3RlcywgZnVuY3Rpb24obm90ZSkgewogICAqICAgbm90ZS5hc3luY1NhdmUoeyAnc3VjY2Vzcyc6IHJlbmRlck5vdGVzIH0pOwogICAqIH0pOwogICAqIC8vIGByZW5kZXJOb3Rlc2AgaXMgcnVuIG9uY2UsIGFmdGVyIGFsbCBub3RlcyBoYXZlIHNhdmVkCiAgICovCiAgZnVuY3Rpb24gYWZ0ZXIobiwgZnVuYykgewogICAgaWYgKG4gPCAxKSB7CiAgICAgIHJldHVybiBmdW5jKCk7CiAgICB9CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmICgtLW4gPCAxKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgaW52b2tlcyBgZnVuY2Agd2l0aCB0aGUgYHRoaXNgCiAgICogYmluZGluZyBvZiBgdGhpc0FyZ2AgYW5kIHByZXBlbmRzIGFueSBhZGRpdGlvbmFsIGBiaW5kYCBhcmd1bWVudHMgdG8gdGhvc2UKICAgKiBwYXNzZWQgdG8gdGhlIGJvdW5kIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGJpbmQuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgZnVuY2AuCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGJlIHBhcnRpYWxseSBhcHBsaWVkLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGJvdW5kIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgZnVuYyA9IGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICogICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyB0aGlzLm5hbWU7CiAgICogfTsKICAgKgogICAqIGZ1bmMgPSBfLmJpbmQoZnVuYywgeyAnbmFtZSc6ICdtb2UnIH0sICdoaScpOwogICAqIGZ1bmMoKTsKICAgKiAvLyA9PiAnaGkgbW9lJwogICAqLwogIGZ1bmN0aW9uIGJpbmQoZnVuYywgdGhpc0FyZykgewogICAgLy8gdXNlIGBGdW5jdGlvbiNiaW5kYCBpZiBpdCBleGlzdHMgYW5kIGlzIGZhc3QKICAgIC8vIChpbiBWOCBgRnVuY3Rpb24jYmluZGAgaXMgc2xvd2VyIGV4Y2VwdCB3aGVuIHBhcnRpYWxseSBhcHBsaWVkKQogICAgcmV0dXJuIGlzQmluZEZhc3QgfHwgKG5hdGl2ZUJpbmQgJiYgYXJndW1lbnRzLmxlbmd0aCA+IDIpCiAgICAgID8gbmF0aXZlQmluZC5jYWxsLmFwcGx5KG5hdGl2ZUJpbmQsIGFyZ3VtZW50cykKICAgICAgOiBjcmVhdGVCb3VuZChmdW5jLCB0aGlzQXJnLCBzbGljZShhcmd1bWVudHMsIDIpKTsKICB9CgogIC8qKgogICAqIEJpbmRzIG1ldGhvZHMgb24gYG9iamVjdGAgdG8gYG9iamVjdGAsIG92ZXJ3cml0aW5nIHRoZSBleGlzdGluZyBtZXRob2QuCiAgICogTWV0aG9kIG5hbWVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzIG9mIG1ldGhvZAogICAqIG5hbWVzLiBJZiBubyBtZXRob2QgbmFtZXMgYXJlIHByb3ZpZGVkLCBhbGwgdGhlIGZ1bmN0aW9uIHByb3BlcnRpZXMgb2YgYG9iamVjdGAKICAgKiB3aWxsIGJlIGJvdW5kLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBiaW5kIGFuZCBhc3NpZ24gdGhlIGJvdW5kIG1ldGhvZHMgdG8uCiAgICogQHBhcmFtIHtTdHJpbmd9IFttZXRob2ROYW1lMSwgbWV0aG9kTmFtZTIsIC4uLl0gTWV0aG9kIG5hbWVzIG9uIHRoZSBvYmplY3QgdG8gYmluZC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgYnV0dG9uVmlldyA9IHsKICAgKiAgJ2xhYmVsJzogJ2xvZGFzaCcsCiAgICogICdvbkNsaWNrJzogZnVuY3Rpb24oKSB7IGFsZXJ0KCdjbGlja2VkOiAnICsgdGhpcy5sYWJlbCk7IH0KICAgKiB9OwogICAqCiAgICogXy5iaW5kQWxsKGJ1dHRvblZpZXcpOwogICAqIGpRdWVyeSgnI2xvZGFzaF9idXR0b24nKS5vbignY2xpY2snLCBidXR0b25WaWV3Lm9uQ2xpY2spOwogICAqIC8vID0+IFdoZW4gdGhlIGJ1dHRvbiBpcyBjbGlja2VkLCBgdGhpcy5sYWJlbGAgd2lsbCBoYXZlIHRoZSBjb3JyZWN0IHZhbHVlCiAgICovCiAgZnVuY3Rpb24gYmluZEFsbChvYmplY3QpIHsKICAgIHZhciBmdW5jcyA9IGNvbmNhdC5hcHBseShhcnJheVJlZiwgYXJndW1lbnRzKSwKICAgICAgICBpbmRleCA9IGZ1bmNzLmxlbmd0aCA+IDEgPyAwIDogKGZ1bmNzID0gZnVuY3Rpb25zKG9iamVjdCksIC0xKSwKICAgICAgICBsZW5ndGggPSBmdW5jcy5sZW5ndGg7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIGtleSA9IGZ1bmNzW2luZGV4XTsKICAgICAgb2JqZWN0W2tleV0gPSBiaW5kKG9iamVjdFtrZXldLCBvYmplY3QpOwogICAgfQogICAgcmV0dXJuIG9iamVjdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgaW52b2tlcyB0aGUgbWV0aG9kIGF0IGBvYmplY3Rba2V5XWAKICAgKiBhbmQgcHJlcGVuZHMgYW55IGFkZGl0aW9uYWwgYGJpbmRLZXlgIGFyZ3VtZW50cyB0byB0aG9zZSBwYXNzZWQgdG8gdGhlIGJvdW5kCiAgICogZnVuY3Rpb24uIFRoaXMgbWV0aG9kIGRpZmZlcnMgZnJvbSBgXy5iaW5kYCBieSBhbGxvd2luZyBib3VuZCBmdW5jdGlvbnMgdG8KICAgKiByZWZlcmVuY2UgbWV0aG9kcyB0aGF0IHdpbGwgYmUgcmVkZWZpbmVkIG9yIGRvbid0IHlldCBleGlzdC4KICAgKiBTZWUgaHR0cDovL21pY2hhdXguY2EvYXJ0aWNsZXMvbGF6eS1mdW5jdGlvbi1kZWZpbml0aW9uLXBhdHRlcm4uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRoZSBtZXRob2QgYmVsb25ncyB0by4KICAgKiBAcGFyYW0ge1N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIG1ldGhvZC4KICAgKiBAcGFyYW0ge01peGVkfSBbYXJnMSwgYXJnMiwgLi4uXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgYm91bmQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBvYmplY3QgPSB7CiAgICogICAnbmFtZSc6ICdtb2UnLAogICAqICAgJ2dyZWV0JzogZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICAgKiAgICAgcmV0dXJuIGdyZWV0aW5nICsgJyAnICsgdGhpcy5uYW1lOwogICAqICAgfQogICAqIH07CiAgICoKICAgKiB2YXIgZnVuYyA9IF8uYmluZEtleShvYmplY3QsICdncmVldCcsICdoaScpOwogICAqIGZ1bmMoKTsKICAgKiAvLyA9PiAnaGkgbW9lJwogICAqCiAgICogb2JqZWN0LmdyZWV0ID0gZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICAgKiAgIHJldHVybiBncmVldGluZyArICcsICcgKyB0aGlzLm5hbWUgKyAnISc7CiAgICogfTsKICAgKgogICAqIGZ1bmMoKTsKICAgKiAvLyA9PiAnaGksIG1vZSEnCiAgICovCiAgZnVuY3Rpb24gYmluZEtleShvYmplY3QsIGtleSkgewogICAgcmV0dXJuIGNyZWF0ZUJvdW5kKG9iamVjdCwga2V5LCBzbGljZShhcmd1bWVudHMsIDIpKTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGlzIHRoZSBjb21wb3NpdGlvbiBvZiB0aGUgcGFzc2VkIGZ1bmN0aW9ucywKICAgKiB3aGVyZSBlYWNoIGZ1bmN0aW9uIGNvbnN1bWVzIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KICAgKiBGb3IgZXhhbXBsZSwgY29tcG9zaW5nIHRoZSBmdW5jdGlvbnMgYGYoKWAsIGBnKClgLCBhbmQgYGgoKWAgcHJvZHVjZXMgYGYoZyhoKCkpKWAuCiAgICogRWFjaCBmdW5jdGlvbiBpcyBleGVjdXRlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgY29tcG9zZWQgZnVuY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2Z1bmMxLCBmdW5jMiwgLi4uXSBGdW5jdGlvbnMgdG8gY29tcG9zZS4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBjb21wb3NlZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGdyZWV0ID0gZnVuY3Rpb24obmFtZSkgeyByZXR1cm4gJ2hpOiAnICsgbmFtZTsgfTsKICAgKiB2YXIgZXhjbGFpbSA9IGZ1bmN0aW9uKHN0YXRlbWVudCkgeyByZXR1cm4gc3RhdGVtZW50ICsgJyEnOyB9OwogICAqIHZhciB3ZWxjb21lID0gXy5jb21wb3NlKGV4Y2xhaW0sIGdyZWV0KTsKICAgKiB3ZWxjb21lKCdtb2UnKTsKICAgKiAvLyA9PiAnaGk6IG1vZSEnCiAgICovCiAgZnVuY3Rpb24gY29tcG9zZSgpIHsKICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50czsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICBsZW5ndGggPSBmdW5jcy5sZW5ndGg7CgogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICBhcmdzID0gW2Z1bmNzW2xlbmd0aF0uYXBwbHkodGhpcywgYXJncyldOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzWzBdOwogICAgfTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgZGVsYXkgdGhlIGV4ZWN1dGlvbiBvZiBgZnVuY2AgdW50aWwgYWZ0ZXIKICAgKiBgd2FpdGAgbWlsbGlzZWNvbmRzIGhhdmUgZWxhcHNlZCBzaW5jZSB0aGUgbGFzdCB0aW1lIGl0IHdhcyBpbnZva2VkLiBQYXNzCiAgICogYHRydWVgIGZvciBgaW1tZWRpYXRlYCB0byBjYXVzZSBkZWJvdW5jZSB0byBpbnZva2UgYGZ1bmNgIG9uIHRoZSBsZWFkaW5nLAogICAqIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLCBlZGdlIG9mIHRoZSBgd2FpdGAgdGltZW91dC4gU3Vic2VxdWVudCBjYWxscyB0bwogICAqIHRoZSBkZWJvdW5jZWQgZnVuY3Rpb24gd2lsbCByZXR1cm4gdGhlIHJlc3VsdCBvZiB0aGUgbGFzdCBgZnVuY2AgY2FsbC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBkZWJvdW5jZS4KICAgKiBAcGFyYW0ge051bWJlcn0gd2FpdCBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byBkZWxheS4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IGltbWVkaWF0ZSBBIGZsYWcgdG8gaW5kaWNhdGUgZXhlY3V0aW9uIGlzIG9uIHRoZSBsZWFkaW5nCiAgICogIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZGVib3VuY2VkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbGF6eUxheW91dCA9IF8uZGVib3VuY2UoY2FsY3VsYXRlTGF5b3V0LCAzMDApOwogICAqIGpRdWVyeSh3aW5kb3cpLm9uKCdyZXNpemUnLCBsYXp5TGF5b3V0KTsKICAgKi8KICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgIHZhciBhcmdzLAogICAgICAgIHJlc3VsdCwKICAgICAgICB0aGlzQXJnLAogICAgICAgIHRpbWVvdXRJZDsKCiAgICBmdW5jdGlvbiBkZWxheWVkKCkgewogICAgICB0aW1lb3V0SWQgPSBudWxsOwogICAgICBpZiAoIWltbWVkaWF0ZSkgewogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGlzSW1tZWRpYXRlID0gaW1tZWRpYXRlICYmICF0aW1lb3V0SWQ7CiAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHRoaXNBcmcgPSB0aGlzOwoKICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZGVsYXllZCwgd2FpdCk7CgogICAgICBpZiAoaXNJbW1lZGlhdGUpIHsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KCiAgLyoqCiAgICogRXhlY3V0ZXMgdGhlIGBmdW5jYCBmdW5jdGlvbiBhZnRlciBgd2FpdGAgbWlsbGlzZWNvbmRzLiBBZGRpdGlvbmFsIGFyZ3VtZW50cwogICAqIHdpbGwgYmUgcGFzc2VkIHRvIGBmdW5jYCB3aGVuIGl0IGlzIGludm9rZWQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gZGVsYXkuCiAgICogQHBhcmFtIHtOdW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gZGVsYXkgZXhlY3V0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBpbnZva2UgdGhlIGZ1bmN0aW9uIHdpdGguCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgYHNldFRpbWVvdXRgIHRpbWVvdXQgaWQuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBsb2cgPSBfLmJpbmQoY29uc29sZS5sb2csIGNvbnNvbGUpOwogICAqIF8uZGVsYXkobG9nLCAxMDAwLCAnbG9nZ2VkIGxhdGVyJyk7CiAgICogLy8gPT4gJ2xvZ2dlZCBsYXRlcicgKEFwcGVhcnMgYWZ0ZXIgb25lIHNlY29uZC4pCiAgICovCiAgZnVuY3Rpb24gZGVsYXkoZnVuYywgd2FpdCkgewogICAgdmFyIGFyZ3MgPSBzbGljZShhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGZ1bmMuYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsgfSwgd2FpdCk7CiAgfQoKICAvKioKICAgKiBEZWZlcnMgZXhlY3V0aW5nIHRoZSBgZnVuY2AgZnVuY3Rpb24gdW50aWwgdGhlIGN1cnJlbnQgY2FsbCBzdGFjayBoYXMgY2xlYXJlZC4KICAgKiBBZGRpdGlvbmFsIGFyZ3VtZW50cyB3aWxsIGJlIHBhc3NlZCB0byBgZnVuY2Agd2hlbiBpdCBpcyBpbnZva2VkLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGRlZmVyLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBpbnZva2UgdGhlIGZ1bmN0aW9uIHdpdGguCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgYHNldFRpbWVvdXRgIHRpbWVvdXQgaWQuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZGVmZXIoZnVuY3Rpb24oKSB7IGFsZXJ0KCdkZWZlcnJlZCcpOyB9KTsKICAgKiAvLyByZXR1cm5zIGZyb20gdGhlIGZ1bmN0aW9uIGJlZm9yZSBgYWxlcnRgIGlzIGNhbGxlZAogICAqLwogIGZ1bmN0aW9uIGRlZmVyKGZ1bmMpIHsKICAgIHZhciBhcmdzID0gc2xpY2UoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBmdW5jLmFwcGx5KHVuZGVmaW5lZCwgYXJncyk7IH0sIDEpOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgbWVtb2l6ZXMgdGhlIHJlc3VsdCBvZiBgZnVuY2AuIElmIGByZXNvbHZlcmAgaXMKICAgKiBwYXNzZWQsIGl0IHdpbGwgYmUgdXNlZCB0byBkZXRlcm1pbmUgdGhlIGNhY2hlIGtleSBmb3Igc3RvcmluZyB0aGUgcmVzdWx0CiAgICogYmFzZWQgb24gdGhlIGFyZ3VtZW50cyBwYXNzZWQgdG8gdGhlIG1lbW9pemVkIGZ1bmN0aW9uLiBCeSBkZWZhdWx0LCB0aGUgZmlyc3QKICAgKiBhcmd1bWVudCBwYXNzZWQgdG8gdGhlIG1lbW9pemVkIGZ1bmN0aW9uIGlzIHVzZWQgYXMgdGhlIGNhY2hlIGtleS4gVGhlIGBmdW5jYAogICAqIGlzIGV4ZWN1dGVkIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBtZW1vaXplZCBmdW5jdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBoYXZlIGl0cyBvdXRwdXQgbWVtb2l6ZWQuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW3Jlc29sdmVyXSBBIGZ1bmN0aW9uIHVzZWQgdG8gcmVzb2x2ZSB0aGUgY2FjaGUga2V5LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IG1lbW9pemluZyBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGZpYm9uYWNjaSA9IF8ubWVtb2l6ZShmdW5jdGlvbihuKSB7CiAgICogICByZXR1cm4gbiA8IDIgPyBuIDogZmlib25hY2NpKG4gLSAxKSArIGZpYm9uYWNjaShuIC0gMik7CiAgICogfSk7CiAgICovCiAgZnVuY3Rpb24gbWVtb2l6ZShmdW5jLCByZXNvbHZlcikgewogICAgdmFyIGNhY2hlID0ge307CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBrZXkgPSAocmVzb2x2ZXIgPyByZXNvbHZlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogYXJndW1lbnRzWzBdKSArICcnOwogICAgICByZXR1cm4gaGFzT3duUHJvcGVydHkuY2FsbChjYWNoZSwga2V5KQogICAgICAgID8gY2FjaGVba2V5XQogICAgICAgIDogKGNhY2hlW2tleV0gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGlzIHJlc3RyaWN0ZWQgdG8gZXhlY3V0ZSBgZnVuY2Agb25jZS4gUmVwZWF0IGNhbGxzIHRvCiAgICogdGhlIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIHRoZSB2YWx1ZSBvZiB0aGUgZmlyc3QgY2FsbC4gVGhlIGBmdW5jYCBpcyBleGVjdXRlZAogICAqIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBjcmVhdGVkIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHJlc3RyaWN0LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHJlc3RyaWN0ZWQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBpbml0aWFsaXplID0gXy5vbmNlKGNyZWF0ZUFwcGxpY2F0aW9uKTsKICAgKiBpbml0aWFsaXplKCk7CiAgICogaW5pdGlhbGl6ZSgpOwogICAqIC8vIGBpbml0aWFsaXplYCBleGVjdXRlcyBgY3JlYXRlQXBwbGljYXRpb25gIG9uY2UKICAgKi8KICBmdW5jdGlvbiBvbmNlKGZ1bmMpIHsKICAgIHZhciByYW4sCiAgICAgICAgcmVzdWx0OwoKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHJhbikgewogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgcmFuID0gdHJ1ZTsKICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgLy8gY2xlYXIgdGhlIGBmdW5jYCB2YXJpYWJsZSBzbyB0aGUgZnVuY3Rpb24gbWF5IGJlIGdhcmJhZ2UgY29sbGVjdGVkCiAgICAgIGZ1bmMgPSBudWxsOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgaW52b2tlcyBgZnVuY2Agd2l0aCBhbnkgYWRkaXRpb25hbAogICAqIGBwYXJ0aWFsYCBhcmd1bWVudHMgcHJlcGVuZGVkIHRvIHRob3NlIHBhc3NlZCB0byB0aGUgbmV3IGZ1bmN0aW9uLiBUaGlzCiAgICogbWV0aG9kIGlzIHNpbWlsYXIgdG8gYF8uYmluZGAsIGV4Y2VwdCBpdCBkb2VzICoqbm90KiogYWx0ZXIgdGhlIGB0aGlzYCBiaW5kaW5nLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHBhcnRpYWxseSBhcHBseSBhcmd1bWVudHMgdG8uCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGJlIHBhcnRpYWxseSBhcHBsaWVkLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHBhcnRpYWxseSBhcHBsaWVkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgZ3JlZXQgPSBmdW5jdGlvbihncmVldGluZywgbmFtZSkgeyByZXR1cm4gZ3JlZXRpbmcgKyAnOiAnICsgbmFtZTsgfTsKICAgKiB2YXIgaGkgPSBfLnBhcnRpYWwoZ3JlZXQsICdoaScpOwogICAqIGhpKCdtb2UnKTsKICAgKiAvLyA9PiAnaGk6IG1vZScKICAgKi8KICBmdW5jdGlvbiBwYXJ0aWFsKGZ1bmMpIHsKICAgIHJldHVybiBjcmVhdGVCb3VuZChmdW5jLCBzbGljZShhcmd1bWVudHMsIDEpKTsKICB9CgogIC8qKgogICAqIFRoaXMgbWV0aG9kIGlzIHNpbWlsYXIgdG8gYF8ucGFydGlhbGAsIGV4Y2VwdCB0aGF0IGBwYXJ0aWFsYCBhcmd1bWVudHMgYXJlCiAgICogYXBwZW5kZWQgdG8gdGhvc2UgcGFzc2VkIHRvIHRoZSBuZXcgZnVuY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcGFydGlhbGx5IGFwcGx5IGFyZ3VtZW50cyB0by4KICAgKiBAcGFyYW0ge01peGVkfSBbYXJnMSwgYXJnMiwgLi4uXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgcGFydGlhbGx5IGFwcGxpZWQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ubWl4aW4oewogICAqICAgJ2RlZmF1bHRzRGVlcCc6IF8ucGFydGlhbFJpZ2h0KF8ubWVyZ2UsIF8uZGVmYXVsdHMpCiAgICogfSk7CiAgICoKICAgKiB2YXIgb3B0aW9ucyA9IHsKICAgKiAgICd2YXJpYWJsZSc6ICdkYXRhJywKICAgKiAgICdpbXBvcnRzJzogeyAnanEnOiAkIH0KICAgKiB9OwogICAqCiAgICogXy5kZWZhdWx0c0RlZXAob3B0aW9ucywgXy50ZW1wbGF0ZVNldHRpbmdzKTsKICAgKgogICAqIG9wdGlvbnMudmFyaWFibGUKICAgKiAvLyA9PiAnZGF0YScKICAgKgogICAqIG9wdGlvbnMuaW1wb3J0cwogICAqIC8vID0+IHsgJ18nOiBfLCAnanEnOiAkIH0KICAgKi8KICBmdW5jdGlvbiBwYXJ0aWFsUmlnaHQoZnVuYykgewogICAgcmV0dXJuIGNyZWF0ZUJvdW5kKGZ1bmMsIHNsaWNlKGFyZ3VtZW50cywgMSksIG51bGwsIGluZGljYXRvck9iamVjdCk7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBleGVjdXRlZCwgd2lsbCBvbmx5IGNhbGwgdGhlIGBmdW5jYAogICAqIGZ1bmN0aW9uIGF0IG1vc3Qgb25jZSBwZXIgZXZlcnkgYHdhaXRgIG1pbGxpc2Vjb25kcy4gSWYgdGhlIHRocm90dGxlZAogICAqIGZ1bmN0aW9uIGlzIGludm9rZWQgbW9yZSB0aGFuIG9uY2UgZHVyaW5nIHRoZSBgd2FpdGAgdGltZW91dCwgYGZ1bmNgIHdpbGwKICAgKiBhbHNvIGJlIGNhbGxlZCBvbiB0aGUgdHJhaWxpbmcgZWRnZSBvZiB0aGUgdGltZW91dC4gU3Vic2VxdWVudCBjYWxscyB0byB0aGUKICAgKiB0aHJvdHRsZWQgZnVuY3Rpb24gd2lsbCByZXR1cm4gdGhlIHJlc3VsdCBvZiB0aGUgbGFzdCBgZnVuY2AgY2FsbC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byB0aHJvdHRsZS4KICAgKiBAcGFyYW0ge051bWJlcn0gd2FpdCBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB0aHJvdHRsZSBleGVjdXRpb25zIHRvLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHRocm90dGxlZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIHRocm90dGxlZCA9IF8udGhyb3R0bGUodXBkYXRlUG9zaXRpb24sIDEwMCk7CiAgICogalF1ZXJ5KHdpbmRvdykub24oJ3Njcm9sbCcsIHRocm90dGxlZCk7CiAgICovCiAgZnVuY3Rpb24gdGhyb3R0bGUoZnVuYywgd2FpdCkgewogICAgdmFyIGFyZ3MsCiAgICAgICAgcmVzdWx0LAogICAgICAgIHRoaXNBcmcsCiAgICAgICAgdGltZW91dElkLAogICAgICAgIGxhc3RDYWxsZWQgPSAwOwoKICAgIGZ1bmN0aW9uIHRyYWlsaW5nQ2FsbCgpIHsKICAgICAgbGFzdENhbGxlZCA9IG5ldyBEYXRlOwogICAgICB0aW1lb3V0SWQgPSBudWxsOwogICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbm93ID0gbmV3IERhdGUsCiAgICAgICAgICByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIGxhc3RDYWxsZWQpOwoKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdGhpc0FyZyA9IHRoaXM7CgogICAgICBpZiAocmVtYWluaW5nIDw9IDApIHsKICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTsKICAgICAgICB0aW1lb3V0SWQgPSBudWxsOwogICAgICAgIGxhc3RDYWxsZWQgPSBub3c7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgICAgfQogICAgICBlbHNlIGlmICghdGltZW91dElkKSB7CiAgICAgICAgdGltZW91dElkID0gc2V0VGltZW91dCh0cmFpbGluZ0NhbGwsIHJlbWFpbmluZyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBwYXNzZXMgYHZhbHVlYCB0byB0aGUgYHdyYXBwZXJgIGZ1bmN0aW9uIGFzIGl0cwogICAqIGZpcnN0IGFyZ3VtZW50LiBBZGRpdGlvbmFsIGFyZ3VtZW50cyBwYXNzZWQgdG8gdGhlIGZ1bmN0aW9uIGFyZSBhcHBlbmRlZAogICAqIHRvIHRob3NlIHBhc3NlZCB0byB0aGUgYHdyYXBwZXJgIGZ1bmN0aW9uLiBUaGUgYHdyYXBwZXJgIGlzIGV4ZWN1dGVkIHdpdGgKICAgKiB0aGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlIGNyZWF0ZWQgZnVuY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHdyYXAuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gd3JhcHBlciBUaGUgd3JhcHBlciBmdW5jdGlvbi4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGhlbGxvID0gZnVuY3Rpb24obmFtZSkgeyByZXR1cm4gJ2hlbGxvICcgKyBuYW1lOyB9OwogICAqIGhlbGxvID0gXy53cmFwKGhlbGxvLCBmdW5jdGlvbihmdW5jKSB7CiAgICogICByZXR1cm4gJ2JlZm9yZSwgJyArIGZ1bmMoJ21vZScpICsgJywgYWZ0ZXInOwogICAqIH0pOwogICAqIGhlbGxvKCk7CiAgICogLy8gPT4gJ2JlZm9yZSwgaGVsbG8gbW9lLCBhZnRlcicKICAgKi8KICBmdW5jdGlvbiB3cmFwKHZhbHVlLCB3cmFwcGVyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gW3ZhbHVlXTsKICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gd3JhcHBlci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH07CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogQ29udmVydHMgdGhlIGNoYXJhY3RlcnMgYCZgLCBgPGAsIGA+YCwgYCJgLCBhbmQgYCdgIGluIGBzdHJpbmdgIHRvIHRoZWlyCiAgICogY29ycmVzcG9uZGluZyBIVE1MIGVudGl0aWVzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJpbmcgVGhlIHN0cmluZyB0byBlc2NhcGUuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyB0aGUgZXNjYXBlZCBzdHJpbmcuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZXNjYXBlKCdNb2UsIExhcnJ5ICYgQ3VybHknKTsKICAgKiAvLyA9PiAnTW9lLCBMYXJyeSAmYW1wOyBDdXJseScKICAgKi8KICBmdW5jdGlvbiBlc2NhcGUoc3RyaW5nKSB7CiAgICByZXR1cm4gc3RyaW5nID09IG51bGwgPyAnJyA6IChzdHJpbmcgKyAnJykucmVwbGFjZShyZVVuZXNjYXBlZEh0bWwsIGVzY2FwZUh0bWxDaGFyKTsKICB9CgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gcmV0dXJucyB0aGUgZmlyc3QgYXJndW1lbnQgcGFzc2VkIHRvIGl0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIEFueSB2YWx1ZS4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgYHZhbHVlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIG1vZSA9IHsgJ25hbWUnOiAnbW9lJyB9OwogICAqIG1vZSA9PT0gXy5pZGVudGl0eShtb2UpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpZGVudGl0eSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KCiAgLyoqCiAgICogQWRkcyBmdW5jdGlvbnMgcHJvcGVydGllcyBvZiBgb2JqZWN0YCB0byB0aGUgYGxvZGFzaGAgZnVuY3Rpb24gYW5kIGNoYWluYWJsZQogICAqIHdyYXBwZXIuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IG9mIGZ1bmN0aW9uIHByb3BlcnRpZXMgdG8gYWRkIHRvIGBsb2Rhc2hgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLm1peGluKHsKICAgKiAgICdjYXBpdGFsaXplJzogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICogICAgIHJldHVybiBzdHJpbmcuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHJpbmcuc2xpY2UoMSkudG9Mb3dlckNhc2UoKTsKICAgKiAgIH0KICAgKiB9KTsKICAgKgogICAqIF8uY2FwaXRhbGl6ZSgnbGFycnknKTsKICAgKiAvLyA9PiAnTGFycnknCiAgICoKICAgKiBfKCdjdXJseScpLmNhcGl0YWxpemUoKTsKICAgKiAvLyA9PiAnQ3VybHknCiAgICovCiAgZnVuY3Rpb24gbWl4aW4ob2JqZWN0KSB7CiAgICBmb3JFYWNoKGZ1bmN0aW9ucyhvYmplY3QpLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgIHZhciBmdW5jID0gbG9kYXNoW21ldGhvZE5hbWVdID0gb2JqZWN0W21ldGhvZE5hbWVdOwoKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX193cmFwcGVkX19dOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gbmV3IGxvZGFzaChmdW5jLmFwcGx5KGxvZGFzaCwgYXJncykpOwogICAgICB9OwogICAgfSk7CiAgfQoKICAvKioKICAgKiBSZXZlcnRzIHRoZSAnXycgdmFyaWFibGUgdG8gaXRzIHByZXZpb3VzIHZhbHVlIGFuZCByZXR1cm5zIGEgcmVmZXJlbmNlIHRvCiAgICogdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgYGxvZGFzaGAgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBsb2Rhc2ggPSBfLm5vQ29uZmxpY3QoKTsKICAgKi8KICBmdW5jdGlvbiBub0NvbmZsaWN0KCkgewogICAgd2luZG93Ll8gPSBvbGREYXNoOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvKioKICAgKiBQcm9kdWNlcyBhIHJhbmRvbSBudW1iZXIgYmV0d2VlbiBgbWluYCBhbmQgYG1heGAgKGluY2x1c2l2ZSkuIElmIG9ubHkgb25lCiAgICogYXJndW1lbnQgaXMgcGFzc2VkLCBhIG51bWJlciBiZXR3ZWVuIGAwYCBhbmQgdGhlIGdpdmVuIG51bWJlciB3aWxsIGJlIHJldHVybmVkLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7TnVtYmVyfSBbbWluPTBdIFRoZSBtaW5pbXVtIHBvc3NpYmxlIHZhbHVlLgogICAqIEBwYXJhbSB7TnVtYmVyfSBbbWF4PTFdIFRoZSBtYXhpbXVtIHBvc3NpYmxlIHZhbHVlLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgYSByYW5kb20gbnVtYmVyLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnJhbmRvbSgwLCA1KTsKICAgKiAvLyA9PiBhIG51bWJlciBiZXR3ZWVuIDAgYW5kIDUKICAgKgogICAqIF8ucmFuZG9tKDUpOwogICAqIC8vID0+IGFsc28gYSBudW1iZXIgYmV0d2VlbiAwIGFuZCA1CiAgICovCiAgZnVuY3Rpb24gcmFuZG9tKG1pbiwgbWF4KSB7CiAgICBpZiAobWluID09IG51bGwgJiYgbWF4ID09IG51bGwpIHsKICAgICAgbWF4ID0gMTsKICAgIH0KICAgIG1pbiA9ICttaW4gfHwgMDsKICAgIGlmIChtYXggPT0gbnVsbCkgewogICAgICBtYXggPSBtaW47CiAgICAgIG1pbiA9IDA7CiAgICB9CiAgICByZXR1cm4gbWluICsgZmxvb3IobmF0aXZlUmFuZG9tKCkgKiAoKCttYXggfHwgMCkgLSBtaW4gKyAxKSk7CiAgfQoKICAvKioKICAgKiBSZXNvbHZlcyB0aGUgdmFsdWUgb2YgYHByb3BlcnR5YCBvbiBgb2JqZWN0YC4gSWYgYHByb3BlcnR5YCBpcyBhIGZ1bmN0aW9uLAogICAqIGl0IHdpbGwgYmUgaW52b2tlZCBhbmQgaXRzIHJlc3VsdCByZXR1cm5lZCwgZWxzZSB0aGUgcHJvcGVydHkgdmFsdWUgaXMKICAgKiByZXR1cm5lZC4gSWYgYG9iamVjdGAgaXMgZmFsc2V5LCB0aGVuIGBudWxsYCBpcyByZXR1cm5lZC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgVGhlIHByb3BlcnR5IHRvIGdldCB0aGUgdmFsdWUgb2YuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSByZXNvbHZlZCB2YWx1ZS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIG9iamVjdCA9IHsKICAgKiAgICdjaGVlc2UnOiAnY3J1bXBldHMnLAogICAqICAgJ3N0dWZmJzogZnVuY3Rpb24oKSB7CiAgICogICAgIHJldHVybiAnbm9uc2Vuc2UnOwogICAqICAgfQogICAqIH07CiAgICoKICAgKiBfLnJlc3VsdChvYmplY3QsICdjaGVlc2UnKTsKICAgKiAvLyA9PiAnY3J1bXBldHMnCiAgICoKICAgKiBfLnJlc3VsdChvYmplY3QsICdzdHVmZicpOwogICAqIC8vID0+ICdub25zZW5zZScKICAgKi8KICBmdW5jdGlvbiByZXN1bHQob2JqZWN0LCBwcm9wZXJ0eSkgewogICAgLy8gYmFzZWQgb24gQmFja2JvbmUncyBwcml2YXRlIGBnZXRWYWx1ZWAgZnVuY3Rpb24KICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9kb2N1bWVudGNsb3VkL2JhY2tib25lL2Jsb2IvMC45LjIvYmFja2JvbmUuanMjTDE0MTktMTQyNAogICAgdmFyIHZhbHVlID0gb2JqZWN0ID8gb2JqZWN0W3Byb3BlcnR5XSA6IG51bGw7CiAgICByZXR1cm4gaXNGdW5jdGlvbih2YWx1ZSkgPyBvYmplY3RbcHJvcGVydHldKCkgOiB2YWx1ZTsKICB9CgogIC8qKgogICAqIEEgbWljcm8tdGVtcGxhdGluZyBtZXRob2QgdGhhdCBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMKICAgKiB3aGl0ZXNwYWNlLCBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KICAgKgogICAqIE5vdGU6IEluIHRoZSBkZXZlbG9wbWVudCBidWlsZCBgXy50ZW1wbGF0ZWAgdXRpbGl6ZXMgc291cmNlVVJMcyBmb3IgZWFzaWVyCiAgICogZGVidWdnaW5nLiBTZWUgaHR0cDovL3d3dy5odG1sNXJvY2tzLmNvbS9lbi90dXRvcmlhbHMvZGV2ZWxvcGVydG9vbHMvc291cmNlbWFwcy8jdG9jLXNvdXJjZXVybAogICAqCiAgICogTm90ZTogTG8tRGFzaCBtYXkgYmUgdXNlZCBpbiBDaHJvbWUgZXh0ZW5zaW9ucyBieSBlaXRoZXIgY3JlYXRpbmcgYSBgbG9kYXNoIGNzcGAKICAgKiBidWlsZCBhbmQgYXZvaWRpbmcgYF8udGVtcGxhdGVgIHVzZSwgb3IgbG9hZGluZyBMby1EYXNoIGluIGEgc2FuZGJveGVkIHBhZ2UuCiAgICogU2VlIGh0dHA6Ly9kZXZlbG9wZXIuY2hyb21lLmNvbS90cnVuay9leHRlbnNpb25zL3NhbmRib3hpbmdFdmFsLmh0bWwKICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge1N0cmluZ30gdGV4dCBUaGUgdGVtcGxhdGUgdGV4dC4KICAgKiBAcGFyYW0ge09iZWN0fSBkYXRhIFRoZSBkYXRhIG9iamVjdCB1c2VkIHRvIHBvcHVsYXRlIHRoZSB0ZXh0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSBvcHRpb25zIG9iamVjdC4KICAgKiAgZXNjYXBlIC0gVGhlICJlc2NhcGUiIGRlbGltaXRlciByZWdleHAuCiAgICogIGV2YWx1YXRlIC0gVGhlICJldmFsdWF0ZSIgZGVsaW1pdGVyIHJlZ2V4cC4KICAgKiAgaW50ZXJwb2xhdGUgLSBUaGUgImludGVycG9sYXRlIiBkZWxpbWl0ZXIgcmVnZXhwLgogICAqICBzb3VyY2VVUkwgLSBUaGUgc291cmNlVVJMIG9mIHRoZSB0ZW1wbGF0ZSdzIGNvbXBpbGVkIHNvdXJjZS4KICAgKiAgdmFyaWFibGUgLSBUaGUgZGF0YSBvYmplY3QgdmFyaWFibGUgbmFtZS4KICAgKgogICAqIEByZXR1cm5zIHtGdW5jdGlvbnxTdHJpbmd9IFJldHVybnMgYSBjb21waWxlZCBmdW5jdGlvbiB3aGVuIG5vIGBkYXRhYCBvYmplY3QKICAgKiAgaXMgZ2l2ZW4sIGVsc2UgaXQgcmV0dXJucyB0aGUgaW50ZXJwb2xhdGVkIHRleHQuCiAgICogQGV4YW1wbGUKICAgKgogICAqIC8vIHVzaW5nIGEgY29tcGlsZWQgdGVtcGxhdGUKICAgKiB2YXIgY29tcGlsZWQgPSBfLnRlbXBsYXRlKCdoZWxsbyA8JT0gbmFtZSAlPicpOwogICAqIGNvbXBpbGVkKHsgJ25hbWUnOiAnbW9lJyB9KTsKICAgKiAvLyA9PiAnaGVsbG8gbW9lJwogICAqCiAgICogdmFyIGxpc3QgPSAnPCUgXy5mb3JFYWNoKHBlb3BsZSwgZnVuY3Rpb24obmFtZSkgeyAlPjxsaT48JT0gbmFtZSAlPjwvbGk+PCUgfSk7ICU+JzsKICAgKiBfLnRlbXBsYXRlKGxpc3QsIHsgJ3Blb3BsZSc6IFsnbW9lJywgJ2xhcnJ5JywgJ2N1cmx5J10gfSk7CiAgICogLy8gPT4gJzxsaT5tb2U8L2xpPjxsaT5sYXJyeTwvbGk+PGxpPmN1cmx5PC9saT4nCiAgICoKICAgKiAvLyB1c2luZyB0aGUgImVzY2FwZSIgZGVsaW1pdGVyIHRvIGVzY2FwZSBIVE1MIGluIGRhdGEgcHJvcGVydHkgdmFsdWVzCiAgICogXy50ZW1wbGF0ZSgnPGI+PCUtIHZhbHVlICU+PC9iPicsIHsgJ3ZhbHVlJzogJzxzY3JpcHQ+JyB9KTsKICAgKiAvLyA9PiAnPGI+Jmx0O3NjcmlwdCZndDs8L2I+JwogICAqCiAgICogLy8gdXNpbmcgdGhlIEVTNiBkZWxpbWl0ZXIgYXMgYW4gYWx0ZXJuYXRpdmUgdG8gdGhlIGRlZmF1bHQgImludGVycG9sYXRlIiBkZWxpbWl0ZXIKICAgKiBfLnRlbXBsYXRlKCdoZWxsbyAkeyBuYW1lIH0nLCB7ICduYW1lJzogJ2N1cmx5JyB9KTsKICAgKiAvLyA9PiAnaGVsbG8gY3VybHknCiAgICoKICAgKiAvLyB1c2luZyB0aGUgaW50ZXJuYWwgYHByaW50YCBmdW5jdGlvbiBpbiAiZXZhbHVhdGUiIGRlbGltaXRlcnMKICAgKiBfLnRlbXBsYXRlKCc8JSBwcmludCgiaGVsbG8gIiArIGVwaXRoZXQpOyAlPiEnLCB7ICdlcGl0aGV0JzogJ3N0b29nZScgfSk7CiAgICogLy8gPT4gJ2hlbGxvIHN0b29nZSEnCiAgICoKICAgKiAvLyB1c2luZyBjdXN0b20gdGVtcGxhdGUgZGVsaW1pdGVycwogICAqIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgKiAgICdpbnRlcnBvbGF0ZSc6IC97eyhbXHNcU10rPyl9fS9nCiAgICogfTsKICAgKgogICAqIF8udGVtcGxhdGUoJ2hlbGxvIHt7IG5hbWUgfX0hJywgeyAnbmFtZSc6ICdtdXN0YWNoZScgfSk7CiAgICogLy8gPT4gJ2hlbGxvIG11c3RhY2hlIScKICAgKgogICAqIC8vIHVzaW5nIHRoZSBgc291cmNlVVJMYCBvcHRpb24gdG8gc3BlY2lmeSBhIGN1c3RvbSBzb3VyY2VVUkwgZm9yIHRoZSB0ZW1wbGF0ZQogICAqIHZhciBjb21waWxlZCA9IF8udGVtcGxhdGUoJ2hlbGxvIDwlPSBuYW1lICU+JywgbnVsbCwgeyAnc291cmNlVVJMJzogJy9iYXNpYy9ncmVldGluZy5qc3QnIH0pOwogICAqIGNvbXBpbGVkKGRhdGEpOwogICAqIC8vID0+IGZpbmQgdGhlIHNvdXJjZSBvZiAiZ3JlZXRpbmcuanN0IiB1bmRlciB0aGUgU291cmNlcyB0YWIgb3IgUmVzb3VyY2VzIHBhbmVsIG9mIHRoZSB3ZWIgaW5zcGVjdG9yCiAgICoKICAgKiAvLyB1c2luZyB0aGUgYHZhcmlhYmxlYCBvcHRpb24gdG8gZW5zdXJlIGEgd2l0aC1zdGF0ZW1lbnQgaXNuJ3QgdXNlZCBpbiB0aGUgY29tcGlsZWQgdGVtcGxhdGUKICAgKiB2YXIgY29tcGlsZWQgPSBfLnRlbXBsYXRlKCdoZWxsbyA8JT0gZGF0YS5uYW1lICU+IScsIG51bGwsIHsgJ3ZhcmlhYmxlJzogJ2RhdGEnIH0pOwogICAqIGNvbXBpbGVkLnNvdXJjZTsKICAgKiAvLyA9PiBmdW5jdGlvbihkYXRhKSB7CiAgICogICB2YXIgX190LCBfX3AgPSAnJywgX19lID0gXy5lc2NhcGU7CiAgICogICBfX3AgKz0gJ2hlbGxvICcgKyAoKF9fdCA9ICggZGF0YS5uYW1lICkpID09IG51bGwgPyAnJyA6IF9fdCkgKyAnISc7CiAgICogICByZXR1cm4gX19wOwogICAqIH0KICAgKgogICAqIC8vIHVzaW5nIHRoZSBgc291cmNlYCBwcm9wZXJ0eSB0byBpbmxpbmUgY29tcGlsZWQgdGVtcGxhdGVzIGZvciBtZWFuaW5nZnVsCiAgICogLy8gbGluZSBudW1iZXJzIGluIGVycm9yIG1lc3NhZ2VzIGFuZCBhIHN0YWNrIHRyYWNlCiAgICogZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4oY3dkLCAnanN0LmpzJyksICdcCiAgICogICB2YXIgSlNUID0ge1wKICAgKiAgICAgIm1haW4iOiAnICsgXy50ZW1wbGF0ZShtYWluVGV4dCkuc291cmNlICsgJ1wKICAgKiAgIH07XAogICAqICcpOwogICAqLwogIGZ1bmN0aW9uIHRlbXBsYXRlKHRleHQsIGRhdGEsIG9wdGlvbnMpIHsKICAgIC8vIGJhc2VkIG9uIEpvaG4gUmVzaWcncyBgdG1wbGAgaW1wbGVtZW50YXRpb24KICAgIC8vIGh0dHA6Ly9lam9obi5vcmcvYmxvZy9qYXZhc2NyaXB0LW1pY3JvLXRlbXBsYXRpbmcvCiAgICAvLyBhbmQgTGF1cmEgRG9rdG9yb3ZhJ3MgZG9ULmpzCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vb2xhZG8vZG9UCiAgICB2YXIgc2V0dGluZ3MgPSBsb2Rhc2gudGVtcGxhdGVTZXR0aW5nczsKICAgIHRleHQgfHwgKHRleHQgPSAnJyk7CgogICAgLy8gYXZvaWQgbWlzc2luZyBkZXBlbmRlbmNpZXMgd2hlbiBgaXRlcmF0b3JUZW1wbGF0ZWAgaXMgbm90IGRlZmluZWQKICAgIG9wdGlvbnMgPSBpdGVyYXRvclRlbXBsYXRlID8gZGVmYXVsdHMoe30sIG9wdGlvbnMsIHNldHRpbmdzKSA6IHNldHRpbmdzOwoKICAgIHZhciBpbXBvcnRzID0gaXRlcmF0b3JUZW1wbGF0ZSAmJiBkZWZhdWx0cyh7fSwgb3B0aW9ucy5pbXBvcnRzLCBzZXR0aW5ncy5pbXBvcnRzKSwKICAgICAgICBpbXBvcnRzS2V5cyA9IGl0ZXJhdG9yVGVtcGxhdGUgPyBrZXlzKGltcG9ydHMpIDogWydfJ10sCiAgICAgICAgaW1wb3J0c1ZhbHVlcyA9IGl0ZXJhdG9yVGVtcGxhdGUgPyB2YWx1ZXMoaW1wb3J0cykgOiBbbG9kYXNoXTsKCiAgICB2YXIgaXNFdmFsdWF0aW5nLAogICAgICAgIGluZGV4ID0gMCwKICAgICAgICBpbnRlcnBvbGF0ZSA9IG9wdGlvbnMuaW50ZXJwb2xhdGUgfHwgcmVOb01hdGNoLAogICAgICAgIHNvdXJjZSA9ICJfX3AgKz0gJyI7CgogICAgLy8gY29tcGlsZSByZWdleHAgdG8gbWF0Y2ggZWFjaCBkZWxpbWl0ZXIKICAgIHZhciByZURlbGltaXRlcnMgPSBSZWdFeHAoCiAgICAgIChvcHRpb25zLmVzY2FwZSB8fCByZU5vTWF0Y2gpLnNvdXJjZSArICd8JyArCiAgICAgIGludGVycG9sYXRlLnNvdXJjZSArICd8JyArCiAgICAgIChpbnRlcnBvbGF0ZSA9PT0gcmVJbnRlcnBvbGF0ZSA/IHJlRXNUZW1wbGF0ZSA6IHJlTm9NYXRjaCkuc291cmNlICsgJ3wnICsKICAgICAgKG9wdGlvbnMuZXZhbHVhdGUgfHwgcmVOb01hdGNoKS5zb3VyY2UgKyAnfCQnCiAgICAsICdnJyk7CgogICAgdGV4dC5yZXBsYWNlKHJlRGVsaW1pdGVycywgZnVuY3Rpb24obWF0Y2gsIGVzY2FwZVZhbHVlLCBpbnRlcnBvbGF0ZVZhbHVlLCBlc1RlbXBsYXRlVmFsdWUsIGV2YWx1YXRlVmFsdWUsIG9mZnNldCkgewogICAgICBpbnRlcnBvbGF0ZVZhbHVlIHx8IChpbnRlcnBvbGF0ZVZhbHVlID0gZXNUZW1wbGF0ZVZhbHVlKTsKCiAgICAgIC8vIGVzY2FwZSBjaGFyYWN0ZXJzIHRoYXQgY2Fubm90IGJlIGluY2x1ZGVkIGluIHN0cmluZyBsaXRlcmFscwogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KS5yZXBsYWNlKHJlVW5lc2NhcGVkU3RyaW5nLCBlc2NhcGVTdHJpbmdDaGFyKTsKCiAgICAgIC8vIHJlcGxhY2UgZGVsaW1pdGVycyB3aXRoIHNuaXBwZXRzCiAgICAgIGlmIChlc2NhcGVWYWx1ZSkgewogICAgICAgIHNvdXJjZSArPSAiJyArXG5fX2UoIiArIGVzY2FwZVZhbHVlICsgIikgK1xuJyI7CiAgICAgIH0KICAgICAgaWYgKGV2YWx1YXRlVmFsdWUpIHsKICAgICAgICBpc0V2YWx1YXRpbmcgPSB0cnVlOwogICAgICAgIHNvdXJjZSArPSAiJztcbiIgKyBldmFsdWF0ZVZhbHVlICsgIjtcbl9fcCArPSAnIjsKICAgICAgfQogICAgICBpZiAoaW50ZXJwb2xhdGVWYWx1ZSkgewogICAgICAgIHNvdXJjZSArPSAiJyArXG4oKF9fdCA9ICgiICsgaW50ZXJwb2xhdGVWYWx1ZSArICIpKSA9PSBudWxsID8gJycgOiBfX3QpICtcbiciOwogICAgICB9CiAgICAgIGluZGV4ID0gb2Zmc2V0ICsgbWF0Y2gubGVuZ3RoOwoKICAgICAgLy8gdGhlIEpTIGVuZ2luZSBlbWJlZGRlZCBpbiBBZG9iZSBwcm9kdWN0cyByZXF1aXJlcyByZXR1cm5pbmcgdGhlIGBtYXRjaGAKICAgICAgLy8gc3RyaW5nIGluIG9yZGVyIHRvIHByb2R1Y2UgdGhlIGNvcnJlY3QgYG9mZnNldGAgdmFsdWUKICAgICAgcmV0dXJuIG1hdGNoOwogICAgfSk7CgogICAgc291cmNlICs9ICInO1xuIjsKCiAgICAvLyBpZiBgdmFyaWFibGVgIGlzIG5vdCBzcGVjaWZpZWQgYW5kIHRoZSB0ZW1wbGF0ZSBjb250YWlucyAiZXZhbHVhdGUiCiAgICAvLyBkZWxpbWl0ZXJzLCB3cmFwIGEgd2l0aC1zdGF0ZW1lbnQgYXJvdW5kIHRoZSBnZW5lcmF0ZWQgY29kZSB0byBhZGQgdGhlCiAgICAvLyBkYXRhIG9iamVjdCB0byB0aGUgdG9wIG9mIHRoZSBzY29wZSBjaGFpbgogICAgdmFyIHZhcmlhYmxlID0gb3B0aW9ucy52YXJpYWJsZSwKICAgICAgICBoYXNWYXJpYWJsZSA9IHZhcmlhYmxlOwoKICAgIGlmICghaGFzVmFyaWFibGUpIHsKICAgICAgdmFyaWFibGUgPSAnb2JqJzsKICAgICAgc291cmNlID0gJ3dpdGggKCcgKyB2YXJpYWJsZSArICcpIHtcbicgKyBzb3VyY2UgKyAnXG59XG4nOwogICAgfQogICAgLy8gY2xlYW51cCBjb2RlIGJ5IHN0cmlwcGluZyBlbXB0eSBzdHJpbmdzCiAgICBzb3VyY2UgPSAoaXNFdmFsdWF0aW5nID8gc291cmNlLnJlcGxhY2UocmVFbXB0eVN0cmluZ0xlYWRpbmcsICcnKSA6IHNvdXJjZSkKICAgICAgLnJlcGxhY2UocmVFbXB0eVN0cmluZ01pZGRsZSwgJyQxJykKICAgICAgLnJlcGxhY2UocmVFbXB0eVN0cmluZ1RyYWlsaW5nLCAnJDE7Jyk7CgogICAgLy8gZnJhbWUgY29kZSBhcyB0aGUgZnVuY3Rpb24gYm9keQogICAgc291cmNlID0gJ2Z1bmN0aW9uKCcgKyB2YXJpYWJsZSArICcpIHtcbicgKwogICAgICAoaGFzVmFyaWFibGUgPyAnJyA6IHZhcmlhYmxlICsgJyB8fCAoJyArIHZhcmlhYmxlICsgJyA9IHt9KTtcbicpICsKICAgICAgInZhciBfX3QsIF9fcCA9ICcnLCBfX2UgPSBfLmVzY2FwZSIgKwogICAgICAoaXNFdmFsdWF0aW5nCiAgICAgICAgPyAnLCBfX2ogPSBBcnJheS5wcm90b3R5cGUuam9pbjtcbicgKwogICAgICAgICAgImZ1bmN0aW9uIHByaW50KCkgeyBfX3AgKz0gX19qLmNhbGwoYXJndW1lbnRzLCAnJykgfVxuIgogICAgICAgIDogKGhhc1ZhcmlhYmxlID8gJycgOiAnLCBfX2QgPSAnICsgdmFyaWFibGUgKyAnLicgKyB2YXJpYWJsZSArICcgfHwgJyArIHZhcmlhYmxlKSArICc7XG4nCiAgICAgICkgKwogICAgICBzb3VyY2UgKwogICAgICAncmV0dXJuIF9fcFxufSc7CgogICAgLy8gVXNlIGEgc291cmNlVVJMIGZvciBlYXNpZXIgZGVidWdnaW5nIGFuZCB3cmFwIGluIGEgbXVsdGktbGluZSBjb21tZW50IHRvCiAgICAvLyBhdm9pZCBpc3N1ZXMgd2l0aCBOYXJ3aGFsLCBJRSBjb25kaXRpb25hbCBjb21waWxhdGlvbiwgYW5kIHRoZSBKUyBlbmdpbmUKICAgIC8vIGVtYmVkZGVkIGluIEFkb2JlIHByb2R1Y3RzLgogICAgLy8gaHR0cDovL3d3dy5odG1sNXJvY2tzLmNvbS9lbi90dXRvcmlhbHMvZGV2ZWxvcGVydG9vbHMvc291cmNlbWFwcy8jdG9jLXNvdXJjZXVybAogICAgdmFyIHNvdXJjZVVSTCA9ICdcbi8qXG4vL0Agc291cmNlVVJMPScgKyAob3B0aW9ucy5zb3VyY2VVUkwgfHwgJy9sb2Rhc2gvdGVtcGxhdGUvc291cmNlWycgKyAodGVtcGxhdGVDb3VudGVyKyspICsgJ10nKSArICdcbiovJzsKCiAgICB0cnkgewogICAgICB2YXIgcmVzdWx0ID0gRnVuY3Rpb24oaW1wb3J0c0tleXMsICdyZXR1cm4gJyArIHNvdXJjZSArIHNvdXJjZVVSTCkuYXBwbHkodW5kZWZpbmVkLCBpbXBvcnRzVmFsdWVzKTsKICAgIH0gY2F0Y2goZSkgewogICAgICBlLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgdGhyb3cgZTsKICAgIH0KICAgIGlmIChkYXRhKSB7CiAgICAgIHJldHVybiByZXN1bHQoZGF0YSk7CiAgICB9CiAgICAvLyBwcm92aWRlIHRoZSBjb21waWxlZCBmdW5jdGlvbidzIHNvdXJjZSB2aWEgaXRzIGB0b1N0cmluZ2AgbWV0aG9kLCBpbgogICAgLy8gc3VwcG9ydGVkIGVudmlyb25tZW50cywgb3IgdGhlIGBzb3VyY2VgIHByb3BlcnR5IGFzIGEgY29udmVuaWVuY2UgZm9yCiAgICAvLyBpbmxpbmluZyBjb21waWxlZCB0ZW1wbGF0ZXMgZHVyaW5nIHRoZSBidWlsZCBwcm9jZXNzCiAgICByZXN1bHQuc291cmNlID0gc291cmNlOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEV4ZWN1dGVzIHRoZSBgY2FsbGJhY2tgIGZ1bmN0aW9uIGBuYCB0aW1lcywgcmV0dXJuaW5nIGFuIGFycmF5IG9mIHRoZSByZXN1bHRzCiAgICogb2YgZWFjaCBgY2FsbGJhY2tgIGV4ZWN1dGlvbi4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkCiAgICogd2l0aCBvbmUgYXJndW1lbnQ7IChpbmRleCkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHBhcmFtIHtOdW1iZXJ9IG4gVGhlIG51bWJlciBvZiB0aW1lcyB0byBleGVjdXRlIHRoZSBjYWxsYmFjay4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiB0aGUgcmVzdWx0cyBvZiBlYWNoIGBjYWxsYmFja2AgZXhlY3V0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgZGljZVJvbGxzID0gXy50aW1lcygzLCBfLnBhcnRpYWwoXy5yYW5kb20sIDEsIDYpKTsKICAgKiAvLyA9PiBbMywgNiwgNF0KICAgKgogICAqIF8udGltZXMoMywgZnVuY3Rpb24obikgeyBtYWdlLmNhc3RTcGVsbChuKTsgfSk7CiAgICogLy8gPT4gY2FsbHMgYG1hZ2UuY2FzdFNwZWxsKG4pYCB0aHJlZSB0aW1lcywgcGFzc2luZyBgbmAgb2YgYDBgLCBgMWAsIGFuZCBgMmAgcmVzcGVjdGl2ZWx5CiAgICoKICAgKiBfLnRpbWVzKDMsIGZ1bmN0aW9uKG4pIHsgdGhpcy5jYXN0KG4pOyB9LCBtYWdlKTsKICAgKiAvLyA9PiBhbHNvIGNhbGxzIGBtYWdlLmNhc3RTcGVsbChuKWAgdGhyZWUgdGltZXMKICAgKi8KICBmdW5jdGlvbiB0aW1lcyhuLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgbiA9ICtuIHx8IDA7CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICByZXN1bHQgPSBBcnJheShuKTsKCiAgICB3aGlsZSAoKytpbmRleCA8IG4pIHsKICAgICAgcmVzdWx0W2luZGV4XSA9IGNhbGxiYWNrLmNhbGwodGhpc0FyZywgaW5kZXgpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFRoZSBvcHBvc2l0ZSBvZiBgXy5lc2NhcGVgLCB0aGlzIG1ldGhvZCBjb252ZXJ0cyB0aGUgSFRNTCBlbnRpdGllcwogICAqIGAmYW1wO2AsIGAmbHQ7YCwgYCZndDtgLCBgJnF1b3Q7YCwgYW5kIGAmI3gyNztgIGluIGBzdHJpbmdgIHRvIHRoZWlyCiAgICogY29ycmVzcG9uZGluZyBjaGFyYWN0ZXJzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJpbmcgVGhlIHN0cmluZyB0byB1bmVzY2FwZS4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSB1bmVzY2FwZWQgc3RyaW5nLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnVuZXNjYXBlKCdNb2UsIExhcnJ5ICZhbXA7IEN1cmx5Jyk7CiAgICogLy8gPT4gJ01vZSwgTGFycnkgJiBDdXJseScKICAgKi8KICBmdW5jdGlvbiB1bmVzY2FwZShzdHJpbmcpIHsKICAgIHJldHVybiBzdHJpbmcgPT0gbnVsbCA/ICcnIDogKHN0cmluZyArICcnKS5yZXBsYWNlKHJlRXNjYXBlZEh0bWwsIHVuZXNjYXBlSHRtbENoYXIpOwogIH0KCiAgLyoqCiAgICogR2VuZXJhdGVzIGEgdW5pcXVlIElELiBJZiBgcHJlZml4YCBpcyBwYXNzZWQsIHRoZSBJRCB3aWxsIGJlIGFwcGVuZGVkIHRvIGl0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7U3RyaW5nfSBbcHJlZml4XSBUaGUgdmFsdWUgdG8gcHJlZml4IHRoZSBJRCB3aXRoLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgdGhlIHVuaXF1ZSBJRC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy51bmlxdWVJZCgnY29udGFjdF8nKTsKICAgKiAvLyA9PiAnY29udGFjdF8xMDQnCiAgICoKICAgKiBfLnVuaXF1ZUlkKCk7CiAgICogLy8gPT4gJzEwNScKICAgKi8KICBmdW5jdGlvbiB1bmlxdWVJZChwcmVmaXgpIHsKICAgIHZhciBpZCA9ICsraWRDb3VudGVyOwogICAgcmV0dXJuIChwcmVmaXggPT0gbnVsbCA/ICcnIDogcHJlZml4ICsgJycpICsgaWQ7CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogSW52b2tlcyBgaW50ZXJjZXB0b3JgIHdpdGggdGhlIGB2YWx1ZWAgYXMgdGhlIGZpcnN0IGFyZ3VtZW50LCBhbmQgdGhlbgogICAqIHJldHVybnMgYHZhbHVlYC4gVGhlIHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwKICAgKiBpbiBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBwYXNzIHRvIGBpbnRlcmNlcHRvcmAuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gaW50ZXJjZXB0b3IgVGhlIGZ1bmN0aW9uIHRvIGludm9rZS4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgYHZhbHVlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXyhbMSwgMiwgMywgNF0pCiAgICogIC5maWx0ZXIoZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pCiAgICogIC50YXAoYWxlcnQpCiAgICogIC5tYXAoZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiBudW07IH0pCiAgICogIC52YWx1ZSgpOwogICAqIC8vID0+IC8vIFsyLCA0XSAoYWxlcnRlZCkKICAgKiAvLyA9PiBbNCwgMTZdCiAgICovCiAgZnVuY3Rpb24gdGFwKHZhbHVlLCBpbnRlcmNlcHRvcikgewogICAgaW50ZXJjZXB0b3IodmFsdWUpOwogICAgcmV0dXJuIHZhbHVlOwogIH0KCiAgLyoqCiAgICogUHJvZHVjZXMgdGhlIGB0b1N0cmluZ2AgcmVzdWx0IG9mIHRoZSB3cmFwcGVkIHZhbHVlLgogICAqCiAgICogQG5hbWUgdG9TdHJpbmcKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgdGhlIHN0cmluZyByZXN1bHQuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8oWzEsIDIsIDNdKS50b1N0cmluZygpOwogICAqIC8vID0+ICcxLDIsMycKICAgKi8KICBmdW5jdGlvbiB3cmFwcGVyVG9TdHJpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5fX3dyYXBwZWRfXyArICcnOwogIH0KCiAgLyoqCiAgICogRXh0cmFjdHMgdGhlIHdyYXBwZWQgdmFsdWUuCiAgICoKICAgKiBAbmFtZSB2YWx1ZU9mCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgdmFsdWUKICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIHdyYXBwZWQgdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8oWzEsIDIsIDNdKS52YWx1ZU9mKCk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICovCiAgZnVuY3Rpb24gd3JhcHBlclZhbHVlT2YoKSB7CiAgICByZXR1cm4gdGhpcy5fX3dyYXBwZWRfXzsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvLyBhZGQgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIHdyYXBwZWQgdmFsdWVzIHdoZW4gY2hhaW5pbmcKICBsb2Rhc2guYWZ0ZXIgPSBhZnRlcjsKICBsb2Rhc2guYXNzaWduID0gYXNzaWduOwogIGxvZGFzaC5hdCA9IGF0OwogIGxvZGFzaC5iaW5kID0gYmluZDsKICBsb2Rhc2guYmluZEFsbCA9IGJpbmRBbGw7CiAgbG9kYXNoLmJpbmRLZXkgPSBiaW5kS2V5OwogIGxvZGFzaC5jb21wYWN0ID0gY29tcGFjdDsKICBsb2Rhc2guY29tcG9zZSA9IGNvbXBvc2U7CiAgbG9kYXNoLmNvdW50QnkgPSBjb3VudEJ5OwogIGxvZGFzaC5kZWJvdW5jZSA9IGRlYm91bmNlOwogIGxvZGFzaC5kZWZhdWx0cyA9IGRlZmF1bHRzOwogIGxvZGFzaC5kZWZlciA9IGRlZmVyOwogIGxvZGFzaC5kZWxheSA9IGRlbGF5OwogIGxvZGFzaC5kaWZmZXJlbmNlID0gZGlmZmVyZW5jZTsKICBsb2Rhc2guZmlsdGVyID0gZmlsdGVyOwogIGxvZGFzaC5mbGF0dGVuID0gZmxhdHRlbjsKICBsb2Rhc2guZm9yRWFjaCA9IGZvckVhY2g7CiAgbG9kYXNoLmZvckluID0gZm9ySW47CiAgbG9kYXNoLmZvck93biA9IGZvck93bjsKICBsb2Rhc2guZnVuY3Rpb25zID0gZnVuY3Rpb25zOwogIGxvZGFzaC5ncm91cEJ5ID0gZ3JvdXBCeTsKICBsb2Rhc2guaW5pdGlhbCA9IGluaXRpYWw7CiAgbG9kYXNoLmludGVyc2VjdGlvbiA9IGludGVyc2VjdGlvbjsKICBsb2Rhc2guaW52ZXJ0ID0gaW52ZXJ0OwogIGxvZGFzaC5pbnZva2UgPSBpbnZva2U7CiAgbG9kYXNoLmtleXMgPSBrZXlzOwogIGxvZGFzaC5tYXAgPSBtYXA7CiAgbG9kYXNoLm1heCA9IG1heDsKICBsb2Rhc2gubWVtb2l6ZSA9IG1lbW9pemU7CiAgbG9kYXNoLm1lcmdlID0gbWVyZ2U7CiAgbG9kYXNoLm1pbiA9IG1pbjsKICBsb2Rhc2gub2JqZWN0ID0gb2JqZWN0OwogIGxvZGFzaC5vbWl0ID0gb21pdDsKICBsb2Rhc2gub25jZSA9IG9uY2U7CiAgbG9kYXNoLnBhaXJzID0gcGFpcnM7CiAgbG9kYXNoLnBhcnRpYWwgPSBwYXJ0aWFsOwogIGxvZGFzaC5wYXJ0aWFsUmlnaHQgPSBwYXJ0aWFsUmlnaHQ7CiAgbG9kYXNoLnBpY2sgPSBwaWNrOwogIGxvZGFzaC5wbHVjayA9IHBsdWNrOwogIGxvZGFzaC5yYW5nZSA9IHJhbmdlOwogIGxvZGFzaC5yZWplY3QgPSByZWplY3Q7CiAgbG9kYXNoLnJlc3QgPSByZXN0OwogIGxvZGFzaC5zaHVmZmxlID0gc2h1ZmZsZTsKICBsb2Rhc2guc29ydEJ5ID0gc29ydEJ5OwogIGxvZGFzaC50YXAgPSB0YXA7CiAgbG9kYXNoLnRocm90dGxlID0gdGhyb3R0bGU7CiAgbG9kYXNoLnRpbWVzID0gdGltZXM7CiAgbG9kYXNoLnRvQXJyYXkgPSB0b0FycmF5OwogIGxvZGFzaC51bmlvbiA9IHVuaW9uOwogIGxvZGFzaC51bmlxID0gdW5pcTsKICBsb2Rhc2gudmFsdWVzID0gdmFsdWVzOwogIGxvZGFzaC53aGVyZSA9IHdoZXJlOwogIGxvZGFzaC53aXRob3V0ID0gd2l0aG91dDsKICBsb2Rhc2gud3JhcCA9IHdyYXA7CiAgbG9kYXNoLnppcCA9IHppcDsKCiAgLy8gYWRkIGFsaWFzZXMKICBsb2Rhc2guY29sbGVjdCA9IG1hcDsKICBsb2Rhc2guZHJvcCA9IHJlc3Q7CiAgbG9kYXNoLmVhY2ggPSBmb3JFYWNoOwogIGxvZGFzaC5leHRlbmQgPSBhc3NpZ247CiAgbG9kYXNoLm1ldGhvZHMgPSBmdW5jdGlvbnM7CiAgbG9kYXNoLnNlbGVjdCA9IGZpbHRlcjsKICBsb2Rhc2gudGFpbCA9IHJlc3Q7CiAgbG9kYXNoLnVuaXF1ZSA9IHVuaXE7CgogIC8vIGFkZCBmdW5jdGlvbnMgdG8gYGxvZGFzaC5wcm90b3R5cGVgCiAgbWl4aW4obG9kYXNoKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8vIGFkZCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gdW53cmFwcGVkIHZhbHVlcyB3aGVuIGNoYWluaW5nCiAgbG9kYXNoLmNsb25lID0gY2xvbmU7CiAgbG9kYXNoLmNsb25lRGVlcCA9IGNsb25lRGVlcDsKICBsb2Rhc2guY29udGFpbnMgPSBjb250YWluczsKICBsb2Rhc2guZXNjYXBlID0gZXNjYXBlOwogIGxvZGFzaC5ldmVyeSA9IGV2ZXJ5OwogIGxvZGFzaC5maW5kID0gZmluZDsKICBsb2Rhc2guaGFzID0gaGFzOwogIGxvZGFzaC5pZGVudGl0eSA9IGlkZW50aXR5OwogIGxvZGFzaC5pbmRleE9mID0gaW5kZXhPZjsKICBsb2Rhc2guaXNBcmd1bWVudHMgPSBpc0FyZ3VtZW50czsKICBsb2Rhc2guaXNBcnJheSA9IGlzQXJyYXk7CiAgbG9kYXNoLmlzQm9vbGVhbiA9IGlzQm9vbGVhbjsKICBsb2Rhc2guaXNEYXRlID0gaXNEYXRlOwogIGxvZGFzaC5pc0VsZW1lbnQgPSBpc0VsZW1lbnQ7CiAgbG9kYXNoLmlzRW1wdHkgPSBpc0VtcHR5OwogIGxvZGFzaC5pc0VxdWFsID0gaXNFcXVhbDsKICBsb2Rhc2guaXNGaW5pdGUgPSBpc0Zpbml0ZTsKICBsb2Rhc2guaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb247CiAgbG9kYXNoLmlzTmFOID0gaXNOYU47CiAgbG9kYXNoLmlzTnVsbCA9IGlzTnVsbDsKICBsb2Rhc2guaXNOdW1iZXIgPSBpc051bWJlcjsKICBsb2Rhc2guaXNPYmplY3QgPSBpc09iamVjdDsKICBsb2Rhc2guaXNQbGFpbk9iamVjdCA9IGlzUGxhaW5PYmplY3Q7CiAgbG9kYXNoLmlzUmVnRXhwID0gaXNSZWdFeHA7CiAgbG9kYXNoLmlzU3RyaW5nID0gaXNTdHJpbmc7CiAgbG9kYXNoLmlzVW5kZWZpbmVkID0gaXNVbmRlZmluZWQ7CiAgbG9kYXNoLmxhc3RJbmRleE9mID0gbGFzdEluZGV4T2Y7CiAgbG9kYXNoLm1peGluID0gbWl4aW47CiAgbG9kYXNoLm5vQ29uZmxpY3QgPSBub0NvbmZsaWN0OwogIGxvZGFzaC5yYW5kb20gPSByYW5kb207CiAgbG9kYXNoLnJlZHVjZSA9IHJlZHVjZTsKICBsb2Rhc2gucmVkdWNlUmlnaHQgPSByZWR1Y2VSaWdodDsKICBsb2Rhc2gucmVzdWx0ID0gcmVzdWx0OwogIGxvZGFzaC5zaXplID0gc2l6ZTsKICBsb2Rhc2guc29tZSA9IHNvbWU7CiAgbG9kYXNoLnNvcnRlZEluZGV4ID0gc29ydGVkSW5kZXg7CiAgbG9kYXNoLnRlbXBsYXRlID0gdGVtcGxhdGU7CiAgbG9kYXNoLnVuZXNjYXBlID0gdW5lc2NhcGU7CiAgbG9kYXNoLnVuaXF1ZUlkID0gdW5pcXVlSWQ7CgogIC8vIGFkZCBhbGlhc2VzCiAgbG9kYXNoLmFsbCA9IGV2ZXJ5OwogIGxvZGFzaC5hbnkgPSBzb21lOwogIGxvZGFzaC5kZXRlY3QgPSBmaW5kOwogIGxvZGFzaC5mb2xkbCA9IHJlZHVjZTsKICBsb2Rhc2guZm9sZHIgPSByZWR1Y2VSaWdodDsKICBsb2Rhc2guaW5jbHVkZSA9IGNvbnRhaW5zOwogIGxvZGFzaC5pbmplY3QgPSByZWR1Y2U7CgogIGZvck93bihsb2Rhc2gsIGZ1bmN0aW9uKGZ1bmMsIG1ldGhvZE5hbWUpIHsKICAgIGlmICghbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSkgewogICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbdGhpcy5fX3dyYXBwZWRfX107CiAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KGxvZGFzaCwgYXJncyk7CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvLyBhZGQgZnVuY3Rpb25zIGNhcGFibGUgb2YgcmV0dXJuaW5nIHdyYXBwZWQgYW5kIHVud3JhcHBlZCB2YWx1ZXMgd2hlbiBjaGFpbmluZwogIGxvZGFzaC5maXJzdCA9IGZpcnN0OwogIGxvZGFzaC5sYXN0ID0gbGFzdDsKCiAgLy8gYWRkIGFsaWFzZXMKICBsb2Rhc2gudGFrZSA9IGZpcnN0OwogIGxvZGFzaC5oZWFkID0gZmlyc3Q7CgogIGZvck93bihsb2Rhc2gsIGZ1bmN0aW9uKGZ1bmMsIG1ldGhvZE5hbWUpIHsKICAgIGlmICghbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSkgewogICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdPSBmdW5jdGlvbihjYWxsYmFjaywgdGhpc0FyZykgewogICAgICAgIHZhciByZXN1bHQgPSBmdW5jKHRoaXMuX193cmFwcGVkX18sIGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgICAgICByZXR1cm4gY2FsbGJhY2sgPT0gbnVsbCB8fCAodGhpc0FyZyAmJiB0eXBlb2YgY2FsbGJhY2sgIT0gJ2Z1bmN0aW9uJykKICAgICAgICAgID8gcmVzdWx0CiAgICAgICAgICA6IG5ldyBsb2Rhc2gocmVzdWx0KTsKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIFRoZSBzZW1hbnRpYyB2ZXJzaW9uIG51bWJlci4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEB0eXBlIFN0cmluZwogICAqLwogIGxvZGFzaC5WRVJTSU9OID0gJzEuMC4wLXJjLjMnOwoKICAvLyBhZGQgIkNoYWluaW5nIiBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIKICBsb2Rhc2gucHJvdG90eXBlLnRvU3RyaW5nID0gd3JhcHBlclRvU3RyaW5nOwogIGxvZGFzaC5wcm90b3R5cGUudmFsdWUgPSB3cmFwcGVyVmFsdWVPZjsKICBsb2Rhc2gucHJvdG90eXBlLnZhbHVlT2YgPSB3cmFwcGVyVmFsdWVPZjsKCiAgLy8gYWRkIGBBcnJheWAgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIHVud3JhcHBlZCB2YWx1ZXMKICBlYWNoKFsnam9pbicsICdwb3AnLCAnc2hpZnQnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgdmFyIGZ1bmMgPSBhcnJheVJlZlttZXRob2ROYW1lXTsKICAgIGxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcy5fX3dyYXBwZWRfXywgYXJndW1lbnRzKTsKICAgIH07CiAgfSk7CgogIC8vIGFkZCBgQXJyYXlgIGZ1bmN0aW9ucyB0aGF0IHJldHVybiB0aGUgd3JhcHBlZCB2YWx1ZQogIGVhY2goWydwdXNoJywgJ3JldmVyc2UnLCAnc29ydCcsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgIHZhciBmdW5jID0gYXJyYXlSZWZbbWV0aG9kTmFtZV07CiAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgIGZ1bmMuYXBwbHkodGhpcy5fX3dyYXBwZWRfXywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogIH0pOwoKICAvLyBhZGQgYEFycmF5YCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gbmV3IHdyYXBwZWQgdmFsdWVzCiAgZWFjaChbJ2NvbmNhdCcsICdzbGljZScsICdzcGxpY2UnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgdmFyIGZ1bmMgPSBhcnJheVJlZlttZXRob2ROYW1lXTsKICAgIGxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyBsb2Rhc2goZnVuYy5hcHBseSh0aGlzLl9fd3JhcHBlZF9fLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CgogIC8vIGF2b2lkIGFycmF5LWxpa2Ugb2JqZWN0IGJ1Z3Mgd2l0aCBgQXJyYXkjc2hpZnRgIGFuZCBgQXJyYXkjc3BsaWNlYAogIC8vIGluIEZpcmVmb3ggPCAxMCBhbmQgSUUgPCA5CiAgaWYgKGhhc09iamVjdFNwbGljZUJ1ZykgewogICAgZWFjaChbJ3BvcCcsICdzaGlmdCcsICdzcGxpY2UnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICB2YXIgZnVuYyA9IGFycmF5UmVmW21ldGhvZE5hbWVdLAogICAgICAgICAgaXNTcGxpY2UgPSBtZXRob2ROYW1lID09ICdzcGxpY2UnOwoKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuX193cmFwcGVkX18sCiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodmFsdWUsIGFyZ3VtZW50cyk7CgogICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICAgIGRlbGV0ZSB2YWx1ZVswXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzU3BsaWNlID8gbmV3IGxvZGFzaChyZXN1bHQpIDogcmVzdWx0OwogICAgICB9OwogICAgfSk7CiAgfQoKICAvLyBhZGQgcHNldWRvIHByaXZhdGUgcHJvcGVydHkgdG8gYmUgdXNlZCBhbmQgcmVtb3ZlZCBkdXJpbmcgdGhlIGJ1aWxkIHByb2Nlc3MKICBsb2Rhc2guX2VhY2ggPSBlYWNoOwogIGxvZGFzaC5faXRlcmF0b3JUZW1wbGF0ZSA9IGl0ZXJhdG9yVGVtcGxhdGU7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvLyBleHBvc2UgTG8tRGFzaAogIC8vIHNvbWUgQU1EIGJ1aWxkIG9wdGltaXplcnMsIGxpa2Ugci5qcywgY2hlY2sgZm9yIHNwZWNpZmljIGNvbmRpdGlvbiBwYXR0ZXJucyBsaWtlIHRoZSBmb2xsb3dpbmc6CiAgaWYgKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgZGVmaW5lLmFtZCA9PSAnb2JqZWN0JyAmJiBkZWZpbmUuYW1kKSB7CiAgICAvLyBFeHBvc2UgTG8tRGFzaCB0byB0aGUgZ2xvYmFsIG9iamVjdCBldmVuIHdoZW4gYW4gQU1EIGxvYWRlciBpcyBwcmVzZW50IGluCiAgICAvLyBjYXNlIExvLURhc2ggd2FzIGluamVjdGVkIGJ5IGEgdGhpcmQtcGFydHkgc2NyaXB0IGFuZCBub3QgaW50ZW5kZWQgdG8gYmUKICAgIC8vIGxvYWRlZCBhcyBhIG1vZHVsZS4gVGhlIGdsb2JhbCBhc3NpZ25tZW50IGNhbiBiZSByZXZlcnRlZCBpbiB0aGUgTG8tRGFzaAogICAgLy8gbW9kdWxlIHZpYSBpdHMgYG5vQ29uZmxpY3QoKWAgbWV0aG9kLgogICAgd2luZG93Ll8gPSBsb2Rhc2g7CgogICAgLy8gZGVmaW5lIGFzIGFuIGFub255bW91cyBtb2R1bGUgc28sIHRocm91Z2ggcGF0aCBtYXBwaW5nLCBpdCBjYW4gYmUKICAgIC8vIHJlZmVyZW5jZWQgYXMgdGhlICJ1bmRlcnNjb3JlIiBtb2R1bGUKICAgIGRlZmluZSgnbG9kYXNoJyxbXSxmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGxvZGFzaDsKICAgIH0pOwogIH0KICAvLyBjaGVjayBmb3IgYGV4cG9ydHNgIGFmdGVyIGBkZWZpbmVgIGluIGNhc2UgYSBidWlsZCBvcHRpbWl6ZXIgYWRkcyBhbiBgZXhwb3J0c2Agb2JqZWN0CiAgZWxzZSBpZiAoZnJlZUV4cG9ydHMpIHsKICAgIC8vIGluIE5vZGUuanMgb3IgUmluZ29KUyB2MC44LjArCiAgICBpZiAodHlwZW9mIG1vZHVsZSA9PSAnb2JqZWN0JyAmJiBtb2R1bGUgJiYgbW9kdWxlLmV4cG9ydHMgPT0gZnJlZUV4cG9ydHMpIHsKICAgICAgKG1vZHVsZS5leHBvcnRzID0gbG9kYXNoKS5fID0gbG9kYXNoOwogICAgfQogICAgLy8gaW4gTmFyd2hhbCBvciBSaW5nb0pTIHYwLjcuMC0KICAgIGVsc2UgewogICAgICBmcmVlRXhwb3J0cy5fID0gbG9kYXNoOwogICAgfQogIH0KICBlbHNlIHsKICAgIC8vIGluIGEgYnJvd3NlciBvciBSaGlubwogICAgd2luZG93Ll8gPSBsb2Rhc2g7CiAgfQp9KHRoaXMpKTsKCi8vICBVbmRlcnNjb3JlLnN0cmluZwovLyAgKGMpIDIwMTAgRXNhLU1hdHRpIFN1dXJvbmVuIDxlc2EtbWF0dGkgYWV0IHN1dXJvbmVuIGRvdCBvcmc+Ci8vICBVbmRlcnNjb3JlLnN0cmluZyBpcyBmcmVlbHkgZGlzdHJpYnV0YWJsZSB1bmRlciB0aGUgdGVybXMgb2YgdGhlIE1JVCBsaWNlbnNlLgovLyAgRG9jdW1lbnRhdGlvbjogaHR0cHM6Ly9naXRodWIuY29tL2VwZWxpL3VuZGVyc2NvcmUuc3RyaW5nCi8vICBTb21lIGNvZGUgaXMgYm9ycm93ZWQgZnJvbSBNb29Ub29scyBhbmQgQWxleGFuZHJ1IE1hcmFzdGVhbnUuCi8vICBWZXJzaW9uICcyLjMuMScKCiFmdW5jdGlvbihyb290LCBTdHJpbmcpewogIAoKICAvLyBEZWZpbmluZyBoZWxwZXIgZnVuY3Rpb25zLgoKICB2YXIgbmF0aXZlVHJpbSA9IFN0cmluZy5wcm90b3R5cGUudHJpbTsKICB2YXIgbmF0aXZlVHJpbVJpZ2h0ID0gU3RyaW5nLnByb3RvdHlwZS50cmltUmlnaHQ7CiAgdmFyIG5hdGl2ZVRyaW1MZWZ0ID0gU3RyaW5nLnByb3RvdHlwZS50cmltTGVmdDsKCiAgdmFyIHBhcnNlTnVtYmVyID0gZnVuY3Rpb24oc291cmNlKSB7IHJldHVybiBzb3VyY2UgKiAxIHx8IDA7IH07CgogIHZhciBzdHJSZXBlYXQgPSBmdW5jdGlvbihzdHIsIHF0eSl7CiAgICBpZiAocXR5IDwgMSkgcmV0dXJuICcnOwogICAgdmFyIHJlc3VsdCA9ICcnOwogICAgd2hpbGUgKHF0eSA+IDApIHsKICAgICAgaWYgKHF0eSAmIDEpIHJlc3VsdCArPSBzdHI7CiAgICAgIHF0eSA+Pj0gMSwgc3RyICs9IHN0cjsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgdmFyIHNsaWNlID0gW10uc2xpY2U7CgogIHZhciBkZWZhdWx0VG9XaGl0ZVNwYWNlID0gZnVuY3Rpb24oY2hhcmFjdGVycykgewogICAgaWYgKGNoYXJhY3RlcnMgPT0gbnVsbCkKICAgICAgcmV0dXJuICdcXHMnOwogICAgZWxzZSBpZiAoY2hhcmFjdGVycy5zb3VyY2UpCiAgICAgIHJldHVybiBjaGFyYWN0ZXJzLnNvdXJjZTsKICAgIGVsc2UKICAgICAgcmV0dXJuICdbJyArIF9zLmVzY2FwZVJlZ0V4cChjaGFyYWN0ZXJzKSArICddJzsKICB9OwoKICB2YXIgZXNjYXBlQ2hhcnMgPSB7CiAgICBsdDogJzwnLAogICAgZ3Q6ICc+JywKICAgIHF1b3Q6ICciJywKICAgIGFtcDogJyYnLAogICAgYXBvczogIiciCiAgfTsKCiAgdmFyIHJldmVyc2VkRXNjYXBlQ2hhcnMgPSB7fTsKICBmb3IodmFyIGtleSBpbiBlc2NhcGVDaGFycykgcmV2ZXJzZWRFc2NhcGVDaGFyc1tlc2NhcGVDaGFyc1trZXldXSA9IGtleTsKICByZXZlcnNlZEVzY2FwZUNoYXJzWyInIl0gPSAnIzM5JzsKCiAgLy8gc3ByaW50ZigpIGZvciBKYXZhU2NyaXB0IDAuNy1iZXRhMQogIC8vIGh0dHA6Ly93d3cuZGl2ZWludG9qYXZhc2NyaXB0LmNvbS9wcm9qZWN0cy9qYXZhc2NyaXB0LXNwcmludGYKICAvLwogIC8vIENvcHlyaWdodCAoYykgQWxleGFuZHJ1IE1hcmFzdGVhbnUgPGFsZXhhaG9saWMgW2F0KSBnbWFpbCAoZG90XSBjb20+CiAgLy8gQWxsIHJpZ2h0cyByZXNlcnZlZC4KCiAgdmFyIHNwcmludGYgPSAoZnVuY3Rpb24oKSB7CiAgICBmdW5jdGlvbiBnZXRfdHlwZSh2YXJpYWJsZSkgewogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhcmlhYmxlKS5zbGljZSg4LCAtMSkudG9Mb3dlckNhc2UoKTsKICAgIH0KCiAgICB2YXIgc3RyX3JlcGVhdCA9IHN0clJlcGVhdDsKCiAgICB2YXIgc3RyX2Zvcm1hdCA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXN0cl9mb3JtYXQuY2FjaGUuaGFzT3duUHJvcGVydHkoYXJndW1lbnRzWzBdKSkgewogICAgICAgIHN0cl9mb3JtYXQuY2FjaGVbYXJndW1lbnRzWzBdXSA9IHN0cl9mb3JtYXQucGFyc2UoYXJndW1lbnRzWzBdKTsKICAgICAgfQogICAgICByZXR1cm4gc3RyX2Zvcm1hdC5mb3JtYXQuY2FsbChudWxsLCBzdHJfZm9ybWF0LmNhY2hlW2FyZ3VtZW50c1swXV0sIGFyZ3VtZW50cyk7CiAgICB9OwoKICAgIHN0cl9mb3JtYXQuZm9ybWF0ID0gZnVuY3Rpb24ocGFyc2VfdHJlZSwgYXJndikgewogICAgICB2YXIgY3Vyc29yID0gMSwgdHJlZV9sZW5ndGggPSBwYXJzZV90cmVlLmxlbmd0aCwgbm9kZV90eXBlID0gJycsIGFyZywgb3V0cHV0ID0gW10sIGksIGssIG1hdGNoLCBwYWQsIHBhZF9jaGFyYWN0ZXIsIHBhZF9sZW5ndGg7CiAgICAgIGZvciAoaSA9IDA7IGkgPCB0cmVlX2xlbmd0aDsgaSsrKSB7CiAgICAgICAgbm9kZV90eXBlID0gZ2V0X3R5cGUocGFyc2VfdHJlZVtpXSk7CiAgICAgICAgaWYgKG5vZGVfdHlwZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIG91dHB1dC5wdXNoKHBhcnNlX3RyZWVbaV0pOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChub2RlX3R5cGUgPT09ICdhcnJheScpIHsKICAgICAgICAgIG1hdGNoID0gcGFyc2VfdHJlZVtpXTsgLy8gY29udmVuaWVuY2UgcHVycG9zZXMgb25seQogICAgICAgICAgaWYgKG1hdGNoWzJdKSB7IC8vIGtleXdvcmQgYXJndW1lbnQKICAgICAgICAgICAgYXJnID0gYXJndltjdXJzb3JdOwogICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgbWF0Y2hbMl0ubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICBpZiAoIWFyZy5oYXNPd25Qcm9wZXJ0eShtYXRjaFsyXVtrXSkpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihzcHJpbnRmKCdbXy5zcHJpbnRmXSBwcm9wZXJ0eSAiJXMiIGRvZXMgbm90IGV4aXN0JywgbWF0Y2hbMl1ba10pKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXJnID0gYXJnW21hdGNoWzJdW2tdXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChtYXRjaFsxXSkgeyAvLyBwb3NpdGlvbmFsIGFyZ3VtZW50IChleHBsaWNpdCkKICAgICAgICAgICAgYXJnID0gYXJndlttYXRjaFsxXV07CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsgLy8gcG9zaXRpb25hbCBhcmd1bWVudCAoaW1wbGljaXQpCiAgICAgICAgICAgIGFyZyA9IGFyZ3ZbY3Vyc29yKytdOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICgvW15zXS8udGVzdChtYXRjaFs4XSkgJiYgKGdldF90eXBlKGFyZykgIT0gJ251bWJlcicpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihzcHJpbnRmKCdbXy5zcHJpbnRmXSBleHBlY3RpbmcgbnVtYmVyIGJ1dCBmb3VuZCAlcycsIGdldF90eXBlKGFyZykpKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAobWF0Y2hbOF0pIHsKICAgICAgICAgICAgY2FzZSAnYic6IGFyZyA9IGFyZy50b1N0cmluZygyKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2MnOiBhcmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGFyZyk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdkJzogYXJnID0gcGFyc2VJbnQoYXJnLCAxMCk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdlJzogYXJnID0gbWF0Y2hbN10gPyBhcmcudG9FeHBvbmVudGlhbChtYXRjaFs3XSkgOiBhcmcudG9FeHBvbmVudGlhbCgpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnZic6IGFyZyA9IG1hdGNoWzddID8gcGFyc2VGbG9hdChhcmcpLnRvRml4ZWQobWF0Y2hbN10pIDogcGFyc2VGbG9hdChhcmcpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnbyc6IGFyZyA9IGFyZy50b1N0cmluZyg4KTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3MnOiBhcmcgPSAoKGFyZyA9IFN0cmluZyhhcmcpKSAmJiBtYXRjaFs3XSA/IGFyZy5zdWJzdHJpbmcoMCwgbWF0Y2hbN10pIDogYXJnKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3UnOiBhcmcgPSBNYXRoLmFicyhhcmcpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAneCc6IGFyZyA9IGFyZy50b1N0cmluZygxNik7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdYJzogYXJnID0gYXJnLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpOyBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGFyZyA9ICgvW2RlZl0vLnRlc3QobWF0Y2hbOF0pICYmIG1hdGNoWzNdICYmIGFyZyA+PSAwID8gJysnKyBhcmcgOiBhcmcpOwogICAgICAgICAgcGFkX2NoYXJhY3RlciA9IG1hdGNoWzRdID8gbWF0Y2hbNF0gPT0gJzAnID8gJzAnIDogbWF0Y2hbNF0uY2hhckF0KDEpIDogJyAnOwogICAgICAgICAgcGFkX2xlbmd0aCA9IG1hdGNoWzZdIC0gU3RyaW5nKGFyZykubGVuZ3RoOwogICAgICAgICAgcGFkID0gbWF0Y2hbNl0gPyBzdHJfcmVwZWF0KHBhZF9jaGFyYWN0ZXIsIHBhZF9sZW5ndGgpIDogJyc7CiAgICAgICAgICBvdXRwdXQucHVzaChtYXRjaFs1XSA/IGFyZyArIHBhZCA6IHBhZCArIGFyZyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvdXRwdXQuam9pbignJyk7CiAgICB9OwoKICAgIHN0cl9mb3JtYXQuY2FjaGUgPSB7fTsKCiAgICBzdHJfZm9ybWF0LnBhcnNlID0gZnVuY3Rpb24oZm10KSB7CiAgICAgIHZhciBfZm10ID0gZm10LCBtYXRjaCA9IFtdLCBwYXJzZV90cmVlID0gW10sIGFyZ19uYW1lcyA9IDA7CiAgICAgIHdoaWxlIChfZm10KSB7CiAgICAgICAgaWYgKChtYXRjaCA9IC9eW15ceDI1XSsvLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CiAgICAgICAgICBwYXJzZV90cmVlLnB1c2gobWF0Y2hbMF0pOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgobWF0Y2ggPSAvXlx4MjV7Mn0vLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CiAgICAgICAgICBwYXJzZV90cmVlLnB1c2goJyUnKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoKG1hdGNoID0gL15ceDI1KD86KFsxLTldXGQqKVwkfFwoKFteXCldKylcKSk/KFwrKT8oMHwnW14kXSk/KC0pPyhcZCspPyg/OlwuKFxkKykpPyhbYi1mb3N1eFhdKS8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKICAgICAgICAgIGlmIChtYXRjaFsyXSkgewogICAgICAgICAgICBhcmdfbmFtZXMgfD0gMTsKICAgICAgICAgICAgdmFyIGZpZWxkX2xpc3QgPSBbXSwgcmVwbGFjZW1lbnRfZmllbGQgPSBtYXRjaFsyXSwgZmllbGRfbWF0Y2ggPSBbXTsKICAgICAgICAgICAgaWYgKChmaWVsZF9tYXRjaCA9IC9eKFthLXpfXVthLXpfXGRdKikvaS5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwogICAgICAgICAgICAgIHdoaWxlICgocmVwbGFjZW1lbnRfZmllbGQgPSByZXBsYWNlbWVudF9maWVsZC5zdWJzdHJpbmcoZmllbGRfbWF0Y2hbMF0ubGVuZ3RoKSkgIT09ICcnKSB7CiAgICAgICAgICAgICAgICBpZiAoKGZpZWxkX21hdGNoID0gL15cLihbYS16X11bYS16X1xkXSopL2kuZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICgoZmllbGRfbWF0Y2ggPSAvXlxbKFxkKylcXS8uZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdbXy5zcHJpbnRmXSBodWg/Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignW18uc3ByaW50Zl0gaHVoPycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hdGNoWzJdID0gZmllbGRfbGlzdDsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICBhcmdfbmFtZXMgfD0gMjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhcmdfbmFtZXMgPT09IDMpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdbXy5zcHJpbnRmXSBtaXhpbmcgcG9zaXRpb25hbCBhbmQgbmFtZWQgcGxhY2Vob2xkZXJzIGlzIG5vdCAoeWV0KSBzdXBwb3J0ZWQnKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhcnNlX3RyZWUucHVzaChtYXRjaCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdbXy5zcHJpbnRmXSBodWg/Jyk7CiAgICAgICAgfQogICAgICAgIF9mbXQgPSBfZm10LnN1YnN0cmluZyhtYXRjaFswXS5sZW5ndGgpOwogICAgICB9CiAgICAgIHJldHVybiBwYXJzZV90cmVlOwogICAgfTsKCiAgICByZXR1cm4gc3RyX2Zvcm1hdDsKICB9KSgpOwoKCgogIC8vIERlZmluaW5nIHVuZGVyc2NvcmUuc3RyaW5nCgogIHZhciBfcyA9IHsKCiAgICBWRVJTSU9OOiAnMi4zLjEnLAoKICAgIGlzQmxhbms6IGZ1bmN0aW9uKHN0cil7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgc3RyID0gJyc7CiAgICAgIHJldHVybiAoL15ccyokLykudGVzdChzdHIpOwogICAgfSwKCiAgICBzdHJpcFRhZ3M6IGZ1bmN0aW9uKHN0cil7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikucmVwbGFjZSgvPFwvP1tePl0rPi9nLCAnJyk7CiAgICB9LAoKICAgIGNhcGl0YWxpemUgOiBmdW5jdGlvbihzdHIpewogICAgICBzdHIgPSBzdHIgPT0gbnVsbCA/ICcnIDogU3RyaW5nKHN0cik7CiAgICAgIHJldHVybiBzdHIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc2xpY2UoMSk7CiAgICB9LAoKICAgIGNob3A6IGZ1bmN0aW9uKHN0ciwgc3RlcCl7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuIFtdOwogICAgICBzdHIgPSBTdHJpbmcoc3RyKTsKICAgICAgc3RlcCA9IH5+c3RlcDsKICAgICAgcmV0dXJuIHN0ZXAgPiAwID8gc3RyLm1hdGNoKG5ldyBSZWdFeHAoJy57MSwnICsgc3RlcCArICd9JywgJ2cnKSkgOiBbc3RyXTsKICAgIH0sCgogICAgY2xlYW46IGZ1bmN0aW9uKHN0cil7CiAgICAgIHJldHVybiBfcy5zdHJpcChzdHIpLnJlcGxhY2UoL1xzKy9nLCAnICcpOwogICAgfSwKCiAgICBjb3VudDogZnVuY3Rpb24oc3RyLCBzdWJzdHIpewogICAgICBpZiAoc3RyID09IG51bGwgfHwgc3Vic3RyID09IG51bGwpIHJldHVybiAwOwoKICAgICAgc3RyID0gU3RyaW5nKHN0cik7CiAgICAgIHN1YnN0ciA9IFN0cmluZyhzdWJzdHIpOwoKICAgICAgdmFyIGNvdW50ID0gMCwKICAgICAgICBwb3MgPSAwLAogICAgICAgIGxlbmd0aCA9IHN1YnN0ci5sZW5ndGg7CgogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIHBvcyA9IHN0ci5pbmRleE9mKHN1YnN0ciwgcG9zKTsKICAgICAgICBpZiAocG9zID09PSAtMSkgYnJlYWs7CiAgICAgICAgY291bnQrKzsKICAgICAgICBwb3MgKz0gbGVuZ3RoOwogICAgICB9CgogICAgICByZXR1cm4gY291bnQ7CiAgICB9LAoKICAgIGNoYXJzOiBmdW5jdGlvbihzdHIpIHsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gW107CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5zcGxpdCgnJyk7CiAgICB9LAoKICAgIHN3YXBDYXNlOiBmdW5jdGlvbihzdHIpIHsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKC9cUy9nLCBmdW5jdGlvbihjKXsKICAgICAgICByZXR1cm4gYyA9PT0gYy50b1VwcGVyQ2FzZSgpID8gYy50b0xvd2VyQ2FzZSgpIDogYy50b1VwcGVyQ2FzZSgpOwogICAgICB9KTsKICAgIH0sCgogICAgZXNjYXBlSFRNTDogZnVuY3Rpb24oc3RyKSB7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikucmVwbGFjZSgvWyY8PiInXS9nLCBmdW5jdGlvbihtKXsgcmV0dXJuICcmJyArIHJldmVyc2VkRXNjYXBlQ2hhcnNbbV0gKyAnOyc7IH0pOwogICAgfSwKCiAgICB1bmVzY2FwZUhUTUw6IGZ1bmN0aW9uKHN0cikgewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UoL1wmKFteO10rKTsvZywgZnVuY3Rpb24oZW50aXR5LCBlbnRpdHlDb2RlKXsKICAgICAgICB2YXIgbWF0Y2g7CgogICAgICAgIGlmIChlbnRpdHlDb2RlIGluIGVzY2FwZUNoYXJzKSB7CiAgICAgICAgICByZXR1cm4gZXNjYXBlQ2hhcnNbZW50aXR5Q29kZV07CiAgICAgICAgfSBlbHNlIGlmIChtYXRjaCA9IGVudGl0eUNvZGUubWF0Y2goL14jeChbXGRhLWZBLUZdKykkLykpIHsKICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KG1hdGNoWzFdLCAxNikpOwogICAgICAgIH0gZWxzZSBpZiAobWF0Y2ggPSBlbnRpdHlDb2RlLm1hdGNoKC9eIyhcZCspJC8pKSB7CiAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSh+fm1hdGNoWzFdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGVudGl0eTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICBlc2NhcGVSZWdFeHA6IGZ1bmN0aW9uKHN0cil7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikucmVwbGFjZSgvKFsuKis/Xj0hOiR7fSgpfFtcXVwvXFxdKS9nLCAnXFwkMScpOwogICAgfSwKCiAgICBzcGxpY2U6IGZ1bmN0aW9uKHN0ciwgaSwgaG93bWFueSwgc3Vic3RyKXsKICAgICAgdmFyIGFyciA9IF9zLmNoYXJzKHN0cik7CiAgICAgIGFyci5zcGxpY2Uofn5pLCB+fmhvd21hbnksIHN1YnN0cik7CiAgICAgIHJldHVybiBhcnIuam9pbignJyk7CiAgICB9LAoKICAgIGluc2VydDogZnVuY3Rpb24oc3RyLCBpLCBzdWJzdHIpewogICAgICByZXR1cm4gX3Muc3BsaWNlKHN0ciwgaSwgMCwgc3Vic3RyKTsKICAgIH0sCgogICAgaW5jbHVkZTogZnVuY3Rpb24oc3RyLCBuZWVkbGUpewogICAgICBpZiAobmVlZGxlID09PSAnJykgcmV0dXJuIHRydWU7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikuaW5kZXhPZihuZWVkbGUpICE9PSAtMTsKICAgIH0sCgogICAgam9pbjogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpLAogICAgICAgIHNlcGFyYXRvciA9IGFyZ3Muc2hpZnQoKTsKCiAgICAgIGlmIChzZXBhcmF0b3IgPT0gbnVsbCkgc2VwYXJhdG9yID0gJyc7CgogICAgICByZXR1cm4gYXJncy5qb2luKHNlcGFyYXRvcik7CiAgICB9LAoKICAgIGxpbmVzOiBmdW5jdGlvbihzdHIpIHsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gW107CiAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5zcGxpdCgiXG4iKTsKICAgIH0sCgogICAgcmV2ZXJzZTogZnVuY3Rpb24oc3RyKXsKICAgICAgcmV0dXJuIF9zLmNoYXJzKHN0cikucmV2ZXJzZSgpLmpvaW4oJycpOwogICAgfSwKCiAgICBzdGFydHNXaXRoOiBmdW5jdGlvbihzdHIsIHN0YXJ0cyl7CiAgICAgIGlmIChzdGFydHMgPT09ICcnKSByZXR1cm4gdHJ1ZTsKICAgICAgaWYgKHN0ciA9PSBudWxsIHx8IHN0YXJ0cyA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAgIHN0ciA9IFN0cmluZyhzdHIpOyBzdGFydHMgPSBTdHJpbmcoc3RhcnRzKTsKICAgICAgcmV0dXJuIHN0ci5sZW5ndGggPj0gc3RhcnRzLmxlbmd0aCAmJiBzdHIuc2xpY2UoMCwgc3RhcnRzLmxlbmd0aCkgPT09IHN0YXJ0czsKICAgIH0sCgogICAgZW5kc1dpdGg6IGZ1bmN0aW9uKHN0ciwgZW5kcyl7CiAgICAgIGlmIChlbmRzID09PSAnJykgcmV0dXJuIHRydWU7CiAgICAgIGlmIChzdHIgPT0gbnVsbCB8fCBlbmRzID09IG51bGwpIHJldHVybiBmYWxzZTsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7IGVuZHMgPSBTdHJpbmcoZW5kcyk7CiAgICAgIHJldHVybiBzdHIubGVuZ3RoID49IGVuZHMubGVuZ3RoICYmIHN0ci5zbGljZShzdHIubGVuZ3RoIC0gZW5kcy5sZW5ndGgpID09PSBlbmRzOwogICAgfSwKCiAgICBzdWNjOiBmdW5jdGlvbihzdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7CiAgICAgIHJldHVybiBzdHIuc2xpY2UoMCwgLTEpICsgU3RyaW5nLmZyb21DaGFyQ29kZShzdHIuY2hhckNvZGVBdChzdHIubGVuZ3RoLTEpICsgMSk7CiAgICB9LAoKICAgIHRpdGxlaXplOiBmdW5jdGlvbihzdHIpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UoLyg/Ol58XHMpXFMvZywgZnVuY3Rpb24oYyl7IHJldHVybiBjLnRvVXBwZXJDYXNlKCk7IH0pOwogICAgfSwKCiAgICBjYW1lbGl6ZTogZnVuY3Rpb24oc3RyKXsKICAgICAgcmV0dXJuIF9zLnRyaW0oc3RyKS5yZXBsYWNlKC9bLV9cc10rKC4pPy9nLCBmdW5jdGlvbihtYXRjaCwgYyl7IHJldHVybiBjLnRvVXBwZXJDYXNlKCk7IH0pOwogICAgfSwKCiAgICB1bmRlcnNjb3JlZDogZnVuY3Rpb24oc3RyKXsKICAgICAgcmV0dXJuIF9zLnRyaW0oc3RyKS5yZXBsYWNlKC8oW2EtelxkXSkoW0EtWl0rKS9nLCAnJDFfJDInKS5yZXBsYWNlKC9bLVxzXSsvZywgJ18nKS50b0xvd2VyQ2FzZSgpOwogICAgfSwKCiAgICBkYXNoZXJpemU6IGZ1bmN0aW9uKHN0cil7CiAgICAgIHJldHVybiBfcy50cmltKHN0cikucmVwbGFjZSgvKFtBLVpdKS9nLCAnLSQxJykucmVwbGFjZSgvWy1fXHNdKy9nLCAnLScpLnRvTG93ZXJDYXNlKCk7CiAgICB9LAoKICAgIGNsYXNzaWZ5OiBmdW5jdGlvbihzdHIpewogICAgICByZXR1cm4gX3MudGl0bGVpemUoU3RyaW5nKHN0cikucmVwbGFjZSgvW1xXX10vZywgJyAnKSkucmVwbGFjZSgvXHMvZywgJycpOwogICAgfSwKCiAgICBodW1hbml6ZTogZnVuY3Rpb24oc3RyKXsKICAgICAgcmV0dXJuIF9zLmNhcGl0YWxpemUoX3MudW5kZXJzY29yZWQoc3RyKS5yZXBsYWNlKC9faWQkLywnJykucmVwbGFjZSgvXy9nLCAnICcpKTsKICAgIH0sCgogICAgdHJpbTogZnVuY3Rpb24oc3RyLCBjaGFyYWN0ZXJzKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIGlmICghY2hhcmFjdGVycyAmJiBuYXRpdmVUcmltKSByZXR1cm4gbmF0aXZlVHJpbS5jYWxsKHN0cik7CiAgICAgIGNoYXJhY3RlcnMgPSBkZWZhdWx0VG9XaGl0ZVNwYWNlKGNoYXJhY3RlcnMpOwogICAgICByZXR1cm4gU3RyaW5nKHN0cikucmVwbGFjZShuZXcgUmVnRXhwKCdcXicgKyBjaGFyYWN0ZXJzICsgJyt8JyArIGNoYXJhY3RlcnMgKyAnKyQnLCAnZycpLCAnJyk7CiAgICB9LAoKICAgIGx0cmltOiBmdW5jdGlvbihzdHIsIGNoYXJhY3RlcnMpewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgaWYgKCFjaGFyYWN0ZXJzICYmIG5hdGl2ZVRyaW1MZWZ0KSByZXR1cm4gbmF0aXZlVHJpbUxlZnQuY2FsbChzdHIpOwogICAgICBjaGFyYWN0ZXJzID0gZGVmYXVsdFRvV2hpdGVTcGFjZShjaGFyYWN0ZXJzKTsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UobmV3IFJlZ0V4cCgnXicgKyBjaGFyYWN0ZXJzICsgJysnKSwgJycpOwogICAgfSwKCiAgICBydHJpbTogZnVuY3Rpb24oc3RyLCBjaGFyYWN0ZXJzKXsKICAgICAgaWYgKHN0ciA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIGlmICghY2hhcmFjdGVycyAmJiBuYXRpdmVUcmltUmlnaHQpIHJldHVybiBuYXRpdmVUcmltUmlnaHQuY2FsbChzdHIpOwogICAgICBjaGFyYWN0ZXJzID0gZGVmYXVsdFRvV2hpdGVTcGFjZShjaGFyYWN0ZXJzKTsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UobmV3IFJlZ0V4cChjaGFyYWN0ZXJzICsgJyskJyksICcnKTsKICAgIH0sCgogICAgdHJ1bmNhdGU6IGZ1bmN0aW9uKHN0ciwgbGVuZ3RoLCB0cnVuY2F0ZVN0cil7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICBzdHIgPSBTdHJpbmcoc3RyKTsgdHJ1bmNhdGVTdHIgPSB0cnVuY2F0ZVN0ciB8fCAnLi4uJzsKICAgICAgbGVuZ3RoID0gfn5sZW5ndGg7CiAgICAgIHJldHVybiBzdHIubGVuZ3RoID4gbGVuZ3RoID8gc3RyLnNsaWNlKDAsIGxlbmd0aCkgKyB0cnVuY2F0ZVN0ciA6IHN0cjsKICAgIH0sCgogICAgLyoqCiAgICAgKiBfcy5wcnVuZTogYSBtb3JlIGVsZWdhbnQgdmVyc2lvbiBvZiB0cnVuY2F0ZQogICAgICogcHJ1bmUgZXh0cmEgY2hhcnMsIG5ldmVyIGxlYXZpbmcgYSBoYWxmLWNob3BwZWQgd29yZC4KICAgICAqIEBhdXRob3IgZ2l0aHViLmNvbS9yd3oKICAgICAqLwogICAgcHJ1bmU6IGZ1bmN0aW9uKHN0ciwgbGVuZ3RoLCBwcnVuZVN0cil7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwoKICAgICAgc3RyID0gU3RyaW5nKHN0cik7IGxlbmd0aCA9IH5+bGVuZ3RoOwogICAgICBwcnVuZVN0ciA9IHBydW5lU3RyICE9IG51bGwgPyBTdHJpbmcocHJ1bmVTdHIpIDogJy4uLic7CgogICAgICBpZiAoc3RyLmxlbmd0aCA8PSBsZW5ndGgpIHJldHVybiBzdHI7CgogICAgICB2YXIgdG1wbCA9IGZ1bmN0aW9uKGMpeyByZXR1cm4gYy50b1VwcGVyQ2FzZSgpICE9PSBjLnRvTG93ZXJDYXNlKCkgPyAnQScgOiAnICc7IH0sCiAgICAgICAgdGVtcGxhdGUgPSBzdHIuc2xpY2UoMCwgbGVuZ3RoKzEpLnJlcGxhY2UoLy4oPz1cVypcdyokKS9nLCB0bXBsKTsgLy8gJ0hlbGxvLCB3b3JsZCcgLT4gJ0hlbGxBQSBBQUFBQScKCiAgICAgIGlmICh0ZW1wbGF0ZS5zbGljZSh0ZW1wbGF0ZS5sZW5ndGgtMikubWF0Y2goL1x3XHcvKSkKICAgICAgICB0ZW1wbGF0ZSA9IHRlbXBsYXRlLnJlcGxhY2UoL1xzKlxTKyQvLCAnJyk7CiAgICAgIGVsc2UKICAgICAgICB0ZW1wbGF0ZSA9IF9zLnJ0cmltKHRlbXBsYXRlLnNsaWNlKDAsIHRlbXBsYXRlLmxlbmd0aC0xKSk7CgogICAgICByZXR1cm4gKHRlbXBsYXRlK3BydW5lU3RyKS5sZW5ndGggPiBzdHIubGVuZ3RoID8gc3RyIDogc3RyLnNsaWNlKDAsIHRlbXBsYXRlLmxlbmd0aCkrcHJ1bmVTdHI7CiAgICB9LAoKICAgIHdvcmRzOiBmdW5jdGlvbihzdHIsIGRlbGltaXRlcikgewogICAgICBpZiAoX3MuaXNCbGFuayhzdHIpKSByZXR1cm4gW107CiAgICAgIHJldHVybiBfcy50cmltKHN0ciwgZGVsaW1pdGVyKS5zcGxpdChkZWxpbWl0ZXIgfHwgL1xzKy8pOwogICAgfSwKCiAgICBwYWQ6IGZ1bmN0aW9uKHN0ciwgbGVuZ3RoLCBwYWRTdHIsIHR5cGUpIHsKICAgICAgc3RyID0gc3RyID09IG51bGwgPyAnJyA6IFN0cmluZyhzdHIpOwogICAgICBsZW5ndGggPSB+fmxlbmd0aDsKCiAgICAgIHZhciBwYWRsZW4gID0gMDsKCiAgICAgIGlmICghcGFkU3RyKQogICAgICAgIHBhZFN0ciA9ICcgJzsKICAgICAgZWxzZSBpZiAocGFkU3RyLmxlbmd0aCA+IDEpCiAgICAgICAgcGFkU3RyID0gcGFkU3RyLmNoYXJBdCgwKTsKCiAgICAgIHN3aXRjaCh0eXBlKSB7CiAgICAgICAgY2FzZSAncmlnaHQnOgogICAgICAgICAgcGFkbGVuID0gbGVuZ3RoIC0gc3RyLmxlbmd0aDsKICAgICAgICAgIHJldHVybiBzdHIgKyBzdHJSZXBlYXQocGFkU3RyLCBwYWRsZW4pOwogICAgICAgIGNhc2UgJ2JvdGgnOgogICAgICAgICAgcGFkbGVuID0gbGVuZ3RoIC0gc3RyLmxlbmd0aDsKICAgICAgICAgIHJldHVybiBzdHJSZXBlYXQocGFkU3RyLCBNYXRoLmNlaWwocGFkbGVuLzIpKSArIHN0cgogICAgICAgICAgICAgICAgICArIHN0clJlcGVhdChwYWRTdHIsIE1hdGguZmxvb3IocGFkbGVuLzIpKTsKICAgICAgICBkZWZhdWx0OiAvLyAnbGVmdCcKICAgICAgICAgIHBhZGxlbiA9IGxlbmd0aCAtIHN0ci5sZW5ndGg7CiAgICAgICAgICByZXR1cm4gc3RyUmVwZWF0KHBhZFN0ciwgcGFkbGVuKSArIHN0cjsKICAgICAgICB9CiAgICB9LAoKICAgIGxwYWQ6IGZ1bmN0aW9uKHN0ciwgbGVuZ3RoLCBwYWRTdHIpIHsKICAgICAgcmV0dXJuIF9zLnBhZChzdHIsIGxlbmd0aCwgcGFkU3RyKTsKICAgIH0sCgogICAgcnBhZDogZnVuY3Rpb24oc3RyLCBsZW5ndGgsIHBhZFN0cikgewogICAgICByZXR1cm4gX3MucGFkKHN0ciwgbGVuZ3RoLCBwYWRTdHIsICdyaWdodCcpOwogICAgfSwKCiAgICBscnBhZDogZnVuY3Rpb24oc3RyLCBsZW5ndGgsIHBhZFN0cikgewogICAgICByZXR1cm4gX3MucGFkKHN0ciwgbGVuZ3RoLCBwYWRTdHIsICdib3RoJyk7CiAgICB9LAoKICAgIHNwcmludGY6IHNwcmludGYsCgogICAgdnNwcmludGY6IGZ1bmN0aW9uKGZtdCwgYXJndil7CiAgICAgIGFyZ3YudW5zaGlmdChmbXQpOwogICAgICByZXR1cm4gc3ByaW50Zi5hcHBseShudWxsLCBhcmd2KTsKICAgIH0sCgogICAgdG9OdW1iZXI6IGZ1bmN0aW9uKHN0ciwgZGVjaW1hbHMpIHsKICAgICAgaWYgKCFzdHIpIHJldHVybiAwOwogICAgICBzdHIgPSBfcy50cmltKHN0cik7CiAgICAgIGlmICghc3RyLm1hdGNoKC9eLT9cZCsoPzpcLlxkKyk/JC8pKSByZXR1cm4gTmFOOwogICAgICByZXR1cm4gcGFyc2VOdW1iZXIocGFyc2VOdW1iZXIoc3RyKS50b0ZpeGVkKH5+ZGVjaW1hbHMpKTsKICAgIH0sCgogICAgbnVtYmVyRm9ybWF0IDogZnVuY3Rpb24obnVtYmVyLCBkZWMsIGRzZXAsIHRzZXApIHsKICAgICAgaWYgKGlzTmFOKG51bWJlcikgfHwgbnVtYmVyID09IG51bGwpIHJldHVybiAnJzsKCiAgICAgIG51bWJlciA9IG51bWJlci50b0ZpeGVkKH5+ZGVjKTsKICAgICAgdHNlcCA9IHR5cGVvZiB0c2VwID09ICdzdHJpbmcnID8gdHNlcCA6ICcsJzsKCiAgICAgIHZhciBwYXJ0cyA9IG51bWJlci5zcGxpdCgnLicpLCBmbnVtcyA9IHBhcnRzWzBdLAogICAgICAgIGRlY2ltYWxzID0gcGFydHNbMV0gPyAoZHNlcCB8fCAnLicpICsgcGFydHNbMV0gOiAnJzsKCiAgICAgIHJldHVybiBmbnVtcy5yZXBsYWNlKC8oXGQpKD89KD86XGR7M30pKyQpL2csICckMScgKyB0c2VwKSArIGRlY2ltYWxzOwogICAgfSwKCiAgICBzdHJSaWdodDogZnVuY3Rpb24oc3RyLCBzZXApewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7IHNlcCA9IHNlcCAhPSBudWxsID8gU3RyaW5nKHNlcCkgOiBzZXA7CiAgICAgIHZhciBwb3MgPSAhc2VwID8gLTEgOiBzdHIuaW5kZXhPZihzZXApOwogICAgICByZXR1cm4gfnBvcyA/IHN0ci5zbGljZShwb3Mrc2VwLmxlbmd0aCwgc3RyLmxlbmd0aCkgOiBzdHI7CiAgICB9LAoKICAgIHN0clJpZ2h0QmFjazogZnVuY3Rpb24oc3RyLCBzZXApewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKICAgICAgc3RyID0gU3RyaW5nKHN0cik7IHNlcCA9IHNlcCAhPSBudWxsID8gU3RyaW5nKHNlcCkgOiBzZXA7CiAgICAgIHZhciBwb3MgPSAhc2VwID8gLTEgOiBzdHIubGFzdEluZGV4T2Yoc2VwKTsKICAgICAgcmV0dXJuIH5wb3MgPyBzdHIuc2xpY2UocG9zK3NlcC5sZW5ndGgsIHN0ci5sZW5ndGgpIDogc3RyOwogICAgfSwKCiAgICBzdHJMZWZ0OiBmdW5jdGlvbihzdHIsIHNlcCl7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICBzdHIgPSBTdHJpbmcoc3RyKTsgc2VwID0gc2VwICE9IG51bGwgPyBTdHJpbmcoc2VwKSA6IHNlcDsKICAgICAgdmFyIHBvcyA9ICFzZXAgPyAtMSA6IHN0ci5pbmRleE9mKHNlcCk7CiAgICAgIHJldHVybiB+cG9zID8gc3RyLnNsaWNlKDAsIHBvcykgOiBzdHI7CiAgICB9LAoKICAgIHN0ckxlZnRCYWNrOiBmdW5jdGlvbihzdHIsIHNlcCl7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICBzdHIgKz0gJyc7IHNlcCA9IHNlcCAhPSBudWxsID8gJycrc2VwIDogc2VwOwogICAgICB2YXIgcG9zID0gc3RyLmxhc3RJbmRleE9mKHNlcCk7CiAgICAgIHJldHVybiB+cG9zID8gc3RyLnNsaWNlKDAsIHBvcykgOiBzdHI7CiAgICB9LAoKICAgIHRvU2VudGVuY2U6IGZ1bmN0aW9uKGFycmF5LCBzZXBhcmF0b3IsIGxhc3RTZXBhcmF0b3IsIHNlcmlhbCkgewogICAgICBzZXBhcmF0b3IgPSBzZXBhcmF0b3IgfHwgJywgJwogICAgICBsYXN0U2VwYXJhdG9yID0gbGFzdFNlcGFyYXRvciB8fCAnIGFuZCAnCiAgICAgIHZhciBhID0gYXJyYXkuc2xpY2UoKSwgbGFzdE1lbWJlciA9IGEucG9wKCk7CgogICAgICBpZiAoYXJyYXkubGVuZ3RoID4gMiAmJiBzZXJpYWwpIGxhc3RTZXBhcmF0b3IgPSBfcy5ydHJpbShzZXBhcmF0b3IpICsgbGFzdFNlcGFyYXRvcjsKCiAgICAgIHJldHVybiBhLmxlbmd0aCA/IGEuam9pbihzZXBhcmF0b3IpICsgbGFzdFNlcGFyYXRvciArIGxhc3RNZW1iZXIgOiBsYXN0TWVtYmVyOwogICAgfSwKCiAgICB0b1NlbnRlbmNlU2VyaWFsOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3NbM10gPSB0cnVlOwogICAgICByZXR1cm4gX3MudG9TZW50ZW5jZS5hcHBseShfcywgYXJncyk7CiAgICB9LAoKICAgIHNsdWdpZnk6IGZ1bmN0aW9uKHN0cikgewogICAgICBpZiAoc3RyID09IG51bGwpIHJldHVybiAnJzsKCiAgICAgIHZhciBmcm9tICA9ICLEhcOgw6HDpMOiw6PDpcOmxIfEmcOow6nDq8Oqw6zDrcOvw67FgsWEw7LDs8O2w7TDtcO4w7nDusO8w7vDscOnxbzFuiIsCiAgICAgICAgICB0byAgICA9ICJhYWFhYWFhYWNlZWVlZWlpaWlsbm9vb29vb3V1dXVuY3p6IiwKICAgICAgICAgIHJlZ2V4ID0gbmV3IFJlZ0V4cChkZWZhdWx0VG9XaGl0ZVNwYWNlKGZyb20pLCAnZycpOwoKICAgICAgc3RyID0gU3RyaW5nKHN0cikudG9Mb3dlckNhc2UoKS5yZXBsYWNlKHJlZ2V4LCBmdW5jdGlvbihjKXsKICAgICAgICB2YXIgaW5kZXggPSBmcm9tLmluZGV4T2YoYyk7CiAgICAgICAgcmV0dXJuIHRvLmNoYXJBdChpbmRleCkgfHwgJy0nOwogICAgICB9KTsKCiAgICAgIHJldHVybiBfcy5kYXNoZXJpemUoc3RyLnJlcGxhY2UoL1teXHdccy1dL2csICcnKSk7CiAgICB9LAoKICAgIHN1cnJvdW5kOiBmdW5jdGlvbihzdHIsIHdyYXBwZXIpIHsKICAgICAgcmV0dXJuIFt3cmFwcGVyLCBzdHIsIHdyYXBwZXJdLmpvaW4oJycpOwogICAgfSwKCiAgICBxdW90ZTogZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiBfcy5zdXJyb3VuZChzdHIsICciJyk7CiAgICB9LAoKICAgIGV4cG9ydHM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgcmVzdWx0ID0ge307CgogICAgICBmb3IgKHZhciBwcm9wIGluIHRoaXMpIHsKICAgICAgICBpZiAoIXRoaXMuaGFzT3duUHJvcGVydHkocHJvcCkgfHwgcHJvcC5tYXRjaCgvXig/OmluY2x1ZGV8Y29udGFpbnN8cmV2ZXJzZSkkLykpIGNvbnRpbnVlOwogICAgICAgIHJlc3VsdFtwcm9wXSA9IHRoaXNbcHJvcF07CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAoKICAgIHJlcGVhdDogZnVuY3Rpb24oc3RyLCBxdHksIHNlcGFyYXRvcil7CiAgICAgIGlmIChzdHIgPT0gbnVsbCkgcmV0dXJuICcnOwoKICAgICAgcXR5ID0gfn5xdHk7CgogICAgICAvLyB1c2luZyBmYXN0ZXIgaW1wbGVtZW50YXRpb24gaWYgc2VwYXJhdG9yIGlzIG5vdCBuZWVkZWQ7CiAgICAgIGlmIChzZXBhcmF0b3IgPT0gbnVsbCkgcmV0dXJuIHN0clJlcGVhdChTdHJpbmcoc3RyKSwgcXR5KTsKCiAgICAgIC8vIHRoaXMgb25lIGlzIGFib3V0IDMwMHggc2xvd2VyIGluIEdvb2dsZSBDaHJvbWUKICAgICAgZm9yICh2YXIgcmVwZWF0ID0gW107IHF0eSA+IDA7IHJlcGVhdFstLXF0eV0gPSBzdHIpIHt9CiAgICAgIHJldHVybiByZXBlYXQuam9pbihzZXBhcmF0b3IpOwogICAgfSwKCiAgICBsZXZlbnNodGVpbjogZnVuY3Rpb24oc3RyMSwgc3RyMikgewogICAgICBpZiAoc3RyMSA9PSBudWxsICYmIHN0cjIgPT0gbnVsbCkgcmV0dXJuIDA7CiAgICAgIGlmIChzdHIxID09IG51bGwpIHJldHVybiBTdHJpbmcoc3RyMikubGVuZ3RoOwogICAgICBpZiAoc3RyMiA9PSBudWxsKSByZXR1cm4gU3RyaW5nKHN0cjEpLmxlbmd0aDsKCiAgICAgIHN0cjEgPSBTdHJpbmcoc3RyMSk7IHN0cjIgPSBTdHJpbmcoc3RyMik7CgogICAgICB2YXIgY3VycmVudCA9IFtdLCBwcmV2LCB2YWx1ZTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IHN0cjIubGVuZ3RoOyBpKyspCiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPD0gc3RyMS5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKGkgJiYgaikKICAgICAgICAgICAgaWYgKHN0cjEuY2hhckF0KGogLSAxKSA9PT0gc3RyMi5jaGFyQXQoaSAtIDEpKQogICAgICAgICAgICAgIHZhbHVlID0gcHJldjsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgIHZhbHVlID0gTWF0aC5taW4oY3VycmVudFtqXSwgY3VycmVudFtqIC0gMV0sIHByZXYpICsgMTsKICAgICAgICAgIGVsc2UKICAgICAgICAgICAgdmFsdWUgPSBpICsgajsKCiAgICAgICAgICBwcmV2ID0gY3VycmVudFtqXTsKICAgICAgICAgIGN1cnJlbnRbal0gPSB2YWx1ZTsKICAgICAgICB9CgogICAgICByZXR1cm4gY3VycmVudC5wb3AoKTsKICAgIH0KICB9OwoKICAvLyBBbGlhc2VzCgogIF9zLnN0cmlwICAgID0gX3MudHJpbTsKICBfcy5sc3RyaXAgICA9IF9zLmx0cmltOwogIF9zLnJzdHJpcCAgID0gX3MucnRyaW07CiAgX3MuY2VudGVyICAgPSBfcy5scnBhZDsKICBfcy5yanVzdCAgICA9IF9zLmxwYWQ7CiAgX3MubGp1c3QgICAgPSBfcy5ycGFkOwogIF9zLmNvbnRhaW5zID0gX3MuaW5jbHVkZTsKICBfcy5xICAgICAgICA9IF9zLnF1b3RlOwoKICAvLyBFeHBvcnRpbmcKCiAgLy8gQ29tbW9uSlMgbW9kdWxlIGlzIGRlZmluZWQKICBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpCiAgICAgIG1vZHVsZS5leHBvcnRzID0gX3M7CgogICAgZXhwb3J0cy5fcyA9IF9zOwogIH0KCiAgLy8gUmVnaXN0ZXIgYXMgYSBuYW1lZCBtb2R1bGUgd2l0aCBBTUQuCiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkKICAgIGRlZmluZSgndW5kZXJzY29yZS5zdHJpbmcnLCBbXSwgZnVuY3Rpb24oKXsgcmV0dXJuIF9zOyB9KTsKCgogIC8vIEludGVncmF0ZSB3aXRoIFVuZGVyc2NvcmUuanMgaWYgZGVmaW5lZAogIC8vIG9yIGNyZWF0ZSBvdXIgb3duIHVuZGVyc2NvcmUgb2JqZWN0LgogIHJvb3QuXyA9IHJvb3QuXyB8fCB7fTsKICByb290Ll8uc3RyaW5nID0gcm9vdC5fLnN0ciA9IF9zOwp9KHRoaXMsIFN0cmluZyk7CgovLyAgICAgbm9kZS11dWlkL3V1aWQuanMKLy8KLy8gICAgIENvcHlyaWdodCAoYykgMjAxMCBSb2JlcnQgS2llZmZlcgovLyAgICAgRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vICAgICBEb2N1bWVudGF0aW9uIGFuZCBkZXRhaWxzIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9icm9vZmEvbm9kZS11dWlkCihmdW5jdGlvbigpIHsKICB2YXIgX2dsb2JhbCA9IHRoaXM7CgogIC8vIFVuaXF1ZSBJRCBjcmVhdGlvbiByZXF1aXJlcyBhIGhpZ2ggcXVhbGl0eSByYW5kb20gIyBnZW5lcmF0b3IsIGJ1dAogIC8vIE1hdGgucmFuZG9tKCkgZG9lcyBub3QgZ3VhcmFudGVlICJjcnlwdG9ncmFwaGljIHF1YWxpdHkiLiAgU28gd2UgZmVhdHVyZQogIC8vIGRldGVjdCBmb3IgbW9yZSByb2J1c3QgQVBJcywgbm9ybWFsaXppbmcgZWFjaCBtZXRob2QgdG8gcmV0dXJuIDEyOC1iaXRzCiAgLy8gKDE2IGJ5dGVzKSBvZiByYW5kb20gZGF0YS4KICB2YXIgbWF0aFJORywgbm9kZVJORywgd2hhdHdnUk5HOwoKICAvLyBNYXRoLnJhbmRvbSgpLWJhc2VkIFJORy4gIEFsbCBwbGF0Zm9ybXMsIHZlcnkgZmFzdCwgdW5rbm93biBxdWFsaXR5CiAgdmFyIF9ybmRCeXRlcyA9IG5ldyBBcnJheSgxNik7CiAgbWF0aFJORyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHIsIGIgPSBfcm5kQnl0ZXMsIGkgPSAwOwoKICAgIGZvciAodmFyIGkgPSAwLCByOyBpIDwgMTY7IGkrKykgewogICAgICBpZiAoKGkgJiAweDAzKSA9PSAwKSByID0gTWF0aC5yYW5kb20oKSAqIDB4MTAwMDAwMDAwOwogICAgICBiW2ldID0gciA+Pj4gKChpICYgMHgwMykgPDwgMykgJiAweGZmOwogICAgfQoKICAgIHJldHVybiBiOwogIH0KCiAgLy8gV0hBVFdHIGNyeXB0by1iYXNlZCBSTkcgLSBodHRwOi8vd2lraS53aGF0d2cub3JnL3dpa2kvQ3J5cHRvCiAgLy8gV2ViS2l0IG9ubHkgKGN1cnJlbnRseSksIG1vZGVyYXRlbHkgZmFzdCwgaGlnaCBxdWFsaXR5CiAgaWYgKF9nbG9iYWwuY3J5cHRvICYmIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMpIHsKICAgIHZhciBfcm5kcyA9IG5ldyBVaW50MzJBcnJheSg0KTsKICAgIHdoYXR3Z1JORyA9IGZ1bmN0aW9uKCkgewogICAgICBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKF9ybmRzKTsKCiAgICAgIGZvciAodmFyIGMgPSAwIDsgYyA8IDE2OyBjKyspIHsKICAgICAgICBfcm5kQnl0ZXNbY10gPSBfcm5kc1tjID4+IDJdID4+PiAoKGMgJiAweDAzKSAqIDgpICYgMHhmZjsKICAgICAgfQogICAgICByZXR1cm4gX3JuZEJ5dGVzOwogICAgfQogIH0KCiAgLy8gTm9kZS5qcyBjcnlwdG8tYmFzZWQgUk5HIC0gaHR0cDovL25vZGVqcy5vcmcvZG9jcy92MC42LjIvYXBpL2NyeXB0by5odG1sCiAgLy8gTm9kZS5qcyBvbmx5LCBtb2RlcmF0ZWx5IGZhc3QsIGhpZ2ggcXVhbGl0eQogIHRyeSB7CiAgICB2YXIgX3JiID0gcmVxdWlyZSgnY3J5cHRvJykucmFuZG9tQnl0ZXM7CiAgICBub2RlUk5HID0gX3JiICYmIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gX3JiKDE2KTsKICAgIH07CiAgfSBjYXRjaCAoZSkge30KCiAgLy8gU2VsZWN0IFJORyB3aXRoIGJlc3QgcXVhbGl0eQogIHZhciBfcm5nID0gbm9kZVJORyB8fCB3aGF0d2dSTkcgfHwgbWF0aFJORzsKCiAgLy8gQnVmZmVyIGNsYXNzIHRvIHVzZQogIHZhciBCdWZmZXJDbGFzcyA9IHR5cGVvZihCdWZmZXIpID09ICdmdW5jdGlvbicgPyBCdWZmZXIgOiBBcnJheTsKCiAgLy8gTWFwcyBmb3IgbnVtYmVyIDwtPiBoZXggc3RyaW5nIGNvbnZlcnNpb24KICB2YXIgX2J5dGVUb0hleCA9IFtdOwogIHZhciBfaGV4VG9CeXRlID0ge307CiAgZm9yICh2YXIgaSA9IDA7IGkgPCAyNTY7IGkrKykgewogICAgX2J5dGVUb0hleFtpXSA9IChpICsgMHgxMDApLnRvU3RyaW5nKDE2KS5zdWJzdHIoMSk7CiAgICBfaGV4VG9CeXRlW19ieXRlVG9IZXhbaV1dID0gaTsKICB9CgogIC8vICoqYHBhcnNlKClgIC0gUGFyc2UgYSBVVUlEIGludG8gaXQncyBjb21wb25lbnQgYnl0ZXMqKgogIGZ1bmN0aW9uIHBhcnNlKHMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgaSA9IChidWYgJiYgb2Zmc2V0KSB8fCAwLCBpaSA9IDA7CgogICAgYnVmID0gYnVmIHx8IFtdOwogICAgcy50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1swLTlhLWZdezJ9L2csIGZ1bmN0aW9uKGJ5dGUpIHsKICAgICAgaWYgKGlpIDwgMTYpIHsgLy8gRG9uJ3Qgb3ZlcmZsb3chCiAgICAgICAgYnVmW2kgKyBpaSsrXSA9IF9oZXhUb0J5dGVbYnl0ZV07CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIFplcm8gb3V0IHJlbWFpbmluZyBieXRlcyBpZiBzdHJpbmcgd2FzIHNob3J0CiAgICB3aGlsZSAoaWkgPCAxNikgewogICAgICBidWZbaSArIGlpKytdID0gMDsKICAgIH0KCiAgICByZXR1cm4gYnVmOwogIH0KCiAgLy8gKipgdW5wYXJzZSgpYCAtIENvbnZlcnQgVVVJRCBieXRlIGFycmF5IChhbGEgcGFyc2UoKSkgaW50byBhIHN0cmluZyoqCiAgZnVuY3Rpb24gdW5wYXJzZShidWYsIG9mZnNldCkgewogICAgdmFyIGkgPSBvZmZzZXQgfHwgMCwgYnRoID0gX2J5dGVUb0hleDsKICAgIHJldHVybiAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArICctJyArCiAgICAgICAgICAgIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsgJy0nICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKyAnLScgKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArICctJyArCiAgICAgICAgICAgIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsKICAgICAgICAgICAgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKwogICAgICAgICAgICBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXTsKICB9CgogIC8vICoqYHYxKClgIC0gR2VuZXJhdGUgdGltZS1iYXNlZCBVVUlEKioKICAvLwogIC8vIEluc3BpcmVkIGJ5IGh0dHBzOi8vZ2l0aHViLmNvbS9MaW9zSy9VVUlELmpzCiAgLy8gYW5kIGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS91dWlkLmh0bWwKCiAgLy8gcmFuZG9tICMncyB3ZSBuZWVkIHRvIGluaXQgbm9kZSBhbmQgY2xvY2tzZXEKICB2YXIgX3NlZWRCeXRlcyA9IF9ybmcoKTsKCiAgLy8gUGVyIDQuNSwgY3JlYXRlIGFuZCA0OC1iaXQgbm9kZSBpZCwgKDQ3IHJhbmRvbSBiaXRzICsgbXVsdGljYXN0IGJpdCA9IDEpCiAgdmFyIF9ub2RlSWQgPSBbCiAgICBfc2VlZEJ5dGVzWzBdIHwgMHgwMSwKICAgIF9zZWVkQnl0ZXNbMV0sIF9zZWVkQnl0ZXNbMl0sIF9zZWVkQnl0ZXNbM10sIF9zZWVkQnl0ZXNbNF0sIF9zZWVkQnl0ZXNbNV0KICBdOwoKICAvLyBQZXIgNC4yLjIsIHJhbmRvbWl6ZSAoMTQgYml0KSBjbG9ja3NlcQogIHZhciBfY2xvY2tzZXEgPSAoX3NlZWRCeXRlc1s2XSA8PCA4IHwgX3NlZWRCeXRlc1s3XSkgJiAweDNmZmY7CgogIC8vIFByZXZpb3VzIHV1aWQgY3JlYXRpb24gdGltZQogIHZhciBfbGFzdE1TZWNzID0gMCwgX2xhc3ROU2VjcyA9IDA7CgogIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYnJvb2ZhL25vZGUtdXVpZCBmb3IgQVBJIGRldGFpbHMKICBmdW5jdGlvbiB2MShvcHRpb25zLCBidWYsIG9mZnNldCkgewogICAgdmFyIGkgPSBidWYgJiYgb2Zmc2V0IHx8IDA7CiAgICB2YXIgYiA9IGJ1ZiB8fCBbXTsKCiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICB2YXIgY2xvY2tzZXEgPSBvcHRpb25zLmNsb2Nrc2VxICE9IG51bGwgPyBvcHRpb25zLmNsb2Nrc2VxIDogX2Nsb2Nrc2VxOwoKICAgIC8vIFVVSUQgdGltZXN0YW1wcyBhcmUgMTAwIG5hbm8tc2Vjb25kIHVuaXRzIHNpbmNlIHRoZSBHcmVnb3JpYW4gZXBvY2gsCiAgICAvLyAoMTU4Mi0xMC0xNSAwMDowMCkuICBKU051bWJlcnMgYXJlbid0IHByZWNpc2UgZW5vdWdoIGZvciB0aGlzLCBzbwogICAgLy8gdGltZSBpcyBoYW5kbGVkIGludGVybmFsbHkgYXMgJ21zZWNzJyAoaW50ZWdlciBtaWxsaXNlY29uZHMpIGFuZCAnbnNlY3MnCiAgICAvLyAoMTAwLW5hbm9zZWNvbmRzIG9mZnNldCBmcm9tIG1zZWNzKSBzaW5jZSB1bml4IGVwb2NoLCAxOTcwLTAxLTAxIDAwOjAwLgogICAgdmFyIG1zZWNzID0gb3B0aW9ucy5tc2VjcyAhPSBudWxsID8gb3B0aW9ucy5tc2VjcyA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoKICAgIC8vIFBlciA0LjIuMS4yLCB1c2UgY291bnQgb2YgdXVpZCdzIGdlbmVyYXRlZCBkdXJpbmcgdGhlIGN1cnJlbnQgY2xvY2sKICAgIC8vIGN5Y2xlIHRvIHNpbXVsYXRlIGhpZ2hlciByZXNvbHV0aW9uIGNsb2NrCiAgICB2YXIgbnNlY3MgPSBvcHRpb25zLm5zZWNzICE9IG51bGwgPyBvcHRpb25zLm5zZWNzIDogX2xhc3ROU2VjcyArIDE7CgogICAgLy8gVGltZSBzaW5jZSBsYXN0IHV1aWQgY3JlYXRpb24gKGluIG1zZWNzKQogICAgdmFyIGR0ID0gKG1zZWNzIC0gX2xhc3RNU2VjcykgKyAobnNlY3MgLSBfbGFzdE5TZWNzKS8xMDAwMDsKCiAgICAvLyBQZXIgNC4yLjEuMiwgQnVtcCBjbG9ja3NlcSBvbiBjbG9jayByZWdyZXNzaW9uCiAgICBpZiAoZHQgPCAwICYmIG9wdGlvbnMuY2xvY2tzZXEgPT0gbnVsbCkgewogICAgICBjbG9ja3NlcSA9IGNsb2Nrc2VxICsgMSAmIDB4M2ZmZjsKICAgIH0KCiAgICAvLyBSZXNldCBuc2VjcyBpZiBjbG9jayByZWdyZXNzZXMgKG5ldyBjbG9ja3NlcSkgb3Igd2UndmUgbW92ZWQgb250byBhIG5ldwogICAgLy8gdGltZSBpbnRlcnZhbAogICAgaWYgKChkdCA8IDAgfHwgbXNlY3MgPiBfbGFzdE1TZWNzKSAmJiBvcHRpb25zLm5zZWNzID09IG51bGwpIHsKICAgICAgbnNlY3MgPSAwOwogICAgfQoKICAgIC8vIFBlciA0LjIuMS4yIFRocm93IGVycm9yIGlmIHRvbyBtYW55IHV1aWRzIGFyZSByZXF1ZXN0ZWQKICAgIGlmIChuc2VjcyA+PSAxMDAwMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3V1aWQudjEoKTogQ2FuXCd0IGNyZWF0ZSBtb3JlIHRoYW4gMTBNIHV1aWRzL3NlYycpOwogICAgfQoKICAgIF9sYXN0TVNlY3MgPSBtc2VjczsKICAgIF9sYXN0TlNlY3MgPSBuc2VjczsKICAgIF9jbG9ja3NlcSA9IGNsb2Nrc2VxOwoKICAgIC8vIFBlciA0LjEuNCAtIENvbnZlcnQgZnJvbSB1bml4IGVwb2NoIHRvIEdyZWdvcmlhbiBlcG9jaAogICAgbXNlY3MgKz0gMTIyMTkyOTI4MDAwMDA7CgogICAgLy8gYHRpbWVfbG93YAogICAgdmFyIHRsID0gKChtc2VjcyAmIDB4ZmZmZmZmZikgKiAxMDAwMCArIG5zZWNzKSAlIDB4MTAwMDAwMDAwOwogICAgYltpKytdID0gdGwgPj4+IDI0ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRsID4+PiAxNiAmIDB4ZmY7CiAgICBiW2krK10gPSB0bCA+Pj4gOCAmIDB4ZmY7CiAgICBiW2krK10gPSB0bCAmIDB4ZmY7CgogICAgLy8gYHRpbWVfbWlkYAogICAgdmFyIHRtaCA9IChtc2VjcyAvIDB4MTAwMDAwMDAwICogMTAwMDApICYgMHhmZmZmZmZmOwogICAgYltpKytdID0gdG1oID4+PiA4ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRtaCAmIDB4ZmY7CgogICAgLy8gYHRpbWVfaGlnaF9hbmRfdmVyc2lvbmAKICAgIGJbaSsrXSA9IHRtaCA+Pj4gMjQgJiAweGYgfCAweDEwOyAvLyBpbmNsdWRlIHZlcnNpb24KICAgIGJbaSsrXSA9IHRtaCA+Pj4gMTYgJiAweGZmOwoKICAgIC8vIGBjbG9ja19zZXFfaGlfYW5kX3Jlc2VydmVkYCAoUGVyIDQuMi4yIC0gaW5jbHVkZSB2YXJpYW50KQogICAgYltpKytdID0gY2xvY2tzZXEgPj4+IDggfCAweDgwOwoKICAgIC8vIGBjbG9ja19zZXFfbG93YAogICAgYltpKytdID0gY2xvY2tzZXEgJiAweGZmOwoKICAgIC8vIGBub2RlYAogICAgdmFyIG5vZGUgPSBvcHRpb25zLm5vZGUgfHwgX25vZGVJZDsKICAgIGZvciAodmFyIG4gPSAwOyBuIDwgNjsgbisrKSB7CiAgICAgIGJbaSArIG5dID0gbm9kZVtuXTsKICAgIH0KCiAgICByZXR1cm4gYnVmID8gYnVmIDogdW5wYXJzZShiKTsKICB9CgogIC8vICoqYHY0KClgIC0gR2VuZXJhdGUgcmFuZG9tIFVVSUQqKgoKICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2Jyb29mYS9ub2RlLXV1aWQgZm9yIEFQSSBkZXRhaWxzCiAgZnVuY3Rpb24gdjQob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICAgIC8vIERlcHJlY2F0ZWQgLSAnZm9ybWF0JyBhcmd1bWVudCwgYXMgc3VwcG9ydGVkIGluIHYxLjIKICAgIHZhciBpID0gYnVmICYmIG9mZnNldCB8fCAwOwoKICAgIGlmICh0eXBlb2Yob3B0aW9ucykgPT0gJ3N0cmluZycpIHsKICAgICAgYnVmID0gb3B0aW9ucyA9PSAnYmluYXJ5JyA/IG5ldyBCdWZmZXJDbGFzcygxNikgOiBudWxsOwogICAgICBvcHRpb25zID0gbnVsbDsKICAgIH0KICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgIHZhciBybmRzID0gb3B0aW9ucy5yYW5kb20gfHwgKG9wdGlvbnMucm5nIHx8IF9ybmcpKCk7CgogICAgLy8gUGVyIDQuNCwgc2V0IGJpdHMgZm9yIHZlcnNpb24gYW5kIGBjbG9ja19zZXFfaGlfYW5kX3Jlc2VydmVkYAogICAgcm5kc1s2XSA9IChybmRzWzZdICYgMHgwZikgfCAweDQwOwogICAgcm5kc1s4XSA9IChybmRzWzhdICYgMHgzZikgfCAweDgwOwoKICAgIC8vIENvcHkgYnl0ZXMgdG8gYnVmZmVyLCBpZiBwcm92aWRlZAogICAgaWYgKGJ1ZikgewogICAgICBmb3IgKHZhciBpaSA9IDA7IGlpIDwgMTY7IGlpKyspIHsKICAgICAgICBidWZbaSArIGlpXSA9IHJuZHNbaWldOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGJ1ZiB8fCB1bnBhcnNlKHJuZHMpOwogIH0KCiAgLy8gRXhwb3J0IHB1YmxpYyBBUEkKICB2YXIgdXVpZCA9IHY0OwogIHV1aWQudjEgPSB2MTsKICB1dWlkLnY0ID0gdjQ7CiAgdXVpZC5wYXJzZSA9IHBhcnNlOwogIHV1aWQudW5wYXJzZSA9IHVucGFyc2U7CiAgdXVpZC5CdWZmZXJDbGFzcyA9IEJ1ZmZlckNsYXNzOwoKICAvLyBFeHBvcnQgUk5HIG9wdGlvbnMKICB1dWlkLm1hdGhSTkcgPSBtYXRoUk5HOwogIHV1aWQubm9kZVJORyA9IG5vZGVSTkc7CiAgdXVpZC53aGF0d2dSTkcgPSB3aGF0d2dSTkc7CgogIGlmICh0eXBlb2YobW9kdWxlKSAhPSAndW5kZWZpbmVkJykgewogICAgLy8gUGxheSBuaWNlIHdpdGggbm9kZS5qcwogICAgbW9kdWxlLmV4cG9ydHMgPSB1dWlkOwogIH0gZWxzZSB7CiAgICAvLyBQbGF5IG5pY2Ugd2l0aCBicm93c2VycwogICAgdmFyIF9wcmV2aW91c1Jvb3QgPSBfZ2xvYmFsLnV1aWQ7CgogICAgLy8gKipgbm9Db25mbGljdCgpYCAtIChicm93c2VyIG9ubHkpIHRvIHJlc2V0IGdsb2JhbCAndXVpZCcgdmFyKioKICAgIHV1aWQubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgICBfZ2xvYmFsLnV1aWQgPSBfcHJldmlvdXNSb290OwogICAgICByZXR1cm4gdXVpZDsKICAgIH0KICAgIF9nbG9iYWwudXVpZCA9IHV1aWQ7CiAgfQp9KCkpOwoKZGVmaW5lKCJ1dWlkIiwgZnVuY3Rpb24oKXt9KTsKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qKgogKiBBIGxpZ2h0d2VpZ2h0IENvbW1vbkpTIFByb21pc2VzL0EgYW5kIHdoZW4oKSBpbXBsZW1lbnRhdGlvbgogKiB3aGVuIGlzIHBhcnQgb2YgdGhlIGN1am8uanMgZmFtaWx5IG9mIGxpYnJhcmllcyAoaHR0cDovL2N1am9qcy5jb20vKQogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UgYXQ6CiAqIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwCiAqCiAqIEB2ZXJzaW9uIDEuNy4xCiAqLwoKKGZ1bmN0aW9uKGRlZmluZSkgeyAKZGVmaW5lKCd3aGVuL3doZW4nLFtdLGZ1bmN0aW9uICgpIHsKCXZhciByZWR1Y2VBcnJheSwgc2xpY2UsIHVuZGVmOwoKCS8vCgkvLyBQdWJsaWMgQVBJCgkvLwoKCXdoZW4uZGVmZXIgICAgID0gZGVmZXI7ICAgICAvLyBDcmVhdGUgYSBkZWZlcnJlZAoJd2hlbi5yZXNvbHZlICAgPSByZXNvbHZlOyAgIC8vIENyZWF0ZSBhIHJlc29sdmVkIHByb21pc2UKCXdoZW4ucmVqZWN0ICAgID0gcmVqZWN0OyAgICAvLyBDcmVhdGUgYSByZWplY3RlZCBwcm9taXNlCgoJd2hlbi5qb2luICAgICAgPSBqb2luOyAgICAgIC8vIEpvaW4gMiBvciBtb3JlIHByb21pc2VzCgoJd2hlbi5hbGwgICAgICAgPSBhbGw7ICAgICAgIC8vIFJlc29sdmUgYSBsaXN0IG9mIHByb21pc2VzCgl3aGVuLm1hcCAgICAgICA9IG1hcDsgICAgICAgLy8gQXJyYXkubWFwKCkgZm9yIHByb21pc2VzCgl3aGVuLnJlZHVjZSAgICA9IHJlZHVjZTsgICAgLy8gQXJyYXkucmVkdWNlKCkgZm9yIHByb21pc2VzCgoJd2hlbi5hbnkgICAgICAgPSBhbnk7ICAgICAgIC8vIE9uZS13aW5uZXIgcmFjZQoJd2hlbi5zb21lICAgICAgPSBzb21lOyAgICAgIC8vIE11bHRpLXdpbm5lciByYWNlCgoJd2hlbi5jaGFpbiAgICAgPSBjaGFpbjsgICAgIC8vIE1ha2UgYSBwcm9taXNlIHRyaWdnZXIgYW5vdGhlciByZXNvbHZlcgoKCXdoZW4uaXNQcm9taXNlID0gaXNQcm9taXNlOyAvLyBEZXRlcm1pbmUgaWYgYSB0aGluZyBpcyBhIHByb21pc2UKCgkvKioKCSAqIFJlZ2lzdGVyIGFuIG9ic2VydmVyIGZvciBhIHByb21pc2Ugb3IgaW1tZWRpYXRlIHZhbHVlLgoJICoKCSAqIEBwYXJhbSB7Kn0gcHJvbWlzZU9yVmFsdWUKCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRdIGNhbGxiYWNrIHRvIGJlIGNhbGxlZCB3aGVuIHByb21pc2VPclZhbHVlIGlzCgkgKiAgIHN1Y2Nlc3NmdWxseSBmdWxmaWxsZWQuICBJZiBwcm9taXNlT3JWYWx1ZSBpcyBhbiBpbW1lZGlhdGUgdmFsdWUsIGNhbGxiYWNrCgkgKiAgIHdpbGwgYmUgaW52b2tlZCBpbW1lZGlhdGVseS4KCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25SZWplY3RlZF0gY2FsbGJhY2sgdG8gYmUgY2FsbGVkIHdoZW4gcHJvbWlzZU9yVmFsdWUgaXMKCSAqICAgcmVqZWN0ZWQuCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUHJvZ3Jlc3NdIGNhbGxiYWNrIHRvIGJlIGNhbGxlZCB3aGVuIHByb2dyZXNzIHVwZGF0ZXMKCSAqICAgYXJlIGlzc3VlZCBmb3IgcHJvbWlzZU9yVmFsdWUuCgkgKiBAcmV0dXJucyB7UHJvbWlzZX0gYSBuZXcge0BsaW5rIFByb21pc2V9IHRoYXQgd2lsbCBjb21wbGV0ZSB3aXRoIHRoZSByZXR1cm4KCSAqICAgdmFsdWUgb2YgY2FsbGJhY2sgb3IgZXJyYmFjayBvciB0aGUgY29tcGxldGlvbiB2YWx1ZSBvZiBwcm9taXNlT3JWYWx1ZSBpZgoJICogICBjYWxsYmFjayBhbmQvb3IgZXJyYmFjayBpcyBub3Qgc3VwcGxpZWQuCgkgKi8KCWZ1bmN0aW9uIHdoZW4ocHJvbWlzZU9yVmFsdWUsIG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKSB7CgkJLy8gR2V0IGEgdHJ1c3RlZCBwcm9taXNlIGZvciB0aGUgaW5wdXQgcHJvbWlzZU9yVmFsdWUsIGFuZCB0aGVuCgkJLy8gcmVnaXN0ZXIgcHJvbWlzZSBoYW5kbGVycwoJCXJldHVybiByZXNvbHZlKHByb21pc2VPclZhbHVlKS50aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKTsKCX0KCgkvKioKCSAqIFJldHVybnMgcHJvbWlzZU9yVmFsdWUgaWYgcHJvbWlzZU9yVmFsdWUgaXMgYSB7QGxpbmsgUHJvbWlzZX0sIGEgbmV3IFByb21pc2UgaWYKCSAqIHByb21pc2VPclZhbHVlIGlzIGEgZm9yZWlnbiBwcm9taXNlLCBvciBhIG5ldywgYWxyZWFkeS1mdWxmaWxsZWQge0BsaW5rIFByb21pc2V9CgkgKiB3aG9zZSB2YWx1ZSBpcyBwcm9taXNlT3JWYWx1ZSBpZiBwcm9taXNlT3JWYWx1ZSBpcyBhbiBpbW1lZGlhdGUgdmFsdWUuCgkgKgoJICogQHBhcmFtIHsqfSBwcm9taXNlT3JWYWx1ZQoJICogQHJldHVybnMgR3VhcmFudGVlZCB0byByZXR1cm4gYSB0cnVzdGVkIFByb21pc2UuICBJZiBwcm9taXNlT3JWYWx1ZSBpcyBhIHdoZW4uanMge0BsaW5rIFByb21pc2V9CgkgKiAgIHJldHVybnMgcHJvbWlzZU9yVmFsdWUsIG90aGVyd2lzZSwgcmV0dXJucyBhIG5ldywgYWxyZWFkeS1yZXNvbHZlZCwgd2hlbi5qcyB7QGxpbmsgUHJvbWlzZX0KCSAqICAgd2hvc2UgcmVzb2x1dGlvbiB2YWx1ZSBpczoKCSAqICAgKiB0aGUgcmVzb2x1dGlvbiB2YWx1ZSBvZiBwcm9taXNlT3JWYWx1ZSBpZiBpdCdzIGEgZm9yZWlnbiBwcm9taXNlLCBvcgoJICogICAqIHByb21pc2VPclZhbHVlIGlmIGl0J3MgYSB2YWx1ZQoJICovCglmdW5jdGlvbiByZXNvbHZlKHByb21pc2VPclZhbHVlKSB7CgkJdmFyIHByb21pc2UsIGRlZmVycmVkOwoKCQlpZihwcm9taXNlT3JWYWx1ZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKCQkJLy8gSXQncyBhIHdoZW4uanMgcHJvbWlzZSwgc28gd2UgdHJ1c3QgaXQKCQkJcHJvbWlzZSA9IHByb21pc2VPclZhbHVlOwoKCQl9IGVsc2UgewoJCQkvLyBJdCdzIG5vdCBhIHdoZW4uanMgcHJvbWlzZS4gU2VlIGlmIGl0J3MgYSBmb3JlaWduIHByb21pc2Ugb3IgYSB2YWx1ZS4KCQkJaWYoaXNQcm9taXNlKHByb21pc2VPclZhbHVlKSkgewoJCQkJLy8gSXQncyBhIHRoZW5hYmxlLCBidXQgd2UgZG9uJ3Qga25vdyB3aGVyZSBpdCBjYW1lIGZyb20sIHNvIGRvbid0IHRydXN0CgkJCQkvLyBpdHMgaW1wbGVtZW50YXRpb24gZW50aXJlbHkuICBJbnRyb2R1Y2UgYSB0cnVzdGVkIG1pZGRsZW1hbiB3aGVuLmpzIHByb21pc2UKCQkJCWRlZmVycmVkID0gZGVmZXIoKTsKCgkJCQkvLyBJTVBPUlRBTlQ6IFRoaXMgaXMgdGhlIG9ubHkgcGxhY2Ugd2hlbi5qcyBzaG91bGQgZXZlciBjYWxsIC50aGVuKCkgb24gYW4KCQkJCS8vIHVudHJ1c3RlZCBwcm9taXNlLiBEb24ndCBleHBvc2UgdGhlIHJldHVybiB2YWx1ZSB0byB0aGUgdW50cnVzdGVkIHByb21pc2UKCQkJCXByb21pc2VPclZhbHVlLnRoZW4oCgkJCQkJZnVuY3Rpb24odmFsdWUpICB7IGRlZmVycmVkLnJlc29sdmUodmFsdWUpOyB9LAoJCQkJCWZ1bmN0aW9uKHJlYXNvbikgeyBkZWZlcnJlZC5yZWplY3QocmVhc29uKTsgfSwKCQkJCQlmdW5jdGlvbih1cGRhdGUpIHsgZGVmZXJyZWQucHJvZ3Jlc3ModXBkYXRlKTsgfQoJCQkJKTsKCgkJCQlwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZTsKCgkJCX0gZWxzZSB7CgkJCQkvLyBJdCdzIGEgdmFsdWUsIG5vdCBhIHByb21pc2UuICBDcmVhdGUgYSByZXNvbHZlZCBwcm9taXNlIGZvciBpdC4KCQkJCXByb21pc2UgPSBmdWxmaWxsZWQocHJvbWlzZU9yVmFsdWUpOwoJCQl9CgkJfQoKCQlyZXR1cm4gcHJvbWlzZTsKCX0KCgkvKioKCSAqIFJldHVybnMgYSByZWplY3RlZCBwcm9taXNlIGZvciB0aGUgc3VwcGxpZWQgcHJvbWlzZU9yVmFsdWUuICBUaGUgcmV0dXJuZWQKCSAqIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCB3aXRoOgoJICogLSBwcm9taXNlT3JWYWx1ZSwgaWYgaXQgaXMgYSB2YWx1ZSwgb3IKCSAqIC0gaWYgcHJvbWlzZU9yVmFsdWUgaXMgYSBwcm9taXNlCgkgKiAgIC0gcHJvbWlzZU9yVmFsdWUncyB2YWx1ZSBhZnRlciBpdCBpcyBmdWxmaWxsZWQKCSAqICAgLSBwcm9taXNlT3JWYWx1ZSdzIHJlYXNvbiBhZnRlciBpdCBpcyByZWplY3RlZAoJICogQHBhcmFtIHsqfSBwcm9taXNlT3JWYWx1ZSB0aGUgcmVqZWN0ZWQgdmFsdWUgb2YgdGhlIHJldHVybmVkIHtAbGluayBQcm9taXNlfQoJICogQHJldHVybiB7UHJvbWlzZX0gcmVqZWN0ZWQge0BsaW5rIFByb21pc2V9CgkgKi8KCWZ1bmN0aW9uIHJlamVjdChwcm9taXNlT3JWYWx1ZSkgewoJCXJldHVybiB3aGVuKHByb21pc2VPclZhbHVlLCByZWplY3RlZCk7Cgl9CgoJLyoqCgkgKiBUcnVzdGVkIFByb21pc2UgY29uc3RydWN0b3IuICBBIFByb21pc2UgY3JlYXRlZCBmcm9tIHRoaXMgY29uc3RydWN0b3IgaXMKCSAqIGEgdHJ1c3RlZCB3aGVuLmpzIHByb21pc2UuICBBbnkgb3RoZXIgZHVjay10eXBlZCBwcm9taXNlIGlzIGNvbnNpZGVyZWQKCSAqIHVudHJ1c3RlZC4KCSAqIEBjb25zdHJ1Y3RvcgoJICogQG5hbWUgUHJvbWlzZQoJICovCglmdW5jdGlvbiBQcm9taXNlKHRoZW4pIHsKCQl0aGlzLnRoZW4gPSB0aGVuOwoJfQoKCVByb21pc2UucHJvdG90eXBlID0gewoJCS8qKgoJCSAqIFJlZ2lzdGVyIGEgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIGEgcHJvbWlzZSBpcwoJCSAqIGZ1bGZpbGxlZCBvciByZWplY3RlZC4gIE9wdGlvbmFsbHkgYWxzbyByZWdpc3RlciBhIHByb2dyZXNzIGhhbmRsZXIuCgkJICogU2hvcnRjdXQgZm9yIC50aGVuKG9uRnVsZmlsbGVkT3JSZWplY3RlZCwgb25GdWxmaWxsZWRPclJlamVjdGVkLCBvblByb2dyZXNzKQoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRPclJlamVjdGVkXQoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25Qcm9ncmVzc10KCQkgKiBAcmV0dXJuIHtQcm9taXNlfQoJCSAqLwoJCWFsd2F5czogZnVuY3Rpb24ob25GdWxmaWxsZWRPclJlamVjdGVkLCBvblByb2dyZXNzKSB7CgkJCXJldHVybiB0aGlzLnRoZW4ob25GdWxmaWxsZWRPclJlamVjdGVkLCBvbkZ1bGZpbGxlZE9yUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MpOwoJCX0sCgoJCS8qKgoJCSAqIFJlZ2lzdGVyIGEgcmVqZWN0aW9uIGhhbmRsZXIuICBTaG9ydGN1dCBmb3IgLnRoZW4odW5kZWZpbmVkLCBvblJlamVjdGVkKQoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBvblJlamVjdGVkCgkJICogQHJldHVybiB7UHJvbWlzZX0KCQkgKi8KCQlvdGhlcndpc2U6IGZ1bmN0aW9uKG9uUmVqZWN0ZWQpIHsKCQkJcmV0dXJuIHRoaXMudGhlbih1bmRlZiwgb25SZWplY3RlZCk7CgkJfSwKCgkJLyoqCgkJICogU2hvcnRjdXQgZm9yIC50aGVuKGZ1bmN0aW9uKCkgeyByZXR1cm4gdmFsdWU7IH0pCgkJICogQHBhcmFtICB7Kn0gdmFsdWUKCQkgKiBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgdGhhdDoKCQkgKiAgLSBpcyBmdWxmaWxsZWQgaWYgdmFsdWUgaXMgbm90IGEgcHJvbWlzZSwgb3IKCQkgKiAgLSBpZiB2YWx1ZSBpcyBhIHByb21pc2UsIHdpbGwgZnVsZmlsbCB3aXRoIGl0cyB2YWx1ZSwgb3IgcmVqZWN0CgkJICogICAgd2l0aCBpdHMgcmVhc29uLgoJCSAqLwoJCXlpZWxkOiBmdW5jdGlvbih2YWx1ZSkgewoJCQlyZXR1cm4gdGhpcy50aGVuKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHZhbHVlOwoJCQl9KTsKCQl9LAoKCQkvKioKCQkgKiBBc3N1bWVzIHRoYXQgdGhpcyBwcm9taXNlIHdpbGwgZnVsZmlsbCB3aXRoIGFuIGFycmF5LCBhbmQgYXJyYW5nZXMKCQkgKiBmb3IgdGhlIG9uRnVsZmlsbGVkIHRvIGJlIGNhbGxlZCB3aXRoIHRoZSBhcnJheSBhcyBpdHMgYXJndW1lbnQgbGlzdAoJCSAqIGkuZS4gb25GdWxmaWxsZWQuc3ByZWFkKHVuZGVmaW5lZCwgYXJyYXkpLgoJCSAqIEBwYXJhbSB7ZnVuY3Rpb259IG9uRnVsZmlsbGVkIGZ1bmN0aW9uIHRvIHJlY2VpdmUgc3ByZWFkIGFyZ3VtZW50cwoJCSAqIEByZXR1cm4ge1Byb21pc2V9CgkJICovCgkJc3ByZWFkOiBmdW5jdGlvbihvbkZ1bGZpbGxlZCkgewoJCQlyZXR1cm4gdGhpcy50aGVuKGZ1bmN0aW9uKGFycmF5KSB7CgkJCQkvLyBhcnJheSBtYXkgY29udGFpbiBwcm9taXNlcywgc28gcmVzb2x2ZSBpdHMgY29udGVudHMuCgkJCQlyZXR1cm4gYWxsKGFycmF5LCBmdW5jdGlvbihhcnJheSkgewoJCQkJCXJldHVybiBvbkZ1bGZpbGxlZC5hcHBseSh1bmRlZiwgYXJyYXkpOwoJCQkJfSk7CgkJCX0pOwoJCX0KCX07CgoJLyoqCgkgKiBDcmVhdGUgYW4gYWxyZWFkeS1yZXNvbHZlZCBwcm9taXNlIGZvciB0aGUgc3VwcGxpZWQgdmFsdWUKCSAqIEBwcml2YXRlCgkgKgoJICogQHBhcmFtIHsqfSB2YWx1ZQoJICogQHJldHVybiB7UHJvbWlzZX0gZnVsZmlsbGVkIHByb21pc2UKCSAqLwoJZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7CgkJdmFyIHAgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihvbkZ1bGZpbGxlZCkgewoJCQkvLyBUT0RPOiBQcm9taXNlcy9BKyBjaGVjayB0eXBlb2Ygb25GdWxmaWxsZWQKCQkJdHJ5IHsKCQkJCXJldHVybiByZXNvbHZlKG9uRnVsZmlsbGVkID8gb25GdWxmaWxsZWQodmFsdWUpIDogdmFsdWUpOwoJCQl9IGNhdGNoKGUpIHsKCQkJCXJldHVybiByZWplY3RlZChlKTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gcDsKCX0KCgkvKioKCSAqIENyZWF0ZSBhbiBhbHJlYWR5LXJlamVjdGVkIHtAbGluayBQcm9taXNlfSB3aXRoIHRoZSBzdXBwbGllZAoJICogcmVqZWN0aW9uIHJlYXNvbi4KCSAqIEBwcml2YXRlCgkgKgoJICogQHBhcmFtIHsqfSByZWFzb24KCSAqIEByZXR1cm4ge1Byb21pc2V9IHJlamVjdGVkIHByb21pc2UKCSAqLwoJZnVuY3Rpb24gcmVqZWN0ZWQocmVhc29uKSB7CgkJdmFyIHAgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihfLCBvblJlamVjdGVkKSB7CgkJCS8vIFRPRE86IFByb21pc2VzL0ErIGNoZWNrIHR5cGVvZiBvblJlamVjdGVkCgkJCXRyeSB7CgkJCQlyZXR1cm4gb25SZWplY3RlZCA/IHJlc29sdmUob25SZWplY3RlZChyZWFzb24pKSA6IHJlamVjdGVkKHJlYXNvbik7CgkJCX0gY2F0Y2goZSkgewoJCQkJcmV0dXJuIHJlamVjdGVkKGUpOwoJCQl9CgkJfSk7CgoJCXJldHVybiBwOwoJfQoKCS8qKgoJICogQ3JlYXRlcyBhIG5ldywgRGVmZXJyZWQgd2l0aCBmdWxseSBpc29sYXRlZCByZXNvbHZlciBhbmQgcHJvbWlzZSBwYXJ0cywKCSAqIGVpdGhlciBvciBib3RoIG9mIHdoaWNoIG1heSBiZSBnaXZlbiBvdXQgc2FmZWx5IHRvIGNvbnN1bWVycy4KCSAqIFRoZSBEZWZlcnJlZCBpdHNlbGYgaGFzIHRoZSBmdWxsIEFQSTogcmVzb2x2ZSwgcmVqZWN0LCBwcm9ncmVzcywgYW5kCgkgKiB0aGVuLiBUaGUgcmVzb2x2ZXIgaGFzIHJlc29sdmUsIHJlamVjdCwgYW5kIHByb2dyZXNzLiAgVGhlIHByb21pc2UKCSAqIG9ubHkgaGFzIHRoZW4uCgkgKgoJICogQHJldHVybiB7RGVmZXJyZWR9CgkgKi8KCWZ1bmN0aW9uIGRlZmVyKCkgewoJCXZhciBkZWZlcnJlZCwgcHJvbWlzZSwgaGFuZGxlcnMsIHByb2dyZXNzSGFuZGxlcnMsCgkJCV90aGVuLCBfcHJvZ3Jlc3MsIF9yZXNvbHZlOwoKCQkvKioKCQkgKiBUaGUgcHJvbWlzZSBmb3IgdGhlIG5ldyBkZWZlcnJlZAoJCSAqIEB0eXBlIHtQcm9taXNlfQoJCSAqLwoJCXByb21pc2UgPSBuZXcgUHJvbWlzZSh0aGVuKTsKCgkJLyoqCgkJICogVGhlIGZ1bGwgRGVmZXJyZWQgb2JqZWN0LCB3aXRoIHtAbGluayBQcm9taXNlfSBhbmQge0BsaW5rIFJlc29sdmVyfSBwYXJ0cwoJCSAqIEBjbGFzcyBEZWZlcnJlZAoJCSAqIEBuYW1lIERlZmVycmVkCgkJICovCgkJZGVmZXJyZWQgPSB7CgkJCXRoZW46ICAgICB0aGVuLCAvLyBERVBSRUNBVEVEOiB1c2UgZGVmZXJyZWQucHJvbWlzZS50aGVuCgkJCXJlc29sdmU6ICBwcm9taXNlUmVzb2x2ZSwKCQkJcmVqZWN0OiAgIHByb21pc2VSZWplY3QsCgkJCS8vIFRPRE86IENvbnNpZGVyIHJlbmFtaW5nIHByb2dyZXNzKCkgdG8gbm90aWZ5KCkKCQkJcHJvZ3Jlc3M6IHByb21pc2VQcm9ncmVzcywKCgkJCXByb21pc2U6ICBwcm9taXNlLAoKCQkJcmVzb2x2ZXI6IHsKCQkJCXJlc29sdmU6ICBwcm9taXNlUmVzb2x2ZSwKCQkJCXJlamVjdDogICBwcm9taXNlUmVqZWN0LAoJCQkJcHJvZ3Jlc3M6IHByb21pc2VQcm9ncmVzcwoJCQl9CgkJfTsKCgkJaGFuZGxlcnMgPSBbXTsKCQlwcm9ncmVzc0hhbmRsZXJzID0gW107CgoJCS8qKgoJCSAqIFByZS1yZXNvbHV0aW9uIHRoZW4oKSB0aGF0IGFkZHMgdGhlIHN1cHBsaWVkIGNhbGxiYWNrLCBlcnJiYWNrLCBhbmQgcHJvZ2JhY2sKCQkgKiBmdW5jdGlvbnMgdG8gdGhlIHJlZ2lzdGVyZWQgbGlzdGVuZXJzCgkJICogQHByaXZhdGUKCQkgKgoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRdIHJlc29sdXRpb24gaGFuZGxlcgoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25SZWplY3RlZF0gcmVqZWN0aW9uIGhhbmRsZXIKCQkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUHJvZ3Jlc3NdIHByb2dyZXNzIGhhbmRsZXIKCQkgKi8KCQlfdGhlbiA9IGZ1bmN0aW9uKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKSB7CgkJCS8vIFRPRE86IFByb21pc2VzL0ErIGNoZWNrIHR5cGVvZiBvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcwoJCQl2YXIgZGVmZXJyZWQsIHByb2dyZXNzSGFuZGxlcjsKCgkJCWRlZmVycmVkID0gZGVmZXIoKTsKCgkJCXByb2dyZXNzSGFuZGxlciA9IHR5cGVvZiBvblByb2dyZXNzID09PSAnZnVuY3Rpb24nCgkJCQk/IGZ1bmN0aW9uKHVwZGF0ZSkgewoJCQkJCXRyeSB7CgkJCQkJCS8vIEFsbG93IHByb2dyZXNzIGhhbmRsZXIgdG8gdHJhbnNmb3JtIHByb2dyZXNzIGV2ZW50CgkJCQkJCWRlZmVycmVkLnByb2dyZXNzKG9uUHJvZ3Jlc3ModXBkYXRlKSk7CgkJCQkJfSBjYXRjaChlKSB7CgkJCQkJCS8vIFVzZSBjYXVnaHQgdmFsdWUgYXMgcHJvZ3Jlc3MKCQkJCQkJZGVmZXJyZWQucHJvZ3Jlc3MoZSk7CgkJCQkJfQoJCQkJfQoJCQkJOiBmdW5jdGlvbih1cGRhdGUpIHsgZGVmZXJyZWQucHJvZ3Jlc3ModXBkYXRlKTsgfTsKCgkJCWhhbmRsZXJzLnB1c2goZnVuY3Rpb24ocHJvbWlzZSkgewoJCQkJcHJvbWlzZS50aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKQoJCQkJCS50aGVuKGRlZmVycmVkLnJlc29sdmUsIGRlZmVycmVkLnJlamVjdCwgcHJvZ3Jlc3NIYW5kbGVyKTsKCQkJfSk7CgoJCQlwcm9ncmVzc0hhbmRsZXJzLnB1c2gocHJvZ3Jlc3NIYW5kbGVyKTsKCgkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlOwoJCX07CgoJCS8qKgoJCSAqIElzc3VlIGEgcHJvZ3Jlc3MgZXZlbnQsIG5vdGlmeWluZyBhbGwgcHJvZ3Jlc3MgbGlzdGVuZXJzCgkJICogQHByaXZhdGUKCQkgKiBAcGFyYW0geyp9IHVwZGF0ZSBwcm9ncmVzcyBldmVudCBwYXlsb2FkIHRvIHBhc3MgdG8gYWxsIGxpc3RlbmVycwoJCSAqLwoJCV9wcm9ncmVzcyA9IGZ1bmN0aW9uKHVwZGF0ZSkgewoJCQlwcm9jZXNzUXVldWUocHJvZ3Jlc3NIYW5kbGVycywgdXBkYXRlKTsKCQkJcmV0dXJuIHVwZGF0ZTsKCQl9OwoKCQkvKioKCQkgKiBUcmFuc2l0aW9uIGZyb20gcHJlLXJlc29sdXRpb24gc3RhdGUgdG8gcG9zdC1yZXNvbHV0aW9uIHN0YXRlLCBub3RpZnlpbmcKCQkgKiBhbGwgbGlzdGVuZXJzIG9mIHRoZSByZXNvbHV0aW9uIG9yIHJlamVjdGlvbgoJCSAqIEBwcml2YXRlCgkJICogQHBhcmFtIHsqfSB2YWx1ZSB0aGUgdmFsdWUgb2YgdGhpcyBkZWZlcnJlZAoJCSAqLwoJCV9yZXNvbHZlID0gZnVuY3Rpb24odmFsdWUpIHsKCQkJdmFsdWUgPSByZXNvbHZlKHZhbHVlKTsKCgkJCS8vIFJlcGxhY2UgX3RoZW4gd2l0aCBvbmUgdGhhdCBkaXJlY3RseSBub3RpZmllcyB3aXRoIHRoZSByZXN1bHQuCgkJCV90aGVuID0gdmFsdWUudGhlbjsKCQkJLy8gUmVwbGFjZSBfcmVzb2x2ZSBzbyB0aGF0IHRoaXMgRGVmZXJyZWQgY2FuIG9ubHkgYmUgcmVzb2x2ZWQgb25jZQoJCQlfcmVzb2x2ZSA9IHJlc29sdmU7CgkJCS8vIE1ha2UgX3Byb2dyZXNzIGEgbm9vcCwgdG8gZGlzYWxsb3cgcHJvZ3Jlc3MgZm9yIHRoZSByZXNvbHZlZCBwcm9taXNlLgoJCQlfcHJvZ3Jlc3MgPSBub29wOwoKCQkJLy8gTm90aWZ5IGhhbmRsZXJzCgkJCXByb2Nlc3NRdWV1ZShoYW5kbGVycywgdmFsdWUpOwoKCQkJLy8gRnJlZSBwcm9ncmVzc0hhbmRsZXJzIGFycmF5IHNpbmNlIHdlJ2xsIG5ldmVyIGlzc3VlIHByb2dyZXNzIGV2ZW50cwoJCQlwcm9ncmVzc0hhbmRsZXJzID0gaGFuZGxlcnMgPSB1bmRlZjsKCgkJCXJldHVybiB2YWx1ZTsKCQl9OwoKCQlyZXR1cm4gZGVmZXJyZWQ7CgoJCS8qKgoJCSAqIFdyYXBwZXIgdG8gYWxsb3cgX3RoZW4gdG8gYmUgcmVwbGFjZWQgc2FmZWx5CgkJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvbkZ1bGZpbGxlZF0gcmVzb2x1dGlvbiBoYW5kbGVyCgkJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblJlamVjdGVkXSByZWplY3Rpb24gaGFuZGxlcgoJCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25Qcm9ncmVzc10gcHJvZ3Jlc3MgaGFuZGxlcgoJCSAqIEByZXR1cm4ge1Byb21pc2V9IG5ldyBwcm9taXNlCgkJICovCgkJZnVuY3Rpb24gdGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcykgewoJCQkvLyBUT0RPOiBQcm9taXNlcy9BKyBjaGVjayB0eXBlb2Ygb25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MKCQkJcmV0dXJuIF90aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKTsKCQl9CgoJCS8qKgoJCSAqIFdyYXBwZXIgdG8gYWxsb3cgX3Jlc29sdmUgdG8gYmUgcmVwbGFjZWQKCQkgKi8KCQlmdW5jdGlvbiBwcm9taXNlUmVzb2x2ZSh2YWwpIHsKCQkJcmV0dXJuIF9yZXNvbHZlKHZhbCk7CgkJfQoKCQkvKioKCQkgKiBXcmFwcGVyIHRvIGFsbG93IF9yZWplY3QgdG8gYmUgcmVwbGFjZWQKCQkgKi8KCQlmdW5jdGlvbiBwcm9taXNlUmVqZWN0KGVycikgewoJCQlyZXR1cm4gX3Jlc29sdmUocmVqZWN0ZWQoZXJyKSk7CgkJfQoKCQkvKioKCQkgKiBXcmFwcGVyIHRvIGFsbG93IF9wcm9ncmVzcyB0byBiZSByZXBsYWNlZAoJCSAqLwoJCWZ1bmN0aW9uIHByb21pc2VQcm9ncmVzcyh1cGRhdGUpIHsKCQkJcmV0dXJuIF9wcm9ncmVzcyh1cGRhdGUpOwoJCX0KCX0KCgkvKioKCSAqIERldGVybWluZXMgaWYgcHJvbWlzZU9yVmFsdWUgaXMgYSBwcm9taXNlIG9yIG5vdC4gIFVzZXMgdGhlIGZlYXR1cmUKCSAqIHRlc3QgZnJvbSBodHRwOi8vd2lraS5jb21tb25qcy5vcmcvd2lraS9Qcm9taXNlcy9BIHRvIGRldGVybWluZSBpZgoJICogcHJvbWlzZU9yVmFsdWUgaXMgYSBwcm9taXNlLgoJICoKCSAqIEBwYXJhbSB7Kn0gcHJvbWlzZU9yVmFsdWUgYW55dGhpbmcKCSAqIEByZXR1cm5zIHtib29sZWFufSB0cnVlIGlmIHByb21pc2VPclZhbHVlIGlzIGEge0BsaW5rIFByb21pc2V9CgkgKi8KCWZ1bmN0aW9uIGlzUHJvbWlzZShwcm9taXNlT3JWYWx1ZSkgewoJCXJldHVybiBwcm9taXNlT3JWYWx1ZSAmJiB0eXBlb2YgcHJvbWlzZU9yVmFsdWUudGhlbiA9PT0gJ2Z1bmN0aW9uJzsKCX0KCgkvKioKCSAqIEluaXRpYXRlcyBhIGNvbXBldGl0aXZlIHJhY2UsIHJldHVybmluZyBhIHByb21pc2UgdGhhdCB3aWxsIHJlc29sdmUgd2hlbgoJICogaG93TWFueSBvZiB0aGUgc3VwcGxpZWQgcHJvbWlzZXNPclZhbHVlcyBoYXZlIHJlc29sdmVkLCBvciB3aWxsIHJlamVjdCB3aGVuCgkgKiBpdCBiZWNvbWVzIGltcG9zc2libGUgZm9yIGhvd01hbnkgdG8gcmVzb2x2ZSwgZm9yIGV4YW1wbGUsIHdoZW4KCSAqIChwcm9taXNlc09yVmFsdWVzLmxlbmd0aCAtIGhvd01hbnkpICsgMSBpbnB1dCBwcm9taXNlcyByZWplY3QuCgkgKgoJICogQHBhcmFtIHtBcnJheX0gcHJvbWlzZXNPclZhbHVlcyBhcnJheSBvZiBhbnl0aGluZywgbWF5IGNvbnRhaW4gYSBtaXgKCSAqICAgICAgb2YgcHJvbWlzZXMgYW5kIHZhbHVlcwoJICogQHBhcmFtIGhvd01hbnkge251bWJlcn0gbnVtYmVyIG9mIHByb21pc2VzT3JWYWx1ZXMgdG8gcmVzb2x2ZQoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvbkZ1bGZpbGxlZF0gcmVzb2x1dGlvbiBoYW5kbGVyCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUmVqZWN0ZWRdIHJlamVjdGlvbiBoYW5kbGVyCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUHJvZ3Jlc3NdIHByb2dyZXNzIGhhbmRsZXIKCSAqIEByZXR1cm5zIHtQcm9taXNlfSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIHRvIGFuIGFycmF5IG9mIGhvd01hbnkgdmFsdWVzIHRoYXQKCSAqIHJlc29sdmVkIGZpcnN0LCBvciB3aWxsIHJlamVjdCB3aXRoIGFuIGFycmF5IG9mIChwcm9taXNlc09yVmFsdWVzLmxlbmd0aCAtIGhvd01hbnkpICsgMQoJICogcmVqZWN0aW9uIHJlYXNvbnMuCgkgKi8KCWZ1bmN0aW9uIHNvbWUocHJvbWlzZXNPclZhbHVlcywgaG93TWFueSwgb25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MpIHsKCgkJY2hlY2tDYWxsYmFja3MoMiwgYXJndW1lbnRzKTsKCgkJcmV0dXJuIHdoZW4ocHJvbWlzZXNPclZhbHVlcywgZnVuY3Rpb24ocHJvbWlzZXNPclZhbHVlcykgewoKCQkJdmFyIHRvUmVzb2x2ZSwgdG9SZWplY3QsIHZhbHVlcywgcmVhc29ucywgZGVmZXJyZWQsIGZ1bGZpbGxPbmUsIHJlamVjdE9uZSwgcHJvZ3Jlc3MsIGxlbiwgaTsKCgkJCWxlbiA9IHByb21pc2VzT3JWYWx1ZXMubGVuZ3RoID4+PiAwOwoKCQkJdG9SZXNvbHZlID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oaG93TWFueSwgbGVuKSk7CgkJCXZhbHVlcyA9IFtdOwoKCQkJdG9SZWplY3QgPSAobGVuIC0gdG9SZXNvbHZlKSArIDE7CgkJCXJlYXNvbnMgPSBbXTsKCgkJCWRlZmVycmVkID0gZGVmZXIoKTsKCgkJCS8vIE5vIGl0ZW1zIGluIHRoZSBpbnB1dCwgcmVzb2x2ZSBpbW1lZGlhdGVseQoJCQlpZiAoIXRvUmVzb2x2ZSkgewoJCQkJZGVmZXJyZWQucmVzb2x2ZSh2YWx1ZXMpOwoKCQkJfSBlbHNlIHsKCQkJCXByb2dyZXNzID0gZGVmZXJyZWQucHJvZ3Jlc3M7CgoJCQkJcmVqZWN0T25lID0gZnVuY3Rpb24ocmVhc29uKSB7CgkJCQkJcmVhc29ucy5wdXNoKHJlYXNvbik7CgkJCQkJaWYoIS0tdG9SZWplY3QpIHsKCQkJCQkJZnVsZmlsbE9uZSA9IHJlamVjdE9uZSA9IG5vb3A7CgkJCQkJCWRlZmVycmVkLnJlamVjdChyZWFzb25zKTsKCQkJCQl9CgkJCQl9OwoKCQkJCWZ1bGZpbGxPbmUgPSBmdW5jdGlvbih2YWwpIHsKCQkJCQkvLyBUaGlzIG9yZGVycyB0aGUgdmFsdWVzIGJhc2VkIG9uIHByb21pc2UgcmVzb2x1dGlvbiBvcmRlcgoJCQkJCS8vIEFub3RoZXIgc3RyYXRlZ3kgd291bGQgYmUgdG8gdXNlIHRoZSBvcmlnaW5hbCBwb3NpdGlvbiBvZgoJCQkJCS8vIHRoZSBjb3JyZXNwb25kaW5nIHByb21pc2UuCgkJCQkJdmFsdWVzLnB1c2godmFsKTsKCgkJCQkJaWYgKCEtLXRvUmVzb2x2ZSkgewoJCQkJCQlmdWxmaWxsT25lID0gcmVqZWN0T25lID0gbm9vcDsKCQkJCQkJZGVmZXJyZWQucmVzb2x2ZSh2YWx1ZXMpOwoJCQkJCX0KCQkJCX07CgoJCQkJZm9yKGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKCQkJCQlpZihpIGluIHByb21pc2VzT3JWYWx1ZXMpIHsKCQkJCQkJd2hlbihwcm9taXNlc09yVmFsdWVzW2ldLCBmdWxmaWxsZXIsIHJlamVjdGVyLCBwcm9ncmVzcyk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gZGVmZXJyZWQudGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgb25Qcm9ncmVzcyk7CgoJCQlmdW5jdGlvbiByZWplY3RlcihyZWFzb24pIHsKCQkJCXJlamVjdE9uZShyZWFzb24pOwoJCQl9CgoJCQlmdW5jdGlvbiBmdWxmaWxsZXIodmFsKSB7CgkJCQlmdWxmaWxsT25lKHZhbCk7CgkJCX0KCgkJfSk7Cgl9CgoJLyoqCgkgKiBJbml0aWF0ZXMgYSBjb21wZXRpdGl2ZSByYWNlLCByZXR1cm5pbmcgYSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIHdoZW4KCSAqIGFueSBvbmUgb2YgdGhlIHN1cHBsaWVkIHByb21pc2VzT3JWYWx1ZXMgaGFzIHJlc29sdmVkIG9yIHdpbGwgcmVqZWN0IHdoZW4KCSAqICphbGwqIHByb21pc2VzT3JWYWx1ZXMgaGF2ZSByZWplY3RlZC4KCSAqCgkgKiBAcGFyYW0ge0FycmF5fFByb21pc2V9IHByb21pc2VzT3JWYWx1ZXMgYXJyYXkgb2YgYW55dGhpbmcsIG1heSBjb250YWluIGEgbWl4CgkgKiAgICAgIG9mIHtAbGluayBQcm9taXNlfXMgYW5kIHZhbHVlcwoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvbkZ1bGZpbGxlZF0gcmVzb2x1dGlvbiBoYW5kbGVyCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUmVqZWN0ZWRdIHJlamVjdGlvbiBoYW5kbGVyCgkgKiBAcGFyYW0ge2Z1bmN0aW9uP30gW29uUHJvZ3Jlc3NdIHByb2dyZXNzIGhhbmRsZXIKCSAqIEByZXR1cm5zIHtQcm9taXNlfSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIHRvIHRoZSB2YWx1ZSB0aGF0IHJlc29sdmVkIGZpcnN0LCBvcgoJICogd2lsbCByZWplY3Qgd2l0aCBhbiBhcnJheSBvZiBhbGwgcmVqZWN0ZWQgaW5wdXRzLgoJICovCglmdW5jdGlvbiBhbnkocHJvbWlzZXNPclZhbHVlcywgb25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MpIHsKCgkJZnVuY3Rpb24gdW53cmFwU2luZ2xlUmVzdWx0KHZhbCkgewoJCQlyZXR1cm4gb25GdWxmaWxsZWQgPyBvbkZ1bGZpbGxlZCh2YWxbMF0pIDogdmFsWzBdOwoJCX0KCgkJcmV0dXJuIHNvbWUocHJvbWlzZXNPclZhbHVlcywgMSwgdW53cmFwU2luZ2xlUmVzdWx0LCBvblJlamVjdGVkLCBvblByb2dyZXNzKTsKCX0KCgkvKioKCSAqIFJldHVybiBhIHByb21pc2UgdGhhdCB3aWxsIHJlc29sdmUgb25seSBvbmNlIGFsbCB0aGUgc3VwcGxpZWQgcHJvbWlzZXNPclZhbHVlcwoJICogaGF2ZSByZXNvbHZlZC4gVGhlIHJlc29sdXRpb24gdmFsdWUgb2YgdGhlIHJldHVybmVkIHByb21pc2Ugd2lsbCBiZSBhbiBhcnJheQoJICogY29udGFpbmluZyB0aGUgcmVzb2x1dGlvbiB2YWx1ZXMgb2YgZWFjaCBvZiB0aGUgcHJvbWlzZXNPclZhbHVlcy4KCSAqIEBtZW1iZXJPZiB3aGVuCgkgKgoJICogQHBhcmFtIHtBcnJheXxQcm9taXNlfSBwcm9taXNlc09yVmFsdWVzIGFycmF5IG9mIGFueXRoaW5nLCBtYXkgY29udGFpbiBhIG1peAoJICogICAgICBvZiB7QGxpbmsgUHJvbWlzZX1zIGFuZCB2YWx1ZXMKCSAqIEBwYXJhbSB7ZnVuY3Rpb24/fSBbb25GdWxmaWxsZWRdIHJlc29sdXRpb24gaGFuZGxlcgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblJlamVjdGVkXSByZWplY3Rpb24gaGFuZGxlcgoJICogQHBhcmFtIHtmdW5jdGlvbj99IFtvblByb2dyZXNzXSBwcm9ncmVzcyBoYW5kbGVyCgkgKiBAcmV0dXJucyB7UHJvbWlzZX0KCSAqLwoJZnVuY3Rpb24gYWxsKHByb21pc2VzT3JWYWx1ZXMsIG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKSB7CgkJY2hlY2tDYWxsYmFja3MoMSwgYXJndW1lbnRzKTsKCQlyZXR1cm4gbWFwKHByb21pc2VzT3JWYWx1ZXMsIGlkZW50aXR5KS50aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBvblByb2dyZXNzKTsKCX0KCgkvKioKCSAqIEpvaW5zIG11bHRpcGxlIHByb21pc2VzIGludG8gYSBzaW5nbGUgcmV0dXJuZWQgcHJvbWlzZS4KCSAqIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSB0aGF0IHdpbGwgZnVsZmlsbCB3aGVuICphbGwqIHRoZSBpbnB1dCBwcm9taXNlcwoJICogaGF2ZSBmdWxmaWxsZWQsIG9yIHdpbGwgcmVqZWN0IHdoZW4gKmFueSBvbmUqIG9mIHRoZSBpbnB1dCBwcm9taXNlcyByZWplY3RzLgoJICovCglmdW5jdGlvbiBqb2luKC8qIC4uLnByb21pc2VzICovKSB7CgkJcmV0dXJuIG1hcChhcmd1bWVudHMsIGlkZW50aXR5KTsKCX0KCgkvKioKCSAqIFRyYWRpdGlvbmFsIG1hcCBmdW5jdGlvbiwgc2ltaWxhciB0byBgQXJyYXkucHJvdG90eXBlLm1hcCgpYCwgYnV0IGFsbG93cwoJICogaW5wdXQgdG8gY29udGFpbiB7QGxpbmsgUHJvbWlzZX1zIGFuZC9vciB2YWx1ZXMsIGFuZCBtYXBGdW5jIG1heSByZXR1cm4KCSAqIGVpdGhlciBhIHZhbHVlIG9yIGEge0BsaW5rIFByb21pc2V9CgkgKgoJICogQHBhcmFtIHtBcnJheXxQcm9taXNlfSBwcm9taXNlIGFycmF5IG9mIGFueXRoaW5nLCBtYXkgY29udGFpbiBhIG1peAoJICogICAgICBvZiB7QGxpbmsgUHJvbWlzZX1zIGFuZCB2YWx1ZXMKCSAqIEBwYXJhbSB7ZnVuY3Rpb259IG1hcEZ1bmMgbWFwcGluZyBmdW5jdGlvbiBtYXBGdW5jKHZhbHVlKSB3aGljaCBtYXkgcmV0dXJuCgkgKiAgICAgIGVpdGhlciBhIHtAbGluayBQcm9taXNlfSBvciB2YWx1ZQoJICogQHJldHVybnMge1Byb21pc2V9IGEge0BsaW5rIFByb21pc2V9IHRoYXQgd2lsbCByZXNvbHZlIHRvIGFuIGFycmF5IGNvbnRhaW5pbmcKCSAqICAgICAgdGhlIG1hcHBlZCBvdXRwdXQgdmFsdWVzLgoJICovCglmdW5jdGlvbiBtYXAocHJvbWlzZSwgbWFwRnVuYykgewoJCXJldHVybiB3aGVuKHByb21pc2UsIGZ1bmN0aW9uKGFycmF5KSB7CgkJCXZhciByZXN1bHRzLCBsZW4sIHRvUmVzb2x2ZSwgcmVzb2x2ZSwgaSwgZDsKCgkJCS8vIFNpbmNlIHdlIGtub3cgdGhlIHJlc3VsdGluZyBsZW5ndGgsIHdlIGNhbiBwcmVhbGxvY2F0ZSB0aGUgcmVzdWx0cwoJCQkvLyBhcnJheSB0byBhdm9pZCBhcnJheSBleHBhbnNpb25zLgoJCQl0b1Jlc29sdmUgPSBsZW4gPSBhcnJheS5sZW5ndGggPj4+IDA7CgkJCXJlc3VsdHMgPSBbXTsKCQkJZCA9IGRlZmVyKCk7CgoJCQlpZighdG9SZXNvbHZlKSB7CgkJCQlkLnJlc29sdmUocmVzdWx0cyk7CgkJCX0gZWxzZSB7CgoJCQkJcmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmVPbmUoaXRlbSwgaSkgewoJCQkJCXdoZW4oaXRlbSwgbWFwRnVuYykudGhlbihmdW5jdGlvbihtYXBwZWQpIHsKCQkJCQkJcmVzdWx0c1tpXSA9IG1hcHBlZDsKCgkJCQkJCWlmKCEtLXRvUmVzb2x2ZSkgewoJCQkJCQkJZC5yZXNvbHZlKHJlc3VsdHMpOwoJCQkJCQl9CgkJCQkJfSwgZC5yZWplY3QpOwoJCQkJfTsKCgkJCQkvLyBTaW5jZSBtYXBGdW5jIG1heSBiZSBhc3luYywgZ2V0IGFsbCBpbnZvY2F0aW9ucyBvZiBpdCBpbnRvIGZsaWdodAoJCQkJZm9yKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKCQkJCQlpZihpIGluIGFycmF5KSB7CgkJCQkJCXJlc29sdmUoYXJyYXlbaV0sIGkpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCS0tdG9SZXNvbHZlOwoJCQkJCX0KCQkJCX0KCgkJCX0KCgkJCXJldHVybiBkLnByb21pc2U7CgoJCX0pOwoJfQoKCS8qKgoJICogVHJhZGl0aW9uYWwgcmVkdWNlIGZ1bmN0aW9uLCBzaW1pbGFyIHRvIGBBcnJheS5wcm90b3R5cGUucmVkdWNlKClgLCBidXQKCSAqIGlucHV0IG1heSBjb250YWluIHByb21pc2VzIGFuZC9vciB2YWx1ZXMsIGFuZCByZWR1Y2VGdW5jCgkgKiBtYXkgcmV0dXJuIGVpdGhlciBhIHZhbHVlIG9yIGEgcHJvbWlzZSwgKmFuZCogaW5pdGlhbFZhbHVlIG1heQoJICogYmUgYSBwcm9taXNlIGZvciB0aGUgc3RhcnRpbmcgdmFsdWUuCgkgKgoJICogQHBhcmFtIHtBcnJheXxQcm9taXNlfSBwcm9taXNlIGFycmF5IG9yIHByb21pc2UgZm9yIGFuIGFycmF5IG9mIGFueXRoaW5nLAoJICogICAgICBtYXkgY29udGFpbiBhIG1peCBvZiBwcm9taXNlcyBhbmQgdmFsdWVzLgoJICogQHBhcmFtIHtmdW5jdGlvbn0gcmVkdWNlRnVuYyByZWR1Y2UgZnVuY3Rpb24gcmVkdWNlKGN1cnJlbnRWYWx1ZSwgbmV4dFZhbHVlLCBpbmRleCwgdG90YWwpLAoJICogICAgICB3aGVyZSB0b3RhbCBpcyB0aGUgdG90YWwgbnVtYmVyIG9mIGl0ZW1zIGJlaW5nIHJlZHVjZWQsIGFuZCB3aWxsIGJlIHRoZSBzYW1lCgkgKiAgICAgIGluIGVhY2ggY2FsbCB0byByZWR1Y2VGdW5jLgoJICogQHJldHVybnMge1Byb21pc2V9IHRoYXQgd2lsbCByZXNvbHZlIHRvIHRoZSBmaW5hbCByZWR1Y2VkIHZhbHVlCgkgKi8KCWZ1bmN0aW9uIHJlZHVjZShwcm9taXNlLCByZWR1Y2VGdW5jIC8qLCBpbml0aWFsVmFsdWUgKi8pIHsKCQl2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCgkJcmV0dXJuIHdoZW4ocHJvbWlzZSwgZnVuY3Rpb24oYXJyYXkpIHsKCQkJdmFyIHRvdGFsOwoKCQkJdG90YWwgPSBhcnJheS5sZW5ndGg7CgoJCQkvLyBXcmFwIHRoZSBzdXBwbGllZCByZWR1Y2VGdW5jIHdpdGggb25lIHRoYXQgaGFuZGxlcyBwcm9taXNlcyBhbmQgdGhlbgoJCQkvLyBkZWxlZ2F0ZXMgdG8gdGhlIHN1cHBsaWVkLgoJCQlhcmdzWzBdID0gZnVuY3Rpb24gKGN1cnJlbnQsIHZhbCwgaSkgewoJCQkJcmV0dXJuIHdoZW4oY3VycmVudCwgZnVuY3Rpb24gKGMpIHsKCQkJCQlyZXR1cm4gd2hlbih2YWwsIGZ1bmN0aW9uICh2YWx1ZSkgewoJCQkJCQlyZXR1cm4gcmVkdWNlRnVuYyhjLCB2YWx1ZSwgaSwgdG90YWwpOwoJCQkJCX0pOwoJCQkJfSk7CgkJCX07CgoJCQlyZXR1cm4gcmVkdWNlQXJyYXkuYXBwbHkoYXJyYXksIGFyZ3MpOwoJCX0pOwoJfQoKCS8qKgoJICogRW5zdXJlIHRoYXQgcmVzb2x1dGlvbiBvZiBwcm9taXNlT3JWYWx1ZSB3aWxsIHRyaWdnZXIgcmVzb2x2ZXIgd2l0aCB0aGUKCSAqIHZhbHVlIG9yIHJlYXNvbiBvZiBwcm9taXNlT3JWYWx1ZSwgb3IgaW5zdGVhZCB3aXRoIHJlc29sdmVWYWx1ZSBpZiBpdCBpcyBwcm92aWRlZC4KCSAqCgkgKiBAcGFyYW0gcHJvbWlzZU9yVmFsdWUKCSAqIEBwYXJhbSB7T2JqZWN0fSByZXNvbHZlcgoJICogQHBhcmFtIHtmdW5jdGlvbn0gcmVzb2x2ZXIucmVzb2x2ZQoJICogQHBhcmFtIHtmdW5jdGlvbn0gcmVzb2x2ZXIucmVqZWN0CgkgKiBAcGFyYW0geyp9IFtyZXNvbHZlVmFsdWVdCgkgKiBAcmV0dXJucyB7UHJvbWlzZX0KCSAqLwoJZnVuY3Rpb24gY2hhaW4ocHJvbWlzZU9yVmFsdWUsIHJlc29sdmVyLCByZXNvbHZlVmFsdWUpIHsKCQl2YXIgdXNlUmVzb2x2ZVZhbHVlID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CgoJCXJldHVybiB3aGVuKHByb21pc2VPclZhbHVlLAoJCQlmdW5jdGlvbih2YWwpIHsKCQkJCXZhbCA9IHVzZVJlc29sdmVWYWx1ZSA/IHJlc29sdmVWYWx1ZSA6IHZhbDsKCQkJCXJlc29sdmVyLnJlc29sdmUodmFsKTsKCQkJCXJldHVybiB2YWw7CgkJCX0sCgkJCWZ1bmN0aW9uKHJlYXNvbikgewoJCQkJcmVzb2x2ZXIucmVqZWN0KHJlYXNvbik7CgkJCQlyZXR1cm4gcmVqZWN0ZWQocmVhc29uKTsKCQkJfSwKCQkJcmVzb2x2ZXIucHJvZ3Jlc3MKCQkpOwoJfQoKCS8vCgkvLyBVdGlsaXR5IGZ1bmN0aW9ucwoJLy8KCgkvKioKCSAqIEFwcGx5IGFsbCBmdW5jdGlvbnMgaW4gcXVldWUgdG8gdmFsdWUKCSAqIEBwYXJhbSB7QXJyYXl9IHF1ZXVlIGFycmF5IG9mIGZ1bmN0aW9ucyB0byBleGVjdXRlCgkgKiBAcGFyYW0geyp9IHZhbHVlIGFyZ3VtZW50IHBhc3NlZCB0byBlYWNoIGZ1bmN0aW9uCgkgKi8KCWZ1bmN0aW9uIHByb2Nlc3NRdWV1ZShxdWV1ZSwgdmFsdWUpIHsKCQl2YXIgaGFuZGxlciwgaSA9IDA7CgoJCXdoaWxlIChoYW5kbGVyID0gcXVldWVbaSsrXSkgewoJCQloYW5kbGVyKHZhbHVlKTsKCQl9Cgl9CgoJLyoqCgkgKiBIZWxwZXIgdGhhdCBjaGVja3MgYXJyYXlPZkNhbGxiYWNrcyB0byBlbnN1cmUgdGhhdCBlYWNoIGVsZW1lbnQgaXMgZWl0aGVyCgkgKiBhIGZ1bmN0aW9uLCBvciBudWxsIG9yIHVuZGVmaW5lZC4KCSAqIEBwcml2YXRlCgkgKiBAcGFyYW0ge251bWJlcn0gc3RhcnQgaW5kZXggYXQgd2hpY2ggdG8gc3RhcnQgY2hlY2tpbmcgaXRlbXMgaW4gYXJyYXlPZkNhbGxiYWNrcwoJICogQHBhcmFtIHtBcnJheX0gYXJyYXlPZkNhbGxiYWNrcyBhcnJheSB0byBjaGVjawoJICogQHRocm93cyB7RXJyb3J9IGlmIGFueSBlbGVtZW50IG9mIGFycmF5T2ZDYWxsYmFja3MgaXMgc29tZXRoaW5nIG90aGVyIHRoYW4KCSAqIGEgZnVuY3Rpb25zLCBudWxsLCBvciB1bmRlZmluZWQuCgkgKi8KCWZ1bmN0aW9uIGNoZWNrQ2FsbGJhY2tzKHN0YXJ0LCBhcnJheU9mQ2FsbGJhY2tzKSB7CgkJLy8gVE9ETzogUHJvbWlzZXMvQSsgdXBkYXRlIHR5cGUgY2hlY2tpbmcgYW5kIGRvY3MKCQl2YXIgYXJnLCBpID0gYXJyYXlPZkNhbGxiYWNrcy5sZW5ndGg7CgoJCXdoaWxlKGkgPiBzdGFydCkgewoJCQlhcmcgPSBhcnJheU9mQ2FsbGJhY2tzWy0taV07CgoJCQlpZiAoYXJnICE9IG51bGwgJiYgdHlwZW9mIGFyZyAhPSAnZnVuY3Rpb24nKSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoJ2FyZyAnK2krJyBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKCQkJfQoJCX0KCX0KCgkvKioKCSAqIE5vLU9wIGZ1bmN0aW9uIHVzZWQgaW4gbWV0aG9kIHJlcGxhY2VtZW50CgkgKiBAcHJpdmF0ZQoJICovCglmdW5jdGlvbiBub29wKCkge30KCglzbGljZSA9IFtdLnNsaWNlOwoKCS8vIEVTNSByZWR1Y2UgaW1wbGVtZW50YXRpb24gaWYgbmF0aXZlIG5vdCBhdmFpbGFibGUKCS8vIFNlZTogaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuNC40LjIxIGFzIHRoZXJlIGFyZSBtYW55CgkvLyBzcGVjaWZpY3MgYW5kIGVkZ2UgY2FzZXMuCglyZWR1Y2VBcnJheSA9IFtdLnJlZHVjZSB8fAoJCWZ1bmN0aW9uKHJlZHVjZUZ1bmMgLyosIGluaXRpYWxWYWx1ZSAqLykgewoJCQkvKmpzaGludCBtYXhjb21wbGV4aXR5OiA3Ki8KCgkJCS8vIEVTNSBkaWN0YXRlcyB0aGF0IHJlZHVjZS5sZW5ndGggPT09IDEKCgkJCS8vIFRoaXMgaW1wbGVtZW50YXRpb24gZGV2aWF0ZXMgZnJvbSBFUzUgc3BlYyBpbiB0aGUgZm9sbG93aW5nIHdheXM6CgkJCS8vIDEuIEl0IGRvZXMgbm90IGNoZWNrIGlmIHJlZHVjZUZ1bmMgaXMgYSBDYWxsYWJsZQoKCQkJdmFyIGFyciwgYXJncywgcmVkdWNlZCwgbGVuLCBpOwoKCQkJaSA9IDA7CgkJCS8vIFRoaXMgZ2VuZXJhdGVzIGEganNoaW50IHdhcm5pbmcsIGRlc3BpdGUgYmVpbmcgdmFsaWQKCQkJLy8gIk1pc3NpbmcgJ25ldycgcHJlZml4IHdoZW4gaW52b2tpbmcgYSBjb25zdHJ1Y3Rvci4iCgkJCS8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanNoaW50L2pzaGludC9pc3N1ZXMvMzkyCgkJCWFyciA9IE9iamVjdCh0aGlzKTsKCQkJbGVuID0gYXJyLmxlbmd0aCA+Pj4gMDsKCQkJYXJncyA9IGFyZ3VtZW50czsKCgkJCS8vIElmIG5vIGluaXRpYWxWYWx1ZSwgdXNlIGZpcnN0IGl0ZW0gb2YgYXJyYXkgKHdlIGtub3cgbGVuZ3RoICE9PSAwIGhlcmUpCgkJCS8vIGFuZCBhZGp1c3QgaSB0byBzdGFydCBhdCBzZWNvbmQgaXRlbQoJCQlpZihhcmdzLmxlbmd0aCA8PSAxKSB7CgkJCQkvLyBTa2lwIHRvIHRoZSBmaXJzdCByZWFsIGVsZW1lbnQgaW4gdGhlIGFycmF5CgkJCQlmb3IoOzspIHsKCQkJCQlpZihpIGluIGFycikgewoJCQkJCQlyZWR1Y2VkID0gYXJyW2krK107CgkJCQkJCWJyZWFrOwoJCQkJCX0KCgkJCQkJLy8gSWYgd2UgcmVhY2hlZCB0aGUgZW5kIG9mIHRoZSBhcnJheSB3aXRob3V0IGZpbmRpbmcgYW55IHJlYWwKCQkJCQkvLyBlbGVtZW50cywgaXQncyBhIFR5cGVFcnJvcgoJCQkJCWlmKCsraSA+PSBsZW4pIHsKCQkJCQkJdGhyb3cgbmV3IFR5cGVFcnJvcigpOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCS8vIElmIGluaXRpYWxWYWx1ZSBwcm92aWRlZCwgdXNlIGl0CgkJCQlyZWR1Y2VkID0gYXJnc1sxXTsKCQkJfQoKCQkJLy8gRG8gdGhlIGFjdHVhbCByZWR1Y2UKCQkJZm9yKDtpIDwgbGVuOyArK2kpIHsKCQkJCS8vIFNraXAgaG9sZXMKCQkJCWlmKGkgaW4gYXJyKSB7CgkJCQkJcmVkdWNlZCA9IHJlZHVjZUZ1bmMocmVkdWNlZCwgYXJyW2ldLCBpLCBhcnIpOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gcmVkdWNlZDsKCQl9OwoKCWZ1bmN0aW9uIGlkZW50aXR5KHgpIHsKCQlyZXR1cm4geDsKCX0KCglyZXR1cm4gd2hlbjsKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kCgk/IGRlZmluZQoJOiBmdW5jdGlvbiAoZmFjdG9yeSkgeyB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcKCQk/IChtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKSkKCQk6ICh0aGlzLndoZW4gICAgICA9IGZhY3RvcnkoKSk7Cgl9CgkvLyBCb2lsZXJwbGF0ZSBmb3IgQU1ELCBOb2RlLCBhbmQgYnJvd3NlciBnbG9iYWwKKTsKCmRlZmluZSgnd2hlbicsIFsnd2hlbi93aGVuJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qKgogKiBhcHBseS5qcwogKiBIZWxwZXIgZm9yIHVzaW5nIGFyZ3VtZW50cy1iYXNlZCBhbmQgdmFyaWFkaWMgY2FsbGJhY2tzIHdpdGggYW55CiAqIHtAbGluayBQcm9taXNlfSB0aGF0IHJlc29sdmVzIHRvIGFuIGFycmF5LgogKgogKiBAYXV0aG9yIGJyaWFuQGhvdmVyY3JhZnRzdHVkaW9zLmNvbQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL2FwcGx5JyxbXSxmdW5jdGlvbigpIHsKCiAgICB2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogICAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYSBmdW5jdGlvbiB0aGF0IHRha2VzIGluZGl2aWR1YWwKICAgICAqIGFyZ3VtZW50cyAoaXQgY2FuIGJlIHZhcmlhZGljLCB0b28pLCBhbmQgcmV0dXJucyBhIG5ldyBmdW5jdGlvbiB0aGF0CiAgICAgKiB0YWtlcyBhIHNpbmdsZSBhcnJheSBhcyBpdHMgb25seSBwYXJhbToKICAgICAqCiAgICAgKiBmdW5jdGlvbiBhcmdCYXNlZChhLCBiLCBjKSB7CiAgICAgKiAgIHJldHVybiBhICsgYiArIGM7CiAgICAgKiB9CiAgICAgKgogICAgICogYXJnQmFzZWQoMSwgMiwgMyk7IC8vIDYKICAgICAqCiAgICAgKiAvLyBDcmVhdGUgYW4gYXJyYXktYmFzZWQgdmVyc2lvbiBvZiBhcmdCYXNlZAogICAgICogdmFyIGFycmF5QmFzZWQgPSBhcHBseShhcmdCYXNlZCk7CiAgICAgKiB2YXIgaW5wdXRzID0gWzEsIDIsIDNdOwogICAgICoKICAgICAqIGFycmF5QmFzZWQoaW5wdXRzKTsgLy8gNgogICAgICoKICAgICAqIFdpdGggcHJvbWlzZXM6CiAgICAgKgogICAgICogdmFyIGQgPSB3aGVuLmRlZmVyKCk7CiAgICAgKiBkLnByb21pc2UudGhlbihhcnJheUJhc2VkKTsKICAgICAqCiAgICAgKiBkLnJlc29sdmUoWzEsIDIsIDNdKTsgLy8gYXJyYXlCYXNlZCBjYWxsZWQgd2l0aCBhcmdzIDEsIDIsIDMgLT4gNgogICAgICoKICAgICAqIEBwYXJhbSBmIHtGdW5jdGlvbn0gYXJndW1lbnRzLWJhc2VkIGZ1bmN0aW9uCiAgICAgKgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBhIG5ldyBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYW4gYXJyYXkKICAgICAqLwogICAgcmV0dXJuIGZ1bmN0aW9uKGYpIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0gYXJyYXkge0FycmF5fSBtdXN0IGJlIGFuIGFycmF5IG9mIGFyZ3VtZW50cyB0byB1c2UgdG8gYXBwbHkgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB0aGUgcmVzdWx0IG9mIGFwcGx5aW5nIGYgd2l0aCB0aGUgYXJndW1lbnRzIGluIGFycmF5LgogICAgICAgICAqLwogICAgICAgIHJldHVybiBmdW5jdGlvbihhcnJheSkgewogICAgICAgICAgICAvLyBJdCBiZXR0ZXIgYmUgYW4gYXJyYXkKICAgICAgICAgICAgaWYodG9TdHJpbmcuY2FsbChhcnJheSkgIT0gJ1tvYmplY3QgQXJyYXldJykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdhcHBseSBjYWxsZWQgd2l0aCBub24tYXJyYXkgYXJnJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmLmFwcGx5KG51bGwsIGFycmF5KTsKICAgICAgICB9OwogICAgfTsKCn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicKICAgID8gZGVmaW5lCiAgICA6IGZ1bmN0aW9uIChmYWN0b3J5KSB7IHR5cGVvZiBtb2R1bGUgIT0gJ3VuZGVmaW5lZCcKICAgICAgICA/IChtb2R1bGUuZXhwb3J0cyAgPSBmYWN0b3J5KCkpCiAgICAgICAgOiAodGhpcy53aGVuX2FwcGx5ID0gZmFjdG9yeSgpKTsKICAgIH0KICAgIC8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKmdsb2JhbCBzZXRUaW1lb3V0OnRydWUqLwoKLyoqCiAqIGRlbGF5LmpzCiAqCiAqIEhlbHBlciB0aGF0IHJldHVybnMgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgYWZ0ZXIgYSBkZWxheS4KICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9kZWxheScsWycuL3doZW4nXSwgZnVuY3Rpb24od2hlbikgewoKICAgIHZhciB1bmRlZjsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSBhZnRlciBhIG1zZWMgZGVsYXkuICBJZiBwcm9taXNlCiAgICAgKiBpcyBzdXBwbGllZCwgdGhlIGRlbGF5IHdpbGwgc3RhcnQgKmFmdGVyKiB0aGUgc3VwcGxpZWQgcHJvbWlzZSBpcyByZXNvbHZlZC4KICAgICAqCiAgICAgKiBVc2FnZToKICAgICAqIC8vIERvIHNvbWV0aGluZyBhZnRlciAxIHNlY29uZCwgc2ltaWxhciB0byB1c2luZyBzZXRUaW1lb3V0CiAgICAgKiBkZWxheSgxMDAwKS50aGVuKGRvU29tZXRoaW5nKTsKICAgICAqIC8vIG9yCiAgICAgKiB3aGVuKGRlbGF5KDEwMDApLCBkb1NvbWV0aGluZyk7CiAgICAgKgogICAgICogLy8gRG8gc29tZXRoaW5nIDEgc2Vjb25kIGFmdGVyIHRyaWdnZXJpbmdQcm9taXNlIHJlc29sdmVzCiAgICAgKiBkZWxheSh0cmlnZ2VyaW5nUHJvbWlzZSwgMTAwMCkudGhlbihkb1NvbWV0aGluZywgaGFuZGxlUmVqZWN0aW9uKTsKICAgICAqIC8vIG9yCiAgICAgKiB3aGVuKGRlbGF5KHRyaWdnZXJpbmdQcm9taXNlLCAxMDAwKSwgZG9Tb21ldGhpbmcsIGhhbmRsZVJlamVjdGlvbik7CiAgICAgKgogICAgICogQHBhcmFtIFtwcm9taXNlXSBhbnl0aGluZyAtIGFueSBwcm9taXNlIG9yIHZhbHVlIGFmdGVyIHdoaWNoIHRoZSBkZWxheSB3aWxsIHN0YXJ0CiAgICAgKiBAcGFyYW0gbXNlYyB7TnVtYmVyfSBkZWxheSBpbiBtaWxsaXNlY29uZHMKICAgICAqLwogICAgcmV0dXJuIGZ1bmN0aW9uIGRlbGF5KHByb21pc2UsIG1zZWMpIHsKICAgICAgICBpZihhcmd1bWVudHMubGVuZ3RoIDwgMikgewogICAgICAgICAgICBtc2VjID0gcHJvbWlzZSA+Pj4gMDsKICAgICAgICAgICAgcHJvbWlzZSA9IHVuZGVmOwogICAgICAgIH0KCiAgICAgICAgdmFyIGRlZmVycmVkID0gd2hlbi5kZWZlcigpOwoKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHByb21pc2UpOwogICAgICAgIH0sIG1zZWMpOwoKICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICAgIH07Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nCiAgICA/IGRlZmluZQogICAgOiBmdW5jdGlvbiAoZGVwcywgZmFjdG9yeSkgeyB0eXBlb2YgbW9kdWxlICE9ICd1bmRlZmluZWQnCiAgICAgICAgPyAobW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoJy4vd2hlbicpKSkKICAgICAgICA6ICh0aGlzLndoZW5fZGVsYXkgPSBmYWN0b3J5KHRoaXMud2hlbikpOwogICAgfQogICAgLy8gQm9pbGVycGxhdGUgZm9yIEFNRCwgTm9kZSwgYW5kIGJyb3dzZXIgZ2xvYmFsCik7CgoKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qZ2xvYmFsIHNldFRpbWVvdXQ6dHJ1ZSwgY2xlYXJUaW1lb3V0OnRydWUqLwoKLyoqCiAqIHRpbWVvdXQuanMKICoKICogSGVscGVyIHRoYXQgcmV0dXJucyBhIHByb21pc2UgdGhhdCByZWplY3RzIGFmdGVyIGEgc3BlY2lmaWVkIHRpbWVvdXQsCiAqIGlmIG5vdCBleHBsaWNpdGx5IHJlc29sdmVkIG9yIHJlamVjdGVkIGJlZm9yZSB0aGF0LgogKgogKiBAYXV0aG9yIGJyaWFuQGhvdmVyY3JhZnRzdHVkaW9zLmNvbQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL3RpbWVvdXQnLFsnLi93aGVuJ10sIGZ1bmN0aW9uKHdoZW4pIHsKCiAgICB2YXIgdW5kZWY7CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgbmV3IHByb21pc2UgdGhhdCB3aWxsIGF1dG9tYXRpY2FsbHkgcmVqZWN0IGFmdGVyIG1zZWMgaWYKICAgICAqIHRoZSBzdXBwbGllZCBwcm9taXNlIGRvZXNuJ3QgcmVzb2x2ZSBvciByZWplY3QgYmVmb3JlIHRoYXQuCiAgICAgKgogICAgICogVXNhZ2U6CiAgICAgKgogICAgICogdmFyIGQgPSB3aGVuLmRlZmVyKCk7CiAgICAgKiAvLyBTZXR1cCBkIGhvd2V2ZXIgeW91IG5lZWQKICAgICAqCiAgICAgKiAvLyByZXR1cm4gYSBuZXcgcHJvbWlzZSB0aGF0IHdpbGwgdGltZW91dCBpZiBkIGRvZXNuJ3QgcmVzb2x2ZS9yZWplY3QgZmlyc3QKICAgICAqIHJldHVybiB0aW1lb3V0KGQucHJvbWlzZSwgMTAwMCk7CiAgICAgKgogICAgICogQHBhcmFtIHByb21pc2UgYW55dGhpbmcgLSBhbnkgcHJvbWlzZSBvciB2YWx1ZSB0aGF0IHNob3VsZCB0cmlnZ2VyCiAgICAgKiAgdGhlIHJldHVybmVkIHByb21pc2UgdG8gcmVzb2x2ZSBvciByZWplY3QgYmVmb3JlIHRoZSBtc2VjIHRpbWVvdXQKICAgICAqIEBwYXJhbSBtc2VjIHtOdW1iZXJ9IHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzCiAgICAgKgogICAgICogQHJldHVybnMge1Byb21pc2V9CiAgICAgKi8KICAgIHJldHVybiBmdW5jdGlvbiB0aW1lb3V0KHByb21pc2UsIG1zZWMpIHsKICAgICAgICB2YXIgZGVmZXJyZWQsIHRpbWVvdXRSZWY7CgogICAgICAgIGRlZmVycmVkID0gd2hlbi5kZWZlcigpOwoKICAgICAgICB0aW1lb3V0UmVmID0gc2V0VGltZW91dChmdW5jdGlvbiBvblRpbWVvdXQoKSB7CiAgICAgICAgICAgIHRpbWVvdXRSZWYgJiYgZGVmZXJyZWQucmVqZWN0KG5ldyBFcnJvcigndGltZWQgb3V0JykpOwogICAgICAgIH0sIG1zZWMpOwoKICAgICAgICBmdW5jdGlvbiBjYW5jZWxUaW1lb3V0KCkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dFJlZik7CiAgICAgICAgICAgIHRpbWVvdXRSZWYgPSB1bmRlZjsKICAgICAgICB9CgogICAgICAgIHdoZW4ocHJvbWlzZSwKICAgICAgICAgICAgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGNhbmNlbFRpbWVvdXQoKTsKICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgICAgIGNhbmNlbFRpbWVvdXQoKTsKICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChyZWFzb24pOwogICAgICAgICAgICB9CiAgICAgICAgKTsKCiAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICB9OwoKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJwogICAgPyBkZWZpbmUKICAgIDogZnVuY3Rpb24gKGRlcHMsIGZhY3RvcnkpIHsgdHlwZW9mIG1vZHVsZSAhPSAndW5kZWZpbmVkJwogICAgICAgID8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCcuL3doZW4nKSkpCiAgICAgICAgOiAodGhpcy53aGVuX3RpbWVvdXQgPSBmYWN0b3J5KHRoaXMud2hlbikpOwogICAgfQogICAgLy8gQm9pbGVycGxhdGUgZm9yIEFNRCwgTm9kZSwgYW5kIGJyb3dzZXIgZ2xvYmFsCik7CgoKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qKgogKiBwYXJhbGxlbC5qcwogKgogKiBSdW4gYSBzZXQgb2YgdGFzayBmdW5jdGlvbnMgaW4gcGFyYWxsZWwuICBBbGwgdGFza3Mgd2lsbAogKiByZWNlaXZlIHRoZSBzYW1lIGFyZ3MKICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9wYXJhbGxlbCcsWycuL3doZW4nXSwgZnVuY3Rpb24od2hlbikgewoKCS8qKgoJICogUnVuIGFycmF5IG9mIHRhc2tzIGluIHBhcmFsbGVsCgkgKiBAcGFyYW0gdGFza3Mge0FycmF5fFByb21pc2V9IGFycmF5IG9yIHByb21pc2VGb3JBcnJheSBvZiB0YXNrIGZ1bmN0aW9ucwoJICogQHBhcmFtIFthcmdzXSB7Kn0gYXJndW1lbnRzIHRvIGJlIHBhc3NlZCB0byBhbGwgdGFza3MKCSAqIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UgZm9yIGFycmF5IGNvbnRhaW5pbmcgdGhlCgkgKiByZXN1bHQgb2YgZWFjaCB0YXNrIGluIHRoZSBhcnJheSBwb3NpdGlvbiBjb3JyZXNwb25kaW5nCgkgKiB0byBwb3NpdGlvbiBvZiB0aGUgdGFzayBpbiB0aGUgdGFza3MgYXJyYXkKCSAqLwoJcmV0dXJuIGZ1bmN0aW9uIHBhcmFsbGVsKHRhc2tzIC8qLCBhcmdzLi4uICovKSB7CgkJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoJCXJldHVybiB3aGVuLm1hcCh0YXNrcywgZnVuY3Rpb24odGFzaykgewoJCQlyZXR1cm4gdGFzay5hcHBseShudWxsLCBhcmdzKTsKCQl9KTsKCX07Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQKCT8gZGVmaW5lCgk6IGZ1bmN0aW9uIChkZXBzLCBmYWN0b3J5KSB7IHR5cGVvZiBleHBvcnRzID09ICdvYmplY3QnCgkJPyAobW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoJy4vd2hlbicpKSkKCQk6ICh0aGlzLndoZW5fcGFyYWxsZWwgPSBmYWN0b3J5KHRoaXMud2hlbikpOwoJfQoJLy8gQm9pbGVycGxhdGUgZm9yIEFNRCwgTm9kZSwgYW5kIGJyb3dzZXIgZ2xvYmFsCik7CgoKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qKgogKiBwaXBlbGluZS5qcwogKgogKiBSdW4gYSBzZXQgb2YgdGFzayBmdW5jdGlvbnMgaW4gc2VxdWVuY2UsIHBhc3NpbmcgdGhlIHJlc3VsdAogKiBvZiB0aGUgcHJldmlvdXMgYXMgYW4gYXJndW1lbnQgdG8gdGhlIG5leHQuICBMaWtlIGEgc2hlbGwKICogcGlwZWxpbmUsIGUuZy4gYGNhdCBmaWxlLnR4dCB8IGdyZXAgJ2ZvbycgfCBzZWQgLWUgJ3MvZm9vL2Jhci9nJwogKgogKiBAYXV0aG9yIGJyaWFuQGhvdmVyY3JhZnRzdHVkaW9zLmNvbQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL3BpcGVsaW5lJyxbJy4vd2hlbiddLCBmdW5jdGlvbih3aGVuKSB7CgoJLyoqCgkgKiBSdW4gYXJyYXkgb2YgdGFza3MgaW4gYSBwaXBlbGluZSB3aGVyZSB0aGUgbmV4dAoJICogdGFza3MgcmVjZWl2ZXMgdGhlIHJlc3VsdCBvZiB0aGUgcHJldmlvdXMuICBUaGUgZmlyc3QgdGFzawoJICogd2lsbCByZWNlaXZlIHRoZSBpbml0aWFsQXJncyBhcyBpdHMgYXJndW1lbnQgbGlzdC4KCSAqIEBwYXJhbSB0YXNrcyB7QXJyYXl8UHJvbWlzZX0gYXJyYXkgb3IgcHJvbWlzZSBmb3IgYXJyYXkgb2YgdGFzayBmdW5jdGlvbnMKCSAqIEBwYXJhbSBbaW5pdGlhbEFyZ3MuLi5dIHsqfSBhcmd1bWVudHMgdG8gYmUgcGFzc2VkIHRvIHRoZSBmaXJzdCB0YXNrCgkgKiBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIGZvciByZXR1cm4gdmFsdWUgb2YgdGhlIGZpbmFsIHRhc2sKCSAqLwoJcmV0dXJuIGZ1bmN0aW9uIHBpcGVsaW5lKHRhc2tzIC8qIGluaXRpYWxBcmdzLi4uICovKSB7CgkJdmFyIGluaXRpYWxBcmdzLCBydW5UYXNrOwoKCQlpbml0aWFsQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgoJCS8vIFNlbGYtb3B0aW1pemluZyBmdW5jdGlvbiB0byBydW4gZmlyc3QgdGFzayB3aXRoIG11bHRpcGxlCgkJLy8gYXJncyB1c2luZyBhcHBseSwgYnV0IHN1YnNlcXVlbmNlIHRhc2tzIHZpYSBkaXJlY3QgaW52b2NhdGlvbgoJCXJ1blRhc2sgPSBmdW5jdGlvbih0YXNrLCBhcmdzKSB7CgkJCXJ1blRhc2sgPSBmdW5jdGlvbih0YXNrLCBhcmcpIHsKCQkJCXJldHVybiB0YXNrKGFyZyk7CgkJCX07CgkJCQoJCQlyZXR1cm4gdGFzay5hcHBseShudWxsLCBhcmdzKTsKCQl9OwoKCQlyZXR1cm4gd2hlbi5yZWR1Y2UodGFza3MsCgkJCWZ1bmN0aW9uKGFyZ3MsIHRhc2spIHsKCQkJCXJldHVybiBydW5UYXNrKHRhc2ssIGFyZ3MpOwoJCQl9LAoJCQlpbml0aWFsQXJncwoJCSk7Cgl9OwoKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kCgk/IGRlZmluZQoJOiBmdW5jdGlvbiAoZGVwcywgZmFjdG9yeSkgeyB0eXBlb2YgZXhwb3J0cyA9PSAnb2JqZWN0JwoJCT8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCcuL3doZW4nKSkpCgkJOiAodGhpcy53aGVuX3BpcGVsaW5lID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKCX0KCS8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogc2VxdWVuY2UuanMKICoKICogUnVuIGEgc2V0IG9mIHRhc2sgZnVuY3Rpb25zIGluIHNlcXVlbmNlLiAgQWxsIHRhc2tzIHdpbGwKICogcmVjZWl2ZSB0aGUgc2FtZSBhcmdzLgogKgogKiBAYXV0aG9yIGJyaWFuQGhvdmVyY3JhZnRzdHVkaW9zLmNvbQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL3NlcXVlbmNlJyxbJy4vd2hlbiddLCBmdW5jdGlvbih3aGVuKSB7CgoJLyoqCgkgKiBSdW4gYXJyYXkgb2YgdGFza3MgaW4gc2VxdWVuY2Ugd2l0aCBubyBvdmVybGFwCgkgKiBAcGFyYW0gdGFza3Mge0FycmF5fFByb21pc2V9IGFycmF5IG9yIHByb21pc2VGb3JBcnJheSBvZiB0YXNrIGZ1bmN0aW9ucwoJICogQHBhcmFtIFthcmdzXSB7Kn0gYXJndW1lbnRzIHRvIGJlIHBhc3NlZCB0byBhbGwgdGFza3MKCSAqIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UgZm9yIGFuIGFycmF5IGNvbnRhaW5pbmcKCSAqIHRoZSByZXN1bHQgb2YgZWFjaCB0YXNrIGluIHRoZSBhcnJheSBwb3NpdGlvbiBjb3JyZXNwb25kaW5nCgkgKiB0byBwb3NpdGlvbiBvZiB0aGUgdGFzayBpbiB0aGUgdGFza3MgYXJyYXkKCSAqLwoJcmV0dXJuIGZ1bmN0aW9uIHNlcXVlbmNlKHRhc2tzIC8qLCBhcmdzLi4uICovKSB7CgkJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoJCXJldHVybiB3aGVuLnJlZHVjZSh0YXNrcywgZnVuY3Rpb24ocmVzdWx0cywgdGFzaykgewoJCQlyZXR1cm4gd2hlbih0YXNrLmFwcGx5KG51bGwsIGFyZ3MpLCBmdW5jdGlvbihyZXN1bHQpIHsKCQkJCXJlc3VsdHMucHVzaChyZXN1bHQpOwoJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCX0pOwoJCX0sIFtdKTsKCX07Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQKCT8gZGVmaW5lCgk6IGZ1bmN0aW9uIChkZXBzLCBmYWN0b3J5KSB7IHR5cGVvZiBleHBvcnRzID09ICdvYmplY3QnCgkJPyAobW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoJy4vd2hlbicpKSkKCQk6ICh0aGlzLndoZW5fc2VxdWVuY2UgPSBmYWN0b3J5KHRoaXMud2hlbikpOwoJfQoJLy8gQm9pbGVycGxhdGUgZm9yIEFNRCwgTm9kZSwgYW5kIGJyb3dzZXIgZ2xvYmFsCik7CgoKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qKgogKiBjYW5jZWxhYmxlLmpzCiAqCiAqIERlY29yYXRvciB0aGF0IG1ha2VzIGEgZGVmZXJyZWQgImNhbmNlbGFibGUiLiAgSXQgYWRkcyBhIGNhbmNlbCgpIG1ldGhvZCB0aGF0CiAqIHdpbGwgY2FsbCBhIHNwZWNpYWwgY2FuY2VsIGhhbmRsZXIgZnVuY3Rpb24gYW5kIHRoZW4gcmVqZWN0IHRoZSBkZWZlcnJlZC4gIFRoZQogKiBjYW5jZWwgaGFuZGxlciBjYW4gYmUgdXNlZCB0byBkbyByZXNvdXJjZSBjbGVhbnVwLCBvciBhbnl0aGluZyBlbHNlIHRoYXQgc2hvdWxkCiAqIGJlIGRvbmUgYmVmb3JlIGFueSBvdGhlciByZWplY3Rpb24gaGFuZGxlcnMgYXJlIGV4ZWN1dGVkLgogKgogKiBVc2FnZToKICoKICogdmFyIGNhbmNlbGFibGVEZWZlcnJlZCA9IGNhbmNlbGFibGUod2hlbi5kZWZlcigpLCBteUNhbmNlbEhhbmRsZXIpOwogKgogKiBAYXV0aG9yIGJyaWFuQGhvdmVyY3JhZnRzdHVkaW9zLmNvbQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL2NhbmNlbGFibGUnLFsnLi93aGVuJ10sIGZ1bmN0aW9uKHdoZW4pIHsKCiAgICAvKioKICAgICAqIE1ha2VzIGRlZmVycmVkIGNhbmNlbGFibGUsIGFkZGluZyBhIGNhbmNlbCgpIG1ldGhvZC4KICAgICAqCiAgICAgKiBAcGFyYW0gZGVmZXJyZWQge0RlZmVycmVkfSB0aGUge0BsaW5rIERlZmVycmVkfSB0byBtYWtlIGNhbmNlbGFibGUKICAgICAqIEBwYXJhbSBjYW5jZWxlciB7RnVuY3Rpb259IGNhbmNlbCBoYW5kbGVyIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiB0aGlzIGRlZmVycmVkIGlzIGNhbmNlbGVkLiAgVGhpcwogICAgICogaXMgZ3VhcmFudGVlZCB0byBydW4gYmVmb3JlIGFsbCBvdGhlciByZWplY3Rpb24gaGFuZGxlcnMuICBUaGUgY2FuY2VsZXIgd2lsbCBOT1QgYmUgZXhlY3V0ZWQgaWYgdGhlCiAgICAgKiBkZWZlcnJlZCBpcyByZWplY3RlZCBpbiB0aGUgc3RhbmRhcmQgd2F5LCBpLmUuIGRlZmVycmVkLnJlamVjdCgpLiAgSXQgT05MWSBleGVjdXRlcyBpZiB0aGUgZGVmZXJyZWQKICAgICAqIGlzIGNhbmNlbGVkLCBpLmUuIGRlZmVycmVkLmNhbmNlbCgpCiAgICAgKgogICAgICogQHJldHVybnMgZGVmZXJyZWQsIHdpdGggYW4gYWRkZWQgY2FuY2VsKCkgbWV0aG9kLgogICAgICovCiAgICByZXR1cm4gZnVuY3Rpb24oZGVmZXJyZWQsIGNhbmNlbGVyKSB7CgogICAgICAgIHZhciBkZWxlZ2F0ZSA9IHdoZW4uZGVmZXIoKTsKCiAgICAgICAgLy8gQWRkIGEgY2FuY2VsIG1ldGhvZCB0byB0aGUgZGVmZXJyZWQgdG8gcmVqZWN0IHRoZSBkZWxlZ2F0ZQogICAgICAgIC8vIHdpdGggdGhlIHNwZWNpYWwgY2FuY2VsZWQgaW5kaWNhdG9yLgogICAgICAgIGRlZmVycmVkLmNhbmNlbCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZGVsZWdhdGUucmVqZWN0KGNhbmNlbGVyKGRlZmVycmVkKSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gRW5zdXJlIHRoYXQgdGhlIG9yaWdpbmFsIHJlc29sdmUsIHJlamVjdCwgYW5kIHByb2dyZXNzIGFsbCBmb3J3YXJkCiAgICAgICAgLy8gdG8gdGhlIGRlbGVnYXRlCiAgICAgICAgZGVmZXJyZWQucHJvbWlzZS50aGVuKGRlbGVnYXRlLnJlc29sdmUsIGRlbGVnYXRlLnJlamVjdCwgZGVsZWdhdGUucHJvZ3Jlc3MpOwoKICAgICAgICAvLyBSZXBsYWNlIGRlZmVycmVkJ3MgcHJvbWlzZSB3aXRoIHRoZSBkZWxlZ2F0ZSBwcm9taXNlCiAgICAgICAgZGVmZXJyZWQucHJvbWlzZSA9IGRlbGVnYXRlLnByb21pc2U7CgogICAgICAgIC8vIEFsc28gcmVwbGFjZSBkZWZlcnJlZC50aGVuIHRvIGFsbG93IGl0IHRvIGJlIGNhbGxlZCBzYWZlbHkgYW5kCiAgICAgICAgLy8gb2JzZXJ2ZSB0aGUgY2FuY2VsbGF0aW9uCgkJLy8gVE9ETzogUmVtb3ZlIG9uY2UgZGVmZXJyZWQudGhlbiBpcyByZW1vdmVkCiAgICAgICAgZGVmZXJyZWQudGhlbiA9IGRlbGVnYXRlLnByb21pc2UudGhlbjsKCiAgICAgICAgcmV0dXJuIGRlZmVycmVkOwogICAgfTsKCn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicKICAgID8gZGVmaW5lCiAgICA6IGZ1bmN0aW9uIChkZXBzLCBmYWN0b3J5KSB7IHR5cGVvZiBtb2R1bGUgIT0gJ3VuZGVmaW5lZCcKICAgICAgICA/IChtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnLi93aGVuJykpKQogICAgICAgIDogKHRoaXMud2hlbl9jYW5jZWxhYmxlID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKICAgIH0KICAgIC8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgpkZWZpbmUoJ3RocnVzdC91dGlsL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ2xvZGFzaCcsICd1bmRlcnNjb3JlLnN0cmluZycsICd1dWlkJywgJ3doZW4nLCAnd2hlbi9hcHBseScsICd3aGVuL2RlbGF5JywgJ3doZW4vdGltZW91dCcsICd3aGVuL3BhcmFsbGVsJywgJ3doZW4vcGlwZWxpbmUnLCAnd2hlbi9zZXF1ZW5jZScsICd3aGVuL2NhbmNlbGFibGUnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19fX19fLCBfX19zX18sIF9fdXVpZF9fLCBfX3dfXywgX193aGVuQXBwbHlfXywgX193aGVuRGVsYXlfXywgX193aGVuVGltZW91dF9fLCBfX3doZW5QYXJhbGxlbF9fLCBfX3doZW5QaXBlbGluZV9fLCBfX3doZW5TZXF1ZW5jZV9fLCBfX3doZW5DYW5jZWxhYmxlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIHV0aWwgeyovCiAgICB2YXIgX18gPSBfX19fX187CgogICAgdmFyIF9zID0gX19fc19fOwoKICAgIHZhciB1dWlkID0gX191dWlkX187CgogICAgCiAgICBfXy5taXhpbihfcyk7CiAgICBleHBvcnRzLl8gPSBfXzsKICAgIC8vI3JlZ2lvbiBmdW5jdGlvbgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwogICAgLyoqCiAgICBBIGZ1bmN0aW9uIHRoYXQgZG9lcyBub3RoaW5nLCBvciBubyBvcGVyYXRpb24uICBIZW5jZSB0aGUgbmFtZSBub29wLgogICAgCiAgICBAbWV0aG9kIG5vb3AKICAgICoqLwogICAgZnVuY3Rpb24gbm9vcCgpIHsKICAgIH0KICAgIGV4cG9ydHMubm9vcCA9IG5vb3A7CiAgICB2YXIgcHJvcGVydHlJc0VudW1lcmFibGUgPSBub29wLnByb3BlcnR5SXNFbnVtZXJhYmxlOwogICAgLyoqCiAgICBBdHRlbXB0cyB0byBpbnZva2UsIHNpbWlsYXIgdG8gXy5pbnZva2UsIGJ1dCBpbiB0aGlzIGNhc2UgaXQgdmVyaWZpZXMgdGhhdCB0aGUgcHJvcGVydHkgZXhpc3QsCiAgICBhbmQgYWxzbyB2ZXJpZmllcyB0aGF0IGl0IGlzIGEgZnVuY3Rpb24sIGFuZCBub3QgdGhlIG5vb3AgbWV0aG9kIGF2YWlsYWJsZSBpbiB0aHJ1c3QuCiAgICAKICAgIFRoZSBpbnRlbnQgaXMgYSBtZXRob2QgdGhhdCBhbGxvd3Mgb3ZlcnJpZGUgb2YgZnVuY3Rpb25zLCB3aXRob3V0IGNyZWF0aW5nIGN1c3RvbSBjb2RlLgogICAgCiAgICBAbWV0aG9kIHNhdmVJbnZva2UKICAgIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb250YWluZXIgdGhhdCBoYXMgdGhlIGl0ZW1zCiAgICBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gbWV0aG9kIFRoZSBtZXRob2QgbmFtZSBvbiBldmVyeSBpdGVtLCBvciB0aGUgbWV0aG9kIHRvIGludm9rZSBhZ2FpbnN0IGVhY2ggaXRlbS4KICAgIEBwYXJhbSB7T2JqZWN0fSBbYXJnc10qIFRoZSBhZGRpdGlvbmFsIGFyZ3VtZW50cyB0byBwYXNzIG9udG8gdGhlIG1ldGhvZC4KICAgICoqLwogICAgZnVuY3Rpb24gc2FmZUludm9rZShjb2xsZWN0aW9uLCBtZXRob2ROYW1lKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAyKTsgX2krKykgewogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDJdOwogICAgICAgIH0KICAgICAgICAvKmpzaGludCBiaXR3aXNlOmZhbHNlICovCiAgICAgICAgICAgICAgICB2YXIgaW5kZXgsIGl0ZXJhdGVlID0gY29sbGVjdGlvbiwgcmVzdWx0OwogICAgICAgIGlmKCFjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9CiAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMiksIGlzRnVuYyA9IHR5cGVvZiBtZXRob2ROYW1lID09ICdmdW5jdGlvbicsIG1ldGhvZEV4aXN0czsKICAgICAgICB2YXIgbGVuZ3RoID0gaXRlcmF0ZWUubGVuZ3RoOwogICAgICAgIGluZGV4ID0gLTE7CiAgICAgICAgaWYobGVuZ3RoID09PSBsZW5ndGggPj4+IDApIHsKICAgICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKICAgICAgICAgICAgd2hpbGUoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzID0gKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiBpdGVyYXRlZVtpbmRleF1bbWV0aG9kTmFtZV0pOwogICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzICYmIG1ldGhvZEV4aXN0cyAhPT0gbm9vcCAmJiAocmVzdWx0W2luZGV4XSA9IG1ldGhvZEV4aXN0cy5hcHBseShpdGVyYXRlZVtpbmRleF0sIGFyZ3MpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBza2lwUHJvdG8gPSB0eXBlb2YgaXRlcmF0ZWUgPT0gJ2Z1bmN0aW9uJyAmJiBwcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGl0ZXJhdGVlLCAncHJvdG90eXBlJyk7CiAgICAgICAgICAgIHZhciBwcm9wcyA9IGV4cG9ydHMuXy5rZXlzKGl0ZXJhdGVlKSwgcHJvcEluZGV4ID0gLTEsIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKICAgICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKICAgICAgICAgICAgd2hpbGUoKytwcm9wSW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gcHJvcHNbcHJvcEluZGV4XTsKICAgICAgICAgICAgICAgIGlmKCEoc2tpcFByb3RvICYmIGluZGV4ID09ICdwcm90b3R5cGUnKSkgewogICAgICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyA9IChpc0Z1bmMgPyBtZXRob2ROYW1lIDogaXRlcmF0ZWVbaW5kZXhdW21ldGhvZE5hbWVdKTsKICAgICAgICAgICAgICAgICAgICBtZXRob2RFeGlzdHMgJiYgbWV0aG9kRXhpc3RzICE9PSBub29wICYmIChyZXN1bHRbcHJvcEluZGV4XSA9ICgoaXNGdW5jID8gbWV0aG9kTmFtZSA6IGl0ZXJhdGVlW2luZGV4XVttZXRob2ROYW1lXSkuYXBwbHkoaXRlcmF0ZWVbaW5kZXhdLCBhcmdzKSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLnNhZmVJbnZva2UgPSBzYWZlSW52b2tlOwogICAgLyoqCiAgICAqIENvbnN0cnVjdG9yIHVzZWQgdG8gYmVnZXQgb2JqZWN0cyB0aGF0IHdpcmUgbmVlZHMgdG8gY3JlYXRlIHVzaW5nIG5ldy4KICAgICogQHBhcmFtIGN0b3Ige0Z1bmN0aW9ufSByZWFsIGNvbnN0cnVjdG9yIHRvIGJlIGludm9rZWQKICAgICogQHBhcmFtIGFyZ3Mge0FycmF5fSBhcmd1bWVudHMgdG8gYmUgc3VwcGxpZWQgdG8gY3RvcgogICAgKi8KICAgIGZ1bmN0aW9uIER5bmFtaWNseUNyZWF0ZWQoY3RvciwgYXJncykgewogICAgICAgIHJldHVybiBjdG9yLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfQogICAgLyoqCiAgICAqIENyZWF0ZXMgYW4gb2JqZWN0IGJ5IGVpdGhlciBpbnZva2luZyBjdG9yIGFzIGEgZnVuY3Rpb24gYW5kIHJldHVybmluZyB0aGUgcmVzdWx0LAogICAgKiBvciBieSBjYWxsaW5nIG5ldyBjdG9yKCkuICBJdCB1c2VzIGEgc2ltcGxlIGhldXJpc3RpYyB0byB0cnkgdG8gZ3Vlc3Mgd2hpY2ggYXBwcm9hY2gKICAgICogaXMgdGhlICJyaWdodCIgb25lLgogICAgKgogICAgKiBAcGFyYW0gY3RvciB7RnVuY3Rpb259IGZ1bmN0aW9uIG9yIGNvbnN0cnVjdG9yIHRvIGludm9rZQogICAgKiBAcGFyYW0gYXJncyB7QXJyYXl9IGFycmF5IG9mIGFyZ3VtZW50cyB0byBwYXNzIHRvIGN0b3IgaW4gZWl0aGVyIGNhc2UKICAgICoKICAgICogQHJldHVybnMgVGhlIHJlc3VsdCBvZiBpbnZva2luZyBjdG9yIHdpdGggYXJncywgd2l0aCBvciB3aXRob3V0IG5ldywgZGVwZW5kaW5nIG9uCiAgICAqIHRoZSBzdHJhdGVneSBzZWxlY3RlZC4KICAgICovCiAgICBmdW5jdGlvbiBpbnN0YW50aWF0ZShjdG9yLCBhcmdzLCBuYW1lKSB7CiAgICAgICAgRHluYW1pY2x5Q3JlYXRlZC5wcm90b3R5cGUgPSBjdG9yLnByb3RvdHlwZTsKICAgICAgICBEeW5hbWljbHlDcmVhdGVkLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGN0b3I7CiAgICAgICAgdmFyIGJlZ290dGVuID0gbmV3IER5bmFtaWNseUNyZWF0ZWQoY3RvciwgYXJncyk7CiAgICAgICAgRHluYW1pY2x5Q3JlYXRlZC5wcm90b3R5cGUgPSB2b2lkIDA7CiAgICAgICAgcmV0dXJuIGJlZ290dGVuOwogICAgfQogICAgZXhwb3J0cy5pbnN0YW50aWF0ZSA9IGluc3RhbnRpYXRlOwogICAgLyoqCiAgICBGbGF0dGVuIGFuZCBmaWx0ZXIgYXJyYXlzIGRvd24gdG8ganVzdCB0aGUgZXhpc3RpbmcgcHJvbWlzZXMuCiAgICAKICAgIEBtZXRob2QgZmxhdHRlblRvUHJvbWlzZXMKICAgIEBwYXJhbSB7QXJyYXl9IEFycmF5IHRvIGZsYXR0ZW4sIGFuZCBmaWx0ZXIuCiAgICBAcmV0dXJucyB7QXJyYXkgb2YgUHJvbWlzZXN9CiAgICAqKi8KICAgIGZ1bmN0aW9uIGZsYXR0ZW5Ub1Byb21pc2VzKGFycmF5KSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5mbGF0dGVuKGFycmF5KS5maWx0ZXIoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuIHdoZW4uaXNQcm9taXNlKHgpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5mbGF0dGVuVG9Qcm9taXNlcyA9IGZsYXR0ZW5Ub1Byb21pc2VzOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gb2JqZWN0CiAgICAvKioKICAgIEludmVydHMgYW4gb2JqZWN0LiAgVGhlIGtleXMgYmVjb21lIHZhbHVlcywgYW5kIHRoZSB2YWx1ZXMgYmVjb21lIGtleXMuCiAgICBEb2VzIG5vdCBkbyBhbnkgY29weWluZy4KICAgIAogICAgQG1ldGhvZCBpbnZlcnQKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byBpbnZlcnQuCiAgICBAcmV0dXJucyB7T2JqZWN0fSBUaGUgaW52ZXJ0ZWQgb2JqZWN0LgogICAgKiovCiAgICB2YXIgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgIGZ1bmN0aW9uIGludmVydChvYmopIHsKICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgIH07CiAgICAgICAgZm9yKHZhciBpIGluIG9iaikgewogICAgICAgICAgICBpZihoYXNPd24uY2FsbChvYmosIGkpKSB7CiAgICAgICAgICAgICAgICByZXN1bHRbb2JqW2ldXSA9IGk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGV4cG9ydHMuaW52ZXJ0ID0gaW52ZXJ0OwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gdHlwZS50cwogICAgLyoqCiAgICBDaGVja3MgaXMgdGhlIG9iamVjdCBpcyBhcnJheSBsaWtlLCBsaWtlIHRoZSBhcnVndW1lbnRzIG9iamVjdCwgYnV0IG5vdCBhIHN0cmluZywgb2UgYXJyYXkuCiAgICBqUXVlcnkgb2JqZWN0cyBmb3IgZXhhbXBsZSB3b3VsZCByZXBvcnQgYXMgYXJyYXkgbGlrZS4KICAgIEFzIHdlbGwgYXMga25vY2tvdXQgb2JzZXJ2YWJsZSBhcnJheXMgcmVwb3J0IGFzIGFycmF5IGxpa2UuCiAgICAKICAgIEBtZXRob2QgaXNBcnJheUxpa2UKICAgIEBwYXJhbSB7T2JqZWN0fSBvIFRoZSBvYmplY3QgdG8gY2hlY2sKICAgIEByZXR1cm5zIHtCb29sZWFufSBJcyBpdCB0cnVlIG9yIGZhbHNlLgogICAgKiovCiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZShvKSB7CiAgICAgICAgcmV0dXJuIChvICYmICFleHBvcnRzLl8uaXNTdHJpbmcobykgJiYgby5sZW5ndGggIT09IHVuZGVmaW5lZCkgfHwgZmFsc2U7CiAgICB9CiAgICBleHBvcnRzLmlzQXJyYXlMaWtlID0gaXNBcnJheUxpa2U7CiAgICAvKioKICAgIENoZWNrcyBpZiB0aGUgZ2l2ZW4gb2JqZWN0IGlzIGFycmF5IG9yIGFycmF5IGxpa2UuCiAgICAKICAgIEBtZXRob2QgaXNBcnJheU9yQXJyYXlMaWtlCiAgICBAcGFyYW0ge09iamVjdH0gbyBUaGUgb2JqZWN0IHRvIGNoZWNrCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSXMgaXQgdHJ1ZSBvciBmYWxzZS4KICAgICoqLwogICAgZnVuY3Rpb24gaXNBcnJheU9yQXJyYXlMaWtlKG8pIHsKICAgICAgICByZXR1cm4gZXhwb3J0cy5fLmlzQXJyYXkobykgfHwgKGlzQXJyYXlMaWtlKG8pKTsKICAgIH0KICAgIGV4cG9ydHMuaXNBcnJheU9yQXJyYXlMaWtlID0gaXNBcnJheU9yQXJyYXlMaWtlOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gdXVpZAogICAgICAgIHZhciBndWlkUmVnZXggPSAvXihce3swLDF9KFswLTlhLWZBLUZdKXs4fS0oWzAtOWEtZkEtRl0pezR9LShbMC05YS1mQS1GXSl7NH0tKFswLTlhLWZBLUZdKXs0fS0oWzAtOWEtZkEtRl0pezEyfVx9ezAsMX0pJC8sIGVtdHB0eUd1aWQgPSAnMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwJzsKICAgIC8qKgogICAgUmV0dXJucyBhIG5ldyBzdWRvIGd1aWQsIGxpbWlhdGlvbnMgaW4gSmF2YVNjcmlwdCBtYWtlIG11c3QgbW9yZSByZWxpYWJsZSBndWlkcyBmYWlybHkgZGlmZmljdWx0IHRvIGNyZWF0ZS4KICAgIAogICAgQGZvciB0aHJ1c3QudXRpbAogICAgQG1ldGhvZCBuZXdHdWlkCiAgICBAcmV0dXJucyB7R3VpZH0gVGhlIG5ldyBndWlkLgogICAgKiovCiAgICBmdW5jdGlvbiBuZXdHdWlkKCkgewogICAgICAgIHJldHVybiB1dWlkLnY0KCk7CiAgICB9CiAgICBleHBvcnRzLm5ld0d1aWQgPSBuZXdHdWlkOwogICAgLyoqCiAgICBSZXR1cm5zIGFuIGVtcHR5IGd1aWQuCiAgICAKICAgIEBtZXRob2QgZW1wdHlHdWlkCiAgICBAcmV0dXJucyB7R3VpZH0gVGhlIGVtdHB0eSBndWlkLgogICAgKiovCiAgICBmdW5jdGlvbiBlbXB0eUd1aWQoKSB7CiAgICAgICAgcmV0dXJuIGVtdHB0eUd1aWQ7CiAgICB9CiAgICBleHBvcnRzLmVtcHR5R3VpZCA9IGVtcHR5R3VpZDsKICAgIC8qKgogICAgQ2hlY2tzIGlmIHRoZSBnaXZlbiBzdHJpbmcgaXMgYSBndWlkLgogICAgCiAgICBAbWV0aG9kIGlzR3VpZAogICAgQHBhcmFtIHtHdWlkfSBndWlkCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSWYgdGhlIGd1aWQgaXMgYSBndWlkIG9yIG5vdC4KICAgICoqLwogICAgZnVuY3Rpb24gaXNHdWlkKGd1aWQpIHsKICAgICAgICByZXR1cm4gZXhwb3J0cy5fLmlzU3RyaW5nKGd1aWQpID8gZ3VpZFJlZ2V4LnRlc3QoZ3VpZCkgOiBmYWxzZTsKICAgIH0KICAgIGV4cG9ydHMuaXNHdWlkID0gaXNHdWlkOwogICAgLyoqCiAgICBDaGVja3MgaWYgdGhlIEd1aWQgaXMgYW4gRW1wdHkgR3VpZAogICAgCiAgICBAbWV0aG9kIGlzRW1wdHlHdWlkCiAgICBAcGFyYW0ge0d1aWR9IGd1aWQKICAgIEByZXR1cm5zIHtCb29sZWFufSBJZiB0aGUgZ3VpZCBpcyBhIGd1aWQgb3Igbm90LgogICAgKiovCiAgICBmdW5jdGlvbiBpc0VtcHR5R3VpZChndWlkKSB7CiAgICAgICAgcmV0dXJuIGd1aWQgPT09IGVtdHB0eUd1aWQ7CiAgICB9CiAgICBleHBvcnRzLmlzRW1wdHlHdWlkID0gaXNFbXB0eUd1aWQ7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vI3JlZ2lvbiBzdHJpbmcKICAgICAgICB2YXIgb2JqZWN0Q3VybHlSZWdleCA9IC9ce1x7fFx9XH18XHsoLio/KVx9L2csIG51bWJlckN1cmx5UmVnZXggPSAvXHtce3xcfVx9fFx7KFxkKylcfS9nOwogICAgLyoqCiAgICBDIyBzdHlsZSBzdHJpbmcgZm9ybWF0LgogICAgCiAgICBAZm9yIHRocnVzdC51dGlsCiAgICBAbWV0aG9kIGZvcm1hdAogICAgKiovCiAgICBmdW5jdGlvbiBmb3JtYXQoc3RyKSB7CiAgICAgICAgdmFyIGZvcm1hdEFyZ3MgPSBbXTsKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICBmb3JtYXRBcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgIH0KICAgICAgICBpZih0eXBlb2YgZm9ybWF0QXJnc1swXSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgdmFyIGEgPSBmb3JtYXRBcmdzWzBdOwogICAgICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2Uob2JqZWN0Q3VybHlSZWdleCwgZnVuY3Rpb24gKG0sIG4pIHsKICAgICAgICAgICAgICAgIGlmKG0gPT0gJ3t7JykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAneyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihtID09ICd9fScpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ30nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGEgJiYgYVtuXSB8fCAnJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHIucmVwbGFjZShudW1iZXJDdXJseVJlZ2V4LCBmdW5jdGlvbiAobSwgbikgewogICAgICAgICAgICBpZihtID09ICd7eycpIHsKICAgICAgICAgICAgICAgIHJldHVybiAneyc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobSA9PSAnfX0nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ30nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmb3JtYXRBcmdzW25dIHx8ICcnOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5mb3JtYXQgPSBmb3JtYXQ7CiAgICBmdW5jdGlvbiBnZXRNb2R1bGVOYW1lRm9yUGF0aChuYW1lKSB7CiAgICAgICAgcmV0dXJuIChuYW1lLmxhc3RJbmRleE9mKCcvJykgPiAtMSA/IG5hbWUuc3Vic3RyaW5nKG5hbWUubGFzdEluZGV4T2YoJy8nKSArIDEpIDogbmFtZSkucmVwbGFjZSgvXC4vZywgJy0nKTsKICAgIH0KICAgIGV4cG9ydHMuZ2V0TW9kdWxlTmFtZUZvclBhdGggPSBnZXRNb2R1bGVOYW1lRm9yUGF0aDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHVybAogICAgICAgIHZhciBkb3VibGVTbGFzaFJlZ2V4ID0gL1wvXC8vZywgcjIwID0gLyUyMC9nLCByYnJhY2tldCA9IC9cW1xdJC87CiAgICAvKioKICAgIGpRdWVyeSBwYXJhbSBtZXRob2QgdG8gZW5jb2RlIGZvcm0gcGFyYW1ldGVycy4KICAgIAogICAgQGZvciB0aHJ1c3QudXRpbC51cmwKICAgIEBtZXRob2QgcGFyYW0KICAgICoqLwogICAgZnVuY3Rpb24gcGFyYW0oYSwgdHJhZGl0aW9uYWwpIHsKICAgICAgICB2YXIgcHJlZml4LCBzID0gW10sIGFkZCA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIC8vIElmIHZhbHVlIGlzIGEgZnVuY3Rpb24sIGludm9rZSBpdCBhbmQgcmV0dXJuIGl0cyB2YWx1ZQogICAgICAgICAgICB2YWx1ZSA9IGV4cG9ydHMuXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlKCkgOiAodmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUpOwogICAgICAgICAgICBzW3MubGVuZ3RoXSA9IGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgICB9OwogICAgICAgIC8vIFNldCB0cmFkaXRpb25hbCB0byB0cnVlIGZvciBqUXVlcnkgPD0gMS4zLjIgYmVoYXZpb3IuCiAgICAgICAgLyppZiAodHJhZGl0aW9uYWwgPT09IHVuZGVmaW5lZCkKICAgICAgICB7CiAgICAgICAgLy8gVE9ETyBTdXBwb3J0IGZvciB0cmFkaXRpb25hbEVuY29kaW5nCiAgICAgICAgLy90cmFkaXRpb25hbCA9ICEhbS5jb25maWcoKS50cmFkaXRpb25hbEVuY29kaW5nOwogICAgICAgIH0qLwogICAgICAgIC8vIElmIGFuIGFycmF5IHdhcyBwYXNzZWQgaW4sIGFzc3VtZSB0aGF0IGl0IGlzIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMuCiAgICAgICAgaWYoaXNBcnJheU9yQXJyYXlMaWtlKGEpKSB7CiAgICAgICAgICAgIC8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwogICAgICAgICAgICBleHBvcnRzLl8uZWFjaChhLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgYWRkKHgubmFtZSwgeC52YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIElmIHRyYWRpdGlvbmFsLCBlbmNvZGUgdGhlICJvbGQiIHdheSAodGhlIHdheSAxLjMuMiBvciBvbGRlcgogICAgICAgICAgICAvLyBkaWQgaXQpLCBvdGhlcndpc2UgZW5jb2RlIHBhcmFtcyByZWN1cnNpdmVseS4KICAgICAgICAgICAgZm9yKHByZWZpeCBpbiBhKSB7CiAgICAgICAgICAgICAgICBidWlsZFBhcmFtcyhwcmVmaXgsIGFbcHJlZml4XSwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbgogICAgICAgIHJldHVybiBzLmpvaW4oIiYiKS5yZXBsYWNlKHIyMCwgIisiKTsKICAgIH0KICAgIGV4cG9ydHMucGFyYW0gPSBwYXJhbTsKICAgIGZ1bmN0aW9uIGJ1aWxkUGFyYW1zKHByZWZpeCwgb2JqLCB0cmFkaXRpb25hbCwgYWRkKSB7CiAgICAgICAgaWYoZXhwb3J0cy5fLmlzQXJyYXkob2JqKSkgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgYXJyYXkgaXRlbS4KICAgICAgICAgICAgZXhwb3J0cy5fLmVhY2gob2JqLCBmdW5jdGlvbiAoaSwgdikgewogICAgICAgICAgICAgICAgaWYodHJhZGl0aW9uYWwgfHwgcmJyYWNrZXQudGVzdChwcmVmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVHJlYXQgZWFjaCBhcnJheSBpdGVtIGFzIGEgc2NhbGFyLgogICAgICAgICAgICAgICAgICAgIGFkZChwcmVmaXgsIHYpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBJZiBhcnJheSBpdGVtIGlzIG5vbi1zY2FsYXIgKGFycmF5IG9yIG9iamVjdCksIGVuY29kZSBpdHMKICAgICAgICAgICAgICAgICAgICAvLyBudW1lcmljIGluZGV4IHRvIHJlc29sdmUgZGVzZXJpYWxpemF0aW9uIGFtYmlndWl0eSBpc3N1ZXMuCiAgICAgICAgICAgICAgICAgICAgLy8gTm90ZSB0aGF0IHJhY2sgKGFzIG9mIDEuMC4wKSBjYW4ndCBjdXJyZW50bHkgZGVzZXJpYWxpemUKICAgICAgICAgICAgICAgICAgICAvLyBuZXN0ZWQgYXJyYXlzIHByb3Blcmx5LCBhbmQgYXR0ZW1wdGluZyB0byBkbyBzbyBtYXkgY2F1c2UKICAgICAgICAgICAgICAgICAgICAvLyBhIHNlcnZlciBlcnJvci4gUG9zc2libGUgZml4ZXMgYXJlIHRvIG1vZGlmeSByYWNrJ3MKICAgICAgICAgICAgICAgICAgICAvLyBkZXNlcmlhbGl6YXRpb24gYWxnb3JpdGhtIG9yIHRvIHByb3ZpZGUgYW4gb3B0aW9uIG9yIGZsYWcKICAgICAgICAgICAgICAgICAgICAvLyB0byBmb3JjZSBhcnJheSBzZXJpYWxpemF0aW9uIHRvIGJlIHNoYWxsb3cuCiAgICAgICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4ICsgIlsiICsgKHR5cGVvZiB2ID09PSAib2JqZWN0IiB8fCBleHBvcnRzLl8uaXNBcnJheSh2KSA/IGkgOiAiIikgKyAiXSIsIHYsIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYoIXRyYWRpdGlvbmFsICYmIG9iaiAhPSBudWxsICYmIHR5cGVvZiBvYmogPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIC8vIFNlcmlhbGl6ZSBvYmplY3QgaXRlbS4KICAgICAgICAgICAgZm9yKHZhciBuYW1lIGluIG9iaikgewogICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4ICsgIlsiICsgbmFtZSArICJdIiwgb2JqW25hbWVdLCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFNlcmlhbGl6ZSBzY2FsYXIgaXRlbS4KICAgICAgICAgICAgYWRkKHByZWZpeCwgb2JqKTsKICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIENsZWFucyB1cCBkb3VibGUgc2xhc2hzIGluIGEgdXJsLCB1c2VkIGJ5IHRocnVzdC9kYXRhCiAgICAKICAgIEBtZXRob2QgY2xlYW5VcmwKICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBjbGVhbgogICAgQHJldHJ1c24ge1N0cmluZ30gVGhlIGNsZWFuZWQgdXJsCiAgICAqKi8KICAgIGZ1bmN0aW9uIGNsZWFuVXJsKHVybCkgewogICAgICAgIHJldHVybiB1cmwucmVwbGFjZShkb3VibGVTbGFzaFJlZ2V4LCAnLycpOwogICAgfQogICAgZXhwb3J0cy5jbGVhblVybCA9IGNsZWFuVXJsOwogICAgLyoqCiAgICBDaGVja3MgZm9yIGV4aXN0YW5jZSBvZiBhcHBsaWNhdGlvbiBwYXRoIGluIHRoZSB1cmwsIG9yIGh0dHAgaWYgdGhlIHVybCBpcyBzdXBwb3NlZCB0byBnbyB0byBhbm90aGVyIGxvY2F0aW9uLgogICAgCiAgICBAbWV0aG9kIGZpeHVwVXJsCiAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZml4dXAKICAgIEByZXRydXNuIHtTdHJpbmd9IFRoZSBmaXhlZCB1cmwKICAgICoqLwogICAgZnVuY3Rpb24gZml4dXBVcmwodXJsLCB1cmxQYXRoKSB7CiAgICAgICAgaWYodXJsLmluZGV4T2YoJ2h0dHAnKSA9PT0gLTEpIHsKICAgICAgICAgICAgdmFyIHBhdGggPSB1cmxQYXRoLmxhc3RJbmRleE9mKCcvJykgPT09IHVybFBhdGgubGVuZ3RoIC0gMSA/IHVybFBhdGguc3Vic3RyaW5nKDAsIC0xKSA6IHVybFBhdGg7CiAgICAgICAgICAgIGlmKHVybC5pbmRleE9mKHBhdGgpID09PSAtMSkgewogICAgICAgICAgICAgICAgdXJsID0gcGF0aCArIHVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cmwgPSBjbGVhblVybCh1cmwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdXJsOwogICAgfQogICAgZXhwb3J0cy5maXh1cFVybCA9IGZpeHVwVXJsOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gd2hlbgogICAgdmFyIHcgPSBfX3dfXzsKCiAgICAvL2ltcG9ydCB3ID0gbW9kdWxlKCd3aGVuL2RlYnVnJyk7CiAgICB2YXIgd2hlbkFwcGx5ID0gX193aGVuQXBwbHlfXzsKCiAgICB2YXIgd2hlbkRlbGF5ID0gX193aGVuRGVsYXlfXzsKCiAgICB2YXIgd2hlblRpbWVvdXQgPSBfX3doZW5UaW1lb3V0X187CgogICAgdmFyIHdoZW5QYXJhbGxlbCA9IF9fd2hlblBhcmFsbGVsX187CgogICAgdmFyIHdoZW5QaXBlbGluZSA9IF9fd2hlblBpcGVsaW5lX187CgogICAgdmFyIHdoZW5TZXF1ZW5jZSA9IF9fd2hlblNlcXVlbmNlX187CgogICAgdmFyIHdoZW5DYW5jZWxhYmxlID0gX193aGVuQ2FuY2VsYWJsZV9fOwoKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QudXRpbAogICAgQHN1Ym1vZHVsZSB0aHJ1c3QudXRpbC53aGVuCiAgICAqKi8KICAgIChmdW5jdGlvbiAod2hlbikgewogICAgICAgIHdoZW4ud2hlbiA9IHc7CiAgICAgICAgLyoqCiAgICAgICAgd2hlbi5hcHBseSwgdXNlZCB0byBhcHBseSB3aGVuIHJlc3VsdHMgb3ZlciBhIGZ1bmN0aW9uLCBzaW1pbGFyIHRvIGpRdWVyeXMgRGVmZXJyZWQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1hcHBseV0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1hcHBseSkKICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC51dGlsLndoZW4KICAgICAgICBAbWV0aG9kIHdoZW4uYXBwbHkKICAgICAgICAqKi8KICAgICAgICB3aGVuLmFwcGx5ID0gd2hlbkFwcGx5OwogICAgICAgIC8qKgogICAgICAgIHdoZW4uZGVsYXksIGNyZWF0ZXMgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgaW4geCBtcywgdXNpbmcgc2V0VGltZW91dC4KICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLWRlbGF5XShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLWRlbGF5KQogICAgICAgIAogICAgICAgIEBtZXRob2Qgd2hlbi5kZWxheQogICAgICAgICoqLwogICAgICAgIHdoZW4uZGVsYXkgPSB3aGVuRGVsYXk7CiAgICAgICAgLyoqCiAgICAgICAgd2hlbi50aW1lb3V0LCBjcmVhdGVzIGEgcHJvbWlzZSB0aGF0IHdpbGwgdGltZW91dCBpZiB4IG1zIGlmIG5vdCByZXNvbHZlZC4KICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXRpbWVvdXRdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tdGltZW91dCkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4udGltZW91dAogICAgICAgICoqLwogICAgICAgIHdoZW4udGltZW91dCA9IHdoZW5UaW1lb3V0OwogICAgICAgIC8qKgogICAgICAgIHdoZW4ucGFyYWxsZWwKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBhcmFsbGVsXShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBhcmFsbGVsKQogICAgICAgIAogICAgICAgIEBtZXRob2Qgd2hlbi5wYXJhbGxlbAogICAgICAgICoqLwogICAgICAgIHdoZW4ucGFyYWxsZWwgPSB3aGVuUGFyYWxsZWw7CiAgICAgICAgLyoqCiAgICAgICAgd2hlbi5waXBlbGluZQogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tcGlwZWxpbmVdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tcGlwZWxpbmUpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnBpcGVsaW5lCiAgICAgICAgKiovCiAgICAgICAgd2hlbi5waXBlbGluZSA9IHdoZW5QaXBlbGluZTsKICAgICAgICAvKioKICAgICAgICB3aGVuLnNlcXVlbmNlCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1zZXF1ZW5jZV0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1zZXF1ZW5jZSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uc2VxdWVuY2UKICAgICAgICAqKi8KICAgICAgICB3aGVuLnNlcXVlbmNlID0gd2hlblNlcXVlbmNlOwogICAgICAgIC8qKgogICAgICAgIHdoZW4uY2FuY2VsYWJsZQogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tY2FuY2VsYWJsZV0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1jYW5jZWxhYmxlKQogICAgICAgIAogICAgICAgIEBtZXRob2Qgd2hlbi5jYW5jZWxhYmxlCiAgICAgICAgKiovCiAgICAgICAgd2hlbi5jYW5jZWxhYmxlID0gd2hlbkNhbmNlbGFibGU7CiAgICAgICAgd2hlbi5hbGwgPSB3aGVuLndoZW4uYWxsOwogICAgICAgIHdoZW4uYW55ID0gd2hlbi53aGVuLmFueTsKICAgICAgICB3aGVuLmNoYWluID0gd2hlbi53aGVuLmNoYWluOwogICAgICAgIHdoZW4uZGVmZXIgPSB3aGVuLndoZW4uZGVmZXI7CiAgICAgICAgd2hlbi5pc1Byb21pc2UgPSB3aGVuLndoZW4uaXNQcm9taXNlOwogICAgICAgIHdoZW4ubWFwID0gd2hlbi53aGVuLm1hcDsKICAgICAgICB3aGVuLnJlZHVjZSA9IHdoZW4ud2hlbi5yZWR1Y2U7CiAgICAgICAgd2hlbi5zb21lID0gd2hlbi53aGVuLnNvbWU7CiAgICAgICAgd2hlbi5yZXNvbHZlID0gd2hlbi53aGVuLnJlc29sdmU7CiAgICAgICAgd2hlbi5yZWplY3QgPSB3aGVuLndoZW4ucmVqZWN0OwogICAgICAgIHdoZW4uam9pbiA9IHdoZW4ud2hlbi5qb2luOwogICAgfSkoZXhwb3J0cy53aGVuIHx8IChleHBvcnRzLndoZW4gPSB7fSkpOwogICAgdmFyIHdoZW4gPSBleHBvcnRzLndoZW47CiAgICAvLyNlbmRyZWdpb24KICAgIC8vI3JlZ2lvbiBjYW1lbENhc2UKICAgICAgICB2YXIgcm1zUHJlZml4ID0gL14tbXMtLywgcmRhc2hBbHBoYSA9IC8tKFtcZGEtel0pL2dpLCBmY2FtZWxDYXNlID0gZnVuY3Rpb24gKGFsbCwgbGV0dGVyKSB7CiAgICAgICAgcmV0dXJuIChsZXR0ZXIgKyAiIikudG9VcHBlckNhc2UoKTsKICAgIH07CiAgICBmdW5jdGlvbiBjYW1lbENhc2Uoc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKHJtc1ByZWZpeCwgIm1zLSIpLnJlcGxhY2UocmRhc2hBbHBoYSwgZmNhbWVsQ2FzZSk7CiAgICB9CiAgICBleHBvcnRzLmNhbWVsQ2FzZSA9IGNhbWVsQ2FzZTsKICAgIGZ1bmN0aW9uIHVuQ2FtZWxDYXNlKHN0cikgewogICAgICAgIHJldHVybiBzdHIucmVwbGFjZSgvKFtBLVpdKS9nLCBmdW5jdGlvbiAoYWxsLCBzKSB7CiAgICAgICAgICAgIHJldHVybiAnLScgKyBzLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLnVuQ2FtZWxDYXNlID0gdW5DYW1lbENhc2U7CiAgICAvLyNlbmRyZWcKICAgIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdXRpbCcsIFsndGhydXN0L3V0aWwvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7Cgo7KGZ1bmN0aW9uKGcpewoKICAgIC8vIHN1bW1hcnk6IEEgc2ltcGxlIGZlYXR1cmUgZGV0ZWN0aW9uIGZ1bmN0aW9uL2ZyYW1ld29yay4KICAgIC8vCiAgICAvLyBuYW1lOiBTdHJpbmcKICAgIC8vICAgICAgVGhlIG5hbWUgb2YgdGhlIGZlYXR1cmUgdG8gZGV0ZWN0LCBhcyBkZWZpbmVkIGJ5IHRoZSBvdmVyYWxsIGBoYXNgIHRlc3RzLgogICAgLy8gICAgICBUZXN0cyBjYW4gYmUgcmVnaXN0ZXJlZCB2aWEgYGhhcy5hZGQodGVzdG5hbWUsIHRlc3RmdW5jdGlvbilgLgogICAgLy8KICAgIC8vIGV4YW1wbGU6CiAgICAvLyAgICAgIG15bGlicmFyeS5iaW5kID0gaGFzKCJuYXRpdmUtYmluZCIpID8gZnVuY3Rpb24oZm4sIGNvbnRleHQpewogICAgLy8gICAgICAgICAgcmV0dXJuIGZuLmJpbmQoY29udGV4dCk7CiAgICAvLyAgICAgIH0gOiBmdW5jdGlvbihmbiwgY29udGV4dCl7CiAgICAvLyAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgIC8vICAgICAgICAgICAgICBmbi5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpOwogICAgLy8gICAgICAgICAgfQogICAgLy8gICAgICB9CgogICAgdmFyIE5PTl9IT1NUX1RZUEVTID0geyAiYm9vbGVhbiI6IDEsICJudW1iZXIiOiAxLCAic3RyaW5nIjogMSwgInVuZGVmaW5lZCI6IDEgfSwKICAgICAgICBWRU5ET1JfUFJFRklYRVMgPSBbIldlYmtpdCIsICJNb3oiLCAiTyIsICJtcyIsICJLaHRtbCJdLAogICAgICAgIGQgPSBpc0hvc3RUeXBlKGcsICJkb2N1bWVudCIpICYmIGcuZG9jdW1lbnQsCiAgICAgICAgZWwgPSBkICYmIGlzSG9zdFR5cGUoZCwgImNyZWF0ZUVsZW1lbnQiKSAmJiBkLmNyZWF0ZUVsZW1lbnQoIkRpViIpLAogICAgICAgIGZyZWVFeHBvcnRzID0gdHlwZW9mIGV4cG9ydHMgPT0gIm9iamVjdCIgJiYgZXhwb3J0cywKICAgICAgICBmcmVlTW9kdWxlID0gdHlwZW9mIG1vZHVsZSA9PSAib2JqZWN0IiAmJiBtb2R1bGUsCiAgICAgICAgdGVzdENhY2hlID0ge30KICAgIDsKCiAgICBmdW5jdGlvbiBoYXMoLyogU3RyaW5nICovbmFtZSl7CiAgICAgICAgaWYodHlwZW9mIHRlc3RDYWNoZVtuYW1lXSA9PSAiZnVuY3Rpb24iKXsKICAgICAgICAgICAgdGVzdENhY2hlW25hbWVdID0gdGVzdENhY2hlW25hbWVdKGcsIGQsIGVsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRlc3RDYWNoZVtuYW1lXTsgLy8gQm9vbGVhbgogICAgfQoKICAgIGZ1bmN0aW9uIGFkZCgvKiBTdHJpbmcgKi9uYW1lLCAvKiBGdW5jdGlvbiAqL3Rlc3QsIC8qIEJvb2xlYW4/ICovbm93KXsKICAgICAgICAvLyBzdW1tYXJ5OiBSZWdpc3RlciBhIG5ldyBmZWF0dXJlIGRldGVjdGlvbiB0ZXN0IGZvciBzb21lIG5hbWVkIGZlYXR1cmUKICAgICAgICAvLwogICAgICAgIC8vIG5hbWU6IFN0cmluZwogICAgICAgIC8vICAgICAgVGhlIG5hbWUgb2YgdGhlIGZlYXR1cmUgdG8gdGVzdC4KICAgICAgICAvLwogICAgICAgIC8vIHRlc3Q6IEZ1bmN0aW9uCiAgICAgICAgLy8gICAgICBBIHRlc3QgZnVuY3Rpb24gdG8gcmVnaXN0ZXIuIElmIGEgZnVuY3Rpb24sIHF1ZXVlZCBmb3IgdGVzdGluZyB1bnRpbCBhY3R1YWxseQogICAgICAgIC8vICAgICAgbmVlZGVkLiBUaGUgdGVzdCBmdW5jdGlvbiBzaG91bGQgcmV0dXJuIGEgYm9vbGVhbiBpbmRpY2F0aW5nCiAgICAgICAgLy8gICAgICB0aGUgcHJlc2VuY2Ugb2YgYSBmZWF0dXJlIG9yIGJ1Zy4KICAgICAgICAvLwogICAgICAgIC8vIG5vdzogQm9vbGVhbj8KICAgICAgICAvLyAgICAgIE9wdGlvbmFsLiBPbWl0IGlmIGB0ZXN0YCBpcyBub3QgYSBmdW5jdGlvbi4gUHJvdmlkZXMgYSB3YXkgdG8gaW1tZWRpYXRlbHkKICAgICAgICAvLyAgICAgIHJ1biB0aGUgdGVzdCBhbmQgY2FjaGUgdGhlIHJlc3VsdC4KICAgICAgICAvLyBleGFtcGxlOgogICAgICAgIC8vICAgICAgQSByZWR1bmRhbnQgdGVzdCwgdGVzdEZuIHdpdGggaW1tZWRpYXRlIGV4ZWN1dGlvbjoKICAgICAgICAvLyAgfCAgICAgICBoYXMuYWRkKCJqYXZhc2NyaXB0IiwgZnVuY3Rpb24oKXsgcmV0dXJuIHRydWU7IH0sIHRydWUpOwogICAgICAgIC8vCiAgICAgICAgLy8gZXhhbXBsZToKICAgICAgICAvLyAgICAgIEFnYWluIHdpdGggdGhlIHJlZHVuZGFudG5lc3MuIFlvdSBjYW4gZG8gdGhpcyBpbiB5b3VyIHRlc3RzLCBidXQgd2Ugc2hvdWxkCiAgICAgICAgLy8gICAgICBub3QgYmUgZG9pbmcgdGhpcyBpbiBhbnkgaW50ZXJuYWwgaGFzLmpzIHRlc3RzCiAgICAgICAgLy8gIHwgICAgICAgaGFzLmFkZCgiamF2YXNjcmlwdCIsIHRydWUpOwogICAgICAgIC8vCiAgICAgICAgLy8gZXhhbXBsZToKICAgICAgICAvLyAgICAgIFRocmVlIHRoaW5ncyBhcmUgcGFzc2VkIHRvIHRoZSB0ZXN0RnVuY3Rpb24uIGBnbG9iYWxgLCBgZG9jdW1lbnRgLCBhbmQgYSBnZW5lcmljIGVsZW1lbnQKICAgICAgICAvLyAgICAgIGZyb20gd2hpY2ggdG8gd29yayB5b3VyIHRlc3Qgc2hvdWxkIHRoZSBuZWVkIGFyaXNlLgogICAgICAgIC8vICB8ICAgICAgIGhhcy5hZGQoImJ1Zy1ieWlkIiwgZnVuY3Rpb24oZywgZCwgZWwpewogICAgICAgIC8vICB8ICAgICAgICAgICAvLyBnICA9PSBnbG9iYWwsIHR5cGljYWxseSB3aW5kb3csIHlhZGRhIHlhZGRhCiAgICAgICAgLy8gIHwgICAgICAgICAgIC8vIGQgID09IGRvY3VtZW50IG9iamVjdAogICAgICAgIC8vICB8ICAgICAgICAgICAvLyBlbCA9PSB0aGUgZ2VuZXJpYyBlbGVtZW50LiBhIGBoYXNgIGVsZW1lbnQuCiAgICAgICAgLy8gIHwgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gZmFrZSB0ZXN0LCBieWlkLXdoZW4tZm9ybS1oYXMtbmFtZS1tYXRjaGluZy1hbi1pZCBpcyBzbGlnaHRseSBsb25nZXIKICAgICAgICAvLyAgfCAgICAgICB9KTsKICAgICAgICB0ZXN0Q2FjaGVbbmFtZV0gPSBub3cgPyB0ZXN0KGcsIGQsIGVsKSA6IHRlc3Q7CiAgICB9CgogICAgLy8gY3NzcHJvcCBhZGFwdGVkIGZyb20gaHR0cDovL2dpc3QuZ2l0aHViLmNvbS81OTgwMDggKHRoYW5rcywgXnBpKQogICAgZnVuY3Rpb24gY3NzcHJvcChuYW1lLCBlbCl7CiAgICAgICAgdmFyIHN1cHBvcnRlZCA9IGZhbHNlLAogICAgICAgICAgICBjYXBpdGFsaXplZCA9IG5hbWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBuYW1lLnNsaWNlKDEpLAogICAgICAgICAgICBsZW5ndGggPSBWRU5ET1JfUFJFRklYRVMubGVuZ3RoLAogICAgICAgICAgICBzdHlsZSA9IGVsLnN0eWxlOwoKICAgICAgICBpZih0eXBlb2Ygc3R5bGVbbmFtZV0gPT0gInN0cmluZyIpewogICAgICAgICAgICBzdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB3aGlsZShsZW5ndGgtLSl7CiAgICAgICAgICAgICAgICBpZih0eXBlb2Ygc3R5bGVbVkVORE9SX1BSRUZJWEVTW2xlbmd0aF0gKyBjYXBpdGFsaXplZF0gPT0gInN0cmluZyIpewogICAgICAgICAgICAgICAgICAgIHN1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN1cHBvcnRlZDsKICAgIH0KCiAgICBmdW5jdGlvbiBjbGVhckVsZW1lbnQoZWwpewogICAgICAgIGlmKGVsKXsKICAgICAgICAgICAgd2hpbGUoZWwubGFzdENoaWxkKXsKICAgICAgICAgICAgICAgIGVsLnJlbW92ZUNoaWxkKGVsLmxhc3RDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGVsOwogICAgfQoKICAgIC8vIEhvc3Qgb2JqZWN0cyBjYW4gcmV0dXJuIHR5cGUgdmFsdWVzIHRoYXQgYXJlIGRpZmZlcmVudCBmcm9tIHRoZWlyIGFjdHVhbAogICAgLy8gZGF0YSB0eXBlLiBUaGUgb2JqZWN0cyB3ZSBhcmUgY29uY2VybmVkIHdpdGggdXN1YWxseSByZXR1cm4gbm9uLXByaW1pdGl2ZQogICAgLy8gdHlwZXMgb2Ygb2JqZWN0LCBmdW5jdGlvbiwgb3IgdW5rbm93bi4KICAgIGZ1bmN0aW9uIGlzSG9zdFR5cGUob2JqZWN0LCBwcm9wZXJ0eSl7CiAgICAgICAgdmFyIHR5cGUgPSB0eXBlb2Ygb2JqZWN0W3Byb3BlcnR5XTsKICAgICAgICByZXR1cm4gdHlwZSA9PSAib2JqZWN0IiA/ICEhb2JqZWN0W3Byb3BlcnR5XSA6ICFOT05fSE9TVF9UWVBFU1t0eXBlXTsKICAgIH0KCiAgICAgICAgaGFzLmFkZCA9IGFkZDsKICAgIGhhcy5jbGVhckVsZW1lbnQgPSBjbGVhckVsZW1lbnQ7CiAgICBoYXMuY3NzcHJvcCA9IGNzc3Byb3A7CiAgICBoYXMuaXNIb3N0VHlwZSA9IGlzSG9zdFR5cGU7CiAgICBoYXMuX3Rlc3RzID0gdGVzdENhY2hlOwoKICAgIGhhcy5hZGQoImRvbSIsIGZ1bmN0aW9uKGcsIGQsIGVsKXsKICAgICAgICByZXR1cm4gZCAmJiBlbCAmJiBpc0hvc3RUeXBlKGcsICJsb2NhdGlvbiIpICYmIGlzSG9zdFR5cGUoZCwgImRvY3VtZW50RWxlbWVudCIpICYmCiAgICAgICAgICAgIGlzSG9zdFR5cGUoZCwgImdldEVsZW1lbnRCeUlkIikgJiYgaXNIb3N0VHlwZShkLCAiZ2V0RWxlbWVudHNCeU5hbWUiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGQsICJnZXRFbGVtZW50c0J5VGFnTmFtZSIpICYmIGlzSG9zdFR5cGUoZCwgImNyZWF0ZUNvbW1lbnQiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGQsICJjcmVhdGVFbGVtZW50IikgJiYgaXNIb3N0VHlwZShkLCAiY3JlYXRlVGV4dE5vZGUiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGVsLCAiYXBwZW5kQ2hpbGQiKSAmJiBpc0hvc3RUeXBlKGVsLCAiaW5zZXJ0QmVmb3JlIikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShlbCwgInJlbW92ZUNoaWxkIikgJiYgaXNIb3N0VHlwZShlbCwgImdldEF0dHJpYnV0ZSIpICYmCiAgICAgICAgICAgIGlzSG9zdFR5cGUoZWwsICJzZXRBdHRyaWJ1dGUiKSAmJiBpc0hvc3RUeXBlKGVsLCAicmVtb3ZlQXR0cmlidXRlIikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShlbCwgInN0eWxlIikgJiYgdHlwZW9mIGVsLnN0eWxlLmNzc1RleHQgPT0gInN0cmluZyI7CiAgICB9KTsKCiAgICAvLyBTdG9wIHJlcGVhdCBiYWNrZ3JvdW5kLWltYWdlIHJlcXVlc3RzIGFuZCByZWR1Y2UgbWVtb3J5IGNvbnN1bXB0aW9uIGluIElFNiBTUDEKICAgIC8vIGh0dHA6Ly9taXN0ZXJwaXhlbC5ibG9nc3BvdC5jb20vMjAwNi8wOS9mb3JlbnNpYy1hbmFseXNpcy1vZi1pZTYuaHRtbAogICAgLy8gaHR0cDovL2Jsb2dzLm1zZG4uY29tL2IvY3dpbHNvL2FyY2hpdmUvMjAwNi8xMS8wNy9pZS1yZS1kb3dubG9hZGluZy1iYWNrZ3JvdW5kLWltYWdlcy5hc3B4P1BhZ2VJbmRleD0xCiAgICAvLyBodHRwOi8vc3VwcG9ydC5taWNyb3NvZnQuY29tL2tiLzgyMzcyNwogICAgdHJ5ewogICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJCYWNrZ3JvdW5kSW1hZ2VDYWNoZSIsIGZhbHNlLCB0cnVlKTsKICAgIH1jYXRjaChlKXt9CgogICAgLy8gRXhwb3NlIGhhcygpCiAgICAvLyBzb21lIEFNRCBidWlsZCBvcHRpbWl6ZXJzLCBsaWtlIHIuanMsIGNoZWNrIGZvciBzcGVjaWZpYyBjb25kaXRpb24gcGF0dGVybnMgbGlrZSB0aGUgZm9sbG93aW5nOgogICAgaWYodHlwZW9mIGRlZmluZSA9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBkZWZpbmUuYW1kID09ICJvYmplY3QiICYmIGRlZmluZS5hbWQpewogICAgICAgIGRlZmluZSgiaGFzIixbXSwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgcmV0dXJuIGhhczsKICAgICAgICB9KTsKICAgIH0KICAgIC8vIGNoZWNrIGZvciBgZXhwb3J0c2AgYWZ0ZXIgYGRlZmluZWAgaW4gY2FzZSBhIGJ1aWxkIG9wdGltaXplciBhZGRzIGFuIGBleHBvcnRzYCBvYmplY3QKICAgIGVsc2UgaWYoZnJlZUV4cG9ydHMpewogICAgICAgIC8vIGluIE5vZGUuanMgb3IgUmluZ29KUyB2MC44LjArCiAgICAgICAgaWYoZnJlZU1vZHVsZSAmJiBmcmVlTW9kdWxlLmV4cG9ydHMgPT0gZnJlZUV4cG9ydHMpewogICAgICAgICAgKGZyZWVNb2R1bGUuZXhwb3J0cyA9IGhhcykuaGFzID0gaGFzOwogICAgICAgIH0KICAgICAgICAvLyBpbiBOYXJ3aGFsIG9yIFJpbmdvSlMgdjAuNy4wLQogICAgICAgIGVsc2V7CiAgICAgICAgICBmcmVlRXhwb3J0cy5oYXMgPSBoYXM7CiAgICAgICAgfQogICAgfQogICAgLy8gaW4gYSBicm93c2VyIG9yIFJoaW5vCiAgICBlbHNlewogICAgICAgIC8vIHVzZSBzcXVhcmUgYnJhY2tldCBub3RhdGlvbiBzbyBDbG9zdXJlIENvbXBpbGVyIHdvbid0IG11bmdlIGBoYXNgCiAgICAgICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9jbG9zdXJlL2NvbXBpbGVyL2RvY3MvYXBpLXR1dG9yaWFsMy5odG1sI2V4cG9ydAogICAgICAgIGdbImhhcyJdID0gaGFzOwogICAgfQp9KSh0aGlzKTsKCmRlZmluZSgndGhydXN0L2NhcHN1bGUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJy4vbG9nJywgJ2hhcyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGVhY2ggPSBfLmVhY2gsIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgZXh0ZW5kID0gXy5leHRlbmQsIHdoZW4gPSB1dGlsLndoZW4sIGZsYXR0ZW4gPSBfLmZsYXR0ZW4sIHBsdWNrID0gXy5wbHVjaywgZmxhdHRlblRvUHJvbWlzZXMgPSB1dGlsLmZsYXR0ZW5Ub1Byb21pc2VzLCB0aHJ1c3RDYWNoZSA9IHsKICAgIH0sIF9fb3B0aW9uYWxNZXRob2RzID0gWwogICAgICAgIC8vIE9wdGlvbmFsIG1ldGhvZHMgdGhhdCBtYXkgYmUgb24gYSBtb2R1bGUKICAgICAgICAnc3RhcnQnLCAKICAgICAgICAnc3RvcCcsIAogICAgICAgICdyZWFkeScsIAogICAgICAgICdjb25maWcnLCAKICAgICAgICAKICAgIF0sIF9fcmVxdWlyZWRNZXRob2RzID0gWwogICAgICAgIC8vIFJlcXVpcmVkIG1ldGhvZHMgdGhhdCBtdXN0IGJlIG9uIGV2ZXJ5IG1vZHVsZQogICAgICAgICdpbml0JywgCiAgICAgICAgJ2Rlc3Ryb3knLCAKICAgICAgICAKICAgIF07CiAgICAvKioKICAgIE1vdmVzIGFsbCBwcm9wZXJ0aWVzLCB0aGF0IHNob3VsZCBleGlzdCBvdXRzaWRlIG9mIHRoZSBtb2R1bGUsIGludG8gYSBwcml2YXRlIG9iamVjdCBmb3IgaG9sZGluZy4KICAgIAogICAgQG1ldGhvZCBtb3ZlVG9UaHJ1c3RDYWNoZQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7T2JqZWN0fSBmcm9tIE9iamVjdCB0byBleHRyYWN0IGl0ZW1zIGZyb20KICAgIEBwYXJhbSB7T2JqZWN0fSB0byBPYmplY3QgdG8gcGxhY2UgaXRlbXMgb24KICAgIEBwYXJhbSB7QXJyYXl9IGxpc3QgSXRlbXMgdG8gbW92ZSBmcm9tIHRvIHRoZSBvdGhlciBvYmplY3QKICAgICoqLwogICAgZnVuY3Rpb24gbW92ZVRvVGhydXN0Q2FjaGUoZnJvbSwgdG8sIGxpc3QpIHsKICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gbGlzdC5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgdG9bbGlzdFtpXV0gPSBmcm9tW2xpc3RbaV1dOwogICAgICAgICAgICBkZWxldGUgZnJvbVtsaXN0W2ldXTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBnZXRFdmVudE5hbWVzcGFjZShuYW1lLCBwcmVmaXgpIHsKICAgICAgICBpZighcHJlZml4KSB7CiAgICAgICAgICAgIHByZWZpeCA9ICdtb2R1bGUtJzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICcuJyArIChuYW1lID09PSAnZ2xvYmFsJyA/ICdnbG9iYWwnIDogcHJlZml4ICsgbmFtZS5yZXBsYWNlKC9cLi9nLCAnLScpKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNhbGxGYWNhZGVNZXRob2RzKG1ldGhvZCwgbW9kdWxlQ2FjaGUpIHsKICAgICAgICB2YXIgbSA9IG1vZHVsZUNhY2hlLm1vZHVsZTsKICAgICAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgICAgIF8uZm9yT3duKG1vZHVsZUNhY2hlLmZhY2FkZXMsIGZ1bmN0aW9uIChmYWNhZGUsIGkpIHsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgndGhydXN0L2NhcHN1bGU6IENhbGxpbmcgZmFjYWRlICJ7MH0iIHsxfSgpJywgaSwgbWV0aG9kKSk7CiAgICAgICAgICAgIGlmKGZhY2FkZVttZXRob2RdICYmIGlzT2JqZWN0KGZhY2FkZSkpIHsKICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChmYWNhZGVbbWV0aG9kXS5jYWxsKGZhY2FkZSwgbSkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmVzdWx0cy5wdXNoKHV0aWwuc2FmZUludm9rZSgobS50aHJ1c3QpLl9fdGhydXN0Q29udmVudGlvbnMsIG1ldGhvZCwgbSwgbW9kdWxlQ2FjaGUuZmFjYWRlcykpOwogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgfQogICAgLyoqCiAgICBUaGUgbW9kdWxlIGlzIHRoZSBoZWFydCBvZiB0aGUgdGhydXN0LCBldmVyeSBtb2R1bGUgZ2V0cyBvbmUgZmFjYWRlIHBlciBtb2R1bGUuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICBAY2xhc3MgdGhydXN0Lk1vZHVsZQogICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlCiAgICBAcGFyYW0ge09iamVjdH0gZGVmIFRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgQHBhcmFtIHtTdHJpbmd9IFtuYW1lXSBUaGUgbW9kdWxlIG5hbWUuCiAgICAqKi8KICAgIHZhciBNb2R1bGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vdmFyIE1vZHVsZSA9CiAgICAgICAgZnVuY3Rpb24gTW9kdWxlKHRocnVzdCwgZGVmLCBuYW1lKSB7CiAgICAgICAgICAgIG5hbWUgPSB0aGlzLm5hbWUgPSAobmFtZSB8fCBkZWYubmFtZSk7CiAgICAgICAgICAgIGlmKHR5cGVvZiBkZWYgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGRlZiA9IGRlZihuYW1lKTsKICAgICAgICAgICAgICAgIGRlZi5uYW1lID0gbmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbWlkID0gdGhpcy5taWQgPSB0aHJ1c3QubmFtZSArICc6JyArIG5hbWU7CiAgICAgICAgICAgIHZhciB0Q2FjaGUgPSB0aHJ1c3RDYWNoZVtkZWYuaGFzaCB8fCBtaWRdOwogICAgICAgICAgICAvLyBDbGVhciBhbnkgcG90ZW50aWFsIGNhY2hlZCBjb25maWcgb2JqZWN0cywgdG8gbWFrZSBzdXJlIHRoZXkgcmVmcmVzaCBpZiB0aGUgbW9kdWxlIGlzIHJlZGVmaW5lZC4KICAgICAgICAgICAgaWYodENhY2hlKSB7CiAgICAgICAgICAgICAgICBfLmtleXModENhY2hlKS5maWx0ZXIoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geC5pbmRleE9mKCdjb25maWcuJykgPT09IDA7CiAgICAgICAgICAgICAgICB9KS5mb3JFYWNoKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZSB0Q2FjaGVbeF07CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmluc3RhbmNlID0gZXh0ZW5kKGRlZiwgdENhY2hlICYmIHRDYWNoZS5pbnN0YW5jZSB8fCB7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmluc3RhbmNlLm5hbWUgPSAodGhpcy5pbnN0YW5jZS5uYW1lIHx8IG5hbWUpOwogICAgICAgICAgICB0aGlzLmluc3RhbmNlLm1pZCA9IG1pZDsKICAgICAgICAgICAgaWYoIXRoaXMuaW5zdGFuY2UubmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBbGwgTW9kdWxlcyBtdXN0IGhhdmUgYSBuYW1lIScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vZHVsZXMgbXVzdCBoYXZlIGFuIGluaXQgbWV0aG9kIGFuZCBhIGRlc3Ryb3kgbWV0aG9kLCBpdCdzIHVwIHRvIHRoZSBtb2R1bGUgZGV2ZWxvcGVyIHRvIHBvcHVsYXRlIHRoZXNlIG1ldGhvZHMuCiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBfX3JlcXVpcmVkTWV0aG9kcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmKCFkZWZbX19yZXF1aXJlZE1ldGhvZHNbaV1dKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnUmVxdWlyZWQgInswfSIgbWV0aG9kIG5vdCBmb3VuZCBvbiBtb2R1bGUgInsxfSIhJywgX19yZXF1aXJlZE1ldGhvZHNbaV0sIG5hbWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBJZiB0aGUgbW9kdWxlIG5hbWUgaXMgdW5kZWZpbmVkLCBicmluZyB0aGUgbmFtZSBpbnRvIHRoZSBtb2R1bGUuCiAgICAgICAgICAgIGlmKHR5cGVvZiBkZWYubmFtZSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIGRlZi5uYW1lID0gbmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhydXN0TW9kdWxlQ2FjaGVJdGVtID0gdGhydXN0Q2FjaGVbbWlkXSA9IGV4dGVuZCh0Q2FjaGUgfHwgewogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBfc3RhcnRlZDogZmFsc2UsCiAgICAgICAgICAgICAgICBuYW1lOiB1dGlsLmdldE1vZHVsZU5hbWVGb3JQYXRoKG5hbWUpLAogICAgICAgICAgICAgICAgbW9kdWxlOiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkZWxldGUgdGhydXN0Q2FjaGVbZGVmLmhhc2hdOwogICAgICAgICAgICB2YXIgZmFjYWRlcyA9IHRocnVzdE1vZHVsZUNhY2hlSXRlbS5mYWNhZGVzIHx8ICh0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uZmFjYWRlcyA9IHsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKCF0aHJ1c3QuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUpIHsKICAgICAgICAgICAgICAgIHRocnVzdC5fX2NvbnZlbnRpb25QbHVja1Byb3BlcnRpZXNDYWNoZSA9IGZsYXR0ZW4ocGx1Y2sodGhydXN0Ll9fY29udmVudGlvbnMgfHwgW10sICdwcm9wZXJ0aWVzJykpLmZpbHRlcihmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB4LmluZGV4T2YoJ2NvbmZpZy4nKSAhPT0gMDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vdmUgYWxsIHNwZWNpYWwgcHJvcGVydGllcyBvZmYgdG8gdGhlIHRocnVzdCdzIGludGVybmFsIG1ldGhvZC4KICAgICAgICAgICAgbW92ZVRvVGhydXN0Q2FjaGUodGhpcy5pbnN0YW5jZSwgdGhydXN0TW9kdWxlQ2FjaGVJdGVtLCBfX3JlcXVpcmVkTWV0aG9kcyk7CiAgICAgICAgICAgIG1vdmVUb1RocnVzdENhY2hlKHRoaXMuaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbSwgX19vcHRpb25hbE1ldGhvZHMpOwogICAgICAgICAgICBtb3ZlVG9UaHJ1c3RDYWNoZSh0aGlzLmluc3RhbmNlLCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0sIHRocnVzdC5fX2NvbnZlbnRpb25QbHVja1Byb3BlcnRpZXNDYWNoZSk7CiAgICAgICAgICAgIHV0aWwuc2FmZUludm9rZSh0aHJ1c3QsICdjcmVhdGVGYWNhZGUnLCB0aHJ1c3QsIHRoaXMuaW5zdGFuY2UsIGZhY2FkZXMpOwogICAgICAgICAgICB0aGlzLl9fbmFtZXNwYWNlID0gZ2V0RXZlbnROYW1lc3BhY2UodGhpcy5pbnN0YW5jZS5uYW1lKTsKICAgICAgICAgICAgdGhpcy50aHJ1c3QgPSB0aHJ1c3Q7CiAgICAgICAgICAgIHRoaXMuY2FjaGUgPSB0aHJ1c3RDYWNoZVttaWRdOwogICAgICAgIH0KICAgICAgICBNb2R1bGUudGhydXN0Q2FjaGUgPSB0aHJ1c3RDYWNoZTsKICAgICAgICBNb2R1bGUucHJvdG90eXBlLmNvbnZlbnRpb24gPSAvKioKICAgICAgICBHZXR0ZXIvU2V0dGVyIGZvciBjb252ZW50aW9uIG1ldGhvZHMuCiAgICAgICAgR2V0cyB0aGUgdmFsdWUgY29udmVudGlvbiBwcm9wZXJ0eSAoZGVmaW5lZCBpbiB0aGUgcHJvcGVydGllcyBhcnJheSBvZiBhIGZhY2FkZSkuCiAgICAgICAgU2V0cyB0aGUgdmFsdWUgb2YgYSBjb252ZW50aW9uIHByb3BlcnR5IChmb3Igc3RvcmluZyBjb252ZW50aW9uIGNvbmZpZ3VyYXRpb24pCiAgICAgICAgCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IFRoZSBwcm9wZXJ0eSB0byBnZXQgb3Igc2V0CiAgICAgICAgQHBhcmFtIHtvYmplY3R9IFt2YWx1ZV0gVGhlIHZhbHVlIHRvIHNldAogICAgICAgIEBtZXRob2QgY29udmVudGlvbgogICAgICAgIEByZXR1cm5zIHtPYmplY3R9IFRoZSB2YWxhdWUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHByb3BlcnR5LCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgdGMgPSB0aGlzLmNhY2hlOwogICAgICAgICAgICBpZihwcm9wZXJ0eS5pbmRleE9mKCdjb25maWcuJykgPT09IDApIHsKICAgICAgICAgICAgICAgIGlmKHR5cGVvZiB0Y1twcm9wZXJ0eV0gPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGNbcHJvcGVydHldID0gdGhpcy5nZXRWYWx1ZUZyb21QYXRoKHByb3BlcnR5LCB0YykgfHwgZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgdGNbcHJvcGVydHldID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRjW3Byb3BlcnR5XTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuZ2V0VmFsdWVGcm9tUGF0aCA9IGZ1bmN0aW9uIChwYXRoLCBvYmplY3QpIHsKICAgICAgICAgICAgdmFyIHBhdGhzID0gcGF0aC5zcGxpdCgnLicpLCB2ID0gb2JqZWN0OwogICAgICAgICAgICBfLmVhY2gocGF0aHMsIGZ1bmN0aW9uIChwKSB7CiAgICAgICAgICAgICAgICB2ID0gdiAmJiB2W3BdOwogICAgICAgICAgICAgICAgaWYoIXYpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUudGhydXN0Q3JlYXRlID0gLyoqCiAgICAgICAgSW5qZWN0cyB0aGlzIG1vZHVsZSBpbnRvIHRoZSBnaXZlbiB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB0aHJ1c3RDcmVhdGUKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB0aHJ1c3QuX19pbmplY3RNb2R1bGUodGhpcyk7CiAgICAgICAgfTsKICAgICAgICBNb2R1bGUucHJvdG90eXBlLnRocnVzdENhbGwgPSAvKioKICAgICAgICBNYWtlcyBhIGNhbGwgdG8gYWxsIHRoZSBtb2R1bGVzIGZhY2FkZXMKICAgICAgICBUaGUgb3JkZXIgb2YgdGhlIGNhbGwgZGVwZW5kcyBvbiB0aGUgb3JkZXIgcmVxdWlyZWQuCiAgICAgICAgRHVyaW5nIHRoZSBzdGFydHVwIHN0YWdlIChpbml0LCBzdGFydCwgcmVhZHkpIGZhY2FkZXMgYXJlIGNhbGxlZCBmaXJzdC4KICAgICAgICBEdXJpbmcgdGhlIHNodXRkb3duIHN0YXRlIChzdG9wLCBkZXN0cm95KSBmYWNhZGVzIGFyZSBjYWxsZWQgbGFzdC4KICAgICAgICBUaGlzIGFsbG93cyBtb2R1bGVzIHRvIHN0YXJ0dXAgYW5kIHNodXRkb3duIHdpbGwgYWxsIHRoZSB0b29scyBpdCBoYWQgdG8gYmVnaW4gd2l0aC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHRocnVzdENhbGwKICAgICAgICBAcHJvdGVjdGVkCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZCB0aGUgbWV0aG9kIHRvIGNhbGwKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IGZhY2FkZUFmdGVyIGNhbGxzIGZhY2FkZSBtZXRob2RzIGJlZm9yZSBvciBhZnRlciBtb2R1bGUgbWV0aG9kLgogICAgICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgQXJncyB0byBiZSBwYXNzZWQgb250byB0aGUgbW9kdWxlIG1ldGhvZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobWV0aG9kLCBmYWNhZGVBZnRlciwgYXJncykgewogICAgICAgICAgICB2YXIgc2VxID0gW10sIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCd0aHJ1c3QvY2Fwc3VsZTogQ2FsbGluZyBmYWNhZGVzIGZvciAiezB9IicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICB2YXIgY2FjaGUgPSB0aGlzLmNhY2hlLCBtID0gY2FjaGVbbWV0aG9kXTsKICAgICAgICAgICAgc2VxLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxGYWNhZGVNZXRob2RzKG1ldGhvZCwgY2FjaGUpOwogICAgICAgICAgICAgICAgaWYocmVzdWx0ICYmIHJlc3VsdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlblRvUHJvbWlzZXMocmVzdWx0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihtKSB7CiAgICAgICAgICAgICAgICBzZXEucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IG0uYXBwbHkodGhhdC5pbnN0YW5jZSwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgaWYocmVzdWx0ICYmIHJlc3VsdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW5Ub1Byb21pc2VzKHJlc3VsdCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGZhY2FkZUFmdGVyKSB7CiAgICAgICAgICAgICAgICBzZXEucHVzaChzZXEuc2hpZnQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdoZW4uc2VxdWVuY2Uoc2VxKTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuc3RhcnQgPSAvKioKICAgICAgICBTdGFydCB0aGUgbW9kdWxlLCBpbnNpZGUgdGhlIHRocnVzdCBjb250YWluZXIgaXQgd2FzIGNyZWF0ZWQgb24uCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC50aHJ1c3Quc3RhcnQodGhhdC5uYW1lKTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuc3RvcCA9IC8qKgogICAgICAgIFN0b3AgdGhlIG1vZHVsZSwgaW5zaWRlIHRoZSB0aHJ1c3QgY29udGFpbmVyIGl0IHdhcyBjcmVhdGVkIG9uLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoYXQudGhydXN0LnN0b3AodGhhdC5uYW1lKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBNb2R1bGU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5Nb2R1bGUgPSBNb2R1bGU7ICAgIAogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBtb2R1bGUgaW5zdGFuY2UuCiAgICBGb3JtYXQ6CiAgICB0aHJ1c3QvY2Fwc3VsZSF7aW5zdGFuY2V9Onttb2R1bGVOYW1lfQogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICBmdW5jdGlvbiBsb2FkKG5hbWUsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwgaW5zdGFuY2VOYW1lID0gcGFydHNbMF0sIG1vZHVsZU5hbWUgPSBwYXJ0c1sxXTsKICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgJ3RocnVzdCEnICsgaW5zdGFuY2VOYW1lCiAgICAgICAgXSwgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgbW9kdWxlID0gdGhydXN0Lm1vZHVsZXNbbW9kdWxlTmFtZV07CiAgICAgICAgICAgIGlmKCFtb2R1bGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ01vZHVsZSAiezB9IiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgInsxfSIuJywgbW9kdWxlTmFtZSwgaW5zdGFuY2VOYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbG9hZChtb2R1bGUpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y2Fwc3VsZS5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9pbnN0YW5jZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2NhcHN1bGUnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fY2Fwc3VsZV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAvKioKICAgIEdldHMgdGhlIHRocnVzdCBpbnN0YW5jZXMuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIHdoZW4gPSB1dGlsLndoZW47CiAgICB2YXIgY2Fwc3VsZSA9IF9fY2Fwc3VsZV9fOwoKICAgIC8qKgogICAgVGhlIGF2YWlsYWJsZSB0aHJ1c3QgaW5zdGFuY2VzCiAgICBpbmRleCBieSBuYW1lCiAgICAKICAgIEBmb3IgdGhydXN0Lmluc3RhbmNlCiAgICBAcHJvcGVydHkgaW5zdGFuY2VzCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBleHBvcnRzLmluc3RhbmNlcyA9IHsKICAgIH07CiAgICAvKioKICAgIFRoZSBsb2FkaW5nIHRodXJzdCBpbnN0YW5jZXMuCiAgICBpbmRleCBieSBuYW1lCiAgICAKICAgIEBwcm9wZXJ0eSBsb2FkaW5nSW5zdGFuY2VzCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXMgPSB7CiAgICB9OwogICAgLyoqCiAgICBHZXRzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICAKICAgIEBtZXRob2QgZ2V0SW5zdGFuY2UKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICBAcmV0dXJucyB7VGhydXN0fSBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGdldEluc3RhbmNlKG5hbWUpIHsKICAgICAgICByZXR1cm4gZXhwb3J0cy5pbnN0YW5jZXNbbmFtZV0gfHwgbnVsbDsKICAgIH0KICAgIGV4cG9ydHMuZ2V0SW5zdGFuY2UgPSBnZXRJbnN0YW5jZTsKICAgIC8qKgogICAgRmV0Y2hzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICBUaGlzIGxvYWRzIGFzeW5jcm9ub3VzbHksIGFzIHRoZSBpbnN0YW5jZSBtYXkgbm90IGJlIGxvYWRlZAogICAgCiAgICBAbWV0aG9kIGZldGNoSW5zdGFuY2UKICAgIEBzdGF0aWMKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgaW5zdGFuY2UgbmFtZQogICAgQHJldHVybnMge1Byb21pc2V9IFRvIGEgdGhydXN0IGluc3RhbmNlIHNwZWMKICAgICoqLwogICAgZnVuY3Rpb24gZmV0Y2hJbnN0YW5jZShuYW1lKSB7CiAgICAgICAgdmFyIGRlZmVyID0gZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzW25hbWVdIHx8IChleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXNbbmFtZV0gPSB3aGVuLmRlZmVyKCkpOwogICAgICAgIHJldHVybiBkZWZlcjsKICAgIH0KICAgIGV4cG9ydHMuZmV0Y2hJbnN0YW5jZSA9IGZldGNoSW5zdGFuY2U7CiAgICAvKioKICAgIENsZWFycyB0aGUgVGhydXN0IEluc3RhbmNlIGNhY2hlLCB0aGlzIGlzIHVzZWQgZm9yIHVuaXQgdGVzdGluZywgYW5kIGNsZWFyaW5nIGFsbCB0aGUgY2FjaGUgZGF0YSBlYWNoIHJ1bi4KICAgIAogICAgQG1ldGhvZCBjbGVhckNhY2hlCiAgICBAc3RhdGljCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBmdW5jdGlvbiBjbGVhckNhY2hlKCkgewogICAgICAgIHV0aWwuXy5lYWNoKHV0aWwuXy5rZXlzKGV4cG9ydHMuaW5zdGFuY2VzKSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgZXhwb3J0cy5pbnN0YW5jZXNbeF0gPSBudWxsOwogICAgICAgICAgICBkZWxldGUgZXhwb3J0cy5pbnN0YW5jZXNbeF07CiAgICAgICAgfSk7CiAgICAgICAgdXRpbC5fLmVhY2godXRpbC5fLmtleXMoZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzKSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzW3hdID0gbnVsbDsKICAgICAgICAgICAgZGVsZXRlIGV4cG9ydHMubG9hZGluZ0luc3RhbmNlc1t4XTsKICAgICAgICB9KTsKICAgICAgICB1dGlsLl8uZWFjaCh1dGlsLl8ua2V5cyhjYXBzdWxlLk1vZHVsZS50aHJ1c3RDYWNoZSksIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIGNhcHN1bGUuTW9kdWxlLnRocnVzdENhY2hlW3hdID0gbnVsbDsKICAgICAgICAgICAgZGVsZXRlIGNhcHN1bGUuTW9kdWxlLnRocnVzdENhY2hlW3hdOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5jbGVhckNhY2hlID0gY2xlYXJDYWNoZTsKICAgIC8qfSovIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWluc3RhbmNlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2NvbmZpZycsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnLi9pbnN0YW5jZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3RocnVzdEluc3RhbmNlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGNvbmZpZyB7Ki8KICAgIAogICAgdmFyIHRocnVzdEluc3RhbmNlID0gX190aHJ1c3RJbnN0YW5jZV9fOwoKICAgIC8qKgogICAgUHJvdmlkZXMgdGhydXN0IGNvbmZpZ3VyYXRpb24KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBzdWJtb2R1bGUgdGhydXN0LmNvbmZpZwogICAgKiovCiAgICAvKioKICAgIFRoaXMgcHJvcGVydHksIHRlbGxzIHRoZSBmcmFtZXdvcmsgaWYgaXQgc2hvdWxkIHRocm93IGVycm9ycyBvciBub3QuCiAgICBJbiBwcm9kdWN0aW9uIGl0J3MgcmVjb21tZW5kZWQgbm90IHRvIHRocm93IGVycm9ycywgdGhhdCB3YXkgaWYgYSBjb21wb25lbnQgZmFpbHMKICAgIHRoZXJlIGlzIGEgY2hhbmNlIHRoZSBhcHBsaWNhdGlvbiBjYW4gc3RpbGwgcmVjb3Zlci4KICAgIAogICAgQGZvciB0aHJ1c3QuY29uZmlnCiAgICBAcHJvcGVydHkgdGhyb3dFcnJvcnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCBmYWxzZQogICAgKiovCiAgICBleHBvcnRzLnRocm93RXJyb3JzID0gdHJ1ZTsKICAgIC8qKgogICAgVGVsbHMgdGhlIGZyYW1ld29yayB0byBydW4gaW4gYXN5bmMgbW9kZSwgdGhpcyBtYXkgZGVsYXkgc3RhcnQgdXAsIGJ1dCB3aWxsIG1ha2UgaW1hZ2UgbG9hZGluZyBhbmQgaW5pdGFsIHJ1bm5pbmcgYXBwZWFyIGZhc3Rlci4KICAgIAogICAgQHByb3BlcnR5IGFzeW5jCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtCb29sZWFufQogICAgQGRlZmF1bHQgdHJ1ZQogICAgKiovCiAgICBleHBvcnRzLmFzeW5jID0gdHJ1ZTsKICAgIC8qKgogICAgVGVsbHMgdGhydXN0IHRvIGV4cG9zZSBlYWNoIGluc3RhbmNlIGFzIGEgZ2xvYmFsLCB0aGlzIGFsbG93cyBsZWdhY3kgY29tcG9uZW50cyB0byB1dGlsaXplIHBhcnRzIG9mIHRocnVzdCwgb3IgZWFzaWx5CiAgICBnZXQgYXQgeW91ciB0aHJ1c3QgaW5zdGFuY2UgZHVyaW5nIGRlYnVnZ2luZy4KICAgIAogICAgQHByb3BlcnR5IGV4cG9zZUdsb2JhbHMKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuZXhwb3NlR2xvYmFscyA9IHRydWU7CiAgICBleHBvcnRzLnVybCA9IHsKICAgICAgICBwYXRoOiAvKioKICAgICAgICBUaGlzIHByb3BlcnR5LCBnaXZlcyB0aGUgZnJhbWV3b3JrIGl0J3MgZGVmYXVsdCBwYXRoLCBpZiBkaWZmZXJlbnQgdGhhbiAnLycKICAgICAgICAKICAgICAgICBAcHJvcGVydHkgdXJsLnBhdGgKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7U3RyaW5nfQogICAgICAgIEBkZWZhdWx0ICIvIgogICAgICAgICoqLwogICAgICAgICcvJywKICAgICAgICB0cmFkaXRpb25hbEVuY29kaW5nOiAvKioKICAgICAgICBUaGlzIHByb3BlcnR5LCB0ZWxscyB0aGUgZnJhbWV3b3JrIGhvdyBpdCBzaG91bGQgZW5jb2RlIGFycmF5IGZvcm0gZGF0YS4KICAgICAgICBJbiBnZW5lcmFsLCBmb3IgQVNQLk5FVCBiYXNlZCBhcHBsaWNhdGlvbnMsIHRyYWRpdGlvbmFsIHNob3VsZCBiZSB0cnVlLgogICAgICAgIEZvciBSdWJ5L1B5dGhvbiBiYXNlZCBhcHBsaWNhdGlvbnMsIHRoaXMgc2hvdWxkIGJlIGZhbHNlLgogICAgICAgIAogICAgICAgIEBwcm9wZXJ0eSB1cmwudHJhZGl0aW9uYWxFbmNvZGluZwogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtCb29sZWFufQogICAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgICAgKiovCiAgICAgICAgdHJ1ZQogICAgfTsKICAgIGV4cG9ydHMubG9nID0gewogICAgICAgIGxldmVsOiAvKioKICAgICAgICBUaGlzIGxlbmRzIHRvIHRoZSBsb2cgbGV2ZWwgb2YgdGhydXN0LgogICAgICAgIAogICAgICAgIEVSUk9SOiAxCiAgICAgICAgV0FSTjogMgogICAgICAgIElORk86IDMKICAgICAgICBERUJVRzogNAogICAgICAgIAogICAgICAgIEBwcm9wZXJ0eSBsb2cubGV2ZWwKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7U3RyaW5nfQogICAgICAgIEBkZWZhdWx0IDEKICAgICAgICAqKi8KICAgICAgICA0LAogICAgICAgIGVuYWJsZWQ6IC8qKgogICAgICAgIFRoaXMgdG9nZ2xlcyBlbmFibGluZyBvbiBvciBvZmYuCiAgICAgICAgCiAgICAgICAgQHByb3BlcnR5IGxvZy5lbmFibGVkCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgICAqKi8KICAgICAgICB0cnVlCiAgICB9OwogICAgLyoqCiAgICBQbHVnaW5zIGZvciB0aHJ1c3QgdG8gbG9hZCwgb3ZlcnJpZGUgd2l0aCB5b3VyIG93biBzZXQgaWYgeW91IGhhdmUgYSBkaWZmZXJlbnQgc2V0LgogICAgCiAgICBAcHJvcGVydHkgcGx1Z2lucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucGx1Z2lucyA9IFtdOwogICAgLyoqCiAgICAqIFRoZSBzZXQgb2YgbW9kdWxlcyB0byBwcmVsb2FkIHdpdGggdGhlIGluaXRhbCB3aXJldXAgb2YgdGhlIFRocnVzdCBpbnN0YW5jZS4KICAgICoKICAgICogQWNjZXB0cyB0aGUgbW9kdWxlIHBhdGggYSBzdHJpbmcgb3IgdGhlIG1vZHVsZSBhcyBhbiBvYmplY3QgaW4gdGhlIGZvbGxvd2luZyBmb3JtYXQuCiAgICAqICAgV2hlcmUgYXJncyB3aWxsIGJlIGhhbmRlZCBvZmYgdG8gdGhlIG1vZHVsZSBsaWZlIGN5Y2xlIG1ldGhvZHMuCiAgICAqCiAgICAqICAgIHsKICAgICogICAgICAgIHBhdGg6ICcnLAogICAgKiAgICAgICAgYXJnczogW10KICAgICogICAgfQogICAgKgogICAgKiBAcHJvcGVydHkgbW9kdWxlcwogICAgKiBAcmVhZE9ubHkKICAgICogQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLm1vZHVsZXMgPSBbXTsKICAgIC8qKgogICAgVXNlZCBpbnRlcm5hbGx5IGJ5IHRocnVzdCB0byBkZXRlcm1pbmUgaWYgdGhlIGxpZmUtY3ljbGUgaXMgY29udHJvbGxlZCBieSB0aHJ1c3QsIG9yIGEgcGFyZW50IGluc3RhbmNlLgogICAgCiAgICBAcHJvcGVydHkgY2hpbGRJbnN0YW5jZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICoqLwogICAgZXhwb3J0cy5jaGlsZEluc3RhbmNlID0gZmFsc2U7CiAgICAvKioKICAgIFVzZWQgaW50ZXJuYWxseSBieSB0aHJ1c3QgdG8gZGV0ZXJtaW5lIGlmIHRocnVzdCBzaG91bGQgY29udHJvbCB0aGUgbGlmZS1jeWNsZSwgb3IgdGhlIGNvbnN1bWVyCiAgICAKICAgIEBwcm9wZXJ0eSBhdXRvbWF0aWNMaWZlY3ljbGUKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICAqKi8KICAgIGV4cG9ydHMuYXV0b21hdGljTGlmZWN5Y2xlID0gdHJ1ZTsKICAgIC8qKgogICAgVXNlZCBpbnRlcm5hbGx5IGJ5IHRocnVzdCB0byBkZXRlcm1pbiBpZiB0aGUgdGhydXN0IGluc3RhbmNlIHNob3VsZCBhdXRvbWF0aWNhbGx5IHN0YXJ0IHVwb24gY3JlYXRpb24uCiAgICAKICAgIEBwcm9wZXJ0eSBhdXRvU3RhcnQKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICAqKi8KICAgIGV4cG9ydHMuYXV0b1N0YXJ0ID0gZmFsc2U7CiAgICAvKioKICAgIERlZmluZSB0aGUgY29udmVudGlvbnMgdGhhdCB1bmlxdWUgdG8gdGhydXN0LCB0aGV5IGFyZSBub3Qgc3BlY2lmaWMgdG8gYW55IG9uZSBwbHVnaW4uCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lcicsIAogICAgICAgICd0aHJ1c3QvY29udmVudGlvbi9hdXRvc3RhcnQnLCAKICAgICAgICAndGhydXN0L2NvbnZlbnRpb24vZGVwZW5kZW50Lm1vZHVsZXMnCiAgICBdOwogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBjdXJyZW50IGNvbmZpZyBmb3IgdGhlIGN1cnJlbnQgdGhydXN0IGluc3RhbmNlLCBvciB0aGUgY29uZmlnIG9mIHRoZSBnaXZlbiBwbHVnaW4uCiAgICBBZGRpbmcgdGhlIDogY2hhcmFjdGVyIHJlcXVlc3RzIGEgc3BlY2lmaWMgY29uZmlnIHBsdWdpbi4KICAgIHRocnVzdC9jb25maWchZ2xvYmFsID0gdGhydXN0IWdsb2JhbDpjb25maWcgPSBUaHJ1c3QgaW5zdGFuY2UgY29uZmlnIGZyb20gdGhlIGluc3RhbmNlIG5hbWVkIGdsb2JhbC4KICAgIAogICAgQG1ldGhvZCBsb2FkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgZnVuY3Rpb24gbG9hZChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksIHJlYWxOYW1lID0gcGFydHNbMF0sIHBsdWdpbk5hbWUgPSBwYXJ0c1sxXSB8fCBmYWxzZTsKICAgICAgICB2YXIgaW5zdGFuY2VEZWZlcnJlZCA9IHRocnVzdEluc3RhbmNlLmZldGNoSW5zdGFuY2UocmVhbE5hbWUpOwogICAgICAgIGluc3RhbmNlRGVmZXJyZWQucHJvbWlzZS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBwbHVnaW4gPSBwbHVnaW5OYW1lICYmIGNvbnRleHQuY2ZnW3BsdWdpbk5hbWVdIHx8IGNvbnRleHQuY29uZmlnOwogICAgICAgICAgICBpZighcGx1Z2luKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BsdWdpbiAiJyArIHBsdWdpbk5hbWUgKyAnIiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgIicgKyByZWFsTmFtZSArICciLicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvYWQocGx1Z2luKTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMubG9hZCA9IGxvYWQ7CiAgICAvKn0qLyB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbG9nJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL2NvbmZpZycsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3RDb25maWdfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIC8qKgogICAgQSBiYXNpYyBsb2dnZXIgZm9yIHRoZSB0aHJ1c3QgZnJhbWV3b3JrLgogICAgRGlzYWJsZXMgZGVidWcgbG9nZ2luZyB3aGVuIHRocnVzdCBpcyBub3QgaW4gZGVidWcgbW9kZS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIAogICAgKiovCiAgICAKICAgIC8vIExvZyBsZXZlbHMKICAgIHZhciBMRVZFTCA9IHsKICAgICAgICBERUJVRzogNCwKICAgICAgICBJTkZPOiAzLAogICAgICAgIFdBUk46IDIsCiAgICAgICAgRVJST1I6IDEKICAgIH07CiAgICAvLyBEZWNsYXJlIG91ciB2YXJpYWJsZXMKICAgICAgICB2YXIgY29uc29sZSA9IHdpbmRvdy5jb25zb2xlLCB0aW1lcnMgPSB7CiAgICB9LCBjTG9nID0gKGNvbnNvbGUgJiYgY29uc29sZS5sb2cpIHx8IGZhbHNlLCBjV2FybiA9IChjb25zb2xlICYmIGNvbnNvbGUud2FybikgfHwgZmFsc2UsIGNJbmZvID0gKGNvbnNvbGUgJiYgY29uc29sZS5pbmZvKSB8fCBmYWxzZSwgY0Vycm9yID0gKGNvbnNvbGUgJiYgY29uc29sZS5lcnJvcikgfHwgZmFsc2UsIGNUaW1lID0gKGNvbnNvbGUgJiYgY29uc29sZVsndGltZSddKSB8fCBmYWxzZSwgY1RpbWVFbmQgPSAoY29uc29sZSAmJiBjb25zb2xlWyd0aW1lRW5kJ10pIHx8IGZhbHNlLCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgY29uZmlnTGV2ZWwgPSB0Q29uZmlnLmxvZy5sZXZlbCB8fCBMRVZFTC5FUlJPUiwgbG9nTGV2ZWwgPSBMRVZFTFtjb25maWdMZXZlbF0gfHwgKHR5cGVvZiBjb25maWdMZXZlbCA9PT0gJ3N0cmluZycgJiYgTEVWRUxbY29uZmlnTGV2ZWwudG9VcHBlckNhc2UoKV0pIHx8ICh0eXBlb2YgY29uZmlnTGV2ZWwgPT09ICdudW1iZXInICYmIGNvbmZpZ0xldmVsKSB8fCBMRVZFTC5FUlJPUjsKICAgIC8vIFZhcmlvdXMgbG9nZ2VycyB0byBoYW5kbGUgSUU4Lzkgc3VwcG9ydC4KICAgIHZhciBsb2dSdW5uZXIgPSBmdW5jdGlvbiAoY29uc29sZU1ldGhvZCwgbG9nVHlwZSkgewogICAgICAgIC8vIFNob3cgbG9ncyB3aGVuIGVuYWJsZWQgb3IgaWYgdGhleSBhcmUgZXJyb3JzCiAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgaWYoY29uc29sZU1ldGhvZCkgewogICAgICAgICAgICBpZihjb25zb2xlTWV0aG9kLmFwcGx5KSB7CiAgICAgICAgICAgICAgICBjb25zb2xlTWV0aG9kLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc29sZU1ldGhvZChhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZighY29uc29sZU1ldGhvZCAmJiBjTG9nKSB7CiAgICAgICAgICAgIGlmKGNMb2cuYXBwbHkpIHsKICAgICAgICAgICAgICAgIGNMb2cuYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjTG9nKGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIC8qKgogICAgQSBiYXNpYyBsb2dnZXIgZm9yIHRoZSB0aHJ1c3QgZnJhbWV3b3JrLgogICAgRGlzYWJsZXMgZGVidWcgbG9nZ2luZyB3aGVuIHRocnVzdCBpcyBub3QgaW4gZGVidWcgbW9kZS4KICAgIAogICAgQGNsYXNzIHRocnVzdC5Mb2cKICAgICoqLwogICAgLyoqCiAgICBMb2dzIGEgZGVidWcgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGxvZyBtZXRob2QKICAgIAogICAgQG1ldGhvZCBkZWJ1ZwogICAgKiovCiAgICBmdW5jdGlvbiBkZWJ1ZygpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDApOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjTG9nKTsKICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICdsb2cnKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmRlYnVnID0gZGVidWc7CiAgICAvKioKICAgIExvZ3MgYSBpbmZvIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSBpbmZvIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2QgaW5mbwogICAgKiovCiAgICBmdW5jdGlvbiBpbmZvKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5JTkZPKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY0luZm8pOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ2luZm8nKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmluZm8gPSBpbmZvOwogICAgLyoqCiAgICBMb2dzIGEgd2FybiB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgd2FybiBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgogICAgCiAgICBAbWV0aG9kIHdhcm4KICAgICoqLwogICAgZnVuY3Rpb24gd2FybigpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDApOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuV0FSTikgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGNXYXJuKTsKICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICd3YXJuJyk7CiAgICAgICAgfQogICAgfQogICAgZXhwb3J0cy53YXJuID0gd2FybjsKICAgIC8qKgogICAgTG9ncyBhIGVycm9yIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSBlcnJvciBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgogICAgCiAgICBAbWV0aG9kIGVycm9yCiAgICAqKi8KICAgIGZ1bmN0aW9uIGVycm9yKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5FUlJPUikgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGNFcnJvcik7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzLCAnZXJyb3InKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmVycm9yID0gZXJyb3I7CiAgICAvKioKICAgIExvZ3MgYSB0aW1lIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSB0aW1lIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2QgdGltZQogICAgKiovCiAgICBmdW5jdGlvbiB0aW1lKG1lc3NhZ2UpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpIHsKICAgICAgICAgICAgdGltZXJzW21lc3NhZ2VdID0gewogICAgICAgICAgICAgICAgc3RhcnQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBtc2cgPSB1dGlsLmZvcm1hdCgnezB9OiB0aW1lciBzdGFydGVkJywgbWVzc2FnZSksIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChtc2cpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY1RpbWUpOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQogICAgfQogICAgZXhwb3J0cy50aW1lID0gdGltZTsKICAgIC8qKgogICAgTG9ncyBhIHRpbWVFbmQgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIHRpbWVFbmQgbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KICAgIENhdXNlcyB0aGUgdGltZXIgdG8gZW5kLCBmb3IgdGhlIGdpdmVuIG1lc3NhZ2UuCiAgICAKICAgIEBtZXRob2QgdGltZUVuZAogICAgKiovCiAgICBmdW5jdGlvbiB0aW1lRW5kKG1lc3NhZ2UpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpIHsKICAgICAgICAgICAgdGltZXJzW21lc3NhZ2VdLmVuZCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CiAgICAgICAgICAgIHZhciB0aW1lID0gdGltZXJzW21lc3NhZ2VdLmVuZCAtIHRpbWVyc1ttZXNzYWdlXS5zdGFydCwgbXNnID0gdXRpbC5mb3JtYXQoJ3swfTogezF9bXMnLCBtZXNzYWdlLCB0aW1lKTsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChtc2cpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY1RpbWVFbmQpOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQogICAgfQogICAgZXhwb3J0cy50aW1lRW5kID0gdGltZUVuZDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bG9nLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2lnbml0ZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnbW9kdWxlJywgJ3RocnVzdC91dGlsJywgJy4vY29uZmlnJywgJy4vY2Fwc3VsZScsICcuL2luc3RhbmNlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fcmVxdWlyZU1vZHVsZV9fLCBfX3V0aWxfXywgX19jb25maWdfXywgX190bV9fLCBfX2luc3RhbmNlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHJlcXVpcmVNb2R1bGUgPSBfX3JlcXVpcmVNb2R1bGVfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICB2YXIgdG0gPSBfX3RtX187CgogICAgdmFyIGluc3RhbmNlID0gX19pbnN0YW5jZV9fOwoKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgaXNBcnJheSA9IF8uaXNBcnJheSwgdG9BcnJheSA9IF8udG9BcnJheSwgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgZWFjaCA9IF8uZWFjaCwgbWFwID0gXy5tYXAsIGFueSA9IF8uYW55LCBhbGwgPSBfLmFsbCwgd2hlbiA9IHV0aWwud2hlbiwgZXh0ZW5kID0gXy5leHRlbmQsIGZsYXR0ZW4gPSBfLmZsYXR0ZW4sIHBsdWNrID0gXy5wbHVjaywgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBrZXlzID0gXy5rZXlzLCB1bmlvbiA9IF8udW5pb247CiAgICAvKmZ1bmN0aW9uIHJlY29uY2lsZUFycmF5cyhjb25maWcsIHNldHRpbmdzLCB0bykKICAgIHsKICAgIHZhciBrZXlzID0gXy5rZXlzKGNvbmZpZyk7CiAgICBpZiAoc2V0dGluZ3MpCiAgICB7CiAgICBrZXlzID0gdW5pb24oXy5rZXlzKHNldHRpbmdzKSwga2V5cyk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICBzZXR0aW5ncyA9IHt9OwogICAgfQogICAgZWFjaChrZXlzLCBmdW5jdGlvbiAoaSkKICAgIHsKICAgIHZhciB4ID0gc2V0dGluZ3NbaV0gfHwgY29uZmlnW2ldOwogICAgaWYgKGlzQXJyYXkoeCkpCiAgICB7CiAgICB0b1tpXSA9IHRvQXJyYXkoc2V0dGluZ3NbaV0gfHwgdG9baV0pOwogICAgfQogICAgZWxzZSBpZiAoaXNPYmplY3QoeCkgJiYgIWlzRnVuY3Rpb24oeCkpCiAgICB7CiAgICByZWNvbmNpbGVBcnJheXMoeCwgbnVsbCwgdG9baV0pOwogICAgfQogICAgfSk7CiAgICB9Ki8KICAgIGZ1bmN0aW9uIG1lcmdlU2V0dGluZ3Moc2V0dGluZ3MpIHsKICAgICAgICBpZigoc2V0dGluZ3MpLl9fc2V0dGluZ3NNZXJnZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHNldHRpbmdzOwogICAgICAgIH0KICAgICAgICB2YXIgcmVxdWlyZUNvbmZpZyA9IHJlcXVpcmVNb2R1bGUuY29uZmlnKCksIHBsdWdpbnMgPSBbCiAgICAgICAgICAgICd0aHJ1c3QvbWVkaWF0b3InCiAgICAgICAgXS5jb25jYXQoc2V0dGluZ3MucGx1Z2lucyB8fCByZXF1aXJlQ29uZmlnLnBsdWdpbnMgfHwgY29uZmlnLnBsdWdpbnMgfHwgW10pLCBjb252ZW50aW9ucyA9IFtdLmNvbmNhdChzZXR0aW5ncy5jb252ZW50aW9ucyB8fCByZXF1aXJlTW9kdWxlLmNvbmZpZygpLmNvbnZlbnRpb25zIHx8IGNvbmZpZy5wbHVnaW5zIHx8IFtdKTsKICAgICAgICBzZXR0aW5ncyA9IF8ubWVyZ2UoewogICAgICAgIH0sIGNvbmZpZywgcmVxdWlyZU1vZHVsZS5jb25maWcoKSwgc2V0dGluZ3MsIHsKICAgICAgICAgICAgX19zZXR0aW5nc01lcmdlZDogdHJ1ZSwKICAgICAgICAgICAgcGx1Z2luczogcGx1Z2lucywKICAgICAgICAgICAgY29udmVudGlvbnM6IGNvbnZlbnRpb25zCiAgICAgICAgfSk7CiAgICAgICAgc2V0dGluZ3MucGx1Z2lucyA9IHBsdWdpbnM7CiAgICAgICAgc2V0dGluZ3MuY29udmVudGlvbnMgPSBjb252ZW50aW9uczsKICAgICAgICByZXR1cm4gc2V0dGluZ3M7CiAgICB9CiAgICBleHBvcnRzLm1lcmdlU2V0dGluZ3MgPSBtZXJnZVNldHRpbmdzOwogICAgZnVuY3Rpb24gZnVzZShzZXR0aW5ncykgewogICAgICAgIHZhciBwaXBlID0gW107CiAgICAgICAgc2V0dGluZ3MgPSBtZXJnZVNldHRpbmdzKHNldHRpbmdzKTsKICAgICAgICBpZighaW5zdGFuY2UuaW5zdGFuY2VzW3NldHRpbmdzLm5hbWVdKSB7CiAgICAgICAgICAgIHBpcGUucHVzaChzdGFnZU9uZSk7CiAgICAgICAgfQogICAgICAgIHBpcGUucHVzaChzdGFnZVR3byk7CiAgICAgICAgaWYoc2V0dGluZ3MubW9kdWxlcyAmJiBzZXR0aW5ncy5tb2R1bGVzLmxlbmd0aCkgewogICAgICAgICAgICBwaXBlLnB1c2goc3RhZ2VUaHJlZSk7CiAgICAgICAgfQogICAgICAgIHZhciBwcm9taXNlID0gd2hlbi5waXBlbGluZShwaXBlLCBzZXR0aW5ncyk7CiAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9CiAgICBleHBvcnRzLmZ1c2UgPSBmdXNlOwogICAgLyoqCiAgICBDb250cnVjdHMgYSB3aXJlIHNwZWMgZm9yIHRocnVzdCB0byBsYXVuY2ggZnJvbS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgLyoqCiAgICBNZXJnZXMgYSBhbGwgdGhlIHBsdWdpbnMgY29uZmlndXJhdGlvbnMsIHdpdGggdGhlIGRlZmF1bHQgY29uZmlnLCBhbmQgdGhlbiBmaW5hbGx5IHdpdGgKICAgIGFueSBjdXN0b21pemVkIGNvbmZpZyBmcm9tIHJlcXVpcmVqcwogICAgCiAgICBAbWV0aG9kIHN0YWdlT25lCiAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbnRzIHRvIHBhc3Mgb250byB0aGUgdGhydXN0IGluc3RhbmNlIGJlaW5nIGNyZWF0ZWQuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHN0YWdlT25lKHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICAgICAgICAgIHZhciBwbHVnaW5zID0gc2V0dGluZ3MucGx1Z2lucywgcmVxdWlyZUNvbmZpZyA9IHJlcXVpcmVNb2R1bGUuY29uZmlnKCksIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgIHNldHRpbmdzLnBsdWdpbnMgPSBwbHVnaW5zOwogICAgICAgIHJlcXVpcmUocGx1Z2lucy5tYXAoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuIHg7CiAgICAgICAgfSksIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICAgIHBsdWdpbnMuZm9yRWFjaChmdW5jdGlvbiAocGx1Z2luLCBpKSB7CiAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxKSwgcGx1Z2luU2V0dGluZ3MgPSBzZXR0aW5nc1tuYW1lXSB8fCB7CiAgICAgICAgICAgICAgICB9LCBwbHVnaW5SZXF1aXJlQ29uZmlnID0gcmVxdWlyZUNvbmZpZ1tuYW1lXSB8fCB7CiAgICAgICAgICAgICAgICB9LCBwbHVnaW5DbGFzcyA9IGFyZ3NbaV1bYXJnc1tpXS5jbGFzc05hbWVdOwogICAgICAgICAgICAgICAgaWYoIWNvbmZpZ1tuYW1lXSkgewogICAgICAgICAgICAgICAgICAgIGNvbmZpZ1tuYW1lXSA9IF8ubWVyZ2UocGx1Z2luQ2xhc3MuY29uZmlnLCBwbHVnaW5SZXF1aXJlQ29uZmlnIHx8IHsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjb252ZW50aW9ucyA9IFtdLmNvbmNhdChwbHVnaW5TZXR0aW5ncy5jb252ZW50aW9ucyB8fCBwbHVnaW5SZXF1aXJlQ29uZmlnLmNvbnZlbnRpb25zIHx8IGNvbmZpZ1tuYW1lXS5jb252ZW50aW9ucyB8fCBbXSk7CiAgICAgICAgICAgICAgICBzZXR0aW5nc1tuYW1lXSA9IF8ubWVyZ2UoewogICAgICAgICAgICAgICAgfSwgY29uZmlnW25hbWVdLCBwbHVnaW5TZXR0aW5ncyB8fCB7CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgY29udmVudGlvbnM6IGNvbnZlbnRpb25zCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHNldHRpbmdzW25hbWVdLmNvbnZlbnRpb25zID0gY29udmVudGlvbnM7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkZWZlci5yZXNvbHZlKHNldHRpbmdzKTsKICAgICAgICB9LCBkZWZlci5yZWplY3QpOwogICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgfQogICAgZXhwb3J0cy5zdGFnZU9uZSA9IHN0YWdlT25lOwogICAgLyoqCiAgICBDcmVhdGVzIGEgdGhydXN0IGluc3RhbmNlLCBmcm9tIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgIEluY2x1ZGluZyB0aGUgcGx1Z2lucy4KICAgIAogICAgQG1ldGhvZCBzdGFnZVR3bwogICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW50cyB0byBwYXNzIG9udG8gdGhlIHRocnVzdCBpbnN0YW5jZSBiZWluZyBjcmVhdGVkLgogICAgKiovCiAgICBmdW5jdGlvbiBzdGFnZVR3byhzZXR0aW5ncykgewogICAgICAgIC8qanNoaW50IGxvb3BmdW5jOnRydWUgKi8KICAgICAgICAvLyBHZXQgdGhlIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgIHZhciBsb2NhbENvbmZpZyA9IHNldHRpbmdzLCBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAvLyBNZWRpYXRvciBpcyBhIHJlcXVpcmVkIHBsdWdpbiwgaW5jbHVkZSBhbGwgdGhlIG90aGVycyBpbiBhZGRpdGlvbiB0byBpdC4KICAgICAgICAgICAgICAgIHZhciBwbHVnaW5zID0gbG9jYWxDb25maWcucGx1Z2lucywgbW9kdWxlc1RvTG9hZCA9IC8vIFRoZSBtb2R1bGVzIHRvIGxvYWQKICAgICAgICBbXSwgdGhydXN0Q29udmVudGlvbnMgPSBzZXR0aW5ncy5jb252ZW50aW9ucyB8fCBbXSwgbW9kdWxlc0NvbmZpZ3VyYXRpb25zID0gLy8gVGhlIG1vZHVsZSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgIHsKICAgICAgICAgICAgdGhydXN0OiAndGhydXN0JwogICAgICAgIH07CiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGx1Z2lucywgY3JlYXRpbmcgYSBwcm9wZXIgZGVwZW5kYW5jeSBsaXN0LgogICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBwbHVnaW5zLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICB2YXIgcGx1Z2luID0gcGx1Z2luc1tpXSwgbmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxKSwgcGx1Z2luQ29uZmlnID0gbG9jYWxDb25maWdbbmFtZV07CiAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaChwbHVnaW4pOwogICAgICAgICAgICBtb2R1bGVzVG9Mb2FkLnB1c2gocGx1Z2luQ29uZmlnICYmIHBsdWdpbkNvbmZpZy5jb252ZW50aW9ucyB8fCBbXSk7CiAgICAgICAgICAgIG1vZHVsZXNDb25maWd1cmF0aW9uc1twbHVnaW5dID0gcGx1Z2luQ29uZmlnOwogICAgICAgIH0KICAgICAgICAvLyBOYW1lIGFuZCBjZmcgYXJlIGRlZmF1bHQgcHJvcGVydGllcyBvZiB0aGUgY29uZmlndXJhdGlvbiBjb250ZXh0CiAgICAgICAgICAgICAgICB2YXIgb3JkZXJlZFBsdWdpbnMgPSBbCiAgICAgICAgICAgICduYW1lJywgCiAgICAgICAgICAgICdjZmcnCiAgICAgICAgXSwgcmVsb29wID0gLy8gV2UgbG9vcCB0aHJvdWdoIHVudGlsIGFsbCB0aGUgcGx1Z2lucyBhcmUgaW4gcHJvcGVyIG9yZGVyLgogICAgICAgIHRydWUsIGlMZW4gPSBtb2R1bGVzVG9Mb2FkLmxlbmd0aCwgaSA9IDA7CiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGx1Z2lucyB1bnRpbCB3ZSBoYXZlIGEgc2V0IHRoYXQgd2lsbCBsb2FkIGluIHByb3BlciBvcmRlci4KICAgICAgICB3aGlsZShpIDwgaUxlbikgewogICAgICAgICAgICAvLyBUaGUgcGx1Z2luCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwbHVnaW4gPSBtb2R1bGVzVG9Mb2FkW2ldLCBuYW1lID0gLy8gVGhlIGltcGxpZWQgcGx1Z2luIG5hbWUKICAgICAgICAgICAgcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCBwbHVnaW5Db25maWcgPSAvLyBUaGUgcGx1Z2lucyBjb25maWd1cmF0aW9uCiAgICAgICAgICAgIGxvY2FsQ29uZmlnW25hbWVdOwogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgcGx1Z2luIGhhcyB0byByZXNvbHZlIGFueSBvdGhlciBwbHVnaW5zCiAgICAgICAgICAgIGlmKHBsdWdpbkNvbmZpZyAmJiBwbHVnaW5Db25maWcucmVzb2x2ZSAmJiBwbHVnaW5Db25maWcucmVzb2x2ZS5sZW5ndGggPiAwICYmICFhbGwocGx1Z2luQ29uZmlnLnJlc29sdmUsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYW55KG9yZGVyZWRQbHVnaW5zLCBmdW5jdGlvbiAoeikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB4ID09PSB6IHx8IHggPT09IHo7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkpIHsKICAgICAgICAgICAgICAgIC8vIFRoZSBtb2R1bGVzIHRvIGxvYWQuCiAgICAgICAgICAgICAgICAvLyBBbHNvIGluY2x1ZGVzIGFueSBjb252ZW50aW9ucy4KICAgICAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaC5hcHBseShtb2R1bGVzVG9Mb2FkLCBtb2R1bGVzVG9Mb2FkLnNwbGljZShpLCAyKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyByZW9yZGVyIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgICAgICAgIG9yZGVyZWRQbHVnaW5zLnB1c2gobmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gVGhlIG1vZHVsZXMgY29uZmlnCiAgICAgICAgdmFyIG1vZHVsZXMgPSBsb2NhbENvbmZpZy5tb2R1bGVzIHx8IFtdOwogICAgICAgIC8vIFRocnVzdCBhbmQgdGhydXN0L2NhcHN1bGUgYWxzbyBuZWVkIHRvIGJlIGxvYWRlZC4KICAgICAgICBtb2R1bGVzVG9Mb2FkLnB1c2guYXBwbHkobW9kdWxlc1RvTG9hZCwgWwogICAgICAgICAgICAndGhydXN0JywgCiAgICAgICAgICAgIHNldHRpbmdzLmNvbnZlbnRpb25zIHx8IFtdCiAgICAgICAgXSk7CiAgICAgICAgLy8gRmxhdHRlbiB0aGUgcmVzdWx0YW50IGFycmF5CiAgICAgICAgbW9kdWxlc1RvTG9hZCA9IGZsYXR0ZW4obW9kdWxlc1RvTG9hZCk7CiAgICAgICAgLy8gQ3JlYXRlIHRoZSBjb25maWd1cmF0aW9uIHNwZWMKICAgICAgICB2YXIgc3BlYyA9IHsKICAgICAgICAgICAgbmFtZTogbG9jYWxDb25maWcubmFtZSB8fCAnZ2xvYmFsJywKICAgICAgICAgICAgY2ZnOiBsb2NhbENvbmZpZwogICAgICAgIH07CiAgICAgICAgLy8gTG9hZCBldmVyeXRoaW5nCiAgICAgICAgcmVxdWlyZShtb2R1bGVzVG9Mb2FkLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDApOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEdldCByZWFkeSB0byBsb29wCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50UGx1Z2luID0gbnVsbCwgYWxsQ29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgbW9kdWxlcyBiZWluZyBsb2FkZWQKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG1vZHVsZXNUb0xvYWQubGVuZ3RoOyBpIDwgaUxlbiAtIHRocnVzdENvbnZlbnRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgcGx1Z2luIGFuZCBjb25maWd1cmF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbiA9IG1vZHVsZXNUb0xvYWRbaV0sIG1Db25maWcgPSBtb2R1bGVzQ29uZmlndXJhdGlvbnNbcGx1Z2luXTsKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHdlIGhhdmUgYSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgaWYobUNvbmZpZykgewogICAgICAgICAgICAgICAgICAgIC8vIExvYWQgYSBuZXcgcGx1Z2luLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbk9iamVjdCA9IGFyZ3NbaV0sIG5hbWUgPSAvLyBHZXQgdGhlIHBsdWdpbiBuYW1lCiAgICAgICAgICAgICAgICAgICAgcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCByZXNvbHZlSXRlbXMgPSAvLyBSZXNvbHZlIGFsbCB0aGUgcmVxdWlyZWQgaXRlbXMuCiAgICAgICAgICAgICAgICAgICAgbWFwKG1Db25maWcucmVzb2x2ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNwZWNbeF07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbkNsYXNzID0gcGx1Z2luT2JqZWN0W3BsdWdpbk9iamVjdC5jbGFzc05hbWVdOwogICAgICAgICAgICAgICAgICAgIC8vIEluc3RhbnRpYXRlIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGx1Z2luID0gc3BlY1tuYW1lXSA9IHV0aWwuaW5zdGFudGlhdGUocGx1Z2luQ2xhc3MsIHJlc29sdmVJdGVtcyk7CiAgICAgICAgICAgICAgICAgICAgLy8gU2V0dXAgdGhlIGNvbnZlbnRpb25zCiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBsdWdpbi5fX2NvbnZlbnRpb25zID0gW107CiAgICAgICAgICAgICAgICB9IGVsc2UgLy8gTG9hZCBhbGwgdGhlIGNvbnZlbnRpb25zCiAgICAgICAgICAgICAgICBpZihjdXJyZW50UGx1Z2luKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCB0aGUgY29udmVudGlvbnMgaW50byB0aGUgcGx1Z2luCiAgICAgICAgICAgICAgICAgICAgXy5mb3JPd24oYXJnc1tpXSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRQbHVnaW4uX19jb252ZW50aW9ucy5wdXNoKHgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIC8vIExvYWQgdGhlIGNvbnZlbnRpb25zIGludG8gdGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICAgICAgICAgICAgICBfLmZvck93bihhcmdzW2ldLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWxsQ29udmVudGlvbnMucHVzaCh4KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBUaGUgbGFzdCBjdXJyZW50IHBsdWdpbiwgd2lsbCBhbHdheXMgYmUgdGhydXN0LgogICAgICAgICAgICBjdXJyZW50UGx1Z2luLl9fY29udmVudGlvbnMgPSBhbGxDb252ZW50aW9uczsKICAgICAgICAgICAgdmFyIHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucyA9IGFyZ3Muc2xpY2UobW9kdWxlc1RvTG9hZC5sZW5ndGggLSB0aHJ1c3RDb252ZW50aW9ucy5sZW5ndGgpOwogICAgICAgICAgICB0aHJ1c3RDb252ZW50aW9uRGVmaW5pdGlvbnMgPSBmbGF0dGVuKG1hcCh0aHJ1c3RDb252ZW50aW9uRGVmaW5pdGlvbnMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWFwKHgsIGZ1bmN0aW9uICh6KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHo7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkpOwogICAgICAgICAgICBjdXJyZW50UGx1Z2luLl9fdGhydXN0Q29udmVudGlvbnMgPSB0aHJ1c3RDb252ZW50aW9uRGVmaW5pdGlvbnM7CiAgICAgICAgICAgIGFsbENvbnZlbnRpb25zLnB1c2guYXBwbHkoYWxsQ29udmVudGlvbnMsIHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucyk7CiAgICAgICAgICAgIC8vIEV4dGVuZCB0aHJ1c3Qgd2l0aCB0aGUgc3BlYwogICAgICAgICAgICBleHRlbmQoY3VycmVudFBsdWdpbiwgc3BlYyk7CiAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoc3BlYyk7CiAgICAgICAgfSwgZGVmZXIucmVqZWN0KTsKICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTsKICAgIH0KICAgIGV4cG9ydHMuc3RhZ2VUd28gPSBzdGFnZVR3bzsKICAgIC8qKgogICAgTG9hZHMgdXAgdGhlIGRlZmF1bHQgbW9kdWxlcyBhcyBpbmRpY2F0ZWQgdG8gdGhydXN0LgogICAgCiAgICBAbWV0aG9kIHN0YWdlVGhyZWUKICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIHVzZSB0byBsb2FkIHRoZSBtb2R1bGVzLgogICAgKiovCiAgICBmdW5jdGlvbiBzdGFnZVRocmVlKGNvbnRleHQpIHsKICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3QsIGRlZmVyID0gd2hlbi5kZWZlcigpLCBtb2R1bGVzID0gY29udGV4dC5jZmcubW9kdWxlczsKICAgICAgICBtb2R1bGVzID0gXy5maWx0ZXIobW9kdWxlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuICF0aHJ1c3QubW9kdWxlc1t4XTsKICAgICAgICB9KTsKICAgICAgICByZXF1aXJlKG1vZHVsZXMsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIE1vZHVsZSA9IHRtLk1vZHVsZTsKICAgICAgICAgICAgLy8gR2V0IHRoZSBkZWZpbml0aW9ucwogICAgICAgICAgICB2YXIgbW9kdWxlRGVmaW5pdGlvbnMgPSBhcmdzOwogICAgICAgICAgICAvLyBMb29wIG92ZXIgYWxsIHRoZSBtb2R1bGVzCiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBtb2R1bGVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgLy8gR2V0IHRoZSBtb2R1bGUgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2QgPSBtb2R1bGVzW2ldLCBkZWZpbml0aW9uID0gLy8gR2V0IHRoZSBkZWZpbml0aW9uCiAgICAgICAgICAgICAgICBtb2R1bGVEZWZpbml0aW9uc1tpXTsKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSB0aGUgaW5zdGFuY2UKICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IG5ldyBNb2R1bGUodGhydXN0LCBkZWZpbml0aW9uLCBtb2QpOwogICAgICAgICAgICAgICAgLy8gSW5qZWN0IGl0IGludG8gdGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgICAgICAgICAgbW9kdWxlSW5zdGFuY2UudGhydXN0Q3JlYXRlKHRocnVzdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmZXIucmVzb2x2ZShjb250ZXh0KTsKICAgICAgICB9LCBkZWZlci5yZWplY3QpOwogICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgfQogICAgZXhwb3J0cy5zdGFnZVRocmVlID0gc3RhZ2VUaHJlZTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9aWduaXRlLmpzLm1hcAo7Ci8qKgogKiBAbGljZW5zZSBSZXF1aXJlSlMgZG9tUmVhZHkgMi4wLjEgQ29weXJpZ2h0IChjKSAyMDEwLTIwMTIsIFRoZSBEb2pvIEZvdW5kYXRpb24gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICogQXZhaWxhYmxlIHZpYSB0aGUgTUlUIG9yIG5ldyBCU0QgbGljZW5zZS4KICogc2VlOiBodHRwOi8vZ2l0aHViLmNvbS9yZXF1aXJlanMvZG9tUmVhZHkgZm9yIGRldGFpbHMKICovCi8qanNsaW50ICovCi8qZ2xvYmFsIHJlcXVpcmU6IGZhbHNlLCBkZWZpbmU6IGZhbHNlLCByZXF1aXJlanM6IGZhbHNlLAogIHdpbmRvdzogZmFsc2UsIGNsZWFySW50ZXJ2YWw6IGZhbHNlLCBkb2N1bWVudDogZmFsc2UsCiAgc2VsZjogZmFsc2UsIHNldEludGVydmFsOiBmYWxzZSAqLwoKCmRlZmluZSgnZG9tUmVhZHknLFtdLGZ1bmN0aW9uICgpIHsKICAgIAoKICAgIHZhciBpc1RvcCwgdGVzdERpdiwgc2Nyb2xsSW50ZXJ2YWxJZCwKICAgICAgICBpc0Jyb3dzZXIgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuZG9jdW1lbnQsCiAgICAgICAgaXNQYWdlTG9hZGVkID0gIWlzQnJvd3NlciwKICAgICAgICBkb2MgPSBpc0Jyb3dzZXIgPyBkb2N1bWVudCA6IG51bGwsCiAgICAgICAgcmVhZHlDYWxscyA9IFtdOwoKICAgIGZ1bmN0aW9uIHJ1bkNhbGxiYWNrcyhjYWxsYmFja3MpIHsKICAgICAgICB2YXIgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY2FsbGJhY2tzLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgIGNhbGxiYWNrc1tpXShkb2MpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjYWxsUmVhZHkoKSB7CiAgICAgICAgdmFyIGNhbGxiYWNrcyA9IHJlYWR5Q2FsbHM7CgogICAgICAgIGlmIChpc1BhZ2VMb2FkZWQpIHsKICAgICAgICAgICAgLy9DYWxsIHRoZSBET00gcmVhZHkgY2FsbGJhY2tzCiAgICAgICAgICAgIGlmIChjYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZWFkeUNhbGxzID0gW107CiAgICAgICAgICAgICAgICBydW5DYWxsYmFja3MoY2FsbGJhY2tzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNldHMgdGhlIHBhZ2UgYXMgbG9hZGVkLgogICAgICovCiAgICBmdW5jdGlvbiBwYWdlTG9hZGVkKCkgewogICAgICAgIGlmICghaXNQYWdlTG9hZGVkKSB7CiAgICAgICAgICAgIGlzUGFnZUxvYWRlZCA9IHRydWU7CiAgICAgICAgICAgIGlmIChzY3JvbGxJbnRlcnZhbElkKSB7CiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHNjcm9sbEludGVydmFsSWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjYWxsUmVhZHkoKTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKGlzQnJvd3NlcikgewogICAgICAgIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgIC8vU3RhbmRhcmRzLiBIb29yYXkhIEFzc3VtcHRpb24gaGVyZSB0aGF0IGlmIHN0YW5kYXJkcyBiYXNlZCwKICAgICAgICAgICAgLy9pdCBrbm93cyBhYm91dCBET01Db250ZW50TG9hZGVkLgogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgcGFnZUxvYWRlZCwgZmFsc2UpOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibG9hZCIsIHBhZ2VMb2FkZWQsIGZhbHNlKTsKICAgICAgICB9IGVsc2UgaWYgKHdpbmRvdy5hdHRhY2hFdmVudCkgewogICAgICAgICAgICB3aW5kb3cuYXR0YWNoRXZlbnQoIm9ubG9hZCIsIHBhZ2VMb2FkZWQpOwoKICAgICAgICAgICAgdGVzdERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaXNUb3AgPSB3aW5kb3cuZnJhbWVFbGVtZW50ID09PSBudWxsOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7fQoKICAgICAgICAgICAgLy9ET01Db250ZW50TG9hZGVkIGFwcHJveGltYXRpb24gdGhhdCB1c2VzIGEgZG9TY3JvbGwsIGFzIGZvdW5kIGJ5CiAgICAgICAgICAgIC8vRGllZ28gUGVyaW5pOiBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLywKICAgICAgICAgICAgLy9idXQgbW9kaWZpZWQgYnkgb3RoZXIgY29udHJpYnV0b3JzLCBpbmNsdWRpbmcgamRhbHRvbgogICAgICAgICAgICBpZiAodGVzdERpdi5kb1Njcm9sbCAmJiBpc1RvcCAmJiB3aW5kb3cuZXh0ZXJuYWwpIHsKICAgICAgICAgICAgICAgIHNjcm9sbEludGVydmFsSWQgPSBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGVzdERpdi5kb1Njcm9sbCgpOwogICAgICAgICAgICAgICAgICAgICAgICBwYWdlTG9hZGVkKCk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgICAgIH0sIDMwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy9DaGVjayBpZiBkb2N1bWVudCBhbHJlYWR5IGNvbXBsZXRlLCBhbmQgaWYgc28sIGp1c3QgdHJpZ2dlciBwYWdlIGxvYWQKICAgICAgICAvL2xpc3RlbmVycy4gTGF0ZXN0IHdlYmtpdCBicm93c2VycyBhbHNvIHVzZSAiaW50ZXJhY3RpdmUiLCBhbmQKICAgICAgICAvL3dpbGwgZmlyZSB0aGUgb25ET01Db250ZW50TG9hZGVkIGJlZm9yZSAiaW50ZXJhY3RpdmUiIGJ1dCBub3QgYWZ0ZXIKICAgICAgICAvL2VudGVyaW5nICJpbnRlcmFjdGl2ZSIgb3IgImNvbXBsZXRlIi4gTW9yZSBkZXRhaWxzOgogICAgICAgIC8vaHR0cDovL2Rldi53My5vcmcvaHRtbDUvc3BlYy90aGUtZW5kLmh0bWwjdGhlLWVuZAogICAgICAgIC8vaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zNjY1NTYxL2RvY3VtZW50LXJlYWR5c3RhdGUtb2YtaW50ZXJhY3RpdmUtdnMtb25kb21jb250ZW50bG9hZGVkCiAgICAgICAgLy9IbW0sIHRoaXMgaXMgbW9yZSBjb21wbGljYXRlZCBvbiBmdXJ0aGVyIHVzZSwgc2VlICJmaXJpbmcgdG9vIGVhcmx5IgogICAgICAgIC8vYnVnOiBodHRwczovL2dpdGh1Yi5jb20vcmVxdWlyZWpzL2RvbVJlYWR5L2lzc3Vlcy8xCiAgICAgICAgLy9zbyByZW1vdmluZyB0aGUgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImludGVyYWN0aXZlIiB0ZXN0LgogICAgICAgIC8vVGhlcmUgaXMgc3RpbGwgYSB3aW5kb3cub25sb2FkIGJpbmRpbmcgdGhhdCBzaG91bGQgZ2V0IGZpcmVkIGlmCiAgICAgICAgLy9ET01Db250ZW50TG9hZGVkIGlzIG1pc3NlZC4KICAgICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIikgewogICAgICAgICAgICBwYWdlTG9hZGVkKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKiBTVEFSVCBPRiBQVUJMSUMgQVBJICoqLwoKICAgIC8qKgogICAgICogUmVnaXN0ZXJzIGEgY2FsbGJhY2sgZm9yIERPTSByZWFkeS4gSWYgRE9NIGlzIGFscmVhZHkgcmVhZHksIHRoZQogICAgICogY2FsbGJhY2sgaXMgY2FsbGVkIGltbWVkaWF0ZWx5LgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICAgICAqLwogICAgZnVuY3Rpb24gZG9tUmVhZHkoY2FsbGJhY2spIHsKICAgICAgICBpZiAoaXNQYWdlTG9hZGVkKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKGRvYyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVhZHlDYWxscy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRvbVJlYWR5OwogICAgfQoKICAgIGRvbVJlYWR5LnZlcnNpb24gPSAnMi4wLjEnOwoKICAgIC8qKgogICAgICogTG9hZGVyIFBsdWdpbiBBUEkgbWV0aG9kCiAgICAgKi8KICAgIGRvbVJlYWR5LmxvYWQgPSBmdW5jdGlvbiAobmFtZSwgcmVxLCBvbkxvYWQsIGNvbmZpZykgewogICAgICAgIGlmIChjb25maWcuaXNCdWlsZCkgewogICAgICAgICAgICBvbkxvYWQobnVsbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZG9tUmVhZHkob25Mb2FkKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKiBFTkQgT0YgUFVCTElDIEFQSSAqKi8KCiAgICByZXR1cm4gZG9tUmVhZHk7Cn0pOwoKZGVmaW5lKCd0aHJ1c3QvbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAnLi9sb2cnLCAnLi9pbnN0YW5jZScsICcuL2lnbml0ZScsICcuL2NhcHN1bGUnLCAnZG9tUmVhZHknLCAnaGFzJywgJ3RocnVzdC9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fbG9nX18sIF9fdGhydXN0SW5zdGFuY2VfXywgX19pZ25pdGVTcGVjX18sIF9fbV9fLCBfX2RvbVJlYWR5X18sIF9faGFzX18sIF9fdENvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciB0aHJ1c3RJbnN0YW5jZSA9IF9fdGhydXN0SW5zdGFuY2VfXzsKCiAgICB2YXIgaWduaXRlU3BlYyA9IF9faWduaXRlU3BlY19fOwoKICAgIHZhciBtID0gX19tX187CgogICAgdmFyIE1vZHVsZSA9IG0uTW9kdWxlOwogICAgdmFyIGRvbVJlYWR5ID0gX19kb21SZWFkeV9fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciB0Q29uZmlnID0gX190Q29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnVGhydXN0JzsKICAgIC8qKgogICAgVGhlIHRocnVzdCBhcHBsaWNhdGlvbiEKICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBtYWluIHRocnVzdAogICAgKiovCiAgICAgICAgdmFyIElOSVQgPSAnaW5pdCcsIFNUQVJUID0gJ3N0YXJ0JywgUkVBRFkgPSAncmVhZHknLCBTVE9QID0gJ3N0b3AnLCBERVNUUk9ZID0gJ2Rlc3Ryb3knLCBDT1VOVERPV04gPSAnY291bnRkb3duJywgSUdOSVRFID0gJ2lnbml0ZScsIE9SQklUID0gJ29yYml0JywgREVQTE9ZID0gJ2RlcGxveScsIERFT1JCSVQgPSAnZGVvcmJpdCcsIFNQTEFTSERPV04gPSAnc3BsYXNoZG93bicsIElOT1JCSVQgPSAnaW5PcmJpdCcsIG1lbW9pemUgPSBfLm1lbW9pemUsIGVhY2ggPSBfLmVhY2gsIG1hcCA9IF8ubWFwLCBleHRlbmQgPSBfLmV4dGVuZCwgd2hlbiA9IHV0aWwud2hlbiwgYmluZCA9IF8uYmluZCwgaXNBcnJheSA9IF8uaXNBcnJheSwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIHRvQXJyYXkgPSBfLnRvQXJyYXksIG1lcmdlID0gXy5tZXJnZSwgZmxhdHRlbiA9IF8uZmxhdHRlbiwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIHJlc29sdmVNZXRob2RzID0gWwogICAgICAgIElOSVQsIAogICAgICAgIFNUQVJULCAKICAgICAgICBSRUFEWSwgCiAgICAgICAgU1RPUCwgCiAgICAgICAgREVTVFJPWQogICAgXSwgaW5zdGFuY2VzID0gdGhydXN0SW5zdGFuY2UuaW5zdGFuY2VzLCBsb2FkaW5nSW5zdGFuY2VzID0gdGhydXN0SW5zdGFuY2UubG9hZGluZ0luc3RhbmNlcywgc2FmZUludm9rZSA9IHV0aWwuc2FmZUludm9rZTsKICAgIC8vI3JlZ2lvbiBSdW5uZXIgRmFjdG9yaWVzCiAgICB2YXIgcnVuUnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHZhciBjb252ZW50aW9uTWV0aG9kID0gKG1ldGhvZCA9PT0gU1RPUCAmJiBTVEFSVCkgfHwgKG1ldGhvZCA9PT0gREVTVFJPWSAmJiBJTklUKSB8fCBtZXRob2QsIGNvbnZlbnRpb25WYWx1ZSA9ICEobWV0aG9kID09PSBTVE9QIHx8IG1ldGhvZCA9PT0gREVTVFJPWSksIHVuc2V0UmVhZHkgPSBtZXRob2QgPT09IFNUT1AsIGNvbnZlbnRpb25DaGVjayA9IGNvbnZlbnRpb25NZXRob2QgIT09IG1ldGhvZCwgY29udmVudGlvbk5hbWUgPSBmb3JtYXQoJ3swfS1zdGF0dXMnLCBjb252ZW50aW9uTWV0aG9kKSwgcnVubmVyID0gcnVubmVyRmFjdG9yeShtZXRob2QsIGNvbnZlbnRpb25OYW1lLCBjb252ZW50aW9uVmFsdWUsIHVuc2V0UmVhZHkpLCBsb2dNZXNzYWdlID0gZm9ybWF0KCdUaHJ1c3Q6IHswfWluZyBtb2R1bGUgInt7MH19IiBmYWlsZWQhJywgbWV0aG9kKSwgcnVubmluZ01lc3NhZ2UgPSBmb3JtYXQoJ1RocnVzdDogUnVubmluZyB7MH0gZm9yIG1vZHVsZSAie3swfX0iLicsIG1ldGhvZCk7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lcykgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCFpc0FycmF5KG5hbWVzKSkgewogICAgICAgICAgICAgICAgbmFtZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgbmFtZXMKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3MsIHJlc3VsdHMgPSBbXTsKICAgICAgICAgICAgZWFjaChuYW1lcywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQocnVubmluZ01lc3NhZ2UsIG5hbWUpKTsKICAgICAgICAgICAgICAgIHZhciBtb2QgPSB0aGF0Lm1vZHVsZXNbbmFtZV07CiAgICAgICAgICAgICAgICBpZighbW9kICYmICF0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAvLyB0cnkgdG8gZmV0Y2ggdGhlIG1vZHVsZS4KICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm5pbmcgdGhlIHByb3BlciBkZWZlciBpbiBpdCdzIHBsYWNlCiAgICAgICAgICAgICAgICAgICAgdmFyIGxvYWRlckRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgICAgICBuYW1lCiAgICAgICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKG1vZHVsZURlZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jcmVhdGVNb2R1bGUobW9kdWxlRGVmbiAmJiBtb2R1bGVEZWZuLm5hbWUgfHwgbmFtZSwgbW9kdWxlRGVmbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBydW5SdW5uZXJGYWN0b3J5KG1ldGhvZCkuYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlRGVmbi5uYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2hlbi5jaGFpbih3aGVuLmFsbChmbGF0dGVuKHJlc3VsdCkpLCBsb2FkZXJEZWZlcik7CiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBsb2FkZXJEZWZlci5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGxvYWRlckRlZmVyLnByb21pc2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKChjb252ZW50aW9uQ2hlY2sgJiYgbW9kLmNvbnZlbnRpb24oY29udmVudGlvbk5hbWUpKSB8fCAhbW9kLmNvbnZlbnRpb24oY29udmVudGlvbk5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoZmFsc2UgJiYgdENvbmZpZy50aHJvd0Vycm9ycykgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocnVubmVyKHRoYXQsIG5hbWUsIG1vZCwgYXJncykpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHJ1bm5lcih0aGF0LCBuYW1lLCBtb2QsIGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmVycm9yKGZvcm1hdChsb2dNZXNzYWdlLCBuYW1lKSwgZSwgZS5zdGFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0cy5sZW5ndGggJiYgcmVzdWx0czsKICAgICAgICB9OwogICAgfSk7CiAgICB2YXIgcnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCwgY29udmVudGlvbk5hbWUsIGNvbnZlbnRpb25WYWx1ZSwgdW5zZXRSZWFkeSkgewogICAgICAgIHZhciBldmVudE5hbWUgPSBmb3JtYXQoJ3RocnVzdC9tb2R1bGUvezB9JywgbWV0aG9kKSwgaW5mb0Zvcm1hdCA9IGZvcm1hdCgnVGhydXN0OiB7MH1pbmcgbW9kdWxlICJ7ezB9fSInLCBtZXRob2QuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBtZXRob2Quc3Vic3RyaW5nKDEpKSwgZGVidWdGb3JtYXQgPSBmb3JtYXQoJ1RocnVzdDogQ2FsbGluZyBtb2R1bGUgInt7MH19IiB7MH0oKScsIG1ldGhvZCksIGNvbXBBZnRlciA9IG1ldGhvZCA9PT0gU1RPUCB8fCBtZXRob2QgPT09IERFU1RST1kgfHwgZmFsc2U7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0aGF0LCBuYW1lLCBtb2QsIGFyZ3MpIHsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmluZm8oZm9ybWF0KGluZm9Gb3JtYXQsIG5hbWUpKTsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdChjb252ZW50aW9uTmFtZSwgbmFtZSkpOwogICAgICAgICAgICByZXR1cm4gbW9kLnRocnVzdENhbGwobWV0aG9kLCBjb21wQWZ0ZXIsIF9fZ2V0TW9kdWxlQXJncyh0aGF0Lm5hbWUsIG5hbWUsIGFyZ3MpKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoYXQubWVkaWF0b3IgJiYgdGhhdC5tZWRpYXRvci5maXJlKGV2ZW50TmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihjb252ZW50aW9uTmFtZSwgY29udmVudGlvblZhbHVlKTsKICAgICAgICAgICAgICAgIGlmKHVuc2V0UmVhZHkpIHsKICAgICAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihSRUFEWSArICctc3RhdHVzJywgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgfSk7CiAgICB2YXIgYWxsUnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHZhciBpbmZvRm9ybWF0ID0gZm9ybWF0KCdUaHJ1c3Q6IHswfWluZyBhbGwgbW9kdWxlcy4uLiBbe3swfX1dJywgbWV0aG9kLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbWV0aG9kLnN1YnN0cmluZygxKSksIHBsdXJhbE5hbWUgPSBmb3JtYXQoJ3RocnVzdC9tb2R1bGUvYWxsL3swfScsIG1ldGhvZCksIGNoZWNrQXV0b1N0YXJ0ID0gbWV0aG9kID09PSBJTklUIHx8IG1ldGhvZCA9PT0gU1RBUlQgfHwgbWV0aG9kID09PSBSRUFEWTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRoYXQpIHsKICAgICAgICAgICAgdGhhdC5tZWRpYXRvciAmJiB0aGF0Lm1lZGlhdG9yLmZpcmUocGx1cmFsTmFtZSk7CiAgICAgICAgICAgIHZhciBtb2R1bGVzID0gdGhhdC5tb2R1bGVzLCByZXN1bHRzID0gW107CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCBtYXAobW9kdWxlcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB4LmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpICYmIGk7CiAgICAgICAgICAgIH0pLmpvaW4oJywgJykpKTsKICAgICAgICAgICAgZWFjaChtb2R1bGVzLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgaWYoIWNoZWNrQXV0b1N0YXJ0IHx8IChjaGVja0F1dG9TdGFydCAmJiB4LmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpKSkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaCh0aGF0W21ldGhvZF0oaSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYodGhhdC5zdGFydGluZ01vZHVsZXMgJiYgY2hlY2tBdXRvU3RhcnQpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCB0aGF0LnN0YXJ0aW5nTW9kdWxlcy5qb2luKCcsICcpKSk7CiAgICAgICAgICAgICAgICB0aGF0W21ldGhvZF0odGhhdC5zdGFydGluZ01vZHVsZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChyZXN1bHRzKTsKICAgICAgICB9OwogICAgfSk7CiAgICBmdW5jdGlvbiBmaXJlVGhydXN0RXZlbnQodGhhdCwgZXZlbnQpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGF0Lm1lZGlhdG9yICYmIHRoYXQubWVkaWF0b3IuZmlyZShldmVudCk7CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBtZXRob2QsIHN0b3BwaW5nKSB7CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgZWFjaCh0aGF0LmNoaWxkcmVuLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgaWYoc3RvcHBpbmcpIHsKICAgICAgICAgICAgICAgIGNoaWxkLl9fcHJldmlvdXNTdGF0ZSA9IGNoaWxkLnN0YXJ0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoY2hpbGQuY2ZnLmF1dG9TdGFydCB8fCAoIXN0b3BwaW5nICYmIGNoaWxkLl9fcHJldmlvdXNTdGF0ZSkgfHwgKHN0b3BwaW5nICYmIGNoaWxkLnN0YXJ0ZWQpKSB7CiAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKGNoaWxkW21ldGhvZF0oZmFsc2UsIHRydWUpKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmKGl0ZW1zLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoaXRlbXMpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgYXJyKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuZmxhdHRlblRvUHJvbWlzZXMoYXJyLmNvbmNhdCh0aGF0LmNmZy5hc3luYyAmJiBbCiAgICAgICAgICAgIHdoZW4uZGVsYXkoMCkKICAgICAgICBdIHx8IFtdKSk7CiAgICB9CiAgICB2YXIgdGhydXN0TG9nRXZlbnQ7CiAgICBpZihmYWxzZSkgewogICAgICAgIHRocnVzdExvZ0V2ZW50ID0gZnVuY3Rpb24gKG1lc3NhZ2UsIG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGxvZy5kZWJ1Zyhmb3JtYXQuYXBwbHkoZm9ybWF0LCBbCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZQogICAgICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSkpOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAgIHRocnVzdExvZ0V2ZW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdXRpbC5ub29wOwogICAgICAgIH07CiAgICB9CiAgICB2YXIgdGhydXN0U2hvdWxkRXhlY3V0ZSA9IGZ1bmN0aW9uICh0aGF0LCBjYWxsZWRCeVBhcmVudCwgc3RvcHBpbmcpIHsKICAgICAgICBpZih0aGF0LnBhcmVudCAmJiB0aGF0LmNmZy5jaGlsZEluc3RhbmNlICYmICF0aGF0LnBhcmVudC5zdGFydGVkICYmICFjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICBsb2cud2Fybihmb3JtYXQoJ0Nhbm5vdCBleGVjdXRlIG9uIGNoaWxkIGluc3RhbmNlICJ7MH0iIHBhcmVudCBpbnN0YW5jZSAiezF9IiBtdXN0IGJlIHN0YXJ0ZWQgZmlyc3QuJywgdGhhdC5uYW1lLCB0aGF0LnBhcmVudC5uYW1lKSk7CiAgICAgICAgfQogICAgICAgIGlmKCFzdG9wcGluZyAmJiB0aGF0LnN0YXJ0ZWQgfHwgc3RvcHBpbmcgJiYgIXRoYXQuc3RhcnRlZCkgewogICAgICAgICAgICBsb2cud2Fybihmb3JtYXQoJ0Nhbm5vdCBzdGFydCB0aHJ1c3QgaW5zdGFuY2UgInswfSIgc2luY2UgaXQgYWxyZWFkeSBzdGFydGVkJywgdGhhdC5uYW1lKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfTsKICAgIC8qKgogICAgR2V0cyB0aGUgbW9kdWxlcyBhcmd1bWVudHMgZnJvbSB0aGUgcmVnaXN0cmF0aW9ucy4KICAgIAogICAgSWYgb3JpZ2luYWwgYXJncyBjb250YWlucyBhbnl0aGluZyBpdCBpcyBwYXNzZWQgaW5zdGVhZCBvZiB0aGUgcmVnaXN0cmF0aW9ucy4KICAgIElmIHRoZSByZWdpc3RyYXRpb25zIGFyZSBpbiBwbGFjZSBpdCB3aWxsIHJldHVybiB0aGVtLgogICAgCiAgICBAbWV0aG9kIF9fZ2V0TW9kdWxlQXJncwogICAgQHN0YXRpYwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lCiAgICBAcGFyYW0ge0FycmF5fSBvcmlnaW5hbEFyZ3MgVGhlIG9yaWdpbmFsIGFyZ3VtZW50cyBwYXNzZWQgaW50byB0aGUgY2FsbGluZyBtZXRob2QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIF9fZ2V0TW9kdWxlQXJncyhpbnN0YW5jZU5hbWUsIG5hbWUsIG9yaWdpbmFsQXJncykgewogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShvcmlnaW5hbEFyZ3MpOwogICAgICAgIGlmKGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBhcmdzOwogICAgICAgIH0KICAgICAgICB2YXIgaW5zdGFuY2VSZWdpc3RyYXRpb25zID0gVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdOwogICAgICAgIGlmKGluc3RhbmNlUmVnaXN0cmF0aW9ucyAmJiBpbnN0YW5jZVJlZ2lzdHJhdGlvbnNbbmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlUmVnaXN0cmF0aW9uc1tuYW1lXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICB9CiAgICAvLyNlbmRyZWdpb24KICAgIC8qKgogICAgVGhlIHByaW1hcnkgdGhydXN0IGNsYXNzLgogICAgCiAgICBAY2xhc3MgdGhydXN0LlRocnVzdAogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGlzIHRocnVzdCBpbnN0YW5jZQogICAgQHJldHVybnMge1RocnVzdH0KICAgICoqLwogICAgdmFyIFRocnVzdCA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gVGhydXN0KG5hbWUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gW107CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9fdGhydXN0Q29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5jZmcgPSBtZXJnZSh0Q29uZmlnLCB7CiAgICAgICAgICAgICAgICBhdXRvU3RhcnQ6IGZhbHNlLAogICAgICAgICAgICAgICAgYXN5bmM6IGZhbHNlLAogICAgICAgICAgICAgICAgY2hpbGRJbnN0YW5jZTogZmFsc2UsCiAgICAgICAgICAgICAgICBhdXRvbWF0aWNMaWZlY3ljbGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gbWVyZ2UodENvbmZpZywgewogICAgICAgICAgICAgICAgYXV0b1N0YXJ0OiBmYWxzZSwKICAgICAgICAgICAgICAgIGFzeW5jOiBmYWxzZSwKICAgICAgICAgICAgICAgIGNoaWxkSW5zdGFuY2U6IGZhbHNlLAogICAgICAgICAgICAgICAgYXV0b21hdGljTGlmZWN5Y2xlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB0aGlzLm1vZHVsZXMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZmFpbGVkTW9kdWxlcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdOwogICAgICAgICAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9ucyA9IHsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY3JlYXRlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyB0aHJ1c3QgbW9kdWxlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHVuaXF1ZSBtb2R1bGUgbmFtZS4KICAgICAgICBAcGFyYW0ge09iamVjdH0gbW9kdWxlIFRoZSBtb2R1bGUgZGVmaW50aW9uLgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gcHJlQnVpbGQgSGFzIHRoaXMgbW9kdWxlIGJlZW4gcHJlYnVpbHQsIGluIG90aGVyIHdvcmRzIGhhcyBpdCBiZWVuIGNyZWF0ZWQsIGJ5IHdpcmUuanMgYW5kIG5lZWRzIHRvIGJlIGluamVjdGVkLgogICAgICAgIEByZXR1cm5zIHtNb2R1bGV9IFRoZSBuZXcgbW9kdWxlIGluc3RhbmNlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCBtb2QsIHByZUJ1aWx0KSB7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ1RocnVzdDogQ3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mICJ7MH0iJywgbmFtZSkpOwogICAgICAgICAgICB2YXIgb2xkTW9kdWxlLCB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYocHJlQnVpbHQpIHsKICAgICAgICAgICAgICAgIG9sZE1vZHVsZSA9IG1vZDsKICAgICAgICAgICAgICAgIG1vZCA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighcHJlQnVpbHQpIHsKICAgICAgICAgICAgICAgIG1vZCA9IG5ldyBtLk1vZHVsZSh0aGF0LCBtb2QsIG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbW9kID0gb2xkTW9kdWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vZHVsZXMgY2Fubm90IGhhdmUgZHVwbGljYXRlIG5hbWVzLCBjaG9vc2UgYSBuZXcgb25lLgogICAgICAgICAgICBpZih0aGF0Lm1vZHVsZXNbbW9kLm5hbWVdKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdEdXBsaWNhdGUgbW9kdWxlIG5hbWUgInswfSIuJywgbmFtZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG0gaXMgdGhlIG1lZGlhdG9ycyBpbnRlcm5hbCBtb2R1bGUuCiAgICAgICAgICAgIHRoYXQubW9kdWxlc1ttb2QubmFtZV0gPSBtb2Q7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdCgnVGhydXN0OiBDcmVhdGVkIG1vZHVsZSAiezB9IicsIG5hbWUpKTsKICAgICAgICAgICAgLy8gTm90aWZ5IHRoZSBtZWRpYXRvciB0aGF0IGEgbW9kdWxlIGhhcyBiZWVuIGNyZWF0ZWQuCiAgICAgICAgICAgIHRoYXQubWVkaWF0b3IuZmlyZSgndGhydXN0L21vZHVsZS9jcmVhdGUnLCBuYW1lKTsKICAgICAgICAgICAgaWYodGhhdCAmJiB0aGF0LnN0YXJ0ZWQgJiYgbW9kLmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpKSB7CiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0KG1vZC5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdGFydHVwID0gLy8jcmVnaW9uIEdsb2JhbCBSdW5uZXJzCiAgICAgICAgZnVuY3Rpb24gKGV2ZW50LCBldmVudFR5cGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIGV2ZW50LCB0aGF0KSwgCiAgICAgICAgICAgICAgICB0aGF0W2V2ZW50VHlwZV0oKSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgZXZlbnQpCiAgICAgICAgICAgIF0pKTsKICAgICAgICAgICAgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKGZpcmVUaHJ1c3RFdmVudCh0aGF0LCAndGhydXN0LycgKyBldmVudFR5cGUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLl9jb3VudGRvd24gPSBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxzZSAmJiB0aHJ1c3RMb2dFdmVudCgnTGF1bmNoIGluc3RhbmNlICJ7MH0iIGluIDUuLi4gNC4uLiAzLi4uIDIuLi4gMS4uLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zdGFydHVwKENPVU5URE9XTiwgSU5JVCk7CiAgICAgICAgICAgIGZhbHNlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGhhcyBiZWVuIGluaXRhbGl6ZWQuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5jb3VudGRvd24gPSAvKioKICAgICAgICBCZWdpbnMgdGhlIGNvdW50ZG93biB0byB0aHJ1c3RzIHN0YXJ0LgogICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNvdW50ZG93bgogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBjb3VudGRvd24gaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoYXQuY2ZnLmF1dG9tYXRpY0xpZmVjeWNsZSAmJiAoIXRoYXQuY2ZnLmNoaWxkSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gVGhydXN0LmxhdW5jaFNlcXVlbmNlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhhdC5fY291bnRkb3duKGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaWduaXRlID0gLyoqCiAgICAgICAgQmVnaW5zIHRoZSBpbmdpdGlvbiBhcyB0aHJ1c3Qgc3RhcnRzIHVwLgogICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGlnbml0ZQogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBpbmdpdGlvbiBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFsc2UgJiYgdGhydXN0TG9nRXZlbnQoJ0ZpcmluZyByb2NrZXRzIGZvciB0aHVyc3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnN0YXJ0dXAoSUdOSVRFLCBTVEFSVCk7CiAgICAgICAgICAgIGZhbHNlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGhhcyBiZWVuIHN0YXJ0ZWQuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5vcmJpdCA9IC8qKgogICAgICAgIFRocnVzdCBwcmVwYXJlcyBmb3Igb3JiaXQuCiAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgb3JiaXQKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aHJ1c3QgaXMgaW4gb3JiaXQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFsc2UgJiYgdGhydXN0TG9nRXZlbnQoJ0ZpcmluZyBzdGFnZSB0d28gdGhydXN0ZXJzIGZvciB0aHJ1c3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKSgpOwogICAgICAgICAgICB2YXIgZG9tUmVhZHlEZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgZG9tUmVhZHlEZWZlci5wcm9taXNlLnRoZW4oZmlyZVRocnVzdEV2ZW50KHRoYXQsICd0aHJ1c3QvZG9tL3JlYWR5JykpOwogICAgICAgICAgICBkb21SZWFkeShkb21SZWFkeURlZmVyLnJlc29sdmUpOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgZG9tUmVhZHlEZWZlci5wcm9taXNlLCAKICAgICAgICAgICAgICAgIHNhZmVJbnZva2UodGhhdC5fX2NvbnZlbnRpb25zLCBPUkJJVCwgdGhhdCksIAogICAgICAgICAgICAgICAgY2hpbGRyZW5DYWxsTWV0aG9kKHRoYXQsIE9SQklUKQogICAgICAgICAgICBdKSk7CiAgICAgICAgICAgIGZhbHNlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGlzIGFsbW9zdCByZWFkeS4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlcGxveSA9IC8qKgogICAgICAgIFRocnVzdCBkZXBsb3lzIGNvbXBvbmVudHMgaW4gb3JiaXQKICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBkZXBsb3kKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aHJ1c3QgaGFzIGZ1bGx5IGRlcGxveWVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGZhbHNlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZVN0YXJ0ID0gdGhhdC5jb25maWcuZGVidWcudGltZVN0YXJ0LCB0aW1lRW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCksIHN0YXJ0VGltZSA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KSwgdHRvRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R0bycpOwogICAgICAgICAgICAgICAgaWYodHRvRGl2KSB7CiAgICAgICAgICAgICAgICAgICAgdHRvRGl2LmlubmVySFRNTCA9IHN0YXJ0VGltZSArICdtcyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIHRoYXQucmVhZHkoKSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgREVQTE9ZKQogICAgICAgICAgICBdKSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC9yZWFkeScpKTsKICAgICAgICAgICAgZmFsc2UgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IHJlYWR5LicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaW5PcmJpdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGF0LnN0YXJ0ZWQgPSB0cnVlOwogICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgSU5PUkJJVCk7CiAgICAgICAgICAgIGlmKGZhbHNlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZVN0YXJ0ID0gdGhhdC5jb25maWcuZGVidWcudGltZVN0YXJ0LCB0aW1lRW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCksIHN0YXJ0VGltZSA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KTsKICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdTdGFydGVkIGluICcgKyBzdGFydFRpbWUgKyAnbXMnKTsKICAgICAgICAgICAgICAgIHZhciB0dHJEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHRyJyk7CiAgICAgICAgICAgICAgICBpZih0dHJEaXYpIHsKICAgICAgICAgICAgICAgICAgICB0dHJEaXYuaW5uZXJIVE1MID0gc3RhcnRUaW1lICsgJ21zJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zaHV0ZG93biA9IGZ1bmN0aW9uIChldmVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBldmVudCwgdHJ1ZSksIAogICAgICAgICAgICAgICAgdGhhdFtldmVudFR5cGVdKCksIAogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIGV2ZW50LCB0aGF0KQogICAgICAgICAgICBdKSk7CiAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC8nICsgZXZlbnRUeXBlKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fZGVvcmJpdCA9IGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50LCB0cnVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZhbHNlICYmIHRocnVzdExvZ0V2ZW50KCdSZWVudGVyaW5nIGVhcnRocyBhdG1vc3BoZXJlIGZvciB0aHJ1c3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnNodXRkb3duKERFT1JCSVQsIFNUT1ApOwogICAgICAgICAgICBmYWxzZSAmJiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4odGhydXN0TG9nRXZlbnQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBpcyBub3cgc3RvcHBlZC4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlb3JiaXQgPSAvKioKICAgICAgICBCZWdpbnMgdGhlIGRlb3JiaXQgYXMgdGhydXN0IHNodXRkb3duLgogICAgICAgIFNodXRkb3duIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBkZW9yYml0CiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGluZ2l0aW9uIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCwgdHJ1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGF0LmNmZy5hdXRvbWF0aWNMaWZlY3ljbGUgJiYgKCF0aGF0LmNmZy5jaGlsZEluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uc2VxdWVuY2UoWwogICAgICAgICAgICAgICAgICAgIF8uYmluZCh0aGF0Ll9kZW9yYml0LCB0aGF0KSwgCiAgICAgICAgICAgICAgICAgICAgXy5iaW5kKHRoYXQuc3BsYXNoZG93biwgdGhhdCkKICAgICAgICAgICAgICAgIF0sIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhhdC5fZGVvcmJpdChjYWxsZWRCeVBhcmVudCk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnNwbGFzaGRvd24gPSAvKioKICAgICAgICBCZWdpbnMgdGhlIHNwbGFzaGRvd24gYXMgdGhydXN0IHNodXRkb3duLgogICAgICAgIFNodXRkb3duIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzcGxhc2hkb3duCiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGluZ2l0aW9uIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCwgdHJ1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxzZSAmJiB0aHJ1c3RMb2dFdmVudCgnTGFuZGluZyBpbiB0aGUgbWlkZGxlIG9mIHRoZSBhdGxhbnRpYyBmb3IgdGhydXN0IGluc3RhbmNlICJ7MH0iLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zaHV0ZG93bihTUExBU0hET1dOLCBERVNUUk9ZKTsKICAgICAgICAgICAgZmFsc2UgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IGJlaW5nIGRlc3Ryb3llZCcsIHRoYXQubmFtZSkpOwogICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhhdC5zdGFydGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUubW9kdWxlTWV0aG9kID0gZnVuY3Rpb24gKG1ldGhvZCwgbmFtZSwgYXJncywgcmV2ZXJzZSwgZGVwZW5kZW50TWV0aG9kcywgc3RhcnRlZE1ldGhvZHMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBwaXBlID0gW107CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gYWxsUnVubmVyRmFjdG9yeShtZXRob2QpKHRoYXQpOwogICAgICAgICAgICAgICAgaWYocmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICAgICAgaWYoIWlzQXJyYXkobmFtZSkpIHsKICAgICAgICAgICAgICAgIG5hbWVzID0gWwogICAgICAgICAgICAgICAgICAgIG5hbWUKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuYW1lcyA9IChuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihkZXBlbmRlbnRNZXRob2RzICYmIGRlcGVuZGVudE1ldGhvZHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG5hbWVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBuID0gbmFtZXNbaV0sIG1vZCA9IHRoYXQubW9kdWxlc1tuXTsKICAgICAgICAgICAgICAgICAgICBlYWNoKGRlcGVuZGVudE1ldGhvZHMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFpdGVtc1t4XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZighcmV2ZXJzZSAmJiAoIW1vZCB8fCAhbW9kLmNvbnZlbnRpb24oeCArICctc3RhdHVzJykpIHx8IChyZXZlcnNlICYmIG1vZC5jb252ZW50aW9uKHggKyAnLXN0YXR1cycpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0ucHVzaChuKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWFjaChkZXBlbmRlbnRNZXRob2RzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIGlmKGl0ZW1zW3hdICYmIGl0ZW1zW3hdLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4odGhhdFt4XS5hcHBseSh0aGF0LCBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4ocnVuUnVubmVyRmFjdG9yeShtZXRob2QpLmFwcGx5KHRoYXQsIFsKICAgICAgICAgICAgICAgICAgICBuYW1lcwogICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZih0aGF0LnN0YXJ0ZWQgJiYgc3RhcnRlZE1ldGhvZHMgJiYgc3RhcnRlZE1ldGhvZHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBlYWNoKHN0YXJ0ZWRNZXRob2RzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChmbGF0dGVuKHRoYXRbeF0uYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZXMKICAgICAgICAgICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5waXBlbGluZShwaXBlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoYXQubW9kdWxlTWV0aG9kKElOSVQsIG5hbWUsIGFyZ3MsIGZhbHNlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChTVEFSVCwgbmFtZSwgYXJncywgZmFsc2UsIFsKICAgICAgICAgICAgICAgIElOSVQKICAgICAgICAgICAgXSwgWwogICAgICAgICAgICAgICAgUkVBRFkKICAgICAgICAgICAgXSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnJlYWR5ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoUkVBRFksIG5hbWUsIGFyZ3MsIGZhbHNlLCBbCiAgICAgICAgICAgICAgICBJTklULCAKICAgICAgICAgICAgICAgIFNUQVJUCiAgICAgICAgICAgIF0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdG9wID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoU1RPUCwgbmFtZSwgYXJncywgdHJ1ZSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1ldGhvZCA9IERFU1RST1k7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChERVNUUk9ZLCBuYW1lLCBhcmdzLCB0cnVlLCBbCiAgICAgICAgICAgICAgICBTVE9QCiAgICAgICAgICAgIF0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fX2luamVjdE1vZHVsZSA9IC8vI2VuZHJlZ2lvbgogICAgICAgIC8qKgogICAgICAgIEluamVjdHMgYSBwcmVjb25zdHJ1Y3RlZCBtb2R1bGUgaW50byB0aGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgX19pbmplY3RNb2R1bGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBpbmplY3QuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgICAgICAgICB0aGlzLmNyZWF0ZShtb2R1bGUubmFtZSwgbW9kdWxlLCB0cnVlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY3JlYXRlTW9kdWxlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG1vZHVsZSBmcm9tIHRoZSBnaXZlbiBkZWZpbml0aW9uIG9iamVjdCwgd2l0aCB0aGUgZ2l2ZW4gbmFtZS4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNyZWF0ZU1vZHVsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGVEZWZuIFRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCBtb2R1bGVEZWZuKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYodGhhdC5tb2R1bGVzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVzW25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtb2R1bGUgPSBuZXcgTW9kdWxlKHRoYXQsIG1vZHVsZURlZm4sIG5hbWUpOwogICAgICAgICAgICB0aGF0Ll9faW5qZWN0TW9kdWxlKG1vZHVsZSk7CiAgICAgICAgICAgIHJldHVybiBtb2R1bGU7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnNwYXduID0gLyoqCiAgICAgICAgTGF1bmNoZXMgYW5vdGhlciBjaGlsZCBtb2R1bGUgZm9yIHRocnVzdC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHNwYXduCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgb25jZSB0aGUgY2hpbGQgaW5zdGFuY2UgaGFzIGZ1bGx5IGxvYWRlZC4gIFJlc29sdmVzIHdpdGggdGhlIGNvbnRleHQgdGhhdCBjb250YWlucyB0aGUgdGhydXN0IGluc3RhbmNlIGFuZCBhbGwgcGx1Z2lucyB0aGF0IHdlcmUgbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChzZXR0aW5ncykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiBUaHJ1c3QubGF1bmNoKGV4dGVuZCh7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGNoaWxkSW5zdGFuY2U6IHRydWUKICAgICAgICAgICAgfSwgc2V0dGluZ3MpLCB0cnVlKS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3Q7CiAgICAgICAgICAgICAgICB0aGF0LmNoaWxkcmVuLnB1c2godGhydXN0KTsKICAgICAgICAgICAgICAgIHRocnVzdC5wYXJlbnQgPSB0aGF0OwogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5yZWdpc3Rlck1vZHVsZSA9IC8qKgogICAgICAgIFJlZ2lzdGVycyBhIHNwZWNpZmljIG1vZHVsZSBuYW1lLCBhbmQgYXJndW1lbnRzLiAgVGhlIGFyZ3VtZW50cyB3aWxsIGJlIHVzZWQgd2hlbiBpbml0YW50aWF0aW5nIHRoZSBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWdpc3Rlck1vZHVsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZSB0byBhc3NpZ24gdGhlIGFyZ3VtZW50cyB3aXRoLgogICAgICAgIEBwYXJhbSB7T2JqZWN0Kn0gYXJndW1lbnRzLCBhZGRpdGlvbmFsIGFyZ3VtZW50cyB0aGF0IHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIG1vdWRsZQogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgVGhydXN0LnJlZ2lzdGVyTW9kdWxlLmFwcGx5KFRocnVzdCwgWwogICAgICAgICAgICAgICAgdGhhdC5uYW1lCiAgICAgICAgICAgIF0uY29uY2F0KHRvQXJyYXkoYXJndW1lbnRzKSkpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmxhdW5jaFNlcXVlbmNlID0gZnVuY3Rpb24gbGF1bmNoU2VxdWVuY2UoaW5zdGFuY2UsIGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHJldHVybiB3aGVuLnNlcXVlbmNlKFsKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5fY291bnRkb3duLCBpbnN0YW5jZSksIAogICAgICAgICAgICAgICAgXy5iaW5kKGluc3RhbmNlLmlnbml0ZSwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5vcmJpdCwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5kZXBsb3ksIGluc3RhbmNlKSwgCiAgICAgICAgICAgICAgICBfLmJpbmQoaW5zdGFuY2UuaW5PcmJpdCwgaW5zdGFuY2UpCiAgICAgICAgICAgIF0sIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5sYXVuY2ggPSAvKioKICAgICAgICBJbml0YWxpemVzIGEgbmV3IFRocnVzdCBpbnN0YW5jZSBiYXNlZCBvbiB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBsYXVuY2gKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBtb2R1bGUgdG8gaW5qZWN0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gbGF1bmNoKHNldHRpbmdzLCBjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICBpZighc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gewogICAgICAgICAgICAgICAgICAgIG5hbWU6ICdnbG9iYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncy5uYW1lKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy5uYW1lID0gJ2dsb2JhbCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZmFsc2UpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzLmRlYnVnID0gewogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFydDogbmV3IERhdGUoKS5nZXRUaW1lKCkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0dGluZ3MgPSBpZ25pdGVTcGVjLm1lcmdlU2V0dGluZ3Moc2V0dGluZ3MpOwogICAgICAgICAgICB2YXIgcGlwZSA9IFsKICAgICAgICAgICAgICAgIGlnbml0ZVNwZWMuZnVzZQogICAgICAgICAgICBdOwogICAgICAgICAgICB2YXIgc2V0dXBEZWZlciA9IFRocnVzdC5fX2ZldGNoSW5zdGFuY2Uoc2V0dGluZ3MubmFtZSk7CiAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICAgICAgdmFyIHRocnVzdCA9IGNvbnRleHQudGhydXN0LCBtb2R1bGVzID0gdGhydXN0LnN0YXJ0aW5nTW9kdWxlcyA9IGNvbnRleHQuY2ZnLm1vZHVsZXMsIGNvbmZpZyA9IHRocnVzdC5jb25maWcgPSB0aHJ1c3QuY2ZnOwogICAgICAgICAgICAgICAgaW5zdGFuY2VzW3RocnVzdC5uYW1lXSA9IHRocnVzdDsKICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYoc2V0dGluZ3MuYXV0b21hdGljTGlmZWN5Y2xlKSB7CiAgICAgICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3QsIGQgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgVGhydXN0LmxhdW5jaFNlcXVlbmNlKHRocnVzdCwgY2FsbGVkQnlQYXJlbnQpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZC5yZXNvbHZlKGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBkLnByb21pc2U7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcGlwZWxpbmUgPSB3aGVuLnBpcGVsaW5lKHBpcGUsIHNldHRpbmdzKS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2V0dXBEZWZlci5yZXNvbHZlKGNvbnRleHQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gV2UncmUgb25seSBnb2luZyB0byBleHBvc2UgZ2xvYmFscyBpZiByZXF1ZXN0ZWQuICBUaGlzIGlzIGEgcG90ZW50aWFsIHVzZWNhc2UgdGhhdCBtYXkgYmUgbmVlZGVkIGZvciBzb21lIHRlYW1zLgogICAgICAgICAgICBpZih0Q29uZmlnLmV4cG9zZUdsb2JhbHMpIHsKICAgICAgICAgICAgICAgIGlmKCF3aW5kb3dbJ1RocnVzdCddKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93WydUaHJ1c3QnXSA9IFRocnVzdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBpcGVsaW5lLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3dbc2V0dGluZ3MubmFtZV0gPSBjb250ZXh0OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBpcGVsaW5lOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmdldEluc3RhbmNlID0gLyoqCiAgICAgICAgR2V0cyBhIG5hbWVkIHRocnVzdCBzdGFuY2UgaWYgaXQgZXhpc3RzLgogICAgICAgIAogICAgICAgIEBtZXRob2QgZ2V0SW5zdGFuY2UKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGluc3RhbmNlIG5hbWUKICAgICAgICBAcmV0dXJucyB7VGhydXN0fSBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2UobmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhydXN0SW5zdGFuY2UuZ2V0SW5zdGFuY2UobmFtZSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QuX19mZXRjaEluc3RhbmNlID0gLyoqCiAgICAgICAgRmV0Y2hzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICAgICAgVGhpcyBsb2FkcyBhc3luY3Jvbm91c2x5LCBhcyB0aGUgaW5zdGFuY2UgbWF5IG5vdCBiZSBsb2FkZWQKICAgICAgICAKICAgICAgICBAbWV0aG9kIF9fZmV0Y2hJbnN0YW5jZQogICAgICAgIEBzdGF0aWMKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRvIGEgdGhydXN0IGluc3RhbmNlIHNwZWMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiBfX2ZldGNoSW5zdGFuY2UobmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhydXN0SW5zdGFuY2UuZmV0Y2hJbnN0YW5jZShuYW1lKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5jcmVhdGVNb2R1bGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbmV3IG1vZHVsZSBhbmQgaGFuZHMgaXQgb2ZmIHRvIHRoZSBnaXZlbiBpbnN0YW5jZSwgaWYgdGhhdCBpbnN0YW5jZSBleGlzdHMuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBjcmVhdGVNb2R1bGUKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlTmFtZSBUaGUgdGhydXN0IGluc3RhbmNlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbW9kdWxlIG5hbWUKICAgICAgICBAcGFyYW0ge09iamVjdH0gbW9kdWxlRGVmbiBUaGUgbW9kdWxlIGRlZmluaXRpb24KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiBjcmVhdGVNb2R1bGUoaW5zdGFuY2VOYW1lLCBuYW1lLCBtb2R1bGVEZWZuKSB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IFRocnVzdC5nZXRJbnN0YW5jZShpbnN0YW5jZU5hbWUpOwogICAgICAgICAgICBpZihpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdmFyIG1vZHVsZSA9IG5ldyBNb2R1bGUoaW5zdGFuY2UsIG1vZHVsZURlZm4sIG5hbWUpOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuX19pbmplY3RNb2R1bGUobW9kdWxlKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb2R1bGU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFRocnVzdC5yZWdpc3Rlck1vZHVsZSA9IC8qKgogICAgICAgIFJlZ2lzdGVycyBhIHNwZWNpZmljIG1vZHVsZSBuYW1lLCBhbmQgYXJndW1lbnRzLiAgVGhlIGFyZ3VtZW50cyB3aWxsIGJlIHVzZWQgd2hlbiBpbml0YW50aWF0aW5nIHRoZSBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWdpc3Rlck1vZHVsZQogICAgICAgIEBzdGF0aWMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VOYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgdGhlIG1vZHVsZSBpcyB0byBiZSBhc3NvY2lhdGVkIHdpdGguCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lIHRvIGFzc2lnbiB0aGUgYXJndW1lbnRzIHdpdGguCiAgICAgICAgQHBhcmFtIHtPYmplY3QqfSBhcmd1bWVudHMsIGFkZGl0aW9uYWwgYXJndW1lbnRzIHRoYXQgd2lsbCBiZSBwYXNzZWQgb250byB0aGUgbW91ZGxlCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJNb2R1bGUoaW5zdGFuY2VOYW1lLCBuYW1lKSB7CiAgICAgICAgICAgIGlmKCFpbnN0YW5jZU5hbWUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignaW5zdGFuY2VOYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25hbWUgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIVRocnVzdC5fX21vZHVsZVJlZ2lzdHJhdGlvbnNbaW5zdGFuY2VOYW1lXSkgewogICAgICAgICAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdID0gewogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKS5zbGljZSgyKTsKICAgICAgICAgICAgaWYoVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdW25hbWVdKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdNb2R1bGUgInswfSIgYWxyZWFkeSByZWdpc3RlcmVkIHRvIGluc3RhbmNlICJ7MX0iJywgbmFtZSwgaW5zdGFuY2VOYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdW25hbWVdID0gYXJncyB8fCBbXTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5fX2dldE1vZHVsZUFyZ3MgPSBfX2dldE1vZHVsZUFyZ3M7CiAgICAgICAgcmV0dXJuIFRocnVzdDsKICAgIH0pKCk7CiAgICBleHBvcnRzLlRocnVzdCA9IFRocnVzdDsgICAgCiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIGN1cnJlbnQgdGh1cnN0IGluc3RhbmNlLCBieSBleHBlY3RlZCBuYW1lLgogICAgQWRkaW5nIHRoZSA6IGNoYXJhY3RlciByZXF1ZXN0cyBhIHNwZWNpZmljIHBsdWdpbi4KICAgIHRocnVzdCFnbG9iYWwgPSBUaHJ1c3QgaW5zdGFuY2UKICAgIHRocnVzdCFnbG9iYWw6ZG9tID0gVGhlIHRocnVzdCBkb20gcGx1Z2luIGluc3RhbmNlCiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkIEFsbG93cyB0aGUgbG9hZCB0byBpbmZvcm0gdGhhdCBBTUQgZm9yIHRoZSB2YWx1ZSB0byBoYW5kIG9mZgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAqKi8KICAgIGZ1bmN0aW9uIGxvYWQobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKSB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLCByZWFsTmFtZSA9IHBhcnRzWzBdLCBwbHVnaW5OYW1lID0gcGFydHNbMV0gfHwgJ3RocnVzdCc7CiAgICAgICAgdmFyIGluc3RhbmNlUHJvbWlzZSA9IFRocnVzdC5fX2ZldGNoSW5zdGFuY2UocmVhbE5hbWUpOwogICAgICAgIGluc3RhbmNlUHJvbWlzZS5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHBsdWdpbiA9IGNvbnRleHRbcGx1Z2luTmFtZV07CiAgICAgICAgICAgIGlmKCFwbHVnaW4pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ1BsdWdpbiAiezB9IiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgInsxfSIuJywgcGx1Z2luTmFtZSwgcmVhbE5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsb2FkKHBsdWdpbik7CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmxvYWQgPSBsb2FkOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0JywgWyd0aHJ1c3QvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgQSBDb252ZW50aW9uIGFsbG93cyB0aHJ1c3QgdG8gYmUgYXMgZXh0ZW5kYWJsZSBhcyBwb3NzaWJsZSwgYnkgZ2l2aW5nIGV4dGVuc2lvbiBwb2ludHMgYXQgZXZlcnkgc3RlcCBhbG9uZyB0aGUgd2F5LgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgKiovCiAgICB2YXIgbWV0aG9kcyA9IFsKICAgICAgICAnY3JlYXRlJywgCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnc3RhcnQnLCAKICAgICAgICAncmVhZHknLCAKICAgICAgICAnc3RvcCcsIAogICAgICAgICdkZXN0cm95JywgCiAgICAgICAgJ2NvdW50ZG93bicsIAogICAgICAgICdpZ25pdGUnLCAKICAgICAgICAnb3JiaXQnLCAKICAgICAgICAnZGVvcmJpdCcsIAogICAgICAgICdzcGxhc2hkb3duJwogICAgXTsKICAgIC8qKgogICAgVGhlIGNvbnZlbnRpb24gY2xhc3MsIHRha2VzIGFuIG92ZXJsb2FkZWQgc2V0IG9mIG1ldGhvZHMsIGZvciBhbnkgbWV0aG9kIHRoYXQgbmVlZHMgdG8gYmUgb3ZlcmxvYWRlZC4KICAgIAogICAgQGNsYXNzIHRocnVzdC5Db252ZW50aW9uCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7T2JqZWN0fSBtZXRob2RzIEFuIG9iamVjdCBvZiBhcHBsaWNhYmxlIG1ldGhvZHMuCiAgICAqKi8KICAgIHZhciBDb252ZW50aW9uID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBDb252ZW50aW9uKG1ldGhvZE92ZXJyaWRlcykgewogICAgICAgICAgICBfLmV4dGVuZCh0aGlzLCBtZXRob2RPdmVycmlkZXMpOwogICAgICAgICAgICB2YXIga2V5cyA9IF8uZGlmZmVyZW5jZShtZXRob2RzLCBfLmludGVyc2VjdGlvbihtZXRob2RzLCBfLmtleXMobWV0aG9kT3ZlcnJpZGVzKSkpOwogICAgICAgICAgICBfLmVhY2goa2V5cywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIGlmKF8uaXNGdW5jdGlvbih0aGlzW3hdKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG5vb3AgaXMgdXNlZCBpbiBzYWZlaW52b2tlLCBhcyBhIHNhZmUgaWdub3JlIGZ1bmN0aW9uLCBubyBvdGhlciBub29wIHdpbGwgd29yayBjb3JyZWN0bHkuCiAgICAgICAgICAgICAgICAgICAgdGhpc1t4XSA9IHV0aWwubm9vcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmNyZWF0ZSA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyBjcmVhdGUgb2YgYSBtb2R1bGUsIGdlbmVyYWxseSB1c2VkIHRvIGNyZWF0ZSBhIGZhY2FkZSwgdGhhdCBpcyB0aGVuIGJvdW5kIHRvIHRoZSBtb2R1bGUuCiAgICAgICAgQG1ldGhvZCBjcmVhdGUKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHBhcmFtIHtNb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIGluc3RhbmNlLgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIEFsbCB0aGUgZmFjYWRlcyBhbHJlYWR5IGF0dGFjaGVkIHRvIHRoZSBtb2R1bGUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5pbml0ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IGluaXQgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3MgaW5pdCBwaGFzZQogICAgICAgIAogICAgICAgIEBtZXRob2QgaW5pdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnN0YXJ0ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IHN0YXJ0IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIHN0YXJ0IHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnJlYWR5ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IHJlYWR5IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIHJlYWR5IHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWFkeQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnN0b3AgPSAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3Qgc3RvcCBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBzdG9wIHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdG9wCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuZGVzdHJveSA9IC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCBkZXN0cm95IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIGRlc3Ryb3kgcGhhc2UKICAgICAgICAKICAgICAgICBAbWV0aG9kIGRlc3Ryb3kKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5jb3VudGRvd24gPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIGluaXQgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBjb3VudGRvd24KICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuaWduaXRlID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBzdGFydCBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIGlnbml0ZQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5vcmJpdCA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgcmVhZHkgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBvcmJpdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5kZW9yYml0ID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBzdG9wIHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2QgZGVvcmJpdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5zcGxhc2hkb3duID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBkZXN0cm95IHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2Qgc3BsYXNoZG93bgogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gQ29udmVudGlvbjsKICAgIH0pKCk7CiAgICBleHBvcnRzLkNvbnZlbnRpb24gPSBDb252ZW50aW9uOyAgICAKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29udmVudGlvbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9ldmVudHMnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJy4vbG9nJywgJy4vY29uZmlnJywgJ2hhcycsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2xvZ19fLCBfX3RDb25maWdfXywgX19oYXNfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLy8gICAgIEJhY2tib25lLmpzIDAuOS4xCiAgICAvLyAgICAgKGMpIDIwMTAtMjAxMiBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgogICAgLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogICAgLy8gICAgIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKICAgIC8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKICAgIC8qKgogICAgVGhydXN0IEV2ZW50cyBhcmUgYmFzZWQgb2ZmIG9mIHRoZSBCYWNrYm9uZSBldmVudCBtb2RlbCwgd2l0aCBzcGVjaWFsIGFkZGl0aW9ucy4KICAgIAogICAgKiBFdmVudHMgY2FuIGJlIGZpcmVkIGFzeW5jcm9ub3VzbHkuCiAgICAqIEV2ZW50cyBjYW4gYmUgbmFtZXNwYWNlZC4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIEV2ZW50Tm9kZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gRXZlbnROb2RlKCkgewogICAgICAgICAgICB0aGlzLnRhaWwgPSBudWxsOwogICAgICAgICAgICB0aGlzLm5leHQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5uYW1lc3BhY2UgPSAnJzsKICAgICAgICAgICAgdGhpcy5vbmNlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBFdmVudE5vZGU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5FdmVudE5vZGUgPSBFdmVudE5vZGU7ICAgIAogICAgdmFyIGNyZWF0ZUFzeW5jRXZlbnQgPSBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICAgICAgdmFyIGYgPSBmdW5jdGlvbiBmKGV2ZW50cykgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfdHJpZ2dlci5hcHBseShvYmplY3QsIFsKICAgICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgIF0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIH07CiAgICAgICAgZi5hc3luYyA9IGZ1bmN0aW9uIChldmVudHMpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3RyaWdnZXIuYXBwbHkob2JqZWN0LCBbCiAgICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgIF0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGY7CiAgICB9OwogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBhc3luY0ZpcmUsIG5vb3AgPSB1dGlsLm5vb3AsIHdoZW4gPSB1dGlsLndoZW4sIHNpemUgPSBfLnNpemUsIGVhY2ggPSBfLmVhY2gsIGRlZmVyID0gXy5kZWZlciwgYmluZCA9IF8uYmluZCwgZXh0ZW5kID0gXy5leHRlbmQsIGZvcm1hdCA9IHV0aWwuZm9ybWF0OwogICAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLywgQUxMID0gJ2FsbCcsIFNUQVJBTEwgPSAnKmFsbCc7CiAgICAvKioKICAgIE5vcm1hbGl6ZXMgdGhlIGdpdmVuIGV2ZW50cyB0byB0aGUgZXhwZWN0ZWQgbmFtZXNwYWNlLgogICAgCiAgICBAbWV0aG9kIG5vcm1hbGl6ZUV2ZW50cwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgVGhlIGV2ZW50cyBkZWxpbWl0ZWQgYnkgYSBzcGFjZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZSBUaGUgbmFtZXNwYWNlLCBpbmNsdWRpbmcgcHJlZml4ZWQgJy4nCiAgICAqKi8KICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIG5hbWVzcGFjZSkgewogICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gZXZlbnRzQXJyYXkubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmKGV2ZW50c0FycmF5W2ldLmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIGV2ZW50c0FycmF5W2ldID0gZXZlbnRzQXJyYXlbaV0gKyBuYW1lc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2ZW50c0FycmF5LmpvaW4oJyAnKTsKICAgIH0KICAgIC8qKgogICAgVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgCiAgICBAbWV0aG9kIF90cmlnZ2VyCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtCb29sZWFufSBhc3luYyBGaXJlIGV2ZW50IGFzeW5jIG9yIHN5bmMKICAgIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgVGhlIGV2ZW50cyB0byBiZSBmaXJlZC4KICAgIGRlbGltaXRlZCBieSBhIHNwYWNlLgogICAgQHBhcmFtIFthcmdzXSogVGhlIGFyZ3VtZW50cyB0byBwYXNzIG9udG8gdGhlIGNhbGxiYWNrIG1ldGhvZHMuCiAgICBAcmV0dXJucyBJZiBhc3luYyB0aGVuIHJldHVybnMgYSBQcm9taXNlLCB3aGVyZSB0aGUgZmlyc3QgYXJndW1lbnQgY29udGFpbnMgYWxsIHRoZSByZXR1cm5lZCB2YWx1ZXMsIGFzIGFuIGFycmF5CiAgICBJZiBzeW5jIHRoZW4gcmV0dXJucyBhbiBhcnJheSBvZiB0aGUgcmV0dXJuIHZhbHVlcy4KICAgIElmIG1vcmUgdGhhbiBvbmUgZXZlbnQsIHJldHVybnMgYW4gb2JqZWN0IG9mIGFycmF5cyBvciBwcm9taXNlcywgd2l0aCB0aGUga2V5IGZvciBlYWNoIGV2ZW50LgogICAgKiovCiAgICBmdW5jdGlvbiBfdHJpZ2dlcihhc3luYywgZXZlbnRzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgZXZlbnQsIG5vZGUsIGNhbGxzLCB0YWlsLCBhcmdzLCBhbGwsIHJlc3QsIG5hbWVzcGFjZSwgb25jZU5vZGVzOwogICAgICAgIGlmKCEoY2FsbHMgPSB0aGlzLl9jYWxsYmFja3MpKSB7CiAgICAgICAgICAgIHJldHVybiB0aGF0OwogICAgICAgIH0KICAgICAgICBhbGwgPSBjYWxscy5hbGw7CiAgICAgICAgdmFyIGV2ZW50c0FycmF5ID0gZXZlbnRzLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHJlc3QgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICAgICAgd2hpbGUoZXZlbnQgPSBldmVudHNBcnJheS5zaGlmdCgpKSB7CiAgICAgICAgICAgIGlmKG5vZGUgPSBjYWxsc1tldmVudF0pIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJOb2Rlcyh0aGF0LCBldmVudCwgYXN5bmMsIG5vZGUsIHJlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG5vZGUgPSBhbGwpIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJOb2Rlcyh0aGF0LCBBTEwsIGFzeW5jLCBub2RlLCBbCiAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgIF0uY29uY2F0KHJlc3QpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIC8qKgogICAgVHJpZ2dlcnMgYWxsIGV2ZW50cyBvbiBhIG5vZGUuCiAgICBBbHNvIHVuYmluZHMgYW55IG5vZGUgdGhhdCBpcyBzZXQgdG8gb25seSBiZSBjYWxsZWQgb25jZS4KICAgIAogICAgQG1ldGhvZCB0cmlnZ2VyTm9kZXMKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gdGhhdCBUaGUgZXZlbnQgY29udGFpbmVyIGNvbnRleHQuCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnQgVGhlIGV2ZW50IHRvIGJlIGJvdW5kIG9yIHVuYm91bmQuCiAgICBAcGFyYW0ge0Jvb2xlYW59IGFzeW5jIEZpcmUgZXZlbnQgYXN5bmMgb3Igc3luYwogICAgQHBhcmFtIHtPYmplY3R9IG5vZGUgVGhlIG5vZGUgbGlua2VkIGxpc3QuCiAgICBAcGFyYW0ge0FycmF5fSBhcmdzIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSB0cmlnZ2VyZWQgbm9kZXMKICAgIAogICAgKiovCiAgICBmdW5jdGlvbiB0cmlnZ2VyTm9kZXModGhhdCwgZXZlbnQsIGFzeW5jLCBub2RlTGlzdCwgYXJncykgewogICAgICAgIHZhciB0YWlsLCBvbmNlTm9kZXMgPSBbXTsKICAgICAgICBmYWxzZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ3swfTogdHJpZ2dlcmluZyB7MX0gZXZlbnQgInsyfSInLCB0aGF0Ll9fcHViU3ViTmFtZSwgYXN5bmMgJiYgJ2FzeW5jJyB8fCAnJywgZXZlbnQpKTsKICAgICAgICBlYWNoKG5vZGVMaXN0LCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgICAgICB3aGlsZSgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJDYWxsYmFjayhhc3luYywgbm9kZS5jYWxsYmFjaywgbm9kZS5jb250ZXh0IHx8IHRoYXQsIGFyZ3MpOwogICAgICAgICAgICAgICAgbm9kZS5vbmNlICYmIG9uY2VOb2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgaWYob25jZU5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICBlYWNoKG9uY2VOb2RlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHRoYXQudW5zdWJzY3JpYmUoZXZlbnQsIHguY2FsbGJhY2ssIHguY29udGV4dCwgeC5uYW1lc3BhY2UpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIEludm9rZXMgYSB0cmlnZ2VyIGNhbGxiYWNrCiAgICAKICAgIEBtZXRob2QgdHJpZ2dlckNhbGxiYWNrCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtCb29sZWFufSBhc3luYyBGaXJlIGV2ZW50IGFzeW5jIG9yIHN5bmMKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QKICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjYWxsaW5nIGNvbnRleHQKICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBjYWxsIHRoZSBjYWxsYmFjayB3aXRoLgogICAgQHJldHVybnMge09iamVjdH0gVGhlIHJldHVybmVkIHZhbHVlLgogICAgRm9yIGFzeW5jIGNhbGxzLCB0aGlzIGlzIGEgcHJvbWlzZQogICAgRm9yIHN5bmMgY2FsbHMgdGhpcyBpcyB0aGUgdmFsdWUgZnJvbSB0aGUgbWV0aG9kLgogICAgKiovCiAgICBmdW5jdGlvbiB0cmlnZ2VyQ2FsbGJhY2soYXN5bmMsIGNhbGxiYWNrLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgICAgaWYoYXN5bmMpIHsKICAgICAgICAgICAgZGVmZXIodHJpZ2dlckFzeW5jQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQsIGFyZ3MpLCAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0cnkgIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgaWYodENvbmZpZy50aHJvd0Vycm9ycykgewogICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIENyZWF0ZXMgYW4gYXN5bmMgZXZlbnQgaGFuZGxlcgogICAgCiAgICBAbWV0aG9kIGFzeW5jRXZlbnRGYWN0b3J5CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZAogICAgQHBhcmFtIHtPYmplY3R9IHRoYXQgVGhlIGNhbGxpbmcgY29udGV4dAogICAgQHBhcmFtIHtBcnJheX0gYXJncyBUaGUgYXJndW1lbnRzIHRvIGNhbGwgdGhlIGNhbGxiYWNrIHdpdGguCiAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBjYWxsYmFjayBmb3IgdGhlIGdpdmVuIGFyZ3VtZW50cy4KICAgICoqLwogICAgZnVuY3Rpb24gdHJpZ2dlckFzeW5jQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQsIGFyZ3MpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgUmVzdWJzY3JpYmVzIHRvIHRoZSBhcHByb3ByaWF0ZSBldmVudHMKICAgIAogICAgQG1ldGhvZCBfb2ZmUHJvY2Vzc05vZGUKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gdGhhdCBUaGUgZXZlbnQgY29udGV4dAogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBldmVudAogICAgQHBhcmFtIHtPYmplY3R9IG5vZGUgVGhlIG5vZGUgbGlua2VkIGxpc3QuCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBldmVudCBjYWxsYmFjayB0byB1bnN1YnNjcmliZQogICAgQHBhcmFtIHtPYmplY3R9IFtjb250ZXh0XSBUaGUgZXZlbnQgY29udGV4dCB0byB1bnN1YnNjcmliZQogICAgQHBhcmFtIHtTdHJpbmd9IFtuYW1lc3BhY2VdIFRoZSBuYW1lc3BhY2UgdG8gdW5zdWJzY3JpYmUKICAgICoqLwogICAgZnVuY3Rpb24gX29mZlByb2Nlc3NOb2RlKHRoYXQsIGV2ZW50LCBub2RlLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIHZhciB0YWlsLCBjYiwgY3R4LCBuczsKICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgIHdoaWxlKChub2RlID0gbm9kZS5uZXh0KSAhPT0gdGFpbCkgewogICAgICAgICAgICBjYiA9IG5vZGUuY2FsbGJhY2s7CiAgICAgICAgICAgIGN0eCA9IG5vZGUuY29udGV4dDsKICAgICAgICAgICAgbnMgPSBub2RlLm5hbWVzcGFjZTsKICAgICAgICAgICAgaWYoKGNhbGxiYWNrICYmIGNiICE9PSBjYWxsYmFjaykgfHwgKGNvbnRleHQgJiYgY3R4ICE9PSBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgdGhhdC5zdWJzY3JpYmUoZXZlbnQgKyAobnMgJiYgKCcuJyArIG5zKSB8fCAnJyksIGNiLCBjdHgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBHZXRzIHRoZSBuYW1lc3BhY2UgaW5mb3JtYXRpb24sIHRoZSByZWFsIGV2ZW50IHRvIHBhc3MgYmFjayBvbnRvIHRoZSBtZXRob2RzLgogICAgCiAgICBAbWV0aG9kIGdldE5hbWVzcGFjZURhdGEKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnQgVGhlIGV2ZW50IHRvIGNhcHR1cmUgbmFtZXNwYWNlIGRhdGEgZnJvbS4KICAgIEByZXR1cm5zIHtPYmplY3R9IENvbnRhaW5pbmcgZXZlbnQgYW5kIG5hbWVzcGFjZS4KICAgICoqLwogICAgZnVuY3Rpb24gZ2V0TmFtZXNwYWNlRGF0YShldmVudCkgewogICAgICAgIHZhciBuc0luZGV4ID0gKGV2ZW50IHx8ICcnKS5pbmRleE9mKCcuJyksIGhhc05zID0gbnNJbmRleCA+IC0xLCBuYW1lc3BhY2UgPSBoYXNOcyA/IGV2ZW50LnN1YnN0cmluZyhuc0luZGV4ICsgMSkgOiB1bmRlZmluZWQsIGV2ZW50ID0gaGFzTnMgPyBldmVudC5zdWJzdHJpbmcoMCwgbnNJbmRleCkgOiBldmVudDsKICAgICAgICBpZihuc0luZGV4ID09PSAwKSB7CiAgICAgICAgICAgIGV2ZW50ID0gU1RBUkFMTDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LAogICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZQogICAgICAgIH07CiAgICB9CiAgICAvKioKICAgIFRocnVzdCBFdmVudHMgYXJlIGJhc2VkIG9mZiBvZiB0aGUgQmFja2JvbmUgZXZlbnQgbW9kZWwsIHdpdGggc3BlY2lhbCBhZGRpdGlvbnMuCiAgICAKICAgICogRXZlbnRzIGNhbiBiZSBmaXJlZCBhc3luY3Jvbm91c2x5LgogICAgKiBFdmVudHMgY2FuIGJlIG5hbWVzcGFjZWQuCiAgICAKICAgIEBjbGFzcyB0aHJ1c3QuRXZlbnRzCiAgICAqKi8KICAgIGV4cG9ydHMuRXZlbnRzID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZXZlbnRzID0gewogICAgICAgICAgICBzdWJzY3JpYmU6IC8qKgogICAgICAgICAgICBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIGBldmVudHNgLCB0byBhIGBjYWxsYmFja2AKICAgICAgICAgICAgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICAgICAgICAgIAogICAgICAgICAgICBAbWV0aG9kIHN1YnNjcmliZQogICAgICAgICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnRzIFNwYXZlIHNlcGVyYXRlZCBldmVudHMKICAgICAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnRzIGFyZSBmaXJlZC4KICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gYmluZCB0aGUgY2FsbGluZyBmdW5jdGlvbiB0by4KICAgICAgICAgICAgQHBhcmFtIHtCb29sZWFufSBvbmNlIENhbGwgdGhpcyBldmVudCBvbmx5IG9uY2UuCiAgICAgICAgICAgIEBjaGFpbmFibGUKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbHMsIGV2ZW50LCBub2RlLCB0YWlsLCBsaXN0LCBuZDsKICAgICAgICAgICAgICAgIHRoaXMuX19uYW1lc3BhY2UgJiYgKGV2ZW50cyA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoaXMuX19uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgICAgICAgICAgIGNhbGxzID0gdGhpcy5fY2FsbGJhY2tzIHx8ICh0aGlzLl9jYWxsYmFja3MgPSB7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhbiBpbW11dGFibGUgY2FsbGJhY2sgbGlzdCwgYWxsb3dpbmcgdHJhdmVyc2FsIGR1cmluZwogICAgICAgICAgICAgICAgLy8gbW9kaWZpY2F0aW9uLiAgVGhlIHRhaWwgaXMgYW4gZW1wdHkgb2JqZWN0IHRoYXQgd2lsbCBhbHdheXMgYmUgdXNlZAogICAgICAgICAgICAgICAgLy8gYXMgdGhlIG5leHQgbm9kZS4KICAgICAgICAgICAgICAgIHdoaWxlKGV2ZW50ID0gZXZlbnRzQXJyYXkuc2hpZnQoKSkgewogICAgICAgICAgICAgICAgICAgIG5kID0gZ2V0TmFtZXNwYWNlRGF0YShldmVudCk7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSBuZC5ldmVudDsKICAgICAgICAgICAgICAgICAgICBsaXN0ID0gY2FsbHNbZXZlbnRdIHx8IChjYWxsc1tldmVudF0gPSB7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgbGlzdCA9IGxpc3RbbmQubmFtZXNwYWNlXTsKICAgICAgICAgICAgICAgICAgICBub2RlID0gbGlzdCA/IGxpc3QudGFpbCA6IG5ldyBFdmVudE5vZGUoKTsKICAgICAgICAgICAgICAgICAgICBub2RlLm5leHQgPSB0YWlsID0gbmV3IEV2ZW50Tm9kZSgpOwogICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGV4dCA9IGNvbnRleHQgfHwgdGhpcy5fX2RlZmF1bHRDb250ZXh0IHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBub2RlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgICAgaWYobmQubmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubmFtZXNwYWNlID0gbmQubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZihvbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUub25jZSA9IG9uY2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhbGxzW2V2ZW50XVtuZC5uYW1lc3BhY2VdID0gewogICAgICAgICAgICAgICAgICAgICAgICB0YWlsOiB0YWlsLAogICAgICAgICAgICAgICAgICAgICAgICBuZXh0OiBsaXN0ID8gbGlzdC5uZXh0IDogbm9kZQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25jZTogLyoqCiAgICAgICAgICAgIEJpbmQgb25lIG9yIG1vcmUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50cywgYGV2ZW50c2AsIHRvIGEgYGNhbGxiYWNrYAogICAgICAgICAgICBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8gYWxsIGV2ZW50cyBmaXJlZC4KICAgICAgICAgICAgCiAgICAgICAgICAgIEVhY2ggZXZlbnQgd2lsbCBvbmx5IGJlIGNhbGxlZCBvbmNlLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBvbmNlCiAgICAgICAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgU3BhdmUgc2VwZXJhdGVkIGV2ZW50cwogICAgICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudHMgYXJlIGZpcmVkLgogICAgICAgICAgICBAcGFyYW0ge09iamVjdH0gY29udGV4dCBUaGUgY29udGV4dCB0byBiaW5kIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIHRvLgogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3Vic2NyaWJlKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIHRydWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN1YnNjcmliZTogLyoqCiAgICAgICAgICAgIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbCBjYWxsYmFja3MKICAgICAgICAgICAgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGNhbGxiYWNrcyBmb3IgdGhlCiAgICAgICAgICAgIGV2ZW50LiBJZiBgZXZlbnRgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgdW5zdWJzY3JpYmUKICAgICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50cyBTcGF2ZSBzZXBlcmF0ZWQgZXZlbnRzCiAgICAgICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50cyBhcmUgZmlyZWQuCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGJpbmQgdGhlIGNhbGxpbmcgZnVuY3Rpb24gdG8uCiAgICAgICAgICAgIEBjaGFpbmFibGUKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnQsIGNhbGxzLCBub2RlLCBuZCwgb3VyTnMsIG5hbWVzcGFjZSwgdGhhdCA9IHRoaXMsIGhhc05zOwogICAgICAgICAgICAgICAgb3VyTnMgPSB0aGF0Ll9fbmFtZXNwYWNlOwogICAgICAgICAgICAgICAgb3VyTnMgJiYgKG91ck5zID0gb3VyTnMuc3Vic3RyaW5nKDEpKTsKICAgICAgICAgICAgICAgIC8vIE5vIGV2ZW50cywgb3IgcmVtb3ZpbmcgKmFsbCogZXZlbnRzLgogICAgICAgICAgICAgICAgaWYoIShjYWxscyA9IHRoYXQuX2NhbGxiYWNrcykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZighKGV2ZW50cyB8fCBjYWxsYmFjayB8fCBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgIGlmKCFvdXJOcykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhhdC5fY2FsbGJhY2tzOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYnMgPSB0aGF0Ll9jYWxsYmFja3M7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSBpbiBjYnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYnNbaV1bb3VyTnNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2l6ZShjYnNbaV0pID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNic1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIExvb3AgdGhyb3VnaCB0aGUgbGlzdGVkIGV2ZW50cyBhbmQgY29udGV4dHMsIHNwbGljaW5nIHRoZW0gb3V0IG9mIHRoZQogICAgICAgICAgICAgICAgLy8gbGlua2VkIGxpc3Qgb2YgY2FsbGJhY2tzIGlmIGFwcHJvcHJpYXRlLgogICAgICAgICAgICAgICAgb3VyTnMgJiYgKGV2ZW50cyA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoYXQuX19uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cyA/IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKSA6IF8ua2V5cyhjYWxscyk7CiAgICAgICAgICAgICAgICB3aGlsZShldmVudCA9IGV2ZW50c0FycmF5LnNoaWZ0KCkpIHsKICAgICAgICAgICAgICAgICAgICBuZCA9IGdldE5hbWVzcGFjZURhdGEoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gbmQuZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlID0gbmQubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIGhhc05zID0gISFuYW1lc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgaWYoIW91ck5zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGNhbGxzW2V2ZW50XSkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbZXZlbnRdW291ck5zXTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XVtvdXJOc107CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNpemUoY2FsbHNbZXZlbnRdKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZighbm9kZSB8fCAhKGNhbGxiYWNrIHx8IGNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvKmlmIChldmVudCAhPT0gU1RBUkFMTCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgIGlmICghbm9kZSkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfSovCiAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnQgIT09IFNUQVJBTEwgJiYgIWNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBldmVudCwgbm9kZSwgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihldmVudCA9PT0gQUxMIHx8ICFjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgaW4gY2FsbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGhhc05zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBpLCBub2RlLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBfb2ZmUHJvY2Vzc05vZGUodGhhdCwgZXZlbnQsIG5vZGUsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX19wdWJTdWJOYW1lOiAvKioKICAgICAgICAgICAgVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAgICAgICAgIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAgICAgICAgICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgICAgICAgICAgcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBmaXJlCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgVGhlIGV2ZW50cyB0byBiZSBmaXJlZC4KICAgICAgICAgICAgZGVsaW1pdGVkIGJ5IGEgc3BhY2UuCiAgICAgICAgICAgIEBwYXJhbSBbYXJnc10qIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBjYWxsYmFjayBtZXRob2RzLgogICAgICAgICAgICBAcmV0dXJucyB7QXJyYXkgb2YgVmFsdWVzfSBJZiBtb3JlIHRoYW4gb24gZXZlbnQgaXMgZmlyZWQsIGFuIE9iamVjdCBvZiBBcnJheXMgaXMgcmV0dXJuZWQuCiAgICAgICAgICAgICoqLwogICAgICAgICAgICAnRXZlbnRzJywKICAgICAgICAgICAgaW5pdEV2ZW50czogLyoqCiAgICAgICAgICAgIEluaXQncyB0aGUgRXZlbnQgbW9kdWxlLgogICAgICAgICAgICBUaGlzIGlzIG9ubHkgcmVxdWlyZWQgaWYgeW91IHdpc2ggdG8gdXNlIGZpcmUuYXN5bmMsIGFuZCBuYW1lc3BhY2luZy4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgaW5pdEV2ZW50cwogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZGVmYXVsdENvbnRleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZSA9IHRoaXMucHVibGlzaCA9IGNyZWF0ZUFzeW5jRXZlbnQodGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLmluaXRFdmVudHMgPSBub29wOwogICAgICAgICAgICAgICAgdGhpcy5fX3B1YlN1Yk5hbWUgPSB0aGlzLm5hbWUgfHwgJ0V2ZW50cyc7CiAgICAgICAgICAgICAgICBpZih0aGlzLm5hbWUgJiYgIXRoaXMuX19uYW1lc3BhY2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9fbmFtZXNwYWNlID0gJy4nICsgdGhpcy5uYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fX2RlZmF1bHRDb250ZXh0ID0gZGVmYXVsdENvbnRleHQ7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZXh0ZW5kOiAvKioKICAgICAgICAgICAgRXh0ZW5kcyBFdmVudHMgaW50byB0aGUgZ2l2ZW4gb2JqZWN0LgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBleHRlbmQKICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IHRvIFRoZSBvYmplY3Qgb3QgZXh0ZW5kIGV2ZW50cyBvbnRvCiAgICAgICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gW2luaXRdIE9wdGlvbmFsbHkgaW5pdCB0aGUgZXZlbnRzLgogICAgICAgICAgICAqKi8KICAgICAgICAgICAgZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgICAgICBfLmV4dGVuZCh0bywgZXhwb3J0cy5FdmVudHMpOwogICAgICAgICAgICAgICAgZGVsZXRlIHRvLmV4dGVuZDsKICAgICAgICAgICAgICAgIGluaXQgJiYgdG8uaW5pdEV2ZW50cygpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRvOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBldmVudHMuZmlyZSA9IGV2ZW50cy5wdWJsaXNoID0gY3JlYXRlQXN5bmNFdmVudCh7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGV2ZW50czsKICAgIH0pKCk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWV2ZW50cy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9mYWNhZGUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJy4vY2Fwc3VsZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX190bV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgdG0gPSBfX3RtX187CgogICAgdmFyIE1vZHVsZSA9IHRtLk1vZHVsZTsKICAgIC8qKgogICAgCiAgICBUaGUgRmFjYWRlIG1vZHVsZSBvZmZlcnMgdGhlIGFiaWxpdHkgdG8gY3JlYXRlIGFuIGludGVyZmFjZSBvciBzaW1pbGFyIGNvbmNlcHQuCiAgICBXaXRoIHRoZSBGYWNhZGUgaW4gdGhydXN0LCBpdCBhbGxvd3MgeW91IHRvIGNhcHR1cmUgZXZlbnRzIGZyb20gYSBtb2R1bGUsIHdoZW4gbG9hZGVkIHZpYSBjb252ZW50aW9uLgogICAgRmFjYWRlcyBhcmUgbWFpbmx5IGZvciB1c2UgaW4gdGhydXN0IHBsdWdpbnMuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlcyBhcmUgbWFpbmx5IGZvciB1c2UgaW4gdGhydXN0IHBsdWdpbnMuCiAgICAKICAgIEZhY2FkZSBoYXMgdGhlc2UgYnVpbHQgaW4gbWV0aG9kczoKICAgICogaW5pdAogICAgKiBzdGFydAogICAgKiByZWFkeQogICAgKiBzdG9wCiAgICAqIGRlc3Ryb3kKICAgIAogICAgQmVoaW5kIHRoZSBzY2VuZXMgdGhlIGZhY2FkZSBtZXRob2RzLCBpbnZva2UgYW55IGNvbnZlbnRpb25zIGxvYWRlZCBmb3IgdGhlIHBsdWdpbi4KICAgIAogICAgQGNsYXNzIHRocnVzdC5GYWNhZGUKICAgICoqLwogICAgdmFyIHRocnVzdENhY2hlID0gTW9kdWxlLnRocnVzdENhY2hlOwogICAgdmFyIGZhY2FkZU1ldGhvZHMgPSBbCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnc3RhcnQnLCAKICAgICAgICAncmVhZHknLCAKICAgICAgICAnc3RvcCcsIAogICAgICAgICdkZXN0cm95JwogICAgXSwgZGVmYXVsdFByb3RvdHlwZSA9IHsKICAgIH07CiAgICBmdW5jdGlvbiBjb252ZW50aW9uRnVuY3Rpb25GYWN0b3J5KG5hbWUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcmV0dXJuVmFsdWVzID0gW107CiAgICAgICAgICAgIGlmKG0gJiYgISgobSkuY29udmVudGlvbikpIHsKICAgICAgICAgICAgICAgIG0gPSB0aHJ1c3RDYWNoZVttLm1pZF0ubW9kdWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoYXQuX19jb252ZW50aW9ucykgewogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIG5hbWUsIG0sIHRoYXQpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIG1ldGhvZFdyYXAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgZi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9OwogICAgfQogICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGZhY2FkZU1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IGZhY2FkZU1ldGhvZHNbaV07CiAgICAgICAgZGVmYXVsdFByb3RvdHlwZVttZXRob2RdID0gY29udmVudGlvbkZ1bmN0aW9uRmFjdG9yeShtZXRob2QpOwogICAgfQogICAgLyoqCiAgICBGYWNhZGUgaW5pdAogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgaW5pdAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgc3RhcnQKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgc3RhcnQgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KICAgIAogICAgQG1ldGhvZCBzdGFydAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgcmVhZHkKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgcmVhZHkgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KICAgIAogICAgQG1ldGhvZCByZWFkeQogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgc3RvcAogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2Qgc3RvcAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgZGVzdHJveQogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBkZXN0cm95IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgZGVzdHJveQogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBtb2R1bGUgaW5zdGFuY2UKICAgIAogICAgRm9ybWF0OgogICAgdGhydXN0L2NhcHN1bGUhe2luc3RhbmNlfTp7cGx1Z2luTmFtZX06e2hhc2hLZXl9CiAgICAKICAgIGhhc0tleTogaXMgYSB1bmlxdWUga2V5LCB0aGF0IHRoZSBtb2R1bGUgc2hhcmVzIHdpdGggdGhlIGZhY2FkZSwgYWxsb3dzIGZvciBkZWZpbmluZyBkZXBlbmRlbmNpZXMKICAgIGluIHlvdXIgZGVmaW5lIGJsb2NrLCBhbmQgZ2V0IGFjY2VzcyB0byB0aGUgbW9kdWxlcyBmYWNhZGUuCiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQG9ic29sZXRlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgZnVuY3Rpb24gbG9hZChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksIGluc3RhbmNlTmFtZSA9IHBhcnRzWzBdLCBwbHVnaW4gPSBwYXJ0c1sxXSwgcGx1Z2luTmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxIHx8IDApLCBoYXNoS2V5ID0gcGFydHNbMl07CiAgICAgICAgaWYoIWluc3RhbmNlTmFtZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2luc3RhbmNlTmFtZSBpcyByZXF1aXJlZCEnKTsKICAgICAgICB9CiAgICAgICAgaWYoIXBsdWdpbk5hbWUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwbHVnaW5OYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgIH0KICAgICAgICBpZighaGFzaEtleSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2hhc2hLZXkgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgfQogICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAndGhydXN0IScgKyBpbnN0YW5jZU5hbWUKICAgICAgICBdLCBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciB0aHJ1c3RQbHVnaW4gPSB0aHJ1c3RbcGx1Z2luTmFtZV07CiAgICAgICAgICAgIGlmKCF0aHJ1c3RQbHVnaW4pIHsKICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgIHBsdWdpbgogICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKHApIHsKICAgICAgICAgICAgICAgICAgICBsb2FkKHApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRocnVzdE1vZHVsZUNhY2hlSXRlbSA9IHRocnVzdENhY2hlW2hhc2hLZXldIHx8ICh0aHJ1c3RDYWNoZVtoYXNoS2V5XSA9IHsKICAgICAgICAgICAgICAgIGZhY2FkZXM6IHsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnN0YW5jZTogewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIGZhY2FkZSA9IHRocnVzdFBsdWdpbi5jcmVhdGVGYWNhZGUodGhydXN0LCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbS5mYWNhZGVzKTsKICAgICAgICAgICAgbG9hZChmYWNhZGUpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKICAgIGZ1bmN0aW9uIGNyZWF0ZUZhY2FkZShpbml0TWV0aG9kKSB7CiAgICAgICAgdmFyIGYgPSAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgRmFjYWRlID0gZnVuY3Rpb24gKG1vZCkgewogICAgICAgICAgICAgICAgaW5pdE1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGZhY2FkZU1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGZhY2FkZU1ldGhvZHNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYodGhpc1ttZXRob2RdICE9PSBkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1ttZXRob2RdID0gXy53cmFwKHRoaXNbbWV0aG9kXSwgbWV0aG9kV3JhcChkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLm1vZCA9IG1vZDsKICAgICAgICAgICAgICAgIC8vdGhpcy5pbml0KG1vZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICBGYWNhZGUucHJvdG90eXBlID0gXy5leHRlbmQoewogICAgICAgICAgICAgICAgdXBkYXRlRmFjYWRlOiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgICAgICAgICBpbml0TWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGRlZmF1bHRQcm90b3R5cGUpOwogICAgICAgICAgICByZXR1cm4gRmFjYWRlOwogICAgICAgIH0pKCk7CiAgICAgICAgcmV0dXJuIGY7CiAgICB9CiAgICBleHBvcnRzLmNyZWF0ZUZhY2FkZSA9IGNyZWF0ZUZhY2FkZTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZmFjYWRlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2NvbnZlbnRpb24vYXV0b3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbiddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAvKioKICAgICogIyBfX3RocnVzdC9tZWRpYXRvcl9fIENvbnZlbnRpb24gLSBBdXRvIFN0YXJ0CiAgICAqCiAgICAqIFRoZSBhdXRvIHN0YXJ0IHByb3BlcnR5IGFsbG93cyBmb3IgYSBtb2R1bGUsIHRvIGJlIGF1dG9tYXRpY2FsbHkgc3RhcnRlZCBvbmNlIGl0IGlzCiAgICAqIGluY2x1ZGVkIGludG8gYSB0aHJ1c3QgaW5zdG5hY2UsIHdpdGhvdXQgaGF2aW5nIHRvIGV4cGxpY2l0eSBjYWxsIHN0YXJ0IG9uIHRoZSBtb2R1bGUuCiAgICAqCiAgICAqCiAgICAqIFRoaXMgaXMgdXNlZnVsIGZvciBjZXJ0aWFuIHR5cGVzIG9mIG1vZHVsZXMsIHVzdWFsbHkgcGVyc2lzdGFudCBvbmVzIHRoYXQgYWx3YXlzIG5lZWQgdG8gbG9hZCByZWdhcmRsZXNzLgogICAgKiBGb3IgZXhhbXBsZSBhIG5hdmlnYXRpb24gbW9kdWxlLCBvciB1c2VyIHNldHRpbmdzIG1vZHVsZS4KICAgICoKICAgICogQGZvciB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgYXV0b1N0YXJ0CiAgICAqKi8KICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgJ2NvbmZpZy5hdXRvU3RhcnQnCiAgICAgICAgXQogICAgfTsKICAgIGV4cG9ydHMuYXV0b3N0YXJ0ID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWF1dG9zdGFydC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lcicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIGFueUNvbnRhaW5lcjogJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lci9hbnknLAogICAgICAgIGNoYW5nZUNvbnRhaW5lcjogJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lci9jaGFuZ2UnCiAgICB9LCBhbnkgPSBfLmFueSwgYmluZCA9IF8uYmluZCwgQ09OVEFJTkVSID0gJ2NvbmZpZy5jb250YWluZXInLCBTVEFSVCA9ICdzdGFydC1zdGF0dXMnLCBkZWZlciA9IF8uZGVmZXI7CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIENPTlRBSU5FUgogICAgICAgIF0sCiAgICAgICAgY2hhbmdlOiBmdW5jdGlvbiAobW9kLCBjb250YWluZXIpIHsKICAgICAgICAgICAgdmFyIGNvbnRhaW5lclZhbHVlID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKTsKICAgICAgICAgICAgaWYoY29udGFpbmVyVmFsdWUgJiYgY29udGFpbmVyICYmIGNvbnRhaW5lclZhbHVlID09PSBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGlmKG1vZC5jb252ZW50aW9uKFNUQVJUKSkgewogICAgICAgICAgICAgICAgICAgIGRlZmVyKGJpbmQobW9kLnN0b3AsIG1vZCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGNvbnRhaW5lclZhbHVlID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKTsKICAgICAgICAgICAgaWYoY29udGFpbmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMubWVkaWF0b3IuZmlyZShldmVudC5jaGFuZ2VDb250YWluZXIsIGNvbnRhaW5lclZhbHVlKTsKICAgICAgICAgICAgICAgIC8vIFN1YnNjcmlwdGlvbnMgZ2V0IHVuc3Vic2NyaWJlZCB3aGVuIHN0b3BwaW5nIGEgbW9kdWxlLCBzbyB3ZSBuZWVkIHRvIHJlc3Vic2NyaWJlIGV2ZXJ5IHRpbWUgaGVyZS4KICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgcHJvYmFibHkgYmV0dGVyLCBhcyB0aGUgZXZlbnRzIHdpbGwgYmUgbGVzcyBjaGF0dHkuCiAgICAgICAgICAgICAgICBmYWNhZGVzLm1lZGlhdG9yLnN1YnNjcmliZShldmVudC5jaGFuZ2VDb250YWluZXIsIGJpbmQodGhhdC5jaGFuZ2UsIHRoYXQsIG1vZCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuY29udGFpbmVyID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbnRhaW5lci5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2RlcGVuZGVudC5tb2R1bGVzJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0Lm1lZGlhdG9yCiAgICBAc3VibW9kdWxlIHRocnVzdC5tZWRpYXRvci5jb252ZW50aW9uCiAgICAqKi8KICAgICAgICB2YXIgYW55ID0gXy5hbnksIG1hcCA9IF8ubWFwLCBETU9EVUxFUyA9ICdjb25maWcuZGVwZW5kZW50TW9kdWxlcycsIENNT0RVTEVTID0gJ2NvbmZpZy5jaGlsZE1vZHVsZXMnLCBTVEFSVCA9ICdzdGFydC1zdGF0dXMnLCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQ7CiAgICB2YXIgaW52b2tlZGVwZW5kZW50TW9kdWxlcyA9IGZ1bmN0aW9uIChtb2QsIG1ldGhvZCkgewogICAgICAgIHZhciByZXF1aXJlZE1vZHVsZXMgPSBtb2QuY29udmVudGlvbihETU9EVUxFUyk7CiAgICAgICAgaWYocmVxdWlyZWRNb2R1bGVzKSB7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0W21ldGhvZF0ocmVxdWlyZWRNb2R1bGVzKTsKICAgICAgICB9CiAgICB9OwogICAgdmFyIGludm9rZUNoaWxkTW9kdWxlcyA9IGZ1bmN0aW9uIChtb2QsIG1ldGhvZCkgewogICAgICAgIHZhciByZXF1aXJlZE1vZHVsZXMgPSBtb2QuY29udmVudGlvbihDTU9EVUxFUyk7CiAgICAgICAgaWYocmVxdWlyZWRNb2R1bGVzKSB7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0W21ldGhvZF0ocmVxdWlyZWRNb2R1bGVzKTsKICAgICAgICB9CiAgICB9OwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBETU9EVUxFUywgCiAgICAgICAgICAgIENNT0RVTEVTCiAgICAgICAgXSwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgaW52b2tlZGVwZW5kZW50TW9kdWxlcyhtb2QsICdzdGFydCcpLCAKICAgICAgICAgICAgICAgIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdzdGFydCcpCiAgICAgICAgICAgIF07CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZighbW9kLnRocnVzdC5zdGFydGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgIGludm9rZWRlcGVuZGVudE1vZHVsZXMobW9kLCAncmVhZHknKSwgCiAgICAgICAgICAgICAgICAgICAgaW52b2tlQ2hpbGRNb2R1bGVzKG1vZCwgJ3JlYWR5JykKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdzdG9wJyk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIHJldHVybiBpbnZva2VDaGlsZE1vZHVsZXMobW9kLCAnZGVzdHJveScpOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmRlcGVuZGVudE1vZHVsZXMgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZGVwZW5kZW50Lm1vZHVsZXMuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnY2ZnJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L21lZGlhdG9yLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nCiAgICBdOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9jb252ZW50aW9uL3N1YnNjcmlwdGlvbi5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgVGhlIGZhY2FkZSBjb252ZW50aW9uLCBjcmVhdGVzIHRoZSBtZWRpYXRvciBmYWNhZGUgZm9yIGVhY2ggbW9kdWxlLgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIFNVQlNDUklQVElPTlMgPSAnY29uZmlnLm1lZGlhdG9yLnN1YnNjcmlwdGlvbnMnLCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBpc1N0cmluZyA9IF8uaXNTdHJpbmcsIGlzQXJyYXkgPSBfLmlzQXJyYXksIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgaXNQbGFpbk9iamVjdCA9IF8uaXNQbGFpbk9iamVjdCwgZm9yT3duID0gXy5mb3JPd24sIGVhY2ggPSBfLmVhY2g7CiAgICB2YXIgYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciA9IFsKICAgICAgICAnaGFuZGxlcicsIAogICAgICAgICdjb250ZXh0JwogICAgXTsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgU1VCU0NSSVBUSU9OUwogICAgICAgIF0sCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgc3Vic2NyaXB0aW9ucyA9IG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpOwogICAgICAgICAgICBpZihzdWJzY3JpcHRpb25zICYmICEoc3Vic2NyaXB0aW9ucykuX3N1YnNjcmlwdGlvbnNTZXQpIHsKICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgICAgIGZvck93bihzdWJzY3JpcHRpb25zLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uQ29sbGVjdGlvbiwgc3Vic2NyaXB0aW9uTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmKCFpc0FycmF5KHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihzdWJzY3JpcHRpb25Db2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoc3Vic2NyaXB0aW9uQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoc3Vic2NyaXB0aW9uQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25Db2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVhY2goc3Vic2NyaXB0aW9uQ29sbGVjdGlvbiwgZnVuY3Rpb24gKHN1YnNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KHN1YnNjcmlwdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vbmV3U3Vic2NyaXB0aW9uLnB1c2guYXBwbHkobmV3U3Vic2NyaXB0aW9uLCBzdWJzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWFjaChzdWJzY3JpcHRpb24sIGZ1bmN0aW9uIChoYW5kbGVyT2JqZWN0LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1N1YnNjcmlwdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uTmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcoaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3RdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc3Vic2NyaXB0aW9uW2kgKyAxXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goc3Vic2NyaXB0aW9uW2kgKyAxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9yZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzRnVuY3Rpb24oaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goaGFuZGxlck9iamVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbltpICsgMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKHN1YnNjcmlwdGlvbltpICsgMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc1BsYWluT2JqZWN0KGhhbmRsZXJPYmplY3QpICYmICgnbW9kdWxlSGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCB8fCAnaGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9uZXdTdWJzY3JpcHRpb24gPSBbc3Vic2NyaXB0aW9uTmFtZV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdtb2R1bGVIYW5kbGVyJyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChtb2QuaW5zdGFuY2VbaGFuZGxlck9iamVjdC5tb2R1bGVIYW5kbGVyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoJ2hhbmRsZXInIGluIGhhbmRsZXJPYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKGhhbmRsZXJPYmplY3QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3QuaGFuZGxlcl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChoYW5kbGVyT2JqZWN0LmhhbmRsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdjb250ZXh0JyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChoYW5kbGVyT2JqZWN0LmNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5ld1N1YnNjcmlwdGlvbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhY2FkZS5zdWJzY3JpYmUuYXBwbHkoZmFjYWRlLCBuZXdTdWJzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpLl9zdWJzY3JpcHRpb25zU2V0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBzdWJzY3JpcHRpb25zID0gbW9kLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUyk7CiAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbnMgJiYgc3Vic2NyaXB0aW9ucy5fc3Vic2NyaXB0aW9uc1NldCkgewogICAgICAgICAgICAgICAgbW9kLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUykuX3N1YnNjcmlwdGlvbnNTZXQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnN1YnNjcmlwdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdWJzY3JpcHRpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFByb3ZpZGVzIHRocnVzdCBjb25maWd1cmF0aW9uCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LmRhdGEKICAgIEBzdWJtb2R1bGUgdGhydXN0LmRhdGEuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicsIAogICAgICAgICdjZmcnCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvZG9tLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvZGF0YS9jb252ZW50aW9uL3N0YXJ0JwogICAgXTsKICAgIC8qKgogICAgRGVjaWRlcyBpZiBgdGhydXN0L2RhdGFgIHNob3VsZCBjYWNoZSByZXF1ZXN0cyBvciBub3QuCiAgICAKICAgIFlvdSBzaG91bGQgdHVybiB0aGlzIHRvIGBmYWxzZWAsIGlmIHlvdSBhcmUgZXhwZXJpZW5jaW5nIGNhY2hpbmcgaXNzdWVzIGFuZCBuZWVkIHRvIGRlYnVnLgogICAgCiAgICBAcHJvcGVydHkgY2FjaGUKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuY2FjaGUgPSB0cnVlOwogICAgLyoqCiAgICAqCiAgICAqIGBzdGFydFRpbWVvdXRgIGlzIHBhcnQgb2YgcXVldWVpbmcgYnVpbHQgaW50byBgdGhydXN0L2RhdGFgLiAgSXQgZGVmaW5lcyB0aGUgd2FpdCB0aW1lIGJlZm9yZSByZXF1ZXN0cwogICAgKiBhcmUgc3RhcnRlZC4KICAgICoKICAgICoKICAgICogVGhlIHF1ZXVlaW5nIHN5c3RlbSB3b3JrcyBpbiB0aGUgZm9sbG93aWcgbWFubmVyLiAgQWxsIHJlcXVlc3RzIHRoYXQgYXJlIHF1ZXVlZCB0b2dldGhlciBwZXIgSFRUUAogICAgKiByZXF1ZXN0IG1ldGhvZCAoYEdFVGAsIGBQT1NUYCwgYFBVVGAsIGBERUxFVEVgLCBgUEFUQ0hgLCBldGMpLiAgQWZ0ZXIgdGhlIGZpcnN0IHJlcXVlc3QsIHRoZSB0aW1lcgogICAgKiBzdGFydHMsIG9uY2UgdGhlIHRpbWVvdXQgZWxhcHNlcywgYWxsIHRoZSByZXF1ZXN0cyBhcmUgc2hpcHBlZCBvZmYgYXQgb25jZS4KICAgICoKICAgICoKICAgICogVGhpcyBjb3VudGVyIGludHVpdGl2ZSBpZiB5b3UncmUgbG9va2luZyB0byBnZXQgdGhlIHJlcXVlc3QgYmFjayBpbW1lZGlhdGVseSwgYnV0IGZyb20gYSBVWCBwZXJzcGVjdGl2ZQogICAgKiB0aGlzIGFsbG93cyB0aGUgVUkgdG8gc3RheSBpbiBzeW5jIGFuZCBnaXZlIHRoZSB1c2VyIGEgY29oZXNpdmUsIGluc3RlYWQgb2Ygc2VlaW5nIGxvYWRlcnMsIHNob3cgdXAgYW5kCiAgICAqIGRpc2FwcGVhciBhdCBzZWVtaW5nbHkgcmFuZG9tIGludGVydmFscywgdGhlIHVzZXIgZG9lcyBhbiBhY3Rpb24sIGFuZCB0aGVuIHNlZXMgYSByZXNwb25zZS4KICAgICoKICAgICoKICAgICogQHByb3BlcnR5IHN0YXJ0VGltZW91dAogICAgKiBAcmVhZE9ubHkKICAgICogQHR5cGUge051bWJlcn0KICAgICogQGRlZmF1bHQgNTAwCiAgICAqKi8KICAgIGV4cG9ydHMuc3RhcnRUaW1lb3V0ID0gMTAwOwogICAgLyoqCiAgICAqCiAgICAqIGBmaW5pc2hUaW1lb3V0YCBpcyBwYXJ0IG9mIHF1ZXVlaW5nIGJ1aWx0IGludG8gYHRocnVzdC9kYXRhYC4gIEl0IGRlZmluZXMgdGhlIHdhaXQgdGltZSBiZWZvcmUgdGhlCiAgICAqIHF1ZXVlIGlzIGNvbXBsZXRlZC4gIElmIGFsbCB0aGUgcmVxdWVzdHMgZmluaXNoIGVhcmx5LCB0aGUgdGltZW91dCBpcyBjYW5jZWxlZC4KICAgICoKICAgICoKICAgICogVGhlIHF1ZXVlaW5nIHN5c3RlbSB3b3JrcyBpbiB0aGUgZm9sbG93aWcgbWFubmVyLiAgQWxsIHJlcXVlc3RzIHRoYXQgYXJlIHF1ZXVlZCB0b2dldGhlciBwZXIgSFRUUAogICAgKiByZXF1ZXN0IG1ldGhvZCAoYEdFVGAsIGBQT1NUYCwgYFBVVGAsIGBERUxFVEVgLCBgUEFUQ0hgLCBldGMpLiAgQWZ0ZXIgdGhlIHJlcXVlc3RzIGFyZSBmaXJlZCBvZmYKICAgICogYHRocnVzdC9kYXRhYCB3aWxsIHdhaXQgdW50aWwgaXQgZ2V0cyBhIHJlc3BvbnNlIGZyb20gZXZlcnlvbmUgb2YgdGhlbS4gIElmIGZvciBzb21lIHJlYXNvbiBhIHJlcXVlc3QKICAgICogdGFrZXMgdG8gbG9uZywgYW5kIHRoZSB0aW1lb3V0IGlzIGhpdCwgYWxsIHRoZSByZXF1ZXN0cyB0aGF0IGhhdmUgY29tcGxldGVkLCB3aWxsIGJlIHJlbGVhc2VlZCwgYWxsb3dpbmcKICAgICogdGhlIGFwcGxpY2F0aW9uIHRvIGNvbnRpbnVlIHVuZGlzcnVwdGVkLgogICAgKgogICAgKgogICAgKiBUaGlzIGNvdW50ZXIgaW50dWl0aXZlIGlmIHlvdSdyZSBsb29raW5nIHRvIGdldCB0aGUgcmVxdWVzdCBiYWNrIGltbWVkaWF0ZWx5LCBidXQgZnJvbSBhIFVYIHBlcnNwZWN0aXZlCiAgICAqIHRoaXMgYWxsb3dzIHRoZSBVSSB0byBzdGF5IGluIHN5bmMgYW5kIGdpdmUgdGhlIHVzZXIgYSBjb2hlc2l2ZSwgaW5zdGVhZCBvZiBzZWVpbmcgbG9hZGVycywgc2hvdyB1cCBhbmQKICAgICogZGlzYXBwZWFyIGF0IHNlZW1pbmdseSByYW5kb20gaW50ZXJ2YWxzLCB0aGUgdXNlciBkb2VzIGFuIGFjdGlvbiwgYW5kIHRoZW4gc2VlcyBhIHJlc3BvbnNlLgogICAgKgogICAgKgogICAgQHByb3BlcnR5IGZpbmlzaFRpbWVvdXQKICAgIEByZWFkT25seQogICAgQHR5cGUge051bWJlcn0KICAgIEBkZWZhdWx0IDIwMDAKICAgICoqLwogICAgZXhwb3J0cy5maW5pc2hUaW1lb3V0ID0gMjAwMDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RhdGEvZXZlbnQudHlwZXMnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8qKgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5kYXRhCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICAqKi8KICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS93YWl0YCBldmVudCBpcyBmaXJlZCBvbmNlIGEgZGF0YSBjYWxsIGlzIG1hZGUuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS93YWl0CiAgICBAcGFyYW0ge1N0cmluZ30gcXVlcnlJZCBUaGUgaW50ZXJuYWwgaWQgb2YgdGhlIG91dGJvdW5kIHF1ZXVlLgogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIG91dGJvdW5kIGV2ZW50IHF1ZXVlIChHZXQvUG9zdC9ldGMpCiAgICAqKi8KICAgIGV4cG9ydHMud2FpdCA9ICd0aHJ1c3QvZGF0YS93YWl0JzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdGFydGAgZXZlbnQgaXMgZmlyZWQgdGhlIHF1ZXVlIGlzIHN0YXJ0ZWQuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGFydAogICAgQHBhcmFtIHtTdHJpbmd9IHF1ZXJ5SWQgVGhlIGludGVybmFsIGlkIG9mIHRoZSBvdXRib3VuZCBxdWV1ZS4KICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIHRoZSBvdXRib3VuZCBldmVudCBxdWV1ZSAoR2V0L1Bvc3QvZXRjKQogICAgQHBhcmFtIHtOdW1iZXJ9IGNvdW50IFRoZSBvdXRnb2luZyBjYWxsIGNvdW50CiAgICAqKi8KICAgIGV4cG9ydHMuc3RhcnQgPSAndGhydXN0L2RhdGEvc3RhcnQnOwogICAgLyoqCiAgICBUaGUgYHRocnVzdC9kYXRhL3N0YXR1c2AgZXZlbnQgaXMgZmlyZWQgZm9yIGV2ZXJ5IGl0ZW0gdGhhdCByZXR1cm5zIGZyb20gdGhlIHF1ZXVlLgogICAgCiAgICBOT1RFOiBJdCBpcyBlbnRpcmVseSBwb3NzaWJsZSBmb3IgYHRocnVzdC9kYXRhL3N0YXR1cyoqIHRvIGJlIGNhbGxlZCBhZnRlciBgdGhydXN0L2RhdGEvc3RvcCoqIGlmIHNldmVyYWwKICAgIGNhbGxzIHRha2UgdG8gbG9uZyB0byBjb21wbGV0ZS4gIFRoaXMgaXMgaW50ZW5kZWQsIGFuZCBwb3RlbnRpYWxseSB1c2VmdWwgaW5mb3JtYXRpb24uCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGF0dXMKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgY3VycmVudCBjb21wbGV0ZWQgY2FsbCBjb3VudCBmb3IgdGhpcyBxdWV1ZS4KICAgICoqLwogICAgZXhwb3J0cy5zdGF0dXMgPSAndGhydXN0L2RhdGEvc3RhdHVzJzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdG9wYCBldmVudCBpcyBmaXJlZCB3aGVuIGFsbCBpdGVtcyBpbiB0aGUgcXVldWUgcmV0dXJuLCBvciB0aGUgZmluaXNoZWRUaW1lb3V0IHNldHRpbmcgZWxhcHNlcy4KICAgIAogICAgQGV2ZW50IHRocnVzdC9kYXRhL3N0b3AKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgKGN1cnJlbnQpIGNvbXBsZXRlZCBjYWxsIGNvdW50IGZvciB0aGlzIHF1ZXVlLgogICAgKiovCiAgICBleHBvcnRzLnN0b3AgPSAndGhydXN0L2RhdGEvc3RvcCc7CiAgICBleHBvcnRzLmV2ZW50ID0gewogICAgICAgIGJlZm9yZVNlbmQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvYmVmb3JlLXNlbmRgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9iZWZvcmUtc2VuZAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L2JlZm9yZS1zZW5kJywKICAgICAgICBzdGFydDogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9zdGFydGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N0YXJ0CiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvc3RhcnQnLAogICAgICAgIHNlbmQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc2VuZGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3NlbmQKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zZW5kJywKICAgICAgICBlcnJvcjogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9lcnJvcmAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L2Vycm9yCiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvZXJyb3InLAogICAgICAgIHN1Y2Nlc3M6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc3VjY2Vzc2AgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N1Y2Nlc3MKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zdWNlc3MnLAogICAgICAgIGNvbXBsZXRlOiAvKioKICAgICAgICBUaGUgYHRocnVzdC9kYXRhL2V2ZW50L2NvbXBsZXRlYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvY29tcGxldGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9jb21wbGV0ZScsCiAgICAgICAgc3RvcDogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9zdG9wYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvc3RvcAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L3N0b3AnCiAgICB9Owp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1ldmVudC50eXBlcy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kYXRhL2V2ZW50LmZhY3RvcnknLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJy4vZXZlbnQudHlwZXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2V2ZW50VHlwZXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vanF1ZXJ5LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnRUeXBlcyA9IF9fZXZlbnRUeXBlc19fOwoKICAgIHZhciBjYW1lbENhc2UgPSB1dGlsLmNhbWVsQ2FzZSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGJpbmQgPSBfLmJpbmQsIGRhdGFFdmVudHMgPSBldmVudFR5cGVzLmV2ZW50LCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgbWVtb2l6ZSA9IF8ubWVtb2l6ZTsKICAgIC8qKgogICAgVGhlIGV2ZW50IGZhY3RvcnkgbGlua3MgalF1ZXJ5IEV2ZW50cyB1cCB0byB0aHJ1c3QgY2VudHJpYyBldmVudHMuCiAgICBUaGUgZXZlbnQgZmFjdG9yeSB3b3VsZCBiZSByZXBsYWNlZCBpZiB3ZSB3ZXJlIGV2ZXIgbW92ZWQgb2ZmIG9mIHRoZSBqUXVlcnkgZGVwZW5kYW5jeS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QuZGF0YQogICAgKiovCiAgICB2YXIgZXZlbnRIYW5kbGVycyA9IHsKICAgICAgICAnYmVmb3JlLXNlbmQnOiAvLyBTdXBwb3J0ZWQgZXZlbnQgaGFuZGxlcnMKICAgICAgICB0cnVlLAogICAgICAgICdzZW5kJzogdHJ1ZSwKICAgICAgICAnZXJyb3InOiB0cnVlLAogICAgICAgICdzdWNjZXNzJzogdHJ1ZSwKICAgICAgICAnY29tcGxldGUnOiB0cnVlLAogICAgICAgICdzdGFydCc6IHRydWUsCiAgICAgICAgJ3N0b3AnOiB0cnVlCiAgICB9OwogICAgLyoqCiAgICBXcmFwcyBiZWZvcmVTZW5kLCB3aGljaCBpcyBhIGN1c3RvbSBwcm9wZXJ0eSBvbiB0aGUgalF1ZXJ5IGFqYXggZGF0YSBjYWxsLgogICAgCiAgICBAbWV0aG9kIGJlZm9yZVNlbmRNZXRob2QKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGJlZm9yZVNlbmRNZXRob2QoanFYSFIsIHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICB0aGlzLmZpcmUoZGF0YUV2ZW50c1snYmVmb3JlU2VuZCddLCBqcVhIUiwgc2V0dGluZ3MpOwogICAgfQogICAgZXhwb3J0cy5iZWZvcmVTZW5kTWV0aG9kID0gYmVmb3JlU2VuZE1ldGhvZDsKICAgIHZhciBldmVudEZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHZhciBldnQgPSBkYXRhRXZlbnRzW2V2ZW50XTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGV2dCk7CiAgICAgICAgICAgIHRoaXMuZmlyZS5hcHBseSh0aGlzLmZpcmUuYXN5bmMsIGFyZ3MpOwogICAgICAgIH07CiAgICB9KTsKICAgIHZhciBub3JtYWxpemVFdmVudHMgPSBmdW5jdGlvbiAoZXZ0cykgewogICAgICAgIGV2dHMgPSBldnRzLnNwbGl0KCcgJyk7CiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGV2dHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmKCFldmVudEhhbmRsZXJzW2V2dHNbaV1dKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdFdmVudCAiezB9IiBpcyBub3QgYSB2YWxpZCBkYXRhIGV2ZW50JywgZXZ0c1tpXSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2dHNbaV0gPSBkYXRhRXZlbnRzW2V2dHNbaV1dOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZ0cy5qb2luKCcgJyk7CiAgICB9OwogICAgdmFyIHNlbmRFdmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoaSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXZlbnQsIGpxWEhSLCBzZXR0aW5ncykgewogICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgICAgICBpZighc2V0dGluZ3MuX19tZWRpYXRvcl9kYXRhX2ZpcmVkX18pIHsKICAgICAgICAgICAgICAgIGpxWEhSLmFib3J0KCk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCwgYWxsIGFqYXggY2FsbHMgbXVzdCBwYXNzIHRocm91Z2ggdGhydXN0LWRhdGEuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXNldHRpbmdzLnNpbGVudCkgewogICAgICAgICAgICAgICAgZXZlbnRGYWN0b3J5KGkpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKICAgIC8qKgogICAgQmluZHMgYWxsIHRoZSBqUXVlcnkgZGF0YSBldmVudHMgYW5kIGNyZWF0ZXMgZXZlbnQgbmF0aXZlIHRocnVzdCBldmVudHMgb3V0IG9mIHRoZW0uCiAgICAKICAgIEBmb3IgdGhydXN0LmRhdGEKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGluaXQKICAgIEBwYXJhbSB7alF1ZXJ5fSBBIGpRdWVyeSBpbnN0YW5jZSB3cmFwcGluZyAnZG9jdW1lbnQnCiAgICAqKi8KICAgIGZ1bmN0aW9uIGluaXQoakRvYykgewogICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgICAgICAgZm9yKHZhciBpIGluIGV2ZW50SGFuZGxlcnMpIHsKICAgICAgICAgICAgdmFyIGpxRXZ0ID0gJ2FqYXgtJyArIGksIG1ldGhvZCA9IGV2ZW50RmFjdG9yeShpKTsKICAgICAgICAgICAgaWYoaSA9PT0gJ3NlbmQnKSB7CiAgICAgICAgICAgICAgICBtZXRob2QgPSBiaW5kKHNlbmRFdmVudEZhY3RvcnkoaSksIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGpEb2Mub24oY2FtZWxDYXNlKGpxRXZ0KSArIHRoaXMubmFtZXNwYWNlLCBtZXRob2QpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaW5pdCA9IGluaXQ7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWV2ZW50LmZhY3RvcnkuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9yZXNwb25zZS5xdWV1ZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAnLi9ldmVudC50eXBlcycsICdqcXVlcnknLCAndGhydXN0L2xvZycsICdoYXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2V2ZW50VHlwZXNfXywgX19qUXVlcnlfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9qcXVlcnkuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBldmVudFR5cGVzID0gX19ldmVudFR5cGVzX187CgogICAgdmFyIGpRdWVyeSA9IF9falF1ZXJ5X187CgogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gXy5leHRlbmQsIHdoZW4gPSB1dGlsLndoZW4sIHVpZCA9IF8udW5pcXVlSWQsIGFqYXggPSBqUXVlcnkuYWpheCwgZGF0YUV2ZW50V2FpdCA9IGV2ZW50VHlwZXMud2FpdCwgZGF0YUV2ZW50U3RhcnQgPSBldmVudFR5cGVzLnN0YXJ0LCBkYXRhRXZlbnRTdG9wID0gZXZlbnRUeXBlcy5zdG9wLCBkYXRhRXZlbnRTdGF0dXMgPSBldmVudFR5cGVzLnN0YXR1cywgcXVldWUgPSB7CiAgICB9LCB1cGRhdGVYSFJJbnRlcm5hbHMgPSBmdW5jdGlvbiAoZGZvLCB4aHIpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZighZGZvLl94aHIpIHsKICAgICAgICAgICAgICAgIGRmby5feGhyID0geGhyOwogICAgICAgICAgICAgICAgZGZvLmdldEFsbFJlc3BvbnNlSGVhZGVycyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZGZvLmdldFJlc3BvbnNlSGVhZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZm8uX3hoci5nZXRBbGxSZXNwb25zZUhlYWRlcnNnZXRSZXNwb25zZUhlYWRlcigpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGRmby5hYm9ydCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBkZm8uc2V0UmVxdWVzdEhlYWRlciA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZm8uX3hoci5zZXRSZXF1ZXN0SGVhZGVyKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGZvLnJlc3BvbnNlVGV4dCA9IHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgIGRmby5yZXNwb25zZVhNTCA9IHhoci5yZXNwb25zZVhNTDsKICAgICAgICAgICAgZGZvLnJlYWR5U3RhdGUgPSB4aHIucmVhZHlTdGF0ZTsKICAgICAgICAgICAgZGZvLnN0YXR1cyA9IHhoci5zdGF0dXM7CiAgICAgICAgICAgIGRmby5zdGF0dXNUZXh0ID0geGhyLnN0YXR1c1RleHQ7CiAgICAgICAgfTsKICAgIH0sIGFyZ3VtZW50UmVzb2x2ZXIgPSBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgfTsKICAgIH0sIGRlZmVyQ29udHJvbGxlckl0ZW1DYWxsYmFjayA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzLCBhcmd1bWVudHNbMF1bMF0pOwogICAgICAgIH07CiAgICB9OwogICAgLyoqCiAgICBUaGUgcmVzcG9uc2UgcXVldWUgY2xhc3MgaGFuZGxlcyBjcmVhdGlvbiBvZiBhIHF1ZXVlIG9yIGJhdGNoaW5nIHN5c3RlbS4KICAgIFdpdGggdGhpcyBzeXN0ZW0sIHdlIGNhbiBiYXRjaCB1cCBhbGwgb3VyIHNlcnZlciByZXF1ZXN0cywgYW5kIHJlcXVlc3QgdGhlbSBmcm9tIHRoZSBzZXJ2ZXIgYWxsIGFyb3VuZCB0aGUgc2FtZSB0aW1lLgogICAgSW4gYWRkaXRpb24gdG8gdGhhdCwgd2hlbiB0aGUgcmVxdWVzdHMgY29tZSBiYWNrIHdlIGNhbiBhbHNvIHNwb29sIHRoZW0gdG9nZXRoZXIsIHNvIHRoYXQgdGhlIGNhbGxzIGRvbid0IHJlc29sdmUgdW50aWwKICAgIGVpdGhlciBhbGwgdGhlIGNhbGxzIGNvbWUgYmFjaywgb3IgYSBzcGVjaWZpYyB0aW1lIGhhcyBlbGFwc2VkLgogICAgCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICBAY2xhc3MgdGhydXN0LmRhdGEuUmVzcG9uc2VRdWV1ZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgcmVzcG9uc2UgcXVldWUgZm9yCiAgICBAcGFyYW0ge051bWJlcn0gc3RhcnRUaW1lb3V0IFRoZSB0aW1lIHRvIHdhaXQgZm9yIGFkZGl0aW9uYWwgcmVxdWVzdHMuCiAgICBAcGFyYW0ge051bWJlcn0gZmluaXNoVGltZW91dCBUaGUgbWF4aW11bSB0aW1lIHRvIHdhaXQgZm9yIHJlcXVlc3RzIHRvIHJldHVybi4KICAgICoqLwogICAgdmFyIFJlc3BvbnNlUXVldWUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFJlc3BvbnNlUXVldWUobW9kdWxlLCBzdGFydFRpbWVvdXQsIGZpbmlzaFRpbWVvdXQpIHsKICAgICAgICAgICAgdGhpcy5zdGFydFRpbWVvdXQgPSBzdGFydFRpbWVvdXQ7CiAgICAgICAgICAgIHRoaXMuZmluaXNoVGltZW91dCA9IGZpbmlzaFRpbWVvdXQ7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLm5hbWVzcGFjZSA9IG1vZHVsZS5uYW1lc3BhY2U7CiAgICAgICAgfQogICAgICAgIFJlc3BvbnNlUXVldWUucHJvdG90eXBlLmFkZFRvUXVldWUgPSAvKioKICAgICAgICBBZGRzIGEgcmVxdWVzdCB0byB0aGUgcXVldWUKICAgICAgICBRdWV1ZXMgYXJlIHNwbGl0IHVwIGJ5IEhUVFAgdHlwZSwgc28gR0VUIHJlcXVlc3RzIGdvIHdpdGggR0VUIHJlcXVlc3RzIGFuZCBQT1NUIHJlcXVlc3RzIGdvIHdpdGggUE9TVCByZXF1ZXN0cy4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGFkZFRvUXVldWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgcmVxdWVzdCB0eXBlIChQT1NULCBHRVQsIGV0YykKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSByZXF1ZXN0IHVybCB0byBxdWV1ZSB1cAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSByZXF1ZXN0IG9wdGlvbnMuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIG9yIHJlamVjdCwgd2hlbiB0aGUgcmVxdWVzdCBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHR5cGUsIHVybCwgb3B0aW9ucykgewogICAgICAgICAgICB2YXIgZGZvID0gd2hlbi5kZWZlcigpLCB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYob3B0aW9ucy5iZWZvcmVTZW5kKSB7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgICAgICAgICAgIGRmby5wcm9ncmVzcyhmdW5jdGlvbiAoZXZlbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnRUeXBlICYmIGV2ZW50VHlwZSA9PSAnYmVmb3JlLXNlbmQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVTZW5kLmFwcGx5KGJlZm9yZVNlbmQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLmNvbXBsZXRlKSB7CiAgICAgICAgICAgICAgICBkZm8ucHJvbWlzZS5hbHdheXMob3B0aW9ucy5jb21wbGV0ZSk7CiAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy5jb21wbGV0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIGRmby5wcm9taXNlLnRoZW4ob3B0aW9ucy5zdWNjZXNzKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYob3B0aW9ucy5lcnJvcikgewogICAgICAgICAgICAgICAgZGZvLnByb21pc2Uub3RoZXJ3aXNlKG9wdGlvbnMuZXJyb3IpOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc1F1ZXVlID0gISFxdWV1ZVt0eXBlXSwgbGlzdCA9IHF1ZXVlW3R5cGVdIHx8IChxdWV1ZVt0eXBlXSA9IHsKICAgICAgICAgICAgfSksIHRhaWwgPSBsaXN0LnRhaWwgfHwgKGxpc3QudGFpbCA9IGxpc3QubmV4dCA9IHsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGV4dGVuZCh0YWlsLCB7CiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgICAgICAgICBkZm86IGRmbwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGlzdC50YWlsID0gdGFpbC5uZXh0ID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICBpZighaGFzUXVldWUpIHsKICAgICAgICAgICAgICAgIHdoZW4uZGVsYXkodGhhdC5zdGFydFRpbWVvdXQpLnRoZW4odGhhdC5wcm9jZXNzKHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGZvLnByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBSZXNwb25zZVF1ZXVlLnByb3RvdHlwZS5wcm9jZXNzID0gLyoqCiAgICAgICAgUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0IHdpbGwgcHJvY2VzcyB0aGUgZ2l2ZW4gcXVldWUgYWZ0ZXIgdGhlIHN0YXJ0IHRpbWUgaGFzIGVsYXBzZWQuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBwcm9jZXNzCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHF1ZXVlIHR5cGUsIHRvIHByb2Nlc3MuCiAgICAgICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgZnVuY3Rpb24gdGhhdCB3aWxsIGRvIHRoZSB3b3JrIG9uIHRoZSBxdWV1ZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gcXVldWVbdHlwZV0sIG5vZGUgPSBwYXJlbnQsIHRoYXQgPSB0aGlzLCBxdWVyeUlkID0gdWlkKCdkcScpOwogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEYXRhW3swfV06IENyZWF0aW5nIHF1ZXVlIGZvciB0eXBlICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHR5cGUpKTsKICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRXYWl0LCBxdWVyeUlkLCB0eXBlKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RhdGFbezB9XTogUHJvY2Vzc2luZyBxdWV1ZSBmb3IgdHlwZSAiezF9IicsIHRoYXQubmFtZXNwYWNlLCB0eXBlKSk7CiAgICAgICAgICAgICAgICB2YXIgd2hlblF1ZXVlID0gW10sIGRlZmVyQ29udHJvbGxlciA9IHdoZW4uZGVmZXIoKSwgcmV0dXJuQ291bnQgPSAwOwogICAgICAgICAgICAgICAgZGVmZXJDb250cm9sbGVyLnByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRGF0YVt7MH1dOiBGaW5pc2hpbmcgcXVldWUgZm9yIHR5cGUgInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdHlwZSkpOwogICAgICAgICAgICAgICAgICAgIHRoYXQubW9kdWxlLmZpcmUoZGF0YUV2ZW50U3RvcCwgcXVlcnlJZCwgdHlwZSwgcmV0dXJuQ291bnQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBkZWxldGUgcXVldWVbdHlwZV07CiAgICAgICAgICAgICAgICB2YXIgdGFpbCA9IG5vZGUudGFpbCwgc3RhdHVzQ2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRTdGF0dXMsIHF1ZXJ5SWQsIHR5cGUsICsrcmV0dXJuQ291bnQpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHdoaWxlKChub2RlID0gbm9kZS5uZXh0KSAhPT0gdGFpbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZm8gPSBub2RlLmRmbywgb3B0aW9ucyA9IGV4dGVuZCh7CiAgICAgICAgICAgICAgICAgICAgfSwgbm9kZS5vcHRpb25zKSwgeGhyRGZvID0gd2hlbi5kZWZlcigpLCB4aHIgPSBub2RlLnhociA9IGFqYXgobm9kZS51cmwsIG9wdGlvbnMpLnRoZW4oYXJndW1lbnRSZXNvbHZlcih4aHJEZm8ucmVzb2x2ZSksIGFyZ3VtZW50UmVzb2x2ZXIoeGhyRGZvLnJlamVjdCkpOwogICAgICAgICAgICAgICAgICAgIHhockRmby5wcm9taXNlLnRoZW4oc3RhdHVzQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIHdoZW5RdWV1ZS5wdXNoKHhocik7CiAgICAgICAgICAgICAgICAgICAgd2hlbi5hbGwoWwogICAgICAgICAgICAgICAgICAgICAgICB4aHJEZm8sIAogICAgICAgICAgICAgICAgICAgICAgICBkZWZlckNvbnRyb2xsZXIucHJvbWlzZQogICAgICAgICAgICAgICAgICAgIF0sIHdoZW4uYXBwbHkoZGZvLnJlc29sdmUpLCB3aGVuLmFwcGx5KGRmby5yZWplY3QpLCB1cGRhdGVYSFJJbnRlcm5hbHMoZGZvLCB4aHIpKTsKICAgICAgICAgICAgICAgICAgICBkZm8ucHJvZ3Jlc3MoJ2JlZm9yZS1zZW5kJywgWwogICAgICAgICAgICAgICAgICAgICAgICBkZm8sIAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGF0Lm1vZHVsZS5maXJlKGRhdGFFdmVudFN0YXJ0LCBxdWVyeUlkLCB0eXBlLCB3aGVuUXVldWUubGVuZ3RoKTsKICAgICAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgICAgICB3aGVuLmFsbCh3aGVuUXVldWUpLCAKICAgICAgICAgICAgICAgICAgICB3aGVuLmRlbGF5KHRoYXQuZmluaXNoVGltZW91dCkKICAgICAgICAgICAgICAgIF0sIGRlZmVyQ29udHJvbGxlci5yZXNvbHZlLCBkZWZlckNvbnRyb2xsZXIucmVzb2x2ZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gUmVzcG9uc2VRdWV1ZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLlJlc3BvbnNlUXVldWUgPSBSZXNwb25zZVF1ZXVlOyAgICAKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9cmVzcG9uc2UucXVldWUuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9jb252ZW50aW9uL3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZGF0YS9kYXRhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbjsKICAgIHZhciB3aGVuUXVldWUgPSBbXTsKICAgIGZ1bmN0aW9uIHdhaXRDYWxsYmFjayh1aWQpIHsKICAgICAgICB2YXIgZCA9IHdoZW4uZGVmZXIoKTsKICAgICAgICBkLnJlc29sdmVyWyd1aWQnXSA9IHVpZDsKICAgICAgICB3aGVuUXVldWUucHVzaCh7CiAgICAgICAgICAgIHVpZDogdWlkLAogICAgICAgICAgICByZXNvbHZlcjogZC5yZXNvbHZlcgogICAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gc3RvcENhbGxiYWNrKHVpZCkgewogICAgICAgIHZhciBpdGVtID0gXy5maW5kKHdoZW5RdWV1ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuIHgudWlkID09PSB1aWQ7CiAgICAgICAgfSk7CiAgICAgICAgd2hlblF1ZXVlID0gXy53aXRob3V0KHdoZW5RdWV1ZSwgaXRlbSk7CiAgICAgICAgaXRlbS5yZXNvbHZlci5yZXNvbHZlKCk7CiAgICB9CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBjb3VudGRvd246IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgLy8gU3Vic2NyaWJlIHRvIHRoZSB3YWl0IGFuZCBzdG9wIGV2ZW50cwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3dhaXQnLCB3YWl0Q2FsbGJhY2spOwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3N0b3AnLCBzdG9wQ2FsbGJhY2spOwogICAgICAgIH0sCiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgLy8gVW5zdWJzY3JpYmUgZnJvbSB0aGUgd2FpdCBhbmQgc3RvcCBldmVudHMKICAgICAgICAgICAgdGhydXN0LmRhdGEudW5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3dhaXQnLCB3YWl0Q2FsbGJhY2spOwogICAgICAgICAgICB0aHJ1c3QuZGF0YS51bnN1YnNjcmliZSgndGhydXN0L2RhdGEvc3RvcCcsIHN0b3BDYWxsYmFjayk7CiAgICAgICAgICAgIC8vIGRlZmVyIHVudGlsIGFueSBvZiB0aGUgZXZlbnRzIHRoYXQgd2VyZSBjYXB0dXJlZCBhcmUgcmVzb2x2ZWQsIG9yIHRoZSBkZWxheSBwYXNzZXMuCiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgaWYodGhydXN0LmNmZy5kYXRhLmZpbmlzaFRpbWVvdXQgPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbCh3aGVuUXVldWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICB3aGVuLmFsbCh3aGVuUXVldWUpLCAKICAgICAgICAgICAgICAgIHdoZW4uZGVsYXkodGhydXN0LmNmZy5kYXRhLmZpbmlzaFRpbWVvdXQpCiAgICAgICAgICAgIF0sIGRlZmVyLnJlc29sdmUsIGRlZmVyLnJlamVjdCk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuc3Vic2NyaXB0aW9uID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXN0YXJ0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0LmRvbS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicKICAgIF07CiAgICAvKioKICAgIFRoZSBzZXQgb2YgY29udmVudGlvbnMgdG8gbG9hZCBpbnRvIHRocnVzdC9kb20uCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9kb20vY29udmVudGlvbi9hY3Rpb24nLCAKICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2NvbnRleHQnLCAKICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JwogICAgXTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9zdWJqcXVlcnknLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ2pxdWVyeScsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ2hhcyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2pRdWVyeV9fLCBfX3V0aWxfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBqUXVlcnkgPSBfX2pRdWVyeV9fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGVhY2ggPSBfLmVhY2gsIGV4dGVuZCA9IF8uZXh0ZW5kLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBHTE9CQUwgPSAnLmdsb2JhbCc7CiAgICB2YXIgalF1ZXJ5Rm5NZXRob2RCbGFja0xpc3QgPSBbCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ2V4dGVuZCcsIAogICAgICAgICdxdWV1ZScsIAogICAgICAgICdkZXF1ZXVlJywgCiAgICAgICAgJ2NsZWFyUXVldWUnLCAKICAgICAgICAncHJvbWlzZScsIAogICAgICAgICdiaW5kJywgCiAgICAgICAgJ3VuYmluZCcsIAogICAgICAgICdsaXZlJywgCiAgICAgICAgJ2RpZScsIAogICAgICAgICdkZWxlZ2F0ZScsIAogICAgICAgICd1bmRlbGVnYXRlJywgCiAgICAgICAgJ2JsdXInLCAKICAgICAgICAnZm9jdXMnLCAKICAgICAgICAnZm9jdXNpbicsIAogICAgICAgICdmb2N1c291dCcsIAogICAgICAgICdsb2FkJywgCiAgICAgICAgJ3Jlc2l6ZScsIAogICAgICAgICdzY3JvbGwnLCAKICAgICAgICAndW5sb2FkJywgCiAgICAgICAgJ2NsaWNrJywgCiAgICAgICAgJ2RibGNsaWNrJywgCiAgICAgICAgJ21vdXNlZG93bicsIAogICAgICAgICdtb3VzZXVwJywgCiAgICAgICAgJ21vdXNlbW92ZScsIAogICAgICAgICdtb3VzZW92ZXInLCAKICAgICAgICAnbW91c2VvdXQnLCAKICAgICAgICAnbW91c2VlbnRlcicsIAogICAgICAgICdtb3VzZWxlYXZlJywgCiAgICAgICAgJ2NoYW5nZScsIAogICAgICAgICdzZWxlY3QnLCAKICAgICAgICAnc3VibWl0JywgCiAgICAgICAgJ2tleWRvd24nLCAKICAgICAgICAna2V5cHJlc3MnLCAKICAgICAgICAna2V5dXAnLCAKICAgICAgICAnZXJyb3InLCAKICAgICAgICAnc2VyaWFsaXplJywgCiAgICAgICAgJ3NlcmlhbGl6ZUFycmF5JywgCiAgICAgICAgJ2FqYXhTdGFydCcsIAogICAgICAgICdhamF4U3RvcCcsIAogICAgICAgICdhamF4Q29tcGxldGUnLCAKICAgICAgICAnYWpheEVycm9yJywgCiAgICAgICAgJ2FqYXhTdWNjZXNzJywgCiAgICAgICAgJ2FqYXhTZW5kJywgCiAgICAgICAgJ190b2dnbGUnLCAKICAgICAgICAnZmFkZVRvJywgCiAgICAgICAgJ3N0b3AnLCAKICAgICAgICAnc2xpZGVEb3duJywgCiAgICAgICAgJ3NsaWRlVXAnLCAKICAgICAgICAnc2xpZGVUb2dnbGUnLCAKICAgICAgICAnZmFkZUluJywgCiAgICAgICAgJ2ZhZGVPdXQnLCAKICAgICAgICAnZmFkZVRvZ2dsZScvKiwgJ29uJywgJ29mZicsICdvbmUnKi8gCiAgICBdOwogICAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnRzKGV2ZW50cywgbmFtZXNwYWNlKSB7CiAgICAgICAgaWYoIW5hbWVzcGFjZSkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRzOwogICAgICAgIH0KICAgICAgICBpZihpc09iamVjdChldmVudHMpKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBuZXcgb2JqZWN0LCBzbyB0aGF0IG9yaWdpbmFsIG9iamVjdCB3aWxsIG5vdCBiZSBtb2RpZmllZCB3aGVuIGJpbmRpbmcuCiAgICAgICAgICAgIGV2ZW50cyA9IGV4dGVuZCh7CiAgICAgICAgICAgIH0sIGV2ZW50cyk7CiAgICAgICAgICAgIGZvcih2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgICAgICAgICAgaWYoa2V5LmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBldmVudHNba2V5ICsgbmFtZXNwYWNlXSA9IGV2ZW50c1trZXldOwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXZlbnRzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmKCFldmVudHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuYW1lc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KCcgJyk7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBldmVudHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZ0ID0gZXZlbnRzW2ldOwogICAgICAgICAgICAgICAgaWYoZXZ0LmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBldmVudHNbaV0gPSBldnQgKyBuYW1lc3BhY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50cy5qb2luKCcgJyk7CiAgICAgICAgfQogICAgfQogICAgLyoKICAgIENsb25lIGpxdWVyeQogICAgUmVtb3ZlIGFsbCBleGNlc3MgbWV0aG9kcyB3ZSBkb24ndCB3YW50IHRvIGV4cG9zZSBuYXRpdmVseS4KICAgIG92ZXJybG9hZCBhbnkgbWV0aG9kcyB3ZSB3YW50IHRvIGNoYW5nZSBiZWhhdmlvciBvZiAobm90ZWFibHkgb24sIG9uZSwgYW5kIG9mZikKICAgIAogICAgSW5zdGVhZCBvZiBkdXBsaWNhdGluZyB0aGUganF1ZXJ5IGJlaGF2aW9yIHdlIGluc3RlYWQgcmVhbGlnbiBpdCB0byBvdXIgb3duLgogICAgKi8KICAgIC8vIGpRdWVyeSBzdWIKICAgIGZ1bmN0aW9uIHN1YkpRdWVyeSgpIHsKICAgICAgICB2YXIgdFF1ZXJ5ID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyB0UXVlcnkucHJvdG90eXBlLmluaXQoc2VsZWN0b3IsIGNvbnRleHQsIG5hbWVzcGFjZSB8fCAodGhpcyAmJiB0aGlzLm5hbWVzcGFjZSkpOwogICAgICAgIH07CiAgICAgICAgXy5tZXJnZSh0UXVlcnksIGpRdWVyeSk7CiAgICAgICAgLy8gRG8gbm90IGxpa2UKICAgICAgICAvLyBwcm9iYWJseSBuZWVkZWQgaW4gc29tZSBzcGVjaWFsIHVuaXF1ZSBjYXNlcwogICAgICAgIHRRdWVyeS5qUXVlcnkgPSBqUXVlcnk7CiAgICAgICAgLy8gZXhwb3NlIGV2ZW50cyBmb3IgZG9pbmcgc3BlY2lhbCBldmVudHMgYXMgcmVxdWlyZWQuCiAgICAgICAgdFF1ZXJ5LmV2ZW50ID0gKGpRdWVyeSkuZXZlbnQ7CiAgICAgICAgdFF1ZXJ5LmZuID0gdFF1ZXJ5LnByb3RvdHlwZSA9IGV4dGVuZCh7CiAgICAgICAgfSwgalF1ZXJ5LmZuKTsKICAgICAgICB0UXVlcnkuZm4uY29uc3RydWN0b3IgPSB0UXVlcnk7CiAgICAgICAgdFF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiBpbml0KHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgdmFyIGlvRG9tID0gY29udGV4dCBpbnN0YW5jZW9mIHRRdWVyeTsKICAgICAgICAgICAgaWYoY29udGV4dCAmJiBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ICYmICEoaW9Eb20pKSB7CiAgICAgICAgICAgICAgICBjb250ZXh0ID0gdFF1ZXJ5KGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBqUXVlcnkuZm4uaW5pdC5jYWxsKHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCB0UXVlcnlSb290KTsKICAgICAgICAgICAgaWYobmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICByZXN1bHQubmFtZXNwYWNlID0gbmFtZXNwYWNlOwogICAgICAgICAgICB9IGVsc2UgaWYoaW9Eb20pIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5uYW1lc3BhY2UgPSBjb250ZXh0Lm5hbWVzcGFjZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CiAgICAgICAgdFF1ZXJ5LmZuLmluaXQucHJvdG90eXBlID0gdFF1ZXJ5LmZuOwogICAgICAgIHZhciB0UXVlcnlSb290ID0gdFF1ZXJ5KGRvY3VtZW50KTsKICAgICAgICAvLyByZW1vdmUgYWxsIG5vdCBhcHBsaWNhYmxlIG1ldGhvZHMgb2ZmIG9mIGZuLgogICAgICAgIGVhY2goalF1ZXJ5Rm5NZXRob2RCbGFja0xpc3QsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIGlmKHRRdWVyeS5mblt4XSkgewogICAgICAgICAgICAgICAgdFF1ZXJ5LmZuW3hdID0gbnVsbDsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0UXVlcnkuZm5beF07CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBfLmVhY2goWwogICAgICAgICAgICAnb24nLCAKICAgICAgICAgICAgJ29uZScsIAogICAgICAgICAgICAnb2ZmJwogICAgICAgIF0sIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHRRdWVyeS5mblt4XSA9IF8ud3JhcCh0UXVlcnkuZm5beF0sIGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgndFF1ZXJ5W3swfV06IEJpbmRpbmcgJyArIHggKyAnIGV2ZW50cy4uLicsIHRoaXMubmFtZXNwYWNlKSk7CiAgICAgICAgICAgICAgICBhcmdzWzBdID0gbm9ybWFsaXplRXZlbnRzKGFyZ3NbMF0sIHRoaXMubmFtZXNwYWNlKTsKICAgICAgICAgICAgICAgIHJldHVybiBmLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICB0UXVlcnkuZm4ucXVlcnkgPSB0UXVlcnkuZm4uJCA9IHRRdWVyeS5mbi5maW5kOwogICAgICAgIHJldHVybiB0UXVlcnk7CiAgICB9CiAgICBleHBvcnRzLnRRdWVyeSA9IHN1YkpRdWVyeSgpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdWJqcXVlcnkuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYWN0aW9uJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuLi9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2FjdGlvbi5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyICQgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBBQ1RJT05TID0gJ2NvbmZpZy5kb20uYWN0aW9ucycsIEFDVElPTlNTSU5HTEUgPSAnYWN0aW9ucycsIFNUUklORyA9ICdzdHJpbmcnLCBSRUdJU1RSQVRJT05TID0gJ19yZWdpc3RyYXRpb25zJywgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNTdHJpbmcgPSBfLmlzU3RyaW5nLCBpc0FycmF5ID0gXy5pc0FycmF5OwogICAgdmFyIGdldEFjdGlvbkF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgICAgICByZXR1cm4gJ2RhdGEtYWN0aW9uLScgKyBldmVudE5hbWU7CiAgICB9OwogICAgdmFyIEFjdGlvbkhhbmRsZXIgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEFjdGlvbkhhbmRsZXIoKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gewogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBBY3Rpb25IYW5kbGVyLnByb3RvdHlwZS5yZWdpc3RlciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGFjdGlvbk5hbWUsIGFjdGlvbikgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gdGhpcy5ldmVudHM7CiAgICAgICAgICAgIGlmKCFldmVudHNbZXZlbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV0gPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFldmVudHNbZXZlbnROYW1lXVthY3Rpb25OYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0gPSBhY3Rpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdUaGUgYWN0aW9uIHsxfSBoYW5kbGVyICJ7MH0iIGhhcyBhbHJlYWR5IGJlZW4gdGFrZW4hJywgYWN0aW9uTmFtZSwgZXZlbnROYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIEFjdGlvbkhhbmRsZXIucHJvdG90eXBlLnVucmVnaXN0ZXIgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBhY3Rpb25OYW1lKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50czsKICAgICAgICAgICAgaWYoZXZlbnRzW2V2ZW50TmFtZV0gJiYgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0pIHsKICAgICAgICAgICAgICAgIGV2ZW50c1tldmVudE5hbWVdW2FjdGlvbk5hbWVdID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5wcm90b3R5cGUuY2FsbGJhY2tGb3IgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCByZXR1cm5SZXN1bHRzKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50cywgYWN0aW9uQXR0cmlidXRlID0gZ2V0QWN0aW9uQXR0cmlidXRlKGV2ZW50TmFtZSksIHJldHVyblJlc3VsdHNEZWZpbmVkID0gdHlwZW9mIHJldHVyblJlc3VsdHMgIT09ICd1bmRlZmluZWQnOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZVZhbHVlID0gJCh0aGlzKS5hdHRyKGFjdGlvbkF0dHJpYnV0ZSk7CiAgICAgICAgICAgICAgICBpZih0eXBlb2YgYXR0cmlidXRlVmFsdWUgPT09IFNUUklORykgewogICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSBldmVudHNbZXZlbnROYW1lXVthdHRyaWJ1dGVWYWx1ZV07CiAgICAgICAgICAgICAgICAgICAgaWYoYWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbi5oYW5kbGVyLmFwcGx5KGFjdGlvbi5jb250ZXh0IHx8IHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmKHJldHVyblJlc3VsdHNEZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5SZXN1bHRzOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBBY3Rpb25IYW5kbGVyLmFjdGlvbkhhbmRsZXJzID0gewogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5nZXRGb3IgPSBmdW5jdGlvbiBnZXRGb3IobmFtZSkgewogICAgICAgICAgICBpZih0aGlzLmFjdGlvbkhhbmRsZXJzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hY3Rpb25IYW5kbGVyc1tuYW1lXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKHRoaXMuYWN0aW9uSGFuZGxlcnNbbmFtZV0gPSBuZXcgQWN0aW9uSGFuZGxlcigpKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBBY3Rpb25IYW5kbGVyOwogICAgfSkoKTsgICAgCiAgICB2YXIgZXZlbnRzID0gewogICAgICAgIGNsaWNrOiBbCiAgICAgICAgICAgICdhJywgCiAgICAgICAgICAgICdidXR0b24nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9ImJ1dHRvbiJdJywgCiAgICAgICAgICAgICdpbnB1dFt0eXBlPSJzdWJtaXQiXScKICAgICAgICBdLAogICAgICAgIGRibGNsaWNrOiBbCiAgICAgICAgICAgICdhJywgCiAgICAgICAgICAgICdidXR0b24nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9ImJ1dHRvbiJdJywgCiAgICAgICAgICAgICdpbnB1dFt0eXBlPSJzdWJtaXQiXScKICAgICAgICBdLAogICAgICAgIG1vdXNlZW50ZXI6IFsKICAgICAgICAgICAgJycKICAgICAgICBdLAogICAgICAgIG1vdXNlbGVhdmU6IFsKICAgICAgICAgICAgJycKICAgICAgICBdLAogICAgICAgIGZvY3VzOiBbCiAgICAgICAgICAgICdpbnB1dCcKICAgICAgICBdLAogICAgICAgIGJsdXI6IFsKICAgICAgICAgICAgJ2lucHV0JwogICAgICAgIF0KICAgIH07CiAgICB2YXIgYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdoYW5kbGVyJywgCiAgICAgICAgJ2NvbnRleHQnCiAgICBdOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBBQ1RJT05TCiAgICAgICAgXSwKICAgICAgICBpZ25pdGU6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdmFyIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcih0aHJ1c3QubmFtZSk7CiAgICAgICAgICAgIHRocnVzdC5kb20uYWN0aW9uSGFuZGxlciA9IGFjdGlvbkhhbmRsZXI7CiAgICAgICAgICAgIHZhciAkYm9keSA9ICQod2luZG93LmRvY3VtZW50LmJvZHkpOwogICAgICAgICAgICBfLmVhY2goZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRTZWxlY3RvcnMsIGV2ZW50TmFtZSkgewogICAgICAgICAgICAgICAgLy8gdXNpbmcgdGhydXN0IG5hbWUsIGFzIGNhbGxiYWNrIG5lZWRzIHRvIGJlIHBlciB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICAgICAgICAgIC8vIGluIHRoZSBldmVudCBvZiBtdWx0aXBsZSB0aHJ1c3QgaW5zdGFuY2VzLgogICAgICAgICAgICAgICAgJGJvZHkub24oZXZlbnROYW1lICsgJy4nICsgQUNUSU9OU1NJTkdMRSArIHRocnVzdC5uYW1lLCBldmVudFNlbGVjdG9ycy5qb2luKGdldEFjdGlvbkF0dHJpYnV0ZShldmVudE5hbWUpICsgJywgJyksIGFjdGlvbkhhbmRsZXIuY2FsbGJhY2tGb3IoZXZlbnROYW1lLCB0cnVlKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgZGVvcmJpdDogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgYWN0aW9uSGFuZGxlciA9IEFjdGlvbkhhbmRsZXIuZ2V0Rm9yKHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgdmFyICRib2R5ID0gJCh3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgICAgICAgIF8uZWFjaChldmVudHMsIGZ1bmN0aW9uIChldmVudFNlbGVjdG9ycywgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAkYm9keS5vZmYoJy4nICsgQUNUSU9OU1NJTkdMRSArIHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gbW9kLmNvbnZlbnRpb24oQUNUSU9OUyksIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcihtb2QudGhydXN0Lm5hbWUpLCBkb20gPSBmYWNhZGUsIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICBfLmZvck93bihhY3Rpb25zLCBmdW5jdGlvbiAoYWN0aW9uQ29sbGVjdGlvbiwgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoIWlzQXJyYXkoYWN0aW9uQ29sbGVjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkNvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoYWN0aW9uQ29sbGVjdGlvbi5sZW5ndGggJiYgKCFpc0FycmF5KGFjdGlvbkNvbGxlY3Rpb25bMF0pIHx8IGlzU3RyaW5nKGFjdGlvbkNvbGxlY3Rpb25bMF0pKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Db2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBfLmVhY2goYWN0aW9uQ29sbGVjdGlvbiwgZnVuY3Rpb24gKGFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KGFjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdBY3Rpb24gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGFycmF5U2hvcnRIYW5kQXJnc0luT3JkZXIsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeCA9PT0gJ2hhbmRsZXInICYmIGlzU3RyaW5nKGFjdGlvbltpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uW2ldID0gbW9kLmluc3RhbmNlW2FjdGlvbltpXV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0FjdGlvblt4XSA9IGFjdGlvbltpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb25OYW1lID0gYWN0aW9uLm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFhY3Rpb24uaGFuZGxlciAmJiBhY3Rpb24ubW9kdWxlSGFuZGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uLmhhbmRsZXIgPSBtb2QuaW5zdGFuY2VbYWN0aW9uLm1vZHVsZUhhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoIWFjdGlvbi5oYW5kbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ011c3QgZGVmaW5lIGVpdGhlciBhIGhhbmRsZXIgb3IgbW9kdWxlIGhhbmRsZXIuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uSGFuZGxlci5yZWdpc3RlcihldmVudE5hbWUsIGFjdGlvbk5hbWUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gbW9kLmNvbnZlbnRpb24oQUNUSU9OUyksIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcihtb2QudGhydXN0Lm5hbWUpLCBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgaWYoYWN0aW9ucykgewogICAgICAgICAgICAgICAgZm9yKHZhciBhY3Rpb25FdmVudCBpbiBhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbkNvbGxlY3Rpb24gPSBhY3Rpb25zW2FjdGlvbkV2ZW50XTsKICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGFjdGlvbk5hbWUgaW4gYWN0aW9uQ29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25IYW5kbGVyLnVucmVnaXN0ZXIoYWN0aW9uRXZlbnQsIGFjdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmFjdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hY3Rpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYW5pbWF0ZS5jb250YWluZXInLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vY29udmVudGlvbi9jb250ZXh0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgYW55Q29udGFpbmVyOiAndGhydXN0LWNvbnZlbnRpb24tY29udGFpbmVyLWFueScsCiAgICAgICAgY2hhbmdlQ29udGFpbmVyOiAndGhydXN0LWNvbnZlbnRpb24tY29udGFpbmVyLWNoYW5nZScKICAgIH0sIGFueSA9IF8uYW55LCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQsIFNUQVJUID0gJ3N0YXJ0LXN0YXR1cycsIEFOSU1BVEUgPSAnYW5pbWF0ZScsIENPTlRBSU5FUiA9ICdjb250YWluZXInLCBDT05URVhUID0gJ2NvbnRleHQnOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBBTklNQVRFCiAgICAgICAgXSwKICAgICAgICBpbml0OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBtZWRpYXRvciA9IG1vZC5pbnN0YW5jZS5tZWRpYXRvcjsKICAgICAgICAgICAgbWVkaWF0b3Iuc3Vic2NyaWJlKGV2ZW50LmNoYW5nZUNvbnRhaW5lciwgYmluZCh0aGF0LmNoYW5nZSwgdGhhdCwgbW9kKSk7CiAgICAgICAgfSwKICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uIChtb2R1bGUsIGNvbnRhaW5lcikgewogICAgICAgICAgICBpZihtb2R1bGUuY29udmVudGlvbihDT05UQUlORVIpID09PSBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGlmKG1vZHVsZS5jb252ZW50aW9uKFNUQVJUKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBhbmltYXRlID0gbW9kdWxlLmNvbnZlbnRpb24oQU5JTUFURSk7CiAgICAgICAgICAgICAgICAgICAgaWYoYW5pbWF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGV4dE5vZGUgPSBtb2R1bGUuaW5zdGFuY2UuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHROb2RlLnJlbW92ZUNsYXNzKGFuaW1hdGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGFuaW1hdGUgPSBtb2QuY29udmVudGlvbihBTklNQVRFKSwgY29udGFpbmVyID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKSwgY29udGV4dCA9IG1vZC5jb252ZW50aW9uKENPTlRFWFQpLCBkb20gPSBmYWNhZGU7CiAgICAgICAgICAgIGlmKGFuaW1hdGUgJiYgY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSBkb20uY29udGV4dC5jbG9uZSgpLmFwcGVuZFRvKGRvbS5jb250ZXh0LnBhcmVudCgpKTsKICAgICAgICAgICAgICAgIGNsb25lLmFkZENsYXNzKGFuaW1hdGUucmVwbGFjZSgvXC4vZywgJyAnKS50cmltKCkpOwogICAgICAgICAgICAgICAgbW9kLmluc3RhbmNlLmRvbSA9IG1vZC5pbnN0YW5jZS4kID0gY2xvbmU7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGJpbmQodGhhdC5jbGVhbnVwLCB0aGF0LCBkb20uY29udGV4dC5wYXJlbnQoKSwgYW5pbWF0ZSwgY29udGV4dCksIDIwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjbGVhbnVwOiBmdW5jdGlvbiAoY29udGFpbmVyLCBhbmltYXRlLCBjb250ZXh0KSB7CiAgICAgICAgICAgIGNvbnRhaW5lci5maW5kKGNvbnRleHQpLmZpbHRlcignOm5vdCgnICsgYW5pbWF0ZSArICcpJykucmVtb3ZlKCk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuYW5pbWF0ZUNvbnRhaW5lciA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hbmltYXRlLmNvbnRhaW5lci5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vY29udmVudGlvbi9jb250ZXh0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuLi9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2NvbnRleHQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBzdWJqcXVlcnkgPSBfX3N1YmpxdWVyeV9fOwoKICAgIHZhciB0UXVlcnkgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIENPTlRFWFQgPSAnY29uZmlnLmRvbS5jb250ZXh0JzsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgQ09OVEVYVAogICAgICAgIF0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgY29udGV4dCA9IG1vZC5jb252ZW50aW9uKENPTlRFWFQpOwogICAgICAgICAgICBpZihjb250ZXh0KSB7CiAgICAgICAgICAgICAgICBtb2QuaW5zdGFuY2UuZG9tID0gbW9kLmluc3RhbmNlLiQgPSB0UXVlcnkoY29udGV4dCwgZmFjYWRlLmNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuY29udGV4dCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb250ZXh0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2NvbnZlbnRpb24vZXZlbnQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBDT05URVhUID0gJ2NvbmZpZy5kb20uY29udGV4dCcsIEVWRU5UUyA9ICdjb25maWcuZG9tLmV2ZW50cycsIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIGlzU3RyaW5nID0gXy5pc1N0cmluZywgaXNBcnJheSA9IF8uaXNBcnJheTsKICAgIHZhciBldmVudFByb3BlcnR5TG9hZE9yZGVyID0gWwogICAgICAgICdzZWxlY3RvcicsIAogICAgICAgICdkYXRhJywgCiAgICAgICAgJ2hhbmRsZXInCiAgICBdOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBFVkVOVFMKICAgICAgICBdLAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IG1vZC5jb252ZW50aW9uKEVWRU5UUyksICRjb250ZXh0ID0gZmFjYWRlLmNvbnRleHQsIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihldmVudHMpIHsKICAgICAgICAgICAgICAgIF8uZm9ySW4oZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRzQ29sbGVjdGlvbiwgZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvL3ZhciBldmVudHNDb2xsZWN0aW9uID0gZXZlbnRzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBpZighaXNBcnJheShldmVudHNDb2xsZWN0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihldmVudHNDb2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoZXZlbnRzQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoZXZlbnRzQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c0NvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF8uZWFjaChldmVudHNDb2xsZWN0aW9uLCBmdW5jdGlvbiAoZGVmaW5pdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZEV2ZW50ID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNBcnJheShkZWZpbml0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZEV2ZW50LnB1c2guYXBwbHkoYmluZEV2ZW50LCBkZWZpbml0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGhhdmUgb25lIGVkZ2VjYXNlIGhlcmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBzaG9ydCBoYW5kIGFycmF5LCBoYXMgYSBjb250ZXh0IHRoYXQgaXMgYSBzdHJpbmcgb3IgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBpdCBkb2VzbnQgaGF2ZSBpbmZvcm1hdGlvbiBmb3IgYm90aCBzZWxlY3RvciBhbmQgZGF0YSwgdGhpcyB3aWxsIGZhaWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGNhbiByZWNvdmVyIHdoZW4gYWxsIDUgcG9zc2libGUgaXRlbXMgYXJlIGRlZmluZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlciA9IGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSB3ZXJlIGFza2VkIGZvciBhIG1ldGhvZCBvbiB0aGUgbW9kdWxlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcoaGFuZGxlcikgJiYgYmluZEV2ZW50Lmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV0gPSBtb2QuaW5zdGFuY2VbaGFuZGxlcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgLy8gV2UgZGlkbnQgZmluZCBhIGZ1bmN0aW9uIDooCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgRURHRSBDQVNFOiBJZiBjb250ZXh0IGlzIGEgZnVuY3Rpb24sIHdlIHdpbGwgYXNzdW1lIGFsbCBpcyB3ZWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAgRXZlbiBpZiB0aGUgaGFuZGxlciBpcyBhIHN0cmluZyB0aGF0IG5lZWRzIHRvIGJlIHJlZmVyZW5jZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXb3JrIGFycm91bmRzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICBTaG9ydGhhbmQ6IGFkZCBudWxsL2VtcHR5IHZhbHVlcyBmb3Igc2VsZWN0b3IgYW5kIGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgTG9uZ2hhbmQ6IHN3aXRjaCB0byBsb25nIGhhbmQgYXMgaXQgaGFzIG1vcmUgZXhwbGljaXQgc3ludGF4LgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWlzU3RyaW5nKGhhbmRsZXIpICYmICFpc0Z1bmN0aW9uKGhhbmRsZXIpICYmIGJpbmRFdmVudC5sZW5ndGggPiAyIHx8IGJpbmRFdmVudC5sZW5ndGggPT09IDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gYmluZEV2ZW50W2JpbmRFdmVudC5sZW5ndGggLSAyXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1N0cmluZyhoYW5kbGVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdID0gbW9kLmluc3RhbmNlW2hhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdID0gXy5iaW5kKGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMl0sIGJpbmRFdmVudC5wb3AoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNTdHJpbmcoaGFuZGxlcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDFdID0gbW9kLmluc3RhbmNlW2hhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGV2ZW50UHJvcGVydHlMb2FkT3JkZXIsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZGVmaW5pdGlvblt4XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBkZWZpbml0aW9uW3hdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih4ID09PSAnaGFuZGxlcicgJiYgZGVmaW5pdGlvbi5jb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IF8uYmluZCh2YWx1ZSwgZGVmaW5pdGlvbi5jb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FsbCB0aGUgb24gbWV0aG9kLCB3aXRoIG91ciBhcmd1bWVudHMuCiAgICAgICAgICAgICAgICAgICAgICAgICRjb250ZXh0Lm9uLmFwcGx5KCRjb250ZXh0LCBiaW5kRXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gbW9kLmNvbnZlbnRpb24oRVZFTlRTKSwgJGNvbnRleHQgPSBmYWNhZGUuY29udGV4dDsKICAgICAgICAgICAgaWYoJGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICRjb250ZXh0Lm9mZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuZXZlbnQgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZXZlbnQuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC50ZW1wbGF0ZQogICAgQHN1Ym1vZHVsZSB0aHJ1c3QudGVtcGxhdGUuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ2NmZycsIAogICAgICAgICdkYXRhJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L3RlbXBsYXRlLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi90ZW1wbGF0ZScsIAogICAgICAgICd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi9rbm9ja291dC5lbmdpbmUnCiAgICBdOwogICAgLyoqCiAgICBNYXBzIHRoZSBhdmFpbGFibGUgdGVtcGxhdGVzLCB0byB0aGVpciBhcHByb3ByaWF0ZSBtb2R1bGUgbmFtZS4KICAgIAogICAgKipwcmVjb21waWxlZCBpcyBhIHNwZWNpYWwgY2FzZSwgYW5kIHRob3NlIG1ldGhvZHMgYXJlIGV4cGVjdGVkIHRvIGJlIGNvZGUgYnVpbHQgZnVuY3Rpb25zLgogICAgCiAgICBAcHJvcGVydHkgdHlwZXMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy50eXBlcyA9IHsKICAgICAgICAnZG9UJzogJ2RvVCcsCiAgICAgICAgJ3ByZWNvbXBpbGVkJzogdHJ1ZQogICAgfTsKICAgIC8qKgogICAgTWFwcyB0aGUgdGVtcGxhdGUgZXZhbHVhdG9ycywgc28gdGhhdCB3aGVuIGNyZWF0aW5nIGEgdGVtcGxhdGUgZm9yIGtub2Nrb3V0LCBpdCBrbm93cyBob3cgdG8gcHJvcGVybHkgb3V0cHV0IHRoZSBpbmZvcm1hdGlvbi4KICAgIAogICAgQHByb3BlcnR5IGV2YWx1YXRvcnMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy5ldmFsdWF0b3JzID0gewogICAgICAgICdkb1QnOiB7CiAgICAgICAgICAgIGxlZnQ6ICd7ez0gJywKICAgICAgICAgICAgcmlnaHQ6ICd9fScKICAgICAgICB9CiAgICB9OwogICAgLyoqCiAgICBUaGUgZGVmYXVsdCB0ZW1wbGF0ZSB0eXBlLCB1c2VkIHdoZW4gZXh0ZW5zaW9uIGlzbid0IGdpdmVuLgogICAgCiAgICBAcHJvcGVydHkgZGVmYXVsdFR5cGUKICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgIEBkZWZhdWx0ICdkb1QnCiAgICAqKi8KICAgIGV4cG9ydHMuZGVmYXVsdFR5cGUgPSAnZG9UJzsKICAgIC8qKgogICAgVGhlIGJhc2UgbG9jYXRpb24sIHJlbGF0aXZlIHRvIHRoZSBhcHBsaWNhdGlvbiBwYXRoIGZvciB0ZW1wbGF0ZSBsb2NhdGlvbi4KICAgIElmIHRlbXBsYXRlIHBhdGhzIGFyZSBnaXZlbiByZWxhdGl2ZSB0byBhcHBsaWNhdGlvbiBwYXRoLCB0aGlzIGNhbiBiZSBsZWZ0IGVtcHR5LgogICAgCiAgICBAcHJvcGVydHkgYmFzZVVybAogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQgJycKICAgICoqLwogICAgZXhwb3J0cy5iYXNlVXJsID0gJyc7CiAgICAvKioKICAgIERlZmluZXMgdGhlIGV4dGVuc2lvbiB1c2VkIGZvciB0ZW1wbGF0ZXMgc3RvcmVkIG9uIHRoZSBzZXJ2ZXIuCiAgICAKICAgIEBwcm9wZXJ0eSBleHRlbnNpb24KICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgIEBkZWZhdWx0ICcudG1wbCcKICAgICoqLwogICAgZXhwb3J0cy5leHRlbnNpb24gPSAnLnRtcGwnOwogICAgLyoqCiAgICBEZWZpbmVzIHRoZSBBTUQgcGF0aHMgdG8gZmluZCB0aGUgZ2l2ZW4gdGVtcGxhdGUgdHlwZQogICAgCiAgICBAcHJvcGVydHkgdGVtcGxhdGVQYXRocwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQge30KICAgICoqLwogICAgZXhwb3J0cy50ZW1wbGF0ZVBhdGhzID0gewogICAgICAgICdkb1QnOiAnZG9UJwogICAgfTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7Ci8vIEtub2Nrb3V0IEphdmFTY3JpcHQgbGlicmFyeSB2Mi4yLjAKLy8gKGMpIFN0ZXZlbiBTYW5kZXJzb24gLSBodHRwOi8va25vY2tvdXRqcy5jb20vCi8vIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgooZnVuY3Rpb24oKXsKdmFyIERFQlVHPXRydWU7CihmdW5jdGlvbih3aW5kb3csZG9jdW1lbnQsbmF2aWdhdG9yLGpRdWVyeSx1bmRlZmluZWQpewohZnVuY3Rpb24oZmFjdG9yeSkgewogICAgLy8gU3VwcG9ydCB0aHJlZSBtb2R1bGUgbG9hZGluZyBzY2VuYXJpb3MKICAgIGlmICh0eXBlb2YgcmVxdWlyZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAvLyBbMV0gQ29tbW9uSlMvTm9kZS5qcwogICAgICAgIHZhciB0YXJnZXQgPSBtb2R1bGVbJ2V4cG9ydHMnXSB8fCBleHBvcnRzOyAvLyBtb2R1bGUuZXhwb3J0cyBpcyBmb3IgTm9kZS5qcwogICAgICAgIGZhY3RvcnkodGFyZ2V0KTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmVbJ2FtZCddKSB7CiAgICAgICAgLy8gWzJdIEFNRCBhbm9ueW1vdXMgbW9kdWxlCiAgICAgICAgZGVmaW5lKCdrbm9ja291dCcsWydleHBvcnRzJ10sIGZhY3RvcnkpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBbM10gTm8gbW9kdWxlIGxvYWRlciAocGxhaW4gPHNjcmlwdD4gdGFnKSAtIHB1dCBkaXJlY3RseSBpbiBnbG9iYWwgbmFtZXNwYWNlCiAgICAgICAgZmFjdG9yeSh3aW5kb3dbJ2tvJ10gPSB7fSk7CiAgICB9Cn0oZnVuY3Rpb24oa29FeHBvcnRzKXsKLy8gSW50ZXJuYWxseSwgYWxsIEtPIG9iamVjdHMgYXJlIGF0dGFjaGVkIHRvIGtvRXhwb3J0cyAoZXZlbiB0aGUgbm9uLWV4cG9ydGVkIG9uZXMgd2hvc2UgbmFtZXMgd2lsbCBiZSBtaW5pZmllZCBieSB0aGUgY2xvc3VyZSBjb21waWxlcikuCi8vIEluIHRoZSBmdXR1cmUsIHRoZSBmb2xsb3dpbmcgImtvIiB2YXJpYWJsZSBtYXkgYmUgbWFkZSBkaXN0aW5jdCBmcm9tICJrb0V4cG9ydHMiIHNvIHRoYXQgcHJpdmF0ZSBvYmplY3RzIGFyZSBub3QgZXh0ZXJuYWxseSByZWFjaGFibGUuCnZhciBrbyA9IHR5cGVvZiBrb0V4cG9ydHMgIT09ICd1bmRlZmluZWQnID8ga29FeHBvcnRzIDoge307Ci8vIEdvb2dsZSBDbG9zdXJlIENvbXBpbGVyIGhlbHBlcnMgKHVzZWQgb25seSB0byBtYWtlIHRoZSBtaW5pZmllZCBmaWxlIHNtYWxsZXIpCmtvLmV4cG9ydFN5bWJvbCA9IGZ1bmN0aW9uKGtvUGF0aCwgb2JqZWN0KSB7Cgl2YXIgdG9rZW5zID0ga29QYXRoLnNwbGl0KCIuIik7CgoJLy8gSW4gdGhlIGZ1dHVyZSwgImtvIiBtYXkgYmVjb21lIGRpc3RpbmN0IGZyb20gImtvRXhwb3J0cyIgKHNvIHRoYXQgbm9uLWV4cG9ydGVkIG9iamVjdHMgYXJlIG5vdCByZWFjaGFibGUpCgkvLyBBdCB0aGF0IHBvaW50LCAidGFyZ2V0IiB3b3VsZCBiZSBzZXQgdG86ICh0eXBlb2Yga29FeHBvcnRzICE9PSAidW5kZWZpbmVkIiA/IGtvRXhwb3J0cyA6IGtvKQoJdmFyIHRhcmdldCA9IGtvOwoKCWZvciAodmFyIGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aCAtIDE7IGkrKykKCQl0YXJnZXQgPSB0YXJnZXRbdG9rZW5zW2ldXTsKCXRhcmdldFt0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdXSA9IG9iamVjdDsKfTsKa28uZXhwb3J0UHJvcGVydHkgPSBmdW5jdGlvbihvd25lciwgcHVibGljTmFtZSwgb2JqZWN0KSB7CiAgb3duZXJbcHVibGljTmFtZV0gPSBvYmplY3Q7Cn07CmtvLnZlcnNpb24gPSAiMi4yLjAiOwoKa28uZXhwb3J0U3ltYm9sKCd2ZXJzaW9uJywga28udmVyc2lvbik7CmtvLnV0aWxzID0gbmV3IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgc3RyaW5nVHJpbVJlZ2V4ID0gL14oXHN8XHUwMEEwKSt8KFxzfFx1MDBBMCkrJC9nOwoKICAgIC8vIFJlcHJlc2VudCB0aGUga25vd24gZXZlbnQgdHlwZXMgaW4gYSBjb21wYWN0IHdheSwgdGhlbiBhdCBydW50aW1lIHRyYW5zZm9ybSBpdCBpbnRvIGEgaGFzaCB3aXRoIGV2ZW50IG5hbWUgYXMga2V5IChmb3IgZmFzdCBsb29rdXApCiAgICB2YXIga25vd25FdmVudHMgPSB7fSwga25vd25FdmVudFR5cGVzQnlFdmVudE5hbWUgPSB7fTsKICAgIHZhciBrZXlFdmVudFR5cGVOYW1lID0gL0ZpcmVmb3hcLzIvaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpID8gJ0tleWJvYXJkRXZlbnQnIDogJ1VJRXZlbnRzJzsKICAgIGtub3duRXZlbnRzW2tleUV2ZW50VHlwZU5hbWVdID0gWydrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJ107CiAgICBrbm93bkV2ZW50c1snTW91c2VFdmVudHMnXSA9IFsnY2xpY2snLCAnZGJsY2xpY2snLCAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsICdtb3VzZWVudGVyJywgJ21vdXNlbGVhdmUnXTsKICAgIGZvciAodmFyIGV2ZW50VHlwZSBpbiBrbm93bkV2ZW50cykgewogICAgICAgIHZhciBrbm93bkV2ZW50c0ZvclR5cGUgPSBrbm93bkV2ZW50c1tldmVudFR5cGVdOwogICAgICAgIGlmIChrbm93bkV2ZW50c0ZvclR5cGUubGVuZ3RoKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0ga25vd25FdmVudHNGb3JUeXBlLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIGtub3duRXZlbnRUeXBlc0J5RXZlbnROYW1lW2tub3duRXZlbnRzRm9yVHlwZVtpXV0gPSBldmVudFR5cGU7CiAgICAgICAgfQogICAgfQogICAgdmFyIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudCA9IHsgJ3Byb3BlcnR5Y2hhbmdlJzogdHJ1ZSB9OyAvLyBXb3JrYXJvdW5kIGZvciBhbiBJRTkgaXNzdWUgLSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzQwNgoKICAgIC8vIERldGVjdCBJRSB2ZXJzaW9ucyBmb3IgYnVnIHdvcmthcm91bmRzICh1c2VzIElFIGNvbmRpdGlvbmFscywgbm90IFVBIHN0cmluZywgZm9yIHJvYnVzdG5lc3MpCiAgICAvLyBOb3RlIHRoYXQsIHNpbmNlIElFIDEwIGRvZXMgbm90IHN1cHBvcnQgY29uZGl0aW9uYWwgY29tbWVudHMsIHRoZSBmb2xsb3dpbmcgbG9naWMgb25seSBkZXRlY3RzIElFIDwgMTAuCiAgICAvLyBDdXJyZW50bHkgdGhpcyBpcyBieSBkZXNpZ24sIHNpbmNlIElFIDEwKyBiZWhhdmVzIGNvcnJlY3RseSB3aGVuIHRyZWF0ZWQgYXMgYSBzdGFuZGFyZCBicm93c2VyLgogICAgLy8gSWYgdGhlcmUgaXMgYSBmdXR1cmUgbmVlZCB0byBkZXRlY3Qgc3BlY2lmaWMgdmVyc2lvbnMgb2YgSUUxMCssIHdlIHdpbGwgYW1lbmQgdGhpcy4KICAgIHZhciBpZVZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHZlcnNpb24gPSAzLCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgaUVsZW1zID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpJyk7CgogICAgICAgIC8vIEtlZXAgY29uc3RydWN0aW5nIGNvbmRpdGlvbmFsIEhUTUwgYmxvY2tzIHVudGlsIHdlIGhpdCBvbmUgdGhhdCByZXNvbHZlcyB0byBhbiBlbXB0eSBmcmFnbWVudAogICAgICAgIHdoaWxlICgKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8IS0tW2lmIGd0IElFICcgKyAoKyt2ZXJzaW9uKSArICddPjxpPjwvaT48IVtlbmRpZl0tLT4nLAogICAgICAgICAgICBpRWxlbXNbMF0KICAgICAgICApOwogICAgICAgIHJldHVybiB2ZXJzaW9uID4gNCA/IHZlcnNpb24gOiB1bmRlZmluZWQ7CiAgICB9KCkpOwogICAgdmFyIGlzSWU2ID0gaWVWZXJzaW9uID09PSA2LAogICAgICAgIGlzSWU3ID0gaWVWZXJzaW9uID09PSA3OwoKICAgIGZ1bmN0aW9uIGlzQ2xpY2tPbkNoZWNrYWJsZUVsZW1lbnQoZWxlbWVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgaWYgKChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT09ICJpbnB1dCIpIHx8ICFlbGVtZW50LnR5cGUpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoZXZlbnRUeXBlLnRvTG93ZXJDYXNlKCkgIT0gImNsaWNrIikgcmV0dXJuIGZhbHNlOwogICAgICAgIHZhciBpbnB1dFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgcmV0dXJuIChpbnB1dFR5cGUgPT0gImNoZWNrYm94IikgfHwgKGlucHV0VHlwZSA9PSAicmFkaW8iKTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICAgIGZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0OiBbJ2F1dGhlbnRpY2l0eV90b2tlbicsIC9eX19SZXF1ZXN0VmVyaWZpY2F0aW9uVG9rZW4oXy4qKT8kL10sCgogICAgICAgIGFycmF5Rm9yRWFjaDogZnVuY3Rpb24gKGFycmF5LCBhY3Rpb24pIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBhY3Rpb24oYXJyYXlbaV0pOwogICAgICAgIH0sCgogICAgICAgIGFycmF5SW5kZXhPZjogZnVuY3Rpb24gKGFycmF5LCBpdGVtKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGFycmF5LCBpdGVtKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9LAoKICAgICAgICBhcnJheUZpcnN0OiBmdW5jdGlvbiAoYXJyYXksIHByZWRpY2F0ZSwgcHJlZGljYXRlT3duZXIpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBpZiAocHJlZGljYXRlLmNhbGwocHJlZGljYXRlT3duZXIsIGFycmF5W2ldKSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXlbaV07CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCgogICAgICAgIGFycmF5UmVtb3ZlSXRlbTogZnVuY3Rpb24gKGFycmF5LCBpdGVtVG9SZW1vdmUpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGFycmF5LCBpdGVtVG9SZW1vdmUpOwogICAgICAgICAgICBpZiAoaW5kZXggPj0gMCkKICAgICAgICAgICAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfSwKCiAgICAgICAgYXJyYXlHZXREaXN0aW5jdFZhbHVlczogZnVuY3Rpb24gKGFycmF5KSB7CiAgICAgICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YocmVzdWx0LCBhcnJheVtpXSkgPCAwKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIGFycmF5TWFwOiBmdW5jdGlvbiAoYXJyYXksIG1hcHBpbmcpIHsKICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG1hcHBpbmcoYXJyYXlbaV0pKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBhcnJheUZpbHRlcjogZnVuY3Rpb24gKGFycmF5LCBwcmVkaWNhdGUpIHsKICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIGlmIChwcmVkaWNhdGUoYXJyYXlbaV0pKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBhcnJheVB1c2hBbGw6IGZ1bmN0aW9uIChhcnJheSwgdmFsdWVzVG9QdXNoKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZXNUb1B1c2ggaW5zdGFuY2VvZiBBcnJheSkKICAgICAgICAgICAgICAgIGFycmF5LnB1c2guYXBwbHkoYXJyYXksIHZhbHVlc1RvUHVzaCk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmFsdWVzVG9QdXNoLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlc1RvUHVzaFtpXSk7CiAgICAgICAgICAgIHJldHVybiBhcnJheTsKICAgICAgICB9LAoKICAgICAgICBleHRlbmQ6IGZ1bmN0aW9uICh0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgICAgICAgICBmb3IodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoc291cmNlLmhhc093blByb3BlcnR5KHByb3ApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9LAoKICAgICAgICBlbXB0eURvbU5vZGU6IGZ1bmN0aW9uIChkb21Ob2RlKSB7CiAgICAgICAgICAgIHdoaWxlIChkb21Ob2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIGtvLnJlbW92ZU5vZGUoZG9tTm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIG1vdmVDbGVhbmVkTm9kZXNUb0NvbnRhaW5lckVsZW1lbnQ6IGZ1bmN0aW9uKG5vZGVzKSB7CiAgICAgICAgICAgIC8vIEVuc3VyZSBpdCdzIGEgcmVhbCBhcnJheSwgYXMgd2UncmUgYWJvdXQgdG8gcmVwYXJlbnQgdGhlIG5vZGVzIGFuZAogICAgICAgICAgICAvLyB3ZSBkb24ndCB3YW50IHRoZSB1bmRlcmx5aW5nIGNvbGxlY3Rpb24gdG8gY2hhbmdlIHdoaWxlIHdlJ3JlIGRvaW5nIHRoYXQuCiAgICAgICAgICAgIHZhciBub2Rlc0FycmF5ID0ga28udXRpbHMubWFrZUFycmF5KG5vZGVzKTsKCiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBub2Rlc0FycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGtvLmNsZWFuTm9kZShub2Rlc0FycmF5W2ldKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjsKICAgICAgICB9LAoKICAgICAgICBjbG9uZU5vZGVzOiBmdW5jdGlvbiAobm9kZXNBcnJheSwgc2hvdWxkQ2xlYW5Ob2RlcykgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzQXJyYXkubGVuZ3RoLCBuZXdOb2Rlc0FycmF5ID0gW107IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjbG9uZWROb2RlID0gbm9kZXNBcnJheVtpXS5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgICAgICAgICBuZXdOb2Rlc0FycmF5LnB1c2goc2hvdWxkQ2xlYW5Ob2RlcyA/IGtvLmNsZWFuTm9kZShjbG9uZWROb2RlKSA6IGNsb25lZE5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdOb2Rlc0FycmF5OwogICAgICAgIH0sCgogICAgICAgIHNldERvbU5vZGVDaGlsZHJlbjogZnVuY3Rpb24gKGRvbU5vZGUsIGNoaWxkTm9kZXMpIHsKICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKGRvbU5vZGUpOwogICAgICAgICAgICBpZiAoY2hpbGROb2RlcykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBjaGlsZE5vZGVzLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBkb21Ob2RlLmFwcGVuZENoaWxkKGNoaWxkTm9kZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcmVwbGFjZURvbU5vZGVzOiBmdW5jdGlvbiAobm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5LCBuZXdOb2Rlc0FycmF5KSB7CiAgICAgICAgICAgIHZhciBub2Rlc1RvUmVwbGFjZUFycmF5ID0gbm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gW25vZGVUb1JlcGxhY2VPck5vZGVBcnJheV0gOiBub2RlVG9SZXBsYWNlT3JOb2RlQXJyYXk7CiAgICAgICAgICAgIGlmIChub2Rlc1RvUmVwbGFjZUFycmF5Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBpbnNlcnRpb25Qb2ludCA9IG5vZGVzVG9SZXBsYWNlQXJyYXlbMF07CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gaW5zZXJ0aW9uUG9pbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gbmV3Tm9kZXNBcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShuZXdOb2Rlc0FycmF5W2ldLCBpbnNlcnRpb25Qb2ludCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzVG9SZXBsYWNlQXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAga28ucmVtb3ZlTm9kZShub2Rlc1RvUmVwbGFjZUFycmF5W2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZTogZnVuY3Rpb24gKG9wdGlvbk5vZGUsIGlzU2VsZWN0ZWQpIHsKICAgICAgICAgICAgLy8gSUU2IHNvbWV0aW1lcyB0aHJvd3MgInVua25vd24gZXJyb3IiIGlmIHlvdSB0cnkgdG8gd3JpdGUgdG8gLnNlbGVjdGVkIGRpcmVjdGx5LCB3aGVyZWFzIEZpcmVmb3ggc3RydWdnbGVzIHdpdGggc2V0QXR0cmlidXRlLiBQaWNrIG9uZSBiYXNlZCBvbiBicm93c2VyLgogICAgICAgICAgICBpZiAoaWVWZXJzaW9uIDwgNykKICAgICAgICAgICAgICAgIG9wdGlvbk5vZGUuc2V0QXR0cmlidXRlKCJzZWxlY3RlZCIsIGlzU2VsZWN0ZWQpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBvcHRpb25Ob2RlLnNlbGVjdGVkID0gaXNTZWxlY3RlZDsKICAgICAgICB9LAoKICAgICAgICBzdHJpbmdUcmltOiBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiAoc3RyaW5nIHx8ICIiKS5yZXBsYWNlKHN0cmluZ1RyaW1SZWdleCwgIiIpOwogICAgICAgIH0sCgogICAgICAgIHN0cmluZ1Rva2VuaXplOiBmdW5jdGlvbiAoc3RyaW5nLCBkZWxpbWl0ZXIpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICB2YXIgdG9rZW5zID0gKHN0cmluZyB8fCAiIikuc3BsaXQoZGVsaW1pdGVyKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSB0b2tlbnMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdHJpbW1lZCA9IGtvLnV0aWxzLnN0cmluZ1RyaW0odG9rZW5zW2ldKTsKICAgICAgICAgICAgICAgIGlmICh0cmltbWVkICE9PSAiIikKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh0cmltbWVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIHN0cmluZ1N0YXJ0c1dpdGg6IGZ1bmN0aW9uIChzdHJpbmcsIHN0YXJ0c1dpdGgpIHsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nIHx8ICIiOwogICAgICAgICAgICBpZiAoc3RhcnRzV2l0aC5sZW5ndGggPiBzdHJpbmcubGVuZ3RoKQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnN1YnN0cmluZygwLCBzdGFydHNXaXRoLmxlbmd0aCkgPT09IHN0YXJ0c1dpdGg7CiAgICAgICAgfSwKCiAgICAgICAgZG9tTm9kZUlzQ29udGFpbmVkQnk6IGZ1bmN0aW9uIChub2RlLCBjb250YWluZWRCeU5vZGUpIHsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lZEJ5Tm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikKICAgICAgICAgICAgICAgIHJldHVybiAoY29udGFpbmVkQnlOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG5vZGUpICYgMTYpID09IDE2OwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZSA9PSBjb250YWluZWRCeU5vZGUpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICBkb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQ6IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBrby51dGlscy5kb21Ob2RlSXNDb250YWluZWRCeShub2RlLCBub2RlLm93bmVyRG9jdW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIHRhZ05hbWVMb3dlcjogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICAvLyBGb3IgSFRNTCBlbGVtZW50cywgdGFnTmFtZSB3aWxsIGFsd2F5cyBiZSB1cHBlciBjYXNlOyBmb3IgWEhUTUwgZWxlbWVudHMsIGl0J2xsIGJlIGxvd2VyIGNhc2UuCiAgICAgICAgICAgIC8vIFBvc3NpYmxlIGZ1dHVyZSBvcHRpbWl6YXRpb246IElmIHdlIGtub3cgaXQncyBhbiBlbGVtZW50IGZyb20gYW4gWEhUTUwgZG9jdW1lbnQgKG5vdCBIVE1MKSwKICAgICAgICAgICAgLy8gd2UgZG9uJ3QgbmVlZCB0byBkbyB0aGUgLnRvTG93ZXJDYXNlKCkgYXMgaXQgd2lsbCBhbHdheXMgYmUgbG93ZXIgY2FzZSBhbnl3YXkuCiAgICAgICAgICAgIHJldHVybiBlbGVtZW50ICYmIGVsZW1lbnQudGFnTmFtZSAmJiBlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICB9LAoKICAgICAgICByZWdpc3RlckV2ZW50SGFuZGxlcjogZnVuY3Rpb24gKGVsZW1lbnQsIGV2ZW50VHlwZSwgaGFuZGxlcikgewogICAgICAgICAgICB2YXIgbXVzdFVzZUF0dGFjaEV2ZW50ID0gaWVWZXJzaW9uICYmIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudFtldmVudFR5cGVdOwogICAgICAgICAgICBpZiAoIW11c3RVc2VBdHRhY2hFdmVudCAmJiB0eXBlb2YgalF1ZXJ5ICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRm9yIGNsaWNrIGV2ZW50cyBvbiBjaGVja2JveGVzLCBqUXVlcnkgaW50ZXJmZXJlcyB3aXRoIHRoZSBldmVudCBoYW5kbGluZyBpbiBhbiBhd2t3YXJkIHdheToKICAgICAgICAgICAgICAgICAgICAvLyBpdCB0b2dnbGVzIHRoZSBlbGVtZW50IGNoZWNrZWQgc3RhdGUgKmFmdGVyKiB0aGUgY2xpY2sgZXZlbnQgaGFuZGxlcnMgcnVuLCB3aGVyZWFzIG5hdGl2ZQogICAgICAgICAgICAgICAgICAgIC8vIGNsaWNrIGV2ZW50cyB0b2dnbGUgdGhlIGNoZWNrZWQgc3RhdGUgKmJlZm9yZSogdGhlIGV2ZW50IGhhbmRsZXIuCiAgICAgICAgICAgICAgICAgICAgLy8gRml4IHRoaXMgYnkgaW50ZWNlcHRpbmcgdGhlIGhhbmRsZXIgYW5kIGFwcGx5aW5nIHRoZSBjb3JyZWN0IGNoZWNrZWRuZXNzIGJlZm9yZSBpdCBydW5zLgogICAgICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbEhhbmRsZXIgPSBoYW5kbGVyOwogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBmdW5jdGlvbihldmVudCwgZXZlbnREYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBqUXVlcnlTdXBwbGllZENoZWNrZWRTdGF0ZSA9IHRoaXMuY2hlY2tlZDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50RGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IGV2ZW50RGF0YS5jaGVja2VkU3RhdGVCZWZvcmVFdmVudCAhPT0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxIYW5kbGVyLmNhbGwodGhpcywgZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoZWNrZWQgPSBqUXVlcnlTdXBwbGllZENoZWNrZWRTdGF0ZTsgLy8gUmVzdG9yZSB0aGUgc3RhdGUgalF1ZXJ5IGFwcGxpZWQKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgalF1ZXJ5KGVsZW1lbnQpWydiaW5kJ10oZXZlbnRUeXBlLCBoYW5kbGVyKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghbXVzdFVzZUF0dGFjaEV2ZW50ICYmIHR5cGVvZiBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIgPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGhhbmRsZXIsIGZhbHNlKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIGVsZW1lbnQuYXR0YWNoRXZlbnQgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICBlbGVtZW50LmF0dGFjaEV2ZW50KCJvbiIgKyBldmVudFR5cGUsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuY2FsbChlbGVtZW50LCBldmVudCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJCcm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBhZGRFdmVudExpc3RlbmVyIG9yIGF0dGFjaEV2ZW50Iik7CiAgICAgICAgfSwKCiAgICAgICAgdHJpZ2dlckV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIGlmICghKGVsZW1lbnQgJiYgZWxlbWVudC5ub2RlVHlwZSkpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImVsZW1lbnQgbXVzdCBiZSBhIERPTSBub2RlIHdoZW4gY2FsbGluZyB0cmlnZ2VyRXZlbnQiKTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgalF1ZXJ5ICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnREYXRhID0gW107CiAgICAgICAgICAgICAgICBpZiAoaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV29yayBhcm91bmQgdGhlIGpRdWVyeSAiY2xpY2sgZXZlbnRzIG9uIGNoZWNrYm94ZXMiIGlzc3VlIGRlc2NyaWJlZCBhYm92ZSBieSBzdG9yaW5nIHRoZSBvcmlnaW5hbCBjaGVja2VkIHN0YXRlIGJlZm9yZSB0cmlnZ2VyaW5nIHRoZSBoYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgZXZlbnREYXRhLnB1c2goeyBjaGVja2VkU3RhdGVCZWZvcmVFdmVudDogZWxlbWVudC5jaGVja2VkIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgalF1ZXJ5KGVsZW1lbnQpWyd0cmlnZ2VyJ10oZXZlbnRUeXBlLCBldmVudERhdGEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkb2N1bWVudC5jcmVhdGVFdmVudCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQuZGlzcGF0Y2hFdmVudCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50Q2F0ZWdvcnkgPSBrbm93bkV2ZW50VHlwZXNCeUV2ZW50TmFtZVtldmVudFR5cGVdIHx8ICJIVE1MRXZlbnRzIjsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChldmVudENhdGVnb3J5KTsKICAgICAgICAgICAgICAgICAgICBldmVudC5pbml0RXZlbnQoZXZlbnRUeXBlLCB0cnVlLCB0cnVlLCB3aW5kb3csIDAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIHN1cHBsaWVkIGVsZW1lbnQgZG9lc24ndCBzdXBwb3J0IGRpc3BhdGNoRXZlbnQiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZWxlbWVudC5maXJlRXZlbnQgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIC8vIFVubGlrZSBvdGhlciBicm93c2VycywgSUUgZG9lc24ndCBjaGFuZ2UgdGhlIGNoZWNrZWQgc3RhdGUgb2YgY2hlY2tib3hlcy9yYWRpb2J1dHRvbnMgd2hlbiB5b3UgdHJpZ2dlciB0aGVpciAiY2xpY2siIGV2ZW50CiAgICAgICAgICAgICAgICAvLyBzbyB0byBtYWtlIGl0IGNvbnNpc3RlbnQsIHdlJ2xsIGRvIGl0IG1hbnVhbGx5IGhlcmUKICAgICAgICAgICAgICAgIGlmIChpc0NsaWNrT25DaGVja2FibGVFbGVtZW50KGVsZW1lbnQsIGV2ZW50VHlwZSkpCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0gZWxlbWVudC5jaGVja2VkICE9PSB0cnVlOwogICAgICAgICAgICAgICAgZWxlbWVudC5maXJlRXZlbnQoIm9uIiArIGV2ZW50VHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJCcm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCB0cmlnZ2VyaW5nIGV2ZW50cyIpOwogICAgICAgIH0sCgogICAgICAgIHVud3JhcE9ic2VydmFibGU6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4ga28uaXNPYnNlcnZhYmxlKHZhbHVlKSA/IHZhbHVlKCkgOiB2YWx1ZTsKICAgICAgICB9LAoKICAgICAgICBwZWVrT2JzZXJ2YWJsZTogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBrby5pc09ic2VydmFibGUodmFsdWUpID8gdmFsdWUucGVlaygpIDogdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgdG9nZ2xlRG9tTm9kZUNzc0NsYXNzOiBmdW5jdGlvbiAobm9kZSwgY2xhc3NOYW1lcywgc2hvdWxkSGF2ZUNsYXNzKSB7CiAgICAgICAgICAgIGlmIChjbGFzc05hbWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgY3NzQ2xhc3NOYW1lUmVnZXggPSAvW1x3LV0rL2csCiAgICAgICAgICAgICAgICAgICAgY3VycmVudENsYXNzTmFtZXMgPSBub2RlLmNsYXNzTmFtZS5tYXRjaChjc3NDbGFzc05hbWVSZWdleCkgfHwgW107CiAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goY2xhc3NOYW1lcy5tYXRjaChjc3NDbGFzc05hbWVSZWdleCksIGZ1bmN0aW9uKGNsYXNzTmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbmRleE9mQ2xhc3MgPSBrby51dGlscy5hcnJheUluZGV4T2YoY3VycmVudENsYXNzTmFtZXMsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4T2ZDbGFzcyA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2hvdWxkSGF2ZUNsYXNzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudENsYXNzTmFtZXMuc3BsaWNlKGluZGV4T2ZDbGFzcywgMSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZEhhdmVDbGFzcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDbGFzc05hbWVzLnB1c2goY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIG5vZGUuY2xhc3NOYW1lID0gY3VycmVudENsYXNzTmFtZXMuam9pbigiICIpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgc2V0VGV4dENvbnRlbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHRleHRDb250ZW50KSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodGV4dENvbnRlbnQpOwogICAgICAgICAgICBpZiAoKHZhbHVlID09PSBudWxsKSB8fCAodmFsdWUgPT09IHVuZGVmaW5lZCkpCiAgICAgICAgICAgICAgICB2YWx1ZSA9ICIiOwoKICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDMpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuZGF0YSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gV2UgbmVlZCB0aGVyZSB0byBiZSBleGFjdGx5IG9uZSBjaGlsZDogYSB0ZXh0IG5vZGUuCiAgICAgICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgbm8gY2hpbGRyZW4sIG1vcmUgdGhhbiBvbmUsIG9yIGlmIGl0J3Mgbm90IGEgdGV4dCBub2RlLAogICAgICAgICAgICAgICAgLy8gd2UnbGwgY2xlYXIgZXZlcnl0aGluZyBhbmQgY3JlYXRlIGEgc2luZ2xlIHRleHQgbm9kZS4KICAgICAgICAgICAgICAgIHZhciBpbm5lclRleHROb2RlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICBpZiAoIWlubmVyVGV4dE5vZGUgfHwgaW5uZXJUZXh0Tm9kZS5ub2RlVHlwZSAhPSAzIHx8IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhpbm5lclRleHROb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4oZWxlbWVudCwgW2RvY3VtZW50LmNyZWF0ZVRleHROb2RlKHZhbHVlKV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpbm5lclRleHROb2RlLmRhdGEgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBrby51dGlscy5mb3JjZVJlZnJlc2goZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzZXRFbGVtZW50TmFtZTogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSkgewogICAgICAgICAgICBlbGVtZW50Lm5hbWUgPSBuYW1lOwoKICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBJRSA2LzcgaXNzdWUKICAgICAgICAgICAgLy8gLSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzE5NwogICAgICAgICAgICAvLyAtIGh0dHA6Ly93d3cubWF0dHM0MTEuY29tL3Bvc3Qvc2V0dGluZ190aGVfbmFtZV9hdHRyaWJ1dGVfaW5faWVfZG9tLwogICAgICAgICAgICBpZiAoaWVWZXJzaW9uIDw9IDcpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5tZXJnZUF0dHJpYnV0ZXMoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiPGlucHV0IG5hbWU9JyIgKyBlbGVtZW50Lm5hbWUgKyAiJy8+IiksIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGNoKGUpIHt9IC8vIEZvciBJRTkgd2l0aCBkb2MgbW9kZSAiSUU5IFN0YW5kYXJkcyIgYW5kIGJyb3dzZXIgbW9kZSAiSUU5IENvbXBhdGliaWxpdHkgVmlldyIKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGZvcmNlUmVmcmVzaDogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBhbiBJRTkgcmVuZGVyaW5nIGJ1ZyAtIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMjA5CiAgICAgICAgICAgIGlmIChpZVZlcnNpb24gPj0gOSkgewogICAgICAgICAgICAgICAgLy8gRm9yIHRleHQgbm9kZXMgYW5kIGNvbW1lbnQgbm9kZXMgKG1vc3QgbGlrZWx5IHZpcnR1YWwgZWxlbWVudHMpLCB3ZSB3aWxsIGhhdmUgdG8gcmVmcmVzaCB0aGUgY29udGFpbmVyCiAgICAgICAgICAgICAgICB2YXIgZWxlbSA9IG5vZGUubm9kZVR5cGUgPT0gMSA/IG5vZGUgOiBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICBpZiAoZWxlbS5zdHlsZSkKICAgICAgICAgICAgICAgICAgICBlbGVtLnN0eWxlLnpvb20gPSBlbGVtLnN0eWxlLnpvb207CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBlbnN1cmVTZWxlY3RFbGVtZW50SXNSZW5kZXJlZENvcnJlY3RseTogZnVuY3Rpb24oc2VsZWN0RWxlbWVudCkgewogICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBJRTkgcmVuZGVyaW5nIGJ1ZyAtIGl0IGRvZXNuJ3QgcmVsaWFibHkgZGlzcGxheSBhbGwgdGhlIHRleHQgaW4gZHluYW1pY2FsbHktYWRkZWQgc2VsZWN0IGJveGVzIHVubGVzcyB5b3UgZm9yY2UgaXQgdG8gcmUtcmVuZGVyIGJ5IHVwZGF0aW5nIHRoZSB3aWR0aC4KICAgICAgICAgICAgLy8gKFNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzMxMiwgaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy81OTA4NDk0L3NlbGVjdC1vbmx5LXNob3dzLWZpcnN0LWNoYXItb2Ytc2VsZWN0ZWQtb3B0aW9uKQogICAgICAgICAgICBpZiAoaWVWZXJzaW9uID49IDkpIHsKICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbFdpZHRoID0gc2VsZWN0RWxlbWVudC5zdHlsZS53aWR0aDsKICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuc3R5bGUud2lkdGggPSAwOwogICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5zdHlsZS53aWR0aCA9IG9yaWdpbmFsV2lkdGg7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICByYW5nZTogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CiAgICAgICAgICAgIG1pbiA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobWluKTsKICAgICAgICAgICAgbWF4ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtYXgpOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBtaW47IGkgPD0gbWF4OyBpKyspCiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBtYWtlQXJyYXk6IGZ1bmN0aW9uKGFycmF5TGlrZU9iamVjdCkgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXlMaWtlT2JqZWN0Lmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goYXJyYXlMaWtlT2JqZWN0W2ldKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBpc0llNiA6IGlzSWU2LAogICAgICAgIGlzSWU3IDogaXNJZTcsCiAgICAgICAgaWVWZXJzaW9uIDogaWVWZXJzaW9uLAoKICAgICAgICBnZXRGb3JtRmllbGRzOiBmdW5jdGlvbihmb3JtLCBmaWVsZE5hbWUpIHsKICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtvLnV0aWxzLm1ha2VBcnJheShmb3JtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpbnB1dCIpKS5jb25jYXQoa28udXRpbHMubWFrZUFycmF5KGZvcm0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRleHRhcmVhIikpKTsKICAgICAgICAgICAgdmFyIGlzTWF0Y2hpbmdGaWVsZCA9ICh0eXBlb2YgZmllbGROYW1lID09ICdzdHJpbmcnKQogICAgICAgICAgICAgICAgPyBmdW5jdGlvbihmaWVsZCkgeyByZXR1cm4gZmllbGQubmFtZSA9PT0gZmllbGROYW1lIH0KICAgICAgICAgICAgICAgIDogZnVuY3Rpb24oZmllbGQpIHsgcmV0dXJuIGZpZWxkTmFtZS50ZXN0KGZpZWxkLm5hbWUpIH07IC8vIFRyZWF0IGZpZWxkTmFtZSBhcyByZWdleCBvciBvYmplY3QgY29udGFpbmluZyBwcmVkaWNhdGUKICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IGZpZWxkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdGaWVsZChmaWVsZHNbaV0pKQogICAgICAgICAgICAgICAgICAgIG1hdGNoZXMucHVzaChmaWVsZHNbaV0pOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gbWF0Y2hlczsKICAgICAgICB9LAoKICAgICAgICBwYXJzZUpzb246IGZ1bmN0aW9uIChqc29uU3RyaW5nKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YganNvblN0cmluZyA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAganNvblN0cmluZyA9IGtvLnV0aWxzLnN0cmluZ1RyaW0oanNvblN0cmluZyk7CiAgICAgICAgICAgICAgICBpZiAoanNvblN0cmluZykgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuSlNPTiAmJiB3aW5kb3cuSlNPTi5wYXJzZSkgLy8gVXNlIG5hdGl2ZSBwYXJzaW5nIHdoZXJlIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93LkpTT04ucGFyc2UoanNvblN0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChuZXcgRnVuY3Rpb24oInJldHVybiAiICsganNvblN0cmluZykpKCk7IC8vIEZhbGxiYWNrIG9uIGxlc3Mgc2FmZSBwYXJzaW5nIGZvciBvbGRlciBicm93c2VycwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCgogICAgICAgIHN0cmluZ2lmeUpzb246IGZ1bmN0aW9uIChkYXRhLCByZXBsYWNlciwgc3BhY2UpIHsgICAvLyByZXBsYWNlciBhbmQgc3BhY2UgYXJlIG9wdGlvbmFsCiAgICAgICAgICAgIGlmICgodHlwZW9mIEpTT04gPT0gInVuZGVmaW5lZCIpIHx8ICh0eXBlb2YgSlNPTi5zdHJpbmdpZnkgPT0gInVuZGVmaW5lZCIpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmluZCBKU09OLnN0cmluZ2lmeSgpLiBTb21lIGJyb3dzZXJzIChlLmcuLCBJRSA8IDgpIGRvbid0IHN1cHBvcnQgaXQgbmF0aXZlbHksIGJ1dCB5b3UgY2FuIG92ZXJjb21lIHRoaXMgYnkgYWRkaW5nIGEgc2NyaXB0IHJlZmVyZW5jZSB0byBqc29uMi5qcywgZG93bmxvYWRhYmxlIGZyb20gaHR0cDovL3d3dy5qc29uLm9yZy9qc29uMi5qcyIpOwogICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhKSwgcmVwbGFjZXIsIHNwYWNlKTsKICAgICAgICB9LAoKICAgICAgICBwb3N0SnNvbjogZnVuY3Rpb24gKHVybE9yRm9ybSwgZGF0YSwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgdmFyIHBhcmFtcyA9IG9wdGlvbnNbJ3BhcmFtcyddIHx8IHt9OwogICAgICAgICAgICB2YXIgaW5jbHVkZUZpZWxkcyA9IG9wdGlvbnNbJ2luY2x1ZGVGaWVsZHMnXSB8fCB0aGlzLmZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0OwogICAgICAgICAgICB2YXIgdXJsID0gdXJsT3JGb3JtOwoKICAgICAgICAgICAgLy8gSWYgd2Ugd2VyZSBnaXZlbiBhIGZvcm0sIHVzZSBpdHMgJ2FjdGlvbicgVVJMIGFuZCBwaWNrIG91dCBhbnkgcmVxdWVzdGVkIGZpZWxkIHZhbHVlcwogICAgICAgICAgICBpZigodHlwZW9mIHVybE9yRm9ybSA9PSAnb2JqZWN0JykgJiYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcih1cmxPckZvcm0pID09PSAiZm9ybSIpKSB7CiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxGb3JtID0gdXJsT3JGb3JtOwogICAgICAgICAgICAgICAgdXJsID0gb3JpZ2luYWxGb3JtLmFjdGlvbjsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBpbmNsdWRlRmllbGRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtvLnV0aWxzLmdldEZvcm1GaWVsZHMob3JpZ2luYWxGb3JtLCBpbmNsdWRlRmllbGRzW2ldKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gZmllbGRzLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tKQogICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXNbZmllbGRzW2pdLm5hbWVdID0gZmllbGRzW2pdLnZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBkYXRhID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhKTsKICAgICAgICAgICAgdmFyIGZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmb3JtIik7CiAgICAgICAgICAgIGZvcm0uc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgZm9ybS5hY3Rpb24gPSB1cmw7CiAgICAgICAgICAgIGZvcm0ubWV0aG9kID0gInBvc3QiOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgICAgICAgICAgIGlucHV0Lm5hbWUgPSBrZXk7CiAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IGtvLnV0aWxzLnN0cmluZ2lmeUpzb24oa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhW2tleV0pKTsKICAgICAgICAgICAgICAgIGZvcm0uYXBwZW5kQ2hpbGQoaW5wdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwYXJhbXMpIHsKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICAgICAgICBpbnB1dC5uYW1lID0ga2V5OwogICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBwYXJhbXNba2V5XTsKICAgICAgICAgICAgICAgIGZvcm0uYXBwZW5kQ2hpbGQoaW5wdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZm9ybSk7CiAgICAgICAgICAgIG9wdGlvbnNbJ3N1Ym1pdHRlciddID8gb3B0aW9uc1snc3VibWl0dGVyJ10oZm9ybSkgOiBmb3JtLnN1Ym1pdCgpOwogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgZm9ybS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGZvcm0pOyB9LCAwKTsKICAgICAgICB9CiAgICB9Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ3V0aWxzJywga28udXRpbHMpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5Rm9yRWFjaCcsIGtvLnV0aWxzLmFycmF5Rm9yRWFjaCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlGaXJzdCcsIGtvLnV0aWxzLmFycmF5Rmlyc3QpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5RmlsdGVyJywga28udXRpbHMuYXJyYXlGaWx0ZXIpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5R2V0RGlzdGluY3RWYWx1ZXMnLCBrby51dGlscy5hcnJheUdldERpc3RpbmN0VmFsdWVzKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheUluZGV4T2YnLCBrby51dGlscy5hcnJheUluZGV4T2YpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5TWFwJywga28udXRpbHMuYXJyYXlNYXApOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5UHVzaEFsbCcsIGtvLnV0aWxzLmFycmF5UHVzaEFsbCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlSZW1vdmVJdGVtJywga28udXRpbHMuYXJyYXlSZW1vdmVJdGVtKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5leHRlbmQnLCBrby51dGlscy5leHRlbmQpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0Jywga28udXRpbHMuZmllbGRzSW5jbHVkZWRXaXRoSnNvblBvc3QpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmdldEZvcm1GaWVsZHMnLCBrby51dGlscy5nZXRGb3JtRmllbGRzKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wZWVrT2JzZXJ2YWJsZScsIGtvLnV0aWxzLnBlZWtPYnNlcnZhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wb3N0SnNvbicsIGtvLnV0aWxzLnBvc3RKc29uKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wYXJzZUpzb24nLCBrby51dGlscy5wYXJzZUpzb24pOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyJywga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnN0cmluZ2lmeUpzb24nLCBrby51dGlscy5zdHJpbmdpZnlKc29uKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5yYW5nZScsIGtvLnV0aWxzLnJhbmdlKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MnLCBrby51dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnRyaWdnZXJFdmVudCcsIGtvLnV0aWxzLnRyaWdnZXJFdmVudCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMudW53cmFwT2JzZXJ2YWJsZScsIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUpOwoKaWYgKCFGdW5jdGlvbi5wcm90b3R5cGVbJ2JpbmQnXSkgewogICAgLy8gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgaXMgYSBzdGFuZGFyZCBwYXJ0IG9mIEVDTUFTY3JpcHQgNXRoIEVkaXRpb24gKERlY2VtYmVyIDIwMDksIGh0dHA6Ly93d3cuZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9wdWJsaWNhdGlvbnMvZmlsZXMvRUNNQS1TVC9FQ01BLTI2Mi5wZGYpCiAgICAvLyBJbiBjYXNlIHRoZSBicm93c2VyIGRvZXNuJ3QgaW1wbGVtZW50IGl0IG5hdGl2ZWx5LCBwcm92aWRlIGEgSmF2YVNjcmlwdCBpbXBsZW1lbnRhdGlvbi4gVGhpcyBpbXBsZW1lbnRhdGlvbiBpcyBiYXNlZCBvbiB0aGUgb25lIGluIHByb3RvdHlwZS5qcwogICAgRnVuY3Rpb24ucHJvdG90eXBlWydiaW5kJ10gPSBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICAgICAgdmFyIG9yaWdpbmFsRnVuY3Rpb24gPSB0aGlzLCBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSwgb2JqZWN0ID0gYXJncy5zaGlmdCgpOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbEZ1bmN0aW9uLmFwcGx5KG9iamVjdCwgYXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgIH07CiAgICB9Owp9Cgprby51dGlscy5kb21EYXRhID0gbmV3IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgdW5pcXVlSWQgPSAwOwogICAgdmFyIGRhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWUgPSAiX19rb19fIiArIChuZXcgRGF0ZSkuZ2V0VGltZSgpOwogICAgdmFyIGRhdGFTdG9yZSA9IHt9OwogICAgcmV0dXJuIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChub2RlLCBrZXkpIHsKICAgICAgICAgICAgdmFyIGFsbERhdGFGb3JOb2RlID0ga28udXRpbHMuZG9tRGF0YS5nZXRBbGwobm9kZSwgZmFsc2UpOwogICAgICAgICAgICByZXR1cm4gYWxsRGF0YUZvck5vZGUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IGFsbERhdGFGb3JOb2RlW2tleV07CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIChub2RlLCBrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgd2UgZG9uJ3QgYWN0dWFsbHkgY3JlYXRlIGEgbmV3IGRvbURhdGEga2V5IGlmIHdlIGFyZSBhY3R1YWxseSBkZWxldGluZyBhIHZhbHVlCiAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuZG9tRGF0YS5nZXRBbGwobm9kZSwgZmFsc2UpID09PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbGxEYXRhRm9yTm9kZSA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0QWxsKG5vZGUsIHRydWUpOwogICAgICAgICAgICBhbGxEYXRhRm9yTm9kZVtrZXldID0gdmFsdWU7CiAgICAgICAgfSwKICAgICAgICBnZXRBbGw6IGZ1bmN0aW9uIChub2RlLCBjcmVhdGVJZk5vdEZvdW5kKSB7CiAgICAgICAgICAgIHZhciBkYXRhU3RvcmVLZXkgPSBub2RlW2RhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWVdOwogICAgICAgICAgICB2YXIgaGFzRXhpc3RpbmdEYXRhU3RvcmUgPSBkYXRhU3RvcmVLZXkgJiYgKGRhdGFTdG9yZUtleSAhPT0gIm51bGwiKSAmJiBkYXRhU3RvcmVbZGF0YVN0b3JlS2V5XTsKICAgICAgICAgICAgaWYgKCFoYXNFeGlzdGluZ0RhdGFTdG9yZSkgewogICAgICAgICAgICAgICAgaWYgKCFjcmVhdGVJZk5vdEZvdW5kKQogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICBkYXRhU3RvcmVLZXkgPSBub2RlW2RhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWVdID0gImtvIiArIHVuaXF1ZUlkKys7CiAgICAgICAgICAgICAgICBkYXRhU3RvcmVbZGF0YVN0b3JlS2V5XSA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkYXRhU3RvcmVbZGF0YVN0b3JlS2V5XTsKICAgICAgICB9LAogICAgICAgIGNsZWFyOiBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICB2YXIgZGF0YVN0b3JlS2V5ID0gbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXTsKICAgICAgICAgICAgaWYgKGRhdGFTdG9yZUtleSkgewogICAgICAgICAgICAgICAgZGVsZXRlIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldOwogICAgICAgICAgICAgICAgbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXSA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gRXhwb3NpbmcgImRpZCBjbGVhbiIgZmxhZyBwdXJlbHkgc28gc3BlY3MgY2FuIGluZmVyIHdoZXRoZXIgdGhpbmdzIGhhdmUgYmVlbiBjbGVhbmVkIHVwIGFzIGludGVuZGVkCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tRGF0YScsIGtvLnV0aWxzLmRvbURhdGEpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbURhdGEuY2xlYXInLCBrby51dGlscy5kb21EYXRhLmNsZWFyKTsgLy8gRXhwb3J0aW5nIG9ubHkgc28gc3BlY3MgY2FuIGNsZWFyIHVwIGFmdGVyIHRoZW1zZWx2ZXMgZnVsbHkKCmtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbCA9IG5ldyAoZnVuY3Rpb24gKCkgewogICAgdmFyIGRvbURhdGFLZXkgPSAiX19rb19kb21Ob2RlRGlzcG9zYWxfXyIgKyAobmV3IERhdGUpLmdldFRpbWUoKTsKICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXMgPSB7IDE6IHRydWUsIDg6IHRydWUsIDk6IHRydWUgfTsgICAgICAgLy8gRWxlbWVudCwgQ29tbWVudCwgRG9jdW1lbnQKICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXNXaXRoRGVzY2VuZGFudHMgPSB7IDE6IHRydWUsIDk6IHRydWUgfTsgLy8gRWxlbWVudCwgRG9jdW1lbnQKCiAgICBmdW5jdGlvbiBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBjcmVhdGVJZk5vdEZvdW5kKSB7CiAgICAgICAgdmFyIGFsbERpc3Bvc2VDYWxsYmFja3MgPSBrby51dGlscy5kb21EYXRhLmdldChub2RlLCBkb21EYXRhS2V5KTsKICAgICAgICBpZiAoKGFsbERpc3Bvc2VDYWxsYmFja3MgPT09IHVuZGVmaW5lZCkgJiYgY3JlYXRlSWZOb3RGb3VuZCkgewogICAgICAgICAgICBhbGxEaXNwb3NlQ2FsbGJhY2tzID0gW107CiAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIGRvbURhdGFLZXksIGFsbERpc3Bvc2VDYWxsYmFja3MpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYWxsRGlzcG9zZUNhbGxiYWNrczsKICAgIH0KICAgIGZ1bmN0aW9uIGRlc3Ryb3lDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUpIHsKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChub2RlLCBkb21EYXRhS2V5LCB1bmRlZmluZWQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsZWFuU2luZ2xlTm9kZShub2RlKSB7CiAgICAgICAgLy8gUnVuIGFsbCB0aGUgZGlzcG9zZSBjYWxsYmFja3MKICAgICAgICB2YXIgY2FsbGJhY2tzID0gZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgZmFsc2UpOwogICAgICAgIGlmIChjYWxsYmFja3MpIHsKICAgICAgICAgICAgY2FsbGJhY2tzID0gY2FsbGJhY2tzLnNsaWNlKDApOyAvLyBDbG9uZSwgYXMgdGhlIGFycmF5IG1heSBiZSBtb2RpZmllZCBkdXJpbmcgaXRlcmF0aW9uICh0eXBpY2FsbHksIGNhbGxiYWNrcyB3aWxsIHJlbW92ZSB0aGVtc2VsdmVzKQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhbGxiYWNrcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tpXShub2RlKTsKICAgICAgICB9CgogICAgICAgIC8vIEFsc28gZXJhc2UgdGhlIERPTSBkYXRhCiAgICAgICAga28udXRpbHMuZG9tRGF0YS5jbGVhcihub2RlKTsKCiAgICAgICAgLy8gU3BlY2lhbCBzdXBwb3J0IGZvciBqUXVlcnkgaGVyZSBiZWNhdXNlIGl0J3Mgc28gY29tbW9ubHkgdXNlZC4KICAgICAgICAvLyBNYW55IGpRdWVyeSBwbHVnaW5zIChpbmNsdWRpbmcganF1ZXJ5LnRtcGwpIHN0b3JlIGRhdGEgdXNpbmcgalF1ZXJ5J3MgZXF1aXZhbGVudCBvZiBkb21EYXRhCiAgICAgICAgLy8gc28gbm90aWZ5IGl0IHRvIHRlYXIgZG93biBhbnkgcmVzb3VyY2VzIGFzc29jaWF0ZWQgd2l0aCB0aGUgbm9kZSAmIGRlc2NlbmRhbnRzIGhlcmUuCiAgICAgICAgaWYgKCh0eXBlb2YgalF1ZXJ5ID09ICJmdW5jdGlvbiIpICYmICh0eXBlb2YgalF1ZXJ5WydjbGVhbkRhdGEnXSA9PSAiZnVuY3Rpb24iKSkKICAgICAgICAgICAgalF1ZXJ5WydjbGVhbkRhdGEnXShbbm9kZV0pOwoKICAgICAgICAvLyBBbHNvIGNsZWFyIGFueSBpbW1lZGlhdGUtY2hpbGQgY29tbWVudCBub2RlcywgYXMgdGhlc2Ugd291bGRuJ3QgaGF2ZSBiZWVuIGZvdW5kIGJ5CiAgICAgICAgLy8gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpIGluIGNsZWFuTm9kZSgpIChjb21tZW50IG5vZGVzIGFyZW4ndCBlbGVtZW50cykKICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKQogICAgICAgICAgICBjbGVhbkltbWVkaWF0ZUNvbW1lbnRUeXBlQ2hpbGRyZW4obm9kZSk7CiAgICB9CgogICAgZnVuY3Rpb24gY2xlYW5JbW1lZGlhdGVDb21tZW50VHlwZUNoaWxkcmVuKG5vZGVXaXRoQ2hpbGRyZW4pIHsKICAgICAgICB2YXIgY2hpbGQsIG5leHRDaGlsZCA9IG5vZGVXaXRoQ2hpbGRyZW4uZmlyc3RDaGlsZDsKICAgICAgICB3aGlsZSAoY2hpbGQgPSBuZXh0Q2hpbGQpIHsKICAgICAgICAgICAgbmV4dENoaWxkID0gY2hpbGQubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIGlmIChjaGlsZC5ub2RlVHlwZSA9PT0gOCkKICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShjaGlsZCk7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgICAgYWRkRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYWxsYmFjayBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICAgICAgZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgdHJ1ZSkucHVzaChjYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGNhbGxiYWNrc0NvbGxlY3Rpb24gPSBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBmYWxzZSk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3NDb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVJlbW92ZUl0ZW0oY2FsbGJhY2tzQ29sbGVjdGlvbiwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc0NvbGxlY3Rpb24ubGVuZ3RoID09IDApCiAgICAgICAgICAgICAgICAgICAgZGVzdHJveUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBjbGVhbk5vZGUgOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIC8vIEZpcnN0IGNsZWFuIHRoaXMgbm9kZSwgd2hlcmUgYXBwbGljYWJsZQogICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzW25vZGUubm9kZVR5cGVdKSB7CiAgICAgICAgICAgICAgICBjbGVhblNpbmdsZU5vZGUobm9kZSk7CgogICAgICAgICAgICAgICAgLy8gLi4uIHRoZW4gaXRzIGRlc2NlbmRhbnRzLCB3aGVyZSBhcHBsaWNhYmxlCiAgICAgICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIGRlc2NlbmRhbnRzIGxpc3QgaW4gY2FzZSBpdCBjaGFuZ2VzIGR1cmluZyBpdGVyYXRpb24KICAgICAgICAgICAgICAgICAgICB2YXIgZGVzY2VuZGFudHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoZGVzY2VuZGFudHMsIG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSk7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBkZXNjZW5kYW50cy5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShkZXNjZW5kYW50c1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlTm9kZSA6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAga28uY2xlYW5Ob2RlKG5vZGUpOwogICAgICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlKQogICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICAgIH0KICAgIH0KfSkoKTsKa28uY2xlYW5Ob2RlID0ga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmNsZWFuTm9kZTsgLy8gU2hvcnRoYW5kIG5hbWUgZm9yIGNvbnZlbmllbmNlCmtvLnJlbW92ZU5vZGUgPSBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlTm9kZTsgLy8gU2hvcnRoYW5kIG5hbWUgZm9yIGNvbnZlbmllbmNlCmtvLmV4cG9ydFN5bWJvbCgnY2xlYW5Ob2RlJywga28uY2xlYW5Ob2RlKTsKa28uZXhwb3J0U3ltYm9sKCdyZW1vdmVOb2RlJywga28ucmVtb3ZlTm9kZSk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tTm9kZURpc3Bvc2FsJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tTm9kZURpc3Bvc2FsLnJlbW92ZURpc3Bvc2VDYWxsYmFjaycsIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5yZW1vdmVEaXNwb3NlQ2FsbGJhY2spOwooZnVuY3Rpb24gKCkgewogICAgdmFyIGxlYWRpbmdDb21tZW50UmVnZXggPSAvXihccyopPCEtLSguKj8pLS0+LzsKCiAgICBmdW5jdGlvbiBzaW1wbGVIdG1sUGFyc2UoaHRtbCkgewogICAgICAgIC8vIEJhc2VkIG9uIGpRdWVyeSdzICJjbGVhbiIgZnVuY3Rpb24sIGJ1dCBvbmx5IGFjY291bnRpbmcgZm9yIHRhYmxlLXJlbGF0ZWQgZWxlbWVudHMuCiAgICAgICAgLy8gSWYgeW91IGhhdmUgcmVmZXJlbmNlZCBqUXVlcnksIHRoaXMgd29uJ3QgYmUgdXNlZCBhbnl3YXkgLSBLTyB3aWxsIHVzZSBqUXVlcnkncyAiY2xlYW4iIGZ1bmN0aW9uIGRpcmVjdGx5CgogICAgICAgIC8vIE5vdGUgdGhhdCB0aGVyZSdzIHN0aWxsIGFuIGlzc3VlIGluIElFIDwgOSB3aGVyZWJ5IGl0IHdpbGwgZGlzY2FyZCBjb21tZW50IG5vZGVzIHRoYXQgYXJlIHRoZSBmaXJzdCBjaGlsZCBvZgogICAgICAgIC8vIGEgZGVzY2VuZGFudCBub2RlLiBGb3IgZXhhbXBsZTogIjxkaXY+PCEtLSBteWNvbW1lbnQgLS0+YWJjPC9kaXY+IiB3aWxsIGdldCBwYXJzZWQgYXMgIjxkaXY+YWJjPC9kaXY+IgogICAgICAgIC8vIFRoaXMgd29uJ3QgYWZmZWN0IGFueW9uZSB3aG8gaGFzIHJlZmVyZW5jZWQgalF1ZXJ5LCBhbmQgdGhlcmUncyBhbHdheXMgdGhlIHdvcmthcm91bmQgb2YgaW5zZXJ0aW5nIGEgZHVtbXkgbm9kZQogICAgICAgIC8vIChwb3NzaWJseSBhIHRleHQgbm9kZSkgaW4gZnJvbnQgb2YgdGhlIGNvbW1lbnQuIFNvLCBLTyBkb2VzIG5vdCBhdHRlbXB0IHRvIHdvcmthcm91bmQgdGhpcyBJRSBpc3N1ZSBhdXRvbWF0aWNhbGx5IGF0IHByZXNlbnQuCgogICAgICAgIC8vIFRyaW0gd2hpdGVzcGFjZSwgb3RoZXJ3aXNlIGluZGV4T2Ygd29uJ3Qgd29yayBhcyBleHBlY3RlZAogICAgICAgIHZhciB0YWdzID0ga28udXRpbHMuc3RyaW5nVHJpbShodG1sKS50b0xvd2VyQ2FzZSgpLCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCiAgICAgICAgLy8gRmluZHMgdGhlIGZpcnN0IG1hdGNoIGZyb20gdGhlIGxlZnQgY29sdW1uLCBhbmQgcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyAid3JhcCIgZGF0YSBmcm9tIHRoZSByaWdodCBjb2x1bW4KICAgICAgICB2YXIgd3JhcCA9IHRhZ3MubWF0Y2goL148KHRoZWFkfHRib2R5fHRmb290KS8pICAgICAgICAgICAgICAmJiBbMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iXSB8fAogICAgICAgICAgICAgICAgICAgIXRhZ3MuaW5kZXhPZigiPHRyIikgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIFsyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiJdIHx8CiAgICAgICAgICAgICAgICAgICAoIXRhZ3MuaW5kZXhPZigiPHRkIikgfHwgIXRhZ3MuaW5kZXhPZigiPHRoIikpICAgJiYgWzMsICI8dGFibGU+PHRib2R5Pjx0cj4iLCAiPC90cj48L3Rib2R5PjwvdGFibGU+Il0gfHwKICAgICAgICAgICAgICAgICAgIC8qIGFueXRoaW5nIGVsc2UgKi8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbMCwgIiIsICIiXTsKCiAgICAgICAgLy8gR28gdG8gaHRtbCBhbmQgYmFjaywgdGhlbiBwZWVsIG9mZiBleHRyYSB3cmFwcGVycwogICAgICAgIC8vIE5vdGUgdGhhdCB3ZSBhbHdheXMgcHJlZml4IHdpdGggc29tZSBkdW1teSB0ZXh0LCBiZWNhdXNlIG90aGVyd2lzZSwgSUU8OSB3aWxsIHN0cmlwIG91dCBsZWFkaW5nIGNvbW1lbnQgbm9kZXMgaW4gZGVzY2VuZGFudHMuIFRvdGFsIG1hZG5lc3MuCiAgICAgICAgdmFyIG1hcmt1cCA9ICJpZ25vcmVkPGRpdj4iICsgd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdICsgIjwvZGl2PiI7CiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3dbJ2lubmVyU2hpdiddID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgZGl2LmFwcGVuZENoaWxkKHdpbmRvd1snaW5uZXJTaGl2J10obWFya3VwKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9IG1hcmt1cDsKICAgICAgICB9CgogICAgICAgIC8vIE1vdmUgdG8gdGhlIHJpZ2h0IGRlcHRoCiAgICAgICAgd2hpbGUgKHdyYXBbMF0tLSkKICAgICAgICAgICAgZGl2ID0gZGl2Lmxhc3RDaGlsZDsKCiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLm1ha2VBcnJheShkaXYubGFzdENoaWxkLmNoaWxkTm9kZXMpOwogICAgfQoKICAgIGZ1bmN0aW9uIGpRdWVyeUh0bWxQYXJzZShodG1sKSB7CiAgICAgICAgdmFyIGVsZW1zID0galF1ZXJ5WydjbGVhbiddKFtodG1sXSk7CgogICAgICAgIC8vIEFzIG9mIGpRdWVyeSAxLjcuMSwgalF1ZXJ5IHBhcnNlcyB0aGUgSFRNTCBieSBhcHBlbmRpbmcgaXQgdG8gc29tZSBkdW1teSBwYXJlbnQgbm9kZXMgaGVsZCBpbiBhbiBpbi1tZW1vcnkgZG9jdW1lbnQgZnJhZ21lbnQuCiAgICAgICAgLy8gVW5mb3J0dW5hdGVseSwgaXQgbmV2ZXIgY2xlYXJzIHRoZSBkdW1teSBwYXJlbnQgbm9kZXMgZnJvbSB0aGUgZG9jdW1lbnQgZnJhZ21lbnQsIHNvIGl0IGxlYWtzIG1lbW9yeSBvdmVyIHRpbWUuCiAgICAgICAgLy8gRml4IHRoaXMgYnkgZmluZGluZyB0aGUgdG9wLW1vc3QgZHVtbXkgcGFyZW50IGVsZW1lbnQsIGFuZCBkZXRhY2hpbmcgaXQgZnJvbSBpdHMgb3duZXIgZnJhZ21lbnQuCiAgICAgICAgaWYgKGVsZW1zICYmIGVsZW1zWzBdKSB7CiAgICAgICAgICAgIC8vIEZpbmQgdGhlIHRvcC1tb3N0IHBhcmVudCBlbGVtZW50IHRoYXQncyBhIGRpcmVjdCBjaGlsZCBvZiBhIGRvY3VtZW50IGZyYWdtZW50CiAgICAgICAgICAgIHZhciBlbGVtID0gZWxlbXNbMF07CiAgICAgICAgICAgIHdoaWxlIChlbGVtLnBhcmVudE5vZGUgJiYgZWxlbS5wYXJlbnROb2RlLm5vZGVUeXBlICE9PSAxMSAvKiBpLmUuLCBEb2N1bWVudEZyYWdtZW50ICovKQogICAgICAgICAgICAgICAgZWxlbSA9IGVsZW0ucGFyZW50Tm9kZTsKICAgICAgICAgICAgLy8gLi4uIHRoZW4gZGV0YWNoIGl0CiAgICAgICAgICAgIGlmIChlbGVtLnBhcmVudE5vZGUpCiAgICAgICAgICAgICAgICBlbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZWxlbXM7CiAgICB9CgogICAga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQgPSBmdW5jdGlvbihodG1sKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBqUXVlcnkgIT0gJ3VuZGVmaW5lZCcgPyBqUXVlcnlIdG1sUGFyc2UoaHRtbCkgICAvLyBBcyBiZWxvdywgYmVuZWZpdCBmcm9tIGpRdWVyeSdzIG9wdGltaXNhdGlvbnMgd2hlcmUgcG9zc2libGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHNpbXBsZUh0bWxQYXJzZShodG1sKTsgIC8vIC4uLiBvdGhlcndpc2UsIHRoaXMgc2ltcGxlIGxvZ2ljIHdpbGwgZG8gaW4gbW9zdCBjb21tb24gY2FzZXMuCiAgICB9OwoKICAgIGtvLnV0aWxzLnNldEh0bWwgPSBmdW5jdGlvbihub2RlLCBodG1sKSB7CiAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKG5vZGUpOwoKICAgICAgICAvLyBUaGVyZSdzIG5vIGxlZ2l0aW1hdGUgcmVhc29uIHRvIGRpc3BsYXkgYSBzdHJpbmdpZmllZCBvYnNlcnZhYmxlIHdpdGhvdXQgdW53cmFwcGluZyBpdCwgc28gd2UnbGwgdW53cmFwIGl0CiAgICAgICAgaHRtbCA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoaHRtbCk7CgogICAgICAgIGlmICgoaHRtbCAhPT0gbnVsbCkgJiYgKGh0bWwgIT09IHVuZGVmaW5lZCkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBodG1sICE9ICdzdHJpbmcnKQogICAgICAgICAgICAgICAgaHRtbCA9IGh0bWwudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIC8vIGpRdWVyeSBjb250YWlucyBhIGxvdCBvZiBzb3BoaXN0aWNhdGVkIGNvZGUgdG8gcGFyc2UgYXJiaXRyYXJ5IEhUTUwgZnJhZ21lbnRzLAogICAgICAgICAgICAvLyBmb3IgZXhhbXBsZSA8dHI+IGVsZW1lbnRzIHdoaWNoIGFyZSBub3Qgbm9ybWFsbHkgYWxsb3dlZCB0byBleGlzdCBvbiB0aGVpciBvd24uCiAgICAgICAgICAgIC8vIElmIHlvdSd2ZSByZWZlcmVuY2VkIGpRdWVyeSB3ZSdsbCB1c2UgdGhhdCByYXRoZXIgdGhhbiBkdXBsaWNhdGluZyBpdHMgY29kZS4KICAgICAgICAgICAgaWYgKHR5cGVvZiBqUXVlcnkgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIGpRdWVyeShub2RlKVsnaHRtbCddKGh0bWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gLi4uIG90aGVyd2lzZSwgdXNlIEtPJ3Mgb3duIHBhcnNpbmcgbG9naWMuCiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkTm9kZXMgPSBrby51dGlscy5wYXJzZUh0bWxGcmFnbWVudChodG1sKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyc2VkTm9kZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChwYXJzZWROb2Rlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wYXJzZUh0bWxGcmFnbWVudCcsIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXRIdG1sJywga28udXRpbHMuc2V0SHRtbCk7Cgprby5tZW1vaXphdGlvbiA9IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgbWVtb3MgPSB7fTsKCiAgICBmdW5jdGlvbiByYW5kb21NYXg4SGV4Q2hhcnMoKSB7CiAgICAgICAgcmV0dXJuICgoKDEgKyBNYXRoLnJhbmRvbSgpKSAqIDB4MTAwMDAwMDAwKSB8IDApLnRvU3RyaW5nKDE2KS5zdWJzdHJpbmcoMSk7CiAgICB9CiAgICBmdW5jdGlvbiBnZW5lcmF0ZVJhbmRvbUlkKCkgewogICAgICAgIHJldHVybiByYW5kb21NYXg4SGV4Q2hhcnMoKSArIHJhbmRvbU1heDhIZXhDaGFycygpOwogICAgfQogICAgZnVuY3Rpb24gZmluZE1lbW9Ob2Rlcyhyb290Tm9kZSwgYXBwZW5kVG9BcnJheSkgewogICAgICAgIGlmICghcm9vdE5vZGUpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBpZiAocm9vdE5vZGUubm9kZVR5cGUgPT0gOCkgewogICAgICAgICAgICB2YXIgbWVtb0lkID0ga28ubWVtb2l6YXRpb24ucGFyc2VNZW1vVGV4dChyb290Tm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICBpZiAobWVtb0lkICE9IG51bGwpCiAgICAgICAgICAgICAgICBhcHBlbmRUb0FycmF5LnB1c2goeyBkb21Ob2RlOiByb290Tm9kZSwgbWVtb0lkOiBtZW1vSWQgfSk7CiAgICAgICAgfSBlbHNlIGlmIChyb290Tm9kZS5ub2RlVHlwZSA9PSAxKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZE5vZGVzID0gcm9vdE5vZGUuY2hpbGROb2RlcywgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgZmluZE1lbW9Ob2RlcyhjaGlsZE5vZGVzW2ldLCBhcHBlbmRUb0FycmF5KTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBtZW1vaXplOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgY2FuIG9ubHkgcGFzcyBhIGZ1bmN0aW9uIHRvIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoKSIpOwogICAgICAgICAgICB2YXIgbWVtb0lkID0gZ2VuZXJhdGVSYW5kb21JZCgpOwogICAgICAgICAgICBtZW1vc1ttZW1vSWRdID0gY2FsbGJhY2s7CiAgICAgICAgICAgIHJldHVybiAiPCEtLVtrb19tZW1vOiIgKyBtZW1vSWQgKyAiXS0tPiI7CiAgICAgICAgfSwKCiAgICAgICAgdW5tZW1vaXplOiBmdW5jdGlvbiAobWVtb0lkLCBjYWxsYmFja1BhcmFtcykgewogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBtZW1vc1ttZW1vSWRdOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ291bGRuJ3QgZmluZCBhbnkgbWVtbyB3aXRoIElEICIgKyBtZW1vSWQgKyAiLiBQZXJoYXBzIGl0J3MgYWxyZWFkeSBiZWVuIHVubWVtb2l6ZWQuIik7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShudWxsLCBjYWxsYmFja1BhcmFtcyB8fCBbXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5hbGx5IHsgZGVsZXRlIG1lbW9zW21lbW9JZF07IH0KICAgICAgICB9LAoKICAgICAgICB1bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHM6IGZ1bmN0aW9uIChkb21Ob2RlLCBleHRyYUNhbGxiYWNrUGFyYW1zQXJyYXkpIHsKICAgICAgICAgICAgdmFyIG1lbW9zID0gW107CiAgICAgICAgICAgIGZpbmRNZW1vTm9kZXMoZG9tTm9kZSwgbWVtb3MpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG1lbW9zLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBtZW1vc1tpXS5kb21Ob2RlOwogICAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkUGFyYW1zID0gW25vZGVdOwogICAgICAgICAgICAgICAgaWYgKGV4dHJhQ2FsbGJhY2tQYXJhbXNBcnJheSkKICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoY29tYmluZWRQYXJhbXMsIGV4dHJhQ2FsbGJhY2tQYXJhbXNBcnJheSk7CiAgICAgICAgICAgICAgICBrby5tZW1vaXphdGlvbi51bm1lbW9pemUobWVtb3NbaV0ubWVtb0lkLCBjb21iaW5lZFBhcmFtcyk7CiAgICAgICAgICAgICAgICBub2RlLm5vZGVWYWx1ZSA9ICIiOyAvLyBOZXV0ZXIgdGhpcyBub2RlIHNvIHdlIGRvbid0IHRyeSB0byB1bm1lbW9pemUgaXQgYWdhaW4KICAgICAgICAgICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpCiAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOyAvLyBJZiBwb3NzaWJsZSwgZXJhc2UgaXQgdG90YWxseSAobm90IGFsd2F5cyBwb3NzaWJsZSAtIHNvbWVvbmUgZWxzZSBtaWdodCBqdXN0IGhvbGQgYSByZWZlcmVuY2UgdG8gaXQgdGhlbiBjYWxsIHVubWVtb2l6ZURvbU5vZGVBbmREZXNjZW5kYW50cyBhZ2FpbikKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHBhcnNlTWVtb1RleHQ6IGZ1bmN0aW9uIChtZW1vVGV4dCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBtZW1vVGV4dC5tYXRjaCgvXlxba29fbWVtb1w6KC4qPylcXSQvKTsKICAgICAgICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBudWxsOwogICAgICAgIH0KICAgIH07Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uJywga28ubWVtb2l6YXRpb24pOwprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLm1lbW9pemUnLCBrby5tZW1vaXphdGlvbi5tZW1vaXplKTsKa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi51bm1lbW9pemUnLCBrby5tZW1vaXphdGlvbi51bm1lbW9pemUpOwprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLnBhcnNlTWVtb1RleHQnLCBrby5tZW1vaXphdGlvbi5wYXJzZU1lbW9UZXh0KTsKa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMnLCBrby5tZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMpOwprby5leHRlbmRlcnMgPSB7CiAgICAndGhyb3R0bGUnOiBmdW5jdGlvbih0YXJnZXQsIHRpbWVvdXQpIHsKICAgICAgICAvLyBUaHJvdHRsaW5nIG1lYW5zIHR3byB0aGluZ3M6CgogICAgICAgIC8vICgxKSBGb3IgZGVwZW5kZW50IG9ic2VydmFibGVzLCB3ZSB0aHJvdHRsZSAqZXZhbHVhdGlvbnMqIHNvIHRoYXQsIG5vIG1hdHRlciBob3cgZmFzdCBpdHMgZGVwZW5kZW5jaWVzCiAgICAgICAgLy8gICAgIG5vdGlmeSB1cGRhdGVzLCB0aGUgdGFyZ2V0IGRvZXNuJ3QgcmUtZXZhbHVhdGUgKGFuZCBoZW5jZSBkb2Vzbid0IG5vdGlmeSkgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKICAgICAgICB0YXJnZXRbJ3Rocm90dGxlRXZhbHVhdGlvbiddID0gdGltZW91dDsKCiAgICAgICAgLy8gKDIpIEZvciB3cml0YWJsZSB0YXJnZXRzIChvYnNlcnZhYmxlcywgb3Igd3JpdGFibGUgZGVwZW5kZW50IG9ic2VydmFibGVzKSwgd2UgdGhyb3R0bGUgKndyaXRlcyoKICAgICAgICAvLyAgICAgc28gdGhlIHRhcmdldCBjYW5ub3QgY2hhbmdlIHZhbHVlIHN5bmNocm9ub3VzbHkgb3IgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKICAgICAgICB2YXIgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwogICAgICAgIHJldHVybiBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKHsKICAgICAgICAgICAgJ3JlYWQnOiB0YXJnZXQsCiAgICAgICAgICAgICd3cml0ZSc6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQod3JpdGVUaW1lb3V0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKCiAgICAnbm90aWZ5JzogZnVuY3Rpb24odGFyZ2V0LCBub3RpZnlXaGVuKSB7CiAgICAgICAgdGFyZ2V0WyJlcXVhbGl0eUNvbXBhcmVyIl0gPSBub3RpZnlXaGVuID09ICJhbHdheXMiCiAgICAgICAgICAgID8gZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZSB9IC8vIFRyZWF0IGFsbCB2YWx1ZXMgYXMgbm90IGVxdWFsCiAgICAgICAgICAgIDoga28ub2JzZXJ2YWJsZVsiZm4iXVsiZXF1YWxpdHlDb21wYXJlciJdOwogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9Cn07CgpmdW5jdGlvbiBhcHBseUV4dGVuZGVycyhyZXF1ZXN0ZWRFeHRlbmRlcnMpIHsKICAgIHZhciB0YXJnZXQgPSB0aGlzOwogICAgaWYgKHJlcXVlc3RlZEV4dGVuZGVycykgewogICAgICAgIGZvciAodmFyIGtleSBpbiByZXF1ZXN0ZWRFeHRlbmRlcnMpIHsKICAgICAgICAgICAgdmFyIGV4dGVuZGVySGFuZGxlciA9IGtvLmV4dGVuZGVyc1trZXldOwogICAgICAgICAgICBpZiAodHlwZW9mIGV4dGVuZGVySGFuZGxlciA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSBleHRlbmRlckhhbmRsZXIodGFyZ2V0LCByZXF1ZXN0ZWRFeHRlbmRlcnNba2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdGFyZ2V0Owp9Cgprby5leHBvcnRTeW1ib2woJ2V4dGVuZGVycycsIGtvLmV4dGVuZGVycyk7Cgprby5zdWJzY3JpcHRpb24gPSBmdW5jdGlvbiAodGFyZ2V0LCBjYWxsYmFjaywgZGlzcG9zZUNhbGxiYWNrKSB7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgIHRoaXMuZGlzcG9zZUNhbGxiYWNrID0gZGlzcG9zZUNhbGxiYWNrOwogICAga28uZXhwb3J0UHJvcGVydHkodGhpcywgJ2Rpc3Bvc2UnLCB0aGlzLmRpc3Bvc2UpOwp9Owprby5zdWJzY3JpcHRpb24ucHJvdG90eXBlLmRpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLmlzRGlzcG9zZWQgPSB0cnVlOwogICAgdGhpcy5kaXNwb3NlQ2FsbGJhY2soKTsKfTsKCmtvLnN1YnNjcmliYWJsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSB7fTsKCiAgICBrby51dGlscy5leHRlbmQodGhpcywga28uc3Vic2NyaWJhYmxlWydmbiddKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KHRoaXMsICdzdWJzY3JpYmUnLCB0aGlzLnN1YnNjcmliZSk7CiAgICBrby5leHBvcnRQcm9wZXJ0eSh0aGlzLCAnZXh0ZW5kJywgdGhpcy5leHRlbmQpOwogICAga28uZXhwb3J0UHJvcGVydHkodGhpcywgJ2dldFN1YnNjcmlwdGlvbnNDb3VudCcsIHRoaXMuZ2V0U3Vic2NyaXB0aW9uc0NvdW50KTsKfQoKdmFyIGRlZmF1bHRFdmVudCA9ICJjaGFuZ2UiOwoKa28uc3Vic2NyaWJhYmxlWydmbiddID0gewogICAgc3Vic2NyaWJlOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNhbGxiYWNrVGFyZ2V0LCBldmVudCkgewogICAgICAgIGV2ZW50ID0gZXZlbnQgfHwgZGVmYXVsdEV2ZW50OwogICAgICAgIHZhciBib3VuZENhbGxiYWNrID0gY2FsbGJhY2tUYXJnZXQgPyBjYWxsYmFjay5iaW5kKGNhbGxiYWNrVGFyZ2V0KSA6IGNhbGxiYWNrOwoKICAgICAgICB2YXIgc3Vic2NyaXB0aW9uID0gbmV3IGtvLnN1YnNjcmlwdGlvbih0aGlzLCBib3VuZENhbGxiYWNrLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbSh0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XSwgc3Vic2NyaXB0aW9uKTsKICAgICAgICB9LmJpbmQodGhpcykpOwoKICAgICAgICBpZiAoIXRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdKQogICAgICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XSA9IFtdOwogICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLnB1c2goc3Vic2NyaXB0aW9uKTsKICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9uOwogICAgfSwKCiAgICAibm90aWZ5U3Vic2NyaWJlcnMiOiBmdW5jdGlvbiAodmFsdWVUb05vdGlmeSwgZXZlbnQpIHsKICAgICAgICBldmVudCA9IGV2ZW50IHx8IGRlZmF1bHRFdmVudDsKICAgICAgICBpZiAodGhpcy5fc3Vic2NyaXB0aW9uc1tldmVudF0pIHsKICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2godGhpcy5fc3Vic2NyaXB0aW9uc1tldmVudF0uc2xpY2UoMCksIGZ1bmN0aW9uIChzdWJzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAvLyBJbiBjYXNlIGEgc3Vic2NyaXB0aW9uIHdhcyBkaXNwb3NlZCBkdXJpbmcgdGhlIGFycmF5Rm9yRWFjaCBjeWNsZSwgY2hlY2sKICAgICAgICAgICAgICAgICAgICAvLyBmb3IgaXNEaXNwb3NlZCBvbiBlYWNoIHN1YnNjcmlwdGlvbiBiZWZvcmUgaW52b2tpbmcgaXRzIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbiAmJiAoc3Vic2NyaXB0aW9uLmlzRGlzcG9zZWQgIT09IHRydWUpKQogICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb24uY2FsbGJhY2sodmFsdWVUb05vdGlmeSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICBnZXRTdWJzY3JpcHRpb25zQ291bnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdG90YWwgPSAwOwogICAgICAgIGZvciAodmFyIGV2ZW50TmFtZSBpbiB0aGlzLl9zdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9zdWJzY3JpcHRpb25zLmhhc093blByb3BlcnR5KGV2ZW50TmFtZSkpCiAgICAgICAgICAgICAgICB0b3RhbCArPSB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50TmFtZV0ubGVuZ3RoOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG90YWw7CiAgICB9LAoKICAgIGV4dGVuZDogYXBwbHlFeHRlbmRlcnMKfTsKCgprby5pc1N1YnNjcmliYWJsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkgewogICAgcmV0dXJuIHR5cGVvZiBpbnN0YW5jZS5zdWJzY3JpYmUgPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2VbIm5vdGlmeVN1YnNjcmliZXJzIl0gPT0gImZ1bmN0aW9uIjsKfTsKCmtvLmV4cG9ydFN5bWJvbCgnc3Vic2NyaWJhYmxlJywga28uc3Vic2NyaWJhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCdpc1N1YnNjcmliYWJsZScsIGtvLmlzU3Vic2NyaWJhYmxlKTsKCmtvLmRlcGVuZGVuY3lEZXRlY3Rpb24gPSAoZnVuY3Rpb24gKCkgewogICAgdmFyIF9mcmFtZXMgPSBbXTsKCiAgICByZXR1cm4gewogICAgICAgIGJlZ2luOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgX2ZyYW1lcy5wdXNoKHsgY2FsbGJhY2s6IGNhbGxiYWNrLCBkaXN0aW5jdERlcGVuZGVuY2llczpbXSB9KTsKICAgICAgICB9LAoKICAgICAgICBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgX2ZyYW1lcy5wb3AoKTsKICAgICAgICB9LAoKICAgICAgICByZWdpc3RlckRlcGVuZGVuY3k6IGZ1bmN0aW9uIChzdWJzY3JpYmFibGUpIHsKICAgICAgICAgICAgaWYgKCFrby5pc1N1YnNjcmliYWJsZShzdWJzY3JpYmFibGUpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPbmx5IHN1YnNjcmliYWJsZSB0aGluZ3MgY2FuIGFjdCBhcyBkZXBlbmRlbmNpZXMiKTsKICAgICAgICAgICAgaWYgKF9mcmFtZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIHRvcEZyYW1lID0gX2ZyYW1lc1tfZnJhbWVzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgaWYgKCF0b3BGcmFtZSB8fCBrby51dGlscy5hcnJheUluZGV4T2YodG9wRnJhbWUuZGlzdGluY3REZXBlbmRlbmNpZXMsIHN1YnNjcmliYWJsZSkgPj0gMCkKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB0b3BGcmFtZS5kaXN0aW5jdERlcGVuZGVuY2llcy5wdXNoKHN1YnNjcmliYWJsZSk7CiAgICAgICAgICAgICAgICB0b3BGcmFtZS5jYWxsYmFjayhzdWJzY3JpYmFibGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgaWdub3JlOiBmdW5jdGlvbihjYWxsYmFjaywgY2FsbGJhY2tUYXJnZXQsIGNhbGxiYWNrQXJncykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgX2ZyYW1lcy5wdXNoKG51bGwpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KGNhbGxiYWNrVGFyZ2V0LCBjYWxsYmFja0FyZ3MgfHwgW10pOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgX2ZyYW1lcy5wb3AoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7CnZhciBwcmltaXRpdmVUeXBlcyA9IHsgJ3VuZGVmaW5lZCc6dHJ1ZSwgJ2Jvb2xlYW4nOnRydWUsICdudW1iZXInOnRydWUsICdzdHJpbmcnOnRydWUgfTsKCmtvLm9ic2VydmFibGUgPSBmdW5jdGlvbiAoaW5pdGlhbFZhbHVlKSB7CiAgICB2YXIgX2xhdGVzdFZhbHVlID0gaW5pdGlhbFZhbHVlOwoKICAgIGZ1bmN0aW9uIG9ic2VydmFibGUoKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIC8vIFdyaXRlCgogICAgICAgICAgICAvLyBJZ25vcmUgd3JpdGVzIGlmIHRoZSB2YWx1ZSBoYXNuJ3QgY2hhbmdlZAogICAgICAgICAgICBpZiAoKCFvYnNlcnZhYmxlWydlcXVhbGl0eUNvbXBhcmVyJ10pIHx8ICFvYnNlcnZhYmxlWydlcXVhbGl0eUNvbXBhcmVyJ10oX2xhdGVzdFZhbHVlLCBhcmd1bWVudHNbMF0pKSB7CiAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSgpOwogICAgICAgICAgICAgICAgX2xhdGVzdFZhbHVlID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICAgICAgaWYgKERFQlVHKSBvYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKICAgICAgICAgICAgICAgIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7IC8vIFBlcm1pdHMgY2hhaW5lZCBhc3NpZ25tZW50cwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgLy8gUmVhZAogICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLnJlZ2lzdGVyRGVwZW5kZW5jeShvYnNlcnZhYmxlKTsgLy8gVGhlIGNhbGxlciBvbmx5IG5lZWRzIHRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgaWYgdGhleSBkaWQgYSAicmVhZCIgb3BlcmF0aW9uCiAgICAgICAgICAgIHJldHVybiBfbGF0ZXN0VmFsdWU7CiAgICAgICAgfQogICAgfQogICAgaWYgKERFQlVHKSBvYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKICAgIGtvLnN1YnNjcmliYWJsZS5jYWxsKG9ic2VydmFibGUpOwogICAgb2JzZXJ2YWJsZS5wZWVrID0gZnVuY3Rpb24oKSB7IHJldHVybiBfbGF0ZXN0VmFsdWUgfTsKICAgIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkID0gZnVuY3Rpb24gKCkgeyBvYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSk7IH0KICAgIG9ic2VydmFibGUudmFsdWVXaWxsTXV0YXRlID0gZnVuY3Rpb24gKCkgeyBvYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOyB9CiAgICBrby51dGlscy5leHRlbmQob2JzZXJ2YWJsZSwga28ub2JzZXJ2YWJsZVsnZm4nXSk7CgogICAga28uZXhwb3J0UHJvcGVydHkob2JzZXJ2YWJsZSwgJ3BlZWsnLCBvYnNlcnZhYmxlLnBlZWspOwogICAga28uZXhwb3J0UHJvcGVydHkob2JzZXJ2YWJsZSwgInZhbHVlSGFzTXV0YXRlZCIsIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KG9ic2VydmFibGUsICJ2YWx1ZVdpbGxNdXRhdGUiLCBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSk7CgogICAgcmV0dXJuIG9ic2VydmFibGU7Cn0KCmtvLm9ic2VydmFibGVbJ2ZuJ10gPSB7CiAgICAiZXF1YWxpdHlDb21wYXJlciI6IGZ1bmN0aW9uIHZhbHVlc0FyZVByaW1pdGl2ZUFuZEVxdWFsKGEsIGIpIHsKICAgICAgICB2YXIgb2xkVmFsdWVJc1ByaW1pdGl2ZSA9IChhID09PSBudWxsKSB8fCAodHlwZW9mKGEpIGluIHByaW1pdGl2ZVR5cGVzKTsKICAgICAgICByZXR1cm4gb2xkVmFsdWVJc1ByaW1pdGl2ZSA/IChhID09PSBiKSA6IGZhbHNlOwogICAgfQp9OwoKdmFyIHByb3RvUHJvcGVydHkgPSBrby5vYnNlcnZhYmxlLnByb3RvUHJvcGVydHkgPSAiX19rb19wcm90b19fIjsKa28ub2JzZXJ2YWJsZVsnZm4nXVtwcm90b1Byb3BlcnR5XSA9IGtvLm9ic2VydmFibGU7Cgprby5oYXNQcm90b3R5cGUgPSBmdW5jdGlvbihpbnN0YW5jZSwgcHJvdG90eXBlKSB7CiAgICBpZiAoKGluc3RhbmNlID09PSBudWxsKSB8fCAoaW5zdGFuY2UgPT09IHVuZGVmaW5lZCkgfHwgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSB1bmRlZmluZWQpKSByZXR1cm4gZmFsc2U7CiAgICBpZiAoaW5zdGFuY2VbcHJvdG9Qcm9wZXJ0eV0gPT09IHByb3RvdHlwZSkgcmV0dXJuIHRydWU7CiAgICByZXR1cm4ga28uaGFzUHJvdG90eXBlKGluc3RhbmNlW3Byb3RvUHJvcGVydHldLCBwcm90b3R5cGUpOyAvLyBXYWxrIHRoZSBwcm90b3R5cGUgY2hhaW4KfTsKCmtvLmlzT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkgewogICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28ub2JzZXJ2YWJsZSk7Cn0Ka28uaXNXcml0ZWFibGVPYnNlcnZhYmxlID0gZnVuY3Rpb24gKGluc3RhbmNlKSB7CiAgICAvLyBPYnNlcnZhYmxlCiAgICBpZiAoKHR5cGVvZiBpbnN0YW5jZSA9PSAiZnVuY3Rpb24iKSAmJiBpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0ga28ub2JzZXJ2YWJsZSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIC8vIFdyaXRlYWJsZSBkZXBlbmRlbnQgb2JzZXJ2YWJsZQogICAgaWYgKCh0eXBlb2YgaW5zdGFuY2UgPT0gImZ1bmN0aW9uIikgJiYgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKSAmJiAoaW5zdGFuY2UuaGFzV3JpdGVGdW5jdGlvbikpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAvLyBBbnl0aGluZyBlbHNlCiAgICByZXR1cm4gZmFsc2U7Cn0KCgprby5leHBvcnRTeW1ib2woJ29ic2VydmFibGUnLCBrby5vYnNlcnZhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCdpc09ic2VydmFibGUnLCBrby5pc09ic2VydmFibGUpOwprby5leHBvcnRTeW1ib2woJ2lzV3JpdGVhYmxlT2JzZXJ2YWJsZScsIGtvLmlzV3JpdGVhYmxlT2JzZXJ2YWJsZSk7CmtvLm9ic2VydmFibGVBcnJheSA9IGZ1bmN0aW9uIChpbml0aWFsVmFsdWVzKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgLy8gWmVyby1wYXJhbWV0ZXIgY29uc3RydWN0b3IgaW5pdGlhbGl6ZXMgdG8gZW1wdHkgYXJyYXkKICAgICAgICBpbml0aWFsVmFsdWVzID0gW107CiAgICB9CiAgICBpZiAoKGluaXRpYWxWYWx1ZXMgIT09IG51bGwpICYmIChpbml0aWFsVmFsdWVzICE9PSB1bmRlZmluZWQpICYmICEoJ2xlbmd0aCcgaW4gaW5pdGlhbFZhbHVlcykpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgYXJndW1lbnQgcGFzc2VkIHdoZW4gaW5pdGlhbGl6aW5nIGFuIG9ic2VydmFibGUgYXJyYXkgbXVzdCBiZSBhbiBhcnJheSwgb3IgbnVsbCwgb3IgdW5kZWZpbmVkLiIpOwoKICAgIHZhciByZXN1bHQgPSBrby5vYnNlcnZhYmxlKGluaXRpYWxWYWx1ZXMpOwogICAga28udXRpbHMuZXh0ZW5kKHJlc3VsdCwga28ub2JzZXJ2YWJsZUFycmF5WydmbiddKTsKICAgIHJldHVybiByZXN1bHQ7Cn0KCmtvLm9ic2VydmFibGVBcnJheVsnZm4nXSA9IHsKICAgICdyZW1vdmUnOiBmdW5jdGlvbiAodmFsdWVPclByZWRpY2F0ZSkgewogICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzLnBlZWsoKTsKICAgICAgICB2YXIgcmVtb3ZlZFZhbHVlcyA9IFtdOwogICAgICAgIHZhciBwcmVkaWNhdGUgPSB0eXBlb2YgdmFsdWVPclByZWRpY2F0ZSA9PSAiZnVuY3Rpb24iID8gdmFsdWVPclByZWRpY2F0ZSA6IGZ1bmN0aW9uICh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgPT09IHZhbHVlT3JQcmVkaWNhdGU7IH07CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1bmRlcmx5aW5nQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdW5kZXJseWluZ0FycmF5W2ldOwogICAgICAgICAgICBpZiAocHJlZGljYXRlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgaWYgKHJlbW92ZWRWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlbW92ZWRWYWx1ZXMucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB1bmRlcmx5aW5nQXJyYXkuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChyZW1vdmVkVmFsdWVzLmxlbmd0aCkgewogICAgICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVtb3ZlZFZhbHVlczsKICAgIH0sCgogICAgJ3JlbW92ZUFsbCc6IGZ1bmN0aW9uIChhcnJheU9mVmFsdWVzKSB7CiAgICAgICAgLy8gSWYgeW91IHBhc3NlZCB6ZXJvIGFyZ3MsIHdlIHJlbW92ZSBldmVyeXRoaW5nCiAgICAgICAgaWYgKGFycmF5T2ZWYWx1ZXMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CiAgICAgICAgICAgIHZhciBhbGxWYWx1ZXMgPSB1bmRlcmx5aW5nQXJyYXkuc2xpY2UoMCk7CiAgICAgICAgICAgIHRoaXMudmFsdWVXaWxsTXV0YXRlKCk7CiAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheS5zcGxpY2UoMCwgdW5kZXJseWluZ0FycmF5Lmxlbmd0aCk7CiAgICAgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CiAgICAgICAgICAgIHJldHVybiBhbGxWYWx1ZXM7CiAgICAgICAgfQogICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byByZW1vdmUKICAgICAgICBpZiAoIWFycmF5T2ZWYWx1ZXMpCiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICByZXR1cm4gdGhpc1sncmVtb3ZlJ10oZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBrby51dGlscy5hcnJheUluZGV4T2YoYXJyYXlPZlZhbHVlcywgdmFsdWUpID49IDA7CiAgICAgICAgfSk7CiAgICB9LAoKICAgICdkZXN0cm95JzogZnVuY3Rpb24gKHZhbHVlT3JQcmVkaWNhdGUpIHsKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CiAgICAgICAgdmFyIHByZWRpY2F0ZSA9IHR5cGVvZiB2YWx1ZU9yUHJlZGljYXRlID09ICJmdW5jdGlvbiIgPyB2YWx1ZU9yUHJlZGljYXRlIDogZnVuY3Rpb24gKHZhbHVlKSB7IHJldHVybiB2YWx1ZSA9PT0gdmFsdWVPclByZWRpY2F0ZTsgfTsKICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwogICAgICAgIGZvciAodmFyIGkgPSB1bmRlcmx5aW5nQXJyYXkubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdW5kZXJseWluZ0FycmF5W2ldOwogICAgICAgICAgICBpZiAocHJlZGljYXRlKHZhbHVlKSkKICAgICAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheVtpXVsiX2Rlc3Ryb3kiXSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CiAgICB9LAoKICAgICdkZXN0cm95QWxsJzogZnVuY3Rpb24gKGFycmF5T2ZWYWx1ZXMpIHsKICAgICAgICAvLyBJZiB5b3UgcGFzc2VkIHplcm8gYXJncywgd2UgZGVzdHJveSBldmVyeXRoaW5nCiAgICAgICAgaWYgKGFycmF5T2ZWYWx1ZXMgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbigpIHsgcmV0dXJuIHRydWUgfSk7CgogICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byBkZXN0cm95CiAgICAgICAgaWYgKCFhcnJheU9mVmFsdWVzKQogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZihhcnJheU9mVmFsdWVzLCB2YWx1ZSkgPj0gMDsKICAgICAgICB9KTsKICAgIH0sCgogICAgJ2luZGV4T2YnOiBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzKCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZih1bmRlcmx5aW5nQXJyYXksIGl0ZW0pOwogICAgfSwKCiAgICAncmVwbGFjZSc6IGZ1bmN0aW9uKG9sZEl0ZW0sIG5ld0l0ZW0pIHsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzWydpbmRleE9mJ10ob2xkSXRlbSk7CiAgICAgICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICAgICAgdGhpcy5wZWVrKClbaW5kZXhdID0gbmV3SXRlbTsKICAgICAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKICAgICAgICB9CiAgICB9Cn0KCi8vIFBvcHVsYXRlIGtvLm9ic2VydmFibGVBcnJheS5mbiB3aXRoIHJlYWQvd3JpdGUgZnVuY3Rpb25zIGZyb20gbmF0aXZlIGFycmF5cwovLyBJbXBvcnRhbnQ6IERvIG5vdCBhZGQgYW55IGFkZGl0aW9uYWwgZnVuY3Rpb25zIGhlcmUgdGhhdCBtYXkgcmVhc29uYWJseSBiZSB1c2VkIHRvICpyZWFkKiBkYXRhIGZyb20gdGhlIGFycmF5Ci8vIGJlY2F1c2Ugd2UnbGwgZXZhbCB0aGVtIHdpdGhvdXQgY2F1c2luZyBzdWJzY3JpcHRpb25zLCBzbyBrby5jb21wdXRlZCBvdXRwdXQgY291bGQgZW5kIHVwIGdldHRpbmcgc3RhbGUKa28udXRpbHMuYXJyYXlGb3JFYWNoKFsicG9wIiwgInB1c2giLCAicmV2ZXJzZSIsICJzaGlmdCIsICJzb3J0IiwgInNwbGljZSIsICJ1bnNoaWZ0Il0sIGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CiAgICBrby5vYnNlcnZhYmxlQXJyYXlbJ2ZuJ11bbWV0aG9kTmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gVXNlICJwZWVrIiB0byBhdm9pZCBjcmVhdGluZyBhIHN1YnNjcmlwdGlvbiBpbiBhbnkgY29tcHV0ZWQgdGhhdCB3ZSdyZSBleGVjdXRpbmcgaW4gdGhlIGNvbnRleHQgb2YKICAgICAgICAvLyAoZm9yIGNvbnNpc3RlbmN5IHdpdGggbXV0YXRpbmcgcmVndWxhciBvYnNlcnZhYmxlcykKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CiAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICB2YXIgbWV0aG9kQ2FsbFJlc3VsdCA9IHVuZGVybHlpbmdBcnJheVttZXRob2ROYW1lXS5hcHBseSh1bmRlcmx5aW5nQXJyYXksIGFyZ3VtZW50cyk7CiAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKICAgICAgICByZXR1cm4gbWV0aG9kQ2FsbFJlc3VsdDsKICAgIH07Cn0pOwoKLy8gUG9wdWxhdGUga28ub2JzZXJ2YWJsZUFycmF5LmZuIHdpdGggcmVhZC1vbmx5IGZ1bmN0aW9ucyBmcm9tIG5hdGl2ZSBhcnJheXMKa28udXRpbHMuYXJyYXlGb3JFYWNoKFsic2xpY2UiXSwgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgIGtvLm9ic2VydmFibGVBcnJheVsnZm4nXVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcygpOwogICAgICAgIHJldHVybiB1bmRlcmx5aW5nQXJyYXlbbWV0aG9kTmFtZV0uYXBwbHkodW5kZXJseWluZ0FycmF5LCBhcmd1bWVudHMpOwogICAgfTsKfSk7Cgprby5leHBvcnRTeW1ib2woJ29ic2VydmFibGVBcnJheScsIGtvLm9ic2VydmFibGVBcnJheSk7CmtvLmRlcGVuZGVudE9ic2VydmFibGUgPSBmdW5jdGlvbiAoZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMsIGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0LCBvcHRpb25zKSB7CiAgICB2YXIgX2xhdGVzdFZhbHVlLAogICAgICAgIF9oYXNCZWVuRXZhbHVhdGVkID0gZmFsc2UsCiAgICAgICAgX2lzQmVpbmdFdmFsdWF0ZWQgPSBmYWxzZSwKICAgICAgICByZWFkRnVuY3Rpb24gPSBldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9uczsKCiAgICBpZiAocmVhZEZ1bmN0aW9uICYmIHR5cGVvZiByZWFkRnVuY3Rpb24gPT0gIm9iamVjdCIpIHsKICAgICAgICAvLyBTaW5nbGUtcGFyYW1ldGVyIHN5bnRheCAtIGV2ZXJ5dGhpbmcgaXMgb24gdGhpcyAib3B0aW9ucyIgcGFyYW0KICAgICAgICBvcHRpb25zID0gcmVhZEZ1bmN0aW9uOwogICAgICAgIHJlYWRGdW5jdGlvbiA9IG9wdGlvbnNbInJlYWQiXTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gTXVsdGktcGFyYW1ldGVyIHN5bnRheCAtIGNvbnN0cnVjdCB0aGUgb3B0aW9ucyBhY2NvcmRpbmcgdG8gdGhlIHBhcmFtcyBwYXNzZWQKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICBpZiAoIXJlYWRGdW5jdGlvbikKICAgICAgICAgICAgcmVhZEZ1bmN0aW9uID0gb3B0aW9uc1sicmVhZCJdOwogICAgfQogICAgaWYgKHR5cGVvZiByZWFkRnVuY3Rpb24gIT0gImZ1bmN0aW9uIikKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBhc3MgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBrby5jb21wdXRlZCIpOwoKICAgIGZ1bmN0aW9uIGFkZFN1YnNjcmlwdGlvblRvRGVwZW5kZW5jeShzdWJzY3JpYmFibGUpIHsKICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLnB1c2goc3Vic2NyaWJhYmxlLnN1YnNjcmliZShldmFsdWF0ZVBvc3NpYmx5QXN5bmMpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCkgewogICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uKSB7CiAgICAgICAgICAgIHN1YnNjcmlwdGlvbi5kaXNwb3NlKCk7CiAgICAgICAgfSk7CiAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcyA9IFtdOwogICAgfQoKICAgIGZ1bmN0aW9uIGV2YWx1YXRlUG9zc2libHlBc3luYygpIHsKICAgICAgICB2YXIgdGhyb3R0bGVFdmFsdWF0aW9uVGltZW91dCA9IGRlcGVuZGVudE9ic2VydmFibGVbJ3Rocm90dGxlRXZhbHVhdGlvbiddOwogICAgICAgIGlmICh0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0ICYmIHRocm90dGxlRXZhbHVhdGlvblRpbWVvdXQgPj0gMCkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQoZXZhbHVhdGlvblRpbWVvdXRJbnN0YW5jZSk7CiAgICAgICAgICAgIGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGV2YWx1YXRlSW1tZWRpYXRlLCB0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0KTsKICAgICAgICB9IGVsc2UKICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBldmFsdWF0ZUltbWVkaWF0ZSgpIHsKICAgICAgICBpZiAoX2lzQmVpbmdFdmFsdWF0ZWQpIHsKICAgICAgICAgICAgLy8gSWYgdGhlIGV2YWx1YXRpb24gb2YgYSBrby5jb21wdXRlZCBjYXVzZXMgc2lkZSBlZmZlY3RzLCBpdCdzIHBvc3NpYmxlIHRoYXQgaXQgd2lsbCB0cmlnZ2VyIGl0cyBvd24gcmUtZXZhbHVhdGlvbi4KICAgICAgICAgICAgLy8gVGhpcyBpcyBub3QgZGVzaXJhYmxlIChpdCdzIGhhcmQgZm9yIGEgZGV2ZWxvcGVyIHRvIHJlYWxpc2UgYSBjaGFpbiBvZiBkZXBlbmRlbmNpZXMgbWlnaHQgY2F1c2UgdGhpcywgYW5kIHRoZXkgYWxtb3N0CiAgICAgICAgICAgIC8vIGNlcnRhaW5seSBkaWRuJ3QgaW50ZW5kIGluZmluaXRlIHJlLWV2YWx1YXRpb25zKS4gU28sIGZvciBwcmVkaWN0YWJpbGl0eSwgd2Ugc2ltcGx5IHByZXZlbnQga28uY29tcHV0ZWRzIGZyb20gY2F1c2luZwogICAgICAgICAgICAvLyB0aGVpciBvd24gcmUtZXZhbHVhdGlvbi4gRnVydGhlciBkaXNjdXNzaW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9wdWxsLzM4NwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBEb24ndCBkaXNwb3NlIG9uIGZpcnN0IGV2YWx1YXRpb24sIGJlY2F1c2UgdGhlICJkaXNwb3NlV2hlbiIgY2FsbGJhY2sgbWlnaHQKICAgICAgICAvLyBlLmcuLCBkaXNwb3NlIHdoZW4gdGhlIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnQgaXNuJ3QgaW4gdGhlIGRvYywgYW5kIGl0J3Mgbm90CiAgICAgICAgLy8gZ29pbmcgdG8gYmUgaW4gdGhlIGRvYyB1bnRpbCAqYWZ0ZXIqIHRoZSBmaXJzdCBldmFsdWF0aW9uCiAgICAgICAgaWYgKF9oYXNCZWVuRXZhbHVhdGVkICYmIGRpc3Bvc2VXaGVuKCkpIHsKICAgICAgICAgICAgZGlzcG9zZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBfaXNCZWluZ0V2YWx1YXRlZCA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gSW5pdGlhbGx5LCB3ZSBhc3N1bWUgdGhhdCBub25lIG9mIHRoZSBzdWJzY3JpcHRpb25zIGFyZSBzdGlsbCBiZWluZyB1c2VkIChpLmUuLCBhbGwgYXJlIGNhbmRpZGF0ZXMgZm9yIGRpc3Bvc2FsKS4KICAgICAgICAgICAgLy8gVGhlbiwgZHVyaW5nIGV2YWx1YXRpb24sIHdlIGNyb3NzIG9mZiBhbnkgdGhhdCBhcmUgaW4gZmFjdCBzdGlsbCBiZWluZyB1c2VkLgogICAgICAgICAgICB2YXIgZGlzcG9zYWxDYW5kaWRhdGVzID0ga28udXRpbHMuYXJyYXlNYXAoX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcywgZnVuY3Rpb24oaXRlbSkge3JldHVybiBpdGVtLnRhcmdldDt9KTsKCiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uYmVnaW4oZnVuY3Rpb24oc3Vic2NyaWJhYmxlKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5PbGQ7CiAgICAgICAgICAgICAgICBpZiAoKGluT2xkID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGRpc3Bvc2FsQ2FuZGlkYXRlcywgc3Vic2NyaWJhYmxlKSkgPj0gMCkKICAgICAgICAgICAgICAgICAgICBkaXNwb3NhbENhbmRpZGF0ZXNbaW5PbGRdID0gdW5kZWZpbmVkOyAvLyBEb24ndCB3YW50IHRvIGRpc3Bvc2UgdGhpcyBzdWJzY3JpcHRpb24sIGFzIGl0J3Mgc3RpbGwgYmVpbmcgdXNlZAogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGFkZFN1YnNjcmlwdGlvblRvRGVwZW5kZW5jeShzdWJzY3JpYmFibGUpOyAvLyBCcmFuZCBuZXcgc3Vic2NyaXB0aW9uIC0gYWRkIGl0CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcmVhZEZ1bmN0aW9uLmNhbGwoZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpOwoKICAgICAgICAgICAgLy8gRm9yIGVhY2ggc3Vic2NyaXB0aW9uIG5vIGxvbmdlciBiZWluZyB1c2VkLCByZW1vdmUgaXQgZnJvbSB0aGUgYWN0aXZlIHN1YnNjcmlwdGlvbnMgbGlzdCBhbmQgZGlzcG9zZSBpdAogICAgICAgICAgICBmb3IgKHZhciBpID0gZGlzcG9zYWxDYW5kaWRhdGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBpZiAoZGlzcG9zYWxDYW5kaWRhdGVzW2ldKQogICAgICAgICAgICAgICAgICAgIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMuc3BsaWNlKGksIDEpWzBdLmRpc3Bvc2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfaGFzQmVlbkV2YWx1YXRlZCA9IHRydWU7CgogICAgICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOwogICAgICAgICAgICBfbGF0ZXN0VmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgaWYgKERFQlVHKSBkZXBlbmRlbnRPYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmVuZCgpOwogICAgICAgIH0KCiAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZVsibm90aWZ5U3Vic2NyaWJlcnMiXShfbGF0ZXN0VmFsdWUpOwogICAgICAgIF9pc0JlaW5nRXZhbHVhdGVkID0gZmFsc2U7CiAgICAgICAgaWYgKCFfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLmxlbmd0aCkKICAgICAgICAgICAgZGlzcG9zZSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGRlcGVuZGVudE9ic2VydmFibGUoKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygd3JpdGVGdW5jdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgLy8gV3JpdGluZyBhIHZhbHVlCiAgICAgICAgICAgICAgICB3cml0ZUZ1bmN0aW9uLmFwcGx5KGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0LCBhcmd1bWVudHMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgd3JpdGUgYSB2YWx1ZSB0byBhIGtvLmNvbXB1dGVkIHVubGVzcyB5b3Ugc3BlY2lmeSBhICd3cml0ZScgb3B0aW9uLiBJZiB5b3Ugd2lzaCB0byByZWFkIHRoZSBjdXJyZW50IHZhbHVlLCBkb24ndCBwYXNzIGFueSBwYXJhbWV0ZXJzLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOyAvLyBQZXJtaXRzIGNoYWluZWQgYXNzaWdubWVudHMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBSZWFkaW5nIHRoZSB2YWx1ZQogICAgICAgICAgICBpZiAoIV9oYXNCZWVuRXZhbHVhdGVkKQogICAgICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5yZWdpc3RlckRlcGVuZGVuY3koZGVwZW5kZW50T2JzZXJ2YWJsZSk7CiAgICAgICAgICAgIHJldHVybiBfbGF0ZXN0VmFsdWU7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHBlZWsoKSB7CiAgICAgICAgaWYgKCFfaGFzQmVlbkV2YWx1YXRlZCkKICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKICAgICAgICByZXR1cm4gX2xhdGVzdFZhbHVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzQWN0aXZlKCkgewogICAgICAgIHJldHVybiAhX2hhc0JlZW5FdmFsdWF0ZWQgfHwgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcy5sZW5ndGggPiAwOwogICAgfQoKICAgIC8vIEJ5IGhlcmUsICJvcHRpb25zIiBpcyBhbHdheXMgbm9uLW51bGwKICAgIHZhciB3cml0ZUZ1bmN0aW9uID0gb3B0aW9uc1sid3JpdGUiXSwKICAgICAgICBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQgPSBvcHRpb25zWyJkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQiXSB8fCBvcHRpb25zLmRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCB8fCBudWxsLAogICAgICAgIGRpc3Bvc2VXaGVuID0gb3B0aW9uc1siZGlzcG9zZVdoZW4iXSB8fCBvcHRpb25zLmRpc3Bvc2VXaGVuIHx8IGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH0sCiAgICAgICAgZGlzcG9zZSA9IGRpc3Bvc2VBbGxTdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMsCiAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcyA9IFtdLAogICAgICAgIGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UgPSBudWxsOwoKICAgIGlmICghZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpCiAgICAgICAgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQgPSBvcHRpb25zWyJvd25lciJdOwoKICAgIGRlcGVuZGVudE9ic2VydmFibGUucGVlayA9IHBlZWs7CiAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmdldERlcGVuZGVuY2llc0NvdW50ID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcy5sZW5ndGg7IH07CiAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmhhc1dyaXRlRnVuY3Rpb24gPSB0eXBlb2Ygb3B0aW9uc1sid3JpdGUiXSA9PT0gImZ1bmN0aW9uIjsKICAgIGRlcGVuZGVudE9ic2VydmFibGUuZGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgZGlzcG9zZSgpOyB9OwogICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5pc0FjdGl2ZSA9IGlzQWN0aXZlOwoKICAgIGtvLnN1YnNjcmliYWJsZS5jYWxsKGRlcGVuZGVudE9ic2VydmFibGUpOwogICAga28udXRpbHMuZXh0ZW5kKGRlcGVuZGVudE9ic2VydmFibGUsIGtvLmRlcGVuZGVudE9ic2VydmFibGVbJ2ZuJ10pOwoKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdwZWVrJywgZGVwZW5kZW50T2JzZXJ2YWJsZS5wZWVrKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdkaXNwb3NlJywgZGVwZW5kZW50T2JzZXJ2YWJsZS5kaXNwb3NlKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdpc0FjdGl2ZScsIGRlcGVuZGVudE9ic2VydmFibGUuaXNBY3RpdmUpOwogICAga28uZXhwb3J0UHJvcGVydHkoZGVwZW5kZW50T2JzZXJ2YWJsZSwgJ2dldERlcGVuZGVuY2llc0NvdW50JywgZGVwZW5kZW50T2JzZXJ2YWJsZS5nZXREZXBlbmRlbmNpZXNDb3VudCk7CgogICAgLy8gRXZhbHVhdGUsIHVubGVzcyBkZWZlckV2YWx1YXRpb24gaXMgdHJ1ZQogICAgaWYgKG9wdGlvbnNbJ2RlZmVyRXZhbHVhdGlvbiddICE9PSB0cnVlKQogICAgICAgIGV2YWx1YXRlSW1tZWRpYXRlKCk7CgogICAgLy8gQnVpbGQgImRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCIgYW5kICJkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWRDYWxsYmFjayIgb3B0aW9uIHZhbHVlcy4KICAgIC8vIEJ1dCBza2lwIGlmIGlzQWN0aXZlIGlzIGZhbHNlICh0aGVyZSB3aWxsIG5ldmVyIGJlIGFueSBkZXBlbmRlbmNpZXMgdG8gZGlzcG9zZSkuCiAgICAvLyAoTm90ZTogImRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCIgb3B0aW9uIGJvdGggcHJvYWN0aXZlbHkgZGlzcG9zZXMgYXMgc29vbiBhcyB0aGUgbm9kZSBpcyByZW1vdmVkIHVzaW5nIGtvLnJlbW92ZU5vZGUoKSwKICAgIC8vIHBsdXMgYWRkcyBhICJkaXNwb3NlV2hlbiIgY2FsbGJhY2sgdGhhdCwgb24gZWFjaCBldmFsdWF0aW9uLCBkaXNwb3NlcyBpZiB0aGUgbm9kZSB3YXMgcmVtb3ZlZCBieSBzb21lIG90aGVyIG1lYW5zLikKICAgIGlmIChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQgJiYgaXNBY3RpdmUoKSkgewogICAgICAgIGRpc3Bvc2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLnJlbW92ZURpc3Bvc2VDYWxsYmFjayhkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQsIGFyZ3VtZW50cy5jYWxsZWUpOwogICAgICAgICAgICBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCk7CiAgICAgICAgfTsKICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCwgZGlzcG9zZSk7CiAgICAgICAgdmFyIGV4aXN0aW5nRGlzcG9zZVdoZW5GdW5jdGlvbiA9IGRpc3Bvc2VXaGVuOwogICAgICAgIGRpc3Bvc2VXaGVuID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gIWtvLnV0aWxzLmRvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQpIHx8IGV4aXN0aW5nRGlzcG9zZVdoZW5GdW5jdGlvbigpOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZGVwZW5kZW50T2JzZXJ2YWJsZTsKfTsKCmtvLmlzQ29tcHV0ZWQgPSBmdW5jdGlvbihpbnN0YW5jZSkgewogICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7Cn07Cgp2YXIgcHJvdG9Qcm9wID0ga28ub2JzZXJ2YWJsZS5wcm90b1Byb3BlcnR5OyAvLyA9PSAiX19rb19wcm90b19fIgprby5kZXBlbmRlbnRPYnNlcnZhYmxlW3Byb3RvUHJvcF0gPSBrby5vYnNlcnZhYmxlOwoKa28uZGVwZW5kZW50T2JzZXJ2YWJsZVsnZm4nXSA9IHt9Owprby5kZXBlbmRlbnRPYnNlcnZhYmxlWydmbiddW3Byb3RvUHJvcF0gPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlOwoKa28uZXhwb3J0U3ltYm9sKCdkZXBlbmRlbnRPYnNlcnZhYmxlJywga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7CmtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWQnLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKTsgLy8gTWFrZSAia28uY29tcHV0ZWQiIGFuIGFsaWFzIGZvciAia28uZGVwZW5kZW50T2JzZXJ2YWJsZSIKa28uZXhwb3J0U3ltYm9sKCdpc0NvbXB1dGVkJywga28uaXNDb21wdXRlZCk7CgooZnVuY3Rpb24oKSB7CiAgICB2YXIgbWF4TmVzdGVkT2JzZXJ2YWJsZURlcHRoID0gMTA7IC8vIEVzY2FwZSB0aGUgKHVubGlrZWx5KSBwYXRoYWxvZ2ljYWwgY2FzZSB3aGVyZSBhbiBvYnNlcnZhYmxlJ3MgY3VycmVudCB2YWx1ZSBpcyBpdHNlbGYgKG9yIHNpbWlsYXIgcmVmZXJlbmNlIGN5Y2xlKQoKICAgIGtvLnRvSlMgPSBmdW5jdGlvbihyb290T2JqZWN0KSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXaGVuIGNhbGxpbmcga28udG9KUywgcGFzcyB0aGUgb2JqZWN0IHlvdSB3YW50IHRvIGNvbnZlcnQuIik7CgogICAgICAgIC8vIFdlIGp1c3QgdW53cmFwIGV2ZXJ5dGhpbmcgYXQgZXZlcnkgbGV2ZWwgaW4gdGhlIG9iamVjdCBncmFwaAogICAgICAgIHJldHVybiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIGZ1bmN0aW9uKHZhbHVlVG9NYXApIHsKICAgICAgICAgICAgLy8gTG9vcCBiZWNhdXNlIGFuIG9ic2VydmFibGUncyB2YWx1ZSBtaWdodCBpbiB0dXJuIGJlIGFub3RoZXIgb2JzZXJ2YWJsZSB3cmFwcGVyCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBrby5pc09ic2VydmFibGUodmFsdWVUb01hcCkgJiYgKGkgPCBtYXhOZXN0ZWRPYnNlcnZhYmxlRGVwdGgpOyBpKyspCiAgICAgICAgICAgICAgICB2YWx1ZVRvTWFwID0gdmFsdWVUb01hcCgpOwogICAgICAgICAgICByZXR1cm4gdmFsdWVUb01hcDsKICAgICAgICB9KTsKICAgIH07CgogICAga28udG9KU09OID0gZnVuY3Rpb24ocm9vdE9iamVjdCwgcmVwbGFjZXIsIHNwYWNlKSB7ICAgICAvLyByZXBsYWNlciBhbmQgc3BhY2UgYXJlIG9wdGlvbmFsCiAgICAgICAgdmFyIHBsYWluSmF2YVNjcmlwdE9iamVjdCA9IGtvLnRvSlMocm9vdE9iamVjdCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnN0cmluZ2lmeUpzb24ocGxhaW5KYXZhU2NyaXB0T2JqZWN0LCByZXBsYWNlciwgc3BhY2UpOwogICAgfTsKCiAgICBmdW5jdGlvbiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIG1hcElucHV0Q2FsbGJhY2ssIHZpc2l0ZWRPYmplY3RzKSB7CiAgICAgICAgdmlzaXRlZE9iamVjdHMgPSB2aXNpdGVkT2JqZWN0cyB8fCBuZXcgb2JqZWN0TG9va3VwKCk7CgogICAgICAgIHJvb3RPYmplY3QgPSBtYXBJbnB1dENhbGxiYWNrKHJvb3RPYmplY3QpOwogICAgICAgIHZhciBjYW5IYXZlUHJvcGVydGllcyA9ICh0eXBlb2Ygcm9vdE9iamVjdCA9PSAib2JqZWN0IikgJiYgKHJvb3RPYmplY3QgIT09IG51bGwpICYmIChyb290T2JqZWN0ICE9PSB1bmRlZmluZWQpICYmICghKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBEYXRlKSk7CiAgICAgICAgaWYgKCFjYW5IYXZlUHJvcGVydGllcykKICAgICAgICAgICAgcmV0dXJuIHJvb3RPYmplY3Q7CgogICAgICAgIHZhciBvdXRwdXRQcm9wZXJ0aWVzID0gcm9vdE9iamVjdCBpbnN0YW5jZW9mIEFycmF5ID8gW10gOiB7fTsKICAgICAgICB2aXNpdGVkT2JqZWN0cy5zYXZlKHJvb3RPYmplY3QsIG91dHB1dFByb3BlcnRpZXMpOwoKICAgICAgICB2aXNpdFByb3BlcnRpZXNPckFycmF5RW50cmllcyhyb290T2JqZWN0LCBmdW5jdGlvbihpbmRleGVyKSB7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eVZhbHVlID0gbWFwSW5wdXRDYWxsYmFjayhyb290T2JqZWN0W2luZGV4ZXJdKTsKCiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHByb3BlcnR5VmFsdWUpIHsKICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0UHJvcGVydGllc1tpbmRleGVyXSA9IHByb3BlcnR5VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNseU1hcHBlZFZhbHVlID0gdmlzaXRlZE9iamVjdHMuZ2V0KHByb3BlcnR5VmFsdWUpOwogICAgICAgICAgICAgICAgICAgIG91dHB1dFByb3BlcnRpZXNbaW5kZXhlcl0gPSAocHJldmlvdXNseU1hcHBlZFZhbHVlICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgICAgID8gcHJldmlvdXNseU1hcHBlZFZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgIDogbWFwSnNPYmplY3RHcmFwaChwcm9wZXJ0eVZhbHVlLCBtYXBJbnB1dENhbGxiYWNrLCB2aXNpdGVkT2JqZWN0cyk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIG91dHB1dFByb3BlcnRpZXM7CiAgICB9CgogICAgZnVuY3Rpb24gdmlzaXRQcm9wZXJ0aWVzT3JBcnJheUVudHJpZXMocm9vdE9iamVjdCwgdmlzaXRvckNhbGxiYWNrKSB7CiAgICAgICAgaWYgKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvb3RPYmplY3QubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2soaSk7CgogICAgICAgICAgICAvLyBGb3IgYXJyYXlzLCBhbHNvIHJlc3BlY3QgdG9KU09OIHByb3BlcnR5IGZvciBjdXN0b20gbWFwcGluZ3MgKGZpeGVzICMyNzgpCiAgICAgICAgICAgIGlmICh0eXBlb2Ygcm9vdE9iamVjdFsndG9KU09OJ10gPT0gJ2Z1bmN0aW9uJykKICAgICAgICAgICAgICAgIHZpc2l0b3JDYWxsYmFjaygndG9KU09OJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlOYW1lIGluIHJvb3RPYmplY3QpCiAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2socHJvcGVydHlOYW1lKTsKICAgICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIG9iamVjdExvb2t1cCgpIHsKICAgICAgICB2YXIga2V5cyA9IFtdOwogICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgICB0aGlzLnNhdmUgPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBleGlzdGluZ0luZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGtleXMsIGtleSk7CiAgICAgICAgICAgIGlmIChleGlzdGluZ0luZGV4ID49IDApCiAgICAgICAgICAgICAgICB2YWx1ZXNbZXhpc3RpbmdJbmRleF0gPSB2YWx1ZTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdGhpcy5nZXQgPSBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nSW5kZXggPSBrby51dGlscy5hcnJheUluZGV4T2Yoa2V5cywga2V5KTsKICAgICAgICAgICAgcmV0dXJuIChleGlzdGluZ0luZGV4ID49IDApID8gdmFsdWVzW2V4aXN0aW5nSW5kZXhdIDogdW5kZWZpbmVkOwogICAgICAgIH07CiAgICB9Owp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd0b0pTJywga28udG9KUyk7CmtvLmV4cG9ydFN5bWJvbCgndG9KU09OJywga28udG9KU09OKTsKKGZ1bmN0aW9uICgpIHsKICAgIHZhciBoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5ID0gJ19fa29fX2hhc0RvbURhdGFPcHRpb25WYWx1ZV9fJzsKCiAgICAvLyBOb3JtYWxseSwgU0VMRUNUIGVsZW1lbnRzIGFuZCB0aGVpciBPUFRJT05zIGNhbiBvbmx5IHRha2UgdmFsdWUgb2YgdHlwZSAnc3RyaW5nJyAoYmVjYXVzZSB0aGUgdmFsdWVzCiAgICAvLyBhcmUgc3RvcmVkIG9uIERPTSBhdHRyaWJ1dGVzKS4ga28uc2VsZWN0RXh0ZW5zaW9ucyBwcm92aWRlcyBhIHdheSBmb3IgU0VMRUNUcy9PUFRJT05zIHRvIGhhdmUgdmFsdWVzCiAgICAvLyB0aGF0IGFyZSBhcmJpdHJhcnkgb2JqZWN0cy4gVGhpcyBpcyB2ZXJ5IGNvbnZlbmllbnQgd2hlbiBpbXBsZW1lbnRpbmcgdGhpbmdzIGxpa2UgY2FzY2FkaW5nIGRyb3Bkb3ducy4KICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMgPSB7CiAgICAgICAgcmVhZFZhbHVlIDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewogICAgICAgICAgICAgICAgY2FzZSAnb3B0aW9uJzoKICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XSA9PT0gdHJ1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmllVmVyc2lvbiA8PSA3CiAgICAgICAgICAgICAgICAgICAgICAgID8gKGVsZW1lbnQuZ2V0QXR0cmlidXRlTm9kZSgndmFsdWUnKS5zcGVjaWZpZWQgPyBlbGVtZW50LnZhbHVlIDogZWxlbWVudC50ZXh0KQogICAgICAgICAgICAgICAgICAgICAgICA6IGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnNlbGVjdGVkSW5kZXggPj0gMCA/IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tlbGVtZW50LnNlbGVjdGVkSW5kZXhdKSA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICB3cml0ZVZhbHVlOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewogICAgICAgICAgICAgICAgY2FzZSAnb3B0aW9uJzoKICAgICAgICAgICAgICAgICAgICBzd2l0Y2godHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnMub3B0aW9ucy5vcHRpb25WYWx1ZURvbURhdGFLZXksIHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzRG9tRGF0YUV4cGFuZG9Qcm9wZXJ0eSBpbiBlbGVtZW50KSB7IC8vIElFIDw9IDggdGhyb3dzIGVycm9ycyBpZiB5b3UgZGVsZXRlIG5vbi1leGlzdGVudCBwcm9wZXJ0aWVzIGZyb20gYSBET00gbm9kZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBlbGVtZW50W2hhc0RvbURhdGFFeHBhbmRvUHJvcGVydHldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9yZSBhcmJpdHJhcnkgb2JqZWN0IHVzaW5nIERvbURhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3BlY2lhbCB0cmVhdG1lbnQgb2YgbnVtYmVycyBpcyBqdXN0IGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LiBLTyAxLjIuMSB3cm90ZSBudW1lcmljYWwgdmFsdWVzIHRvIGVsZW1lbnQudmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiA/IHZhbHVlIDogIiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBlbGVtZW50Lm9wdGlvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tpXSkgPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc2VsZWN0ZWRJbmRleCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gbnVsbCkgfHwgKHZhbHVlID09PSB1bmRlZmluZWQpKQogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICIiOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ3NlbGVjdEV4dGVuc2lvbnMnLCBrby5zZWxlY3RFeHRlbnNpb25zKTsKa28uZXhwb3J0U3ltYm9sKCdzZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZScsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKTsKa28uZXhwb3J0U3ltYm9sKCdzZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUnLCBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUpOwprby5leHByZXNzaW9uUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciByZXN0b3JlQ2FwdHVyZWRUb2tlbnNSZWdleCA9IC9cQGtvX3Rva2VuXyhcZCspXEAvZzsKICAgIHZhciBqYXZhU2NyaXB0UmVzZXJ2ZWRXb3JkcyA9IFsidHJ1ZSIsICJmYWxzZSJdOwoKICAgIC8vIE1hdGNoZXMgc29tZXRoaW5nIHRoYXQgY2FuIGJlIGFzc2lnbmVkIHRvLS1laXRoZXIgYW4gaXNvbGF0ZWQgaWRlbnRpZmllciBvciBzb21ldGhpbmcgZW5kaW5nIHdpdGggYSBwcm9wZXJ0eSBhY2Nlc3NvcgogICAgLy8gVGhpcyBpcyBkZXNpZ25lZCB0byBiZSBzaW1wbGUgYW5kIGF2b2lkIGZhbHNlIG5lZ2F0aXZlcywgYnV0IGNvdWxkIHByb2R1Y2UgZmFsc2UgcG9zaXRpdmVzIChlLmcuLCBhK2IuYykuCiAgICB2YXIgamF2YVNjcmlwdEFzc2lnbm1lbnRUYXJnZXQgPSAvXig/OlskX2Etel1bJFx3XSp8KC4rKShcLlxzKlskX2Etel1bJFx3XSp8XFsuK1xdKSkkL2k7CgogICAgZnVuY3Rpb24gcmVzdG9yZVRva2VucyhzdHJpbmcsIHRva2VucykgewogICAgICAgIHZhciBwcmV2VmFsdWUgPSBudWxsOwogICAgICAgIHdoaWxlIChzdHJpbmcgIT0gcHJldlZhbHVlKSB7IC8vIEtlZXAgcmVzdG9yaW5nIHRva2VucyB1bnRpbCBpdCBubyBsb25nZXIgbWFrZXMgYSBkaWZmZXJlbmNlICh0aGV5IG1heSBiZSBuZXN0ZWQpCiAgICAgICAgICAgIHByZXZWYWx1ZSA9IHN0cmluZzsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UocmVzdG9yZUNhcHR1cmVkVG9rZW5zUmVnZXgsIGZ1bmN0aW9uIChtYXRjaCwgdG9rZW5JbmRleCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRva2Vuc1t0b2tlbkluZGV4XTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHJpbmc7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0V3JpdGVhYmxlVmFsdWUoZXhwcmVzc2lvbikgewogICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YoamF2YVNjcmlwdFJlc2VydmVkV29yZHMsIGtvLnV0aWxzLnN0cmluZ1RyaW0oZXhwcmVzc2lvbikudG9Mb3dlckNhc2UoKSkgPj0gMCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHZhciBtYXRjaCA9IGV4cHJlc3Npb24ubWF0Y2goamF2YVNjcmlwdEFzc2lnbm1lbnRUYXJnZXQpOwogICAgICAgIHJldHVybiBtYXRjaCA9PT0gbnVsbCA/IGZhbHNlIDogbWF0Y2hbMV0gPyAoJ09iamVjdCgnICsgbWF0Y2hbMV0gKyAnKScgKyBtYXRjaFsyXSkgOiBleHByZXNzaW9uOwogICAgfQoKICAgIGZ1bmN0aW9uIGVuc3VyZVF1b3RlZChrZXkpIHsKICAgICAgICB2YXIgdHJpbW1lZEtleSA9IGtvLnV0aWxzLnN0cmluZ1RyaW0oa2V5KTsKICAgICAgICBzd2l0Y2ggKHRyaW1tZWRLZXkubGVuZ3RoICYmIHRyaW1tZWRLZXkuY2hhckF0KDApKSB7CiAgICAgICAgICAgIGNhc2UgIiciOgogICAgICAgICAgICBjYXNlICciJzoKICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gIiciICsgdHJpbW1lZEtleSArICInIjsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBiaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnM6IFtdLAoKICAgICAgICBwYXJzZU9iamVjdExpdGVyYWw6IGZ1bmN0aW9uKG9iamVjdExpdGVyYWxTdHJpbmcpIHsKICAgICAgICAgICAgLy8gQSBmdWxsIHRva2VuaXNlcitsZXhlciB3b3VsZCBhZGQgdG9vIG11Y2ggd2VpZ2h0IHRvIHRoaXMgbGlicmFyeSwgc28gaGVyZSdzIGEgc2ltcGxlIHBhcnNlcgogICAgICAgICAgICAvLyB0aGF0IGlzIHN1ZmZpY2llbnQganVzdCB0byBzcGxpdCBhbiBvYmplY3QgbGl0ZXJhbCBzdHJpbmcgaW50byBhIHNldCBvZiB0b3AtbGV2ZWwga2V5LXZhbHVlIHBhaXJzCgogICAgICAgICAgICB2YXIgc3RyID0ga28udXRpbHMuc3RyaW5nVHJpbShvYmplY3RMaXRlcmFsU3RyaW5nKTsKICAgICAgICAgICAgaWYgKHN0ci5sZW5ndGggPCAzKQogICAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICBpZiAoc3RyLmNoYXJBdCgwKSA9PT0gInsiKS8vIElnbm9yZSBhbnkgYnJhY2VzIHN1cnJvdW5kaW5nIHRoZSB3aG9sZSBvYmplY3QgbGl0ZXJhbAogICAgICAgICAgICAgICAgc3RyID0gc3RyLnN1YnN0cmluZygxLCBzdHIubGVuZ3RoIC0gMSk7CgogICAgICAgICAgICAvLyBQdWxsIG91dCBhbnkgc3RyaW5nIGxpdGVyYWxzIGFuZCByZWdleCBsaXRlcmFscwogICAgICAgICAgICB2YXIgdG9rZW5zID0gW107CiAgICAgICAgICAgIHZhciB0b2tlblN0YXJ0ID0gbnVsbCwgdG9rZW5FbmRDaGFyOwogICAgICAgICAgICBmb3IgKHZhciBwb3NpdGlvbiA9IDA7IHBvc2l0aW9uIDwgc3RyLmxlbmd0aDsgcG9zaXRpb24rKykgewogICAgICAgICAgICAgICAgdmFyIGMgPSBzdHIuY2hhckF0KHBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh0b2tlblN0YXJ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJyInOgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICInIjoKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiLyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlblN0YXJ0ID0gcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbkVuZENoYXIgPSBjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoYyA9PSB0b2tlbkVuZENoYXIpICYmIChzdHIuY2hhckF0KHBvc2l0aW9uIC0gMSkgIT09ICJcXCIpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gc3RyLnN1YnN0cmluZyh0b2tlblN0YXJ0LCBwb3NpdGlvbiArIDEpOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVwbGFjZW1lbnQgPSAiQGtvX3Rva2VuXyIgKyAodG9rZW5zLmxlbmd0aCAtIDEpICsgIkAiOwogICAgICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoMCwgdG9rZW5TdGFydCkgKyByZXBsYWNlbWVudCArIHN0ci5zdWJzdHJpbmcocG9zaXRpb24gKyAxKTsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiAtPSAodG9rZW4ubGVuZ3RoIC0gcmVwbGFjZW1lbnQubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICB0b2tlblN0YXJ0ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTmV4dCBwdWxsIG91dCBiYWxhbmNlZCBwYXJlbiwgYnJhY2UsIGFuZCBicmFja2V0IGJsb2NrcwogICAgICAgICAgICB0b2tlblN0YXJ0ID0gbnVsbDsKICAgICAgICAgICAgdG9rZW5FbmRDaGFyID0gbnVsbDsKICAgICAgICAgICAgdmFyIHRva2VuRGVwdGggPSAwLCB0b2tlblN0YXJ0Q2hhciA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIHBvc2l0aW9uID0gMDsgcG9zaXRpb24gPCBzdHIubGVuZ3RoOyBwb3NpdGlvbisrKSB7CiAgICAgICAgICAgICAgICB2YXIgYyA9IHN0ci5jaGFyQXQocG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRva2VuU3RhcnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAieyI6IHRva2VuU3RhcnQgPSBwb3NpdGlvbjsgdG9rZW5TdGFydENoYXIgPSBjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5FbmRDaGFyID0gIn0iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIigiOiB0b2tlblN0YXJ0ID0gcG9zaXRpb247IHRva2VuU3RhcnRDaGFyID0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuRW5kQ2hhciA9ICIpIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJbIjogdG9rZW5TdGFydCA9IHBvc2l0aW9uOyB0b2tlblN0YXJ0Q2hhciA9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbkVuZENoYXIgPSAiXSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGMgPT09IHRva2VuU3RhcnRDaGFyKQogICAgICAgICAgICAgICAgICAgIHRva2VuRGVwdGgrKzsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGMgPT09IHRva2VuRW5kQ2hhcikgewogICAgICAgICAgICAgICAgICAgIHRva2VuRGVwdGgtLTsKICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW5EZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBzdHIuc3Vic3RyaW5nKHRva2VuU3RhcnQsIHBvc2l0aW9uICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlcGxhY2VtZW50ID0gIkBrb190b2tlbl8iICsgKHRva2Vucy5sZW5ndGggLSAxKSArICJAIjsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyLnN1YnN0cmluZygwLCB0b2tlblN0YXJ0KSArIHJlcGxhY2VtZW50ICsgc3RyLnN1YnN0cmluZyhwb3NpdGlvbiArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiAtPSAodG9rZW4ubGVuZ3RoIC0gcmVwbGFjZW1lbnQubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5TdGFydCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOb3cgd2UgY2FuIHNhZmVseSBzcGxpdCBvbiBjb21tYXMgdG8gZ2V0IHRoZSBrZXkvdmFsdWUgcGFpcnMKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICB2YXIga2V5VmFsdWVQYWlycyA9IHN0ci5zcGxpdCgiLCIpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGtleVZhbHVlUGFpcnMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFpciA9IGtleVZhbHVlUGFpcnNbaV07CiAgICAgICAgICAgICAgICB2YXIgY29sb25Qb3MgPSBwYWlyLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgICAgIGlmICgoY29sb25Qb3MgPiAwKSAmJiAoY29sb25Qb3MgPCBwYWlyLmxlbmd0aCAtIDEpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IHBhaXIuc3Vic3RyaW5nKDAsIGNvbG9uUG9zKTsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBwYWlyLnN1YnN0cmluZyhjb2xvblBvcyArIDEpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHsgJ2tleSc6IHJlc3RvcmVUb2tlbnMoa2V5LCB0b2tlbnMpLCAndmFsdWUnOiByZXN0b3JlVG9rZW5zKHZhbHVlLCB0b2tlbnMpIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh7ICd1bmtub3duJzogcmVzdG9yZVRva2VucyhwYWlyLCB0b2tlbnMpIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAgcHJlUHJvY2Vzc0JpbmRpbmdzOiBmdW5jdGlvbiAob2JqZWN0TGl0ZXJhbFN0cmluZ09yS2V5VmFsdWVBcnJheSkgewogICAgICAgICAgICB2YXIga2V5VmFsdWVBcnJheSA9IHR5cGVvZiBvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5ID09PSAic3RyaW5nIgogICAgICAgICAgICAgICAgPyBrby5leHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbChvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5KQogICAgICAgICAgICAgICAgOiBvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5OwogICAgICAgICAgICB2YXIgcmVzdWx0U3RyaW5ncyA9IFtdLCBwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncyA9IFtdOwoKICAgICAgICAgICAgdmFyIGtleVZhbHVlRW50cnk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBrZXlWYWx1ZUVudHJ5ID0ga2V5VmFsdWVBcnJheVtpXTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0U3RyaW5ncy5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCgiLCIpOwoKICAgICAgICAgICAgICAgIGlmIChrZXlWYWx1ZUVudHJ5WydrZXknXSkgewogICAgICAgICAgICAgICAgICAgIHZhciBxdW90ZWRLZXkgPSBlbnN1cmVRdW90ZWQoa2V5VmFsdWVFbnRyeVsna2V5J10pLCB2YWwgPSBrZXlWYWx1ZUVudHJ5Wyd2YWx1ZSddOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaChxdW90ZWRLZXkpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCgiOiIpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCh2YWwpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodmFsID0gZ2V0V3JpdGVhYmxlVmFsdWUoa28udXRpbHMuc3RyaW5nVHJpbSh2YWwpKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3MubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLnB1c2goIiwgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLnB1c2gocXVvdGVkS2V5ICsgIiA6IGZ1bmN0aW9uKF9fa29fdmFsdWUpIHsgIiArIHZhbCArICIgPSBfX2tvX3ZhbHVlOyB9Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXlWYWx1ZUVudHJ5Wyd1bmtub3duJ10pIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmdzLnB1c2goa2V5VmFsdWVFbnRyeVsndW5rbm93biddKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNvbWJpbmVkUmVzdWx0ID0gcmVzdWx0U3RyaW5ncy5qb2luKCIiKTsKICAgICAgICAgICAgaWYgKHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBhbGxQcm9wZXJ0eUFjY2Vzc29ycyA9IHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLmpvaW4oIiIpOwogICAgICAgICAgICAgICAgY29tYmluZWRSZXN1bHQgPSBjb21iaW5lZFJlc3VsdCArICIsICdfa29fcHJvcGVydHlfd3JpdGVycycgOiB7ICIgKyBhbGxQcm9wZXJ0eUFjY2Vzc29ycyArICIgfSAiOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gY29tYmluZWRSZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAga2V5VmFsdWVBcnJheUNvbnRhaW5zS2V5OiBmdW5jdGlvbihrZXlWYWx1ZUFycmF5LCBrZXkpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlWYWx1ZUFycmF5Lmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLnN0cmluZ1RyaW0oa2V5VmFsdWVBcnJheVtpXVsna2V5J10pID09IGtleSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8vIEludGVybmFsLCBwcml2YXRlIEtPIHV0aWxpdHkgZm9yIHVwZGF0aW5nIG1vZGVsIHByb3BlcnRpZXMgZnJvbSB3aXRoaW4gYmluZGluZ3MKICAgICAgICAvLyBwcm9wZXJ0eTogICAgICAgICAgICBJZiB0aGUgcHJvcGVydHkgYmVpbmcgdXBkYXRlZCBpcyAob3IgbWlnaHQgYmUpIGFuIG9ic2VydmFibGUsIHBhc3MgaXQgaGVyZQogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIElmIGl0IHR1cm5zIG91dCB0byBiZSBhIHdyaXRhYmxlIG9ic2VydmFibGUsIGl0IHdpbGwgYmUgd3JpdHRlbiB0byBkaXJlY3RseQogICAgICAgIC8vIGFsbEJpbmRpbmdzQWNjZXNzb3I6IEFsbCBiaW5kaW5ncyBpbiB0aGUgY3VycmVudCBleGVjdXRpb24gY29udGV4dC4KICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgICBUaGlzIHdpbGwgYmUgc2VhcmNoZWQgZm9yIGEgJ19rb19wcm9wZXJ0eV93cml0ZXJzJyBwcm9wZXJ0eSBpbiBjYXNlIHlvdSdyZSB3cml0aW5nIHRvIGEgbm9uLW9ic2VydmFibGUKICAgICAgICAvLyBrZXk6ICAgICAgICAgICAgICAgICBUaGUga2V5IGlkZW50aWZ5aW5nIHRoZSBwcm9wZXJ0eSB0byBiZSB3cml0dGVuLiBFeGFtcGxlOiBmb3IgeyBoYXNGb2N1czogbXlWYWx1ZSB9LCB3cml0ZSB0byAnbXlWYWx1ZScgYnkgc3BlY2lmeWluZyB0aGUga2V5ICdoYXNGb2N1cycKICAgICAgICAvLyB2YWx1ZTogICAgICAgICAgICAgICBUaGUgdmFsdWUgdG8gYmUgd3JpdHRlbgogICAgICAgIC8vIGNoZWNrSWZEaWZmZXJlbnQ6ICAgIElmIHRydWUsIGFuZCBpZiB0aGUgcHJvcGVydHkgYmVpbmcgd3JpdHRlbiBpcyBhIHdyaXRhYmxlIG9ic2VydmFibGUsIHRoZSB2YWx1ZSB3aWxsIG9ubHkgYmUgd3JpdHRlbiBpZgogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIGl0IGlzICE9PSBleGlzdGluZyB2YWx1ZSBvbiB0aGF0IHdyaXRhYmxlIG9ic2VydmFibGUKICAgICAgICB3cml0ZVZhbHVlVG9Qcm9wZXJ0eTogZnVuY3Rpb24ocHJvcGVydHksIGFsbEJpbmRpbmdzQWNjZXNzb3IsIGtleSwgdmFsdWUsIGNoZWNrSWZEaWZmZXJlbnQpIHsKICAgICAgICAgICAgaWYgKCFwcm9wZXJ0eSB8fCAha28uaXNXcml0ZWFibGVPYnNlcnZhYmxlKHByb3BlcnR5KSkgewogICAgICAgICAgICAgICAgdmFyIHByb3BXcml0ZXJzID0gYWxsQmluZGluZ3NBY2Nlc3NvcigpWydfa29fcHJvcGVydHlfd3JpdGVycyddOwogICAgICAgICAgICAgICAgaWYgKHByb3BXcml0ZXJzICYmIHByb3BXcml0ZXJzW2tleV0pCiAgICAgICAgICAgICAgICAgICAgcHJvcFdyaXRlcnNba2V5XSh2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWNoZWNrSWZEaWZmZXJlbnQgfHwgcHJvcGVydHkucGVlaygpICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgcHJvcGVydHkodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgnZXhwcmVzc2lvblJld3JpdGluZycsIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcpOwprby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzJywga28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnMpOwprby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wYXJzZU9iamVjdExpdGVyYWwpOwprby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcucHJlUHJvY2Vzc0JpbmRpbmdzJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MpOwoKLy8gRm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIGRlZmluZSB0aGUgZm9sbG93aW5nIGFsaWFzZXMuIChQcmV2aW91c2x5LCB0aGVzZSBmdW5jdGlvbiBuYW1lcyB3ZXJlIG1pc2xlYWRpbmcgYmVjYXVzZQovLyB0aGV5IHJlZmVycmVkIHRvIEpTT04gc3BlY2lmaWNhbGx5LCBldmVuIHRob3VnaCB0aGV5IGFjdHVhbGx5IHdvcmsgd2l0aCBhcmJpdHJhcnkgSmF2YVNjcmlwdCBvYmplY3QgbGl0ZXJhbCBleHByZXNzaW9ucy4pCmtvLmV4cG9ydFN5bWJvbCgnanNvbkV4cHJlc3Npb25SZXdyaXRpbmcnLCBrby5leHByZXNzaW9uUmV3cml0aW5nKTsKa28uZXhwb3J0U3ltYm9sKCdqc29uRXhwcmVzc2lvblJld3JpdGluZy5pbnNlcnRQcm9wZXJ0eUFjY2Vzc29yc0ludG9Kc29uJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MpOyhmdW5jdGlvbigpIHsKICAgIC8vICJWaXJ0dWFsIGVsZW1lbnRzIiBpcyBhbiBhYnN0cmFjdGlvbiBvbiB0b3Agb2YgdGhlIHVzdWFsIERPTSBBUEkgd2hpY2ggdW5kZXJzdGFuZHMgdGhlIG5vdGlvbiB0aGF0IGNvbW1lbnQgbm9kZXMKICAgIC8vIG1heSBiZSB1c2VkIHRvIHJlcHJlc2VudCBoaWVyYXJjaHkgKGluIGFkZGl0aW9uIHRvIHRoZSBET00ncyBuYXR1cmFsIGhpZXJhcmNoeSkuCiAgICAvLyBJZiB5b3UgY2FsbCB0aGUgRE9NLW1hbmlwdWxhdGluZyBmdW5jdGlvbnMgb24ga28udmlydHVhbEVsZW1lbnRzLCB5b3Ugd2lsbCBiZSBhYmxlIHRvIHJlYWQgYW5kIHdyaXRlIHRoZSBzdGF0ZQogICAgLy8gb2YgdGhhdCB2aXJ0dWFsIGhpZXJhcmNoeQogICAgLy8KICAgIC8vIFRoZSBwb2ludCBvZiBhbGwgdGhpcyBpcyB0byBzdXBwb3J0IGNvbnRhaW5lcmxlc3MgdGVtcGxhdGVzIChlLmcuLCA8IS0tIGtvIGZvcmVhY2g6c29tZUNvbGxlY3Rpb24gLS0+YmxhaDwhLS0gL2tvIC0tPikKICAgIC8vIHdpdGhvdXQgaGF2aW5nIHRvIHNjYXR0ZXIgc3BlY2lhbCBjYXNlcyBhbGwgb3ZlciB0aGUgYmluZGluZyBhbmQgdGVtcGxhdGluZyBjb2RlLgoKICAgIC8vIElFIDkgY2Fubm90IHJlbGlhYmx5IHJlYWQgdGhlICJub2RlVmFsdWUiIHByb3BlcnR5IG9mIGEgY29tbWVudCBub2RlIChzZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8xODYpCiAgICAvLyBidXQgaXQgZG9lcyBnaXZlIHRoZW0gYSBub25zdGFuZGFyZCBhbHRlcm5hdGl2ZSBwcm9wZXJ0eSBjYWxsZWQgInRleHQiIHRoYXQgaXQgY2FuIHJlYWQgcmVsaWFibHkuIE90aGVyIGJyb3dzZXJzIGRvbid0IGhhdmUgdGhhdCBwcm9wZXJ0eS4KICAgIC8vIFNvLCB1c2Ugbm9kZS50ZXh0IHdoZXJlIGF2YWlsYWJsZSwgYW5kIG5vZGUubm9kZVZhbHVlIGVsc2V3aGVyZQogICAgdmFyIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KCJ0ZXN0IikudGV4dCA9PT0gIjwhLS10ZXN0LS0+IjsKCiAgICB2YXIgc3RhcnRDb21tZW50UmVnZXggPSBjb21tZW50Tm9kZXNIYXZlVGV4dFByb3BlcnR5ID8gL148IS0tXHMqa28oPzpccysoLitccypcOltcc1xTXSopKT9ccyotLT4kLyA6IC9eXHMqa28oPzpccysoLitccypcOltcc1xTXSopKT9ccyokLzsKICAgIHZhciBlbmRDb21tZW50UmVnZXggPSAgIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyAvXjwhLS1ccypcL2tvXHMqLS0+JC8gOiAvXlxzKlwva29ccyokLzsKICAgIHZhciBodG1sVGFnc1dpdGhPcHRpb25hbGx5Q2xvc2luZ0NoaWxkcmVuID0geyAndWwnOiB0cnVlLCAnb2wnOiB0cnVlIH07CgogICAgZnVuY3Rpb24gaXNTdGFydENvbW1lbnQobm9kZSkgewogICAgICAgIHJldHVybiAobm9kZS5ub2RlVHlwZSA9PSA4KSAmJiAoY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IG5vZGUudGV4dCA6IG5vZGUubm9kZVZhbHVlKS5tYXRjaChzdGFydENvbW1lbnRSZWdleCk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNFbmRDb21tZW50KG5vZGUpIHsKICAgICAgICByZXR1cm4gKG5vZGUubm9kZVR5cGUgPT0gOCkgJiYgKGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyBub2RlLnRleHQgOiBub2RlLm5vZGVWYWx1ZSkubWF0Y2goZW5kQ29tbWVudFJlZ2V4KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRWaXJ0dWFsQ2hpbGRyZW4oc3RhcnRDb21tZW50LCBhbGxvd1VuYmFsYW5jZWQpIHsKICAgICAgICB2YXIgY3VycmVudE5vZGUgPSBzdGFydENvbW1lbnQ7CiAgICAgICAgdmFyIGRlcHRoID0gMTsKICAgICAgICB2YXIgY2hpbGRyZW4gPSBbXTsKICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICBpZiAoaXNFbmRDb21tZW50KGN1cnJlbnROb2RlKSkgewogICAgICAgICAgICAgICAgZGVwdGgtLTsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goY3VycmVudE5vZGUpOwoKICAgICAgICAgICAgaWYgKGlzU3RhcnRDb21tZW50KGN1cnJlbnROb2RlKSkKICAgICAgICAgICAgICAgIGRlcHRoKys7CiAgICAgICAgfQogICAgICAgIGlmICghYWxsb3dVbmJhbGFuY2VkKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmaW5kIGNsb3NpbmcgY29tbWVudCB0YWcgdG8gbWF0Y2g6ICIgKyBzdGFydENvbW1lbnQubm9kZVZhbHVlKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRNYXRjaGluZ0VuZENvbW1lbnQoc3RhcnRDb21tZW50LCBhbGxvd1VuYmFsYW5jZWQpIHsKICAgICAgICB2YXIgYWxsVmlydHVhbENoaWxkcmVuID0gZ2V0VmlydHVhbENoaWxkcmVuKHN0YXJ0Q29tbWVudCwgYWxsb3dVbmJhbGFuY2VkKTsKICAgICAgICBpZiAoYWxsVmlydHVhbENoaWxkcmVuKSB7CiAgICAgICAgICAgIGlmIChhbGxWaXJ0dWFsQ2hpbGRyZW4ubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgIHJldHVybiBhbGxWaXJ0dWFsQ2hpbGRyZW5bYWxsVmlydHVhbENoaWxkcmVuLmxlbmd0aCAtIDFdLm5leHRTaWJsaW5nOwogICAgICAgICAgICByZXR1cm4gc3RhcnRDb21tZW50Lm5leHRTaWJsaW5nOwogICAgICAgIH0gZWxzZQogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gTXVzdCBoYXZlIG5vIG1hdGNoaW5nIGVuZCBjb21tZW50LCBhbmQgYWxsb3dVbmJhbGFuY2VkIGlzIHRydWUKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRVbmJhbGFuY2VkQ2hpbGRUYWdzKG5vZGUpIHsKICAgICAgICAvLyBlLmcuLCBmcm9tIDxkaXY+T0s8L2Rpdj48IS0tIGtvIGJsYWggLS0+PHNwYW4+QW5vdGhlcjwvc3Bhbj4sIHJldHVybnM6IDwhLS0ga28gYmxhaCAtLT48c3Bhbj5Bbm90aGVyPC9zcGFuPgogICAgICAgIC8vICAgICAgIGZyb20gPGRpdj5PSzwvZGl2PjwhLS0gL2tvIC0tPjwhLS0gL2tvIC0tPiwgICAgICAgICAgICAgcmV0dXJuczogPCEtLSAva28gLS0+PCEtLSAva28gLS0+CiAgICAgICAgdmFyIGNoaWxkTm9kZSA9IG5vZGUuZmlyc3RDaGlsZCwgY2FwdHVyZVJlbWFpbmluZyA9IG51bGw7CiAgICAgICAgaWYgKGNoaWxkTm9kZSkgewogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBpZiAoY2FwdHVyZVJlbWFpbmluZykgICAgICAgICAgICAgICAgICAgLy8gV2UgYWxyZWFkeSBoaXQgYW4gdW5iYWxhbmNlZCBub2RlIGFuZCBhcmUgbm93IGp1c3Qgc2Nvb3BpbmcgdXAgYWxsIHN1YnNlcXVlbnQgbm9kZXMKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nLnB1c2goY2hpbGROb2RlKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzU3RhcnRDb21tZW50KGNoaWxkTm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2hpbmdFbmRDb21tZW50ID0gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KGNoaWxkTm9kZSwgLyogYWxsb3dVbmJhbGFuY2VkOiAqLyB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hpbmdFbmRDb21tZW50KSAgICAgICAgICAgICAvLyBJdCdzIGEgYmFsYW5jZWQgdGFnLCBzbyBza2lwIGltbWVkaWF0ZWx5IHRvIHRoZSBlbmQgb2YgdGhpcyB2aXJ0dWFsIHNldAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUgPSBtYXRjaGluZ0VuZENvbW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nID0gW2NoaWxkTm9kZV07IC8vIEl0J3MgdW5iYWxhbmNlZCwgc28gc3RhcnQgY2FwdHVyaW5nIGZyb20gdGhpcyBwb2ludAogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0VuZENvbW1lbnQoY2hpbGROb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVSZW1haW5pbmcgPSBbY2hpbGROb2RlXTsgICAgIC8vIEl0J3MgdW5iYWxhbmNlZCAoaWYgaXQgd2Fzbid0LCB3ZSdkIGhhdmUgc2tpcHBlZCBvdmVyIGl0IGFscmVhZHkpLCBzbyBzdGFydCBjYXB0dXJpbmcKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoY2hpbGROb2RlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhcHR1cmVSZW1haW5pbmc7CiAgICB9CgogICAga28udmlydHVhbEVsZW1lbnRzID0gewogICAgICAgIGFsbG93ZWRCaW5kaW5nczoge30sCgogICAgICAgIGNoaWxkTm9kZXM6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGlzU3RhcnRDb21tZW50KG5vZGUpID8gZ2V0VmlydHVhbENoaWxkcmVuKG5vZGUpIDogbm9kZS5jaGlsZE5vZGVzOwogICAgICAgIH0sCgogICAgICAgIGVtcHR5Tm9kZTogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KG5vZGUpKQogICAgICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKG5vZGUpOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB2aXJ0dWFsQ2hpbGRyZW4gPSBrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2Rlcyhub2RlKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmlydHVhbENoaWxkcmVuLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBrby5yZW1vdmVOb2RlKHZpcnR1YWxDaGlsZHJlbltpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzZXREb21Ob2RlQ2hpbGRyZW46IGZ1bmN0aW9uKG5vZGUsIGNoaWxkTm9kZXMpIHsKICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChub2RlKSkKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbihub2RlLCBjaGlsZE5vZGVzKTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKG5vZGUpOwogICAgICAgICAgICAgICAgdmFyIGVuZENvbW1lbnROb2RlID0gbm9kZS5uZXh0U2libGluZzsgLy8gTXVzdCBiZSB0aGUgbmV4dCBzaWJsaW5nLCBhcyB3ZSBqdXN0IGVtcHRpZWQgdGhlIGNoaWxkcmVuCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgICAgIGVuZENvbW1lbnROb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkTm9kZXNbaV0sIGVuZENvbW1lbnROb2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHByZXBlbmQ6IGZ1bmN0aW9uKGNvbnRhaW5lck5vZGUsIG5vZGVUb1ByZXBlbmQpIHsKICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChjb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lck5vZGUuZmlyc3RDaGlsZCkKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmluc2VydEJlZm9yZShub2RlVG9QcmVwZW5kLCBjb250YWluZXJOb2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuYXBwZW5kQ2hpbGQobm9kZVRvUHJlcGVuZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTdGFydCBjb21tZW50cyBtdXN0IGFsd2F5cyBoYXZlIGEgcGFyZW50IGFuZCBhdCBsZWFzdCBvbmUgZm9sbG93aW5nIHNpYmxpbmcgKHRoZSBlbmQgY29tbWVudCkKICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvUHJlcGVuZCwgY29udGFpbmVyTm9kZS5uZXh0U2libGluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBpbnNlcnRBZnRlcjogZnVuY3Rpb24oY29udGFpbmVyTm9kZSwgbm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUpIHsKICAgICAgICAgICAgaWYgKCFpbnNlcnRBZnRlck5vZGUpIHsKICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5wcmVwZW5kKGNvbnRhaW5lck5vZGUsIG5vZGVUb0luc2VydCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzU3RhcnRDb21tZW50KGNvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgICAgICAvLyBJbnNlcnQgYWZ0ZXIgaW5zZXJ0aW9uIHBvaW50CiAgICAgICAgICAgICAgICBpZiAoaW5zZXJ0QWZ0ZXJOb2RlLm5leHRTaWJsaW5nKQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuaW5zZXJ0QmVmb3JlKG5vZGVUb0luc2VydCwgaW5zZXJ0QWZ0ZXJOb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmFwcGVuZENoaWxkKG5vZGVUb0luc2VydCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBDaGlsZHJlbiBvZiBzdGFydCBjb21tZW50cyBtdXN0IGFsd2F5cyBoYXZlIGEgcGFyZW50IGFuZCBhdCBsZWFzdCBvbmUgZm9sbG93aW5nIHNpYmxpbmcgKHRoZSBlbmQgY29tbWVudCkKICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUubmV4dFNpYmxpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZmlyc3RDaGlsZDogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KG5vZGUpKQogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgICAgaWYgKCFub2RlLm5leHRTaWJsaW5nIHx8IGlzRW5kQ29tbWVudChub2RlLm5leHRTaWJsaW5nKSkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gbm9kZS5uZXh0U2libGluZzsKICAgICAgICB9LAoKICAgICAgICBuZXh0U2libGluZzogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBpZiAoaXNTdGFydENvbW1lbnQobm9kZSkpCiAgICAgICAgICAgICAgICBub2RlID0gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KG5vZGUpOwogICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyAmJiBpc0VuZENvbW1lbnQobm9kZS5uZXh0U2libGluZykpCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgfSwKCiAgICAgICAgdmlydHVhbE5vZGVCaW5kaW5nVmFsdWU6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgdmFyIHJlZ2V4TWF0Y2ggPSBpc1N0YXJ0Q29tbWVudChub2RlKTsKICAgICAgICAgICAgcmV0dXJuIHJlZ2V4TWF0Y2ggPyByZWdleE1hdGNoWzFdIDogbnVsbDsKICAgICAgICB9LAoKICAgICAgICBub3JtYWxpc2VWaXJ0dWFsRWxlbWVudERvbVN0cnVjdHVyZTogZnVuY3Rpb24oZWxlbWVudFZlcmlmaWVkKSB7CiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTU1CiAgICAgICAgICAgIC8vIChJRSA8PSA4IG9yIElFIDkgcXVpcmtzIG1vZGUgcGFyc2VzIHlvdXIgSFRNTCB3ZWlyZGx5LCB0cmVhdGluZyBjbG9zaW5nIDwvbGk+IHRhZ3MgYXMgaWYgdGhleSBkb24ndCBleGlzdCwgdGhlcmVieSBtb3ZpbmcgY29tbWVudCBub2RlcwogICAgICAgICAgICAvLyB0aGF0IGFyZSBkaXJlY3QgZGVzY2VuZGFudHMgb2YgPHVsPiBpbnRvIHRoZSBwcmVjZWRpbmcgPGxpPikKICAgICAgICAgICAgaWYgKCFodG1sVGFnc1dpdGhPcHRpb25hbGx5Q2xvc2luZ0NoaWxkcmVuW2tvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50VmVyaWZpZWQpXSkKICAgICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIFNjYW4gaW1tZWRpYXRlIGNoaWxkcmVuIHRvIHNlZSBpZiB0aGV5IGNvbnRhaW4gdW5iYWxhbmNlZCBjb21tZW50IHRhZ3MuIElmIHRoZXkgZG8sIHRob3NlIGNvbW1lbnQgdGFncwogICAgICAgICAgICAvLyBtdXN0IGJlIGludGVuZGVkIHRvIGFwcGVhciAqYWZ0ZXIqIHRoYXQgY2hpbGQsIHNvIG1vdmUgdGhlbSB0aGVyZS4KICAgICAgICAgICAgdmFyIGNoaWxkTm9kZSA9IGVsZW1lbnRWZXJpZmllZC5maXJzdENoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGROb2RlKSB7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkTm9kZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdW5iYWxhbmNlZFRhZ3MgPSBnZXRVbmJhbGFuY2VkQ2hpbGRUYWdzKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmJhbGFuY2VkVGFncykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRml4IHVwIHRoZSBET00gYnkgbW92aW5nIHRoZSB1bmJhbGFuY2VkIHRhZ3MgdG8gd2hlcmUgdGhleSBtb3N0IGxpa2VseSB3ZXJlIGludGVuZGVkIHRvIGJlIHBsYWNlZCAtICphZnRlciogdGhlIGNoaWxkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZVRvSW5zZXJ0QmVmb3JlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1bmJhbGFuY2VkVGFncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlVG9JbnNlcnRCZWZvcmUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRWZXJpZmllZC5pbnNlcnRCZWZvcmUodW5iYWxhbmNlZFRhZ3NbaV0sIG5vZGVUb0luc2VydEJlZm9yZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50VmVyaWZpZWQuYXBwZW5kQ2hpbGQodW5iYWxhbmNlZFRhZ3NbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSB3aGlsZSAoY2hpbGROb2RlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7CmtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzJywga28udmlydHVhbEVsZW1lbnRzKTsKa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzJywga28udmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5ncyk7CmtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZScsIGtvLnZpcnR1YWxFbGVtZW50cy5lbXB0eU5vZGUpOwovL2tvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQnLCBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZCk7ICAgICAvLyBmaXJzdENoaWxkIGlzIG5vdCBtaW5pZmllZAprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcicsIGtvLnZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcik7Ci8va28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcnLCBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcpOyAgIC8vIG5leHRTaWJsaW5nIGlzIG5vdCBtaW5pZmllZAprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5wcmVwZW5kJywga28udmlydHVhbEVsZW1lbnRzLnByZXBlbmQpOwprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4nLCBrby52aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuKTsKKGZ1bmN0aW9uKCkgewogICAgdmFyIGRlZmF1bHRCaW5kaW5nQXR0cmlidXRlTmFtZSA9ICJkYXRhLWJpbmQiOwoKICAgIGtvLmJpbmRpbmdQcm92aWRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYmluZGluZ0NhY2hlID0ge307CiAgICB9OwoKICAgIGtvLnV0aWxzLmV4dGVuZChrby5iaW5kaW5nUHJvdmlkZXIucHJvdG90eXBlLCB7CiAgICAgICAgJ25vZGVIYXNCaW5kaW5ncyc6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgc3dpdGNoIChub2RlLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUpICE9IG51bGw7ICAgLy8gRWxlbWVudAogICAgICAgICAgICAgICAgY2FzZSA4OiByZXR1cm4ga28udmlydHVhbEVsZW1lbnRzLnZpcnR1YWxOb2RlQmluZGluZ1ZhbHVlKG5vZGUpICE9IG51bGw7IC8vIENvbW1lbnQgbm9kZQogICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgJ2dldEJpbmRpbmdzJzogZnVuY3Rpb24obm9kZSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgdmFyIGJpbmRpbmdzU3RyaW5nID0gdGhpc1snZ2V0QmluZGluZ3NTdHJpbmcnXShub2RlLCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIHJldHVybiBiaW5kaW5nc1N0cmluZyA/IHRoaXNbJ3BhcnNlQmluZGluZ3NTdHJpbmcnXShiaW5kaW5nc1N0cmluZywgYmluZGluZ0NvbnRleHQsIG5vZGUpIDogbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIGlzIG9ubHkgdXNlZCBpbnRlcm5hbGx5IGJ5IHRoaXMgZGVmYXVsdCBwcm92aWRlci4KICAgICAgICAvLyBJdCdzIG5vdCBwYXJ0IG9mIHRoZSBpbnRlcmZhY2UgZGVmaW5pdGlvbiBmb3IgYSBnZW5lcmFsIGJpbmRpbmcgcHJvdmlkZXIuCiAgICAgICAgJ2dldEJpbmRpbmdzU3RyaW5nJzogZnVuY3Rpb24obm9kZSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgc3dpdGNoIChub2RlLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUpOyAgIC8vIEVsZW1lbnQKICAgICAgICAgICAgICAgIGNhc2UgODogcmV0dXJuIGtvLnZpcnR1YWxFbGVtZW50cy52aXJ0dWFsTm9kZUJpbmRpbmdWYWx1ZShub2RlKTsgLy8gQ29tbWVudCBub2RlCiAgICAgICAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gaXMgb25seSB1c2VkIGludGVybmFsbHkgYnkgdGhpcyBkZWZhdWx0IHByb3ZpZGVyLgogICAgICAgIC8vIEl0J3Mgbm90IHBhcnQgb2YgdGhlIGludGVyZmFjZSBkZWZpbml0aW9uIGZvciBhIGdlbmVyYWwgYmluZGluZyBwcm92aWRlci4KICAgICAgICAncGFyc2VCaW5kaW5nc1N0cmluZyc6IGZ1bmN0aW9uKGJpbmRpbmdzU3RyaW5nLCBiaW5kaW5nQ29udGV4dCwgbm9kZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdGdW5jdGlvbiA9IGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yVmlhQ2FjaGUoYmluZGluZ3NTdHJpbmcsIHRoaXMuYmluZGluZ0NhY2hlKTsKICAgICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nRnVuY3Rpb24oYmluZGluZ0NvbnRleHQsIG5vZGUpOwogICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gcGFyc2UgYmluZGluZ3MuXG5NZXNzYWdlOiAiICsgZXggKyAiO1xuQmluZGluZ3MgdmFsdWU6ICIgKyBiaW5kaW5nc1N0cmluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCiAgICBrby5iaW5kaW5nUHJvdmlkZXJbJ2luc3RhbmNlJ10gPSBuZXcga28uYmluZGluZ1Byb3ZpZGVyKCk7CgogICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ3NTdHJpbmdFdmFsdWF0b3JWaWFDYWNoZShiaW5kaW5nc1N0cmluZywgY2FjaGUpIHsKICAgICAgICB2YXIgY2FjaGVLZXkgPSBiaW5kaW5nc1N0cmluZzsKICAgICAgICByZXR1cm4gY2FjaGVbY2FjaGVLZXldCiAgICAgICAgICAgIHx8IChjYWNoZVtjYWNoZUtleV0gPSBjcmVhdGVCaW5kaW5nc1N0cmluZ0V2YWx1YXRvcihiaW5kaW5nc1N0cmluZykpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yKGJpbmRpbmdzU3RyaW5nKSB7CiAgICAgICAgLy8gQnVpbGQgdGhlIHNvdXJjZSBmb3IgYSBmdW5jdGlvbiB0aGF0IGV2YWx1YXRlcyAiZXhwcmVzc2lvbiIKICAgICAgICAvLyBGb3IgZWFjaCBzY29wZSB2YXJpYWJsZSwgYWRkIGFuIGV4dHJhIGxldmVsIG9mICJ3aXRoIiBuZXN0aW5nCiAgICAgICAgLy8gRXhhbXBsZSByZXN1bHQ6IHdpdGgoc2MxKSB7IHdpdGgoc2MwKSB7IHJldHVybiAoZXhwcmVzc2lvbikgfSB9CiAgICAgICAgdmFyIHJld3JpdHRlbkJpbmRpbmdzID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MoYmluZGluZ3NTdHJpbmcpLAogICAgICAgICAgICBmdW5jdGlvbkJvZHkgPSAid2l0aCgkY29udGV4dCl7d2l0aCgkZGF0YXx8e30pe3JldHVybnsiICsgcmV3cml0dGVuQmluZGluZ3MgKyAifX19IjsKICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCIkY29udGV4dCIsICIkZWxlbWVudCIsIGZ1bmN0aW9uQm9keSk7CiAgICB9Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ2JpbmRpbmdQcm92aWRlcicsIGtvLmJpbmRpbmdQcm92aWRlcik7CihmdW5jdGlvbiAoKSB7CiAgICBrby5iaW5kaW5nSGFuZGxlcnMgPSB7fTsKCiAgICBrby5iaW5kaW5nQ29udGV4dCA9IGZ1bmN0aW9uKGRhdGFJdGVtLCBwYXJlbnRCaW5kaW5nQ29udGV4dCwgZGF0YUl0ZW1BbGlhcykgewogICAgICAgIGlmIChwYXJlbnRCaW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICBrby51dGlscy5leHRlbmQodGhpcywgcGFyZW50QmluZGluZ0NvbnRleHQpOyAvLyBJbmhlcml0ICRyb290IGFuZCBhbnkgY3VzdG9tIHByb3BlcnRpZXMKICAgICAgICAgICAgdGhpc1snJHBhcmVudENvbnRleHQnXSA9IHBhcmVudEJpbmRpbmdDb250ZXh0OwogICAgICAgICAgICB0aGlzWyckcGFyZW50J10gPSBwYXJlbnRCaW5kaW5nQ29udGV4dFsnJGRhdGEnXTsKICAgICAgICAgICAgdGhpc1snJHBhcmVudHMnXSA9IChwYXJlbnRCaW5kaW5nQ29udGV4dFsnJHBhcmVudHMnXSB8fCBbXSkuc2xpY2UoMCk7CiAgICAgICAgICAgIHRoaXNbJyRwYXJlbnRzJ10udW5zaGlmdCh0aGlzWyckcGFyZW50J10pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXNbJyRwYXJlbnRzJ10gPSBbXTsKICAgICAgICAgICAgdGhpc1snJHJvb3QnXSA9IGRhdGFJdGVtOwogICAgICAgICAgICAvLyBFeHBvcnQgJ2tvJyBpbiB0aGUgYmluZGluZyBjb250ZXh0IHNvIGl0IHdpbGwgYmUgYXZhaWxhYmxlIGluIGJpbmRpbmdzIGFuZCB0ZW1wbGF0ZXMKICAgICAgICAgICAgLy8gZXZlbiBpZiAna28nIGlzbid0IGV4cG9ydGVkIGFzIGEgZ2xvYmFsLCBzdWNoIGFzIHdoZW4gdXNpbmcgYW4gQU1EIGxvYWRlci4KICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvNDkwCiAgICAgICAgICAgIHRoaXNbJ2tvJ10gPSBrbzsKICAgICAgICB9CiAgICAgICAgdGhpc1snJGRhdGEnXSA9IGRhdGFJdGVtOwogICAgICAgIGlmIChkYXRhSXRlbUFsaWFzKQogICAgICAgICAgICB0aGlzW2RhdGFJdGVtQWxpYXNdID0gZGF0YUl0ZW07CiAgICB9CiAgICBrby5iaW5kaW5nQ29udGV4dC5wcm90b3R5cGVbJ2NyZWF0ZUNoaWxkQ29udGV4dCddID0gZnVuY3Rpb24gKGRhdGFJdGVtLCBkYXRhSXRlbUFsaWFzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBrby5iaW5kaW5nQ29udGV4dChkYXRhSXRlbSwgdGhpcywgZGF0YUl0ZW1BbGlhcyk7CiAgICB9OwogICAga28uYmluZGluZ0NvbnRleHQucHJvdG90eXBlWydleHRlbmQnXSA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpIHsKICAgICAgICB2YXIgY2xvbmUgPSBrby51dGlscy5leHRlbmQobmV3IGtvLmJpbmRpbmdDb250ZXh0KCksIHRoaXMpOwogICAgICAgIHJldHVybiBrby51dGlscy5leHRlbmQoY2xvbmUsIHByb3BlcnRpZXMpOwogICAgfTsKCiAgICBmdW5jdGlvbiB2YWxpZGF0ZVRoYXRCaW5kaW5nSXNBbGxvd2VkRm9yVmlydHVhbEVsZW1lbnRzKGJpbmRpbmdOYW1lKSB7CiAgICAgICAgdmFyIHZhbGlkYXRvciA9IGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbYmluZGluZ05hbWVdOwogICAgICAgIGlmICghdmFsaWRhdG9yKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBiaW5kaW5nICciICsgYmluZGluZ05hbWUgKyAiJyBjYW5ub3QgYmUgdXNlZCB3aXRoIHZpcnR1YWwgZWxlbWVudHMiKQogICAgfQoKICAgIGZ1bmN0aW9uIGFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzSW50ZXJuYWwgKHZpZXdNb2RlbCwgZWxlbWVudE9yVmlydHVhbEVsZW1lbnQsIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CiAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCwgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZChlbGVtZW50T3JWaXJ0dWFsRWxlbWVudCk7CiAgICAgICAgd2hpbGUgKGN1cnJlbnRDaGlsZCA9IG5leHRJblF1ZXVlKSB7CiAgICAgICAgICAgIC8vIEtlZXAgYSByZWNvcmQgb2YgdGhlIG5leHQgY2hpbGQgKmJlZm9yZSogYXBwbHlpbmcgYmluZGluZ3MsIGluIGNhc2UgdGhlIGJpbmRpbmcgcmVtb3ZlcyB0aGUgY3VycmVudCBjaGlsZCBmcm9tIGl0cyBwb3NpdGlvbgogICAgICAgICAgICBuZXh0SW5RdWV1ZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhjdXJyZW50Q2hpbGQpOwogICAgICAgICAgICBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIGN1cnJlbnRDaGlsZCwgYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCAodmlld01vZGVsLCBub2RlVmVyaWZpZWQsIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpIHsKICAgICAgICB2YXIgc2hvdWxkQmluZERlc2NlbmRhbnRzID0gdHJ1ZTsKCiAgICAgICAgLy8gUGVyZiBvcHRpbWlzYXRpb246IEFwcGx5IGJpbmRpbmdzIG9ubHkgaWYuLi4KICAgICAgICAvLyAoMSkgV2UgbmVlZCB0byBzdG9yZSB0aGUgYmluZGluZyBjb250ZXh0IG9uIHRoaXMgbm9kZSAoYmVjYXVzZSBpdCBtYXkgZGlmZmVyIGZyb20gdGhlIERPTSBwYXJlbnQgbm9kZSdzIGJpbmRpbmcgY29udGV4dCkKICAgICAgICAvLyAgICAgTm90ZSB0aGF0IHdlIGNhbid0IHN0b3JlIGJpbmRpbmcgY29udGV4dHMgb24gbm9uLWVsZW1lbnRzIChlLmcuLCB0ZXh0IG5vZGVzKSwgYXMgSUUgZG9lc24ndCBhbGxvdyBleHBhbmRvIHByb3BlcnRpZXMgZm9yIHRob3NlCiAgICAgICAgLy8gKDIpIEl0IG1pZ2h0IGhhdmUgYmluZGluZ3MgKGUuZy4sIGl0IGhhcyBhIGRhdGEtYmluZCBhdHRyaWJ1dGUsIG9yIGl0J3MgYSBtYXJrZXIgZm9yIGEgY29udGFpbmVybGVzcyB0ZW1wbGF0ZSkKICAgICAgICB2YXIgaXNFbGVtZW50ID0gKG5vZGVWZXJpZmllZC5ub2RlVHlwZSA9PT0gMSk7CiAgICAgICAgaWYgKGlzRWxlbWVudCkgLy8gV29ya2Fyb3VuZCBJRSA8PSA4IEhUTUwgcGFyc2luZyB3ZWlyZG5lc3MKICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLm5vcm1hbGlzZVZpcnR1YWxFbGVtZW50RG9tU3RydWN0dXJlKG5vZGVWZXJpZmllZCk7CgogICAgICAgIHZhciBzaG91bGRBcHBseUJpbmRpbmdzID0gKGlzRWxlbWVudCAmJiBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSAgICAgICAgICAgICAvLyBDYXNlICgxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfHwga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddWydub2RlSGFzQmluZGluZ3MnXShub2RlVmVyaWZpZWQpOyAgICAgICAvLyBDYXNlICgyKQogICAgICAgIGlmIChzaG91bGRBcHBseUJpbmRpbmdzKQogICAgICAgICAgICBzaG91bGRCaW5kRGVzY2VuZGFudHMgPSBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwobm9kZVZlcmlmaWVkLCBudWxsLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpLnNob3VsZEJpbmREZXNjZW5kYW50czsKCiAgICAgICAgaWYgKHNob3VsZEJpbmREZXNjZW5kYW50cykgewogICAgICAgICAgICAvLyBXZSdyZSByZWN1cnNpbmcgYXV0b21hdGljYWxseSBpbnRvIChyZWFsIG9yIHZpcnR1YWwpIGNoaWxkIG5vZGVzIHdpdGhvdXQgY2hhbmdpbmcgYmluZGluZyBjb250ZXh0cy4gU28sCiAgICAgICAgICAgIC8vICAqIEZvciBjaGlsZHJlbiBvZiBhICpyZWFsKiBlbGVtZW50LCB0aGUgYmluZGluZyBjb250ZXh0IGlzIGNlcnRhaW5seSB0aGUgc2FtZSBhcyBvbiB0aGVpciBET00gLnBhcmVudE5vZGUsCiAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIGZhbHNlCiAgICAgICAgICAgIC8vICAqIEZvciBjaGlsZHJlbiBvZiBhICp2aXJ0dWFsKiBlbGVtZW50LCB3ZSBjYW4ndCBiZSBzdXJlLiBFdmFsdWF0aW5nIC5wYXJlbnROb2RlIG9uIHRob3NlIGNoaWxkcmVuIG1heQogICAgICAgICAgICAvLyAgICBza2lwIG92ZXIgYW55IG51bWJlciBvZiBpbnRlcm1lZGlhdGUgdmlydHVhbCBlbGVtZW50cywgYW55IG9mIHdoaWNoIG1pZ2h0IGRlZmluZSBhIGN1c3RvbSBiaW5kaW5nIGNvbnRleHQsCiAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIHRydWUKICAgICAgICAgICAgYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIG5vZGVWZXJpZmllZCwgLyogYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQ6ICovICFpc0VsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwgKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0LCBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CiAgICAgICAgLy8gTmVlZCB0byBiZSBzdXJlIHRoYXQgaW5pdHMgYXJlIG9ubHkgcnVuIG9uY2UsIGFuZCB1cGRhdGVzIG5ldmVyIHJ1biB1bnRpbCBhbGwgdGhlIGluaXRzIGhhdmUgYmVlbiBydW4KICAgICAgICB2YXIgaW5pdFBoYXNlID0gMDsgLy8gMCA9IGJlZm9yZSBhbGwgaW5pdHMsIDEgPSBkdXJpbmcgaW5pdHMsIDIgPSBhZnRlciBhbGwgaW5pdHMKCiAgICAgICAgLy8gRWFjaCB0aW1lIHRoZSBkZXBlbmRlbnRPYnNlcnZhYmxlIGlzIGV2YWx1YXRlZCAoYWZ0ZXIgZGF0YSBjaGFuZ2VzKSwKICAgICAgICAvLyB0aGUgYmluZGluZyBhdHRyaWJ1dGUgaXMgcmVwYXJzZWQgc28gdGhhdCBpdCBjYW4gcGljayBvdXQgdGhlIGNvcnJlY3QKICAgICAgICAvLyBtb2RlbCBwcm9wZXJ0aWVzIGluIHRoZSBjb250ZXh0IG9mIHRoZSBjaGFuZ2VkIGRhdGEuCiAgICAgICAgLy8gRE9NIGV2ZW50IGNhbGxiYWNrcyBuZWVkIHRvIGJlIGFibGUgdG8gYWNjZXNzIHRoaXMgY2hhbmdlZCBkYXRhLAogICAgICAgIC8vIHNvIHdlIG5lZWQgYSBzaW5nbGUgcGFyc2VkQmluZGluZ3MgdmFyaWFibGUgKHNoYXJlZCBieSBhbGwgY2FsbGJhY2tzCiAgICAgICAgLy8gYXNzb2NpYXRlZCB3aXRoIHRoaXMgbm9kZSdzIGJpbmRpbmdzKSB0aGF0IGFsbCB0aGUgY2xvc3VyZXMgY2FuIGFjY2Vzcy4KICAgICAgICB2YXIgcGFyc2VkQmluZGluZ3M7CiAgICAgICAgZnVuY3Rpb24gbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgeyByZXR1cm4gcGFyc2VkQmluZGluZ3NbYmluZGluZ0tleV0gfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZWRCaW5kaW5nc0FjY2Vzc29yKCkgewogICAgICAgICAgICByZXR1cm4gcGFyc2VkQmluZGluZ3M7CiAgICAgICAgfQoKICAgICAgICB2YXIgYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3M7CiAgICAgICAga28uZGVwZW5kZW50T2JzZXJ2YWJsZSgKICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgYSBub25udWxsIGJpbmRpbmcgY29udGV4dCB0byB3b3JrIHdpdGgKICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nQ29udGV4dEluc3RhbmNlID0gdmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCAmJiAodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCBpbnN0YW5jZW9mIGtvLmJpbmRpbmdDb250ZXh0KQogICAgICAgICAgICAgICAgICAgID8gdmlld01vZGVsT3JCaW5kaW5nQ29udGV4dAogICAgICAgICAgICAgICAgICAgIDogbmV3IGtvLmJpbmRpbmdDb250ZXh0KGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCkpOwogICAgICAgICAgICAgICAgdmFyIHZpZXdNb2RlbCA9IGJpbmRpbmdDb250ZXh0SW5zdGFuY2VbJyRkYXRhJ107CgogICAgICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBEb24ndCBzdG9yZSB0aGUgYmluZGluZyBjb250ZXh0IG9uIHRoaXMgbm9kZSBpZiBpdCdzIGRlZmluaXRlbHkgdGhlIHNhbWUgYXMgb24gbm9kZS5wYXJlbnROb2RlLCBiZWNhdXNlCiAgICAgICAgICAgICAgICAvLyB3ZSBjYW4gZWFzaWx5IHJlY292ZXIgaXQganVzdCBieSBzY2FubmluZyB1cCB0aGUgbm9kZSdzIGFuY2VzdG9ycyBpbiB0aGUgRE9NCiAgICAgICAgICAgICAgICAvLyAobm90ZTogaGVyZSwgcGFyZW50IG5vZGUgbWVhbnMgInJlYWwgRE9NIHBhcmVudCIgbm90ICJ2aXJ0dWFsIHBhcmVudCIsIGFzIHRoZXJlJ3Mgbm8gTygxKSB3YXkgdG8gZmluZCB0aGUgdmlydHVhbCBwYXJlbnQpCiAgICAgICAgICAgICAgICBpZiAoYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkKICAgICAgICAgICAgICAgICAgICBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUobm9kZSwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CgogICAgICAgICAgICAgICAgLy8gVXNlIGV2YWx1YXRlZEJpbmRpbmdzIGlmIGdpdmVuLCBvdGhlcndpc2UgZmFsbCBiYWNrIG9uIGFza2luZyB0aGUgYmluZGluZ3MgcHJvdmlkZXIgdG8gZ2l2ZSB1cyBzb21lIGJpbmRpbmdzCiAgICAgICAgICAgICAgICB2YXIgZXZhbHVhdGVkQmluZGluZ3MgPSAodHlwZW9mIGJpbmRpbmdzID09ICJmdW5jdGlvbiIpID8gYmluZGluZ3MoYmluZGluZ0NvbnRleHRJbnN0YW5jZSwgbm9kZSkgOiBiaW5kaW5nczsKICAgICAgICAgICAgICAgIHBhcnNlZEJpbmRpbmdzID0gZXZhbHVhdGVkQmluZGluZ3MgfHwga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddWydnZXRCaW5kaW5ncyddKG5vZGUsIGJpbmRpbmdDb250ZXh0SW5zdGFuY2UpOwoKICAgICAgICAgICAgICAgIGlmIChwYXJzZWRCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgIC8vIEZpcnN0IHJ1biBhbGwgdGhlIGluaXRzLCBzbyBiaW5kaW5ncyBjYW4gcmVnaXN0ZXIgZm9yIG5vdGlmaWNhdGlvbiBvbiBjaGFuZ2VzCiAgICAgICAgICAgICAgICAgICAgaWYgKGluaXRQaGFzZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbml0UGhhc2UgPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBiaW5kaW5nS2V5IGluIHBhcnNlZEJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nICYmIG5vZGUubm9kZVR5cGUgPT09IDgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVUaGF0QmluZGluZ0lzQWxsb3dlZEZvclZpcnR1YWxFbGVtZW50cyhiaW5kaW5nS2V5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZyAmJiB0eXBlb2YgYmluZGluZ1siaW5pdCJdID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlckluaXRGbiA9IGJpbmRpbmdbImluaXQiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5pdFJlc3VsdCA9IGhhbmRsZXJJbml0Rm4obm9kZSwgbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSksIHBhcnNlZEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgYmluZGluZyBoYW5kbGVyIGNsYWltcyB0byBjb250cm9sIGRlc2NlbmRhbnQgYmluZGluZ3MsIG1ha2UgYSBub3RlIG9mIHRoaXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5pdFJlc3VsdCAmJiBpbml0UmVzdWx0Wydjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNdWx0aXBsZSBiaW5kaW5ncyAoIiArIGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzICsgIiBhbmQgIiArIGJpbmRpbmdLZXkgKyAiKSBhcmUgdHJ5aW5nIHRvIGNvbnRyb2wgZGVzY2VuZGFudCBiaW5kaW5ncyBvZiB0aGUgc2FtZSBlbGVtZW50LiBZb3UgY2Fubm90IHVzZSB0aGVzZSBiaW5kaW5ncyB0b2dldGhlciBvbiB0aGUgc2FtZSBlbGVtZW50LiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyA9IGJpbmRpbmdLZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRQaGFzZSA9IDI7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyAuLi4gdGhlbiBydW4gYWxsIHRoZSB1cGRhdGVzLCB3aGljaCBtaWdodCB0cmlnZ2VyIGNoYW5nZXMgZXZlbiBvbiB0aGUgZmlyc3QgZXZhbHVhdGlvbgogICAgICAgICAgICAgICAgICAgIGlmIChpbml0UGhhc2UgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgYmluZGluZ0tleSBpbiBwYXJzZWRCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBrby5iaW5kaW5nSGFuZGxlcnNbYmluZGluZ0tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZyAmJiB0eXBlb2YgYmluZGluZ1sidXBkYXRlIl0gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyVXBkYXRlRm4gPSBiaW5kaW5nWyJ1cGRhdGUiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyVXBkYXRlRm4obm9kZSwgbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSksIHBhcnNlZEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIDogbm9kZSB9CiAgICAgICAgKTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgc2hvdWxkQmluZERlc2NlbmRhbnRzOiBiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyA9PT0gdW5kZWZpbmVkCiAgICAgICAgfTsKICAgIH07CgogICAgdmFyIHN0b3JlZEJpbmRpbmdDb250ZXh0RG9tRGF0YUtleSA9ICJfX2tvX2JpbmRpbmdDb250ZXh0X18iOwogICAga28uc3RvcmVkQmluZGluZ0NvbnRleHRGb3JOb2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQobm9kZSwgc3RvcmVkQmluZGluZ0NvbnRleHREb21EYXRhS2V5LCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4ga28udXRpbHMuZG9tRGF0YS5nZXQobm9kZSwgc3RvcmVkQmluZGluZ0NvbnRleHREb21EYXRhS2V5KTsKICAgIH0KCiAgICBrby5hcHBseUJpbmRpbmdzVG9Ob2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWwpIHsKICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgLy8gSWYgaXQncyBhbiBlbGVtZW50LCB3b3JrYXJvdW5kIElFIDw9IDggSFRNTCBwYXJzaW5nIHdlaXJkbmVzcwogICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMubm9ybWFsaXNlVmlydHVhbEVsZW1lbnREb21TdHJ1Y3R1cmUobm9kZSk7CiAgICAgICAgcmV0dXJuIGFwcGx5QmluZGluZ3NUb05vZGVJbnRlcm5hbChub2RlLCBiaW5kaW5ncywgdmlld01vZGVsLCB0cnVlKTsKICAgIH07CgogICAga28uYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHMgPSBmdW5jdGlvbih2aWV3TW9kZWwsIHJvb3ROb2RlKSB7CiAgICAgICAgaWYgKHJvb3ROb2RlLm5vZGVUeXBlID09PSAxIHx8IHJvb3ROb2RlLm5vZGVUeXBlID09PSA4KQogICAgICAgICAgICBhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50c0ludGVybmFsKHZpZXdNb2RlbCwgcm9vdE5vZGUsIHRydWUpOwogICAgfTsKCiAgICBrby5hcHBseUJpbmRpbmdzID0gZnVuY3Rpb24gKHZpZXdNb2RlbCwgcm9vdE5vZGUpIHsKICAgICAgICBpZiAocm9vdE5vZGUgJiYgKHJvb3ROb2RlLm5vZGVUeXBlICE9PSAxKSAmJiAocm9vdE5vZGUubm9kZVR5cGUgIT09IDgpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImtvLmFwcGx5QmluZGluZ3M6IGZpcnN0IHBhcmFtZXRlciBzaG91bGQgYmUgeW91ciB2aWV3IG1vZGVsOyBzZWNvbmQgcGFyYW1ldGVyIHNob3VsZCBiZSBhIERPTSBub2RlIik7CiAgICAgICAgcm9vdE5vZGUgPSByb290Tm9kZSB8fCB3aW5kb3cuZG9jdW1lbnQuYm9keTsgLy8gTWFrZSAicm9vdE5vZGUiIHBhcmFtZXRlciBvcHRpb25hbAoKICAgICAgICBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIHJvb3ROb2RlLCB0cnVlKTsKICAgIH07CgogICAgLy8gUmV0cmlldmluZyBiaW5kaW5nIGNvbnRleHQgZnJvbSBhcmJpdHJhcnkgbm9kZXMKICAgIGtvLmNvbnRleHRGb3IgPSBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgLy8gV2UgY2FuIG9ubHkgZG8gc29tZXRoaW5nIG1lYW5pbmdmdWwgZm9yIGVsZW1lbnRzIGFuZCBjb21tZW50IG5vZGVzIChpbiBwYXJ0aWN1bGFyLCBub3QgdGV4dCBub2RlcywgYXMgSUUgY2FuJ3Qgc3RvcmUgZG9tZGF0YSBmb3IgdGhlbSkKICAgICAgICBzd2l0Y2ggKG5vZGUubm9kZVR5cGUpIHsKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IGtvLnN0b3JlZEJpbmRpbmdDb250ZXh0Rm9yTm9kZShub2RlKTsKICAgICAgICAgICAgICAgIGlmIChjb250ZXh0KSByZXR1cm4gY29udGV4dDsKICAgICAgICAgICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpIHJldHVybiBrby5jb250ZXh0Rm9yKG5vZGUucGFyZW50Tm9kZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH07CiAgICBrby5kYXRhRm9yID0gZnVuY3Rpb24obm9kZSkgewogICAgICAgIHZhciBjb250ZXh0ID0ga28uY29udGV4dEZvcihub2RlKTsKICAgICAgICByZXR1cm4gY29udGV4dCA/IGNvbnRleHRbJyRkYXRhJ10gOiB1bmRlZmluZWQ7CiAgICB9OwoKICAgIGtvLmV4cG9ydFN5bWJvbCgnYmluZGluZ0hhbmRsZXJzJywga28uYmluZGluZ0hhbmRsZXJzKTsKICAgIGtvLmV4cG9ydFN5bWJvbCgnYXBwbHlCaW5kaW5ncycsIGtvLmFwcGx5QmluZGluZ3MpOwogICAga28uZXhwb3J0U3ltYm9sKCdhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cycsIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzKTsKICAgIGtvLmV4cG9ydFN5bWJvbCgnYXBwbHlCaW5kaW5nc1RvTm9kZScsIGtvLmFwcGx5QmluZGluZ3NUb05vZGUpOwogICAga28uZXhwb3J0U3ltYm9sKCdjb250ZXh0Rm9yJywga28uY29udGV4dEZvcik7CiAgICBrby5leHBvcnRTeW1ib2woJ2RhdGFGb3InLCBrby5kYXRhRm9yKTsKfSkoKTsKdmFyIGF0dHJIdG1sVG9KYXZhc2NyaXB0TWFwID0geyAnY2xhc3MnOiAnY2xhc3NOYW1lJywgJ2Zvcic6ICdodG1sRm9yJyB9Owprby5iaW5kaW5nSGFuZGxlcnNbJ2F0dHInXSA9IHsKICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpIHx8IHt9OwogICAgICAgIGZvciAodmFyIGF0dHJOYW1lIGluIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXR0ck5hbWUgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHZhciBhdHRyVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlW2F0dHJOYW1lXSk7CgogICAgICAgICAgICAgICAgLy8gVG8gY292ZXIgY2FzZXMgbGlrZSAiYXR0cjogeyBjaGVja2VkOnNvbWVQcm9wIH0iLCB3ZSB3YW50IHRvIHJlbW92ZSB0aGUgYXR0cmlidXRlIGVudGlyZWx5CiAgICAgICAgICAgICAgICAvLyB3aGVuIHNvbWVQcm9wIGlzIGEgIm5vIHZhbHVlIi1saWtlIHZhbHVlIChzdHJpY3RseSBudWxsLCBmYWxzZSwgb3IgdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgLy8gKGJlY2F1c2UgdGhlIGFic2VuY2Ugb2YgdGhlICJjaGVja2VkIiBhdHRyIGlzIGhvdyB0byBtYXJrIGFuIGVsZW1lbnQgYXMgbm90IGNoZWNrZWQsIGV0Yy4pCiAgICAgICAgICAgICAgICB2YXIgdG9SZW1vdmUgPSAoYXR0clZhbHVlID09PSBmYWxzZSkgfHwgKGF0dHJWYWx1ZSA9PT0gbnVsbCkgfHwgKGF0dHJWYWx1ZSA9PT0gdW5kZWZpbmVkKTsKICAgICAgICAgICAgICAgIGlmICh0b1JlbW92ZSkKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShhdHRyTmFtZSk7CgogICAgICAgICAgICAgICAgLy8gSW4gSUUgPD0gNyBhbmQgSUU4IFF1aXJrcyBNb2RlLCB5b3UgaGF2ZSB0byB1c2UgdGhlIEphdmFzY3JpcHQgcHJvcGVydHkgbmFtZSBpbnN0ZWFkIG9mIHRoZQogICAgICAgICAgICAgICAgLy8gSFRNTCBhdHRyaWJ1dGUgbmFtZSBmb3IgY2VydGFpbiBhdHRyaWJ1dGVzLiBJRTggU3RhbmRhcmRzIE1vZGUgc3VwcG9ydHMgdGhlIGNvcnJlY3QgYmVoYXZpb3IsCiAgICAgICAgICAgICAgICAvLyBidXQgaW5zdGVhZCBvZiBmaWd1cmluZyBvdXQgdGhlIG1vZGUsIHdlJ2xsIGp1c3Qgc2V0IHRoZSBhdHRyaWJ1dGUgdGhyb3VnaCB0aGUgSmF2YXNjcmlwdAogICAgICAgICAgICAgICAgLy8gcHJvcGVydHkgZm9yIElFIDw9IDguCiAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuaWVWZXJzaW9uIDw9IDggJiYgYXR0ck5hbWUgaW4gYXR0ckh0bWxUb0phdmFzY3JpcHRNYXApIHsKICAgICAgICAgICAgICAgICAgICBhdHRyTmFtZSA9IGF0dHJIdG1sVG9KYXZhc2NyaXB0TWFwW2F0dHJOYW1lXTsKICAgICAgICAgICAgICAgICAgICBpZiAodG9SZW1vdmUpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGF0dHJOYW1lKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbYXR0ck5hbWVdID0gYXR0clZhbHVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdG9SZW1vdmUpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgYXR0clZhbHVlLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFRyZWF0ICJuYW1lIiBzcGVjaWFsbHkgLSBhbHRob3VnaCB5b3UgY2FuIHRoaW5rIG9mIGl0IGFzIGFuIGF0dHJpYnV0ZSwgaXQgYWxzbyBuZWVkcwogICAgICAgICAgICAgICAgLy8gc3BlY2lhbCBoYW5kbGluZyBvbiBvbGRlciB2ZXJzaW9ucyBvZiBJRSAoaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvMzMzKQogICAgICAgICAgICAgICAgLy8gRGVsaWJlcmF0ZWx5IGJlaW5nIGNhc2Utc2Vuc2l0aXZlIGhlcmUgYmVjYXVzZSBYSFRNTCB3b3VsZCByZWdhcmQgIk5hbWUiIGFzIGEgZGlmZmVyZW50IHRoaW5nCiAgICAgICAgICAgICAgICAvLyBlbnRpcmVseSwgYW5kIHRoZXJlJ3Mgbm8gc3Ryb25nIHJlYXNvbiB0byBhbGxvdyBmb3Igc3VjaCBjYXNpbmcgaW4gSFRNTC4KICAgICAgICAgICAgICAgIGlmIChhdHRyTmFtZSA9PT0gIm5hbWUiKSB7CiAgICAgICAgICAgICAgICAgICAga28udXRpbHMuc2V0RWxlbWVudE5hbWUoZWxlbWVudCwgdG9SZW1vdmUgPyAiIiA6IGF0dHJWYWx1ZS50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWydjaGVja2VkJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgdmFyIHVwZGF0ZUhhbmRsZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PSAiY2hlY2tib3giKSB7CiAgICAgICAgICAgICAgICB2YWx1ZVRvV3JpdGUgPSBlbGVtZW50LmNoZWNrZWQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKGVsZW1lbnQudHlwZSA9PSAicmFkaW8iKSAmJiAoZWxlbWVudC5jaGVja2VkKSkgewogICAgICAgICAgICAgICAgdmFsdWVUb1dyaXRlID0gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybjsgLy8gImNoZWNrZWQiIGJpbmRpbmcgb25seSByZXNwb25kcyB0byBjaGVja2JveGVzIGFuZCBzZWxlY3RlZCByYWRpbyBidXR0b25zCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLCB1bndyYXBwZWRWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobW9kZWxWYWx1ZSk7CiAgICAgICAgICAgIGlmICgoZWxlbWVudC50eXBlID09ICJjaGVja2JveCIpICYmICh1bndyYXBwZWRWYWx1ZSBpbnN0YW5jZW9mIEFycmF5KSkgewogICAgICAgICAgICAgICAgLy8gRm9yIGNoZWNrYm94ZXMgYm91bmQgdG8gYW4gYXJyYXksIHdlIGFkZC9yZW1vdmUgdGhlIGNoZWNrYm94IHZhbHVlIHRvIHRoYXQgYXJyYXkKICAgICAgICAgICAgICAgIC8vIFRoaXMgd29ya3MgZm9yIGJvdGggb2JzZXJ2YWJsZSBhbmQgbm9uLW9ic2VydmFibGUgYXJyYXlzCiAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmdFbnRyeUluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKHVud3JhcHBlZFZhbHVlLCBlbGVtZW50LnZhbHVlKTsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LmNoZWNrZWQgJiYgKGV4aXN0aW5nRW50cnlJbmRleCA8IDApKQogICAgICAgICAgICAgICAgICAgIG1vZGVsVmFsdWUucHVzaChlbGVtZW50LnZhbHVlKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKCghZWxlbWVudC5jaGVja2VkKSAmJiAoZXhpc3RpbmdFbnRyeUluZGV4ID49IDApKQogICAgICAgICAgICAgICAgICAgIG1vZGVsVmFsdWUuc3BsaWNlKGV4aXN0aW5nRW50cnlJbmRleCwgMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzQWNjZXNzb3IsICdjaGVja2VkJywgdmFsdWVUb1dyaXRlLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImNsaWNrIiwgdXBkYXRlSGFuZGxlcik7CgogICAgICAgIC8vIElFIDYgd29uJ3QgYWxsb3cgcmFkaW8gYnV0dG9ucyB0byBiZSBzZWxlY3RlZCB1bmxlc3MgdGhleSBoYXZlIGEgbmFtZQogICAgICAgIGlmICgoZWxlbWVudC50eXBlID09ICJyYWRpbyIpICYmICFlbGVtZW50Lm5hbWUpCiAgICAgICAgICAgIGtvLmJpbmRpbmdIYW5kbGVyc1sndW5pcXVlTmFtZSddWydpbml0J10oZWxlbWVudCwgZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlIH0pOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCiAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PSAiY2hlY2tib3giKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAvLyBXaGVuIGJvdW5kIHRvIGFuIGFycmF5LCB0aGUgY2hlY2tib3ggYmVpbmcgY2hlY2tlZCByZXByZXNlbnRzIGl0cyB2YWx1ZSBiZWluZyBwcmVzZW50IGluIHRoYXQgYXJyYXkKICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZih2YWx1ZSwgZWxlbWVudC52YWx1ZSkgPj0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFdoZW4gYm91bmQgdG8gYW55dGhpbmcgb3RoZXIgdmFsdWUgKG5vdCBhbiBhcnJheSksIHRoZSBjaGVja2JveCBiZWluZyBjaGVja2VkIHJlcHJlc2VudHMgdGhlIHZhbHVlIGJlaW5nIHRydWVpc2gKICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50LnR5cGUgPT0gInJhZGlvIikgewogICAgICAgICAgICBlbGVtZW50LmNoZWNrZWQgPSAoZWxlbWVudC52YWx1ZSA9PSB2YWx1ZSk7CiAgICAgICAgfQogICAgfQp9Owp2YXIgY2xhc3Nlc1dyaXR0ZW5CeUJpbmRpbmdLZXkgPSAnX19rb19fY3NzVmFsdWUnOwprby5iaW5kaW5nSGFuZGxlcnNbJ2NzcyddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgZm9yICh2YXIgY2xhc3NOYW1lIGluIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgc2hvdWxkSGF2ZUNsYXNzID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZVtjbGFzc05hbWVdKTsKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUsIHNob3VsZEhhdmVDbGFzcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9IFN0cmluZyh2YWx1ZSB8fCAnJyk7IC8vIE1ha2Ugc3VyZSB3ZSBkb24ndCB0cnkgdG8gc3RvcmUgb3Igc2V0IGEgbm9uLXN0cmluZyB2YWx1ZQogICAgICAgICAgICBrby51dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MoZWxlbWVudCwgZWxlbWVudFtjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleV0sIGZhbHNlKTsKICAgICAgICAgICAgZWxlbWVudFtjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleV0gPSB2YWx1ZTsKICAgICAgICAgICAga28udXRpbHMudG9nZ2xlRG9tTm9kZUNzc0NsYXNzKGVsZW1lbnQsIHZhbHVlLCB0cnVlKTsKICAgICAgICB9CiAgICB9Cn07CmtvLmJpbmRpbmdIYW5kbGVyc1snZW5hYmxlJ10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgaWYgKHZhbHVlICYmIGVsZW1lbnQuZGlzYWJsZWQpCiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCJkaXNhYmxlZCIpOwogICAgICAgIGVsc2UgaWYgKCghdmFsdWUpICYmICghZWxlbWVudC5kaXNhYmxlZCkpCiAgICAgICAgICAgIGVsZW1lbnQuZGlzYWJsZWQgPSB0cnVlOwogICAgfQp9OwoKa28uYmluZGluZ0hhbmRsZXJzWydkaXNhYmxlJ10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBrby5iaW5kaW5nSGFuZGxlcnNbJ2VuYWJsZSddWyd1cGRhdGUnXShlbGVtZW50LCBmdW5jdGlvbigpIHsgcmV0dXJuICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSkgfSk7CiAgICB9Cn07Ci8vIEZvciBjZXJ0YWluIGNvbW1vbiBldmVudHMgKGN1cnJlbnRseSBqdXN0ICdjbGljaycpLCBhbGxvdyBhIHNpbXBsaWZpZWQgZGF0YS1iaW5kaW5nIHN5bnRheAovLyBlLmcuIGNsaWNrOmhhbmRsZXIgaW5zdGVhZCBvZiB0aGUgdXN1YWwgZnVsbC1sZW5ndGggZXZlbnQ6e2NsaWNrOmhhbmRsZXJ9CmZ1bmN0aW9uIG1ha2VFdmVudEhhbmRsZXJTaG9ydGN1dChldmVudE5hbWUpIHsKICAgIGtvLmJpbmRpbmdIYW5kbGVyc1tldmVudE5hbWVdID0gewogICAgICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsKSB7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZUFjY2Vzc29yID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgcmVzdWx0W2V2ZW50TmFtZV0gPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWydldmVudCddWydpbml0J10uY2FsbCh0aGlzLCBlbGVtZW50LCBuZXdWYWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwpOwogICAgICAgIH0KICAgIH0KfQoKa28uYmluZGluZ0hhbmRsZXJzWydldmVudCddID0gewogICAgJ2luaXQnIDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCkgewogICAgICAgIHZhciBldmVudHNUb0hhbmRsZSA9IHZhbHVlQWNjZXNzb3IoKSB8fCB7fTsKICAgICAgICBmb3IodmFyIGV2ZW50TmFtZU91dHNpZGVDbG9zdXJlIGluIGV2ZW50c1RvSGFuZGxlKSB7CiAgICAgICAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBldmVudE5hbWVPdXRzaWRlQ2xvc3VyZTsgLy8gU2VwYXJhdGUgdmFyaWFibGUgdG8gYmUgY2FwdHVyZWQgYnkgZXZlbnQgaGFuZGxlciBjbG9zdXJlCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGV2ZW50TmFtZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50TmFtZSwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyUmV0dXJuVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyRnVuY3Rpb24gPSB2YWx1ZUFjY2Vzc29yKClbZXZlbnROYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFoYW5kbGVyRnVuY3Rpb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhbGxCaW5kaW5ncyA9IGFsbEJpbmRpbmdzQWNjZXNzb3IoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUYWtlIGFsbCB0aGUgZXZlbnQgYXJncywgYW5kIHByZWZpeCB3aXRoIHRoZSB2aWV3bW9kZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzRm9ySGFuZGxlciA9IGtvLnV0aWxzLm1ha2VBcnJheShhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnc0ZvckhhbmRsZXIudW5zaGlmdCh2aWV3TW9kZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlclJldHVyblZhbHVlID0gaGFuZGxlckZ1bmN0aW9uLmFwcGx5KHZpZXdNb2RlbCwgYXJnc0ZvckhhbmRsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXJSZXR1cm5WYWx1ZSAhPT0gdHJ1ZSkgeyAvLyBOb3JtYWxseSB3ZSB3YW50IHRvIHByZXZlbnQgZGVmYXVsdCBhY3Rpb24uIERldmVsb3BlciBjYW4gb3ZlcnJpZGUgdGhpcyBiZSBleHBsaWNpdGx5IHJldHVybmluZyB0cnVlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBidWJibGUgPSBhbGxCaW5kaW5nc1tldmVudE5hbWUgKyAnQnViYmxlJ10gIT09IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWJ1YmJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkoKTsKICAgICAgICB9CiAgICB9Cn07Ci8vICJmb3JlYWNoOiBzb21lRXhwcmVzc2lvbiIgaXMgZXF1aXZhbGVudCB0byAidGVtcGxhdGU6IHsgZm9yZWFjaDogc29tZUV4cHJlc3Npb24gfSIKLy8gImZvcmVhY2g6IHsgZGF0YTogc29tZUV4cHJlc3Npb24sIGFmdGVyQWRkOiBteWZuIH0iIGlzIGVxdWl2YWxlbnQgdG8gInRlbXBsYXRlOiB7IGZvcmVhY2g6IHNvbWVFeHByZXNzaW9uLCBhZnRlckFkZDogbXlmbiB9Igprby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXSA9IHsKICAgIG1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3I6IGZ1bmN0aW9uKHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLAogICAgICAgICAgICAgICAgdW53cmFwcGVkVmFsdWUgPSBrby51dGlscy5wZWVrT2JzZXJ2YWJsZShtb2RlbFZhbHVlKTsgICAgLy8gVW53cmFwIHdpdGhvdXQgc2V0dGluZyBhIGRlcGVuZGVuY3kgaGVyZQoKICAgICAgICAgICAgLy8gSWYgdW53cmFwcGVkVmFsdWUgaXMgdGhlIGFycmF5LCBwYXNzIGluIHRoZSB3cmFwcGVkIHZhbHVlIG9uIGl0cyBvd24KICAgICAgICAgICAgLy8gVGhlIHZhbHVlIHdpbGwgYmUgdW53cmFwcGVkIGFuZCB0cmFja2VkIHdpdGhpbiB0aGUgdGVtcGxhdGUgYmluZGluZwogICAgICAgICAgICAvLyAoU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvNTIzKQogICAgICAgICAgICBpZiAoKCF1bndyYXBwZWRWYWx1ZSkgfHwgdHlwZW9mIHVud3JhcHBlZFZhbHVlLmxlbmd0aCA9PSAibnVtYmVyIikKICAgICAgICAgICAgICAgIHJldHVybiB7ICdmb3JlYWNoJzogbW9kZWxWYWx1ZSwgJ3RlbXBsYXRlRW5naW5lJzoga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UgfTsKCiAgICAgICAgICAgIC8vIElmIHVud3JhcHBlZFZhbHVlLmRhdGEgaXMgdGhlIGFycmF5LCBwcmVzZXJ2ZSBhbGwgcmVsZXZhbnQgb3B0aW9ucyBhbmQgdW53cmFwIGFnYWluIHZhbHVlIHNvIHdlIGdldCB1cGRhdGVzCiAgICAgICAgICAgIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobW9kZWxWYWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAnZm9yZWFjaCc6IHVud3JhcHBlZFZhbHVlWydkYXRhJ10sCiAgICAgICAgICAgICAgICAnYXMnOiB1bndyYXBwZWRWYWx1ZVsnYXMnXSwKICAgICAgICAgICAgICAgICdpbmNsdWRlRGVzdHJveWVkJzogdW53cmFwcGVkVmFsdWVbJ2luY2x1ZGVEZXN0cm95ZWQnXSwKICAgICAgICAgICAgICAgICdhZnRlckFkZCc6IHVud3JhcHBlZFZhbHVlWydhZnRlckFkZCddLAogICAgICAgICAgICAgICAgJ2JlZm9yZVJlbW92ZSc6IHVud3JhcHBlZFZhbHVlWydiZWZvcmVSZW1vdmUnXSwKICAgICAgICAgICAgICAgICdhZnRlclJlbmRlcic6IHVud3JhcHBlZFZhbHVlWydhZnRlclJlbmRlciddLAogICAgICAgICAgICAgICAgJ2JlZm9yZU1vdmUnOiB1bndyYXBwZWRWYWx1ZVsnYmVmb3JlTW92ZSddLAogICAgICAgICAgICAgICAgJ2FmdGVyTW92ZSc6IHVud3JhcHBlZFZhbHVlWydhZnRlck1vdmUnXSwKICAgICAgICAgICAgICAgICd0ZW1wbGF0ZUVuZ2luZSc6IGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLmluc3RhbmNlCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0sCiAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWydpbml0J10oZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzWydmb3JlYWNoJ10ubWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3Nvcih2YWx1ZUFjY2Vzc29yKSk7CiAgICB9LAogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWyd1cGRhdGUnXShlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KTsKICAgIH0KfTsKa28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnNbJ2ZvcmVhY2gnXSA9IGZhbHNlOyAvLyBDYW4ndCByZXdyaXRlIGNvbnRyb2wgZmxvdyBiaW5kaW5ncwprby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWydmb3JlYWNoJ10gPSB0cnVlOwp2YXIgaGFzZm9jdXNVcGRhdGluZ1Byb3BlcnR5ID0gJ19fa29faGFzZm9jdXNVcGRhdGluZyc7CmtvLmJpbmRpbmdIYW5kbGVyc1snaGFzZm9jdXMnXSA9IHsKICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIHZhciBoYW5kbGVFbGVtZW50Rm9jdXNDaGFuZ2UgPSBmdW5jdGlvbihpc0ZvY3VzZWQpIHsKICAgICAgICAgICAgLy8gV2hlcmUgcG9zc2libGUsIGlnbm9yZSB3aGljaCBldmVudCB3YXMgcmFpc2VkIGFuZCBkZXRlcm1pbmUgZm9jdXMgc3RhdGUgdXNpbmcgYWN0aXZlRWxlbWVudCwKICAgICAgICAgICAgLy8gYXMgdGhpcyBhdm9pZHMgcGhhbnRvbSBmb2N1cy9ibHVyIGV2ZW50cyByYWlzZWQgd2hlbiBjaGFuZ2luZyB0YWJzIGluIG1vZGVybiBicm93c2Vycy4KICAgICAgICAgICAgLy8gSG93ZXZlciwgbm90IGFsbCBLTy10YXJnZXRlZCBicm93c2VycyAoRmlyZWZveCAyKSBzdXBwb3J0IGFjdGl2ZUVsZW1lbnQuIEZvciB0aG9zZSBicm93c2VycywKICAgICAgICAgICAgLy8gcHJldmVudCBhIGxvc3Mgb2YgZm9jdXMgd2hlbiBjaGFuZ2luZyB0YWJzL3dpbmRvd3MgYnkgc2V0dGluZyBhIGZsYWcgdGhhdCBwcmV2ZW50cyBoYXNmb2N1cwogICAgICAgICAgICAvLyBmcm9tIGNhbGxpbmcgJ2JsdXIoKScgb24gdGhlIGVsZW1lbnQgd2hlbiBpdCBsb3NlcyBmb2N1cy4KICAgICAgICAgICAgLy8gRGlzY3Vzc2lvbiBhdCBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvcHVsbC8zNTIKICAgICAgICAgICAgZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIG93bmVyRG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50OwogICAgICAgICAgICBpZiAoImFjdGl2ZUVsZW1lbnQiIGluIG93bmVyRG9jKSB7CiAgICAgICAgICAgICAgICBpc0ZvY3VzZWQgPSAob3duZXJEb2MuYWN0aXZlRWxlbWVudCA9PT0gZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkobW9kZWxWYWx1ZSwgYWxsQmluZGluZ3NBY2Nlc3NvciwgJ2hhc2ZvY3VzJywgaXNGb2N1c2VkLCB0cnVlKTsKICAgICAgICAgICAgZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldID0gZmFsc2U7CiAgICAgICAgfTsKICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzSW4gPSBoYW5kbGVFbGVtZW50Rm9jdXNDaGFuZ2UuYmluZChudWxsLCB0cnVlKTsKICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzT3V0ID0gaGFuZGxlRWxlbWVudEZvY3VzQ2hhbmdlLmJpbmQobnVsbCwgZmFsc2UpOwoKICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiZm9jdXMiLCBoYW5kbGVFbGVtZW50Rm9jdXNJbik7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3VzaW4iLCBoYW5kbGVFbGVtZW50Rm9jdXNJbik7IC8vIEZvciBJRQogICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJibHVyIiwgIGhhbmRsZUVsZW1lbnRGb2N1c091dCk7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3Vzb3V0IiwgIGhhbmRsZUVsZW1lbnRGb2N1c091dCk7IC8vIEZvciBJRQogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIGlmICghZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldKSB7CiAgICAgICAgICAgIHZhbHVlID8gZWxlbWVudC5mb2N1cygpIDogZWxlbWVudC5ibHVyKCk7CiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsIHZhbHVlID8gImZvY3VzaW4iIDogImZvY3Vzb3V0Il0pOyAvLyBGb3IgSUUsIHdoaWNoIGRvZXNuJ3QgcmVsaWFibHkgZmlyZSAiZm9jdXMiIG9yICJibHVyIiBldmVudHMgc3luY2hyb25vdXNseQogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWydodG1sJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIFByZXZlbnQgYmluZGluZyBvbiB0aGUgZHluYW1pY2FsbHktaW5qZWN0ZWQgSFRNTCAoYXMgZGV2ZWxvcGVycyBhcmUgdW5saWtlbHkgdG8gZXhwZWN0IHRoYXQsIGFuZCBpdCBoYXMgc2VjdXJpdHkgaW1wbGljYXRpb25zKQogICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICAvLyBzZXRIdG1sIHdpbGwgdW53cmFwIHRoZSB2YWx1ZSBpZiBuZWVkZWQKICAgICAgICBrby51dGlscy5zZXRIdG1sKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IoKSk7CiAgICB9Cn07CnZhciB3aXRoSWZEb21EYXRhS2V5ID0gJ19fa29fd2l0aElmQmluZGluZ0RhdGEnOwovLyBNYWtlcyBhIGJpbmRpbmcgbGlrZSB3aXRoIG9yIGlmCmZ1bmN0aW9uIG1ha2VXaXRoSWZCaW5kaW5nKGJpbmRpbmdLZXksIGlzV2l0aCwgaXNOb3QsIG1ha2VDb250ZXh0Q2FsbGJhY2spIHsKICAgIGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XSA9IHsKICAgICAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQoZWxlbWVudCwgd2l0aElmRG9tRGF0YUtleSwge30pOwogICAgICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CiAgICAgICAgfSwKICAgICAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICB2YXIgd2l0aElmRGF0YSA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIHdpdGhJZkRvbURhdGFLZXkpLAogICAgICAgICAgICAgICAgZGF0YVZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpLAogICAgICAgICAgICAgICAgc2hvdWxkRGlzcGxheSA9ICFpc05vdCAhPT0gIWRhdGFWYWx1ZSwgLy8gZXF1aXZhbGVudCB0byBpc05vdCA/ICFkYXRhVmFsdWUgOiAhIWRhdGFWYWx1ZQogICAgICAgICAgICAgICAgaXNGaXJzdFJlbmRlciA9ICF3aXRoSWZEYXRhLnNhdmVkTm9kZXMsCiAgICAgICAgICAgICAgICBuZWVkc1JlZnJlc2ggPSBpc0ZpcnN0UmVuZGVyIHx8IGlzV2l0aCB8fCAoc2hvdWxkRGlzcGxheSAhPT0gd2l0aElmRGF0YS5kaWREaXNwbGF5T25MYXN0VXBkYXRlKTsKCiAgICAgICAgICAgIGlmIChuZWVkc1JlZnJlc2gpIHsKICAgICAgICAgICAgICAgIGlmIChpc0ZpcnN0UmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgd2l0aElmRGF0YS5zYXZlZE5vZGVzID0ga28udXRpbHMuY2xvbmVOb2Rlcyhrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2RlcyhlbGVtZW50KSwgdHJ1ZSAvKiBzaG91bGRDbGVhbk5vZGVzICovKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkRGlzcGxheSkgewogICAgICAgICAgICAgICAgICAgIGlmICghaXNGaXJzdFJlbmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuKGVsZW1lbnQsIGtvLnV0aWxzLmNsb25lTm9kZXMod2l0aElmRGF0YS5zYXZlZE5vZGVzKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzKG1ha2VDb250ZXh0Q2FsbGJhY2sgPyBtYWtlQ29udGV4dENhbGxiYWNrKGJpbmRpbmdDb250ZXh0LCBkYXRhVmFsdWUpIDogYmluZGluZ0NvbnRleHQsIGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHdpdGhJZkRhdGEuZGlkRGlzcGxheU9uTGFzdFVwZGF0ZSA9IHNob3VsZERpc3BsYXk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAga28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnNbYmluZGluZ0tleV0gPSBmYWxzZTsgLy8gQ2FuJ3QgcmV3cml0ZSBjb250cm9sIGZsb3cgYmluZGluZ3MKICAgIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbYmluZGluZ0tleV0gPSB0cnVlOwp9CgovLyBDb25zdHJ1Y3QgdGhlIGFjdHVhbCBiaW5kaW5nIGhhbmRsZXJzCm1ha2VXaXRoSWZCaW5kaW5nKCdpZicpOwptYWtlV2l0aElmQmluZGluZygnaWZub3QnLCBmYWxzZSAvKiBpc1dpdGggKi8sIHRydWUgLyogaXNOb3QgKi8pOwptYWtlV2l0aElmQmluZGluZygnd2l0aCcsIHRydWUgLyogaXNXaXRoICovLCBmYWxzZSAvKiBpc05vdCAqLywKICAgIGZ1bmN0aW9uKGJpbmRpbmdDb250ZXh0LCBkYXRhVmFsdWUpIHsKICAgICAgICByZXR1cm4gYmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGRhdGFWYWx1ZSk7CiAgICB9Cik7CmZ1bmN0aW9uIGVuc3VyZURyb3Bkb3duU2VsZWN0aW9uSXNDb25zaXN0ZW50V2l0aE1vZGVsVmFsdWUoZWxlbWVudCwgbW9kZWxWYWx1ZSwgcHJlZmVyTW9kZWxWYWx1ZSkgewogICAgaWYgKHByZWZlck1vZGVsVmFsdWUpIHsKICAgICAgICBpZiAobW9kZWxWYWx1ZSAhPT0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCkpCiAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBtb2RlbFZhbHVlKTsKICAgIH0KCiAgICAvLyBObyBtYXR0ZXIgd2hpY2ggZGlyZWN0aW9uIHdlJ3JlIHN5bmNpbmcgaW4sIHdlIHdhbnQgdGhlIGVuZCByZXN1bHQgdG8gYmUgZXF1YWxpdHkgYmV0d2VlbiBkcm9wZG93biB2YWx1ZSBhbmQgbW9kZWwgdmFsdWUuCiAgICAvLyBJZiB0aGV5IGFyZW4ndCBlcXVhbCwgZWl0aGVyIHdlIHByZWZlciB0aGUgZHJvcGRvd24gdmFsdWUsIG9yIHRoZSBtb2RlbCB2YWx1ZSBjb3VsZG4ndCBiZSByZXByZXNlbnRlZCwgc28gZWl0aGVyIHdheSwKICAgIC8vIGNoYW5nZSB0aGUgbW9kZWwgdmFsdWUgdG8gbWF0Y2ggdGhlIGRyb3Bkb3duLgogICAgaWYgKG1vZGVsVmFsdWUgIT09IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpKQogICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsICJjaGFuZ2UiXSk7Cn07Cgprby5iaW5kaW5nSGFuZGxlcnNbJ29wdGlvbnMnXSA9IHsKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIGlmIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT09ICJzZWxlY3QiKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIm9wdGlvbnMgYmluZGluZyBhcHBsaWVzIG9ubHkgdG8gU0VMRUNUIGVsZW1lbnRzIik7CgogICAgICAgIHZhciBzZWxlY3RXYXNQcmV2aW91c2x5RW1wdHkgPSBlbGVtZW50Lmxlbmd0aCA9PSAwOwogICAgICAgIHZhciBwcmV2aW91c1NlbGVjdGVkVmFsdWVzID0ga28udXRpbHMuYXJyYXlNYXAoa28udXRpbHMuYXJyYXlGaWx0ZXIoZWxlbWVudC5jaGlsZE5vZGVzLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZS50YWdOYW1lICYmIChrby51dGlscy50YWdOYW1lTG93ZXIobm9kZSkgPT09ICJvcHRpb24iKSAmJiBub2RlLnNlbGVjdGVkOwogICAgICAgIH0pLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUobm9kZSkgfHwgbm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudDsKICAgICAgICB9KTsKICAgICAgICB2YXIgcHJldmlvdXNTY3JvbGxUb3AgPSBlbGVtZW50LnNjcm9sbFRvcDsKCiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBzZWxlY3RlZFZhbHVlID0gZWxlbWVudC52YWx1ZTsKCiAgICAgICAgLy8gUmVtb3ZlIGFsbCBleGlzdGluZyA8b3B0aW9uPnMuCiAgICAgICAgLy8gTmVlZCB0byB1c2UgLnJlbW92ZSgpIHJhdGhlciB0aGFuIC5yZW1vdmVDaGlsZCgpIGZvciA8b3B0aW9uPnMgb3RoZXJ3aXNlIElFIGJlaGF2ZXMgb2RkbHkgKGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTM0KQogICAgICAgIHdoaWxlIChlbGVtZW50Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAga28uY2xlYW5Ob2RlKGVsZW1lbnQub3B0aW9uc1swXSk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlKDApOwogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBhbGxCaW5kaW5ncyA9IGFsbEJpbmRpbmdzQWNjZXNzb3IoKSwKICAgICAgICAgICAgICAgIGluY2x1ZGVEZXN0cm95ZWQgPSBhbGxCaW5kaW5nc1snb3B0aW9uc0luY2x1ZGVEZXN0cm95ZWQnXTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUubGVuZ3RoICE9ICJudW1iZXIiKQogICAgICAgICAgICAgICAgdmFsdWUgPSBbdmFsdWVdOwogICAgICAgICAgICBpZiAoYWxsQmluZGluZ3NbJ29wdGlvbnNDYXB0aW9uJ10pIHsKICAgICAgICAgICAgICAgIHZhciBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKTsKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldEh0bWwob3B0aW9uLCBhbGxCaW5kaW5nc1snb3B0aW9uc0NhcHRpb24nXSk7CiAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUob3B0aW9uLCB1bmRlZmluZWQpOwogICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChvcHRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IHZhbHVlLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgLy8gU2tpcCBkZXN0cm95ZWQgaXRlbXMKICAgICAgICAgICAgICAgIHZhciBhcnJheUVudHJ5ID0gdmFsdWVbaV07CiAgICAgICAgICAgICAgICBpZiAoYXJyYXlFbnRyeSAmJiBhcnJheUVudHJ5WydfZGVzdHJveSddICYmICFpbmNsdWRlRGVzdHJveWVkKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIHZhciBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKTsKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhcHBseVRvT2JqZWN0KG9iamVjdCwgcHJlZGljYXRlLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJlZGljYXRlVHlwZSA9IHR5cGVvZiBwcmVkaWNhdGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZVR5cGUgPT0gImZ1bmN0aW9uIikgICAgLy8gR2l2ZW4gYSBmdW5jdGlvbjsgcnVuIGl0IGFnYWluc3QgdGhlIGRhdGEgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByZWRpY2F0ZShvYmplY3QpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHByZWRpY2F0ZVR5cGUgPT0gInN0cmluZyIpIC8vIEdpdmVuIGEgc3RyaW5nOyB0cmVhdCBpdCBhcyBhIHByb3BlcnR5IG5hbWUgb24gdGhlIGRhdGEgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdFtwcmVkaWNhdGVdOwogICAgICAgICAgICAgICAgICAgIGVsc2UgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdpdmVuIG5vIG9wdGlvbnNUZXh0IGFyZzsgdXNlIHRoZSBkYXRhIHZhbHVlIGl0c2VsZgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGEgdmFsdWUgdG8gdGhlIG9wdGlvbiBlbGVtZW50CiAgICAgICAgICAgICAgICB2YXIgb3B0aW9uVmFsdWUgPSBhcHBseVRvT2JqZWN0KGFycmF5RW50cnksIGFsbEJpbmRpbmdzWydvcHRpb25zVmFsdWUnXSwgYXJyYXlFbnRyeSk7CiAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUob3B0aW9uLCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9wdGlvblZhbHVlKSk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgc29tZSB0ZXh0IHRvIHRoZSBvcHRpb24gZWxlbWVudAogICAgICAgICAgICAgICAgdmFyIG9wdGlvblRleHQgPSBhcHBseVRvT2JqZWN0KGFycmF5RW50cnksIGFsbEJpbmRpbmdzWydvcHRpb25zVGV4dCddLCBvcHRpb25WYWx1ZSk7CiAgICAgICAgICAgICAgICBrby51dGlscy5zZXRUZXh0Q29udGVudChvcHRpb24sIG9wdGlvblRleHQpOwoKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQob3B0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSUU2IGRvZXNuJ3QgbGlrZSB1cyB0byBhc3NpZ24gc2VsZWN0aW9uIHRvIE9QVElPTiBub2RlcyBiZWZvcmUgdGhleSdyZSBhZGRlZCB0byB0aGUgZG9jdW1lbnQuCiAgICAgICAgICAgIC8vIFRoYXQncyB3aHkgd2UgZmlyc3QgYWRkZWQgdGhlbSB3aXRob3V0IHNlbGVjdGlvbi4gTm93IGl0J3MgdGltZSB0byBzZXQgdGhlIHNlbGVjdGlvbi4KICAgICAgICAgICAgdmFyIG5ld09wdGlvbnMgPSBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJvcHRpb24iKTsKICAgICAgICAgICAgdmFyIGNvdW50U2VsZWN0aW9uc1JldGFpbmVkID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBuZXdPcHRpb25zLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmFycmF5SW5kZXhPZihwcmV2aW91c1NlbGVjdGVkVmFsdWVzLCBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShuZXdPcHRpb25zW2ldKSkgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZShuZXdPcHRpb25zW2ldLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBjb3VudFNlbGVjdGlvbnNSZXRhaW5lZCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBlbGVtZW50LnNjcm9sbFRvcCA9IHByZXZpb3VzU2Nyb2xsVG9wOwoKICAgICAgICAgICAgaWYgKHNlbGVjdFdhc1ByZXZpb3VzbHlFbXB0eSAmJiAoJ3ZhbHVlJyBpbiBhbGxCaW5kaW5ncykpIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBjb25zaXN0ZW5jeSBiZXR3ZWVuIG1vZGVsIHZhbHVlIGFuZCBzZWxlY3RlZCBvcHRpb24uCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgZHJvcGRvd24gaXMgYmVpbmcgcG9wdWxhdGVkIGZvciB0aGUgZmlyc3QgdGltZSBoZXJlIChvciB3YXMgb3RoZXJ3aXNlIHByZXZpb3VzbHkgZW1wdHkpLAogICAgICAgICAgICAgICAgLy8gdGhlIGRyb3Bkb3duIHNlbGVjdGlvbiBzdGF0ZSBpcyBtZWFuaW5nbGVzcywgc28gd2UgcHJlc2VydmUgdGhlIG1vZGVsIHZhbHVlLgogICAgICAgICAgICAgICAgZW5zdXJlRHJvcGRvd25TZWxlY3Rpb25Jc0NvbnNpc3RlbnRXaXRoTW9kZWxWYWx1ZShlbGVtZW50LCBrby51dGlscy5wZWVrT2JzZXJ2YWJsZShhbGxCaW5kaW5nc1sndmFsdWUnXSksIC8qIHByZWZlck1vZGVsVmFsdWUgKi8gdHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIElFOSBidWcKICAgICAgICAgICAga28udXRpbHMuZW5zdXJlU2VsZWN0RWxlbWVudElzUmVuZGVyZWRDb3JyZWN0bHkoZWxlbWVudCk7CiAgICAgICAgfQogICAgfQp9Owprby5iaW5kaW5nSGFuZGxlcnNbJ29wdGlvbnMnXS5vcHRpb25WYWx1ZURvbURhdGFLZXkgPSAnX19rby5vcHRpb25WYWx1ZURvbURhdGFfXyc7CmtvLmJpbmRpbmdIYW5kbGVyc1snc2VsZWN0ZWRPcHRpb25zJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImNoYW5nZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLCB2YWx1ZVRvV3JpdGUgPSBbXTsKICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9wdGlvbiIpLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5zZWxlY3RlZCkKICAgICAgICAgICAgICAgICAgICB2YWx1ZVRvV3JpdGUucHVzaChrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShub2RlKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KHZhbHVlLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCAndmFsdWUnLCB2YWx1ZVRvV3JpdGUpOwogICAgICAgIH0pOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIGlmIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT0gInNlbGVjdCIpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidmFsdWVzIGJpbmRpbmcgYXBwbGllcyBvbmx5IHRvIFNFTEVDVCBlbGVtZW50cyIpOwoKICAgICAgICB2YXIgbmV3VmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgaWYgKG5ld1ZhbHVlICYmIHR5cGVvZiBuZXdWYWx1ZS5sZW5ndGggPT0gIm51bWJlciIpIHsKICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9wdGlvbiIpLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNTZWxlY3RlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihuZXdWYWx1ZSwga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUobm9kZSkpID49IDA7CiAgICAgICAgICAgICAgICBrby51dGlscy5zZXRPcHRpb25Ob2RlU2VsZWN0aW9uU3RhdGUobm9kZSwgaXNTZWxlY3RlZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWydzdHlsZSddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkgfHwge30pOwogICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiB2YWx1ZSkgewogICAgICAgICAgICBpZiAodHlwZW9mIHN0eWxlTmFtZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdmFyIHN0eWxlVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlW3N0eWxlTmFtZV0pOwogICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZVtzdHlsZU5hbWVdID0gc3R5bGVWYWx1ZSB8fCAiIjsgLy8gRW1wdHkgc3RyaW5nIHJlbW92ZXMgdGhlIHZhbHVlLCB3aGVyZWFzIG51bGwvdW5kZWZpbmVkIGhhdmUgbm8gZWZmZWN0CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn07CmtvLmJpbmRpbmdIYW5kbGVyc1snc3VibWl0J10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwpIHsKICAgICAgICBpZiAodHlwZW9mIHZhbHVlQWNjZXNzb3IoKSAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSB2YWx1ZSBmb3IgYSBzdWJtaXQgYmluZGluZyBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAic3VibWl0IiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBoYW5kbGVyUmV0dXJuVmFsdWU7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKICAgICAgICAgICAgdHJ5IHsgaGFuZGxlclJldHVyblZhbHVlID0gdmFsdWUuY2FsbCh2aWV3TW9kZWwsIGVsZW1lbnQpOyB9CiAgICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICAgICAgaWYgKGhhbmRsZXJSZXR1cm5WYWx1ZSAhPT0gdHJ1ZSkgeyAvLyBOb3JtYWxseSB3ZSB3YW50IHRvIHByZXZlbnQgZGVmYXVsdCBhY3Rpb24uIERldmVsb3BlciBjYW4gb3ZlcnJpZGUgdGhpcyBiZSBleHBsaWNpdGx5IHJldHVybmluZyB0cnVlLgogICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWyd0ZXh0J10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBrby51dGlscy5zZXRUZXh0Q29udGVudChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKCkpOwogICAgfQp9Owprby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWyd0ZXh0J10gPSB0cnVlOwprby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXSA9IHsKICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBpZiAodmFsdWVBY2Nlc3NvcigpKSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gImtvX3VuaXF1ZV8iICsgKCsra28uYmluZGluZ0hhbmRsZXJzWyd1bmlxdWVOYW1lJ10uY3VycmVudEluZGV4KTsKICAgICAgICAgICAga28udXRpbHMuc2V0RWxlbWVudE5hbWUoZWxlbWVudCwgbmFtZSk7CiAgICAgICAgfQogICAgfQp9Owprby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXS5jdXJyZW50SW5kZXggPSAwOwprby5iaW5kaW5nSGFuZGxlcnNbJ3ZhbHVlJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgLy8gQWx3YXlzIGNhdGNoICJjaGFuZ2UiIGV2ZW50OyBwb3NzaWJseSBvdGhlciBldmVudHMgdG9vIGlmIGFza2VkCiAgICAgICAgdmFyIGV2ZW50c1RvQ2F0Y2ggPSBbImNoYW5nZSJdOwogICAgICAgIHZhciByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoID0gYWxsQmluZGluZ3NBY2Nlc3NvcigpWyJ2YWx1ZVVwZGF0ZSJdOwogICAgICAgIHZhciBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IGZhbHNlOwogICAgICAgIGlmIChyZXF1ZXN0ZWRFdmVudHNUb0NhdGNoKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCA9PSAic3RyaW5nIikgLy8gQWxsb3cgYm90aCBpbmRpdmlkdWFsIGV2ZW50IG5hbWVzLCBhbmQgYXJyYXlzIG9mIGV2ZW50IG5hbWVzCiAgICAgICAgICAgICAgICByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoID0gW3JlcXVlc3RlZEV2ZW50c1RvQ2F0Y2hdOwogICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoZXZlbnRzVG9DYXRjaCwgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCk7CiAgICAgICAgICAgIGV2ZW50c1RvQ2F0Y2ggPSBrby51dGlscy5hcnJheUdldERpc3RpbmN0VmFsdWVzKGV2ZW50c1RvQ2F0Y2gpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHZhbHVlVXBkYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IGZhbHNlOwogICAgICAgICAgICB2YXIgbW9kZWxWYWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKICAgICAgICAgICAgdmFyIGVsZW1lbnRWYWx1ZSA9IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpOwogICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzQWNjZXNzb3IsICd2YWx1ZScsIGVsZW1lbnRWYWx1ZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzEyMgogICAgICAgIC8vIElFIGRvZXNuJ3QgZmlyZSAiY2hhbmdlIiBldmVudHMgb24gdGV4dGJveGVzIGlmIHRoZSB1c2VyIHNlbGVjdHMgYSB2YWx1ZSBmcm9tIGl0cyBhdXRvY29tcGxldGUgbGlzdAogICAgICAgIHZhciBpZUF1dG9Db21wbGV0ZUhhY2tOZWVkZWQgPSBrby51dGlscy5pZVZlcnNpb24gJiYgZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImlucHV0IiAmJiBlbGVtZW50LnR5cGUgPT0gInRleHQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIGVsZW1lbnQuYXV0b2NvbXBsZXRlICE9ICJvZmYiICYmICghZWxlbWVudC5mb3JtIHx8IGVsZW1lbnQuZm9ybS5hdXRvY29tcGxldGUgIT0gIm9mZiIpOwogICAgICAgIGlmIChpZUF1dG9Db21wbGV0ZUhhY2tOZWVkZWQgJiYga28udXRpbHMuYXJyYXlJbmRleE9mKGV2ZW50c1RvQ2F0Y2gsICJwcm9wZXJ0eWNoYW5nZSIpID09IC0xKSB7CiAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJwcm9wZXJ0eWNoYW5nZSIsIGZ1bmN0aW9uICgpIHsgcHJvcGVydHlDaGFuZ2VkRmlyZWQgPSB0cnVlIH0pOwogICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiYmx1ciIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5Q2hhbmdlZEZpcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWVVcGRhdGVIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGV2ZW50c1RvQ2F0Y2gsIGZ1bmN0aW9uKGV2ZW50TmFtZSkgewogICAgICAgICAgICAvLyBUaGUgc3ludGF4ICJhZnRlcjxldmVudG5hbWU+IiBtZWFucyAicnVuIHRoZSBoYW5kbGVyIGFzeW5jaHJvbm91c2x5IGFmdGVyIHRoZSBldmVudCIKICAgICAgICAgICAgLy8gVGhpcyBpcyB1c2VmdWwsIGZvciBleGFtcGxlLCB0byBjYXRjaCAia2V5ZG93biIgZXZlbnRzIGFmdGVyIHRoZSBicm93c2VyIGhhcyB1cGRhdGVkIHRoZSBjb250cm9sCiAgICAgICAgICAgIC8vIChvdGhlcndpc2UsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKHRoaXMpIHdpbGwgcmVjZWl2ZSB0aGUgY29udHJvbCdzIHZhbHVlICpiZWZvcmUqIHRoZSBrZXkgZXZlbnQpCiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdmFsdWVVcGRhdGVIYW5kbGVyOwogICAgICAgICAgICBpZiAoa28udXRpbHMuc3RyaW5nU3RhcnRzV2l0aChldmVudE5hbWUsICJhZnRlciIpKSB7CiAgICAgICAgICAgICAgICBoYW5kbGVyID0gZnVuY3Rpb24oKSB7IHNldFRpbWVvdXQodmFsdWVVcGRhdGVIYW5kbGVyLCAwKSB9OwogICAgICAgICAgICAgICAgZXZlbnROYW1lID0gZXZlbnROYW1lLnN1YnN0cmluZygiYWZ0ZXIiLmxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnROYW1lLCBoYW5kbGVyKTsKICAgICAgICB9KTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWVJc1NlbGVjdE9wdGlvbiA9IGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSA9PT0gInNlbGVjdCI7CiAgICAgICAgdmFyIG5ld1ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBlbGVtZW50VmFsdWUgPSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50KTsKICAgICAgICB2YXIgdmFsdWVIYXNDaGFuZ2VkID0gKG5ld1ZhbHVlICE9IGVsZW1lbnRWYWx1ZSk7CgogICAgICAgIC8vIEphdmFTY3JpcHQncyAwID09ICIiIGJlaGF2aW91cyBpcyB1bmZvcnR1bmF0ZSBoZXJlIGFzIGl0IHByZXZlbnRzIHdyaXRpbmcgMCB0byBhbiBlbXB0eSB0ZXh0IGJveCAobG9vc2UgZXF1YWxpdHkgc3VnZ2VzdHMgdGhlIHZhbHVlcyBhcmUgdGhlIHNhbWUpLgogICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdG8gZG8gYSBzdHJpY3QgZXF1YWxpdHkgY29tcGFyaXNvbiBhcyB0aGF0IGlzIG1vcmUgY29uZnVzaW5nIGZvciBkZXZlbG9wZXJzIGluIGNlcnRhaW4gY2FzZXMsIHNvIHdlIHNwZWNpZmljYWxseSBzcGVjaWFsIGNhc2UgMCAhPSAiIiBoZXJlLgogICAgICAgIGlmICgobmV3VmFsdWUgPT09IDApICYmIChlbGVtZW50VmFsdWUgIT09IDApICYmIChlbGVtZW50VmFsdWUgIT09ICIwIikpCiAgICAgICAgICAgIHZhbHVlSGFzQ2hhbmdlZCA9IHRydWU7CgogICAgICAgIGlmICh2YWx1ZUhhc0NoYW5nZWQpIHsKICAgICAgICAgICAgdmFyIGFwcGx5VmFsdWVBY3Rpb24gPSBmdW5jdGlvbiAoKSB7IGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSk7IH07CiAgICAgICAgICAgIGFwcGx5VmFsdWVBY3Rpb24oKTsKCiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIElFNiBidWc6IEl0IHdvbid0IHJlbGlhYmx5IGFwcGx5IHZhbHVlcyB0byBTRUxFQ1Qgbm9kZXMgZHVyaW5nIHRoZSBzYW1lIGV4ZWN1dGlvbiB0aHJlYWQKICAgICAgICAgICAgLy8gcmlnaHQgYWZ0ZXIgeW91J3ZlIGNoYW5nZWQgdGhlIHNldCBvZiBPUFRJT04gbm9kZXMgb24gaXQuIFNvIGZvciB0aGF0IG5vZGUgdHlwZSwgd2UnbGwgc2NoZWR1bGUgYSBzZWNvbmQgdGhyZWFkCiAgICAgICAgICAgIC8vIHRvIGFwcGx5IHRoZSB2YWx1ZSBhcyB3ZWxsLgogICAgICAgICAgICB2YXIgYWxzb0FwcGx5QXN5bmNocm9ub3VzbHkgPSB2YWx1ZUlzU2VsZWN0T3B0aW9uOwogICAgICAgICAgICBpZiAoYWxzb0FwcGx5QXN5bmNocm9ub3VzbHkpCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGFwcGx5VmFsdWVBY3Rpb24sIDApOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgeW91IHRyeSB0byBzZXQgYSBtb2RlbCB2YWx1ZSB0aGF0IGNhbid0IGJlIHJlcHJlc2VudGVkIGluIGFuIGFscmVhZHktcG9wdWxhdGVkIGRyb3Bkb3duLCByZWplY3QgdGhhdCBjaGFuZ2UsCiAgICAgICAgLy8gYmVjYXVzZSB5b3UncmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBhIG1vZGVsIHZhbHVlIHRoYXQgZGlzYWdyZWVzIHdpdGggYSB2aXNpYmxlIFVJIHNlbGVjdGlvbi4KICAgICAgICBpZiAodmFsdWVJc1NlbGVjdE9wdGlvbiAmJiAoZWxlbWVudC5sZW5ndGggPiAwKSkKICAgICAgICAgICAgZW5zdXJlRHJvcGRvd25TZWxlY3Rpb25Jc0NvbnNpc3RlbnRXaXRoTW9kZWxWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSwgLyogcHJlZmVyTW9kZWxWYWx1ZSAqLyBmYWxzZSk7CiAgICB9Cn07CmtvLmJpbmRpbmdIYW5kbGVyc1sndmlzaWJsZSddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBpc0N1cnJlbnRseVZpc2libGUgPSAhKGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9PSAibm9uZSIpOwogICAgICAgIGlmICh2YWx1ZSAmJiAhaXNDdXJyZW50bHlWaXNpYmxlKQogICAgICAgICAgICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAiIjsKICAgICAgICBlbHNlIGlmICgoIXZhbHVlKSAmJiBpc0N1cnJlbnRseVZpc2libGUpCiAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIH0KfTsKLy8gJ2NsaWNrJyBpcyBqdXN0IGEgc2hvcnRoYW5kIGZvciB0aGUgdXN1YWwgZnVsbC1sZW5ndGggZXZlbnQ6e2NsaWNrOmhhbmRsZXJ9Cm1ha2VFdmVudEhhbmRsZXJTaG9ydGN1dCgnY2xpY2snKTsKLy8gSWYgeW91IHdhbnQgdG8gbWFrZSBhIGN1c3RvbSB0ZW1wbGF0ZSBlbmdpbmUsCi8vCi8vIFsxXSBJbmhlcml0IGZyb20gdGhpcyBjbGFzcyAobGlrZSBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSBkb2VzKQovLyBbMl0gT3ZlcnJpZGUgJ3JlbmRlclRlbXBsYXRlU291cmNlJywgc3VwcGx5aW5nIGEgZnVuY3Rpb24gd2l0aCB0aGlzIHNpZ25hdHVyZToKLy8KLy8gICAgICAgIGZ1bmN0aW9uICh0ZW1wbGF0ZVNvdXJjZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpIHsKLy8gICAgICAgICAgICAvLyAtIHRlbXBsYXRlU291cmNlLnRleHQoKSBpcyB0aGUgdGV4dCBvZiB0aGUgdGVtcGxhdGUgeW91IHNob3VsZCByZW5kZXIKLy8gICAgICAgICAgICAvLyAtIGJpbmRpbmdDb250ZXh0LiRkYXRhIGlzIHRoZSBkYXRhIHlvdSBzaG91bGQgcGFzcyBpbnRvIHRoZSB0ZW1wbGF0ZQovLyAgICAgICAgICAgIC8vICAgLSB5b3UgbWlnaHQgYWxzbyB3YW50IHRvIG1ha2UgYmluZGluZ0NvbnRleHQuJHBhcmVudCwgYmluZGluZ0NvbnRleHQuJHBhcmVudHMsCi8vICAgICAgICAgICAgLy8gICAgIGFuZCBiaW5kaW5nQ29udGV4dC4kcm9vdCBhdmFpbGFibGUgaW4gdGhlIHRlbXBsYXRlIHRvbwovLyAgICAgICAgICAgIC8vIC0gb3B0aW9ucyBnaXZlcyB5b3UgYWNjZXNzIHRvIGFueSBvdGhlciBwcm9wZXJ0aWVzIHNldCBvbiAiZGF0YS1iaW5kOiB7IHRlbXBsYXRlOiBvcHRpb25zIH0iCi8vICAgICAgICAgICAgLy8KLy8gICAgICAgICAgICAvLyBSZXR1cm4gdmFsdWU6IGFuIGFycmF5IG9mIERPTSBub2RlcwovLyAgICAgICAgfQovLwovLyBbM10gT3ZlcnJpZGUgJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jaycsIHN1cHBseWluZyBhIGZ1bmN0aW9uIHdpdGggdGhpcyBzaWduYXR1cmU6Ci8vCi8vICAgICAgICBmdW5jdGlvbiAoc2NyaXB0KSB7Ci8vICAgICAgICAgICAgLy8gUmV0dXJuIHZhbHVlOiBXaGF0ZXZlciBzeW50YXggbWVhbnMgIkV2YWx1YXRlIHRoZSBKYXZhU2NyaXB0IHN0YXRlbWVudCAnc2NyaXB0JyBhbmQgb3V0cHV0IHRoZSByZXN1bHQiCi8vICAgICAgICAgICAgLy8gICAgICAgICAgICAgICBGb3IgZXhhbXBsZSwgdGhlIGpxdWVyeS50bXBsIHRlbXBsYXRlIGVuZ2luZSBjb252ZXJ0cyAnc29tZVNjcmlwdCcgdG8gJyR7IHNvbWVTY3JpcHQgfScKLy8gICAgICAgIH0KLy8KLy8gICAgIFRoaXMgaXMgb25seSBuZWNlc3NhcnkgaWYgeW91IHdhbnQgdG8gYWxsb3cgZGF0YS1iaW5kIGF0dHJpYnV0ZXMgdG8gcmVmZXJlbmNlIGFyYml0cmFyeSB0ZW1wbGF0ZSB2YXJpYWJsZXMuCi8vICAgICBJZiB5b3UgZG9uJ3Qgd2FudCB0byBhbGxvdyB0aGF0LCB5b3UgY2FuIHNldCB0aGUgcHJvcGVydHkgJ2FsbG93VGVtcGxhdGVSZXdyaXRpbmcnIHRvIGZhbHNlIChsaWtlIGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lIGRvZXMpCi8vICAgICBhbmQgdGhlbiB5b3UgZG9uJ3QgbmVlZCB0byBvdmVycmlkZSAnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJy4KCmtvLnRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgeyB9OwoKa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddID0gZnVuY3Rpb24gKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewogICAgdGhyb3cgbmV3IEVycm9yKCJPdmVycmlkZSByZW5kZXJUZW1wbGF0ZVNvdXJjZSIpOwp9OwoKa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2snXSA9IGZ1bmN0aW9uIChzY3JpcHQpIHsKICAgIHRocm93IG5ldyBFcnJvcigiT3ZlcnJpZGUgY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrIik7Cn07Cgprby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ21ha2VUZW1wbGF0ZVNvdXJjZSddID0gZnVuY3Rpb24odGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIC8vIE5hbWVkIHRlbXBsYXRlCiAgICBpZiAodHlwZW9mIHRlbXBsYXRlID09ICJzdHJpbmciKSB7CiAgICAgICAgdGVtcGxhdGVEb2N1bWVudCA9IHRlbXBsYXRlRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgdmFyIGVsZW0gPSB0ZW1wbGF0ZURvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRlbXBsYXRlKTsKICAgICAgICBpZiAoIWVsZW0pCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgdGVtcGxhdGUgd2l0aCBJRCAiICsgdGVtcGxhdGUpOwogICAgICAgIHJldHVybiBuZXcga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQoZWxlbSk7CiAgICB9IGVsc2UgaWYgKCh0ZW1wbGF0ZS5ub2RlVHlwZSA9PSAxKSB8fCAodGVtcGxhdGUubm9kZVR5cGUgPT0gOCkpIHsKICAgICAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGUKICAgICAgICByZXR1cm4gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZSh0ZW1wbGF0ZSk7CiAgICB9IGVsc2UKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdGVtcGxhdGUgdHlwZTogIiArIHRlbXBsYXRlKTsKfTsKCmtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmVuZGVyVGVtcGxhdGUnXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIHZhciB0ZW1wbGF0ZVNvdXJjZSA9IHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgIHJldHVybiB0aGlzWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucyk7Cn07Cgprby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ2lzVGVtcGxhdGVSZXdyaXR0ZW4nXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkgewogICAgLy8gU2tpcCByZXdyaXRpbmcgaWYgcmVxdWVzdGVkCiAgICBpZiAodGhpc1snYWxsb3dUZW1wbGF0ZVJld3JpdGluZyddID09PSBmYWxzZSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIHJldHVybiB0aGlzWydtYWtlVGVtcGxhdGVTb3VyY2UnXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudClbJ2RhdGEnXSgiaXNSZXdyaXR0ZW4iKTsKfTsKCmtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmV3cml0ZVRlbXBsYXRlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGUsIHJld3JpdGVyQ2FsbGJhY2ssIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIHZhciB0ZW1wbGF0ZVNvdXJjZSA9IHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgIHZhciByZXdyaXR0ZW4gPSByZXdyaXRlckNhbGxiYWNrKHRlbXBsYXRlU291cmNlWyd0ZXh0J10oKSk7CiAgICB0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKHJld3JpdHRlbik7CiAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCJpc1Jld3JpdHRlbiIsIHRydWUpOwp9OwoKa28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZUVuZ2luZScsIGtvLnRlbXBsYXRlRW5naW5lKTsKCmtvLnRlbXBsYXRlUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCA9IC8oPFthLXpdK1xkKihccysoPyFkYXRhLWJpbmQ9KVthLXowLTlcLV0rKD0oXCJbXlwiXSpcInxcJ1teXCddKlwnKSk/KSpccyspZGF0YS1iaW5kPShbIiddKShbXHNcU10qPylcNS9naTsKICAgIHZhciBtZW1vaXplVmlydHVhbENvbnRhaW5lckJpbmRpbmdTeW50YXhSZWdleCA9IC88IS0tXHMqa29cYlxzKihbXHNcU10qPylccyotLT4vZzsKCiAgICBmdW5jdGlvbiB2YWxpZGF0ZURhdGFCaW5kVmFsdWVzRm9yUmV3cml0aW5nKGtleVZhbHVlQXJyYXkpIHsKICAgICAgICB2YXIgYWxsVmFsaWRhdG9ycyA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5VmFsdWVBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIga2V5ID0ga2V5VmFsdWVBcnJheVtpXVsna2V5J107CiAgICAgICAgICAgIGlmIChhbGxWYWxpZGF0b3JzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgIHZhciB2YWxpZGF0b3IgPSBhbGxWYWxpZGF0b3JzW2tleV07CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWxpZGF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcG9zc2libGVFcnJvck1lc3NhZ2UgPSB2YWxpZGF0b3Ioa2V5VmFsdWVBcnJheVtpXVsndmFsdWUnXSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlRXJyb3JNZXNzYWdlKQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IocG9zc2libGVFcnJvck1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdmFsaWRhdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHRlbXBsYXRlIGVuZ2luZSBkb2VzIG5vdCBzdXBwb3J0IHRoZSAnIiArIGtleSArICInIGJpbmRpbmcgd2l0aGluIGl0cyB0ZW1wbGF0ZXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjb25zdHJ1Y3RNZW1vaXplZFRhZ1JlcGxhY2VtZW50KGRhdGFCaW5kQXR0cmlidXRlVmFsdWUsIHRhZ1RvUmV0YWluLCB0ZW1wbGF0ZUVuZ2luZSkgewogICAgICAgIHZhciBkYXRhQmluZEtleVZhbHVlQXJyYXkgPSBrby5leHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbChkYXRhQmluZEF0dHJpYnV0ZVZhbHVlKTsKICAgICAgICB2YWxpZGF0ZURhdGFCaW5kVmFsdWVzRm9yUmV3cml0aW5nKGRhdGFCaW5kS2V5VmFsdWVBcnJheSk7CiAgICAgICAgdmFyIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgPSBrby5leHByZXNzaW9uUmV3cml0aW5nLnByZVByb2Nlc3NCaW5kaW5ncyhkYXRhQmluZEtleVZhbHVlQXJyYXkpOwoKICAgICAgICAvLyBGb3Igbm8gb2J2aW91cyByZWFzb24sIE9wZXJhIGZhaWxzIHRvIGV2YWx1YXRlIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgdW5sZXNzIGl0J3Mgd3JhcHBlZCBpbiBhbiBhZGRpdGlvbmFsCiAgICAgICAgLy8gYW5vbnltb3VzIGZ1bmN0aW9uLCBldmVuIHRob3VnaCBPcGVyYSdzIGJ1aWx0LWluIGRlYnVnZ2VyIGNhbiBldmFsdWF0ZSBpdCBhbnl3YXkuIE5vIG90aGVyIGJyb3dzZXIgcmVxdWlyZXMgdGhpcwogICAgICAgIC8vIGV4dHJhIGluZGlyZWN0aW9uLgogICAgICAgIHZhciBhcHBseUJpbmRpbmdzVG9OZXh0U2libGluZ1NjcmlwdCA9CiAgICAgICAgICAgICJrby5fX3RyX2FtYnRucyhmdW5jdGlvbigkY29udGV4dCwkZWxlbWVudCl7cmV0dXJuKGZ1bmN0aW9uKCl7cmV0dXJueyAiICsgcmV3cml0dGVuRGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSArICIgfSB9KSgpfSkiOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZUVuZ2luZVsnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10oYXBwbHlCaW5kaW5nc1RvTmV4dFNpYmxpbmdTY3JpcHQpICsgdGFnVG9SZXRhaW47CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBlbnN1cmVUZW1wbGF0ZUlzUmV3cml0dGVuOiBmdW5jdGlvbiAodGVtcGxhdGUsIHRlbXBsYXRlRW5naW5lLCB0ZW1wbGF0ZURvY3VtZW50KSB7CiAgICAgICAgICAgIGlmICghdGVtcGxhdGVFbmdpbmVbJ2lzVGVtcGxhdGVSZXdyaXR0ZW4nXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkpCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZUVuZ2luZVsncmV3cml0ZVRlbXBsYXRlJ10odGVtcGxhdGUsIGZ1bmN0aW9uIChodG1sU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnRlbXBsYXRlUmV3cml0aW5nLm1lbW9pemVCaW5kaW5nQXR0cmlidXRlU3ludGF4KGh0bWxTdHJpbmcsIHRlbXBsYXRlRW5naW5lKTsKICAgICAgICAgICAgICAgIH0sIHRlbXBsYXRlRG9jdW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIG1lbW9pemVCaW5kaW5nQXR0cmlidXRlU3ludGF4OiBmdW5jdGlvbiAoaHRtbFN0cmluZywgdGVtcGxhdGVFbmdpbmUpIHsKICAgICAgICAgICAgcmV0dXJuIGh0bWxTdHJpbmcucmVwbGFjZShtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzZdLCAvKiB0YWdUb1JldGFpbjogKi8gYXJndW1lbnRzWzFdLCB0ZW1wbGF0ZUVuZ2luZSk7CiAgICAgICAgICAgIH0pLnJlcGxhY2UobWVtb2l6ZVZpcnR1YWxDb250YWluZXJCaW5kaW5nU3ludGF4UmVnZXgsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzFdLCAvKiB0YWdUb1JldGFpbjogKi8gIjwhLS0ga28gLS0+IiwgdGVtcGxhdGVFbmdpbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBhcHBseU1lbW9pemVkQmluZGluZ3NUb05leHRTaWJsaW5nOiBmdW5jdGlvbiAoYmluZGluZ3MpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoZnVuY3Rpb24gKGRvbU5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoZG9tTm9kZS5uZXh0U2libGluZykKICAgICAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdzVG9Ob2RlKGRvbU5vZGUubmV4dFNpYmxpbmcsIGJpbmRpbmdzLCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KfSkoKTsKCgovLyBFeHBvcnRlZCBvbmx5IGJlY2F1c2UgaXQgaGFzIHRvIGJlIHJlZmVyZW5jZWQgYnkgc3RyaW5nIGxvb2t1cCBmcm9tIHdpdGhpbiByZXdyaXR0ZW4gdGVtcGxhdGUKa28uZXhwb3J0U3ltYm9sKCdfX3RyX2FtYnRucycsIGtvLnRlbXBsYXRlUmV3cml0aW5nLmFwcGx5TWVtb2l6ZWRCaW5kaW5nc1RvTmV4dFNpYmxpbmcpOwooZnVuY3Rpb24oKSB7CiAgICAvLyBBIHRlbXBsYXRlIHNvdXJjZSByZXByZXNlbnRzIGEgcmVhZC93cml0ZSB3YXkgb2YgYWNjZXNzaW5nIGEgdGVtcGxhdGUuIFRoaXMgaXMgdG8gZWxpbWluYXRlIHRoZSBuZWVkIGZvciB0ZW1wbGF0ZSBsb2FkaW5nL3NhdmluZwogICAgLy8gbG9naWMgdG8gYmUgZHVwbGljYXRlZCBpbiBldmVyeSB0ZW1wbGF0ZSBlbmdpbmUgKGFuZCBtZWFucyB0aGV5IGNhbiBhbGwgd29yayB3aXRoIGFub255bW91cyB0ZW1wbGF0ZXMsIGV0Yy4pCiAgICAvLwogICAgLy8gVHdvIGFyZSBwcm92aWRlZCBieSBkZWZhdWx0OgogICAgLy8gIDEuIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ICAgICAgIC0gcmVhZHMvd3JpdGVzIHRoZSB0ZXh0IGNvbnRlbnQgb2YgYW4gYXJiaXRyYXJ5IERPTSBlbGVtZW50CiAgICAvLyAgMi4ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c0VsZW1lbnQgLSB1c2VzIGtvLnV0aWxzLmRvbURhdGEgdG8gcmVhZC93cml0ZSB0ZXh0ICphc3NvY2lhdGVkKiB3aXRoIHRoZSBET00gZWxlbWVudCwgYnV0CiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRob3V0IHJlYWRpbmcvd3JpdGluZyB0aGUgYWN0dWFsIGVsZW1lbnQgdGV4dCBjb250ZW50LCBzaW5jZSBpdCB3aWxsIGJlIG92ZXJ3cml0dGVuCiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIHRoZSByZW5kZXJlZCB0ZW1wbGF0ZSBvdXRwdXQuCiAgICAvLyBZb3UgY2FuIGltcGxlbWVudCB5b3VyIG93biB0ZW1wbGF0ZSBzb3VyY2UgaWYgeW91IHdhbnQgdG8gZmV0Y2gvc3RvcmUgdGVtcGxhdGVzIHNvbWV3aGVyZSBvdGhlciB0aGFuIGluIERPTSBlbGVtZW50cy4KICAgIC8vIFRlbXBsYXRlIHNvdXJjZXMgbmVlZCB0byBoYXZlIHRoZSBmb2xsb3dpbmcgZnVuY3Rpb25zOgogICAgLy8gICB0ZXh0KCkgCQkJLSByZXR1cm5zIHRoZSB0ZW1wbGF0ZSB0ZXh0IGZyb20geW91ciBzdG9yYWdlIGxvY2F0aW9uCiAgICAvLyAgIHRleHQodmFsdWUpCQktIHdyaXRlcyB0aGUgc3VwcGxpZWQgdGVtcGxhdGUgdGV4dCB0byB5b3VyIHN0b3JhZ2UgbG9jYXRpb24KICAgIC8vICAgZGF0YShrZXkpCQkJLSByZWFkcyB2YWx1ZXMgc3RvcmVkIHVzaW5nIGRhdGEoa2V5LCB2YWx1ZSkgLSBzZWUgYmVsb3cKICAgIC8vICAgZGF0YShrZXksIHZhbHVlKQktIGFzc29jaWF0ZXMgInZhbHVlIiB3aXRoIHRoaXMgdGVtcGxhdGUgYW5kIHRoZSBrZXkgImtleSIuIElzIHVzZWQgdG8gc3RvcmUgaW5mb3JtYXRpb24gbGlrZSAiaXNSZXdyaXR0ZW4iLgogICAgLy8KICAgIC8vIE9wdGlvbmFsbHksIHRlbXBsYXRlIHNvdXJjZXMgY2FuIGFsc28gaGF2ZSB0aGUgZm9sbG93aW5nIGZ1bmN0aW9uczoKICAgIC8vICAgbm9kZXMoKSAgICAgICAgICAgIC0gcmV0dXJucyBhIERPTSBlbGVtZW50IGNvbnRhaW5pbmcgdGhlIG5vZGVzIG9mIHRoaXMgdGVtcGxhdGUsIHdoZXJlIGF2YWlsYWJsZQogICAgLy8gICBub2Rlcyh2YWx1ZSkgICAgICAgLSB3cml0ZXMgdGhlIGdpdmVuIERPTSBlbGVtZW50IHRvIHlvdXIgc3RvcmFnZSBsb2NhdGlvbgogICAgLy8gSWYgYSBET00gZWxlbWVudCBpcyBhdmFpbGFibGUgZm9yIGEgZ2l2ZW4gdGVtcGxhdGUgc291cmNlLCB0ZW1wbGF0ZSBlbmdpbmVzIGFyZSBlbmNvdXJhZ2VkIHRvIHVzZSBpdCBpbiBwcmVmZXJlbmNlIG92ZXIgdGV4dCgpCiAgICAvLyBmb3IgaW1wcm92ZWQgc3BlZWQuIEhvd2V2ZXIsIGFsbCB0ZW1wbGF0ZVNvdXJjZXMgbXVzdCBzdXBwbHkgdGV4dCgpIGV2ZW4gaWYgdGhleSBkb24ndCBzdXBwbHkgbm9kZXMoKS4KICAgIC8vCiAgICAvLyBPbmNlIHlvdSd2ZSBpbXBsZW1lbnRlZCBhIHRlbXBsYXRlU291cmNlLCBtYWtlIHlvdXIgdGVtcGxhdGUgZW5naW5lIHVzZSBpdCBieSBzdWJjbGFzc2luZyB3aGF0ZXZlciB0ZW1wbGF0ZSBlbmdpbmUgeW91IHdlcmUKICAgIC8vIHVzaW5nIGFuZCBvdmVycmlkaW5nICJtYWtlVGVtcGxhdGVTb3VyY2UiIHRvIHJldHVybiBhbiBpbnN0YW5jZSBvZiB5b3VyIGN1c3RvbSB0ZW1wbGF0ZSBzb3VyY2UuCgogICAga28udGVtcGxhdGVTb3VyY2VzID0ge307CgogICAgLy8gLS0tLSBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCAtLS0tLQoKICAgIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHRoaXMuZG9tRWxlbWVudCA9IGVsZW1lbnQ7CiAgICB9CgogICAga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICB2YXIgdGFnTmFtZUxvd2VyID0ga28udXRpbHMudGFnTmFtZUxvd2VyKHRoaXMuZG9tRWxlbWVudCksCiAgICAgICAgICAgIGVsZW1Db250ZW50c1Byb3BlcnR5ID0gdGFnTmFtZUxvd2VyID09PSAic2NyaXB0IiA/ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHRhZ05hbWVMb3dlciA9PT0gInRleHRhcmVhIiA/ICJ2YWx1ZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAiaW5uZXJIVE1MIjsKCiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kb21FbGVtZW50W2VsZW1Db250ZW50c1Byb3BlcnR5XTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdmFsdWVUb1dyaXRlID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICBpZiAoZWxlbUNvbnRlbnRzUHJvcGVydHkgPT09ICJpbm5lckhUTUwiKQogICAgICAgICAgICAgICAga28udXRpbHMuc2V0SHRtbCh0aGlzLmRvbUVsZW1lbnQsIHZhbHVlVG9Xcml0ZSk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHRoaXMuZG9tRWxlbWVudFtlbGVtQ29udGVudHNQcm9wZXJ0eV0gPSB2YWx1ZVRvV3JpdGU7CiAgICAgICAgfQogICAgfTsKCiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudC5wcm90b3R5cGVbJ2RhdGEnXSA9IGZ1bmN0aW9uKGtleSAvKiwgdmFsdWVUb1dyaXRlICovKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KHRoaXMuZG9tRWxlbWVudCwgInRlbXBsYXRlU291cmNlRGF0YV8iICsga2V5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldCh0aGlzLmRvbUVsZW1lbnQsICJ0ZW1wbGF0ZVNvdXJjZURhdGFfIiArIGtleSwgYXJndW1lbnRzWzFdKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIC0tLS0ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlIC0tLS0tCiAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGVzIGFyZSBub3JtYWxseSBzYXZlZC9yZXRyaWV2ZWQgYXMgRE9NIG5vZGVzIHRocm91Z2ggIm5vZGVzIi4KICAgIC8vIEZvciBjb21wYXRpYmlsaXR5LCB5b3UgY2FuIGFsc28gcmVhZCAidGV4dCI7IGl0IHdpbGwgYmUgc2VyaWFsaXplZCBmcm9tIHRoZSBub2RlcyBvbiBkZW1hbmQuCiAgICAvLyBXcml0aW5nIHRvICJ0ZXh0IiBpcyBzdGlsbCBzdXBwb3J0ZWQsIGJ1dCB0aGVuIHRoZSB0ZW1wbGF0ZSBkYXRhIHdpbGwgbm90IGJlIGF2YWlsYWJsZSBhcyBET00gbm9kZXMuCgogICAgdmFyIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkgPSAiX19rb19hbm9uX3RlbXBsYXRlX18iOwogICAga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHRoaXMuZG9tRWxlbWVudCA9IGVsZW1lbnQ7CiAgICB9CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlID0gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50KCk7CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBrby51dGlscy5kb21EYXRhLmdldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkpIHx8IHt9OwogICAgICAgICAgICBpZiAodGVtcGxhdGVEYXRhLnRleHREYXRhID09PSB1bmRlZmluZWQgJiYgdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGEpCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZURhdGEudGV4dERhdGEgPSB0ZW1wbGF0ZURhdGEuY29udGFpbmVyRGF0YS5pbm5lckhUTUw7CiAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZURhdGEudGV4dERhdGE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5LCB7dGV4dERhdGE6IHZhbHVlVG9Xcml0ZX0pOwogICAgICAgIH0KICAgIH07CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudC5wcm90b3R5cGVbJ25vZGVzJ10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBrby51dGlscy5kb21EYXRhLmdldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkpIHx8IHt9OwogICAgICAgICAgICByZXR1cm4gdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5LCB7Y29udGFpbmVyRGF0YTogdmFsdWVUb1dyaXRlfSk7CiAgICAgICAgfQogICAgfTsKCiAgICBrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlU291cmNlcycsIGtvLnRlbXBsYXRlU291cmNlcyk7CiAgICBrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlU291cmNlcy5kb21FbGVtZW50Jywga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQpOwogICAga28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUnLCBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUpOwp9KSgpOwooZnVuY3Rpb24gKCkgewogICAgdmFyIF90ZW1wbGF0ZUVuZ2luZTsKICAgIGtvLnNldFRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKHRlbXBsYXRlRW5naW5lKSB7CiAgICAgICAgaWYgKCh0ZW1wbGF0ZUVuZ2luZSAhPSB1bmRlZmluZWQpICYmICEodGVtcGxhdGVFbmdpbmUgaW5zdGFuY2VvZiBrby50ZW1wbGF0ZUVuZ2luZSkpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidGVtcGxhdGVFbmdpbmUgbXVzdCBpbmhlcml0IGZyb20ga28udGVtcGxhdGVFbmdpbmUiKTsKICAgICAgICBfdGVtcGxhdGVFbmdpbmUgPSB0ZW1wbGF0ZUVuZ2luZTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbnZva2VGb3JFYWNoTm9kZU9yQ29tbWVudEluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGFjdGlvbikgewogICAgICAgIHZhciBub2RlLCBuZXh0SW5RdWV1ZSA9IGZpcnN0Tm9kZSwgZmlyc3RPdXRPZlJhbmdlTm9kZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhsYXN0Tm9kZSk7CiAgICAgICAgd2hpbGUgKG5leHRJblF1ZXVlICYmICgobm9kZSA9IG5leHRJblF1ZXVlKSAhPT0gZmlyc3RPdXRPZlJhbmdlTm9kZSkpIHsKICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcobm9kZSk7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxIHx8IG5vZGUubm9kZVR5cGUgPT09IDgpCiAgICAgICAgICAgICAgICBhY3Rpb24obm9kZSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGFjdGl2YXRlQmluZGluZ3NPbkNvbnRpbnVvdXNOb2RlQXJyYXkoY29udGludW91c05vZGVBcnJheSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAvLyBUbyBiZSB1c2VkIG9uIGFueSBub2RlcyB0aGF0IGhhdmUgYmVlbiByZW5kZXJlZCBieSBhIHRlbXBsYXRlIGFuZCBoYXZlIGJlZW4gaW5zZXJ0ZWQgaW50byBzb21lIHBhcmVudCBlbGVtZW50CiAgICAgICAgLy8gV2Fsa3MgdGhyb3VnaCBjb250aW51b3VzTm9kZUFycmF5ICh3aGljaCAqbXVzdCogYmUgY29udGludW91cywgaS5lLiwgYW4gdW5pbnRlcnJ1cHRlZCBzZXF1ZW5jZSBvZiBzaWJsaW5nIG5vZGVzLCBiZWNhdXNlCiAgICAgICAgLy8gdGhlIGFsZ29yaXRobSBmb3Igd2Fsa2luZyB0aGVtIHJlbGllcyBvbiB0aGlzKSwgYW5kIGZvciBlYWNoIHRvcC1sZXZlbCBpdGVtIGluIHRoZSB2aXJ0dWFsLWVsZW1lbnQgc2Vuc2UsCiAgICAgICAgLy8gKDEpIERvZXMgYSByZWd1bGFyICJhcHBseUJpbmRpbmdzIiB0byBhc3NvY2lhdGUgYmluZGluZ0NvbnRleHQgd2l0aCB0aGlzIG5vZGUgYW5kIHRvIGFjdGl2YXRlIGFueSBub24tbWVtb2l6ZWQgYmluZGluZ3MKICAgICAgICAvLyAoMikgVW5tZW1vaXplcyBhbnkgbWVtb3MgaW4gdGhlIERPTSBzdWJ0cmVlIChlLmcuLCB0byBhY3RpdmF0ZSBiaW5kaW5ncyB0aGF0IGhhZCBiZWVuIG1lbW9pemVkIGR1cmluZyB0ZW1wbGF0ZSByZXdyaXRpbmcpCgogICAgICAgIGlmIChjb250aW51b3VzTm9kZUFycmF5Lmxlbmd0aCkgewogICAgICAgICAgICB2YXIgZmlyc3ROb2RlID0gY29udGludW91c05vZGVBcnJheVswXSwgbGFzdE5vZGUgPSBjb250aW51b3VzTm9kZUFycmF5W2NvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoIC0gMV07CgogICAgICAgICAgICAvLyBOZWVkIHRvIGFwcGx5QmluZGluZ3MgKmJlZm9yZSogdW5tZW1vemlhdGlvbiwgYmVjYXVzZSB1bm1lbW9pemF0aW9uIG1pZ2h0IGludHJvZHVjZSBleHRyYSBub2RlcyAodGhhdCB3ZSBkb24ndCB3YW50IHRvIHJlLWJpbmQpCiAgICAgICAgICAgIC8vIHdoZXJlYXMgYSByZWd1bGFyIGFwcGx5QmluZGluZ3Mgd29uJ3QgaW50cm9kdWNlIG5ldyBtZW1vaXplZCBub2RlcwogICAgICAgICAgICBpbnZva2VGb3JFYWNoTm9kZU9yQ29tbWVudEluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ3MoYmluZGluZ0NvbnRleHQsIG5vZGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaW52b2tlRm9yRWFjaE5vZGVPckNvbW1lbnRJbkNvbnRpbnVvdXNSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICBrby5tZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMobm9kZSwgW2JpbmRpbmdDb250ZXh0XSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheShub2RlT3JOb2RlQXJyYXkpIHsKICAgICAgICByZXR1cm4gbm9kZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gbm9kZU9yTm9kZUFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG5vZGVPck5vZGVBcnJheS5sZW5ndGggPiAwID8gbm9kZU9yTm9kZUFycmF5WzBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gZXhlY3V0ZVRlbXBsYXRlKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSwgdGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdmFyIGZpcnN0VGFyZ2V0Tm9kZSA9IHRhcmdldE5vZGVPck5vZGVBcnJheSAmJiBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheSh0YXJnZXROb2RlT3JOb2RlQXJyYXkpOwogICAgICAgIHZhciB0ZW1wbGF0ZURvY3VtZW50ID0gZmlyc3RUYXJnZXROb2RlICYmIGZpcnN0VGFyZ2V0Tm9kZS5vd25lckRvY3VtZW50OwogICAgICAgIHZhciB0ZW1wbGF0ZUVuZ2luZVRvVXNlID0gKG9wdGlvbnNbJ3RlbXBsYXRlRW5naW5lJ10gfHwgX3RlbXBsYXRlRW5naW5lKTsKICAgICAgICBrby50ZW1wbGF0ZVJld3JpdGluZy5lbnN1cmVUZW1wbGF0ZUlzUmV3cml0dGVuKHRlbXBsYXRlLCB0ZW1wbGF0ZUVuZ2luZVRvVXNlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgICAgICB2YXIgcmVuZGVyZWROb2Rlc0FycmF5ID0gdGVtcGxhdGVFbmdpbmVUb1VzZVsncmVuZGVyVGVtcGxhdGUnXSh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRlbXBsYXRlRG9jdW1lbnQpOwoKICAgICAgICAvLyBMb29zZWx5IGNoZWNrIHJlc3VsdCBpcyBhbiBhcnJheSBvZiBET00gbm9kZXMKICAgICAgICBpZiAoKHR5cGVvZiByZW5kZXJlZE5vZGVzQXJyYXkubGVuZ3RoICE9ICJudW1iZXIiKSB8fCAocmVuZGVyZWROb2Rlc0FycmF5Lmxlbmd0aCA+IDAgJiYgdHlwZW9mIHJlbmRlcmVkTm9kZXNBcnJheVswXS5ub2RlVHlwZSAhPSAibnVtYmVyIikpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGVtcGxhdGUgZW5naW5lIG11c3QgcmV0dXJuIGFuIGFycmF5IG9mIERPTSBub2RlcyIpOwoKICAgICAgICB2YXIgaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCA9IGZhbHNlOwogICAgICAgIHN3aXRjaCAocmVuZGVyTW9kZSkgewogICAgICAgICAgICBjYXNlICJyZXBsYWNlQ2hpbGRyZW4iOgogICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbih0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlcmVkTm9kZXNBcnJheSk7CiAgICAgICAgICAgICAgICBoYXZlQWRkZWROb2Rlc1RvUGFyZW50ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJyZXBsYWNlTm9kZSI6CiAgICAgICAgICAgICAgICBrby51dGlscy5yZXBsYWNlRG9tTm9kZXModGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJlZE5vZGVzQXJyYXkpOwogICAgICAgICAgICAgICAgaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaWdub3JlVGFyZ2V0Tm9kZSI6IGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHJlbmRlck1vZGU6ICIgKyByZW5kZXJNb2RlKTsKICAgICAgICB9CgogICAgICAgIGlmIChoYXZlQWRkZWROb2Rlc1RvUGFyZW50KSB7CiAgICAgICAgICAgIGFjdGl2YXRlQmluZGluZ3NPbkNvbnRpbnVvdXNOb2RlQXJyYXkocmVuZGVyZWROb2Rlc0FycmF5LCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIGlmIChvcHRpb25zWydhZnRlclJlbmRlciddKQogICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSwgbnVsbCwgW3JlbmRlcmVkTm9kZXNBcnJheSwgYmluZGluZ0NvbnRleHRbJyRkYXRhJ11dKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZW5kZXJlZE5vZGVzQXJyYXk7CiAgICB9CgogICAga28ucmVuZGVyVGVtcGxhdGUgPSBmdW5jdGlvbiAodGVtcGxhdGUsIGRhdGFPckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCB0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlck1vZGUpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICBpZiAoKG9wdGlvbnNbJ3RlbXBsYXRlRW5naW5lJ10gfHwgX3RlbXBsYXRlRW5naW5lKSA9PSB1bmRlZmluZWQpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2V0IGEgdGVtcGxhdGUgZW5naW5lIGJlZm9yZSBjYWxsaW5nIHJlbmRlclRlbXBsYXRlIik7CiAgICAgICAgcmVuZGVyTW9kZSA9IHJlbmRlck1vZGUgfHwgInJlcGxhY2VDaGlsZHJlbiI7CgogICAgICAgIGlmICh0YXJnZXROb2RlT3JOb2RlQXJyYXkpIHsKICAgICAgICAgICAgdmFyIGZpcnN0VGFyZ2V0Tm9kZSA9IGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CgogICAgICAgICAgICB2YXIgd2hlblRvRGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICghZmlyc3RUYXJnZXROb2RlKSB8fCAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KGZpcnN0VGFyZ2V0Tm9kZSk7IH07IC8vIFBhc3NpdmUgZGlzcG9zYWwgKG9uIG5leHQgZXZhbHVhdGlvbikKICAgICAgICAgICAgdmFyIGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkID0gKGZpcnN0VGFyZ2V0Tm9kZSAmJiByZW5kZXJNb2RlID09ICJyZXBsYWNlTm9kZSIpID8gZmlyc3RUYXJnZXROb2RlLnBhcmVudE5vZGUgOiBmaXJzdFRhcmdldE5vZGU7CgogICAgICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZSggLy8gU28gdGhlIERPTSBpcyBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgd2hlbiBhbnkgZGVwZW5kZW5jeSBjaGFuZ2VzCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIHdlJ3ZlIGdvdCBhIHByb3BlciBiaW5kaW5nIGNvbnRleHQgdG8gd29yayB3aXRoCiAgICAgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdDb250ZXh0ID0gKGRhdGFPckJpbmRpbmdDb250ZXh0ICYmIChkYXRhT3JCaW5kaW5nQ29udGV4dCBpbnN0YW5jZW9mIGtvLmJpbmRpbmdDb250ZXh0KSkKICAgICAgICAgICAgICAgICAgICAgICAgPyBkYXRhT3JCaW5kaW5nQ29udGV4dAogICAgICAgICAgICAgICAgICAgICAgICA6IG5ldyBrby5iaW5kaW5nQ29udGV4dChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGFPckJpbmRpbmdDb250ZXh0KSk7CgogICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQgc2VsZWN0aW5nIHRlbXBsYXRlIGFzIGEgZnVuY3Rpb24gb2YgdGhlIGRhdGEgYmVpbmcgcmVuZGVyZWQKICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVOYW1lID0gdHlwZW9mKHRlbXBsYXRlKSA9PSAnZnVuY3Rpb24nID8gdGVtcGxhdGUoYmluZGluZ0NvbnRleHRbJyRkYXRhJ10sIGJpbmRpbmdDb250ZXh0KSA6IHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWROb2Rlc0FycmF5ID0gZXhlY3V0ZVRlbXBsYXRlKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSwgdGVtcGxhdGVOYW1lLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlck1vZGUgPT0gInJlcGxhY2VOb2RlIikgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXROb2RlT3JOb2RlQXJyYXkgPSByZW5kZXJlZE5vZGVzQXJyYXk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0VGFyZ2V0Tm9kZSA9IGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICB7IGRpc3Bvc2VXaGVuOiB3aGVuVG9EaXNwb3NlLCBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIH0KICAgICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBXZSBkb24ndCB5ZXQgaGF2ZSBhIERPTSBub2RlIHRvIGV2YWx1YXRlLCBzbyB1c2UgYSBtZW1vIGFuZCByZW5kZXIgdGhlIHRlbXBsYXRlIGxhdGVyIHdoZW4gdGhlcmUgaXMgYSBET00gbm9kZQogICAgICAgICAgICByZXR1cm4ga28ubWVtb2l6YXRpb24ubWVtb2l6ZShmdW5jdGlvbiAoZG9tTm9kZSkgewogICAgICAgICAgICAgICAga28ucmVuZGVyVGVtcGxhdGUodGVtcGxhdGUsIGRhdGFPckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCBkb21Ob2RlLCAicmVwbGFjZU5vZGUiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfTsKCiAgICBrby5yZW5kZXJUZW1wbGF0ZUZvckVhY2ggPSBmdW5jdGlvbiAodGVtcGxhdGUsIGFycmF5T3JPYnNlcnZhYmxlQXJyYXksIG9wdGlvbnMsIHRhcmdldE5vZGUsIHBhcmVudEJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgLy8gU2luY2Ugc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyBhbHdheXMgY2FsbHMgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtIGFuZCB0aGVuCiAgICAgICAgLy8gYWN0aXZhdGVCaW5kaW5nc0NhbGxiYWNrIGZvciBhZGRlZCBpdGVtcywgd2UgY2FuIHN0b3JlIHRoZSBiaW5kaW5nIGNvbnRleHQgaW4gdGhlIGZvcm1lciB0byB1c2UgaW4gdGhlIGxhdHRlci4KICAgICAgICB2YXIgYXJyYXlJdGVtQ29udGV4dDsKCiAgICAgICAgLy8gVGhpcyB3aWxsIGJlIGNhbGxlZCBieSBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIHRvIGdldCB0aGUgbm9kZXMgdG8gYWRkIHRvIHRhcmdldE5vZGUKICAgICAgICB2YXIgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtID0gZnVuY3Rpb24gKGFycmF5VmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgIC8vIFN1cHBvcnQgc2VsZWN0aW5nIHRlbXBsYXRlIGFzIGEgZnVuY3Rpb24gb2YgdGhlIGRhdGEgYmVpbmcgcmVuZGVyZWQKICAgICAgICAgICAgYXJyYXlJdGVtQ29udGV4dCA9IHBhcmVudEJpbmRpbmdDb250ZXh0WydjcmVhdGVDaGlsZENvbnRleHQnXShrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFycmF5VmFsdWUpLCBvcHRpb25zWydhcyddKTsKICAgICAgICAgICAgYXJyYXlJdGVtQ29udGV4dFsnJGluZGV4J10gPSBpbmRleDsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlTmFtZSA9IHR5cGVvZih0ZW1wbGF0ZSkgPT0gJ2Z1bmN0aW9uJyA/IHRlbXBsYXRlKGFycmF5VmFsdWUsIGFycmF5SXRlbUNvbnRleHQpIDogdGVtcGxhdGU7CiAgICAgICAgICAgIHJldHVybiBleGVjdXRlVGVtcGxhdGUobnVsbCwgImlnbm9yZVRhcmdldE5vZGUiLCB0ZW1wbGF0ZU5hbWUsIGFycmF5SXRlbUNvbnRleHQsIG9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgLy8gVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIGhhcyBhZGRlZCBub2RlcyB0byB0YXJnZXROb2RlCiAgICAgICAgdmFyIGFjdGl2YXRlQmluZGluZ3NDYWxsYmFjayA9IGZ1bmN0aW9uKGFycmF5VmFsdWUsIGFkZGVkTm9kZXNBcnJheSwgaW5kZXgpIHsKICAgICAgICAgICAgYWN0aXZhdGVCaW5kaW5nc09uQ29udGludW91c05vZGVBcnJheShhZGRlZE5vZGVzQXJyYXksIGFycmF5SXRlbUNvbnRleHQpOwogICAgICAgICAgICBpZiAob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSkKICAgICAgICAgICAgICAgIG9wdGlvbnNbJ2FmdGVyUmVuZGVyJ10oYWRkZWROb2Rlc0FycmF5LCBhcnJheVZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB1bndyYXBwZWRBcnJheSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYXJyYXlPck9ic2VydmFibGVBcnJheSkgfHwgW107CiAgICAgICAgICAgIGlmICh0eXBlb2YgdW53cmFwcGVkQXJyYXkubGVuZ3RoID09ICJ1bmRlZmluZWQiKSAvLyBDb2VyY2Ugc2luZ2xlIHZhbHVlIGludG8gYXJyYXkKICAgICAgICAgICAgICAgIHVud3JhcHBlZEFycmF5ID0gW3Vud3JhcHBlZEFycmF5XTsKCiAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgYW55IGVudHJpZXMgbWFya2VkIGFzIGRlc3Ryb3llZAogICAgICAgICAgICB2YXIgZmlsdGVyZWRBcnJheSA9IGtvLnV0aWxzLmFycmF5RmlsdGVyKHVud3JhcHBlZEFycmF5LCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uc1snaW5jbHVkZURlc3Ryb3llZCddIHx8IGl0ZW0gPT09IHVuZGVmaW5lZCB8fCBpdGVtID09PSBudWxsIHx8ICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGl0ZW1bJ19kZXN0cm95J10pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIENhbGwgc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZywgaWdub3JpbmcgYW55IG9ic2VydmFibGVzIHVud3JhcHBlZCB3aXRoaW4gKG1vc3QgbGlrZWx5IGZyb20gYSBjYWxsYmFjayBmdW5jdGlvbikuCiAgICAgICAgICAgIC8vIElmIHRoZSBhcnJheSBpdGVtcyBhcmUgb2JzZXJ2YWJsZXMsIHRob3VnaCwgdGhleSB3aWxsIGJlIHVud3JhcHBlZCBpbiBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0gYW5kIG1hbmFnZWQgd2l0aGluIHNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcuCiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcsIG51bGwsIFt0YXJnZXROb2RlLCBmaWx0ZXJlZEFycmF5LCBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0sIG9wdGlvbnMsIGFjdGl2YXRlQmluZGluZ3NDYWxsYmFja10pOwoKICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogdGFyZ2V0Tm9kZSB9KTsKICAgIH07CgogICAgdmFyIHRlbXBsYXRlQ29tcHV0ZWREb21EYXRhS2V5ID0gJ19fa29fX3RlbXBsYXRlQ29tcHV0ZWREb21EYXRhS2V5X18nOwogICAgZnVuY3Rpb24gZGlzcG9zZU9sZENvbXB1dGVkQW5kU3RvcmVOZXdPbmUoZWxlbWVudCwgbmV3Q29tcHV0ZWQpIHsKICAgICAgICB2YXIgb2xkQ29tcHV0ZWQgPSBrby51dGlscy5kb21EYXRhLmdldChlbGVtZW50LCB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSk7CiAgICAgICAgaWYgKG9sZENvbXB1dGVkICYmICh0eXBlb2Yob2xkQ29tcHV0ZWQuZGlzcG9zZSkgPT0gJ2Z1bmN0aW9uJykpCiAgICAgICAgICAgIG9sZENvbXB1dGVkLmRpc3Bvc2UoKTsKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSwgKG5ld0NvbXB1dGVkICYmIG5ld0NvbXB1dGVkLmlzQWN0aXZlKCkpID8gbmV3Q29tcHV0ZWQgOiB1bmRlZmluZWQpOwogICAgfQoKICAgIGtvLmJpbmRpbmdIYW5kbGVyc1sndGVtcGxhdGUnXSA9IHsKICAgICAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICAgICAgLy8gU3VwcG9ydCBhbm9ueW1vdXMgdGVtcGxhdGVzCiAgICAgICAgICAgIHZhciBiaW5kaW5nVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgICAgIGlmICgodHlwZW9mIGJpbmRpbmdWYWx1ZSAhPSAic3RyaW5nIikgJiYgKCFiaW5kaW5nVmFsdWVbJ25hbWUnXSkgJiYgKGVsZW1lbnQubm9kZVR5cGUgPT0gMSB8fCBlbGVtZW50Lm5vZGVUeXBlID09IDgpKSB7CiAgICAgICAgICAgICAgICAvLyBJdCdzIGFuIGFub255bW91cyB0ZW1wbGF0ZSAtIHN0b3JlIHRoZSBlbGVtZW50IGNvbnRlbnRzLCB0aGVuIGNsZWFyIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVOb2RlcyA9IGVsZW1lbnQubm9kZVR5cGUgPT0gMSA/IGVsZW1lbnQuY2hpbGROb2RlcyA6IGtvLnZpcnR1YWxFbGVtZW50cy5jaGlsZE5vZGVzKGVsZW1lbnQpLAogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lciA9IGtvLnV0aWxzLm1vdmVDbGVhbmVkTm9kZXNUb0NvbnRhaW5lckVsZW1lbnQodGVtcGxhdGVOb2Rlcyk7IC8vIFRoaXMgYWxzbyByZW1vdmVzIHRoZSBub2RlcyBmcm9tIHRoZWlyIGN1cnJlbnQgcGFyZW50CiAgICAgICAgICAgICAgICBuZXcga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlKGVsZW1lbnQpWydub2RlcyddKGNvbnRhaW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHsgJ2NvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzJzogdHJ1ZSB9OwogICAgICAgIH0sCiAgICAgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZU5hbWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSksCiAgICAgICAgICAgICAgICBvcHRpb25zID0ge30sCiAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0gdHJ1ZSwKICAgICAgICAgICAgICAgIGRhdGFWYWx1ZSwKICAgICAgICAgICAgICAgIHRlbXBsYXRlQ29tcHV0ZWQgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZU5hbWUgIT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB0ZW1wbGF0ZU5hbWU7CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZU5hbWUgPSBvcHRpb25zWyduYW1lJ107CgogICAgICAgICAgICAgICAgLy8gU3VwcG9ydCAiaWYiLyJpZm5vdCIgY29uZGl0aW9ucwogICAgICAgICAgICAgICAgaWYgKCdpZicgaW4gb3B0aW9ucykKICAgICAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShvcHRpb25zWydpZiddKTsKICAgICAgICAgICAgICAgIGlmIChzaG91bGREaXNwbGF5ICYmICdpZm5vdCcgaW4gb3B0aW9ucykKICAgICAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0gIWtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUob3B0aW9uc1snaWZub3QnXSk7CgogICAgICAgICAgICAgICAgZGF0YVZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShvcHRpb25zWydkYXRhJ10pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoJ2ZvcmVhY2gnIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIC8vIFJlbmRlciBvbmNlIGZvciBlYWNoIGRhdGEgcG9pbnQgKHRyZWF0aW5nIGRhdGEgc2V0IGFzIGVtcHR5IGlmIHNob3VsZERpc3BsYXk9PWZhbHNlKQogICAgICAgICAgICAgICAgdmFyIGRhdGFBcnJheSA9IChzaG91bGREaXNwbGF5ICYmIG9wdGlvbnNbJ2ZvcmVhY2gnXSkgfHwgW107CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZUNvbXB1dGVkID0ga28ucmVuZGVyVGVtcGxhdGVGb3JFYWNoKHRlbXBsYXRlTmFtZSB8fCBlbGVtZW50LCBkYXRhQXJyYXksIG9wdGlvbnMsIGVsZW1lbnQsIGJpbmRpbmdDb250ZXh0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICghc2hvdWxkRGlzcGxheSkgewogICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZShlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJlbmRlciBvbmNlIGZvciB0aGlzIHNpbmdsZSBkYXRhIHBvaW50IChvciB1c2UgdGhlIHZpZXdNb2RlbCBpZiBubyBkYXRhIHdhcyBwcm92aWRlZCkKICAgICAgICAgICAgICAgIHZhciBpbm5lckJpbmRpbmdDb250ZXh0ID0gKCdkYXRhJyBpbiBvcHRpb25zKSA/CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGRhdGFWYWx1ZSwgb3B0aW9uc1snYXMnXSkgOiAgLy8gR2l2ZW4gYW4gZXhwbGl0aXQgJ2RhdGEnIHZhbHVlLCB3ZSBjcmVhdGUgYSBjaGlsZCBiaW5kaW5nIGNvbnRleHQgZm9yIGl0CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ0NvbnRleHQ7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBHaXZlbiBubyBleHBsaWNpdCAnZGF0YScgdmFsdWUsIHdlIHJldGFpbiB0aGUgc2FtZSBiaW5kaW5nIGNvbnRleHQKICAgICAgICAgICAgICAgIHRlbXBsYXRlQ29tcHV0ZWQgPSBrby5yZW5kZXJUZW1wbGF0ZSh0ZW1wbGF0ZU5hbWUgfHwgZWxlbWVudCwgaW5uZXJCaW5kaW5nQ29udGV4dCwgb3B0aW9ucywgZWxlbWVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEl0IG9ubHkgbWFrZXMgc2Vuc2UgdG8gaGF2ZSBhIHNpbmdsZSB0ZW1wbGF0ZSBjb21wdXRlZCBwZXIgZWxlbWVudCAob3RoZXJ3aXNlIHdoaWNoIG9uZSBzaG91bGQgaGF2ZSBpdHMgb3V0cHV0IGRpc3BsYXllZD8pCiAgICAgICAgICAgIGRpc3Bvc2VPbGRDb21wdXRlZEFuZFN0b3JlTmV3T25lKGVsZW1lbnQsIHRlbXBsYXRlQ29tcHV0ZWQpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gQW5vbnltb3VzIHRlbXBsYXRlcyBjYW4ndCBiZSByZXdyaXR0ZW4uIEdpdmUgYSBuaWNlIGVycm9yIG1lc3NhZ2UgaWYgeW91IHRyeSB0byBkbyBpdC4KICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzWyd0ZW1wbGF0ZSddID0gZnVuY3Rpb24oYmluZGluZ1ZhbHVlKSB7CiAgICAgICAgdmFyIHBhcnNlZEJpbmRpbmdWYWx1ZSA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsKGJpbmRpbmdWYWx1ZSk7CgogICAgICAgIGlmICgocGFyc2VkQmluZGluZ1ZhbHVlLmxlbmd0aCA9PSAxKSAmJiBwYXJzZWRCaW5kaW5nVmFsdWVbMF1bJ3Vua25vd24nXSkKICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIEl0IGxvb2tzIGxpa2UgYSBzdHJpbmcgbGl0ZXJhbCwgbm90IGFuIG9iamVjdCBsaXRlcmFsLCBzbyB0cmVhdCBpdCBhcyBhIG5hbWVkIHRlbXBsYXRlICh3aGljaCBpcyBhbGxvd2VkIGZvciByZXdyaXRpbmcpCgogICAgICAgIGlmIChrby5leHByZXNzaW9uUmV3cml0aW5nLmtleVZhbHVlQXJyYXlDb250YWluc0tleShwYXJzZWRCaW5kaW5nVmFsdWUsICJuYW1lIikpCiAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBOYW1lZCB0ZW1wbGF0ZXMgY2FuIGJlIHJld3JpdHRlbiwgc28gcmV0dXJuICJubyBlcnJvciIKICAgICAgICByZXR1cm4gIlRoaXMgdGVtcGxhdGUgZW5naW5lIGRvZXMgbm90IHN1cHBvcnQgYW5vbnltb3VzIHRlbXBsYXRlcyBuZXN0ZWQgd2l0aGluIGl0cyB0ZW1wbGF0ZXMiOwogICAgfTsKCiAgICBrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWyd0ZW1wbGF0ZSddID0gdHJ1ZTsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgnc2V0VGVtcGxhdGVFbmdpbmUnLCBrby5zZXRUZW1wbGF0ZUVuZ2luZSk7CmtvLmV4cG9ydFN5bWJvbCgncmVuZGVyVGVtcGxhdGUnLCBrby5yZW5kZXJUZW1wbGF0ZSk7Cgprby51dGlscy5jb21wYXJlQXJyYXlzID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBzdGF0dXNOb3RJbk9sZCA9ICdhZGRlZCcsIHN0YXR1c05vdEluTmV3ID0gJ2RlbGV0ZWQnOwoKICAgIC8vIFNpbXBsZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBMZXZlbnNodGVpbiBkaXN0YW5jZS4KICAgIGZ1bmN0aW9uIGNvbXBhcmVBcnJheXMob2xkQXJyYXksIG5ld0FycmF5LCBkb250TGltaXRNb3ZlcykgewogICAgICAgIG9sZEFycmF5ID0gb2xkQXJyYXkgfHwgW107CiAgICAgICAgbmV3QXJyYXkgPSBuZXdBcnJheSB8fCBbXTsKCiAgICAgICAgaWYgKG9sZEFycmF5Lmxlbmd0aCA8PSBuZXdBcnJheS5sZW5ndGgpCiAgICAgICAgICAgIHJldHVybiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkob2xkQXJyYXksIG5ld0FycmF5LCBzdGF0dXNOb3RJbk9sZCwgc3RhdHVzTm90SW5OZXcsIGRvbnRMaW1pdE1vdmVzKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkobmV3QXJyYXksIG9sZEFycmF5LCBzdGF0dXNOb3RJbk5ldywgc3RhdHVzTm90SW5PbGQsIGRvbnRMaW1pdE1vdmVzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkoc21sQXJyYXksIGJpZ0FycmF5LCBzdGF0dXNOb3RJblNtbCwgc3RhdHVzTm90SW5CaWcsIGRvbnRMaW1pdE1vdmVzKSB7CiAgICAgICAgdmFyIG15TWluID0gTWF0aC5taW4sCiAgICAgICAgICAgIG15TWF4ID0gTWF0aC5tYXgsCiAgICAgICAgICAgIGVkaXREaXN0YW5jZU1hdHJpeCA9IFtdLAogICAgICAgICAgICBzbWxJbmRleCwgc21sSW5kZXhNYXggPSBzbWxBcnJheS5sZW5ndGgsCiAgICAgICAgICAgIGJpZ0luZGV4LCBiaWdJbmRleE1heCA9IGJpZ0FycmF5Lmxlbmd0aCwKICAgICAgICAgICAgY29tcGFyZVJhbmdlID0gKGJpZ0luZGV4TWF4IC0gc21sSW5kZXhNYXgpIHx8IDEsCiAgICAgICAgICAgIG1heERpc3RhbmNlID0gc21sSW5kZXhNYXggKyBiaWdJbmRleE1heCArIDEsCiAgICAgICAgICAgIHRoaXNSb3csIGxhc3RSb3csCiAgICAgICAgICAgIGJpZ0luZGV4TWF4Rm9yUm93LCBiaWdJbmRleE1pbkZvclJvdzsKCiAgICAgICAgZm9yIChzbWxJbmRleCA9IDA7IHNtbEluZGV4IDw9IHNtbEluZGV4TWF4OyBzbWxJbmRleCsrKSB7CiAgICAgICAgICAgIGxhc3RSb3cgPSB0aGlzUm93OwogICAgICAgICAgICBlZGl0RGlzdGFuY2VNYXRyaXgucHVzaCh0aGlzUm93ID0gW10pOwogICAgICAgICAgICBiaWdJbmRleE1heEZvclJvdyA9IG15TWluKGJpZ0luZGV4TWF4LCBzbWxJbmRleCArIGNvbXBhcmVSYW5nZSk7CiAgICAgICAgICAgIGJpZ0luZGV4TWluRm9yUm93ID0gbXlNYXgoMCwgc21sSW5kZXggLSAxKTsKICAgICAgICAgICAgZm9yIChiaWdJbmRleCA9IGJpZ0luZGV4TWluRm9yUm93OyBiaWdJbmRleCA8PSBiaWdJbmRleE1heEZvclJvdzsgYmlnSW5kZXgrKykgewogICAgICAgICAgICAgICAgaWYgKCFiaWdJbmRleCkKICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IHNtbEluZGV4ICsgMTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFzbWxJbmRleCkgIC8vIFRvcCByb3cgLSB0cmFuc2Zvcm0gZW1wdHkgYXJyYXkgaW50byBuZXcgYXJyYXkgdmlhIGFkZGl0aW9ucwogICAgICAgICAgICAgICAgICAgIHRoaXNSb3dbYmlnSW5kZXhdID0gYmlnSW5kZXggKyAxOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoc21sQXJyYXlbc21sSW5kZXggLSAxXSA9PT0gYmlnQXJyYXlbYmlnSW5kZXggLSAxXSkKICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IGxhc3RSb3dbYmlnSW5kZXggLSAxXTsgICAgICAgICAgICAgICAgICAvLyBjb3B5IHZhbHVlIChubyBlZGl0KQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5vcnRoRGlzdGFuY2UgPSBsYXN0Um93W2JpZ0luZGV4XSB8fCBtYXhEaXN0YW5jZTsgICAgICAgLy8gbm90IGluIGJpZyAoZGVsZXRpb24pCiAgICAgICAgICAgICAgICAgICAgdmFyIHdlc3REaXN0YW5jZSA9IHRoaXNSb3dbYmlnSW5kZXggLSAxXSB8fCBtYXhEaXN0YW5jZTsgICAgLy8gbm90IGluIHNtYWxsIChhZGRpdGlvbikKICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IG15TWluKG5vcnRoRGlzdGFuY2UsIHdlc3REaXN0YW5jZSkgKyAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgZWRpdFNjcmlwdCA9IFtdLCBtZU1pbnVzT25lLCBub3RJblNtbCA9IFtdLCBub3RJbkJpZyA9IFtdOwogICAgICAgIGZvciAoc21sSW5kZXggPSBzbWxJbmRleE1heCwgYmlnSW5kZXggPSBiaWdJbmRleE1heDsgc21sSW5kZXggfHwgYmlnSW5kZXg7KSB7CiAgICAgICAgICAgIG1lTWludXNPbmUgPSBlZGl0RGlzdGFuY2VNYXRyaXhbc21sSW5kZXhdW2JpZ0luZGV4XSAtIDE7CiAgICAgICAgICAgIGlmIChiaWdJbmRleCAmJiBtZU1pbnVzT25lID09PSBlZGl0RGlzdGFuY2VNYXRyaXhbc21sSW5kZXhdW2JpZ0luZGV4LTFdKSB7CiAgICAgICAgICAgICAgICBub3RJblNtbC5wdXNoKGVkaXRTY3JpcHRbZWRpdFNjcmlwdC5sZW5ndGhdID0geyAgICAgLy8gYWRkZWQKICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJzogc3RhdHVzTm90SW5TbWwsCiAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogYmlnQXJyYXlbLS1iaWdJbmRleF0sCiAgICAgICAgICAgICAgICAgICAgJ2luZGV4JzogYmlnSW5kZXggfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc21sSW5kZXggJiYgbWVNaW51c09uZSA9PT0gZWRpdERpc3RhbmNlTWF0cml4W3NtbEluZGV4IC0gMV1bYmlnSW5kZXhdKSB7CiAgICAgICAgICAgICAgICBub3RJbkJpZy5wdXNoKGVkaXRTY3JpcHRbZWRpdFNjcmlwdC5sZW5ndGhdID0geyAgICAgLy8gZGVsZXRlZAogICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiBzdGF0dXNOb3RJbkJpZywKICAgICAgICAgICAgICAgICAgICAndmFsdWUnOiBzbWxBcnJheVstLXNtbEluZGV4XSwKICAgICAgICAgICAgICAgICAgICAnaW5kZXgnOiBzbWxJbmRleCB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVkaXRTY3JpcHQucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cyc6ICJyZXRhaW5lZCIsCiAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogYmlnQXJyYXlbLS1iaWdJbmRleF0gfSk7CiAgICAgICAgICAgICAgICAtLXNtbEluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobm90SW5TbWwubGVuZ3RoICYmIG5vdEluQmlnLmxlbmd0aCkgewogICAgICAgICAgICAvLyBTZXQgYSBsaW1pdCBvbiB0aGUgbnVtYmVyIG9mIGNvbnNlY3V0aXZlIG5vbi1tYXRjaGluZyBjb21wYXJpc29uczsgaGF2aW5nIGl0IGEgbXVsdGlwbGUgb2YKICAgICAgICAgICAgLy8gc21sSW5kZXhNYXgga2VlcHMgdGhlIHRpbWUgY29tcGxleGl0eSBvZiB0aGlzIGFsZ29yaXRobSBsaW5lYXIuCiAgICAgICAgICAgIHZhciBsaW1pdEZhaWxlZENvbXBhcmVzID0gc21sSW5kZXhNYXggKiAxMCwgZmFpbGVkQ29tcGFyZXMsCiAgICAgICAgICAgICAgICBhLCBkLCBub3RJblNtbEl0ZW0sIG5vdEluQmlnSXRlbTsKICAgICAgICAgICAgLy8gR28gdGhyb3VnaCB0aGUgaXRlbXMgdGhhdCBoYXZlIGJlZW4gYWRkZWQgYW5kIGRlbGV0ZWQgYW5kIHRyeSB0byBmaW5kIG1hdGNoZXMgYmV0d2VlbiB0aGVtLgogICAgICAgICAgICBmb3IgKGZhaWxlZENvbXBhcmVzID0gYSA9IDA7IChkb250TGltaXRNb3ZlcyB8fCBmYWlsZWRDb21wYXJlcyA8IGxpbWl0RmFpbGVkQ29tcGFyZXMpICYmIChub3RJblNtbEl0ZW0gPSBub3RJblNtbFthXSk7IGErKykgewogICAgICAgICAgICAgICAgZm9yIChkID0gMDsgbm90SW5CaWdJdGVtID0gbm90SW5CaWdbZF07IGQrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChub3RJblNtbEl0ZW1bJ3ZhbHVlJ10gPT09IG5vdEluQmlnSXRlbVsndmFsdWUnXSkgewogICAgICAgICAgICAgICAgICAgICAgICBub3RJblNtbEl0ZW1bJ21vdmVkJ10gPSBub3RJbkJpZ0l0ZW1bJ2luZGV4J107CiAgICAgICAgICAgICAgICAgICAgICAgIG5vdEluQmlnSXRlbVsnbW92ZWQnXSA9IG5vdEluU21sSXRlbVsnaW5kZXgnXTsKICAgICAgICAgICAgICAgICAgICAgICAgbm90SW5CaWcuc3BsaWNlKGQsMSk7ICAgICAgIC8vIFRoaXMgaXRlbSBpcyBtYXJrZWQgYXMgbW92ZWQ7IHNvIHJlbW92ZSBpdCBmcm9tIG5vdEluQmlnIGxpc3QKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkQ29tcGFyZXMgPSBkID0gMDsgICAgIC8vIFJlc2V0IGZhaWxlZCBjb21wYXJlcyBjb3VudCBiZWNhdXNlIHdlJ3JlIGNoZWNraW5nIGZvciBjb25zZWN1dGl2ZSBmYWlsdXJlcwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmYWlsZWRDb21wYXJlcyArPSBkOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBlZGl0U2NyaXB0LnJldmVyc2UoKTsKICAgIH0KCiAgICByZXR1cm4gY29tcGFyZUFycmF5czsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuY29tcGFyZUFycmF5cycsIGtvLnV0aWxzLmNvbXBhcmVBcnJheXMpOwoKKGZ1bmN0aW9uICgpIHsKICAgIC8vIE9iamVjdGl2ZToKICAgIC8vICogR2l2ZW4gYW4gaW5wdXQgYXJyYXksIGEgY29udGFpbmVyIERPTSBub2RlLCBhbmQgYSBmdW5jdGlvbiBmcm9tIGFycmF5IGVsZW1lbnRzIHRvIGFycmF5cyBvZiBET00gbm9kZXMsCiAgICAvLyAgIG1hcCB0aGUgYXJyYXkgZWxlbWVudHMgdG8gYXJyYXlzIG9mIERPTSBub2RlcywgY29uY2F0ZW5hdGUgdG9nZXRoZXIgYWxsIHRoZXNlIGFycmF5cywgYW5kIHVzZSB0aGVtIHRvIHBvcHVsYXRlIHRoZSBjb250YWluZXIgRE9NIG5vZGUKICAgIC8vICogTmV4dCB0aW1lIHdlJ3JlIGdpdmVuIHRoZSBzYW1lIGNvbWJpbmF0aW9uIG9mIHRoaW5ncyAod2l0aCB0aGUgYXJyYXkgcG9zc2libHkgaGF2aW5nIG11dGF0ZWQpLCB1cGRhdGUgdGhlIGNvbnRhaW5lciBET00gbm9kZQogICAgLy8gICBzbyB0aGF0IGl0cyBjaGlsZHJlbiBpcyBhZ2FpbiB0aGUgY29uY2F0ZW5hdGlvbiBvZiB0aGUgbWFwcGluZ3Mgb2YgdGhlIGFycmF5IGVsZW1lbnRzLCBidXQgZG9uJ3QgcmUtbWFwIGFueSBhcnJheSBlbGVtZW50cyB0aGF0IHdlCiAgICAvLyAgIHByZXZpb3VzbHkgbWFwcGVkIC0gcmV0YWluIHRob3NlIG5vZGVzLCBhbmQganVzdCBpbnNlcnQvZGVsZXRlIG90aGVyIG9uZXMKCiAgICAvLyAiY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzIiB3aWxsIGJlIGludm9rZWQgYWZ0ZXIgYW55ICJtYXBwaW5nIi1nZW5lcmF0ZWQgbm9kZXMgYXJlIGluc2VydGVkIGludG8gdGhlIGNvbnRhaW5lciBub2RlCiAgICAvLyBZb3UgY2FuIHVzZSB0aGlzLCBmb3IgZXhhbXBsZSwgdG8gYWN0aXZhdGUgYmluZGluZ3Mgb24gdGhvc2Ugbm9kZXMuCgogICAgZnVuY3Rpb24gZml4VXBOb2Rlc1RvQmVNb3ZlZE9yUmVtb3ZlZChjb250aWd1b3VzTm9kZUFycmF5KSB7CiAgICAgICAgLy8gQmVmb3JlIG1vdmluZywgZGVsZXRpbmcsIG9yIHJlcGxhY2luZyBhIHNldCBvZiBub2RlcyB0aGF0IHdlcmUgcHJldmlvdXNseSBvdXRwdXR0ZWQgYnkgdGhlICJtYXAiIGZ1bmN0aW9uLCB3ZSBoYXZlIHRvIHJlY29uY2lsZQogICAgICAgIC8vIHRoZW0gYWdhaW5zdCB3aGF0IGlzIGluIHRoZSBET00gcmlnaHQgbm93LiBJdCBtYXkgYmUgdGhhdCBzb21lIG9mIHRoZSBub2RlcyBoYXZlIGFscmVhZHkgYmVlbiByZW1vdmVkIGZyb20gdGhlIGRvY3VtZW50LAogICAgICAgIC8vIG9yIHRoYXQgbmV3IG5vZGVzIG1pZ2h0IGhhdmUgYmVlbiBpbnNlcnRlZCBpbiB0aGUgbWlkZGxlLCBmb3IgZXhhbXBsZSBieSBhIGJpbmRpbmcuIEFsc28sIHRoZXJlIG1heSBwcmV2aW91c2x5IGhhdmUgYmVlbgogICAgICAgIC8vIGxlYWRpbmcgY29tbWVudCBub2RlcyAoY3JlYXRlZCBieSByZXdyaXR0ZW4gc3RyaW5nLWJhc2VkIHRlbXBsYXRlcykgdGhhdCBoYXZlIHNpbmNlIGJlZW4gcmVtb3ZlZCBkdXJpbmcgYmluZGluZy4KICAgICAgICAvLyBTbywgdGhpcyBmdW5jdGlvbiB0cmFuc2xhdGVzIHRoZSBvbGQgIm1hcCIgb3V0cHV0IGFycmF5IGludG8gaXRzIGJlc3QgZ3Vlc3Mgb2Ygd2hhdCBzZXQgb2YgY3VycmVudCBET00gbm9kZXMgc2hvdWxkIGJlIHJlbW92ZWQuCiAgICAgICAgLy8KICAgICAgICAvLyBSdWxlczoKICAgICAgICAvLyAgIFtBXSBBbnkgbGVhZGluZyBub2RlcyB0aGF0IGFyZW4ndCBpbiB0aGUgZG9jdW1lbnQgYW55IG1vcmUgc2hvdWxkIGJlIGlnbm9yZWQKICAgICAgICAvLyAgICAgICBUaGVzZSBtb3N0IGxpa2VseSBjb3JyZXNwb25kIHRvIG1lbW9pemF0aW9uIG5vZGVzIHRoYXQgd2VyZSBhbHJlYWR5IHJlbW92ZWQgZHVyaW5nIGJpbmRpbmcKICAgICAgICAvLyAgICAgICBTZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvNDQwCiAgICAgICAgLy8gICBbQl0gV2Ugd2FudCB0byBvdXRwdXQgYSBjb250aWd1b3VzIHNlcmllcyBvZiBub2RlcyB0aGF0IGFyZSBzdGlsbCBpbiB0aGUgZG9jdW1lbnQuIFNvLCBpZ25vcmUgYW55IG5vZGVzIHRoYXQKICAgICAgICAvLyAgICAgICBoYXZlIGFscmVhZHkgYmVlbiByZW1vdmVkLCBhbmQgaW5jbHVkZSBhbnkgbm9kZXMgdGhhdCBoYXZlIGJlZW4gaW5zZXJ0ZWQgYW1vbmcgdGhlIHByZXZpb3VzIGNvbGxlY3Rpb24KCiAgICAgICAgLy8gUnVsZSBbQV0KICAgICAgICB3aGlsZSAoY29udGlndW91c05vZGVBcnJheS5sZW5ndGggJiYgIWtvLnV0aWxzLmRvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChjb250aWd1b3VzTm9kZUFycmF5WzBdKSkKICAgICAgICAgICAgY29udGlndW91c05vZGVBcnJheS5zcGxpY2UoMCwgMSk7CgogICAgICAgIC8vIFJ1bGUgW0JdCiAgICAgICAgaWYgKGNvbnRpZ3VvdXNOb2RlQXJyYXkubGVuZ3RoID4gMSkgewogICAgICAgICAgICAvLyBCdWlsZCB1cCB0aGUgYWN0dWFsIG5ldyBjb250aWd1b3VzIG5vZGUgc2V0CiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gY29udGlndW91c05vZGVBcnJheVswXSwgbGFzdCA9IGNvbnRpZ3VvdXNOb2RlQXJyYXlbY29udGlndW91c05vZGVBcnJheS5sZW5ndGggLSAxXSwgbmV3Q29udGlndW91c1NldCA9IFtjdXJyZW50XTsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgIT09IGxhc3QpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50Lm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgaWYgKCFjdXJyZW50KSAvLyBXb24ndCBoYXBwZW4sIGV4Y2VwdCBpZiB0aGUgZGV2ZWxvcGVyIGhhcyBtYW51YWxseSByZW1vdmVkIHNvbWUgRE9NIGVsZW1lbnRzICh0aGVuIHdlJ3JlIGluIGFuIHVuZGVmaW5lZCBzY2VuYXJpbykKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBuZXdDb250aWd1b3VzU2V0LnB1c2goY3VycmVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC4uLiB0aGVuIG11dGF0ZSB0aGUgaW5wdXQgYXJyYXkgdG8gbWF0Y2ggdGhpcy4KICAgICAgICAgICAgLy8gKFRoZSBmb2xsb3dpbmcgbGluZSByZXBsYWNlcyB0aGUgY29udGVudHMgb2YgY29udGlndW91c05vZGVBcnJheSB3aXRoIG5ld0NvbnRpZ3VvdXNTZXQpCiAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UuYXBwbHkoY29udGlndW91c05vZGVBcnJheSwgWzAsIGNvbnRpZ3VvdXNOb2RlQXJyYXkubGVuZ3RoXS5jb25jYXQobmV3Q29udGlndW91c1NldCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29udGlndW91c05vZGVBcnJheTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYXBOb2RlQW5kUmVmcmVzaFdoZW5DaGFuZ2VkKGNvbnRhaW5lck5vZGUsIG1hcHBpbmcsIHZhbHVlVG9NYXAsIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgaW5kZXgpIHsKICAgICAgICAvLyBNYXAgdGhpcyBhcnJheSB2YWx1ZSBpbnNpZGUgYSBkZXBlbmRlbnRPYnNlcnZhYmxlIHNvIHdlIHJlLW1hcCB3aGVuIGFueSBkZXBlbmRlbmN5IGNoYW5nZXMKICAgICAgICB2YXIgbWFwcGVkTm9kZXMgPSBbXTsKICAgICAgICB2YXIgZGVwZW5kZW50T2JzZXJ2YWJsZSA9IGtvLmRlcGVuZGVudE9ic2VydmFibGUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBuZXdNYXBwZWROb2RlcyA9IG1hcHBpbmcodmFsdWVUb01hcCwgaW5kZXgpIHx8IFtdOwoKICAgICAgICAgICAgLy8gT24gc3Vic2VxdWVudCBldmFsdWF0aW9ucywganVzdCByZXBsYWNlIHRoZSBwcmV2aW91c2x5LWluc2VydGVkIERPTSBub2RlcwogICAgICAgICAgICBpZiAobWFwcGVkTm9kZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAga28udXRpbHMucmVwbGFjZURvbU5vZGVzKGZpeFVwTm9kZXNUb0JlTW92ZWRPclJlbW92ZWQobWFwcGVkTm9kZXMpLCBuZXdNYXBwZWROb2Rlcyk7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKQogICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgbnVsbCwgW3ZhbHVlVG9NYXAsIG5ld01hcHBlZE5vZGVzLCBpbmRleF0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXBsYWNlIHRoZSBjb250ZW50cyBvZiB0aGUgbWFwcGVkTm9kZXMgYXJyYXksIHRoZXJlYnkgdXBkYXRpbmcgdGhlIHJlY29yZAogICAgICAgICAgICAvLyBvZiB3aGljaCBub2RlcyB3b3VsZCBiZSBkZWxldGVkIGlmIHZhbHVlVG9NYXAgd2FzIGl0c2VsZiBsYXRlciByZW1vdmVkCiAgICAgICAgICAgIG1hcHBlZE5vZGVzLnNwbGljZSgwLCBtYXBwZWROb2Rlcy5sZW5ndGgpOwogICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwobWFwcGVkTm9kZXMsIG5ld01hcHBlZE5vZGVzKTsKICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogY29udGFpbmVyTm9kZSwgZGlzcG9zZVdoZW46IGZ1bmN0aW9uKCkgeyByZXR1cm4gKG1hcHBlZE5vZGVzLmxlbmd0aCA9PSAwKSB8fCAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KG1hcHBlZE5vZGVzWzBdKSB9IH0pOwogICAgICAgIHJldHVybiB7IG1hcHBlZE5vZGVzIDogbWFwcGVkTm9kZXMsIGRlcGVuZGVudE9ic2VydmFibGUgOiAoZGVwZW5kZW50T2JzZXJ2YWJsZS5pc0FjdGl2ZSgpID8gZGVwZW5kZW50T2JzZXJ2YWJsZSA6IHVuZGVmaW5lZCkgfTsKICAgIH0KCiAgICB2YXIgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5ID0gInNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmdfbGFzdE1hcHBpbmdSZXN1bHQiOwoKICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcgPSBmdW5jdGlvbiAoZG9tTm9kZSwgYXJyYXksIG1hcHBpbmcsIG9wdGlvbnMsIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcykgewogICAgICAgIC8vIENvbXBhcmUgdGhlIHByb3ZpZGVkIGFycmF5IGFnYWluc3QgdGhlIHByZXZpb3VzIG9uZQogICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdmFyIGlzRmlyc3RFeGVjdXRpb24gPSBrby51dGlscy5kb21EYXRhLmdldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXkpID09PSB1bmRlZmluZWQ7CiAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0ID0ga28udXRpbHMuZG9tRGF0YS5nZXQoZG9tTm9kZSwgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5KSB8fCBbXTsKICAgICAgICB2YXIgbGFzdEFycmF5ID0ga28udXRpbHMuYXJyYXlNYXAobGFzdE1hcHBpbmdSZXN1bHQsIGZ1bmN0aW9uICh4KSB7IHJldHVybiB4LmFycmF5RW50cnk7IH0pOwogICAgICAgIHZhciBlZGl0U2NyaXB0ID0ga28udXRpbHMuY29tcGFyZUFycmF5cyhsYXN0QXJyYXksIGFycmF5KTsKCiAgICAgICAgLy8gQnVpbGQgdGhlIG5ldyBtYXBwaW5nIHJlc3VsdAogICAgICAgIHZhciBuZXdNYXBwaW5nUmVzdWx0ID0gW107CiAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwogICAgICAgIHZhciBuZXdNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwoKICAgICAgICB2YXIgbm9kZXNUb0RlbGV0ZSA9IFtdOwogICAgICAgIHZhciBpdGVtc1RvUHJvY2VzcyA9IFtdOwogICAgICAgIHZhciBpdGVtc0ZvckJlZm9yZVJlbW92ZUNhbGxiYWNrcyA9IFtdOwogICAgICAgIHZhciBpdGVtc0Zvck1vdmVDYWxsYmFja3MgPSBbXTsKICAgICAgICB2YXIgaXRlbXNGb3JBZnRlckFkZENhbGxiYWNrcyA9IFtdOwogICAgICAgIHZhciBtYXBEYXRhOwoKICAgICAgICBmdW5jdGlvbiBpdGVtTW92ZWRPclJldGFpbmVkKGVkaXRTY3JpcHRJbmRleCwgb2xkUG9zaXRpb24pIHsKICAgICAgICAgICAgbWFwRGF0YSA9IGxhc3RNYXBwaW5nUmVzdWx0W29sZFBvc2l0aW9uXTsKICAgICAgICAgICAgaWYgKG5ld01hcHBpbmdSZXN1bHRJbmRleCAhPT0gb2xkUG9zaXRpb24pCiAgICAgICAgICAgICAgICBpdGVtc0Zvck1vdmVDYWxsYmFja3NbZWRpdFNjcmlwdEluZGV4XSA9IG1hcERhdGE7CiAgICAgICAgICAgIC8vIFNpbmNlIHVwZGF0aW5nIHRoZSBpbmRleCBtaWdodCBjaGFuZ2UgdGhlIG5vZGVzLCBkbyBzbyBiZWZvcmUgY2FsbGluZyBmaXhVcE5vZGVzVG9CZU1vdmVkT3JSZW1vdmVkCiAgICAgICAgICAgIG1hcERhdGEuaW5kZXhPYnNlcnZhYmxlKG5ld01hcHBpbmdSZXN1bHRJbmRleCsrKTsKICAgICAgICAgICAgZml4VXBOb2Rlc1RvQmVNb3ZlZE9yUmVtb3ZlZChtYXBEYXRhLm1hcHBlZE5vZGVzKTsKICAgICAgICAgICAgbmV3TWFwcGluZ1Jlc3VsdC5wdXNoKG1hcERhdGEpOwogICAgICAgICAgICBpdGVtc1RvUHJvY2Vzcy5wdXNoKG1hcERhdGEpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrKGNhbGxiYWNrLCBpdGVtcykgewogICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBuID0gaXRlbXMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1zW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChpdGVtc1tpXS5tYXBwZWROb2RlcywgZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobm9kZSwgaSwgaXRlbXNbaV0uYXJyYXlFbnRyeSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGVkaXRTY3JpcHRJdGVtLCBtb3ZlZEluZGV4OyBlZGl0U2NyaXB0SXRlbSA9IGVkaXRTY3JpcHRbaV07IGkrKykgewogICAgICAgICAgICBtb3ZlZEluZGV4ID0gZWRpdFNjcmlwdEl0ZW1bJ21vdmVkJ107CiAgICAgICAgICAgIHN3aXRjaCAoZWRpdFNjcmlwdEl0ZW1bJ3N0YXR1cyddKSB7CiAgICAgICAgICAgICAgICBjYXNlICJkZWxldGVkIjoKICAgICAgICAgICAgICAgICAgICBpZiAobW92ZWRJbmRleCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEgPSBsYXN0TWFwcGluZ1Jlc3VsdFtsYXN0TWFwcGluZ1Jlc3VsdEluZGV4XTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgdHJhY2tpbmcgY2hhbmdlcyB0byB0aGUgbWFwcGluZyBmb3IgdGhlc2Ugbm9kZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hcERhdGEuZGVwZW5kZW50T2JzZXJ2YWJsZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEuZGVwZW5kZW50T2JzZXJ2YWJsZS5kaXNwb3NlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBRdWV1ZSB0aGVzZSBub2RlcyBmb3IgbGF0ZXIgcmVtb3ZhbAogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvRGVsZXRlLnB1c2guYXBwbHkobm9kZXNUb0RlbGV0ZSwgZml4VXBOb2Rlc1RvQmVNb3ZlZE9yUmVtb3ZlZChtYXBEYXRhLm1hcHBlZE5vZGVzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zWydiZWZvcmVSZW1vdmUnXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNGb3JCZWZvcmVSZW1vdmVDYWxsYmFja3NbaV0gPSBtYXBEYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNUb1Byb2Nlc3MucHVzaChtYXBEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBsYXN0TWFwcGluZ1Jlc3VsdEluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAicmV0YWluZWQiOgogICAgICAgICAgICAgICAgICAgIGl0ZW1Nb3ZlZE9yUmV0YWluZWQoaSwgbGFzdE1hcHBpbmdSZXN1bHRJbmRleCsrKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlICJhZGRlZCI6CiAgICAgICAgICAgICAgICAgICAgaWYgKG1vdmVkSW5kZXggIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpdGVtTW92ZWRPclJldGFpbmVkKGksIG1vdmVkSW5kZXgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEgPSB7IGFycmF5RW50cnk6IGVkaXRTY3JpcHRJdGVtWyd2YWx1ZSddLCBpbmRleE9ic2VydmFibGU6IGtvLm9ic2VydmFibGUobmV3TWFwcGluZ1Jlc3VsdEluZGV4KyspIH07CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld01hcHBpbmdSZXN1bHQucHVzaChtYXBEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNUb1Byb2Nlc3MucHVzaChtYXBEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0ZpcnN0RXhlY3V0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNGb3JBZnRlckFkZENhbGxiYWNrc1tpXSA9IG1hcERhdGE7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxsIGJlZm9yZU1vdmUgZmlyc3QgYmVmb3JlIGFueSBjaGFuZ2VzIGhhdmUgYmVlbiBtYWRlIHRvIHRoZSBET00KICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYmVmb3JlTW92ZSddLCBpdGVtc0Zvck1vdmVDYWxsYmFja3MpOwoKICAgICAgICAvLyBOZXh0IHJlbW92ZSBub2RlcyBmb3IgZGVsZXRlZCBpdGVtcyAob3IganVzdCBjbGVhbiBpZiB0aGVyZSdzIGEgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrKQogICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChub2Rlc1RvRGVsZXRlLCBvcHRpb25zWydiZWZvcmVSZW1vdmUnXSA/IGtvLmNsZWFuTm9kZSA6IGtvLnJlbW92ZU5vZGUpOwoKICAgICAgICAvLyBOZXh0IGFkZC9yZW9yZGVyIHRoZSByZW1haW5pbmcgaXRlbXMgKHdpbGwgaW5jbHVkZSBkZWxldGVkIGl0ZW1zIGlmIHRoZXJlJ3MgYSBiZWZvcmVSZW1vdmUgY2FsbGJhY2spCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5leHROb2RlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZG9tTm9kZSksIGxhc3ROb2RlLCBub2RlOyBtYXBEYXRhID0gaXRlbXNUb1Byb2Nlc3NbaV07IGkrKykgewogICAgICAgICAgICAvLyBHZXQgbm9kZXMgZm9yIG5ld2x5IGFkZGVkIGl0ZW1zCiAgICAgICAgICAgIGlmICghbWFwRGF0YS5tYXBwZWROb2RlcykKICAgICAgICAgICAgICAgIGtvLnV0aWxzLmV4dGVuZChtYXBEYXRhLCBtYXBOb2RlQW5kUmVmcmVzaFdoZW5DaGFuZ2VkKGRvbU5vZGUsIG1hcHBpbmcsIG1hcERhdGEuYXJyYXlFbnRyeSwgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzLCBtYXBEYXRhLmluZGV4T2JzZXJ2YWJsZSkpOwoKICAgICAgICAgICAgLy8gUHV0IG5vZGVzIGluIHRoZSByaWdodCBwbGFjZSBpZiB0aGV5IGFyZW4ndCB0aGVyZSBhbHJlYWR5CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBub2RlID0gbWFwRGF0YS5tYXBwZWROb2Rlc1tqXTsgbmV4dE5vZGUgPSBub2RlLm5leHRTaWJsaW5nLCBsYXN0Tm9kZSA9IG5vZGUsIGorKykgewogICAgICAgICAgICAgICAgaWYgKG5vZGUgIT09IG5leHROb2RlKQogICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcihkb21Ob2RlLCBub2RlLCBsYXN0Tm9kZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJ1biB0aGUgY2FsbGJhY2tzIGZvciBuZXdseSBhZGRlZCBub2RlcyAoZm9yIGV4YW1wbGUsIHRvIGFwcGx5IGJpbmRpbmdzLCBldGMuKQogICAgICAgICAgICBpZiAoIW1hcERhdGEuaW5pdGlhbGl6ZWQgJiYgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMobWFwRGF0YS5hcnJheUVudHJ5LCBtYXBEYXRhLm1hcHBlZE5vZGVzLCBtYXBEYXRhLmluZGV4T2JzZXJ2YWJsZSk7CiAgICAgICAgICAgICAgICBtYXBEYXRhLmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gSWYgdGhlcmUncyBhIGJlZm9yZVJlbW92ZSBjYWxsYmFjaywgY2FsbCBpdCBhZnRlciByZW9yZGVyaW5nLgogICAgICAgIC8vIE5vdGUgdGhhdCB3ZSBhc3N1bWUgdGhhdCB0aGUgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrIHdpbGwgdXN1YWxseSBiZSB1c2VkIHRvIHJlbW92ZSB0aGUgbm9kZXMgdXNpbmcKICAgICAgICAvLyBzb21lIHNvcnQgb2YgYW5pbWF0aW9uLCB3aGljaCBpcyB3aHkgd2UgZmlyc3QgcmVvcmRlciB0aGUgbm9kZXMgdGhhdCB3aWxsIGJlIHJlbW92ZWQuIElmIHRoZQogICAgICAgIC8vIGNhbGxiYWNrIGluc3RlYWQgcmVtb3ZlcyB0aGUgbm9kZXMgcmlnaHQgYXdheSwgaXQgd291bGQgYmUgbW9yZSBlZmZpY2llbnQgdG8gc2tpcCByZW9yZGVyaW5nIHRoZW0uCiAgICAgICAgLy8gUGVyaGFwcyB3ZSdsbCBtYWtlIHRoYXQgY2hhbmdlIGluIHRoZSBmdXR1cmUgaWYgdGhpcyBzY2VuYXJpbyBiZWNvbWVzIG1vcmUgY29tbW9uLgogICAgICAgIGNhbGxDYWxsYmFjayhvcHRpb25zWydiZWZvcmVSZW1vdmUnXSwgaXRlbXNGb3JCZWZvcmVSZW1vdmVDYWxsYmFja3MpOwoKICAgICAgICAvLyBGaW5hbGx5IGNhbGwgYWZ0ZXJNb3ZlIGFuZCBhZnRlckFkZCBjYWxsYmFja3MKICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYWZ0ZXJNb3ZlJ10sIGl0ZW1zRm9yTW92ZUNhbGxiYWNrcyk7CiAgICAgICAgY2FsbENhbGxiYWNrKG9wdGlvbnNbJ2FmdGVyQWRkJ10sIGl0ZW1zRm9yQWZ0ZXJBZGRDYWxsYmFja3MpOwoKICAgICAgICAvLyBTdG9yZSBhIGNvcHkgb2YgdGhlIGFycmF5IGl0ZW1zIHdlIGp1c3QgY29uc2lkZXJlZCBzbyB3ZSBjYW4gZGlmZmVyZW5jZSBpdCBuZXh0IHRpbWUKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXksIG5ld01hcHBpbmdSZXN1bHQpOwogICAgfQp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nJywga28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyk7CmtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewogICAgdGhpc1snYWxsb3dUZW1wbGF0ZVJld3JpdGluZyddID0gZmFsc2U7Cn0KCmtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IG5ldyBrby50ZW1wbGF0ZUVuZ2luZSgpOwprby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICB2YXIgdXNlTm9kZXNJZkF2YWlsYWJsZSA9ICEoa28udXRpbHMuaWVWZXJzaW9uIDwgOSksIC8vIElFPDkgY2xvbmVOb2RlIGRvZXNuJ3Qgd29yayBwcm9wZXJseQogICAgICAgIHRlbXBsYXRlTm9kZXNGdW5jID0gdXNlTm9kZXNJZkF2YWlsYWJsZSA/IHRlbXBsYXRlU291cmNlWydub2RlcyddIDogbnVsbCwKICAgICAgICB0ZW1wbGF0ZU5vZGVzID0gdGVtcGxhdGVOb2Rlc0Z1bmMgPyB0ZW1wbGF0ZVNvdXJjZVsnbm9kZXMnXSgpIDogbnVsbDsKCiAgICBpZiAodGVtcGxhdGVOb2RlcykgewogICAgICAgIHJldHVybiBrby51dGlscy5tYWtlQXJyYXkodGVtcGxhdGVOb2Rlcy5jbG9uZU5vZGUodHJ1ZSkuY2hpbGROb2Rlcyk7CiAgICB9IGVsc2UgewogICAgICAgIHZhciB0ZW1wbGF0ZVRleHQgPSB0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KHRlbXBsYXRlVGV4dCk7CiAgICB9Cn07Cgprby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSA9IG5ldyBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSgpOwprby5zZXRUZW1wbGF0ZUVuZ2luZShrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSk7Cgprby5leHBvcnRTeW1ib2woJ25hdGl2ZVRlbXBsYXRlRW5naW5lJywga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUpOwooZnVuY3Rpb24oKSB7CiAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gRGV0ZWN0IHdoaWNoIHZlcnNpb24gb2YganF1ZXJ5LXRtcGwgeW91J3JlIHVzaW5nLiBVbmZvcnR1bmF0ZWx5IGpxdWVyeS10bXBsCiAgICAgICAgLy8gZG9lc24ndCBleHBvc2UgYSB2ZXJzaW9uIG51bWJlciwgc28gd2UgaGF2ZSB0byBpbmZlciBpdC4KICAgICAgICAvLyBOb3RlIHRoYXQgYXMgb2YgS25vY2tvdXQgMS4zLCB3ZSBvbmx5IHN1cHBvcnQgalF1ZXJ5LnRtcGwgMS4wLjBwcmUgYW5kIGxhdGVyLAogICAgICAgIC8vIHdoaWNoIEtPIGludGVybmFsbHkgcmVmZXJzIHRvIGFzIHZlcnNpb24gIjIiLCBzbyBvbGRlciB2ZXJzaW9ucyBhcmUgbm8gbG9uZ2VyIGRldGVjdGVkLgogICAgICAgIHZhciBqUXVlcnlUbXBsVmVyc2lvbiA9IHRoaXMualF1ZXJ5VG1wbFZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICgodHlwZW9mKGpRdWVyeSkgPT0gInVuZGVmaW5lZCIpIHx8ICEoalF1ZXJ5Wyd0bXBsJ10pKQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIC8vIFNpbmNlIGl0IGV4cG9zZXMgbm8gb2ZmaWNpYWwgdmVyc2lvbiBudW1iZXIsIHdlIHVzZSBvdXIgb3duIG51bWJlcmluZyBzeXN0ZW0uIFRvIGJlIHVwZGF0ZWQgYXMganF1ZXJ5LXRtcGwgZXZvbHZlcy4KICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChqUXVlcnlbJ3RtcGwnXVsndGFnJ11bJ3RtcGwnXVsnb3BlbiddLnRvU3RyaW5nKCkuaW5kZXhPZignX18nKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU2luY2UgMS4wLjBwcmUsIGN1c3RvbSB0YWdzIHNob3VsZCBhcHBlbmQgbWFya3VwIHRvIGFuIGFycmF5IGNhbGxlZCAiX18iCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDI7IC8vIEZpbmFsIHZlcnNpb24gb2YganF1ZXJ5LnRtcGwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaChleCkgeyAvKiBBcHBhcmVudGx5IG5vdCB0aGUgdmVyc2lvbiB3ZSB3ZXJlIGxvb2tpbmcgZm9yICovIH0KCiAgICAgICAgICAgIHJldHVybiAxOyAvLyBBbnkgb2xkZXIgdmVyc2lvbiB0aGF0IHdlIGRvbid0IHN1cHBvcnQKICAgICAgICB9KSgpOwoKICAgICAgICBmdW5jdGlvbiBlbnN1cmVIYXNSZWZlcmVuY2VkSlF1ZXJ5VGVtcGxhdGVzKCkgewogICAgICAgICAgICBpZiAoalF1ZXJ5VG1wbFZlcnNpb24gPCAyKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3VyIHZlcnNpb24gb2YgalF1ZXJ5LnRtcGwgaXMgdG9vIG9sZC4gUGxlYXNlIHVwZ3JhZGUgdG8galF1ZXJ5LnRtcGwgMS4wLjBwcmUgb3IgbGF0ZXIuIik7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBleGVjdXRlVGVtcGxhdGUoY29tcGlsZWRUZW1wbGF0ZSwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnlbJ3RtcGwnXShjb21waWxlZFRlbXBsYXRlLCBkYXRhLCBqUXVlcnlUZW1wbGF0ZU9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgdGhpc1sncmVuZGVyVGVtcGxhdGVTb3VyY2UnXSA9IGZ1bmN0aW9uKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgZW5zdXJlSGFzUmVmZXJlbmNlZEpRdWVyeVRlbXBsYXRlcygpOwoKICAgICAgICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgc3RvcmVkIGEgcHJlY29tcGlsZWQgdmVyc2lvbiBvZiB0aGlzIHRlbXBsYXRlIChkb24ndCB3YW50IHRvIHJlcGFyc2Ugb24gZXZlcnkgcmVuZGVyKQogICAgICAgICAgICB2YXIgcHJlY29tcGlsZWQgPSB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcpOwogICAgICAgICAgICBpZiAoIXByZWNvbXBpbGVkKSB7CiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVUZXh0ID0gdGVtcGxhdGVTb3VyY2VbJ3RleHQnXSgpIHx8ICIiOwogICAgICAgICAgICAgICAgLy8gV3JhcCBpbiAid2l0aCgkd2hhdGV2ZXIua29CaW5kaW5nQ29udGV4dCkgeyAuLi4gfSIKICAgICAgICAgICAgICAgIHRlbXBsYXRlVGV4dCA9ICJ7e2tvX3dpdGggJGl0ZW0ua29CaW5kaW5nQ29udGV4dH19IiArIHRlbXBsYXRlVGV4dCArICJ7ey9rb193aXRofX0iOwoKICAgICAgICAgICAgICAgIHByZWNvbXBpbGVkID0galF1ZXJ5Wyd0ZW1wbGF0ZSddKG51bGwsIHRlbXBsYXRlVGV4dCk7CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcsIHByZWNvbXBpbGVkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGRhdGEgPSBbYmluZGluZ0NvbnRleHRbJyRkYXRhJ11dOyAvLyBQcmV3cmFwIHRoZSBkYXRhIGluIGFuIGFycmF5IHRvIHN0b3AganF1ZXJ5LnRtcGwgZnJvbSB0cnlpbmcgdG8gdW53cmFwIGFueSBhcnJheXMKICAgICAgICAgICAgdmFyIGpRdWVyeVRlbXBsYXRlT3B0aW9ucyA9IGpRdWVyeVsnZXh0ZW5kJ10oeyAna29CaW5kaW5nQ29udGV4dCc6IGJpbmRpbmdDb250ZXh0IH0sIG9wdGlvbnNbJ3RlbXBsYXRlT3B0aW9ucyddKTsKCiAgICAgICAgICAgIHZhciByZXN1bHROb2RlcyA9IGV4ZWN1dGVUZW1wbGF0ZShwcmVjb21waWxlZCwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKTsKICAgICAgICAgICAgcmVzdWx0Tm9kZXNbJ2FwcGVuZFRvJ10oZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikpOyAvLyBVc2luZyAiYXBwZW5kVG8iIGZvcmNlcyBqUXVlcnkvalF1ZXJ5LnRtcGwgdG8gcGVyZm9ybSBuZWNlc3NhcnkgY2xlYW51cCB3b3JrCgogICAgICAgICAgICBqUXVlcnlbJ2ZyYWdtZW50cyddID0ge307IC8vIENsZWFyIGpRdWVyeSdzIGZyYWdtZW50IGNhY2hlIHRvIGF2b2lkIGEgbWVtb3J5IGxlYWsgYWZ0ZXIgYSBsYXJnZSBudW1iZXIgb2YgdGVtcGxhdGUgcmVuZGVycwogICAgICAgICAgICByZXR1cm4gcmVzdWx0Tm9kZXM7CiAgICAgICAgfTsKCiAgICAgICAgdGhpc1snY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10gPSBmdW5jdGlvbihzY3JpcHQpIHsKICAgICAgICAgICAgcmV0dXJuICJ7e2tvX2NvZGUgKChmdW5jdGlvbigpIHsgcmV0dXJuICIgKyBzY3JpcHQgKyAiIH0pKCkpIH19IjsKICAgICAgICB9OwoKICAgICAgICB0aGlzWydhZGRUZW1wbGF0ZSddID0gZnVuY3Rpb24odGVtcGxhdGVOYW1lLCB0ZW1wbGF0ZU1hcmt1cCkgewogICAgICAgICAgICBkb2N1bWVudC53cml0ZSgiPHNjcmlwdCB0eXBlPSd0ZXh0L2h0bWwnIGlkPSciICsgdGVtcGxhdGVOYW1lICsgIic+IiArIHRlbXBsYXRlTWFya3VwICsgIjwvc2NyaXB0PiIpOwogICAgICAgIH07CgogICAgICAgIGlmIChqUXVlcnlUbXBsVmVyc2lvbiA+IDApIHsKICAgICAgICAgICAgalF1ZXJ5Wyd0bXBsJ11bJ3RhZyddWydrb19jb2RlJ10gPSB7CiAgICAgICAgICAgICAgICBvcGVuOiAiX18ucHVzaCgkMSB8fCAnJyk7IgogICAgICAgICAgICB9OwogICAgICAgICAgICBqUXVlcnlbJ3RtcGwnXVsndGFnJ11bJ2tvX3dpdGgnXSA9IHsKICAgICAgICAgICAgICAgIG9wZW46ICJ3aXRoKCQxKSB7IiwKICAgICAgICAgICAgICAgIGNsb3NlOiAifSAiCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfTsKCiAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlID0gbmV3IGtvLnRlbXBsYXRlRW5naW5lKCk7CgogICAgLy8gVXNlIHRoaXMgb25lIGJ5IGRlZmF1bHQgKm9ubHkgaWYganF1ZXJ5LnRtcGwgaXMgcmVmZXJlbmNlZCoKICAgIHZhciBqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZSA9IG5ldyBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUoKTsKICAgIGlmIChqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZS5qUXVlcnlUbXBsVmVyc2lvbiA+IDApCiAgICAgICAga28uc2V0VGVtcGxhdGVFbmdpbmUoanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lSW5zdGFuY2UpOwoKICAgIGtvLmV4cG9ydFN5bWJvbCgnanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lJywga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lKTsKfSkoKTsKfSk7Cn0pKHdpbmRvdyxkb2N1bWVudCxuYXZpZ2F0b3Isd2luZG93WyJqUXVlcnkiXSk7Cn0pKCk7CgpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZS9jb252ZW50aW9uL2tub2Nrb3V0LmVuZ2luZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAna25vY2tvdXQnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2tvX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIga28gPSBfX2tvX187CgogICAgdmFyIHdoZW4gPSB1dGlsLndoZW4sIGVhY2ggPSBfLmVhY2gsIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksIGZpbmQgPSBfLmZpbmQsIGtub2Nrb3V0VGVtcGxhdGVzID0gewogICAgfTsKICAgIHZhciBpbml0S25vY2tvdXRJbnRlZ3JhdGlvbiA9IGZ1bmN0aW9uICh0ZW1wbGF0ZU1hbmFnZXIpIHsKICAgICAgICB2YXIgVGhydXN0VGVtcGxhdGVTb3VyY2UgPSAoa28pLnRlbXBsYXRlU291cmNlcy50aHJ1c3RUZW1wbGF0ZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSkgewogICAgICAgICAgICB0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3RUZW1wbGF0ZVNvdXJjZS5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgIHRleHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC50ZW1wbGF0ZS5odG1sOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRlbXBsYXRlLmh0bWwgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoJ1RocnVzdCBUZW1wbGF0ZSBkb2VzIG5vdCBzdXBwb3J0IHJld3JpdGluZy4uLicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LnRlbXBsYXRlLmRhdGEpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRlbXBsYXRlLmRhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC50ZW1wbGF0ZS5kYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoYXQudGVtcGxhdGUuZGF0YVtrZXldID0gYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICAvLyBCZWdpbiBpbnRlZ3JhdGlvbiBvZiB0ZW1wbGF0ZSBwbHVnaW4sIHdpdGggS25vY2tvdXQuCiAgICAgICAgdmFyIG9sZEVuZ2luZSA9IChrbykubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2U7CiAgICAgICAgdmFyIGNvbnZlbnRpb25UZW1wbGF0ZUVuZ2luZSA9IChrbykuY29udmVudGlvblRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewogICAgICAgIH07CiAgICAgICAgY29udmVudGlvblRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IGtvLnV0aWxzLmV4dGVuZChuZXcgKGtvKS50ZW1wbGF0ZUVuZ2luZSgpLCB7CiAgICAgICAgICAgIHJlbmRlclRlbXBsYXRlU291cmNlOiBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBpZih0ZW1wbGF0ZVNvdXJjZS50ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBldmFsdWF0b3JzID0gdGhpcy5ldmFsdWF0b3JzOwogICAgICAgICAgICAgICAgICAgIGlmKCFldmFsdWF0b3JzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZhbHVhdG9ycyA9IGV2YWx1YXRvcnMgPSB0ZW1wbGF0ZU1hbmFnZXIuY29uZmlnLmV2YWx1YXRvcnNbdGVtcGxhdGVNYW5hZ2VyLmNvbmZpZy5kZWZhdWx0VHlwZV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBwcmVjb21waWxlZCA9IHRlbXBsYXRlU291cmNlWydkYXRhJ10oJ3ByZWNvbXBpbGVkJyk7CiAgICAgICAgICAgICAgICAgICAgaWYoIXByZWNvbXBpbGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZWNvbXBpbGVkID0gdGVtcGxhdGVNYW5hZ2VyLmNvbXBpbGUoJ3t7IHdpdGgoJGRhdGEpIHsgfX0gJyArIHRlbXBsYXRlU291cmNlLnRleHQoKSArICIge3sgfSB9fSIpOwogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcsIHByZWNvbXBpbGVkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gUnVuIHRoZSB0ZW1wbGF0ZSBhbmQgcGFyc2UgaXRzIG91dHB1dCBpbnRvIGFuIGFycmF5IG9mIERPTSBlbGVtZW50cwogICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJlZE1hcmt1cCA9IHRlbXBsYXRlU291cmNlLnRlbXBsYXRlLmNvbXBpbGVkKGJpbmRpbmdDb250ZXh0KS5yZXBsYWNlKC9ccysvZywgIiAiKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGtvKS51dGlscy5wYXJzZUh0bWxGcmFnbWVudChyZW5kZXJlZE1hcmt1cCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gb2xkRW5naW5lLnJlbmRlclRlbXBsYXRlU291cmNlLmFwcGx5KG9sZEVuZ2luZSwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrOiBmdW5jdGlvbiAoc2NyaXB0KSB7CiAgICAgICAgICAgICAgICBpZighdGhpcy5ldmFsdWF0b3JDYWNoZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBldmFsdWF0b3JzID0gdGVtcGxhdGVNYW5hZ2VyLmNvbmZpZy5ldmFsdWF0b3JzW3RlbXBsYXRlTWFuYWdlci5jb25maWcuZGVmYXVsdFR5cGVdOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXZhbHVhdG9yQ2FjaGUgPSBldmFsdWF0b3JzLmxlZnQgKyBzY3JpcHQgKyBldmFsdWF0b3JzLnJpZ2h0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdG9yQ2FjaGU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1ha2VUZW1wbGF0ZVNvdXJjZTogZnVuY3Rpb24gKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KSB7CiAgICAgICAgICAgICAgICAvLyBOYW1lZCB0ZW1wbGF0ZQogICAgICAgICAgICAgICAgaWYodHlwZW9mIHRlbXBsYXRlID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRlZmluaXRpb24gPSB0ZW1wbGF0ZU1hbmFnZXIuZ2V0KHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICBpZihkZWZpbml0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGhydXN0VGVtcGxhdGVTb3VyY2UoZGVmaW5pdGlvbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9sZEVuZ2luZS5tYWtlVGVtcGxhdGVTb3VyY2UuYXBwbHkob2xkRW5naW5lLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgKGtvKS5zZXRUZW1wbGF0ZUVuZ2luZShuZXcgKGtvKS5jb252ZW50aW9uVGVtcGxhdGVFbmdpbmUoKSk7CiAgICB9OwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgY291bnRkb3duOiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIGluaXRLbm9ja291dEludGVncmF0aW9uKHRocnVzdC50ZW1wbGF0ZSk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMua25vY2tvdXRFbmdpbmUgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9a25vY2tvdXQuZW5naW5lLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3RlbXBsYXRlL2NvbnZlbnRpb24vdGVtcGxhdGUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90ZW1wbGF0ZS90ZW1wbGF0ZS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBURU1QTEFURVMgPSAndGVtcGxhdGVzJywgd2hlbiA9IHV0aWwud2hlbiwgZWFjaCA9IF8uZWFjaCwgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwgZmluZCA9IF8uZmluZDsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgVEVNUExBVEVTCiAgICAgICAgXSwKICAgICAgICBpbml0OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICB2YXIgdGVtcGxhdGVzID0gbW9kLmNvbnZlbnRpb24oVEVNUExBVEVTKSwgaW52ZXJ0ZWRUZW1wbGF0ZXMgPSB1dGlsLmludmVydCh0ZW1wbGF0ZXMpLCBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgaWYodGVtcGxhdGVzKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVmZXJzID0gW107CiAgICAgICAgICAgICAgICBlYWNoKHRlbXBsYXRlcywgZnVuY3Rpb24gKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIHRlbXBsYXRlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnMucHVzaChmYWNhZGUuZmV0Y2godGVtcGxhdGUpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZhY2FkZS5sb2FkaW5nUHJvbWlzZSA9IHdoZW4uYWxsKGRlZmVycykudGhlbihmdW5jdGlvbiAobG9hZGVkVGVtcGxhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgLypqc2hpbnQgbG9vcGZ1bmM6dHJ1ZSAqLwogICAgICAgICAgICAgICAgICAgIF8uZWFjaChpbnZlcnRlZFRlbXBsYXRlcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gXy5maW5kKGxvYWRlZFRlbXBsYXRlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB4LnNob3J0TmFtZSA9PT0gaSB8fCB4Lm5hbWUgPT09IGk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGVJbnN0YW5jZS50ZW1wbGF0ZXNbaV0gPSB0ZW1wbGF0ZS5jb21waWxlZDsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWNhZGUubG9hZGluZ1Byb21pc2UgfHwgdW5kZWZpbmVkOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnRlbXBsYXRlID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXRlbXBsYXRlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3NwYS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFByb3ZpZGVzIHRocnVzdCBjb25maWd1cmF0aW9uCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LnNwYQogICAgQHN1Ym1vZHVsZSB0aHJ1c3Quc3BhLmNvbmZpZwogICAgKiovCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0LnNwYS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnY2ZnJywgCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnbWVkaWF0b3InCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvbWVkaWF0b3IuCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9zcGEvY29udmVudGlvbi9zdGFydCcsIAogICAgICAgICd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3BhbGluaycKICAgIF07CiAgICAvKioKICAgIERlZmluZXMgdGhlIHZhbHVlIG9mIGN1c3RvbSBwYXJhbWV0ZXJzLgogICAgWW91IGNhbiBhbHNvIGRlZmluZSBjdXN0b20gcGFyYW1ldGVycyB0byBiZSBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgYW5kIHRoZW4gdXNlIHRoZW0gaW4geW91ciByb3V0ZXMKICAgIAogICAgQHByb3BlcnR5IHBhcmFtcwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7T2JqZWN0fQogICAgKiovCiAgICBleHBvcnRzLnBhcmFtcyA9IHsKICAgIH07CiAgICAvKioKICAgIFRoZSBwcmVkZmluZWQgcm91dGVzIHRvIGJlIHVzZWQgYnkgc3BhLgogICAgCiAgICBAcHJvcGVydHkgcm91dGVzCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtPYmplY3R9CiAgICAqKi8KICAgIGV4cG9ydHMucm91dGVzID0gewogICAgfTsKICAgIC8qKgogICAgVGhlIGZpbGUgZXhzdGVuaW9uIHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQgd2hlbiByZXNvbHZpbmcgcm91dGVzIGFuZCBzdGFydGluZyBtb2R1bGVzLgogICAgCiAgICBAcHJvcGVydHkgZmlsZUV4dGVuc2lvbgogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgKiovCiAgICBleHBvcnRzLmZpbGVFeHRlbnNpb24gPSAnLmh0bWwnOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3BhbGluaycsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2RvbS9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvc3BhL3NwYS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBzdWJqcXVlcnkgPSBfX3N1YmpxdWVyeV9fOwoKICAgIHZhciAkID0gc3VianF1ZXJ5LnRRdWVyeTsKICAgIHZhciBwYXJzZUZ1bGxIcmVmID0gZnVuY3Rpb24gKGhyZWYpIHsKICAgICAgICB2YXIgYmFzZVVybCA9IGxvY2F0aW9uLnBhdGhuYW1lLnN1YnN0cmluZygwLCBsb2NhdGlvbi5wYXRobmFtZS5sYXN0SW5kZXhPZignLycpKTsKICAgICAgICBpZihocmVmLmluZGV4T2YoJy8nKSAhPSAtMSkgewogICAgICAgICAgICBocmVmID0gaHJlZi5zdWJzdHJpbmcoaHJlZi5sYXN0SW5kZXhPZignLycpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBocmVmID0gJy8nICsgaHJlZjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJhc2VVcmwgKyBocmVmOwogICAgfTsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QuZG9tCiAgICBAc3VibW9kdWxlIHRocnVzdC5kb20uY29udmVudGlvbgogICAgKiovCiAgICAvKioKICAgICogIyBfX3RocnVzdC9kb21fXyBDb252ZW50aW9uIC0gU2luZ2xlIFBhZ2UgQXBwIExpbmsKICAgICoKICAgICogUmVxdWlyZXMgdGhydXN0L2RvbQogICAgKgogICAgKiBAZm9yIHRocnVzdC5kb20uY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgc3BhO2luawogICAgKiovCiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBvcmJpdDogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgY29uZmlnID0gdGhydXN0LmNvbmZpZywgc3BhID0gdGhydXN0LnNwYTsKICAgICAgICAgICAgJC5vbignY2xpY2snLCAnYScsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICB2YXIgbGluayA9IHBhcnNlRnVsbEhyZWYodGhpcy5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSk7CiAgICAgICAgICAgICAgICBpZihsaW5rLmluZGV4T2YoY29uZmlnLnVybC5wYXRoKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHNwYS5uYXZpZ2F0ZShsaW5rKTsKICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnNwYWxpbmsgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9c3BhbGluay5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9zcGEvY29udmVudGlvbi9zdGFydCcsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3NwYS9zcGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnNwYQogICAgQHN1Ym1vZHVsZSB0aHJ1c3Quc3BhLmNvbnZlbnRpb24KICAgICoqLwogICAgLyoqCiAgICAqICMgX190aHJ1c3Qvc3BhX18gQ29udmVudGlvbiAtIFN0YXJ0CiAgICAqCiAgICAqIFRoZSBzaW5nbGUgcGFnZSBhcHAgc3RhcnQgY29udmVudGlvbiwgZG9lcyB0aGUgYWN0dWFsIHN0YXJ0aW5nIG9mIHRoZSBwbHVnaW4sIGluIGFkZGl0aW9uIGl0IGFsc28gZGVsYXlzCiAgICAqIGZ1bGwgb3JiaXQsIHVudGlsIGFueSBtb2R1bGUgaXQgaGFzIHN0YXJ0ZWQgaGFzIGJlZW4gbG9hZGVkLgogICAgKgogICAgKiBAZm9yIHRocnVzdC5zcGEuY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgc3RhcnQKICAgICoqLwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdmFyIHJvdXRlciA9IHRocnVzdC5zcGE7CiAgICAgICAgICAgIHJvdXRlci5zdGFydCgpOwogICAgICAgICAgICByZXR1cm4gdGhydXN0LnNwYS5zdGFydGluZ01vZHVsZVByb21pc2UgfHwgbnVsbDsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5zdGFydCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdGFydC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9tZWRpYXRvci9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ3RocnVzdC9ldmVudHMnLCAndGhydXN0L2ZhY2FkZScsICdoYXMnLCAndGhydXN0L2NvbmZpZycsICcuL2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19sb2dfXywgX19ldmVudHNfXywgX19mYWNhZGVfXywgX19oYXNfXywgX19jb25maWdfXywgX19tZWRpYXRvckNvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9oYXMuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgLy9pbXBvcnQgZXZlbnRzID0gbW9kdWxlKCd0aHJ1c3QvZXZlbnRzJyk7CiAgICB2YXIgZXZlbnRzID0gX19ldmVudHNfXzsKCiAgICB2YXIgRXZlbnRzID0gZXZlbnRzLkV2ZW50czsKICAgIHZhciBmYWNhZGUgPSBfX2ZhY2FkZV9fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIHZhciBtZWRpYXRvckNvbmZpZyA9IF9fbWVkaWF0b3JDb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdNZWRpYXRvcic7CiAgICAvLyBWYXJpYWJsZSBkZWNsYXJhdGlvbi4KICAgICAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGV4dGVuZCA9IC8vIHN0cmluZyBmb3JtYXQgbWV0aG9kCiAgICBfLmV4dGVuZCwgd2hlbiA9IC8vIG9iamVjdCBleHRlbnNpb24gbWV0aG9kCiAgICB1dGlsLndoZW4sIG1lbW9pemUgPSBfLm1lbW9pemUsIG1lZGlhdG9yLCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIHZhciBjID0gY29uZmlnOwogICAgLy8jcmVnaW9uIEZhY2FkZQogICAgLyoqCiAgICBDcmVhdGVzIGEgbmV3IG1lZGlhdG9yIGZhY2FkZSBmb3IgdGhlIGdpdmVuIG1vZHVsZS4KICAgIAogICAgQGZvciB0aHJ1c3QubWVkaWF0b3IKICAgIEBjbGFzcyB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3JGYWNhZGUKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgIEBwYXJhbSB7dGhydXN0Lk1lZGlhdG9yfSBwYXJlbnQgVGhlIHBhcmVudCBtZWRpYXRvciB0byBjcmVhdGUgdGhlIGZhY2FkZSBvbi4KICAgICoqLwogICAgdmFyIE1lZGlhdG9yRmFjYWRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbWVkaWF0b3JGYWNhZGUgPSBmYWNhZGUuY3JlYXRlRmFjYWRlKGZ1bmN0aW9uIChtb2R1bGUsIHBhcmVudCkgewogICAgICAgICAgICB0aGlzLm5hbWUgPSBtb2R1bGUubmFtZTsKICAgICAgICAgICAgdGhpcy5tb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gcGFyZW50Ll9jYWxsYmFja3M7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cyhtb2R1bGUpOwogICAgICAgIH0pOwogICAgICAgIF8uZXh0ZW5kKG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZSwgRXZlbnRzKTsKICAgICAgICAvKioKICAgICAgICBEdXJpbmcgdGhlIHN0YXJ0IG9mIGEgbWVkaWF0b3IgZmFjYWRlLCBzdGFydCBjcmVhdGVzIHRoZSBpbnRlcm5hbCBzdWJzY3JpcHRpb25zIGFycmF5LgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yRmFjYWRlCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgaWYoIXRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucykgewogICAgICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuc3RhcnQgPSBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuaW5pdDsKICAgICAgICAvKioKICAgICAgICBPdmVycmlkZXMgdGhlIHN1YnNjcmliZSBtZXRob2QsIGFuZCB0cmFja3MgdGhlIGFueSBldmVudCB0aGF0IGlzIGJvdW5kLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yRmFjYWRlCiAgICAgICAgQG1ldGhvZCBzdWJzY3JpYmUKICAgICAgICAqKi8KICAgICAgICAobWVkaWF0b3JGYWNhZGUpLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICBldmVudHM6IGV2ZW50cywKICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjaywKICAgICAgICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIEV2ZW50cy5zdWJzY3JpYmUuY2FsbCh0aGlzLCBldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICB9OwogICAgICAgIC8qKgogICAgICAgIFVuc3Vic2NyaWJlcyBmcm9tIGFsbCBldmVudHMgdGhhdCB3ZXJlIHN1YnNjcmliZWQgdG8uCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3JGYWNhZGUKICAgICAgICBAbWV0aG9kIHN0b3AKICAgICAgICAqKi8KICAgICAgICBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuc3RvcCA9IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIGlmKHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucykgewogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN1YiA9IHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9uc1tpXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKHN1Yi5ldmVudHMsIHN1Yi5jYWxsYmFjaywgc3ViLmNvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIHJldHVybiBtZWRpYXRvckZhY2FkZTsKICAgIH0pKCk7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vIE91ciBkZWZhdWx0IG5hbWVzcGFjZSBwcmVmaXguCiAgICAvKioKICAgIE1lZGlhdG9yIGNsYXNzLgogICAgVGhpcyBjcmVhdGVzIGEgaW5zdGFuY2Ugb2YgdGhlIG1lZGlhdG9yLCBmb3IgdXNlIGluc2lkZSB0aHJ1c3QuCiAgICAKICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yCiAgICBAY2xhc3MgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBtZWRpYXRvci4KICAgICoqLwogICAgdmFyIE1lZGlhdG9yID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyNlbmRyZWdpb24KICAgICAgICBmdW5jdGlvbiBNZWRpYXRvcihuYW1lLCBjb25maWcpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBhcHBQYXRoID0gY29uZmlnICYmIGNvbmZpZy51cmwgJiYgY29uZmlnLnVybC5wYXRoOwogICAgICAgICAgICB0aGF0Lm5hbWUgPSBuYW1lOwogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdNZWRpYXRvcjogQ3JlYXRpbmcgbmV3IE1lZGlhdG9yIHswfScsIG5hbWUpKTsKICAgICAgICAgICAgdGhhdC5pbml0RXZlbnRzKCk7CiAgICAgICAgICAgIHRoYXQuc3Vic2NyaWJlKCd0aHJ1c3QvcmVhZHknLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBmYWxzZSAmJiBsb2cuaW5mbygnTWVkaWF0b3I6IFJlYWR5IScpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLmluaXRFdmVudHMgPSAvLyNyZWdpb24gRXZlbnRzCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uICh0bywgaW5pdCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCwgb25jZSkgewogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgaWYoZmFjYWRlcy5tZWRpYXRvciAmJiAhKGZhY2FkZXMubWVkaWF0b3IgaW5zdGFuY2VvZiBNZWRpYXRvckZhY2FkZSkpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignIm1lZGlhdG9yIiBpcyBhIHJlc2VydmVkIHByb3BlcnR5Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1lZGlhdG9yOwogICAgICAgICAgICBpZihmYWNhZGVzLm1lZGlhdG9yKSB7CiAgICAgICAgICAgICAgICBmYWNhZGVzLm1lZGlhdG9yLnVwZGF0ZUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICAgICAgbWVkaWF0b3IgPSBmYWNhZGVzLm1lZGlhdG9yOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbWVkaWF0b3IgPSBmYWNhZGVzLm1lZGlhdG9yID0gKG1vZCkubWVkaWF0b3IgPSBuZXcgTWVkaWF0b3JGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWVkaWF0b3I7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5jb25maWcgPSBtZWRpYXRvckNvbmZpZzsKICAgICAgICByZXR1cm4gTWVkaWF0b3I7CiAgICB9KSgpOwogICAgZXhwb3J0cy5NZWRpYXRvciA9IE1lZGlhdG9yOyAgICAKICAgIC8vIEdldCB0aGUgYWN0dWFsIGV2ZW50IG1ldGhvZHMgb250byB0aGUgTWVkaWF0b3IKICAgIF8uZXh0ZW5kKE1lZGlhdG9yLnByb3RvdHlwZSwgRXZlbnRzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9tZWRpYXRvcicsIFsndGhydXN0L21lZGlhdG9yL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3QvZGF0YS9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICdqcXVlcnknLCAndGhydXN0L2xvZycsICcuL2NvbmZpZycsICd0aHJ1c3QvY29uZmlnJywgJy4vZXZlbnQuZmFjdG9yeScsICcuL3Jlc3BvbnNlLnF1ZXVlJywgJ3RocnVzdC9ldmVudHMnLCAndGhydXN0L2ZhY2FkZScsICcuL2V2ZW50LnR5cGVzJywgJ2hhcyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18sIF9falF1ZXJ5X18sIF9fbG9nX18sIF9fY29uZmlnX18sIF9fdENvbmZpZ19fLCBfX2V2ZW50RmFjdG9yeV9fLCBfX3Jlc3BvbnNlUXVldWVfXywgX19ldmVudHNfXywgX19mYWNhZGVfXywgX19ldmVudFR5cGVzX18sIF9faGFzX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvZGF0YS9kYXRhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9qcXVlcnkuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBqUXVlcnkgPSBfX2pRdWVyeV9fOwoKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIHZhciB0Q29uZmlnID0gX190Q29uZmlnX187CgogICAgdmFyIGV2ZW50RmFjdG9yeSA9IF9fZXZlbnRGYWN0b3J5X187CgogICAgdmFyIHJlc3BvbnNlUXVldWUgPSBfX3Jlc3BvbnNlUXVldWVfXzsKCiAgICB2YXIgUmVzcG9uc2VRdWV1ZSA9IHJlc3BvbnNlUXVldWUuUmVzcG9uc2VRdWV1ZTsKICAgIHZhciBldmVudHMgPSBfX2V2ZW50c19fOwoKICAgIHZhciBFdmVudHMgPSBldmVudHMuRXZlbnRzOwogICAgdmFyIGZhY2FkZSA9IF9fZmFjYWRlX187CgogICAgdmFyIGV2ZW50VHlwZXMgPSBfX2V2ZW50VHlwZXNfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdEYXRhJzsKICAgIGNvbmZpZzsKICAgIC8vIFZhcmlhYmxlIGRlY2xhcmF0aW9uLgogICAgICAgIHZhciBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gXy5leHRlbmQsIHdoZW4gPSB1dGlsLndoZW4sIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBhamF4ID0galF1ZXJ5LmFqYXgsIHVpZCA9IF8udW5pcXVlSWQsIGRhdGFFdmVudFdhaXQgPSBldmVudFR5cGVzWyd3YWl0J10sIGRhdGFFdmVudFN0YXJ0ID0gZXZlbnRUeXBlc1snc3RhcnQnXSwgZGF0YUV2ZW50U3RvcCA9IGV2ZW50VHlwZXNbJ3N0b3AnXSwgZGF0YUV2ZW50U3RhdHVzID0gZXZlbnRUeXBlc1snc3RhdHVzJ10sIGFyZ3VtZW50UmVzb2x2ZXIgPSBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgfTsKICAgIH07CiAgICBqUXVlcnkuYWpheFNldHRpbmdzLnRyYWRpdGlvbmFsID0gISF0Q29uZmlnLnVybC50cmFkaXRpb25hbEVuY29kaW5nOwogICAgdmFyIGpEb2MgPSBqUXVlcnkoZG9jdW1lbnQpOwogICAgZXZlbnRGYWN0b3J5LmluaXQoakRvYyk7CiAgICAvLyNyZWdpb24gRGF0YUZhY2FkZQogICAgLyoqCiAgICBUaGUgZGF0YSBmYWNhZGUgdGhhdCBpcyBoYW5kZWQgb2ZmIHRvIG1vZHVsZXMuCiAgICAKICAgIAogICAgRW5hYmxlcyBkYXRhIHRyYW5zcG9ydCwgdXNpbmcgalF1ZXJ5IGZvciB0aHJ1c3QuCiAgICAKICAgIEBmb3IgdGhydXN0LmRhdGEKICAgIEBjbGFzcyB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgQHBhcmFtIHt0aHJ1c3QuZGF0YS5EYXRhfSBwYXJlbnQgVGhlIHBhcmVudCB0aHJ1c3QgZGF0YSBvYmplY3QgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yLgogICAgQGNvbnN0cnVjdG9yCiAgICAqKi8KICAgIHZhciBEYXRhRmFjYWRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZGF0YUZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZHVsZSwgcGFyZW50KSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG1vZHVsZS5uYW1lICsgJy1kYXRhJzsKICAgICAgICAgICAgdGhpcy5tb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gcGFyZW50Ll9jYWxsYmFja3M7CiAgICAgICAgICAgIHRoaXMucmVzcG9uc2VRdWV1ZSA9IHBhcmVudC5yZXNwb25zZVF1ZXVlOwogICAgICAgICAgICB0aGlzLmluaXRFdmVudHMoKTsKICAgICAgICAgICAgdGhpcy5kZWZhdWx0cyA9IHBhcmVudC5kZWZhdWx0czsKICAgICAgICAgICAgdGhpcy5hcHBQYXRoID0gcGFyZW50LmFwcFBhdGg7CiAgICAgICAgfSk7CiAgICAgICAgXy5leHRlbmQoZGF0YUZhY2FkZS5wcm90b3R5cGUsIGV2ZW50cyk7CiAgICAgICAgcmV0dXJuIGRhdGFGYWNhZGU7CiAgICB9KSgpOwogICAgLy8jZW5kcmVnaW9uCiAgICAvKioKICAgIFRoZSBtYXN0ZXIgZGF0YSBwbHVnaW4uCiAgICAKICAgIAogICAgRW5hYmxlcyBkYXRhIHRyYW5zcG9ydCwgdXNpbmcgalF1ZXJ5IGZvciB0aHJ1c3QuCiAgICAKICAgIEBmb3IgdGhydXN0LmRhdGEKICAgIEBjbGFzcyB0aHJ1c3QuZGF0YS5EYXRhCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGhydXN0IGluc3RhbmNlIG5hbWUuCiAgICBAcGFyYW0ge3RocnVzdC5tZWRpYXRvci5NZWRpYXRvcn0gbWVkaWF0b3IgVGhlIHRocnVzdCBtZWRpYXRvciBpbnN0YW5jZS4KICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIHRocnVzdCBpbnN0YW5jZSBjb25maWd1cmF0aW9uLgogICAgQGNvbnN0cnVjdG9yCiAgICAqKi8KICAgIHZhciBEYXRhID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyNlbmRyZWdpb24KICAgICAgICBmdW5jdGlvbiBEYXRhKG5hbWUsIG1lZGlhdG9yLCBjb25maWcpIHsKICAgICAgICAgICAgaWYoIW5hbWUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRGF0YTogbW9kdWxlIG5hbWUgbXVzdCBiZSBkZWZpbmVkLicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIHRoaXMucmVzcG9uc2VRdWV1ZSA9IG5ldyBSZXNwb25zZVF1ZXVlKHRoaXMsIGNvbmZpZy5kYXRhLnN0YXJ0VGltZW91dCwgY29uZmlnLmRhdGEuZmluaXNoVGltZW91dCk7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1ZygnRGF0YTogQ3JlYXRpbmcgbmV3IERhdGEnKTsKICAgICAgICAgICAgdGhpcy5tZWRpYXRvciA9IG1lZGlhdG9yOwogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSAodGhpcykubWVkaWF0b3IuX2NhbGxiYWNrczsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnRzKCk7CiAgICAgICAgICAgIHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgICAgICAgICAgICBjYWNoZTogY29uZmlnLmRhdGEuY2FjaGUsCiAgICAgICAgICAgICAgICBiZWZvcmVTZW5kOiBldmVudEZhY3RvcnkuYmVmb3JlU2VuZE1ldGhvZCwKICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbicsCiAgICAgICAgICAgICAgICB0eXBlOiAnUE9TVCcsCiAgICAgICAgICAgICAgICB1cmw6ICcnLAogICAgICAgICAgICAgICAgZGF0YTogJycsCiAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLAogICAgICAgICAgICAgICAgX19tZWRpYXRvcl9kYXRhX2ZpcmVkX186IHRydWUsCiAgICAgICAgICAgICAgICBzaWxlbnQ6IGZhbHNlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuYXBwUGF0aCA9IGNvbmZpZy51cmwucGF0aCArICcvJzsKICAgICAgICB9CiAgICAgICAgRGF0YS5wcm90b3R5cGUuaW5pdEV2ZW50cyA9IC8vI3JlZ2lvbiBFdmVudHMKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbiAodG8sIGluaXQpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCwgb25jZSkgewogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgRGF0YUZhY2FkZSBmb3IgdGhlIGdpdmVuIG1vZHVsZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZhY2FkZQogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBhdmFpbGFibGUgZmFjYWRlcwogICAgICAgIEByZXR1cm5zIHtEYXRhRmFjYWRlfSBUaGUgbmV3IERhdGFGYWNhZGUKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgaWYobW9kLmRhdGEgJiYgIShmYWNhZGVzLmRhdGEgaW5zdGFuY2VvZiBEYXRhRmFjYWRlKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCciZGF0YSIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkYXRhOwogICAgICAgICAgICBpZihmYWNhZGVzLmRhdGEpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMuZGF0YS51cGRhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgICAgIGRhdGEgPSBmYWNhZGVzLmRhdGE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkYXRhID0gZmFjYWRlcy5kYXRhID0gbW9kLmRhdGEgPSBuZXcgRGF0YUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuZ2V0RGF0YSA9IC8qKgogICAgICAgIERvZXMgYSBHRVQgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIGdldERhdGEKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIHBhc3MgdG8gdGhlIGdpdmVuIHVybAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGEgR0VUIHRvIHRoZSBzZXJ2ZXIsIGZvciB0aGUgZ2l2ZW4gZGF0YSBhbmQgc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBnZXREYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgc2V0dGluZ3MgPSAhc2V0dGluZ3MgPyB7CiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0gOiBleHRlbmQoc2V0dGluZ3MsIHsKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldCh1cmwsIHNldHRpbmdzKTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLnBvc3REYXRhID0gLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIHBvc3REYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIHBvc3REYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgc2V0dGluZ3MgPSAhc2V0dGluZ3MgPyB7CiAgICAgICAgICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeShkYXRhKQogICAgICAgICAgICB9IDogZXh0ZW5kKHNldHRpbmdzLCB7CiAgICAgICAgICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeShkYXRhKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9zdCh1cmwsIHNldHRpbmdzKTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLmdldCA9IC8qKgogICAgICAgIERvZXMgYSBHRVQgdG8gdGhlIHNlcnZlciwgdXNpbmcgdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIERhdGEgbXVzdCBiZSBwYXNzZWQgaW4gdXNpbmcgc2V0dGluZ3M6IHsgZGF0YToge30gfSBvdGhlcndpc2UgdXNlIGdldERhdGEuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBnZXQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGEgR0VUIHRvIHRoZSBzZXJ2ZXIsIHVzaW5nIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBEYXRhIG11c3QgYmUgcGFzc2VkIGluIHVzaW5nIHNldHRpbmdzOiB7IGRhdGE6IHt9IH0gb3RoZXJ3aXNlIHVzZSBnZXREYXRhLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgICAgIEBtZXRob2QgZ2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgaWYoc2V0dGluZ3MgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgdXJsID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB1cmw7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodXJsID09PSB1bmRlZmluZWQgJiYgc2V0dGluZ3MudXJsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyB1cmwgaXMgZGVmaW5lZCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCBleHRlbmQoc2V0dGluZ3MgfHwgewogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICB0eXBlOiAnZ2V0JwogICAgICAgICAgICB9KSk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5wb3N0ID0gLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgdXNpbmcgdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIERhdGEgbXVzdCBiZSBwYXNzZWQgaW4gdXNpbmcgc2V0dGluZ3M6IHsgZGF0YToge30gfSBvdGhlcndpc2UgdXNlIHBvc3REYXRhLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgcG9zdAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIERvZXMgYSBQT1NUIHRvIHRoZSBzZXJ2ZXIsIHVzaW5nIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBEYXRhIG11c3QgYmUgcGFzc2VkIGluIHVzaW5nIHNldHRpbmdzOiB7IGRhdGE6IHt9IH0gb3RoZXJ3aXNlIHVzZSBwb3N0RGF0YS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIHBvc3QKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodXJsLCBzZXR0aW5ncykgewogICAgICAgICAgICBpZihzZXR0aW5ncyA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHVybDsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy51cmwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHVybCBpcyBkZWZpbmVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsIGV4dGVuZChzZXR0aW5ncyB8fCB7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIHR5cGU6ICdwb3N0JwogICAgICAgICAgICB9KSk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5hamF4ID0gLyoqCiAgICAgICAgRG9lcyBhbiBhamF4IGNhbGwgdG8gdGhlIGdpdmVuIHVybCwgd2l0aCB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBhamF4CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhbiBhamF4IGNhbGwgdG8gdGhlIGdpdmVuIHVybCwgd2l0aCB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBhamF4CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBvcHRpb25zLCB0eXBlLCBiZWZvcmVTZW5kOwogICAgICAgICAgICBmYWxzZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ0RhdGFbezB9XTogRmV0Y2hpbmcgZGF0YSBmcm9tICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHVybCkpOwogICAgICAgICAgICBpZihzZXR0aW5ncyA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHVybDsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gewogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy51cmwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVybCA9IHV0aWwuZml4dXBVcmwodXJsLCB0aGF0LmFwcFBhdGgpOwogICAgICAgICAgICBpZihzZXR0aW5ncy5zaWxlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBkZm8gPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgcXVlcnlJZCA9IHVpZCgnZHEnKTsKICAgICAgICAgICAgICAgIHR5cGUgPSBzZXR0aW5ncy50eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKHsKICAgICAgICAgICAgICAgIH0sIHRoYXQuZGVmYXVsdHMsIHsKICAgICAgICAgICAgICAgICAgICBiZWZvcmVTZW5kOiB1dGlsLm5vb3AKICAgICAgICAgICAgICAgIH0sIHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIGFqYXgodXJsLCBvcHRpb25zKS50aGVuKGFyZ3VtZW50UmVzb2x2ZXIoZGZvLnJlc29sdmUpLCBhcmd1bWVudFJlc29sdmVyKGRmby5yZWplY3QpKTsKICAgICAgICAgICAgICAgIHJldHVybiBkZm8ucHJvbWlzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKHsKICAgICAgICAgICAgfSwgdGhhdC5kZWZhdWx0cywgc2V0dGluZ3MsIHsKICAgICAgICAgICAgICAgIGJlZm9yZVNlbmQ6IGV2ZW50RmFjdG9yeS5iZWZvcmVTZW5kTWV0aG9kCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0eXBlID0gb3B0aW9ucy50eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc3BvbnNlUXVldWUuYWRkVG9RdWV1ZSh0eXBlLCB1cmwsIG9wdGlvbnMpOwogICAgICAgIH07CiAgICAgICAgRGF0YS5jb25maWcgPSBjb25maWc7CiAgICAgICAgcmV0dXJuIERhdGE7CiAgICB9KSgpOwogICAgZXhwb3J0cy5EYXRhID0gRGF0YTsgICAgCiAgICBfLmV4dGVuZChEYXRhLnByb3RvdHlwZSwgRXZlbnRzKTsKICAgIF8uZXh0ZW5kKERhdGFGYWNhZGUucHJvdG90eXBlLCBEYXRhLnByb3RvdHlwZSk7CiAgICAvLyBUYWtlIGEgaG9sZCBvZiBqUXVlcnkuLi4gdGhpcyBpcyBzdXJlIHRvIGJlIGNvbnRyYXZlc2lhbAogICAgalF1ZXJ5LmFqYXggPSAoRGF0YSkucHJvdG90eXBlLmFqYXg7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YScsIFsndGhydXN0L2RhdGEvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9kb20vbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnLi9zdWJqcXVlcnknLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2xvZycsICd0aHJ1c3QvZmFjYWRlJywgJ2hhcycsICd0aHJ1c3QvaW5zdGFuY2UnLCAnLi9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19zdWJqcXVlcnlfXywgX191dGlsX18sIF9fbG9nX18sIF9fZmFjYWRlX18sIF9faGFzX18sIF9faW5zdGFuY2VfXywgX19jb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyIHRRdWVyeSA9IHN1YmpxdWVyeS50UXVlcnk7CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGZhY2FkZSA9IF9fZmFjYWRlX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGluc3RhbmNlID0gX19pbnN0YW5jZV9fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ0RvbSc7CiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGV4dGVuZCA9IF8uZXh0ZW5kLCBiaW5kID0gXy5iaW5kLCBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LCBpc09iamVjdCA9IF8uaXNPYmplY3QsIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCB3aGVuID0gdXRpbC53aGVuLCBpc0FycmF5ID0gXy5pc0FycmF5OwogICAgLy8jcmVnaW9uIERvbUZhY2FkZQogICAgdmFyIERvbUZhY2FkZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGRvbUZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZCwgcGFyZW50KSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IHBhcmVudC5uYW1lOwogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gdFF1ZXJ5KGRvY3VtZW50LCB1bmRlZmluZWQsIHRoaXMubmFtZSk7CiAgICAgICAgfSk7CiAgICAgICAgZG9tRmFjYWRlLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKGZha2UpIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxFdmVudHMgPSB0aGlzLl9pbnRlcm5hbEV2ZW50cyB8fCBbXTsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRG9tW3swfV06IEluaXRhbGl6aW5nIHsxfURvbSBmYWNhZGUnLCB0aGlzLm5hbWUsIGZha2UgPyAnZmFrZSAnIDogJycpKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLnN0YXJ0ID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRG9tW3swfV06IFN0YXJ0aW5nIERvbSBmYWNhZGUnLCB0aGlzLm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogU3RvcHBpbmcgRG9tIGZhY2FkZScsIHRoaXMubmFtZSkpOwogICAgICAgICAgICBmb3IodmFyIGkgPSB0aGlzLl9pbnRlcm5hbEV2ZW50cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgdmFyIHN1YiA9IHRoaXMuX2ludGVybmFsRXZlbnRzW2ldOwogICAgICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxFdmVudHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgc3ViLmNvbnRleHQub2ZmLmFwcGx5KHRoaXMsIChpc0FycmF5KHN1YikpID8gc3ViIDogKGlzQXJyYXkoc3ViLmFyZ3MpKSA/IHN1Yi5hcmdzIDogW10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgZG9tRmFjYWRlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRG9tW3swfV06IERlc3Ryb3lpbmcgRG9tIGZhY2FkZScsIHRoaXMubmFtZSkpOwogICAgICAgICAgICBkZWxldGUgdGhpcy5faW50ZXJuYWxFdmVudHM7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGRvbUZhY2FkZTsKICAgIH0pKCk7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vI3JlZ2lvbiBEb20KICAgIHZhciBEb20gPSAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vI2VuZHJlZ2lvbgogICAgICAgIGZ1bmN0aW9uIERvbShuYW1lLCBtZWRpYXRvcikgewogICAgICAgICAgICBpZighbmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEb206IG1vZHVsZSBuYW1lIG11c3QgYmUgZGVmaW5lZC4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoJ0RhdGE6IENyZWF0aW5nIG5ldyBEYXRhJyk7CiAgICAgICAgICAgIHRoaXMubWVkaWF0b3IgPSBtZWRpYXRvcjsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gKG1lZGlhdG9yKS5fY2FsbGJhY2tzOwogICAgICAgICAgICB0aGlzLmluaXRFdmVudHMoKTsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpbnN0YW5jZS5mZXRjaEluc3RhbmNlKG5hbWUpLnByb21pc2UudGhlbihmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgICAgICB2YXIgbW9kID0gewogICAgICAgICAgICAgICAgfSwgZmFjYWRlID0gdGhhdC5jcmVhdGVGYWNhZGUodGhydXN0LCBtb2QsIHsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIERvbS5wcm90b3R5cGUuaW5pdEV2ZW50cyA9IC8vI3JlZ2lvbiBFdmVudHMKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBEb20ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uICh0bywgaW5pdCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIERvbS5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIG9uY2UpIHsKICAgICAgICB9OwogICAgICAgIERvbS5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgRG9tLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIERvbS5jb25maWcgPSBjb25maWc7CiAgICAgICAgRG9tLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgaWYoZmFjYWRlcy5kb20gJiYgIShmYWNhZGVzLmRvbSBpbnN0YW5jZW9mIERvbUZhY2FkZSkpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignImRvbSIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkb207CiAgICAgICAgICAgIGlmKGZhY2FkZXMuZG9tKSB7CiAgICAgICAgICAgICAgICBmYWNhZGVzLmRvbS51cGRhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgICAgIGRvbSA9IGZhY2FkZXMuZG9tOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZG9tID0gZmFjYWRlcy5kb20gPSBuZXcgRG9tRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRvbTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBEb207CiAgICB9KSgpOwogICAgZXhwb3J0cy5Eb20gPSBEb207ICAgIAogICAgLy8jZW5kcmVnaW9uCiAgICB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbScsIFsndGhydXN0L2RvbS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L3RlbXBsYXRlL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJ2RvbVJlYWR5JywgJ3RocnVzdC9mYWNhZGUnLCAnLi9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fZG9tUmVhZHlfXywgX19mYWNhZGVfXywgX19jb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgCiAgICAKICAgIHZhciBkb21SZWFkeSA9IF9fZG9tUmVhZHlfXzsKCiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdUZW1wbGF0ZSc7CiAgICBjb25maWc7CiAgICB2YXIgTE9ORyA9ICdsb25nJywgU0hPUlQgPSAnc2hvcnQnLCBJRCA9ICdpZCcsIGRlZXBDb3B5ID0gXy5tZXJnZSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGVhY2ggPSBfLmVhY2gsIGJpbmQgPSBfLmJpbmQsIHdoZW4gPSB1dGlsLndoZW4sIHJlZHVjZSA9IF8ucmVkdWNlLCBtZW1vaXplID0gXy5tZW1vaXplLCBtYXAgPSBfLm1hcCwgZXh0ZW5kID0gXy5leHRlbmQsIGdldExvbmdOYW1lID0gZnVuY3Rpb24gKG5hbWUsIHR5cGUpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHJlc3VsdCA9ICh0aGF0LnNob3J0TmFtZShuYW1lKSArICcuJyArICh0eXBlIHx8IHRoYXQuY29uZmlnLmRlZmF1bHRUeXBlKSArIHRoYXQuY29uZmlnLmV4dGVuc2lvbikudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwgZ2V0U2hvcnROYW1lID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHJlc3VsdCA9IHJlZHVjZSh0aGF0LnRlbXBsYXRlVHlwZXMsIGZ1bmN0aW9uIChtZW1vLCB4KSB7CiAgICAgICAgICAgIHJldHVybiBtZW1vLnJlcGxhY2UoJy4nICsgeC50b0xvd2VyQ2FzZSgpICsgdGhhdC5jb25maWcuZXh0ZW5zaW9uLCAnJyk7CiAgICAgICAgfSwgbmFtZS50b0xvd2VyQ2FzZSgpKS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LCBnZXRUZW1wbGF0ZUlkID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHJlc3VsdCA9IHRoYXQuc2hvcnROYW1lKG5hbWUpLnJlcGxhY2UoL1wvL2csICctJyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnRlbXBsYXRlCiAgICBAcmVxdWlyZXMgdGhydXN0LmRhdGEKICAgICoqLwogICAgLyoqCiAgICBUaGUgdGVtcGxhdGUgcGx1Z2luIGNvbnN0dXJjdG9yLgogICAgCiAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZQogICAgQGNsYXNzIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdGhydXN0IGNvbmZpZyBvYmplY3QKICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSB0aHJ1c3QgZGF0YSBpbnN0YW5jZQogICAgQHVzZXMgdGhydXN0LmRhdGEuRGF0YQogICAgQGNvbnN0cnVjdG9yCiAgICAqKi8KICAgIHZhciBUZW1wbGF0ZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gVGVtcGxhdGUoY29uZmlnLCBkYXRhKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdGVtcGxhdGVDb25maWcgPSB0aGlzLmNvbmZpZyA9IGNvbmZpZy50ZW1wbGF0ZTsKICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZVR5cGVzID0gbWFwKHRlbXBsYXRlQ29uZmlnLnR5cGVzLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGF0LnRlbXBsYXRlcyA9IHsKICAgICAgICAgICAgICAgIGxvbmc6IHsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzaG9ydDogewogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGlkOiB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoYXQubG9uZ05hbWUgPSBtZW1vaXplKGJpbmQoZ2V0TG9uZ05hbWUsIHRoYXQpKTsKICAgICAgICAgICAgdGhhdC5zaG9ydE5hbWUgPSBtZW1vaXplKGJpbmQoZ2V0U2hvcnROYW1lLCB0aGF0KSk7CiAgICAgICAgICAgIHRoYXQudGVtcGxhdGVJZCA9IG1lbW9pemUoYmluZChnZXRUZW1wbGF0ZUlkLCB0aGF0KSk7CiAgICAgICAgICAgIHRoYXQuZW5naW5lcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhhdC5kYXRhID0gZGF0YTsKICAgICAgICAgICAgcmVxdWlyZShbCiAgICAgICAgICAgICAgICAodGVtcGxhdGVDb25maWcudGVtcGxhdGVQYXRoc1t0ZW1wbGF0ZUNvbmZpZy5kZWZhdWx0VHlwZV0gfHwgJ3RocnVzdC90ZW1wbGF0ZS8nICsgdGVtcGxhdGVDb25maWcuZGVmYXVsdFR5cGUpCiAgICAgICAgICAgIF0sIGZ1bmN0aW9uIChlbmdpbmUpIHsKICAgICAgICAgICAgICAgIHRoYXQuZW5naW5lc1t0ZW1wbGF0ZUNvbmZpZy5kZWZhdWx0VHlwZV0gPSBlbmdpbmU7CiAgICAgICAgICAgICAgICBkb21SZWFkeShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgKF8oZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpKSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhIXguZ2V0QXR0cmlidXRlKCdkYXRhLXRlbXBsYXRlJyk7CiAgICAgICAgICAgICAgICAgICAgfSkuZWFjaChiaW5kKHRoYXQuY3JlYXRlRnJvbURvbU5vZGUsIHRoYXQpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmdldCA9IC8qKgogICAgICAgIEdldHMgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBjYWNoZSBpZiBpdCBoYXMgYmVlbiBmZXRjaGVkLiBGYWxzZSBvdGhlcndpc2UuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGdldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lIHRvIHRyeSBhbmQgZ2V0LgogICAgICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIHRlbXBsYXRlIG9iamVjdAogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIEdldHMgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBjYWNoZSBpZiBpdCBoYXMgYmVlbiBmZXRjaGVkLiBGYWxzZSBvdGhlcndpc2UuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgICAgICBAbWV0aG9kIGdldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lIHRvIHRyeSBhbmQgZ2V0LgogICAgICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIHRlbXBsYXRlIG9iamVjdAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IG51bGwsIHRoYXQgPSB0aGlzLCB0ZW1wbGF0ZXMgPSB0aGF0LnRlbXBsYXRlczsKICAgICAgICAgICAgaWYodGVtcGxhdGUgPSB0ZW1wbGF0ZXMubG9uZ1t0aGF0LmxvbmdOYW1lKG5hbWUpXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgICAgICAgICB9IGVsc2UgaWYodGVtcGxhdGUgPSB0ZW1wbGF0ZXMuc2hvcnRbdGhhdC5zaG9ydE5hbWUobmFtZSldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICAgICAgICAgIH0gZWxzZSBpZih0ZW1wbGF0ZSA9IHRlbXBsYXRlcy5pZFt0aGF0LnRlbXBsYXRlSWQobmFtZSldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuc2V0ID0gLyoqCiAgICAgICAgU2V0cyBhIHRlbXBsYXRlIHRvIHRoZSBjYWNoZSwgd2l0aCB0aGUgZ2l2ZW4gaW5mb3JtYXRpb24KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2Qgc2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdGVtcGxhdGUgZW5naW5lIHR5cGUKICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjb21waWxlZFRlbXBsYXRlIFRoZSBjb21waWxlZCB0ZW1wbGF0ZSBtZXRob2QKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaHRtbCBUaGUgdGVtcGxhdGUgSFRNTC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSwgdHlwZSwgY29tcGlsZWRUZW1wbGF0ZSwgaHRtbCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHNob3J0TmFtZSA9IHRoYXQuc2hvcnROYW1lKG5hbWUpLCB0ZW1wbGF0ZUlkID0gdGhhdC50ZW1wbGF0ZUlkKG5hbWUpLCBsb25nTmFtZSA9IHRoYXQubG9uZ05hbWUobmFtZSwgdHlwZSksIHRlbXBsYXRlcyA9IHRoYXQudGVtcGxhdGVzOwogICAgICAgICAgICB0ZW1wbGF0ZXMubG9uZ1tsb25nTmFtZV0gPSB0ZW1wbGF0ZXMuc2hvcnRbc2hvcnROYW1lXSA9IHRlbXBsYXRlcy5pZFt0ZW1wbGF0ZUlkXSA9IHsKICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICBzaG9ydE5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICBpZDogdGVtcGxhdGVJZCwKICAgICAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgICBodG1sOiBodG1sLAogICAgICAgICAgICAgICAgY29tcGlsZWQ6IGNvbXBpbGVkVGVtcGxhdGUKICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5oYXMgPSAvKioKICAgICAgICBDaGVja3MgaWYgdGhlIHRlbXBsYXRlIGV4aXN0cyBpbiB0aGUgY2FjaGUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGhhcwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHJldHVybnMge0Jvb2xlYW59IFdldGhlciB0aGUgdGVtcGxhdGUgZXhpc3RzIG9yIG5vdC4KICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBDaGVja3MgaWYgdGhlIHRlbXBsYXRlIGV4aXN0cyBpbiB0aGUgY2FjaGUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgICAgICBAbWV0aG9kIGhhcwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHJldHVybnMge0Jvb2xlYW59IFdldGhlciB0aGUgdGVtcGxhdGUgZXhpc3RzIG9yIG5vdC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiAhIXRoYXQuZ2V0KG5hbWUpOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLm5ld1RlbXBsYXRlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyB0ZW1wbGF0ZSBnaXZlbiB0aGUgaW5mb3JtYXRpb24KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgbmV3VGVtcGxhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0ZW1wbGF0ZSBlbmdpbmUgdHlwZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBodG1sIFRoZSB0ZW1wbGF0ZSBIVE1MLgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBlbmdpbmUgVGhlIHRlbXBsYXRlIGVuZ2luZQogICAgICAgIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXcgdGVtcGxhdGUgaW5zdGFuY2UuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUsIHR5cGUsIGh0bWwsIGVuZ2luZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHRlbXBsYXRlID0gdGhhdC5nZXQobmFtZSk7CiAgICAgICAgICAgIGlmKCF0ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgaWYodHlwZSA9PSAncHJlY29tcGlsZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5zZXQobmFtZSwgdHlwZSwgaHRtbCwgaHRtbC50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRpbmdNZXRob2Q7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBpbGVkVGVtcGxhdGUgPSB0aGlzLmNvbXBpbGUoaHRtbCwgZW5naW5lKTsKICAgICAgICAgICAgICAgICAgICB0aGF0LnNldChuYW1lLCB0eXBlLCBjb21waWxlZFRlbXBsYXRlLCBodG1sKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhhdC5nZXQobmFtZSk7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuY29tcGlsZSA9IC8qKgogICAgICAgIENvbXBpbGVzIGEgdGVtcGxhdGUgZ2l2ZW4gdGhlIGh0bWwgYW5kIHRoZSBlbmdpbmUgdHlwZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgY29tcGlsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBodG1sIFRoZSBodG1sIHRvIGdlbmVyYXRlIHRoZSB0ZW1wbGF0ZSBmcm9tCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGVuZ2luZSBUaGUgdGVtcGxhdGUgZW5naW5lIHRoYXQgaXMgYmVpbmcgdXNlZC4KICAgICAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBjb21waWxlZCB0ZW1wbGF0ZSBtZXRob2QKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoaHRtbCwgZW5naW5lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdGVtcGxhdGluZ01ldGhvZDsKICAgICAgICAgICAgaWYoIWVuZ2luZSkgewogICAgICAgICAgICAgICAgZW5naW5lID0gdGhhdC5lbmdpbmVzW3RoYXQuY29uZmlnLmRlZmF1bHRUeXBlXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0eXBlb2YgZW5naW5lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0ZW1wbGF0aW5nTWV0aG9kID0gZW5naW5lOwogICAgICAgICAgICB9IGVsc2UgaWYodHlwZW9mIGVuZ2luZS50ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgdGVtcGxhdGluZ01ldGhvZCA9IGVuZ2luZS50ZW1wbGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGVtcGxhdGluZ01ldGhvZChodG1sKTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5mZXRjaCA9IC8qKgogICAgICAgIEZldGNocyBhIHRlbXBsYXRlIGZyb20gdGhlIHNlcnZlciwgb3IgdGVtcGxhdGUgc3RvcmUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGZldGNoCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gW3R5cGVdIFRoZSB0ZW1wbGF0ZSB0eXBlIGlmIG5vdCB0aGUgZGVmYXVsdAogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBmb3Igd2hlbiB0aGUgdGVtcGxhdGUgaGFzIGJlZW4gbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIEZldGNocyBhIHRlbXBsYXRlIGZyb20gdGhlIHNlcnZlciwgb3IgdGVtcGxhdGUgc3RvcmUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgICAgICBAbWV0aG9kIGZldGNoCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gW3R5cGVdIFRoZSB0ZW1wbGF0ZSB0eXBlIGlmIG5vdCB0aGUgZGVmYXVsdAogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBmb3Igd2hlbiB0aGUgdGVtcGxhdGUgaGFzIGJlZW4gbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCB0eXBlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdHlwZSA9IHR5cGUgfHwgdGhhdC5jb25maWcuZGVmYXVsdFR5cGUsIHNob3J0TmFtZSA9IHRoYXQuc2hvcnROYW1lKG5hbWUpLCBsb25nTmFtZSA9IHRoYXQubG9uZ05hbWUobmFtZSwgdHlwZSksIHRlbXBsYXRlOwogICAgICAgICAgICB2YXIgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgIGlmKHRlbXBsYXRlID0gdGhhdC5nZXQobmFtZSkpIHsKICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhhdC5kYXRhLmdldCh0aGF0LmNvbmZpZy5iYXNlVXJsICsgbG9uZ05hbWUsIHsKICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAndGV4dC9wbGFpbicsCiAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ3RleHQnLAogICAgICAgICAgICAgICAgc2lsZW50OiB0cnVlCiAgICAgICAgICAgIH0pLnRoZW4od2hlbi5hcHBseShmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgaWYodHlwZSA9PSAncHJlY29tcGlsZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhhdC5uZXdUZW1wbGF0ZShuYW1lLCB0eXBlLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYodGhhdC5lbmdpbmVzW3R5cGVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoYXQubmV3VGVtcGxhdGUobmFtZSwgdHlwZSwgZGF0YSwgdGhhdC5lbmdpbmVzW3R5cGVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhhdC5jb25maWcudGVtcGxhdGVQYXRoc1t0eXBlXSB8fCAndGhydXN0L3RlbXBsYXRlLycgKyB0eXBlKQogICAgICAgICAgICAgICAgICAgICAgICBdLCBmdW5jdGlvbiAoZW5naW5lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmVuZ2luZXNbdHlwZV0gPSBlbmdpbmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB0aGF0Lm5ld1RlbXBsYXRlKG5hbWUsIHR5cGUsIGRhdGEsIGVuZ2luZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSwgZGVmZXIucmVqZWN0KTsKICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuY3JlYXRlRnJvbURvbU5vZGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbmV3IHRlbXBsYXRlIGZyb20gdGhlIGdpdmVuIERPTSBOb2RlCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZyb21Eb21Ob2RlCiAgICAgICAgQHByb3RlY3RlZAogICAgICAgIEBwYXJhbSB7Tm9kZX0gZWxlbWVudCBUSGUgZG9tZSBlbGVtZW50LgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdGhhdC5uZXdUZW1wbGF0ZShlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10ZW1wbGF0ZScpLCBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10eXBlJyksIGVsZW1lbnQudGV4dCk7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuY3JlYXRlRmFjYWRlID0gLyoqCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZhY2FkZQogICAgICAgIEBwYXJhbSB7dGhydXN0LlRocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGFscmVhZHkgYWRkZWQgZm9yIHRoaXMgbW9kdWxlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICB2YXIgdGVtcGxhdGVJbnN0YW5jZSA9IHRocnVzdC50ZW1wbGF0ZTsKICAgICAgICAgICAgdmFyIGZhY2FkZSA9IGZhY2FkZXMudGVtcGxhdGUgPSBuZXcgVGVtcGxhdGVGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgbW9kLnRlbXBsYXRlcyA9IHsKICAgICAgICAgICAgICAgIGZldGNoOiBiaW5kKHRlbXBsYXRlSW5zdGFuY2UuZmV0Y2gsIHRlbXBsYXRlSW5zdGFuY2UpLAogICAgICAgICAgICAgICAgZ2V0OiBiaW5kKHRlbXBsYXRlSW5zdGFuY2UuZ2V0LCB0ZW1wbGF0ZUluc3RhbmNlKSwKICAgICAgICAgICAgICAgIGhhczogYmluZCh0ZW1wbGF0ZUluc3RhbmNlLmhhcywgdGVtcGxhdGVJbnN0YW5jZSkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGZhY2FkZTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLmNvbmZpZyA9IGNvbmZpZzsKICAgICAgICByZXR1cm4gVGVtcGxhdGU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5UZW1wbGF0ZSA9IFRlbXBsYXRlOyAgICAKICAgIC8qKgogICAgCiAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZQogICAgQGNsYXNzIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZUZhY2FkZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgQHBhcmFtIHt0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGV9IHBhcmVudCBUaGUgdGVtcGxhdGUgaW5zdGFuY2UgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yLgogICAgKiovCiAgICB2YXIgVGVtcGxhdGVGYWNhZGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0ZW1wbGF0ZUZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZHVsZSwgcGFyZW50KSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG1vZHVsZS5uYW1lICsgJy10ZW1wbGF0ZSc7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gcGFyZW50Ll9fY29udmVudGlvbnM7CiAgICAgICAgICAgIGV4dGVuZCh0aGlzLCB7CiAgICAgICAgICAgICAgICBmZXRjaDogYmluZChwYXJlbnQuZmV0Y2gsIHBhcmVudCksCiAgICAgICAgICAgICAgICBnZXQ6IGJpbmQocGFyZW50LmdldCwgcGFyZW50KSwKICAgICAgICAgICAgICAgIGhhczogYmluZChwYXJlbnQuaGFzLCBwYXJlbnQpCiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZUZhY2FkZTsKICAgIH0pKCk7CiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIHRocnVzdC90ZW1wbGF0ZSBieSBwYXRoLgogICAgUmVxdWlyZXMgdGhlIGluc3RhbmNlLCB0aGF0IHRoZSB0ZW1wbGF0ZSBpcyBleHBlY3RlZCB0byBjb21lIGZyb20uCiAgICB0aHJ1c3RJbnN0YW5jZVs6ZW5naW5lTmFtZV06dGVtcGxhdGVQYXRoCiAgICAKICAgIFByZWZpeCB3aXRoIDxlbmdpbmVOYW1lPjogdG8gc2VsZWN0IGEgc3BlY2lmaWMgdGVtcGxhdGUgZW5naW5lLgogICAgdGhydXN0L3RlbXBsYXRlIWdsb2JhbDp0ZW1wbGF0ZXMvbXlUZW1wbGF0ZS50bXBsID0gU3BlY2lmaWMgdGVtcGxhdGUKICAgIHRocnVzdC90ZW1wbGF0ZSFpbnN0YW5jZTI6dGVtcGxhdGVzL215VGVtcGxhdGUgPSBVc2VzIGRlZmF1bHQgZXh0ZW5zaW9uIGZyb20gY29uZmlnCiAgICB0aHJ1c3QvdGVtcGxhdGUhaW5zdGFuY2UyOmtlbmRvOnRlbXBsYXRlcy9teVRlbXBsYXRlLnRtcGwgPSBVc2VzIHRoZSBrZW5kbyB0ZW1wbGF0ZSBlbmdpbmUuCiAgICB0aHJ1c3QvdGVtcGxhdGUhaW5zdGFuY2UzOmtlbmRvOnRlbXBsYXRlcy9teVRlbXBsYXRlLnRtcGwgPSBVc2VzIHRoZSBrZW5kbyB0ZW1wbGF0ZSBlbmdpbmUgd2l0aCB0aGUgZGVmYXVsdCBleHRlbnNpb24KICAgIAogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSB0ZW1wbGF0ZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICAvLyBOb3QgY29tcGxldGVkIHlldAogICAgLy8gU2hvdWxkIGJlaGF2ZSBzaW1pbGFybHkgdG8gdGV4dCEKICAgIC8vZXhwb3J0IGZ1bmN0aW9uIGxvYWQobmFtZTogc3RyaW5nLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpCiAgICAvL3sKICAgIC8vICAgIHZhciB0ZW1wbGF0ZVBhdGggPSBuYW1lLAogICAgLy8gICAgICAgIHRlbXBsYXRlRW5naW5lLAogICAgLy8gICAgICAgIGNvbG9uID0gdGVtcGxhdGVQYXRoLmluZGV4T2YoJzonKTsKICAgIC8vCXZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwKICAgIC8vICAgICAgICBpbnN0YW5jZU5hbWUgPSBwYXJ0c1swXSwKICAgIC8vCQl0ZW1wbGF0ZUVuZ2luZSA9IHBhcnRzWzFdLAogICAgLy8JCXRlbXBsYXRlUGF0aCA9IHBhcnRzWzJdIHx8IHRlbXBsYXRlRW5naW5lOwogICAgLy8gICAgaWYgKHBhcnRzLmxlbmd0aCA9PT0gMikKICAgIC8vICAgICAgICB0ZW1wbGF0ZUVuZ2luZSA9IG51bGw7CiAgICAvLwkvL3ZhciBpbnN0YW5jZVByb21pc2UgPSBUaHJ1c3QuX19mZXRjaEluc3RhbmNlKHJlYWxOYW1lKTsKICAgIC8vICAgIC8vIEdldCB0aGUgZGF0YSBwbHVnaW4uCiAgICAvLyAgICBwYXJlbnRSZXF1aXJlKFsndGhydXN0IWRhdGE6JyArIGluc3RhbmNlTmFtZV0sIChkYXRhUGx1Z2luKSA9PgogICAgLy8gICAgewogICAgLy8gICAgICAgIHZhciBkYXRhUGx1Z2luID0gZGF0YVBsdWdpbgogICAgLy8gICAgfSk7CiAgICAvL30KICAgIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUnLCBbJ3RocnVzdC90ZW1wbGF0ZS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCgoKLy8KLy8gR2VuZXJhdGVkIG9uIFN1biBEZWMgMTYgMjAxMiAyMjo0NzowNSBHTVQtMDUwMCAoRVNUKSBieSBOb2Rlaml0c3UsIEluYyAoVXNpbmcgQ29kZXN1cmdlb24pLgovLyBWZXJzaW9uIDEuMS45Ci8vCgooZnVuY3Rpb24gKGV4cG9ydHMpIHsKCgovKgogKiBicm93c2VyLmpzOiBCcm93c2VyIHNwZWNpZmljIGZ1bmN0aW9uYWxpdHkgZm9yIGRpcmVjdG9yLgogKgogKiAoQykgMjAxMSwgTm9kZWppdHN1IEluYy4KICogTUlUIExJQ0VOU0UKICoKICovCgppZiAoIUFycmF5LnByb3RvdHlwZS5maWx0ZXIpIHsKICBBcnJheS5wcm90b3R5cGUuZmlsdGVyID0gZnVuY3Rpb24oZmlsdGVyLCB0aGF0KSB7CiAgICB2YXIgb3RoZXIgPSBbXSwgdjsKICAgIGZvciAodmFyIGkgPSAwLCBuID0gdGhpcy5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgaWYgKGkgaW4gdGhpcyAmJiBmaWx0ZXIuY2FsbCh0aGF0LCB2ID0gdGhpc1tpXSwgaSwgdGhpcykpIHsKICAgICAgICBvdGhlci5wdXNoKHYpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gb3RoZXI7CiAgfTsKfQoKaWYgKCFBcnJheS5pc0FycmF5KXsKICBBcnJheS5pc0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKfQoKdmFyIGRsb2MgPSBkb2N1bWVudC5sb2NhdGlvbjsKCmZ1bmN0aW9uIGRsb2NIYXNoRW1wdHkoKSB7CiAgLy8gTm9uLUlFIGJyb3dzZXJzIHJldHVybiAnJyB3aGVuIHRoZSBhZGRyZXNzIGJhciBzaG93cyAnIyc7IERpcmVjdG9yJ3MgbG9naWMKICAvLyBhc3N1bWVzIGJvdGggbWVhbiBlbXB0eS4KICByZXR1cm4gZGxvYy5oYXNoID09PSAnJyB8fCBkbG9jLmhhc2ggPT09ICcjJzsKfQoKdmFyIGxpc3RlbmVyID0gewogIG1vZGU6ICdtb2Rlcm4nLAogIGhhc2g6IGRsb2MuaGFzaCwKICBoaXN0b3J5OiBmYWxzZSwKCiAgY2hlY2s6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBoID0gZGxvYy5oYXNoOwogICAgaWYgKGggIT0gdGhpcy5oYXNoKSB7CiAgICAgIHRoaXMuaGFzaCA9IGg7CiAgICAgIHRoaXMub25IYXNoQ2hhbmdlZCgpOwogICAgfQogIH0sCgogIGZpcmU6IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLm1vZGUgPT09ICdtb2Rlcm4nKSB7CiAgICAgIHRoaXMuaGlzdG9yeSA9PT0gdHJ1ZSA/IHdpbmRvdy5vbnBvcHN0YXRlKCkgOiB3aW5kb3cub25oYXNoY2hhbmdlKCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgdGhpcy5vbkhhc2hDaGFuZ2VkKCk7CiAgICB9CiAgfSwKCiAgaW5pdDogZnVuY3Rpb24gKGZuLCBoaXN0b3J5KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoKICAgIGlmICghUm91dGVyLmxpc3RlbmVycykgewogICAgICBSb3V0ZXIubGlzdGVuZXJzID0gW107CiAgICB9CgogICAgZnVuY3Rpb24gb25jaGFuZ2Uob25DaGFuZ2VFdmVudCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IFJvdXRlci5saXN0ZW5lcnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgUm91dGVyLmxpc3RlbmVyc1tpXShvbkNoYW5nZUV2ZW50KTsKICAgICAgfQogICAgfQoKICAgIC8vbm90ZSBJRTggaXMgYmVpbmcgY291bnRlZCBhcyAnbW9kZXJuJyBiZWNhdXNlIGl0IGhhcyB0aGUgaGFzaGNoYW5nZSBldmVudAogICAgaWYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdyAmJiAoZG9jdW1lbnQuZG9jdW1lbnRNb2RlID09PSB1bmRlZmluZWQKICAgICAgfHwgZG9jdW1lbnQuZG9jdW1lbnRNb2RlID4gNykpIHsKICAgICAgLy8gQXQgbGVhc3QgZm9yIG5vdyBIVE1MNSBoaXN0b3J5IGlzIGF2YWlsYWJsZSBmb3IgJ21vZGVybicgYnJvd3NlcnMgb25seQogICAgICBpZiAodGhpcy5oaXN0b3J5ID09PSB0cnVlKSB7CiAgICAgICAgLy8gVGhlcmUgaXMgYW4gb2xkIGJ1ZyBpbiBDaHJvbWUgdGhhdCBjYXVzZXMgb25wb3BzdGF0ZSB0byBmaXJlIGV2ZW4KICAgICAgICAvLyB1cG9uIGluaXRpYWwgcGFnZSBsb2FkLiBTaW5jZSB0aGUgaGFuZGxlciBpcyBydW4gbWFudWFsbHkgaW4gaW5pdCgpLAogICAgICAgIC8vIHRoaXMgd291bGQgY2F1c2UgQ2hyb21lIHRvIHJ1biBpdCB0d2lzZS4gQ3VycmVudGx5IHRoZSBvbmx5CiAgICAgICAgLy8gd29ya2Fyb3VuZCBzZWVtcyB0byBiZSB0byBzZXQgdGhlIGhhbmRsZXIgYWZ0ZXIgdGhlIGluaXRpYWwgcGFnZSBsb2FkCiAgICAgICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NjMwNDAKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgd2luZG93Lm9ucG9wc3RhdGUgPSBvbmNoYW5nZTsKICAgICAgICB9LCA1MDApOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIHdpbmRvdy5vbmhhc2hjaGFuZ2UgPSBvbmNoYW5nZTsKICAgICAgfQogICAgICB0aGlzLm1vZGUgPSAnbW9kZXJuJzsKICAgIH0KICAgIGVsc2UgewogICAgICAvLwogICAgICAvLyBJRSBzdXBwb3J0LCBiYXNlZCBvbiBhIGNvbmNlcHQgYnkgRXJpayBBcnZpZHNvbiAuLi4KICAgICAgLy8KICAgICAgdmFyIGZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CiAgICAgIGZyYW1lLmlkID0gJ3N0YXRlLWZyYW1lJzsKICAgICAgZnJhbWUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmcmFtZSk7CiAgICAgIHRoaXMud3JpdGVGcmFtZSgnJyk7CgogICAgICBpZiAoJ29ucHJvcGVydHljaGFuZ2UnIGluIGRvY3VtZW50ICYmICdhdHRhY2hFdmVudCcgaW4gZG9jdW1lbnQpIHsKICAgICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgnb25wcm9wZXJ0eWNoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChldmVudC5wcm9wZXJ0eU5hbWUgPT09ICdsb2NhdGlvbicpIHsKICAgICAgICAgICAgc2VsZi5jaGVjaygpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgeyBzZWxmLmNoZWNrKCk7IH0sIDUwKTsKCiAgICAgIHRoaXMub25IYXNoQ2hhbmdlZCA9IG9uY2hhbmdlOwogICAgICB0aGlzLm1vZGUgPSAnbGVnYWN5JzsKICAgIH0KCiAgICBSb3V0ZXIubGlzdGVuZXJzLnB1c2goZm4pOwoKICAgIHJldHVybiB0aGlzLm1vZGU7CiAgfSwKCiAgZGVzdHJveTogZnVuY3Rpb24gKGZuKSB7CiAgICBpZiAoIVJvdXRlciB8fCAhUm91dGVyLmxpc3RlbmVycykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGxpc3RlbmVycyA9IFJvdXRlci5saXN0ZW5lcnM7CgogICAgZm9yICh2YXIgaSA9IGxpc3RlbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBpZiAobGlzdGVuZXJzW2ldID09PSBmbikgewogICAgICAgIGxpc3RlbmVycy5zcGxpY2UoaSwgMSk7CiAgICAgIH0KICAgIH0KICB9LAoKICBzZXRIYXNoOiBmdW5jdGlvbiAocykgewogICAgLy8gTW96aWxsYSBhbHdheXMgYWRkcyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeQogICAgaWYgKHRoaXMubW9kZSA9PT0gJ2xlZ2FjeScpIHsKICAgICAgdGhpcy53cml0ZUZyYW1lKHMpOwogICAgfQoKICAgIGlmICh0aGlzLmhpc3RvcnkgPT09IHRydWUpIHsKICAgICAgd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgcyk7CiAgICAgIC8vIEZpcmUgYW4gb25wb3BzdGF0ZSBldmVudCBtYW51YWxseSBzaW5jZSBwdXNoaW5nIGRvZXMgbm90IG9idmlvdXNseQogICAgICAvLyB0cmlnZ2VyIHRoZSBwb3AgZXZlbnQuCiAgICAgIHRoaXMuZmlyZSgpOwogICAgfSBlbHNlIHsKICAgICAgZGxvYy5oYXNoID0gKHNbMF0gPT09ICcvJykgPyBzIDogJy8nICsgczsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0sCgogIHdyaXRlRnJhbWU6IGZ1bmN0aW9uIChzKSB7CiAgICAvLyBJRSBzdXBwb3J0Li4uCiAgICB2YXIgZiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0ZS1mcmFtZScpOwogICAgdmFyIGQgPSBmLmNvbnRlbnREb2N1bWVudCB8fCBmLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQ7CiAgICBkLm9wZW4oKTsKICAgIGQud3JpdGUoIjxzY3JpcHQ+X2hhc2ggPSAnIiArIHMgKyAiJzsgb25sb2FkID0gcGFyZW50Lmxpc3RlbmVyLnN5bmNIYXNoOzxzY3JpcHQ+Iik7CiAgICBkLmNsb3NlKCk7CiAgfSwKCiAgc3luY0hhc2g6IGZ1bmN0aW9uICgpIHsKICAgIC8vIElFIHN1cHBvcnQuLi4KICAgIHZhciBzID0gdGhpcy5faGFzaDsKICAgIGlmIChzICE9IGRsb2MuaGFzaCkgewogICAgICBkbG9jLmhhc2ggPSBzOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgb25IYXNoQ2hhbmdlZDogZnVuY3Rpb24gKCkge30KfTsKCnZhciBSb3V0ZXIgPSBleHBvcnRzLlJvdXRlciA9IGZ1bmN0aW9uIChyb3V0ZXMpIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUm91dGVyKSkgcmV0dXJuIG5ldyBSb3V0ZXIocm91dGVzKTsKCiAgdGhpcy5wYXJhbXMgICA9IHt9OwogIHRoaXMucm91dGVzICAgPSB7fTsKICB0aGlzLm1ldGhvZHMgID0gWydvbicsICdvbmNlJywgJ2FmdGVyJywgJ2JlZm9yZSddOwogIHRoaXMuc2NvcGUgICAgPSBbXTsKICB0aGlzLl9tZXRob2RzID0ge307CgogIHRoaXMuX2luc2VydCA9IHRoaXMuaW5zZXJ0OwogIHRoaXMuaW5zZXJ0ID0gdGhpcy5pbnNlcnRFeDsKCiAgdGhpcy5oaXN0b3J5U3VwcG9ydCA9ICh3aW5kb3cuaGlzdG9yeSAhPSBudWxsID8gd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlIDogbnVsbCkgIT0gbnVsbAoKICB0aGlzLmNvbmZpZ3VyZSgpOwogIHRoaXMubW91bnQocm91dGVzIHx8IHt9KTsKfTsKClJvdXRlci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChyKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHRoaXMuaGFuZGxlciA9IGZ1bmN0aW9uKG9uQ2hhbmdlRXZlbnQpIHsKICAgIHZhciBuZXdVUkwgPSBvbkNoYW5nZUV2ZW50ICYmIG9uQ2hhbmdlRXZlbnQubmV3VVJMIHx8IHdpbmRvdy5sb2NhdGlvbi5oYXNoOwogICAgdmFyIHVybCA9IHNlbGYuaGlzdG9yeSA9PT0gdHJ1ZSA/IHNlbGYuZ2V0UGF0aCgpIDogbmV3VVJMLnJlcGxhY2UoLy4qIy8sICcnKTsKICAgIHNlbGYuZGlzcGF0Y2goJ29uJywgdXJsKTsKICB9OwoKICBsaXN0ZW5lci5pbml0KHRoaXMuaGFuZGxlciwgdGhpcy5oaXN0b3J5KTsKCiAgaWYgKHRoaXMuaGlzdG9yeSA9PT0gZmFsc2UpIHsKICAgIGlmIChkbG9jSGFzaEVtcHR5KCkgJiYgcikgewogICAgICBkbG9jLmhhc2ggPSByOwogICAgfSBlbHNlIGlmICghZGxvY0hhc2hFbXB0eSgpKSB7CiAgICAgIHNlbGYuZGlzcGF0Y2goJ29uJywgZGxvYy5oYXNoLnJlcGxhY2UoL14jLywgJycpKTsKICAgIH0KICB9CiAgZWxzZSB7CiAgICB2YXIgcm91dGVUbyA9IGRsb2NIYXNoRW1wdHkoKSAmJiByID8gciA6ICFkbG9jSGFzaEVtcHR5KCkgPyBkbG9jLmhhc2gucmVwbGFjZSgvXiMvLCAnJykgOiBudWxsOwogICAgaWYgKHJvdXRlVG8pIHsKICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgcm91dGVUbyk7CiAgICB9CgogICAgLy8gUm91dGVyIGhhcyBiZWVuIGluaXRpYWxpemVkLCBidXQgZHVlIHRvIHRoZSBjaHJvbWUgYnVnIGl0IHdpbGwgbm90CiAgICAvLyB5ZXQgYWN0dWFsbHkgcm91dGUgSFRNTDUgaGlzdG9yeSBzdGF0ZSBjaGFuZ2VzLiBUaHVzLCBkZWNpZGUgaWYgc2hvdWxkIHJvdXRlLgogICAgaWYgKHJvdXRlVG8gfHwgdGhpcy5ydW5faW5faW5pdCA9PT0gdHJ1ZSkgewogICAgICB0aGlzLmhhbmRsZXIoKTsKICAgIH0KICB9CgogIHJldHVybiB0aGlzOwp9OwoKUm91dGVyLnByb3RvdHlwZS5leHBsb2RlID0gZnVuY3Rpb24gKCkgewogIHZhciB2ID0gdGhpcy5oaXN0b3J5ID09PSB0cnVlID8gdGhpcy5nZXRQYXRoKCkgOiBkbG9jLmhhc2g7CiAgaWYgKHYuY2hhckF0KDEpID09PSAnLycpIHsgdj12LnNsaWNlKDEpIH0KICByZXR1cm4gdi5zbGljZSgxLCB2Lmxlbmd0aCkuc3BsaXQoIi8iKTsKfTsKClJvdXRlci5wcm90b3R5cGUuc2V0Um91dGUgPSBmdW5jdGlvbiAoaSwgdiwgdmFsKSB7CiAgdmFyIHVybCA9IHRoaXMuZXhwbG9kZSgpOwoKICBpZiAodHlwZW9mIGkgPT09ICdudW1iZXInICYmIHR5cGVvZiB2ID09PSAnc3RyaW5nJykgewogICAgdXJsW2ldID0gdjsKICB9CiAgZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgIHVybC5zcGxpY2UoaSwgdiwgcyk7CiAgfQogIGVsc2UgewogICAgdXJsID0gW2ldOwogIH0KCiAgbGlzdGVuZXIuc2V0SGFzaCh1cmwuam9pbignLycpKTsKICByZXR1cm4gdXJsOwp9OwoKLy8KLy8gIyMjIGZ1bmN0aW9uIGluc2VydEV4KG1ldGhvZCwgcGF0aCwgcm91dGUsIHBhcmVudCkKLy8gIyMjIyBAbWV0aG9kIHtzdHJpbmd9IE1ldGhvZCB0byBpbnNlcnQgdGhlIHNwZWNpZmljIGByb3V0ZWAuCi8vICMjIyMgQHBhdGgge0FycmF5fSBQYXJzZWQgcGF0aCB0byBpbnNlcnQgdGhlIGByb3V0ZWAgYXQuCi8vICMjIyMgQHJvdXRlIHtBcnJheXxmdW5jdGlvbn0gUm91dGUgaGFuZGxlcnMgdG8gaW5zZXJ0LgovLyAjIyMjIEBwYXJlbnQge09iamVjdH0gKipPcHRpb25hbCoqIFBhcmVudCAicm91dGVzIiB0byBpbnNlcnQgaW50by4KLy8gaW5zZXJ0IGEgY2FsbGJhY2sgdGhhdCB3aWxsIG9ubHkgb2NjdXIgb25jZSBwZXIgdGhlIG1hdGNoZWQgcm91dGUuCi8vClJvdXRlci5wcm90b3R5cGUuaW5zZXJ0RXggPSBmdW5jdGlvbihtZXRob2QsIHBhdGgsIHJvdXRlLCBwYXJlbnQpIHsKICBpZiAobWV0aG9kID09PSAib25jZSIpIHsKICAgIG1ldGhvZCA9ICJvbiI7CiAgICByb3V0ZSA9IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHZhciBvbmNlID0gZmFsc2U7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAob25jZSkgcmV0dXJuOwogICAgICAgIG9uY2UgPSB0cnVlOwogICAgICAgIHJldHVybiByb3V0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfShyb3V0ZSk7CiAgfQogIHJldHVybiB0aGlzLl9pbnNlcnQobWV0aG9kLCBwYXRoLCByb3V0ZSwgcGFyZW50KTsKfTsKClJvdXRlci5wcm90b3R5cGUuZ2V0Um91dGUgPSBmdW5jdGlvbiAodikgewogIHZhciByZXQgPSB2OwoKICBpZiAodHlwZW9mIHYgPT09ICJudW1iZXIiKSB7CiAgICByZXQgPSB0aGlzLmV4cGxvZGUoKVt2XTsKICB9CiAgZWxzZSBpZiAodHlwZW9mIHYgPT09ICJzdHJpbmciKXsKICAgIHZhciBoID0gdGhpcy5leHBsb2RlKCk7CiAgICByZXQgPSBoLmluZGV4T2Yodik7CiAgfQogIGVsc2UgewogICAgcmV0ID0gdGhpcy5leHBsb2RlKCk7CiAgfQoKICByZXR1cm4gcmV0Owp9OwoKUm91dGVyLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogIGxpc3RlbmVyLmRlc3Ryb3kodGhpcy5oYW5kbGVyKTsKICByZXR1cm4gdGhpczsKfTsKClJvdXRlci5wcm90b3R5cGUuZ2V0UGF0aCA9IGZ1bmN0aW9uICgpIHsKICB2YXIgcGF0aCA9IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZTsKICBpZiAocGF0aC5zdWJzdHIoMCwgMSkgIT09ICcvJykgewogICAgcGF0aCA9ICcvJyArIHBhdGg7CiAgfQogIHJldHVybiBwYXRoOwp9OwpmdW5jdGlvbiBfZXZlcnkoYXJyLCBpdGVyYXRvcikgewogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSArPSAxKSB7CiAgICBpZiAoaXRlcmF0b3IoYXJyW2ldLCBpLCBhcnIpID09PSBmYWxzZSkgewogICAgICByZXR1cm47CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBfZmxhdHRlbihhcnIpIHsKICB2YXIgZmxhdCA9IFtdOwogIGZvciAodmFyIGkgPSAwLCBuID0gYXJyLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgZmxhdCA9IGZsYXQuY29uY2F0KGFycltpXSk7CiAgfQogIHJldHVybiBmbGF0Owp9CgpmdW5jdGlvbiBfYXN5bmNFdmVyeVNlcmllcyhhcnIsIGl0ZXJhdG9yLCBjYWxsYmFjaykgewogIGlmICghYXJyLmxlbmd0aCkgewogICAgcmV0dXJuIGNhbGxiYWNrKCk7CiAgfQogIHZhciBjb21wbGV0ZWQgPSAwOwogIChmdW5jdGlvbiBpdGVyYXRlKCkgewogICAgaXRlcmF0b3IoYXJyW2NvbXBsZXRlZF0sIGZ1bmN0aW9uKGVycikgewogICAgICBpZiAoZXJyIHx8IGVyciA9PT0gZmFsc2UpIHsKICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb21wbGV0ZWQgKz0gMTsKICAgICAgICBpZiAoY29tcGxldGVkID09PSBhcnIubGVuZ3RoKSB7CiAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpdGVyYXRlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9KSgpOwp9CgpmdW5jdGlvbiBwYXJhbWlmeVN0cmluZyhzdHIsIHBhcmFtcywgbW9kKSB7CiAgbW9kID0gc3RyOwogIGZvciAodmFyIHBhcmFtIGluIHBhcmFtcykgewogICAgaWYgKHBhcmFtcy5oYXNPd25Qcm9wZXJ0eShwYXJhbSkpIHsKICAgICAgbW9kID0gcGFyYW1zW3BhcmFtXShzdHIpOwogICAgICBpZiAobW9kICE9PSBzdHIpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gbW9kID09PSBzdHIgPyAiKFsuX2EtekEtWjAtOS1dKykiIDogbW9kOwp9CgpmdW5jdGlvbiByZWdpZnlTdHJpbmcoc3RyLCBwYXJhbXMpIHsKICB2YXIgbWF0Y2hlcywgbGFzdCA9IDAsIG91dCA9ICIiOwogIHdoaWxlIChtYXRjaGVzID0gc3RyLnN1YnN0cihsYXN0KS5tYXRjaCgvW15cd1xkXC0gJUAmXSpcKlteXHdcZFwtICVAJl0qLykpIHsKICAgIGxhc3QgPSBtYXRjaGVzLmluZGV4ICsgbWF0Y2hlc1swXS5sZW5ndGg7CiAgICBtYXRjaGVzWzBdID0gbWF0Y2hlc1swXS5yZXBsYWNlKC9eXCovLCAiKFtfLigpIVxcICVAJmEtekEtWjAtOS1dKykiKTsKICAgIG91dCArPSBzdHIuc3Vic3RyKDAsIG1hdGNoZXMuaW5kZXgpICsgbWF0Y2hlc1swXTsKICB9CiAgc3RyID0gb3V0ICs9IHN0ci5zdWJzdHIobGFzdCk7CiAgdmFyIGNhcHR1cmVzID0gc3RyLm1hdGNoKC86KFteXC9dKykvaWcpLCBsZW5ndGg7CiAgaWYgKGNhcHR1cmVzKSB7CiAgICBsZW5ndGggPSBjYXB0dXJlcy5sZW5ndGg7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKGNhcHR1cmVzW2ldLCBwYXJhbWlmeVN0cmluZyhjYXB0dXJlc1tpXSwgcGFyYW1zKSk7CiAgICB9CiAgfQogIHJldHVybiBzdHI7Cn0KCmZ1bmN0aW9uIHRlcm1pbmF0b3Iocm91dGVzLCBkZWxpbWl0ZXIsIHN0YXJ0LCBzdG9wKSB7CiAgdmFyIGxhc3QgPSAwLCBsZWZ0ID0gMCwgcmlnaHQgPSAwLCBzdGFydCA9IChzdGFydCB8fCAiKCIpLnRvU3RyaW5nKCksIHN0b3AgPSAoc3RvcCB8fCAiKSIpLnRvU3RyaW5nKCksIGk7CiAgZm9yIChpID0gMDsgaSA8IHJvdXRlcy5sZW5ndGg7IGkrKykgewogICAgdmFyIGNodW5rID0gcm91dGVzW2ldOwogICAgaWYgKGNodW5rLmluZGV4T2Yoc3RhcnQsIGxhc3QpID4gY2h1bmsuaW5kZXhPZihzdG9wLCBsYXN0KSB8fCB+Y2h1bmsuaW5kZXhPZihzdGFydCwgbGFzdCkgJiYgIX5jaHVuay5pbmRleE9mKHN0b3AsIGxhc3QpIHx8ICF+Y2h1bmsuaW5kZXhPZihzdGFydCwgbGFzdCkgJiYgfmNodW5rLmluZGV4T2Yoc3RvcCwgbGFzdCkpIHsKICAgICAgbGVmdCA9IGNodW5rLmluZGV4T2Yoc3RhcnQsIGxhc3QpOwogICAgICByaWdodCA9IGNodW5rLmluZGV4T2Yoc3RvcCwgbGFzdCk7CiAgICAgIGlmICh+bGVmdCAmJiAhfnJpZ2h0IHx8ICF+bGVmdCAmJiB+cmlnaHQpIHsKICAgICAgICB2YXIgdG1wID0gcm91dGVzLnNsaWNlKDAsIChpIHx8IDEpICsgMSkuam9pbihkZWxpbWl0ZXIpOwogICAgICAgIHJvdXRlcyA9IFsgdG1wIF0uY29uY2F0KHJvdXRlcy5zbGljZSgoaSB8fCAxKSArIDEpKTsKICAgICAgfQogICAgICBsYXN0ID0gKHJpZ2h0ID4gbGVmdCA/IHJpZ2h0IDogbGVmdCkgKyAxOwogICAgICBpID0gMDsKICAgIH0gZWxzZSB7CiAgICAgIGxhc3QgPSAwOwogICAgfQogIH0KICByZXR1cm4gcm91dGVzOwp9CgpSb3V0ZXIucHJvdG90eXBlLmNvbmZpZ3VyZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubWV0aG9kcy5sZW5ndGg7IGkrKykgewogICAgdGhpcy5fbWV0aG9kc1t0aGlzLm1ldGhvZHNbaV1dID0gdHJ1ZTsKICB9CiAgdGhpcy5yZWN1cnNlID0gb3B0aW9ucy5yZWN1cnNlIHx8IHRoaXMucmVjdXJzZSB8fCBmYWxzZTsKICB0aGlzLmFzeW5jID0gb3B0aW9ucy5hc3luYyB8fCBmYWxzZTsKICB0aGlzLmRlbGltaXRlciA9IG9wdGlvbnMuZGVsaW1pdGVyIHx8ICIvIjsKICB0aGlzLnN0cmljdCA9IHR5cGVvZiBvcHRpb25zLnN0cmljdCA9PT0gInVuZGVmaW5lZCIgPyB0cnVlIDogb3B0aW9ucy5zdHJpY3Q7CiAgdGhpcy5ub3Rmb3VuZCA9IG9wdGlvbnMubm90Zm91bmQ7CiAgdGhpcy5yZXNvdXJjZSA9IG9wdGlvbnMucmVzb3VyY2U7CiAgdGhpcy5oaXN0b3J5ID0gb3B0aW9ucy5odG1sNWhpc3RvcnkgJiYgdGhpcy5oaXN0b3J5U3VwcG9ydCB8fCBmYWxzZTsKICB0aGlzLnJ1bl9pbl9pbml0ID0gdGhpcy5oaXN0b3J5ID09PSB0cnVlICYmIG9wdGlvbnMucnVuX2hhbmRsZXJfaW5faW5pdCAhPT0gZmFsc2U7CiAgdGhpcy5ldmVyeSA9IHsKICAgIGFmdGVyOiBvcHRpb25zLmFmdGVyIHx8IG51bGwsCiAgICBiZWZvcmU6IG9wdGlvbnMuYmVmb3JlIHx8IG51bGwsCiAgICBvbjogb3B0aW9ucy5vbiB8fCBudWxsCiAgfTsKICByZXR1cm4gdGhpczsKfTsKClJvdXRlci5wcm90b3R5cGUucGFyYW0gPSBmdW5jdGlvbih0b2tlbiwgbWF0Y2hlcikgewogIGlmICh0b2tlblswXSAhPT0gIjoiKSB7CiAgICB0b2tlbiA9ICI6IiArIHRva2VuOwogIH0KICB2YXIgY29tcGlsZWQgPSBuZXcgUmVnRXhwKHRva2VuLCAiZyIpOwogIHRoaXMucGFyYW1zW3Rva2VuXSA9IGZ1bmN0aW9uKHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKGNvbXBpbGVkLCBtYXRjaGVyLnNvdXJjZSB8fCBtYXRjaGVyKTsKICB9Owp9OwoKUm91dGVyLnByb3RvdHlwZS5vbiA9IFJvdXRlci5wcm90b3R5cGUucm91dGUgPSBmdW5jdGlvbihtZXRob2QsIHBhdGgsIHJvdXRlKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIGlmICghcm91dGUgJiYgdHlwZW9mIHBhdGggPT0gImZ1bmN0aW9uIikgewogICAgcm91dGUgPSBwYXRoOwogICAgcGF0aCA9IG1ldGhvZDsKICAgIG1ldGhvZCA9ICJvbiI7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KHBhdGgpKSB7CiAgICByZXR1cm4gcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKHApIHsKICAgICAgc2VsZi5vbihtZXRob2QsIHAsIHJvdXRlKTsKICAgIH0pOwogIH0KICBpZiAocGF0aC5zb3VyY2UpIHsKICAgIHBhdGggPSBwYXRoLnNvdXJjZS5yZXBsYWNlKC9cXFwvL2lnLCAiLyIpOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheShtZXRob2QpKSB7CiAgICByZXR1cm4gbWV0aG9kLmZvckVhY2goZnVuY3Rpb24obSkgewogICAgICBzZWxmLm9uKG0udG9Mb3dlckNhc2UoKSwgcGF0aCwgcm91dGUpOwogICAgfSk7CiAgfQogIHBhdGggPSBwYXRoLnNwbGl0KG5ldyBSZWdFeHAodGhpcy5kZWxpbWl0ZXIpKTsKICBwYXRoID0gdGVybWluYXRvcihwYXRoLCB0aGlzLmRlbGltaXRlcik7CiAgdGhpcy5pbnNlcnQobWV0aG9kLCB0aGlzLnNjb3BlLmNvbmNhdChwYXRoKSwgcm91dGUpOwp9OwoKUm91dGVyLnByb3RvdHlwZS5kaXNwYXRjaCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGF0aCwgY2FsbGJhY2spIHsKICB2YXIgc2VsZiA9IHRoaXMsIGZucyA9IHRoaXMudHJhdmVyc2UobWV0aG9kLCBwYXRoLCB0aGlzLnJvdXRlcywgIiIpLCBpbnZva2VkID0gdGhpcy5faW52b2tlZCwgYWZ0ZXI7CiAgdGhpcy5faW52b2tlZCA9IHRydWU7CiAgaWYgKCFmbnMgfHwgZm5zLmxlbmd0aCA9PT0gMCkgewogICAgdGhpcy5sYXN0ID0gW107CiAgICBpZiAodHlwZW9mIHRoaXMubm90Zm91bmQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhpcy5pbnZva2UoWyB0aGlzLm5vdGZvdW5kIF0sIHsKICAgICAgICBtZXRob2Q6IG1ldGhvZCwKICAgICAgICBwYXRoOiBwYXRoCiAgICAgIH0sIGNhbGxiYWNrKTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKHRoaXMucmVjdXJzZSA9PT0gImZvcndhcmQiKSB7CiAgICBmbnMgPSBmbnMucmV2ZXJzZSgpOwogIH0KICBmdW5jdGlvbiB1cGRhdGVBbmRJbnZva2UoKSB7CiAgICBzZWxmLmxhc3QgPSBmbnMuYWZ0ZXI7CiAgICBzZWxmLmludm9rZShzZWxmLnJ1bmxpc3QoZm5zKSwgc2VsZiwgY2FsbGJhY2spOwogIH0KICBhZnRlciA9IHRoaXMuZXZlcnkgJiYgdGhpcy5ldmVyeS5hZnRlciA/IFsgdGhpcy5ldmVyeS5hZnRlciBdLmNvbmNhdCh0aGlzLmxhc3QpIDogWyB0aGlzLmxhc3QgXTsKICBpZiAoYWZ0ZXIgJiYgYWZ0ZXIubGVuZ3RoID4gMCAmJiBpbnZva2VkKSB7CiAgICBpZiAodGhpcy5hc3luYykgewogICAgICB0aGlzLmludm9rZShhZnRlciwgdGhpcywgdXBkYXRlQW5kSW52b2tlKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuaW52b2tlKGFmdGVyLCB0aGlzKTsKICAgICAgdXBkYXRlQW5kSW52b2tlKCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgdXBkYXRlQW5kSW52b2tlKCk7CiAgcmV0dXJuIHRydWU7Cn07CgpSb3V0ZXIucHJvdG90eXBlLmludm9rZSA9IGZ1bmN0aW9uKGZucywgdGhpc0FyZywgY2FsbGJhY2spIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgaWYgKHRoaXMuYXN5bmMpIHsKICAgIF9hc3luY0V2ZXJ5U2VyaWVzKGZucywgZnVuY3Rpb24gYXBwbHkoZm4sIG5leHQpIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZm4pKSB7CiAgICAgICAgcmV0dXJuIF9hc3luY0V2ZXJ5U2VyaWVzKGZuLCBhcHBseSwgbmV4dCk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZuID09ICJmdW5jdGlvbiIpIHsKICAgICAgICBmbi5hcHBseSh0aGlzQXJnLCBmbnMuY2FwdHVyZXMuY29uY2F0KG5leHQpKTsKICAgICAgfQogICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXNBcmcsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH0pOwogIH0gZWxzZSB7CiAgICBfZXZlcnkoZm5zLCBmdW5jdGlvbiBhcHBseShmbikgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShmbikpIHsKICAgICAgICByZXR1cm4gX2V2ZXJ5KGZuLCBhcHBseSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXNBcmcsIGZucy5jYXB0dXJlcyB8fCBbXSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZuID09PSAic3RyaW5nIiAmJiBzZWxmLnJlc291cmNlKSB7CiAgICAgICAgc2VsZi5yZXNvdXJjZVtmbl0uYXBwbHkodGhpc0FyZywgZm5zLmNhcHR1cmVzIHx8IFtdKTsKICAgICAgfQogICAgfSk7CiAgfQp9OwoKUm91dGVyLnByb3RvdHlwZS50cmF2ZXJzZSA9IGZ1bmN0aW9uKG1ldGhvZCwgcGF0aCwgcm91dGVzLCByZWdleHAsIGZpbHRlcikgewogIHZhciBmbnMgPSBbXSwgY3VycmVudCwgZXhhY3QsIG1hdGNoLCBuZXh0LCB0aGF0OwogIGZ1bmN0aW9uIGZpbHRlclJvdXRlcyhyb3V0ZXMpIHsKICAgIGlmICghZmlsdGVyKSB7CiAgICAgIHJldHVybiByb3V0ZXM7CiAgICB9CiAgICBmdW5jdGlvbiBkZWVwQ29weShzb3VyY2UpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvdXJjZS5sZW5ndGg7IGkrKykgewogICAgICAgIHJlc3VsdFtpXSA9IEFycmF5LmlzQXJyYXkoc291cmNlW2ldKSA/IGRlZXBDb3B5KHNvdXJjZVtpXSkgOiBzb3VyY2VbaV07CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIGFwcGx5RmlsdGVyKGZucykgewogICAgICBmb3IgKHZhciBpID0gZm5zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZm5zW2ldKSkgewogICAgICAgICAgYXBwbHlGaWx0ZXIoZm5zW2ldKTsKICAgICAgICAgIGlmIChmbnNbaV0ubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGZucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghZmlsdGVyKGZuc1tpXSkpIHsKICAgICAgICAgICAgZm5zLnNwbGljZShpLCAxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHZhciBuZXdSb3V0ZXMgPSBkZWVwQ29weShyb3V0ZXMpOwogICAgbmV3Um91dGVzLm1hdGNoZWQgPSByb3V0ZXMubWF0Y2hlZDsKICAgIG5ld1JvdXRlcy5jYXB0dXJlcyA9IHJvdXRlcy5jYXB0dXJlczsKICAgIG5ld1JvdXRlcy5hZnRlciA9IHJvdXRlcy5hZnRlci5maWx0ZXIoZmlsdGVyKTsKICAgIGFwcGx5RmlsdGVyKG5ld1JvdXRlcyk7CiAgICByZXR1cm4gbmV3Um91dGVzOwogIH0KICBpZiAocGF0aCA9PT0gdGhpcy5kZWxpbWl0ZXIgJiYgcm91dGVzW21ldGhvZF0pIHsKICAgIG5leHQgPSBbIFsgcm91dGVzLmJlZm9yZSwgcm91dGVzW21ldGhvZF0gXS5maWx0ZXIoQm9vbGVhbikgXTsKICAgIG5leHQuYWZ0ZXIgPSBbIHJvdXRlcy5hZnRlciBdLmZpbHRlcihCb29sZWFuKTsKICAgIG5leHQubWF0Y2hlZCA9IHRydWU7CiAgICBuZXh0LmNhcHR1cmVzID0gW107CiAgICByZXR1cm4gZmlsdGVyUm91dGVzKG5leHQpOwogIH0KICBmb3IgKHZhciByIGluIHJvdXRlcykgewogICAgaWYgKHJvdXRlcy5oYXNPd25Qcm9wZXJ0eShyKSAmJiAoIXRoaXMuX21ldGhvZHNbcl0gfHwgdGhpcy5fbWV0aG9kc1tyXSAmJiB0eXBlb2Ygcm91dGVzW3JdID09PSAib2JqZWN0IiAmJiAhQXJyYXkuaXNBcnJheShyb3V0ZXNbcl0pKSkgewogICAgICBjdXJyZW50ID0gZXhhY3QgPSByZWdleHAgKyB0aGlzLmRlbGltaXRlciArIHI7CiAgICAgIGlmICghdGhpcy5zdHJpY3QpIHsKICAgICAgICBleGFjdCArPSAiWyIgKyB0aGlzLmRlbGltaXRlciArICJdPyI7CiAgICAgIH0KICAgICAgbWF0Y2ggPSBwYXRoLm1hdGNoKG5ldyBSZWdFeHAoIl4iICsgZXhhY3QpKTsKICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmIChtYXRjaFswXSAmJiBtYXRjaFswXSA9PSBwYXRoICYmIHJvdXRlc1tyXVttZXRob2RdKSB7CiAgICAgICAgbmV4dCA9IFsgWyByb3V0ZXNbcl0uYmVmb3JlLCByb3V0ZXNbcl1bbWV0aG9kXSBdLmZpbHRlcihCb29sZWFuKSBdOwogICAgICAgIG5leHQuYWZ0ZXIgPSBbIHJvdXRlc1tyXS5hZnRlciBdLmZpbHRlcihCb29sZWFuKTsKICAgICAgICBuZXh0Lm1hdGNoZWQgPSB0cnVlOwogICAgICAgIG5leHQuY2FwdHVyZXMgPSBtYXRjaC5zbGljZSgxKTsKICAgICAgICBpZiAodGhpcy5yZWN1cnNlICYmIHJvdXRlcyA9PT0gdGhpcy5yb3V0ZXMpIHsKICAgICAgICAgIG5leHQucHVzaChbIHJvdXRlcy5iZWZvcmUsIHJvdXRlcy5vbiBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICBuZXh0LmFmdGVyID0gbmV4dC5hZnRlci5jb25jYXQoWyByb3V0ZXMuYWZ0ZXIgXS5maWx0ZXIoQm9vbGVhbikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmlsdGVyUm91dGVzKG5leHQpOwogICAgICB9CiAgICAgIG5leHQgPSB0aGlzLnRyYXZlcnNlKG1ldGhvZCwgcGF0aCwgcm91dGVzW3JdLCBjdXJyZW50KTsKICAgICAgaWYgKG5leHQubWF0Y2hlZCkgewogICAgICAgIGlmIChuZXh0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgIGZucyA9IGZucy5jb25jYXQobmV4dCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnJlY3Vyc2UpIHsKICAgICAgICAgIGZucy5wdXNoKFsgcm91dGVzW3JdLmJlZm9yZSwgcm91dGVzW3JdLm9uIF0uZmlsdGVyKEJvb2xlYW4pKTsKICAgICAgICAgIG5leHQuYWZ0ZXIgPSBuZXh0LmFmdGVyLmNvbmNhdChbIHJvdXRlc1tyXS5hZnRlciBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICBpZiAocm91dGVzID09PSB0aGlzLnJvdXRlcykgewogICAgICAgICAgICBmbnMucHVzaChbIHJvdXRlc1siYmVmb3JlIl0sIHJvdXRlc1sib24iXSBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICAgIG5leHQuYWZ0ZXIgPSBuZXh0LmFmdGVyLmNvbmNhdChbIHJvdXRlc1siYWZ0ZXIiXSBdLmZpbHRlcihCb29sZWFuKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZucy5tYXRjaGVkID0gdHJ1ZTsKICAgICAgICBmbnMuY2FwdHVyZXMgPSBuZXh0LmNhcHR1cmVzOwogICAgICAgIGZucy5hZnRlciA9IG5leHQuYWZ0ZXI7CiAgICAgICAgcmV0dXJuIGZpbHRlclJvdXRlcyhmbnMpOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfTsKClJvdXRlci5wcm90b3R5cGUuaW5zZXJ0ID0gZnVuY3Rpb24obWV0aG9kLCBwYXRoLCByb3V0ZSwgcGFyZW50KSB7CiAgdmFyIG1ldGhvZFR5cGUsIHBhcmVudFR5cGUsIGlzQXJyYXksIG5lc3RlZCwgcGFydDsKICBwYXRoID0gcGF0aC5maWx0ZXIoZnVuY3Rpb24ocCkgewogICAgcmV0dXJuIHAgJiYgcC5sZW5ndGggPiAwOwogIH0pOwogIHBhcmVudCA9IHBhcmVudCB8fCB0aGlzLnJvdXRlczsKICBwYXJ0ID0gcGF0aC5zaGlmdCgpOwogIGlmICgvXDp8XCovLnRlc3QocGFydCkgJiYgIS9cXGR8XFx3Ly50ZXN0KHBhcnQpKSB7CiAgICBwYXJ0ID0gcmVnaWZ5U3RyaW5nKHBhcnQsIHRoaXMucGFyYW1zKTsKICB9CiAgaWYgKHBhdGgubGVuZ3RoID4gMCkgewogICAgcGFyZW50W3BhcnRdID0gcGFyZW50W3BhcnRdIHx8IHt9OwogICAgcmV0dXJuIHRoaXMuaW5zZXJ0KG1ldGhvZCwgcGF0aCwgcm91dGUsIHBhcmVudFtwYXJ0XSk7CiAgfQogIGlmICghcGFydCAmJiAhcGF0aC5sZW5ndGggJiYgcGFyZW50ID09PSB0aGlzLnJvdXRlcykgewogICAgbWV0aG9kVHlwZSA9IHR5cGVvZiBwYXJlbnRbbWV0aG9kXTsKICAgIHN3aXRjaCAobWV0aG9kVHlwZSkgewogICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgcGFyZW50W21ldGhvZF0gPSBbIHBhcmVudFttZXRob2RdLCByb3V0ZSBdOwogICAgICByZXR1cm47CiAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgcGFyZW50W21ldGhvZF0ucHVzaChyb3V0ZSk7CiAgICAgIHJldHVybjsKICAgICBjYXNlICJ1bmRlZmluZWQiOgogICAgICBwYXJlbnRbbWV0aG9kXSA9IHJvdXRlOwogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm47CiAgfQogIHBhcmVudFR5cGUgPSB0eXBlb2YgcGFyZW50W3BhcnRdOwogIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5KHBhcmVudFtwYXJ0XSk7CiAgaWYgKHBhcmVudFtwYXJ0XSAmJiAhaXNBcnJheSAmJiBwYXJlbnRUeXBlID09ICJvYmplY3QiKSB7CiAgICBtZXRob2RUeXBlID0gdHlwZW9mIHBhcmVudFtwYXJ0XVttZXRob2RdOwogICAgc3dpdGNoIChtZXRob2RUeXBlKSB7CiAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICBwYXJlbnRbcGFydF1bbWV0aG9kXSA9IFsgcGFyZW50W3BhcnRdW21ldGhvZF0sIHJvdXRlIF07CiAgICAgIHJldHVybjsKICAgICBjYXNlICJvYmplY3QiOgogICAgICBwYXJlbnRbcGFydF1bbWV0aG9kXS5wdXNoKHJvdXRlKTsKICAgICAgcmV0dXJuOwogICAgIGNhc2UgInVuZGVmaW5lZCI6CiAgICAgIHBhcmVudFtwYXJ0XVttZXRob2RdID0gcm91dGU7CiAgICAgIHJldHVybjsKICAgIH0KICB9IGVsc2UgaWYgKHBhcmVudFR5cGUgPT0gInVuZGVmaW5lZCIpIHsKICAgIG5lc3RlZCA9IHt9OwogICAgbmVzdGVkW21ldGhvZF0gPSByb3V0ZTsKICAgIHBhcmVudFtwYXJ0XSA9IG5lc3RlZDsKICAgIHJldHVybjsKICB9CiAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHJvdXRlIGNvbnRleHQ6ICIgKyBwYXJlbnRUeXBlKTsKfTsKCgoKUm91dGVyLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbihtZXRob2RzKSB7CiAgdmFyIHNlbGYgPSB0aGlzLCBsZW4gPSBtZXRob2RzLmxlbmd0aCwgaTsKICBmdW5jdGlvbiBleHRlbmQobWV0aG9kKSB7CiAgICBzZWxmLl9tZXRob2RzW21ldGhvZF0gPSB0cnVlOwogICAgc2VsZlttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBleHRyYSA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyBbIG1ldGhvZCwgIiIgXSA6IFsgbWV0aG9kIF07CiAgICAgIHNlbGYub24uYXBwbHkoc2VsZiwgZXh0cmEuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgIH07CiAgfQogIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgZXh0ZW5kKG1ldGhvZHNbaV0pOwogIH0KfTsKClJvdXRlci5wcm90b3R5cGUucnVubGlzdCA9IGZ1bmN0aW9uKGZucykgewogIHZhciBydW5saXN0ID0gdGhpcy5ldmVyeSAmJiB0aGlzLmV2ZXJ5LmJlZm9yZSA/IFsgdGhpcy5ldmVyeS5iZWZvcmUgXS5jb25jYXQoX2ZsYXR0ZW4oZm5zKSkgOiBfZmxhdHRlbihmbnMpOwogIGlmICh0aGlzLmV2ZXJ5ICYmIHRoaXMuZXZlcnkub24pIHsKICAgIHJ1bmxpc3QucHVzaCh0aGlzLmV2ZXJ5Lm9uKTsKICB9CiAgcnVubGlzdC5jYXB0dXJlcyA9IGZucy5jYXB0dXJlczsKICBydW5saXN0LnNvdXJjZSA9IGZucy5zb3VyY2U7CiAgcmV0dXJuIHJ1bmxpc3Q7Cn07CgpSb3V0ZXIucHJvdG90eXBlLm1vdW50ID0gZnVuY3Rpb24ocm91dGVzLCBwYXRoKSB7CiAgaWYgKCFyb3V0ZXMgfHwgdHlwZW9mIHJvdXRlcyAhPT0gIm9iamVjdCIgfHwgQXJyYXkuaXNBcnJheShyb3V0ZXMpKSB7CiAgICByZXR1cm47CiAgfQogIHZhciBzZWxmID0gdGhpczsKICBwYXRoID0gcGF0aCB8fCBbXTsKICBpZiAoIUFycmF5LmlzQXJyYXkocGF0aCkpIHsKICAgIHBhdGggPSBwYXRoLnNwbGl0KHNlbGYuZGVsaW1pdGVyKTsKICB9CiAgZnVuY3Rpb24gaW5zZXJ0T3JNb3VudChyb3V0ZSwgbG9jYWwpIHsKICAgIHZhciByZW5hbWUgPSByb3V0ZSwgcGFydHMgPSByb3V0ZS5zcGxpdChzZWxmLmRlbGltaXRlciksIHJvdXRlVHlwZSA9IHR5cGVvZiByb3V0ZXNbcm91dGVdLCBpc1JvdXRlID0gcGFydHNbMF0gPT09ICIiIHx8ICFzZWxmLl9tZXRob2RzW3BhcnRzWzBdXSwgZXZlbnQgPSBpc1JvdXRlID8gIm9uIiA6IHJlbmFtZTsKICAgIGlmIChpc1JvdXRlKSB7CiAgICAgIHJlbmFtZSA9IHJlbmFtZS5zbGljZSgocmVuYW1lLm1hdGNoKG5ldyBSZWdFeHAoc2VsZi5kZWxpbWl0ZXIpKSB8fCBbICIiIF0pWzBdLmxlbmd0aCk7CiAgICAgIHBhcnRzLnNoaWZ0KCk7CiAgICB9CiAgICBpZiAoaXNSb3V0ZSAmJiByb3V0ZVR5cGUgPT09ICJvYmplY3QiICYmICFBcnJheS5pc0FycmF5KHJvdXRlc1tyb3V0ZV0pKSB7CiAgICAgIGxvY2FsID0gbG9jYWwuY29uY2F0KHBhcnRzKTsKICAgICAgc2VsZi5tb3VudChyb3V0ZXNbcm91dGVdLCBsb2NhbCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpc1JvdXRlKSB7CiAgICAgIGxvY2FsID0gbG9jYWwuY29uY2F0KHJlbmFtZS5zcGxpdChzZWxmLmRlbGltaXRlcikpOwogICAgICBsb2NhbCA9IHRlcm1pbmF0b3IobG9jYWwsIHNlbGYuZGVsaW1pdGVyKTsKICAgIH0KICAgIHNlbGYuaW5zZXJ0KGV2ZW50LCBsb2NhbCwgcm91dGVzW3JvdXRlXSk7CiAgfQogIGZvciAodmFyIHJvdXRlIGluIHJvdXRlcykgewogICAgaWYgKHJvdXRlcy5oYXNPd25Qcm9wZXJ0eShyb3V0ZSkpIHsKICAgICAgaW5zZXJ0T3JNb3VudChyb3V0ZSwgcGF0aC5zbGljZSgwKSk7CiAgICB9CiAgfQp9OwoKCgp9KHR5cGVvZiBleHBvcnRzID09PSAib2JqZWN0IiA/IGV4cG9ydHMgOiB3aW5kb3cpKTsKZGVmaW5lKCJmbGF0aXJvbi9kaXJlY3RvciIsIChmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciByZXQsIGZuOwogICAgICAgIHJldHVybiByZXQgfHwgZ2xvYmFsLlJvdXRlcjsKICAgIH07Cn0odGhpcykpKTsKCmRlZmluZSgndGhydXN0L3NwYS9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QnLCAndGhydXN0L2xvZycsICdoYXMnLCAnZmxhdGlyb24vZGlyZWN0b3InLCAndGhydXN0L2luc3RhbmNlJywgJy4vY29uZmlnJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX3RocnVzdF9fLCBfX2xvZ19fLCBfX2hhc19fLCBfX2ZsYXRpcm9uUm91dGVyX18sIF9faW5zdGFuY2VfXywgX19jb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9zcGEvc3BhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciB0aHJ1c3QgPSBfX3RocnVzdF9fOwoKICAgIHZhciBUaHJ1c3QgPSB0aHJ1c3QuVGhydXN0OwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGZsYXRpcm9uUm91dGVyID0gX19mbGF0aXJvblJvdXRlcl9fOwoKICAgIHZhciBSb3V0ZXIgPSBmbGF0aXJvblJvdXRlci5Sb3V0ZXIgfHwgZmxhdGlyb25Sb3V0ZXI7CiAgICAKICAgIHZhciBpbnN0YW5jZSA9IF9faW5zdGFuY2VfXzsKCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICBleHBvcnRzLmNsYXNzTmFtZSA9ICdTaW5nbGVQYWdlQXBwbGljYXRpb24nOwogICAgY29uZmlnOwogICAgdmFyIGVhY2ggPSBfLmVhY2gsIGlzU3RyaW5nID0gXy5pc1N0cmluZywgaXNBcnJheSA9IF8uaXNBcnJheSwgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBpc1JlZ0V4cCA9IF8uaXNSZWdFeHAsIGV4dGVuZCA9IF8uZXh0ZW5kLCBvbmNlID0gXy5vbmNlLCB3aGVuID0gdXRpbC53aGVuLCBiaW5kID0gXy5iaW5kLCBpbnZva2UgPSBfLmludm9rZSwgcGx1Y2sgPSBfLnBsdWNrLCBtYXAgPSBfLm1hcCwgZGVmZXIgPSBfLmRlZmVyLCByZWR1Y2UgPSBfLnJlZHVjZSwgbWVtb2l6ZSA9IF8ubWVtb2l6ZSwgdG9BcnJheSA9IF8udG9BcnJheSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIFNUQVJUID0gJ3N0YXJ0JzsKICAgIHZhciBleHRyYWN0UGFyYW1zID0gZnVuY3Rpb24gKHJvdXRlKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IFtdLCBpbmRleCA9IHJvdXRlLmluZGV4T2YoJzonKSwgc2xhc2hJbmRleDsKICAgICAgICB3aGlsZShpbmRleCA+IC0xKSB7CiAgICAgICAgICAgIHNsYXNoSW5kZXggPSByb3V0ZS5pbmRleE9mKCcvJywgaW5kZXgpOwogICAgICAgICAgICBpZihzbGFzaEluZGV4ID09PSAtMSkgewogICAgICAgICAgICAgICAgc2xhc2hJbmRleCA9IHJvdXRlLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChyb3V0ZS5zdWJzdHJpbmcoaW5kZXgsIHNsYXNoSW5kZXggLSBpbmRleCArIDEpKTsKICAgICAgICAgICAgcm91dGUgPSByb3V0ZS5zdWJzdHJpbmcoc2xhc2hJbmRleCk7CiAgICAgICAgICAgIGluZGV4ID0gcm91dGUuaW5kZXhPZignOicpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFyYW1zOwogICAgfTsKICAgIHZhciBldmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoZXZlbnQsIG1lZGlhdG9yKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRmlyaW5nIHNwYSAiezB9IiB3aXRoIFt7MX1dJywgZXZlbnQsIHRvQXJyYXkoYXJndW1lbnRzKS5qb2luKCcsJykpKTsKICAgICAgICAgICAgbWVkaWF0b3IuZmlyZS5hc3luYy5hcHBseShtZWRpYXRvciwgWwogICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSk7CiAgICAgICAgfTsKICAgIH07CiAgICAvKioKICAgIAogICAgQGZvciB0aHJ1c3Quc3BhCiAgICBAY2xhc3MgdGhydXN0LnNwYS5TaW5nbGVQYWdlQXBwCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIHRocnVzdCBpbnN0YW5jZSBjb25maWd1cmF0aW9uCiAgICBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VOYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgbmFtZQogICAgQHBhcmFtIHt0aHJ1c3QubWVkaWF0b3JNZWRpYXRvcn0gbWVkaWF0b3IgVGhlIHRocnVzdCBpbnN0YW5jZSBtZWRpYXRvcgogICAgKiovCiAgICB2YXIgU2luZ2xlUGFnZUFwcGxpY2F0aW9uID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBTaW5nbGVQYWdlQXBwbGljYXRpb24oY29uZmlnLCBpbnN0YW5jZU5hbWUsIG1lZGlhdG9yKSB7CiAgICAgICAgICAgIHRoaXMuc3RhcnRpbmdNb2R1bGVQcm9taXNlID0gbnVsbDsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGF0LmJhc2VVcmwgPSBjb25maWcudXJsLnBhdGg7CiAgICAgICAgICAgIHZhciBzcGFDb25maWcgPSBjb25maWcuc3BhOwogICAgICAgICAgICB0aGF0LmZpbGVFeHRlbnNpb24gPSBzcGFDb25maWcuZmlsZUV4dGVuc2lvbjsKICAgICAgICAgICAgdmFyIHJvdXRlcyA9IHRoYXQuY29uZmlndXJlUm91dGVzKHNwYUNvbmZpZy5yb3V0ZXMpLCBwYXJhbXMgPSBzcGFDb25maWcucGFyYW1zOwogICAgICAgICAgICB2YXIgZXZlbnRGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRmlyaW5nIHNwYSAiezB9IiB3aXRoIFt7MX1dJywgZXZlbnQsIHRvQXJyYXkoYXJndW1lbnRzKS5qb2luKCcsJykpKTsKICAgICAgICAgICAgICAgICAgICBtZWRpYXRvci5maXJlLmFzeW5jLmFwcGx5KG1lZGlhdG9yLCBbCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIHJvdXRlciA9IHRoYXQucm91dGVyID0gbmV3IFJvdXRlcihyb3V0ZXMpLmNvbmZpZ3VyZSh7CiAgICAgICAgICAgICAgICByZWN1cnNlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHN0cmljdDogZmFsc2UsCiAgICAgICAgICAgICAgICBhc3luYzogZmFsc2UsCiAgICAgICAgICAgICAgICBodG1sNWhpc3Rvcnk6IHRydWUsCiAgICAgICAgICAgICAgICBub3Rmb3VuZDogZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JvdXRlL25vdGZvdW5kJyksCiAgICAgICAgICAgICAgICBiZWZvcmU6IGV2ZW50RmFjdG9yeSgndGhydXN0L3NwYS9yb3V0ZS9iZWZvcmUnKSwKICAgICAgICAgICAgICAgIG9uOiBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcm91dGUvcnVuJyksCiAgICAgICAgICAgICAgICBhZnRlcjogZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JvdXRlL2FmdGVyJykKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIF8uZWFjaChwYXJhbXMsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICByb3V0ZXIucGFyYW0oaSwgeCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvKioKICAgICAgICAgICAgU3RhcnQgdGhlIHNpbmdsZSBwYWdlIGFwcCByb3V0ZXIuCiAgICAgICAgICAgIAogICAgICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgICAgICoqLwogICAgICAgICAgICB0aGF0LnN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhhdC50aHJ1c3QgPSBpbnN0YW5jZS5nZXRJbnN0YW5jZShpbnN0YW5jZU5hbWUpOwogICAgICAgICAgICAgICAgdGhhdC5yb3V0ZXIuaW5pdCgpOwogICAgICAgICAgICAgICAgbWVkaWF0b3IuZmlyZS5hc3luYygndGhydXN0L3NwYS9zdGFydCcpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGF0Lm5hdmlnYXRlID0gdGhhdC5uYXZpZ2F0ZS5iaW5kKHRoYXQpOwogICAgICAgIH0KICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLm5hdmlnYXRlID0gLyoqCiAgICAgICAgTmF2aWdhdGVzIHRvIHRoZSBnaXZlbiB1cmwuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBuYXZpZ2F0ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBsb2NhdGlvbiBUaGUgbG9jYXRpb24gdG8gbmF2aWdhdGUgdG8uCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGxvY2F0aW9uKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdmFyIHVybCA9IHV0aWwuZml4dXBVcmwobG9jYXRpb24sIHRoYXQuYmFzZVVybCk7CiAgICAgICAgICAgIHRoYXQucm91dGVyLnNldFJvdXRlKHVybCk7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLnN0YXJ0ID0gLyoqCiAgICAgICAgU3RhcnQgdGhlIHNpbmdsZSBwYWdlIGFwcCByb3V0ZXIuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy50aHJ1c3QgPSBpbnN0YW5jZS5nZXRJbnN0YW5jZSh0aGlzLmluc3RhbmNlTmFtZSk7CiAgICAgICAgICAgIHRoaXMucm91dGVyLmluaXQoKTsKICAgICAgICAgICAgdGhpcy50aHJ1c3QubWVkaWF0b3IuZmlyZS5hc3luYygndGhydXN0L3NwYS9zdGFydCcpOwogICAgICAgIH07CiAgICAgICAgU2luZ2xlUGFnZUFwcGxpY2F0aW9uLnByb3RvdHlwZS5jb25maWd1cmVSb3V0ZXMgPSAvKioKICAgICAgICBDb25maWd1cmVzIHRoZSByb3V0ZSBvYmplY3QgZm9yIHRoZSBzcGEgaW5zdGFuY2UKICAgICAgICAKICAgICAgICBSb3V0ZXMgY2FuIGJlIGluIDQgZm9ybXMKICAgICAgICAKICAgICAgICB7CiAgICAgICAgJy9wYXRoL3RvLzpmb28nOiAncGF0aC90by9tb2R1bGUnLAogICAgICAgICcvcGF0aC90by86YmFyJzogWydwYXRoL3RvL21vZHVsZTEnLCAncGF0aC90by9tb2R1bGUyJ10sCiAgICAgICAgJy9wYXRoL3RvLzpmYic6IHsgcGF0aDogJ3BhdGgvdG8vbW9kdWxlJywgYXJnczogWydhcmdzJywgJ3RvJywgJ2hhbmQgb2ZmIHRvIHN0YXJ0J10gfQogICAgICAgICcvcGF0aC90by86Zm9vLzpiYXInOiBmdW5jdGlvbihmb28sIGJhcil7ICBjdXN0b20gaGFuZGxlciB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIEBtZXRob2QgY29uZmlndXJlUm91dGVzCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHJvdXRlcyBPYmplY3Qgb2Ygcm91dGVzLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChyb3V0ZXMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBjb25maWd1cmVkUm91dGVzID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICAvLyBlYWNoKHJvdXRlcywgZnVuY3Rpb24gKHZhbHVlLCByb3V0ZSkgewogICAgICAgICAgICBmb3IodmFyIHJvdXRlIGluIHJvdXRlcykgewogICAgICAgICAgICAgICAgaWYoXy5oYXMocm91dGVzLCByb3V0ZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSByb3V0ZXNbcm91dGVdOwogICAgICAgICAgICAgICAgICAgIHZhciByZWFsUm91dGUgPSB1dGlsLmZpeHVwVXJsKHJvdXRlLCB0aGF0LmJhc2VVcmwpOwogICAgICAgICAgICAgICAgICAgIGlmKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyZWRSb3V0ZXNbcmVhbFJvdXRlXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kdWxlcyA9IFtdLCBtZXRob2RzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSB2YWx1ZS5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2ID0gdmFsdWVbdl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1N0cmluZyh2KSB8fCBpc09iamVjdCh2KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZXMucHVzaCh2KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc0Z1bmN0aW9uKHYpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kcy5wdXNoKHYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVDYWxsYmFjayA9IHRoYXQubW9kdWxlU3RhcnRDYWxsYmFjayhyb3V0ZSwgbW9kdWxlcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZHMucHVzaChtb2R1bGVDYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyZWRSb3V0ZXNbcmVhbFJvdXRlXSA9IG1ldGhvZHM7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kdWxlQ2FsbGJhY2sgPSB0aGF0Lm1vZHVsZVN0YXJ0Q2FsbGJhY2socm91dGUsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJlZFJvdXRlc1tyZWFsUm91dGVdID0gbW9kdWxlQ2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vfSk7CiAgICAgICAgICAgIHJldHVybiBjb25maWd1cmVkUm91dGVzOwogICAgICAgIH07CiAgICAgICAgU2luZ2xlUGFnZUFwcGxpY2F0aW9uLnByb3RvdHlwZS5tb2R1bGVTdGFydENhbGxiYWNrID0gLyoqCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBtb2R1bGVTdGFydENhbGxiYWNrCiAgICAgICAgQHByaXZhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZyB8IEFycmF5IHwgT2JqZWN0fSBtb2R1bGVzIFN0cmluZyB0byBzdGFydCBhIHNpbmdsZSBtb2R1bGUsIEFycmF5IHRvIHN0YXJ0IG1hbnkgbW9kdWxlcywgT2JqZWN0IHRvIHN0YXJ0IGEgbW9kdWxlIHdpdGggc3BlY2lmaWMgYXJndW1lbnRzLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChyb3V0ZSwgbW9kdWxlcykgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdLCBwYXJhbXMgPSBleHRyYWN0UGFyYW1zKHJvdXRlKSwgdGhhdCA9IHRoaXMsIGZpbGVFeHRlbnNpb24gPSB0aGF0LmZpbGVFeHRlbnNpb247CiAgICAgICAgICAgIGlmKGlzT2JqZWN0KG1vZHVsZXMpKSB7CiAgICAgICAgICAgICAgICBhcmdzID0gbW9kdWxlcy5hcmdzIHx8IGFyZ3M7CiAgICAgICAgICAgICAgICBtb2R1bGVzID0gbW9kdWxlcy5wYXRoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGlzU3RyaW5nKG1vZHVsZXMpKSB7CiAgICAgICAgICAgICAgICBtb2R1bGVzID0gWwogICAgICAgICAgICAgICAgICAgIG1vZHVsZXMKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBhciA9IHRvQXJyYXkoYXJndW1lbnRzKSwgdGhydXN0ID0gdGhhdC50aHJ1c3QsIG1hcHBlZE1vZHVsZXMgPSBtYXAobW9kdWxlcywgZnVuY3Rpb24gKG1vZHVsZVBhdGgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVkdWNlKGFyLCBmdW5jdGlvbiAobWVtbywgYXJnLCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtZW1vLnJlcGxhY2UocGFyYW1zW2ldLCBhcmcudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgfSwgbW9kdWxlUGF0aCkucmVwbGFjZShmaWxlRXh0ZW5zaW9uLCAnJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhydXN0LnN0YXJ0LmFwcGx5KHRocnVzdCwgWwogICAgICAgICAgICAgICAgICAgIG1hcHBlZE1vZHVsZXMKICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LnRocnVzdC5zdGFydGVkKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhydXN0LnJlYWR5KG1hcHBlZE1vZHVsZXMsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhhdC5zdGFydGluZ01vZHVsZVByb21pc2UgPSBwcm9taXNlOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgU2luZ2xlUGFnZUFwcGxpY2F0aW9uLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSAvKioKICAgICAgICBIYW5kcyB0aGUgbmF2aWdhdGUgbWV0aG9kIG9mZiB0byB0aGUgbW9kdWxlLCBzbyBhbnkgbW9kdWxlIGNhbiB0cmlnZ2VyIGEgbmF2aWdhdGlvbiBldmVudC4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5zcGEuU2luZ2xlUGFnZUFwcAogICAgICAgIEBtZXRob2QgY3JlYXRlRmFjYWRlCiAgICAgICAgQHBhcmFtIHt0aHJ1c3QuVGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgIEBwYXJhbSB7dGhydXN0Lk1vZHVsZX0gbW9kIFRoZSBtb2R1bGUgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgYWxyZWFkeSBhZGRlZCBmb3IgdGhpcyBtb2R1bGUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYobW9kLm5hdmlnYXRlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJyJuYXZpZ2F0ZSIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEFscmVhZHkgcHJlIGJvdW5kLCBzbyB3ZSBvbmx5IHBhc3MgYXJvdW5kIDEgZnVuY3Rpb24gcGVyIGluc3RhbmNlLgogICAgICAgICAgICBtb2QubmF2aWdhdGUgPSB0aGF0Lm5hdmlnYXRlLmJpbmQodGhhdCk7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgU2luZ2xlUGFnZUFwcGxpY2F0aW9uLmNvbmZpZyA9IGNvbmZpZzsKICAgICAgICByZXR1cm4gU2luZ2xlUGFnZUFwcGxpY2F0aW9uOwogICAgfSkoKTsKICAgIGV4cG9ydHMuU2luZ2xlUGFnZUFwcGxpY2F0aW9uID0gU2luZ2xlUGFnZUFwcGxpY2F0aW9uOyAgICAKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9zcGEnLCBbJ3RocnVzdC9zcGEvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 20:05:27 GMT",
                    "Content-Length": "646654",
                    "Date": "Sat, 08 Nov 2014 20:05:28 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}