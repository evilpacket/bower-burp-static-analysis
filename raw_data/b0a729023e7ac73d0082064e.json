{
    "url": "http://localhost:9999/andreypopp/rrouter-build/rrouter.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location.href</b> and written to <b>window.location.replace()</b> via the following statements:<ul><li>var href = window.location.href.replace(/(javascript:|#).*$/, '');</li><li>window.location.replace(href + '#' + path);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/andreypopp/rrouter-build/rrouter.js",
                "path": "/andreypopp/rrouter-build/rrouter.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9hbmRyZXlwb3BwL3Jyb3V0ZXItYnVpbGQvcnJvdXRlci5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTAwNzUNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMDM6Mzk6NDUgR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDAzOjM5OjQ1IEdNVA0KDQooZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmaW5kIG1vZHVsZSAnIitvKyInIil9dmFyIGY9bltvXT17ZXhwb3J0czp7fX07dFtvXVswXS5jYWxsKGYuZXhwb3J0cyxmdW5jdGlvbihlKXt2YXIgbj10W29dWzFdW2VdO3JldHVybiBzKG4/bjplKX0sZixmLmV4cG9ydHMsZSx0LG4scil9cmV0dXJuIG5bb10uZXhwb3J0c312YXIgaT10eXBlb2YgcmVxdWlyZT09ImZ1bmN0aW9uIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkoezE6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIE9iamVjdCN0b1N0cmluZygpIHJlZiBmb3Igc3RyaW5naWZ5KCkuCiAqLwoKdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKCi8qKgogKiBPYmplY3QjaGFzT3duUHJvcGVydHkgcmVmCiAqLwoKdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKCi8qKgogKiBBcnJheSNpbmRleE9mIHNoaW0uCiAqLwoKdmFyIGluZGV4T2YgPSB0eXBlb2YgQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPT09ICdmdW5jdGlvbicKICA/IGZ1bmN0aW9uKGFyciwgZWwpIHsgcmV0dXJuIGFyci5pbmRleE9mKGVsKTsgfQogIDogZnVuY3Rpb24oYXJyLCBlbCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChhcnJbaV0gPT09IGVsKSByZXR1cm4gaTsKICAgICAgfQogICAgICByZXR1cm4gLTE7CiAgICB9OwoKLyoqCiAqIEFycmF5LmlzQXJyYXkgc2hpbS4KICovCgp2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24oYXJyKSB7CiAgcmV0dXJuIHRvU3RyaW5nLmNhbGwoYXJyKSA9PSAnW29iamVjdCBBcnJheV0nOwp9OwoKLyoqCiAqIE9iamVjdC5rZXlzIHNoaW0uCiAqLwoKdmFyIG9iamVjdEtleXMgPSBPYmplY3Qua2V5cyB8fCBmdW5jdGlvbihvYmopIHsKICB2YXIgcmV0ID0gW107CiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgIHJldC5wdXNoKGtleSk7CiAgICB9CiAgfQogIHJldHVybiByZXQ7Cn07CgovKioKICogQXJyYXkjZm9yRWFjaCBzaGltLgogKi8KCnZhciBmb3JFYWNoID0gdHlwZW9mIEFycmF5LnByb3RvdHlwZS5mb3JFYWNoID09PSAnZnVuY3Rpb24nCiAgPyBmdW5jdGlvbihhcnIsIGZuKSB7IHJldHVybiBhcnIuZm9yRWFjaChmbik7IH0KICA6IGZ1bmN0aW9uKGFyciwgZm4pIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIGZuKGFycltpXSk7CiAgICB9OwoKLyoqCiAqIEFycmF5I3JlZHVjZSBzaGltLgogKi8KCnZhciByZWR1Y2UgPSBmdW5jdGlvbihhcnIsIGZuLCBpbml0aWFsKSB7CiAgaWYgKHR5cGVvZiBhcnIucmVkdWNlID09PSAnZnVuY3Rpb24nKSByZXR1cm4gYXJyLnJlZHVjZShmbiwgaW5pdGlhbCk7CiAgdmFyIHJlcyA9IGluaXRpYWw7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHJlcyA9IGZuKHJlcywgYXJyW2ldKTsKICByZXR1cm4gcmVzOwp9OwoKLyoqCiAqIENhY2hlIG5vbi1pbnRlZ2VyIHRlc3QgcmVnZXhwLgogKi8KCnZhciBpc2ludCA9IC9eWzAtOV0rJC87CgpmdW5jdGlvbiBwcm9tb3RlKHBhcmVudCwga2V5KSB7CiAgaWYgKHBhcmVudFtrZXldLmxlbmd0aCA9PSAwKSByZXR1cm4gcGFyZW50W2tleV0gPSB7fQogIHZhciB0ID0ge307CiAgZm9yICh2YXIgaSBpbiBwYXJlbnRba2V5XSkgewogICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwocGFyZW50W2tleV0sIGkpKSB7CiAgICAgIHRbaV0gPSBwYXJlbnRba2V5XVtpXTsKICAgIH0KICB9CiAgcGFyZW50W2tleV0gPSB0OwogIHJldHVybiB0Owp9CgpmdW5jdGlvbiBwYXJzZShwYXJ0cywgcGFyZW50LCBrZXksIHZhbCkgewogIHZhciBwYXJ0ID0gcGFydHMuc2hpZnQoKTsKICAKICAvLyBpbGxlZ2FsCiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoT2JqZWN0LnByb3RvdHlwZSwga2V5KSkgcmV0dXJuOwogIAogIC8vIGVuZAogIGlmICghcGFydCkgewogICAgaWYgKGlzQXJyYXkocGFyZW50W2tleV0pKSB7CiAgICAgIHBhcmVudFtrZXldLnB1c2godmFsKTsKICAgIH0gZWxzZSBpZiAoJ29iamVjdCcgPT0gdHlwZW9mIHBhcmVudFtrZXldKSB7CiAgICAgIHBhcmVudFtrZXldID0gdmFsOwogICAgfSBlbHNlIGlmICgndW5kZWZpbmVkJyA9PSB0eXBlb2YgcGFyZW50W2tleV0pIHsKICAgICAgcGFyZW50W2tleV0gPSB2YWw7CiAgICB9IGVsc2UgewogICAgICBwYXJlbnRba2V5XSA9IFtwYXJlbnRba2V5XSwgdmFsXTsKICAgIH0KICAgIC8vIGFycmF5CiAgfSBlbHNlIHsKICAgIHZhciBvYmogPSBwYXJlbnRba2V5XSA9IHBhcmVudFtrZXldIHx8IFtdOwogICAgaWYgKCddJyA9PSBwYXJ0KSB7CiAgICAgIGlmIChpc0FycmF5KG9iaikpIHsKICAgICAgICBpZiAoJycgIT0gdmFsKSBvYmoucHVzaCh2YWwpOwogICAgICB9IGVsc2UgaWYgKCdvYmplY3QnID09IHR5cGVvZiBvYmopIHsKICAgICAgICBvYmpbb2JqZWN0S2V5cyhvYmopLmxlbmd0aF0gPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb2JqID0gcGFyZW50W2tleV0gPSBbcGFyZW50W2tleV0sIHZhbF07CiAgICAgIH0KICAgICAgLy8gcHJvcAogICAgfSBlbHNlIGlmICh+aW5kZXhPZihwYXJ0LCAnXScpKSB7CiAgICAgIHBhcnQgPSBwYXJ0LnN1YnN0cigwLCBwYXJ0Lmxlbmd0aCAtIDEpOwogICAgICBpZiAoIWlzaW50LnRlc3QocGFydCkgJiYgaXNBcnJheShvYmopKSBvYmogPSBwcm9tb3RlKHBhcmVudCwga2V5KTsKICAgICAgcGFyc2UocGFydHMsIG9iaiwgcGFydCwgdmFsKTsKICAgICAgLy8ga2V5CiAgICB9IGVsc2UgewogICAgICBpZiAoIWlzaW50LnRlc3QocGFydCkgJiYgaXNBcnJheShvYmopKSBvYmogPSBwcm9tb3RlKHBhcmVudCwga2V5KTsKICAgICAgcGFyc2UocGFydHMsIG9iaiwgcGFydCwgdmFsKTsKICAgIH0KICB9Cn0KCi8qKgogKiBNZXJnZSBwYXJlbnQga2V5L3ZhbCBwYWlyLgogKi8KCmZ1bmN0aW9uIG1lcmdlKHBhcmVudCwga2V5LCB2YWwpewogIGlmICh+aW5kZXhPZihrZXksICddJykpIHsKICAgIHZhciBwYXJ0cyA9IGtleS5zcGxpdCgnWycpCiAgICAgICwgbGVuID0gcGFydHMubGVuZ3RoCiAgICAgICwgbGFzdCA9IGxlbiAtIDE7CiAgICBwYXJzZShwYXJ0cywgcGFyZW50LCAnYmFzZScsIHZhbCk7CiAgICAvLyBvcHRpbWl6ZQogIH0gZWxzZSB7CiAgICBpZiAoIWlzaW50LnRlc3Qoa2V5KSAmJiBpc0FycmF5KHBhcmVudC5iYXNlKSkgewogICAgICB2YXIgdCA9IHt9OwogICAgICBmb3IgKHZhciBrIGluIHBhcmVudC5iYXNlKSB0W2tdID0gcGFyZW50LmJhc2Vba107CiAgICAgIHBhcmVudC5iYXNlID0gdDsKICAgIH0KICAgIHNldChwYXJlbnQuYmFzZSwga2V5LCB2YWwpOwogIH0KCiAgcmV0dXJuIHBhcmVudDsKfQoKLyoqCiAqIENvbXBhY3Qgc3BhcnNlIGFycmF5cy4KICovCgpmdW5jdGlvbiBjb21wYWN0KG9iaikgewogIGlmICgnb2JqZWN0JyAhPSB0eXBlb2Ygb2JqKSByZXR1cm4gb2JqOwoKICBpZiAoaXNBcnJheShvYmopKSB7CiAgICB2YXIgcmV0ID0gW107CgogICAgZm9yICh2YXIgaSBpbiBvYmopIHsKICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqLCBpKSkgewogICAgICAgIHJldC5wdXNoKG9ialtpXSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH0KCiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgb2JqW2tleV0gPSBjb21wYWN0KG9ialtrZXldKTsKICB9CgogIHJldHVybiBvYmo7Cn0KCi8qKgogKiBQYXJzZSB0aGUgZ2l2ZW4gb2JqLgogKi8KCmZ1bmN0aW9uIHBhcnNlT2JqZWN0KG9iail7CiAgdmFyIHJldCA9IHsgYmFzZToge30gfTsKCiAgZm9yRWFjaChvYmplY3RLZXlzKG9iaiksIGZ1bmN0aW9uKG5hbWUpewogICAgbWVyZ2UocmV0LCBuYW1lLCBvYmpbbmFtZV0pOwogIH0pOwoKICByZXR1cm4gY29tcGFjdChyZXQuYmFzZSk7Cn0KCi8qKgogKiBQYXJzZSB0aGUgZ2l2ZW4gc3RyLgogKi8KCmZ1bmN0aW9uIHBhcnNlU3RyaW5nKHN0cil7CiAgdmFyIHJldCA9IHJlZHVjZShTdHJpbmcoc3RyKS5zcGxpdCgnJicpLCBmdW5jdGlvbihyZXQsIHBhaXIpewogICAgdmFyIGVxbCA9IGluZGV4T2YocGFpciwgJz0nKQogICAgICAsIGJyYWNlID0gbGFzdEJyYWNlSW5LZXkocGFpcikKICAgICAgLCBrZXkgPSBwYWlyLnN1YnN0cigwLCBicmFjZSB8fCBlcWwpCiAgICAgICwgdmFsID0gcGFpci5zdWJzdHIoYnJhY2UgfHwgZXFsLCBwYWlyLmxlbmd0aCkKICAgICAgLCB2YWwgPSB2YWwuc3Vic3RyKGluZGV4T2YodmFsLCAnPScpICsgMSwgdmFsLmxlbmd0aCk7CgogICAgLy8gP2ZvbwogICAgaWYgKCcnID09IGtleSkga2V5ID0gcGFpciwgdmFsID0gJyc7CiAgICBpZiAoJycgPT0ga2V5KSByZXR1cm4gcmV0OwoKICAgIHJldHVybiBtZXJnZShyZXQsIGRlY29kZShrZXkpLCBkZWNvZGUodmFsKSk7CiAgfSwgeyBiYXNlOiB7fSB9KS5iYXNlOwoKICByZXR1cm4gY29tcGFjdChyZXQpOwp9CgovKioKICogUGFyc2UgdGhlIGdpdmVuIHF1ZXJ5IGBzdHJgIG9yIGBvYmpgLCByZXR1cm5pbmcgYW4gb2JqZWN0LgogKgogKiBAcGFyYW0ge1N0cmluZ30gc3RyIHwge09iamVjdH0gb2JqCiAqIEByZXR1cm4ge09iamVjdH0KICogQGFwaSBwdWJsaWMKICovCgpleHBvcnRzLnBhcnNlID0gZnVuY3Rpb24oc3RyKXsKICBpZiAobnVsbCA9PSBzdHIgfHwgJycgPT0gc3RyKSByZXR1cm4ge307CiAgcmV0dXJuICdvYmplY3QnID09IHR5cGVvZiBzdHIKICAgID8gcGFyc2VPYmplY3Qoc3RyKQogICAgOiBwYXJzZVN0cmluZyhzdHIpOwp9OwoKLyoqCiAqIFR1cm4gdGhlIGdpdmVuIGBvYmpgIGludG8gYSBxdWVyeSBzdHJpbmcKICoKICogQHBhcmFtIHtPYmplY3R9IG9iagogKiBAcmV0dXJuIHtTdHJpbmd9CiAqIEBhcGkgcHVibGljCiAqLwoKdmFyIHN0cmluZ2lmeSA9IGV4cG9ydHMuc3RyaW5naWZ5ID0gZnVuY3Rpb24ob2JqLCBwcmVmaXgpIHsKICBpZiAoaXNBcnJheShvYmopKSB7CiAgICByZXR1cm4gc3RyaW5naWZ5QXJyYXkob2JqLCBwcmVmaXgpOwogIH0gZWxzZSBpZiAoJ1tvYmplY3QgT2JqZWN0XScgPT0gdG9TdHJpbmcuY2FsbChvYmopKSB7CiAgICByZXR1cm4gc3RyaW5naWZ5T2JqZWN0KG9iaiwgcHJlZml4KTsKICB9IGVsc2UgaWYgKCdzdHJpbmcnID09IHR5cGVvZiBvYmopIHsKICAgIHJldHVybiBzdHJpbmdpZnlTdHJpbmcob2JqLCBwcmVmaXgpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gcHJlZml4ICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KFN0cmluZyhvYmopKTsKICB9Cn07CgovKioKICogU3RyaW5naWZ5IHRoZSBnaXZlbiBgc3RyYC4KICoKICogQHBhcmFtIHtTdHJpbmd9IHN0cgogKiBAcGFyYW0ge1N0cmluZ30gcHJlZml4CiAqIEByZXR1cm4ge1N0cmluZ30KICogQGFwaSBwcml2YXRlCiAqLwoKZnVuY3Rpb24gc3RyaW5naWZ5U3RyaW5nKHN0ciwgcHJlZml4KSB7CiAgaWYgKCFwcmVmaXgpIHRocm93IG5ldyBUeXBlRXJyb3IoJ3N0cmluZ2lmeSBleHBlY3RzIGFuIG9iamVjdCcpOwogIHJldHVybiBwcmVmaXggKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyKTsKfQoKLyoqCiAqIFN0cmluZ2lmeSB0aGUgZ2l2ZW4gYGFycmAuCiAqCiAqIEBwYXJhbSB7QXJyYXl9IGFycgogKiBAcGFyYW0ge1N0cmluZ30gcHJlZml4CiAqIEByZXR1cm4ge1N0cmluZ30KICogQGFwaSBwcml2YXRlCiAqLwoKZnVuY3Rpb24gc3RyaW5naWZ5QXJyYXkoYXJyLCBwcmVmaXgpIHsKICB2YXIgcmV0ID0gW107CiAgaWYgKCFwcmVmaXgpIHRocm93IG5ldyBUeXBlRXJyb3IoJ3N0cmluZ2lmeSBleHBlY3RzIGFuIG9iamVjdCcpOwogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICByZXQucHVzaChzdHJpbmdpZnkoYXJyW2ldLCBwcmVmaXggKyAnWycgKyBpICsgJ10nKSk7CiAgfQogIHJldHVybiByZXQuam9pbignJicpOwp9CgovKioKICogU3RyaW5naWZ5IHRoZSBnaXZlbiBgb2JqYC4KICoKICogQHBhcmFtIHtPYmplY3R9IG9iagogKiBAcGFyYW0ge1N0cmluZ30gcHJlZml4CiAqIEByZXR1cm4ge1N0cmluZ30KICogQGFwaSBwcml2YXRlCiAqLwoKZnVuY3Rpb24gc3RyaW5naWZ5T2JqZWN0KG9iaiwgcHJlZml4KSB7CiAgdmFyIHJldCA9IFtdCiAgICAsIGtleXMgPSBvYmplY3RLZXlzKG9iaikKICAgICwga2V5OwoKICBmb3IgKHZhciBpID0gMCwgbGVuID0ga2V5cy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAga2V5ID0ga2V5c1tpXTsKICAgIGlmICgnJyA9PSBrZXkpIGNvbnRpbnVlOwogICAgaWYgKG51bGwgPT0gb2JqW2tleV0pIHsKICAgICAgcmV0LnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KGtleSkgKyAnPScpOwogICAgfSBlbHNlIHsKICAgICAgcmV0LnB1c2goc3RyaW5naWZ5KG9ialtrZXldLCBwcmVmaXgKICAgICAgICA/IHByZWZpeCArICdbJyArIGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgJ10nCiAgICAgICAgOiBlbmNvZGVVUklDb21wb25lbnQoa2V5KSkpOwogICAgfQogIH0KCiAgcmV0dXJuIHJldC5qb2luKCcmJyk7Cn0KCi8qKgogKiBTZXQgYG9iamAncyBga2V5YCB0byBgdmFsYCByZXNwZWN0aW5nCiAqIHRoZSB3ZWlyZCBhbmQgd29uZGVyZnVsIHN5bnRheCBvZiBhIHFzLAogKiB3aGVyZSAiZm9vPWJhciZmb289YmF6IiBiZWNvbWVzIGFuIGFycmF5LgogKgogKiBAcGFyYW0ge09iamVjdH0gb2JqCiAqIEBwYXJhbSB7U3RyaW5nfSBrZXkKICogQHBhcmFtIHtTdHJpbmd9IHZhbAogKiBAYXBpIHByaXZhdGUKICovCgpmdW5jdGlvbiBzZXQob2JqLCBrZXksIHZhbCkgewogIHZhciB2ID0gb2JqW2tleV07CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoT2JqZWN0LnByb3RvdHlwZSwga2V5KSkgcmV0dXJuOwogIGlmICh1bmRlZmluZWQgPT09IHYpIHsKICAgIG9ialtrZXldID0gdmFsOwogIH0gZWxzZSBpZiAoaXNBcnJheSh2KSkgewogICAgdi5wdXNoKHZhbCk7CiAgfSBlbHNlIHsKICAgIG9ialtrZXldID0gW3YsIHZhbF07CiAgfQp9CgovKioKICogTG9jYXRlIGxhc3QgYnJhY2UgaW4gYHN0cmAgd2l0aGluIHRoZSBrZXkuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBzdHIKICogQHJldHVybiB7TnVtYmVyfQogKiBAYXBpIHByaXZhdGUKICovCgpmdW5jdGlvbiBsYXN0QnJhY2VJbktleShzdHIpIHsKICB2YXIgbGVuID0gc3RyLmxlbmd0aAogICAgLCBicmFjZQogICAgLCBjOwogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgIGMgPSBzdHJbaV07CiAgICBpZiAoJ10nID09IGMpIGJyYWNlID0gZmFsc2U7CiAgICBpZiAoJ1snID09IGMpIGJyYWNlID0gdHJ1ZTsKICAgIGlmICgnPScgPT0gYyAmJiAhYnJhY2UpIHJldHVybiBpOwogIH0KfQoKLyoqCiAqIERlY29kZSBgc3RyYC4KICoKICogQHBhcmFtIHtTdHJpbmd9IHN0cgogKiBAcmV0dXJuIHtTdHJpbmd9CiAqIEBhcGkgcHJpdmF0ZQogKi8KCmZ1bmN0aW9uIGRlY29kZShzdHIpIHsKICB0cnkgewogICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChzdHIucmVwbGFjZSgvXCsvZywgJyAnKSk7CiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gc3RyOwogIH0KfQoKfSx7fV0sMjpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovLyBHZW5lcmF0ZWQgYnkgQ29mZmVlU2NyaXB0IDEuNy4xCnZhciBfX2luZGV4T2YgPSBbXS5pbmRleE9mIHx8IGZ1bmN0aW9uKGl0ZW0pIHsgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKykgeyBpZiAoaSBpbiB0aGlzICYmIHRoaXNbaV0gPT09IGl0ZW0pIHJldHVybiBpOyB9IHJldHVybiAtMTsgfTsKCm1vZHVsZS5leHBvcnRzID0gewogIFBhdHRlcm5Qcm90b3R5cGU6IHsKICAgIG1hdGNoOiBmdW5jdGlvbih1cmwpIHsKICAgICAgdmFyIGJvdW5kLCBjYXB0dXJlZCwgaSwgbWF0Y2gsIG5hbWUsIHZhbHVlLCBfaSwgX2xlbjsKICAgICAgbWF0Y2ggPSB0aGlzLnJlZ2V4LmV4ZWModXJsKTsKICAgICAgaWYgKG1hdGNoID09IG51bGwpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBjYXB0dXJlZCA9IG1hdGNoLnNsaWNlKDEpOwogICAgICBpZiAodGhpcy5pc1JlZ2V4KSB7CiAgICAgICAgcmV0dXJuIGNhcHR1cmVkOwogICAgICB9CiAgICAgIGJvdW5kID0ge307CiAgICAgIGZvciAoaSA9IF9pID0gMCwgX2xlbiA9IGNhcHR1cmVkLmxlbmd0aDsgX2kgPCBfbGVuOyBpID0gKytfaSkgewogICAgICAgIHZhbHVlID0gY2FwdHVyZWRbaV07CiAgICAgICAgbmFtZSA9IHRoaXMubmFtZXNbaV07CiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAobmFtZSA9PT0gJ18nKSB7CiAgICAgICAgICBpZiAoYm91bmQuXyA9PSBudWxsKSB7CiAgICAgICAgICAgIGJvdW5kLl8gPSBbXTsKICAgICAgICAgIH0KICAgICAgICAgIGJvdW5kLl8ucHVzaCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJvdW5kW25hbWVdID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBib3VuZDsKICAgIH0KICB9LAogIG5ld1BhdHRlcm46IGZ1bmN0aW9uKGFyZywgc2VwYXJhdG9yKSB7CiAgICB2YXIgaXNSZWdleCwgcGF0dGVybiwgcmVnZXhTdHJpbmc7CiAgICBpZiAoc2VwYXJhdG9yID09IG51bGwpIHsKICAgICAgc2VwYXJhdG9yID0gJy8nOwogICAgfQogICAgaXNSZWdleCA9IGFyZyBpbnN0YW5jZW9mIFJlZ0V4cDsKICAgIGlmICghKCgnc3RyaW5nJyA9PT0gdHlwZW9mIGFyZykgfHwgaXNSZWdleCkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignYXJndW1lbnQgbXVzdCBiZSBhIHJlZ2V4IG9yIGEgc3RyaW5nJyk7CiAgICB9CiAgICBbJzonLCAnKiddLmZvckVhY2goZnVuY3Rpb24oZm9yYmlkZGVuKSB7CiAgICAgIGlmIChzZXBhcmF0b3IgPT09IGZvcmJpZGRlbikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigic2VwYXJhdG9yIGNhbid0IGJlICIgKyBmb3JiaWRkZW4pOwogICAgICB9CiAgICB9KTsKICAgIHBhdHRlcm4gPSBPYmplY3QuY3JlYXRlKG1vZHVsZS5leHBvcnRzLlBhdHRlcm5Qcm90b3R5cGUpOwogICAgcGF0dGVybi5pc1JlZ2V4ID0gaXNSZWdleDsKICAgIHBhdHRlcm4ucmVnZXggPSBpc1JlZ2V4ID8gYXJnIDogKHJlZ2V4U3RyaW5nID0gbW9kdWxlLmV4cG9ydHMudG9SZWdleFN0cmluZyhhcmcsIHNlcGFyYXRvciksIG5ldyBSZWdFeHAocmVnZXhTdHJpbmcpKTsKICAgIGlmICghaXNSZWdleCkgewogICAgICBwYXR0ZXJuLm5hbWVzID0gbW9kdWxlLmV4cG9ydHMuZ2V0TmFtZXMoYXJnLCBzZXBhcmF0b3IpOwogICAgfQogICAgcmV0dXJuIHBhdHRlcm47CiAgfSwKICBlc2NhcGVGb3JSZWdleDogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoL1stXC9cXF4kKis/LigpfFtcXXt9XS9nLCAnXFwkJicpOwogIH0sCiAgZ2V0TmFtZXM6IGZ1bmN0aW9uKGFyZywgc2VwYXJhdG9yKSB7CiAgICB2YXIgZXNjYXBlZFNlcGFyYXRvciwgbmFtZSwgbmFtZXMsIHJlZ2V4LCByZXN1bHRzOwogICAgaWYgKHNlcGFyYXRvciA9PSBudWxsKSB7CiAgICAgIHNlcGFyYXRvciA9ICcvJzsKICAgIH0KICAgIGlmIChhcmcgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQogICAgZXNjYXBlZFNlcGFyYXRvciA9IG1vZHVsZS5leHBvcnRzLmVzY2FwZUZvclJlZ2V4KHNlcGFyYXRvcik7CiAgICByZWdleCA9IG5ldyBSZWdFeHAoIigoOj86W14iICsgZXNjYXBlZFNlcGFyYXRvciArICJcKFwpXSspfCg/OltcKl0pKSIsICdnJyk7CiAgICBuYW1lcyA9IFtdOwogICAgcmVzdWx0cyA9IHJlZ2V4LmV4ZWMoYXJnKTsKICAgIHdoaWxlIChyZXN1bHRzICE9IG51bGwpIHsKICAgICAgbmFtZSA9IHJlc3VsdHNbMV0uc2xpY2UoMSk7CiAgICAgIGlmIChuYW1lID09PSAnXycpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCI6XyBjYW4ndCBiZSB1c2VkIGFzIGEgcGF0dGVybiBuYW1lIGluIHBhdHRlcm4gIiArIGFyZyk7CiAgICAgIH0KICAgICAgaWYgKF9faW5kZXhPZi5jYWxsKG5hbWVzLCBuYW1lKSA+PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiZHVwbGljYXRlIHBhdHRlcm4gbmFtZSA6IiArIG5hbWUgKyAiIGluIHBhdHRlcm4gIiArIGFyZyk7CiAgICAgIH0KICAgICAgbmFtZXMucHVzaChuYW1lIHx8ICdfJyk7CiAgICAgIHJlc3VsdHMgPSByZWdleC5leGVjKGFyZyk7CiAgICB9CiAgICByZXR1cm4gbmFtZXM7CiAgfSwKICBlc2NhcGVTZXBhcmF0b3JzOiBmdW5jdGlvbihzdHJpbmcsIHNlcGFyYXRvcikgewogICAgdmFyIGVzY2FwZWRTZXBhcmF0b3IsIHJlZ2V4OwogICAgaWYgKHNlcGFyYXRvciA9PSBudWxsKSB7CiAgICAgIHNlcGFyYXRvciA9ICcvJzsKICAgIH0KICAgIGVzY2FwZWRTZXBhcmF0b3IgPSBtb2R1bGUuZXhwb3J0cy5lc2NhcGVGb3JSZWdleChzZXBhcmF0b3IpOwogICAgcmVnZXggPSBuZXcgUmVnRXhwKGVzY2FwZWRTZXBhcmF0b3IsICdnJyk7CiAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UocmVnZXgsIGVzY2FwZWRTZXBhcmF0b3IpOwogIH0sCiAgdG9SZWdleFN0cmluZzogZnVuY3Rpb24oc3RyaW5nLCBzZXBhcmF0b3IpIHsKICAgIHZhciBlc2NhcGVkU2VwYXJhdG9yLCBzdHJpbmdXaXRoRXNjYXBlZFNlcGFyYXRvcnM7CiAgICBpZiAoc2VwYXJhdG9yID09IG51bGwpIHsKICAgICAgc2VwYXJhdG9yID0gJy8nOwogICAgfQogICAgc3RyaW5nV2l0aEVzY2FwZWRTZXBhcmF0b3JzID0gbW9kdWxlLmV4cG9ydHMuZXNjYXBlU2VwYXJhdG9ycyhzdHJpbmcsIHNlcGFyYXRvcik7CiAgICBzdHJpbmdXaXRoRXNjYXBlZFNlcGFyYXRvcnMgPSBzdHJpbmdXaXRoRXNjYXBlZFNlcGFyYXRvcnMucmVwbGFjZSgvXCgoLio/KVwpL2csICcoPzokMSk/JykucmVwbGFjZSgvXCovZywgJyguKj8pJyk7CiAgICBlc2NhcGVkU2VwYXJhdG9yID0gbW9kdWxlLmV4cG9ydHMuZXNjYXBlRm9yUmVnZXgoc2VwYXJhdG9yKTsKICAgIG1vZHVsZS5leHBvcnRzLmdldE5hbWVzKHN0cmluZywgc2VwYXJhdG9yKS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgcmV0dXJuIHN0cmluZ1dpdGhFc2NhcGVkU2VwYXJhdG9ycyA9IHN0cmluZ1dpdGhFc2NhcGVkU2VwYXJhdG9ycy5yZXBsYWNlKCc6JyArIG5hbWUsICIoW15cXCIgKyBzZXBhcmF0b3IgKyAiXSspIik7CiAgICB9KTsKICAgIHJldHVybiAiXiIgKyBzdHJpbmdXaXRoRXNjYXBlZFNlcGFyYXRvcnMgKyAiJCI7CiAgfQp9OwoKfSx7fV0sMzpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewo7KGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgZGVmaW5lKFsncmVhY3QnLCAnYmx1ZWJpcmQnXSwgZmFjdG9yeSk7CiAgfSBlbHNlIHsKICAgIHJvb3QuUlJvdXRlciA9IGZhY3Rvcnkocm9vdC5SZWFjdCwgcm9vdC5Qcm9taXNlKTsKICB9Cn0pKHdpbmRvdywgZnVuY3Rpb24oUmVhY3QsIFByb21pc2UpIHsKICByZXR1cm4gX19icm93c2VyaWZ5X18oJy4vbGliLycpOwp9KTsKCn0seyIuL2xpYi8iOjE0fV0sNDpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQGpzeCBSZWFjdC5ET00KICovCid1c2Ugc3RyaWN0JzsKCnZhciBSZWFjdCAgICAgPSAod2luZG93LlJlYWN0KTsKdmFyIExpbmtNaXhpbiA9IF9fYnJvd3NlcmlmeV9fKCcuL0xpbmtNaXhpbicpOwoKdmFyIExpbmsgPSBSZWFjdC5jcmVhdGVDbGFzcyh7ZGlzcGxheU5hbWU6ICdMaW5rJywKICBtaXhpbnM6IFtMaW5rTWl4aW5dLAoKICBvbkNsaWNrOiBmdW5jdGlvbihlKSB7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB0aGlzLmFjdGl2YXRlKCk7CiAgfSwKCiAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnRyYW5zZmVyUHJvcHNUbygKICAgICAgUmVhY3QuRE9NLmEoIHtocmVmOnRoaXMuaHJlZigpLCBvbkNsaWNrOnRoaXMub25DbGlja30sIAogICAgICAgIHRoaXMucHJvcHMuY2hpbGRyZW4KICAgICAgKQogICAgKTsKICB9Cn0pOwoKbW9kdWxlLmV4cG9ydHMgPSBMaW5rOwoKfSx7Ii4vTGlua01peGluIjo1fV0sNTpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQGpzeCBSZWFjdC5ET00KICovCid1c2Ugc3RyaWN0JzsKCnZhciBSZWFjdCAgICAgICAgICAgICAgID0gKHdpbmRvdy5SZWFjdCk7CnZhciBpbnZhcmlhbnQgICAgICAgICAgID0gX19icm93c2VyaWZ5X18oJy4vaW52YXJpYW50Jyk7CnZhciBSb3V0aW5nQ29udGV4dE1peGluID0gX19icm93c2VyaWZ5X18oJy4vUm91dGluZ0NvbnRleHRNaXhpbicpOwoKdmFyIExpbmtNaXhpbiA9IHsKICBtaXhpbnM6IFtSb3V0aW5nQ29udGV4dE1peGluXSwKCiAgcHJvcFR5cGVzOiB7CiAgICB0bzogUmVhY3QuUHJvcFR5cGVzLnN0cmluZywKICAgIGhyZWY6IFJlYWN0LlByb3BUeXBlcy5zdHJpbmcsCiAgICBxdWVyeTogUmVhY3QuUHJvcFR5cGVzLm9iamVjdAogIH0sCgogIGFjdGl2YXRlOiBmdW5jdGlvbigpIHsKICAgIHZhciByb3V0aW5nID0gdGhpcy5nZXRSb3V0aW5nKCk7CiAgICBpZiAodGhpcy5wcm9wcy5ocmVmKSB7CiAgICAgIHJvdXRpbmcubmF2aWdhdGUodGhpcy5wcm9wcy5ocmVmLCB0aGlzLnByb3BzLm5hdmlnYXRpb24pOwogICAgfSBlbHNlIGlmICh0aGlzLnByb3BzLnRvKSB7CiAgICAgIHJvdXRpbmcubmF2aWdhdGVUbyh0aGlzLnByb3BzLnRvLCB0aGlzLnByb3BzLCB0aGlzLnByb3BzLm5hdmlnYXRpb24pOwogICAgfSBlbHNlIHsKICAgICAgaW52YXJpYW50KAogICAgICAgIGZhbHNlLAogICAgICAgICdwcm92aWRlIGVpdGhlciAidG8iIG9yICJocmVmIiBwcm9wIHRvIExpbmsgY29tcG9uZW50JwogICAgICApOwogICAgfQogIH0sCgogIGhyZWY6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMucHJvcHMuaHJlZikgewogICAgICByZXR1cm4gdGhpcy5wcm9wcy5ocmVmOwogICAgfSBlbHNlIGlmICh0aGlzLnByb3BzLnRvKSB7CiAgICAgIHJldHVybiB0aGlzLmdldFJvdXRpbmcoKS5tYWtlSHJlZih0aGlzLnByb3BzLnRvLCB0aGlzLnByb3BzKTsKICAgIH0gZWxzZSB7CiAgICAgIGludmFyaWFudCgKICAgICAgICBmYWxzZSwKICAgICAgICAncHJvdmlkZSBlaXRoZXIgInRvIiBvciAiaHJlZiIgcHJvcCB0byBMaW5rIGNvbXBvbmVudCcKICAgICAgKTsKICAgIH0KICB9Cn07Cgptb2R1bGUuZXhwb3J0cyA9IExpbmtNaXhpbjsKCn0seyIuL1JvdXRpbmdDb250ZXh0TWl4aW4iOjYsIi4vaW52YXJpYW50IjoxNX1dLDY6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEBqc3ggUmVhY3QuRE9NCiAqLwondXNlIHN0cmljdCc7Cgp2YXIgUmVhY3QgICAgID0gKHdpbmRvdy5SZWFjdCk7CnZhciBpbnZhcmlhbnQgPSBfX2Jyb3dzZXJpZnlfXygnLi9pbnZhcmlhbnQnKTsKCnZhciBjb250ZXh0VHlwZXMgPSB7CiAgcm91dGluZzogUmVhY3QuUHJvcFR5cGVzLm9iamVjdCwKICByb3V0ZXM6IFJlYWN0LlByb3BUeXBlcy5vYmplY3QsCiAgbWF0Y2g6IFJlYWN0LlByb3BUeXBlcy5vYmplY3QKfTsKCnZhciBSb3V0aW5nQ29udGV4dE1peGluID0gewogIGNvbnRleHRUeXBlczogY29udGV4dFR5cGVzLAoKICBuYXZpZ2F0ZTogZnVuY3Rpb24ocGF0aCwgbmF2aWdhdGlvbikgewogICAgaW52YXJpYW50KAogICAgICB0aGlzLmNvbnRleHQucm91dGluZywKICAgICAgJ25vIHJvdXRpbmcgZm91bmQgaW4gY29udGV4dCcKICAgICk7CiAgICB0aGlzLmNvbnRleHQucm91dGluZy5uYXZpZ2F0ZShwYXRoLCBuYXZpZ2F0aW9uKTsKICB9LAoKICBuYXZpZ2F0ZVRvOiBmdW5jdGlvbihyb3V0ZVJlZiwgcHJvcHMsIG5hdmlnYXRpb24pIHsKICAgIGludmFyaWFudCgKICAgICAgdGhpcy5jb250ZXh0LnJvdXRpbmcsCiAgICAgICdubyByb3V0aW5nIGZvdW5kIGluIGNvbnRleHQnCiAgICApOwogICAgdGhpcy5jb250ZXh0LnJvdXRpbmcubmF2aWdhdGVUbyhyb3V0ZVJlZiwgcHJvcHMsIG5hdmlnYXRpb24pOwogIH0sCgogIGdldE1hdGNoOiBmdW5jdGlvbigpIHsKICAgIGludmFyaWFudCgKICAgICAgdGhpcy5jb250ZXh0Lm1hdGNoLAogICAgICAnbm8gbWF0Y2ggZm91bmQgaW4gY29udGV4dCcKICAgICk7CiAgICByZXR1cm4gdGhpcy5jb250ZXh0Lm1hdGNoOwogIH0sCgogIGdldFJvdXRlczogZnVuY3Rpb24oKSB7CiAgICBpbnZhcmlhbnQoCiAgICAgIHRoaXMuY29udGV4dC5yb3V0ZXMsCiAgICAgICdubyByb3V0ZXMgZm91bmQgaW4gY29udGV4dCcKICAgICk7CiAgICByZXR1cm4gdGhpcy5jb250ZXh0LnJvdXRlczsKICB9LAoKICBnZXRSb3V0aW5nOiBmdW5jdGlvbigpIHsKICAgIGludmFyaWFudCgKICAgICAgdGhpcy5jb250ZXh0LnJvdXRpbmcsCiAgICAgICdubyByb3V0aW5nIGZvdW5kIGluIGNvbnRleHQnCiAgICApOwogICAgcmV0dXJuIHRoaXMuY29udGV4dC5yb3V0aW5nOwogIH0KfTsKCm1vZHVsZS5leHBvcnRzID0gUm91dGluZ0NvbnRleHRNaXhpbjsKCn0seyIuL2ludmFyaWFudCI6MTV9XSw3OltmdW5jdGlvbihfX2Jyb3dzZXJpZnlfXyxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBDb3B5cmlnaHQgMjAxMy0yMDE0IEZhY2Vib29rLCBJbmMuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwogKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQogKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAogKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICoKICogQHByb3ZpZGVzTW9kdWxlIGNvcHlQcm9wZXJ0aWVzCiAqLwondXNlIHN0cmljdCc7CgovKioKICogQ29weSBwcm9wZXJ0aWVzIGZyb20gb25lIG9yIG1vcmUgb2JqZWN0cyAodXAgdG8gNSkgaW50byB0aGUgZmlyc3Qgb2JqZWN0LgogKiBUaGlzIGlzIGEgc2hhbGxvdyBjb3B5LiBJdCBtdXRhdGVzIHRoZSBmaXJzdCBvYmplY3QgYW5kIGFsc28gcmV0dXJucyBpdC4KICoKICogTk9URTogYGFyZ3VtZW50c2AgaGFzIGEgdmVyeSBzaWduaWZpY2FudCBwZXJmb3JtYW5jZSBwZW5hbHR5LCB3aGljaCBpcyB3aHkKICogd2UgZG9uJ3Qgc3VwcG9ydCB1bmxpbWl0ZWQgYXJndW1lbnRzLgogKi8KZnVuY3Rpb24gY29weVByb3BlcnRpZXMob2JqLCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgb2JqID0gb2JqIHx8IHt9OwoKICBpZiAoImRldmVsb3BtZW50IiAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBpZiAoZikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RvbyBtYW55IGFyZ3VtZW50cyBwYXNzZWQgdG8gY29weVByb3BlcnRpZXMnKTsKICAgIH0KICB9CgogIHZhciBhcmdzID0gW2EsIGIsIGMsIGQsIGVdOwogIHZhciBpaSA9IDAsIHY7CiAgd2hpbGUgKGFyZ3NbaWldKSB7CiAgICB2ID0gYXJnc1tpaSsrXTsKICAgIGZvciAodmFyIGsgaW4gdikgewogICAgICBvYmpba10gPSB2W2tdOwogICAgfQoKICAgIC8vIElFIGlnbm9yZXMgdG9TdHJpbmcgaW4gb2JqZWN0IGl0ZXJhdGlvbi4uIFNlZToKICAgIC8vIHdlYnJlZmxlY3Rpb24uYmxvZ3Nwb3QuY29tLzIwMDcvMDcvcXVpY2stZml4LWludGVybmV0LWV4cGxvcmVyLWFuZC5odG1sCiAgICBpZiAodi5oYXNPd25Qcm9wZXJ0eSAmJiB2Lmhhc093blByb3BlcnR5KCd0b1N0cmluZycpICYmCiAgICAgICAgKHR5cGVvZiB2LnRvU3RyaW5nICE9PSAndW5kZWZpbmVkJykgJiYgKG9iai50b1N0cmluZyAhPT0gdi50b1N0cmluZykpIHsKICAgICAgb2JqLnRvU3RyaW5nID0gdi50b1N0cmluZzsKICAgIH0KICB9CgogIHJldHVybiBvYmo7Cn0KCm1vZHVsZS5leHBvcnRzID0gY29weVByb3BlcnRpZXM7Cgp9LHt9XSw4OltmdW5jdGlvbihfX2Jyb3dzZXJpZnlfXyxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBAanN4IFJlYWN0LkRPTQogKi8KJ3VzZSBzdHJpY3QnOwoKdmFyIGludmFyaWFudCAgICA9IF9fYnJvd3NlcmlmeV9fKCcuL2ludmFyaWFudCcpOwp2YXIgbWVyZ2UgICAgICAgID0gX19icm93c2VyaWZ5X18oJy4vbWVyZ2UnKTsKdmFyIGdldFN0ZXBQcm9wcyA9IF9fYnJvd3NlcmlmeV9fKCcuL2dldFN0ZXBQcm9wcycpOwoKdmFyIGlzVmlld1Byb3BSZSA9IC8oW2EtekEtWjAtOV0rKVZpZXckLzsKCmZ1bmN0aW9uIGdldFZpZXdQcm9wcyhhbGxQcm9wcykgewogIHZhciB2aWV3cyA9IHt9OwogIHZhciBwcm9wcyA9IHt9OwoKICBmb3IgKHZhciBuYW1lIGluIGFsbFByb3BzKSB7CiAgICB2YXIgbSA9IGlzVmlld1Byb3BSZS5leGVjKG5hbWUpOwogICAgaWYgKG0pIHsKICAgICAgdmFyIHByb3AgPSBtWzFdOwoKICAgICAgaW52YXJpYW50KAogICAgICAgICFhbGxQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wKSwKICAgICAgICAndmlldyBwcm9wZXJ0eSAiJyArIG5hbWUgKyAnIiB3b3VsZCBvdmVyd3JpdGUgcmVndWxhciBwcm9wZXJ0eSAiJyArIHByb3AgKyAnIicKICAgICAgKTsKCiAgICAgIHZpZXdzW3Byb3BdID0gYWxsUHJvcHNbbmFtZV07CiAgICB9IGVsc2UgewogICAgICBwcm9wc1tuYW1lXSA9IGFsbFByb3BzW25hbWVdOwogICAgfQogIH0KCiAgcmV0dXJuIHt2aWV3czp2aWV3cywgcHJvcHM6cHJvcHN9Owp9CgpmdW5jdGlvbiBtYWtlVmlld0ZhY3Rvcnkodmlld0NsYXNzLCB2aWV3UHJvcHMpIHsKICByZXR1cm4gZnVuY3Rpb24gdmlld0ZhY3RvcnkocHJvcHMpIHsKICAgIHByb3BzID0gcHJvcHMgIT09IG51bGwgJiYgcHJvcHMgIT09IHVuZGVmaW5lZCA/CiAgICAgIG1lcmdlKHZpZXdQcm9wcywgcHJvcHMpIDoKICAgICAgdmlld1Byb3BzOwogICAgcmV0dXJuIHZpZXdDbGFzcyhwcm9wcyk7CiAgfTsKfQoKZnVuY3Rpb24gY29sbGVjdFN1YlZpZXdzKHByb3BzLCBzdWJWaWV3cykgewogIHZhciByID0gZ2V0Vmlld1Byb3BzKHByb3BzKTsKICB2YXIgdmlld3MgPSB7fTsKCiAgZm9yICh2YXIgbmFtZSBpbiByLnZpZXdzKSB7CiAgICB2aWV3c1tuYW1lXSA9IG1ha2VWaWV3RmFjdG9yeShyLnZpZXdzW25hbWVdLCBtZXJnZShyLnByb3BzLCBzdWJWaWV3cykpOwogIH0KCiAgcmV0dXJuIHZpZXdzOwp9CgovKioKICogQ3JlYXRlIGEgdmlldyBmb3Igd2hpY2ggbWF0Y2hlcyBmb3IgYSBwYXRoIHdpdGggdGhlIHByb3ZpZGVkIHJvdXRlcwogKgogKiBAcGFyYW0ge1JvdXRlfSByb3V0ZXMKICogQHJldHVybnMge1Byb21pc2U8UmVhY3RDb21wb25lbnQ+fQogKi8KZnVuY3Rpb24gY3JlYXRlVmlldyhtYXRjaCkgewogIHZhciB2aWV3cyA9IHt9OwoKICBmb3IgKHZhciBpID0gbWF0Y2guYWN0aXZlVHJhY2UubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgIHZhciBzdGVwID0gbWF0Y2guYWN0aXZlVHJhY2VbaV07CiAgICB2YXIgc3RlcFByb3BzID0gZ2V0U3RlcFByb3BzKHN0ZXApOwoKICAgIHZpZXdzID0gbWVyZ2Uodmlld3MsIGNvbGxlY3RTdWJWaWV3cyhzdGVwUHJvcHMsIHZpZXdzKSk7CgogICAgaWYgKHN0ZXAucm91dGUudmlldyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiBzdGVwLnJvdXRlLnZpZXcobWVyZ2Uoc3RlcFByb3BzLCB2aWV3cykpOwogICAgfQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBjcmVhdGVWaWV3Owptb2R1bGUuZXhwb3J0cy5nZXRWaWV3UHJvcHMgPSBnZXRWaWV3UHJvcHM7Cgp9LHsiLi9nZXRTdGVwUHJvcHMiOjEzLCIuL2ludmFyaWFudCI6MTUsIi4vbWVyZ2UiOjIwfV0sOTpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQGpzeCBSZWFjdC5ET00KICovCid1c2Ugc3RyaWN0JzsKCnZhciBQcm9taXNlICAgICAgID0gKHdpbmRvdy5Qcm9taXNlKTsKdmFyIG1lcmdlICAgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygnLi9tZXJnZScpOwp2YXIgZW1wdHlGdW5jdGlvbiA9IF9fYnJvd3NlcmlmeV9fKCcuL2VtcHR5RnVuY3Rpb24nKTsKdmFyIGdldFN0ZXBQcm9wcyAgPSBfX2Jyb3dzZXJpZnlfXygnLi9nZXRTdGVwUHJvcHMnKTsKCi8qKgogKiBNYWtlIHRhc2sKICoKICogQHBhcmFtIHtTdHJpbmd9IG5hbWUKICogQHBhcmFtIHtGdW5jdGlvbn0gZmV0Y2gKICogQHJldHVybnMge0Z1bmN0aW9ufQogKi8KZnVuY3Rpb24gbWFrZVRhc2soZmV0Y2gsIGRlZmVycmVkKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIHN0YXJ0KHByb3BzLCBwcm9taXNlcykgewogICAgdmFyIHByb21pc2UgPSBmZXRjaChwcm9wcywgcHJvbWlzZXMpOwoKICAgIGlmIChwcm9taXNlLmlzRnVsZmlsbGVkKCkpIHsKICAgICAgZGVmZXJyZWQucmVzb2x2ZShwcm9taXNlLnZhbHVlKCkpOwogICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oCiAgICAgICAgZnVuY3Rpb24ocmVzdWx0KSAgewogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHQpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAogICAgICAgIGZ1bmN0aW9uKGVycikgIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpOwogICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgIH0KICAgICAgKTsKICAgIH0KICB9Owp9Cgp2YXIgaXNQcm9taXNlUHJvcFJlID0gLyhbYS16QS1aMC05XSspUHJvbWlzZSQvOwoKLyoqCiAqIEZldGNoIGFsbCBwcm9taXNlcyBkZWZpbmVkIGluIHByb3BzCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wcwogKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3Q+fQogKi8KZnVuY3Rpb24gZmV0Y2hQcm9wcyhwcm9wcykgewogIHZhciBuZXdQcm9wcyA9IHt9OwoKICB2YXIgZGVmZXJyZWRzID0ge307CiAgdmFyIHByb21pc2VzID0ge307CiAgdmFyIHRhc2tzID0ge307CgogIHZhciBuYW1lOwoKICBmb3IgKG5hbWUgaW4gcHJvcHMpIHsKICAgIHZhciBtID0gaXNQcm9taXNlUHJvcFJlLmV4ZWMobmFtZSk7CiAgICBpZiAobSkgewogICAgICB2YXIgcHJvbWlzZU5hbWUgPSBtWzFdOwogICAgICB2YXIgZGVmZXJyZWQgPSBQcm9taXNlLmRlZmVyKCk7CiAgICAgIHRhc2tzW3Byb21pc2VOYW1lXSA9IG1ha2VUYXNrKHByb3BzW25hbWVdLCBkZWZlcnJlZCk7CiAgICAgIGRlZmVycmVkc1twcm9taXNlTmFtZV0gPSBkZWZlcnJlZC5wcm9taXNlOwogICAgfSBlbHNlIHsKICAgICAgbmV3UHJvcHNbbmFtZV0gPSBwcm9wc1tuYW1lXTsKICAgIH0KICB9CgogIC8vIG5vdCAqUHJvbWlzZSBwcm9wcywgc2hvcnRjaXJjdWl0IQogIGlmIChPYmplY3Qua2V5cyhkZWZlcnJlZHMpLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShwcm9wcyk7CiAgfQoKICB2YXIgaXNGdWxmaWxsZWQgPSB0cnVlOwoKICBmb3IgKG5hbWUgaW4gdGFza3MpIHsKICAgIHZhciBwcm9taXNlID0gdGFza3NbbmFtZV0obmV3UHJvcHMsIGRlZmVycmVkcyk7CiAgICBpc0Z1bGZpbGxlZCA9IGlzRnVsZmlsbGVkICYmIHByb21pc2UuaXNGdWxmaWxsZWQoKTsKICAgIHByb21pc2VzW25hbWVdID0gcHJvbWlzZS5pc0Z1bGZpbGxlZCgpID8gcHJvbWlzZS52YWx1ZSgpIDogcHJvbWlzZTsKICB9CgogIC8vIGV2ZXJ5IHByb21pc2UgaXMgcmVzb2x2ZWQgKHByb2JhYmx5IGZyb20gc29tZSBEQiBjYWNoZT8pLCBzaG9ydGNpcmN1aXQhCiAgaWYgKGlzRnVsZmlsbGVkKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG1lcmdlKG5ld1Byb3BzLCBwcm9taXNlcykpOwogIH0KCiAgcmV0dXJuIFByb21pc2UucHJvcHMocHJvbWlzZXMpCiAgICAudGhlbihmdW5jdGlvbihwcm9wcykgIHtyZXR1cm4gbWVyZ2UobmV3UHJvcHMsIHByb3BzKTt9KQogICAgLmZpbmFsbHkoZnVuY3Rpb24oKSAgewogICAgICBmb3IgKHZhciBuYW1lIGluIGRlZmVycmVkcykgewogICAgICAgIGRlZmVycmVkc1tuYW1lXS5jYXRjaChlbXB0eUZ1bmN0aW9uKTsKICAgICAgfQogICAgfSk7Cn0KCmZ1bmN0aW9uIGZldGNoU3RlcChzdGVwKSB7CiAgdmFyIHByb3BzID0gZmV0Y2hQcm9wcyhnZXRTdGVwUHJvcHMoc3RlcCkpOwogIC8vIHN0ZXAgaXMgcmVzb2x2ZWQsIHNob3J0Y2lyY3VpdCEKICBpZiAocHJvcHMuaXNGdWxmaWxsZWQoKSkgewogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgKICAgICAgbWVyZ2Uoc3RlcCwge3Byb3BzOiBtZXJnZShzdGVwLnByb3BzLCBwcm9wcy52YWx1ZSgpKX0pKTsKICB9IGVsc2UgewogICAgcmV0dXJuIFByb21pc2UucHJvcHMocHJvcHMpLnRoZW4oZnVuY3Rpb24ocHJvcHMpIAogICAgICB7cmV0dXJuIG1lcmdlKHN0ZXAsIHtwcm9wczogbWVyZ2Uoc3RlcC5wcm9wcywgcHJvcHMpfSk7fSk7CiAgfQp9CgpmdW5jdGlvbiBmZXRjaFByb2dyZXNzaXZlbHkobWF0Y2gsIG9uUHJvZ3Jlc3MsIG9uRXJyb3IpIHsKICB2YXIgYWN0aXZlVHJhY2UgPSBtYXRjaC5hY3RpdmVUcmFjZTsKICB2YXIgbGF0Y2ggPSBhY3RpdmVUcmFjZS5sZW5ndGg7CgogIGFjdGl2ZVRyYWNlLmZvckVhY2goZnVuY3Rpb24oc3RlcCwgaWR4KSAgewogICAgdmFyIHByb21pc2UgPSBmZXRjaFN0ZXAoc3RlcCk7CgogICAgaWYgKHByb21pc2UuaXNGdWxmaWxsZWQoKSkgewogICAgICBsYXRjaCA9IGxhdGNoIC0gMTsKICAgICAgYWN0aXZlVHJhY2UgPSBhY3RpdmVUcmFjZS5zbGljZSgwKTsKICAgICAgYWN0aXZlVHJhY2VbaWR4XSA9IHByb21pc2UudmFsdWUoKTsKICAgIH0gZWxzZSB7CiAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbihzdGVwKSAgewogICAgICAgIGFjdGl2ZVRyYWNlID0gYWN0aXZlVHJhY2Uuc2xpY2UoMCk7CiAgICAgICAgYWN0aXZlVHJhY2VbaWR4XSA9IHN0ZXA7CiAgICAgICAgb25Qcm9ncmVzcyhtZXJnZShtYXRjaCwge2FjdGl2ZVRyYWNlOmFjdGl2ZVRyYWNlfSkpOwogICAgICB9KS5jYXRjaChvbkVycm9yKTsKICAgIH0KICB9KTsKCiAgcmV0dXJuIG1lcmdlKG1hdGNoLCB7YWN0aXZlVHJhY2U6YWN0aXZlVHJhY2V9KTsKfQoKZnVuY3Rpb24gZmV0Y2gobWF0Y2gpIHsKICByZXR1cm4gUHJvbWlzZS5hbGwobWF0Y2guYWN0aXZlVHJhY2UubWFwKGZldGNoU3RlcCkpCiAgICAudGhlbihmdW5jdGlvbihhY3RpdmVUcmFjZSkgIHtyZXR1cm4gbWVyZ2UobWF0Y2gsIHthY3RpdmVUcmFjZTphY3RpdmVUcmFjZX0pO30pOwp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBmZXRjaDpmZXRjaCwKICBmZXRjaFByb2dyZXNzaXZlbHk6ZmV0Y2hQcm9ncmVzc2l2ZWx5LAogIGZldGNoUHJvcHM6ZmV0Y2hQcm9wcwp9OwoKfSx7Ii4vZW1wdHlGdW5jdGlvbiI6MTEsIi4vZ2V0U3RlcFByb3BzIjoxMywiLi9tZXJnZSI6MjB9XSwxMDpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQGpzeCBSZWFjdC5ET00KICovCid1c2Ugc3RyaWN0JzsKCnZhciBtZXJnZSA9IF9fYnJvd3NlcmlmeV9fKCcuL21lcmdlJyk7Cgp2YXIgc2xhc2hlcyA9IC8oXlwvKXwoXC8kKS9nOwoKLyoqCiAqIFJvdXRlIGRlc3JpcHRvciBjb25zdHJ1Y3RvcgogKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuLi59IGNoaWxkcmVuCiAqIEByZXR1cm5zIHtSb3V0ZX0KICovCmZ1bmN0aW9uIFJvdXRlKHByb3BzKSB7CiAgcHJvcHMgPSBwcm9wcyB8fCB7fTsKCiAgdmFyIHBhdGggPSBwcm9wcy5wYXRoID8KICAgIHByb3BzLnBhdGgucmVwbGFjZShzbGFzaGVzLCAnJykgOgogICAgdW5kZWZpbmVkOwoKICBkZWxldGUgcHJvcHMucGF0aDsKCiAgdmFyIHZpZXcgPSBwcm9wcy52aWV3OwogIGRlbGV0ZSBwcm9wcy52aWV3OwoKICB2YXIgdmlld1Byb21pc2UgPSBwcm9wcy52aWV3UHJvbWlzZTsKICBkZWxldGUgcHJvcHMudmlld1Byb21pc2U7CgogIHZhciBuYW1lID0gcHJvcHMubmFtZTsKICBkZWxldGUgcHJvcHMubmFtZTsKCiAgdmFyIF9fc2NvcGUgPSBwcm9wcy5fX3Njb3BlOwogIGRlbGV0ZSBwcm9wcy5fX3Njb3BlOwoKICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgogIHZhciBjaGlsZHJlbiA9IFtdOwoKICAvLyBzbyB3ZSBzdXBwb3J0IHBhc3Npbmcgcm91dGVzIGFzIGFyZ3VtZW50cyBhbmQgYXJyYXlzCiAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGFyZ3MubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGFyZ3NbaV0pKSB7CiAgICAgIGNoaWxkcmVuID0gY2hpbGRyZW4uY29uY2F0KGFyZ3NbaV0pOwogICAgfSBlbHNlIHsKICAgICAgY2hpbGRyZW4ucHVzaChhcmdzW2ldKTsKICAgIH0KICB9CgogIHZhciByb3V0ZSA9IHtwYXRoOnBhdGgsIG5hbWU6bmFtZSwgdmlldzp2aWV3LCB2aWV3UHJvbWlzZTp2aWV3UHJvbWlzZSwgcHJvcHM6cHJvcHMsIGNoaWxkcmVuOmNoaWxkcmVuLCBfX3Njb3BlOl9fc2NvcGV9OwogIGJ1aWxkTmFtZUluZGV4KHJvdXRlKTsKICByZXR1cm4gcm91dGU7Cn0KCmZ1bmN0aW9uIFJvdXRlcyhwcm9wcykgewogIHByb3BzID0gbWVyZ2UocHJvcHMsIHtfX3Njb3BlOiB0cnVlfSk7CiAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogIGFyZ3MudW5zaGlmdChwcm9wcyk7CiAgcmV0dXJuIFJvdXRlLmFwcGx5KG51bGwsIGFyZ3MpOwp9CgpmdW5jdGlvbiBidWlsZE5hbWVJbmRleChyb3V0ZSkgewogIGlmIChyb3V0ZS5fX25hbWVJbmRleCAhPT0gdW5kZWZpbmVkKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgaW5kZXggPSB7fTsKICB2YXIgcHJlZml4ID0gcm91dGUubmFtZSA/IHJvdXRlLm5hbWUgKyAnLycgOiAnJzsKCiAgaWYgKHJvdXRlLmNoaWxkcmVuICYmIHJvdXRlLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSByb3V0ZS5jaGlsZHJlbi5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICB2YXIgciA9IHJvdXRlLmNoaWxkcmVuW2ldOwogICAgICBidWlsZE5hbWVJbmRleChyKTsKICAgICAgZm9yICh2YXIgbmFtZSBpbiByLl9fbmFtZUluZGV4KSB7CiAgICAgICAgaW5kZXhbcHJlZml4ICsgbmFtZV0gPSBbcm91dGVdLmNvbmNhdChyLl9fbmFtZUluZGV4W25hbWVdKTsKICAgICAgfQogICAgfQogIH0KICAKICBpZiAocm91dGUubmFtZSAhPT0gdW5kZWZpbmVkKSB7CiAgICBpbmRleFtyb3V0ZS5uYW1lXSA9IFtyb3V0ZV07CiAgfQoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkocm91dGUsICdfX25hbWVJbmRleCcsIHsKICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgdmFsdWU6IGluZGV4CiAgfSk7Cn0KCmZ1bmN0aW9uIGdldFRyYWNlQnlOYW1lKHJvdXRlLCBuYW1lKSB7CiAgcmV0dXJuIHJvdXRlLl9fbmFtZUluZGV4W25hbWVdOwp9CgpmdW5jdGlvbiBoYXNWaWV3KHJvdXRlKSB7CiAgcmV0dXJuIHJvdXRlLnZpZXcgIT09IHVuZGVmaW5lZCB8fCByb3V0ZS52aWV3UHJvbWlzZSAhPT0gdW5kZWZpbmVkOwp9CgpmdW5jdGlvbiBpc1JvdXRlcyhyb3V0ZXMpIHsKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHJvdXRlcyk7CiAgcmV0dXJuICgKICAgIGtleXMuaW5kZXhPZigncGF0aCcpID4gLTEKICAgICYmIGtleXMuaW5kZXhPZigndmlldycpID4gLTEKICAgICYmIGtleXMuaW5kZXhPZigncHJvcHMnKSA+IC0xCiAgICAmJiBrZXlzLmluZGV4T2YoJ2NoaWxkcmVuJykgPiAtMQogICk7Cn0KCm1vZHVsZS5leHBvcnRzID0gewogIFJvdXRlOlJvdXRlLAogIFJvdXRlczpSb3V0ZXMsCiAgaXNSb3V0ZXM6aXNSb3V0ZXMsCiAgZ2V0VHJhY2VCeU5hbWU6Z2V0VHJhY2VCeU5hbWUsCiAgaGFzVmlldzpoYXNWaWV3Cn07Cgp9LHsiLi9tZXJnZSI6MjB9XSwxMTpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQ29weXJpZ2h0IDIwMTMtMjAxNCBGYWNlYm9vaywgSW5jLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIEBwcm92aWRlc01vZHVsZSBlbXB0eUZ1bmN0aW9uCiAqLwondXNlIHN0cmljdCc7Cgp2YXIgY29weVByb3BlcnRpZXMgPSBfX2Jyb3dzZXJpZnlfXygnLi9jb3B5UHJvcGVydGllcycpOwoKZnVuY3Rpb24gbWFrZUVtcHR5RnVuY3Rpb24oYXJnKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFyZzsKICB9Owp9CgovKioKICogVGhpcyBmdW5jdGlvbiBhY2NlcHRzIGFuZCBkaXNjYXJkcyBpbnB1dHM7IGl0IGhhcyBubyBzaWRlIGVmZmVjdHMuIFRoaXMgaXMKICogcHJpbWFyaWx5IHVzZWZ1bCBpZGlvbWF0aWNhbGx5IGZvciBvdmVycmlkYWJsZSBmdW5jdGlvbiBlbmRwb2ludHMgd2hpY2gKICogYWx3YXlzIG5lZWQgdG8gYmUgY2FsbGFibGUsIHNpbmNlIEpTIGxhY2tzIGEgbnVsbC1jYWxsIGlkaW9tIGFsYSBDb2NvYS4KICovCmZ1bmN0aW9uIGVtcHR5RnVuY3Rpb24oKSB7fQoKY29weVByb3BlcnRpZXMoZW1wdHlGdW5jdGlvbiwgewogIHRoYXRSZXR1cm5zOiBtYWtlRW1wdHlGdW5jdGlvbiwKICB0aGF0UmV0dXJuc0ZhbHNlOiBtYWtlRW1wdHlGdW5jdGlvbihmYWxzZSksCiAgdGhhdFJldHVybnNUcnVlOiBtYWtlRW1wdHlGdW5jdGlvbih0cnVlKSwKICB0aGF0UmV0dXJuc051bGw6IG1ha2VFbXB0eUZ1bmN0aW9uKG51bGwpLAogIHRoYXRSZXR1cm5zVGhpczogZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzOyB9LAogIHRoYXRSZXR1cm5zQXJndW1lbnQ6IGZ1bmN0aW9uKGFyZykgeyByZXR1cm4gYXJnOyB9Cn0pOwoKbW9kdWxlLmV4cG9ydHMgPSBlbXB0eUZ1bmN0aW9uOwoKfSx7Ii4vY29weVByb3BlcnRpZXMiOjd9XSwxMjpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQGpzeCBSZWFjdC5ET00KICovCid1c2Ugc3RyaWN0JzsKCnZhciBtZXJnZSAgID0gX19icm93c2VyaWZ5X18oJy4vbWVyZ2UnKTsKdmFyIFByb21pc2UgPSAod2luZG93LlByb21pc2UpOwoKZnVuY3Rpb24gZmV0Y2hWaWV3c1N0ZXAoc3RlcCkgewogIHZhciBwcm9wcyA9IG1lcmdlKHN0ZXAubWF0Y2gsIHN0ZXAucm91dGUucHJvcHMpOwogIHJldHVybiBzdGVwLnJvdXRlLnZpZXdQcm9taXNlID8KICAgIHN0ZXAucm91dGUudmlld1Byb21pc2UocHJvcHMpLnRoZW4oZnVuY3Rpb24odmlldykgIHtyZXR1cm4gbWVyZ2Uoc3RlcCwge3ZpZXc6dmlld30pO30pIDoKICAgIHN0ZXA7Cn0KCi8qKgogKiBGZXRjaCB2aWV3cyBmb3IgbWF0Y2gKICoKICogQHBhcmFtIHtNYXRjaH0gbWF0Y2gKICogQHJldHVybnMge01hdGNofQogKi8KZnVuY3Rpb24gZmV0Y2hWaWV3cyhtYXRjaCkgewogIHZhciBhY3RpdmVUcmFjZSA9IG1hdGNoLmFjdGl2ZVRyYWNlLm1hcChmZXRjaFZpZXdzU3RlcCk7CgogIHJldHVybiBhY3RpdmVUcmFjZS5zb21lKFByb21pc2UuaXMpID8KICAgIFByb21pc2UuYWxsKGFjdGl2ZVRyYWNlKS50aGVuKGZ1bmN0aW9uKGFjdGl2ZVRyYWNlKSAge3JldHVybiBtZXJnZShtYXRjaCwge2FjdGl2ZVRyYWNlOmFjdGl2ZVRyYWNlfSk7fSkgOgogICAgUHJvbWlzZS5yZXNvbHZlKG1lcmdlKG1hdGNoLCB7YWN0aXZlVHJhY2U6YWN0aXZlVHJhY2V9KSk7Cn0KCm1vZHVsZS5leHBvcnRzID0gZmV0Y2hWaWV3czsKCn0seyIuL21lcmdlIjoyMH1dLDEzOltmdW5jdGlvbihfX2Jyb3dzZXJpZnlfXyxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBAanN4IFJlYWN0LkRPTQogKi8KJ3VzZSBzdHJpY3QnOwoKdmFyIG1lcmdlSW50byA9IF9fYnJvd3NlcmlmeV9fKCcuL21lcmdlSW50bycpOwoKZnVuY3Rpb24gZ2V0U3RlcFByb3BzKHN0ZXApIHsKICB2YXIgcHJvcHMgPSB7fTsKICBtZXJnZUludG8ocHJvcHMsIHN0ZXAubWF0Y2gpOwogIG1lcmdlSW50byhwcm9wcywgc3RlcC5yb3V0ZS5wcm9wcyk7CiAgbWVyZ2VJbnRvKHByb3BzLCBzdGVwLnByb3BzKTsKICByZXR1cm4gcHJvcHM7Cn0KCm1vZHVsZS5leHBvcnRzID0gZ2V0U3RlcFByb3BzOwoKfSx7Ii4vbWVyZ2VJbnRvIjoyMn1dLDE0OltmdW5jdGlvbihfX2Jyb3dzZXJpZnlfXyxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBAanN4IFJlYWN0LkRPTQogKi8KJ3VzZSBzdHJpY3QnOwoKdmFyIG1hdGNoUm91dGVzICAgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygnLi9tYXRjaFJvdXRlcycpOwp2YXIgZGF0YSAgICAgICAgICAgICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuL2RhdGEnKTsKdmFyIHJvdXRlICAgICAgICAgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygnLi9yb3V0ZScpOwp2YXIgY3JlYXRlVmlldyAgICAgICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuL2NyZWF0ZVZpZXcnKTsKdmFyIGZldGNoVmlld3MgICAgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygnLi9mZXRjaFZpZXdzJyk7CnZhciBQYXRobmFtZVJvdXRpbmcgICAgID0gX19icm93c2VyaWZ5X18oJy4vcm91dGluZy9QYXRobmFtZVJvdXRpbmcnKTsKdmFyIEhhc2hSb3V0aW5nICAgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygnLi9yb3V0aW5nL0hhc2hSb3V0aW5nJyk7CnZhciBMaW5rICAgICAgICAgICAgICAgID0gX19icm93c2VyaWZ5X18oJy4vTGluaycpOwp2YXIgTGlua01peGluICAgICAgICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuL0xpbmtNaXhpbicpOwp2YXIgZGVzY3JpcHRvcnMgICAgICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuL2Rlc2NyaXB0b3JzJyk7CnZhciBSb3V0aW5nQ29udGV4dE1peGluID0gX19icm93c2VyaWZ5X18oJy4vUm91dGluZ0NvbnRleHRNaXhpbicpOwoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgaXNSb3V0ZXM6IGRlc2NyaXB0b3JzLmlzUm91dGVzLAogIFJvdXRlczogZGVzY3JpcHRvcnMuUm91dGVzLAogIFJvdXRlOiBkZXNjcmlwdG9ycy5Sb3V0ZSwKICBMaW5rOkxpbmssCiAgTGlua01peGluOkxpbmtNaXhpbiwKICBtYXRjaFJvdXRlczptYXRjaFJvdXRlcywKICBjcmVhdGVWaWV3OmNyZWF0ZVZpZXcsCiAgZGF0YTpkYXRhLAogIHN0YXJ0OiBQYXRobmFtZVJvdXRpbmcuc3RhcnQuYmluZChQYXRobmFtZVJvdXRpbmcpLAogIHJvdXRlOnJvdXRlLAogIFBhdGhuYW1lUm91dGluZzpQYXRobmFtZVJvdXRpbmcsCiAgSGFzaFJvdXRpbmc6SGFzaFJvdXRpbmcsCiAgUm91dGluZ0NvbnRleHRNaXhpbjpSb3V0aW5nQ29udGV4dE1peGluCn07Cgp9LHsiLi9MaW5rIjo0LCIuL0xpbmtNaXhpbiI6NSwiLi9Sb3V0aW5nQ29udGV4dE1peGluIjo2LCIuL2NyZWF0ZVZpZXciOjgsIi4vZGF0YSI6OSwiLi9kZXNjcmlwdG9ycyI6MTAsIi4vZmV0Y2hWaWV3cyI6MTIsIi4vbWF0Y2hSb3V0ZXMiOjE5LCIuL3JvdXRlIjoyMywiLi9yb3V0aW5nL0hhc2hSb3V0aW5nIjoyNCwiLi9yb3V0aW5nL1BhdGhuYW1lUm91dGluZyI6MjV9XSwxNTpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQ29weXJpZ2h0IDIwMTMtMjAxNCBGYWNlYm9vaywgSW5jLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIEBwcm92aWRlc01vZHVsZSBpbnZhcmlhbnQKICovCgoidXNlIHN0cmljdCI7CgovKioKICogVXNlIGludmFyaWFudCgpIHRvIGFzc2VydCBzdGF0ZSB3aGljaCB5b3VyIHByb2dyYW0gYXNzdW1lcyB0byBiZSB0cnVlLgogKgogKiBQcm92aWRlIHNwcmludGYtc3R5bGUgZm9ybWF0IChvbmx5ICVzIGlzIHN1cHBvcnRlZCkgYW5kIGFyZ3VtZW50cwogKiB0byBwcm92aWRlIGluZm9ybWF0aW9uIGFib3V0IHdoYXQgYnJva2UgYW5kIHdoYXQgeW91IHdlcmUKICogZXhwZWN0aW5nLgogKgogKiBUaGUgaW52YXJpYW50IG1lc3NhZ2Ugd2lsbCBiZSBzdHJpcHBlZCBpbiBwcm9kdWN0aW9uLCBidXQgdGhlIGludmFyaWFudAogKiB3aWxsIHJlbWFpbiB0byBlbnN1cmUgbG9naWMgZG9lcyBub3QgZGlmZmVyIGluIHByb2R1Y3Rpb24uCiAqLwoKdmFyIGludmFyaWFudCA9IGZ1bmN0aW9uKGNvbmRpdGlvbikgewogIGlmICghY29uZGl0aW9uKSB7CiAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoCiAgICAgICdNaW5pZmllZCBleGNlcHRpb24gb2NjdXJlZDsgdXNlIHRoZSBub24tbWluaWZpZWQgZGV2IGVudmlyb25tZW50IGZvciAnICsKICAgICAgJ3RoZSBmdWxsIGVycm9yIG1lc3NhZ2UgYW5kIGFkZGl0aW9uYWwgaGVscGZ1bCB3YXJuaW5ncy4nCiAgICApOwogICAgZXJyb3IuZnJhbWVzVG9Qb3AgPSAxOwogICAgdGhyb3cgZXJyb3I7CiAgfQp9OwoKaWYgKCJkZXZlbG9wbWVudCIgIT09ICdwcm9kdWN0aW9uJykgewogIGludmFyaWFudCA9IGZ1bmN0aW9uKGNvbmRpdGlvbiwgZm9ybWF0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICBpZiAoZm9ybWF0ID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhcmlhbnQgcmVxdWlyZXMgYW4gZXJyb3IgbWVzc2FnZSBhcmd1bWVudCcpOwogICAgfQoKICAgIGlmICghY29uZGl0aW9uKSB7CiAgICAgIHZhciBhcmdzID0gW2EsIGIsIGMsIGQsIGUsIGZdOwogICAgICB2YXIgYXJnSW5kZXggPSAwOwogICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoCiAgICAgICAgJ0ludmFyaWFudCBWaW9sYXRpb246ICcgKwogICAgICAgIGZvcm1hdC5yZXBsYWNlKC8lcy9nLCBmdW5jdGlvbigpIHsgcmV0dXJuIGFyZ3NbYXJnSW5kZXgrK107IH0pCiAgICAgICk7CiAgICAgIGVycm9yLmZyYW1lc1RvUG9wID0gMTsgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCBpbnZhcmlhbnQncyBvd24gZnJhbWUKICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBpbnZhcmlhbnQ7Cgp9LHt9XSwxNjpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQGpzeCBSZWFjdC5ET00KICovCid1c2Ugc3RyaWN0JzsKCmZ1bmN0aW9uIGlzU3RyaW5nKG8pIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG8pID09PSAnW29iamVjdCBTdHJpbmddJzsKfQoKbW9kdWxlLmV4cG9ydHMgPSBpc1N0cmluZzsKCn0se31dLDE3OltmdW5jdGlvbihfX2Jyb3dzZXJpZnlfXyxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBDb3B5cmlnaHQgMjAxMy0yMDE0IEZhY2Vib29rLCBJbmMuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwogKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQogKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAogKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICoKICogQHByb3ZpZGVzTW9kdWxlIGtleU1pcnJvcgogKiBAdHlwZWNoZWNrcyBzdGF0aWMtb25seQogKi8KCiJ1c2Ugc3RyaWN0IjsKCnZhciBpbnZhcmlhbnQgPSBfX2Jyb3dzZXJpZnlfXygnLi9pbnZhcmlhbnQnKTsKCi8qKgogKiBDb25zdHJ1Y3RzIGFuIGVudW1lcmF0aW9uIHdpdGgga2V5cyBlcXVhbCB0byB0aGVpciB2YWx1ZS4KICoKICogRm9yIGV4YW1wbGU6CiAqCiAqICAgdmFyIENPTE9SUyA9IGtleU1pcnJvcih7Ymx1ZTogbnVsbCwgcmVkOiBudWxsfSk7CiAqICAgdmFyIG15Q29sb3IgPSBDT0xPUlMuYmx1ZTsKICogICB2YXIgaXNDb2xvclZhbGlkID0gISFDT0xPUlNbbXlDb2xvcl07CiAqCiAqIFRoZSBsYXN0IGxpbmUgY291bGQgbm90IGJlIHBlcmZvcm1lZCBpZiB0aGUgdmFsdWVzIG9mIHRoZSBnZW5lcmF0ZWQgZW51bSB3ZXJlCiAqIG5vdCBlcXVhbCB0byB0aGVpciBrZXlzLgogKgogKiAgIElucHV0OiAge2tleTE6IHZhbDEsIGtleTI6IHZhbDJ9CiAqICAgT3V0cHV0OiB7a2V5MToga2V5MSwga2V5Mjoga2V5Mn0KICoKICogQHBhcmFtIHtvYmplY3R9IG9iagogKiBAcmV0dXJuIHtvYmplY3R9CiAqLwp2YXIga2V5TWlycm9yID0gZnVuY3Rpb24ob2JqKSB7CiAgdmFyIHJldCA9IHt9OwogIHZhciBrZXk7CiAgaW52YXJpYW50KAogICAgb2JqIGluc3RhbmNlb2YgT2JqZWN0ICYmICFBcnJheS5pc0FycmF5KG9iaiksCiAgICAna2V5TWlycm9yKC4uLik6IEFyZ3VtZW50IG11c3QgYmUgYW4gb2JqZWN0LicKICApOwogIGZvciAoa2V5IGluIG9iaikgewogICAgaWYgKCFvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICBjb250aW51ZTsKICAgIH0KICAgIHJldFtrZXldID0ga2V5OwogIH0KICByZXR1cm4gcmV0Owp9OwoKbW9kdWxlLmV4cG9ydHMgPSBrZXlNaXJyb3I7Cgp9LHsiLi9pbnZhcmlhbnQiOjE1fV0sMTg6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEBqc3ggUmVhY3QuRE9NCiAqLwondXNlIHN0cmljdCc7Cgp2YXIgaW52YXJpYW50ICAgICAgID0gX19icm93c2VyaWZ5X18oJy4vaW52YXJpYW50Jyk7CnZhciBnZXRUcmFjZUJ5TmFtZSAgPSBfX2Jyb3dzZXJpZnlfXygnLi9kZXNjcmlwdG9ycycpLmdldFRyYWNlQnlOYW1lOwoKZnVuY3Rpb24gbWFrZUhyZWYocm91dGVzLCBuYW1lLCBtYXRjaCwgcGFyYW1zKSB7CiAgcGFyYW1zID0gcGFyYW1zIHx8IHt9OwogIHZhciBwYXR0ZXJuID0gZ2V0UGF0dGVybihyb3V0ZXMsIG5hbWUsIG1hdGNoKTsKICAvLyBUT0RPOiBoYW5kbGUgb3B0aW9uYWwgYW5kIHNwbGF0IHBhcmFtcwogIHJldHVybiBwYXR0ZXJuLnJlcGxhY2UoCiAgICAvOlthLXpBLVowLTlfXSsvZywKICAgIGZ1bmN0aW9uKG5hbWUpICB7cmV0dXJuIHBhcmFtc1tuYW1lLnNsaWNlKDEpXTt9CiAgKTsKfQoKZnVuY3Rpb24gZ2V0UGF0dGVybihyb3V0ZXMsIG5hbWUsIG1hdGNoKSB7CiAgdmFyIHRyYWNlID0gZ2V0U2NvcGVkVHJhY2Uocm91dGVzLCBuYW1lLCBtYXRjaCk7CgogIGludmFyaWFudCgKICAgIHRyYWNlICE9PSB1bmRlZmluZWQgJiYgdHJhY2UubGVuZ3RoID4gMCwKICAgICdjYW5ub3QgcmVzb2x2ZSAiJXMiIHJvdXRlIHJlZmVyZW5jZScsIG5hbWUKICApOwoKICB2YXIgaHJlZiA9ICcnOwogIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0cmFjZS5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgdmFyIHJvdXRlID0gdHJhY2VbaV07CiAgICBpZiAocm91dGUucGF0aCAmJiByb3V0ZS5wYXRoLmxlbmd0aCA+IDApIHsKICAgICAgaHJlZiA9IGhyZWYgKyAnLycgKyByb3V0ZS5wYXRoOwogICAgfQogIH0KCiAgcmV0dXJuIGhyZWYgPT09ICcnID8gJy8nIDogaHJlZjsKfQoKZnVuY3Rpb24gZ2V0U2NvcGVkVHJhY2Uocm91dGVzLCBuYW1lLCBtYXRjaCkgewogIGlmIChuYW1lWzBdID09PSAnLycpIHsKICAgIHJldHVybiBnZXRUcmFjZUJ5TmFtZShyb3V0ZXMsIG5hbWUuc2xpY2UoMSkpOwogIH0gZWxzZSB7CiAgICB2YXIgdHJhY2UgPSBtYXRjaC50cmFjZS5tYXAoZnVuY3Rpb24oc3RlcCkgIHtyZXR1cm4gc3RlcC5yb3V0ZTt9KTsKICAgIHZhciBzY29wZSA9IHRyYWNlWzBdOwoKICAgIGZvciAodmFyIGkgPSB0cmFjZS5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBpZiAodHJhY2VbaV0uX19zY29wZSkgewogICAgICAgIHNjb3BlID0gdHJhY2VbaV07CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdHJhY2UKICAgICAgLnNsaWNlKDAsIGkpCiAgICAgIC5jb25jYXQoZ2V0VHJhY2VCeU5hbWUoc2NvcGUsIG5hbWUpKTsKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gbWFrZUhyZWY7Cm1vZHVsZS5leHBvcnRzLmdldFBhdHRlcm4gPSBnZXRQYXR0ZXJuOwoKfSx7Ii4vZGVzY3JpcHRvcnMiOjEwLCIuL2ludmFyaWFudCI6MTV9XSwxOTpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQGpzeCBSZWFjdC5ET00KICovCid1c2Ugc3RyaWN0JzsKCnZhciBwYXR0ZXJuICA9IF9fYnJvd3NlcmlmeV9fKCd1cmwtcGF0dGVybicpOwp2YXIgcXMgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygncXMnKTsKdmFyIGhhc1ZpZXcgID0gX19icm93c2VyaWZ5X18oJy4vZGVzY3JpcHRvcnMnKS5oYXNWaWV3Owp2YXIgaXNTdHJpbmcgPSBfX2Jyb3dzZXJpZnlfXygnLi9pc1N0cmluZycpOwoKLyoqCiAqIE5vcm1hbGl6ZSBwYXRoCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAqIEByZXR1cm5zIHtTdHJpbmd9CiAqLwpmdW5jdGlvbiBub3JtYWxpemUocGF0aCkgewogIGlmICghcGF0aCkgewogICAgcmV0dXJuICcvJzsKICB9CiAgaWYgKHBhdGhbMF0gIT09ICcvJykgewogICAgcGF0aCA9ICcvJyArIHBhdGg7CiAgfQogIGlmIChwYXRoW3BhdGgubGVuZ3RoIC0gMV0gIT09ICcvJykgewogICAgcGF0aCA9IHBhdGggKyAnLyc7CiAgfQogIHJldHVybiBwYXRoOwp9CgovKioKICogTWF0Y2ggcm91dGUgYWdhaW5zdCBwYXRoCiAqCiAqIEBwYXJhbSB7Um91dGV9IHJvdXRlCiAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAqIEByZXR1cm5zIHtNYXRjaHxOdWxsfQogKi8KZnVuY3Rpb24gbWF0Y2hSb3V0ZShyb3V0ZSwgcGF0aCkgewoKICBpZiAocm91dGUucGF0dGVybiA9PT0gdW5kZWZpbmVkICYmIHJvdXRlLnBhdGggIT09IHVuZGVmaW5lZCkgewogICAgdmFyIHJvdXRlUGF0aCA9IG5vcm1hbGl6ZShyb3V0ZS5wYXRoKTsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocm91dGUsICdwYXR0ZXJuJywgewogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgdmFsdWU6IHBhdHRlcm4ubmV3UGF0dGVybihyb3V0ZS5jaGlsZHJlbi5sZW5ndGggPiAwID8KICAgICAgICByb3V0ZVBhdGggKyAnKicgOgogICAgICAgIHJvdXRlUGF0aCkKICAgIH0pOwogIH0KCiAgaWYgKHJvdXRlLnBhdHRlcm4pIHsKICAgIHZhciBtYXRjaCA9IHJvdXRlLnBhdHRlcm4ubWF0Y2gocGF0aCk7CgogICAgaWYgKG1hdGNoCiAgICAgICAgJiYgKCFtYXRjaC5fIHx8IG1hdGNoLl9bMF0gPT09ICcvJyB8fCBtYXRjaC5fWzBdID09PSAnJykpIHsKICAgICAgZGVsZXRlIG1hdGNoLl87CiAgICB9CgogICAgcmV0dXJuIG1hdGNoOwoKICB9IGVsc2UgewogICAgcmV0dXJuIHBhdGggPT09ICcvJyB8fCBwYXRoID09PSAnJyA/IHt9IDoge186IFtwYXRoXX07CiAgfQp9CgpmdW5jdGlvbiBtYXRjaFJvdXRlc0ltcGwocm91dGVzLCBwYXRoLCBxdWVyeSwgdHJhY2UsIGFjdGl2ZVRyYWNlLCBvcmlnaW5hbFBhdGgpIHsKICByb3V0ZXMgPSBBcnJheS5pc0FycmF5KHJvdXRlcykgPyByb3V0ZXMgOiBbcm91dGVzXTsKICB0cmFjZSA9IHRyYWNlIHx8IFtdOwogIGFjdGl2ZVRyYWNlID0gYWN0aXZlVHJhY2UgfHwgW107CiAgb3JpZ2luYWxQYXRoID0gb3JpZ2luYWxQYXRoID09PSB1bmRlZmluZWQgPyBwYXRoIDogb3JpZ2luYWxQYXRoOwoKICBmb3IgKHZhciBpID0gMCwgbGVuID0gcm91dGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICB2YXIgcm91dGUgPSByb3V0ZXNbaV07CiAgICB2YXIgbWF0Y2ggPSBtYXRjaFJvdXRlKHJvdXRlLCBub3JtYWxpemUocGF0aCkpOwoKICAgIGlmICghbWF0Y2gpIHsKICAgICAgY29udGludWU7CiAgICB9CgogICAgdmFyIHN0ZXAgPSB7cm91dGU6cm91dGUsIG1hdGNoOm1hdGNoLCBwcm9wczoge3F1ZXJ5OnF1ZXJ5fX07CgogICAgdHJhY2UgPSB0cmFjZS5jb25jYXQoc3RlcCk7CgogICAgYWN0aXZlVHJhY2UgPSByb3V0ZS52aWV3ICE9PSB1bmRlZmluZWQgPwogICAgICBbc3RlcF0gOiBhY3RpdmVUcmFjZS5jb25jYXQoc3RlcCk7CgogICAgaWYgKChtYXRjaC5fIHx8ICFoYXNWaWV3KHJvdXRlKSkgJiYgcm91dGUuY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgICByZXR1cm4gbWF0Y2hSb3V0ZXNJbXBsKAogICAgICAgIHJvdXRlLmNoaWxkcmVuLCBtYXRjaC5fID8gbWF0Y2guX1swXSA6ICcvJywgcXVlcnksCiAgICAgICAgdHJhY2UsIGFjdGl2ZVRyYWNlLCBvcmlnaW5hbFBhdGgpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHtwYXRoOiBvcmlnaW5hbFBhdGgsIHF1ZXJ5OnF1ZXJ5LCByb3V0ZTpyb3V0ZSwgdHJhY2U6dHJhY2UsIGFjdGl2ZVRyYWNlOmFjdGl2ZVRyYWNlfTsKICAgIH0KICB9CgogIHJldHVybiB7CiAgICBwYXRoOiBvcmlnaW5hbFBhdGgsCiAgICBxdWVyeTpxdWVyeSwKICAgIHJvdXRlOiB1bmRlZmluZWQsCiAgICB0cmFjZTogW10sCiAgICBhY3RpdmVUcmFjZTogW10KICB9Owp9CgovKioKICogTWF0Y2ggcm91dGVzIGFnYWluc3QgcGF0aAogKgogKiBAcGFyYW0ge1JvdXRlfSByb3V0ZXMKICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICogQHJldHVybnMge01hdGNofQogKi8KZnVuY3Rpb24gbWF0Y2hSb3V0ZXMocm91dGVzLCBwYXRoLCBxdWVyeSkgewogIHF1ZXJ5ID0gcXVlcnkgPT09IHVuZGVmaW5lZCA/IHt9IDogaXNTdHJpbmcocXVlcnkpID8gcXMucGFyc2UocXVlcnkpIDogcXVlcnk7CiAgcmV0dXJuIG1hdGNoUm91dGVzSW1wbChyb3V0ZXMsIHBhdGgsIHF1ZXJ5KTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBtYXRjaFJvdXRlczsKCn0seyIuL2Rlc2NyaXB0b3JzIjoxMCwiLi9pc1N0cmluZyI6MTYsInFzIjoxLCJ1cmwtcGF0dGVybiI6Mn1dLDIwOltmdW5jdGlvbihfX2Jyb3dzZXJpZnlfXyxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBDb3B5cmlnaHQgMjAxMy0yMDE0IEZhY2Vib29rLCBJbmMuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwogKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQogKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAogKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICoKICogQHByb3ZpZGVzTW9kdWxlIG1lcmdlCiAqLwoKInVzZSBzdHJpY3QiOwoKdmFyIG1lcmdlSW50byA9IF9fYnJvd3NlcmlmeV9fKCcuL21lcmdlSW50bycpOwoKLyoqCiAqIFNoYWxsb3cgbWVyZ2VzIHR3byBzdHJ1Y3R1cmVzIGludG8gYSByZXR1cm4gdmFsdWUsIHdpdGhvdXQgbXV0YXRpbmcgZWl0aGVyLgogKgogKiBAcGFyYW0gez9vYmplY3R9IG9uZSBPcHRpb25hbCBvYmplY3Qgd2l0aCBwcm9wZXJ0aWVzIHRvIG1lcmdlIGZyb20uCiAqIEBwYXJhbSB7P29iamVjdH0gdHdvIE9wdGlvbmFsIG9iamVjdCB3aXRoIHByb3BlcnRpZXMgdG8gbWVyZ2UgZnJvbS4KICogQHJldHVybiB7b2JqZWN0fSBUaGUgc2hhbGxvdyBleHRlbnNpb24gb2Ygb25lIGJ5IHR3by4KICovCnZhciBtZXJnZSA9IGZ1bmN0aW9uKG9uZSwgdHdvKSB7CiAgdmFyIHJlc3VsdCA9IHt9OwogIG1lcmdlSW50byhyZXN1bHQsIG9uZSk7CiAgbWVyZ2VJbnRvKHJlc3VsdCwgdHdvKTsKICByZXR1cm4gcmVzdWx0Owp9OwoKbW9kdWxlLmV4cG9ydHMgPSBtZXJnZTsKCn0seyIuL21lcmdlSW50byI6MjJ9XSwyMTpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQ29weXJpZ2h0IDIwMTMtMjAxNCBGYWNlYm9vaywgSW5jLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIEBwcm92aWRlc01vZHVsZSBtZXJnZUhlbHBlcnMKICoKICogcmVxdWlyZXNQb2x5ZmlsbHM6IEFycmF5LmlzQXJyYXkKICovCgoidXNlIHN0cmljdCI7Cgp2YXIgaW52YXJpYW50ID0gX19icm93c2VyaWZ5X18oJy4vaW52YXJpYW50Jyk7CnZhciBrZXlNaXJyb3IgPSBfX2Jyb3dzZXJpZnlfXygnLi9rZXlNaXJyb3InKTsKCi8qKgogKiBNYXhpbXVtIG51bWJlciBvZiBsZXZlbHMgdG8gdHJhdmVyc2UuIFdpbGwgY2F0Y2ggY2lyY3VsYXIgc3RydWN0dXJlcy4KICogQGNvbnN0CiAqLwp2YXIgTUFYX01FUkdFX0RFUFRIID0gMzY7CgovKioKICogV2Ugd29uJ3Qgd29ycnkgYWJvdXQgZWRnZSBjYXNlcyBsaWtlIG5ldyBTdHJpbmcoJ3gnKSBvciBuZXcgQm9vbGVhbih0cnVlKS4KICogRnVuY3Rpb25zIGFyZSBjb25zaWRlcmVkIHRlcm1pbmFscywgYW5kIGFycmF5cyBhcmUgbm90LgogKiBAcGFyYW0geyp9IG8gVGhlIGl0ZW0vb2JqZWN0L3ZhbHVlIHRvIHRlc3QuCiAqIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWZmIHRoZSBhcmd1bWVudCBpcyBhIHRlcm1pbmFsLgogKi8KdmFyIGlzVGVybWluYWwgPSBmdW5jdGlvbihvKSB7CiAgcmV0dXJuIHR5cGVvZiBvICE9PSAnb2JqZWN0JyB8fCBvID09PSBudWxsOwp9OwoKdmFyIG1lcmdlSGVscGVycyA9IHsKCiAgTUFYX01FUkdFX0RFUFRIOiBNQVhfTUVSR0VfREVQVEgsCgogIGlzVGVybWluYWw6IGlzVGVybWluYWwsCgogIC8qKgogICAqIENvbnZlcnRzIG51bGwvdW5kZWZpbmVkIHZhbHVlcyBpbnRvIGVtcHR5IG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7P09iamVjdD19IGFyZyBBcmd1bWVudCB0byBiZSBub3JtYWxpemVkIChudWxsYWJsZSBvcHRpb25hbCkKICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIG5vcm1hbGl6ZU1lcmdlQXJnOiBmdW5jdGlvbihhcmcpIHsKICAgIHJldHVybiBhcmcgPT09IHVuZGVmaW5lZCB8fCBhcmcgPT09IG51bGwgPyB7fSA6IGFyZzsKICB9LAoKICAvKioKICAgKiBJZiBtZXJnaW5nIEFycmF5cywgYSBtZXJnZSBzdHJhdGVneSAqbXVzdCogYmUgc3VwcGxpZWQuIElmIG5vdCwgaXQgaXMKICAgKiBsaWtlbHkgdGhlIGNhbGxlcidzIGZhdWx0LiBJZiB0aGlzIGZ1bmN0aW9uIGlzIGV2ZXIgY2FsbGVkIHdpdGggYW55dGhpbmcKICAgKiBidXQgYG9uZWAgYW5kIGB0d29gIGJlaW5nIGBBcnJheWBzLCBpdCBpcyB0aGUgZmF1bHQgb2YgdGhlIG1lcmdlIHV0aWxpdGllcy4KICAgKgogICAqIEBwYXJhbSB7Kn0gb25lIEFycmF5IHRvIG1lcmdlIGludG8uCiAgICogQHBhcmFtIHsqfSB0d28gQXJyYXkgdG8gbWVyZ2UgZnJvbS4KICAgKi8KICBjaGVja01lcmdlQXJyYXlBcmdzOiBmdW5jdGlvbihvbmUsIHR3bykgewogICAgaW52YXJpYW50KAogICAgICBBcnJheS5pc0FycmF5KG9uZSkgJiYgQXJyYXkuaXNBcnJheSh0d28pLAogICAgICAnVHJpZWQgdG8gbWVyZ2UgYXJyYXlzLCBpbnN0ZWFkIGdvdCAlcyBhbmQgJXMuJywKICAgICAgb25lLAogICAgICB0d28KICAgICk7CiAgfSwKCiAgLyoqCiAgICogQHBhcmFtIHsqfSBvbmUgT2JqZWN0IHRvIG1lcmdlIGludG8uCiAgICogQHBhcmFtIHsqfSB0d28gT2JqZWN0IHRvIG1lcmdlIGZyb20uCiAgICovCiAgY2hlY2tNZXJnZU9iamVjdEFyZ3M6IGZ1bmN0aW9uKG9uZSwgdHdvKSB7CiAgICBtZXJnZUhlbHBlcnMuY2hlY2tNZXJnZU9iamVjdEFyZyhvbmUpOwogICAgbWVyZ2VIZWxwZXJzLmNoZWNrTWVyZ2VPYmplY3RBcmcodHdvKTsKICB9LAoKICAvKioKICAgKiBAcGFyYW0geyp9IGFyZwogICAqLwogIGNoZWNrTWVyZ2VPYmplY3RBcmc6IGZ1bmN0aW9uKGFyZykgewogICAgaW52YXJpYW50KAogICAgICAhaXNUZXJtaW5hbChhcmcpICYmICFBcnJheS5pc0FycmF5KGFyZyksCiAgICAgICdUcmllZCB0byBtZXJnZSBhbiBvYmplY3QsIGluc3RlYWQgZ290ICVzLicsCiAgICAgIGFyZwogICAgKTsKICB9LAoKICAvKioKICAgKiBDaGVja3MgdGhhdCBhIG1lcmdlIHdhcyBub3QgZ2l2ZW4gYSBjaXJjdWxhciBvYmplY3Qgb3IgYW4gb2JqZWN0IHRoYXQgaGFkCiAgICogdG9vIGdyZWF0IG9mIGRlcHRoLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IExldmVsIG9mIHJlY3Vyc2lvbiB0byB2YWxpZGF0ZSBhZ2FpbnN0IG1heGltdW0uCiAgICovCiAgY2hlY2tNZXJnZUxldmVsOiBmdW5jdGlvbihsZXZlbCkgewogICAgaW52YXJpYW50KAogICAgICBsZXZlbCA8IE1BWF9NRVJHRV9ERVBUSCwKICAgICAgJ01heGltdW0gZGVlcCBtZXJnZSBkZXB0aCBleGNlZWRlZC4gWW91IG1heSBiZSBhdHRlbXB0aW5nIHRvIG1lcmdlICcgKwogICAgICAnY2lyY3VsYXIgc3RydWN0dXJlcyBpbiBhbiB1bnN1cHBvcnRlZCB3YXkuJwogICAgKTsKICB9LAoKICAvKioKICAgKiBDaGVja3MgdGhhdCB0aGUgc3VwcGxpZWQgbWVyZ2Ugc3RyYXRlZ3kgaXMgdmFsaWQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gQXJyYXkgbWVyZ2Ugc3RyYXRlZ3kuCiAgICovCiAgY2hlY2tBcnJheVN0cmF0ZWd5OiBmdW5jdGlvbihzdHJhdGVneSkgewogICAgaW52YXJpYW50KAogICAgICBzdHJhdGVneSA9PT0gdW5kZWZpbmVkIHx8IHN0cmF0ZWd5IGluIG1lcmdlSGVscGVycy5BcnJheVN0cmF0ZWdpZXMsCiAgICAgICdZb3UgbXVzdCBwcm92aWRlIGFuIGFycmF5IHN0cmF0ZWd5IHRvIGRlZXAgbWVyZ2UgZnVuY3Rpb25zIHRvICcgKwogICAgICAnaW5zdHJ1Y3QgdGhlIGRlZXAgbWVyZ2UgaG93IHRvIHJlc29sdmUgbWVyZ2luZyB0d28gYXJyYXlzLicKICAgICk7CiAgfSwKCiAgLyoqCiAgICogU2V0IG9mIHBvc3NpYmxlIGJlaGF2aW9ycyBvZiBtZXJnZSBhbGdvcml0aG1zIHdoZW4gZW5jb3VudGVyaW5nIHR3byBBcnJheXMKICAgKiB0aGF0IG11c3QgYmUgbWVyZ2VkIHRvZ2V0aGVyLgogICAqIC0gYGNsb2JiZXJgOiBUaGUgbGVmdCBgQXJyYXlgIGlzIGlnbm9yZWQuCiAgICogLSBgaW5kZXhCeUluZGV4YDogVGhlIHJlc3VsdCBpcyBhY2hpZXZlZCBieSByZWN1cnNpdmVseSBkZWVwIG1lcmdpbmcgYXQKICAgKiAgIGVhY2ggaW5kZXguIChub3QgeWV0IHN1cHBvcnRlZC4pCiAgICovCiAgQXJyYXlTdHJhdGVnaWVzOiBrZXlNaXJyb3IoewogICAgQ2xvYmJlcjogdHJ1ZSwKICAgIEluZGV4QnlJbmRleDogdHJ1ZQogIH0pCgp9OwoKbW9kdWxlLmV4cG9ydHMgPSBtZXJnZUhlbHBlcnM7Cgp9LHsiLi9pbnZhcmlhbnQiOjE1LCIuL2tleU1pcnJvciI6MTd9XSwyMjpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQ29weXJpZ2h0IDIwMTMtMjAxNCBGYWNlYm9vaywgSW5jLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIEBwcm92aWRlc01vZHVsZSBtZXJnZUludG8KICogQHR5cGVjaGVja3Mgc3RhdGljLW9ubHkKICovCgoidXNlIHN0cmljdCI7Cgp2YXIgbWVyZ2VIZWxwZXJzID0gX19icm93c2VyaWZ5X18oJy4vbWVyZ2VIZWxwZXJzJyk7Cgp2YXIgY2hlY2tNZXJnZU9iamVjdEFyZyA9IG1lcmdlSGVscGVycy5jaGVja01lcmdlT2JqZWN0QXJnOwoKLyoqCiAqIFNoYWxsb3cgbWVyZ2VzIHR3byBzdHJ1Y3R1cmVzIGJ5IG11dGF0aW5nIHRoZSBmaXJzdCBwYXJhbWV0ZXIuCiAqCiAqIEBwYXJhbSB7b2JqZWN0fSBvbmUgT2JqZWN0IHRvIGJlIG1lcmdlZCBpbnRvLgogKiBAcGFyYW0gez9vYmplY3R9IHR3byBPcHRpb25hbCBvYmplY3Qgd2l0aCBwcm9wZXJ0aWVzIHRvIG1lcmdlIGZyb20uCiAqLwpmdW5jdGlvbiBtZXJnZUludG8ob25lLCB0d28pIHsKICBjaGVja01lcmdlT2JqZWN0QXJnKG9uZSk7CiAgaWYgKHR3byAhPSBudWxsKSB7CiAgICBjaGVja01lcmdlT2JqZWN0QXJnKHR3byk7CiAgICBmb3IgKHZhciBrZXkgaW4gdHdvKSB7CiAgICAgIGlmICghdHdvLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBvbmVba2V5XSA9IHR3b1trZXldOwogICAgfQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBtZXJnZUludG87Cgp9LHsiLi9tZXJnZUhlbHBlcnMiOjIxfV0sMjM6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEBqc3ggUmVhY3QuRE9NCiAqLwondXNlIHN0cmljdCc7Cgp2YXIgUmVhY3QgICAgICAgPSAod2luZG93LlJlYWN0KTsKdmFyIFByb21pc2UgICAgID0gKHdpbmRvdy5Qcm9taXNlKTsKdmFyIG1hdGNoUm91dGVzID0gX19icm93c2VyaWZ5X18oJy4vbWF0Y2hSb3V0ZXMnKTsKdmFyIGRhdGEgICAgICAgID0gX19icm93c2VyaWZ5X18oJy4vZGF0YScpOwp2YXIgY3JlYXRlVmlldyAgPSBfX2Jyb3dzZXJpZnlfXygnLi9jcmVhdGVWaWV3Jyk7CnZhciBmZXRjaFZpZXdzICA9IF9fYnJvd3NlcmlmeV9fKCcuL2ZldGNoVmlld3MnKTsKCmZ1bmN0aW9uIHJvdXRlKHJvdXRlcywgcGF0aCwgcXVlcnkpIHsKICBxdWVyeSA9IHF1ZXJ5IHx8ICcnOwogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpICB7CiAgICB2YXIgbWF0Y2ggPSBtYXRjaFJvdXRlcyhyb3V0ZXMsIHBhdGgsIHF1ZXJ5KTsKICAgIHJldHVybiBmZXRjaFZpZXdzKG1hdGNoKS50aGVuKGRhdGEuZmV0Y2gpLnRoZW4oZnVuY3Rpb24obWF0Y2gpICB7CiAgICAgIHJldHVybiBmdW5jdGlvbiBleGVjdXRlKGZ1bmMpIHsKICAgICAgICBSZWFjdC53aXRoQ29udGV4dCh7bWF0Y2g6bWF0Y2gsIHJvdXRlczpyb3V0ZXN9LCBmdW5jdGlvbigpICB7CiAgICAgICAgICB2YXIgdmlldyA9IGNyZWF0ZVZpZXcobWF0Y2gpOwogICAgICAgICAgcmV0dXJuIGZ1bmModmlldywgbWF0Y2gsIHtpbml0aWFsOiB0cnVlfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTsKICB9KTsKfQoKbW9kdWxlLmV4cG9ydHMgPSByb3V0ZTsKCn0seyIuL2NyZWF0ZVZpZXciOjgsIi4vZGF0YSI6OSwiLi9mZXRjaFZpZXdzIjoxMiwiLi9tYXRjaFJvdXRlcyI6MTl9XSwyNDpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQGpzeCBSZWFjdC5ET00KICovCid1c2Ugc3RyaWN0JzsKCnZhciBSb3V0aW5nID0gX19icm93c2VyaWZ5X18oJy4vUm91dGluZycpOwoKZm9yKHZhciBSb3V0aW5nX19fX0tleSBpbiBSb3V0aW5nKXtpZihSb3V0aW5nLmhhc093blByb3BlcnR5KFJvdXRpbmdfX19fS2V5KSl7SGFzaFJvdXRpbmdbUm91dGluZ19fX19LZXldPVJvdXRpbmdbUm91dGluZ19fX19LZXldO319dmFyIF9fX19TdXBlclByb3RvT2ZSb3V0aW5nPVJvdXRpbmc9PT1udWxsP251bGw6Um91dGluZy5wcm90b3R5cGU7SGFzaFJvdXRpbmcucHJvdG90eXBlPU9iamVjdC5jcmVhdGUoX19fX1N1cGVyUHJvdG9PZlJvdXRpbmcpO0hhc2hSb3V0aW5nLnByb3RvdHlwZS5jb25zdHJ1Y3Rvcj1IYXNoUm91dGluZztIYXNoUm91dGluZy5fX3N1cGVyQ29uc3RydWN0b3JfXz1Sb3V0aW5nO2Z1bmN0aW9uIEhhc2hSb3V0aW5nKCl7aWYoUm91dGluZyE9PW51bGwpe1JvdXRpbmcuYXBwbHkodGhpcyxhcmd1bWVudHMpO319CgogIEhhc2hSb3V0aW5nLnByb3RvdHlwZS5nZXRQYXRoPWZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0UGFyc2VkUGF0aCgpLnBhdGg7CiAgfTsKCiAgSGFzaFJvdXRpbmcucHJvdG90eXBlLmdldFF1ZXJ5PWZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0UGFyc2VkUGF0aCgpLnF1ZXJ5OwogIH07CgogIEhhc2hSb3V0aW5nLnByb3RvdHlwZS5nZXRQYXJzZWRQYXRoPWZ1bmN0aW9uKCkgewogICAgdmFyIHBhdGggPSB3aW5kb3cubG9jYXRpb24uaGFzaC5zbGljZSgxKSB8fCAnLyc7CiAgICB2YXIgaWR4ID0gcGF0aC5pbmRleE9mKCc/Jyk7CiAgICBpZiAoaWR4ID4gLTEpIHsKICAgICAgcmV0dXJuIHtwYXRoOiBwYXRoLnN1YnN0cmluZygwLCBpZHgpLCBxdWVyeTogcGF0aC5zdWJzdHJpbmcoaWR4ICsgMSl9OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHtwYXRoOnBhdGgsIHF1ZXJ5OiAnJ307CiAgICB9CiAgfTsKCiAgSGFzaFJvdXRpbmcucHJvdG90eXBlLnB1c2hQYXRoPWZ1bmN0aW9uKHBhdGgpIHsKICAgIHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gcGF0aDsKICB9OwoKICBIYXNoUm91dGluZy5wcm90b3R5cGUucmVwbGFjZVBhdGg9ZnVuY3Rpb24ocGF0aCkgewogICAgdmFyIGhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5yZXBsYWNlKC8oamF2YXNjcmlwdDp8IykuKiQvLCAnJyk7CiAgICB3aW5kb3cubG9jYXRpb24ucmVwbGFjZShocmVmICsgJyMnICsgcGF0aCk7CiAgfTsKCiAgSGFzaFJvdXRpbmcucHJvdG90eXBlLm1ha2VIcmVmPWZ1bmN0aW9uKG5hbWUsIHBhcmFtcykgewogICAgcmV0dXJuICcjJyArIF9fX19TdXBlclByb3RvT2ZSb3V0aW5nLm1ha2VIcmVmLmNhbGwodGhpcyxuYW1lLCBwYXJhbXMpOwogIH07CgogIEhhc2hSb3V0aW5nLnByb3RvdHlwZS5kb1N0YXJ0PWZ1bmN0aW9uKCkgewogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2hhc2hjaGFuZ2UnLCB0aGlzLm9uQmFja0J1dHRvbik7CiAgfTsKCiAgSGFzaFJvdXRpbmcucHJvdG90eXBlLmRvU3RvcD1mdW5jdGlvbigpIHsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdoYXNoY2hhbmdlJywgdGhpcy5vbkJhY2tCdXR0b24pOwogIH07CgoKbW9kdWxlLmV4cG9ydHMgPSBIYXNoUm91dGluZzsKCn0seyIuL1JvdXRpbmciOjI2fV0sMjU6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEBqc3ggUmVhY3QuRE9NCiAqLwondXNlIHN0cmljdCc7Cgp2YXIgUm91dGluZyA9IF9fYnJvd3NlcmlmeV9fKCcuL1JvdXRpbmcnKTsKCmZvcih2YXIgUm91dGluZ19fX19LZXkgaW4gUm91dGluZyl7aWYoUm91dGluZy5oYXNPd25Qcm9wZXJ0eShSb3V0aW5nX19fX0tleSkpe1BhdGhuYW1lUm91dGluZ1tSb3V0aW5nX19fX0tleV09Um91dGluZ1tSb3V0aW5nX19fX0tleV07fX12YXIgX19fX1N1cGVyUHJvdG9PZlJvdXRpbmc9Um91dGluZz09PW51bGw/bnVsbDpSb3V0aW5nLnByb3RvdHlwZTtQYXRobmFtZVJvdXRpbmcucHJvdG90eXBlPU9iamVjdC5jcmVhdGUoX19fX1N1cGVyUHJvdG9PZlJvdXRpbmcpO1BhdGhuYW1lUm91dGluZy5wcm90b3R5cGUuY29uc3RydWN0b3I9UGF0aG5hbWVSb3V0aW5nO1BhdGhuYW1lUm91dGluZy5fX3N1cGVyQ29uc3RydWN0b3JfXz1Sb3V0aW5nO2Z1bmN0aW9uIFBhdGhuYW1lUm91dGluZygpe2lmKFJvdXRpbmchPT1udWxsKXtSb3V0aW5nLmFwcGx5KHRoaXMsYXJndW1lbnRzKTt9fQoKICBQYXRobmFtZVJvdXRpbmcucHJvdG90eXBlLmdldFBhdGg9ZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lOwogIH07CgogIFBhdGhuYW1lUm91dGluZy5wcm90b3R5cGUuZ2V0UXVlcnk9ZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gd2luZG93LmxvY2F0aW9uLnNlYXJjaC5zdWJzdHIoMSk7CiAgfTsKCiAgUGF0aG5hbWVSb3V0aW5nLnByb3RvdHlwZS5wdXNoUGF0aD1mdW5jdGlvbihwYXRoKSB7CiAgICB3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUoe30sICcnLCBwYXRoKTsKICB9OwoKICBQYXRobmFtZVJvdXRpbmcucHJvdG90eXBlLnJlcGxhY2VQYXRoPWZ1bmN0aW9uKHBhdGgpIHsKICAgIHdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgJycsIHBhdGgpOwogIH07CgogIFBhdGhuYW1lUm91dGluZy5wcm90b3R5cGUuZG9TdGFydD1mdW5jdGlvbigpIHsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIHRoaXMub25CYWNrQnV0dG9uKTsKICB9OwoKICBQYXRobmFtZVJvdXRpbmcucHJvdG90eXBlLmRvU3RvcD1mdW5jdGlvbigpIHsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIHRoaXMub25CYWNrQnV0dG9uKTsKICB9OwoKCm1vZHVsZS5leHBvcnRzID0gUGF0aG5hbWVSb3V0aW5nOwoKfSx7Ii4vUm91dGluZyI6MjZ9XSwyNjpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQGpzeCBSZWFjdC5ET00KICovCid1c2Ugc3RyaWN0JzsKCnZhciBxcyAgICAgICAgICAgICAgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygncXMnKTsKdmFyIFJlYWN0ICAgICAgICAgICAgICAgICA9ICh3aW5kb3cuUmVhY3QpOwp2YXIgY3JlYXRlVmlldyAgICAgICAgICAgID0gX19icm93c2VyaWZ5X18oJy4uL2NyZWF0ZVZpZXcnKTsKdmFyIG1hdGNoUm91dGVzICAgICAgICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuLi9tYXRjaFJvdXRlcycpOwp2YXIgZGF0YSAgICAgICAgICAgICAgICAgID0gX19icm93c2VyaWZ5X18oJy4uL2RhdGEnKTsKdmFyIGZldGNoVmlld3MgICAgICAgICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuLi9mZXRjaFZpZXdzJyk7CnZhciBtYWtlSHJlZiAgICAgICAgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygnLi4vbWFrZUhyZWYnKTsKCmZ1bmN0aW9uIHRocm93RXJyb3IoZXJyKSB7CiAgdGhyb3cgZXJyOwp9CgoKCiAgZnVuY3Rpb24gUm91dGluZyhyb3V0ZXMsIG9uUm91dGUsIG9uRXJyb3IpIHsKICAgIHRoaXMucm91dGVzID0gcm91dGVzOwogICAgdGhpcy5vblJvdXRlID0gb25Sb3V0ZTsKICAgIHRoaXMub25FcnJvciA9IG9uRXJyb3IgfHwgdGhyb3dFcnJvcjsKICAgIHRoaXMub25DaGFuZ2UgPSB0aGlzLm9uQ2hhbmdlLmJpbmQodGhpcyk7CiAgICB0aGlzLm9uQmFja0J1dHRvbiA9IHRoaXMub25CYWNrQnV0dG9uLmJpbmQodGhpcyk7CiAgICB0aGlzLnBhdGggPSB1bmRlZmluZWQ7CiAgICB0aGlzLm1hdGNoID0gdW5kZWZpbmVkOwogICAgdGhpcy5zdGFydGVkID0gZmFsc2U7CiAgfQoKICBSb3V0aW5nLnByb3RvdHlwZS5vbkNoYW5nZT1mdW5jdGlvbihuYXZpZ2F0aW9uKSB7CiAgICBuYXZpZ2F0aW9uID0gbmF2aWdhdGlvbiB8fCB7fTsKICAgIHZhciBwYXRoID0gdGhpcy5nZXRQYXRoKCk7CiAgICB2YXIgcXVlcnkgPSB0aGlzLmdldFF1ZXJ5KCk7CiAgICBpZiAodGhpcy5wYXRoICE9PSBwYXRoIHx8IHRoaXMucXVlcnkgIT09IHF1ZXJ5KSB7CiAgICAgIHRoaXMuJFJvdXRpbmdfcm91dGUocGF0aCwgcXVlcnksIG5hdmlnYXRpb24pOwogICAgfQogIH07CgogIFJvdXRpbmcucHJvdG90eXBlLm9uQmFja0J1dHRvbj1mdW5jdGlvbigpIHsKICAgIHRoaXMub25DaGFuZ2Uoe2JhY2s6IHRydWV9KTsKICB9OwoKICBSb3V0aW5nLnByb3RvdHlwZS51cGRhdGU9ZnVuY3Rpb24oKSB7CiAgICB0aGlzLiRSb3V0aW5nX3JvdXRlKHRoaXMuZ2V0UGF0aCgpLCB0aGlzLmdldFF1ZXJ5KCkpOwogIH07CgogIFJvdXRpbmcucHJvdG90eXBlLiRSb3V0aW5nX3JvdXRlPWZ1bmN0aW9uKHBhdGgsIHF1ZXJ5LCBuYXZpZ2F0aW9uKSB7CiAgICB0aGlzLnBhdGggPSBwYXRoOwogICAgdGhpcy5xdWVyeSA9IHF1ZXJ5OwogICAgdGhpcy5tYXRjaCA9IG1hdGNoUm91dGVzKHRoaXMucm91dGVzLCBwYXRoLCBxdWVyeSk7CgogICAgdmFyIGV4cGVjdGVkTWF0Y2ggPSB0aGlzLm1hdGNoOwoKICAgIHZhciByZW5kZXIgPSBmdW5jdGlvbihtYXRjaCkgIHsKICAgICAgaWYgKHRoaXMubWF0Y2ggPT09IGV4cGVjdGVkTWF0Y2gpIHsKICAgICAgICB0aGlzLnJlbmRlclZpZXcobWF0Y2gsIG5hdmlnYXRpb24pOwogICAgICB9CiAgICB9LmJpbmQodGhpcyk7CgogICAgdmFyIHByb21pc2UgPSBmZXRjaFZpZXdzKHRoaXMubWF0Y2gpOwoKICAgIGlmIChwcm9taXNlLmlzRnVsZmlsbGVkKCkpIHsKICAgICAgcmVuZGVyKGRhdGEuZmV0Y2hQcm9ncmVzc2l2ZWx5KHByb21pc2UudmFsdWUoKSwgcmVuZGVyLCB0aGlzLm9uRXJyb3IpKTsKICAgIH0gZWxzZSB7CiAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbihtYXRjaCkgIHsKICAgICAgICByZW5kZXIoZGF0YS5mZXRjaFByb2dyZXNzaXZlbHkobWF0Y2gsIHJlbmRlciwgdGhpcy5vbkVycm9yKSk7CiAgICAgIH0uYmluZCh0aGlzKSwgdGhpcy5vbkVycm9yKTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5tYXRjaDsKICB9OwoKICBSb3V0aW5nLnByb3RvdHlwZS5yZW5kZXJWaWV3PWZ1bmN0aW9uKG1hdGNoLCBuYXZpZ2F0aW9uKSB7CiAgICB2YXIgY29udGV4dCA9IHttYXRjaDptYXRjaCwgcm91dGluZzogdGhpcywgcm91dGVzOiB0aGlzLnJvdXRlc307CiAgICBSZWFjdC53aXRoQ29udGV4dChjb250ZXh0LCBmdW5jdGlvbigpICB7CiAgICAgIHZhciB2aWV3ID0gY3JlYXRlVmlldyhtYXRjaCk7CiAgICAgIHRoaXMub25Sb3V0ZSh2aWV3LCBtYXRjaCwgbmF2aWdhdGlvbik7CiAgICB9LmJpbmQodGhpcykpOwogIH07CgogIFJvdXRpbmcucHJvdG90eXBlLm5hdmlnYXRlPWZ1bmN0aW9uKHBhdGgsIG5hdmlnYXRpb24pIHsKICAgIG5hdmlnYXRpb24gPSBuYXZpZ2F0aW9uIHx8IHt9OwogICAgaWYgKG5hdmlnYXRpb24ucmVwbGFjZSkgewogICAgICB0aGlzLnJlcGxhY2VQYXRoKHBhdGgsIG5hdmlnYXRpb24pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5wdXNoUGF0aChwYXRoLCBuYXZpZ2F0aW9uKTsKICAgIH0KICAgIHJldHVybiB0aGlzLm9uQ2hhbmdlKG5hdmlnYXRpb24pOwogIH07CgogIFJvdXRpbmcucHJvdG90eXBlLm5hdmlnYXRlVG89ZnVuY3Rpb24ocm91dGVSZWYsIHByb3BzLCBuYXZpZ2F0aW9uKSB7CiAgICB2YXIgcGF0aCA9IHRoaXMubWFrZUhyZWYocm91dGVSZWYsIHByb3BzKTsKICAgIHRoaXMubmF2aWdhdGUocGF0aCwgbmF2aWdhdGlvbik7CiAgfTsKCiAgUm91dGluZy5wcm90b3R5cGUubWFrZUhyZWY9ZnVuY3Rpb24obmFtZSwgcGFyYW1zKSB7CiAgICB2YXIgaHJlZiA9IG1ha2VIcmVmKHRoaXMucm91dGVzLCBuYW1lLCB0aGlzLm1hdGNoLCBwYXJhbXMpOwogICAgaWYgKHBhcmFtcyAmJiBwYXJhbXMucXVlcnkpIHsKICAgICAgaHJlZiA9IGhyZWYgKyAnPycgKyBxcy5zdHJpbmdpZnkocGFyYW1zLnF1ZXJ5KTsKICAgIH0KICAgIHJldHVybiBocmVmOwogIH07CgogIFJvdXRpbmcucHJvdG90eXBlLnN0YXJ0PWZ1bmN0aW9uKCkgewogICAgaWYgKCF0aGlzLnN0YXJ0ZWQpIHsKICAgICAgdGhpcy5kb1N0YXJ0KCk7CiAgICAgIHRoaXMub25DaGFuZ2Uoe2luaXRpYWw6IHRydWV9KTsKICAgICAgdGhpcy5zdGFydGVkID0gdHJ1ZTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CgogIFJvdXRpbmcucHJvdG90eXBlLnN0b3A9ZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5zdGFydGVkKSB7CiAgICAgIHRoaXMuZG9TdG9wKCk7CiAgICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgUm91dGluZy5zdGFydD1mdW5jdGlvbihyb3V0ZXMsIG9uUm91dGUsIG9uRXJyb3IpIHsKICAgIHJldHVybiBuZXcgdGhpcyhyb3V0ZXMsIG9uUm91dGUsIG9uRXJyb3IpLnN0YXJ0KCk7CiAgfTsKCgptb2R1bGUuZXhwb3J0cyA9IFJvdXRpbmc7Cgp9LHsiLi4vY3JlYXRlVmlldyI6OCwiLi4vZGF0YSI6OSwiLi4vZmV0Y2hWaWV3cyI6MTIsIi4uL21ha2VIcmVmIjoxOCwiLi4vbWF0Y2hSb3V0ZXMiOjE5LCJxcyI6MX1dfSx7fSxbM10pCg==",
                "body": "KGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmluZCBtb2R1bGUgJyIrbysiJyIpfXZhciBmPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChmLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGYsZi5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pKHsxOltmdW5jdGlvbihfX2Jyb3dzZXJpZnlfXyxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBPYmplY3QjdG9TdHJpbmcoKSByZWYgZm9yIHN0cmluZ2lmeSgpLgogKi8KCnZhciB0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CgovKioKICogT2JqZWN0I2hhc093blByb3BlcnR5IHJlZgogKi8KCnZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CgovKioKICogQXJyYXkjaW5kZXhPZiBzaGltLgogKi8KCnZhciBpbmRleE9mID0gdHlwZW9mIEFycmF5LnByb3RvdHlwZS5pbmRleE9mID09PSAnZnVuY3Rpb24nCiAgPyBmdW5jdGlvbihhcnIsIGVsKSB7IHJldHVybiBhcnIuaW5kZXhPZihlbCk7IH0KICA6IGZ1bmN0aW9uKGFyciwgZWwpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoYXJyW2ldID09PSBlbCkgcmV0dXJuIGk7CiAgICAgIH0KICAgICAgcmV0dXJuIC0xOwogICAgfTsKCi8qKgogKiBBcnJheS5pc0FycmF5IHNoaW0uCiAqLwoKdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uKGFycikgewogIHJldHVybiB0b1N0cmluZy5jYWxsKGFycikgPT0gJ1tvYmplY3QgQXJyYXldJzsKfTsKCi8qKgogKiBPYmplY3Qua2V5cyBzaGltLgogKi8KCnZhciBvYmplY3RLZXlzID0gT2JqZWN0LmtleXMgfHwgZnVuY3Rpb24ob2JqKSB7CiAgdmFyIHJldCA9IFtdOwogIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICByZXQucHVzaChrZXkpOwogICAgfQogIH0KICByZXR1cm4gcmV0Owp9OwoKLyoqCiAqIEFycmF5I2ZvckVhY2ggc2hpbS4KICovCgp2YXIgZm9yRWFjaCA9IHR5cGVvZiBBcnJheS5wcm90b3R5cGUuZm9yRWFjaCA9PT0gJ2Z1bmN0aW9uJwogID8gZnVuY3Rpb24oYXJyLCBmbikgeyByZXR1cm4gYXJyLmZvckVhY2goZm4pOyB9CiAgOiBmdW5jdGlvbihhcnIsIGZuKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSBmbihhcnJbaV0pOwogICAgfTsKCi8qKgogKiBBcnJheSNyZWR1Y2Ugc2hpbS4KICovCgp2YXIgcmVkdWNlID0gZnVuY3Rpb24oYXJyLCBmbiwgaW5pdGlhbCkgewogIGlmICh0eXBlb2YgYXJyLnJlZHVjZSA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIGFyci5yZWR1Y2UoZm4sIGluaXRpYWwpOwogIHZhciByZXMgPSBpbml0aWFsOwogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSByZXMgPSBmbihyZXMsIGFycltpXSk7CiAgcmV0dXJuIHJlczsKfTsKCi8qKgogKiBDYWNoZSBub24taW50ZWdlciB0ZXN0IHJlZ2V4cC4KICovCgp2YXIgaXNpbnQgPSAvXlswLTldKyQvOwoKZnVuY3Rpb24gcHJvbW90ZShwYXJlbnQsIGtleSkgewogIGlmIChwYXJlbnRba2V5XS5sZW5ndGggPT0gMCkgcmV0dXJuIHBhcmVudFtrZXldID0ge30KICB2YXIgdCA9IHt9OwogIGZvciAodmFyIGkgaW4gcGFyZW50W2tleV0pIHsKICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHBhcmVudFtrZXldLCBpKSkgewogICAgICB0W2ldID0gcGFyZW50W2tleV1baV07CiAgICB9CiAgfQogIHBhcmVudFtrZXldID0gdDsKICByZXR1cm4gdDsKfQoKZnVuY3Rpb24gcGFyc2UocGFydHMsIHBhcmVudCwga2V5LCB2YWwpIHsKICB2YXIgcGFydCA9IHBhcnRzLnNoaWZ0KCk7CiAgCiAgLy8gaWxsZWdhbAogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKE9iamVjdC5wcm90b3R5cGUsIGtleSkpIHJldHVybjsKICAKICAvLyBlbmQKICBpZiAoIXBhcnQpIHsKICAgIGlmIChpc0FycmF5KHBhcmVudFtrZXldKSkgewogICAgICBwYXJlbnRba2V5XS5wdXNoKHZhbCk7CiAgICB9IGVsc2UgaWYgKCdvYmplY3QnID09IHR5cGVvZiBwYXJlbnRba2V5XSkgewogICAgICBwYXJlbnRba2V5XSA9IHZhbDsKICAgIH0gZWxzZSBpZiAoJ3VuZGVmaW5lZCcgPT0gdHlwZW9mIHBhcmVudFtrZXldKSB7CiAgICAgIHBhcmVudFtrZXldID0gdmFsOwogICAgfSBlbHNlIHsKICAgICAgcGFyZW50W2tleV0gPSBbcGFyZW50W2tleV0sIHZhbF07CiAgICB9CiAgICAvLyBhcnJheQogIH0gZWxzZSB7CiAgICB2YXIgb2JqID0gcGFyZW50W2tleV0gPSBwYXJlbnRba2V5XSB8fCBbXTsKICAgIGlmICgnXScgPT0gcGFydCkgewogICAgICBpZiAoaXNBcnJheShvYmopKSB7CiAgICAgICAgaWYgKCcnICE9IHZhbCkgb2JqLnB1c2godmFsKTsKICAgICAgfSBlbHNlIGlmICgnb2JqZWN0JyA9PSB0eXBlb2Ygb2JqKSB7CiAgICAgICAgb2JqW29iamVjdEtleXMob2JqKS5sZW5ndGhdID0gdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIG9iaiA9IHBhcmVudFtrZXldID0gW3BhcmVudFtrZXldLCB2YWxdOwogICAgICB9CiAgICAgIC8vIHByb3AKICAgIH0gZWxzZSBpZiAofmluZGV4T2YocGFydCwgJ10nKSkgewogICAgICBwYXJ0ID0gcGFydC5zdWJzdHIoMCwgcGFydC5sZW5ndGggLSAxKTsKICAgICAgaWYgKCFpc2ludC50ZXN0KHBhcnQpICYmIGlzQXJyYXkob2JqKSkgb2JqID0gcHJvbW90ZShwYXJlbnQsIGtleSk7CiAgICAgIHBhcnNlKHBhcnRzLCBvYmosIHBhcnQsIHZhbCk7CiAgICAgIC8vIGtleQogICAgfSBlbHNlIHsKICAgICAgaWYgKCFpc2ludC50ZXN0KHBhcnQpICYmIGlzQXJyYXkob2JqKSkgb2JqID0gcHJvbW90ZShwYXJlbnQsIGtleSk7CiAgICAgIHBhcnNlKHBhcnRzLCBvYmosIHBhcnQsIHZhbCk7CiAgICB9CiAgfQp9CgovKioKICogTWVyZ2UgcGFyZW50IGtleS92YWwgcGFpci4KICovCgpmdW5jdGlvbiBtZXJnZShwYXJlbnQsIGtleSwgdmFsKXsKICBpZiAofmluZGV4T2Yoa2V5LCAnXScpKSB7CiAgICB2YXIgcGFydHMgPSBrZXkuc3BsaXQoJ1snKQogICAgICAsIGxlbiA9IHBhcnRzLmxlbmd0aAogICAgICAsIGxhc3QgPSBsZW4gLSAxOwogICAgcGFyc2UocGFydHMsIHBhcmVudCwgJ2Jhc2UnLCB2YWwpOwogICAgLy8gb3B0aW1pemUKICB9IGVsc2UgewogICAgaWYgKCFpc2ludC50ZXN0KGtleSkgJiYgaXNBcnJheShwYXJlbnQuYmFzZSkpIHsKICAgICAgdmFyIHQgPSB7fTsKICAgICAgZm9yICh2YXIgayBpbiBwYXJlbnQuYmFzZSkgdFtrXSA9IHBhcmVudC5iYXNlW2tdOwogICAgICBwYXJlbnQuYmFzZSA9IHQ7CiAgICB9CiAgICBzZXQocGFyZW50LmJhc2UsIGtleSwgdmFsKTsKICB9CgogIHJldHVybiBwYXJlbnQ7Cn0KCi8qKgogKiBDb21wYWN0IHNwYXJzZSBhcnJheXMuCiAqLwoKZnVuY3Rpb24gY29tcGFjdChvYmopIHsKICBpZiAoJ29iamVjdCcgIT0gdHlwZW9mIG9iaikgcmV0dXJuIG9iajsKCiAgaWYgKGlzQXJyYXkob2JqKSkgewogICAgdmFyIHJldCA9IFtdOwoKICAgIGZvciAodmFyIGkgaW4gb2JqKSB7CiAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgaSkpIHsKICAgICAgICByZXQucHVzaChvYmpbaV0pOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJldDsKICB9CgogIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgIG9ialtrZXldID0gY29tcGFjdChvYmpba2V5XSk7CiAgfQoKICByZXR1cm4gb2JqOwp9CgovKioKICogUGFyc2UgdGhlIGdpdmVuIG9iai4KICovCgpmdW5jdGlvbiBwYXJzZU9iamVjdChvYmopewogIHZhciByZXQgPSB7IGJhc2U6IHt9IH07CgogIGZvckVhY2gob2JqZWN0S2V5cyhvYmopLCBmdW5jdGlvbihuYW1lKXsKICAgIG1lcmdlKHJldCwgbmFtZSwgb2JqW25hbWVdKTsKICB9KTsKCiAgcmV0dXJuIGNvbXBhY3QocmV0LmJhc2UpOwp9CgovKioKICogUGFyc2UgdGhlIGdpdmVuIHN0ci4KICovCgpmdW5jdGlvbiBwYXJzZVN0cmluZyhzdHIpewogIHZhciByZXQgPSByZWR1Y2UoU3RyaW5nKHN0cikuc3BsaXQoJyYnKSwgZnVuY3Rpb24ocmV0LCBwYWlyKXsKICAgIHZhciBlcWwgPSBpbmRleE9mKHBhaXIsICc9JykKICAgICAgLCBicmFjZSA9IGxhc3RCcmFjZUluS2V5KHBhaXIpCiAgICAgICwga2V5ID0gcGFpci5zdWJzdHIoMCwgYnJhY2UgfHwgZXFsKQogICAgICAsIHZhbCA9IHBhaXIuc3Vic3RyKGJyYWNlIHx8IGVxbCwgcGFpci5sZW5ndGgpCiAgICAgICwgdmFsID0gdmFsLnN1YnN0cihpbmRleE9mKHZhbCwgJz0nKSArIDEsIHZhbC5sZW5ndGgpOwoKICAgIC8vID9mb28KICAgIGlmICgnJyA9PSBrZXkpIGtleSA9IHBhaXIsIHZhbCA9ICcnOwogICAgaWYgKCcnID09IGtleSkgcmV0dXJuIHJldDsKCiAgICByZXR1cm4gbWVyZ2UocmV0LCBkZWNvZGUoa2V5KSwgZGVjb2RlKHZhbCkpOwogIH0sIHsgYmFzZToge30gfSkuYmFzZTsKCiAgcmV0dXJuIGNvbXBhY3QocmV0KTsKfQoKLyoqCiAqIFBhcnNlIHRoZSBnaXZlbiBxdWVyeSBgc3RyYCBvciBgb2JqYCwgcmV0dXJuaW5nIGFuIG9iamVjdC4KICoKICogQHBhcmFtIHtTdHJpbmd9IHN0ciB8IHtPYmplY3R9IG9iagogKiBAcmV0dXJuIHtPYmplY3R9CiAqIEBhcGkgcHVibGljCiAqLwoKZXhwb3J0cy5wYXJzZSA9IGZ1bmN0aW9uKHN0cil7CiAgaWYgKG51bGwgPT0gc3RyIHx8ICcnID09IHN0cikgcmV0dXJuIHt9OwogIHJldHVybiAnb2JqZWN0JyA9PSB0eXBlb2Ygc3RyCiAgICA/IHBhcnNlT2JqZWN0KHN0cikKICAgIDogcGFyc2VTdHJpbmcoc3RyKTsKfTsKCi8qKgogKiBUdXJuIHRoZSBnaXZlbiBgb2JqYCBpbnRvIGEgcXVlcnkgc3RyaW5nCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBvYmoKICogQHJldHVybiB7U3RyaW5nfQogKiBAYXBpIHB1YmxpYwogKi8KCnZhciBzdHJpbmdpZnkgPSBleHBvcnRzLnN0cmluZ2lmeSA9IGZ1bmN0aW9uKG9iaiwgcHJlZml4KSB7CiAgaWYgKGlzQXJyYXkob2JqKSkgewogICAgcmV0dXJuIHN0cmluZ2lmeUFycmF5KG9iaiwgcHJlZml4KTsKICB9IGVsc2UgaWYgKCdbb2JqZWN0IE9iamVjdF0nID09IHRvU3RyaW5nLmNhbGwob2JqKSkgewogICAgcmV0dXJuIHN0cmluZ2lmeU9iamVjdChvYmosIHByZWZpeCk7CiAgfSBlbHNlIGlmICgnc3RyaW5nJyA9PSB0eXBlb2Ygb2JqKSB7CiAgICByZXR1cm4gc3RyaW5naWZ5U3RyaW5nKG9iaiwgcHJlZml4KTsKICB9IGVsc2UgewogICAgcmV0dXJuIHByZWZpeCArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudChTdHJpbmcob2JqKSk7CiAgfQp9OwoKLyoqCiAqIFN0cmluZ2lmeSB0aGUgZ2l2ZW4gYHN0cmAuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBzdHIKICogQHBhcmFtIHtTdHJpbmd9IHByZWZpeAogKiBAcmV0dXJuIHtTdHJpbmd9CiAqIEBhcGkgcHJpdmF0ZQogKi8KCmZ1bmN0aW9uIHN0cmluZ2lmeVN0cmluZyhzdHIsIHByZWZpeCkgewogIGlmICghcHJlZml4KSB0aHJvdyBuZXcgVHlwZUVycm9yKCdzdHJpbmdpZnkgZXhwZWN0cyBhbiBvYmplY3QnKTsKICByZXR1cm4gcHJlZml4ICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cik7Cn0KCi8qKgogKiBTdHJpbmdpZnkgdGhlIGdpdmVuIGBhcnJgLgogKgogKiBAcGFyYW0ge0FycmF5fSBhcnIKICogQHBhcmFtIHtTdHJpbmd9IHByZWZpeAogKiBAcmV0dXJuIHtTdHJpbmd9CiAqIEBhcGkgcHJpdmF0ZQogKi8KCmZ1bmN0aW9uIHN0cmluZ2lmeUFycmF5KGFyciwgcHJlZml4KSB7CiAgdmFyIHJldCA9IFtdOwogIGlmICghcHJlZml4KSB0aHJvdyBuZXcgVHlwZUVycm9yKCdzdHJpbmdpZnkgZXhwZWN0cyBhbiBvYmplY3QnKTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgcmV0LnB1c2goc3RyaW5naWZ5KGFycltpXSwgcHJlZml4ICsgJ1snICsgaSArICddJykpOwogIH0KICByZXR1cm4gcmV0LmpvaW4oJyYnKTsKfQoKLyoqCiAqIFN0cmluZ2lmeSB0aGUgZ2l2ZW4gYG9iamAuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBvYmoKICogQHBhcmFtIHtTdHJpbmd9IHByZWZpeAogKiBAcmV0dXJuIHtTdHJpbmd9CiAqIEBhcGkgcHJpdmF0ZQogKi8KCmZ1bmN0aW9uIHN0cmluZ2lmeU9iamVjdChvYmosIHByZWZpeCkgewogIHZhciByZXQgPSBbXQogICAgLCBrZXlzID0gb2JqZWN0S2V5cyhvYmopCiAgICAsIGtleTsKCiAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGtleXMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgIGtleSA9IGtleXNbaV07CiAgICBpZiAoJycgPT0ga2V5KSBjb250aW51ZTsKICAgIGlmIChudWxsID09IG9ialtrZXldKSB7CiAgICAgIHJldC5wdXNoKGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgJz0nKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldC5wdXNoKHN0cmluZ2lmeShvYmpba2V5XSwgcHJlZml4CiAgICAgICAgPyBwcmVmaXggKyAnWycgKyBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICddJwogICAgICAgIDogZW5jb2RlVVJJQ29tcG9uZW50KGtleSkpKTsKICAgIH0KICB9CgogIHJldHVybiByZXQuam9pbignJicpOwp9CgovKioKICogU2V0IGBvYmpgJ3MgYGtleWAgdG8gYHZhbGAgcmVzcGVjdGluZwogKiB0aGUgd2VpcmQgYW5kIHdvbmRlcmZ1bCBzeW50YXggb2YgYSBxcywKICogd2hlcmUgImZvbz1iYXImZm9vPWJheiIgYmVjb21lcyBhbiBhcnJheS4KICoKICogQHBhcmFtIHtPYmplY3R9IG9iagogKiBAcGFyYW0ge1N0cmluZ30ga2V5CiAqIEBwYXJhbSB7U3RyaW5nfSB2YWwKICogQGFwaSBwcml2YXRlCiAqLwoKZnVuY3Rpb24gc2V0KG9iaiwga2V5LCB2YWwpIHsKICB2YXIgdiA9IG9ialtrZXldOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKE9iamVjdC5wcm90b3R5cGUsIGtleSkpIHJldHVybjsKICBpZiAodW5kZWZpbmVkID09PSB2KSB7CiAgICBvYmpba2V5XSA9IHZhbDsKICB9IGVsc2UgaWYgKGlzQXJyYXkodikpIHsKICAgIHYucHVzaCh2YWwpOwogIH0gZWxzZSB7CiAgICBvYmpba2V5XSA9IFt2LCB2YWxdOwogIH0KfQoKLyoqCiAqIExvY2F0ZSBsYXN0IGJyYWNlIGluIGBzdHJgIHdpdGhpbiB0aGUga2V5LgogKgogKiBAcGFyYW0ge1N0cmluZ30gc3RyCiAqIEByZXR1cm4ge051bWJlcn0KICogQGFwaSBwcml2YXRlCiAqLwoKZnVuY3Rpb24gbGFzdEJyYWNlSW5LZXkoc3RyKSB7CiAgdmFyIGxlbiA9IHN0ci5sZW5ndGgKICAgICwgYnJhY2UKICAgICwgYzsKICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICBjID0gc3RyW2ldOwogICAgaWYgKCddJyA9PSBjKSBicmFjZSA9IGZhbHNlOwogICAgaWYgKCdbJyA9PSBjKSBicmFjZSA9IHRydWU7CiAgICBpZiAoJz0nID09IGMgJiYgIWJyYWNlKSByZXR1cm4gaTsKICB9Cn0KCi8qKgogKiBEZWNvZGUgYHN0cmAuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBzdHIKICogQHJldHVybiB7U3RyaW5nfQogKiBAYXBpIHByaXZhdGUKICovCgpmdW5jdGlvbiBkZWNvZGUoc3RyKSB7CiAgdHJ5IHsKICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQoc3RyLnJlcGxhY2UoL1wrL2csICcgJykpOwogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIHN0cjsKICB9Cn0KCn0se31dLDI6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjcuMQp2YXIgX19pbmRleE9mID0gW10uaW5kZXhPZiB8fCBmdW5jdGlvbihpdGVtKSB7IGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsgaWYgKGkgaW4gdGhpcyAmJiB0aGlzW2ldID09PSBpdGVtKSByZXR1cm4gaTsgfSByZXR1cm4gLTE7IH07Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBQYXR0ZXJuUHJvdG90eXBlOiB7CiAgICBtYXRjaDogZnVuY3Rpb24odXJsKSB7CiAgICAgIHZhciBib3VuZCwgY2FwdHVyZWQsIGksIG1hdGNoLCBuYW1lLCB2YWx1ZSwgX2ksIF9sZW47CiAgICAgIG1hdGNoID0gdGhpcy5yZWdleC5leGVjKHVybCk7CiAgICAgIGlmIChtYXRjaCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgY2FwdHVyZWQgPSBtYXRjaC5zbGljZSgxKTsKICAgICAgaWYgKHRoaXMuaXNSZWdleCkgewogICAgICAgIHJldHVybiBjYXB0dXJlZDsKICAgICAgfQogICAgICBib3VuZCA9IHt9OwogICAgICBmb3IgKGkgPSBfaSA9IDAsIF9sZW4gPSBjYXB0dXJlZC5sZW5ndGg7IF9pIDwgX2xlbjsgaSA9ICsrX2kpIHsKICAgICAgICB2YWx1ZSA9IGNhcHR1cmVkW2ldOwogICAgICAgIG5hbWUgPSB0aGlzLm5hbWVzW2ldOwogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKG5hbWUgPT09ICdfJykgewogICAgICAgICAgaWYgKGJvdW5kLl8gPT0gbnVsbCkgewogICAgICAgICAgICBib3VuZC5fID0gW107CiAgICAgICAgICB9CiAgICAgICAgICBib3VuZC5fLnB1c2godmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBib3VuZFtuYW1lXSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYm91bmQ7CiAgICB9CiAgfSwKICBuZXdQYXR0ZXJuOiBmdW5jdGlvbihhcmcsIHNlcGFyYXRvcikgewogICAgdmFyIGlzUmVnZXgsIHBhdHRlcm4sIHJlZ2V4U3RyaW5nOwogICAgaWYgKHNlcGFyYXRvciA9PSBudWxsKSB7CiAgICAgIHNlcGFyYXRvciA9ICcvJzsKICAgIH0KICAgIGlzUmVnZXggPSBhcmcgaW5zdGFuY2VvZiBSZWdFeHA7CiAgICBpZiAoISgoJ3N0cmluZycgPT09IHR5cGVvZiBhcmcpIHx8IGlzUmVnZXgpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2FyZ3VtZW50IG11c3QgYmUgYSByZWdleCBvciBhIHN0cmluZycpOwogICAgfQogICAgWyc6JywgJyonXS5mb3JFYWNoKGZ1bmN0aW9uKGZvcmJpZGRlbikgewogICAgICBpZiAoc2VwYXJhdG9yID09PSBmb3JiaWRkZW4pIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNlcGFyYXRvciBjYW4ndCBiZSAiICsgZm9yYmlkZGVuKTsKICAgICAgfQogICAgfSk7CiAgICBwYXR0ZXJuID0gT2JqZWN0LmNyZWF0ZShtb2R1bGUuZXhwb3J0cy5QYXR0ZXJuUHJvdG90eXBlKTsKICAgIHBhdHRlcm4uaXNSZWdleCA9IGlzUmVnZXg7CiAgICBwYXR0ZXJuLnJlZ2V4ID0gaXNSZWdleCA/IGFyZyA6IChyZWdleFN0cmluZyA9IG1vZHVsZS5leHBvcnRzLnRvUmVnZXhTdHJpbmcoYXJnLCBzZXBhcmF0b3IpLCBuZXcgUmVnRXhwKHJlZ2V4U3RyaW5nKSk7CiAgICBpZiAoIWlzUmVnZXgpIHsKICAgICAgcGF0dGVybi5uYW1lcyA9IG1vZHVsZS5leHBvcnRzLmdldE5hbWVzKGFyZywgc2VwYXJhdG9yKTsKICAgIH0KICAgIHJldHVybiBwYXR0ZXJuOwogIH0sCiAgZXNjYXBlRm9yUmVnZXg6IGZ1bmN0aW9uKHN0cmluZykgewogICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bLVwvXFxeJCorPy4oKXxbXF17fV0vZywgJ1xcJCYnKTsKICB9LAogIGdldE5hbWVzOiBmdW5jdGlvbihhcmcsIHNlcGFyYXRvcikgewogICAgdmFyIGVzY2FwZWRTZXBhcmF0b3IsIG5hbWUsIG5hbWVzLCByZWdleCwgcmVzdWx0czsKICAgIGlmIChzZXBhcmF0b3IgPT0gbnVsbCkgewogICAgICBzZXBhcmF0b3IgPSAnLyc7CiAgICB9CiAgICBpZiAoYXJnIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KICAgIGVzY2FwZWRTZXBhcmF0b3IgPSBtb2R1bGUuZXhwb3J0cy5lc2NhcGVGb3JSZWdleChzZXBhcmF0b3IpOwogICAgcmVnZXggPSBuZXcgUmVnRXhwKCIoKDo/OlteIiArIGVzY2FwZWRTZXBhcmF0b3IgKyAiXChcKV0rKXwoPzpbXCpdKSkiLCAnZycpOwogICAgbmFtZXMgPSBbXTsKICAgIHJlc3VsdHMgPSByZWdleC5leGVjKGFyZyk7CiAgICB3aGlsZSAocmVzdWx0cyAhPSBudWxsKSB7CiAgICAgIG5hbWUgPSByZXN1bHRzWzFdLnNsaWNlKDEpOwogICAgICBpZiAobmFtZSA9PT0gJ18nKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiOl8gY2FuJ3QgYmUgdXNlZCBhcyBhIHBhdHRlcm4gbmFtZSBpbiBwYXR0ZXJuICIgKyBhcmcpOwogICAgICB9CiAgICAgIGlmIChfX2luZGV4T2YuY2FsbChuYW1lcywgbmFtZSkgPj0gMCkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImR1cGxpY2F0ZSBwYXR0ZXJuIG5hbWUgOiIgKyBuYW1lICsgIiBpbiBwYXR0ZXJuICIgKyBhcmcpOwogICAgICB9CiAgICAgIG5hbWVzLnB1c2gobmFtZSB8fCAnXycpOwogICAgICByZXN1bHRzID0gcmVnZXguZXhlYyhhcmcpOwogICAgfQogICAgcmV0dXJuIG5hbWVzOwogIH0sCiAgZXNjYXBlU2VwYXJhdG9yczogZnVuY3Rpb24oc3RyaW5nLCBzZXBhcmF0b3IpIHsKICAgIHZhciBlc2NhcGVkU2VwYXJhdG9yLCByZWdleDsKICAgIGlmIChzZXBhcmF0b3IgPT0gbnVsbCkgewogICAgICBzZXBhcmF0b3IgPSAnLyc7CiAgICB9CiAgICBlc2NhcGVkU2VwYXJhdG9yID0gbW9kdWxlLmV4cG9ydHMuZXNjYXBlRm9yUmVnZXgoc2VwYXJhdG9yKTsKICAgIHJlZ2V4ID0gbmV3IFJlZ0V4cChlc2NhcGVkU2VwYXJhdG9yLCAnZycpOwogICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKHJlZ2V4LCBlc2NhcGVkU2VwYXJhdG9yKTsKICB9LAogIHRvUmVnZXhTdHJpbmc6IGZ1bmN0aW9uKHN0cmluZywgc2VwYXJhdG9yKSB7CiAgICB2YXIgZXNjYXBlZFNlcGFyYXRvciwgc3RyaW5nV2l0aEVzY2FwZWRTZXBhcmF0b3JzOwogICAgaWYgKHNlcGFyYXRvciA9PSBudWxsKSB7CiAgICAgIHNlcGFyYXRvciA9ICcvJzsKICAgIH0KICAgIHN0cmluZ1dpdGhFc2NhcGVkU2VwYXJhdG9ycyA9IG1vZHVsZS5leHBvcnRzLmVzY2FwZVNlcGFyYXRvcnMoc3RyaW5nLCBzZXBhcmF0b3IpOwogICAgc3RyaW5nV2l0aEVzY2FwZWRTZXBhcmF0b3JzID0gc3RyaW5nV2l0aEVzY2FwZWRTZXBhcmF0b3JzLnJlcGxhY2UoL1woKC4qPylcKS9nLCAnKD86JDEpPycpLnJlcGxhY2UoL1wqL2csICcoLio/KScpOwogICAgZXNjYXBlZFNlcGFyYXRvciA9IG1vZHVsZS5leHBvcnRzLmVzY2FwZUZvclJlZ2V4KHNlcGFyYXRvcik7CiAgICBtb2R1bGUuZXhwb3J0cy5nZXROYW1lcyhzdHJpbmcsIHNlcGFyYXRvcikuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgIHJldHVybiBzdHJpbmdXaXRoRXNjYXBlZFNlcGFyYXRvcnMgPSBzdHJpbmdXaXRoRXNjYXBlZFNlcGFyYXRvcnMucmVwbGFjZSgnOicgKyBuYW1lLCAiKFteXFwiICsgc2VwYXJhdG9yICsgIl0rKSIpOwogICAgfSk7CiAgICByZXR1cm4gIl4iICsgc3RyaW5nV2l0aEVzY2FwZWRTZXBhcmF0b3JzICsgIiQiOwogIH0KfTsKCn0se31dLDM6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKOyhmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgIGRlZmluZShbJ3JlYWN0JywgJ2JsdWViaXJkJ10sIGZhY3RvcnkpOwogIH0gZWxzZSB7CiAgICByb290LlJSb3V0ZXIgPSBmYWN0b3J5KHJvb3QuUmVhY3QsIHJvb3QuUHJvbWlzZSk7CiAgfQp9KSh3aW5kb3csIGZ1bmN0aW9uKFJlYWN0LCBQcm9taXNlKSB7CiAgcmV0dXJuIF9fYnJvd3NlcmlmeV9fKCcuL2xpYi8nKTsKfSk7Cgp9LHsiLi9saWIvIjoxNH1dLDQ6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEBqc3ggUmVhY3QuRE9NCiAqLwondXNlIHN0cmljdCc7Cgp2YXIgUmVhY3QgICAgID0gKHdpbmRvdy5SZWFjdCk7CnZhciBMaW5rTWl4aW4gPSBfX2Jyb3dzZXJpZnlfXygnLi9MaW5rTWl4aW4nKTsKCnZhciBMaW5rID0gUmVhY3QuY3JlYXRlQ2xhc3Moe2Rpc3BsYXlOYW1lOiAnTGluaycsCiAgbWl4aW5zOiBbTGlua01peGluXSwKCiAgb25DbGljazogZnVuY3Rpb24oZSkgewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgdGhpcy5hY3RpdmF0ZSgpOwogIH0sCgogIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy50cmFuc2ZlclByb3BzVG8oCiAgICAgIFJlYWN0LkRPTS5hKCB7aHJlZjp0aGlzLmhyZWYoKSwgb25DbGljazp0aGlzLm9uQ2xpY2t9LCAKICAgICAgICB0aGlzLnByb3BzLmNoaWxkcmVuCiAgICAgICkKICAgICk7CiAgfQp9KTsKCm1vZHVsZS5leHBvcnRzID0gTGluazsKCn0seyIuL0xpbmtNaXhpbiI6NX1dLDU6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEBqc3ggUmVhY3QuRE9NCiAqLwondXNlIHN0cmljdCc7Cgp2YXIgUmVhY3QgICAgICAgICAgICAgICA9ICh3aW5kb3cuUmVhY3QpOwp2YXIgaW52YXJpYW50ICAgICAgICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuL2ludmFyaWFudCcpOwp2YXIgUm91dGluZ0NvbnRleHRNaXhpbiA9IF9fYnJvd3NlcmlmeV9fKCcuL1JvdXRpbmdDb250ZXh0TWl4aW4nKTsKCnZhciBMaW5rTWl4aW4gPSB7CiAgbWl4aW5zOiBbUm91dGluZ0NvbnRleHRNaXhpbl0sCgogIHByb3BUeXBlczogewogICAgdG86IFJlYWN0LlByb3BUeXBlcy5zdHJpbmcsCiAgICBocmVmOiBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nLAogICAgcXVlcnk6IFJlYWN0LlByb3BUeXBlcy5vYmplY3QKICB9LAoKICBhY3RpdmF0ZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgcm91dGluZyA9IHRoaXMuZ2V0Um91dGluZygpOwogICAgaWYgKHRoaXMucHJvcHMuaHJlZikgewogICAgICByb3V0aW5nLm5hdmlnYXRlKHRoaXMucHJvcHMuaHJlZiwgdGhpcy5wcm9wcy5uYXZpZ2F0aW9uKTsKICAgIH0gZWxzZSBpZiAodGhpcy5wcm9wcy50bykgewogICAgICByb3V0aW5nLm5hdmlnYXRlVG8odGhpcy5wcm9wcy50bywgdGhpcy5wcm9wcywgdGhpcy5wcm9wcy5uYXZpZ2F0aW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIGludmFyaWFudCgKICAgICAgICBmYWxzZSwKICAgICAgICAncHJvdmlkZSBlaXRoZXIgInRvIiBvciAiaHJlZiIgcHJvcCB0byBMaW5rIGNvbXBvbmVudCcKICAgICAgKTsKICAgIH0KICB9LAoKICBocmVmOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLnByb3BzLmhyZWYpIHsKICAgICAgcmV0dXJuIHRoaXMucHJvcHMuaHJlZjsKICAgIH0gZWxzZSBpZiAodGhpcy5wcm9wcy50bykgewogICAgICByZXR1cm4gdGhpcy5nZXRSb3V0aW5nKCkubWFrZUhyZWYodGhpcy5wcm9wcy50bywgdGhpcy5wcm9wcyk7CiAgICB9IGVsc2UgewogICAgICBpbnZhcmlhbnQoCiAgICAgICAgZmFsc2UsCiAgICAgICAgJ3Byb3ZpZGUgZWl0aGVyICJ0byIgb3IgImhyZWYiIHByb3AgdG8gTGluayBjb21wb25lbnQnCiAgICAgICk7CiAgICB9CiAgfQp9OwoKbW9kdWxlLmV4cG9ydHMgPSBMaW5rTWl4aW47Cgp9LHsiLi9Sb3V0aW5nQ29udGV4dE1peGluIjo2LCIuL2ludmFyaWFudCI6MTV9XSw2OltmdW5jdGlvbihfX2Jyb3dzZXJpZnlfXyxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBAanN4IFJlYWN0LkRPTQogKi8KJ3VzZSBzdHJpY3QnOwoKdmFyIFJlYWN0ICAgICA9ICh3aW5kb3cuUmVhY3QpOwp2YXIgaW52YXJpYW50ID0gX19icm93c2VyaWZ5X18oJy4vaW52YXJpYW50Jyk7Cgp2YXIgY29udGV4dFR5cGVzID0gewogIHJvdXRpbmc6IFJlYWN0LlByb3BUeXBlcy5vYmplY3QsCiAgcm91dGVzOiBSZWFjdC5Qcm9wVHlwZXMub2JqZWN0LAogIG1hdGNoOiBSZWFjdC5Qcm9wVHlwZXMub2JqZWN0Cn07Cgp2YXIgUm91dGluZ0NvbnRleHRNaXhpbiA9IHsKICBjb250ZXh0VHlwZXM6IGNvbnRleHRUeXBlcywKCiAgbmF2aWdhdGU6IGZ1bmN0aW9uKHBhdGgsIG5hdmlnYXRpb24pIHsKICAgIGludmFyaWFudCgKICAgICAgdGhpcy5jb250ZXh0LnJvdXRpbmcsCiAgICAgICdubyByb3V0aW5nIGZvdW5kIGluIGNvbnRleHQnCiAgICApOwogICAgdGhpcy5jb250ZXh0LnJvdXRpbmcubmF2aWdhdGUocGF0aCwgbmF2aWdhdGlvbik7CiAgfSwKCiAgbmF2aWdhdGVUbzogZnVuY3Rpb24ocm91dGVSZWYsIHByb3BzLCBuYXZpZ2F0aW9uKSB7CiAgICBpbnZhcmlhbnQoCiAgICAgIHRoaXMuY29udGV4dC5yb3V0aW5nLAogICAgICAnbm8gcm91dGluZyBmb3VuZCBpbiBjb250ZXh0JwogICAgKTsKICAgIHRoaXMuY29udGV4dC5yb3V0aW5nLm5hdmlnYXRlVG8ocm91dGVSZWYsIHByb3BzLCBuYXZpZ2F0aW9uKTsKICB9LAoKICBnZXRNYXRjaDogZnVuY3Rpb24oKSB7CiAgICBpbnZhcmlhbnQoCiAgICAgIHRoaXMuY29udGV4dC5tYXRjaCwKICAgICAgJ25vIG1hdGNoIGZvdW5kIGluIGNvbnRleHQnCiAgICApOwogICAgcmV0dXJuIHRoaXMuY29udGV4dC5tYXRjaDsKICB9LAoKICBnZXRSb3V0ZXM6IGZ1bmN0aW9uKCkgewogICAgaW52YXJpYW50KAogICAgICB0aGlzLmNvbnRleHQucm91dGVzLAogICAgICAnbm8gcm91dGVzIGZvdW5kIGluIGNvbnRleHQnCiAgICApOwogICAgcmV0dXJuIHRoaXMuY29udGV4dC5yb3V0ZXM7CiAgfSwKCiAgZ2V0Um91dGluZzogZnVuY3Rpb24oKSB7CiAgICBpbnZhcmlhbnQoCiAgICAgIHRoaXMuY29udGV4dC5yb3V0aW5nLAogICAgICAnbm8gcm91dGluZyBmb3VuZCBpbiBjb250ZXh0JwogICAgKTsKICAgIHJldHVybiB0aGlzLmNvbnRleHQucm91dGluZzsKICB9Cn07Cgptb2R1bGUuZXhwb3J0cyA9IFJvdXRpbmdDb250ZXh0TWl4aW47Cgp9LHsiLi9pbnZhcmlhbnQiOjE1fV0sNzpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQ29weXJpZ2h0IDIwMTMtMjAxNCBGYWNlYm9vaywgSW5jLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIEBwcm92aWRlc01vZHVsZSBjb3B5UHJvcGVydGllcwogKi8KJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIENvcHkgcHJvcGVydGllcyBmcm9tIG9uZSBvciBtb3JlIG9iamVjdHMgKHVwIHRvIDUpIGludG8gdGhlIGZpcnN0IG9iamVjdC4KICogVGhpcyBpcyBhIHNoYWxsb3cgY29weS4gSXQgbXV0YXRlcyB0aGUgZmlyc3Qgb2JqZWN0IGFuZCBhbHNvIHJldHVybnMgaXQuCiAqCiAqIE5PVEU6IGBhcmd1bWVudHNgIGhhcyBhIHZlcnkgc2lnbmlmaWNhbnQgcGVyZm9ybWFuY2UgcGVuYWx0eSwgd2hpY2ggaXMgd2h5CiAqIHdlIGRvbid0IHN1cHBvcnQgdW5saW1pdGVkIGFyZ3VtZW50cy4KICovCmZ1bmN0aW9uIGNvcHlQcm9wZXJ0aWVzKG9iaiwgYSwgYiwgYywgZCwgZSwgZikgewogIG9iaiA9IG9iaiB8fCB7fTsKCiAgaWYgKCJkZXZlbG9wbWVudCIgIT09ICdwcm9kdWN0aW9uJykgewogICAgaWYgKGYpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdUb28gbWFueSBhcmd1bWVudHMgcGFzc2VkIHRvIGNvcHlQcm9wZXJ0aWVzJyk7CiAgICB9CiAgfQoKICB2YXIgYXJncyA9IFthLCBiLCBjLCBkLCBlXTsKICB2YXIgaWkgPSAwLCB2OwogIHdoaWxlIChhcmdzW2lpXSkgewogICAgdiA9IGFyZ3NbaWkrK107CiAgICBmb3IgKHZhciBrIGluIHYpIHsKICAgICAgb2JqW2tdID0gdltrXTsKICAgIH0KCiAgICAvLyBJRSBpZ25vcmVzIHRvU3RyaW5nIGluIG9iamVjdCBpdGVyYXRpb24uLiBTZWU6CiAgICAvLyB3ZWJyZWZsZWN0aW9uLmJsb2dzcG90LmNvbS8yMDA3LzA3L3F1aWNrLWZpeC1pbnRlcm5ldC1leHBsb3Jlci1hbmQuaHRtbAogICAgaWYgKHYuaGFzT3duUHJvcGVydHkgJiYgdi5oYXNPd25Qcm9wZXJ0eSgndG9TdHJpbmcnKSAmJgogICAgICAgICh0eXBlb2Ygdi50b1N0cmluZyAhPT0gJ3VuZGVmaW5lZCcpICYmIChvYmoudG9TdHJpbmcgIT09IHYudG9TdHJpbmcpKSB7CiAgICAgIG9iai50b1N0cmluZyA9IHYudG9TdHJpbmc7CiAgICB9CiAgfQoKICByZXR1cm4gb2JqOwp9Cgptb2R1bGUuZXhwb3J0cyA9IGNvcHlQcm9wZXJ0aWVzOwoKfSx7fV0sODpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQGpzeCBSZWFjdC5ET00KICovCid1c2Ugc3RyaWN0JzsKCnZhciBpbnZhcmlhbnQgICAgPSBfX2Jyb3dzZXJpZnlfXygnLi9pbnZhcmlhbnQnKTsKdmFyIG1lcmdlICAgICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuL21lcmdlJyk7CnZhciBnZXRTdGVwUHJvcHMgPSBfX2Jyb3dzZXJpZnlfXygnLi9nZXRTdGVwUHJvcHMnKTsKCnZhciBpc1ZpZXdQcm9wUmUgPSAvKFthLXpBLVowLTldKylWaWV3JC87CgpmdW5jdGlvbiBnZXRWaWV3UHJvcHMoYWxsUHJvcHMpIHsKICB2YXIgdmlld3MgPSB7fTsKICB2YXIgcHJvcHMgPSB7fTsKCiAgZm9yICh2YXIgbmFtZSBpbiBhbGxQcm9wcykgewogICAgdmFyIG0gPSBpc1ZpZXdQcm9wUmUuZXhlYyhuYW1lKTsKICAgIGlmIChtKSB7CiAgICAgIHZhciBwcm9wID0gbVsxXTsKCiAgICAgIGludmFyaWFudCgKICAgICAgICAhYWxsUHJvcHMuaGFzT3duUHJvcGVydHkocHJvcCksCiAgICAgICAgJ3ZpZXcgcHJvcGVydHkgIicgKyBuYW1lICsgJyIgd291bGQgb3ZlcndyaXRlIHJlZ3VsYXIgcHJvcGVydHkgIicgKyBwcm9wICsgJyInCiAgICAgICk7CgogICAgICB2aWV3c1twcm9wXSA9IGFsbFByb3BzW25hbWVdOwogICAgfSBlbHNlIHsKICAgICAgcHJvcHNbbmFtZV0gPSBhbGxQcm9wc1tuYW1lXTsKICAgIH0KICB9CgogIHJldHVybiB7dmlld3M6dmlld3MsIHByb3BzOnByb3BzfTsKfQoKZnVuY3Rpb24gbWFrZVZpZXdGYWN0b3J5KHZpZXdDbGFzcywgdmlld1Byb3BzKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIHZpZXdGYWN0b3J5KHByb3BzKSB7CiAgICBwcm9wcyA9IHByb3BzICE9PSBudWxsICYmIHByb3BzICE9PSB1bmRlZmluZWQgPwogICAgICBtZXJnZSh2aWV3UHJvcHMsIHByb3BzKSA6CiAgICAgIHZpZXdQcm9wczsKICAgIHJldHVybiB2aWV3Q2xhc3MocHJvcHMpOwogIH07Cn0KCmZ1bmN0aW9uIGNvbGxlY3RTdWJWaWV3cyhwcm9wcywgc3ViVmlld3MpIHsKICB2YXIgciA9IGdldFZpZXdQcm9wcyhwcm9wcyk7CiAgdmFyIHZpZXdzID0ge307CgogIGZvciAodmFyIG5hbWUgaW4gci52aWV3cykgewogICAgdmlld3NbbmFtZV0gPSBtYWtlVmlld0ZhY3Rvcnkoci52aWV3c1tuYW1lXSwgbWVyZ2Uoci5wcm9wcywgc3ViVmlld3MpKTsKICB9CgogIHJldHVybiB2aWV3czsKfQoKLyoqCiAqIENyZWF0ZSBhIHZpZXcgZm9yIHdoaWNoIG1hdGNoZXMgZm9yIGEgcGF0aCB3aXRoIHRoZSBwcm92aWRlZCByb3V0ZXMKICoKICogQHBhcmFtIHtSb3V0ZX0gcm91dGVzCiAqIEByZXR1cm5zIHtQcm9taXNlPFJlYWN0Q29tcG9uZW50Pn0KICovCmZ1bmN0aW9uIGNyZWF0ZVZpZXcobWF0Y2gpIHsKICB2YXIgdmlld3MgPSB7fTsKCiAgZm9yICh2YXIgaSA9IG1hdGNoLmFjdGl2ZVRyYWNlLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICB2YXIgc3RlcCA9IG1hdGNoLmFjdGl2ZVRyYWNlW2ldOwogICAgdmFyIHN0ZXBQcm9wcyA9IGdldFN0ZXBQcm9wcyhzdGVwKTsKCiAgICB2aWV3cyA9IG1lcmdlKHZpZXdzLCBjb2xsZWN0U3ViVmlld3Moc3RlcFByb3BzLCB2aWV3cykpOwoKICAgIGlmIChzdGVwLnJvdXRlLnZpZXcgIT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gc3RlcC5yb3V0ZS52aWV3KG1lcmdlKHN0ZXBQcm9wcywgdmlld3MpKTsKICAgIH0KICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY3JlYXRlVmlldzsKbW9kdWxlLmV4cG9ydHMuZ2V0Vmlld1Byb3BzID0gZ2V0Vmlld1Byb3BzOwoKfSx7Ii4vZ2V0U3RlcFByb3BzIjoxMywiLi9pbnZhcmlhbnQiOjE1LCIuL21lcmdlIjoyMH1dLDk6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEBqc3ggUmVhY3QuRE9NCiAqLwondXNlIHN0cmljdCc7Cgp2YXIgUHJvbWlzZSAgICAgICA9ICh3aW5kb3cuUHJvbWlzZSk7CnZhciBtZXJnZSAgICAgICAgID0gX19icm93c2VyaWZ5X18oJy4vbWVyZ2UnKTsKdmFyIGVtcHR5RnVuY3Rpb24gPSBfX2Jyb3dzZXJpZnlfXygnLi9lbXB0eUZ1bmN0aW9uJyk7CnZhciBnZXRTdGVwUHJvcHMgID0gX19icm93c2VyaWZ5X18oJy4vZ2V0U3RlcFByb3BzJyk7CgovKioKICogTWFrZSB0YXNrCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lCiAqIEBwYXJhbSB7RnVuY3Rpb259IGZldGNoCiAqIEByZXR1cm5zIHtGdW5jdGlvbn0KICovCmZ1bmN0aW9uIG1ha2VUYXNrKGZldGNoLCBkZWZlcnJlZCkgewogIHJldHVybiBmdW5jdGlvbiBzdGFydChwcm9wcywgcHJvbWlzZXMpIHsKICAgIHZhciBwcm9taXNlID0gZmV0Y2gocHJvcHMsIHByb21pc2VzKTsKCiAgICBpZiAocHJvbWlzZS5pc0Z1bGZpbGxlZCgpKSB7CiAgICAgIGRlZmVycmVkLnJlc29sdmUocHJvbWlzZS52YWx1ZSgpKTsKICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gcHJvbWlzZS50aGVuKAogICAgICAgIGZ1bmN0aW9uKHJlc3VsdCkgIHsKICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzdWx0KTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKICAgICAgICBmdW5jdGlvbihlcnIpICB7CiAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZXJyKTsKICAgICAgICAgIHRocm93IGVycjsKICAgICAgICB9CiAgICAgICk7CiAgICB9CiAgfTsKfQoKdmFyIGlzUHJvbWlzZVByb3BSZSA9IC8oW2EtekEtWjAtOV0rKVByb21pc2UkLzsKCi8qKgogKiBGZXRjaCBhbGwgcHJvbWlzZXMgZGVmaW5lZCBpbiBwcm9wcwogKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHJldHVybnMge1Byb21pc2U8T2JqZWN0Pn0KICovCmZ1bmN0aW9uIGZldGNoUHJvcHMocHJvcHMpIHsKICB2YXIgbmV3UHJvcHMgPSB7fTsKCiAgdmFyIGRlZmVycmVkcyA9IHt9OwogIHZhciBwcm9taXNlcyA9IHt9OwogIHZhciB0YXNrcyA9IHt9OwoKICB2YXIgbmFtZTsKCiAgZm9yIChuYW1lIGluIHByb3BzKSB7CiAgICB2YXIgbSA9IGlzUHJvbWlzZVByb3BSZS5leGVjKG5hbWUpOwogICAgaWYgKG0pIHsKICAgICAgdmFyIHByb21pc2VOYW1lID0gbVsxXTsKICAgICAgdmFyIGRlZmVycmVkID0gUHJvbWlzZS5kZWZlcigpOwogICAgICB0YXNrc1twcm9taXNlTmFtZV0gPSBtYWtlVGFzayhwcm9wc1tuYW1lXSwgZGVmZXJyZWQpOwogICAgICBkZWZlcnJlZHNbcHJvbWlzZU5hbWVdID0gZGVmZXJyZWQucHJvbWlzZTsKICAgIH0gZWxzZSB7CiAgICAgIG5ld1Byb3BzW25hbWVdID0gcHJvcHNbbmFtZV07CiAgICB9CiAgfQoKICAvLyBub3QgKlByb21pc2UgcHJvcHMsIHNob3J0Y2lyY3VpdCEKICBpZiAoT2JqZWN0LmtleXMoZGVmZXJyZWRzKS5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocHJvcHMpOwogIH0KCiAgdmFyIGlzRnVsZmlsbGVkID0gdHJ1ZTsKCiAgZm9yIChuYW1lIGluIHRhc2tzKSB7CiAgICB2YXIgcHJvbWlzZSA9IHRhc2tzW25hbWVdKG5ld1Byb3BzLCBkZWZlcnJlZHMpOwogICAgaXNGdWxmaWxsZWQgPSBpc0Z1bGZpbGxlZCAmJiBwcm9taXNlLmlzRnVsZmlsbGVkKCk7CiAgICBwcm9taXNlc1tuYW1lXSA9IHByb21pc2UuaXNGdWxmaWxsZWQoKSA/IHByb21pc2UudmFsdWUoKSA6IHByb21pc2U7CiAgfQoKICAvLyBldmVyeSBwcm9taXNlIGlzIHJlc29sdmVkIChwcm9iYWJseSBmcm9tIHNvbWUgREIgY2FjaGU/KSwgc2hvcnRjaXJjdWl0IQogIGlmIChpc0Z1bGZpbGxlZCkgewogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShtZXJnZShuZXdQcm9wcywgcHJvbWlzZXMpKTsKICB9CgogIHJldHVybiBQcm9taXNlLnByb3BzKHByb21pc2VzKQogICAgLnRoZW4oZnVuY3Rpb24ocHJvcHMpICB7cmV0dXJuIG1lcmdlKG5ld1Byb3BzLCBwcm9wcyk7fSkKICAgIC5maW5hbGx5KGZ1bmN0aW9uKCkgIHsKICAgICAgZm9yICh2YXIgbmFtZSBpbiBkZWZlcnJlZHMpIHsKICAgICAgICBkZWZlcnJlZHNbbmFtZV0uY2F0Y2goZW1wdHlGdW5jdGlvbik7CiAgICAgIH0KICAgIH0pOwp9CgpmdW5jdGlvbiBmZXRjaFN0ZXAoc3RlcCkgewogIHZhciBwcm9wcyA9IGZldGNoUHJvcHMoZ2V0U3RlcFByb3BzKHN0ZXApKTsKICAvLyBzdGVwIGlzIHJlc29sdmVkLCBzaG9ydGNpcmN1aXQhCiAgaWYgKHByb3BzLmlzRnVsZmlsbGVkKCkpIHsKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoCiAgICAgIG1lcmdlKHN0ZXAsIHtwcm9wczogbWVyZ2Uoc3RlcC5wcm9wcywgcHJvcHMudmFsdWUoKSl9KSk7CiAgfSBlbHNlIHsKICAgIHJldHVybiBQcm9taXNlLnByb3BzKHByb3BzKS50aGVuKGZ1bmN0aW9uKHByb3BzKSAKICAgICAge3JldHVybiBtZXJnZShzdGVwLCB7cHJvcHM6IG1lcmdlKHN0ZXAucHJvcHMsIHByb3BzKX0pO30pOwogIH0KfQoKZnVuY3Rpb24gZmV0Y2hQcm9ncmVzc2l2ZWx5KG1hdGNoLCBvblByb2dyZXNzLCBvbkVycm9yKSB7CiAgdmFyIGFjdGl2ZVRyYWNlID0gbWF0Y2guYWN0aXZlVHJhY2U7CiAgdmFyIGxhdGNoID0gYWN0aXZlVHJhY2UubGVuZ3RoOwoKICBhY3RpdmVUcmFjZS5mb3JFYWNoKGZ1bmN0aW9uKHN0ZXAsIGlkeCkgIHsKICAgIHZhciBwcm9taXNlID0gZmV0Y2hTdGVwKHN0ZXApOwoKICAgIGlmIChwcm9taXNlLmlzRnVsZmlsbGVkKCkpIHsKICAgICAgbGF0Y2ggPSBsYXRjaCAtIDE7CiAgICAgIGFjdGl2ZVRyYWNlID0gYWN0aXZlVHJhY2Uuc2xpY2UoMCk7CiAgICAgIGFjdGl2ZVRyYWNlW2lkeF0gPSBwcm9taXNlLnZhbHVlKCk7CiAgICB9IGVsc2UgewogICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oc3RlcCkgIHsKICAgICAgICBhY3RpdmVUcmFjZSA9IGFjdGl2ZVRyYWNlLnNsaWNlKDApOwogICAgICAgIGFjdGl2ZVRyYWNlW2lkeF0gPSBzdGVwOwogICAgICAgIG9uUHJvZ3Jlc3MobWVyZ2UobWF0Y2gsIHthY3RpdmVUcmFjZTphY3RpdmVUcmFjZX0pKTsKICAgICAgfSkuY2F0Y2gob25FcnJvcik7CiAgICB9CiAgfSk7CgogIHJldHVybiBtZXJnZShtYXRjaCwge2FjdGl2ZVRyYWNlOmFjdGl2ZVRyYWNlfSk7Cn0KCmZ1bmN0aW9uIGZldGNoKG1hdGNoKSB7CiAgcmV0dXJuIFByb21pc2UuYWxsKG1hdGNoLmFjdGl2ZVRyYWNlLm1hcChmZXRjaFN0ZXApKQogICAgLnRoZW4oZnVuY3Rpb24oYWN0aXZlVHJhY2UpICB7cmV0dXJuIG1lcmdlKG1hdGNoLCB7YWN0aXZlVHJhY2U6YWN0aXZlVHJhY2V9KTt9KTsKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgZmV0Y2g6ZmV0Y2gsCiAgZmV0Y2hQcm9ncmVzc2l2ZWx5OmZldGNoUHJvZ3Jlc3NpdmVseSwKICBmZXRjaFByb3BzOmZldGNoUHJvcHMKfTsKCn0seyIuL2VtcHR5RnVuY3Rpb24iOjExLCIuL2dldFN0ZXBQcm9wcyI6MTMsIi4vbWVyZ2UiOjIwfV0sMTA6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEBqc3ggUmVhY3QuRE9NCiAqLwondXNlIHN0cmljdCc7Cgp2YXIgbWVyZ2UgPSBfX2Jyb3dzZXJpZnlfXygnLi9tZXJnZScpOwoKdmFyIHNsYXNoZXMgPSAvKF5cLyl8KFwvJCkvZzsKCi8qKgogKiBSb3V0ZSBkZXNyaXB0b3IgY29uc3RydWN0b3IKICoKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7T2JqZWN0Li4ufSBjaGlsZHJlbgogKiBAcmV0dXJucyB7Um91dGV9CiAqLwpmdW5jdGlvbiBSb3V0ZShwcm9wcykgewogIHByb3BzID0gcHJvcHMgfHwge307CgogIHZhciBwYXRoID0gcHJvcHMucGF0aCA/CiAgICBwcm9wcy5wYXRoLnJlcGxhY2Uoc2xhc2hlcywgJycpIDoKICAgIHVuZGVmaW5lZDsKCiAgZGVsZXRlIHByb3BzLnBhdGg7CgogIHZhciB2aWV3ID0gcHJvcHMudmlldzsKICBkZWxldGUgcHJvcHMudmlldzsKCiAgdmFyIHZpZXdQcm9taXNlID0gcHJvcHMudmlld1Byb21pc2U7CiAgZGVsZXRlIHByb3BzLnZpZXdQcm9taXNlOwoKICB2YXIgbmFtZSA9IHByb3BzLm5hbWU7CiAgZGVsZXRlIHByb3BzLm5hbWU7CgogIHZhciBfX3Njb3BlID0gcHJvcHMuX19zY29wZTsKICBkZWxldGUgcHJvcHMuX19zY29wZTsKCiAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoKICB2YXIgY2hpbGRyZW4gPSBbXTsKCiAgLy8gc28gd2Ugc3VwcG9ydCBwYXNzaW5nIHJvdXRlcyBhcyBhcmd1bWVudHMgYW5kIGFycmF5cwogIGZvciAodmFyIGkgPSAwLCBsZW4gPSBhcmdzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShhcmdzW2ldKSkgewogICAgICBjaGlsZHJlbiA9IGNoaWxkcmVuLmNvbmNhdChhcmdzW2ldKTsKICAgIH0gZWxzZSB7CiAgICAgIGNoaWxkcmVuLnB1c2goYXJnc1tpXSk7CiAgICB9CiAgfQoKICB2YXIgcm91dGUgPSB7cGF0aDpwYXRoLCBuYW1lOm5hbWUsIHZpZXc6dmlldywgdmlld1Byb21pc2U6dmlld1Byb21pc2UsIHByb3BzOnByb3BzLCBjaGlsZHJlbjpjaGlsZHJlbiwgX19zY29wZTpfX3Njb3BlfTsKICBidWlsZE5hbWVJbmRleChyb3V0ZSk7CiAgcmV0dXJuIHJvdXRlOwp9CgpmdW5jdGlvbiBSb3V0ZXMocHJvcHMpIHsKICBwcm9wcyA9IG1lcmdlKHByb3BzLCB7X19zY29wZTogdHJ1ZX0pOwogIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICBhcmdzLnVuc2hpZnQocHJvcHMpOwogIHJldHVybiBSb3V0ZS5hcHBseShudWxsLCBhcmdzKTsKfQoKZnVuY3Rpb24gYnVpbGROYW1lSW5kZXgocm91dGUpIHsKICBpZiAocm91dGUuX19uYW1lSW5kZXggIT09IHVuZGVmaW5lZCkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGluZGV4ID0ge307CiAgdmFyIHByZWZpeCA9IHJvdXRlLm5hbWUgPyByb3V0ZS5uYW1lICsgJy8nIDogJyc7CgogIGlmIChyb3V0ZS5jaGlsZHJlbiAmJiByb3V0ZS5jaGlsZHJlbi5sZW5ndGggPiAwKSB7CiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gcm91dGUuY2hpbGRyZW4ubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgdmFyIHIgPSByb3V0ZS5jaGlsZHJlbltpXTsKICAgICAgYnVpbGROYW1lSW5kZXgocik7CiAgICAgIGZvciAodmFyIG5hbWUgaW4gci5fX25hbWVJbmRleCkgewogICAgICAgIGluZGV4W3ByZWZpeCArIG5hbWVdID0gW3JvdXRlXS5jb25jYXQoci5fX25hbWVJbmRleFtuYW1lXSk7CiAgICAgIH0KICAgIH0KICB9CiAgCiAgaWYgKHJvdXRlLm5hbWUgIT09IHVuZGVmaW5lZCkgewogICAgaW5kZXhbcm91dGUubmFtZV0gPSBbcm91dGVdOwogIH0KCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHJvdXRlLCAnX19uYW1lSW5kZXgnLCB7CiAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgIHZhbHVlOiBpbmRleAogIH0pOwp9CgpmdW5jdGlvbiBnZXRUcmFjZUJ5TmFtZShyb3V0ZSwgbmFtZSkgewogIHJldHVybiByb3V0ZS5fX25hbWVJbmRleFtuYW1lXTsKfQoKZnVuY3Rpb24gaGFzVmlldyhyb3V0ZSkgewogIHJldHVybiByb3V0ZS52aWV3ICE9PSB1bmRlZmluZWQgfHwgcm91dGUudmlld1Byb21pc2UgIT09IHVuZGVmaW5lZDsKfQoKZnVuY3Rpb24gaXNSb3V0ZXMocm91dGVzKSB7CiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhyb3V0ZXMpOwogIHJldHVybiAoCiAgICBrZXlzLmluZGV4T2YoJ3BhdGgnKSA+IC0xCiAgICAmJiBrZXlzLmluZGV4T2YoJ3ZpZXcnKSA+IC0xCiAgICAmJiBrZXlzLmluZGV4T2YoJ3Byb3BzJykgPiAtMQogICAgJiYga2V5cy5pbmRleE9mKCdjaGlsZHJlbicpID4gLTEKICApOwp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBSb3V0ZTpSb3V0ZSwKICBSb3V0ZXM6Um91dGVzLAogIGlzUm91dGVzOmlzUm91dGVzLAogIGdldFRyYWNlQnlOYW1lOmdldFRyYWNlQnlOYW1lLAogIGhhc1ZpZXc6aGFzVmlldwp9OwoKfSx7Ii4vbWVyZ2UiOjIwfV0sMTE6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENvcHlyaWdodCAyMDEzLTIwMTQgRmFjZWJvb2ssIEluYy4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqCiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAogKgogKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBAcHJvdmlkZXNNb2R1bGUgZW1wdHlGdW5jdGlvbgogKi8KJ3VzZSBzdHJpY3QnOwoKdmFyIGNvcHlQcm9wZXJ0aWVzID0gX19icm93c2VyaWZ5X18oJy4vY29weVByb3BlcnRpZXMnKTsKCmZ1bmN0aW9uIG1ha2VFbXB0eUZ1bmN0aW9uKGFyZykgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBhcmc7CiAgfTsKfQoKLyoqCiAqIFRoaXMgZnVuY3Rpb24gYWNjZXB0cyBhbmQgZGlzY2FyZHMgaW5wdXRzOyBpdCBoYXMgbm8gc2lkZSBlZmZlY3RzLiBUaGlzIGlzCiAqIHByaW1hcmlseSB1c2VmdWwgaWRpb21hdGljYWxseSBmb3Igb3ZlcnJpZGFibGUgZnVuY3Rpb24gZW5kcG9pbnRzIHdoaWNoCiAqIGFsd2F5cyBuZWVkIHRvIGJlIGNhbGxhYmxlLCBzaW5jZSBKUyBsYWNrcyBhIG51bGwtY2FsbCBpZGlvbSBhbGEgQ29jb2EuCiAqLwpmdW5jdGlvbiBlbXB0eUZ1bmN0aW9uKCkge30KCmNvcHlQcm9wZXJ0aWVzKGVtcHR5RnVuY3Rpb24sIHsKICB0aGF0UmV0dXJuczogbWFrZUVtcHR5RnVuY3Rpb24sCiAgdGhhdFJldHVybnNGYWxzZTogbWFrZUVtcHR5RnVuY3Rpb24oZmFsc2UpLAogIHRoYXRSZXR1cm5zVHJ1ZTogbWFrZUVtcHR5RnVuY3Rpb24odHJ1ZSksCiAgdGhhdFJldHVybnNOdWxsOiBtYWtlRW1wdHlGdW5jdGlvbihudWxsKSwKICB0aGF0UmV0dXJuc1RoaXM6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpczsgfSwKICB0aGF0UmV0dXJuc0FyZ3VtZW50OiBmdW5jdGlvbihhcmcpIHsgcmV0dXJuIGFyZzsgfQp9KTsKCm1vZHVsZS5leHBvcnRzID0gZW1wdHlGdW5jdGlvbjsKCn0seyIuL2NvcHlQcm9wZXJ0aWVzIjo3fV0sMTI6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEBqc3ggUmVhY3QuRE9NCiAqLwondXNlIHN0cmljdCc7Cgp2YXIgbWVyZ2UgICA9IF9fYnJvd3NlcmlmeV9fKCcuL21lcmdlJyk7CnZhciBQcm9taXNlID0gKHdpbmRvdy5Qcm9taXNlKTsKCmZ1bmN0aW9uIGZldGNoVmlld3NTdGVwKHN0ZXApIHsKICB2YXIgcHJvcHMgPSBtZXJnZShzdGVwLm1hdGNoLCBzdGVwLnJvdXRlLnByb3BzKTsKICByZXR1cm4gc3RlcC5yb3V0ZS52aWV3UHJvbWlzZSA/CiAgICBzdGVwLnJvdXRlLnZpZXdQcm9taXNlKHByb3BzKS50aGVuKGZ1bmN0aW9uKHZpZXcpICB7cmV0dXJuIG1lcmdlKHN0ZXAsIHt2aWV3OnZpZXd9KTt9KSA6CiAgICBzdGVwOwp9CgovKioKICogRmV0Y2ggdmlld3MgZm9yIG1hdGNoCiAqCiAqIEBwYXJhbSB7TWF0Y2h9IG1hdGNoCiAqIEByZXR1cm5zIHtNYXRjaH0KICovCmZ1bmN0aW9uIGZldGNoVmlld3MobWF0Y2gpIHsKICB2YXIgYWN0aXZlVHJhY2UgPSBtYXRjaC5hY3RpdmVUcmFjZS5tYXAoZmV0Y2hWaWV3c1N0ZXApOwoKICByZXR1cm4gYWN0aXZlVHJhY2Uuc29tZShQcm9taXNlLmlzKSA/CiAgICBQcm9taXNlLmFsbChhY3RpdmVUcmFjZSkudGhlbihmdW5jdGlvbihhY3RpdmVUcmFjZSkgIHtyZXR1cm4gbWVyZ2UobWF0Y2gsIHthY3RpdmVUcmFjZTphY3RpdmVUcmFjZX0pO30pIDoKICAgIFByb21pc2UucmVzb2x2ZShtZXJnZShtYXRjaCwge2FjdGl2ZVRyYWNlOmFjdGl2ZVRyYWNlfSkpOwp9Cgptb2R1bGUuZXhwb3J0cyA9IGZldGNoVmlld3M7Cgp9LHsiLi9tZXJnZSI6MjB9XSwxMzpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQGpzeCBSZWFjdC5ET00KICovCid1c2Ugc3RyaWN0JzsKCnZhciBtZXJnZUludG8gPSBfX2Jyb3dzZXJpZnlfXygnLi9tZXJnZUludG8nKTsKCmZ1bmN0aW9uIGdldFN0ZXBQcm9wcyhzdGVwKSB7CiAgdmFyIHByb3BzID0ge307CiAgbWVyZ2VJbnRvKHByb3BzLCBzdGVwLm1hdGNoKTsKICBtZXJnZUludG8ocHJvcHMsIHN0ZXAucm91dGUucHJvcHMpOwogIG1lcmdlSW50byhwcm9wcywgc3RlcC5wcm9wcyk7CiAgcmV0dXJuIHByb3BzOwp9Cgptb2R1bGUuZXhwb3J0cyA9IGdldFN0ZXBQcm9wczsKCn0seyIuL21lcmdlSW50byI6MjJ9XSwxNDpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQGpzeCBSZWFjdC5ET00KICovCid1c2Ugc3RyaWN0JzsKCnZhciBtYXRjaFJvdXRlcyAgICAgICAgID0gX19icm93c2VyaWZ5X18oJy4vbWF0Y2hSb3V0ZXMnKTsKdmFyIGRhdGEgICAgICAgICAgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygnLi9kYXRhJyk7CnZhciByb3V0ZSAgICAgICAgICAgICAgID0gX19icm93c2VyaWZ5X18oJy4vcm91dGUnKTsKdmFyIGNyZWF0ZVZpZXcgICAgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygnLi9jcmVhdGVWaWV3Jyk7CnZhciBmZXRjaFZpZXdzICAgICAgICAgID0gX19icm93c2VyaWZ5X18oJy4vZmV0Y2hWaWV3cycpOwp2YXIgUGF0aG5hbWVSb3V0aW5nICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuL3JvdXRpbmcvUGF0aG5hbWVSb3V0aW5nJyk7CnZhciBIYXNoUm91dGluZyAgICAgICAgID0gX19icm93c2VyaWZ5X18oJy4vcm91dGluZy9IYXNoUm91dGluZycpOwp2YXIgTGluayAgICAgICAgICAgICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuL0xpbmsnKTsKdmFyIExpbmtNaXhpbiAgICAgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygnLi9MaW5rTWl4aW4nKTsKdmFyIGRlc2NyaXB0b3JzICAgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygnLi9kZXNjcmlwdG9ycycpOwp2YXIgUm91dGluZ0NvbnRleHRNaXhpbiA9IF9fYnJvd3NlcmlmeV9fKCcuL1JvdXRpbmdDb250ZXh0TWl4aW4nKTsKCm1vZHVsZS5leHBvcnRzID0gewogIGlzUm91dGVzOiBkZXNjcmlwdG9ycy5pc1JvdXRlcywKICBSb3V0ZXM6IGRlc2NyaXB0b3JzLlJvdXRlcywKICBSb3V0ZTogZGVzY3JpcHRvcnMuUm91dGUsCiAgTGluazpMaW5rLAogIExpbmtNaXhpbjpMaW5rTWl4aW4sCiAgbWF0Y2hSb3V0ZXM6bWF0Y2hSb3V0ZXMsCiAgY3JlYXRlVmlldzpjcmVhdGVWaWV3LAogIGRhdGE6ZGF0YSwKICBzdGFydDogUGF0aG5hbWVSb3V0aW5nLnN0YXJ0LmJpbmQoUGF0aG5hbWVSb3V0aW5nKSwKICByb3V0ZTpyb3V0ZSwKICBQYXRobmFtZVJvdXRpbmc6UGF0aG5hbWVSb3V0aW5nLAogIEhhc2hSb3V0aW5nOkhhc2hSb3V0aW5nLAogIFJvdXRpbmdDb250ZXh0TWl4aW46Um91dGluZ0NvbnRleHRNaXhpbgp9OwoKfSx7Ii4vTGluayI6NCwiLi9MaW5rTWl4aW4iOjUsIi4vUm91dGluZ0NvbnRleHRNaXhpbiI6NiwiLi9jcmVhdGVWaWV3Ijo4LCIuL2RhdGEiOjksIi4vZGVzY3JpcHRvcnMiOjEwLCIuL2ZldGNoVmlld3MiOjEyLCIuL21hdGNoUm91dGVzIjoxOSwiLi9yb3V0ZSI6MjMsIi4vcm91dGluZy9IYXNoUm91dGluZyI6MjQsIi4vcm91dGluZy9QYXRobmFtZVJvdXRpbmciOjI1fV0sMTU6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENvcHlyaWdodCAyMDEzLTIwMTQgRmFjZWJvb2ssIEluYy4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqCiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAogKgogKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBAcHJvdmlkZXNNb2R1bGUgaW52YXJpYW50CiAqLwoKInVzZSBzdHJpY3QiOwoKLyoqCiAqIFVzZSBpbnZhcmlhbnQoKSB0byBhc3NlcnQgc3RhdGUgd2hpY2ggeW91ciBwcm9ncmFtIGFzc3VtZXMgdG8gYmUgdHJ1ZS4KICoKICogUHJvdmlkZSBzcHJpbnRmLXN0eWxlIGZvcm1hdCAob25seSAlcyBpcyBzdXBwb3J0ZWQpIGFuZCBhcmd1bWVudHMKICogdG8gcHJvdmlkZSBpbmZvcm1hdGlvbiBhYm91dCB3aGF0IGJyb2tlIGFuZCB3aGF0IHlvdSB3ZXJlCiAqIGV4cGVjdGluZy4KICoKICogVGhlIGludmFyaWFudCBtZXNzYWdlIHdpbGwgYmUgc3RyaXBwZWQgaW4gcHJvZHVjdGlvbiwgYnV0IHRoZSBpbnZhcmlhbnQKICogd2lsbCByZW1haW4gdG8gZW5zdXJlIGxvZ2ljIGRvZXMgbm90IGRpZmZlciBpbiBwcm9kdWN0aW9uLgogKi8KCnZhciBpbnZhcmlhbnQgPSBmdW5jdGlvbihjb25kaXRpb24pIHsKICBpZiAoIWNvbmRpdGlvbikgewogICAgdmFyIGVycm9yID0gbmV3IEVycm9yKAogICAgICAnTWluaWZpZWQgZXhjZXB0aW9uIG9jY3VyZWQ7IHVzZSB0aGUgbm9uLW1pbmlmaWVkIGRldiBlbnZpcm9ubWVudCBmb3IgJyArCiAgICAgICd0aGUgZnVsbCBlcnJvciBtZXNzYWdlIGFuZCBhZGRpdGlvbmFsIGhlbHBmdWwgd2FybmluZ3MuJwogICAgKTsKICAgIGVycm9yLmZyYW1lc1RvUG9wID0gMTsKICAgIHRocm93IGVycm9yOwogIH0KfTsKCmlmICgiZGV2ZWxvcG1lbnQiICE9PSAncHJvZHVjdGlvbicpIHsKICBpbnZhcmlhbnQgPSBmdW5jdGlvbihjb25kaXRpb24sIGZvcm1hdCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgaWYgKGZvcm1hdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignaW52YXJpYW50IHJlcXVpcmVzIGFuIGVycm9yIG1lc3NhZ2UgYXJndW1lbnQnKTsKICAgIH0KCiAgICBpZiAoIWNvbmRpdGlvbikgewogICAgICB2YXIgYXJncyA9IFthLCBiLCBjLCBkLCBlLCBmXTsKICAgICAgdmFyIGFyZ0luZGV4ID0gMDsKICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKAogICAgICAgICdJbnZhcmlhbnQgVmlvbGF0aW9uOiAnICsKICAgICAgICBmb3JtYXQucmVwbGFjZSgvJXMvZywgZnVuY3Rpb24oKSB7IHJldHVybiBhcmdzW2FyZ0luZGV4KytdOyB9KQogICAgICApOwogICAgICBlcnJvci5mcmFtZXNUb1BvcCA9IDE7IC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgaW52YXJpYW50J3Mgb3duIGZyYW1lCiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH07Cn0KCm1vZHVsZS5leHBvcnRzID0gaW52YXJpYW50OwoKfSx7fV0sMTY6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEBqc3ggUmVhY3QuRE9NCiAqLwondXNlIHN0cmljdCc7CgpmdW5jdGlvbiBpc1N0cmluZyhvKSB7CiAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvKSA9PT0gJ1tvYmplY3QgU3RyaW5nXSc7Cn0KCm1vZHVsZS5leHBvcnRzID0gaXNTdHJpbmc7Cgp9LHt9XSwxNzpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQ29weXJpZ2h0IDIwMTMtMjAxNCBGYWNlYm9vaywgSW5jLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIEBwcm92aWRlc01vZHVsZSBrZXlNaXJyb3IKICogQHR5cGVjaGVja3Mgc3RhdGljLW9ubHkKICovCgoidXNlIHN0cmljdCI7Cgp2YXIgaW52YXJpYW50ID0gX19icm93c2VyaWZ5X18oJy4vaW52YXJpYW50Jyk7CgovKioKICogQ29uc3RydWN0cyBhbiBlbnVtZXJhdGlvbiB3aXRoIGtleXMgZXF1YWwgdG8gdGhlaXIgdmFsdWUuCiAqCiAqIEZvciBleGFtcGxlOgogKgogKiAgIHZhciBDT0xPUlMgPSBrZXlNaXJyb3Ioe2JsdWU6IG51bGwsIHJlZDogbnVsbH0pOwogKiAgIHZhciBteUNvbG9yID0gQ09MT1JTLmJsdWU7CiAqICAgdmFyIGlzQ29sb3JWYWxpZCA9ICEhQ09MT1JTW215Q29sb3JdOwogKgogKiBUaGUgbGFzdCBsaW5lIGNvdWxkIG5vdCBiZSBwZXJmb3JtZWQgaWYgdGhlIHZhbHVlcyBvZiB0aGUgZ2VuZXJhdGVkIGVudW0gd2VyZQogKiBub3QgZXF1YWwgdG8gdGhlaXIga2V5cy4KICoKICogICBJbnB1dDogIHtrZXkxOiB2YWwxLCBrZXkyOiB2YWwyfQogKiAgIE91dHB1dDoge2tleTE6IGtleTEsIGtleTI6IGtleTJ9CiAqCiAqIEBwYXJhbSB7b2JqZWN0fSBvYmoKICogQHJldHVybiB7b2JqZWN0fQogKi8KdmFyIGtleU1pcnJvciA9IGZ1bmN0aW9uKG9iaikgewogIHZhciByZXQgPSB7fTsKICB2YXIga2V5OwogIGludmFyaWFudCgKICAgIG9iaiBpbnN0YW5jZW9mIE9iamVjdCAmJiAhQXJyYXkuaXNBcnJheShvYmopLAogICAgJ2tleU1pcnJvciguLi4pOiBBcmd1bWVudCBtdXN0IGJlIGFuIG9iamVjdC4nCiAgKTsKICBmb3IgKGtleSBpbiBvYmopIHsKICAgIGlmICghb2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICByZXRba2V5XSA9IGtleTsKICB9CiAgcmV0dXJuIHJldDsKfTsKCm1vZHVsZS5leHBvcnRzID0ga2V5TWlycm9yOwoKfSx7Ii4vaW52YXJpYW50IjoxNX1dLDE4OltmdW5jdGlvbihfX2Jyb3dzZXJpZnlfXyxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBAanN4IFJlYWN0LkRPTQogKi8KJ3VzZSBzdHJpY3QnOwoKdmFyIGludmFyaWFudCAgICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuL2ludmFyaWFudCcpOwp2YXIgZ2V0VHJhY2VCeU5hbWUgID0gX19icm93c2VyaWZ5X18oJy4vZGVzY3JpcHRvcnMnKS5nZXRUcmFjZUJ5TmFtZTsKCmZ1bmN0aW9uIG1ha2VIcmVmKHJvdXRlcywgbmFtZSwgbWF0Y2gsIHBhcmFtcykgewogIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICB2YXIgcGF0dGVybiA9IGdldFBhdHRlcm4ocm91dGVzLCBuYW1lLCBtYXRjaCk7CiAgLy8gVE9ETzogaGFuZGxlIG9wdGlvbmFsIGFuZCBzcGxhdCBwYXJhbXMKICByZXR1cm4gcGF0dGVybi5yZXBsYWNlKAogICAgLzpbYS16QS1aMC05X10rL2csCiAgICBmdW5jdGlvbihuYW1lKSAge3JldHVybiBwYXJhbXNbbmFtZS5zbGljZSgxKV07fQogICk7Cn0KCmZ1bmN0aW9uIGdldFBhdHRlcm4ocm91dGVzLCBuYW1lLCBtYXRjaCkgewogIHZhciB0cmFjZSA9IGdldFNjb3BlZFRyYWNlKHJvdXRlcywgbmFtZSwgbWF0Y2gpOwoKICBpbnZhcmlhbnQoCiAgICB0cmFjZSAhPT0gdW5kZWZpbmVkICYmIHRyYWNlLmxlbmd0aCA+IDAsCiAgICAnY2Fubm90IHJlc29sdmUgIiVzIiByb3V0ZSByZWZlcmVuY2UnLCBuYW1lCiAgKTsKCiAgdmFyIGhyZWYgPSAnJzsKICBmb3IgKHZhciBpID0gMCwgbGVuID0gdHJhY2UubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgIHZhciByb3V0ZSA9IHRyYWNlW2ldOwogICAgaWYgKHJvdXRlLnBhdGggJiYgcm91dGUucGF0aC5sZW5ndGggPiAwKSB7CiAgICAgIGhyZWYgPSBocmVmICsgJy8nICsgcm91dGUucGF0aDsKICAgIH0KICB9CgogIHJldHVybiBocmVmID09PSAnJyA/ICcvJyA6IGhyZWY7Cn0KCmZ1bmN0aW9uIGdldFNjb3BlZFRyYWNlKHJvdXRlcywgbmFtZSwgbWF0Y2gpIHsKICBpZiAobmFtZVswXSA9PT0gJy8nKSB7CiAgICByZXR1cm4gZ2V0VHJhY2VCeU5hbWUocm91dGVzLCBuYW1lLnNsaWNlKDEpKTsKICB9IGVsc2UgewogICAgdmFyIHRyYWNlID0gbWF0Y2gudHJhY2UubWFwKGZ1bmN0aW9uKHN0ZXApICB7cmV0dXJuIHN0ZXAucm91dGU7fSk7CiAgICB2YXIgc2NvcGUgPSB0cmFjZVswXTsKCiAgICBmb3IgKHZhciBpID0gdHJhY2UubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgaWYgKHRyYWNlW2ldLl9fc2NvcGUpIHsKICAgICAgICBzY29wZSA9IHRyYWNlW2ldOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRyYWNlCiAgICAgIC5zbGljZSgwLCBpKQogICAgICAuY29uY2F0KGdldFRyYWNlQnlOYW1lKHNjb3BlLCBuYW1lKSk7CiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IG1ha2VIcmVmOwptb2R1bGUuZXhwb3J0cy5nZXRQYXR0ZXJuID0gZ2V0UGF0dGVybjsKCn0seyIuL2Rlc2NyaXB0b3JzIjoxMCwiLi9pbnZhcmlhbnQiOjE1fV0sMTk6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEBqc3ggUmVhY3QuRE9NCiAqLwondXNlIHN0cmljdCc7Cgp2YXIgcGF0dGVybiAgPSBfX2Jyb3dzZXJpZnlfXygndXJsLXBhdHRlcm4nKTsKdmFyIHFzICAgICAgID0gX19icm93c2VyaWZ5X18oJ3FzJyk7CnZhciBoYXNWaWV3ICA9IF9fYnJvd3NlcmlmeV9fKCcuL2Rlc2NyaXB0b3JzJykuaGFzVmlldzsKdmFyIGlzU3RyaW5nID0gX19icm93c2VyaWZ5X18oJy4vaXNTdHJpbmcnKTsKCi8qKgogKiBOb3JtYWxpemUgcGF0aAogKgogKiBAcGFyYW0ge1N0cmluZ30gcGF0aAogKiBAcmV0dXJucyB7U3RyaW5nfQogKi8KZnVuY3Rpb24gbm9ybWFsaXplKHBhdGgpIHsKICBpZiAoIXBhdGgpIHsKICAgIHJldHVybiAnLyc7CiAgfQogIGlmIChwYXRoWzBdICE9PSAnLycpIHsKICAgIHBhdGggPSAnLycgKyBwYXRoOwogIH0KICBpZiAocGF0aFtwYXRoLmxlbmd0aCAtIDFdICE9PSAnLycpIHsKICAgIHBhdGggPSBwYXRoICsgJy8nOwogIH0KICByZXR1cm4gcGF0aDsKfQoKLyoqCiAqIE1hdGNoIHJvdXRlIGFnYWluc3QgcGF0aAogKgogKiBAcGFyYW0ge1JvdXRlfSByb3V0ZQogKiBAcGFyYW0ge1N0cmluZ30gcGF0aAogKiBAcmV0dXJucyB7TWF0Y2h8TnVsbH0KICovCmZ1bmN0aW9uIG1hdGNoUm91dGUocm91dGUsIHBhdGgpIHsKCiAgaWYgKHJvdXRlLnBhdHRlcm4gPT09IHVuZGVmaW5lZCAmJiByb3V0ZS5wYXRoICE9PSB1bmRlZmluZWQpIHsKICAgIHZhciByb3V0ZVBhdGggPSBub3JtYWxpemUocm91dGUucGF0aCk7CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHJvdXRlLCAncGF0dGVybicsIHsKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIHZhbHVlOiBwYXR0ZXJuLm5ld1BhdHRlcm4ocm91dGUuY2hpbGRyZW4ubGVuZ3RoID4gMCA/CiAgICAgICAgcm91dGVQYXRoICsgJyonIDoKICAgICAgICByb3V0ZVBhdGgpCiAgICB9KTsKICB9CgogIGlmIChyb3V0ZS5wYXR0ZXJuKSB7CiAgICB2YXIgbWF0Y2ggPSByb3V0ZS5wYXR0ZXJuLm1hdGNoKHBhdGgpOwoKICAgIGlmIChtYXRjaAogICAgICAgICYmICghbWF0Y2guXyB8fCBtYXRjaC5fWzBdID09PSAnLycgfHwgbWF0Y2guX1swXSA9PT0gJycpKSB7CiAgICAgIGRlbGV0ZSBtYXRjaC5fOwogICAgfQoKICAgIHJldHVybiBtYXRjaDsKCiAgfSBlbHNlIHsKICAgIHJldHVybiBwYXRoID09PSAnLycgfHwgcGF0aCA9PT0gJycgPyB7fSA6IHtfOiBbcGF0aF19OwogIH0KfQoKZnVuY3Rpb24gbWF0Y2hSb3V0ZXNJbXBsKHJvdXRlcywgcGF0aCwgcXVlcnksIHRyYWNlLCBhY3RpdmVUcmFjZSwgb3JpZ2luYWxQYXRoKSB7CiAgcm91dGVzID0gQXJyYXkuaXNBcnJheShyb3V0ZXMpID8gcm91dGVzIDogW3JvdXRlc107CiAgdHJhY2UgPSB0cmFjZSB8fCBbXTsKICBhY3RpdmVUcmFjZSA9IGFjdGl2ZVRyYWNlIHx8IFtdOwogIG9yaWdpbmFsUGF0aCA9IG9yaWdpbmFsUGF0aCA9PT0gdW5kZWZpbmVkID8gcGF0aCA6IG9yaWdpbmFsUGF0aDsKCiAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHJvdXRlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgdmFyIHJvdXRlID0gcm91dGVzW2ldOwogICAgdmFyIG1hdGNoID0gbWF0Y2hSb3V0ZShyb3V0ZSwgbm9ybWFsaXplKHBhdGgpKTsKCiAgICBpZiAoIW1hdGNoKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIHZhciBzdGVwID0ge3JvdXRlOnJvdXRlLCBtYXRjaDptYXRjaCwgcHJvcHM6IHtxdWVyeTpxdWVyeX19OwoKICAgIHRyYWNlID0gdHJhY2UuY29uY2F0KHN0ZXApOwoKICAgIGFjdGl2ZVRyYWNlID0gcm91dGUudmlldyAhPT0gdW5kZWZpbmVkID8KICAgICAgW3N0ZXBdIDogYWN0aXZlVHJhY2UuY29uY2F0KHN0ZXApOwoKICAgIGlmICgobWF0Y2guXyB8fCAhaGFzVmlldyhyb3V0ZSkpICYmIHJvdXRlLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgcmV0dXJuIG1hdGNoUm91dGVzSW1wbCgKICAgICAgICByb3V0ZS5jaGlsZHJlbiwgbWF0Y2guXyA/IG1hdGNoLl9bMF0gOiAnLycsIHF1ZXJ5LAogICAgICAgIHRyYWNlLCBhY3RpdmVUcmFjZSwgb3JpZ2luYWxQYXRoKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB7cGF0aDogb3JpZ2luYWxQYXRoLCBxdWVyeTpxdWVyeSwgcm91dGU6cm91dGUsIHRyYWNlOnRyYWNlLCBhY3RpdmVUcmFjZTphY3RpdmVUcmFjZX07CiAgICB9CiAgfQoKICByZXR1cm4gewogICAgcGF0aDogb3JpZ2luYWxQYXRoLAogICAgcXVlcnk6cXVlcnksCiAgICByb3V0ZTogdW5kZWZpbmVkLAogICAgdHJhY2U6IFtdLAogICAgYWN0aXZlVHJhY2U6IFtdCiAgfTsKfQoKLyoqCiAqIE1hdGNoIHJvdXRlcyBhZ2FpbnN0IHBhdGgKICoKICogQHBhcmFtIHtSb3V0ZX0gcm91dGVzCiAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAqIEByZXR1cm5zIHtNYXRjaH0KICovCmZ1bmN0aW9uIG1hdGNoUm91dGVzKHJvdXRlcywgcGF0aCwgcXVlcnkpIHsKICBxdWVyeSA9IHF1ZXJ5ID09PSB1bmRlZmluZWQgPyB7fSA6IGlzU3RyaW5nKHF1ZXJ5KSA/IHFzLnBhcnNlKHF1ZXJ5KSA6IHF1ZXJ5OwogIHJldHVybiBtYXRjaFJvdXRlc0ltcGwocm91dGVzLCBwYXRoLCBxdWVyeSk7Cn0KCm1vZHVsZS5leHBvcnRzID0gbWF0Y2hSb3V0ZXM7Cgp9LHsiLi9kZXNjcmlwdG9ycyI6MTAsIi4vaXNTdHJpbmciOjE2LCJxcyI6MSwidXJsLXBhdHRlcm4iOjJ9XSwyMDpbZnVuY3Rpb24oX19icm93c2VyaWZ5X18sbW9kdWxlLGV4cG9ydHMpewovKioKICogQ29weXJpZ2h0IDIwMTMtMjAxNCBGYWNlYm9vaywgSW5jLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIEBwcm92aWRlc01vZHVsZSBtZXJnZQogKi8KCiJ1c2Ugc3RyaWN0IjsKCnZhciBtZXJnZUludG8gPSBfX2Jyb3dzZXJpZnlfXygnLi9tZXJnZUludG8nKTsKCi8qKgogKiBTaGFsbG93IG1lcmdlcyB0d28gc3RydWN0dXJlcyBpbnRvIGEgcmV0dXJuIHZhbHVlLCB3aXRob3V0IG11dGF0aW5nIGVpdGhlci4KICoKICogQHBhcmFtIHs/b2JqZWN0fSBvbmUgT3B0aW9uYWwgb2JqZWN0IHdpdGggcHJvcGVydGllcyB0byBtZXJnZSBmcm9tLgogKiBAcGFyYW0gez9vYmplY3R9IHR3byBPcHRpb25hbCBvYmplY3Qgd2l0aCBwcm9wZXJ0aWVzIHRvIG1lcmdlIGZyb20uCiAqIEByZXR1cm4ge29iamVjdH0gVGhlIHNoYWxsb3cgZXh0ZW5zaW9uIG9mIG9uZSBieSB0d28uCiAqLwp2YXIgbWVyZ2UgPSBmdW5jdGlvbihvbmUsIHR3bykgewogIHZhciByZXN1bHQgPSB7fTsKICBtZXJnZUludG8ocmVzdWx0LCBvbmUpOwogIG1lcmdlSW50byhyZXN1bHQsIHR3byk7CiAgcmV0dXJuIHJlc3VsdDsKfTsKCm1vZHVsZS5leHBvcnRzID0gbWVyZ2U7Cgp9LHsiLi9tZXJnZUludG8iOjIyfV0sMjE6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENvcHlyaWdodCAyMDEzLTIwMTQgRmFjZWJvb2ssIEluYy4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqCiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAogKgogKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBAcHJvdmlkZXNNb2R1bGUgbWVyZ2VIZWxwZXJzCiAqCiAqIHJlcXVpcmVzUG9seWZpbGxzOiBBcnJheS5pc0FycmF5CiAqLwoKInVzZSBzdHJpY3QiOwoKdmFyIGludmFyaWFudCA9IF9fYnJvd3NlcmlmeV9fKCcuL2ludmFyaWFudCcpOwp2YXIga2V5TWlycm9yID0gX19icm93c2VyaWZ5X18oJy4va2V5TWlycm9yJyk7CgovKioKICogTWF4aW11bSBudW1iZXIgb2YgbGV2ZWxzIHRvIHRyYXZlcnNlLiBXaWxsIGNhdGNoIGNpcmN1bGFyIHN0cnVjdHVyZXMuCiAqIEBjb25zdAogKi8KdmFyIE1BWF9NRVJHRV9ERVBUSCA9IDM2OwoKLyoqCiAqIFdlIHdvbid0IHdvcnJ5IGFib3V0IGVkZ2UgY2FzZXMgbGlrZSBuZXcgU3RyaW5nKCd4Jykgb3IgbmV3IEJvb2xlYW4odHJ1ZSkuCiAqIEZ1bmN0aW9ucyBhcmUgY29uc2lkZXJlZCB0ZXJtaW5hbHMsIGFuZCBhcnJheXMgYXJlIG5vdC4KICogQHBhcmFtIHsqfSBvIFRoZSBpdGVtL29iamVjdC92YWx1ZSB0byB0ZXN0LgogKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmZiB0aGUgYXJndW1lbnQgaXMgYSB0ZXJtaW5hbC4KICovCnZhciBpc1Rlcm1pbmFsID0gZnVuY3Rpb24obykgewogIHJldHVybiB0eXBlb2YgbyAhPT0gJ29iamVjdCcgfHwgbyA9PT0gbnVsbDsKfTsKCnZhciBtZXJnZUhlbHBlcnMgPSB7CgogIE1BWF9NRVJHRV9ERVBUSDogTUFYX01FUkdFX0RFUFRILAoKICBpc1Rlcm1pbmFsOiBpc1Rlcm1pbmFsLAoKICAvKioKICAgKiBDb252ZXJ0cyBudWxsL3VuZGVmaW5lZCB2YWx1ZXMgaW50byBlbXB0eSBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0gez9PYmplY3Q9fSBhcmcgQXJndW1lbnQgdG8gYmUgbm9ybWFsaXplZCAobnVsbGFibGUgb3B0aW9uYWwpCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBub3JtYWxpemVNZXJnZUFyZzogZnVuY3Rpb24oYXJnKSB7CiAgICByZXR1cm4gYXJnID09PSB1bmRlZmluZWQgfHwgYXJnID09PSBudWxsID8ge30gOiBhcmc7CiAgfSwKCiAgLyoqCiAgICogSWYgbWVyZ2luZyBBcnJheXMsIGEgbWVyZ2Ugc3RyYXRlZ3kgKm11c3QqIGJlIHN1cHBsaWVkLiBJZiBub3QsIGl0IGlzCiAgICogbGlrZWx5IHRoZSBjYWxsZXIncyBmYXVsdC4gSWYgdGhpcyBmdW5jdGlvbiBpcyBldmVyIGNhbGxlZCB3aXRoIGFueXRoaW5nCiAgICogYnV0IGBvbmVgIGFuZCBgdHdvYCBiZWluZyBgQXJyYXlgcywgaXQgaXMgdGhlIGZhdWx0IG9mIHRoZSBtZXJnZSB1dGlsaXRpZXMuCiAgICoKICAgKiBAcGFyYW0geyp9IG9uZSBBcnJheSB0byBtZXJnZSBpbnRvLgogICAqIEBwYXJhbSB7Kn0gdHdvIEFycmF5IHRvIG1lcmdlIGZyb20uCiAgICovCiAgY2hlY2tNZXJnZUFycmF5QXJnczogZnVuY3Rpb24ob25lLCB0d28pIHsKICAgIGludmFyaWFudCgKICAgICAgQXJyYXkuaXNBcnJheShvbmUpICYmIEFycmF5LmlzQXJyYXkodHdvKSwKICAgICAgJ1RyaWVkIHRvIG1lcmdlIGFycmF5cywgaW5zdGVhZCBnb3QgJXMgYW5kICVzLicsCiAgICAgIG9uZSwKICAgICAgdHdvCiAgICApOwogIH0sCgogIC8qKgogICAqIEBwYXJhbSB7Kn0gb25lIE9iamVjdCB0byBtZXJnZSBpbnRvLgogICAqIEBwYXJhbSB7Kn0gdHdvIE9iamVjdCB0byBtZXJnZSBmcm9tLgogICAqLwogIGNoZWNrTWVyZ2VPYmplY3RBcmdzOiBmdW5jdGlvbihvbmUsIHR3bykgewogICAgbWVyZ2VIZWxwZXJzLmNoZWNrTWVyZ2VPYmplY3RBcmcob25lKTsKICAgIG1lcmdlSGVscGVycy5jaGVja01lcmdlT2JqZWN0QXJnKHR3byk7CiAgfSwKCiAgLyoqCiAgICogQHBhcmFtIHsqfSBhcmcKICAgKi8KICBjaGVja01lcmdlT2JqZWN0QXJnOiBmdW5jdGlvbihhcmcpIHsKICAgIGludmFyaWFudCgKICAgICAgIWlzVGVybWluYWwoYXJnKSAmJiAhQXJyYXkuaXNBcnJheShhcmcpLAogICAgICAnVHJpZWQgdG8gbWVyZ2UgYW4gb2JqZWN0LCBpbnN0ZWFkIGdvdCAlcy4nLAogICAgICBhcmcKICAgICk7CiAgfSwKCiAgLyoqCiAgICogQ2hlY2tzIHRoYXQgYSBtZXJnZSB3YXMgbm90IGdpdmVuIGEgY2lyY3VsYXIgb2JqZWN0IG9yIGFuIG9iamVjdCB0aGF0IGhhZAogICAqIHRvbyBncmVhdCBvZiBkZXB0aC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBMZXZlbCBvZiByZWN1cnNpb24gdG8gdmFsaWRhdGUgYWdhaW5zdCBtYXhpbXVtLgogICAqLwogIGNoZWNrTWVyZ2VMZXZlbDogZnVuY3Rpb24obGV2ZWwpIHsKICAgIGludmFyaWFudCgKICAgICAgbGV2ZWwgPCBNQVhfTUVSR0VfREVQVEgsCiAgICAgICdNYXhpbXVtIGRlZXAgbWVyZ2UgZGVwdGggZXhjZWVkZWQuIFlvdSBtYXkgYmUgYXR0ZW1wdGluZyB0byBtZXJnZSAnICsKICAgICAgJ2NpcmN1bGFyIHN0cnVjdHVyZXMgaW4gYW4gdW5zdXBwb3J0ZWQgd2F5LicKICAgICk7CiAgfSwKCiAgLyoqCiAgICogQ2hlY2tzIHRoYXQgdGhlIHN1cHBsaWVkIG1lcmdlIHN0cmF0ZWd5IGlzIHZhbGlkLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IEFycmF5IG1lcmdlIHN0cmF0ZWd5LgogICAqLwogIGNoZWNrQXJyYXlTdHJhdGVneTogZnVuY3Rpb24oc3RyYXRlZ3kpIHsKICAgIGludmFyaWFudCgKICAgICAgc3RyYXRlZ3kgPT09IHVuZGVmaW5lZCB8fCBzdHJhdGVneSBpbiBtZXJnZUhlbHBlcnMuQXJyYXlTdHJhdGVnaWVzLAogICAgICAnWW91IG11c3QgcHJvdmlkZSBhbiBhcnJheSBzdHJhdGVneSB0byBkZWVwIG1lcmdlIGZ1bmN0aW9ucyB0byAnICsKICAgICAgJ2luc3RydWN0IHRoZSBkZWVwIG1lcmdlIGhvdyB0byByZXNvbHZlIG1lcmdpbmcgdHdvIGFycmF5cy4nCiAgICApOwogIH0sCgogIC8qKgogICAqIFNldCBvZiBwb3NzaWJsZSBiZWhhdmlvcnMgb2YgbWVyZ2UgYWxnb3JpdGhtcyB3aGVuIGVuY291bnRlcmluZyB0d28gQXJyYXlzCiAgICogdGhhdCBtdXN0IGJlIG1lcmdlZCB0b2dldGhlci4KICAgKiAtIGBjbG9iYmVyYDogVGhlIGxlZnQgYEFycmF5YCBpcyBpZ25vcmVkLgogICAqIC0gYGluZGV4QnlJbmRleGA6IFRoZSByZXN1bHQgaXMgYWNoaWV2ZWQgYnkgcmVjdXJzaXZlbHkgZGVlcCBtZXJnaW5nIGF0CiAgICogICBlYWNoIGluZGV4LiAobm90IHlldCBzdXBwb3J0ZWQuKQogICAqLwogIEFycmF5U3RyYXRlZ2llczoga2V5TWlycm9yKHsKICAgIENsb2JiZXI6IHRydWUsCiAgICBJbmRleEJ5SW5kZXg6IHRydWUKICB9KQoKfTsKCm1vZHVsZS5leHBvcnRzID0gbWVyZ2VIZWxwZXJzOwoKfSx7Ii4vaW52YXJpYW50IjoxNSwiLi9rZXlNaXJyb3IiOjE3fV0sMjI6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENvcHlyaWdodCAyMDEzLTIwMTQgRmFjZWJvb2ssIEluYy4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqCiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAogKgogKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBAcHJvdmlkZXNNb2R1bGUgbWVyZ2VJbnRvCiAqIEB0eXBlY2hlY2tzIHN0YXRpYy1vbmx5CiAqLwoKInVzZSBzdHJpY3QiOwoKdmFyIG1lcmdlSGVscGVycyA9IF9fYnJvd3NlcmlmeV9fKCcuL21lcmdlSGVscGVycycpOwoKdmFyIGNoZWNrTWVyZ2VPYmplY3RBcmcgPSBtZXJnZUhlbHBlcnMuY2hlY2tNZXJnZU9iamVjdEFyZzsKCi8qKgogKiBTaGFsbG93IG1lcmdlcyB0d28gc3RydWN0dXJlcyBieSBtdXRhdGluZyB0aGUgZmlyc3QgcGFyYW1ldGVyLgogKgogKiBAcGFyYW0ge29iamVjdH0gb25lIE9iamVjdCB0byBiZSBtZXJnZWQgaW50by4KICogQHBhcmFtIHs/b2JqZWN0fSB0d28gT3B0aW9uYWwgb2JqZWN0IHdpdGggcHJvcGVydGllcyB0byBtZXJnZSBmcm9tLgogKi8KZnVuY3Rpb24gbWVyZ2VJbnRvKG9uZSwgdHdvKSB7CiAgY2hlY2tNZXJnZU9iamVjdEFyZyhvbmUpOwogIGlmICh0d28gIT0gbnVsbCkgewogICAgY2hlY2tNZXJnZU9iamVjdEFyZyh0d28pOwogICAgZm9yICh2YXIga2V5IGluIHR3bykgewogICAgICBpZiAoIXR3by5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgb25lW2tleV0gPSB0d29ba2V5XTsKICAgIH0KICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gbWVyZ2VJbnRvOwoKfSx7Ii4vbWVyZ2VIZWxwZXJzIjoyMX1dLDIzOltmdW5jdGlvbihfX2Jyb3dzZXJpZnlfXyxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBAanN4IFJlYWN0LkRPTQogKi8KJ3VzZSBzdHJpY3QnOwoKdmFyIFJlYWN0ICAgICAgID0gKHdpbmRvdy5SZWFjdCk7CnZhciBQcm9taXNlICAgICA9ICh3aW5kb3cuUHJvbWlzZSk7CnZhciBtYXRjaFJvdXRlcyA9IF9fYnJvd3NlcmlmeV9fKCcuL21hdGNoUm91dGVzJyk7CnZhciBkYXRhICAgICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuL2RhdGEnKTsKdmFyIGNyZWF0ZVZpZXcgID0gX19icm93c2VyaWZ5X18oJy4vY3JlYXRlVmlldycpOwp2YXIgZmV0Y2hWaWV3cyAgPSBfX2Jyb3dzZXJpZnlfXygnLi9mZXRjaFZpZXdzJyk7CgpmdW5jdGlvbiByb3V0ZShyb3V0ZXMsIHBhdGgsIHF1ZXJ5KSB7CiAgcXVlcnkgPSBxdWVyeSB8fCAnJzsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSAgewogICAgdmFyIG1hdGNoID0gbWF0Y2hSb3V0ZXMocm91dGVzLCBwYXRoLCBxdWVyeSk7CiAgICByZXR1cm4gZmV0Y2hWaWV3cyhtYXRjaCkudGhlbihkYXRhLmZldGNoKS50aGVuKGZ1bmN0aW9uKG1hdGNoKSAgewogICAgICByZXR1cm4gZnVuY3Rpb24gZXhlY3V0ZShmdW5jKSB7CiAgICAgICAgUmVhY3Qud2l0aENvbnRleHQoe21hdGNoOm1hdGNoLCByb3V0ZXM6cm91dGVzfSwgZnVuY3Rpb24oKSAgewogICAgICAgICAgdmFyIHZpZXcgPSBjcmVhdGVWaWV3KG1hdGNoKTsKICAgICAgICAgIHJldHVybiBmdW5jKHZpZXcsIG1hdGNoLCB7aW5pdGlhbDogdHJ1ZX0pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KS50aGVuKHJlc29sdmUsIHJlamVjdCk7CiAgfSk7Cn0KCm1vZHVsZS5leHBvcnRzID0gcm91dGU7Cgp9LHsiLi9jcmVhdGVWaWV3Ijo4LCIuL2RhdGEiOjksIi4vZmV0Y2hWaWV3cyI6MTIsIi4vbWF0Y2hSb3V0ZXMiOjE5fV0sMjQ6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEBqc3ggUmVhY3QuRE9NCiAqLwondXNlIHN0cmljdCc7Cgp2YXIgUm91dGluZyA9IF9fYnJvd3NlcmlmeV9fKCcuL1JvdXRpbmcnKTsKCmZvcih2YXIgUm91dGluZ19fX19LZXkgaW4gUm91dGluZyl7aWYoUm91dGluZy5oYXNPd25Qcm9wZXJ0eShSb3V0aW5nX19fX0tleSkpe0hhc2hSb3V0aW5nW1JvdXRpbmdfX19fS2V5XT1Sb3V0aW5nW1JvdXRpbmdfX19fS2V5XTt9fXZhciBfX19fU3VwZXJQcm90b09mUm91dGluZz1Sb3V0aW5nPT09bnVsbD9udWxsOlJvdXRpbmcucHJvdG90eXBlO0hhc2hSb3V0aW5nLnByb3RvdHlwZT1PYmplY3QuY3JlYXRlKF9fX19TdXBlclByb3RvT2ZSb3V0aW5nKTtIYXNoUm91dGluZy5wcm90b3R5cGUuY29uc3RydWN0b3I9SGFzaFJvdXRpbmc7SGFzaFJvdXRpbmcuX19zdXBlckNvbnN0cnVjdG9yX189Um91dGluZztmdW5jdGlvbiBIYXNoUm91dGluZygpe2lmKFJvdXRpbmchPT1udWxsKXtSb3V0aW5nLmFwcGx5KHRoaXMsYXJndW1lbnRzKTt9fQoKICBIYXNoUm91dGluZy5wcm90b3R5cGUuZ2V0UGF0aD1mdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmdldFBhcnNlZFBhdGgoKS5wYXRoOwogIH07CgogIEhhc2hSb3V0aW5nLnByb3RvdHlwZS5nZXRRdWVyeT1mdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmdldFBhcnNlZFBhdGgoKS5xdWVyeTsKICB9OwoKICBIYXNoUm91dGluZy5wcm90b3R5cGUuZ2V0UGFyc2VkUGF0aD1mdW5jdGlvbigpIHsKICAgIHZhciBwYXRoID0gd2luZG93LmxvY2F0aW9uLmhhc2guc2xpY2UoMSkgfHwgJy8nOwogICAgdmFyIGlkeCA9IHBhdGguaW5kZXhPZignPycpOwogICAgaWYgKGlkeCA+IC0xKSB7CiAgICAgIHJldHVybiB7cGF0aDogcGF0aC5zdWJzdHJpbmcoMCwgaWR4KSwgcXVlcnk6IHBhdGguc3Vic3RyaW5nKGlkeCArIDEpfTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB7cGF0aDpwYXRoLCBxdWVyeTogJyd9OwogICAgfQogIH07CgogIEhhc2hSb3V0aW5nLnByb3RvdHlwZS5wdXNoUGF0aD1mdW5jdGlvbihwYXRoKSB7CiAgICB3aW5kb3cubG9jYXRpb24uaGFzaCA9IHBhdGg7CiAgfTsKCiAgSGFzaFJvdXRpbmcucHJvdG90eXBlLnJlcGxhY2VQYXRoPWZ1bmN0aW9uKHBhdGgpIHsKICAgIHZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgd2luZG93LmxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIHBhdGgpOwogIH07CgogIEhhc2hSb3V0aW5nLnByb3RvdHlwZS5tYWtlSHJlZj1mdW5jdGlvbihuYW1lLCBwYXJhbXMpIHsKICAgIHJldHVybiAnIycgKyBfX19fU3VwZXJQcm90b09mUm91dGluZy5tYWtlSHJlZi5jYWxsKHRoaXMsbmFtZSwgcGFyYW1zKTsKICB9OwoKICBIYXNoUm91dGluZy5wcm90b3R5cGUuZG9TdGFydD1mdW5jdGlvbigpIHsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdoYXNoY2hhbmdlJywgdGhpcy5vbkJhY2tCdXR0b24pOwogIH07CgogIEhhc2hSb3V0aW5nLnByb3RvdHlwZS5kb1N0b3A9ZnVuY3Rpb24oKSB7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignaGFzaGNoYW5nZScsIHRoaXMub25CYWNrQnV0dG9uKTsKICB9OwoKCm1vZHVsZS5leHBvcnRzID0gSGFzaFJvdXRpbmc7Cgp9LHsiLi9Sb3V0aW5nIjoyNn1dLDI1OltmdW5jdGlvbihfX2Jyb3dzZXJpZnlfXyxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBAanN4IFJlYWN0LkRPTQogKi8KJ3VzZSBzdHJpY3QnOwoKdmFyIFJvdXRpbmcgPSBfX2Jyb3dzZXJpZnlfXygnLi9Sb3V0aW5nJyk7Cgpmb3IodmFyIFJvdXRpbmdfX19fS2V5IGluIFJvdXRpbmcpe2lmKFJvdXRpbmcuaGFzT3duUHJvcGVydHkoUm91dGluZ19fX19LZXkpKXtQYXRobmFtZVJvdXRpbmdbUm91dGluZ19fX19LZXldPVJvdXRpbmdbUm91dGluZ19fX19LZXldO319dmFyIF9fX19TdXBlclByb3RvT2ZSb3V0aW5nPVJvdXRpbmc9PT1udWxsP251bGw6Um91dGluZy5wcm90b3R5cGU7UGF0aG5hbWVSb3V0aW5nLnByb3RvdHlwZT1PYmplY3QuY3JlYXRlKF9fX19TdXBlclByb3RvT2ZSb3V0aW5nKTtQYXRobmFtZVJvdXRpbmcucHJvdG90eXBlLmNvbnN0cnVjdG9yPVBhdGhuYW1lUm91dGluZztQYXRobmFtZVJvdXRpbmcuX19zdXBlckNvbnN0cnVjdG9yX189Um91dGluZztmdW5jdGlvbiBQYXRobmFtZVJvdXRpbmcoKXtpZihSb3V0aW5nIT09bnVsbCl7Um91dGluZy5hcHBseSh0aGlzLGFyZ3VtZW50cyk7fX0KCiAgUGF0aG5hbWVSb3V0aW5nLnByb3RvdHlwZS5nZXRQYXRoPWZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZTsKICB9OwoKICBQYXRobmFtZVJvdXRpbmcucHJvdG90eXBlLmdldFF1ZXJ5PWZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHdpbmRvdy5sb2NhdGlvbi5zZWFyY2guc3Vic3RyKDEpOwogIH07CgogIFBhdGhuYW1lUm91dGluZy5wcm90b3R5cGUucHVzaFBhdGg9ZnVuY3Rpb24ocGF0aCkgewogICAgd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKHt9LCAnJywgcGF0aCk7CiAgfTsKCiAgUGF0aG5hbWVSb3V0aW5nLnByb3RvdHlwZS5yZXBsYWNlUGF0aD1mdW5jdGlvbihwYXRoKSB7CiAgICB3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sICcnLCBwYXRoKTsKICB9OwoKICBQYXRobmFtZVJvdXRpbmcucHJvdG90eXBlLmRvU3RhcnQ9ZnVuY3Rpb24oKSB7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncG9wc3RhdGUnLCB0aGlzLm9uQmFja0J1dHRvbik7CiAgfTsKCiAgUGF0aG5hbWVSb3V0aW5nLnByb3RvdHlwZS5kb1N0b3A9ZnVuY3Rpb24oKSB7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9wc3RhdGUnLCB0aGlzLm9uQmFja0J1dHRvbik7CiAgfTsKCgptb2R1bGUuZXhwb3J0cyA9IFBhdGhuYW1lUm91dGluZzsKCn0seyIuL1JvdXRpbmciOjI2fV0sMjY6W2Z1bmN0aW9uKF9fYnJvd3NlcmlmeV9fLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEBqc3ggUmVhY3QuRE9NCiAqLwondXNlIHN0cmljdCc7Cgp2YXIgcXMgICAgICAgICAgICAgICAgICAgID0gX19icm93c2VyaWZ5X18oJ3FzJyk7CnZhciBSZWFjdCAgICAgICAgICAgICAgICAgPSAod2luZG93LlJlYWN0KTsKdmFyIGNyZWF0ZVZpZXcgICAgICAgICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuLi9jcmVhdGVWaWV3Jyk7CnZhciBtYXRjaFJvdXRlcyAgICAgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygnLi4vbWF0Y2hSb3V0ZXMnKTsKdmFyIGRhdGEgICAgICAgICAgICAgICAgICA9IF9fYnJvd3NlcmlmeV9fKCcuLi9kYXRhJyk7CnZhciBmZXRjaFZpZXdzICAgICAgICAgICAgPSBfX2Jyb3dzZXJpZnlfXygnLi4vZmV0Y2hWaWV3cycpOwp2YXIgbWFrZUhyZWYgICAgICAgICAgICAgID0gX19icm93c2VyaWZ5X18oJy4uL21ha2VIcmVmJyk7CgpmdW5jdGlvbiB0aHJvd0Vycm9yKGVycikgewogIHRocm93IGVycjsKfQoKCgogIGZ1bmN0aW9uIFJvdXRpbmcocm91dGVzLCBvblJvdXRlLCBvbkVycm9yKSB7CiAgICB0aGlzLnJvdXRlcyA9IHJvdXRlczsKICAgIHRoaXMub25Sb3V0ZSA9IG9uUm91dGU7CiAgICB0aGlzLm9uRXJyb3IgPSBvbkVycm9yIHx8IHRocm93RXJyb3I7CiAgICB0aGlzLm9uQ2hhbmdlID0gdGhpcy5vbkNoYW5nZS5iaW5kKHRoaXMpOwogICAgdGhpcy5vbkJhY2tCdXR0b24gPSB0aGlzLm9uQmFja0J1dHRvbi5iaW5kKHRoaXMpOwogICAgdGhpcy5wYXRoID0gdW5kZWZpbmVkOwogICAgdGhpcy5tYXRjaCA9IHVuZGVmaW5lZDsKICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlOwogIH0KCiAgUm91dGluZy5wcm90b3R5cGUub25DaGFuZ2U9ZnVuY3Rpb24obmF2aWdhdGlvbikgewogICAgbmF2aWdhdGlvbiA9IG5hdmlnYXRpb24gfHwge307CiAgICB2YXIgcGF0aCA9IHRoaXMuZ2V0UGF0aCgpOwogICAgdmFyIHF1ZXJ5ID0gdGhpcy5nZXRRdWVyeSgpOwogICAgaWYgKHRoaXMucGF0aCAhPT0gcGF0aCB8fCB0aGlzLnF1ZXJ5ICE9PSBxdWVyeSkgewogICAgICB0aGlzLiRSb3V0aW5nX3JvdXRlKHBhdGgsIHF1ZXJ5LCBuYXZpZ2F0aW9uKTsKICAgIH0KICB9OwoKICBSb3V0aW5nLnByb3RvdHlwZS5vbkJhY2tCdXR0b249ZnVuY3Rpb24oKSB7CiAgICB0aGlzLm9uQ2hhbmdlKHtiYWNrOiB0cnVlfSk7CiAgfTsKCiAgUm91dGluZy5wcm90b3R5cGUudXBkYXRlPWZ1bmN0aW9uKCkgewogICAgdGhpcy4kUm91dGluZ19yb3V0ZSh0aGlzLmdldFBhdGgoKSwgdGhpcy5nZXRRdWVyeSgpKTsKICB9OwoKICBSb3V0aW5nLnByb3RvdHlwZS4kUm91dGluZ19yb3V0ZT1mdW5jdGlvbihwYXRoLCBxdWVyeSwgbmF2aWdhdGlvbikgewogICAgdGhpcy5wYXRoID0gcGF0aDsKICAgIHRoaXMucXVlcnkgPSBxdWVyeTsKICAgIHRoaXMubWF0Y2ggPSBtYXRjaFJvdXRlcyh0aGlzLnJvdXRlcywgcGF0aCwgcXVlcnkpOwoKICAgIHZhciBleHBlY3RlZE1hdGNoID0gdGhpcy5tYXRjaDsKCiAgICB2YXIgcmVuZGVyID0gZnVuY3Rpb24obWF0Y2gpICB7CiAgICAgIGlmICh0aGlzLm1hdGNoID09PSBleHBlY3RlZE1hdGNoKSB7CiAgICAgICAgdGhpcy5yZW5kZXJWaWV3KG1hdGNoLCBuYXZpZ2F0aW9uKTsKICAgICAgfQogICAgfS5iaW5kKHRoaXMpOwoKICAgIHZhciBwcm9taXNlID0gZmV0Y2hWaWV3cyh0aGlzLm1hdGNoKTsKCiAgICBpZiAocHJvbWlzZS5pc0Z1bGZpbGxlZCgpKSB7CiAgICAgIHJlbmRlcihkYXRhLmZldGNoUHJvZ3Jlc3NpdmVseShwcm9taXNlLnZhbHVlKCksIHJlbmRlciwgdGhpcy5vbkVycm9yKSk7CiAgICB9IGVsc2UgewogICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24obWF0Y2gpICB7CiAgICAgICAgcmVuZGVyKGRhdGEuZmV0Y2hQcm9ncmVzc2l2ZWx5KG1hdGNoLCByZW5kZXIsIHRoaXMub25FcnJvcikpOwogICAgICB9LmJpbmQodGhpcyksIHRoaXMub25FcnJvcik7CiAgICB9CgogICAgcmV0dXJuIHRoaXMubWF0Y2g7CiAgfTsKCiAgUm91dGluZy5wcm90b3R5cGUucmVuZGVyVmlldz1mdW5jdGlvbihtYXRjaCwgbmF2aWdhdGlvbikgewogICAgdmFyIGNvbnRleHQgPSB7bWF0Y2g6bWF0Y2gsIHJvdXRpbmc6IHRoaXMsIHJvdXRlczogdGhpcy5yb3V0ZXN9OwogICAgUmVhY3Qud2l0aENvbnRleHQoY29udGV4dCwgZnVuY3Rpb24oKSAgewogICAgICB2YXIgdmlldyA9IGNyZWF0ZVZpZXcobWF0Y2gpOwogICAgICB0aGlzLm9uUm91dGUodmlldywgbWF0Y2gsIG5hdmlnYXRpb24pOwogICAgfS5iaW5kKHRoaXMpKTsKICB9OwoKICBSb3V0aW5nLnByb3RvdHlwZS5uYXZpZ2F0ZT1mdW5jdGlvbihwYXRoLCBuYXZpZ2F0aW9uKSB7CiAgICBuYXZpZ2F0aW9uID0gbmF2aWdhdGlvbiB8fCB7fTsKICAgIGlmIChuYXZpZ2F0aW9uLnJlcGxhY2UpIHsKICAgICAgdGhpcy5yZXBsYWNlUGF0aChwYXRoLCBuYXZpZ2F0aW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucHVzaFBhdGgocGF0aCwgbmF2aWdhdGlvbik7CiAgICB9CiAgICByZXR1cm4gdGhpcy5vbkNoYW5nZShuYXZpZ2F0aW9uKTsKICB9OwoKICBSb3V0aW5nLnByb3RvdHlwZS5uYXZpZ2F0ZVRvPWZ1bmN0aW9uKHJvdXRlUmVmLCBwcm9wcywgbmF2aWdhdGlvbikgewogICAgdmFyIHBhdGggPSB0aGlzLm1ha2VIcmVmKHJvdXRlUmVmLCBwcm9wcyk7CiAgICB0aGlzLm5hdmlnYXRlKHBhdGgsIG5hdmlnYXRpb24pOwogIH07CgogIFJvdXRpbmcucHJvdG90eXBlLm1ha2VIcmVmPWZ1bmN0aW9uKG5hbWUsIHBhcmFtcykgewogICAgdmFyIGhyZWYgPSBtYWtlSHJlZih0aGlzLnJvdXRlcywgbmFtZSwgdGhpcy5tYXRjaCwgcGFyYW1zKTsKICAgIGlmIChwYXJhbXMgJiYgcGFyYW1zLnF1ZXJ5KSB7CiAgICAgIGhyZWYgPSBocmVmICsgJz8nICsgcXMuc3RyaW5naWZ5KHBhcmFtcy5xdWVyeSk7CiAgICB9CiAgICByZXR1cm4gaHJlZjsKICB9OwoKICBSb3V0aW5nLnByb3RvdHlwZS5zdGFydD1mdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy5zdGFydGVkKSB7CiAgICAgIHRoaXMuZG9TdGFydCgpOwogICAgICB0aGlzLm9uQ2hhbmdlKHtpbml0aWFsOiB0cnVlfSk7CiAgICAgIHRoaXMuc3RhcnRlZCA9IHRydWU7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwoKICBSb3V0aW5nLnByb3RvdHlwZS5zdG9wPWZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuc3RhcnRlZCkgewogICAgICB0aGlzLmRvU3RvcCgpOwogICAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CgogIFJvdXRpbmcuc3RhcnQ9ZnVuY3Rpb24ocm91dGVzLCBvblJvdXRlLCBvbkVycm9yKSB7CiAgICByZXR1cm4gbmV3IHRoaXMocm91dGVzLCBvblJvdXRlLCBvbkVycm9yKS5zdGFydCgpOwogIH07CgoKbW9kdWxlLmV4cG9ydHMgPSBSb3V0aW5nOwoKfSx7Ii4uL2NyZWF0ZVZpZXciOjgsIi4uL2RhdGEiOjksIi4uL2ZldGNoVmlld3MiOjEyLCIuLi9tYWtlSHJlZiI6MTgsIi4uL21hdGNoUm91dGVzIjoxOSwicXMiOjF9XX0se30sWzNdKQo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 03:39:45 GMT",
                    "Content-Length": "50075",
                    "Date": "Sat, 08 Nov 2014 03:39:45 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}