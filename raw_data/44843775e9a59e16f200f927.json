{
    "url": "http://localhost:9999/kmalakoff/knockback/knockback-full-stack.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/kmalakoff/knockback/knockback-full-stack.js",
                "path": "/kmalakoff/knockback/knockback-full-stack.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9rbWFsYWtvZmYva25vY2tiYWNrL2tub2NrYmFjay1mdWxsLXN0YWNrLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDk3MTgzDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA4OjA5OjQ5IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwODowOTo0OCBHTVQNCg0KLyoKICBrbm9ja2JhY2stZnVsbC1zdGFjay5qcyAwLjIwLjQKICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCiAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCiAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgogIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoqLwooZnVuY3Rpb24gd2VicGFja1VuaXZlcnNhbE1vZHVsZURlZmluaXRpb24ocm9vdCwgZmFjdG9yeSkgewoJaWYodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnKQoJCW1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCJqcXVlcnkiKSk7CgllbHNlIGlmKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkKCQlkZWZpbmUoWyJqcXVlcnkiXSwgZmFjdG9yeSk7CgllbHNlIGlmKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykKCQlleHBvcnRzWyJrYiJdID0gZmFjdG9yeShyZXF1aXJlKCJqcXVlcnkiKSk7CgllbHNlCgkJcm9vdFsia2IiXSA9IGZhY3Rvcnkocm9vdFsialF1ZXJ5Il0pOwp9KSh0aGlzLCBmdW5jdGlvbihfX1dFQlBBQ0tfRVhURVJOQUxfTU9EVUxFXzIwX18pIHsKcmV0dXJuIC8qKioqKiovIChmdW5jdGlvbihtb2R1bGVzKSB7IC8vIHdlYnBhY2tCb290c3RyYXAKLyoqKioqKi8gCS8vIFRoZSBtb2R1bGUgY2FjaGUKLyoqKioqKi8gCXZhciBpbnN0YWxsZWRNb2R1bGVzID0ge307Ci8qKioqKiovCi8qKioqKiovIAkvLyBUaGUgcmVxdWlyZSBmdW5jdGlvbgovKioqKioqLyAJZnVuY3Rpb24gX193ZWJwYWNrX3JlcXVpcmVfXyhtb2R1bGVJZCkgewovKioqKioqLwovKioqKioqLyAJCS8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZQovKioqKioqLyAJCWlmKGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdKQovKioqKioqLyAJCQlyZXR1cm4gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0uZXhwb3J0czsKLyoqKioqKi8KLyoqKioqKi8gCQkvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIChhbmQgcHV0IGl0IGludG8gdGhlIGNhY2hlKQovKioqKioqLyAJCXZhciBtb2R1bGUgPSBpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXSA9IHsKLyoqKioqKi8gCQkJZXhwb3J0czoge30sCi8qKioqKiovIAkJCWlkOiBtb2R1bGVJZCwKLyoqKioqKi8gCQkJbG9hZGVkOiBmYWxzZQovKioqKioqLyAJCX07Ci8qKioqKiovCi8qKioqKiovIAkJLy8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uCi8qKioqKiovIAkJbW9kdWxlc1ttb2R1bGVJZF0uY2FsbChtb2R1bGUuZXhwb3J0cywgbW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7Ci8qKioqKiovCi8qKioqKiovIAkJLy8gRmxhZyB0aGUgbW9kdWxlIGFzIGxvYWRlZAovKioqKioqLyAJCW1vZHVsZS5sb2FkZWQgPSB0cnVlOwovKioqKioqLwovKioqKioqLyAJCS8vIFJldHVybiB0aGUgZXhwb3J0cyBvZiB0aGUgbW9kdWxlCi8qKioqKiovIAkJcmV0dXJuIG1vZHVsZS5leHBvcnRzOwovKioqKioqLyAJfQovKioqKioqLwovKioqKioqLwovKioqKioqLyAJLy8gZXhwb3NlIHRoZSBtb2R1bGVzIG9iamVjdCAoX193ZWJwYWNrX21vZHVsZXNfXykKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18ubSA9IG1vZHVsZXM7Ci8qKioqKiovCi8qKioqKiovIAkvLyBleHBvc2UgdGhlIG1vZHVsZSBjYWNoZQovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXy5jID0gaW5zdGFsbGVkTW9kdWxlczsKLyoqKioqKi8KLyoqKioqKi8gCS8vIF9fd2VicGFja19wdWJsaWNfcGF0aF9fCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fLnAgPSAiIjsKLyoqKioqKi8KLyoqKioqKi8gCS8vIExvYWQgZW50cnkgbW9kdWxlIGFuZCByZXR1cm4gZXhwb3J0cwovKioqKioqLyAJcmV0dXJuIF9fd2VicGFja19yZXF1aXJlX18oMCk7Ci8qKioqKiovIH0pCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIChbCi8qIDAgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJX193ZWJwYWNrX3JlcXVpcmVfXygxKTsKCV9fd2VicGFja19yZXF1aXJlX18oMik7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOwoJX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsKCV9fd2VicGFja19yZXF1aXJlX18oNSk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDYpOwoJX193ZWJwYWNrX3JlcXVpcmVfXyg3KTsKCV9fd2VicGFja19yZXF1aXJlX18oOCk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDkpOwoJX193ZWJwYWNrX3JlcXVpcmVfXygxMCk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDExKTsKCV9fd2VicGFja19yZXF1aXJlX18oMTIpOwoJX193ZWJwYWNrX3JlcXVpcmVfXygxMyk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDE1KTsKCV9fd2VicGFja19yZXF1aXJlX18oMTYpOwoJX193ZWJwYWNrX3JlcXVpcmVfXygxNyk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDE4KTsKCV9fd2VicGFja19yZXF1aXJlX18oMTkpOwoJbW9kdWxlLmV4cG9ydHMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE0KTsKCgovKioqLyB9LAovKiAxICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIENPTVBBUkVfQVNDRU5ESU5HLCBDT01QQVJFX0RFU0NFTkRJTkcsIENPTVBBUkVfRVFVQUwsIEtFWVNfUFVCTElTSCwga2IsIGtvLCBfLCBfcmVmLAoJICBfX2JpbmQgPSBmdW5jdGlvbihmbiwgbWUpeyByZXR1cm4gZnVuY3Rpb24oKXsgcmV0dXJuIGZuLmFwcGx5KG1lLCBhcmd1bWVudHMpOyB9OyB9LAoJICBfX2luZGV4T2YgPSBbXS5pbmRleE9mIHx8IGZ1bmN0aW9uKGl0ZW0pIHsgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKykgeyBpZiAoaSBpbiB0aGlzICYmIHRoaXNbaV0gPT09IGl0ZW0pIHJldHVybiBpOyB9IHJldHVybiAtMTsgfTsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJQ09NUEFSRV9FUVVBTCA9IDA7CgoJQ09NUEFSRV9BU0NFTkRJTkcgPSAtMTsKCglDT01QQVJFX0RFU0NFTkRJTkcgPSAxOwoKCUtFWVNfUFVCTElTSCA9IFsnZGVzdHJveScsICdzaGFyZU9wdGlvbnMnLCAnZmlsdGVycycsICdjb21wYXJhdG9yJywgJ3NvcnRBdHRyaWJ1dGUnLCAndmlld01vZGVsQnlNb2RlbCcsICdoYXNWaWV3TW9kZWxzJ107CgoJa2IuY29tcGFyZSA9IGZ1bmN0aW9uKHZhbHVlX2EsIHZhbHVlX2IpIHsKCSAgaWYgKF8uaXNTdHJpbmcodmFsdWVfYSkpIHsKCSAgICByZXR1cm4gdmFsdWVfYS5sb2NhbGVDb21wYXJlKCIiICsgdmFsdWVfYik7CgkgIH0KCSAgaWYgKF8uaXNTdHJpbmcodmFsdWVfYikpIHsKCSAgICByZXR1cm4gdmFsdWVfYi5sb2NhbGVDb21wYXJlKCIiICsgdmFsdWVfYSk7CgkgIH0KCSAgaWYgKHZhbHVlX2EgPT09IHZhbHVlX2IpIHsKCSAgICByZXR1cm4gQ09NUEFSRV9FUVVBTDsKCSAgfSBlbHNlIHsKCSAgICBpZiAodmFsdWVfYSA8IHZhbHVlX2IpIHsKCSAgICAgIHJldHVybiBDT01QQVJFX0FTQ0VORElORzsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIENPTVBBUkVfREVTQ0VORElORzsKCSAgICB9CgkgIH0KCX07CgoJa2IuQ29sbGVjdGlvbk9ic2VydmFibGUgPSAoZnVuY3Rpb24oKSB7CgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLmV4dGVuZCA9IGtiLmV4dGVuZDsKCgkgIGZ1bmN0aW9uIENvbGxlY3Rpb25PYnNlcnZhYmxlKGNvbGxlY3Rpb24sIHZpZXdfbW9kZWwsIG9wdGlvbnMpIHsKCSAgICB0aGlzLl9vbkNvbGxlY3Rpb25DaGFuZ2UgPSBfX2JpbmQodGhpcy5fb25Db2xsZWN0aW9uQ2hhbmdlLCB0aGlzKTsKCSAgICB2YXIgYXJnczsKCSAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoXy5pc0FyZ3VtZW50cyhjb2xsZWN0aW9uKSA/IGNvbGxlY3Rpb24gOiBhcmd1bWVudHMpOwoJICAgIHJldHVybiBrYi5pZ25vcmUoKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgIHZhciBhcmcsIGNyZWF0ZV9vcHRpb25zLCBvYnNlcnZhYmxlLCBfaSwgX2xlbjsKCSAgICAgICAgY29sbGVjdGlvbiA9IGFyZ3NbMF0gaW5zdGFuY2VvZiBrYi5Db2xsZWN0aW9uID8gYXJncy5zaGlmdCgpIDogKF8uaXNBcnJheShhcmdzWzBdKSA/IG5ldyBrYi5Db2xsZWN0aW9uKGFyZ3Muc2hpZnQoKSkgOiBuZXcga2IuQ29sbGVjdGlvbigpKTsKCSAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihhcmdzWzBdKSkgewoJICAgICAgICAgIGFyZ3NbMF0gPSB7CgkgICAgICAgICAgICB2aWV3X21vZGVsOiBhcmdzWzBdCgkgICAgICAgICAgfTsKCSAgICAgICAgfQoJICAgICAgICBvcHRpb25zID0ge307CgkgICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gYXJncy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgICAgIGFyZyA9IGFyZ3NbX2ldOwoJICAgICAgICAgIF8uZXh0ZW5kKG9wdGlvbnMsIGFyZyk7CgkgICAgICAgIH0KCSAgICAgICAgb2JzZXJ2YWJsZSA9IGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKF90aGlzLCBrby5vYnNlcnZhYmxlQXJyYXkoW10pKTsKCSAgICAgICAgb2JzZXJ2YWJsZS5fX2tiX2lzX2NvID0gdHJ1ZTsKCSAgICAgICAgX3RoaXMuaW5fZWRpdCA9IDA7CgkgICAgICAgIF90aGlzLl9fa2IgfHwgKF90aGlzLl9fa2IgPSB7fSk7CgkgICAgICAgIG9wdGlvbnMgPSBrYi51dGlscy5jb2xsYXBzZU9wdGlvbnMob3B0aW9ucyk7CgkgICAgICAgIGlmIChvcHRpb25zLmF1dG9fY29tcGFjdCkgewoJICAgICAgICAgIF90aGlzLmF1dG9fY29tcGFjdCA9IHRydWU7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKG9wdGlvbnMuc29ydF9hdHRyaWJ1dGUpIHsKCSAgICAgICAgICBfdGhpcy5fY29tcGFyYXRvciA9IGtvLm9ic2VydmFibGUoX3RoaXMuX2F0dHJpYnV0ZUNvbXBhcmF0b3Iob3B0aW9ucy5zb3J0X2F0dHJpYnV0ZSkpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIF90aGlzLl9jb21wYXJhdG9yID0ga28ub2JzZXJ2YWJsZShvcHRpb25zLmNvbXBhcmF0b3IpOwoJICAgICAgICB9CgkgICAgICAgIGlmIChvcHRpb25zLmZpbHRlcnMpIHsKCSAgICAgICAgICBfdGhpcy5fZmlsdGVycyA9IGtvLm9ic2VydmFibGVBcnJheShfLmlzQXJyYXkob3B0aW9ucy5maWx0ZXJzKSA/IG9wdGlvbnMuZmlsdGVycyA6IG9wdGlvbnMuZmlsdGVycyA/IFtvcHRpb25zLmZpbHRlcnNdIDogdm9pZCAwKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICBfdGhpcy5fZmlsdGVycyA9IGtvLm9ic2VydmFibGVBcnJheShbXSk7CgkgICAgICAgIH0KCSAgICAgICAgY3JlYXRlX29wdGlvbnMgPSBfdGhpcy5jcmVhdGVfb3B0aW9ucyA9IHsKCSAgICAgICAgICBzdG9yZToga2IuU3RvcmUudXNlT3B0aW9uc09yQ3JlYXRlKG9wdGlvbnMsIGNvbGxlY3Rpb24sIG9ic2VydmFibGUpCgkgICAgICAgIH07CgkgICAgICAgIGtiLnV0aWxzLndyYXBwZWRPYmplY3Qob2JzZXJ2YWJsZSwgY29sbGVjdGlvbik7CgkgICAgICAgIF90aGlzLnBhdGggPSBvcHRpb25zLnBhdGg7CgkgICAgICAgIGNyZWF0ZV9vcHRpb25zLmZhY3RvcnkgPSBrYi51dGlscy53cmFwcGVkRmFjdG9yeShvYnNlcnZhYmxlLCBfdGhpcy5fc2hhcmVPckNyZWF0ZUZhY3Rvcnkob3B0aW9ucykpOwoJICAgICAgICBjcmVhdGVfb3B0aW9ucy5wYXRoID0ga2IudXRpbHMucGF0aEpvaW4ob3B0aW9ucy5wYXRoLCAnbW9kZWxzJyk7CgkgICAgICAgIGNyZWF0ZV9vcHRpb25zLmNyZWF0b3IgPSBjcmVhdGVfb3B0aW9ucy5mYWN0b3J5LmNyZWF0b3JGb3JQYXRoKG51bGwsIGNyZWF0ZV9vcHRpb25zLnBhdGgpOwoJICAgICAgICBpZiAoY3JlYXRlX29wdGlvbnMuY3JlYXRvcikgewoJICAgICAgICAgIF90aGlzLm1vZGVsc19vbmx5ID0gY3JlYXRlX29wdGlvbnMuY3JlYXRvci5tb2RlbHNfb25seTsKCSAgICAgICAgfQoJICAgICAgICBrYi5wdWJsaXNoTWV0aG9kcyhvYnNlcnZhYmxlLCBfdGhpcywgS0VZU19QVUJMSVNIKTsKCSAgICAgICAgX3RoaXMuX2NvbGxlY3Rpb24gPSBrby5vYnNlcnZhYmxlKGNvbGxlY3Rpb24pOwoJICAgICAgICBvYnNlcnZhYmxlLmNvbGxlY3Rpb24gPSBfdGhpcy5jb2xsZWN0aW9uID0ga28uY29tcHV0ZWQoewoJICAgICAgICAgIHJlYWQ6IGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9jb2xsZWN0aW9uKCk7CgkgICAgICAgICAgfSwKCSAgICAgICAgICB3cml0ZTogZnVuY3Rpb24obmV3X2NvbGxlY3Rpb24pIHsKCSAgICAgICAgICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgIHZhciBwcmV2aW91c19jb2xsZWN0aW9uOwoJICAgICAgICAgICAgICBpZiAoKHByZXZpb3VzX2NvbGxlY3Rpb24gPSBfdGhpcy5fY29sbGVjdGlvbigpKSA9PT0gbmV3X2NvbGxlY3Rpb24pIHsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAga2IudXRpbHMud3JhcHBlZE9iamVjdChvYnNlcnZhYmxlLCBuZXdfY29sbGVjdGlvbik7CgkgICAgICAgICAgICAgIGlmIChwcmV2aW91c19jb2xsZWN0aW9uKSB7CgkgICAgICAgICAgICAgICAgcHJldmlvdXNfY29sbGVjdGlvbi51bmJpbmQoJ2FsbCcsIF90aGlzLl9vbkNvbGxlY3Rpb25DaGFuZ2UpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIGlmIChuZXdfY29sbGVjdGlvbikgewoJICAgICAgICAgICAgICAgIG5ld19jb2xsZWN0aW9uLmJpbmQoJ2FsbCcsIF90aGlzLl9vbkNvbGxlY3Rpb25DaGFuZ2UpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5fY29sbGVjdGlvbihuZXdfY29sbGVjdGlvbik7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgICAgICBpZiAoY29sbGVjdGlvbikgewoJICAgICAgICAgIGNvbGxlY3Rpb24uYmluZCgnYWxsJywgX3RoaXMuX29uQ29sbGVjdGlvbkNoYW5nZSk7CgkgICAgICAgIH0KCSAgICAgICAgX3RoaXMuX21hcHBlciA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgICAgICAgIHZhciBjb21wYXJhdG9yLCBjdXJyZW50X2NvbGxlY3Rpb24sIGZpbHRlciwgZmlsdGVycywgbW9kZWxzLCBwcmV2aW91c192aWV3X21vZGVscywgdmlld19tb2RlbHMsIF9qLCBfbGVuMTsKCSAgICAgICAgICBjb21wYXJhdG9yID0gX3RoaXMuX2NvbXBhcmF0b3IoKTsKCSAgICAgICAgICBmaWx0ZXJzID0gX3RoaXMuX2ZpbHRlcnMoKTsKCSAgICAgICAgICBpZiAoZmlsdGVycykgewoJICAgICAgICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gZmlsdGVycy5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKCSAgICAgICAgICAgICAgZmlsdGVyID0gZmlsdGVyc1tfal07CgkgICAgICAgICAgICAgIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoZmlsdGVyKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICB9CgkgICAgICAgICAgY3VycmVudF9jb2xsZWN0aW9uID0gX3RoaXMuX2NvbGxlY3Rpb24oKTsKCSAgICAgICAgICBpZiAoX3RoaXMuaW5fZWRpdCkgewoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgIH0KCSAgICAgICAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUoX3RoaXMpOwoJICAgICAgICAgIHByZXZpb3VzX3ZpZXdfbW9kZWxzID0ga2IucGVlayhvYnNlcnZhYmxlKTsKCSAgICAgICAgICBpZiAoY3VycmVudF9jb2xsZWN0aW9uKSB7CgkgICAgICAgICAgICBtb2RlbHMgPSBjdXJyZW50X2NvbGxlY3Rpb24ubW9kZWxzOwoJICAgICAgICAgIH0KCSAgICAgICAgICBpZiAoIW1vZGVscyB8fCAoY3VycmVudF9jb2xsZWN0aW9uLm1vZGVscy5sZW5ndGggPT09IDApKSB7CgkgICAgICAgICAgICB2aWV3X21vZGVscyA9IFtdOwoJICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBtb2RlbHMgPSBfLmZpbHRlcihtb2RlbHMsIGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAgICAgICAgIHJldHVybiAhZmlsdGVycy5sZW5ndGggfHwgX3RoaXMuX3NlbGVjdE1vZGVsKG1vZGVsKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgaWYgKGNvbXBhcmF0b3IpIHsKCSAgICAgICAgICAgICAgdmlld19tb2RlbHMgPSBfLm1hcChtb2RlbHMsIGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9jcmVhdGVWaWV3TW9kZWwobW9kZWwpOwoJICAgICAgICAgICAgICB9KS5zb3J0KGNvbXBhcmF0b3IpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgaWYgKF90aGlzLm1vZGVsc19vbmx5KSB7CgkgICAgICAgICAgICAgICAgdmlld19tb2RlbHMgPSBmaWx0ZXJzLmxlbmd0aCA/IG1vZGVscyA6IG1vZGVscy5zbGljZSgpOwoJICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIHZpZXdfbW9kZWxzID0gXy5tYXAobW9kZWxzLCBmdW5jdGlvbihtb2RlbCkgewoJICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9jcmVhdGVWaWV3TW9kZWwobW9kZWwpOwoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgfQoJICAgICAgICAgIF90aGlzLmluX2VkaXQrKzsKCSAgICAgICAgICBvYnNlcnZhYmxlKHZpZXdfbW9kZWxzKTsKCSAgICAgICAgICBfdGhpcy5pbl9lZGl0LS07CgkgICAgICAgIH0pOwoJICAgICAgICBvYnNlcnZhYmxlLnN1YnNjcmliZShfLmJpbmQoX3RoaXMuX29uT2JzZXJ2YWJsZUFycmF5Q2hhbmdlLCBfdGhpcykpOwoJICAgICAgICAha2Iuc3RhdGlzdGljcyB8fCBrYi5zdGF0aXN0aWNzLnJlZ2lzdGVyKCdDb2xsZWN0aW9uT2JzZXJ2YWJsZScsIF90aGlzKTsKCSAgICAgICAgcmV0dXJuIG9ic2VydmFibGU7CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKTsKCSAgfQoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgYXJyYXksIGNvbGxlY3Rpb24sIG9ic2VydmFibGU7CgkgICAgdGhpcy5fX2tiX3JlbGVhc2VkID0gdHJ1ZTsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcyk7CgkgICAgY29sbGVjdGlvbiA9IGtiLnBlZWsodGhpcy5fY29sbGVjdGlvbik7CgkgICAga2IudXRpbHMud3JhcHBlZE9iamVjdChvYnNlcnZhYmxlLCBudWxsKTsKCSAgICBpZiAoY29sbGVjdGlvbikgewoJICAgICAgY29sbGVjdGlvbi51bmJpbmQoJ2FsbCcsIHRoaXMuX29uQ29sbGVjdGlvbkNoYW5nZSk7CgkgICAgICBhcnJheSA9IGtiLnBlZWsob2JzZXJ2YWJsZSk7CgkgICAgICBhcnJheS5zcGxpY2UoMCwgYXJyYXkubGVuZ3RoKTsKCSAgICB9CgkgICAgdGhpcy5jb2xsZWN0aW9uLmRpc3Bvc2UoKTsKCSAgICB0aGlzLl9jb2xsZWN0aW9uID0gb2JzZXJ2YWJsZS5jb2xsZWN0aW9uID0gdGhpcy5jb2xsZWN0aW9uID0gbnVsbDsKCSAgICB0aGlzLl9tYXBwZXIuZGlzcG9zZSgpOwoJICAgIHRoaXMuX21hcHBlciA9IG51bGw7CgkgICAga2IucmVsZWFzZSh0aGlzLl9maWx0ZXJzKTsKCSAgICB0aGlzLl9maWx0ZXJzID0gbnVsbDsKCSAgICB0aGlzLl9jb21wYXJhdG9yKG51bGwpOwoJICAgIHRoaXMuX2NvbXBhcmF0b3IgPSBudWxsOwoJICAgIHRoaXMuY3JlYXRlX29wdGlvbnMgPSBudWxsOwoJICAgIG9ic2VydmFibGUuY29sbGVjdGlvbiA9IG51bGw7CgkgICAga2IudXRpbHMud3JhcHBlZERlc3Ryb3kodGhpcyk7CgkgICAgcmV0dXJuICFrYi5zdGF0aXN0aWNzIHx8IGtiLnN0YXRpc3RpY3MudW5yZWdpc3RlcignQ29sbGVjdGlvbk9ic2VydmFibGUnLCB0aGlzKTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5zaGFyZU9wdGlvbnMgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgb2JzZXJ2YWJsZTsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcyk7CgkgICAgcmV0dXJuIHsKCSAgICAgIHN0b3JlOiBrYi51dGlscy53cmFwcGVkU3RvcmUob2JzZXJ2YWJsZSksCgkgICAgICBmYWN0b3J5OiBrYi51dGlscy53cmFwcGVkRmFjdG9yeShvYnNlcnZhYmxlKQoJICAgIH07CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuZmlsdGVycyA9IGZ1bmN0aW9uKGZpbHRlcnMpIHsKCSAgICBpZiAoZmlsdGVycykgewoJICAgICAgcmV0dXJuIHRoaXMuX2ZpbHRlcnMoXy5pc0FycmF5KGZpbHRlcnMpID8gZmlsdGVycyA6IFtmaWx0ZXJzXSk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiB0aGlzLl9maWx0ZXJzKFtdKTsKCSAgICB9CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuY29tcGFyYXRvciA9IGZ1bmN0aW9uKGNvbXBhcmF0b3IpIHsKCSAgICByZXR1cm4gdGhpcy5fY29tcGFyYXRvcihjb21wYXJhdG9yKTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5zb3J0QXR0cmlidXRlID0gZnVuY3Rpb24oc29ydF9hdHRyaWJ1dGUpIHsKCSAgICByZXR1cm4gdGhpcy5fY29tcGFyYXRvcihzb3J0X2F0dHJpYnV0ZSA/IHRoaXMuX2F0dHJpYnV0ZUNvbXBhcmF0b3Ioc29ydF9hdHRyaWJ1dGUpIDogbnVsbCk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUudmlld01vZGVsQnlNb2RlbCA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgdmFyIGlkX2F0dHJpYnV0ZTsKCSAgICBpZiAodGhpcy5tb2RlbHNfb25seSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIGlkX2F0dHJpYnV0ZSA9IG1vZGVsLmhhc093blByb3BlcnR5KG1vZGVsLmlkQXR0cmlidXRlKSA/IG1vZGVsLmlkQXR0cmlidXRlIDogJ2NpZCc7CgkgICAgcmV0dXJuIF8uZmluZChrYi5wZWVrKGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKHRoaXMpKSwgZnVuY3Rpb24odGVzdCkgewoJICAgICAgdmFyIF9yZWYxOwoJICAgICAgaWYgKHRlc3QgIT0gbnVsbCA/IChfcmVmMSA9IHRlc3QuX19rYikgIT0gbnVsbCA/IF9yZWYxLm9iamVjdCA6IHZvaWQgMCA6IHZvaWQgMCkgewoJICAgICAgICByZXR1cm4gdGVzdC5fX2tiLm9iamVjdFtpZF9hdHRyaWJ1dGVdID09PSBtb2RlbFtpZF9hdHRyaWJ1dGVdOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgfQoJICAgIH0pOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLmhhc1ZpZXdNb2RlbHMgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gIXRoaXMubW9kZWxzX29ubHk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuY29tcGFjdCA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBrYi5pZ25vcmUoKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgIHZhciBvYnNlcnZhYmxlOwoJICAgICAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUoX3RoaXMpOwoJICAgICAgICBpZiAoIWtiLnV0aWxzLndyYXBwZWRTdG9yZUlzT3duZWQob2JzZXJ2YWJsZSkpIHsKCSAgICAgICAgICByZXR1cm47CgkgICAgICAgIH0KCSAgICAgICAga2IudXRpbHMud3JhcHBlZFN0b3JlKG9ic2VydmFibGUpLmNsZWFyKCk7CgkgICAgICAgIHJldHVybiBfdGhpcy5fY29sbGVjdGlvbi5ub3RpZnlTdWJzY3JpYmVycyhfdGhpcy5fY29sbGVjdGlvbigpKTsKCSAgICAgIH07CgkgICAgfSkodGhpcykpOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLl9zaGFyZU9yQ3JlYXRlRmFjdG9yeSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICB2YXIgYWJzb2x1dGVfbW9kZWxzX3BhdGgsIGV4aXN0aW5nX2NyZWF0b3IsIGZhY3RvcmllcywgZmFjdG9yeTsKCSAgICBhYnNvbHV0ZV9tb2RlbHNfcGF0aCA9IGtiLnV0aWxzLnBhdGhKb2luKG9wdGlvbnMucGF0aCwgJ21vZGVscycpOwoJICAgIGZhY3RvcmllcyA9IG9wdGlvbnMuZmFjdG9yaWVzOwoJICAgIGlmICgoZmFjdG9yeSA9IG9wdGlvbnMuZmFjdG9yeSkpIHsKCSAgICAgIGlmICgoZXhpc3RpbmdfY3JlYXRvciA9IGZhY3RvcnkuY3JlYXRvckZvclBhdGgobnVsbCwgYWJzb2x1dGVfbW9kZWxzX3BhdGgpKSAmJiAoIWZhY3RvcmllcyB8fCAoZmFjdG9yaWVzWydtb2RlbHMnXSA9PT0gZXhpc3RpbmdfY3JlYXRvcikpKSB7CgkgICAgICAgIGlmICghZmFjdG9yaWVzKSB7CgkgICAgICAgICAgcmV0dXJuIGZhY3Rvcnk7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKGZhY3RvcnkuaGFzUGF0aE1hcHBpbmdzKGZhY3Rvcmllcywgb3B0aW9ucy5wYXRoKSkgewoJICAgICAgICAgIHJldHVybiBmYWN0b3J5OwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICAgIGZhY3RvcnkgPSBuZXcga2IuRmFjdG9yeShvcHRpb25zLmZhY3RvcnkpOwoJICAgIGlmIChmYWN0b3JpZXMpIHsKCSAgICAgIGZhY3RvcnkuYWRkUGF0aE1hcHBpbmdzKGZhY3Rvcmllcywgb3B0aW9ucy5wYXRoKTsKCSAgICB9CgkgICAgaWYgKCFmYWN0b3J5LmNyZWF0b3JGb3JQYXRoKG51bGwsIGFic29sdXRlX21vZGVsc19wYXRoKSkgewoJICAgICAgaWYgKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ21vZGVsc19vbmx5JykpIHsKCSAgICAgICAgaWYgKG9wdGlvbnMubW9kZWxzX29ubHkpIHsKCSAgICAgICAgICBmYWN0b3J5LmFkZFBhdGhNYXBwaW5nKGFic29sdXRlX21vZGVsc19wYXRoLCB7CgkgICAgICAgICAgICBtb2RlbHNfb25seTogdHJ1ZQoJICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIGZhY3RvcnkuYWRkUGF0aE1hcHBpbmcoYWJzb2x1dGVfbW9kZWxzX3BhdGgsIGtiLlZpZXdNb2RlbCk7CgkgICAgICAgIH0KCSAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy52aWV3X21vZGVsKSB7CgkgICAgICAgIGZhY3RvcnkuYWRkUGF0aE1hcHBpbmcoYWJzb2x1dGVfbW9kZWxzX3BhdGgsIG9wdGlvbnMudmlld19tb2RlbCk7CgkgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMuY3JlYXRlKSB7CgkgICAgICAgIGZhY3RvcnkuYWRkUGF0aE1hcHBpbmcoYWJzb2x1dGVfbW9kZWxzX3BhdGgsIHsKCSAgICAgICAgICBjcmVhdGU6IG9wdGlvbnMuY3JlYXRlCgkgICAgICAgIH0pOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgZmFjdG9yeS5hZGRQYXRoTWFwcGluZyhhYnNvbHV0ZV9tb2RlbHNfcGF0aCwga2IuVmlld01vZGVsKTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIGZhY3Rvcnk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuX29uQ29sbGVjdGlvbkNoYW5nZSA9IGZ1bmN0aW9uKGV2ZW50LCBhcmcpIHsKCSAgICByZXR1cm4ga2IuaWdub3JlKChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgY29sbGVjdGlvbiwgY29tcGFyYXRvciwgb2JzZXJ2YWJsZSwgdmlld19tb2RlbDsKCSAgICAgICAgaWYgKF90aGlzLmluX2VkaXQpIHsKCSAgICAgICAgICByZXR1cm47CgkgICAgICAgIH0KCSAgICAgICAgc3dpdGNoIChldmVudCkgewoJICAgICAgICAgIGNhc2UgJ3Jlc2V0JzoKCSAgICAgICAgICAgIGlmIChfdGhpcy5hdXRvX2NvbXBhY3QpIHsKCSAgICAgICAgICAgICAgX3RoaXMuY29tcGFjdCgpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgX3RoaXMuX2NvbGxlY3Rpb24ubm90aWZ5U3Vic2NyaWJlcnMoX3RoaXMuX2NvbGxlY3Rpb24oKSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICBjYXNlICdzb3J0JzoKCSAgICAgICAgICBjYXNlICdyZXNvcnQnOgoJICAgICAgICAgICAgX3RoaXMuX2NvbGxlY3Rpb24ubm90aWZ5U3Vic2NyaWJlcnMoX3RoaXMuX2NvbGxlY3Rpb24oKSk7CgkgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICBjYXNlICduZXcnOgoJICAgICAgICAgIGNhc2UgJ2FkZCc6CgkgICAgICAgICAgICBpZiAoIV90aGlzLl9zZWxlY3RNb2RlbChhcmcpKSB7CgkgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZShfdGhpcyk7CgkgICAgICAgICAgICBjb2xsZWN0aW9uID0gX3RoaXMuX2NvbGxlY3Rpb24oKTsKCSAgICAgICAgICAgIGlmIChjb2xsZWN0aW9uLmluZGV4T2YoYXJnKSA9PT0gLTEpIHsKCSAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKCh2aWV3X21vZGVsID0gX3RoaXMudmlld01vZGVsQnlNb2RlbChhcmcpKSkgewoJICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBfdGhpcy5pbl9lZGl0Kys7CgkgICAgICAgICAgICBpZiAoKGNvbXBhcmF0b3IgPSBfdGhpcy5fY29tcGFyYXRvcigpKSkgewoJICAgICAgICAgICAgICBvYnNlcnZhYmxlKCkucHVzaChfdGhpcy5fY3JlYXRlVmlld01vZGVsKGFyZykpOwoJICAgICAgICAgICAgICBvYnNlcnZhYmxlLnNvcnQoY29tcGFyYXRvcik7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICBvYnNlcnZhYmxlLnNwbGljZShjb2xsZWN0aW9uLmluZGV4T2YoYXJnKSwgMCwgX3RoaXMuX2NyZWF0ZVZpZXdNb2RlbChhcmcpKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIF90aGlzLmluX2VkaXQtLTsKCSAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgIGNhc2UgJ3JlbW92ZSc6CgkgICAgICAgICAgY2FzZSAnZGVzdHJveSc6CgkgICAgICAgICAgICBfdGhpcy5fb25Nb2RlbFJlbW92ZShhcmcpOwoJICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgY2FzZSAnY2hhbmdlJzoKCSAgICAgICAgICAgIGlmICghX3RoaXMuX3NlbGVjdE1vZGVsKGFyZykpIHsKCSAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9vbk1vZGVsUmVtb3ZlKGFyZyk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICB2aWV3X21vZGVsID0gX3RoaXMubW9kZWxzX29ubHkgPyBhcmcgOiBfdGhpcy52aWV3TW9kZWxCeU1vZGVsKGFyZyk7CgkgICAgICAgICAgICBpZiAoIXZpZXdfbW9kZWwpIHsKCSAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9vbkNvbGxlY3Rpb25DaGFuZ2UoJ2FkZCcsIGFyZyk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAoIShjb21wYXJhdG9yID0gX3RoaXMuX2NvbXBhcmF0b3IoKSkpIHsKCSAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgX3RoaXMuaW5fZWRpdCsrOwoJICAgICAgICAgICAga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUoX3RoaXMpLnNvcnQoY29tcGFyYXRvcik7CgkgICAgICAgICAgICBfdGhpcy5pbl9lZGl0LS07CgkgICAgICAgIH0KCSAgICAgIH07CgkgICAgfSkodGhpcykpOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLl9vbk1vZGVsUmVtb3ZlID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICB2YXIgb2JzZXJ2YWJsZSwgdmlld19tb2RlbDsKCSAgICB2aWV3X21vZGVsID0gdGhpcy5tb2RlbHNfb25seSA/IG1vZGVsIDogdGhpcy52aWV3TW9kZWxCeU1vZGVsKG1vZGVsKTsKCSAgICBpZiAoIXZpZXdfbW9kZWwpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgb2JzZXJ2YWJsZSA9IGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKHRoaXMpOwoJICAgIHRoaXMuaW5fZWRpdCsrOwoJICAgIG9ic2VydmFibGUucmVtb3ZlKHZpZXdfbW9kZWwpOwoJICAgIHJldHVybiB0aGlzLmluX2VkaXQtLTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5fb25PYnNlcnZhYmxlQXJyYXlDaGFuZ2UgPSBmdW5jdGlvbihtb2RlbHNfb3Jfdmlld19tb2RlbHMpIHsKCSAgICByZXR1cm4ga2IuaWdub3JlKChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgY29sbGVjdGlvbiwgY3VycmVudF92aWV3X21vZGVsLCBoYXNfZmlsdGVycywgbW9kZWwsIG1vZGVscywgb2JzZXJ2YWJsZSwgdmlld19tb2RlbCwgdmlld19tb2RlbHMsIF9pLCBfbGVuOwoJICAgICAgICBpZiAoX3RoaXMuaW5fZWRpdCkgewoJICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgICAgICAoX3RoaXMubW9kZWxzX29ubHkgJiYgKCFtb2RlbHNfb3Jfdmlld19tb2RlbHMubGVuZ3RoIHx8IGtiLmlzTW9kZWwobW9kZWxzX29yX3ZpZXdfbW9kZWxzWzBdKSkpIHx8ICghX3RoaXMubW9kZWxzX29ubHkgJiYgKCFtb2RlbHNfb3Jfdmlld19tb2RlbHMubGVuZ3RoIHx8IChfLmlzT2JqZWN0KG1vZGVsc19vcl92aWV3X21vZGVsc1swXSkgJiYgIWtiLmlzTW9kZWwobW9kZWxzX29yX3ZpZXdfbW9kZWxzWzBdKSkpKSB8fCBrYi5fdGhyb3dVbmV4cGVjdGVkKF90aGlzLCAnaW5jb3JyZWN0IHR5cGUgcGFzc2VkJyk7CgkgICAgICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZShfdGhpcyk7CgkgICAgICAgIGNvbGxlY3Rpb24gPSBrYi5wZWVrKF90aGlzLl9jb2xsZWN0aW9uKTsKCSAgICAgICAgaGFzX2ZpbHRlcnMgPSBrYi5wZWVrKF90aGlzLl9maWx0ZXJzKS5sZW5ndGg7CgkgICAgICAgIGlmICghY29sbGVjdGlvbikgewoJICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgICAgICB2aWV3X21vZGVscyA9IG1vZGVsc19vcl92aWV3X21vZGVsczsKCSAgICAgICAgaWYgKF90aGlzLm1vZGVsc19vbmx5KSB7CgkgICAgICAgICAgbW9kZWxzID0gXy5maWx0ZXIobW9kZWxzX29yX3ZpZXdfbW9kZWxzLCBmdW5jdGlvbihtb2RlbCkgewoJICAgICAgICAgICAgcmV0dXJuICFoYXNfZmlsdGVycyB8fCBfdGhpcy5fc2VsZWN0TW9kZWwobW9kZWwpOwoJICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICFoYXNfZmlsdGVycyB8fCAodmlld19tb2RlbHMgPSBbXSk7CgkgICAgICAgICAgbW9kZWxzID0gW107CgkgICAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBtb2RlbHNfb3Jfdmlld19tb2RlbHMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgICAgICAgIHZpZXdfbW9kZWwgPSBtb2RlbHNfb3Jfdmlld19tb2RlbHNbX2ldOwoJICAgICAgICAgICAgbW9kZWwgPSBrYi51dGlscy53cmFwcGVkT2JqZWN0KHZpZXdfbW9kZWwpOwoJICAgICAgICAgICAgaWYgKGhhc19maWx0ZXJzKSB7CgkgICAgICAgICAgICAgIGlmICghX3RoaXMuX3NlbGVjdE1vZGVsKG1vZGVsKSkgewoJICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIHZpZXdfbW9kZWxzLnB1c2godmlld19tb2RlbCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAoY3VycmVudF92aWV3X21vZGVsID0gX3RoaXMuY3JlYXRlX29wdGlvbnMuc3RvcmUuZmluZChtb2RlbCwgX3RoaXMuY3JlYXRlX29wdGlvbnMuY3JlYXRvcikpIHsKCSAgICAgICAgICAgICAgKGN1cnJlbnRfdmlld19tb2RlbC5jb25zdHJ1Y3RvciA9PT0gdmlld19tb2RlbC5jb25zdHJ1Y3RvcikgfHwga2IuX3Rocm93VW5leHBlY3RlZChfdGhpcywgJ3JlcGxhY2luZyBkaWZmZXJlbnQgdHlwZSBvZiB2aWV3IG1vZGVsJyk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBfdGhpcy5jcmVhdGVfb3B0aW9ucy5zdG9yZS5yZXRhaW4odmlld19tb2RlbCwgbW9kZWwsIF90aGlzLmNyZWF0ZV9vcHRpb25zLmNyZWF0b3IpOwoJICAgICAgICAgICAgbW9kZWxzLnB1c2gobW9kZWwpOwoJICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICBfdGhpcy5pbl9lZGl0Kys7CgkgICAgICAgIChtb2RlbHNfb3Jfdmlld19tb2RlbHMubGVuZ3RoID09PSB2aWV3X21vZGVscy5sZW5ndGgpIHx8IG9ic2VydmFibGUodmlld19tb2RlbHMpOwoJICAgICAgICBfLmlzRXF1YWwoY29sbGVjdGlvbi5tb2RlbHMsIG1vZGVscykgfHwgY29sbGVjdGlvbi5yZXNldChtb2RlbHMpOwoJICAgICAgICBfdGhpcy5pbl9lZGl0LS07CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5fYXR0cmlidXRlQ29tcGFyYXRvciA9IGZ1bmN0aW9uKHNvcnRfYXR0cmlidXRlKSB7CgkgICAgdmFyIG1vZGVsQXR0cmlidXRlQ29tcGFyZTsKCSAgICBtb2RlbEF0dHJpYnV0ZUNvbXBhcmUgPSBmdW5jdGlvbihtb2RlbF9hLCBtb2RlbF9iKSB7CgkgICAgICB2YXIgYXR0cmlidXRlX25hbWU7CgkgICAgICBhdHRyaWJ1dGVfbmFtZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoc29ydF9hdHRyaWJ1dGUpOwoJICAgICAgcmV0dXJuIGtiLmNvbXBhcmUobW9kZWxfYS5nZXQoYXR0cmlidXRlX25hbWUpLCBtb2RlbF9iLmdldChhdHRyaWJ1dGVfbmFtZSkpOwoJICAgIH07CgkgICAgcmV0dXJuICh0aGlzLm1vZGVsc19vbmx5ID8gbW9kZWxBdHRyaWJ1dGVDb21wYXJlIDogZnVuY3Rpb24obW9kZWxfYSwgbW9kZWxfYikgewoJICAgICAgcmV0dXJuIG1vZGVsQXR0cmlidXRlQ29tcGFyZShrYi51dGlscy53cmFwcGVkTW9kZWwobW9kZWxfYSksIGtiLnV0aWxzLndyYXBwZWRNb2RlbChtb2RlbF9iKSk7CgkgICAgfSk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuX2NyZWF0ZVZpZXdNb2RlbCA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgaWYgKHRoaXMubW9kZWxzX29ubHkpIHsKCSAgICAgIHJldHVybiBtb2RlbDsKCSAgICB9CgkgICAgcmV0dXJuIHRoaXMuY3JlYXRlX29wdGlvbnMuc3RvcmUucmV0YWluT3JDcmVhdGUobW9kZWwsIHRoaXMuY3JlYXRlX29wdGlvbnMpOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLl9zZWxlY3RNb2RlbCA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgdmFyIGZpbHRlciwgZmlsdGVycywgX2ksIF9sZW4sIF9yZWYxOwoJICAgIGZpbHRlcnMgPSBrYi5wZWVrKHRoaXMuX2ZpbHRlcnMpOwoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZmlsdGVycy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgZmlsdGVyID0gZmlsdGVyc1tfaV07CgkgICAgICBmaWx0ZXIgPSBrYi5wZWVrKGZpbHRlcik7CgkgICAgICBpZiAoXy5pc0Z1bmN0aW9uKGZpbHRlcikpIHsKCSAgICAgICAgaWYgKCFmaWx0ZXIobW9kZWwpKSB7CgkgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgICB9CgkgICAgICB9IGVsc2UgaWYgKF8uaXNBcnJheShmaWx0ZXIpKSB7CgkgICAgICAgIGlmIChfcmVmMSA9IG1vZGVsLmlkLCBfX2luZGV4T2YuY2FsbChmaWx0ZXIsIF9yZWYxKSA8IDApIHsKCSAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0KCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGlmIChtb2RlbC5pZCAhPT0gZmlsdGVyKSB7CgkgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiB0cnVlOwoJICB9OwoKCSAgcmV0dXJuIENvbGxlY3Rpb25PYnNlcnZhYmxlOwoKCX0pKCk7CgoJa2IuY29sbGVjdGlvbk9ic2VydmFibGUgPSBmdW5jdGlvbihjb2xsZWN0aW9uLCB2aWV3X21vZGVsLCBvcHRpb25zKSB7CgkgIHJldHVybiBuZXcga2IuQ29sbGVjdGlvbk9ic2VydmFibGUoYXJndW1lbnRzKTsKCX07CgoKLyoqKi8gfSwKLyogMiAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgl2YXIgQUxMX09STVMsIGtiLCBrZXksIGtvLCB2YWx1ZSwgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJQUxMX09STVMgPSB7CgkgICJkZWZhdWx0IjogbnVsbCwKCSAgJ2JhY2tib25lLW9ybSc6IG51bGwsCgkgICdiYWNrYm9uZS1hc3NvY2lhdGlvbnMnOiBfX3dlYnBhY2tfcmVxdWlyZV9fKDIzKSwKCSAgJ2JhY2tib25lLXJlbGF0aW9uYWwnOiBfX3dlYnBhY2tfcmVxdWlyZV9fKDI0KSwKCSAgc3VwZXJtb2RlbDogX193ZWJwYWNrX3JlcXVpcmVfXygyNSkKCX07CgoJa2Iub3JtID0gQUxMX09STVNbImRlZmF1bHQiXTsKCglmb3IgKGtleSBpbiBBTExfT1JNUykgewoJICB2YWx1ZSA9IEFMTF9PUk1TW2tleV07CgkgIGlmICh2YWx1ZSAmJiB2YWx1ZS5pc0F2YWlsYWJsZSgpKSB7CgkgICAga2Iub3JtID0gdmFsdWU7CgkgICAgYnJlYWs7CgkgIH0KCX0KCgltb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgdmFyIG9ybTsKCSAgaWYgKG9wdGlvbnMgPT0gbnVsbCkgewoJICAgIG9wdGlvbnMgPSB7fTsKCSAgfQoJICBmb3IgKGtleSBpbiBvcHRpb25zKSB7CgkgICAgdmFsdWUgPSBvcHRpb25zW2tleV07CgkgICAgc3dpdGNoIChrZXkpIHsKCSAgICAgIGNhc2UgJ29ybSc6CgkgICAgICAgIGlmIChfLmlzU3RyaW5nKHZhbHVlKSkgewoJICAgICAgICAgIGlmICghQUxMX09STVMuaGFzT3duUHJvcGVydHkodmFsdWUpKSB7CgkgICAgICAgICAgICBjb25zb2xlLmxvZygiS25vY2tiYWNrIGNvbmZpZ3VyZTogY291bGQgbm90IGZpbmQgb3JtOiAiICsgdmFsdWUgKyAiLiBBdmFpbGFibGU6ICIgKyAoXy5rZXlzKEFMTF9PUk1TKS5qb2luKCcsICcpKSk7CgkgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICB9CgkgICAgICAgICAgaWYgKChvcm0gPSBBTExfT1JNU1t2YWx1ZV0pICYmICFvcm0uaXNBdmFpbGFibGUoKSkgewoJICAgICAgICAgICAgY29uc29sZS5sb2coIktub2NrYmFjayBjb25maWd1cmU6IGNvdWxkIG5vdCBlbmFibGUgb3JtICIgKyB2YWx1ZSArICIuIE1ha2Ugc3VyZSBpdCBpcyBpbmNsdWRlZCBiZWZvcmUgS25vY2tiYWNrIik7CgkgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICB9CgkgICAgICAgICAga2Iub3JtID0gb3JtOwoJICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIGtiLm9ybSA9IHZhbHVlOwoJICAgICAgICB9CgkgICAgICAgIGJyZWFrOwoJICAgICAgZGVmYXVsdDoKCSAgICAgICAga2Jba2V5XSA9IHZhbHVlOwoJICAgIH0KCSAgfQoJfTsKCgovKioqLyB9LAovKiAzICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGtiLCBrbywgXywgX3JlZiwKCSAgX19iaW5kID0gZnVuY3Rpb24oZm4sIG1lKXsgcmV0dXJuIGZ1bmN0aW9uKCl7IHJldHVybiBmbi5hcHBseShtZSwgYXJndW1lbnRzKTsgfTsgfTsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJa2IuRXZlbnRXYXRjaGVyID0gKGZ1bmN0aW9uKCkgewoJICBFdmVudFdhdGNoZXIudXNlT3B0aW9uc09yQ3JlYXRlID0gZnVuY3Rpb24ob3B0aW9ucywgZW1pdHRlciwgb2JqLCBjYWxsYmFja19vcHRpb25zKSB7CgkgICAgaWYgKG9wdGlvbnMuZXZlbnRfd2F0Y2hlcikgewoJICAgICAgaWYgKCEob3B0aW9ucy5ldmVudF93YXRjaGVyLmVtaXR0ZXIoKSA9PT0gZW1pdHRlciB8fCAob3B0aW9ucy5ldmVudF93YXRjaGVyLm1vZGVsX3JlZiA9PT0gZW1pdHRlcikpKSB7CgkgICAgICAgIGtiLl90aHJvd1VuZXhwZWN0ZWQodGhpcywgJ2VtaXR0ZXIgbm90IG1hdGNoaW5nJyk7CgkgICAgICB9CgkgICAgICByZXR1cm4ga2IudXRpbHMud3JhcHBlZEV2ZW50V2F0Y2hlcihvYmosIG9wdGlvbnMuZXZlbnRfd2F0Y2hlcikucmVnaXN0ZXJDYWxsYmFja3Mob2JqLCBjYWxsYmFja19vcHRpb25zKTsKCSAgICB9IGVsc2UgewoJICAgICAga2IudXRpbHMud3JhcHBlZEV2ZW50V2F0Y2hlcklzT3duZWQob2JqLCB0cnVlKTsKCSAgICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkRXZlbnRXYXRjaGVyKG9iaiwgbmV3IGtiLkV2ZW50V2F0Y2hlcihlbWl0dGVyKSkucmVnaXN0ZXJDYWxsYmFja3Mob2JqLCBjYWxsYmFja19vcHRpb25zKTsKCSAgICB9CgkgIH07CgoJICBmdW5jdGlvbiBFdmVudFdhdGNoZXIoZW1pdHRlciwgb2JqLCBjYWxsYmFja19vcHRpb25zKSB7CgkgICAgdGhpcy5fdW5iaW5kQ2FsbGJhY2tzID0gX19iaW5kKHRoaXMuX3VuYmluZENhbGxiYWNrcywgdGhpcyk7CgkgICAgdGhpcy5fb25Nb2RlbFVubG9hZGVkID0gX19iaW5kKHRoaXMuX29uTW9kZWxVbmxvYWRlZCwgdGhpcyk7CgkgICAgdGhpcy5fb25Nb2RlbExvYWRlZCA9IF9fYmluZCh0aGlzLl9vbk1vZGVsTG9hZGVkLCB0aGlzKTsKCSAgICB0aGlzLl9fa2IgfHwgKHRoaXMuX19rYiA9IHt9KTsKCSAgICB0aGlzLl9fa2IuY2FsbGJhY2tzID0ge307CgkgICAgdGhpcy5lZSA9IG51bGw7CgkgICAgaWYgKGNhbGxiYWNrX29wdGlvbnMpIHsKCSAgICAgIHRoaXMucmVnaXN0ZXJDYWxsYmFja3Mob2JqLCBjYWxsYmFja19vcHRpb25zKTsKCSAgICB9CgkgICAgaWYgKGVtaXR0ZXIpIHsKCSAgICAgIHRoaXMuZW1pdHRlcihlbWl0dGVyKTsKCSAgICB9CgkgIH0KCgkgIEV2ZW50V2F0Y2hlci5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIHRoaXMuZW1pdHRlcihudWxsKTsKCSAgICB0aGlzLl9fa2IuY2FsbGJhY2tzID0gbnVsbDsKCSAgICByZXR1cm4ga2IudXRpbHMud3JhcHBlZERlc3Ryb3kodGhpcyk7CgkgIH07CgoJICBFdmVudFdhdGNoZXIucHJvdG90eXBlLmVtaXR0ZXIgPSBmdW5jdGlvbihuZXdfZW1pdHRlcikgewoJICAgIGlmICgoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgfHwgKHRoaXMuZWUgPT09IG5ld19lbWl0dGVyKSkgewoJICAgICAgcmV0dXJuIHRoaXMuZWU7CgkgICAgfQoJICAgIGlmICh0aGlzLm1vZGVsX3JlZikgewoJICAgICAgdGhpcy5tb2RlbF9yZWYudW5iaW5kKCdsb2FkZWQnLCB0aGlzLl9vbk1vZGVsTG9hZGVkKTsKCSAgICAgIHRoaXMubW9kZWxfcmVmLnVuYmluZCgndW5sb2FkZWQnLCB0aGlzLl9vbk1vZGVsVW5sb2FkZWQpOwoJICAgICAgdGhpcy5tb2RlbF9yZWYucmVsZWFzZSgpOwoJICAgICAgdGhpcy5tb2RlbF9yZWYgPSBudWxsOwoJICAgIH0KCSAgICBpZiAoa2IuQmFja2JvbmUgJiYga2IuQmFja2JvbmUuTW9kZWxSZWYgJiYgKG5ld19lbWl0dGVyIGluc3RhbmNlb2Yga2IuQmFja2JvbmUuTW9kZWxSZWYpKSB7CgkgICAgICB0aGlzLm1vZGVsX3JlZiA9IG5ld19lbWl0dGVyOwoJICAgICAgdGhpcy5tb2RlbF9yZWYucmV0YWluKCk7CgkgICAgICB0aGlzLm1vZGVsX3JlZi5iaW5kKCdsb2FkZWQnLCB0aGlzLl9vbk1vZGVsTG9hZGVkKTsKCSAgICAgIHRoaXMubW9kZWxfcmVmLmJpbmQoJ3VubG9hZGVkJywgdGhpcy5fb25Nb2RlbFVubG9hZGVkKTsKCSAgICAgIG5ld19lbWl0dGVyID0gdGhpcy5tb2RlbF9yZWYubW9kZWwoKSB8fCBudWxsOwoJICAgIH0gZWxzZSB7CgkgICAgICBkZWxldGUgdGhpcy5tb2RlbF9yZWY7CgkgICAgfQoJICAgIGlmICh0aGlzLmVlICE9PSBuZXdfZW1pdHRlcikgewoJICAgICAgaWYgKG5ld19lbWl0dGVyKSB7CgkgICAgICAgIHRoaXMuX29uTW9kZWxMb2FkZWQobmV3X2VtaXR0ZXIpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgdGhpcy5fb25Nb2RlbFVubG9hZGVkKHRoaXMuZWUpOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gbmV3X2VtaXR0ZXI7CgkgIH07CgoJICBFdmVudFdhdGNoZXIucHJvdG90eXBlLnJlZ2lzdGVyQ2FsbGJhY2tzID0gZnVuY3Rpb24ob2JqLCBjYWxsYmFja19pbmZvKSB7CgkgICAgdmFyIGV2ZW50X25hbWUsIGV2ZW50X25hbWVzLCBtb2RlbCwgX2ZuLCBfaSwgX2xlbjsKCSAgICBvYmogfHwga2IuX3Rocm93TWlzc2luZyh0aGlzLCAnb2JqJyk7CgkgICAgY2FsbGJhY2tfaW5mbyB8fCBrYi5fdGhyb3dNaXNzaW5nKHRoaXMsICdjYWxsYmFja19pbmZvJyk7CgkgICAgZXZlbnRfbmFtZXMgPSBjYWxsYmFja19pbmZvLmV2ZW50X3NlbGVjdG9yID8gY2FsbGJhY2tfaW5mby5ldmVudF9zZWxlY3Rvci5zcGxpdCgnICcpIDogWydjaGFuZ2UnXTsKCSAgICBtb2RlbCA9IHRoaXMuZWU7CgkgICAgX2ZuID0gKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oZXZlbnRfbmFtZSkgewoJICAgICAgICB2YXIgY2FsbGJhY2tzLCBpbmZvOwoJICAgICAgICBpZiAoIShjYWxsYmFja3MgPSBfdGhpcy5fX2tiLmNhbGxiYWNrc1tldmVudF9uYW1lXSkpIHsKCSAgICAgICAgICBjYWxsYmFja3MgPSBfdGhpcy5fX2tiLmNhbGxiYWNrc1tldmVudF9uYW1lXSA9IHsKCSAgICAgICAgICAgIG1vZGVsOiBudWxsLAoJICAgICAgICAgICAgbGlzdDogW10sCgkgICAgICAgICAgICBmbjogZnVuY3Rpb24obW9kZWwpIHsKCSAgICAgICAgICAgICAgdmFyIGluZm8sIF9qLCBfbGVuMSwgX3JlZjE7CgkgICAgICAgICAgICAgIF9yZWYxID0gY2FsbGJhY2tzLmxpc3Q7CgkgICAgICAgICAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IF9yZWYxLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewoJICAgICAgICAgICAgICAgIGluZm8gPSBfcmVmMVtfal07CgkgICAgICAgICAgICAgICAgaWYgKCFpbmZvLnVwZGF0ZSkgewoJICAgICAgICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGlmIChtb2RlbCAmJiBpbmZvLmtleSAmJiAobW9kZWwuaGFzQ2hhbmdlZCAmJiAhbW9kZWwuaGFzQ2hhbmdlZChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGluZm8ua2V5KSkpKSB7CgkgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgIWtiLnN0YXRpc3RpY3MgfHwga2Iuc3RhdGlzdGljcy5hZGRNb2RlbEV2ZW50KHsKCSAgICAgICAgICAgICAgICAgIG5hbWU6IGV2ZW50X25hbWUsCgkgICAgICAgICAgICAgICAgICBtb2RlbDogbW9kZWwsCgkgICAgICAgICAgICAgICAgICBrZXk6IGluZm8ua2V5LAoJICAgICAgICAgICAgICAgICAgcGF0aDogaW5mby5wYXRoCgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgaW5mby51cGRhdGUoKTsKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICB9OwoJICAgICAgICB9CgkgICAgICAgIGNhbGxiYWNrcy5saXN0LnB1c2goaW5mbyA9IF8uZGVmYXVsdHMoewoJICAgICAgICAgIG9iajogb2JqCgkgICAgICAgIH0sIGNhbGxiYWNrX2luZm8pKTsKCSAgICAgICAgaWYgKG1vZGVsKSB7CgkgICAgICAgICAgcmV0dXJuIF90aGlzLl9vbk1vZGVsTG9hZGVkKG1vZGVsKTsKCSAgICAgICAgfQoJICAgICAgfTsKCSAgICB9KSh0aGlzKTsKCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGV2ZW50X25hbWVzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBldmVudF9uYW1lID0gZXZlbnRfbmFtZXNbX2ldOwoJICAgICAgaWYgKCFldmVudF9uYW1lKSB7CgkgICAgICAgIGNvbnRpbnVlOwoJICAgICAgfQoJICAgICAgX2ZuKGV2ZW50X25hbWUpOwoJICAgIH0KCSAgICByZXR1cm4gdGhpczsKCSAgfTsKCgkgIEV2ZW50V2F0Y2hlci5wcm90b3R5cGUucmVsZWFzZUNhbGxiYWNrcyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBjYWxsYmFja3MsIGV2ZW50X25hbWUsIF9yZWYxOwoJICAgIHRoaXMuZWUgPSBudWxsOwoJICAgIF9yZWYxID0gdGhpcy5fX2tiLmNhbGxiYWNrczsKCSAgICBmb3IgKGV2ZW50X25hbWUgaW4gX3JlZjEpIHsKCSAgICAgIGNhbGxiYWNrcyA9IF9yZWYxW2V2ZW50X25hbWVdOwoJICAgICAgdGhpcy5fdW5iaW5kQ2FsbGJhY2tzKGV2ZW50X25hbWUsIGNhbGxiYWNrcywga2Iud2FzUmVsZWFzZWQob2JqKSk7CgkgICAgfQoJICAgIHJldHVybiBkZWxldGUgdGhpcy5fX2tiLmNhbGxiYWNrczsKCSAgfTsKCgkgIEV2ZW50V2F0Y2hlci5wcm90b3R5cGUuX29uTW9kZWxMb2FkZWQgPSBmdW5jdGlvbihtb2RlbCkgewoJICAgIHZhciBjYWxsYmFja3MsIGV2ZW50X25hbWUsIGluZm8sIF9pLCBfbGVuLCBfcmVmMSwgX3JlZjIsIF9yZWYzOwoJICAgIHRoaXMuZWUgPSBtb2RlbDsKCSAgICBfcmVmMSA9IHRoaXMuX19rYi5jYWxsYmFja3M7CgkgICAgZm9yIChldmVudF9uYW1lIGluIF9yZWYxKSB7CgkgICAgICBjYWxsYmFja3MgPSBfcmVmMVtldmVudF9uYW1lXTsKCSAgICAgIGlmIChjYWxsYmFja3MubW9kZWwgJiYgKGNhbGxiYWNrcy5tb2RlbCAhPT0gbW9kZWwpKSB7CgkgICAgICAgIHRoaXMuX3VuYmluZENhbGxiYWNrcyhldmVudF9uYW1lLCBjYWxsYmFja3MsIHRydWUpOwoJICAgICAgfQoJICAgICAgaWYgKCFjYWxsYmFja3MubW9kZWwpIHsKCSAgICAgICAgY2FsbGJhY2tzLm1vZGVsID0gbW9kZWw7CgkgICAgICAgIG1vZGVsLmJpbmQoZXZlbnRfbmFtZSwgY2FsbGJhY2tzLmZuKTsKCSAgICAgIH0KCSAgICAgIF9yZWYyID0gY2FsbGJhY2tzLmxpc3Q7CgkgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYyLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgIGluZm8gPSBfcmVmMltfaV07CgkgICAgICAgIGluZm8udW5iaW5kX2ZuIHx8IChpbmZvLnVuYmluZF9mbiA9IChfcmVmMyA9IGtiLm9ybSkgIT0gbnVsbCA/IF9yZWYzLmJpbmQobW9kZWwsIGluZm8ua2V5LCBpbmZvLnVwZGF0ZSwgaW5mby5wYXRoKSA6IHZvaWQgMCk7CgkgICAgICAgIGlmIChpbmZvLmVtaXR0ZXIpIHsKCSAgICAgICAgICBpbmZvLmVtaXR0ZXIobW9kZWwpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICB9OwoKCSAgRXZlbnRXYXRjaGVyLnByb3RvdHlwZS5fb25Nb2RlbFVubG9hZGVkID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICB2YXIgY2FsbGJhY2tzLCBldmVudF9uYW1lLCBfcmVmMTsKCSAgICBpZiAodGhpcy5lZSAhPT0gbW9kZWwpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgdGhpcy5lZSA9IG51bGw7CgkgICAgX3JlZjEgPSB0aGlzLl9fa2IuY2FsbGJhY2tzOwoJICAgIGZvciAoZXZlbnRfbmFtZSBpbiBfcmVmMSkgewoJICAgICAgY2FsbGJhY2tzID0gX3JlZjFbZXZlbnRfbmFtZV07CgkgICAgICB0aGlzLl91bmJpbmRDYWxsYmFja3MoZXZlbnRfbmFtZSwgY2FsbGJhY2tzKTsKCSAgICB9CgkgIH07CgoJICBFdmVudFdhdGNoZXIucHJvdG90eXBlLl91bmJpbmRDYWxsYmFja3MgPSBmdW5jdGlvbihldmVudF9uYW1lLCBjYWxsYmFja3MsIHNraXBfZW1pdHRlcikgewoJICAgIHZhciBpbmZvLCBfaSwgX2xlbiwgX3JlZjE7CgkgICAgaWYgKGNhbGxiYWNrcy5tb2RlbCkgewoJICAgICAgY2FsbGJhY2tzLm1vZGVsLnVuYmluZChldmVudF9uYW1lLCBjYWxsYmFja3MuZm4pOwoJICAgICAgY2FsbGJhY2tzLm1vZGVsID0gbnVsbDsKCSAgICB9CgkgICAgX3JlZjEgPSBjYWxsYmFja3MubGlzdDsKCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYxLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBpbmZvID0gX3JlZjFbX2ldOwoJICAgICAgaWYgKGluZm8udW5iaW5kX2ZuKSB7CgkgICAgICAgIGluZm8udW5iaW5kX2ZuKCk7CgkgICAgICAgIGluZm8udW5iaW5kX2ZuID0gbnVsbDsKCSAgICAgIH0KCSAgICAgIGlmIChpbmZvLmVtaXR0ZXIgJiYgIXNraXBfZW1pdHRlciAmJiAha2Iud2FzUmVsZWFzZWQoaW5mby5vYmopKSB7CgkgICAgICAgIGluZm8uZW1pdHRlcihudWxsKTsKCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICByZXR1cm4gRXZlbnRXYXRjaGVyOwoKCX0pKCk7CgoJa2IuZW1pdHRlck9ic2VydmFibGUgPSBmdW5jdGlvbihlbWl0dGVyLCBvYnNlcnZhYmxlKSB7CgkgIHJldHVybiBuZXcga2IuRXZlbnRXYXRjaGVyKGVtaXR0ZXIsIG9ic2VydmFibGUpOwoJfTsKCgovKioqLyB9LAovKiA0ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGtiLCBfOwoKCV8gPSAoa2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpKS5fOwoKCWtiLkZhY3RvcnkgPSAoZnVuY3Rpb24oKSB7CgkgIEZhY3RvcnkudXNlT3B0aW9uc09yQ3JlYXRlID0gZnVuY3Rpb24ob3B0aW9ucywgb2JqLCBvd25lcl9wYXRoKSB7CgkgICAgdmFyIGZhY3Rvcnk7CgkgICAgaWYgKG9wdGlvbnMuZmFjdG9yeSAmJiAoIW9wdGlvbnMuZmFjdG9yaWVzIHx8IChvcHRpb25zLmZhY3RvcmllcyAmJiBvcHRpb25zLmZhY3RvcnkuaGFzUGF0aE1hcHBpbmdzKG9wdGlvbnMuZmFjdG9yaWVzLCBvd25lcl9wYXRoKSkpKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMud3JhcHBlZEZhY3Rvcnkob2JqLCBvcHRpb25zLmZhY3RvcnkpOwoJICAgIH0KCSAgICBmYWN0b3J5ID0ga2IudXRpbHMud3JhcHBlZEZhY3Rvcnkob2JqLCBuZXcga2IuRmFjdG9yeShvcHRpb25zLmZhY3RvcnkpKTsKCSAgICBpZiAob3B0aW9ucy5mYWN0b3JpZXMpIHsKCSAgICAgIGZhY3RvcnkuYWRkUGF0aE1hcHBpbmdzKG9wdGlvbnMuZmFjdG9yaWVzLCBvd25lcl9wYXRoKTsKCSAgICB9CgkgICAgcmV0dXJuIGZhY3Rvcnk7CgkgIH07CgoJICBmdW5jdGlvbiBGYWN0b3J5KHBhcmVudF9mYWN0b3J5KSB7CgkgICAgdGhpcy5wYXRocyA9IHt9OwoJICAgIGlmIChwYXJlbnRfZmFjdG9yeSkgewoJICAgICAgdGhpcy5wYXJlbnRfZmFjdG9yeSA9IHBhcmVudF9mYWN0b3J5OwoJICAgIH0KCSAgfQoKCSAgRmFjdG9yeS5wcm90b3R5cGUuaGFzUGF0aCA9IGZ1bmN0aW9uKHBhdGgpIHsKCSAgICB2YXIgX3JlZjsKCSAgICByZXR1cm4gdGhpcy5wYXRocy5oYXNPd25Qcm9wZXJ0eShwYXRoKSB8fCAoKF9yZWYgPSB0aGlzLnBhcmVudF9mYWN0b3J5KSAhPSBudWxsID8gX3JlZi5oYXNQYXRoKHBhdGgpIDogdm9pZCAwKTsKCSAgfTsKCgkgIEZhY3RvcnkucHJvdG90eXBlLmFkZFBhdGhNYXBwaW5nID0gZnVuY3Rpb24ocGF0aCwgY3JlYXRlX2luZm8pIHsKCSAgICByZXR1cm4gdGhpcy5wYXRoc1twYXRoXSA9IGNyZWF0ZV9pbmZvOwoJICB9OwoKCSAgRmFjdG9yeS5wcm90b3R5cGUuYWRkUGF0aE1hcHBpbmdzID0gZnVuY3Rpb24oZmFjdG9yaWVzLCBvd25lcl9wYXRoKSB7CgkgICAgdmFyIGNyZWF0ZV9pbmZvLCBwYXRoOwoJICAgIGZvciAocGF0aCBpbiBmYWN0b3JpZXMpIHsKCSAgICAgIGNyZWF0ZV9pbmZvID0gZmFjdG9yaWVzW3BhdGhdOwoJICAgICAgdGhpcy5wYXRoc1trYi51dGlscy5wYXRoSm9pbihvd25lcl9wYXRoLCBwYXRoKV0gPSBjcmVhdGVfaW5mbzsKCSAgICB9CgkgIH07CgoJICBGYWN0b3J5LnByb3RvdHlwZS5oYXNQYXRoTWFwcGluZ3MgPSBmdW5jdGlvbihmYWN0b3JpZXMsIG93bmVyX3BhdGgpIHsKCSAgICB2YXIgYWxsX2V4aXN0LCBjcmVhdG9yLCBleGlzdGluZ19jcmVhdG9yLCBwYXRoOwoJICAgIGFsbF9leGlzdCA9IHRydWU7CgkgICAgZm9yIChwYXRoIGluIGZhY3RvcmllcykgewoJICAgICAgY3JlYXRvciA9IGZhY3Rvcmllc1twYXRoXTsKCSAgICAgIGFsbF9leGlzdCAmPSAoZXhpc3RpbmdfY3JlYXRvciA9IHRoaXMuY3JlYXRvckZvclBhdGgobnVsbCwga2IudXRpbHMucGF0aEpvaW4ob3duZXJfcGF0aCwgcGF0aCkpKSAmJiAoY3JlYXRvciA9PT0gZXhpc3RpbmdfY3JlYXRvcik7CgkgICAgfQoJICAgIHJldHVybiBhbGxfZXhpc3Q7CgkgIH07CgoJICBGYWN0b3J5LnByb3RvdHlwZS5jcmVhdG9yRm9yUGF0aCA9IGZ1bmN0aW9uKG9iaiwgcGF0aCkgewoJICAgIHZhciBjcmVhdG9yLCBfcmVmOwoJICAgIGlmIChjcmVhdG9yID0gdGhpcy5wYXRoc1twYXRoXSkgewoJICAgICAgcmV0dXJuIChjcmVhdG9yLnZpZXdfbW9kZWwgPyBjcmVhdG9yLnZpZXdfbW9kZWwgOiBjcmVhdG9yKTsKCSAgICB9CgkgICAgaWYgKGNyZWF0b3IgPSAoX3JlZiA9IHRoaXMucGFyZW50X2ZhY3RvcnkpICE9IG51bGwgPyBfcmVmLmNyZWF0b3JGb3JQYXRoKG9iaiwgcGF0aCkgOiB2b2lkIDApIHsKCSAgICAgIHJldHVybiBjcmVhdG9yOwoJICAgIH0KCSAgICByZXR1cm4gbnVsbDsKCSAgfTsKCgkgIHJldHVybiBGYWN0b3J5OwoKCX0pKCk7CgoKLyoqKi8gfSwKLyogNSAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkvKiBXRUJQQUNLIFZBUiBJTkpFQ1RJT04gKi8oZnVuY3Rpb24oZ2xvYmFsKSB7CgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgJCwga2IsIGtvLCBvblJlYWR5LCB3aW5kb3csIF8sIF9rb19hcHBseUJpbmRpbmdzLCBfcmVmOwoKCXdpbmRvdyA9IHdpbmRvdyAhPSBudWxsID8gd2luZG93IDogZ2xvYmFsOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbywgJCA9IF9yZWYuJDsKCglrYi5SRUNVU0lWRV9BVVRPX0lOSkVDVCA9IHRydWU7CgoJa28uYmluZGluZ0hhbmRsZXJzWydpbmplY3QnXSA9IHsKCSAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZV9hY2Nlc3NvciwgYWxsX2JpbmRpbmdzX2FjY2Vzc29yLCB2aWV3X21vZGVsKSB7CgkgICAgcmV0dXJuIGtiLkluamVjdC5pbmplY3Qoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZV9hY2Nlc3NvcigpKSwgdmlld19tb2RlbCwgZWxlbWVudCwgdmFsdWVfYWNjZXNzb3IsIGFsbF9iaW5kaW5nc19hY2Nlc3Nvcik7CgkgIH0KCX07CgoJa2IuSW5qZWN0ID0gKGZ1bmN0aW9uKCkgewoJICBmdW5jdGlvbiBJbmplY3QoKSB7fQoKCSAgSW5qZWN0LmluamVjdCA9IGZ1bmN0aW9uKGRhdGEsIHZpZXdfbW9kZWwsIGVsZW1lbnQsIHZhbHVlX2FjY2Vzc29yLCBhbGxfYmluZGluZ3NfYWNjZXNzb3IsIG5lc3RlZCkgewoJICAgIHZhciBpbmplY3Q7CgkgICAgaW5qZWN0ID0gZnVuY3Rpb24oZGF0YSkgewoJICAgICAgdmFyIGtleSwgdGFyZ2V0LCB2YWx1ZTsKCSAgICAgIGlmIChfLmlzRnVuY3Rpb24oZGF0YSkpIHsKCSAgICAgICAgdmlld19tb2RlbCA9IG5ldyBkYXRhKHZpZXdfbW9kZWwsIGVsZW1lbnQsIHZhbHVlX2FjY2Vzc29yLCBhbGxfYmluZGluZ3NfYWNjZXNzb3IpOwoJICAgICAgICBrYi5yZWxlYXNlT25Ob2RlUmVtb3ZlKHZpZXdfbW9kZWwsIGVsZW1lbnQpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgaWYgKGRhdGEudmlld19tb2RlbCkgewoJICAgICAgICAgIHZpZXdfbW9kZWwgPSBuZXcgZGF0YS52aWV3X21vZGVsKHZpZXdfbW9kZWwsIGVsZW1lbnQsIHZhbHVlX2FjY2Vzc29yLCBhbGxfYmluZGluZ3NfYWNjZXNzb3IpOwoJICAgICAgICAgIGtiLnJlbGVhc2VPbk5vZGVSZW1vdmUodmlld19tb2RlbCwgZWxlbWVudCk7CgkgICAgICAgIH0KCSAgICAgICAgZm9yIChrZXkgaW4gZGF0YSkgewoJICAgICAgICAgIHZhbHVlID0gZGF0YVtrZXldOwoJICAgICAgICAgIGlmIChrZXkgPT09ICd2aWV3X21vZGVsJykgewoJICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgICAgfQoJICAgICAgICAgIGlmIChrZXkgPT09ICdjcmVhdGUnKSB7CgkgICAgICAgICAgICB2YWx1ZSh2aWV3X21vZGVsLCBlbGVtZW50LCB2YWx1ZV9hY2Nlc3NvciwgYWxsX2JpbmRpbmdzX2FjY2Vzc29yKTsKCSAgICAgICAgICB9IGVsc2UgaWYgKF8uaXNPYmplY3QodmFsdWUpICYmICFfLmlzRnVuY3Rpb24odmFsdWUpKSB7CgkgICAgICAgICAgICB0YXJnZXQgPSBuZXN0ZWQgfHwgKHZhbHVlICYmIHZhbHVlLmNyZWF0ZSkgPyB7fSA6IHZpZXdfbW9kZWw7CgkgICAgICAgICAgICB2aWV3X21vZGVsW2tleV0gPSBrYi5JbmplY3QuaW5qZWN0KHZhbHVlLCB0YXJnZXQsIGVsZW1lbnQsIHZhbHVlX2FjY2Vzc29yLCBhbGxfYmluZGluZ3NfYWNjZXNzb3IsIHRydWUpOwoJICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICB2aWV3X21vZGVsW2tleV0gPSB2YWx1ZTsKCSAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICAgIHJldHVybiB2aWV3X21vZGVsOwoJICAgIH07CgkgICAgaWYgKG5lc3RlZCkgewoJICAgICAgcmV0dXJuIGluamVjdChkYXRhKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLmlnbm9yZShmdW5jdGlvbigpIHsKCSAgICAgICAgcmV0dXJuIGluamVjdChkYXRhKTsKCSAgICAgIH0pOwoJICAgIH0KCSAgfTsKCgkgIEluamVjdC5pbmplY3RWaWV3TW9kZWxzID0gZnVuY3Rpb24ocm9vdCkgewoJICAgIHZhciBhZnRlckJpbmRpbmcsIGFwcCwgYmVmb3JlQmluZGluZywgZGF0YSwgZXhwcmVzc2lvbiwgZmluZEVsZW1lbnRzLCBvcHRpb25zLCByZXN1bHRzLCBfaSwgX2xlbjsKCSAgICByZXN1bHRzID0gW107CgkgICAgZmluZEVsZW1lbnRzID0gZnVuY3Rpb24oZWwpIHsKCSAgICAgIHZhciBhdHRyLCBjaGlsZF9lbCwgX2ksIF9sZW4sIF9yZWYxOwoJICAgICAgaWYgKCFlbC5fX2tiX2luamVjdGVkKSB7CgkgICAgICAgIGlmIChlbC5hdHRyaWJ1dGVzICYmIChhdHRyID0gXy5maW5kKGVsLmF0dHJpYnV0ZXMsIGZ1bmN0aW9uKGF0dHIpIHsKCSAgICAgICAgICByZXR1cm4gYXR0ci5uYW1lID09PSAna2ItaW5qZWN0JzsKCSAgICAgICAgfSkpKSB7CgkgICAgICAgICAgZWwuX19rYl9pbmplY3RlZCA9IHRydWU7CgkgICAgICAgICAgcmVzdWx0cy5wdXNoKHsKCSAgICAgICAgICAgIGVsOiBlbCwKCSAgICAgICAgICAgIHZpZXdfbW9kZWw6IHt9LAoJICAgICAgICAgICAgYmluZGluZzogYXR0ci52YWx1ZQoJICAgICAgICAgIH0pOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgICBfcmVmMSA9IGVsLmNoaWxkTm9kZXM7CgkgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYxLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgIGNoaWxkX2VsID0gX3JlZjFbX2ldOwoJICAgICAgICBmaW5kRWxlbWVudHMoY2hpbGRfZWwpOwoJICAgICAgfQoJICAgIH07CgkgICAgaWYgKCFyb290ICYmICh3aW5kb3cgIT0gbnVsbCA/IHdpbmRvdy5kb2N1bWVudCA6IHZvaWQgMCkpIHsKCSAgICAgIHJvb3QgPSB3aW5kb3cuZG9jdW1lbnQ7CgkgICAgfQoJICAgIGZpbmRFbGVtZW50cyhyb290KTsKCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IHJlc3VsdHMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgIGFwcCA9IHJlc3VsdHNbX2ldOwoJICAgICAgaWYgKGV4cHJlc3Npb24gPSBhcHAuYmluZGluZykgewoJICAgICAgICAoZXhwcmVzc2lvbi5zZWFyY2goL1s6XS8pIDwgMCkgfHwgKGV4cHJlc3Npb24gPSAieyIgKyBleHByZXNzaW9uICsgIn0iKTsKCSAgICAgICAgZGF0YSA9IChuZXcgRnVuY3Rpb24oIiIsICJyZXR1cm4gKCAiICsgZXhwcmVzc2lvbiArICIgKSIpKSgpOwoJICAgICAgICBkYXRhIHx8IChkYXRhID0ge30pOwoJICAgICAgICAoIWRhdGEub3B0aW9ucykgfHwgKG9wdGlvbnMgPSBkYXRhLm9wdGlvbnMsIGRlbGV0ZSBkYXRhLm9wdGlvbnMpOwoJICAgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgICAgICBhcHAudmlld19tb2RlbCA9IGtiLkluamVjdC5pbmplY3QoZGF0YSwgYXBwLnZpZXdfbW9kZWwsIGFwcC5lbCwgbnVsbCwgbnVsbCwgdHJ1ZSk7CgkgICAgICAgIGFmdGVyQmluZGluZyA9IGFwcC52aWV3X21vZGVsLmFmdGVyQmluZGluZyB8fCBvcHRpb25zLmFmdGVyQmluZGluZzsKCSAgICAgICAgYmVmb3JlQmluZGluZyA9IGFwcC52aWV3X21vZGVsLmJlZm9yZUJpbmRpbmcgfHwgb3B0aW9ucy5iZWZvcmVCaW5kaW5nOwoJICAgICAgfQoJICAgICAgaWYgKGJlZm9yZUJpbmRpbmcpIHsKCSAgICAgICAgYmVmb3JlQmluZGluZy5jYWxsKGFwcC52aWV3X21vZGVsLCBhcHAudmlld19tb2RlbCwgYXBwLmVsLCBvcHRpb25zKTsKCSAgICAgIH0KCSAgICAgIGtiLmFwcGx5QmluZGluZ3MoYXBwLnZpZXdfbW9kZWwsIGFwcC5lbCwgb3B0aW9ucyk7CgkgICAgICBpZiAoYWZ0ZXJCaW5kaW5nKSB7CgkgICAgICAgIGFmdGVyQmluZGluZy5jYWxsKGFwcC52aWV3X21vZGVsLCBhcHAudmlld19tb2RlbCwgYXBwLmVsLCBvcHRpb25zKTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdHM7CgkgIH07CgoJICByZXR1cm4gSW5qZWN0OwoKCX0pKCk7CgoJX2tvX2FwcGx5QmluZGluZ3MgPSBrby5hcHBseUJpbmRpbmdzOwoKCWtvLmFwcGx5QmluZGluZ3MgPSBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KSB7CgkgIHZhciByZXN1bHRzOwoJICByZXN1bHRzID0ga2IuUkVDVVNJVkVfQVVUT19JTkpFQ1QgPyBrYi5pbmplY3RWaWV3TW9kZWxzKGVsZW1lbnQpIDogW107CgkgIGlmICghcmVzdWx0cy5sZW5ndGgpIHsKCSAgICByZXR1cm4gX2tvX2FwcGx5QmluZGluZ3MuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgfQoJfTsKCglrYi5pbmplY3RWaWV3TW9kZWxzID0ga2IuSW5qZWN0LmluamVjdFZpZXdNb2RlbHM7CgoJaWYgKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnQgIT09IG51bGwpIHsKCSAgaWYgKCQpIHsKCSAgICAkKGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIGtiLmluamVjdFZpZXdNb2RlbHMoKTsKCSAgICB9KTsKCSAgfSBlbHNlIHsKCSAgICAob25SZWFkeSA9IGZ1bmN0aW9uKCkgewoJICAgICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgIT09ICdjb21wbGV0ZScpIHsKCSAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQob25SZWFkeSwgMCk7CgkgICAgICB9CgkgICAgICByZXR1cm4ga2IuaW5qZWN0Vmlld01vZGVscygpOwoJICAgIH0pKCk7CgkgIH0KCX0KCQoJLyogV0VCUEFDSyBWQVIgSU5KRUNUSU9OICovfS5jYWxsKGV4cG9ydHMsIChmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXM7IH0oKSkpKQoKLyoqKi8gfSwKLyogNiAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkvKiBXRUJQQUNLIFZBUiBJTkpFQ1RJT04gKi8oZnVuY3Rpb24oZ2xvYmFsKSB7CgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgQmFja2JvbmUsIExJRkVDWUNMRV9NRVRIT0RTLCBrYiwga28sIHdpbmRvdywgXzsKCgl3aW5kb3cgPSB3aW5kb3cgIT0gbnVsbCA/IHdpbmRvdyA6IGdsb2JhbDsKCglrbyA9IF9fd2VicGFja19yZXF1aXJlX18oMzIpOwoKCUxJRkVDWUNMRV9NRVRIT0RTID0gWydyZWxlYXNlJywgJ2Rlc3Ryb3knLCAnZGlzcG9zZSddOwoKCW1vZHVsZS5leHBvcnRzID0ga2IgPSAoZnVuY3Rpb24oKSB7CgkgIHZhciBfcmVmOwoKCSAgZnVuY3Rpb24ga2IoKSB7fQoKCSAga2IuVkVSU0lPTiA9ICcwLjIwLjQnOwoKCSAga2IuVFlQRV9VTktOT1dOID0gMDsKCgkgIGtiLlRZUEVfU0lNUExFID0gMTsKCgkgIGtiLlRZUEVfQVJSQVkgPSAyOwoKCSAga2IuVFlQRV9NT0RFTCA9IDM7CgoJICBrYi5UWVBFX0NPTExFQ1RJT04gPSA0OwoKCSAga2Iud2FzUmVsZWFzZWQgPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gIW9iaiB8fCBvYmouX19rYl9yZWxlYXNlZDsKCSAgfTsKCgkgIGtiLmlzUmVsZWFzZWFibGUgPSBmdW5jdGlvbihvYmosIGRlcHRoKSB7CgkgICAgdmFyIGtleSwgbWV0aG9kLCB2YWx1ZSwgX2ksIF9sZW47CgkgICAgaWYgKGRlcHRoID09IG51bGwpIHsKCSAgICAgIGRlcHRoID0gMDsKCSAgICB9CgkgICAgaWYgKCghb2JqIHx8IChvYmogIT09IE9iamVjdChvYmopKSkgfHwgb2JqLl9fa2JfcmVsZWFzZWQpIHsKCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9CgkgICAgaWYgKGtvLmlzT2JzZXJ2YWJsZShvYmopIHx8IChvYmogaW5zdGFuY2VvZiBrYi5WaWV3TW9kZWwpKSB7CgkgICAgICByZXR1cm4gdHJ1ZTsKCSAgICB9CgkgICAgaWYgKCh0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSB8fCBrYi5pc01vZGVsKG9iaikgfHwga2IuaXNDb2xsZWN0aW9uKG9iaikpIHsKCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9CgkgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBMSUZFQ1lDTEVfTUVUSE9EUy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgbWV0aG9kID0gTElGRUNZQ0xFX01FVEhPRFNbX2ldOwoJICAgICAgaWYgKHR5cGVvZiBvYmpbbWV0aG9kXSA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICByZXR1cm4gdHJ1ZTsKCSAgICAgIH0KCSAgICB9CgkgICAgaWYgKGRlcHRoID4gMCkgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICBmb3IgKGtleSBpbiBvYmopIHsKCSAgICAgIHZhbHVlID0gb2JqW2tleV07CgkgICAgICBpZiAoKGtleSAhPT0gJ19fa2InKSAmJiBrYi5pc1JlbGVhc2VhYmxlKHZhbHVlLCBkZXB0aCArIDEpKSB7CgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gZmFsc2U7CgkgIH07CgoJICBrYi5yZWxlYXNlID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIGFycmF5LCBpbmRleCwgbWV0aG9kLCB2YWx1ZSwgX2ksIF9sZW47CgkgICAgaWYgKCFrYi5pc1JlbGVhc2VhYmxlKG9iaikpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgb2JqLl9fa2JfcmVsZWFzZWQgPSB0cnVlOwoJICAgIGlmIChfLmlzQXJyYXkob2JqKSkgewoJICAgICAgZm9yIChpbmRleCBpbiBvYmopIHsKCSAgICAgICAgdmFsdWUgPSBvYmpbaW5kZXhdOwoJICAgICAgICBpZiAoa2IuaXNSZWxlYXNlYWJsZSh2YWx1ZSkpIHsKCSAgICAgICAgICBvYmpbaW5kZXhdID0gbnVsbDsKCSAgICAgICAgICBrYi5yZWxlYXNlKHZhbHVlKTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBpZiAoa28uaXNPYnNlcnZhYmxlKG9iaikgJiYgXy5pc0FycmF5KGFycmF5ID0ga2IucGVlayhvYmopKSkgewoJICAgICAgaWYgKG9iai5fX2tiX2lzX2NvIHx8IChvYmouX19rYl9pc19vICYmIChvYmoudmFsdWVUeXBlKCkgPT09IGtiLlRZUEVfQ09MTEVDVElPTikpKSB7CgkgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqLmRlc3Ryb3kgPT09ICJmdW5jdGlvbiIgPyBvYmouZGVzdHJveSgpIDogdm9pZCAwOwoJICAgICAgfQoJICAgICAgZm9yIChpbmRleCBpbiBhcnJheSkgewoJICAgICAgICB2YWx1ZSA9IGFycmF5W2luZGV4XTsKCSAgICAgICAgaWYgKGtiLmlzUmVsZWFzZWFibGUodmFsdWUpKSB7CgkgICAgICAgICAgYXJyYXlbaW5kZXhdID0gbnVsbDsKCSAgICAgICAgICBrYi5yZWxlYXNlKHZhbHVlKTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgICAgaWYgKHR5cGVvZiBvYmouZGlzcG9zZSA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICBvYmouZGlzcG9zZSgpOwoJICAgICAgfQoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IExJRkVDWUNMRV9NRVRIT0RTLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBtZXRob2QgPSBMSUZFQ1lDTEVfTUVUSE9EU1tfaV07CgkgICAgICBpZiAodHlwZW9mIG9ialttZXRob2RdID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgIHJldHVybiBvYmpbbWV0aG9kXS5jYWxsKG9iaik7CgkgICAgICB9CgkgICAgfQoJICAgIGlmICgha28uaXNPYnNlcnZhYmxlKG9iaikpIHsKCSAgICAgIHJldHVybiB0aGlzLnJlbGVhc2VLZXlzKG9iaik7CgkgICAgfQoJICB9OwoKCSAga2IucmVsZWFzZUtleXMgPSBmdW5jdGlvbihvYmopIHsKCSAgICB2YXIga2V5LCB2YWx1ZTsKCSAgICBmb3IgKGtleSBpbiBvYmopIHsKCSAgICAgIHZhbHVlID0gb2JqW2tleV07CgkgICAgICBpZiAoa2V5ICE9PSAnX19rYicgJiYga2IuaXNSZWxlYXNlYWJsZSh2YWx1ZSkpIHsKCSAgICAgICAgb2JqW2tleV0gPSBudWxsOwoJICAgICAgICBrYi5yZWxlYXNlKHZhbHVlKTsKCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICBrYi5yZWxlYXNlT25Ob2RlUmVtb3ZlID0gZnVuY3Rpb24odmlld19tb2RlbCwgbm9kZSkgewoJICAgIHZpZXdfbW9kZWwgfHwga2IuX3Rocm93VW5leHBlY3RlZCh0aGlzLCAnbWlzc2luZyB2aWV3IG1vZGVsJyk7CgkgICAgbm9kZSB8fCBrYi5fdGhyb3dVbmV4cGVjdGVkKHRoaXMsICdtaXNzaW5nIG5vZGUnKTsKCSAgICByZXR1cm4ga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayhub2RlLCBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBrYi5yZWxlYXNlKHZpZXdfbW9kZWwpOwoJICAgIH0pOwoJICB9OwoKCSAga2IucmVuZGVyVGVtcGxhdGUgPSBmdW5jdGlvbih0ZW1wbGF0ZSwgdmlld19tb2RlbCwgb3B0aW9ucykgewoJICAgIHZhciBkb2N1bWVudCwgZWwsIG9ic2VydmFibGU7CgkgICAgaWYgKG9wdGlvbnMgPT0gbnVsbCkgewoJICAgICAgb3B0aW9ucyA9IHt9OwoJICAgIH0KCSAgICBpZiAoIShkb2N1bWVudCA9IHdpbmRvdyAhPSBudWxsID8gd2luZG93LmRvY3VtZW50IDogdm9pZCAwKSkgewoJICAgICAgcmV0dXJuIHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiBjb25zb2xlICE9PSBudWxsID8gY29uc29sZS5sb2coJ3JlbmRlclRlbXBsYXRlOiBkb2N1bWVudCBpcyB1bmRlZmluZWQnKSA6IHZvaWQgMDsKCSAgICB9CgkgICAgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCSAgICBvYnNlcnZhYmxlID0ga28ucmVuZGVyVGVtcGxhdGUodGVtcGxhdGUsIHZpZXdfbW9kZWwsIG9wdGlvbnMsIGVsLCAncmVwbGFjZUNoaWxkcmVuJyk7CgkgICAgaWYgKGVsLmNoaWxkTm9kZXMubGVuZ3RoID09PSAxKSB7CgkgICAgICBlbCA9IGVsLmNoaWxkTm9kZXNbMF07CgkgICAgfSBlbHNlIGlmIChlbC5jaGlsZE5vZGVzLmxlbmd0aCkgewoJICAgICAga28uc3RvcmVkQmluZGluZ0NvbnRleHRGb3JOb2RlKGVsLCBrby5jb250ZXh0Rm9yKGVsLmNoaWxkTm9kZXNbMF0pKTsKCSAgICB9CgkgICAga2IucmVsZWFzZU9uTm9kZVJlbW92ZSh2aWV3X21vZGVsLCBlbCk7CgkgICAgb2JzZXJ2YWJsZS5kaXNwb3NlKCk7CgkgICAgaWYgKHZpZXdfbW9kZWwuYWZ0ZXJSZW5kZXIgJiYgIW9wdGlvbnMuYWZ0ZXJSZW5kZXIpIHsKCSAgICAgIHZpZXdfbW9kZWwuYWZ0ZXJSZW5kZXIoZWwpOwoJICAgIH0KCSAgICByZXR1cm4gZWw7CgkgIH07CgoJICBrYi5hcHBseUJpbmRpbmdzID0gZnVuY3Rpb24odmlld19tb2RlbCwgbm9kZSkgewoJICAgIHZhciBjaGlsZCwgY2hpbGRyZW4sIF9pLCBfbGVuLCBfcmVmOwoJICAgIGlmIChub2RlLmxlbmd0aCkgewoJICAgICAgX3JlZiA9IFtkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgbm9kZV0sIG5vZGUgPSBfcmVmWzBdLCBjaGlsZHJlbiA9IF9yZWZbMV07CgkgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGNoaWxkcmVuLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgIGNoaWxkID0gY2hpbGRyZW5bX2ldOwoJICAgICAgICBub2RlLmFwcGVuZENoaWxkKGNoaWxkKTsKCSAgICAgIH0KCSAgICB9CgkgICAga28uYXBwbHlCaW5kaW5ncyh2aWV3X21vZGVsLCBub2RlKTsKCSAgICBrYi5yZWxlYXNlT25Ob2RlUmVtb3ZlKHZpZXdfbW9kZWwsIG5vZGUpOwoJICAgIHJldHVybiBub2RlOwoJICB9OwoKCSAga2IuZ2V0VmFsdWUgPSBmdW5jdGlvbihtb2RlbCwga2V5LCBhcmdzKSB7CgkgICAgdmFyIF9yZWY7CgkgICAgaWYgKCFtb2RlbCkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBpZiAoXy5pc0Z1bmN0aW9uKG1vZGVsW2tleV0pICYmICgoX3JlZiA9IGtiLm9ybSkgIT0gbnVsbCA/IF9yZWYudXNlRnVuY3Rpb24obW9kZWwsIGtleSkgOiB2b2lkIDApKSB7CgkgICAgICByZXR1cm4gbW9kZWxba2V5XSgpOwoJICAgIH0KCSAgICBpZiAoIWFyZ3MpIHsKCSAgICAgIHJldHVybiBtb2RlbC5nZXQoa2V5KTsKCSAgICB9CgkgICAgcmV0dXJuIG1vZGVsLmdldC5hcHBseShtb2RlbCwgXy5tYXAoW2tleV0uY29uY2F0KGFyZ3MpLCBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgcmV0dXJuIGtiLnBlZWsodmFsdWUpOwoJICAgIH0pKTsKCSAgfTsKCgkgIGtiLnNldFZhbHVlID0gZnVuY3Rpb24obW9kZWwsIGtleSwgdmFsdWUpIHsKCSAgICB2YXIgYXR0cmlidXRlcywgX3JlZjsKCSAgICBpZiAoIW1vZGVsKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGlmIChfLmlzRnVuY3Rpb24obW9kZWxba2V5XSkgJiYgKChfcmVmID0ga2Iub3JtKSAhPSBudWxsID8gX3JlZi51c2VGdW5jdGlvbihtb2RlbCwga2V5KSA6IHZvaWQgMCkpIHsKCSAgICAgIHJldHVybiBtb2RlbFtrZXldKHZhbHVlKTsKCSAgICB9CgkgICAgKGF0dHJpYnV0ZXMgPSB7fSlba2V5XSA9IHZhbHVlOwoJICAgIHJldHVybiBtb2RlbC5zZXQoYXR0cmlidXRlcyk7CgkgIH07CgoJICBrYi5pZ25vcmUgPSAoKF9yZWYgPSBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uKSAhPSBudWxsID8gX3JlZi5pZ25vcmUgOiB2b2lkIDApIHx8IGZ1bmN0aW9uKGNhbGxiYWNrLCBjYWxsYmFja1RhcmdldCwgY2FsbGJhY2tBcmdzKSB7CgkgICAgdmFyIHZhbHVlOwoJICAgIHZhbHVlID0gbnVsbDsKCSAgICBrby5jb21wdXRlZChmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiB2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KGNhbGxiYWNrVGFyZ2V0LCBjYWxsYmFja0FyZ3MgfHwgW10pOwoJICAgIH0pLmRpc3Bvc2UoKTsKCSAgICByZXR1cm4gdmFsdWU7CgkgIH07CgoJICBrYi5leHRlbmQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI2KTsKCgkgIGtiLl90aHJvd01pc3NpbmcgPSBmdW5jdGlvbihpbnN0YW5jZSwgbWVzc2FnZSkgewoJICAgIHRocm93ICIiICsgKF8uaXNTdHJpbmcoaW5zdGFuY2UpID8gaW5zdGFuY2UgOiBpbnN0YW5jZS5jb25zdHJ1Y3Rvci5uYW1lKSArICI6ICIgKyBtZXNzYWdlICsgIiBpcyBtaXNzaW5nIjsKCSAgfTsKCgkgIGtiLl90aHJvd1VuZXhwZWN0ZWQgPSBmdW5jdGlvbihpbnN0YW5jZSwgbWVzc2FnZSkgewoJICAgIHRocm93ICIiICsgKF8uaXNTdHJpbmcoaW5zdGFuY2UpID8gaW5zdGFuY2UgOiBpbnN0YW5jZS5jb25zdHJ1Y3Rvci5uYW1lKSArICI6ICIgKyBtZXNzYWdlICsgIiBpcyB1bmV4cGVjdGVkIjsKCSAgfTsKCgkgIGtiLnB1Ymxpc2hNZXRob2RzID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSwgaW5zdGFuY2UsIG1ldGhvZHMpIHsKCSAgICB2YXIgZm4sIF9pLCBfbGVuOwoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gbWV0aG9kcy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgZm4gPSBtZXRob2RzW19pXTsKCSAgICAgIG9ic2VydmFibGVbZm5dID0ga2IuXy5iaW5kKGluc3RhbmNlW2ZuXSwgaW5zdGFuY2UpOwoJICAgIH0KCSAgfTsKCgkgIGtiLnBlZWsgPSBmdW5jdGlvbihvYnMpIHsKCSAgICBpZiAoIWtvLmlzT2JzZXJ2YWJsZShvYnMpKSB7CgkgICAgICByZXR1cm4gb2JzOwoJICAgIH0KCSAgICBpZiAob2JzLnBlZWspIHsKCSAgICAgIHJldHVybiBvYnMucGVlaygpOwoJICAgIH0KCSAgICByZXR1cm4ga2IuaWdub3JlKGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIG9icygpOwoJICAgIH0pOwoJICB9OwoKCSAga2IuaXNNb2RlbCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiBvYmogJiYgKChvYmogaW5zdGFuY2VvZiBrYi5Nb2RlbCkgfHwgKCh0eXBlb2Ygb2JqLmdldCA9PT0gJ2Z1bmN0aW9uJykgJiYgKHR5cGVvZiBvYmouYmluZCA9PT0gJ2Z1bmN0aW9uJykpKTsKCSAgfTsKCgkgIGtiLmlzQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiBvYmogJiYgKG9iaiBpbnN0YW5jZW9mIGtiLkNvbGxlY3Rpb24pOwoJICB9OwoKCSAgcmV0dXJuIGtiOwoKCX0pKCk7CgoJaWYgKHdpbmRvdy5QYXJzZSkgewoJICBCYWNrYm9uZSA9IGtiLlBhcnNlID0gd2luZG93LlBhcnNlOwoJICBfID0ga2IuXyA9IHdpbmRvdy5QYXJzZS5fOwoJfSBlbHNlIHsKCSAgQmFja2JvbmUgPSBrYi5CYWNrYm9uZSA9IF9fd2VicGFja19yZXF1aXJlX18oMzApOwoJICBfID0ga2IuXyA9IF9fd2VicGFja19yZXF1aXJlX18oMzEpOwoJfQoKCWtiLmtvID0ga287CgoJa2IuQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb247CgoJa2IuTW9kZWwgPSBCYWNrYm9uZS5PYmplY3QgfHwgQmFja2JvbmUuTW9kZWw7CgoJa2IuRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzOwoKCWtiLiQgPSB3aW5kb3cualF1ZXJ5IHx8IHdpbmRvdy4kOwoKCXRyeSB7CgkgIGtiLiQgfHwgKGtiLiQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIwKSk7Cgl9IGNhdGNoIChfZXJyb3IpIHt9CgkKCS8qIFdFQlBBQ0sgVkFSIElOSkVDVElPTiAqL30uY2FsbChleHBvcnRzLCAoZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzOyB9KCkpKSkKCi8qKiovIH0sCi8qIDcgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIGtvLCBfZXh0ZW5kLCBfcmVmLCBfcmVmMTsKCglrbyA9IChrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNikpLmtvOwoKCWlmICgoX3JlZiA9IGtvLnN1YnNjcmliYWJsZSkgIT0gbnVsbCA/IChfcmVmMSA9IF9yZWYuZm4pICE9IG51bGwgPyBfcmVmMS5leHRlbmQgOiB2b2lkIDAgOiB2b2lkIDApIHsKCSAgX2V4dGVuZCA9IGtvLnN1YnNjcmliYWJsZS5mbi5leHRlbmQ7CgkgIGtvLnN1YnNjcmliYWJsZS5mbi5leHRlbmQgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgdGFyZ2V0LCBfZGlzcG9zZTsKCSAgICB0YXJnZXQgPSBfZXh0ZW5kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgICAgaWYgKHRhcmdldCAhPT0gdGhpcyAmJiBrYi5pc1JlbGVhc2VhYmxlKHRoaXMpKSB7CgkgICAgICBfZGlzcG9zZSA9IHRhcmdldC5kaXNwb3NlOwoJICAgICAgdGFyZ2V0LmRpc3Bvc2UgPSAoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgIGlmIChfZGlzcG9zZSAhPSBudWxsKSB7CgkgICAgICAgICAgICBfZGlzcG9zZS5hcHBseSh0YXJnZXQsIGFyZ3VtZW50cyk7CgkgICAgICAgICAgfQoJICAgICAgICAgIHJldHVybiBrYi5yZWxlYXNlKF90aGlzKTsKCSAgICAgICAgfTsKCSAgICAgIH0pKHRoaXMpOwoJICAgIH0KCSAgICByZXR1cm4gdGFyZ2V0OwoJICB9OwoJfQoKCi8qKiovIH0sCi8qIDggKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgS0VZU19JTkZPLCBLRVlTX1BVQkxJU0gsIFR5cGVkVmFsdWUsIGtiLCBrbywgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJVHlwZWRWYWx1ZSA9IF9fd2VicGFja19yZXF1aXJlX18oMTEpOwoKCUtFWVNfUFVCTElTSCA9IFsndmFsdWUnLCAndmFsdWVUeXBlJywgJ2Rlc3Ryb3knXTsKCglLRVlTX0lORk8gPSBbJ2FyZ3MnLCAncmVhZCcsICd3cml0ZSddOwoKCWtiLk9ic2VydmFibGUgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIE9ic2VydmFibGUobW9kZWwsIGtleV9vcl9pbmZvLCBvcHRpb25zLCBfdm0pIHsKCSAgICB0aGlzLl92bSA9IF92bSAhPSBudWxsID8gX3ZtIDoge307CgkgICAgcmV0dXJuIGtiLmlnbm9yZSgoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgdmFyIGNyZWF0ZV9vcHRpb25zLCBldmVudF93YXRjaGVyLCBrZXksIG9ic2VydmFibGUsIF9pLCBfbGVuOwoJICAgICAgICBrZXlfb3JfaW5mbyB8fCBrYi5fdGhyb3dNaXNzaW5nKF90aGlzLCAna2V5X29yX2luZm8nKTsKCSAgICAgICAgX3RoaXMua2V5ID0ga2V5X29yX2luZm8ua2V5IHx8IGtleV9vcl9pbmZvOwoJICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IEtFWVNfSU5GTy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgICAgIGtleSA9IEtFWVNfSU5GT1tfaV07CgkgICAgICAgICAgaWYgKGtleV9vcl9pbmZvW2tleV0pIHsKCSAgICAgICAgICAgIF90aGlzW2tleV0gPSBrZXlfb3JfaW5mb1trZXldOwoJICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICBjcmVhdGVfb3B0aW9ucyA9IGtiLnV0aWxzLmNvbGxhcHNlT3B0aW9ucyhvcHRpb25zKTsKCSAgICAgICAgZXZlbnRfd2F0Y2hlciA9IGNyZWF0ZV9vcHRpb25zLmV2ZW50X3dhdGNoZXI7CgkgICAgICAgIGRlbGV0ZSBjcmVhdGVfb3B0aW9ucy5ldmVudF93YXRjaGVyOwoJICAgICAgICBfdGhpcy5fdmFsdWUgPSBuZXcgVHlwZWRWYWx1ZShjcmVhdGVfb3B0aW9ucyk7CgkgICAgICAgIF90aGlzLl9tb2RlbCA9IGtvLm9ic2VydmFibGUoKTsKCSAgICAgICAgb2JzZXJ2YWJsZSA9IGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKF90aGlzLCBrby5jb21wdXRlZCh7CgkgICAgICAgICAgcmVhZDogZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICB2YXIgYXJnLCBhcmdzLCBfaiwgX2xlbjEsIF9tb2RlbCwgX3JlZjEsIF9yZWYyOwoJICAgICAgICAgICAgX21vZGVsID0gX3RoaXMuX21vZGVsKCk7CgkgICAgICAgICAgICBfcmVmMSA9IGFyZ3MgPSBbX3RoaXMua2V5XS5jb25jYXQoX3RoaXMuYXJncyB8fCBbXSk7CgkgICAgICAgICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBfcmVmMS5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKCSAgICAgICAgICAgICAgYXJnID0gX3JlZjFbX2pdOwoJICAgICAgICAgICAgICBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFyZyk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAoKF9yZWYyID0ga2IudXRpbHMud3JhcHBlZEV2ZW50V2F0Y2hlcihfdGhpcykpICE9IG51bGwpIHsKCSAgICAgICAgICAgICAgX3JlZjIuZW1pdHRlcihfbW9kZWwgfHwgbnVsbCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAoX3RoaXMucmVhZCkgewoJICAgICAgICAgICAgICBfdGhpcy51cGRhdGUoX3RoaXMucmVhZC5hcHBseShfdGhpcy5fdm0sIGFyZ3MpKTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAoIV8uaXNVbmRlZmluZWQoX21vZGVsKSkgewoJICAgICAgICAgICAgICBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnVwZGF0ZShrYi5nZXRWYWx1ZShfbW9kZWwsIGtiLnBlZWsoX3RoaXMua2V5KSwgX3RoaXMuYXJncykpOwoJICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBfdGhpcy5fdmFsdWUudmFsdWUoKTsKCSAgICAgICAgICB9LAoJICAgICAgICAgIHdyaXRlOiBmdW5jdGlvbihuZXdfdmFsdWUpIHsKCSAgICAgICAgICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgIHZhciB1bndyYXBwZWRfbmV3X3ZhbHVlLCBfbW9kZWw7CgkgICAgICAgICAgICAgIHVud3JhcHBlZF9uZXdfdmFsdWUgPSBrYi51dGlscy51bndyYXBNb2RlbHMobmV3X3ZhbHVlKTsKCSAgICAgICAgICAgICAgX21vZGVsID0ga2IucGVlayhfdGhpcy5fbW9kZWwpOwoJICAgICAgICAgICAgICBpZiAoX3RoaXMud3JpdGUpIHsKCSAgICAgICAgICAgICAgICBfdGhpcy53cml0ZS5jYWxsKF90aGlzLl92bSwgdW53cmFwcGVkX25ld192YWx1ZSk7CgkgICAgICAgICAgICAgICAgbmV3X3ZhbHVlID0ga2IuZ2V0VmFsdWUoX21vZGVsLCBrYi5wZWVrKF90aGlzLmtleSksIF90aGlzLmFyZ3MpOwoJICAgICAgICAgICAgICB9IGVsc2UgaWYgKF9tb2RlbCkgewoJICAgICAgICAgICAgICAgIGtiLnNldFZhbHVlKF9tb2RlbCwga2IucGVlayhfdGhpcy5rZXkpLCB1bndyYXBwZWRfbmV3X3ZhbHVlKTsKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlKG5ld192YWx1ZSk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICB9LAoJICAgICAgICAgIG93bmVyOiBfdGhpcy5fdm0KCSAgICAgICAgfSkpOwoJICAgICAgICBvYnNlcnZhYmxlLl9fa2JfaXNfbyA9IHRydWU7CgkgICAgICAgIGNyZWF0ZV9vcHRpb25zLnN0b3JlID0ga2IudXRpbHMud3JhcHBlZFN0b3JlKG9ic2VydmFibGUsIGNyZWF0ZV9vcHRpb25zLnN0b3JlKTsKCSAgICAgICAgY3JlYXRlX29wdGlvbnMucGF0aCA9IGtiLnV0aWxzLnBhdGhKb2luKGNyZWF0ZV9vcHRpb25zLnBhdGgsIF90aGlzLmtleSk7CgkgICAgICAgIGlmIChjcmVhdGVfb3B0aW9ucy5mYWN0b3JpZXMgJiYgKCh0eXBlb2YgY3JlYXRlX29wdGlvbnMuZmFjdG9yaWVzID09PSAnZnVuY3Rpb24nKSB8fCBjcmVhdGVfb3B0aW9ucy5mYWN0b3JpZXMuY3JlYXRlKSkgewoJICAgICAgICAgIGNyZWF0ZV9vcHRpb25zLmZhY3RvcnkgPSBrYi51dGlscy53cmFwcGVkRmFjdG9yeShvYnNlcnZhYmxlLCBuZXcga2IuRmFjdG9yeShjcmVhdGVfb3B0aW9ucy5mYWN0b3J5KSk7CgkgICAgICAgICAgY3JlYXRlX29wdGlvbnMuZmFjdG9yeS5hZGRQYXRoTWFwcGluZyhjcmVhdGVfb3B0aW9ucy5wYXRoLCBjcmVhdGVfb3B0aW9ucy5mYWN0b3JpZXMpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIGNyZWF0ZV9vcHRpb25zLmZhY3RvcnkgPSBrYi5GYWN0b3J5LnVzZU9wdGlvbnNPckNyZWF0ZShjcmVhdGVfb3B0aW9ucywgb2JzZXJ2YWJsZSwgY3JlYXRlX29wdGlvbnMucGF0aCk7CgkgICAgICAgIH0KCSAgICAgICAgZGVsZXRlIGNyZWF0ZV9vcHRpb25zLmZhY3RvcmllczsKCSAgICAgICAga2IucHVibGlzaE1ldGhvZHMob2JzZXJ2YWJsZSwgX3RoaXMsIEtFWVNfUFVCTElTSCk7CgkgICAgICAgIG9ic2VydmFibGUubW9kZWwgPSBfdGhpcy5tb2RlbCA9IGtvLmNvbXB1dGVkKHsKCSAgICAgICAgICByZWFkOiBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKF90aGlzLl9tb2RlbCk7CgkgICAgICAgICAgfSwKCSAgICAgICAgICB3cml0ZTogZnVuY3Rpb24obmV3X21vZGVsKSB7CgkgICAgICAgICAgICByZXR1cm4ga2IuaWdub3JlKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICB2YXIgbmV3X3ZhbHVlOwoJICAgICAgICAgICAgICBpZiAoX3RoaXMuX19rYl9yZWxlYXNlZCB8fCAoa2IucGVlayhfdGhpcy5fbW9kZWwpID09PSBuZXdfbW9kZWwpKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIG5ld192YWx1ZSA9IGtiLmdldFZhbHVlKG5ld19tb2RlbCwga2IucGVlayhfdGhpcy5rZXkpLCBfdGhpcy5hcmdzKTsKCSAgICAgICAgICAgICAgX3RoaXMuX21vZGVsKG5ld19tb2RlbCk7CgkgICAgICAgICAgICAgIGlmICghbmV3X21vZGVsKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnVwZGF0ZShudWxsKTsKCSAgICAgICAgICAgICAgfSBlbHNlIGlmICghXy5pc1VuZGVmaW5lZChuZXdfdmFsdWUpKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnVwZGF0ZShuZXdfdmFsdWUpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgICAgICBrYi5FdmVudFdhdGNoZXIudXNlT3B0aW9uc09yQ3JlYXRlKHsKCSAgICAgICAgICBldmVudF93YXRjaGVyOiBldmVudF93YXRjaGVyCgkgICAgICAgIH0sIG1vZGVsIHx8IG51bGwsIF90aGlzLCB7CgkgICAgICAgICAgZW1pdHRlcjogX3RoaXMubW9kZWwsCgkgICAgICAgICAgdXBkYXRlOiAoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICByZXR1cm4ga2IuaWdub3JlKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlKCk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICB9KSwKCSAgICAgICAgICBrZXk6IF90aGlzLmtleSwKCSAgICAgICAgICBwYXRoOiBjcmVhdGVfb3B0aW9ucy5wYXRoCgkgICAgICAgIH0pOwoJICAgICAgICBfdGhpcy5fdmFsdWUucmF3VmFsdWUoKSB8fCBfdGhpcy5fdmFsdWUudXBkYXRlKCk7CgkgICAgICAgIGlmIChrYi5Mb2NhbGl6ZWRPYnNlcnZhYmxlICYmIGtleV9vcl9pbmZvLmxvY2FsaXplcikgewoJICAgICAgICAgIG9ic2VydmFibGUgPSBuZXcga2V5X29yX2luZm8ubG9jYWxpemVyKG9ic2VydmFibGUpOwoJICAgICAgICB9CgkgICAgICAgIGlmIChrYi5EZWZhdWx0T2JzZXJ2YWJsZSAmJiBrZXlfb3JfaW5mby5oYXNPd25Qcm9wZXJ0eSgnZGVmYXVsdCcpKSB7CgkgICAgICAgICAgb2JzZXJ2YWJsZSA9IGtiLmRlZmF1bHRPYnNlcnZhYmxlKG9ic2VydmFibGUsIGtleV9vcl9pbmZvWyJkZWZhdWx0Il0pOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiBvYnNlcnZhYmxlOwoJICAgICAgfTsKCSAgICB9KSh0aGlzKSk7CgkgIH0KCgkgIE9ic2VydmFibGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgb2JzZXJ2YWJsZTsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcyk7CgkgICAgdGhpcy5fX2tiX3JlbGVhc2VkID0gdHJ1ZTsKCSAgICB0aGlzLl92YWx1ZS5kZXN0cm95KCk7CgkgICAgdGhpcy5fdmFsdWUgPSBudWxsOwoJICAgIHRoaXMubW9kZWwuZGlzcG9zZSgpOwoJICAgIHRoaXMubW9kZWwgPSBvYnNlcnZhYmxlLm1vZGVsID0gbnVsbDsKCSAgICByZXR1cm4ga2IudXRpbHMud3JhcHBlZERlc3Ryb3kodGhpcyk7CgkgIH07CgoJICBPYnNlcnZhYmxlLnByb3RvdHlwZS52YWx1ZSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiB0aGlzLl92YWx1ZS5yYXdWYWx1ZSgpOwoJICB9OwoKCSAgT2JzZXJ2YWJsZS5wcm90b3R5cGUudmFsdWVUeXBlID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIHRoaXMuX3ZhbHVlLnZhbHVlVHlwZShrYi5wZWVrKHRoaXMuX21vZGVsKSwga2IucGVlayh0aGlzLmtleSkpOwoJICB9OwoKCSAgT2JzZXJ2YWJsZS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24obmV3X3ZhbHVlKSB7CgkgICAgaWYgKHRoaXMuX19rYl9yZWxlYXNlZCkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsKCSAgICAgIG5ld192YWx1ZSA9IGtiLmdldFZhbHVlKGtiLnBlZWsodGhpcy5fbW9kZWwpLCBrYi5wZWVrKHRoaXMua2V5KSk7CgkgICAgfQoJICAgIHJldHVybiB0aGlzLl92YWx1ZS51cGRhdGUobmV3X3ZhbHVlKTsKCSAgfTsKCgkgIHJldHVybiBPYnNlcnZhYmxlOwoKCX0pKCk7CgoJa2Iub2JzZXJ2YWJsZSA9IGZ1bmN0aW9uKG1vZGVsLCBrZXksIG9wdGlvbnMsIHZpZXdfbW9kZWwpIHsKCSAgcmV0dXJuIG5ldyBrYi5PYnNlcnZhYmxlKG1vZGVsLCBrZXksIG9wdGlvbnMsIHZpZXdfbW9kZWwpOwoJfTsKCgovKioqLyB9LAovKiA5ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGtiLCBfOwoKCV8gPSAoa2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpKS5fOwoKCW1vZHVsZS5leHBvcnRzID0ga2IuU3RhdGlzdGljcyA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gU3RhdGlzdGljcygpIHsKCSAgICB0aGlzLm1vZGVsX2V2ZW50c190cmFja2VyID0gW107CgkgICAgdGhpcy5yZWdpc3RlcmVkX3RyYWNrZXIgPSB7fTsKCSAgfQoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gdGhpcy5tb2RlbF9ldmVudHNfdHJhY2tlciA9IFtdOwoJICB9OwoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUuYWRkTW9kZWxFdmVudCA9IGZ1bmN0aW9uKGV2ZW50KSB7CgkgICAgcmV0dXJuIHRoaXMubW9kZWxfZXZlbnRzX3RyYWNrZXIucHVzaChldmVudCk7CgkgIH07CgoJICBTdGF0aXN0aWNzLnByb3RvdHlwZS5tb2RlbEV2ZW50c1N0YXRzU3RyaW5nID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIGV2ZW50X2dyb3Vwcywga2V5LCBzdGF0c19zdHJpbmcsIHZhbHVlOwoJICAgIHN0YXRzX3N0cmluZyA9ICcnOwoJICAgIHN0YXRzX3N0cmluZyArPSAiVG90YWwgQ291bnQ6ICIgKyB0aGlzLm1vZGVsX2V2ZW50c190cmFja2VyLmxlbmd0aDsKCSAgICBldmVudF9ncm91cHMgPSBfLmdyb3VwQnkodGhpcy5tb2RlbF9ldmVudHNfdHJhY2tlciwgZnVuY3Rpb24odGVzdCkgewoJICAgICAgcmV0dXJuICJldmVudCBuYW1lOiAnIiArIHRlc3QubmFtZSArICInLCBhdHRyaWJ1dGUgbmFtZTogJyIgKyB0ZXN0LmtleSArICInIjsKCSAgICB9KTsKCSAgICBmb3IgKGtleSBpbiBldmVudF9ncm91cHMpIHsKCSAgICAgIHZhbHVlID0gZXZlbnRfZ3JvdXBzW2tleV07CgkgICAgICBzdGF0c19zdHJpbmcgKz0gIlxuICIgKyBrZXkgKyAiLCBjb3VudDogIiArIHZhbHVlLmxlbmd0aDsKCSAgICB9CgkgICAgcmV0dXJuIHN0YXRzX3N0cmluZzsKCSAgfTsKCgkgIFN0YXRpc3RpY3MucHJvdG90eXBlLnJlZ2lzdGVyID0gZnVuY3Rpb24oa2V5LCBvYmopIHsKCSAgICByZXR1cm4gdGhpcy5yZWdpc3RlcmVkVHJhY2tlcihrZXkpLnB1c2gob2JqKTsKCSAgfTsKCgkgIFN0YXRpc3RpY3MucHJvdG90eXBlLnVucmVnaXN0ZXIgPSBmdW5jdGlvbihrZXksIG9iaikgewoJICAgIHZhciBpbmRleCwgdHlwZV90cmFja2VyOwoJICAgIHR5cGVfdHJhY2tlciA9IHRoaXMucmVnaXN0ZXJlZFRyYWNrZXIoa2V5KTsKCSAgICBpZiAoKGluZGV4ID0gXy5pbmRleE9mKHR5cGVfdHJhY2tlciwgb2JqKSkgPCAwKSB7CgkgICAgICByZXR1cm4gdHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUgIT09IG51bGwgPyBjb25zb2xlLmxvZygia2IuU3RhdGlzdGljczogZmFpbGVkIHRvIHVucmVnaXN0ZXIgdHlwZTogIiArIGtleSkgOiB2b2lkIDA7CgkgICAgfQoJICAgIHJldHVybiB0eXBlX3RyYWNrZXIuc3BsaWNlKGluZGV4LCAxKTsKCSAgfTsKCgkgIFN0YXRpc3RpY3MucHJvdG90eXBlLnJlZ2lzdGVyZWRDb3VudCA9IGZ1bmN0aW9uKHR5cGUpIHsKCSAgICB2YXIgY291bnQsIHR5cGVfdHJhY2tlciwgX3JlZjsKCSAgICBpZiAodHlwZSkgewoJICAgICAgcmV0dXJuIHRoaXMucmVnaXN0ZXJlZFRyYWNrZXIodHlwZSkubGVuZ3RoOwoJICAgIH0KCSAgICBjb3VudCA9IDA7CgkgICAgX3JlZiA9IHRoaXMucmVnaXN0ZXJlZF90cmFja2VyW3R5cGVdOwoJICAgIGZvciAodHlwZSBpbiBfcmVmKSB7CgkgICAgICB0eXBlX3RyYWNrZXIgPSBfcmVmW3R5cGVdOwoJICAgICAgY291bnQgKz0gdHlwZV90cmFja2VyLmxlbmd0aDsKCSAgICB9CgkgICAgcmV0dXJuIGNvdW50OwoJICB9OwoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUucmVnaXN0ZXJlZFN0YXRzU3RyaW5nID0gZnVuY3Rpb24oc3VjY2Vzc19tZXNzYWdlKSB7CgkgICAgdmFyIHN0YXRzX3N0cmluZywgdHlwZSwgdHlwZV90cmFja2VyLCB3cml0dGVuLCBfcmVmOwoJICAgIHN0YXRzX3N0cmluZyA9ICcnOwoJICAgIF9yZWYgPSB0aGlzLnJlZ2lzdGVyZWRfdHJhY2tlcjsKCSAgICBmb3IgKHR5cGUgaW4gX3JlZikgewoJICAgICAgdHlwZV90cmFja2VyID0gX3JlZlt0eXBlXTsKCSAgICAgIGlmICghdHlwZV90cmFja2VyLmxlbmd0aCkgewoJICAgICAgICBjb250aW51ZTsKCSAgICAgIH0KCSAgICAgIGlmICh3cml0dGVuKSB7CgkgICAgICAgIHN0YXRzX3N0cmluZyArPSAnXG4gJzsKCSAgICAgIH0KCSAgICAgIHN0YXRzX3N0cmluZyArPSAiIiArICh0eXBlID8gdHlwZSA6ICdObyBOYW1lJykgKyAiOiAiICsgdHlwZV90cmFja2VyLmxlbmd0aDsKCSAgICAgIHdyaXR0ZW4gPSB0cnVlOwoJICAgIH0KCSAgICBpZiAoc3RhdHNfc3RyaW5nKSB7CgkgICAgICByZXR1cm4gc3RhdHNfc3RyaW5nOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4gc3VjY2Vzc19tZXNzYWdlOwoJICAgIH0KCSAgfTsKCgkgIFN0YXRpc3RpY3MucHJvdG90eXBlLnJlZ2lzdGVyZWRUcmFja2VyID0gZnVuY3Rpb24oa2V5KSB7CgkgICAgdmFyIHR5cGVfdHJhY2tlcjsKCSAgICBpZiAodGhpcy5yZWdpc3RlcmVkX3RyYWNrZXIuaGFzT3duUHJvcGVydHkoa2V5KSkgewoJICAgICAgcmV0dXJuIHRoaXMucmVnaXN0ZXJlZF90cmFja2VyW2tleV07CgkgICAgfQoJICAgIHR5cGVfdHJhY2tlciA9IFtdOwoJICAgIHRoaXMucmVnaXN0ZXJlZF90cmFja2VyW2tleV0gPSB0eXBlX3RyYWNrZXI7CgkgICAgcmV0dXJuIHR5cGVfdHJhY2tlcjsKCSAgfTsKCgkgIFN0YXRpc3RpY3MuZXZlbnRzU3RhdHMgPSBmdW5jdGlvbihvYmosIGtleSkgewoJICAgIHZhciBldmVudHMsIG5vZGUsIHN0YXRzLCB0YWlsLCBfaSwgX2xlbiwgX3JlZjsKCSAgICBzdGF0cyA9IHsKCSAgICAgIGNvdW50OiAwCgkgICAgfTsKCSAgICBldmVudHMgPSBvYmouX2V2ZW50cyB8fCBvYmouX2NhbGxiYWNrcyB8fCB7fTsKCSAgICBfcmVmID0gKGtleSA/IFtrZXldIDogXy5rZXlzKGV2ZW50cykpOwoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAga2V5ID0gX3JlZltfaV07CgkgICAgICBpZiAoIShub2RlID0gZXZlbnRzW2tleV0pKSB7CgkgICAgICAgIGNvbnRpbnVlOwoJICAgICAgfQoJICAgICAgaWYgKF8uaXNBcnJheShub2RlKSkgewoJICAgICAgICBzdGF0c1trZXldID0gXy5jb21wYWN0KG5vZGUpLmxlbmd0aDsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHN0YXRzW2tleV0gPSAwOwoJICAgICAgICB0YWlsID0gbm9kZS50YWlsOwoJICAgICAgICB3aGlsZSAoKG5vZGUgPSBub2RlLm5leHQpICE9PSB0YWlsKSB7CgkgICAgICAgICAgc3RhdHNba2V5XSsrOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgICBzdGF0cy5jb3VudCArPSBzdGF0c1trZXldOwoJICAgIH0KCSAgICByZXR1cm4gc3RhdHM7CgkgIH07CgoJICByZXR1cm4gU3RhdGlzdGljczsKCgl9KSgpOwoKCi8qKiovIH0sCi8qIDEwICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGtiLCBrbywgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJbW9kdWxlLmV4cG9ydHMgPSBrYi5TdG9yZSA9IChmdW5jdGlvbigpIHsKCSAgU3RvcmUuaW5zdGFuY2VzID0gW107CgoJICBTdG9yZS51c2VPcHRpb25zT3JDcmVhdGUgPSBmdW5jdGlvbihvcHRpb25zLCBvYmosIG9ic2VydmFibGUpIHsKCSAgICB2YXIgc3RvcmU7CgkgICAgaWYgKCFvcHRpb25zLnN0b3JlKSB7CgkgICAgICBrYi51dGlscy53cmFwcGVkU3RvcmVJc093bmVkKG9ic2VydmFibGUsIHRydWUpOwoJICAgIH0KCSAgICBzdG9yZSA9IGtiLnV0aWxzLndyYXBwZWRTdG9yZShvYnNlcnZhYmxlLCBvcHRpb25zLnN0b3JlIHx8IG5ldyBrYi5TdG9yZSgpKTsKCSAgICBzdG9yZS5yZXRhaW4ob2JzZXJ2YWJsZSwgb2JqLCBvcHRpb25zLmNyZWF0b3IpOwoJICAgIHJldHVybiBzdG9yZTsKCSAgfTsKCgkgIGZ1bmN0aW9uIFN0b3JlKCkgewoJICAgIHRoaXMub2JzZXJ2YWJsZV9yZWNvcmRzID0ge307CgkgICAgdGhpcy5yZXBsYWNlZF9vYnNlcnZhYmxlcyA9IFtdOwoJICAgIGtiLlN0b3JlLmluc3RhbmNlcy5wdXNoKHRoaXMpOwoJICB9CgoJICBTdG9yZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciBpbmRleDsKCSAgICB0aGlzLl9fa2JfcmVsZWFzZWQgPSB0cnVlOwoJICAgIHRoaXMuY2xlYXIoKTsKCSAgICBpZiAoKGluZGV4ID0gXy5pbmRleE9mKGtiLlN0b3JlLmluc3RhbmNlcywgdGhpcykpID49IDApIHsKCSAgICAgIHJldHVybiBrYi5TdG9yZS5pbnN0YW5jZXMuc3BsaWNlKGluZGV4LCAxKTsKCSAgICB9CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgY2lkLCBjcmVhdG9yX2lkLCBvYnNlcnZhYmxlLCBvYnNlcnZhYmxlX3JlY29yZHMsIHJlY29yZHMsIHJlcGxhY2VkX29ic2VydmFibGVzLCBfaSwgX2xlbiwgX3JlZjEsIF9yZWYyOwoJICAgIF9yZWYxID0gW3RoaXMub2JzZXJ2YWJsZV9yZWNvcmRzLCB7fV0sIG9ic2VydmFibGVfcmVjb3JkcyA9IF9yZWYxWzBdLCB0aGlzLm9ic2VydmFibGVfcmVjb3JkcyA9IF9yZWYxWzFdOwoJICAgIGZvciAoY3JlYXRvcl9pZCBpbiBvYnNlcnZhYmxlX3JlY29yZHMpIHsKCSAgICAgIHJlY29yZHMgPSBvYnNlcnZhYmxlX3JlY29yZHNbY3JlYXRvcl9pZF07CgkgICAgICBmb3IgKGNpZCBpbiByZWNvcmRzKSB7CgkgICAgICAgIG9ic2VydmFibGUgPSByZWNvcmRzW2NpZF07CgkgICAgICAgIHRoaXMucmVsZWFzZShvYnNlcnZhYmxlLCB0cnVlKTsKCSAgICAgIH0KCSAgICB9CgkgICAgX3JlZjIgPSBbdGhpcy5yZXBsYWNlZF9vYnNlcnZhYmxlcywgW11dLCByZXBsYWNlZF9vYnNlcnZhYmxlcyA9IF9yZWYyWzBdLCB0aGlzLnJlcGxhY2VkX29ic2VydmFibGVzID0gX3JlZjJbMV07CgkgICAgZm9yIChfaSA9IDAsIF9sZW4gPSByZXBsYWNlZF9vYnNlcnZhYmxlcy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgb2JzZXJ2YWJsZSA9IHJlcGxhY2VkX29ic2VydmFibGVzW19pXTsKCSAgICAgIGlmICghb2JzZXJ2YWJsZS5fX2tiX3JlbGVhc2VkKSB7CgkgICAgICAgIHRoaXMucmVsZWFzZShvYnNlcnZhYmxlLCB0cnVlKTsKCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuY29tcGFjdCA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciBjaWQsIGNyZWF0b3JfaWQsIG9ic2VydmFibGUsIHJlY29yZHMsIF9yZWYxOwoJICAgIF9yZWYxID0gdGhpcy5vYnNlcnZhYmxlX3JlY29yZHM7CgkgICAgZm9yIChjcmVhdG9yX2lkIGluIF9yZWYxKSB7CgkgICAgICByZWNvcmRzID0gX3JlZjFbY3JlYXRvcl9pZF07CgkgICAgICBmb3IgKGNpZCBpbiByZWNvcmRzKSB7CgkgICAgICAgIG9ic2VydmFibGUgPSByZWNvcmRzW2NpZF07CgkgICAgICAgIGlmIChvYnNlcnZhYmxlLl9fa2JfcmVsZWFzZWQpIHsKCSAgICAgICAgICBkZWxldGUgcmVjb3Jkc1tjaWRdOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLnJldGFpbiA9IGZ1bmN0aW9uKG9ic2VydmFibGUsIG9iaiwgY3JlYXRvcikgewoJICAgIHZhciBjdXJyZW50X29ic2VydmFibGU7CgkgICAgaWYgKCF0aGlzLl9jYW5SZWdpc3RlcihvYnNlcnZhYmxlKSkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBjcmVhdG9yIHx8IChjcmVhdG9yID0gb2JzZXJ2YWJsZS5jb25zdHJ1Y3Rvcik7CgkgICAgaWYgKGN1cnJlbnRfb2JzZXJ2YWJsZSA9IHRoaXMuZmluZChvYmosIGNyZWF0b3IpKSB7CgkgICAgICBpZiAoY3VycmVudF9vYnNlcnZhYmxlID09PSBvYnNlcnZhYmxlKSB7CgkgICAgICAgIHRoaXMuX2dldE9yQ3JlYXRlU3RvcmVSZWZlcmVuY2VzKG9ic2VydmFibGUpLnJlZl9jb3VudCsrOwoJICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgICAgIH0KCSAgICAgIHRoaXMuX3JldGlyZShjdXJyZW50X29ic2VydmFibGUpOwoJICAgIH0KCSAgICB0aGlzLl9hZGQob2JzZXJ2YWJsZSwgb2JqLCBjcmVhdG9yKTsKCSAgICB0aGlzLl9nZXRPckNyZWF0ZVN0b3JlUmVmZXJlbmNlcyhvYnNlcnZhYmxlKS5yZWZfY291bnQrKzsKCSAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5yZXRhaW5PckNyZWF0ZSA9IGZ1bmN0aW9uKG9iaiwgb3B0aW9ucykgewoJICAgIHZhciBjcmVhdG9yLCBvYnNlcnZhYmxlOwoJICAgIGlmICghKGNyZWF0b3IgPSB0aGlzLl9jcmVhdG9yKG9iaiwgb3B0aW9ucykpKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuY3JlYXRlRnJvbURlZmF1bHRDcmVhdG9yKG9iaiwgb3B0aW9ucyk7CgkgICAgfQoJICAgIGlmIChjcmVhdG9yLm1vZGVsc19vbmx5KSB7CgkgICAgICByZXR1cm4gb2JqOwoJICAgIH0KCSAgICBpZiAob2JzZXJ2YWJsZSA9IHRoaXMuZmluZChvYmosIGNyZWF0b3IpKSB7CgkgICAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgICB9CgkgICAgaWYgKCFfLmlzRnVuY3Rpb24oY3JlYXRvci5jcmVhdGUgfHwgY3JlYXRvcikpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBmYWN0b3J5IGZvciBcIiIgKyBvcHRpb25zLnBhdGggKyAiXCIiKTsKCSAgICB9CgkgICAgb2JzZXJ2YWJsZSA9IGtiLmlnbm9yZSgoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMoewoJICAgICAgICAgIHN0b3JlOiBfdGhpcywKCSAgICAgICAgICBjcmVhdG9yOiBjcmVhdG9yCgkgICAgICAgIH0sIG9wdGlvbnMpOwoJICAgICAgICBvYnNlcnZhYmxlID0gY3JlYXRvci5jcmVhdGUgPyBjcmVhdG9yLmNyZWF0ZShvYmosIG9wdGlvbnMpIDogbmV3IGNyZWF0b3Iob2JqLCBvcHRpb25zKTsKCSAgICAgICAgcmV0dXJuIG9ic2VydmFibGUgfHwga28ub2JzZXJ2YWJsZShudWxsKTsKCSAgICAgIH07CgkgICAgfSkodGhpcykpOwoJICAgIHRoaXMucmV0YWluKG9ic2VydmFibGUsIG9iaiwgY3JlYXRvcik7CgkgICAgcmV0dXJuIG9ic2VydmFibGU7CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUucmV1c2UgPSBmdW5jdGlvbihvYnNlcnZhYmxlLCBvYmopIHsKCSAgICB2YXIgY3JlYXRvciwgY3VycmVudF9vYmosIGN1cnJlbnRfb2JzZXJ2YWJsZTsKCSAgICBpZiAoKGN1cnJlbnRfb2JqID0ga2IudXRpbHMud3JhcHBlZE9iamVjdChvYnNlcnZhYmxlKSkgPT09IG9iaikgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBpZiAoIXRoaXMuX2NhblJlZ2lzdGVyKG9ic2VydmFibGUpKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCByZXVzZSBhIHNpbXBsZSBvYnNlcnZhYmxlJyk7CgkgICAgfQoJICAgIGlmICh0aGlzLl9yZWZDb3VudChvYnNlcnZhYmxlKSAhPT0gMSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCJUcnlpbmcgdG8gY2hhbmdlIGEgc2hhcmVkIHZpZXcgbW9kZWwuIFJlZiBjb3VudDogIiArICh0aGlzLl9yZWZDb3VudChvYnNlcnZhYmxlKSkpOwoJICAgIH0KCSAgICBjcmVhdG9yID0ga2IudXRpbHMud3JhcHBlZENyZWF0b3Iob2JzZXJ2YWJsZSkgfHwgb2JzZXJ2YWJsZS5jb25zdHJ1Y3RvcjsKCSAgICBpZiAoIV8uaXNVbmRlZmluZWQoY3VycmVudF9vYmopKSB7CgkgICAgICBjdXJyZW50X29ic2VydmFibGUgPSB0aGlzLmZpbmQoY3VycmVudF9vYmosIGNyZWF0b3IpOwoJICAgIH0KCSAgICB0aGlzLnJldGFpbihvYnNlcnZhYmxlLCBvYmosIGNyZWF0b3IpOwoJICAgIGlmIChjdXJyZW50X29ic2VydmFibGUpIHsKCSAgICAgIHRoaXMucmVsZWFzZShjdXJyZW50X29ic2VydmFibGUpOwoJICAgIH0KCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5yZWxlYXNlID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSwgZm9yY2UpIHsKCSAgICB2YXIgc3RvcmVfcmVmZXJlbmNlczsKCSAgICBpZiAoIXRoaXMuX2NhblJlZ2lzdGVyKG9ic2VydmFibGUpKSB7CgkgICAgICByZXR1cm4ga2IucmVsZWFzZShvYnNlcnZhYmxlKTsKCSAgICB9CgkgICAgaWYgKHN0b3JlX3JlZmVyZW5jZXMgPSB0aGlzLl9zdG9yZVJlZmVyZW5jZXMob2JzZXJ2YWJsZSkpIHsKCSAgICAgIGlmICghZm9yY2UgJiYgLS1zdG9yZV9yZWZlcmVuY2VzLnJlZl9jb3VudCA+IDApIHsKCSAgICAgICAgcmV0dXJuOwoJICAgICAgfQoJICAgICAgdGhpcy5fY2xlYXJTdG9yZVJlZmVyZW5jZXMob2JzZXJ2YWJsZSk7CgkgICAgfQoJICAgIHRoaXMuX3JlbW92ZShvYnNlcnZhYmxlKTsKCSAgICBpZiAob2JzZXJ2YWJsZS5fX2tiX3JlbGVhc2VkKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGlmIChmb3JjZSB8fCB0aGlzLl9yZWZDb3VudChvYnNlcnZhYmxlKSA8PSAxKSB7CgkgICAgICByZXR1cm4ga2IucmVsZWFzZShvYnNlcnZhYmxlKTsKCSAgICB9CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuZmluZCA9IGZ1bmN0aW9uKG9iaiwgY3JlYXRvcikgewoJICAgIHZhciBvYnNlcnZhYmxlLCByZWNvcmRzLCBfcmVmMTsKCSAgICBpZiAoIShyZWNvcmRzID0gdGhpcy5vYnNlcnZhYmxlX3JlY29yZHNbdGhpcy5fY3JlYXRvcklkKGNyZWF0b3IpXSkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAoKF9yZWYxID0gKG9ic2VydmFibGUgPSByZWNvcmRzW3RoaXMuX2NpZChvYmopXSkpICE9IG51bGwgPyBfcmVmMS5fX2tiX3JlbGVhc2VkIDogdm9pZCAwKSB7CgkgICAgICBkZWxldGUgcmVjb3Jkc1t0aGlzLl9jaWQob2JqKV07CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgcmV0dXJuIG9ic2VydmFibGU7CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX3JlZkNvdW50ID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSkgewoJICAgIHZhciBzdG9yZXNfcmVmZXJlbmNlczsKCSAgICBpZiAob2JzZXJ2YWJsZS5fX2tiX3JlbGVhc2VkKSB7CgkgICAgICBpZiAodHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUgIT09IG51bGwpIHsKCSAgICAgICAgY29uc29sZS5sb2coJ09ic2VydmFibGUgYWxyZWFkeSByZWxlYXNlZCcpOwoJICAgICAgfQoJICAgICAgcmV0dXJuIDA7CgkgICAgfQoJICAgIGlmICghKHN0b3Jlc19yZWZlcmVuY2VzID0ga2IudXRpbHMuZ2V0KG9ic2VydmFibGUsICdzdG9yZXNfcmVmZXJlbmNlcycpKSkgewoJICAgICAgcmV0dXJuIDE7CgkgICAgfQoJICAgIHJldHVybiBfLnJlZHVjZShzdG9yZXNfcmVmZXJlbmNlcywgKGZ1bmN0aW9uKG1lbW8sIHN0b3JlX3JlZmVyZW5jZXMpIHsKCSAgICAgIHJldHVybiBtZW1vICsgc3RvcmVfcmVmZXJlbmNlcy5yZWZfY291bnQ7CgkgICAgfSksIDApOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9jYW5SZWdpc3RlciA9IGZ1bmN0aW9uKG9ic2VydmFibGUpIHsKCSAgICByZXR1cm4gb2JzZXJ2YWJsZSAmJiAha28uaXNPYnNlcnZhYmxlKG9ic2VydmFibGUpICYmICFvYnNlcnZhYmxlLl9fa2JfaXNfY287CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX2NpZCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBjaWQ7CgkgICAgcmV0dXJuIGNpZCA9IG9iaiA/IG9iai5jaWQgfHwgKG9iai5jaWQgPSBfLnVuaXF1ZUlkKCdjJykpIDogJ251bGwnOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9jcmVhdG9ySWQgPSBmdW5jdGlvbihjcmVhdG9yKSB7CgkgICAgdmFyIGNyZWF0ZSwgaXRlbSwgX2ksIF9sZW4sIF9yZWYxOwoJICAgIGNyZWF0ZSA9IGNyZWF0b3IuY3JlYXRlIHx8IGNyZWF0b3I7CgkgICAgY3JlYXRlLl9fa2JfY2lkcyB8fCAoY3JlYXRlLl9fa2JfY2lkcyA9IFtdKTsKCSAgICBfcmVmMSA9IGNyZWF0ZS5fX2tiX2NpZHM7CgkgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBfcmVmMS5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgaXRlbSA9IF9yZWYxW19pXTsKCSAgICAgIGlmIChpdGVtLmNyZWF0ZSA9PT0gY3JlYXRlKSB7CgkgICAgICAgIHJldHVybiBpdGVtLmNpZDsKCSAgICAgIH0KCSAgICB9CgkgICAgY3JlYXRlLl9fa2JfY2lkcy5wdXNoKGl0ZW0gPSB7CgkgICAgICBjcmVhdGU6IGNyZWF0ZSwKCSAgICAgIGNpZDogXy51bmlxdWVJZCgna2InKQoJICAgIH0pOwoJICAgIHJldHVybiBpdGVtLmNpZDsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fc3RvcmVSZWZlcmVuY2VzID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSkgewoJICAgIHZhciBzdG9yZXNfcmVmZXJlbmNlczsKCSAgICBpZiAoIShzdG9yZXNfcmVmZXJlbmNlcyA9IGtiLnV0aWxzLmdldChvYnNlcnZhYmxlLCAnc3RvcmVzX3JlZmVyZW5jZXMnKSkpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgcmV0dXJuIF8uZmluZChzdG9yZXNfcmVmZXJlbmNlcywgKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oc3RvcmVfcmVmZXJlbmNlcykgewoJICAgICAgICByZXR1cm4gc3RvcmVfcmVmZXJlbmNlcy5zdG9yZSA9PT0gX3RoaXM7CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKTsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fZ2V0T3JDcmVhdGVTdG9yZVJlZmVyZW5jZXMgPSBmdW5jdGlvbihvYnNlcnZhYmxlKSB7CgkgICAgdmFyIHN0b3JlX3JlZmVyZW5jZXMsIHN0b3Jlc19yZWZlcmVuY2VzOwoJICAgIHN0b3Jlc19yZWZlcmVuY2VzID0ga2IudXRpbHMub3JTZXQob2JzZXJ2YWJsZSwgJ3N0b3Jlc19yZWZlcmVuY2VzJywgW10pOwoJICAgIGlmICghKHN0b3JlX3JlZmVyZW5jZXMgPSBfLmZpbmQoc3RvcmVzX3JlZmVyZW5jZXMsIChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKHN0b3JlX3JlZmVyZW5jZXMpIHsKCSAgICAgICAgcmV0dXJuIHN0b3JlX3JlZmVyZW5jZXMuc3RvcmUgPT09IF90aGlzOwoJICAgICAgfTsKCSAgICB9KSh0aGlzKSkpKSB7CgkgICAgICBzdG9yZXNfcmVmZXJlbmNlcy5wdXNoKHN0b3JlX3JlZmVyZW5jZXMgPSB7CgkgICAgICAgIHN0b3JlOiB0aGlzLAoJICAgICAgICByZWZfY291bnQ6IDAsCgkgICAgICAgIHJlbGVhc2U6IChmdW5jdGlvbihfdGhpcykgewoJICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHJldHVybiBfdGhpcy5yZWxlYXNlKG9ic2VydmFibGUpOwoJICAgICAgICAgIH07CgkgICAgICAgIH0pKHRoaXMpCgkgICAgICB9KTsKCSAgICB9CgkgICAgcmV0dXJuIHN0b3JlX3JlZmVyZW5jZXM7CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX2NsZWFyU3RvcmVSZWZlcmVuY2VzID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSkgewoJICAgIHZhciBpbmRleCwgc3RvcmVfcmVmZXJlbmNlcywgc3RvcmVzX3JlZmVyZW5jZXMsIF9yZWYxOwoJICAgIGlmIChzdG9yZXNfcmVmZXJlbmNlcyA9IGtiLnV0aWxzLmdldChvYnNlcnZhYmxlLCAnc3RvcmVzX3JlZmVyZW5jZXMnKSkgewoJICAgICAgX3JlZjEgPSBvYnNlcnZhYmxlLl9fa2Iuc3RvcmVzX3JlZmVyZW5jZXM7CgkgICAgICBmb3IgKGluZGV4IGluIF9yZWYxKSB7CgkgICAgICAgIHN0b3JlX3JlZmVyZW5jZXMgPSBfcmVmMVtpbmRleF07CgkgICAgICAgIGlmIChzdG9yZV9yZWZlcmVuY2VzLnN0b3JlID09PSB0aGlzKSB7CgkgICAgICAgICAgb2JzZXJ2YWJsZS5fX2tiLnN0b3Jlc19yZWZlcmVuY2VzLnNwbGljZShpbmRleCwgMSk7CgkgICAgICAgICAgYnJlYWs7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX3JldGlyZSA9IGZ1bmN0aW9uKG9ic2VydmFibGUpIHsKCSAgICB0aGlzLl9jbGVhclN0b3JlUmVmZXJlbmNlcyhvYnNlcnZhYmxlKTsKCSAgICB0aGlzLnJlcGxhY2VkX29ic2VydmFibGVzLnB1c2gob2JzZXJ2YWJsZSk7CgkgICAgcmV0dXJuIHRoaXMuX3JlbW92ZShvYnNlcnZhYmxlKTsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fYWRkID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSwgb2JqLCBjcmVhdG9yKSB7CgkgICAgdmFyIF9iYXNlLCBfbmFtZTsKCSAgICBjcmVhdG9yIHx8IChjcmVhdG9yID0gb2JzZXJ2YWJsZS5jb25zdHJ1Y3Rvcik7CgkgICAga2IudXRpbHMud3JhcHBlZE9iamVjdChvYnNlcnZhYmxlLCBvYmopOwoJICAgIGtiLnV0aWxzLndyYXBwZWRDcmVhdG9yKG9ic2VydmFibGUsIGNyZWF0b3IpOwoJICAgIHJldHVybiAoKF9iYXNlID0gdGhpcy5vYnNlcnZhYmxlX3JlY29yZHMpW19uYW1lID0gdGhpcy5fY3JlYXRvcklkKGNyZWF0b3IpXSB8fCAoX2Jhc2VbX25hbWVdID0ge30pKVt0aGlzLl9jaWQob2JqKV0gPSBvYnNlcnZhYmxlOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9yZW1vdmUgPSBmdW5jdGlvbihvYnNlcnZhYmxlKSB7CgkgICAgdmFyIGNyZWF0b3IsIGN1cnJlbnRfb2JzZXJ2YWJsZSwgb2JqOwoJICAgIGNyZWF0b3IgPSBrYi51dGlscy53cmFwcGVkQ3JlYXRvcihvYnNlcnZhYmxlKSB8fCBvYnNlcnZhYmxlLmNvbnN0cnVjdG9yOwoJICAgIGlmIChjdXJyZW50X29ic2VydmFibGUgPSB0aGlzLmZpbmQob2JqID0ga2IudXRpbHMud3JhcHBlZE9iamVjdChvYnNlcnZhYmxlKSwgY3JlYXRvcikpIHsKCSAgICAgIGlmIChjdXJyZW50X29ic2VydmFibGUgPT09IG9ic2VydmFibGUpIHsKCSAgICAgICAgZGVsZXRlIHRoaXMub2JzZXJ2YWJsZV9yZWNvcmRzW3RoaXMuX2NyZWF0b3JJZChjcmVhdG9yKV1bdGhpcy5fY2lkKG9iaildOwoJICAgICAgfQoJICAgIH0KCSAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KG9ic2VydmFibGUsIG51bGwpOwoJICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkQ3JlYXRvcihvYnNlcnZhYmxlLCBudWxsKTsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fY3JlYXRvciA9IGZ1bmN0aW9uKG9iaiwgb3B0aW9ucykgewoJICAgIHZhciBjcmVhdG9yOwoJICAgIGlmIChvcHRpb25zLmNyZWF0b3IpIHsKCSAgICAgIHJldHVybiBvcHRpb25zLmNyZWF0b3I7CgkgICAgfQoJICAgIGlmIChjcmVhdG9yID0ga2IudXRpbHMuaW5mZXJDcmVhdG9yKG9iaiwgb3B0aW9ucy5mYWN0b3J5LCBvcHRpb25zLnBhdGgpKSB7CgkgICAgICByZXR1cm4gY3JlYXRvcjsKCSAgICB9CgkgICAgaWYgKGtiLmlzTW9kZWwob2JqKSkgewoJICAgICAgcmV0dXJuIGtiLlZpZXdNb2RlbDsKCSAgICB9CgkgIH07CgoJICByZXR1cm4gU3RvcmU7CgoJfSkoKTsKCgovKioqLyB9LAovKiAxMSAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgl2YXIgVHlwZWRWYWx1ZSwga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCgltb2R1bGUuZXhwb3J0cyA9IFR5cGVkVmFsdWUgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIFR5cGVkVmFsdWUoY3JlYXRlX29wdGlvbnMpIHsKCSAgICB0aGlzLmNyZWF0ZV9vcHRpb25zID0gY3JlYXRlX29wdGlvbnM7CgkgICAgdGhpcy5fdm8gPSBrby5vYnNlcnZhYmxlKG51bGwpOwoJICB9CgoJICBUeXBlZFZhbHVlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIHByZXZpb3VzX3ZhbHVlOwoJICAgIHRoaXMuX19rYl9yZWxlYXNlZCA9IHRydWU7CgkgICAgaWYgKHByZXZpb3VzX3ZhbHVlID0gdGhpcy5fX2tiX3ZhbHVlKSB7CgkgICAgICB0aGlzLl9fa2JfdmFsdWUgPSBudWxsOwoJICAgICAgaWYgKHRoaXMuY3JlYXRlX29wdGlvbnMuc3RvcmUgJiYga2IudXRpbHMud3JhcHBlZENyZWF0b3IocHJldmlvdXNfdmFsdWUpKSB7CgkgICAgICAgIHRoaXMuY3JlYXRlX29wdGlvbnMuc3RvcmUucmVsZWFzZShwcmV2aW91c192YWx1ZSk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBrYi5yZWxlYXNlKHByZXZpb3VzX3ZhbHVlKTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHRoaXMuY3JlYXRlX29wdGlvbnMgPSBudWxsOwoJICB9OwoKCSAgVHlwZWRWYWx1ZS5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh0aGlzLl92bygpKTsKCSAgfTsKCgkgIFR5cGVkVmFsdWUucHJvdG90eXBlLnJhd1ZhbHVlID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIHRoaXMuX19rYl92YWx1ZTsKCSAgfTsKCgkgIFR5cGVkVmFsdWUucHJvdG90eXBlLnZhbHVlVHlwZSA9IGZ1bmN0aW9uKG1vZGVsLCBrZXkpIHsKCSAgICB2YXIgbmV3X3ZhbHVlOwoJICAgIG5ld192YWx1ZSA9IGtiLmdldFZhbHVlKG1vZGVsLCBrZXkpOwoJICAgIHRoaXMudmFsdWVfdHlwZSB8fCB0aGlzLl91cGRhdGVWYWx1ZU9ic2VydmFibGUobmV3X3ZhbHVlKTsKCSAgICByZXR1cm4gdGhpcy52YWx1ZV90eXBlOwoJICB9OwoKCSAgVHlwZWRWYWx1ZS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24obmV3X3ZhbHVlKSB7CgkgICAgdmFyIG5ld190eXBlLCB2YWx1ZSwgX3JlZjE7CgkgICAgaWYgKHRoaXMuX19rYl9yZWxlYXNlZCkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICAobmV3X3ZhbHVlICE9PSB2b2lkIDApIHx8IChuZXdfdmFsdWUgPSBudWxsKTsKCSAgICBuZXdfdHlwZSA9IGtiLnV0aWxzLnZhbHVlVHlwZShuZXdfdmFsdWUpOwoJICAgIGlmICgoX3JlZjEgPSB0aGlzLl9fa2JfdmFsdWUpICE9IG51bGwgPyBfcmVmMS5fX2tiX3JlbGVhc2VkIDogdm9pZCAwKSB7CgkgICAgICB0aGlzLl9fa2JfdmFsdWUgPSB0aGlzLnZhbHVlX3R5cGUgPSB2b2lkIDA7CgkgICAgfQoJICAgIHZhbHVlID0gdGhpcy5fX2tiX3ZhbHVlOwoJICAgIHN3aXRjaCAodGhpcy52YWx1ZV90eXBlKSB7CgkgICAgICBjYXNlIGtiLlRZUEVfQ09MTEVDVElPTjoKCSAgICAgICAgaWYgKHRoaXMudmFsdWVfdHlwZSA9PT0ga2IuVFlQRV9DT0xMRUNUSU9OICYmIG5ld190eXBlID09PSBrYi5UWVBFX0FSUkFZKSB7CgkgICAgICAgICAgcmV0dXJuIHZhbHVlKG5ld192YWx1ZSk7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKG5ld190eXBlID09PSBrYi5UWVBFX0NPTExFQ1RJT04gfHwgXy5pc051bGwobmV3X3ZhbHVlKSkgewoJICAgICAgICAgIGlmIChuZXdfdmFsdWUgJiYgbmV3X3ZhbHVlIGluc3RhbmNlb2Yga2IuQ29sbGVjdGlvbk9ic2VydmFibGUpIHsKCSAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZhbHVlT2JzZXJ2YWJsZShrYi51dGlscy53cmFwcGVkT2JqZWN0KG5ld192YWx1ZSksIG5ld192YWx1ZSk7CgkgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGlmIChrYi5wZWVrKHZhbHVlLmNvbGxlY3Rpb24pICE9PSBuZXdfdmFsdWUpIHsKCSAgICAgICAgICAgICAgdmFsdWUuY29sbGVjdGlvbihuZXdfdmFsdWUpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgIH0KCSAgICAgICAgICByZXR1cm47CgkgICAgICAgIH0KCSAgICAgICAgYnJlYWs7CgkgICAgICBjYXNlIGtiLlRZUEVfTU9ERUw6CgkgICAgICAgIGlmIChuZXdfdHlwZSA9PT0ga2IuVFlQRV9NT0RFTCB8fCBfLmlzTnVsbChuZXdfdmFsdWUpKSB7CgkgICAgICAgICAgaWYgKG5ld192YWx1ZSAmJiAha2IuaXNNb2RlbChuZXdfdmFsdWUpKSB7CgkgICAgICAgICAgICB0aGlzLl91cGRhdGVWYWx1ZU9ic2VydmFibGUoa2IudXRpbHMud3JhcHBlZE9iamVjdChuZXdfdmFsdWUpLCBuZXdfdmFsdWUpOwoJICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBpZiAoa2IudXRpbHMud3JhcHBlZE9iamVjdCh2YWx1ZSkgIT09IGtiLnV0aWxzLnJlc29sdmVNb2RlbChuZXdfdmFsdWUpKSB7CgkgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZhbHVlT2JzZXJ2YWJsZShuZXdfdmFsdWUpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgIH0KCSAgICAgICAgICByZXR1cm47CgkgICAgICAgIH0KCSAgICB9CgkgICAgaWYgKHRoaXMudmFsdWVfdHlwZSA9PT0gbmV3X3R5cGUgJiYgIV8uaXNVbmRlZmluZWQodGhpcy52YWx1ZV90eXBlKSkgewoJICAgICAgaWYgKGtiLnBlZWsodmFsdWUpICE9PSBuZXdfdmFsdWUpIHsKCSAgICAgICAgcmV0dXJuIHZhbHVlKG5ld192YWx1ZSk7CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIGlmIChrYi5wZWVrKHZhbHVlKSAhPT0gbmV3X3ZhbHVlKSB7CgkgICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVWYWx1ZU9ic2VydmFibGUobmV3X3ZhbHVlKTsKCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICBUeXBlZFZhbHVlLnByb3RvdHlwZS5fdXBkYXRlVmFsdWVPYnNlcnZhYmxlID0gZnVuY3Rpb24obmV3X3ZhbHVlLCBuZXdfb2JzZXJ2YWJsZSkgewoJICAgIHZhciBjcmVhdGVfb3B0aW9ucywgY3JlYXRvciwgcHJldmlvdXNfdmFsdWUsIHZhbHVlLCB2YWx1ZV90eXBlLCBfcmVmMTsKCSAgICBjcmVhdGVfb3B0aW9ucyA9IHRoaXMuY3JlYXRlX29wdGlvbnM7CgkgICAgY3JlYXRvciA9IGtiLnV0aWxzLmluZmVyQ3JlYXRvcihuZXdfdmFsdWUsIGNyZWF0ZV9vcHRpb25zLmZhY3RvcnksIGNyZWF0ZV9vcHRpb25zLnBhdGgpOwoJICAgIGlmICgobmV3X3ZhbHVlID09PSBudWxsKSAmJiAhY3JlYXRvcikgewoJICAgICAgaWYgKHRoaXMudmFsdWVfdHlwZSA9PT0ga2IuVFlQRV9NT0RFTCkgewoJICAgICAgICBjcmVhdG9yID0ga2IuVmlld01vZGVsOwoJICAgICAgfSBlbHNlIGlmICh0aGlzLnZhbHVlX3R5cGUgPT09IGtiLlRZUEVfQ09MTEVDVElPTikgewoJICAgICAgICBjcmVhdG9yID0ga2IuQ29sbGVjdGlvbk9ic2VydmFibGU7CgkgICAgICB9CgkgICAgfQoJICAgIGNyZWF0ZV9vcHRpb25zLmNyZWF0b3IgPSBjcmVhdG9yOwoJICAgIHZhbHVlX3R5cGUgPSBrYi5UWVBFX1VOS05PV047CgkgICAgX3JlZjEgPSBbdGhpcy5fX2tiX3ZhbHVlLCB2b2lkIDBdLCBwcmV2aW91c192YWx1ZSA9IF9yZWYxWzBdLCB0aGlzLl9fa2JfdmFsdWUgPSBfcmVmMVsxXTsKCSAgICBpZiAobmV3X29ic2VydmFibGUpIHsKCSAgICAgIHZhbHVlID0gbmV3X29ic2VydmFibGU7CgkgICAgICBpZiAoY3JlYXRlX29wdGlvbnMuc3RvcmUpIHsKCSAgICAgICAgY3JlYXRlX29wdGlvbnMuc3RvcmUucmV0YWluKG5ld19vYnNlcnZhYmxlLCBuZXdfdmFsdWUsIGNyZWF0b3IpOwoJICAgICAgfQoJICAgIH0gZWxzZSBpZiAoY3JlYXRvcikgewoJICAgICAgaWYgKGNyZWF0ZV9vcHRpb25zLnN0b3JlKSB7CgkgICAgICAgIHZhbHVlID0gY3JlYXRlX29wdGlvbnMuc3RvcmUucmV0YWluT3JDcmVhdGUobmV3X3ZhbHVlLCBjcmVhdGVfb3B0aW9ucyk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBpZiAoY3JlYXRvci5tb2RlbHNfb25seSkgewoJICAgICAgICAgIHZhbHVlID0gbmV3X3ZhbHVlOwoJICAgICAgICAgIHZhbHVlX3R5cGUgPSBrYi5UWVBFX1NJTVBMRTsKCSAgICAgICAgfSBlbHNlIGlmIChjcmVhdG9yLmNyZWF0ZSkgewoJICAgICAgICAgIHZhbHVlID0gY3JlYXRvci5jcmVhdGUobmV3X3ZhbHVlLCBjcmVhdGVfb3B0aW9ucyk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgdmFsdWUgPSBuZXcgY3JlYXRvcihuZXdfdmFsdWUsIGNyZWF0ZV9vcHRpb25zKTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH0gZWxzZSB7CgkgICAgICBpZiAoXy5pc0FycmF5KG5ld192YWx1ZSkpIHsKCSAgICAgICAgdmFsdWVfdHlwZSA9IGtiLlRZUEVfQVJSQVk7CgkgICAgICAgIHZhbHVlID0ga28ub2JzZXJ2YWJsZUFycmF5KG5ld192YWx1ZSk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICB2YWx1ZV90eXBlID0ga2IuVFlQRV9TSU1QTEU7CgkgICAgICAgIHZhbHVlID0ga28ub2JzZXJ2YWJsZShuZXdfdmFsdWUpOwoJICAgICAgfQoJICAgIH0KCSAgICBpZiAoKHRoaXMudmFsdWVfdHlwZSA9IHZhbHVlX3R5cGUpID09PSBrYi5UWVBFX1VOS05PV04pIHsKCSAgICAgIGlmICgha28uaXNPYnNlcnZhYmxlKHZhbHVlKSkgewoJICAgICAgICB0aGlzLnZhbHVlX3R5cGUgPSBrYi5UWVBFX01PREVMOwoJICAgICAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KHZhbHVlLCBrYi51dGlscy5yZXNvbHZlTW9kZWwobmV3X3ZhbHVlKSk7CgkgICAgICB9IGVsc2UgaWYgKHZhbHVlLl9fa2JfaXNfY28pIHsKCSAgICAgICAgdGhpcy52YWx1ZV90eXBlID0ga2IuVFlQRV9DT0xMRUNUSU9OOwoJICAgICAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KHZhbHVlLCBuZXdfdmFsdWUpOwoJICAgICAgfSBlbHNlIGlmICghdGhpcy52YWx1ZV90eXBlKSB7CgkgICAgICAgIHRoaXMudmFsdWVfdHlwZSA9IGtiLlRZUEVfU0lNUExFOwoJICAgICAgfQoJICAgIH0KCSAgICBpZiAocHJldmlvdXNfdmFsdWUpIHsKCSAgICAgIGlmICh0aGlzLmNyZWF0ZV9vcHRpb25zLnN0b3JlKSB7CgkgICAgICAgIHRoaXMuY3JlYXRlX29wdGlvbnMuc3RvcmUucmVsZWFzZShwcmV2aW91c192YWx1ZSk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBrYi5yZWxlYXNlKHByZXZpb3VzX3ZhbHVlKTsKCSAgICAgIH0KCSAgICB9CgkgICAgdGhpcy5fX2tiX3ZhbHVlID0gdmFsdWU7CgkgICAgcmV0dXJuIHRoaXMuX3ZvKHZhbHVlKTsKCSAgfTsKCgkgIFR5cGVkVmFsdWUucHJvdG90eXBlLl9pbmZlclR5cGUgPSBmdW5jdGlvbih2YWx1ZSkge307CgoJICByZXR1cm4gVHlwZWRWYWx1ZTsKCgl9KSgpOwoKCi8qKiovIH0sCi8qIDEyICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGtiLCBrbywgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJa2IudXRpbHMgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIHV0aWxzKCkge30KCgkgIHV0aWxzLmdldCA9IGZ1bmN0aW9uKG9iaiwga2V5LCBkZWZhdWx0X3ZhbHVlKSB7CgkgICAgaWYgKCFvYmouX19rYiB8fCAhb2JqLl9fa2IuaGFzT3duUHJvcGVydHkoa2V5KSkgewoJICAgICAgcmV0dXJuIGRlZmF1bHRfdmFsdWU7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBvYmouX19rYltrZXldOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLnNldCA9IGZ1bmN0aW9uKG9iaiwga2V5LCB2YWx1ZSkgewoJICAgIHJldHVybiAob2JqLl9fa2IgfHwgKG9iai5fX2tiID0ge30pKVtrZXldID0gdmFsdWU7CgkgIH07CgoJICB1dGlscy5vclNldCA9IGZ1bmN0aW9uKG9iaiwga2V5LCB2YWx1ZSkgewoJICAgIGlmICghKG9iai5fX2tiIHx8IChvYmouX19rYiA9IHt9KSkuaGFzT3duUHJvcGVydHkoa2V5KSkgewoJICAgICAgb2JqLl9fa2Jba2V5XSA9IHZhbHVlOwoJICAgIH0KCSAgICByZXR1cm4gb2JqLl9fa2Jba2V5XTsKCSAgfTsKCgkgIHV0aWxzLmhhcyA9IGZ1bmN0aW9uKG9iaiwga2V5KSB7CgkgICAgcmV0dXJuIG9iai5fX2tiICYmIG9iai5fX2tiLmhhc093blByb3BlcnR5KGtleSk7CgkgIH07CgoJICB1dGlscy53cmFwcGVkT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLmdldChvYmosICdvYnNlcnZhYmxlJyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnb2JzZXJ2YWJsZScsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkT2JqZWN0ID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuZ2V0KG9iaiwgJ29iamVjdCcpOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuc2V0KG9iaiwgJ29iamVjdCcsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkQ3JlYXRvciA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLmdldChvYmosICdjcmVhdG9yJyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnY3JlYXRvcicsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkTW9kZWwgPSBmdW5jdGlvbihvYmosIHZhbHVlKSB7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKCSAgICAgIGlmIChfLmlzVW5kZWZpbmVkKHZhbHVlID0ga2IudXRpbHMuZ2V0KG9iaiwgJ29iamVjdCcpKSkgewoJICAgICAgICByZXR1cm4gb2JqOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgcmV0dXJuIHZhbHVlOwoJICAgICAgfQoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuc2V0KG9iaiwgJ29iamVjdCcsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkU3RvcmUgPSBmdW5jdGlvbihvYmosIHZhbHVlKSB7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5nZXQob2JqLCAnc3RvcmUnKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLnNldChvYmosICdzdG9yZScsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkU3RvcmVJc093bmVkID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuZ2V0KG9iaiwgJ3N0b3JlX2lzX293bmVkJyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnc3RvcmVfaXNfb3duZWQnLCB2YWx1ZSk7CgkgICAgfQoJICB9OwoKCSAgdXRpbHMud3JhcHBlZEZhY3RvcnkgPSBmdW5jdGlvbihvYmosIHZhbHVlKSB7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5nZXQob2JqLCAnZmFjdG9yeScpOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuc2V0KG9iaiwgJ2ZhY3RvcnknLCB2YWx1ZSk7CgkgICAgfQoJICB9OwoKCSAgdXRpbHMud3JhcHBlZEV2ZW50V2F0Y2hlciA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLmdldChvYmosICdldmVudF93YXRjaGVyJyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnZXZlbnRfd2F0Y2hlcicsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkRXZlbnRXYXRjaGVySXNPd25lZCA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLmdldChvYmosICdldmVudF93YXRjaGVyX2lzX293bmVkJyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnZXZlbnRfd2F0Y2hlcl9pc19vd25lZCcsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkRGVzdHJveSA9IF9fd2VicGFja19yZXF1aXJlX18oMjcpOwoKCSAgdXRpbHMudmFsdWVUeXBlID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSkgewoJICAgIGlmICghb2JzZXJ2YWJsZSkgewoJICAgICAgcmV0dXJuIGtiLlRZUEVfVU5LTk9XTjsKCSAgICB9CgkgICAgaWYgKG9ic2VydmFibGUuX19rYl9pc19vKSB7CgkgICAgICByZXR1cm4gb2JzZXJ2YWJsZS52YWx1ZVR5cGUoKTsKCSAgICB9CgkgICAgaWYgKG9ic2VydmFibGUuX19rYl9pc19jbyB8fCAob2JzZXJ2YWJsZSBpbnN0YW5jZW9mIGtiLkNvbGxlY3Rpb24pKSB7CgkgICAgICByZXR1cm4ga2IuVFlQRV9DT0xMRUNUSU9OOwoJICAgIH0KCSAgICBpZiAoKG9ic2VydmFibGUgaW5zdGFuY2VvZiBrYi5WaWV3TW9kZWwpIHx8IChvYnNlcnZhYmxlIGluc3RhbmNlb2Yga2IuTW9kZWwpKSB7CgkgICAgICByZXR1cm4ga2IuVFlQRV9NT0RFTDsKCSAgICB9CgkgICAgaWYgKF8uaXNBcnJheShvYnNlcnZhYmxlKSkgewoJICAgICAgcmV0dXJuIGtiLlRZUEVfQVJSQVk7CgkgICAgfQoJICAgIHJldHVybiBrYi5UWVBFX1NJTVBMRTsKCSAgfTsKCgkgIHV0aWxzLnBhdGhKb2luID0gZnVuY3Rpb24ocGF0aDEsIHBhdGgyKSB7CgkgICAgcmV0dXJuIChwYXRoMSA/IChwYXRoMVtwYXRoMS5sZW5ndGggLSAxXSAhPT0gJy4nID8gIiIgKyBwYXRoMSArICIuIiA6IHBhdGgxKSA6ICcnKSArIHBhdGgyOwoJICB9OwoKCSAgdXRpbHMub3B0aW9uc1BhdGhKb2luID0gZnVuY3Rpb24ob3B0aW9ucywgcGF0aCkgewoJICAgIHJldHVybiBfLmRlZmF1bHRzKHsKCSAgICAgIHBhdGg6IHRoaXMucGF0aEpvaW4ob3B0aW9ucy5wYXRoLCBwYXRoKQoJICAgIH0sIG9wdGlvbnMpOwoJICB9OwoKCSAgdXRpbHMuaW5mZXJDcmVhdG9yID0gZnVuY3Rpb24odmFsdWUsIGZhY3RvcnksIHBhdGgpIHsKCSAgICB2YXIgY3JlYXRvcjsKCSAgICBpZiAoZmFjdG9yeSAmJiAoY3JlYXRvciA9IGZhY3RvcnkuY3JlYXRvckZvclBhdGgodmFsdWUsIHBhdGgpKSkgewoJICAgICAgcmV0dXJuIGNyZWF0b3I7CgkgICAgfQoJICAgIGlmICghdmFsdWUpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBrYi5Nb2RlbCkgewoJICAgICAgcmV0dXJuIGtiLlZpZXdNb2RlbDsKCSAgICB9CgkgICAgaWYgKHZhbHVlIGluc3RhbmNlb2Yga2IuQ29sbGVjdGlvbikgewoJICAgICAgcmV0dXJuIGtiLkNvbGxlY3Rpb25PYnNlcnZhYmxlOwoJICAgIH0KCSAgICByZXR1cm4gbnVsbDsKCSAgfTsKCgkgIHV0aWxzLmNyZWF0ZUZyb21EZWZhdWx0Q3JlYXRvciA9IGZ1bmN0aW9uKG9iaiwgb3B0aW9ucykgewoJICAgIGlmIChrYi5pc01vZGVsKG9iaikpIHsKCSAgICAgIHJldHVybiBrYi52aWV3TW9kZWwob2JqLCBvcHRpb25zKTsKCSAgICB9CgkgICAgaWYgKGtiLmlzQ29sbGVjdGlvbihvYmopKSB7CgkgICAgICByZXR1cm4ga2IuY29sbGVjdGlvbk9ic2VydmFibGUob2JqLCBvcHRpb25zKTsKCSAgICB9CgkgICAgaWYgKF8uaXNBcnJheShvYmopKSB7CgkgICAgICByZXR1cm4ga28ub2JzZXJ2YWJsZUFycmF5KG9iaik7CgkgICAgfQoJICAgIHJldHVybiBrby5vYnNlcnZhYmxlKG9iaik7CgkgIH07CgoJICB1dGlscy5jb2xsYXBzZU9wdGlvbnMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI4KTsKCgkgIHV0aWxzLnVud3JhcE1vZGVscyA9IF9fd2VicGFja19yZXF1aXJlX18oMjkpOwoKCSAgdXRpbHMucmVzb2x2ZU1vZGVsID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICBpZiAobW9kZWwgJiYga2IuQmFja2JvbmUgJiYga2IuQmFja2JvbmUuTW9kZWxSZWYgJiYgbW9kZWwgaW5zdGFuY2VvZiBrYi5CYWNrYm9uZS5Nb2RlbFJlZikgewoJICAgICAgcmV0dXJuIG1vZGVsLm1vZGVsKCk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBtb2RlbDsKCSAgICB9CgkgIH07CgoJICByZXR1cm4gdXRpbHM7CgoJfSkoKTsKCgovKioqLyB9LAovKiAxMyAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciBLRVlTX09QVElPTlMsIGFzc2lnblZpZXdNb2RlbEtleSwgY3JlYXRlT2JzZXJ2YWJsZSwgY3JlYXRlU3RhdGljT2JzZXJ2YWJsZXMsIGtiLCBrbywgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJYXNzaWduVmlld01vZGVsS2V5ID0gZnVuY3Rpb24odm0sIGtleSkgewoJICB2YXIgdm1fa2V5OwoJICB2bV9rZXkgPSB2bS5fX2tiLmludGVybmFscyAmJiBfLmNvbnRhaW5zKHZtLl9fa2IuaW50ZXJuYWxzLCBrZXkpID8gIl8iICsga2V5IDoga2V5OwoJICBpZiAodm0uX19rYi52aWV3X21vZGVsLmhhc093blByb3BlcnR5KHZtX2tleSkpIHsKCSAgICByZXR1cm47CgkgIH0KCSAgdm0uX19rYi52aWV3X21vZGVsW3ZtX2tleV0gPSBudWxsOwoJICByZXR1cm4gdm1fa2V5OwoJfTsKCgljcmVhdGVPYnNlcnZhYmxlID0gZnVuY3Rpb24odm0sIG1vZGVsLCBrZXksIGNyZWF0ZV9vcHRpb25zKSB7CgkgIHZhciB2bV9rZXk7CgkgIGlmICh2bS5fX2tiLmV4Y2x1ZGVzICYmIF8uY29udGFpbnModm0uX19rYi5leGNsdWRlcywga2V5KSkgewoJICAgIHJldHVybjsKCSAgfQoJICBpZiAodm0uX19rYi5zdGF0aWNzICYmIF8uY29udGFpbnModm0uX19rYi5zdGF0aWNzLCBrZXkpKSB7CgkgICAgcmV0dXJuOwoJICB9CgkgIGlmICghKHZtX2tleSA9IGFzc2lnblZpZXdNb2RlbEtleSh2bSwga2V5KSkpIHsKCSAgICByZXR1cm47CgkgIH0KCSAgcmV0dXJuIHZtW3ZtX2tleV0gPSB2bS5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XSA9IGtiLm9ic2VydmFibGUobW9kZWwsIGtleSwgY3JlYXRlX29wdGlvbnMsIHZtKTsKCX07CgoJY3JlYXRlU3RhdGljT2JzZXJ2YWJsZXMgPSBmdW5jdGlvbih2bSwgbW9kZWwpIHsKCSAgdmFyIGtleSwgdm1fa2V5LCBfaSwgX2xlbiwgX3JlZjE7CgkgIF9yZWYxID0gdm0uX19rYi5zdGF0aWNzOwoJICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYxLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAga2V5ID0gX3JlZjFbX2ldOwoJICAgIGlmICh2bV9rZXkgPSBhc3NpZ25WaWV3TW9kZWxLZXkodm0sIGtleSkpIHsKCSAgICAgIGlmIChtb2RlbC5oYXModm1fa2V5KSkgewoJICAgICAgICB2bVt2bV9rZXldID0gdm0uX19rYi52aWV3X21vZGVsW3ZtX2tleV0gPSBtb2RlbC5nZXQodm1fa2V5KTsKCSAgICAgIH0gZWxzZSBpZiAodm0uX19rYi5zdGF0aWNfZGVmYXVsdHMgJiYgdm1fa2V5IGluIHZtLl9fa2Iuc3RhdGljX2RlZmF1bHRzKSB7CgkgICAgICAgIHZtW3ZtX2tleV0gPSB2bS5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XSA9IHZtLl9fa2Iuc3RhdGljX2RlZmF1bHRzW3ZtX2tleV07CgkgICAgICB9IGVsc2UgewoJICAgICAgICBkZWxldGUgdm0uX19rYi52aWV3X21vZGVsW3ZtX2tleV07CgkgICAgICB9CgkgICAgfQoJICB9Cgl9OwoKCUtFWVNfT1BUSU9OUyA9IFsna2V5cycsICdpbnRlcm5hbHMnLCAnZXhjbHVkZXMnLCAnc3RhdGljcycsICdzdGF0aWNfZGVmYXVsdHMnXTsKCglrYi5WaWV3TW9kZWwgPSAoZnVuY3Rpb24oKSB7CgkgIFZpZXdNb2RlbC5leHRlbmQgPSBrYi5leHRlbmQ7CgoJICBmdW5jdGlvbiBWaWV3TW9kZWwobW9kZWwsIG9wdGlvbnMsIHZpZXdfbW9kZWwpIHsKCSAgICB2YXIgYXJnczsKCSAgICBpZiAob3B0aW9ucyA9PSBudWxsKSB7CgkgICAgICBvcHRpb25zID0ge307CgkgICAgfQoJICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChfLmlzQXJndW1lbnRzKG1vZGVsKSA/IG1vZGVsIDogYXJndW1lbnRzKTsKCSAgICByZXR1cm4ga2IuaWdub3JlKChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgYXJnLCBldmVudF93YXRjaGVyLCBrZXksIF9pLCBfaiwgX2xlbiwgX2xlbjEsIF9tb2RlbDsKCSAgICAgICAgIShtb2RlbCA9IGFyZ3Muc2hpZnQoKSkgfHwga2IuaXNNb2RlbChtb2RlbCkgfHwga2IuX3Rocm93VW5leHBlY3RlZChfdGhpcywgJ25vdCBhIG1vZGVsJyk7CgkgICAgICAgIGlmIChfLmlzQXJyYXkoYXJnc1swXSkpIHsKCSAgICAgICAgICBhcmdzWzBdID0gewoJICAgICAgICAgICAga2V5czogYXJnc1swXQoJICAgICAgICAgIH07CgkgICAgICAgIH0KCSAgICAgICAgX3RoaXMuX19rYiB8fCAoX3RoaXMuX19rYiA9IHt9KTsKCSAgICAgICAgX3RoaXMuX19rYi52aWV3X21vZGVsID0gKGFyZ3MubGVuZ3RoID4gMSA/IGFyZ3MucG9wKCkgOiBfdGhpcyk7CgkgICAgICAgIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBhcmdzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgICAgYXJnID0gYXJnc1tfaV07CgkgICAgICAgICAgXy5leHRlbmQob3B0aW9ucywgYXJnKTsKCSAgICAgICAgfQoJICAgICAgICBvcHRpb25zID0ga2IudXRpbHMuY29sbGFwc2VPcHRpb25zKG9wdGlvbnMpOwoJICAgICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBLRVlTX09QVElPTlMubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CgkgICAgICAgICAga2V5ID0gS0VZU19PUFRJT05TW19qXTsKCSAgICAgICAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CgkgICAgICAgICAgICBfdGhpcy5fX2tiW2tleV0gPSBvcHRpb25zW2tleV07CgkgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIGtiLlN0b3JlLnVzZU9wdGlvbnNPckNyZWF0ZShvcHRpb25zLCBtb2RlbCwgX3RoaXMpOwoJICAgICAgICBfdGhpcy5fX2tiLnBhdGggPSBvcHRpb25zLnBhdGg7CgkgICAgICAgIGtiLkZhY3RvcnkudXNlT3B0aW9uc09yQ3JlYXRlKG9wdGlvbnMsIF90aGlzLCBvcHRpb25zLnBhdGgpOwoJICAgICAgICBfbW9kZWwgPSBrYi51dGlscy5zZXQoX3RoaXMsICdfbW9kZWwnLCBrby5vYnNlcnZhYmxlKCkpOwoJICAgICAgICBfdGhpcy5tb2RlbCA9IGtvLmNvbXB1dGVkKHsKCSAgICAgICAgICByZWFkOiBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKF9tb2RlbCk7CgkgICAgICAgICAgfSwKCSAgICAgICAgICB3cml0ZTogZnVuY3Rpb24obmV3X21vZGVsKSB7CgkgICAgICAgICAgICByZXR1cm4ga2IuaWdub3JlKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICBpZiAoKGtiLnV0aWxzLndyYXBwZWRPYmplY3QoX3RoaXMpID09PSBuZXdfbW9kZWwpIHx8IGtiLndhc1JlbGVhc2VkKF90aGlzKSB8fCAhZXZlbnRfd2F0Y2hlcikgewoJICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICBfdGhpcy5fX2tiLnN0b3JlLnJldXNlKF90aGlzLCBrYi51dGlscy5yZXNvbHZlTW9kZWwobmV3X21vZGVsKSk7CgkgICAgICAgICAgICAgIGV2ZW50X3dhdGNoZXIuZW1pdHRlcihuZXdfbW9kZWwpOwoJICAgICAgICAgICAgICBfbW9kZWwoZXZlbnRfd2F0Y2hlci5lZSk7CgkgICAgICAgICAgICAgIHJldHVybiAhZXZlbnRfd2F0Y2hlci5lZSB8fCBfdGhpcy5jcmVhdGVPYnNlcnZhYmxlcyhldmVudF93YXRjaGVyLmVlKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgICAgIGV2ZW50X3dhdGNoZXIgPSBrYi51dGlscy53cmFwcGVkRXZlbnRXYXRjaGVyKF90aGlzLCBuZXcga2IuRXZlbnRXYXRjaGVyKG1vZGVsLCBfdGhpcywgewoJICAgICAgICAgIGVtaXR0ZXI6IF90aGlzLl9tb2RlbCwKCSAgICAgICAgICB1cGRhdGU6IChmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgIHJldHVybiAhKGV2ZW50X3dhdGNoZXIgIT0gbnVsbCA/IGV2ZW50X3dhdGNoZXIuZWUgOiB2b2lkIDApIHx8IF90aGlzLmNyZWF0ZU9ic2VydmFibGVzKGV2ZW50X3dhdGNoZXIgIT0gbnVsbCA/IGV2ZW50X3dhdGNoZXIuZWUgOiB2b2lkIDApOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgICAgfSkKCSAgICAgICAgfSkpOwoJICAgICAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KF90aGlzLCBtb2RlbCA9IGV2ZW50X3dhdGNoZXIuZWUpOwoJICAgICAgICBfbW9kZWwoZXZlbnRfd2F0Y2hlci5lZSk7CgkgICAgICAgIF90aGlzLl9fa2IuY3JlYXRlX29wdGlvbnMgPSB7CgkgICAgICAgICAgc3RvcmU6IGtiLnV0aWxzLndyYXBwZWRTdG9yZShfdGhpcyksCgkgICAgICAgICAgZmFjdG9yeToga2IudXRpbHMud3JhcHBlZEZhY3RvcnkoX3RoaXMpLAoJICAgICAgICAgIHBhdGg6IF90aGlzLl9fa2IucGF0aCwKCSAgICAgICAgICBldmVudF93YXRjaGVyOiBrYi51dGlscy53cmFwcGVkRXZlbnRXYXRjaGVyKF90aGlzKQoJICAgICAgICB9OwoJICAgICAgICAhb3B0aW9ucy5yZXF1aXJlcyB8fCBfdGhpcy5jcmVhdGVPYnNlcnZhYmxlcyhtb2RlbCwgb3B0aW9ucy5yZXF1aXJlcyk7CgkgICAgICAgICFfdGhpcy5fX2tiLmludGVybmFscyB8fCBfdGhpcy5jcmVhdGVPYnNlcnZhYmxlcyhtb2RlbCwgX3RoaXMuX19rYi5pbnRlcm5hbHMpOwoJICAgICAgICAhb3B0aW9ucy5tYXBwaW5ncyB8fCBfdGhpcy5jcmVhdGVPYnNlcnZhYmxlcyhtb2RlbCwgb3B0aW9ucy5tYXBwaW5ncyk7CgkgICAgICAgICFfdGhpcy5fX2tiLnN0YXRpY3MgfHwgY3JlYXRlU3RhdGljT2JzZXJ2YWJsZXMoX3RoaXMsIG1vZGVsKTsKCSAgICAgICAgX3RoaXMuY3JlYXRlT2JzZXJ2YWJsZXMobW9kZWwsIF90aGlzLl9fa2Iua2V5cyk7CgkgICAgICAgICFrYi5zdGF0aXN0aWNzIHx8IGtiLnN0YXRpc3RpY3MucmVnaXN0ZXIoJ1ZpZXdNb2RlbCcsIF90aGlzKTsKCSAgICAgICAgcmV0dXJuIF90aGlzOwoJICAgICAgfTsKCSAgICB9KSh0aGlzKSk7CgkgIH0KCgkgIFZpZXdNb2RlbC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciB2bV9rZXk7CgkgICAgdGhpcy5fX2tiX3JlbGVhc2VkID0gdHJ1ZTsKCSAgICBpZiAodGhpcy5fX2tiLnZpZXdfbW9kZWwgIT09IHRoaXMpIHsKCSAgICAgIGZvciAodm1fa2V5IGluIHRoaXMuX19rYi52bV9rZXlzKSB7CgkgICAgICAgIHRoaXMuX19rYi52aWV3X21vZGVsW3ZtX2tleV0gPSBudWxsOwoJICAgICAgfQoJICAgIH0KCSAgICB0aGlzLl9fa2Iudmlld19tb2RlbCA9IHRoaXMuX19rYi5jcmVhdGVfb3B0aW9ucyA9IG51bGw7CgkgICAga2IucmVsZWFzZUtleXModGhpcyk7CgkgICAga2IudXRpbHMud3JhcHBlZERlc3Ryb3kodGhpcyk7CgkgICAgcmV0dXJuICFrYi5zdGF0aXN0aWNzIHx8IGtiLnN0YXRpc3RpY3MudW5yZWdpc3RlcignVmlld01vZGVsJywgdGhpcyk7CgkgIH07CgoJICBWaWV3TW9kZWwucHJvdG90eXBlLnNoYXJlT3B0aW9ucyA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiB7CgkgICAgICBzdG9yZToga2IudXRpbHMud3JhcHBlZFN0b3JlKHRoaXMpLAoJICAgICAgZmFjdG9yeToga2IudXRpbHMud3JhcHBlZEZhY3RvcnkodGhpcykKCSAgICB9OwoJICB9OwoKCSAgVmlld01vZGVsLnByb3RvdHlwZS5jcmVhdGVPYnNlcnZhYmxlcyA9IGZ1bmN0aW9uKG1vZGVsLCBrZXlzKSB7CgkgICAgdmFyIGtleSwgbWFwcGluZ19pbmZvLCByZWxfa2V5cywgdm1fa2V5LCBfaSwgX2osIF9sZW4sIF9sZW4xLCBfcmVmMTsKCSAgICBpZiAoIWtleXMpIHsKCSAgICAgIGlmICh0aGlzLl9fa2Iua2V5cyB8fCAhbW9kZWwpIHsKCSAgICAgICAgcmV0dXJuOwoJICAgICAgfQoJICAgICAgZm9yIChrZXkgaW4gbW9kZWwuYXR0cmlidXRlcykgewoJICAgICAgICBjcmVhdGVPYnNlcnZhYmxlKHRoaXMsIG1vZGVsLCBrZXksIHRoaXMuX19rYi5jcmVhdGVfb3B0aW9ucyk7CgkgICAgICB9CgkgICAgICBpZiAocmVsX2tleXMgPSAoX3JlZjEgPSBrYi5vcm0pICE9IG51bGwgPyB0eXBlb2YgX3JlZjEua2V5cyA9PT0gImZ1bmN0aW9uIiA/IF9yZWYxLmtleXMobW9kZWwpIDogdm9pZCAwIDogdm9pZCAwKSB7CgkgICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gcmVsX2tleXMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgICAgICBrZXkgPSByZWxfa2V5c1tfaV07CgkgICAgICAgICAgY3JlYXRlT2JzZXJ2YWJsZSh0aGlzLCBtb2RlbCwga2V5LCB0aGlzLl9fa2IuY3JlYXRlX29wdGlvbnMpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfSBlbHNlIGlmIChfLmlzQXJyYXkoa2V5cykpIHsKCSAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IGtleXMubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CgkgICAgICAgIGtleSA9IGtleXNbX2pdOwoJICAgICAgICBjcmVhdGVPYnNlcnZhYmxlKHRoaXMsIG1vZGVsLCBrZXksIHRoaXMuX19rYi5jcmVhdGVfb3B0aW9ucyk7CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIGZvciAoa2V5IGluIGtleXMpIHsKCSAgICAgICAgbWFwcGluZ19pbmZvID0ga2V5c1trZXldOwoJICAgICAgICBpZiAoISh2bV9rZXkgPSBhc3NpZ25WaWV3TW9kZWxLZXkodGhpcywga2V5KSkpIHsKCSAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgfQoJICAgICAgICBpZiAoIV8uaXNTdHJpbmcobWFwcGluZ19pbmZvKSkgewoJICAgICAgICAgIG1hcHBpbmdfaW5mby5rZXkgfHwgKG1hcHBpbmdfaW5mby5rZXkgPSB2bV9rZXkpOwoJICAgICAgICB9CgkgICAgICAgIHRoaXNbdm1fa2V5XSA9IHRoaXMuX19rYi52aWV3X21vZGVsW3ZtX2tleV0gPSBrYi5vYnNlcnZhYmxlKG1vZGVsLCBtYXBwaW5nX2luZm8sIHRoaXMuX19rYi5jcmVhdGVfb3B0aW9ucywgdGhpcyk7CgkgICAgICB9CgkgICAgfQoJICB9OwoKCSAgcmV0dXJuIFZpZXdNb2RlbDsKCgl9KSgpOwoKCWtiLnZpZXdNb2RlbCA9IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zLCB2aWV3X21vZGVsKSB7CgkgIHJldHVybiBuZXcga2IuVmlld01vZGVsKGFyZ3VtZW50cyk7Cgl9OwoKCi8qKiovIH0sCi8qIDE0ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGtiLCBrZXksIF9pLCBfbGVuLCBfcmVmOwoKCW1vZHVsZS5leHBvcnRzID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpOwoKCWtiLmNvbmZpZ3VyZSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7CgoJa2IubW9kdWxlcyA9IHsKCSAgdW5kZXJzY29yZToga2IuXywKCSAgYmFja2JvbmU6IGtiLlBhcnNlIHx8IGtiLkJhY2tib25lLAoJICBrbm9ja291dDoga2Iua28KCX07CgoJaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdyAhPT0gbnVsbCkgewoJICBfcmVmID0gWydfJywgJ0JhY2tib25lJywgJ1BhcnNlJywgJ2tvJywgJyQnXTsKCSAgZm9yIChfaSA9IDAsIF9sZW4gPSBfcmVmLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAga2V5ID0gX3JlZltfaV07CgkgICAgaWYgKGtiW2tleV0gJiYgIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh3aW5kb3csIGtleSkpIHsKCSAgICAgIHdpbmRvd1trZXldID0ga2Jba2V5XTsKCSAgICB9CgkgIH0KCX0KCgovKioqLyB9LAovKiAxNSAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciBLRVlTX1BVQkxJU0gsIGtiLCBrbywgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJX193ZWJwYWNrX3JlcXVpcmVfXygyMSk7CgoJS0VZU19QVUJMSVNIID0gWydkZXN0cm95JywgJ3NldFRvRGVmYXVsdCddOwoKCW1vZHVsZS5leHBvcnRzID0ga2IuRGVmYXVsdE9ic2VydmFibGUgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIERlZmF1bHRPYnNlcnZhYmxlKHRhcmdldF9vYnNlcnZhYmxlLCBkdikgewoJICAgIHZhciBvYnNlcnZhYmxlOwoJICAgIHRoaXMuZHYgPSBkdjsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcywga28uY29tcHV0ZWQoewoJICAgICAgcmVhZDogKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgICB2YXIgY3VycmVudF90YXJnZXQ7CgkgICAgICAgICAgY3VycmVudF90YXJnZXQgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHRhcmdldF9vYnNlcnZhYmxlKCkpOwoJICAgICAgICAgIGlmIChfLmlzTnVsbChjdXJyZW50X3RhcmdldCkgfHwgXy5pc1VuZGVmaW5lZChjdXJyZW50X3RhcmdldCkpIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKF90aGlzLmR2KTsKCSAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRfdGFyZ2V0OwoJICAgICAgICAgIH0KCSAgICAgICAgfTsKCSAgICAgIH0pKHRoaXMpLAoJICAgICAgd3JpdGU6IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgICAgIHJldHVybiB0YXJnZXRfb2JzZXJ2YWJsZSh2YWx1ZSk7CgkgICAgICB9CgkgICAgfSkpOwoJICAgIGtiLnB1Ymxpc2hNZXRob2RzKG9ic2VydmFibGUsIHRoaXMsIEtFWVNfUFVCTElTSCk7CgkgICAgcmV0dXJuIG9ic2VydmFibGU7CgkgIH0KCgkgIERlZmF1bHRPYnNlcnZhYmxlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIGtiLnV0aWxzLndyYXBwZWREZXN0cm95KHRoaXMpOwoJICB9OwoKCSAgRGVmYXVsdE9ic2VydmFibGUucHJvdG90eXBlLnNldFRvRGVmYXVsdCA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZSh0aGlzKSh0aGlzLmR2KTsKCSAgfTsKCgkgIHJldHVybiBEZWZhdWx0T2JzZXJ2YWJsZTsKCgl9KSgpOwoKCWtiLmRlZmF1bHRPYnNlcnZhYmxlID0gZnVuY3Rpb24odGFyZ2V0LCBkZWZhdWx0X3ZhbHVlKSB7CgkgIHJldHVybiBuZXcga2IuRGVmYXVsdE9ic2VydmFibGUodGFyZ2V0LCBkZWZhdWx0X3ZhbHVlKTsKCX07CgoKLyoqKi8gfSwKLyogMTYgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgYXJyYXlTbGljZSwga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglhcnJheVNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKCWtiLnRvRm9ybWF0dGVkU3RyaW5nID0gZnVuY3Rpb24oZm9ybWF0KSB7CgkgIHZhciBhcmcsIGFyZ3MsIGluZGV4LCBwYXJhbWV0ZXJfaW5kZXgsIHJlc3VsdCwgdmFsdWU7CgkgIHJlc3VsdCA9IGZvcm1hdC5zbGljZSgpOwoJICBhcmdzID0gYXJyYXlTbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgkgIGZvciAoaW5kZXggaW4gYXJncykgewoJICAgIGFyZyA9IGFyZ3NbaW5kZXhdOwoJICAgIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShhcmcpOwoJICAgIGlmIChfLmlzVW5kZWZpbmVkKHZhbHVlKSB8fCBfLmlzTnVsbCh2YWx1ZSkpIHsKCSAgICAgIHZhbHVlID0gJyc7CgkgICAgfQoJICAgIHBhcmFtZXRlcl9pbmRleCA9IGZvcm1hdC5pbmRleE9mKCJceyIgKyBpbmRleCArICJcfSIpOwoJICAgIHdoaWxlIChwYXJhbWV0ZXJfaW5kZXggPj0gMCkgewoJICAgICAgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoInsiICsgaW5kZXggKyAifSIsIHZhbHVlKTsKCSAgICAgIHBhcmFtZXRlcl9pbmRleCA9IGZvcm1hdC5pbmRleE9mKCJceyIgKyBpbmRleCArICJcfSIsIHBhcmFtZXRlcl9pbmRleCArIDEpOwoJICAgIH0KCSAgfQoJICByZXR1cm4gcmVzdWx0OwoJfTsKCglrYi5wYXJzZUZvcm1hdHRlZFN0cmluZyA9IGZ1bmN0aW9uKHN0cmluZywgZm9ybWF0KSB7CgkgIHZhciBjb3VudCwgZm9ybWF0X2luZGljZXNfdG9fbWF0Y2hlZF9pbmRpY2VzLCBpbmRleCwgbWF0Y2hfaW5kZXgsIG1hdGNoZXMsIHBhcmFtZXRlcl9jb3VudCwgcGFyYW1ldGVyX2luZGV4LCBwb3NpdGlvbnMsIHJlZ2V4LCByZWdleF9zdHJpbmcsIHJlc3VsdCwgcmVzdWx0cywgc29ydGVkX3Bvc2l0aW9uczsKCSAgcmVnZXhfc3RyaW5nID0gZm9ybWF0LnNsaWNlKCk7CgkgIGluZGV4ID0gMDsKCSAgcGFyYW1ldGVyX2NvdW50ID0gMDsKCSAgcG9zaXRpb25zID0ge307CgkgIHdoaWxlIChyZWdleF9zdHJpbmcuc2VhcmNoKCJcXHsiICsgaW5kZXggKyAiXFx9IikgPj0gMCkgewoJICAgIHBhcmFtZXRlcl9pbmRleCA9IGZvcm1hdC5pbmRleE9mKCJceyIgKyBpbmRleCArICJcfSIpOwoJICAgIHdoaWxlIChwYXJhbWV0ZXJfaW5kZXggPj0gMCkgewoJICAgICAgcmVnZXhfc3RyaW5nID0gcmVnZXhfc3RyaW5nLnJlcGxhY2UoIlx7IiArIGluZGV4ICsgIlx9IiwgJyguKiknKTsKCSAgICAgIHBvc2l0aW9uc1twYXJhbWV0ZXJfaW5kZXhdID0gaW5kZXg7CgkgICAgICBwYXJhbWV0ZXJfY291bnQrKzsKCSAgICAgIHBhcmFtZXRlcl9pbmRleCA9IGZvcm1hdC5pbmRleE9mKCJceyIgKyBpbmRleCArICJcfSIsIHBhcmFtZXRlcl9pbmRleCArIDEpOwoJICAgIH0KCSAgICBpbmRleCsrOwoJICB9CgkgIGNvdW50ID0gaW5kZXg7CgkgIHJlZ2V4ID0gbmV3IFJlZ0V4cChyZWdleF9zdHJpbmcpOwoJICBtYXRjaGVzID0gcmVnZXguZXhlYyhzdHJpbmcpOwoJICBpZiAobWF0Y2hlcykgewoJICAgIG1hdGNoZXMuc2hpZnQoKTsKCSAgfQoJICBpZiAoIW1hdGNoZXMgfHwgKG1hdGNoZXMubGVuZ3RoICE9PSBwYXJhbWV0ZXJfY291bnQpKSB7CgkgICAgcmVzdWx0ID0gW107CgkgICAgd2hpbGUgKGNvdW50LS0gPiAwKSB7CgkgICAgICByZXN1bHQucHVzaCgnJyk7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH0KCSAgc29ydGVkX3Bvc2l0aW9ucyA9IF8uc29ydEJ5KF8ua2V5cyhwb3NpdGlvbnMpLCBmdW5jdGlvbihwYXJhbWV0ZXJfaW5kZXgsIGZvcm1hdF9pbmRleCkgewoJICAgIHJldHVybiBwYXJzZUludChwYXJhbWV0ZXJfaW5kZXgsIDEwKTsKCSAgfSk7CgkgIGZvcm1hdF9pbmRpY2VzX3RvX21hdGNoZWRfaW5kaWNlcyA9IHt9OwoJICBmb3IgKG1hdGNoX2luZGV4IGluIHNvcnRlZF9wb3NpdGlvbnMpIHsKCSAgICBwYXJhbWV0ZXJfaW5kZXggPSBzb3J0ZWRfcG9zaXRpb25zW21hdGNoX2luZGV4XTsKCSAgICBpbmRleCA9IHBvc2l0aW9uc1twYXJhbWV0ZXJfaW5kZXhdOwoJICAgIGlmIChmb3JtYXRfaW5kaWNlc190b19tYXRjaGVkX2luZGljZXMuaGFzT3duUHJvcGVydHkoaW5kZXgpKSB7CgkgICAgICBjb250aW51ZTsKCSAgICB9CgkgICAgZm9ybWF0X2luZGljZXNfdG9fbWF0Y2hlZF9pbmRpY2VzW2luZGV4XSA9IG1hdGNoX2luZGV4OwoJICB9CgkgIHJlc3VsdHMgPSBbXTsKCSAgaW5kZXggPSAwOwoJICB3aGlsZSAoaW5kZXggPCBjb3VudCkgewoJICAgIHJlc3VsdHMucHVzaChtYXRjaGVzW2Zvcm1hdF9pbmRpY2VzX3RvX21hdGNoZWRfaW5kaWNlc1tpbmRleF1dKTsKCSAgICBpbmRleCsrOwoJICB9CgkgIHJldHVybiByZXN1bHRzOwoJfTsKCgltb2R1bGUuZXhwb3J0cyA9IGtiLkZvcm1hdHRlZE9ic2VydmFibGUgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIEZvcm1hdHRlZE9ic2VydmFibGUoZm9ybWF0LCBhcmdzKSB7CgkgICAgdmFyIG9ic2VydmFibGUsIG9ic2VydmFibGVfYXJnczsKCSAgICBpZiAoXy5pc0FycmF5KGFyZ3MpKSB7CgkgICAgICBmb3JtYXQgPSBmb3JtYXQ7CgkgICAgICBvYnNlcnZhYmxlX2FyZ3MgPSBhcmdzOwoJICAgIH0gZWxzZSB7CgkgICAgICBvYnNlcnZhYmxlX2FyZ3MgPSBhcnJheVNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCSAgICB9CgkgICAgb2JzZXJ2YWJsZSA9IGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKHRoaXMsIGtvLmNvbXB1dGVkKHsKCSAgICAgIHJlYWQ6IGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgYXJnLCBfaSwgX2xlbjsKCSAgICAgICAgYXJncyA9IFtrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGZvcm1hdCldOwoJICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IG9ic2VydmFibGVfYXJncy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgICAgIGFyZyA9IG9ic2VydmFibGVfYXJnc1tfaV07CgkgICAgICAgICAgYXJncy5wdXNoKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYXJnKSk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIGtiLnRvRm9ybWF0dGVkU3RyaW5nLmFwcGx5KG51bGwsIGFyZ3MpOwoJICAgICAgfSwKCSAgICAgIHdyaXRlOiBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgICB2YXIgaW5kZXgsIG1hdGNoZXMsIG1heF9jb3VudDsKCSAgICAgICAgbWF0Y2hlcyA9IGtiLnBhcnNlRm9ybWF0dGVkU3RyaW5nKHZhbHVlLCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGZvcm1hdCkpOwoJICAgICAgICBtYXhfY291bnQgPSBNYXRoLm1pbihvYnNlcnZhYmxlX2FyZ3MubGVuZ3RoLCBtYXRjaGVzLmxlbmd0aCk7CgkgICAgICAgIGluZGV4ID0gMDsKCSAgICAgICAgd2hpbGUgKGluZGV4IDwgbWF4X2NvdW50KSB7CgkgICAgICAgICAgb2JzZXJ2YWJsZV9hcmdzW2luZGV4XShtYXRjaGVzW2luZGV4XSk7CgkgICAgICAgICAgaW5kZXgrKzsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH0pKTsKCSAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgfQoKCSAgRm9ybWF0dGVkT2JzZXJ2YWJsZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkRGVzdHJveSh0aGlzKTsKCSAgfTsKCgkgIHJldHVybiBGb3JtYXR0ZWRPYnNlcnZhYmxlOwoKCX0pKCk7CgoJa2IuZm9ybWF0dGVkT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uKGZvcm1hdCwgYXJncykgewoJICByZXR1cm4gbmV3IGtiLkZvcm1hdHRlZE9ic2VydmFibGUoZm9ybWF0LCBhcnJheVNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7Cgl9OwoKCi8qKiovIH0sCi8qIDE3ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIEtFWVNfUFVCTElTSCwga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglLRVlTX1BVQkxJU0ggPSBbJ2Rlc3Ryb3knLCAnb2JzZXJ2ZWRWYWx1ZScsICdyZXNldFRvQ3VycmVudCddOwoKCWtiLmxvY2FsZV9tYW5hZ2VyIHx8IChrYi5sb2NhbGVfbWFuYWdlciA9IHZvaWQgMCk7CgoJbW9kdWxlLmV4cG9ydHMgPSBrYi5Mb2NhbGl6ZWRPYnNlcnZhYmxlID0gKGZ1bmN0aW9uKCkgewoJICBMb2NhbGl6ZWRPYnNlcnZhYmxlLmV4dGVuZCA9IGtiLmV4dGVuZDsKCgkgIGZ1bmN0aW9uIExvY2FsaXplZE9ic2VydmFibGUodmFsdWUsIG9wdGlvbnMsIHZtKSB7CgkgICAgdmFyIG9ic2VydmFibGU7CgkgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwoJICAgIHRoaXMudm0gPSB2bTsKCSAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgIHRoaXMudm0gfHwgKHRoaXMudm0gPSB7fSk7CgkgICAgdGhpcy5yZWFkIHx8IGtiLl90aHJvd01pc3NpbmcodGhpcywgJ3JlYWQnKTsKCSAgICBrYi5sb2NhbGVfbWFuYWdlciB8fCBrYi5fdGhyb3dNaXNzaW5nKHRoaXMsICdrYi5sb2NhbGVfbWFuYWdlcicpOwoJICAgIHRoaXMuX19rYiB8fCAodGhpcy5fX2tiID0ge30pOwoJICAgIHRoaXMuX19rYi5fb25Mb2NhbGVDaGFuZ2UgPSBfLmJpbmQodGhpcy5fb25Mb2NhbGVDaGFuZ2UsIHRoaXMpOwoJICAgIHRoaXMuX19rYi5fb25DaGFuZ2UgPSBvcHRpb25zLm9uQ2hhbmdlOwoJICAgIGlmICh0aGlzLnZhbHVlKSB7CgkgICAgICB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodGhpcy52YWx1ZSk7CgkgICAgfQoJICAgIHRoaXMudm8gPSBrby5vYnNlcnZhYmxlKCF2YWx1ZSA/IG51bGwgOiB0aGlzLnJlYWQodmFsdWUsIG51bGwpKTsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcywga28uY29tcHV0ZWQoewoJICAgICAgcmVhZDogKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgICBpZiAoX3RoaXMudmFsdWUpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoX3RoaXMudmFsdWUpOwoJICAgICAgICAgIH0KCSAgICAgICAgICBfdGhpcy52bygpOwoJICAgICAgICAgIHJldHVybiBfdGhpcy5yZWFkKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoX3RoaXMudmFsdWUpKTsKCSAgICAgICAgfTsKCSAgICAgIH0pKHRoaXMpLAoJICAgICAgd3JpdGU6IChmdW5jdGlvbihfdGhpcykgewoJICAgICAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKCSAgICAgICAgICBfdGhpcy53cml0ZSB8fCBrYi5fdGhyb3dVbmV4cGVjdGVkKF90aGlzLCAnd3JpdGluZyB0byByZWFkLW9ubHknKTsKCSAgICAgICAgICBfdGhpcy53cml0ZSh2YWx1ZSwga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShfdGhpcy52YWx1ZSkpOwoJICAgICAgICAgIF90aGlzLnZvKHZhbHVlKTsKCSAgICAgICAgICBpZiAoX3RoaXMuX19rYi5fb25DaGFuZ2UpIHsKCSAgICAgICAgICAgIHJldHVybiBfdGhpcy5fX2tiLl9vbkNoYW5nZSh2YWx1ZSk7CgkgICAgICAgICAgfQoJICAgICAgICB9OwoJICAgICAgfSkodGhpcyksCgkgICAgICBvd25lcjogdGhpcy52bQoJICAgIH0pKTsKCSAgICBrYi5wdWJsaXNoTWV0aG9kcyhvYnNlcnZhYmxlLCB0aGlzLCBLRVlTX1BVQkxJU0gpOwoJICAgIGtiLmxvY2FsZV9tYW5hZ2VyLmJpbmQoJ2NoYW5nZScsIHRoaXMuX19rYi5fb25Mb2NhbGVDaGFuZ2UpOwoJICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCdkZWZhdWx0JykpIHsKCSAgICAgIG9ic2VydmFibGUgPSBrYi5EZWZhdWx0T2JzZXJ2YWJsZSAmJiBrby5kZWZhdWx0T2JzZXJ2YWJsZShvYnNlcnZhYmxlLCBvcHRpb25zWyJkZWZhdWx0Il0pOwoJICAgIH0KCSAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgfQoKCSAgTG9jYWxpemVkT2JzZXJ2YWJsZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIGtiLmxvY2FsZV9tYW5hZ2VyLnVuYmluZCgnY2hhbmdlJywgdGhpcy5fX2tiLl9vbkxvY2FsZUNoYW5nZSk7CgkgICAgdGhpcy52bSA9IG51bGw7CgkgICAgcmV0dXJuIGtiLnV0aWxzLndyYXBwZWREZXN0cm95KHRoaXMpOwoJICB9OwoKCSAgTG9jYWxpemVkT2JzZXJ2YWJsZS5wcm90b3R5cGUucmVzZXRUb0N1cnJlbnQgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgY3VycmVudF92YWx1ZSwgb2JzZXJ2YWJsZTsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcyk7CgkgICAgY3VycmVudF92YWx1ZSA9IHRoaXMudmFsdWUgPyB0aGlzLnJlYWQoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh0aGlzLnZhbHVlKSkgOiBudWxsOwoJICAgIGlmIChvYnNlcnZhYmxlKCkgPT09IGN1cnJlbnRfdmFsdWUpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgcmV0dXJuIG9ic2VydmFibGUoY3VycmVudF92YWx1ZSk7CgkgIH07CgoJICBMb2NhbGl6ZWRPYnNlcnZhYmxlLnByb3RvdHlwZS5vYnNlcnZlZFZhbHVlID0gZnVuY3Rpb24odmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewoJICAgICAgcmV0dXJuIHRoaXMudmFsdWU7CgkgICAgfQoJICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKCSAgICB0aGlzLl9vbkxvY2FsZUNoYW5nZSgpOwoJICB9OwoKCSAgTG9jYWxpemVkT2JzZXJ2YWJsZS5wcm90b3R5cGUuX29uTG9jYWxlQ2hhbmdlID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIHZhbHVlOwoJICAgIHZhbHVlID0gdGhpcy5yZWFkKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodGhpcy52YWx1ZSkpOwoJICAgIHRoaXMudm8odmFsdWUpOwoJICAgIGlmICh0aGlzLl9fa2IuX29uQ2hhbmdlKSB7CgkgICAgICByZXR1cm4gdGhpcy5fX2tiLl9vbkNoYW5nZSh2YWx1ZSk7CgkgICAgfQoJICB9OwoKCSAgcmV0dXJuIExvY2FsaXplZE9ic2VydmFibGU7CgoJfSkoKTsKCglrYi5sb2NhbGl6ZWRPYnNlcnZhYmxlID0gZnVuY3Rpb24odmFsdWUsIG9wdGlvbnMsIHZpZXdfbW9kZWwpIHsKCSAgcmV0dXJuIG5ldyBrYi5Mb2NhbGl6ZWRPYnNlcnZhYmxlKHZhbHVlLCBvcHRpb25zLCB2aWV3X21vZGVsKTsKCX07CgoKLyoqKi8gfSwKLyogMTggKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgS0VZU19QVUJMSVNILCBrYiwga28sIF8sIF9yZWY7CgoJX3JlZiA9IGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSwgXyA9IF9yZWYuXywga28gPSBfcmVmLmtvOwoKCUtFWVNfUFVCTElTSCA9IFsnZGVzdHJveSddOwoKCW1vZHVsZS5leHBvcnRzID0ga2IuVHJpZ2dlcmVkT2JzZXJ2YWJsZSA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gVHJpZ2dlcmVkT2JzZXJ2YWJsZShlbWl0dGVyLCBldmVudF9zZWxlY3RvcikgewoJICAgIHZhciBvYnNlcnZhYmxlOwoJICAgIHRoaXMuZXZlbnRfc2VsZWN0b3IgPSBldmVudF9zZWxlY3RvcjsKCSAgICBlbWl0dGVyIHx8IGtiLl90aHJvd01pc3NpbmcodGhpcywgJ2VtaXR0ZXInKTsKCSAgICB0aGlzLmV2ZW50X3NlbGVjdG9yIHx8IGtiLl90aHJvd01pc3NpbmcodGhpcywgJ2V2ZW50X3NlbGVjdG9yJyk7CgkgICAgdGhpcy52byA9IGtvLm9ic2VydmFibGUoKTsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcywga28uY29tcHV0ZWQoKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgIHJldHVybiBfdGhpcy52bygpOwoJICAgICAgfTsKCSAgICB9KSh0aGlzKSkpOwoJICAgIGtiLnB1Ymxpc2hNZXRob2RzKG9ic2VydmFibGUsIHRoaXMsIEtFWVNfUFVCTElTSCk7CgkgICAga2IudXRpbHMud3JhcHBlZEV2ZW50V2F0Y2hlcih0aGlzLCBuZXcga2IuRXZlbnRXYXRjaGVyKGVtaXR0ZXIsIHRoaXMsIHsKCSAgICAgIGVtaXR0ZXI6IF8uYmluZCh0aGlzLmVtaXR0ZXIsIHRoaXMpLAoJICAgICAgdXBkYXRlOiBfLmJpbmQodGhpcy51cGRhdGUsIHRoaXMpLAoJICAgICAgZXZlbnRfc2VsZWN0b3I6IHRoaXMuZXZlbnRfc2VsZWN0b3IKCSAgICB9KSk7CgkgICAgcmV0dXJuIG9ic2VydmFibGU7CgkgIH0KCgkgIFRyaWdnZXJlZE9ic2VydmFibGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4ga2IudXRpbHMud3JhcHBlZERlc3Ryb3kodGhpcyk7CgkgIH07CgoJICBUcmlnZ2VyZWRPYnNlcnZhYmxlLnByb3RvdHlwZS5lbWl0dGVyID0gZnVuY3Rpb24obmV3X2VtaXR0ZXIpIHsKCSAgICBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHx8ICh0aGlzLmVlID09PSBuZXdfZW1pdHRlcikpIHsKCSAgICAgIHJldHVybiB0aGlzLmVlOwoJICAgIH0KCSAgICBpZiAoKHRoaXMuZWUgPSBuZXdfZW1pdHRlcikpIHsKCSAgICAgIHJldHVybiB0aGlzLnVwZGF0ZSgpOwoJICAgIH0KCSAgfTsKCgkgIFRyaWdnZXJlZE9ic2VydmFibGUucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKCkgewoJICAgIGlmICghdGhpcy5lZSkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBpZiAodGhpcy52bygpICE9PSB0aGlzLmVlKSB7CgkgICAgICByZXR1cm4gdGhpcy52byh0aGlzLmVlKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIHRoaXMudm8udmFsdWVIYXNNdXRhdGVkKCk7CgkgICAgfQoJICB9OwoKCSAgcmV0dXJuIFRyaWdnZXJlZE9ic2VydmFibGU7CgoJfSkoKTsKCglrYi50cmlnZ2VyZWRPYnNlcnZhYmxlID0gZnVuY3Rpb24oZW1pdHRlciwgZXZlbnRfc2VsZWN0b3IpIHsKCSAgcmV0dXJuIG5ldyBrYi5UcmlnZ2VyZWRPYnNlcnZhYmxlKGVtaXR0ZXIsIGV2ZW50X3NlbGVjdG9yKTsKCX07CgoKLyoqKi8gfSwKLyogMTkgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgJCwgY2FsbE9yR2V0LCBrYiwga28sIF8sIF9yZWY7CgoJX3JlZiA9IGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSwgXyA9IF9yZWYuXywga28gPSBfcmVmLmtvLCAkID0gX3JlZi4kOwoKCV9fd2VicGFja19yZXF1aXJlX18oMjIpOwoKCWNhbGxPckdldCA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkgIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZSk7CgkgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpIHsKCSAgICByZXR1cm4gdmFsdWUuYXBwbHkobnVsbCwgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CgkgIH0gZWxzZSB7CgkgICAgcmV0dXJuIHZhbHVlOwoJICB9Cgl9OwoKCW1vZHVsZS5leHBvcnRzID0ga2IuVmFsaWRhdGlvbiA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gVmFsaWRhdGlvbigpIHt9CgoJICByZXR1cm4gVmFsaWRhdGlvbjsKCgl9KSgpOwoKCWtiLnZhbHVlVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUsIGJpbmRpbmdzLCB2YWxpZGF0aW9uX29wdGlvbnMpIHsKCSAgaWYgKHZhbGlkYXRpb25fb3B0aW9ucyA9PSBudWxsKSB7CgkgICAgdmFsaWRhdGlvbl9vcHRpb25zID0ge307CgkgIH0KCSAgKHZhbGlkYXRpb25fb3B0aW9ucyAmJiAhKHR5cGVvZiB2YWxpZGF0aW9uX29wdGlvbnMgPT09ICdmdW5jdGlvbicpKSB8fCAodmFsaWRhdGlvbl9vcHRpb25zID0ge30pOwoJICByZXR1cm4ga28uY29tcHV0ZWQoZnVuY3Rpb24oKSB7CgkgICAgdmFyIGFjdGl2ZV9pbmRleCwgY3VycmVudF92YWx1ZSwgZGlzYWJsZWQsIGlkZW50aWZpZXIsIGlkZW50aWZpZXJfaW5kZXgsIHByaW9yaXRpZXMsIHJlc3VsdHMsIHZhbGlkYXRvcjsKCSAgICByZXN1bHRzID0gewoJICAgICAgJGVycm9yX2NvdW50OiAwCgkgICAgfTsKCSAgICBjdXJyZW50X3ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZSk7CgkgICAgISgnZGlzYWJsZScgaW4gdmFsaWRhdGlvbl9vcHRpb25zKSB8fCAoZGlzYWJsZWQgPSBjYWxsT3JHZXQodmFsaWRhdGlvbl9vcHRpb25zLmRpc2FibGUpKTsKCSAgICAhKCdlbmFibGUnIGluIHZhbGlkYXRpb25fb3B0aW9ucykgfHwgKGRpc2FibGVkID0gIWNhbGxPckdldCh2YWxpZGF0aW9uX29wdGlvbnMuZW5hYmxlKSk7CgkgICAgcHJpb3JpdGllcyA9IHZhbGlkYXRpb25fb3B0aW9ucy5wcmlvcml0aWVzIHx8IFtdOwoJICAgIF8uaXNBcnJheShwcmlvcml0aWVzKSB8fCAocHJpb3JpdGllcyA9IFtwcmlvcml0aWVzXSk7CgkgICAgYWN0aXZlX2luZGV4ID0gcHJpb3JpdGllcy5sZW5ndGggKyAxOwoJICAgIGZvciAoaWRlbnRpZmllciBpbiBiaW5kaW5ncykgewoJICAgICAgdmFsaWRhdG9yID0gYmluZGluZ3NbaWRlbnRpZmllcl07CgkgICAgICByZXN1bHRzW2lkZW50aWZpZXJdID0gIWRpc2FibGVkICYmIGNhbGxPckdldCh2YWxpZGF0b3IsIGN1cnJlbnRfdmFsdWUpOwoJICAgICAgaWYgKHJlc3VsdHNbaWRlbnRpZmllcl0pIHsKCSAgICAgICAgcmVzdWx0cy4kZXJyb3JfY291bnQrKzsKCSAgICAgICAgKGlkZW50aWZpZXJfaW5kZXggPSBfLmluZGV4T2YocHJpb3JpdGllcywgaWRlbnRpZmllcikgPj0gMCkgfHwgKGlkZW50aWZpZXJfaW5kZXggPSBwcmlvcml0aWVzLmxlbmd0aCk7CgkgICAgICAgIGlmIChyZXN1bHRzLiRhY3RpdmVfZXJyb3IgJiYgaWRlbnRpZmllcl9pbmRleCA8IGFjdGl2ZV9pbmRleCkgewoJICAgICAgICAgIHJlc3VsdHMuJGFjdGl2ZV9lcnJvciA9IGlkZW50aWZpZXI7CgkgICAgICAgICAgYWN0aXZlX2luZGV4ID0gaWRlbnRpZmllcl9pbmRleDsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICByZXN1bHRzLiRhY3RpdmVfZXJyb3IgfHwgKHJlc3VsdHMuJGFjdGl2ZV9lcnJvciA9IGlkZW50aWZpZXIsIGFjdGl2ZV9pbmRleCA9IGlkZW50aWZpZXJfaW5kZXgpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICAgIHJlc3VsdHMuJGVuYWJsZWQgPSAhZGlzYWJsZWQ7CgkgICAgcmVzdWx0cy4kZGlzYWJsZSA9ICEhZGlzYWJsZWQ7CgkgICAgcmVzdWx0cy4kdmFsaWQgPSByZXN1bHRzLiRlcnJvcl9jb3VudCA9PT0gMDsKCSAgICByZXR1cm4gcmVzdWx0czsKCSAgfSk7Cgl9OwoKCWtiLmlucHV0VmFsaWRhdG9yID0gZnVuY3Rpb24odmlld19tb2RlbCwgZWwsIHZhbGlkYXRpb25fb3B0aW9ucykgewoJICB2YXIgJGlucHV0X2VsLCBiaW5kaW5ncywgaWRlbnRpZmllciwgaW5wdXRfbmFtZSwgb3B0aW9ucywgcmVzdWx0LCB0eXBlLCB2YWxpZGF0b3IsIHZhbGlkYXRvcnMsIF9yZWYxOwoJICBpZiAodmFsaWRhdGlvbl9vcHRpb25zID09IG51bGwpIHsKCSAgICB2YWxpZGF0aW9uX29wdGlvbnMgPSB7fTsKCSAgfQoJICAodmFsaWRhdGlvbl9vcHRpb25zICYmICEodHlwZW9mIHZhbGlkYXRpb25fb3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykpIHx8ICh2YWxpZGF0aW9uX29wdGlvbnMgPSB7fSk7CgkgIHZhbGlkYXRvcnMgPSBrYi52YWxpZDsKCSAgJGlucHV0X2VsID0gJChlbCk7CgkgIGlmICgoaW5wdXRfbmFtZSA9ICRpbnB1dF9lbC5hdHRyKCduYW1lJykpICYmICFfLmlzU3RyaW5nKGlucHV0X25hbWUpKSB7CgkgICAgaW5wdXRfbmFtZSA9IG51bGw7CgkgIH0KCSAgaWYgKCEoYmluZGluZ3MgPSAkaW5wdXRfZWwuYXR0cignZGF0YS1iaW5kJykpKSB7CgkgICAgcmV0dXJuIG51bGw7CgkgIH0KCSAgb3B0aW9ucyA9IChuZXcgRnVuY3Rpb24oInNjIiwgIndpdGgoc2NbMF0pIHsgcmV0dXJuIHsgIiArIGJpbmRpbmdzICsgIiB9IH0iKSkoW3ZpZXdfbW9kZWxdKTsKCSAgaWYgKCEob3B0aW9ucyAmJiBvcHRpb25zLnZhbHVlKSkgewoJICAgIHJldHVybiBudWxsOwoJICB9CgkgICghb3B0aW9ucy52YWxpZGF0aW9uX29wdGlvbnMpIHx8IChfLmRlZmF1bHRzKG9wdGlvbnMudmFsaWRhdGlvbl9vcHRpb25zLCB2YWxpZGF0aW9uX29wdGlvbnMpLCB2YWxpZGF0aW9uX29wdGlvbnMgPSBvcHRpb25zLnZhbGlkYXRpb25fb3B0aW9ucyk7CgkgIGJpbmRpbmdzID0ge307CgkgICghdmFsaWRhdG9yc1t0eXBlID0gJGlucHV0X2VsLmF0dHIoJ3R5cGUnKV0pIHx8IChiaW5kaW5nc1t0eXBlXSA9IHZhbGlkYXRvcnNbdHlwZV0pOwoJICAoISRpbnB1dF9lbC5hdHRyKCdyZXF1aXJlZCcpKSB8fCAoYmluZGluZ3MucmVxdWlyZWQgPSB2YWxpZGF0b3JzLnJlcXVpcmVkKTsKCSAgaWYgKG9wdGlvbnMudmFsaWRhdGlvbnMpIHsKCSAgICBfcmVmMSA9IG9wdGlvbnMudmFsaWRhdGlvbnM7CgkgICAgZm9yIChpZGVudGlmaWVyIGluIF9yZWYxKSB7CgkgICAgICB2YWxpZGF0b3IgPSBfcmVmMVtpZGVudGlmaWVyXTsKCSAgICAgIGJpbmRpbmdzW2lkZW50aWZpZXJdID0gdmFsaWRhdG9yOwoJICAgIH0KCSAgfQoJICByZXN1bHQgPSBrYi52YWx1ZVZhbGlkYXRvcihvcHRpb25zLnZhbHVlLCBiaW5kaW5ncywgdmFsaWRhdGlvbl9vcHRpb25zKTsKCSAgKCFpbnB1dF9uYW1lICYmICF2YWxpZGF0aW9uX29wdGlvbnMubm9fYXR0YWNoKSB8fCAodmlld19tb2RlbFsiJCIgKyBpbnB1dF9uYW1lXSA9IHJlc3VsdCk7CgkgIHJldHVybiByZXN1bHQ7Cgl9OwoKCWtiLmZvcm1WYWxpZGF0b3IgPSBmdW5jdGlvbih2aWV3X21vZGVsLCBlbCkgewoJICB2YXIgJHJvb3RfZWwsIGJpbmRpbmdzLCBmb3JtX25hbWUsIGlucHV0X2VsLCBuYW1lLCBvcHRpb25zLCByZXN1bHRzLCB2YWxpZGF0aW9uX29wdGlvbnMsIHZhbGlkYXRvciwgdmFsaWRhdG9ycywgX2ksIF9sZW4sIF9yZWYxOwoJICByZXN1bHRzID0ge307CgkgIHZhbGlkYXRvcnMgPSBbXTsKCSAgJHJvb3RfZWwgPSAkKGVsKTsKCSAgaWYgKChmb3JtX25hbWUgPSAkcm9vdF9lbC5hdHRyKCduYW1lJykpICYmICFfLmlzU3RyaW5nKGZvcm1fbmFtZSkpIHsKCSAgICBmb3JtX25hbWUgPSBudWxsOwoJICB9CgkgIGlmICgoYmluZGluZ3MgPSAkcm9vdF9lbC5hdHRyKCdkYXRhLWJpbmQnKSkpIHsKCSAgICBvcHRpb25zID0gKG5ldyBGdW5jdGlvbigic2MiLCAid2l0aChzY1swXSkgeyByZXR1cm4geyAiICsgYmluZGluZ3MgKyAiIH0gfSIpKShbdmlld19tb2RlbF0pOwoJICAgIHZhbGlkYXRpb25fb3B0aW9ucyA9IG9wdGlvbnMudmFsaWRhdGlvbl9vcHRpb25zOwoJICB9CgkgIHZhbGlkYXRpb25fb3B0aW9ucyB8fCAodmFsaWRhdGlvbl9vcHRpb25zID0ge30pOwoJICB2YWxpZGF0aW9uX29wdGlvbnMubm9fYXR0YWNoID0gISFmb3JtX25hbWU7CgkgIF9yZWYxID0gJHJvb3RfZWwuZmluZCgnaW5wdXQnKTsKCSAgZm9yIChfaSA9IDAsIF9sZW4gPSBfcmVmMS5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgIGlucHV0X2VsID0gX3JlZjFbX2ldOwoJICAgIGlmICghKG5hbWUgPSAkKGlucHV0X2VsKS5hdHRyKCduYW1lJykpKSB7CgkgICAgICBjb250aW51ZTsKCSAgICB9CgkgICAgdmFsaWRhdG9yID0ga2IuaW5wdXRWYWxpZGF0b3Iodmlld19tb2RlbCwgaW5wdXRfZWwsIHZhbGlkYXRpb25fb3B0aW9ucyk7CgkgICAgIXZhbGlkYXRvciB8fCB2YWxpZGF0b3JzLnB1c2gocmVzdWx0c1tuYW1lXSA9IHZhbGlkYXRvcik7CgkgIH0KCSAgcmVzdWx0cy4kZXJyb3JfY291bnQgPSBrby5jb21wdXRlZChmdW5jdGlvbigpIHsKCSAgICB2YXIgZXJyb3JfY291bnQsIF9qLCBfbGVuMTsKCSAgICBlcnJvcl9jb3VudCA9IDA7CgkgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gdmFsaWRhdG9ycy5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKCSAgICAgIHZhbGlkYXRvciA9IHZhbGlkYXRvcnNbX2pdOwoJICAgICAgZXJyb3JfY291bnQgKz0gdmFsaWRhdG9yKCkuJGVycm9yX2NvdW50OwoJICAgIH0KCSAgICByZXR1cm4gZXJyb3JfY291bnQ7CgkgIH0pOwoJICByZXN1bHRzLiR2YWxpZCA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiByZXN1bHRzLiRlcnJvcl9jb3VudCgpID09PSAwOwoJICB9KTsKCSAgcmVzdWx0cy4kZW5hYmxlZCA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgIHZhciBlbmFibGVkLCBfaiwgX2xlbjE7CgkgICAgZW5hYmxlZCA9IHRydWU7CgkgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gdmFsaWRhdG9ycy5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKCSAgICAgIHZhbGlkYXRvciA9IHZhbGlkYXRvcnNbX2pdOwoJICAgICAgZW5hYmxlZCAmPSB2YWxpZGF0b3IoKS4kZW5hYmxlZDsKCSAgICB9CgkgICAgcmV0dXJuIGVuYWJsZWQ7CgkgIH0pOwoJICByZXN1bHRzLiRkaXNhYmxlZCA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiAhcmVzdWx0cy4kZW5hYmxlZCgpOwoJICB9KTsKCSAgaWYgKGZvcm1fbmFtZSkgewoJICAgIHZpZXdfbW9kZWxbIiQiICsgZm9ybV9uYW1lXSA9IHJlc3VsdHM7CgkgIH0KCSAgcmV0dXJuIHJlc3VsdHM7Cgl9OwoKCi8qKiovIH0sCi8qIDIwICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCW1vZHVsZS5leHBvcnRzID0gX19XRUJQQUNLX0VYVEVSTkFMX01PRFVMRV8yMF9fOwoKLyoqKi8gfSwKLyogMjEgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglrYi5PYnNlcnZhYmxlLnByb3RvdHlwZS5zZXRUb0RlZmF1bHQgPSBmdW5jdGlvbigpIHsKCSAgdmFyIF9yZWYxOwoJICBpZiAoKF9yZWYxID0gdGhpcy5fX2tiX3ZhbHVlKSAhPSBudWxsKSB7CgkgICAgaWYgKHR5cGVvZiBfcmVmMS5zZXRUb0RlZmF1bHQgPT09ICJmdW5jdGlvbiIpIHsKCSAgICAgIF9yZWYxLnNldFRvRGVmYXVsdCgpOwoJICAgIH0KCSAgfQoJfTsKCglrYi5WaWV3TW9kZWwucHJvdG90eXBlLnNldFRvRGVmYXVsdCA9IGZ1bmN0aW9uKCkgewoJICB2YXIgdm1fa2V5LCBfcmVmMTsKCSAgZm9yICh2bV9rZXkgaW4gdGhpcy5fX2tiLnZtX2tleXMpIHsKCSAgICBpZiAoKF9yZWYxID0gdGhpc1t2bV9rZXldKSAhPSBudWxsKSB7CgkgICAgICBpZiAodHlwZW9mIF9yZWYxLnNldFRvRGVmYXVsdCA9PT0gImZ1bmN0aW9uIikgewoJICAgICAgICBfcmVmMS5zZXRUb0RlZmF1bHQoKTsKCSAgICAgIH0KCSAgICB9CgkgIH0KCX07CgoJa2IudXRpbHMuc2V0VG9EZWZhdWx0ID0gZnVuY3Rpb24ob2JqKSB7CgkgIHZhciBrZXksIHZhbHVlOwoJICBpZiAoIW9iaikgewoJICAgIHJldHVybjsKCSAgfQoJICBpZiAoa28uaXNPYnNlcnZhYmxlKG9iaikpIHsKCSAgICBpZiAodHlwZW9mIG9iai5zZXRUb0RlZmF1bHQgPT09ICJmdW5jdGlvbiIpIHsKCSAgICAgIG9iai5zZXRUb0RlZmF1bHQoKTsKCSAgICB9CgkgIH0gZWxzZSBpZiAoXy5pc09iamVjdChvYmopKSB7CgkgICAgZm9yIChrZXkgaW4gb2JqKSB7CgkgICAgICB2YWx1ZSA9IG9ialtrZXldOwoJICAgICAgaWYgKHZhbHVlICYmIChrby5pc09ic2VydmFibGUodmFsdWUpIHx8ICh0eXBlb2YgdmFsdWUgIT09ICdmdW5jdGlvbicpKSAmJiAoKGtleVswXSAhPT0gJ18nKSB8fCBrZXkuc2VhcmNoKCdfX2tiJykpKSB7CgkgICAgICAgIHRoaXMuc2V0VG9EZWZhdWx0KHZhbHVlKTsKCSAgICAgIH0KCSAgICB9CgkgIH0KCSAgcmV0dXJuIG9iajsKCX07CgoKLyoqKi8gfSwKLyogMjIgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgJCwgRU1BSUxfUkVHRVhQLCBOVU1CRVJfUkVHRVhQLCBVUkxfUkVHRVhQLCBrYiwga28sIF8sIF9yZWY7CgoJX3JlZiA9IGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSwgXyA9IF9yZWYuXywga28gPSBfcmVmLmtvLCAkID0gX3JlZi4kOwoKCVVSTF9SRUdFWFAgPSAvXihmdHB8aHR0cHxodHRwcyk6XC9cLyhcdys6ezAsMX1cdypAKT8oXFMrKSg6WzAtOV0rKT8oXC98XC8oW1x3IyE6Lj8rPSYlQCFcLVwvXSkpPyQvOwoKCUVNQUlMX1JFR0VYUCA9IC9eW0EtWmEtejAtOS5fJSstXStAW0EtWmEtejAtOS4tXStcLltBLVphLXpdezIsNH0kLzsKCglOVU1CRVJfUkVHRVhQID0gL15ccyooXC18XCspPyhcZCt8KFxkKihcLlxkKikpKVxzKiQvOwoKCWtiLnZhbGlkID0gewoJICByZXF1aXJlZDogZnVuY3Rpb24odmFsdWUpIHsKCSAgICByZXR1cm4gIXZhbHVlOwoJICB9LAoJICB1cmw6IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgcmV0dXJuICFVUkxfUkVHRVhQLnRlc3QodmFsdWUpOwoJICB9LAoJICBlbWFpbDogZnVuY3Rpb24odmFsdWUpIHsKCSAgICByZXR1cm4gIUVNQUlMX1JFR0VYUC50ZXN0KHZhbHVlKTsKCSAgfSwKCSAgbnVtYmVyOiBmdW5jdGlvbih2YWx1ZSkgewoJICAgIHJldHVybiAhTlVNQkVSX1JFR0VYUC50ZXN0KHZhbHVlKTsKCSAgfQoJfTsKCglrYi5oYXNDaGFuZ2VkRm4gPSBmdW5jdGlvbihtb2RlbCkgewoJICB2YXIgYXR0cmlidXRlcywgbTsKCSAgbSA9IG51bGw7CgkgIGF0dHJpYnV0ZXMgPSBudWxsOwoJICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgdmFyIGN1cnJlbnRfbW9kZWw7CgkgICAgaWYgKG0gIT09IChjdXJyZW50X21vZGVsID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtb2RlbCkpKSB7CgkgICAgICBtID0gY3VycmVudF9tb2RlbDsKCSAgICAgIGF0dHJpYnV0ZXMgPSAobSA/IG0udG9KU09OKCkgOiBudWxsKTsKCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9CgkgICAgaWYgKCEobSAmJiBhdHRyaWJ1dGVzKSkgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICByZXR1cm4gIV8uaXNFcXVhbChtLnRvSlNPTigpLCBhdHRyaWJ1dGVzKTsKCSAgfTsKCX07CgoJa2IubWluTGVuZ3RoRm4gPSBmdW5jdGlvbihsZW5ndGgpIHsKCSAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgcmV0dXJuICF2YWx1ZSB8fCB2YWx1ZS5sZW5ndGggPCBsZW5ndGg7CgkgIH07Cgl9OwoKCWtiLnVuaXF1ZVZhbHVlRm4gPSBmdW5jdGlvbihtb2RlbCwga2V5LCBjb2xsZWN0aW9uKSB7CgkgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewoJICAgIHZhciBjLCBrLCBtOwoJICAgIG0gPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG1vZGVsKTsKCSAgICBrID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShrZXkpOwoJICAgIGMgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGNvbGxlY3Rpb24pOwoJICAgIGlmICghKG0gJiYgayAmJiBjKSkgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICByZXR1cm4gISFfLmZpbmQoYy5tb2RlbHMsIChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKHRlc3QpIHsKCSAgICAgICAgcmV0dXJuICh0ZXN0ICE9PSBtKSAmJiB0ZXN0LmdldChrKSA9PT0gdmFsdWU7CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKTsKCSAgfTsKCX07CgoJa2IudW50aWxUcnVlRm4gPSBmdW5jdGlvbihzdGFuZF9pbiwgZm4sIG1vZGVsKSB7CgkgIHZhciB3YXNfdHJ1ZTsKCSAgd2FzX3RydWUgPSBmYWxzZTsKCSAgaWYgKG1vZGVsICYmIGtvLmlzT2JzZXJ2YWJsZShtb2RlbCkpIHsKCSAgICBtb2RlbC5zdWJzY3JpYmUoZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gd2FzX3RydWUgPSBmYWxzZTsKCSAgICB9KTsKCSAgfQoJICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKCSAgICB2YXIgZiwgcmVzdWx0OwoJICAgIGlmICghKGYgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGZuKSkpIHsKCSAgICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHN0YW5kX2luKTsKCSAgICB9CgkgICAgd2FzX3RydWUgfD0gISEocmVzdWx0ID0gZihrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlKSkpOwoJICAgIHJldHVybiAod2FzX3RydWUgPyByZXN1bHQgOiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHN0YW5kX2luKSk7CgkgIH07Cgl9OwoKCWtiLnVudGlsRmFsc2VGbiA9IGZ1bmN0aW9uKHN0YW5kX2luLCBmbiwgbW9kZWwpIHsKCSAgdmFyIHdhc19mYWxzZTsKCSAgd2FzX2ZhbHNlID0gZmFsc2U7CgkgIGlmIChtb2RlbCAmJiBrby5pc09ic2VydmFibGUobW9kZWwpKSB7CgkgICAgbW9kZWwuc3Vic2NyaWJlKGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHdhc19mYWxzZSA9IGZhbHNlOwoJICAgIH0pOwoJICB9CgkgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewoJICAgIHZhciBmLCByZXN1bHQ7CgkgICAgaWYgKCEoZiA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoZm4pKSkgewoJICAgICAgcmV0dXJuIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoc3RhbmRfaW4pOwoJICAgIH0KCSAgICB3YXNfZmFsc2UgfD0gIShyZXN1bHQgPSBmKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWUpKSk7CgkgICAgcmV0dXJuICh3YXNfZmFsc2UgPyByZXN1bHQgOiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHN0YW5kX2luKSk7CgkgIH07Cgl9OwoKCi8qKiovIH0sCi8qIDIzICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIEFzc29jaWF0ZWRNb2RlbCwgQmFja2JvbmUsIEJhY2tib25lQXNzb2NpYXRpb25zLCBrYiwgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBCYWNrYm9uZSA9IF9yZWYuQmFja2JvbmU7CgoJQXNzb2NpYXRlZE1vZGVsID0gbnVsbDsKCgltb2R1bGUuZXhwb3J0cyA9IEJhY2tib25lQXNzb2NpYXRpb25zID0gKGZ1bmN0aW9uKCkgewoJICBmdW5jdGlvbiBCYWNrYm9uZUFzc29jaWF0aW9ucygpIHt9CgoJICBCYWNrYm9uZUFzc29jaWF0aW9ucy5pc0F2YWlsYWJsZSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiAhIShBc3NvY2lhdGVkTW9kZWwgPSBCYWNrYm9uZSAhPSBudWxsID8gQmFja2JvbmUuQXNzb2NpYXRlZE1vZGVsIDogdm9pZCAwKTsKCSAgfTsKCgkgIEJhY2tib25lQXNzb2NpYXRpb25zLmtleXMgPSBmdW5jdGlvbihtb2RlbCkgewoJICAgIGlmICghKG1vZGVsIGluc3RhbmNlb2YgQXNzb2NpYXRlZE1vZGVsKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIHJldHVybiBfLm1hcChtb2RlbC5yZWxhdGlvbnMsIGZ1bmN0aW9uKHRlc3QpIHsKCSAgICAgIHJldHVybiB0ZXN0LmtleTsKCSAgICB9KTsKCSAgfTsKCgkgIEJhY2tib25lQXNzb2NpYXRpb25zLnJlbGF0aW9uVHlwZSA9IGZ1bmN0aW9uKG1vZGVsLCBrZXkpIHsKCSAgICB2YXIgcmVsYXRpb247CgkgICAgaWYgKCEobW9kZWwgaW5zdGFuY2VvZiBBc3NvY2lhdGVkTW9kZWwpKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgaWYgKCEocmVsYXRpb24gPSBfLmZpbmQobW9kZWwucmVsYXRpb25zLCBmdW5jdGlvbih0ZXN0KSB7CgkgICAgICByZXR1cm4gdGVzdC5rZXkgPT09IGtleTsKCSAgICB9KSkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAocmVsYXRpb24udHlwZSA9PT0gJ01hbnknKSB7CgkgICAgICByZXR1cm4ga2IuVFlQRV9DT0xMRUNUSU9OOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4ga2IuVFlQRV9NT0RFTDsKCSAgICB9CgkgIH07CgoJICBCYWNrYm9uZUFzc29jaWF0aW9ucy51c2VGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBmYWxzZTsKCSAgfTsKCgkgIHJldHVybiBCYWNrYm9uZUFzc29jaWF0aW9uczsKCgl9KSgpOwoKCi8qKiovIH0sCi8qIDI0ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIEJhY2tib25lLCBCYWNrYm9uZVJlbGF0aW9uYWwsIFJlbGF0aW9uYWxNb2RlbCwga2IsIF8sIF9yZWY7CgoJX3JlZiA9IGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSwgXyA9IF9yZWYuXywgQmFja2JvbmUgPSBfcmVmLkJhY2tib25lOwoKCVJlbGF0aW9uYWxNb2RlbCA9IG51bGw7CgoJbW9kdWxlLmV4cG9ydHMgPSBCYWNrYm9uZVJlbGF0aW9uYWwgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIEJhY2tib25lUmVsYXRpb25hbCgpIHt9CgoJICBCYWNrYm9uZVJlbGF0aW9uYWwuaXNBdmFpbGFibGUgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gISEoUmVsYXRpb25hbE1vZGVsID0gQmFja2JvbmUgIT0gbnVsbCA/IEJhY2tib25lLlJlbGF0aW9uYWxNb2RlbCA6IHZvaWQgMCk7CgkgIH07CgoJICBCYWNrYm9uZVJlbGF0aW9uYWwucmVsYXRpb25UeXBlID0gZnVuY3Rpb24obW9kZWwsIGtleSkgewoJICAgIHZhciByZWxhdGlvbjsKCSAgICBpZiAoIShtb2RlbCBpbnN0YW5jZW9mIFJlbGF0aW9uYWxNb2RlbCkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAoIShyZWxhdGlvbiA9IF8uZmluZChtb2RlbC5nZXRSZWxhdGlvbnMoKSwgZnVuY3Rpb24odGVzdCkgewoJICAgICAgcmV0dXJuIHRlc3Qua2V5ID09PSBrZXk7CgkgICAgfSkpKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgaWYgKHJlbGF0aW9uLmNvbGxlY3Rpb25UeXBlIHx8IF8uaXNBcnJheShyZWxhdGlvbi5rZXlDb250ZW50cykpIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX0NPTExFQ1RJT047CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX01PREVMOwoJICAgIH0KCSAgfTsKCgkgIEJhY2tib25lUmVsYXRpb25hbC5iaW5kID0gZnVuY3Rpb24obW9kZWwsIGtleSwgdXBkYXRlLCBwYXRoKSB7CgkgICAgdmFyIGV2ZW50LCBldmVudHMsIHJlbF9mbiwgdHlwZSwgX2ksIF9sZW47CgkgICAgaWYgKCEodHlwZSA9IHRoaXMucmVsYXRpb25UeXBlKG1vZGVsLCBrZXkpKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIHJlbF9mbiA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAha2Iuc3RhdGlzdGljcyB8fCBrYi5zdGF0aXN0aWNzLmFkZE1vZGVsRXZlbnQoewoJICAgICAgICBuYW1lOiAndXBkYXRlIChyZWxhdGlvbmFsKScsCgkgICAgICAgIG1vZGVsOiBtb2RlbCwKCSAgICAgICAga2V5OiBrZXksCgkgICAgICAgIHBhdGg6IHBhdGgKCSAgICAgIH0pOwoJICAgICAgcmV0dXJuIHVwZGF0ZSgpOwoJICAgIH07CgkgICAgZXZlbnRzID0ga2IuQmFja2JvbmUuUmVsYXRpb24ucHJvdG90eXBlLnNhbml0aXplT3B0aW9ucyA/IFsndXBkYXRlJywgJ2FkZCcsICdyZW1vdmUnXSA6IFsnY2hhbmdlJywgJ2FkZCcsICdyZW1vdmUnXTsKCSAgICBpZiAodHlwZSA9PT0ga2IuVFlQRV9DT0xMRUNUSU9OKSB7CgkgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGV2ZW50cy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgICBldmVudCA9IGV2ZW50c1tfaV07CgkgICAgICAgIG1vZGVsLmJpbmQoIiIgKyBldmVudCArICI6IiArIGtleSwgcmVsX2ZuKTsKCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgbW9kZWwuYmluZCgiIiArIGV2ZW50c1swXSArICI6IiArIGtleSwgcmVsX2ZuKTsKCSAgICB9CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIF9qLCBfbGVuMTsKCSAgICAgIGlmICh0eXBlID09PSBrYi5UWVBFX0NPTExFQ1RJT04pIHsKCSAgICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gZXZlbnRzLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewoJICAgICAgICAgIGV2ZW50ID0gZXZlbnRzW19qXTsKCSAgICAgICAgICBtb2RlbC51bmJpbmQoIiIgKyBldmVudCArICI6IiArIGtleSwgcmVsX2ZuKTsKCSAgICAgICAgfQoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgbW9kZWwudW5iaW5kKCIiICsgZXZlbnRzWzBdICsgIjoiICsga2V5LCByZWxfZm4pOwoJICAgICAgfQoJICAgIH07CgkgIH07CgoJICBCYWNrYm9uZVJlbGF0aW9uYWwudXNlRnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gZmFsc2U7CgkgIH07CgoJICByZXR1cm4gQmFja2JvbmVSZWxhdGlvbmFsOwoKCX0pKCk7CgoKLyoqKi8gfSwKLyogMjUgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJLyogV0VCUEFDSyBWQVIgSU5KRUNUSU9OICovKGZ1bmN0aW9uKGdsb2JhbCkgewoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIFN1cGVybW9kZWwsIGtiLCByb290LCBfOwoKCXJvb3QgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cgIT09IG51bGwgPyB3aW5kb3cgOiBnbG9iYWw7CgoJXyA9IChrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNikpLl87CgoJU3VwZXJtb2RlbCA9IG51bGw7CgoJbW9kdWxlLmV4cG9ydHMgPSBTdXBlcm1vZGVsID0gKGZ1bmN0aW9uKCkgewoJICBmdW5jdGlvbiBTdXBlcm1vZGVsKCkge30KCgkgIFN1cGVybW9kZWwuaXNBdmFpbGFibGUgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gISEoU3VwZXJtb2RlbCA9IHJvb3QuU3VwZXJtb2RlbCk7CgkgIH07CgoJICBTdXBlcm1vZGVsLmtleXMgPSBmdW5jdGlvbihtb2RlbCkgewoJICAgIGlmICghKG1vZGVsIGluc3RhbmNlb2YgU3VwZXJtb2RlbC5Nb2RlbCkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICByZXR1cm4gXy5rZXlzKG1vZGVsLmNvbnN0cnVjdG9yLmFzc29jaWF0aW9ucygpKTsKCSAgfTsKCgkgIFN1cGVybW9kZWwucmVsYXRpb25UeXBlID0gZnVuY3Rpb24obW9kZWwsIGtleSkgewoJICAgIHZhciByZWxhdGlvbjsKCSAgICBpZiAoIShtb2RlbCBpbnN0YW5jZW9mIFN1cGVybW9kZWwuTW9kZWwpKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgaWYgKCEocmVsYXRpb24gPSBtb2RlbC5jb25zdHJ1Y3Rvci5hc3NvY2lhdGlvbnMoKVtrZXldKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIGlmIChyZWxhdGlvbi5hZGQpIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX0NPTExFQ1RJT047CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX01PREVMOwoJICAgIH0KCSAgfTsKCgkgIFN1cGVybW9kZWwuYmluZCA9IGZ1bmN0aW9uKG1vZGVsLCBrZXksIHVwZGF0ZSwgcGF0aCkgewoJICAgIHZhciByZWxfZm4sIHR5cGU7CgkgICAgaWYgKCEodHlwZSA9IHRoaXMucmVsYXRpb25UeXBlKG1vZGVsLCBrZXkpKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIHJlbF9mbiA9IGZ1bmN0aW9uKG1vZGVsLCBvdGhlcikgewoJICAgICAgdmFyIHByZXZpb3VzLCByZWxhdGlvbjsKCSAgICAgICFrYi5zdGF0aXN0aWNzIHx8IGtiLnN0YXRpc3RpY3MuYWRkTW9kZWxFdmVudCh7CgkgICAgICAgIG5hbWU6ICd1cGRhdGUgKHN1cGVybW9kZWwpJywKCSAgICAgICAgbW9kZWw6IG1vZGVsLAoJICAgICAgICBrZXk6IGtleSwKCSAgICAgICAgcGF0aDogcGF0aAoJICAgICAgfSk7CgkgICAgICByZWxhdGlvbiA9IG1vZGVsLmNvbnN0cnVjdG9yLmFzc29jaWF0aW9ucygpW2tleV07CgkgICAgICBwcmV2aW91cyA9IG1vZGVsW3JlbGF0aW9uLnN0b3JlXTsKCSAgICAgIG1vZGVsW3JlbGF0aW9uLnN0b3JlXSA9IG90aGVyOwoJICAgICAgdXBkYXRlKG90aGVyKTsKCSAgICAgIHJldHVybiBtb2RlbFtyZWxhdGlvbi5zdG9yZV0gPSBwcmV2aW91czsKCSAgICB9OwoJICAgIGlmICh0eXBlID09PSBrYi5UWVBFX01PREVMKSB7CgkgICAgICBtb2RlbC5iaW5kKCJhc3NvY2lhdGU6IiArIGtleSwgcmVsX2ZuKTsKCSAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgcmV0dXJuIG1vZGVsLnVuYmluZCgiYXNzb2NpYXRlOiIgKyBrZXksIHJlbF9mbik7CgkgICAgICB9OwoJICAgIH0KCSAgfTsKCgkgIFN1cGVybW9kZWwudXNlRnVuY3Rpb24gPSBmdW5jdGlvbihtb2RlbCwga2V5KSB7CgkgICAgcmV0dXJuICEhdGhpcy5yZWxhdGlvblR5cGUobW9kZWwsIGtleSk7CgkgIH07CgoJICByZXR1cm4gU3VwZXJtb2RlbDsKCgl9KSgpOwoJCgkvKiBXRUJQQUNLIFZBUiBJTkpFQ1RJT04gKi99LmNhbGwoZXhwb3J0cywgKGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpczsgfSgpKSkpCgovKioqLyB9LAovKiAyNiAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciBjb3B5UHJvcHM7CgoJY29weVByb3BzID0gZnVuY3Rpb24oZGVzdCwgc291cmNlKSB7CgkgIHZhciBrZXksIHZhbHVlOwoJICBmb3IgKGtleSBpbiBzb3VyY2UpIHsKCSAgICB2YWx1ZSA9IHNvdXJjZVtrZXldOwoJICAgIGRlc3Rba2V5XSA9IHZhbHVlOwoJICB9CgkgIHJldHVybiBkZXN0OwoJfTsKCgkvLyBTaGFyZWQgZW1wdHkgY29uc3RydWN0b3IgZnVuY3Rpb24gdG8gYWlkIGluIHByb3RvdHlwZS1jaGFpbiBjcmVhdGlvbi4KCXZhciBjdG9yID0gZnVuY3Rpb24oKXt9OwoKCS8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgoJLy8gU2ltaWxhciB0byAnZ29vZy5pbmhlcml0cycsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKCS8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCgl2YXIgaW5oZXJpdHMgPSBmdW5jdGlvbihwYXJlbnQsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CgkgIHZhciBjaGlsZDsKCgkgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKCSAgLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgZXh0ZW5kIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKCSAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgoJICBpZiAocHJvdG9Qcm9wcyAmJiBwcm90b1Byb3BzLmhhc093blByb3BlcnR5KCdjb25zdHJ1Y3RvcicpKSB7CgkgICAgY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOwoJICB9IGVsc2UgewoJICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CgkgIH0KCgkgIC8vIEluaGVyaXQgY2xhc3MgKHN0YXRpYykgcHJvcGVydGllcyBmcm9tIHBhcmVudC4KCSAgY29weVByb3BzKGNoaWxkLCBwYXJlbnQpOwoKCSAgLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIHBhcmVudCwgd2l0aG91dCBjYWxsaW5nCgkgIC8vIHBhcmVudCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgoJICBjdG9yLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7CgkgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBjdG9yKCk7CgoJICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKCSAgLy8gaWYgc3VwcGxpZWQuCgkgIGlmIChwcm90b1Byb3BzKSBjb3B5UHJvcHMoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKCgkgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgoJICBpZiAoc3RhdGljUHJvcHMpIGNvcHlQcm9wcyhjaGlsZCwgc3RhdGljUHJvcHMpOwoKCSAgLy8gQ29ycmVjdGx5IHNldCBjaGlsZCdzICdwcm90b3R5cGUuY29uc3RydWN0b3InLgoJICBjaGlsZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjaGlsZDsKCgkgIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQgbGF0ZXIuCgkgIGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7CgoJICByZXR1cm4gY2hpbGQ7Cgl9OwoKCS8vIFRoZSBzZWxmLXByb3BhZ2F0aW5nIGV4dGVuZCBmdW5jdGlvbiB0aGF0IEJhY0xDb25lIGNsYXNzZXMgdXNlLgoJdmFyIGV4dGVuZCA9IGZ1bmN0aW9uIChwcm90b1Byb3BzLCBjbGFzc1Byb3BzKSB7CgkgIHZhciBjaGlsZCA9IGluaGVyaXRzKHRoaXMsIHByb3RvUHJvcHMsIGNsYXNzUHJvcHMpOwoJICBjaGlsZC5leHRlbmQgPSB0aGlzLmV4dGVuZDsKCSAgcmV0dXJuIGNoaWxkOwoJfTsKCTsKCgltb2R1bGUuZXhwb3J0cyA9IGV4dGVuZDsKCgovKioqLyB9LAovKiAyNyAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciB3cmFwcGVkRGVzdHJveSwgXzsKCglfID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KS5fOwoKCW1vZHVsZS5leHBvcnRzID0gd3JhcHBlZERlc3Ryb3kgPSBmdW5jdGlvbihvYmopIHsKCSAgdmFyIHN0b3JlX3JlZmVyZW5jZXMsIF9fa2I7CgkgIGlmICghb2JqLl9fa2IpIHsKCSAgICByZXR1cm47CgkgIH0KCSAgaWYgKG9iai5fX2tiLmV2ZW50X3dhdGNoZXIpIHsKCSAgICBvYmouX19rYi5ldmVudF93YXRjaGVyLnJlbGVhc2VDYWxsYmFja3Mob2JqKTsKCSAgfQoJICBfX2tiID0gb2JqLl9fa2I7CgkgIG9iai5fX2tiID0gbnVsbDsKCSAgaWYgKF9fa2Iub2JzZXJ2YWJsZSkgewoJICAgIF9fa2Iub2JzZXJ2YWJsZS5kZXN0cm95ID0gX19rYi5vYnNlcnZhYmxlLnJlbGVhc2UgPSBudWxsOwoJICAgIHdyYXBwZWREZXN0cm95KF9fa2Iub2JzZXJ2YWJsZSk7CgkgICAgX19rYi5vYnNlcnZhYmxlID0gbnVsbDsKCSAgfQoJICBfX2tiLmZhY3RvcnkgPSBudWxsOwoJICBpZiAoX19rYi5ldmVudF93YXRjaGVyX2lzX293bmVkKSB7CgkgICAgX19rYi5ldmVudF93YXRjaGVyLmRlc3Ryb3koKTsKCSAgfQoJICBfX2tiLmV2ZW50X3dhdGNoZXIgPSBudWxsOwoJICBpZiAoX19rYi5zdG9yZV9pc19vd25lZCkgewoJICAgIF9fa2Iuc3RvcmUuZGVzdHJveSgpOwoJICB9CgkgIF9fa2Iuc3RvcmUgPSBudWxsOwoJICBpZiAoX19rYi5zdG9yZXNfcmVmZXJlbmNlcykgewoJICAgIHdoaWxlIChzdG9yZV9yZWZlcmVuY2VzID0gX19rYi5zdG9yZXNfcmVmZXJlbmNlcy5wb3AoKSkgewoJICAgICAgaWYgKCFzdG9yZV9yZWZlcmVuY2VzLnN0b3JlLl9fa2JfcmVsZWFzZWQpIHsKCSAgICAgICAgc3RvcmVfcmVmZXJlbmNlcy5zdG9yZS5yZWxlYXNlKG9iaik7CgkgICAgICB9CgkgICAgfQoJICB9Cgl9OwoKCi8qKiovIH0sCi8qIDI4ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIF8sIF9rZXlBcnJheVRvT2JqZWN0LCBfbWVyZ2VBcnJheSwgX21lcmdlT2JqZWN0LCBfbWVyZ2VPcHRpb25zOwoKCV8gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLl87CgoJX21lcmdlQXJyYXkgPSBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKCSAgcmVzdWx0W2tleV0gfHwgKHJlc3VsdFtrZXldID0gW10pOwoJICBpZiAoIV8uaXNBcnJheSh2YWx1ZSkpIHsKCSAgICB2YWx1ZSA9IFt2YWx1ZV07CgkgIH0KCSAgcmVzdWx0W2tleV0gPSByZXN1bHRba2V5XS5sZW5ndGggPyBfLnVuaW9uKHJlc3VsdFtrZXldLCB2YWx1ZSkgOiB2YWx1ZTsKCSAgcmV0dXJuIHJlc3VsdDsKCX07CgoJX21lcmdlT2JqZWN0ID0gZnVuY3Rpb24ocmVzdWx0LCBrZXksIHZhbHVlKSB7CgkgIHJlc3VsdFtrZXldIHx8IChyZXN1bHRba2V5XSA9IHt9KTsKCSAgcmV0dXJuIF8uZXh0ZW5kKHJlc3VsdFtrZXldLCB2YWx1ZSk7Cgl9OwoKCV9rZXlBcnJheVRvT2JqZWN0ID0gZnVuY3Rpb24odmFsdWUpIHsKCSAgdmFyIGl0ZW0sIHJlc3VsdCwgX2ksIF9sZW47CgkgIHJlc3VsdCA9IHt9OwoJICBmb3IgKF9pID0gMCwgX2xlbiA9IHZhbHVlLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgaXRlbSA9IHZhbHVlW19pXTsKCSAgICByZXN1bHRbaXRlbV0gPSB7CgkgICAgICBrZXk6IGl0ZW0KCSAgICB9OwoJICB9CgkgIHJldHVybiByZXN1bHQ7Cgl9OwoKCV9tZXJnZU9wdGlvbnMgPSBmdW5jdGlvbihyZXN1bHQsIG9wdGlvbnMpIHsKCSAgdmFyIGtleSwgdmFsdWU7CgkgIGlmICghb3B0aW9ucykgewoJICAgIHJldHVybiByZXN1bHQ7CgkgIH0KCSAgZm9yIChrZXkgaW4gb3B0aW9ucykgewoJICAgIHZhbHVlID0gb3B0aW9uc1trZXldOwoJICAgIHN3aXRjaCAoa2V5KSB7CgkgICAgICBjYXNlICdpbnRlcm5hbHMnOgoJICAgICAgY2FzZSAncmVxdWlyZXMnOgoJICAgICAgY2FzZSAnZXhjbHVkZXMnOgoJICAgICAgY2FzZSAnc3RhdGljcyc6CgkgICAgICAgIF9tZXJnZUFycmF5KHJlc3VsdCwga2V5LCB2YWx1ZSk7CgkgICAgICAgIGJyZWFrOwoJICAgICAgY2FzZSAna2V5cyc6CgkgICAgICAgIGlmICgoXy5pc09iamVjdCh2YWx1ZSkgJiYgIV8uaXNBcnJheSh2YWx1ZSkpIHx8IChfLmlzT2JqZWN0KHJlc3VsdFtrZXldKSAmJiAhXy5pc0FycmF5KHJlc3VsdFtrZXldKSkpIHsKCSAgICAgICAgICBpZiAoIV8uaXNPYmplY3QodmFsdWUpKSB7CgkgICAgICAgICAgICB2YWx1ZSA9IFt2YWx1ZV07CgkgICAgICAgICAgfQoJICAgICAgICAgIGlmIChfLmlzQXJyYXkodmFsdWUpKSB7CgkgICAgICAgICAgICB2YWx1ZSA9IF9rZXlBcnJheVRvT2JqZWN0KHZhbHVlKTsKCSAgICAgICAgICB9CgkgICAgICAgICAgaWYgKF8uaXNBcnJheShyZXN1bHRba2V5XSkpIHsKCSAgICAgICAgICAgIHJlc3VsdFtrZXldID0gX2tleUFycmF5VG9PYmplY3QocmVzdWx0W2tleV0pOwoJICAgICAgICAgIH0KCSAgICAgICAgICBfbWVyZ2VPYmplY3QocmVzdWx0LCBrZXksIHZhbHVlKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICBfbWVyZ2VBcnJheShyZXN1bHQsIGtleSwgdmFsdWUpOwoJICAgICAgICB9CgkgICAgICAgIGJyZWFrOwoJICAgICAgY2FzZSAnZmFjdG9yaWVzJzoKCSAgICAgICAgaWYgKF8uaXNGdW5jdGlvbih2YWx1ZSkpIHsKCSAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIF9tZXJnZU9iamVjdChyZXN1bHQsIGtleSwgdmFsdWUpOwoJICAgICAgICB9CgkgICAgICAgIGJyZWFrOwoJICAgICAgY2FzZSAnc3RhdGljX2RlZmF1bHRzJzoKCSAgICAgICAgX21lcmdlT2JqZWN0KHJlc3VsdCwga2V5LCB2YWx1ZSk7CgkgICAgICAgIGJyZWFrOwoJICAgICAgY2FzZSAnb3B0aW9ucyc6CgkgICAgICAgIGJyZWFrOwoJICAgICAgZGVmYXVsdDoKCSAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKCSAgICB9CgkgIH0KCSAgcmV0dXJuIF9tZXJnZU9wdGlvbnMocmVzdWx0LCBvcHRpb25zLm9wdGlvbnMpOwoJfTsKCgltb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgcmV0dXJuIF9tZXJnZU9wdGlvbnMoe30sIG9wdGlvbnMpOwoJfTsKCgovKioqLyB9LAovKiAyOSAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciB1bndyYXBNb2RlbHMsIF87CgoJXyA9IF9fd2VicGFja19yZXF1aXJlX18oNikuXzsKCgltb2R1bGUuZXhwb3J0cyA9IHVud3JhcE1vZGVscyA9IGZ1bmN0aW9uKG9iaikgewoJICB2YXIga2V5LCByZXN1bHQsIHZhbHVlOwoJICBpZiAoIW9iaikgewoJICAgIHJldHVybiBvYmo7CgkgIH0KCSAgaWYgKG9iai5fX2tiKSB7CgkgICAgcmV0dXJuIChvYmouX19rYi5oYXNPd25Qcm9wZXJ0eSgnb2JqZWN0JykgPyBvYmouX19rYi5vYmplY3QgOiBvYmopOwoJICB9CgkgIGlmIChfLmlzQXJyYXkob2JqKSkgewoJICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uKHRlc3QpIHsKCSAgICAgIHJldHVybiB1bndyYXBNb2RlbHModGVzdCk7CgkgICAgfSk7CgkgIH0KCSAgaWYgKF8uaXNPYmplY3Qob2JqKSAmJiAob2JqLmNvbnN0cnVjdG9yID09PSB7fS5jb25zdHJ1Y3RvcikpIHsKCSAgICByZXN1bHQgPSB7fTsKCSAgICBmb3IgKGtleSBpbiBvYmopIHsKCSAgICAgIHZhbHVlID0gb2JqW2tleV07CgkgICAgICByZXN1bHRba2V5XSA9IHVud3JhcE1vZGVscyh2YWx1ZSk7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH0KCSAgcmV0dXJuIG9iajsKCX07CgoKLyoqKi8gfSwKLyogMzAgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJdmFyIF9fV0VCUEFDS19BTURfREVGSU5FX0FSUkFZX18sIF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fOy8vICAgICBCYWNrYm9uZS5qcyAxLjEuMgoKCS8vICAgICAoYykgMjAxMC0yMDE0IEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCgkvLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgkvLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgoJLy8gICAgIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZwoKCShmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CgoJICAvLyBTZXQgdXAgQmFja2JvbmUgYXBwcm9wcmlhdGVseSBmb3IgdGhlIGVudmlyb25tZW50LiBTdGFydCB3aXRoIEFNRC4KCSAgaWYgKHRydWUpIHsKCSAgICAhKF9fV0VCUEFDS19BTURfREVGSU5FX0FSUkFZX18gPSBbX193ZWJwYWNrX3JlcXVpcmVfXygzMSksIF9fd2VicGFja19yZXF1aXJlX18oMjApLCBleHBvcnRzXSwgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gPSBmdW5jdGlvbihfLCAkLCBleHBvcnRzKSB7CgkgICAgICAvLyBFeHBvcnQgZ2xvYmFsIGV2ZW4gaW4gQU1EIGNhc2UgaW4gY2FzZSB0aGlzIHNjcmlwdCBpcyBsb2FkZWQgd2l0aAoJICAgICAgLy8gb3RoZXJzIHRoYXQgbWF5IHN0aWxsIGV4cGVjdCBhIGdsb2JhbCBCYWNrYm9uZS4KCSAgICAgIHJvb3QuQmFja2JvbmUgPSBmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIF8sICQpOwoJICAgIH0uYXBwbHkoZXhwb3J0cywgX19XRUJQQUNLX0FNRF9ERUZJTkVfQVJSQVlfXyksIF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fICE9PSB1bmRlZmluZWQgJiYgKG1vZHVsZS5leHBvcnRzID0gX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18pKTsKCgkgIC8vIE5leHQgZm9yIE5vZGUuanMgb3IgQ29tbW9uSlMuIGpRdWVyeSBtYXkgbm90IGJlIG5lZWRlZCBhcyBhIG1vZHVsZS4KCSAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKCSAgICB2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTsKCSAgICBmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIF8pOwoKCSAgLy8gRmluYWxseSwgYXMgYSBicm93c2VyIGdsb2JhbC4KCSAgfSBlbHNlIHsKCSAgICByb290LkJhY2tib25lID0gZmFjdG9yeShyb290LCB7fSwgcm9vdC5fLCAocm9vdC5qUXVlcnkgfHwgcm9vdC5aZXB0byB8fCByb290LmVuZGVyIHx8IHJvb3QuJCkpOwoJICB9CgoJfSh0aGlzLCBmdW5jdGlvbihyb290LCBCYWNrYm9uZSwgXywgJCkgewoKCSAgLy8gSW5pdGlhbCBTZXR1cAoJICAvLyAtLS0tLS0tLS0tLS0tCgoJICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKCSAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgoJICB2YXIgcHJldmlvdXNCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmU7CgoJICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgoJICB2YXIgYXJyYXkgPSBbXTsKCSAgdmFyIHB1c2ggPSBhcnJheS5wdXNoOwoJICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKCSAgdmFyIHNwbGljZSA9IGFycmF5LnNwbGljZTsKCgkgIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCgkgIEJhY2tib25lLlZFUlNJT04gPSAnMS4xLjInOwoKCSAgLy8gRm9yIEJhY2tib25lJ3MgcHVycG9zZXMsIGpRdWVyeSwgWmVwdG8sIEVuZGVyLCBvciBNeSBMaWJyYXJ5IChraWRkaW5nKSBvd25zCgkgIC8vIHRoZSBgJGAgdmFyaWFibGUuCgkgIEJhY2tib25lLiQgPSAkOwoKCSAgLy8gUnVucyBCYWNrYm9uZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlCgkgIC8vIHRvIGl0cyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIEJhY2tib25lIG9iamVjdC4KCSAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewoJICAgIHJvb3QuQmFja2JvbmUgPSBwcmV2aW91c0JhY2tib25lOwoJICAgIHJldHVybiB0aGlzOwoJICB9OwoKCSAgLy8gVHVybiBvbiBgZW11bGF0ZUhUVFBgIHRvIHN1cHBvcnQgbGVnYWN5IEhUVFAgc2VydmVycy4gU2V0dGluZyB0aGlzIG9wdGlvbgoJICAvLyB3aWxsIGZha2UgYCJQQVRDSCJgLCBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKCSAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KCSAgQmFja2JvbmUuZW11bGF0ZUhUVFAgPSBmYWxzZTsKCgkgIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAoJICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCgkgIC8vIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgIGluc3RlYWQgYW5kIHdpbGwgc2VuZCB0aGUgbW9kZWwgaW4gYQoJICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCgkgIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgoJICAvLyBCYWNrYm9uZS5FdmVudHMKCSAgLy8gLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCgkgIC8vIGN1c3RvbSBldmVudHMuIFlvdSBtYXkgYmluZCB3aXRoIGBvbmAgb3IgcmVtb3ZlIHdpdGggYG9mZmAgY2FsbGJhY2sKCSAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KCSAgLy8gc3VjY2Vzc2lvbi4KCSAgLy8KCSAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKCSAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKCSAgLy8gICAgIG9iamVjdC5vbignZXhwYW5kJywgZnVuY3Rpb24oKXsgYWxlcnQoJ2V4cGFuZGVkJyk7IH0pOwoJICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwoJICAvLwoJICB2YXIgRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzID0gewoKCSAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZAoJICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgoJICAgIG9uOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewoJICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKSByZXR1cm4gdGhpczsKCSAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwoJICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSB8fCAodGhpcy5fZXZlbnRzW25hbWVdID0gW10pOwoJICAgICAgZXZlbnRzLnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIEJpbmQgYW4gZXZlbnQgdG8gb25seSBiZSB0cmlnZ2VyZWQgYSBzaW5nbGUgdGltZS4gQWZ0ZXIgdGhlIGZpcnN0IHRpbWUKCSAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgoJICAgIG9uY2U6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CgkgICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CgkgICAgICB2YXIgc2VsZiA9IHRoaXM7CgkgICAgICB2YXIgb25jZSA9IF8ub25jZShmdW5jdGlvbigpIHsKCSAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CgkgICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgICAgICB9KTsKCSAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CgkgICAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKCSAgICB9LAoKCSAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKCSAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCgkgICAgLy8gY2FsbGJhY2tzIGZvciB0aGUgZXZlbnQuIElmIGBuYW1lYCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZAoJICAgIC8vIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KCSAgICBvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CgkgICAgICB2YXIgcmV0YWluLCBldiwgZXZlbnRzLCBuYW1lcywgaSwgbCwgaiwgazsKCSAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKCSAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKCSAgICAgICAgdGhpcy5fZXZlbnRzID0gdm9pZCAwOwoJICAgICAgICByZXR1cm4gdGhpczsKCSAgICAgIH0KCSAgICAgIG5hbWVzID0gbmFtZSA/IFtuYW1lXSA6IF8ua2V5cyh0aGlzLl9ldmVudHMpOwoJICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJICAgICAgICBuYW1lID0gbmFtZXNbaV07CgkgICAgICAgIGlmIChldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0pIHsKCSAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSByZXRhaW4gPSBbXTsKCSAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewoJICAgICAgICAgICAgZm9yIChqID0gMCwgayA9IGV2ZW50cy5sZW5ndGg7IGogPCBrOyBqKyspIHsKCSAgICAgICAgICAgICAgZXYgPSBldmVudHNbal07CgkgICAgICAgICAgICAgIGlmICgoY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjay5fY2FsbGJhY2spIHx8CgkgICAgICAgICAgICAgICAgICAoY29udGV4dCAmJiBjb250ZXh0ICE9PSBldi5jb250ZXh0KSkgewoJICAgICAgICAgICAgICAgIHJldGFpbi5wdXNoKGV2KTsKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgIH0KCSAgICAgICAgICBpZiAoIXJldGFpbi5sZW5ndGgpIGRlbGV0ZSB0aGlzLl9ldmVudHNbbmFtZV07CgkgICAgICAgIH0KCSAgICAgIH0KCgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKCSAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQoJICAgIC8vICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KCSAgICAvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCgkgICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewoJICAgICAgaWYgKCF0aGlzLl9ldmVudHMpIHJldHVybiB0aGlzOwoJICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgkgICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKCSAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV07CgkgICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKCSAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHMoZXZlbnRzLCBhcmdzKTsKCSAgICAgIGlmIChhbGxFdmVudHMpIHRyaWdnZXJFdmVudHMoYWxsRXZlbnRzLCBhcmd1bWVudHMpOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gVGVsbCB0aGlzIG9iamVjdCB0byBzdG9wIGxpc3RlbmluZyB0byBlaXRoZXIgc3BlY2lmaWMgZXZlbnRzIC4uLiBvcgoJICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCgkgICAgc3RvcExpc3RlbmluZzogZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewoJICAgICAgdmFyIGxpc3RlbmluZ1RvID0gdGhpcy5fbGlzdGVuaW5nVG87CgkgICAgICBpZiAoIWxpc3RlbmluZ1RvKSByZXR1cm4gdGhpczsKCSAgICAgIHZhciByZW1vdmUgPSAhbmFtZSAmJiAhY2FsbGJhY2s7CgkgICAgICBpZiAoIWNhbGxiYWNrICYmIHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgY2FsbGJhY2sgPSB0aGlzOwoJICAgICAgaWYgKG9iaikgKGxpc3RlbmluZ1RvID0ge30pW29iai5fbGlzdGVuSWRdID0gb2JqOwoJICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuaW5nVG8pIHsKCSAgICAgICAgb2JqID0gbGlzdGVuaW5nVG9baWRdOwoJICAgICAgICBvYmoub2ZmKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKCSAgICAgICAgaWYgKHJlbW92ZSB8fCBfLmlzRW1wdHkob2JqLl9ldmVudHMpKSBkZWxldGUgdGhpcy5fbGlzdGVuaW5nVG9baWRdOwoJICAgICAgfQoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfQoKCSAgfTsKCgkgIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCgkgIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CgoJICAvLyBJbXBsZW1lbnQgZmFuY3kgZmVhdHVyZXMgb2YgdGhlIEV2ZW50cyBBUEkgc3VjaCBhcyBtdWx0aXBsZSBldmVudAoJICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAoJICAvLyBpbiB0ZXJtcyBvZiB0aGUgZXhpc3RpbmcgQVBJLgoJICB2YXIgZXZlbnRzQXBpID0gZnVuY3Rpb24ob2JqLCBhY3Rpb24sIG5hbWUsIHJlc3QpIHsKCSAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwoKCSAgICAvLyBIYW5kbGUgZXZlbnQgbWFwcy4KCSAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7CgkgICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewoJICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtrZXksIG5hbWVba2V5XV0uY29uY2F0KHJlc3QpKTsKCSAgICAgIH0KCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9CgoJICAgIC8vIEhhbmRsZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnQgbmFtZXMuCgkgICAgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewoJICAgICAgdmFyIG5hbWVzID0gbmFtZS5zcGxpdChldmVudFNwbGl0dGVyKTsKCSAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW25hbWVzW2ldXS5jb25jYXQocmVzdCkpOwoJICAgICAgfQoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCgkgICAgcmV0dXJuIHRydWU7CgkgIH07CgoJICAvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgoJICAvLyB0cmlnZ2VyaW5nIGV2ZW50cy4gVHJpZXMgdG8ga2VlcCB0aGUgdXN1YWwgY2FzZXMgc3BlZWR5IChtb3N0IGludGVybmFsCgkgIC8vIEJhY2tib25lIGV2ZW50cyBoYXZlIDMgYXJndW1lbnRzKS4KCSAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihldmVudHMsIGFyZ3MpIHsKCSAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGgsIGExID0gYXJnc1swXSwgYTIgPSBhcmdzWzFdLCBhMyA9IGFyZ3NbMl07CgkgICAgc3dpdGNoIChhcmdzLmxlbmd0aCkgewoJICAgICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7IHJldHVybjsKCSAgICAgIGNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExKTsgcmV0dXJuOwoJICAgICAgY2FzZSAyOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyKTsgcmV0dXJuOwoJICAgICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyLCBhMyk7IHJldHVybjsKCSAgICAgIGRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7IHJldHVybjsKCSAgICB9CgkgIH07CgoJICB2YXIgbGlzdGVuTWV0aG9kcyA9IHtsaXN0ZW5UbzogJ29uJywgbGlzdGVuVG9PbmNlOiAnb25jZSd9OwoKCSAgLy8gSW52ZXJzaW9uLW9mLWNvbnRyb2wgdmVyc2lvbnMgb2YgYG9uYCBhbmQgYG9uY2VgLiBUZWxsICp0aGlzKiBvYmplY3QgdG8KCSAgLy8gbGlzdGVuIHRvIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncwoJICAvLyBsaXN0ZW5pbmcgdG8uCgkgIF8uZWFjaChsaXN0ZW5NZXRob2RzLCBmdW5jdGlvbihpbXBsZW1lbnRhdGlvbiwgbWV0aG9kKSB7CgkgICAgRXZlbnRzW21ldGhvZF0gPSBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CgkgICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbyB8fCAodGhpcy5fbGlzdGVuaW5nVG8gPSB7fSk7CgkgICAgICB2YXIgaWQgPSBvYmouX2xpc3RlbklkIHx8IChvYmouX2xpc3RlbklkID0gXy51bmlxdWVJZCgnbCcpKTsKCSAgICAgIGxpc3RlbmluZ1RvW2lkXSA9IG9iajsKCSAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CgkgICAgICBvYmpbaW1wbGVtZW50YXRpb25dKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCgkgIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CgkgIEV2ZW50cy51bmJpbmQgPSBFdmVudHMub2ZmOwoKCSAgLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwoJICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCgkgIF8uZXh0ZW5kKEJhY2tib25lLCBFdmVudHMpOwoKCSAgLy8gQmFja2JvbmUuTW9kZWwKCSAgLy8gLS0tLS0tLS0tLS0tLS0KCgkgIC8vIEJhY2tib25lICoqTW9kZWxzKiogYXJlIHRoZSBiYXNpYyBkYXRhIG9iamVjdCBpbiB0aGUgZnJhbWV3b3JrIC0tCgkgIC8vIGZyZXF1ZW50bHkgcmVwcmVzZW50aW5nIGEgcm93IGluIGEgdGFibGUgaW4gYSBkYXRhYmFzZSBvbiB5b3VyIHNlcnZlci4KCSAgLy8gQSBkaXNjcmV0ZSBjaHVuayBvZiBkYXRhIGFuZCBhIGJ1bmNoIG9mIHVzZWZ1bCwgcmVsYXRlZCBtZXRob2RzIGZvcgoJICAvLyBwZXJmb3JtaW5nIGNvbXB1dGF0aW9ucyBhbmQgdHJhbnNmb3JtYXRpb25zIG9uIHRoYXQgZGF0YS4KCgkgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIHRoZSBzcGVjaWZpZWQgYXR0cmlidXRlcy4gQSBjbGllbnQgaWQgKGBjaWRgKQoJICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KCSAgdmFyIE1vZGVsID0gQmFja2JvbmUuTW9kZWwgPSBmdW5jdGlvbihhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CgkgICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKCSAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgnYycpOwoJICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwoJICAgIGlmIChvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKCSAgICBpZiAob3B0aW9ucy5wYXJzZSkgYXR0cnMgPSB0aGlzLnBhcnNlKGF0dHJzLCBvcHRpb25zKSB8fCB7fTsKCSAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSk7CgkgICAgdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpOwoJICAgIHRoaXMuY2hhbmdlZCA9IHt9OwoJICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICB9OwoKCSAgLy8gQXR0YWNoIGFsbCBpbmhlcml0YWJsZSBtZXRob2RzIHRvIHRoZSBNb2RlbCBwcm90b3R5cGUuCgkgIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgoJICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KCSAgICBjaGFuZ2VkOiBudWxsLAoKCSAgICAvLyBUaGUgdmFsdWUgcmV0dXJuZWQgZHVyaW5nIHRoZSBsYXN0IGZhaWxlZCB2YWxpZGF0aW9uLgoJICAgIHZhbGlkYXRpb25FcnJvcjogbnVsbCwKCgkgICAgLy8gVGhlIGRlZmF1bHQgbmFtZSBmb3IgdGhlIEpTT04gYGlkYCBhdHRyaWJ1dGUgaXMgYCJpZCJgLiBNb25nb0RCIGFuZAoJICAgIC8vIENvdWNoREIgdXNlcnMgbWF5IHdhbnQgdG8gc2V0IHRoaXMgdG8gYCJfaWQiYC4KCSAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCgkgICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCgkgICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCgkgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKCSAgICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBtb2RlbCdzIGBhdHRyaWJ1dGVzYCBvYmplY3QuCgkgICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwoJICAgIH0sCgoJICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0IC0tIGJ1dCBvdmVycmlkZSB0aGlzIGlmIHlvdSBuZWVkCgkgICAgLy8gY3VzdG9tIHN5bmNpbmcgc2VtYW50aWNzIGZvciAqdGhpcyogcGFydGljdWxhciBtb2RlbC4KCSAgICBzeW5jOiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgICAgfSwKCgkgICAgLy8gR2V0IHRoZSB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCgkgICAgZ2V0OiBmdW5jdGlvbihhdHRyKSB7CgkgICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwoJICAgIH0sCgoJICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KCSAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKCSAgICAgIHJldHVybiBfLmVzY2FwZSh0aGlzLmdldChhdHRyKSk7CgkgICAgfSwKCgkgICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKCSAgICAvLyBvciB1bmRlZmluZWQuCgkgICAgaGFzOiBmdW5jdGlvbihhdHRyKSB7CgkgICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKCSAgICB9LAoKCSAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMgb24gdGhlIG9iamVjdCwgZmlyaW5nIGAiY2hhbmdlImAuIFRoaXMgaXMKCSAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKCSAgICAvLyBhbnlvbmUgd2hvIG5lZWRzIHRvIGtub3cgYWJvdXQgdGhlIGNoYW5nZSBpbiBzdGF0ZS4gVGhlIGhlYXJ0IG9mIHRoZSBiZWFzdC4KCSAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CgkgICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwoJICAgICAgaWYgKGtleSA9PSBudWxsKSByZXR1cm4gdGhpczsKCgkgICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KCSAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewoJICAgICAgICBhdHRycyA9IGtleTsKCSAgICAgICAgb3B0aW9ucyA9IHZhbDsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwoJICAgICAgfQoKCSAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgoJICAgICAgLy8gUnVuIHZhbGlkYXRpb24uCgkgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKCSAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KCSAgICAgIHVuc2V0ICAgICAgICAgICA9IG9wdGlvbnMudW5zZXQ7CgkgICAgICBzaWxlbnQgICAgICAgICAgPSBvcHRpb25zLnNpbGVudDsKCSAgICAgIGNoYW5nZXMgICAgICAgICA9IFtdOwoJICAgICAgY2hhbmdpbmcgICAgICAgID0gdGhpcy5fY2hhbmdpbmc7CgkgICAgICB0aGlzLl9jaGFuZ2luZyAgPSB0cnVlOwoKCSAgICAgIGlmICghY2hhbmdpbmcpIHsKCSAgICAgICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwoJICAgICAgICB0aGlzLmNoYW5nZWQgPSB7fTsKCSAgICAgIH0KCSAgICAgIGN1cnJlbnQgPSB0aGlzLmF0dHJpYnV0ZXMsIHByZXYgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CgoJICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KCSAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgoJICAgICAgLy8gRm9yIGVhY2ggYHNldGAgYXR0cmlidXRlLCB1cGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLgoJICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CgkgICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwoJICAgICAgICBpZiAoIV8uaXNFcXVhbChjdXJyZW50W2F0dHJdLCB2YWwpKSBjaGFuZ2VzLnB1c2goYXR0cik7CgkgICAgICAgIGlmICghXy5pc0VxdWFsKHByZXZbYXR0cl0sIHZhbCkpIHsKCSAgICAgICAgICB0aGlzLmNoYW5nZWRbYXR0cl0gPSB2YWw7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgZGVsZXRlIHRoaXMuY2hhbmdlZFthdHRyXTsKCSAgICAgICAgfQoJICAgICAgICB1bnNldCA/IGRlbGV0ZSBjdXJyZW50W2F0dHJdIDogY3VycmVudFthdHRyXSA9IHZhbDsKCSAgICAgIH0KCgkgICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KCSAgICAgIGlmICghc2lsZW50KSB7CgkgICAgICAgIGlmIChjaGFuZ2VzLmxlbmd0aCkgdGhpcy5fcGVuZGluZyA9IG9wdGlvbnM7CgkgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hhbmdlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCSAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgY2hhbmdlc1tpXSwgdGhpcywgY3VycmVudFtjaGFuZ2VzW2ldXSwgb3B0aW9ucyk7CgkgICAgICAgIH0KCSAgICAgIH0KCgkgICAgICAvLyBZb3UgbWlnaHQgYmUgd29uZGVyaW5nIHdoeSB0aGVyZSdzIGEgYHdoaWxlYCBsb29wIGhlcmUuIENoYW5nZXMgY2FuCgkgICAgICAvLyBiZSByZWN1cnNpdmVseSBuZXN0ZWQgd2l0aGluIGAiY2hhbmdlImAgZXZlbnRzLgoJICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKCSAgICAgIGlmICghc2lsZW50KSB7CgkgICAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7CgkgICAgICAgICAgb3B0aW9ucyA9IHRoaXMuX3BlbmRpbmc7CgkgICAgICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwoJICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlJywgdGhpcywgb3B0aW9ucyk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKCSAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4gYHVuc2V0YCBpcyBhIG5vb3AKCSAgICAvLyBpZiB0aGUgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QuCgkgICAgdW5zZXQ6IGZ1bmN0aW9uKGF0dHIsIG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CgkgICAgfSwKCgkgICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4KCSAgICBjbGVhcjogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgdmFyIGF0dHJzID0ge307CgkgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5hdHRyaWJ1dGVzKSBhdHRyc1trZXldID0gdm9pZCAwOwoJICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwoJICAgIH0sCgoJICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KCSAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgoJICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uKGF0dHIpIHsKCSAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CgkgICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKCSAgICB9LAoKCSAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIHRoZSBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkLCBvcgoJICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAoJICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCgkgICAgLy8gcGVyc2lzdGVkIHRvIHRoZSBzZXJ2ZXIuIFVuc2V0IGF0dHJpYnV0ZXMgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgoJICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCgkgICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KCSAgICBjaGFuZ2VkQXR0cmlidXRlczogZnVuY3Rpb24oZGlmZikgewoJICAgICAgaWYgKCFkaWZmKSByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKCSAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKCSAgICAgIHZhciBvbGQgPSB0aGlzLl9jaGFuZ2luZyA/IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA6IHRoaXMuYXR0cmlidXRlczsKCSAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewoJICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgKHZhbCA9IGRpZmZbYXR0cl0pKSkgY29udGludWU7CgkgICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKCSAgICAgIH0KCSAgICAgIHJldHVybiBjaGFuZ2VkOwoJICAgIH0sCgoJICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAoJICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgoJICAgIHByZXZpb3VzOiBmdW5jdGlvbihhdHRyKSB7CgkgICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwoJICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlc1thdHRyXTsKCSAgICB9LAoKCSAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKCSAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgoJICAgIHByZXZpb3VzQXR0cmlidXRlczogZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwoJICAgIH0sCgoJICAgIC8vIEZldGNoIHRoZSBtb2RlbCBmcm9tIHRoZSBzZXJ2ZXIuIElmIHRoZSBzZXJ2ZXIncyByZXByZXNlbnRhdGlvbiBvZiB0aGUKCSAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRkZW4sCgkgICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCgkgICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoJICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CgkgICAgICB2YXIgbW9kZWwgPSB0aGlzOwoJICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgkgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CgkgICAgICAgIGlmICghbW9kZWwuc2V0KG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoJICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkgICAgICB9OwoJICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoJICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwoJICAgIH0sCgoJICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcywgYW5kIHN5bmMgdGhlIG1vZGVsIHRvIHRoZSBzZXJ2ZXIuCgkgICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCgkgICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KCSAgICBzYXZlOiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewoJICAgICAgdmFyIGF0dHJzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKCgkgICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KCSAgICAgIGlmIChrZXkgPT0gbnVsbCB8fCB0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewoJICAgICAgICBhdHRycyA9IGtleTsKCSAgICAgICAgb3B0aW9ucyA9IHZhbDsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwoJICAgICAgfQoKCSAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7dmFsaWRhdGU6IHRydWV9LCBvcHRpb25zKTsKCgkgICAgICAvLyBJZiB3ZSdyZSBub3Qgd2FpdGluZyBhbmQgYXR0cmlidXRlcyBleGlzdCwgc2F2ZSBhY3RzIGFzCgkgICAgICAvLyBgc2V0KGF0dHIpLnNhdmUobnVsbCwgb3B0cylgIHdpdGggdmFsaWRhdGlvbi4gT3RoZXJ3aXNlLCBjaGVjayBpZgoJICAgICAgLy8gdGhlIG1vZGVsIHdpbGwgYmUgdmFsaWQgd2hlbiB0aGUgYXR0cmlidXRlcywgaWYgYW55LCBhcmUgc2V0LgoJICAgICAgaWYgKGF0dHJzICYmICFvcHRpb25zLndhaXQpIHsKCSAgICAgICAgaWYgKCF0aGlzLnNldChhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgkgICAgICB9CgoJICAgICAgLy8gU2V0IHRlbXBvcmFyeSBhdHRyaWJ1dGVzIGlmIGB7d2FpdDogdHJ1ZX1gLgoJICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgewoJICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7fSwgYXR0cmlidXRlcywgYXR0cnMpOwoJICAgICAgfQoKCSAgICAgIC8vIEFmdGVyIGEgc3VjY2Vzc2Z1bCBzZXJ2ZXItc2lkZSBzYXZlLCB0aGUgY2xpZW50IGlzIChvcHRpb25hbGx5KQoJICAgICAgLy8gdXBkYXRlZCB3aXRoIHRoZSBzZXJ2ZXItc2lkZSBzdGF0ZS4KCSAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwoJICAgICAgdmFyIG1vZGVsID0gdGhpczsKCSAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoJICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewoJICAgICAgICAvLyBFbnN1cmUgYXR0cmlidXRlcyBhcmUgcmVzdG9yZWQgZHVyaW5nIHN5bmNocm9ub3VzIHNhdmVzLgoJICAgICAgICBtb2RlbC5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKCSAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyk7CgkgICAgICAgIGlmIChvcHRpb25zLndhaXQpIHNlcnZlckF0dHJzID0gXy5leHRlbmQoYXR0cnMgfHwge30sIHNlcnZlckF0dHJzKTsKCSAgICAgICAgaWYgKF8uaXNPYmplY3Qoc2VydmVyQXR0cnMpICYmICFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSB7CgkgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgICB9CgkgICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICAgIH07CgkgICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgoJICAgICAgbWV0aG9kID0gdGhpcy5pc05ldygpID8gJ2NyZWF0ZScgOiAob3B0aW9ucy5wYXRjaCA/ICdwYXRjaCcgOiAndXBkYXRlJyk7CgkgICAgICBpZiAobWV0aG9kID09PSAncGF0Y2gnKSBvcHRpb25zLmF0dHJzID0gYXR0cnM7CgkgICAgICB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCgkgICAgICAvLyBSZXN0b3JlIGF0dHJpYnV0ZXMuCgkgICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB0aGlzLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwoKCSAgICAgIHJldHVybiB4aHI7CgkgICAgfSwKCgkgICAgLy8gRGVzdHJveSB0aGlzIG1vZGVsIG9uIHRoZSBzZXJ2ZXIgaWYgaXQgd2FzIGFscmVhZHkgcGVyc2lzdGVkLgoJICAgIC8vIE9wdGltaXN0aWNhbGx5IHJlbW92ZXMgdGhlIG1vZGVsIGZyb20gaXRzIGNvbGxlY3Rpb24sIGlmIGl0IGhhcyBvbmUuCgkgICAgLy8gSWYgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgd2FpdHMgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZCBiZWZvcmUgcmVtb3ZhbC4KCSAgICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKCSAgICAgIHZhciBtb2RlbCA9IHRoaXM7CgkgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCgkgICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOwoJICAgICAgfTsKCgkgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CgkgICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwoJICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkgICAgICAgIGlmICghbW9kZWwuaXNOZXcoKSkgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICAgIH07CgoJICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgewoJICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsKCSAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgfQoJICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoKCSAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMoJ2RlbGV0ZScsIHRoaXMsIG9wdGlvbnMpOwoJICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKCSAgICAgIHJldHVybiB4aHI7CgkgICAgfSwKCgkgICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCgkgICAgLy8gdXNpbmcgQmFja2JvbmUncyByZXN0ZnVsIG1ldGhvZHMsIG92ZXJyaWRlIHRoaXMgdG8gY2hhbmdlIHRoZSBlbmRwb2ludAoJICAgIC8vIHRoYXQgd2lsbCBiZSBjYWxsZWQuCgkgICAgdXJsOiBmdW5jdGlvbigpIHsKCSAgICAgIHZhciBiYXNlID0KCSAgICAgICAgXy5yZXN1bHQodGhpcywgJ3VybFJvb3QnKSB8fAoJICAgICAgICBfLnJlc3VsdCh0aGlzLmNvbGxlY3Rpb24sICd1cmwnKSB8fAoJICAgICAgICB1cmxFcnJvcigpOwoJICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgcmV0dXJuIGJhc2U7CgkgICAgICByZXR1cm4gYmFzZS5yZXBsYWNlKC8oW15cL10pJC8sICckMS8nKSArIGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLmlkKTsKCSAgICB9LAoKCSAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIHRoZSBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYHNldGAgb24KCSAgICAvLyB0aGUgbW9kZWwuIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyB0aGUgcmVzcG9uc2UgYWxvbmcuCgkgICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiByZXNwOwoJICAgIH0sCgoJICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgoJICAgIGNsb25lOiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLmF0dHJpYnV0ZXMpOwoJICAgIH0sCgoJICAgIC8vIEEgbW9kZWwgaXMgbmV3IGlmIGl0IGhhcyBuZXZlciBiZWVuIHNhdmVkIHRvIHRoZSBzZXJ2ZXIsIGFuZCBsYWNrcyBhbiBpZC4KCSAgICBpc05ldzogZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gIXRoaXMuaGFzKHRoaXMuaWRBdHRyaWJ1dGUpOwoJICAgIH0sCgoJICAgIC8vIENoZWNrIGlmIHRoZSBtb2RlbCBpcyBjdXJyZW50bHkgaW4gYSB2YWxpZCBzdGF0ZS4KCSAgICBpc1ZhbGlkOiBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgICByZXR1cm4gdGhpcy5fdmFsaWRhdGUoe30sIF8uZXh0ZW5kKG9wdGlvbnMgfHwge30sIHsgdmFsaWRhdGU6IHRydWUgfSkpOwoJICAgIH0sCgoJICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgdGhlIG5leHQgY29tcGxldGUgc2V0IG9mIG1vZGVsIGF0dHJpYnV0ZXMsCgkgICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gT3RoZXJ3aXNlLCBmaXJlIGFuIGAiaW52YWxpZCJgIGV2ZW50LgoJICAgIF92YWxpZGF0ZTogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKCSAgICAgIGlmICghb3B0aW9ucy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CgkgICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKCSAgICAgIHZhciBlcnJvciA9IHRoaXMudmFsaWRhdGlvbkVycm9yID0gdGhpcy52YWxpZGF0ZShhdHRycywgb3B0aW9ucykgfHwgbnVsbDsKCSAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOwoJICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgZXJyb3IsIF8uZXh0ZW5kKG9wdGlvbnMsIHt2YWxpZGF0aW9uRXJyb3I6IGVycm9yfSkpOwoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCgkgIH0pOwoKCSAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIE1vZGVsLgoJICB2YXIgbW9kZWxNZXRob2RzID0gWydrZXlzJywgJ3ZhbHVlcycsICdwYWlycycsICdpbnZlcnQnLCAncGljaycsICdvbWl0J107CgoJICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBNb2RlbCNhdHRyaWJ1dGVzYC4KCSAgXy5lYWNoKG1vZGVsTWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CgkgICAgTW9kZWwucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKCSAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwoJICAgICAgYXJncy51bnNoaWZ0KHRoaXMuYXR0cmlidXRlcyk7CgkgICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gQmFja2JvbmUuQ29sbGVjdGlvbgoJICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBJZiBtb2RlbHMgdGVuZCB0byByZXByZXNlbnQgYSBzaW5nbGUgcm93IG9mIGRhdGEsIGEgQmFja2JvbmUgQ29sbGVjdGlvbiBpcwoJICAvLyBtb3JlIGFuYWxhZ291cyB0byBhIHRhYmxlIGZ1bGwgb2YgZGF0YSAuLi4gb3IgYSBzbWFsbCBzbGljZSBvciBwYWdlIG9mIHRoYXQKCSAgLy8gdGFibGUsIG9yIGEgY29sbGVjdGlvbiBvZiByb3dzIHRoYXQgYmVsb25nIHRvZ2V0aGVyIGZvciBhIHBhcnRpY3VsYXIgcmVhc29uCgkgIC8vIC0tIGFsbCBvZiB0aGUgbWVzc2FnZXMgaW4gdGhpcyBwYXJ0aWN1bGFyIGZvbGRlciwgYWxsIG9mIHRoZSBkb2N1bWVudHMKCSAgLy8gYmVsb25naW5nIHRvIHRoaXMgcGFydGljdWxhciBhdXRob3IsIGFuZCBzbyBvbi4gQ29sbGVjdGlvbnMgbWFpbnRhaW4KCSAgLy8gaW5kZXhlcyBvZiB0aGVpciBtb2RlbHMsIGJvdGggaW4gb3JkZXIsIGFuZCBmb3IgbG9va3VwIGJ5IGBpZGAuCgoJICAvLyBDcmVhdGUgYSBuZXcgKipDb2xsZWN0aW9uKiosIHBlcmhhcHMgdG8gY29udGFpbiBhIHNwZWNpZmljIHR5cGUgb2YgYG1vZGVsYC4KCSAgLy8gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCgkgIC8vIGl0cyBtb2RlbHMgaW4gc29ydCBvcmRlciwgYXMgdGhleSdyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KCSAgdmFyIENvbGxlY3Rpb24gPSBCYWNrYm9uZS5Db2xsZWN0aW9uID0gZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CgkgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCSAgICBpZiAob3B0aW9ucy5tb2RlbCkgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7CgkgICAgaWYgKG9wdGlvbnMuY29tcGFyYXRvciAhPT0gdm9pZCAwKSB0aGlzLmNvbXBhcmF0b3IgPSBvcHRpb25zLmNvbXBhcmF0b3I7CgkgICAgdGhpcy5fcmVzZXQoKTsKCSAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICBpZiAobW9kZWxzKSB0aGlzLnJlc2V0KG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKCSAgfTsKCgkgIC8vIERlZmF1bHQgb3B0aW9ucyBmb3IgYENvbGxlY3Rpb24jc2V0YC4KCSAgdmFyIHNldE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IHRydWUsIG1lcmdlOiB0cnVlfTsKCSAgdmFyIGFkZE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IGZhbHNlfTsKCgkgIC8vIERlZmluZSB0aGUgQ29sbGVjdGlvbidzIGluaGVyaXRhYmxlIG1ldGhvZHMuCgkgIF8uZXh0ZW5kKENvbGxlY3Rpb24ucHJvdG90eXBlLCBFdmVudHMsIHsKCgkgICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgoJICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4KCSAgICBtb2RlbDogTW9kZWwsCgoJICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgoJICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgoJICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCgkgICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQoJICAgIC8vIG1vZGVscycgYXR0cmlidXRlcy4KCSAgICB0b0pTT046IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwoJICAgIH0sCgoJICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0LgoJICAgIHN5bmM6IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICB9LAoKCSAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4KCSAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewoJICAgICAgcmV0dXJuIHRoaXMuc2V0KG1vZGVscywgXy5leHRlbmQoe21lcmdlOiBmYWxzZX0sIG9wdGlvbnMsIGFkZE9wdGlvbnMpKTsKCSAgICB9LAoKCSAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuCgkgICAgcmVtb3ZlOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKCSAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKCSAgICAgIG1vZGVscyA9IHNpbmd1bGFyID8gW21vZGVsc10gOiBfLmNsb25lKG1vZGVscyk7CgkgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsKCSAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5nZXQobW9kZWxzW2ldKTsKCSAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CgkgICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKCSAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuY2lkXTsKCSAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwoJICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoaW5kZXgsIDEpOwoJICAgICAgICB0aGlzLmxlbmd0aC0tOwoJICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CgkgICAgICAgICAgb3B0aW9ucy5pbmRleCA9IGluZGV4OwoJICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlbW92ZScsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKCSAgICAgICAgfQoJICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UobW9kZWwsIG9wdGlvbnMpOwoJICAgICAgfQoJICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwoJICAgIH0sCgoJICAgIC8vIFVwZGF0ZSBhIGNvbGxlY3Rpb24gYnkgYHNldGAtaW5nIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCBhZGRpbmcgbmV3IG9uZXMsCgkgICAgLy8gcmVtb3ZpbmcgbW9kZWxzIHRoYXQgYXJlIG5vIGxvbmdlciBwcmVzZW50LCBhbmQgbWVyZ2luZyBtb2RlbHMgdGhhdAoJICAgIC8vIGFscmVhZHkgZXhpc3QgaW4gdGhlIGNvbGxlY3Rpb24sIGFzIG5lY2Vzc2FyeS4gU2ltaWxhciB0byAqKk1vZGVsI3NldCoqLAoJICAgIC8vIHRoZSBjb3JlIG9wZXJhdGlvbiBmb3IgdXBkYXRpbmcgdGhlIGRhdGEgY29udGFpbmVkIGJ5IHRoZSBjb2xsZWN0aW9uLgoJICAgIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CgkgICAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7fSwgb3B0aW9ucywgc2V0T3B0aW9ucyk7CgkgICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMsIG9wdGlvbnMpOwoJICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwoJICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyAobW9kZWxzID8gW21vZGVsc10gOiBbXSkgOiBfLmNsb25lKG1vZGVscyk7CgkgICAgICB2YXIgaSwgbCwgaWQsIG1vZGVsLCBhdHRycywgZXhpc3RpbmcsIHNvcnQ7CgkgICAgICB2YXIgYXQgPSBvcHRpb25zLmF0OwoJICAgICAgdmFyIHRhcmdldE1vZGVsID0gdGhpcy5tb2RlbDsKCSAgICAgIHZhciBzb3J0YWJsZSA9IHRoaXMuY29tcGFyYXRvciAmJiAoYXQgPT0gbnVsbCkgJiYgb3B0aW9ucy5zb3J0ICE9PSBmYWxzZTsKCSAgICAgIHZhciBzb3J0QXR0ciA9IF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSA/IHRoaXMuY29tcGFyYXRvciA6IG51bGw7CgkgICAgICB2YXIgdG9BZGQgPSBbXSwgdG9SZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKCSAgICAgIHZhciBhZGQgPSBvcHRpb25zLmFkZCwgbWVyZ2UgPSBvcHRpb25zLm1lcmdlLCByZW1vdmUgPSBvcHRpb25zLnJlbW92ZTsKCSAgICAgIHZhciBvcmRlciA9ICFzb3J0YWJsZSAmJiBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKCgkgICAgICAvLyBUdXJuIGJhcmUgb2JqZWN0cyBpbnRvIG1vZGVsIHJlZmVyZW5jZXMsIGFuZCBwcmV2ZW50IGludmFsaWQgbW9kZWxzCgkgICAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLgoJICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCSAgICAgICAgYXR0cnMgPSBtb2RlbHNbaV0gfHwge307CgkgICAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSB7CgkgICAgICAgICAgaWQgPSBtb2RlbCA9IGF0dHJzOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIGlkID0gYXR0cnNbdGFyZ2V0TW9kZWwucHJvdG90eXBlLmlkQXR0cmlidXRlIHx8ICdpZCddOwoJICAgICAgICB9CgoJICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAoJICAgICAgICAvLyBvcHRpb25hbGx5IG1lcmdlIGl0IGludG8gdGhlIGV4aXN0aW5nIG1vZGVsLgoJICAgICAgICBpZiAoZXhpc3RpbmcgPSB0aGlzLmdldChpZCkpIHsKCSAgICAgICAgICBpZiAocmVtb3ZlKSBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKCSAgICAgICAgICBpZiAobWVyZ2UpIHsKCSAgICAgICAgICAgIGF0dHJzID0gYXR0cnMgPT09IG1vZGVsID8gbW9kZWwuYXR0cmlidXRlcyA6IGF0dHJzOwoJICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gZXhpc3RpbmcucGFyc2UoYXR0cnMsIG9wdGlvbnMpOwoJICAgICAgICAgICAgZXhpc3Rpbmcuc2V0KGF0dHJzLCBvcHRpb25zKTsKCSAgICAgICAgICAgIGlmIChzb3J0YWJsZSAmJiAhc29ydCAmJiBleGlzdGluZy5oYXNDaGFuZ2VkKHNvcnRBdHRyKSkgc29ydCA9IHRydWU7CgkgICAgICAgICAgfQoJICAgICAgICAgIG1vZGVsc1tpXSA9IGV4aXN0aW5nOwoKCSAgICAgICAgLy8gSWYgdGhpcyBpcyBhIG5ldywgdmFsaWQgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KCSAgICAgICAgfSBlbHNlIGlmIChhZGQpIHsKCSAgICAgICAgICBtb2RlbCA9IG1vZGVsc1tpXSA9IHRoaXMuX3ByZXBhcmVNb2RlbChhdHRycywgb3B0aW9ucyk7CgkgICAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CgkgICAgICAgICAgdG9BZGQucHVzaChtb2RlbCk7CgkgICAgICAgICAgdGhpcy5fYWRkUmVmZXJlbmNlKG1vZGVsLCBvcHRpb25zKTsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gRG8gbm90IGFkZCBtdWx0aXBsZSBtb2RlbHMgd2l0aCB0aGUgc2FtZSBgaWRgLgoJICAgICAgICBtb2RlbCA9IGV4aXN0aW5nIHx8IG1vZGVsOwoJICAgICAgICBpZiAob3JkZXIgJiYgKG1vZGVsLmlzTmV3KCkgfHwgIW1vZGVsTWFwW21vZGVsLmlkXSkpIG9yZGVyLnB1c2gobW9kZWwpOwoJICAgICAgICBtb2RlbE1hcFttb2RlbC5pZF0gPSB0cnVlOwoJICAgICAgfQoKCSAgICAgIC8vIFJlbW92ZSBub25leGlzdGVudCBtb2RlbHMgaWYgYXBwcm9wcmlhdGUuCgkgICAgICBpZiAocmVtb3ZlKSB7CgkgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7ICsraSkgewoJICAgICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwoJICAgICAgICB9CgkgICAgICAgIGlmICh0b1JlbW92ZS5sZW5ndGgpIHRoaXMucmVtb3ZlKHRvUmVtb3ZlLCBvcHRpb25zKTsKCSAgICAgIH0KCgkgICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCgkgICAgICBpZiAodG9BZGQubGVuZ3RoIHx8IChvcmRlciAmJiBvcmRlci5sZW5ndGgpKSB7CgkgICAgICAgIGlmIChzb3J0YWJsZSkgc29ydCA9IHRydWU7CgkgICAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKCSAgICAgICAgaWYgKGF0ICE9IG51bGwpIHsKCSAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoYXQgKyBpLCAwLCB0b0FkZFtpXSk7CgkgICAgICAgICAgfQoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIGlmIChvcmRlcikgdGhpcy5tb2RlbHMubGVuZ3RoID0gMDsKCSAgICAgICAgICB2YXIgb3JkZXJlZE1vZGVscyA9IG9yZGVyIHx8IHRvQWRkOwoJICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBvcmRlcmVkTW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJICAgICAgICAgICAgdGhpcy5tb2RlbHMucHVzaChvcmRlcmVkTW9kZWxzW2ldKTsKCSAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgIH0KCgkgICAgICAvLyBTaWxlbnRseSBzb3J0IHRoZSBjb2xsZWN0aW9uIGlmIGFwcHJvcHJpYXRlLgoJICAgICAgaWYgKHNvcnQpIHRoaXMuc29ydCh7c2lsZW50OiB0cnVlfSk7CgoJICAgICAgLy8gVW5sZXNzIHNpbGVuY2VkLCBpdCdzIHRpbWUgdG8gZmlyZSBhbGwgYXBwcm9wcmlhdGUgYWRkL3NvcnQgZXZlbnRzLgoJICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewoJICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKCSAgICAgICAgfQoJICAgICAgICBpZiAoc29ydCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CgkgICAgICB9CgoJICAgICAgLy8gUmV0dXJuIHRoZSBhZGRlZCAob3IgbWVyZ2VkKSBtb2RlbCAob3IgbW9kZWxzKS4KCSAgICAgIHJldHVybiBzaW5ndWxhciA/IG1vZGVsc1swXSA6IG1vZGVsczsKCSAgICB9LAoKCSAgICAvLyBXaGVuIHlvdSBoYXZlIG1vcmUgaXRlbXMgdGhhbiB5b3Ugd2FudCB0byBhZGQgb3IgcmVtb3ZlIGluZGl2aWR1YWxseSwKCSAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCgkgICAgLy8gYW55IGdyYW51bGFyIGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgoJICAgIC8vIFVzZWZ1bCBmb3IgYnVsayBvcGVyYXRpb25zIGFuZCBvcHRpbWl6YXRpb25zLgoJICAgIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0sIG9wdGlvbnMpOwoJICAgICAgfQoJICAgICAgb3B0aW9ucy5wcmV2aW91c01vZGVscyA9IHRoaXMubW9kZWxzOwoJICAgICAgdGhpcy5fcmVzZXQoKTsKCSAgICAgIG1vZGVscyA9IHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKCSAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcigncmVzZXQnLCB0aGlzLCBvcHRpb25zKTsKCSAgICAgIHJldHVybiBtb2RlbHM7CgkgICAgfSwKCgkgICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KCSAgICBwdXNoOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewoJICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IHRoaXMubGVuZ3RofSwgb3B0aW9ucykpOwoJICAgIH0sCgoJICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KCSAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQodGhpcy5sZW5ndGggLSAxKTsKCSAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKCSAgICAgIHJldHVybiBtb2RlbDsKCSAgICB9LAoKCSAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgoJICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkgICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogMH0sIG9wdGlvbnMpKTsKCSAgICB9LAoKCSAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCgkgICAgc2hpZnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CgkgICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CgkgICAgICByZXR1cm4gbW9kZWw7CgkgICAgfSwKCgkgICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgoJICAgIHNsaWNlOiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBzbGljZS5hcHBseSh0aGlzLm1vZGVscywgYXJndW1lbnRzKTsKCSAgICB9LAoKCSAgICAvLyBHZXQgYSBtb2RlbCBmcm9tIHRoZSBzZXQgYnkgaWQuCgkgICAgZ2V0OiBmdW5jdGlvbihvYmopIHsKCSAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKCSAgICAgIHJldHVybiB0aGlzLl9ieUlkW29ial0gfHwgdGhpcy5fYnlJZFtvYmouaWRdIHx8IHRoaXMuX2J5SWRbb2JqLmNpZF07CgkgICAgfSwKCgkgICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCgkgICAgYXQ6IGZ1bmN0aW9uKGluZGV4KSB7CgkgICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwoJICAgIH0sCgoJICAgIC8vIFJldHVybiBtb2RlbHMgd2l0aCBtYXRjaGluZyBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIHNpbXBsZSBjYXNlcyBvZgoJICAgIC8vIGBmaWx0ZXJgLgoJICAgIHdoZXJlOiBmdW5jdGlvbihhdHRycywgZmlyc3QpIHsKCSAgICAgIGlmIChfLmlzRW1wdHkoYXR0cnMpKSByZXR1cm4gZmlyc3QgPyB2b2lkIDAgOiBbXTsKCSAgICAgIHJldHVybiB0aGlzW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewoJICAgICAgICAgIGlmIChhdHRyc1trZXldICE9PSBtb2RlbC5nZXQoa2V5KSkgcmV0dXJuIGZhbHNlOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgICAgfSk7CgkgICAgfSwKCgkgICAgLy8gUmV0dXJuIHRoZSBmaXJzdCBtb2RlbCB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzCgkgICAgLy8gb2YgYGZpbmRgLgoJICAgIGZpbmRXaGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKCSAgICAgIHJldHVybiB0aGlzLndoZXJlKGF0dHJzLCB0cnVlKTsKCSAgICB9LAoKCSAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCgkgICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQoJICAgIC8vIGlzIGFkZGVkLgoJICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIGlmICghdGhpcy5jb21wYXJhdG9yKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CgkgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoKCSAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgoJICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CgkgICAgICAgIHRoaXMubW9kZWxzID0gdGhpcy5zb3J0QnkodGhpcy5jb21wYXJhdG9yLCB0aGlzKTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHRoaXMubW9kZWxzLnNvcnQoXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcykpOwoJICAgICAgfQoKCSAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KCSAgICBwbHVjazogZnVuY3Rpb24oYXR0cikgewoJICAgICAgcmV0dXJuIF8uaW52b2tlKHRoaXMubW9kZWxzLCAnZ2V0JywgYXR0cik7CgkgICAgfSwKCgkgICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlCgkgICAgLy8gY29sbGVjdGlvbiB3aGVuIHRoZXkgYXJyaXZlLiBJZiBgcmVzZXQ6IHRydWVgIGlzIHBhc3NlZCwgdGhlIHJlc3BvbnNlCgkgICAgLy8gZGF0YSB3aWxsIGJlIHBhc3NlZCB0aHJvdWdoIHRoZSBgcmVzZXRgIG1ldGhvZCBpbnN0ZWFkIG9mIGBzZXRgLgoJICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKCSAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwoJICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgkgICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CgkgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CgkgICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlc2V0ID8gJ3Jlc2V0JyA6ICdzZXQnOwoJICAgICAgICBjb2xsZWN0aW9uW21ldGhvZF0ocmVzcCwgb3B0aW9ucyk7CgkgICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgICBjb2xsZWN0aW9uLnRyaWdnZXIoJ3N5bmMnLCBjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKCSAgICAgIH07CgkgICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgkgICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CgkgICAgfSwKCgkgICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgbW9kZWwgaW4gdGhpcyBjb2xsZWN0aW9uLiBBZGQgdGhlIG1vZGVsIHRvIHRoZQoJICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCgkgICAgLy8gd2FpdCBmb3IgdGhlIHNlcnZlciB0byBhZ3JlZS4KCSAgICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKCSAgICAgIGlmICghKG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKSkpIHJldHVybiBmYWxzZTsKCSAgICAgIGlmICghb3B0aW9ucy53YWl0KSB0aGlzLmFkZChtb2RlbCwgb3B0aW9ucyk7CgkgICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CgkgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCSAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKG1vZGVsLCByZXNwKSB7CgkgICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKCSAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgfTsKCSAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CgkgICAgICByZXR1cm4gbW9kZWw7CgkgICAgfSwKCgkgICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQoJICAgIC8vIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyBpdCB0aHJvdWdoLgoJICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CgkgICAgICByZXR1cm4gcmVzcDsKCSAgICB9LAoKCSAgICAvLyBDcmVhdGUgYSBuZXcgY29sbGVjdGlvbiB3aXRoIGFuIGlkZW50aWNhbCBsaXN0IG9mIG1vZGVscyBhcyB0aGlzIG9uZS4KCSAgICBjbG9uZTogZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5tb2RlbHMpOwoJICAgIH0sCgoJICAgIC8vIFByaXZhdGUgbWV0aG9kIHRvIHJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24KCSAgICAvLyBpcyBmaXJzdCBpbml0aWFsaXplZCBvciByZXNldC4KCSAgICBfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJICAgICAgdGhpcy5sZW5ndGggPSAwOwoJICAgICAgdGhpcy5tb2RlbHMgPSBbXTsKCSAgICAgIHRoaXMuX2J5SWQgID0ge307CgkgICAgfSwKCgkgICAgLy8gUHJlcGFyZSBhIGhhc2ggb2YgYXR0cmlidXRlcyAob3Igb3RoZXIgbW9kZWwpIHRvIGJlIGFkZGVkIHRvIHRoaXMKCSAgICAvLyBjb2xsZWN0aW9uLgoJICAgIF9wcmVwYXJlTW9kZWw6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CgkgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgcmV0dXJuIGF0dHJzOwoJICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CgkgICAgICBvcHRpb25zLmNvbGxlY3Rpb24gPSB0aGlzOwoJICAgICAgdmFyIG1vZGVsID0gbmV3IHRoaXMubW9kZWwoYXR0cnMsIG9wdGlvbnMpOwoJICAgICAgaWYgKCFtb2RlbC52YWxpZGF0aW9uRXJyb3IpIHJldHVybiBtb2RlbDsKCSAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIHRoaXMsIG1vZGVsLnZhbGlkYXRpb25FcnJvciwgb3B0aW9ucyk7CgkgICAgICByZXR1cm4gZmFsc2U7CgkgICAgfSwKCgkgICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGNyZWF0ZSBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCgkgICAgX2FkZFJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKCSAgICAgIHRoaXMuX2J5SWRbbW9kZWwuY2lkXSA9IG1vZGVsOwoJICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CgkgICAgICBpZiAoIW1vZGVsLmNvbGxlY3Rpb24pIG1vZGVsLmNvbGxlY3Rpb24gPSB0aGlzOwoJICAgICAgbW9kZWwub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CgkgICAgfSwKCgkgICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNldmVyIGEgbW9kZWwncyB0aWVzIHRvIGEgY29sbGVjdGlvbi4KCSAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewoJICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwoJICAgICAgbW9kZWwub2ZmKCdhbGwnLCB0aGlzLl9vbk1vZGVsRXZlbnQsIHRoaXMpOwoJICAgIH0sCgoJICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCgkgICAgLy8gU2V0cyBuZWVkIHRvIHVwZGF0ZSB0aGVpciBpbmRleGVzIHdoZW4gbW9kZWxzIGNoYW5nZSBpZHMuIEFsbCBvdGhlcgoJICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQoJICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgoJICAgIF9vbk1vZGVsRXZlbnQ6IGZ1bmN0aW9uKGV2ZW50LCBtb2RlbCwgY29sbGVjdGlvbiwgb3B0aW9ucykgewoJICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CgkgICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwoJICAgICAgaWYgKG1vZGVsICYmIGV2ZW50ID09PSAnY2hhbmdlOicgKyBtb2RlbC5pZEF0dHJpYnV0ZSkgewoJICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwoJICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKCSAgICAgIH0KCSAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgIH0KCgkgIH0pOwoKCSAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCgkgIC8vIDkwJSBvZiB0aGUgY29yZSB1c2VmdWxuZXNzIG9mIEJhY2tib25lIENvbGxlY3Rpb25zIGlzIGFjdHVhbGx5IGltcGxlbWVudGVkCgkgIC8vIHJpZ2h0IGhlcmU6CgkgIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2ZvbGRsJywKCSAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLAoJICAgICdyZWplY3QnLCAnZXZlcnknLCAnYWxsJywgJ3NvbWUnLCAnYW55JywgJ2luY2x1ZGUnLCAnY29udGFpbnMnLCAnaW52b2tlJywKCSAgICAnbWF4JywgJ21pbicsICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaGVhZCcsICd0YWtlJywgJ2luaXRpYWwnLCAncmVzdCcsCgkgICAgJ3RhaWwnLCAnZHJvcCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnZGlmZmVyZW5jZScsICdpbmRleE9mJywgJ3NodWZmbGUnLAoJICAgICdsYXN0SW5kZXhPZicsICdpc0VtcHR5JywgJ2NoYWluJywgJ3NhbXBsZSddOwoKCSAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgoJICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CgkgICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CgkgICAgICBhcmdzLnVuc2hpZnQodGhpcy5tb2RlbHMpOwoJICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKCSAgICB9OwoJICB9KTsKCgkgIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHRha2UgYSBwcm9wZXJ0eSBuYW1lIGFzIGFuIGFyZ3VtZW50LgoJICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeScsICdpbmRleEJ5J107CgoJICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCgkgIF8uZWFjaChhdHRyaWJ1dGVNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKCSAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24odmFsdWUsIGNvbnRleHQpIHsKCSAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOwoJICAgICAgfTsKCSAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKCSAgICB9OwoJICB9KTsKCgkgIC8vIEJhY2tib25lLlZpZXcKCSAgLy8gLS0tLS0tLS0tLS0tLQoKCSAgLy8gQmFja2JvbmUgVmlld3MgYXJlIGFsbW9zdCBtb3JlIGNvbnZlbnRpb24gdGhhbiB0aGV5IGFyZSBhY3R1YWwgY29kZS4gQSBWaWV3CgkgIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCgkgIC8vIERPTS4gVGhpcyBtaWdodCBiZSBhIHNpbmdsZSBpdGVtLCBhbiBlbnRpcmUgbGlzdCwgYSBzaWRlYmFyIG9yIHBhbmVsLCBvcgoJICAvLyBldmVuIHRoZSBzdXJyb3VuZGluZyBmcmFtZSB3aGljaCB3cmFwcyB5b3VyIHdob2xlIGFwcC4gRGVmaW5pbmcgYSBjaHVuayBvZgoJICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CgkgIC8vIGhhdmluZyB0byB3b3JyeSBhYm91dCByZW5kZXIgb3JkZXIgLi4uIGFuZCBtYWtlcyBpdCBlYXN5IGZvciB0aGUgdmlldyB0bwoJICAvLyByZWFjdCB0byBzcGVjaWZpYyBjaGFuZ2VzIGluIHRoZSBzdGF0ZSBvZiB5b3VyIG1vZGVscy4KCgkgIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAoJICAvLyBpZiBhbiBleGlzdGluZyBlbGVtZW50IGlzIG5vdCBwcm92aWRlZC4uLgoJICB2YXIgVmlldyA9IEJhY2tib25lLlZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CgkgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCSAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgdmlld09wdGlvbnMpKTsKCSAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CgkgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwoJICB9OwoKCSAgLy8gQ2FjaGVkIHJlZ2V4IHRvIHNwbGl0IGtleXMgZm9yIGBkZWxlZ2F0ZWAuCgkgIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwoKCSAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCgkgIHZhciB2aWV3T3B0aW9ucyA9IFsnbW9kZWwnLCAnY29sbGVjdGlvbicsICdlbCcsICdpZCcsICdhdHRyaWJ1dGVzJywgJ2NsYXNzTmFtZScsICd0YWdOYW1lJywgJ2V2ZW50cyddOwoKCSAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlZpZXcqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgoJICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgoJICAgIC8vIFRoZSBkZWZhdWx0IGB0YWdOYW1lYCBvZiBhIFZpZXcncyBlbGVtZW50IGlzIGAiZGl2ImAuCgkgICAgdGFnTmFtZTogJ2RpdicsCgoJICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQoJICAgIC8vIGN1cnJlbnQgdmlldy4gVGhpcyBzaG91bGQgYmUgcHJlZmVycmVkIHRvIGdsb2JhbCBsb29rdXBzIHdoZXJlIHBvc3NpYmxlLgoJICAgICQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CgkgICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CgkgICAgfSwKCgkgICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCgkgICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCgkgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKCSAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKCSAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCgkgICAgLy8gY29udmVudGlvbiBpcyBmb3IgKipyZW5kZXIqKiB0byBhbHdheXMgcmV0dXJuIGB0aGlzYC4KCSAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBieSB0YWtpbmcgdGhlIGVsZW1lbnQgb3V0IG9mIHRoZSBET00sIGFuZCByZW1vdmluZyBhbnkKCSAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCgkgICAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKCSAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwoJICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKCSAgICAvLyByZS1kZWxlZ2F0aW9uLgoJICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGRlbGVnYXRlKSB7CgkgICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwoJICAgICAgdGhpcy4kZWwgPSBlbGVtZW50IGluc3RhbmNlb2YgQmFja2JvbmUuJCA/IGVsZW1lbnQgOiBCYWNrYm9uZS4kKGVsZW1lbnQpOwoJICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsWzBdOwoJICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKCSAgICAvLwoJICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCgkgICAgLy8KCSAgICAvLyAgICAgewoJICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKCSAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScsCgkgICAgLy8gICAgICAgJ2NsaWNrIC5vcGVuJzogICAgICAgZnVuY3Rpb24oZSkgeyAuLi4gfQoJICAgIC8vICAgICB9CgkgICAgLy8KCSAgICAvLyBwYWlycy4gQ2FsbGJhY2tzIHdpbGwgYmUgYm91bmQgdG8gdGhlIHZpZXcsIHdpdGggYHRoaXNgIHNldCBwcm9wZXJseS4KCSAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCgkgICAgLy8gT21pdHRpbmcgdGhlIHNlbGVjdG9yIGJpbmRzIHRoZSBldmVudCB0byBgdGhpcy5lbGAuCgkgICAgLy8gVGhpcyBvbmx5IHdvcmtzIGZvciBkZWxlZ2F0ZS1hYmxlIGV2ZW50czogbm90IGBmb2N1c2AsIGBibHVyYCwgYW5kCgkgICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCgkgICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewoJICAgICAgaWYgKCEoZXZlbnRzIHx8IChldmVudHMgPSBfLnJlc3VsdCh0aGlzLCAnZXZlbnRzJykpKSkgcmV0dXJuIHRoaXM7CgkgICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKCSAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKCSAgICAgICAgdmFyIG1ldGhvZCA9IGV2ZW50c1trZXldOwoJICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsKCSAgICAgICAgaWYgKCFtZXRob2QpIGNvbnRpbnVlOwoKCSAgICAgICAgdmFyIG1hdGNoID0ga2V5Lm1hdGNoKGRlbGVnYXRlRXZlbnRTcGxpdHRlcik7CgkgICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKCSAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CgkgICAgICAgIGV2ZW50TmFtZSArPSAnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkOwoJICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CgkgICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBtZXRob2QpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgc2VsZWN0b3IsIG1ldGhvZCk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIENsZWFycyBhbGwgY2FsbGJhY2tzIHByZXZpb3VzbHkgYm91bmQgdG8gdGhlIHZpZXcgd2l0aCBgZGVsZWdhdGVFdmVudHNgLgoJICAgIC8vIFlvdSB1c3VhbGx5IGRvbid0IG5lZWQgdG8gdXNlIHRoaXMsIGJ1dCBtYXkgd2lzaCB0byBpZiB5b3UgaGF2ZSBtdWx0aXBsZQoJICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgoJICAgIHVuZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKCkgewoJICAgICAgdGhpcy4kZWwub2ZmKCcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQpOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gRW5zdXJlIHRoYXQgdGhlIFZpZXcgaGFzIGEgRE9NIGVsZW1lbnQgdG8gcmVuZGVyIGludG8uCgkgICAgLy8gSWYgYHRoaXMuZWxgIGlzIGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggYCQoKWAsIHRha2UgdGhlIGZpcnN0CgkgICAgLy8gbWF0Y2hpbmcgZWxlbWVudCwgYW5kIHJlLWFzc2lnbiBpdCB0byBgZWxgLiBPdGhlcndpc2UsIGNyZWF0ZQoJICAgIC8vIGFuIGVsZW1lbnQgZnJvbSB0aGUgYGlkYCwgYGNsYXNzTmFtZWAgYW5kIGB0YWdOYW1lYCBwcm9wZXJ0aWVzLgoJICAgIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKCSAgICAgIGlmICghdGhpcy5lbCkgewoJICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ2F0dHJpYnV0ZXMnKSk7CgkgICAgICAgIGlmICh0aGlzLmlkKSBhdHRycy5pZCA9IF8ucmVzdWx0KHRoaXMsICdpZCcpOwoJICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwoJICAgICAgICB2YXIgJGVsID0gQmFja2JvbmUuJCgnPCcgKyBfLnJlc3VsdCh0aGlzLCAndGFnTmFtZScpICsgJz4nKS5hdHRyKGF0dHJzKTsKCSAgICAgICAgdGhpcy5zZXRFbGVtZW50KCRlbCwgZmFsc2UpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CgkgICAgICB9CgkgICAgfQoKCSAgfSk7CgoJICAvLyBCYWNrYm9uZS5zeW5jCgkgIC8vIC0tLS0tLS0tLS0tLS0KCgkgIC8vIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBtYW5uZXIgaW4gd2hpY2ggQmFja2JvbmUgcGVyc2lzdHMKCSAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCgkgIC8vIG1vZGVsIGluIHF1ZXN0aW9uLiBCeSBkZWZhdWx0LCBtYWtlcyBhIFJFU1RmdWwgQWpheCByZXF1ZXN0CgkgIC8vIHRvIHRoZSBtb2RlbCdzIGB1cmwoKWAuIFNvbWUgcG9zc2libGUgY3VzdG9taXphdGlvbnMgY291bGQgYmU6CgkgIC8vCgkgIC8vICogVXNlIGBzZXRUaW1lb3V0YCB0byBiYXRjaCByYXBpZC1maXJlIHVwZGF0ZXMgaW50byBhIHNpbmdsZSByZXF1ZXN0LgoJICAvLyAqIFNlbmQgdXAgdGhlIG1vZGVscyBhcyBYTUwgaW5zdGVhZCBvZiBKU09OLgoJICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KCSAgLy8KCSAgLy8gVHVybiBvbiBgQmFja2JvbmUuZW11bGF0ZUhUVFBgIGluIG9yZGVyIHRvIHNlbmQgYFBVVGAgYW5kIGBERUxFVEVgIHJlcXVlc3RzCgkgIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKCSAgLy8gYXMgd2VsbCBhcyBhbGwgcmVxdWVzdHMgd2l0aCB0aGUgYm9keSBhcyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYAoJICAvLyBpbnN0ZWFkIG9mIGBhcHBsaWNhdGlvbi9qc29uYCB3aXRoIHRoZSBtb2RlbCBpbiBhIHBhcmFtIG5hbWVkIGBtb2RlbGAuCgkgIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKCSAgLy8gaXQgZGlmZmljdWx0IHRvIHJlYWQgdGhlIGJvZHkgb2YgYFBVVGAgcmVxdWVzdHMuCgkgIEJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CgkgICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCgkgICAgLy8gRGVmYXVsdCBvcHRpb25zLCB1bmxlc3Mgc3BlY2lmaWVkLgoJICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgewoJICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAoJICAgICAgZW11bGF0ZUpTT046IEJhY2tib25lLmVtdWxhdGVKU09OCgkgICAgfSk7CgoJICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCgkgICAgdmFyIHBhcmFtcyA9IHt0eXBlOiB0eXBlLCBkYXRhVHlwZTogJ2pzb24nfTsKCgkgICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4KCSAgICBpZiAoIW9wdGlvbnMudXJsKSB7CgkgICAgICBwYXJhbXMudXJsID0gXy5yZXN1bHQobW9kZWwsICd1cmwnKSB8fCB1cmxFcnJvcigpOwoJICAgIH0KCgkgICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgoJICAgIGlmIChvcHRpb25zLmRhdGEgPT0gbnVsbCAmJiBtb2RlbCAmJiAobWV0aG9kID09PSAnY3JlYXRlJyB8fCBtZXRob2QgPT09ICd1cGRhdGUnIHx8IG1ldGhvZCA9PT0gJ3BhdGNoJykpIHsKCSAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKCSAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwoJICAgIH0KCgkgICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSlNPTiBieSBlbmNvZGluZyB0aGUgcmVxdWVzdCBpbnRvIGFuIEhUTUwtZm9ybS4KCSAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewoJICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCc7CgkgICAgICBwYXJhbXMuZGF0YSA9IHBhcmFtcy5kYXRhID8ge21vZGVsOiBwYXJhbXMuZGF0YX0gOiB7fTsKCSAgICB9CgoJICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEhUVFAgYnkgbWltaWNraW5nIHRoZSBIVFRQIG1ldGhvZCB3aXRoIGBfbWV0aG9kYAoJICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgoJICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewoJICAgICAgcGFyYW1zLnR5cGUgPSAnUE9TVCc7CgkgICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgcGFyYW1zLmRhdGEuX21ldGhvZCA9IHR5cGU7CgkgICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKCSAgICAgIG9wdGlvbnMuYmVmb3JlU2VuZCA9IGZ1bmN0aW9uKHhocikgewoJICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwoJICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgIH07CgkgICAgfQoKCSAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCgkgICAgaWYgKHBhcmFtcy50eXBlICE9PSAnR0VUJyAmJiAhb3B0aW9ucy5lbXVsYXRlSlNPTikgewoJICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7CgkgICAgfQoKCSAgICAvLyBJZiB3ZSdyZSBzZW5kaW5nIGEgYFBBVENIYCByZXF1ZXN0LCBhbmQgd2UncmUgaW4gYW4gb2xkIEludGVybmV0IEV4cGxvcmVyCgkgICAgLy8gdGhhdCBzdGlsbCBoYXMgQWN0aXZlWCBlbmFibGVkIGJ5IGRlZmF1bHQsIG92ZXJyaWRlIGpRdWVyeSB0byB1c2UgdGhhdAoJICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KCSAgICBpZiAocGFyYW1zLnR5cGUgPT09ICdQQVRDSCcgJiYgbm9YaHJQYXRjaCkgewoJICAgICAgcGFyYW1zLnhociA9IGZ1bmN0aW9uKCkgewoJICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CgkgICAgICB9OwoJICAgIH0KCgkgICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KCSAgICB2YXIgeGhyID0gb3B0aW9ucy54aHIgPSBCYWNrYm9uZS5hamF4KF8uZXh0ZW5kKHBhcmFtcywgb3B0aW9ucykpOwoJICAgIG1vZGVsLnRyaWdnZXIoJ3JlcXVlc3QnLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKCSAgICByZXR1cm4geGhyOwoJICB9OwoKCSAgdmFyIG5vWGhyUGF0Y2ggPQoJICAgIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmICEhd2luZG93LkFjdGl2ZVhPYmplY3QgJiYKCSAgICAgICEod2luZG93LlhNTEh0dHBSZXF1ZXN0ICYmIChuZXcgWE1MSHR0cFJlcXVlc3QpLmRpc3BhdGNoRXZlbnQpOwoKCSAgLy8gTWFwIGZyb20gQ1JVRCB0byBIVFRQIGZvciBvdXIgZGVmYXVsdCBgQmFja2JvbmUuc3luY2AgaW1wbGVtZW50YXRpb24uCgkgIHZhciBtZXRob2RNYXAgPSB7CgkgICAgJ2NyZWF0ZSc6ICdQT1NUJywKCSAgICAndXBkYXRlJzogJ1BVVCcsCgkgICAgJ3BhdGNoJzogICdQQVRDSCcsCgkgICAgJ2RlbGV0ZSc6ICdERUxFVEUnLAoJICAgICdyZWFkJzogICAnR0VUJwoJICB9OwoKCSAgLy8gU2V0IHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIGBCYWNrYm9uZS5hamF4YCB0byBwcm94eSB0aHJvdWdoIHRvIGAkYC4KCSAgLy8gT3ZlcnJpZGUgdGhpcyBpZiB5b3UnZCBsaWtlIHRvIHVzZSBhIGRpZmZlcmVudCBsaWJyYXJ5LgoJICBCYWNrYm9uZS5hamF4ID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIEJhY2tib25lLiQuYWpheC5hcHBseShCYWNrYm9uZS4kLCBhcmd1bWVudHMpOwoJICB9OwoKCSAgLy8gQmFja2JvbmUuUm91dGVyCgkgIC8vIC0tLS0tLS0tLS0tLS0tLQoKCSAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKCSAgLy8gbWF0Y2hlZC4gQ3JlYXRpbmcgYSBuZXcgb25lIHNldHMgaXRzIGByb3V0ZXNgIGhhc2gsIGlmIG5vdCBzZXQgc3RhdGljYWxseS4KCSAgdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgIGlmIChvcHRpb25zLnJvdXRlcykgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsKCSAgICB0aGlzLl9iaW5kUm91dGVzKCk7CgkgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgIH07CgoJICAvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkCgkgIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCgkgIHZhciBvcHRpb25hbFBhcmFtID0gL1woKC4qPylcKS9nOwoJICB2YXIgbmFtZWRQYXJhbSAgICA9IC8oXChcPyk/Olx3Ky9nOwoJICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwoJICB2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKCSAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlJvdXRlcioqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCgkgIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKCSAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KCSAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KCSAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgoJICAgIC8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CgkgICAgLy8KCSAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CgkgICAgLy8gICAgICAgLi4uCgkgICAgLy8gICAgIH0pOwoJICAgIC8vCgkgICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewoJICAgICAgaWYgKCFfLmlzUmVnRXhwKHJvdXRlKSkgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsKCSAgICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKCSAgICAgICAgY2FsbGJhY2sgPSBuYW1lOwoJICAgICAgICBuYW1lID0gJyc7CgkgICAgICB9CgkgICAgICBpZiAoIWNhbGxiYWNrKSBjYWxsYmFjayA9IHRoaXNbbmFtZV07CgkgICAgICB2YXIgcm91dGVyID0gdGhpczsKCSAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIGZ1bmN0aW9uKGZyYWdtZW50KSB7CgkgICAgICAgIHZhciBhcmdzID0gcm91dGVyLl9leHRyYWN0UGFyYW1ldGVycyhyb3V0ZSwgZnJhZ21lbnQpOwoJICAgICAgICByb3V0ZXIuZXhlY3V0ZShjYWxsYmFjaywgYXJncyk7CgkgICAgICAgIHJvdXRlci50cmlnZ2VyLmFwcGx5KHJvdXRlciwgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKCSAgICAgICAgcm91dGVyLnRyaWdnZXIoJ3JvdXRlJywgbmFtZSwgYXJncyk7CgkgICAgICAgIEJhY2tib25lLmhpc3RvcnkudHJpZ2dlcigncm91dGUnLCByb3V0ZXIsIG5hbWUsIGFyZ3MpOwoJICAgICAgfSk7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBFeGVjdXRlIGEgcm91dGUgaGFuZGxlciB3aXRoIHRoZSBwcm92aWRlZCBwYXJhbWV0ZXJzLiAgVGhpcyBpcyBhbgoJICAgIC8vIGV4Y2VsbGVudCBwbGFjZSB0byBkbyBwcmUtcm91dGUgc2V0dXAgb3IgcG9zdC1yb3V0ZSBjbGVhbnVwLgoJICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKGNhbGxiYWNrLCBhcmdzKSB7CgkgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwoJICAgIH0sCgoJICAgIC8vIFNpbXBsZSBwcm94eSB0byBgQmFja2JvbmUuaGlzdG9yeWAgdG8gc2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhpc3RvcnkuCgkgICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CgkgICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIEJpbmQgYWxsIGRlZmluZWQgcm91dGVzIHRvIGBCYWNrYm9uZS5oaXN0b3J5YC4gV2UgaGF2ZSB0byByZXZlcnNlIHRoZQoJICAgIC8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwKCSAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgoJICAgIF9iaW5kUm91dGVzOiBmdW5jdGlvbigpIHsKCSAgICAgIGlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsKCSAgICAgIHRoaXMucm91dGVzID0gXy5yZXN1bHQodGhpcywgJ3JvdXRlcycpOwoJICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwoJICAgICAgd2hpbGUgKChyb3V0ZSA9IHJvdXRlcy5wb3AoKSkgIT0gbnVsbCkgewoJICAgICAgICB0aGlzLnJvdXRlKHJvdXRlLCB0aGlzLnJvdXRlc1tyb3V0ZV0pOwoJICAgICAgfQoJICAgIH0sCgoJICAgIC8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nCgkgICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgoJICAgIF9yb3V0ZVRvUmVnRXhwOiBmdW5jdGlvbihyb3V0ZSkgewoJICAgICAgcm91dGUgPSByb3V0ZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKQoJICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKCSAgICAgICAgICAgICAgICAgICAucmVwbGFjZShuYW1lZFBhcmFtLCBmdW5jdGlvbihtYXRjaCwgb3B0aW9uYWwpIHsKCSAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXi8/XSspJzsKCSAgICAgICAgICAgICAgICAgICB9KQoJICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKHNwbGF0UGFyYW0sICcoW14/XSo/KScpOwoJICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnKD86XFw/KFtcXHNcXFNdKikpPyQnKTsKCSAgICB9LAoKCSAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCgkgICAgLy8gZXh0cmFjdGVkIGRlY29kZWQgcGFyYW1ldGVycy4gRW1wdHkgb3IgdW5tYXRjaGVkIHBhcmFtZXRlcnMgd2lsbCBiZQoJICAgIC8vIHRyZWF0ZWQgYXMgYG51bGxgIHRvIG5vcm1hbGl6ZSBjcm9zcy1icm93c2VyIGJlaGF2aW9yLgoJICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24ocm91dGUsIGZyYWdtZW50KSB7CgkgICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CgkgICAgICByZXR1cm4gXy5tYXAocGFyYW1zLCBmdW5jdGlvbihwYXJhbSwgaSkgewoJICAgICAgICAvLyBEb24ndCBkZWNvZGUgdGhlIHNlYXJjaCBwYXJhbXMuCgkgICAgICAgIGlmIChpID09PSBwYXJhbXMubGVuZ3RoIC0gMSkgcmV0dXJuIHBhcmFtIHx8IG51bGw7CgkgICAgICAgIHJldHVybiBwYXJhbSA/IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbSkgOiBudWxsOwoJICAgICAgfSk7CgkgICAgfQoKCSAgfSk7CgoJICAvLyBCYWNrYm9uZS5IaXN0b3J5CgkgIC8vIC0tLS0tLS0tLS0tLS0tLS0KCgkgIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIGVpdGhlcgoJICAvLyBbcHVzaFN0YXRlXShodHRwOi8vZGl2ZWludG9odG1sNS5pbmZvL2hpc3RvcnkuaHRtbCkgYW5kIHJlYWwgVVJMcywgb3IKCSAgLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKCSAgLy8gYW5kIFVSTCBmcmFnbWVudHMuIElmIHRoZSBicm93c2VyIHN1cHBvcnRzIG5laXRoZXIgKG9sZCBJRSwgbmF0Y2gpLAoJICAvLyBmYWxscyBiYWNrIHRvIHBvbGxpbmcuCgkgIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewoJICAgIHRoaXMuaGFuZGxlcnMgPSBbXTsKCSAgICBfLmJpbmRBbGwodGhpcywgJ2NoZWNrVXJsJyk7CgoJICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgoJICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewoJICAgICAgdGhpcy5sb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKCSAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwoJICAgIH0KCSAgfTsKCgkgIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KCSAgdmFyIHJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dfFxzKyQvZzsKCgkgIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoZXMuCgkgIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgoJICAvLyBDYWNoZWQgcmVnZXggZm9yIGRldGVjdGluZyBNU0lFLgoJICB2YXIgaXNFeHBsb3JlciA9IC9tc2llIFtcdy5dKy87CgoJICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCgkgIHZhciB0cmFpbGluZ1NsYXNoID0gL1wvJC87CgoJICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyB1cmxzIG9mIGhhc2guCgkgIHZhciBwYXRoU3RyaXBwZXIgPSAvIy4qJC87CgoJICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CgkgIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoKCSAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgoJICBfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CgoJICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwoJICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4KCSAgICBpbnRlcnZhbDogNTAsCgoJICAgIC8vIEFyZSB3ZSBhdCB0aGUgYXBwIHJvb3Q/CgkgICAgYXRSb290OiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dJC8sICckJi8nKSA9PT0gdGhpcy5yb290OwoJICAgIH0sCgoJICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKCSAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KCSAgICBnZXRIYXNoOiBmdW5jdGlvbih3aW5kb3cpIHsKCSAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CgkgICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwoJICAgIH0sCgoJICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKCSAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgoJICAgIGdldEZyYWdtZW50OiBmdW5jdGlvbihmcmFnbWVudCwgZm9yY2VQdXNoU3RhdGUpIHsKCSAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CgkgICAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgfHwgIXRoaXMuX3dhbnRzSGFzaENoYW5nZSB8fCBmb3JjZVB1c2hTdGF0ZSkgewoJICAgICAgICAgIGZyYWdtZW50ID0gZGVjb2RlVVJJKHRoaXMubG9jYXRpb24ucGF0aG5hbWUgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCk7CgkgICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CgkgICAgICAgICAgaWYgKCFmcmFnbWVudC5pbmRleE9mKHJvb3QpKSBmcmFnbWVudCA9IGZyYWdtZW50LnNsaWNlKHJvb3QubGVuZ3RoKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CgkgICAgfSwKCgkgICAgLy8gU3RhcnQgdGhlIGhhc2ggY2hhbmdlIGhhbmRsaW5nLCByZXR1cm5pbmcgYHRydWVgIGlmIHRoZSBjdXJyZW50IFVSTCBtYXRjaGVzCgkgICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KCSAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgaWYgKEhpc3Rvcnkuc3RhcnRlZCkgdGhyb3cgbmV3IEVycm9yKCJCYWNrYm9uZS5oaXN0b3J5IGhhcyBhbHJlYWR5IGJlZW4gc3RhcnRlZCIpOwoJICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCgkgICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwoJICAgICAgLy8gSXMgcHVzaFN0YXRlIGRlc2lyZWQgLi4uIGlzIGl0IGF2YWlsYWJsZT8KCSAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHtyb290OiAnLyd9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwoJICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CgkgICAgICB0aGlzLl93YW50c0hhc2hDaGFuZ2UgPSB0aGlzLm9wdGlvbnMuaGFzaENoYW5nZSAhPT0gZmFsc2U7CgkgICAgICB0aGlzLl93YW50c1B1c2hTdGF0ZSAgPSAhIXRoaXMub3B0aW9ucy5wdXNoU3RhdGU7CgkgICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKCSAgICAgIHZhciBmcmFnbWVudCAgICAgICAgICA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKCSAgICAgIHZhciBkb2NNb2RlICAgICAgICAgICA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKCSAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgoJICAgICAgLy8gTm9ybWFsaXplIHJvb3QgdG8gYWx3YXlzIGluY2x1ZGUgYSBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaC4KCSAgICAgIHRoaXMucm9vdCA9ICgnLycgKyB0aGlzLnJvb3QgKyAnLycpLnJlcGxhY2Uocm9vdFN0cmlwcGVyLCAnLycpOwoKCSAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKCSAgICAgICAgdmFyIGZyYW1lID0gQmFja2JvbmUuJCgnPGlmcmFtZSBzcmM9ImphdmFzY3JpcHQ6MCIgdGFiaW5kZXg9Ii0xIj4nKTsKCSAgICAgICAgdGhpcy5pZnJhbWUgPSBmcmFtZS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwoJICAgICAgICB0aGlzLm5hdmlnYXRlKGZyYWdtZW50KTsKCSAgICAgIH0KCgkgICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgoJICAgICAgLy8gJ29uaGFzaGNoYW5nZScgaXMgc3VwcG9ydGVkLCBkZXRlcm1pbmUgaG93IHdlIGNoZWNrIHRoZSBVUkwgc3RhdGUuCgkgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CgkgICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKCSAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmICgnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3cpICYmICFvbGRJRSkgewoJICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKCSAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CgkgICAgICAgIHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLmNoZWNrVXJsLCB0aGlzLmludGVydmFsKTsKCSAgICAgIH0KCgkgICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawoJICAgICAgLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgoJICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwoJICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CgoJICAgICAgLy8gVHJhbnNpdGlvbiBmcm9tIGhhc2hDaGFuZ2UgdG8gcHVzaFN0YXRlIG9yIHZpY2UgdmVyc2EgaWYgYm90aCBhcmUKCSAgICAgIC8vIHJlcXVlc3RlZC4KCSAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKCgkgICAgICAgIC8vIElmIHdlJ3ZlIHN0YXJ0ZWQgb2ZmIHdpdGggYSByb3V0ZSBmcm9tIGEgYHB1c2hTdGF0ZWAtZW5hYmxlZAoJICAgICAgICAvLyBicm93c2VyLCBidXQgd2UncmUgY3VycmVudGx5IGluIGEgYnJvd3NlciB0aGF0IGRvZXNuJ3Qgc3VwcG9ydCBpdC4uLgoJICAgICAgICBpZiAoIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhdGhpcy5hdFJvb3QoKSkgewoJICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KG51bGwsIHRydWUpOwoJICAgICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSh0aGlzLnJvb3QgKyAnIycgKyB0aGlzLmZyYWdtZW50KTsKCSAgICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKCSAgICAgICAgICByZXR1cm4gdHJ1ZTsKCgkgICAgICAgIC8vIE9yIGlmIHdlJ3ZlIHN0YXJ0ZWQgb3V0IHdpdGggYSBoYXNoLWJhc2VkIHJvdXRlLCBidXQgd2UncmUgY3VycmVudGx5CgkgICAgICAgIC8vIGluIGEgYnJvd3NlciB3aGVyZSBpdCBjb3VsZCBiZSBgcHVzaFN0YXRlYC1iYXNlZCBpbnN0ZWFkLi4uCgkgICAgICAgIH0gZWxzZSBpZiAodGhpcy5faGFzUHVzaFN0YXRlICYmIHRoaXMuYXRSb290KCkgJiYgbG9jLmhhc2gpIHsKCSAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CgkgICAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQpOwoJICAgICAgICB9CgoJICAgICAgfQoKCSAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOwoJICAgIH0sCgoJICAgIC8vIERpc2FibGUgQmFja2JvbmUuaGlzdG9yeSwgcGVyaGFwcyB0ZW1wb3JhcmlseS4gTm90IHVzZWZ1bCBpbiBhIHJlYWwgYXBwLAoJICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgoJICAgIHN0b3A6IGZ1bmN0aW9uKCkgewoJICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9mZigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKS5vZmYoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKCSAgICAgIGlmICh0aGlzLl9jaGVja1VybEludGVydmFsKSBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwoJICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgkgICAgfSwKCgkgICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgoJICAgIC8vIG1heSBvdmVycmlkZSBwcmV2aW91cyByb3V0ZXMuCgkgICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBjYWxsYmFjaykgewoJICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwoJICAgIH0sCgoJICAgIC8vIENoZWNrcyB0aGUgY3VycmVudCBVUkwgdG8gc2VlIGlmIGl0IGhhcyBjaGFuZ2VkLCBhbmQgaWYgaXQgaGFzLAoJICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgoJICAgIGNoZWNrVXJsOiBmdW5jdGlvbihlKSB7CgkgICAgICB2YXIgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKCSAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CgkgICAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwoJICAgICAgfQoJICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKCSAgICAgIGlmICh0aGlzLmlmcmFtZSkgdGhpcy5uYXZpZ2F0ZShjdXJyZW50KTsKCSAgICAgIHRoaXMubG9hZFVybCgpOwoJICAgIH0sCgoJICAgIC8vIEF0dGVtcHQgdG8gbG9hZCB0aGUgY3VycmVudCBVUkwgZnJhZ21lbnQuIElmIGEgcm91dGUgc3VjY2VlZHMgd2l0aCBhCgkgICAgLy8gbWF0Y2gsIHJldHVybnMgYHRydWVgLiBJZiBubyBkZWZpbmVkIHJvdXRlcyBtYXRjaGVzIHRoZSBmcmFnbWVudCwKCSAgICAvLyByZXR1cm5zIGBmYWxzZWAuCgkgICAgbG9hZFVybDogZnVuY3Rpb24oZnJhZ21lbnQpIHsKCSAgICAgIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQpOwoJICAgICAgcmV0dXJuIF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uKGhhbmRsZXIpIHsKCSAgICAgICAgaWYgKGhhbmRsZXIucm91dGUudGVzdChmcmFnbWVudCkpIHsKCSAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKCSAgICAgICAgICByZXR1cm4gdHJ1ZTsKCSAgICAgICAgfQoJICAgICAgfSk7CgkgICAgfSwKCgkgICAgLy8gU2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhhc2ggaGlzdG9yeSwgb3IgcmVwbGFjZSB0aGUgVVJMIHN0YXRlIGlmIHRoZQoJICAgIC8vICdyZXBsYWNlJyBvcHRpb24gaXMgcGFzc2VkLiBZb3UgYXJlIHJlc3BvbnNpYmxlIGZvciBwcm9wZXJseSBVUkwtZW5jb2RpbmcKCSAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KCSAgICAvLwoJICAgIC8vIFRoZSBvcHRpb25zIG9iamVjdCBjYW4gY29udGFpbiBgdHJpZ2dlcjogdHJ1ZWAgaWYgeW91IHdpc2ggdG8gaGF2ZSB0aGUKCSAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgoJICAgIC8vIHlvdSB3aXNoIHRvIG1vZGlmeSB0aGUgY3VycmVudCBVUkwgd2l0aG91dCBhZGRpbmcgYW4gZW50cnkgdG8gdGhlIGhpc3RvcnkuCgkgICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CgkgICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwoJICAgICAgaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpIG9wdGlvbnMgPSB7dHJpZ2dlcjogISFvcHRpb25zfTsKCgkgICAgICB2YXIgdXJsID0gdGhpcy5yb290ICsgKGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJykpOwoKCSAgICAgIC8vIFN0cmlwIHRoZSBoYXNoIGZvciBtYXRjaGluZy4KCSAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZShwYXRoU3RyaXBwZXIsICcnKTsKCgkgICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpIHJldHVybjsKCSAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKCgkgICAgICAvLyBEb24ndCBpbmNsdWRlIGEgdHJhaWxpbmcgc2xhc2ggb24gdGhlIHJvb3QuCgkgICAgICBpZiAoZnJhZ21lbnQgPT09ICcnICYmIHVybCAhPT0gJy8nKSB1cmwgPSB1cmwuc2xpY2UoMCwgLTEpOwoKCSAgICAgIC8vIElmIHB1c2hTdGF0ZSBpcyBhdmFpbGFibGUsIHdlIHVzZSBpdCB0byBzZXQgdGhlIGZyYWdtZW50IGFzIGEgcmVhbCBVUkwuCgkgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CgkgICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CgoJICAgICAgLy8gSWYgaGFzaCBjaGFuZ2VzIGhhdmVuJ3QgYmVlbiBleHBsaWNpdGx5IGRpc2FibGVkLCB1cGRhdGUgdGhlIGhhc2gKCSAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCgkgICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewoJICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwoJICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgKGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSkgewoJICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQoJICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CgkgICAgICAgICAgLy8gd2FudCB0aGlzLgoJICAgICAgICAgIGlmKCFvcHRpb25zLnJlcGxhY2UpIHRoaXMuaWZyYW1lLmRvY3VtZW50Lm9wZW4oKS5jbG9zZSgpOwoJICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwoJICAgICAgICB9CgoJICAgICAgLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtCgkgICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwoJICAgICAgfQoJICAgICAgaWYgKG9wdGlvbnMudHJpZ2dlcikgcmV0dXJuIHRoaXMubG9hZFVybChmcmFnbWVudCk7CgkgICAgfSwKCgkgICAgLy8gVXBkYXRlIHRoZSBoYXNoIGxvY2F0aW9uLCBlaXRoZXIgcmVwbGFjaW5nIHRoZSBjdXJyZW50IGVudHJ5LCBvciBhZGRpbmcKCSAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KCSAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CgkgICAgICBpZiAocmVwbGFjZSkgewoJICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwoJICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCgkgICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKCSAgICAgIH0KCSAgICB9CgoJICB9KTsKCgkgIC8vIENyZWF0ZSB0aGUgZGVmYXVsdCBCYWNrYm9uZS5oaXN0b3J5LgoJICBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7CgoJICAvLyBIZWxwZXJzCgkgIC8vIC0tLS0tLS0KCgkgIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgoJICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAoJICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgoJICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKCSAgICB2YXIgcGFyZW50ID0gdGhpczsKCSAgICB2YXIgY2hpbGQ7CgoJICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKCSAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCgkgICAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgoJICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CgkgICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CgkgICAgfSBlbHNlIHsKCSAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwoJICAgIH0KCgkgICAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCgkgICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKCSAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwoJICAgIC8vIGBwYXJlbnRgJ3MgY29uc3RydWN0b3IgZnVuY3Rpb24uCgkgICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKCSAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKCSAgICBjaGlsZC5wcm90b3R5cGUgPSBuZXcgU3Vycm9nYXRlOwoKCSAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKCSAgICAvLyBpZiBzdXBwbGllZC4KCSAgICBpZiAocHJvdG9Qcm9wcykgXy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKCgkgICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAoJICAgIC8vIGxhdGVyLgoJICAgIGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7CgoJICAgIHJldHVybiBjaGlsZDsKCSAgfTsKCgkgIC8vIFNldCB1cCBpbmhlcml0YW5jZSBmb3IgdGhlIG1vZGVsLCBjb2xsZWN0aW9uLCByb3V0ZXIsIHZpZXcgYW5kIGhpc3RvcnkuCgkgIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgoJICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCgkgIHZhciB1cmxFcnJvciA9IGZ1bmN0aW9uKCkgewoJICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwoJICB9OwoKCSAgLy8gV3JhcCBhbiBvcHRpb25hbCBlcnJvciBjYWxsYmFjayB3aXRoIGEgZmFsbGJhY2sgZXJyb3IgZXZlbnQuCgkgIHZhciB3cmFwRXJyb3IgPSBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewoJICAgIHZhciBlcnJvciA9IG9wdGlvbnMuZXJyb3I7CgkgICAgb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uKHJlc3ApIHsKCSAgICAgIGlmIChlcnJvcikgZXJyb3IobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkgICAgfTsKCSAgfTsKCgkgIHJldHVybiBCYWNrYm9uZTsKCgl9KSk7CgoKLyoqKi8gfSwKLyogMzEgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJdmFyIF9fV0VCUEFDS19BTURfREVGSU5FX0FSUkFZX18sIF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fOy8vICAgICBVbmRlcnNjb3JlLmpzIDEuNy4wCgkvLyAgICAgaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcKCS8vICAgICAoYykgMjAwOS0yMDE0IEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCgkvLyAgICAgVW5kZXJzY29yZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCgkoZnVuY3Rpb24oKSB7CgoJICAvLyBCYXNlbGluZSBzZXR1cAoJICAvLyAtLS0tLS0tLS0tLS0tLQoKCSAgLy8gRXN0YWJsaXNoIHRoZSByb290IG9iamVjdCwgYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIG9yIGBleHBvcnRzYCBvbiB0aGUgc2VydmVyLgoJICB2YXIgcm9vdCA9IHRoaXM7CgoJICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYF9gIHZhcmlhYmxlLgoJICB2YXIgcHJldmlvdXNVbmRlcnNjb3JlID0gcm9vdC5fOwoKCSAgLy8gU2F2ZSBieXRlcyBpbiB0aGUgbWluaWZpZWQgKGJ1dCBub3QgZ3ppcHBlZCkgdmVyc2lvbjoKCSAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwoKCSAgLy8gQ3JlYXRlIHF1aWNrIHJlZmVyZW5jZSB2YXJpYWJsZXMgZm9yIHNwZWVkIGFjY2VzcyB0byBjb3JlIHByb3RvdHlwZXMuCgkgIHZhcgoJICAgIHB1c2ggICAgICAgICAgICAgPSBBcnJheVByb3RvLnB1c2gsCgkgICAgc2xpY2UgICAgICAgICAgICA9IEFycmF5UHJvdG8uc2xpY2UsCgkgICAgY29uY2F0ICAgICAgICAgICA9IEFycmF5UHJvdG8uY29uY2F0LAoJICAgIHRvU3RyaW5nICAgICAgICAgPSBPYmpQcm90by50b1N0cmluZywKCSAgICBoYXNPd25Qcm9wZXJ0eSAgID0gT2JqUHJvdG8uaGFzT3duUHJvcGVydHk7CgoJICAvLyBBbGwgKipFQ01BU2NyaXB0IDUqKiBuYXRpdmUgZnVuY3Rpb24gaW1wbGVtZW50YXRpb25zIHRoYXQgd2UgaG9wZSB0byB1c2UKCSAgLy8gYXJlIGRlY2xhcmVkIGhlcmUuCgkgIHZhcgoJICAgIG5hdGl2ZUlzQXJyYXkgICAgICA9IEFycmF5LmlzQXJyYXksCgkgICAgbmF0aXZlS2V5cyAgICAgICAgID0gT2JqZWN0LmtleXMsCgkgICAgbmF0aXZlQmluZCAgICAgICAgID0gRnVuY1Byb3RvLmJpbmQ7CgoJICAvLyBDcmVhdGUgYSBzYWZlIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yIHVzZSBiZWxvdy4KCSAgdmFyIF8gPSBmdW5jdGlvbihvYmopIHsKCSAgICBpZiAob2JqIGluc3RhbmNlb2YgXykgcmV0dXJuIG9iajsKCSAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgXykpIHJldHVybiBuZXcgXyhvYmopOwoJICAgIHRoaXMuX3dyYXBwZWQgPSBvYmo7CgkgIH07CgoJICAvLyBFeHBvcnQgdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciAqKk5vZGUuanMqKiwgd2l0aAoJICAvLyBiYWNrd2FyZHMtY29tcGF0aWJpbGl0eSBmb3IgdGhlIG9sZCBgcmVxdWlyZSgpYCBBUEkuIElmIHdlJ3JlIGluCgkgIC8vIHRoZSBicm93c2VyLCBhZGQgYF9gIGFzIGEgZ2xvYmFsIG9iamVjdC4KCSAgaWYgKHRydWUpIHsKCSAgICBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpIHsKCSAgICAgIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IF87CgkgICAgfQoJICAgIGV4cG9ydHMuXyA9IF87CgkgIH0gZWxzZSB7CgkgICAgcm9vdC5fID0gXzsKCSAgfQoKCSAgLy8gQ3VycmVudCB2ZXJzaW9uLgoJICBfLlZFUlNJT04gPSAnMS43LjAnOwoKCSAgLy8gSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGFuIGVmZmljaWVudCAoZm9yIGN1cnJlbnQgZW5naW5lcykgdmVyc2lvbgoJICAvLyBvZiB0aGUgcGFzc2VkLWluIGNhbGxiYWNrLCB0byBiZSByZXBlYXRlZGx5IGFwcGxpZWQgaW4gb3RoZXIgVW5kZXJzY29yZQoJICAvLyBmdW5jdGlvbnMuCgkgIHZhciBjcmVhdGVDYWxsYmFjayA9IGZ1bmN0aW9uKGZ1bmMsIGNvbnRleHQsIGFyZ0NvdW50KSB7CgkgICAgaWYgKGNvbnRleHQgPT09IHZvaWQgMCkgcmV0dXJuIGZ1bmM7CgkgICAgc3dpdGNoIChhcmdDb3VudCA9PSBudWxsID8gMyA6IGFyZ0NvdW50KSB7CgkgICAgICBjYXNlIDE6IHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIHZhbHVlKTsKCSAgICAgIH07CgkgICAgICBjYXNlIDI6IHJldHVybiBmdW5jdGlvbih2YWx1ZSwgb3RoZXIpIHsKCSAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0LCB2YWx1ZSwgb3RoZXIpOwoJICAgICAgfTsKCSAgICAgIGNhc2UgMzogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewoJICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CgkgICAgICB9OwoJICAgICAgY2FzZSA0OiByZXR1cm4gZnVuY3Rpb24oYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewoJICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pOwoJICAgICAgfTsKCSAgICB9CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJndW1lbnRzKTsKCSAgICB9OwoJICB9OwoKCSAgLy8gQSBtb3N0bHktaW50ZXJuYWwgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgY2FsbGJhY2tzIHRoYXQgY2FuIGJlIGFwcGxpZWQKCSAgLy8gdG8gZWFjaCBlbGVtZW50IGluIGEgY29sbGVjdGlvbiwgcmV0dXJuaW5nIHRoZSBkZXNpcmVkIHJlc3VsdCDigJQgZWl0aGVyCgkgIC8vIGlkZW50aXR5LCBhbiBhcmJpdHJhcnkgY2FsbGJhY2ssIGEgcHJvcGVydHkgbWF0Y2hlciwgb3IgYSBwcm9wZXJ0eSBhY2Nlc3Nvci4KCSAgXy5pdGVyYXRlZSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0LCBhcmdDb3VudCkgewoJICAgIGlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gXy5pZGVudGl0eTsKCSAgICBpZiAoXy5pc0Z1bmN0aW9uKHZhbHVlKSkgcmV0dXJuIGNyZWF0ZUNhbGxiYWNrKHZhbHVlLCBjb250ZXh0LCBhcmdDb3VudCk7CgkgICAgaWYgKF8uaXNPYmplY3QodmFsdWUpKSByZXR1cm4gXy5tYXRjaGVzKHZhbHVlKTsKCSAgICByZXR1cm4gXy5wcm9wZXJ0eSh2YWx1ZSk7CgkgIH07CgoJICAvLyBDb2xsZWN0aW9uIEZ1bmN0aW9ucwoJICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLQoKCSAgLy8gVGhlIGNvcm5lcnN0b25lLCBhbiBgZWFjaGAgaW1wbGVtZW50YXRpb24sIGFrYSBgZm9yRWFjaGAuCgkgIC8vIEhhbmRsZXMgcmF3IG9iamVjdHMgaW4gYWRkaXRpb24gdG8gYXJyYXktbGlrZXMuIFRyZWF0cyBhbGwKCSAgLy8gc3BhcnNlIGFycmF5LWxpa2VzIGFzIGlmIHRoZXkgd2VyZSBkZW5zZS4KCSAgXy5lYWNoID0gXy5mb3JFYWNoID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIG9iajsKCSAgICBpdGVyYXRlZSA9IGNyZWF0ZUNhbGxiYWNrKGl0ZXJhdGVlLCBjb250ZXh0KTsKCSAgICB2YXIgaSwgbGVuZ3RoID0gb2JqLmxlbmd0aDsKCSAgICBpZiAobGVuZ3RoID09PSArbGVuZ3RoKSB7CgkgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgICAgaXRlcmF0ZWUob2JqW2ldLCBpLCBvYmopOwoJICAgICAgfQoJICAgIH0gZWxzZSB7CgkgICAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwoJICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0ga2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICBpdGVyYXRlZShvYmpba2V5c1tpXV0sIGtleXNbaV0sIG9iaik7CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiBvYmo7CgkgIH07CgoJICAvLyBSZXR1cm4gdGhlIHJlc3VsdHMgb2YgYXBwbHlpbmcgdGhlIGl0ZXJhdGVlIHRvIGVhY2ggZWxlbWVudC4KCSAgXy5tYXAgPSBfLmNvbGxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gW107CgkgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKCSAgICB2YXIga2V5cyA9IG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAoJICAgICAgICBsZW5ndGggPSAoa2V5cyB8fCBvYmopLmxlbmd0aCwKCSAgICAgICAgcmVzdWx0cyA9IEFycmF5KGxlbmd0aCksCgkgICAgICAgIGN1cnJlbnRLZXk7CgkgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewoJICAgICAgY3VycmVudEtleSA9IGtleXMgPyBrZXlzW2luZGV4XSA6IGluZGV4OwoJICAgICAgcmVzdWx0c1tpbmRleF0gPSBpdGVyYXRlZShvYmpbY3VycmVudEtleV0sIGN1cnJlbnRLZXksIG9iaik7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHRzOwoJICB9OwoKCSAgdmFyIHJlZHVjZUVycm9yID0gJ1JlZHVjZSBvZiBlbXB0eSBhcnJheSB3aXRoIG5vIGluaXRpYWwgdmFsdWUnOwoKCSAgLy8gKipSZWR1Y2UqKiBidWlsZHMgdXAgYSBzaW5nbGUgcmVzdWx0IGZyb20gYSBsaXN0IG9mIHZhbHVlcywgYWthIGBpbmplY3RgLAoJICAvLyBvciBgZm9sZGxgLgoJICBfLnJlZHVjZSA9IF8uZm9sZGwgPSBfLmluamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIG1lbW8sIGNvbnRleHQpIHsKCSAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwoJICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQsIDQpOwoJICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGggJiYgXy5rZXlzKG9iaiksCgkgICAgICAgIGxlbmd0aCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAoJICAgICAgICBpbmRleCA9IDAsIGN1cnJlbnRLZXk7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAzKSB7CgkgICAgICBpZiAoIWxlbmd0aCkgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CgkgICAgICBtZW1vID0gb2JqW2tleXMgPyBrZXlzW2luZGV4KytdIDogaW5kZXgrK107CgkgICAgfQoJICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewoJICAgICAgY3VycmVudEtleSA9IGtleXMgPyBrZXlzW2luZGV4XSA6IGluZGV4OwoJICAgICAgbWVtbyA9IGl0ZXJhdGVlKG1lbW8sIG9ialtjdXJyZW50S2V5XSwgY3VycmVudEtleSwgb2JqKTsKCSAgICB9CgkgICAgcmV0dXJuIG1lbW87CgkgIH07CgoJICAvLyBUaGUgcmlnaHQtYXNzb2NpYXRpdmUgdmVyc2lvbiBvZiByZWR1Y2UsIGFsc28ga25vd24gYXMgYGZvbGRyYC4KCSAgXy5yZWR1Y2VSaWdodCA9IF8uZm9sZHIgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBtZW1vLCBjb250ZXh0KSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSBvYmogPSBbXTsKCSAgICBpdGVyYXRlZSA9IGNyZWF0ZUNhbGxiYWNrKGl0ZXJhdGVlLCBjb250ZXh0LCA0KTsKCSAgICB2YXIga2V5cyA9IG9iai5sZW5ndGggIT09ICsgb2JqLmxlbmd0aCAmJiBfLmtleXMob2JqKSwKCSAgICAgICAgaW5kZXggPSAoa2V5cyB8fCBvYmopLmxlbmd0aCwKCSAgICAgICAgY3VycmVudEtleTsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDMpIHsKCSAgICAgIGlmICghaW5kZXgpIHRocm93IG5ldyBUeXBlRXJyb3IocmVkdWNlRXJyb3IpOwoJICAgICAgbWVtbyA9IG9ialtrZXlzID8ga2V5c1stLWluZGV4XSA6IC0taW5kZXhdOwoJICAgIH0KCSAgICB3aGlsZSAoaW5kZXgtLSkgewoJICAgICAgY3VycmVudEtleSA9IGtleXMgPyBrZXlzW2luZGV4XSA6IGluZGV4OwoJICAgICAgbWVtbyA9IGl0ZXJhdGVlKG1lbW8sIG9ialtjdXJyZW50S2V5XSwgY3VycmVudEtleSwgb2JqKTsKCSAgICB9CgkgICAgcmV0dXJuIG1lbW87CgkgIH07CgoJICAvLyBSZXR1cm4gdGhlIGZpcnN0IHZhbHVlIHdoaWNoIHBhc3NlcyBhIHRydXRoIHRlc3QuIEFsaWFzZWQgYXMgYGRldGVjdGAuCgkgIF8uZmluZCA9IF8uZGV0ZWN0ID0gZnVuY3Rpb24ob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKCSAgICB2YXIgcmVzdWx0OwoJICAgIHByZWRpY2F0ZSA9IF8uaXRlcmF0ZWUocHJlZGljYXRlLCBjb250ZXh0KTsKCSAgICBfLnNvbWUob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKCSAgICAgIGlmIChwcmVkaWNhdGUodmFsdWUsIGluZGV4LCBsaXN0KSkgewoJICAgICAgICByZXN1bHQgPSB2YWx1ZTsKCSAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgICB9CgkgICAgfSk7CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIHRoYXQgcGFzcyBhIHRydXRoIHRlc3QuCgkgIC8vIEFsaWFzZWQgYXMgYHNlbGVjdGAuCgkgIF8uZmlsdGVyID0gXy5zZWxlY3QgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewoJICAgIHZhciByZXN1bHRzID0gW107CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKCSAgICBwcmVkaWNhdGUgPSBfLml0ZXJhdGVlKHByZWRpY2F0ZSwgY29udGV4dCk7CgkgICAgXy5lYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CgkgICAgICBpZiAocHJlZGljYXRlKHZhbHVlLCBpbmRleCwgbGlzdCkpIHJlc3VsdHMucHVzaCh2YWx1ZSk7CgkgICAgfSk7CgkgICAgcmV0dXJuIHJlc3VsdHM7CgkgIH07CgoJICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyBmb3Igd2hpY2ggYSB0cnV0aCB0ZXN0IGZhaWxzLgoJICBfLnJlamVjdCA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CgkgICAgcmV0dXJuIF8uZmlsdGVyKG9iaiwgXy5uZWdhdGUoXy5pdGVyYXRlZShwcmVkaWNhdGUpKSwgY29udGV4dCk7CgkgIH07CgoJICAvLyBEZXRlcm1pbmUgd2hldGhlciBhbGwgb2YgdGhlIGVsZW1lbnRzIG1hdGNoIGEgdHJ1dGggdGVzdC4KCSAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KCSAgXy5ldmVyeSA9IF8uYWxsID0gZnVuY3Rpb24ob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKCSAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB0cnVlOwoJICAgIHByZWRpY2F0ZSA9IF8uaXRlcmF0ZWUocHJlZGljYXRlLCBjb250ZXh0KTsKCSAgICB2YXIga2V5cyA9IG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAoJICAgICAgICBsZW5ndGggPSAoa2V5cyB8fCBvYmopLmxlbmd0aCwKCSAgICAgICAgaW5kZXgsIGN1cnJlbnRLZXk7CgkgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CgkgICAgICBjdXJyZW50S2V5ID0ga2V5cyA/IGtleXNbaW5kZXhdIDogaW5kZXg7CgkgICAgICBpZiAoIXByZWRpY2F0ZShvYmpbY3VycmVudEtleV0sIGN1cnJlbnRLZXksIG9iaikpIHJldHVybiBmYWxzZTsKCSAgICB9CgkgICAgcmV0dXJuIHRydWU7CgkgIH07CgoJICAvLyBEZXRlcm1pbmUgaWYgYXQgbGVhc3Qgb25lIGVsZW1lbnQgaW4gdGhlIG9iamVjdCBtYXRjaGVzIGEgdHJ1dGggdGVzdC4KCSAgLy8gQWxpYXNlZCBhcyBgYW55YC4KCSAgXy5zb21lID0gXy5hbnkgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwoJICAgIHByZWRpY2F0ZSA9IF8uaXRlcmF0ZWUocHJlZGljYXRlLCBjb250ZXh0KTsKCSAgICB2YXIga2V5cyA9IG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAoJICAgICAgICBsZW5ndGggPSAoa2V5cyB8fCBvYmopLmxlbmd0aCwKCSAgICAgICAgaW5kZXgsIGN1cnJlbnRLZXk7CgkgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CgkgICAgICBjdXJyZW50S2V5ID0ga2V5cyA/IGtleXNbaW5kZXhdIDogaW5kZXg7CgkgICAgICBpZiAocHJlZGljYXRlKG9ialtjdXJyZW50S2V5XSwgY3VycmVudEtleSwgb2JqKSkgcmV0dXJuIHRydWU7CgkgICAgfQoJICAgIHJldHVybiBmYWxzZTsKCSAgfTsKCgkgIC8vIERldGVybWluZSBpZiB0aGUgYXJyYXkgb3Igb2JqZWN0IGNvbnRhaW5zIGEgZ2l2ZW4gdmFsdWUgKHVzaW5nIGA9PT1gKS4KCSAgLy8gQWxpYXNlZCBhcyBgaW5jbHVkZWAuCgkgIF8uY29udGFpbnMgPSBfLmluY2x1ZGUgPSBmdW5jdGlvbihvYmosIHRhcmdldCkgewoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwoJICAgIGlmIChvYmoubGVuZ3RoICE9PSArb2JqLmxlbmd0aCkgb2JqID0gXy52YWx1ZXMob2JqKTsKCSAgICByZXR1cm4gXy5pbmRleE9mKG9iaiwgdGFyZ2V0KSA+PSAwOwoJICB9OwoKCSAgLy8gSW52b2tlIGEgbWV0aG9kICh3aXRoIGFyZ3VtZW50cykgb24gZXZlcnkgaXRlbSBpbiBhIGNvbGxlY3Rpb24uCgkgIF8uaW52b2tlID0gZnVuY3Rpb24ob2JqLCBtZXRob2QpIHsKCSAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKCSAgICB2YXIgaXNGdW5jID0gXy5pc0Z1bmN0aW9uKG1ldGhvZCk7CgkgICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKCSAgICAgIHJldHVybiAoaXNGdW5jID8gbWV0aG9kIDogdmFsdWVbbWV0aG9kXSkuYXBwbHkodmFsdWUsIGFyZ3MpOwoJICAgIH0pOwoJICB9OwoKCSAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgbWFwYDogZmV0Y2hpbmcgYSBwcm9wZXJ0eS4KCSAgXy5wbHVjayA9IGZ1bmN0aW9uKG9iaiwga2V5KSB7CgkgICAgcmV0dXJuIF8ubWFwKG9iaiwgXy5wcm9wZXJ0eShrZXkpKTsKCSAgfTsKCgkgIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbHRlcmA6IHNlbGVjdGluZyBvbmx5IG9iamVjdHMKCSAgLy8gY29udGFpbmluZyBzcGVjaWZpYyBga2V5OnZhbHVlYCBwYWlycy4KCSAgXy53aGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMpIHsKCSAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBfLm1hdGNoZXMoYXR0cnMpKTsKCSAgfTsKCgkgIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbmRgOiBnZXR0aW5nIHRoZSBmaXJzdCBvYmplY3QKCSAgLy8gY29udGFpbmluZyBzcGVjaWZpYyBga2V5OnZhbHVlYCBwYWlycy4KCSAgXy5maW5kV2hlcmUgPSBmdW5jdGlvbihvYmosIGF0dHJzKSB7CgkgICAgcmV0dXJuIF8uZmluZChvYmosIF8ubWF0Y2hlcyhhdHRycykpOwoJICB9OwoKCSAgLy8gUmV0dXJuIHRoZSBtYXhpbXVtIGVsZW1lbnQgKG9yIGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgoJICBfLm1heCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICB2YXIgcmVzdWx0ID0gLUluZmluaXR5LCBsYXN0Q29tcHV0ZWQgPSAtSW5maW5pdHksCgkgICAgICAgIHZhbHVlLCBjb21wdXRlZDsKCSAgICBpZiAoaXRlcmF0ZWUgPT0gbnVsbCAmJiBvYmogIT0gbnVsbCkgewoJICAgICAgb2JqID0gb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmogOiBfLnZhbHVlcyhvYmopOwoJICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IG9iai5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICB2YWx1ZSA9IG9ialtpXTsKCSAgICAgICAgaWYgKHZhbHVlID4gcmVzdWx0KSB7CgkgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKCSAgICAgIF8uZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewoJICAgICAgICBjb21wdXRlZCA9IGl0ZXJhdGVlKHZhbHVlLCBpbmRleCwgbGlzdCk7CgkgICAgICAgIGlmIChjb21wdXRlZCA+IGxhc3RDb21wdXRlZCB8fCBjb21wdXRlZCA9PT0gLUluZmluaXR5ICYmIHJlc3VsdCA9PT0gLUluZmluaXR5KSB7CgkgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CgkgICAgICAgICAgbGFzdENvbXB1dGVkID0gY29tcHV0ZWQ7CgkgICAgICAgIH0KCSAgICAgIH0pOwoJICAgIH0KCSAgICByZXR1cm4gcmVzdWx0OwoJICB9OwoKCSAgLy8gUmV0dXJuIHRoZSBtaW5pbXVtIGVsZW1lbnQgKG9yIGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgoJICBfLm1pbiA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICB2YXIgcmVzdWx0ID0gSW5maW5pdHksIGxhc3RDb21wdXRlZCA9IEluZmluaXR5LAoJICAgICAgICB2YWx1ZSwgY29tcHV0ZWQ7CgkgICAgaWYgKGl0ZXJhdGVlID09IG51bGwgJiYgb2JqICE9IG51bGwpIHsKCSAgICAgIG9iaiA9IG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoID8gb2JqIDogXy52YWx1ZXMob2JqKTsKCSAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBvYmoubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgICAgdmFsdWUgPSBvYmpbaV07CgkgICAgICAgIGlmICh2YWx1ZSA8IHJlc3VsdCkgewoJICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIGl0ZXJhdGVlID0gXy5pdGVyYXRlZShpdGVyYXRlZSwgY29udGV4dCk7CgkgICAgICBfLmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKCSAgICAgICAgY29tcHV0ZWQgPSBpdGVyYXRlZSh2YWx1ZSwgaW5kZXgsIGxpc3QpOwoJICAgICAgICBpZiAoY29tcHV0ZWQgPCBsYXN0Q29tcHV0ZWQgfHwgY29tcHV0ZWQgPT09IEluZmluaXR5ICYmIHJlc3VsdCA9PT0gSW5maW5pdHkpIHsKCSAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKCSAgICAgICAgICBsYXN0Q29tcHV0ZWQgPSBjb21wdXRlZDsKCSAgICAgICAgfQoJICAgICAgfSk7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH07CgoJICAvLyBTaHVmZmxlIGEgY29sbGVjdGlvbiwgdXNpbmcgdGhlIG1vZGVybiB2ZXJzaW9uIG9mIHRoZQoJICAvLyBbRmlzaGVyLVlhdGVzIHNodWZmbGVdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmlzaGVy4oCTWWF0ZXNfc2h1ZmZsZSkuCgkgIF8uc2h1ZmZsZSA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBzZXQgPSBvYmogJiYgb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmogOiBfLnZhbHVlcyhvYmopOwoJICAgIHZhciBsZW5ndGggPSBzZXQubGVuZ3RoOwoJICAgIHZhciBzaHVmZmxlZCA9IEFycmF5KGxlbmd0aCk7CgkgICAgZm9yICh2YXIgaW5kZXggPSAwLCByYW5kOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewoJICAgICAgcmFuZCA9IF8ucmFuZG9tKDAsIGluZGV4KTsKCSAgICAgIGlmIChyYW5kICE9PSBpbmRleCkgc2h1ZmZsZWRbaW5kZXhdID0gc2h1ZmZsZWRbcmFuZF07CgkgICAgICBzaHVmZmxlZFtyYW5kXSA9IHNldFtpbmRleF07CgkgICAgfQoJICAgIHJldHVybiBzaHVmZmxlZDsKCSAgfTsKCgkgIC8vIFNhbXBsZSAqKm4qKiByYW5kb20gdmFsdWVzIGZyb20gYSBjb2xsZWN0aW9uLgoJICAvLyBJZiAqKm4qKiBpcyBub3Qgc3BlY2lmaWVkLCByZXR1cm5zIGEgc2luZ2xlIHJhbmRvbSBlbGVtZW50LgoJICAvLyBUaGUgaW50ZXJuYWwgYGd1YXJkYCBhcmd1bWVudCBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBtYXBgLgoJICBfLnNhbXBsZSA9IGZ1bmN0aW9uKG9iaiwgbiwgZ3VhcmQpIHsKCSAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKSB7CgkgICAgICBpZiAob2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGgpIG9iaiA9IF8udmFsdWVzKG9iaik7CgkgICAgICByZXR1cm4gb2JqW18ucmFuZG9tKG9iai5sZW5ndGggLSAxKV07CgkgICAgfQoJICAgIHJldHVybiBfLnNodWZmbGUob2JqKS5zbGljZSgwLCBNYXRoLm1heCgwLCBuKSk7CgkgIH07CgoJICAvLyBTb3J0IHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24gcHJvZHVjZWQgYnkgYW4gaXRlcmF0ZWUuCgkgIF8uc29ydEJ5ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIGl0ZXJhdGVlID0gXy5pdGVyYXRlZShpdGVyYXRlZSwgY29udGV4dCk7CgkgICAgcmV0dXJuIF8ucGx1Y2soXy5tYXAob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKCSAgICAgIHJldHVybiB7CgkgICAgICAgIHZhbHVlOiB2YWx1ZSwKCSAgICAgICAgaW5kZXg6IGluZGV4LAoJICAgICAgICBjcml0ZXJpYTogaXRlcmF0ZWUodmFsdWUsIGluZGV4LCBsaXN0KQoJICAgICAgfTsKCSAgICB9KS5zb3J0KGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CgkgICAgICB2YXIgYSA9IGxlZnQuY3JpdGVyaWE7CgkgICAgICB2YXIgYiA9IHJpZ2h0LmNyaXRlcmlhOwoJICAgICAgaWYgKGEgIT09IGIpIHsKCSAgICAgICAgaWYgKGEgPiBiIHx8IGEgPT09IHZvaWQgMCkgcmV0dXJuIDE7CgkgICAgICAgIGlmIChhIDwgYiB8fCBiID09PSB2b2lkIDApIHJldHVybiAtMTsKCSAgICAgIH0KCSAgICAgIHJldHVybiBsZWZ0LmluZGV4IC0gcmlnaHQuaW5kZXg7CgkgICAgfSksICd2YWx1ZScpOwoJICB9OwoKCSAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdXNlZCBmb3IgYWdncmVnYXRlICJncm91cCBieSIgb3BlcmF0aW9ucy4KCSAgdmFyIGdyb3VwID0gZnVuY3Rpb24oYmVoYXZpb3IpIHsKCSAgICByZXR1cm4gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgICAgdmFyIHJlc3VsdCA9IHt9OwoJICAgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKCSAgICAgIF8uZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewoJICAgICAgICB2YXIga2V5ID0gaXRlcmF0ZWUodmFsdWUsIGluZGV4LCBvYmopOwoJICAgICAgICBiZWhhdmlvcihyZXN1bHQsIHZhbHVlLCBrZXkpOwoJICAgICAgfSk7CgkgICAgICByZXR1cm4gcmVzdWx0OwoJICAgIH07CgkgIH07CgoJICAvLyBHcm91cHMgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbi4gUGFzcyBlaXRoZXIgYSBzdHJpbmcgYXR0cmlidXRlCgkgIC8vIHRvIGdyb3VwIGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3JpdGVyaW9uLgoJICBfLmdyb3VwQnkgPSBncm91cChmdW5jdGlvbihyZXN1bHQsIHZhbHVlLCBrZXkpIHsKCSAgICBpZiAoXy5oYXMocmVzdWx0LCBrZXkpKSByZXN1bHRba2V5XS5wdXNoKHZhbHVlKTsgZWxzZSByZXN1bHRba2V5XSA9IFt2YWx1ZV07CgkgIH0pOwoKCSAgLy8gSW5kZXhlcyB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uLCBzaW1pbGFyIHRvIGBncm91cEJ5YCwgYnV0IGZvcgoJICAvLyB3aGVuIHlvdSBrbm93IHRoYXQgeW91ciBpbmRleCB2YWx1ZXMgd2lsbCBiZSB1bmlxdWUuCgkgIF8uaW5kZXhCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewoJICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CgkgIH0pOwoKCSAgLy8gQ291bnRzIGluc3RhbmNlcyBvZiBhbiBvYmplY3QgdGhhdCBncm91cCBieSBhIGNlcnRhaW4gY3JpdGVyaW9uLiBQYXNzCgkgIC8vIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUgdG8gY291bnQgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZQoJICAvLyBjcml0ZXJpb24uCgkgIF8uY291bnRCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewoJICAgIGlmIChfLmhhcyhyZXN1bHQsIGtleSkpIHJlc3VsdFtrZXldKys7IGVsc2UgcmVzdWx0W2tleV0gPSAxOwoJICB9KTsKCgkgIC8vIFVzZSBhIGNvbXBhcmF0b3IgZnVuY3Rpb24gdG8gZmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2gKCSAgLy8gYW4gb2JqZWN0IHNob3VsZCBiZSBpbnNlcnRlZCBzbyBhcyB0byBtYWludGFpbiBvcmRlci4gVXNlcyBiaW5hcnkgc2VhcmNoLgoJICBfLnNvcnRlZEluZGV4ID0gZnVuY3Rpb24oYXJyYXksIG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQsIDEpOwoJICAgIHZhciB2YWx1ZSA9IGl0ZXJhdGVlKG9iaik7CgkgICAgdmFyIGxvdyA9IDAsIGhpZ2ggPSBhcnJheS5sZW5ndGg7CgkgICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKCSAgICAgIHZhciBtaWQgPSBsb3cgKyBoaWdoID4+PiAxOwoJICAgICAgaWYgKGl0ZXJhdGVlKGFycmF5W21pZF0pIDwgdmFsdWUpIGxvdyA9IG1pZCArIDE7IGVsc2UgaGlnaCA9IG1pZDsKCSAgICB9CgkgICAgcmV0dXJuIGxvdzsKCSAgfTsKCgkgIC8vIFNhZmVseSBjcmVhdGUgYSByZWFsLCBsaXZlIGFycmF5IGZyb20gYW55dGhpbmcgaXRlcmFibGUuCgkgIF8udG9BcnJheSA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmICghb2JqKSByZXR1cm4gW107CgkgICAgaWYgKF8uaXNBcnJheShvYmopKSByZXR1cm4gc2xpY2UuY2FsbChvYmopOwoJICAgIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgcmV0dXJuIF8ubWFwKG9iaiwgXy5pZGVudGl0eSk7CgkgICAgcmV0dXJuIF8udmFsdWVzKG9iaik7CgkgIH07CgoJICAvLyBSZXR1cm4gdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBvYmplY3QuCgkgIF8uc2l6ZSA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIDA7CgkgICAgcmV0dXJuIG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoID8gb2JqLmxlbmd0aCA6IF8ua2V5cyhvYmopLmxlbmd0aDsKCSAgfTsKCgkgIC8vIFNwbGl0IGEgY29sbGVjdGlvbiBpbnRvIHR3byBhcnJheXM6IG9uZSB3aG9zZSBlbGVtZW50cyBhbGwgc2F0aXNmeSB0aGUgZ2l2ZW4KCSAgLy8gcHJlZGljYXRlLCBhbmQgb25lIHdob3NlIGVsZW1lbnRzIGFsbCBkbyBub3Qgc2F0aXNmeSB0aGUgcHJlZGljYXRlLgoJICBfLnBhcnRpdGlvbiA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CgkgICAgcHJlZGljYXRlID0gXy5pdGVyYXRlZShwcmVkaWNhdGUsIGNvbnRleHQpOwoJICAgIHZhciBwYXNzID0gW10sIGZhaWwgPSBbXTsKCSAgICBfLmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmopIHsKCSAgICAgIChwcmVkaWNhdGUodmFsdWUsIGtleSwgb2JqKSA/IHBhc3MgOiBmYWlsKS5wdXNoKHZhbHVlKTsKCSAgICB9KTsKCSAgICByZXR1cm4gW3Bhc3MsIGZhaWxdOwoJICB9OwoKCSAgLy8gQXJyYXkgRnVuY3Rpb25zCgkgIC8vIC0tLS0tLS0tLS0tLS0tLQoKCSAgLy8gR2V0IHRoZSBmaXJzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBmaXJzdCBOCgkgIC8vIHZhbHVlcyBpbiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYGhlYWRgIGFuZCBgdGFrZWAuIFRoZSAqKmd1YXJkKiogY2hlY2sKCSAgLy8gYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgoJICBfLmZpcnN0ID0gXy5oZWFkID0gXy50YWtlID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CgkgICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiB2b2lkIDA7CgkgICAgaWYgKG4gPT0gbnVsbCB8fCBndWFyZCkgcmV0dXJuIGFycmF5WzBdOwoJICAgIGlmIChuIDwgMCkgcmV0dXJuIFtdOwoJICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBuKTsKCSAgfTsKCgkgIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGxhc3QgZW50cnkgb2YgdGhlIGFycmF5LiBFc3BlY2lhbGx5IHVzZWZ1bCBvbgoJICAvLyB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiBhbGwgdGhlIHZhbHVlcyBpbgoJICAvLyB0aGUgYXJyYXksIGV4Y2x1ZGluZyB0aGUgbGFzdCBOLiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGgKCSAgLy8gYF8ubWFwYC4KCSAgXy5pbml0aWFsID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CgkgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIDAsIE1hdGgubWF4KDAsIGFycmF5Lmxlbmd0aCAtIChuID09IG51bGwgfHwgZ3VhcmQgPyAxIDogbikpKTsKCSAgfTsKCgkgIC8vIEdldCB0aGUgbGFzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBsYXN0IE4KCSAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCgkgIF8ubGFzdCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewoJICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwoJICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpIHJldHVybiBhcnJheVthcnJheS5sZW5ndGggLSAxXTsKCSAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgTWF0aC5tYXgoYXJyYXkubGVuZ3RoIC0gbiwgMCkpOwoJICB9OwoKCSAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgZmlyc3QgZW50cnkgb2YgdGhlIGFycmF5LiBBbGlhc2VkIGFzIGB0YWlsYCBhbmQgYGRyb3BgLgoJICAvLyBFc3BlY2lhbGx5IHVzZWZ1bCBvbiB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyBhbiAqKm4qKiB3aWxsIHJldHVybgoJICAvLyB0aGUgcmVzdCBOIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKioKCSAgLy8gY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgoJICBfLnJlc3QgPSBfLnRhaWwgPSBfLmRyb3AgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKCSAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgbiA9PSBudWxsIHx8IGd1YXJkID8gMSA6IG4pOwoJICB9OwoKCSAgLy8gVHJpbSBvdXQgYWxsIGZhbHN5IHZhbHVlcyBmcm9tIGFuIGFycmF5LgoJICBfLmNvbXBhY3QgPSBmdW5jdGlvbihhcnJheSkgewoJICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgXy5pZGVudGl0eSk7CgkgIH07CgoJICAvLyBJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlY3Vyc2l2ZSBgZmxhdHRlbmAgZnVuY3Rpb24uCgkgIHZhciBmbGF0dGVuID0gZnVuY3Rpb24oaW5wdXQsIHNoYWxsb3csIHN0cmljdCwgb3V0cHV0KSB7CgkgICAgaWYgKHNoYWxsb3cgJiYgXy5ldmVyeShpbnB1dCwgXy5pc0FycmF5KSkgewoJICAgICAgcmV0dXJuIGNvbmNhdC5hcHBseShvdXRwdXQsIGlucHV0KTsKCSAgICB9CgkgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGlucHV0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICB2YXIgdmFsdWUgPSBpbnB1dFtpXTsKCSAgICAgIGlmICghXy5pc0FycmF5KHZhbHVlKSAmJiAhXy5pc0FyZ3VtZW50cyh2YWx1ZSkpIHsKCSAgICAgICAgaWYgKCFzdHJpY3QpIG91dHB1dC5wdXNoKHZhbHVlKTsKCSAgICAgIH0gZWxzZSBpZiAoc2hhbGxvdykgewoJICAgICAgICBwdXNoLmFwcGx5KG91dHB1dCwgdmFsdWUpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgZmxhdHRlbih2YWx1ZSwgc2hhbGxvdywgc3RyaWN0LCBvdXRwdXQpOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gb3V0cHV0OwoJICB9OwoKCSAgLy8gRmxhdHRlbiBvdXQgYW4gYXJyYXksIGVpdGhlciByZWN1cnNpdmVseSAoYnkgZGVmYXVsdCksIG9yIGp1c3Qgb25lIGxldmVsLgoJICBfLmZsYXR0ZW4gPSBmdW5jdGlvbihhcnJheSwgc2hhbGxvdykgewoJICAgIHJldHVybiBmbGF0dGVuKGFycmF5LCBzaGFsbG93LCBmYWxzZSwgW10pOwoJICB9OwoKCSAgLy8gUmV0dXJuIGEgdmVyc2lvbiBvZiB0aGUgYXJyYXkgdGhhdCBkb2VzIG5vdCBjb250YWluIHRoZSBzcGVjaWZpZWQgdmFsdWUocykuCgkgIF8ud2l0aG91dCA9IGZ1bmN0aW9uKGFycmF5KSB7CgkgICAgcmV0dXJuIF8uZGlmZmVyZW5jZShhcnJheSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCSAgfTsKCgkgIC8vIFByb2R1Y2UgYSBkdXBsaWNhdGUtZnJlZSB2ZXJzaW9uIG9mIHRoZSBhcnJheS4gSWYgdGhlIGFycmF5IGhhcyBhbHJlYWR5CgkgIC8vIGJlZW4gc29ydGVkLCB5b3UgaGF2ZSB0aGUgb3B0aW9uIG9mIHVzaW5nIGEgZmFzdGVyIGFsZ29yaXRobS4KCSAgLy8gQWxpYXNlZCBhcyBgdW5pcXVlYC4KCSAgXy51bmlxID0gXy51bmlxdWUgPSBmdW5jdGlvbihhcnJheSwgaXNTb3J0ZWQsIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiBbXTsKCSAgICBpZiAoIV8uaXNCb29sZWFuKGlzU29ydGVkKSkgewoJICAgICAgY29udGV4dCA9IGl0ZXJhdGVlOwoJICAgICAgaXRlcmF0ZWUgPSBpc1NvcnRlZDsKCSAgICAgIGlzU29ydGVkID0gZmFsc2U7CgkgICAgfQoJICAgIGlmIChpdGVyYXRlZSAhPSBudWxsKSBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQpOwoJICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICB2YXIgc2VlbiA9IFtdOwoJICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaV07CgkgICAgICBpZiAoaXNTb3J0ZWQpIHsKCSAgICAgICAgaWYgKCFpIHx8IHNlZW4gIT09IHZhbHVlKSByZXN1bHQucHVzaCh2YWx1ZSk7CgkgICAgICAgIHNlZW4gPSB2YWx1ZTsKCSAgICAgIH0gZWxzZSBpZiAoaXRlcmF0ZWUpIHsKCSAgICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0ZWUodmFsdWUsIGksIGFycmF5KTsKCSAgICAgICAgaWYgKF8uaW5kZXhPZihzZWVuLCBjb21wdXRlZCkgPCAwKSB7CgkgICAgICAgICAgc2Vlbi5wdXNoKGNvbXB1dGVkKTsKCSAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CgkgICAgICAgIH0KCSAgICAgIH0gZWxzZSBpZiAoXy5pbmRleE9mKHJlc3VsdCwgdmFsdWUpIDwgMCkgewoJICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH07CgoJICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIHVuaW9uOiBlYWNoIGRpc3RpbmN0IGVsZW1lbnQgZnJvbSBhbGwgb2YKCSAgLy8gdGhlIHBhc3NlZC1pbiBhcnJheXMuCgkgIF8udW5pb24gPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gXy51bmlxKGZsYXR0ZW4oYXJndW1lbnRzLCB0cnVlLCB0cnVlLCBbXSkpOwoJICB9OwoKCSAgLy8gUHJvZHVjZSBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIGV2ZXJ5IGl0ZW0gc2hhcmVkIGJldHdlZW4gYWxsIHRoZQoJICAvLyBwYXNzZWQtaW4gYXJyYXlzLgoJICBfLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKGFycmF5KSB7CgkgICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiBbXTsKCSAgICB2YXIgcmVzdWx0ID0gW107CgkgICAgdmFyIGFyZ3NMZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwoJICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgdmFyIGl0ZW0gPSBhcnJheVtpXTsKCSAgICAgIGlmIChfLmNvbnRhaW5zKHJlc3VsdCwgaXRlbSkpIGNvbnRpbnVlOwoJICAgICAgZm9yICh2YXIgaiA9IDE7IGogPCBhcmdzTGVuZ3RoOyBqKyspIHsKCSAgICAgICAgaWYgKCFfLmNvbnRhaW5zKGFyZ3VtZW50c1tqXSwgaXRlbSkpIGJyZWFrOwoJICAgICAgfQoJICAgICAgaWYgKGogPT09IGFyZ3NMZW5ndGgpIHJlc3VsdC5wdXNoKGl0ZW0pOwoJICAgIH0KCSAgICByZXR1cm4gcmVzdWx0OwoJICB9OwoKCSAgLy8gVGFrZSB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIG9uZSBhcnJheSBhbmQgYSBudW1iZXIgb2Ygb3RoZXIgYXJyYXlzLgoJICAvLyBPbmx5IHRoZSBlbGVtZW50cyBwcmVzZW50IGluIGp1c3QgdGhlIGZpcnN0IGFycmF5IHdpbGwgcmVtYWluLgoJICBfLmRpZmZlcmVuY2UgPSBmdW5jdGlvbihhcnJheSkgewoJICAgIHZhciByZXN0ID0gZmxhdHRlbihzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIHRydWUsIHRydWUsIFtdKTsKCSAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKXsKCSAgICAgIHJldHVybiAhXy5jb250YWlucyhyZXN0LCB2YWx1ZSk7CgkgICAgfSk7CgkgIH07CgoJICAvLyBaaXAgdG9nZXRoZXIgbXVsdGlwbGUgbGlzdHMgaW50byBhIHNpbmdsZSBhcnJheSAtLSBlbGVtZW50cyB0aGF0IHNoYXJlCgkgIC8vIGFuIGluZGV4IGdvIHRvZ2V0aGVyLgoJICBfLnppcCA9IGZ1bmN0aW9uKGFycmF5KSB7CgkgICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiBbXTsKCSAgICB2YXIgbGVuZ3RoID0gXy5tYXgoYXJndW1lbnRzLCAnbGVuZ3RoJykubGVuZ3RoOwoJICAgIHZhciByZXN1bHRzID0gQXJyYXkobGVuZ3RoKTsKCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICByZXN1bHRzW2ldID0gXy5wbHVjayhhcmd1bWVudHMsIGkpOwoJICAgIH0KCSAgICByZXR1cm4gcmVzdWx0czsKCSAgfTsKCgkgIC8vIENvbnZlcnRzIGxpc3RzIGludG8gb2JqZWN0cy4gUGFzcyBlaXRoZXIgYSBzaW5nbGUgYXJyYXkgb2YgYFtrZXksIHZhbHVlXWAKCSAgLy8gcGFpcnMsIG9yIHR3byBwYXJhbGxlbCBhcnJheXMgb2YgdGhlIHNhbWUgbGVuZ3RoIC0tIG9uZSBvZiBrZXlzLCBhbmQgb25lIG9mCgkgIC8vIHRoZSBjb3JyZXNwb25kaW5nIHZhbHVlcy4KCSAgXy5vYmplY3QgPSBmdW5jdGlvbihsaXN0LCB2YWx1ZXMpIHsKCSAgICBpZiAobGlzdCA9PSBudWxsKSByZXR1cm4ge307CgkgICAgdmFyIHJlc3VsdCA9IHt9OwoJICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBsaXN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICBpZiAodmFsdWVzKSB7CgkgICAgICAgIHJlc3VsdFtsaXN0W2ldXSA9IHZhbHVlc1tpXTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHJlc3VsdFtsaXN0W2ldWzBdXSA9IGxpc3RbaV1bMV07CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH07CgoJICAvLyBSZXR1cm4gdGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGFuIGl0ZW0gaW4gYW4gYXJyYXksCgkgIC8vIG9yIC0xIGlmIHRoZSBpdGVtIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgYXJyYXkuCgkgIC8vIElmIHRoZSBhcnJheSBpcyBsYXJnZSBhbmQgYWxyZWFkeSBpbiBzb3J0IG9yZGVyLCBwYXNzIGB0cnVlYAoJICAvLyBmb3IgKippc1NvcnRlZCoqIHRvIHVzZSBiaW5hcnkgc2VhcmNoLgoJICBfLmluZGV4T2YgPSBmdW5jdGlvbihhcnJheSwgaXRlbSwgaXNTb3J0ZWQpIHsKCSAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwoJICAgIHZhciBpID0gMCwgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoJICAgIGlmIChpc1NvcnRlZCkgewoJICAgICAgaWYgKHR5cGVvZiBpc1NvcnRlZCA9PSAnbnVtYmVyJykgewoJICAgICAgICBpID0gaXNTb3J0ZWQgPCAwID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgaXNTb3J0ZWQpIDogaXNTb3J0ZWQ7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBpID0gXy5zb3J0ZWRJbmRleChhcnJheSwgaXRlbSk7CgkgICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKCSAgICAgIH0KCSAgICB9CgkgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgaWYgKGFycmF5W2ldID09PSBpdGVtKSByZXR1cm4gaTsKCSAgICByZXR1cm4gLTE7CgkgIH07CgoJICBfLmxhc3RJbmRleE9mID0gZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGZyb20pIHsKCSAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwoJICAgIHZhciBpZHggPSBhcnJheS5sZW5ndGg7CgkgICAgaWYgKHR5cGVvZiBmcm9tID09ICdudW1iZXInKSB7CgkgICAgICBpZHggPSBmcm9tIDwgMCA/IGlkeCArIGZyb20gKyAxIDogTWF0aC5taW4oaWR4LCBmcm9tICsgMSk7CgkgICAgfQoJICAgIHdoaWxlICgtLWlkeCA+PSAwKSBpZiAoYXJyYXlbaWR4XSA9PT0gaXRlbSkgcmV0dXJuIGlkeDsKCSAgICByZXR1cm4gLTE7CgkgIH07CgoJICAvLyBHZW5lcmF0ZSBhbiBpbnRlZ2VyIEFycmF5IGNvbnRhaW5pbmcgYW4gYXJpdGhtZXRpYyBwcm9ncmVzc2lvbi4gQSBwb3J0IG9mCgkgIC8vIHRoZSBuYXRpdmUgUHl0aG9uIGByYW5nZSgpYCBmdW5jdGlvbi4gU2VlCgkgIC8vIFt0aGUgUHl0aG9uIGRvY3VtZW50YXRpb25dKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9mdW5jdGlvbnMuaHRtbCNyYW5nZSkuCgkgIF8ucmFuZ2UgPSBmdW5jdGlvbihzdGFydCwgc3RvcCwgc3RlcCkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDw9IDEpIHsKCSAgICAgIHN0b3AgPSBzdGFydCB8fCAwOwoJICAgICAgc3RhcnQgPSAwOwoJICAgIH0KCSAgICBzdGVwID0gc3RlcCB8fCAxOwoKCSAgICB2YXIgbGVuZ3RoID0gTWF0aC5tYXgoTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCksIDApOwoJICAgIHZhciByYW5nZSA9IEFycmF5KGxlbmd0aCk7CgoJICAgIGZvciAodmFyIGlkeCA9IDA7IGlkeCA8IGxlbmd0aDsgaWR4KyssIHN0YXJ0ICs9IHN0ZXApIHsKCSAgICAgIHJhbmdlW2lkeF0gPSBzdGFydDsKCSAgICB9CgoJICAgIHJldHVybiByYW5nZTsKCSAgfTsKCgkgIC8vIEZ1bmN0aW9uIChhaGVtKSBGdW5jdGlvbnMKCSAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBSZXVzYWJsZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgcHJvdG90eXBlIHNldHRpbmcuCgkgIHZhciBDdG9yID0gZnVuY3Rpb24oKXt9OwoKCSAgLy8gQ3JlYXRlIGEgZnVuY3Rpb24gYm91bmQgdG8gYSBnaXZlbiBvYmplY3QgKGFzc2lnbmluZyBgdGhpc2AsIGFuZCBhcmd1bWVudHMsCgkgIC8vIG9wdGlvbmFsbHkpLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgRnVuY3Rpb24uYmluZGAgaWYKCSAgLy8gYXZhaWxhYmxlLgoJICBfLmJpbmQgPSBmdW5jdGlvbihmdW5jLCBjb250ZXh0KSB7CgkgICAgdmFyIGFyZ3MsIGJvdW5kOwoJICAgIGlmIChuYXRpdmVCaW5kICYmIGZ1bmMuYmluZCA9PT0gbmF0aXZlQmluZCkgcmV0dXJuIG5hdGl2ZUJpbmQuYXBwbHkoZnVuYywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCSAgICBpZiAoIV8uaXNGdW5jdGlvbihmdW5jKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignQmluZCBtdXN0IGJlIGNhbGxlZCBvbiBhIGZ1bmN0aW9uJyk7CgkgICAgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKCSAgICBib3VuZCA9IGZ1bmN0aW9uKCkgewoJICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGJvdW5kKSkgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CgkgICAgICBDdG9yLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwoJICAgICAgdmFyIHNlbGYgPSBuZXcgQ3RvcjsKCSAgICAgIEN0b3IucHJvdG90eXBlID0gbnVsbDsKCSAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHNlbGYsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwoJICAgICAgaWYgKF8uaXNPYmplY3QocmVzdWx0KSkgcmV0dXJuIHJlc3VsdDsKCSAgICAgIHJldHVybiBzZWxmOwoJICAgIH07CgkgICAgcmV0dXJuIGJvdW5kOwoJICB9OwoKCSAgLy8gUGFydGlhbGx5IGFwcGx5IGEgZnVuY3Rpb24gYnkgY3JlYXRpbmcgYSB2ZXJzaW9uIHRoYXQgaGFzIGhhZCBzb21lIG9mIGl0cwoJICAvLyBhcmd1bWVudHMgcHJlLWZpbGxlZCwgd2l0aG91dCBjaGFuZ2luZyBpdHMgZHluYW1pYyBgdGhpc2AgY29udGV4dC4gXyBhY3RzCgkgIC8vIGFzIGEgcGxhY2Vob2xkZXIsIGFsbG93aW5nIGFueSBjb21iaW5hdGlvbiBvZiBhcmd1bWVudHMgdG8gYmUgcHJlLWZpbGxlZC4KCSAgXy5wYXJ0aWFsID0gZnVuY3Rpb24oZnVuYykgewoJICAgIHZhciBib3VuZEFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIHBvc2l0aW9uID0gMDsKCSAgICAgIHZhciBhcmdzID0gYm91bmRBcmdzLnNsaWNlKCk7CgkgICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gYXJncy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICBpZiAoYXJnc1tpXSA9PT0gXykgYXJnc1tpXSA9IGFyZ3VtZW50c1twb3NpdGlvbisrXTsKCSAgICAgIH0KCSAgICAgIHdoaWxlIChwb3NpdGlvbiA8IGFyZ3VtZW50cy5sZW5ndGgpIGFyZ3MucHVzaChhcmd1bWVudHNbcG9zaXRpb24rK10pOwoJICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CgkgICAgfTsKCSAgfTsKCgkgIC8vIEJpbmQgYSBudW1iZXIgb2YgYW4gb2JqZWN0J3MgbWV0aG9kcyB0byB0aGF0IG9iamVjdC4gUmVtYWluaW5nIGFyZ3VtZW50cwoJICAvLyBhcmUgdGhlIG1ldGhvZCBuYW1lcyB0byBiZSBib3VuZC4gVXNlZnVsIGZvciBlbnN1cmluZyB0aGF0IGFsbCBjYWxsYmFja3MKCSAgLy8gZGVmaW5lZCBvbiBhbiBvYmplY3QgYmVsb25nIHRvIGl0LgoJICBfLmJpbmRBbGwgPSBmdW5jdGlvbihvYmopIHsKCSAgICB2YXIgaSwgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwga2V5OwoJICAgIGlmIChsZW5ndGggPD0gMSkgdGhyb3cgbmV3IEVycm9yKCdiaW5kQWxsIG11c3QgYmUgcGFzc2VkIGZ1bmN0aW9uIG5hbWVzJyk7CgkgICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICBrZXkgPSBhcmd1bWVudHNbaV07CgkgICAgICBvYmpba2V5XSA9IF8uYmluZChvYmpba2V5XSwgb2JqKTsKCSAgICB9CgkgICAgcmV0dXJuIG9iajsKCSAgfTsKCgkgIC8vIE1lbW9pemUgYW4gZXhwZW5zaXZlIGZ1bmN0aW9uIGJ5IHN0b3JpbmcgaXRzIHJlc3VsdHMuCgkgIF8ubWVtb2l6ZSA9IGZ1bmN0aW9uKGZ1bmMsIGhhc2hlcikgewoJICAgIHZhciBtZW1vaXplID0gZnVuY3Rpb24oa2V5KSB7CgkgICAgICB2YXIgY2FjaGUgPSBtZW1vaXplLmNhY2hlOwoJICAgICAgdmFyIGFkZHJlc3MgPSBoYXNoZXIgPyBoYXNoZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IGtleTsKCSAgICAgIGlmICghXy5oYXMoY2FjaGUsIGFkZHJlc3MpKSBjYWNoZVthZGRyZXNzXSA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgIHJldHVybiBjYWNoZVthZGRyZXNzXTsKCSAgICB9OwoJICAgIG1lbW9pemUuY2FjaGUgPSB7fTsKCSAgICByZXR1cm4gbWVtb2l6ZTsKCSAgfTsKCgkgIC8vIERlbGF5cyBhIGZ1bmN0aW9uIGZvciB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1pbGxpc2Vjb25kcywgYW5kIHRoZW4gY2FsbHMKCSAgLy8gaXQgd2l0aCB0aGUgYXJndW1lbnRzIHN1cHBsaWVkLgoJICBfLmRlbGF5ID0gZnVuY3Rpb24oZnVuYywgd2FpdCkgewoJICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoJICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgkgICAgICByZXR1cm4gZnVuYy5hcHBseShudWxsLCBhcmdzKTsKCSAgICB9LCB3YWl0KTsKCSAgfTsKCgkgIC8vIERlZmVycyBhIGZ1bmN0aW9uLCBzY2hlZHVsaW5nIGl0IHRvIHJ1biBhZnRlciB0aGUgY3VycmVudCBjYWxsIHN0YWNrIGhhcwoJICAvLyBjbGVhcmVkLgoJICBfLmRlZmVyID0gZnVuY3Rpb24oZnVuYykgewoJICAgIHJldHVybiBfLmRlbGF5LmFwcGx5KF8sIFtmdW5jLCAxXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIHdoZW4gaW52b2tlZCwgd2lsbCBvbmx5IGJlIHRyaWdnZXJlZCBhdCBtb3N0IG9uY2UKCSAgLy8gZHVyaW5nIGEgZ2l2ZW4gd2luZG93IG9mIHRpbWUuIE5vcm1hbGx5LCB0aGUgdGhyb3R0bGVkIGZ1bmN0aW9uIHdpbGwgcnVuCgkgIC8vIGFzIG11Y2ggYXMgaXQgY2FuLCB3aXRob3V0IGV2ZXIgZ29pbmcgbW9yZSB0aGFuIG9uY2UgcGVyIGB3YWl0YCBkdXJhdGlvbjsKCSAgLy8gYnV0IGlmIHlvdSdkIGxpa2UgdG8gZGlzYWJsZSB0aGUgZXhlY3V0aW9uIG9uIHRoZSBsZWFkaW5nIGVkZ2UsIHBhc3MKCSAgLy8gYHtsZWFkaW5nOiBmYWxzZX1gLiBUbyBkaXNhYmxlIGV4ZWN1dGlvbiBvbiB0aGUgdHJhaWxpbmcgZWRnZSwgZGl0dG8uCgkgIF8udGhyb3R0bGUgPSBmdW5jdGlvbihmdW5jLCB3YWl0LCBvcHRpb25zKSB7CgkgICAgdmFyIGNvbnRleHQsIGFyZ3MsIHJlc3VsdDsKCSAgICB2YXIgdGltZW91dCA9IG51bGw7CgkgICAgdmFyIHByZXZpb3VzID0gMDsKCSAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKCSAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKCSAgICAgIHByZXZpb3VzID0gb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSA/IDAgOiBfLm5vdygpOwoJICAgICAgdGltZW91dCA9IG51bGw7CgkgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwoJICAgICAgaWYgKCF0aW1lb3V0KSBjb250ZXh0ID0gYXJncyA9IG51bGw7CgkgICAgfTsKCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICB2YXIgbm93ID0gXy5ub3coKTsKCSAgICAgIGlmICghcHJldmlvdXMgJiYgb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSkgcHJldmlvdXMgPSBub3c7CgkgICAgICB2YXIgcmVtYWluaW5nID0gd2FpdCAtIChub3cgLSBwcmV2aW91cyk7CgkgICAgICBjb250ZXh0ID0gdGhpczsKCSAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CgkgICAgICBpZiAocmVtYWluaW5nIDw9IDAgfHwgcmVtYWluaW5nID4gd2FpdCkgewoJICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CgkgICAgICAgIHRpbWVvdXQgPSBudWxsOwoJICAgICAgICBwcmV2aW91cyA9IG5vdzsKCSAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKCSAgICAgICAgaWYgKCF0aW1lb3V0KSBjb250ZXh0ID0gYXJncyA9IG51bGw7CgkgICAgICB9IGVsc2UgaWYgKCF0aW1lb3V0ICYmIG9wdGlvbnMudHJhaWxpbmcgIT09IGZhbHNlKSB7CgkgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCByZW1haW5pbmcpOwoJICAgICAgfQoJICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICB9OwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCBhcyBsb25nIGFzIGl0IGNvbnRpbnVlcyB0byBiZSBpbnZva2VkLCB3aWxsIG5vdAoJICAvLyBiZSB0cmlnZ2VyZWQuIFRoZSBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCBhZnRlciBpdCBzdG9wcyBiZWluZyBjYWxsZWQgZm9yCgkgIC8vIE4gbWlsbGlzZWNvbmRzLiBJZiBgaW1tZWRpYXRlYCBpcyBwYXNzZWQsIHRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZQoJICAvLyBsZWFkaW5nIGVkZ2UsIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLgoJICBfLmRlYm91bmNlID0gZnVuY3Rpb24oZnVuYywgd2FpdCwgaW1tZWRpYXRlKSB7CgkgICAgdmFyIHRpbWVvdXQsIGFyZ3MsIGNvbnRleHQsIHRpbWVzdGFtcCwgcmVzdWx0OwoKCSAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKCSAgICAgIHZhciBsYXN0ID0gXy5ub3coKSAtIHRpbWVzdGFtcDsKCgkgICAgICBpZiAobGFzdCA8IHdhaXQgJiYgbGFzdCA+IDApIHsKCSAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQgLSBsYXN0KTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHRpbWVvdXQgPSBudWxsOwoJICAgICAgICBpZiAoIWltbWVkaWF0ZSkgewoJICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CgkgICAgICAgICAgaWYgKCF0aW1lb3V0KSBjb250ZXh0ID0gYXJncyA9IG51bGw7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9OwoKCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICBjb250ZXh0ID0gdGhpczsKCSAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CgkgICAgICB0aW1lc3RhbXAgPSBfLm5vdygpOwoJICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CgkgICAgICBpZiAoIXRpbWVvdXQpIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKCSAgICAgIGlmIChjYWxsTm93KSB7CgkgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CgkgICAgICAgIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKCSAgICAgIH0KCgkgICAgICByZXR1cm4gcmVzdWx0OwoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIHRoZSBmaXJzdCBmdW5jdGlvbiBwYXNzZWQgYXMgYW4gYXJndW1lbnQgdG8gdGhlIHNlY29uZCwKCSAgLy8gYWxsb3dpbmcgeW91IHRvIGFkanVzdCBhcmd1bWVudHMsIHJ1biBjb2RlIGJlZm9yZSBhbmQgYWZ0ZXIsIGFuZAoJICAvLyBjb25kaXRpb25hbGx5IGV4ZWN1dGUgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLgoJICBfLndyYXAgPSBmdW5jdGlvbihmdW5jLCB3cmFwcGVyKSB7CgkgICAgcmV0dXJuIF8ucGFydGlhbCh3cmFwcGVyLCBmdW5jKTsKCSAgfTsKCgkgIC8vIFJldHVybnMgYSBuZWdhdGVkIHZlcnNpb24gb2YgdGhlIHBhc3NlZC1pbiBwcmVkaWNhdGUuCgkgIF8ubmVnYXRlID0gZnVuY3Rpb24ocHJlZGljYXRlKSB7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuICFwcmVkaWNhdGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICB9OwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgaXMgdGhlIGNvbXBvc2l0aW9uIG9mIGEgbGlzdCBvZiBmdW5jdGlvbnMsIGVhY2gKCSAgLy8gY29uc3VtaW5nIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KCSAgXy5jb21wb3NlID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CgkgICAgdmFyIHN0YXJ0ID0gYXJncy5sZW5ndGggLSAxOwoJICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgIHZhciBpID0gc3RhcnQ7CgkgICAgICB2YXIgcmVzdWx0ID0gYXJnc1tzdGFydF0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgIHdoaWxlIChpLS0pIHJlc3VsdCA9IGFyZ3NbaV0uY2FsbCh0aGlzLCByZXN1bHQpOwoJICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICB9OwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIGFmdGVyIGJlaW5nIGNhbGxlZCBOIHRpbWVzLgoJICBfLmFmdGVyID0gZnVuY3Rpb24odGltZXMsIGZ1bmMpIHsKCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICBpZiAoLS10aW1lcyA8IDEpIHsKCSAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgIH0KCSAgICB9OwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIGJlZm9yZSBiZWluZyBjYWxsZWQgTiB0aW1lcy4KCSAgXy5iZWZvcmUgPSBmdW5jdGlvbih0aW1lcywgZnVuYykgewoJICAgIHZhciBtZW1vOwoJICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgIGlmICgtLXRpbWVzID4gMCkgewoJICAgICAgICBtZW1vID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgZnVuYyA9IG51bGw7CgkgICAgICB9CgkgICAgICByZXR1cm4gbWVtbzsKCSAgICB9OwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCBhdCBtb3N0IG9uZSB0aW1lLCBubyBtYXR0ZXIgaG93CgkgIC8vIG9mdGVuIHlvdSBjYWxsIGl0LiBVc2VmdWwgZm9yIGxhenkgaW5pdGlhbGl6YXRpb24uCgkgIF8ub25jZSA9IF8ucGFydGlhbChfLmJlZm9yZSwgMik7CgoJICAvLyBPYmplY3QgRnVuY3Rpb25zCgkgIC8vIC0tLS0tLS0tLS0tLS0tLS0KCgkgIC8vIFJldHJpZXZlIHRoZSBuYW1lcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgoJICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgT2JqZWN0LmtleXNgCgkgIF8ua2V5cyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gW107CgkgICAgaWYgKG5hdGl2ZUtleXMpIHJldHVybiBuYXRpdmVLZXlzKG9iaik7CgkgICAgdmFyIGtleXMgPSBbXTsKCSAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSBrZXlzLnB1c2goa2V5KTsKCSAgICByZXR1cm4ga2V5czsKCSAgfTsKCgkgIC8vIFJldHJpZXZlIHRoZSB2YWx1ZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KCSAgXy52YWx1ZXMgPSBmdW5jdGlvbihvYmopIHsKCSAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwoJICAgIHZhciBsZW5ndGggPSBrZXlzLmxlbmd0aDsKCSAgICB2YXIgdmFsdWVzID0gQXJyYXkobGVuZ3RoKTsKCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICB2YWx1ZXNbaV0gPSBvYmpba2V5c1tpXV07CgkgICAgfQoJICAgIHJldHVybiB2YWx1ZXM7CgkgIH07CgoJICAvLyBDb252ZXJ0IGFuIG9iamVjdCBpbnRvIGEgbGlzdCBvZiBgW2tleSwgdmFsdWVdYCBwYWlycy4KCSAgXy5wYWlycyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CgkgICAgdmFyIGxlbmd0aCA9IGtleXMubGVuZ3RoOwoJICAgIHZhciBwYWlycyA9IEFycmF5KGxlbmd0aCk7CgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgcGFpcnNbaV0gPSBba2V5c1tpXSwgb2JqW2tleXNbaV1dXTsKCSAgICB9CgkgICAgcmV0dXJuIHBhaXJzOwoJICB9OwoKCSAgLy8gSW52ZXJ0IHRoZSBrZXlzIGFuZCB2YWx1ZXMgb2YgYW4gb2JqZWN0LiBUaGUgdmFsdWVzIG11c3QgYmUgc2VyaWFsaXphYmxlLgoJICBfLmludmVydCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciByZXN1bHQgPSB7fTsKCSAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwoJICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICByZXN1bHRbb2JqW2tleXNbaV1dXSA9IGtleXNbaV07CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH07CgoJICAvLyBSZXR1cm4gYSBzb3J0ZWQgbGlzdCBvZiB0aGUgZnVuY3Rpb24gbmFtZXMgYXZhaWxhYmxlIG9uIHRoZSBvYmplY3QuCgkgIC8vIEFsaWFzZWQgYXMgYG1ldGhvZHNgCgkgIF8uZnVuY3Rpb25zID0gXy5tZXRob2RzID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIG5hbWVzID0gW107CgkgICAgZm9yICh2YXIga2V5IGluIG9iaikgewoJICAgICAgaWYgKF8uaXNGdW5jdGlvbihvYmpba2V5XSkpIG5hbWVzLnB1c2goa2V5KTsKCSAgICB9CgkgICAgcmV0dXJuIG5hbWVzLnNvcnQoKTsKCSAgfTsKCgkgIC8vIEV4dGVuZCBhIGdpdmVuIG9iamVjdCB3aXRoIGFsbCB0aGUgcHJvcGVydGllcyBpbiBwYXNzZWQtaW4gb2JqZWN0KHMpLgoJICBfLmV4dGVuZCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gb2JqOwoJICAgIHZhciBzb3VyY2UsIHByb3A7CgkgICAgZm9yICh2YXIgaSA9IDEsIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgc291cmNlID0gYXJndW1lbnRzW2ldOwoJICAgICAgZm9yIChwcm9wIGluIHNvdXJjZSkgewoJICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIHByb3ApKSB7CgkgICAgICAgICAgICBvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF07CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIG9iajsKCSAgfTsKCgkgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCBvbmx5IGNvbnRhaW5pbmcgdGhlIHdoaXRlbGlzdGVkIHByb3BlcnRpZXMuCgkgIF8ucGljayA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICB2YXIgcmVzdWx0ID0ge30sIGtleTsKCSAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHQ7CgkgICAgaWYgKF8uaXNGdW5jdGlvbihpdGVyYXRlZSkpIHsKCSAgICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQpOwoJICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CgkgICAgICAgIHZhciB2YWx1ZSA9IG9ialtrZXldOwoJICAgICAgICBpZiAoaXRlcmF0ZWUodmFsdWUsIGtleSwgb2JqKSkgcmVzdWx0W2tleV0gPSB2YWx1ZTsKCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgdmFyIGtleXMgPSBjb25jYXQuYXBwbHkoW10sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CgkgICAgICBvYmogPSBuZXcgT2JqZWN0KG9iaik7CgkgICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0ga2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICBrZXkgPSBrZXlzW2ldOwoJICAgICAgICBpZiAoa2V5IGluIG9iaikgcmVzdWx0W2tleV0gPSBvYmpba2V5XTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgd2l0aG91dCB0aGUgYmxhY2tsaXN0ZWQgcHJvcGVydGllcy4KCSAgXy5vbWl0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIGlmIChfLmlzRnVuY3Rpb24oaXRlcmF0ZWUpKSB7CgkgICAgICBpdGVyYXRlZSA9IF8ubmVnYXRlKGl0ZXJhdGVlKTsKCSAgICB9IGVsc2UgewoJICAgICAgdmFyIGtleXMgPSBfLm1hcChjb25jYXQuYXBwbHkoW10sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSksIFN0cmluZyk7CgkgICAgICBpdGVyYXRlZSA9IGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKCSAgICAgICAgcmV0dXJuICFfLmNvbnRhaW5zKGtleXMsIGtleSk7CgkgICAgICB9OwoJICAgIH0KCSAgICByZXR1cm4gXy5waWNrKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpOwoJICB9OwoKCSAgLy8gRmlsbCBpbiBhIGdpdmVuIG9iamVjdCB3aXRoIGRlZmF1bHQgcHJvcGVydGllcy4KCSAgXy5kZWZhdWx0cyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gb2JqOwoJICAgIGZvciAodmFyIGkgPSAxLCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV07CgkgICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewoJICAgICAgICBpZiAob2JqW3Byb3BdID09PSB2b2lkIDApIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIG9iajsKCSAgfTsKCgkgIC8vIENyZWF0ZSBhIChzaGFsbG93LWNsb25lZCkgZHVwbGljYXRlIG9mIGFuIG9iamVjdC4KCSAgXy5jbG9uZSA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gb2JqOwoJICAgIHJldHVybiBfLmlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogXy5leHRlbmQoe30sIG9iaik7CgkgIH07CgoJICAvLyBJbnZva2VzIGludGVyY2VwdG9yIHdpdGggdGhlIG9iaiwgYW5kIHRoZW4gcmV0dXJucyBvYmouCgkgIC8vIFRoZSBwcmltYXJ5IHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwgaW4KCSAgLy8gb3JkZXIgdG8gcGVyZm9ybSBvcGVyYXRpb25zIG9uIGludGVybWVkaWF0ZSByZXN1bHRzIHdpdGhpbiB0aGUgY2hhaW4uCgkgIF8udGFwID0gZnVuY3Rpb24ob2JqLCBpbnRlcmNlcHRvcikgewoJICAgIGludGVyY2VwdG9yKG9iaik7CgkgICAgcmV0dXJuIG9iajsKCSAgfTsKCgkgIC8vIEludGVybmFsIHJlY3Vyc2l2ZSBjb21wYXJpc29uIGZ1bmN0aW9uIGZvciBgaXNFcXVhbGAuCgkgIHZhciBlcSA9IGZ1bmN0aW9uKGEsIGIsIGFTdGFjaywgYlN0YWNrKSB7CgkgICAgLy8gSWRlbnRpY2FsIG9iamVjdHMgYXJlIGVxdWFsLiBgMCA9PT0gLTBgLCBidXQgdGhleSBhcmVuJ3QgaWRlbnRpY2FsLgoJICAgIC8vIFNlZSB0aGUgW0hhcm1vbnkgYGVnYWxgIHByb3Bvc2FsXShodHRwOi8vd2lraS5lY21hc2NyaXB0Lm9yZy9kb2t1LnBocD9pZD1oYXJtb255OmVnYWwpLgoJICAgIGlmIChhID09PSBiKSByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PT0gMSAvIGI7CgkgICAgLy8gQSBzdHJpY3QgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkgYmVjYXVzZSBgbnVsbCA9PSB1bmRlZmluZWRgLgoJICAgIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSByZXR1cm4gYSA9PT0gYjsKCSAgICAvLyBVbndyYXAgYW55IHdyYXBwZWQgb2JqZWN0cy4KCSAgICBpZiAoYSBpbnN0YW5jZW9mIF8pIGEgPSBhLl93cmFwcGVkOwoJICAgIGlmIChiIGluc3RhbmNlb2YgXykgYiA9IGIuX3dyYXBwZWQ7CgkgICAgLy8gQ29tcGFyZSBgW1tDbGFzc11dYCBuYW1lcy4KCSAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbChhKTsKCSAgICBpZiAoY2xhc3NOYW1lICE9PSB0b1N0cmluZy5jYWxsKGIpKSByZXR1cm4gZmFsc2U7CgkgICAgc3dpdGNoIChjbGFzc05hbWUpIHsKCSAgICAgIC8vIFN0cmluZ3MsIG51bWJlcnMsIHJlZ3VsYXIgZXhwcmVzc2lvbnMsIGRhdGVzLCBhbmQgYm9vbGVhbnMgYXJlIGNvbXBhcmVkIGJ5IHZhbHVlLgoJICAgICAgY2FzZSAnW29iamVjdCBSZWdFeHBdJzoKCSAgICAgIC8vIFJlZ0V4cHMgYXJlIGNvZXJjZWQgdG8gc3RyaW5ncyBmb3IgY29tcGFyaXNvbiAoTm90ZTogJycgKyAvYS9pID09PSAnL2EvaScpCgkgICAgICBjYXNlICdbb2JqZWN0IFN0cmluZ10nOgoJICAgICAgICAvLyBQcmltaXRpdmVzIGFuZCB0aGVpciBjb3JyZXNwb25kaW5nIG9iamVjdCB3cmFwcGVycyBhcmUgZXF1aXZhbGVudDsgdGh1cywgYCI1ImAgaXMKCSAgICAgICAgLy8gZXF1aXZhbGVudCB0byBgbmV3IFN0cmluZygiNSIpYC4KCSAgICAgICAgcmV0dXJuICcnICsgYSA9PT0gJycgKyBiOwoJICAgICAgY2FzZSAnW29iamVjdCBOdW1iZXJdJzoKCSAgICAgICAgLy8gYE5hTmBzIGFyZSBlcXVpdmFsZW50LCBidXQgbm9uLXJlZmxleGl2ZS4KCSAgICAgICAgLy8gT2JqZWN0KE5hTikgaXMgZXF1aXZhbGVudCB0byBOYU4KCSAgICAgICAgaWYgKCthICE9PSArYSkgcmV0dXJuICtiICE9PSArYjsKCSAgICAgICAgLy8gQW4gYGVnYWxgIGNvbXBhcmlzb24gaXMgcGVyZm9ybWVkIGZvciBvdGhlciBudW1lcmljIHZhbHVlcy4KCSAgICAgICAgcmV0dXJuICthID09PSAwID8gMSAvICthID09PSAxIC8gYiA6ICthID09PSArYjsKCSAgICAgIGNhc2UgJ1tvYmplY3QgRGF0ZV0nOgoJICAgICAgY2FzZSAnW29iamVjdCBCb29sZWFuXSc6CgkgICAgICAgIC8vIENvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtZXJpYyBwcmltaXRpdmUgdmFsdWVzLiBEYXRlcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIKCSAgICAgICAgLy8gbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zLiBOb3RlIHRoYXQgaW52YWxpZCBkYXRlcyB3aXRoIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucwoJICAgICAgICAvLyBvZiBgTmFOYCBhcmUgbm90IGVxdWl2YWxlbnQuCgkgICAgICAgIHJldHVybiArYSA9PT0gK2I7CgkgICAgfQoJICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlOwoJICAgIC8vIEFzc3VtZSBlcXVhbGl0eSBmb3IgY3ljbGljIHN0cnVjdHVyZXMuIFRoZSBhbGdvcml0aG0gZm9yIGRldGVjdGluZyBjeWNsaWMKCSAgICAvLyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEgc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYC4KCSAgICB2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKCSAgICB3aGlsZSAobGVuZ3RoLS0pIHsKCSAgICAgIC8vIExpbmVhciBzZWFyY2guIFBlcmZvcm1hbmNlIGlzIGludmVyc2VseSBwcm9wb3J0aW9uYWwgdG8gdGhlIG51bWJlciBvZgoJICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgoJICAgICAgaWYgKGFTdGFja1tsZW5ndGhdID09PSBhKSByZXR1cm4gYlN0YWNrW2xlbmd0aF0gPT09IGI7CgkgICAgfQoJICAgIC8vIE9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudCwgYnV0IGBPYmplY3RgcwoJICAgIC8vIGZyb20gZGlmZmVyZW50IGZyYW1lcyBhcmUuCgkgICAgdmFyIGFDdG9yID0gYS5jb25zdHJ1Y3RvciwgYkN0b3IgPSBiLmNvbnN0cnVjdG9yOwoJICAgIGlmICgKCSAgICAgIGFDdG9yICE9PSBiQ3RvciAmJgoJICAgICAgLy8gSGFuZGxlIE9iamVjdC5jcmVhdGUoeCkgY2FzZXMKCSAgICAgICdjb25zdHJ1Y3RvcicgaW4gYSAmJiAnY29uc3RydWN0b3InIGluIGIgJiYKCSAgICAgICEoXy5pc0Z1bmN0aW9uKGFDdG9yKSAmJiBhQ3RvciBpbnN0YW5jZW9mIGFDdG9yICYmCgkgICAgICAgIF8uaXNGdW5jdGlvbihiQ3RvcikgJiYgYkN0b3IgaW5zdGFuY2VvZiBiQ3RvcikKCSAgICApIHsKCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9CgkgICAgLy8gQWRkIHRoZSBmaXJzdCBvYmplY3QgdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgoJICAgIGFTdGFjay5wdXNoKGEpOwoJICAgIGJTdGFjay5wdXNoKGIpOwoJICAgIHZhciBzaXplLCByZXN1bHQ7CgkgICAgLy8gUmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMuCgkgICAgaWYgKGNsYXNzTmFtZSA9PT0gJ1tvYmplY3QgQXJyYXldJykgewoJICAgICAgLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCgkgICAgICBzaXplID0gYS5sZW5ndGg7CgkgICAgICByZXN1bHQgPSBzaXplID09PSBiLmxlbmd0aDsKCSAgICAgIGlmIChyZXN1bHQpIHsKCSAgICAgICAgLy8gRGVlcCBjb21wYXJlIHRoZSBjb250ZW50cywgaWdub3Jpbmcgbm9uLW51bWVyaWMgcHJvcGVydGllcy4KCSAgICAgICAgd2hpbGUgKHNpemUtLSkgewoJICAgICAgICAgIGlmICghKHJlc3VsdCA9IGVxKGFbc2l6ZV0sIGJbc2l6ZV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIC8vIERlZXAgY29tcGFyZSBvYmplY3RzLgoJICAgICAgdmFyIGtleXMgPSBfLmtleXMoYSksIGtleTsKCSAgICAgIHNpemUgPSBrZXlzLmxlbmd0aDsKCSAgICAgIC8vIEVuc3VyZSB0aGF0IGJvdGggb2JqZWN0cyBjb250YWluIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzIGJlZm9yZSBjb21wYXJpbmcgZGVlcCBlcXVhbGl0eS4KCSAgICAgIHJlc3VsdCA9IF8ua2V5cyhiKS5sZW5ndGggPT09IHNpemU7CgkgICAgICBpZiAocmVzdWx0KSB7CgkgICAgICAgIHdoaWxlIChzaXplLS0pIHsKCSAgICAgICAgICAvLyBEZWVwIGNvbXBhcmUgZWFjaCBtZW1iZXIKCSAgICAgICAgICBrZXkgPSBrZXlzW3NpemVdOwoJICAgICAgICAgIGlmICghKHJlc3VsdCA9IF8uaGFzKGIsIGtleSkgJiYgZXEoYVtrZXldLCBiW2tleV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICAgIC8vIFJlbW92ZSB0aGUgZmlyc3Qgb2JqZWN0IGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgoJICAgIGFTdGFjay5wb3AoKTsKCSAgICBiU3RhY2sucG9wKCk7CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgIC8vIFBlcmZvcm0gYSBkZWVwIGNvbXBhcmlzb24gdG8gY2hlY2sgaWYgdHdvIG9iamVjdHMgYXJlIGVxdWFsLgoJICBfLmlzRXF1YWwgPSBmdW5jdGlvbihhLCBiKSB7CgkgICAgcmV0dXJuIGVxKGEsIGIsIFtdLCBbXSk7CgkgIH07CgoJICAvLyBJcyBhIGdpdmVuIGFycmF5LCBzdHJpbmcsIG9yIG9iamVjdCBlbXB0eT8KCSAgLy8gQW4gImVtcHR5IiBvYmplY3QgaGFzIG5vIGVudW1lcmFibGUgb3duLXByb3BlcnRpZXMuCgkgIF8uaXNFbXB0eSA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHRydWU7CgkgICAgaWYgKF8uaXNBcnJheShvYmopIHx8IF8uaXNTdHJpbmcob2JqKSB8fCBfLmlzQXJndW1lbnRzKG9iaikpIHJldHVybiBvYmoubGVuZ3RoID09PSAwOwoJICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJldHVybiBmYWxzZTsKCSAgICByZXR1cm4gdHJ1ZTsKCSAgfTsKCgkgIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBET00gZWxlbWVudD8KCSAgXy5pc0VsZW1lbnQgPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gISEob2JqICYmIG9iai5ub2RlVHlwZSA9PT0gMSk7CgkgIH07CgoJICAvLyBJcyBhIGdpdmVuIHZhbHVlIGFuIGFycmF5PwoJICAvLyBEZWxlZ2F0ZXMgdG8gRUNNQTUncyBuYXRpdmUgQXJyYXkuaXNBcnJheQoJICBfLmlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEFycmF5XSc7CgkgIH07CgoJICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIGFuIG9iamVjdD8KCSAgXy5pc09iamVjdCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciB0eXBlID0gdHlwZW9mIG9iajsKCSAgICByZXR1cm4gdHlwZSA9PT0gJ2Z1bmN0aW9uJyB8fCB0eXBlID09PSAnb2JqZWN0JyAmJiAhIW9iajsKCSAgfTsKCgkgIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgoJICBfLmVhY2goWydBcmd1bWVudHMnLCAnRnVuY3Rpb24nLCAnU3RyaW5nJywgJ051bWJlcicsICdEYXRlJywgJ1JlZ0V4cCddLCBmdW5jdGlvbihuYW1lKSB7CgkgICAgX1snaXMnICsgbmFtZV0gPSBmdW5jdGlvbihvYmopIHsKCSAgICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCgkgIC8vIHRoZXJlIGlzbid0IGFueSBpbnNwZWN0YWJsZSAiQXJndW1lbnRzIiB0eXBlLgoJICBpZiAoIV8uaXNBcmd1bWVudHMoYXJndW1lbnRzKSkgewoJICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbihvYmopIHsKCSAgICAgIHJldHVybiBfLmhhcyhvYmosICdjYWxsZWUnKTsKCSAgICB9OwoJICB9CgoJICAvLyBPcHRpbWl6ZSBgaXNGdW5jdGlvbmAgaWYgYXBwcm9wcmlhdGUuIFdvcmsgYXJvdW5kIGFuIElFIDExIGJ1Zy4KCSAgaWYgKHRydWUpIHsKCSAgICBfLmlzRnVuY3Rpb24gPSBmdW5jdGlvbihvYmopIHsKCSAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09ICdmdW5jdGlvbicgfHwgZmFsc2U7CgkgICAgfTsKCSAgfQoKCSAgLy8gSXMgYSBnaXZlbiBvYmplY3QgYSBmaW5pdGUgbnVtYmVyPwoJICBfLmlzRmluaXRlID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgcmV0dXJuIGlzRmluaXRlKG9iaikgJiYgIWlzTmFOKHBhcnNlRmxvYXQob2JqKSk7CgkgIH07CgoJICAvLyBJcyB0aGUgZ2l2ZW4gdmFsdWUgYE5hTmA/IChOYU4gaXMgdGhlIG9ubHkgbnVtYmVyIHdoaWNoIGRvZXMgbm90IGVxdWFsIGl0c2VsZikuCgkgIF8uaXNOYU4gPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIG9iaiAhPT0gK29iajsKCSAgfTsKCgkgIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwoJICBfLmlzQm9vbGVhbiA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiBvYmogPT09IHRydWUgfHwgb2JqID09PSBmYWxzZSB8fCB0b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEJvb2xlYW5dJzsKCSAgfTsKCgkgIC8vIElzIGEgZ2l2ZW4gdmFsdWUgZXF1YWwgdG8gbnVsbD8KCSAgXy5pc051bGwgPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gb2JqID09PSBudWxsOwoJICB9OwoKCSAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSB1bmRlZmluZWQ/CgkgIF8uaXNVbmRlZmluZWQgPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gb2JqID09PSB2b2lkIDA7CgkgIH07CgoJICAvLyBTaG9ydGN1dCBmdW5jdGlvbiBmb3IgY2hlY2tpbmcgaWYgYW4gb2JqZWN0IGhhcyBhIGdpdmVuIHByb3BlcnR5IGRpcmVjdGx5CgkgIC8vIG9uIGl0c2VsZiAoaW4gb3RoZXIgd29yZHMsIG5vdCBvbiBhIHByb3RvdHlwZSkuCgkgIF8uaGFzID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKCSAgICByZXR1cm4gb2JqICE9IG51bGwgJiYgaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSk7CgkgIH07CgoJICAvLyBVdGlsaXR5IEZ1bmN0aW9ucwoJICAvLyAtLS0tLS0tLS0tLS0tLS0tLQoKCSAgLy8gUnVuIFVuZGVyc2NvcmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYF9gIHZhcmlhYmxlIHRvIGl0cwoJICAvLyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCgkgIF8ubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewoJICAgIHJvb3QuXyA9IHByZXZpb3VzVW5kZXJzY29yZTsKCSAgICByZXR1cm4gdGhpczsKCSAgfTsKCgkgIC8vIEtlZXAgdGhlIGlkZW50aXR5IGZ1bmN0aW9uIGFyb3VuZCBmb3IgZGVmYXVsdCBpdGVyYXRlZXMuCgkgIF8uaWRlbnRpdHkgPSBmdW5jdGlvbih2YWx1ZSkgewoJICAgIHJldHVybiB2YWx1ZTsKCSAgfTsKCgkgIF8uY29uc3RhbnQgPSBmdW5jdGlvbih2YWx1ZSkgewoJICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiB2YWx1ZTsKCSAgICB9OwoJICB9OwoKCSAgXy5ub29wID0gZnVuY3Rpb24oKXt9OwoKCSAgXy5wcm9wZXJ0eSA9IGZ1bmN0aW9uKGtleSkgewoJICAgIHJldHVybiBmdW5jdGlvbihvYmopIHsKCSAgICAgIHJldHVybiBvYmpba2V5XTsKCSAgICB9OwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIHByZWRpY2F0ZSBmb3IgY2hlY2tpbmcgd2hldGhlciBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gc2V0IG9mIGBrZXk6dmFsdWVgIHBhaXJzLgoJICBfLm1hdGNoZXMgPSBmdW5jdGlvbihhdHRycykgewoJICAgIHZhciBwYWlycyA9IF8ucGFpcnMoYXR0cnMpLCBsZW5ndGggPSBwYWlycy5sZW5ndGg7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKG9iaikgewoJICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gIWxlbmd0aDsKCSAgICAgIG9iaiA9IG5ldyBPYmplY3Qob2JqKTsKCSAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgICAgdmFyIHBhaXIgPSBwYWlyc1tpXSwga2V5ID0gcGFpclswXTsKCSAgICAgICAgaWYgKHBhaXJbMV0gIT09IG9ialtrZXldIHx8ICEoa2V5IGluIG9iaikpIHJldHVybiBmYWxzZTsKCSAgICAgIH0KCSAgICAgIHJldHVybiB0cnVlOwoJICAgIH07CgkgIH07CgoJICAvLyBSdW4gYSBmdW5jdGlvbiAqKm4qKiB0aW1lcy4KCSAgXy50aW1lcyA9IGZ1bmN0aW9uKG4sIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgdmFyIGFjY3VtID0gQXJyYXkoTWF0aC5tYXgoMCwgbikpOwoJICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQsIDEpOwoJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSBhY2N1bVtpXSA9IGl0ZXJhdGVlKGkpOwoJICAgIHJldHVybiBhY2N1bTsKCSAgfTsKCgkgIC8vIFJldHVybiBhIHJhbmRvbSBpbnRlZ2VyIGJldHdlZW4gbWluIGFuZCBtYXggKGluY2x1c2l2ZSkuCgkgIF8ucmFuZG9tID0gZnVuY3Rpb24obWluLCBtYXgpIHsKCSAgICBpZiAobWF4ID09IG51bGwpIHsKCSAgICAgIG1heCA9IG1pbjsKCSAgICAgIG1pbiA9IDA7CgkgICAgfQoJICAgIHJldHVybiBtaW4gKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkpOwoJICB9OwoKCSAgLy8gQSAocG9zc2libHkgZmFzdGVyKSB3YXkgdG8gZ2V0IHRoZSBjdXJyZW50IHRpbWVzdGFtcCBhcyBhbiBpbnRlZ2VyLgoJICBfLm5vdyA9IERhdGUubm93IHx8IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCSAgfTsKCgkgICAvLyBMaXN0IG9mIEhUTUwgZW50aXRpZXMgZm9yIGVzY2FwaW5nLgoJICB2YXIgZXNjYXBlTWFwID0gewoJICAgICcmJzogJyZhbXA7JywKCSAgICAnPCc6ICcmbHQ7JywKCSAgICAnPic6ICcmZ3Q7JywKCSAgICAnIic6ICcmcXVvdDsnLAoJICAgICInIjogJyYjeDI3OycsCgkgICAgJ2AnOiAnJiN4NjA7JwoJICB9OwoJICB2YXIgdW5lc2NhcGVNYXAgPSBfLmludmVydChlc2NhcGVNYXApOwoKCSAgLy8gRnVuY3Rpb25zIGZvciBlc2NhcGluZyBhbmQgdW5lc2NhcGluZyBzdHJpbmdzIHRvL2Zyb20gSFRNTCBpbnRlcnBvbGF0aW9uLgoJICB2YXIgY3JlYXRlRXNjYXBlciA9IGZ1bmN0aW9uKG1hcCkgewoJICAgIHZhciBlc2NhcGVyID0gZnVuY3Rpb24obWF0Y2gpIHsKCSAgICAgIHJldHVybiBtYXBbbWF0Y2hdOwoJICAgIH07CgkgICAgLy8gUmVnZXhlcyBmb3IgaWRlbnRpZnlpbmcgYSBrZXkgdGhhdCBuZWVkcyB0byBiZSBlc2NhcGVkCgkgICAgdmFyIHNvdXJjZSA9ICcoPzonICsgXy5rZXlzKG1hcCkuam9pbignfCcpICsgJyknOwoJICAgIHZhciB0ZXN0UmVnZXhwID0gUmVnRXhwKHNvdXJjZSk7CgkgICAgdmFyIHJlcGxhY2VSZWdleHAgPSBSZWdFeHAoc291cmNlLCAnZycpOwoJICAgIHJldHVybiBmdW5jdGlvbihzdHJpbmcpIHsKCSAgICAgIHN0cmluZyA9IHN0cmluZyA9PSBudWxsID8gJycgOiAnJyArIHN0cmluZzsKCSAgICAgIHJldHVybiB0ZXN0UmVnZXhwLnRlc3Qoc3RyaW5nKSA/IHN0cmluZy5yZXBsYWNlKHJlcGxhY2VSZWdleHAsIGVzY2FwZXIpIDogc3RyaW5nOwoJICAgIH07CgkgIH07CgkgIF8uZXNjYXBlID0gY3JlYXRlRXNjYXBlcihlc2NhcGVNYXApOwoJICBfLnVuZXNjYXBlID0gY3JlYXRlRXNjYXBlcih1bmVzY2FwZU1hcCk7CgoJICAvLyBJZiB0aGUgdmFsdWUgb2YgdGhlIG5hbWVkIGBwcm9wZXJ0eWAgaXMgYSBmdW5jdGlvbiB0aGVuIGludm9rZSBpdCB3aXRoIHRoZQoJICAvLyBgb2JqZWN0YCBhcyBjb250ZXh0OyBvdGhlcndpc2UsIHJldHVybiBpdC4KCSAgXy5yZXN1bHQgPSBmdW5jdGlvbihvYmplY3QsIHByb3BlcnR5KSB7CgkgICAgaWYgKG9iamVjdCA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwoJICAgIHZhciB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07CgkgICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyBvYmplY3RbcHJvcGVydHldKCkgOiB2YWx1ZTsKCSAgfTsKCgkgIC8vIEdlbmVyYXRlIGEgdW5pcXVlIGludGVnZXIgaWQgKHVuaXF1ZSB3aXRoaW4gdGhlIGVudGlyZSBjbGllbnQgc2Vzc2lvbikuCgkgIC8vIFVzZWZ1bCBmb3IgdGVtcG9yYXJ5IERPTSBpZHMuCgkgIHZhciBpZENvdW50ZXIgPSAwOwoJICBfLnVuaXF1ZUlkID0gZnVuY3Rpb24ocHJlZml4KSB7CgkgICAgdmFyIGlkID0gKytpZENvdW50ZXIgKyAnJzsKCSAgICByZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKCSAgfTsKCgkgIC8vIEJ5IGRlZmF1bHQsIFVuZGVyc2NvcmUgdXNlcyBFUkItc3R5bGUgdGVtcGxhdGUgZGVsaW1pdGVycywgY2hhbmdlIHRoZQoJICAvLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCgkgIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKCSAgICBldmFsdWF0ZSAgICA6IC88JShbXHNcU10rPyklPi9nLAoJICAgIGludGVycG9sYXRlIDogLzwlPShbXHNcU10rPyklPi9nLAoJICAgIGVzY2FwZSAgICAgIDogLzwlLShbXHNcU10rPyklPi9nCgkgIH07CgoJICAvLyBXaGVuIGN1c3RvbWl6aW5nIGB0ZW1wbGF0ZVNldHRpbmdzYCwgaWYgeW91IGRvbid0IHdhbnQgdG8gZGVmaW5lIGFuCgkgIC8vIGludGVycG9sYXRpb24sIGV2YWx1YXRpb24gb3IgZXNjYXBpbmcgcmVnZXgsIHdlIG5lZWQgb25lIHRoYXQgaXMKCSAgLy8gZ3VhcmFudGVlZCBub3QgdG8gbWF0Y2guCgkgIHZhciBub01hdGNoID0gLyguKV4vOwoKCSAgLy8gQ2VydGFpbiBjaGFyYWN0ZXJzIG5lZWQgdG8gYmUgZXNjYXBlZCBzbyB0aGF0IHRoZXkgY2FuIGJlIHB1dCBpbnRvIGEKCSAgLy8gc3RyaW5nIGxpdGVyYWwuCgkgIHZhciBlc2NhcGVzID0gewoJICAgICInIjogICAgICAiJyIsCgkgICAgJ1xcJzogICAgICdcXCcsCgkgICAgJ1xyJzogICAgICdyJywKCSAgICAnXG4nOiAgICAgJ24nLAoJICAgICdcdTIwMjgnOiAndTIwMjgnLAoJICAgICdcdTIwMjknOiAndTIwMjknCgkgIH07CgoJICB2YXIgZXNjYXBlciA9IC9cXHwnfFxyfFxufFx1MjAyOHxcdTIwMjkvZzsKCgkgIHZhciBlc2NhcGVDaGFyID0gZnVuY3Rpb24obWF0Y2gpIHsKCSAgICByZXR1cm4gJ1xcJyArIGVzY2FwZXNbbWF0Y2hdOwoJICB9OwoKCSAgLy8gSmF2YVNjcmlwdCBtaWNyby10ZW1wbGF0aW5nLCBzaW1pbGFyIHRvIEpvaG4gUmVzaWcncyBpbXBsZW1lbnRhdGlvbi4KCSAgLy8gVW5kZXJzY29yZSB0ZW1wbGF0aW5nIGhhbmRsZXMgYXJiaXRyYXJ5IGRlbGltaXRlcnMsIHByZXNlcnZlcyB3aGl0ZXNwYWNlLAoJICAvLyBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KCSAgLy8gTkI6IGBvbGRTZXR0aW5nc2Agb25seSBleGlzdHMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgoJICBfLnRlbXBsYXRlID0gZnVuY3Rpb24odGV4dCwgc2V0dGluZ3MsIG9sZFNldHRpbmdzKSB7CgkgICAgaWYgKCFzZXR0aW5ncyAmJiBvbGRTZXR0aW5ncykgc2V0dGluZ3MgPSBvbGRTZXR0aW5nczsKCSAgICBzZXR0aW5ncyA9IF8uZGVmYXVsdHMoe30sIHNldHRpbmdzLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwoKCSAgICAvLyBDb21iaW5lIGRlbGltaXRlcnMgaW50byBvbmUgcmVndWxhciBleHByZXNzaW9uIHZpYSBhbHRlcm5hdGlvbi4KCSAgICB2YXIgbWF0Y2hlciA9IFJlZ0V4cChbCgkgICAgICAoc2V0dGluZ3MuZXNjYXBlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKCSAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCgkgICAgICAoc2V0dGluZ3MuZXZhbHVhdGUgfHwgbm9NYXRjaCkuc291cmNlCgkgICAgXS5qb2luKCd8JykgKyAnfCQnLCAnZycpOwoKCSAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgoJICAgIHZhciBpbmRleCA9IDA7CgkgICAgdmFyIHNvdXJjZSA9ICJfX3ArPSciOwoJICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewoJICAgICAgc291cmNlICs9IHRleHQuc2xpY2UoaW5kZXgsIG9mZnNldCkucmVwbGFjZShlc2NhcGVyLCBlc2NhcGVDaGFyKTsKCSAgICAgIGluZGV4ID0gb2Zmc2V0ICsgbWF0Y2gubGVuZ3RoOwoKCSAgICAgIGlmIChlc2NhcGUpIHsKCSAgICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBlc2NhcGUgKyAiKSk9PW51bGw/Jyc6Xy5lc2NhcGUoX190KSkrXG4nIjsKCSAgICAgIH0gZWxzZSBpZiAoaW50ZXJwb2xhdGUpIHsKCSAgICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBpbnRlcnBvbGF0ZSArICIpKT09bnVsbD8nJzpfX3QpK1xuJyI7CgkgICAgICB9IGVsc2UgaWYgKGV2YWx1YXRlKSB7CgkgICAgICAgIHNvdXJjZSArPSAiJztcbiIgKyBldmFsdWF0ZSArICJcbl9fcCs9JyI7CgkgICAgICB9CgoJICAgICAgLy8gQWRvYmUgVk1zIG5lZWQgdGhlIG1hdGNoIHJldHVybmVkIHRvIHByb2R1Y2UgdGhlIGNvcnJlY3Qgb2ZmZXN0LgoJICAgICAgcmV0dXJuIG1hdGNoOwoJICAgIH0pOwoJICAgIHNvdXJjZSArPSAiJztcbiI7CgoJICAgIC8vIElmIGEgdmFyaWFibGUgaXMgbm90IHNwZWNpZmllZCwgcGxhY2UgZGF0YSB2YWx1ZXMgaW4gbG9jYWwgc2NvcGUuCgkgICAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CgoJICAgIHNvdXJjZSA9ICJ2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4sIiArCgkgICAgICAicHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTtcbiIgKwoJICAgICAgc291cmNlICsgJ3JldHVybiBfX3A7XG4nOwoKCSAgICB0cnkgewoJICAgICAgdmFyIHJlbmRlciA9IG5ldyBGdW5jdGlvbihzZXR0aW5ncy52YXJpYWJsZSB8fCAnb2JqJywgJ18nLCBzb3VyY2UpOwoJICAgIH0gY2F0Y2ggKGUpIHsKCSAgICAgIGUuc291cmNlID0gc291cmNlOwoJICAgICAgdGhyb3cgZTsKCSAgICB9CgoJICAgIHZhciB0ZW1wbGF0ZSA9IGZ1bmN0aW9uKGRhdGEpIHsKCSAgICAgIHJldHVybiByZW5kZXIuY2FsbCh0aGlzLCBkYXRhLCBfKTsKCSAgICB9OwoKCSAgICAvLyBQcm92aWRlIHRoZSBjb21waWxlZCBzb3VyY2UgYXMgYSBjb252ZW5pZW5jZSBmb3IgcHJlY29tcGlsYXRpb24uCgkgICAgdmFyIGFyZ3VtZW50ID0gc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaic7CgkgICAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyBhcmd1bWVudCArICcpe1xuJyArIHNvdXJjZSArICd9JzsKCgkgICAgcmV0dXJuIHRlbXBsYXRlOwoJICB9OwoKCSAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbi4gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgoJICBfLmNoYWluID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIGluc3RhbmNlID0gXyhvYmopOwoJICAgIGluc3RhbmNlLl9jaGFpbiA9IHRydWU7CgkgICAgcmV0dXJuIGluc3RhbmNlOwoJICB9OwoKCSAgLy8gT09QCgkgIC8vIC0tLS0tLS0tLS0tLS0tLQoJICAvLyBJZiBVbmRlcnNjb3JlIGlzIGNhbGxlZCBhcyBhIGZ1bmN0aW9uLCBpdCByZXR1cm5zIGEgd3JhcHBlZCBvYmplY3QgdGhhdAoJICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQoJICAvLyB1bmRlcnNjb3JlIGZ1bmN0aW9ucy4gV3JhcHBlZCBvYmplY3RzIG1heSBiZSBjaGFpbmVkLgoKCSAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvbnRpbnVlIGNoYWluaW5nIGludGVybWVkaWF0ZSByZXN1bHRzLgoJICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgcmV0dXJuIHRoaXMuX2NoYWluID8gXyhvYmopLmNoYWluKCkgOiBvYmo7CgkgIH07CgoJICAvLyBBZGQgeW91ciBvd24gY3VzdG9tIGZ1bmN0aW9ucyB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCgkgIF8ubWl4aW4gPSBmdW5jdGlvbihvYmopIHsKCSAgICBfLmVhY2goXy5mdW5jdGlvbnMob2JqKSwgZnVuY3Rpb24obmFtZSkgewoJICAgICAgdmFyIGZ1bmMgPSBfW25hbWVdID0gb2JqW25hbWVdOwoJICAgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKCSAgICAgICAgdmFyIGFyZ3MgPSBbdGhpcy5fd3JhcHBlZF07CgkgICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKCSAgICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIGZ1bmMuYXBwbHkoXywgYXJncykpOwoJICAgICAgfTsKCSAgICB9KTsKCSAgfTsKCgkgIC8vIEFkZCBhbGwgb2YgdGhlIFVuZGVyc2NvcmUgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyIG9iamVjdC4KCSAgXy5taXhpbihfKTsKCgkgIC8vIEFkZCBhbGwgbXV0YXRvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCgkgIF8uZWFjaChbJ3BvcCcsICdwdXNoJywgJ3JldmVyc2UnLCAnc2hpZnQnLCAnc29ydCcsICdzcGxpY2UnLCAndW5zaGlmdCddLCBmdW5jdGlvbihuYW1lKSB7CgkgICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CgkgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKCSAgICAgIHZhciBvYmogPSB0aGlzLl93cmFwcGVkOwoJICAgICAgbWV0aG9kLmFwcGx5KG9iaiwgYXJndW1lbnRzKTsKCSAgICAgIGlmICgobmFtZSA9PT0gJ3NoaWZ0JyB8fCBuYW1lID09PSAnc3BsaWNlJykgJiYgb2JqLmxlbmd0aCA9PT0gMCkgZGVsZXRlIG9ialswXTsKCSAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBvYmopOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gQWRkIGFsbCBhY2Nlc3NvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCgkgIF8uZWFjaChbJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10sIGZ1bmN0aW9uKG5hbWUpIHsKCSAgICB2YXIgbWV0aG9kID0gQXJyYXlQcm90b1tuYW1lXTsKCSAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKCSAgICB9OwoJICB9KTsKCgkgIC8vIEV4dHJhY3RzIHRoZSByZXN1bHQgZnJvbSBhIHdyYXBwZWQgYW5kIGNoYWluZWQgb2JqZWN0LgoJICBfLnByb3RvdHlwZS52YWx1ZSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiB0aGlzLl93cmFwcGVkOwoJICB9OwoKCSAgLy8gQU1EIHJlZ2lzdHJhdGlvbiBoYXBwZW5zIGF0IHRoZSBlbmQgZm9yIGNvbXBhdGliaWxpdHkgd2l0aCBBTUQgbG9hZGVycwoJICAvLyB0aGF0IG1heSBub3QgZW5mb3JjZSBuZXh0LXR1cm4gc2VtYW50aWNzIG9uIG1vZHVsZXMuIEV2ZW4gdGhvdWdoIGdlbmVyYWwKCSAgLy8gcHJhY3RpY2UgZm9yIEFNRCByZWdpc3RyYXRpb24gaXMgdG8gYmUgYW5vbnltb3VzLCB1bmRlcnNjb3JlIHJlZ2lzdGVycwoJICAvLyBhcyBhIG5hbWVkIG1vZHVsZSBiZWNhdXNlLCBsaWtlIGpRdWVyeSwgaXQgaXMgYSBiYXNlIGxpYnJhcnkgdGhhdCBpcwoJICAvLyBwb3B1bGFyIGVub3VnaCB0byBiZSBidW5kbGVkIGluIGEgdGhpcmQgcGFydHkgbGliLCBidXQgbm90IGJlIHBhcnQgb2YKCSAgLy8gYW4gQU1EIGxvYWQgcmVxdWVzdC4gVGhvc2UgY2FzZXMgY291bGQgZ2VuZXJhdGUgYW4gZXJyb3Igd2hlbiBhbgoJICAvLyBhbm9ueW1vdXMgZGVmaW5lKCkgaXMgY2FsbGVkIG91dHNpZGUgb2YgYSBsb2FkZXIgcmVxdWVzdC4KCSAgaWYgKHRydWUpIHsKCSAgICAhKF9fV0VCUEFDS19BTURfREVGSU5FX0FSUkFZX18gPSBbXSwgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gPSBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBfOwoJICAgIH0uYXBwbHkoZXhwb3J0cywgX19XRUJQQUNLX0FNRF9ERUZJTkVfQVJSQVlfXyksIF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fICE9PSB1bmRlZmluZWQgJiYgKG1vZHVsZS5leHBvcnRzID0gX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18pKTsKCSAgfQoJfS5jYWxsKHRoaXMpKTsKCgovKioqLyB9LAovKiAzMiAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkvKioqIElNUE9SVFMgRlJPTSBpbXBvcnRzLWxvYWRlciAqKiovCgl2YXIgcmVxdWlyZSA9IF9fd2VicGFja19yZXF1aXJlX187CgoJLyohCgkgKiBLbm9ja291dCBKYXZhU2NyaXB0IGxpYnJhcnkgdjMuMi4wCgkgKiAoYykgU3RldmVuIFNhbmRlcnNvbiAtIGh0dHA6Ly9rbm9ja291dGpzLmNvbS8KCSAqIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgKi8KCgkoZnVuY3Rpb24oKXsKCXZhciBERUJVRz10cnVlOwoJKGZ1bmN0aW9uKHVuZGVmaW5lZCl7CgkgICAgLy8gKDAsIGV2YWwpKCd0aGlzJykgaXMgYSByb2J1c3Qgd2F5IG9mIGdldHRpbmcgYSByZWZlcmVuY2UgdG8gdGhlIGdsb2JhbCBvYmplY3QKCSAgICAvLyBGb3IgZGV0YWlscywgc2VlIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTQxMTk5ODgvcmV0dXJuLXRoaXMtMC1ldmFsdGhpcy8xNDEyMDAyMyMxNDEyMDAyMwoJICAgIHZhciB3aW5kb3cgPSB0aGlzIHx8ICgwLCBldmFsKSgndGhpcycpLAoJICAgICAgICBkb2N1bWVudCA9IHdpbmRvd1snZG9jdW1lbnQnXSwKCSAgICAgICAgbmF2aWdhdG9yID0gd2luZG93WyduYXZpZ2F0b3InXSwKCSAgICAgICAgalF1ZXJ5SW5zdGFuY2UgPSB3aW5kb3dbImpRdWVyeSJdLAoJICAgICAgICBKU09OID0gd2luZG93WyJKU09OIl07CgkoZnVuY3Rpb24oZmFjdG9yeSkgewoJICAgIC8vIFN1cHBvcnQgdGhyZWUgbW9kdWxlIGxvYWRpbmcgc2NlbmFyaW9zCgkgICAgaWYgKHR5cGVvZiByZXF1aXJlID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JykgewoJICAgICAgICAvLyBbMV0gQ29tbW9uSlMvTm9kZS5qcwoJICAgICAgICB2YXIgdGFyZ2V0ID0gbW9kdWxlWydleHBvcnRzJ10gfHwgZXhwb3J0czsgLy8gbW9kdWxlLmV4cG9ydHMgaXMgZm9yIE5vZGUuanMKCSAgICAgICAgZmFjdG9yeSh0YXJnZXQsIHJlcXVpcmUpOwoJICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmVbJ2FtZCddKSB7CgkgICAgICAgIC8vIFsyXSBBTUQgYW5vbnltb3VzIG1vZHVsZQoJICAgICAgICBkZWZpbmUoWydleHBvcnRzJywgJ3JlcXVpcmUnXSwgZmFjdG9yeSk7CgkgICAgfSBlbHNlIHsKCSAgICAgICAgLy8gWzNdIE5vIG1vZHVsZSBsb2FkZXIgKHBsYWluIDxzY3JpcHQ+IHRhZykgLSBwdXQgZGlyZWN0bHkgaW4gZ2xvYmFsIG5hbWVzcGFjZQoJICAgICAgICBmYWN0b3J5KHdpbmRvd1sna28nXSA9IHt9KTsKCSAgICB9Cgl9KGZ1bmN0aW9uKGtvRXhwb3J0cywgcmVxdWlyZSl7CgkvLyBJbnRlcm5hbGx5LCBhbGwgS08gb2JqZWN0cyBhcmUgYXR0YWNoZWQgdG8ga29FeHBvcnRzIChldmVuIHRoZSBub24tZXhwb3J0ZWQgb25lcyB3aG9zZSBuYW1lcyB3aWxsIGJlIG1pbmlmaWVkIGJ5IHRoZSBjbG9zdXJlIGNvbXBpbGVyKS4KCS8vIEluIHRoZSBmdXR1cmUsIHRoZSBmb2xsb3dpbmcgImtvIiB2YXJpYWJsZSBtYXkgYmUgbWFkZSBkaXN0aW5jdCBmcm9tICJrb0V4cG9ydHMiIHNvIHRoYXQgcHJpdmF0ZSBvYmplY3RzIGFyZSBub3QgZXh0ZXJuYWxseSByZWFjaGFibGUuCgl2YXIga28gPSB0eXBlb2Yga29FeHBvcnRzICE9PSAndW5kZWZpbmVkJyA/IGtvRXhwb3J0cyA6IHt9OwoJLy8gR29vZ2xlIENsb3N1cmUgQ29tcGlsZXIgaGVscGVycyAodXNlZCBvbmx5IHRvIG1ha2UgdGhlIG1pbmlmaWVkIGZpbGUgc21hbGxlcikKCWtvLmV4cG9ydFN5bWJvbCA9IGZ1bmN0aW9uKGtvUGF0aCwgb2JqZWN0KSB7CgkgICAgdmFyIHRva2VucyA9IGtvUGF0aC5zcGxpdCgiLiIpOwoKCSAgICAvLyBJbiB0aGUgZnV0dXJlLCAia28iIG1heSBiZWNvbWUgZGlzdGluY3QgZnJvbSAia29FeHBvcnRzIiAoc28gdGhhdCBub24tZXhwb3J0ZWQgb2JqZWN0cyBhcmUgbm90IHJlYWNoYWJsZSkKCSAgICAvLyBBdCB0aGF0IHBvaW50LCAidGFyZ2V0IiB3b3VsZCBiZSBzZXQgdG86ICh0eXBlb2Yga29FeHBvcnRzICE9PSAidW5kZWZpbmVkIiA/IGtvRXhwb3J0cyA6IGtvKQoJICAgIHZhciB0YXJnZXQgPSBrbzsKCgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoIC0gMTsgaSsrKQoJICAgICAgICB0YXJnZXQgPSB0YXJnZXRbdG9rZW5zW2ldXTsKCSAgICB0YXJnZXRbdG9rZW5zW3Rva2Vucy5sZW5ndGggLSAxXV0gPSBvYmplY3Q7Cgl9OwoJa28uZXhwb3J0UHJvcGVydHkgPSBmdW5jdGlvbihvd25lciwgcHVibGljTmFtZSwgb2JqZWN0KSB7CgkgICAgb3duZXJbcHVibGljTmFtZV0gPSBvYmplY3Q7Cgl9OwoJa28udmVyc2lvbiA9ICIzLjIuMCI7CgoJa28uZXhwb3J0U3ltYm9sKCd2ZXJzaW9uJywga28udmVyc2lvbik7Cglrby51dGlscyA9IChmdW5jdGlvbiAoKSB7CgkgICAgZnVuY3Rpb24gb2JqZWN0Rm9yRWFjaChvYmosIGFjdGlvbikgewoJICAgICAgICBmb3IgKHZhciBwcm9wIGluIG9iaikgewoJICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewoJICAgICAgICAgICAgICAgIGFjdGlvbihwcm9wLCBvYmpbcHJvcF0pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBleHRlbmQodGFyZ2V0LCBzb3VyY2UpIHsKCSAgICAgICAgaWYgKHNvdXJjZSkgewoJICAgICAgICAgICAgZm9yKHZhciBwcm9wIGluIHNvdXJjZSkgewoJICAgICAgICAgICAgICAgIGlmKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewoJICAgICAgICAgICAgICAgICAgICB0YXJnZXRbcHJvcF0gPSBzb3VyY2VbcHJvcF07CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIHJldHVybiB0YXJnZXQ7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBzZXRQcm90b3R5cGVPZihvYmosIHByb3RvKSB7CgkgICAgICAgIG9iai5fX3Byb3RvX18gPSBwcm90bzsKCSAgICAgICAgcmV0dXJuIG9iajsKCSAgICB9CgoJICAgIHZhciBjYW5TZXRQcm90b3R5cGUgPSAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSk7CgoJICAgIC8vIFJlcHJlc2VudCB0aGUga25vd24gZXZlbnQgdHlwZXMgaW4gYSBjb21wYWN0IHdheSwgdGhlbiBhdCBydW50aW1lIHRyYW5zZm9ybSBpdCBpbnRvIGEgaGFzaCB3aXRoIGV2ZW50IG5hbWUgYXMga2V5IChmb3IgZmFzdCBsb29rdXApCgkgICAgdmFyIGtub3duRXZlbnRzID0ge30sIGtub3duRXZlbnRUeXBlc0J5RXZlbnROYW1lID0ge307CgkgICAgdmFyIGtleUV2ZW50VHlwZU5hbWUgPSAobmF2aWdhdG9yICYmIC9GaXJlZm94XC8yL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSkgPyAnS2V5Ym9hcmRFdmVudCcgOiAnVUlFdmVudHMnOwoJICAgIGtub3duRXZlbnRzW2tleUV2ZW50VHlwZU5hbWVdID0gWydrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJ107CgkgICAga25vd25FdmVudHNbJ01vdXNlRXZlbnRzJ10gPSBbJ2NsaWNrJywgJ2RibGNsaWNrJywgJ21vdXNlZG93bicsICdtb3VzZXVwJywgJ21vdXNlbW92ZScsICdtb3VzZW92ZXInLCAnbW91c2VvdXQnLCAnbW91c2VlbnRlcicsICdtb3VzZWxlYXZlJ107CgkgICAgb2JqZWN0Rm9yRWFjaChrbm93bkV2ZW50cywgZnVuY3Rpb24oZXZlbnRUeXBlLCBrbm93bkV2ZW50c0ZvclR5cGUpIHsKCSAgICAgICAgaWYgKGtub3duRXZlbnRzRm9yVHlwZS5sZW5ndGgpIHsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0ga25vd25FdmVudHNGb3JUeXBlLmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICBrbm93bkV2ZW50VHlwZXNCeUV2ZW50TmFtZVtrbm93bkV2ZW50c0ZvclR5cGVbaV1dID0gZXZlbnRUeXBlOwoJICAgICAgICB9CgkgICAgfSk7CgkgICAgdmFyIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudCA9IHsgJ3Byb3BlcnR5Y2hhbmdlJzogdHJ1ZSB9OyAvLyBXb3JrYXJvdW5kIGZvciBhbiBJRTkgaXNzdWUgLSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzQwNgoKCSAgICAvLyBEZXRlY3QgSUUgdmVyc2lvbnMgZm9yIGJ1ZyB3b3JrYXJvdW5kcyAodXNlcyBJRSBjb25kaXRpb25hbHMsIG5vdCBVQSBzdHJpbmcsIGZvciByb2J1c3RuZXNzKQoJICAgIC8vIE5vdGUgdGhhdCwgc2luY2UgSUUgMTAgZG9lcyBub3Qgc3VwcG9ydCBjb25kaXRpb25hbCBjb21tZW50cywgdGhlIGZvbGxvd2luZyBsb2dpYyBvbmx5IGRldGVjdHMgSUUgPCAxMC4KCSAgICAvLyBDdXJyZW50bHkgdGhpcyBpcyBieSBkZXNpZ24sIHNpbmNlIElFIDEwKyBiZWhhdmVzIGNvcnJlY3RseSB3aGVuIHRyZWF0ZWQgYXMgYSBzdGFuZGFyZCBicm93c2VyLgoJICAgIC8vIElmIHRoZXJlIGlzIGEgZnV0dXJlIG5lZWQgdG8gZGV0ZWN0IHNwZWNpZmljIHZlcnNpb25zIG9mIElFMTArLCB3ZSB3aWxsIGFtZW5kIHRoaXMuCgkgICAgdmFyIGllVmVyc2lvbiA9IGRvY3VtZW50ICYmIChmdW5jdGlvbigpIHsKCSAgICAgICAgdmFyIHZlcnNpb24gPSAzLCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgaUVsZW1zID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpJyk7CgoJICAgICAgICAvLyBLZWVwIGNvbnN0cnVjdGluZyBjb25kaXRpb25hbCBIVE1MIGJsb2NrcyB1bnRpbCB3ZSBoaXQgb25lIHRoYXQgcmVzb2x2ZXMgdG8gYW4gZW1wdHkgZnJhZ21lbnQKCSAgICAgICAgd2hpbGUgKAoJICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8IS0tW2lmIGd0IElFICcgKyAoKyt2ZXJzaW9uKSArICddPjxpPjwvaT48IVtlbmRpZl0tLT4nLAoJICAgICAgICAgICAgaUVsZW1zWzBdCgkgICAgICAgICkge30KCSAgICAgICAgcmV0dXJuIHZlcnNpb24gPiA0ID8gdmVyc2lvbiA6IHVuZGVmaW5lZDsKCSAgICB9KCkpOwoJICAgIHZhciBpc0llNiA9IGllVmVyc2lvbiA9PT0gNiwKCSAgICAgICAgaXNJZTcgPSBpZVZlcnNpb24gPT09IDc7CgoJICAgIGZ1bmN0aW9uIGlzQ2xpY2tPbkNoZWNrYWJsZUVsZW1lbnQoZWxlbWVudCwgZXZlbnRUeXBlKSB7CgkgICAgICAgIGlmICgoa28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnQpICE9PSAiaW5wdXQiKSB8fCAhZWxlbWVudC50eXBlKSByZXR1cm4gZmFsc2U7CgkgICAgICAgIGlmIChldmVudFR5cGUudG9Mb3dlckNhc2UoKSAhPSAiY2xpY2siKSByZXR1cm4gZmFsc2U7CgkgICAgICAgIHZhciBpbnB1dFR5cGUgPSBlbGVtZW50LnR5cGU7CgkgICAgICAgIHJldHVybiAoaW5wdXRUeXBlID09ICJjaGVja2JveCIpIHx8IChpbnB1dFR5cGUgPT0gInJhZGlvIik7CgkgICAgfQoKCSAgICByZXR1cm4gewoJICAgICAgICBmaWVsZHNJbmNsdWRlZFdpdGhKc29uUG9zdDogWydhdXRoZW50aWNpdHlfdG9rZW4nLCAvXl9fUmVxdWVzdFZlcmlmaWNhdGlvblRva2VuKF8uKik/JC9dLAoKCSAgICAgICAgYXJyYXlGb3JFYWNoOiBmdW5jdGlvbiAoYXJyYXksIGFjdGlvbikgewoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCgkgICAgICAgICAgICAgICAgYWN0aW9uKGFycmF5W2ldLCBpKTsKCSAgICAgICAgfSwKCgkgICAgICAgIGFycmF5SW5kZXhPZjogZnVuY3Rpb24gKGFycmF5LCBpdGVtKSB7CgkgICAgICAgICAgICBpZiAodHlwZW9mIEFycmF5LnByb3RvdHlwZS5pbmRleE9mID09ICJmdW5jdGlvbiIpCgkgICAgICAgICAgICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5pbmRleE9mLmNhbGwoYXJyYXksIGl0ZW0pOwoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCgkgICAgICAgICAgICAgICAgaWYgKGFycmF5W2ldID09PSBpdGVtKQoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTsKCSAgICAgICAgICAgIHJldHVybiAtMTsKCSAgICAgICAgfSwKCgkgICAgICAgIGFycmF5Rmlyc3Q6IGZ1bmN0aW9uIChhcnJheSwgcHJlZGljYXRlLCBwcmVkaWNhdGVPd25lcikgewoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCgkgICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZS5jYWxsKHByZWRpY2F0ZU93bmVyLCBhcnJheVtpXSwgaSkpCgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcnJheVtpXTsKCSAgICAgICAgICAgIHJldHVybiBudWxsOwoJICAgICAgICB9LAoKCSAgICAgICAgYXJyYXlSZW1vdmVJdGVtOiBmdW5jdGlvbiAoYXJyYXksIGl0ZW1Ub1JlbW92ZSkgewoJICAgICAgICAgICAgdmFyIGluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGFycmF5LCBpdGVtVG9SZW1vdmUpOwoJICAgICAgICAgICAgaWYgKGluZGV4ID4gMCkgewoJICAgICAgICAgICAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBlbHNlIGlmIChpbmRleCA9PT0gMCkgewoJICAgICAgICAgICAgICAgIGFycmF5LnNoaWZ0KCk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBhcnJheUdldERpc3RpbmN0VmFsdWVzOiBmdW5jdGlvbiAoYXJyYXkpIHsKCSAgICAgICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CgkgICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykgewoJICAgICAgICAgICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YocmVzdWx0LCBhcnJheVtpXSkgPCAwKQoJICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChhcnJheVtpXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgICAgICB9LAoKCSAgICAgICAgYXJyYXlNYXA6IGZ1bmN0aW9uIChhcnJheSwgbWFwcGluZykgewoJICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKCSAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG1hcHBpbmcoYXJyYXlbaV0sIGkpKTsKCSAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgICAgIH0sCgoJICAgICAgICBhcnJheUZpbHRlcjogZnVuY3Rpb24gKGFycmF5LCBwcmVkaWNhdGUpIHsKCSAgICAgICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CgkgICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICBpZiAocHJlZGljYXRlKGFycmF5W2ldLCBpKSkKCSAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goYXJyYXlbaV0pOwoJICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICAgICAgfSwKCgkgICAgICAgIGFycmF5UHVzaEFsbDogZnVuY3Rpb24gKGFycmF5LCB2YWx1ZXNUb1B1c2gpIHsKCSAgICAgICAgICAgIGlmICh2YWx1ZXNUb1B1c2ggaW5zdGFuY2VvZiBBcnJheSkKCSAgICAgICAgICAgICAgICBhcnJheS5wdXNoLmFwcGx5KGFycmF5LCB2YWx1ZXNUb1B1c2gpOwoJICAgICAgICAgICAgZWxzZQoJICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmFsdWVzVG9QdXNoLmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaCh2YWx1ZXNUb1B1c2hbaV0pOwoJICAgICAgICAgICAgcmV0dXJuIGFycmF5OwoJICAgICAgICB9LAoKCSAgICAgICAgYWRkT3JSZW1vdmVJdGVtOiBmdW5jdGlvbihhcnJheSwgdmFsdWUsIGluY2x1ZGVkKSB7CgkgICAgICAgICAgICB2YXIgZXhpc3RpbmdFbnRyeUluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGtvLnV0aWxzLnBlZWtPYnNlcnZhYmxlKGFycmF5KSwgdmFsdWUpOwoJICAgICAgICAgICAgaWYgKGV4aXN0aW5nRW50cnlJbmRleCA8IDApIHsKCSAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZWQpCgkgICAgICAgICAgICAgICAgICAgIGFycmF5LnB1c2godmFsdWUpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVkKQoJICAgICAgICAgICAgICAgICAgICBhcnJheS5zcGxpY2UoZXhpc3RpbmdFbnRyeUluZGV4LCAxKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIGNhblNldFByb3RvdHlwZTogY2FuU2V0UHJvdG90eXBlLAoKCSAgICAgICAgZXh0ZW5kOiBleHRlbmQsCgoJICAgICAgICBzZXRQcm90b3R5cGVPZjogc2V0UHJvdG90eXBlT2YsCgoJICAgICAgICBzZXRQcm90b3R5cGVPZk9yRXh0ZW5kOiBjYW5TZXRQcm90b3R5cGUgPyBzZXRQcm90b3R5cGVPZiA6IGV4dGVuZCwKCgkgICAgICAgIG9iamVjdEZvckVhY2g6IG9iamVjdEZvckVhY2gsCgoJICAgICAgICBvYmplY3RNYXA6IGZ1bmN0aW9uKHNvdXJjZSwgbWFwcGluZykgewoJICAgICAgICAgICAgaWYgKCFzb3VyY2UpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHNvdXJjZTsKCSAgICAgICAgICAgIHZhciB0YXJnZXQgPSB7fTsKCSAgICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CgkgICAgICAgICAgICAgICAgaWYgKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewoJICAgICAgICAgICAgICAgICAgICB0YXJnZXRbcHJvcF0gPSBtYXBwaW5nKHNvdXJjZVtwcm9wXSwgcHJvcCwgc291cmNlKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdGFyZ2V0OwoJICAgICAgICB9LAoKCSAgICAgICAgZW1wdHlEb21Ob2RlOiBmdW5jdGlvbiAoZG9tTm9kZSkgewoJICAgICAgICAgICAgd2hpbGUgKGRvbU5vZGUuZmlyc3RDaGlsZCkgewoJICAgICAgICAgICAgICAgIGtvLnJlbW92ZU5vZGUoZG9tTm9kZS5maXJzdENoaWxkKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIG1vdmVDbGVhbmVkTm9kZXNUb0NvbnRhaW5lckVsZW1lbnQ6IGZ1bmN0aW9uKG5vZGVzKSB7CgkgICAgICAgICAgICAvLyBFbnN1cmUgaXQncyBhIHJlYWwgYXJyYXksIGFzIHdlJ3JlIGFib3V0IHRvIHJlcGFyZW50IHRoZSBub2RlcyBhbmQKCSAgICAgICAgICAgIC8vIHdlIGRvbid0IHdhbnQgdGhlIHVuZGVybHlpbmcgY29sbGVjdGlvbiB0byBjaGFuZ2Ugd2hpbGUgd2UncmUgZG9pbmcgdGhhdC4KCSAgICAgICAgICAgIHZhciBub2Rlc0FycmF5ID0ga28udXRpbHMubWFrZUFycmF5KG5vZGVzKTsKCgkgICAgICAgICAgICB2YXIgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzQXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB7CgkgICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGtvLmNsZWFuTm9kZShub2Rlc0FycmF5W2ldKSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyOwoJICAgICAgICB9LAoKCSAgICAgICAgY2xvbmVOb2RlczogZnVuY3Rpb24gKG5vZGVzQXJyYXksIHNob3VsZENsZWFuTm9kZXMpIHsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gbm9kZXNBcnJheS5sZW5ndGgsIG5ld05vZGVzQXJyYXkgPSBbXTsgaSA8IGo7IGkrKykgewoJICAgICAgICAgICAgICAgIHZhciBjbG9uZWROb2RlID0gbm9kZXNBcnJheVtpXS5jbG9uZU5vZGUodHJ1ZSk7CgkgICAgICAgICAgICAgICAgbmV3Tm9kZXNBcnJheS5wdXNoKHNob3VsZENsZWFuTm9kZXMgPyBrby5jbGVhbk5vZGUoY2xvbmVkTm9kZSkgOiBjbG9uZWROb2RlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBuZXdOb2Rlc0FycmF5OwoJICAgICAgICB9LAoKCSAgICAgICAgc2V0RG9tTm9kZUNoaWxkcmVuOiBmdW5jdGlvbiAoZG9tTm9kZSwgY2hpbGROb2RlcykgewoJICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKGRvbU5vZGUpOwoJICAgICAgICAgICAgaWYgKGNoaWxkTm9kZXMpIHsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgICAgICBkb21Ob2RlLmFwcGVuZENoaWxkKGNoaWxkTm9kZXNbaV0pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgcmVwbGFjZURvbU5vZGVzOiBmdW5jdGlvbiAobm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5LCBuZXdOb2Rlc0FycmF5KSB7CgkgICAgICAgICAgICB2YXIgbm9kZXNUb1JlcGxhY2VBcnJheSA9IG5vZGVUb1JlcGxhY2VPck5vZGVBcnJheS5ub2RlVHlwZSA/IFtub2RlVG9SZXBsYWNlT3JOb2RlQXJyYXldIDogbm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5OwoJICAgICAgICAgICAgaWYgKG5vZGVzVG9SZXBsYWNlQXJyYXkubGVuZ3RoID4gMCkgewoJICAgICAgICAgICAgICAgIHZhciBpbnNlcnRpb25Qb2ludCA9IG5vZGVzVG9SZXBsYWNlQXJyYXlbMF07CgkgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IGluc2VydGlvblBvaW50LnBhcmVudE5vZGU7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBuZXdOb2Rlc0FycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShuZXdOb2Rlc0FycmF5W2ldLCBpbnNlcnRpb25Qb2ludCk7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBub2Rlc1RvUmVwbGFjZUFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykgewoJICAgICAgICAgICAgICAgICAgICBrby5yZW1vdmVOb2RlKG5vZGVzVG9SZXBsYWNlQXJyYXlbaV0pOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIGZpeFVwQ29udGludW91c05vZGVBcnJheTogZnVuY3Rpb24oY29udGludW91c05vZGVBcnJheSwgcGFyZW50Tm9kZSkgewoJICAgICAgICAgICAgLy8gQmVmb3JlIGFjdGluZyBvbiBhIHNldCBvZiBub2RlcyB0aGF0IHdlcmUgcHJldmlvdXNseSBvdXRwdXR0ZWQgYnkgYSB0ZW1wbGF0ZSBmdW5jdGlvbiwgd2UgaGF2ZSB0byByZWNvbmNpbGUKCSAgICAgICAgICAgIC8vIHRoZW0gYWdhaW5zdCB3aGF0IGlzIGluIHRoZSBET00gcmlnaHQgbm93LiBJdCBtYXkgYmUgdGhhdCBzb21lIG9mIHRoZSBub2RlcyBoYXZlIGFscmVhZHkgYmVlbiByZW1vdmVkLCBvciB0aGF0CgkgICAgICAgICAgICAvLyBuZXcgbm9kZXMgbWlnaHQgaGF2ZSBiZWVuIGluc2VydGVkIGluIHRoZSBtaWRkbGUsIGZvciBleGFtcGxlIGJ5IGEgYmluZGluZy4gQWxzbywgdGhlcmUgbWF5IHByZXZpb3VzbHkgaGF2ZSBiZWVuCgkgICAgICAgICAgICAvLyBsZWFkaW5nIGNvbW1lbnQgbm9kZXMgKGNyZWF0ZWQgYnkgcmV3cml0dGVuIHN0cmluZy1iYXNlZCB0ZW1wbGF0ZXMpIHRoYXQgaGF2ZSBzaW5jZSBiZWVuIHJlbW92ZWQgZHVyaW5nIGJpbmRpbmcuCgkgICAgICAgICAgICAvLyBTbywgdGhpcyBmdW5jdGlvbiB0cmFuc2xhdGVzIHRoZSBvbGQgIm1hcCIgb3V0cHV0IGFycmF5IGludG8gaXRzIGJlc3QgZ3Vlc3Mgb2YgdGhlIHNldCBvZiBjdXJyZW50IERPTSBub2Rlcy4KCSAgICAgICAgICAgIC8vCgkgICAgICAgICAgICAvLyBSdWxlczoKCSAgICAgICAgICAgIC8vICAgW0FdIEFueSBsZWFkaW5nIG5vZGVzIHRoYXQgaGF2ZSBiZWVuIHJlbW92ZWQgc2hvdWxkIGJlIGlnbm9yZWQKCSAgICAgICAgICAgIC8vICAgICAgIFRoZXNlIG1vc3QgbGlrZWx5IGNvcnJlc3BvbmQgdG8gbWVtb2l6YXRpb24gbm9kZXMgdGhhdCB3ZXJlIGFscmVhZHkgcmVtb3ZlZCBkdXJpbmcgYmluZGluZwoJICAgICAgICAgICAgLy8gICAgICAgU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9wdWxsLzQ0MAoJICAgICAgICAgICAgLy8gICBbQl0gV2Ugd2FudCB0byBvdXRwdXQgYSBjb250aW51b3VzIHNlcmllcyBvZiBub2Rlcy4gU28sIGlnbm9yZSBhbnkgbm9kZXMgdGhhdCBoYXZlIGFscmVhZHkgYmVlbiByZW1vdmVkLAoJICAgICAgICAgICAgLy8gICAgICAgYW5kIGluY2x1ZGUgYW55IG5vZGVzIHRoYXQgaGF2ZSBiZWVuIGluc2VydGVkIGFtb25nIHRoZSBwcmV2aW91cyBjb2xsZWN0aW9uCgoJICAgICAgICAgICAgaWYgKGNvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgLy8gVGhlIHBhcmVudCBub2RlIGNhbiBiZSBhIHZpcnR1YWwgZWxlbWVudDsgc28gZ2V0IHRoZSByZWFsIHBhcmVudCBub2RlCgkgICAgICAgICAgICAgICAgcGFyZW50Tm9kZSA9IChwYXJlbnROb2RlLm5vZGVUeXBlID09PSA4ICYmIHBhcmVudE5vZGUucGFyZW50Tm9kZSkgfHwgcGFyZW50Tm9kZTsKCgkgICAgICAgICAgICAgICAgLy8gUnVsZSBbQV0KCSAgICAgICAgICAgICAgICB3aGlsZSAoY29udGludW91c05vZGVBcnJheS5sZW5ndGggJiYgY29udGludW91c05vZGVBcnJheVswXS5wYXJlbnROb2RlICE9PSBwYXJlbnROb2RlKQoJICAgICAgICAgICAgICAgICAgICBjb250aW51b3VzTm9kZUFycmF5LnNoaWZ0KCk7CgoJICAgICAgICAgICAgICAgIC8vIFJ1bGUgW0JdCgkgICAgICAgICAgICAgICAgaWYgKGNvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoID4gMSkgewoJICAgICAgICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IGNvbnRpbnVvdXNOb2RlQXJyYXlbMF0sIGxhc3QgPSBjb250aW51b3VzTm9kZUFycmF5W2NvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoIC0gMV07CgkgICAgICAgICAgICAgICAgICAgIC8vIFJlcGxhY2Ugd2l0aCB0aGUgYWN0dWFsIG5ldyBjb250aW51b3VzIG5vZGUgc2V0CgkgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoID0gMDsKCSAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgIT09IGxhc3QpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVvdXNOb2RlQXJyYXkucHVzaChjdXJyZW50KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50Lm5leHRTaWJsaW5nOwoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjdXJyZW50KSAvLyBXb24ndCBoYXBwZW4sIGV4Y2VwdCBpZiB0aGUgZGV2ZWxvcGVyIGhhcyBtYW51YWxseSByZW1vdmVkIHNvbWUgRE9NIGVsZW1lbnRzICh0aGVuIHdlJ3JlIGluIGFuIHVuZGVmaW5lZCBzY2VuYXJpbykKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgY29udGludW91c05vZGVBcnJheS5wdXNoKGxhc3QpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBjb250aW51b3VzTm9kZUFycmF5OwoJICAgICAgICB9LAoKCSAgICAgICAgc2V0T3B0aW9uTm9kZVNlbGVjdGlvblN0YXRlOiBmdW5jdGlvbiAob3B0aW9uTm9kZSwgaXNTZWxlY3RlZCkgewoJICAgICAgICAgICAgLy8gSUU2IHNvbWV0aW1lcyB0aHJvd3MgInVua25vd24gZXJyb3IiIGlmIHlvdSB0cnkgdG8gd3JpdGUgdG8gLnNlbGVjdGVkIGRpcmVjdGx5LCB3aGVyZWFzIEZpcmVmb3ggc3RydWdnbGVzIHdpdGggc2V0QXR0cmlidXRlLiBQaWNrIG9uZSBiYXNlZCBvbiBicm93c2VyLgoJICAgICAgICAgICAgaWYgKGllVmVyc2lvbiA8IDcpCgkgICAgICAgICAgICAgICAgb3B0aW9uTm9kZS5zZXRBdHRyaWJ1dGUoInNlbGVjdGVkIiwgaXNTZWxlY3RlZCk7CgkgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgb3B0aW9uTm9kZS5zZWxlY3RlZCA9IGlzU2VsZWN0ZWQ7CgkgICAgICAgIH0sCgoJICAgICAgICBzdHJpbmdUcmltOiBmdW5jdGlvbiAoc3RyaW5nKSB7CgkgICAgICAgICAgICByZXR1cm4gc3RyaW5nID09PSBudWxsIHx8IHN0cmluZyA9PT0gdW5kZWZpbmVkID8gJycgOgoJICAgICAgICAgICAgICAgIHN0cmluZy50cmltID8KCSAgICAgICAgICAgICAgICAgICAgc3RyaW5nLnRyaW0oKSA6CgkgICAgICAgICAgICAgICAgICAgIHN0cmluZy50b1N0cmluZygpLnJlcGxhY2UoL15bXHNceGEwXSt8W1xzXHhhMF0rJC9nLCAnJyk7CgkgICAgICAgIH0sCgoJICAgICAgICBzdHJpbmdTdGFydHNXaXRoOiBmdW5jdGlvbiAoc3RyaW5nLCBzdGFydHNXaXRoKSB7CgkgICAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcgfHwgIiI7CgkgICAgICAgICAgICBpZiAoc3RhcnRzV2l0aC5sZW5ndGggPiBzdHJpbmcubGVuZ3RoKQoJICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCSAgICAgICAgICAgIHJldHVybiBzdHJpbmcuc3Vic3RyaW5nKDAsIHN0YXJ0c1dpdGgubGVuZ3RoKSA9PT0gc3RhcnRzV2l0aDsKCSAgICAgICAgfSwKCgkgICAgICAgIGRvbU5vZGVJc0NvbnRhaW5lZEJ5OiBmdW5jdGlvbiAobm9kZSwgY29udGFpbmVkQnlOb2RlKSB7CgkgICAgICAgICAgICBpZiAobm9kZSA9PT0gY29udGFpbmVkQnlOb2RlKQoJICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwoJICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDExKQoJICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gRml4ZXMgaXNzdWUgIzExNjIgLSBjYW4ndCB1c2Ugbm9kZS5jb250YWlucyBmb3IgZG9jdW1lbnQgZnJhZ21lbnRzIG9uIElFOAoJICAgICAgICAgICAgaWYgKGNvbnRhaW5lZEJ5Tm9kZS5jb250YWlucykKCSAgICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVkQnlOb2RlLmNvbnRhaW5zKG5vZGUubm9kZVR5cGUgPT09IDMgPyBub2RlLnBhcmVudE5vZGUgOiBub2RlKTsKCSAgICAgICAgICAgIGlmIChjb250YWluZWRCeU5vZGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24pCgkgICAgICAgICAgICAgICAgcmV0dXJuIChjb250YWluZWRCeU5vZGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24obm9kZSkgJiAxNikgPT0gMTY7CgkgICAgICAgICAgICB3aGlsZSAobm9kZSAmJiBub2RlICE9IGNvbnRhaW5lZEJ5Tm9kZSkgewoJICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gISFub2RlOwoJICAgICAgICB9LAoKCSAgICAgICAgZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50OiBmdW5jdGlvbiAobm9kZSkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbU5vZGVJc0NvbnRhaW5lZEJ5KG5vZGUsIG5vZGUub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpOwoJICAgICAgICB9LAoKCSAgICAgICAgYW55RG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50OiBmdW5jdGlvbihub2RlcykgewoJICAgICAgICAgICAgcmV0dXJuICEha28udXRpbHMuYXJyYXlGaXJzdChub2Rlcywga28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KTsKCSAgICAgICAgfSwKCgkgICAgICAgIHRhZ05hbWVMb3dlcjogZnVuY3Rpb24oZWxlbWVudCkgewoJICAgICAgICAgICAgLy8gRm9yIEhUTUwgZWxlbWVudHMsIHRhZ05hbWUgd2lsbCBhbHdheXMgYmUgdXBwZXIgY2FzZTsgZm9yIFhIVE1MIGVsZW1lbnRzLCBpdCdsbCBiZSBsb3dlciBjYXNlLgoJICAgICAgICAgICAgLy8gUG9zc2libGUgZnV0dXJlIG9wdGltaXphdGlvbjogSWYgd2Uga25vdyBpdCdzIGFuIGVsZW1lbnQgZnJvbSBhbiBYSFRNTCBkb2N1bWVudCAobm90IEhUTUwpLAoJICAgICAgICAgICAgLy8gd2UgZG9uJ3QgbmVlZCB0byBkbyB0aGUgLnRvTG93ZXJDYXNlKCkgYXMgaXQgd2lsbCBhbHdheXMgYmUgbG93ZXIgY2FzZSBhbnl3YXkuCgkgICAgICAgICAgICByZXR1cm4gZWxlbWVudCAmJiBlbGVtZW50LnRhZ05hbWUgJiYgZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CgkgICAgICAgIH0sCgoJICAgICAgICByZWdpc3RlckV2ZW50SGFuZGxlcjogZnVuY3Rpb24gKGVsZW1lbnQsIGV2ZW50VHlwZSwgaGFuZGxlcikgewoJICAgICAgICAgICAgdmFyIG11c3RVc2VBdHRhY2hFdmVudCA9IGllVmVyc2lvbiAmJiBldmVudHNUaGF0TXVzdEJlUmVnaXN0ZXJlZFVzaW5nQXR0YWNoRXZlbnRbZXZlbnRUeXBlXTsKCSAgICAgICAgICAgIGlmICghbXVzdFVzZUF0dGFjaEV2ZW50ICYmIGpRdWVyeUluc3RhbmNlKSB7CgkgICAgICAgICAgICAgICAgalF1ZXJ5SW5zdGFuY2UoZWxlbWVudClbJ2JpbmQnXShldmVudFR5cGUsIGhhbmRsZXIpOwoJICAgICAgICAgICAgfSBlbHNlIGlmICghbXVzdFVzZUF0dGFjaEV2ZW50ICYmIHR5cGVvZiBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIgPT0gImZ1bmN0aW9uIikKCSAgICAgICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBoYW5kbGVyLCBmYWxzZSk7CgkgICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgZWxlbWVudC5hdHRhY2hFdmVudCAhPSAidW5kZWZpbmVkIikgewoJICAgICAgICAgICAgICAgIHZhciBhdHRhY2hFdmVudEhhbmRsZXIgPSBmdW5jdGlvbiAoZXZlbnQpIHsgaGFuZGxlci5jYWxsKGVsZW1lbnQsIGV2ZW50KTsgfSwKCSAgICAgICAgICAgICAgICAgICAgYXR0YWNoRXZlbnROYW1lID0gIm9uIiArIGV2ZW50VHlwZTsKCSAgICAgICAgICAgICAgICBlbGVtZW50LmF0dGFjaEV2ZW50KGF0dGFjaEV2ZW50TmFtZSwgYXR0YWNoRXZlbnRIYW5kbGVyKTsKCgkgICAgICAgICAgICAgICAgLy8gSUUgZG9lcyBub3QgZGlzcG9zZSBhdHRhY2hFdmVudCBoYW5kbGVycyBhdXRvbWF0aWNhbGx5ICh1bmxpa2Ugd2l0aCBhZGRFdmVudExpc3RlbmVyKQoJICAgICAgICAgICAgICAgIC8vIHNvIHRvIGF2b2lkIGxlYWtzLCB3ZSBoYXZlIHRvIHJlbW92ZSB0aGVtIG1hbnVhbGx5LiBTZWUgYnVnICM4NTYKCSAgICAgICAgICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKGVsZW1lbnQsIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmRldGFjaEV2ZW50KGF0dGFjaEV2ZW50TmFtZSwgYXR0YWNoRXZlbnRIYW5kbGVyKTsKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0gZWxzZQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgYWRkRXZlbnRMaXN0ZW5lciBvciBhdHRhY2hFdmVudCIpOwoJICAgICAgICB9LAoKCSAgICAgICAgdHJpZ2dlckV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnRUeXBlKSB7CgkgICAgICAgICAgICBpZiAoIShlbGVtZW50ICYmIGVsZW1lbnQubm9kZVR5cGUpKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZWxlbWVudCBtdXN0IGJlIGEgRE9NIG5vZGUgd2hlbiBjYWxsaW5nIHRyaWdnZXJFdmVudCIpOwoKCSAgICAgICAgICAgIC8vIEZvciBjbGljayBldmVudHMgb24gY2hlY2tib3hlcyBhbmQgcmFkaW8gYnV0dG9ucywgalF1ZXJ5IHRvZ2dsZXMgdGhlIGVsZW1lbnQgY2hlY2tlZCBzdGF0ZSAqYWZ0ZXIqIHRoZQoJICAgICAgICAgICAgLy8gZXZlbnQgaGFuZGxlciBydW5zIGluc3RlYWQgb2YgKmJlZm9yZSouIChUaGlzIHdhcyBmaXhlZCBpbiAxLjkgZm9yIGNoZWNrYm94ZXMgYnV0IG5vdCBmb3IgcmFkaW8gYnV0dG9ucy4pCgkgICAgICAgICAgICAvLyBJRSBkb2Vzbid0IGNoYW5nZSB0aGUgY2hlY2tlZCBzdGF0ZSB3aGVuIHlvdSB0cmlnZ2VyIHRoZSBjbGljayBldmVudCB1c2luZyAiZmlyZUV2ZW50Ii4KCSAgICAgICAgICAgIC8vIEluIGJvdGggY2FzZXMsIHdlJ2xsIHVzZSB0aGUgY2xpY2sgbWV0aG9kIGluc3RlYWQuCgkgICAgICAgICAgICB2YXIgdXNlQ2xpY2tXb3JrYXJvdW5kID0gaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpOwoKCSAgICAgICAgICAgIGlmIChqUXVlcnlJbnN0YW5jZSAmJiAhdXNlQ2xpY2tXb3JrYXJvdW5kKSB7CgkgICAgICAgICAgICAgICAgalF1ZXJ5SW5zdGFuY2UoZWxlbWVudClbJ3RyaWdnZXInXShldmVudFR5cGUpOwoJICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZG9jdW1lbnQuY3JlYXRlRXZlbnQgPT0gImZ1bmN0aW9uIikgewoJICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZWxlbWVudC5kaXNwYXRjaEV2ZW50ID09ICJmdW5jdGlvbiIpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50Q2F0ZWdvcnkgPSBrbm93bkV2ZW50VHlwZXNCeUV2ZW50TmFtZVtldmVudFR5cGVdIHx8ICJIVE1MRXZlbnRzIjsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoZXZlbnRDYXRlZ29yeSk7CgkgICAgICAgICAgICAgICAgICAgIGV2ZW50LmluaXRFdmVudChldmVudFR5cGUsIHRydWUsIHRydWUsIHdpbmRvdywgMCwgMCwgMCwgMCwgMCwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDAsIGVsZW1lbnQpOwoJICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIHN1cHBsaWVkIGVsZW1lbnQgZG9lc24ndCBzdXBwb3J0IGRpc3BhdGNoRXZlbnQiKTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAodXNlQ2xpY2tXb3JrYXJvdW5kICYmIGVsZW1lbnQuY2xpY2spIHsKCSAgICAgICAgICAgICAgICBlbGVtZW50LmNsaWNrKCk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbGVtZW50LmZpcmVFdmVudCAhPSAidW5kZWZpbmVkIikgewoJICAgICAgICAgICAgICAgIGVsZW1lbnQuZmlyZUV2ZW50KCJvbiIgKyBldmVudFR5cGUpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IHRyaWdnZXJpbmcgZXZlbnRzIik7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICB1bndyYXBPYnNlcnZhYmxlOiBmdW5jdGlvbiAodmFsdWUpIHsKCSAgICAgICAgICAgIHJldHVybiBrby5pc09ic2VydmFibGUodmFsdWUpID8gdmFsdWUoKSA6IHZhbHVlOwoJICAgICAgICB9LAoKCSAgICAgICAgcGVla09ic2VydmFibGU6IGZ1bmN0aW9uICh2YWx1ZSkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLmlzT2JzZXJ2YWJsZSh2YWx1ZSkgPyB2YWx1ZS5wZWVrKCkgOiB2YWx1ZTsKCSAgICAgICAgfSwKCgkgICAgICAgIHRvZ2dsZURvbU5vZGVDc3NDbGFzczogZnVuY3Rpb24gKG5vZGUsIGNsYXNzTmFtZXMsIHNob3VsZEhhdmVDbGFzcykgewoJICAgICAgICAgICAgaWYgKGNsYXNzTmFtZXMpIHsKCSAgICAgICAgICAgICAgICB2YXIgY3NzQ2xhc3NOYW1lUmVnZXggPSAvXFMrL2csCgkgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDbGFzc05hbWVzID0gbm9kZS5jbGFzc05hbWUubWF0Y2goY3NzQ2xhc3NOYW1lUmVnZXgpIHx8IFtdOwoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChjbGFzc05hbWVzLm1hdGNoKGNzc0NsYXNzTmFtZVJlZ2V4KSwgZnVuY3Rpb24oY2xhc3NOYW1lKSB7CgkgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFkZE9yUmVtb3ZlSXRlbShjdXJyZW50Q2xhc3NOYW1lcywgY2xhc3NOYW1lLCBzaG91bGRIYXZlQ2xhc3MpOwoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICAgIG5vZGUuY2xhc3NOYW1lID0gY3VycmVudENsYXNzTmFtZXMuam9pbigiICIpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgc2V0VGV4dENvbnRlbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHRleHRDb250ZW50KSB7CgkgICAgICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHRleHRDb250ZW50KTsKCSAgICAgICAgICAgIGlmICgodmFsdWUgPT09IG51bGwpIHx8ICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSkKCSAgICAgICAgICAgICAgICB2YWx1ZSA9ICIiOwoKCSAgICAgICAgICAgIC8vIFdlIG5lZWQgdGhlcmUgdG8gYmUgZXhhY3RseSBvbmUgY2hpbGQ6IGEgdGV4dCBub2RlLgoJICAgICAgICAgICAgLy8gSWYgdGhlcmUgYXJlIG5vIGNoaWxkcmVuLCBtb3JlIHRoYW4gb25lLCBvciBpZiBpdCdzIG5vdCBhIHRleHQgbm9kZSwKCSAgICAgICAgICAgIC8vIHdlJ2xsIGNsZWFyIGV2ZXJ5dGhpbmcgYW5kIGNyZWF0ZSBhIHNpbmdsZSB0ZXh0IG5vZGUuCgkgICAgICAgICAgICB2YXIgaW5uZXJUZXh0Tm9kZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5maXJzdENoaWxkKGVsZW1lbnQpOwoJICAgICAgICAgICAgaWYgKCFpbm5lclRleHROb2RlIHx8IGlubmVyVGV4dE5vZGUubm9kZVR5cGUgIT0gMyB8fCBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcoaW5uZXJUZXh0Tm9kZSkpIHsKCSAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuKGVsZW1lbnQsIFtlbGVtZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWUpXSk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIGlubmVyVGV4dE5vZGUuZGF0YSA9IHZhbHVlOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIGtvLnV0aWxzLmZvcmNlUmVmcmVzaChlbGVtZW50KTsKCSAgICAgICAgfSwKCgkgICAgICAgIHNldEVsZW1lbnROYW1lOiBmdW5jdGlvbihlbGVtZW50LCBuYW1lKSB7CgkgICAgICAgICAgICBlbGVtZW50Lm5hbWUgPSBuYW1lOwoKCSAgICAgICAgICAgIC8vIFdvcmthcm91bmQgSUUgNi83IGlzc3VlCgkgICAgICAgICAgICAvLyAtIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTk3CgkgICAgICAgICAgICAvLyAtIGh0dHA6Ly93d3cubWF0dHM0MTEuY29tL3Bvc3Qvc2V0dGluZ190aGVfbmFtZV9hdHRyaWJ1dGVfaW5faWVfZG9tLwoJICAgICAgICAgICAgaWYgKGllVmVyc2lvbiA8PSA3KSB7CgkgICAgICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5tZXJnZUF0dHJpYnV0ZXMoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiPGlucHV0IG5hbWU9JyIgKyBlbGVtZW50Lm5hbWUgKyAiJy8+IiksIGZhbHNlKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgY2F0Y2goZSkge30gLy8gRm9yIElFOSB3aXRoIGRvYyBtb2RlICJJRTkgU3RhbmRhcmRzIiBhbmQgYnJvd3NlciBtb2RlICJJRTkgQ29tcGF0aWJpbGl0eSBWaWV3IgoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgZm9yY2VSZWZyZXNoOiBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBhbiBJRTkgcmVuZGVyaW5nIGJ1ZyAtIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMjA5CgkgICAgICAgICAgICBpZiAoaWVWZXJzaW9uID49IDkpIHsKCSAgICAgICAgICAgICAgICAvLyBGb3IgdGV4dCBub2RlcyBhbmQgY29tbWVudCBub2RlcyAobW9zdCBsaWtlbHkgdmlydHVhbCBlbGVtZW50cyksIHdlIHdpbGwgaGF2ZSB0byByZWZyZXNoIHRoZSBjb250YWluZXIKCSAgICAgICAgICAgICAgICB2YXIgZWxlbSA9IG5vZGUubm9kZVR5cGUgPT0gMSA/IG5vZGUgOiBub2RlLnBhcmVudE5vZGU7CgkgICAgICAgICAgICAgICAgaWYgKGVsZW0uc3R5bGUpCgkgICAgICAgICAgICAgICAgICAgIGVsZW0uc3R5bGUuem9vbSA9IGVsZW0uc3R5bGUuem9vbTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIGVuc3VyZVNlbGVjdEVsZW1lbnRJc1JlbmRlcmVkQ29ycmVjdGx5OiBmdW5jdGlvbihzZWxlY3RFbGVtZW50KSB7CgkgICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBJRTkgcmVuZGVyaW5nIGJ1ZyAtIGl0IGRvZXNuJ3QgcmVsaWFibHkgZGlzcGxheSBhbGwgdGhlIHRleHQgaW4gZHluYW1pY2FsbHktYWRkZWQgc2VsZWN0IGJveGVzIHVubGVzcyB5b3UgZm9yY2UgaXQgdG8gcmUtcmVuZGVyIGJ5IHVwZGF0aW5nIHRoZSB3aWR0aC4KCSAgICAgICAgICAgIC8vIChTZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8zMTIsIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNTkwODQ5NC9zZWxlY3Qtb25seS1zaG93cy1maXJzdC1jaGFyLW9mLXNlbGVjdGVkLW9wdGlvbikKCSAgICAgICAgICAgIC8vIEFsc28gZml4ZXMgSUU3IGFuZCBJRTggYnVnIHRoYXQgY2F1c2VzIHNlbGVjdHMgdG8gYmUgemVybyB3aWR0aCBpZiBlbmNsb3NlZCBieSAnaWYnIG9yICd3aXRoJy4gKFNlZSBpc3N1ZSAjODM5KQoJICAgICAgICAgICAgaWYgKGllVmVyc2lvbikgewoJICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbFdpZHRoID0gc2VsZWN0RWxlbWVudC5zdHlsZS53aWR0aDsKCSAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnN0eWxlLndpZHRoID0gMDsKCSAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnN0eWxlLndpZHRoID0gb3JpZ2luYWxXaWR0aDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIHJhbmdlOiBmdW5jdGlvbiAobWluLCBtYXgpIHsKCSAgICAgICAgICAgIG1pbiA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobWluKTsKCSAgICAgICAgICAgIG1heCA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobWF4KTsKCSAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSBtaW47IGkgPD0gbWF4OyBpKyspCgkgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goaSk7CgkgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgICAgICB9LAoKCSAgICAgICAgbWFrZUFycmF5OiBmdW5jdGlvbihhcnJheUxpa2VPYmplY3QpIHsKCSAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXlMaWtlT2JqZWN0Lmxlbmd0aDsgaSA8IGo7IGkrKykgewoJICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5TGlrZU9iamVjdFtpXSk7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICAgICAgfSwKCgkgICAgICAgIGlzSWU2IDogaXNJZTYsCgkgICAgICAgIGlzSWU3IDogaXNJZTcsCgkgICAgICAgIGllVmVyc2lvbiA6IGllVmVyc2lvbiwKCgkgICAgICAgIGdldEZvcm1GaWVsZHM6IGZ1bmN0aW9uKGZvcm0sIGZpZWxkTmFtZSkgewoJICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtvLnV0aWxzLm1ha2VBcnJheShmb3JtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpbnB1dCIpKS5jb25jYXQoa28udXRpbHMubWFrZUFycmF5KGZvcm0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRleHRhcmVhIikpKTsKCSAgICAgICAgICAgIHZhciBpc01hdGNoaW5nRmllbGQgPSAodHlwZW9mIGZpZWxkTmFtZSA9PSAnc3RyaW5nJykKCSAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uKGZpZWxkKSB7IHJldHVybiBmaWVsZC5uYW1lID09PSBmaWVsZE5hbWUgfQoJICAgICAgICAgICAgICAgIDogZnVuY3Rpb24oZmllbGQpIHsgcmV0dXJuIGZpZWxkTmFtZS50ZXN0KGZpZWxkLm5hbWUpIH07IC8vIFRyZWF0IGZpZWxkTmFtZSBhcyByZWdleCBvciBvYmplY3QgY29udGFpbmluZyBwcmVkaWNhdGUKCSAgICAgICAgICAgIHZhciBtYXRjaGVzID0gW107CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gZmllbGRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkgICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdGaWVsZChmaWVsZHNbaV0pKQoJICAgICAgICAgICAgICAgICAgICBtYXRjaGVzLnB1c2goZmllbGRzW2ldKTsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICByZXR1cm4gbWF0Y2hlczsKCSAgICAgICAgfSwKCgkgICAgICAgIHBhcnNlSnNvbjogZnVuY3Rpb24gKGpzb25TdHJpbmcpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YganNvblN0cmluZyA9PSAic3RyaW5nIikgewoJICAgICAgICAgICAgICAgIGpzb25TdHJpbmcgPSBrby51dGlscy5zdHJpbmdUcmltKGpzb25TdHJpbmcpOwoJICAgICAgICAgICAgICAgIGlmIChqc29uU3RyaW5nKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChKU09OICYmIEpTT04ucGFyc2UpIC8vIFVzZSBuYXRpdmUgcGFyc2luZyB3aGVyZSBhdmFpbGFibGUKCSAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKGpzb25TdHJpbmcpOwoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gKG5ldyBGdW5jdGlvbigicmV0dXJuICIgKyBqc29uU3RyaW5nKSkoKTsgLy8gRmFsbGJhY2sgb24gbGVzcyBzYWZlIHBhcnNpbmcgZm9yIG9sZGVyIGJyb3dzZXJzCgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgICAgIH0sCgoJICAgICAgICBzdHJpbmdpZnlKc29uOiBmdW5jdGlvbiAoZGF0YSwgcmVwbGFjZXIsIHNwYWNlKSB7ICAgLy8gcmVwbGFjZXIgYW5kIHNwYWNlIGFyZSBvcHRpb25hbAoJICAgICAgICAgICAgaWYgKCFKU09OIHx8ICFKU09OLnN0cmluZ2lmeSkKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmaW5kIEpTT04uc3RyaW5naWZ5KCkuIFNvbWUgYnJvd3NlcnMgKGUuZy4sIElFIDwgOCkgZG9uJ3Qgc3VwcG9ydCBpdCBuYXRpdmVseSwgYnV0IHlvdSBjYW4gb3ZlcmNvbWUgdGhpcyBieSBhZGRpbmcgYSBzY3JpcHQgcmVmZXJlbmNlIHRvIGpzb24yLmpzLCBkb3dubG9hZGFibGUgZnJvbSBodHRwOi8vd3d3Lmpzb24ub3JnL2pzb24yLmpzIik7CgkgICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhKSwgcmVwbGFjZXIsIHNwYWNlKTsKCSAgICAgICAgfSwKCgkgICAgICAgIHBvc3RKc29uOiBmdW5jdGlvbiAodXJsT3JGb3JtLCBkYXRhLCBvcHRpb25zKSB7CgkgICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgICAgICAgICAgIHZhciBwYXJhbXMgPSBvcHRpb25zWydwYXJhbXMnXSB8fCB7fTsKCSAgICAgICAgICAgIHZhciBpbmNsdWRlRmllbGRzID0gb3B0aW9uc1snaW5jbHVkZUZpZWxkcyddIHx8IHRoaXMuZmllbGRzSW5jbHVkZWRXaXRoSnNvblBvc3Q7CgkgICAgICAgICAgICB2YXIgdXJsID0gdXJsT3JGb3JtOwoKCSAgICAgICAgICAgIC8vIElmIHdlIHdlcmUgZ2l2ZW4gYSBmb3JtLCB1c2UgaXRzICdhY3Rpb24nIFVSTCBhbmQgcGljayBvdXQgYW55IHJlcXVlc3RlZCBmaWVsZCB2YWx1ZXMKCSAgICAgICAgICAgIGlmKCh0eXBlb2YgdXJsT3JGb3JtID09ICdvYmplY3QnKSAmJiAoa28udXRpbHMudGFnTmFtZUxvd2VyKHVybE9yRm9ybSkgPT09ICJmb3JtIikpIHsKCSAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxGb3JtID0gdXJsT3JGb3JtOwoJICAgICAgICAgICAgICAgIHVybCA9IG9yaWdpbmFsRm9ybS5hY3Rpb247CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IGluY2x1ZGVGaWVsZHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtvLnV0aWxzLmdldEZvcm1GaWVsZHMob3JpZ2luYWxGb3JtLCBpbmNsdWRlRmllbGRzW2ldKTsKCSAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IGZpZWxkcy5sZW5ndGggLSAxOyBqID49IDA7IGotLSkKCSAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtc1tmaWVsZHNbal0ubmFtZV0gPSBmaWVsZHNbal0udmFsdWU7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIGRhdGEgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGEpOwoJICAgICAgICAgICAgdmFyIGZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmb3JtIik7CgkgICAgICAgICAgICBmb3JtLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgkgICAgICAgICAgICBmb3JtLmFjdGlvbiA9IHVybDsKCSAgICAgICAgICAgIGZvcm0ubWV0aG9kID0gInBvc3QiOwoJICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIHsKCSAgICAgICAgICAgICAgICAvLyBTaW5jZSAnZGF0YScgdGhpcyBpcyBhIG1vZGVsIG9iamVjdCwgd2UgaW5jbHVkZSBhbGwgcHJvcGVydGllcyBpbmNsdWRpbmcgdGhvc2UgaW5oZXJpdGVkIGZyb20gaXRzIHByb3RvdHlwZQoJICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CgkgICAgICAgICAgICAgICAgaW5wdXQudHlwZSA9ICJoaWRkZW4iOwoJICAgICAgICAgICAgICAgIGlucHV0Lm5hbWUgPSBrZXk7CgkgICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBrby51dGlscy5zdHJpbmdpZnlKc29uKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoZGF0YVtrZXldKSk7CgkgICAgICAgICAgICAgICAgZm9ybS5hcHBlbmRDaGlsZChpbnB1dCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBvYmplY3RGb3JFYWNoKHBhcmFtcywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewoJICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CgkgICAgICAgICAgICAgICAgaW5wdXQudHlwZSA9ICJoaWRkZW4iOwoJICAgICAgICAgICAgICAgIGlucHV0Lm5hbWUgPSBrZXk7CgkgICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSB2YWx1ZTsKCSAgICAgICAgICAgICAgICBmb3JtLmFwcGVuZENoaWxkKGlucHV0KTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmb3JtKTsKCSAgICAgICAgICAgIG9wdGlvbnNbJ3N1Ym1pdHRlciddID8gb3B0aW9uc1snc3VibWl0dGVyJ10oZm9ybSkgOiBmb3JtLnN1Ym1pdCgpOwoJICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IGZvcm0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChmb3JtKTsgfSwgMCk7CgkgICAgICAgIH0KCSAgICB9Cgl9KCkpOwoKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMnLCBrby51dGlscyk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5Rm9yRWFjaCcsIGtvLnV0aWxzLmFycmF5Rm9yRWFjaCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5Rmlyc3QnLCBrby51dGlscy5hcnJheUZpcnN0KTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlGaWx0ZXInLCBrby51dGlscy5hcnJheUZpbHRlcik7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5R2V0RGlzdGluY3RWYWx1ZXMnLCBrby51dGlscy5hcnJheUdldERpc3RpbmN0VmFsdWVzKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlJbmRleE9mJywga28udXRpbHMuYXJyYXlJbmRleE9mKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlNYXAnLCBrby51dGlscy5hcnJheU1hcCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5UHVzaEFsbCcsIGtvLnV0aWxzLmFycmF5UHVzaEFsbCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5UmVtb3ZlSXRlbScsIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbSk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmV4dGVuZCcsIGtvLnV0aWxzLmV4dGVuZCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0Jywga28udXRpbHMuZmllbGRzSW5jbHVkZWRXaXRoSnNvblBvc3QpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5nZXRGb3JtRmllbGRzJywga28udXRpbHMuZ2V0Rm9ybUZpZWxkcyk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnBlZWtPYnNlcnZhYmxlJywga28udXRpbHMucGVla09ic2VydmFibGUpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wb3N0SnNvbicsIGtvLnV0aWxzLnBvc3RKc29uKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMucGFyc2VKc29uJywga28udXRpbHMucGFyc2VKc29uKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXInLCBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcik7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnN0cmluZ2lmeUpzb24nLCBrby51dGlscy5zdHJpbmdpZnlKc29uKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMucmFuZ2UnLCBrby51dGlscy5yYW5nZSk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcycsIGtvLnV0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcyk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnRyaWdnZXJFdmVudCcsIGtvLnV0aWxzLnRyaWdnZXJFdmVudCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnVud3JhcE9ic2VydmFibGUnLCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMub2JqZWN0Rm9yRWFjaCcsIGtvLnV0aWxzLm9iamVjdEZvckVhY2gpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hZGRPclJlbW92ZUl0ZW0nLCBrby51dGlscy5hZGRPclJlbW92ZUl0ZW0pOwoJa28uZXhwb3J0U3ltYm9sKCd1bndyYXAnLCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKTsgLy8gQ29udmVuaWVudCBzaG9ydGhhbmQsIGJlY2F1c2UgdGhpcyBpcyB1c2VkIHNvIGNvbW1vbmx5CgoJaWYgKCFGdW5jdGlvbi5wcm90b3R5cGVbJ2JpbmQnXSkgewoJICAgIC8vIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kIGlzIGEgc3RhbmRhcmQgcGFydCBvZiBFQ01BU2NyaXB0IDV0aCBFZGl0aW9uIChEZWNlbWJlciAyMDA5LCBodHRwOi8vd3d3LmVjbWEtaW50ZXJuYXRpb25hbC5vcmcvcHVibGljYXRpb25zL2ZpbGVzL0VDTUEtU1QvRUNNQS0yNjIucGRmKQoJICAgIC8vIEluIGNhc2UgdGhlIGJyb3dzZXIgZG9lc24ndCBpbXBsZW1lbnQgaXQgbmF0aXZlbHksIHByb3ZpZGUgYSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uLiBUaGlzIGltcGxlbWVudGF0aW9uIGlzIGJhc2VkIG9uIHRoZSBvbmUgaW4gcHJvdG90eXBlLmpzCgkgICAgRnVuY3Rpb24ucHJvdG90eXBlWydiaW5kJ10gPSBmdW5jdGlvbiAob2JqZWN0KSB7CgkgICAgICAgIHZhciBvcmlnaW5hbEZ1bmN0aW9uID0gdGhpcywgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyksIG9iamVjdCA9IGFyZ3Muc2hpZnQoKTsKCSAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbEZ1bmN0aW9uLmFwcGx5KG9iamVjdCwgYXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwoJICAgICAgICB9OwoJICAgIH07Cgl9CgoJa28udXRpbHMuZG9tRGF0YSA9IG5ldyAoZnVuY3Rpb24gKCkgewoJICAgIHZhciB1bmlxdWVJZCA9IDA7CgkgICAgdmFyIGRhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWUgPSAiX19rb19fIiArIChuZXcgRGF0ZSkuZ2V0VGltZSgpOwoJICAgIHZhciBkYXRhU3RvcmUgPSB7fTsKCgkgICAgZnVuY3Rpb24gZ2V0QWxsKG5vZGUsIGNyZWF0ZUlmTm90Rm91bmQpIHsKCSAgICAgICAgdmFyIGRhdGFTdG9yZUtleSA9IG5vZGVbZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZV07CgkgICAgICAgIHZhciBoYXNFeGlzdGluZ0RhdGFTdG9yZSA9IGRhdGFTdG9yZUtleSAmJiAoZGF0YVN0b3JlS2V5ICE9PSAibnVsbCIpICYmIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldOwoJICAgICAgICBpZiAoIWhhc0V4aXN0aW5nRGF0YVN0b3JlKSB7CgkgICAgICAgICAgICBpZiAoIWNyZWF0ZUlmTm90Rm91bmQpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKCSAgICAgICAgICAgIGRhdGFTdG9yZUtleSA9IG5vZGVbZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZV0gPSAia28iICsgdW5pcXVlSWQrKzsKCSAgICAgICAgICAgIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldID0ge307CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldOwoJICAgIH0KCgkgICAgcmV0dXJuIHsKCSAgICAgICAgZ2V0OiBmdW5jdGlvbiAobm9kZSwga2V5KSB7CgkgICAgICAgICAgICB2YXIgYWxsRGF0YUZvck5vZGUgPSBnZXRBbGwobm9kZSwgZmFsc2UpOwoJICAgICAgICAgICAgcmV0dXJuIGFsbERhdGFGb3JOb2RlID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBhbGxEYXRhRm9yTm9kZVtrZXldOwoJICAgICAgICB9LAoJICAgICAgICBzZXQ6IGZ1bmN0aW9uIChub2RlLCBrZXksIHZhbHVlKSB7CgkgICAgICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBkb24ndCBhY3R1YWxseSBjcmVhdGUgYSBuZXcgZG9tRGF0YSBrZXkgaWYgd2UgYXJlIGFjdHVhbGx5IGRlbGV0aW5nIGEgdmFsdWUKCSAgICAgICAgICAgICAgICBpZiAoZ2V0QWxsKG5vZGUsIGZhbHNlKSA9PT0gdW5kZWZpbmVkKQoJICAgICAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICB2YXIgYWxsRGF0YUZvck5vZGUgPSBnZXRBbGwobm9kZSwgdHJ1ZSk7CgkgICAgICAgICAgICBhbGxEYXRhRm9yTm9kZVtrZXldID0gdmFsdWU7CgkgICAgICAgIH0sCgkgICAgICAgIGNsZWFyOiBmdW5jdGlvbiAobm9kZSkgewoJICAgICAgICAgICAgdmFyIGRhdGFTdG9yZUtleSA9IG5vZGVbZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZV07CgkgICAgICAgICAgICBpZiAoZGF0YVN0b3JlS2V5KSB7CgkgICAgICAgICAgICAgICAgZGVsZXRlIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldOwoJICAgICAgICAgICAgICAgIG5vZGVbZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZV0gPSBudWxsOwoJICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBFeHBvc2luZyAiZGlkIGNsZWFuIiBmbGFnIHB1cmVseSBzbyBzcGVjcyBjYW4gaW5mZXIgd2hldGhlciB0aGluZ3MgaGF2ZSBiZWVuIGNsZWFuZWQgdXAgYXMgaW50ZW5kZWQKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCSAgICAgICAgfSwKCgkgICAgICAgIG5leHRLZXk6IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgIHJldHVybiAodW5pcXVlSWQrKykgKyBkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lOwoJICAgICAgICB9CgkgICAgfTsKCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21EYXRhJywga28udXRpbHMuZG9tRGF0YSk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbURhdGEuY2xlYXInLCBrby51dGlscy5kb21EYXRhLmNsZWFyKTsgLy8gRXhwb3J0aW5nIG9ubHkgc28gc3BlY3MgY2FuIGNsZWFyIHVwIGFmdGVyIHRoZW1zZWx2ZXMgZnVsbHkKCglrby51dGlscy5kb21Ob2RlRGlzcG9zYWwgPSBuZXcgKGZ1bmN0aW9uICgpIHsKCSAgICB2YXIgZG9tRGF0YUtleSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpOwoJICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXMgPSB7IDE6IHRydWUsIDg6IHRydWUsIDk6IHRydWUgfTsgICAgICAgLy8gRWxlbWVudCwgQ29tbWVudCwgRG9jdW1lbnQKCSAgICB2YXIgY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzID0geyAxOiB0cnVlLCA5OiB0cnVlIH07IC8vIEVsZW1lbnQsIERvY3VtZW50CgoJICAgIGZ1bmN0aW9uIGdldERpc3Bvc2VDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUsIGNyZWF0ZUlmTm90Rm91bmQpIHsKCSAgICAgICAgdmFyIGFsbERpc3Bvc2VDYWxsYmFja3MgPSBrby51dGlscy5kb21EYXRhLmdldChub2RlLCBkb21EYXRhS2V5KTsKCSAgICAgICAgaWYgKChhbGxEaXNwb3NlQ2FsbGJhY2tzID09PSB1bmRlZmluZWQpICYmIGNyZWF0ZUlmTm90Rm91bmQpIHsKCSAgICAgICAgICAgIGFsbERpc3Bvc2VDYWxsYmFja3MgPSBbXTsKCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIGRvbURhdGFLZXksIGFsbERpc3Bvc2VDYWxsYmFja3MpOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiBhbGxEaXNwb3NlQ2FsbGJhY2tzOwoJICAgIH0KCSAgICBmdW5jdGlvbiBkZXN0cm95Q2FsbGJhY2tzQ29sbGVjdGlvbihub2RlKSB7CgkgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIGRvbURhdGFLZXksIHVuZGVmaW5lZCk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBjbGVhblNpbmdsZU5vZGUobm9kZSkgewoJICAgICAgICAvLyBSdW4gYWxsIHRoZSBkaXNwb3NlIGNhbGxiYWNrcwoJICAgICAgICB2YXIgY2FsbGJhY2tzID0gZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgZmFsc2UpOwoJICAgICAgICBpZiAoY2FsbGJhY2tzKSB7CgkgICAgICAgICAgICBjYWxsYmFja3MgPSBjYWxsYmFja3Muc2xpY2UoMCk7IC8vIENsb25lLCBhcyB0aGUgYXJyYXkgbWF5IGJlIG1vZGlmaWVkIGR1cmluZyBpdGVyYXRpb24gKHR5cGljYWxseSwgY2FsbGJhY2tzIHdpbGwgcmVtb3ZlIHRoZW1zZWx2ZXMpCgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhbGxiYWNrcy5sZW5ndGg7IGkrKykKCSAgICAgICAgICAgICAgICBjYWxsYmFja3NbaV0obm9kZSk7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIEVyYXNlIHRoZSBET00gZGF0YQoJICAgICAgICBrby51dGlscy5kb21EYXRhLmNsZWFyKG5vZGUpOwoKCSAgICAgICAgLy8gUGVyZm9ybSBjbGVhbnVwIG5lZWRlZCBieSBleHRlcm5hbCBsaWJyYXJpZXMgKGN1cnJlbnRseSBvbmx5IGpRdWVyeSwgYnV0IGNhbiBiZSBleHRlbmRlZCkKCSAgICAgICAga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsWyJjbGVhbkV4dGVybmFsRGF0YSJdKG5vZGUpOwoKCSAgICAgICAgLy8gQ2xlYXIgYW55IGltbWVkaWF0ZS1jaGlsZCBjb21tZW50IG5vZGVzLCBhcyB0aGVzZSB3b3VsZG4ndCBoYXZlIGJlZW4gZm91bmQgYnkKCSAgICAgICAgLy8gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpIGluIGNsZWFuTm9kZSgpIChjb21tZW50IG5vZGVzIGFyZW4ndCBlbGVtZW50cykKCSAgICAgICAgaWYgKGNsZWFuYWJsZU5vZGVUeXBlc1dpdGhEZXNjZW5kYW50c1tub2RlLm5vZGVUeXBlXSkKCSAgICAgICAgICAgIGNsZWFuSW1tZWRpYXRlQ29tbWVudFR5cGVDaGlsZHJlbihub2RlKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNsZWFuSW1tZWRpYXRlQ29tbWVudFR5cGVDaGlsZHJlbihub2RlV2l0aENoaWxkcmVuKSB7CgkgICAgICAgIHZhciBjaGlsZCwgbmV4dENoaWxkID0gbm9kZVdpdGhDaGlsZHJlbi5maXJzdENoaWxkOwoJICAgICAgICB3aGlsZSAoY2hpbGQgPSBuZXh0Q2hpbGQpIHsKCSAgICAgICAgICAgIG5leHRDaGlsZCA9IGNoaWxkLm5leHRTaWJsaW5nOwoJICAgICAgICAgICAgaWYgKGNoaWxkLm5vZGVUeXBlID09PSA4KQoJICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShjaGlsZCk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIHJldHVybiB7CgkgICAgICAgIGFkZERpc3Bvc2VDYWxsYmFjayA6IGZ1bmN0aW9uKG5vZGUsIGNhbGxiYWNrKSB7CgkgICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICJmdW5jdGlvbiIpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYWxsYmFjayBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKCSAgICAgICAgICAgIGdldERpc3Bvc2VDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUsIHRydWUpLnB1c2goY2FsbGJhY2spOwoJICAgICAgICB9LAoKCSAgICAgICAgcmVtb3ZlRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKCSAgICAgICAgICAgIHZhciBjYWxsYmFja3NDb2xsZWN0aW9uID0gZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgZmFsc2UpOwoJICAgICAgICAgICAgaWYgKGNhbGxiYWNrc0NvbGxlY3Rpb24pIHsKCSAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVJlbW92ZUl0ZW0oY2FsbGJhY2tzQ29sbGVjdGlvbiwgY2FsbGJhY2spOwoJICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja3NDb2xsZWN0aW9uLmxlbmd0aCA9PSAwKQoJICAgICAgICAgICAgICAgICAgICBkZXN0cm95Q2FsbGJhY2tzQ29sbGVjdGlvbihub2RlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIGNsZWFuTm9kZSA6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIC8vIEZpcnN0IGNsZWFuIHRoaXMgbm9kZSwgd2hlcmUgYXBwbGljYWJsZQoJICAgICAgICAgICAgaWYgKGNsZWFuYWJsZU5vZGVUeXBlc1tub2RlLm5vZGVUeXBlXSkgewoJICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShub2RlKTsKCgkgICAgICAgICAgICAgICAgLy8gLi4uIHRoZW4gaXRzIGRlc2NlbmRhbnRzLCB3aGVyZSBhcHBsaWNhYmxlCgkgICAgICAgICAgICAgICAgaWYgKGNsZWFuYWJsZU5vZGVUeXBlc1dpdGhEZXNjZW5kYW50c1tub2RlLm5vZGVUeXBlXSkgewoJICAgICAgICAgICAgICAgICAgICAvLyBDbG9uZSB0aGUgZGVzY2VuZGFudHMgbGlzdCBpbiBjYXNlIGl0IGNoYW5nZXMgZHVyaW5nIGl0ZXJhdGlvbgoJICAgICAgICAgICAgICAgICAgICB2YXIgZGVzY2VuZGFudHMgPSBbXTsKCSAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYXJyYXlQdXNoQWxsKGRlc2NlbmRhbnRzLCBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikpOwoJICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGRlc2NlbmRhbnRzLmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShkZXNjZW5kYW50c1tpXSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG5vZGU7CgkgICAgICAgIH0sCgoJICAgICAgICByZW1vdmVOb2RlIDogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAga28uY2xlYW5Ob2RlKG5vZGUpOwoJICAgICAgICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZSkKCSAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7CgkgICAgICAgIH0sCgoJICAgICAgICAiY2xlYW5FeHRlcm5hbERhdGEiIDogZnVuY3Rpb24gKG5vZGUpIHsKCSAgICAgICAgICAgIC8vIFNwZWNpYWwgc3VwcG9ydCBmb3IgalF1ZXJ5IGhlcmUgYmVjYXVzZSBpdCdzIHNvIGNvbW1vbmx5IHVzZWQuCgkgICAgICAgICAgICAvLyBNYW55IGpRdWVyeSBwbHVnaW5zIChpbmNsdWRpbmcganF1ZXJ5LnRtcGwpIHN0b3JlIGRhdGEgdXNpbmcgalF1ZXJ5J3MgZXF1aXZhbGVudCBvZiBkb21EYXRhCgkgICAgICAgICAgICAvLyBzbyBub3RpZnkgaXQgdG8gdGVhciBkb3duIGFueSByZXNvdXJjZXMgYXNzb2NpYXRlZCB3aXRoIHRoZSBub2RlICYgZGVzY2VuZGFudHMgaGVyZS4KCSAgICAgICAgICAgIGlmIChqUXVlcnlJbnN0YW5jZSAmJiAodHlwZW9mIGpRdWVyeUluc3RhbmNlWydjbGVhbkRhdGEnXSA9PSAiZnVuY3Rpb24iKSkKCSAgICAgICAgICAgICAgICBqUXVlcnlJbnN0YW5jZVsnY2xlYW5EYXRhJ10oW25vZGVdKTsKCSAgICAgICAgfQoJICAgIH0KCX0pKCk7Cglrby5jbGVhbk5vZGUgPSBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuY2xlYW5Ob2RlOyAvLyBTaG9ydGhhbmQgbmFtZSBmb3IgY29udmVuaWVuY2UKCWtvLnJlbW92ZU5vZGUgPSBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlTm9kZTsgLy8gU2hvcnRoYW5kIG5hbWUgZm9yIGNvbnZlbmllbmNlCglrby5leHBvcnRTeW1ib2woJ2NsZWFuTm9kZScsIGtvLmNsZWFuTm9kZSk7Cglrby5leHBvcnRTeW1ib2woJ3JlbW92ZU5vZGUnLCBrby5yZW1vdmVOb2RlKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tTm9kZURpc3Bvc2FsJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjaycsIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5hZGREaXNwb3NlQ2FsbGJhY2spOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlRGlzcG9zZUNhbGxiYWNrJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLnJlbW92ZURpc3Bvc2VDYWxsYmFjayk7CgkoZnVuY3Rpb24gKCkgewoJICAgIHZhciBsZWFkaW5nQ29tbWVudFJlZ2V4ID0gL14oXHMqKTwhLS0oLio/KS0tPi87CgoJICAgIGZ1bmN0aW9uIHNpbXBsZUh0bWxQYXJzZShodG1sKSB7CgkgICAgICAgIC8vIEJhc2VkIG9uIGpRdWVyeSdzICJjbGVhbiIgZnVuY3Rpb24sIGJ1dCBvbmx5IGFjY291bnRpbmcgZm9yIHRhYmxlLXJlbGF0ZWQgZWxlbWVudHMuCgkgICAgICAgIC8vIElmIHlvdSBoYXZlIHJlZmVyZW5jZWQgalF1ZXJ5LCB0aGlzIHdvbid0IGJlIHVzZWQgYW55d2F5IC0gS08gd2lsbCB1c2UgalF1ZXJ5J3MgImNsZWFuIiBmdW5jdGlvbiBkaXJlY3RseQoKCSAgICAgICAgLy8gTm90ZSB0aGF0IHRoZXJlJ3Mgc3RpbGwgYW4gaXNzdWUgaW4gSUUgPCA5IHdoZXJlYnkgaXQgd2lsbCBkaXNjYXJkIGNvbW1lbnQgbm9kZXMgdGhhdCBhcmUgdGhlIGZpcnN0IGNoaWxkIG9mCgkgICAgICAgIC8vIGEgZGVzY2VuZGFudCBub2RlLiBGb3IgZXhhbXBsZTogIjxkaXY+PCEtLSBteWNvbW1lbnQgLS0+YWJjPC9kaXY+IiB3aWxsIGdldCBwYXJzZWQgYXMgIjxkaXY+YWJjPC9kaXY+IgoJICAgICAgICAvLyBUaGlzIHdvbid0IGFmZmVjdCBhbnlvbmUgd2hvIGhhcyByZWZlcmVuY2VkIGpRdWVyeSwgYW5kIHRoZXJlJ3MgYWx3YXlzIHRoZSB3b3JrYXJvdW5kIG9mIGluc2VydGluZyBhIGR1bW15IG5vZGUKCSAgICAgICAgLy8gKHBvc3NpYmx5IGEgdGV4dCBub2RlKSBpbiBmcm9udCBvZiB0aGUgY29tbWVudC4gU28sIEtPIGRvZXMgbm90IGF0dGVtcHQgdG8gd29ya2Fyb3VuZCB0aGlzIElFIGlzc3VlIGF1dG9tYXRpY2FsbHkgYXQgcHJlc2VudC4KCgkgICAgICAgIC8vIFRyaW0gd2hpdGVzcGFjZSwgb3RoZXJ3aXNlIGluZGV4T2Ygd29uJ3Qgd29yayBhcyBleHBlY3RlZAoJICAgICAgICB2YXIgdGFncyA9IGtvLnV0aWxzLnN0cmluZ1RyaW0oaHRtbCkudG9Mb3dlckNhc2UoKSwgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CgoJICAgICAgICAvLyBGaW5kcyB0aGUgZmlyc3QgbWF0Y2ggZnJvbSB0aGUgbGVmdCBjb2x1bW4sIGFuZCByZXR1cm5zIHRoZSBjb3JyZXNwb25kaW5nICJ3cmFwIiBkYXRhIGZyb20gdGhlIHJpZ2h0IGNvbHVtbgoJICAgICAgICB2YXIgd3JhcCA9IHRhZ3MubWF0Y2goL148KHRoZWFkfHRib2R5fHRmb290KS8pICAgICAgICAgICAgICAmJiBbMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iXSB8fAoJICAgICAgICAgICAgICAgICAgICF0YWdzLmluZGV4T2YoIjx0ciIpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBbMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iXSB8fAoJICAgICAgICAgICAgICAgICAgICghdGFncy5pbmRleE9mKCI8dGQiKSB8fCAhdGFncy5pbmRleE9mKCI8dGgiKSkgICAmJiBbMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iXSB8fAoJICAgICAgICAgICAgICAgICAgIC8qIGFueXRoaW5nIGVsc2UgKi8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbMCwgIiIsICIiXTsKCgkgICAgICAgIC8vIEdvIHRvIGh0bWwgYW5kIGJhY2ssIHRoZW4gcGVlbCBvZmYgZXh0cmEgd3JhcHBlcnMKCSAgICAgICAgLy8gTm90ZSB0aGF0IHdlIGFsd2F5cyBwcmVmaXggd2l0aCBzb21lIGR1bW15IHRleHQsIGJlY2F1c2Ugb3RoZXJ3aXNlLCBJRTw5IHdpbGwgc3RyaXAgb3V0IGxlYWRpbmcgY29tbWVudCBub2RlcyBpbiBkZXNjZW5kYW50cy4gVG90YWwgbWFkbmVzcy4KCSAgICAgICAgdmFyIG1hcmt1cCA9ICJpZ25vcmVkPGRpdj4iICsgd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdICsgIjwvZGl2PiI7CgkgICAgICAgIGlmICh0eXBlb2Ygd2luZG93Wydpbm5lclNoaXYnXSA9PSAiZnVuY3Rpb24iKSB7CgkgICAgICAgICAgICBkaXYuYXBwZW5kQ2hpbGQod2luZG93Wydpbm5lclNoaXYnXShtYXJrdXApKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSBtYXJrdXA7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIE1vdmUgdG8gdGhlIHJpZ2h0IGRlcHRoCgkgICAgICAgIHdoaWxlICh3cmFwWzBdLS0pCgkgICAgICAgICAgICBkaXYgPSBkaXYubGFzdENoaWxkOwoKCSAgICAgICAgcmV0dXJuIGtvLnV0aWxzLm1ha2VBcnJheShkaXYubGFzdENoaWxkLmNoaWxkTm9kZXMpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24galF1ZXJ5SHRtbFBhcnNlKGh0bWwpIHsKCSAgICAgICAgLy8galF1ZXJ5J3MgInBhcnNlSFRNTCIgZnVuY3Rpb24gd2FzIGludHJvZHVjZWQgaW4galF1ZXJ5IDEuOC4wIGFuZCBpcyBhIGRvY3VtZW50ZWQgcHVibGljIEFQSS4KCSAgICAgICAgaWYgKGpRdWVyeUluc3RhbmNlWydwYXJzZUhUTUwnXSkgewoJICAgICAgICAgICAgcmV0dXJuIGpRdWVyeUluc3RhbmNlWydwYXJzZUhUTUwnXShodG1sKSB8fCBbXTsgLy8gRW5zdXJlIHdlIGFsd2F5cyByZXR1cm4gYW4gYXJyYXkgYW5kIG5ldmVyIG51bGwKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIC8vIEZvciBqUXVlcnkgPCAxLjguMCwgd2UgZmFsbCBiYWNrIG9uIHRoZSB1bmRvY3VtZW50ZWQgaW50ZXJuYWwgImNsZWFuIiBmdW5jdGlvbi4KCSAgICAgICAgICAgIHZhciBlbGVtcyA9IGpRdWVyeUluc3RhbmNlWydjbGVhbiddKFtodG1sXSk7CgoJICAgICAgICAgICAgLy8gQXMgb2YgalF1ZXJ5IDEuNy4xLCBqUXVlcnkgcGFyc2VzIHRoZSBIVE1MIGJ5IGFwcGVuZGluZyBpdCB0byBzb21lIGR1bW15IHBhcmVudCBub2RlcyBoZWxkIGluIGFuIGluLW1lbW9yeSBkb2N1bWVudCBmcmFnbWVudC4KCSAgICAgICAgICAgIC8vIFVuZm9ydHVuYXRlbHksIGl0IG5ldmVyIGNsZWFycyB0aGUgZHVtbXkgcGFyZW50IG5vZGVzIGZyb20gdGhlIGRvY3VtZW50IGZyYWdtZW50LCBzbyBpdCBsZWFrcyBtZW1vcnkgb3ZlciB0aW1lLgoJICAgICAgICAgICAgLy8gRml4IHRoaXMgYnkgZmluZGluZyB0aGUgdG9wLW1vc3QgZHVtbXkgcGFyZW50IGVsZW1lbnQsIGFuZCBkZXRhY2hpbmcgaXQgZnJvbSBpdHMgb3duZXIgZnJhZ21lbnQuCgkgICAgICAgICAgICBpZiAoZWxlbXMgJiYgZWxlbXNbMF0pIHsKCSAgICAgICAgICAgICAgICAvLyBGaW5kIHRoZSB0b3AtbW9zdCBwYXJlbnQgZWxlbWVudCB0aGF0J3MgYSBkaXJlY3QgY2hpbGQgb2YgYSBkb2N1bWVudCBmcmFnbWVudAoJICAgICAgICAgICAgICAgIHZhciBlbGVtID0gZWxlbXNbMF07CgkgICAgICAgICAgICAgICAgd2hpbGUgKGVsZW0ucGFyZW50Tm9kZSAmJiBlbGVtLnBhcmVudE5vZGUubm9kZVR5cGUgIT09IDExIC8qIGkuZS4sIERvY3VtZW50RnJhZ21lbnQgKi8pCgkgICAgICAgICAgICAgICAgICAgIGVsZW0gPSBlbGVtLnBhcmVudE5vZGU7CgkgICAgICAgICAgICAgICAgLy8gLi4uIHRoZW4gZGV0YWNoIGl0CgkgICAgICAgICAgICAgICAgaWYgKGVsZW0ucGFyZW50Tm9kZSkKCSAgICAgICAgICAgICAgICAgICAgZWxlbS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsZW0pOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIHJldHVybiBlbGVtczsKCSAgICAgICAgfQoJICAgIH0KCgkgICAga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQgPSBmdW5jdGlvbihodG1sKSB7CgkgICAgICAgIHJldHVybiBqUXVlcnlJbnN0YW5jZSA/IGpRdWVyeUh0bWxQYXJzZShodG1sKSAgIC8vIEFzIGJlbG93LCBiZW5lZml0IGZyb20galF1ZXJ5J3Mgb3B0aW1pc2F0aW9ucyB3aGVyZSBwb3NzaWJsZQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBzaW1wbGVIdG1sUGFyc2UoaHRtbCk7ICAvLyAuLi4gb3RoZXJ3aXNlLCB0aGlzIHNpbXBsZSBsb2dpYyB3aWxsIGRvIGluIG1vc3QgY29tbW9uIGNhc2VzLgoJICAgIH07CgoJICAgIGtvLnV0aWxzLnNldEh0bWwgPSBmdW5jdGlvbihub2RlLCBodG1sKSB7CgkgICAgICAgIGtvLnV0aWxzLmVtcHR5RG9tTm9kZShub2RlKTsKCgkgICAgICAgIC8vIFRoZXJlJ3Mgbm8gbGVnaXRpbWF0ZSByZWFzb24gdG8gZGlzcGxheSBhIHN0cmluZ2lmaWVkIG9ic2VydmFibGUgd2l0aG91dCB1bndyYXBwaW5nIGl0LCBzbyB3ZSdsbCB1bndyYXAgaXQKCSAgICAgICAgaHRtbCA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoaHRtbCk7CgoJICAgICAgICBpZiAoKGh0bWwgIT09IG51bGwpICYmIChodG1sICE9PSB1bmRlZmluZWQpKSB7CgkgICAgICAgICAgICBpZiAodHlwZW9mIGh0bWwgIT0gJ3N0cmluZycpCgkgICAgICAgICAgICAgICAgaHRtbCA9IGh0bWwudG9TdHJpbmcoKTsKCgkgICAgICAgICAgICAvLyBqUXVlcnkgY29udGFpbnMgYSBsb3Qgb2Ygc29waGlzdGljYXRlZCBjb2RlIHRvIHBhcnNlIGFyYml0cmFyeSBIVE1MIGZyYWdtZW50cywKCSAgICAgICAgICAgIC8vIGZvciBleGFtcGxlIDx0cj4gZWxlbWVudHMgd2hpY2ggYXJlIG5vdCBub3JtYWxseSBhbGxvd2VkIHRvIGV4aXN0IG9uIHRoZWlyIG93bi4KCSAgICAgICAgICAgIC8vIElmIHlvdSd2ZSByZWZlcmVuY2VkIGpRdWVyeSB3ZSdsbCB1c2UgdGhhdCByYXRoZXIgdGhhbiBkdXBsaWNhdGluZyBpdHMgY29kZS4KCSAgICAgICAgICAgIGlmIChqUXVlcnlJbnN0YW5jZSkgewoJICAgICAgICAgICAgICAgIGpRdWVyeUluc3RhbmNlKG5vZGUpWydodG1sJ10oaHRtbCk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIC4uLiBvdGhlcndpc2UsIHVzZSBLTydzIG93biBwYXJzaW5nIGxvZ2ljLgoJICAgICAgICAgICAgICAgIHZhciBwYXJzZWROb2RlcyA9IGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KGh0bWwpOwoJICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyc2VkTm9kZXMubGVuZ3RoOyBpKyspCgkgICAgICAgICAgICAgICAgICAgIG5vZGUuYXBwZW5kQ2hpbGQocGFyc2VkTm9kZXNbaV0pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfTsKCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wYXJzZUh0bWxGcmFnbWVudCcsIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuc2V0SHRtbCcsIGtvLnV0aWxzLnNldEh0bWwpOwoKCWtvLm1lbW9pemF0aW9uID0gKGZ1bmN0aW9uICgpIHsKCSAgICB2YXIgbWVtb3MgPSB7fTsKCgkgICAgZnVuY3Rpb24gcmFuZG9tTWF4OEhleENoYXJzKCkgewoJICAgICAgICByZXR1cm4gKCgoMSArIE1hdGgucmFuZG9tKCkpICogMHgxMDAwMDAwMDApIHwgMCkudG9TdHJpbmcoMTYpLnN1YnN0cmluZygxKTsKCSAgICB9CgkgICAgZnVuY3Rpb24gZ2VuZXJhdGVSYW5kb21JZCgpIHsKCSAgICAgICAgcmV0dXJuIHJhbmRvbU1heDhIZXhDaGFycygpICsgcmFuZG9tTWF4OEhleENoYXJzKCk7CgkgICAgfQoJICAgIGZ1bmN0aW9uIGZpbmRNZW1vTm9kZXMocm9vdE5vZGUsIGFwcGVuZFRvQXJyYXkpIHsKCSAgICAgICAgaWYgKCFyb290Tm9kZSkKCSAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgaWYgKHJvb3ROb2RlLm5vZGVUeXBlID09IDgpIHsKCSAgICAgICAgICAgIHZhciBtZW1vSWQgPSBrby5tZW1vaXphdGlvbi5wYXJzZU1lbW9UZXh0KHJvb3ROb2RlLm5vZGVWYWx1ZSk7CgkgICAgICAgICAgICBpZiAobWVtb0lkICE9IG51bGwpCgkgICAgICAgICAgICAgICAgYXBwZW5kVG9BcnJheS5wdXNoKHsgZG9tTm9kZTogcm9vdE5vZGUsIG1lbW9JZDogbWVtb0lkIH0pOwoJICAgICAgICB9IGVsc2UgaWYgKHJvb3ROb2RlLm5vZGVUeXBlID09IDEpIHsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZE5vZGVzID0gcm9vdE5vZGUuY2hpbGROb2RlcywgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgIGZpbmRNZW1vTm9kZXMoY2hpbGROb2Rlc1tpXSwgYXBwZW5kVG9BcnJheSk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIHJldHVybiB7CgkgICAgICAgIG1lbW9pemU6IGZ1bmN0aW9uIChjYWxsYmFjaykgewoJICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiWW91IGNhbiBvbmx5IHBhc3MgYSBmdW5jdGlvbiB0byBrby5tZW1vaXphdGlvbi5tZW1vaXplKCkiKTsKCSAgICAgICAgICAgIHZhciBtZW1vSWQgPSBnZW5lcmF0ZVJhbmRvbUlkKCk7CgkgICAgICAgICAgICBtZW1vc1ttZW1vSWRdID0gY2FsbGJhY2s7CgkgICAgICAgICAgICByZXR1cm4gIjwhLS1ba29fbWVtbzoiICsgbWVtb0lkICsgIl0tLT4iOwoJICAgICAgICB9LAoKCSAgICAgICAgdW5tZW1vaXplOiBmdW5jdGlvbiAobWVtb0lkLCBjYWxsYmFja1BhcmFtcykgewoJICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gbWVtb3NbbWVtb0lkXTsKCSAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gdW5kZWZpbmVkKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ291bGRuJ3QgZmluZCBhbnkgbWVtbyB3aXRoIElEICIgKyBtZW1vSWQgKyAiLiBQZXJoYXBzIGl0J3MgYWxyZWFkeSBiZWVuIHVubWVtb2l6ZWQuIik7CgkgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KG51bGwsIGNhbGxiYWNrUGFyYW1zIHx8IFtdKTsKCSAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGZpbmFsbHkgeyBkZWxldGUgbWVtb3NbbWVtb0lkXTsgfQoJICAgICAgICB9LAoKCSAgICAgICAgdW5tZW1vaXplRG9tTm9kZUFuZERlc2NlbmRhbnRzOiBmdW5jdGlvbiAoZG9tTm9kZSwgZXh0cmFDYWxsYmFja1BhcmFtc0FycmF5KSB7CgkgICAgICAgICAgICB2YXIgbWVtb3MgPSBbXTsKCSAgICAgICAgICAgIGZpbmRNZW1vTm9kZXMoZG9tTm9kZSwgbWVtb3MpOwoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBtZW1vcy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKCSAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IG1lbW9zW2ldLmRvbU5vZGU7CgkgICAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkUGFyYW1zID0gW25vZGVdOwoJICAgICAgICAgICAgICAgIGlmIChleHRyYUNhbGxiYWNrUGFyYW1zQXJyYXkpCgkgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UHVzaEFsbChjb21iaW5lZFBhcmFtcywgZXh0cmFDYWxsYmFja1BhcmFtc0FycmF5KTsKCSAgICAgICAgICAgICAgICBrby5tZW1vaXphdGlvbi51bm1lbW9pemUobWVtb3NbaV0ubWVtb0lkLCBjb21iaW5lZFBhcmFtcyk7CgkgICAgICAgICAgICAgICAgbm9kZS5ub2RlVmFsdWUgPSAiIjsgLy8gTmV1dGVyIHRoaXMgbm9kZSBzbyB3ZSBkb24ndCB0cnkgdG8gdW5tZW1vaXplIGl0IGFnYWluCgkgICAgICAgICAgICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZSkKCSAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOyAvLyBJZiBwb3NzaWJsZSwgZXJhc2UgaXQgdG90YWxseSAobm90IGFsd2F5cyBwb3NzaWJsZSAtIHNvbWVvbmUgZWxzZSBtaWdodCBqdXN0IGhvbGQgYSByZWZlcmVuY2UgdG8gaXQgdGhlbiBjYWxsIHVubWVtb2l6ZURvbU5vZGVBbmREZXNjZW5kYW50cyBhZ2FpbikKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIHBhcnNlTWVtb1RleHQ6IGZ1bmN0aW9uIChtZW1vVGV4dCkgewoJICAgICAgICAgICAgdmFyIG1hdGNoID0gbWVtb1RleHQubWF0Y2goL15cW2tvX21lbW9cOiguKj8pXF0kLyk7CgkgICAgICAgICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6IG51bGw7CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uJywga28ubWVtb2l6YXRpb24pOwoJa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi5tZW1vaXplJywga28ubWVtb2l6YXRpb24ubWVtb2l6ZSk7Cglrby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLnVubWVtb2l6ZScsIGtvLm1lbW9pemF0aW9uLnVubWVtb2l6ZSk7Cglrby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLnBhcnNlTWVtb1RleHQnLCBrby5tZW1vaXphdGlvbi5wYXJzZU1lbW9UZXh0KTsKCWtvLmV4cG9ydFN5bWJvbCgnbWVtb2l6YXRpb24udW5tZW1vaXplRG9tTm9kZUFuZERlc2NlbmRhbnRzJywga28ubWVtb2l6YXRpb24udW5tZW1vaXplRG9tTm9kZUFuZERlc2NlbmRhbnRzKTsKCWtvLmV4dGVuZGVycyA9IHsKCSAgICAndGhyb3R0bGUnOiBmdW5jdGlvbih0YXJnZXQsIHRpbWVvdXQpIHsKCSAgICAgICAgLy8gVGhyb3R0bGluZyBtZWFucyB0d28gdGhpbmdzOgoKCSAgICAgICAgLy8gKDEpIEZvciBkZXBlbmRlbnQgb2JzZXJ2YWJsZXMsIHdlIHRocm90dGxlICpldmFsdWF0aW9ucyogc28gdGhhdCwgbm8gbWF0dGVyIGhvdyBmYXN0IGl0cyBkZXBlbmRlbmNpZXMKCSAgICAgICAgLy8gICAgIG5vdGlmeSB1cGRhdGVzLCB0aGUgdGFyZ2V0IGRvZXNuJ3QgcmUtZXZhbHVhdGUgKGFuZCBoZW5jZSBkb2Vzbid0IG5vdGlmeSkgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKCSAgICAgICAgdGFyZ2V0Wyd0aHJvdHRsZUV2YWx1YXRpb24nXSA9IHRpbWVvdXQ7CgoJICAgICAgICAvLyAoMikgRm9yIHdyaXRhYmxlIHRhcmdldHMgKG9ic2VydmFibGVzLCBvciB3cml0YWJsZSBkZXBlbmRlbnQgb2JzZXJ2YWJsZXMpLCB3ZSB0aHJvdHRsZSAqd3JpdGVzKgoJICAgICAgICAvLyAgICAgc28gdGhlIHRhcmdldCBjYW5ub3QgY2hhbmdlIHZhbHVlIHN5bmNocm9ub3VzbHkgb3IgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKCSAgICAgICAgdmFyIHdyaXRlVGltZW91dEluc3RhbmNlID0gbnVsbDsKCSAgICAgICAgcmV0dXJuIGtvLmRlcGVuZGVudE9ic2VydmFibGUoewoJICAgICAgICAgICAgJ3JlYWQnOiB0YXJnZXQsCgkgICAgICAgICAgICAnd3JpdGUnOiBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh3cml0ZVRpbWVvdXRJbnN0YW5jZSk7CgkgICAgICAgICAgICAgICAgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgICAgICB0YXJnZXQodmFsdWUpOwoJICAgICAgICAgICAgICAgIH0sIHRpbWVvdXQpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9KTsKCSAgICB9LAoKCSAgICAncmF0ZUxpbWl0JzogZnVuY3Rpb24odGFyZ2V0LCBvcHRpb25zKSB7CgkgICAgICAgIHZhciB0aW1lb3V0LCBtZXRob2QsIGxpbWl0RnVuY3Rpb247CgoJICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT0gJ251bWJlcicpIHsKCSAgICAgICAgICAgIHRpbWVvdXQgPSBvcHRpb25zOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdGltZW91dCA9IG9wdGlvbnNbJ3RpbWVvdXQnXTsKCSAgICAgICAgICAgIG1ldGhvZCA9IG9wdGlvbnNbJ21ldGhvZCddOwoJICAgICAgICB9CgoJICAgICAgICBsaW1pdEZ1bmN0aW9uID0gbWV0aG9kID09ICdub3RpZnlXaGVuQ2hhbmdlc1N0b3AnID8gIGRlYm91bmNlIDogdGhyb3R0bGU7CgkgICAgICAgIHRhcmdldC5saW1pdChmdW5jdGlvbihjYWxsYmFjaykgewoJICAgICAgICAgICAgcmV0dXJuIGxpbWl0RnVuY3Rpb24oY2FsbGJhY2ssIHRpbWVvdXQpOwoJICAgICAgICB9KTsKCSAgICB9LAoKCSAgICAnbm90aWZ5JzogZnVuY3Rpb24odGFyZ2V0LCBub3RpZnlXaGVuKSB7CgkgICAgICAgIHRhcmdldFsiZXF1YWxpdHlDb21wYXJlciJdID0gbm90aWZ5V2hlbiA9PSAiYWx3YXlzIiA/CgkgICAgICAgICAgICBudWxsIDogIC8vIG51bGwgZXF1YWxpdHlDb21wYXJlciBtZWFucyB0byBhbHdheXMgbm90aWZ5CgkgICAgICAgICAgICB2YWx1ZXNBcmVQcmltaXRpdmVBbmRFcXVhbDsKCSAgICB9Cgl9OwoKCXZhciBwcmltaXRpdmVUeXBlcyA9IHsgJ3VuZGVmaW5lZCc6MSwgJ2Jvb2xlYW4nOjEsICdudW1iZXInOjEsICdzdHJpbmcnOjEgfTsKCWZ1bmN0aW9uIHZhbHVlc0FyZVByaW1pdGl2ZUFuZEVxdWFsKGEsIGIpIHsKCSAgICB2YXIgb2xkVmFsdWVJc1ByaW1pdGl2ZSA9IChhID09PSBudWxsKSB8fCAodHlwZW9mKGEpIGluIHByaW1pdGl2ZVR5cGVzKTsKCSAgICByZXR1cm4gb2xkVmFsdWVJc1ByaW1pdGl2ZSA/IChhID09PSBiKSA6IGZhbHNlOwoJfQoKCWZ1bmN0aW9uIHRocm90dGxlKGNhbGxiYWNrLCB0aW1lb3V0KSB7CgkgICAgdmFyIHRpbWVvdXRJbnN0YW5jZTsKCSAgICByZXR1cm4gZnVuY3Rpb24gKCkgewoJICAgICAgICBpZiAoIXRpbWVvdXRJbnN0YW5jZSkgewoJICAgICAgICAgICAgdGltZW91dEluc3RhbmNlID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICB0aW1lb3V0SW5zdGFuY2UgPSB1bmRlZmluZWQ7CgkgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCSAgICAgICAgICAgIH0sIHRpbWVvdXQpOwoJICAgICAgICB9CgkgICAgfTsKCX0KCglmdW5jdGlvbiBkZWJvdW5jZShjYWxsYmFjaywgdGltZW91dCkgewoJICAgIHZhciB0aW1lb3V0SW5zdGFuY2U7CgkgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKCSAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJbnN0YW5jZSk7CgkgICAgICAgIHRpbWVvdXRJbnN0YW5jZSA9IHNldFRpbWVvdXQoY2FsbGJhY2ssIHRpbWVvdXQpOwoJICAgIH07Cgl9CgoJZnVuY3Rpb24gYXBwbHlFeHRlbmRlcnMocmVxdWVzdGVkRXh0ZW5kZXJzKSB7CgkgICAgdmFyIHRhcmdldCA9IHRoaXM7CgkgICAgaWYgKHJlcXVlc3RlZEV4dGVuZGVycykgewoJICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKHJlcXVlc3RlZEV4dGVuZGVycywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewoJICAgICAgICAgICAgdmFyIGV4dGVuZGVySGFuZGxlciA9IGtvLmV4dGVuZGVyc1trZXldOwoJICAgICAgICAgICAgaWYgKHR5cGVvZiBleHRlbmRlckhhbmRsZXIgPT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgICAgIHRhcmdldCA9IGV4dGVuZGVySGFuZGxlcih0YXJnZXQsIHZhbHVlKSB8fCB0YXJnZXQ7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgIH0KCSAgICByZXR1cm4gdGFyZ2V0OwoJfQoKCWtvLmV4cG9ydFN5bWJvbCgnZXh0ZW5kZXJzJywga28uZXh0ZW5kZXJzKTsKCglrby5zdWJzY3JpcHRpb24gPSBmdW5jdGlvbiAodGFyZ2V0LCBjYWxsYmFjaywgZGlzcG9zZUNhbGxiYWNrKSB7CgkgICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CgkgICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrOwoJICAgIHRoaXMuZGlzcG9zZUNhbGxiYWNrID0gZGlzcG9zZUNhbGxiYWNrOwoJICAgIHRoaXMuaXNEaXNwb3NlZCA9IGZhbHNlOwoJICAgIGtvLmV4cG9ydFByb3BlcnR5KHRoaXMsICdkaXNwb3NlJywgdGhpcy5kaXNwb3NlKTsKCX07Cglrby5zdWJzY3JpcHRpb24ucHJvdG90eXBlLmRpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7CgkgICAgdGhpcy5pc0Rpc3Bvc2VkID0gdHJ1ZTsKCSAgICB0aGlzLmRpc3Bvc2VDYWxsYmFjaygpOwoJfTsKCglrby5zdWJzY3JpYmFibGUgPSBmdW5jdGlvbiAoKSB7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2ZPckV4dGVuZCh0aGlzLCBrby5zdWJzY3JpYmFibGVbJ2ZuJ10pOwoJICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSB7fTsKCX0KCgl2YXIgZGVmYXVsdEV2ZW50ID0gImNoYW5nZSI7CgoJdmFyIGtvX3N1YnNjcmliYWJsZV9mbiA9IHsKCSAgICBzdWJzY3JpYmU6IGZ1bmN0aW9uIChjYWxsYmFjaywgY2FsbGJhY2tUYXJnZXQsIGV2ZW50KSB7CgkgICAgICAgIHZhciBzZWxmID0gdGhpczsKCgkgICAgICAgIGV2ZW50ID0gZXZlbnQgfHwgZGVmYXVsdEV2ZW50OwoJICAgICAgICB2YXIgYm91bmRDYWxsYmFjayA9IGNhbGxiYWNrVGFyZ2V0ID8gY2FsbGJhY2suYmluZChjYWxsYmFja1RhcmdldCkgOiBjYWxsYmFjazsKCgkgICAgICAgIHZhciBzdWJzY3JpcHRpb24gPSBuZXcga28uc3Vic2NyaXB0aW9uKHNlbGYsIGJvdW5kQ2FsbGJhY2ssIGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbShzZWxmLl9zdWJzY3JpcHRpb25zW2V2ZW50XSwgc3Vic2NyaXB0aW9uKTsKCSAgICAgICAgICAgIGlmIChzZWxmLmFmdGVyU3Vic2NyaXB0aW9uUmVtb3ZlKQoJICAgICAgICAgICAgICAgIHNlbGYuYWZ0ZXJTdWJzY3JpcHRpb25SZW1vdmUoZXZlbnQpOwoJICAgICAgICB9KTsKCgkgICAgICAgIGlmIChzZWxmLmJlZm9yZVN1YnNjcmlwdGlvbkFkZCkKCSAgICAgICAgICAgIHNlbGYuYmVmb3JlU3Vic2NyaXB0aW9uQWRkKGV2ZW50KTsKCgkgICAgICAgIGlmICghc2VsZi5fc3Vic2NyaXB0aW9uc1tldmVudF0pCgkgICAgICAgICAgICBzZWxmLl9zdWJzY3JpcHRpb25zW2V2ZW50XSA9IFtdOwoJICAgICAgICBzZWxmLl9zdWJzY3JpcHRpb25zW2V2ZW50XS5wdXNoKHN1YnNjcmlwdGlvbik7CgoJICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9uOwoJICAgIH0sCgoJICAgICJub3RpZnlTdWJzY3JpYmVycyI6IGZ1bmN0aW9uICh2YWx1ZVRvTm90aWZ5LCBldmVudCkgewoJICAgICAgICBldmVudCA9IGV2ZW50IHx8IGRlZmF1bHRFdmVudDsKCSAgICAgICAgaWYgKHRoaXMuaGFzU3Vic2NyaXB0aW9uc0ZvckV2ZW50KGV2ZW50KSkgewoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmJlZ2luKCk7IC8vIEJlZ2luIHN1cHByZXNzaW5nIGRlcGVuZGVuY3kgZGV0ZWN0aW9uIChieSBzZXR0aW5nIHRoZSB0b3AgZnJhbWUgdG8gdW5kZWZpbmVkKQoJICAgICAgICAgICAgICAgIGZvciAodmFyIGEgPSB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XS5zbGljZSgwKSwgaSA9IDAsIHN1YnNjcmlwdGlvbjsgc3Vic2NyaXB0aW9uID0gYVtpXTsgKytpKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEluIGNhc2UgYSBzdWJzY3JpcHRpb24gd2FzIGRpc3Bvc2VkIGR1cmluZyB0aGUgYXJyYXlGb3JFYWNoIGN5Y2xlLCBjaGVjawoJICAgICAgICAgICAgICAgICAgICAvLyBmb3IgaXNEaXNwb3NlZCBvbiBlYWNoIHN1YnNjcmlwdGlvbiBiZWZvcmUgaW52b2tpbmcgaXRzIGNhbGxiYWNrCgkgICAgICAgICAgICAgICAgICAgIGlmICghc3Vic2NyaXB0aW9uLmlzRGlzcG9zZWQpCgkgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb24uY2FsbGJhY2sodmFsdWVUb05vdGlmeSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSBmaW5hbGx5IHsKCSAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmVuZCgpOyAvLyBFbmQgc3VwcHJlc3NpbmcgZGVwZW5kZW5jeSBkZXRlY3Rpb24KCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH0sCgoJICAgIGxpbWl0OiBmdW5jdGlvbihsaW1pdEZ1bmN0aW9uKSB7CgkgICAgICAgIHZhciBzZWxmID0gdGhpcywgc2VsZklzT2JzZXJ2YWJsZSA9IGtvLmlzT2JzZXJ2YWJsZShzZWxmKSwKCSAgICAgICAgICAgIGlzUGVuZGluZywgcHJldmlvdXNWYWx1ZSwgcGVuZGluZ1ZhbHVlLCBiZWZvcmVDaGFuZ2UgPSAnYmVmb3JlQ2hhbmdlJzsKCgkgICAgICAgIGlmICghc2VsZi5fb3JpZ05vdGlmeVN1YnNjcmliZXJzKSB7CgkgICAgICAgICAgICBzZWxmLl9vcmlnTm90aWZ5U3Vic2NyaWJlcnMgPSBzZWxmWyJub3RpZnlTdWJzY3JpYmVycyJdOwoJICAgICAgICAgICAgc2VsZlsibm90aWZ5U3Vic2NyaWJlcnMiXSA9IGZ1bmN0aW9uKHZhbHVlLCBldmVudCkgewoJICAgICAgICAgICAgICAgIGlmICghZXZlbnQgfHwgZXZlbnQgPT09IGRlZmF1bHRFdmVudCkgewoJICAgICAgICAgICAgICAgICAgICBzZWxmLl9yYXRlTGltaXRlZENoYW5nZSh2YWx1ZSk7CgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudCA9PT0gYmVmb3JlQ2hhbmdlKSB7CgkgICAgICAgICAgICAgICAgICAgIHNlbGYuX3JhdGVMaW1pdGVkQmVmb3JlQ2hhbmdlKHZhbHVlKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICBzZWxmLl9vcmlnTm90aWZ5U3Vic2NyaWJlcnModmFsdWUsIGV2ZW50KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9OwoJICAgICAgICB9CgoJICAgICAgICB2YXIgZmluaXNoID0gbGltaXRGdW5jdGlvbihmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIC8vIElmIGFuIG9ic2VydmFibGUgcHJvdmlkZWQgYSByZWZlcmVuY2UgdG8gaXRzZWxmLCBhY2Nlc3MgaXQgdG8gZ2V0IHRoZSBsYXRlc3QgdmFsdWUuCgkgICAgICAgICAgICAvLyBUaGlzIGFsbG93cyBjb21wdXRlZCBvYnNlcnZhYmxlcyB0byBkZWxheSBjYWxjdWxhdGluZyB0aGVpciB2YWx1ZSB1bnRpbCBuZWVkZWQuCgkgICAgICAgICAgICBpZiAoc2VsZklzT2JzZXJ2YWJsZSAmJiBwZW5kaW5nVmFsdWUgPT09IHNlbGYpIHsKCSAgICAgICAgICAgICAgICBwZW5kaW5nVmFsdWUgPSBzZWxmKCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpc1BlbmRpbmcgPSBmYWxzZTsKCSAgICAgICAgICAgIGlmIChzZWxmLmlzRGlmZmVyZW50KHByZXZpb3VzVmFsdWUsIHBlbmRpbmdWYWx1ZSkpIHsKCSAgICAgICAgICAgICAgICBzZWxmLl9vcmlnTm90aWZ5U3Vic2NyaWJlcnMocHJldmlvdXNWYWx1ZSA9IHBlbmRpbmdWYWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoKCSAgICAgICAgc2VsZi5fcmF0ZUxpbWl0ZWRDaGFuZ2UgPSBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgICAgICAgaXNQZW5kaW5nID0gdHJ1ZTsKCSAgICAgICAgICAgIHBlbmRpbmdWYWx1ZSA9IHZhbHVlOwoJICAgICAgICAgICAgZmluaXNoKCk7CgkgICAgICAgIH07CgkgICAgICAgIHNlbGYuX3JhdGVMaW1pdGVkQmVmb3JlQ2hhbmdlID0gZnVuY3Rpb24odmFsdWUpIHsKCSAgICAgICAgICAgIGlmICghaXNQZW5kaW5nKSB7CgkgICAgICAgICAgICAgICAgcHJldmlvdXNWYWx1ZSA9IHZhbHVlOwoJICAgICAgICAgICAgICAgIHNlbGYuX29yaWdOb3RpZnlTdWJzY3JpYmVycyh2YWx1ZSwgYmVmb3JlQ2hhbmdlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfTsKCSAgICB9LAoKCSAgICBoYXNTdWJzY3JpcHRpb25zRm9yRXZlbnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CgkgICAgICAgIHJldHVybiB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XSAmJiB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XS5sZW5ndGg7CgkgICAgfSwKCgkgICAgZ2V0U3Vic2NyaXB0aW9uc0NvdW50OiBmdW5jdGlvbiAoKSB7CgkgICAgICAgIHZhciB0b3RhbCA9IDA7CgkgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2godGhpcy5fc3Vic2NyaXB0aW9ucywgZnVuY3Rpb24oZXZlbnROYW1lLCBzdWJzY3JpcHRpb25zKSB7CgkgICAgICAgICAgICB0b3RhbCArPSBzdWJzY3JpcHRpb25zLmxlbmd0aDsKCSAgICAgICAgfSk7CgkgICAgICAgIHJldHVybiB0b3RhbDsKCSAgICB9LAoKCSAgICBpc0RpZmZlcmVudDogZnVuY3Rpb24ob2xkVmFsdWUsIG5ld1ZhbHVlKSB7CgkgICAgICAgIHJldHVybiAhdGhpc1snZXF1YWxpdHlDb21wYXJlciddIHx8ICF0aGlzWydlcXVhbGl0eUNvbXBhcmVyJ10ob2xkVmFsdWUsIG5ld1ZhbHVlKTsKCSAgICB9LAoKCSAgICBleHRlbmQ6IGFwcGx5RXh0ZW5kZXJzCgl9OwoKCWtvLmV4cG9ydFByb3BlcnR5KGtvX3N1YnNjcmliYWJsZV9mbiwgJ3N1YnNjcmliZScsIGtvX3N1YnNjcmliYWJsZV9mbi5zdWJzY3JpYmUpOwoJa28uZXhwb3J0UHJvcGVydHkoa29fc3Vic2NyaWJhYmxlX2ZuLCAnZXh0ZW5kJywga29fc3Vic2NyaWJhYmxlX2ZuLmV4dGVuZCk7Cglrby5leHBvcnRQcm9wZXJ0eShrb19zdWJzY3JpYmFibGVfZm4sICdnZXRTdWJzY3JpcHRpb25zQ291bnQnLCBrb19zdWJzY3JpYmFibGVfZm4uZ2V0U3Vic2NyaXB0aW9uc0NvdW50KTsKCgkvLyBGb3IgYnJvd3NlcnMgdGhhdCBzdXBwb3J0IHByb3RvIGFzc2lnbm1lbnQsIHdlIG92ZXJ3cml0ZSB0aGUgcHJvdG90eXBlIG9mIGVhY2gKCS8vIG9ic2VydmFibGUgaW5zdGFuY2UuIFNpbmNlIG9ic2VydmFibGVzIGFyZSBmdW5jdGlvbnMsIHdlIG5lZWQgRnVuY3Rpb24ucHJvdG90eXBlCgkvLyB0byBzdGlsbCBiZSBpbiB0aGUgcHJvdG90eXBlIGNoYWluLgoJaWYgKGtvLnV0aWxzLmNhblNldFByb3RvdHlwZSkgewoJICAgIGtvLnV0aWxzLnNldFByb3RvdHlwZU9mKGtvX3N1YnNjcmliYWJsZV9mbiwgRnVuY3Rpb24ucHJvdG90eXBlKTsKCX0KCglrby5zdWJzY3JpYmFibGVbJ2ZuJ10gPSBrb19zdWJzY3JpYmFibGVfZm47CgoKCWtvLmlzU3Vic2NyaWJhYmxlID0gZnVuY3Rpb24gKGluc3RhbmNlKSB7CgkgICAgcmV0dXJuIGluc3RhbmNlICE9IG51bGwgJiYgdHlwZW9mIGluc3RhbmNlLnN1YnNjcmliZSA9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBpbnN0YW5jZVsibm90aWZ5U3Vic2NyaWJlcnMiXSA9PSAiZnVuY3Rpb24iOwoJfTsKCglrby5leHBvcnRTeW1ib2woJ3N1YnNjcmliYWJsZScsIGtvLnN1YnNjcmliYWJsZSk7Cglrby5leHBvcnRTeW1ib2woJ2lzU3Vic2NyaWJhYmxlJywga28uaXNTdWJzY3JpYmFibGUpOwoKCWtvLmNvbXB1dGVkQ29udGV4dCA9IGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24gPSAoZnVuY3Rpb24gKCkgewoJICAgIHZhciBvdXRlckZyYW1lcyA9IFtdLAoJICAgICAgICBjdXJyZW50RnJhbWUsCgkgICAgICAgIGxhc3RJZCA9IDA7CgoJICAgIC8vIFJldHVybiBhIHVuaXF1ZSBJRCB0aGF0IGNhbiBiZSBhc3NpZ25lZCB0byBhbiBvYnNlcnZhYmxlIGZvciBkZXBlbmRlbmN5IHRyYWNraW5nLgoJICAgIC8vIFRoZW9yZXRpY2FsbHksIHlvdSBjb3VsZCBldmVudHVhbGx5IG92ZXJmbG93IHRoZSBudW1iZXIgc3RvcmFnZSBzaXplLCByZXN1bHRpbmcKCSAgICAvLyBpbiBkdXBsaWNhdGUgSURzLiBCdXQgaW4gSmF2YVNjcmlwdCwgdGhlIGxhcmdlc3QgZXhhY3QgaW50ZWdyYWwgdmFsdWUgaXMgMl41MwoJICAgIC8vIG9yIDksMDA3LDE5OSwyNTQsNzQwLDk5Mi4gSWYgeW91IGNyZWF0ZWQgMSwwMDAsMDAwIElEcyBwZXIgc2Vjb25kLCBpdCB3b3VsZAoJICAgIC8vIHRha2Ugb3ZlciAyODUgeWVhcnMgdG8gcmVhY2ggdGhhdCBudW1iZXIuCgkgICAgLy8gUmVmZXJlbmNlIGh0dHA6Ly9ibG9nLnZqZXV4LmNvbS8yMDEwL2phdmFzY3JpcHQvamF2YXNjcmlwdC1tYXhfaW50LW51bWJlci1saW1pdHMuaHRtbAoJICAgIGZ1bmN0aW9uIGdldElkKCkgewoJICAgICAgICByZXR1cm4gKytsYXN0SWQ7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBiZWdpbihvcHRpb25zKSB7CgkgICAgICAgIG91dGVyRnJhbWVzLnB1c2goY3VycmVudEZyYW1lKTsKCSAgICAgICAgY3VycmVudEZyYW1lID0gb3B0aW9uczsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGVuZCgpIHsKCSAgICAgICAgY3VycmVudEZyYW1lID0gb3V0ZXJGcmFtZXMucG9wKCk7CgkgICAgfQoKCSAgICByZXR1cm4gewoJICAgICAgICBiZWdpbjogYmVnaW4sCgoJICAgICAgICBlbmQ6IGVuZCwKCgkgICAgICAgIHJlZ2lzdGVyRGVwZW5kZW5jeTogZnVuY3Rpb24gKHN1YnNjcmliYWJsZSkgewoJICAgICAgICAgICAgaWYgKGN1cnJlbnRGcmFtZSkgewoJICAgICAgICAgICAgICAgIGlmICgha28uaXNTdWJzY3JpYmFibGUoc3Vic2NyaWJhYmxlKSkKCSAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPbmx5IHN1YnNjcmliYWJsZSB0aGluZ3MgY2FuIGFjdCBhcyBkZXBlbmRlbmNpZXMiKTsKCSAgICAgICAgICAgICAgICBjdXJyZW50RnJhbWUuY2FsbGJhY2soc3Vic2NyaWJhYmxlLCBzdWJzY3JpYmFibGUuX2lkIHx8IChzdWJzY3JpYmFibGUuX2lkID0gZ2V0SWQoKSkpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgaWdub3JlOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNhbGxiYWNrVGFyZ2V0LCBjYWxsYmFja0FyZ3MpIHsKCSAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgYmVnaW4oKTsKCSAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkoY2FsbGJhY2tUYXJnZXQsIGNhbGxiYWNrQXJncyB8fCBbXSk7CgkgICAgICAgICAgICB9IGZpbmFsbHkgewoJICAgICAgICAgICAgICAgIGVuZCgpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgZ2V0RGVwZW5kZW5jaWVzQ291bnQ6IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgIGlmIChjdXJyZW50RnJhbWUpCgkgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRGcmFtZS5jb21wdXRlZC5nZXREZXBlbmRlbmNpZXNDb3VudCgpOwoJICAgICAgICB9LAoKCSAgICAgICAgaXNJbml0aWFsOiBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIGlmIChjdXJyZW50RnJhbWUpCgkgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRGcmFtZS5pc0luaXRpYWw7CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ2NvbXB1dGVkQ29udGV4dCcsIGtvLmNvbXB1dGVkQ29udGV4dCk7Cglrby5leHBvcnRTeW1ib2woJ2NvbXB1dGVkQ29udGV4dC5nZXREZXBlbmRlbmNpZXNDb3VudCcsIGtvLmNvbXB1dGVkQ29udGV4dC5nZXREZXBlbmRlbmNpZXNDb3VudCk7Cglrby5leHBvcnRTeW1ib2woJ2NvbXB1dGVkQ29udGV4dC5pc0luaXRpYWwnLCBrby5jb21wdXRlZENvbnRleHQuaXNJbml0aWFsKTsKCWtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWRDb250ZXh0LmlzU2xlZXBpbmcnLCBrby5jb21wdXRlZENvbnRleHQuaXNTbGVlcGluZyk7Cglrby5vYnNlcnZhYmxlID0gZnVuY3Rpb24gKGluaXRpYWxWYWx1ZSkgewoJICAgIHZhciBfbGF0ZXN0VmFsdWUgPSBpbml0aWFsVmFsdWU7CgoJICAgIGZ1bmN0aW9uIG9ic2VydmFibGUoKSB7CgkgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMCkgewoJICAgICAgICAgICAgLy8gV3JpdGUKCgkgICAgICAgICAgICAvLyBJZ25vcmUgd3JpdGVzIGlmIHRoZSB2YWx1ZSBoYXNuJ3QgY2hhbmdlZAoJICAgICAgICAgICAgaWYgKG9ic2VydmFibGUuaXNEaWZmZXJlbnQoX2xhdGVzdFZhbHVlLCBhcmd1bWVudHNbMF0pKSB7CgkgICAgICAgICAgICAgICAgb2JzZXJ2YWJsZS52YWx1ZVdpbGxNdXRhdGUoKTsKCSAgICAgICAgICAgICAgICBfbGF0ZXN0VmFsdWUgPSBhcmd1bWVudHNbMF07CgkgICAgICAgICAgICAgICAgaWYgKERFQlVHKSBvYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKCSAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLnZhbHVlSGFzTXV0YXRlZCgpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHRoaXM7IC8vIFBlcm1pdHMgY2hhaW5lZCBhc3NpZ25tZW50cwoJICAgICAgICB9CgkgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgLy8gUmVhZAoJICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5yZWdpc3RlckRlcGVuZGVuY3kob2JzZXJ2YWJsZSk7IC8vIFRoZSBjYWxsZXIgb25seSBuZWVkcyB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIGlmIHRoZXkgZGlkIGEgInJlYWQiIG9wZXJhdGlvbgoJICAgICAgICAgICAgcmV0dXJuIF9sYXRlc3RWYWx1ZTsKCSAgICAgICAgfQoJICAgIH0KCSAgICBrby5zdWJzY3JpYmFibGUuY2FsbChvYnNlcnZhYmxlKTsKCSAgICBrby51dGlscy5zZXRQcm90b3R5cGVPZk9yRXh0ZW5kKG9ic2VydmFibGUsIGtvLm9ic2VydmFibGVbJ2ZuJ10pOwoKCSAgICBpZiAoREVCVUcpIG9ic2VydmFibGUuX2xhdGVzdFZhbHVlID0gX2xhdGVzdFZhbHVlOwoJICAgIG9ic2VydmFibGUucGVlayA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gX2xhdGVzdFZhbHVlIH07CgkgICAgb2JzZXJ2YWJsZS52YWx1ZUhhc011dGF0ZWQgPSBmdW5jdGlvbiAoKSB7IG9ic2VydmFibGVbIm5vdGlmeVN1YnNjcmliZXJzIl0oX2xhdGVzdFZhbHVlKTsgfQoJICAgIG9ic2VydmFibGUudmFsdWVXaWxsTXV0YXRlID0gZnVuY3Rpb24gKCkgeyBvYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOyB9CgoJICAgIGtvLmV4cG9ydFByb3BlcnR5KG9ic2VydmFibGUsICdwZWVrJywgb2JzZXJ2YWJsZS5wZWVrKTsKCSAgICBrby5leHBvcnRQcm9wZXJ0eShvYnNlcnZhYmxlLCAidmFsdWVIYXNNdXRhdGVkIiwgb2JzZXJ2YWJsZS52YWx1ZUhhc011dGF0ZWQpOwoJICAgIGtvLmV4cG9ydFByb3BlcnR5KG9ic2VydmFibGUsICJ2YWx1ZVdpbGxNdXRhdGUiLCBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSk7CgoJICAgIHJldHVybiBvYnNlcnZhYmxlOwoJfQoKCWtvLm9ic2VydmFibGVbJ2ZuJ10gPSB7CgkgICAgImVxdWFsaXR5Q29tcGFyZXIiOiB2YWx1ZXNBcmVQcmltaXRpdmVBbmRFcXVhbAoJfTsKCgl2YXIgcHJvdG9Qcm9wZXJ0eSA9IGtvLm9ic2VydmFibGUucHJvdG9Qcm9wZXJ0eSA9ICJfX2tvX3Byb3RvX18iOwoJa28ub2JzZXJ2YWJsZVsnZm4nXVtwcm90b1Byb3BlcnR5XSA9IGtvLm9ic2VydmFibGU7CgoJLy8gTm90ZSB0aGF0IGZvciBicm93c2VycyB0aGF0IGRvbid0IHN1cHBvcnQgcHJvdG8gYXNzaWdubWVudCwgdGhlCgkvLyBpbmhlcml0YW5jZSBjaGFpbiBpcyBjcmVhdGVkIG1hbnVhbGx5IGluIHRoZSBrby5vYnNlcnZhYmxlIGNvbnN0cnVjdG9yCglpZiAoa28udXRpbHMuY2FuU2V0UHJvdG90eXBlKSB7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2Yoa28ub2JzZXJ2YWJsZVsnZm4nXSwga28uc3Vic2NyaWJhYmxlWydmbiddKTsKCX0KCglrby5oYXNQcm90b3R5cGUgPSBmdW5jdGlvbihpbnN0YW5jZSwgcHJvdG90eXBlKSB7CgkgICAgaWYgKChpbnN0YW5jZSA9PT0gbnVsbCkgfHwgKGluc3RhbmNlID09PSB1bmRlZmluZWQpIHx8IChpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0gdW5kZWZpbmVkKSkgcmV0dXJuIGZhbHNlOwoJICAgIGlmIChpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0gcHJvdG90eXBlKSByZXR1cm4gdHJ1ZTsKCSAgICByZXR1cm4ga28uaGFzUHJvdG90eXBlKGluc3RhbmNlW3Byb3RvUHJvcGVydHldLCBwcm90b3R5cGUpOyAvLyBXYWxrIHRoZSBwcm90b3R5cGUgY2hhaW4KCX07CgoJa28uaXNPYnNlcnZhYmxlID0gZnVuY3Rpb24gKGluc3RhbmNlKSB7CgkgICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28ub2JzZXJ2YWJsZSk7Cgl9Cglrby5pc1dyaXRlYWJsZU9ic2VydmFibGUgPSBmdW5jdGlvbiAoaW5zdGFuY2UpIHsKCSAgICAvLyBPYnNlcnZhYmxlCgkgICAgaWYgKCh0eXBlb2YgaW5zdGFuY2UgPT0gImZ1bmN0aW9uIikgJiYgaW5zdGFuY2VbcHJvdG9Qcm9wZXJ0eV0gPT09IGtvLm9ic2VydmFibGUpCgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgIC8vIFdyaXRlYWJsZSBkZXBlbmRlbnQgb2JzZXJ2YWJsZQoJICAgIGlmICgodHlwZW9mIGluc3RhbmNlID09ICJmdW5jdGlvbiIpICYmIChpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0ga28uZGVwZW5kZW50T2JzZXJ2YWJsZSkgJiYgKGluc3RhbmNlLmhhc1dyaXRlRnVuY3Rpb24pKQoJICAgICAgICByZXR1cm4gdHJ1ZTsKCSAgICAvLyBBbnl0aGluZyBlbHNlCgkgICAgcmV0dXJuIGZhbHNlOwoJfQoKCglrby5leHBvcnRTeW1ib2woJ29ic2VydmFibGUnLCBrby5vYnNlcnZhYmxlKTsKCWtvLmV4cG9ydFN5bWJvbCgnaXNPYnNlcnZhYmxlJywga28uaXNPYnNlcnZhYmxlKTsKCWtvLmV4cG9ydFN5bWJvbCgnaXNXcml0ZWFibGVPYnNlcnZhYmxlJywga28uaXNXcml0ZWFibGVPYnNlcnZhYmxlKTsKCWtvLmV4cG9ydFN5bWJvbCgnaXNXcml0YWJsZU9ic2VydmFibGUnLCBrby5pc1dyaXRlYWJsZU9ic2VydmFibGUpOwoJa28ub2JzZXJ2YWJsZUFycmF5ID0gZnVuY3Rpb24gKGluaXRpYWxWYWx1ZXMpIHsKCSAgICBpbml0aWFsVmFsdWVzID0gaW5pdGlhbFZhbHVlcyB8fCBbXTsKCgkgICAgaWYgKHR5cGVvZiBpbml0aWFsVmFsdWVzICE9ICdvYmplY3QnIHx8ICEoJ2xlbmd0aCcgaW4gaW5pdGlhbFZhbHVlcykpCgkgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGFyZ3VtZW50IHBhc3NlZCB3aGVuIGluaXRpYWxpemluZyBhbiBvYnNlcnZhYmxlIGFycmF5IG11c3QgYmUgYW4gYXJyYXksIG9yIG51bGwsIG9yIHVuZGVmaW5lZC4iKTsKCgkgICAgdmFyIHJlc3VsdCA9IGtvLm9ic2VydmFibGUoaW5pdGlhbFZhbHVlcyk7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2ZPckV4dGVuZChyZXN1bHQsIGtvLm9ic2VydmFibGVBcnJheVsnZm4nXSk7CgkgICAgcmV0dXJuIHJlc3VsdC5leHRlbmQoeyd0cmFja0FycmF5Q2hhbmdlcyc6dHJ1ZX0pOwoJfTsKCglrby5vYnNlcnZhYmxlQXJyYXlbJ2ZuJ10gPSB7CgkgICAgJ3JlbW92ZSc6IGZ1bmN0aW9uICh2YWx1ZU9yUHJlZGljYXRlKSB7CgkgICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzLnBlZWsoKTsKCSAgICAgICAgdmFyIHJlbW92ZWRWYWx1ZXMgPSBbXTsKCSAgICAgICAgdmFyIHByZWRpY2F0ZSA9IHR5cGVvZiB2YWx1ZU9yUHJlZGljYXRlID09ICJmdW5jdGlvbiIgJiYgIWtvLmlzT2JzZXJ2YWJsZSh2YWx1ZU9yUHJlZGljYXRlKSA/IHZhbHVlT3JQcmVkaWNhdGUgOiBmdW5jdGlvbiAodmFsdWUpIHsgcmV0dXJuIHZhbHVlID09PSB2YWx1ZU9yUHJlZGljYXRlOyB9OwoJICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHVuZGVybHlpbmdBcnJheS5sZW5ndGg7IGkrKykgewoJICAgICAgICAgICAgdmFyIHZhbHVlID0gdW5kZXJseWluZ0FycmF5W2ldOwoJICAgICAgICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSkpIHsKCSAgICAgICAgICAgICAgICBpZiAocmVtb3ZlZFZhbHVlcy5sZW5ndGggPT09IDApIHsKCSAgICAgICAgICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgcmVtb3ZlZFZhbHVlcy5wdXNoKHZhbHVlKTsKCSAgICAgICAgICAgICAgICB1bmRlcmx5aW5nQXJyYXkuc3BsaWNlKGksIDEpOwoJICAgICAgICAgICAgICAgIGktLTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICBpZiAocmVtb3ZlZFZhbHVlcy5sZW5ndGgpIHsKCSAgICAgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHJlbW92ZWRWYWx1ZXM7CgkgICAgfSwKCgkgICAgJ3JlbW92ZUFsbCc6IGZ1bmN0aW9uIChhcnJheU9mVmFsdWVzKSB7CgkgICAgICAgIC8vIElmIHlvdSBwYXNzZWQgemVybyBhcmdzLCB3ZSByZW1vdmUgZXZlcnl0aGluZwoJICAgICAgICBpZiAoYXJyYXlPZlZhbHVlcyA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CgkgICAgICAgICAgICB2YXIgYWxsVmFsdWVzID0gdW5kZXJseWluZ0FycmF5LnNsaWNlKDApOwoJICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKCSAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheS5zcGxpY2UoMCwgdW5kZXJseWluZ0FycmF5Lmxlbmd0aCk7CgkgICAgICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwoJICAgICAgICAgICAgcmV0dXJuIGFsbFZhbHVlczsKCSAgICAgICAgfQoJICAgICAgICAvLyBJZiB5b3UgcGFzc2VkIGFuIGFyZywgd2UgaW50ZXJwcmV0IGl0IGFzIGFuIGFycmF5IG9mIGVudHJpZXMgdG8gcmVtb3ZlCgkgICAgICAgIGlmICghYXJyYXlPZlZhbHVlcykKCSAgICAgICAgICAgIHJldHVybiBbXTsKCSAgICAgICAgcmV0dXJuIHRoaXNbJ3JlbW92ZSddKGZ1bmN0aW9uICh2YWx1ZSkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZihhcnJheU9mVmFsdWVzLCB2YWx1ZSkgPj0gMDsKCSAgICAgICAgfSk7CgkgICAgfSwKCgkgICAgJ2Rlc3Ryb3knOiBmdW5jdGlvbiAodmFsdWVPclByZWRpY2F0ZSkgewoJICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CgkgICAgICAgIHZhciBwcmVkaWNhdGUgPSB0eXBlb2YgdmFsdWVPclByZWRpY2F0ZSA9PSAiZnVuY3Rpb24iICYmICFrby5pc09ic2VydmFibGUodmFsdWVPclByZWRpY2F0ZSkgPyB2YWx1ZU9yUHJlZGljYXRlIDogZnVuY3Rpb24gKHZhbHVlKSB7IHJldHVybiB2YWx1ZSA9PT0gdmFsdWVPclByZWRpY2F0ZTsgfTsKCSAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKCSAgICAgICAgZm9yICh2YXIgaSA9IHVuZGVybHlpbmdBcnJheS5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewoJICAgICAgICAgICAgdmFyIHZhbHVlID0gdW5kZXJseWluZ0FycmF5W2ldOwoJICAgICAgICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSkpCgkgICAgICAgICAgICAgICAgdW5kZXJseWluZ0FycmF5W2ldWyJfZGVzdHJveSJdID0gdHJ1ZTsKCSAgICAgICAgfQoJICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwoJICAgIH0sCgoJICAgICdkZXN0cm95QWxsJzogZnVuY3Rpb24gKGFycmF5T2ZWYWx1ZXMpIHsKCSAgICAgICAgLy8gSWYgeW91IHBhc3NlZCB6ZXJvIGFyZ3MsIHdlIGRlc3Ryb3kgZXZlcnl0aGluZwoJICAgICAgICBpZiAoYXJyYXlPZlZhbHVlcyA9PT0gdW5kZWZpbmVkKQoJICAgICAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbigpIHsgcmV0dXJuIHRydWUgfSk7CgoJICAgICAgICAvLyBJZiB5b3UgcGFzc2VkIGFuIGFyZywgd2UgaW50ZXJwcmV0IGl0IGFzIGFuIGFycmF5IG9mIGVudHJpZXMgdG8gZGVzdHJveQoJICAgICAgICBpZiAoIWFycmF5T2ZWYWx1ZXMpCgkgICAgICAgICAgICByZXR1cm4gW107CgkgICAgICAgIHJldHVybiB0aGlzWydkZXN0cm95J10oZnVuY3Rpb24gKHZhbHVlKSB7CgkgICAgICAgICAgICByZXR1cm4ga28udXRpbHMuYXJyYXlJbmRleE9mKGFycmF5T2ZWYWx1ZXMsIHZhbHVlKSA+PSAwOwoJICAgICAgICB9KTsKCSAgICB9LAoKCSAgICAnaW5kZXhPZic6IGZ1bmN0aW9uIChpdGVtKSB7CgkgICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzKCk7CgkgICAgICAgIHJldHVybiBrby51dGlscy5hcnJheUluZGV4T2YodW5kZXJseWluZ0FycmF5LCBpdGVtKTsKCSAgICB9LAoKCSAgICAncmVwbGFjZSc6IGZ1bmN0aW9uKG9sZEl0ZW0sIG5ld0l0ZW0pIHsKCSAgICAgICAgdmFyIGluZGV4ID0gdGhpc1snaW5kZXhPZiddKG9sZEl0ZW0pOwoJICAgICAgICBpZiAoaW5kZXggPj0gMCkgewoJICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKCSAgICAgICAgICAgIHRoaXMucGVlaygpW2luZGV4XSA9IG5ld0l0ZW07CgkgICAgICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwoJICAgICAgICB9CgkgICAgfQoJfTsKCgkvLyBQb3B1bGF0ZSBrby5vYnNlcnZhYmxlQXJyYXkuZm4gd2l0aCByZWFkL3dyaXRlIGZ1bmN0aW9ucyBmcm9tIG5hdGl2ZSBhcnJheXMKCS8vIEltcG9ydGFudDogRG8gbm90IGFkZCBhbnkgYWRkaXRpb25hbCBmdW5jdGlvbnMgaGVyZSB0aGF0IG1heSByZWFzb25hYmx5IGJlIHVzZWQgdG8gKnJlYWQqIGRhdGEgZnJvbSB0aGUgYXJyYXkKCS8vIGJlY2F1c2Ugd2UnbGwgZXZhbCB0aGVtIHdpdGhvdXQgY2F1c2luZyBzdWJzY3JpcHRpb25zLCBzbyBrby5jb21wdXRlZCBvdXRwdXQgY291bGQgZW5kIHVwIGdldHRpbmcgc3RhbGUKCWtvLnV0aWxzLmFycmF5Rm9yRWFjaChbInBvcCIsICJwdXNoIiwgInJldmVyc2UiLCAic2hpZnQiLCAic29ydCIsICJzcGxpY2UiLCAidW5zaGlmdCJdLCBmdW5jdGlvbiAobWV0aG9kTmFtZSkgewoJICAgIGtvLm9ic2VydmFibGVBcnJheVsnZm4nXVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgLy8gVXNlICJwZWVrIiB0byBhdm9pZCBjcmVhdGluZyBhIHN1YnNjcmlwdGlvbiBpbiBhbnkgY29tcHV0ZWQgdGhhdCB3ZSdyZSBleGVjdXRpbmcgaW4gdGhlIGNvbnRleHQgb2YKCSAgICAgICAgLy8gKGZvciBjb25zaXN0ZW5jeSB3aXRoIG11dGF0aW5nIHJlZ3VsYXIgb2JzZXJ2YWJsZXMpCgkgICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzLnBlZWsoKTsKCSAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKCSAgICAgICAgdGhpcy5jYWNoZURpZmZGb3JLbm93bk9wZXJhdGlvbih1bmRlcmx5aW5nQXJyYXksIG1ldGhvZE5hbWUsIGFyZ3VtZW50cyk7CgkgICAgICAgIHZhciBtZXRob2RDYWxsUmVzdWx0ID0gdW5kZXJseWluZ0FycmF5W21ldGhvZE5hbWVdLmFwcGx5KHVuZGVybHlpbmdBcnJheSwgYXJndW1lbnRzKTsKCSAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKCSAgICAgICAgcmV0dXJuIG1ldGhvZENhbGxSZXN1bHQ7CgkgICAgfTsKCX0pOwoKCS8vIFBvcHVsYXRlIGtvLm9ic2VydmFibGVBcnJheS5mbiB3aXRoIHJlYWQtb25seSBmdW5jdGlvbnMgZnJvbSBuYXRpdmUgYXJyYXlzCglrby51dGlscy5hcnJheUZvckVhY2goWyJzbGljZSJdLCBmdW5jdGlvbiAobWV0aG9kTmFtZSkgewoJICAgIGtvLm9ic2VydmFibGVBcnJheVsnZm4nXVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgdmFyIHVuZGVybHlpbmdBcnJheSA9IHRoaXMoKTsKCSAgICAgICAgcmV0dXJuIHVuZGVybHlpbmdBcnJheVttZXRob2ROYW1lXS5hcHBseSh1bmRlcmx5aW5nQXJyYXksIGFyZ3VtZW50cyk7CgkgICAgfTsKCX0pOwoKCS8vIE5vdGUgdGhhdCBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IHByb3RvIGFzc2lnbm1lbnQsIHRoZQoJLy8gaW5oZXJpdGFuY2UgY2hhaW4gaXMgY3JlYXRlZCBtYW51YWxseSBpbiB0aGUga28ub2JzZXJ2YWJsZUFycmF5IGNvbnN0cnVjdG9yCglpZiAoa28udXRpbHMuY2FuU2V0UHJvdG90eXBlKSB7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2Yoa28ub2JzZXJ2YWJsZUFycmF5WydmbiddLCBrby5vYnNlcnZhYmxlWydmbiddKTsKCX0KCglrby5leHBvcnRTeW1ib2woJ29ic2VydmFibGVBcnJheScsIGtvLm9ic2VydmFibGVBcnJheSk7Cgl2YXIgYXJyYXlDaGFuZ2VFdmVudE5hbWUgPSAnYXJyYXlDaGFuZ2UnOwoJa28uZXh0ZW5kZXJzWyd0cmFja0FycmF5Q2hhbmdlcyddID0gZnVuY3Rpb24odGFyZ2V0KSB7CgkgICAgLy8gT25seSBtb2RpZnkgdGhlIHRhcmdldCBvYnNlcnZhYmxlIG9uY2UKCSAgICBpZiAodGFyZ2V0LmNhY2hlRGlmZkZvcktub3duT3BlcmF0aW9uKSB7CgkgICAgICAgIHJldHVybjsKCSAgICB9CgkgICAgdmFyIHRyYWNraW5nQ2hhbmdlcyA9IGZhbHNlLAoJICAgICAgICBjYWNoZWREaWZmID0gbnVsbCwKCSAgICAgICAgcGVuZGluZ05vdGlmaWNhdGlvbnMgPSAwLAoJICAgICAgICB1bmRlcmx5aW5nU3Vic2NyaWJlRnVuY3Rpb24gPSB0YXJnZXQuc3Vic2NyaWJlOwoKCSAgICAvLyBJbnRlcmNlcHQgInN1YnNjcmliZSIgY2FsbHMsIGFuZCBmb3IgYXJyYXkgY2hhbmdlIGV2ZW50cywgZW5zdXJlIGNoYW5nZSB0cmFja2luZyBpcyBlbmFibGVkCgkgICAgdGFyZ2V0LnN1YnNjcmliZSA9IHRhcmdldFsnc3Vic2NyaWJlJ10gPSBmdW5jdGlvbihjYWxsYmFjaywgY2FsbGJhY2tUYXJnZXQsIGV2ZW50KSB7CgkgICAgICAgIGlmIChldmVudCA9PT0gYXJyYXlDaGFuZ2VFdmVudE5hbWUpIHsKCSAgICAgICAgICAgIHRyYWNrQ2hhbmdlcygpOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiB1bmRlcmx5aW5nU3Vic2NyaWJlRnVuY3Rpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICB9OwoKCSAgICBmdW5jdGlvbiB0cmFja0NoYW5nZXMoKSB7CgkgICAgICAgIC8vIENhbGxpbmcgJ3RyYWNrQ2hhbmdlcycgbXVsdGlwbGUgdGltZXMgaXMgdGhlIHNhbWUgYXMgY2FsbGluZyBpdCBvbmNlCgkgICAgICAgIGlmICh0cmFja2luZ0NoYW5nZXMpIHsKCSAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoKCSAgICAgICAgdHJhY2tpbmdDaGFuZ2VzID0gdHJ1ZTsKCgkgICAgICAgIC8vIEludGVyY2VwdCAibm90aWZ5U3Vic2NyaWJlcnMiIHRvIHRyYWNrIGhvdyBtYW55IHRpbWVzIGl0IHdhcyBjYWxsZWQuCgkgICAgICAgIHZhciB1bmRlcmx5aW5nTm90aWZ5U3Vic2NyaWJlcnNGdW5jdGlvbiA9IHRhcmdldFsnbm90aWZ5U3Vic2NyaWJlcnMnXTsKCSAgICAgICAgdGFyZ2V0Wydub3RpZnlTdWJzY3JpYmVycyddID0gZnVuY3Rpb24odmFsdWVUb05vdGlmeSwgZXZlbnQpIHsKCSAgICAgICAgICAgIGlmICghZXZlbnQgfHwgZXZlbnQgPT09IGRlZmF1bHRFdmVudCkgewoJICAgICAgICAgICAgICAgICsrcGVuZGluZ05vdGlmaWNhdGlvbnM7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdW5kZXJseWluZ05vdGlmeVN1YnNjcmliZXJzRnVuY3Rpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgICAgfTsKCgkgICAgICAgIC8vIEVhY2ggdGltZSB0aGUgYXJyYXkgY2hhbmdlcyB2YWx1ZSwgY2FwdHVyZSBhIGNsb25lIHNvIHRoYXQgb24gdGhlIG5leHQKCSAgICAgICAgLy8gY2hhbmdlIGl0J3MgcG9zc2libGUgdG8gcHJvZHVjZSBhIGRpZmYKCSAgICAgICAgdmFyIHByZXZpb3VzQ29udGVudHMgPSBbXS5jb25jYXQodGFyZ2V0LnBlZWsoKSB8fCBbXSk7CgkgICAgICAgIGNhY2hlZERpZmYgPSBudWxsOwoJICAgICAgICB0YXJnZXQuc3Vic2NyaWJlKGZ1bmN0aW9uKGN1cnJlbnRDb250ZW50cykgewoJICAgICAgICAgICAgLy8gTWFrZSBhIGNvcHkgb2YgdGhlIGN1cnJlbnQgY29udGVudHMgYW5kIGVuc3VyZSBpdCdzIGFuIGFycmF5CgkgICAgICAgICAgICBjdXJyZW50Q29udGVudHMgPSBbXS5jb25jYXQoY3VycmVudENvbnRlbnRzIHx8IFtdKTsKCgkgICAgICAgICAgICAvLyBDb21wdXRlIHRoZSBkaWZmIGFuZCBpc3N1ZSBub3RpZmljYXRpb25zLCBidXQgb25seSBpZiBzb21lb25lIGlzIGxpc3RlbmluZwoJICAgICAgICAgICAgaWYgKHRhcmdldC5oYXNTdWJzY3JpcHRpb25zRm9yRXZlbnQoYXJyYXlDaGFuZ2VFdmVudE5hbWUpKSB7CgkgICAgICAgICAgICAgICAgdmFyIGNoYW5nZXMgPSBnZXRDaGFuZ2VzKHByZXZpb3VzQ29udGVudHMsIGN1cnJlbnRDb250ZW50cyk7CgkgICAgICAgICAgICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgICAgIHRhcmdldFsnbm90aWZ5U3Vic2NyaWJlcnMnXShjaGFuZ2VzLCBhcnJheUNoYW5nZUV2ZW50TmFtZSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIC8vIEVsaW1pbmF0ZSByZWZlcmVuY2VzIHRvIHRoZSBvbGQsIHJlbW92ZWQgaXRlbXMsIHNvIHRoZXkgY2FuIGJlIEdDZWQKCSAgICAgICAgICAgIHByZXZpb3VzQ29udGVudHMgPSBjdXJyZW50Q29udGVudHM7CgkgICAgICAgICAgICBjYWNoZWREaWZmID0gbnVsbDsKCSAgICAgICAgICAgIHBlbmRpbmdOb3RpZmljYXRpb25zID0gMDsKCSAgICAgICAgfSk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBnZXRDaGFuZ2VzKHByZXZpb3VzQ29udGVudHMsIGN1cnJlbnRDb250ZW50cykgewoJICAgICAgICAvLyBXZSB0cnkgdG8gcmUtdXNlIGNhY2hlZCBkaWZmcy4KCSAgICAgICAgLy8gVGhlIHNjZW5hcmlvcyB3aGVyZSBwZW5kaW5nTm90aWZpY2F0aW9ucyA+IDEgYXJlIHdoZW4gdXNpbmcgcmF0ZS1saW1pdGluZyBvciB0aGUgRGVmZXJyZWQgVXBkYXRlcwoJICAgICAgICAvLyBwbHVnaW4sIHdoaWNoIHdpdGhvdXQgdGhpcyBjaGVjayB3b3VsZCBub3QgYmUgY29tcGF0aWJsZSB3aXRoIGFycmF5Q2hhbmdlIG5vdGlmaWNhdGlvbnMuIE5vcm1hbGx5LAoJICAgICAgICAvLyBub3RpZmljYXRpb25zIGFyZSBpc3N1ZWQgaW1tZWRpYXRlbHkgc28gd2Ugd291bGRuJ3QgYmUgcXVldWVpbmcgdXAgbW9yZSB0aGFuIG9uZS4KCSAgICAgICAgaWYgKCFjYWNoZWREaWZmIHx8IHBlbmRpbmdOb3RpZmljYXRpb25zID4gMSkgewoJICAgICAgICAgICAgY2FjaGVkRGlmZiA9IGtvLnV0aWxzLmNvbXBhcmVBcnJheXMocHJldmlvdXNDb250ZW50cywgY3VycmVudENvbnRlbnRzLCB7ICdzcGFyc2UnOiB0cnVlIH0pOwoJICAgICAgICB9CgoJICAgICAgICByZXR1cm4gY2FjaGVkRGlmZjsKCSAgICB9CgoJICAgIHRhcmdldC5jYWNoZURpZmZGb3JLbm93bk9wZXJhdGlvbiA9IGZ1bmN0aW9uKHJhd0FycmF5LCBvcGVyYXRpb25OYW1lLCBhcmdzKSB7CgkgICAgICAgIC8vIE9ubHkgcnVuIGlmIHdlJ3JlIGN1cnJlbnRseSB0cmFja2luZyBjaGFuZ2VzIGZvciB0aGlzIG9ic2VydmFibGUgYXJyYXkKCSAgICAgICAgLy8gYW5kIHRoZXJlIGFyZW4ndCBhbnkgcGVuZGluZyBkZWZlcnJlZCBub3RpZmljYXRpb25zLgoJICAgICAgICBpZiAoIXRyYWNraW5nQ2hhbmdlcyB8fCBwZW5kaW5nTm90aWZpY2F0aW9ucykgewoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgkgICAgICAgIHZhciBkaWZmID0gW10sCgkgICAgICAgICAgICBhcnJheUxlbmd0aCA9IHJhd0FycmF5Lmxlbmd0aCwKCSAgICAgICAgICAgIGFyZ3NMZW5ndGggPSBhcmdzLmxlbmd0aCwKCSAgICAgICAgICAgIG9mZnNldCA9IDA7CgoJICAgICAgICBmdW5jdGlvbiBwdXNoRGlmZihzdGF0dXMsIHZhbHVlLCBpbmRleCkgewoJICAgICAgICAgICAgcmV0dXJuIGRpZmZbZGlmZi5sZW5ndGhdID0geyAnc3RhdHVzJzogc3RhdHVzLCAndmFsdWUnOiB2YWx1ZSwgJ2luZGV4JzogaW5kZXggfTsKCSAgICAgICAgfQoJICAgICAgICBzd2l0Y2ggKG9wZXJhdGlvbk5hbWUpIHsKCSAgICAgICAgICAgIGNhc2UgJ3B1c2gnOgoJICAgICAgICAgICAgICAgIG9mZnNldCA9IGFycmF5TGVuZ3RoOwoJICAgICAgICAgICAgY2FzZSAndW5zaGlmdCc6CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IGFyZ3NMZW5ndGg7IGluZGV4KyspIHsKCSAgICAgICAgICAgICAgICAgICAgcHVzaERpZmYoJ2FkZGVkJywgYXJnc1tpbmRleF0sIG9mZnNldCArIGluZGV4KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgYnJlYWs7CgoJICAgICAgICAgICAgY2FzZSAncG9wJzoKCSAgICAgICAgICAgICAgICBvZmZzZXQgPSBhcnJheUxlbmd0aCAtIDE7CgkgICAgICAgICAgICBjYXNlICdzaGlmdCc6CgkgICAgICAgICAgICAgICAgaWYgKGFycmF5TGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgICAgIHB1c2hEaWZmKCdkZWxldGVkJywgcmF3QXJyYXlbb2Zmc2V0XSwgb2Zmc2V0KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgYnJlYWs7CgoJICAgICAgICAgICAgY2FzZSAnc3BsaWNlJzoKCSAgICAgICAgICAgICAgICAvLyBOZWdhdGl2ZSBzdGFydCBpbmRleCBtZWFucyAnZnJvbSBlbmQgb2YgYXJyYXknLiBBZnRlciB0aGF0IHdlIGNsYW1wIHRvIFswLi4uYXJyYXlMZW5ndGhdLgoJICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9BcnJheS9zcGxpY2UKCSAgICAgICAgICAgICAgICB2YXIgc3RhcnRJbmRleCA9IE1hdGgubWluKE1hdGgubWF4KDAsIGFyZ3NbMF0gPCAwID8gYXJyYXlMZW5ndGggKyBhcmdzWzBdIDogYXJnc1swXSksIGFycmF5TGVuZ3RoKSwKCSAgICAgICAgICAgICAgICAgICAgZW5kRGVsZXRlSW5kZXggPSBhcmdzTGVuZ3RoID09PSAxID8gYXJyYXlMZW5ndGggOiBNYXRoLm1pbihzdGFydEluZGV4ICsgKGFyZ3NbMV0gfHwgMCksIGFycmF5TGVuZ3RoKSwKCSAgICAgICAgICAgICAgICAgICAgZW5kQWRkSW5kZXggPSBzdGFydEluZGV4ICsgYXJnc0xlbmd0aCAtIDIsCgkgICAgICAgICAgICAgICAgICAgIGVuZEluZGV4ID0gTWF0aC5tYXgoZW5kRGVsZXRlSW5kZXgsIGVuZEFkZEluZGV4KSwKCSAgICAgICAgICAgICAgICAgICAgYWRkaXRpb25zID0gW10sIGRlbGV0aW9ucyA9IFtdOwoJICAgICAgICAgICAgICAgIGZvciAodmFyIGluZGV4ID0gc3RhcnRJbmRleCwgYXJnc0luZGV4ID0gMjsgaW5kZXggPCBlbmRJbmRleDsgKytpbmRleCwgKythcmdzSW5kZXgpIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4IDwgZW5kRGVsZXRlSW5kZXgpCgkgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChwdXNoRGlmZignZGVsZXRlZCcsIHJhd0FycmF5W2luZGV4XSwgaW5kZXgpKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4IDwgZW5kQWRkSW5kZXgpCgkgICAgICAgICAgICAgICAgICAgICAgICBhZGRpdGlvbnMucHVzaChwdXNoRGlmZignYWRkZWQnLCBhcmdzW2FyZ3NJbmRleF0sIGluZGV4KSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLmZpbmRNb3Zlc0luQXJyYXlDb21wYXJpc29uKGRlbGV0aW9ucywgYWRkaXRpb25zKTsKCSAgICAgICAgICAgICAgICBicmVhazsKCgkgICAgICAgICAgICBkZWZhdWx0OgoJICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgICAgICBjYWNoZWREaWZmID0gZGlmZjsKCSAgICB9OwoJfTsKCWtvLmNvbXB1dGVkID0ga28uZGVwZW5kZW50T2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucywgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQsIG9wdGlvbnMpIHsKCSAgICB2YXIgX2xhdGVzdFZhbHVlLAoJICAgICAgICBfbmVlZHNFdmFsdWF0aW9uID0gdHJ1ZSwKCSAgICAgICAgX2lzQmVpbmdFdmFsdWF0ZWQgPSBmYWxzZSwKCSAgICAgICAgX3N1cHByZXNzRGlzcG9zYWxVbnRpbERpc3Bvc2VXaGVuUmV0dXJuc0ZhbHNlID0gZmFsc2UsCgkgICAgICAgIF9pc0Rpc3Bvc2VkID0gZmFsc2UsCgkgICAgICAgIHJlYWRGdW5jdGlvbiA9IGV2YWx1YXRvckZ1bmN0aW9uT3JPcHRpb25zLAoJICAgICAgICBwdXJlID0gZmFsc2UsCgkgICAgICAgIGlzU2xlZXBpbmcgPSBmYWxzZTsKCgkgICAgaWYgKHJlYWRGdW5jdGlvbiAmJiB0eXBlb2YgcmVhZEZ1bmN0aW9uID09ICJvYmplY3QiKSB7CgkgICAgICAgIC8vIFNpbmdsZS1wYXJhbWV0ZXIgc3ludGF4IC0gZXZlcnl0aGluZyBpcyBvbiB0aGlzICJvcHRpb25zIiBwYXJhbQoJICAgICAgICBvcHRpb25zID0gcmVhZEZ1bmN0aW9uOwoJICAgICAgICByZWFkRnVuY3Rpb24gPSBvcHRpb25zWyJyZWFkIl07CgkgICAgfSBlbHNlIHsKCSAgICAgICAgLy8gTXVsdGktcGFyYW1ldGVyIHN5bnRheCAtIGNvbnN0cnVjdCB0aGUgb3B0aW9ucyBhY2NvcmRpbmcgdG8gdGhlIHBhcmFtcyBwYXNzZWQKCSAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkgICAgICAgIGlmICghcmVhZEZ1bmN0aW9uKQoJICAgICAgICAgICAgcmVhZEZ1bmN0aW9uID0gb3B0aW9uc1sicmVhZCJdOwoJICAgIH0KCSAgICBpZiAodHlwZW9mIHJlYWRGdW5jdGlvbiAhPSAiZnVuY3Rpb24iKQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBhc3MgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBrby5jb21wdXRlZCIpOwoKCSAgICBmdW5jdGlvbiBhZGRTdWJzY3JpcHRpb25Ub0RlcGVuZGVuY3koc3Vic2NyaWJhYmxlLCBpZCkgewoJICAgICAgICBpZiAoIV9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXNbaWRdKSB7CgkgICAgICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzW2lkXSA9IHN1YnNjcmliYWJsZS5zdWJzY3JpYmUoZXZhbHVhdGVQb3NzaWJseUFzeW5jKTsKCSAgICAgICAgICAgICsrX2RlcGVuZGVuY2llc0NvdW50OwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCkgewoJICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMsIGZ1bmN0aW9uIChpZCwgc3Vic2NyaXB0aW9uKSB7CgkgICAgICAgICAgICBzdWJzY3JpcHRpb24uZGlzcG9zZSgpOwoJICAgICAgICB9KTsKCSAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcyA9IHt9OwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZGlzcG9zZUNvbXB1dGVkKCkgewoJICAgICAgICBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCk7CgkgICAgICAgIF9kZXBlbmRlbmNpZXNDb3VudCA9IDA7CgkgICAgICAgIF9pc0Rpc3Bvc2VkID0gdHJ1ZTsKCSAgICAgICAgX25lZWRzRXZhbHVhdGlvbiA9IGZhbHNlOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZXZhbHVhdGVQb3NzaWJseUFzeW5jKCkgewoJICAgICAgICB2YXIgdGhyb3R0bGVFdmFsdWF0aW9uVGltZW91dCA9IGRlcGVuZGVudE9ic2VydmFibGVbJ3Rocm90dGxlRXZhbHVhdGlvbiddOwoJICAgICAgICBpZiAodGhyb3R0bGVFdmFsdWF0aW9uVGltZW91dCAmJiB0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0ID49IDApIHsKCSAgICAgICAgICAgIGNsZWFyVGltZW91dChldmFsdWF0aW9uVGltZW91dEluc3RhbmNlKTsKCSAgICAgICAgICAgIGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGV2YWx1YXRlSW1tZWRpYXRlLCB0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0KTsKCSAgICAgICAgfSBlbHNlIGlmIChkZXBlbmRlbnRPYnNlcnZhYmxlLl9ldmFsUmF0ZUxpbWl0ZWQpIHsKCSAgICAgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGUuX2V2YWxSYXRlTGltaXRlZCgpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gZXZhbHVhdGVJbW1lZGlhdGUoc3VwcHJlc3NDaGFuZ2VOb3RpZmljYXRpb24pIHsKCSAgICAgICAgaWYgKF9pc0JlaW5nRXZhbHVhdGVkKSB7CgkgICAgICAgICAgICBpZiAocHVyZSkgewoJICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJBICdwdXJlJyBjb21wdXRlZCBtdXN0IG5vdCBiZSBjYWxsZWQgcmVjdXJzaXZlbHkiKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIC8vIElmIHRoZSBldmFsdWF0aW9uIG9mIGEga28uY29tcHV0ZWQgY2F1c2VzIHNpZGUgZWZmZWN0cywgaXQncyBwb3NzaWJsZSB0aGF0IGl0IHdpbGwgdHJpZ2dlciBpdHMgb3duIHJlLWV2YWx1YXRpb24uCgkgICAgICAgICAgICAvLyBUaGlzIGlzIG5vdCBkZXNpcmFibGUgKGl0J3MgaGFyZCBmb3IgYSBkZXZlbG9wZXIgdG8gcmVhbGlzZSBhIGNoYWluIG9mIGRlcGVuZGVuY2llcyBtaWdodCBjYXVzZSB0aGlzLCBhbmQgdGhleSBhbG1vc3QKCSAgICAgICAgICAgIC8vIGNlcnRhaW5seSBkaWRuJ3QgaW50ZW5kIGluZmluaXRlIHJlLWV2YWx1YXRpb25zKS4gU28sIGZvciBwcmVkaWN0YWJpbGl0eSwgd2Ugc2ltcGx5IHByZXZlbnQga28uY29tcHV0ZWRzIGZyb20gY2F1c2luZwoJICAgICAgICAgICAgLy8gdGhlaXIgb3duIHJlLWV2YWx1YXRpb24uIEZ1cnRoZXIgZGlzY3Vzc2lvbiBhdCBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvcHVsbC8zODcKCSAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gRG8gbm90IGV2YWx1YXRlIChhbmQgcG9zc2libHkgY2FwdHVyZSBuZXcgZGVwZW5kZW5jaWVzKSBpZiBkaXNwb3NlZAoJICAgICAgICBpZiAoX2lzRGlzcG9zZWQpIHsKCSAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoKCSAgICAgICAgaWYgKGRpc3Bvc2VXaGVuICYmIGRpc3Bvc2VXaGVuKCkpIHsKCSAgICAgICAgICAgIC8vIFNlZSBjb21tZW50IGJlbG93IGFib3V0IF9zdXBwcmVzc0Rpc3Bvc2FsVW50aWxEaXNwb3NlV2hlblJldHVybnNGYWxzZQoJICAgICAgICAgICAgaWYgKCFfc3VwcHJlc3NEaXNwb3NhbFVudGlsRGlzcG9zZVdoZW5SZXR1cm5zRmFsc2UpIHsKCSAgICAgICAgICAgICAgICBkaXNwb3NlKCk7CgkgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgfQoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgLy8gSXQganVzdCBkaWQgcmV0dXJuIGZhbHNlLCBzbyB3ZSBjYW4gc3RvcCBzdXBwcmVzc2luZyBub3cKCSAgICAgICAgICAgIF9zdXBwcmVzc0Rpc3Bvc2FsVW50aWxEaXNwb3NlV2hlblJldHVybnNGYWxzZSA9IGZhbHNlOwoJICAgICAgICB9CgoJICAgICAgICBfaXNCZWluZ0V2YWx1YXRlZCA9IHRydWU7CgoJICAgICAgICAvLyBXaGVuIHNsZWVwaW5nLCByZWNhbGN1bGF0ZSB0aGUgdmFsdWUgYW5kIHJldHVybi4KCSAgICAgICAgaWYgKGlzU2xlZXBpbmcpIHsKCSAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgdmFyIGRlcGVuZGVuY3lUcmFja2luZyA9IHt9OwoJICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uYmVnaW4oewoJICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24gKHN1YnNjcmliYWJsZSwgaWQpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZGVwZW5kZW5jeVRyYWNraW5nW2lkXSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lUcmFja2luZ1tpZF0gPSAxOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICsrX2RlcGVuZGVuY2llc0NvdW50OwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICB9LAoJICAgICAgICAgICAgICAgICAgICBjb21wdXRlZDogZGVwZW5kZW50T2JzZXJ2YWJsZSwKCSAgICAgICAgICAgICAgICAgICAgaXNJbml0aWFsOiB1bmRlZmluZWQKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICBfZGVwZW5kZW5jaWVzQ291bnQgPSAwOwoJICAgICAgICAgICAgICAgIF9sYXRlc3RWYWx1ZSA9IHJlYWRGdW5jdGlvbi5jYWxsKGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0KTsKCSAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5lbmQoKTsKCSAgICAgICAgICAgICAgICBfaXNCZWluZ0V2YWx1YXRlZCA9IGZhbHNlOwoJICAgICAgICAgICAgfQoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICAvLyBJbml0aWFsbHksIHdlIGFzc3VtZSB0aGF0IG5vbmUgb2YgdGhlIHN1YnNjcmlwdGlvbnMgYXJlIHN0aWxsIGJlaW5nIHVzZWQgKGkuZS4sIGFsbCBhcmUgY2FuZGlkYXRlcyBmb3IgZGlzcG9zYWwpLgoJICAgICAgICAgICAgICAgIC8vIFRoZW4sIGR1cmluZyBldmFsdWF0aW9uLCB3ZSBjcm9zcyBvZmYgYW55IHRoYXQgYXJlIGluIGZhY3Qgc3RpbGwgYmVpbmcgdXNlZC4KCSAgICAgICAgICAgICAgICB2YXIgZGlzcG9zYWxDYW5kaWRhdGVzID0gX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcywgZGlzcG9zYWxDb3VudCA9IF9kZXBlbmRlbmNpZXNDb3VudDsKCSAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmJlZ2luKHsKCSAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uKHN1YnNjcmliYWJsZSwgaWQpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmICghX2lzRGlzcG9zZWQpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzcG9zYWxDb3VudCAmJiBkaXNwb3NhbENhbmRpZGF0ZXNbaWRdKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvbid0IHdhbnQgdG8gZGlzcG9zZSB0aGlzIHN1YnNjcmlwdGlvbiwgYXMgaXQncyBzdGlsbCBiZWluZyB1c2VkCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXNbaWRdID0gZGlzcG9zYWxDYW5kaWRhdGVzW2lkXTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKytfZGVwZW5kZW5jaWVzQ291bnQ7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkaXNwb3NhbENhbmRpZGF0ZXNbaWRdOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtLWRpc3Bvc2FsQ291bnQ7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQnJhbmQgbmV3IHN1YnNjcmlwdGlvbiAtIGFkZCBpdAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRTdWJzY3JpcHRpb25Ub0RlcGVuZGVuY3koc3Vic2NyaWJhYmxlLCBpZCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICB9LAoJICAgICAgICAgICAgICAgICAgICBjb21wdXRlZDogZGVwZW5kZW50T2JzZXJ2YWJsZSwKCSAgICAgICAgICAgICAgICAgICAgaXNJbml0aWFsOiBwdXJlID8gdW5kZWZpbmVkIDogIV9kZXBlbmRlbmNpZXNDb3VudCAgICAgICAgLy8gSWYgd2UncmUgZXZhbHVhdGluZyB3aGVuIHRoZXJlIGFyZSBubyBwcmV2aW91cyBkZXBlbmRlbmNpZXMsIGl0IG11c3QgYmUgdGhlIGZpcnN0IHRpbWUKCSAgICAgICAgICAgICAgICB9KTsKCgkgICAgICAgICAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcyA9IHt9OwoJICAgICAgICAgICAgICAgIF9kZXBlbmRlbmNpZXNDb3VudCA9IDA7CgoJICAgICAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0ID8gcmVhZEZ1bmN0aW9uLmNhbGwoZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpIDogcmVhZEZ1bmN0aW9uKCk7CgoJICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uZW5kKCk7CgoJICAgICAgICAgICAgICAgICAgICAvLyBGb3IgZWFjaCBzdWJzY3JpcHRpb24gbm8gbG9uZ2VyIGJlaW5nIHVzZWQsIHJlbW92ZSBpdCBmcm9tIHRoZSBhY3RpdmUgc3Vic2NyaXB0aW9ucyBsaXN0IGFuZCBkaXNwb3NlIGl0CgkgICAgICAgICAgICAgICAgICAgIGlmIChkaXNwb3NhbENvdW50KSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKGRpc3Bvc2FsQ2FuZGlkYXRlcywgZnVuY3Rpb24oaWQsIHRvRGlzcG9zZSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvRGlzcG9zZS5kaXNwb3NlKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAgICAgX25lZWRzRXZhbHVhdGlvbiA9IGZhbHNlOwoJICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgaWYgKGRlcGVuZGVudE9ic2VydmFibGUuaXNEaWZmZXJlbnQoX2xhdGVzdFZhbHVlLCBuZXdWYWx1ZSkpIHsKCSAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZVsibm90aWZ5U3Vic2NyaWJlcnMiXShfbGF0ZXN0VmFsdWUsICJiZWZvcmVDaGFuZ2UiKTsKCgkgICAgICAgICAgICAgICAgICAgIF9sYXRlc3RWYWx1ZSA9IG5ld1ZhbHVlOwoJICAgICAgICAgICAgICAgICAgICBpZiAoREVCVUcpIGRlcGVuZGVudE9ic2VydmFibGUuX2xhdGVzdFZhbHVlID0gX2xhdGVzdFZhbHVlOwoKCSAgICAgICAgICAgICAgICAgICAgaWYgKHN1cHByZXNzQ2hhbmdlTm90aWZpY2F0aW9uICE9PSB0cnVlKSB7ICAvLyBDaGVjayBmb3Igc3RyaWN0IHRydWUgdmFsdWUgc2luY2Ugc2V0VGltZW91dCBpbiBGaXJlZm94IHBhc3NlcyBhIG51bWVyaWMgdmFsdWUgdG8gdGhlIGZ1bmN0aW9uCgkgICAgICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9IGZpbmFsbHkgewoJICAgICAgICAgICAgICAgIF9pc0JlaW5nRXZhbHVhdGVkID0gZmFsc2U7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIGlmICghX2RlcGVuZGVuY2llc0NvdW50KQoJICAgICAgICAgICAgZGlzcG9zZSgpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZGVwZW5kZW50T2JzZXJ2YWJsZSgpIHsKCSAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CgkgICAgICAgICAgICBpZiAodHlwZW9mIHdyaXRlRnVuY3Rpb24gPT09ICJmdW5jdGlvbiIpIHsKCSAgICAgICAgICAgICAgICAvLyBXcml0aW5nIGEgdmFsdWUKCSAgICAgICAgICAgICAgICB3cml0ZUZ1bmN0aW9uLmFwcGx5KGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0LCBhcmd1bWVudHMpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCB3cml0ZSBhIHZhbHVlIHRvIGEga28uY29tcHV0ZWQgdW5sZXNzIHlvdSBzcGVjaWZ5IGEgJ3dyaXRlJyBvcHRpb24uIElmIHlvdSB3aXNoIHRvIHJlYWQgdGhlIGN1cnJlbnQgdmFsdWUsIGRvbid0IHBhc3MgYW55IHBhcmFtZXRlcnMuIik7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdGhpczsgLy8gUGVybWl0cyBjaGFpbmVkIGFzc2lnbm1lbnRzCgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAvLyBSZWFkaW5nIHRoZSB2YWx1ZQoJICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5yZWdpc3RlckRlcGVuZGVuY3koZGVwZW5kZW50T2JzZXJ2YWJsZSk7CgkgICAgICAgICAgICBpZiAoX25lZWRzRXZhbHVhdGlvbikKCSAgICAgICAgICAgICAgICBldmFsdWF0ZUltbWVkaWF0ZSh0cnVlIC8qIHN1cHByZXNzQ2hhbmdlTm90aWZpY2F0aW9uICovKTsKCSAgICAgICAgICAgIHJldHVybiBfbGF0ZXN0VmFsdWU7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIHBlZWsoKSB7CgkgICAgICAgIC8vIFBlZWsgd29uJ3QgcmUtZXZhbHVhdGUsIGV4Y2VwdCB0byBnZXQgdGhlIGluaXRpYWwgdmFsdWUgd2hlbiAiZGVmZXJFdmFsdWF0aW9uIiBpcyBzZXQsIG9yIHdoaWxlIHRoZSBjb21wdXRlZCBpcyBzbGVlcGluZy4KCSAgICAgICAgLy8gVGhvc2UgYXJlIHRoZSBvbmx5IHRpbWVzIHRoYXQgYm90aCBvZiB0aGVzZSBjb25kaXRpb25zIHdpbGwgYmUgc2F0aXNmaWVkLgoJICAgICAgICBpZiAoX25lZWRzRXZhbHVhdGlvbiAmJiAhX2RlcGVuZGVuY2llc0NvdW50KQoJICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUodHJ1ZSAvKiBzdXBwcmVzc0NoYW5nZU5vdGlmaWNhdGlvbiAqLyk7CgkgICAgICAgIHJldHVybiBfbGF0ZXN0VmFsdWU7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBpc0FjdGl2ZSgpIHsKCSAgICAgICAgcmV0dXJuIF9uZWVkc0V2YWx1YXRpb24gfHwgX2RlcGVuZGVuY2llc0NvdW50ID4gMDsKCSAgICB9CgoJICAgIC8vIEJ5IGhlcmUsICJvcHRpb25zIiBpcyBhbHdheXMgbm9uLW51bGwKCSAgICB2YXIgd3JpdGVGdW5jdGlvbiA9IG9wdGlvbnNbIndyaXRlIl0sCgkgICAgICAgIGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCA9IG9wdGlvbnNbImRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCJdIHx8IG9wdGlvbnMuZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIHx8IG51bGwsCgkgICAgICAgIGRpc3Bvc2VXaGVuT3B0aW9uID0gb3B0aW9uc1siZGlzcG9zZVdoZW4iXSB8fCBvcHRpb25zLmRpc3Bvc2VXaGVuLAoJICAgICAgICBkaXNwb3NlV2hlbiA9IGRpc3Bvc2VXaGVuT3B0aW9uLAoJICAgICAgICBkaXNwb3NlID0gZGlzcG9zZUNvbXB1dGVkLAoJICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzID0ge30sCgkgICAgICAgIF9kZXBlbmRlbmNpZXNDb3VudCA9IDAsCgkgICAgICAgIGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UgPSBudWxsOwoKCSAgICBpZiAoIWV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0KQoJICAgICAgICBldmFsdWF0b3JGdW5jdGlvblRhcmdldCA9IG9wdGlvbnNbIm93bmVyIl07CgoJICAgIGtvLnN1YnNjcmliYWJsZS5jYWxsKGRlcGVuZGVudE9ic2VydmFibGUpOwoJICAgIGtvLnV0aWxzLnNldFByb3RvdHlwZU9mT3JFeHRlbmQoZGVwZW5kZW50T2JzZXJ2YWJsZSwga28uZGVwZW5kZW50T2JzZXJ2YWJsZVsnZm4nXSk7CgoJICAgIGRlcGVuZGVudE9ic2VydmFibGUucGVlayA9IHBlZWs7CgkgICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5nZXREZXBlbmRlbmNpZXNDb3VudCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIF9kZXBlbmRlbmNpZXNDb3VudDsgfTsKCSAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmhhc1dyaXRlRnVuY3Rpb24gPSB0eXBlb2Ygb3B0aW9uc1sid3JpdGUiXSA9PT0gImZ1bmN0aW9uIjsKCSAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmRpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7IGRpc3Bvc2UoKTsgfTsKCSAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmlzQWN0aXZlID0gaXNBY3RpdmU7CgoJICAgIC8vIFJlcGxhY2UgdGhlIGxpbWl0IGZ1bmN0aW9uIHdpdGggb25lIHRoYXQgZGVsYXlzIGV2YWx1YXRpb24gYXMgd2VsbC4KCSAgICB2YXIgb3JpZ2luYWxMaW1pdCA9IGRlcGVuZGVudE9ic2VydmFibGUubGltaXQ7CgkgICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5saW1pdCA9IGZ1bmN0aW9uKGxpbWl0RnVuY3Rpb24pIHsKCSAgICAgICAgb3JpZ2luYWxMaW1pdC5jYWxsKGRlcGVuZGVudE9ic2VydmFibGUsIGxpbWl0RnVuY3Rpb24pOwoJICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLl9ldmFsUmF0ZUxpbWl0ZWQgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGUuX3JhdGVMaW1pdGVkQmVmb3JlQ2hhbmdlKF9sYXRlc3RWYWx1ZSk7CgoJICAgICAgICAgICAgX25lZWRzRXZhbHVhdGlvbiA9IHRydWU7ICAgIC8vIE1hcmsgYXMgZGlydHkKCgkgICAgICAgICAgICAvLyBQYXNzIHRoZSBvYnNlcnZhYmxlIHRvIHRoZSByYXRlLWxpbWl0IGNvZGUsIHdoaWNoIHdpbGwgYWNjZXNzIGl0IHdoZW4KCSAgICAgICAgICAgIC8vIGl0J3MgdGltZSB0byBkbyB0aGUgbm90aWZpY2F0aW9uLgoJICAgICAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5fcmF0ZUxpbWl0ZWRDaGFuZ2UoZGVwZW5kZW50T2JzZXJ2YWJsZSk7CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICBpZiAob3B0aW9uc1sncHVyZSddKSB7CgkgICAgICAgIHB1cmUgPSB0cnVlOwoJICAgICAgICBpc1NsZWVwaW5nID0gdHJ1ZTsgICAgIC8vIFN0YXJ0cyBvZmYgc2xlZXBpbmc7IHdpbGwgYXdha2Ugb24gdGhlIGZpcnN0IHN1YnNjcmlwdGlvbgoJICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmJlZm9yZVN1YnNjcmlwdGlvbkFkZCA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgIC8vIElmIGFzbGVlcCwgd2FrZSB1cCB0aGUgY29tcHV0ZWQgYW5kIGV2YWx1YXRlIHRvIHJlZ2lzdGVyIGFueSBkZXBlbmRlbmNpZXMuCgkgICAgICAgICAgICBpZiAoaXNTbGVlcGluZykgewoJICAgICAgICAgICAgICAgIGlzU2xlZXBpbmcgPSBmYWxzZTsKCSAgICAgICAgICAgICAgICBldmFsdWF0ZUltbWVkaWF0ZSh0cnVlIC8qIHN1cHByZXNzQ2hhbmdlTm90aWZpY2F0aW9uICovKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmFmdGVyU3Vic2NyaXB0aW9uUmVtb3ZlID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgaWYgKCFkZXBlbmRlbnRPYnNlcnZhYmxlLmdldFN1YnNjcmlwdGlvbnNDb3VudCgpKSB7CgkgICAgICAgICAgICAgICAgZGlzcG9zZUFsbFN1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcygpOwoJICAgICAgICAgICAgICAgIGlzU2xlZXBpbmcgPSBfbmVlZHNFdmFsdWF0aW9uID0gdHJ1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH0gZWxzZSBpZiAob3B0aW9uc1snZGVmZXJFdmFsdWF0aW9uJ10pIHsKCSAgICAgICAgLy8gVGhpcyB3aWxsIGZvcmNlIGEgY29tcHV0ZWQgd2l0aCBkZWZlckV2YWx1YXRpb24gdG8gZXZhbHVhdGUgd2hlbiB0aGUgZmlyc3Qgc3Vic2NyaXB0aW9ucyBpcyByZWdpc3RlcmVkLgoJICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmJlZm9yZVN1YnNjcmlwdGlvbkFkZCA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgIHBlZWsoKTsKCSAgICAgICAgICAgIGRlbGV0ZSBkZXBlbmRlbnRPYnNlcnZhYmxlLmJlZm9yZVN1YnNjcmlwdGlvbkFkZDsKCSAgICAgICAgfQoJICAgIH0KCgkgICAga28uZXhwb3J0UHJvcGVydHkoZGVwZW5kZW50T2JzZXJ2YWJsZSwgJ3BlZWsnLCBkZXBlbmRlbnRPYnNlcnZhYmxlLnBlZWspOwoJICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdkaXNwb3NlJywgZGVwZW5kZW50T2JzZXJ2YWJsZS5kaXNwb3NlKTsKCSAgICBrby5leHBvcnRQcm9wZXJ0eShkZXBlbmRlbnRPYnNlcnZhYmxlLCAnaXNBY3RpdmUnLCBkZXBlbmRlbnRPYnNlcnZhYmxlLmlzQWN0aXZlKTsKCSAgICBrby5leHBvcnRQcm9wZXJ0eShkZXBlbmRlbnRPYnNlcnZhYmxlLCAnZ2V0RGVwZW5kZW5jaWVzQ291bnQnLCBkZXBlbmRlbnRPYnNlcnZhYmxlLmdldERlcGVuZGVuY2llc0NvdW50KTsKCgkgICAgLy8gQWRkIGEgImRpc3Bvc2VXaGVuIiBjYWxsYmFjayB0aGF0LCBvbiBlYWNoIGV2YWx1YXRpb24sIGRpc3Bvc2VzIGlmIHRoZSBub2RlIHdhcyByZW1vdmVkIHdpdGhvdXQgdXNpbmcga28ucmVtb3ZlTm9kZS4KCSAgICBpZiAoZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkKSB7CgkgICAgICAgIC8vIFNpbmNlIHRoaXMgY29tcHV0ZWQgaXMgYXNzb2NpYXRlZCB3aXRoIGEgRE9NIG5vZGUsIGFuZCB3ZSBkb24ndCB3YW50IHRvIGRpc3Bvc2UgdGhlIGNvbXB1dGVkCgkgICAgICAgIC8vIHVudGlsIHRoZSBET00gbm9kZSBpcyAqcmVtb3ZlZCogZnJvbSB0aGUgZG9jdW1lbnQgKGFzIG9wcG9zZWQgdG8gbmV2ZXIgaGF2aW5nIGJlZW4gaW4gdGhlIGRvY3VtZW50KSwKCSAgICAgICAgLy8gd2UnbGwgcHJldmVudCBkaXNwb3NhbCB1bnRpbCAiZGlzcG9zZVdoZW4iIGZpcnN0IHJldHVybnMgZmFsc2UuCgkgICAgICAgIF9zdXBwcmVzc0Rpc3Bvc2FsVW50aWxEaXNwb3NlV2hlblJldHVybnNGYWxzZSA9IHRydWU7CgoJICAgICAgICAvLyBPbmx5IHdhdGNoIGZvciB0aGUgbm9kZSdzIGRpc3Bvc2FsIGlmIHRoZSB2YWx1ZSByZWFsbHkgaXMgYSBub2RlLiBJdCBtaWdodCBub3QgYmUsCgkgICAgICAgIC8vIGUuZy4sIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiB0cnVlIH0gY2FuIGJlIHVzZWQgdG8gb3B0IGludG8gdGhlICJvbmx5IGRpc3Bvc2UKCSAgICAgICAgLy8gYWZ0ZXIgZmlyc3QgZmFsc2UgcmVzdWx0IiBiZWhhdmlvdXIgZXZlbiBpZiB0aGVyZSdzIG5vIHNwZWNpZmljIG5vZGUgdG8gd2F0Y2guIFRoaXMKCSAgICAgICAgLy8gdGVjaG5pcXVlIGlzIGludGVuZGVkIGZvciBLTydzIGludGVybmFsIHVzZSBvbmx5IGFuZCBzaG91bGRuJ3QgYmUgZG9jdW1lbnRlZCBvciB1c2VkCgkgICAgICAgIC8vIGJ5IGFwcGxpY2F0aW9uIGNvZGUsIGFzIGl0J3MgbGlrZWx5IHRvIGNoYW5nZSBpbiBhIGZ1dHVyZSB2ZXJzaW9uIG9mIEtPLgoJICAgICAgICBpZiAoZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkLm5vZGVUeXBlKSB7CgkgICAgICAgICAgICBkaXNwb3NlV2hlbiA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gIWtvLnV0aWxzLmRvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQpIHx8IChkaXNwb3NlV2hlbk9wdGlvbiAmJiBkaXNwb3NlV2hlbk9wdGlvbigpKTsKCSAgICAgICAgICAgIH07CgkgICAgICAgIH0KCSAgICB9CgoJICAgIC8vIEV2YWx1YXRlLCB1bmxlc3Mgc2xlZXBpbmcgb3IgZGVmZXJFdmFsdWF0aW9uIGlzIHRydWUKCSAgICBpZiAoIWlzU2xlZXBpbmcgJiYgIW9wdGlvbnNbJ2RlZmVyRXZhbHVhdGlvbiddKQoJICAgICAgICBldmFsdWF0ZUltbWVkaWF0ZSgpOwoKCSAgICAvLyBBdHRhY2ggYSBET00gbm9kZSBkaXNwb3NhbCBjYWxsYmFjayBzbyB0aGF0IHRoZSBjb21wdXRlZCB3aWxsIGJlIHByb2FjdGl2ZWx5IGRpc3Bvc2VkIGFzIHNvb24gYXMgdGhlIG5vZGUgaXMKCSAgICAvLyByZW1vdmVkIHVzaW5nIGtvLnJlbW92ZU5vZGUuIEJ1dCBza2lwIGlmIGlzQWN0aXZlIGlzIGZhbHNlICh0aGVyZSB3aWxsIG5ldmVyIGJlIGFueSBkZXBlbmRlbmNpZXMgdG8gZGlzcG9zZSkuCgkgICAgaWYgKGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCAmJiBpc0FjdGl2ZSgpICYmIGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZC5ub2RlVHlwZSkgewoJICAgICAgICBkaXNwb3NlID0gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlRGlzcG9zZUNhbGxiYWNrKGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCwgZGlzcG9zZSk7CgkgICAgICAgICAgICBkaXNwb3NlQ29tcHV0ZWQoKTsKCSAgICAgICAgfTsKCSAgICAgICAga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayhkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQsIGRpc3Bvc2UpOwoJICAgIH0KCgkgICAgcmV0dXJuIGRlcGVuZGVudE9ic2VydmFibGU7Cgl9OwoKCWtvLmlzQ29tcHV0ZWQgPSBmdW5jdGlvbihpbnN0YW5jZSkgewoJICAgIHJldHVybiBrby5oYXNQcm90b3R5cGUoaW5zdGFuY2UsIGtvLmRlcGVuZGVudE9ic2VydmFibGUpOwoJfTsKCgl2YXIgcHJvdG9Qcm9wID0ga28ub2JzZXJ2YWJsZS5wcm90b1Byb3BlcnR5OyAvLyA9PSAiX19rb19wcm90b19fIgoJa28uZGVwZW5kZW50T2JzZXJ2YWJsZVtwcm90b1Byb3BdID0ga28ub2JzZXJ2YWJsZTsKCglrby5kZXBlbmRlbnRPYnNlcnZhYmxlWydmbiddID0gewoJICAgICJlcXVhbGl0eUNvbXBhcmVyIjogdmFsdWVzQXJlUHJpbWl0aXZlQW5kRXF1YWwKCX07Cglrby5kZXBlbmRlbnRPYnNlcnZhYmxlWydmbiddW3Byb3RvUHJvcF0gPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlOwoKCS8vIE5vdGUgdGhhdCBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IHByb3RvIGFzc2lnbm1lbnQsIHRoZQoJLy8gaW5oZXJpdGFuY2UgY2hhaW4gaXMgY3JlYXRlZCBtYW51YWxseSBpbiB0aGUga28uZGVwZW5kZW50T2JzZXJ2YWJsZSBjb25zdHJ1Y3RvcgoJaWYgKGtvLnV0aWxzLmNhblNldFByb3RvdHlwZSkgewoJICAgIGtvLnV0aWxzLnNldFByb3RvdHlwZU9mKGtvLmRlcGVuZGVudE9ic2VydmFibGVbJ2ZuJ10sIGtvLnN1YnNjcmliYWJsZVsnZm4nXSk7Cgl9CgoJa28uZXhwb3J0U3ltYm9sKCdkZXBlbmRlbnRPYnNlcnZhYmxlJywga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7Cglrby5leHBvcnRTeW1ib2woJ2NvbXB1dGVkJywga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7IC8vIE1ha2UgImtvLmNvbXB1dGVkIiBhbiBhbGlhcyBmb3IgImtvLmRlcGVuZGVudE9ic2VydmFibGUiCglrby5leHBvcnRTeW1ib2woJ2lzQ29tcHV0ZWQnLCBrby5pc0NvbXB1dGVkKTsKCglrby5wdXJlQ29tcHV0ZWQgPSBmdW5jdGlvbiAoZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMsIGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0KSB7CgkgICAgaWYgKHR5cGVvZiBldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICByZXR1cm4ga28uY29tcHV0ZWQoZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMsIGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0LCB7J3B1cmUnOnRydWV9KTsKCSAgICB9IGVsc2UgewoJICAgICAgICBldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucyA9IGtvLnV0aWxzLmV4dGVuZCh7fSwgZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMpOyAgIC8vIG1ha2UgYSBjb3B5IG9mIHRoZSBwYXJhbWV0ZXIgb2JqZWN0CgkgICAgICAgIGV2YWx1YXRvckZ1bmN0aW9uT3JPcHRpb25zWydwdXJlJ10gPSB0cnVlOwoJICAgICAgICByZXR1cm4ga28uY29tcHV0ZWQoZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMsIGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0KTsKCSAgICB9Cgl9Cglrby5leHBvcnRTeW1ib2woJ3B1cmVDb21wdXRlZCcsIGtvLnB1cmVDb21wdXRlZCk7CgoJKGZ1bmN0aW9uKCkgewoJICAgIHZhciBtYXhOZXN0ZWRPYnNlcnZhYmxlRGVwdGggPSAxMDsgLy8gRXNjYXBlIHRoZSAodW5saWtlbHkpIHBhdGhhbG9naWNhbCBjYXNlIHdoZXJlIGFuIG9ic2VydmFibGUncyBjdXJyZW50IHZhbHVlIGlzIGl0c2VsZiAob3Igc2ltaWxhciByZWZlcmVuY2UgY3ljbGUpCgoJICAgIGtvLnRvSlMgPSBmdW5jdGlvbihyb290T2JqZWN0KSB7CgkgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDApCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldoZW4gY2FsbGluZyBrby50b0pTLCBwYXNzIHRoZSBvYmplY3QgeW91IHdhbnQgdG8gY29udmVydC4iKTsKCgkgICAgICAgIC8vIFdlIGp1c3QgdW53cmFwIGV2ZXJ5dGhpbmcgYXQgZXZlcnkgbGV2ZWwgaW4gdGhlIG9iamVjdCBncmFwaAoJICAgICAgICByZXR1cm4gbWFwSnNPYmplY3RHcmFwaChyb290T2JqZWN0LCBmdW5jdGlvbih2YWx1ZVRvTWFwKSB7CgkgICAgICAgICAgICAvLyBMb29wIGJlY2F1c2UgYW4gb2JzZXJ2YWJsZSdzIHZhbHVlIG1pZ2h0IGluIHR1cm4gYmUgYW5vdGhlciBvYnNlcnZhYmxlIHdyYXBwZXIKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBrby5pc09ic2VydmFibGUodmFsdWVUb01hcCkgJiYgKGkgPCBtYXhOZXN0ZWRPYnNlcnZhYmxlRGVwdGgpOyBpKyspCgkgICAgICAgICAgICAgICAgdmFsdWVUb01hcCA9IHZhbHVlVG9NYXAoKTsKCSAgICAgICAgICAgIHJldHVybiB2YWx1ZVRvTWFwOwoJICAgICAgICB9KTsKCSAgICB9OwoKCSAgICBrby50b0pTT04gPSBmdW5jdGlvbihyb290T2JqZWN0LCByZXBsYWNlciwgc3BhY2UpIHsgICAgIC8vIHJlcGxhY2VyIGFuZCBzcGFjZSBhcmUgb3B0aW9uYWwKCSAgICAgICAgdmFyIHBsYWluSmF2YVNjcmlwdE9iamVjdCA9IGtvLnRvSlMocm9vdE9iamVjdCk7CgkgICAgICAgIHJldHVybiBrby51dGlscy5zdHJpbmdpZnlKc29uKHBsYWluSmF2YVNjcmlwdE9iamVjdCwgcmVwbGFjZXIsIHNwYWNlKTsKCSAgICB9OwoKCSAgICBmdW5jdGlvbiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIG1hcElucHV0Q2FsbGJhY2ssIHZpc2l0ZWRPYmplY3RzKSB7CgkgICAgICAgIHZpc2l0ZWRPYmplY3RzID0gdmlzaXRlZE9iamVjdHMgfHwgbmV3IG9iamVjdExvb2t1cCgpOwoKCSAgICAgICAgcm9vdE9iamVjdCA9IG1hcElucHV0Q2FsbGJhY2socm9vdE9iamVjdCk7CgkgICAgICAgIHZhciBjYW5IYXZlUHJvcGVydGllcyA9ICh0eXBlb2Ygcm9vdE9iamVjdCA9PSAib2JqZWN0IikgJiYgKHJvb3RPYmplY3QgIT09IG51bGwpICYmIChyb290T2JqZWN0ICE9PSB1bmRlZmluZWQpICYmICghKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBEYXRlKSkgJiYgKCEocm9vdE9iamVjdCBpbnN0YW5jZW9mIFN0cmluZykpICYmICghKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBOdW1iZXIpKSAmJiAoIShyb290T2JqZWN0IGluc3RhbmNlb2YgQm9vbGVhbikpOwoJICAgICAgICBpZiAoIWNhbkhhdmVQcm9wZXJ0aWVzKQoJICAgICAgICAgICAgcmV0dXJuIHJvb3RPYmplY3Q7CgoJICAgICAgICB2YXIgb3V0cHV0UHJvcGVydGllcyA9IHJvb3RPYmplY3QgaW5zdGFuY2VvZiBBcnJheSA/IFtdIDoge307CgkgICAgICAgIHZpc2l0ZWRPYmplY3RzLnNhdmUocm9vdE9iamVjdCwgb3V0cHV0UHJvcGVydGllcyk7CgoJICAgICAgICB2aXNpdFByb3BlcnRpZXNPckFycmF5RW50cmllcyhyb290T2JqZWN0LCBmdW5jdGlvbihpbmRleGVyKSB7CgkgICAgICAgICAgICB2YXIgcHJvcGVydHlWYWx1ZSA9IG1hcElucHV0Q2FsbGJhY2socm9vdE9iamVjdFtpbmRleGVyXSk7CgoJICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgcHJvcGVydHlWYWx1ZSkgewoJICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgoJICAgICAgICAgICAgICAgIGNhc2UgIm51bWJlciI6CgkgICAgICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKCSAgICAgICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CgkgICAgICAgICAgICAgICAgICAgIG91dHB1dFByb3BlcnRpZXNbaW5kZXhlcl0gPSBwcm9wZXJ0eVZhbHVlOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgoJICAgICAgICAgICAgICAgIGNhc2UgInVuZGVmaW5lZCI6CgkgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c2x5TWFwcGVkVmFsdWUgPSB2aXNpdGVkT2JqZWN0cy5nZXQocHJvcGVydHlWYWx1ZSk7CgkgICAgICAgICAgICAgICAgICAgIG91dHB1dFByb3BlcnRpZXNbaW5kZXhlcl0gPSAocHJldmlvdXNseU1hcHBlZFZhbHVlICE9PSB1bmRlZmluZWQpCgkgICAgICAgICAgICAgICAgICAgICAgICA/IHByZXZpb3VzbHlNYXBwZWRWYWx1ZQoJICAgICAgICAgICAgICAgICAgICAgICAgOiBtYXBKc09iamVjdEdyYXBoKHByb3BlcnR5VmFsdWUsIG1hcElucHV0Q2FsbGJhY2ssIHZpc2l0ZWRPYmplY3RzKTsKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoKCSAgICAgICAgcmV0dXJuIG91dHB1dFByb3BlcnRpZXM7CgkgICAgfQoKCSAgICBmdW5jdGlvbiB2aXNpdFByb3BlcnRpZXNPckFycmF5RW50cmllcyhyb290T2JqZWN0LCB2aXNpdG9yQ2FsbGJhY2spIHsKCSAgICAgICAgaWYgKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBBcnJheSkgewoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByb290T2JqZWN0Lmxlbmd0aDsgaSsrKQoJICAgICAgICAgICAgICAgIHZpc2l0b3JDYWxsYmFjayhpKTsKCgkgICAgICAgICAgICAvLyBGb3IgYXJyYXlzLCBhbHNvIHJlc3BlY3QgdG9KU09OIHByb3BlcnR5IGZvciBjdXN0b20gbWFwcGluZ3MgKGZpeGVzICMyNzgpCgkgICAgICAgICAgICBpZiAodHlwZW9mIHJvb3RPYmplY3RbJ3RvSlNPTiddID09ICdmdW5jdGlvbicpCgkgICAgICAgICAgICAgICAgdmlzaXRvckNhbGxiYWNrKCd0b0pTT04nKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGZvciAodmFyIHByb3BlcnR5TmFtZSBpbiByb290T2JqZWN0KSB7CgkgICAgICAgICAgICAgICAgdmlzaXRvckNhbGxiYWNrKHByb3BlcnR5TmFtZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICBmdW5jdGlvbiBvYmplY3RMb29rdXAoKSB7CgkgICAgICAgIHRoaXMua2V5cyA9IFtdOwoJICAgICAgICB0aGlzLnZhbHVlcyA9IFtdOwoJICAgIH07CgoJICAgIG9iamVjdExvb2t1cC5wcm90b3R5cGUgPSB7CgkgICAgICAgIGNvbnN0cnVjdG9yOiBvYmplY3RMb29rdXAsCgkgICAgICAgIHNhdmU6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKCSAgICAgICAgICAgIHZhciBleGlzdGluZ0luZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKHRoaXMua2V5cywga2V5KTsKCSAgICAgICAgICAgIGlmIChleGlzdGluZ0luZGV4ID49IDApCgkgICAgICAgICAgICAgICAgdGhpcy52YWx1ZXNbZXhpc3RpbmdJbmRleF0gPSB2YWx1ZTsKCSAgICAgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgICAgIHRoaXMua2V5cy5wdXNoKGtleSk7CgkgICAgICAgICAgICAgICAgdGhpcy52YWx1ZXMucHVzaCh2YWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgkgICAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CgkgICAgICAgICAgICB2YXIgZXhpc3RpbmdJbmRleCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZih0aGlzLmtleXMsIGtleSk7CgkgICAgICAgICAgICByZXR1cm4gKGV4aXN0aW5nSW5kZXggPj0gMCkgPyB0aGlzLnZhbHVlc1tleGlzdGluZ0luZGV4XSA6IHVuZGVmaW5lZDsKCSAgICAgICAgfQoJICAgIH07Cgl9KSgpOwoKCWtvLmV4cG9ydFN5bWJvbCgndG9KUycsIGtvLnRvSlMpOwoJa28uZXhwb3J0U3ltYm9sKCd0b0pTT04nLCBrby50b0pTT04pOwoJKGZ1bmN0aW9uICgpIHsKCSAgICB2YXIgaGFzRG9tRGF0YUV4cGFuZG9Qcm9wZXJ0eSA9ICdfX2tvX19oYXNEb21EYXRhT3B0aW9uVmFsdWVfXyc7CgoJICAgIC8vIE5vcm1hbGx5LCBTRUxFQ1QgZWxlbWVudHMgYW5kIHRoZWlyIE9QVElPTnMgY2FuIG9ubHkgdGFrZSB2YWx1ZSBvZiB0eXBlICdzdHJpbmcnIChiZWNhdXNlIHRoZSB2YWx1ZXMKCSAgICAvLyBhcmUgc3RvcmVkIG9uIERPTSBhdHRyaWJ1dGVzKS4ga28uc2VsZWN0RXh0ZW5zaW9ucyBwcm92aWRlcyBhIHdheSBmb3IgU0VMRUNUcy9PUFRJT05zIHRvIGhhdmUgdmFsdWVzCgkgICAgLy8gdGhhdCBhcmUgYXJiaXRyYXJ5IG9iamVjdHMuIFRoaXMgaXMgdmVyeSBjb252ZW5pZW50IHdoZW4gaW1wbGVtZW50aW5nIHRoaW5ncyBsaWtlIGNhc2NhZGluZyBkcm9wZG93bnMuCgkgICAga28uc2VsZWN0RXh0ZW5zaW9ucyA9IHsKCSAgICAgICAgcmVhZFZhbHVlIDogZnVuY3Rpb24oZWxlbWVudCkgewoJICAgICAgICAgICAgc3dpdGNoIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkpIHsKCSAgICAgICAgICAgICAgICBjYXNlICdvcHRpb24nOgoJICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XSA9PT0gdHJ1ZSkKCSAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBrby51dGlscy5kb21EYXRhLmdldChlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnMub3B0aW9ucy5vcHRpb25WYWx1ZURvbURhdGFLZXkpOwoJICAgICAgICAgICAgICAgICAgICByZXR1cm4ga28udXRpbHMuaWVWZXJzaW9uIDw9IDcKCSAgICAgICAgICAgICAgICAgICAgICAgID8gKGVsZW1lbnQuZ2V0QXR0cmlidXRlTm9kZSgndmFsdWUnKSAmJiBlbGVtZW50LmdldEF0dHJpYnV0ZU5vZGUoJ3ZhbHVlJykuc3BlY2lmaWVkID8gZWxlbWVudC52YWx1ZSA6IGVsZW1lbnQudGV4dCkKCSAgICAgICAgICAgICAgICAgICAgICAgIDogZWxlbWVudC52YWx1ZTsKCSAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOgoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC5zZWxlY3RlZEluZGV4ID49IDAgPyBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50Lm9wdGlvbnNbZWxlbWVudC5zZWxlY3RlZEluZGV4XSkgOiB1bmRlZmluZWQ7CgkgICAgICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQudmFsdWU7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICB3cml0ZVZhbHVlOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSwgYWxsb3dVbnNldCkgewoJICAgICAgICAgICAgc3dpdGNoIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkpIHsKCSAgICAgICAgICAgICAgICBjYXNlICdvcHRpb24nOgoJICAgICAgICAgICAgICAgICAgICBzd2l0Y2godHlwZW9mIHZhbHVlKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJzdHJpbmciOgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSwgdW5kZWZpbmVkKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzRG9tRGF0YUV4cGFuZG9Qcm9wZXJ0eSBpbiBlbGVtZW50KSB7IC8vIElFIDw9IDggdGhyb3dzIGVycm9ycyBpZiB5b3UgZGVsZXRlIG5vbi1leGlzdGVudCBwcm9wZXJ0aWVzIGZyb20gYSBET00gbm9kZQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9yZSBhcmJpdHJhcnkgb2JqZWN0IHVzaW5nIERvbURhdGEKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnMub3B0aW9ucy5vcHRpb25WYWx1ZURvbURhdGFLZXksIHZhbHVlKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50W2hhc0RvbURhdGFFeHBhbmRvUHJvcGVydHldID0gdHJ1ZTsKCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3BlY2lhbCB0cmVhdG1lbnQgb2YgbnVtYmVycyBpcyBqdXN0IGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LiBLTyAxLjIuMSB3cm90ZSBudW1lcmljYWwgdmFsdWVzIHRvIGVsZW1lbnQudmFsdWUuCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgPyB2YWx1ZSA6ICIiOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGNhc2UgJ3NlbGVjdCc6CgkgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIgfHwgdmFsdWUgPT09IG51bGwpICAgICAgIC8vIEEgYmxhbmsgc3RyaW5nIG9yIG51bGwgdmFsdWUgd2lsbCBzZWxlY3QgdGhlIGNhcHRpb24KCSAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdW5kZWZpbmVkOwoJICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gLTE7CgkgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBuID0gZWxlbWVudC5vcHRpb25zLmxlbmd0aCwgb3B0aW9uVmFsdWU7IGkgPCBuOyArK2kpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvblZhbHVlID0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudC5vcHRpb25zW2ldKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluY2x1ZGUgc3BlY2lhbCBjaGVjayB0byBoYW5kbGUgc2VsZWN0aW5nIGEgY2FwdGlvbiB3aXRoIGEgYmxhbmsgc3RyaW5nIHZhbHVlCgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uVmFsdWUgPT0gdmFsdWUgfHwgKG9wdGlvblZhbHVlID09ICIiICYmIHZhbHVlID09PSB1bmRlZmluZWQpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uID0gaTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBpZiAoYWxsb3dVbnNldCB8fCBzZWxlY3Rpb24gPj0gMCB8fCAodmFsdWUgPT09IHVuZGVmaW5lZCAmJiBlbGVtZW50LnNpemUgPiAxKSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zZWxlY3RlZEluZGV4ID0gc2VsZWN0aW9uOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgICAgIGlmICgodmFsdWUgPT09IG51bGwpIHx8ICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSkKCSAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gIiI7CgkgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudmFsdWUgPSB2YWx1ZTsKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ3NlbGVjdEV4dGVuc2lvbnMnLCBrby5zZWxlY3RFeHRlbnNpb25zKTsKCWtvLmV4cG9ydFN5bWJvbCgnc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUnLCBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZSk7Cglrby5leHBvcnRTeW1ib2woJ3NlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZScsIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZSk7Cglrby5leHByZXNzaW9uUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKCSAgICB2YXIgamF2YVNjcmlwdFJlc2VydmVkV29yZHMgPSBbInRydWUiLCAiZmFsc2UiLCAibnVsbCIsICJ1bmRlZmluZWQiXTsKCgkgICAgLy8gTWF0Y2hlcyBzb21ldGhpbmcgdGhhdCBjYW4gYmUgYXNzaWduZWQgdG8tLWVpdGhlciBhbiBpc29sYXRlZCBpZGVudGlmaWVyIG9yIHNvbWV0aGluZyBlbmRpbmcgd2l0aCBhIHByb3BlcnR5IGFjY2Vzc29yCgkgICAgLy8gVGhpcyBpcyBkZXNpZ25lZCB0byBiZSBzaW1wbGUgYW5kIGF2b2lkIGZhbHNlIG5lZ2F0aXZlcywgYnV0IGNvdWxkIHByb2R1Y2UgZmFsc2UgcG9zaXRpdmVzIChlLmcuLCBhK2IuYykuCgkgICAgLy8gVGhpcyBhbHNvIHdpbGwgbm90IHByb3Blcmx5IGhhbmRsZSBuZXN0ZWQgYnJhY2tldHMgKGUuZy4sIG9iajFbb2JqMlsncHJvcCddXTsgc2VlICM5MTEpLgoJICAgIHZhciBqYXZhU2NyaXB0QXNzaWdubWVudFRhcmdldCA9IC9eKD86WyRfYS16XVskXHddKnwoLispKFwuXHMqWyRfYS16XVskXHddKnxcWy4rXF0pKSQvaTsKCgkgICAgZnVuY3Rpb24gZ2V0V3JpdGVhYmxlVmFsdWUoZXhwcmVzc2lvbikgewoJICAgICAgICBpZiAoa28udXRpbHMuYXJyYXlJbmRleE9mKGphdmFTY3JpcHRSZXNlcnZlZFdvcmRzLCBleHByZXNzaW9uKSA+PSAwKQoJICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgICB2YXIgbWF0Y2ggPSBleHByZXNzaW9uLm1hdGNoKGphdmFTY3JpcHRBc3NpZ25tZW50VGFyZ2V0KTsKCSAgICAgICAgcmV0dXJuIG1hdGNoID09PSBudWxsID8gZmFsc2UgOiBtYXRjaFsxXSA/ICgnT2JqZWN0KCcgKyBtYXRjaFsxXSArICcpJyArIG1hdGNoWzJdKSA6IGV4cHJlc3Npb247CgkgICAgfQoKCSAgICAvLyBUaGUgZm9sbG93aW5nIHJlZ3VsYXIgZXhwcmVzc2lvbnMgd2lsbCBiZSB1c2VkIHRvIHNwbGl0IGFuIG9iamVjdC1saXRlcmFsIHN0cmluZyBpbnRvIHRva2VucwoKCSAgICAgICAgLy8gVGhlc2UgdHdvIG1hdGNoIHN0cmluZ3MsIGVpdGhlciB3aXRoIGRvdWJsZSBxdW90ZXMgb3Igc2luZ2xlIHF1b3RlcwoJICAgIHZhciBzdHJpbmdEb3VibGUgPSAnIig/OlteIlxcXFxdfFxcXFwuKSoiJywKCSAgICAgICAgc3RyaW5nU2luZ2xlID0gIicoPzpbXidcXFxcXXxcXFxcLikqJyIsCgkgICAgICAgIC8vIE1hdGNoZXMgYSByZWd1bGFyIGV4cHJlc3Npb24gKHRleHQgZW5jbG9zZWQgYnkgc2xhc2hlcyksIGJ1dCB3aWxsIGFsc28gbWF0Y2ggc2V0cyBvZiBkaXZpc2lvbnMKCSAgICAgICAgLy8gYXMgYSByZWd1bGFyIGV4cHJlc3Npb24gKHRoaXMgaXMgaGFuZGxlZCBieSB0aGUgcGFyc2luZyBsb29wIGJlbG93KS4KCSAgICAgICAgc3RyaW5nUmVnZXhwID0gJy8oPzpbXi9cXFxcXXxcXFxcLikqL1x3KicsCgkgICAgICAgIC8vIFRoZXNlIGNoYXJhY3RlcnMgaGF2ZSBzcGVjaWFsIG1lYW5pbmcgdG8gdGhlIHBhcnNlciBhbmQgbXVzdCBub3QgYXBwZWFyIGluIHRoZSBtaWRkbGUgb2YgYQoJICAgICAgICAvLyB0b2tlbiwgZXhjZXB0IGFzIHBhcnQgb2YgYSBzdHJpbmcuCgkgICAgICAgIHNwZWNpYWxzID0gJywiXCd7fSgpLzpbXFxdJywKCSAgICAgICAgLy8gTWF0Y2ggdGV4dCAoYXQgbGVhc3QgdHdvIGNoYXJhY3RlcnMpIHRoYXQgZG9lcyBub3QgY29udGFpbiBhbnkgb2YgdGhlIGFib3ZlIHNwZWNpYWwgY2hhcmFjdGVycywKCSAgICAgICAgLy8gYWx0aG91Z2ggc29tZSBvZiB0aGUgc3BlY2lhbCBjaGFyYWN0ZXJzIGFyZSBhbGxvd2VkIHRvIHN0YXJ0IGl0IChhbGwgYnV0IHRoZSBjb2xvbiBhbmQgY29tbWEpLgoJICAgICAgICAvLyBUaGUgdGV4dCBjYW4gY29udGFpbiBzcGFjZXMsIGJ1dCBsZWFkaW5nIG9yIHRyYWlsaW5nIHNwYWNlcyBhcmUgc2tpcHBlZC4KCSAgICAgICAgZXZlcnlUaGluZ0Vsc2UgPSAnW15cXHM6LC9dW14nICsgc3BlY2lhbHMgKyAnXSpbXlxccycgKyBzcGVjaWFscyArICddJywKCSAgICAgICAgLy8gTWF0Y2ggYW55IG5vbi1zcGFjZSBjaGFyYWN0ZXIgbm90IG1hdGNoZWQgYWxyZWFkeS4gVGhpcyB3aWxsIG1hdGNoIGNvbG9ucyBhbmQgY29tbWFzLCBzaW5jZSB0aGV5J3JlCgkgICAgICAgIC8vIG5vdCBtYXRjaGVkIGJ5ICJldmVyeVRoaW5nRWxzZSIsIGJ1dCB3aWxsIGFsc28gbWF0Y2ggYW55IG90aGVyIHNpbmdsZSBjaGFyYWN0ZXIgdGhhdCB3YXNuJ3QgYWxyZWFkeQoJICAgICAgICAvLyBtYXRjaGVkIChmb3IgZXhhbXBsZTogaW4gImE6IDEsIGI6IDIiLCBlYWNoIG9mIHRoZSBub24tc3BhY2UgY2hhcmFjdGVycyB3aWxsIGJlIG1hdGNoZWQgYnkgb25lTm90U3BhY2UpLgoJICAgICAgICBvbmVOb3RTcGFjZSA9ICdbXlxcc10nLAoKCSAgICAgICAgLy8gQ3JlYXRlIHRoZSBhY3R1YWwgcmVndWxhciBleHByZXNzaW9uIGJ5IG9yLWluZyB0aGUgYWJvdmUgc3RyaW5ncy4gVGhlIG9yZGVyIGlzIGltcG9ydGFudC4KCSAgICAgICAgYmluZGluZ1Rva2VuID0gUmVnRXhwKHN0cmluZ0RvdWJsZSArICd8JyArIHN0cmluZ1NpbmdsZSArICd8JyArIHN0cmluZ1JlZ2V4cCArICd8JyArIGV2ZXJ5VGhpbmdFbHNlICsgJ3wnICsgb25lTm90U3BhY2UsICdnJyksCgoJICAgICAgICAvLyBNYXRjaCBlbmQgb2YgcHJldmlvdXMgdG9rZW4gdG8gZGV0ZXJtaW5lIHdoZXRoZXIgYSBzbGFzaCBpcyBhIGRpdmlzaW9uIG9yIHJlZ2V4LgoJICAgICAgICBkaXZpc2lvbkxvb2tCZWhpbmQgPSAvW1xdKSInQS1aYS16MC05XyRdKyQvLAoJICAgICAgICBrZXl3b3JkUmVnZXhMb29rQmVoaW5kID0geydpbic6MSwncmV0dXJuJzoxLCd0eXBlb2YnOjF9OwoKCSAgICBmdW5jdGlvbiBwYXJzZU9iamVjdExpdGVyYWwob2JqZWN0TGl0ZXJhbFN0cmluZykgewoJICAgICAgICAvLyBUcmltIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNwYWNlcyBmcm9tIHRoZSBzdHJpbmcKCSAgICAgICAgdmFyIHN0ciA9IGtvLnV0aWxzLnN0cmluZ1RyaW0ob2JqZWN0TGl0ZXJhbFN0cmluZyk7CgoJICAgICAgICAvLyBUcmltIGJyYWNlcyAneycgc3Vycm91bmRpbmcgdGhlIHdob2xlIG9iamVjdCBsaXRlcmFsCgkgICAgICAgIGlmIChzdHIuY2hhckNvZGVBdCgwKSA9PT0gMTIzKSBzdHIgPSBzdHIuc2xpY2UoMSwgLTEpOwoKCSAgICAgICAgLy8gU3BsaXQgaW50byB0b2tlbnMKCSAgICAgICAgdmFyIHJlc3VsdCA9IFtdLCB0b2tzID0gc3RyLm1hdGNoKGJpbmRpbmdUb2tlbiksIGtleSwgdmFsdWVzLCBkZXB0aCA9IDA7CgoJICAgICAgICBpZiAodG9rcykgewoJICAgICAgICAgICAgLy8gQXBwZW5kIGEgY29tbWEgc28gdGhhdCB3ZSBkb24ndCBuZWVkIGEgc2VwYXJhdGUgY29kZSBibG9jayB0byBkZWFsIHdpdGggdGhlIGxhc3QgaXRlbQoJICAgICAgICAgICAgdG9rcy5wdXNoKCcsJyk7CgoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIHRvazsgdG9rID0gdG9rc1tpXTsgKytpKSB7CgkgICAgICAgICAgICAgICAgdmFyIGMgPSB0b2suY2hhckNvZGVBdCgwKTsKCSAgICAgICAgICAgICAgICAvLyBBIGNvbW1hIHNpZ25hbHMgdGhlIGVuZCBvZiBhIGtleS92YWx1ZSBwYWlyIGlmIGRlcHRoIGlzIHplcm8KCSAgICAgICAgICAgICAgICBpZiAoYyA9PT0gNDQpIHsgLy8gIiwiCgkgICAgICAgICAgICAgICAgICAgIGlmIChkZXB0aCA8PSAwKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5KQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlcyA/IHtrZXk6IGtleSwgdmFsdWU6IHZhbHVlcy5qb2luKCcnKX0gOiB7J3Vua25vd24nOiBrZXl9KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IHZhbHVlcyA9IGRlcHRoID0gMDsKCSAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgLy8gU2ltcGx5IHNraXAgdGhlIGNvbG9uIHRoYXQgc2VwYXJhdGVzIHRoZSBuYW1lIGFuZCB2YWx1ZQoJICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gNTgpIHsgLy8gIjoiCgkgICAgICAgICAgICAgICAgICAgIGlmICghdmFsdWVzKQoJICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgICAgICAgICAgLy8gQSBzZXQgb2Ygc2xhc2hlcyBpcyBpbml0aWFsbHkgbWF0Y2hlZCBhcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgYnV0IGNvdWxkIGJlIGRpdmlzaW9uCgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSA0NyAmJiBpICYmIHRvay5sZW5ndGggPiAxKSB7ICAvLyAiLyIKCSAgICAgICAgICAgICAgICAgICAgLy8gTG9vayBhdCB0aGUgZW5kIG9mIHRoZSBwcmV2aW91cyB0b2tlbiB0byBkZXRlcm1pbmUgaWYgdGhlIHNsYXNoIGlzIGFjdHVhbGx5IGRpdmlzaW9uCgkgICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IHRva3NbaS0xXS5tYXRjaChkaXZpc2lvbkxvb2tCZWhpbmQpOwoJICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2ggJiYgIWtleXdvcmRSZWdleExvb2tCZWhpbmRbbWF0Y2hbMF1dKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgc2xhc2ggaXMgYWN0dWFsbHkgYSBkaXZpc2lvbiBwdW5jdHVhdG9yOyByZS1wYXJzZSB0aGUgcmVtYWluZGVyIG9mIHRoZSBzdHJpbmcgKG5vdCBpbmNsdWRpbmcgdGhlIHNsYXNoKQoJICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyLnN1YnN0cihzdHIuaW5kZXhPZih0b2spICsgMSk7CgkgICAgICAgICAgICAgICAgICAgICAgICB0b2tzID0gc3RyLm1hdGNoKGJpbmRpbmdUb2tlbik7CgkgICAgICAgICAgICAgICAgICAgICAgICB0b2tzLnB1c2goJywnKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGkgPSAtMTsKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbnRpbnVlIHdpdGgganVzdCB0aGUgc2xhc2gKCSAgICAgICAgICAgICAgICAgICAgICAgIHRvayA9ICcvJzsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIC8vIEluY3JlbWVudCBkZXB0aCBmb3IgcGFyZW50aGVzZXMsIGJyYWNlcywgYW5kIGJyYWNrZXRzIHNvIHRoYXQgaW50ZXJpb3IgY29tbWFzIGFyZSBpZ25vcmVkCgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSA0MCB8fCBjID09PSAxMjMgfHwgYyA9PT0gOTEpIHsgLy8gJygnLCAneycsICdbJwoJICAgICAgICAgICAgICAgICAgICArK2RlcHRoOwoJICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gNDEgfHwgYyA9PT0gMTI1IHx8IGMgPT09IDkzKSB7IC8vICcpJywgJ30nLCAnXScKCSAgICAgICAgICAgICAgICAgICAgLS1kZXB0aDsKCSAgICAgICAgICAgICAgICAvLyBUaGUga2V5IG11c3QgYmUgYSBzaW5nbGUgdG9rZW47IGlmIGl0J3MgYSBzdHJpbmcsIHRyaW0gdGhlIHF1b3RlcwoJICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWtleSAmJiAhdmFsdWVzKSB7CgkgICAgICAgICAgICAgICAgICAgIGtleSA9IChjID09PSAzNCB8fCBjID09PSAzOSkgLyogJyInLCAiJyIgKi8gPyB0b2suc2xpY2UoMSwgLTEpIDogdG9rOwoJICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKHZhbHVlcykKCSAgICAgICAgICAgICAgICAgICAgdmFsdWVzLnB1c2godG9rKTsKCSAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgIHZhbHVlcyA9IFt0b2tdOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgfQoKCSAgICAvLyBUd28td2F5IGJpbmRpbmdzIGluY2x1ZGUgYSB3cml0ZSBmdW5jdGlvbiB0aGF0IGFsbG93IHRoZSBoYW5kbGVyIHRvIHVwZGF0ZSB0aGUgdmFsdWUgZXZlbiBpZiBpdCdzIG5vdCBhbiBvYnNlcnZhYmxlLgoJICAgIHZhciB0d29XYXlCaW5kaW5ncyA9IHt9OwoKCSAgICBmdW5jdGlvbiBwcmVQcm9jZXNzQmluZGluZ3MoYmluZGluZ3NTdHJpbmdPcktleVZhbHVlQXJyYXksIGJpbmRpbmdPcHRpb25zKSB7CgkgICAgICAgIGJpbmRpbmdPcHRpb25zID0gYmluZGluZ09wdGlvbnMgfHwge307CgoJICAgICAgICBmdW5jdGlvbiBwcm9jZXNzS2V5VmFsdWUoa2V5LCB2YWwpIHsKCSAgICAgICAgICAgIHZhciB3cml0YWJsZVZhbDsKCSAgICAgICAgICAgIGZ1bmN0aW9uIGNhbGxQcmVwcm9jZXNzSG9vayhvYmopIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gKG9iaiAmJiBvYmpbJ3ByZXByb2Nlc3MnXSkgPyAodmFsID0gb2JqWydwcmVwcm9jZXNzJ10odmFsLCBrZXksIHByb2Nlc3NLZXlWYWx1ZSkpIDogdHJ1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmICghYmluZGluZ1BhcmFtcykgewoJICAgICAgICAgICAgICAgIGlmICghY2FsbFByZXByb2Nlc3NIb29rKGtvWydnZXRCaW5kaW5nSGFuZGxlciddKGtleSkpKQoJICAgICAgICAgICAgICAgICAgICByZXR1cm47CgoJICAgICAgICAgICAgICAgIGlmICh0d29XYXlCaW5kaW5nc1trZXldICYmICh3cml0YWJsZVZhbCA9IGdldFdyaXRlYWJsZVZhbHVlKHZhbCkpKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEZvciB0d28td2F5IGJpbmRpbmdzLCBwcm92aWRlIGEgd3JpdGUgbWV0aG9kIGluIGNhc2UgdGhlIHZhbHVlCgkgICAgICAgICAgICAgICAgICAgIC8vIGlzbid0IGEgd3JpdGFibGUgb2JzZXJ2YWJsZS4KCSAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3MucHVzaCgiJyIgKyBrZXkgKyAiJzpmdW5jdGlvbihfeil7IiArIHdyaXRhYmxlVmFsICsgIj1fen0iKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICAvLyBWYWx1ZXMgYXJlIHdyYXBwZWQgaW4gYSBmdW5jdGlvbiBzbyB0aGF0IGVhY2ggdmFsdWUgY2FuIGJlIGFjY2Vzc2VkIGluZGVwZW5kZW50bHkKCSAgICAgICAgICAgIGlmIChtYWtlVmFsdWVBY2Nlc3NvcnMpIHsKCSAgICAgICAgICAgICAgICB2YWwgPSAnZnVuY3Rpb24oKXtyZXR1cm4gJyArIHZhbCArICcgfSc7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXN1bHRTdHJpbmdzLnB1c2goIiciICsga2V5ICsgIic6IiArIHZhbCk7CgkgICAgICAgIH0KCgkgICAgICAgIHZhciByZXN1bHRTdHJpbmdzID0gW10sCgkgICAgICAgICAgICBwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncyA9IFtdLAoJICAgICAgICAgICAgbWFrZVZhbHVlQWNjZXNzb3JzID0gYmluZGluZ09wdGlvbnNbJ3ZhbHVlQWNjZXNzb3JzJ10sCgkgICAgICAgICAgICBiaW5kaW5nUGFyYW1zID0gYmluZGluZ09wdGlvbnNbJ2JpbmRpbmdQYXJhbXMnXSwKCSAgICAgICAgICAgIGtleVZhbHVlQXJyYXkgPSB0eXBlb2YgYmluZGluZ3NTdHJpbmdPcktleVZhbHVlQXJyYXkgPT09ICJzdHJpbmciID8KCSAgICAgICAgICAgICAgICBwYXJzZU9iamVjdExpdGVyYWwoYmluZGluZ3NTdHJpbmdPcktleVZhbHVlQXJyYXkpIDogYmluZGluZ3NTdHJpbmdPcktleVZhbHVlQXJyYXk7CgoJICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goa2V5VmFsdWVBcnJheSwgZnVuY3Rpb24oa2V5VmFsdWUpIHsKCSAgICAgICAgICAgIHByb2Nlc3NLZXlWYWx1ZShrZXlWYWx1ZS5rZXkgfHwga2V5VmFsdWVbJ3Vua25vd24nXSwga2V5VmFsdWUudmFsdWUpOwoJICAgICAgICB9KTsKCgkgICAgICAgIGlmIChwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncy5sZW5ndGgpCgkgICAgICAgICAgICBwcm9jZXNzS2V5VmFsdWUoJ19rb19wcm9wZXJ0eV93cml0ZXJzJywgInsiICsgcHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3Muam9pbigiLCIpICsgIiB9Iik7CgoJICAgICAgICByZXR1cm4gcmVzdWx0U3RyaW5ncy5qb2luKCIsIik7CgkgICAgfQoKCSAgICByZXR1cm4gewoJICAgICAgICBiaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnM6IFtdLAoKCSAgICAgICAgdHdvV2F5QmluZGluZ3M6IHR3b1dheUJpbmRpbmdzLAoKCSAgICAgICAgcGFyc2VPYmplY3RMaXRlcmFsOiBwYXJzZU9iamVjdExpdGVyYWwsCgoJICAgICAgICBwcmVQcm9jZXNzQmluZGluZ3M6IHByZVByb2Nlc3NCaW5kaW5ncywKCgkgICAgICAgIGtleVZhbHVlQXJyYXlDb250YWluc0tleTogZnVuY3Rpb24oa2V5VmFsdWVBcnJheSwga2V5KSB7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleVZhbHVlQXJyYXkubGVuZ3RoOyBpKyspCgkgICAgICAgICAgICAgICAgaWYgKGtleVZhbHVlQXJyYXlbaV1bJ2tleSddID09IGtleSkKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0sCgoJICAgICAgICAvLyBJbnRlcm5hbCwgcHJpdmF0ZSBLTyB1dGlsaXR5IGZvciB1cGRhdGluZyBtb2RlbCBwcm9wZXJ0aWVzIGZyb20gd2l0aGluIGJpbmRpbmdzCgkgICAgICAgIC8vIHByb3BlcnR5OiAgICAgICAgICAgIElmIHRoZSBwcm9wZXJ0eSBiZWluZyB1cGRhdGVkIGlzIChvciBtaWdodCBiZSkgYW4gb2JzZXJ2YWJsZSwgcGFzcyBpdCBoZXJlCgkgICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIElmIGl0IHR1cm5zIG91dCB0byBiZSBhIHdyaXRhYmxlIG9ic2VydmFibGUsIGl0IHdpbGwgYmUgd3JpdHRlbiB0byBkaXJlY3RseQoJICAgICAgICAvLyBhbGxCaW5kaW5nczogICAgICAgICBBbiBvYmplY3Qgd2l0aCBhIGdldCBtZXRob2QgdG8gcmV0cmlldmUgYmluZGluZ3MgaW4gdGhlIGN1cnJlbnQgZXhlY3V0aW9uIGNvbnRleHQuCgkgICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIFRoaXMgd2lsbCBiZSBzZWFyY2hlZCBmb3IgYSAnX2tvX3Byb3BlcnR5X3dyaXRlcnMnIHByb3BlcnR5IGluIGNhc2UgeW91J3JlIHdyaXRpbmcgdG8gYSBub24tb2JzZXJ2YWJsZQoJICAgICAgICAvLyBrZXk6ICAgICAgICAgICAgICAgICBUaGUga2V5IGlkZW50aWZ5aW5nIHRoZSBwcm9wZXJ0eSB0byBiZSB3cml0dGVuLiBFeGFtcGxlOiBmb3IgeyBoYXNGb2N1czogbXlWYWx1ZSB9LCB3cml0ZSB0byAnbXlWYWx1ZScgYnkgc3BlY2lmeWluZyB0aGUga2V5ICdoYXNGb2N1cycKCSAgICAgICAgLy8gdmFsdWU6ICAgICAgICAgICAgICAgVGhlIHZhbHVlIHRvIGJlIHdyaXR0ZW4KCSAgICAgICAgLy8gY2hlY2tJZkRpZmZlcmVudDogICAgSWYgdHJ1ZSwgYW5kIGlmIHRoZSBwcm9wZXJ0eSBiZWluZyB3cml0dGVuIGlzIGEgd3JpdGFibGUgb2JzZXJ2YWJsZSwgdGhlIHZhbHVlIHdpbGwgb25seSBiZSB3cml0dGVuIGlmCgkgICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIGl0IGlzICE9PSBleGlzdGluZyB2YWx1ZSBvbiB0aGF0IHdyaXRhYmxlIG9ic2VydmFibGUKCSAgICAgICAgd3JpdGVWYWx1ZVRvUHJvcGVydHk6IGZ1bmN0aW9uKHByb3BlcnR5LCBhbGxCaW5kaW5ncywga2V5LCB2YWx1ZSwgY2hlY2tJZkRpZmZlcmVudCkgewoJICAgICAgICAgICAgaWYgKCFwcm9wZXJ0eSB8fCAha28uaXNPYnNlcnZhYmxlKHByb3BlcnR5KSkgewoJICAgICAgICAgICAgICAgIHZhciBwcm9wV3JpdGVycyA9IGFsbEJpbmRpbmdzLmdldCgnX2tvX3Byb3BlcnR5X3dyaXRlcnMnKTsKCSAgICAgICAgICAgICAgICBpZiAocHJvcFdyaXRlcnMgJiYgcHJvcFdyaXRlcnNba2V5XSkKCSAgICAgICAgICAgICAgICAgICAgcHJvcFdyaXRlcnNba2V5XSh2YWx1ZSk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKGtvLmlzV3JpdGVhYmxlT2JzZXJ2YWJsZShwcm9wZXJ0eSkgJiYgKCFjaGVja0lmRGlmZmVyZW50IHx8IHByb3BlcnR5LnBlZWsoKSAhPT0gdmFsdWUpKSB7CgkgICAgICAgICAgICAgICAgcHJvcGVydHkodmFsdWUpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfTsKCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCdleHByZXNzaW9uUmV3cml0aW5nJywga28uZXhwcmVzc2lvblJld3JpdGluZyk7Cglrby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzJywga28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnMpOwoJa28uZXhwb3J0U3ltYm9sKCdleHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbCcsIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsKTsKCWtvLmV4cG9ydFN5bWJvbCgnZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MnLCBrby5leHByZXNzaW9uUmV3cml0aW5nLnByZVByb2Nlc3NCaW5kaW5ncyk7CgoJLy8gTWFraW5nIGJpbmRpbmdzIGV4cGxpY2l0bHkgZGVjbGFyZSB0aGVtc2VsdmVzIGFzICJ0d28gd2F5IiBpc24ndCBpZGVhbCBpbiB0aGUgbG9uZyB0ZXJtIChpdCB3b3VsZCBiZSBiZXR0ZXIgaWYKCS8vIGFsbCBiaW5kaW5ncyBjb3VsZCB1c2UgYW4gb2ZmaWNpYWwgJ3Byb3BlcnR5IHdyaXRlcicgQVBJIHdpdGhvdXQgbmVlZGluZyB0byBkZWNsYXJlIHRoYXQgdGhleSBtaWdodCkuIEhvd2V2ZXIsCgkvLyBzaW5jZSB0aGlzIGlzIG5vdCwgYW5kIGhhcyBuZXZlciBiZWVuLCBhIHB1YmxpYyBBUEkgKF9rb19wcm9wZXJ0eV93cml0ZXJzIHdhcyBuZXZlciBkb2N1bWVudGVkKSwgaXQncyBhY2NlcHRhYmxlCgkvLyBhcyBhbiBpbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBkZXRhaWwgaW4gdGhlIHNob3J0IHRlcm0uCgkvLyBGb3IgdGhvc2UgZGV2ZWxvcGVycyB3aG8gcmVseSBvbiBfa29fcHJvcGVydHlfd3JpdGVycyBpbiB0aGVpciBjdXN0b20gYmluZGluZ3MsIHdlIGV4cG9zZSBfdHdvV2F5QmluZGluZ3MgYXMgYW4KCS8vIHVuZG9jdW1lbnRlZCBmZWF0dXJlIHRoYXQgbWFrZXMgaXQgcmVsYXRpdmVseSBlYXN5IHRvIHVwZ3JhZGUgdG8gS08gMy4wLiBIb3dldmVyLCB0aGlzIGlzIHN0aWxsIG5vdCBhbiBvZmZpY2lhbAoJLy8gcHVibGljIEFQSSwgYW5kIHdlIHJlc2VydmUgdGhlIHJpZ2h0IHRvIHJlbW92ZSBpdCBhdCBhbnkgdGltZSBpZiB3ZSBjcmVhdGUgYSByZWFsIHB1YmxpYyBwcm9wZXJ0eSB3cml0ZXJzIEFQSS4KCWtvLmV4cG9ydFN5bWJvbCgnZXhwcmVzc2lvblJld3JpdGluZy5fdHdvV2F5QmluZGluZ3MnLCBrby5leHByZXNzaW9uUmV3cml0aW5nLnR3b1dheUJpbmRpbmdzKTsKCgkvLyBGb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgZGVmaW5lIHRoZSBmb2xsb3dpbmcgYWxpYXNlcy4gKFByZXZpb3VzbHksIHRoZXNlIGZ1bmN0aW9uIG5hbWVzIHdlcmUgbWlzbGVhZGluZyBiZWNhdXNlCgkvLyB0aGV5IHJlZmVycmVkIHRvIEpTT04gc3BlY2lmaWNhbGx5LCBldmVuIHRob3VnaCB0aGV5IGFjdHVhbGx5IHdvcmsgd2l0aCBhcmJpdHJhcnkgSmF2YVNjcmlwdCBvYmplY3QgbGl0ZXJhbCBleHByZXNzaW9ucy4pCglrby5leHBvcnRTeW1ib2woJ2pzb25FeHByZXNzaW9uUmV3cml0aW5nJywga28uZXhwcmVzc2lvblJld3JpdGluZyk7Cglrby5leHBvcnRTeW1ib2woJ2pzb25FeHByZXNzaW9uUmV3cml0aW5nLmluc2VydFByb3BlcnR5QWNjZXNzb3JzSW50b0pzb24nLCBrby5leHByZXNzaW9uUmV3cml0aW5nLnByZVByb2Nlc3NCaW5kaW5ncyk7CgkoZnVuY3Rpb24oKSB7CgkgICAgLy8gIlZpcnR1YWwgZWxlbWVudHMiIGlzIGFuIGFic3RyYWN0aW9uIG9uIHRvcCBvZiB0aGUgdXN1YWwgRE9NIEFQSSB3aGljaCB1bmRlcnN0YW5kcyB0aGUgbm90aW9uIHRoYXQgY29tbWVudCBub2RlcwoJICAgIC8vIG1heSBiZSB1c2VkIHRvIHJlcHJlc2VudCBoaWVyYXJjaHkgKGluIGFkZGl0aW9uIHRvIHRoZSBET00ncyBuYXR1cmFsIGhpZXJhcmNoeSkuCgkgICAgLy8gSWYgeW91IGNhbGwgdGhlIERPTS1tYW5pcHVsYXRpbmcgZnVuY3Rpb25zIG9uIGtvLnZpcnR1YWxFbGVtZW50cywgeW91IHdpbGwgYmUgYWJsZSB0byByZWFkIGFuZCB3cml0ZSB0aGUgc3RhdGUKCSAgICAvLyBvZiB0aGF0IHZpcnR1YWwgaGllcmFyY2h5CgkgICAgLy8KCSAgICAvLyBUaGUgcG9pbnQgb2YgYWxsIHRoaXMgaXMgdG8gc3VwcG9ydCBjb250YWluZXJsZXNzIHRlbXBsYXRlcyAoZS5nLiwgPCEtLSBrbyBmb3JlYWNoOnNvbWVDb2xsZWN0aW9uIC0tPmJsYWg8IS0tIC9rbyAtLT4pCgkgICAgLy8gd2l0aG91dCBoYXZpbmcgdG8gc2NhdHRlciBzcGVjaWFsIGNhc2VzIGFsbCBvdmVyIHRoZSBiaW5kaW5nIGFuZCB0ZW1wbGF0aW5nIGNvZGUuCgoJICAgIC8vIElFIDkgY2Fubm90IHJlbGlhYmx5IHJlYWQgdGhlICJub2RlVmFsdWUiIHByb3BlcnR5IG9mIGEgY29tbWVudCBub2RlIChzZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8xODYpCgkgICAgLy8gYnV0IGl0IGRvZXMgZ2l2ZSB0aGVtIGEgbm9uc3RhbmRhcmQgYWx0ZXJuYXRpdmUgcHJvcGVydHkgY2FsbGVkICJ0ZXh0IiB0aGF0IGl0IGNhbiByZWFkIHJlbGlhYmx5LiBPdGhlciBicm93c2VycyBkb24ndCBoYXZlIHRoYXQgcHJvcGVydHkuCgkgICAgLy8gU28sIHVzZSBub2RlLnRleHQgd2hlcmUgYXZhaWxhYmxlLCBhbmQgbm9kZS5ub2RlVmFsdWUgZWxzZXdoZXJlCgkgICAgdmFyIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPSBkb2N1bWVudCAmJiBkb2N1bWVudC5jcmVhdGVDb21tZW50KCJ0ZXN0IikudGV4dCA9PT0gIjwhLS10ZXN0LS0+IjsKCgkgICAgdmFyIHN0YXJ0Q29tbWVudFJlZ2V4ID0gY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IC9ePCEtLVxzKmtvKD86XHMrKFtcc1xTXSspKT9ccyotLT4kLyA6IC9eXHMqa28oPzpccysoW1xzXFNdKykpP1xzKiQvOwoJICAgIHZhciBlbmRDb21tZW50UmVnZXggPSAgIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyAvXjwhLS1ccypcL2tvXHMqLS0+JC8gOiAvXlxzKlwva29ccyokLzsKCSAgICB2YXIgaHRtbFRhZ3NXaXRoT3B0aW9uYWxseUNsb3NpbmdDaGlsZHJlbiA9IHsgJ3VsJzogdHJ1ZSwgJ29sJzogdHJ1ZSB9OwoKCSAgICBmdW5jdGlvbiBpc1N0YXJ0Q29tbWVudChub2RlKSB7CgkgICAgICAgIHJldHVybiAobm9kZS5ub2RlVHlwZSA9PSA4KSAmJiBzdGFydENvbW1lbnRSZWdleC50ZXN0KGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyBub2RlLnRleHQgOiBub2RlLm5vZGVWYWx1ZSk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBpc0VuZENvbW1lbnQobm9kZSkgewoJICAgICAgICByZXR1cm4gKG5vZGUubm9kZVR5cGUgPT0gOCkgJiYgZW5kQ29tbWVudFJlZ2V4LnRlc3QoY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IG5vZGUudGV4dCA6IG5vZGUubm9kZVZhbHVlKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGdldFZpcnR1YWxDaGlsZHJlbihzdGFydENvbW1lbnQsIGFsbG93VW5iYWxhbmNlZCkgewoJICAgICAgICB2YXIgY3VycmVudE5vZGUgPSBzdGFydENvbW1lbnQ7CgkgICAgICAgIHZhciBkZXB0aCA9IDE7CgkgICAgICAgIHZhciBjaGlsZHJlbiA9IFtdOwoJICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5uZXh0U2libGluZykgewoJICAgICAgICAgICAgaWYgKGlzRW5kQ29tbWVudChjdXJyZW50Tm9kZSkpIHsKCSAgICAgICAgICAgICAgICBkZXB0aC0tOwoJICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goY3VycmVudE5vZGUpOwoKCSAgICAgICAgICAgIGlmIChpc1N0YXJ0Q29tbWVudChjdXJyZW50Tm9kZSkpCgkgICAgICAgICAgICAgICAgZGVwdGgrKzsKCSAgICAgICAgfQoJICAgICAgICBpZiAoIWFsbG93VW5iYWxhbmNlZCkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgY2xvc2luZyBjb21tZW50IHRhZyB0byBtYXRjaDogIiArIHN0YXJ0Q29tbWVudC5ub2RlVmFsdWUpOwoJICAgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGdldE1hdGNoaW5nRW5kQ29tbWVudChzdGFydENvbW1lbnQsIGFsbG93VW5iYWxhbmNlZCkgewoJICAgICAgICB2YXIgYWxsVmlydHVhbENoaWxkcmVuID0gZ2V0VmlydHVhbENoaWxkcmVuKHN0YXJ0Q29tbWVudCwgYWxsb3dVbmJhbGFuY2VkKTsKCSAgICAgICAgaWYgKGFsbFZpcnR1YWxDaGlsZHJlbikgewoJICAgICAgICAgICAgaWYgKGFsbFZpcnR1YWxDaGlsZHJlbi5sZW5ndGggPiAwKQoJICAgICAgICAgICAgICAgIHJldHVybiBhbGxWaXJ0dWFsQ2hpbGRyZW5bYWxsVmlydHVhbENoaWxkcmVuLmxlbmd0aCAtIDFdLm5leHRTaWJsaW5nOwoJICAgICAgICAgICAgcmV0dXJuIHN0YXJ0Q29tbWVudC5uZXh0U2libGluZzsKCSAgICAgICAgfSBlbHNlCgkgICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gTXVzdCBoYXZlIG5vIG1hdGNoaW5nIGVuZCBjb21tZW50LCBhbmQgYWxsb3dVbmJhbGFuY2VkIGlzIHRydWUKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGdldFVuYmFsYW5jZWRDaGlsZFRhZ3Mobm9kZSkgewoJICAgICAgICAvLyBlLmcuLCBmcm9tIDxkaXY+T0s8L2Rpdj48IS0tIGtvIGJsYWggLS0+PHNwYW4+QW5vdGhlcjwvc3Bhbj4sIHJldHVybnM6IDwhLS0ga28gYmxhaCAtLT48c3Bhbj5Bbm90aGVyPC9zcGFuPgoJICAgICAgICAvLyAgICAgICBmcm9tIDxkaXY+T0s8L2Rpdj48IS0tIC9rbyAtLT48IS0tIC9rbyAtLT4sICAgICAgICAgICAgIHJldHVybnM6IDwhLS0gL2tvIC0tPjwhLS0gL2tvIC0tPgoJICAgICAgICB2YXIgY2hpbGROb2RlID0gbm9kZS5maXJzdENoaWxkLCBjYXB0dXJlUmVtYWluaW5nID0gbnVsbDsKCSAgICAgICAgaWYgKGNoaWxkTm9kZSkgewoJICAgICAgICAgICAgZG8gewoJICAgICAgICAgICAgICAgIGlmIChjYXB0dXJlUmVtYWluaW5nKSAgICAgICAgICAgICAgICAgICAvLyBXZSBhbHJlYWR5IGhpdCBhbiB1bmJhbGFuY2VkIG5vZGUgYW5kIGFyZSBub3cganVzdCBzY29vcGluZyB1cCBhbGwgc3Vic2VxdWVudCBub2RlcwoJICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nLnB1c2goY2hpbGROb2RlKTsKCSAgICAgICAgICAgICAgICBlbHNlIGlmIChpc1N0YXJ0Q29tbWVudChjaGlsZE5vZGUpKSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaGluZ0VuZENvbW1lbnQgPSBnZXRNYXRjaGluZ0VuZENvbW1lbnQoY2hpbGROb2RlLCAvKiBhbGxvd1VuYmFsYW5jZWQ6ICovIHRydWUpOwoJICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hpbmdFbmRDb21tZW50KSAgICAgICAgICAgICAvLyBJdCdzIGEgYmFsYW5jZWQgdGFnLCBzbyBza2lwIGltbWVkaWF0ZWx5IHRvIHRoZSBlbmQgb2YgdGhpcyB2aXJ0dWFsIHNldAoJICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlID0gbWF0Y2hpbmdFbmRDb21tZW50OwoJICAgICAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nID0gW2NoaWxkTm9kZV07IC8vIEl0J3MgdW5iYWxhbmNlZCwgc28gc3RhcnQgY2FwdHVyaW5nIGZyb20gdGhpcyBwb2ludAoJICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFbmRDb21tZW50KGNoaWxkTm9kZSkpIHsKCSAgICAgICAgICAgICAgICAgICAgY2FwdHVyZVJlbWFpbmluZyA9IFtjaGlsZE5vZGVdOyAgICAgLy8gSXQncyB1bmJhbGFuY2VkIChpZiBpdCB3YXNuJ3QsIHdlJ2QgaGF2ZSBza2lwcGVkIG92ZXIgaXQgYWxyZWFkeSksIHNvIHN0YXJ0IGNhcHR1cmluZwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gd2hpbGUgKGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5uZXh0U2libGluZyk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIGNhcHR1cmVSZW1haW5pbmc7CgkgICAgfQoKCSAgICBrby52aXJ0dWFsRWxlbWVudHMgPSB7CgkgICAgICAgIGFsbG93ZWRCaW5kaW5nczoge30sCgoJICAgICAgICBjaGlsZE5vZGVzOiBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICByZXR1cm4gaXNTdGFydENvbW1lbnQobm9kZSkgPyBnZXRWaXJ0dWFsQ2hpbGRyZW4obm9kZSkgOiBub2RlLmNoaWxkTm9kZXM7CgkgICAgICAgIH0sCgoJICAgICAgICBlbXB0eU5vZGU6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIGlmICghaXNTdGFydENvbW1lbnQobm9kZSkpCgkgICAgICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKG5vZGUpOwoJICAgICAgICAgICAgZWxzZSB7CgkgICAgICAgICAgICAgICAgdmFyIHZpcnR1YWxDaGlsZHJlbiA9IGtvLnZpcnR1YWxFbGVtZW50cy5jaGlsZE5vZGVzKG5vZGUpOwoJICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmlydHVhbENoaWxkcmVuLmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICAgICAga28ucmVtb3ZlTm9kZSh2aXJ0dWFsQ2hpbGRyZW5baV0pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgc2V0RG9tTm9kZUNoaWxkcmVuOiBmdW5jdGlvbihub2RlLCBjaGlsZE5vZGVzKSB7CgkgICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KG5vZGUpKQoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbihub2RlLCBjaGlsZE5vZGVzKTsKCSAgICAgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5lbXB0eU5vZGUobm9kZSk7CgkgICAgICAgICAgICAgICAgdmFyIGVuZENvbW1lbnROb2RlID0gbm9kZS5uZXh0U2libGluZzsgLy8gTXVzdCBiZSB0aGUgbmV4dCBzaWJsaW5nLCBhcyB3ZSBqdXN0IGVtcHRpZWQgdGhlIGNoaWxkcmVuCgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBjaGlsZE5vZGVzLmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICAgICAgZW5kQ29tbWVudE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGROb2Rlc1tpXSwgZW5kQ29tbWVudE5vZGUpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgcHJlcGVuZDogZnVuY3Rpb24oY29udGFpbmVyTm9kZSwgbm9kZVRvUHJlcGVuZCkgewoJICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChjb250YWluZXJOb2RlKSkgewoJICAgICAgICAgICAgICAgIGlmIChjb250YWluZXJOb2RlLmZpcnN0Q2hpbGQpCgkgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuaW5zZXJ0QmVmb3JlKG5vZGVUb1ByZXBlbmQsIGNvbnRhaW5lck5vZGUuZmlyc3RDaGlsZCk7CgkgICAgICAgICAgICAgICAgZWxzZQoJICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmFwcGVuZENoaWxkKG5vZGVUb1ByZXBlbmQpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAvLyBTdGFydCBjb21tZW50cyBtdXN0IGFsd2F5cyBoYXZlIGEgcGFyZW50IGFuZCBhdCBsZWFzdCBvbmUgZm9sbG93aW5nIHNpYmxpbmcgKHRoZSBlbmQgY29tbWVudCkKCSAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5vZGVUb1ByZXBlbmQsIGNvbnRhaW5lck5vZGUubmV4dFNpYmxpbmcpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgaW5zZXJ0QWZ0ZXI6IGZ1bmN0aW9uKGNvbnRhaW5lck5vZGUsIG5vZGVUb0luc2VydCwgaW5zZXJ0QWZ0ZXJOb2RlKSB7CgkgICAgICAgICAgICBpZiAoIWluc2VydEFmdGVyTm9kZSkgewoJICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5wcmVwZW5kKGNvbnRhaW5lck5vZGUsIG5vZGVUb0luc2VydCk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc1N0YXJ0Q29tbWVudChjb250YWluZXJOb2RlKSkgewoJICAgICAgICAgICAgICAgIC8vIEluc2VydCBhZnRlciBpbnNlcnRpb24gcG9pbnQKCSAgICAgICAgICAgICAgICBpZiAoaW5zZXJ0QWZ0ZXJOb2RlLm5leHRTaWJsaW5nKQoJICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmluc2VydEJlZm9yZShub2RlVG9JbnNlcnQsIGluc2VydEFmdGVyTm9kZS5uZXh0U2libGluZyk7CgkgICAgICAgICAgICAgICAgZWxzZQoJICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmFwcGVuZENoaWxkKG5vZGVUb0luc2VydCk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIENoaWxkcmVuIG9mIHN0YXJ0IGNvbW1lbnRzIG11c3QgYWx3YXlzIGhhdmUgYSBwYXJlbnQgYW5kIGF0IGxlYXN0IG9uZSBmb2xsb3dpbmcgc2libGluZyAodGhlIGVuZCBjb21tZW50KQoJICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUubmV4dFNpYmxpbmcpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgZmlyc3RDaGlsZDogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChub2RlKSkKCSAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5maXJzdENoaWxkOwoJICAgICAgICAgICAgaWYgKCFub2RlLm5leHRTaWJsaW5nIHx8IGlzRW5kQ29tbWVudChub2RlLm5leHRTaWJsaW5nKSkKCSAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKCSAgICAgICAgICAgIHJldHVybiBub2RlLm5leHRTaWJsaW5nOwoJICAgICAgICB9LAoKCSAgICAgICAgbmV4dFNpYmxpbmc6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIGlmIChpc1N0YXJ0Q29tbWVudChub2RlKSkKCSAgICAgICAgICAgICAgICBub2RlID0gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KG5vZGUpOwoJICAgICAgICAgICAgaWYgKG5vZGUubmV4dFNpYmxpbmcgJiYgaXNFbmRDb21tZW50KG5vZGUubmV4dFNpYmxpbmcpKQoJICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwoJICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CgkgICAgICAgIH0sCgoJICAgICAgICBoYXNCaW5kaW5nVmFsdWU6IGlzU3RhcnRDb21tZW50LAoKCSAgICAgICAgdmlydHVhbE5vZGVCaW5kaW5nVmFsdWU6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIHZhciByZWdleE1hdGNoID0gKGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyBub2RlLnRleHQgOiBub2RlLm5vZGVWYWx1ZSkubWF0Y2goc3RhcnRDb21tZW50UmVnZXgpOwoJICAgICAgICAgICAgcmV0dXJuIHJlZ2V4TWF0Y2ggPyByZWdleE1hdGNoWzFdIDogbnVsbDsKCSAgICAgICAgfSwKCgkgICAgICAgIG5vcm1hbGlzZVZpcnR1YWxFbGVtZW50RG9tU3RydWN0dXJlOiBmdW5jdGlvbihlbGVtZW50VmVyaWZpZWQpIHsKCSAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTU1CgkgICAgICAgICAgICAvLyAoSUUgPD0gOCBvciBJRSA5IHF1aXJrcyBtb2RlIHBhcnNlcyB5b3VyIEhUTUwgd2VpcmRseSwgdHJlYXRpbmcgY2xvc2luZyA8L2xpPiB0YWdzIGFzIGlmIHRoZXkgZG9uJ3QgZXhpc3QsIHRoZXJlYnkgbW92aW5nIGNvbW1lbnQgbm9kZXMKCSAgICAgICAgICAgIC8vIHRoYXQgYXJlIGRpcmVjdCBkZXNjZW5kYW50cyBvZiA8dWw+IGludG8gdGhlIHByZWNlZGluZyA8bGk+KQoJICAgICAgICAgICAgaWYgKCFodG1sVGFnc1dpdGhPcHRpb25hbGx5Q2xvc2luZ0NoaWxkcmVuW2tvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50VmVyaWZpZWQpXSkKCSAgICAgICAgICAgICAgICByZXR1cm47CgoJICAgICAgICAgICAgLy8gU2NhbiBpbW1lZGlhdGUgY2hpbGRyZW4gdG8gc2VlIGlmIHRoZXkgY29udGFpbiB1bmJhbGFuY2VkIGNvbW1lbnQgdGFncy4gSWYgdGhleSBkbywgdGhvc2UgY29tbWVudCB0YWdzCgkgICAgICAgICAgICAvLyBtdXN0IGJlIGludGVuZGVkIHRvIGFwcGVhciAqYWZ0ZXIqIHRoYXQgY2hpbGQsIHNvIG1vdmUgdGhlbSB0aGVyZS4KCSAgICAgICAgICAgIHZhciBjaGlsZE5vZGUgPSBlbGVtZW50VmVyaWZpZWQuZmlyc3RDaGlsZDsKCSAgICAgICAgICAgIGlmIChjaGlsZE5vZGUpIHsKCSAgICAgICAgICAgICAgICBkbyB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZE5vZGUubm9kZVR5cGUgPT09IDEpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1bmJhbGFuY2VkVGFncyA9IGdldFVuYmFsYW5jZWRDaGlsZFRhZ3MoY2hpbGROb2RlKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmJhbGFuY2VkVGFncykgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpeCB1cCB0aGUgRE9NIGJ5IG1vdmluZyB0aGUgdW5iYWxhbmNlZCB0YWdzIHRvIHdoZXJlIHRoZXkgbW9zdCBsaWtlbHkgd2VyZSBpbnRlbmRlZCB0byBiZSBwbGFjZWQgLSAqYWZ0ZXIqIHRoZSBjaGlsZAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlVG9JbnNlcnRCZWZvcmUgPSBjaGlsZE5vZGUubmV4dFNpYmxpbmc7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1bmJhbGFuY2VkVGFncy5sZW5ndGg7IGkrKykgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZVRvSW5zZXJ0QmVmb3JlKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFZlcmlmaWVkLmluc2VydEJlZm9yZSh1bmJhbGFuY2VkVGFnc1tpXSwgbm9kZVRvSW5zZXJ0QmVmb3JlKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFZlcmlmaWVkLmFwcGVuZENoaWxkKHVuYmFsYW5jZWRUYWdzW2ldKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9IHdoaWxlIChjaGlsZE5vZGUgPSBjaGlsZE5vZGUubmV4dFNpYmxpbmcpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfTsKCX0pKCk7Cglrby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cycsIGtvLnZpcnR1YWxFbGVtZW50cyk7Cglrby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3MnLCBrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzKTsKCWtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZScsIGtvLnZpcnR1YWxFbGVtZW50cy5lbXB0eU5vZGUpOwoJLy9rby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5maXJzdENoaWxkJywga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQpOyAgICAgLy8gZmlyc3RDaGlsZCBpcyBub3QgbWluaWZpZWQKCWtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmluc2VydEFmdGVyJywga28udmlydHVhbEVsZW1lbnRzLmluc2VydEFmdGVyKTsKCS8va28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcnLCBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcpOyAgIC8vIG5leHRTaWJsaW5nIGlzIG5vdCBtaW5pZmllZAoJa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMucHJlcGVuZCcsIGtvLnZpcnR1YWxFbGVtZW50cy5wcmVwZW5kKTsKCWtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbicsIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4pOwoJKGZ1bmN0aW9uKCkgewoJICAgIHZhciBkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUgPSAiZGF0YS1iaW5kIjsKCgkgICAga28uYmluZGluZ1Byb3ZpZGVyID0gZnVuY3Rpb24oKSB7CgkgICAgICAgIHRoaXMuYmluZGluZ0NhY2hlID0ge307CgkgICAgfTsKCgkgICAga28udXRpbHMuZXh0ZW5kKGtvLmJpbmRpbmdQcm92aWRlci5wcm90b3R5cGUsIHsKCSAgICAgICAgJ25vZGVIYXNCaW5kaW5ncyc6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIHN3aXRjaCAobm9kZS5ub2RlVHlwZSkgewoJICAgICAgICAgICAgICAgIGNhc2UgMTogLy8gRWxlbWVudAoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5nZXRBdHRyaWJ1dGUoZGVmYXVsdEJpbmRpbmdBdHRyaWJ1dGVOYW1lKSAhPSBudWxsCgkgICAgICAgICAgICAgICAgICAgICAgICB8fCBrby5jb21wb25lbnRzWydnZXRDb21wb25lbnROYW1lRm9yTm9kZSddKG5vZGUpOwoJICAgICAgICAgICAgICAgIGNhc2UgODogLy8gQ29tbWVudCBub2RlCgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBrby52aXJ0dWFsRWxlbWVudHMuaGFzQmluZGluZ1ZhbHVlKG5vZGUpOwoJICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBmYWxzZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgICdnZXRCaW5kaW5ncyc6IGZ1bmN0aW9uKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgICAgICB2YXIgYmluZGluZ3NTdHJpbmcgPSB0aGlzWydnZXRCaW5kaW5nc1N0cmluZyddKG5vZGUsIGJpbmRpbmdDb250ZXh0KSwKCSAgICAgICAgICAgICAgICBwYXJzZWRCaW5kaW5ncyA9IGJpbmRpbmdzU3RyaW5nID8gdGhpc1sncGFyc2VCaW5kaW5nc1N0cmluZyddKGJpbmRpbmdzU3RyaW5nLCBiaW5kaW5nQ29udGV4dCwgbm9kZSkgOiBudWxsOwoJICAgICAgICAgICAgcmV0dXJuIGtvLmNvbXBvbmVudHMuYWRkQmluZGluZ3NGb3JDdXN0b21FbGVtZW50KHBhcnNlZEJpbmRpbmdzLCBub2RlLCBiaW5kaW5nQ29udGV4dCwgLyogdmFsdWVBY2Nlc3NvcnMgKi8gZmFsc2UpOwoJICAgICAgICB9LAoKCSAgICAgICAgJ2dldEJpbmRpbmdBY2Nlc3NvcnMnOiBmdW5jdGlvbihub2RlLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAgICAgdmFyIGJpbmRpbmdzU3RyaW5nID0gdGhpc1snZ2V0QmluZGluZ3NTdHJpbmcnXShub2RlLCBiaW5kaW5nQ29udGV4dCksCgkgICAgICAgICAgICAgICAgcGFyc2VkQmluZGluZ3MgPSBiaW5kaW5nc1N0cmluZyA/IHRoaXNbJ3BhcnNlQmluZGluZ3NTdHJpbmcnXShiaW5kaW5nc1N0cmluZywgYmluZGluZ0NvbnRleHQsIG5vZGUsIHsgJ3ZhbHVlQWNjZXNzb3JzJzogdHJ1ZSB9KSA6IG51bGw7CgkgICAgICAgICAgICByZXR1cm4ga28uY29tcG9uZW50cy5hZGRCaW5kaW5nc0ZvckN1c3RvbUVsZW1lbnQocGFyc2VkQmluZGluZ3MsIG5vZGUsIGJpbmRpbmdDb250ZXh0LCAvKiB2YWx1ZUFjY2Vzc29ycyAqLyB0cnVlKTsKCSAgICAgICAgfSwKCgkgICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gaXMgb25seSB1c2VkIGludGVybmFsbHkgYnkgdGhpcyBkZWZhdWx0IHByb3ZpZGVyLgoJICAgICAgICAvLyBJdCdzIG5vdCBwYXJ0IG9mIHRoZSBpbnRlcmZhY2UgZGVmaW5pdGlvbiBmb3IgYSBnZW5lcmFsIGJpbmRpbmcgcHJvdmlkZXIuCgkgICAgICAgICdnZXRCaW5kaW5nc1N0cmluZyc6IGZ1bmN0aW9uKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgICAgICBzd2l0Y2ggKG5vZGUubm9kZVR5cGUpIHsKCSAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUpOyAgIC8vIEVsZW1lbnQKCSAgICAgICAgICAgICAgICBjYXNlIDg6IHJldHVybiBrby52aXJ0dWFsRWxlbWVudHMudmlydHVhbE5vZGVCaW5kaW5nVmFsdWUobm9kZSk7IC8vIENvbW1lbnQgbm9kZQoJICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBudWxsOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBpcyBvbmx5IHVzZWQgaW50ZXJuYWxseSBieSB0aGlzIGRlZmF1bHQgcHJvdmlkZXIuCgkgICAgICAgIC8vIEl0J3Mgbm90IHBhcnQgb2YgdGhlIGludGVyZmFjZSBkZWZpbml0aW9uIGZvciBhIGdlbmVyYWwgYmluZGluZyBwcm92aWRlci4KCSAgICAgICAgJ3BhcnNlQmluZGluZ3NTdHJpbmcnOiBmdW5jdGlvbihiaW5kaW5nc1N0cmluZywgYmluZGluZ0NvbnRleHQsIG5vZGUsIG9wdGlvbnMpIHsKCSAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdGdW5jdGlvbiA9IGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yVmlhQ2FjaGUoYmluZGluZ3NTdHJpbmcsIHRoaXMuYmluZGluZ0NhY2hlLCBvcHRpb25zKTsKCSAgICAgICAgICAgICAgICByZXR1cm4gYmluZGluZ0Z1bmN0aW9uKGJpbmRpbmdDb250ZXh0LCBub2RlKTsKCSAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CgkgICAgICAgICAgICAgICAgZXgubWVzc2FnZSA9ICJVbmFibGUgdG8gcGFyc2UgYmluZGluZ3MuXG5CaW5kaW5ncyB2YWx1ZTogIiArIGJpbmRpbmdzU3RyaW5nICsgIlxuTWVzc2FnZTogIiArIGV4Lm1lc3NhZ2U7CgkgICAgICAgICAgICAgICAgdGhyb3cgZXg7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9KTsKCgkgICAga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddID0gbmV3IGtvLmJpbmRpbmdQcm92aWRlcigpOwoKCSAgICBmdW5jdGlvbiBjcmVhdGVCaW5kaW5nc1N0cmluZ0V2YWx1YXRvclZpYUNhY2hlKGJpbmRpbmdzU3RyaW5nLCBjYWNoZSwgb3B0aW9ucykgewoJICAgICAgICB2YXIgY2FjaGVLZXkgPSBiaW5kaW5nc1N0cmluZyArIChvcHRpb25zICYmIG9wdGlvbnNbJ3ZhbHVlQWNjZXNzb3JzJ10gfHwgJycpOwoJICAgICAgICByZXR1cm4gY2FjaGVbY2FjaGVLZXldCgkgICAgICAgICAgICB8fCAoY2FjaGVbY2FjaGVLZXldID0gY3JlYXRlQmluZGluZ3NTdHJpbmdFdmFsdWF0b3IoYmluZGluZ3NTdHJpbmcsIG9wdGlvbnMpKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yKGJpbmRpbmdzU3RyaW5nLCBvcHRpb25zKSB7CgkgICAgICAgIC8vIEJ1aWxkIHRoZSBzb3VyY2UgZm9yIGEgZnVuY3Rpb24gdGhhdCBldmFsdWF0ZXMgImV4cHJlc3Npb24iCgkgICAgICAgIC8vIEZvciBlYWNoIHNjb3BlIHZhcmlhYmxlLCBhZGQgYW4gZXh0cmEgbGV2ZWwgb2YgIndpdGgiIG5lc3RpbmcKCSAgICAgICAgLy8gRXhhbXBsZSByZXN1bHQ6IHdpdGgoc2MxKSB7IHdpdGgoc2MwKSB7IHJldHVybiAoZXhwcmVzc2lvbikgfSB9CgkgICAgICAgIHZhciByZXdyaXR0ZW5CaW5kaW5ncyA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucHJlUHJvY2Vzc0JpbmRpbmdzKGJpbmRpbmdzU3RyaW5nLCBvcHRpb25zKSwKCSAgICAgICAgICAgIGZ1bmN0aW9uQm9keSA9ICJ3aXRoKCRjb250ZXh0KXt3aXRoKCRkYXRhfHx7fSl7cmV0dXJueyIgKyByZXdyaXR0ZW5CaW5kaW5ncyArICJ9fX0iOwoJICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCIkY29udGV4dCIsICIkZWxlbWVudCIsIGZ1bmN0aW9uQm9keSk7CgkgICAgfQoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ2JpbmRpbmdQcm92aWRlcicsIGtvLmJpbmRpbmdQcm92aWRlcik7CgkoZnVuY3Rpb24gKCkgewoJICAgIGtvLmJpbmRpbmdIYW5kbGVycyA9IHt9OwoKCSAgICAvLyBUaGUgZm9sbG93aW5nIGVsZW1lbnQgdHlwZXMgd2lsbCBub3QgYmUgcmVjdXJzZWQgaW50byBkdXJpbmcgYmluZGluZy4gSW4gdGhlIGZ1dHVyZSwgd2UKCSAgICAvLyBtYXkgY29uc2lkZXIgYWRkaW5nIDx0ZW1wbGF0ZT4gdG8gdGhpcyBsaXN0LCBiZWNhdXNlIHN1Y2ggZWxlbWVudHMnIGNvbnRlbnRzIGFyZSBhbHdheXMKCSAgICAvLyBpbnRlbmRlZCB0byBiZSBib3VuZCBpbiBhIGRpZmZlcmVudCBjb250ZXh0IGZyb20gd2hlcmUgdGhleSBhcHBlYXIgaW4gdGhlIGRvY3VtZW50LgoJICAgIHZhciBiaW5kaW5nRG9lc05vdFJlY3Vyc2VJbnRvRWxlbWVudFR5cGVzID0gewoJICAgICAgICAvLyBEb24ndCB3YW50IGJpbmRpbmdzIHRoYXQgb3BlcmF0ZSBvbiB0ZXh0IG5vZGVzIHRvIG11dGF0ZSA8c2NyaXB0PiBjb250ZW50cywKCSAgICAgICAgLy8gYmVjYXVzZSBpdCdzIHVuZXhwZWN0ZWQgYW5kIGEgcG90ZW50aWFsIFhTUyBpc3N1ZQoJICAgICAgICAnc2NyaXB0JzogdHJ1ZQoJICAgIH07CgoJICAgIC8vIFVzZSBhbiBvdmVycmlkYWJsZSBtZXRob2QgZm9yIHJldHJpZXZpbmcgYmluZGluZyBoYW5kbGVycyBzbyB0aGF0IGEgcGx1Z2lucyBtYXkgc3VwcG9ydCBkeW5hbWljYWxseSBjcmVhdGVkIGhhbmRsZXJzCgkgICAga29bJ2dldEJpbmRpbmdIYW5kbGVyJ10gPSBmdW5jdGlvbihiaW5kaW5nS2V5KSB7CgkgICAgICAgIHJldHVybiBrby5iaW5kaW5nSGFuZGxlcnNbYmluZGluZ0tleV07CgkgICAgfTsKCgkgICAgLy8gVGhlIGtvLmJpbmRpbmdDb250ZXh0IGNvbnN0cnVjdG9yIGlzIG9ubHkgY2FsbGVkIGRpcmVjdGx5IHRvIGNyZWF0ZSB0aGUgcm9vdCBjb250ZXh0LiBGb3IgY2hpbGQKCSAgICAvLyBjb250ZXh0cywgdXNlIGJpbmRpbmdDb250ZXh0LmNyZWF0ZUNoaWxkQ29udGV4dCBvciBiaW5kaW5nQ29udGV4dC5leHRlbmQuCgkgICAga28uYmluZGluZ0NvbnRleHQgPSBmdW5jdGlvbihkYXRhSXRlbU9yQWNjZXNzb3IsIHBhcmVudENvbnRleHQsIGRhdGFJdGVtQWxpYXMsIGV4dGVuZENhbGxiYWNrKSB7CgoJICAgICAgICAvLyBUaGUgYmluZGluZyBjb250ZXh0IG9iamVjdCBpbmNsdWRlcyBzdGF0aWMgcHJvcGVydGllcyBmb3IgdGhlIGN1cnJlbnQsIHBhcmVudCwgYW5kIHJvb3QgdmlldyBtb2RlbHMuCgkgICAgICAgIC8vIElmIGEgdmlldyBtb2RlbCBpcyBhY3R1YWxseSBzdG9yZWQgaW4gYW4gb2JzZXJ2YWJsZSwgdGhlIGNvcnJlc3BvbmRpbmcgYmluZGluZyBjb250ZXh0IG9iamVjdCwgYW5kCgkgICAgICAgIC8vIGFueSBjaGlsZCBjb250ZXh0cywgbXVzdCBiZSB1cGRhdGVkIHdoZW4gdGhlIHZpZXcgbW9kZWwgaXMgY2hhbmdlZC4KCSAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGV4dCgpIHsKCSAgICAgICAgICAgIC8vIE1vc3Qgb2YgdGhlIHRpbWUsIHRoZSBjb250ZXh0IHdpbGwgZGlyZWN0bHkgZ2V0IGEgdmlldyBtb2RlbCBvYmplY3QsIGJ1dCBpZiBhIGZ1bmN0aW9uIGlzIGdpdmVuLAoJICAgICAgICAgICAgLy8gd2UgY2FsbCB0aGUgZnVuY3Rpb24gdG8gcmV0cmlldmUgdGhlIHZpZXcgbW9kZWwuIElmIHRoZSBmdW5jdGlvbiBhY2Nlc3NlcyBhbnkgb2JzZXZhYmxlcyBvciByZXR1cm5zCgkgICAgICAgICAgICAvLyBhbiBvYnNlcnZhYmxlLCB0aGUgZGVwZW5kZW5jeSBpcyB0cmFja2VkLCBhbmQgdGhvc2Ugb2JzZXJ2YWJsZXMgY2FuIGxhdGVyIGNhdXNlIHRoZSBiaW5kaW5nCgkgICAgICAgICAgICAvLyBjb250ZXh0IHRvIGJlIHVwZGF0ZWQuCgkgICAgICAgICAgICB2YXIgZGF0YUl0ZW1Pck9ic2VydmFibGUgPSBpc0Z1bmMgPyBkYXRhSXRlbU9yQWNjZXNzb3IoKSA6IGRhdGFJdGVtT3JBY2Nlc3NvciwKCSAgICAgICAgICAgICAgICBkYXRhSXRlbSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoZGF0YUl0ZW1Pck9ic2VydmFibGUpOwoKCSAgICAgICAgICAgIGlmIChwYXJlbnRDb250ZXh0KSB7CgkgICAgICAgICAgICAgICAgLy8gV2hlbiBhICJwYXJlbnQiIGNvbnRleHQgaXMgZ2l2ZW4sIHJlZ2lzdGVyIGEgZGVwZW5kZW5jeSBvbiB0aGUgcGFyZW50IGNvbnRleHQuIFRodXMgd2hlbmV2ZXIgdGhlCgkgICAgICAgICAgICAgICAgLy8gcGFyZW50IGNvbnRleHQgaXMgdXBkYXRlZCwgdGhpcyBjb250ZXh0IHdpbGwgYWxzbyBiZSB1cGRhdGVkLgoJICAgICAgICAgICAgICAgIGlmIChwYXJlbnRDb250ZXh0Ll9zdWJzY3JpYmFibGUpCgkgICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRleHQuX3N1YnNjcmliYWJsZSgpOwoKCSAgICAgICAgICAgICAgICAvLyBDb3B5ICRyb290IGFuZCBhbnkgY3VzdG9tIHByb3BlcnRpZXMgZnJvbSB0aGUgcGFyZW50IGNvbnRleHQKCSAgICAgICAgICAgICAgICBrby51dGlscy5leHRlbmQoc2VsZiwgcGFyZW50Q29udGV4dCk7CgoJICAgICAgICAgICAgICAgIC8vIEJlY2F1c2UgdGhlIGFib3ZlIGNvcHkgb3ZlcndyaXRlcyBvdXIgb3duIHByb3BlcnRpZXMsIHdlIG5lZWQgdG8gcmVzZXQgdGhlbS4KCSAgICAgICAgICAgICAgICAvLyBEdXJpbmcgdGhlIGZpcnN0IGV4ZWN1dGlvbiwgInN1YnNjcmliYWJsZSIgaXNuJ3Qgc2V0LCBzbyBkb24ndCBib3RoZXIgZG9pbmcgdGhlIHVwZGF0ZSB0aGVuLgoJICAgICAgICAgICAgICAgIGlmIChzdWJzY3JpYmFibGUpIHsKCSAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3Vic2NyaWJhYmxlID0gc3Vic2NyaWJhYmxlOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgc2VsZlsnJHBhcmVudHMnXSA9IFtdOwoJICAgICAgICAgICAgICAgIHNlbGZbJyRyb290J10gPSBkYXRhSXRlbTsKCgkgICAgICAgICAgICAgICAgLy8gRXhwb3J0ICdrbycgaW4gdGhlIGJpbmRpbmcgY29udGV4dCBzbyBpdCB3aWxsIGJlIGF2YWlsYWJsZSBpbiBiaW5kaW5ncyBhbmQgdGVtcGxhdGVzCgkgICAgICAgICAgICAgICAgLy8gZXZlbiBpZiAna28nIGlzbid0IGV4cG9ydGVkIGFzIGEgZ2xvYmFsLCBzdWNoIGFzIHdoZW4gdXNpbmcgYW4gQU1EIGxvYWRlci4KCSAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy80OTAKCSAgICAgICAgICAgICAgICBzZWxmWydrbyddID0ga287CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBzZWxmWyckcmF3RGF0YSddID0gZGF0YUl0ZW1Pck9ic2VydmFibGU7CgkgICAgICAgICAgICBzZWxmWyckZGF0YSddID0gZGF0YUl0ZW07CgkgICAgICAgICAgICBpZiAoZGF0YUl0ZW1BbGlhcykKCSAgICAgICAgICAgICAgICBzZWxmW2RhdGFJdGVtQWxpYXNdID0gZGF0YUl0ZW07CgoJICAgICAgICAgICAgLy8gVGhlIGV4dGVuZENhbGxiYWNrIGZ1bmN0aW9uIGlzIHByb3ZpZGVkIHdoZW4gY3JlYXRpbmcgYSBjaGlsZCBjb250ZXh0IG9yIGV4dGVuZGluZyBhIGNvbnRleHQuCgkgICAgICAgICAgICAvLyBJdCBoYW5kbGVzIHRoZSBzcGVjaWZpYyBhY3Rpb25zIG5lZWRlZCB0byBmaW5pc2ggc2V0dGluZyB1cCB0aGUgYmluZGluZyBjb250ZXh0LiBBY3Rpb25zIGluIHRoaXMKCSAgICAgICAgICAgIC8vIGZ1bmN0aW9uIGNvdWxkIGFsc28gYWRkIGRlcGVuZGVuY2llcyB0byB0aGlzIGJpbmRpbmcgY29udGV4dC4KCSAgICAgICAgICAgIGlmIChleHRlbmRDYWxsYmFjaykKCSAgICAgICAgICAgICAgICBleHRlbmRDYWxsYmFjayhzZWxmLCBwYXJlbnRDb250ZXh0LCBkYXRhSXRlbSk7CgoJICAgICAgICAgICAgcmV0dXJuIHNlbGZbJyRkYXRhJ107CgkgICAgICAgIH0KCSAgICAgICAgZnVuY3Rpb24gZGlzcG9zZVdoZW4oKSB7CgkgICAgICAgICAgICByZXR1cm4gbm9kZXMgJiYgIWtvLnV0aWxzLmFueURvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChub2Rlcyk7CgkgICAgICAgIH0KCgkgICAgICAgIHZhciBzZWxmID0gdGhpcywKCSAgICAgICAgICAgIGlzRnVuYyA9IHR5cGVvZihkYXRhSXRlbU9yQWNjZXNzb3IpID09ICJmdW5jdGlvbiIgJiYgIWtvLmlzT2JzZXJ2YWJsZShkYXRhSXRlbU9yQWNjZXNzb3IpLAoJICAgICAgICAgICAgbm9kZXMsCgkgICAgICAgICAgICBzdWJzY3JpYmFibGUgPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKHVwZGF0ZUNvbnRleHQsIG51bGwsIHsgZGlzcG9zZVdoZW46IGRpc3Bvc2VXaGVuLCBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IHRydWUgfSk7CgoJICAgICAgICAvLyBBdCB0aGlzIHBvaW50LCB0aGUgYmluZGluZyBjb250ZXh0IGhhcyBiZWVuIGluaXRpYWxpemVkLCBhbmQgdGhlICJzdWJzY3JpYmFibGUiIGNvbXB1dGVkIG9ic2VydmFibGUgaXMKCSAgICAgICAgLy8gc3Vic2NyaWJlZCB0byBhbnkgb2JzZXJ2YWJsZXMgdGhhdCB3ZXJlIGFjY2Vzc2VkIGluIHRoZSBwcm9jZXNzLiBJZiB0aGVyZSBpcyBub3RoaW5nIHRvIHRyYWNrLCB0aGUKCSAgICAgICAgLy8gY29tcHV0ZWQgd2lsbCBiZSBpbmFjdGl2ZSwgYW5kIHdlIGNhbiBzYWZlbHkgdGhyb3cgaXQgYXdheS4gSWYgaXQncyBhY3RpdmUsIHRoZSBjb21wdXRlZCBpcyBzdG9yZWQgaW4KCSAgICAgICAgLy8gdGhlIGNvbnRleHQgb2JqZWN0LgoJICAgICAgICBpZiAoc3Vic2NyaWJhYmxlLmlzQWN0aXZlKCkpIHsKCSAgICAgICAgICAgIHNlbGYuX3N1YnNjcmliYWJsZSA9IHN1YnNjcmliYWJsZTsKCgkgICAgICAgICAgICAvLyBBbHdheXMgbm90aWZ5IGJlY2F1c2UgZXZlbiBpZiB0aGUgbW9kZWwgKCRkYXRhKSBoYXNuJ3QgY2hhbmdlZCwgb3RoZXIgY29udGV4dCBwcm9wZXJ0aWVzIG1pZ2h0IGhhdmUgY2hhbmdlZAoJICAgICAgICAgICAgc3Vic2NyaWJhYmxlWydlcXVhbGl0eUNvbXBhcmVyJ10gPSBudWxsOwoKCSAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gYmUgYWJsZSB0byBkaXNwb3NlIG9mIHRoaXMgY29tcHV0ZWQgb2JzZXJ2YWJsZSB3aGVuIGl0J3Mgbm8gbG9uZ2VyIG5lZWRlZC4gVGhpcyB3b3VsZCBiZQoJICAgICAgICAgICAgLy8gZWFzeSBpZiB3ZSBoYWQgYSBzaW5nbGUgbm9kZSB0byB3YXRjaCwgYnV0IGJpbmRpbmcgY29udGV4dHMgY2FuIGJlIHVzZWQgYnkgbWFueSBkaWZmZXJlbnQgbm9kZXMsIGFuZAoJICAgICAgICAgICAgLy8gd2UgY2Fubm90IGFzc3VtZSB0aGF0IHRob3NlIG5vZGVzIGhhdmUgYW55IHJlbGF0aW9uIHRvIGVhY2ggb3RoZXIuIFNvIGluc3RlYWQgd2UgdHJhY2sgYW55IG5vZGUgdGhhdAoJICAgICAgICAgICAgLy8gdGhlIGNvbnRleHQgaXMgYXR0YWNoZWQgdG8sIGFuZCBkaXNwb3NlIHRoZSBjb21wdXRlZCB3aGVuIGFsbCBvZiB0aG9zZSBub2RlcyBoYXZlIGJlZW4gY2xlYW5lZC4KCgkgICAgICAgICAgICAvLyBBZGQgcHJvcGVydGllcyB0byAqc3Vic2NyaWJhYmxlKiBpbnN0ZWFkIG9mICpzZWxmKiBiZWNhdXNlIGFueSBwcm9wZXJ0aWVzIGFkZGVkIHRvICpzZWxmKiBtYXkgYmUgb3ZlcndyaXR0ZW4gb24gdXBkYXRlcwoJICAgICAgICAgICAgbm9kZXMgPSBbXTsKCSAgICAgICAgICAgIHN1YnNjcmliYWJsZS5fYWRkTm9kZSA9IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgICAgICBub2Rlcy5wdXNoKG5vZGUpOwoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5hZGREaXNwb3NlQ2FsbGJhY2sobm9kZSwgZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVJlbW92ZUl0ZW0obm9kZXMsIG5vZGUpOwoJICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGVzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaWJhYmxlLmRpc3Bvc2UoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N1YnNjcmliYWJsZSA9IHN1YnNjcmliYWJsZSA9IHVuZGVmaW5lZDsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgLy8gRXh0ZW5kIHRoZSBiaW5kaW5nIGNvbnRleHQgaGllcmFyY2h5IHdpdGggYSBuZXcgdmlldyBtb2RlbCBvYmplY3QuIElmIHRoZSBwYXJlbnQgY29udGV4dCBpcyB3YXRjaGluZwoJICAgIC8vIGFueSBvYnNldmFibGVzLCB0aGUgbmV3IGNoaWxkIGNvbnRleHQgd2lsbCBhdXRvbWF0aWNhbGx5IGdldCBhIGRlcGVuZGVuY3kgb24gdGhlIHBhcmVudCBjb250ZXh0LgoJICAgIC8vIEJ1dCB0aGlzIGRvZXMgbm90IG1lYW4gdGhhdCB0aGUgJGRhdGEgdmFsdWUgb2YgdGhlIGNoaWxkIGNvbnRleHQgd2lsbCBhbHNvIGdldCB1cGRhdGVkLiBJZiB0aGUgY2hpbGQKCSAgICAvLyB2aWV3IG1vZGVsIGFsc28gZGVwZW5kcyBvbiB0aGUgcGFyZW50IHZpZXcgbW9kZWwsIHlvdSBtdXN0IHByb3ZpZGUgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGNvcnJlY3QKCSAgICAvLyB2aWV3IG1vZGVsIG9uIGVhY2ggdXBkYXRlLgoJICAgIGtvLmJpbmRpbmdDb250ZXh0LnByb3RvdHlwZVsnY3JlYXRlQ2hpbGRDb250ZXh0J10gPSBmdW5jdGlvbiAoZGF0YUl0ZW1PckFjY2Vzc29yLCBkYXRhSXRlbUFsaWFzLCBleHRlbmRDYWxsYmFjaykgewoJICAgICAgICByZXR1cm4gbmV3IGtvLmJpbmRpbmdDb250ZXh0KGRhdGFJdGVtT3JBY2Nlc3NvciwgdGhpcywgZGF0YUl0ZW1BbGlhcywgZnVuY3Rpb24oc2VsZiwgcGFyZW50Q29udGV4dCkgewoJICAgICAgICAgICAgLy8gRXh0ZW5kIHRoZSBjb250ZXh0IGhpZXJhcmNoeSBieSBzZXR0aW5nIHRoZSBhcHByb3ByaWF0ZSBwb2ludGVycwoJICAgICAgICAgICAgc2VsZlsnJHBhcmVudENvbnRleHQnXSA9IHBhcmVudENvbnRleHQ7CgkgICAgICAgICAgICBzZWxmWyckcGFyZW50J10gPSBwYXJlbnRDb250ZXh0WyckZGF0YSddOwoJICAgICAgICAgICAgc2VsZlsnJHBhcmVudHMnXSA9IChwYXJlbnRDb250ZXh0WyckcGFyZW50cyddIHx8IFtdKS5zbGljZSgwKTsKCSAgICAgICAgICAgIHNlbGZbJyRwYXJlbnRzJ10udW5zaGlmdChzZWxmWyckcGFyZW50J10pOwoJICAgICAgICAgICAgaWYgKGV4dGVuZENhbGxiYWNrKQoJICAgICAgICAgICAgICAgIGV4dGVuZENhbGxiYWNrKHNlbGYpOwoJICAgICAgICB9KTsKCSAgICB9OwoKCSAgICAvLyBFeHRlbmQgdGhlIGJpbmRpbmcgY29udGV4dCB3aXRoIG5ldyBjdXN0b20gcHJvcGVydGllcy4gVGhpcyBkb2Vzbid0IGNoYW5nZSB0aGUgY29udGV4dCBoaWVyYXJjaHkuCgkgICAgLy8gU2ltaWxhcmx5IHRvICJjaGlsZCIgY29udGV4dHMsIHByb3ZpZGUgYSBmdW5jdGlvbiBoZXJlIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZSBjb3JyZWN0IHZhbHVlcyBhcmUgc2V0CgkgICAgLy8gd2hlbiBhbiBvYnNlcnZhYmxlIHZpZXcgbW9kZWwgaXMgdXBkYXRlZC4KCSAgICBrby5iaW5kaW5nQ29udGV4dC5wcm90b3R5cGVbJ2V4dGVuZCddID0gZnVuY3Rpb24ocHJvcGVydGllcykgewoJICAgICAgICAvLyBJZiB0aGUgcGFyZW50IGNvbnRleHQgcmVmZXJlbmNlcyBhbiBvYnNlcnZhYmxlIHZpZXcgbW9kZWwsICJfc3Vic2NyaWJhYmxlIiB3aWxsIGFsd2F5cyBiZSB0aGUKCSAgICAgICAgLy8gbGF0ZXN0IHZpZXcgbW9kZWwgb2JqZWN0LiBJZiBub3QsICJfc3Vic2NyaWJhYmxlIiBpc24ndCBzZXQsIGFuZCB3ZSBjYW4gdXNlIHRoZSBzdGF0aWMgIiRkYXRhIiB2YWx1ZS4KCSAgICAgICAgcmV0dXJuIG5ldyBrby5iaW5kaW5nQ29udGV4dCh0aGlzLl9zdWJzY3JpYmFibGUgfHwgdGhpc1snJGRhdGEnXSwgdGhpcywgbnVsbCwgZnVuY3Rpb24oc2VsZiwgcGFyZW50Q29udGV4dCkgewoJICAgICAgICAgICAgLy8gVGhpcyAiY2hpbGQiIGNvbnRleHQgZG9lc24ndCBkaXJlY3RseSB0cmFjayBhIHBhcmVudCBvYnNlcnZhYmxlIHZpZXcgbW9kZWwsCgkgICAgICAgICAgICAvLyBzbyB3ZSBuZWVkIHRvIG1hbnVhbGx5IHNldCB0aGUgJHJhd0RhdGEgdmFsdWUgdG8gbWF0Y2ggdGhlIHBhcmVudC4KCSAgICAgICAgICAgIHNlbGZbJyRyYXdEYXRhJ10gPSBwYXJlbnRDb250ZXh0WyckcmF3RGF0YSddOwoJICAgICAgICAgICAga28udXRpbHMuZXh0ZW5kKHNlbGYsIHR5cGVvZihwcm9wZXJ0aWVzKSA9PSAiZnVuY3Rpb24iID8gcHJvcGVydGllcygpIDogcHJvcGVydGllcyk7CgkgICAgICAgIH0pOwoJICAgIH07CgoJICAgIC8vIFJldHVybnMgdGhlIHZhbHVlQWNjZXNvciBmdW5jdGlvbiBmb3IgYSBiaW5kaW5nIHZhbHVlCgkgICAgZnVuY3Rpb24gbWFrZVZhbHVlQWNjZXNzb3IodmFsdWUpIHsKCSAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwoJICAgICAgICB9OwoJICAgIH0KCgkgICAgLy8gUmV0dXJucyB0aGUgdmFsdWUgb2YgYSB2YWx1ZUFjY2Vzc29yIGZ1bmN0aW9uCgkgICAgZnVuY3Rpb24gZXZhbHVhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgcmV0dXJuIHZhbHVlQWNjZXNzb3IoKTsKCSAgICB9CgoJICAgIC8vIEdpdmVuIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGJpbmRpbmdzLCBjcmVhdGUgYW5kIHJldHVybiBhIG5ldyBvYmplY3QgdGhhdCBjb250YWlucwoJICAgIC8vIGJpbmRpbmcgdmFsdWUtYWNjZXNzb3JzIGZ1bmN0aW9ucy4gRWFjaCBhY2Nlc3NvciBmdW5jdGlvbiBjYWxscyB0aGUgb3JpZ2luYWwgZnVuY3Rpb24KCSAgICAvLyBzbyB0aGF0IGl0IGFsd2F5cyBnZXRzIHRoZSBsYXRlc3QgdmFsdWUgYW5kIGFsbCBkZXBlbmRlbmNpZXMgYXJlIGNhcHR1cmVkLiBUaGlzIGlzIHVzZWQKCSAgICAvLyBieSBrby5hcHBseUJpbmRpbmdzVG9Ob2RlIGFuZCBnZXRCaW5kaW5nc0FuZE1ha2VBY2Nlc3NvcnMuCgkgICAgZnVuY3Rpb24gbWFrZUFjY2Vzc29yc0Zyb21GdW5jdGlvbihjYWxsYmFjaykgewoJICAgICAgICByZXR1cm4ga28udXRpbHMub2JqZWN0TWFwKGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGNhbGxiYWNrKSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewoJICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjaygpW2tleV07CgkgICAgICAgICAgICB9OwoJICAgICAgICB9KTsKCSAgICB9CgoJICAgIC8vIEdpdmVuIGEgYmluZGluZ3MgZnVuY3Rpb24gb3Igb2JqZWN0LCBjcmVhdGUgYW5kIHJldHVybiBhIG5ldyBvYmplY3QgdGhhdCBjb250YWlucwoJICAgIC8vIGJpbmRpbmcgdmFsdWUtYWNjZXNzb3JzIGZ1bmN0aW9ucy4gVGhpcyBpcyB1c2VkIGJ5IGtvLmFwcGx5QmluZGluZ3NUb05vZGUuCgkgICAgZnVuY3Rpb24gbWFrZUJpbmRpbmdBY2Nlc3NvcnMoYmluZGluZ3MsIGNvbnRleHQsIG5vZGUpIHsKCSAgICAgICAgaWYgKHR5cGVvZiBiaW5kaW5ncyA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgcmV0dXJuIG1ha2VBY2Nlc3NvcnNGcm9tRnVuY3Rpb24oYmluZGluZ3MuYmluZChudWxsLCBjb250ZXh0LCBub2RlKSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICByZXR1cm4ga28udXRpbHMub2JqZWN0TWFwKGJpbmRpbmdzLCBtYWtlVmFsdWVBY2Nlc3Nvcik7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIC8vIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBpZiB0aGUgYmluZGluZyBwcm92aWRlciBkb2Vzbid0IGluY2x1ZGUgYSBnZXRCaW5kaW5nQWNjZXNzb3JzIGZ1bmN0aW9uLgoJICAgIC8vIEl0IG11c3QgYmUgY2FsbGVkIHdpdGggJ3RoaXMnIHNldCB0byB0aGUgcHJvdmlkZXIgaW5zdGFuY2UuCgkgICAgZnVuY3Rpb24gZ2V0QmluZGluZ3NBbmRNYWtlQWNjZXNzb3JzKG5vZGUsIGNvbnRleHQpIHsKCSAgICAgICAgcmV0dXJuIG1ha2VBY2Nlc3NvcnNGcm9tRnVuY3Rpb24odGhpc1snZ2V0QmluZGluZ3MnXS5iaW5kKHRoaXMsIG5vZGUsIGNvbnRleHQpKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIHZhbGlkYXRlVGhhdEJpbmRpbmdJc0FsbG93ZWRGb3JWaXJ0dWFsRWxlbWVudHMoYmluZGluZ05hbWUpIHsKCSAgICAgICAgdmFyIHZhbGlkYXRvciA9IGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbYmluZGluZ05hbWVdOwoJICAgICAgICBpZiAoIXZhbGlkYXRvcikKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGJpbmRpbmcgJyIgKyBiaW5kaW5nTmFtZSArICInIGNhbm5vdCBiZSB1c2VkIHdpdGggdmlydHVhbCBlbGVtZW50cyIpCgkgICAgfQoKCSAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50c0ludGVybmFsIChiaW5kaW5nQ29udGV4dCwgZWxlbWVudE9yVmlydHVhbEVsZW1lbnQsIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CgkgICAgICAgIHZhciBjdXJyZW50Q2hpbGQsCgkgICAgICAgICAgICBuZXh0SW5RdWV1ZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5maXJzdENoaWxkKGVsZW1lbnRPclZpcnR1YWxFbGVtZW50KSwKCSAgICAgICAgICAgIHByb3ZpZGVyID0ga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddLAoJICAgICAgICAgICAgcHJlcHJvY2Vzc05vZGUgPSBwcm92aWRlclsncHJlcHJvY2Vzc05vZGUnXTsKCgkgICAgICAgIC8vIFByZXByb2Nlc3NpbmcgYWxsb3dzIGEgYmluZGluZyBwcm92aWRlciB0byBtdXRhdGUgYSBub2RlIGJlZm9yZSBiaW5kaW5ncyBhcmUgYXBwbGllZCB0byBpdC4gRm9yIGV4YW1wbGUgaXQncwoJICAgICAgICAvLyBwb3NzaWJsZSB0byBpbnNlcnQgbmV3IHNpYmxpbmdzIGFmdGVyIGl0LCBhbmQvb3IgcmVwbGFjZSB0aGUgbm9kZSB3aXRoIGEgZGlmZmVyZW50IG9uZS4gVGhpcyBjYW4gYmUgdXNlZCB0bwoJICAgICAgICAvLyBpbXBsZW1lbnQgY3VzdG9tIGJpbmRpbmcgc3ludGF4ZXMsIHN1Y2ggYXMge3sgdmFsdWUgfX0gZm9yIHN0cmluZyBpbnRlcnBvbGF0aW9uLCBvciBjdXN0b20gZWxlbWVudCB0eXBlcyB0aGF0CgkgICAgICAgIC8vIHRyaWdnZXIgaW5zZXJ0aW9uIG9mIDx0ZW1wbGF0ZT4gY29udGVudHMgYXQgdGhhdCBwb2ludCBpbiB0aGUgZG9jdW1lbnQuCgkgICAgICAgIGlmIChwcmVwcm9jZXNzTm9kZSkgewoJICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnRDaGlsZCA9IG5leHRJblF1ZXVlKSB7CgkgICAgICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcoY3VycmVudENoaWxkKTsKCSAgICAgICAgICAgICAgICBwcmVwcm9jZXNzTm9kZS5jYWxsKHByb3ZpZGVyLCBjdXJyZW50Q2hpbGQpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgLy8gUmVzZXQgbmV4dEluUXVldWUgZm9yIHRoZSBuZXh0IGxvb3AKCSAgICAgICAgICAgIG5leHRJblF1ZXVlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZWxlbWVudE9yVmlydHVhbEVsZW1lbnQpOwoJICAgICAgICB9CgoJICAgICAgICB3aGlsZSAoY3VycmVudENoaWxkID0gbmV4dEluUXVldWUpIHsKCSAgICAgICAgICAgIC8vIEtlZXAgYSByZWNvcmQgb2YgdGhlIG5leHQgY2hpbGQgKmJlZm9yZSogYXBwbHlpbmcgYmluZGluZ3MsIGluIGNhc2UgdGhlIGJpbmRpbmcgcmVtb3ZlcyB0aGUgY3VycmVudCBjaGlsZCBmcm9tIGl0cyBwb3NpdGlvbgoJICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcoY3VycmVudENoaWxkKTsKCSAgICAgICAgICAgIGFwcGx5QmluZGluZ3NUb05vZGVBbmREZXNjZW5kYW50c0ludGVybmFsKGJpbmRpbmdDb250ZXh0LCBjdXJyZW50Q2hpbGQsIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gYXBwbHlCaW5kaW5nc1RvTm9kZUFuZERlc2NlbmRhbnRzSW50ZXJuYWwgKGJpbmRpbmdDb250ZXh0LCBub2RlVmVyaWZpZWQsIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpIHsKCSAgICAgICAgdmFyIHNob3VsZEJpbmREZXNjZW5kYW50cyA9IHRydWU7CgoJICAgICAgICAvLyBQZXJmIG9wdGltaXNhdGlvbjogQXBwbHkgYmluZGluZ3Mgb25seSBpZi4uLgoJICAgICAgICAvLyAoMSkgV2UgbmVlZCB0byBzdG9yZSB0aGUgYmluZGluZyBjb250ZXh0IG9uIHRoaXMgbm9kZSAoYmVjYXVzZSBpdCBtYXkgZGlmZmVyIGZyb20gdGhlIERPTSBwYXJlbnQgbm9kZSdzIGJpbmRpbmcgY29udGV4dCkKCSAgICAgICAgLy8gICAgIE5vdGUgdGhhdCB3ZSBjYW4ndCBzdG9yZSBiaW5kaW5nIGNvbnRleHRzIG9uIG5vbi1lbGVtZW50cyAoZS5nLiwgdGV4dCBub2RlcyksIGFzIElFIGRvZXNuJ3QgYWxsb3cgZXhwYW5kbyBwcm9wZXJ0aWVzIGZvciB0aG9zZQoJICAgICAgICAvLyAoMikgSXQgbWlnaHQgaGF2ZSBiaW5kaW5ncyAoZS5nLiwgaXQgaGFzIGEgZGF0YS1iaW5kIGF0dHJpYnV0ZSwgb3IgaXQncyBhIG1hcmtlciBmb3IgYSBjb250YWluZXJsZXNzIHRlbXBsYXRlKQoJICAgICAgICB2YXIgaXNFbGVtZW50ID0gKG5vZGVWZXJpZmllZC5ub2RlVHlwZSA9PT0gMSk7CgkgICAgICAgIGlmIChpc0VsZW1lbnQpIC8vIFdvcmthcm91bmQgSUUgPD0gOCBIVE1MIHBhcnNpbmcgd2VpcmRuZXNzCgkgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMubm9ybWFsaXNlVmlydHVhbEVsZW1lbnREb21TdHJ1Y3R1cmUobm9kZVZlcmlmaWVkKTsKCgkgICAgICAgIHZhciBzaG91bGRBcHBseUJpbmRpbmdzID0gKGlzRWxlbWVudCAmJiBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSAgICAgICAgICAgICAvLyBDYXNlICgxKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHx8IGtvLmJpbmRpbmdQcm92aWRlclsnaW5zdGFuY2UnXVsnbm9kZUhhc0JpbmRpbmdzJ10obm9kZVZlcmlmaWVkKTsgICAgICAgLy8gQ2FzZSAoMikKCSAgICAgICAgaWYgKHNob3VsZEFwcGx5QmluZGluZ3MpCgkgICAgICAgICAgICBzaG91bGRCaW5kRGVzY2VuZGFudHMgPSBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwobm9kZVZlcmlmaWVkLCBudWxsLCBiaW5kaW5nQ29udGV4dCwgYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudClbJ3Nob3VsZEJpbmREZXNjZW5kYW50cyddOwoKCSAgICAgICAgaWYgKHNob3VsZEJpbmREZXNjZW5kYW50cyAmJiAhYmluZGluZ0RvZXNOb3RSZWN1cnNlSW50b0VsZW1lbnRUeXBlc1trby51dGlscy50YWdOYW1lTG93ZXIobm9kZVZlcmlmaWVkKV0pIHsKCSAgICAgICAgICAgIC8vIFdlJ3JlIHJlY3Vyc2luZyBhdXRvbWF0aWNhbGx5IGludG8gKHJlYWwgb3IgdmlydHVhbCkgY2hpbGQgbm9kZXMgd2l0aG91dCBjaGFuZ2luZyBiaW5kaW5nIGNvbnRleHRzLiBTbywKCSAgICAgICAgICAgIC8vICAqIEZvciBjaGlsZHJlbiBvZiBhICpyZWFsKiBlbGVtZW50LCB0aGUgYmluZGluZyBjb250ZXh0IGlzIGNlcnRhaW5seSB0aGUgc2FtZSBhcyBvbiB0aGVpciBET00gLnBhcmVudE5vZGUsCgkgICAgICAgICAgICAvLyAgICBoZW5jZSBiaW5kaW5nQ29udGV4dHNNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCBpcyBmYWxzZQoJICAgICAgICAgICAgLy8gICogRm9yIGNoaWxkcmVuIG9mIGEgKnZpcnR1YWwqIGVsZW1lbnQsIHdlIGNhbid0IGJlIHN1cmUuIEV2YWx1YXRpbmcgLnBhcmVudE5vZGUgb24gdGhvc2UgY2hpbGRyZW4gbWF5CgkgICAgICAgICAgICAvLyAgICBza2lwIG92ZXIgYW55IG51bWJlciBvZiBpbnRlcm1lZGlhdGUgdmlydHVhbCBlbGVtZW50cywgYW55IG9mIHdoaWNoIG1pZ2h0IGRlZmluZSBhIGN1c3RvbSBiaW5kaW5nIGNvbnRleHQsCgkgICAgICAgICAgICAvLyAgICBoZW5jZSBiaW5kaW5nQ29udGV4dHNNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCBpcyB0cnVlCgkgICAgICAgICAgICBhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50c0ludGVybmFsKGJpbmRpbmdDb250ZXh0LCBub2RlVmVyaWZpZWQsIC8qIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50OiAqLyAhaXNFbGVtZW50KTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgdmFyIGJvdW5kRWxlbWVudERvbURhdGFLZXkgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCgoJICAgIGZ1bmN0aW9uIHRvcG9sb2dpY2FsU29ydEJpbmRpbmdzKGJpbmRpbmdzKSB7CgkgICAgICAgIC8vIERlcHRoLWZpcnN0IHNvcnQKCSAgICAgICAgdmFyIHJlc3VsdCA9IFtdLCAgICAgICAgICAgICAgICAvLyBUaGUgbGlzdCBvZiBrZXkvaGFuZGxlciBwYWlycyB0aGF0IHdlIHdpbGwgcmV0dXJuCgkgICAgICAgICAgICBiaW5kaW5nc0NvbnNpZGVyZWQgPSB7fSwgICAgLy8gQSB0ZW1wb3JhcnkgcmVjb3JkIG9mIHdoaWNoIGJpbmRpbmdzIGFyZSBhbHJlYWR5IGluICdyZXN1bHQnCgkgICAgICAgICAgICBjeWNsaWNEZXBlbmRlbmN5U3RhY2sgPSBbXTsgLy8gS2VlcHMgdHJhY2sgb2YgYSBkZXB0aC1zZWFyY2ggc28gdGhhdCwgaWYgdGhlcmUncyBhIGN5Y2xlLCB3ZSBrbm93IHdoaWNoIGJpbmRpbmdzIGNhdXNlZCBpdAoJICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKGJpbmRpbmdzLCBmdW5jdGlvbiBwdXNoQmluZGluZyhiaW5kaW5nS2V5KSB7CgkgICAgICAgICAgICBpZiAoIWJpbmRpbmdzQ29uc2lkZXJlZFtiaW5kaW5nS2V5XSkgewoJICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nID0ga29bJ2dldEJpbmRpbmdIYW5kbGVyJ10oYmluZGluZ0tleSk7CgkgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmcpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gRmlyc3QgYWRkIGRlcGVuZGVuY2llcyAoaWYgYW55KSBvZiB0aGUgY3VycmVudCBiaW5kaW5nCgkgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nWydhZnRlciddKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBjeWNsaWNEZXBlbmRlbmN5U3RhY2sucHVzaChiaW5kaW5nS2V5KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChiaW5kaW5nWydhZnRlciddLCBmdW5jdGlvbihiaW5kaW5nRGVwZW5kZW5jeUtleSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nc1tiaW5kaW5nRGVwZW5kZW5jeUtleV0pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmFycmF5SW5kZXhPZihjeWNsaWNEZXBlbmRlbmN5U3RhY2ssIGJpbmRpbmdEZXBlbmRlbmN5S2V5KSAhPT0gLTEpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJDYW5ub3QgY29tYmluZSB0aGUgZm9sbG93aW5nIGJpbmRpbmdzLCBiZWNhdXNlIHRoZXkgaGF2ZSBhIGN5Y2xpYyBkZXBlbmRlbmN5OiAiICsgY3ljbGljRGVwZW5kZW5jeVN0YWNrLmpvaW4oIiwgIikpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVzaEJpbmRpbmcoYmluZGluZ0RlcGVuZGVuY3lLZXkpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgICAgICAgICBjeWNsaWNEZXBlbmRlbmN5U3RhY2subGVuZ3RoLS07CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgLy8gTmV4dCBhZGQgdGhlIGN1cnJlbnQgYmluZGluZwoJICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh7IGtleTogYmluZGluZ0tleSwgaGFuZGxlcjogYmluZGluZyB9KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgYmluZGluZ3NDb25zaWRlcmVkW2JpbmRpbmdLZXldID0gdHJ1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgoJICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgIH0KCgkgICAgZnVuY3Rpb24gYXBwbHlCaW5kaW5nc1RvTm9kZUludGVybmFsKG5vZGUsIHNvdXJjZUJpbmRpbmdzLCBiaW5kaW5nQ29udGV4dCwgYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkgewoJICAgICAgICAvLyBQcmV2ZW50IG11bHRpcGxlIGFwcGx5QmluZGluZ3MgY2FsbHMgZm9yIHRoZSBzYW1lIG5vZGUsIGV4Y2VwdCB3aGVuIGEgYmluZGluZyB2YWx1ZSBpcyBzcGVjaWZpZWQKCSAgICAgICAgdmFyIGFscmVhZHlCb3VuZCA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KG5vZGUsIGJvdW5kRWxlbWVudERvbURhdGFLZXkpOwoJICAgICAgICBpZiAoIXNvdXJjZUJpbmRpbmdzKSB7CgkgICAgICAgICAgICBpZiAoYWxyZWFkeUJvdW5kKSB7CgkgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIllvdSBjYW5ub3QgYXBwbHkgYmluZGluZ3MgbXVsdGlwbGUgdGltZXMgdG8gdGhlIHNhbWUgZWxlbWVudC4iKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIGJvdW5kRWxlbWVudERvbURhdGFLZXksIHRydWUpOwoJICAgICAgICB9CgoJICAgICAgICAvLyBPcHRpbWl6YXRpb246IERvbid0IHN0b3JlIHRoZSBiaW5kaW5nIGNvbnRleHQgb24gdGhpcyBub2RlIGlmIGl0J3MgZGVmaW5pdGVseSB0aGUgc2FtZSBhcyBvbiBub2RlLnBhcmVudE5vZGUsIGJlY2F1c2UKCSAgICAgICAgLy8gd2UgY2FuIGVhc2lseSByZWNvdmVyIGl0IGp1c3QgYnkgc2Nhbm5pbmcgdXAgdGhlIG5vZGUncyBhbmNlc3RvcnMgaW4gdGhlIERPTQoJICAgICAgICAvLyAobm90ZTogaGVyZSwgcGFyZW50IG5vZGUgbWVhbnMgInJlYWwgRE9NIHBhcmVudCIgbm90ICJ2aXJ0dWFsIHBhcmVudCIsIGFzIHRoZXJlJ3Mgbm8gTygxKSB3YXkgdG8gZmluZCB0aGUgdmlydHVhbCBwYXJlbnQpCgkgICAgICAgIGlmICghYWxyZWFkeUJvdW5kICYmIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpCgkgICAgICAgICAgICBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUobm9kZSwgYmluZGluZ0NvbnRleHQpOwoKCSAgICAgICAgLy8gVXNlIGJpbmRpbmdzIGlmIGdpdmVuLCBvdGhlcndpc2UgZmFsbCBiYWNrIG9uIGFza2luZyB0aGUgYmluZGluZ3MgcHJvdmlkZXIgdG8gZ2l2ZSB1cyBzb21lIGJpbmRpbmdzCgkgICAgICAgIHZhciBiaW5kaW5nczsKCSAgICAgICAgaWYgKHNvdXJjZUJpbmRpbmdzICYmIHR5cGVvZiBzb3VyY2VCaW5kaW5ncyAhPT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgYmluZGluZ3MgPSBzb3VyY2VCaW5kaW5nczsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHZhciBwcm92aWRlciA9IGtvLmJpbmRpbmdQcm92aWRlclsnaW5zdGFuY2UnXSwKCSAgICAgICAgICAgICAgICBnZXRCaW5kaW5ncyA9IHByb3ZpZGVyWydnZXRCaW5kaW5nQWNjZXNzb3JzJ10gfHwgZ2V0QmluZGluZ3NBbmRNYWtlQWNjZXNzb3JzOwoKCSAgICAgICAgICAgIC8vIEdldCB0aGUgYmluZGluZyBmcm9tIHRoZSBwcm92aWRlciB3aXRoaW4gYSBjb21wdXRlZCBvYnNlcnZhYmxlIHNvIHRoYXQgd2UgY2FuIHVwZGF0ZSB0aGUgYmluZGluZ3Mgd2hlbmV2ZXIKCSAgICAgICAgICAgIC8vIHRoZSBiaW5kaW5nIGNvbnRleHQgaXMgdXBkYXRlZCBvciBpZiB0aGUgYmluZGluZyBwcm92aWRlciBhY2Nlc3NlcyBvYnNlcnZhYmxlcy4KCSAgICAgICAgICAgIHZhciBiaW5kaW5nc1VwZGF0ZXIgPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKAoJICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgICAgICBiaW5kaW5ncyA9IHNvdXJjZUJpbmRpbmdzID8gc291cmNlQmluZGluZ3MoYmluZGluZ0NvbnRleHQsIG5vZGUpIDogZ2V0QmluZGluZ3MuY2FsbChwcm92aWRlciwgbm9kZSwgYmluZGluZ0NvbnRleHQpOwoJICAgICAgICAgICAgICAgICAgICAvLyBSZWdpc3RlciBhIGRlcGVuZGVuY3kgb24gdGhlIGJpbmRpbmcgY29udGV4dCB0byBzdXBwb3J0IG9ic2V2YWJsZSB2aWV3IG1vZGVscy4KCSAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdzICYmIGJpbmRpbmdDb250ZXh0Ll9zdWJzY3JpYmFibGUpCgkgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nQ29udGV4dC5fc3Vic2NyaWJhYmxlKCk7CgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nczsKCSAgICAgICAgICAgICAgICB9LAoJICAgICAgICAgICAgICAgIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBub2RlIH0KCSAgICAgICAgICAgICk7CgoJICAgICAgICAgICAgaWYgKCFiaW5kaW5ncyB8fCAhYmluZGluZ3NVcGRhdGVyLmlzQWN0aXZlKCkpCgkgICAgICAgICAgICAgICAgYmluZGluZ3NVcGRhdGVyID0gbnVsbDsKCSAgICAgICAgfQoKCSAgICAgICAgdmFyIGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzOwoJICAgICAgICBpZiAoYmluZGluZ3MpIHsKCSAgICAgICAgICAgIC8vIFJldHVybiB0aGUgdmFsdWUgYWNjZXNzb3IgZm9yIGEgZ2l2ZW4gYmluZGluZy4gV2hlbiBiaW5kaW5ncyBhcmUgc3RhdGljICh3b24ndCBiZSB1cGRhdGVkIGJlY2F1c2Ugb2YgYSBiaW5kaW5nCgkgICAgICAgICAgICAvLyBjb250ZXh0IHVwZGF0ZSksIGp1c3QgcmV0dXJuIHRoZSB2YWx1ZSBhY2Nlc3NvciBmcm9tIHRoZSBiaW5kaW5nLiBPdGhlcndpc2UsIHJldHVybiBhIGZ1bmN0aW9uIHRoYXQgYWx3YXlzIGdldHMKCSAgICAgICAgICAgIC8vIHRoZSBsYXRlc3QgYmluZGluZyB2YWx1ZSBhbmQgcmVnaXN0ZXJzIGEgZGVwZW5kZW5jeSBvbiB0aGUgYmluZGluZyB1cGRhdGVyLgoJICAgICAgICAgICAgdmFyIGdldFZhbHVlQWNjZXNzb3IgPSBiaW5kaW5nc1VwZGF0ZXIKCSAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uKGJpbmRpbmdLZXkpIHsKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2YWx1YXRlVmFsdWVBY2Nlc3NvcihiaW5kaW5nc1VwZGF0ZXIoKVtiaW5kaW5nS2V5XSk7CgkgICAgICAgICAgICAgICAgICAgIH07CgkgICAgICAgICAgICAgICAgfSA6IGZ1bmN0aW9uKGJpbmRpbmdLZXkpIHsKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmdzW2JpbmRpbmdLZXldOwoJICAgICAgICAgICAgICAgIH07CgoJICAgICAgICAgICAgLy8gVXNlIG9mIGFsbEJpbmRpbmdzIGFzIGEgZnVuY3Rpb24gaXMgbWFpbnRhaW5lZCBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHksIGJ1dCBpdHMgdXNlIGlzIGRlcHJlY2F0ZWQKCSAgICAgICAgICAgIGZ1bmN0aW9uIGFsbEJpbmRpbmdzKCkgewoJICAgICAgICAgICAgICAgIHJldHVybiBrby51dGlscy5vYmplY3RNYXAoYmluZGluZ3NVcGRhdGVyID8gYmluZGluZ3NVcGRhdGVyKCkgOiBiaW5kaW5ncywgZXZhbHVhdGVWYWx1ZUFjY2Vzc29yKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgaXMgdGhlIDMueCBhbGxCaW5kaW5ncyBBUEkKCSAgICAgICAgICAgIGFsbEJpbmRpbmdzWydnZXQnXSA9IGZ1bmN0aW9uKGtleSkgewoJICAgICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nc1trZXldICYmIGV2YWx1YXRlVmFsdWVBY2Nlc3NvcihnZXRWYWx1ZUFjY2Vzc29yKGtleSkpOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIGFsbEJpbmRpbmdzWydoYXMnXSA9IGZ1bmN0aW9uKGtleSkgewoJICAgICAgICAgICAgICAgIHJldHVybiBrZXkgaW4gYmluZGluZ3M7CgkgICAgICAgICAgICB9OwoKCSAgICAgICAgICAgIC8vIEZpcnN0IHB1dCB0aGUgYmluZGluZ3MgaW50byB0aGUgcmlnaHQgb3JkZXIKCSAgICAgICAgICAgIHZhciBvcmRlcmVkQmluZGluZ3MgPSB0b3BvbG9naWNhbFNvcnRCaW5kaW5ncyhiaW5kaW5ncyk7CgoJICAgICAgICAgICAgLy8gR28gdGhyb3VnaCB0aGUgc29ydGVkIGJpbmRpbmdzLCBjYWxsaW5nIGluaXQgYW5kIHVwZGF0ZSBmb3IgZWFjaAoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKG9yZGVyZWRCaW5kaW5ncywgZnVuY3Rpb24oYmluZGluZ0tleUFuZEhhbmRsZXIpIHsKCSAgICAgICAgICAgICAgICAvLyBOb3RlIHRoYXQgdG9wb2xvZ2ljYWxTb3J0QmluZGluZ3MgaGFzIGFscmVhZHkgZmlsdGVyZWQgb3V0IGFueSBub25leGlzdGVudCBiaW5kaW5nIGhhbmRsZXJzLAoJICAgICAgICAgICAgICAgIC8vIHNvIGJpbmRpbmdLZXlBbmRIYW5kbGVyLmhhbmRsZXIgd2lsbCBhbHdheXMgYmUgbm9ubnVsbC4KCSAgICAgICAgICAgICAgICB2YXIgaGFuZGxlckluaXRGbiA9IGJpbmRpbmdLZXlBbmRIYW5kbGVyLmhhbmRsZXJbImluaXQiXSwKCSAgICAgICAgICAgICAgICAgICAgaGFuZGxlclVwZGF0ZUZuID0gYmluZGluZ0tleUFuZEhhbmRsZXIuaGFuZGxlclsidXBkYXRlIl0sCgkgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdLZXkgPSBiaW5kaW5nS2V5QW5kSGFuZGxlci5rZXk7CgoJICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSA4KSB7CgkgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlVGhhdEJpbmRpbmdJc0FsbG93ZWRGb3JWaXJ0dWFsRWxlbWVudHMoYmluZGluZ0tleSk7CgkgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgICAgICAvLyBSdW4gaW5pdCwgaWdub3JpbmcgYW55IGRlcGVuZGVuY2llcwoJICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGhhbmRsZXJJbml0Rm4gPT0gImZ1bmN0aW9uIikgewoJICAgICAgICAgICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluaXRSZXN1bHQgPSBoYW5kbGVySW5pdEZuKG5vZGUsIGdldFZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSksIGFsbEJpbmRpbmdzLCBiaW5kaW5nQ29udGV4dFsnJGRhdGEnXSwgYmluZGluZ0NvbnRleHQpOwoKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGlzIGJpbmRpbmcgaGFuZGxlciBjbGFpbXMgdG8gY29udHJvbCBkZXNjZW5kYW50IGJpbmRpbmdzLCBtYWtlIGEgbm90ZSBvZiB0aGlzCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluaXRSZXN1bHQgJiYgaW5pdFJlc3VsdFsnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnXSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MgIT09IHVuZGVmaW5lZCkKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTXVsdGlwbGUgYmluZGluZ3MgKCIgKyBiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyArICIgYW5kICIgKyBiaW5kaW5nS2V5ICsgIikgYXJlIHRyeWluZyB0byBjb250cm9sIGRlc2NlbmRhbnQgYmluZGluZ3Mgb2YgdGhlIHNhbWUgZWxlbWVudC4gWW91IGNhbm5vdCB1c2UgdGhlc2UgYmluZGluZ3MgdG9nZXRoZXIgb24gdGhlIHNhbWUgZWxlbWVudC4iKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MgPSBiaW5kaW5nS2V5OwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgICAgICAvLyBSdW4gdXBkYXRlIGluIGl0cyBvd24gY29tcHV0ZWQgd3JhcHBlcgoJICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGhhbmRsZXJVcGRhdGVGbiA9PSAiZnVuY3Rpb24iKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyVXBkYXRlRm4obm9kZSwgZ2V0VmFsdWVBY2Nlc3NvcihiaW5kaW5nS2V5KSwgYWxsQmluZGluZ3MsIGJpbmRpbmdDb250ZXh0WyckZGF0YSddLCBiaW5kaW5nQ29udGV4dCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBudWxsLAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBub2RlIH0KCSAgICAgICAgICAgICAgICAgICAgICAgICk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewoJICAgICAgICAgICAgICAgICAgICBleC5tZXNzYWdlID0gIlVuYWJsZSB0byBwcm9jZXNzIGJpbmRpbmcgXCIiICsgYmluZGluZ0tleSArICI6ICIgKyBiaW5kaW5nc1tiaW5kaW5nS2V5XSArICJcIlxuTWVzc2FnZTogIiArIGV4Lm1lc3NhZ2U7CgkgICAgICAgICAgICAgICAgICAgIHRocm93IGV4OwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9CgoJICAgICAgICByZXR1cm4gewoJICAgICAgICAgICAgJ3Nob3VsZEJpbmREZXNjZW5kYW50cyc6IGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzID09PSB1bmRlZmluZWQKCSAgICAgICAgfTsKCSAgICB9OwoKCSAgICB2YXIgc3RvcmVkQmluZGluZ0NvbnRleHREb21EYXRhS2V5ID0ga28udXRpbHMuZG9tRGF0YS5uZXh0S2V5KCk7CgkgICAga28uc3RvcmVkQmluZGluZ0NvbnRleHRGb3JOb2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDIpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIHN0b3JlZEJpbmRpbmdDb250ZXh0RG9tRGF0YUtleSwgYmluZGluZ0NvbnRleHQpOwoJICAgICAgICAgICAgaWYgKGJpbmRpbmdDb250ZXh0Ll9zdWJzY3JpYmFibGUpCgkgICAgICAgICAgICAgICAgYmluZGluZ0NvbnRleHQuX3N1YnNjcmliYWJsZS5fYWRkTm9kZShub2RlKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy5kb21EYXRhLmdldChub2RlLCBzdG9yZWRCaW5kaW5nQ29udGV4dERvbURhdGFLZXkpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBnZXRCaW5kaW5nQ29udGV4dCh2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIHJldHVybiB2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0ICYmICh2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0IGluc3RhbmNlb2Yga28uYmluZGluZ0NvbnRleHQpCgkgICAgICAgICAgICA/IHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQKCSAgICAgICAgICAgIDogbmV3IGtvLmJpbmRpbmdDb250ZXh0KHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQpOwoJICAgIH0KCgkgICAga28uYXBwbHlCaW5kaW5nQWNjZXNzb3JzVG9Ob2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSAvLyBJZiBpdCdzIGFuIGVsZW1lbnQsIHdvcmthcm91bmQgSUUgPD0gOCBIVE1MIHBhcnNpbmcgd2VpcmRuZXNzCgkgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMubm9ybWFsaXNlVmlydHVhbEVsZW1lbnREb21TdHJ1Y3R1cmUobm9kZSk7CgkgICAgICAgIHJldHVybiBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwobm9kZSwgYmluZGluZ3MsIGdldEJpbmRpbmdDb250ZXh0KHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQpLCB0cnVlKTsKCSAgICB9OwoKCSAgICBrby5hcHBseUJpbmRpbmdzVG9Ob2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIHZhciBjb250ZXh0ID0gZ2V0QmluZGluZ0NvbnRleHQodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCk7CgkgICAgICAgIHJldHVybiBrby5hcHBseUJpbmRpbmdBY2Nlc3NvcnNUb05vZGUobm9kZSwgbWFrZUJpbmRpbmdBY2Nlc3NvcnMoYmluZGluZ3MsIGNvbnRleHQsIG5vZGUpLCBjb250ZXh0KTsKCSAgICB9OwoKCSAgICBrby5hcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cyA9IGZ1bmN0aW9uKHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQsIHJvb3ROb2RlKSB7CgkgICAgICAgIGlmIChyb290Tm9kZS5ub2RlVHlwZSA9PT0gMSB8fCByb290Tm9kZS5ub2RlVHlwZSA9PT0gOCkKCSAgICAgICAgICAgIGFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzSW50ZXJuYWwoZ2V0QmluZGluZ0NvbnRleHQodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCksIHJvb3ROb2RlLCB0cnVlKTsKCSAgICB9OwoKCSAgICBrby5hcHBseUJpbmRpbmdzID0gZnVuY3Rpb24gKHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQsIHJvb3ROb2RlKSB7CgkgICAgICAgIC8vIElmIGpRdWVyeSBpcyBsb2FkZWQgYWZ0ZXIgS25vY2tvdXQsIHdlIHdvbid0IGluaXRpYWxseSBoYXZlIGFjY2VzcyB0byBpdC4gU28gc2F2ZSBpdCBoZXJlLgoJICAgICAgICBpZiAoIWpRdWVyeUluc3RhbmNlICYmIHdpbmRvd1snalF1ZXJ5J10pIHsKCSAgICAgICAgICAgIGpRdWVyeUluc3RhbmNlID0gd2luZG93WydqUXVlcnknXTsKCSAgICAgICAgfQoKCSAgICAgICAgaWYgKHJvb3ROb2RlICYmIChyb290Tm9kZS5ub2RlVHlwZSAhPT0gMSkgJiYgKHJvb3ROb2RlLm5vZGVUeXBlICE9PSA4KSkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigia28uYXBwbHlCaW5kaW5nczogZmlyc3QgcGFyYW1ldGVyIHNob3VsZCBiZSB5b3VyIHZpZXcgbW9kZWw7IHNlY29uZCBwYXJhbWV0ZXIgc2hvdWxkIGJlIGEgRE9NIG5vZGUiKTsKCSAgICAgICAgcm9vdE5vZGUgPSByb290Tm9kZSB8fCB3aW5kb3cuZG9jdW1lbnQuYm9keTsgLy8gTWFrZSAicm9vdE5vZGUiIHBhcmFtZXRlciBvcHRpb25hbAoKCSAgICAgICAgYXBwbHlCaW5kaW5nc1RvTm9kZUFuZERlc2NlbmRhbnRzSW50ZXJuYWwoZ2V0QmluZGluZ0NvbnRleHQodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCksIHJvb3ROb2RlLCB0cnVlKTsKCSAgICB9OwoKCSAgICAvLyBSZXRyaWV2aW5nIGJpbmRpbmcgY29udGV4dCBmcm9tIGFyYml0cmFyeSBub2RlcwoJICAgIGtvLmNvbnRleHRGb3IgPSBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgIC8vIFdlIGNhbiBvbmx5IGRvIHNvbWV0aGluZyBtZWFuaW5nZnVsIGZvciBlbGVtZW50cyBhbmQgY29tbWVudCBub2RlcyAoaW4gcGFydGljdWxhciwgbm90IHRleHQgbm9kZXMsIGFzIElFIGNhbid0IHN0b3JlIGRvbWRhdGEgZm9yIHRoZW0pCgkgICAgICAgIHN3aXRjaCAobm9kZS5ub2RlVHlwZSkgewoJICAgICAgICAgICAgY2FzZSAxOgoJICAgICAgICAgICAgY2FzZSA4OgoJICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0ga28uc3RvcmVkQmluZGluZ0NvbnRleHRGb3JOb2RlKG5vZGUpOwoJICAgICAgICAgICAgICAgIGlmIChjb250ZXh0KSByZXR1cm4gY29udGV4dDsKCSAgICAgICAgICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlKSByZXR1cm4ga28uY29udGV4dEZvcihub2RlLnBhcmVudE5vZGUpOwoJICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CgkgICAgfTsKCSAgICBrby5kYXRhRm9yID0gZnVuY3Rpb24obm9kZSkgewoJICAgICAgICB2YXIgY29udGV4dCA9IGtvLmNvbnRleHRGb3Iobm9kZSk7CgkgICAgICAgIHJldHVybiBjb250ZXh0ID8gY29udGV4dFsnJGRhdGEnXSA6IHVuZGVmaW5lZDsKCSAgICB9OwoKCSAgICBrby5leHBvcnRTeW1ib2woJ2JpbmRpbmdIYW5kbGVycycsIGtvLmJpbmRpbmdIYW5kbGVycyk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdhcHBseUJpbmRpbmdzJywga28uYXBwbHlCaW5kaW5ncyk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cycsIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2FwcGx5QmluZGluZ0FjY2Vzc29yc1RvTm9kZScsIGtvLmFwcGx5QmluZGluZ0FjY2Vzc29yc1RvTm9kZSk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdhcHBseUJpbmRpbmdzVG9Ob2RlJywga28uYXBwbHlCaW5kaW5nc1RvTm9kZSk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdjb250ZXh0Rm9yJywga28uY29udGV4dEZvcik7CgkgICAga28uZXhwb3J0U3ltYm9sKCdkYXRhRm9yJywga28uZGF0YUZvcik7Cgl9KSgpOwoJKGZ1bmN0aW9uKHVuZGVmaW5lZCkgewoJICAgIHZhciBsb2FkaW5nU3Vic2NyaWJhYmxlc0NhY2hlID0ge30sIC8vIFRyYWNrcyBjb21wb25lbnQgbG9hZHMgdGhhdCBhcmUgY3VycmVudGx5IGluIGZsaWdodAoJICAgICAgICBsb2FkZWREZWZpbml0aW9uc0NhY2hlID0ge307ICAgIC8vIFRyYWNrcyBjb21wb25lbnQgbG9hZHMgdGhhdCBoYXZlIGFscmVhZHkgY29tcGxldGVkCgoJICAgIGtvLmNvbXBvbmVudHMgPSB7CgkgICAgICAgIGdldDogZnVuY3Rpb24oY29tcG9uZW50TmFtZSwgY2FsbGJhY2spIHsKCSAgICAgICAgICAgIHZhciBjYWNoZWREZWZpbml0aW9uID0gZ2V0T2JqZWN0T3duUHJvcGVydHkobG9hZGVkRGVmaW5pdGlvbnNDYWNoZSwgY29tcG9uZW50TmFtZSk7CgkgICAgICAgICAgICBpZiAoY2FjaGVkRGVmaW5pdGlvbikgewoJICAgICAgICAgICAgICAgIC8vIEl0J3MgYWxyZWFkeSBsb2FkZWQgYW5kIGNhY2hlZC4gUmV1c2UgdGhlIHNhbWUgZGVmaW5pdGlvbiBvYmplY3QuCgkgICAgICAgICAgICAgICAgLy8gTm90ZSB0aGF0IGZvciBBUEkgY29uc2lzdGVuY3ksIGV2ZW4gY2FjaGUgaGl0cyBjb21wbGV0ZSBhc3luY2hyb25vdXNseS4KCSAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBjYWxsYmFjayhjYWNoZWREZWZpbml0aW9uKSB9LCAwKTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gSm9pbiB0aGUgbG9hZGluZyBwcm9jZXNzIHRoYXQgaXMgYWxyZWFkeSB1bmRlcndheSwgb3Igc3RhcnQgYSBuZXcgb25lLgoJICAgICAgICAgICAgICAgIGxvYWRDb21wb25lbnRBbmROb3RpZnkoY29tcG9uZW50TmFtZSwgY2FsbGJhY2spOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgY2xlYXJDYWNoZWREZWZpbml0aW9uOiBmdW5jdGlvbihjb21wb25lbnROYW1lKSB7CgkgICAgICAgICAgICBkZWxldGUgbG9hZGVkRGVmaW5pdGlvbnNDYWNoZVtjb21wb25lbnROYW1lXTsKCSAgICAgICAgfSwKCgkgICAgICAgIF9nZXRGaXJzdFJlc3VsdEZyb21Mb2FkZXJzOiBnZXRGaXJzdFJlc3VsdEZyb21Mb2FkZXJzCgkgICAgfTsKCgkgICAgZnVuY3Rpb24gZ2V0T2JqZWN0T3duUHJvcGVydHkob2JqLCBwcm9wTmFtZSkgewoJICAgICAgICByZXR1cm4gb2JqLmhhc093blByb3BlcnR5KHByb3BOYW1lKSA/IG9ialtwcm9wTmFtZV0gOiB1bmRlZmluZWQ7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBsb2FkQ29tcG9uZW50QW5kTm90aWZ5KGNvbXBvbmVudE5hbWUsIGNhbGxiYWNrKSB7CgkgICAgICAgIHZhciBzdWJzY3JpYmFibGUgPSBnZXRPYmplY3RPd25Qcm9wZXJ0eShsb2FkaW5nU3Vic2NyaWJhYmxlc0NhY2hlLCBjb21wb25lbnROYW1lKSwKCSAgICAgICAgICAgIGNvbXBsZXRlZEFzeW5jOwoJICAgICAgICBpZiAoIXN1YnNjcmliYWJsZSkgewoJICAgICAgICAgICAgLy8gSXQncyBub3Qgc3RhcnRlZCBsb2FkaW5nIHlldC4gU3RhcnQgbG9hZGluZywgYW5kIHdoZW4gaXQncyBkb25lLCBtb3ZlIGl0IHRvIGxvYWRlZERlZmluaXRpb25zQ2FjaGUuCgkgICAgICAgICAgICBzdWJzY3JpYmFibGUgPSBsb2FkaW5nU3Vic2NyaWJhYmxlc0NhY2hlW2NvbXBvbmVudE5hbWVdID0gbmV3IGtvLnN1YnNjcmliYWJsZSgpOwoJICAgICAgICAgICAgYmVnaW5Mb2FkaW5nQ29tcG9uZW50KGNvbXBvbmVudE5hbWUsIGZ1bmN0aW9uKGRlZmluaXRpb24pIHsKCSAgICAgICAgICAgICAgICBsb2FkZWREZWZpbml0aW9uc0NhY2hlW2NvbXBvbmVudE5hbWVdID0gZGVmaW5pdGlvbjsKCSAgICAgICAgICAgICAgICBkZWxldGUgbG9hZGluZ1N1YnNjcmliYWJsZXNDYWNoZVtjb21wb25lbnROYW1lXTsKCgkgICAgICAgICAgICAgICAgLy8gRm9yIEFQSSBjb25zaXN0ZW5jeSwgYWxsIGxvYWRzIGNvbXBsZXRlIGFzeW5jaHJvbm91c2x5LiBIb3dldmVyIHdlIHdhbnQgdG8gYXZvaWQKCSAgICAgICAgICAgICAgICAvLyBhZGRpbmcgYW4gZXh0cmEgc2V0VGltZW91dCBpZiBpdCdzIHVubmVjZXNzYXJ5IChpLmUuLCB0aGUgY29tcGxldGlvbiBpcyBhbHJlYWR5CgkgICAgICAgICAgICAgICAgLy8gYXN5bmMpIHNpbmNlIHNldFRpbWVvdXQoLi4uLCAwKSBzdGlsbCB0YWtlcyBhYm91dCAxNm1zIG9yIG1vcmUgb24gbW9zdCBicm93c2Vycy4KCSAgICAgICAgICAgICAgICBpZiAoY29tcGxldGVkQXN5bmMpIHsKCSAgICAgICAgICAgICAgICAgICAgc3Vic2NyaWJhYmxlWydub3RpZnlTdWJzY3JpYmVycyddKGRlZmluaXRpb24pOwoJICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpYmFibGVbJ25vdGlmeVN1YnNjcmliZXJzJ10oZGVmaW5pdGlvbik7CgkgICAgICAgICAgICAgICAgICAgIH0sIDApOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgY29tcGxldGVkQXN5bmMgPSB0cnVlOwoJICAgICAgICB9CgkgICAgICAgIHN1YnNjcmliYWJsZS5zdWJzY3JpYmUoY2FsbGJhY2spOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gYmVnaW5Mb2FkaW5nQ29tcG9uZW50KGNvbXBvbmVudE5hbWUsIGNhbGxiYWNrKSB7CgkgICAgICAgIGdldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMoJ2dldENvbmZpZycsIFtjb21wb25lbnROYW1lXSwgZnVuY3Rpb24oY29uZmlnKSB7CgkgICAgICAgICAgICBpZiAoY29uZmlnKSB7CgkgICAgICAgICAgICAgICAgLy8gV2UgaGF2ZSBhIGNvbmZpZywgc28gbm93IGxvYWQgaXRzIGRlZmluaXRpb24KCSAgICAgICAgICAgICAgICBnZXRGaXJzdFJlc3VsdEZyb21Mb2FkZXJzKCdsb2FkQ29tcG9uZW50JywgW2NvbXBvbmVudE5hbWUsIGNvbmZpZ10sIGZ1bmN0aW9uKGRlZmluaXRpb24pIHsKCSAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZGVmaW5pdGlvbik7CgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIFRoZSBjb21wb25lbnQgaGFzIG5vIGNvbmZpZyAtIGl0J3MgdW5rbm93biB0byBhbGwgdGhlIGxvYWRlcnMuCgkgICAgICAgICAgICAgICAgLy8gTm90ZSB0aGF0IHRoaXMgaXMgbm90IGFuIGVycm9yIChlLmcuLCBhIG1vZHVsZSBsb2FkaW5nIGVycm9yKSAtIHRoYXQgd291bGQgYWJvcnQgdGhlCgkgICAgICAgICAgICAgICAgLy8gcHJvY2VzcyBhbmQgdGhpcyBjYWxsYmFjayB3b3VsZCBub3QgcnVuLiBGb3IgdGhpcyBjYWxsYmFjayB0byBydW4sIGFsbCBsb2FkZXJzIG11c3QKCSAgICAgICAgICAgICAgICAvLyBoYXZlIGNvbmZpcm1lZCB0aGV5IGRvbid0IGtub3cgYWJvdXQgdGhpcyBjb21wb25lbnQuCgkgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZ2V0Rmlyc3RSZXN1bHRGcm9tTG9hZGVycyhtZXRob2ROYW1lLCBhcmdzRXhjZXB0Q2FsbGJhY2ssIGNhbGxiYWNrLCBjYW5kaWRhdGVMb2FkZXJzKSB7CgkgICAgICAgIC8vIE9uIHRoZSBmaXJzdCBjYWxsIGluIHRoZSBzdGFjaywgc3RhcnQgd2l0aCB0aGUgZnVsbCBzZXQgb2YgbG9hZGVycwoJICAgICAgICBpZiAoIWNhbmRpZGF0ZUxvYWRlcnMpIHsKCSAgICAgICAgICAgIGNhbmRpZGF0ZUxvYWRlcnMgPSBrby5jb21wb25lbnRzWydsb2FkZXJzJ10uc2xpY2UoMCk7IC8vIFVzZSBhIGNvcHksIGJlY2F1c2Ugd2UnbGwgYmUgbXV0YXRpbmcgdGhpcyBhcnJheQoJICAgICAgICB9CgoJICAgICAgICAvLyBUcnkgdGhlIG5leHQgY2FuZGlkYXRlCgkgICAgICAgIHZhciBjdXJyZW50Q2FuZGlkYXRlTG9hZGVyID0gY2FuZGlkYXRlTG9hZGVycy5zaGlmdCgpOwoJICAgICAgICBpZiAoY3VycmVudENhbmRpZGF0ZUxvYWRlcikgewoJICAgICAgICAgICAgdmFyIG1ldGhvZEluc3RhbmNlID0gY3VycmVudENhbmRpZGF0ZUxvYWRlclttZXRob2ROYW1lXTsKCSAgICAgICAgICAgIGlmIChtZXRob2RJbnN0YW5jZSkgewoJICAgICAgICAgICAgICAgIHZhciB3YXNBYm9ydGVkID0gZmFsc2UsCgkgICAgICAgICAgICAgICAgICAgIHN5bmNocm9ub3VzUmV0dXJuVmFsdWUgPSBtZXRob2RJbnN0YW5jZS5hcHBseShjdXJyZW50Q2FuZGlkYXRlTG9hZGVyLCBhcmdzRXhjZXB0Q2FsbGJhY2suY29uY2F0KGZ1bmN0aW9uKHJlc3VsdCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdhc0Fib3J0ZWQpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzdWx0ICE9PSBudWxsKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBjYW5kaWRhdGUgcmV0dXJuZWQgYSB2YWx1ZS4gVXNlIGl0LgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHJlc3VsdCk7CgkgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRyeSB0aGUgbmV4dCBjYW5kaWRhdGUKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXRGaXJzdFJlc3VsdEZyb21Mb2FkZXJzKG1ldGhvZE5hbWUsIGFyZ3NFeGNlcHRDYWxsYmFjaywgY2FsbGJhY2ssIGNhbmRpZGF0ZUxvYWRlcnMpOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICB9KSk7CgoJICAgICAgICAgICAgICAgIC8vIEN1cnJlbnRseSwgbG9hZGVycyBtYXkgbm90IHJldHVybiBhbnl0aGluZyBzeW5jaHJvbm91c2x5LiBUaGlzIGxlYXZlcyBvcGVuIHRoZSBwb3NzaWJpbGl0eQoJICAgICAgICAgICAgICAgIC8vIHRoYXQgd2UnbGwgZXh0ZW5kIHRoZSBBUEkgdG8gc3VwcG9ydCBzeW5jaHJvbm91cyByZXR1cm4gdmFsdWVzIGluIHRoZSBmdXR1cmUuIEl0IHdvbid0IGJlCgkgICAgICAgICAgICAgICAgLy8gYSBicmVha2luZyBjaGFuZ2UsIGJlY2F1c2UgY3VycmVudGx5IG5vIGxvYWRlciBpcyBhbGxvd2VkIHRvIHJldHVybiBhbnl0aGluZyBleGNlcHQgdW5kZWZpbmVkLgoJICAgICAgICAgICAgICAgIGlmIChzeW5jaHJvbm91c1JldHVyblZhbHVlICE9PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgICAgICAgICAgd2FzQWJvcnRlZCA9IHRydWU7CgoJICAgICAgICAgICAgICAgICAgICAvLyBNZXRob2QgdG8gc3VwcHJlc3MgZXhjZXB0aW9ucyB3aWxsIHJlbWFpbiB1bmRvY3VtZW50ZWQuIFRoaXMgaXMgb25seSB0byBrZWVwCgkgICAgICAgICAgICAgICAgICAgIC8vIEtPJ3Mgc3BlY3MgcnVubmluZyB0aWRpbHksIHNpbmNlIHdlIGNhbiBvYnNlcnZlIHRoZSBsb2FkaW5nIGdvdCBhYm9ydGVkIHdpdGhvdXQKCSAgICAgICAgICAgICAgICAgICAgLy8gaGF2aW5nIGV4Y2VwdGlvbnMgY2x1dHRlcmluZyB1cCB0aGUgY29uc29sZSB0b28uCgkgICAgICAgICAgICAgICAgICAgIGlmICghY3VycmVudENhbmRpZGF0ZUxvYWRlclsnc3VwcHJlc3NMb2FkZXJFeGNlcHRpb25zJ10pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcG9uZW50IGxvYWRlcnMgbXVzdCBzdXBwbHkgdmFsdWVzIGJ5IGludm9raW5nIHRoZSBjYWxsYmFjaywgbm90IGJ5IHJldHVybmluZyB2YWx1ZXMgc3luY2hyb25vdXNseS4nKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gVGhpcyBjYW5kaWRhdGUgZG9lc24ndCBoYXZlIHRoZSByZWxldmFudCBoYW5kbGVyLiBTeW5jaHJvbm91c2x5IG1vdmUgb24gdG8gdGhlIG5leHQgb25lLgoJICAgICAgICAgICAgICAgIGdldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMobWV0aG9kTmFtZSwgYXJnc0V4Y2VwdENhbGxiYWNrLCBjYWxsYmFjaywgY2FuZGlkYXRlTG9hZGVycyk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAvLyBObyBjYW5kaWRhdGVzIHJldHVybmVkIGEgdmFsdWUKCSAgICAgICAgICAgIGNhbGxiYWNrKG51bGwpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICAvLyBSZWZlcmVuY2UgdGhlIGxvYWRlcnMgdmlhIHN0cmluZyBuYW1lIHNvIGl0J3MgcG9zc2libGUgZm9yIGRldmVsb3BlcnMKCSAgICAvLyB0byByZXBsYWNlIHRoZSB3aG9sZSBhcnJheSBieSBhc3NpZ25pbmcgdG8ga28uY29tcG9uZW50cy5sb2FkZXJzCgkgICAga28uY29tcG9uZW50c1snbG9hZGVycyddID0gW107CgoJICAgIGtvLmV4cG9ydFN5bWJvbCgnY29tcG9uZW50cycsIGtvLmNvbXBvbmVudHMpOwoJICAgIGtvLmV4cG9ydFN5bWJvbCgnY29tcG9uZW50cy5nZXQnLCBrby5jb21wb25lbnRzLmdldCk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzLmNsZWFyQ2FjaGVkRGVmaW5pdGlvbicsIGtvLmNvbXBvbmVudHMuY2xlYXJDYWNoZWREZWZpbml0aW9uKTsKCX0pKCk7CgkoZnVuY3Rpb24odW5kZWZpbmVkKSB7CgoJICAgIC8vIFRoZSBkZWZhdWx0IGxvYWRlciBpcyByZXNwb25zaWJsZSBmb3IgdHdvIHRoaW5nczoKCSAgICAvLyAxLiBNYWludGFpbmluZyB0aGUgZGVmYXVsdCBpbi1tZW1vcnkgcmVnaXN0cnkgb2YgY29tcG9uZW50IGNvbmZpZ3VyYXRpb24gb2JqZWN0cwoJICAgIC8vICAgIChpLmUuLCB0aGUgdGhpbmcgeW91J3JlIHdyaXRpbmcgdG8gd2hlbiB5b3UgY2FsbCBrby5jb21wb25lbnRzLnJlZ2lzdGVyKHNvbWVOYW1lLCAuLi4pKQoJICAgIC8vIDIuIEFuc3dlcmluZyByZXF1ZXN0cyBmb3IgY29tcG9uZW50cyBieSBmZXRjaGluZyBjb25maWd1cmF0aW9uIG9iamVjdHMKCSAgICAvLyAgICBmcm9tIHRoYXQgZGVmYXVsdCBpbi1tZW1vcnkgcmVnaXN0cnkgYW5kIHJlc29sdmluZyB0aGVtIGludG8gc3RhbmRhcmQKCSAgICAvLyAgICBjb21wb25lbnQgZGVmaW5pdGlvbiBvYmplY3RzIChvZiB0aGUgZm9ybSB7IGNyZWF0ZVZpZXdNb2RlbDogLi4uLCB0ZW1wbGF0ZTogLi4uIH0pCgkgICAgLy8gQ3VzdG9tIGxvYWRlcnMgbWF5IG92ZXJyaWRlIGVpdGhlciBvZiB0aGVzZSBmYWNpbGl0aWVzLCBpLmUuLAoJICAgIC8vIDEuIFRvIHN1cHBseSBjb25maWd1cmF0aW9uIG9iamVjdHMgZnJvbSBzb21lIG90aGVyIHNvdXJjZSAoZS5nLiwgY29udmVudGlvbnMpCgkgICAgLy8gMi4gT3IsIHRvIHJlc29sdmUgY29uZmlndXJhdGlvbiBvYmplY3RzIGJ5IGxvYWRpbmcgdmlld21vZGVscy90ZW1wbGF0ZXMgdmlhIGFyYml0cmFyeSBsb2dpYy4KCgkgICAgdmFyIGRlZmF1bHRDb25maWdSZWdpc3RyeSA9IHt9OwoKCSAgICBrby5jb21wb25lbnRzLnJlZ2lzdGVyID0gZnVuY3Rpb24oY29tcG9uZW50TmFtZSwgY29uZmlnKSB7CgkgICAgICAgIGlmICghY29uZmlnKSB7CgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY29uZmlndXJhdGlvbiBmb3IgJyArIGNvbXBvbmVudE5hbWUpOwoJICAgICAgICB9CgoJICAgICAgICBpZiAoa28uY29tcG9uZW50cy5pc1JlZ2lzdGVyZWQoY29tcG9uZW50TmFtZSkpIHsKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcG9uZW50ICcgKyBjb21wb25lbnROYW1lICsgJyBpcyBhbHJlYWR5IHJlZ2lzdGVyZWQnKTsKCSAgICAgICAgfQoKCSAgICAgICAgZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5W2NvbXBvbmVudE5hbWVdID0gY29uZmlnOwoJICAgIH0KCgkgICAga28uY29tcG9uZW50cy5pc1JlZ2lzdGVyZWQgPSBmdW5jdGlvbihjb21wb25lbnROYW1lKSB7CgkgICAgICAgIHJldHVybiBjb21wb25lbnROYW1lIGluIGRlZmF1bHRDb25maWdSZWdpc3RyeTsKCSAgICB9CgoJICAgIGtvLmNvbXBvbmVudHMudW5yZWdpc3RlciA9IGZ1bmN0aW9uKGNvbXBvbmVudE5hbWUpIHsKCSAgICAgICAgZGVsZXRlIGRlZmF1bHRDb25maWdSZWdpc3RyeVtjb21wb25lbnROYW1lXTsKCSAgICAgICAga28uY29tcG9uZW50cy5jbGVhckNhY2hlZERlZmluaXRpb24oY29tcG9uZW50TmFtZSk7CgkgICAgfQoKCSAgICBrby5jb21wb25lbnRzLmRlZmF1bHRMb2FkZXIgPSB7CgkgICAgICAgICdnZXRDb25maWcnOiBmdW5jdGlvbihjb21wb25lbnROYW1lLCBjYWxsYmFjaykgewoJICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmF1bHRDb25maWdSZWdpc3RyeS5oYXNPd25Qcm9wZXJ0eShjb21wb25lbnROYW1lKQoJICAgICAgICAgICAgICAgID8gZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5W2NvbXBvbmVudE5hbWVdCgkgICAgICAgICAgICAgICAgOiBudWxsOwoJICAgICAgICAgICAgY2FsbGJhY2socmVzdWx0KTsKCSAgICAgICAgfSwKCgkgICAgICAgICdsb2FkQ29tcG9uZW50JzogZnVuY3Rpb24oY29tcG9uZW50TmFtZSwgY29uZmlnLCBjYWxsYmFjaykgewoJICAgICAgICAgICAgdmFyIGVycm9yQ2FsbGJhY2sgPSBtYWtlRXJyb3JDYWxsYmFjayhjb21wb25lbnROYW1lKTsKCSAgICAgICAgICAgIHBvc3NpYmx5R2V0Q29uZmlnRnJvbUFtZChlcnJvckNhbGxiYWNrLCBjb25maWcsIGZ1bmN0aW9uKGxvYWRlZENvbmZpZykgewoJICAgICAgICAgICAgICAgIHJlc29sdmVDb25maWcoY29tcG9uZW50TmFtZSwgZXJyb3JDYWxsYmFjaywgbG9hZGVkQ29uZmlnLCBjYWxsYmFjayk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfSwKCgkgICAgICAgICdsb2FkVGVtcGxhdGUnOiBmdW5jdGlvbihjb21wb25lbnROYW1lLCB0ZW1wbGF0ZUNvbmZpZywgY2FsbGJhY2spIHsKCSAgICAgICAgICAgIHJlc29sdmVUZW1wbGF0ZShtYWtlRXJyb3JDYWxsYmFjayhjb21wb25lbnROYW1lKSwgdGVtcGxhdGVDb25maWcsIGNhbGxiYWNrKTsKCSAgICAgICAgfSwKCgkgICAgICAgICdsb2FkVmlld01vZGVsJzogZnVuY3Rpb24oY29tcG9uZW50TmFtZSwgdmlld01vZGVsQ29uZmlnLCBjYWxsYmFjaykgewoJICAgICAgICAgICAgcmVzb2x2ZVZpZXdNb2RlbChtYWtlRXJyb3JDYWxsYmFjayhjb21wb25lbnROYW1lKSwgdmlld01vZGVsQ29uZmlnLCBjYWxsYmFjayk7CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICB2YXIgY3JlYXRlVmlld01vZGVsS2V5ID0gJ2NyZWF0ZVZpZXdNb2RlbCc7CgoJICAgIC8vIFRha2VzIGEgY29uZmlnIG9iamVjdCBvZiB0aGUgZm9ybSB7IHRlbXBsYXRlOiAuLi4sIHZpZXdNb2RlbDogLi4uIH0sIGFuZCBhc3luY2hyb25vdXNseSBjb252ZXJ0IGl0CgkgICAgLy8gaW50byB0aGUgc3RhbmRhcmQgY29tcG9uZW50IGRlZmluaXRpb24gZm9ybWF0OgoJICAgIC8vICAgIHsgdGVtcGxhdGU6IDxBcnJheU9mRG9tTm9kZXM+LCBjcmVhdGVWaWV3TW9kZWw6IGZ1bmN0aW9uKHBhcmFtcywgY29tcG9uZW50SW5mbykgeyAuLi4gfSB9LgoJICAgIC8vIFNpbmNlIGJvdGggdGVtcGxhdGUgYW5kIHZpZXdNb2RlbCBtYXkgbmVlZCB0byBiZSByZXNvbHZlZCBhc3luY2hyb25vdXNseSwgYm90aCB0YXNrcyBhcmUgcGVyZm9ybWVkCgkgICAgLy8gaW4gcGFyYWxsZWwsIGFuZCB0aGUgcmVzdWx0cyBqb2luZWQgd2hlbiBib3RoIGFyZSByZWFkeS4gV2UgZG9uJ3QgZGVwZW5kIG9uIGFueSBwcm9taXNlcyBpbmZyYXN0cnVjdHVyZSwKCSAgICAvLyBzbyB0aGlzIGlzIGltcGxlbWVudGVkIG1hbnVhbGx5IGJlbG93LgoJICAgIGZ1bmN0aW9uIHJlc29sdmVDb25maWcoY29tcG9uZW50TmFtZSwgZXJyb3JDYWxsYmFjaywgY29uZmlnLCBjYWxsYmFjaykgewoJICAgICAgICB2YXIgcmVzdWx0ID0ge30sCgkgICAgICAgICAgICBtYWtlQ2FsbEJhY2tXaGVuWmVybyA9IDIsCgkgICAgICAgICAgICB0cnlJc3N1ZUNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgaWYgKC0tbWFrZUNhbGxCYWNrV2hlblplcm8gPT09IDApIHsKCSAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2socmVzdWx0KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9LAoJICAgICAgICAgICAgdGVtcGxhdGVDb25maWcgPSBjb25maWdbJ3RlbXBsYXRlJ10sCgkgICAgICAgICAgICB2aWV3TW9kZWxDb25maWcgPSBjb25maWdbJ3ZpZXdNb2RlbCddOwoKCSAgICAgICAgaWYgKHRlbXBsYXRlQ29uZmlnKSB7CgkgICAgICAgICAgICBwb3NzaWJseUdldENvbmZpZ0Zyb21BbWQoZXJyb3JDYWxsYmFjaywgdGVtcGxhdGVDb25maWcsIGZ1bmN0aW9uKGxvYWRlZENvbmZpZykgewoJICAgICAgICAgICAgICAgIGtvLmNvbXBvbmVudHMuX2dldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMoJ2xvYWRUZW1wbGF0ZScsIFtjb21wb25lbnROYW1lLCBsb2FkZWRDb25maWddLCBmdW5jdGlvbihyZXNvbHZlZFRlbXBsYXRlKSB7CgkgICAgICAgICAgICAgICAgICAgIHJlc3VsdFsndGVtcGxhdGUnXSA9IHJlc29sdmVkVGVtcGxhdGU7CgkgICAgICAgICAgICAgICAgICAgIHRyeUlzc3VlQ2FsbGJhY2soKTsKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdHJ5SXNzdWVDYWxsYmFjaygpOwoJICAgICAgICB9CgoJICAgICAgICBpZiAodmlld01vZGVsQ29uZmlnKSB7CgkgICAgICAgICAgICBwb3NzaWJseUdldENvbmZpZ0Zyb21BbWQoZXJyb3JDYWxsYmFjaywgdmlld01vZGVsQ29uZmlnLCBmdW5jdGlvbihsb2FkZWRDb25maWcpIHsKCSAgICAgICAgICAgICAgICBrby5jb21wb25lbnRzLl9nZXRGaXJzdFJlc3VsdEZyb21Mb2FkZXJzKCdsb2FkVmlld01vZGVsJywgW2NvbXBvbmVudE5hbWUsIGxvYWRlZENvbmZpZ10sIGZ1bmN0aW9uKHJlc29sdmVkVmlld01vZGVsKSB7CgkgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtjcmVhdGVWaWV3TW9kZWxLZXldID0gcmVzb2x2ZWRWaWV3TW9kZWw7CgkgICAgICAgICAgICAgICAgICAgIHRyeUlzc3VlQ2FsbGJhY2soKTsKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdHJ5SXNzdWVDYWxsYmFjaygpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiByZXNvbHZlVGVtcGxhdGUoZXJyb3JDYWxsYmFjaywgdGVtcGxhdGVDb25maWcsIGNhbGxiYWNrKSB7CgkgICAgICAgIGlmICh0eXBlb2YgdGVtcGxhdGVDb25maWcgPT09ICdzdHJpbmcnKSB7CgkgICAgICAgICAgICAvLyBNYXJrdXAgLSBwYXJzZSBpdAoJICAgICAgICAgICAgY2FsbGJhY2soa28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQodGVtcGxhdGVDb25maWcpKTsKCSAgICAgICAgfSBlbHNlIGlmICh0ZW1wbGF0ZUNvbmZpZyBpbnN0YW5jZW9mIEFycmF5KSB7CgkgICAgICAgICAgICAvLyBBc3N1bWUgYWxyZWFkeSBhbiBhcnJheSBvZiBET00gbm9kZXMgLSBwYXNzIHRocm91Z2ggdW5jaGFuZ2VkCgkgICAgICAgICAgICBjYWxsYmFjayh0ZW1wbGF0ZUNvbmZpZyk7CgkgICAgICAgIH0gZWxzZSBpZiAoaXNEb2N1bWVudEZyYWdtZW50KHRlbXBsYXRlQ29uZmlnKSkgewoJICAgICAgICAgICAgLy8gRG9jdW1lbnQgZnJhZ21lbnQgLSB1c2UgaXRzIGNoaWxkIG5vZGVzCgkgICAgICAgICAgICBjYWxsYmFjayhrby51dGlscy5tYWtlQXJyYXkodGVtcGxhdGVDb25maWcuY2hpbGROb2RlcykpOwoJICAgICAgICB9IGVsc2UgaWYgKHRlbXBsYXRlQ29uZmlnWydlbGVtZW50J10pIHsKCSAgICAgICAgICAgIHZhciBlbGVtZW50ID0gdGVtcGxhdGVDb25maWdbJ2VsZW1lbnQnXTsKCSAgICAgICAgICAgIGlmIChpc0RvbUVsZW1lbnQoZWxlbWVudCkpIHsKCSAgICAgICAgICAgICAgICAvLyBFbGVtZW50IGluc3RhbmNlIC0gY29weSBpdHMgY2hpbGQgbm9kZXMKCSAgICAgICAgICAgICAgICBjYWxsYmFjayhjbG9uZU5vZGVzRnJvbVRlbXBsYXRlU291cmNlRWxlbWVudChlbGVtZW50KSk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAnc3RyaW5nJykgewoJICAgICAgICAgICAgICAgIC8vIEVsZW1lbnQgSUQgLSBmaW5kIGl0LCB0aGVuIGNvcHkgaXRzIGNoaWxkIG5vZGVzCgkgICAgICAgICAgICAgICAgdmFyIGVsZW1JbnN0YW5jZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGVsZW1lbnQpOwoJICAgICAgICAgICAgICAgIGlmIChlbGVtSW5zdGFuY2UpIHsKCSAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soY2xvbmVOb2Rlc0Zyb21UZW1wbGF0ZVNvdXJjZUVsZW1lbnQoZWxlbUluc3RhbmNlKSk7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgZXJyb3JDYWxsYmFjaygnQ2Fubm90IGZpbmQgZWxlbWVudCB3aXRoIElEICcgKyBlbGVtZW50KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIGVycm9yQ2FsbGJhY2soJ1Vua25vd24gZWxlbWVudCB0eXBlOiAnICsgZWxlbWVudCk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBlcnJvckNhbGxiYWNrKCdVbmtub3duIHRlbXBsYXRlIHZhbHVlOiAnICsgdGVtcGxhdGVDb25maWcpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiByZXNvbHZlVmlld01vZGVsKGVycm9yQ2FsbGJhY2ssIHZpZXdNb2RlbENvbmZpZywgY2FsbGJhY2spIHsKCSAgICAgICAgaWYgKHR5cGVvZiB2aWV3TW9kZWxDb25maWcgPT09ICdmdW5jdGlvbicpIHsKCSAgICAgICAgICAgIC8vIENvbnN0cnVjdG9yIC0gY29udmVydCB0byBzdGFuZGFyZCBmYWN0b3J5IGZ1bmN0aW9uIGZvcm1hdAoJICAgICAgICAgICAgLy8gQnkgZGVzaWduLCB0aGlzIGRvZXMgKm5vdCogc3VwcGx5IGNvbXBvbmVudEluZm8gdG8gdGhlIGNvbnN0cnVjdG9yLCBhcyB0aGUgaW50ZW50IGlzIHRoYXQKCSAgICAgICAgICAgIC8vIGNvbXBvbmVudEluZm8gY29udGFpbnMgbm9uLXZpZXdtb2RlbCBkYXRhIChlLmcuLCB0aGUgY29tcG9uZW50J3MgZWxlbWVudCkgdGhhdCBzaG91bGQgb25seQoJICAgICAgICAgICAgLy8gYmUgdXNlZCBpbiBmYWN0b3J5IGZ1bmN0aW9ucywgbm90IHZpZXdtb2RlbCBjb25zdHJ1Y3RvcnMuCgkgICAgICAgICAgICBjYWxsYmFjayhmdW5jdGlvbiAocGFyYW1zIC8qLCBjb21wb25lbnRJbmZvICovKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyB2aWV3TW9kZWxDb25maWcocGFyYW1zKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2aWV3TW9kZWxDb25maWdbY3JlYXRlVmlld01vZGVsS2V5XSA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgLy8gQWxyZWFkeSBhIGZhY3RvcnkgZnVuY3Rpb24gLSB1c2UgaXQgYXMtaXMKCSAgICAgICAgICAgIGNhbGxiYWNrKHZpZXdNb2RlbENvbmZpZ1tjcmVhdGVWaWV3TW9kZWxLZXldKTsKCSAgICAgICAgfSBlbHNlIGlmICgnaW5zdGFuY2UnIGluIHZpZXdNb2RlbENvbmZpZykgewoJICAgICAgICAgICAgLy8gRml4ZWQgb2JqZWN0IGluc3RhbmNlIC0gcHJvbW90ZSB0byBjcmVhdGVWaWV3TW9kZWwgZm9ybWF0IGZvciBBUEkgY29uc2lzdGVuY3kKCSAgICAgICAgICAgIHZhciBmaXhlZEluc3RhbmNlID0gdmlld01vZGVsQ29uZmlnWydpbnN0YW5jZSddOwoJICAgICAgICAgICAgY2FsbGJhY2soZnVuY3Rpb24gKHBhcmFtcywgY29tcG9uZW50SW5mbykgewoJICAgICAgICAgICAgICAgIHJldHVybiBmaXhlZEluc3RhbmNlOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0gZWxzZSBpZiAoJ3ZpZXdNb2RlbCcgaW4gdmlld01vZGVsQ29uZmlnKSB7CgkgICAgICAgICAgICAvLyBSZXNvbHZlZCBBTUQgbW9kdWxlIHdob3NlIHZhbHVlIGlzIG9mIHRoZSBmb3JtIHsgdmlld01vZGVsOiAuLi4gfQoJICAgICAgICAgICAgcmVzb2x2ZVZpZXdNb2RlbChlcnJvckNhbGxiYWNrLCB2aWV3TW9kZWxDb25maWdbJ3ZpZXdNb2RlbCddLCBjYWxsYmFjayk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBlcnJvckNhbGxiYWNrKCdVbmtub3duIHZpZXdNb2RlbCB2YWx1ZTogJyArIHZpZXdNb2RlbENvbmZpZyk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNsb25lTm9kZXNGcm9tVGVtcGxhdGVTb3VyY2VFbGVtZW50KGVsZW1JbnN0YW5jZSkgewoJICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtSW5zdGFuY2UpKSB7CgkgICAgICAgICAgICBjYXNlICdzY3JpcHQnOgoJICAgICAgICAgICAgICAgIHJldHVybiBrby51dGlscy5wYXJzZUh0bWxGcmFnbWVudChlbGVtSW5zdGFuY2UudGV4dCk7CgkgICAgICAgICAgICBjYXNlICd0ZXh0YXJlYSc6CgkgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KGVsZW1JbnN0YW5jZS52YWx1ZSk7CgkgICAgICAgICAgICBjYXNlICd0ZW1wbGF0ZSc6CgkgICAgICAgICAgICAgICAgLy8gRm9yIGJyb3dzZXJzIHdpdGggcHJvcGVyIDx0ZW1wbGF0ZT4gZWxlbWVudCBzdXBwb3J0IChpLmUuLCB3aGVyZSB0aGUgLmNvbnRlbnQgcHJvcGVydHkKCSAgICAgICAgICAgICAgICAvLyBnaXZlcyBhIGRvY3VtZW50IGZyYWdtZW50KSwgdXNlIHRoYXQgZG9jdW1lbnQgZnJhZ21lbnQuCgkgICAgICAgICAgICAgICAgaWYgKGlzRG9jdW1lbnRGcmFnbWVudChlbGVtSW5zdGFuY2UuY29udGVudCkpIHsKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmNsb25lTm9kZXMoZWxlbUluc3RhbmNlLmNvbnRlbnQuY2hpbGROb2Rlcyk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICAvLyBSZWd1bGFyIGVsZW1lbnRzIHN1Y2ggYXMgPGRpdj4sIGFuZCA8dGVtcGxhdGU+IGVsZW1lbnRzIG9uIG9sZCBicm93c2VycyB0aGF0IGRvbid0IHJlYWxseQoJICAgICAgICAvLyB1bmRlcnN0YW5kIDx0ZW1wbGF0ZT4gYW5kIGp1c3QgdHJlYXQgaXQgYXMgYSByZWd1bGFyIGNvbnRhaW5lcgoJICAgICAgICByZXR1cm4ga28udXRpbHMuY2xvbmVOb2RlcyhlbGVtSW5zdGFuY2UuY2hpbGROb2Rlcyk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBpc0RvbUVsZW1lbnQob2JqKSB7CgkgICAgICAgIGlmICh3aW5kb3dbJ0hUTUxFbGVtZW50J10pIHsKCSAgICAgICAgICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBIVE1MRWxlbWVudDsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHJldHVybiBvYmogJiYgb2JqLnRhZ05hbWUgJiYgb2JqLm5vZGVUeXBlID09PSAxOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBpc0RvY3VtZW50RnJhZ21lbnQob2JqKSB7CgkgICAgICAgIGlmICh3aW5kb3dbJ0RvY3VtZW50RnJhZ21lbnQnXSkgewoJICAgICAgICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIERvY3VtZW50RnJhZ21lbnQ7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5ub2RlVHlwZSA9PT0gMTE7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIHBvc3NpYmx5R2V0Q29uZmlnRnJvbUFtZChlcnJvckNhbGxiYWNrLCBjb25maWcsIGNhbGxiYWNrKSB7CgkgICAgICAgIGlmICh0eXBlb2YgY29uZmlnWydyZXF1aXJlJ10gPT09ICdzdHJpbmcnKSB7CgkgICAgICAgICAgICAvLyBUaGUgY29uZmlnIGlzIHRoZSB2YWx1ZSBvZiBhbiBBTUQgbW9kdWxlCgkgICAgICAgICAgICBpZiAocmVxdWlyZSB8fCB3aW5kb3dbJ3JlcXVpcmUnXSkgewoJICAgICAgICAgICAgICAgIChyZXF1aXJlIHx8IHdpbmRvd1sncmVxdWlyZSddKShbY29uZmlnWydyZXF1aXJlJ11dLCBjYWxsYmFjayk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIGVycm9yQ2FsbGJhY2soJ1VzZXMgcmVxdWlyZSwgYnV0IG5vIEFNRCBsb2FkZXIgaXMgcHJlc2VudCcpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgY2FsbGJhY2soY29uZmlnKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gbWFrZUVycm9yQ2FsbGJhY2soY29tcG9uZW50TmFtZSkgewoJICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG1lc3NhZ2UpIHsKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcG9uZW50IFwnJyArIGNvbXBvbmVudE5hbWUgKyAnXCc6ICcgKyBtZXNzYWdlKTsKCSAgICAgICAgfTsKCSAgICB9CgoJICAgIGtvLmV4cG9ydFN5bWJvbCgnY29tcG9uZW50cy5yZWdpc3RlcicsIGtvLmNvbXBvbmVudHMucmVnaXN0ZXIpOwoJICAgIGtvLmV4cG9ydFN5bWJvbCgnY29tcG9uZW50cy5pc1JlZ2lzdGVyZWQnLCBrby5jb21wb25lbnRzLmlzUmVnaXN0ZXJlZCk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzLnVucmVnaXN0ZXInLCBrby5jb21wb25lbnRzLnVucmVnaXN0ZXIpOwoKCSAgICAvLyBFeHBvc2UgdGhlIGRlZmF1bHQgbG9hZGVyIHNvIHRoYXQgZGV2ZWxvcGVycyBjYW4gZGlyZWN0bHkgYXNrIGl0IGZvciBjb25maWd1cmF0aW9uCgkgICAgLy8gb3IgdG8gcmVzb2x2ZSBjb25maWd1cmF0aW9uCgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzLmRlZmF1bHRMb2FkZXInLCBrby5jb21wb25lbnRzLmRlZmF1bHRMb2FkZXIpOwoKCSAgICAvLyBCeSBkZWZhdWx0LCB0aGUgZGVmYXVsdCBsb2FkZXIgaXMgdGhlIG9ubHkgcmVnaXN0ZXJlZCBjb21wb25lbnQgbG9hZGVyCgkgICAga28uY29tcG9uZW50c1snbG9hZGVycyddLnB1c2goa28uY29tcG9uZW50cy5kZWZhdWx0TG9hZGVyKTsKCgkgICAgLy8gUHJpdmF0ZWx5IGV4cG9zZSB0aGUgdW5kZXJseWluZyBjb25maWcgcmVnaXN0cnkgZm9yIHVzZSBpbiBvbGQtSUUgc2hpbQoJICAgIGtvLmNvbXBvbmVudHMuX2FsbFJlZ2lzdGVyZWRDb21wb25lbnRzID0gZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5OwoJfSkoKTsKCShmdW5jdGlvbiAodW5kZWZpbmVkKSB7CgkgICAgLy8gT3ZlcnJpZGFibGUgQVBJIGZvciBkZXRlcm1pbmluZyB3aGljaCBjb21wb25lbnQgbmFtZSBhcHBsaWVzIHRvIGEgZ2l2ZW4gbm9kZS4gQnkgb3ZlcnJpZGluZyB0aGlzLAoJICAgIC8vIHlvdSBjYW4gZm9yIGV4YW1wbGUgbWFwIHNwZWNpZmljIHRhZ05hbWVzIHRvIGNvbXBvbmVudHMgdGhhdCBhcmUgbm90IHByZXJlZ2lzdGVyZWQuCgkgICAga28uY29tcG9uZW50c1snZ2V0Q29tcG9uZW50TmFtZUZvck5vZGUnXSA9IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgdmFyIHRhZ05hbWVMb3dlciA9IGtvLnV0aWxzLnRhZ05hbWVMb3dlcihub2RlKTsKCSAgICAgICAgcmV0dXJuIGtvLmNvbXBvbmVudHMuaXNSZWdpc3RlcmVkKHRhZ05hbWVMb3dlcikgJiYgdGFnTmFtZUxvd2VyOwoJICAgIH07CgoJICAgIGtvLmNvbXBvbmVudHMuYWRkQmluZGluZ3NGb3JDdXN0b21FbGVtZW50ID0gZnVuY3Rpb24oYWxsQmluZGluZ3MsIG5vZGUsIGJpbmRpbmdDb250ZXh0LCB2YWx1ZUFjY2Vzc29ycykgewoJICAgICAgICAvLyBEZXRlcm1pbmUgaWYgaXQncyByZWFsbHkgYSBjdXN0b20gZWxlbWVudCBtYXRjaGluZyBhIGNvbXBvbmVudAoJICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgewoJICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBrby5jb21wb25lbnRzWydnZXRDb21wb25lbnROYW1lRm9yTm9kZSddKG5vZGUpOwoJICAgICAgICAgICAgaWYgKGNvbXBvbmVudE5hbWUpIHsKCSAgICAgICAgICAgICAgICAvLyBJdCBkb2VzIHJlcHJlc2VudCBhIGNvbXBvbmVudCwgc28gYWRkIGEgY29tcG9uZW50IGJpbmRpbmcgZm9yIGl0CgkgICAgICAgICAgICAgICAgYWxsQmluZGluZ3MgPSBhbGxCaW5kaW5ncyB8fCB7fTsKCgkgICAgICAgICAgICAgICAgaWYgKGFsbEJpbmRpbmdzWydjb21wb25lbnQnXSkgewoJICAgICAgICAgICAgICAgICAgICAvLyBBdm9pZCBzaWxlbnRseSBvdmVyd3JpdGluZyBzb21lIG90aGVyICdjb21wb25lbnQnIGJpbmRpbmcgdGhhdCBtYXkgYWxyZWFkeSBiZSBvbiB0aGUgZWxlbWVudAoJICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCB1c2UgdGhlICJjb21wb25lbnQiIGJpbmRpbmcgb24gYSBjdXN0b20gZWxlbWVudCBtYXRjaGluZyBhIGNvbXBvbmVudCcpOwoJICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudEJpbmRpbmdWYWx1ZSA9IHsgJ25hbWUnOiBjb21wb25lbnROYW1lLCAncGFyYW1zJzogZ2V0Q29tcG9uZW50UGFyYW1zRnJvbUN1c3RvbUVsZW1lbnQobm9kZSwgYmluZGluZ0NvbnRleHQpIH07CgoJICAgICAgICAgICAgICAgIGFsbEJpbmRpbmdzWydjb21wb25lbnQnXSA9IHZhbHVlQWNjZXNzb3JzCgkgICAgICAgICAgICAgICAgICAgID8gZnVuY3Rpb24oKSB7IHJldHVybiBjb21wb25lbnRCaW5kaW5nVmFsdWU7IH0KCSAgICAgICAgICAgICAgICAgICAgOiBjb21wb25lbnRCaW5kaW5nVmFsdWU7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIHJldHVybiBhbGxCaW5kaW5nczsKCSAgICB9CgoJICAgIHZhciBuYXRpdmVCaW5kaW5nUHJvdmlkZXJJbnN0YW5jZSA9IG5ldyBrby5iaW5kaW5nUHJvdmlkZXIoKTsKCgkgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50UGFyYW1zRnJvbUN1c3RvbUVsZW1lbnQoZWxlbSwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgdmFyIHBhcmFtc0F0dHJpYnV0ZSA9IGVsZW0uZ2V0QXR0cmlidXRlKCdwYXJhbXMnKTsKCgkgICAgICAgIGlmIChwYXJhbXNBdHRyaWJ1dGUpIHsKCSAgICAgICAgICAgIHZhciBwYXJhbXMgPSBuYXRpdmVCaW5kaW5nUHJvdmlkZXJJbnN0YW5jZVsncGFyc2VCaW5kaW5nc1N0cmluZyddKHBhcmFtc0F0dHJpYnV0ZSwgYmluZGluZ0NvbnRleHQsIGVsZW0sIHsgJ3ZhbHVlQWNjZXNzb3JzJzogdHJ1ZSwgJ2JpbmRpbmdQYXJhbXMnOiB0cnVlIH0pLAoJICAgICAgICAgICAgICAgIHJhd1BhcmFtQ29tcHV0ZWRWYWx1ZXMgPSBrby51dGlscy5vYmplY3RNYXAocGFyYW1zLCBmdW5jdGlvbihwYXJhbVZhbHVlLCBwYXJhbU5hbWUpIHsKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLmNvbXB1dGVkKHBhcmFtVmFsdWUsIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBlbGVtIH0pOwoJICAgICAgICAgICAgICAgIH0pLAoJICAgICAgICAgICAgICAgIHJlc3VsdCA9IGtvLnV0aWxzLm9iamVjdE1hcChyYXdQYXJhbUNvbXB1dGVkVmFsdWVzLCBmdW5jdGlvbihwYXJhbVZhbHVlQ29tcHV0ZWQsIHBhcmFtTmFtZSkgewoJICAgICAgICAgICAgICAgICAgICAvLyBEb2VzIHRoZSBldmFsdWF0aW9uIG9mIHRoZSBwYXJhbWV0ZXIgdmFsdWUgdW53cmFwIGFueSBvYnNlcnZhYmxlcz8KCSAgICAgICAgICAgICAgICAgICAgaWYgKCFwYXJhbVZhbHVlQ29tcHV0ZWQuaXNBY3RpdmUoKSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm8gaXQgZG9lc24ndCwgc28gdGhlcmUncyBubyBuZWVkIGZvciBhbnkgY29tcHV0ZWQgd3JhcHBlci4gSnVzdCBwYXNzIHRocm91Z2ggdGhlIHN1cHBsaWVkIHZhbHVlIGRpcmVjdGx5LgoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gRXhhbXBsZTogInNvbWVWYWw6IGZpcnN0TmFtZSwgYWdlOiAxMjMiICh3aGV0aGVyIG9yIG5vdCBmaXJzdE5hbWUgaXMgYW4gb2JzZXJ2YWJsZS9jb21wdXRlZCkKCSAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJhbVZhbHVlQ29tcHV0ZWQucGVlaygpOwoJICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gWWVzIGl0IGRvZXMuIFN1cHBseSBhIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgdW53cmFwcyBib3RoIHRoZSBvdXRlciAoYmluZGluZyBleHByZXNzaW9uKQoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGV2ZWwgb2Ygb2JzZXJ2YWJpbGl0eSwgYW5kIGFueSBpbm5lciAocmVzdWx0aW5nIG1vZGVsIHZhbHVlKSBsZXZlbCBvZiBvYnNlcnZhYmlsaXR5LgoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBtZWFucyB0aGUgY29tcG9uZW50IGRvZXNuJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCBtdWx0aXBsZSB1bndyYXBwaW5nLgoJICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHBhcmFtVmFsdWVDb21wdXRlZCgpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0sIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBlbGVtIH0pOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfSk7CgoJICAgICAgICAgICAgLy8gR2l2ZSBhY2Nlc3MgdG8gdGhlIHJhdyBjb21wdXRlZHMsIGFzIGxvbmcgYXMgdGhhdCB3b3VsZG4ndCBvdmVyd3JpdGUgYW55IGN1c3RvbSBwYXJhbSBhbHNvIGNhbGxlZCAnJHJhdycKCSAgICAgICAgICAgIC8vIFRoaXMgaXMgaW4gY2FzZSB0aGUgZGV2ZWxvcGVyIHdhbnRzIHRvIHJlYWN0IHRvIG91dGVyIChiaW5kaW5nKSBvYnNlcnZhYmlsaXR5IHNlcGFyYXRlbHkgZnJvbSBpbm5lcgoJICAgICAgICAgICAgLy8gKG1vZGVsIHZhbHVlKSBvYnNlcnZhYmlsaXR5LCBvciBpbiBjYXNlIHRoZSBtb2RlbCB2YWx1ZSBvYnNlcnZhYmxlIGhhcyBzdWJvYnNlcnZhYmxlcy4KCSAgICAgICAgICAgIGlmICghcmVzdWx0Lmhhc093blByb3BlcnR5KCckcmF3JykpIHsKCSAgICAgICAgICAgICAgICByZXN1bHRbJyRyYXcnXSA9IHJhd1BhcmFtQ29tcHV0ZWRWYWx1ZXM7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIC8vIEZvciBjb25zaXN0ZW5jeSwgYWJzZW5jZSBvZiBhICJwYXJhbXMiIGF0dHJpYnV0ZSBpcyB0cmVhdGVkIHRoZSBzYW1lIGFzIHRoZSBwcmVzZW5jZSBvZgoJICAgICAgICAgICAgLy8gYW55IGVtcHR5IG9uZS4gT3RoZXJ3aXNlIGNvbXBvbmVudCB2aWV3bW9kZWxzIG5lZWQgc3BlY2lhbCBjb2RlIHRvIGNoZWNrIHdoZXRoZXIgb3Igbm90CgkgICAgICAgICAgICAvLyAncGFyYW1zJyBvciAncGFyYW1zLiRyYXcnIGlzIG51bGwvdW5kZWZpbmVkIGJlZm9yZSByZWFkaW5nIHN1YnByb3BlcnRpZXMsIHdoaWNoIGlzIGFubm95aW5nLgoJICAgICAgICAgICAgcmV0dXJuIHsgJyRyYXcnOiB7fSB9OwoJICAgICAgICB9CgkgICAgfQoKCSAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoJICAgIC8vIENvbXBhdGliaWxpdHkgY29kZSBmb3Igb2xkZXIgKHByZS1IVE1MNSkgSUUgYnJvd3NlcnMKCgkgICAgaWYgKGtvLnV0aWxzLmllVmVyc2lvbiA8IDkpIHsKCSAgICAgICAgLy8gV2hlbmV2ZXIgeW91IHByZXJlZ2lzdGVyIGEgY29tcG9uZW50LCBlbmFibGUgaXQgYXMgYSBjdXN0b20gZWxlbWVudCBpbiB0aGUgY3VycmVudCBkb2N1bWVudAoJICAgICAgICBrby5jb21wb25lbnRzWydyZWdpc3RlciddID0gKGZ1bmN0aW9uKG9yaWdpbmFsRnVuY3Rpb24pIHsKCSAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihjb21wb25lbnROYW1lKSB7CgkgICAgICAgICAgICAgICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudChjb21wb25lbnROYW1lKTsgLy8gQWxsb3dzIElFPDkgdG8gcGFyc2UgbWFya3VwIGNvbnRhaW5pbmcgdGhlIGN1c3RvbSBlbGVtZW50CgkgICAgICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsRnVuY3Rpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSkoa28uY29tcG9uZW50c1sncmVnaXN0ZXInXSk7CgoJICAgICAgICAvLyBXaGVuZXZlciB5b3UgY3JlYXRlIGEgZG9jdW1lbnQgZnJhZ21lbnQsIGVuYWJsZSBhbGwgcHJlcmVnaXN0ZXJlZCBjb21wb25lbnQgbmFtZXMgYXMgY3VzdG9tIGVsZW1lbnRzCgkgICAgICAgIC8vIFRoaXMgaXMgbmVlZGVkIHRvIG1ha2UgaW5uZXJTaGl2L2pRdWVyeSBIVE1MIHBhcnNpbmcgY29ycmVjdGx5IGhhbmRsZSB0aGUgY3VzdG9tIGVsZW1lbnRzCgkgICAgICAgIGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQgPSAoZnVuY3Rpb24ob3JpZ2luYWxGdW5jdGlvbikgewoJICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgIHZhciBuZXdEb2NGcmFnID0gb3JpZ2luYWxGdW5jdGlvbigpLAoJICAgICAgICAgICAgICAgICAgICBhbGxDb21wb25lbnRzID0ga28uY29tcG9uZW50cy5fYWxsUmVnaXN0ZXJlZENvbXBvbmVudHM7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgY29tcG9uZW50TmFtZSBpbiBhbGxDb21wb25lbnRzKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChhbGxDb21wb25lbnRzLmhhc093blByb3BlcnR5KGNvbXBvbmVudE5hbWUpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBuZXdEb2NGcmFnLmNyZWF0ZUVsZW1lbnQoY29tcG9uZW50TmFtZSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgcmV0dXJuIG5ld0RvY0ZyYWc7CgkgICAgICAgICAgICB9OwoJICAgICAgICB9KShkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KTsKCSAgICB9Cgl9KSgpOyhmdW5jdGlvbih1bmRlZmluZWQpIHsKCgkgICAgdmFyIGNvbXBvbmVudExvYWRpbmdPcGVyYXRpb25VbmlxdWVJZCA9IDA7CgoJICAgIGtvLmJpbmRpbmdIYW5kbGVyc1snY29tcG9uZW50J10gPSB7CgkgICAgICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgaWdub3JlZDEsIGlnbm9yZWQyLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAgICAgdmFyIGN1cnJlbnRWaWV3TW9kZWwsCgkgICAgICAgICAgICAgICAgY3VycmVudExvYWRpbmdPcGVyYXRpb25JZCwKCSAgICAgICAgICAgICAgICBkaXNwb3NlQXNzb2NpYXRlZENvbXBvbmVudFZpZXdNb2RlbCA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRWaWV3TW9kZWxEaXNwb3NlID0gY3VycmVudFZpZXdNb2RlbCAmJiBjdXJyZW50Vmlld01vZGVsWydkaXNwb3NlJ107CgkgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY3VycmVudFZpZXdNb2RlbERpc3Bvc2UgPT09ICdmdW5jdGlvbicpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3TW9kZWxEaXNwb3NlLmNhbGwoY3VycmVudFZpZXdNb2RlbCk7CgkgICAgICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgICAgIC8vIEFueSBpbi1mbGlnaHQgbG9hZGluZyBvcGVyYXRpb24gaXMgbm8gbG9uZ2VyIHJlbGV2YW50LCBzbyBtYWtlIHN1cmUgd2UgaWdub3JlIGl0cyBjb21wbGV0aW9uCgkgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRMb2FkaW5nT3BlcmF0aW9uSWQgPSBudWxsOwoJICAgICAgICAgICAgICAgIH07CgoJICAgICAgICAgICAga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayhlbGVtZW50LCBkaXNwb3NlQXNzb2NpYXRlZENvbXBvbmVudFZpZXdNb2RlbCk7CgoJICAgICAgICAgICAga28uY29tcHV0ZWQoZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKSwKCSAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50TmFtZSwgY29tcG9uZW50UGFyYW1zOwoKCSAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewoJICAgICAgICAgICAgICAgICAgICBjb21wb25lbnROYW1lID0gdmFsdWU7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50TmFtZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVbJ25hbWUnXSk7CgkgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudFBhcmFtcyA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVbJ3BhcmFtcyddKTsKCSAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgIGlmICghY29tcG9uZW50TmFtZSkgewoJICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGNvbXBvbmVudCBuYW1lIHNwZWNpZmllZCcpOwoJICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgdmFyIGxvYWRpbmdPcGVyYXRpb25JZCA9IGN1cnJlbnRMb2FkaW5nT3BlcmF0aW9uSWQgPSArK2NvbXBvbmVudExvYWRpbmdPcGVyYXRpb25VbmlxdWVJZDsKCSAgICAgICAgICAgICAgICBrby5jb21wb25lbnRzLmdldChjb21wb25lbnROYW1lLCBmdW5jdGlvbihjb21wb25lbnREZWZpbml0aW9uKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgaXMgbm90IHRoZSBjdXJyZW50IGxvYWQgb3BlcmF0aW9uIGZvciB0aGlzIGVsZW1lbnQsIGlnbm9yZSBpdC4KCSAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRMb2FkaW5nT3BlcmF0aW9uSWQgIT09IGxvYWRpbmdPcGVyYXRpb25JZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgICAgICAvLyBDbGVhbiB1cCBwcmV2aW91cyBzdGF0ZQoJICAgICAgICAgICAgICAgICAgICBkaXNwb3NlQXNzb2NpYXRlZENvbXBvbmVudFZpZXdNb2RlbCgpOwoKCSAgICAgICAgICAgICAgICAgICAgLy8gSW5zdGFudGlhdGUgYW5kIGJpbmQgbmV3IGNvbXBvbmVudC4gSW1wbGljaXRseSB0aGlzIGNsZWFucyBhbnkgb2xkIERPTSBub2Rlcy4KCSAgICAgICAgICAgICAgICAgICAgaWYgKCFjb21wb25lbnREZWZpbml0aW9uKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gY29tcG9uZW50IFwnJyArIGNvbXBvbmVudE5hbWUgKyAnXCcnKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBjbG9uZVRlbXBsYXRlSW50b0VsZW1lbnQoY29tcG9uZW50TmFtZSwgY29tcG9uZW50RGVmaW5pdGlvbiwgZWxlbWVudCk7CgkgICAgICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnRWaWV3TW9kZWwgPSBjcmVhdGVWaWV3TW9kZWwoY29tcG9uZW50RGVmaW5pdGlvbiwgZWxlbWVudCwgY29tcG9uZW50UGFyYW1zKSwKCSAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkQmluZGluZ0NvbnRleHQgPSBiaW5kaW5nQ29udGV4dFsnY3JlYXRlQ2hpbGRDb250ZXh0J10oY29tcG9uZW50Vmlld01vZGVsKTsKCSAgICAgICAgICAgICAgICAgICAgY3VycmVudFZpZXdNb2RlbCA9IGNvbXBvbmVudFZpZXdNb2RlbDsKCSAgICAgICAgICAgICAgICAgICAga28uYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHMoY2hpbGRCaW5kaW5nQ29udGV4dCwgZWxlbWVudCk7CgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogZWxlbWVudCB9KTsKCgkgICAgICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICBrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWydjb21wb25lbnQnXSA9IHRydWU7CgoJICAgIGZ1bmN0aW9uIGNsb25lVGVtcGxhdGVJbnRvRWxlbWVudChjb21wb25lbnROYW1lLCBjb21wb25lbnREZWZpbml0aW9uLCBlbGVtZW50KSB7CgkgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGNvbXBvbmVudERlZmluaXRpb25bJ3RlbXBsYXRlJ107CgkgICAgICAgIGlmICghdGVtcGxhdGUpIHsKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcG9uZW50IFwnJyArIGNvbXBvbmVudE5hbWUgKyAnXCcgaGFzIG5vIHRlbXBsYXRlJyk7CgkgICAgICAgIH0KCgkgICAgICAgIHZhciBjbG9uZWROb2Rlc0FycmF5ID0ga28udXRpbHMuY2xvbmVOb2Rlcyh0ZW1wbGF0ZSk7CgkgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4oZWxlbWVudCwgY2xvbmVkTm9kZXNBcnJheSk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBjcmVhdGVWaWV3TW9kZWwoY29tcG9uZW50RGVmaW5pdGlvbiwgZWxlbWVudCwgY29tcG9uZW50UGFyYW1zKSB7CgkgICAgICAgIHZhciBjb21wb25lbnRWaWV3TW9kZWxGYWN0b3J5ID0gY29tcG9uZW50RGVmaW5pdGlvblsnY3JlYXRlVmlld01vZGVsJ107CgkgICAgICAgIHJldHVybiBjb21wb25lbnRWaWV3TW9kZWxGYWN0b3J5CgkgICAgICAgICAgICA/IGNvbXBvbmVudFZpZXdNb2RlbEZhY3RvcnkuY2FsbChjb21wb25lbnREZWZpbml0aW9uLCBjb21wb25lbnRQYXJhbXMsIHsgZWxlbWVudDogZWxlbWVudCB9KQoJICAgICAgICAgICAgOiBjb21wb25lbnRQYXJhbXM7IC8vIFRlbXBsYXRlLW9ubHkgY29tcG9uZW50CgkgICAgfQoKCX0pKCk7Cgl2YXIgYXR0ckh0bWxUb0phdmFzY3JpcHRNYXAgPSB7ICdjbGFzcyc6ICdjbGFzc05hbWUnLCAnZm9yJzogJ2h0bWxGb3InIH07Cglrby5iaW5kaW5nSGFuZGxlcnNbJ2F0dHInXSA9IHsKCSAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MpIHsKCSAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpIHx8IHt9OwoJICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKHZhbHVlLCBmdW5jdGlvbihhdHRyTmFtZSwgYXR0clZhbHVlKSB7CgkgICAgICAgICAgICBhdHRyVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGF0dHJWYWx1ZSk7CgoJICAgICAgICAgICAgLy8gVG8gY292ZXIgY2FzZXMgbGlrZSAiYXR0cjogeyBjaGVja2VkOnNvbWVQcm9wIH0iLCB3ZSB3YW50IHRvIHJlbW92ZSB0aGUgYXR0cmlidXRlIGVudGlyZWx5CgkgICAgICAgICAgICAvLyB3aGVuIHNvbWVQcm9wIGlzIGEgIm5vIHZhbHVlIi1saWtlIHZhbHVlIChzdHJpY3RseSBudWxsLCBmYWxzZSwgb3IgdW5kZWZpbmVkKQoJICAgICAgICAgICAgLy8gKGJlY2F1c2UgdGhlIGFic2VuY2Ugb2YgdGhlICJjaGVja2VkIiBhdHRyIGlzIGhvdyB0byBtYXJrIGFuIGVsZW1lbnQgYXMgbm90IGNoZWNrZWQsIGV0Yy4pCgkgICAgICAgICAgICB2YXIgdG9SZW1vdmUgPSAoYXR0clZhbHVlID09PSBmYWxzZSkgfHwgKGF0dHJWYWx1ZSA9PT0gbnVsbCkgfHwgKGF0dHJWYWx1ZSA9PT0gdW5kZWZpbmVkKTsKCSAgICAgICAgICAgIGlmICh0b1JlbW92ZSkKCSAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShhdHRyTmFtZSk7CgoJICAgICAgICAgICAgLy8gSW4gSUUgPD0gNyBhbmQgSUU4IFF1aXJrcyBNb2RlLCB5b3UgaGF2ZSB0byB1c2UgdGhlIEphdmFzY3JpcHQgcHJvcGVydHkgbmFtZSBpbnN0ZWFkIG9mIHRoZQoJICAgICAgICAgICAgLy8gSFRNTCBhdHRyaWJ1dGUgbmFtZSBmb3IgY2VydGFpbiBhdHRyaWJ1dGVzLiBJRTggU3RhbmRhcmRzIE1vZGUgc3VwcG9ydHMgdGhlIGNvcnJlY3QgYmVoYXZpb3IsCgkgICAgICAgICAgICAvLyBidXQgaW5zdGVhZCBvZiBmaWd1cmluZyBvdXQgdGhlIG1vZGUsIHdlJ2xsIGp1c3Qgc2V0IHRoZSBhdHRyaWJ1dGUgdGhyb3VnaCB0aGUgSmF2YXNjcmlwdAoJICAgICAgICAgICAgLy8gcHJvcGVydHkgZm9yIElFIDw9IDguCgkgICAgICAgICAgICBpZiAoa28udXRpbHMuaWVWZXJzaW9uIDw9IDggJiYgYXR0ck5hbWUgaW4gYXR0ckh0bWxUb0phdmFzY3JpcHRNYXApIHsKCSAgICAgICAgICAgICAgICBhdHRyTmFtZSA9IGF0dHJIdG1sVG9KYXZhc2NyaXB0TWFwW2F0dHJOYW1lXTsKCSAgICAgICAgICAgICAgICBpZiAodG9SZW1vdmUpCgkgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGF0dHJOYW1lKTsKCSAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbYXR0ck5hbWVdID0gYXR0clZhbHVlOwoJICAgICAgICAgICAgfSBlbHNlIGlmICghdG9SZW1vdmUpIHsKCSAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgYXR0clZhbHVlLnRvU3RyaW5nKCkpOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIC8vIFRyZWF0ICJuYW1lIiBzcGVjaWFsbHkgLSBhbHRob3VnaCB5b3UgY2FuIHRoaW5rIG9mIGl0IGFzIGFuIGF0dHJpYnV0ZSwgaXQgYWxzbyBuZWVkcwoJICAgICAgICAgICAgLy8gc3BlY2lhbCBoYW5kbGluZyBvbiBvbGRlciB2ZXJzaW9ucyBvZiBJRSAoaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvMzMzKQoJICAgICAgICAgICAgLy8gRGVsaWJlcmF0ZWx5IGJlaW5nIGNhc2Utc2Vuc2l0aXZlIGhlcmUgYmVjYXVzZSBYSFRNTCB3b3VsZCByZWdhcmQgIk5hbWUiIGFzIGEgZGlmZmVyZW50IHRoaW5nCgkgICAgICAgICAgICAvLyBlbnRpcmVseSwgYW5kIHRoZXJlJ3Mgbm8gc3Ryb25nIHJlYXNvbiB0byBhbGxvdyBmb3Igc3VjaCBjYXNpbmcgaW4gSFRNTC4KCSAgICAgICAgICAgIGlmIChhdHRyTmFtZSA9PT0gIm5hbWUiKSB7CgkgICAgICAgICAgICAgICAga28udXRpbHMuc2V0RWxlbWVudE5hbWUoZWxlbWVudCwgdG9SZW1vdmUgPyAiIiA6IGF0dHJWYWx1ZS50b1N0cmluZygpKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgfQoJfTsKCShmdW5jdGlvbigpIHsKCglrby5iaW5kaW5nSGFuZGxlcnNbJ2NoZWNrZWQnXSA9IHsKCSAgICAnYWZ0ZXInOiBbJ3ZhbHVlJywgJ2F0dHInXSwKCSAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncykgewoJICAgICAgICB2YXIgY2hlY2tlZFZhbHVlID0ga28ucHVyZUNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgLy8gVHJlYXQgInZhbHVlIiBsaWtlICJjaGVja2VkVmFsdWUiIHdoZW4gaXQgaXMgaW5jbHVkZWQgd2l0aCAiY2hlY2tlZCIgYmluZGluZwoJICAgICAgICAgICAgaWYgKGFsbEJpbmRpbmdzWydoYXMnXSgnY2hlY2tlZFZhbHVlJykpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShhbGxCaW5kaW5ncy5nZXQoJ2NoZWNrZWRWYWx1ZScpKTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAoYWxsQmluZGluZ3NbJ2hhcyddKCd2YWx1ZScpKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYWxsQmluZGluZ3MuZ2V0KCd2YWx1ZScpKTsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICByZXR1cm4gZWxlbWVudC52YWx1ZTsKCSAgICAgICAgfSk7CgoJICAgICAgICBmdW5jdGlvbiB1cGRhdGVNb2RlbCgpIHsKCSAgICAgICAgICAgIC8vIFRoaXMgdXBkYXRlcyB0aGUgbW9kZWwgdmFsdWUgZnJvbSB0aGUgdmlldyB2YWx1ZS4KCSAgICAgICAgICAgIC8vIEl0IHJ1bnMgaW4gcmVzcG9uc2UgdG8gRE9NIGV2ZW50cyAoY2xpY2spIGFuZCBjaGFuZ2VzIGluIGNoZWNrZWRWYWx1ZS4KCSAgICAgICAgICAgIHZhciBpc0NoZWNrZWQgPSBlbGVtZW50LmNoZWNrZWQsCgkgICAgICAgICAgICAgICAgZWxlbVZhbHVlID0gdXNlQ2hlY2tlZFZhbHVlID8gY2hlY2tlZFZhbHVlKCkgOiBpc0NoZWNrZWQ7CgoJICAgICAgICAgICAgLy8gV2hlbiB3ZSdyZSBmaXJzdCBzZXR0aW5nIHVwIHRoaXMgY29tcHV0ZWQsIGRvbid0IGNoYW5nZSBhbnkgbW9kZWwgc3RhdGUuCgkgICAgICAgICAgICBpZiAoa28uY29tcHV0ZWRDb250ZXh0LmlzSW5pdGlhbCgpKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIC8vIFdlIGNhbiBpZ25vcmUgdW5jaGVja2VkIHJhZGlvIGJ1dHRvbnMsIGJlY2F1c2Ugc29tZSBvdGhlciByYWRpbwoJICAgICAgICAgICAgLy8gYnV0dG9uIHdpbGwgYmUgZ2V0dGluZyBjaGVja2VkLCBhbmQgdGhhdCBvbmUgY2FuIHRha2UgY2FyZSBvZiB1cGRhdGluZyBzdGF0ZS4KCSAgICAgICAgICAgIGlmIChpc1JhZGlvICYmICFpc0NoZWNrZWQpIHsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZSh2YWx1ZUFjY2Vzc29yKTsKCSAgICAgICAgICAgIGlmIChpc1ZhbHVlQXJyYXkpIHsKCSAgICAgICAgICAgICAgICBpZiAob2xkRWxlbVZhbHVlICE9PSBlbGVtVmFsdWUpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gV2hlbiB3ZSdyZSByZXNwb25kaW5nIHRvIHRoZSBjaGVja2VkVmFsdWUgY2hhbmdpbmcsIGFuZCB0aGUgZWxlbWVudCBpcwoJICAgICAgICAgICAgICAgICAgICAvLyBjdXJyZW50bHkgY2hlY2tlZCwgcmVwbGFjZSB0aGUgb2xkIGVsZW0gdmFsdWUgd2l0aCB0aGUgbmV3IGVsZW0gdmFsdWUKCSAgICAgICAgICAgICAgICAgICAgLy8gaW4gdGhlIG1vZGVsIGFycmF5LgoJICAgICAgICAgICAgICAgICAgICBpZiAoaXNDaGVja2VkKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hZGRPclJlbW92ZUl0ZW0obW9kZWxWYWx1ZSwgZWxlbVZhbHVlLCB0cnVlKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFkZE9yUmVtb3ZlSXRlbShtb2RlbFZhbHVlLCBvbGRFbGVtVmFsdWUsIGZhbHNlKTsKCSAgICAgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAgICAgb2xkRWxlbVZhbHVlID0gZWxlbVZhbHVlOwoJICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIFdoZW4gd2UncmUgcmVzcG9uZGluZyB0byB0aGUgdXNlciBoYXZpbmcgY2hlY2tlZC91bmNoZWNrZWQgYSBjaGVja2JveCwKCSAgICAgICAgICAgICAgICAgICAgLy8gYWRkL3JlbW92ZSB0aGUgZWxlbWVudCB2YWx1ZSB0byB0aGUgbW9kZWwgYXJyYXkuCgkgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFkZE9yUmVtb3ZlSXRlbShtb2RlbFZhbHVlLCBlbGVtVmFsdWUsIGlzQ2hlY2tlZCk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzLCAnY2hlY2tlZCcsIGVsZW1WYWx1ZSwgdHJ1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH07CgoJICAgICAgICBmdW5jdGlvbiB1cGRhdGVWaWV3KCkgewoJICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGVzIHRoZSB2aWV3IHZhbHVlIGZyb20gdGhlIG1vZGVsIHZhbHVlLgoJICAgICAgICAgICAgLy8gSXQgcnVucyBpbiByZXNwb25zZSB0byBjaGFuZ2VzIGluIHRoZSBib3VuZCAoY2hlY2tlZCkgdmFsdWUuCgkgICAgICAgICAgICB2YXIgbW9kZWxWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCgkgICAgICAgICAgICBpZiAoaXNWYWx1ZUFycmF5KSB7CgkgICAgICAgICAgICAgICAgLy8gV2hlbiBhIGNoZWNrYm94IGlzIGJvdW5kIHRvIGFuIGFycmF5LCBiZWluZyBjaGVja2VkIHJlcHJlc2VudHMgaXRzIHZhbHVlIGJlaW5nIHByZXNlbnQgaW4gdGhhdCBhcnJheQoJICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihtb2RlbFZhbHVlLCBjaGVja2VkVmFsdWUoKSkgPj0gMDsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNDaGVja2JveCkgewoJICAgICAgICAgICAgICAgIC8vIFdoZW4gYSBjaGVja2JveCBpcyBib3VuZCB0byBhbnkgb3RoZXIgdmFsdWUgKG5vdCBhbiBhcnJheSksIGJlaW5nIGNoZWNrZWQgcmVwcmVzZW50cyB0aGUgdmFsdWUgYmVpbmcgdHJ1ZWlzaAoJICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IG1vZGVsVmFsdWU7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIEZvciByYWRpbyBidXR0b25zLCBiZWluZyBjaGVja2VkIG1lYW5zIHRoYXQgdGhlIHJhZGlvIGJ1dHRvbidzIHZhbHVlIGNvcnJlc3BvbmRzIHRvIHRoZSBtb2RlbCB2YWx1ZQoJICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IChjaGVja2VkVmFsdWUoKSA9PT0gbW9kZWxWYWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH07CgoJICAgICAgICB2YXIgaXNDaGVja2JveCA9IGVsZW1lbnQudHlwZSA9PSAiY2hlY2tib3giLAoJICAgICAgICAgICAgaXNSYWRpbyA9IGVsZW1lbnQudHlwZSA9PSAicmFkaW8iOwoKCSAgICAgICAgLy8gT25seSBiaW5kIHRvIGNoZWNrIGJveGVzIGFuZCByYWRpbyBidXR0b25zCgkgICAgICAgIGlmICghaXNDaGVja2JveCAmJiAhaXNSYWRpbykgewoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgoJICAgICAgICB2YXIgaXNWYWx1ZUFycmF5ID0gaXNDaGVja2JveCAmJiAoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpIGluc3RhbmNlb2YgQXJyYXkpLAoJICAgICAgICAgICAgb2xkRWxlbVZhbHVlID0gaXNWYWx1ZUFycmF5ID8gY2hlY2tlZFZhbHVlKCkgOiB1bmRlZmluZWQsCgkgICAgICAgICAgICB1c2VDaGVja2VkVmFsdWUgPSBpc1JhZGlvIHx8IGlzVmFsdWVBcnJheTsKCgkgICAgICAgIC8vIElFIDYgd29uJ3QgYWxsb3cgcmFkaW8gYnV0dG9ucyB0byBiZSBzZWxlY3RlZCB1bmxlc3MgdGhleSBoYXZlIGEgbmFtZQoJICAgICAgICBpZiAoaXNSYWRpbyAmJiAhZWxlbWVudC5uYW1lKQoJICAgICAgICAgICAga28uYmluZGluZ0hhbmRsZXJzWyd1bmlxdWVOYW1lJ11bJ2luaXQnXShlbGVtZW50LCBmdW5jdGlvbigpIHsgcmV0dXJuIHRydWUgfSk7CgoJICAgICAgICAvLyBTZXQgdXAgdHdvIGNvbXB1dGVkcyB0byB1cGRhdGUgdGhlIGJpbmRpbmc6CgoJICAgICAgICAvLyBUaGUgZmlyc3QgcmVzcG9uZHMgdG8gY2hhbmdlcyBpbiB0aGUgY2hlY2tlZFZhbHVlIHZhbHVlIGFuZCB0byBlbGVtZW50IGNsaWNrcwoJICAgICAgICBrby5jb21wdXRlZCh1cGRhdGVNb2RlbCwgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGVsZW1lbnQgfSk7CgkgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJjbGljayIsIHVwZGF0ZU1vZGVsKTsKCgkgICAgICAgIC8vIFRoZSBzZWNvbmQgcmVzcG9uZHMgdG8gY2hhbmdlcyBpbiB0aGUgbW9kZWwgdmFsdWUgKHRoZSBvbmUgYXNzb2NpYXRlZCB3aXRoIHRoZSBjaGVja2VkIGJpbmRpbmcpCgkgICAgICAgIGtvLmNvbXB1dGVkKHVwZGF0ZVZpZXcsIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBlbGVtZW50IH0pOwoJICAgIH0KCX07Cglrby5leHByZXNzaW9uUmV3cml0aW5nLnR3b1dheUJpbmRpbmdzWydjaGVja2VkJ10gPSB0cnVlOwoKCWtvLmJpbmRpbmdIYW5kbGVyc1snY2hlY2tlZFZhbHVlJ10gPSB7CgkgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIGVsZW1lbnQudmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgfQoJfTsKCgl9KSgpO3ZhciBjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleSA9ICdfX2tvX19jc3NWYWx1ZSc7Cglrby5iaW5kaW5nSGFuZGxlcnNbJ2NzcyddID0gewoJICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2godmFsdWUsIGZ1bmN0aW9uKGNsYXNzTmFtZSwgc2hvdWxkSGF2ZUNsYXNzKSB7CgkgICAgICAgICAgICAgICAgc2hvdWxkSGF2ZUNsYXNzID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShzaG91bGRIYXZlQ2xhc3MpOwoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUsIHNob3VsZEhhdmVDbGFzcyk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHZhbHVlID0gU3RyaW5nKHZhbHVlIHx8ICcnKTsgLy8gTWFrZSBzdXJlIHdlIGRvbid0IHRyeSB0byBzdG9yZSBvciBzZXQgYSBub24tc3RyaW5nIHZhbHVlCgkgICAgICAgICAgICBrby51dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MoZWxlbWVudCwgZWxlbWVudFtjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleV0sIGZhbHNlKTsKCSAgICAgICAgICAgIGVsZW1lbnRbY2xhc3Nlc1dyaXR0ZW5CeUJpbmRpbmdLZXldID0gdmFsdWU7CgkgICAgICAgICAgICBrby51dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MoZWxlbWVudCwgdmFsdWUsIHRydWUpOwoJICAgICAgICB9CgkgICAgfQoJfTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snZW5hYmxlJ10gPSB7CgkgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCSAgICAgICAgaWYgKHZhbHVlICYmIGVsZW1lbnQuZGlzYWJsZWQpCgkgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSgiZGlzYWJsZWQiKTsKCSAgICAgICAgZWxzZSBpZiAoKCF2YWx1ZSkgJiYgKCFlbGVtZW50LmRpc2FibGVkKSkKCSAgICAgICAgICAgIGVsZW1lbnQuZGlzYWJsZWQgPSB0cnVlOwoJICAgIH0KCX07CgoJa28uYmluZGluZ0hhbmRsZXJzWydkaXNhYmxlJ10gPSB7CgkgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIGtvLmJpbmRpbmdIYW5kbGVyc1snZW5hYmxlJ11bJ3VwZGF0ZSddKGVsZW1lbnQsIGZ1bmN0aW9uKCkgeyByZXR1cm4gIWtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKSB9KTsKCSAgICB9Cgl9OwoJLy8gRm9yIGNlcnRhaW4gY29tbW9uIGV2ZW50cyAoY3VycmVudGx5IGp1c3QgJ2NsaWNrJyksIGFsbG93IGEgc2ltcGxpZmllZCBkYXRhLWJpbmRpbmcgc3ludGF4CgkvLyBlLmcuIGNsaWNrOmhhbmRsZXIgaW5zdGVhZCBvZiB0aGUgdXN1YWwgZnVsbC1sZW5ndGggZXZlbnQ6e2NsaWNrOmhhbmRsZXJ9CglmdW5jdGlvbiBtYWtlRXZlbnRIYW5kbGVyU2hvcnRjdXQoZXZlbnROYW1lKSB7CgkgICAga28uYmluZGluZ0hhbmRsZXJzW2V2ZW50TmFtZV0gPSB7CgkgICAgICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgICAgIHZhciBuZXdWYWx1ZUFjY2Vzc29yID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSB7fTsKCSAgICAgICAgICAgICAgICByZXN1bHRbZXZlbnROYW1lXSA9IHZhbHVlQWNjZXNzb3IoKTsKCSAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIHJldHVybiBrby5iaW5kaW5nSGFuZGxlcnNbJ2V2ZW50J11bJ2luaXQnXS5jYWxsKHRoaXMsIGVsZW1lbnQsIG5ld1ZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KTsKCSAgICAgICAgfQoJICAgIH0KCX0KCglrby5iaW5kaW5nSGFuZGxlcnNbJ2V2ZW50J10gPSB7CgkgICAgJ2luaXQnIDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIHZhciBldmVudHNUb0hhbmRsZSA9IHZhbHVlQWNjZXNzb3IoKSB8fCB7fTsKCSAgICAgICAga28udXRpbHMub2JqZWN0Rm9yRWFjaChldmVudHNUb0hhbmRsZSwgZnVuY3Rpb24oZXZlbnROYW1lKSB7CgkgICAgICAgICAgICBpZiAodHlwZW9mIGV2ZW50TmFtZSA9PSAic3RyaW5nIikgewoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50TmFtZSwgZnVuY3Rpb24gKGV2ZW50KSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyUmV0dXJuVmFsdWU7CgkgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyRnVuY3Rpb24gPSB2YWx1ZUFjY2Vzc29yKClbZXZlbnROYW1lXTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKCFoYW5kbGVyRnVuY3Rpb24pCgkgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CgoJICAgICAgICAgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGFrZSBhbGwgdGhlIGV2ZW50IGFyZ3MsIGFuZCBwcmVmaXggd2l0aCB0aGUgdmlld21vZGVsCgkgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJnc0ZvckhhbmRsZXIgPSBrby51dGlscy5tYWtlQXJyYXkoYXJndW1lbnRzKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIHZpZXdNb2RlbCA9IGJpbmRpbmdDb250ZXh0WyckZGF0YSddOwoJICAgICAgICAgICAgICAgICAgICAgICAgYXJnc0ZvckhhbmRsZXIudW5zaGlmdCh2aWV3TW9kZWwpOwoJICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlclJldHVyblZhbHVlID0gaGFuZGxlckZ1bmN0aW9uLmFwcGx5KHZpZXdNb2RlbCwgYXJnc0ZvckhhbmRsZXIpOwoJICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXJSZXR1cm5WYWx1ZSAhPT0gdHJ1ZSkgeyAvLyBOb3JtYWxseSB3ZSB3YW50IHRvIHByZXZlbnQgZGVmYXVsdCBhY3Rpb24uIERldmVsb3BlciBjYW4gb3ZlcnJpZGUgdGhpcyBiZSBleHBsaWNpdGx5IHJldHVybmluZyB0cnVlLgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgICAgIHZhciBidWJibGUgPSBhbGxCaW5kaW5ncy5nZXQoZXZlbnROYW1lICsgJ0J1YmJsZScpICE9PSBmYWxzZTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKCFidWJibGUpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgIH0KCX07CgkvLyAiZm9yZWFjaDogc29tZUV4cHJlc3Npb24iIGlzIGVxdWl2YWxlbnQgdG8gInRlbXBsYXRlOiB7IGZvcmVhY2g6IHNvbWVFeHByZXNzaW9uIH0iCgkvLyAiZm9yZWFjaDogeyBkYXRhOiBzb21lRXhwcmVzc2lvbiwgYWZ0ZXJBZGQ6IG15Zm4gfSIgaXMgZXF1aXZhbGVudCB0byAidGVtcGxhdGU6IHsgZm9yZWFjaDogc29tZUV4cHJlc3Npb24sIGFmdGVyQWRkOiBteWZuIH0iCglrby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXSA9IHsKCSAgICBtYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yOiBmdW5jdGlvbih2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLAoJICAgICAgICAgICAgICAgIHVud3JhcHBlZFZhbHVlID0ga28udXRpbHMucGVla09ic2VydmFibGUobW9kZWxWYWx1ZSk7ICAgIC8vIFVud3JhcCB3aXRob3V0IHNldHRpbmcgYSBkZXBlbmRlbmN5IGhlcmUKCgkgICAgICAgICAgICAvLyBJZiB1bndyYXBwZWRWYWx1ZSBpcyB0aGUgYXJyYXksIHBhc3MgaW4gdGhlIHdyYXBwZWQgdmFsdWUgb24gaXRzIG93bgoJICAgICAgICAgICAgLy8gVGhlIHZhbHVlIHdpbGwgYmUgdW53cmFwcGVkIGFuZCB0cmFja2VkIHdpdGhpbiB0aGUgdGVtcGxhdGUgYmluZGluZwoJICAgICAgICAgICAgLy8gKFNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzUyMykKCSAgICAgICAgICAgIGlmICgoIXVud3JhcHBlZFZhbHVlKSB8fCB0eXBlb2YgdW53cmFwcGVkVmFsdWUubGVuZ3RoID09ICJudW1iZXIiKQoJICAgICAgICAgICAgICAgIHJldHVybiB7ICdmb3JlYWNoJzogbW9kZWxWYWx1ZSwgJ3RlbXBsYXRlRW5naW5lJzoga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UgfTsKCgkgICAgICAgICAgICAvLyBJZiB1bndyYXBwZWRWYWx1ZS5kYXRhIGlzIHRoZSBhcnJheSwgcHJlc2VydmUgYWxsIHJlbGV2YW50IG9wdGlvbnMgYW5kIHVud3JhcCBhZ2FpbiB2YWx1ZSBzbyB3ZSBnZXQgdXBkYXRlcwoJICAgICAgICAgICAga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtb2RlbFZhbHVlKTsKCSAgICAgICAgICAgIHJldHVybiB7CgkgICAgICAgICAgICAgICAgJ2ZvcmVhY2gnOiB1bndyYXBwZWRWYWx1ZVsnZGF0YSddLAoJICAgICAgICAgICAgICAgICdhcyc6IHVud3JhcHBlZFZhbHVlWydhcyddLAoJICAgICAgICAgICAgICAgICdpbmNsdWRlRGVzdHJveWVkJzogdW53cmFwcGVkVmFsdWVbJ2luY2x1ZGVEZXN0cm95ZWQnXSwKCSAgICAgICAgICAgICAgICAnYWZ0ZXJBZGQnOiB1bndyYXBwZWRWYWx1ZVsnYWZ0ZXJBZGQnXSwKCSAgICAgICAgICAgICAgICAnYmVmb3JlUmVtb3ZlJzogdW53cmFwcGVkVmFsdWVbJ2JlZm9yZVJlbW92ZSddLAoJICAgICAgICAgICAgICAgICdhZnRlclJlbmRlcic6IHVud3JhcHBlZFZhbHVlWydhZnRlclJlbmRlciddLAoJICAgICAgICAgICAgICAgICdiZWZvcmVNb3ZlJzogdW53cmFwcGVkVmFsdWVbJ2JlZm9yZU1vdmUnXSwKCSAgICAgICAgICAgICAgICAnYWZ0ZXJNb3ZlJzogdW53cmFwcGVkVmFsdWVbJ2FmdGVyTW92ZSddLAoJICAgICAgICAgICAgICAgICd0ZW1wbGF0ZUVuZ2luZSc6IGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLmluc3RhbmNlCgkgICAgICAgICAgICB9OwoJICAgICAgICB9OwoJICAgIH0sCgkgICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWydpbml0J10oZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzWydmb3JlYWNoJ10ubWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3Nvcih2YWx1ZUFjY2Vzc29yKSk7CgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1sndGVtcGxhdGUnXVsndXBkYXRlJ10oZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzWydmb3JlYWNoJ10ubWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3Nvcih2YWx1ZUFjY2Vzc29yKSwgYWxsQmluZGluZ3MsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpOwoJICAgIH0KCX07Cglrby5leHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9yc1snZm9yZWFjaCddID0gZmFsc2U7IC8vIENhbid0IHJld3JpdGUgY29udHJvbCBmbG93IGJpbmRpbmdzCglrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWydmb3JlYWNoJ10gPSB0cnVlOwoJdmFyIGhhc2ZvY3VzVXBkYXRpbmdQcm9wZXJ0eSA9ICdfX2tvX2hhc2ZvY3VzVXBkYXRpbmcnOwoJdmFyIGhhc2ZvY3VzTGFzdFZhbHVlID0gJ19fa29faGFzZm9jdXNMYXN0VmFsdWUnOwoJa28uYmluZGluZ0hhbmRsZXJzWydoYXNmb2N1cyddID0gewoJICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MpIHsKCSAgICAgICAgdmFyIGhhbmRsZUVsZW1lbnRGb2N1c0NoYW5nZSA9IGZ1bmN0aW9uKGlzRm9jdXNlZCkgewoJICAgICAgICAgICAgLy8gV2hlcmUgcG9zc2libGUsIGlnbm9yZSB3aGljaCBldmVudCB3YXMgcmFpc2VkIGFuZCBkZXRlcm1pbmUgZm9jdXMgc3RhdGUgdXNpbmcgYWN0aXZlRWxlbWVudCwKCSAgICAgICAgICAgIC8vIGFzIHRoaXMgYXZvaWRzIHBoYW50b20gZm9jdXMvYmx1ciBldmVudHMgcmFpc2VkIHdoZW4gY2hhbmdpbmcgdGFicyBpbiBtb2Rlcm4gYnJvd3NlcnMuCgkgICAgICAgICAgICAvLyBIb3dldmVyLCBub3QgYWxsIEtPLXRhcmdldGVkIGJyb3dzZXJzIChGaXJlZm94IDIpIHN1cHBvcnQgYWN0aXZlRWxlbWVudC4gRm9yIHRob3NlIGJyb3dzZXJzLAoJICAgICAgICAgICAgLy8gcHJldmVudCBhIGxvc3Mgb2YgZm9jdXMgd2hlbiBjaGFuZ2luZyB0YWJzL3dpbmRvd3MgYnkgc2V0dGluZyBhIGZsYWcgdGhhdCBwcmV2ZW50cyBoYXNmb2N1cwoJICAgICAgICAgICAgLy8gZnJvbSBjYWxsaW5nICdibHVyKCknIG9uIHRoZSBlbGVtZW50IHdoZW4gaXQgbG9zZXMgZm9jdXMuCgkgICAgICAgICAgICAvLyBEaXNjdXNzaW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9wdWxsLzM1MgoJICAgICAgICAgICAgZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldID0gdHJ1ZTsKCSAgICAgICAgICAgIHZhciBvd25lckRvYyA9IGVsZW1lbnQub3duZXJEb2N1bWVudDsKCSAgICAgICAgICAgIGlmICgiYWN0aXZlRWxlbWVudCIgaW4gb3duZXJEb2MpIHsKCSAgICAgICAgICAgICAgICB2YXIgYWN0aXZlOwoJICAgICAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgICAgIGFjdGl2ZSA9IG93bmVyRG9jLmFjdGl2ZUVsZW1lbnQ7CgkgICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIElFOSB0aHJvd3MgaWYgeW91IGFjY2VzcyBhY3RpdmVFbGVtZW50IGR1cmluZyBwYWdlIGxvYWQgKHNlZSBpc3N1ZSAjNzAzKQoJICAgICAgICAgICAgICAgICAgICBhY3RpdmUgPSBvd25lckRvYy5ib2R5OwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpc0ZvY3VzZWQgPSAoYWN0aXZlID09PSBlbGVtZW50KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpOwoJICAgICAgICAgICAga28uZXhwcmVzc2lvblJld3JpdGluZy53cml0ZVZhbHVlVG9Qcm9wZXJ0eShtb2RlbFZhbHVlLCBhbGxCaW5kaW5ncywgJ2hhc2ZvY3VzJywgaXNGb2N1c2VkLCB0cnVlKTsKCgkgICAgICAgICAgICAvL2NhY2hlIHRoZSBsYXRlc3QgdmFsdWUsIHNvIHdlIGNhbiBhdm9pZCB1bm5lY2Vzc2FyaWx5IGNhbGxpbmcgZm9jdXMvYmx1ciBpbiB0aGUgdXBkYXRlIGZ1bmN0aW9uCgkgICAgICAgICAgICBlbGVtZW50W2hhc2ZvY3VzTGFzdFZhbHVlXSA9IGlzRm9jdXNlZDsKCSAgICAgICAgICAgIGVsZW1lbnRbaGFzZm9jdXNVcGRhdGluZ1Byb3BlcnR5XSA9IGZhbHNlOwoJICAgICAgICB9OwoJICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzSW4gPSBoYW5kbGVFbGVtZW50Rm9jdXNDaGFuZ2UuYmluZChudWxsLCB0cnVlKTsKCSAgICAgICAgdmFyIGhhbmRsZUVsZW1lbnRGb2N1c091dCA9IGhhbmRsZUVsZW1lbnRGb2N1c0NoYW5nZS5iaW5kKG51bGwsIGZhbHNlKTsKCgkgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJmb2N1cyIsIGhhbmRsZUVsZW1lbnRGb2N1c0luKTsKCSAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3VzaW4iLCBoYW5kbGVFbGVtZW50Rm9jdXNJbik7IC8vIEZvciBJRQoJICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiYmx1ciIsICBoYW5kbGVFbGVtZW50Rm9jdXNPdXQpOwoJICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiZm9jdXNvdXQiLCAgaGFuZGxlRWxlbWVudEZvY3VzT3V0KTsgLy8gRm9yIElFCgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICB2YXIgdmFsdWUgPSAhIWtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsgLy9mb3JjZSBib29sZWFuIHRvIGNvbXBhcmUgd2l0aCBsYXN0IHZhbHVlCgkgICAgICAgIGlmICghZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldICYmIGVsZW1lbnRbaGFzZm9jdXNMYXN0VmFsdWVdICE9PSB2YWx1ZSkgewoJICAgICAgICAgICAgdmFsdWUgPyBlbGVtZW50LmZvY3VzKCkgOiBlbGVtZW50LmJsdXIoKTsKCSAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsIHZhbHVlID8gImZvY3VzaW4iIDogImZvY3Vzb3V0Il0pOyAvLyBGb3IgSUUsIHdoaWNoIGRvZXNuJ3QgcmVsaWFibHkgZmlyZSAiZm9jdXMiIG9yICJibHVyIiBldmVudHMgc3luY2hyb25vdXNseQoJICAgICAgICB9CgkgICAgfQoJfTsKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcudHdvV2F5QmluZGluZ3NbJ2hhc2ZvY3VzJ10gPSB0cnVlOwoKCWtvLmJpbmRpbmdIYW5kbGVyc1snaGFzRm9jdXMnXSA9IGtvLmJpbmRpbmdIYW5kbGVyc1snaGFzZm9jdXMnXTsgLy8gTWFrZSAiaGFzRm9jdXMiIGFuIGFsaWFzCglrby5leHByZXNzaW9uUmV3cml0aW5nLnR3b1dheUJpbmRpbmdzWydoYXNGb2N1cyddID0gdHJ1ZTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snaHRtbCddID0gewoJICAgICdpbml0JzogZnVuY3Rpb24oKSB7CgkgICAgICAgIC8vIFByZXZlbnQgYmluZGluZyBvbiB0aGUgZHluYW1pY2FsbHktaW5qZWN0ZWQgSFRNTCAoYXMgZGV2ZWxvcGVycyBhcmUgdW5saWtlbHkgdG8gZXhwZWN0IHRoYXQsIGFuZCBpdCBoYXMgc2VjdXJpdHkgaW1wbGljYXRpb25zKQoJICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgLy8gc2V0SHRtbCB3aWxsIHVud3JhcCB0aGUgdmFsdWUgaWYgbmVlZGVkCgkgICAgICAgIGtvLnV0aWxzLnNldEh0bWwoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcigpKTsKCSAgICB9Cgl9OwoJLy8gTWFrZXMgYSBiaW5kaW5nIGxpa2Ugd2l0aCBvciBpZgoJZnVuY3Rpb24gbWFrZVdpdGhJZkJpbmRpbmcoYmluZGluZ0tleSwgaXNXaXRoLCBpc05vdCwgbWFrZUNvbnRleHRDYWxsYmFjaykgewoJICAgIGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XSA9IHsKCSAgICAgICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAgICAgdmFyIGRpZERpc3BsYXlPbkxhc3RVcGRhdGUsCgkgICAgICAgICAgICAgICAgc2F2ZWROb2RlczsKCSAgICAgICAgICAgIGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgIHZhciBkYXRhVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSksCgkgICAgICAgICAgICAgICAgICAgIHNob3VsZERpc3BsYXkgPSAhaXNOb3QgIT09ICFkYXRhVmFsdWUsIC8vIGVxdWl2YWxlbnQgdG8gaXNOb3QgPyAhZGF0YVZhbHVlIDogISFkYXRhVmFsdWUKCSAgICAgICAgICAgICAgICAgICAgaXNGaXJzdFJlbmRlciA9ICFzYXZlZE5vZGVzLAoJICAgICAgICAgICAgICAgICAgICBuZWVkc1JlZnJlc2ggPSBpc0ZpcnN0UmVuZGVyIHx8IGlzV2l0aCB8fCAoc2hvdWxkRGlzcGxheSAhPT0gZGlkRGlzcGxheU9uTGFzdFVwZGF0ZSk7CgoJICAgICAgICAgICAgICAgIGlmIChuZWVkc1JlZnJlc2gpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gU2F2ZSBhIGNvcHkgb2YgdGhlIGlubmVyIG5vZGVzIG9uIHRoZSBpbml0aWFsIHVwZGF0ZSwgYnV0IG9ubHkgaWYgd2UgaGF2ZSBkZXBlbmRlbmNpZXMuCgkgICAgICAgICAgICAgICAgICAgIGlmIChpc0ZpcnN0UmVuZGVyICYmIGtvLmNvbXB1dGVkQ29udGV4dC5nZXREZXBlbmRlbmNpZXNDb3VudCgpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBzYXZlZE5vZGVzID0ga28udXRpbHMuY2xvbmVOb2Rlcyhrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2RlcyhlbGVtZW50KSwgdHJ1ZSAvKiBzaG91bGRDbGVhbk5vZGVzICovKTsKCSAgICAgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZERpc3BsYXkpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNGaXJzdFJlbmRlcikgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4oZWxlbWVudCwga28udXRpbHMuY2xvbmVOb2RlcyhzYXZlZE5vZGVzKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cyhtYWtlQ29udGV4dENhbGxiYWNrID8gbWFrZUNvbnRleHRDYWxsYmFjayhiaW5kaW5nQ29udGV4dCwgZGF0YVZhbHVlKSA6IGJpbmRpbmdDb250ZXh0LCBlbGVtZW50KTsKCSAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5lbXB0eU5vZGUoZWxlbWVudCk7CgkgICAgICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgICAgIGRpZERpc3BsYXlPbkxhc3RVcGRhdGUgPSBzaG91bGREaXNwbGF5OwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0sIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBlbGVtZW50IH0pOwoJICAgICAgICAgICAgcmV0dXJuIHsgJ2NvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzJzogdHJ1ZSB9OwoJICAgICAgICB9CgkgICAgfTsKCSAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9yc1tiaW5kaW5nS2V5XSA9IGZhbHNlOyAvLyBDYW4ndCByZXdyaXRlIGNvbnRyb2wgZmxvdyBiaW5kaW5ncwoJICAgIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbYmluZGluZ0tleV0gPSB0cnVlOwoJfQoKCS8vIENvbnN0cnVjdCB0aGUgYWN0dWFsIGJpbmRpbmcgaGFuZGxlcnMKCW1ha2VXaXRoSWZCaW5kaW5nKCdpZicpOwoJbWFrZVdpdGhJZkJpbmRpbmcoJ2lmbm90JywgZmFsc2UgLyogaXNXaXRoICovLCB0cnVlIC8qIGlzTm90ICovKTsKCW1ha2VXaXRoSWZCaW5kaW5nKCd3aXRoJywgdHJ1ZSAvKiBpc1dpdGggKi8sIGZhbHNlIC8qIGlzTm90ICovLAoJICAgIGZ1bmN0aW9uKGJpbmRpbmdDb250ZXh0LCBkYXRhVmFsdWUpIHsKCSAgICAgICAgcmV0dXJuIGJpbmRpbmdDb250ZXh0WydjcmVhdGVDaGlsZENvbnRleHQnXShkYXRhVmFsdWUpOwoJICAgIH0KCSk7Cgl2YXIgY2FwdGlvblBsYWNlaG9sZGVyID0ge307Cglrby5iaW5kaW5nSGFuZGxlcnNbJ29wdGlvbnMnXSA9IHsKCSAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKCSAgICAgICAgaWYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSAhPT0gInNlbGVjdCIpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIm9wdGlvbnMgYmluZGluZyBhcHBsaWVzIG9ubHkgdG8gU0VMRUNUIGVsZW1lbnRzIik7CgoJICAgICAgICAvLyBSZW1vdmUgYWxsIGV4aXN0aW5nIDxvcHRpb24+cy4KCSAgICAgICAgd2hpbGUgKGVsZW1lbnQubGVuZ3RoID4gMCkgewoJICAgICAgICAgICAgZWxlbWVudC5yZW1vdmUoMCk7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIEVuc3VyZXMgdGhhdCB0aGUgYmluZGluZyBwcm9jZXNzb3IgZG9lc24ndCB0cnkgdG8gYmluZCB0aGUgb3B0aW9ucwoJICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzKSB7CgkgICAgICAgIGZ1bmN0aW9uIHNlbGVjdGVkT3B0aW9ucygpIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy5hcnJheUZpbHRlcihlbGVtZW50Lm9wdGlvbnMsIGZ1bmN0aW9uIChub2RlKSB7IHJldHVybiBub2RlLnNlbGVjdGVkOyB9KTsKCSAgICAgICAgfQoKCSAgICAgICAgdmFyIHNlbGVjdFdhc1ByZXZpb3VzbHlFbXB0eSA9IGVsZW1lbnQubGVuZ3RoID09IDA7CgkgICAgICAgIHZhciBwcmV2aW91c1Njcm9sbFRvcCA9ICghc2VsZWN0V2FzUHJldmlvdXNseUVtcHR5ICYmIGVsZW1lbnQubXVsdGlwbGUpID8gZWxlbWVudC5zY3JvbGxUb3AgOiBudWxsOwoJICAgICAgICB2YXIgdW53cmFwcGVkQXJyYXkgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgICAgIHZhciBpbmNsdWRlRGVzdHJveWVkID0gYWxsQmluZGluZ3MuZ2V0KCdvcHRpb25zSW5jbHVkZURlc3Ryb3llZCcpOwoJICAgICAgICB2YXIgYXJyYXlUb0RvbU5vZGVDaGlsZHJlbk9wdGlvbnMgPSB7fTsKCSAgICAgICAgdmFyIGNhcHRpb25WYWx1ZTsKCSAgICAgICAgdmFyIGZpbHRlcmVkQXJyYXk7CgkgICAgICAgIHZhciBwcmV2aW91c1NlbGVjdGVkVmFsdWVzOwoKCSAgICAgICAgaWYgKGVsZW1lbnQubXVsdGlwbGUpIHsKCSAgICAgICAgICAgIHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMgPSBrby51dGlscy5hcnJheU1hcChzZWxlY3RlZE9wdGlvbnMoKSwga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgcHJldmlvdXNTZWxlY3RlZFZhbHVlcyA9IGVsZW1lbnQuc2VsZWN0ZWRJbmRleCA+PSAwID8gWyBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50Lm9wdGlvbnNbZWxlbWVudC5zZWxlY3RlZEluZGV4XSkgXSA6IFtdOwoJICAgICAgICB9CgoJICAgICAgICBpZiAodW53cmFwcGVkQXJyYXkpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgdW53cmFwcGVkQXJyYXkubGVuZ3RoID09ICJ1bmRlZmluZWQiKSAvLyBDb2VyY2Ugc2luZ2xlIHZhbHVlIGludG8gYXJyYXkKCSAgICAgICAgICAgICAgICB1bndyYXBwZWRBcnJheSA9IFt1bndyYXBwZWRBcnJheV07CgoJICAgICAgICAgICAgLy8gRmlsdGVyIG91dCBhbnkgZW50cmllcyBtYXJrZWQgYXMgZGVzdHJveWVkCgkgICAgICAgICAgICBmaWx0ZXJlZEFycmF5ID0ga28udXRpbHMuYXJyYXlGaWx0ZXIodW53cmFwcGVkQXJyYXksIGZ1bmN0aW9uKGl0ZW0pIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gaW5jbHVkZURlc3Ryb3llZCB8fCBpdGVtID09PSB1bmRlZmluZWQgfHwgaXRlbSA9PT0gbnVsbCB8fCAha28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShpdGVtWydfZGVzdHJveSddKTsKCSAgICAgICAgICAgIH0pOwoKCSAgICAgICAgICAgIC8vIElmIGNhcHRpb24gaXMgaW5jbHVkZWQsIGFkZCBpdCB0byB0aGUgYXJyYXkKCSAgICAgICAgICAgIGlmIChhbGxCaW5kaW5nc1snaGFzJ10oJ29wdGlvbnNDYXB0aW9uJykpIHsKCSAgICAgICAgICAgICAgICBjYXB0aW9uVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFsbEJpbmRpbmdzLmdldCgnb3B0aW9uc0NhcHRpb24nKSk7CgkgICAgICAgICAgICAgICAgLy8gSWYgY2FwdGlvbiB2YWx1ZSBpcyBudWxsIG9yIHVuZGVmaW5lZCwgZG9uJ3Qgc2hvdyBhIGNhcHRpb24KCSAgICAgICAgICAgICAgICBpZiAoY2FwdGlvblZhbHVlICE9PSBudWxsICYmIGNhcHRpb25WYWx1ZSAhPT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICAgICAgICAgIGZpbHRlcmVkQXJyYXkudW5zaGlmdChjYXB0aW9uUGxhY2Vob2xkZXIpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIC8vIElmIGEgZmFsc3kgdmFsdWUgaXMgcHJvdmlkZWQgKGUuZy4gbnVsbCksIHdlJ2xsIHNpbXBseSBlbXB0eSB0aGUgc2VsZWN0IGVsZW1lbnQKCSAgICAgICAgfQoKCSAgICAgICAgZnVuY3Rpb24gYXBwbHlUb09iamVjdChvYmplY3QsIHByZWRpY2F0ZSwgZGVmYXVsdFZhbHVlKSB7CgkgICAgICAgICAgICB2YXIgcHJlZGljYXRlVHlwZSA9IHR5cGVvZiBwcmVkaWNhdGU7CgkgICAgICAgICAgICBpZiAocHJlZGljYXRlVHlwZSA9PSAiZnVuY3Rpb24iKSAgICAvLyBHaXZlbiBhIGZ1bmN0aW9uOyBydW4gaXQgYWdhaW5zdCB0aGUgZGF0YSB2YWx1ZQoJICAgICAgICAgICAgICAgIHJldHVybiBwcmVkaWNhdGUob2JqZWN0KTsKCSAgICAgICAgICAgIGVsc2UgaWYgKHByZWRpY2F0ZVR5cGUgPT0gInN0cmluZyIpIC8vIEdpdmVuIGEgc3RyaW5nOyB0cmVhdCBpdCBhcyBhIHByb3BlcnR5IG5hbWUgb24gdGhlIGRhdGEgdmFsdWUKCSAgICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0W3ByZWRpY2F0ZV07CgkgICAgICAgICAgICBlbHNlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBHaXZlbiBubyBvcHRpb25zVGV4dCBhcmc7IHVzZSB0aGUgZGF0YSB2YWx1ZSBpdHNlbGYKCSAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwoJICAgICAgICB9CgoJICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9ucyBjYW4gcnVuIGF0IHR3byBkaWZmZXJlbnQgdGltZXM6CgkgICAgICAgIC8vIFRoZSBmaXJzdCBpcyB3aGVuIHRoZSB3aG9sZSBhcnJheSBpcyBiZWluZyB1cGRhdGVkIGRpcmVjdGx5IGZyb20gdGhpcyBiaW5kaW5nIGhhbmRsZXIuCgkgICAgICAgIC8vIFRoZSBzZWNvbmQgaXMgd2hlbiBhbiBvYnNlcnZhYmxlIHZhbHVlIGZvciBhIHNwZWNpZmljIGFycmF5IGVudHJ5IGlzIHVwZGF0ZWQuCgkgICAgICAgIC8vIG9sZE9wdGlvbnMgd2lsbCBiZSBlbXB0eSBpbiB0aGUgZmlyc3QgY2FzZSwgYnV0IHdpbGwgYmUgZmlsbGVkIHdpdGggdGhlIHByZXZpb3VzbHkgZ2VuZXJhdGVkIG9wdGlvbiBpbiB0aGUgc2Vjb25kLgoJICAgICAgICB2YXIgaXRlbVVwZGF0ZSA9IGZhbHNlOwoJICAgICAgICBmdW5jdGlvbiBvcHRpb25Gb3JBcnJheUl0ZW0oYXJyYXlFbnRyeSwgaW5kZXgsIG9sZE9wdGlvbnMpIHsKCSAgICAgICAgICAgIGlmIChvbGRPcHRpb25zLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMgPSBvbGRPcHRpb25zWzBdLnNlbGVjdGVkID8gWyBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShvbGRPcHRpb25zWzBdKSBdIDogW107CgkgICAgICAgICAgICAgICAgaXRlbVVwZGF0ZSA9IHRydWU7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICB2YXIgb3B0aW9uID0gZWxlbWVudC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpOwoJICAgICAgICAgICAgaWYgKGFycmF5RW50cnkgPT09IGNhcHRpb25QbGFjZWhvbGRlcikgewoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldFRleHRDb250ZW50KG9wdGlvbiwgYWxsQmluZGluZ3MuZ2V0KCdvcHRpb25zQ2FwdGlvbicpKTsKCSAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUob3B0aW9uLCB1bmRlZmluZWQpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAvLyBBcHBseSBhIHZhbHVlIHRvIHRoZSBvcHRpb24gZWxlbWVudAoJICAgICAgICAgICAgICAgIHZhciBvcHRpb25WYWx1ZSA9IGFwcGx5VG9PYmplY3QoYXJyYXlFbnRyeSwgYWxsQmluZGluZ3MuZ2V0KCdvcHRpb25zVmFsdWUnKSwgYXJyYXlFbnRyeSk7CgkgICAgICAgICAgICAgICAga28uc2VsZWN0RXh0ZW5zaW9ucy53cml0ZVZhbHVlKG9wdGlvbiwga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShvcHRpb25WYWx1ZSkpOwoKCSAgICAgICAgICAgICAgICAvLyBBcHBseSBzb21lIHRleHQgdG8gdGhlIG9wdGlvbiBlbGVtZW50CgkgICAgICAgICAgICAgICAgdmFyIG9wdGlvblRleHQgPSBhcHBseVRvT2JqZWN0KGFycmF5RW50cnksIGFsbEJpbmRpbmdzLmdldCgnb3B0aW9uc1RleHQnKSwgb3B0aW9uVmFsdWUpOwoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldFRleHRDb250ZW50KG9wdGlvbiwgb3B0aW9uVGV4dCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gW29wdGlvbl07CgkgICAgICAgIH0KCgkgICAgICAgIC8vIEJ5IHVzaW5nIGEgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrLCB3ZSBkZWxheSB0aGUgcmVtb3ZhbCB1bnRpbCBhZnRlciBuZXcgaXRlbXMgYXJlIGFkZGVkLiBUaGlzIGZpeGVzIGEgc2VsZWN0aW9uCgkgICAgICAgIC8vIHByb2JsZW0gaW4gSUU8PTggYW5kIEZpcmVmb3guIFNlZSBodHRwczovL2dpdGh1Yi5jb20va25vY2tvdXQva25vY2tvdXQvaXNzdWVzLzEyMDgKCSAgICAgICAgYXJyYXlUb0RvbU5vZGVDaGlsZHJlbk9wdGlvbnNbJ2JlZm9yZVJlbW92ZSddID0KCSAgICAgICAgICAgIGZ1bmN0aW9uIChvcHRpb24pIHsKCSAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNoaWxkKG9wdGlvbik7CgkgICAgICAgICAgICB9OwoKCSAgICAgICAgZnVuY3Rpb24gc2V0U2VsZWN0aW9uQ2FsbGJhY2soYXJyYXlFbnRyeSwgbmV3T3B0aW9ucykgewoJICAgICAgICAgICAgLy8gSUU2IGRvZXNuJ3QgbGlrZSB1cyB0byBhc3NpZ24gc2VsZWN0aW9uIHRvIE9QVElPTiBub2RlcyBiZWZvcmUgdGhleSdyZSBhZGRlZCB0byB0aGUgZG9jdW1lbnQuCgkgICAgICAgICAgICAvLyBUaGF0J3Mgd2h5IHdlIGZpcnN0IGFkZGVkIHRoZW0gd2l0aG91dCBzZWxlY3Rpb24uIE5vdyBpdCdzIHRpbWUgdG8gc2V0IHRoZSBzZWxlY3Rpb24uCgkgICAgICAgICAgICBpZiAocHJldmlvdXNTZWxlY3RlZFZhbHVlcy5sZW5ndGgpIHsKCSAgICAgICAgICAgICAgICB2YXIgaXNTZWxlY3RlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihwcmV2aW91c1NlbGVjdGVkVmFsdWVzLCBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShuZXdPcHRpb25zWzBdKSkgPj0gMDsKCSAgICAgICAgICAgICAgICBrby51dGlscy5zZXRPcHRpb25Ob2RlU2VsZWN0aW9uU3RhdGUobmV3T3B0aW9uc1swXSwgaXNTZWxlY3RlZCk7CgoJICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgb3B0aW9uIHdhcyBjaGFuZ2VkIGZyb20gYmVpbmcgc2VsZWN0ZWQgZHVyaW5nIGEgc2luZ2xlLWl0ZW0gdXBkYXRlLCBub3RpZnkgdGhlIGNoYW5nZQoJICAgICAgICAgICAgICAgIGlmIChpdGVtVXBkYXRlICYmICFpc1NlbGVjdGVkKQoJICAgICAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZShrby51dGlscy50cmlnZ2VyRXZlbnQsIG51bGwsIFtlbGVtZW50LCAiY2hhbmdlIl0pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICB2YXIgY2FsbGJhY2sgPSBzZXRTZWxlY3Rpb25DYWxsYmFjazsKCSAgICAgICAgaWYgKGFsbEJpbmRpbmdzWydoYXMnXSgnb3B0aW9uc0FmdGVyUmVuZGVyJykpIHsKCSAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oYXJyYXlFbnRyeSwgbmV3T3B0aW9ucykgewoJICAgICAgICAgICAgICAgIHNldFNlbGVjdGlvbkNhbGxiYWNrKGFycmF5RW50cnksIG5ld09wdGlvbnMpOwoJICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGFsbEJpbmRpbmdzLmdldCgnb3B0aW9uc0FmdGVyUmVuZGVyJyksIG51bGwsIFtuZXdPcHRpb25zWzBdLCBhcnJheUVudHJ5ICE9PSBjYXB0aW9uUGxhY2Vob2xkZXIgPyBhcnJheUVudHJ5IDogdW5kZWZpbmVkXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcoZWxlbWVudCwgZmlsdGVyZWRBcnJheSwgb3B0aW9uRm9yQXJyYXlJdGVtLCBhcnJheVRvRG9tTm9kZUNoaWxkcmVuT3B0aW9ucywgY2FsbGJhY2spOwoKCSAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgaWYgKGFsbEJpbmRpbmdzLmdldCgndmFsdWVBbGxvd1Vuc2V0JykgJiYgYWxsQmluZGluZ3NbJ2hhcyddKCd2YWx1ZScpKSB7CgkgICAgICAgICAgICAgICAgLy8gVGhlIG1vZGVsIHZhbHVlIGlzIGF1dGhvcml0YXRpdmUsIHNvIG1ha2Ugc3VyZSBpdHMgdmFsdWUgaXMgdGhlIG9uZSBzZWxlY3RlZAoJICAgICAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFsbEJpbmRpbmdzLmdldCgndmFsdWUnKSksIHRydWUgLyogYWxsb3dVbnNldCAqLyk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBpZiB0aGUgc2VsZWN0aW9uIGhhcyBjaGFuZ2VkIGFzIGEgcmVzdWx0IG9mIHVwZGF0aW5nIHRoZSBvcHRpb25zIGxpc3QKCSAgICAgICAgICAgICAgICB2YXIgc2VsZWN0aW9uQ2hhbmdlZDsKCSAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5tdWx0aXBsZSkgewoJICAgICAgICAgICAgICAgICAgICAvLyBGb3IgYSBtdWx0aXBsZS1zZWxlY3QgYm94LCBjb21wYXJlIHRoZSBuZXcgc2VsZWN0aW9uIGNvdW50IHRvIHRoZSBwcmV2aW91cyBvbmUKCSAgICAgICAgICAgICAgICAgICAgLy8gQnV0IGlmIG5vdGhpbmcgd2FzIHNlbGVjdGVkIGJlZm9yZSwgdGhlIHNlbGVjdGlvbiBjYW4ndCBoYXZlIGNoYW5nZWQKCSAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uQ2hhbmdlZCA9IHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMubGVuZ3RoICYmIHNlbGVjdGVkT3B0aW9ucygpLmxlbmd0aCA8IHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMubGVuZ3RoOwoJICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEZvciBhIHNpbmdsZS1zZWxlY3QgYm94LCBjb21wYXJlIHRoZSBjdXJyZW50IHZhbHVlIHRvIHRoZSBwcmV2aW91cyB2YWx1ZQoJICAgICAgICAgICAgICAgICAgICAvLyBCdXQgaWYgbm90aGluZyB3YXMgc2VsZWN0ZWQgYmVmb3JlIG9yIG5vdGhpbmcgaXMgc2VsZWN0ZWQgbm93LCBqdXN0IGxvb2sgZm9yIGEgY2hhbmdlIGluIHNlbGVjdGlvbgoJICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb25DaGFuZ2VkID0gKHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMubGVuZ3RoICYmIGVsZW1lbnQuc2VsZWN0ZWRJbmRleCA+PSAwKQoJICAgICAgICAgICAgICAgICAgICAgICAgPyAoa28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudC5vcHRpb25zW2VsZW1lbnQuc2VsZWN0ZWRJbmRleF0pICE9PSBwcmV2aW91c1NlbGVjdGVkVmFsdWVzWzBdKQoJICAgICAgICAgICAgICAgICAgICAgICAgOiAocHJldmlvdXNTZWxlY3RlZFZhbHVlcy5sZW5ndGggfHwgZWxlbWVudC5zZWxlY3RlZEluZGV4ID49IDApOwoJICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgLy8gRW5zdXJlIGNvbnNpc3RlbmN5IGJldHdlZW4gbW9kZWwgdmFsdWUgYW5kIHNlbGVjdGVkIG9wdGlvbi4KCSAgICAgICAgICAgICAgICAvLyBJZiB0aGUgZHJvcGRvd24gd2FzIGNoYW5nZWQgc28gdGhhdCBzZWxlY3Rpb24gaXMgbm8gbG9uZ2VyIHRoZSBzYW1lLAoJICAgICAgICAgICAgICAgIC8vIG5vdGlmeSB0aGUgdmFsdWUgb3Igc2VsZWN0ZWRPcHRpb25zIGJpbmRpbmcuCgkgICAgICAgICAgICAgICAgaWYgKHNlbGVjdGlvbkNoYW5nZWQpIHsKCSAgICAgICAgICAgICAgICAgICAga28udXRpbHMudHJpZ2dlckV2ZW50KGVsZW1lbnQsICJjaGFuZ2UiKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoKCSAgICAgICAgLy8gV29ya2Fyb3VuZCBmb3IgSUUgYnVnCgkgICAgICAgIGtvLnV0aWxzLmVuc3VyZVNlbGVjdEVsZW1lbnRJc1JlbmRlcmVkQ29ycmVjdGx5KGVsZW1lbnQpOwoKCSAgICAgICAgaWYgKHByZXZpb3VzU2Nyb2xsVG9wICYmIE1hdGguYWJzKHByZXZpb3VzU2Nyb2xsVG9wIC0gZWxlbWVudC5zY3JvbGxUb3ApID4gMjApCgkgICAgICAgICAgICBlbGVtZW50LnNjcm9sbFRvcCA9IHByZXZpb3VzU2Nyb2xsVG9wOwoJICAgIH0KCX07Cglrby5iaW5kaW5nSGFuZGxlcnNbJ29wdGlvbnMnXS5vcHRpb25WYWx1ZURvbURhdGFLZXkgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snc2VsZWN0ZWRPcHRpb25zJ10gPSB7CgkgICAgJ2FmdGVyJzogWydvcHRpb25zJywgJ2ZvcmVhY2gnXSwKCSAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncykgewoJICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiY2hhbmdlIiwgZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgdmFyIHZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLCB2YWx1ZVRvV3JpdGUgPSBbXTsKCSAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJvcHRpb24iKSwgZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgICAgIGlmIChub2RlLnNlbGVjdGVkKQoJICAgICAgICAgICAgICAgICAgICB2YWx1ZVRvV3JpdGUucHVzaChrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShub2RlKSk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkodmFsdWUsIGFsbEJpbmRpbmdzLCAnc2VsZWN0ZWRPcHRpb25zJywgdmFsdWVUb1dyaXRlKTsKCSAgICAgICAgfSk7CgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgaWYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSAhPSAic2VsZWN0IikKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidmFsdWVzIGJpbmRpbmcgYXBwbGllcyBvbmx5IHRvIFNFTEVDVCBlbGVtZW50cyIpOwoKCSAgICAgICAgdmFyIG5ld1ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwoJICAgICAgICBpZiAobmV3VmFsdWUgJiYgdHlwZW9mIG5ld1ZhbHVlLmxlbmd0aCA9PSAibnVtYmVyIikgewoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9wdGlvbiIpLCBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAgICAgdmFyIGlzU2VsZWN0ZWQgPSBrby51dGlscy5hcnJheUluZGV4T2YobmV3VmFsdWUsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKG5vZGUpKSA+PSAwOwoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZShub2RlLCBpc1NlbGVjdGVkKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9CgkgICAgfQoJfTsKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcudHdvV2F5QmluZGluZ3NbJ3NlbGVjdGVkT3B0aW9ucyddID0gdHJ1ZTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snc3R5bGUnXSA9IHsKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkgfHwge30pOwoJICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKHZhbHVlLCBmdW5jdGlvbihzdHlsZU5hbWUsIHN0eWxlVmFsdWUpIHsKCSAgICAgICAgICAgIHN0eWxlVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHN0eWxlVmFsdWUpOwoKCSAgICAgICAgICAgIGlmIChzdHlsZVZhbHVlID09PSBudWxsIHx8IHN0eWxlVmFsdWUgPT09IHVuZGVmaW5lZCB8fCBzdHlsZVZhbHVlID09PSBmYWxzZSkgewoJICAgICAgICAgICAgICAgIC8vIEVtcHR5IHN0cmluZyByZW1vdmVzIHRoZSB2YWx1ZSwgd2hlcmVhcyBudWxsL3VuZGVmaW5lZCBoYXZlIG5vIGVmZmVjdAoJICAgICAgICAgICAgICAgIHN0eWxlVmFsdWUgPSAiIjsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICBlbGVtZW50LnN0eWxlW3N0eWxlTmFtZV0gPSBzdHlsZVZhbHVlOwoJICAgICAgICB9KTsKCSAgICB9Cgl9OwoJa28uYmluZGluZ0hhbmRsZXJzWydzdWJtaXQnXSA9IHsKCSAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICBpZiAodHlwZW9mIHZhbHVlQWNjZXNzb3IoKSAhPSAiZnVuY3Rpb24iKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgdmFsdWUgZm9yIGEgc3VibWl0IGJpbmRpbmcgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CgkgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJzdWJtaXQiLCBmdW5jdGlvbiAoZXZlbnQpIHsKCSAgICAgICAgICAgIHZhciBoYW5kbGVyUmV0dXJuVmFsdWU7CgkgICAgICAgICAgICB2YXIgdmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CgkgICAgICAgICAgICB0cnkgeyBoYW5kbGVyUmV0dXJuVmFsdWUgPSB2YWx1ZS5jYWxsKGJpbmRpbmdDb250ZXh0WyckZGF0YSddLCBlbGVtZW50KTsgfQoJICAgICAgICAgICAgZmluYWxseSB7CgkgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXJSZXR1cm5WYWx1ZSAhPT0gdHJ1ZSkgeyAvLyBOb3JtYWxseSB3ZSB3YW50IHRvIHByZXZlbnQgZGVmYXVsdCBhY3Rpb24uIERldmVsb3BlciBjYW4gb3ZlcnJpZGUgdGhpcyBiZSBleHBsaWNpdGx5IHJldHVybmluZyB0cnVlLgoJICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpCgkgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJICAgICAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgfQoJfTsKCWtvLmJpbmRpbmdIYW5kbGVyc1sndGV4dCddID0gewoJICAgICdpbml0JzogZnVuY3Rpb24oKSB7CgkgICAgICAgIC8vIFByZXZlbnQgYmluZGluZyBvbiB0aGUgZHluYW1pY2FsbHktaW5qZWN0ZWQgdGV4dCBub2RlIChhcyBkZXZlbG9wZXJzIGFyZSB1bmxpa2VseSB0byBleHBlY3QgdGhhdCwgYW5kIGl0IGhhcyBzZWN1cml0eSBpbXBsaWNhdGlvbnMpLgoJICAgICAgICAvLyBJdCBzaG91bGQgYWxzbyBtYWtlIHRoaW5ncyBmYXN0ZXIsIGFzIHdlIG5vIGxvbmdlciBoYXZlIHRvIGNvbnNpZGVyIHdoZXRoZXIgdGhlIHRleHQgbm9kZSBtaWdodCBiZSBiaW5kYWJsZS4KCSAgICAgICAgcmV0dXJuIHsgJ2NvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzJzogdHJ1ZSB9OwoJICAgIH0sCgkgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIGtvLnV0aWxzLnNldFRleHRDb250ZW50KGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgfQoJfTsKCWtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbJ3RleHQnXSA9IHRydWU7CgkoZnVuY3Rpb24gKCkgewoKCWlmICh3aW5kb3cgJiYgd2luZG93Lm5hdmlnYXRvcikgewoJICAgIHZhciBwYXJzZVZlcnNpb24gPSBmdW5jdGlvbiAobWF0Y2hlcykgewoJICAgICAgICBpZiAobWF0Y2hlcykgewoJICAgICAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQobWF0Y2hlc1sxXSk7CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICAvLyBEZXRlY3QgdmFyaW91cyBicm93c2VyIHZlcnNpb25zIGJlY2F1c2Ugc29tZSBvbGQgdmVyc2lvbnMgZG9uJ3QgZnVsbHkgc3VwcG9ydCB0aGUgJ2lucHV0JyBldmVudAoJICAgIHZhciBvcGVyYVZlcnNpb24gPSB3aW5kb3cub3BlcmEgJiYgd2luZG93Lm9wZXJhLnZlcnNpb24gJiYgcGFyc2VJbnQod2luZG93Lm9wZXJhLnZlcnNpb24oKSksCgkgICAgICAgIHVzZXJBZ2VudCA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LAoJICAgICAgICBzYWZhcmlWZXJzaW9uID0gcGFyc2VWZXJzaW9uKHVzZXJBZ2VudC5tYXRjaCgvXig/Oig/IWNocm9tZSkuKSp2ZXJzaW9uXC8oW14gXSopIHNhZmFyaS9pKSksCgkgICAgICAgIGZpcmVmb3hWZXJzaW9uID0gcGFyc2VWZXJzaW9uKHVzZXJBZ2VudC5tYXRjaCgvRmlyZWZveFwvKFteIF0qKS8pKTsKCX0KCgkvLyBJRSA4IGFuZCA5IGhhdmUgYnVncyB0aGF0IHByZXZlbnQgdGhlIG5vcm1hbCBldmVudHMgZnJvbSBmaXJpbmcgd2hlbiB0aGUgdmFsdWUgY2hhbmdlcy4KCS8vIEJ1dCBpdCBkb2VzIGZpcmUgdGhlICdzZWxlY3Rpb25jaGFuZ2UnIGV2ZW50IG9uIG1hbnkgb2YgdGhvc2UsIHByZXN1bWFibHkgYmVjYXVzZSB0aGUKCS8vIGN1cnNvciBpcyBtb3ZpbmcgYW5kIHRoYXQgY291bnRzIGFzIHRoZSBzZWxlY3Rpb24gY2hhbmdpbmcuIFRoZSAnc2VsZWN0aW9uY2hhbmdlJyBldmVudCBpcwoJLy8gZmlyZWQgYXQgdGhlIGRvY3VtZW50IGxldmVsIG9ubHkgYW5kIGRvZXNuJ3QgZGlyZWN0bHkgaW5kaWNhdGUgd2hpY2ggZWxlbWVudCBjaGFuZ2VkLiBXZQoJLy8gc2V0IHVwIGp1c3Qgb25lIGV2ZW50IGhhbmRsZXIgZm9yIHRoZSBkb2N1bWVudCBhbmQgdXNlICdhY3RpdmVFbGVtZW50JyB0byBkZXRlcm1pbmUgd2hpY2gKCS8vIGVsZW1lbnQgd2FzIGNoYW5nZWQuCglpZiAoa28udXRpbHMuaWVWZXJzaW9uIDwgMTApIHsKCSAgICB2YXIgc2VsZWN0aW9uQ2hhbmdlUmVnaXN0ZXJlZE5hbWUgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKSwKCSAgICAgICAgc2VsZWN0aW9uQ2hhbmdlSGFuZGxlck5hbWUgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCSAgICB2YXIgc2VsZWN0aW9uQ2hhbmdlSGFuZGxlciA9IGZ1bmN0aW9uKGV2ZW50KSB7CgkgICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLmFjdGl2ZUVsZW1lbnQsCgkgICAgICAgICAgICBoYW5kbGVyID0gdGFyZ2V0ICYmIGtvLnV0aWxzLmRvbURhdGEuZ2V0KHRhcmdldCwgc2VsZWN0aW9uQ2hhbmdlSGFuZGxlck5hbWUpOwoJICAgICAgICBpZiAoaGFuZGxlcikgewoJICAgICAgICAgICAgaGFuZGxlcihldmVudCk7CgkgICAgICAgIH0KCSAgICB9OwoJICAgIHZhciByZWdpc3RlckZvclNlbGVjdGlvbkNoYW5nZUV2ZW50ID0gZnVuY3Rpb24gKGVsZW1lbnQsIGhhbmRsZXIpIHsKCSAgICAgICAgdmFyIG93bmVyRG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50OwoJICAgICAgICBpZiAoIWtvLnV0aWxzLmRvbURhdGEuZ2V0KG93bmVyRG9jLCBzZWxlY3Rpb25DaGFuZ2VSZWdpc3RlcmVkTmFtZSkpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG93bmVyRG9jLCBzZWxlY3Rpb25DaGFuZ2VSZWdpc3RlcmVkTmFtZSwgdHJ1ZSk7CgkgICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihvd25lckRvYywgJ3NlbGVjdGlvbmNoYW5nZScsIHNlbGVjdGlvbkNoYW5nZUhhbmRsZXIpOwoJICAgICAgICB9CgkgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIHNlbGVjdGlvbkNoYW5nZUhhbmRsZXJOYW1lLCBoYW5kbGVyKTsKCSAgICB9OwoJfQoKCWtvLmJpbmRpbmdIYW5kbGVyc1sndGV4dElucHV0J10gPSB7CgkgICAgJ2luaXQnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MpIHsKCgkgICAgICAgIHZhciBwcmV2aW91c0VsZW1lbnRWYWx1ZSA9IGVsZW1lbnQudmFsdWUsCgkgICAgICAgICAgICB0aW1lb3V0SGFuZGxlLAoJICAgICAgICAgICAgZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQ7CgoJICAgICAgICB2YXIgdXBkYXRlTW9kZWwgPSBmdW5jdGlvbiAoZXZlbnQpIHsKCSAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SGFuZGxlKTsKCSAgICAgICAgICAgIGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50ID0gdGltZW91dEhhbmRsZSA9IHVuZGVmaW5lZDsKCgkgICAgICAgICAgICB2YXIgZWxlbWVudFZhbHVlID0gZWxlbWVudC52YWx1ZTsKCSAgICAgICAgICAgIGlmIChwcmV2aW91c0VsZW1lbnRWYWx1ZSAhPT0gZWxlbWVudFZhbHVlKSB7CgkgICAgICAgICAgICAgICAgLy8gUHJvdmlkZSBhIHdheSBmb3IgdGVzdHMgdG8ga25vdyBleGFjdGx5IHdoaWNoIGV2ZW50IHdhcyBwcm9jZXNzZWQKCSAgICAgICAgICAgICAgICBpZiAoREVCVUcgJiYgZXZlbnQpIGVsZW1lbnRbJ19rb190ZXh0SW5wdXRQcm9jZXNzZWRFdmVudCddID0gZXZlbnQudHlwZTsKCSAgICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnRWYWx1ZSA9IGVsZW1lbnRWYWx1ZTsKCSAgICAgICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KHZhbHVlQWNjZXNzb3IoKSwgYWxsQmluZGluZ3MsICd0ZXh0SW5wdXQnLCBlbGVtZW50VmFsdWUpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9OwoKCSAgICAgICAgdmFyIGRlZmVyVXBkYXRlTW9kZWwgPSBmdW5jdGlvbiAoZXZlbnQpIHsKCSAgICAgICAgICAgIGlmICghdGltZW91dEhhbmRsZSkgewoJICAgICAgICAgICAgICAgIC8vIFRoZSBlbGVtZW50VmFsdWVCZWZvcmVFdmVudCB2YXJpYWJsZSBpcyBzZXQgKm9ubHkqIGR1cmluZyB0aGUgYnJpZWYgZ2FwIGJldHdlZW4gYW4KCSAgICAgICAgICAgICAgICAvLyBldmVudCBmaXJpbmcgYW5kIHRoZSB1cGRhdGVNb2RlbCBmdW5jdGlvbiBydW5uaW5nLiBUaGlzIGFsbG93cyB1cyB0byBpZ25vcmUgbW9kZWwKCSAgICAgICAgICAgICAgICAvLyB1cGRhdGVzIHRoYXQgYXJlIGZyb20gdGhlIHByZXZpb3VzIHN0YXRlIG9mIHRoZSBlbGVtZW50LCB1c3VhbGx5IGR1ZSB0byB0ZWNobmlxdWVzCgkgICAgICAgICAgICAgICAgLy8gc3VjaCBhcyByYXRlTGltaXQuIFN1Y2ggdXBkYXRlcywgaWYgbm90IGlnbm9yZWQsIGNhbiBjYXVzZSBrZXlzdHJva2VzIHRvIGJlIGxvc3QuCgkgICAgICAgICAgICAgICAgZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQgPSBlbGVtZW50LnZhbHVlOwoJICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyID0gREVCVUcgPyB1cGRhdGVNb2RlbC5iaW5kKGVsZW1lbnQsIHt0eXBlOiBldmVudC50eXBlfSkgOiB1cGRhdGVNb2RlbDsKCSAgICAgICAgICAgICAgICB0aW1lb3V0SGFuZGxlID0gc2V0VGltZW91dChoYW5kbGVyLCA0KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfTsKCgkgICAgICAgIHZhciB1cGRhdGVWaWV3ID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgoJICAgICAgICAgICAgaWYgKG1vZGVsVmFsdWUgPT09IG51bGwgfHwgbW9kZWxWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICAgICAgbW9kZWxWYWx1ZSA9ICcnOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIGlmIChlbGVtZW50VmFsdWVCZWZvcmVFdmVudCAhPT0gdW5kZWZpbmVkICYmIG1vZGVsVmFsdWUgPT09IGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50KSB7CgkgICAgICAgICAgICAgICAgc2V0VGltZW91dCh1cGRhdGVWaWV3LCA0KTsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBlbGVtZW50IG9ubHkgaWYgdGhlIGVsZW1lbnQgYW5kIG1vZGVsIGFyZSBkaWZmZXJlbnQuIE9uIHNvbWUgYnJvd3NlcnMsIHVwZGF0aW5nIHRoZSB2YWx1ZQoJICAgICAgICAgICAgLy8gd2lsbCBtb3ZlIHRoZSBjdXJzb3IgdG8gdGhlIGVuZCBvZiB0aGUgaW5wdXQsIHdoaWNoIHdvdWxkIGJlIGJhZCB3aGlsZSB0aGUgdXNlciBpcyB0eXBpbmcuCgkgICAgICAgICAgICBpZiAoZWxlbWVudC52YWx1ZSAhPT0gbW9kZWxWYWx1ZSkgewoJICAgICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudFZhbHVlID0gbW9kZWxWYWx1ZTsgIC8vIE1ha2Ugc3VyZSB3ZSBpZ25vcmUgZXZlbnRzIChwcm9wZXJ0eWNoYW5nZSkgdGhhdCByZXN1bHQgZnJvbSB1cGRhdGluZyB0aGUgdmFsdWUKCSAgICAgICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gbW9kZWxWYWx1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfTsKCgkgICAgICAgIHZhciBvbkV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50LCBoYW5kbGVyKSB7CgkgICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudCwgaGFuZGxlcik7CgkgICAgICAgIH07CgoJICAgICAgICBpZiAoREVCVUcgJiYga28uYmluZGluZ0hhbmRsZXJzWyd0ZXh0SW5wdXQnXVsnX2ZvcmNlVXBkYXRlT24nXSkgewoJICAgICAgICAgICAgLy8gUHJvdmlkZSBhIHdheSBmb3IgdGVzdHMgdG8gc3BlY2lmeSBleGFjdGx5IHdoaWNoIGV2ZW50cyBhcmUgYm91bmQKCSAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChrby5iaW5kaW5nSGFuZGxlcnNbJ3RleHRJbnB1dCddWydfZm9yY2VVcGRhdGVPbiddLCBmdW5jdGlvbihldmVudE5hbWUpIHsKCSAgICAgICAgICAgICAgICBpZiAoZXZlbnROYW1lLnNsaWNlKDAsNSkgPT0gJ2FmdGVyJykgewoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KGV2ZW50TmFtZS5zbGljZSg1KSwgZGVmZXJVcGRhdGVNb2RlbCk7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgb25FdmVudChldmVudE5hbWUsIHVwZGF0ZU1vZGVsKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGlmIChrby51dGlscy5pZVZlcnNpb24gPCAxMCkgewoJICAgICAgICAgICAgICAgIC8vIEludGVybmV0IEV4cGxvcmVyIDw9IDggZG9lc24ndCBzdXBwb3J0IHRoZSAnaW5wdXQnIGV2ZW50LCBidXQgZG9lcyBpbmNsdWRlICdwcm9wZXJ0eWNoYW5nZScgdGhhdCBmaXJlcyB3aGVuZXZlcgoJICAgICAgICAgICAgICAgIC8vIGFueSBwcm9wZXJ0eSBvZiBhbiBlbGVtZW50IGNoYW5nZXMuIFVubGlrZSAnaW5wdXQnLCBpdCBhbHNvIGZpcmVzIGlmIGEgcHJvcGVydHkgaXMgY2hhbmdlZCBmcm9tIEphdmFTY3JpcHQgY29kZSwKCSAgICAgICAgICAgICAgICAvLyBidXQgdGhhdCdzIGFuIGFjY2VwdGFibGUgY29tcHJvbWlzZSBmb3IgdGhpcyBiaW5kaW5nLiBJRSA5IGRvZXMgc3VwcG9ydCAnaW5wdXQnLCBidXQgc2luY2UgaXQgZG9lc24ndCBmaXJlIGl0CgkgICAgICAgICAgICAgICAgLy8gd2hlbiB1c2luZyBhdXRvY29tcGxldGUsIHdlJ2xsIHVzZSAncHJvcGVydHljaGFuZ2UnIGZvciBpdCBhbHNvLgoJICAgICAgICAgICAgICAgIG9uRXZlbnQoJ3Byb3BlcnR5Y2hhbmdlJywgZnVuY3Rpb24oZXZlbnQpIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3ZhbHVlJykgewoJICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlTW9kZWwoZXZlbnQpOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfSk7CgoJICAgICAgICAgICAgICAgIGlmIChrby51dGlscy5pZVZlcnNpb24gPT0gOCkgewoJICAgICAgICAgICAgICAgICAgICAvLyBJRSA4IGhhcyBhIGJ1ZyB3aGVyZSBpdCBmYWlscyB0byBmaXJlICdwcm9wZXJ0eWNoYW5nZScgb24gdGhlIGZpcnN0IHVwZGF0ZSBmb2xsb3dpbmcgYSB2YWx1ZSBjaGFuZ2UgZnJvbQoJICAgICAgICAgICAgICAgICAgICAvLyBKYXZhU2NyaXB0IGNvZGUuIEl0IGFsc28gZG9lc24ndCBmaXJlIGlmIHlvdSBjbGVhciB0aGUgZW50aXJlIHZhbHVlLiBUbyBmaXggdGhpcywgd2UgYmluZCB0byB0aGUgZm9sbG93aW5nCgkgICAgICAgICAgICAgICAgICAgIC8vIGV2ZW50cyB0b28uCgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2tleXVwJywgdXBkYXRlTW9kZWwpOyAgICAgIC8vIEEgc2luZ2xlIGtleXN0b2tlCgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2tleWRvd24nLCB1cGRhdGVNb2RlbCk7ICAgIC8vIFRoZSBmaXJzdCBjaGFyYWN0ZXIgd2hlbiBhIGtleSBpcyBoZWxkIGRvd24KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmllVmVyc2lvbiA+PSA4KSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEludGVybmV0IEV4cGxvcmVyIDkgZG9lc24ndCBmaXJlIHRoZSAnaW5wdXQnIGV2ZW50IHdoZW4gZGVsZXRpbmcgdGV4dCwgaW5jbHVkaW5nIHVzaW5nCgkgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBiYWNrc3BhY2UsIGRlbGV0ZSwgb3IgY3RybC14IGtleXMsIGNsaWNraW5nIHRoZSAneCcgdG8gY2xlYXIgdGhlIGlucHV0LCBkcmFnZ2luZyB0ZXh0CgkgICAgICAgICAgICAgICAgICAgIC8vIG91dCBvZiB0aGUgZmllbGQsIGFuZCBjdXR0aW5nIG9yIGRlbGV0aW5nIHRleHQgdXNpbmcgdGhlIGNvbnRleHQgbWVudS4gJ3NlbGVjdGlvbmNoYW5nZScKCSAgICAgICAgICAgICAgICAgICAgLy8gY2FuIGRldGVjdCBhbGwgb2YgdGhvc2UgZXhjZXB0IGRyYWdnaW5nIHRleHQgb3V0IG9mIHRoZSBmaWVsZCwgZm9yIHdoaWNoIHdlIHVzZSAnZHJhZ2VuZCcuCgkgICAgICAgICAgICAgICAgICAgIC8vIFRoZXNlIGFyZSBhbHNvIG5lZWRlZCBpbiBJRTggYmVjYXVzZSBvZiB0aGUgYnVnIGRlc2NyaWJlZCBhYm92ZS4KCSAgICAgICAgICAgICAgICAgICAgcmVnaXN0ZXJGb3JTZWxlY3Rpb25DaGFuZ2VFdmVudChlbGVtZW50LCB1cGRhdGVNb2RlbCk7ICAvLyAnc2VsZWN0aW9uY2hhbmdlJyBjb3ZlcnMgY3V0LCBwYXN0ZSwgZHJvcCwgZGVsZXRlLCBldGMuCgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2RyYWdlbmQnLCBkZWZlclVwZGF0ZU1vZGVsKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIEFsbCBvdGhlciBzdXBwb3J0ZWQgYnJvd3NlcnMgc3VwcG9ydCB0aGUgJ2lucHV0JyBldmVudCwgd2hpY2ggZmlyZXMgd2hlbmV2ZXIgdGhlIGNvbnRlbnQgb2YgdGhlIGVsZW1lbnQgaXMgY2hhbmdlZAoJICAgICAgICAgICAgICAgIC8vIHRocm91Z2ggdGhlIHVzZXIgaW50ZXJmYWNlLgoJICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2lucHV0JywgdXBkYXRlTW9kZWwpOwoKCSAgICAgICAgICAgICAgICBpZiAoc2FmYXJpVmVyc2lvbiA8IDUgJiYga28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnQpID09PSAidGV4dGFyZWEiKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIFNhZmFyaSA8NSBkb2Vzbid0IGZpcmUgdGhlICdpbnB1dCcgZXZlbnQgZm9yIDx0ZXh0YXJlYT4gZWxlbWVudHMgKGl0IGRvZXMgZmlyZSAndGV4dElucHV0JwoJICAgICAgICAgICAgICAgICAgICAvLyBidXQgb25seSB3aGVuIHR5cGluZykuIFNvIHdlJ2xsIGp1c3QgY2F0Y2ggYXMgbXVjaCBhcyB3ZSBjYW4gd2l0aCBrZXlkb3duLCBjdXQsIGFuZCBwYXN0ZS4KCSAgICAgICAgICAgICAgICAgICAgb25FdmVudCgna2V5ZG93bicsIGRlZmVyVXBkYXRlTW9kZWwpOwoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KCdwYXN0ZScsIGRlZmVyVXBkYXRlTW9kZWwpOwoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KCdjdXQnLCBkZWZlclVwZGF0ZU1vZGVsKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhVmVyc2lvbiA8IDExKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIE9wZXJhIDEwIGRvZXNuJ3QgYWx3YXlzIGZpcmUgdGhlICdpbnB1dCcgZXZlbnQgZm9yIGN1dCwgcGFzdGUsIHVuZG8gJiBkcm9wIG9wZXJhdGlvbnMuCgkgICAgICAgICAgICAgICAgICAgIC8vIFdlIGNhbiB0cnkgdG8gY2F0Y2ggc29tZSBvZiB0aG9zZSB1c2luZyAna2V5ZG93bicuCgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2tleWRvd24nLCBkZWZlclVwZGF0ZU1vZGVsKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZpcmVmb3hWZXJzaW9uIDwgNC4wKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEZpcmVmb3ggPD0gMy42IGRvZXNuJ3QgZmlyZSB0aGUgJ2lucHV0JyBldmVudCB3aGVuIHRleHQgaXMgZmlsbGVkIGluIHRocm91Z2ggYXV0b2NvbXBsZXRlCgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ0RPTUF1dG9Db21wbGV0ZScsIHVwZGF0ZU1vZGVsKTsKCgkgICAgICAgICAgICAgICAgICAgIC8vIEZpcmVmb3ggPD0zLjUgZG9lc24ndCBmaXJlIHRoZSAnaW5wdXQnIGV2ZW50IHdoZW4gdGV4dCBpcyBkcm9wcGVkIGludG8gdGhlIGlucHV0LgoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KCdkcmFnZHJvcCcsIHVwZGF0ZU1vZGVsKTsgICAgICAgLy8gPDMuNQoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KCdkcm9wJywgdXBkYXRlTW9kZWwpOyAgICAgICAgICAgLy8gMy41CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICAvLyBCaW5kIHRvIHRoZSBjaGFuZ2UgZXZlbnQgc28gdGhhdCB3ZSBjYW4gY2F0Y2ggcHJvZ3JhbW1hdGljIHVwZGF0ZXMgb2YgdGhlIHZhbHVlIHRoYXQgZmlyZSB0aGlzIGV2ZW50LgoJICAgICAgICBvbkV2ZW50KCdjaGFuZ2UnLCB1cGRhdGVNb2RlbCk7CgoJICAgICAgICBrby5jb21wdXRlZCh1cGRhdGVWaWV3LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogZWxlbWVudCB9KTsKCSAgICB9Cgl9OwoJa28uZXhwcmVzc2lvblJld3JpdGluZy50d29XYXlCaW5kaW5nc1sndGV4dElucHV0J10gPSB0cnVlOwoKCS8vIHRleHRpbnB1dCBpcyBhbiBhbGlhcyBmb3IgdGV4dElucHV0Cglrby5iaW5kaW5nSGFuZGxlcnNbJ3RleHRpbnB1dCddID0gewoJICAgIC8vIHByZXByb2Nlc3MgaXMgdGhlIG9ubHkgd2F5IHRvIHNldCB1cCBhIGZ1bGwgYWxpYXMKCSAgICAncHJlcHJvY2Vzcyc6IGZ1bmN0aW9uICh2YWx1ZSwgbmFtZSwgYWRkQmluZGluZykgewoJICAgICAgICBhZGRCaW5kaW5nKCd0ZXh0SW5wdXQnLCB2YWx1ZSk7CgkgICAgfQoJfTsKCgl9KSgpO2tvLmJpbmRpbmdIYW5kbGVyc1sndW5pcXVlTmFtZSddID0gewoJICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgaWYgKHZhbHVlQWNjZXNzb3IoKSkgewoJICAgICAgICAgICAgdmFyIG5hbWUgPSAia29fdW5pcXVlXyIgKyAoKytrby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXS5jdXJyZW50SW5kZXgpOwoJICAgICAgICAgICAga28udXRpbHMuc2V0RWxlbWVudE5hbWUoZWxlbWVudCwgbmFtZSk7CgkgICAgICAgIH0KCSAgICB9Cgl9OwoJa28uYmluZGluZ0hhbmRsZXJzWyd1bmlxdWVOYW1lJ10uY3VycmVudEluZGV4ID0gMDsKCWtvLmJpbmRpbmdIYW5kbGVyc1sndmFsdWUnXSA9IHsKCSAgICAnYWZ0ZXInOiBbJ29wdGlvbnMnLCAnZm9yZWFjaCddLAoJICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzKSB7CgkgICAgICAgIC8vIElmIHRoZSB2YWx1ZSBiaW5kaW5nIGlzIHBsYWNlZCBvbiBhIHJhZGlvL2NoZWNrYm94LCB0aGVuIGp1c3QgcGFzcyB0aHJvdWdoIHRvIGNoZWNrZWRWYWx1ZSBhbmQgcXVpdAoJICAgICAgICBpZiAoZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImlucHV0IiAmJiAoZWxlbWVudC50eXBlID09ICJjaGVja2JveCIgfHwgZWxlbWVudC50eXBlID09ICJyYWRpbyIpKSB7CgkgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdBY2Nlc3NvcnNUb05vZGUoZWxlbWVudCwgeyAnY2hlY2tlZFZhbHVlJzogdmFsdWVBY2Nlc3NvciB9KTsKCSAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gQWx3YXlzIGNhdGNoICJjaGFuZ2UiIGV2ZW50OyBwb3NzaWJseSBvdGhlciBldmVudHMgdG9vIGlmIGFza2VkCgkgICAgICAgIHZhciBldmVudHNUb0NhdGNoID0gWyJjaGFuZ2UiXTsKCSAgICAgICAgdmFyIHJlcXVlc3RlZEV2ZW50c1RvQ2F0Y2ggPSBhbGxCaW5kaW5ncy5nZXQoInZhbHVlVXBkYXRlIik7CgkgICAgICAgIHZhciBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IGZhbHNlOwoJICAgICAgICB2YXIgZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQgPSBudWxsOwoKCSAgICAgICAgaWYgKHJlcXVlc3RlZEV2ZW50c1RvQ2F0Y2gpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCA9PSAic3RyaW5nIikgLy8gQWxsb3cgYm90aCBpbmRpdmlkdWFsIGV2ZW50IG5hbWVzLCBhbmQgYXJyYXlzIG9mIGV2ZW50IG5hbWVzCgkgICAgICAgICAgICAgICAgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCA9IFtyZXF1ZXN0ZWRFdmVudHNUb0NhdGNoXTsKCSAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UHVzaEFsbChldmVudHNUb0NhdGNoLCByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoKTsKCSAgICAgICAgICAgIGV2ZW50c1RvQ2F0Y2ggPSBrby51dGlscy5hcnJheUdldERpc3RpbmN0VmFsdWVzKGV2ZW50c1RvQ2F0Y2gpOwoJICAgICAgICB9CgoJICAgICAgICB2YXIgdmFsdWVVcGRhdGVIYW5kbGVyID0gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICBlbGVtZW50VmFsdWVCZWZvcmVFdmVudCA9IG51bGw7CgkgICAgICAgICAgICBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IGZhbHNlOwoJICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CgkgICAgICAgICAgICB2YXIgZWxlbWVudFZhbHVlID0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCk7CgkgICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzLCAndmFsdWUnLCBlbGVtZW50VmFsdWUpOwoJICAgICAgICB9CgoJICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzEyMgoJICAgICAgICAvLyBJRSBkb2Vzbid0IGZpcmUgImNoYW5nZSIgZXZlbnRzIG9uIHRleHRib3hlcyBpZiB0aGUgdXNlciBzZWxlY3RzIGEgdmFsdWUgZnJvbSBpdHMgYXV0b2NvbXBsZXRlIGxpc3QKCSAgICAgICAgdmFyIGllQXV0b0NvbXBsZXRlSGFja05lZWRlZCA9IGtvLnV0aWxzLmllVmVyc2lvbiAmJiBlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAiaW5wdXQiICYmIGVsZW1lbnQudHlwZSA9PSAidGV4dCIKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIGVsZW1lbnQuYXV0b2NvbXBsZXRlICE9ICJvZmYiICYmICghZWxlbWVudC5mb3JtIHx8IGVsZW1lbnQuZm9ybS5hdXRvY29tcGxldGUgIT0gIm9mZiIpOwoJICAgICAgICBpZiAoaWVBdXRvQ29tcGxldGVIYWNrTmVlZGVkICYmIGtvLnV0aWxzLmFycmF5SW5kZXhPZihldmVudHNUb0NhdGNoLCAicHJvcGVydHljaGFuZ2UiKSA9PSAtMSkgewoJICAgICAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgInByb3BlcnR5Y2hhbmdlIiwgZnVuY3Rpb24gKCkgeyBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IHRydWUgfSk7CgkgICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiZm9jdXMiLCBmdW5jdGlvbiAoKSB7IHByb3BlcnR5Q2hhbmdlZEZpcmVkID0gZmFsc2UgfSk7CgkgICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUNoYW5nZWRGaXJlZCkgewoJICAgICAgICAgICAgICAgICAgICB2YWx1ZVVwZGF0ZUhhbmRsZXIoKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfQoKCSAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGV2ZW50c1RvQ2F0Y2gsIGZ1bmN0aW9uKGV2ZW50TmFtZSkgewoJICAgICAgICAgICAgLy8gVGhlIHN5bnRheCAiYWZ0ZXI8ZXZlbnRuYW1lPiIgbWVhbnMgInJ1biB0aGUgaGFuZGxlciBhc3luY2hyb25vdXNseSBhZnRlciB0aGUgZXZlbnQiCgkgICAgICAgICAgICAvLyBUaGlzIGlzIHVzZWZ1bCwgZm9yIGV4YW1wbGUsIHRvIGNhdGNoICJrZXlkb3duIiBldmVudHMgYWZ0ZXIgdGhlIGJyb3dzZXIgaGFzIHVwZGF0ZWQgdGhlIGNvbnRyb2wKCSAgICAgICAgICAgIC8vIChvdGhlcndpc2UsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKHRoaXMpIHdpbGwgcmVjZWl2ZSB0aGUgY29udHJvbCdzIHZhbHVlICpiZWZvcmUqIHRoZSBrZXkgZXZlbnQpCgkgICAgICAgICAgICB2YXIgaGFuZGxlciA9IHZhbHVlVXBkYXRlSGFuZGxlcjsKCSAgICAgICAgICAgIGlmIChrby51dGlscy5zdHJpbmdTdGFydHNXaXRoKGV2ZW50TmFtZSwgImFmdGVyIikpIHsKCSAgICAgICAgICAgICAgICBoYW5kbGVyID0gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIFRoZSBlbGVtZW50VmFsdWVCZWZvcmVFdmVudCB2YXJpYWJsZSBpcyBub24tbnVsbCAqb25seSogZHVyaW5nIHRoZSBicmllZiBnYXAgYmV0d2VlbgoJICAgICAgICAgICAgICAgICAgICAvLyBhIGtleVggZXZlbnQgZmlyaW5nIGFuZCB0aGUgdmFsdWVVcGRhdGVIYW5kbGVyIHJ1bm5pbmcsIHdoaWNoIGlzIHNjaGVkdWxlZCB0byBoYXBwZW4KCSAgICAgICAgICAgICAgICAgICAgLy8gYXQgdGhlIGVhcmxpZXN0IGFzeW5jaHJvbm91cyBvcHBvcnR1bml0eS4gV2Ugc3RvcmUgdGhpcyB0ZW1wb3JhcnkgaW5mb3JtYXRpb24gc28gdGhhdAoJICAgICAgICAgICAgICAgICAgICAvLyBpZiwgYmV0d2VlbiBrZXlYIGFuZCB2YWx1ZVVwZGF0ZUhhbmRsZXIsIHRoZSB1bmRlcmx5aW5nIG1vZGVsIHZhbHVlIGNoYW5nZXMgc2VwYXJhdGVseSwKCSAgICAgICAgICAgICAgICAgICAgLy8gd2UgY2FuIG92ZXJ3cml0ZSB0aGF0IG1vZGVsIHZhbHVlIGNoYW5nZSB3aXRoIHRoZSB2YWx1ZSB0aGUgdXNlciBqdXN0IHR5cGVkLiBPdGhlcndpc2UsCgkgICAgICAgICAgICAgICAgICAgIC8vIHRlY2huaXF1ZXMgbGlrZSByYXRlTGltaXQgY2FuIHRyaWdnZXIgbW9kZWwgY2hhbmdlcyBhdCBjcml0aWNhbCBtb21lbnRzIHRoYXQgd2lsbAoJICAgICAgICAgICAgICAgICAgICAvLyBvdmVycmlkZSB0aGUgdXNlcidzIGlucHV0cywgY2F1c2luZyBrZXlzdHJva2VzIHRvIGJlIGxvc3QuCgkgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50ID0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCk7CgkgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQodmFsdWVVcGRhdGVIYW5kbGVyLCAwKTsKCSAgICAgICAgICAgICAgICB9OwoJICAgICAgICAgICAgICAgIGV2ZW50TmFtZSA9IGV2ZW50TmFtZS5zdWJzdHJpbmcoImFmdGVyIi5sZW5ndGgpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnROYW1lLCBoYW5kbGVyKTsKCSAgICAgICAgfSk7CgoJICAgICAgICB2YXIgdXBkYXRlRnJvbU1vZGVsID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwoJICAgICAgICAgICAgdmFyIGVsZW1lbnRWYWx1ZSA9IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpOwoKCSAgICAgICAgICAgIGlmIChlbGVtZW50VmFsdWVCZWZvcmVFdmVudCAhPT0gbnVsbCAmJiBuZXdWYWx1ZSA9PT0gZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQpIHsKCSAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHVwZGF0ZUZyb21Nb2RlbCwgMCk7CgkgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIHZhciB2YWx1ZUhhc0NoYW5nZWQgPSAobmV3VmFsdWUgIT09IGVsZW1lbnRWYWx1ZSk7CgoJICAgICAgICAgICAgaWYgKHZhbHVlSGFzQ2hhbmdlZCkgewoJICAgICAgICAgICAgICAgIGlmIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgPT09ICJzZWxlY3QiKSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBhbGxvd1Vuc2V0ID0gYWxsQmluZGluZ3MuZ2V0KCd2YWx1ZUFsbG93VW5zZXQnKTsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGFwcGx5VmFsdWVBY3Rpb24gPSBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUoZWxlbWVudCwgbmV3VmFsdWUsIGFsbG93VW5zZXQpOwoJICAgICAgICAgICAgICAgICAgICB9OwoJICAgICAgICAgICAgICAgICAgICBhcHBseVZhbHVlQWN0aW9uKCk7CgoJICAgICAgICAgICAgICAgICAgICBpZiAoIWFsbG93VW5zZXQgJiYgbmV3VmFsdWUgIT09IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB5b3UgdHJ5IHRvIHNldCBhIG1vZGVsIHZhbHVlIHRoYXQgY2FuJ3QgYmUgcmVwcmVzZW50ZWQgaW4gYW4gYWxyZWFkeS1wb3B1bGF0ZWQgZHJvcGRvd24sIHJlamVjdCB0aGF0IGNoYW5nZSwKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgeW91J3JlIG5vdCBhbGxvd2VkIHRvIGhhdmUgYSBtb2RlbCB2YWx1ZSB0aGF0IGRpc2FncmVlcyB3aXRoIGEgdmlzaWJsZSBVSSBzZWxlY3Rpb24uCgkgICAgICAgICAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZShrby51dGlscy50cmlnZ2VyRXZlbnQsIG51bGwsIFtlbGVtZW50LCAiY2hhbmdlIl0pOwoJICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBmb3IgSUU2IGJ1ZzogSXQgd29uJ3QgcmVsaWFibHkgYXBwbHkgdmFsdWVzIHRvIFNFTEVDVCBub2RlcyBkdXJpbmcgdGhlIHNhbWUgZXhlY3V0aW9uIHRocmVhZAoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmlnaHQgYWZ0ZXIgeW91J3ZlIGNoYW5nZWQgdGhlIHNldCBvZiBPUFRJT04gbm9kZXMgb24gaXQuIFNvIGZvciB0aGF0IG5vZGUgdHlwZSwgd2UnbGwgc2NoZWR1bGUgYSBzZWNvbmQgdGhyZWFkCgkgICAgICAgICAgICAgICAgICAgICAgICAvLyB0byBhcHBseSB0aGUgdmFsdWUgYXMgd2VsbC4KCSAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoYXBwbHlWYWx1ZUFjdGlvbiwgMCk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUoZWxlbWVudCwgbmV3VmFsdWUpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfTsKCgkgICAgICAgIGtvLmNvbXB1dGVkKHVwZGF0ZUZyb21Nb2RlbCwgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGVsZW1lbnQgfSk7CgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24oKSB7fSAvLyBLZWVwIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIGNvZGUgdGhhdCBtYXkgaGF2ZSB3cmFwcGVkIHZhbHVlIGJpbmRpbmcKCX07Cglrby5leHByZXNzaW9uUmV3cml0aW5nLnR3b1dheUJpbmRpbmdzWyd2YWx1ZSddID0gdHJ1ZTsKCWtvLmJpbmRpbmdIYW5kbGVyc1sndmlzaWJsZSddID0gewoJICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgICAgIHZhciBpc0N1cnJlbnRseVZpc2libGUgPSAhKGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9PSAibm9uZSIpOwoJICAgICAgICBpZiAodmFsdWUgJiYgIWlzQ3VycmVudGx5VmlzaWJsZSkKCSAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICIiOwoJICAgICAgICBlbHNlIGlmICgoIXZhbHVlKSAmJiBpc0N1cnJlbnRseVZpc2libGUpCgkgICAgICAgICAgICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgkgICAgfQoJfTsKCS8vICdjbGljaycgaXMganVzdCBhIHNob3J0aGFuZCBmb3IgdGhlIHVzdWFsIGZ1bGwtbGVuZ3RoIGV2ZW50OntjbGljazpoYW5kbGVyfQoJbWFrZUV2ZW50SGFuZGxlclNob3J0Y3V0KCdjbGljaycpOwoJLy8gSWYgeW91IHdhbnQgdG8gbWFrZSBhIGN1c3RvbSB0ZW1wbGF0ZSBlbmdpbmUsCgkvLwoJLy8gWzFdIEluaGVyaXQgZnJvbSB0aGlzIGNsYXNzIChsaWtlIGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lIGRvZXMpCgkvLyBbMl0gT3ZlcnJpZGUgJ3JlbmRlclRlbXBsYXRlU291cmNlJywgc3VwcGx5aW5nIGEgZnVuY3Rpb24gd2l0aCB0aGlzIHNpZ25hdHVyZToKCS8vCgkvLyAgICAgICAgZnVuY3Rpb24gKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewoJLy8gICAgICAgICAgICAvLyAtIHRlbXBsYXRlU291cmNlLnRleHQoKSBpcyB0aGUgdGV4dCBvZiB0aGUgdGVtcGxhdGUgeW91IHNob3VsZCByZW5kZXIKCS8vICAgICAgICAgICAgLy8gLSBiaW5kaW5nQ29udGV4dC4kZGF0YSBpcyB0aGUgZGF0YSB5b3Ugc2hvdWxkIHBhc3MgaW50byB0aGUgdGVtcGxhdGUKCS8vICAgICAgICAgICAgLy8gICAtIHlvdSBtaWdodCBhbHNvIHdhbnQgdG8gbWFrZSBiaW5kaW5nQ29udGV4dC4kcGFyZW50LCBiaW5kaW5nQ29udGV4dC4kcGFyZW50cywKCS8vICAgICAgICAgICAgLy8gICAgIGFuZCBiaW5kaW5nQ29udGV4dC4kcm9vdCBhdmFpbGFibGUgaW4gdGhlIHRlbXBsYXRlIHRvbwoJLy8gICAgICAgICAgICAvLyAtIG9wdGlvbnMgZ2l2ZXMgeW91IGFjY2VzcyB0byBhbnkgb3RoZXIgcHJvcGVydGllcyBzZXQgb24gImRhdGEtYmluZDogeyB0ZW1wbGF0ZTogb3B0aW9ucyB9IgoJLy8gICAgICAgICAgICAvLwoJLy8gICAgICAgICAgICAvLyBSZXR1cm4gdmFsdWU6IGFuIGFycmF5IG9mIERPTSBub2RlcwoJLy8gICAgICAgIH0KCS8vCgkvLyBbM10gT3ZlcnJpZGUgJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jaycsIHN1cHBseWluZyBhIGZ1bmN0aW9uIHdpdGggdGhpcyBzaWduYXR1cmU6CgkvLwoJLy8gICAgICAgIGZ1bmN0aW9uIChzY3JpcHQpIHsKCS8vICAgICAgICAgICAgLy8gUmV0dXJuIHZhbHVlOiBXaGF0ZXZlciBzeW50YXggbWVhbnMgIkV2YWx1YXRlIHRoZSBKYXZhU2NyaXB0IHN0YXRlbWVudCAnc2NyaXB0JyBhbmQgb3V0cHV0IHRoZSByZXN1bHQiCgkvLyAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgRm9yIGV4YW1wbGUsIHRoZSBqcXVlcnkudG1wbCB0ZW1wbGF0ZSBlbmdpbmUgY29udmVydHMgJ3NvbWVTY3JpcHQnIHRvICckeyBzb21lU2NyaXB0IH0nCgkvLyAgICAgICAgfQoJLy8KCS8vICAgICBUaGlzIGlzIG9ubHkgbmVjZXNzYXJ5IGlmIHlvdSB3YW50IHRvIGFsbG93IGRhdGEtYmluZCBhdHRyaWJ1dGVzIHRvIHJlZmVyZW5jZSBhcmJpdHJhcnkgdGVtcGxhdGUgdmFyaWFibGVzLgoJLy8gICAgIElmIHlvdSBkb24ndCB3YW50IHRvIGFsbG93IHRoYXQsIHlvdSBjYW4gc2V0IHRoZSBwcm9wZXJ0eSAnYWxsb3dUZW1wbGF0ZVJld3JpdGluZycgdG8gZmFsc2UgKGxpa2Uga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUgZG9lcykKCS8vICAgICBhbmQgdGhlbiB5b3UgZG9uJ3QgbmVlZCB0byBvdmVycmlkZSAnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJy4KCglrby50ZW1wbGF0ZUVuZ2luZSA9IGZ1bmN0aW9uICgpIHsgfTsKCglrby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CgkgICAgdGhyb3cgbmV3IEVycm9yKCJPdmVycmlkZSByZW5kZXJUZW1wbGF0ZVNvdXJjZSIpOwoJfTsKCglrby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jayddID0gZnVuY3Rpb24gKHNjcmlwdCkgewoJICAgIHRocm93IG5ldyBFcnJvcigiT3ZlcnJpZGUgY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrIik7Cgl9OwoKCWtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsnbWFrZVRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbih0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkgewoJICAgIC8vIE5hbWVkIHRlbXBsYXRlCgkgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PSAic3RyaW5nIikgewoJICAgICAgICB0ZW1wbGF0ZURvY3VtZW50ID0gdGVtcGxhdGVEb2N1bWVudCB8fCBkb2N1bWVudDsKCSAgICAgICAgdmFyIGVsZW0gPSB0ZW1wbGF0ZURvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRlbXBsYXRlKTsKCSAgICAgICAgaWYgKCFlbGVtKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmluZCB0ZW1wbGF0ZSB3aXRoIElEICIgKyB0ZW1wbGF0ZSk7CgkgICAgICAgIHJldHVybiBuZXcga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQoZWxlbSk7CgkgICAgfSBlbHNlIGlmICgodGVtcGxhdGUubm9kZVR5cGUgPT0gMSkgfHwgKHRlbXBsYXRlLm5vZGVUeXBlID09IDgpKSB7CgkgICAgICAgIC8vIEFub255bW91cyB0ZW1wbGF0ZQoJICAgICAgICByZXR1cm4gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZSh0ZW1wbGF0ZSk7CgkgICAgfSBlbHNlCgkgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biB0ZW1wbGF0ZSB0eXBlOiAiICsgdGVtcGxhdGUpOwoJfTsKCglrby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3JlbmRlclRlbXBsYXRlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCB0ZW1wbGF0ZURvY3VtZW50KSB7CgkgICAgdmFyIHRlbXBsYXRlU291cmNlID0gdGhpc1snbWFrZVRlbXBsYXRlU291cmNlJ10odGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpOwoJICAgIHJldHVybiB0aGlzWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucyk7Cgl9OwoKCWtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsnaXNUZW1wbGF0ZVJld3JpdHRlbiddID0gZnVuY3Rpb24gKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KSB7CgkgICAgLy8gU2tpcCByZXdyaXRpbmcgaWYgcmVxdWVzdGVkCgkgICAgaWYgKHRoaXNbJ2FsbG93VGVtcGxhdGVSZXdyaXRpbmcnXSA9PT0gZmFsc2UpCgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgIHJldHVybiB0aGlzWydtYWtlVGVtcGxhdGVTb3VyY2UnXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudClbJ2RhdGEnXSgiaXNSZXdyaXR0ZW4iKTsKCX07CgoJa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydyZXdyaXRlVGVtcGxhdGUnXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgcmV3cml0ZXJDYWxsYmFjaywgdGVtcGxhdGVEb2N1bWVudCkgewoJICAgIHZhciB0ZW1wbGF0ZVNvdXJjZSA9IHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KTsKCSAgICB2YXIgcmV3cml0dGVuID0gcmV3cml0ZXJDYWxsYmFjayh0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKCkpOwoJICAgIHRlbXBsYXRlU291cmNlWyd0ZXh0J10ocmV3cml0dGVuKTsKCSAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCJpc1Jld3JpdHRlbiIsIHRydWUpOwoJfTsKCglrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlRW5naW5lJywga28udGVtcGxhdGVFbmdpbmUpOwoKCWtvLnRlbXBsYXRlUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKCSAgICB2YXIgbWVtb2l6ZURhdGFCaW5kaW5nQXR0cmlidXRlU3ludGF4UmVnZXggPSAvKDwoW2Etel0rXGQqKSg/OlxzKyg/IWRhdGEtYmluZFxzKj1ccyopW2EtejAtOVwtXSsoPzo9KD86XCJbXlwiXSpcInxcJ1teXCddKlwnKSk/KSpccyspZGF0YS1iaW5kXHMqPVxzKihbIiddKShbXHNcU10qPylcMy9naTsKCSAgICB2YXIgbWVtb2l6ZVZpcnR1YWxDb250YWluZXJCaW5kaW5nU3ludGF4UmVnZXggPSAvPCEtLVxzKmtvXGJccyooW1xzXFNdKj8pXHMqLS0+L2c7CgoJICAgIGZ1bmN0aW9uIHZhbGlkYXRlRGF0YUJpbmRWYWx1ZXNGb3JSZXdyaXRpbmcoa2V5VmFsdWVBcnJheSkgewoJICAgICAgICB2YXIgYWxsVmFsaWRhdG9ycyA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzOwoJICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleVZhbHVlQXJyYXkubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgICAgIHZhciBrZXkgPSBrZXlWYWx1ZUFycmF5W2ldWydrZXknXTsKCSAgICAgICAgICAgIGlmIChhbGxWYWxpZGF0b3JzLmhhc093blByb3BlcnR5KGtleSkpIHsKCSAgICAgICAgICAgICAgICB2YXIgdmFsaWRhdG9yID0gYWxsVmFsaWRhdG9yc1trZXldOwoKCSAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbGlkYXRvciA9PT0gImZ1bmN0aW9uIikgewoJICAgICAgICAgICAgICAgICAgICB2YXIgcG9zc2libGVFcnJvck1lc3NhZ2UgPSB2YWxpZGF0b3Ioa2V5VmFsdWVBcnJheVtpXVsndmFsdWUnXSk7CgkgICAgICAgICAgICAgICAgICAgIGlmIChwb3NzaWJsZUVycm9yTWVzc2FnZSkKCSAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihwb3NzaWJsZUVycm9yTWVzc2FnZSk7CgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdmFsaWRhdG9yKSB7CgkgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyB0ZW1wbGF0ZSBlbmdpbmUgZG9lcyBub3Qgc3VwcG9ydCB0aGUgJyIgKyBrZXkgKyAiJyBiaW5kaW5nIHdpdGhpbiBpdHMgdGVtcGxhdGVzIik7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBjb25zdHJ1Y3RNZW1vaXplZFRhZ1JlcGxhY2VtZW50KGRhdGFCaW5kQXR0cmlidXRlVmFsdWUsIHRhZ1RvUmV0YWluLCBub2RlTmFtZSwgdGVtcGxhdGVFbmdpbmUpIHsKCSAgICAgICAgdmFyIGRhdGFCaW5kS2V5VmFsdWVBcnJheSA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsKGRhdGFCaW5kQXR0cmlidXRlVmFsdWUpOwoJICAgICAgICB2YWxpZGF0ZURhdGFCaW5kVmFsdWVzRm9yUmV3cml0aW5nKGRhdGFCaW5kS2V5VmFsdWVBcnJheSk7CgkgICAgICAgIHZhciByZXdyaXR0ZW5EYXRhQmluZEF0dHJpYnV0ZVZhbHVlID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MoZGF0YUJpbmRLZXlWYWx1ZUFycmF5LCB7J3ZhbHVlQWNjZXNzb3JzJzp0cnVlfSk7CgoJICAgICAgICAvLyBGb3Igbm8gb2J2aW91cyByZWFzb24sIE9wZXJhIGZhaWxzIHRvIGV2YWx1YXRlIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgdW5sZXNzIGl0J3Mgd3JhcHBlZCBpbiBhbiBhZGRpdGlvbmFsCgkgICAgICAgIC8vIGFub255bW91cyBmdW5jdGlvbiwgZXZlbiB0aG91Z2ggT3BlcmEncyBidWlsdC1pbiBkZWJ1Z2dlciBjYW4gZXZhbHVhdGUgaXQgYW55d2F5LiBObyBvdGhlciBicm93c2VyIHJlcXVpcmVzIHRoaXMKCSAgICAgICAgLy8gZXh0cmEgaW5kaXJlY3Rpb24uCgkgICAgICAgIHZhciBhcHBseUJpbmRpbmdzVG9OZXh0U2libGluZ1NjcmlwdCA9CgkgICAgICAgICAgICAia28uX190cl9hbWJ0bnMoZnVuY3Rpb24oJGNvbnRleHQsJGVsZW1lbnQpe3JldHVybihmdW5jdGlvbigpe3JldHVybnsgIiArIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgKyAiIH0gfSkoKX0sJyIgKyBub2RlTmFtZS50b0xvd2VyQ2FzZSgpICsgIicpIjsKCSAgICAgICAgcmV0dXJuIHRlbXBsYXRlRW5naW5lWydjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2snXShhcHBseUJpbmRpbmdzVG9OZXh0U2libGluZ1NjcmlwdCkgKyB0YWdUb1JldGFpbjsKCSAgICB9CgoJICAgIHJldHVybiB7CgkgICAgICAgIGVuc3VyZVRlbXBsYXRlSXNSZXdyaXR0ZW46IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgdGVtcGxhdGVFbmdpbmUsIHRlbXBsYXRlRG9jdW1lbnQpIHsKCSAgICAgICAgICAgIGlmICghdGVtcGxhdGVFbmdpbmVbJ2lzVGVtcGxhdGVSZXdyaXR0ZW4nXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkpCgkgICAgICAgICAgICAgICAgdGVtcGxhdGVFbmdpbmVbJ3Jld3JpdGVUZW1wbGF0ZSddKHRlbXBsYXRlLCBmdW5jdGlvbiAoaHRtbFN0cmluZykgewoJICAgICAgICAgICAgICAgICAgICByZXR1cm4ga28udGVtcGxhdGVSZXdyaXRpbmcubWVtb2l6ZUJpbmRpbmdBdHRyaWJ1dGVTeW50YXgoaHRtbFN0cmluZywgdGVtcGxhdGVFbmdpbmUpOwoJICAgICAgICAgICAgICAgIH0sIHRlbXBsYXRlRG9jdW1lbnQpOwoJICAgICAgICB9LAoKCSAgICAgICAgbWVtb2l6ZUJpbmRpbmdBdHRyaWJ1dGVTeW50YXg6IGZ1bmN0aW9uIChodG1sU3RyaW5nLCB0ZW1wbGF0ZUVuZ2luZSkgewoJICAgICAgICAgICAgcmV0dXJuIGh0bWxTdHJpbmcucmVwbGFjZShtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCwgZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgICAgIHJldHVybiBjb25zdHJ1Y3RNZW1vaXplZFRhZ1JlcGxhY2VtZW50KC8qIGRhdGFCaW5kQXR0cmlidXRlVmFsdWU6ICovIGFyZ3VtZW50c1s0XSwgLyogdGFnVG9SZXRhaW46ICovIGFyZ3VtZW50c1sxXSwgLyogbm9kZU5hbWU6ICovIGFyZ3VtZW50c1syXSwgdGVtcGxhdGVFbmdpbmUpOwoJICAgICAgICAgICAgfSkucmVwbGFjZShtZW1vaXplVmlydHVhbENvbnRhaW5lckJpbmRpbmdTeW50YXhSZWdleCwgZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzFdLCAvKiB0YWdUb1JldGFpbjogKi8gIjwhLS0ga28gLS0+IiwgLyogbm9kZU5hbWU6ICovICIjY29tbWVudCIsIHRlbXBsYXRlRW5naW5lKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9LAoKCSAgICAgICAgYXBwbHlNZW1vaXplZEJpbmRpbmdzVG9OZXh0U2libGluZzogZnVuY3Rpb24gKGJpbmRpbmdzLCBub2RlTmFtZSkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoZnVuY3Rpb24gKGRvbU5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgICAgICAgICAgdmFyIG5vZGVUb0JpbmQgPSBkb21Ob2RlLm5leHRTaWJsaW5nOwoJICAgICAgICAgICAgICAgIGlmIChub2RlVG9CaW5kICYmIG5vZGVUb0JpbmQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbm9kZU5hbWUpIHsKCSAgICAgICAgICAgICAgICAgICAga28uYXBwbHlCaW5kaW5nQWNjZXNzb3JzVG9Ob2RlKG5vZGVUb0JpbmQsIGJpbmRpbmdzLCBiaW5kaW5nQ29udGV4dCk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0KCSAgICB9Cgl9KSgpOwoKCgkvLyBFeHBvcnRlZCBvbmx5IGJlY2F1c2UgaXQgaGFzIHRvIGJlIHJlZmVyZW5jZWQgYnkgc3RyaW5nIGxvb2t1cCBmcm9tIHdpdGhpbiByZXdyaXR0ZW4gdGVtcGxhdGUKCWtvLmV4cG9ydFN5bWJvbCgnX190cl9hbWJ0bnMnLCBrby50ZW1wbGF0ZVJld3JpdGluZy5hcHBseU1lbW9pemVkQmluZGluZ3NUb05leHRTaWJsaW5nKTsKCShmdW5jdGlvbigpIHsKCSAgICAvLyBBIHRlbXBsYXRlIHNvdXJjZSByZXByZXNlbnRzIGEgcmVhZC93cml0ZSB3YXkgb2YgYWNjZXNzaW5nIGEgdGVtcGxhdGUuIFRoaXMgaXMgdG8gZWxpbWluYXRlIHRoZSBuZWVkIGZvciB0ZW1wbGF0ZSBsb2FkaW5nL3NhdmluZwoJICAgIC8vIGxvZ2ljIHRvIGJlIGR1cGxpY2F0ZWQgaW4gZXZlcnkgdGVtcGxhdGUgZW5naW5lIChhbmQgbWVhbnMgdGhleSBjYW4gYWxsIHdvcmsgd2l0aCBhbm9ueW1vdXMgdGVtcGxhdGVzLCBldGMuKQoJICAgIC8vCgkgICAgLy8gVHdvIGFyZSBwcm92aWRlZCBieSBkZWZhdWx0OgoJICAgIC8vICAxLiBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCAgICAgICAtIHJlYWRzL3dyaXRlcyB0aGUgdGV4dCBjb250ZW50IG9mIGFuIGFyYml0cmFyeSBET00gZWxlbWVudAoJICAgIC8vICAyLiBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzRWxlbWVudCAtIHVzZXMga28udXRpbHMuZG9tRGF0YSB0byByZWFkL3dyaXRlIHRleHQgKmFzc29jaWF0ZWQqIHdpdGggdGhlIERPTSBlbGVtZW50LCBidXQKCSAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRob3V0IHJlYWRpbmcvd3JpdGluZyB0aGUgYWN0dWFsIGVsZW1lbnQgdGV4dCBjb250ZW50LCBzaW5jZSBpdCB3aWxsIGJlIG92ZXJ3cml0dGVuCgkgICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aCB0aGUgcmVuZGVyZWQgdGVtcGxhdGUgb3V0cHV0LgoJICAgIC8vIFlvdSBjYW4gaW1wbGVtZW50IHlvdXIgb3duIHRlbXBsYXRlIHNvdXJjZSBpZiB5b3Ugd2FudCB0byBmZXRjaC9zdG9yZSB0ZW1wbGF0ZXMgc29tZXdoZXJlIG90aGVyIHRoYW4gaW4gRE9NIGVsZW1lbnRzLgoJICAgIC8vIFRlbXBsYXRlIHNvdXJjZXMgbmVlZCB0byBoYXZlIHRoZSBmb2xsb3dpbmcgZnVuY3Rpb25zOgoJICAgIC8vICAgdGV4dCgpIAkJCS0gcmV0dXJucyB0aGUgdGVtcGxhdGUgdGV4dCBmcm9tIHlvdXIgc3RvcmFnZSBsb2NhdGlvbgoJICAgIC8vICAgdGV4dCh2YWx1ZSkJCS0gd3JpdGVzIHRoZSBzdXBwbGllZCB0ZW1wbGF0ZSB0ZXh0IHRvIHlvdXIgc3RvcmFnZSBsb2NhdGlvbgoJICAgIC8vICAgZGF0YShrZXkpCQkJLSByZWFkcyB2YWx1ZXMgc3RvcmVkIHVzaW5nIGRhdGEoa2V5LCB2YWx1ZSkgLSBzZWUgYmVsb3cKCSAgICAvLyAgIGRhdGEoa2V5LCB2YWx1ZSkJLSBhc3NvY2lhdGVzICJ2YWx1ZSIgd2l0aCB0aGlzIHRlbXBsYXRlIGFuZCB0aGUga2V5ICJrZXkiLiBJcyB1c2VkIHRvIHN0b3JlIGluZm9ybWF0aW9uIGxpa2UgImlzUmV3cml0dGVuIi4KCSAgICAvLwoJICAgIC8vIE9wdGlvbmFsbHksIHRlbXBsYXRlIHNvdXJjZXMgY2FuIGFsc28gaGF2ZSB0aGUgZm9sbG93aW5nIGZ1bmN0aW9uczoKCSAgICAvLyAgIG5vZGVzKCkgICAgICAgICAgICAtIHJldHVybnMgYSBET00gZWxlbWVudCBjb250YWluaW5nIHRoZSBub2RlcyBvZiB0aGlzIHRlbXBsYXRlLCB3aGVyZSBhdmFpbGFibGUKCSAgICAvLyAgIG5vZGVzKHZhbHVlKSAgICAgICAtIHdyaXRlcyB0aGUgZ2l2ZW4gRE9NIGVsZW1lbnQgdG8geW91ciBzdG9yYWdlIGxvY2F0aW9uCgkgICAgLy8gSWYgYSBET00gZWxlbWVudCBpcyBhdmFpbGFibGUgZm9yIGEgZ2l2ZW4gdGVtcGxhdGUgc291cmNlLCB0ZW1wbGF0ZSBlbmdpbmVzIGFyZSBlbmNvdXJhZ2VkIHRvIHVzZSBpdCBpbiBwcmVmZXJlbmNlIG92ZXIgdGV4dCgpCgkgICAgLy8gZm9yIGltcHJvdmVkIHNwZWVkLiBIb3dldmVyLCBhbGwgdGVtcGxhdGVTb3VyY2VzIG11c3Qgc3VwcGx5IHRleHQoKSBldmVuIGlmIHRoZXkgZG9uJ3Qgc3VwcGx5IG5vZGVzKCkuCgkgICAgLy8KCSAgICAvLyBPbmNlIHlvdSd2ZSBpbXBsZW1lbnRlZCBhIHRlbXBsYXRlU291cmNlLCBtYWtlIHlvdXIgdGVtcGxhdGUgZW5naW5lIHVzZSBpdCBieSBzdWJjbGFzc2luZyB3aGF0ZXZlciB0ZW1wbGF0ZSBlbmdpbmUgeW91IHdlcmUKCSAgICAvLyB1c2luZyBhbmQgb3ZlcnJpZGluZyAibWFrZVRlbXBsYXRlU291cmNlIiB0byByZXR1cm4gYW4gaW5zdGFuY2Ugb2YgeW91ciBjdXN0b20gdGVtcGxhdGUgc291cmNlLgoKCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMgPSB7fTsKCgkgICAgLy8gLS0tLSBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCAtLS0tLQoKCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKCSAgICAgICAgdGhpcy5kb21FbGVtZW50ID0gZWxlbWVudDsKCSAgICB9CgoJICAgIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50LnByb3RvdHlwZVsndGV4dCddID0gZnVuY3Rpb24oLyogdmFsdWVUb1dyaXRlICovKSB7CgkgICAgICAgIHZhciB0YWdOYW1lTG93ZXIgPSBrby51dGlscy50YWdOYW1lTG93ZXIodGhpcy5kb21FbGVtZW50KSwKCSAgICAgICAgICAgIGVsZW1Db250ZW50c1Byb3BlcnR5ID0gdGFnTmFtZUxvd2VyID09PSAic2NyaXB0IiA/ICJ0ZXh0IgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB0YWdOYW1lTG93ZXIgPT09ICJ0ZXh0YXJlYSIgPyAidmFsdWUiCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICJpbm5lckhUTUwiOwoKCSAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkgewoJICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tRWxlbWVudFtlbGVtQ29udGVudHNQcm9wZXJ0eV07CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICB2YXIgdmFsdWVUb1dyaXRlID0gYXJndW1lbnRzWzBdOwoJICAgICAgICAgICAgaWYgKGVsZW1Db250ZW50c1Byb3BlcnR5ID09PSAiaW5uZXJIVE1MIikKCSAgICAgICAgICAgICAgICBrby51dGlscy5zZXRIdG1sKHRoaXMuZG9tRWxlbWVudCwgdmFsdWVUb1dyaXRlKTsKCSAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICB0aGlzLmRvbUVsZW1lbnRbZWxlbUNvbnRlbnRzUHJvcGVydHldID0gdmFsdWVUb1dyaXRlOwoJICAgICAgICB9CgkgICAgfTsKCgkgICAgdmFyIGRhdGFEb21EYXRhUHJlZml4ID0ga28udXRpbHMuZG9tRGF0YS5uZXh0S2V5KCkgKyAiXyI7CgkgICAga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQucHJvdG90eXBlWydkYXRhJ10gPSBmdW5jdGlvbihrZXkgLyosIHZhbHVlVG9Xcml0ZSAqLykgewoJICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KHRoaXMuZG9tRWxlbWVudCwgZGF0YURvbURhdGFQcmVmaXggKyBrZXkpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQodGhpcy5kb21FbGVtZW50LCBkYXRhRG9tRGF0YVByZWZpeCArIGtleSwgYXJndW1lbnRzWzFdKTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIC8vIC0tLS0ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlIC0tLS0tCgkgICAgLy8gQW5vbnltb3VzIHRlbXBsYXRlcyBhcmUgbm9ybWFsbHkgc2F2ZWQvcmV0cmlldmVkIGFzIERPTSBub2RlcyB0aHJvdWdoICJub2RlcyIuCgkgICAgLy8gRm9yIGNvbXBhdGliaWxpdHksIHlvdSBjYW4gYWxzbyByZWFkICJ0ZXh0IjsgaXQgd2lsbCBiZSBzZXJpYWxpemVkIGZyb20gdGhlIG5vZGVzIG9uIGRlbWFuZC4KCSAgICAvLyBXcml0aW5nIHRvICJ0ZXh0IiBpcyBzdGlsbCBzdXBwb3J0ZWQsIGJ1dCB0aGVuIHRoZSB0ZW1wbGF0ZSBkYXRhIHdpbGwgbm90IGJlIGF2YWlsYWJsZSBhcyBET00gbm9kZXMuCgoJICAgIHZhciBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5ID0ga28udXRpbHMuZG9tRGF0YS5uZXh0S2V5KCk7CgkgICAga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlID0gZnVuY3Rpb24oZWxlbWVudCkgewoJICAgICAgICB0aGlzLmRvbUVsZW1lbnQgPSBlbGVtZW50OwoJICAgIH0KCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlID0gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50KCk7CgkgICAga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZTsKCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKCSAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkgewoJICAgICAgICAgICAgdmFyIHRlbXBsYXRlRGF0YSA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KHRoaXMuZG9tRWxlbWVudCwgYW5vbnltb3VzVGVtcGxhdGVzRG9tRGF0YUtleSkgfHwge307CgkgICAgICAgICAgICBpZiAodGVtcGxhdGVEYXRhLnRleHREYXRhID09PSB1bmRlZmluZWQgJiYgdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGEpCgkgICAgICAgICAgICAgICAgdGVtcGxhdGVEYXRhLnRleHREYXRhID0gdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGEuaW5uZXJIVE1MOwoJICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlRGF0YS50ZXh0RGF0YTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHZhciB2YWx1ZVRvV3JpdGUgPSBhcmd1bWVudHNbMF07CgkgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXksIHt0ZXh0RGF0YTogdmFsdWVUb1dyaXRlfSk7CgkgICAgICAgIH0KCSAgICB9OwoJICAgIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50LnByb3RvdHlwZVsnbm9kZXMnXSA9IGZ1bmN0aW9uKC8qIHZhbHVlVG9Xcml0ZSAqLykgewoJICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CgkgICAgICAgICAgICB2YXIgdGVtcGxhdGVEYXRhID0ga28udXRpbHMuZG9tRGF0YS5nZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5KSB8fCB7fTsKCSAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZURhdGEuY29udGFpbmVyRGF0YTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHZhciB2YWx1ZVRvV3JpdGUgPSBhcmd1bWVudHNbMF07CgkgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXksIHtjb250YWluZXJEYXRhOiB2YWx1ZVRvV3JpdGV9KTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIGtvLmV4cG9ydFN5bWJvbCgndGVtcGxhdGVTb3VyY2VzJywga28udGVtcGxhdGVTb3VyY2VzKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlU291cmNlcy5kb21FbGVtZW50Jywga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQpOwoJICAgIGtvLmV4cG9ydFN5bWJvbCgndGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlJywga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlKTsKCX0pKCk7CgkoZnVuY3Rpb24gKCkgewoJICAgIHZhciBfdGVtcGxhdGVFbmdpbmU7CgkgICAga28uc2V0VGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbiAodGVtcGxhdGVFbmdpbmUpIHsKCSAgICAgICAgaWYgKCh0ZW1wbGF0ZUVuZ2luZSAhPSB1bmRlZmluZWQpICYmICEodGVtcGxhdGVFbmdpbmUgaW5zdGFuY2VvZiBrby50ZW1wbGF0ZUVuZ2luZSkpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRlbXBsYXRlRW5naW5lIG11c3QgaW5oZXJpdCBmcm9tIGtvLnRlbXBsYXRlRW5naW5lIik7CgkgICAgICAgIF90ZW1wbGF0ZUVuZ2luZSA9IHRlbXBsYXRlRW5naW5lOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gaW52b2tlRm9yRWFjaE5vZGVJbkNvbnRpbnVvdXNSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlLCBhY3Rpb24pIHsKCSAgICAgICAgdmFyIG5vZGUsIG5leHRJblF1ZXVlID0gZmlyc3ROb2RlLCBmaXJzdE91dE9mUmFuZ2VOb2RlID0ga28udmlydHVhbEVsZW1lbnRzLm5leHRTaWJsaW5nKGxhc3ROb2RlKTsKCSAgICAgICAgd2hpbGUgKG5leHRJblF1ZXVlICYmICgobm9kZSA9IG5leHRJblF1ZXVlKSAhPT0gZmlyc3RPdXRPZlJhbmdlTm9kZSkpIHsKCSAgICAgICAgICAgIG5leHRJblF1ZXVlID0ga28udmlydHVhbEVsZW1lbnRzLm5leHRTaWJsaW5nKG5vZGUpOwoJICAgICAgICAgICAgYWN0aW9uKG5vZGUsIG5leHRJblF1ZXVlKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gYWN0aXZhdGVCaW5kaW5nc09uQ29udGludW91c05vZGVBcnJheShjb250aW51b3VzTm9kZUFycmF5LCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAvLyBUbyBiZSB1c2VkIG9uIGFueSBub2RlcyB0aGF0IGhhdmUgYmVlbiByZW5kZXJlZCBieSBhIHRlbXBsYXRlIGFuZCBoYXZlIGJlZW4gaW5zZXJ0ZWQgaW50byBzb21lIHBhcmVudCBlbGVtZW50CgkgICAgICAgIC8vIFdhbGtzIHRocm91Z2ggY29udGludW91c05vZGVBcnJheSAod2hpY2ggKm11c3QqIGJlIGNvbnRpbnVvdXMsIGkuZS4sIGFuIHVuaW50ZXJydXB0ZWQgc2VxdWVuY2Ugb2Ygc2libGluZyBub2RlcywgYmVjYXVzZQoJICAgICAgICAvLyB0aGUgYWxnb3JpdGhtIGZvciB3YWxraW5nIHRoZW0gcmVsaWVzIG9uIHRoaXMpLCBhbmQgZm9yIGVhY2ggdG9wLWxldmVsIGl0ZW0gaW4gdGhlIHZpcnR1YWwtZWxlbWVudCBzZW5zZSwKCSAgICAgICAgLy8gKDEpIERvZXMgYSByZWd1bGFyICJhcHBseUJpbmRpbmdzIiB0byBhc3NvY2lhdGUgYmluZGluZ0NvbnRleHQgd2l0aCB0aGlzIG5vZGUgYW5kIHRvIGFjdGl2YXRlIGFueSBub24tbWVtb2l6ZWQgYmluZGluZ3MKCSAgICAgICAgLy8gKDIpIFVubWVtb2l6ZXMgYW55IG1lbW9zIGluIHRoZSBET00gc3VidHJlZSAoZS5nLiwgdG8gYWN0aXZhdGUgYmluZGluZ3MgdGhhdCBoYWQgYmVlbiBtZW1vaXplZCBkdXJpbmcgdGVtcGxhdGUgcmV3cml0aW5nKQoKCSAgICAgICAgaWYgKGNvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoKSB7CgkgICAgICAgICAgICB2YXIgZmlyc3ROb2RlID0gY29udGludW91c05vZGVBcnJheVswXSwKCSAgICAgICAgICAgICAgICBsYXN0Tm9kZSA9IGNvbnRpbnVvdXNOb2RlQXJyYXlbY29udGludW91c05vZGVBcnJheS5sZW5ndGggLSAxXSwKCSAgICAgICAgICAgICAgICBwYXJlbnROb2RlID0gZmlyc3ROb2RlLnBhcmVudE5vZGUsCgkgICAgICAgICAgICAgICAgcHJvdmlkZXIgPSBrby5iaW5kaW5nUHJvdmlkZXJbJ2luc3RhbmNlJ10sCgkgICAgICAgICAgICAgICAgcHJlcHJvY2Vzc05vZGUgPSBwcm92aWRlclsncHJlcHJvY2Vzc05vZGUnXTsKCgkgICAgICAgICAgICBpZiAocHJlcHJvY2Vzc05vZGUpIHsKCSAgICAgICAgICAgICAgICBpbnZva2VGb3JFYWNoTm9kZUluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGZ1bmN0aW9uKG5vZGUsIG5leHROb2RlSW5SYW5nZSkgewoJICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZVByZXZpb3VzU2libGluZyA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwoJICAgICAgICAgICAgICAgICAgICB2YXIgbmV3Tm9kZXMgPSBwcmVwcm9jZXNzTm9kZS5jYWxsKHByb3ZpZGVyLCBub2RlKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKG5ld05vZGVzKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZmlyc3ROb2RlKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0Tm9kZSA9IG5ld05vZGVzWzBdIHx8IG5leHROb2RlSW5SYW5nZTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBsYXN0Tm9kZSkKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0Tm9kZSA9IG5ld05vZGVzW25ld05vZGVzLmxlbmd0aCAtIDFdIHx8IG5vZGVQcmV2aW91c1NpYmxpbmc7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9KTsKCgkgICAgICAgICAgICAgICAgLy8gQmVjYXVzZSBwcmVwcm9jZXNzTm9kZSBjYW4gY2hhbmdlIHRoZSBub2RlcywgaW5jbHVkaW5nIHRoZSBmaXJzdCBhbmQgbGFzdCBub2RlcywgdXBkYXRlIGNvbnRpbnVvdXNOb2RlQXJyYXkgdG8gbWF0Y2guCgkgICAgICAgICAgICAgICAgLy8gV2UgbmVlZCB0aGUgZnVsbCBzZXQsIGluY2x1ZGluZyBpbm5lciBub2RlcywgYmVjYXVzZSB0aGUgdW5tZW1vaXplIHN0ZXAgbWlnaHQgcmVtb3ZlIHRoZSBmaXJzdCBub2RlIChhbmQgc28gdGhlIHJlYWwKCSAgICAgICAgICAgICAgICAvLyBmaXJzdCBub2RlIG5lZWRzIHRvIGJlIGluIHRoZSBhcnJheSkuCgkgICAgICAgICAgICAgICAgY29udGludW91c05vZGVBcnJheS5sZW5ndGggPSAwOwoJICAgICAgICAgICAgICAgIGlmICghZmlyc3ROb2RlKSB7IC8vIHByZXByb2Nlc3NOb2RlIG1pZ2h0IGhhdmUgcmVtb3ZlZCBhbGwgdGhlIG5vZGVzLCBpbiB3aGljaCBjYXNlIHRoZXJlJ3Mgbm90aGluZyBsZWZ0IHRvIGRvCgkgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKGZpcnN0Tm9kZSA9PT0gbGFzdE5vZGUpIHsKCSAgICAgICAgICAgICAgICAgICAgY29udGludW91c05vZGVBcnJheS5wdXNoKGZpcnN0Tm9kZSk7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgY29udGludW91c05vZGVBcnJheS5wdXNoKGZpcnN0Tm9kZSwgbGFzdE5vZGUpOwoJICAgICAgICAgICAgICAgICAgICBrby51dGlscy5maXhVcENvbnRpbnVvdXNOb2RlQXJyYXkoY29udGludW91c05vZGVBcnJheSwgcGFyZW50Tm9kZSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIC8vIE5lZWQgdG8gYXBwbHlCaW5kaW5ncyAqYmVmb3JlKiB1bm1lbW96aWF0aW9uLCBiZWNhdXNlIHVubWVtb2l6YXRpb24gbWlnaHQgaW50cm9kdWNlIGV4dHJhIG5vZGVzICh0aGF0IHdlIGRvbid0IHdhbnQgdG8gcmUtYmluZCkKCSAgICAgICAgICAgIC8vIHdoZXJlYXMgYSByZWd1bGFyIGFwcGx5QmluZGluZ3Mgd29uJ3QgaW50cm9kdWNlIG5ldyBtZW1vaXplZCBub2RlcwoJICAgICAgICAgICAgaW52b2tlRm9yRWFjaE5vZGVJbkNvbnRpbnVvdXNSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlLCBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEgfHwgbm9kZS5ub2RlVHlwZSA9PT0gOCkKCSAgICAgICAgICAgICAgICAgICAga28uYXBwbHlCaW5kaW5ncyhiaW5kaW5nQ29udGV4dCwgbm9kZSk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIGludm9rZUZvckVhY2hOb2RlSW5Db250aW51b3VzUmFuZ2UoZmlyc3ROb2RlLCBsYXN0Tm9kZSwgZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxIHx8IG5vZGUubm9kZVR5cGUgPT09IDgpCgkgICAgICAgICAgICAgICAgICAgIGtvLm1lbW9pemF0aW9uLnVubWVtb2l6ZURvbU5vZGVBbmREZXNjZW5kYW50cyhub2RlLCBbYmluZGluZ0NvbnRleHRdKTsKCSAgICAgICAgICAgIH0pOwoKCSAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSBhbnkgY2hhbmdlcyBkb25lIGJ5IGFwcGx5QmluZGluZ3Mgb3IgdW5tZW1vaXplIGFyZSByZWZsZWN0ZWQgaW4gdGhlIGFycmF5CgkgICAgICAgICAgICBrby51dGlscy5maXhVcENvbnRpbnVvdXNOb2RlQXJyYXkoY29udGludW91c05vZGVBcnJheSwgcGFyZW50Tm9kZSk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KG5vZGVPck5vZGVBcnJheSkgewoJICAgICAgICByZXR1cm4gbm9kZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gbm9kZU9yTm9kZUFycmF5CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBub2RlT3JOb2RlQXJyYXkubGVuZ3RoID4gMCA/IG5vZGVPck5vZGVBcnJheVswXQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogbnVsbDsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGV4ZWN1dGVUZW1wbGF0ZSh0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlck1vZGUsIHRlbXBsYXRlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewoJICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgICAgICAgdmFyIGZpcnN0VGFyZ2V0Tm9kZSA9IHRhcmdldE5vZGVPck5vZGVBcnJheSAmJiBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheSh0YXJnZXROb2RlT3JOb2RlQXJyYXkpOwoJICAgICAgICB2YXIgdGVtcGxhdGVEb2N1bWVudCA9IGZpcnN0VGFyZ2V0Tm9kZSAmJiBmaXJzdFRhcmdldE5vZGUub3duZXJEb2N1bWVudDsKCSAgICAgICAgdmFyIHRlbXBsYXRlRW5naW5lVG9Vc2UgPSAob3B0aW9uc1sndGVtcGxhdGVFbmdpbmUnXSB8fCBfdGVtcGxhdGVFbmdpbmUpOwoJICAgICAgICBrby50ZW1wbGF0ZVJld3JpdGluZy5lbnN1cmVUZW1wbGF0ZUlzUmV3cml0dGVuKHRlbXBsYXRlLCB0ZW1wbGF0ZUVuZ2luZVRvVXNlLCB0ZW1wbGF0ZURvY3VtZW50KTsKCSAgICAgICAgdmFyIHJlbmRlcmVkTm9kZXNBcnJheSA9IHRlbXBsYXRlRW5naW5lVG9Vc2VbJ3JlbmRlclRlbXBsYXRlJ10odGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCB0ZW1wbGF0ZURvY3VtZW50KTsKCgkgICAgICAgIC8vIExvb3NlbHkgY2hlY2sgcmVzdWx0IGlzIGFuIGFycmF5IG9mIERPTSBub2RlcwoJICAgICAgICBpZiAoKHR5cGVvZiByZW5kZXJlZE5vZGVzQXJyYXkubGVuZ3RoICE9ICJudW1iZXIiKSB8fCAocmVuZGVyZWROb2Rlc0FycmF5Lmxlbmd0aCA+IDAgJiYgdHlwZW9mIHJlbmRlcmVkTm9kZXNBcnJheVswXS5ub2RlVHlwZSAhPSAibnVtYmVyIikpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRlbXBsYXRlIGVuZ2luZSBtdXN0IHJldHVybiBhbiBhcnJheSBvZiBET00gbm9kZXMiKTsKCgkgICAgICAgIHZhciBoYXZlQWRkZWROb2Rlc1RvUGFyZW50ID0gZmFsc2U7CgkgICAgICAgIHN3aXRjaCAocmVuZGVyTW9kZSkgewoJICAgICAgICAgICAgY2FzZSAicmVwbGFjZUNoaWxkcmVuIjoKCSAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyZWROb2Rlc0FycmF5KTsKCSAgICAgICAgICAgICAgICBoYXZlQWRkZWROb2Rlc1RvUGFyZW50ID0gdHJ1ZTsKCSAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgIGNhc2UgInJlcGxhY2VOb2RlIjoKCSAgICAgICAgICAgICAgICBrby51dGlscy5yZXBsYWNlRG9tTm9kZXModGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJlZE5vZGVzQXJyYXkpOwoJICAgICAgICAgICAgICAgIGhhdmVBZGRlZE5vZGVzVG9QYXJlbnQgPSB0cnVlOwoJICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgY2FzZSAiaWdub3JlVGFyZ2V0Tm9kZSI6IGJyZWFrOwoJICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gcmVuZGVyTW9kZTogIiArIHJlbmRlck1vZGUpOwoJICAgICAgICB9CgoJICAgICAgICBpZiAoaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCkgewoJICAgICAgICAgICAgYWN0aXZhdGVCaW5kaW5nc09uQ29udGludW91c05vZGVBcnJheShyZW5kZXJlZE5vZGVzQXJyYXksIGJpbmRpbmdDb250ZXh0KTsKCSAgICAgICAgICAgIGlmIChvcHRpb25zWydhZnRlclJlbmRlciddKQoJICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKG9wdGlvbnNbJ2FmdGVyUmVuZGVyJ10sIG51bGwsIFtyZW5kZXJlZE5vZGVzQXJyYXksIGJpbmRpbmdDb250ZXh0WyckZGF0YSddXSk7CgkgICAgICAgIH0KCgkgICAgICAgIHJldHVybiByZW5kZXJlZE5vZGVzQXJyYXk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiByZXNvbHZlVGVtcGxhdGVOYW1lKHRlbXBsYXRlLCBkYXRhLCBjb250ZXh0KSB7CgkgICAgICAgIC8vIFRoZSB0ZW1wbGF0ZSBjYW4gYmUgc3BlY2lmaWVkIGFzOgoJICAgICAgICBpZiAoa28uaXNPYnNlcnZhYmxlKHRlbXBsYXRlKSkgewoJICAgICAgICAgICAgLy8gMS4gQW4gb2JzZXJ2YWJsZSwgd2l0aCBzdHJpbmcgdmFsdWUKCSAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZSgpOwoJICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgLy8gMi4gQSBmdW5jdGlvbiBvZiAoZGF0YSwgY29udGV4dCkgcmV0dXJuaW5nIGEgc3RyaW5nCgkgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGUoZGF0YSwgY29udGV4dCk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAvLyAzLiBBIHN0cmluZwoJICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBrby5yZW5kZXJUZW1wbGF0ZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgZGF0YU9yQmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSkgewoJICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgICAgICAgaWYgKChvcHRpb25zWyd0ZW1wbGF0ZUVuZ2luZSddIHx8IF90ZW1wbGF0ZUVuZ2luZSkgPT0gdW5kZWZpbmVkKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTZXQgYSB0ZW1wbGF0ZSBlbmdpbmUgYmVmb3JlIGNhbGxpbmcgcmVuZGVyVGVtcGxhdGUiKTsKCSAgICAgICAgcmVuZGVyTW9kZSA9IHJlbmRlck1vZGUgfHwgInJlcGxhY2VDaGlsZHJlbiI7CgoJICAgICAgICBpZiAodGFyZ2V0Tm9kZU9yTm9kZUFycmF5KSB7CgkgICAgICAgICAgICB2YXIgZmlyc3RUYXJnZXROb2RlID0gZ2V0Rmlyc3ROb2RlRnJvbVBvc3NpYmxlQXJyYXkodGFyZ2V0Tm9kZU9yTm9kZUFycmF5KTsKCgkgICAgICAgICAgICB2YXIgd2hlblRvRGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICghZmlyc3RUYXJnZXROb2RlKSB8fCAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KGZpcnN0VGFyZ2V0Tm9kZSk7IH07IC8vIFBhc3NpdmUgZGlzcG9zYWwgKG9uIG5leHQgZXZhbHVhdGlvbikKCSAgICAgICAgICAgIHZhciBhY3RpdmVseURpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCA9IChmaXJzdFRhcmdldE5vZGUgJiYgcmVuZGVyTW9kZSA9PSAicmVwbGFjZU5vZGUiKSA/IGZpcnN0VGFyZ2V0Tm9kZS5wYXJlbnROb2RlIDogZmlyc3RUYXJnZXROb2RlOwoKCSAgICAgICAgICAgIHJldHVybiBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKCAvLyBTbyB0aGUgRE9NIGlzIGF1dG9tYXRpY2FsbHkgdXBkYXRlZCB3aGVuIGFueSBkZXBlbmRlbmN5IGNoYW5nZXMKCSAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3ZSd2ZSBnb3QgYSBwcm9wZXIgYmluZGluZyBjb250ZXh0IHRvIHdvcmsgd2l0aAoJICAgICAgICAgICAgICAgICAgICB2YXIgYmluZGluZ0NvbnRleHQgPSAoZGF0YU9yQmluZGluZ0NvbnRleHQgJiYgKGRhdGFPckJpbmRpbmdDb250ZXh0IGluc3RhbmNlb2Yga28uYmluZGluZ0NvbnRleHQpKQoJICAgICAgICAgICAgICAgICAgICAgICAgPyBkYXRhT3JCaW5kaW5nQ29udGV4dAoJICAgICAgICAgICAgICAgICAgICAgICAgOiBuZXcga28uYmluZGluZ0NvbnRleHQoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhT3JCaW5kaW5nQ29udGV4dCkpOwoKCSAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlTmFtZSA9IHJlc29sdmVUZW1wbGF0ZU5hbWUodGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0WyckZGF0YSddLCBiaW5kaW5nQ29udGV4dCksCgkgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJlZE5vZGVzQXJyYXkgPSBleGVjdXRlVGVtcGxhdGUodGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJNb2RlLCB0ZW1wbGF0ZU5hbWUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKTsKCgkgICAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJNb2RlID09ICJyZXBsYWNlTm9kZSIpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldE5vZGVPck5vZGVBcnJheSA9IHJlbmRlcmVkTm9kZXNBcnJheTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0VGFyZ2V0Tm9kZSA9IGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9LAoJICAgICAgICAgICAgICAgIG51bGwsCgkgICAgICAgICAgICAgICAgeyBkaXNwb3NlV2hlbjogd2hlblRvRGlzcG9zZSwgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBhY3RpdmVseURpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCB9CgkgICAgICAgICAgICApOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgLy8gV2UgZG9uJ3QgeWV0IGhhdmUgYSBET00gbm9kZSB0byBldmFsdWF0ZSwgc28gdXNlIGEgbWVtbyBhbmQgcmVuZGVyIHRoZSB0ZW1wbGF0ZSBsYXRlciB3aGVuIHRoZXJlIGlzIGEgRE9NIG5vZGUKCSAgICAgICAgICAgIHJldHVybiBrby5tZW1vaXphdGlvbi5tZW1vaXplKGZ1bmN0aW9uIChkb21Ob2RlKSB7CgkgICAgICAgICAgICAgICAga28ucmVuZGVyVGVtcGxhdGUodGVtcGxhdGUsIGRhdGFPckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCBkb21Ob2RlLCAicmVwbGFjZU5vZGUiKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9CgkgICAgfTsKCgkgICAga28ucmVuZGVyVGVtcGxhdGVGb3JFYWNoID0gZnVuY3Rpb24gKHRlbXBsYXRlLCBhcnJheU9yT2JzZXJ2YWJsZUFycmF5LCBvcHRpb25zLCB0YXJnZXROb2RlLCBwYXJlbnRCaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAvLyBTaW5jZSBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIGFsd2F5cyBjYWxscyBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0gYW5kIHRoZW4KCSAgICAgICAgLy8gYWN0aXZhdGVCaW5kaW5nc0NhbGxiYWNrIGZvciBhZGRlZCBpdGVtcywgd2UgY2FuIHN0b3JlIHRoZSBiaW5kaW5nIGNvbnRleHQgaW4gdGhlIGZvcm1lciB0byB1c2UgaW4gdGhlIGxhdHRlci4KCSAgICAgICAgdmFyIGFycmF5SXRlbUNvbnRleHQ7CgoJICAgICAgICAvLyBUaGlzIHdpbGwgYmUgY2FsbGVkIGJ5IHNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcgdG8gZ2V0IHRoZSBub2RlcyB0byBhZGQgdG8gdGFyZ2V0Tm9kZQoJICAgICAgICB2YXIgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtID0gZnVuY3Rpb24gKGFycmF5VmFsdWUsIGluZGV4KSB7CgkgICAgICAgICAgICAvLyBTdXBwb3J0IHNlbGVjdGluZyB0ZW1wbGF0ZSBhcyBhIGZ1bmN0aW9uIG9mIHRoZSBkYXRhIGJlaW5nIHJlbmRlcmVkCgkgICAgICAgICAgICBhcnJheUl0ZW1Db250ZXh0ID0gcGFyZW50QmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGFycmF5VmFsdWUsIG9wdGlvbnNbJ2FzJ10sIGZ1bmN0aW9uKGNvbnRleHQpIHsKCSAgICAgICAgICAgICAgICBjb250ZXh0WyckaW5kZXgnXSA9IGluZGV4OwoJICAgICAgICAgICAgfSk7CgoJICAgICAgICAgICAgdmFyIHRlbXBsYXRlTmFtZSA9IHJlc29sdmVUZW1wbGF0ZU5hbWUodGVtcGxhdGUsIGFycmF5VmFsdWUsIGFycmF5SXRlbUNvbnRleHQpOwoJICAgICAgICAgICAgcmV0dXJuIGV4ZWN1dGVUZW1wbGF0ZShudWxsLCAiaWdub3JlVGFyZ2V0Tm9kZSIsIHRlbXBsYXRlTmFtZSwgYXJyYXlJdGVtQ29udGV4dCwgb3B0aW9ucyk7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbmV2ZXIgc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyBoYXMgYWRkZWQgbm9kZXMgdG8gdGFyZ2V0Tm9kZQoJICAgICAgICB2YXIgYWN0aXZhdGVCaW5kaW5nc0NhbGxiYWNrID0gZnVuY3Rpb24oYXJyYXlWYWx1ZSwgYWRkZWROb2Rlc0FycmF5LCBpbmRleCkgewoJICAgICAgICAgICAgYWN0aXZhdGVCaW5kaW5nc09uQ29udGludW91c05vZGVBcnJheShhZGRlZE5vZGVzQXJyYXksIGFycmF5SXRlbUNvbnRleHQpOwoJICAgICAgICAgICAgaWYgKG9wdGlvbnNbJ2FmdGVyUmVuZGVyJ10pCgkgICAgICAgICAgICAgICAgb3B0aW9uc1snYWZ0ZXJSZW5kZXInXShhZGRlZE5vZGVzQXJyYXksIGFycmF5VmFsdWUpOwoJICAgICAgICB9OwoKCSAgICAgICAgcmV0dXJuIGtvLmRlcGVuZGVudE9ic2VydmFibGUoZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgdmFyIHVud3JhcHBlZEFycmF5ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShhcnJheU9yT2JzZXJ2YWJsZUFycmF5KSB8fCBbXTsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgdW53cmFwcGVkQXJyYXkubGVuZ3RoID09ICJ1bmRlZmluZWQiKSAvLyBDb2VyY2Ugc2luZ2xlIHZhbHVlIGludG8gYXJyYXkKCSAgICAgICAgICAgICAgICB1bndyYXBwZWRBcnJheSA9IFt1bndyYXBwZWRBcnJheV07CgoJICAgICAgICAgICAgLy8gRmlsdGVyIG91dCBhbnkgZW50cmllcyBtYXJrZWQgYXMgZGVzdHJveWVkCgkgICAgICAgICAgICB2YXIgZmlsdGVyZWRBcnJheSA9IGtvLnV0aWxzLmFycmF5RmlsdGVyKHVud3JhcHBlZEFycmF5LCBmdW5jdGlvbihpdGVtKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnNbJ2luY2x1ZGVEZXN0cm95ZWQnXSB8fCBpdGVtID09PSB1bmRlZmluZWQgfHwgaXRlbSA9PT0gbnVsbCB8fCAha28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShpdGVtWydfZGVzdHJveSddKTsKCSAgICAgICAgICAgIH0pOwoKCSAgICAgICAgICAgIC8vIENhbGwgc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZywgaWdub3JpbmcgYW55IG9ic2VydmFibGVzIHVud3JhcHBlZCB3aXRoaW4gKG1vc3QgbGlrZWx5IGZyb20gYSBjYWxsYmFjayBmdW5jdGlvbikuCgkgICAgICAgICAgICAvLyBJZiB0aGUgYXJyYXkgaXRlbXMgYXJlIG9ic2VydmFibGVzLCB0aG91Z2gsIHRoZXkgd2lsbCBiZSB1bndyYXBwZWQgaW4gZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtIGFuZCBtYW5hZ2VkIHdpdGhpbiBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nLgoJICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoa28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZywgbnVsbCwgW3RhcmdldE5vZGUsIGZpbHRlcmVkQXJyYXksIGV4ZWN1dGVUZW1wbGF0ZUZvckFycmF5SXRlbSwgb3B0aW9ucywgYWN0aXZhdGVCaW5kaW5nc0NhbGxiYWNrXSk7CgoJICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogdGFyZ2V0Tm9kZSB9KTsKCSAgICB9OwoKCSAgICB2YXIgdGVtcGxhdGVDb21wdXRlZERvbURhdGFLZXkgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCSAgICBmdW5jdGlvbiBkaXNwb3NlT2xkQ29tcHV0ZWRBbmRTdG9yZU5ld09uZShlbGVtZW50LCBuZXdDb21wdXRlZCkgewoJICAgICAgICB2YXIgb2xkQ29tcHV0ZWQgPSBrby51dGlscy5kb21EYXRhLmdldChlbGVtZW50LCB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSk7CgkgICAgICAgIGlmIChvbGRDb21wdXRlZCAmJiAodHlwZW9mKG9sZENvbXB1dGVkLmRpc3Bvc2UpID09ICdmdW5jdGlvbicpKQoJICAgICAgICAgICAgb2xkQ29tcHV0ZWQuZGlzcG9zZSgpOwoJICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSwgKG5ld0NvbXB1dGVkICYmIG5ld0NvbXB1dGVkLmlzQWN0aXZlKCkpID8gbmV3Q29tcHV0ZWQgOiB1bmRlZmluZWQpOwoJICAgIH0KCgkgICAga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddID0gewoJICAgICAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgICAgIC8vIFN1cHBvcnQgYW5vbnltb3VzIHRlbXBsYXRlcwoJICAgICAgICAgICAgdmFyIGJpbmRpbmdWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgYmluZGluZ1ZhbHVlID09ICJzdHJpbmciIHx8IGJpbmRpbmdWYWx1ZVsnbmFtZSddKSB7CgkgICAgICAgICAgICAgICAgLy8gSXQncyBhIG5hbWVkIHRlbXBsYXRlIC0gY2xlYXIgdGhlIGVsZW1lbnQKCSAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKGVsZW1lbnQpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAvLyBJdCdzIGFuIGFub255bW91cyB0ZW1wbGF0ZSAtIHN0b3JlIHRoZSBlbGVtZW50IGNvbnRlbnRzLCB0aGVuIGNsZWFyIHRoZSBlbGVtZW50CgkgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlTm9kZXMgPSBrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2RlcyhlbGVtZW50KSwKCSAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyID0ga28udXRpbHMubW92ZUNsZWFuZWROb2Rlc1RvQ29udGFpbmVyRWxlbWVudCh0ZW1wbGF0ZU5vZGVzKTsgLy8gVGhpcyBhbHNvIHJlbW92ZXMgdGhlIG5vZGVzIGZyb20gdGhlaXIgY3VycmVudCBwYXJlbnQKCSAgICAgICAgICAgICAgICBuZXcga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlKGVsZW1lbnQpWydub2RlcyddKGNvbnRhaW5lcik7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CgkgICAgICAgIH0sCgkgICAgICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgICAgIHZhciB2YWx1ZSA9IHZhbHVlQWNjZXNzb3IoKSwKCSAgICAgICAgICAgICAgICBkYXRhVmFsdWUsCgkgICAgICAgICAgICAgICAgb3B0aW9ucyA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWUpLAoJICAgICAgICAgICAgICAgIHNob3VsZERpc3BsYXkgPSB0cnVlLAoJICAgICAgICAgICAgICAgIHRlbXBsYXRlQ29tcHV0ZWQgPSBudWxsLAoJICAgICAgICAgICAgICAgIHRlbXBsYXRlTmFtZTsKCgkgICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT0gInN0cmluZyIpIHsKCSAgICAgICAgICAgICAgICB0ZW1wbGF0ZU5hbWUgPSB2YWx1ZTsKCSAgICAgICAgICAgICAgICBvcHRpb25zID0ge307CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIHRlbXBsYXRlTmFtZSA9IG9wdGlvbnNbJ25hbWUnXTsKCgkgICAgICAgICAgICAgICAgLy8gU3VwcG9ydCAiaWYiLyJpZm5vdCIgY29uZGl0aW9ucwoJICAgICAgICAgICAgICAgIGlmICgnaWYnIGluIG9wdGlvbnMpCgkgICAgICAgICAgICAgICAgICAgIHNob3VsZERpc3BsYXkgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9wdGlvbnNbJ2lmJ10pOwoJICAgICAgICAgICAgICAgIGlmIChzaG91bGREaXNwbGF5ICYmICdpZm5vdCcgaW4gb3B0aW9ucykKCSAgICAgICAgICAgICAgICAgICAgc2hvdWxkRGlzcGxheSA9ICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9wdGlvbnNbJ2lmbm90J10pOwoKCSAgICAgICAgICAgICAgICBkYXRhVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9wdGlvbnNbJ2RhdGEnXSk7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgaWYgKCdmb3JlYWNoJyBpbiBvcHRpb25zKSB7CgkgICAgICAgICAgICAgICAgLy8gUmVuZGVyIG9uY2UgZm9yIGVhY2ggZGF0YSBwb2ludCAodHJlYXRpbmcgZGF0YSBzZXQgYXMgZW1wdHkgaWYgc2hvdWxkRGlzcGxheT09ZmFsc2UpCgkgICAgICAgICAgICAgICAgdmFyIGRhdGFBcnJheSA9IChzaG91bGREaXNwbGF5ICYmIG9wdGlvbnNbJ2ZvcmVhY2gnXSkgfHwgW107CgkgICAgICAgICAgICAgICAgdGVtcGxhdGVDb21wdXRlZCA9IGtvLnJlbmRlclRlbXBsYXRlRm9yRWFjaCh0ZW1wbGF0ZU5hbWUgfHwgZWxlbWVudCwgZGF0YUFycmF5LCBvcHRpb25zLCBlbGVtZW50LCBiaW5kaW5nQ29udGV4dCk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKCFzaG91bGREaXNwbGF5KSB7CgkgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZShlbGVtZW50KTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gUmVuZGVyIG9uY2UgZm9yIHRoaXMgc2luZ2xlIGRhdGEgcG9pbnQgKG9yIHVzZSB0aGUgdmlld01vZGVsIGlmIG5vIGRhdGEgd2FzIHByb3ZpZGVkKQoJICAgICAgICAgICAgICAgIHZhciBpbm5lckJpbmRpbmdDb250ZXh0ID0gKCdkYXRhJyBpbiBvcHRpb25zKSA/CgkgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdDb250ZXh0WydjcmVhdGVDaGlsZENvbnRleHQnXShkYXRhVmFsdWUsIG9wdGlvbnNbJ2FzJ10pIDogIC8vIEdpdmVuIGFuIGV4cGxpdGl0ICdkYXRhJyB2YWx1ZSwgd2UgY3JlYXRlIGEgY2hpbGQgYmluZGluZyBjb250ZXh0IGZvciBpdAoJICAgICAgICAgICAgICAgICAgICBiaW5kaW5nQ29udGV4dDsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdpdmVuIG5vIGV4cGxpY2l0ICdkYXRhJyB2YWx1ZSwgd2UgcmV0YWluIHRoZSBzYW1lIGJpbmRpbmcgY29udGV4dAoJICAgICAgICAgICAgICAgIHRlbXBsYXRlQ29tcHV0ZWQgPSBrby5yZW5kZXJUZW1wbGF0ZSh0ZW1wbGF0ZU5hbWUgfHwgZWxlbWVudCwgaW5uZXJCaW5kaW5nQ29udGV4dCwgb3B0aW9ucywgZWxlbWVudCk7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gSXQgb25seSBtYWtlcyBzZW5zZSB0byBoYXZlIGEgc2luZ2xlIHRlbXBsYXRlIGNvbXB1dGVkIHBlciBlbGVtZW50IChvdGhlcndpc2Ugd2hpY2ggb25lIHNob3VsZCBoYXZlIGl0cyBvdXRwdXQgZGlzcGxheWVkPykKCSAgICAgICAgICAgIGRpc3Bvc2VPbGRDb21wdXRlZEFuZFN0b3JlTmV3T25lKGVsZW1lbnQsIHRlbXBsYXRlQ29tcHV0ZWQpOwoJICAgICAgICB9CgkgICAgfTsKCgkgICAgLy8gQW5vbnltb3VzIHRlbXBsYXRlcyBjYW4ndCBiZSByZXdyaXR0ZW4uIEdpdmUgYSBuaWNlIGVycm9yIG1lc3NhZ2UgaWYgeW91IHRyeSB0byBkbyBpdC4KCSAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9yc1sndGVtcGxhdGUnXSA9IGZ1bmN0aW9uKGJpbmRpbmdWYWx1ZSkgewoJICAgICAgICB2YXIgcGFyc2VkQmluZGluZ1ZhbHVlID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5wYXJzZU9iamVjdExpdGVyYWwoYmluZGluZ1ZhbHVlKTsKCgkgICAgICAgIGlmICgocGFyc2VkQmluZGluZ1ZhbHVlLmxlbmd0aCA9PSAxKSAmJiBwYXJzZWRCaW5kaW5nVmFsdWVbMF1bJ3Vua25vd24nXSkKCSAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBJdCBsb29rcyBsaWtlIGEgc3RyaW5nIGxpdGVyYWwsIG5vdCBhbiBvYmplY3QgbGl0ZXJhbCwgc28gdHJlYXQgaXQgYXMgYSBuYW1lZCB0ZW1wbGF0ZSAod2hpY2ggaXMgYWxsb3dlZCBmb3IgcmV3cml0aW5nKQoKCSAgICAgICAgaWYgKGtvLmV4cHJlc3Npb25SZXdyaXRpbmcua2V5VmFsdWVBcnJheUNvbnRhaW5zS2V5KHBhcnNlZEJpbmRpbmdWYWx1ZSwgIm5hbWUiKSkKCSAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBOYW1lZCB0ZW1wbGF0ZXMgY2FuIGJlIHJld3JpdHRlbiwgc28gcmV0dXJuICJubyBlcnJvciIKCSAgICAgICAgcmV0dXJuICJUaGlzIHRlbXBsYXRlIGVuZ2luZSBkb2VzIG5vdCBzdXBwb3J0IGFub255bW91cyB0ZW1wbGF0ZXMgbmVzdGVkIHdpdGhpbiBpdHMgdGVtcGxhdGVzIjsKCSAgICB9OwoKCSAgICBrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWyd0ZW1wbGF0ZSddID0gdHJ1ZTsKCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCdzZXRUZW1wbGF0ZUVuZ2luZScsIGtvLnNldFRlbXBsYXRlRW5naW5lKTsKCWtvLmV4cG9ydFN5bWJvbCgncmVuZGVyVGVtcGxhdGUnLCBrby5yZW5kZXJUZW1wbGF0ZSk7CgkvLyBHbyB0aHJvdWdoIHRoZSBpdGVtcyB0aGF0IGhhdmUgYmVlbiBhZGRlZCBhbmQgZGVsZXRlZCBhbmQgdHJ5IHRvIGZpbmQgbWF0Y2hlcyBiZXR3ZWVuIHRoZW0uCglrby51dGlscy5maW5kTW92ZXNJbkFycmF5Q29tcGFyaXNvbiA9IGZ1bmN0aW9uIChsZWZ0LCByaWdodCwgbGltaXRGYWlsZWRDb21wYXJlcykgewoJICAgIGlmIChsZWZ0Lmxlbmd0aCAmJiByaWdodC5sZW5ndGgpIHsKCSAgICAgICAgdmFyIGZhaWxlZENvbXBhcmVzLCBsLCByLCBsZWZ0SXRlbSwgcmlnaHRJdGVtOwoJICAgICAgICBmb3IgKGZhaWxlZENvbXBhcmVzID0gbCA9IDA7ICghbGltaXRGYWlsZWRDb21wYXJlcyB8fCBmYWlsZWRDb21wYXJlcyA8IGxpbWl0RmFpbGVkQ29tcGFyZXMpICYmIChsZWZ0SXRlbSA9IGxlZnRbbF0pOyArK2wpIHsKCSAgICAgICAgICAgIGZvciAociA9IDA7IHJpZ2h0SXRlbSA9IHJpZ2h0W3JdOyArK3IpIHsKCSAgICAgICAgICAgICAgICBpZiAobGVmdEl0ZW1bJ3ZhbHVlJ10gPT09IHJpZ2h0SXRlbVsndmFsdWUnXSkgewoJICAgICAgICAgICAgICAgICAgICBsZWZ0SXRlbVsnbW92ZWQnXSA9IHJpZ2h0SXRlbVsnaW5kZXgnXTsKCSAgICAgICAgICAgICAgICAgICAgcmlnaHRJdGVtWydtb3ZlZCddID0gbGVmdEl0ZW1bJ2luZGV4J107CgkgICAgICAgICAgICAgICAgICAgIHJpZ2h0LnNwbGljZShyLCAxKTsgICAgICAgICAvLyBUaGlzIGl0ZW0gaXMgbWFya2VkIGFzIG1vdmVkOyBzbyByZW1vdmUgaXQgZnJvbSByaWdodCBsaXN0CgkgICAgICAgICAgICAgICAgICAgIGZhaWxlZENvbXBhcmVzID0gciA9IDA7ICAgICAvLyBSZXNldCBmYWlsZWQgY29tcGFyZXMgY291bnQgYmVjYXVzZSB3ZSdyZSBjaGVja2luZyBmb3IgY29uc2VjdXRpdmUgZmFpbHVyZXMKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZmFpbGVkQ29tcGFyZXMgKz0gcjsKCSAgICAgICAgfQoJICAgIH0KCX07CgoJa28udXRpbHMuY29tcGFyZUFycmF5cyA9IChmdW5jdGlvbiAoKSB7CgkgICAgdmFyIHN0YXR1c05vdEluT2xkID0gJ2FkZGVkJywgc3RhdHVzTm90SW5OZXcgPSAnZGVsZXRlZCc7CgoJICAgIC8vIFNpbXBsZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBMZXZlbnNodGVpbiBkaXN0YW5jZS4KCSAgICBmdW5jdGlvbiBjb21wYXJlQXJyYXlzKG9sZEFycmF5LCBuZXdBcnJheSwgb3B0aW9ucykgewoJICAgICAgICAvLyBGb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgaWYgdGhlIHRoaXJkIGFyZyBpcyBhY3R1YWxseSBhIGJvb2wsIGludGVycHJldAoJICAgICAgICAvLyBpdCBhcyB0aGUgb2xkIHBhcmFtZXRlciAnZG9udExpbWl0TW92ZXMnLiBOZXdlciBjb2RlIHNob3VsZCB1c2UgeyBkb250TGltaXRNb3ZlczogdHJ1ZSB9LgoJICAgICAgICBvcHRpb25zID0gKHR5cGVvZiBvcHRpb25zID09PSAnYm9vbGVhbicpID8geyAnZG9udExpbWl0TW92ZXMnOiBvcHRpb25zIH0gOiAob3B0aW9ucyB8fCB7fSk7CgkgICAgICAgIG9sZEFycmF5ID0gb2xkQXJyYXkgfHwgW107CgkgICAgICAgIG5ld0FycmF5ID0gbmV3QXJyYXkgfHwgW107CgoJICAgICAgICBpZiAob2xkQXJyYXkubGVuZ3RoIDw9IG5ld0FycmF5Lmxlbmd0aCkKCSAgICAgICAgICAgIHJldHVybiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkob2xkQXJyYXksIG5ld0FycmF5LCBzdGF0dXNOb3RJbk9sZCwgc3RhdHVzTm90SW5OZXcsIG9wdGlvbnMpOwoJICAgICAgICBlbHNlCgkgICAgICAgICAgICByZXR1cm4gY29tcGFyZVNtYWxsQXJyYXlUb0JpZ0FycmF5KG5ld0FycmF5LCBvbGRBcnJheSwgc3RhdHVzTm90SW5OZXcsIHN0YXR1c05vdEluT2xkLCBvcHRpb25zKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNvbXBhcmVTbWFsbEFycmF5VG9CaWdBcnJheShzbWxBcnJheSwgYmlnQXJyYXksIHN0YXR1c05vdEluU21sLCBzdGF0dXNOb3RJbkJpZywgb3B0aW9ucykgewoJICAgICAgICB2YXIgbXlNaW4gPSBNYXRoLm1pbiwKCSAgICAgICAgICAgIG15TWF4ID0gTWF0aC5tYXgsCgkgICAgICAgICAgICBlZGl0RGlzdGFuY2VNYXRyaXggPSBbXSwKCSAgICAgICAgICAgIHNtbEluZGV4LCBzbWxJbmRleE1heCA9IHNtbEFycmF5Lmxlbmd0aCwKCSAgICAgICAgICAgIGJpZ0luZGV4LCBiaWdJbmRleE1heCA9IGJpZ0FycmF5Lmxlbmd0aCwKCSAgICAgICAgICAgIGNvbXBhcmVSYW5nZSA9IChiaWdJbmRleE1heCAtIHNtbEluZGV4TWF4KSB8fCAxLAoJICAgICAgICAgICAgbWF4RGlzdGFuY2UgPSBzbWxJbmRleE1heCArIGJpZ0luZGV4TWF4ICsgMSwKCSAgICAgICAgICAgIHRoaXNSb3csIGxhc3RSb3csCgkgICAgICAgICAgICBiaWdJbmRleE1heEZvclJvdywgYmlnSW5kZXhNaW5Gb3JSb3c7CgoJICAgICAgICBmb3IgKHNtbEluZGV4ID0gMDsgc21sSW5kZXggPD0gc21sSW5kZXhNYXg7IHNtbEluZGV4KyspIHsKCSAgICAgICAgICAgIGxhc3RSb3cgPSB0aGlzUm93OwoJICAgICAgICAgICAgZWRpdERpc3RhbmNlTWF0cml4LnB1c2godGhpc1JvdyA9IFtdKTsKCSAgICAgICAgICAgIGJpZ0luZGV4TWF4Rm9yUm93ID0gbXlNaW4oYmlnSW5kZXhNYXgsIHNtbEluZGV4ICsgY29tcGFyZVJhbmdlKTsKCSAgICAgICAgICAgIGJpZ0luZGV4TWluRm9yUm93ID0gbXlNYXgoMCwgc21sSW5kZXggLSAxKTsKCSAgICAgICAgICAgIGZvciAoYmlnSW5kZXggPSBiaWdJbmRleE1pbkZvclJvdzsgYmlnSW5kZXggPD0gYmlnSW5kZXhNYXhGb3JSb3c7IGJpZ0luZGV4KyspIHsKCSAgICAgICAgICAgICAgICBpZiAoIWJpZ0luZGV4KQoJICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IHNtbEluZGV4ICsgMTsKCSAgICAgICAgICAgICAgICBlbHNlIGlmICghc21sSW5kZXgpICAvLyBUb3Agcm93IC0gdHJhbnNmb3JtIGVtcHR5IGFycmF5IGludG8gbmV3IGFycmF5IHZpYSBhZGRpdGlvbnMKCSAgICAgICAgICAgICAgICAgICAgdGhpc1Jvd1tiaWdJbmRleF0gPSBiaWdJbmRleCArIDE7CgkgICAgICAgICAgICAgICAgZWxzZSBpZiAoc21sQXJyYXlbc21sSW5kZXggLSAxXSA9PT0gYmlnQXJyYXlbYmlnSW5kZXggLSAxXSkKCSAgICAgICAgICAgICAgICAgICAgdGhpc1Jvd1tiaWdJbmRleF0gPSBsYXN0Um93W2JpZ0luZGV4IC0gMV07ICAgICAgICAgICAgICAgICAgLy8gY29weSB2YWx1ZSAobm8gZWRpdCkKCSAgICAgICAgICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIG5vcnRoRGlzdGFuY2UgPSBsYXN0Um93W2JpZ0luZGV4XSB8fCBtYXhEaXN0YW5jZTsgICAgICAgLy8gbm90IGluIGJpZyAoZGVsZXRpb24pCgkgICAgICAgICAgICAgICAgICAgIHZhciB3ZXN0RGlzdGFuY2UgPSB0aGlzUm93W2JpZ0luZGV4IC0gMV0gfHwgbWF4RGlzdGFuY2U7ICAgIC8vIG5vdCBpbiBzbWFsbCAoYWRkaXRpb24pCgkgICAgICAgICAgICAgICAgICAgIHRoaXNSb3dbYmlnSW5kZXhdID0gbXlNaW4obm9ydGhEaXN0YW5jZSwgd2VzdERpc3RhbmNlKSArIDE7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICB2YXIgZWRpdFNjcmlwdCA9IFtdLCBtZU1pbnVzT25lLCBub3RJblNtbCA9IFtdLCBub3RJbkJpZyA9IFtdOwoJICAgICAgICBmb3IgKHNtbEluZGV4ID0gc21sSW5kZXhNYXgsIGJpZ0luZGV4ID0gYmlnSW5kZXhNYXg7IHNtbEluZGV4IHx8IGJpZ0luZGV4OykgewoJICAgICAgICAgICAgbWVNaW51c09uZSA9IGVkaXREaXN0YW5jZU1hdHJpeFtzbWxJbmRleF1bYmlnSW5kZXhdIC0gMTsKCSAgICAgICAgICAgIGlmIChiaWdJbmRleCAmJiBtZU1pbnVzT25lID09PSBlZGl0RGlzdGFuY2VNYXRyaXhbc21sSW5kZXhdW2JpZ0luZGV4LTFdKSB7CgkgICAgICAgICAgICAgICAgbm90SW5TbWwucHVzaChlZGl0U2NyaXB0W2VkaXRTY3JpcHQubGVuZ3RoXSA9IHsgICAgIC8vIGFkZGVkCgkgICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiBzdGF0dXNOb3RJblNtbCwKCSAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogYmlnQXJyYXlbLS1iaWdJbmRleF0sCgkgICAgICAgICAgICAgICAgICAgICdpbmRleCc6IGJpZ0luZGV4IH0pOwoJICAgICAgICAgICAgfSBlbHNlIGlmIChzbWxJbmRleCAmJiBtZU1pbnVzT25lID09PSBlZGl0RGlzdGFuY2VNYXRyaXhbc21sSW5kZXggLSAxXVtiaWdJbmRleF0pIHsKCSAgICAgICAgICAgICAgICBub3RJbkJpZy5wdXNoKGVkaXRTY3JpcHRbZWRpdFNjcmlwdC5sZW5ndGhdID0geyAgICAgLy8gZGVsZXRlZAoJICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJzogc3RhdHVzTm90SW5CaWcsCgkgICAgICAgICAgICAgICAgICAgICd2YWx1ZSc6IHNtbEFycmF5Wy0tc21sSW5kZXhdLAoJICAgICAgICAgICAgICAgICAgICAnaW5kZXgnOiBzbWxJbmRleCB9KTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLS1iaWdJbmRleDsKCSAgICAgICAgICAgICAgICAtLXNtbEluZGV4OwoJICAgICAgICAgICAgICAgIGlmICghb3B0aW9uc1snc3BhcnNlJ10pIHsKCSAgICAgICAgICAgICAgICAgICAgZWRpdFNjcmlwdC5wdXNoKHsKCSAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiAicmV0YWluZWQiLAoJICAgICAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogYmlnQXJyYXlbYmlnSW5kZXhdIH0pOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoKCSAgICAgICAgLy8gU2V0IGEgbGltaXQgb24gdGhlIG51bWJlciBvZiBjb25zZWN1dGl2ZSBub24tbWF0Y2hpbmcgY29tcGFyaXNvbnM7IGhhdmluZyBpdCBhIG11bHRpcGxlIG9mCgkgICAgICAgIC8vIHNtbEluZGV4TWF4IGtlZXBzIHRoZSB0aW1lIGNvbXBsZXhpdHkgb2YgdGhpcyBhbGdvcml0aG0gbGluZWFyLgoJICAgICAgICBrby51dGlscy5maW5kTW92ZXNJbkFycmF5Q29tcGFyaXNvbihub3RJblNtbCwgbm90SW5CaWcsIHNtbEluZGV4TWF4ICogMTApOwoKCSAgICAgICAgcmV0dXJuIGVkaXRTY3JpcHQucmV2ZXJzZSgpOwoJICAgIH0KCgkgICAgcmV0dXJuIGNvbXBhcmVBcnJheXM7Cgl9KSgpOwoKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuY29tcGFyZUFycmF5cycsIGtvLnV0aWxzLmNvbXBhcmVBcnJheXMpOwoJKGZ1bmN0aW9uICgpIHsKCSAgICAvLyBPYmplY3RpdmU6CgkgICAgLy8gKiBHaXZlbiBhbiBpbnB1dCBhcnJheSwgYSBjb250YWluZXIgRE9NIG5vZGUsIGFuZCBhIGZ1bmN0aW9uIGZyb20gYXJyYXkgZWxlbWVudHMgdG8gYXJyYXlzIG9mIERPTSBub2RlcywKCSAgICAvLyAgIG1hcCB0aGUgYXJyYXkgZWxlbWVudHMgdG8gYXJyYXlzIG9mIERPTSBub2RlcywgY29uY2F0ZW5hdGUgdG9nZXRoZXIgYWxsIHRoZXNlIGFycmF5cywgYW5kIHVzZSB0aGVtIHRvIHBvcHVsYXRlIHRoZSBjb250YWluZXIgRE9NIG5vZGUKCSAgICAvLyAqIE5leHQgdGltZSB3ZSdyZSBnaXZlbiB0aGUgc2FtZSBjb21iaW5hdGlvbiBvZiB0aGluZ3MgKHdpdGggdGhlIGFycmF5IHBvc3NpYmx5IGhhdmluZyBtdXRhdGVkKSwgdXBkYXRlIHRoZSBjb250YWluZXIgRE9NIG5vZGUKCSAgICAvLyAgIHNvIHRoYXQgaXRzIGNoaWxkcmVuIGlzIGFnYWluIHRoZSBjb25jYXRlbmF0aW9uIG9mIHRoZSBtYXBwaW5ncyBvZiB0aGUgYXJyYXkgZWxlbWVudHMsIGJ1dCBkb24ndCByZS1tYXAgYW55IGFycmF5IGVsZW1lbnRzIHRoYXQgd2UKCSAgICAvLyAgIHByZXZpb3VzbHkgbWFwcGVkIC0gcmV0YWluIHRob3NlIG5vZGVzLCBhbmQganVzdCBpbnNlcnQvZGVsZXRlIG90aGVyIG9uZXMKCgkgICAgLy8gImNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcyIgd2lsbCBiZSBpbnZva2VkIGFmdGVyIGFueSAibWFwcGluZyItZ2VuZXJhdGVkIG5vZGVzIGFyZSBpbnNlcnRlZCBpbnRvIHRoZSBjb250YWluZXIgbm9kZQoJICAgIC8vIFlvdSBjYW4gdXNlIHRoaXMsIGZvciBleGFtcGxlLCB0byBhY3RpdmF0ZSBiaW5kaW5ncyBvbiB0aG9zZSBub2Rlcy4KCgkgICAgZnVuY3Rpb24gbWFwTm9kZUFuZFJlZnJlc2hXaGVuQ2hhbmdlZChjb250YWluZXJOb2RlLCBtYXBwaW5nLCB2YWx1ZVRvTWFwLCBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMsIGluZGV4KSB7CgkgICAgICAgIC8vIE1hcCB0aGlzIGFycmF5IHZhbHVlIGluc2lkZSBhIGRlcGVuZGVudE9ic2VydmFibGUgc28gd2UgcmUtbWFwIHdoZW4gYW55IGRlcGVuZGVuY3kgY2hhbmdlcwoJICAgICAgICB2YXIgbWFwcGVkTm9kZXMgPSBbXTsKCSAgICAgICAgdmFyIGRlcGVuZGVudE9ic2VydmFibGUgPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgdmFyIG5ld01hcHBlZE5vZGVzID0gbWFwcGluZyh2YWx1ZVRvTWFwLCBpbmRleCwga28udXRpbHMuZml4VXBDb250aW51b3VzTm9kZUFycmF5KG1hcHBlZE5vZGVzLCBjb250YWluZXJOb2RlKSkgfHwgW107CgoJICAgICAgICAgICAgLy8gT24gc3Vic2VxdWVudCBldmFsdWF0aW9ucywganVzdCByZXBsYWNlIHRoZSBwcmV2aW91c2x5LWluc2VydGVkIERPTSBub2RlcwoJICAgICAgICAgICAgaWYgKG1hcHBlZE5vZGVzLmxlbmd0aCA+IDApIHsKCSAgICAgICAgICAgICAgICBrby51dGlscy5yZXBsYWNlRG9tTm9kZXMobWFwcGVkTm9kZXMsIG5ld01hcHBlZE5vZGVzKTsKCSAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKQoJICAgICAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZShjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMsIG51bGwsIFt2YWx1ZVRvTWFwLCBuZXdNYXBwZWROb2RlcywgaW5kZXhdKTsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAvLyBSZXBsYWNlIHRoZSBjb250ZW50cyBvZiB0aGUgbWFwcGVkTm9kZXMgYXJyYXksIHRoZXJlYnkgdXBkYXRpbmcgdGhlIHJlY29yZAoJICAgICAgICAgICAgLy8gb2Ygd2hpY2ggbm9kZXMgd291bGQgYmUgZGVsZXRlZCBpZiB2YWx1ZVRvTWFwIHdhcyBpdHNlbGYgbGF0ZXIgcmVtb3ZlZAoJICAgICAgICAgICAgbWFwcGVkTm9kZXMubGVuZ3RoID0gMDsKCSAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UHVzaEFsbChtYXBwZWROb2RlcywgbmV3TWFwcGVkTm9kZXMpOwoJICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogY29udGFpbmVyTm9kZSwgZGlzcG9zZVdoZW46IGZ1bmN0aW9uKCkgeyByZXR1cm4gIWtvLnV0aWxzLmFueURvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChtYXBwZWROb2Rlcyk7IH0gfSk7CgkgICAgICAgIHJldHVybiB7IG1hcHBlZE5vZGVzIDogbWFwcGVkTm9kZXMsIGRlcGVuZGVudE9ic2VydmFibGUgOiAoZGVwZW5kZW50T2JzZXJ2YWJsZS5pc0FjdGl2ZSgpID8gZGVwZW5kZW50T2JzZXJ2YWJsZSA6IHVuZGVmaW5lZCkgfTsKCSAgICB9CgoJICAgIHZhciBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXkgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCgkgICAga28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyA9IGZ1bmN0aW9uIChkb21Ob2RlLCBhcnJheSwgbWFwcGluZywgb3B0aW9ucywgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKSB7CgkgICAgICAgIC8vIENvbXBhcmUgdGhlIHByb3ZpZGVkIGFycmF5IGFnYWluc3QgdGhlIHByZXZpb3VzIG9uZQoJICAgICAgICBhcnJheSA9IGFycmF5IHx8IFtdOwoJICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgICAgICAgdmFyIGlzRmlyc3RFeGVjdXRpb24gPSBrby51dGlscy5kb21EYXRhLmdldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXkpID09PSB1bmRlZmluZWQ7CgkgICAgICAgIHZhciBsYXN0TWFwcGluZ1Jlc3VsdCA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KGRvbU5vZGUsIGxhc3RNYXBwaW5nUmVzdWx0RG9tRGF0YUtleSkgfHwgW107CgkgICAgICAgIHZhciBsYXN0QXJyYXkgPSBrby51dGlscy5hcnJheU1hcChsYXN0TWFwcGluZ1Jlc3VsdCwgZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHguYXJyYXlFbnRyeTsgfSk7CgkgICAgICAgIHZhciBlZGl0U2NyaXB0ID0ga28udXRpbHMuY29tcGFyZUFycmF5cyhsYXN0QXJyYXksIGFycmF5LCBvcHRpb25zWydkb250TGltaXRNb3ZlcyddKTsKCgkgICAgICAgIC8vIEJ1aWxkIHRoZSBuZXcgbWFwcGluZyByZXN1bHQKCSAgICAgICAgdmFyIG5ld01hcHBpbmdSZXN1bHQgPSBbXTsKCSAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwoJICAgICAgICB2YXIgbmV3TWFwcGluZ1Jlc3VsdEluZGV4ID0gMDsKCgkgICAgICAgIHZhciBub2Rlc1RvRGVsZXRlID0gW107CgkgICAgICAgIHZhciBpdGVtc1RvUHJvY2VzcyA9IFtdOwoJICAgICAgICB2YXIgaXRlbXNGb3JCZWZvcmVSZW1vdmVDYWxsYmFja3MgPSBbXTsKCSAgICAgICAgdmFyIGl0ZW1zRm9yTW92ZUNhbGxiYWNrcyA9IFtdOwoJICAgICAgICB2YXIgaXRlbXNGb3JBZnRlckFkZENhbGxiYWNrcyA9IFtdOwoJICAgICAgICB2YXIgbWFwRGF0YTsKCgkgICAgICAgIGZ1bmN0aW9uIGl0ZW1Nb3ZlZE9yUmV0YWluZWQoZWRpdFNjcmlwdEluZGV4LCBvbGRQb3NpdGlvbikgewoJICAgICAgICAgICAgbWFwRGF0YSA9IGxhc3RNYXBwaW5nUmVzdWx0W29sZFBvc2l0aW9uXTsKCSAgICAgICAgICAgIGlmIChuZXdNYXBwaW5nUmVzdWx0SW5kZXggIT09IG9sZFBvc2l0aW9uKQoJICAgICAgICAgICAgICAgIGl0ZW1zRm9yTW92ZUNhbGxiYWNrc1tlZGl0U2NyaXB0SW5kZXhdID0gbWFwRGF0YTsKCSAgICAgICAgICAgIC8vIFNpbmNlIHVwZGF0aW5nIHRoZSBpbmRleCBtaWdodCBjaGFuZ2UgdGhlIG5vZGVzLCBkbyBzbyBiZWZvcmUgY2FsbGluZyBmaXhVcENvbnRpbnVvdXNOb2RlQXJyYXkKCSAgICAgICAgICAgIG1hcERhdGEuaW5kZXhPYnNlcnZhYmxlKG5ld01hcHBpbmdSZXN1bHRJbmRleCsrKTsKCSAgICAgICAgICAgIGtvLnV0aWxzLmZpeFVwQ29udGludW91c05vZGVBcnJheShtYXBEYXRhLm1hcHBlZE5vZGVzLCBkb21Ob2RlKTsKCSAgICAgICAgICAgIG5ld01hcHBpbmdSZXN1bHQucHVzaChtYXBEYXRhKTsKCSAgICAgICAgICAgIGl0ZW1zVG9Qcm9jZXNzLnB1c2gobWFwRGF0YSk7CgkgICAgICAgIH0KCgkgICAgICAgIGZ1bmN0aW9uIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgaXRlbXMpIHsKCSAgICAgICAgICAgIGlmIChjYWxsYmFjaykgewoJICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBuID0gaXRlbXMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtc1tpXSkgewoJICAgICAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGl0ZW1zW2ldLm1hcHBlZE5vZGVzLCBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobm9kZSwgaSwgaXRlbXNbaV0uYXJyYXlFbnRyeSk7CgkgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoKCSAgICAgICAgZm9yICh2YXIgaSA9IDAsIGVkaXRTY3JpcHRJdGVtLCBtb3ZlZEluZGV4OyBlZGl0U2NyaXB0SXRlbSA9IGVkaXRTY3JpcHRbaV07IGkrKykgewoJICAgICAgICAgICAgbW92ZWRJbmRleCA9IGVkaXRTY3JpcHRJdGVtWydtb3ZlZCddOwoJICAgICAgICAgICAgc3dpdGNoIChlZGl0U2NyaXB0SXRlbVsnc3RhdHVzJ10pIHsKCSAgICAgICAgICAgICAgICBjYXNlICJkZWxldGVkIjoKCSAgICAgICAgICAgICAgICAgICAgaWYgKG1vdmVkSW5kZXggPT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgbWFwRGF0YSA9IGxhc3RNYXBwaW5nUmVzdWx0W2xhc3RNYXBwaW5nUmVzdWx0SW5kZXhdOwoKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgdHJhY2tpbmcgY2hhbmdlcyB0byB0aGUgbWFwcGluZyBmb3IgdGhlc2Ugbm9kZXMKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXBEYXRhLmRlcGVuZGVudE9ic2VydmFibGUpCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwRGF0YS5kZXBlbmRlbnRPYnNlcnZhYmxlLmRpc3Bvc2UoKTsKCgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBRdWV1ZSB0aGVzZSBub2RlcyBmb3IgbGF0ZXIgcmVtb3ZhbAoJICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb0RlbGV0ZS5wdXNoLmFwcGx5KG5vZGVzVG9EZWxldGUsIGtvLnV0aWxzLmZpeFVwQ29udGludW91c05vZGVBcnJheShtYXBEYXRhLm1hcHBlZE5vZGVzLCBkb21Ob2RlKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uc1snYmVmb3JlUmVtb3ZlJ10pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc0ZvckJlZm9yZVJlbW92ZUNhbGxiYWNrc1tpXSA9IG1hcERhdGE7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNUb1Byb2Nlc3MucHVzaChtYXBEYXRhKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBsYXN0TWFwcGluZ1Jlc3VsdEluZGV4Kys7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKCSAgICAgICAgICAgICAgICBjYXNlICJyZXRhaW5lZCI6CgkgICAgICAgICAgICAgICAgICAgIGl0ZW1Nb3ZlZE9yUmV0YWluZWQoaSwgbGFzdE1hcHBpbmdSZXN1bHRJbmRleCsrKTsKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgoJICAgICAgICAgICAgICAgIGNhc2UgImFkZGVkIjoKCSAgICAgICAgICAgICAgICAgICAgaWYgKG1vdmVkSW5kZXggIT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgaXRlbU1vdmVkT3JSZXRhaW5lZChpLCBtb3ZlZEluZGV4KTsKCSAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEgPSB7IGFycmF5RW50cnk6IGVkaXRTY3JpcHRJdGVtWyd2YWx1ZSddLCBpbmRleE9ic2VydmFibGU6IGtvLm9ic2VydmFibGUobmV3TWFwcGluZ1Jlc3VsdEluZGV4KyspIH07CgkgICAgICAgICAgICAgICAgICAgICAgICBuZXdNYXBwaW5nUmVzdWx0LnB1c2gobWFwRGF0YSk7CgkgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc1RvUHJvY2Vzcy5wdXNoKG1hcERhdGEpOwoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0ZpcnN0RXhlY3V0aW9uKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zRm9yQWZ0ZXJBZGRDYWxsYmFja3NbaV0gPSBtYXBEYXRhOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICAvLyBDYWxsIGJlZm9yZU1vdmUgZmlyc3QgYmVmb3JlIGFueSBjaGFuZ2VzIGhhdmUgYmVlbiBtYWRlIHRvIHRoZSBET00KCSAgICAgICAgY2FsbENhbGxiYWNrKG9wdGlvbnNbJ2JlZm9yZU1vdmUnXSwgaXRlbXNGb3JNb3ZlQ2FsbGJhY2tzKTsKCgkgICAgICAgIC8vIE5leHQgcmVtb3ZlIG5vZGVzIGZvciBkZWxldGVkIGl0ZW1zIChvciBqdXN0IGNsZWFuIGlmIHRoZXJlJ3MgYSBiZWZvcmVSZW1vdmUgY2FsbGJhY2spCgkgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChub2Rlc1RvRGVsZXRlLCBvcHRpb25zWydiZWZvcmVSZW1vdmUnXSA/IGtvLmNsZWFuTm9kZSA6IGtvLnJlbW92ZU5vZGUpOwoKCSAgICAgICAgLy8gTmV4dCBhZGQvcmVvcmRlciB0aGUgcmVtYWluaW5nIGl0ZW1zICh3aWxsIGluY2x1ZGUgZGVsZXRlZCBpdGVtcyBpZiB0aGVyZSdzIGEgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrKQoJICAgICAgICBmb3IgKHZhciBpID0gMCwgbmV4dE5vZGUgPSBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZChkb21Ob2RlKSwgbGFzdE5vZGUsIG5vZGU7IG1hcERhdGEgPSBpdGVtc1RvUHJvY2Vzc1tpXTsgaSsrKSB7CgkgICAgICAgICAgICAvLyBHZXQgbm9kZXMgZm9yIG5ld2x5IGFkZGVkIGl0ZW1zCgkgICAgICAgICAgICBpZiAoIW1hcERhdGEubWFwcGVkTm9kZXMpCgkgICAgICAgICAgICAgICAga28udXRpbHMuZXh0ZW5kKG1hcERhdGEsIG1hcE5vZGVBbmRSZWZyZXNoV2hlbkNoYW5nZWQoZG9tTm9kZSwgbWFwcGluZywgbWFwRGF0YS5hcnJheUVudHJ5LCBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMsIG1hcERhdGEuaW5kZXhPYnNlcnZhYmxlKSk7CgoJICAgICAgICAgICAgLy8gUHV0IG5vZGVzIGluIHRoZSByaWdodCBwbGFjZSBpZiB0aGV5IGFyZW4ndCB0aGVyZSBhbHJlYWR5CgkgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgbm9kZSA9IG1hcERhdGEubWFwcGVkTm9kZXNbal07IG5leHROb2RlID0gbm9kZS5uZXh0U2libGluZywgbGFzdE5vZGUgPSBub2RlLCBqKyspIHsKCSAgICAgICAgICAgICAgICBpZiAobm9kZSAhPT0gbmV4dE5vZGUpCgkgICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcihkb21Ob2RlLCBub2RlLCBsYXN0Tm9kZSk7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gUnVuIHRoZSBjYWxsYmFja3MgZm9yIG5ld2x5IGFkZGVkIG5vZGVzIChmb3IgZXhhbXBsZSwgdG8gYXBwbHkgYmluZGluZ3MsIGV0Yy4pCgkgICAgICAgICAgICBpZiAoIW1hcERhdGEuaW5pdGlhbGl6ZWQgJiYgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKSB7CgkgICAgICAgICAgICAgICAgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKG1hcERhdGEuYXJyYXlFbnRyeSwgbWFwRGF0YS5tYXBwZWROb2RlcywgbWFwRGF0YS5pbmRleE9ic2VydmFibGUpOwoJICAgICAgICAgICAgICAgIG1hcERhdGEuaW5pdGlhbGl6ZWQgPSB0cnVlOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICAvLyBJZiB0aGVyZSdzIGEgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrLCBjYWxsIGl0IGFmdGVyIHJlb3JkZXJpbmcuCgkgICAgICAgIC8vIE5vdGUgdGhhdCB3ZSBhc3N1bWUgdGhhdCB0aGUgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrIHdpbGwgdXN1YWxseSBiZSB1c2VkIHRvIHJlbW92ZSB0aGUgbm9kZXMgdXNpbmcKCSAgICAgICAgLy8gc29tZSBzb3J0IG9mIGFuaW1hdGlvbiwgd2hpY2ggaXMgd2h5IHdlIGZpcnN0IHJlb3JkZXIgdGhlIG5vZGVzIHRoYXQgd2lsbCBiZSByZW1vdmVkLiBJZiB0aGUKCSAgICAgICAgLy8gY2FsbGJhY2sgaW5zdGVhZCByZW1vdmVzIHRoZSBub2RlcyByaWdodCBhd2F5LCBpdCB3b3VsZCBiZSBtb3JlIGVmZmljaWVudCB0byBza2lwIHJlb3JkZXJpbmcgdGhlbS4KCSAgICAgICAgLy8gUGVyaGFwcyB3ZSdsbCBtYWtlIHRoYXQgY2hhbmdlIGluIHRoZSBmdXR1cmUgaWYgdGhpcyBzY2VuYXJpbyBiZWNvbWVzIG1vcmUgY29tbW9uLgoJICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYmVmb3JlUmVtb3ZlJ10sIGl0ZW1zRm9yQmVmb3JlUmVtb3ZlQ2FsbGJhY2tzKTsKCgkgICAgICAgIC8vIEZpbmFsbHkgY2FsbCBhZnRlck1vdmUgYW5kIGFmdGVyQWRkIGNhbGxiYWNrcwoJICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYWZ0ZXJNb3ZlJ10sIGl0ZW1zRm9yTW92ZUNhbGxiYWNrcyk7CgkgICAgICAgIGNhbGxDYWxsYmFjayhvcHRpb25zWydhZnRlckFkZCddLCBpdGVtc0ZvckFmdGVyQWRkQ2FsbGJhY2tzKTsKCgkgICAgICAgIC8vIFN0b3JlIGEgY29weSBvZiB0aGUgYXJyYXkgaXRlbXMgd2UganVzdCBjb25zaWRlcmVkIHNvIHdlIGNhbiBkaWZmZXJlbmNlIGl0IG5leHQgdGltZQoJICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXksIG5ld01hcHBpbmdSZXN1bHQpOwoJICAgIH0KCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nJywga28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyk7Cglrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSA9IGZ1bmN0aW9uICgpIHsKCSAgICB0aGlzWydhbGxvd1RlbXBsYXRlUmV3cml0aW5nJ10gPSBmYWxzZTsKCX0KCglrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGUgPSBuZXcga28udGVtcGxhdGVFbmdpbmUoKTsKCWtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lOwoJa28ubmF0aXZlVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddID0gZnVuY3Rpb24gKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewoJICAgIHZhciB1c2VOb2Rlc0lmQXZhaWxhYmxlID0gIShrby51dGlscy5pZVZlcnNpb24gPCA5KSwgLy8gSUU8OSBjbG9uZU5vZGUgZG9lc24ndCB3b3JrIHByb3Blcmx5CgkgICAgICAgIHRlbXBsYXRlTm9kZXNGdW5jID0gdXNlTm9kZXNJZkF2YWlsYWJsZSA/IHRlbXBsYXRlU291cmNlWydub2RlcyddIDogbnVsbCwKCSAgICAgICAgdGVtcGxhdGVOb2RlcyA9IHRlbXBsYXRlTm9kZXNGdW5jID8gdGVtcGxhdGVTb3VyY2VbJ25vZGVzJ10oKSA6IG51bGw7CgoJICAgIGlmICh0ZW1wbGF0ZU5vZGVzKSB7CgkgICAgICAgIHJldHVybiBrby51dGlscy5tYWtlQXJyYXkodGVtcGxhdGVOb2Rlcy5jbG9uZU5vZGUodHJ1ZSkuY2hpbGROb2Rlcyk7CgkgICAgfSBlbHNlIHsKCSAgICAgICAgdmFyIHRlbXBsYXRlVGV4dCA9IHRlbXBsYXRlU291cmNlWyd0ZXh0J10oKTsKCSAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KHRlbXBsYXRlVGV4dCk7CgkgICAgfQoJfTsKCglrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSA9IG5ldyBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSgpOwoJa28uc2V0VGVtcGxhdGVFbmdpbmUoa28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UpOwoKCWtvLmV4cG9ydFN5bWJvbCgnbmF0aXZlVGVtcGxhdGVFbmdpbmUnLCBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSk7CgkoZnVuY3Rpb24oKSB7CgkgICAga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAvLyBEZXRlY3Qgd2hpY2ggdmVyc2lvbiBvZiBqcXVlcnktdG1wbCB5b3UncmUgdXNpbmcuIFVuZm9ydHVuYXRlbHkganF1ZXJ5LXRtcGwKCSAgICAgICAgLy8gZG9lc24ndCBleHBvc2UgYSB2ZXJzaW9uIG51bWJlciwgc28gd2UgaGF2ZSB0byBpbmZlciBpdC4KCSAgICAgICAgLy8gTm90ZSB0aGF0IGFzIG9mIEtub2Nrb3V0IDEuMywgd2Ugb25seSBzdXBwb3J0IGpRdWVyeS50bXBsIDEuMC4wcHJlIGFuZCBsYXRlciwKCSAgICAgICAgLy8gd2hpY2ggS08gaW50ZXJuYWxseSByZWZlcnMgdG8gYXMgdmVyc2lvbiAiMiIsIHNvIG9sZGVyIHZlcnNpb25zIGFyZSBubyBsb25nZXIgZGV0ZWN0ZWQuCgkgICAgICAgIHZhciBqUXVlcnlUbXBsVmVyc2lvbiA9IHRoaXMualF1ZXJ5VG1wbFZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICBpZiAoIWpRdWVyeUluc3RhbmNlIHx8ICEoalF1ZXJ5SW5zdGFuY2VbJ3RtcGwnXSkpCgkgICAgICAgICAgICAgICAgcmV0dXJuIDA7CgkgICAgICAgICAgICAvLyBTaW5jZSBpdCBleHBvc2VzIG5vIG9mZmljaWFsIHZlcnNpb24gbnVtYmVyLCB3ZSB1c2Ugb3VyIG93biBudW1iZXJpbmcgc3lzdGVtLiBUbyBiZSB1cGRhdGVkIGFzIGpxdWVyeS10bXBsIGV2b2x2ZXMuCgkgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgIGlmIChqUXVlcnlJbnN0YW5jZVsndG1wbCddWyd0YWcnXVsndG1wbCddWydvcGVuJ10udG9TdHJpbmcoKS5pbmRleE9mKCdfXycpID49IDApIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gU2luY2UgMS4wLjBwcmUsIGN1c3RvbSB0YWdzIHNob3VsZCBhcHBlbmQgbWFya3VwIHRvIGFuIGFycmF5IGNhbGxlZCAiX18iCgkgICAgICAgICAgICAgICAgICAgIHJldHVybiAyOyAvLyBGaW5hbCB2ZXJzaW9uIG9mIGpxdWVyeS50bXBsCgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSBjYXRjaChleCkgeyAvKiBBcHBhcmVudGx5IG5vdCB0aGUgdmVyc2lvbiB3ZSB3ZXJlIGxvb2tpbmcgZm9yICovIH0KCgkgICAgICAgICAgICByZXR1cm4gMTsgLy8gQW55IG9sZGVyIHZlcnNpb24gdGhhdCB3ZSBkb24ndCBzdXBwb3J0CgkgICAgICAgIH0pKCk7CgoJICAgICAgICBmdW5jdGlvbiBlbnN1cmVIYXNSZWZlcmVuY2VkSlF1ZXJ5VGVtcGxhdGVzKCkgewoJICAgICAgICAgICAgaWYgKGpRdWVyeVRtcGxWZXJzaW9uIDwgMikKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIllvdXIgdmVyc2lvbiBvZiBqUXVlcnkudG1wbCBpcyB0b28gb2xkLiBQbGVhc2UgdXBncmFkZSB0byBqUXVlcnkudG1wbCAxLjAuMHByZSBvciBsYXRlci4iKTsKCSAgICAgICAgfQoKCSAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZVRlbXBsYXRlKGNvbXBpbGVkVGVtcGxhdGUsIGRhdGEsIGpRdWVyeVRlbXBsYXRlT3B0aW9ucykgewoJICAgICAgICAgICAgcmV0dXJuIGpRdWVyeUluc3RhbmNlWyd0bXBsJ10oY29tcGlsZWRUZW1wbGF0ZSwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKTsKCSAgICAgICAgfQoKCSAgICAgICAgdGhpc1sncmVuZGVyVGVtcGxhdGVTb3VyY2UnXSA9IGZ1bmN0aW9uKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewoJICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkgICAgICAgICAgICBlbnN1cmVIYXNSZWZlcmVuY2VkSlF1ZXJ5VGVtcGxhdGVzKCk7CgoJICAgICAgICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgc3RvcmVkIGEgcHJlY29tcGlsZWQgdmVyc2lvbiBvZiB0aGlzIHRlbXBsYXRlIChkb24ndCB3YW50IHRvIHJlcGFyc2Ugb24gZXZlcnkgcmVuZGVyKQoJICAgICAgICAgICAgdmFyIHByZWNvbXBpbGVkID0gdGVtcGxhdGVTb3VyY2VbJ2RhdGEnXSgncHJlY29tcGlsZWQnKTsKCSAgICAgICAgICAgIGlmICghcHJlY29tcGlsZWQpIHsKCSAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVUZXh0ID0gdGVtcGxhdGVTb3VyY2VbJ3RleHQnXSgpIHx8ICIiOwoJICAgICAgICAgICAgICAgIC8vIFdyYXAgaW4gIndpdGgoJHdoYXRldmVyLmtvQmluZGluZ0NvbnRleHQpIHsgLi4uIH0iCgkgICAgICAgICAgICAgICAgdGVtcGxhdGVUZXh0ID0gInt7a29fd2l0aCAkaXRlbS5rb0JpbmRpbmdDb250ZXh0fX0iICsgdGVtcGxhdGVUZXh0ICsgInt7L2tvX3dpdGh9fSI7CgoJICAgICAgICAgICAgICAgIHByZWNvbXBpbGVkID0galF1ZXJ5SW5zdGFuY2VbJ3RlbXBsYXRlJ10obnVsbCwgdGVtcGxhdGVUZXh0KTsKCSAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcsIHByZWNvbXBpbGVkKTsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICB2YXIgZGF0YSA9IFtiaW5kaW5nQ29udGV4dFsnJGRhdGEnXV07IC8vIFByZXdyYXAgdGhlIGRhdGEgaW4gYW4gYXJyYXkgdG8gc3RvcCBqcXVlcnkudG1wbCBmcm9tIHRyeWluZyB0byB1bndyYXAgYW55IGFycmF5cwoJICAgICAgICAgICAgdmFyIGpRdWVyeVRlbXBsYXRlT3B0aW9ucyA9IGpRdWVyeUluc3RhbmNlWydleHRlbmQnXSh7ICdrb0JpbmRpbmdDb250ZXh0JzogYmluZGluZ0NvbnRleHQgfSwgb3B0aW9uc1sndGVtcGxhdGVPcHRpb25zJ10pOwoKCSAgICAgICAgICAgIHZhciByZXN1bHROb2RlcyA9IGV4ZWN1dGVUZW1wbGF0ZShwcmVjb21waWxlZCwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKTsKCSAgICAgICAgICAgIHJlc3VsdE5vZGVzWydhcHBlbmRUbyddKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpKTsgLy8gVXNpbmcgImFwcGVuZFRvIiBmb3JjZXMgalF1ZXJ5L2pRdWVyeS50bXBsIHRvIHBlcmZvcm0gbmVjZXNzYXJ5IGNsZWFudXAgd29yawoKCSAgICAgICAgICAgIGpRdWVyeUluc3RhbmNlWydmcmFnbWVudHMnXSA9IHt9OyAvLyBDbGVhciBqUXVlcnkncyBmcmFnbWVudCBjYWNoZSB0byBhdm9pZCBhIG1lbW9yeSBsZWFrIGFmdGVyIGEgbGFyZ2UgbnVtYmVyIG9mIHRlbXBsYXRlIHJlbmRlcnMKCSAgICAgICAgICAgIHJldHVybiByZXN1bHROb2RlczsKCSAgICAgICAgfTsKCgkgICAgICAgIHRoaXNbJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jayddID0gZnVuY3Rpb24oc2NyaXB0KSB7CgkgICAgICAgICAgICByZXR1cm4gInt7a29fY29kZSAoKGZ1bmN0aW9uKCkgeyByZXR1cm4gIiArIHNjcmlwdCArICIgfSkoKSkgfX0iOwoJICAgICAgICB9OwoKCSAgICAgICAgdGhpc1snYWRkVGVtcGxhdGUnXSA9IGZ1bmN0aW9uKHRlbXBsYXRlTmFtZSwgdGVtcGxhdGVNYXJrdXApIHsKCSAgICAgICAgICAgIGRvY3VtZW50LndyaXRlKCI8c2NyaXB0IHR5cGU9J3RleHQvaHRtbCcgaWQ9JyIgKyB0ZW1wbGF0ZU5hbWUgKyAiJz4iICsgdGVtcGxhdGVNYXJrdXAgKyAiPCIgKyAiL3NjcmlwdD4iKTsKCSAgICAgICAgfTsKCgkgICAgICAgIGlmIChqUXVlcnlUbXBsVmVyc2lvbiA+IDApIHsKCSAgICAgICAgICAgIGpRdWVyeUluc3RhbmNlWyd0bXBsJ11bJ3RhZyddWydrb19jb2RlJ10gPSB7CgkgICAgICAgICAgICAgICAgb3BlbjogIl9fLnB1c2goJDEgfHwgJycpOyIKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICBqUXVlcnlJbnN0YW5jZVsndG1wbCddWyd0YWcnXVsna29fd2l0aCddID0gewoJICAgICAgICAgICAgICAgIG9wZW46ICJ3aXRoKCQxKSB7IiwKCSAgICAgICAgICAgICAgICBjbG9zZTogIn0gIgoJICAgICAgICAgICAgfTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIGtvLmpxdWVyeVRtcGxUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGUgPSBuZXcga28udGVtcGxhdGVFbmdpbmUoKTsKCSAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0ga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lOwoKCSAgICAvLyBVc2UgdGhpcyBvbmUgYnkgZGVmYXVsdCAqb25seSBpZiBqcXVlcnkudG1wbCBpcyByZWZlcmVuY2VkKgoJICAgIHZhciBqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZSA9IG5ldyBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUoKTsKCSAgICBpZiAoanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lSW5zdGFuY2UualF1ZXJ5VG1wbFZlcnNpb24gPiAwKQoJICAgICAgICBrby5zZXRUZW1wbGF0ZUVuZ2luZShqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZSk7CgoJICAgIGtvLmV4cG9ydFN5bWJvbCgnanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lJywga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lKTsKCX0pKCk7Cgl9KSk7Cgl9KCkpOwoJfSkoKTsKCgovKioqLyB9Ci8qKioqKiovIF0pCn0pOwo=",
                "body": "LyoKICBrbm9ja2JhY2stZnVsbC1zdGFjay5qcyAwLjIwLjQKICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCiAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCiAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgogIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoqLwooZnVuY3Rpb24gd2VicGFja1VuaXZlcnNhbE1vZHVsZURlZmluaXRpb24ocm9vdCwgZmFjdG9yeSkgewoJaWYodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnKQoJCW1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCJqcXVlcnkiKSk7CgllbHNlIGlmKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkKCQlkZWZpbmUoWyJqcXVlcnkiXSwgZmFjdG9yeSk7CgllbHNlIGlmKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykKCQlleHBvcnRzWyJrYiJdID0gZmFjdG9yeShyZXF1aXJlKCJqcXVlcnkiKSk7CgllbHNlCgkJcm9vdFsia2IiXSA9IGZhY3Rvcnkocm9vdFsialF1ZXJ5Il0pOwp9KSh0aGlzLCBmdW5jdGlvbihfX1dFQlBBQ0tfRVhURVJOQUxfTU9EVUxFXzIwX18pIHsKcmV0dXJuIC8qKioqKiovIChmdW5jdGlvbihtb2R1bGVzKSB7IC8vIHdlYnBhY2tCb290c3RyYXAKLyoqKioqKi8gCS8vIFRoZSBtb2R1bGUgY2FjaGUKLyoqKioqKi8gCXZhciBpbnN0YWxsZWRNb2R1bGVzID0ge307Ci8qKioqKiovCi8qKioqKiovIAkvLyBUaGUgcmVxdWlyZSBmdW5jdGlvbgovKioqKioqLyAJZnVuY3Rpb24gX193ZWJwYWNrX3JlcXVpcmVfXyhtb2R1bGVJZCkgewovKioqKioqLwovKioqKioqLyAJCS8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZQovKioqKioqLyAJCWlmKGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdKQovKioqKioqLyAJCQlyZXR1cm4gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0uZXhwb3J0czsKLyoqKioqKi8KLyoqKioqKi8gCQkvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIChhbmQgcHV0IGl0IGludG8gdGhlIGNhY2hlKQovKioqKioqLyAJCXZhciBtb2R1bGUgPSBpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXSA9IHsKLyoqKioqKi8gCQkJZXhwb3J0czoge30sCi8qKioqKiovIAkJCWlkOiBtb2R1bGVJZCwKLyoqKioqKi8gCQkJbG9hZGVkOiBmYWxzZQovKioqKioqLyAJCX07Ci8qKioqKiovCi8qKioqKiovIAkJLy8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uCi8qKioqKiovIAkJbW9kdWxlc1ttb2R1bGVJZF0uY2FsbChtb2R1bGUuZXhwb3J0cywgbW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7Ci8qKioqKiovCi8qKioqKiovIAkJLy8gRmxhZyB0aGUgbW9kdWxlIGFzIGxvYWRlZAovKioqKioqLyAJCW1vZHVsZS5sb2FkZWQgPSB0cnVlOwovKioqKioqLwovKioqKioqLyAJCS8vIFJldHVybiB0aGUgZXhwb3J0cyBvZiB0aGUgbW9kdWxlCi8qKioqKiovIAkJcmV0dXJuIG1vZHVsZS5leHBvcnRzOwovKioqKioqLyAJfQovKioqKioqLwovKioqKioqLwovKioqKioqLyAJLy8gZXhwb3NlIHRoZSBtb2R1bGVzIG9iamVjdCAoX193ZWJwYWNrX21vZHVsZXNfXykKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18ubSA9IG1vZHVsZXM7Ci8qKioqKiovCi8qKioqKiovIAkvLyBleHBvc2UgdGhlIG1vZHVsZSBjYWNoZQovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXy5jID0gaW5zdGFsbGVkTW9kdWxlczsKLyoqKioqKi8KLyoqKioqKi8gCS8vIF9fd2VicGFja19wdWJsaWNfcGF0aF9fCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fLnAgPSAiIjsKLyoqKioqKi8KLyoqKioqKi8gCS8vIExvYWQgZW50cnkgbW9kdWxlIGFuZCByZXR1cm4gZXhwb3J0cwovKioqKioqLyAJcmV0dXJuIF9fd2VicGFja19yZXF1aXJlX18oMCk7Ci8qKioqKiovIH0pCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIChbCi8qIDAgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJX193ZWJwYWNrX3JlcXVpcmVfXygxKTsKCV9fd2VicGFja19yZXF1aXJlX18oMik7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOwoJX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsKCV9fd2VicGFja19yZXF1aXJlX18oNSk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDYpOwoJX193ZWJwYWNrX3JlcXVpcmVfXyg3KTsKCV9fd2VicGFja19yZXF1aXJlX18oOCk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDkpOwoJX193ZWJwYWNrX3JlcXVpcmVfXygxMCk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDExKTsKCV9fd2VicGFja19yZXF1aXJlX18oMTIpOwoJX193ZWJwYWNrX3JlcXVpcmVfXygxMyk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDE1KTsKCV9fd2VicGFja19yZXF1aXJlX18oMTYpOwoJX193ZWJwYWNrX3JlcXVpcmVfXygxNyk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDE4KTsKCV9fd2VicGFja19yZXF1aXJlX18oMTkpOwoJbW9kdWxlLmV4cG9ydHMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE0KTsKCgovKioqLyB9LAovKiAxICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIENPTVBBUkVfQVNDRU5ESU5HLCBDT01QQVJFX0RFU0NFTkRJTkcsIENPTVBBUkVfRVFVQUwsIEtFWVNfUFVCTElTSCwga2IsIGtvLCBfLCBfcmVmLAoJICBfX2JpbmQgPSBmdW5jdGlvbihmbiwgbWUpeyByZXR1cm4gZnVuY3Rpb24oKXsgcmV0dXJuIGZuLmFwcGx5KG1lLCBhcmd1bWVudHMpOyB9OyB9LAoJICBfX2luZGV4T2YgPSBbXS5pbmRleE9mIHx8IGZ1bmN0aW9uKGl0ZW0pIHsgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKykgeyBpZiAoaSBpbiB0aGlzICYmIHRoaXNbaV0gPT09IGl0ZW0pIHJldHVybiBpOyB9IHJldHVybiAtMTsgfTsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJQ09NUEFSRV9FUVVBTCA9IDA7CgoJQ09NUEFSRV9BU0NFTkRJTkcgPSAtMTsKCglDT01QQVJFX0RFU0NFTkRJTkcgPSAxOwoKCUtFWVNfUFVCTElTSCA9IFsnZGVzdHJveScsICdzaGFyZU9wdGlvbnMnLCAnZmlsdGVycycsICdjb21wYXJhdG9yJywgJ3NvcnRBdHRyaWJ1dGUnLCAndmlld01vZGVsQnlNb2RlbCcsICdoYXNWaWV3TW9kZWxzJ107CgoJa2IuY29tcGFyZSA9IGZ1bmN0aW9uKHZhbHVlX2EsIHZhbHVlX2IpIHsKCSAgaWYgKF8uaXNTdHJpbmcodmFsdWVfYSkpIHsKCSAgICByZXR1cm4gdmFsdWVfYS5sb2NhbGVDb21wYXJlKCIiICsgdmFsdWVfYik7CgkgIH0KCSAgaWYgKF8uaXNTdHJpbmcodmFsdWVfYikpIHsKCSAgICByZXR1cm4gdmFsdWVfYi5sb2NhbGVDb21wYXJlKCIiICsgdmFsdWVfYSk7CgkgIH0KCSAgaWYgKHZhbHVlX2EgPT09IHZhbHVlX2IpIHsKCSAgICByZXR1cm4gQ09NUEFSRV9FUVVBTDsKCSAgfSBlbHNlIHsKCSAgICBpZiAodmFsdWVfYSA8IHZhbHVlX2IpIHsKCSAgICAgIHJldHVybiBDT01QQVJFX0FTQ0VORElORzsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIENPTVBBUkVfREVTQ0VORElORzsKCSAgICB9CgkgIH0KCX07CgoJa2IuQ29sbGVjdGlvbk9ic2VydmFibGUgPSAoZnVuY3Rpb24oKSB7CgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLmV4dGVuZCA9IGtiLmV4dGVuZDsKCgkgIGZ1bmN0aW9uIENvbGxlY3Rpb25PYnNlcnZhYmxlKGNvbGxlY3Rpb24sIHZpZXdfbW9kZWwsIG9wdGlvbnMpIHsKCSAgICB0aGlzLl9vbkNvbGxlY3Rpb25DaGFuZ2UgPSBfX2JpbmQodGhpcy5fb25Db2xsZWN0aW9uQ2hhbmdlLCB0aGlzKTsKCSAgICB2YXIgYXJnczsKCSAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoXy5pc0FyZ3VtZW50cyhjb2xsZWN0aW9uKSA/IGNvbGxlY3Rpb24gOiBhcmd1bWVudHMpOwoJICAgIHJldHVybiBrYi5pZ25vcmUoKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgIHZhciBhcmcsIGNyZWF0ZV9vcHRpb25zLCBvYnNlcnZhYmxlLCBfaSwgX2xlbjsKCSAgICAgICAgY29sbGVjdGlvbiA9IGFyZ3NbMF0gaW5zdGFuY2VvZiBrYi5Db2xsZWN0aW9uID8gYXJncy5zaGlmdCgpIDogKF8uaXNBcnJheShhcmdzWzBdKSA/IG5ldyBrYi5Db2xsZWN0aW9uKGFyZ3Muc2hpZnQoKSkgOiBuZXcga2IuQ29sbGVjdGlvbigpKTsKCSAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihhcmdzWzBdKSkgewoJICAgICAgICAgIGFyZ3NbMF0gPSB7CgkgICAgICAgICAgICB2aWV3X21vZGVsOiBhcmdzWzBdCgkgICAgICAgICAgfTsKCSAgICAgICAgfQoJICAgICAgICBvcHRpb25zID0ge307CgkgICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gYXJncy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgICAgIGFyZyA9IGFyZ3NbX2ldOwoJICAgICAgICAgIF8uZXh0ZW5kKG9wdGlvbnMsIGFyZyk7CgkgICAgICAgIH0KCSAgICAgICAgb2JzZXJ2YWJsZSA9IGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKF90aGlzLCBrby5vYnNlcnZhYmxlQXJyYXkoW10pKTsKCSAgICAgICAgb2JzZXJ2YWJsZS5fX2tiX2lzX2NvID0gdHJ1ZTsKCSAgICAgICAgX3RoaXMuaW5fZWRpdCA9IDA7CgkgICAgICAgIF90aGlzLl9fa2IgfHwgKF90aGlzLl9fa2IgPSB7fSk7CgkgICAgICAgIG9wdGlvbnMgPSBrYi51dGlscy5jb2xsYXBzZU9wdGlvbnMob3B0aW9ucyk7CgkgICAgICAgIGlmIChvcHRpb25zLmF1dG9fY29tcGFjdCkgewoJICAgICAgICAgIF90aGlzLmF1dG9fY29tcGFjdCA9IHRydWU7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKG9wdGlvbnMuc29ydF9hdHRyaWJ1dGUpIHsKCSAgICAgICAgICBfdGhpcy5fY29tcGFyYXRvciA9IGtvLm9ic2VydmFibGUoX3RoaXMuX2F0dHJpYnV0ZUNvbXBhcmF0b3Iob3B0aW9ucy5zb3J0X2F0dHJpYnV0ZSkpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIF90aGlzLl9jb21wYXJhdG9yID0ga28ub2JzZXJ2YWJsZShvcHRpb25zLmNvbXBhcmF0b3IpOwoJICAgICAgICB9CgkgICAgICAgIGlmIChvcHRpb25zLmZpbHRlcnMpIHsKCSAgICAgICAgICBfdGhpcy5fZmlsdGVycyA9IGtvLm9ic2VydmFibGVBcnJheShfLmlzQXJyYXkob3B0aW9ucy5maWx0ZXJzKSA/IG9wdGlvbnMuZmlsdGVycyA6IG9wdGlvbnMuZmlsdGVycyA/IFtvcHRpb25zLmZpbHRlcnNdIDogdm9pZCAwKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICBfdGhpcy5fZmlsdGVycyA9IGtvLm9ic2VydmFibGVBcnJheShbXSk7CgkgICAgICAgIH0KCSAgICAgICAgY3JlYXRlX29wdGlvbnMgPSBfdGhpcy5jcmVhdGVfb3B0aW9ucyA9IHsKCSAgICAgICAgICBzdG9yZToga2IuU3RvcmUudXNlT3B0aW9uc09yQ3JlYXRlKG9wdGlvbnMsIGNvbGxlY3Rpb24sIG9ic2VydmFibGUpCgkgICAgICAgIH07CgkgICAgICAgIGtiLnV0aWxzLndyYXBwZWRPYmplY3Qob2JzZXJ2YWJsZSwgY29sbGVjdGlvbik7CgkgICAgICAgIF90aGlzLnBhdGggPSBvcHRpb25zLnBhdGg7CgkgICAgICAgIGNyZWF0ZV9vcHRpb25zLmZhY3RvcnkgPSBrYi51dGlscy53cmFwcGVkRmFjdG9yeShvYnNlcnZhYmxlLCBfdGhpcy5fc2hhcmVPckNyZWF0ZUZhY3Rvcnkob3B0aW9ucykpOwoJICAgICAgICBjcmVhdGVfb3B0aW9ucy5wYXRoID0ga2IudXRpbHMucGF0aEpvaW4ob3B0aW9ucy5wYXRoLCAnbW9kZWxzJyk7CgkgICAgICAgIGNyZWF0ZV9vcHRpb25zLmNyZWF0b3IgPSBjcmVhdGVfb3B0aW9ucy5mYWN0b3J5LmNyZWF0b3JGb3JQYXRoKG51bGwsIGNyZWF0ZV9vcHRpb25zLnBhdGgpOwoJICAgICAgICBpZiAoY3JlYXRlX29wdGlvbnMuY3JlYXRvcikgewoJICAgICAgICAgIF90aGlzLm1vZGVsc19vbmx5ID0gY3JlYXRlX29wdGlvbnMuY3JlYXRvci5tb2RlbHNfb25seTsKCSAgICAgICAgfQoJICAgICAgICBrYi5wdWJsaXNoTWV0aG9kcyhvYnNlcnZhYmxlLCBfdGhpcywgS0VZU19QVUJMSVNIKTsKCSAgICAgICAgX3RoaXMuX2NvbGxlY3Rpb24gPSBrby5vYnNlcnZhYmxlKGNvbGxlY3Rpb24pOwoJICAgICAgICBvYnNlcnZhYmxlLmNvbGxlY3Rpb24gPSBfdGhpcy5jb2xsZWN0aW9uID0ga28uY29tcHV0ZWQoewoJICAgICAgICAgIHJlYWQ6IGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9jb2xsZWN0aW9uKCk7CgkgICAgICAgICAgfSwKCSAgICAgICAgICB3cml0ZTogZnVuY3Rpb24obmV3X2NvbGxlY3Rpb24pIHsKCSAgICAgICAgICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgIHZhciBwcmV2aW91c19jb2xsZWN0aW9uOwoJICAgICAgICAgICAgICBpZiAoKHByZXZpb3VzX2NvbGxlY3Rpb24gPSBfdGhpcy5fY29sbGVjdGlvbigpKSA9PT0gbmV3X2NvbGxlY3Rpb24pIHsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAga2IudXRpbHMud3JhcHBlZE9iamVjdChvYnNlcnZhYmxlLCBuZXdfY29sbGVjdGlvbik7CgkgICAgICAgICAgICAgIGlmIChwcmV2aW91c19jb2xsZWN0aW9uKSB7CgkgICAgICAgICAgICAgICAgcHJldmlvdXNfY29sbGVjdGlvbi51bmJpbmQoJ2FsbCcsIF90aGlzLl9vbkNvbGxlY3Rpb25DaGFuZ2UpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIGlmIChuZXdfY29sbGVjdGlvbikgewoJICAgICAgICAgICAgICAgIG5ld19jb2xsZWN0aW9uLmJpbmQoJ2FsbCcsIF90aGlzLl9vbkNvbGxlY3Rpb25DaGFuZ2UpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5fY29sbGVjdGlvbihuZXdfY29sbGVjdGlvbik7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgICAgICBpZiAoY29sbGVjdGlvbikgewoJICAgICAgICAgIGNvbGxlY3Rpb24uYmluZCgnYWxsJywgX3RoaXMuX29uQ29sbGVjdGlvbkNoYW5nZSk7CgkgICAgICAgIH0KCSAgICAgICAgX3RoaXMuX21hcHBlciA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgICAgICAgIHZhciBjb21wYXJhdG9yLCBjdXJyZW50X2NvbGxlY3Rpb24sIGZpbHRlciwgZmlsdGVycywgbW9kZWxzLCBwcmV2aW91c192aWV3X21vZGVscywgdmlld19tb2RlbHMsIF9qLCBfbGVuMTsKCSAgICAgICAgICBjb21wYXJhdG9yID0gX3RoaXMuX2NvbXBhcmF0b3IoKTsKCSAgICAgICAgICBmaWx0ZXJzID0gX3RoaXMuX2ZpbHRlcnMoKTsKCSAgICAgICAgICBpZiAoZmlsdGVycykgewoJICAgICAgICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gZmlsdGVycy5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKCSAgICAgICAgICAgICAgZmlsdGVyID0gZmlsdGVyc1tfal07CgkgICAgICAgICAgICAgIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoZmlsdGVyKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICB9CgkgICAgICAgICAgY3VycmVudF9jb2xsZWN0aW9uID0gX3RoaXMuX2NvbGxlY3Rpb24oKTsKCSAgICAgICAgICBpZiAoX3RoaXMuaW5fZWRpdCkgewoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgIH0KCSAgICAgICAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUoX3RoaXMpOwoJICAgICAgICAgIHByZXZpb3VzX3ZpZXdfbW9kZWxzID0ga2IucGVlayhvYnNlcnZhYmxlKTsKCSAgICAgICAgICBpZiAoY3VycmVudF9jb2xsZWN0aW9uKSB7CgkgICAgICAgICAgICBtb2RlbHMgPSBjdXJyZW50X2NvbGxlY3Rpb24ubW9kZWxzOwoJICAgICAgICAgIH0KCSAgICAgICAgICBpZiAoIW1vZGVscyB8fCAoY3VycmVudF9jb2xsZWN0aW9uLm1vZGVscy5sZW5ndGggPT09IDApKSB7CgkgICAgICAgICAgICB2aWV3X21vZGVscyA9IFtdOwoJICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBtb2RlbHMgPSBfLmZpbHRlcihtb2RlbHMsIGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAgICAgICAgIHJldHVybiAhZmlsdGVycy5sZW5ndGggfHwgX3RoaXMuX3NlbGVjdE1vZGVsKG1vZGVsKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgaWYgKGNvbXBhcmF0b3IpIHsKCSAgICAgICAgICAgICAgdmlld19tb2RlbHMgPSBfLm1hcChtb2RlbHMsIGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9jcmVhdGVWaWV3TW9kZWwobW9kZWwpOwoJICAgICAgICAgICAgICB9KS5zb3J0KGNvbXBhcmF0b3IpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgaWYgKF90aGlzLm1vZGVsc19vbmx5KSB7CgkgICAgICAgICAgICAgICAgdmlld19tb2RlbHMgPSBmaWx0ZXJzLmxlbmd0aCA/IG1vZGVscyA6IG1vZGVscy5zbGljZSgpOwoJICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIHZpZXdfbW9kZWxzID0gXy5tYXAobW9kZWxzLCBmdW5jdGlvbihtb2RlbCkgewoJICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9jcmVhdGVWaWV3TW9kZWwobW9kZWwpOwoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgfQoJICAgICAgICAgIF90aGlzLmluX2VkaXQrKzsKCSAgICAgICAgICBvYnNlcnZhYmxlKHZpZXdfbW9kZWxzKTsKCSAgICAgICAgICBfdGhpcy5pbl9lZGl0LS07CgkgICAgICAgIH0pOwoJICAgICAgICBvYnNlcnZhYmxlLnN1YnNjcmliZShfLmJpbmQoX3RoaXMuX29uT2JzZXJ2YWJsZUFycmF5Q2hhbmdlLCBfdGhpcykpOwoJICAgICAgICAha2Iuc3RhdGlzdGljcyB8fCBrYi5zdGF0aXN0aWNzLnJlZ2lzdGVyKCdDb2xsZWN0aW9uT2JzZXJ2YWJsZScsIF90aGlzKTsKCSAgICAgICAgcmV0dXJuIG9ic2VydmFibGU7CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKTsKCSAgfQoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgYXJyYXksIGNvbGxlY3Rpb24sIG9ic2VydmFibGU7CgkgICAgdGhpcy5fX2tiX3JlbGVhc2VkID0gdHJ1ZTsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcyk7CgkgICAgY29sbGVjdGlvbiA9IGtiLnBlZWsodGhpcy5fY29sbGVjdGlvbik7CgkgICAga2IudXRpbHMud3JhcHBlZE9iamVjdChvYnNlcnZhYmxlLCBudWxsKTsKCSAgICBpZiAoY29sbGVjdGlvbikgewoJICAgICAgY29sbGVjdGlvbi51bmJpbmQoJ2FsbCcsIHRoaXMuX29uQ29sbGVjdGlvbkNoYW5nZSk7CgkgICAgICBhcnJheSA9IGtiLnBlZWsob2JzZXJ2YWJsZSk7CgkgICAgICBhcnJheS5zcGxpY2UoMCwgYXJyYXkubGVuZ3RoKTsKCSAgICB9CgkgICAgdGhpcy5jb2xsZWN0aW9uLmRpc3Bvc2UoKTsKCSAgICB0aGlzLl9jb2xsZWN0aW9uID0gb2JzZXJ2YWJsZS5jb2xsZWN0aW9uID0gdGhpcy5jb2xsZWN0aW9uID0gbnVsbDsKCSAgICB0aGlzLl9tYXBwZXIuZGlzcG9zZSgpOwoJICAgIHRoaXMuX21hcHBlciA9IG51bGw7CgkgICAga2IucmVsZWFzZSh0aGlzLl9maWx0ZXJzKTsKCSAgICB0aGlzLl9maWx0ZXJzID0gbnVsbDsKCSAgICB0aGlzLl9jb21wYXJhdG9yKG51bGwpOwoJICAgIHRoaXMuX2NvbXBhcmF0b3IgPSBudWxsOwoJICAgIHRoaXMuY3JlYXRlX29wdGlvbnMgPSBudWxsOwoJICAgIG9ic2VydmFibGUuY29sbGVjdGlvbiA9IG51bGw7CgkgICAga2IudXRpbHMud3JhcHBlZERlc3Ryb3kodGhpcyk7CgkgICAgcmV0dXJuICFrYi5zdGF0aXN0aWNzIHx8IGtiLnN0YXRpc3RpY3MudW5yZWdpc3RlcignQ29sbGVjdGlvbk9ic2VydmFibGUnLCB0aGlzKTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5zaGFyZU9wdGlvbnMgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgb2JzZXJ2YWJsZTsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcyk7CgkgICAgcmV0dXJuIHsKCSAgICAgIHN0b3JlOiBrYi51dGlscy53cmFwcGVkU3RvcmUob2JzZXJ2YWJsZSksCgkgICAgICBmYWN0b3J5OiBrYi51dGlscy53cmFwcGVkRmFjdG9yeShvYnNlcnZhYmxlKQoJICAgIH07CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuZmlsdGVycyA9IGZ1bmN0aW9uKGZpbHRlcnMpIHsKCSAgICBpZiAoZmlsdGVycykgewoJICAgICAgcmV0dXJuIHRoaXMuX2ZpbHRlcnMoXy5pc0FycmF5KGZpbHRlcnMpID8gZmlsdGVycyA6IFtmaWx0ZXJzXSk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiB0aGlzLl9maWx0ZXJzKFtdKTsKCSAgICB9CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuY29tcGFyYXRvciA9IGZ1bmN0aW9uKGNvbXBhcmF0b3IpIHsKCSAgICByZXR1cm4gdGhpcy5fY29tcGFyYXRvcihjb21wYXJhdG9yKTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5zb3J0QXR0cmlidXRlID0gZnVuY3Rpb24oc29ydF9hdHRyaWJ1dGUpIHsKCSAgICByZXR1cm4gdGhpcy5fY29tcGFyYXRvcihzb3J0X2F0dHJpYnV0ZSA/IHRoaXMuX2F0dHJpYnV0ZUNvbXBhcmF0b3Ioc29ydF9hdHRyaWJ1dGUpIDogbnVsbCk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUudmlld01vZGVsQnlNb2RlbCA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgdmFyIGlkX2F0dHJpYnV0ZTsKCSAgICBpZiAodGhpcy5tb2RlbHNfb25seSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIGlkX2F0dHJpYnV0ZSA9IG1vZGVsLmhhc093blByb3BlcnR5KG1vZGVsLmlkQXR0cmlidXRlKSA/IG1vZGVsLmlkQXR0cmlidXRlIDogJ2NpZCc7CgkgICAgcmV0dXJuIF8uZmluZChrYi5wZWVrKGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKHRoaXMpKSwgZnVuY3Rpb24odGVzdCkgewoJICAgICAgdmFyIF9yZWYxOwoJICAgICAgaWYgKHRlc3QgIT0gbnVsbCA/IChfcmVmMSA9IHRlc3QuX19rYikgIT0gbnVsbCA/IF9yZWYxLm9iamVjdCA6IHZvaWQgMCA6IHZvaWQgMCkgewoJICAgICAgICByZXR1cm4gdGVzdC5fX2tiLm9iamVjdFtpZF9hdHRyaWJ1dGVdID09PSBtb2RlbFtpZF9hdHRyaWJ1dGVdOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgfQoJICAgIH0pOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLmhhc1ZpZXdNb2RlbHMgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gIXRoaXMubW9kZWxzX29ubHk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuY29tcGFjdCA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBrYi5pZ25vcmUoKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgIHZhciBvYnNlcnZhYmxlOwoJICAgICAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUoX3RoaXMpOwoJICAgICAgICBpZiAoIWtiLnV0aWxzLndyYXBwZWRTdG9yZUlzT3duZWQob2JzZXJ2YWJsZSkpIHsKCSAgICAgICAgICByZXR1cm47CgkgICAgICAgIH0KCSAgICAgICAga2IudXRpbHMud3JhcHBlZFN0b3JlKG9ic2VydmFibGUpLmNsZWFyKCk7CgkgICAgICAgIHJldHVybiBfdGhpcy5fY29sbGVjdGlvbi5ub3RpZnlTdWJzY3JpYmVycyhfdGhpcy5fY29sbGVjdGlvbigpKTsKCSAgICAgIH07CgkgICAgfSkodGhpcykpOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLl9zaGFyZU9yQ3JlYXRlRmFjdG9yeSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICB2YXIgYWJzb2x1dGVfbW9kZWxzX3BhdGgsIGV4aXN0aW5nX2NyZWF0b3IsIGZhY3RvcmllcywgZmFjdG9yeTsKCSAgICBhYnNvbHV0ZV9tb2RlbHNfcGF0aCA9IGtiLnV0aWxzLnBhdGhKb2luKG9wdGlvbnMucGF0aCwgJ21vZGVscycpOwoJICAgIGZhY3RvcmllcyA9IG9wdGlvbnMuZmFjdG9yaWVzOwoJICAgIGlmICgoZmFjdG9yeSA9IG9wdGlvbnMuZmFjdG9yeSkpIHsKCSAgICAgIGlmICgoZXhpc3RpbmdfY3JlYXRvciA9IGZhY3RvcnkuY3JlYXRvckZvclBhdGgobnVsbCwgYWJzb2x1dGVfbW9kZWxzX3BhdGgpKSAmJiAoIWZhY3RvcmllcyB8fCAoZmFjdG9yaWVzWydtb2RlbHMnXSA9PT0gZXhpc3RpbmdfY3JlYXRvcikpKSB7CgkgICAgICAgIGlmICghZmFjdG9yaWVzKSB7CgkgICAgICAgICAgcmV0dXJuIGZhY3Rvcnk7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKGZhY3RvcnkuaGFzUGF0aE1hcHBpbmdzKGZhY3Rvcmllcywgb3B0aW9ucy5wYXRoKSkgewoJICAgICAgICAgIHJldHVybiBmYWN0b3J5OwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICAgIGZhY3RvcnkgPSBuZXcga2IuRmFjdG9yeShvcHRpb25zLmZhY3RvcnkpOwoJICAgIGlmIChmYWN0b3JpZXMpIHsKCSAgICAgIGZhY3RvcnkuYWRkUGF0aE1hcHBpbmdzKGZhY3Rvcmllcywgb3B0aW9ucy5wYXRoKTsKCSAgICB9CgkgICAgaWYgKCFmYWN0b3J5LmNyZWF0b3JGb3JQYXRoKG51bGwsIGFic29sdXRlX21vZGVsc19wYXRoKSkgewoJICAgICAgaWYgKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ21vZGVsc19vbmx5JykpIHsKCSAgICAgICAgaWYgKG9wdGlvbnMubW9kZWxzX29ubHkpIHsKCSAgICAgICAgICBmYWN0b3J5LmFkZFBhdGhNYXBwaW5nKGFic29sdXRlX21vZGVsc19wYXRoLCB7CgkgICAgICAgICAgICBtb2RlbHNfb25seTogdHJ1ZQoJICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIGZhY3RvcnkuYWRkUGF0aE1hcHBpbmcoYWJzb2x1dGVfbW9kZWxzX3BhdGgsIGtiLlZpZXdNb2RlbCk7CgkgICAgICAgIH0KCSAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy52aWV3X21vZGVsKSB7CgkgICAgICAgIGZhY3RvcnkuYWRkUGF0aE1hcHBpbmcoYWJzb2x1dGVfbW9kZWxzX3BhdGgsIG9wdGlvbnMudmlld19tb2RlbCk7CgkgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMuY3JlYXRlKSB7CgkgICAgICAgIGZhY3RvcnkuYWRkUGF0aE1hcHBpbmcoYWJzb2x1dGVfbW9kZWxzX3BhdGgsIHsKCSAgICAgICAgICBjcmVhdGU6IG9wdGlvbnMuY3JlYXRlCgkgICAgICAgIH0pOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgZmFjdG9yeS5hZGRQYXRoTWFwcGluZyhhYnNvbHV0ZV9tb2RlbHNfcGF0aCwga2IuVmlld01vZGVsKTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIGZhY3Rvcnk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuX29uQ29sbGVjdGlvbkNoYW5nZSA9IGZ1bmN0aW9uKGV2ZW50LCBhcmcpIHsKCSAgICByZXR1cm4ga2IuaWdub3JlKChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgY29sbGVjdGlvbiwgY29tcGFyYXRvciwgb2JzZXJ2YWJsZSwgdmlld19tb2RlbDsKCSAgICAgICAgaWYgKF90aGlzLmluX2VkaXQpIHsKCSAgICAgICAgICByZXR1cm47CgkgICAgICAgIH0KCSAgICAgICAgc3dpdGNoIChldmVudCkgewoJICAgICAgICAgIGNhc2UgJ3Jlc2V0JzoKCSAgICAgICAgICAgIGlmIChfdGhpcy5hdXRvX2NvbXBhY3QpIHsKCSAgICAgICAgICAgICAgX3RoaXMuY29tcGFjdCgpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgX3RoaXMuX2NvbGxlY3Rpb24ubm90aWZ5U3Vic2NyaWJlcnMoX3RoaXMuX2NvbGxlY3Rpb24oKSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICBjYXNlICdzb3J0JzoKCSAgICAgICAgICBjYXNlICdyZXNvcnQnOgoJICAgICAgICAgICAgX3RoaXMuX2NvbGxlY3Rpb24ubm90aWZ5U3Vic2NyaWJlcnMoX3RoaXMuX2NvbGxlY3Rpb24oKSk7CgkgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICBjYXNlICduZXcnOgoJICAgICAgICAgIGNhc2UgJ2FkZCc6CgkgICAgICAgICAgICBpZiAoIV90aGlzLl9zZWxlY3RNb2RlbChhcmcpKSB7CgkgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZShfdGhpcyk7CgkgICAgICAgICAgICBjb2xsZWN0aW9uID0gX3RoaXMuX2NvbGxlY3Rpb24oKTsKCSAgICAgICAgICAgIGlmIChjb2xsZWN0aW9uLmluZGV4T2YoYXJnKSA9PT0gLTEpIHsKCSAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKCh2aWV3X21vZGVsID0gX3RoaXMudmlld01vZGVsQnlNb2RlbChhcmcpKSkgewoJICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBfdGhpcy5pbl9lZGl0Kys7CgkgICAgICAgICAgICBpZiAoKGNvbXBhcmF0b3IgPSBfdGhpcy5fY29tcGFyYXRvcigpKSkgewoJICAgICAgICAgICAgICBvYnNlcnZhYmxlKCkucHVzaChfdGhpcy5fY3JlYXRlVmlld01vZGVsKGFyZykpOwoJICAgICAgICAgICAgICBvYnNlcnZhYmxlLnNvcnQoY29tcGFyYXRvcik7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICBvYnNlcnZhYmxlLnNwbGljZShjb2xsZWN0aW9uLmluZGV4T2YoYXJnKSwgMCwgX3RoaXMuX2NyZWF0ZVZpZXdNb2RlbChhcmcpKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIF90aGlzLmluX2VkaXQtLTsKCSAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgIGNhc2UgJ3JlbW92ZSc6CgkgICAgICAgICAgY2FzZSAnZGVzdHJveSc6CgkgICAgICAgICAgICBfdGhpcy5fb25Nb2RlbFJlbW92ZShhcmcpOwoJICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgY2FzZSAnY2hhbmdlJzoKCSAgICAgICAgICAgIGlmICghX3RoaXMuX3NlbGVjdE1vZGVsKGFyZykpIHsKCSAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9vbk1vZGVsUmVtb3ZlKGFyZyk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICB2aWV3X21vZGVsID0gX3RoaXMubW9kZWxzX29ubHkgPyBhcmcgOiBfdGhpcy52aWV3TW9kZWxCeU1vZGVsKGFyZyk7CgkgICAgICAgICAgICBpZiAoIXZpZXdfbW9kZWwpIHsKCSAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9vbkNvbGxlY3Rpb25DaGFuZ2UoJ2FkZCcsIGFyZyk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAoIShjb21wYXJhdG9yID0gX3RoaXMuX2NvbXBhcmF0b3IoKSkpIHsKCSAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgX3RoaXMuaW5fZWRpdCsrOwoJICAgICAgICAgICAga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUoX3RoaXMpLnNvcnQoY29tcGFyYXRvcik7CgkgICAgICAgICAgICBfdGhpcy5pbl9lZGl0LS07CgkgICAgICAgIH0KCSAgICAgIH07CgkgICAgfSkodGhpcykpOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLl9vbk1vZGVsUmVtb3ZlID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICB2YXIgb2JzZXJ2YWJsZSwgdmlld19tb2RlbDsKCSAgICB2aWV3X21vZGVsID0gdGhpcy5tb2RlbHNfb25seSA/IG1vZGVsIDogdGhpcy52aWV3TW9kZWxCeU1vZGVsKG1vZGVsKTsKCSAgICBpZiAoIXZpZXdfbW9kZWwpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgb2JzZXJ2YWJsZSA9IGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKHRoaXMpOwoJICAgIHRoaXMuaW5fZWRpdCsrOwoJICAgIG9ic2VydmFibGUucmVtb3ZlKHZpZXdfbW9kZWwpOwoJICAgIHJldHVybiB0aGlzLmluX2VkaXQtLTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5fb25PYnNlcnZhYmxlQXJyYXlDaGFuZ2UgPSBmdW5jdGlvbihtb2RlbHNfb3Jfdmlld19tb2RlbHMpIHsKCSAgICByZXR1cm4ga2IuaWdub3JlKChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgY29sbGVjdGlvbiwgY3VycmVudF92aWV3X21vZGVsLCBoYXNfZmlsdGVycywgbW9kZWwsIG1vZGVscywgb2JzZXJ2YWJsZSwgdmlld19tb2RlbCwgdmlld19tb2RlbHMsIF9pLCBfbGVuOwoJICAgICAgICBpZiAoX3RoaXMuaW5fZWRpdCkgewoJICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgICAgICAoX3RoaXMubW9kZWxzX29ubHkgJiYgKCFtb2RlbHNfb3Jfdmlld19tb2RlbHMubGVuZ3RoIHx8IGtiLmlzTW9kZWwobW9kZWxzX29yX3ZpZXdfbW9kZWxzWzBdKSkpIHx8ICghX3RoaXMubW9kZWxzX29ubHkgJiYgKCFtb2RlbHNfb3Jfdmlld19tb2RlbHMubGVuZ3RoIHx8IChfLmlzT2JqZWN0KG1vZGVsc19vcl92aWV3X21vZGVsc1swXSkgJiYgIWtiLmlzTW9kZWwobW9kZWxzX29yX3ZpZXdfbW9kZWxzWzBdKSkpKSB8fCBrYi5fdGhyb3dVbmV4cGVjdGVkKF90aGlzLCAnaW5jb3JyZWN0IHR5cGUgcGFzc2VkJyk7CgkgICAgICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZShfdGhpcyk7CgkgICAgICAgIGNvbGxlY3Rpb24gPSBrYi5wZWVrKF90aGlzLl9jb2xsZWN0aW9uKTsKCSAgICAgICAgaGFzX2ZpbHRlcnMgPSBrYi5wZWVrKF90aGlzLl9maWx0ZXJzKS5sZW5ndGg7CgkgICAgICAgIGlmICghY29sbGVjdGlvbikgewoJICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgICAgICB2aWV3X21vZGVscyA9IG1vZGVsc19vcl92aWV3X21vZGVsczsKCSAgICAgICAgaWYgKF90aGlzLm1vZGVsc19vbmx5KSB7CgkgICAgICAgICAgbW9kZWxzID0gXy5maWx0ZXIobW9kZWxzX29yX3ZpZXdfbW9kZWxzLCBmdW5jdGlvbihtb2RlbCkgewoJICAgICAgICAgICAgcmV0dXJuICFoYXNfZmlsdGVycyB8fCBfdGhpcy5fc2VsZWN0TW9kZWwobW9kZWwpOwoJICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICFoYXNfZmlsdGVycyB8fCAodmlld19tb2RlbHMgPSBbXSk7CgkgICAgICAgICAgbW9kZWxzID0gW107CgkgICAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBtb2RlbHNfb3Jfdmlld19tb2RlbHMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgICAgICAgIHZpZXdfbW9kZWwgPSBtb2RlbHNfb3Jfdmlld19tb2RlbHNbX2ldOwoJICAgICAgICAgICAgbW9kZWwgPSBrYi51dGlscy53cmFwcGVkT2JqZWN0KHZpZXdfbW9kZWwpOwoJICAgICAgICAgICAgaWYgKGhhc19maWx0ZXJzKSB7CgkgICAgICAgICAgICAgIGlmICghX3RoaXMuX3NlbGVjdE1vZGVsKG1vZGVsKSkgewoJICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIHZpZXdfbW9kZWxzLnB1c2godmlld19tb2RlbCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAoY3VycmVudF92aWV3X21vZGVsID0gX3RoaXMuY3JlYXRlX29wdGlvbnMuc3RvcmUuZmluZChtb2RlbCwgX3RoaXMuY3JlYXRlX29wdGlvbnMuY3JlYXRvcikpIHsKCSAgICAgICAgICAgICAgKGN1cnJlbnRfdmlld19tb2RlbC5jb25zdHJ1Y3RvciA9PT0gdmlld19tb2RlbC5jb25zdHJ1Y3RvcikgfHwga2IuX3Rocm93VW5leHBlY3RlZChfdGhpcywgJ3JlcGxhY2luZyBkaWZmZXJlbnQgdHlwZSBvZiB2aWV3IG1vZGVsJyk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBfdGhpcy5jcmVhdGVfb3B0aW9ucy5zdG9yZS5yZXRhaW4odmlld19tb2RlbCwgbW9kZWwsIF90aGlzLmNyZWF0ZV9vcHRpb25zLmNyZWF0b3IpOwoJICAgICAgICAgICAgbW9kZWxzLnB1c2gobW9kZWwpOwoJICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICBfdGhpcy5pbl9lZGl0Kys7CgkgICAgICAgIChtb2RlbHNfb3Jfdmlld19tb2RlbHMubGVuZ3RoID09PSB2aWV3X21vZGVscy5sZW5ndGgpIHx8IG9ic2VydmFibGUodmlld19tb2RlbHMpOwoJICAgICAgICBfLmlzRXF1YWwoY29sbGVjdGlvbi5tb2RlbHMsIG1vZGVscykgfHwgY29sbGVjdGlvbi5yZXNldChtb2RlbHMpOwoJICAgICAgICBfdGhpcy5pbl9lZGl0LS07CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5fYXR0cmlidXRlQ29tcGFyYXRvciA9IGZ1bmN0aW9uKHNvcnRfYXR0cmlidXRlKSB7CgkgICAgdmFyIG1vZGVsQXR0cmlidXRlQ29tcGFyZTsKCSAgICBtb2RlbEF0dHJpYnV0ZUNvbXBhcmUgPSBmdW5jdGlvbihtb2RlbF9hLCBtb2RlbF9iKSB7CgkgICAgICB2YXIgYXR0cmlidXRlX25hbWU7CgkgICAgICBhdHRyaWJ1dGVfbmFtZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoc29ydF9hdHRyaWJ1dGUpOwoJICAgICAgcmV0dXJuIGtiLmNvbXBhcmUobW9kZWxfYS5nZXQoYXR0cmlidXRlX25hbWUpLCBtb2RlbF9iLmdldChhdHRyaWJ1dGVfbmFtZSkpOwoJICAgIH07CgkgICAgcmV0dXJuICh0aGlzLm1vZGVsc19vbmx5ID8gbW9kZWxBdHRyaWJ1dGVDb21wYXJlIDogZnVuY3Rpb24obW9kZWxfYSwgbW9kZWxfYikgewoJICAgICAgcmV0dXJuIG1vZGVsQXR0cmlidXRlQ29tcGFyZShrYi51dGlscy53cmFwcGVkTW9kZWwobW9kZWxfYSksIGtiLnV0aWxzLndyYXBwZWRNb2RlbChtb2RlbF9iKSk7CgkgICAgfSk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuX2NyZWF0ZVZpZXdNb2RlbCA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgaWYgKHRoaXMubW9kZWxzX29ubHkpIHsKCSAgICAgIHJldHVybiBtb2RlbDsKCSAgICB9CgkgICAgcmV0dXJuIHRoaXMuY3JlYXRlX29wdGlvbnMuc3RvcmUucmV0YWluT3JDcmVhdGUobW9kZWwsIHRoaXMuY3JlYXRlX29wdGlvbnMpOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLl9zZWxlY3RNb2RlbCA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgdmFyIGZpbHRlciwgZmlsdGVycywgX2ksIF9sZW4sIF9yZWYxOwoJICAgIGZpbHRlcnMgPSBrYi5wZWVrKHRoaXMuX2ZpbHRlcnMpOwoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZmlsdGVycy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgZmlsdGVyID0gZmlsdGVyc1tfaV07CgkgICAgICBmaWx0ZXIgPSBrYi5wZWVrKGZpbHRlcik7CgkgICAgICBpZiAoXy5pc0Z1bmN0aW9uKGZpbHRlcikpIHsKCSAgICAgICAgaWYgKCFmaWx0ZXIobW9kZWwpKSB7CgkgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgICB9CgkgICAgICB9IGVsc2UgaWYgKF8uaXNBcnJheShmaWx0ZXIpKSB7CgkgICAgICAgIGlmIChfcmVmMSA9IG1vZGVsLmlkLCBfX2luZGV4T2YuY2FsbChmaWx0ZXIsIF9yZWYxKSA8IDApIHsKCSAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0KCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGlmIChtb2RlbC5pZCAhPT0gZmlsdGVyKSB7CgkgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiB0cnVlOwoJICB9OwoKCSAgcmV0dXJuIENvbGxlY3Rpb25PYnNlcnZhYmxlOwoKCX0pKCk7CgoJa2IuY29sbGVjdGlvbk9ic2VydmFibGUgPSBmdW5jdGlvbihjb2xsZWN0aW9uLCB2aWV3X21vZGVsLCBvcHRpb25zKSB7CgkgIHJldHVybiBuZXcga2IuQ29sbGVjdGlvbk9ic2VydmFibGUoYXJndW1lbnRzKTsKCX07CgoKLyoqKi8gfSwKLyogMiAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgl2YXIgQUxMX09STVMsIGtiLCBrZXksIGtvLCB2YWx1ZSwgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJQUxMX09STVMgPSB7CgkgICJkZWZhdWx0IjogbnVsbCwKCSAgJ2JhY2tib25lLW9ybSc6IG51bGwsCgkgICdiYWNrYm9uZS1hc3NvY2lhdGlvbnMnOiBfX3dlYnBhY2tfcmVxdWlyZV9fKDIzKSwKCSAgJ2JhY2tib25lLXJlbGF0aW9uYWwnOiBfX3dlYnBhY2tfcmVxdWlyZV9fKDI0KSwKCSAgc3VwZXJtb2RlbDogX193ZWJwYWNrX3JlcXVpcmVfXygyNSkKCX07CgoJa2Iub3JtID0gQUxMX09STVNbImRlZmF1bHQiXTsKCglmb3IgKGtleSBpbiBBTExfT1JNUykgewoJICB2YWx1ZSA9IEFMTF9PUk1TW2tleV07CgkgIGlmICh2YWx1ZSAmJiB2YWx1ZS5pc0F2YWlsYWJsZSgpKSB7CgkgICAga2Iub3JtID0gdmFsdWU7CgkgICAgYnJlYWs7CgkgIH0KCX0KCgltb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgdmFyIG9ybTsKCSAgaWYgKG9wdGlvbnMgPT0gbnVsbCkgewoJICAgIG9wdGlvbnMgPSB7fTsKCSAgfQoJICBmb3IgKGtleSBpbiBvcHRpb25zKSB7CgkgICAgdmFsdWUgPSBvcHRpb25zW2tleV07CgkgICAgc3dpdGNoIChrZXkpIHsKCSAgICAgIGNhc2UgJ29ybSc6CgkgICAgICAgIGlmIChfLmlzU3RyaW5nKHZhbHVlKSkgewoJICAgICAgICAgIGlmICghQUxMX09STVMuaGFzT3duUHJvcGVydHkodmFsdWUpKSB7CgkgICAgICAgICAgICBjb25zb2xlLmxvZygiS25vY2tiYWNrIGNvbmZpZ3VyZTogY291bGQgbm90IGZpbmQgb3JtOiAiICsgdmFsdWUgKyAiLiBBdmFpbGFibGU6ICIgKyAoXy5rZXlzKEFMTF9PUk1TKS5qb2luKCcsICcpKSk7CgkgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICB9CgkgICAgICAgICAgaWYgKChvcm0gPSBBTExfT1JNU1t2YWx1ZV0pICYmICFvcm0uaXNBdmFpbGFibGUoKSkgewoJICAgICAgICAgICAgY29uc29sZS5sb2coIktub2NrYmFjayBjb25maWd1cmU6IGNvdWxkIG5vdCBlbmFibGUgb3JtICIgKyB2YWx1ZSArICIuIE1ha2Ugc3VyZSBpdCBpcyBpbmNsdWRlZCBiZWZvcmUgS25vY2tiYWNrIik7CgkgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICB9CgkgICAgICAgICAga2Iub3JtID0gb3JtOwoJICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIGtiLm9ybSA9IHZhbHVlOwoJICAgICAgICB9CgkgICAgICAgIGJyZWFrOwoJICAgICAgZGVmYXVsdDoKCSAgICAgICAga2Jba2V5XSA9IHZhbHVlOwoJICAgIH0KCSAgfQoJfTsKCgovKioqLyB9LAovKiAzICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGtiLCBrbywgXywgX3JlZiwKCSAgX19iaW5kID0gZnVuY3Rpb24oZm4sIG1lKXsgcmV0dXJuIGZ1bmN0aW9uKCl7IHJldHVybiBmbi5hcHBseShtZSwgYXJndW1lbnRzKTsgfTsgfTsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJa2IuRXZlbnRXYXRjaGVyID0gKGZ1bmN0aW9uKCkgewoJICBFdmVudFdhdGNoZXIudXNlT3B0aW9uc09yQ3JlYXRlID0gZnVuY3Rpb24ob3B0aW9ucywgZW1pdHRlciwgb2JqLCBjYWxsYmFja19vcHRpb25zKSB7CgkgICAgaWYgKG9wdGlvbnMuZXZlbnRfd2F0Y2hlcikgewoJICAgICAgaWYgKCEob3B0aW9ucy5ldmVudF93YXRjaGVyLmVtaXR0ZXIoKSA9PT0gZW1pdHRlciB8fCAob3B0aW9ucy5ldmVudF93YXRjaGVyLm1vZGVsX3JlZiA9PT0gZW1pdHRlcikpKSB7CgkgICAgICAgIGtiLl90aHJvd1VuZXhwZWN0ZWQodGhpcywgJ2VtaXR0ZXIgbm90IG1hdGNoaW5nJyk7CgkgICAgICB9CgkgICAgICByZXR1cm4ga2IudXRpbHMud3JhcHBlZEV2ZW50V2F0Y2hlcihvYmosIG9wdGlvbnMuZXZlbnRfd2F0Y2hlcikucmVnaXN0ZXJDYWxsYmFja3Mob2JqLCBjYWxsYmFja19vcHRpb25zKTsKCSAgICB9IGVsc2UgewoJICAgICAga2IudXRpbHMud3JhcHBlZEV2ZW50V2F0Y2hlcklzT3duZWQob2JqLCB0cnVlKTsKCSAgICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkRXZlbnRXYXRjaGVyKG9iaiwgbmV3IGtiLkV2ZW50V2F0Y2hlcihlbWl0dGVyKSkucmVnaXN0ZXJDYWxsYmFja3Mob2JqLCBjYWxsYmFja19vcHRpb25zKTsKCSAgICB9CgkgIH07CgoJICBmdW5jdGlvbiBFdmVudFdhdGNoZXIoZW1pdHRlciwgb2JqLCBjYWxsYmFja19vcHRpb25zKSB7CgkgICAgdGhpcy5fdW5iaW5kQ2FsbGJhY2tzID0gX19iaW5kKHRoaXMuX3VuYmluZENhbGxiYWNrcywgdGhpcyk7CgkgICAgdGhpcy5fb25Nb2RlbFVubG9hZGVkID0gX19iaW5kKHRoaXMuX29uTW9kZWxVbmxvYWRlZCwgdGhpcyk7CgkgICAgdGhpcy5fb25Nb2RlbExvYWRlZCA9IF9fYmluZCh0aGlzLl9vbk1vZGVsTG9hZGVkLCB0aGlzKTsKCSAgICB0aGlzLl9fa2IgfHwgKHRoaXMuX19rYiA9IHt9KTsKCSAgICB0aGlzLl9fa2IuY2FsbGJhY2tzID0ge307CgkgICAgdGhpcy5lZSA9IG51bGw7CgkgICAgaWYgKGNhbGxiYWNrX29wdGlvbnMpIHsKCSAgICAgIHRoaXMucmVnaXN0ZXJDYWxsYmFja3Mob2JqLCBjYWxsYmFja19vcHRpb25zKTsKCSAgICB9CgkgICAgaWYgKGVtaXR0ZXIpIHsKCSAgICAgIHRoaXMuZW1pdHRlcihlbWl0dGVyKTsKCSAgICB9CgkgIH0KCgkgIEV2ZW50V2F0Y2hlci5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIHRoaXMuZW1pdHRlcihudWxsKTsKCSAgICB0aGlzLl9fa2IuY2FsbGJhY2tzID0gbnVsbDsKCSAgICByZXR1cm4ga2IudXRpbHMud3JhcHBlZERlc3Ryb3kodGhpcyk7CgkgIH07CgoJICBFdmVudFdhdGNoZXIucHJvdG90eXBlLmVtaXR0ZXIgPSBmdW5jdGlvbihuZXdfZW1pdHRlcikgewoJICAgIGlmICgoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgfHwgKHRoaXMuZWUgPT09IG5ld19lbWl0dGVyKSkgewoJICAgICAgcmV0dXJuIHRoaXMuZWU7CgkgICAgfQoJICAgIGlmICh0aGlzLm1vZGVsX3JlZikgewoJICAgICAgdGhpcy5tb2RlbF9yZWYudW5iaW5kKCdsb2FkZWQnLCB0aGlzLl9vbk1vZGVsTG9hZGVkKTsKCSAgICAgIHRoaXMubW9kZWxfcmVmLnVuYmluZCgndW5sb2FkZWQnLCB0aGlzLl9vbk1vZGVsVW5sb2FkZWQpOwoJICAgICAgdGhpcy5tb2RlbF9yZWYucmVsZWFzZSgpOwoJICAgICAgdGhpcy5tb2RlbF9yZWYgPSBudWxsOwoJICAgIH0KCSAgICBpZiAoa2IuQmFja2JvbmUgJiYga2IuQmFja2JvbmUuTW9kZWxSZWYgJiYgKG5ld19lbWl0dGVyIGluc3RhbmNlb2Yga2IuQmFja2JvbmUuTW9kZWxSZWYpKSB7CgkgICAgICB0aGlzLm1vZGVsX3JlZiA9IG5ld19lbWl0dGVyOwoJICAgICAgdGhpcy5tb2RlbF9yZWYucmV0YWluKCk7CgkgICAgICB0aGlzLm1vZGVsX3JlZi5iaW5kKCdsb2FkZWQnLCB0aGlzLl9vbk1vZGVsTG9hZGVkKTsKCSAgICAgIHRoaXMubW9kZWxfcmVmLmJpbmQoJ3VubG9hZGVkJywgdGhpcy5fb25Nb2RlbFVubG9hZGVkKTsKCSAgICAgIG5ld19lbWl0dGVyID0gdGhpcy5tb2RlbF9yZWYubW9kZWwoKSB8fCBudWxsOwoJICAgIH0gZWxzZSB7CgkgICAgICBkZWxldGUgdGhpcy5tb2RlbF9yZWY7CgkgICAgfQoJICAgIGlmICh0aGlzLmVlICE9PSBuZXdfZW1pdHRlcikgewoJICAgICAgaWYgKG5ld19lbWl0dGVyKSB7CgkgICAgICAgIHRoaXMuX29uTW9kZWxMb2FkZWQobmV3X2VtaXR0ZXIpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgdGhpcy5fb25Nb2RlbFVubG9hZGVkKHRoaXMuZWUpOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gbmV3X2VtaXR0ZXI7CgkgIH07CgoJICBFdmVudFdhdGNoZXIucHJvdG90eXBlLnJlZ2lzdGVyQ2FsbGJhY2tzID0gZnVuY3Rpb24ob2JqLCBjYWxsYmFja19pbmZvKSB7CgkgICAgdmFyIGV2ZW50X25hbWUsIGV2ZW50X25hbWVzLCBtb2RlbCwgX2ZuLCBfaSwgX2xlbjsKCSAgICBvYmogfHwga2IuX3Rocm93TWlzc2luZyh0aGlzLCAnb2JqJyk7CgkgICAgY2FsbGJhY2tfaW5mbyB8fCBrYi5fdGhyb3dNaXNzaW5nKHRoaXMsICdjYWxsYmFja19pbmZvJyk7CgkgICAgZXZlbnRfbmFtZXMgPSBjYWxsYmFja19pbmZvLmV2ZW50X3NlbGVjdG9yID8gY2FsbGJhY2tfaW5mby5ldmVudF9zZWxlY3Rvci5zcGxpdCgnICcpIDogWydjaGFuZ2UnXTsKCSAgICBtb2RlbCA9IHRoaXMuZWU7CgkgICAgX2ZuID0gKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oZXZlbnRfbmFtZSkgewoJICAgICAgICB2YXIgY2FsbGJhY2tzLCBpbmZvOwoJICAgICAgICBpZiAoIShjYWxsYmFja3MgPSBfdGhpcy5fX2tiLmNhbGxiYWNrc1tldmVudF9uYW1lXSkpIHsKCSAgICAgICAgICBjYWxsYmFja3MgPSBfdGhpcy5fX2tiLmNhbGxiYWNrc1tldmVudF9uYW1lXSA9IHsKCSAgICAgICAgICAgIG1vZGVsOiBudWxsLAoJICAgICAgICAgICAgbGlzdDogW10sCgkgICAgICAgICAgICBmbjogZnVuY3Rpb24obW9kZWwpIHsKCSAgICAgICAgICAgICAgdmFyIGluZm8sIF9qLCBfbGVuMSwgX3JlZjE7CgkgICAgICAgICAgICAgIF9yZWYxID0gY2FsbGJhY2tzLmxpc3Q7CgkgICAgICAgICAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IF9yZWYxLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewoJICAgICAgICAgICAgICAgIGluZm8gPSBfcmVmMVtfal07CgkgICAgICAgICAgICAgICAgaWYgKCFpbmZvLnVwZGF0ZSkgewoJICAgICAgICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGlmIChtb2RlbCAmJiBpbmZvLmtleSAmJiAobW9kZWwuaGFzQ2hhbmdlZCAmJiAhbW9kZWwuaGFzQ2hhbmdlZChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGluZm8ua2V5KSkpKSB7CgkgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgIWtiLnN0YXRpc3RpY3MgfHwga2Iuc3RhdGlzdGljcy5hZGRNb2RlbEV2ZW50KHsKCSAgICAgICAgICAgICAgICAgIG5hbWU6IGV2ZW50X25hbWUsCgkgICAgICAgICAgICAgICAgICBtb2RlbDogbW9kZWwsCgkgICAgICAgICAgICAgICAgICBrZXk6IGluZm8ua2V5LAoJICAgICAgICAgICAgICAgICAgcGF0aDogaW5mby5wYXRoCgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgaW5mby51cGRhdGUoKTsKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICB9OwoJICAgICAgICB9CgkgICAgICAgIGNhbGxiYWNrcy5saXN0LnB1c2goaW5mbyA9IF8uZGVmYXVsdHMoewoJICAgICAgICAgIG9iajogb2JqCgkgICAgICAgIH0sIGNhbGxiYWNrX2luZm8pKTsKCSAgICAgICAgaWYgKG1vZGVsKSB7CgkgICAgICAgICAgcmV0dXJuIF90aGlzLl9vbk1vZGVsTG9hZGVkKG1vZGVsKTsKCSAgICAgICAgfQoJICAgICAgfTsKCSAgICB9KSh0aGlzKTsKCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGV2ZW50X25hbWVzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBldmVudF9uYW1lID0gZXZlbnRfbmFtZXNbX2ldOwoJICAgICAgaWYgKCFldmVudF9uYW1lKSB7CgkgICAgICAgIGNvbnRpbnVlOwoJICAgICAgfQoJICAgICAgX2ZuKGV2ZW50X25hbWUpOwoJICAgIH0KCSAgICByZXR1cm4gdGhpczsKCSAgfTsKCgkgIEV2ZW50V2F0Y2hlci5wcm90b3R5cGUucmVsZWFzZUNhbGxiYWNrcyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBjYWxsYmFja3MsIGV2ZW50X25hbWUsIF9yZWYxOwoJICAgIHRoaXMuZWUgPSBudWxsOwoJICAgIF9yZWYxID0gdGhpcy5fX2tiLmNhbGxiYWNrczsKCSAgICBmb3IgKGV2ZW50X25hbWUgaW4gX3JlZjEpIHsKCSAgICAgIGNhbGxiYWNrcyA9IF9yZWYxW2V2ZW50X25hbWVdOwoJICAgICAgdGhpcy5fdW5iaW5kQ2FsbGJhY2tzKGV2ZW50X25hbWUsIGNhbGxiYWNrcywga2Iud2FzUmVsZWFzZWQob2JqKSk7CgkgICAgfQoJICAgIHJldHVybiBkZWxldGUgdGhpcy5fX2tiLmNhbGxiYWNrczsKCSAgfTsKCgkgIEV2ZW50V2F0Y2hlci5wcm90b3R5cGUuX29uTW9kZWxMb2FkZWQgPSBmdW5jdGlvbihtb2RlbCkgewoJICAgIHZhciBjYWxsYmFja3MsIGV2ZW50X25hbWUsIGluZm8sIF9pLCBfbGVuLCBfcmVmMSwgX3JlZjIsIF9yZWYzOwoJICAgIHRoaXMuZWUgPSBtb2RlbDsKCSAgICBfcmVmMSA9IHRoaXMuX19rYi5jYWxsYmFja3M7CgkgICAgZm9yIChldmVudF9uYW1lIGluIF9yZWYxKSB7CgkgICAgICBjYWxsYmFja3MgPSBfcmVmMVtldmVudF9uYW1lXTsKCSAgICAgIGlmIChjYWxsYmFja3MubW9kZWwgJiYgKGNhbGxiYWNrcy5tb2RlbCAhPT0gbW9kZWwpKSB7CgkgICAgICAgIHRoaXMuX3VuYmluZENhbGxiYWNrcyhldmVudF9uYW1lLCBjYWxsYmFja3MsIHRydWUpOwoJICAgICAgfQoJICAgICAgaWYgKCFjYWxsYmFja3MubW9kZWwpIHsKCSAgICAgICAgY2FsbGJhY2tzLm1vZGVsID0gbW9kZWw7CgkgICAgICAgIG1vZGVsLmJpbmQoZXZlbnRfbmFtZSwgY2FsbGJhY2tzLmZuKTsKCSAgICAgIH0KCSAgICAgIF9yZWYyID0gY2FsbGJhY2tzLmxpc3Q7CgkgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYyLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgIGluZm8gPSBfcmVmMltfaV07CgkgICAgICAgIGluZm8udW5iaW5kX2ZuIHx8IChpbmZvLnVuYmluZF9mbiA9IChfcmVmMyA9IGtiLm9ybSkgIT0gbnVsbCA/IF9yZWYzLmJpbmQobW9kZWwsIGluZm8ua2V5LCBpbmZvLnVwZGF0ZSwgaW5mby5wYXRoKSA6IHZvaWQgMCk7CgkgICAgICAgIGlmIChpbmZvLmVtaXR0ZXIpIHsKCSAgICAgICAgICBpbmZvLmVtaXR0ZXIobW9kZWwpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICB9OwoKCSAgRXZlbnRXYXRjaGVyLnByb3RvdHlwZS5fb25Nb2RlbFVubG9hZGVkID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICB2YXIgY2FsbGJhY2tzLCBldmVudF9uYW1lLCBfcmVmMTsKCSAgICBpZiAodGhpcy5lZSAhPT0gbW9kZWwpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgdGhpcy5lZSA9IG51bGw7CgkgICAgX3JlZjEgPSB0aGlzLl9fa2IuY2FsbGJhY2tzOwoJICAgIGZvciAoZXZlbnRfbmFtZSBpbiBfcmVmMSkgewoJICAgICAgY2FsbGJhY2tzID0gX3JlZjFbZXZlbnRfbmFtZV07CgkgICAgICB0aGlzLl91bmJpbmRDYWxsYmFja3MoZXZlbnRfbmFtZSwgY2FsbGJhY2tzKTsKCSAgICB9CgkgIH07CgoJICBFdmVudFdhdGNoZXIucHJvdG90eXBlLl91bmJpbmRDYWxsYmFja3MgPSBmdW5jdGlvbihldmVudF9uYW1lLCBjYWxsYmFja3MsIHNraXBfZW1pdHRlcikgewoJICAgIHZhciBpbmZvLCBfaSwgX2xlbiwgX3JlZjE7CgkgICAgaWYgKGNhbGxiYWNrcy5tb2RlbCkgewoJICAgICAgY2FsbGJhY2tzLm1vZGVsLnVuYmluZChldmVudF9uYW1lLCBjYWxsYmFja3MuZm4pOwoJICAgICAgY2FsbGJhY2tzLm1vZGVsID0gbnVsbDsKCSAgICB9CgkgICAgX3JlZjEgPSBjYWxsYmFja3MubGlzdDsKCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYxLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBpbmZvID0gX3JlZjFbX2ldOwoJICAgICAgaWYgKGluZm8udW5iaW5kX2ZuKSB7CgkgICAgICAgIGluZm8udW5iaW5kX2ZuKCk7CgkgICAgICAgIGluZm8udW5iaW5kX2ZuID0gbnVsbDsKCSAgICAgIH0KCSAgICAgIGlmIChpbmZvLmVtaXR0ZXIgJiYgIXNraXBfZW1pdHRlciAmJiAha2Iud2FzUmVsZWFzZWQoaW5mby5vYmopKSB7CgkgICAgICAgIGluZm8uZW1pdHRlcihudWxsKTsKCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICByZXR1cm4gRXZlbnRXYXRjaGVyOwoKCX0pKCk7CgoJa2IuZW1pdHRlck9ic2VydmFibGUgPSBmdW5jdGlvbihlbWl0dGVyLCBvYnNlcnZhYmxlKSB7CgkgIHJldHVybiBuZXcga2IuRXZlbnRXYXRjaGVyKGVtaXR0ZXIsIG9ic2VydmFibGUpOwoJfTsKCgovKioqLyB9LAovKiA0ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGtiLCBfOwoKCV8gPSAoa2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpKS5fOwoKCWtiLkZhY3RvcnkgPSAoZnVuY3Rpb24oKSB7CgkgIEZhY3RvcnkudXNlT3B0aW9uc09yQ3JlYXRlID0gZnVuY3Rpb24ob3B0aW9ucywgb2JqLCBvd25lcl9wYXRoKSB7CgkgICAgdmFyIGZhY3Rvcnk7CgkgICAgaWYgKG9wdGlvbnMuZmFjdG9yeSAmJiAoIW9wdGlvbnMuZmFjdG9yaWVzIHx8IChvcHRpb25zLmZhY3RvcmllcyAmJiBvcHRpb25zLmZhY3RvcnkuaGFzUGF0aE1hcHBpbmdzKG9wdGlvbnMuZmFjdG9yaWVzLCBvd25lcl9wYXRoKSkpKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMud3JhcHBlZEZhY3Rvcnkob2JqLCBvcHRpb25zLmZhY3RvcnkpOwoJICAgIH0KCSAgICBmYWN0b3J5ID0ga2IudXRpbHMud3JhcHBlZEZhY3Rvcnkob2JqLCBuZXcga2IuRmFjdG9yeShvcHRpb25zLmZhY3RvcnkpKTsKCSAgICBpZiAob3B0aW9ucy5mYWN0b3JpZXMpIHsKCSAgICAgIGZhY3RvcnkuYWRkUGF0aE1hcHBpbmdzKG9wdGlvbnMuZmFjdG9yaWVzLCBvd25lcl9wYXRoKTsKCSAgICB9CgkgICAgcmV0dXJuIGZhY3Rvcnk7CgkgIH07CgoJICBmdW5jdGlvbiBGYWN0b3J5KHBhcmVudF9mYWN0b3J5KSB7CgkgICAgdGhpcy5wYXRocyA9IHt9OwoJICAgIGlmIChwYXJlbnRfZmFjdG9yeSkgewoJICAgICAgdGhpcy5wYXJlbnRfZmFjdG9yeSA9IHBhcmVudF9mYWN0b3J5OwoJICAgIH0KCSAgfQoKCSAgRmFjdG9yeS5wcm90b3R5cGUuaGFzUGF0aCA9IGZ1bmN0aW9uKHBhdGgpIHsKCSAgICB2YXIgX3JlZjsKCSAgICByZXR1cm4gdGhpcy5wYXRocy5oYXNPd25Qcm9wZXJ0eShwYXRoKSB8fCAoKF9yZWYgPSB0aGlzLnBhcmVudF9mYWN0b3J5KSAhPSBudWxsID8gX3JlZi5oYXNQYXRoKHBhdGgpIDogdm9pZCAwKTsKCSAgfTsKCgkgIEZhY3RvcnkucHJvdG90eXBlLmFkZFBhdGhNYXBwaW5nID0gZnVuY3Rpb24ocGF0aCwgY3JlYXRlX2luZm8pIHsKCSAgICByZXR1cm4gdGhpcy5wYXRoc1twYXRoXSA9IGNyZWF0ZV9pbmZvOwoJICB9OwoKCSAgRmFjdG9yeS5wcm90b3R5cGUuYWRkUGF0aE1hcHBpbmdzID0gZnVuY3Rpb24oZmFjdG9yaWVzLCBvd25lcl9wYXRoKSB7CgkgICAgdmFyIGNyZWF0ZV9pbmZvLCBwYXRoOwoJICAgIGZvciAocGF0aCBpbiBmYWN0b3JpZXMpIHsKCSAgICAgIGNyZWF0ZV9pbmZvID0gZmFjdG9yaWVzW3BhdGhdOwoJICAgICAgdGhpcy5wYXRoc1trYi51dGlscy5wYXRoSm9pbihvd25lcl9wYXRoLCBwYXRoKV0gPSBjcmVhdGVfaW5mbzsKCSAgICB9CgkgIH07CgoJICBGYWN0b3J5LnByb3RvdHlwZS5oYXNQYXRoTWFwcGluZ3MgPSBmdW5jdGlvbihmYWN0b3JpZXMsIG93bmVyX3BhdGgpIHsKCSAgICB2YXIgYWxsX2V4aXN0LCBjcmVhdG9yLCBleGlzdGluZ19jcmVhdG9yLCBwYXRoOwoJICAgIGFsbF9leGlzdCA9IHRydWU7CgkgICAgZm9yIChwYXRoIGluIGZhY3RvcmllcykgewoJICAgICAgY3JlYXRvciA9IGZhY3Rvcmllc1twYXRoXTsKCSAgICAgIGFsbF9leGlzdCAmPSAoZXhpc3RpbmdfY3JlYXRvciA9IHRoaXMuY3JlYXRvckZvclBhdGgobnVsbCwga2IudXRpbHMucGF0aEpvaW4ob3duZXJfcGF0aCwgcGF0aCkpKSAmJiAoY3JlYXRvciA9PT0gZXhpc3RpbmdfY3JlYXRvcik7CgkgICAgfQoJICAgIHJldHVybiBhbGxfZXhpc3Q7CgkgIH07CgoJICBGYWN0b3J5LnByb3RvdHlwZS5jcmVhdG9yRm9yUGF0aCA9IGZ1bmN0aW9uKG9iaiwgcGF0aCkgewoJICAgIHZhciBjcmVhdG9yLCBfcmVmOwoJICAgIGlmIChjcmVhdG9yID0gdGhpcy5wYXRoc1twYXRoXSkgewoJICAgICAgcmV0dXJuIChjcmVhdG9yLnZpZXdfbW9kZWwgPyBjcmVhdG9yLnZpZXdfbW9kZWwgOiBjcmVhdG9yKTsKCSAgICB9CgkgICAgaWYgKGNyZWF0b3IgPSAoX3JlZiA9IHRoaXMucGFyZW50X2ZhY3RvcnkpICE9IG51bGwgPyBfcmVmLmNyZWF0b3JGb3JQYXRoKG9iaiwgcGF0aCkgOiB2b2lkIDApIHsKCSAgICAgIHJldHVybiBjcmVhdG9yOwoJICAgIH0KCSAgICByZXR1cm4gbnVsbDsKCSAgfTsKCgkgIHJldHVybiBGYWN0b3J5OwoKCX0pKCk7CgoKLyoqKi8gfSwKLyogNSAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkvKiBXRUJQQUNLIFZBUiBJTkpFQ1RJT04gKi8oZnVuY3Rpb24oZ2xvYmFsKSB7CgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgJCwga2IsIGtvLCBvblJlYWR5LCB3aW5kb3csIF8sIF9rb19hcHBseUJpbmRpbmdzLCBfcmVmOwoKCXdpbmRvdyA9IHdpbmRvdyAhPSBudWxsID8gd2luZG93IDogZ2xvYmFsOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbywgJCA9IF9yZWYuJDsKCglrYi5SRUNVU0lWRV9BVVRPX0lOSkVDVCA9IHRydWU7CgoJa28uYmluZGluZ0hhbmRsZXJzWydpbmplY3QnXSA9IHsKCSAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZV9hY2Nlc3NvciwgYWxsX2JpbmRpbmdzX2FjY2Vzc29yLCB2aWV3X21vZGVsKSB7CgkgICAgcmV0dXJuIGtiLkluamVjdC5pbmplY3Qoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZV9hY2Nlc3NvcigpKSwgdmlld19tb2RlbCwgZWxlbWVudCwgdmFsdWVfYWNjZXNzb3IsIGFsbF9iaW5kaW5nc19hY2Nlc3Nvcik7CgkgIH0KCX07CgoJa2IuSW5qZWN0ID0gKGZ1bmN0aW9uKCkgewoJICBmdW5jdGlvbiBJbmplY3QoKSB7fQoKCSAgSW5qZWN0LmluamVjdCA9IGZ1bmN0aW9uKGRhdGEsIHZpZXdfbW9kZWwsIGVsZW1lbnQsIHZhbHVlX2FjY2Vzc29yLCBhbGxfYmluZGluZ3NfYWNjZXNzb3IsIG5lc3RlZCkgewoJICAgIHZhciBpbmplY3Q7CgkgICAgaW5qZWN0ID0gZnVuY3Rpb24oZGF0YSkgewoJICAgICAgdmFyIGtleSwgdGFyZ2V0LCB2YWx1ZTsKCSAgICAgIGlmIChfLmlzRnVuY3Rpb24oZGF0YSkpIHsKCSAgICAgICAgdmlld19tb2RlbCA9IG5ldyBkYXRhKHZpZXdfbW9kZWwsIGVsZW1lbnQsIHZhbHVlX2FjY2Vzc29yLCBhbGxfYmluZGluZ3NfYWNjZXNzb3IpOwoJICAgICAgICBrYi5yZWxlYXNlT25Ob2RlUmVtb3ZlKHZpZXdfbW9kZWwsIGVsZW1lbnQpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgaWYgKGRhdGEudmlld19tb2RlbCkgewoJICAgICAgICAgIHZpZXdfbW9kZWwgPSBuZXcgZGF0YS52aWV3X21vZGVsKHZpZXdfbW9kZWwsIGVsZW1lbnQsIHZhbHVlX2FjY2Vzc29yLCBhbGxfYmluZGluZ3NfYWNjZXNzb3IpOwoJICAgICAgICAgIGtiLnJlbGVhc2VPbk5vZGVSZW1vdmUodmlld19tb2RlbCwgZWxlbWVudCk7CgkgICAgICAgIH0KCSAgICAgICAgZm9yIChrZXkgaW4gZGF0YSkgewoJICAgICAgICAgIHZhbHVlID0gZGF0YVtrZXldOwoJICAgICAgICAgIGlmIChrZXkgPT09ICd2aWV3X21vZGVsJykgewoJICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgICAgfQoJICAgICAgICAgIGlmIChrZXkgPT09ICdjcmVhdGUnKSB7CgkgICAgICAgICAgICB2YWx1ZSh2aWV3X21vZGVsLCBlbGVtZW50LCB2YWx1ZV9hY2Nlc3NvciwgYWxsX2JpbmRpbmdzX2FjY2Vzc29yKTsKCSAgICAgICAgICB9IGVsc2UgaWYgKF8uaXNPYmplY3QodmFsdWUpICYmICFfLmlzRnVuY3Rpb24odmFsdWUpKSB7CgkgICAgICAgICAgICB0YXJnZXQgPSBuZXN0ZWQgfHwgKHZhbHVlICYmIHZhbHVlLmNyZWF0ZSkgPyB7fSA6IHZpZXdfbW9kZWw7CgkgICAgICAgICAgICB2aWV3X21vZGVsW2tleV0gPSBrYi5JbmplY3QuaW5qZWN0KHZhbHVlLCB0YXJnZXQsIGVsZW1lbnQsIHZhbHVlX2FjY2Vzc29yLCBhbGxfYmluZGluZ3NfYWNjZXNzb3IsIHRydWUpOwoJICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICB2aWV3X21vZGVsW2tleV0gPSB2YWx1ZTsKCSAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICAgIHJldHVybiB2aWV3X21vZGVsOwoJICAgIH07CgkgICAgaWYgKG5lc3RlZCkgewoJICAgICAgcmV0dXJuIGluamVjdChkYXRhKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLmlnbm9yZShmdW5jdGlvbigpIHsKCSAgICAgICAgcmV0dXJuIGluamVjdChkYXRhKTsKCSAgICAgIH0pOwoJICAgIH0KCSAgfTsKCgkgIEluamVjdC5pbmplY3RWaWV3TW9kZWxzID0gZnVuY3Rpb24ocm9vdCkgewoJICAgIHZhciBhZnRlckJpbmRpbmcsIGFwcCwgYmVmb3JlQmluZGluZywgZGF0YSwgZXhwcmVzc2lvbiwgZmluZEVsZW1lbnRzLCBvcHRpb25zLCByZXN1bHRzLCBfaSwgX2xlbjsKCSAgICByZXN1bHRzID0gW107CgkgICAgZmluZEVsZW1lbnRzID0gZnVuY3Rpb24oZWwpIHsKCSAgICAgIHZhciBhdHRyLCBjaGlsZF9lbCwgX2ksIF9sZW4sIF9yZWYxOwoJICAgICAgaWYgKCFlbC5fX2tiX2luamVjdGVkKSB7CgkgICAgICAgIGlmIChlbC5hdHRyaWJ1dGVzICYmIChhdHRyID0gXy5maW5kKGVsLmF0dHJpYnV0ZXMsIGZ1bmN0aW9uKGF0dHIpIHsKCSAgICAgICAgICByZXR1cm4gYXR0ci5uYW1lID09PSAna2ItaW5qZWN0JzsKCSAgICAgICAgfSkpKSB7CgkgICAgICAgICAgZWwuX19rYl9pbmplY3RlZCA9IHRydWU7CgkgICAgICAgICAgcmVzdWx0cy5wdXNoKHsKCSAgICAgICAgICAgIGVsOiBlbCwKCSAgICAgICAgICAgIHZpZXdfbW9kZWw6IHt9LAoJICAgICAgICAgICAgYmluZGluZzogYXR0ci52YWx1ZQoJICAgICAgICAgIH0pOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgICBfcmVmMSA9IGVsLmNoaWxkTm9kZXM7CgkgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYxLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgIGNoaWxkX2VsID0gX3JlZjFbX2ldOwoJICAgICAgICBmaW5kRWxlbWVudHMoY2hpbGRfZWwpOwoJICAgICAgfQoJICAgIH07CgkgICAgaWYgKCFyb290ICYmICh3aW5kb3cgIT0gbnVsbCA/IHdpbmRvdy5kb2N1bWVudCA6IHZvaWQgMCkpIHsKCSAgICAgIHJvb3QgPSB3aW5kb3cuZG9jdW1lbnQ7CgkgICAgfQoJICAgIGZpbmRFbGVtZW50cyhyb290KTsKCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IHJlc3VsdHMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgIGFwcCA9IHJlc3VsdHNbX2ldOwoJICAgICAgaWYgKGV4cHJlc3Npb24gPSBhcHAuYmluZGluZykgewoJICAgICAgICAoZXhwcmVzc2lvbi5zZWFyY2goL1s6XS8pIDwgMCkgfHwgKGV4cHJlc3Npb24gPSAieyIgKyBleHByZXNzaW9uICsgIn0iKTsKCSAgICAgICAgZGF0YSA9IChuZXcgRnVuY3Rpb24oIiIsICJyZXR1cm4gKCAiICsgZXhwcmVzc2lvbiArICIgKSIpKSgpOwoJICAgICAgICBkYXRhIHx8IChkYXRhID0ge30pOwoJICAgICAgICAoIWRhdGEub3B0aW9ucykgfHwgKG9wdGlvbnMgPSBkYXRhLm9wdGlvbnMsIGRlbGV0ZSBkYXRhLm9wdGlvbnMpOwoJICAgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgICAgICBhcHAudmlld19tb2RlbCA9IGtiLkluamVjdC5pbmplY3QoZGF0YSwgYXBwLnZpZXdfbW9kZWwsIGFwcC5lbCwgbnVsbCwgbnVsbCwgdHJ1ZSk7CgkgICAgICAgIGFmdGVyQmluZGluZyA9IGFwcC52aWV3X21vZGVsLmFmdGVyQmluZGluZyB8fCBvcHRpb25zLmFmdGVyQmluZGluZzsKCSAgICAgICAgYmVmb3JlQmluZGluZyA9IGFwcC52aWV3X21vZGVsLmJlZm9yZUJpbmRpbmcgfHwgb3B0aW9ucy5iZWZvcmVCaW5kaW5nOwoJICAgICAgfQoJICAgICAgaWYgKGJlZm9yZUJpbmRpbmcpIHsKCSAgICAgICAgYmVmb3JlQmluZGluZy5jYWxsKGFwcC52aWV3X21vZGVsLCBhcHAudmlld19tb2RlbCwgYXBwLmVsLCBvcHRpb25zKTsKCSAgICAgIH0KCSAgICAgIGtiLmFwcGx5QmluZGluZ3MoYXBwLnZpZXdfbW9kZWwsIGFwcC5lbCwgb3B0aW9ucyk7CgkgICAgICBpZiAoYWZ0ZXJCaW5kaW5nKSB7CgkgICAgICAgIGFmdGVyQmluZGluZy5jYWxsKGFwcC52aWV3X21vZGVsLCBhcHAudmlld19tb2RlbCwgYXBwLmVsLCBvcHRpb25zKTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdHM7CgkgIH07CgoJICByZXR1cm4gSW5qZWN0OwoKCX0pKCk7CgoJX2tvX2FwcGx5QmluZGluZ3MgPSBrby5hcHBseUJpbmRpbmdzOwoKCWtvLmFwcGx5QmluZGluZ3MgPSBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KSB7CgkgIHZhciByZXN1bHRzOwoJICByZXN1bHRzID0ga2IuUkVDVVNJVkVfQVVUT19JTkpFQ1QgPyBrYi5pbmplY3RWaWV3TW9kZWxzKGVsZW1lbnQpIDogW107CgkgIGlmICghcmVzdWx0cy5sZW5ndGgpIHsKCSAgICByZXR1cm4gX2tvX2FwcGx5QmluZGluZ3MuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgfQoJfTsKCglrYi5pbmplY3RWaWV3TW9kZWxzID0ga2IuSW5qZWN0LmluamVjdFZpZXdNb2RlbHM7CgoJaWYgKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnQgIT09IG51bGwpIHsKCSAgaWYgKCQpIHsKCSAgICAkKGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIGtiLmluamVjdFZpZXdNb2RlbHMoKTsKCSAgICB9KTsKCSAgfSBlbHNlIHsKCSAgICAob25SZWFkeSA9IGZ1bmN0aW9uKCkgewoJICAgICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgIT09ICdjb21wbGV0ZScpIHsKCSAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQob25SZWFkeSwgMCk7CgkgICAgICB9CgkgICAgICByZXR1cm4ga2IuaW5qZWN0Vmlld01vZGVscygpOwoJICAgIH0pKCk7CgkgIH0KCX0KCQoJLyogV0VCUEFDSyBWQVIgSU5KRUNUSU9OICovfS5jYWxsKGV4cG9ydHMsIChmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXM7IH0oKSkpKQoKLyoqKi8gfSwKLyogNiAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkvKiBXRUJQQUNLIFZBUiBJTkpFQ1RJT04gKi8oZnVuY3Rpb24oZ2xvYmFsKSB7CgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgQmFja2JvbmUsIExJRkVDWUNMRV9NRVRIT0RTLCBrYiwga28sIHdpbmRvdywgXzsKCgl3aW5kb3cgPSB3aW5kb3cgIT0gbnVsbCA/IHdpbmRvdyA6IGdsb2JhbDsKCglrbyA9IF9fd2VicGFja19yZXF1aXJlX18oMzIpOwoKCUxJRkVDWUNMRV9NRVRIT0RTID0gWydyZWxlYXNlJywgJ2Rlc3Ryb3knLCAnZGlzcG9zZSddOwoKCW1vZHVsZS5leHBvcnRzID0ga2IgPSAoZnVuY3Rpb24oKSB7CgkgIHZhciBfcmVmOwoKCSAgZnVuY3Rpb24ga2IoKSB7fQoKCSAga2IuVkVSU0lPTiA9ICcwLjIwLjQnOwoKCSAga2IuVFlQRV9VTktOT1dOID0gMDsKCgkgIGtiLlRZUEVfU0lNUExFID0gMTsKCgkgIGtiLlRZUEVfQVJSQVkgPSAyOwoKCSAga2IuVFlQRV9NT0RFTCA9IDM7CgoJICBrYi5UWVBFX0NPTExFQ1RJT04gPSA0OwoKCSAga2Iud2FzUmVsZWFzZWQgPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gIW9iaiB8fCBvYmouX19rYl9yZWxlYXNlZDsKCSAgfTsKCgkgIGtiLmlzUmVsZWFzZWFibGUgPSBmdW5jdGlvbihvYmosIGRlcHRoKSB7CgkgICAgdmFyIGtleSwgbWV0aG9kLCB2YWx1ZSwgX2ksIF9sZW47CgkgICAgaWYgKGRlcHRoID09IG51bGwpIHsKCSAgICAgIGRlcHRoID0gMDsKCSAgICB9CgkgICAgaWYgKCghb2JqIHx8IChvYmogIT09IE9iamVjdChvYmopKSkgfHwgb2JqLl9fa2JfcmVsZWFzZWQpIHsKCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9CgkgICAgaWYgKGtvLmlzT2JzZXJ2YWJsZShvYmopIHx8IChvYmogaW5zdGFuY2VvZiBrYi5WaWV3TW9kZWwpKSB7CgkgICAgICByZXR1cm4gdHJ1ZTsKCSAgICB9CgkgICAgaWYgKCh0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSB8fCBrYi5pc01vZGVsKG9iaikgfHwga2IuaXNDb2xsZWN0aW9uKG9iaikpIHsKCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9CgkgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBMSUZFQ1lDTEVfTUVUSE9EUy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgbWV0aG9kID0gTElGRUNZQ0xFX01FVEhPRFNbX2ldOwoJICAgICAgaWYgKHR5cGVvZiBvYmpbbWV0aG9kXSA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICByZXR1cm4gdHJ1ZTsKCSAgICAgIH0KCSAgICB9CgkgICAgaWYgKGRlcHRoID4gMCkgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICBmb3IgKGtleSBpbiBvYmopIHsKCSAgICAgIHZhbHVlID0gb2JqW2tleV07CgkgICAgICBpZiAoKGtleSAhPT0gJ19fa2InKSAmJiBrYi5pc1JlbGVhc2VhYmxlKHZhbHVlLCBkZXB0aCArIDEpKSB7CgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gZmFsc2U7CgkgIH07CgoJICBrYi5yZWxlYXNlID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIGFycmF5LCBpbmRleCwgbWV0aG9kLCB2YWx1ZSwgX2ksIF9sZW47CgkgICAgaWYgKCFrYi5pc1JlbGVhc2VhYmxlKG9iaikpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgb2JqLl9fa2JfcmVsZWFzZWQgPSB0cnVlOwoJICAgIGlmIChfLmlzQXJyYXkob2JqKSkgewoJICAgICAgZm9yIChpbmRleCBpbiBvYmopIHsKCSAgICAgICAgdmFsdWUgPSBvYmpbaW5kZXhdOwoJICAgICAgICBpZiAoa2IuaXNSZWxlYXNlYWJsZSh2YWx1ZSkpIHsKCSAgICAgICAgICBvYmpbaW5kZXhdID0gbnVsbDsKCSAgICAgICAgICBrYi5yZWxlYXNlKHZhbHVlKTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBpZiAoa28uaXNPYnNlcnZhYmxlKG9iaikgJiYgXy5pc0FycmF5KGFycmF5ID0ga2IucGVlayhvYmopKSkgewoJICAgICAgaWYgKG9iai5fX2tiX2lzX2NvIHx8IChvYmouX19rYl9pc19vICYmIChvYmoudmFsdWVUeXBlKCkgPT09IGtiLlRZUEVfQ09MTEVDVElPTikpKSB7CgkgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqLmRlc3Ryb3kgPT09ICJmdW5jdGlvbiIgPyBvYmouZGVzdHJveSgpIDogdm9pZCAwOwoJICAgICAgfQoJICAgICAgZm9yIChpbmRleCBpbiBhcnJheSkgewoJICAgICAgICB2YWx1ZSA9IGFycmF5W2luZGV4XTsKCSAgICAgICAgaWYgKGtiLmlzUmVsZWFzZWFibGUodmFsdWUpKSB7CgkgICAgICAgICAgYXJyYXlbaW5kZXhdID0gbnVsbDsKCSAgICAgICAgICBrYi5yZWxlYXNlKHZhbHVlKTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgICAgaWYgKHR5cGVvZiBvYmouZGlzcG9zZSA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICBvYmouZGlzcG9zZSgpOwoJICAgICAgfQoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IExJRkVDWUNMRV9NRVRIT0RTLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBtZXRob2QgPSBMSUZFQ1lDTEVfTUVUSE9EU1tfaV07CgkgICAgICBpZiAodHlwZW9mIG9ialttZXRob2RdID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgIHJldHVybiBvYmpbbWV0aG9kXS5jYWxsKG9iaik7CgkgICAgICB9CgkgICAgfQoJICAgIGlmICgha28uaXNPYnNlcnZhYmxlKG9iaikpIHsKCSAgICAgIHJldHVybiB0aGlzLnJlbGVhc2VLZXlzKG9iaik7CgkgICAgfQoJICB9OwoKCSAga2IucmVsZWFzZUtleXMgPSBmdW5jdGlvbihvYmopIHsKCSAgICB2YXIga2V5LCB2YWx1ZTsKCSAgICBmb3IgKGtleSBpbiBvYmopIHsKCSAgICAgIHZhbHVlID0gb2JqW2tleV07CgkgICAgICBpZiAoa2V5ICE9PSAnX19rYicgJiYga2IuaXNSZWxlYXNlYWJsZSh2YWx1ZSkpIHsKCSAgICAgICAgb2JqW2tleV0gPSBudWxsOwoJICAgICAgICBrYi5yZWxlYXNlKHZhbHVlKTsKCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICBrYi5yZWxlYXNlT25Ob2RlUmVtb3ZlID0gZnVuY3Rpb24odmlld19tb2RlbCwgbm9kZSkgewoJICAgIHZpZXdfbW9kZWwgfHwga2IuX3Rocm93VW5leHBlY3RlZCh0aGlzLCAnbWlzc2luZyB2aWV3IG1vZGVsJyk7CgkgICAgbm9kZSB8fCBrYi5fdGhyb3dVbmV4cGVjdGVkKHRoaXMsICdtaXNzaW5nIG5vZGUnKTsKCSAgICByZXR1cm4ga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayhub2RlLCBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBrYi5yZWxlYXNlKHZpZXdfbW9kZWwpOwoJICAgIH0pOwoJICB9OwoKCSAga2IucmVuZGVyVGVtcGxhdGUgPSBmdW5jdGlvbih0ZW1wbGF0ZSwgdmlld19tb2RlbCwgb3B0aW9ucykgewoJICAgIHZhciBkb2N1bWVudCwgZWwsIG9ic2VydmFibGU7CgkgICAgaWYgKG9wdGlvbnMgPT0gbnVsbCkgewoJICAgICAgb3B0aW9ucyA9IHt9OwoJICAgIH0KCSAgICBpZiAoIShkb2N1bWVudCA9IHdpbmRvdyAhPSBudWxsID8gd2luZG93LmRvY3VtZW50IDogdm9pZCAwKSkgewoJICAgICAgcmV0dXJuIHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiBjb25zb2xlICE9PSBudWxsID8gY29uc29sZS5sb2coJ3JlbmRlclRlbXBsYXRlOiBkb2N1bWVudCBpcyB1bmRlZmluZWQnKSA6IHZvaWQgMDsKCSAgICB9CgkgICAgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCSAgICBvYnNlcnZhYmxlID0ga28ucmVuZGVyVGVtcGxhdGUodGVtcGxhdGUsIHZpZXdfbW9kZWwsIG9wdGlvbnMsIGVsLCAncmVwbGFjZUNoaWxkcmVuJyk7CgkgICAgaWYgKGVsLmNoaWxkTm9kZXMubGVuZ3RoID09PSAxKSB7CgkgICAgICBlbCA9IGVsLmNoaWxkTm9kZXNbMF07CgkgICAgfSBlbHNlIGlmIChlbC5jaGlsZE5vZGVzLmxlbmd0aCkgewoJICAgICAga28uc3RvcmVkQmluZGluZ0NvbnRleHRGb3JOb2RlKGVsLCBrby5jb250ZXh0Rm9yKGVsLmNoaWxkTm9kZXNbMF0pKTsKCSAgICB9CgkgICAga2IucmVsZWFzZU9uTm9kZVJlbW92ZSh2aWV3X21vZGVsLCBlbCk7CgkgICAgb2JzZXJ2YWJsZS5kaXNwb3NlKCk7CgkgICAgaWYgKHZpZXdfbW9kZWwuYWZ0ZXJSZW5kZXIgJiYgIW9wdGlvbnMuYWZ0ZXJSZW5kZXIpIHsKCSAgICAgIHZpZXdfbW9kZWwuYWZ0ZXJSZW5kZXIoZWwpOwoJICAgIH0KCSAgICByZXR1cm4gZWw7CgkgIH07CgoJICBrYi5hcHBseUJpbmRpbmdzID0gZnVuY3Rpb24odmlld19tb2RlbCwgbm9kZSkgewoJICAgIHZhciBjaGlsZCwgY2hpbGRyZW4sIF9pLCBfbGVuLCBfcmVmOwoJICAgIGlmIChub2RlLmxlbmd0aCkgewoJICAgICAgX3JlZiA9IFtkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgbm9kZV0sIG5vZGUgPSBfcmVmWzBdLCBjaGlsZHJlbiA9IF9yZWZbMV07CgkgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGNoaWxkcmVuLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgIGNoaWxkID0gY2hpbGRyZW5bX2ldOwoJICAgICAgICBub2RlLmFwcGVuZENoaWxkKGNoaWxkKTsKCSAgICAgIH0KCSAgICB9CgkgICAga28uYXBwbHlCaW5kaW5ncyh2aWV3X21vZGVsLCBub2RlKTsKCSAgICBrYi5yZWxlYXNlT25Ob2RlUmVtb3ZlKHZpZXdfbW9kZWwsIG5vZGUpOwoJICAgIHJldHVybiBub2RlOwoJICB9OwoKCSAga2IuZ2V0VmFsdWUgPSBmdW5jdGlvbihtb2RlbCwga2V5LCBhcmdzKSB7CgkgICAgdmFyIF9yZWY7CgkgICAgaWYgKCFtb2RlbCkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBpZiAoXy5pc0Z1bmN0aW9uKG1vZGVsW2tleV0pICYmICgoX3JlZiA9IGtiLm9ybSkgIT0gbnVsbCA/IF9yZWYudXNlRnVuY3Rpb24obW9kZWwsIGtleSkgOiB2b2lkIDApKSB7CgkgICAgICByZXR1cm4gbW9kZWxba2V5XSgpOwoJICAgIH0KCSAgICBpZiAoIWFyZ3MpIHsKCSAgICAgIHJldHVybiBtb2RlbC5nZXQoa2V5KTsKCSAgICB9CgkgICAgcmV0dXJuIG1vZGVsLmdldC5hcHBseShtb2RlbCwgXy5tYXAoW2tleV0uY29uY2F0KGFyZ3MpLCBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgcmV0dXJuIGtiLnBlZWsodmFsdWUpOwoJICAgIH0pKTsKCSAgfTsKCgkgIGtiLnNldFZhbHVlID0gZnVuY3Rpb24obW9kZWwsIGtleSwgdmFsdWUpIHsKCSAgICB2YXIgYXR0cmlidXRlcywgX3JlZjsKCSAgICBpZiAoIW1vZGVsKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGlmIChfLmlzRnVuY3Rpb24obW9kZWxba2V5XSkgJiYgKChfcmVmID0ga2Iub3JtKSAhPSBudWxsID8gX3JlZi51c2VGdW5jdGlvbihtb2RlbCwga2V5KSA6IHZvaWQgMCkpIHsKCSAgICAgIHJldHVybiBtb2RlbFtrZXldKHZhbHVlKTsKCSAgICB9CgkgICAgKGF0dHJpYnV0ZXMgPSB7fSlba2V5XSA9IHZhbHVlOwoJICAgIHJldHVybiBtb2RlbC5zZXQoYXR0cmlidXRlcyk7CgkgIH07CgoJICBrYi5pZ25vcmUgPSAoKF9yZWYgPSBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uKSAhPSBudWxsID8gX3JlZi5pZ25vcmUgOiB2b2lkIDApIHx8IGZ1bmN0aW9uKGNhbGxiYWNrLCBjYWxsYmFja1RhcmdldCwgY2FsbGJhY2tBcmdzKSB7CgkgICAgdmFyIHZhbHVlOwoJICAgIHZhbHVlID0gbnVsbDsKCSAgICBrby5jb21wdXRlZChmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiB2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KGNhbGxiYWNrVGFyZ2V0LCBjYWxsYmFja0FyZ3MgfHwgW10pOwoJICAgIH0pLmRpc3Bvc2UoKTsKCSAgICByZXR1cm4gdmFsdWU7CgkgIH07CgoJICBrYi5leHRlbmQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI2KTsKCgkgIGtiLl90aHJvd01pc3NpbmcgPSBmdW5jdGlvbihpbnN0YW5jZSwgbWVzc2FnZSkgewoJICAgIHRocm93ICIiICsgKF8uaXNTdHJpbmcoaW5zdGFuY2UpID8gaW5zdGFuY2UgOiBpbnN0YW5jZS5jb25zdHJ1Y3Rvci5uYW1lKSArICI6ICIgKyBtZXNzYWdlICsgIiBpcyBtaXNzaW5nIjsKCSAgfTsKCgkgIGtiLl90aHJvd1VuZXhwZWN0ZWQgPSBmdW5jdGlvbihpbnN0YW5jZSwgbWVzc2FnZSkgewoJICAgIHRocm93ICIiICsgKF8uaXNTdHJpbmcoaW5zdGFuY2UpID8gaW5zdGFuY2UgOiBpbnN0YW5jZS5jb25zdHJ1Y3Rvci5uYW1lKSArICI6ICIgKyBtZXNzYWdlICsgIiBpcyB1bmV4cGVjdGVkIjsKCSAgfTsKCgkgIGtiLnB1Ymxpc2hNZXRob2RzID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSwgaW5zdGFuY2UsIG1ldGhvZHMpIHsKCSAgICB2YXIgZm4sIF9pLCBfbGVuOwoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gbWV0aG9kcy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgZm4gPSBtZXRob2RzW19pXTsKCSAgICAgIG9ic2VydmFibGVbZm5dID0ga2IuXy5iaW5kKGluc3RhbmNlW2ZuXSwgaW5zdGFuY2UpOwoJICAgIH0KCSAgfTsKCgkgIGtiLnBlZWsgPSBmdW5jdGlvbihvYnMpIHsKCSAgICBpZiAoIWtvLmlzT2JzZXJ2YWJsZShvYnMpKSB7CgkgICAgICByZXR1cm4gb2JzOwoJICAgIH0KCSAgICBpZiAob2JzLnBlZWspIHsKCSAgICAgIHJldHVybiBvYnMucGVlaygpOwoJICAgIH0KCSAgICByZXR1cm4ga2IuaWdub3JlKGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIG9icygpOwoJICAgIH0pOwoJICB9OwoKCSAga2IuaXNNb2RlbCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiBvYmogJiYgKChvYmogaW5zdGFuY2VvZiBrYi5Nb2RlbCkgfHwgKCh0eXBlb2Ygb2JqLmdldCA9PT0gJ2Z1bmN0aW9uJykgJiYgKHR5cGVvZiBvYmouYmluZCA9PT0gJ2Z1bmN0aW9uJykpKTsKCSAgfTsKCgkgIGtiLmlzQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiBvYmogJiYgKG9iaiBpbnN0YW5jZW9mIGtiLkNvbGxlY3Rpb24pOwoJICB9OwoKCSAgcmV0dXJuIGtiOwoKCX0pKCk7CgoJaWYgKHdpbmRvdy5QYXJzZSkgewoJICBCYWNrYm9uZSA9IGtiLlBhcnNlID0gd2luZG93LlBhcnNlOwoJICBfID0ga2IuXyA9IHdpbmRvdy5QYXJzZS5fOwoJfSBlbHNlIHsKCSAgQmFja2JvbmUgPSBrYi5CYWNrYm9uZSA9IF9fd2VicGFja19yZXF1aXJlX18oMzApOwoJICBfID0ga2IuXyA9IF9fd2VicGFja19yZXF1aXJlX18oMzEpOwoJfQoKCWtiLmtvID0ga287CgoJa2IuQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb247CgoJa2IuTW9kZWwgPSBCYWNrYm9uZS5PYmplY3QgfHwgQmFja2JvbmUuTW9kZWw7CgoJa2IuRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzOwoKCWtiLiQgPSB3aW5kb3cualF1ZXJ5IHx8IHdpbmRvdy4kOwoKCXRyeSB7CgkgIGtiLiQgfHwgKGtiLiQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIwKSk7Cgl9IGNhdGNoIChfZXJyb3IpIHt9CgkKCS8qIFdFQlBBQ0sgVkFSIElOSkVDVElPTiAqL30uY2FsbChleHBvcnRzLCAoZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzOyB9KCkpKSkKCi8qKiovIH0sCi8qIDcgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIGtvLCBfZXh0ZW5kLCBfcmVmLCBfcmVmMTsKCglrbyA9IChrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNikpLmtvOwoKCWlmICgoX3JlZiA9IGtvLnN1YnNjcmliYWJsZSkgIT0gbnVsbCA/IChfcmVmMSA9IF9yZWYuZm4pICE9IG51bGwgPyBfcmVmMS5leHRlbmQgOiB2b2lkIDAgOiB2b2lkIDApIHsKCSAgX2V4dGVuZCA9IGtvLnN1YnNjcmliYWJsZS5mbi5leHRlbmQ7CgkgIGtvLnN1YnNjcmliYWJsZS5mbi5leHRlbmQgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgdGFyZ2V0LCBfZGlzcG9zZTsKCSAgICB0YXJnZXQgPSBfZXh0ZW5kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgICAgaWYgKHRhcmdldCAhPT0gdGhpcyAmJiBrYi5pc1JlbGVhc2VhYmxlKHRoaXMpKSB7CgkgICAgICBfZGlzcG9zZSA9IHRhcmdldC5kaXNwb3NlOwoJICAgICAgdGFyZ2V0LmRpc3Bvc2UgPSAoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgIGlmIChfZGlzcG9zZSAhPSBudWxsKSB7CgkgICAgICAgICAgICBfZGlzcG9zZS5hcHBseSh0YXJnZXQsIGFyZ3VtZW50cyk7CgkgICAgICAgICAgfQoJICAgICAgICAgIHJldHVybiBrYi5yZWxlYXNlKF90aGlzKTsKCSAgICAgICAgfTsKCSAgICAgIH0pKHRoaXMpOwoJICAgIH0KCSAgICByZXR1cm4gdGFyZ2V0OwoJICB9OwoJfQoKCi8qKiovIH0sCi8qIDggKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgS0VZU19JTkZPLCBLRVlTX1BVQkxJU0gsIFR5cGVkVmFsdWUsIGtiLCBrbywgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJVHlwZWRWYWx1ZSA9IF9fd2VicGFja19yZXF1aXJlX18oMTEpOwoKCUtFWVNfUFVCTElTSCA9IFsndmFsdWUnLCAndmFsdWVUeXBlJywgJ2Rlc3Ryb3knXTsKCglLRVlTX0lORk8gPSBbJ2FyZ3MnLCAncmVhZCcsICd3cml0ZSddOwoKCWtiLk9ic2VydmFibGUgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIE9ic2VydmFibGUobW9kZWwsIGtleV9vcl9pbmZvLCBvcHRpb25zLCBfdm0pIHsKCSAgICB0aGlzLl92bSA9IF92bSAhPSBudWxsID8gX3ZtIDoge307CgkgICAgcmV0dXJuIGtiLmlnbm9yZSgoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgdmFyIGNyZWF0ZV9vcHRpb25zLCBldmVudF93YXRjaGVyLCBrZXksIG9ic2VydmFibGUsIF9pLCBfbGVuOwoJICAgICAgICBrZXlfb3JfaW5mbyB8fCBrYi5fdGhyb3dNaXNzaW5nKF90aGlzLCAna2V5X29yX2luZm8nKTsKCSAgICAgICAgX3RoaXMua2V5ID0ga2V5X29yX2luZm8ua2V5IHx8IGtleV9vcl9pbmZvOwoJICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IEtFWVNfSU5GTy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgICAgIGtleSA9IEtFWVNfSU5GT1tfaV07CgkgICAgICAgICAgaWYgKGtleV9vcl9pbmZvW2tleV0pIHsKCSAgICAgICAgICAgIF90aGlzW2tleV0gPSBrZXlfb3JfaW5mb1trZXldOwoJICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICBjcmVhdGVfb3B0aW9ucyA9IGtiLnV0aWxzLmNvbGxhcHNlT3B0aW9ucyhvcHRpb25zKTsKCSAgICAgICAgZXZlbnRfd2F0Y2hlciA9IGNyZWF0ZV9vcHRpb25zLmV2ZW50X3dhdGNoZXI7CgkgICAgICAgIGRlbGV0ZSBjcmVhdGVfb3B0aW9ucy5ldmVudF93YXRjaGVyOwoJICAgICAgICBfdGhpcy5fdmFsdWUgPSBuZXcgVHlwZWRWYWx1ZShjcmVhdGVfb3B0aW9ucyk7CgkgICAgICAgIF90aGlzLl9tb2RlbCA9IGtvLm9ic2VydmFibGUoKTsKCSAgICAgICAgb2JzZXJ2YWJsZSA9IGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKF90aGlzLCBrby5jb21wdXRlZCh7CgkgICAgICAgICAgcmVhZDogZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICB2YXIgYXJnLCBhcmdzLCBfaiwgX2xlbjEsIF9tb2RlbCwgX3JlZjEsIF9yZWYyOwoJICAgICAgICAgICAgX21vZGVsID0gX3RoaXMuX21vZGVsKCk7CgkgICAgICAgICAgICBfcmVmMSA9IGFyZ3MgPSBbX3RoaXMua2V5XS5jb25jYXQoX3RoaXMuYXJncyB8fCBbXSk7CgkgICAgICAgICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBfcmVmMS5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKCSAgICAgICAgICAgICAgYXJnID0gX3JlZjFbX2pdOwoJICAgICAgICAgICAgICBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFyZyk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAoKF9yZWYyID0ga2IudXRpbHMud3JhcHBlZEV2ZW50V2F0Y2hlcihfdGhpcykpICE9IG51bGwpIHsKCSAgICAgICAgICAgICAgX3JlZjIuZW1pdHRlcihfbW9kZWwgfHwgbnVsbCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAoX3RoaXMucmVhZCkgewoJICAgICAgICAgICAgICBfdGhpcy51cGRhdGUoX3RoaXMucmVhZC5hcHBseShfdGhpcy5fdm0sIGFyZ3MpKTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAoIV8uaXNVbmRlZmluZWQoX21vZGVsKSkgewoJICAgICAgICAgICAgICBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnVwZGF0ZShrYi5nZXRWYWx1ZShfbW9kZWwsIGtiLnBlZWsoX3RoaXMua2V5KSwgX3RoaXMuYXJncykpOwoJICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBfdGhpcy5fdmFsdWUudmFsdWUoKTsKCSAgICAgICAgICB9LAoJICAgICAgICAgIHdyaXRlOiBmdW5jdGlvbihuZXdfdmFsdWUpIHsKCSAgICAgICAgICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgIHZhciB1bndyYXBwZWRfbmV3X3ZhbHVlLCBfbW9kZWw7CgkgICAgICAgICAgICAgIHVud3JhcHBlZF9uZXdfdmFsdWUgPSBrYi51dGlscy51bndyYXBNb2RlbHMobmV3X3ZhbHVlKTsKCSAgICAgICAgICAgICAgX21vZGVsID0ga2IucGVlayhfdGhpcy5fbW9kZWwpOwoJICAgICAgICAgICAgICBpZiAoX3RoaXMud3JpdGUpIHsKCSAgICAgICAgICAgICAgICBfdGhpcy53cml0ZS5jYWxsKF90aGlzLl92bSwgdW53cmFwcGVkX25ld192YWx1ZSk7CgkgICAgICAgICAgICAgICAgbmV3X3ZhbHVlID0ga2IuZ2V0VmFsdWUoX21vZGVsLCBrYi5wZWVrKF90aGlzLmtleSksIF90aGlzLmFyZ3MpOwoJICAgICAgICAgICAgICB9IGVsc2UgaWYgKF9tb2RlbCkgewoJICAgICAgICAgICAgICAgIGtiLnNldFZhbHVlKF9tb2RlbCwga2IucGVlayhfdGhpcy5rZXkpLCB1bndyYXBwZWRfbmV3X3ZhbHVlKTsKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlKG5ld192YWx1ZSk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICB9LAoJICAgICAgICAgIG93bmVyOiBfdGhpcy5fdm0KCSAgICAgICAgfSkpOwoJICAgICAgICBvYnNlcnZhYmxlLl9fa2JfaXNfbyA9IHRydWU7CgkgICAgICAgIGNyZWF0ZV9vcHRpb25zLnN0b3JlID0ga2IudXRpbHMud3JhcHBlZFN0b3JlKG9ic2VydmFibGUsIGNyZWF0ZV9vcHRpb25zLnN0b3JlKTsKCSAgICAgICAgY3JlYXRlX29wdGlvbnMucGF0aCA9IGtiLnV0aWxzLnBhdGhKb2luKGNyZWF0ZV9vcHRpb25zLnBhdGgsIF90aGlzLmtleSk7CgkgICAgICAgIGlmIChjcmVhdGVfb3B0aW9ucy5mYWN0b3JpZXMgJiYgKCh0eXBlb2YgY3JlYXRlX29wdGlvbnMuZmFjdG9yaWVzID09PSAnZnVuY3Rpb24nKSB8fCBjcmVhdGVfb3B0aW9ucy5mYWN0b3JpZXMuY3JlYXRlKSkgewoJICAgICAgICAgIGNyZWF0ZV9vcHRpb25zLmZhY3RvcnkgPSBrYi51dGlscy53cmFwcGVkRmFjdG9yeShvYnNlcnZhYmxlLCBuZXcga2IuRmFjdG9yeShjcmVhdGVfb3B0aW9ucy5mYWN0b3J5KSk7CgkgICAgICAgICAgY3JlYXRlX29wdGlvbnMuZmFjdG9yeS5hZGRQYXRoTWFwcGluZyhjcmVhdGVfb3B0aW9ucy5wYXRoLCBjcmVhdGVfb3B0aW9ucy5mYWN0b3JpZXMpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIGNyZWF0ZV9vcHRpb25zLmZhY3RvcnkgPSBrYi5GYWN0b3J5LnVzZU9wdGlvbnNPckNyZWF0ZShjcmVhdGVfb3B0aW9ucywgb2JzZXJ2YWJsZSwgY3JlYXRlX29wdGlvbnMucGF0aCk7CgkgICAgICAgIH0KCSAgICAgICAgZGVsZXRlIGNyZWF0ZV9vcHRpb25zLmZhY3RvcmllczsKCSAgICAgICAga2IucHVibGlzaE1ldGhvZHMob2JzZXJ2YWJsZSwgX3RoaXMsIEtFWVNfUFVCTElTSCk7CgkgICAgICAgIG9ic2VydmFibGUubW9kZWwgPSBfdGhpcy5tb2RlbCA9IGtvLmNvbXB1dGVkKHsKCSAgICAgICAgICByZWFkOiBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKF90aGlzLl9tb2RlbCk7CgkgICAgICAgICAgfSwKCSAgICAgICAgICB3cml0ZTogZnVuY3Rpb24obmV3X21vZGVsKSB7CgkgICAgICAgICAgICByZXR1cm4ga2IuaWdub3JlKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICB2YXIgbmV3X3ZhbHVlOwoJICAgICAgICAgICAgICBpZiAoX3RoaXMuX19rYl9yZWxlYXNlZCB8fCAoa2IucGVlayhfdGhpcy5fbW9kZWwpID09PSBuZXdfbW9kZWwpKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIG5ld192YWx1ZSA9IGtiLmdldFZhbHVlKG5ld19tb2RlbCwga2IucGVlayhfdGhpcy5rZXkpLCBfdGhpcy5hcmdzKTsKCSAgICAgICAgICAgICAgX3RoaXMuX21vZGVsKG5ld19tb2RlbCk7CgkgICAgICAgICAgICAgIGlmICghbmV3X21vZGVsKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnVwZGF0ZShudWxsKTsKCSAgICAgICAgICAgICAgfSBlbHNlIGlmICghXy5pc1VuZGVmaW5lZChuZXdfdmFsdWUpKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnVwZGF0ZShuZXdfdmFsdWUpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgICAgICBrYi5FdmVudFdhdGNoZXIudXNlT3B0aW9uc09yQ3JlYXRlKHsKCSAgICAgICAgICBldmVudF93YXRjaGVyOiBldmVudF93YXRjaGVyCgkgICAgICAgIH0sIG1vZGVsIHx8IG51bGwsIF90aGlzLCB7CgkgICAgICAgICAgZW1pdHRlcjogX3RoaXMubW9kZWwsCgkgICAgICAgICAgdXBkYXRlOiAoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICByZXR1cm4ga2IuaWdub3JlKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlKCk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICB9KSwKCSAgICAgICAgICBrZXk6IF90aGlzLmtleSwKCSAgICAgICAgICBwYXRoOiBjcmVhdGVfb3B0aW9ucy5wYXRoCgkgICAgICAgIH0pOwoJICAgICAgICBfdGhpcy5fdmFsdWUucmF3VmFsdWUoKSB8fCBfdGhpcy5fdmFsdWUudXBkYXRlKCk7CgkgICAgICAgIGlmIChrYi5Mb2NhbGl6ZWRPYnNlcnZhYmxlICYmIGtleV9vcl9pbmZvLmxvY2FsaXplcikgewoJICAgICAgICAgIG9ic2VydmFibGUgPSBuZXcga2V5X29yX2luZm8ubG9jYWxpemVyKG9ic2VydmFibGUpOwoJICAgICAgICB9CgkgICAgICAgIGlmIChrYi5EZWZhdWx0T2JzZXJ2YWJsZSAmJiBrZXlfb3JfaW5mby5oYXNPd25Qcm9wZXJ0eSgnZGVmYXVsdCcpKSB7CgkgICAgICAgICAgb2JzZXJ2YWJsZSA9IGtiLmRlZmF1bHRPYnNlcnZhYmxlKG9ic2VydmFibGUsIGtleV9vcl9pbmZvWyJkZWZhdWx0Il0pOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiBvYnNlcnZhYmxlOwoJICAgICAgfTsKCSAgICB9KSh0aGlzKSk7CgkgIH0KCgkgIE9ic2VydmFibGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgb2JzZXJ2YWJsZTsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcyk7CgkgICAgdGhpcy5fX2tiX3JlbGVhc2VkID0gdHJ1ZTsKCSAgICB0aGlzLl92YWx1ZS5kZXN0cm95KCk7CgkgICAgdGhpcy5fdmFsdWUgPSBudWxsOwoJICAgIHRoaXMubW9kZWwuZGlzcG9zZSgpOwoJICAgIHRoaXMubW9kZWwgPSBvYnNlcnZhYmxlLm1vZGVsID0gbnVsbDsKCSAgICByZXR1cm4ga2IudXRpbHMud3JhcHBlZERlc3Ryb3kodGhpcyk7CgkgIH07CgoJICBPYnNlcnZhYmxlLnByb3RvdHlwZS52YWx1ZSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiB0aGlzLl92YWx1ZS5yYXdWYWx1ZSgpOwoJICB9OwoKCSAgT2JzZXJ2YWJsZS5wcm90b3R5cGUudmFsdWVUeXBlID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIHRoaXMuX3ZhbHVlLnZhbHVlVHlwZShrYi5wZWVrKHRoaXMuX21vZGVsKSwga2IucGVlayh0aGlzLmtleSkpOwoJICB9OwoKCSAgT2JzZXJ2YWJsZS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24obmV3X3ZhbHVlKSB7CgkgICAgaWYgKHRoaXMuX19rYl9yZWxlYXNlZCkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsKCSAgICAgIG5ld192YWx1ZSA9IGtiLmdldFZhbHVlKGtiLnBlZWsodGhpcy5fbW9kZWwpLCBrYi5wZWVrKHRoaXMua2V5KSk7CgkgICAgfQoJICAgIHJldHVybiB0aGlzLl92YWx1ZS51cGRhdGUobmV3X3ZhbHVlKTsKCSAgfTsKCgkgIHJldHVybiBPYnNlcnZhYmxlOwoKCX0pKCk7CgoJa2Iub2JzZXJ2YWJsZSA9IGZ1bmN0aW9uKG1vZGVsLCBrZXksIG9wdGlvbnMsIHZpZXdfbW9kZWwpIHsKCSAgcmV0dXJuIG5ldyBrYi5PYnNlcnZhYmxlKG1vZGVsLCBrZXksIG9wdGlvbnMsIHZpZXdfbW9kZWwpOwoJfTsKCgovKioqLyB9LAovKiA5ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGtiLCBfOwoKCV8gPSAoa2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpKS5fOwoKCW1vZHVsZS5leHBvcnRzID0ga2IuU3RhdGlzdGljcyA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gU3RhdGlzdGljcygpIHsKCSAgICB0aGlzLm1vZGVsX2V2ZW50c190cmFja2VyID0gW107CgkgICAgdGhpcy5yZWdpc3RlcmVkX3RyYWNrZXIgPSB7fTsKCSAgfQoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gdGhpcy5tb2RlbF9ldmVudHNfdHJhY2tlciA9IFtdOwoJICB9OwoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUuYWRkTW9kZWxFdmVudCA9IGZ1bmN0aW9uKGV2ZW50KSB7CgkgICAgcmV0dXJuIHRoaXMubW9kZWxfZXZlbnRzX3RyYWNrZXIucHVzaChldmVudCk7CgkgIH07CgoJICBTdGF0aXN0aWNzLnByb3RvdHlwZS5tb2RlbEV2ZW50c1N0YXRzU3RyaW5nID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIGV2ZW50X2dyb3Vwcywga2V5LCBzdGF0c19zdHJpbmcsIHZhbHVlOwoJICAgIHN0YXRzX3N0cmluZyA9ICcnOwoJICAgIHN0YXRzX3N0cmluZyArPSAiVG90YWwgQ291bnQ6ICIgKyB0aGlzLm1vZGVsX2V2ZW50c190cmFja2VyLmxlbmd0aDsKCSAgICBldmVudF9ncm91cHMgPSBfLmdyb3VwQnkodGhpcy5tb2RlbF9ldmVudHNfdHJhY2tlciwgZnVuY3Rpb24odGVzdCkgewoJICAgICAgcmV0dXJuICJldmVudCBuYW1lOiAnIiArIHRlc3QubmFtZSArICInLCBhdHRyaWJ1dGUgbmFtZTogJyIgKyB0ZXN0LmtleSArICInIjsKCSAgICB9KTsKCSAgICBmb3IgKGtleSBpbiBldmVudF9ncm91cHMpIHsKCSAgICAgIHZhbHVlID0gZXZlbnRfZ3JvdXBzW2tleV07CgkgICAgICBzdGF0c19zdHJpbmcgKz0gIlxuICIgKyBrZXkgKyAiLCBjb3VudDogIiArIHZhbHVlLmxlbmd0aDsKCSAgICB9CgkgICAgcmV0dXJuIHN0YXRzX3N0cmluZzsKCSAgfTsKCgkgIFN0YXRpc3RpY3MucHJvdG90eXBlLnJlZ2lzdGVyID0gZnVuY3Rpb24oa2V5LCBvYmopIHsKCSAgICByZXR1cm4gdGhpcy5yZWdpc3RlcmVkVHJhY2tlcihrZXkpLnB1c2gob2JqKTsKCSAgfTsKCgkgIFN0YXRpc3RpY3MucHJvdG90eXBlLnVucmVnaXN0ZXIgPSBmdW5jdGlvbihrZXksIG9iaikgewoJICAgIHZhciBpbmRleCwgdHlwZV90cmFja2VyOwoJICAgIHR5cGVfdHJhY2tlciA9IHRoaXMucmVnaXN0ZXJlZFRyYWNrZXIoa2V5KTsKCSAgICBpZiAoKGluZGV4ID0gXy5pbmRleE9mKHR5cGVfdHJhY2tlciwgb2JqKSkgPCAwKSB7CgkgICAgICByZXR1cm4gdHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUgIT09IG51bGwgPyBjb25zb2xlLmxvZygia2IuU3RhdGlzdGljczogZmFpbGVkIHRvIHVucmVnaXN0ZXIgdHlwZTogIiArIGtleSkgOiB2b2lkIDA7CgkgICAgfQoJICAgIHJldHVybiB0eXBlX3RyYWNrZXIuc3BsaWNlKGluZGV4LCAxKTsKCSAgfTsKCgkgIFN0YXRpc3RpY3MucHJvdG90eXBlLnJlZ2lzdGVyZWRDb3VudCA9IGZ1bmN0aW9uKHR5cGUpIHsKCSAgICB2YXIgY291bnQsIHR5cGVfdHJhY2tlciwgX3JlZjsKCSAgICBpZiAodHlwZSkgewoJICAgICAgcmV0dXJuIHRoaXMucmVnaXN0ZXJlZFRyYWNrZXIodHlwZSkubGVuZ3RoOwoJICAgIH0KCSAgICBjb3VudCA9IDA7CgkgICAgX3JlZiA9IHRoaXMucmVnaXN0ZXJlZF90cmFja2VyW3R5cGVdOwoJICAgIGZvciAodHlwZSBpbiBfcmVmKSB7CgkgICAgICB0eXBlX3RyYWNrZXIgPSBfcmVmW3R5cGVdOwoJICAgICAgY291bnQgKz0gdHlwZV90cmFja2VyLmxlbmd0aDsKCSAgICB9CgkgICAgcmV0dXJuIGNvdW50OwoJICB9OwoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUucmVnaXN0ZXJlZFN0YXRzU3RyaW5nID0gZnVuY3Rpb24oc3VjY2Vzc19tZXNzYWdlKSB7CgkgICAgdmFyIHN0YXRzX3N0cmluZywgdHlwZSwgdHlwZV90cmFja2VyLCB3cml0dGVuLCBfcmVmOwoJICAgIHN0YXRzX3N0cmluZyA9ICcnOwoJICAgIF9yZWYgPSB0aGlzLnJlZ2lzdGVyZWRfdHJhY2tlcjsKCSAgICBmb3IgKHR5cGUgaW4gX3JlZikgewoJICAgICAgdHlwZV90cmFja2VyID0gX3JlZlt0eXBlXTsKCSAgICAgIGlmICghdHlwZV90cmFja2VyLmxlbmd0aCkgewoJICAgICAgICBjb250aW51ZTsKCSAgICAgIH0KCSAgICAgIGlmICh3cml0dGVuKSB7CgkgICAgICAgIHN0YXRzX3N0cmluZyArPSAnXG4gJzsKCSAgICAgIH0KCSAgICAgIHN0YXRzX3N0cmluZyArPSAiIiArICh0eXBlID8gdHlwZSA6ICdObyBOYW1lJykgKyAiOiAiICsgdHlwZV90cmFja2VyLmxlbmd0aDsKCSAgICAgIHdyaXR0ZW4gPSB0cnVlOwoJICAgIH0KCSAgICBpZiAoc3RhdHNfc3RyaW5nKSB7CgkgICAgICByZXR1cm4gc3RhdHNfc3RyaW5nOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4gc3VjY2Vzc19tZXNzYWdlOwoJICAgIH0KCSAgfTsKCgkgIFN0YXRpc3RpY3MucHJvdG90eXBlLnJlZ2lzdGVyZWRUcmFja2VyID0gZnVuY3Rpb24oa2V5KSB7CgkgICAgdmFyIHR5cGVfdHJhY2tlcjsKCSAgICBpZiAodGhpcy5yZWdpc3RlcmVkX3RyYWNrZXIuaGFzT3duUHJvcGVydHkoa2V5KSkgewoJICAgICAgcmV0dXJuIHRoaXMucmVnaXN0ZXJlZF90cmFja2VyW2tleV07CgkgICAgfQoJICAgIHR5cGVfdHJhY2tlciA9IFtdOwoJICAgIHRoaXMucmVnaXN0ZXJlZF90cmFja2VyW2tleV0gPSB0eXBlX3RyYWNrZXI7CgkgICAgcmV0dXJuIHR5cGVfdHJhY2tlcjsKCSAgfTsKCgkgIFN0YXRpc3RpY3MuZXZlbnRzU3RhdHMgPSBmdW5jdGlvbihvYmosIGtleSkgewoJICAgIHZhciBldmVudHMsIG5vZGUsIHN0YXRzLCB0YWlsLCBfaSwgX2xlbiwgX3JlZjsKCSAgICBzdGF0cyA9IHsKCSAgICAgIGNvdW50OiAwCgkgICAgfTsKCSAgICBldmVudHMgPSBvYmouX2V2ZW50cyB8fCBvYmouX2NhbGxiYWNrcyB8fCB7fTsKCSAgICBfcmVmID0gKGtleSA/IFtrZXldIDogXy5rZXlzKGV2ZW50cykpOwoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAga2V5ID0gX3JlZltfaV07CgkgICAgICBpZiAoIShub2RlID0gZXZlbnRzW2tleV0pKSB7CgkgICAgICAgIGNvbnRpbnVlOwoJICAgICAgfQoJICAgICAgaWYgKF8uaXNBcnJheShub2RlKSkgewoJICAgICAgICBzdGF0c1trZXldID0gXy5jb21wYWN0KG5vZGUpLmxlbmd0aDsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHN0YXRzW2tleV0gPSAwOwoJICAgICAgICB0YWlsID0gbm9kZS50YWlsOwoJICAgICAgICB3aGlsZSAoKG5vZGUgPSBub2RlLm5leHQpICE9PSB0YWlsKSB7CgkgICAgICAgICAgc3RhdHNba2V5XSsrOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgICBzdGF0cy5jb3VudCArPSBzdGF0c1trZXldOwoJICAgIH0KCSAgICByZXR1cm4gc3RhdHM7CgkgIH07CgoJICByZXR1cm4gU3RhdGlzdGljczsKCgl9KSgpOwoKCi8qKiovIH0sCi8qIDEwICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGtiLCBrbywgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJbW9kdWxlLmV4cG9ydHMgPSBrYi5TdG9yZSA9IChmdW5jdGlvbigpIHsKCSAgU3RvcmUuaW5zdGFuY2VzID0gW107CgoJICBTdG9yZS51c2VPcHRpb25zT3JDcmVhdGUgPSBmdW5jdGlvbihvcHRpb25zLCBvYmosIG9ic2VydmFibGUpIHsKCSAgICB2YXIgc3RvcmU7CgkgICAgaWYgKCFvcHRpb25zLnN0b3JlKSB7CgkgICAgICBrYi51dGlscy53cmFwcGVkU3RvcmVJc093bmVkKG9ic2VydmFibGUsIHRydWUpOwoJICAgIH0KCSAgICBzdG9yZSA9IGtiLnV0aWxzLndyYXBwZWRTdG9yZShvYnNlcnZhYmxlLCBvcHRpb25zLnN0b3JlIHx8IG5ldyBrYi5TdG9yZSgpKTsKCSAgICBzdG9yZS5yZXRhaW4ob2JzZXJ2YWJsZSwgb2JqLCBvcHRpb25zLmNyZWF0b3IpOwoJICAgIHJldHVybiBzdG9yZTsKCSAgfTsKCgkgIGZ1bmN0aW9uIFN0b3JlKCkgewoJICAgIHRoaXMub2JzZXJ2YWJsZV9yZWNvcmRzID0ge307CgkgICAgdGhpcy5yZXBsYWNlZF9vYnNlcnZhYmxlcyA9IFtdOwoJICAgIGtiLlN0b3JlLmluc3RhbmNlcy5wdXNoKHRoaXMpOwoJICB9CgoJICBTdG9yZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciBpbmRleDsKCSAgICB0aGlzLl9fa2JfcmVsZWFzZWQgPSB0cnVlOwoJICAgIHRoaXMuY2xlYXIoKTsKCSAgICBpZiAoKGluZGV4ID0gXy5pbmRleE9mKGtiLlN0b3JlLmluc3RhbmNlcywgdGhpcykpID49IDApIHsKCSAgICAgIHJldHVybiBrYi5TdG9yZS5pbnN0YW5jZXMuc3BsaWNlKGluZGV4LCAxKTsKCSAgICB9CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgY2lkLCBjcmVhdG9yX2lkLCBvYnNlcnZhYmxlLCBvYnNlcnZhYmxlX3JlY29yZHMsIHJlY29yZHMsIHJlcGxhY2VkX29ic2VydmFibGVzLCBfaSwgX2xlbiwgX3JlZjEsIF9yZWYyOwoJICAgIF9yZWYxID0gW3RoaXMub2JzZXJ2YWJsZV9yZWNvcmRzLCB7fV0sIG9ic2VydmFibGVfcmVjb3JkcyA9IF9yZWYxWzBdLCB0aGlzLm9ic2VydmFibGVfcmVjb3JkcyA9IF9yZWYxWzFdOwoJICAgIGZvciAoY3JlYXRvcl9pZCBpbiBvYnNlcnZhYmxlX3JlY29yZHMpIHsKCSAgICAgIHJlY29yZHMgPSBvYnNlcnZhYmxlX3JlY29yZHNbY3JlYXRvcl9pZF07CgkgICAgICBmb3IgKGNpZCBpbiByZWNvcmRzKSB7CgkgICAgICAgIG9ic2VydmFibGUgPSByZWNvcmRzW2NpZF07CgkgICAgICAgIHRoaXMucmVsZWFzZShvYnNlcnZhYmxlLCB0cnVlKTsKCSAgICAgIH0KCSAgICB9CgkgICAgX3JlZjIgPSBbdGhpcy5yZXBsYWNlZF9vYnNlcnZhYmxlcywgW11dLCByZXBsYWNlZF9vYnNlcnZhYmxlcyA9IF9yZWYyWzBdLCB0aGlzLnJlcGxhY2VkX29ic2VydmFibGVzID0gX3JlZjJbMV07CgkgICAgZm9yIChfaSA9IDAsIF9sZW4gPSByZXBsYWNlZF9vYnNlcnZhYmxlcy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgb2JzZXJ2YWJsZSA9IHJlcGxhY2VkX29ic2VydmFibGVzW19pXTsKCSAgICAgIGlmICghb2JzZXJ2YWJsZS5fX2tiX3JlbGVhc2VkKSB7CgkgICAgICAgIHRoaXMucmVsZWFzZShvYnNlcnZhYmxlLCB0cnVlKTsKCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuY29tcGFjdCA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciBjaWQsIGNyZWF0b3JfaWQsIG9ic2VydmFibGUsIHJlY29yZHMsIF9yZWYxOwoJICAgIF9yZWYxID0gdGhpcy5vYnNlcnZhYmxlX3JlY29yZHM7CgkgICAgZm9yIChjcmVhdG9yX2lkIGluIF9yZWYxKSB7CgkgICAgICByZWNvcmRzID0gX3JlZjFbY3JlYXRvcl9pZF07CgkgICAgICBmb3IgKGNpZCBpbiByZWNvcmRzKSB7CgkgICAgICAgIG9ic2VydmFibGUgPSByZWNvcmRzW2NpZF07CgkgICAgICAgIGlmIChvYnNlcnZhYmxlLl9fa2JfcmVsZWFzZWQpIHsKCSAgICAgICAgICBkZWxldGUgcmVjb3Jkc1tjaWRdOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLnJldGFpbiA9IGZ1bmN0aW9uKG9ic2VydmFibGUsIG9iaiwgY3JlYXRvcikgewoJICAgIHZhciBjdXJyZW50X29ic2VydmFibGU7CgkgICAgaWYgKCF0aGlzLl9jYW5SZWdpc3RlcihvYnNlcnZhYmxlKSkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBjcmVhdG9yIHx8IChjcmVhdG9yID0gb2JzZXJ2YWJsZS5jb25zdHJ1Y3Rvcik7CgkgICAgaWYgKGN1cnJlbnRfb2JzZXJ2YWJsZSA9IHRoaXMuZmluZChvYmosIGNyZWF0b3IpKSB7CgkgICAgICBpZiAoY3VycmVudF9vYnNlcnZhYmxlID09PSBvYnNlcnZhYmxlKSB7CgkgICAgICAgIHRoaXMuX2dldE9yQ3JlYXRlU3RvcmVSZWZlcmVuY2VzKG9ic2VydmFibGUpLnJlZl9jb3VudCsrOwoJICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgICAgIH0KCSAgICAgIHRoaXMuX3JldGlyZShjdXJyZW50X29ic2VydmFibGUpOwoJICAgIH0KCSAgICB0aGlzLl9hZGQob2JzZXJ2YWJsZSwgb2JqLCBjcmVhdG9yKTsKCSAgICB0aGlzLl9nZXRPckNyZWF0ZVN0b3JlUmVmZXJlbmNlcyhvYnNlcnZhYmxlKS5yZWZfY291bnQrKzsKCSAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5yZXRhaW5PckNyZWF0ZSA9IGZ1bmN0aW9uKG9iaiwgb3B0aW9ucykgewoJICAgIHZhciBjcmVhdG9yLCBvYnNlcnZhYmxlOwoJICAgIGlmICghKGNyZWF0b3IgPSB0aGlzLl9jcmVhdG9yKG9iaiwgb3B0aW9ucykpKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuY3JlYXRlRnJvbURlZmF1bHRDcmVhdG9yKG9iaiwgb3B0aW9ucyk7CgkgICAgfQoJICAgIGlmIChjcmVhdG9yLm1vZGVsc19vbmx5KSB7CgkgICAgICByZXR1cm4gb2JqOwoJICAgIH0KCSAgICBpZiAob2JzZXJ2YWJsZSA9IHRoaXMuZmluZChvYmosIGNyZWF0b3IpKSB7CgkgICAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgICB9CgkgICAgaWYgKCFfLmlzRnVuY3Rpb24oY3JlYXRvci5jcmVhdGUgfHwgY3JlYXRvcikpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBmYWN0b3J5IGZvciBcIiIgKyBvcHRpb25zLnBhdGggKyAiXCIiKTsKCSAgICB9CgkgICAgb2JzZXJ2YWJsZSA9IGtiLmlnbm9yZSgoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMoewoJICAgICAgICAgIHN0b3JlOiBfdGhpcywKCSAgICAgICAgICBjcmVhdG9yOiBjcmVhdG9yCgkgICAgICAgIH0sIG9wdGlvbnMpOwoJICAgICAgICBvYnNlcnZhYmxlID0gY3JlYXRvci5jcmVhdGUgPyBjcmVhdG9yLmNyZWF0ZShvYmosIG9wdGlvbnMpIDogbmV3IGNyZWF0b3Iob2JqLCBvcHRpb25zKTsKCSAgICAgICAgcmV0dXJuIG9ic2VydmFibGUgfHwga28ub2JzZXJ2YWJsZShudWxsKTsKCSAgICAgIH07CgkgICAgfSkodGhpcykpOwoJICAgIHRoaXMucmV0YWluKG9ic2VydmFibGUsIG9iaiwgY3JlYXRvcik7CgkgICAgcmV0dXJuIG9ic2VydmFibGU7CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUucmV1c2UgPSBmdW5jdGlvbihvYnNlcnZhYmxlLCBvYmopIHsKCSAgICB2YXIgY3JlYXRvciwgY3VycmVudF9vYmosIGN1cnJlbnRfb2JzZXJ2YWJsZTsKCSAgICBpZiAoKGN1cnJlbnRfb2JqID0ga2IudXRpbHMud3JhcHBlZE9iamVjdChvYnNlcnZhYmxlKSkgPT09IG9iaikgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBpZiAoIXRoaXMuX2NhblJlZ2lzdGVyKG9ic2VydmFibGUpKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCByZXVzZSBhIHNpbXBsZSBvYnNlcnZhYmxlJyk7CgkgICAgfQoJICAgIGlmICh0aGlzLl9yZWZDb3VudChvYnNlcnZhYmxlKSAhPT0gMSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCJUcnlpbmcgdG8gY2hhbmdlIGEgc2hhcmVkIHZpZXcgbW9kZWwuIFJlZiBjb3VudDogIiArICh0aGlzLl9yZWZDb3VudChvYnNlcnZhYmxlKSkpOwoJICAgIH0KCSAgICBjcmVhdG9yID0ga2IudXRpbHMud3JhcHBlZENyZWF0b3Iob2JzZXJ2YWJsZSkgfHwgb2JzZXJ2YWJsZS5jb25zdHJ1Y3RvcjsKCSAgICBpZiAoIV8uaXNVbmRlZmluZWQoY3VycmVudF9vYmopKSB7CgkgICAgICBjdXJyZW50X29ic2VydmFibGUgPSB0aGlzLmZpbmQoY3VycmVudF9vYmosIGNyZWF0b3IpOwoJICAgIH0KCSAgICB0aGlzLnJldGFpbihvYnNlcnZhYmxlLCBvYmosIGNyZWF0b3IpOwoJICAgIGlmIChjdXJyZW50X29ic2VydmFibGUpIHsKCSAgICAgIHRoaXMucmVsZWFzZShjdXJyZW50X29ic2VydmFibGUpOwoJICAgIH0KCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5yZWxlYXNlID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSwgZm9yY2UpIHsKCSAgICB2YXIgc3RvcmVfcmVmZXJlbmNlczsKCSAgICBpZiAoIXRoaXMuX2NhblJlZ2lzdGVyKG9ic2VydmFibGUpKSB7CgkgICAgICByZXR1cm4ga2IucmVsZWFzZShvYnNlcnZhYmxlKTsKCSAgICB9CgkgICAgaWYgKHN0b3JlX3JlZmVyZW5jZXMgPSB0aGlzLl9zdG9yZVJlZmVyZW5jZXMob2JzZXJ2YWJsZSkpIHsKCSAgICAgIGlmICghZm9yY2UgJiYgLS1zdG9yZV9yZWZlcmVuY2VzLnJlZl9jb3VudCA+IDApIHsKCSAgICAgICAgcmV0dXJuOwoJICAgICAgfQoJICAgICAgdGhpcy5fY2xlYXJTdG9yZVJlZmVyZW5jZXMob2JzZXJ2YWJsZSk7CgkgICAgfQoJICAgIHRoaXMuX3JlbW92ZShvYnNlcnZhYmxlKTsKCSAgICBpZiAob2JzZXJ2YWJsZS5fX2tiX3JlbGVhc2VkKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGlmIChmb3JjZSB8fCB0aGlzLl9yZWZDb3VudChvYnNlcnZhYmxlKSA8PSAxKSB7CgkgICAgICByZXR1cm4ga2IucmVsZWFzZShvYnNlcnZhYmxlKTsKCSAgICB9CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuZmluZCA9IGZ1bmN0aW9uKG9iaiwgY3JlYXRvcikgewoJICAgIHZhciBvYnNlcnZhYmxlLCByZWNvcmRzLCBfcmVmMTsKCSAgICBpZiAoIShyZWNvcmRzID0gdGhpcy5vYnNlcnZhYmxlX3JlY29yZHNbdGhpcy5fY3JlYXRvcklkKGNyZWF0b3IpXSkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAoKF9yZWYxID0gKG9ic2VydmFibGUgPSByZWNvcmRzW3RoaXMuX2NpZChvYmopXSkpICE9IG51bGwgPyBfcmVmMS5fX2tiX3JlbGVhc2VkIDogdm9pZCAwKSB7CgkgICAgICBkZWxldGUgcmVjb3Jkc1t0aGlzLl9jaWQob2JqKV07CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgcmV0dXJuIG9ic2VydmFibGU7CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX3JlZkNvdW50ID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSkgewoJICAgIHZhciBzdG9yZXNfcmVmZXJlbmNlczsKCSAgICBpZiAob2JzZXJ2YWJsZS5fX2tiX3JlbGVhc2VkKSB7CgkgICAgICBpZiAodHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUgIT09IG51bGwpIHsKCSAgICAgICAgY29uc29sZS5sb2coJ09ic2VydmFibGUgYWxyZWFkeSByZWxlYXNlZCcpOwoJICAgICAgfQoJICAgICAgcmV0dXJuIDA7CgkgICAgfQoJICAgIGlmICghKHN0b3Jlc19yZWZlcmVuY2VzID0ga2IudXRpbHMuZ2V0KG9ic2VydmFibGUsICdzdG9yZXNfcmVmZXJlbmNlcycpKSkgewoJICAgICAgcmV0dXJuIDE7CgkgICAgfQoJICAgIHJldHVybiBfLnJlZHVjZShzdG9yZXNfcmVmZXJlbmNlcywgKGZ1bmN0aW9uKG1lbW8sIHN0b3JlX3JlZmVyZW5jZXMpIHsKCSAgICAgIHJldHVybiBtZW1vICsgc3RvcmVfcmVmZXJlbmNlcy5yZWZfY291bnQ7CgkgICAgfSksIDApOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9jYW5SZWdpc3RlciA9IGZ1bmN0aW9uKG9ic2VydmFibGUpIHsKCSAgICByZXR1cm4gb2JzZXJ2YWJsZSAmJiAha28uaXNPYnNlcnZhYmxlKG9ic2VydmFibGUpICYmICFvYnNlcnZhYmxlLl9fa2JfaXNfY287CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX2NpZCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBjaWQ7CgkgICAgcmV0dXJuIGNpZCA9IG9iaiA/IG9iai5jaWQgfHwgKG9iai5jaWQgPSBfLnVuaXF1ZUlkKCdjJykpIDogJ251bGwnOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9jcmVhdG9ySWQgPSBmdW5jdGlvbihjcmVhdG9yKSB7CgkgICAgdmFyIGNyZWF0ZSwgaXRlbSwgX2ksIF9sZW4sIF9yZWYxOwoJICAgIGNyZWF0ZSA9IGNyZWF0b3IuY3JlYXRlIHx8IGNyZWF0b3I7CgkgICAgY3JlYXRlLl9fa2JfY2lkcyB8fCAoY3JlYXRlLl9fa2JfY2lkcyA9IFtdKTsKCSAgICBfcmVmMSA9IGNyZWF0ZS5fX2tiX2NpZHM7CgkgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBfcmVmMS5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgaXRlbSA9IF9yZWYxW19pXTsKCSAgICAgIGlmIChpdGVtLmNyZWF0ZSA9PT0gY3JlYXRlKSB7CgkgICAgICAgIHJldHVybiBpdGVtLmNpZDsKCSAgICAgIH0KCSAgICB9CgkgICAgY3JlYXRlLl9fa2JfY2lkcy5wdXNoKGl0ZW0gPSB7CgkgICAgICBjcmVhdGU6IGNyZWF0ZSwKCSAgICAgIGNpZDogXy51bmlxdWVJZCgna2InKQoJICAgIH0pOwoJICAgIHJldHVybiBpdGVtLmNpZDsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fc3RvcmVSZWZlcmVuY2VzID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSkgewoJICAgIHZhciBzdG9yZXNfcmVmZXJlbmNlczsKCSAgICBpZiAoIShzdG9yZXNfcmVmZXJlbmNlcyA9IGtiLnV0aWxzLmdldChvYnNlcnZhYmxlLCAnc3RvcmVzX3JlZmVyZW5jZXMnKSkpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgcmV0dXJuIF8uZmluZChzdG9yZXNfcmVmZXJlbmNlcywgKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oc3RvcmVfcmVmZXJlbmNlcykgewoJICAgICAgICByZXR1cm4gc3RvcmVfcmVmZXJlbmNlcy5zdG9yZSA9PT0gX3RoaXM7CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKTsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fZ2V0T3JDcmVhdGVTdG9yZVJlZmVyZW5jZXMgPSBmdW5jdGlvbihvYnNlcnZhYmxlKSB7CgkgICAgdmFyIHN0b3JlX3JlZmVyZW5jZXMsIHN0b3Jlc19yZWZlcmVuY2VzOwoJICAgIHN0b3Jlc19yZWZlcmVuY2VzID0ga2IudXRpbHMub3JTZXQob2JzZXJ2YWJsZSwgJ3N0b3Jlc19yZWZlcmVuY2VzJywgW10pOwoJICAgIGlmICghKHN0b3JlX3JlZmVyZW5jZXMgPSBfLmZpbmQoc3RvcmVzX3JlZmVyZW5jZXMsIChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKHN0b3JlX3JlZmVyZW5jZXMpIHsKCSAgICAgICAgcmV0dXJuIHN0b3JlX3JlZmVyZW5jZXMuc3RvcmUgPT09IF90aGlzOwoJICAgICAgfTsKCSAgICB9KSh0aGlzKSkpKSB7CgkgICAgICBzdG9yZXNfcmVmZXJlbmNlcy5wdXNoKHN0b3JlX3JlZmVyZW5jZXMgPSB7CgkgICAgICAgIHN0b3JlOiB0aGlzLAoJICAgICAgICByZWZfY291bnQ6IDAsCgkgICAgICAgIHJlbGVhc2U6IChmdW5jdGlvbihfdGhpcykgewoJICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHJldHVybiBfdGhpcy5yZWxlYXNlKG9ic2VydmFibGUpOwoJICAgICAgICAgIH07CgkgICAgICAgIH0pKHRoaXMpCgkgICAgICB9KTsKCSAgICB9CgkgICAgcmV0dXJuIHN0b3JlX3JlZmVyZW5jZXM7CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX2NsZWFyU3RvcmVSZWZlcmVuY2VzID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSkgewoJICAgIHZhciBpbmRleCwgc3RvcmVfcmVmZXJlbmNlcywgc3RvcmVzX3JlZmVyZW5jZXMsIF9yZWYxOwoJICAgIGlmIChzdG9yZXNfcmVmZXJlbmNlcyA9IGtiLnV0aWxzLmdldChvYnNlcnZhYmxlLCAnc3RvcmVzX3JlZmVyZW5jZXMnKSkgewoJICAgICAgX3JlZjEgPSBvYnNlcnZhYmxlLl9fa2Iuc3RvcmVzX3JlZmVyZW5jZXM7CgkgICAgICBmb3IgKGluZGV4IGluIF9yZWYxKSB7CgkgICAgICAgIHN0b3JlX3JlZmVyZW5jZXMgPSBfcmVmMVtpbmRleF07CgkgICAgICAgIGlmIChzdG9yZV9yZWZlcmVuY2VzLnN0b3JlID09PSB0aGlzKSB7CgkgICAgICAgICAgb2JzZXJ2YWJsZS5fX2tiLnN0b3Jlc19yZWZlcmVuY2VzLnNwbGljZShpbmRleCwgMSk7CgkgICAgICAgICAgYnJlYWs7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX3JldGlyZSA9IGZ1bmN0aW9uKG9ic2VydmFibGUpIHsKCSAgICB0aGlzLl9jbGVhclN0b3JlUmVmZXJlbmNlcyhvYnNlcnZhYmxlKTsKCSAgICB0aGlzLnJlcGxhY2VkX29ic2VydmFibGVzLnB1c2gob2JzZXJ2YWJsZSk7CgkgICAgcmV0dXJuIHRoaXMuX3JlbW92ZShvYnNlcnZhYmxlKTsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fYWRkID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSwgb2JqLCBjcmVhdG9yKSB7CgkgICAgdmFyIF9iYXNlLCBfbmFtZTsKCSAgICBjcmVhdG9yIHx8IChjcmVhdG9yID0gb2JzZXJ2YWJsZS5jb25zdHJ1Y3Rvcik7CgkgICAga2IudXRpbHMud3JhcHBlZE9iamVjdChvYnNlcnZhYmxlLCBvYmopOwoJICAgIGtiLnV0aWxzLndyYXBwZWRDcmVhdG9yKG9ic2VydmFibGUsIGNyZWF0b3IpOwoJICAgIHJldHVybiAoKF9iYXNlID0gdGhpcy5vYnNlcnZhYmxlX3JlY29yZHMpW19uYW1lID0gdGhpcy5fY3JlYXRvcklkKGNyZWF0b3IpXSB8fCAoX2Jhc2VbX25hbWVdID0ge30pKVt0aGlzLl9jaWQob2JqKV0gPSBvYnNlcnZhYmxlOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9yZW1vdmUgPSBmdW5jdGlvbihvYnNlcnZhYmxlKSB7CgkgICAgdmFyIGNyZWF0b3IsIGN1cnJlbnRfb2JzZXJ2YWJsZSwgb2JqOwoJICAgIGNyZWF0b3IgPSBrYi51dGlscy53cmFwcGVkQ3JlYXRvcihvYnNlcnZhYmxlKSB8fCBvYnNlcnZhYmxlLmNvbnN0cnVjdG9yOwoJICAgIGlmIChjdXJyZW50X29ic2VydmFibGUgPSB0aGlzLmZpbmQob2JqID0ga2IudXRpbHMud3JhcHBlZE9iamVjdChvYnNlcnZhYmxlKSwgY3JlYXRvcikpIHsKCSAgICAgIGlmIChjdXJyZW50X29ic2VydmFibGUgPT09IG9ic2VydmFibGUpIHsKCSAgICAgICAgZGVsZXRlIHRoaXMub2JzZXJ2YWJsZV9yZWNvcmRzW3RoaXMuX2NyZWF0b3JJZChjcmVhdG9yKV1bdGhpcy5fY2lkKG9iaildOwoJICAgICAgfQoJICAgIH0KCSAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KG9ic2VydmFibGUsIG51bGwpOwoJICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkQ3JlYXRvcihvYnNlcnZhYmxlLCBudWxsKTsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fY3JlYXRvciA9IGZ1bmN0aW9uKG9iaiwgb3B0aW9ucykgewoJICAgIHZhciBjcmVhdG9yOwoJICAgIGlmIChvcHRpb25zLmNyZWF0b3IpIHsKCSAgICAgIHJldHVybiBvcHRpb25zLmNyZWF0b3I7CgkgICAgfQoJICAgIGlmIChjcmVhdG9yID0ga2IudXRpbHMuaW5mZXJDcmVhdG9yKG9iaiwgb3B0aW9ucy5mYWN0b3J5LCBvcHRpb25zLnBhdGgpKSB7CgkgICAgICByZXR1cm4gY3JlYXRvcjsKCSAgICB9CgkgICAgaWYgKGtiLmlzTW9kZWwob2JqKSkgewoJICAgICAgcmV0dXJuIGtiLlZpZXdNb2RlbDsKCSAgICB9CgkgIH07CgoJICByZXR1cm4gU3RvcmU7CgoJfSkoKTsKCgovKioqLyB9LAovKiAxMSAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgl2YXIgVHlwZWRWYWx1ZSwga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCgltb2R1bGUuZXhwb3J0cyA9IFR5cGVkVmFsdWUgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIFR5cGVkVmFsdWUoY3JlYXRlX29wdGlvbnMpIHsKCSAgICB0aGlzLmNyZWF0ZV9vcHRpb25zID0gY3JlYXRlX29wdGlvbnM7CgkgICAgdGhpcy5fdm8gPSBrby5vYnNlcnZhYmxlKG51bGwpOwoJICB9CgoJICBUeXBlZFZhbHVlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIHByZXZpb3VzX3ZhbHVlOwoJICAgIHRoaXMuX19rYl9yZWxlYXNlZCA9IHRydWU7CgkgICAgaWYgKHByZXZpb3VzX3ZhbHVlID0gdGhpcy5fX2tiX3ZhbHVlKSB7CgkgICAgICB0aGlzLl9fa2JfdmFsdWUgPSBudWxsOwoJICAgICAgaWYgKHRoaXMuY3JlYXRlX29wdGlvbnMuc3RvcmUgJiYga2IudXRpbHMud3JhcHBlZENyZWF0b3IocHJldmlvdXNfdmFsdWUpKSB7CgkgICAgICAgIHRoaXMuY3JlYXRlX29wdGlvbnMuc3RvcmUucmVsZWFzZShwcmV2aW91c192YWx1ZSk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBrYi5yZWxlYXNlKHByZXZpb3VzX3ZhbHVlKTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHRoaXMuY3JlYXRlX29wdGlvbnMgPSBudWxsOwoJICB9OwoKCSAgVHlwZWRWYWx1ZS5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh0aGlzLl92bygpKTsKCSAgfTsKCgkgIFR5cGVkVmFsdWUucHJvdG90eXBlLnJhd1ZhbHVlID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIHRoaXMuX19rYl92YWx1ZTsKCSAgfTsKCgkgIFR5cGVkVmFsdWUucHJvdG90eXBlLnZhbHVlVHlwZSA9IGZ1bmN0aW9uKG1vZGVsLCBrZXkpIHsKCSAgICB2YXIgbmV3X3ZhbHVlOwoJICAgIG5ld192YWx1ZSA9IGtiLmdldFZhbHVlKG1vZGVsLCBrZXkpOwoJICAgIHRoaXMudmFsdWVfdHlwZSB8fCB0aGlzLl91cGRhdGVWYWx1ZU9ic2VydmFibGUobmV3X3ZhbHVlKTsKCSAgICByZXR1cm4gdGhpcy52YWx1ZV90eXBlOwoJICB9OwoKCSAgVHlwZWRWYWx1ZS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24obmV3X3ZhbHVlKSB7CgkgICAgdmFyIG5ld190eXBlLCB2YWx1ZSwgX3JlZjE7CgkgICAgaWYgKHRoaXMuX19rYl9yZWxlYXNlZCkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICAobmV3X3ZhbHVlICE9PSB2b2lkIDApIHx8IChuZXdfdmFsdWUgPSBudWxsKTsKCSAgICBuZXdfdHlwZSA9IGtiLnV0aWxzLnZhbHVlVHlwZShuZXdfdmFsdWUpOwoJICAgIGlmICgoX3JlZjEgPSB0aGlzLl9fa2JfdmFsdWUpICE9IG51bGwgPyBfcmVmMS5fX2tiX3JlbGVhc2VkIDogdm9pZCAwKSB7CgkgICAgICB0aGlzLl9fa2JfdmFsdWUgPSB0aGlzLnZhbHVlX3R5cGUgPSB2b2lkIDA7CgkgICAgfQoJICAgIHZhbHVlID0gdGhpcy5fX2tiX3ZhbHVlOwoJICAgIHN3aXRjaCAodGhpcy52YWx1ZV90eXBlKSB7CgkgICAgICBjYXNlIGtiLlRZUEVfQ09MTEVDVElPTjoKCSAgICAgICAgaWYgKHRoaXMudmFsdWVfdHlwZSA9PT0ga2IuVFlQRV9DT0xMRUNUSU9OICYmIG5ld190eXBlID09PSBrYi5UWVBFX0FSUkFZKSB7CgkgICAgICAgICAgcmV0dXJuIHZhbHVlKG5ld192YWx1ZSk7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKG5ld190eXBlID09PSBrYi5UWVBFX0NPTExFQ1RJT04gfHwgXy5pc051bGwobmV3X3ZhbHVlKSkgewoJICAgICAgICAgIGlmIChuZXdfdmFsdWUgJiYgbmV3X3ZhbHVlIGluc3RhbmNlb2Yga2IuQ29sbGVjdGlvbk9ic2VydmFibGUpIHsKCSAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZhbHVlT2JzZXJ2YWJsZShrYi51dGlscy53cmFwcGVkT2JqZWN0KG5ld192YWx1ZSksIG5ld192YWx1ZSk7CgkgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGlmIChrYi5wZWVrKHZhbHVlLmNvbGxlY3Rpb24pICE9PSBuZXdfdmFsdWUpIHsKCSAgICAgICAgICAgICAgdmFsdWUuY29sbGVjdGlvbihuZXdfdmFsdWUpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgIH0KCSAgICAgICAgICByZXR1cm47CgkgICAgICAgIH0KCSAgICAgICAgYnJlYWs7CgkgICAgICBjYXNlIGtiLlRZUEVfTU9ERUw6CgkgICAgICAgIGlmIChuZXdfdHlwZSA9PT0ga2IuVFlQRV9NT0RFTCB8fCBfLmlzTnVsbChuZXdfdmFsdWUpKSB7CgkgICAgICAgICAgaWYgKG5ld192YWx1ZSAmJiAha2IuaXNNb2RlbChuZXdfdmFsdWUpKSB7CgkgICAgICAgICAgICB0aGlzLl91cGRhdGVWYWx1ZU9ic2VydmFibGUoa2IudXRpbHMud3JhcHBlZE9iamVjdChuZXdfdmFsdWUpLCBuZXdfdmFsdWUpOwoJICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBpZiAoa2IudXRpbHMud3JhcHBlZE9iamVjdCh2YWx1ZSkgIT09IGtiLnV0aWxzLnJlc29sdmVNb2RlbChuZXdfdmFsdWUpKSB7CgkgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZhbHVlT2JzZXJ2YWJsZShuZXdfdmFsdWUpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgIH0KCSAgICAgICAgICByZXR1cm47CgkgICAgICAgIH0KCSAgICB9CgkgICAgaWYgKHRoaXMudmFsdWVfdHlwZSA9PT0gbmV3X3R5cGUgJiYgIV8uaXNVbmRlZmluZWQodGhpcy52YWx1ZV90eXBlKSkgewoJICAgICAgaWYgKGtiLnBlZWsodmFsdWUpICE9PSBuZXdfdmFsdWUpIHsKCSAgICAgICAgcmV0dXJuIHZhbHVlKG5ld192YWx1ZSk7CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIGlmIChrYi5wZWVrKHZhbHVlKSAhPT0gbmV3X3ZhbHVlKSB7CgkgICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVWYWx1ZU9ic2VydmFibGUobmV3X3ZhbHVlKTsKCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICBUeXBlZFZhbHVlLnByb3RvdHlwZS5fdXBkYXRlVmFsdWVPYnNlcnZhYmxlID0gZnVuY3Rpb24obmV3X3ZhbHVlLCBuZXdfb2JzZXJ2YWJsZSkgewoJICAgIHZhciBjcmVhdGVfb3B0aW9ucywgY3JlYXRvciwgcHJldmlvdXNfdmFsdWUsIHZhbHVlLCB2YWx1ZV90eXBlLCBfcmVmMTsKCSAgICBjcmVhdGVfb3B0aW9ucyA9IHRoaXMuY3JlYXRlX29wdGlvbnM7CgkgICAgY3JlYXRvciA9IGtiLnV0aWxzLmluZmVyQ3JlYXRvcihuZXdfdmFsdWUsIGNyZWF0ZV9vcHRpb25zLmZhY3RvcnksIGNyZWF0ZV9vcHRpb25zLnBhdGgpOwoJICAgIGlmICgobmV3X3ZhbHVlID09PSBudWxsKSAmJiAhY3JlYXRvcikgewoJICAgICAgaWYgKHRoaXMudmFsdWVfdHlwZSA9PT0ga2IuVFlQRV9NT0RFTCkgewoJICAgICAgICBjcmVhdG9yID0ga2IuVmlld01vZGVsOwoJICAgICAgfSBlbHNlIGlmICh0aGlzLnZhbHVlX3R5cGUgPT09IGtiLlRZUEVfQ09MTEVDVElPTikgewoJICAgICAgICBjcmVhdG9yID0ga2IuQ29sbGVjdGlvbk9ic2VydmFibGU7CgkgICAgICB9CgkgICAgfQoJICAgIGNyZWF0ZV9vcHRpb25zLmNyZWF0b3IgPSBjcmVhdG9yOwoJICAgIHZhbHVlX3R5cGUgPSBrYi5UWVBFX1VOS05PV047CgkgICAgX3JlZjEgPSBbdGhpcy5fX2tiX3ZhbHVlLCB2b2lkIDBdLCBwcmV2aW91c192YWx1ZSA9IF9yZWYxWzBdLCB0aGlzLl9fa2JfdmFsdWUgPSBfcmVmMVsxXTsKCSAgICBpZiAobmV3X29ic2VydmFibGUpIHsKCSAgICAgIHZhbHVlID0gbmV3X29ic2VydmFibGU7CgkgICAgICBpZiAoY3JlYXRlX29wdGlvbnMuc3RvcmUpIHsKCSAgICAgICAgY3JlYXRlX29wdGlvbnMuc3RvcmUucmV0YWluKG5ld19vYnNlcnZhYmxlLCBuZXdfdmFsdWUsIGNyZWF0b3IpOwoJICAgICAgfQoJICAgIH0gZWxzZSBpZiAoY3JlYXRvcikgewoJICAgICAgaWYgKGNyZWF0ZV9vcHRpb25zLnN0b3JlKSB7CgkgICAgICAgIHZhbHVlID0gY3JlYXRlX29wdGlvbnMuc3RvcmUucmV0YWluT3JDcmVhdGUobmV3X3ZhbHVlLCBjcmVhdGVfb3B0aW9ucyk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBpZiAoY3JlYXRvci5tb2RlbHNfb25seSkgewoJICAgICAgICAgIHZhbHVlID0gbmV3X3ZhbHVlOwoJICAgICAgICAgIHZhbHVlX3R5cGUgPSBrYi5UWVBFX1NJTVBMRTsKCSAgICAgICAgfSBlbHNlIGlmIChjcmVhdG9yLmNyZWF0ZSkgewoJICAgICAgICAgIHZhbHVlID0gY3JlYXRvci5jcmVhdGUobmV3X3ZhbHVlLCBjcmVhdGVfb3B0aW9ucyk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgdmFsdWUgPSBuZXcgY3JlYXRvcihuZXdfdmFsdWUsIGNyZWF0ZV9vcHRpb25zKTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH0gZWxzZSB7CgkgICAgICBpZiAoXy5pc0FycmF5KG5ld192YWx1ZSkpIHsKCSAgICAgICAgdmFsdWVfdHlwZSA9IGtiLlRZUEVfQVJSQVk7CgkgICAgICAgIHZhbHVlID0ga28ub2JzZXJ2YWJsZUFycmF5KG5ld192YWx1ZSk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICB2YWx1ZV90eXBlID0ga2IuVFlQRV9TSU1QTEU7CgkgICAgICAgIHZhbHVlID0ga28ub2JzZXJ2YWJsZShuZXdfdmFsdWUpOwoJICAgICAgfQoJICAgIH0KCSAgICBpZiAoKHRoaXMudmFsdWVfdHlwZSA9IHZhbHVlX3R5cGUpID09PSBrYi5UWVBFX1VOS05PV04pIHsKCSAgICAgIGlmICgha28uaXNPYnNlcnZhYmxlKHZhbHVlKSkgewoJICAgICAgICB0aGlzLnZhbHVlX3R5cGUgPSBrYi5UWVBFX01PREVMOwoJICAgICAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KHZhbHVlLCBrYi51dGlscy5yZXNvbHZlTW9kZWwobmV3X3ZhbHVlKSk7CgkgICAgICB9IGVsc2UgaWYgKHZhbHVlLl9fa2JfaXNfY28pIHsKCSAgICAgICAgdGhpcy52YWx1ZV90eXBlID0ga2IuVFlQRV9DT0xMRUNUSU9OOwoJICAgICAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KHZhbHVlLCBuZXdfdmFsdWUpOwoJICAgICAgfSBlbHNlIGlmICghdGhpcy52YWx1ZV90eXBlKSB7CgkgICAgICAgIHRoaXMudmFsdWVfdHlwZSA9IGtiLlRZUEVfU0lNUExFOwoJICAgICAgfQoJICAgIH0KCSAgICBpZiAocHJldmlvdXNfdmFsdWUpIHsKCSAgICAgIGlmICh0aGlzLmNyZWF0ZV9vcHRpb25zLnN0b3JlKSB7CgkgICAgICAgIHRoaXMuY3JlYXRlX29wdGlvbnMuc3RvcmUucmVsZWFzZShwcmV2aW91c192YWx1ZSk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBrYi5yZWxlYXNlKHByZXZpb3VzX3ZhbHVlKTsKCSAgICAgIH0KCSAgICB9CgkgICAgdGhpcy5fX2tiX3ZhbHVlID0gdmFsdWU7CgkgICAgcmV0dXJuIHRoaXMuX3ZvKHZhbHVlKTsKCSAgfTsKCgkgIFR5cGVkVmFsdWUucHJvdG90eXBlLl9pbmZlclR5cGUgPSBmdW5jdGlvbih2YWx1ZSkge307CgoJICByZXR1cm4gVHlwZWRWYWx1ZTsKCgl9KSgpOwoKCi8qKiovIH0sCi8qIDEyICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGtiLCBrbywgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJa2IudXRpbHMgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIHV0aWxzKCkge30KCgkgIHV0aWxzLmdldCA9IGZ1bmN0aW9uKG9iaiwga2V5LCBkZWZhdWx0X3ZhbHVlKSB7CgkgICAgaWYgKCFvYmouX19rYiB8fCAhb2JqLl9fa2IuaGFzT3duUHJvcGVydHkoa2V5KSkgewoJICAgICAgcmV0dXJuIGRlZmF1bHRfdmFsdWU7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBvYmouX19rYltrZXldOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLnNldCA9IGZ1bmN0aW9uKG9iaiwga2V5LCB2YWx1ZSkgewoJICAgIHJldHVybiAob2JqLl9fa2IgfHwgKG9iai5fX2tiID0ge30pKVtrZXldID0gdmFsdWU7CgkgIH07CgoJICB1dGlscy5vclNldCA9IGZ1bmN0aW9uKG9iaiwga2V5LCB2YWx1ZSkgewoJICAgIGlmICghKG9iai5fX2tiIHx8IChvYmouX19rYiA9IHt9KSkuaGFzT3duUHJvcGVydHkoa2V5KSkgewoJICAgICAgb2JqLl9fa2Jba2V5XSA9IHZhbHVlOwoJICAgIH0KCSAgICByZXR1cm4gb2JqLl9fa2Jba2V5XTsKCSAgfTsKCgkgIHV0aWxzLmhhcyA9IGZ1bmN0aW9uKG9iaiwga2V5KSB7CgkgICAgcmV0dXJuIG9iai5fX2tiICYmIG9iai5fX2tiLmhhc093blByb3BlcnR5KGtleSk7CgkgIH07CgoJICB1dGlscy53cmFwcGVkT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLmdldChvYmosICdvYnNlcnZhYmxlJyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnb2JzZXJ2YWJsZScsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkT2JqZWN0ID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuZ2V0KG9iaiwgJ29iamVjdCcpOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuc2V0KG9iaiwgJ29iamVjdCcsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkQ3JlYXRvciA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLmdldChvYmosICdjcmVhdG9yJyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnY3JlYXRvcicsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkTW9kZWwgPSBmdW5jdGlvbihvYmosIHZhbHVlKSB7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKCSAgICAgIGlmIChfLmlzVW5kZWZpbmVkKHZhbHVlID0ga2IudXRpbHMuZ2V0KG9iaiwgJ29iamVjdCcpKSkgewoJICAgICAgICByZXR1cm4gb2JqOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgcmV0dXJuIHZhbHVlOwoJICAgICAgfQoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuc2V0KG9iaiwgJ29iamVjdCcsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkU3RvcmUgPSBmdW5jdGlvbihvYmosIHZhbHVlKSB7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5nZXQob2JqLCAnc3RvcmUnKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLnNldChvYmosICdzdG9yZScsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkU3RvcmVJc093bmVkID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuZ2V0KG9iaiwgJ3N0b3JlX2lzX293bmVkJyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnc3RvcmVfaXNfb3duZWQnLCB2YWx1ZSk7CgkgICAgfQoJICB9OwoKCSAgdXRpbHMud3JhcHBlZEZhY3RvcnkgPSBmdW5jdGlvbihvYmosIHZhbHVlKSB7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5nZXQob2JqLCAnZmFjdG9yeScpOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuc2V0KG9iaiwgJ2ZhY3RvcnknLCB2YWx1ZSk7CgkgICAgfQoJICB9OwoKCSAgdXRpbHMud3JhcHBlZEV2ZW50V2F0Y2hlciA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLmdldChvYmosICdldmVudF93YXRjaGVyJyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnZXZlbnRfd2F0Y2hlcicsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkRXZlbnRXYXRjaGVySXNPd25lZCA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLmdldChvYmosICdldmVudF93YXRjaGVyX2lzX293bmVkJyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnZXZlbnRfd2F0Y2hlcl9pc19vd25lZCcsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkRGVzdHJveSA9IF9fd2VicGFja19yZXF1aXJlX18oMjcpOwoKCSAgdXRpbHMudmFsdWVUeXBlID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSkgewoJICAgIGlmICghb2JzZXJ2YWJsZSkgewoJICAgICAgcmV0dXJuIGtiLlRZUEVfVU5LTk9XTjsKCSAgICB9CgkgICAgaWYgKG9ic2VydmFibGUuX19rYl9pc19vKSB7CgkgICAgICByZXR1cm4gb2JzZXJ2YWJsZS52YWx1ZVR5cGUoKTsKCSAgICB9CgkgICAgaWYgKG9ic2VydmFibGUuX19rYl9pc19jbyB8fCAob2JzZXJ2YWJsZSBpbnN0YW5jZW9mIGtiLkNvbGxlY3Rpb24pKSB7CgkgICAgICByZXR1cm4ga2IuVFlQRV9DT0xMRUNUSU9OOwoJICAgIH0KCSAgICBpZiAoKG9ic2VydmFibGUgaW5zdGFuY2VvZiBrYi5WaWV3TW9kZWwpIHx8IChvYnNlcnZhYmxlIGluc3RhbmNlb2Yga2IuTW9kZWwpKSB7CgkgICAgICByZXR1cm4ga2IuVFlQRV9NT0RFTDsKCSAgICB9CgkgICAgaWYgKF8uaXNBcnJheShvYnNlcnZhYmxlKSkgewoJICAgICAgcmV0dXJuIGtiLlRZUEVfQVJSQVk7CgkgICAgfQoJICAgIHJldHVybiBrYi5UWVBFX1NJTVBMRTsKCSAgfTsKCgkgIHV0aWxzLnBhdGhKb2luID0gZnVuY3Rpb24ocGF0aDEsIHBhdGgyKSB7CgkgICAgcmV0dXJuIChwYXRoMSA/IChwYXRoMVtwYXRoMS5sZW5ndGggLSAxXSAhPT0gJy4nID8gIiIgKyBwYXRoMSArICIuIiA6IHBhdGgxKSA6ICcnKSArIHBhdGgyOwoJICB9OwoKCSAgdXRpbHMub3B0aW9uc1BhdGhKb2luID0gZnVuY3Rpb24ob3B0aW9ucywgcGF0aCkgewoJICAgIHJldHVybiBfLmRlZmF1bHRzKHsKCSAgICAgIHBhdGg6IHRoaXMucGF0aEpvaW4ob3B0aW9ucy5wYXRoLCBwYXRoKQoJICAgIH0sIG9wdGlvbnMpOwoJICB9OwoKCSAgdXRpbHMuaW5mZXJDcmVhdG9yID0gZnVuY3Rpb24odmFsdWUsIGZhY3RvcnksIHBhdGgpIHsKCSAgICB2YXIgY3JlYXRvcjsKCSAgICBpZiAoZmFjdG9yeSAmJiAoY3JlYXRvciA9IGZhY3RvcnkuY3JlYXRvckZvclBhdGgodmFsdWUsIHBhdGgpKSkgewoJICAgICAgcmV0dXJuIGNyZWF0b3I7CgkgICAgfQoJICAgIGlmICghdmFsdWUpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBrYi5Nb2RlbCkgewoJICAgICAgcmV0dXJuIGtiLlZpZXdNb2RlbDsKCSAgICB9CgkgICAgaWYgKHZhbHVlIGluc3RhbmNlb2Yga2IuQ29sbGVjdGlvbikgewoJICAgICAgcmV0dXJuIGtiLkNvbGxlY3Rpb25PYnNlcnZhYmxlOwoJICAgIH0KCSAgICByZXR1cm4gbnVsbDsKCSAgfTsKCgkgIHV0aWxzLmNyZWF0ZUZyb21EZWZhdWx0Q3JlYXRvciA9IGZ1bmN0aW9uKG9iaiwgb3B0aW9ucykgewoJICAgIGlmIChrYi5pc01vZGVsKG9iaikpIHsKCSAgICAgIHJldHVybiBrYi52aWV3TW9kZWwob2JqLCBvcHRpb25zKTsKCSAgICB9CgkgICAgaWYgKGtiLmlzQ29sbGVjdGlvbihvYmopKSB7CgkgICAgICByZXR1cm4ga2IuY29sbGVjdGlvbk9ic2VydmFibGUob2JqLCBvcHRpb25zKTsKCSAgICB9CgkgICAgaWYgKF8uaXNBcnJheShvYmopKSB7CgkgICAgICByZXR1cm4ga28ub2JzZXJ2YWJsZUFycmF5KG9iaik7CgkgICAgfQoJICAgIHJldHVybiBrby5vYnNlcnZhYmxlKG9iaik7CgkgIH07CgoJICB1dGlscy5jb2xsYXBzZU9wdGlvbnMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI4KTsKCgkgIHV0aWxzLnVud3JhcE1vZGVscyA9IF9fd2VicGFja19yZXF1aXJlX18oMjkpOwoKCSAgdXRpbHMucmVzb2x2ZU1vZGVsID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICBpZiAobW9kZWwgJiYga2IuQmFja2JvbmUgJiYga2IuQmFja2JvbmUuTW9kZWxSZWYgJiYgbW9kZWwgaW5zdGFuY2VvZiBrYi5CYWNrYm9uZS5Nb2RlbFJlZikgewoJICAgICAgcmV0dXJuIG1vZGVsLm1vZGVsKCk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBtb2RlbDsKCSAgICB9CgkgIH07CgoJICByZXR1cm4gdXRpbHM7CgoJfSkoKTsKCgovKioqLyB9LAovKiAxMyAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciBLRVlTX09QVElPTlMsIGFzc2lnblZpZXdNb2RlbEtleSwgY3JlYXRlT2JzZXJ2YWJsZSwgY3JlYXRlU3RhdGljT2JzZXJ2YWJsZXMsIGtiLCBrbywgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJYXNzaWduVmlld01vZGVsS2V5ID0gZnVuY3Rpb24odm0sIGtleSkgewoJICB2YXIgdm1fa2V5OwoJICB2bV9rZXkgPSB2bS5fX2tiLmludGVybmFscyAmJiBfLmNvbnRhaW5zKHZtLl9fa2IuaW50ZXJuYWxzLCBrZXkpID8gIl8iICsga2V5IDoga2V5OwoJICBpZiAodm0uX19rYi52aWV3X21vZGVsLmhhc093blByb3BlcnR5KHZtX2tleSkpIHsKCSAgICByZXR1cm47CgkgIH0KCSAgdm0uX19rYi52aWV3X21vZGVsW3ZtX2tleV0gPSBudWxsOwoJICByZXR1cm4gdm1fa2V5OwoJfTsKCgljcmVhdGVPYnNlcnZhYmxlID0gZnVuY3Rpb24odm0sIG1vZGVsLCBrZXksIGNyZWF0ZV9vcHRpb25zKSB7CgkgIHZhciB2bV9rZXk7CgkgIGlmICh2bS5fX2tiLmV4Y2x1ZGVzICYmIF8uY29udGFpbnModm0uX19rYi5leGNsdWRlcywga2V5KSkgewoJICAgIHJldHVybjsKCSAgfQoJICBpZiAodm0uX19rYi5zdGF0aWNzICYmIF8uY29udGFpbnModm0uX19rYi5zdGF0aWNzLCBrZXkpKSB7CgkgICAgcmV0dXJuOwoJICB9CgkgIGlmICghKHZtX2tleSA9IGFzc2lnblZpZXdNb2RlbEtleSh2bSwga2V5KSkpIHsKCSAgICByZXR1cm47CgkgIH0KCSAgcmV0dXJuIHZtW3ZtX2tleV0gPSB2bS5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XSA9IGtiLm9ic2VydmFibGUobW9kZWwsIGtleSwgY3JlYXRlX29wdGlvbnMsIHZtKTsKCX07CgoJY3JlYXRlU3RhdGljT2JzZXJ2YWJsZXMgPSBmdW5jdGlvbih2bSwgbW9kZWwpIHsKCSAgdmFyIGtleSwgdm1fa2V5LCBfaSwgX2xlbiwgX3JlZjE7CgkgIF9yZWYxID0gdm0uX19rYi5zdGF0aWNzOwoJICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYxLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAga2V5ID0gX3JlZjFbX2ldOwoJICAgIGlmICh2bV9rZXkgPSBhc3NpZ25WaWV3TW9kZWxLZXkodm0sIGtleSkpIHsKCSAgICAgIGlmIChtb2RlbC5oYXModm1fa2V5KSkgewoJICAgICAgICB2bVt2bV9rZXldID0gdm0uX19rYi52aWV3X21vZGVsW3ZtX2tleV0gPSBtb2RlbC5nZXQodm1fa2V5KTsKCSAgICAgIH0gZWxzZSBpZiAodm0uX19rYi5zdGF0aWNfZGVmYXVsdHMgJiYgdm1fa2V5IGluIHZtLl9fa2Iuc3RhdGljX2RlZmF1bHRzKSB7CgkgICAgICAgIHZtW3ZtX2tleV0gPSB2bS5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XSA9IHZtLl9fa2Iuc3RhdGljX2RlZmF1bHRzW3ZtX2tleV07CgkgICAgICB9IGVsc2UgewoJICAgICAgICBkZWxldGUgdm0uX19rYi52aWV3X21vZGVsW3ZtX2tleV07CgkgICAgICB9CgkgICAgfQoJICB9Cgl9OwoKCUtFWVNfT1BUSU9OUyA9IFsna2V5cycsICdpbnRlcm5hbHMnLCAnZXhjbHVkZXMnLCAnc3RhdGljcycsICdzdGF0aWNfZGVmYXVsdHMnXTsKCglrYi5WaWV3TW9kZWwgPSAoZnVuY3Rpb24oKSB7CgkgIFZpZXdNb2RlbC5leHRlbmQgPSBrYi5leHRlbmQ7CgoJICBmdW5jdGlvbiBWaWV3TW9kZWwobW9kZWwsIG9wdGlvbnMsIHZpZXdfbW9kZWwpIHsKCSAgICB2YXIgYXJnczsKCSAgICBpZiAob3B0aW9ucyA9PSBudWxsKSB7CgkgICAgICBvcHRpb25zID0ge307CgkgICAgfQoJICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChfLmlzQXJndW1lbnRzKG1vZGVsKSA/IG1vZGVsIDogYXJndW1lbnRzKTsKCSAgICByZXR1cm4ga2IuaWdub3JlKChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgYXJnLCBldmVudF93YXRjaGVyLCBrZXksIF9pLCBfaiwgX2xlbiwgX2xlbjEsIF9tb2RlbDsKCSAgICAgICAgIShtb2RlbCA9IGFyZ3Muc2hpZnQoKSkgfHwga2IuaXNNb2RlbChtb2RlbCkgfHwga2IuX3Rocm93VW5leHBlY3RlZChfdGhpcywgJ25vdCBhIG1vZGVsJyk7CgkgICAgICAgIGlmIChfLmlzQXJyYXkoYXJnc1swXSkpIHsKCSAgICAgICAgICBhcmdzWzBdID0gewoJICAgICAgICAgICAga2V5czogYXJnc1swXQoJICAgICAgICAgIH07CgkgICAgICAgIH0KCSAgICAgICAgX3RoaXMuX19rYiB8fCAoX3RoaXMuX19rYiA9IHt9KTsKCSAgICAgICAgX3RoaXMuX19rYi52aWV3X21vZGVsID0gKGFyZ3MubGVuZ3RoID4gMSA/IGFyZ3MucG9wKCkgOiBfdGhpcyk7CgkgICAgICAgIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBhcmdzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgICAgYXJnID0gYXJnc1tfaV07CgkgICAgICAgICAgXy5leHRlbmQob3B0aW9ucywgYXJnKTsKCSAgICAgICAgfQoJICAgICAgICBvcHRpb25zID0ga2IudXRpbHMuY29sbGFwc2VPcHRpb25zKG9wdGlvbnMpOwoJICAgICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBLRVlTX09QVElPTlMubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CgkgICAgICAgICAga2V5ID0gS0VZU19PUFRJT05TW19qXTsKCSAgICAgICAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CgkgICAgICAgICAgICBfdGhpcy5fX2tiW2tleV0gPSBvcHRpb25zW2tleV07CgkgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIGtiLlN0b3JlLnVzZU9wdGlvbnNPckNyZWF0ZShvcHRpb25zLCBtb2RlbCwgX3RoaXMpOwoJICAgICAgICBfdGhpcy5fX2tiLnBhdGggPSBvcHRpb25zLnBhdGg7CgkgICAgICAgIGtiLkZhY3RvcnkudXNlT3B0aW9uc09yQ3JlYXRlKG9wdGlvbnMsIF90aGlzLCBvcHRpb25zLnBhdGgpOwoJICAgICAgICBfbW9kZWwgPSBrYi51dGlscy5zZXQoX3RoaXMsICdfbW9kZWwnLCBrby5vYnNlcnZhYmxlKCkpOwoJICAgICAgICBfdGhpcy5tb2RlbCA9IGtvLmNvbXB1dGVkKHsKCSAgICAgICAgICByZWFkOiBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKF9tb2RlbCk7CgkgICAgICAgICAgfSwKCSAgICAgICAgICB3cml0ZTogZnVuY3Rpb24obmV3X21vZGVsKSB7CgkgICAgICAgICAgICByZXR1cm4ga2IuaWdub3JlKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICBpZiAoKGtiLnV0aWxzLndyYXBwZWRPYmplY3QoX3RoaXMpID09PSBuZXdfbW9kZWwpIHx8IGtiLndhc1JlbGVhc2VkKF90aGlzKSB8fCAhZXZlbnRfd2F0Y2hlcikgewoJICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICBfdGhpcy5fX2tiLnN0b3JlLnJldXNlKF90aGlzLCBrYi51dGlscy5yZXNvbHZlTW9kZWwobmV3X21vZGVsKSk7CgkgICAgICAgICAgICAgIGV2ZW50X3dhdGNoZXIuZW1pdHRlcihuZXdfbW9kZWwpOwoJICAgICAgICAgICAgICBfbW9kZWwoZXZlbnRfd2F0Y2hlci5lZSk7CgkgICAgICAgICAgICAgIHJldHVybiAhZXZlbnRfd2F0Y2hlci5lZSB8fCBfdGhpcy5jcmVhdGVPYnNlcnZhYmxlcyhldmVudF93YXRjaGVyLmVlKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgICAgIGV2ZW50X3dhdGNoZXIgPSBrYi51dGlscy53cmFwcGVkRXZlbnRXYXRjaGVyKF90aGlzLCBuZXcga2IuRXZlbnRXYXRjaGVyKG1vZGVsLCBfdGhpcywgewoJICAgICAgICAgIGVtaXR0ZXI6IF90aGlzLl9tb2RlbCwKCSAgICAgICAgICB1cGRhdGU6IChmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgIHJldHVybiAhKGV2ZW50X3dhdGNoZXIgIT0gbnVsbCA/IGV2ZW50X3dhdGNoZXIuZWUgOiB2b2lkIDApIHx8IF90aGlzLmNyZWF0ZU9ic2VydmFibGVzKGV2ZW50X3dhdGNoZXIgIT0gbnVsbCA/IGV2ZW50X3dhdGNoZXIuZWUgOiB2b2lkIDApOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgICAgfSkKCSAgICAgICAgfSkpOwoJICAgICAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KF90aGlzLCBtb2RlbCA9IGV2ZW50X3dhdGNoZXIuZWUpOwoJICAgICAgICBfbW9kZWwoZXZlbnRfd2F0Y2hlci5lZSk7CgkgICAgICAgIF90aGlzLl9fa2IuY3JlYXRlX29wdGlvbnMgPSB7CgkgICAgICAgICAgc3RvcmU6IGtiLnV0aWxzLndyYXBwZWRTdG9yZShfdGhpcyksCgkgICAgICAgICAgZmFjdG9yeToga2IudXRpbHMud3JhcHBlZEZhY3RvcnkoX3RoaXMpLAoJICAgICAgICAgIHBhdGg6IF90aGlzLl9fa2IucGF0aCwKCSAgICAgICAgICBldmVudF93YXRjaGVyOiBrYi51dGlscy53cmFwcGVkRXZlbnRXYXRjaGVyKF90aGlzKQoJICAgICAgICB9OwoJICAgICAgICAhb3B0aW9ucy5yZXF1aXJlcyB8fCBfdGhpcy5jcmVhdGVPYnNlcnZhYmxlcyhtb2RlbCwgb3B0aW9ucy5yZXF1aXJlcyk7CgkgICAgICAgICFfdGhpcy5fX2tiLmludGVybmFscyB8fCBfdGhpcy5jcmVhdGVPYnNlcnZhYmxlcyhtb2RlbCwgX3RoaXMuX19rYi5pbnRlcm5hbHMpOwoJICAgICAgICAhb3B0aW9ucy5tYXBwaW5ncyB8fCBfdGhpcy5jcmVhdGVPYnNlcnZhYmxlcyhtb2RlbCwgb3B0aW9ucy5tYXBwaW5ncyk7CgkgICAgICAgICFfdGhpcy5fX2tiLnN0YXRpY3MgfHwgY3JlYXRlU3RhdGljT2JzZXJ2YWJsZXMoX3RoaXMsIG1vZGVsKTsKCSAgICAgICAgX3RoaXMuY3JlYXRlT2JzZXJ2YWJsZXMobW9kZWwsIF90aGlzLl9fa2Iua2V5cyk7CgkgICAgICAgICFrYi5zdGF0aXN0aWNzIHx8IGtiLnN0YXRpc3RpY3MucmVnaXN0ZXIoJ1ZpZXdNb2RlbCcsIF90aGlzKTsKCSAgICAgICAgcmV0dXJuIF90aGlzOwoJICAgICAgfTsKCSAgICB9KSh0aGlzKSk7CgkgIH0KCgkgIFZpZXdNb2RlbC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciB2bV9rZXk7CgkgICAgdGhpcy5fX2tiX3JlbGVhc2VkID0gdHJ1ZTsKCSAgICBpZiAodGhpcy5fX2tiLnZpZXdfbW9kZWwgIT09IHRoaXMpIHsKCSAgICAgIGZvciAodm1fa2V5IGluIHRoaXMuX19rYi52bV9rZXlzKSB7CgkgICAgICAgIHRoaXMuX19rYi52aWV3X21vZGVsW3ZtX2tleV0gPSBudWxsOwoJICAgICAgfQoJICAgIH0KCSAgICB0aGlzLl9fa2Iudmlld19tb2RlbCA9IHRoaXMuX19rYi5jcmVhdGVfb3B0aW9ucyA9IG51bGw7CgkgICAga2IucmVsZWFzZUtleXModGhpcyk7CgkgICAga2IudXRpbHMud3JhcHBlZERlc3Ryb3kodGhpcyk7CgkgICAgcmV0dXJuICFrYi5zdGF0aXN0aWNzIHx8IGtiLnN0YXRpc3RpY3MudW5yZWdpc3RlcignVmlld01vZGVsJywgdGhpcyk7CgkgIH07CgoJICBWaWV3TW9kZWwucHJvdG90eXBlLnNoYXJlT3B0aW9ucyA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiB7CgkgICAgICBzdG9yZToga2IudXRpbHMud3JhcHBlZFN0b3JlKHRoaXMpLAoJICAgICAgZmFjdG9yeToga2IudXRpbHMud3JhcHBlZEZhY3RvcnkodGhpcykKCSAgICB9OwoJICB9OwoKCSAgVmlld01vZGVsLnByb3RvdHlwZS5jcmVhdGVPYnNlcnZhYmxlcyA9IGZ1bmN0aW9uKG1vZGVsLCBrZXlzKSB7CgkgICAgdmFyIGtleSwgbWFwcGluZ19pbmZvLCByZWxfa2V5cywgdm1fa2V5LCBfaSwgX2osIF9sZW4sIF9sZW4xLCBfcmVmMTsKCSAgICBpZiAoIWtleXMpIHsKCSAgICAgIGlmICh0aGlzLl9fa2Iua2V5cyB8fCAhbW9kZWwpIHsKCSAgICAgICAgcmV0dXJuOwoJICAgICAgfQoJICAgICAgZm9yIChrZXkgaW4gbW9kZWwuYXR0cmlidXRlcykgewoJICAgICAgICBjcmVhdGVPYnNlcnZhYmxlKHRoaXMsIG1vZGVsLCBrZXksIHRoaXMuX19rYi5jcmVhdGVfb3B0aW9ucyk7CgkgICAgICB9CgkgICAgICBpZiAocmVsX2tleXMgPSAoX3JlZjEgPSBrYi5vcm0pICE9IG51bGwgPyB0eXBlb2YgX3JlZjEua2V5cyA9PT0gImZ1bmN0aW9uIiA/IF9yZWYxLmtleXMobW9kZWwpIDogdm9pZCAwIDogdm9pZCAwKSB7CgkgICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gcmVsX2tleXMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgICAgICBrZXkgPSByZWxfa2V5c1tfaV07CgkgICAgICAgICAgY3JlYXRlT2JzZXJ2YWJsZSh0aGlzLCBtb2RlbCwga2V5LCB0aGlzLl9fa2IuY3JlYXRlX29wdGlvbnMpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfSBlbHNlIGlmIChfLmlzQXJyYXkoa2V5cykpIHsKCSAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IGtleXMubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CgkgICAgICAgIGtleSA9IGtleXNbX2pdOwoJICAgICAgICBjcmVhdGVPYnNlcnZhYmxlKHRoaXMsIG1vZGVsLCBrZXksIHRoaXMuX19rYi5jcmVhdGVfb3B0aW9ucyk7CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIGZvciAoa2V5IGluIGtleXMpIHsKCSAgICAgICAgbWFwcGluZ19pbmZvID0ga2V5c1trZXldOwoJICAgICAgICBpZiAoISh2bV9rZXkgPSBhc3NpZ25WaWV3TW9kZWxLZXkodGhpcywga2V5KSkpIHsKCSAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgfQoJICAgICAgICBpZiAoIV8uaXNTdHJpbmcobWFwcGluZ19pbmZvKSkgewoJICAgICAgICAgIG1hcHBpbmdfaW5mby5rZXkgfHwgKG1hcHBpbmdfaW5mby5rZXkgPSB2bV9rZXkpOwoJICAgICAgICB9CgkgICAgICAgIHRoaXNbdm1fa2V5XSA9IHRoaXMuX19rYi52aWV3X21vZGVsW3ZtX2tleV0gPSBrYi5vYnNlcnZhYmxlKG1vZGVsLCBtYXBwaW5nX2luZm8sIHRoaXMuX19rYi5jcmVhdGVfb3B0aW9ucywgdGhpcyk7CgkgICAgICB9CgkgICAgfQoJICB9OwoKCSAgcmV0dXJuIFZpZXdNb2RlbDsKCgl9KSgpOwoKCWtiLnZpZXdNb2RlbCA9IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zLCB2aWV3X21vZGVsKSB7CgkgIHJldHVybiBuZXcga2IuVmlld01vZGVsKGFyZ3VtZW50cyk7Cgl9OwoKCi8qKiovIH0sCi8qIDE0ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGtiLCBrZXksIF9pLCBfbGVuLCBfcmVmOwoKCW1vZHVsZS5leHBvcnRzID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpOwoKCWtiLmNvbmZpZ3VyZSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7CgoJa2IubW9kdWxlcyA9IHsKCSAgdW5kZXJzY29yZToga2IuXywKCSAgYmFja2JvbmU6IGtiLlBhcnNlIHx8IGtiLkJhY2tib25lLAoJICBrbm9ja291dDoga2Iua28KCX07CgoJaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdyAhPT0gbnVsbCkgewoJICBfcmVmID0gWydfJywgJ0JhY2tib25lJywgJ1BhcnNlJywgJ2tvJywgJyQnXTsKCSAgZm9yIChfaSA9IDAsIF9sZW4gPSBfcmVmLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAga2V5ID0gX3JlZltfaV07CgkgICAgaWYgKGtiW2tleV0gJiYgIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh3aW5kb3csIGtleSkpIHsKCSAgICAgIHdpbmRvd1trZXldID0ga2Jba2V5XTsKCSAgICB9CgkgIH0KCX0KCgovKioqLyB9LAovKiAxNSAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciBLRVlTX1BVQkxJU0gsIGtiLCBrbywgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBrbyA9IF9yZWYua287CgoJX193ZWJwYWNrX3JlcXVpcmVfXygyMSk7CgoJS0VZU19QVUJMSVNIID0gWydkZXN0cm95JywgJ3NldFRvRGVmYXVsdCddOwoKCW1vZHVsZS5leHBvcnRzID0ga2IuRGVmYXVsdE9ic2VydmFibGUgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIERlZmF1bHRPYnNlcnZhYmxlKHRhcmdldF9vYnNlcnZhYmxlLCBkdikgewoJICAgIHZhciBvYnNlcnZhYmxlOwoJICAgIHRoaXMuZHYgPSBkdjsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcywga28uY29tcHV0ZWQoewoJICAgICAgcmVhZDogKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgICB2YXIgY3VycmVudF90YXJnZXQ7CgkgICAgICAgICAgY3VycmVudF90YXJnZXQgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHRhcmdldF9vYnNlcnZhYmxlKCkpOwoJICAgICAgICAgIGlmIChfLmlzTnVsbChjdXJyZW50X3RhcmdldCkgfHwgXy5pc1VuZGVmaW5lZChjdXJyZW50X3RhcmdldCkpIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKF90aGlzLmR2KTsKCSAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRfdGFyZ2V0OwoJICAgICAgICAgIH0KCSAgICAgICAgfTsKCSAgICAgIH0pKHRoaXMpLAoJICAgICAgd3JpdGU6IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgICAgIHJldHVybiB0YXJnZXRfb2JzZXJ2YWJsZSh2YWx1ZSk7CgkgICAgICB9CgkgICAgfSkpOwoJICAgIGtiLnB1Ymxpc2hNZXRob2RzKG9ic2VydmFibGUsIHRoaXMsIEtFWVNfUFVCTElTSCk7CgkgICAgcmV0dXJuIG9ic2VydmFibGU7CgkgIH0KCgkgIERlZmF1bHRPYnNlcnZhYmxlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIGtiLnV0aWxzLndyYXBwZWREZXN0cm95KHRoaXMpOwoJICB9OwoKCSAgRGVmYXVsdE9ic2VydmFibGUucHJvdG90eXBlLnNldFRvRGVmYXVsdCA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZSh0aGlzKSh0aGlzLmR2KTsKCSAgfTsKCgkgIHJldHVybiBEZWZhdWx0T2JzZXJ2YWJsZTsKCgl9KSgpOwoKCWtiLmRlZmF1bHRPYnNlcnZhYmxlID0gZnVuY3Rpb24odGFyZ2V0LCBkZWZhdWx0X3ZhbHVlKSB7CgkgIHJldHVybiBuZXcga2IuRGVmYXVsdE9ic2VydmFibGUodGFyZ2V0LCBkZWZhdWx0X3ZhbHVlKTsKCX07CgoKLyoqKi8gfSwKLyogMTYgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgYXJyYXlTbGljZSwga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglhcnJheVNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKCWtiLnRvRm9ybWF0dGVkU3RyaW5nID0gZnVuY3Rpb24oZm9ybWF0KSB7CgkgIHZhciBhcmcsIGFyZ3MsIGluZGV4LCBwYXJhbWV0ZXJfaW5kZXgsIHJlc3VsdCwgdmFsdWU7CgkgIHJlc3VsdCA9IGZvcm1hdC5zbGljZSgpOwoJICBhcmdzID0gYXJyYXlTbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgkgIGZvciAoaW5kZXggaW4gYXJncykgewoJICAgIGFyZyA9IGFyZ3NbaW5kZXhdOwoJICAgIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShhcmcpOwoJICAgIGlmIChfLmlzVW5kZWZpbmVkKHZhbHVlKSB8fCBfLmlzTnVsbCh2YWx1ZSkpIHsKCSAgICAgIHZhbHVlID0gJyc7CgkgICAgfQoJICAgIHBhcmFtZXRlcl9pbmRleCA9IGZvcm1hdC5pbmRleE9mKCJceyIgKyBpbmRleCArICJcfSIpOwoJICAgIHdoaWxlIChwYXJhbWV0ZXJfaW5kZXggPj0gMCkgewoJICAgICAgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoInsiICsgaW5kZXggKyAifSIsIHZhbHVlKTsKCSAgICAgIHBhcmFtZXRlcl9pbmRleCA9IGZvcm1hdC5pbmRleE9mKCJceyIgKyBpbmRleCArICJcfSIsIHBhcmFtZXRlcl9pbmRleCArIDEpOwoJICAgIH0KCSAgfQoJICByZXR1cm4gcmVzdWx0OwoJfTsKCglrYi5wYXJzZUZvcm1hdHRlZFN0cmluZyA9IGZ1bmN0aW9uKHN0cmluZywgZm9ybWF0KSB7CgkgIHZhciBjb3VudCwgZm9ybWF0X2luZGljZXNfdG9fbWF0Y2hlZF9pbmRpY2VzLCBpbmRleCwgbWF0Y2hfaW5kZXgsIG1hdGNoZXMsIHBhcmFtZXRlcl9jb3VudCwgcGFyYW1ldGVyX2luZGV4LCBwb3NpdGlvbnMsIHJlZ2V4LCByZWdleF9zdHJpbmcsIHJlc3VsdCwgcmVzdWx0cywgc29ydGVkX3Bvc2l0aW9uczsKCSAgcmVnZXhfc3RyaW5nID0gZm9ybWF0LnNsaWNlKCk7CgkgIGluZGV4ID0gMDsKCSAgcGFyYW1ldGVyX2NvdW50ID0gMDsKCSAgcG9zaXRpb25zID0ge307CgkgIHdoaWxlIChyZWdleF9zdHJpbmcuc2VhcmNoKCJcXHsiICsgaW5kZXggKyAiXFx9IikgPj0gMCkgewoJICAgIHBhcmFtZXRlcl9pbmRleCA9IGZvcm1hdC5pbmRleE9mKCJceyIgKyBpbmRleCArICJcfSIpOwoJICAgIHdoaWxlIChwYXJhbWV0ZXJfaW5kZXggPj0gMCkgewoJICAgICAgcmVnZXhfc3RyaW5nID0gcmVnZXhfc3RyaW5nLnJlcGxhY2UoIlx7IiArIGluZGV4ICsgIlx9IiwgJyguKiknKTsKCSAgICAgIHBvc2l0aW9uc1twYXJhbWV0ZXJfaW5kZXhdID0gaW5kZXg7CgkgICAgICBwYXJhbWV0ZXJfY291bnQrKzsKCSAgICAgIHBhcmFtZXRlcl9pbmRleCA9IGZvcm1hdC5pbmRleE9mKCJceyIgKyBpbmRleCArICJcfSIsIHBhcmFtZXRlcl9pbmRleCArIDEpOwoJICAgIH0KCSAgICBpbmRleCsrOwoJICB9CgkgIGNvdW50ID0gaW5kZXg7CgkgIHJlZ2V4ID0gbmV3IFJlZ0V4cChyZWdleF9zdHJpbmcpOwoJICBtYXRjaGVzID0gcmVnZXguZXhlYyhzdHJpbmcpOwoJICBpZiAobWF0Y2hlcykgewoJICAgIG1hdGNoZXMuc2hpZnQoKTsKCSAgfQoJICBpZiAoIW1hdGNoZXMgfHwgKG1hdGNoZXMubGVuZ3RoICE9PSBwYXJhbWV0ZXJfY291bnQpKSB7CgkgICAgcmVzdWx0ID0gW107CgkgICAgd2hpbGUgKGNvdW50LS0gPiAwKSB7CgkgICAgICByZXN1bHQucHVzaCgnJyk7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH0KCSAgc29ydGVkX3Bvc2l0aW9ucyA9IF8uc29ydEJ5KF8ua2V5cyhwb3NpdGlvbnMpLCBmdW5jdGlvbihwYXJhbWV0ZXJfaW5kZXgsIGZvcm1hdF9pbmRleCkgewoJICAgIHJldHVybiBwYXJzZUludChwYXJhbWV0ZXJfaW5kZXgsIDEwKTsKCSAgfSk7CgkgIGZvcm1hdF9pbmRpY2VzX3RvX21hdGNoZWRfaW5kaWNlcyA9IHt9OwoJICBmb3IgKG1hdGNoX2luZGV4IGluIHNvcnRlZF9wb3NpdGlvbnMpIHsKCSAgICBwYXJhbWV0ZXJfaW5kZXggPSBzb3J0ZWRfcG9zaXRpb25zW21hdGNoX2luZGV4XTsKCSAgICBpbmRleCA9IHBvc2l0aW9uc1twYXJhbWV0ZXJfaW5kZXhdOwoJICAgIGlmIChmb3JtYXRfaW5kaWNlc190b19tYXRjaGVkX2luZGljZXMuaGFzT3duUHJvcGVydHkoaW5kZXgpKSB7CgkgICAgICBjb250aW51ZTsKCSAgICB9CgkgICAgZm9ybWF0X2luZGljZXNfdG9fbWF0Y2hlZF9pbmRpY2VzW2luZGV4XSA9IG1hdGNoX2luZGV4OwoJICB9CgkgIHJlc3VsdHMgPSBbXTsKCSAgaW5kZXggPSAwOwoJICB3aGlsZSAoaW5kZXggPCBjb3VudCkgewoJICAgIHJlc3VsdHMucHVzaChtYXRjaGVzW2Zvcm1hdF9pbmRpY2VzX3RvX21hdGNoZWRfaW5kaWNlc1tpbmRleF1dKTsKCSAgICBpbmRleCsrOwoJICB9CgkgIHJldHVybiByZXN1bHRzOwoJfTsKCgltb2R1bGUuZXhwb3J0cyA9IGtiLkZvcm1hdHRlZE9ic2VydmFibGUgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIEZvcm1hdHRlZE9ic2VydmFibGUoZm9ybWF0LCBhcmdzKSB7CgkgICAgdmFyIG9ic2VydmFibGUsIG9ic2VydmFibGVfYXJnczsKCSAgICBpZiAoXy5pc0FycmF5KGFyZ3MpKSB7CgkgICAgICBmb3JtYXQgPSBmb3JtYXQ7CgkgICAgICBvYnNlcnZhYmxlX2FyZ3MgPSBhcmdzOwoJICAgIH0gZWxzZSB7CgkgICAgICBvYnNlcnZhYmxlX2FyZ3MgPSBhcnJheVNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCSAgICB9CgkgICAgb2JzZXJ2YWJsZSA9IGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKHRoaXMsIGtvLmNvbXB1dGVkKHsKCSAgICAgIHJlYWQ6IGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgYXJnLCBfaSwgX2xlbjsKCSAgICAgICAgYXJncyA9IFtrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGZvcm1hdCldOwoJICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IG9ic2VydmFibGVfYXJncy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgICAgIGFyZyA9IG9ic2VydmFibGVfYXJnc1tfaV07CgkgICAgICAgICAgYXJncy5wdXNoKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYXJnKSk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIGtiLnRvRm9ybWF0dGVkU3RyaW5nLmFwcGx5KG51bGwsIGFyZ3MpOwoJICAgICAgfSwKCSAgICAgIHdyaXRlOiBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgICB2YXIgaW5kZXgsIG1hdGNoZXMsIG1heF9jb3VudDsKCSAgICAgICAgbWF0Y2hlcyA9IGtiLnBhcnNlRm9ybWF0dGVkU3RyaW5nKHZhbHVlLCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGZvcm1hdCkpOwoJICAgICAgICBtYXhfY291bnQgPSBNYXRoLm1pbihvYnNlcnZhYmxlX2FyZ3MubGVuZ3RoLCBtYXRjaGVzLmxlbmd0aCk7CgkgICAgICAgIGluZGV4ID0gMDsKCSAgICAgICAgd2hpbGUgKGluZGV4IDwgbWF4X2NvdW50KSB7CgkgICAgICAgICAgb2JzZXJ2YWJsZV9hcmdzW2luZGV4XShtYXRjaGVzW2luZGV4XSk7CgkgICAgICAgICAgaW5kZXgrKzsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH0pKTsKCSAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgfQoKCSAgRm9ybWF0dGVkT2JzZXJ2YWJsZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkRGVzdHJveSh0aGlzKTsKCSAgfTsKCgkgIHJldHVybiBGb3JtYXR0ZWRPYnNlcnZhYmxlOwoKCX0pKCk7CgoJa2IuZm9ybWF0dGVkT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uKGZvcm1hdCwgYXJncykgewoJICByZXR1cm4gbmV3IGtiLkZvcm1hdHRlZE9ic2VydmFibGUoZm9ybWF0LCBhcnJheVNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7Cgl9OwoKCi8qKiovIH0sCi8qIDE3ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIEtFWVNfUFVCTElTSCwga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglLRVlTX1BVQkxJU0ggPSBbJ2Rlc3Ryb3knLCAnb2JzZXJ2ZWRWYWx1ZScsICdyZXNldFRvQ3VycmVudCddOwoKCWtiLmxvY2FsZV9tYW5hZ2VyIHx8IChrYi5sb2NhbGVfbWFuYWdlciA9IHZvaWQgMCk7CgoJbW9kdWxlLmV4cG9ydHMgPSBrYi5Mb2NhbGl6ZWRPYnNlcnZhYmxlID0gKGZ1bmN0aW9uKCkgewoJICBMb2NhbGl6ZWRPYnNlcnZhYmxlLmV4dGVuZCA9IGtiLmV4dGVuZDsKCgkgIGZ1bmN0aW9uIExvY2FsaXplZE9ic2VydmFibGUodmFsdWUsIG9wdGlvbnMsIHZtKSB7CgkgICAgdmFyIG9ic2VydmFibGU7CgkgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwoJICAgIHRoaXMudm0gPSB2bTsKCSAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgIHRoaXMudm0gfHwgKHRoaXMudm0gPSB7fSk7CgkgICAgdGhpcy5yZWFkIHx8IGtiLl90aHJvd01pc3NpbmcodGhpcywgJ3JlYWQnKTsKCSAgICBrYi5sb2NhbGVfbWFuYWdlciB8fCBrYi5fdGhyb3dNaXNzaW5nKHRoaXMsICdrYi5sb2NhbGVfbWFuYWdlcicpOwoJICAgIHRoaXMuX19rYiB8fCAodGhpcy5fX2tiID0ge30pOwoJICAgIHRoaXMuX19rYi5fb25Mb2NhbGVDaGFuZ2UgPSBfLmJpbmQodGhpcy5fb25Mb2NhbGVDaGFuZ2UsIHRoaXMpOwoJICAgIHRoaXMuX19rYi5fb25DaGFuZ2UgPSBvcHRpb25zLm9uQ2hhbmdlOwoJICAgIGlmICh0aGlzLnZhbHVlKSB7CgkgICAgICB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodGhpcy52YWx1ZSk7CgkgICAgfQoJICAgIHRoaXMudm8gPSBrby5vYnNlcnZhYmxlKCF2YWx1ZSA/IG51bGwgOiB0aGlzLnJlYWQodmFsdWUsIG51bGwpKTsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcywga28uY29tcHV0ZWQoewoJICAgICAgcmVhZDogKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgICBpZiAoX3RoaXMudmFsdWUpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoX3RoaXMudmFsdWUpOwoJICAgICAgICAgIH0KCSAgICAgICAgICBfdGhpcy52bygpOwoJICAgICAgICAgIHJldHVybiBfdGhpcy5yZWFkKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoX3RoaXMudmFsdWUpKTsKCSAgICAgICAgfTsKCSAgICAgIH0pKHRoaXMpLAoJICAgICAgd3JpdGU6IChmdW5jdGlvbihfdGhpcykgewoJICAgICAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKCSAgICAgICAgICBfdGhpcy53cml0ZSB8fCBrYi5fdGhyb3dVbmV4cGVjdGVkKF90aGlzLCAnd3JpdGluZyB0byByZWFkLW9ubHknKTsKCSAgICAgICAgICBfdGhpcy53cml0ZSh2YWx1ZSwga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShfdGhpcy52YWx1ZSkpOwoJICAgICAgICAgIF90aGlzLnZvKHZhbHVlKTsKCSAgICAgICAgICBpZiAoX3RoaXMuX19rYi5fb25DaGFuZ2UpIHsKCSAgICAgICAgICAgIHJldHVybiBfdGhpcy5fX2tiLl9vbkNoYW5nZSh2YWx1ZSk7CgkgICAgICAgICAgfQoJICAgICAgICB9OwoJICAgICAgfSkodGhpcyksCgkgICAgICBvd25lcjogdGhpcy52bQoJICAgIH0pKTsKCSAgICBrYi5wdWJsaXNoTWV0aG9kcyhvYnNlcnZhYmxlLCB0aGlzLCBLRVlTX1BVQkxJU0gpOwoJICAgIGtiLmxvY2FsZV9tYW5hZ2VyLmJpbmQoJ2NoYW5nZScsIHRoaXMuX19rYi5fb25Mb2NhbGVDaGFuZ2UpOwoJICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCdkZWZhdWx0JykpIHsKCSAgICAgIG9ic2VydmFibGUgPSBrYi5EZWZhdWx0T2JzZXJ2YWJsZSAmJiBrby5kZWZhdWx0T2JzZXJ2YWJsZShvYnNlcnZhYmxlLCBvcHRpb25zWyJkZWZhdWx0Il0pOwoJICAgIH0KCSAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgfQoKCSAgTG9jYWxpemVkT2JzZXJ2YWJsZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIGtiLmxvY2FsZV9tYW5hZ2VyLnVuYmluZCgnY2hhbmdlJywgdGhpcy5fX2tiLl9vbkxvY2FsZUNoYW5nZSk7CgkgICAgdGhpcy52bSA9IG51bGw7CgkgICAgcmV0dXJuIGtiLnV0aWxzLndyYXBwZWREZXN0cm95KHRoaXMpOwoJICB9OwoKCSAgTG9jYWxpemVkT2JzZXJ2YWJsZS5wcm90b3R5cGUucmVzZXRUb0N1cnJlbnQgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgY3VycmVudF92YWx1ZSwgb2JzZXJ2YWJsZTsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcyk7CgkgICAgY3VycmVudF92YWx1ZSA9IHRoaXMudmFsdWUgPyB0aGlzLnJlYWQoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh0aGlzLnZhbHVlKSkgOiBudWxsOwoJICAgIGlmIChvYnNlcnZhYmxlKCkgPT09IGN1cnJlbnRfdmFsdWUpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgcmV0dXJuIG9ic2VydmFibGUoY3VycmVudF92YWx1ZSk7CgkgIH07CgoJICBMb2NhbGl6ZWRPYnNlcnZhYmxlLnByb3RvdHlwZS5vYnNlcnZlZFZhbHVlID0gZnVuY3Rpb24odmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewoJICAgICAgcmV0dXJuIHRoaXMudmFsdWU7CgkgICAgfQoJICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKCSAgICB0aGlzLl9vbkxvY2FsZUNoYW5nZSgpOwoJICB9OwoKCSAgTG9jYWxpemVkT2JzZXJ2YWJsZS5wcm90b3R5cGUuX29uTG9jYWxlQ2hhbmdlID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIHZhbHVlOwoJICAgIHZhbHVlID0gdGhpcy5yZWFkKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodGhpcy52YWx1ZSkpOwoJICAgIHRoaXMudm8odmFsdWUpOwoJICAgIGlmICh0aGlzLl9fa2IuX29uQ2hhbmdlKSB7CgkgICAgICByZXR1cm4gdGhpcy5fX2tiLl9vbkNoYW5nZSh2YWx1ZSk7CgkgICAgfQoJICB9OwoKCSAgcmV0dXJuIExvY2FsaXplZE9ic2VydmFibGU7CgoJfSkoKTsKCglrYi5sb2NhbGl6ZWRPYnNlcnZhYmxlID0gZnVuY3Rpb24odmFsdWUsIG9wdGlvbnMsIHZpZXdfbW9kZWwpIHsKCSAgcmV0dXJuIG5ldyBrYi5Mb2NhbGl6ZWRPYnNlcnZhYmxlKHZhbHVlLCBvcHRpb25zLCB2aWV3X21vZGVsKTsKCX07CgoKLyoqKi8gfSwKLyogMTggKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgS0VZU19QVUJMSVNILCBrYiwga28sIF8sIF9yZWY7CgoJX3JlZiA9IGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSwgXyA9IF9yZWYuXywga28gPSBfcmVmLmtvOwoKCUtFWVNfUFVCTElTSCA9IFsnZGVzdHJveSddOwoKCW1vZHVsZS5leHBvcnRzID0ga2IuVHJpZ2dlcmVkT2JzZXJ2YWJsZSA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gVHJpZ2dlcmVkT2JzZXJ2YWJsZShlbWl0dGVyLCBldmVudF9zZWxlY3RvcikgewoJICAgIHZhciBvYnNlcnZhYmxlOwoJICAgIHRoaXMuZXZlbnRfc2VsZWN0b3IgPSBldmVudF9zZWxlY3RvcjsKCSAgICBlbWl0dGVyIHx8IGtiLl90aHJvd01pc3NpbmcodGhpcywgJ2VtaXR0ZXInKTsKCSAgICB0aGlzLmV2ZW50X3NlbGVjdG9yIHx8IGtiLl90aHJvd01pc3NpbmcodGhpcywgJ2V2ZW50X3NlbGVjdG9yJyk7CgkgICAgdGhpcy52byA9IGtvLm9ic2VydmFibGUoKTsKCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcywga28uY29tcHV0ZWQoKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgIHJldHVybiBfdGhpcy52bygpOwoJICAgICAgfTsKCSAgICB9KSh0aGlzKSkpOwoJICAgIGtiLnB1Ymxpc2hNZXRob2RzKG9ic2VydmFibGUsIHRoaXMsIEtFWVNfUFVCTElTSCk7CgkgICAga2IudXRpbHMud3JhcHBlZEV2ZW50V2F0Y2hlcih0aGlzLCBuZXcga2IuRXZlbnRXYXRjaGVyKGVtaXR0ZXIsIHRoaXMsIHsKCSAgICAgIGVtaXR0ZXI6IF8uYmluZCh0aGlzLmVtaXR0ZXIsIHRoaXMpLAoJICAgICAgdXBkYXRlOiBfLmJpbmQodGhpcy51cGRhdGUsIHRoaXMpLAoJICAgICAgZXZlbnRfc2VsZWN0b3I6IHRoaXMuZXZlbnRfc2VsZWN0b3IKCSAgICB9KSk7CgkgICAgcmV0dXJuIG9ic2VydmFibGU7CgkgIH0KCgkgIFRyaWdnZXJlZE9ic2VydmFibGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4ga2IudXRpbHMud3JhcHBlZERlc3Ryb3kodGhpcyk7CgkgIH07CgoJICBUcmlnZ2VyZWRPYnNlcnZhYmxlLnByb3RvdHlwZS5lbWl0dGVyID0gZnVuY3Rpb24obmV3X2VtaXR0ZXIpIHsKCSAgICBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHx8ICh0aGlzLmVlID09PSBuZXdfZW1pdHRlcikpIHsKCSAgICAgIHJldHVybiB0aGlzLmVlOwoJICAgIH0KCSAgICBpZiAoKHRoaXMuZWUgPSBuZXdfZW1pdHRlcikpIHsKCSAgICAgIHJldHVybiB0aGlzLnVwZGF0ZSgpOwoJICAgIH0KCSAgfTsKCgkgIFRyaWdnZXJlZE9ic2VydmFibGUucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKCkgewoJICAgIGlmICghdGhpcy5lZSkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBpZiAodGhpcy52bygpICE9PSB0aGlzLmVlKSB7CgkgICAgICByZXR1cm4gdGhpcy52byh0aGlzLmVlKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIHRoaXMudm8udmFsdWVIYXNNdXRhdGVkKCk7CgkgICAgfQoJICB9OwoKCSAgcmV0dXJuIFRyaWdnZXJlZE9ic2VydmFibGU7CgoJfSkoKTsKCglrYi50cmlnZ2VyZWRPYnNlcnZhYmxlID0gZnVuY3Rpb24oZW1pdHRlciwgZXZlbnRfc2VsZWN0b3IpIHsKCSAgcmV0dXJuIG5ldyBrYi5UcmlnZ2VyZWRPYnNlcnZhYmxlKGVtaXR0ZXIsIGV2ZW50X3NlbGVjdG9yKTsKCX07CgoKLyoqKi8gfSwKLyogMTkgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgJCwgY2FsbE9yR2V0LCBrYiwga28sIF8sIF9yZWY7CgoJX3JlZiA9IGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSwgXyA9IF9yZWYuXywga28gPSBfcmVmLmtvLCAkID0gX3JlZi4kOwoKCV9fd2VicGFja19yZXF1aXJlX18oMjIpOwoKCWNhbGxPckdldCA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkgIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZSk7CgkgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpIHsKCSAgICByZXR1cm4gdmFsdWUuYXBwbHkobnVsbCwgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CgkgIH0gZWxzZSB7CgkgICAgcmV0dXJuIHZhbHVlOwoJICB9Cgl9OwoKCW1vZHVsZS5leHBvcnRzID0ga2IuVmFsaWRhdGlvbiA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gVmFsaWRhdGlvbigpIHt9CgoJICByZXR1cm4gVmFsaWRhdGlvbjsKCgl9KSgpOwoKCWtiLnZhbHVlVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUsIGJpbmRpbmdzLCB2YWxpZGF0aW9uX29wdGlvbnMpIHsKCSAgaWYgKHZhbGlkYXRpb25fb3B0aW9ucyA9PSBudWxsKSB7CgkgICAgdmFsaWRhdGlvbl9vcHRpb25zID0ge307CgkgIH0KCSAgKHZhbGlkYXRpb25fb3B0aW9ucyAmJiAhKHR5cGVvZiB2YWxpZGF0aW9uX29wdGlvbnMgPT09ICdmdW5jdGlvbicpKSB8fCAodmFsaWRhdGlvbl9vcHRpb25zID0ge30pOwoJICByZXR1cm4ga28uY29tcHV0ZWQoZnVuY3Rpb24oKSB7CgkgICAgdmFyIGFjdGl2ZV9pbmRleCwgY3VycmVudF92YWx1ZSwgZGlzYWJsZWQsIGlkZW50aWZpZXIsIGlkZW50aWZpZXJfaW5kZXgsIHByaW9yaXRpZXMsIHJlc3VsdHMsIHZhbGlkYXRvcjsKCSAgICByZXN1bHRzID0gewoJICAgICAgJGVycm9yX2NvdW50OiAwCgkgICAgfTsKCSAgICBjdXJyZW50X3ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZSk7CgkgICAgISgnZGlzYWJsZScgaW4gdmFsaWRhdGlvbl9vcHRpb25zKSB8fCAoZGlzYWJsZWQgPSBjYWxsT3JHZXQodmFsaWRhdGlvbl9vcHRpb25zLmRpc2FibGUpKTsKCSAgICAhKCdlbmFibGUnIGluIHZhbGlkYXRpb25fb3B0aW9ucykgfHwgKGRpc2FibGVkID0gIWNhbGxPckdldCh2YWxpZGF0aW9uX29wdGlvbnMuZW5hYmxlKSk7CgkgICAgcHJpb3JpdGllcyA9IHZhbGlkYXRpb25fb3B0aW9ucy5wcmlvcml0aWVzIHx8IFtdOwoJICAgIF8uaXNBcnJheShwcmlvcml0aWVzKSB8fCAocHJpb3JpdGllcyA9IFtwcmlvcml0aWVzXSk7CgkgICAgYWN0aXZlX2luZGV4ID0gcHJpb3JpdGllcy5sZW5ndGggKyAxOwoJICAgIGZvciAoaWRlbnRpZmllciBpbiBiaW5kaW5ncykgewoJICAgICAgdmFsaWRhdG9yID0gYmluZGluZ3NbaWRlbnRpZmllcl07CgkgICAgICByZXN1bHRzW2lkZW50aWZpZXJdID0gIWRpc2FibGVkICYmIGNhbGxPckdldCh2YWxpZGF0b3IsIGN1cnJlbnRfdmFsdWUpOwoJICAgICAgaWYgKHJlc3VsdHNbaWRlbnRpZmllcl0pIHsKCSAgICAgICAgcmVzdWx0cy4kZXJyb3JfY291bnQrKzsKCSAgICAgICAgKGlkZW50aWZpZXJfaW5kZXggPSBfLmluZGV4T2YocHJpb3JpdGllcywgaWRlbnRpZmllcikgPj0gMCkgfHwgKGlkZW50aWZpZXJfaW5kZXggPSBwcmlvcml0aWVzLmxlbmd0aCk7CgkgICAgICAgIGlmIChyZXN1bHRzLiRhY3RpdmVfZXJyb3IgJiYgaWRlbnRpZmllcl9pbmRleCA8IGFjdGl2ZV9pbmRleCkgewoJICAgICAgICAgIHJlc3VsdHMuJGFjdGl2ZV9lcnJvciA9IGlkZW50aWZpZXI7CgkgICAgICAgICAgYWN0aXZlX2luZGV4ID0gaWRlbnRpZmllcl9pbmRleDsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICByZXN1bHRzLiRhY3RpdmVfZXJyb3IgfHwgKHJlc3VsdHMuJGFjdGl2ZV9lcnJvciA9IGlkZW50aWZpZXIsIGFjdGl2ZV9pbmRleCA9IGlkZW50aWZpZXJfaW5kZXgpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICAgIHJlc3VsdHMuJGVuYWJsZWQgPSAhZGlzYWJsZWQ7CgkgICAgcmVzdWx0cy4kZGlzYWJsZSA9ICEhZGlzYWJsZWQ7CgkgICAgcmVzdWx0cy4kdmFsaWQgPSByZXN1bHRzLiRlcnJvcl9jb3VudCA9PT0gMDsKCSAgICByZXR1cm4gcmVzdWx0czsKCSAgfSk7Cgl9OwoKCWtiLmlucHV0VmFsaWRhdG9yID0gZnVuY3Rpb24odmlld19tb2RlbCwgZWwsIHZhbGlkYXRpb25fb3B0aW9ucykgewoJICB2YXIgJGlucHV0X2VsLCBiaW5kaW5ncywgaWRlbnRpZmllciwgaW5wdXRfbmFtZSwgb3B0aW9ucywgcmVzdWx0LCB0eXBlLCB2YWxpZGF0b3IsIHZhbGlkYXRvcnMsIF9yZWYxOwoJICBpZiAodmFsaWRhdGlvbl9vcHRpb25zID09IG51bGwpIHsKCSAgICB2YWxpZGF0aW9uX29wdGlvbnMgPSB7fTsKCSAgfQoJICAodmFsaWRhdGlvbl9vcHRpb25zICYmICEodHlwZW9mIHZhbGlkYXRpb25fb3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykpIHx8ICh2YWxpZGF0aW9uX29wdGlvbnMgPSB7fSk7CgkgIHZhbGlkYXRvcnMgPSBrYi52YWxpZDsKCSAgJGlucHV0X2VsID0gJChlbCk7CgkgIGlmICgoaW5wdXRfbmFtZSA9ICRpbnB1dF9lbC5hdHRyKCduYW1lJykpICYmICFfLmlzU3RyaW5nKGlucHV0X25hbWUpKSB7CgkgICAgaW5wdXRfbmFtZSA9IG51bGw7CgkgIH0KCSAgaWYgKCEoYmluZGluZ3MgPSAkaW5wdXRfZWwuYXR0cignZGF0YS1iaW5kJykpKSB7CgkgICAgcmV0dXJuIG51bGw7CgkgIH0KCSAgb3B0aW9ucyA9IChuZXcgRnVuY3Rpb24oInNjIiwgIndpdGgoc2NbMF0pIHsgcmV0dXJuIHsgIiArIGJpbmRpbmdzICsgIiB9IH0iKSkoW3ZpZXdfbW9kZWxdKTsKCSAgaWYgKCEob3B0aW9ucyAmJiBvcHRpb25zLnZhbHVlKSkgewoJICAgIHJldHVybiBudWxsOwoJICB9CgkgICghb3B0aW9ucy52YWxpZGF0aW9uX29wdGlvbnMpIHx8IChfLmRlZmF1bHRzKG9wdGlvbnMudmFsaWRhdGlvbl9vcHRpb25zLCB2YWxpZGF0aW9uX29wdGlvbnMpLCB2YWxpZGF0aW9uX29wdGlvbnMgPSBvcHRpb25zLnZhbGlkYXRpb25fb3B0aW9ucyk7CgkgIGJpbmRpbmdzID0ge307CgkgICghdmFsaWRhdG9yc1t0eXBlID0gJGlucHV0X2VsLmF0dHIoJ3R5cGUnKV0pIHx8IChiaW5kaW5nc1t0eXBlXSA9IHZhbGlkYXRvcnNbdHlwZV0pOwoJICAoISRpbnB1dF9lbC5hdHRyKCdyZXF1aXJlZCcpKSB8fCAoYmluZGluZ3MucmVxdWlyZWQgPSB2YWxpZGF0b3JzLnJlcXVpcmVkKTsKCSAgaWYgKG9wdGlvbnMudmFsaWRhdGlvbnMpIHsKCSAgICBfcmVmMSA9IG9wdGlvbnMudmFsaWRhdGlvbnM7CgkgICAgZm9yIChpZGVudGlmaWVyIGluIF9yZWYxKSB7CgkgICAgICB2YWxpZGF0b3IgPSBfcmVmMVtpZGVudGlmaWVyXTsKCSAgICAgIGJpbmRpbmdzW2lkZW50aWZpZXJdID0gdmFsaWRhdG9yOwoJICAgIH0KCSAgfQoJICByZXN1bHQgPSBrYi52YWx1ZVZhbGlkYXRvcihvcHRpb25zLnZhbHVlLCBiaW5kaW5ncywgdmFsaWRhdGlvbl9vcHRpb25zKTsKCSAgKCFpbnB1dF9uYW1lICYmICF2YWxpZGF0aW9uX29wdGlvbnMubm9fYXR0YWNoKSB8fCAodmlld19tb2RlbFsiJCIgKyBpbnB1dF9uYW1lXSA9IHJlc3VsdCk7CgkgIHJldHVybiByZXN1bHQ7Cgl9OwoKCWtiLmZvcm1WYWxpZGF0b3IgPSBmdW5jdGlvbih2aWV3X21vZGVsLCBlbCkgewoJICB2YXIgJHJvb3RfZWwsIGJpbmRpbmdzLCBmb3JtX25hbWUsIGlucHV0X2VsLCBuYW1lLCBvcHRpb25zLCByZXN1bHRzLCB2YWxpZGF0aW9uX29wdGlvbnMsIHZhbGlkYXRvciwgdmFsaWRhdG9ycywgX2ksIF9sZW4sIF9yZWYxOwoJICByZXN1bHRzID0ge307CgkgIHZhbGlkYXRvcnMgPSBbXTsKCSAgJHJvb3RfZWwgPSAkKGVsKTsKCSAgaWYgKChmb3JtX25hbWUgPSAkcm9vdF9lbC5hdHRyKCduYW1lJykpICYmICFfLmlzU3RyaW5nKGZvcm1fbmFtZSkpIHsKCSAgICBmb3JtX25hbWUgPSBudWxsOwoJICB9CgkgIGlmICgoYmluZGluZ3MgPSAkcm9vdF9lbC5hdHRyKCdkYXRhLWJpbmQnKSkpIHsKCSAgICBvcHRpb25zID0gKG5ldyBGdW5jdGlvbigic2MiLCAid2l0aChzY1swXSkgeyByZXR1cm4geyAiICsgYmluZGluZ3MgKyAiIH0gfSIpKShbdmlld19tb2RlbF0pOwoJICAgIHZhbGlkYXRpb25fb3B0aW9ucyA9IG9wdGlvbnMudmFsaWRhdGlvbl9vcHRpb25zOwoJICB9CgkgIHZhbGlkYXRpb25fb3B0aW9ucyB8fCAodmFsaWRhdGlvbl9vcHRpb25zID0ge30pOwoJICB2YWxpZGF0aW9uX29wdGlvbnMubm9fYXR0YWNoID0gISFmb3JtX25hbWU7CgkgIF9yZWYxID0gJHJvb3RfZWwuZmluZCgnaW5wdXQnKTsKCSAgZm9yIChfaSA9IDAsIF9sZW4gPSBfcmVmMS5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgIGlucHV0X2VsID0gX3JlZjFbX2ldOwoJICAgIGlmICghKG5hbWUgPSAkKGlucHV0X2VsKS5hdHRyKCduYW1lJykpKSB7CgkgICAgICBjb250aW51ZTsKCSAgICB9CgkgICAgdmFsaWRhdG9yID0ga2IuaW5wdXRWYWxpZGF0b3Iodmlld19tb2RlbCwgaW5wdXRfZWwsIHZhbGlkYXRpb25fb3B0aW9ucyk7CgkgICAgIXZhbGlkYXRvciB8fCB2YWxpZGF0b3JzLnB1c2gocmVzdWx0c1tuYW1lXSA9IHZhbGlkYXRvcik7CgkgIH0KCSAgcmVzdWx0cy4kZXJyb3JfY291bnQgPSBrby5jb21wdXRlZChmdW5jdGlvbigpIHsKCSAgICB2YXIgZXJyb3JfY291bnQsIF9qLCBfbGVuMTsKCSAgICBlcnJvcl9jb3VudCA9IDA7CgkgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gdmFsaWRhdG9ycy5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKCSAgICAgIHZhbGlkYXRvciA9IHZhbGlkYXRvcnNbX2pdOwoJICAgICAgZXJyb3JfY291bnQgKz0gdmFsaWRhdG9yKCkuJGVycm9yX2NvdW50OwoJICAgIH0KCSAgICByZXR1cm4gZXJyb3JfY291bnQ7CgkgIH0pOwoJICByZXN1bHRzLiR2YWxpZCA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiByZXN1bHRzLiRlcnJvcl9jb3VudCgpID09PSAwOwoJICB9KTsKCSAgcmVzdWx0cy4kZW5hYmxlZCA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgIHZhciBlbmFibGVkLCBfaiwgX2xlbjE7CgkgICAgZW5hYmxlZCA9IHRydWU7CgkgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gdmFsaWRhdG9ycy5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKCSAgICAgIHZhbGlkYXRvciA9IHZhbGlkYXRvcnNbX2pdOwoJICAgICAgZW5hYmxlZCAmPSB2YWxpZGF0b3IoKS4kZW5hYmxlZDsKCSAgICB9CgkgICAgcmV0dXJuIGVuYWJsZWQ7CgkgIH0pOwoJICByZXN1bHRzLiRkaXNhYmxlZCA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiAhcmVzdWx0cy4kZW5hYmxlZCgpOwoJICB9KTsKCSAgaWYgKGZvcm1fbmFtZSkgewoJICAgIHZpZXdfbW9kZWxbIiQiICsgZm9ybV9uYW1lXSA9IHJlc3VsdHM7CgkgIH0KCSAgcmV0dXJuIHJlc3VsdHM7Cgl9OwoKCi8qKiovIH0sCi8qIDIwICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCW1vZHVsZS5leHBvcnRzID0gX19XRUJQQUNLX0VYVEVSTkFMX01PRFVMRV8yMF9fOwoKLyoqKi8gfSwKLyogMjEgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglrYi5PYnNlcnZhYmxlLnByb3RvdHlwZS5zZXRUb0RlZmF1bHQgPSBmdW5jdGlvbigpIHsKCSAgdmFyIF9yZWYxOwoJICBpZiAoKF9yZWYxID0gdGhpcy5fX2tiX3ZhbHVlKSAhPSBudWxsKSB7CgkgICAgaWYgKHR5cGVvZiBfcmVmMS5zZXRUb0RlZmF1bHQgPT09ICJmdW5jdGlvbiIpIHsKCSAgICAgIF9yZWYxLnNldFRvRGVmYXVsdCgpOwoJICAgIH0KCSAgfQoJfTsKCglrYi5WaWV3TW9kZWwucHJvdG90eXBlLnNldFRvRGVmYXVsdCA9IGZ1bmN0aW9uKCkgewoJICB2YXIgdm1fa2V5LCBfcmVmMTsKCSAgZm9yICh2bV9rZXkgaW4gdGhpcy5fX2tiLnZtX2tleXMpIHsKCSAgICBpZiAoKF9yZWYxID0gdGhpc1t2bV9rZXldKSAhPSBudWxsKSB7CgkgICAgICBpZiAodHlwZW9mIF9yZWYxLnNldFRvRGVmYXVsdCA9PT0gImZ1bmN0aW9uIikgewoJICAgICAgICBfcmVmMS5zZXRUb0RlZmF1bHQoKTsKCSAgICAgIH0KCSAgICB9CgkgIH0KCX07CgoJa2IudXRpbHMuc2V0VG9EZWZhdWx0ID0gZnVuY3Rpb24ob2JqKSB7CgkgIHZhciBrZXksIHZhbHVlOwoJICBpZiAoIW9iaikgewoJICAgIHJldHVybjsKCSAgfQoJICBpZiAoa28uaXNPYnNlcnZhYmxlKG9iaikpIHsKCSAgICBpZiAodHlwZW9mIG9iai5zZXRUb0RlZmF1bHQgPT09ICJmdW5jdGlvbiIpIHsKCSAgICAgIG9iai5zZXRUb0RlZmF1bHQoKTsKCSAgICB9CgkgIH0gZWxzZSBpZiAoXy5pc09iamVjdChvYmopKSB7CgkgICAgZm9yIChrZXkgaW4gb2JqKSB7CgkgICAgICB2YWx1ZSA9IG9ialtrZXldOwoJICAgICAgaWYgKHZhbHVlICYmIChrby5pc09ic2VydmFibGUodmFsdWUpIHx8ICh0eXBlb2YgdmFsdWUgIT09ICdmdW5jdGlvbicpKSAmJiAoKGtleVswXSAhPT0gJ18nKSB8fCBrZXkuc2VhcmNoKCdfX2tiJykpKSB7CgkgICAgICAgIHRoaXMuc2V0VG9EZWZhdWx0KHZhbHVlKTsKCSAgICAgIH0KCSAgICB9CgkgIH0KCSAgcmV0dXJuIG9iajsKCX07CgoKLyoqKi8gfSwKLyogMjIgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgJCwgRU1BSUxfUkVHRVhQLCBOVU1CRVJfUkVHRVhQLCBVUkxfUkVHRVhQLCBrYiwga28sIF8sIF9yZWY7CgoJX3JlZiA9IGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSwgXyA9IF9yZWYuXywga28gPSBfcmVmLmtvLCAkID0gX3JlZi4kOwoKCVVSTF9SRUdFWFAgPSAvXihmdHB8aHR0cHxodHRwcyk6XC9cLyhcdys6ezAsMX1cdypAKT8oXFMrKSg6WzAtOV0rKT8oXC98XC8oW1x3IyE6Lj8rPSYlQCFcLVwvXSkpPyQvOwoKCUVNQUlMX1JFR0VYUCA9IC9eW0EtWmEtejAtOS5fJSstXStAW0EtWmEtejAtOS4tXStcLltBLVphLXpdezIsNH0kLzsKCglOVU1CRVJfUkVHRVhQID0gL15ccyooXC18XCspPyhcZCt8KFxkKihcLlxkKikpKVxzKiQvOwoKCWtiLnZhbGlkID0gewoJICByZXF1aXJlZDogZnVuY3Rpb24odmFsdWUpIHsKCSAgICByZXR1cm4gIXZhbHVlOwoJICB9LAoJICB1cmw6IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgcmV0dXJuICFVUkxfUkVHRVhQLnRlc3QodmFsdWUpOwoJICB9LAoJICBlbWFpbDogZnVuY3Rpb24odmFsdWUpIHsKCSAgICByZXR1cm4gIUVNQUlMX1JFR0VYUC50ZXN0KHZhbHVlKTsKCSAgfSwKCSAgbnVtYmVyOiBmdW5jdGlvbih2YWx1ZSkgewoJICAgIHJldHVybiAhTlVNQkVSX1JFR0VYUC50ZXN0KHZhbHVlKTsKCSAgfQoJfTsKCglrYi5oYXNDaGFuZ2VkRm4gPSBmdW5jdGlvbihtb2RlbCkgewoJICB2YXIgYXR0cmlidXRlcywgbTsKCSAgbSA9IG51bGw7CgkgIGF0dHJpYnV0ZXMgPSBudWxsOwoJICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgdmFyIGN1cnJlbnRfbW9kZWw7CgkgICAgaWYgKG0gIT09IChjdXJyZW50X21vZGVsID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtb2RlbCkpKSB7CgkgICAgICBtID0gY3VycmVudF9tb2RlbDsKCSAgICAgIGF0dHJpYnV0ZXMgPSAobSA/IG0udG9KU09OKCkgOiBudWxsKTsKCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9CgkgICAgaWYgKCEobSAmJiBhdHRyaWJ1dGVzKSkgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICByZXR1cm4gIV8uaXNFcXVhbChtLnRvSlNPTigpLCBhdHRyaWJ1dGVzKTsKCSAgfTsKCX07CgoJa2IubWluTGVuZ3RoRm4gPSBmdW5jdGlvbihsZW5ndGgpIHsKCSAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgcmV0dXJuICF2YWx1ZSB8fCB2YWx1ZS5sZW5ndGggPCBsZW5ndGg7CgkgIH07Cgl9OwoKCWtiLnVuaXF1ZVZhbHVlRm4gPSBmdW5jdGlvbihtb2RlbCwga2V5LCBjb2xsZWN0aW9uKSB7CgkgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewoJICAgIHZhciBjLCBrLCBtOwoJICAgIG0gPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG1vZGVsKTsKCSAgICBrID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShrZXkpOwoJICAgIGMgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGNvbGxlY3Rpb24pOwoJICAgIGlmICghKG0gJiYgayAmJiBjKSkgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICByZXR1cm4gISFfLmZpbmQoYy5tb2RlbHMsIChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKHRlc3QpIHsKCSAgICAgICAgcmV0dXJuICh0ZXN0ICE9PSBtKSAmJiB0ZXN0LmdldChrKSA9PT0gdmFsdWU7CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKTsKCSAgfTsKCX07CgoJa2IudW50aWxUcnVlRm4gPSBmdW5jdGlvbihzdGFuZF9pbiwgZm4sIG1vZGVsKSB7CgkgIHZhciB3YXNfdHJ1ZTsKCSAgd2FzX3RydWUgPSBmYWxzZTsKCSAgaWYgKG1vZGVsICYmIGtvLmlzT2JzZXJ2YWJsZShtb2RlbCkpIHsKCSAgICBtb2RlbC5zdWJzY3JpYmUoZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gd2FzX3RydWUgPSBmYWxzZTsKCSAgICB9KTsKCSAgfQoJICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKCSAgICB2YXIgZiwgcmVzdWx0OwoJICAgIGlmICghKGYgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGZuKSkpIHsKCSAgICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHN0YW5kX2luKTsKCSAgICB9CgkgICAgd2FzX3RydWUgfD0gISEocmVzdWx0ID0gZihrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlKSkpOwoJICAgIHJldHVybiAod2FzX3RydWUgPyByZXN1bHQgOiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHN0YW5kX2luKSk7CgkgIH07Cgl9OwoKCWtiLnVudGlsRmFsc2VGbiA9IGZ1bmN0aW9uKHN0YW5kX2luLCBmbiwgbW9kZWwpIHsKCSAgdmFyIHdhc19mYWxzZTsKCSAgd2FzX2ZhbHNlID0gZmFsc2U7CgkgIGlmIChtb2RlbCAmJiBrby5pc09ic2VydmFibGUobW9kZWwpKSB7CgkgICAgbW9kZWwuc3Vic2NyaWJlKGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHdhc19mYWxzZSA9IGZhbHNlOwoJICAgIH0pOwoJICB9CgkgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewoJICAgIHZhciBmLCByZXN1bHQ7CgkgICAgaWYgKCEoZiA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoZm4pKSkgewoJICAgICAgcmV0dXJuIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoc3RhbmRfaW4pOwoJICAgIH0KCSAgICB3YXNfZmFsc2UgfD0gIShyZXN1bHQgPSBmKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWUpKSk7CgkgICAgcmV0dXJuICh3YXNfZmFsc2UgPyByZXN1bHQgOiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHN0YW5kX2luKSk7CgkgIH07Cgl9OwoKCi8qKiovIH0sCi8qIDIzICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIEFzc29jaWF0ZWRNb2RlbCwgQmFja2JvbmUsIEJhY2tib25lQXNzb2NpYXRpb25zLCBrYiwgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBCYWNrYm9uZSA9IF9yZWYuQmFja2JvbmU7CgoJQXNzb2NpYXRlZE1vZGVsID0gbnVsbDsKCgltb2R1bGUuZXhwb3J0cyA9IEJhY2tib25lQXNzb2NpYXRpb25zID0gKGZ1bmN0aW9uKCkgewoJICBmdW5jdGlvbiBCYWNrYm9uZUFzc29jaWF0aW9ucygpIHt9CgoJICBCYWNrYm9uZUFzc29jaWF0aW9ucy5pc0F2YWlsYWJsZSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiAhIShBc3NvY2lhdGVkTW9kZWwgPSBCYWNrYm9uZSAhPSBudWxsID8gQmFja2JvbmUuQXNzb2NpYXRlZE1vZGVsIDogdm9pZCAwKTsKCSAgfTsKCgkgIEJhY2tib25lQXNzb2NpYXRpb25zLmtleXMgPSBmdW5jdGlvbihtb2RlbCkgewoJICAgIGlmICghKG1vZGVsIGluc3RhbmNlb2YgQXNzb2NpYXRlZE1vZGVsKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIHJldHVybiBfLm1hcChtb2RlbC5yZWxhdGlvbnMsIGZ1bmN0aW9uKHRlc3QpIHsKCSAgICAgIHJldHVybiB0ZXN0LmtleTsKCSAgICB9KTsKCSAgfTsKCgkgIEJhY2tib25lQXNzb2NpYXRpb25zLnJlbGF0aW9uVHlwZSA9IGZ1bmN0aW9uKG1vZGVsLCBrZXkpIHsKCSAgICB2YXIgcmVsYXRpb247CgkgICAgaWYgKCEobW9kZWwgaW5zdGFuY2VvZiBBc3NvY2lhdGVkTW9kZWwpKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgaWYgKCEocmVsYXRpb24gPSBfLmZpbmQobW9kZWwucmVsYXRpb25zLCBmdW5jdGlvbih0ZXN0KSB7CgkgICAgICByZXR1cm4gdGVzdC5rZXkgPT09IGtleTsKCSAgICB9KSkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAocmVsYXRpb24udHlwZSA9PT0gJ01hbnknKSB7CgkgICAgICByZXR1cm4ga2IuVFlQRV9DT0xMRUNUSU9OOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4ga2IuVFlQRV9NT0RFTDsKCSAgICB9CgkgIH07CgoJICBCYWNrYm9uZUFzc29jaWF0aW9ucy51c2VGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBmYWxzZTsKCSAgfTsKCgkgIHJldHVybiBCYWNrYm9uZUFzc29jaWF0aW9uczsKCgl9KSgpOwoKCi8qKiovIH0sCi8qIDI0ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIEJhY2tib25lLCBCYWNrYm9uZVJlbGF0aW9uYWwsIFJlbGF0aW9uYWxNb2RlbCwga2IsIF8sIF9yZWY7CgoJX3JlZiA9IGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSwgXyA9IF9yZWYuXywgQmFja2JvbmUgPSBfcmVmLkJhY2tib25lOwoKCVJlbGF0aW9uYWxNb2RlbCA9IG51bGw7CgoJbW9kdWxlLmV4cG9ydHMgPSBCYWNrYm9uZVJlbGF0aW9uYWwgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIEJhY2tib25lUmVsYXRpb25hbCgpIHt9CgoJICBCYWNrYm9uZVJlbGF0aW9uYWwuaXNBdmFpbGFibGUgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gISEoUmVsYXRpb25hbE1vZGVsID0gQmFja2JvbmUgIT0gbnVsbCA/IEJhY2tib25lLlJlbGF0aW9uYWxNb2RlbCA6IHZvaWQgMCk7CgkgIH07CgoJICBCYWNrYm9uZVJlbGF0aW9uYWwucmVsYXRpb25UeXBlID0gZnVuY3Rpb24obW9kZWwsIGtleSkgewoJICAgIHZhciByZWxhdGlvbjsKCSAgICBpZiAoIShtb2RlbCBpbnN0YW5jZW9mIFJlbGF0aW9uYWxNb2RlbCkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAoIShyZWxhdGlvbiA9IF8uZmluZChtb2RlbC5nZXRSZWxhdGlvbnMoKSwgZnVuY3Rpb24odGVzdCkgewoJICAgICAgcmV0dXJuIHRlc3Qua2V5ID09PSBrZXk7CgkgICAgfSkpKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgaWYgKHJlbGF0aW9uLmNvbGxlY3Rpb25UeXBlIHx8IF8uaXNBcnJheShyZWxhdGlvbi5rZXlDb250ZW50cykpIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX0NPTExFQ1RJT047CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX01PREVMOwoJICAgIH0KCSAgfTsKCgkgIEJhY2tib25lUmVsYXRpb25hbC5iaW5kID0gZnVuY3Rpb24obW9kZWwsIGtleSwgdXBkYXRlLCBwYXRoKSB7CgkgICAgdmFyIGV2ZW50LCBldmVudHMsIHJlbF9mbiwgdHlwZSwgX2ksIF9sZW47CgkgICAgaWYgKCEodHlwZSA9IHRoaXMucmVsYXRpb25UeXBlKG1vZGVsLCBrZXkpKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIHJlbF9mbiA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAha2Iuc3RhdGlzdGljcyB8fCBrYi5zdGF0aXN0aWNzLmFkZE1vZGVsRXZlbnQoewoJICAgICAgICBuYW1lOiAndXBkYXRlIChyZWxhdGlvbmFsKScsCgkgICAgICAgIG1vZGVsOiBtb2RlbCwKCSAgICAgICAga2V5OiBrZXksCgkgICAgICAgIHBhdGg6IHBhdGgKCSAgICAgIH0pOwoJICAgICAgcmV0dXJuIHVwZGF0ZSgpOwoJICAgIH07CgkgICAgZXZlbnRzID0ga2IuQmFja2JvbmUuUmVsYXRpb24ucHJvdG90eXBlLnNhbml0aXplT3B0aW9ucyA/IFsndXBkYXRlJywgJ2FkZCcsICdyZW1vdmUnXSA6IFsnY2hhbmdlJywgJ2FkZCcsICdyZW1vdmUnXTsKCSAgICBpZiAodHlwZSA9PT0ga2IuVFlQRV9DT0xMRUNUSU9OKSB7CgkgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGV2ZW50cy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgICBldmVudCA9IGV2ZW50c1tfaV07CgkgICAgICAgIG1vZGVsLmJpbmQoIiIgKyBldmVudCArICI6IiArIGtleSwgcmVsX2ZuKTsKCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgbW9kZWwuYmluZCgiIiArIGV2ZW50c1swXSArICI6IiArIGtleSwgcmVsX2ZuKTsKCSAgICB9CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIF9qLCBfbGVuMTsKCSAgICAgIGlmICh0eXBlID09PSBrYi5UWVBFX0NPTExFQ1RJT04pIHsKCSAgICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gZXZlbnRzLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewoJICAgICAgICAgIGV2ZW50ID0gZXZlbnRzW19qXTsKCSAgICAgICAgICBtb2RlbC51bmJpbmQoIiIgKyBldmVudCArICI6IiArIGtleSwgcmVsX2ZuKTsKCSAgICAgICAgfQoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgbW9kZWwudW5iaW5kKCIiICsgZXZlbnRzWzBdICsgIjoiICsga2V5LCByZWxfZm4pOwoJICAgICAgfQoJICAgIH07CgkgIH07CgoJICBCYWNrYm9uZVJlbGF0aW9uYWwudXNlRnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gZmFsc2U7CgkgIH07CgoJICByZXR1cm4gQmFja2JvbmVSZWxhdGlvbmFsOwoKCX0pKCk7CgoKLyoqKi8gfSwKLyogMjUgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJLyogV0VCUEFDSyBWQVIgSU5KRUNUSU9OICovKGZ1bmN0aW9uKGdsb2JhbCkgewoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIFN1cGVybW9kZWwsIGtiLCByb290LCBfOwoKCXJvb3QgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cgIT09IG51bGwgPyB3aW5kb3cgOiBnbG9iYWw7CgoJXyA9IChrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNikpLl87CgoJU3VwZXJtb2RlbCA9IG51bGw7CgoJbW9kdWxlLmV4cG9ydHMgPSBTdXBlcm1vZGVsID0gKGZ1bmN0aW9uKCkgewoJICBmdW5jdGlvbiBTdXBlcm1vZGVsKCkge30KCgkgIFN1cGVybW9kZWwuaXNBdmFpbGFibGUgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gISEoU3VwZXJtb2RlbCA9IHJvb3QuU3VwZXJtb2RlbCk7CgkgIH07CgoJICBTdXBlcm1vZGVsLmtleXMgPSBmdW5jdGlvbihtb2RlbCkgewoJICAgIGlmICghKG1vZGVsIGluc3RhbmNlb2YgU3VwZXJtb2RlbC5Nb2RlbCkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICByZXR1cm4gXy5rZXlzKG1vZGVsLmNvbnN0cnVjdG9yLmFzc29jaWF0aW9ucygpKTsKCSAgfTsKCgkgIFN1cGVybW9kZWwucmVsYXRpb25UeXBlID0gZnVuY3Rpb24obW9kZWwsIGtleSkgewoJICAgIHZhciByZWxhdGlvbjsKCSAgICBpZiAoIShtb2RlbCBpbnN0YW5jZW9mIFN1cGVybW9kZWwuTW9kZWwpKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgaWYgKCEocmVsYXRpb24gPSBtb2RlbC5jb25zdHJ1Y3Rvci5hc3NvY2lhdGlvbnMoKVtrZXldKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIGlmIChyZWxhdGlvbi5hZGQpIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX0NPTExFQ1RJT047CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX01PREVMOwoJICAgIH0KCSAgfTsKCgkgIFN1cGVybW9kZWwuYmluZCA9IGZ1bmN0aW9uKG1vZGVsLCBrZXksIHVwZGF0ZSwgcGF0aCkgewoJICAgIHZhciByZWxfZm4sIHR5cGU7CgkgICAgaWYgKCEodHlwZSA9IHRoaXMucmVsYXRpb25UeXBlKG1vZGVsLCBrZXkpKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIHJlbF9mbiA9IGZ1bmN0aW9uKG1vZGVsLCBvdGhlcikgewoJICAgICAgdmFyIHByZXZpb3VzLCByZWxhdGlvbjsKCSAgICAgICFrYi5zdGF0aXN0aWNzIHx8IGtiLnN0YXRpc3RpY3MuYWRkTW9kZWxFdmVudCh7CgkgICAgICAgIG5hbWU6ICd1cGRhdGUgKHN1cGVybW9kZWwpJywKCSAgICAgICAgbW9kZWw6IG1vZGVsLAoJICAgICAgICBrZXk6IGtleSwKCSAgICAgICAgcGF0aDogcGF0aAoJICAgICAgfSk7CgkgICAgICByZWxhdGlvbiA9IG1vZGVsLmNvbnN0cnVjdG9yLmFzc29jaWF0aW9ucygpW2tleV07CgkgICAgICBwcmV2aW91cyA9IG1vZGVsW3JlbGF0aW9uLnN0b3JlXTsKCSAgICAgIG1vZGVsW3JlbGF0aW9uLnN0b3JlXSA9IG90aGVyOwoJICAgICAgdXBkYXRlKG90aGVyKTsKCSAgICAgIHJldHVybiBtb2RlbFtyZWxhdGlvbi5zdG9yZV0gPSBwcmV2aW91czsKCSAgICB9OwoJICAgIGlmICh0eXBlID09PSBrYi5UWVBFX01PREVMKSB7CgkgICAgICBtb2RlbC5iaW5kKCJhc3NvY2lhdGU6IiArIGtleSwgcmVsX2ZuKTsKCSAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgcmV0dXJuIG1vZGVsLnVuYmluZCgiYXNzb2NpYXRlOiIgKyBrZXksIHJlbF9mbik7CgkgICAgICB9OwoJICAgIH0KCSAgfTsKCgkgIFN1cGVybW9kZWwudXNlRnVuY3Rpb24gPSBmdW5jdGlvbihtb2RlbCwga2V5KSB7CgkgICAgcmV0dXJuICEhdGhpcy5yZWxhdGlvblR5cGUobW9kZWwsIGtleSk7CgkgIH07CgoJICByZXR1cm4gU3VwZXJtb2RlbDsKCgl9KSgpOwoJCgkvKiBXRUJQQUNLIFZBUiBJTkpFQ1RJT04gKi99LmNhbGwoZXhwb3J0cywgKGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpczsgfSgpKSkpCgovKioqLyB9LAovKiAyNiAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciBjb3B5UHJvcHM7CgoJY29weVByb3BzID0gZnVuY3Rpb24oZGVzdCwgc291cmNlKSB7CgkgIHZhciBrZXksIHZhbHVlOwoJICBmb3IgKGtleSBpbiBzb3VyY2UpIHsKCSAgICB2YWx1ZSA9IHNvdXJjZVtrZXldOwoJICAgIGRlc3Rba2V5XSA9IHZhbHVlOwoJICB9CgkgIHJldHVybiBkZXN0OwoJfTsKCgkvLyBTaGFyZWQgZW1wdHkgY29uc3RydWN0b3IgZnVuY3Rpb24gdG8gYWlkIGluIHByb3RvdHlwZS1jaGFpbiBjcmVhdGlvbi4KCXZhciBjdG9yID0gZnVuY3Rpb24oKXt9OwoKCS8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgoJLy8gU2ltaWxhciB0byAnZ29vZy5pbmhlcml0cycsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKCS8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCgl2YXIgaW5oZXJpdHMgPSBmdW5jdGlvbihwYXJlbnQsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CgkgIHZhciBjaGlsZDsKCgkgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKCSAgLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgZXh0ZW5kIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKCSAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgoJICBpZiAocHJvdG9Qcm9wcyAmJiBwcm90b1Byb3BzLmhhc093blByb3BlcnR5KCdjb25zdHJ1Y3RvcicpKSB7CgkgICAgY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOwoJICB9IGVsc2UgewoJICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CgkgIH0KCgkgIC8vIEluaGVyaXQgY2xhc3MgKHN0YXRpYykgcHJvcGVydGllcyBmcm9tIHBhcmVudC4KCSAgY29weVByb3BzKGNoaWxkLCBwYXJlbnQpOwoKCSAgLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIHBhcmVudCwgd2l0aG91dCBjYWxsaW5nCgkgIC8vIHBhcmVudCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgoJICBjdG9yLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7CgkgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBjdG9yKCk7CgoJICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKCSAgLy8gaWYgc3VwcGxpZWQuCgkgIGlmIChwcm90b1Byb3BzKSBjb3B5UHJvcHMoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKCgkgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgoJICBpZiAoc3RhdGljUHJvcHMpIGNvcHlQcm9wcyhjaGlsZCwgc3RhdGljUHJvcHMpOwoKCSAgLy8gQ29ycmVjdGx5IHNldCBjaGlsZCdzICdwcm90b3R5cGUuY29uc3RydWN0b3InLgoJICBjaGlsZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjaGlsZDsKCgkgIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQgbGF0ZXIuCgkgIGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7CgoJICByZXR1cm4gY2hpbGQ7Cgl9OwoKCS8vIFRoZSBzZWxmLXByb3BhZ2F0aW5nIGV4dGVuZCBmdW5jdGlvbiB0aGF0IEJhY0xDb25lIGNsYXNzZXMgdXNlLgoJdmFyIGV4dGVuZCA9IGZ1bmN0aW9uIChwcm90b1Byb3BzLCBjbGFzc1Byb3BzKSB7CgkgIHZhciBjaGlsZCA9IGluaGVyaXRzKHRoaXMsIHByb3RvUHJvcHMsIGNsYXNzUHJvcHMpOwoJICBjaGlsZC5leHRlbmQgPSB0aGlzLmV4dGVuZDsKCSAgcmV0dXJuIGNoaWxkOwoJfTsKCTsKCgltb2R1bGUuZXhwb3J0cyA9IGV4dGVuZDsKCgovKioqLyB9LAovKiAyNyAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciB3cmFwcGVkRGVzdHJveSwgXzsKCglfID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KS5fOwoKCW1vZHVsZS5leHBvcnRzID0gd3JhcHBlZERlc3Ryb3kgPSBmdW5jdGlvbihvYmopIHsKCSAgdmFyIHN0b3JlX3JlZmVyZW5jZXMsIF9fa2I7CgkgIGlmICghb2JqLl9fa2IpIHsKCSAgICByZXR1cm47CgkgIH0KCSAgaWYgKG9iai5fX2tiLmV2ZW50X3dhdGNoZXIpIHsKCSAgICBvYmouX19rYi5ldmVudF93YXRjaGVyLnJlbGVhc2VDYWxsYmFja3Mob2JqKTsKCSAgfQoJICBfX2tiID0gb2JqLl9fa2I7CgkgIG9iai5fX2tiID0gbnVsbDsKCSAgaWYgKF9fa2Iub2JzZXJ2YWJsZSkgewoJICAgIF9fa2Iub2JzZXJ2YWJsZS5kZXN0cm95ID0gX19rYi5vYnNlcnZhYmxlLnJlbGVhc2UgPSBudWxsOwoJICAgIHdyYXBwZWREZXN0cm95KF9fa2Iub2JzZXJ2YWJsZSk7CgkgICAgX19rYi5vYnNlcnZhYmxlID0gbnVsbDsKCSAgfQoJICBfX2tiLmZhY3RvcnkgPSBudWxsOwoJICBpZiAoX19rYi5ldmVudF93YXRjaGVyX2lzX293bmVkKSB7CgkgICAgX19rYi5ldmVudF93YXRjaGVyLmRlc3Ryb3koKTsKCSAgfQoJICBfX2tiLmV2ZW50X3dhdGNoZXIgPSBudWxsOwoJICBpZiAoX19rYi5zdG9yZV9pc19vd25lZCkgewoJICAgIF9fa2Iuc3RvcmUuZGVzdHJveSgpOwoJICB9CgkgIF9fa2Iuc3RvcmUgPSBudWxsOwoJICBpZiAoX19rYi5zdG9yZXNfcmVmZXJlbmNlcykgewoJICAgIHdoaWxlIChzdG9yZV9yZWZlcmVuY2VzID0gX19rYi5zdG9yZXNfcmVmZXJlbmNlcy5wb3AoKSkgewoJICAgICAgaWYgKCFzdG9yZV9yZWZlcmVuY2VzLnN0b3JlLl9fa2JfcmVsZWFzZWQpIHsKCSAgICAgICAgc3RvcmVfcmVmZXJlbmNlcy5zdG9yZS5yZWxlYXNlKG9iaik7CgkgICAgICB9CgkgICAgfQoJICB9Cgl9OwoKCi8qKiovIH0sCi8qIDI4ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIF8sIF9rZXlBcnJheVRvT2JqZWN0LCBfbWVyZ2VBcnJheSwgX21lcmdlT2JqZWN0LCBfbWVyZ2VPcHRpb25zOwoKCV8gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLl87CgoJX21lcmdlQXJyYXkgPSBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKCSAgcmVzdWx0W2tleV0gfHwgKHJlc3VsdFtrZXldID0gW10pOwoJICBpZiAoIV8uaXNBcnJheSh2YWx1ZSkpIHsKCSAgICB2YWx1ZSA9IFt2YWx1ZV07CgkgIH0KCSAgcmVzdWx0W2tleV0gPSByZXN1bHRba2V5XS5sZW5ndGggPyBfLnVuaW9uKHJlc3VsdFtrZXldLCB2YWx1ZSkgOiB2YWx1ZTsKCSAgcmV0dXJuIHJlc3VsdDsKCX07CgoJX21lcmdlT2JqZWN0ID0gZnVuY3Rpb24ocmVzdWx0LCBrZXksIHZhbHVlKSB7CgkgIHJlc3VsdFtrZXldIHx8IChyZXN1bHRba2V5XSA9IHt9KTsKCSAgcmV0dXJuIF8uZXh0ZW5kKHJlc3VsdFtrZXldLCB2YWx1ZSk7Cgl9OwoKCV9rZXlBcnJheVRvT2JqZWN0ID0gZnVuY3Rpb24odmFsdWUpIHsKCSAgdmFyIGl0ZW0sIHJlc3VsdCwgX2ksIF9sZW47CgkgIHJlc3VsdCA9IHt9OwoJICBmb3IgKF9pID0gMCwgX2xlbiA9IHZhbHVlLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgaXRlbSA9IHZhbHVlW19pXTsKCSAgICByZXN1bHRbaXRlbV0gPSB7CgkgICAgICBrZXk6IGl0ZW0KCSAgICB9OwoJICB9CgkgIHJldHVybiByZXN1bHQ7Cgl9OwoKCV9tZXJnZU9wdGlvbnMgPSBmdW5jdGlvbihyZXN1bHQsIG9wdGlvbnMpIHsKCSAgdmFyIGtleSwgdmFsdWU7CgkgIGlmICghb3B0aW9ucykgewoJICAgIHJldHVybiByZXN1bHQ7CgkgIH0KCSAgZm9yIChrZXkgaW4gb3B0aW9ucykgewoJICAgIHZhbHVlID0gb3B0aW9uc1trZXldOwoJICAgIHN3aXRjaCAoa2V5KSB7CgkgICAgICBjYXNlICdpbnRlcm5hbHMnOgoJICAgICAgY2FzZSAncmVxdWlyZXMnOgoJICAgICAgY2FzZSAnZXhjbHVkZXMnOgoJICAgICAgY2FzZSAnc3RhdGljcyc6CgkgICAgICAgIF9tZXJnZUFycmF5KHJlc3VsdCwga2V5LCB2YWx1ZSk7CgkgICAgICAgIGJyZWFrOwoJICAgICAgY2FzZSAna2V5cyc6CgkgICAgICAgIGlmICgoXy5pc09iamVjdCh2YWx1ZSkgJiYgIV8uaXNBcnJheSh2YWx1ZSkpIHx8IChfLmlzT2JqZWN0KHJlc3VsdFtrZXldKSAmJiAhXy5pc0FycmF5KHJlc3VsdFtrZXldKSkpIHsKCSAgICAgICAgICBpZiAoIV8uaXNPYmplY3QodmFsdWUpKSB7CgkgICAgICAgICAgICB2YWx1ZSA9IFt2YWx1ZV07CgkgICAgICAgICAgfQoJICAgICAgICAgIGlmIChfLmlzQXJyYXkodmFsdWUpKSB7CgkgICAgICAgICAgICB2YWx1ZSA9IF9rZXlBcnJheVRvT2JqZWN0KHZhbHVlKTsKCSAgICAgICAgICB9CgkgICAgICAgICAgaWYgKF8uaXNBcnJheShyZXN1bHRba2V5XSkpIHsKCSAgICAgICAgICAgIHJlc3VsdFtrZXldID0gX2tleUFycmF5VG9PYmplY3QocmVzdWx0W2tleV0pOwoJICAgICAgICAgIH0KCSAgICAgICAgICBfbWVyZ2VPYmplY3QocmVzdWx0LCBrZXksIHZhbHVlKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICBfbWVyZ2VBcnJheShyZXN1bHQsIGtleSwgdmFsdWUpOwoJICAgICAgICB9CgkgICAgICAgIGJyZWFrOwoJICAgICAgY2FzZSAnZmFjdG9yaWVzJzoKCSAgICAgICAgaWYgKF8uaXNGdW5jdGlvbih2YWx1ZSkpIHsKCSAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIF9tZXJnZU9iamVjdChyZXN1bHQsIGtleSwgdmFsdWUpOwoJICAgICAgICB9CgkgICAgICAgIGJyZWFrOwoJICAgICAgY2FzZSAnc3RhdGljX2RlZmF1bHRzJzoKCSAgICAgICAgX21lcmdlT2JqZWN0KHJlc3VsdCwga2V5LCB2YWx1ZSk7CgkgICAgICAgIGJyZWFrOwoJICAgICAgY2FzZSAnb3B0aW9ucyc6CgkgICAgICAgIGJyZWFrOwoJICAgICAgZGVmYXVsdDoKCSAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKCSAgICB9CgkgIH0KCSAgcmV0dXJuIF9tZXJnZU9wdGlvbnMocmVzdWx0LCBvcHRpb25zLm9wdGlvbnMpOwoJfTsKCgltb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgcmV0dXJuIF9tZXJnZU9wdGlvbnMoe30sIG9wdGlvbnMpOwoJfTsKCgovKioqLyB9LAovKiAyOSAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciB1bndyYXBNb2RlbHMsIF87CgoJXyA9IF9fd2VicGFja19yZXF1aXJlX18oNikuXzsKCgltb2R1bGUuZXhwb3J0cyA9IHVud3JhcE1vZGVscyA9IGZ1bmN0aW9uKG9iaikgewoJICB2YXIga2V5LCByZXN1bHQsIHZhbHVlOwoJICBpZiAoIW9iaikgewoJICAgIHJldHVybiBvYmo7CgkgIH0KCSAgaWYgKG9iai5fX2tiKSB7CgkgICAgcmV0dXJuIChvYmouX19rYi5oYXNPd25Qcm9wZXJ0eSgnb2JqZWN0JykgPyBvYmouX19rYi5vYmplY3QgOiBvYmopOwoJICB9CgkgIGlmIChfLmlzQXJyYXkob2JqKSkgewoJICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uKHRlc3QpIHsKCSAgICAgIHJldHVybiB1bndyYXBNb2RlbHModGVzdCk7CgkgICAgfSk7CgkgIH0KCSAgaWYgKF8uaXNPYmplY3Qob2JqKSAmJiAob2JqLmNvbnN0cnVjdG9yID09PSB7fS5jb25zdHJ1Y3RvcikpIHsKCSAgICByZXN1bHQgPSB7fTsKCSAgICBmb3IgKGtleSBpbiBvYmopIHsKCSAgICAgIHZhbHVlID0gb2JqW2tleV07CgkgICAgICByZXN1bHRba2V5XSA9IHVud3JhcE1vZGVscyh2YWx1ZSk7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH0KCSAgcmV0dXJuIG9iajsKCX07CgoKLyoqKi8gfSwKLyogMzAgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJdmFyIF9fV0VCUEFDS19BTURfREVGSU5FX0FSUkFZX18sIF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fOy8vICAgICBCYWNrYm9uZS5qcyAxLjEuMgoKCS8vICAgICAoYykgMjAxMC0yMDE0IEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCgkvLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgkvLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgoJLy8gICAgIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZwoKCShmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CgoJICAvLyBTZXQgdXAgQmFja2JvbmUgYXBwcm9wcmlhdGVseSBmb3IgdGhlIGVudmlyb25tZW50LiBTdGFydCB3aXRoIEFNRC4KCSAgaWYgKHRydWUpIHsKCSAgICAhKF9fV0VCUEFDS19BTURfREVGSU5FX0FSUkFZX18gPSBbX193ZWJwYWNrX3JlcXVpcmVfXygzMSksIF9fd2VicGFja19yZXF1aXJlX18oMjApLCBleHBvcnRzXSwgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gPSBmdW5jdGlvbihfLCAkLCBleHBvcnRzKSB7CgkgICAgICAvLyBFeHBvcnQgZ2xvYmFsIGV2ZW4gaW4gQU1EIGNhc2UgaW4gY2FzZSB0aGlzIHNjcmlwdCBpcyBsb2FkZWQgd2l0aAoJICAgICAgLy8gb3RoZXJzIHRoYXQgbWF5IHN0aWxsIGV4cGVjdCBhIGdsb2JhbCBCYWNrYm9uZS4KCSAgICAgIHJvb3QuQmFja2JvbmUgPSBmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIF8sICQpOwoJICAgIH0uYXBwbHkoZXhwb3J0cywgX19XRUJQQUNLX0FNRF9ERUZJTkVfQVJSQVlfXyksIF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fICE9PSB1bmRlZmluZWQgJiYgKG1vZHVsZS5leHBvcnRzID0gX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18pKTsKCgkgIC8vIE5leHQgZm9yIE5vZGUuanMgb3IgQ29tbW9uSlMuIGpRdWVyeSBtYXkgbm90IGJlIG5lZWRlZCBhcyBhIG1vZHVsZS4KCSAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKCSAgICB2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTsKCSAgICBmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIF8pOwoKCSAgLy8gRmluYWxseSwgYXMgYSBicm93c2VyIGdsb2JhbC4KCSAgfSBlbHNlIHsKCSAgICByb290LkJhY2tib25lID0gZmFjdG9yeShyb290LCB7fSwgcm9vdC5fLCAocm9vdC5qUXVlcnkgfHwgcm9vdC5aZXB0byB8fCByb290LmVuZGVyIHx8IHJvb3QuJCkpOwoJICB9CgoJfSh0aGlzLCBmdW5jdGlvbihyb290LCBCYWNrYm9uZSwgXywgJCkgewoKCSAgLy8gSW5pdGlhbCBTZXR1cAoJICAvLyAtLS0tLS0tLS0tLS0tCgoJICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKCSAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgoJICB2YXIgcHJldmlvdXNCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmU7CgoJICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgoJICB2YXIgYXJyYXkgPSBbXTsKCSAgdmFyIHB1c2ggPSBhcnJheS5wdXNoOwoJICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKCSAgdmFyIHNwbGljZSA9IGFycmF5LnNwbGljZTsKCgkgIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCgkgIEJhY2tib25lLlZFUlNJT04gPSAnMS4xLjInOwoKCSAgLy8gRm9yIEJhY2tib25lJ3MgcHVycG9zZXMsIGpRdWVyeSwgWmVwdG8sIEVuZGVyLCBvciBNeSBMaWJyYXJ5IChraWRkaW5nKSBvd25zCgkgIC8vIHRoZSBgJGAgdmFyaWFibGUuCgkgIEJhY2tib25lLiQgPSAkOwoKCSAgLy8gUnVucyBCYWNrYm9uZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlCgkgIC8vIHRvIGl0cyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIEJhY2tib25lIG9iamVjdC4KCSAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewoJICAgIHJvb3QuQmFja2JvbmUgPSBwcmV2aW91c0JhY2tib25lOwoJICAgIHJldHVybiB0aGlzOwoJICB9OwoKCSAgLy8gVHVybiBvbiBgZW11bGF0ZUhUVFBgIHRvIHN1cHBvcnQgbGVnYWN5IEhUVFAgc2VydmVycy4gU2V0dGluZyB0aGlzIG9wdGlvbgoJICAvLyB3aWxsIGZha2UgYCJQQVRDSCJgLCBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKCSAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KCSAgQmFja2JvbmUuZW11bGF0ZUhUVFAgPSBmYWxzZTsKCgkgIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAoJICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCgkgIC8vIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgIGluc3RlYWQgYW5kIHdpbGwgc2VuZCB0aGUgbW9kZWwgaW4gYQoJICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCgkgIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgoJICAvLyBCYWNrYm9uZS5FdmVudHMKCSAgLy8gLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCgkgIC8vIGN1c3RvbSBldmVudHMuIFlvdSBtYXkgYmluZCB3aXRoIGBvbmAgb3IgcmVtb3ZlIHdpdGggYG9mZmAgY2FsbGJhY2sKCSAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KCSAgLy8gc3VjY2Vzc2lvbi4KCSAgLy8KCSAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKCSAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKCSAgLy8gICAgIG9iamVjdC5vbignZXhwYW5kJywgZnVuY3Rpb24oKXsgYWxlcnQoJ2V4cGFuZGVkJyk7IH0pOwoJICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwoJICAvLwoJICB2YXIgRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzID0gewoKCSAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZAoJICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgoJICAgIG9uOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewoJICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKSByZXR1cm4gdGhpczsKCSAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwoJICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSB8fCAodGhpcy5fZXZlbnRzW25hbWVdID0gW10pOwoJICAgICAgZXZlbnRzLnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIEJpbmQgYW4gZXZlbnQgdG8gb25seSBiZSB0cmlnZ2VyZWQgYSBzaW5nbGUgdGltZS4gQWZ0ZXIgdGhlIGZpcnN0IHRpbWUKCSAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgoJICAgIG9uY2U6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CgkgICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CgkgICAgICB2YXIgc2VsZiA9IHRoaXM7CgkgICAgICB2YXIgb25jZSA9IF8ub25jZShmdW5jdGlvbigpIHsKCSAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CgkgICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgICAgICB9KTsKCSAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CgkgICAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKCSAgICB9LAoKCSAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKCSAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCgkgICAgLy8gY2FsbGJhY2tzIGZvciB0aGUgZXZlbnQuIElmIGBuYW1lYCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZAoJICAgIC8vIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KCSAgICBvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CgkgICAgICB2YXIgcmV0YWluLCBldiwgZXZlbnRzLCBuYW1lcywgaSwgbCwgaiwgazsKCSAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKCSAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKCSAgICAgICAgdGhpcy5fZXZlbnRzID0gdm9pZCAwOwoJICAgICAgICByZXR1cm4gdGhpczsKCSAgICAgIH0KCSAgICAgIG5hbWVzID0gbmFtZSA/IFtuYW1lXSA6IF8ua2V5cyh0aGlzLl9ldmVudHMpOwoJICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJICAgICAgICBuYW1lID0gbmFtZXNbaV07CgkgICAgICAgIGlmIChldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0pIHsKCSAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSByZXRhaW4gPSBbXTsKCSAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewoJICAgICAgICAgICAgZm9yIChqID0gMCwgayA9IGV2ZW50cy5sZW5ndGg7IGogPCBrOyBqKyspIHsKCSAgICAgICAgICAgICAgZXYgPSBldmVudHNbal07CgkgICAgICAgICAgICAgIGlmICgoY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjay5fY2FsbGJhY2spIHx8CgkgICAgICAgICAgICAgICAgICAoY29udGV4dCAmJiBjb250ZXh0ICE9PSBldi5jb250ZXh0KSkgewoJICAgICAgICAgICAgICAgIHJldGFpbi5wdXNoKGV2KTsKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgIH0KCSAgICAgICAgICBpZiAoIXJldGFpbi5sZW5ndGgpIGRlbGV0ZSB0aGlzLl9ldmVudHNbbmFtZV07CgkgICAgICAgIH0KCSAgICAgIH0KCgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKCSAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQoJICAgIC8vICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KCSAgICAvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCgkgICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewoJICAgICAgaWYgKCF0aGlzLl9ldmVudHMpIHJldHVybiB0aGlzOwoJICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgkgICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKCSAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV07CgkgICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKCSAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHMoZXZlbnRzLCBhcmdzKTsKCSAgICAgIGlmIChhbGxFdmVudHMpIHRyaWdnZXJFdmVudHMoYWxsRXZlbnRzLCBhcmd1bWVudHMpOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gVGVsbCB0aGlzIG9iamVjdCB0byBzdG9wIGxpc3RlbmluZyB0byBlaXRoZXIgc3BlY2lmaWMgZXZlbnRzIC4uLiBvcgoJICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCgkgICAgc3RvcExpc3RlbmluZzogZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewoJICAgICAgdmFyIGxpc3RlbmluZ1RvID0gdGhpcy5fbGlzdGVuaW5nVG87CgkgICAgICBpZiAoIWxpc3RlbmluZ1RvKSByZXR1cm4gdGhpczsKCSAgICAgIHZhciByZW1vdmUgPSAhbmFtZSAmJiAhY2FsbGJhY2s7CgkgICAgICBpZiAoIWNhbGxiYWNrICYmIHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgY2FsbGJhY2sgPSB0aGlzOwoJICAgICAgaWYgKG9iaikgKGxpc3RlbmluZ1RvID0ge30pW29iai5fbGlzdGVuSWRdID0gb2JqOwoJICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuaW5nVG8pIHsKCSAgICAgICAgb2JqID0gbGlzdGVuaW5nVG9baWRdOwoJICAgICAgICBvYmoub2ZmKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKCSAgICAgICAgaWYgKHJlbW92ZSB8fCBfLmlzRW1wdHkob2JqLl9ldmVudHMpKSBkZWxldGUgdGhpcy5fbGlzdGVuaW5nVG9baWRdOwoJICAgICAgfQoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfQoKCSAgfTsKCgkgIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCgkgIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CgoJICAvLyBJbXBsZW1lbnQgZmFuY3kgZmVhdHVyZXMgb2YgdGhlIEV2ZW50cyBBUEkgc3VjaCBhcyBtdWx0aXBsZSBldmVudAoJICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAoJICAvLyBpbiB0ZXJtcyBvZiB0aGUgZXhpc3RpbmcgQVBJLgoJICB2YXIgZXZlbnRzQXBpID0gZnVuY3Rpb24ob2JqLCBhY3Rpb24sIG5hbWUsIHJlc3QpIHsKCSAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwoKCSAgICAvLyBIYW5kbGUgZXZlbnQgbWFwcy4KCSAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7CgkgICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewoJICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtrZXksIG5hbWVba2V5XV0uY29uY2F0KHJlc3QpKTsKCSAgICAgIH0KCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9CgoJICAgIC8vIEhhbmRsZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnQgbmFtZXMuCgkgICAgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewoJICAgICAgdmFyIG5hbWVzID0gbmFtZS5zcGxpdChldmVudFNwbGl0dGVyKTsKCSAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW25hbWVzW2ldXS5jb25jYXQocmVzdCkpOwoJICAgICAgfQoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCgkgICAgcmV0dXJuIHRydWU7CgkgIH07CgoJICAvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgoJICAvLyB0cmlnZ2VyaW5nIGV2ZW50cy4gVHJpZXMgdG8ga2VlcCB0aGUgdXN1YWwgY2FzZXMgc3BlZWR5IChtb3N0IGludGVybmFsCgkgIC8vIEJhY2tib25lIGV2ZW50cyBoYXZlIDMgYXJndW1lbnRzKS4KCSAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihldmVudHMsIGFyZ3MpIHsKCSAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGgsIGExID0gYXJnc1swXSwgYTIgPSBhcmdzWzFdLCBhMyA9IGFyZ3NbMl07CgkgICAgc3dpdGNoIChhcmdzLmxlbmd0aCkgewoJICAgICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7IHJldHVybjsKCSAgICAgIGNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExKTsgcmV0dXJuOwoJICAgICAgY2FzZSAyOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyKTsgcmV0dXJuOwoJICAgICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyLCBhMyk7IHJldHVybjsKCSAgICAgIGRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7IHJldHVybjsKCSAgICB9CgkgIH07CgoJICB2YXIgbGlzdGVuTWV0aG9kcyA9IHtsaXN0ZW5UbzogJ29uJywgbGlzdGVuVG9PbmNlOiAnb25jZSd9OwoKCSAgLy8gSW52ZXJzaW9uLW9mLWNvbnRyb2wgdmVyc2lvbnMgb2YgYG9uYCBhbmQgYG9uY2VgLiBUZWxsICp0aGlzKiBvYmplY3QgdG8KCSAgLy8gbGlzdGVuIHRvIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncwoJICAvLyBsaXN0ZW5pbmcgdG8uCgkgIF8uZWFjaChsaXN0ZW5NZXRob2RzLCBmdW5jdGlvbihpbXBsZW1lbnRhdGlvbiwgbWV0aG9kKSB7CgkgICAgRXZlbnRzW21ldGhvZF0gPSBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CgkgICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbyB8fCAodGhpcy5fbGlzdGVuaW5nVG8gPSB7fSk7CgkgICAgICB2YXIgaWQgPSBvYmouX2xpc3RlbklkIHx8IChvYmouX2xpc3RlbklkID0gXy51bmlxdWVJZCgnbCcpKTsKCSAgICAgIGxpc3RlbmluZ1RvW2lkXSA9IG9iajsKCSAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CgkgICAgICBvYmpbaW1wbGVtZW50YXRpb25dKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCgkgIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CgkgIEV2ZW50cy51bmJpbmQgPSBFdmVudHMub2ZmOwoKCSAgLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwoJICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCgkgIF8uZXh0ZW5kKEJhY2tib25lLCBFdmVudHMpOwoKCSAgLy8gQmFja2JvbmUuTW9kZWwKCSAgLy8gLS0tLS0tLS0tLS0tLS0KCgkgIC8vIEJhY2tib25lICoqTW9kZWxzKiogYXJlIHRoZSBiYXNpYyBkYXRhIG9iamVjdCBpbiB0aGUgZnJhbWV3b3JrIC0tCgkgIC8vIGZyZXF1ZW50bHkgcmVwcmVzZW50aW5nIGEgcm93IGluIGEgdGFibGUgaW4gYSBkYXRhYmFzZSBvbiB5b3VyIHNlcnZlci4KCSAgLy8gQSBkaXNjcmV0ZSBjaHVuayBvZiBkYXRhIGFuZCBhIGJ1bmNoIG9mIHVzZWZ1bCwgcmVsYXRlZCBtZXRob2RzIGZvcgoJICAvLyBwZXJmb3JtaW5nIGNvbXB1dGF0aW9ucyBhbmQgdHJhbnNmb3JtYXRpb25zIG9uIHRoYXQgZGF0YS4KCgkgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIHRoZSBzcGVjaWZpZWQgYXR0cmlidXRlcy4gQSBjbGllbnQgaWQgKGBjaWRgKQoJICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KCSAgdmFyIE1vZGVsID0gQmFja2JvbmUuTW9kZWwgPSBmdW5jdGlvbihhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CgkgICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKCSAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgnYycpOwoJICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwoJICAgIGlmIChvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKCSAgICBpZiAob3B0aW9ucy5wYXJzZSkgYXR0cnMgPSB0aGlzLnBhcnNlKGF0dHJzLCBvcHRpb25zKSB8fCB7fTsKCSAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSk7CgkgICAgdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpOwoJICAgIHRoaXMuY2hhbmdlZCA9IHt9OwoJICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICB9OwoKCSAgLy8gQXR0YWNoIGFsbCBpbmhlcml0YWJsZSBtZXRob2RzIHRvIHRoZSBNb2RlbCBwcm90b3R5cGUuCgkgIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgoJICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KCSAgICBjaGFuZ2VkOiBudWxsLAoKCSAgICAvLyBUaGUgdmFsdWUgcmV0dXJuZWQgZHVyaW5nIHRoZSBsYXN0IGZhaWxlZCB2YWxpZGF0aW9uLgoJICAgIHZhbGlkYXRpb25FcnJvcjogbnVsbCwKCgkgICAgLy8gVGhlIGRlZmF1bHQgbmFtZSBmb3IgdGhlIEpTT04gYGlkYCBhdHRyaWJ1dGUgaXMgYCJpZCJgLiBNb25nb0RCIGFuZAoJICAgIC8vIENvdWNoREIgdXNlcnMgbWF5IHdhbnQgdG8gc2V0IHRoaXMgdG8gYCJfaWQiYC4KCSAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCgkgICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCgkgICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCgkgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKCSAgICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBtb2RlbCdzIGBhdHRyaWJ1dGVzYCBvYmplY3QuCgkgICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwoJICAgIH0sCgoJICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0IC0tIGJ1dCBvdmVycmlkZSB0aGlzIGlmIHlvdSBuZWVkCgkgICAgLy8gY3VzdG9tIHN5bmNpbmcgc2VtYW50aWNzIGZvciAqdGhpcyogcGFydGljdWxhciBtb2RlbC4KCSAgICBzeW5jOiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgICAgfSwKCgkgICAgLy8gR2V0IHRoZSB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCgkgICAgZ2V0OiBmdW5jdGlvbihhdHRyKSB7CgkgICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwoJICAgIH0sCgoJICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KCSAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKCSAgICAgIHJldHVybiBfLmVzY2FwZSh0aGlzLmdldChhdHRyKSk7CgkgICAgfSwKCgkgICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKCSAgICAvLyBvciB1bmRlZmluZWQuCgkgICAgaGFzOiBmdW5jdGlvbihhdHRyKSB7CgkgICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKCSAgICB9LAoKCSAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMgb24gdGhlIG9iamVjdCwgZmlyaW5nIGAiY2hhbmdlImAuIFRoaXMgaXMKCSAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKCSAgICAvLyBhbnlvbmUgd2hvIG5lZWRzIHRvIGtub3cgYWJvdXQgdGhlIGNoYW5nZSBpbiBzdGF0ZS4gVGhlIGhlYXJ0IG9mIHRoZSBiZWFzdC4KCSAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CgkgICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwoJICAgICAgaWYgKGtleSA9PSBudWxsKSByZXR1cm4gdGhpczsKCgkgICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KCSAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewoJICAgICAgICBhdHRycyA9IGtleTsKCSAgICAgICAgb3B0aW9ucyA9IHZhbDsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwoJICAgICAgfQoKCSAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgoJICAgICAgLy8gUnVuIHZhbGlkYXRpb24uCgkgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKCSAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KCSAgICAgIHVuc2V0ICAgICAgICAgICA9IG9wdGlvbnMudW5zZXQ7CgkgICAgICBzaWxlbnQgICAgICAgICAgPSBvcHRpb25zLnNpbGVudDsKCSAgICAgIGNoYW5nZXMgICAgICAgICA9IFtdOwoJICAgICAgY2hhbmdpbmcgICAgICAgID0gdGhpcy5fY2hhbmdpbmc7CgkgICAgICB0aGlzLl9jaGFuZ2luZyAgPSB0cnVlOwoKCSAgICAgIGlmICghY2hhbmdpbmcpIHsKCSAgICAgICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwoJICAgICAgICB0aGlzLmNoYW5nZWQgPSB7fTsKCSAgICAgIH0KCSAgICAgIGN1cnJlbnQgPSB0aGlzLmF0dHJpYnV0ZXMsIHByZXYgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CgoJICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KCSAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgoJICAgICAgLy8gRm9yIGVhY2ggYHNldGAgYXR0cmlidXRlLCB1cGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLgoJICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CgkgICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwoJICAgICAgICBpZiAoIV8uaXNFcXVhbChjdXJyZW50W2F0dHJdLCB2YWwpKSBjaGFuZ2VzLnB1c2goYXR0cik7CgkgICAgICAgIGlmICghXy5pc0VxdWFsKHByZXZbYXR0cl0sIHZhbCkpIHsKCSAgICAgICAgICB0aGlzLmNoYW5nZWRbYXR0cl0gPSB2YWw7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgZGVsZXRlIHRoaXMuY2hhbmdlZFthdHRyXTsKCSAgICAgICAgfQoJICAgICAgICB1bnNldCA/IGRlbGV0ZSBjdXJyZW50W2F0dHJdIDogY3VycmVudFthdHRyXSA9IHZhbDsKCSAgICAgIH0KCgkgICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KCSAgICAgIGlmICghc2lsZW50KSB7CgkgICAgICAgIGlmIChjaGFuZ2VzLmxlbmd0aCkgdGhpcy5fcGVuZGluZyA9IG9wdGlvbnM7CgkgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hhbmdlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCSAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgY2hhbmdlc1tpXSwgdGhpcywgY3VycmVudFtjaGFuZ2VzW2ldXSwgb3B0aW9ucyk7CgkgICAgICAgIH0KCSAgICAgIH0KCgkgICAgICAvLyBZb3UgbWlnaHQgYmUgd29uZGVyaW5nIHdoeSB0aGVyZSdzIGEgYHdoaWxlYCBsb29wIGhlcmUuIENoYW5nZXMgY2FuCgkgICAgICAvLyBiZSByZWN1cnNpdmVseSBuZXN0ZWQgd2l0aGluIGAiY2hhbmdlImAgZXZlbnRzLgoJICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKCSAgICAgIGlmICghc2lsZW50KSB7CgkgICAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7CgkgICAgICAgICAgb3B0aW9ucyA9IHRoaXMuX3BlbmRpbmc7CgkgICAgICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwoJICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlJywgdGhpcywgb3B0aW9ucyk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKCSAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4gYHVuc2V0YCBpcyBhIG5vb3AKCSAgICAvLyBpZiB0aGUgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QuCgkgICAgdW5zZXQ6IGZ1bmN0aW9uKGF0dHIsIG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CgkgICAgfSwKCgkgICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4KCSAgICBjbGVhcjogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgdmFyIGF0dHJzID0ge307CgkgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5hdHRyaWJ1dGVzKSBhdHRyc1trZXldID0gdm9pZCAwOwoJICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwoJICAgIH0sCgoJICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KCSAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgoJICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uKGF0dHIpIHsKCSAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CgkgICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKCSAgICB9LAoKCSAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIHRoZSBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkLCBvcgoJICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAoJICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCgkgICAgLy8gcGVyc2lzdGVkIHRvIHRoZSBzZXJ2ZXIuIFVuc2V0IGF0dHJpYnV0ZXMgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgoJICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCgkgICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KCSAgICBjaGFuZ2VkQXR0cmlidXRlczogZnVuY3Rpb24oZGlmZikgewoJICAgICAgaWYgKCFkaWZmKSByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKCSAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKCSAgICAgIHZhciBvbGQgPSB0aGlzLl9jaGFuZ2luZyA/IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA6IHRoaXMuYXR0cmlidXRlczsKCSAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewoJICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgKHZhbCA9IGRpZmZbYXR0cl0pKSkgY29udGludWU7CgkgICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKCSAgICAgIH0KCSAgICAgIHJldHVybiBjaGFuZ2VkOwoJICAgIH0sCgoJICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAoJICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgoJICAgIHByZXZpb3VzOiBmdW5jdGlvbihhdHRyKSB7CgkgICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwoJICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlc1thdHRyXTsKCSAgICB9LAoKCSAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKCSAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgoJICAgIHByZXZpb3VzQXR0cmlidXRlczogZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwoJICAgIH0sCgoJICAgIC8vIEZldGNoIHRoZSBtb2RlbCBmcm9tIHRoZSBzZXJ2ZXIuIElmIHRoZSBzZXJ2ZXIncyByZXByZXNlbnRhdGlvbiBvZiB0aGUKCSAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRkZW4sCgkgICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCgkgICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoJICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CgkgICAgICB2YXIgbW9kZWwgPSB0aGlzOwoJICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgkgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CgkgICAgICAgIGlmICghbW9kZWwuc2V0KG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoJICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkgICAgICB9OwoJICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoJICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwoJICAgIH0sCgoJICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcywgYW5kIHN5bmMgdGhlIG1vZGVsIHRvIHRoZSBzZXJ2ZXIuCgkgICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCgkgICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KCSAgICBzYXZlOiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewoJICAgICAgdmFyIGF0dHJzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKCgkgICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KCSAgICAgIGlmIChrZXkgPT0gbnVsbCB8fCB0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewoJICAgICAgICBhdHRycyA9IGtleTsKCSAgICAgICAgb3B0aW9ucyA9IHZhbDsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwoJICAgICAgfQoKCSAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7dmFsaWRhdGU6IHRydWV9LCBvcHRpb25zKTsKCgkgICAgICAvLyBJZiB3ZSdyZSBub3Qgd2FpdGluZyBhbmQgYXR0cmlidXRlcyBleGlzdCwgc2F2ZSBhY3RzIGFzCgkgICAgICAvLyBgc2V0KGF0dHIpLnNhdmUobnVsbCwgb3B0cylgIHdpdGggdmFsaWRhdGlvbi4gT3RoZXJ3aXNlLCBjaGVjayBpZgoJICAgICAgLy8gdGhlIG1vZGVsIHdpbGwgYmUgdmFsaWQgd2hlbiB0aGUgYXR0cmlidXRlcywgaWYgYW55LCBhcmUgc2V0LgoJICAgICAgaWYgKGF0dHJzICYmICFvcHRpb25zLndhaXQpIHsKCSAgICAgICAgaWYgKCF0aGlzLnNldChhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgkgICAgICB9CgoJICAgICAgLy8gU2V0IHRlbXBvcmFyeSBhdHRyaWJ1dGVzIGlmIGB7d2FpdDogdHJ1ZX1gLgoJICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgewoJICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7fSwgYXR0cmlidXRlcywgYXR0cnMpOwoJICAgICAgfQoKCSAgICAgIC8vIEFmdGVyIGEgc3VjY2Vzc2Z1bCBzZXJ2ZXItc2lkZSBzYXZlLCB0aGUgY2xpZW50IGlzIChvcHRpb25hbGx5KQoJICAgICAgLy8gdXBkYXRlZCB3aXRoIHRoZSBzZXJ2ZXItc2lkZSBzdGF0ZS4KCSAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwoJICAgICAgdmFyIG1vZGVsID0gdGhpczsKCSAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoJICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewoJICAgICAgICAvLyBFbnN1cmUgYXR0cmlidXRlcyBhcmUgcmVzdG9yZWQgZHVyaW5nIHN5bmNocm9ub3VzIHNhdmVzLgoJICAgICAgICBtb2RlbC5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKCSAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyk7CgkgICAgICAgIGlmIChvcHRpb25zLndhaXQpIHNlcnZlckF0dHJzID0gXy5leHRlbmQoYXR0cnMgfHwge30sIHNlcnZlckF0dHJzKTsKCSAgICAgICAgaWYgKF8uaXNPYmplY3Qoc2VydmVyQXR0cnMpICYmICFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSB7CgkgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgICB9CgkgICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICAgIH07CgkgICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgoJICAgICAgbWV0aG9kID0gdGhpcy5pc05ldygpID8gJ2NyZWF0ZScgOiAob3B0aW9ucy5wYXRjaCA/ICdwYXRjaCcgOiAndXBkYXRlJyk7CgkgICAgICBpZiAobWV0aG9kID09PSAncGF0Y2gnKSBvcHRpb25zLmF0dHJzID0gYXR0cnM7CgkgICAgICB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCgkgICAgICAvLyBSZXN0b3JlIGF0dHJpYnV0ZXMuCgkgICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB0aGlzLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwoKCSAgICAgIHJldHVybiB4aHI7CgkgICAgfSwKCgkgICAgLy8gRGVzdHJveSB0aGlzIG1vZGVsIG9uIHRoZSBzZXJ2ZXIgaWYgaXQgd2FzIGFscmVhZHkgcGVyc2lzdGVkLgoJICAgIC8vIE9wdGltaXN0aWNhbGx5IHJlbW92ZXMgdGhlIG1vZGVsIGZyb20gaXRzIGNvbGxlY3Rpb24sIGlmIGl0IGhhcyBvbmUuCgkgICAgLy8gSWYgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgd2FpdHMgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZCBiZWZvcmUgcmVtb3ZhbC4KCSAgICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKCSAgICAgIHZhciBtb2RlbCA9IHRoaXM7CgkgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCgkgICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOwoJICAgICAgfTsKCgkgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CgkgICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwoJICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkgICAgICAgIGlmICghbW9kZWwuaXNOZXcoKSkgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICAgIH07CgoJICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgewoJICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsKCSAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgfQoJICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoKCSAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMoJ2RlbGV0ZScsIHRoaXMsIG9wdGlvbnMpOwoJICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKCSAgICAgIHJldHVybiB4aHI7CgkgICAgfSwKCgkgICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCgkgICAgLy8gdXNpbmcgQmFja2JvbmUncyByZXN0ZnVsIG1ldGhvZHMsIG92ZXJyaWRlIHRoaXMgdG8gY2hhbmdlIHRoZSBlbmRwb2ludAoJICAgIC8vIHRoYXQgd2lsbCBiZSBjYWxsZWQuCgkgICAgdXJsOiBmdW5jdGlvbigpIHsKCSAgICAgIHZhciBiYXNlID0KCSAgICAgICAgXy5yZXN1bHQodGhpcywgJ3VybFJvb3QnKSB8fAoJICAgICAgICBfLnJlc3VsdCh0aGlzLmNvbGxlY3Rpb24sICd1cmwnKSB8fAoJICAgICAgICB1cmxFcnJvcigpOwoJICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgcmV0dXJuIGJhc2U7CgkgICAgICByZXR1cm4gYmFzZS5yZXBsYWNlKC8oW15cL10pJC8sICckMS8nKSArIGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLmlkKTsKCSAgICB9LAoKCSAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIHRoZSBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYHNldGAgb24KCSAgICAvLyB0aGUgbW9kZWwuIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyB0aGUgcmVzcG9uc2UgYWxvbmcuCgkgICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiByZXNwOwoJICAgIH0sCgoJICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgoJICAgIGNsb25lOiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLmF0dHJpYnV0ZXMpOwoJICAgIH0sCgoJICAgIC8vIEEgbW9kZWwgaXMgbmV3IGlmIGl0IGhhcyBuZXZlciBiZWVuIHNhdmVkIHRvIHRoZSBzZXJ2ZXIsIGFuZCBsYWNrcyBhbiBpZC4KCSAgICBpc05ldzogZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gIXRoaXMuaGFzKHRoaXMuaWRBdHRyaWJ1dGUpOwoJICAgIH0sCgoJICAgIC8vIENoZWNrIGlmIHRoZSBtb2RlbCBpcyBjdXJyZW50bHkgaW4gYSB2YWxpZCBzdGF0ZS4KCSAgICBpc1ZhbGlkOiBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgICByZXR1cm4gdGhpcy5fdmFsaWRhdGUoe30sIF8uZXh0ZW5kKG9wdGlvbnMgfHwge30sIHsgdmFsaWRhdGU6IHRydWUgfSkpOwoJICAgIH0sCgoJICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgdGhlIG5leHQgY29tcGxldGUgc2V0IG9mIG1vZGVsIGF0dHJpYnV0ZXMsCgkgICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gT3RoZXJ3aXNlLCBmaXJlIGFuIGAiaW52YWxpZCJgIGV2ZW50LgoJICAgIF92YWxpZGF0ZTogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKCSAgICAgIGlmICghb3B0aW9ucy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CgkgICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKCSAgICAgIHZhciBlcnJvciA9IHRoaXMudmFsaWRhdGlvbkVycm9yID0gdGhpcy52YWxpZGF0ZShhdHRycywgb3B0aW9ucykgfHwgbnVsbDsKCSAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOwoJICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgZXJyb3IsIF8uZXh0ZW5kKG9wdGlvbnMsIHt2YWxpZGF0aW9uRXJyb3I6IGVycm9yfSkpOwoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCgkgIH0pOwoKCSAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIE1vZGVsLgoJICB2YXIgbW9kZWxNZXRob2RzID0gWydrZXlzJywgJ3ZhbHVlcycsICdwYWlycycsICdpbnZlcnQnLCAncGljaycsICdvbWl0J107CgoJICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBNb2RlbCNhdHRyaWJ1dGVzYC4KCSAgXy5lYWNoKG1vZGVsTWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CgkgICAgTW9kZWwucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKCSAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwoJICAgICAgYXJncy51bnNoaWZ0KHRoaXMuYXR0cmlidXRlcyk7CgkgICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gQmFja2JvbmUuQ29sbGVjdGlvbgoJICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBJZiBtb2RlbHMgdGVuZCB0byByZXByZXNlbnQgYSBzaW5nbGUgcm93IG9mIGRhdGEsIGEgQmFja2JvbmUgQ29sbGVjdGlvbiBpcwoJICAvLyBtb3JlIGFuYWxhZ291cyB0byBhIHRhYmxlIGZ1bGwgb2YgZGF0YSAuLi4gb3IgYSBzbWFsbCBzbGljZSBvciBwYWdlIG9mIHRoYXQKCSAgLy8gdGFibGUsIG9yIGEgY29sbGVjdGlvbiBvZiByb3dzIHRoYXQgYmVsb25nIHRvZ2V0aGVyIGZvciBhIHBhcnRpY3VsYXIgcmVhc29uCgkgIC8vIC0tIGFsbCBvZiB0aGUgbWVzc2FnZXMgaW4gdGhpcyBwYXJ0aWN1bGFyIGZvbGRlciwgYWxsIG9mIHRoZSBkb2N1bWVudHMKCSAgLy8gYmVsb25naW5nIHRvIHRoaXMgcGFydGljdWxhciBhdXRob3IsIGFuZCBzbyBvbi4gQ29sbGVjdGlvbnMgbWFpbnRhaW4KCSAgLy8gaW5kZXhlcyBvZiB0aGVpciBtb2RlbHMsIGJvdGggaW4gb3JkZXIsIGFuZCBmb3IgbG9va3VwIGJ5IGBpZGAuCgoJICAvLyBDcmVhdGUgYSBuZXcgKipDb2xsZWN0aW9uKiosIHBlcmhhcHMgdG8gY29udGFpbiBhIHNwZWNpZmljIHR5cGUgb2YgYG1vZGVsYC4KCSAgLy8gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCgkgIC8vIGl0cyBtb2RlbHMgaW4gc29ydCBvcmRlciwgYXMgdGhleSdyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KCSAgdmFyIENvbGxlY3Rpb24gPSBCYWNrYm9uZS5Db2xsZWN0aW9uID0gZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CgkgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCSAgICBpZiAob3B0aW9ucy5tb2RlbCkgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7CgkgICAgaWYgKG9wdGlvbnMuY29tcGFyYXRvciAhPT0gdm9pZCAwKSB0aGlzLmNvbXBhcmF0b3IgPSBvcHRpb25zLmNvbXBhcmF0b3I7CgkgICAgdGhpcy5fcmVzZXQoKTsKCSAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICBpZiAobW9kZWxzKSB0aGlzLnJlc2V0KG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKCSAgfTsKCgkgIC8vIERlZmF1bHQgb3B0aW9ucyBmb3IgYENvbGxlY3Rpb24jc2V0YC4KCSAgdmFyIHNldE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IHRydWUsIG1lcmdlOiB0cnVlfTsKCSAgdmFyIGFkZE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IGZhbHNlfTsKCgkgIC8vIERlZmluZSB0aGUgQ29sbGVjdGlvbidzIGluaGVyaXRhYmxlIG1ldGhvZHMuCgkgIF8uZXh0ZW5kKENvbGxlY3Rpb24ucHJvdG90eXBlLCBFdmVudHMsIHsKCgkgICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgoJICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4KCSAgICBtb2RlbDogTW9kZWwsCgoJICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgoJICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgoJICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCgkgICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQoJICAgIC8vIG1vZGVscycgYXR0cmlidXRlcy4KCSAgICB0b0pTT046IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwoJICAgIH0sCgoJICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0LgoJICAgIHN5bmM6IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICB9LAoKCSAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4KCSAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewoJICAgICAgcmV0dXJuIHRoaXMuc2V0KG1vZGVscywgXy5leHRlbmQoe21lcmdlOiBmYWxzZX0sIG9wdGlvbnMsIGFkZE9wdGlvbnMpKTsKCSAgICB9LAoKCSAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuCgkgICAgcmVtb3ZlOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKCSAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKCSAgICAgIG1vZGVscyA9IHNpbmd1bGFyID8gW21vZGVsc10gOiBfLmNsb25lKG1vZGVscyk7CgkgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsKCSAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5nZXQobW9kZWxzW2ldKTsKCSAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CgkgICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKCSAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuY2lkXTsKCSAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwoJICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoaW5kZXgsIDEpOwoJICAgICAgICB0aGlzLmxlbmd0aC0tOwoJICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CgkgICAgICAgICAgb3B0aW9ucy5pbmRleCA9IGluZGV4OwoJICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlbW92ZScsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKCSAgICAgICAgfQoJICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UobW9kZWwsIG9wdGlvbnMpOwoJICAgICAgfQoJICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwoJICAgIH0sCgoJICAgIC8vIFVwZGF0ZSBhIGNvbGxlY3Rpb24gYnkgYHNldGAtaW5nIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCBhZGRpbmcgbmV3IG9uZXMsCgkgICAgLy8gcmVtb3ZpbmcgbW9kZWxzIHRoYXQgYXJlIG5vIGxvbmdlciBwcmVzZW50LCBhbmQgbWVyZ2luZyBtb2RlbHMgdGhhdAoJICAgIC8vIGFscmVhZHkgZXhpc3QgaW4gdGhlIGNvbGxlY3Rpb24sIGFzIG5lY2Vzc2FyeS4gU2ltaWxhciB0byAqKk1vZGVsI3NldCoqLAoJICAgIC8vIHRoZSBjb3JlIG9wZXJhdGlvbiBmb3IgdXBkYXRpbmcgdGhlIGRhdGEgY29udGFpbmVkIGJ5IHRoZSBjb2xsZWN0aW9uLgoJICAgIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CgkgICAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7fSwgb3B0aW9ucywgc2V0T3B0aW9ucyk7CgkgICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMsIG9wdGlvbnMpOwoJICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwoJICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyAobW9kZWxzID8gW21vZGVsc10gOiBbXSkgOiBfLmNsb25lKG1vZGVscyk7CgkgICAgICB2YXIgaSwgbCwgaWQsIG1vZGVsLCBhdHRycywgZXhpc3RpbmcsIHNvcnQ7CgkgICAgICB2YXIgYXQgPSBvcHRpb25zLmF0OwoJICAgICAgdmFyIHRhcmdldE1vZGVsID0gdGhpcy5tb2RlbDsKCSAgICAgIHZhciBzb3J0YWJsZSA9IHRoaXMuY29tcGFyYXRvciAmJiAoYXQgPT0gbnVsbCkgJiYgb3B0aW9ucy5zb3J0ICE9PSBmYWxzZTsKCSAgICAgIHZhciBzb3J0QXR0ciA9IF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSA/IHRoaXMuY29tcGFyYXRvciA6IG51bGw7CgkgICAgICB2YXIgdG9BZGQgPSBbXSwgdG9SZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKCSAgICAgIHZhciBhZGQgPSBvcHRpb25zLmFkZCwgbWVyZ2UgPSBvcHRpb25zLm1lcmdlLCByZW1vdmUgPSBvcHRpb25zLnJlbW92ZTsKCSAgICAgIHZhciBvcmRlciA9ICFzb3J0YWJsZSAmJiBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKCgkgICAgICAvLyBUdXJuIGJhcmUgb2JqZWN0cyBpbnRvIG1vZGVsIHJlZmVyZW5jZXMsIGFuZCBwcmV2ZW50IGludmFsaWQgbW9kZWxzCgkgICAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLgoJICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCSAgICAgICAgYXR0cnMgPSBtb2RlbHNbaV0gfHwge307CgkgICAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSB7CgkgICAgICAgICAgaWQgPSBtb2RlbCA9IGF0dHJzOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIGlkID0gYXR0cnNbdGFyZ2V0TW9kZWwucHJvdG90eXBlLmlkQXR0cmlidXRlIHx8ICdpZCddOwoJICAgICAgICB9CgoJICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAoJICAgICAgICAvLyBvcHRpb25hbGx5IG1lcmdlIGl0IGludG8gdGhlIGV4aXN0aW5nIG1vZGVsLgoJICAgICAgICBpZiAoZXhpc3RpbmcgPSB0aGlzLmdldChpZCkpIHsKCSAgICAgICAgICBpZiAocmVtb3ZlKSBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKCSAgICAgICAgICBpZiAobWVyZ2UpIHsKCSAgICAgICAgICAgIGF0dHJzID0gYXR0cnMgPT09IG1vZGVsID8gbW9kZWwuYXR0cmlidXRlcyA6IGF0dHJzOwoJICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gZXhpc3RpbmcucGFyc2UoYXR0cnMsIG9wdGlvbnMpOwoJICAgICAgICAgICAgZXhpc3Rpbmcuc2V0KGF0dHJzLCBvcHRpb25zKTsKCSAgICAgICAgICAgIGlmIChzb3J0YWJsZSAmJiAhc29ydCAmJiBleGlzdGluZy5oYXNDaGFuZ2VkKHNvcnRBdHRyKSkgc29ydCA9IHRydWU7CgkgICAgICAgICAgfQoJICAgICAgICAgIG1vZGVsc1tpXSA9IGV4aXN0aW5nOwoKCSAgICAgICAgLy8gSWYgdGhpcyBpcyBhIG5ldywgdmFsaWQgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KCSAgICAgICAgfSBlbHNlIGlmIChhZGQpIHsKCSAgICAgICAgICBtb2RlbCA9IG1vZGVsc1tpXSA9IHRoaXMuX3ByZXBhcmVNb2RlbChhdHRycywgb3B0aW9ucyk7CgkgICAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CgkgICAgICAgICAgdG9BZGQucHVzaChtb2RlbCk7CgkgICAgICAgICAgdGhpcy5fYWRkUmVmZXJlbmNlKG1vZGVsLCBvcHRpb25zKTsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gRG8gbm90IGFkZCBtdWx0aXBsZSBtb2RlbHMgd2l0aCB0aGUgc2FtZSBgaWRgLgoJICAgICAgICBtb2RlbCA9IGV4aXN0aW5nIHx8IG1vZGVsOwoJICAgICAgICBpZiAob3JkZXIgJiYgKG1vZGVsLmlzTmV3KCkgfHwgIW1vZGVsTWFwW21vZGVsLmlkXSkpIG9yZGVyLnB1c2gobW9kZWwpOwoJICAgICAgICBtb2RlbE1hcFttb2RlbC5pZF0gPSB0cnVlOwoJICAgICAgfQoKCSAgICAgIC8vIFJlbW92ZSBub25leGlzdGVudCBtb2RlbHMgaWYgYXBwcm9wcmlhdGUuCgkgICAgICBpZiAocmVtb3ZlKSB7CgkgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7ICsraSkgewoJICAgICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwoJICAgICAgICB9CgkgICAgICAgIGlmICh0b1JlbW92ZS5sZW5ndGgpIHRoaXMucmVtb3ZlKHRvUmVtb3ZlLCBvcHRpb25zKTsKCSAgICAgIH0KCgkgICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCgkgICAgICBpZiAodG9BZGQubGVuZ3RoIHx8IChvcmRlciAmJiBvcmRlci5sZW5ndGgpKSB7CgkgICAgICAgIGlmIChzb3J0YWJsZSkgc29ydCA9IHRydWU7CgkgICAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKCSAgICAgICAgaWYgKGF0ICE9IG51bGwpIHsKCSAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoYXQgKyBpLCAwLCB0b0FkZFtpXSk7CgkgICAgICAgICAgfQoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIGlmIChvcmRlcikgdGhpcy5tb2RlbHMubGVuZ3RoID0gMDsKCSAgICAgICAgICB2YXIgb3JkZXJlZE1vZGVscyA9IG9yZGVyIHx8IHRvQWRkOwoJICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBvcmRlcmVkTW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJICAgICAgICAgICAgdGhpcy5tb2RlbHMucHVzaChvcmRlcmVkTW9kZWxzW2ldKTsKCSAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgIH0KCgkgICAgICAvLyBTaWxlbnRseSBzb3J0IHRoZSBjb2xsZWN0aW9uIGlmIGFwcHJvcHJpYXRlLgoJICAgICAgaWYgKHNvcnQpIHRoaXMuc29ydCh7c2lsZW50OiB0cnVlfSk7CgoJICAgICAgLy8gVW5sZXNzIHNpbGVuY2VkLCBpdCdzIHRpbWUgdG8gZmlyZSBhbGwgYXBwcm9wcmlhdGUgYWRkL3NvcnQgZXZlbnRzLgoJICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewoJICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKCSAgICAgICAgfQoJICAgICAgICBpZiAoc29ydCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CgkgICAgICB9CgoJICAgICAgLy8gUmV0dXJuIHRoZSBhZGRlZCAob3IgbWVyZ2VkKSBtb2RlbCAob3IgbW9kZWxzKS4KCSAgICAgIHJldHVybiBzaW5ndWxhciA/IG1vZGVsc1swXSA6IG1vZGVsczsKCSAgICB9LAoKCSAgICAvLyBXaGVuIHlvdSBoYXZlIG1vcmUgaXRlbXMgdGhhbiB5b3Ugd2FudCB0byBhZGQgb3IgcmVtb3ZlIGluZGl2aWR1YWxseSwKCSAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCgkgICAgLy8gYW55IGdyYW51bGFyIGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgoJICAgIC8vIFVzZWZ1bCBmb3IgYnVsayBvcGVyYXRpb25zIGFuZCBvcHRpbWl6YXRpb25zLgoJICAgIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0sIG9wdGlvbnMpOwoJICAgICAgfQoJICAgICAgb3B0aW9ucy5wcmV2aW91c01vZGVscyA9IHRoaXMubW9kZWxzOwoJICAgICAgdGhpcy5fcmVzZXQoKTsKCSAgICAgIG1vZGVscyA9IHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKCSAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcigncmVzZXQnLCB0aGlzLCBvcHRpb25zKTsKCSAgICAgIHJldHVybiBtb2RlbHM7CgkgICAgfSwKCgkgICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KCSAgICBwdXNoOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewoJICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IHRoaXMubGVuZ3RofSwgb3B0aW9ucykpOwoJICAgIH0sCgoJICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KCSAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQodGhpcy5sZW5ndGggLSAxKTsKCSAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKCSAgICAgIHJldHVybiBtb2RlbDsKCSAgICB9LAoKCSAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgoJICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkgICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogMH0sIG9wdGlvbnMpKTsKCSAgICB9LAoKCSAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCgkgICAgc2hpZnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CgkgICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CgkgICAgICByZXR1cm4gbW9kZWw7CgkgICAgfSwKCgkgICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgoJICAgIHNsaWNlOiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBzbGljZS5hcHBseSh0aGlzLm1vZGVscywgYXJndW1lbnRzKTsKCSAgICB9LAoKCSAgICAvLyBHZXQgYSBtb2RlbCBmcm9tIHRoZSBzZXQgYnkgaWQuCgkgICAgZ2V0OiBmdW5jdGlvbihvYmopIHsKCSAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKCSAgICAgIHJldHVybiB0aGlzLl9ieUlkW29ial0gfHwgdGhpcy5fYnlJZFtvYmouaWRdIHx8IHRoaXMuX2J5SWRbb2JqLmNpZF07CgkgICAgfSwKCgkgICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCgkgICAgYXQ6IGZ1bmN0aW9uKGluZGV4KSB7CgkgICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwoJICAgIH0sCgoJICAgIC8vIFJldHVybiBtb2RlbHMgd2l0aCBtYXRjaGluZyBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIHNpbXBsZSBjYXNlcyBvZgoJICAgIC8vIGBmaWx0ZXJgLgoJICAgIHdoZXJlOiBmdW5jdGlvbihhdHRycywgZmlyc3QpIHsKCSAgICAgIGlmIChfLmlzRW1wdHkoYXR0cnMpKSByZXR1cm4gZmlyc3QgPyB2b2lkIDAgOiBbXTsKCSAgICAgIHJldHVybiB0aGlzW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewoJICAgICAgICAgIGlmIChhdHRyc1trZXldICE9PSBtb2RlbC5nZXQoa2V5KSkgcmV0dXJuIGZhbHNlOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgICAgfSk7CgkgICAgfSwKCgkgICAgLy8gUmV0dXJuIHRoZSBmaXJzdCBtb2RlbCB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzCgkgICAgLy8gb2YgYGZpbmRgLgoJICAgIGZpbmRXaGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKCSAgICAgIHJldHVybiB0aGlzLndoZXJlKGF0dHJzLCB0cnVlKTsKCSAgICB9LAoKCSAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCgkgICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQoJICAgIC8vIGlzIGFkZGVkLgoJICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIGlmICghdGhpcy5jb21wYXJhdG9yKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CgkgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoKCSAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgoJICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CgkgICAgICAgIHRoaXMubW9kZWxzID0gdGhpcy5zb3J0QnkodGhpcy5jb21wYXJhdG9yLCB0aGlzKTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHRoaXMubW9kZWxzLnNvcnQoXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcykpOwoJICAgICAgfQoKCSAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KCSAgICBwbHVjazogZnVuY3Rpb24oYXR0cikgewoJICAgICAgcmV0dXJuIF8uaW52b2tlKHRoaXMubW9kZWxzLCAnZ2V0JywgYXR0cik7CgkgICAgfSwKCgkgICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlCgkgICAgLy8gY29sbGVjdGlvbiB3aGVuIHRoZXkgYXJyaXZlLiBJZiBgcmVzZXQ6IHRydWVgIGlzIHBhc3NlZCwgdGhlIHJlc3BvbnNlCgkgICAgLy8gZGF0YSB3aWxsIGJlIHBhc3NlZCB0aHJvdWdoIHRoZSBgcmVzZXRgIG1ldGhvZCBpbnN0ZWFkIG9mIGBzZXRgLgoJICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKCSAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwoJICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgkgICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CgkgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CgkgICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlc2V0ID8gJ3Jlc2V0JyA6ICdzZXQnOwoJICAgICAgICBjb2xsZWN0aW9uW21ldGhvZF0ocmVzcCwgb3B0aW9ucyk7CgkgICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgICBjb2xsZWN0aW9uLnRyaWdnZXIoJ3N5bmMnLCBjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKCSAgICAgIH07CgkgICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgkgICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CgkgICAgfSwKCgkgICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgbW9kZWwgaW4gdGhpcyBjb2xsZWN0aW9uLiBBZGQgdGhlIG1vZGVsIHRvIHRoZQoJICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCgkgICAgLy8gd2FpdCBmb3IgdGhlIHNlcnZlciB0byBhZ3JlZS4KCSAgICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKCSAgICAgIGlmICghKG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKSkpIHJldHVybiBmYWxzZTsKCSAgICAgIGlmICghb3B0aW9ucy53YWl0KSB0aGlzLmFkZChtb2RlbCwgb3B0aW9ucyk7CgkgICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CgkgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCSAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKG1vZGVsLCByZXNwKSB7CgkgICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKCSAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgfTsKCSAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CgkgICAgICByZXR1cm4gbW9kZWw7CgkgICAgfSwKCgkgICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQoJICAgIC8vIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyBpdCB0aHJvdWdoLgoJICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CgkgICAgICByZXR1cm4gcmVzcDsKCSAgICB9LAoKCSAgICAvLyBDcmVhdGUgYSBuZXcgY29sbGVjdGlvbiB3aXRoIGFuIGlkZW50aWNhbCBsaXN0IG9mIG1vZGVscyBhcyB0aGlzIG9uZS4KCSAgICBjbG9uZTogZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5tb2RlbHMpOwoJICAgIH0sCgoJICAgIC8vIFByaXZhdGUgbWV0aG9kIHRvIHJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24KCSAgICAvLyBpcyBmaXJzdCBpbml0aWFsaXplZCBvciByZXNldC4KCSAgICBfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJICAgICAgdGhpcy5sZW5ndGggPSAwOwoJICAgICAgdGhpcy5tb2RlbHMgPSBbXTsKCSAgICAgIHRoaXMuX2J5SWQgID0ge307CgkgICAgfSwKCgkgICAgLy8gUHJlcGFyZSBhIGhhc2ggb2YgYXR0cmlidXRlcyAob3Igb3RoZXIgbW9kZWwpIHRvIGJlIGFkZGVkIHRvIHRoaXMKCSAgICAvLyBjb2xsZWN0aW9uLgoJICAgIF9wcmVwYXJlTW9kZWw6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CgkgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgcmV0dXJuIGF0dHJzOwoJICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CgkgICAgICBvcHRpb25zLmNvbGxlY3Rpb24gPSB0aGlzOwoJICAgICAgdmFyIG1vZGVsID0gbmV3IHRoaXMubW9kZWwoYXR0cnMsIG9wdGlvbnMpOwoJICAgICAgaWYgKCFtb2RlbC52YWxpZGF0aW9uRXJyb3IpIHJldHVybiBtb2RlbDsKCSAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIHRoaXMsIG1vZGVsLnZhbGlkYXRpb25FcnJvciwgb3B0aW9ucyk7CgkgICAgICByZXR1cm4gZmFsc2U7CgkgICAgfSwKCgkgICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGNyZWF0ZSBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCgkgICAgX2FkZFJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKCSAgICAgIHRoaXMuX2J5SWRbbW9kZWwuY2lkXSA9IG1vZGVsOwoJICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CgkgICAgICBpZiAoIW1vZGVsLmNvbGxlY3Rpb24pIG1vZGVsLmNvbGxlY3Rpb24gPSB0aGlzOwoJICAgICAgbW9kZWwub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CgkgICAgfSwKCgkgICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNldmVyIGEgbW9kZWwncyB0aWVzIHRvIGEgY29sbGVjdGlvbi4KCSAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewoJICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwoJICAgICAgbW9kZWwub2ZmKCdhbGwnLCB0aGlzLl9vbk1vZGVsRXZlbnQsIHRoaXMpOwoJICAgIH0sCgoJICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCgkgICAgLy8gU2V0cyBuZWVkIHRvIHVwZGF0ZSB0aGVpciBpbmRleGVzIHdoZW4gbW9kZWxzIGNoYW5nZSBpZHMuIEFsbCBvdGhlcgoJICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQoJICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgoJICAgIF9vbk1vZGVsRXZlbnQ6IGZ1bmN0aW9uKGV2ZW50LCBtb2RlbCwgY29sbGVjdGlvbiwgb3B0aW9ucykgewoJICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CgkgICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwoJICAgICAgaWYgKG1vZGVsICYmIGV2ZW50ID09PSAnY2hhbmdlOicgKyBtb2RlbC5pZEF0dHJpYnV0ZSkgewoJICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwoJICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKCSAgICAgIH0KCSAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgIH0KCgkgIH0pOwoKCSAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCgkgIC8vIDkwJSBvZiB0aGUgY29yZSB1c2VmdWxuZXNzIG9mIEJhY2tib25lIENvbGxlY3Rpb25zIGlzIGFjdHVhbGx5IGltcGxlbWVudGVkCgkgIC8vIHJpZ2h0IGhlcmU6CgkgIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2ZvbGRsJywKCSAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLAoJICAgICdyZWplY3QnLCAnZXZlcnknLCAnYWxsJywgJ3NvbWUnLCAnYW55JywgJ2luY2x1ZGUnLCAnY29udGFpbnMnLCAnaW52b2tlJywKCSAgICAnbWF4JywgJ21pbicsICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaGVhZCcsICd0YWtlJywgJ2luaXRpYWwnLCAncmVzdCcsCgkgICAgJ3RhaWwnLCAnZHJvcCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnZGlmZmVyZW5jZScsICdpbmRleE9mJywgJ3NodWZmbGUnLAoJICAgICdsYXN0SW5kZXhPZicsICdpc0VtcHR5JywgJ2NoYWluJywgJ3NhbXBsZSddOwoKCSAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgoJICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CgkgICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CgkgICAgICBhcmdzLnVuc2hpZnQodGhpcy5tb2RlbHMpOwoJICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKCSAgICB9OwoJICB9KTsKCgkgIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHRha2UgYSBwcm9wZXJ0eSBuYW1lIGFzIGFuIGFyZ3VtZW50LgoJICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeScsICdpbmRleEJ5J107CgoJICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCgkgIF8uZWFjaChhdHRyaWJ1dGVNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKCSAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24odmFsdWUsIGNvbnRleHQpIHsKCSAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOwoJICAgICAgfTsKCSAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKCSAgICB9OwoJICB9KTsKCgkgIC8vIEJhY2tib25lLlZpZXcKCSAgLy8gLS0tLS0tLS0tLS0tLQoKCSAgLy8gQmFja2JvbmUgVmlld3MgYXJlIGFsbW9zdCBtb3JlIGNvbnZlbnRpb24gdGhhbiB0aGV5IGFyZSBhY3R1YWwgY29kZS4gQSBWaWV3CgkgIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCgkgIC8vIERPTS4gVGhpcyBtaWdodCBiZSBhIHNpbmdsZSBpdGVtLCBhbiBlbnRpcmUgbGlzdCwgYSBzaWRlYmFyIG9yIHBhbmVsLCBvcgoJICAvLyBldmVuIHRoZSBzdXJyb3VuZGluZyBmcmFtZSB3aGljaCB3cmFwcyB5b3VyIHdob2xlIGFwcC4gRGVmaW5pbmcgYSBjaHVuayBvZgoJICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CgkgIC8vIGhhdmluZyB0byB3b3JyeSBhYm91dCByZW5kZXIgb3JkZXIgLi4uIGFuZCBtYWtlcyBpdCBlYXN5IGZvciB0aGUgdmlldyB0bwoJICAvLyByZWFjdCB0byBzcGVjaWZpYyBjaGFuZ2VzIGluIHRoZSBzdGF0ZSBvZiB5b3VyIG1vZGVscy4KCgkgIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAoJICAvLyBpZiBhbiBleGlzdGluZyBlbGVtZW50IGlzIG5vdCBwcm92aWRlZC4uLgoJICB2YXIgVmlldyA9IEJhY2tib25lLlZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CgkgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCSAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgdmlld09wdGlvbnMpKTsKCSAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CgkgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwoJICB9OwoKCSAgLy8gQ2FjaGVkIHJlZ2V4IHRvIHNwbGl0IGtleXMgZm9yIGBkZWxlZ2F0ZWAuCgkgIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwoKCSAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCgkgIHZhciB2aWV3T3B0aW9ucyA9IFsnbW9kZWwnLCAnY29sbGVjdGlvbicsICdlbCcsICdpZCcsICdhdHRyaWJ1dGVzJywgJ2NsYXNzTmFtZScsICd0YWdOYW1lJywgJ2V2ZW50cyddOwoKCSAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlZpZXcqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgoJICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgoJICAgIC8vIFRoZSBkZWZhdWx0IGB0YWdOYW1lYCBvZiBhIFZpZXcncyBlbGVtZW50IGlzIGAiZGl2ImAuCgkgICAgdGFnTmFtZTogJ2RpdicsCgoJICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQoJICAgIC8vIGN1cnJlbnQgdmlldy4gVGhpcyBzaG91bGQgYmUgcHJlZmVycmVkIHRvIGdsb2JhbCBsb29rdXBzIHdoZXJlIHBvc3NpYmxlLgoJICAgICQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CgkgICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CgkgICAgfSwKCgkgICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCgkgICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCgkgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKCSAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKCSAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCgkgICAgLy8gY29udmVudGlvbiBpcyBmb3IgKipyZW5kZXIqKiB0byBhbHdheXMgcmV0dXJuIGB0aGlzYC4KCSAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBieSB0YWtpbmcgdGhlIGVsZW1lbnQgb3V0IG9mIHRoZSBET00sIGFuZCByZW1vdmluZyBhbnkKCSAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCgkgICAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKCSAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwoJICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKCSAgICAvLyByZS1kZWxlZ2F0aW9uLgoJICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGRlbGVnYXRlKSB7CgkgICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwoJICAgICAgdGhpcy4kZWwgPSBlbGVtZW50IGluc3RhbmNlb2YgQmFja2JvbmUuJCA/IGVsZW1lbnQgOiBCYWNrYm9uZS4kKGVsZW1lbnQpOwoJICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsWzBdOwoJICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKCSAgICAvLwoJICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCgkgICAgLy8KCSAgICAvLyAgICAgewoJICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKCSAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScsCgkgICAgLy8gICAgICAgJ2NsaWNrIC5vcGVuJzogICAgICAgZnVuY3Rpb24oZSkgeyAuLi4gfQoJICAgIC8vICAgICB9CgkgICAgLy8KCSAgICAvLyBwYWlycy4gQ2FsbGJhY2tzIHdpbGwgYmUgYm91bmQgdG8gdGhlIHZpZXcsIHdpdGggYHRoaXNgIHNldCBwcm9wZXJseS4KCSAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCgkgICAgLy8gT21pdHRpbmcgdGhlIHNlbGVjdG9yIGJpbmRzIHRoZSBldmVudCB0byBgdGhpcy5lbGAuCgkgICAgLy8gVGhpcyBvbmx5IHdvcmtzIGZvciBkZWxlZ2F0ZS1hYmxlIGV2ZW50czogbm90IGBmb2N1c2AsIGBibHVyYCwgYW5kCgkgICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCgkgICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewoJICAgICAgaWYgKCEoZXZlbnRzIHx8IChldmVudHMgPSBfLnJlc3VsdCh0aGlzLCAnZXZlbnRzJykpKSkgcmV0dXJuIHRoaXM7CgkgICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKCSAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKCSAgICAgICAgdmFyIG1ldGhvZCA9IGV2ZW50c1trZXldOwoJICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsKCSAgICAgICAgaWYgKCFtZXRob2QpIGNvbnRpbnVlOwoKCSAgICAgICAgdmFyIG1hdGNoID0ga2V5Lm1hdGNoKGRlbGVnYXRlRXZlbnRTcGxpdHRlcik7CgkgICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKCSAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CgkgICAgICAgIGV2ZW50TmFtZSArPSAnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkOwoJICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CgkgICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBtZXRob2QpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgc2VsZWN0b3IsIG1ldGhvZCk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIENsZWFycyBhbGwgY2FsbGJhY2tzIHByZXZpb3VzbHkgYm91bmQgdG8gdGhlIHZpZXcgd2l0aCBgZGVsZWdhdGVFdmVudHNgLgoJICAgIC8vIFlvdSB1c3VhbGx5IGRvbid0IG5lZWQgdG8gdXNlIHRoaXMsIGJ1dCBtYXkgd2lzaCB0byBpZiB5b3UgaGF2ZSBtdWx0aXBsZQoJICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgoJICAgIHVuZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKCkgewoJICAgICAgdGhpcy4kZWwub2ZmKCcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQpOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gRW5zdXJlIHRoYXQgdGhlIFZpZXcgaGFzIGEgRE9NIGVsZW1lbnQgdG8gcmVuZGVyIGludG8uCgkgICAgLy8gSWYgYHRoaXMuZWxgIGlzIGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggYCQoKWAsIHRha2UgdGhlIGZpcnN0CgkgICAgLy8gbWF0Y2hpbmcgZWxlbWVudCwgYW5kIHJlLWFzc2lnbiBpdCB0byBgZWxgLiBPdGhlcndpc2UsIGNyZWF0ZQoJICAgIC8vIGFuIGVsZW1lbnQgZnJvbSB0aGUgYGlkYCwgYGNsYXNzTmFtZWAgYW5kIGB0YWdOYW1lYCBwcm9wZXJ0aWVzLgoJICAgIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKCSAgICAgIGlmICghdGhpcy5lbCkgewoJICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ2F0dHJpYnV0ZXMnKSk7CgkgICAgICAgIGlmICh0aGlzLmlkKSBhdHRycy5pZCA9IF8ucmVzdWx0KHRoaXMsICdpZCcpOwoJICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwoJICAgICAgICB2YXIgJGVsID0gQmFja2JvbmUuJCgnPCcgKyBfLnJlc3VsdCh0aGlzLCAndGFnTmFtZScpICsgJz4nKS5hdHRyKGF0dHJzKTsKCSAgICAgICAgdGhpcy5zZXRFbGVtZW50KCRlbCwgZmFsc2UpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CgkgICAgICB9CgkgICAgfQoKCSAgfSk7CgoJICAvLyBCYWNrYm9uZS5zeW5jCgkgIC8vIC0tLS0tLS0tLS0tLS0KCgkgIC8vIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBtYW5uZXIgaW4gd2hpY2ggQmFja2JvbmUgcGVyc2lzdHMKCSAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCgkgIC8vIG1vZGVsIGluIHF1ZXN0aW9uLiBCeSBkZWZhdWx0LCBtYWtlcyBhIFJFU1RmdWwgQWpheCByZXF1ZXN0CgkgIC8vIHRvIHRoZSBtb2RlbCdzIGB1cmwoKWAuIFNvbWUgcG9zc2libGUgY3VzdG9taXphdGlvbnMgY291bGQgYmU6CgkgIC8vCgkgIC8vICogVXNlIGBzZXRUaW1lb3V0YCB0byBiYXRjaCByYXBpZC1maXJlIHVwZGF0ZXMgaW50byBhIHNpbmdsZSByZXF1ZXN0LgoJICAvLyAqIFNlbmQgdXAgdGhlIG1vZGVscyBhcyBYTUwgaW5zdGVhZCBvZiBKU09OLgoJICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KCSAgLy8KCSAgLy8gVHVybiBvbiBgQmFja2JvbmUuZW11bGF0ZUhUVFBgIGluIG9yZGVyIHRvIHNlbmQgYFBVVGAgYW5kIGBERUxFVEVgIHJlcXVlc3RzCgkgIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKCSAgLy8gYXMgd2VsbCBhcyBhbGwgcmVxdWVzdHMgd2l0aCB0aGUgYm9keSBhcyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYAoJICAvLyBpbnN0ZWFkIG9mIGBhcHBsaWNhdGlvbi9qc29uYCB3aXRoIHRoZSBtb2RlbCBpbiBhIHBhcmFtIG5hbWVkIGBtb2RlbGAuCgkgIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKCSAgLy8gaXQgZGlmZmljdWx0IHRvIHJlYWQgdGhlIGJvZHkgb2YgYFBVVGAgcmVxdWVzdHMuCgkgIEJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CgkgICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCgkgICAgLy8gRGVmYXVsdCBvcHRpb25zLCB1bmxlc3Mgc3BlY2lmaWVkLgoJICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgewoJICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAoJICAgICAgZW11bGF0ZUpTT046IEJhY2tib25lLmVtdWxhdGVKU09OCgkgICAgfSk7CgoJICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCgkgICAgdmFyIHBhcmFtcyA9IHt0eXBlOiB0eXBlLCBkYXRhVHlwZTogJ2pzb24nfTsKCgkgICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4KCSAgICBpZiAoIW9wdGlvbnMudXJsKSB7CgkgICAgICBwYXJhbXMudXJsID0gXy5yZXN1bHQobW9kZWwsICd1cmwnKSB8fCB1cmxFcnJvcigpOwoJICAgIH0KCgkgICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgoJICAgIGlmIChvcHRpb25zLmRhdGEgPT0gbnVsbCAmJiBtb2RlbCAmJiAobWV0aG9kID09PSAnY3JlYXRlJyB8fCBtZXRob2QgPT09ICd1cGRhdGUnIHx8IG1ldGhvZCA9PT0gJ3BhdGNoJykpIHsKCSAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKCSAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwoJICAgIH0KCgkgICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSlNPTiBieSBlbmNvZGluZyB0aGUgcmVxdWVzdCBpbnRvIGFuIEhUTUwtZm9ybS4KCSAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewoJICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCc7CgkgICAgICBwYXJhbXMuZGF0YSA9IHBhcmFtcy5kYXRhID8ge21vZGVsOiBwYXJhbXMuZGF0YX0gOiB7fTsKCSAgICB9CgoJICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEhUVFAgYnkgbWltaWNraW5nIHRoZSBIVFRQIG1ldGhvZCB3aXRoIGBfbWV0aG9kYAoJICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgoJICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewoJICAgICAgcGFyYW1zLnR5cGUgPSAnUE9TVCc7CgkgICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgcGFyYW1zLmRhdGEuX21ldGhvZCA9IHR5cGU7CgkgICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKCSAgICAgIG9wdGlvbnMuYmVmb3JlU2VuZCA9IGZ1bmN0aW9uKHhocikgewoJICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwoJICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgIH07CgkgICAgfQoKCSAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCgkgICAgaWYgKHBhcmFtcy50eXBlICE9PSAnR0VUJyAmJiAhb3B0aW9ucy5lbXVsYXRlSlNPTikgewoJICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7CgkgICAgfQoKCSAgICAvLyBJZiB3ZSdyZSBzZW5kaW5nIGEgYFBBVENIYCByZXF1ZXN0LCBhbmQgd2UncmUgaW4gYW4gb2xkIEludGVybmV0IEV4cGxvcmVyCgkgICAgLy8gdGhhdCBzdGlsbCBoYXMgQWN0aXZlWCBlbmFibGVkIGJ5IGRlZmF1bHQsIG92ZXJyaWRlIGpRdWVyeSB0byB1c2UgdGhhdAoJICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KCSAgICBpZiAocGFyYW1zLnR5cGUgPT09ICdQQVRDSCcgJiYgbm9YaHJQYXRjaCkgewoJICAgICAgcGFyYW1zLnhociA9IGZ1bmN0aW9uKCkgewoJICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CgkgICAgICB9OwoJICAgIH0KCgkgICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KCSAgICB2YXIgeGhyID0gb3B0aW9ucy54aHIgPSBCYWNrYm9uZS5hamF4KF8uZXh0ZW5kKHBhcmFtcywgb3B0aW9ucykpOwoJICAgIG1vZGVsLnRyaWdnZXIoJ3JlcXVlc3QnLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKCSAgICByZXR1cm4geGhyOwoJICB9OwoKCSAgdmFyIG5vWGhyUGF0Y2ggPQoJICAgIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmICEhd2luZG93LkFjdGl2ZVhPYmplY3QgJiYKCSAgICAgICEod2luZG93LlhNTEh0dHBSZXF1ZXN0ICYmIChuZXcgWE1MSHR0cFJlcXVlc3QpLmRpc3BhdGNoRXZlbnQpOwoKCSAgLy8gTWFwIGZyb20gQ1JVRCB0byBIVFRQIGZvciBvdXIgZGVmYXVsdCBgQmFja2JvbmUuc3luY2AgaW1wbGVtZW50YXRpb24uCgkgIHZhciBtZXRob2RNYXAgPSB7CgkgICAgJ2NyZWF0ZSc6ICdQT1NUJywKCSAgICAndXBkYXRlJzogJ1BVVCcsCgkgICAgJ3BhdGNoJzogICdQQVRDSCcsCgkgICAgJ2RlbGV0ZSc6ICdERUxFVEUnLAoJICAgICdyZWFkJzogICAnR0VUJwoJICB9OwoKCSAgLy8gU2V0IHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIGBCYWNrYm9uZS5hamF4YCB0byBwcm94eSB0aHJvdWdoIHRvIGAkYC4KCSAgLy8gT3ZlcnJpZGUgdGhpcyBpZiB5b3UnZCBsaWtlIHRvIHVzZSBhIGRpZmZlcmVudCBsaWJyYXJ5LgoJICBCYWNrYm9uZS5hamF4ID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIEJhY2tib25lLiQuYWpheC5hcHBseShCYWNrYm9uZS4kLCBhcmd1bWVudHMpOwoJICB9OwoKCSAgLy8gQmFja2JvbmUuUm91dGVyCgkgIC8vIC0tLS0tLS0tLS0tLS0tLQoKCSAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKCSAgLy8gbWF0Y2hlZC4gQ3JlYXRpbmcgYSBuZXcgb25lIHNldHMgaXRzIGByb3V0ZXNgIGhhc2gsIGlmIG5vdCBzZXQgc3RhdGljYWxseS4KCSAgdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgIGlmIChvcHRpb25zLnJvdXRlcykgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsKCSAgICB0aGlzLl9iaW5kUm91dGVzKCk7CgkgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgIH07CgoJICAvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkCgkgIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCgkgIHZhciBvcHRpb25hbFBhcmFtID0gL1woKC4qPylcKS9nOwoJICB2YXIgbmFtZWRQYXJhbSAgICA9IC8oXChcPyk/Olx3Ky9nOwoJICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwoJICB2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKCSAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlJvdXRlcioqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCgkgIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKCSAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KCSAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KCSAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgoJICAgIC8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CgkgICAgLy8KCSAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CgkgICAgLy8gICAgICAgLi4uCgkgICAgLy8gICAgIH0pOwoJICAgIC8vCgkgICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewoJICAgICAgaWYgKCFfLmlzUmVnRXhwKHJvdXRlKSkgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsKCSAgICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKCSAgICAgICAgY2FsbGJhY2sgPSBuYW1lOwoJICAgICAgICBuYW1lID0gJyc7CgkgICAgICB9CgkgICAgICBpZiAoIWNhbGxiYWNrKSBjYWxsYmFjayA9IHRoaXNbbmFtZV07CgkgICAgICB2YXIgcm91dGVyID0gdGhpczsKCSAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIGZ1bmN0aW9uKGZyYWdtZW50KSB7CgkgICAgICAgIHZhciBhcmdzID0gcm91dGVyLl9leHRyYWN0UGFyYW1ldGVycyhyb3V0ZSwgZnJhZ21lbnQpOwoJICAgICAgICByb3V0ZXIuZXhlY3V0ZShjYWxsYmFjaywgYXJncyk7CgkgICAgICAgIHJvdXRlci50cmlnZ2VyLmFwcGx5KHJvdXRlciwgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKCSAgICAgICAgcm91dGVyLnRyaWdnZXIoJ3JvdXRlJywgbmFtZSwgYXJncyk7CgkgICAgICAgIEJhY2tib25lLmhpc3RvcnkudHJpZ2dlcigncm91dGUnLCByb3V0ZXIsIG5hbWUsIGFyZ3MpOwoJICAgICAgfSk7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBFeGVjdXRlIGEgcm91dGUgaGFuZGxlciB3aXRoIHRoZSBwcm92aWRlZCBwYXJhbWV0ZXJzLiAgVGhpcyBpcyBhbgoJICAgIC8vIGV4Y2VsbGVudCBwbGFjZSB0byBkbyBwcmUtcm91dGUgc2V0dXAgb3IgcG9zdC1yb3V0ZSBjbGVhbnVwLgoJICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKGNhbGxiYWNrLCBhcmdzKSB7CgkgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwoJICAgIH0sCgoJICAgIC8vIFNpbXBsZSBwcm94eSB0byBgQmFja2JvbmUuaGlzdG9yeWAgdG8gc2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhpc3RvcnkuCgkgICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CgkgICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIEJpbmQgYWxsIGRlZmluZWQgcm91dGVzIHRvIGBCYWNrYm9uZS5oaXN0b3J5YC4gV2UgaGF2ZSB0byByZXZlcnNlIHRoZQoJICAgIC8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwKCSAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgoJICAgIF9iaW5kUm91dGVzOiBmdW5jdGlvbigpIHsKCSAgICAgIGlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsKCSAgICAgIHRoaXMucm91dGVzID0gXy5yZXN1bHQodGhpcywgJ3JvdXRlcycpOwoJICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwoJICAgICAgd2hpbGUgKChyb3V0ZSA9IHJvdXRlcy5wb3AoKSkgIT0gbnVsbCkgewoJICAgICAgICB0aGlzLnJvdXRlKHJvdXRlLCB0aGlzLnJvdXRlc1tyb3V0ZV0pOwoJICAgICAgfQoJICAgIH0sCgoJICAgIC8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nCgkgICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgoJICAgIF9yb3V0ZVRvUmVnRXhwOiBmdW5jdGlvbihyb3V0ZSkgewoJICAgICAgcm91dGUgPSByb3V0ZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKQoJICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKCSAgICAgICAgICAgICAgICAgICAucmVwbGFjZShuYW1lZFBhcmFtLCBmdW5jdGlvbihtYXRjaCwgb3B0aW9uYWwpIHsKCSAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXi8/XSspJzsKCSAgICAgICAgICAgICAgICAgICB9KQoJICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKHNwbGF0UGFyYW0sICcoW14/XSo/KScpOwoJICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnKD86XFw/KFtcXHNcXFNdKikpPyQnKTsKCSAgICB9LAoKCSAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCgkgICAgLy8gZXh0cmFjdGVkIGRlY29kZWQgcGFyYW1ldGVycy4gRW1wdHkgb3IgdW5tYXRjaGVkIHBhcmFtZXRlcnMgd2lsbCBiZQoJICAgIC8vIHRyZWF0ZWQgYXMgYG51bGxgIHRvIG5vcm1hbGl6ZSBjcm9zcy1icm93c2VyIGJlaGF2aW9yLgoJICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24ocm91dGUsIGZyYWdtZW50KSB7CgkgICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CgkgICAgICByZXR1cm4gXy5tYXAocGFyYW1zLCBmdW5jdGlvbihwYXJhbSwgaSkgewoJICAgICAgICAvLyBEb24ndCBkZWNvZGUgdGhlIHNlYXJjaCBwYXJhbXMuCgkgICAgICAgIGlmIChpID09PSBwYXJhbXMubGVuZ3RoIC0gMSkgcmV0dXJuIHBhcmFtIHx8IG51bGw7CgkgICAgICAgIHJldHVybiBwYXJhbSA/IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbSkgOiBudWxsOwoJICAgICAgfSk7CgkgICAgfQoKCSAgfSk7CgoJICAvLyBCYWNrYm9uZS5IaXN0b3J5CgkgIC8vIC0tLS0tLS0tLS0tLS0tLS0KCgkgIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIGVpdGhlcgoJICAvLyBbcHVzaFN0YXRlXShodHRwOi8vZGl2ZWludG9odG1sNS5pbmZvL2hpc3RvcnkuaHRtbCkgYW5kIHJlYWwgVVJMcywgb3IKCSAgLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKCSAgLy8gYW5kIFVSTCBmcmFnbWVudHMuIElmIHRoZSBicm93c2VyIHN1cHBvcnRzIG5laXRoZXIgKG9sZCBJRSwgbmF0Y2gpLAoJICAvLyBmYWxscyBiYWNrIHRvIHBvbGxpbmcuCgkgIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewoJICAgIHRoaXMuaGFuZGxlcnMgPSBbXTsKCSAgICBfLmJpbmRBbGwodGhpcywgJ2NoZWNrVXJsJyk7CgoJICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgoJICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewoJICAgICAgdGhpcy5sb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKCSAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwoJICAgIH0KCSAgfTsKCgkgIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KCSAgdmFyIHJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dfFxzKyQvZzsKCgkgIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoZXMuCgkgIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgoJICAvLyBDYWNoZWQgcmVnZXggZm9yIGRldGVjdGluZyBNU0lFLgoJICB2YXIgaXNFeHBsb3JlciA9IC9tc2llIFtcdy5dKy87CgoJICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCgkgIHZhciB0cmFpbGluZ1NsYXNoID0gL1wvJC87CgoJICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyB1cmxzIG9mIGhhc2guCgkgIHZhciBwYXRoU3RyaXBwZXIgPSAvIy4qJC87CgoJICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CgkgIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoKCSAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgoJICBfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CgoJICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwoJICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4KCSAgICBpbnRlcnZhbDogNTAsCgoJICAgIC8vIEFyZSB3ZSBhdCB0aGUgYXBwIHJvb3Q/CgkgICAgYXRSb290OiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dJC8sICckJi8nKSA9PT0gdGhpcy5yb290OwoJICAgIH0sCgoJICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKCSAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KCSAgICBnZXRIYXNoOiBmdW5jdGlvbih3aW5kb3cpIHsKCSAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CgkgICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwoJICAgIH0sCgoJICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKCSAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgoJICAgIGdldEZyYWdtZW50OiBmdW5jdGlvbihmcmFnbWVudCwgZm9yY2VQdXNoU3RhdGUpIHsKCSAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CgkgICAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgfHwgIXRoaXMuX3dhbnRzSGFzaENoYW5nZSB8fCBmb3JjZVB1c2hTdGF0ZSkgewoJICAgICAgICAgIGZyYWdtZW50ID0gZGVjb2RlVVJJKHRoaXMubG9jYXRpb24ucGF0aG5hbWUgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCk7CgkgICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CgkgICAgICAgICAgaWYgKCFmcmFnbWVudC5pbmRleE9mKHJvb3QpKSBmcmFnbWVudCA9IGZyYWdtZW50LnNsaWNlKHJvb3QubGVuZ3RoKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CgkgICAgfSwKCgkgICAgLy8gU3RhcnQgdGhlIGhhc2ggY2hhbmdlIGhhbmRsaW5nLCByZXR1cm5pbmcgYHRydWVgIGlmIHRoZSBjdXJyZW50IFVSTCBtYXRjaGVzCgkgICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KCSAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgaWYgKEhpc3Rvcnkuc3RhcnRlZCkgdGhyb3cgbmV3IEVycm9yKCJCYWNrYm9uZS5oaXN0b3J5IGhhcyBhbHJlYWR5IGJlZW4gc3RhcnRlZCIpOwoJICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCgkgICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwoJICAgICAgLy8gSXMgcHVzaFN0YXRlIGRlc2lyZWQgLi4uIGlzIGl0IGF2YWlsYWJsZT8KCSAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHtyb290OiAnLyd9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwoJICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CgkgICAgICB0aGlzLl93YW50c0hhc2hDaGFuZ2UgPSB0aGlzLm9wdGlvbnMuaGFzaENoYW5nZSAhPT0gZmFsc2U7CgkgICAgICB0aGlzLl93YW50c1B1c2hTdGF0ZSAgPSAhIXRoaXMub3B0aW9ucy5wdXNoU3RhdGU7CgkgICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKCSAgICAgIHZhciBmcmFnbWVudCAgICAgICAgICA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKCSAgICAgIHZhciBkb2NNb2RlICAgICAgICAgICA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKCSAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgoJICAgICAgLy8gTm9ybWFsaXplIHJvb3QgdG8gYWx3YXlzIGluY2x1ZGUgYSBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaC4KCSAgICAgIHRoaXMucm9vdCA9ICgnLycgKyB0aGlzLnJvb3QgKyAnLycpLnJlcGxhY2Uocm9vdFN0cmlwcGVyLCAnLycpOwoKCSAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKCSAgICAgICAgdmFyIGZyYW1lID0gQmFja2JvbmUuJCgnPGlmcmFtZSBzcmM9ImphdmFzY3JpcHQ6MCIgdGFiaW5kZXg9Ii0xIj4nKTsKCSAgICAgICAgdGhpcy5pZnJhbWUgPSBmcmFtZS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwoJICAgICAgICB0aGlzLm5hdmlnYXRlKGZyYWdtZW50KTsKCSAgICAgIH0KCgkgICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgoJICAgICAgLy8gJ29uaGFzaGNoYW5nZScgaXMgc3VwcG9ydGVkLCBkZXRlcm1pbmUgaG93IHdlIGNoZWNrIHRoZSBVUkwgc3RhdGUuCgkgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CgkgICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKCSAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmICgnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3cpICYmICFvbGRJRSkgewoJICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKCSAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CgkgICAgICAgIHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLmNoZWNrVXJsLCB0aGlzLmludGVydmFsKTsKCSAgICAgIH0KCgkgICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawoJICAgICAgLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgoJICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwoJICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CgoJICAgICAgLy8gVHJhbnNpdGlvbiBmcm9tIGhhc2hDaGFuZ2UgdG8gcHVzaFN0YXRlIG9yIHZpY2UgdmVyc2EgaWYgYm90aCBhcmUKCSAgICAgIC8vIHJlcXVlc3RlZC4KCSAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKCgkgICAgICAgIC8vIElmIHdlJ3ZlIHN0YXJ0ZWQgb2ZmIHdpdGggYSByb3V0ZSBmcm9tIGEgYHB1c2hTdGF0ZWAtZW5hYmxlZAoJICAgICAgICAvLyBicm93c2VyLCBidXQgd2UncmUgY3VycmVudGx5IGluIGEgYnJvd3NlciB0aGF0IGRvZXNuJ3Qgc3VwcG9ydCBpdC4uLgoJICAgICAgICBpZiAoIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhdGhpcy5hdFJvb3QoKSkgewoJICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KG51bGwsIHRydWUpOwoJICAgICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSh0aGlzLnJvb3QgKyAnIycgKyB0aGlzLmZyYWdtZW50KTsKCSAgICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKCSAgICAgICAgICByZXR1cm4gdHJ1ZTsKCgkgICAgICAgIC8vIE9yIGlmIHdlJ3ZlIHN0YXJ0ZWQgb3V0IHdpdGggYSBoYXNoLWJhc2VkIHJvdXRlLCBidXQgd2UncmUgY3VycmVudGx5CgkgICAgICAgIC8vIGluIGEgYnJvd3NlciB3aGVyZSBpdCBjb3VsZCBiZSBgcHVzaFN0YXRlYC1iYXNlZCBpbnN0ZWFkLi4uCgkgICAgICAgIH0gZWxzZSBpZiAodGhpcy5faGFzUHVzaFN0YXRlICYmIHRoaXMuYXRSb290KCkgJiYgbG9jLmhhc2gpIHsKCSAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CgkgICAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQpOwoJICAgICAgICB9CgoJICAgICAgfQoKCSAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOwoJICAgIH0sCgoJICAgIC8vIERpc2FibGUgQmFja2JvbmUuaGlzdG9yeSwgcGVyaGFwcyB0ZW1wb3JhcmlseS4gTm90IHVzZWZ1bCBpbiBhIHJlYWwgYXBwLAoJICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgoJICAgIHN0b3A6IGZ1bmN0aW9uKCkgewoJICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9mZigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKS5vZmYoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKCSAgICAgIGlmICh0aGlzLl9jaGVja1VybEludGVydmFsKSBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwoJICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgkgICAgfSwKCgkgICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgoJICAgIC8vIG1heSBvdmVycmlkZSBwcmV2aW91cyByb3V0ZXMuCgkgICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBjYWxsYmFjaykgewoJICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwoJICAgIH0sCgoJICAgIC8vIENoZWNrcyB0aGUgY3VycmVudCBVUkwgdG8gc2VlIGlmIGl0IGhhcyBjaGFuZ2VkLCBhbmQgaWYgaXQgaGFzLAoJICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgoJICAgIGNoZWNrVXJsOiBmdW5jdGlvbihlKSB7CgkgICAgICB2YXIgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKCSAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CgkgICAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwoJICAgICAgfQoJICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKCSAgICAgIGlmICh0aGlzLmlmcmFtZSkgdGhpcy5uYXZpZ2F0ZShjdXJyZW50KTsKCSAgICAgIHRoaXMubG9hZFVybCgpOwoJICAgIH0sCgoJICAgIC8vIEF0dGVtcHQgdG8gbG9hZCB0aGUgY3VycmVudCBVUkwgZnJhZ21lbnQuIElmIGEgcm91dGUgc3VjY2VlZHMgd2l0aCBhCgkgICAgLy8gbWF0Y2gsIHJldHVybnMgYHRydWVgLiBJZiBubyBkZWZpbmVkIHJvdXRlcyBtYXRjaGVzIHRoZSBmcmFnbWVudCwKCSAgICAvLyByZXR1cm5zIGBmYWxzZWAuCgkgICAgbG9hZFVybDogZnVuY3Rpb24oZnJhZ21lbnQpIHsKCSAgICAgIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQpOwoJICAgICAgcmV0dXJuIF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uKGhhbmRsZXIpIHsKCSAgICAgICAgaWYgKGhhbmRsZXIucm91dGUudGVzdChmcmFnbWVudCkpIHsKCSAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKCSAgICAgICAgICByZXR1cm4gdHJ1ZTsKCSAgICAgICAgfQoJICAgICAgfSk7CgkgICAgfSwKCgkgICAgLy8gU2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhhc2ggaGlzdG9yeSwgb3IgcmVwbGFjZSB0aGUgVVJMIHN0YXRlIGlmIHRoZQoJICAgIC8vICdyZXBsYWNlJyBvcHRpb24gaXMgcGFzc2VkLiBZb3UgYXJlIHJlc3BvbnNpYmxlIGZvciBwcm9wZXJseSBVUkwtZW5jb2RpbmcKCSAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KCSAgICAvLwoJICAgIC8vIFRoZSBvcHRpb25zIG9iamVjdCBjYW4gY29udGFpbiBgdHJpZ2dlcjogdHJ1ZWAgaWYgeW91IHdpc2ggdG8gaGF2ZSB0aGUKCSAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgoJICAgIC8vIHlvdSB3aXNoIHRvIG1vZGlmeSB0aGUgY3VycmVudCBVUkwgd2l0aG91dCBhZGRpbmcgYW4gZW50cnkgdG8gdGhlIGhpc3RvcnkuCgkgICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CgkgICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwoJICAgICAgaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpIG9wdGlvbnMgPSB7dHJpZ2dlcjogISFvcHRpb25zfTsKCgkgICAgICB2YXIgdXJsID0gdGhpcy5yb290ICsgKGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJykpOwoKCSAgICAgIC8vIFN0cmlwIHRoZSBoYXNoIGZvciBtYXRjaGluZy4KCSAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZShwYXRoU3RyaXBwZXIsICcnKTsKCgkgICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpIHJldHVybjsKCSAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKCgkgICAgICAvLyBEb24ndCBpbmNsdWRlIGEgdHJhaWxpbmcgc2xhc2ggb24gdGhlIHJvb3QuCgkgICAgICBpZiAoZnJhZ21lbnQgPT09ICcnICYmIHVybCAhPT0gJy8nKSB1cmwgPSB1cmwuc2xpY2UoMCwgLTEpOwoKCSAgICAgIC8vIElmIHB1c2hTdGF0ZSBpcyBhdmFpbGFibGUsIHdlIHVzZSBpdCB0byBzZXQgdGhlIGZyYWdtZW50IGFzIGEgcmVhbCBVUkwuCgkgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CgkgICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CgoJICAgICAgLy8gSWYgaGFzaCBjaGFuZ2VzIGhhdmVuJ3QgYmVlbiBleHBsaWNpdGx5IGRpc2FibGVkLCB1cGRhdGUgdGhlIGhhc2gKCSAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCgkgICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewoJICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwoJICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgKGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSkgewoJICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQoJICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CgkgICAgICAgICAgLy8gd2FudCB0aGlzLgoJICAgICAgICAgIGlmKCFvcHRpb25zLnJlcGxhY2UpIHRoaXMuaWZyYW1lLmRvY3VtZW50Lm9wZW4oKS5jbG9zZSgpOwoJICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwoJICAgICAgICB9CgoJICAgICAgLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtCgkgICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwoJICAgICAgfQoJICAgICAgaWYgKG9wdGlvbnMudHJpZ2dlcikgcmV0dXJuIHRoaXMubG9hZFVybChmcmFnbWVudCk7CgkgICAgfSwKCgkgICAgLy8gVXBkYXRlIHRoZSBoYXNoIGxvY2F0aW9uLCBlaXRoZXIgcmVwbGFjaW5nIHRoZSBjdXJyZW50IGVudHJ5LCBvciBhZGRpbmcKCSAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KCSAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CgkgICAgICBpZiAocmVwbGFjZSkgewoJICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwoJICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCgkgICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKCSAgICAgIH0KCSAgICB9CgoJICB9KTsKCgkgIC8vIENyZWF0ZSB0aGUgZGVmYXVsdCBCYWNrYm9uZS5oaXN0b3J5LgoJICBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7CgoJICAvLyBIZWxwZXJzCgkgIC8vIC0tLS0tLS0KCgkgIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgoJICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAoJICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgoJICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKCSAgICB2YXIgcGFyZW50ID0gdGhpczsKCSAgICB2YXIgY2hpbGQ7CgoJICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKCSAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCgkgICAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgoJICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CgkgICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CgkgICAgfSBlbHNlIHsKCSAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwoJICAgIH0KCgkgICAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCgkgICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKCSAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwoJICAgIC8vIGBwYXJlbnRgJ3MgY29uc3RydWN0b3IgZnVuY3Rpb24uCgkgICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKCSAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKCSAgICBjaGlsZC5wcm90b3R5cGUgPSBuZXcgU3Vycm9nYXRlOwoKCSAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKCSAgICAvLyBpZiBzdXBwbGllZC4KCSAgICBpZiAocHJvdG9Qcm9wcykgXy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKCgkgICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAoJICAgIC8vIGxhdGVyLgoJICAgIGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7CgoJICAgIHJldHVybiBjaGlsZDsKCSAgfTsKCgkgIC8vIFNldCB1cCBpbmhlcml0YW5jZSBmb3IgdGhlIG1vZGVsLCBjb2xsZWN0aW9uLCByb3V0ZXIsIHZpZXcgYW5kIGhpc3RvcnkuCgkgIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgoJICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCgkgIHZhciB1cmxFcnJvciA9IGZ1bmN0aW9uKCkgewoJICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwoJICB9OwoKCSAgLy8gV3JhcCBhbiBvcHRpb25hbCBlcnJvciBjYWxsYmFjayB3aXRoIGEgZmFsbGJhY2sgZXJyb3IgZXZlbnQuCgkgIHZhciB3cmFwRXJyb3IgPSBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewoJICAgIHZhciBlcnJvciA9IG9wdGlvbnMuZXJyb3I7CgkgICAgb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uKHJlc3ApIHsKCSAgICAgIGlmIChlcnJvcikgZXJyb3IobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkgICAgfTsKCSAgfTsKCgkgIHJldHVybiBCYWNrYm9uZTsKCgl9KSk7CgoKLyoqKi8gfSwKLyogMzEgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJdmFyIF9fV0VCUEFDS19BTURfREVGSU5FX0FSUkFZX18sIF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fOy8vICAgICBVbmRlcnNjb3JlLmpzIDEuNy4wCgkvLyAgICAgaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcKCS8vICAgICAoYykgMjAwOS0yMDE0IEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCgkvLyAgICAgVW5kZXJzY29yZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCgkoZnVuY3Rpb24oKSB7CgoJICAvLyBCYXNlbGluZSBzZXR1cAoJICAvLyAtLS0tLS0tLS0tLS0tLQoKCSAgLy8gRXN0YWJsaXNoIHRoZSByb290IG9iamVjdCwgYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIG9yIGBleHBvcnRzYCBvbiB0aGUgc2VydmVyLgoJICB2YXIgcm9vdCA9IHRoaXM7CgoJICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYF9gIHZhcmlhYmxlLgoJICB2YXIgcHJldmlvdXNVbmRlcnNjb3JlID0gcm9vdC5fOwoKCSAgLy8gU2F2ZSBieXRlcyBpbiB0aGUgbWluaWZpZWQgKGJ1dCBub3QgZ3ppcHBlZCkgdmVyc2lvbjoKCSAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwoKCSAgLy8gQ3JlYXRlIHF1aWNrIHJlZmVyZW5jZSB2YXJpYWJsZXMgZm9yIHNwZWVkIGFjY2VzcyB0byBjb3JlIHByb3RvdHlwZXMuCgkgIHZhcgoJICAgIHB1c2ggICAgICAgICAgICAgPSBBcnJheVByb3RvLnB1c2gsCgkgICAgc2xpY2UgICAgICAgICAgICA9IEFycmF5UHJvdG8uc2xpY2UsCgkgICAgY29uY2F0ICAgICAgICAgICA9IEFycmF5UHJvdG8uY29uY2F0LAoJICAgIHRvU3RyaW5nICAgICAgICAgPSBPYmpQcm90by50b1N0cmluZywKCSAgICBoYXNPd25Qcm9wZXJ0eSAgID0gT2JqUHJvdG8uaGFzT3duUHJvcGVydHk7CgoJICAvLyBBbGwgKipFQ01BU2NyaXB0IDUqKiBuYXRpdmUgZnVuY3Rpb24gaW1wbGVtZW50YXRpb25zIHRoYXQgd2UgaG9wZSB0byB1c2UKCSAgLy8gYXJlIGRlY2xhcmVkIGhlcmUuCgkgIHZhcgoJICAgIG5hdGl2ZUlzQXJyYXkgICAgICA9IEFycmF5LmlzQXJyYXksCgkgICAgbmF0aXZlS2V5cyAgICAgICAgID0gT2JqZWN0LmtleXMsCgkgICAgbmF0aXZlQmluZCAgICAgICAgID0gRnVuY1Byb3RvLmJpbmQ7CgoJICAvLyBDcmVhdGUgYSBzYWZlIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yIHVzZSBiZWxvdy4KCSAgdmFyIF8gPSBmdW5jdGlvbihvYmopIHsKCSAgICBpZiAob2JqIGluc3RhbmNlb2YgXykgcmV0dXJuIG9iajsKCSAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgXykpIHJldHVybiBuZXcgXyhvYmopOwoJICAgIHRoaXMuX3dyYXBwZWQgPSBvYmo7CgkgIH07CgoJICAvLyBFeHBvcnQgdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciAqKk5vZGUuanMqKiwgd2l0aAoJICAvLyBiYWNrd2FyZHMtY29tcGF0aWJpbGl0eSBmb3IgdGhlIG9sZCBgcmVxdWlyZSgpYCBBUEkuIElmIHdlJ3JlIGluCgkgIC8vIHRoZSBicm93c2VyLCBhZGQgYF9gIGFzIGEgZ2xvYmFsIG9iamVjdC4KCSAgaWYgKHRydWUpIHsKCSAgICBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpIHsKCSAgICAgIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IF87CgkgICAgfQoJICAgIGV4cG9ydHMuXyA9IF87CgkgIH0gZWxzZSB7CgkgICAgcm9vdC5fID0gXzsKCSAgfQoKCSAgLy8gQ3VycmVudCB2ZXJzaW9uLgoJICBfLlZFUlNJT04gPSAnMS43LjAnOwoKCSAgLy8gSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGFuIGVmZmljaWVudCAoZm9yIGN1cnJlbnQgZW5naW5lcykgdmVyc2lvbgoJICAvLyBvZiB0aGUgcGFzc2VkLWluIGNhbGxiYWNrLCB0byBiZSByZXBlYXRlZGx5IGFwcGxpZWQgaW4gb3RoZXIgVW5kZXJzY29yZQoJICAvLyBmdW5jdGlvbnMuCgkgIHZhciBjcmVhdGVDYWxsYmFjayA9IGZ1bmN0aW9uKGZ1bmMsIGNvbnRleHQsIGFyZ0NvdW50KSB7CgkgICAgaWYgKGNvbnRleHQgPT09IHZvaWQgMCkgcmV0dXJuIGZ1bmM7CgkgICAgc3dpdGNoIChhcmdDb3VudCA9PSBudWxsID8gMyA6IGFyZ0NvdW50KSB7CgkgICAgICBjYXNlIDE6IHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIHZhbHVlKTsKCSAgICAgIH07CgkgICAgICBjYXNlIDI6IHJldHVybiBmdW5jdGlvbih2YWx1ZSwgb3RoZXIpIHsKCSAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0LCB2YWx1ZSwgb3RoZXIpOwoJICAgICAgfTsKCSAgICAgIGNhc2UgMzogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewoJICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CgkgICAgICB9OwoJICAgICAgY2FzZSA0OiByZXR1cm4gZnVuY3Rpb24oYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewoJICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pOwoJICAgICAgfTsKCSAgICB9CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJndW1lbnRzKTsKCSAgICB9OwoJICB9OwoKCSAgLy8gQSBtb3N0bHktaW50ZXJuYWwgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgY2FsbGJhY2tzIHRoYXQgY2FuIGJlIGFwcGxpZWQKCSAgLy8gdG8gZWFjaCBlbGVtZW50IGluIGEgY29sbGVjdGlvbiwgcmV0dXJuaW5nIHRoZSBkZXNpcmVkIHJlc3VsdCDigJQgZWl0aGVyCgkgIC8vIGlkZW50aXR5LCBhbiBhcmJpdHJhcnkgY2FsbGJhY2ssIGEgcHJvcGVydHkgbWF0Y2hlciwgb3IgYSBwcm9wZXJ0eSBhY2Nlc3Nvci4KCSAgXy5pdGVyYXRlZSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0LCBhcmdDb3VudCkgewoJICAgIGlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gXy5pZGVudGl0eTsKCSAgICBpZiAoXy5pc0Z1bmN0aW9uKHZhbHVlKSkgcmV0dXJuIGNyZWF0ZUNhbGxiYWNrKHZhbHVlLCBjb250ZXh0LCBhcmdDb3VudCk7CgkgICAgaWYgKF8uaXNPYmplY3QodmFsdWUpKSByZXR1cm4gXy5tYXRjaGVzKHZhbHVlKTsKCSAgICByZXR1cm4gXy5wcm9wZXJ0eSh2YWx1ZSk7CgkgIH07CgoJICAvLyBDb2xsZWN0aW9uIEZ1bmN0aW9ucwoJICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLQoKCSAgLy8gVGhlIGNvcm5lcnN0b25lLCBhbiBgZWFjaGAgaW1wbGVtZW50YXRpb24sIGFrYSBgZm9yRWFjaGAuCgkgIC8vIEhhbmRsZXMgcmF3IG9iamVjdHMgaW4gYWRkaXRpb24gdG8gYXJyYXktbGlrZXMuIFRyZWF0cyBhbGwKCSAgLy8gc3BhcnNlIGFycmF5LWxpa2VzIGFzIGlmIHRoZXkgd2VyZSBkZW5zZS4KCSAgXy5lYWNoID0gXy5mb3JFYWNoID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIG9iajsKCSAgICBpdGVyYXRlZSA9IGNyZWF0ZUNhbGxiYWNrKGl0ZXJhdGVlLCBjb250ZXh0KTsKCSAgICB2YXIgaSwgbGVuZ3RoID0gb2JqLmxlbmd0aDsKCSAgICBpZiAobGVuZ3RoID09PSArbGVuZ3RoKSB7CgkgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgICAgaXRlcmF0ZWUob2JqW2ldLCBpLCBvYmopOwoJICAgICAgfQoJICAgIH0gZWxzZSB7CgkgICAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwoJICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0ga2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICBpdGVyYXRlZShvYmpba2V5c1tpXV0sIGtleXNbaV0sIG9iaik7CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiBvYmo7CgkgIH07CgoJICAvLyBSZXR1cm4gdGhlIHJlc3VsdHMgb2YgYXBwbHlpbmcgdGhlIGl0ZXJhdGVlIHRvIGVhY2ggZWxlbWVudC4KCSAgXy5tYXAgPSBfLmNvbGxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gW107CgkgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKCSAgICB2YXIga2V5cyA9IG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAoJICAgICAgICBsZW5ndGggPSAoa2V5cyB8fCBvYmopLmxlbmd0aCwKCSAgICAgICAgcmVzdWx0cyA9IEFycmF5KGxlbmd0aCksCgkgICAgICAgIGN1cnJlbnRLZXk7CgkgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewoJICAgICAgY3VycmVudEtleSA9IGtleXMgPyBrZXlzW2luZGV4XSA6IGluZGV4OwoJICAgICAgcmVzdWx0c1tpbmRleF0gPSBpdGVyYXRlZShvYmpbY3VycmVudEtleV0sIGN1cnJlbnRLZXksIG9iaik7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHRzOwoJICB9OwoKCSAgdmFyIHJlZHVjZUVycm9yID0gJ1JlZHVjZSBvZiBlbXB0eSBhcnJheSB3aXRoIG5vIGluaXRpYWwgdmFsdWUnOwoKCSAgLy8gKipSZWR1Y2UqKiBidWlsZHMgdXAgYSBzaW5nbGUgcmVzdWx0IGZyb20gYSBsaXN0IG9mIHZhbHVlcywgYWthIGBpbmplY3RgLAoJICAvLyBvciBgZm9sZGxgLgoJICBfLnJlZHVjZSA9IF8uZm9sZGwgPSBfLmluamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIG1lbW8sIGNvbnRleHQpIHsKCSAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwoJICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQsIDQpOwoJICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGggJiYgXy5rZXlzKG9iaiksCgkgICAgICAgIGxlbmd0aCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAoJICAgICAgICBpbmRleCA9IDAsIGN1cnJlbnRLZXk7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAzKSB7CgkgICAgICBpZiAoIWxlbmd0aCkgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CgkgICAgICBtZW1vID0gb2JqW2tleXMgPyBrZXlzW2luZGV4KytdIDogaW5kZXgrK107CgkgICAgfQoJICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewoJICAgICAgY3VycmVudEtleSA9IGtleXMgPyBrZXlzW2luZGV4XSA6IGluZGV4OwoJICAgICAgbWVtbyA9IGl0ZXJhdGVlKG1lbW8sIG9ialtjdXJyZW50S2V5XSwgY3VycmVudEtleSwgb2JqKTsKCSAgICB9CgkgICAgcmV0dXJuIG1lbW87CgkgIH07CgoJICAvLyBUaGUgcmlnaHQtYXNzb2NpYXRpdmUgdmVyc2lvbiBvZiByZWR1Y2UsIGFsc28ga25vd24gYXMgYGZvbGRyYC4KCSAgXy5yZWR1Y2VSaWdodCA9IF8uZm9sZHIgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBtZW1vLCBjb250ZXh0KSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSBvYmogPSBbXTsKCSAgICBpdGVyYXRlZSA9IGNyZWF0ZUNhbGxiYWNrKGl0ZXJhdGVlLCBjb250ZXh0LCA0KTsKCSAgICB2YXIga2V5cyA9IG9iai5sZW5ndGggIT09ICsgb2JqLmxlbmd0aCAmJiBfLmtleXMob2JqKSwKCSAgICAgICAgaW5kZXggPSAoa2V5cyB8fCBvYmopLmxlbmd0aCwKCSAgICAgICAgY3VycmVudEtleTsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDMpIHsKCSAgICAgIGlmICghaW5kZXgpIHRocm93IG5ldyBUeXBlRXJyb3IocmVkdWNlRXJyb3IpOwoJICAgICAgbWVtbyA9IG9ialtrZXlzID8ga2V5c1stLWluZGV4XSA6IC0taW5kZXhdOwoJICAgIH0KCSAgICB3aGlsZSAoaW5kZXgtLSkgewoJICAgICAgY3VycmVudEtleSA9IGtleXMgPyBrZXlzW2luZGV4XSA6IGluZGV4OwoJICAgICAgbWVtbyA9IGl0ZXJhdGVlKG1lbW8sIG9ialtjdXJyZW50S2V5XSwgY3VycmVudEtleSwgb2JqKTsKCSAgICB9CgkgICAgcmV0dXJuIG1lbW87CgkgIH07CgoJICAvLyBSZXR1cm4gdGhlIGZpcnN0IHZhbHVlIHdoaWNoIHBhc3NlcyBhIHRydXRoIHRlc3QuIEFsaWFzZWQgYXMgYGRldGVjdGAuCgkgIF8uZmluZCA9IF8uZGV0ZWN0ID0gZnVuY3Rpb24ob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKCSAgICB2YXIgcmVzdWx0OwoJICAgIHByZWRpY2F0ZSA9IF8uaXRlcmF0ZWUocHJlZGljYXRlLCBjb250ZXh0KTsKCSAgICBfLnNvbWUob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKCSAgICAgIGlmIChwcmVkaWNhdGUodmFsdWUsIGluZGV4LCBsaXN0KSkgewoJICAgICAgICByZXN1bHQgPSB2YWx1ZTsKCSAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgICB9CgkgICAgfSk7CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIHRoYXQgcGFzcyBhIHRydXRoIHRlc3QuCgkgIC8vIEFsaWFzZWQgYXMgYHNlbGVjdGAuCgkgIF8uZmlsdGVyID0gXy5zZWxlY3QgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewoJICAgIHZhciByZXN1bHRzID0gW107CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKCSAgICBwcmVkaWNhdGUgPSBfLml0ZXJhdGVlKHByZWRpY2F0ZSwgY29udGV4dCk7CgkgICAgXy5lYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CgkgICAgICBpZiAocHJlZGljYXRlKHZhbHVlLCBpbmRleCwgbGlzdCkpIHJlc3VsdHMucHVzaCh2YWx1ZSk7CgkgICAgfSk7CgkgICAgcmV0dXJuIHJlc3VsdHM7CgkgIH07CgoJICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyBmb3Igd2hpY2ggYSB0cnV0aCB0ZXN0IGZhaWxzLgoJICBfLnJlamVjdCA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CgkgICAgcmV0dXJuIF8uZmlsdGVyKG9iaiwgXy5uZWdhdGUoXy5pdGVyYXRlZShwcmVkaWNhdGUpKSwgY29udGV4dCk7CgkgIH07CgoJICAvLyBEZXRlcm1pbmUgd2hldGhlciBhbGwgb2YgdGhlIGVsZW1lbnRzIG1hdGNoIGEgdHJ1dGggdGVzdC4KCSAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KCSAgXy5ldmVyeSA9IF8uYWxsID0gZnVuY3Rpb24ob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKCSAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB0cnVlOwoJICAgIHByZWRpY2F0ZSA9IF8uaXRlcmF0ZWUocHJlZGljYXRlLCBjb250ZXh0KTsKCSAgICB2YXIga2V5cyA9IG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAoJICAgICAgICBsZW5ndGggPSAoa2V5cyB8fCBvYmopLmxlbmd0aCwKCSAgICAgICAgaW5kZXgsIGN1cnJlbnRLZXk7CgkgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CgkgICAgICBjdXJyZW50S2V5ID0ga2V5cyA/IGtleXNbaW5kZXhdIDogaW5kZXg7CgkgICAgICBpZiAoIXByZWRpY2F0ZShvYmpbY3VycmVudEtleV0sIGN1cnJlbnRLZXksIG9iaikpIHJldHVybiBmYWxzZTsKCSAgICB9CgkgICAgcmV0dXJuIHRydWU7CgkgIH07CgoJICAvLyBEZXRlcm1pbmUgaWYgYXQgbGVhc3Qgb25lIGVsZW1lbnQgaW4gdGhlIG9iamVjdCBtYXRjaGVzIGEgdHJ1dGggdGVzdC4KCSAgLy8gQWxpYXNlZCBhcyBgYW55YC4KCSAgXy5zb21lID0gXy5hbnkgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwoJICAgIHByZWRpY2F0ZSA9IF8uaXRlcmF0ZWUocHJlZGljYXRlLCBjb250ZXh0KTsKCSAgICB2YXIga2V5cyA9IG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAoJICAgICAgICBsZW5ndGggPSAoa2V5cyB8fCBvYmopLmxlbmd0aCwKCSAgICAgICAgaW5kZXgsIGN1cnJlbnRLZXk7CgkgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CgkgICAgICBjdXJyZW50S2V5ID0ga2V5cyA/IGtleXNbaW5kZXhdIDogaW5kZXg7CgkgICAgICBpZiAocHJlZGljYXRlKG9ialtjdXJyZW50S2V5XSwgY3VycmVudEtleSwgb2JqKSkgcmV0dXJuIHRydWU7CgkgICAgfQoJICAgIHJldHVybiBmYWxzZTsKCSAgfTsKCgkgIC8vIERldGVybWluZSBpZiB0aGUgYXJyYXkgb3Igb2JqZWN0IGNvbnRhaW5zIGEgZ2l2ZW4gdmFsdWUgKHVzaW5nIGA9PT1gKS4KCSAgLy8gQWxpYXNlZCBhcyBgaW5jbHVkZWAuCgkgIF8uY29udGFpbnMgPSBfLmluY2x1ZGUgPSBmdW5jdGlvbihvYmosIHRhcmdldCkgewoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwoJICAgIGlmIChvYmoubGVuZ3RoICE9PSArb2JqLmxlbmd0aCkgb2JqID0gXy52YWx1ZXMob2JqKTsKCSAgICByZXR1cm4gXy5pbmRleE9mKG9iaiwgdGFyZ2V0KSA+PSAwOwoJICB9OwoKCSAgLy8gSW52b2tlIGEgbWV0aG9kICh3aXRoIGFyZ3VtZW50cykgb24gZXZlcnkgaXRlbSBpbiBhIGNvbGxlY3Rpb24uCgkgIF8uaW52b2tlID0gZnVuY3Rpb24ob2JqLCBtZXRob2QpIHsKCSAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKCSAgICB2YXIgaXNGdW5jID0gXy5pc0Z1bmN0aW9uKG1ldGhvZCk7CgkgICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKCSAgICAgIHJldHVybiAoaXNGdW5jID8gbWV0aG9kIDogdmFsdWVbbWV0aG9kXSkuYXBwbHkodmFsdWUsIGFyZ3MpOwoJICAgIH0pOwoJICB9OwoKCSAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgbWFwYDogZmV0Y2hpbmcgYSBwcm9wZXJ0eS4KCSAgXy5wbHVjayA9IGZ1bmN0aW9uKG9iaiwga2V5KSB7CgkgICAgcmV0dXJuIF8ubWFwKG9iaiwgXy5wcm9wZXJ0eShrZXkpKTsKCSAgfTsKCgkgIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbHRlcmA6IHNlbGVjdGluZyBvbmx5IG9iamVjdHMKCSAgLy8gY29udGFpbmluZyBzcGVjaWZpYyBga2V5OnZhbHVlYCBwYWlycy4KCSAgXy53aGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMpIHsKCSAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBfLm1hdGNoZXMoYXR0cnMpKTsKCSAgfTsKCgkgIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbmRgOiBnZXR0aW5nIHRoZSBmaXJzdCBvYmplY3QKCSAgLy8gY29udGFpbmluZyBzcGVjaWZpYyBga2V5OnZhbHVlYCBwYWlycy4KCSAgXy5maW5kV2hlcmUgPSBmdW5jdGlvbihvYmosIGF0dHJzKSB7CgkgICAgcmV0dXJuIF8uZmluZChvYmosIF8ubWF0Y2hlcyhhdHRycykpOwoJICB9OwoKCSAgLy8gUmV0dXJuIHRoZSBtYXhpbXVtIGVsZW1lbnQgKG9yIGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgoJICBfLm1heCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICB2YXIgcmVzdWx0ID0gLUluZmluaXR5LCBsYXN0Q29tcHV0ZWQgPSAtSW5maW5pdHksCgkgICAgICAgIHZhbHVlLCBjb21wdXRlZDsKCSAgICBpZiAoaXRlcmF0ZWUgPT0gbnVsbCAmJiBvYmogIT0gbnVsbCkgewoJICAgICAgb2JqID0gb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmogOiBfLnZhbHVlcyhvYmopOwoJICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IG9iai5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICB2YWx1ZSA9IG9ialtpXTsKCSAgICAgICAgaWYgKHZhbHVlID4gcmVzdWx0KSB7CgkgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKCSAgICAgIF8uZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewoJICAgICAgICBjb21wdXRlZCA9IGl0ZXJhdGVlKHZhbHVlLCBpbmRleCwgbGlzdCk7CgkgICAgICAgIGlmIChjb21wdXRlZCA+IGxhc3RDb21wdXRlZCB8fCBjb21wdXRlZCA9PT0gLUluZmluaXR5ICYmIHJlc3VsdCA9PT0gLUluZmluaXR5KSB7CgkgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CgkgICAgICAgICAgbGFzdENvbXB1dGVkID0gY29tcHV0ZWQ7CgkgICAgICAgIH0KCSAgICAgIH0pOwoJICAgIH0KCSAgICByZXR1cm4gcmVzdWx0OwoJICB9OwoKCSAgLy8gUmV0dXJuIHRoZSBtaW5pbXVtIGVsZW1lbnQgKG9yIGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgoJICBfLm1pbiA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICB2YXIgcmVzdWx0ID0gSW5maW5pdHksIGxhc3RDb21wdXRlZCA9IEluZmluaXR5LAoJICAgICAgICB2YWx1ZSwgY29tcHV0ZWQ7CgkgICAgaWYgKGl0ZXJhdGVlID09IG51bGwgJiYgb2JqICE9IG51bGwpIHsKCSAgICAgIG9iaiA9IG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoID8gb2JqIDogXy52YWx1ZXMob2JqKTsKCSAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBvYmoubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgICAgdmFsdWUgPSBvYmpbaV07CgkgICAgICAgIGlmICh2YWx1ZSA8IHJlc3VsdCkgewoJICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIGl0ZXJhdGVlID0gXy5pdGVyYXRlZShpdGVyYXRlZSwgY29udGV4dCk7CgkgICAgICBfLmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKCSAgICAgICAgY29tcHV0ZWQgPSBpdGVyYXRlZSh2YWx1ZSwgaW5kZXgsIGxpc3QpOwoJICAgICAgICBpZiAoY29tcHV0ZWQgPCBsYXN0Q29tcHV0ZWQgfHwgY29tcHV0ZWQgPT09IEluZmluaXR5ICYmIHJlc3VsdCA9PT0gSW5maW5pdHkpIHsKCSAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKCSAgICAgICAgICBsYXN0Q29tcHV0ZWQgPSBjb21wdXRlZDsKCSAgICAgICAgfQoJICAgICAgfSk7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH07CgoJICAvLyBTaHVmZmxlIGEgY29sbGVjdGlvbiwgdXNpbmcgdGhlIG1vZGVybiB2ZXJzaW9uIG9mIHRoZQoJICAvLyBbRmlzaGVyLVlhdGVzIHNodWZmbGVdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmlzaGVy4oCTWWF0ZXNfc2h1ZmZsZSkuCgkgIF8uc2h1ZmZsZSA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBzZXQgPSBvYmogJiYgb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmogOiBfLnZhbHVlcyhvYmopOwoJICAgIHZhciBsZW5ndGggPSBzZXQubGVuZ3RoOwoJICAgIHZhciBzaHVmZmxlZCA9IEFycmF5KGxlbmd0aCk7CgkgICAgZm9yICh2YXIgaW5kZXggPSAwLCByYW5kOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewoJICAgICAgcmFuZCA9IF8ucmFuZG9tKDAsIGluZGV4KTsKCSAgICAgIGlmIChyYW5kICE9PSBpbmRleCkgc2h1ZmZsZWRbaW5kZXhdID0gc2h1ZmZsZWRbcmFuZF07CgkgICAgICBzaHVmZmxlZFtyYW5kXSA9IHNldFtpbmRleF07CgkgICAgfQoJICAgIHJldHVybiBzaHVmZmxlZDsKCSAgfTsKCgkgIC8vIFNhbXBsZSAqKm4qKiByYW5kb20gdmFsdWVzIGZyb20gYSBjb2xsZWN0aW9uLgoJICAvLyBJZiAqKm4qKiBpcyBub3Qgc3BlY2lmaWVkLCByZXR1cm5zIGEgc2luZ2xlIHJhbmRvbSBlbGVtZW50LgoJICAvLyBUaGUgaW50ZXJuYWwgYGd1YXJkYCBhcmd1bWVudCBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBtYXBgLgoJICBfLnNhbXBsZSA9IGZ1bmN0aW9uKG9iaiwgbiwgZ3VhcmQpIHsKCSAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKSB7CgkgICAgICBpZiAob2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGgpIG9iaiA9IF8udmFsdWVzKG9iaik7CgkgICAgICByZXR1cm4gb2JqW18ucmFuZG9tKG9iai5sZW5ndGggLSAxKV07CgkgICAgfQoJICAgIHJldHVybiBfLnNodWZmbGUob2JqKS5zbGljZSgwLCBNYXRoLm1heCgwLCBuKSk7CgkgIH07CgoJICAvLyBTb3J0IHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24gcHJvZHVjZWQgYnkgYW4gaXRlcmF0ZWUuCgkgIF8uc29ydEJ5ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIGl0ZXJhdGVlID0gXy5pdGVyYXRlZShpdGVyYXRlZSwgY29udGV4dCk7CgkgICAgcmV0dXJuIF8ucGx1Y2soXy5tYXAob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKCSAgICAgIHJldHVybiB7CgkgICAgICAgIHZhbHVlOiB2YWx1ZSwKCSAgICAgICAgaW5kZXg6IGluZGV4LAoJICAgICAgICBjcml0ZXJpYTogaXRlcmF0ZWUodmFsdWUsIGluZGV4LCBsaXN0KQoJICAgICAgfTsKCSAgICB9KS5zb3J0KGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CgkgICAgICB2YXIgYSA9IGxlZnQuY3JpdGVyaWE7CgkgICAgICB2YXIgYiA9IHJpZ2h0LmNyaXRlcmlhOwoJICAgICAgaWYgKGEgIT09IGIpIHsKCSAgICAgICAgaWYgKGEgPiBiIHx8IGEgPT09IHZvaWQgMCkgcmV0dXJuIDE7CgkgICAgICAgIGlmIChhIDwgYiB8fCBiID09PSB2b2lkIDApIHJldHVybiAtMTsKCSAgICAgIH0KCSAgICAgIHJldHVybiBsZWZ0LmluZGV4IC0gcmlnaHQuaW5kZXg7CgkgICAgfSksICd2YWx1ZScpOwoJICB9OwoKCSAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdXNlZCBmb3IgYWdncmVnYXRlICJncm91cCBieSIgb3BlcmF0aW9ucy4KCSAgdmFyIGdyb3VwID0gZnVuY3Rpb24oYmVoYXZpb3IpIHsKCSAgICByZXR1cm4gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgICAgdmFyIHJlc3VsdCA9IHt9OwoJICAgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKCSAgICAgIF8uZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewoJICAgICAgICB2YXIga2V5ID0gaXRlcmF0ZWUodmFsdWUsIGluZGV4LCBvYmopOwoJICAgICAgICBiZWhhdmlvcihyZXN1bHQsIHZhbHVlLCBrZXkpOwoJICAgICAgfSk7CgkgICAgICByZXR1cm4gcmVzdWx0OwoJICAgIH07CgkgIH07CgoJICAvLyBHcm91cHMgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbi4gUGFzcyBlaXRoZXIgYSBzdHJpbmcgYXR0cmlidXRlCgkgIC8vIHRvIGdyb3VwIGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3JpdGVyaW9uLgoJICBfLmdyb3VwQnkgPSBncm91cChmdW5jdGlvbihyZXN1bHQsIHZhbHVlLCBrZXkpIHsKCSAgICBpZiAoXy5oYXMocmVzdWx0LCBrZXkpKSByZXN1bHRba2V5XS5wdXNoKHZhbHVlKTsgZWxzZSByZXN1bHRba2V5XSA9IFt2YWx1ZV07CgkgIH0pOwoKCSAgLy8gSW5kZXhlcyB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uLCBzaW1pbGFyIHRvIGBncm91cEJ5YCwgYnV0IGZvcgoJICAvLyB3aGVuIHlvdSBrbm93IHRoYXQgeW91ciBpbmRleCB2YWx1ZXMgd2lsbCBiZSB1bmlxdWUuCgkgIF8uaW5kZXhCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewoJICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CgkgIH0pOwoKCSAgLy8gQ291bnRzIGluc3RhbmNlcyBvZiBhbiBvYmplY3QgdGhhdCBncm91cCBieSBhIGNlcnRhaW4gY3JpdGVyaW9uLiBQYXNzCgkgIC8vIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUgdG8gY291bnQgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZQoJICAvLyBjcml0ZXJpb24uCgkgIF8uY291bnRCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewoJICAgIGlmIChfLmhhcyhyZXN1bHQsIGtleSkpIHJlc3VsdFtrZXldKys7IGVsc2UgcmVzdWx0W2tleV0gPSAxOwoJICB9KTsKCgkgIC8vIFVzZSBhIGNvbXBhcmF0b3IgZnVuY3Rpb24gdG8gZmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2gKCSAgLy8gYW4gb2JqZWN0IHNob3VsZCBiZSBpbnNlcnRlZCBzbyBhcyB0byBtYWludGFpbiBvcmRlci4gVXNlcyBiaW5hcnkgc2VhcmNoLgoJICBfLnNvcnRlZEluZGV4ID0gZnVuY3Rpb24oYXJyYXksIG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQsIDEpOwoJICAgIHZhciB2YWx1ZSA9IGl0ZXJhdGVlKG9iaik7CgkgICAgdmFyIGxvdyA9IDAsIGhpZ2ggPSBhcnJheS5sZW5ndGg7CgkgICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKCSAgICAgIHZhciBtaWQgPSBsb3cgKyBoaWdoID4+PiAxOwoJICAgICAgaWYgKGl0ZXJhdGVlKGFycmF5W21pZF0pIDwgdmFsdWUpIGxvdyA9IG1pZCArIDE7IGVsc2UgaGlnaCA9IG1pZDsKCSAgICB9CgkgICAgcmV0dXJuIGxvdzsKCSAgfTsKCgkgIC8vIFNhZmVseSBjcmVhdGUgYSByZWFsLCBsaXZlIGFycmF5IGZyb20gYW55dGhpbmcgaXRlcmFibGUuCgkgIF8udG9BcnJheSA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmICghb2JqKSByZXR1cm4gW107CgkgICAgaWYgKF8uaXNBcnJheShvYmopKSByZXR1cm4gc2xpY2UuY2FsbChvYmopOwoJICAgIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgcmV0dXJuIF8ubWFwKG9iaiwgXy5pZGVudGl0eSk7CgkgICAgcmV0dXJuIF8udmFsdWVzKG9iaik7CgkgIH07CgoJICAvLyBSZXR1cm4gdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBvYmplY3QuCgkgIF8uc2l6ZSA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIDA7CgkgICAgcmV0dXJuIG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoID8gb2JqLmxlbmd0aCA6IF8ua2V5cyhvYmopLmxlbmd0aDsKCSAgfTsKCgkgIC8vIFNwbGl0IGEgY29sbGVjdGlvbiBpbnRvIHR3byBhcnJheXM6IG9uZSB3aG9zZSBlbGVtZW50cyBhbGwgc2F0aXNmeSB0aGUgZ2l2ZW4KCSAgLy8gcHJlZGljYXRlLCBhbmQgb25lIHdob3NlIGVsZW1lbnRzIGFsbCBkbyBub3Qgc2F0aXNmeSB0aGUgcHJlZGljYXRlLgoJICBfLnBhcnRpdGlvbiA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CgkgICAgcHJlZGljYXRlID0gXy5pdGVyYXRlZShwcmVkaWNhdGUsIGNvbnRleHQpOwoJICAgIHZhciBwYXNzID0gW10sIGZhaWwgPSBbXTsKCSAgICBfLmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmopIHsKCSAgICAgIChwcmVkaWNhdGUodmFsdWUsIGtleSwgb2JqKSA/IHBhc3MgOiBmYWlsKS5wdXNoKHZhbHVlKTsKCSAgICB9KTsKCSAgICByZXR1cm4gW3Bhc3MsIGZhaWxdOwoJICB9OwoKCSAgLy8gQXJyYXkgRnVuY3Rpb25zCgkgIC8vIC0tLS0tLS0tLS0tLS0tLQoKCSAgLy8gR2V0IHRoZSBmaXJzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBmaXJzdCBOCgkgIC8vIHZhbHVlcyBpbiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYGhlYWRgIGFuZCBgdGFrZWAuIFRoZSAqKmd1YXJkKiogY2hlY2sKCSAgLy8gYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgoJICBfLmZpcnN0ID0gXy5oZWFkID0gXy50YWtlID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CgkgICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiB2b2lkIDA7CgkgICAgaWYgKG4gPT0gbnVsbCB8fCBndWFyZCkgcmV0dXJuIGFycmF5WzBdOwoJICAgIGlmIChuIDwgMCkgcmV0dXJuIFtdOwoJICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBuKTsKCSAgfTsKCgkgIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGxhc3QgZW50cnkgb2YgdGhlIGFycmF5LiBFc3BlY2lhbGx5IHVzZWZ1bCBvbgoJICAvLyB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiBhbGwgdGhlIHZhbHVlcyBpbgoJICAvLyB0aGUgYXJyYXksIGV4Y2x1ZGluZyB0aGUgbGFzdCBOLiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGgKCSAgLy8gYF8ubWFwYC4KCSAgXy5pbml0aWFsID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CgkgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIDAsIE1hdGgubWF4KDAsIGFycmF5Lmxlbmd0aCAtIChuID09IG51bGwgfHwgZ3VhcmQgPyAxIDogbikpKTsKCSAgfTsKCgkgIC8vIEdldCB0aGUgbGFzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBsYXN0IE4KCSAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCgkgIF8ubGFzdCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewoJICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwoJICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpIHJldHVybiBhcnJheVthcnJheS5sZW5ndGggLSAxXTsKCSAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgTWF0aC5tYXgoYXJyYXkubGVuZ3RoIC0gbiwgMCkpOwoJICB9OwoKCSAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgZmlyc3QgZW50cnkgb2YgdGhlIGFycmF5LiBBbGlhc2VkIGFzIGB0YWlsYCBhbmQgYGRyb3BgLgoJICAvLyBFc3BlY2lhbGx5IHVzZWZ1bCBvbiB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyBhbiAqKm4qKiB3aWxsIHJldHVybgoJICAvLyB0aGUgcmVzdCBOIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKioKCSAgLy8gY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgoJICBfLnJlc3QgPSBfLnRhaWwgPSBfLmRyb3AgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKCSAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgbiA9PSBudWxsIHx8IGd1YXJkID8gMSA6IG4pOwoJICB9OwoKCSAgLy8gVHJpbSBvdXQgYWxsIGZhbHN5IHZhbHVlcyBmcm9tIGFuIGFycmF5LgoJICBfLmNvbXBhY3QgPSBmdW5jdGlvbihhcnJheSkgewoJICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgXy5pZGVudGl0eSk7CgkgIH07CgoJICAvLyBJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlY3Vyc2l2ZSBgZmxhdHRlbmAgZnVuY3Rpb24uCgkgIHZhciBmbGF0dGVuID0gZnVuY3Rpb24oaW5wdXQsIHNoYWxsb3csIHN0cmljdCwgb3V0cHV0KSB7CgkgICAgaWYgKHNoYWxsb3cgJiYgXy5ldmVyeShpbnB1dCwgXy5pc0FycmF5KSkgewoJICAgICAgcmV0dXJuIGNvbmNhdC5hcHBseShvdXRwdXQsIGlucHV0KTsKCSAgICB9CgkgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGlucHV0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICB2YXIgdmFsdWUgPSBpbnB1dFtpXTsKCSAgICAgIGlmICghXy5pc0FycmF5KHZhbHVlKSAmJiAhXy5pc0FyZ3VtZW50cyh2YWx1ZSkpIHsKCSAgICAgICAgaWYgKCFzdHJpY3QpIG91dHB1dC5wdXNoKHZhbHVlKTsKCSAgICAgIH0gZWxzZSBpZiAoc2hhbGxvdykgewoJICAgICAgICBwdXNoLmFwcGx5KG91dHB1dCwgdmFsdWUpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgZmxhdHRlbih2YWx1ZSwgc2hhbGxvdywgc3RyaWN0LCBvdXRwdXQpOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gb3V0cHV0OwoJICB9OwoKCSAgLy8gRmxhdHRlbiBvdXQgYW4gYXJyYXksIGVpdGhlciByZWN1cnNpdmVseSAoYnkgZGVmYXVsdCksIG9yIGp1c3Qgb25lIGxldmVsLgoJICBfLmZsYXR0ZW4gPSBmdW5jdGlvbihhcnJheSwgc2hhbGxvdykgewoJICAgIHJldHVybiBmbGF0dGVuKGFycmF5LCBzaGFsbG93LCBmYWxzZSwgW10pOwoJICB9OwoKCSAgLy8gUmV0dXJuIGEgdmVyc2lvbiBvZiB0aGUgYXJyYXkgdGhhdCBkb2VzIG5vdCBjb250YWluIHRoZSBzcGVjaWZpZWQgdmFsdWUocykuCgkgIF8ud2l0aG91dCA9IGZ1bmN0aW9uKGFycmF5KSB7CgkgICAgcmV0dXJuIF8uZGlmZmVyZW5jZShhcnJheSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCSAgfTsKCgkgIC8vIFByb2R1Y2UgYSBkdXBsaWNhdGUtZnJlZSB2ZXJzaW9uIG9mIHRoZSBhcnJheS4gSWYgdGhlIGFycmF5IGhhcyBhbHJlYWR5CgkgIC8vIGJlZW4gc29ydGVkLCB5b3UgaGF2ZSB0aGUgb3B0aW9uIG9mIHVzaW5nIGEgZmFzdGVyIGFsZ29yaXRobS4KCSAgLy8gQWxpYXNlZCBhcyBgdW5pcXVlYC4KCSAgXy51bmlxID0gXy51bmlxdWUgPSBmdW5jdGlvbihhcnJheSwgaXNTb3J0ZWQsIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiBbXTsKCSAgICBpZiAoIV8uaXNCb29sZWFuKGlzU29ydGVkKSkgewoJICAgICAgY29udGV4dCA9IGl0ZXJhdGVlOwoJICAgICAgaXRlcmF0ZWUgPSBpc1NvcnRlZDsKCSAgICAgIGlzU29ydGVkID0gZmFsc2U7CgkgICAgfQoJICAgIGlmIChpdGVyYXRlZSAhPSBudWxsKSBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQpOwoJICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICB2YXIgc2VlbiA9IFtdOwoJICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaV07CgkgICAgICBpZiAoaXNTb3J0ZWQpIHsKCSAgICAgICAgaWYgKCFpIHx8IHNlZW4gIT09IHZhbHVlKSByZXN1bHQucHVzaCh2YWx1ZSk7CgkgICAgICAgIHNlZW4gPSB2YWx1ZTsKCSAgICAgIH0gZWxzZSBpZiAoaXRlcmF0ZWUpIHsKCSAgICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0ZWUodmFsdWUsIGksIGFycmF5KTsKCSAgICAgICAgaWYgKF8uaW5kZXhPZihzZWVuLCBjb21wdXRlZCkgPCAwKSB7CgkgICAgICAgICAgc2Vlbi5wdXNoKGNvbXB1dGVkKTsKCSAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CgkgICAgICAgIH0KCSAgICAgIH0gZWxzZSBpZiAoXy5pbmRleE9mKHJlc3VsdCwgdmFsdWUpIDwgMCkgewoJICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH07CgoJICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIHVuaW9uOiBlYWNoIGRpc3RpbmN0IGVsZW1lbnQgZnJvbSBhbGwgb2YKCSAgLy8gdGhlIHBhc3NlZC1pbiBhcnJheXMuCgkgIF8udW5pb24gPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gXy51bmlxKGZsYXR0ZW4oYXJndW1lbnRzLCB0cnVlLCB0cnVlLCBbXSkpOwoJICB9OwoKCSAgLy8gUHJvZHVjZSBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIGV2ZXJ5IGl0ZW0gc2hhcmVkIGJldHdlZW4gYWxsIHRoZQoJICAvLyBwYXNzZWQtaW4gYXJyYXlzLgoJICBfLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKGFycmF5KSB7CgkgICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiBbXTsKCSAgICB2YXIgcmVzdWx0ID0gW107CgkgICAgdmFyIGFyZ3NMZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwoJICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgdmFyIGl0ZW0gPSBhcnJheVtpXTsKCSAgICAgIGlmIChfLmNvbnRhaW5zKHJlc3VsdCwgaXRlbSkpIGNvbnRpbnVlOwoJICAgICAgZm9yICh2YXIgaiA9IDE7IGogPCBhcmdzTGVuZ3RoOyBqKyspIHsKCSAgICAgICAgaWYgKCFfLmNvbnRhaW5zKGFyZ3VtZW50c1tqXSwgaXRlbSkpIGJyZWFrOwoJICAgICAgfQoJICAgICAgaWYgKGogPT09IGFyZ3NMZW5ndGgpIHJlc3VsdC5wdXNoKGl0ZW0pOwoJICAgIH0KCSAgICByZXR1cm4gcmVzdWx0OwoJICB9OwoKCSAgLy8gVGFrZSB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIG9uZSBhcnJheSBhbmQgYSBudW1iZXIgb2Ygb3RoZXIgYXJyYXlzLgoJICAvLyBPbmx5IHRoZSBlbGVtZW50cyBwcmVzZW50IGluIGp1c3QgdGhlIGZpcnN0IGFycmF5IHdpbGwgcmVtYWluLgoJICBfLmRpZmZlcmVuY2UgPSBmdW5jdGlvbihhcnJheSkgewoJICAgIHZhciByZXN0ID0gZmxhdHRlbihzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIHRydWUsIHRydWUsIFtdKTsKCSAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKXsKCSAgICAgIHJldHVybiAhXy5jb250YWlucyhyZXN0LCB2YWx1ZSk7CgkgICAgfSk7CgkgIH07CgoJICAvLyBaaXAgdG9nZXRoZXIgbXVsdGlwbGUgbGlzdHMgaW50byBhIHNpbmdsZSBhcnJheSAtLSBlbGVtZW50cyB0aGF0IHNoYXJlCgkgIC8vIGFuIGluZGV4IGdvIHRvZ2V0aGVyLgoJICBfLnppcCA9IGZ1bmN0aW9uKGFycmF5KSB7CgkgICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiBbXTsKCSAgICB2YXIgbGVuZ3RoID0gXy5tYXgoYXJndW1lbnRzLCAnbGVuZ3RoJykubGVuZ3RoOwoJICAgIHZhciByZXN1bHRzID0gQXJyYXkobGVuZ3RoKTsKCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICByZXN1bHRzW2ldID0gXy5wbHVjayhhcmd1bWVudHMsIGkpOwoJICAgIH0KCSAgICByZXR1cm4gcmVzdWx0czsKCSAgfTsKCgkgIC8vIENvbnZlcnRzIGxpc3RzIGludG8gb2JqZWN0cy4gUGFzcyBlaXRoZXIgYSBzaW5nbGUgYXJyYXkgb2YgYFtrZXksIHZhbHVlXWAKCSAgLy8gcGFpcnMsIG9yIHR3byBwYXJhbGxlbCBhcnJheXMgb2YgdGhlIHNhbWUgbGVuZ3RoIC0tIG9uZSBvZiBrZXlzLCBhbmQgb25lIG9mCgkgIC8vIHRoZSBjb3JyZXNwb25kaW5nIHZhbHVlcy4KCSAgXy5vYmplY3QgPSBmdW5jdGlvbihsaXN0LCB2YWx1ZXMpIHsKCSAgICBpZiAobGlzdCA9PSBudWxsKSByZXR1cm4ge307CgkgICAgdmFyIHJlc3VsdCA9IHt9OwoJICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBsaXN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICBpZiAodmFsdWVzKSB7CgkgICAgICAgIHJlc3VsdFtsaXN0W2ldXSA9IHZhbHVlc1tpXTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHJlc3VsdFtsaXN0W2ldWzBdXSA9IGxpc3RbaV1bMV07CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH07CgoJICAvLyBSZXR1cm4gdGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGFuIGl0ZW0gaW4gYW4gYXJyYXksCgkgIC8vIG9yIC0xIGlmIHRoZSBpdGVtIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgYXJyYXkuCgkgIC8vIElmIHRoZSBhcnJheSBpcyBsYXJnZSBhbmQgYWxyZWFkeSBpbiBzb3J0IG9yZGVyLCBwYXNzIGB0cnVlYAoJICAvLyBmb3IgKippc1NvcnRlZCoqIHRvIHVzZSBiaW5hcnkgc2VhcmNoLgoJICBfLmluZGV4T2YgPSBmdW5jdGlvbihhcnJheSwgaXRlbSwgaXNTb3J0ZWQpIHsKCSAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwoJICAgIHZhciBpID0gMCwgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoJICAgIGlmIChpc1NvcnRlZCkgewoJICAgICAgaWYgKHR5cGVvZiBpc1NvcnRlZCA9PSAnbnVtYmVyJykgewoJICAgICAgICBpID0gaXNTb3J0ZWQgPCAwID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgaXNTb3J0ZWQpIDogaXNTb3J0ZWQ7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBpID0gXy5zb3J0ZWRJbmRleChhcnJheSwgaXRlbSk7CgkgICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKCSAgICAgIH0KCSAgICB9CgkgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgaWYgKGFycmF5W2ldID09PSBpdGVtKSByZXR1cm4gaTsKCSAgICByZXR1cm4gLTE7CgkgIH07CgoJICBfLmxhc3RJbmRleE9mID0gZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGZyb20pIHsKCSAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwoJICAgIHZhciBpZHggPSBhcnJheS5sZW5ndGg7CgkgICAgaWYgKHR5cGVvZiBmcm9tID09ICdudW1iZXInKSB7CgkgICAgICBpZHggPSBmcm9tIDwgMCA/IGlkeCArIGZyb20gKyAxIDogTWF0aC5taW4oaWR4LCBmcm9tICsgMSk7CgkgICAgfQoJICAgIHdoaWxlICgtLWlkeCA+PSAwKSBpZiAoYXJyYXlbaWR4XSA9PT0gaXRlbSkgcmV0dXJuIGlkeDsKCSAgICByZXR1cm4gLTE7CgkgIH07CgoJICAvLyBHZW5lcmF0ZSBhbiBpbnRlZ2VyIEFycmF5IGNvbnRhaW5pbmcgYW4gYXJpdGhtZXRpYyBwcm9ncmVzc2lvbi4gQSBwb3J0IG9mCgkgIC8vIHRoZSBuYXRpdmUgUHl0aG9uIGByYW5nZSgpYCBmdW5jdGlvbi4gU2VlCgkgIC8vIFt0aGUgUHl0aG9uIGRvY3VtZW50YXRpb25dKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9mdW5jdGlvbnMuaHRtbCNyYW5nZSkuCgkgIF8ucmFuZ2UgPSBmdW5jdGlvbihzdGFydCwgc3RvcCwgc3RlcCkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDw9IDEpIHsKCSAgICAgIHN0b3AgPSBzdGFydCB8fCAwOwoJICAgICAgc3RhcnQgPSAwOwoJICAgIH0KCSAgICBzdGVwID0gc3RlcCB8fCAxOwoKCSAgICB2YXIgbGVuZ3RoID0gTWF0aC5tYXgoTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCksIDApOwoJICAgIHZhciByYW5nZSA9IEFycmF5KGxlbmd0aCk7CgoJICAgIGZvciAodmFyIGlkeCA9IDA7IGlkeCA8IGxlbmd0aDsgaWR4KyssIHN0YXJ0ICs9IHN0ZXApIHsKCSAgICAgIHJhbmdlW2lkeF0gPSBzdGFydDsKCSAgICB9CgoJICAgIHJldHVybiByYW5nZTsKCSAgfTsKCgkgIC8vIEZ1bmN0aW9uIChhaGVtKSBGdW5jdGlvbnMKCSAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBSZXVzYWJsZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgcHJvdG90eXBlIHNldHRpbmcuCgkgIHZhciBDdG9yID0gZnVuY3Rpb24oKXt9OwoKCSAgLy8gQ3JlYXRlIGEgZnVuY3Rpb24gYm91bmQgdG8gYSBnaXZlbiBvYmplY3QgKGFzc2lnbmluZyBgdGhpc2AsIGFuZCBhcmd1bWVudHMsCgkgIC8vIG9wdGlvbmFsbHkpLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgRnVuY3Rpb24uYmluZGAgaWYKCSAgLy8gYXZhaWxhYmxlLgoJICBfLmJpbmQgPSBmdW5jdGlvbihmdW5jLCBjb250ZXh0KSB7CgkgICAgdmFyIGFyZ3MsIGJvdW5kOwoJICAgIGlmIChuYXRpdmVCaW5kICYmIGZ1bmMuYmluZCA9PT0gbmF0aXZlQmluZCkgcmV0dXJuIG5hdGl2ZUJpbmQuYXBwbHkoZnVuYywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCSAgICBpZiAoIV8uaXNGdW5jdGlvbihmdW5jKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignQmluZCBtdXN0IGJlIGNhbGxlZCBvbiBhIGZ1bmN0aW9uJyk7CgkgICAgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKCSAgICBib3VuZCA9IGZ1bmN0aW9uKCkgewoJICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGJvdW5kKSkgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CgkgICAgICBDdG9yLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwoJICAgICAgdmFyIHNlbGYgPSBuZXcgQ3RvcjsKCSAgICAgIEN0b3IucHJvdG90eXBlID0gbnVsbDsKCSAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHNlbGYsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwoJICAgICAgaWYgKF8uaXNPYmplY3QocmVzdWx0KSkgcmV0dXJuIHJlc3VsdDsKCSAgICAgIHJldHVybiBzZWxmOwoJICAgIH07CgkgICAgcmV0dXJuIGJvdW5kOwoJICB9OwoKCSAgLy8gUGFydGlhbGx5IGFwcGx5IGEgZnVuY3Rpb24gYnkgY3JlYXRpbmcgYSB2ZXJzaW9uIHRoYXQgaGFzIGhhZCBzb21lIG9mIGl0cwoJICAvLyBhcmd1bWVudHMgcHJlLWZpbGxlZCwgd2l0aG91dCBjaGFuZ2luZyBpdHMgZHluYW1pYyBgdGhpc2AgY29udGV4dC4gXyBhY3RzCgkgIC8vIGFzIGEgcGxhY2Vob2xkZXIsIGFsbG93aW5nIGFueSBjb21iaW5hdGlvbiBvZiBhcmd1bWVudHMgdG8gYmUgcHJlLWZpbGxlZC4KCSAgXy5wYXJ0aWFsID0gZnVuY3Rpb24oZnVuYykgewoJICAgIHZhciBib3VuZEFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIHBvc2l0aW9uID0gMDsKCSAgICAgIHZhciBhcmdzID0gYm91bmRBcmdzLnNsaWNlKCk7CgkgICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gYXJncy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICBpZiAoYXJnc1tpXSA9PT0gXykgYXJnc1tpXSA9IGFyZ3VtZW50c1twb3NpdGlvbisrXTsKCSAgICAgIH0KCSAgICAgIHdoaWxlIChwb3NpdGlvbiA8IGFyZ3VtZW50cy5sZW5ndGgpIGFyZ3MucHVzaChhcmd1bWVudHNbcG9zaXRpb24rK10pOwoJICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CgkgICAgfTsKCSAgfTsKCgkgIC8vIEJpbmQgYSBudW1iZXIgb2YgYW4gb2JqZWN0J3MgbWV0aG9kcyB0byB0aGF0IG9iamVjdC4gUmVtYWluaW5nIGFyZ3VtZW50cwoJICAvLyBhcmUgdGhlIG1ldGhvZCBuYW1lcyB0byBiZSBib3VuZC4gVXNlZnVsIGZvciBlbnN1cmluZyB0aGF0IGFsbCBjYWxsYmFja3MKCSAgLy8gZGVmaW5lZCBvbiBhbiBvYmplY3QgYmVsb25nIHRvIGl0LgoJICBfLmJpbmRBbGwgPSBmdW5jdGlvbihvYmopIHsKCSAgICB2YXIgaSwgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwga2V5OwoJICAgIGlmIChsZW5ndGggPD0gMSkgdGhyb3cgbmV3IEVycm9yKCdiaW5kQWxsIG11c3QgYmUgcGFzc2VkIGZ1bmN0aW9uIG5hbWVzJyk7CgkgICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICBrZXkgPSBhcmd1bWVudHNbaV07CgkgICAgICBvYmpba2V5XSA9IF8uYmluZChvYmpba2V5XSwgb2JqKTsKCSAgICB9CgkgICAgcmV0dXJuIG9iajsKCSAgfTsKCgkgIC8vIE1lbW9pemUgYW4gZXhwZW5zaXZlIGZ1bmN0aW9uIGJ5IHN0b3JpbmcgaXRzIHJlc3VsdHMuCgkgIF8ubWVtb2l6ZSA9IGZ1bmN0aW9uKGZ1bmMsIGhhc2hlcikgewoJICAgIHZhciBtZW1vaXplID0gZnVuY3Rpb24oa2V5KSB7CgkgICAgICB2YXIgY2FjaGUgPSBtZW1vaXplLmNhY2hlOwoJICAgICAgdmFyIGFkZHJlc3MgPSBoYXNoZXIgPyBoYXNoZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IGtleTsKCSAgICAgIGlmICghXy5oYXMoY2FjaGUsIGFkZHJlc3MpKSBjYWNoZVthZGRyZXNzXSA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgIHJldHVybiBjYWNoZVthZGRyZXNzXTsKCSAgICB9OwoJICAgIG1lbW9pemUuY2FjaGUgPSB7fTsKCSAgICByZXR1cm4gbWVtb2l6ZTsKCSAgfTsKCgkgIC8vIERlbGF5cyBhIGZ1bmN0aW9uIGZvciB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1pbGxpc2Vjb25kcywgYW5kIHRoZW4gY2FsbHMKCSAgLy8gaXQgd2l0aCB0aGUgYXJndW1lbnRzIHN1cHBsaWVkLgoJICBfLmRlbGF5ID0gZnVuY3Rpb24oZnVuYywgd2FpdCkgewoJICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoJICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgkgICAgICByZXR1cm4gZnVuYy5hcHBseShudWxsLCBhcmdzKTsKCSAgICB9LCB3YWl0KTsKCSAgfTsKCgkgIC8vIERlZmVycyBhIGZ1bmN0aW9uLCBzY2hlZHVsaW5nIGl0IHRvIHJ1biBhZnRlciB0aGUgY3VycmVudCBjYWxsIHN0YWNrIGhhcwoJICAvLyBjbGVhcmVkLgoJICBfLmRlZmVyID0gZnVuY3Rpb24oZnVuYykgewoJICAgIHJldHVybiBfLmRlbGF5LmFwcGx5KF8sIFtmdW5jLCAxXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIHdoZW4gaW52b2tlZCwgd2lsbCBvbmx5IGJlIHRyaWdnZXJlZCBhdCBtb3N0IG9uY2UKCSAgLy8gZHVyaW5nIGEgZ2l2ZW4gd2luZG93IG9mIHRpbWUuIE5vcm1hbGx5LCB0aGUgdGhyb3R0bGVkIGZ1bmN0aW9uIHdpbGwgcnVuCgkgIC8vIGFzIG11Y2ggYXMgaXQgY2FuLCB3aXRob3V0IGV2ZXIgZ29pbmcgbW9yZSB0aGFuIG9uY2UgcGVyIGB3YWl0YCBkdXJhdGlvbjsKCSAgLy8gYnV0IGlmIHlvdSdkIGxpa2UgdG8gZGlzYWJsZSB0aGUgZXhlY3V0aW9uIG9uIHRoZSBsZWFkaW5nIGVkZ2UsIHBhc3MKCSAgLy8gYHtsZWFkaW5nOiBmYWxzZX1gLiBUbyBkaXNhYmxlIGV4ZWN1dGlvbiBvbiB0aGUgdHJhaWxpbmcgZWRnZSwgZGl0dG8uCgkgIF8udGhyb3R0bGUgPSBmdW5jdGlvbihmdW5jLCB3YWl0LCBvcHRpb25zKSB7CgkgICAgdmFyIGNvbnRleHQsIGFyZ3MsIHJlc3VsdDsKCSAgICB2YXIgdGltZW91dCA9IG51bGw7CgkgICAgdmFyIHByZXZpb3VzID0gMDsKCSAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKCSAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKCSAgICAgIHByZXZpb3VzID0gb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSA/IDAgOiBfLm5vdygpOwoJICAgICAgdGltZW91dCA9IG51bGw7CgkgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwoJICAgICAgaWYgKCF0aW1lb3V0KSBjb250ZXh0ID0gYXJncyA9IG51bGw7CgkgICAgfTsKCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICB2YXIgbm93ID0gXy5ub3coKTsKCSAgICAgIGlmICghcHJldmlvdXMgJiYgb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSkgcHJldmlvdXMgPSBub3c7CgkgICAgICB2YXIgcmVtYWluaW5nID0gd2FpdCAtIChub3cgLSBwcmV2aW91cyk7CgkgICAgICBjb250ZXh0ID0gdGhpczsKCSAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CgkgICAgICBpZiAocmVtYWluaW5nIDw9IDAgfHwgcmVtYWluaW5nID4gd2FpdCkgewoJICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CgkgICAgICAgIHRpbWVvdXQgPSBudWxsOwoJICAgICAgICBwcmV2aW91cyA9IG5vdzsKCSAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKCSAgICAgICAgaWYgKCF0aW1lb3V0KSBjb250ZXh0ID0gYXJncyA9IG51bGw7CgkgICAgICB9IGVsc2UgaWYgKCF0aW1lb3V0ICYmIG9wdGlvbnMudHJhaWxpbmcgIT09IGZhbHNlKSB7CgkgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCByZW1haW5pbmcpOwoJICAgICAgfQoJICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICB9OwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCBhcyBsb25nIGFzIGl0IGNvbnRpbnVlcyB0byBiZSBpbnZva2VkLCB3aWxsIG5vdAoJICAvLyBiZSB0cmlnZ2VyZWQuIFRoZSBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCBhZnRlciBpdCBzdG9wcyBiZWluZyBjYWxsZWQgZm9yCgkgIC8vIE4gbWlsbGlzZWNvbmRzLiBJZiBgaW1tZWRpYXRlYCBpcyBwYXNzZWQsIHRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZQoJICAvLyBsZWFkaW5nIGVkZ2UsIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLgoJICBfLmRlYm91bmNlID0gZnVuY3Rpb24oZnVuYywgd2FpdCwgaW1tZWRpYXRlKSB7CgkgICAgdmFyIHRpbWVvdXQsIGFyZ3MsIGNvbnRleHQsIHRpbWVzdGFtcCwgcmVzdWx0OwoKCSAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKCSAgICAgIHZhciBsYXN0ID0gXy5ub3coKSAtIHRpbWVzdGFtcDsKCgkgICAgICBpZiAobGFzdCA8IHdhaXQgJiYgbGFzdCA+IDApIHsKCSAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQgLSBsYXN0KTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHRpbWVvdXQgPSBudWxsOwoJICAgICAgICBpZiAoIWltbWVkaWF0ZSkgewoJICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CgkgICAgICAgICAgaWYgKCF0aW1lb3V0KSBjb250ZXh0ID0gYXJncyA9IG51bGw7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9OwoKCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICBjb250ZXh0ID0gdGhpczsKCSAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CgkgICAgICB0aW1lc3RhbXAgPSBfLm5vdygpOwoJICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CgkgICAgICBpZiAoIXRpbWVvdXQpIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKCSAgICAgIGlmIChjYWxsTm93KSB7CgkgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CgkgICAgICAgIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKCSAgICAgIH0KCgkgICAgICByZXR1cm4gcmVzdWx0OwoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIHRoZSBmaXJzdCBmdW5jdGlvbiBwYXNzZWQgYXMgYW4gYXJndW1lbnQgdG8gdGhlIHNlY29uZCwKCSAgLy8gYWxsb3dpbmcgeW91IHRvIGFkanVzdCBhcmd1bWVudHMsIHJ1biBjb2RlIGJlZm9yZSBhbmQgYWZ0ZXIsIGFuZAoJICAvLyBjb25kaXRpb25hbGx5IGV4ZWN1dGUgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLgoJICBfLndyYXAgPSBmdW5jdGlvbihmdW5jLCB3cmFwcGVyKSB7CgkgICAgcmV0dXJuIF8ucGFydGlhbCh3cmFwcGVyLCBmdW5jKTsKCSAgfTsKCgkgIC8vIFJldHVybnMgYSBuZWdhdGVkIHZlcnNpb24gb2YgdGhlIHBhc3NlZC1pbiBwcmVkaWNhdGUuCgkgIF8ubmVnYXRlID0gZnVuY3Rpb24ocHJlZGljYXRlKSB7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuICFwcmVkaWNhdGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICB9OwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgaXMgdGhlIGNvbXBvc2l0aW9uIG9mIGEgbGlzdCBvZiBmdW5jdGlvbnMsIGVhY2gKCSAgLy8gY29uc3VtaW5nIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KCSAgXy5jb21wb3NlID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CgkgICAgdmFyIHN0YXJ0ID0gYXJncy5sZW5ndGggLSAxOwoJICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgIHZhciBpID0gc3RhcnQ7CgkgICAgICB2YXIgcmVzdWx0ID0gYXJnc1tzdGFydF0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgIHdoaWxlIChpLS0pIHJlc3VsdCA9IGFyZ3NbaV0uY2FsbCh0aGlzLCByZXN1bHQpOwoJICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICB9OwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIGFmdGVyIGJlaW5nIGNhbGxlZCBOIHRpbWVzLgoJICBfLmFmdGVyID0gZnVuY3Rpb24odGltZXMsIGZ1bmMpIHsKCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICBpZiAoLS10aW1lcyA8IDEpIHsKCSAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgIH0KCSAgICB9OwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIGJlZm9yZSBiZWluZyBjYWxsZWQgTiB0aW1lcy4KCSAgXy5iZWZvcmUgPSBmdW5jdGlvbih0aW1lcywgZnVuYykgewoJICAgIHZhciBtZW1vOwoJICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgIGlmICgtLXRpbWVzID4gMCkgewoJICAgICAgICBtZW1vID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgZnVuYyA9IG51bGw7CgkgICAgICB9CgkgICAgICByZXR1cm4gbWVtbzsKCSAgICB9OwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCBhdCBtb3N0IG9uZSB0aW1lLCBubyBtYXR0ZXIgaG93CgkgIC8vIG9mdGVuIHlvdSBjYWxsIGl0LiBVc2VmdWwgZm9yIGxhenkgaW5pdGlhbGl6YXRpb24uCgkgIF8ub25jZSA9IF8ucGFydGlhbChfLmJlZm9yZSwgMik7CgoJICAvLyBPYmplY3QgRnVuY3Rpb25zCgkgIC8vIC0tLS0tLS0tLS0tLS0tLS0KCgkgIC8vIFJldHJpZXZlIHRoZSBuYW1lcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgoJICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgT2JqZWN0LmtleXNgCgkgIF8ua2V5cyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gW107CgkgICAgaWYgKG5hdGl2ZUtleXMpIHJldHVybiBuYXRpdmVLZXlzKG9iaik7CgkgICAgdmFyIGtleXMgPSBbXTsKCSAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSBrZXlzLnB1c2goa2V5KTsKCSAgICByZXR1cm4ga2V5czsKCSAgfTsKCgkgIC8vIFJldHJpZXZlIHRoZSB2YWx1ZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KCSAgXy52YWx1ZXMgPSBmdW5jdGlvbihvYmopIHsKCSAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwoJICAgIHZhciBsZW5ndGggPSBrZXlzLmxlbmd0aDsKCSAgICB2YXIgdmFsdWVzID0gQXJyYXkobGVuZ3RoKTsKCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICB2YWx1ZXNbaV0gPSBvYmpba2V5c1tpXV07CgkgICAgfQoJICAgIHJldHVybiB2YWx1ZXM7CgkgIH07CgoJICAvLyBDb252ZXJ0IGFuIG9iamVjdCBpbnRvIGEgbGlzdCBvZiBgW2tleSwgdmFsdWVdYCBwYWlycy4KCSAgXy5wYWlycyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CgkgICAgdmFyIGxlbmd0aCA9IGtleXMubGVuZ3RoOwoJICAgIHZhciBwYWlycyA9IEFycmF5KGxlbmd0aCk7CgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgcGFpcnNbaV0gPSBba2V5c1tpXSwgb2JqW2tleXNbaV1dXTsKCSAgICB9CgkgICAgcmV0dXJuIHBhaXJzOwoJICB9OwoKCSAgLy8gSW52ZXJ0IHRoZSBrZXlzIGFuZCB2YWx1ZXMgb2YgYW4gb2JqZWN0LiBUaGUgdmFsdWVzIG11c3QgYmUgc2VyaWFsaXphYmxlLgoJICBfLmludmVydCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciByZXN1bHQgPSB7fTsKCSAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwoJICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICByZXN1bHRbb2JqW2tleXNbaV1dXSA9IGtleXNbaV07CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH07CgoJICAvLyBSZXR1cm4gYSBzb3J0ZWQgbGlzdCBvZiB0aGUgZnVuY3Rpb24gbmFtZXMgYXZhaWxhYmxlIG9uIHRoZSBvYmplY3QuCgkgIC8vIEFsaWFzZWQgYXMgYG1ldGhvZHNgCgkgIF8uZnVuY3Rpb25zID0gXy5tZXRob2RzID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIG5hbWVzID0gW107CgkgICAgZm9yICh2YXIga2V5IGluIG9iaikgewoJICAgICAgaWYgKF8uaXNGdW5jdGlvbihvYmpba2V5XSkpIG5hbWVzLnB1c2goa2V5KTsKCSAgICB9CgkgICAgcmV0dXJuIG5hbWVzLnNvcnQoKTsKCSAgfTsKCgkgIC8vIEV4dGVuZCBhIGdpdmVuIG9iamVjdCB3aXRoIGFsbCB0aGUgcHJvcGVydGllcyBpbiBwYXNzZWQtaW4gb2JqZWN0KHMpLgoJICBfLmV4dGVuZCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gb2JqOwoJICAgIHZhciBzb3VyY2UsIHByb3A7CgkgICAgZm9yICh2YXIgaSA9IDEsIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgc291cmNlID0gYXJndW1lbnRzW2ldOwoJICAgICAgZm9yIChwcm9wIGluIHNvdXJjZSkgewoJICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIHByb3ApKSB7CgkgICAgICAgICAgICBvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF07CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIG9iajsKCSAgfTsKCgkgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCBvbmx5IGNvbnRhaW5pbmcgdGhlIHdoaXRlbGlzdGVkIHByb3BlcnRpZXMuCgkgIF8ucGljayA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICB2YXIgcmVzdWx0ID0ge30sIGtleTsKCSAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHQ7CgkgICAgaWYgKF8uaXNGdW5jdGlvbihpdGVyYXRlZSkpIHsKCSAgICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQpOwoJICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CgkgICAgICAgIHZhciB2YWx1ZSA9IG9ialtrZXldOwoJICAgICAgICBpZiAoaXRlcmF0ZWUodmFsdWUsIGtleSwgb2JqKSkgcmVzdWx0W2tleV0gPSB2YWx1ZTsKCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgdmFyIGtleXMgPSBjb25jYXQuYXBwbHkoW10sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CgkgICAgICBvYmogPSBuZXcgT2JqZWN0KG9iaik7CgkgICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0ga2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICBrZXkgPSBrZXlzW2ldOwoJICAgICAgICBpZiAoa2V5IGluIG9iaikgcmVzdWx0W2tleV0gPSBvYmpba2V5XTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgd2l0aG91dCB0aGUgYmxhY2tsaXN0ZWQgcHJvcGVydGllcy4KCSAgXy5vbWl0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIGlmIChfLmlzRnVuY3Rpb24oaXRlcmF0ZWUpKSB7CgkgICAgICBpdGVyYXRlZSA9IF8ubmVnYXRlKGl0ZXJhdGVlKTsKCSAgICB9IGVsc2UgewoJICAgICAgdmFyIGtleXMgPSBfLm1hcChjb25jYXQuYXBwbHkoW10sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSksIFN0cmluZyk7CgkgICAgICBpdGVyYXRlZSA9IGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKCSAgICAgICAgcmV0dXJuICFfLmNvbnRhaW5zKGtleXMsIGtleSk7CgkgICAgICB9OwoJICAgIH0KCSAgICByZXR1cm4gXy5waWNrKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpOwoJICB9OwoKCSAgLy8gRmlsbCBpbiBhIGdpdmVuIG9iamVjdCB3aXRoIGRlZmF1bHQgcHJvcGVydGllcy4KCSAgXy5kZWZhdWx0cyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gb2JqOwoJICAgIGZvciAodmFyIGkgPSAxLCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV07CgkgICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewoJICAgICAgICBpZiAob2JqW3Byb3BdID09PSB2b2lkIDApIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIG9iajsKCSAgfTsKCgkgIC8vIENyZWF0ZSBhIChzaGFsbG93LWNsb25lZCkgZHVwbGljYXRlIG9mIGFuIG9iamVjdC4KCSAgXy5jbG9uZSA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gb2JqOwoJICAgIHJldHVybiBfLmlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogXy5leHRlbmQoe30sIG9iaik7CgkgIH07CgoJICAvLyBJbnZva2VzIGludGVyY2VwdG9yIHdpdGggdGhlIG9iaiwgYW5kIHRoZW4gcmV0dXJucyBvYmouCgkgIC8vIFRoZSBwcmltYXJ5IHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwgaW4KCSAgLy8gb3JkZXIgdG8gcGVyZm9ybSBvcGVyYXRpb25zIG9uIGludGVybWVkaWF0ZSByZXN1bHRzIHdpdGhpbiB0aGUgY2hhaW4uCgkgIF8udGFwID0gZnVuY3Rpb24ob2JqLCBpbnRlcmNlcHRvcikgewoJICAgIGludGVyY2VwdG9yKG9iaik7CgkgICAgcmV0dXJuIG9iajsKCSAgfTsKCgkgIC8vIEludGVybmFsIHJlY3Vyc2l2ZSBjb21wYXJpc29uIGZ1bmN0aW9uIGZvciBgaXNFcXVhbGAuCgkgIHZhciBlcSA9IGZ1bmN0aW9uKGEsIGIsIGFTdGFjaywgYlN0YWNrKSB7CgkgICAgLy8gSWRlbnRpY2FsIG9iamVjdHMgYXJlIGVxdWFsLiBgMCA9PT0gLTBgLCBidXQgdGhleSBhcmVuJ3QgaWRlbnRpY2FsLgoJICAgIC8vIFNlZSB0aGUgW0hhcm1vbnkgYGVnYWxgIHByb3Bvc2FsXShodHRwOi8vd2lraS5lY21hc2NyaXB0Lm9yZy9kb2t1LnBocD9pZD1oYXJtb255OmVnYWwpLgoJICAgIGlmIChhID09PSBiKSByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PT0gMSAvIGI7CgkgICAgLy8gQSBzdHJpY3QgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkgYmVjYXVzZSBgbnVsbCA9PSB1bmRlZmluZWRgLgoJICAgIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSByZXR1cm4gYSA9PT0gYjsKCSAgICAvLyBVbndyYXAgYW55IHdyYXBwZWQgb2JqZWN0cy4KCSAgICBpZiAoYSBpbnN0YW5jZW9mIF8pIGEgPSBhLl93cmFwcGVkOwoJICAgIGlmIChiIGluc3RhbmNlb2YgXykgYiA9IGIuX3dyYXBwZWQ7CgkgICAgLy8gQ29tcGFyZSBgW1tDbGFzc11dYCBuYW1lcy4KCSAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbChhKTsKCSAgICBpZiAoY2xhc3NOYW1lICE9PSB0b1N0cmluZy5jYWxsKGIpKSByZXR1cm4gZmFsc2U7CgkgICAgc3dpdGNoIChjbGFzc05hbWUpIHsKCSAgICAgIC8vIFN0cmluZ3MsIG51bWJlcnMsIHJlZ3VsYXIgZXhwcmVzc2lvbnMsIGRhdGVzLCBhbmQgYm9vbGVhbnMgYXJlIGNvbXBhcmVkIGJ5IHZhbHVlLgoJICAgICAgY2FzZSAnW29iamVjdCBSZWdFeHBdJzoKCSAgICAgIC8vIFJlZ0V4cHMgYXJlIGNvZXJjZWQgdG8gc3RyaW5ncyBmb3IgY29tcGFyaXNvbiAoTm90ZTogJycgKyAvYS9pID09PSAnL2EvaScpCgkgICAgICBjYXNlICdbb2JqZWN0IFN0cmluZ10nOgoJICAgICAgICAvLyBQcmltaXRpdmVzIGFuZCB0aGVpciBjb3JyZXNwb25kaW5nIG9iamVjdCB3cmFwcGVycyBhcmUgZXF1aXZhbGVudDsgdGh1cywgYCI1ImAgaXMKCSAgICAgICAgLy8gZXF1aXZhbGVudCB0byBgbmV3IFN0cmluZygiNSIpYC4KCSAgICAgICAgcmV0dXJuICcnICsgYSA9PT0gJycgKyBiOwoJICAgICAgY2FzZSAnW29iamVjdCBOdW1iZXJdJzoKCSAgICAgICAgLy8gYE5hTmBzIGFyZSBlcXVpdmFsZW50LCBidXQgbm9uLXJlZmxleGl2ZS4KCSAgICAgICAgLy8gT2JqZWN0KE5hTikgaXMgZXF1aXZhbGVudCB0byBOYU4KCSAgICAgICAgaWYgKCthICE9PSArYSkgcmV0dXJuICtiICE9PSArYjsKCSAgICAgICAgLy8gQW4gYGVnYWxgIGNvbXBhcmlzb24gaXMgcGVyZm9ybWVkIGZvciBvdGhlciBudW1lcmljIHZhbHVlcy4KCSAgICAgICAgcmV0dXJuICthID09PSAwID8gMSAvICthID09PSAxIC8gYiA6ICthID09PSArYjsKCSAgICAgIGNhc2UgJ1tvYmplY3QgRGF0ZV0nOgoJICAgICAgY2FzZSAnW29iamVjdCBCb29sZWFuXSc6CgkgICAgICAgIC8vIENvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtZXJpYyBwcmltaXRpdmUgdmFsdWVzLiBEYXRlcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIKCSAgICAgICAgLy8gbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zLiBOb3RlIHRoYXQgaW52YWxpZCBkYXRlcyB3aXRoIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucwoJICAgICAgICAvLyBvZiBgTmFOYCBhcmUgbm90IGVxdWl2YWxlbnQuCgkgICAgICAgIHJldHVybiArYSA9PT0gK2I7CgkgICAgfQoJICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlOwoJICAgIC8vIEFzc3VtZSBlcXVhbGl0eSBmb3IgY3ljbGljIHN0cnVjdHVyZXMuIFRoZSBhbGdvcml0aG0gZm9yIGRldGVjdGluZyBjeWNsaWMKCSAgICAvLyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEgc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYC4KCSAgICB2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKCSAgICB3aGlsZSAobGVuZ3RoLS0pIHsKCSAgICAgIC8vIExpbmVhciBzZWFyY2guIFBlcmZvcm1hbmNlIGlzIGludmVyc2VseSBwcm9wb3J0aW9uYWwgdG8gdGhlIG51bWJlciBvZgoJICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgoJICAgICAgaWYgKGFTdGFja1tsZW5ndGhdID09PSBhKSByZXR1cm4gYlN0YWNrW2xlbmd0aF0gPT09IGI7CgkgICAgfQoJICAgIC8vIE9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudCwgYnV0IGBPYmplY3RgcwoJICAgIC8vIGZyb20gZGlmZmVyZW50IGZyYW1lcyBhcmUuCgkgICAgdmFyIGFDdG9yID0gYS5jb25zdHJ1Y3RvciwgYkN0b3IgPSBiLmNvbnN0cnVjdG9yOwoJICAgIGlmICgKCSAgICAgIGFDdG9yICE9PSBiQ3RvciAmJgoJICAgICAgLy8gSGFuZGxlIE9iamVjdC5jcmVhdGUoeCkgY2FzZXMKCSAgICAgICdjb25zdHJ1Y3RvcicgaW4gYSAmJiAnY29uc3RydWN0b3InIGluIGIgJiYKCSAgICAgICEoXy5pc0Z1bmN0aW9uKGFDdG9yKSAmJiBhQ3RvciBpbnN0YW5jZW9mIGFDdG9yICYmCgkgICAgICAgIF8uaXNGdW5jdGlvbihiQ3RvcikgJiYgYkN0b3IgaW5zdGFuY2VvZiBiQ3RvcikKCSAgICApIHsKCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9CgkgICAgLy8gQWRkIHRoZSBmaXJzdCBvYmplY3QgdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgoJICAgIGFTdGFjay5wdXNoKGEpOwoJICAgIGJTdGFjay5wdXNoKGIpOwoJICAgIHZhciBzaXplLCByZXN1bHQ7CgkgICAgLy8gUmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMuCgkgICAgaWYgKGNsYXNzTmFtZSA9PT0gJ1tvYmplY3QgQXJyYXldJykgewoJICAgICAgLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCgkgICAgICBzaXplID0gYS5sZW5ndGg7CgkgICAgICByZXN1bHQgPSBzaXplID09PSBiLmxlbmd0aDsKCSAgICAgIGlmIChyZXN1bHQpIHsKCSAgICAgICAgLy8gRGVlcCBjb21wYXJlIHRoZSBjb250ZW50cywgaWdub3Jpbmcgbm9uLW51bWVyaWMgcHJvcGVydGllcy4KCSAgICAgICAgd2hpbGUgKHNpemUtLSkgewoJICAgICAgICAgIGlmICghKHJlc3VsdCA9IGVxKGFbc2l6ZV0sIGJbc2l6ZV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIC8vIERlZXAgY29tcGFyZSBvYmplY3RzLgoJICAgICAgdmFyIGtleXMgPSBfLmtleXMoYSksIGtleTsKCSAgICAgIHNpemUgPSBrZXlzLmxlbmd0aDsKCSAgICAgIC8vIEVuc3VyZSB0aGF0IGJvdGggb2JqZWN0cyBjb250YWluIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzIGJlZm9yZSBjb21wYXJpbmcgZGVlcCBlcXVhbGl0eS4KCSAgICAgIHJlc3VsdCA9IF8ua2V5cyhiKS5sZW5ndGggPT09IHNpemU7CgkgICAgICBpZiAocmVzdWx0KSB7CgkgICAgICAgIHdoaWxlIChzaXplLS0pIHsKCSAgICAgICAgICAvLyBEZWVwIGNvbXBhcmUgZWFjaCBtZW1iZXIKCSAgICAgICAgICBrZXkgPSBrZXlzW3NpemVdOwoJICAgICAgICAgIGlmICghKHJlc3VsdCA9IF8uaGFzKGIsIGtleSkgJiYgZXEoYVtrZXldLCBiW2tleV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfQoJICAgIC8vIFJlbW92ZSB0aGUgZmlyc3Qgb2JqZWN0IGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgoJICAgIGFTdGFjay5wb3AoKTsKCSAgICBiU3RhY2sucG9wKCk7CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgIC8vIFBlcmZvcm0gYSBkZWVwIGNvbXBhcmlzb24gdG8gY2hlY2sgaWYgdHdvIG9iamVjdHMgYXJlIGVxdWFsLgoJICBfLmlzRXF1YWwgPSBmdW5jdGlvbihhLCBiKSB7CgkgICAgcmV0dXJuIGVxKGEsIGIsIFtdLCBbXSk7CgkgIH07CgoJICAvLyBJcyBhIGdpdmVuIGFycmF5LCBzdHJpbmcsIG9yIG9iamVjdCBlbXB0eT8KCSAgLy8gQW4gImVtcHR5IiBvYmplY3QgaGFzIG5vIGVudW1lcmFibGUgb3duLXByb3BlcnRpZXMuCgkgIF8uaXNFbXB0eSA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHRydWU7CgkgICAgaWYgKF8uaXNBcnJheShvYmopIHx8IF8uaXNTdHJpbmcob2JqKSB8fCBfLmlzQXJndW1lbnRzKG9iaikpIHJldHVybiBvYmoubGVuZ3RoID09PSAwOwoJICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJldHVybiBmYWxzZTsKCSAgICByZXR1cm4gdHJ1ZTsKCSAgfTsKCgkgIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBET00gZWxlbWVudD8KCSAgXy5pc0VsZW1lbnQgPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gISEob2JqICYmIG9iai5ub2RlVHlwZSA9PT0gMSk7CgkgIH07CgoJICAvLyBJcyBhIGdpdmVuIHZhbHVlIGFuIGFycmF5PwoJICAvLyBEZWxlZ2F0ZXMgdG8gRUNNQTUncyBuYXRpdmUgQXJyYXkuaXNBcnJheQoJICBfLmlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEFycmF5XSc7CgkgIH07CgoJICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIGFuIG9iamVjdD8KCSAgXy5pc09iamVjdCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciB0eXBlID0gdHlwZW9mIG9iajsKCSAgICByZXR1cm4gdHlwZSA9PT0gJ2Z1bmN0aW9uJyB8fCB0eXBlID09PSAnb2JqZWN0JyAmJiAhIW9iajsKCSAgfTsKCgkgIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgoJICBfLmVhY2goWydBcmd1bWVudHMnLCAnRnVuY3Rpb24nLCAnU3RyaW5nJywgJ051bWJlcicsICdEYXRlJywgJ1JlZ0V4cCddLCBmdW5jdGlvbihuYW1lKSB7CgkgICAgX1snaXMnICsgbmFtZV0gPSBmdW5jdGlvbihvYmopIHsKCSAgICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCgkgIC8vIHRoZXJlIGlzbid0IGFueSBpbnNwZWN0YWJsZSAiQXJndW1lbnRzIiB0eXBlLgoJICBpZiAoIV8uaXNBcmd1bWVudHMoYXJndW1lbnRzKSkgewoJICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbihvYmopIHsKCSAgICAgIHJldHVybiBfLmhhcyhvYmosICdjYWxsZWUnKTsKCSAgICB9OwoJICB9CgoJICAvLyBPcHRpbWl6ZSBgaXNGdW5jdGlvbmAgaWYgYXBwcm9wcmlhdGUuIFdvcmsgYXJvdW5kIGFuIElFIDExIGJ1Zy4KCSAgaWYgKHRydWUpIHsKCSAgICBfLmlzRnVuY3Rpb24gPSBmdW5jdGlvbihvYmopIHsKCSAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09ICdmdW5jdGlvbicgfHwgZmFsc2U7CgkgICAgfTsKCSAgfQoKCSAgLy8gSXMgYSBnaXZlbiBvYmplY3QgYSBmaW5pdGUgbnVtYmVyPwoJICBfLmlzRmluaXRlID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgcmV0dXJuIGlzRmluaXRlKG9iaikgJiYgIWlzTmFOKHBhcnNlRmxvYXQob2JqKSk7CgkgIH07CgoJICAvLyBJcyB0aGUgZ2l2ZW4gdmFsdWUgYE5hTmA/IChOYU4gaXMgdGhlIG9ubHkgbnVtYmVyIHdoaWNoIGRvZXMgbm90IGVxdWFsIGl0c2VsZikuCgkgIF8uaXNOYU4gPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIG9iaiAhPT0gK29iajsKCSAgfTsKCgkgIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwoJICBfLmlzQm9vbGVhbiA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiBvYmogPT09IHRydWUgfHwgb2JqID09PSBmYWxzZSB8fCB0b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEJvb2xlYW5dJzsKCSAgfTsKCgkgIC8vIElzIGEgZ2l2ZW4gdmFsdWUgZXF1YWwgdG8gbnVsbD8KCSAgXy5pc051bGwgPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gb2JqID09PSBudWxsOwoJICB9OwoKCSAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSB1bmRlZmluZWQ/CgkgIF8uaXNVbmRlZmluZWQgPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gb2JqID09PSB2b2lkIDA7CgkgIH07CgoJICAvLyBTaG9ydGN1dCBmdW5jdGlvbiBmb3IgY2hlY2tpbmcgaWYgYW4gb2JqZWN0IGhhcyBhIGdpdmVuIHByb3BlcnR5IGRpcmVjdGx5CgkgIC8vIG9uIGl0c2VsZiAoaW4gb3RoZXIgd29yZHMsIG5vdCBvbiBhIHByb3RvdHlwZSkuCgkgIF8uaGFzID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKCSAgICByZXR1cm4gb2JqICE9IG51bGwgJiYgaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSk7CgkgIH07CgoJICAvLyBVdGlsaXR5IEZ1bmN0aW9ucwoJICAvLyAtLS0tLS0tLS0tLS0tLS0tLQoKCSAgLy8gUnVuIFVuZGVyc2NvcmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYF9gIHZhcmlhYmxlIHRvIGl0cwoJICAvLyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCgkgIF8ubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewoJICAgIHJvb3QuXyA9IHByZXZpb3VzVW5kZXJzY29yZTsKCSAgICByZXR1cm4gdGhpczsKCSAgfTsKCgkgIC8vIEtlZXAgdGhlIGlkZW50aXR5IGZ1bmN0aW9uIGFyb3VuZCBmb3IgZGVmYXVsdCBpdGVyYXRlZXMuCgkgIF8uaWRlbnRpdHkgPSBmdW5jdGlvbih2YWx1ZSkgewoJICAgIHJldHVybiB2YWx1ZTsKCSAgfTsKCgkgIF8uY29uc3RhbnQgPSBmdW5jdGlvbih2YWx1ZSkgewoJICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiB2YWx1ZTsKCSAgICB9OwoJICB9OwoKCSAgXy5ub29wID0gZnVuY3Rpb24oKXt9OwoKCSAgXy5wcm9wZXJ0eSA9IGZ1bmN0aW9uKGtleSkgewoJICAgIHJldHVybiBmdW5jdGlvbihvYmopIHsKCSAgICAgIHJldHVybiBvYmpba2V5XTsKCSAgICB9OwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIHByZWRpY2F0ZSBmb3IgY2hlY2tpbmcgd2hldGhlciBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gc2V0IG9mIGBrZXk6dmFsdWVgIHBhaXJzLgoJICBfLm1hdGNoZXMgPSBmdW5jdGlvbihhdHRycykgewoJICAgIHZhciBwYWlycyA9IF8ucGFpcnMoYXR0cnMpLCBsZW5ndGggPSBwYWlycy5sZW5ndGg7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKG9iaikgewoJICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gIWxlbmd0aDsKCSAgICAgIG9iaiA9IG5ldyBPYmplY3Qob2JqKTsKCSAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgICAgdmFyIHBhaXIgPSBwYWlyc1tpXSwga2V5ID0gcGFpclswXTsKCSAgICAgICAgaWYgKHBhaXJbMV0gIT09IG9ialtrZXldIHx8ICEoa2V5IGluIG9iaikpIHJldHVybiBmYWxzZTsKCSAgICAgIH0KCSAgICAgIHJldHVybiB0cnVlOwoJICAgIH07CgkgIH07CgoJICAvLyBSdW4gYSBmdW5jdGlvbiAqKm4qKiB0aW1lcy4KCSAgXy50aW1lcyA9IGZ1bmN0aW9uKG4sIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgdmFyIGFjY3VtID0gQXJyYXkoTWF0aC5tYXgoMCwgbikpOwoJICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQsIDEpOwoJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSBhY2N1bVtpXSA9IGl0ZXJhdGVlKGkpOwoJICAgIHJldHVybiBhY2N1bTsKCSAgfTsKCgkgIC8vIFJldHVybiBhIHJhbmRvbSBpbnRlZ2VyIGJldHdlZW4gbWluIGFuZCBtYXggKGluY2x1c2l2ZSkuCgkgIF8ucmFuZG9tID0gZnVuY3Rpb24obWluLCBtYXgpIHsKCSAgICBpZiAobWF4ID09IG51bGwpIHsKCSAgICAgIG1heCA9IG1pbjsKCSAgICAgIG1pbiA9IDA7CgkgICAgfQoJICAgIHJldHVybiBtaW4gKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkpOwoJICB9OwoKCSAgLy8gQSAocG9zc2libHkgZmFzdGVyKSB3YXkgdG8gZ2V0IHRoZSBjdXJyZW50IHRpbWVzdGFtcCBhcyBhbiBpbnRlZ2VyLgoJICBfLm5vdyA9IERhdGUubm93IHx8IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCSAgfTsKCgkgICAvLyBMaXN0IG9mIEhUTUwgZW50aXRpZXMgZm9yIGVzY2FwaW5nLgoJICB2YXIgZXNjYXBlTWFwID0gewoJICAgICcmJzogJyZhbXA7JywKCSAgICAnPCc6ICcmbHQ7JywKCSAgICAnPic6ICcmZ3Q7JywKCSAgICAnIic6ICcmcXVvdDsnLAoJICAgICInIjogJyYjeDI3OycsCgkgICAgJ2AnOiAnJiN4NjA7JwoJICB9OwoJICB2YXIgdW5lc2NhcGVNYXAgPSBfLmludmVydChlc2NhcGVNYXApOwoKCSAgLy8gRnVuY3Rpb25zIGZvciBlc2NhcGluZyBhbmQgdW5lc2NhcGluZyBzdHJpbmdzIHRvL2Zyb20gSFRNTCBpbnRlcnBvbGF0aW9uLgoJICB2YXIgY3JlYXRlRXNjYXBlciA9IGZ1bmN0aW9uKG1hcCkgewoJICAgIHZhciBlc2NhcGVyID0gZnVuY3Rpb24obWF0Y2gpIHsKCSAgICAgIHJldHVybiBtYXBbbWF0Y2hdOwoJICAgIH07CgkgICAgLy8gUmVnZXhlcyBmb3IgaWRlbnRpZnlpbmcgYSBrZXkgdGhhdCBuZWVkcyB0byBiZSBlc2NhcGVkCgkgICAgdmFyIHNvdXJjZSA9ICcoPzonICsgXy5rZXlzKG1hcCkuam9pbignfCcpICsgJyknOwoJICAgIHZhciB0ZXN0UmVnZXhwID0gUmVnRXhwKHNvdXJjZSk7CgkgICAgdmFyIHJlcGxhY2VSZWdleHAgPSBSZWdFeHAoc291cmNlLCAnZycpOwoJICAgIHJldHVybiBmdW5jdGlvbihzdHJpbmcpIHsKCSAgICAgIHN0cmluZyA9IHN0cmluZyA9PSBudWxsID8gJycgOiAnJyArIHN0cmluZzsKCSAgICAgIHJldHVybiB0ZXN0UmVnZXhwLnRlc3Qoc3RyaW5nKSA/IHN0cmluZy5yZXBsYWNlKHJlcGxhY2VSZWdleHAsIGVzY2FwZXIpIDogc3RyaW5nOwoJICAgIH07CgkgIH07CgkgIF8uZXNjYXBlID0gY3JlYXRlRXNjYXBlcihlc2NhcGVNYXApOwoJICBfLnVuZXNjYXBlID0gY3JlYXRlRXNjYXBlcih1bmVzY2FwZU1hcCk7CgoJICAvLyBJZiB0aGUgdmFsdWUgb2YgdGhlIG5hbWVkIGBwcm9wZXJ0eWAgaXMgYSBmdW5jdGlvbiB0aGVuIGludm9rZSBpdCB3aXRoIHRoZQoJICAvLyBgb2JqZWN0YCBhcyBjb250ZXh0OyBvdGhlcndpc2UsIHJldHVybiBpdC4KCSAgXy5yZXN1bHQgPSBmdW5jdGlvbihvYmplY3QsIHByb3BlcnR5KSB7CgkgICAgaWYgKG9iamVjdCA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwoJICAgIHZhciB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07CgkgICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyBvYmplY3RbcHJvcGVydHldKCkgOiB2YWx1ZTsKCSAgfTsKCgkgIC8vIEdlbmVyYXRlIGEgdW5pcXVlIGludGVnZXIgaWQgKHVuaXF1ZSB3aXRoaW4gdGhlIGVudGlyZSBjbGllbnQgc2Vzc2lvbikuCgkgIC8vIFVzZWZ1bCBmb3IgdGVtcG9yYXJ5IERPTSBpZHMuCgkgIHZhciBpZENvdW50ZXIgPSAwOwoJICBfLnVuaXF1ZUlkID0gZnVuY3Rpb24ocHJlZml4KSB7CgkgICAgdmFyIGlkID0gKytpZENvdW50ZXIgKyAnJzsKCSAgICByZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKCSAgfTsKCgkgIC8vIEJ5IGRlZmF1bHQsIFVuZGVyc2NvcmUgdXNlcyBFUkItc3R5bGUgdGVtcGxhdGUgZGVsaW1pdGVycywgY2hhbmdlIHRoZQoJICAvLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCgkgIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKCSAgICBldmFsdWF0ZSAgICA6IC88JShbXHNcU10rPyklPi9nLAoJICAgIGludGVycG9sYXRlIDogLzwlPShbXHNcU10rPyklPi9nLAoJICAgIGVzY2FwZSAgICAgIDogLzwlLShbXHNcU10rPyklPi9nCgkgIH07CgoJICAvLyBXaGVuIGN1c3RvbWl6aW5nIGB0ZW1wbGF0ZVNldHRpbmdzYCwgaWYgeW91IGRvbid0IHdhbnQgdG8gZGVmaW5lIGFuCgkgIC8vIGludGVycG9sYXRpb24sIGV2YWx1YXRpb24gb3IgZXNjYXBpbmcgcmVnZXgsIHdlIG5lZWQgb25lIHRoYXQgaXMKCSAgLy8gZ3VhcmFudGVlZCBub3QgdG8gbWF0Y2guCgkgIHZhciBub01hdGNoID0gLyguKV4vOwoKCSAgLy8gQ2VydGFpbiBjaGFyYWN0ZXJzIG5lZWQgdG8gYmUgZXNjYXBlZCBzbyB0aGF0IHRoZXkgY2FuIGJlIHB1dCBpbnRvIGEKCSAgLy8gc3RyaW5nIGxpdGVyYWwuCgkgIHZhciBlc2NhcGVzID0gewoJICAgICInIjogICAgICAiJyIsCgkgICAgJ1xcJzogICAgICdcXCcsCgkgICAgJ1xyJzogICAgICdyJywKCSAgICAnXG4nOiAgICAgJ24nLAoJICAgICdcdTIwMjgnOiAndTIwMjgnLAoJICAgICdcdTIwMjknOiAndTIwMjknCgkgIH07CgoJICB2YXIgZXNjYXBlciA9IC9cXHwnfFxyfFxufFx1MjAyOHxcdTIwMjkvZzsKCgkgIHZhciBlc2NhcGVDaGFyID0gZnVuY3Rpb24obWF0Y2gpIHsKCSAgICByZXR1cm4gJ1xcJyArIGVzY2FwZXNbbWF0Y2hdOwoJICB9OwoKCSAgLy8gSmF2YVNjcmlwdCBtaWNyby10ZW1wbGF0aW5nLCBzaW1pbGFyIHRvIEpvaG4gUmVzaWcncyBpbXBsZW1lbnRhdGlvbi4KCSAgLy8gVW5kZXJzY29yZSB0ZW1wbGF0aW5nIGhhbmRsZXMgYXJiaXRyYXJ5IGRlbGltaXRlcnMsIHByZXNlcnZlcyB3aGl0ZXNwYWNlLAoJICAvLyBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KCSAgLy8gTkI6IGBvbGRTZXR0aW5nc2Agb25seSBleGlzdHMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgoJICBfLnRlbXBsYXRlID0gZnVuY3Rpb24odGV4dCwgc2V0dGluZ3MsIG9sZFNldHRpbmdzKSB7CgkgICAgaWYgKCFzZXR0aW5ncyAmJiBvbGRTZXR0aW5ncykgc2V0dGluZ3MgPSBvbGRTZXR0aW5nczsKCSAgICBzZXR0aW5ncyA9IF8uZGVmYXVsdHMoe30sIHNldHRpbmdzLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwoKCSAgICAvLyBDb21iaW5lIGRlbGltaXRlcnMgaW50byBvbmUgcmVndWxhciBleHByZXNzaW9uIHZpYSBhbHRlcm5hdGlvbi4KCSAgICB2YXIgbWF0Y2hlciA9IFJlZ0V4cChbCgkgICAgICAoc2V0dGluZ3MuZXNjYXBlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKCSAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCgkgICAgICAoc2V0dGluZ3MuZXZhbHVhdGUgfHwgbm9NYXRjaCkuc291cmNlCgkgICAgXS5qb2luKCd8JykgKyAnfCQnLCAnZycpOwoKCSAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgoJICAgIHZhciBpbmRleCA9IDA7CgkgICAgdmFyIHNvdXJjZSA9ICJfX3ArPSciOwoJICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewoJICAgICAgc291cmNlICs9IHRleHQuc2xpY2UoaW5kZXgsIG9mZnNldCkucmVwbGFjZShlc2NhcGVyLCBlc2NhcGVDaGFyKTsKCSAgICAgIGluZGV4ID0gb2Zmc2V0ICsgbWF0Y2gubGVuZ3RoOwoKCSAgICAgIGlmIChlc2NhcGUpIHsKCSAgICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBlc2NhcGUgKyAiKSk9PW51bGw/Jyc6Xy5lc2NhcGUoX190KSkrXG4nIjsKCSAgICAgIH0gZWxzZSBpZiAoaW50ZXJwb2xhdGUpIHsKCSAgICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBpbnRlcnBvbGF0ZSArICIpKT09bnVsbD8nJzpfX3QpK1xuJyI7CgkgICAgICB9IGVsc2UgaWYgKGV2YWx1YXRlKSB7CgkgICAgICAgIHNvdXJjZSArPSAiJztcbiIgKyBldmFsdWF0ZSArICJcbl9fcCs9JyI7CgkgICAgICB9CgoJICAgICAgLy8gQWRvYmUgVk1zIG5lZWQgdGhlIG1hdGNoIHJldHVybmVkIHRvIHByb2R1Y2UgdGhlIGNvcnJlY3Qgb2ZmZXN0LgoJICAgICAgcmV0dXJuIG1hdGNoOwoJICAgIH0pOwoJICAgIHNvdXJjZSArPSAiJztcbiI7CgoJICAgIC8vIElmIGEgdmFyaWFibGUgaXMgbm90IHNwZWNpZmllZCwgcGxhY2UgZGF0YSB2YWx1ZXMgaW4gbG9jYWwgc2NvcGUuCgkgICAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CgoJICAgIHNvdXJjZSA9ICJ2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4sIiArCgkgICAgICAicHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTtcbiIgKwoJICAgICAgc291cmNlICsgJ3JldHVybiBfX3A7XG4nOwoKCSAgICB0cnkgewoJICAgICAgdmFyIHJlbmRlciA9IG5ldyBGdW5jdGlvbihzZXR0aW5ncy52YXJpYWJsZSB8fCAnb2JqJywgJ18nLCBzb3VyY2UpOwoJICAgIH0gY2F0Y2ggKGUpIHsKCSAgICAgIGUuc291cmNlID0gc291cmNlOwoJICAgICAgdGhyb3cgZTsKCSAgICB9CgoJICAgIHZhciB0ZW1wbGF0ZSA9IGZ1bmN0aW9uKGRhdGEpIHsKCSAgICAgIHJldHVybiByZW5kZXIuY2FsbCh0aGlzLCBkYXRhLCBfKTsKCSAgICB9OwoKCSAgICAvLyBQcm92aWRlIHRoZSBjb21waWxlZCBzb3VyY2UgYXMgYSBjb252ZW5pZW5jZSBmb3IgcHJlY29tcGlsYXRpb24uCgkgICAgdmFyIGFyZ3VtZW50ID0gc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaic7CgkgICAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyBhcmd1bWVudCArICcpe1xuJyArIHNvdXJjZSArICd9JzsKCgkgICAgcmV0dXJuIHRlbXBsYXRlOwoJICB9OwoKCSAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbi4gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgoJICBfLmNoYWluID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIGluc3RhbmNlID0gXyhvYmopOwoJICAgIGluc3RhbmNlLl9jaGFpbiA9IHRydWU7CgkgICAgcmV0dXJuIGluc3RhbmNlOwoJICB9OwoKCSAgLy8gT09QCgkgIC8vIC0tLS0tLS0tLS0tLS0tLQoJICAvLyBJZiBVbmRlcnNjb3JlIGlzIGNhbGxlZCBhcyBhIGZ1bmN0aW9uLCBpdCByZXR1cm5zIGEgd3JhcHBlZCBvYmplY3QgdGhhdAoJICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQoJICAvLyB1bmRlcnNjb3JlIGZ1bmN0aW9ucy4gV3JhcHBlZCBvYmplY3RzIG1heSBiZSBjaGFpbmVkLgoKCSAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvbnRpbnVlIGNoYWluaW5nIGludGVybWVkaWF0ZSByZXN1bHRzLgoJICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgcmV0dXJuIHRoaXMuX2NoYWluID8gXyhvYmopLmNoYWluKCkgOiBvYmo7CgkgIH07CgoJICAvLyBBZGQgeW91ciBvd24gY3VzdG9tIGZ1bmN0aW9ucyB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCgkgIF8ubWl4aW4gPSBmdW5jdGlvbihvYmopIHsKCSAgICBfLmVhY2goXy5mdW5jdGlvbnMob2JqKSwgZnVuY3Rpb24obmFtZSkgewoJICAgICAgdmFyIGZ1bmMgPSBfW25hbWVdID0gb2JqW25hbWVdOwoJICAgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKCSAgICAgICAgdmFyIGFyZ3MgPSBbdGhpcy5fd3JhcHBlZF07CgkgICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKCSAgICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIGZ1bmMuYXBwbHkoXywgYXJncykpOwoJICAgICAgfTsKCSAgICB9KTsKCSAgfTsKCgkgIC8vIEFkZCBhbGwgb2YgdGhlIFVuZGVyc2NvcmUgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyIG9iamVjdC4KCSAgXy5taXhpbihfKTsKCgkgIC8vIEFkZCBhbGwgbXV0YXRvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCgkgIF8uZWFjaChbJ3BvcCcsICdwdXNoJywgJ3JldmVyc2UnLCAnc2hpZnQnLCAnc29ydCcsICdzcGxpY2UnLCAndW5zaGlmdCddLCBmdW5jdGlvbihuYW1lKSB7CgkgICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CgkgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKCSAgICAgIHZhciBvYmogPSB0aGlzLl93cmFwcGVkOwoJICAgICAgbWV0aG9kLmFwcGx5KG9iaiwgYXJndW1lbnRzKTsKCSAgICAgIGlmICgobmFtZSA9PT0gJ3NoaWZ0JyB8fCBuYW1lID09PSAnc3BsaWNlJykgJiYgb2JqLmxlbmd0aCA9PT0gMCkgZGVsZXRlIG9ialswXTsKCSAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBvYmopOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gQWRkIGFsbCBhY2Nlc3NvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCgkgIF8uZWFjaChbJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10sIGZ1bmN0aW9uKG5hbWUpIHsKCSAgICB2YXIgbWV0aG9kID0gQXJyYXlQcm90b1tuYW1lXTsKCSAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKCSAgICB9OwoJICB9KTsKCgkgIC8vIEV4dHJhY3RzIHRoZSByZXN1bHQgZnJvbSBhIHdyYXBwZWQgYW5kIGNoYWluZWQgb2JqZWN0LgoJICBfLnByb3RvdHlwZS52YWx1ZSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiB0aGlzLl93cmFwcGVkOwoJICB9OwoKCSAgLy8gQU1EIHJlZ2lzdHJhdGlvbiBoYXBwZW5zIGF0IHRoZSBlbmQgZm9yIGNvbXBhdGliaWxpdHkgd2l0aCBBTUQgbG9hZGVycwoJICAvLyB0aGF0IG1heSBub3QgZW5mb3JjZSBuZXh0LXR1cm4gc2VtYW50aWNzIG9uIG1vZHVsZXMuIEV2ZW4gdGhvdWdoIGdlbmVyYWwKCSAgLy8gcHJhY3RpY2UgZm9yIEFNRCByZWdpc3RyYXRpb24gaXMgdG8gYmUgYW5vbnltb3VzLCB1bmRlcnNjb3JlIHJlZ2lzdGVycwoJICAvLyBhcyBhIG5hbWVkIG1vZHVsZSBiZWNhdXNlLCBsaWtlIGpRdWVyeSwgaXQgaXMgYSBiYXNlIGxpYnJhcnkgdGhhdCBpcwoJICAvLyBwb3B1bGFyIGVub3VnaCB0byBiZSBidW5kbGVkIGluIGEgdGhpcmQgcGFydHkgbGliLCBidXQgbm90IGJlIHBhcnQgb2YKCSAgLy8gYW4gQU1EIGxvYWQgcmVxdWVzdC4gVGhvc2UgY2FzZXMgY291bGQgZ2VuZXJhdGUgYW4gZXJyb3Igd2hlbiBhbgoJICAvLyBhbm9ueW1vdXMgZGVmaW5lKCkgaXMgY2FsbGVkIG91dHNpZGUgb2YgYSBsb2FkZXIgcmVxdWVzdC4KCSAgaWYgKHRydWUpIHsKCSAgICAhKF9fV0VCUEFDS19BTURfREVGSU5FX0FSUkFZX18gPSBbXSwgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gPSBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBfOwoJICAgIH0uYXBwbHkoZXhwb3J0cywgX19XRUJQQUNLX0FNRF9ERUZJTkVfQVJSQVlfXyksIF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fICE9PSB1bmRlZmluZWQgJiYgKG1vZHVsZS5leHBvcnRzID0gX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18pKTsKCSAgfQoJfS5jYWxsKHRoaXMpKTsKCgovKioqLyB9LAovKiAzMiAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkvKioqIElNUE9SVFMgRlJPTSBpbXBvcnRzLWxvYWRlciAqKiovCgl2YXIgcmVxdWlyZSA9IF9fd2VicGFja19yZXF1aXJlX187CgoJLyohCgkgKiBLbm9ja291dCBKYXZhU2NyaXB0IGxpYnJhcnkgdjMuMi4wCgkgKiAoYykgU3RldmVuIFNhbmRlcnNvbiAtIGh0dHA6Ly9rbm9ja291dGpzLmNvbS8KCSAqIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgKi8KCgkoZnVuY3Rpb24oKXsKCXZhciBERUJVRz10cnVlOwoJKGZ1bmN0aW9uKHVuZGVmaW5lZCl7CgkgICAgLy8gKDAsIGV2YWwpKCd0aGlzJykgaXMgYSByb2J1c3Qgd2F5IG9mIGdldHRpbmcgYSByZWZlcmVuY2UgdG8gdGhlIGdsb2JhbCBvYmplY3QKCSAgICAvLyBGb3IgZGV0YWlscywgc2VlIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTQxMTk5ODgvcmV0dXJuLXRoaXMtMC1ldmFsdGhpcy8xNDEyMDAyMyMxNDEyMDAyMwoJICAgIHZhciB3aW5kb3cgPSB0aGlzIHx8ICgwLCBldmFsKSgndGhpcycpLAoJICAgICAgICBkb2N1bWVudCA9IHdpbmRvd1snZG9jdW1lbnQnXSwKCSAgICAgICAgbmF2aWdhdG9yID0gd2luZG93WyduYXZpZ2F0b3InXSwKCSAgICAgICAgalF1ZXJ5SW5zdGFuY2UgPSB3aW5kb3dbImpRdWVyeSJdLAoJICAgICAgICBKU09OID0gd2luZG93WyJKU09OIl07CgkoZnVuY3Rpb24oZmFjdG9yeSkgewoJICAgIC8vIFN1cHBvcnQgdGhyZWUgbW9kdWxlIGxvYWRpbmcgc2NlbmFyaW9zCgkgICAgaWYgKHR5cGVvZiByZXF1aXJlID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JykgewoJICAgICAgICAvLyBbMV0gQ29tbW9uSlMvTm9kZS5qcwoJICAgICAgICB2YXIgdGFyZ2V0ID0gbW9kdWxlWydleHBvcnRzJ10gfHwgZXhwb3J0czsgLy8gbW9kdWxlLmV4cG9ydHMgaXMgZm9yIE5vZGUuanMKCSAgICAgICAgZmFjdG9yeSh0YXJnZXQsIHJlcXVpcmUpOwoJICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmVbJ2FtZCddKSB7CgkgICAgICAgIC8vIFsyXSBBTUQgYW5vbnltb3VzIG1vZHVsZQoJICAgICAgICBkZWZpbmUoWydleHBvcnRzJywgJ3JlcXVpcmUnXSwgZmFjdG9yeSk7CgkgICAgfSBlbHNlIHsKCSAgICAgICAgLy8gWzNdIE5vIG1vZHVsZSBsb2FkZXIgKHBsYWluIDxzY3JpcHQ+IHRhZykgLSBwdXQgZGlyZWN0bHkgaW4gZ2xvYmFsIG5hbWVzcGFjZQoJICAgICAgICBmYWN0b3J5KHdpbmRvd1sna28nXSA9IHt9KTsKCSAgICB9Cgl9KGZ1bmN0aW9uKGtvRXhwb3J0cywgcmVxdWlyZSl7CgkvLyBJbnRlcm5hbGx5LCBhbGwgS08gb2JqZWN0cyBhcmUgYXR0YWNoZWQgdG8ga29FeHBvcnRzIChldmVuIHRoZSBub24tZXhwb3J0ZWQgb25lcyB3aG9zZSBuYW1lcyB3aWxsIGJlIG1pbmlmaWVkIGJ5IHRoZSBjbG9zdXJlIGNvbXBpbGVyKS4KCS8vIEluIHRoZSBmdXR1cmUsIHRoZSBmb2xsb3dpbmcgImtvIiB2YXJpYWJsZSBtYXkgYmUgbWFkZSBkaXN0aW5jdCBmcm9tICJrb0V4cG9ydHMiIHNvIHRoYXQgcHJpdmF0ZSBvYmplY3RzIGFyZSBub3QgZXh0ZXJuYWxseSByZWFjaGFibGUuCgl2YXIga28gPSB0eXBlb2Yga29FeHBvcnRzICE9PSAndW5kZWZpbmVkJyA/IGtvRXhwb3J0cyA6IHt9OwoJLy8gR29vZ2xlIENsb3N1cmUgQ29tcGlsZXIgaGVscGVycyAodXNlZCBvbmx5IHRvIG1ha2UgdGhlIG1pbmlmaWVkIGZpbGUgc21hbGxlcikKCWtvLmV4cG9ydFN5bWJvbCA9IGZ1bmN0aW9uKGtvUGF0aCwgb2JqZWN0KSB7CgkgICAgdmFyIHRva2VucyA9IGtvUGF0aC5zcGxpdCgiLiIpOwoKCSAgICAvLyBJbiB0aGUgZnV0dXJlLCAia28iIG1heSBiZWNvbWUgZGlzdGluY3QgZnJvbSAia29FeHBvcnRzIiAoc28gdGhhdCBub24tZXhwb3J0ZWQgb2JqZWN0cyBhcmUgbm90IHJlYWNoYWJsZSkKCSAgICAvLyBBdCB0aGF0IHBvaW50LCAidGFyZ2V0IiB3b3VsZCBiZSBzZXQgdG86ICh0eXBlb2Yga29FeHBvcnRzICE9PSAidW5kZWZpbmVkIiA/IGtvRXhwb3J0cyA6IGtvKQoJICAgIHZhciB0YXJnZXQgPSBrbzsKCgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoIC0gMTsgaSsrKQoJICAgICAgICB0YXJnZXQgPSB0YXJnZXRbdG9rZW5zW2ldXTsKCSAgICB0YXJnZXRbdG9rZW5zW3Rva2Vucy5sZW5ndGggLSAxXV0gPSBvYmplY3Q7Cgl9OwoJa28uZXhwb3J0UHJvcGVydHkgPSBmdW5jdGlvbihvd25lciwgcHVibGljTmFtZSwgb2JqZWN0KSB7CgkgICAgb3duZXJbcHVibGljTmFtZV0gPSBvYmplY3Q7Cgl9OwoJa28udmVyc2lvbiA9ICIzLjIuMCI7CgoJa28uZXhwb3J0U3ltYm9sKCd2ZXJzaW9uJywga28udmVyc2lvbik7Cglrby51dGlscyA9IChmdW5jdGlvbiAoKSB7CgkgICAgZnVuY3Rpb24gb2JqZWN0Rm9yRWFjaChvYmosIGFjdGlvbikgewoJICAgICAgICBmb3IgKHZhciBwcm9wIGluIG9iaikgewoJICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewoJICAgICAgICAgICAgICAgIGFjdGlvbihwcm9wLCBvYmpbcHJvcF0pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBleHRlbmQodGFyZ2V0LCBzb3VyY2UpIHsKCSAgICAgICAgaWYgKHNvdXJjZSkgewoJICAgICAgICAgICAgZm9yKHZhciBwcm9wIGluIHNvdXJjZSkgewoJICAgICAgICAgICAgICAgIGlmKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewoJICAgICAgICAgICAgICAgICAgICB0YXJnZXRbcHJvcF0gPSBzb3VyY2VbcHJvcF07CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIHJldHVybiB0YXJnZXQ7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBzZXRQcm90b3R5cGVPZihvYmosIHByb3RvKSB7CgkgICAgICAgIG9iai5fX3Byb3RvX18gPSBwcm90bzsKCSAgICAgICAgcmV0dXJuIG9iajsKCSAgICB9CgoJICAgIHZhciBjYW5TZXRQcm90b3R5cGUgPSAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSk7CgoJICAgIC8vIFJlcHJlc2VudCB0aGUga25vd24gZXZlbnQgdHlwZXMgaW4gYSBjb21wYWN0IHdheSwgdGhlbiBhdCBydW50aW1lIHRyYW5zZm9ybSBpdCBpbnRvIGEgaGFzaCB3aXRoIGV2ZW50IG5hbWUgYXMga2V5IChmb3IgZmFzdCBsb29rdXApCgkgICAgdmFyIGtub3duRXZlbnRzID0ge30sIGtub3duRXZlbnRUeXBlc0J5RXZlbnROYW1lID0ge307CgkgICAgdmFyIGtleUV2ZW50VHlwZU5hbWUgPSAobmF2aWdhdG9yICYmIC9GaXJlZm94XC8yL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSkgPyAnS2V5Ym9hcmRFdmVudCcgOiAnVUlFdmVudHMnOwoJICAgIGtub3duRXZlbnRzW2tleUV2ZW50VHlwZU5hbWVdID0gWydrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJ107CgkgICAga25vd25FdmVudHNbJ01vdXNlRXZlbnRzJ10gPSBbJ2NsaWNrJywgJ2RibGNsaWNrJywgJ21vdXNlZG93bicsICdtb3VzZXVwJywgJ21vdXNlbW92ZScsICdtb3VzZW92ZXInLCAnbW91c2VvdXQnLCAnbW91c2VlbnRlcicsICdtb3VzZWxlYXZlJ107CgkgICAgb2JqZWN0Rm9yRWFjaChrbm93bkV2ZW50cywgZnVuY3Rpb24oZXZlbnRUeXBlLCBrbm93bkV2ZW50c0ZvclR5cGUpIHsKCSAgICAgICAgaWYgKGtub3duRXZlbnRzRm9yVHlwZS5sZW5ndGgpIHsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0ga25vd25FdmVudHNGb3JUeXBlLmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICBrbm93bkV2ZW50VHlwZXNCeUV2ZW50TmFtZVtrbm93bkV2ZW50c0ZvclR5cGVbaV1dID0gZXZlbnRUeXBlOwoJICAgICAgICB9CgkgICAgfSk7CgkgICAgdmFyIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudCA9IHsgJ3Byb3BlcnR5Y2hhbmdlJzogdHJ1ZSB9OyAvLyBXb3JrYXJvdW5kIGZvciBhbiBJRTkgaXNzdWUgLSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzQwNgoKCSAgICAvLyBEZXRlY3QgSUUgdmVyc2lvbnMgZm9yIGJ1ZyB3b3JrYXJvdW5kcyAodXNlcyBJRSBjb25kaXRpb25hbHMsIG5vdCBVQSBzdHJpbmcsIGZvciByb2J1c3RuZXNzKQoJICAgIC8vIE5vdGUgdGhhdCwgc2luY2UgSUUgMTAgZG9lcyBub3Qgc3VwcG9ydCBjb25kaXRpb25hbCBjb21tZW50cywgdGhlIGZvbGxvd2luZyBsb2dpYyBvbmx5IGRldGVjdHMgSUUgPCAxMC4KCSAgICAvLyBDdXJyZW50bHkgdGhpcyBpcyBieSBkZXNpZ24sIHNpbmNlIElFIDEwKyBiZWhhdmVzIGNvcnJlY3RseSB3aGVuIHRyZWF0ZWQgYXMgYSBzdGFuZGFyZCBicm93c2VyLgoJICAgIC8vIElmIHRoZXJlIGlzIGEgZnV0dXJlIG5lZWQgdG8gZGV0ZWN0IHNwZWNpZmljIHZlcnNpb25zIG9mIElFMTArLCB3ZSB3aWxsIGFtZW5kIHRoaXMuCgkgICAgdmFyIGllVmVyc2lvbiA9IGRvY3VtZW50ICYmIChmdW5jdGlvbigpIHsKCSAgICAgICAgdmFyIHZlcnNpb24gPSAzLCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgaUVsZW1zID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpJyk7CgoJICAgICAgICAvLyBLZWVwIGNvbnN0cnVjdGluZyBjb25kaXRpb25hbCBIVE1MIGJsb2NrcyB1bnRpbCB3ZSBoaXQgb25lIHRoYXQgcmVzb2x2ZXMgdG8gYW4gZW1wdHkgZnJhZ21lbnQKCSAgICAgICAgd2hpbGUgKAoJICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8IS0tW2lmIGd0IElFICcgKyAoKyt2ZXJzaW9uKSArICddPjxpPjwvaT48IVtlbmRpZl0tLT4nLAoJICAgICAgICAgICAgaUVsZW1zWzBdCgkgICAgICAgICkge30KCSAgICAgICAgcmV0dXJuIHZlcnNpb24gPiA0ID8gdmVyc2lvbiA6IHVuZGVmaW5lZDsKCSAgICB9KCkpOwoJICAgIHZhciBpc0llNiA9IGllVmVyc2lvbiA9PT0gNiwKCSAgICAgICAgaXNJZTcgPSBpZVZlcnNpb24gPT09IDc7CgoJICAgIGZ1bmN0aW9uIGlzQ2xpY2tPbkNoZWNrYWJsZUVsZW1lbnQoZWxlbWVudCwgZXZlbnRUeXBlKSB7CgkgICAgICAgIGlmICgoa28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnQpICE9PSAiaW5wdXQiKSB8fCAhZWxlbWVudC50eXBlKSByZXR1cm4gZmFsc2U7CgkgICAgICAgIGlmIChldmVudFR5cGUudG9Mb3dlckNhc2UoKSAhPSAiY2xpY2siKSByZXR1cm4gZmFsc2U7CgkgICAgICAgIHZhciBpbnB1dFR5cGUgPSBlbGVtZW50LnR5cGU7CgkgICAgICAgIHJldHVybiAoaW5wdXRUeXBlID09ICJjaGVja2JveCIpIHx8IChpbnB1dFR5cGUgPT0gInJhZGlvIik7CgkgICAgfQoKCSAgICByZXR1cm4gewoJICAgICAgICBmaWVsZHNJbmNsdWRlZFdpdGhKc29uUG9zdDogWydhdXRoZW50aWNpdHlfdG9rZW4nLCAvXl9fUmVxdWVzdFZlcmlmaWNhdGlvblRva2VuKF8uKik/JC9dLAoKCSAgICAgICAgYXJyYXlGb3JFYWNoOiBmdW5jdGlvbiAoYXJyYXksIGFjdGlvbikgewoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCgkgICAgICAgICAgICAgICAgYWN0aW9uKGFycmF5W2ldLCBpKTsKCSAgICAgICAgfSwKCgkgICAgICAgIGFycmF5SW5kZXhPZjogZnVuY3Rpb24gKGFycmF5LCBpdGVtKSB7CgkgICAgICAgICAgICBpZiAodHlwZW9mIEFycmF5LnByb3RvdHlwZS5pbmRleE9mID09ICJmdW5jdGlvbiIpCgkgICAgICAgICAgICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5pbmRleE9mLmNhbGwoYXJyYXksIGl0ZW0pOwoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCgkgICAgICAgICAgICAgICAgaWYgKGFycmF5W2ldID09PSBpdGVtKQoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTsKCSAgICAgICAgICAgIHJldHVybiAtMTsKCSAgICAgICAgfSwKCgkgICAgICAgIGFycmF5Rmlyc3Q6IGZ1bmN0aW9uIChhcnJheSwgcHJlZGljYXRlLCBwcmVkaWNhdGVPd25lcikgewoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCgkgICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZS5jYWxsKHByZWRpY2F0ZU93bmVyLCBhcnJheVtpXSwgaSkpCgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcnJheVtpXTsKCSAgICAgICAgICAgIHJldHVybiBudWxsOwoJICAgICAgICB9LAoKCSAgICAgICAgYXJyYXlSZW1vdmVJdGVtOiBmdW5jdGlvbiAoYXJyYXksIGl0ZW1Ub1JlbW92ZSkgewoJICAgICAgICAgICAgdmFyIGluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGFycmF5LCBpdGVtVG9SZW1vdmUpOwoJICAgICAgICAgICAgaWYgKGluZGV4ID4gMCkgewoJICAgICAgICAgICAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBlbHNlIGlmIChpbmRleCA9PT0gMCkgewoJICAgICAgICAgICAgICAgIGFycmF5LnNoaWZ0KCk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBhcnJheUdldERpc3RpbmN0VmFsdWVzOiBmdW5jdGlvbiAoYXJyYXkpIHsKCSAgICAgICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CgkgICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykgewoJICAgICAgICAgICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YocmVzdWx0LCBhcnJheVtpXSkgPCAwKQoJICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChhcnJheVtpXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgICAgICB9LAoKCSAgICAgICAgYXJyYXlNYXA6IGZ1bmN0aW9uIChhcnJheSwgbWFwcGluZykgewoJICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKCSAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG1hcHBpbmcoYXJyYXlbaV0sIGkpKTsKCSAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgICAgIH0sCgoJICAgICAgICBhcnJheUZpbHRlcjogZnVuY3Rpb24gKGFycmF5LCBwcmVkaWNhdGUpIHsKCSAgICAgICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CgkgICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICBpZiAocHJlZGljYXRlKGFycmF5W2ldLCBpKSkKCSAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goYXJyYXlbaV0pOwoJICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICAgICAgfSwKCgkgICAgICAgIGFycmF5UHVzaEFsbDogZnVuY3Rpb24gKGFycmF5LCB2YWx1ZXNUb1B1c2gpIHsKCSAgICAgICAgICAgIGlmICh2YWx1ZXNUb1B1c2ggaW5zdGFuY2VvZiBBcnJheSkKCSAgICAgICAgICAgICAgICBhcnJheS5wdXNoLmFwcGx5KGFycmF5LCB2YWx1ZXNUb1B1c2gpOwoJICAgICAgICAgICAgZWxzZQoJICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmFsdWVzVG9QdXNoLmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaCh2YWx1ZXNUb1B1c2hbaV0pOwoJICAgICAgICAgICAgcmV0dXJuIGFycmF5OwoJICAgICAgICB9LAoKCSAgICAgICAgYWRkT3JSZW1vdmVJdGVtOiBmdW5jdGlvbihhcnJheSwgdmFsdWUsIGluY2x1ZGVkKSB7CgkgICAgICAgICAgICB2YXIgZXhpc3RpbmdFbnRyeUluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGtvLnV0aWxzLnBlZWtPYnNlcnZhYmxlKGFycmF5KSwgdmFsdWUpOwoJICAgICAgICAgICAgaWYgKGV4aXN0aW5nRW50cnlJbmRleCA8IDApIHsKCSAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZWQpCgkgICAgICAgICAgICAgICAgICAgIGFycmF5LnB1c2godmFsdWUpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVkKQoJICAgICAgICAgICAgICAgICAgICBhcnJheS5zcGxpY2UoZXhpc3RpbmdFbnRyeUluZGV4LCAxKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIGNhblNldFByb3RvdHlwZTogY2FuU2V0UHJvdG90eXBlLAoKCSAgICAgICAgZXh0ZW5kOiBleHRlbmQsCgoJICAgICAgICBzZXRQcm90b3R5cGVPZjogc2V0UHJvdG90eXBlT2YsCgoJICAgICAgICBzZXRQcm90b3R5cGVPZk9yRXh0ZW5kOiBjYW5TZXRQcm90b3R5cGUgPyBzZXRQcm90b3R5cGVPZiA6IGV4dGVuZCwKCgkgICAgICAgIG9iamVjdEZvckVhY2g6IG9iamVjdEZvckVhY2gsCgoJICAgICAgICBvYmplY3RNYXA6IGZ1bmN0aW9uKHNvdXJjZSwgbWFwcGluZykgewoJICAgICAgICAgICAgaWYgKCFzb3VyY2UpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHNvdXJjZTsKCSAgICAgICAgICAgIHZhciB0YXJnZXQgPSB7fTsKCSAgICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CgkgICAgICAgICAgICAgICAgaWYgKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewoJICAgICAgICAgICAgICAgICAgICB0YXJnZXRbcHJvcF0gPSBtYXBwaW5nKHNvdXJjZVtwcm9wXSwgcHJvcCwgc291cmNlKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdGFyZ2V0OwoJICAgICAgICB9LAoKCSAgICAgICAgZW1wdHlEb21Ob2RlOiBmdW5jdGlvbiAoZG9tTm9kZSkgewoJICAgICAgICAgICAgd2hpbGUgKGRvbU5vZGUuZmlyc3RDaGlsZCkgewoJICAgICAgICAgICAgICAgIGtvLnJlbW92ZU5vZGUoZG9tTm9kZS5maXJzdENoaWxkKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIG1vdmVDbGVhbmVkTm9kZXNUb0NvbnRhaW5lckVsZW1lbnQ6IGZ1bmN0aW9uKG5vZGVzKSB7CgkgICAgICAgICAgICAvLyBFbnN1cmUgaXQncyBhIHJlYWwgYXJyYXksIGFzIHdlJ3JlIGFib3V0IHRvIHJlcGFyZW50IHRoZSBub2RlcyBhbmQKCSAgICAgICAgICAgIC8vIHdlIGRvbid0IHdhbnQgdGhlIHVuZGVybHlpbmcgY29sbGVjdGlvbiB0byBjaGFuZ2Ugd2hpbGUgd2UncmUgZG9pbmcgdGhhdC4KCSAgICAgICAgICAgIHZhciBub2Rlc0FycmF5ID0ga28udXRpbHMubWFrZUFycmF5KG5vZGVzKTsKCgkgICAgICAgICAgICB2YXIgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzQXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB7CgkgICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGtvLmNsZWFuTm9kZShub2Rlc0FycmF5W2ldKSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyOwoJICAgICAgICB9LAoKCSAgICAgICAgY2xvbmVOb2RlczogZnVuY3Rpb24gKG5vZGVzQXJyYXksIHNob3VsZENsZWFuTm9kZXMpIHsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gbm9kZXNBcnJheS5sZW5ndGgsIG5ld05vZGVzQXJyYXkgPSBbXTsgaSA8IGo7IGkrKykgewoJICAgICAgICAgICAgICAgIHZhciBjbG9uZWROb2RlID0gbm9kZXNBcnJheVtpXS5jbG9uZU5vZGUodHJ1ZSk7CgkgICAgICAgICAgICAgICAgbmV3Tm9kZXNBcnJheS5wdXNoKHNob3VsZENsZWFuTm9kZXMgPyBrby5jbGVhbk5vZGUoY2xvbmVkTm9kZSkgOiBjbG9uZWROb2RlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBuZXdOb2Rlc0FycmF5OwoJICAgICAgICB9LAoKCSAgICAgICAgc2V0RG9tTm9kZUNoaWxkcmVuOiBmdW5jdGlvbiAoZG9tTm9kZSwgY2hpbGROb2RlcykgewoJICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKGRvbU5vZGUpOwoJICAgICAgICAgICAgaWYgKGNoaWxkTm9kZXMpIHsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgICAgICBkb21Ob2RlLmFwcGVuZENoaWxkKGNoaWxkTm9kZXNbaV0pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgcmVwbGFjZURvbU5vZGVzOiBmdW5jdGlvbiAobm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5LCBuZXdOb2Rlc0FycmF5KSB7CgkgICAgICAgICAgICB2YXIgbm9kZXNUb1JlcGxhY2VBcnJheSA9IG5vZGVUb1JlcGxhY2VPck5vZGVBcnJheS5ub2RlVHlwZSA/IFtub2RlVG9SZXBsYWNlT3JOb2RlQXJyYXldIDogbm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5OwoJICAgICAgICAgICAgaWYgKG5vZGVzVG9SZXBsYWNlQXJyYXkubGVuZ3RoID4gMCkgewoJICAgICAgICAgICAgICAgIHZhciBpbnNlcnRpb25Qb2ludCA9IG5vZGVzVG9SZXBsYWNlQXJyYXlbMF07CgkgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IGluc2VydGlvblBvaW50LnBhcmVudE5vZGU7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBuZXdOb2Rlc0FycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShuZXdOb2Rlc0FycmF5W2ldLCBpbnNlcnRpb25Qb2ludCk7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBub2Rlc1RvUmVwbGFjZUFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykgewoJICAgICAgICAgICAgICAgICAgICBrby5yZW1vdmVOb2RlKG5vZGVzVG9SZXBsYWNlQXJyYXlbaV0pOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIGZpeFVwQ29udGludW91c05vZGVBcnJheTogZnVuY3Rpb24oY29udGludW91c05vZGVBcnJheSwgcGFyZW50Tm9kZSkgewoJICAgICAgICAgICAgLy8gQmVmb3JlIGFjdGluZyBvbiBhIHNldCBvZiBub2RlcyB0aGF0IHdlcmUgcHJldmlvdXNseSBvdXRwdXR0ZWQgYnkgYSB0ZW1wbGF0ZSBmdW5jdGlvbiwgd2UgaGF2ZSB0byByZWNvbmNpbGUKCSAgICAgICAgICAgIC8vIHRoZW0gYWdhaW5zdCB3aGF0IGlzIGluIHRoZSBET00gcmlnaHQgbm93LiBJdCBtYXkgYmUgdGhhdCBzb21lIG9mIHRoZSBub2RlcyBoYXZlIGFscmVhZHkgYmVlbiByZW1vdmVkLCBvciB0aGF0CgkgICAgICAgICAgICAvLyBuZXcgbm9kZXMgbWlnaHQgaGF2ZSBiZWVuIGluc2VydGVkIGluIHRoZSBtaWRkbGUsIGZvciBleGFtcGxlIGJ5IGEgYmluZGluZy4gQWxzbywgdGhlcmUgbWF5IHByZXZpb3VzbHkgaGF2ZSBiZWVuCgkgICAgICAgICAgICAvLyBsZWFkaW5nIGNvbW1lbnQgbm9kZXMgKGNyZWF0ZWQgYnkgcmV3cml0dGVuIHN0cmluZy1iYXNlZCB0ZW1wbGF0ZXMpIHRoYXQgaGF2ZSBzaW5jZSBiZWVuIHJlbW92ZWQgZHVyaW5nIGJpbmRpbmcuCgkgICAgICAgICAgICAvLyBTbywgdGhpcyBmdW5jdGlvbiB0cmFuc2xhdGVzIHRoZSBvbGQgIm1hcCIgb3V0cHV0IGFycmF5IGludG8gaXRzIGJlc3QgZ3Vlc3Mgb2YgdGhlIHNldCBvZiBjdXJyZW50IERPTSBub2Rlcy4KCSAgICAgICAgICAgIC8vCgkgICAgICAgICAgICAvLyBSdWxlczoKCSAgICAgICAgICAgIC8vICAgW0FdIEFueSBsZWFkaW5nIG5vZGVzIHRoYXQgaGF2ZSBiZWVuIHJlbW92ZWQgc2hvdWxkIGJlIGlnbm9yZWQKCSAgICAgICAgICAgIC8vICAgICAgIFRoZXNlIG1vc3QgbGlrZWx5IGNvcnJlc3BvbmQgdG8gbWVtb2l6YXRpb24gbm9kZXMgdGhhdCB3ZXJlIGFscmVhZHkgcmVtb3ZlZCBkdXJpbmcgYmluZGluZwoJICAgICAgICAgICAgLy8gICAgICAgU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9wdWxsLzQ0MAoJICAgICAgICAgICAgLy8gICBbQl0gV2Ugd2FudCB0byBvdXRwdXQgYSBjb250aW51b3VzIHNlcmllcyBvZiBub2Rlcy4gU28sIGlnbm9yZSBhbnkgbm9kZXMgdGhhdCBoYXZlIGFscmVhZHkgYmVlbiByZW1vdmVkLAoJICAgICAgICAgICAgLy8gICAgICAgYW5kIGluY2x1ZGUgYW55IG5vZGVzIHRoYXQgaGF2ZSBiZWVuIGluc2VydGVkIGFtb25nIHRoZSBwcmV2aW91cyBjb2xsZWN0aW9uCgoJICAgICAgICAgICAgaWYgKGNvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgLy8gVGhlIHBhcmVudCBub2RlIGNhbiBiZSBhIHZpcnR1YWwgZWxlbWVudDsgc28gZ2V0IHRoZSByZWFsIHBhcmVudCBub2RlCgkgICAgICAgICAgICAgICAgcGFyZW50Tm9kZSA9IChwYXJlbnROb2RlLm5vZGVUeXBlID09PSA4ICYmIHBhcmVudE5vZGUucGFyZW50Tm9kZSkgfHwgcGFyZW50Tm9kZTsKCgkgICAgICAgICAgICAgICAgLy8gUnVsZSBbQV0KCSAgICAgICAgICAgICAgICB3aGlsZSAoY29udGludW91c05vZGVBcnJheS5sZW5ndGggJiYgY29udGludW91c05vZGVBcnJheVswXS5wYXJlbnROb2RlICE9PSBwYXJlbnROb2RlKQoJICAgICAgICAgICAgICAgICAgICBjb250aW51b3VzTm9kZUFycmF5LnNoaWZ0KCk7CgoJICAgICAgICAgICAgICAgIC8vIFJ1bGUgW0JdCgkgICAgICAgICAgICAgICAgaWYgKGNvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoID4gMSkgewoJICAgICAgICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IGNvbnRpbnVvdXNOb2RlQXJyYXlbMF0sIGxhc3QgPSBjb250aW51b3VzTm9kZUFycmF5W2NvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoIC0gMV07CgkgICAgICAgICAgICAgICAgICAgIC8vIFJlcGxhY2Ugd2l0aCB0aGUgYWN0dWFsIG5ldyBjb250aW51b3VzIG5vZGUgc2V0CgkgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoID0gMDsKCSAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgIT09IGxhc3QpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVvdXNOb2RlQXJyYXkucHVzaChjdXJyZW50KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50Lm5leHRTaWJsaW5nOwoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjdXJyZW50KSAvLyBXb24ndCBoYXBwZW4sIGV4Y2VwdCBpZiB0aGUgZGV2ZWxvcGVyIGhhcyBtYW51YWxseSByZW1vdmVkIHNvbWUgRE9NIGVsZW1lbnRzICh0aGVuIHdlJ3JlIGluIGFuIHVuZGVmaW5lZCBzY2VuYXJpbykKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgY29udGludW91c05vZGVBcnJheS5wdXNoKGxhc3QpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBjb250aW51b3VzTm9kZUFycmF5OwoJICAgICAgICB9LAoKCSAgICAgICAgc2V0T3B0aW9uTm9kZVNlbGVjdGlvblN0YXRlOiBmdW5jdGlvbiAob3B0aW9uTm9kZSwgaXNTZWxlY3RlZCkgewoJICAgICAgICAgICAgLy8gSUU2IHNvbWV0aW1lcyB0aHJvd3MgInVua25vd24gZXJyb3IiIGlmIHlvdSB0cnkgdG8gd3JpdGUgdG8gLnNlbGVjdGVkIGRpcmVjdGx5LCB3aGVyZWFzIEZpcmVmb3ggc3RydWdnbGVzIHdpdGggc2V0QXR0cmlidXRlLiBQaWNrIG9uZSBiYXNlZCBvbiBicm93c2VyLgoJICAgICAgICAgICAgaWYgKGllVmVyc2lvbiA8IDcpCgkgICAgICAgICAgICAgICAgb3B0aW9uTm9kZS5zZXRBdHRyaWJ1dGUoInNlbGVjdGVkIiwgaXNTZWxlY3RlZCk7CgkgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgb3B0aW9uTm9kZS5zZWxlY3RlZCA9IGlzU2VsZWN0ZWQ7CgkgICAgICAgIH0sCgoJICAgICAgICBzdHJpbmdUcmltOiBmdW5jdGlvbiAoc3RyaW5nKSB7CgkgICAgICAgICAgICByZXR1cm4gc3RyaW5nID09PSBudWxsIHx8IHN0cmluZyA9PT0gdW5kZWZpbmVkID8gJycgOgoJICAgICAgICAgICAgICAgIHN0cmluZy50cmltID8KCSAgICAgICAgICAgICAgICAgICAgc3RyaW5nLnRyaW0oKSA6CgkgICAgICAgICAgICAgICAgICAgIHN0cmluZy50b1N0cmluZygpLnJlcGxhY2UoL15bXHNceGEwXSt8W1xzXHhhMF0rJC9nLCAnJyk7CgkgICAgICAgIH0sCgoJICAgICAgICBzdHJpbmdTdGFydHNXaXRoOiBmdW5jdGlvbiAoc3RyaW5nLCBzdGFydHNXaXRoKSB7CgkgICAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcgfHwgIiI7CgkgICAgICAgICAgICBpZiAoc3RhcnRzV2l0aC5sZW5ndGggPiBzdHJpbmcubGVuZ3RoKQoJICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCSAgICAgICAgICAgIHJldHVybiBzdHJpbmcuc3Vic3RyaW5nKDAsIHN0YXJ0c1dpdGgubGVuZ3RoKSA9PT0gc3RhcnRzV2l0aDsKCSAgICAgICAgfSwKCgkgICAgICAgIGRvbU5vZGVJc0NvbnRhaW5lZEJ5OiBmdW5jdGlvbiAobm9kZSwgY29udGFpbmVkQnlOb2RlKSB7CgkgICAgICAgICAgICBpZiAobm9kZSA9PT0gY29udGFpbmVkQnlOb2RlKQoJICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwoJICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDExKQoJICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gRml4ZXMgaXNzdWUgIzExNjIgLSBjYW4ndCB1c2Ugbm9kZS5jb250YWlucyBmb3IgZG9jdW1lbnQgZnJhZ21lbnRzIG9uIElFOAoJICAgICAgICAgICAgaWYgKGNvbnRhaW5lZEJ5Tm9kZS5jb250YWlucykKCSAgICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVkQnlOb2RlLmNvbnRhaW5zKG5vZGUubm9kZVR5cGUgPT09IDMgPyBub2RlLnBhcmVudE5vZGUgOiBub2RlKTsKCSAgICAgICAgICAgIGlmIChjb250YWluZWRCeU5vZGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24pCgkgICAgICAgICAgICAgICAgcmV0dXJuIChjb250YWluZWRCeU5vZGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24obm9kZSkgJiAxNikgPT0gMTY7CgkgICAgICAgICAgICB3aGlsZSAobm9kZSAmJiBub2RlICE9IGNvbnRhaW5lZEJ5Tm9kZSkgewoJICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gISFub2RlOwoJICAgICAgICB9LAoKCSAgICAgICAgZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50OiBmdW5jdGlvbiAobm9kZSkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbU5vZGVJc0NvbnRhaW5lZEJ5KG5vZGUsIG5vZGUub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpOwoJICAgICAgICB9LAoKCSAgICAgICAgYW55RG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50OiBmdW5jdGlvbihub2RlcykgewoJICAgICAgICAgICAgcmV0dXJuICEha28udXRpbHMuYXJyYXlGaXJzdChub2Rlcywga28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KTsKCSAgICAgICAgfSwKCgkgICAgICAgIHRhZ05hbWVMb3dlcjogZnVuY3Rpb24oZWxlbWVudCkgewoJICAgICAgICAgICAgLy8gRm9yIEhUTUwgZWxlbWVudHMsIHRhZ05hbWUgd2lsbCBhbHdheXMgYmUgdXBwZXIgY2FzZTsgZm9yIFhIVE1MIGVsZW1lbnRzLCBpdCdsbCBiZSBsb3dlciBjYXNlLgoJICAgICAgICAgICAgLy8gUG9zc2libGUgZnV0dXJlIG9wdGltaXphdGlvbjogSWYgd2Uga25vdyBpdCdzIGFuIGVsZW1lbnQgZnJvbSBhbiBYSFRNTCBkb2N1bWVudCAobm90IEhUTUwpLAoJICAgICAgICAgICAgLy8gd2UgZG9uJ3QgbmVlZCB0byBkbyB0aGUgLnRvTG93ZXJDYXNlKCkgYXMgaXQgd2lsbCBhbHdheXMgYmUgbG93ZXIgY2FzZSBhbnl3YXkuCgkgICAgICAgICAgICByZXR1cm4gZWxlbWVudCAmJiBlbGVtZW50LnRhZ05hbWUgJiYgZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CgkgICAgICAgIH0sCgoJICAgICAgICByZWdpc3RlckV2ZW50SGFuZGxlcjogZnVuY3Rpb24gKGVsZW1lbnQsIGV2ZW50VHlwZSwgaGFuZGxlcikgewoJICAgICAgICAgICAgdmFyIG11c3RVc2VBdHRhY2hFdmVudCA9IGllVmVyc2lvbiAmJiBldmVudHNUaGF0TXVzdEJlUmVnaXN0ZXJlZFVzaW5nQXR0YWNoRXZlbnRbZXZlbnRUeXBlXTsKCSAgICAgICAgICAgIGlmICghbXVzdFVzZUF0dGFjaEV2ZW50ICYmIGpRdWVyeUluc3RhbmNlKSB7CgkgICAgICAgICAgICAgICAgalF1ZXJ5SW5zdGFuY2UoZWxlbWVudClbJ2JpbmQnXShldmVudFR5cGUsIGhhbmRsZXIpOwoJICAgICAgICAgICAgfSBlbHNlIGlmICghbXVzdFVzZUF0dGFjaEV2ZW50ICYmIHR5cGVvZiBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIgPT0gImZ1bmN0aW9uIikKCSAgICAgICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBoYW5kbGVyLCBmYWxzZSk7CgkgICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgZWxlbWVudC5hdHRhY2hFdmVudCAhPSAidW5kZWZpbmVkIikgewoJICAgICAgICAgICAgICAgIHZhciBhdHRhY2hFdmVudEhhbmRsZXIgPSBmdW5jdGlvbiAoZXZlbnQpIHsgaGFuZGxlci5jYWxsKGVsZW1lbnQsIGV2ZW50KTsgfSwKCSAgICAgICAgICAgICAgICAgICAgYXR0YWNoRXZlbnROYW1lID0gIm9uIiArIGV2ZW50VHlwZTsKCSAgICAgICAgICAgICAgICBlbGVtZW50LmF0dGFjaEV2ZW50KGF0dGFjaEV2ZW50TmFtZSwgYXR0YWNoRXZlbnRIYW5kbGVyKTsKCgkgICAgICAgICAgICAgICAgLy8gSUUgZG9lcyBub3QgZGlzcG9zZSBhdHRhY2hFdmVudCBoYW5kbGVycyBhdXRvbWF0aWNhbGx5ICh1bmxpa2Ugd2l0aCBhZGRFdmVudExpc3RlbmVyKQoJICAgICAgICAgICAgICAgIC8vIHNvIHRvIGF2b2lkIGxlYWtzLCB3ZSBoYXZlIHRvIHJlbW92ZSB0aGVtIG1hbnVhbGx5LiBTZWUgYnVnICM4NTYKCSAgICAgICAgICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKGVsZW1lbnQsIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmRldGFjaEV2ZW50KGF0dGFjaEV2ZW50TmFtZSwgYXR0YWNoRXZlbnRIYW5kbGVyKTsKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0gZWxzZQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgYWRkRXZlbnRMaXN0ZW5lciBvciBhdHRhY2hFdmVudCIpOwoJICAgICAgICB9LAoKCSAgICAgICAgdHJpZ2dlckV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnRUeXBlKSB7CgkgICAgICAgICAgICBpZiAoIShlbGVtZW50ICYmIGVsZW1lbnQubm9kZVR5cGUpKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZWxlbWVudCBtdXN0IGJlIGEgRE9NIG5vZGUgd2hlbiBjYWxsaW5nIHRyaWdnZXJFdmVudCIpOwoKCSAgICAgICAgICAgIC8vIEZvciBjbGljayBldmVudHMgb24gY2hlY2tib3hlcyBhbmQgcmFkaW8gYnV0dG9ucywgalF1ZXJ5IHRvZ2dsZXMgdGhlIGVsZW1lbnQgY2hlY2tlZCBzdGF0ZSAqYWZ0ZXIqIHRoZQoJICAgICAgICAgICAgLy8gZXZlbnQgaGFuZGxlciBydW5zIGluc3RlYWQgb2YgKmJlZm9yZSouIChUaGlzIHdhcyBmaXhlZCBpbiAxLjkgZm9yIGNoZWNrYm94ZXMgYnV0IG5vdCBmb3IgcmFkaW8gYnV0dG9ucy4pCgkgICAgICAgICAgICAvLyBJRSBkb2Vzbid0IGNoYW5nZSB0aGUgY2hlY2tlZCBzdGF0ZSB3aGVuIHlvdSB0cmlnZ2VyIHRoZSBjbGljayBldmVudCB1c2luZyAiZmlyZUV2ZW50Ii4KCSAgICAgICAgICAgIC8vIEluIGJvdGggY2FzZXMsIHdlJ2xsIHVzZSB0aGUgY2xpY2sgbWV0aG9kIGluc3RlYWQuCgkgICAgICAgICAgICB2YXIgdXNlQ2xpY2tXb3JrYXJvdW5kID0gaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpOwoKCSAgICAgICAgICAgIGlmIChqUXVlcnlJbnN0YW5jZSAmJiAhdXNlQ2xpY2tXb3JrYXJvdW5kKSB7CgkgICAgICAgICAgICAgICAgalF1ZXJ5SW5zdGFuY2UoZWxlbWVudClbJ3RyaWdnZXInXShldmVudFR5cGUpOwoJICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZG9jdW1lbnQuY3JlYXRlRXZlbnQgPT0gImZ1bmN0aW9uIikgewoJICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZWxlbWVudC5kaXNwYXRjaEV2ZW50ID09ICJmdW5jdGlvbiIpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50Q2F0ZWdvcnkgPSBrbm93bkV2ZW50VHlwZXNCeUV2ZW50TmFtZVtldmVudFR5cGVdIHx8ICJIVE1MRXZlbnRzIjsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoZXZlbnRDYXRlZ29yeSk7CgkgICAgICAgICAgICAgICAgICAgIGV2ZW50LmluaXRFdmVudChldmVudFR5cGUsIHRydWUsIHRydWUsIHdpbmRvdywgMCwgMCwgMCwgMCwgMCwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDAsIGVsZW1lbnQpOwoJICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIHN1cHBsaWVkIGVsZW1lbnQgZG9lc24ndCBzdXBwb3J0IGRpc3BhdGNoRXZlbnQiKTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAodXNlQ2xpY2tXb3JrYXJvdW5kICYmIGVsZW1lbnQuY2xpY2spIHsKCSAgICAgICAgICAgICAgICBlbGVtZW50LmNsaWNrKCk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbGVtZW50LmZpcmVFdmVudCAhPSAidW5kZWZpbmVkIikgewoJICAgICAgICAgICAgICAgIGVsZW1lbnQuZmlyZUV2ZW50KCJvbiIgKyBldmVudFR5cGUpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IHRyaWdnZXJpbmcgZXZlbnRzIik7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICB1bndyYXBPYnNlcnZhYmxlOiBmdW5jdGlvbiAodmFsdWUpIHsKCSAgICAgICAgICAgIHJldHVybiBrby5pc09ic2VydmFibGUodmFsdWUpID8gdmFsdWUoKSA6IHZhbHVlOwoJICAgICAgICB9LAoKCSAgICAgICAgcGVla09ic2VydmFibGU6IGZ1bmN0aW9uICh2YWx1ZSkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLmlzT2JzZXJ2YWJsZSh2YWx1ZSkgPyB2YWx1ZS5wZWVrKCkgOiB2YWx1ZTsKCSAgICAgICAgfSwKCgkgICAgICAgIHRvZ2dsZURvbU5vZGVDc3NDbGFzczogZnVuY3Rpb24gKG5vZGUsIGNsYXNzTmFtZXMsIHNob3VsZEhhdmVDbGFzcykgewoJICAgICAgICAgICAgaWYgKGNsYXNzTmFtZXMpIHsKCSAgICAgICAgICAgICAgICB2YXIgY3NzQ2xhc3NOYW1lUmVnZXggPSAvXFMrL2csCgkgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDbGFzc05hbWVzID0gbm9kZS5jbGFzc05hbWUubWF0Y2goY3NzQ2xhc3NOYW1lUmVnZXgpIHx8IFtdOwoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChjbGFzc05hbWVzLm1hdGNoKGNzc0NsYXNzTmFtZVJlZ2V4KSwgZnVuY3Rpb24oY2xhc3NOYW1lKSB7CgkgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFkZE9yUmVtb3ZlSXRlbShjdXJyZW50Q2xhc3NOYW1lcywgY2xhc3NOYW1lLCBzaG91bGRIYXZlQ2xhc3MpOwoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICAgIG5vZGUuY2xhc3NOYW1lID0gY3VycmVudENsYXNzTmFtZXMuam9pbigiICIpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgc2V0VGV4dENvbnRlbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHRleHRDb250ZW50KSB7CgkgICAgICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHRleHRDb250ZW50KTsKCSAgICAgICAgICAgIGlmICgodmFsdWUgPT09IG51bGwpIHx8ICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSkKCSAgICAgICAgICAgICAgICB2YWx1ZSA9ICIiOwoKCSAgICAgICAgICAgIC8vIFdlIG5lZWQgdGhlcmUgdG8gYmUgZXhhY3RseSBvbmUgY2hpbGQ6IGEgdGV4dCBub2RlLgoJICAgICAgICAgICAgLy8gSWYgdGhlcmUgYXJlIG5vIGNoaWxkcmVuLCBtb3JlIHRoYW4gb25lLCBvciBpZiBpdCdzIG5vdCBhIHRleHQgbm9kZSwKCSAgICAgICAgICAgIC8vIHdlJ2xsIGNsZWFyIGV2ZXJ5dGhpbmcgYW5kIGNyZWF0ZSBhIHNpbmdsZSB0ZXh0IG5vZGUuCgkgICAgICAgICAgICB2YXIgaW5uZXJUZXh0Tm9kZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5maXJzdENoaWxkKGVsZW1lbnQpOwoJICAgICAgICAgICAgaWYgKCFpbm5lclRleHROb2RlIHx8IGlubmVyVGV4dE5vZGUubm9kZVR5cGUgIT0gMyB8fCBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcoaW5uZXJUZXh0Tm9kZSkpIHsKCSAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuKGVsZW1lbnQsIFtlbGVtZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWUpXSk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIGlubmVyVGV4dE5vZGUuZGF0YSA9IHZhbHVlOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIGtvLnV0aWxzLmZvcmNlUmVmcmVzaChlbGVtZW50KTsKCSAgICAgICAgfSwKCgkgICAgICAgIHNldEVsZW1lbnROYW1lOiBmdW5jdGlvbihlbGVtZW50LCBuYW1lKSB7CgkgICAgICAgICAgICBlbGVtZW50Lm5hbWUgPSBuYW1lOwoKCSAgICAgICAgICAgIC8vIFdvcmthcm91bmQgSUUgNi83IGlzc3VlCgkgICAgICAgICAgICAvLyAtIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTk3CgkgICAgICAgICAgICAvLyAtIGh0dHA6Ly93d3cubWF0dHM0MTEuY29tL3Bvc3Qvc2V0dGluZ190aGVfbmFtZV9hdHRyaWJ1dGVfaW5faWVfZG9tLwoJICAgICAgICAgICAgaWYgKGllVmVyc2lvbiA8PSA3KSB7CgkgICAgICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5tZXJnZUF0dHJpYnV0ZXMoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiPGlucHV0IG5hbWU9JyIgKyBlbGVtZW50Lm5hbWUgKyAiJy8+IiksIGZhbHNlKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgY2F0Y2goZSkge30gLy8gRm9yIElFOSB3aXRoIGRvYyBtb2RlICJJRTkgU3RhbmRhcmRzIiBhbmQgYnJvd3NlciBtb2RlICJJRTkgQ29tcGF0aWJpbGl0eSBWaWV3IgoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgZm9yY2VSZWZyZXNoOiBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBhbiBJRTkgcmVuZGVyaW5nIGJ1ZyAtIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMjA5CgkgICAgICAgICAgICBpZiAoaWVWZXJzaW9uID49IDkpIHsKCSAgICAgICAgICAgICAgICAvLyBGb3IgdGV4dCBub2RlcyBhbmQgY29tbWVudCBub2RlcyAobW9zdCBsaWtlbHkgdmlydHVhbCBlbGVtZW50cyksIHdlIHdpbGwgaGF2ZSB0byByZWZyZXNoIHRoZSBjb250YWluZXIKCSAgICAgICAgICAgICAgICB2YXIgZWxlbSA9IG5vZGUubm9kZVR5cGUgPT0gMSA/IG5vZGUgOiBub2RlLnBhcmVudE5vZGU7CgkgICAgICAgICAgICAgICAgaWYgKGVsZW0uc3R5bGUpCgkgICAgICAgICAgICAgICAgICAgIGVsZW0uc3R5bGUuem9vbSA9IGVsZW0uc3R5bGUuem9vbTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIGVuc3VyZVNlbGVjdEVsZW1lbnRJc1JlbmRlcmVkQ29ycmVjdGx5OiBmdW5jdGlvbihzZWxlY3RFbGVtZW50KSB7CgkgICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBJRTkgcmVuZGVyaW5nIGJ1ZyAtIGl0IGRvZXNuJ3QgcmVsaWFibHkgZGlzcGxheSBhbGwgdGhlIHRleHQgaW4gZHluYW1pY2FsbHktYWRkZWQgc2VsZWN0IGJveGVzIHVubGVzcyB5b3UgZm9yY2UgaXQgdG8gcmUtcmVuZGVyIGJ5IHVwZGF0aW5nIHRoZSB3aWR0aC4KCSAgICAgICAgICAgIC8vIChTZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8zMTIsIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNTkwODQ5NC9zZWxlY3Qtb25seS1zaG93cy1maXJzdC1jaGFyLW9mLXNlbGVjdGVkLW9wdGlvbikKCSAgICAgICAgICAgIC8vIEFsc28gZml4ZXMgSUU3IGFuZCBJRTggYnVnIHRoYXQgY2F1c2VzIHNlbGVjdHMgdG8gYmUgemVybyB3aWR0aCBpZiBlbmNsb3NlZCBieSAnaWYnIG9yICd3aXRoJy4gKFNlZSBpc3N1ZSAjODM5KQoJICAgICAgICAgICAgaWYgKGllVmVyc2lvbikgewoJICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbFdpZHRoID0gc2VsZWN0RWxlbWVudC5zdHlsZS53aWR0aDsKCSAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnN0eWxlLndpZHRoID0gMDsKCSAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnN0eWxlLndpZHRoID0gb3JpZ2luYWxXaWR0aDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIHJhbmdlOiBmdW5jdGlvbiAobWluLCBtYXgpIHsKCSAgICAgICAgICAgIG1pbiA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobWluKTsKCSAgICAgICAgICAgIG1heCA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobWF4KTsKCSAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSBtaW47IGkgPD0gbWF4OyBpKyspCgkgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goaSk7CgkgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgICAgICB9LAoKCSAgICAgICAgbWFrZUFycmF5OiBmdW5jdGlvbihhcnJheUxpa2VPYmplY3QpIHsKCSAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXlMaWtlT2JqZWN0Lmxlbmd0aDsgaSA8IGo7IGkrKykgewoJICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5TGlrZU9iamVjdFtpXSk7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICAgICAgfSwKCgkgICAgICAgIGlzSWU2IDogaXNJZTYsCgkgICAgICAgIGlzSWU3IDogaXNJZTcsCgkgICAgICAgIGllVmVyc2lvbiA6IGllVmVyc2lvbiwKCgkgICAgICAgIGdldEZvcm1GaWVsZHM6IGZ1bmN0aW9uKGZvcm0sIGZpZWxkTmFtZSkgewoJICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtvLnV0aWxzLm1ha2VBcnJheShmb3JtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpbnB1dCIpKS5jb25jYXQoa28udXRpbHMubWFrZUFycmF5KGZvcm0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRleHRhcmVhIikpKTsKCSAgICAgICAgICAgIHZhciBpc01hdGNoaW5nRmllbGQgPSAodHlwZW9mIGZpZWxkTmFtZSA9PSAnc3RyaW5nJykKCSAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uKGZpZWxkKSB7IHJldHVybiBmaWVsZC5uYW1lID09PSBmaWVsZE5hbWUgfQoJICAgICAgICAgICAgICAgIDogZnVuY3Rpb24oZmllbGQpIHsgcmV0dXJuIGZpZWxkTmFtZS50ZXN0KGZpZWxkLm5hbWUpIH07IC8vIFRyZWF0IGZpZWxkTmFtZSBhcyByZWdleCBvciBvYmplY3QgY29udGFpbmluZyBwcmVkaWNhdGUKCSAgICAgICAgICAgIHZhciBtYXRjaGVzID0gW107CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gZmllbGRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkgICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdGaWVsZChmaWVsZHNbaV0pKQoJICAgICAgICAgICAgICAgICAgICBtYXRjaGVzLnB1c2goZmllbGRzW2ldKTsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICByZXR1cm4gbWF0Y2hlczsKCSAgICAgICAgfSwKCgkgICAgICAgIHBhcnNlSnNvbjogZnVuY3Rpb24gKGpzb25TdHJpbmcpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YganNvblN0cmluZyA9PSAic3RyaW5nIikgewoJICAgICAgICAgICAgICAgIGpzb25TdHJpbmcgPSBrby51dGlscy5zdHJpbmdUcmltKGpzb25TdHJpbmcpOwoJICAgICAgICAgICAgICAgIGlmIChqc29uU3RyaW5nKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChKU09OICYmIEpTT04ucGFyc2UpIC8vIFVzZSBuYXRpdmUgcGFyc2luZyB3aGVyZSBhdmFpbGFibGUKCSAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKGpzb25TdHJpbmcpOwoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gKG5ldyBGdW5jdGlvbigicmV0dXJuICIgKyBqc29uU3RyaW5nKSkoKTsgLy8gRmFsbGJhY2sgb24gbGVzcyBzYWZlIHBhcnNpbmcgZm9yIG9sZGVyIGJyb3dzZXJzCgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgICAgIH0sCgoJICAgICAgICBzdHJpbmdpZnlKc29uOiBmdW5jdGlvbiAoZGF0YSwgcmVwbGFjZXIsIHNwYWNlKSB7ICAgLy8gcmVwbGFjZXIgYW5kIHNwYWNlIGFyZSBvcHRpb25hbAoJICAgICAgICAgICAgaWYgKCFKU09OIHx8ICFKU09OLnN0cmluZ2lmeSkKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmaW5kIEpTT04uc3RyaW5naWZ5KCkuIFNvbWUgYnJvd3NlcnMgKGUuZy4sIElFIDwgOCkgZG9uJ3Qgc3VwcG9ydCBpdCBuYXRpdmVseSwgYnV0IHlvdSBjYW4gb3ZlcmNvbWUgdGhpcyBieSBhZGRpbmcgYSBzY3JpcHQgcmVmZXJlbmNlIHRvIGpzb24yLmpzLCBkb3dubG9hZGFibGUgZnJvbSBodHRwOi8vd3d3Lmpzb24ub3JnL2pzb24yLmpzIik7CgkgICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhKSwgcmVwbGFjZXIsIHNwYWNlKTsKCSAgICAgICAgfSwKCgkgICAgICAgIHBvc3RKc29uOiBmdW5jdGlvbiAodXJsT3JGb3JtLCBkYXRhLCBvcHRpb25zKSB7CgkgICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgICAgICAgICAgIHZhciBwYXJhbXMgPSBvcHRpb25zWydwYXJhbXMnXSB8fCB7fTsKCSAgICAgICAgICAgIHZhciBpbmNsdWRlRmllbGRzID0gb3B0aW9uc1snaW5jbHVkZUZpZWxkcyddIHx8IHRoaXMuZmllbGRzSW5jbHVkZWRXaXRoSnNvblBvc3Q7CgkgICAgICAgICAgICB2YXIgdXJsID0gdXJsT3JGb3JtOwoKCSAgICAgICAgICAgIC8vIElmIHdlIHdlcmUgZ2l2ZW4gYSBmb3JtLCB1c2UgaXRzICdhY3Rpb24nIFVSTCBhbmQgcGljayBvdXQgYW55IHJlcXVlc3RlZCBmaWVsZCB2YWx1ZXMKCSAgICAgICAgICAgIGlmKCh0eXBlb2YgdXJsT3JGb3JtID09ICdvYmplY3QnKSAmJiAoa28udXRpbHMudGFnTmFtZUxvd2VyKHVybE9yRm9ybSkgPT09ICJmb3JtIikpIHsKCSAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxGb3JtID0gdXJsT3JGb3JtOwoJICAgICAgICAgICAgICAgIHVybCA9IG9yaWdpbmFsRm9ybS5hY3Rpb247CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IGluY2x1ZGVGaWVsZHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtvLnV0aWxzLmdldEZvcm1GaWVsZHMob3JpZ2luYWxGb3JtLCBpbmNsdWRlRmllbGRzW2ldKTsKCSAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IGZpZWxkcy5sZW5ndGggLSAxOyBqID49IDA7IGotLSkKCSAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtc1tmaWVsZHNbal0ubmFtZV0gPSBmaWVsZHNbal0udmFsdWU7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIGRhdGEgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGEpOwoJICAgICAgICAgICAgdmFyIGZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmb3JtIik7CgkgICAgICAgICAgICBmb3JtLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgkgICAgICAgICAgICBmb3JtLmFjdGlvbiA9IHVybDsKCSAgICAgICAgICAgIGZvcm0ubWV0aG9kID0gInBvc3QiOwoJICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIHsKCSAgICAgICAgICAgICAgICAvLyBTaW5jZSAnZGF0YScgdGhpcyBpcyBhIG1vZGVsIG9iamVjdCwgd2UgaW5jbHVkZSBhbGwgcHJvcGVydGllcyBpbmNsdWRpbmcgdGhvc2UgaW5oZXJpdGVkIGZyb20gaXRzIHByb3RvdHlwZQoJICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CgkgICAgICAgICAgICAgICAgaW5wdXQudHlwZSA9ICJoaWRkZW4iOwoJICAgICAgICAgICAgICAgIGlucHV0Lm5hbWUgPSBrZXk7CgkgICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBrby51dGlscy5zdHJpbmdpZnlKc29uKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoZGF0YVtrZXldKSk7CgkgICAgICAgICAgICAgICAgZm9ybS5hcHBlbmRDaGlsZChpbnB1dCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBvYmplY3RGb3JFYWNoKHBhcmFtcywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewoJICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CgkgICAgICAgICAgICAgICAgaW5wdXQudHlwZSA9ICJoaWRkZW4iOwoJICAgICAgICAgICAgICAgIGlucHV0Lm5hbWUgPSBrZXk7CgkgICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSB2YWx1ZTsKCSAgICAgICAgICAgICAgICBmb3JtLmFwcGVuZENoaWxkKGlucHV0KTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmb3JtKTsKCSAgICAgICAgICAgIG9wdGlvbnNbJ3N1Ym1pdHRlciddID8gb3B0aW9uc1snc3VibWl0dGVyJ10oZm9ybSkgOiBmb3JtLnN1Ym1pdCgpOwoJICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IGZvcm0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChmb3JtKTsgfSwgMCk7CgkgICAgICAgIH0KCSAgICB9Cgl9KCkpOwoKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMnLCBrby51dGlscyk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5Rm9yRWFjaCcsIGtvLnV0aWxzLmFycmF5Rm9yRWFjaCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5Rmlyc3QnLCBrby51dGlscy5hcnJheUZpcnN0KTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlGaWx0ZXInLCBrby51dGlscy5hcnJheUZpbHRlcik7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5R2V0RGlzdGluY3RWYWx1ZXMnLCBrby51dGlscy5hcnJheUdldERpc3RpbmN0VmFsdWVzKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlJbmRleE9mJywga28udXRpbHMuYXJyYXlJbmRleE9mKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlNYXAnLCBrby51dGlscy5hcnJheU1hcCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5UHVzaEFsbCcsIGtvLnV0aWxzLmFycmF5UHVzaEFsbCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5UmVtb3ZlSXRlbScsIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbSk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmV4dGVuZCcsIGtvLnV0aWxzLmV4dGVuZCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0Jywga28udXRpbHMuZmllbGRzSW5jbHVkZWRXaXRoSnNvblBvc3QpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5nZXRGb3JtRmllbGRzJywga28udXRpbHMuZ2V0Rm9ybUZpZWxkcyk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnBlZWtPYnNlcnZhYmxlJywga28udXRpbHMucGVla09ic2VydmFibGUpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wb3N0SnNvbicsIGtvLnV0aWxzLnBvc3RKc29uKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMucGFyc2VKc29uJywga28udXRpbHMucGFyc2VKc29uKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXInLCBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcik7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnN0cmluZ2lmeUpzb24nLCBrby51dGlscy5zdHJpbmdpZnlKc29uKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMucmFuZ2UnLCBrby51dGlscy5yYW5nZSk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcycsIGtvLnV0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcyk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnRyaWdnZXJFdmVudCcsIGtvLnV0aWxzLnRyaWdnZXJFdmVudCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnVud3JhcE9ic2VydmFibGUnLCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMub2JqZWN0Rm9yRWFjaCcsIGtvLnV0aWxzLm9iamVjdEZvckVhY2gpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hZGRPclJlbW92ZUl0ZW0nLCBrby51dGlscy5hZGRPclJlbW92ZUl0ZW0pOwoJa28uZXhwb3J0U3ltYm9sKCd1bndyYXAnLCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKTsgLy8gQ29udmVuaWVudCBzaG9ydGhhbmQsIGJlY2F1c2UgdGhpcyBpcyB1c2VkIHNvIGNvbW1vbmx5CgoJaWYgKCFGdW5jdGlvbi5wcm90b3R5cGVbJ2JpbmQnXSkgewoJICAgIC8vIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kIGlzIGEgc3RhbmRhcmQgcGFydCBvZiBFQ01BU2NyaXB0IDV0aCBFZGl0aW9uIChEZWNlbWJlciAyMDA5LCBodHRwOi8vd3d3LmVjbWEtaW50ZXJuYXRpb25hbC5vcmcvcHVibGljYXRpb25zL2ZpbGVzL0VDTUEtU1QvRUNNQS0yNjIucGRmKQoJICAgIC8vIEluIGNhc2UgdGhlIGJyb3dzZXIgZG9lc24ndCBpbXBsZW1lbnQgaXQgbmF0aXZlbHksIHByb3ZpZGUgYSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uLiBUaGlzIGltcGxlbWVudGF0aW9uIGlzIGJhc2VkIG9uIHRoZSBvbmUgaW4gcHJvdG90eXBlLmpzCgkgICAgRnVuY3Rpb24ucHJvdG90eXBlWydiaW5kJ10gPSBmdW5jdGlvbiAob2JqZWN0KSB7CgkgICAgICAgIHZhciBvcmlnaW5hbEZ1bmN0aW9uID0gdGhpcywgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyksIG9iamVjdCA9IGFyZ3Muc2hpZnQoKTsKCSAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbEZ1bmN0aW9uLmFwcGx5KG9iamVjdCwgYXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwoJICAgICAgICB9OwoJICAgIH07Cgl9CgoJa28udXRpbHMuZG9tRGF0YSA9IG5ldyAoZnVuY3Rpb24gKCkgewoJICAgIHZhciB1bmlxdWVJZCA9IDA7CgkgICAgdmFyIGRhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWUgPSAiX19rb19fIiArIChuZXcgRGF0ZSkuZ2V0VGltZSgpOwoJICAgIHZhciBkYXRhU3RvcmUgPSB7fTsKCgkgICAgZnVuY3Rpb24gZ2V0QWxsKG5vZGUsIGNyZWF0ZUlmTm90Rm91bmQpIHsKCSAgICAgICAgdmFyIGRhdGFTdG9yZUtleSA9IG5vZGVbZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZV07CgkgICAgICAgIHZhciBoYXNFeGlzdGluZ0RhdGFTdG9yZSA9IGRhdGFTdG9yZUtleSAmJiAoZGF0YVN0b3JlS2V5ICE9PSAibnVsbCIpICYmIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldOwoJICAgICAgICBpZiAoIWhhc0V4aXN0aW5nRGF0YVN0b3JlKSB7CgkgICAgICAgICAgICBpZiAoIWNyZWF0ZUlmTm90Rm91bmQpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKCSAgICAgICAgICAgIGRhdGFTdG9yZUtleSA9IG5vZGVbZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZV0gPSAia28iICsgdW5pcXVlSWQrKzsKCSAgICAgICAgICAgIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldID0ge307CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldOwoJICAgIH0KCgkgICAgcmV0dXJuIHsKCSAgICAgICAgZ2V0OiBmdW5jdGlvbiAobm9kZSwga2V5KSB7CgkgICAgICAgICAgICB2YXIgYWxsRGF0YUZvck5vZGUgPSBnZXRBbGwobm9kZSwgZmFsc2UpOwoJICAgICAgICAgICAgcmV0dXJuIGFsbERhdGFGb3JOb2RlID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBhbGxEYXRhRm9yTm9kZVtrZXldOwoJICAgICAgICB9LAoJICAgICAgICBzZXQ6IGZ1bmN0aW9uIChub2RlLCBrZXksIHZhbHVlKSB7CgkgICAgICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBkb24ndCBhY3R1YWxseSBjcmVhdGUgYSBuZXcgZG9tRGF0YSBrZXkgaWYgd2UgYXJlIGFjdHVhbGx5IGRlbGV0aW5nIGEgdmFsdWUKCSAgICAgICAgICAgICAgICBpZiAoZ2V0QWxsKG5vZGUsIGZhbHNlKSA9PT0gdW5kZWZpbmVkKQoJICAgICAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICB2YXIgYWxsRGF0YUZvck5vZGUgPSBnZXRBbGwobm9kZSwgdHJ1ZSk7CgkgICAgICAgICAgICBhbGxEYXRhRm9yTm9kZVtrZXldID0gdmFsdWU7CgkgICAgICAgIH0sCgkgICAgICAgIGNsZWFyOiBmdW5jdGlvbiAobm9kZSkgewoJICAgICAgICAgICAgdmFyIGRhdGFTdG9yZUtleSA9IG5vZGVbZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZV07CgkgICAgICAgICAgICBpZiAoZGF0YVN0b3JlS2V5KSB7CgkgICAgICAgICAgICAgICAgZGVsZXRlIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldOwoJICAgICAgICAgICAgICAgIG5vZGVbZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZV0gPSBudWxsOwoJICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBFeHBvc2luZyAiZGlkIGNsZWFuIiBmbGFnIHB1cmVseSBzbyBzcGVjcyBjYW4gaW5mZXIgd2hldGhlciB0aGluZ3MgaGF2ZSBiZWVuIGNsZWFuZWQgdXAgYXMgaW50ZW5kZWQKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCSAgICAgICAgfSwKCgkgICAgICAgIG5leHRLZXk6IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgIHJldHVybiAodW5pcXVlSWQrKykgKyBkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lOwoJICAgICAgICB9CgkgICAgfTsKCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21EYXRhJywga28udXRpbHMuZG9tRGF0YSk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbURhdGEuY2xlYXInLCBrby51dGlscy5kb21EYXRhLmNsZWFyKTsgLy8gRXhwb3J0aW5nIG9ubHkgc28gc3BlY3MgY2FuIGNsZWFyIHVwIGFmdGVyIHRoZW1zZWx2ZXMgZnVsbHkKCglrby51dGlscy5kb21Ob2RlRGlzcG9zYWwgPSBuZXcgKGZ1bmN0aW9uICgpIHsKCSAgICB2YXIgZG9tRGF0YUtleSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpOwoJICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXMgPSB7IDE6IHRydWUsIDg6IHRydWUsIDk6IHRydWUgfTsgICAgICAgLy8gRWxlbWVudCwgQ29tbWVudCwgRG9jdW1lbnQKCSAgICB2YXIgY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzID0geyAxOiB0cnVlLCA5OiB0cnVlIH07IC8vIEVsZW1lbnQsIERvY3VtZW50CgoJICAgIGZ1bmN0aW9uIGdldERpc3Bvc2VDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUsIGNyZWF0ZUlmTm90Rm91bmQpIHsKCSAgICAgICAgdmFyIGFsbERpc3Bvc2VDYWxsYmFja3MgPSBrby51dGlscy5kb21EYXRhLmdldChub2RlLCBkb21EYXRhS2V5KTsKCSAgICAgICAgaWYgKChhbGxEaXNwb3NlQ2FsbGJhY2tzID09PSB1bmRlZmluZWQpICYmIGNyZWF0ZUlmTm90Rm91bmQpIHsKCSAgICAgICAgICAgIGFsbERpc3Bvc2VDYWxsYmFja3MgPSBbXTsKCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIGRvbURhdGFLZXksIGFsbERpc3Bvc2VDYWxsYmFja3MpOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiBhbGxEaXNwb3NlQ2FsbGJhY2tzOwoJICAgIH0KCSAgICBmdW5jdGlvbiBkZXN0cm95Q2FsbGJhY2tzQ29sbGVjdGlvbihub2RlKSB7CgkgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIGRvbURhdGFLZXksIHVuZGVmaW5lZCk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBjbGVhblNpbmdsZU5vZGUobm9kZSkgewoJICAgICAgICAvLyBSdW4gYWxsIHRoZSBkaXNwb3NlIGNhbGxiYWNrcwoJICAgICAgICB2YXIgY2FsbGJhY2tzID0gZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgZmFsc2UpOwoJICAgICAgICBpZiAoY2FsbGJhY2tzKSB7CgkgICAgICAgICAgICBjYWxsYmFja3MgPSBjYWxsYmFja3Muc2xpY2UoMCk7IC8vIENsb25lLCBhcyB0aGUgYXJyYXkgbWF5IGJlIG1vZGlmaWVkIGR1cmluZyBpdGVyYXRpb24gKHR5cGljYWxseSwgY2FsbGJhY2tzIHdpbGwgcmVtb3ZlIHRoZW1zZWx2ZXMpCgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhbGxiYWNrcy5sZW5ndGg7IGkrKykKCSAgICAgICAgICAgICAgICBjYWxsYmFja3NbaV0obm9kZSk7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIEVyYXNlIHRoZSBET00gZGF0YQoJICAgICAgICBrby51dGlscy5kb21EYXRhLmNsZWFyKG5vZGUpOwoKCSAgICAgICAgLy8gUGVyZm9ybSBjbGVhbnVwIG5lZWRlZCBieSBleHRlcm5hbCBsaWJyYXJpZXMgKGN1cnJlbnRseSBvbmx5IGpRdWVyeSwgYnV0IGNhbiBiZSBleHRlbmRlZCkKCSAgICAgICAga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsWyJjbGVhbkV4dGVybmFsRGF0YSJdKG5vZGUpOwoKCSAgICAgICAgLy8gQ2xlYXIgYW55IGltbWVkaWF0ZS1jaGlsZCBjb21tZW50IG5vZGVzLCBhcyB0aGVzZSB3b3VsZG4ndCBoYXZlIGJlZW4gZm91bmQgYnkKCSAgICAgICAgLy8gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpIGluIGNsZWFuTm9kZSgpIChjb21tZW50IG5vZGVzIGFyZW4ndCBlbGVtZW50cykKCSAgICAgICAgaWYgKGNsZWFuYWJsZU5vZGVUeXBlc1dpdGhEZXNjZW5kYW50c1tub2RlLm5vZGVUeXBlXSkKCSAgICAgICAgICAgIGNsZWFuSW1tZWRpYXRlQ29tbWVudFR5cGVDaGlsZHJlbihub2RlKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNsZWFuSW1tZWRpYXRlQ29tbWVudFR5cGVDaGlsZHJlbihub2RlV2l0aENoaWxkcmVuKSB7CgkgICAgICAgIHZhciBjaGlsZCwgbmV4dENoaWxkID0gbm9kZVdpdGhDaGlsZHJlbi5maXJzdENoaWxkOwoJICAgICAgICB3aGlsZSAoY2hpbGQgPSBuZXh0Q2hpbGQpIHsKCSAgICAgICAgICAgIG5leHRDaGlsZCA9IGNoaWxkLm5leHRTaWJsaW5nOwoJICAgICAgICAgICAgaWYgKGNoaWxkLm5vZGVUeXBlID09PSA4KQoJICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShjaGlsZCk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIHJldHVybiB7CgkgICAgICAgIGFkZERpc3Bvc2VDYWxsYmFjayA6IGZ1bmN0aW9uKG5vZGUsIGNhbGxiYWNrKSB7CgkgICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICJmdW5jdGlvbiIpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYWxsYmFjayBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKCSAgICAgICAgICAgIGdldERpc3Bvc2VDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUsIHRydWUpLnB1c2goY2FsbGJhY2spOwoJICAgICAgICB9LAoKCSAgICAgICAgcmVtb3ZlRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKCSAgICAgICAgICAgIHZhciBjYWxsYmFja3NDb2xsZWN0aW9uID0gZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgZmFsc2UpOwoJICAgICAgICAgICAgaWYgKGNhbGxiYWNrc0NvbGxlY3Rpb24pIHsKCSAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVJlbW92ZUl0ZW0oY2FsbGJhY2tzQ29sbGVjdGlvbiwgY2FsbGJhY2spOwoJICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja3NDb2xsZWN0aW9uLmxlbmd0aCA9PSAwKQoJICAgICAgICAgICAgICAgICAgICBkZXN0cm95Q2FsbGJhY2tzQ29sbGVjdGlvbihub2RlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIGNsZWFuTm9kZSA6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIC8vIEZpcnN0IGNsZWFuIHRoaXMgbm9kZSwgd2hlcmUgYXBwbGljYWJsZQoJICAgICAgICAgICAgaWYgKGNsZWFuYWJsZU5vZGVUeXBlc1tub2RlLm5vZGVUeXBlXSkgewoJICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShub2RlKTsKCgkgICAgICAgICAgICAgICAgLy8gLi4uIHRoZW4gaXRzIGRlc2NlbmRhbnRzLCB3aGVyZSBhcHBsaWNhYmxlCgkgICAgICAgICAgICAgICAgaWYgKGNsZWFuYWJsZU5vZGVUeXBlc1dpdGhEZXNjZW5kYW50c1tub2RlLm5vZGVUeXBlXSkgewoJICAgICAgICAgICAgICAgICAgICAvLyBDbG9uZSB0aGUgZGVzY2VuZGFudHMgbGlzdCBpbiBjYXNlIGl0IGNoYW5nZXMgZHVyaW5nIGl0ZXJhdGlvbgoJICAgICAgICAgICAgICAgICAgICB2YXIgZGVzY2VuZGFudHMgPSBbXTsKCSAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYXJyYXlQdXNoQWxsKGRlc2NlbmRhbnRzLCBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikpOwoJICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGRlc2NlbmRhbnRzLmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShkZXNjZW5kYW50c1tpXSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG5vZGU7CgkgICAgICAgIH0sCgoJICAgICAgICByZW1vdmVOb2RlIDogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAga28uY2xlYW5Ob2RlKG5vZGUpOwoJICAgICAgICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZSkKCSAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7CgkgICAgICAgIH0sCgoJICAgICAgICAiY2xlYW5FeHRlcm5hbERhdGEiIDogZnVuY3Rpb24gKG5vZGUpIHsKCSAgICAgICAgICAgIC8vIFNwZWNpYWwgc3VwcG9ydCBmb3IgalF1ZXJ5IGhlcmUgYmVjYXVzZSBpdCdzIHNvIGNvbW1vbmx5IHVzZWQuCgkgICAgICAgICAgICAvLyBNYW55IGpRdWVyeSBwbHVnaW5zIChpbmNsdWRpbmcganF1ZXJ5LnRtcGwpIHN0b3JlIGRhdGEgdXNpbmcgalF1ZXJ5J3MgZXF1aXZhbGVudCBvZiBkb21EYXRhCgkgICAgICAgICAgICAvLyBzbyBub3RpZnkgaXQgdG8gdGVhciBkb3duIGFueSByZXNvdXJjZXMgYXNzb2NpYXRlZCB3aXRoIHRoZSBub2RlICYgZGVzY2VuZGFudHMgaGVyZS4KCSAgICAgICAgICAgIGlmIChqUXVlcnlJbnN0YW5jZSAmJiAodHlwZW9mIGpRdWVyeUluc3RhbmNlWydjbGVhbkRhdGEnXSA9PSAiZnVuY3Rpb24iKSkKCSAgICAgICAgICAgICAgICBqUXVlcnlJbnN0YW5jZVsnY2xlYW5EYXRhJ10oW25vZGVdKTsKCSAgICAgICAgfQoJICAgIH0KCX0pKCk7Cglrby5jbGVhbk5vZGUgPSBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuY2xlYW5Ob2RlOyAvLyBTaG9ydGhhbmQgbmFtZSBmb3IgY29udmVuaWVuY2UKCWtvLnJlbW92ZU5vZGUgPSBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlTm9kZTsgLy8gU2hvcnRoYW5kIG5hbWUgZm9yIGNvbnZlbmllbmNlCglrby5leHBvcnRTeW1ib2woJ2NsZWFuTm9kZScsIGtvLmNsZWFuTm9kZSk7Cglrby5leHBvcnRTeW1ib2woJ3JlbW92ZU5vZGUnLCBrby5yZW1vdmVOb2RlKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tTm9kZURpc3Bvc2FsJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjaycsIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5hZGREaXNwb3NlQ2FsbGJhY2spOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlRGlzcG9zZUNhbGxiYWNrJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLnJlbW92ZURpc3Bvc2VDYWxsYmFjayk7CgkoZnVuY3Rpb24gKCkgewoJICAgIHZhciBsZWFkaW5nQ29tbWVudFJlZ2V4ID0gL14oXHMqKTwhLS0oLio/KS0tPi87CgoJICAgIGZ1bmN0aW9uIHNpbXBsZUh0bWxQYXJzZShodG1sKSB7CgkgICAgICAgIC8vIEJhc2VkIG9uIGpRdWVyeSdzICJjbGVhbiIgZnVuY3Rpb24sIGJ1dCBvbmx5IGFjY291bnRpbmcgZm9yIHRhYmxlLXJlbGF0ZWQgZWxlbWVudHMuCgkgICAgICAgIC8vIElmIHlvdSBoYXZlIHJlZmVyZW5jZWQgalF1ZXJ5LCB0aGlzIHdvbid0IGJlIHVzZWQgYW55d2F5IC0gS08gd2lsbCB1c2UgalF1ZXJ5J3MgImNsZWFuIiBmdW5jdGlvbiBkaXJlY3RseQoKCSAgICAgICAgLy8gTm90ZSB0aGF0IHRoZXJlJ3Mgc3RpbGwgYW4gaXNzdWUgaW4gSUUgPCA5IHdoZXJlYnkgaXQgd2lsbCBkaXNjYXJkIGNvbW1lbnQgbm9kZXMgdGhhdCBhcmUgdGhlIGZpcnN0IGNoaWxkIG9mCgkgICAgICAgIC8vIGEgZGVzY2VuZGFudCBub2RlLiBGb3IgZXhhbXBsZTogIjxkaXY+PCEtLSBteWNvbW1lbnQgLS0+YWJjPC9kaXY+IiB3aWxsIGdldCBwYXJzZWQgYXMgIjxkaXY+YWJjPC9kaXY+IgoJICAgICAgICAvLyBUaGlzIHdvbid0IGFmZmVjdCBhbnlvbmUgd2hvIGhhcyByZWZlcmVuY2VkIGpRdWVyeSwgYW5kIHRoZXJlJ3MgYWx3YXlzIHRoZSB3b3JrYXJvdW5kIG9mIGluc2VydGluZyBhIGR1bW15IG5vZGUKCSAgICAgICAgLy8gKHBvc3NpYmx5IGEgdGV4dCBub2RlKSBpbiBmcm9udCBvZiB0aGUgY29tbWVudC4gU28sIEtPIGRvZXMgbm90IGF0dGVtcHQgdG8gd29ya2Fyb3VuZCB0aGlzIElFIGlzc3VlIGF1dG9tYXRpY2FsbHkgYXQgcHJlc2VudC4KCgkgICAgICAgIC8vIFRyaW0gd2hpdGVzcGFjZSwgb3RoZXJ3aXNlIGluZGV4T2Ygd29uJ3Qgd29yayBhcyBleHBlY3RlZAoJICAgICAgICB2YXIgdGFncyA9IGtvLnV0aWxzLnN0cmluZ1RyaW0oaHRtbCkudG9Mb3dlckNhc2UoKSwgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CgoJICAgICAgICAvLyBGaW5kcyB0aGUgZmlyc3QgbWF0Y2ggZnJvbSB0aGUgbGVmdCBjb2x1bW4sIGFuZCByZXR1cm5zIHRoZSBjb3JyZXNwb25kaW5nICJ3cmFwIiBkYXRhIGZyb20gdGhlIHJpZ2h0IGNvbHVtbgoJICAgICAgICB2YXIgd3JhcCA9IHRhZ3MubWF0Y2goL148KHRoZWFkfHRib2R5fHRmb290KS8pICAgICAgICAgICAgICAmJiBbMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iXSB8fAoJICAgICAgICAgICAgICAgICAgICF0YWdzLmluZGV4T2YoIjx0ciIpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBbMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iXSB8fAoJICAgICAgICAgICAgICAgICAgICghdGFncy5pbmRleE9mKCI8dGQiKSB8fCAhdGFncy5pbmRleE9mKCI8dGgiKSkgICAmJiBbMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iXSB8fAoJICAgICAgICAgICAgICAgICAgIC8qIGFueXRoaW5nIGVsc2UgKi8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbMCwgIiIsICIiXTsKCgkgICAgICAgIC8vIEdvIHRvIGh0bWwgYW5kIGJhY2ssIHRoZW4gcGVlbCBvZmYgZXh0cmEgd3JhcHBlcnMKCSAgICAgICAgLy8gTm90ZSB0aGF0IHdlIGFsd2F5cyBwcmVmaXggd2l0aCBzb21lIGR1bW15IHRleHQsIGJlY2F1c2Ugb3RoZXJ3aXNlLCBJRTw5IHdpbGwgc3RyaXAgb3V0IGxlYWRpbmcgY29tbWVudCBub2RlcyBpbiBkZXNjZW5kYW50cy4gVG90YWwgbWFkbmVzcy4KCSAgICAgICAgdmFyIG1hcmt1cCA9ICJpZ25vcmVkPGRpdj4iICsgd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdICsgIjwvZGl2PiI7CgkgICAgICAgIGlmICh0eXBlb2Ygd2luZG93Wydpbm5lclNoaXYnXSA9PSAiZnVuY3Rpb24iKSB7CgkgICAgICAgICAgICBkaXYuYXBwZW5kQ2hpbGQod2luZG93Wydpbm5lclNoaXYnXShtYXJrdXApKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSBtYXJrdXA7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIE1vdmUgdG8gdGhlIHJpZ2h0IGRlcHRoCgkgICAgICAgIHdoaWxlICh3cmFwWzBdLS0pCgkgICAgICAgICAgICBkaXYgPSBkaXYubGFzdENoaWxkOwoKCSAgICAgICAgcmV0dXJuIGtvLnV0aWxzLm1ha2VBcnJheShkaXYubGFzdENoaWxkLmNoaWxkTm9kZXMpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24galF1ZXJ5SHRtbFBhcnNlKGh0bWwpIHsKCSAgICAgICAgLy8galF1ZXJ5J3MgInBhcnNlSFRNTCIgZnVuY3Rpb24gd2FzIGludHJvZHVjZWQgaW4galF1ZXJ5IDEuOC4wIGFuZCBpcyBhIGRvY3VtZW50ZWQgcHVibGljIEFQSS4KCSAgICAgICAgaWYgKGpRdWVyeUluc3RhbmNlWydwYXJzZUhUTUwnXSkgewoJICAgICAgICAgICAgcmV0dXJuIGpRdWVyeUluc3RhbmNlWydwYXJzZUhUTUwnXShodG1sKSB8fCBbXTsgLy8gRW5zdXJlIHdlIGFsd2F5cyByZXR1cm4gYW4gYXJyYXkgYW5kIG5ldmVyIG51bGwKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIC8vIEZvciBqUXVlcnkgPCAxLjguMCwgd2UgZmFsbCBiYWNrIG9uIHRoZSB1bmRvY3VtZW50ZWQgaW50ZXJuYWwgImNsZWFuIiBmdW5jdGlvbi4KCSAgICAgICAgICAgIHZhciBlbGVtcyA9IGpRdWVyeUluc3RhbmNlWydjbGVhbiddKFtodG1sXSk7CgoJICAgICAgICAgICAgLy8gQXMgb2YgalF1ZXJ5IDEuNy4xLCBqUXVlcnkgcGFyc2VzIHRoZSBIVE1MIGJ5IGFwcGVuZGluZyBpdCB0byBzb21lIGR1bW15IHBhcmVudCBub2RlcyBoZWxkIGluIGFuIGluLW1lbW9yeSBkb2N1bWVudCBmcmFnbWVudC4KCSAgICAgICAgICAgIC8vIFVuZm9ydHVuYXRlbHksIGl0IG5ldmVyIGNsZWFycyB0aGUgZHVtbXkgcGFyZW50IG5vZGVzIGZyb20gdGhlIGRvY3VtZW50IGZyYWdtZW50LCBzbyBpdCBsZWFrcyBtZW1vcnkgb3ZlciB0aW1lLgoJICAgICAgICAgICAgLy8gRml4IHRoaXMgYnkgZmluZGluZyB0aGUgdG9wLW1vc3QgZHVtbXkgcGFyZW50IGVsZW1lbnQsIGFuZCBkZXRhY2hpbmcgaXQgZnJvbSBpdHMgb3duZXIgZnJhZ21lbnQuCgkgICAgICAgICAgICBpZiAoZWxlbXMgJiYgZWxlbXNbMF0pIHsKCSAgICAgICAgICAgICAgICAvLyBGaW5kIHRoZSB0b3AtbW9zdCBwYXJlbnQgZWxlbWVudCB0aGF0J3MgYSBkaXJlY3QgY2hpbGQgb2YgYSBkb2N1bWVudCBmcmFnbWVudAoJICAgICAgICAgICAgICAgIHZhciBlbGVtID0gZWxlbXNbMF07CgkgICAgICAgICAgICAgICAgd2hpbGUgKGVsZW0ucGFyZW50Tm9kZSAmJiBlbGVtLnBhcmVudE5vZGUubm9kZVR5cGUgIT09IDExIC8qIGkuZS4sIERvY3VtZW50RnJhZ21lbnQgKi8pCgkgICAgICAgICAgICAgICAgICAgIGVsZW0gPSBlbGVtLnBhcmVudE5vZGU7CgkgICAgICAgICAgICAgICAgLy8gLi4uIHRoZW4gZGV0YWNoIGl0CgkgICAgICAgICAgICAgICAgaWYgKGVsZW0ucGFyZW50Tm9kZSkKCSAgICAgICAgICAgICAgICAgICAgZWxlbS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsZW0pOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIHJldHVybiBlbGVtczsKCSAgICAgICAgfQoJICAgIH0KCgkgICAga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQgPSBmdW5jdGlvbihodG1sKSB7CgkgICAgICAgIHJldHVybiBqUXVlcnlJbnN0YW5jZSA/IGpRdWVyeUh0bWxQYXJzZShodG1sKSAgIC8vIEFzIGJlbG93LCBiZW5lZml0IGZyb20galF1ZXJ5J3Mgb3B0aW1pc2F0aW9ucyB3aGVyZSBwb3NzaWJsZQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBzaW1wbGVIdG1sUGFyc2UoaHRtbCk7ICAvLyAuLi4gb3RoZXJ3aXNlLCB0aGlzIHNpbXBsZSBsb2dpYyB3aWxsIGRvIGluIG1vc3QgY29tbW9uIGNhc2VzLgoJICAgIH07CgoJICAgIGtvLnV0aWxzLnNldEh0bWwgPSBmdW5jdGlvbihub2RlLCBodG1sKSB7CgkgICAgICAgIGtvLnV0aWxzLmVtcHR5RG9tTm9kZShub2RlKTsKCgkgICAgICAgIC8vIFRoZXJlJ3Mgbm8gbGVnaXRpbWF0ZSByZWFzb24gdG8gZGlzcGxheSBhIHN0cmluZ2lmaWVkIG9ic2VydmFibGUgd2l0aG91dCB1bndyYXBwaW5nIGl0LCBzbyB3ZSdsbCB1bndyYXAgaXQKCSAgICAgICAgaHRtbCA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoaHRtbCk7CgoJICAgICAgICBpZiAoKGh0bWwgIT09IG51bGwpICYmIChodG1sICE9PSB1bmRlZmluZWQpKSB7CgkgICAgICAgICAgICBpZiAodHlwZW9mIGh0bWwgIT0gJ3N0cmluZycpCgkgICAgICAgICAgICAgICAgaHRtbCA9IGh0bWwudG9TdHJpbmcoKTsKCgkgICAgICAgICAgICAvLyBqUXVlcnkgY29udGFpbnMgYSBsb3Qgb2Ygc29waGlzdGljYXRlZCBjb2RlIHRvIHBhcnNlIGFyYml0cmFyeSBIVE1MIGZyYWdtZW50cywKCSAgICAgICAgICAgIC8vIGZvciBleGFtcGxlIDx0cj4gZWxlbWVudHMgd2hpY2ggYXJlIG5vdCBub3JtYWxseSBhbGxvd2VkIHRvIGV4aXN0IG9uIHRoZWlyIG93bi4KCSAgICAgICAgICAgIC8vIElmIHlvdSd2ZSByZWZlcmVuY2VkIGpRdWVyeSB3ZSdsbCB1c2UgdGhhdCByYXRoZXIgdGhhbiBkdXBsaWNhdGluZyBpdHMgY29kZS4KCSAgICAgICAgICAgIGlmIChqUXVlcnlJbnN0YW5jZSkgewoJICAgICAgICAgICAgICAgIGpRdWVyeUluc3RhbmNlKG5vZGUpWydodG1sJ10oaHRtbCk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIC4uLiBvdGhlcndpc2UsIHVzZSBLTydzIG93biBwYXJzaW5nIGxvZ2ljLgoJICAgICAgICAgICAgICAgIHZhciBwYXJzZWROb2RlcyA9IGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KGh0bWwpOwoJICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyc2VkTm9kZXMubGVuZ3RoOyBpKyspCgkgICAgICAgICAgICAgICAgICAgIG5vZGUuYXBwZW5kQ2hpbGQocGFyc2VkTm9kZXNbaV0pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfTsKCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wYXJzZUh0bWxGcmFnbWVudCcsIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuc2V0SHRtbCcsIGtvLnV0aWxzLnNldEh0bWwpOwoKCWtvLm1lbW9pemF0aW9uID0gKGZ1bmN0aW9uICgpIHsKCSAgICB2YXIgbWVtb3MgPSB7fTsKCgkgICAgZnVuY3Rpb24gcmFuZG9tTWF4OEhleENoYXJzKCkgewoJICAgICAgICByZXR1cm4gKCgoMSArIE1hdGgucmFuZG9tKCkpICogMHgxMDAwMDAwMDApIHwgMCkudG9TdHJpbmcoMTYpLnN1YnN0cmluZygxKTsKCSAgICB9CgkgICAgZnVuY3Rpb24gZ2VuZXJhdGVSYW5kb21JZCgpIHsKCSAgICAgICAgcmV0dXJuIHJhbmRvbU1heDhIZXhDaGFycygpICsgcmFuZG9tTWF4OEhleENoYXJzKCk7CgkgICAgfQoJICAgIGZ1bmN0aW9uIGZpbmRNZW1vTm9kZXMocm9vdE5vZGUsIGFwcGVuZFRvQXJyYXkpIHsKCSAgICAgICAgaWYgKCFyb290Tm9kZSkKCSAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgaWYgKHJvb3ROb2RlLm5vZGVUeXBlID09IDgpIHsKCSAgICAgICAgICAgIHZhciBtZW1vSWQgPSBrby5tZW1vaXphdGlvbi5wYXJzZU1lbW9UZXh0KHJvb3ROb2RlLm5vZGVWYWx1ZSk7CgkgICAgICAgICAgICBpZiAobWVtb0lkICE9IG51bGwpCgkgICAgICAgICAgICAgICAgYXBwZW5kVG9BcnJheS5wdXNoKHsgZG9tTm9kZTogcm9vdE5vZGUsIG1lbW9JZDogbWVtb0lkIH0pOwoJICAgICAgICB9IGVsc2UgaWYgKHJvb3ROb2RlLm5vZGVUeXBlID09IDEpIHsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZE5vZGVzID0gcm9vdE5vZGUuY2hpbGROb2RlcywgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgIGZpbmRNZW1vTm9kZXMoY2hpbGROb2Rlc1tpXSwgYXBwZW5kVG9BcnJheSk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIHJldHVybiB7CgkgICAgICAgIG1lbW9pemU6IGZ1bmN0aW9uIChjYWxsYmFjaykgewoJICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiWW91IGNhbiBvbmx5IHBhc3MgYSBmdW5jdGlvbiB0byBrby5tZW1vaXphdGlvbi5tZW1vaXplKCkiKTsKCSAgICAgICAgICAgIHZhciBtZW1vSWQgPSBnZW5lcmF0ZVJhbmRvbUlkKCk7CgkgICAgICAgICAgICBtZW1vc1ttZW1vSWRdID0gY2FsbGJhY2s7CgkgICAgICAgICAgICByZXR1cm4gIjwhLS1ba29fbWVtbzoiICsgbWVtb0lkICsgIl0tLT4iOwoJICAgICAgICB9LAoKCSAgICAgICAgdW5tZW1vaXplOiBmdW5jdGlvbiAobWVtb0lkLCBjYWxsYmFja1BhcmFtcykgewoJICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gbWVtb3NbbWVtb0lkXTsKCSAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gdW5kZWZpbmVkKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ291bGRuJ3QgZmluZCBhbnkgbWVtbyB3aXRoIElEICIgKyBtZW1vSWQgKyAiLiBQZXJoYXBzIGl0J3MgYWxyZWFkeSBiZWVuIHVubWVtb2l6ZWQuIik7CgkgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KG51bGwsIGNhbGxiYWNrUGFyYW1zIHx8IFtdKTsKCSAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGZpbmFsbHkgeyBkZWxldGUgbWVtb3NbbWVtb0lkXTsgfQoJICAgICAgICB9LAoKCSAgICAgICAgdW5tZW1vaXplRG9tTm9kZUFuZERlc2NlbmRhbnRzOiBmdW5jdGlvbiAoZG9tTm9kZSwgZXh0cmFDYWxsYmFja1BhcmFtc0FycmF5KSB7CgkgICAgICAgICAgICB2YXIgbWVtb3MgPSBbXTsKCSAgICAgICAgICAgIGZpbmRNZW1vTm9kZXMoZG9tTm9kZSwgbWVtb3MpOwoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBtZW1vcy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKCSAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IG1lbW9zW2ldLmRvbU5vZGU7CgkgICAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkUGFyYW1zID0gW25vZGVdOwoJICAgICAgICAgICAgICAgIGlmIChleHRyYUNhbGxiYWNrUGFyYW1zQXJyYXkpCgkgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UHVzaEFsbChjb21iaW5lZFBhcmFtcywgZXh0cmFDYWxsYmFja1BhcmFtc0FycmF5KTsKCSAgICAgICAgICAgICAgICBrby5tZW1vaXphdGlvbi51bm1lbW9pemUobWVtb3NbaV0ubWVtb0lkLCBjb21iaW5lZFBhcmFtcyk7CgkgICAgICAgICAgICAgICAgbm9kZS5ub2RlVmFsdWUgPSAiIjsgLy8gTmV1dGVyIHRoaXMgbm9kZSBzbyB3ZSBkb24ndCB0cnkgdG8gdW5tZW1vaXplIGl0IGFnYWluCgkgICAgICAgICAgICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZSkKCSAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOyAvLyBJZiBwb3NzaWJsZSwgZXJhc2UgaXQgdG90YWxseSAobm90IGFsd2F5cyBwb3NzaWJsZSAtIHNvbWVvbmUgZWxzZSBtaWdodCBqdXN0IGhvbGQgYSByZWZlcmVuY2UgdG8gaXQgdGhlbiBjYWxsIHVubWVtb2l6ZURvbU5vZGVBbmREZXNjZW5kYW50cyBhZ2FpbikKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIHBhcnNlTWVtb1RleHQ6IGZ1bmN0aW9uIChtZW1vVGV4dCkgewoJICAgICAgICAgICAgdmFyIG1hdGNoID0gbWVtb1RleHQubWF0Y2goL15cW2tvX21lbW9cOiguKj8pXF0kLyk7CgkgICAgICAgICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6IG51bGw7CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uJywga28ubWVtb2l6YXRpb24pOwoJa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi5tZW1vaXplJywga28ubWVtb2l6YXRpb24ubWVtb2l6ZSk7Cglrby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLnVubWVtb2l6ZScsIGtvLm1lbW9pemF0aW9uLnVubWVtb2l6ZSk7Cglrby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLnBhcnNlTWVtb1RleHQnLCBrby5tZW1vaXphdGlvbi5wYXJzZU1lbW9UZXh0KTsKCWtvLmV4cG9ydFN5bWJvbCgnbWVtb2l6YXRpb24udW5tZW1vaXplRG9tTm9kZUFuZERlc2NlbmRhbnRzJywga28ubWVtb2l6YXRpb24udW5tZW1vaXplRG9tTm9kZUFuZERlc2NlbmRhbnRzKTsKCWtvLmV4dGVuZGVycyA9IHsKCSAgICAndGhyb3R0bGUnOiBmdW5jdGlvbih0YXJnZXQsIHRpbWVvdXQpIHsKCSAgICAgICAgLy8gVGhyb3R0bGluZyBtZWFucyB0d28gdGhpbmdzOgoKCSAgICAgICAgLy8gKDEpIEZvciBkZXBlbmRlbnQgb2JzZXJ2YWJsZXMsIHdlIHRocm90dGxlICpldmFsdWF0aW9ucyogc28gdGhhdCwgbm8gbWF0dGVyIGhvdyBmYXN0IGl0cyBkZXBlbmRlbmNpZXMKCSAgICAgICAgLy8gICAgIG5vdGlmeSB1cGRhdGVzLCB0aGUgdGFyZ2V0IGRvZXNuJ3QgcmUtZXZhbHVhdGUgKGFuZCBoZW5jZSBkb2Vzbid0IG5vdGlmeSkgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKCSAgICAgICAgdGFyZ2V0Wyd0aHJvdHRsZUV2YWx1YXRpb24nXSA9IHRpbWVvdXQ7CgoJICAgICAgICAvLyAoMikgRm9yIHdyaXRhYmxlIHRhcmdldHMgKG9ic2VydmFibGVzLCBvciB3cml0YWJsZSBkZXBlbmRlbnQgb2JzZXJ2YWJsZXMpLCB3ZSB0aHJvdHRsZSAqd3JpdGVzKgoJICAgICAgICAvLyAgICAgc28gdGhlIHRhcmdldCBjYW5ub3QgY2hhbmdlIHZhbHVlIHN5bmNocm9ub3VzbHkgb3IgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKCSAgICAgICAgdmFyIHdyaXRlVGltZW91dEluc3RhbmNlID0gbnVsbDsKCSAgICAgICAgcmV0dXJuIGtvLmRlcGVuZGVudE9ic2VydmFibGUoewoJICAgICAgICAgICAgJ3JlYWQnOiB0YXJnZXQsCgkgICAgICAgICAgICAnd3JpdGUnOiBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh3cml0ZVRpbWVvdXRJbnN0YW5jZSk7CgkgICAgICAgICAgICAgICAgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgICAgICB0YXJnZXQodmFsdWUpOwoJICAgICAgICAgICAgICAgIH0sIHRpbWVvdXQpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9KTsKCSAgICB9LAoKCSAgICAncmF0ZUxpbWl0JzogZnVuY3Rpb24odGFyZ2V0LCBvcHRpb25zKSB7CgkgICAgICAgIHZhciB0aW1lb3V0LCBtZXRob2QsIGxpbWl0RnVuY3Rpb247CgoJICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT0gJ251bWJlcicpIHsKCSAgICAgICAgICAgIHRpbWVvdXQgPSBvcHRpb25zOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdGltZW91dCA9IG9wdGlvbnNbJ3RpbWVvdXQnXTsKCSAgICAgICAgICAgIG1ldGhvZCA9IG9wdGlvbnNbJ21ldGhvZCddOwoJICAgICAgICB9CgoJICAgICAgICBsaW1pdEZ1bmN0aW9uID0gbWV0aG9kID09ICdub3RpZnlXaGVuQ2hhbmdlc1N0b3AnID8gIGRlYm91bmNlIDogdGhyb3R0bGU7CgkgICAgICAgIHRhcmdldC5saW1pdChmdW5jdGlvbihjYWxsYmFjaykgewoJICAgICAgICAgICAgcmV0dXJuIGxpbWl0RnVuY3Rpb24oY2FsbGJhY2ssIHRpbWVvdXQpOwoJICAgICAgICB9KTsKCSAgICB9LAoKCSAgICAnbm90aWZ5JzogZnVuY3Rpb24odGFyZ2V0LCBub3RpZnlXaGVuKSB7CgkgICAgICAgIHRhcmdldFsiZXF1YWxpdHlDb21wYXJlciJdID0gbm90aWZ5V2hlbiA9PSAiYWx3YXlzIiA/CgkgICAgICAgICAgICBudWxsIDogIC8vIG51bGwgZXF1YWxpdHlDb21wYXJlciBtZWFucyB0byBhbHdheXMgbm90aWZ5CgkgICAgICAgICAgICB2YWx1ZXNBcmVQcmltaXRpdmVBbmRFcXVhbDsKCSAgICB9Cgl9OwoKCXZhciBwcmltaXRpdmVUeXBlcyA9IHsgJ3VuZGVmaW5lZCc6MSwgJ2Jvb2xlYW4nOjEsICdudW1iZXInOjEsICdzdHJpbmcnOjEgfTsKCWZ1bmN0aW9uIHZhbHVlc0FyZVByaW1pdGl2ZUFuZEVxdWFsKGEsIGIpIHsKCSAgICB2YXIgb2xkVmFsdWVJc1ByaW1pdGl2ZSA9IChhID09PSBudWxsKSB8fCAodHlwZW9mKGEpIGluIHByaW1pdGl2ZVR5cGVzKTsKCSAgICByZXR1cm4gb2xkVmFsdWVJc1ByaW1pdGl2ZSA/IChhID09PSBiKSA6IGZhbHNlOwoJfQoKCWZ1bmN0aW9uIHRocm90dGxlKGNhbGxiYWNrLCB0aW1lb3V0KSB7CgkgICAgdmFyIHRpbWVvdXRJbnN0YW5jZTsKCSAgICByZXR1cm4gZnVuY3Rpb24gKCkgewoJICAgICAgICBpZiAoIXRpbWVvdXRJbnN0YW5jZSkgewoJICAgICAgICAgICAgdGltZW91dEluc3RhbmNlID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICB0aW1lb3V0SW5zdGFuY2UgPSB1bmRlZmluZWQ7CgkgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCSAgICAgICAgICAgIH0sIHRpbWVvdXQpOwoJICAgICAgICB9CgkgICAgfTsKCX0KCglmdW5jdGlvbiBkZWJvdW5jZShjYWxsYmFjaywgdGltZW91dCkgewoJICAgIHZhciB0aW1lb3V0SW5zdGFuY2U7CgkgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKCSAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJbnN0YW5jZSk7CgkgICAgICAgIHRpbWVvdXRJbnN0YW5jZSA9IHNldFRpbWVvdXQoY2FsbGJhY2ssIHRpbWVvdXQpOwoJICAgIH07Cgl9CgoJZnVuY3Rpb24gYXBwbHlFeHRlbmRlcnMocmVxdWVzdGVkRXh0ZW5kZXJzKSB7CgkgICAgdmFyIHRhcmdldCA9IHRoaXM7CgkgICAgaWYgKHJlcXVlc3RlZEV4dGVuZGVycykgewoJICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKHJlcXVlc3RlZEV4dGVuZGVycywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewoJICAgICAgICAgICAgdmFyIGV4dGVuZGVySGFuZGxlciA9IGtvLmV4dGVuZGVyc1trZXldOwoJICAgICAgICAgICAgaWYgKHR5cGVvZiBleHRlbmRlckhhbmRsZXIgPT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgICAgIHRhcmdldCA9IGV4dGVuZGVySGFuZGxlcih0YXJnZXQsIHZhbHVlKSB8fCB0YXJnZXQ7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgIH0KCSAgICByZXR1cm4gdGFyZ2V0OwoJfQoKCWtvLmV4cG9ydFN5bWJvbCgnZXh0ZW5kZXJzJywga28uZXh0ZW5kZXJzKTsKCglrby5zdWJzY3JpcHRpb24gPSBmdW5jdGlvbiAodGFyZ2V0LCBjYWxsYmFjaywgZGlzcG9zZUNhbGxiYWNrKSB7CgkgICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CgkgICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrOwoJICAgIHRoaXMuZGlzcG9zZUNhbGxiYWNrID0gZGlzcG9zZUNhbGxiYWNrOwoJICAgIHRoaXMuaXNEaXNwb3NlZCA9IGZhbHNlOwoJICAgIGtvLmV4cG9ydFByb3BlcnR5KHRoaXMsICdkaXNwb3NlJywgdGhpcy5kaXNwb3NlKTsKCX07Cglrby5zdWJzY3JpcHRpb24ucHJvdG90eXBlLmRpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7CgkgICAgdGhpcy5pc0Rpc3Bvc2VkID0gdHJ1ZTsKCSAgICB0aGlzLmRpc3Bvc2VDYWxsYmFjaygpOwoJfTsKCglrby5zdWJzY3JpYmFibGUgPSBmdW5jdGlvbiAoKSB7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2ZPckV4dGVuZCh0aGlzLCBrby5zdWJzY3JpYmFibGVbJ2ZuJ10pOwoJICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSB7fTsKCX0KCgl2YXIgZGVmYXVsdEV2ZW50ID0gImNoYW5nZSI7CgoJdmFyIGtvX3N1YnNjcmliYWJsZV9mbiA9IHsKCSAgICBzdWJzY3JpYmU6IGZ1bmN0aW9uIChjYWxsYmFjaywgY2FsbGJhY2tUYXJnZXQsIGV2ZW50KSB7CgkgICAgICAgIHZhciBzZWxmID0gdGhpczsKCgkgICAgICAgIGV2ZW50ID0gZXZlbnQgfHwgZGVmYXVsdEV2ZW50OwoJICAgICAgICB2YXIgYm91bmRDYWxsYmFjayA9IGNhbGxiYWNrVGFyZ2V0ID8gY2FsbGJhY2suYmluZChjYWxsYmFja1RhcmdldCkgOiBjYWxsYmFjazsKCgkgICAgICAgIHZhciBzdWJzY3JpcHRpb24gPSBuZXcga28uc3Vic2NyaXB0aW9uKHNlbGYsIGJvdW5kQ2FsbGJhY2ssIGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbShzZWxmLl9zdWJzY3JpcHRpb25zW2V2ZW50XSwgc3Vic2NyaXB0aW9uKTsKCSAgICAgICAgICAgIGlmIChzZWxmLmFmdGVyU3Vic2NyaXB0aW9uUmVtb3ZlKQoJICAgICAgICAgICAgICAgIHNlbGYuYWZ0ZXJTdWJzY3JpcHRpb25SZW1vdmUoZXZlbnQpOwoJICAgICAgICB9KTsKCgkgICAgICAgIGlmIChzZWxmLmJlZm9yZVN1YnNjcmlwdGlvbkFkZCkKCSAgICAgICAgICAgIHNlbGYuYmVmb3JlU3Vic2NyaXB0aW9uQWRkKGV2ZW50KTsKCgkgICAgICAgIGlmICghc2VsZi5fc3Vic2NyaXB0aW9uc1tldmVudF0pCgkgICAgICAgICAgICBzZWxmLl9zdWJzY3JpcHRpb25zW2V2ZW50XSA9IFtdOwoJICAgICAgICBzZWxmLl9zdWJzY3JpcHRpb25zW2V2ZW50XS5wdXNoKHN1YnNjcmlwdGlvbik7CgoJICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9uOwoJICAgIH0sCgoJICAgICJub3RpZnlTdWJzY3JpYmVycyI6IGZ1bmN0aW9uICh2YWx1ZVRvTm90aWZ5LCBldmVudCkgewoJICAgICAgICBldmVudCA9IGV2ZW50IHx8IGRlZmF1bHRFdmVudDsKCSAgICAgICAgaWYgKHRoaXMuaGFzU3Vic2NyaXB0aW9uc0ZvckV2ZW50KGV2ZW50KSkgewoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmJlZ2luKCk7IC8vIEJlZ2luIHN1cHByZXNzaW5nIGRlcGVuZGVuY3kgZGV0ZWN0aW9uIChieSBzZXR0aW5nIHRoZSB0b3AgZnJhbWUgdG8gdW5kZWZpbmVkKQoJICAgICAgICAgICAgICAgIGZvciAodmFyIGEgPSB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XS5zbGljZSgwKSwgaSA9IDAsIHN1YnNjcmlwdGlvbjsgc3Vic2NyaXB0aW9uID0gYVtpXTsgKytpKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEluIGNhc2UgYSBzdWJzY3JpcHRpb24gd2FzIGRpc3Bvc2VkIGR1cmluZyB0aGUgYXJyYXlGb3JFYWNoIGN5Y2xlLCBjaGVjawoJICAgICAgICAgICAgICAgICAgICAvLyBmb3IgaXNEaXNwb3NlZCBvbiBlYWNoIHN1YnNjcmlwdGlvbiBiZWZvcmUgaW52b2tpbmcgaXRzIGNhbGxiYWNrCgkgICAgICAgICAgICAgICAgICAgIGlmICghc3Vic2NyaXB0aW9uLmlzRGlzcG9zZWQpCgkgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb24uY2FsbGJhY2sodmFsdWVUb05vdGlmeSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSBmaW5hbGx5IHsKCSAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmVuZCgpOyAvLyBFbmQgc3VwcHJlc3NpbmcgZGVwZW5kZW5jeSBkZXRlY3Rpb24KCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH0sCgoJICAgIGxpbWl0OiBmdW5jdGlvbihsaW1pdEZ1bmN0aW9uKSB7CgkgICAgICAgIHZhciBzZWxmID0gdGhpcywgc2VsZklzT2JzZXJ2YWJsZSA9IGtvLmlzT2JzZXJ2YWJsZShzZWxmKSwKCSAgICAgICAgICAgIGlzUGVuZGluZywgcHJldmlvdXNWYWx1ZSwgcGVuZGluZ1ZhbHVlLCBiZWZvcmVDaGFuZ2UgPSAnYmVmb3JlQ2hhbmdlJzsKCgkgICAgICAgIGlmICghc2VsZi5fb3JpZ05vdGlmeVN1YnNjcmliZXJzKSB7CgkgICAgICAgICAgICBzZWxmLl9vcmlnTm90aWZ5U3Vic2NyaWJlcnMgPSBzZWxmWyJub3RpZnlTdWJzY3JpYmVycyJdOwoJICAgICAgICAgICAgc2VsZlsibm90aWZ5U3Vic2NyaWJlcnMiXSA9IGZ1bmN0aW9uKHZhbHVlLCBldmVudCkgewoJICAgICAgICAgICAgICAgIGlmICghZXZlbnQgfHwgZXZlbnQgPT09IGRlZmF1bHRFdmVudCkgewoJICAgICAgICAgICAgICAgICAgICBzZWxmLl9yYXRlTGltaXRlZENoYW5nZSh2YWx1ZSk7CgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudCA9PT0gYmVmb3JlQ2hhbmdlKSB7CgkgICAgICAgICAgICAgICAgICAgIHNlbGYuX3JhdGVMaW1pdGVkQmVmb3JlQ2hhbmdlKHZhbHVlKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICBzZWxmLl9vcmlnTm90aWZ5U3Vic2NyaWJlcnModmFsdWUsIGV2ZW50KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9OwoJICAgICAgICB9CgoJICAgICAgICB2YXIgZmluaXNoID0gbGltaXRGdW5jdGlvbihmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIC8vIElmIGFuIG9ic2VydmFibGUgcHJvdmlkZWQgYSByZWZlcmVuY2UgdG8gaXRzZWxmLCBhY2Nlc3MgaXQgdG8gZ2V0IHRoZSBsYXRlc3QgdmFsdWUuCgkgICAgICAgICAgICAvLyBUaGlzIGFsbG93cyBjb21wdXRlZCBvYnNlcnZhYmxlcyB0byBkZWxheSBjYWxjdWxhdGluZyB0aGVpciB2YWx1ZSB1bnRpbCBuZWVkZWQuCgkgICAgICAgICAgICBpZiAoc2VsZklzT2JzZXJ2YWJsZSAmJiBwZW5kaW5nVmFsdWUgPT09IHNlbGYpIHsKCSAgICAgICAgICAgICAgICBwZW5kaW5nVmFsdWUgPSBzZWxmKCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpc1BlbmRpbmcgPSBmYWxzZTsKCSAgICAgICAgICAgIGlmIChzZWxmLmlzRGlmZmVyZW50KHByZXZpb3VzVmFsdWUsIHBlbmRpbmdWYWx1ZSkpIHsKCSAgICAgICAgICAgICAgICBzZWxmLl9vcmlnTm90aWZ5U3Vic2NyaWJlcnMocHJldmlvdXNWYWx1ZSA9IHBlbmRpbmdWYWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoKCSAgICAgICAgc2VsZi5fcmF0ZUxpbWl0ZWRDaGFuZ2UgPSBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgICAgICAgaXNQZW5kaW5nID0gdHJ1ZTsKCSAgICAgICAgICAgIHBlbmRpbmdWYWx1ZSA9IHZhbHVlOwoJICAgICAgICAgICAgZmluaXNoKCk7CgkgICAgICAgIH07CgkgICAgICAgIHNlbGYuX3JhdGVMaW1pdGVkQmVmb3JlQ2hhbmdlID0gZnVuY3Rpb24odmFsdWUpIHsKCSAgICAgICAgICAgIGlmICghaXNQZW5kaW5nKSB7CgkgICAgICAgICAgICAgICAgcHJldmlvdXNWYWx1ZSA9IHZhbHVlOwoJICAgICAgICAgICAgICAgIHNlbGYuX29yaWdOb3RpZnlTdWJzY3JpYmVycyh2YWx1ZSwgYmVmb3JlQ2hhbmdlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfTsKCSAgICB9LAoKCSAgICBoYXNTdWJzY3JpcHRpb25zRm9yRXZlbnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CgkgICAgICAgIHJldHVybiB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XSAmJiB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XS5sZW5ndGg7CgkgICAgfSwKCgkgICAgZ2V0U3Vic2NyaXB0aW9uc0NvdW50OiBmdW5jdGlvbiAoKSB7CgkgICAgICAgIHZhciB0b3RhbCA9IDA7CgkgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2godGhpcy5fc3Vic2NyaXB0aW9ucywgZnVuY3Rpb24oZXZlbnROYW1lLCBzdWJzY3JpcHRpb25zKSB7CgkgICAgICAgICAgICB0b3RhbCArPSBzdWJzY3JpcHRpb25zLmxlbmd0aDsKCSAgICAgICAgfSk7CgkgICAgICAgIHJldHVybiB0b3RhbDsKCSAgICB9LAoKCSAgICBpc0RpZmZlcmVudDogZnVuY3Rpb24ob2xkVmFsdWUsIG5ld1ZhbHVlKSB7CgkgICAgICAgIHJldHVybiAhdGhpc1snZXF1YWxpdHlDb21wYXJlciddIHx8ICF0aGlzWydlcXVhbGl0eUNvbXBhcmVyJ10ob2xkVmFsdWUsIG5ld1ZhbHVlKTsKCSAgICB9LAoKCSAgICBleHRlbmQ6IGFwcGx5RXh0ZW5kZXJzCgl9OwoKCWtvLmV4cG9ydFByb3BlcnR5KGtvX3N1YnNjcmliYWJsZV9mbiwgJ3N1YnNjcmliZScsIGtvX3N1YnNjcmliYWJsZV9mbi5zdWJzY3JpYmUpOwoJa28uZXhwb3J0UHJvcGVydHkoa29fc3Vic2NyaWJhYmxlX2ZuLCAnZXh0ZW5kJywga29fc3Vic2NyaWJhYmxlX2ZuLmV4dGVuZCk7Cglrby5leHBvcnRQcm9wZXJ0eShrb19zdWJzY3JpYmFibGVfZm4sICdnZXRTdWJzY3JpcHRpb25zQ291bnQnLCBrb19zdWJzY3JpYmFibGVfZm4uZ2V0U3Vic2NyaXB0aW9uc0NvdW50KTsKCgkvLyBGb3IgYnJvd3NlcnMgdGhhdCBzdXBwb3J0IHByb3RvIGFzc2lnbm1lbnQsIHdlIG92ZXJ3cml0ZSB0aGUgcHJvdG90eXBlIG9mIGVhY2gKCS8vIG9ic2VydmFibGUgaW5zdGFuY2UuIFNpbmNlIG9ic2VydmFibGVzIGFyZSBmdW5jdGlvbnMsIHdlIG5lZWQgRnVuY3Rpb24ucHJvdG90eXBlCgkvLyB0byBzdGlsbCBiZSBpbiB0aGUgcHJvdG90eXBlIGNoYWluLgoJaWYgKGtvLnV0aWxzLmNhblNldFByb3RvdHlwZSkgewoJICAgIGtvLnV0aWxzLnNldFByb3RvdHlwZU9mKGtvX3N1YnNjcmliYWJsZV9mbiwgRnVuY3Rpb24ucHJvdG90eXBlKTsKCX0KCglrby5zdWJzY3JpYmFibGVbJ2ZuJ10gPSBrb19zdWJzY3JpYmFibGVfZm47CgoKCWtvLmlzU3Vic2NyaWJhYmxlID0gZnVuY3Rpb24gKGluc3RhbmNlKSB7CgkgICAgcmV0dXJuIGluc3RhbmNlICE9IG51bGwgJiYgdHlwZW9mIGluc3RhbmNlLnN1YnNjcmliZSA9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBpbnN0YW5jZVsibm90aWZ5U3Vic2NyaWJlcnMiXSA9PSAiZnVuY3Rpb24iOwoJfTsKCglrby5leHBvcnRTeW1ib2woJ3N1YnNjcmliYWJsZScsIGtvLnN1YnNjcmliYWJsZSk7Cglrby5leHBvcnRTeW1ib2woJ2lzU3Vic2NyaWJhYmxlJywga28uaXNTdWJzY3JpYmFibGUpOwoKCWtvLmNvbXB1dGVkQ29udGV4dCA9IGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24gPSAoZnVuY3Rpb24gKCkgewoJICAgIHZhciBvdXRlckZyYW1lcyA9IFtdLAoJICAgICAgICBjdXJyZW50RnJhbWUsCgkgICAgICAgIGxhc3RJZCA9IDA7CgoJICAgIC8vIFJldHVybiBhIHVuaXF1ZSBJRCB0aGF0IGNhbiBiZSBhc3NpZ25lZCB0byBhbiBvYnNlcnZhYmxlIGZvciBkZXBlbmRlbmN5IHRyYWNraW5nLgoJICAgIC8vIFRoZW9yZXRpY2FsbHksIHlvdSBjb3VsZCBldmVudHVhbGx5IG92ZXJmbG93IHRoZSBudW1iZXIgc3RvcmFnZSBzaXplLCByZXN1bHRpbmcKCSAgICAvLyBpbiBkdXBsaWNhdGUgSURzLiBCdXQgaW4gSmF2YVNjcmlwdCwgdGhlIGxhcmdlc3QgZXhhY3QgaW50ZWdyYWwgdmFsdWUgaXMgMl41MwoJICAgIC8vIG9yIDksMDA3LDE5OSwyNTQsNzQwLDk5Mi4gSWYgeW91IGNyZWF0ZWQgMSwwMDAsMDAwIElEcyBwZXIgc2Vjb25kLCBpdCB3b3VsZAoJICAgIC8vIHRha2Ugb3ZlciAyODUgeWVhcnMgdG8gcmVhY2ggdGhhdCBudW1iZXIuCgkgICAgLy8gUmVmZXJlbmNlIGh0dHA6Ly9ibG9nLnZqZXV4LmNvbS8yMDEwL2phdmFzY3JpcHQvamF2YXNjcmlwdC1tYXhfaW50LW51bWJlci1saW1pdHMuaHRtbAoJICAgIGZ1bmN0aW9uIGdldElkKCkgewoJICAgICAgICByZXR1cm4gKytsYXN0SWQ7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBiZWdpbihvcHRpb25zKSB7CgkgICAgICAgIG91dGVyRnJhbWVzLnB1c2goY3VycmVudEZyYW1lKTsKCSAgICAgICAgY3VycmVudEZyYW1lID0gb3B0aW9uczsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGVuZCgpIHsKCSAgICAgICAgY3VycmVudEZyYW1lID0gb3V0ZXJGcmFtZXMucG9wKCk7CgkgICAgfQoKCSAgICByZXR1cm4gewoJICAgICAgICBiZWdpbjogYmVnaW4sCgoJICAgICAgICBlbmQ6IGVuZCwKCgkgICAgICAgIHJlZ2lzdGVyRGVwZW5kZW5jeTogZnVuY3Rpb24gKHN1YnNjcmliYWJsZSkgewoJICAgICAgICAgICAgaWYgKGN1cnJlbnRGcmFtZSkgewoJICAgICAgICAgICAgICAgIGlmICgha28uaXNTdWJzY3JpYmFibGUoc3Vic2NyaWJhYmxlKSkKCSAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPbmx5IHN1YnNjcmliYWJsZSB0aGluZ3MgY2FuIGFjdCBhcyBkZXBlbmRlbmNpZXMiKTsKCSAgICAgICAgICAgICAgICBjdXJyZW50RnJhbWUuY2FsbGJhY2soc3Vic2NyaWJhYmxlLCBzdWJzY3JpYmFibGUuX2lkIHx8IChzdWJzY3JpYmFibGUuX2lkID0gZ2V0SWQoKSkpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgaWdub3JlOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNhbGxiYWNrVGFyZ2V0LCBjYWxsYmFja0FyZ3MpIHsKCSAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgYmVnaW4oKTsKCSAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkoY2FsbGJhY2tUYXJnZXQsIGNhbGxiYWNrQXJncyB8fCBbXSk7CgkgICAgICAgICAgICB9IGZpbmFsbHkgewoJICAgICAgICAgICAgICAgIGVuZCgpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgZ2V0RGVwZW5kZW5jaWVzQ291bnQ6IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgIGlmIChjdXJyZW50RnJhbWUpCgkgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRGcmFtZS5jb21wdXRlZC5nZXREZXBlbmRlbmNpZXNDb3VudCgpOwoJICAgICAgICB9LAoKCSAgICAgICAgaXNJbml0aWFsOiBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIGlmIChjdXJyZW50RnJhbWUpCgkgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRGcmFtZS5pc0luaXRpYWw7CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ2NvbXB1dGVkQ29udGV4dCcsIGtvLmNvbXB1dGVkQ29udGV4dCk7Cglrby5leHBvcnRTeW1ib2woJ2NvbXB1dGVkQ29udGV4dC5nZXREZXBlbmRlbmNpZXNDb3VudCcsIGtvLmNvbXB1dGVkQ29udGV4dC5nZXREZXBlbmRlbmNpZXNDb3VudCk7Cglrby5leHBvcnRTeW1ib2woJ2NvbXB1dGVkQ29udGV4dC5pc0luaXRpYWwnLCBrby5jb21wdXRlZENvbnRleHQuaXNJbml0aWFsKTsKCWtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWRDb250ZXh0LmlzU2xlZXBpbmcnLCBrby5jb21wdXRlZENvbnRleHQuaXNTbGVlcGluZyk7Cglrby5vYnNlcnZhYmxlID0gZnVuY3Rpb24gKGluaXRpYWxWYWx1ZSkgewoJICAgIHZhciBfbGF0ZXN0VmFsdWUgPSBpbml0aWFsVmFsdWU7CgoJICAgIGZ1bmN0aW9uIG9ic2VydmFibGUoKSB7CgkgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMCkgewoJICAgICAgICAgICAgLy8gV3JpdGUKCgkgICAgICAgICAgICAvLyBJZ25vcmUgd3JpdGVzIGlmIHRoZSB2YWx1ZSBoYXNuJ3QgY2hhbmdlZAoJICAgICAgICAgICAgaWYgKG9ic2VydmFibGUuaXNEaWZmZXJlbnQoX2xhdGVzdFZhbHVlLCBhcmd1bWVudHNbMF0pKSB7CgkgICAgICAgICAgICAgICAgb2JzZXJ2YWJsZS52YWx1ZVdpbGxNdXRhdGUoKTsKCSAgICAgICAgICAgICAgICBfbGF0ZXN0VmFsdWUgPSBhcmd1bWVudHNbMF07CgkgICAgICAgICAgICAgICAgaWYgKERFQlVHKSBvYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKCSAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLnZhbHVlSGFzTXV0YXRlZCgpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHRoaXM7IC8vIFBlcm1pdHMgY2hhaW5lZCBhc3NpZ25tZW50cwoJICAgICAgICB9CgkgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgLy8gUmVhZAoJICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5yZWdpc3RlckRlcGVuZGVuY3kob2JzZXJ2YWJsZSk7IC8vIFRoZSBjYWxsZXIgb25seSBuZWVkcyB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIGlmIHRoZXkgZGlkIGEgInJlYWQiIG9wZXJhdGlvbgoJICAgICAgICAgICAgcmV0dXJuIF9sYXRlc3RWYWx1ZTsKCSAgICAgICAgfQoJICAgIH0KCSAgICBrby5zdWJzY3JpYmFibGUuY2FsbChvYnNlcnZhYmxlKTsKCSAgICBrby51dGlscy5zZXRQcm90b3R5cGVPZk9yRXh0ZW5kKG9ic2VydmFibGUsIGtvLm9ic2VydmFibGVbJ2ZuJ10pOwoKCSAgICBpZiAoREVCVUcpIG9ic2VydmFibGUuX2xhdGVzdFZhbHVlID0gX2xhdGVzdFZhbHVlOwoJICAgIG9ic2VydmFibGUucGVlayA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gX2xhdGVzdFZhbHVlIH07CgkgICAgb2JzZXJ2YWJsZS52YWx1ZUhhc011dGF0ZWQgPSBmdW5jdGlvbiAoKSB7IG9ic2VydmFibGVbIm5vdGlmeVN1YnNjcmliZXJzIl0oX2xhdGVzdFZhbHVlKTsgfQoJICAgIG9ic2VydmFibGUudmFsdWVXaWxsTXV0YXRlID0gZnVuY3Rpb24gKCkgeyBvYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOyB9CgoJICAgIGtvLmV4cG9ydFByb3BlcnR5KG9ic2VydmFibGUsICdwZWVrJywgb2JzZXJ2YWJsZS5wZWVrKTsKCSAgICBrby5leHBvcnRQcm9wZXJ0eShvYnNlcnZhYmxlLCAidmFsdWVIYXNNdXRhdGVkIiwgb2JzZXJ2YWJsZS52YWx1ZUhhc011dGF0ZWQpOwoJICAgIGtvLmV4cG9ydFByb3BlcnR5KG9ic2VydmFibGUsICJ2YWx1ZVdpbGxNdXRhdGUiLCBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSk7CgoJICAgIHJldHVybiBvYnNlcnZhYmxlOwoJfQoKCWtvLm9ic2VydmFibGVbJ2ZuJ10gPSB7CgkgICAgImVxdWFsaXR5Q29tcGFyZXIiOiB2YWx1ZXNBcmVQcmltaXRpdmVBbmRFcXVhbAoJfTsKCgl2YXIgcHJvdG9Qcm9wZXJ0eSA9IGtvLm9ic2VydmFibGUucHJvdG9Qcm9wZXJ0eSA9ICJfX2tvX3Byb3RvX18iOwoJa28ub2JzZXJ2YWJsZVsnZm4nXVtwcm90b1Byb3BlcnR5XSA9IGtvLm9ic2VydmFibGU7CgoJLy8gTm90ZSB0aGF0IGZvciBicm93c2VycyB0aGF0IGRvbid0IHN1cHBvcnQgcHJvdG8gYXNzaWdubWVudCwgdGhlCgkvLyBpbmhlcml0YW5jZSBjaGFpbiBpcyBjcmVhdGVkIG1hbnVhbGx5IGluIHRoZSBrby5vYnNlcnZhYmxlIGNvbnN0cnVjdG9yCglpZiAoa28udXRpbHMuY2FuU2V0UHJvdG90eXBlKSB7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2Yoa28ub2JzZXJ2YWJsZVsnZm4nXSwga28uc3Vic2NyaWJhYmxlWydmbiddKTsKCX0KCglrby5oYXNQcm90b3R5cGUgPSBmdW5jdGlvbihpbnN0YW5jZSwgcHJvdG90eXBlKSB7CgkgICAgaWYgKChpbnN0YW5jZSA9PT0gbnVsbCkgfHwgKGluc3RhbmNlID09PSB1bmRlZmluZWQpIHx8IChpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0gdW5kZWZpbmVkKSkgcmV0dXJuIGZhbHNlOwoJICAgIGlmIChpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0gcHJvdG90eXBlKSByZXR1cm4gdHJ1ZTsKCSAgICByZXR1cm4ga28uaGFzUHJvdG90eXBlKGluc3RhbmNlW3Byb3RvUHJvcGVydHldLCBwcm90b3R5cGUpOyAvLyBXYWxrIHRoZSBwcm90b3R5cGUgY2hhaW4KCX07CgoJa28uaXNPYnNlcnZhYmxlID0gZnVuY3Rpb24gKGluc3RhbmNlKSB7CgkgICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28ub2JzZXJ2YWJsZSk7Cgl9Cglrby5pc1dyaXRlYWJsZU9ic2VydmFibGUgPSBmdW5jdGlvbiAoaW5zdGFuY2UpIHsKCSAgICAvLyBPYnNlcnZhYmxlCgkgICAgaWYgKCh0eXBlb2YgaW5zdGFuY2UgPT0gImZ1bmN0aW9uIikgJiYgaW5zdGFuY2VbcHJvdG9Qcm9wZXJ0eV0gPT09IGtvLm9ic2VydmFibGUpCgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgIC8vIFdyaXRlYWJsZSBkZXBlbmRlbnQgb2JzZXJ2YWJsZQoJICAgIGlmICgodHlwZW9mIGluc3RhbmNlID09ICJmdW5jdGlvbiIpICYmIChpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0ga28uZGVwZW5kZW50T2JzZXJ2YWJsZSkgJiYgKGluc3RhbmNlLmhhc1dyaXRlRnVuY3Rpb24pKQoJICAgICAgICByZXR1cm4gdHJ1ZTsKCSAgICAvLyBBbnl0aGluZyBlbHNlCgkgICAgcmV0dXJuIGZhbHNlOwoJfQoKCglrby5leHBvcnRTeW1ib2woJ29ic2VydmFibGUnLCBrby5vYnNlcnZhYmxlKTsKCWtvLmV4cG9ydFN5bWJvbCgnaXNPYnNlcnZhYmxlJywga28uaXNPYnNlcnZhYmxlKTsKCWtvLmV4cG9ydFN5bWJvbCgnaXNXcml0ZWFibGVPYnNlcnZhYmxlJywga28uaXNXcml0ZWFibGVPYnNlcnZhYmxlKTsKCWtvLmV4cG9ydFN5bWJvbCgnaXNXcml0YWJsZU9ic2VydmFibGUnLCBrby5pc1dyaXRlYWJsZU9ic2VydmFibGUpOwoJa28ub2JzZXJ2YWJsZUFycmF5ID0gZnVuY3Rpb24gKGluaXRpYWxWYWx1ZXMpIHsKCSAgICBpbml0aWFsVmFsdWVzID0gaW5pdGlhbFZhbHVlcyB8fCBbXTsKCgkgICAgaWYgKHR5cGVvZiBpbml0aWFsVmFsdWVzICE9ICdvYmplY3QnIHx8ICEoJ2xlbmd0aCcgaW4gaW5pdGlhbFZhbHVlcykpCgkgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGFyZ3VtZW50IHBhc3NlZCB3aGVuIGluaXRpYWxpemluZyBhbiBvYnNlcnZhYmxlIGFycmF5IG11c3QgYmUgYW4gYXJyYXksIG9yIG51bGwsIG9yIHVuZGVmaW5lZC4iKTsKCgkgICAgdmFyIHJlc3VsdCA9IGtvLm9ic2VydmFibGUoaW5pdGlhbFZhbHVlcyk7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2ZPckV4dGVuZChyZXN1bHQsIGtvLm9ic2VydmFibGVBcnJheVsnZm4nXSk7CgkgICAgcmV0dXJuIHJlc3VsdC5leHRlbmQoeyd0cmFja0FycmF5Q2hhbmdlcyc6dHJ1ZX0pOwoJfTsKCglrby5vYnNlcnZhYmxlQXJyYXlbJ2ZuJ10gPSB7CgkgICAgJ3JlbW92ZSc6IGZ1bmN0aW9uICh2YWx1ZU9yUHJlZGljYXRlKSB7CgkgICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzLnBlZWsoKTsKCSAgICAgICAgdmFyIHJlbW92ZWRWYWx1ZXMgPSBbXTsKCSAgICAgICAgdmFyIHByZWRpY2F0ZSA9IHR5cGVvZiB2YWx1ZU9yUHJlZGljYXRlID09ICJmdW5jdGlvbiIgJiYgIWtvLmlzT2JzZXJ2YWJsZSh2YWx1ZU9yUHJlZGljYXRlKSA/IHZhbHVlT3JQcmVkaWNhdGUgOiBmdW5jdGlvbiAodmFsdWUpIHsgcmV0dXJuIHZhbHVlID09PSB2YWx1ZU9yUHJlZGljYXRlOyB9OwoJICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHVuZGVybHlpbmdBcnJheS5sZW5ndGg7IGkrKykgewoJICAgICAgICAgICAgdmFyIHZhbHVlID0gdW5kZXJseWluZ0FycmF5W2ldOwoJICAgICAgICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSkpIHsKCSAgICAgICAgICAgICAgICBpZiAocmVtb3ZlZFZhbHVlcy5sZW5ndGggPT09IDApIHsKCSAgICAgICAgICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgcmVtb3ZlZFZhbHVlcy5wdXNoKHZhbHVlKTsKCSAgICAgICAgICAgICAgICB1bmRlcmx5aW5nQXJyYXkuc3BsaWNlKGksIDEpOwoJICAgICAgICAgICAgICAgIGktLTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICBpZiAocmVtb3ZlZFZhbHVlcy5sZW5ndGgpIHsKCSAgICAgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHJlbW92ZWRWYWx1ZXM7CgkgICAgfSwKCgkgICAgJ3JlbW92ZUFsbCc6IGZ1bmN0aW9uIChhcnJheU9mVmFsdWVzKSB7CgkgICAgICAgIC8vIElmIHlvdSBwYXNzZWQgemVybyBhcmdzLCB3ZSByZW1vdmUgZXZlcnl0aGluZwoJICAgICAgICBpZiAoYXJyYXlPZlZhbHVlcyA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CgkgICAgICAgICAgICB2YXIgYWxsVmFsdWVzID0gdW5kZXJseWluZ0FycmF5LnNsaWNlKDApOwoJICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKCSAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheS5zcGxpY2UoMCwgdW5kZXJseWluZ0FycmF5Lmxlbmd0aCk7CgkgICAgICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwoJICAgICAgICAgICAgcmV0dXJuIGFsbFZhbHVlczsKCSAgICAgICAgfQoJICAgICAgICAvLyBJZiB5b3UgcGFzc2VkIGFuIGFyZywgd2UgaW50ZXJwcmV0IGl0IGFzIGFuIGFycmF5IG9mIGVudHJpZXMgdG8gcmVtb3ZlCgkgICAgICAgIGlmICghYXJyYXlPZlZhbHVlcykKCSAgICAgICAgICAgIHJldHVybiBbXTsKCSAgICAgICAgcmV0dXJuIHRoaXNbJ3JlbW92ZSddKGZ1bmN0aW9uICh2YWx1ZSkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZihhcnJheU9mVmFsdWVzLCB2YWx1ZSkgPj0gMDsKCSAgICAgICAgfSk7CgkgICAgfSwKCgkgICAgJ2Rlc3Ryb3knOiBmdW5jdGlvbiAodmFsdWVPclByZWRpY2F0ZSkgewoJICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcy5wZWVrKCk7CgkgICAgICAgIHZhciBwcmVkaWNhdGUgPSB0eXBlb2YgdmFsdWVPclByZWRpY2F0ZSA9PSAiZnVuY3Rpb24iICYmICFrby5pc09ic2VydmFibGUodmFsdWVPclByZWRpY2F0ZSkgPyB2YWx1ZU9yUHJlZGljYXRlIDogZnVuY3Rpb24gKHZhbHVlKSB7IHJldHVybiB2YWx1ZSA9PT0gdmFsdWVPclByZWRpY2F0ZTsgfTsKCSAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKCSAgICAgICAgZm9yICh2YXIgaSA9IHVuZGVybHlpbmdBcnJheS5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewoJICAgICAgICAgICAgdmFyIHZhbHVlID0gdW5kZXJseWluZ0FycmF5W2ldOwoJICAgICAgICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSkpCgkgICAgICAgICAgICAgICAgdW5kZXJseWluZ0FycmF5W2ldWyJfZGVzdHJveSJdID0gdHJ1ZTsKCSAgICAgICAgfQoJICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwoJICAgIH0sCgoJICAgICdkZXN0cm95QWxsJzogZnVuY3Rpb24gKGFycmF5T2ZWYWx1ZXMpIHsKCSAgICAgICAgLy8gSWYgeW91IHBhc3NlZCB6ZXJvIGFyZ3MsIHdlIGRlc3Ryb3kgZXZlcnl0aGluZwoJICAgICAgICBpZiAoYXJyYXlPZlZhbHVlcyA9PT0gdW5kZWZpbmVkKQoJICAgICAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbigpIHsgcmV0dXJuIHRydWUgfSk7CgoJICAgICAgICAvLyBJZiB5b3UgcGFzc2VkIGFuIGFyZywgd2UgaW50ZXJwcmV0IGl0IGFzIGFuIGFycmF5IG9mIGVudHJpZXMgdG8gZGVzdHJveQoJICAgICAgICBpZiAoIWFycmF5T2ZWYWx1ZXMpCgkgICAgICAgICAgICByZXR1cm4gW107CgkgICAgICAgIHJldHVybiB0aGlzWydkZXN0cm95J10oZnVuY3Rpb24gKHZhbHVlKSB7CgkgICAgICAgICAgICByZXR1cm4ga28udXRpbHMuYXJyYXlJbmRleE9mKGFycmF5T2ZWYWx1ZXMsIHZhbHVlKSA+PSAwOwoJICAgICAgICB9KTsKCSAgICB9LAoKCSAgICAnaW5kZXhPZic6IGZ1bmN0aW9uIChpdGVtKSB7CgkgICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzKCk7CgkgICAgICAgIHJldHVybiBrby51dGlscy5hcnJheUluZGV4T2YodW5kZXJseWluZ0FycmF5LCBpdGVtKTsKCSAgICB9LAoKCSAgICAncmVwbGFjZSc6IGZ1bmN0aW9uKG9sZEl0ZW0sIG5ld0l0ZW0pIHsKCSAgICAgICAgdmFyIGluZGV4ID0gdGhpc1snaW5kZXhPZiddKG9sZEl0ZW0pOwoJICAgICAgICBpZiAoaW5kZXggPj0gMCkgewoJICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKCSAgICAgICAgICAgIHRoaXMucGVlaygpW2luZGV4XSA9IG5ld0l0ZW07CgkgICAgICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwoJICAgICAgICB9CgkgICAgfQoJfTsKCgkvLyBQb3B1bGF0ZSBrby5vYnNlcnZhYmxlQXJyYXkuZm4gd2l0aCByZWFkL3dyaXRlIGZ1bmN0aW9ucyBmcm9tIG5hdGl2ZSBhcnJheXMKCS8vIEltcG9ydGFudDogRG8gbm90IGFkZCBhbnkgYWRkaXRpb25hbCBmdW5jdGlvbnMgaGVyZSB0aGF0IG1heSByZWFzb25hYmx5IGJlIHVzZWQgdG8gKnJlYWQqIGRhdGEgZnJvbSB0aGUgYXJyYXkKCS8vIGJlY2F1c2Ugd2UnbGwgZXZhbCB0aGVtIHdpdGhvdXQgY2F1c2luZyBzdWJzY3JpcHRpb25zLCBzbyBrby5jb21wdXRlZCBvdXRwdXQgY291bGQgZW5kIHVwIGdldHRpbmcgc3RhbGUKCWtvLnV0aWxzLmFycmF5Rm9yRWFjaChbInBvcCIsICJwdXNoIiwgInJldmVyc2UiLCAic2hpZnQiLCAic29ydCIsICJzcGxpY2UiLCAidW5zaGlmdCJdLCBmdW5jdGlvbiAobWV0aG9kTmFtZSkgewoJICAgIGtvLm9ic2VydmFibGVBcnJheVsnZm4nXVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgLy8gVXNlICJwZWVrIiB0byBhdm9pZCBjcmVhdGluZyBhIHN1YnNjcmlwdGlvbiBpbiBhbnkgY29tcHV0ZWQgdGhhdCB3ZSdyZSBleGVjdXRpbmcgaW4gdGhlIGNvbnRleHQgb2YKCSAgICAgICAgLy8gKGZvciBjb25zaXN0ZW5jeSB3aXRoIG11dGF0aW5nIHJlZ3VsYXIgb2JzZXJ2YWJsZXMpCgkgICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzLnBlZWsoKTsKCSAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKCSAgICAgICAgdGhpcy5jYWNoZURpZmZGb3JLbm93bk9wZXJhdGlvbih1bmRlcmx5aW5nQXJyYXksIG1ldGhvZE5hbWUsIGFyZ3VtZW50cyk7CgkgICAgICAgIHZhciBtZXRob2RDYWxsUmVzdWx0ID0gdW5kZXJseWluZ0FycmF5W21ldGhvZE5hbWVdLmFwcGx5KHVuZGVybHlpbmdBcnJheSwgYXJndW1lbnRzKTsKCSAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKCSAgICAgICAgcmV0dXJuIG1ldGhvZENhbGxSZXN1bHQ7CgkgICAgfTsKCX0pOwoKCS8vIFBvcHVsYXRlIGtvLm9ic2VydmFibGVBcnJheS5mbiB3aXRoIHJlYWQtb25seSBmdW5jdGlvbnMgZnJvbSBuYXRpdmUgYXJyYXlzCglrby51dGlscy5hcnJheUZvckVhY2goWyJzbGljZSJdLCBmdW5jdGlvbiAobWV0aG9kTmFtZSkgewoJICAgIGtvLm9ic2VydmFibGVBcnJheVsnZm4nXVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgdmFyIHVuZGVybHlpbmdBcnJheSA9IHRoaXMoKTsKCSAgICAgICAgcmV0dXJuIHVuZGVybHlpbmdBcnJheVttZXRob2ROYW1lXS5hcHBseSh1bmRlcmx5aW5nQXJyYXksIGFyZ3VtZW50cyk7CgkgICAgfTsKCX0pOwoKCS8vIE5vdGUgdGhhdCBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IHByb3RvIGFzc2lnbm1lbnQsIHRoZQoJLy8gaW5oZXJpdGFuY2UgY2hhaW4gaXMgY3JlYXRlZCBtYW51YWxseSBpbiB0aGUga28ub2JzZXJ2YWJsZUFycmF5IGNvbnN0cnVjdG9yCglpZiAoa28udXRpbHMuY2FuU2V0UHJvdG90eXBlKSB7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2Yoa28ub2JzZXJ2YWJsZUFycmF5WydmbiddLCBrby5vYnNlcnZhYmxlWydmbiddKTsKCX0KCglrby5leHBvcnRTeW1ib2woJ29ic2VydmFibGVBcnJheScsIGtvLm9ic2VydmFibGVBcnJheSk7Cgl2YXIgYXJyYXlDaGFuZ2VFdmVudE5hbWUgPSAnYXJyYXlDaGFuZ2UnOwoJa28uZXh0ZW5kZXJzWyd0cmFja0FycmF5Q2hhbmdlcyddID0gZnVuY3Rpb24odGFyZ2V0KSB7CgkgICAgLy8gT25seSBtb2RpZnkgdGhlIHRhcmdldCBvYnNlcnZhYmxlIG9uY2UKCSAgICBpZiAodGFyZ2V0LmNhY2hlRGlmZkZvcktub3duT3BlcmF0aW9uKSB7CgkgICAgICAgIHJldHVybjsKCSAgICB9CgkgICAgdmFyIHRyYWNraW5nQ2hhbmdlcyA9IGZhbHNlLAoJICAgICAgICBjYWNoZWREaWZmID0gbnVsbCwKCSAgICAgICAgcGVuZGluZ05vdGlmaWNhdGlvbnMgPSAwLAoJICAgICAgICB1bmRlcmx5aW5nU3Vic2NyaWJlRnVuY3Rpb24gPSB0YXJnZXQuc3Vic2NyaWJlOwoKCSAgICAvLyBJbnRlcmNlcHQgInN1YnNjcmliZSIgY2FsbHMsIGFuZCBmb3IgYXJyYXkgY2hhbmdlIGV2ZW50cywgZW5zdXJlIGNoYW5nZSB0cmFja2luZyBpcyBlbmFibGVkCgkgICAgdGFyZ2V0LnN1YnNjcmliZSA9IHRhcmdldFsnc3Vic2NyaWJlJ10gPSBmdW5jdGlvbihjYWxsYmFjaywgY2FsbGJhY2tUYXJnZXQsIGV2ZW50KSB7CgkgICAgICAgIGlmIChldmVudCA9PT0gYXJyYXlDaGFuZ2VFdmVudE5hbWUpIHsKCSAgICAgICAgICAgIHRyYWNrQ2hhbmdlcygpOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiB1bmRlcmx5aW5nU3Vic2NyaWJlRnVuY3Rpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICB9OwoKCSAgICBmdW5jdGlvbiB0cmFja0NoYW5nZXMoKSB7CgkgICAgICAgIC8vIENhbGxpbmcgJ3RyYWNrQ2hhbmdlcycgbXVsdGlwbGUgdGltZXMgaXMgdGhlIHNhbWUgYXMgY2FsbGluZyBpdCBvbmNlCgkgICAgICAgIGlmICh0cmFja2luZ0NoYW5nZXMpIHsKCSAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoKCSAgICAgICAgdHJhY2tpbmdDaGFuZ2VzID0gdHJ1ZTsKCgkgICAgICAgIC8vIEludGVyY2VwdCAibm90aWZ5U3Vic2NyaWJlcnMiIHRvIHRyYWNrIGhvdyBtYW55IHRpbWVzIGl0IHdhcyBjYWxsZWQuCgkgICAgICAgIHZhciB1bmRlcmx5aW5nTm90aWZ5U3Vic2NyaWJlcnNGdW5jdGlvbiA9IHRhcmdldFsnbm90aWZ5U3Vic2NyaWJlcnMnXTsKCSAgICAgICAgdGFyZ2V0Wydub3RpZnlTdWJzY3JpYmVycyddID0gZnVuY3Rpb24odmFsdWVUb05vdGlmeSwgZXZlbnQpIHsKCSAgICAgICAgICAgIGlmICghZXZlbnQgfHwgZXZlbnQgPT09IGRlZmF1bHRFdmVudCkgewoJICAgICAgICAgICAgICAgICsrcGVuZGluZ05vdGlmaWNhdGlvbnM7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdW5kZXJseWluZ05vdGlmeVN1YnNjcmliZXJzRnVuY3Rpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgICAgfTsKCgkgICAgICAgIC8vIEVhY2ggdGltZSB0aGUgYXJyYXkgY2hhbmdlcyB2YWx1ZSwgY2FwdHVyZSBhIGNsb25lIHNvIHRoYXQgb24gdGhlIG5leHQKCSAgICAgICAgLy8gY2hhbmdlIGl0J3MgcG9zc2libGUgdG8gcHJvZHVjZSBhIGRpZmYKCSAgICAgICAgdmFyIHByZXZpb3VzQ29udGVudHMgPSBbXS5jb25jYXQodGFyZ2V0LnBlZWsoKSB8fCBbXSk7CgkgICAgICAgIGNhY2hlZERpZmYgPSBudWxsOwoJICAgICAgICB0YXJnZXQuc3Vic2NyaWJlKGZ1bmN0aW9uKGN1cnJlbnRDb250ZW50cykgewoJICAgICAgICAgICAgLy8gTWFrZSBhIGNvcHkgb2YgdGhlIGN1cnJlbnQgY29udGVudHMgYW5kIGVuc3VyZSBpdCdzIGFuIGFycmF5CgkgICAgICAgICAgICBjdXJyZW50Q29udGVudHMgPSBbXS5jb25jYXQoY3VycmVudENvbnRlbnRzIHx8IFtdKTsKCgkgICAgICAgICAgICAvLyBDb21wdXRlIHRoZSBkaWZmIGFuZCBpc3N1ZSBub3RpZmljYXRpb25zLCBidXQgb25seSBpZiBzb21lb25lIGlzIGxpc3RlbmluZwoJICAgICAgICAgICAgaWYgKHRhcmdldC5oYXNTdWJzY3JpcHRpb25zRm9yRXZlbnQoYXJyYXlDaGFuZ2VFdmVudE5hbWUpKSB7CgkgICAgICAgICAgICAgICAgdmFyIGNoYW5nZXMgPSBnZXRDaGFuZ2VzKHByZXZpb3VzQ29udGVudHMsIGN1cnJlbnRDb250ZW50cyk7CgkgICAgICAgICAgICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgICAgIHRhcmdldFsnbm90aWZ5U3Vic2NyaWJlcnMnXShjaGFuZ2VzLCBhcnJheUNoYW5nZUV2ZW50TmFtZSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIC8vIEVsaW1pbmF0ZSByZWZlcmVuY2VzIHRvIHRoZSBvbGQsIHJlbW92ZWQgaXRlbXMsIHNvIHRoZXkgY2FuIGJlIEdDZWQKCSAgICAgICAgICAgIHByZXZpb3VzQ29udGVudHMgPSBjdXJyZW50Q29udGVudHM7CgkgICAgICAgICAgICBjYWNoZWREaWZmID0gbnVsbDsKCSAgICAgICAgICAgIHBlbmRpbmdOb3RpZmljYXRpb25zID0gMDsKCSAgICAgICAgfSk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBnZXRDaGFuZ2VzKHByZXZpb3VzQ29udGVudHMsIGN1cnJlbnRDb250ZW50cykgewoJICAgICAgICAvLyBXZSB0cnkgdG8gcmUtdXNlIGNhY2hlZCBkaWZmcy4KCSAgICAgICAgLy8gVGhlIHNjZW5hcmlvcyB3aGVyZSBwZW5kaW5nTm90aWZpY2F0aW9ucyA+IDEgYXJlIHdoZW4gdXNpbmcgcmF0ZS1saW1pdGluZyBvciB0aGUgRGVmZXJyZWQgVXBkYXRlcwoJICAgICAgICAvLyBwbHVnaW4sIHdoaWNoIHdpdGhvdXQgdGhpcyBjaGVjayB3b3VsZCBub3QgYmUgY29tcGF0aWJsZSB3aXRoIGFycmF5Q2hhbmdlIG5vdGlmaWNhdGlvbnMuIE5vcm1hbGx5LAoJICAgICAgICAvLyBub3RpZmljYXRpb25zIGFyZSBpc3N1ZWQgaW1tZWRpYXRlbHkgc28gd2Ugd291bGRuJ3QgYmUgcXVldWVpbmcgdXAgbW9yZSB0aGFuIG9uZS4KCSAgICAgICAgaWYgKCFjYWNoZWREaWZmIHx8IHBlbmRpbmdOb3RpZmljYXRpb25zID4gMSkgewoJICAgICAgICAgICAgY2FjaGVkRGlmZiA9IGtvLnV0aWxzLmNvbXBhcmVBcnJheXMocHJldmlvdXNDb250ZW50cywgY3VycmVudENvbnRlbnRzLCB7ICdzcGFyc2UnOiB0cnVlIH0pOwoJICAgICAgICB9CgoJICAgICAgICByZXR1cm4gY2FjaGVkRGlmZjsKCSAgICB9CgoJICAgIHRhcmdldC5jYWNoZURpZmZGb3JLbm93bk9wZXJhdGlvbiA9IGZ1bmN0aW9uKHJhd0FycmF5LCBvcGVyYXRpb25OYW1lLCBhcmdzKSB7CgkgICAgICAgIC8vIE9ubHkgcnVuIGlmIHdlJ3JlIGN1cnJlbnRseSB0cmFja2luZyBjaGFuZ2VzIGZvciB0aGlzIG9ic2VydmFibGUgYXJyYXkKCSAgICAgICAgLy8gYW5kIHRoZXJlIGFyZW4ndCBhbnkgcGVuZGluZyBkZWZlcnJlZCBub3RpZmljYXRpb25zLgoJICAgICAgICBpZiAoIXRyYWNraW5nQ2hhbmdlcyB8fCBwZW5kaW5nTm90aWZpY2F0aW9ucykgewoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgkgICAgICAgIHZhciBkaWZmID0gW10sCgkgICAgICAgICAgICBhcnJheUxlbmd0aCA9IHJhd0FycmF5Lmxlbmd0aCwKCSAgICAgICAgICAgIGFyZ3NMZW5ndGggPSBhcmdzLmxlbmd0aCwKCSAgICAgICAgICAgIG9mZnNldCA9IDA7CgoJICAgICAgICBmdW5jdGlvbiBwdXNoRGlmZihzdGF0dXMsIHZhbHVlLCBpbmRleCkgewoJICAgICAgICAgICAgcmV0dXJuIGRpZmZbZGlmZi5sZW5ndGhdID0geyAnc3RhdHVzJzogc3RhdHVzLCAndmFsdWUnOiB2YWx1ZSwgJ2luZGV4JzogaW5kZXggfTsKCSAgICAgICAgfQoJICAgICAgICBzd2l0Y2ggKG9wZXJhdGlvbk5hbWUpIHsKCSAgICAgICAgICAgIGNhc2UgJ3B1c2gnOgoJICAgICAgICAgICAgICAgIG9mZnNldCA9IGFycmF5TGVuZ3RoOwoJICAgICAgICAgICAgY2FzZSAndW5zaGlmdCc6CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IGFyZ3NMZW5ndGg7IGluZGV4KyspIHsKCSAgICAgICAgICAgICAgICAgICAgcHVzaERpZmYoJ2FkZGVkJywgYXJnc1tpbmRleF0sIG9mZnNldCArIGluZGV4KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgYnJlYWs7CgoJICAgICAgICAgICAgY2FzZSAncG9wJzoKCSAgICAgICAgICAgICAgICBvZmZzZXQgPSBhcnJheUxlbmd0aCAtIDE7CgkgICAgICAgICAgICBjYXNlICdzaGlmdCc6CgkgICAgICAgICAgICAgICAgaWYgKGFycmF5TGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgICAgIHB1c2hEaWZmKCdkZWxldGVkJywgcmF3QXJyYXlbb2Zmc2V0XSwgb2Zmc2V0KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgYnJlYWs7CgoJICAgICAgICAgICAgY2FzZSAnc3BsaWNlJzoKCSAgICAgICAgICAgICAgICAvLyBOZWdhdGl2ZSBzdGFydCBpbmRleCBtZWFucyAnZnJvbSBlbmQgb2YgYXJyYXknLiBBZnRlciB0aGF0IHdlIGNsYW1wIHRvIFswLi4uYXJyYXlMZW5ndGhdLgoJICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9BcnJheS9zcGxpY2UKCSAgICAgICAgICAgICAgICB2YXIgc3RhcnRJbmRleCA9IE1hdGgubWluKE1hdGgubWF4KDAsIGFyZ3NbMF0gPCAwID8gYXJyYXlMZW5ndGggKyBhcmdzWzBdIDogYXJnc1swXSksIGFycmF5TGVuZ3RoKSwKCSAgICAgICAgICAgICAgICAgICAgZW5kRGVsZXRlSW5kZXggPSBhcmdzTGVuZ3RoID09PSAxID8gYXJyYXlMZW5ndGggOiBNYXRoLm1pbihzdGFydEluZGV4ICsgKGFyZ3NbMV0gfHwgMCksIGFycmF5TGVuZ3RoKSwKCSAgICAgICAgICAgICAgICAgICAgZW5kQWRkSW5kZXggPSBzdGFydEluZGV4ICsgYXJnc0xlbmd0aCAtIDIsCgkgICAgICAgICAgICAgICAgICAgIGVuZEluZGV4ID0gTWF0aC5tYXgoZW5kRGVsZXRlSW5kZXgsIGVuZEFkZEluZGV4KSwKCSAgICAgICAgICAgICAgICAgICAgYWRkaXRpb25zID0gW10sIGRlbGV0aW9ucyA9IFtdOwoJICAgICAgICAgICAgICAgIGZvciAodmFyIGluZGV4ID0gc3RhcnRJbmRleCwgYXJnc0luZGV4ID0gMjsgaW5kZXggPCBlbmRJbmRleDsgKytpbmRleCwgKythcmdzSW5kZXgpIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4IDwgZW5kRGVsZXRlSW5kZXgpCgkgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChwdXNoRGlmZignZGVsZXRlZCcsIHJhd0FycmF5W2luZGV4XSwgaW5kZXgpKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4IDwgZW5kQWRkSW5kZXgpCgkgICAgICAgICAgICAgICAgICAgICAgICBhZGRpdGlvbnMucHVzaChwdXNoRGlmZignYWRkZWQnLCBhcmdzW2FyZ3NJbmRleF0sIGluZGV4KSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLmZpbmRNb3Zlc0luQXJyYXlDb21wYXJpc29uKGRlbGV0aW9ucywgYWRkaXRpb25zKTsKCSAgICAgICAgICAgICAgICBicmVhazsKCgkgICAgICAgICAgICBkZWZhdWx0OgoJICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgICAgICBjYWNoZWREaWZmID0gZGlmZjsKCSAgICB9OwoJfTsKCWtvLmNvbXB1dGVkID0ga28uZGVwZW5kZW50T2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucywgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQsIG9wdGlvbnMpIHsKCSAgICB2YXIgX2xhdGVzdFZhbHVlLAoJICAgICAgICBfbmVlZHNFdmFsdWF0aW9uID0gdHJ1ZSwKCSAgICAgICAgX2lzQmVpbmdFdmFsdWF0ZWQgPSBmYWxzZSwKCSAgICAgICAgX3N1cHByZXNzRGlzcG9zYWxVbnRpbERpc3Bvc2VXaGVuUmV0dXJuc0ZhbHNlID0gZmFsc2UsCgkgICAgICAgIF9pc0Rpc3Bvc2VkID0gZmFsc2UsCgkgICAgICAgIHJlYWRGdW5jdGlvbiA9IGV2YWx1YXRvckZ1bmN0aW9uT3JPcHRpb25zLAoJICAgICAgICBwdXJlID0gZmFsc2UsCgkgICAgICAgIGlzU2xlZXBpbmcgPSBmYWxzZTsKCgkgICAgaWYgKHJlYWRGdW5jdGlvbiAmJiB0eXBlb2YgcmVhZEZ1bmN0aW9uID09ICJvYmplY3QiKSB7CgkgICAgICAgIC8vIFNpbmdsZS1wYXJhbWV0ZXIgc3ludGF4IC0gZXZlcnl0aGluZyBpcyBvbiB0aGlzICJvcHRpb25zIiBwYXJhbQoJICAgICAgICBvcHRpb25zID0gcmVhZEZ1bmN0aW9uOwoJICAgICAgICByZWFkRnVuY3Rpb24gPSBvcHRpb25zWyJyZWFkIl07CgkgICAgfSBlbHNlIHsKCSAgICAgICAgLy8gTXVsdGktcGFyYW1ldGVyIHN5bnRheCAtIGNvbnN0cnVjdCB0aGUgb3B0aW9ucyBhY2NvcmRpbmcgdG8gdGhlIHBhcmFtcyBwYXNzZWQKCSAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkgICAgICAgIGlmICghcmVhZEZ1bmN0aW9uKQoJICAgICAgICAgICAgcmVhZEZ1bmN0aW9uID0gb3B0aW9uc1sicmVhZCJdOwoJICAgIH0KCSAgICBpZiAodHlwZW9mIHJlYWRGdW5jdGlvbiAhPSAiZnVuY3Rpb24iKQoJICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBhc3MgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBrby5jb21wdXRlZCIpOwoKCSAgICBmdW5jdGlvbiBhZGRTdWJzY3JpcHRpb25Ub0RlcGVuZGVuY3koc3Vic2NyaWJhYmxlLCBpZCkgewoJICAgICAgICBpZiAoIV9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXNbaWRdKSB7CgkgICAgICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzW2lkXSA9IHN1YnNjcmliYWJsZS5zdWJzY3JpYmUoZXZhbHVhdGVQb3NzaWJseUFzeW5jKTsKCSAgICAgICAgICAgICsrX2RlcGVuZGVuY2llc0NvdW50OwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCkgewoJICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMsIGZ1bmN0aW9uIChpZCwgc3Vic2NyaXB0aW9uKSB7CgkgICAgICAgICAgICBzdWJzY3JpcHRpb24uZGlzcG9zZSgpOwoJICAgICAgICB9KTsKCSAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcyA9IHt9OwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZGlzcG9zZUNvbXB1dGVkKCkgewoJICAgICAgICBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCk7CgkgICAgICAgIF9kZXBlbmRlbmNpZXNDb3VudCA9IDA7CgkgICAgICAgIF9pc0Rpc3Bvc2VkID0gdHJ1ZTsKCSAgICAgICAgX25lZWRzRXZhbHVhdGlvbiA9IGZhbHNlOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZXZhbHVhdGVQb3NzaWJseUFzeW5jKCkgewoJICAgICAgICB2YXIgdGhyb3R0bGVFdmFsdWF0aW9uVGltZW91dCA9IGRlcGVuZGVudE9ic2VydmFibGVbJ3Rocm90dGxlRXZhbHVhdGlvbiddOwoJICAgICAgICBpZiAodGhyb3R0bGVFdmFsdWF0aW9uVGltZW91dCAmJiB0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0ID49IDApIHsKCSAgICAgICAgICAgIGNsZWFyVGltZW91dChldmFsdWF0aW9uVGltZW91dEluc3RhbmNlKTsKCSAgICAgICAgICAgIGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGV2YWx1YXRlSW1tZWRpYXRlLCB0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0KTsKCSAgICAgICAgfSBlbHNlIGlmIChkZXBlbmRlbnRPYnNlcnZhYmxlLl9ldmFsUmF0ZUxpbWl0ZWQpIHsKCSAgICAgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGUuX2V2YWxSYXRlTGltaXRlZCgpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gZXZhbHVhdGVJbW1lZGlhdGUoc3VwcHJlc3NDaGFuZ2VOb3RpZmljYXRpb24pIHsKCSAgICAgICAgaWYgKF9pc0JlaW5nRXZhbHVhdGVkKSB7CgkgICAgICAgICAgICBpZiAocHVyZSkgewoJICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJBICdwdXJlJyBjb21wdXRlZCBtdXN0IG5vdCBiZSBjYWxsZWQgcmVjdXJzaXZlbHkiKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIC8vIElmIHRoZSBldmFsdWF0aW9uIG9mIGEga28uY29tcHV0ZWQgY2F1c2VzIHNpZGUgZWZmZWN0cywgaXQncyBwb3NzaWJsZSB0aGF0IGl0IHdpbGwgdHJpZ2dlciBpdHMgb3duIHJlLWV2YWx1YXRpb24uCgkgICAgICAgICAgICAvLyBUaGlzIGlzIG5vdCBkZXNpcmFibGUgKGl0J3MgaGFyZCBmb3IgYSBkZXZlbG9wZXIgdG8gcmVhbGlzZSBhIGNoYWluIG9mIGRlcGVuZGVuY2llcyBtaWdodCBjYXVzZSB0aGlzLCBhbmQgdGhleSBhbG1vc3QKCSAgICAgICAgICAgIC8vIGNlcnRhaW5seSBkaWRuJ3QgaW50ZW5kIGluZmluaXRlIHJlLWV2YWx1YXRpb25zKS4gU28sIGZvciBwcmVkaWN0YWJpbGl0eSwgd2Ugc2ltcGx5IHByZXZlbnQga28uY29tcHV0ZWRzIGZyb20gY2F1c2luZwoJICAgICAgICAgICAgLy8gdGhlaXIgb3duIHJlLWV2YWx1YXRpb24uIEZ1cnRoZXIgZGlzY3Vzc2lvbiBhdCBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvcHVsbC8zODcKCSAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gRG8gbm90IGV2YWx1YXRlIChhbmQgcG9zc2libHkgY2FwdHVyZSBuZXcgZGVwZW5kZW5jaWVzKSBpZiBkaXNwb3NlZAoJICAgICAgICBpZiAoX2lzRGlzcG9zZWQpIHsKCSAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoKCSAgICAgICAgaWYgKGRpc3Bvc2VXaGVuICYmIGRpc3Bvc2VXaGVuKCkpIHsKCSAgICAgICAgICAgIC8vIFNlZSBjb21tZW50IGJlbG93IGFib3V0IF9zdXBwcmVzc0Rpc3Bvc2FsVW50aWxEaXNwb3NlV2hlblJldHVybnNGYWxzZQoJICAgICAgICAgICAgaWYgKCFfc3VwcHJlc3NEaXNwb3NhbFVudGlsRGlzcG9zZVdoZW5SZXR1cm5zRmFsc2UpIHsKCSAgICAgICAgICAgICAgICBkaXNwb3NlKCk7CgkgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgfQoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgLy8gSXQganVzdCBkaWQgcmV0dXJuIGZhbHNlLCBzbyB3ZSBjYW4gc3RvcCBzdXBwcmVzc2luZyBub3cKCSAgICAgICAgICAgIF9zdXBwcmVzc0Rpc3Bvc2FsVW50aWxEaXNwb3NlV2hlblJldHVybnNGYWxzZSA9IGZhbHNlOwoJICAgICAgICB9CgoJICAgICAgICBfaXNCZWluZ0V2YWx1YXRlZCA9IHRydWU7CgoJICAgICAgICAvLyBXaGVuIHNsZWVwaW5nLCByZWNhbGN1bGF0ZSB0aGUgdmFsdWUgYW5kIHJldHVybi4KCSAgICAgICAgaWYgKGlzU2xlZXBpbmcpIHsKCSAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgdmFyIGRlcGVuZGVuY3lUcmFja2luZyA9IHt9OwoJICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uYmVnaW4oewoJICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24gKHN1YnNjcmliYWJsZSwgaWQpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZGVwZW5kZW5jeVRyYWNraW5nW2lkXSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lUcmFja2luZ1tpZF0gPSAxOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICsrX2RlcGVuZGVuY2llc0NvdW50OwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICB9LAoJICAgICAgICAgICAgICAgICAgICBjb21wdXRlZDogZGVwZW5kZW50T2JzZXJ2YWJsZSwKCSAgICAgICAgICAgICAgICAgICAgaXNJbml0aWFsOiB1bmRlZmluZWQKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICBfZGVwZW5kZW5jaWVzQ291bnQgPSAwOwoJICAgICAgICAgICAgICAgIF9sYXRlc3RWYWx1ZSA9IHJlYWRGdW5jdGlvbi5jYWxsKGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0KTsKCSAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5lbmQoKTsKCSAgICAgICAgICAgICAgICBfaXNCZWluZ0V2YWx1YXRlZCA9IGZhbHNlOwoJICAgICAgICAgICAgfQoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICAvLyBJbml0aWFsbHksIHdlIGFzc3VtZSB0aGF0IG5vbmUgb2YgdGhlIHN1YnNjcmlwdGlvbnMgYXJlIHN0aWxsIGJlaW5nIHVzZWQgKGkuZS4sIGFsbCBhcmUgY2FuZGlkYXRlcyBmb3IgZGlzcG9zYWwpLgoJICAgICAgICAgICAgICAgIC8vIFRoZW4sIGR1cmluZyBldmFsdWF0aW9uLCB3ZSBjcm9zcyBvZmYgYW55IHRoYXQgYXJlIGluIGZhY3Qgc3RpbGwgYmVpbmcgdXNlZC4KCSAgICAgICAgICAgICAgICB2YXIgZGlzcG9zYWxDYW5kaWRhdGVzID0gX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcywgZGlzcG9zYWxDb3VudCA9IF9kZXBlbmRlbmNpZXNDb3VudDsKCSAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmJlZ2luKHsKCSAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uKHN1YnNjcmliYWJsZSwgaWQpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmICghX2lzRGlzcG9zZWQpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzcG9zYWxDb3VudCAmJiBkaXNwb3NhbENhbmRpZGF0ZXNbaWRdKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvbid0IHdhbnQgdG8gZGlzcG9zZSB0aGlzIHN1YnNjcmlwdGlvbiwgYXMgaXQncyBzdGlsbCBiZWluZyB1c2VkCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXNbaWRdID0gZGlzcG9zYWxDYW5kaWRhdGVzW2lkXTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKytfZGVwZW5kZW5jaWVzQ291bnQ7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkaXNwb3NhbENhbmRpZGF0ZXNbaWRdOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtLWRpc3Bvc2FsQ291bnQ7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQnJhbmQgbmV3IHN1YnNjcmlwdGlvbiAtIGFkZCBpdAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRTdWJzY3JpcHRpb25Ub0RlcGVuZGVuY3koc3Vic2NyaWJhYmxlLCBpZCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICB9LAoJICAgICAgICAgICAgICAgICAgICBjb21wdXRlZDogZGVwZW5kZW50T2JzZXJ2YWJsZSwKCSAgICAgICAgICAgICAgICAgICAgaXNJbml0aWFsOiBwdXJlID8gdW5kZWZpbmVkIDogIV9kZXBlbmRlbmNpZXNDb3VudCAgICAgICAgLy8gSWYgd2UncmUgZXZhbHVhdGluZyB3aGVuIHRoZXJlIGFyZSBubyBwcmV2aW91cyBkZXBlbmRlbmNpZXMsIGl0IG11c3QgYmUgdGhlIGZpcnN0IHRpbWUKCSAgICAgICAgICAgICAgICB9KTsKCgkgICAgICAgICAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcyA9IHt9OwoJICAgICAgICAgICAgICAgIF9kZXBlbmRlbmNpZXNDb3VudCA9IDA7CgoJICAgICAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0ID8gcmVhZEZ1bmN0aW9uLmNhbGwoZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpIDogcmVhZEZ1bmN0aW9uKCk7CgoJICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uZW5kKCk7CgoJICAgICAgICAgICAgICAgICAgICAvLyBGb3IgZWFjaCBzdWJzY3JpcHRpb24gbm8gbG9uZ2VyIGJlaW5nIHVzZWQsIHJlbW92ZSBpdCBmcm9tIHRoZSBhY3RpdmUgc3Vic2NyaXB0aW9ucyBsaXN0IGFuZCBkaXNwb3NlIGl0CgkgICAgICAgICAgICAgICAgICAgIGlmIChkaXNwb3NhbENvdW50KSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKGRpc3Bvc2FsQ2FuZGlkYXRlcywgZnVuY3Rpb24oaWQsIHRvRGlzcG9zZSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvRGlzcG9zZS5kaXNwb3NlKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAgICAgX25lZWRzRXZhbHVhdGlvbiA9IGZhbHNlOwoJICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgaWYgKGRlcGVuZGVudE9ic2VydmFibGUuaXNEaWZmZXJlbnQoX2xhdGVzdFZhbHVlLCBuZXdWYWx1ZSkpIHsKCSAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZVsibm90aWZ5U3Vic2NyaWJlcnMiXShfbGF0ZXN0VmFsdWUsICJiZWZvcmVDaGFuZ2UiKTsKCgkgICAgICAgICAgICAgICAgICAgIF9sYXRlc3RWYWx1ZSA9IG5ld1ZhbHVlOwoJICAgICAgICAgICAgICAgICAgICBpZiAoREVCVUcpIGRlcGVuZGVudE9ic2VydmFibGUuX2xhdGVzdFZhbHVlID0gX2xhdGVzdFZhbHVlOwoKCSAgICAgICAgICAgICAgICAgICAgaWYgKHN1cHByZXNzQ2hhbmdlTm90aWZpY2F0aW9uICE9PSB0cnVlKSB7ICAvLyBDaGVjayBmb3Igc3RyaWN0IHRydWUgdmFsdWUgc2luY2Ugc2V0VGltZW91dCBpbiBGaXJlZm94IHBhc3NlcyBhIG51bWVyaWMgdmFsdWUgdG8gdGhlIGZ1bmN0aW9uCgkgICAgICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9IGZpbmFsbHkgewoJICAgICAgICAgICAgICAgIF9pc0JlaW5nRXZhbHVhdGVkID0gZmFsc2U7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIGlmICghX2RlcGVuZGVuY2llc0NvdW50KQoJICAgICAgICAgICAgZGlzcG9zZSgpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZGVwZW5kZW50T2JzZXJ2YWJsZSgpIHsKCSAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CgkgICAgICAgICAgICBpZiAodHlwZW9mIHdyaXRlRnVuY3Rpb24gPT09ICJmdW5jdGlvbiIpIHsKCSAgICAgICAgICAgICAgICAvLyBXcml0aW5nIGEgdmFsdWUKCSAgICAgICAgICAgICAgICB3cml0ZUZ1bmN0aW9uLmFwcGx5KGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0LCBhcmd1bWVudHMpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCB3cml0ZSBhIHZhbHVlIHRvIGEga28uY29tcHV0ZWQgdW5sZXNzIHlvdSBzcGVjaWZ5IGEgJ3dyaXRlJyBvcHRpb24uIElmIHlvdSB3aXNoIHRvIHJlYWQgdGhlIGN1cnJlbnQgdmFsdWUsIGRvbid0IHBhc3MgYW55IHBhcmFtZXRlcnMuIik7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdGhpczsgLy8gUGVybWl0cyBjaGFpbmVkIGFzc2lnbm1lbnRzCgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAvLyBSZWFkaW5nIHRoZSB2YWx1ZQoJICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5yZWdpc3RlckRlcGVuZGVuY3koZGVwZW5kZW50T2JzZXJ2YWJsZSk7CgkgICAgICAgICAgICBpZiAoX25lZWRzRXZhbHVhdGlvbikKCSAgICAgICAgICAgICAgICBldmFsdWF0ZUltbWVkaWF0ZSh0cnVlIC8qIHN1cHByZXNzQ2hhbmdlTm90aWZpY2F0aW9uICovKTsKCSAgICAgICAgICAgIHJldHVybiBfbGF0ZXN0VmFsdWU7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIHBlZWsoKSB7CgkgICAgICAgIC8vIFBlZWsgd29uJ3QgcmUtZXZhbHVhdGUsIGV4Y2VwdCB0byBnZXQgdGhlIGluaXRpYWwgdmFsdWUgd2hlbiAiZGVmZXJFdmFsdWF0aW9uIiBpcyBzZXQsIG9yIHdoaWxlIHRoZSBjb21wdXRlZCBpcyBzbGVlcGluZy4KCSAgICAgICAgLy8gVGhvc2UgYXJlIHRoZSBvbmx5IHRpbWVzIHRoYXQgYm90aCBvZiB0aGVzZSBjb25kaXRpb25zIHdpbGwgYmUgc2F0aXNmaWVkLgoJICAgICAgICBpZiAoX25lZWRzRXZhbHVhdGlvbiAmJiAhX2RlcGVuZGVuY2llc0NvdW50KQoJICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUodHJ1ZSAvKiBzdXBwcmVzc0NoYW5nZU5vdGlmaWNhdGlvbiAqLyk7CgkgICAgICAgIHJldHVybiBfbGF0ZXN0VmFsdWU7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBpc0FjdGl2ZSgpIHsKCSAgICAgICAgcmV0dXJuIF9uZWVkc0V2YWx1YXRpb24gfHwgX2RlcGVuZGVuY2llc0NvdW50ID4gMDsKCSAgICB9CgoJICAgIC8vIEJ5IGhlcmUsICJvcHRpb25zIiBpcyBhbHdheXMgbm9uLW51bGwKCSAgICB2YXIgd3JpdGVGdW5jdGlvbiA9IG9wdGlvbnNbIndyaXRlIl0sCgkgICAgICAgIGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCA9IG9wdGlvbnNbImRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCJdIHx8IG9wdGlvbnMuZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIHx8IG51bGwsCgkgICAgICAgIGRpc3Bvc2VXaGVuT3B0aW9uID0gb3B0aW9uc1siZGlzcG9zZVdoZW4iXSB8fCBvcHRpb25zLmRpc3Bvc2VXaGVuLAoJICAgICAgICBkaXNwb3NlV2hlbiA9IGRpc3Bvc2VXaGVuT3B0aW9uLAoJICAgICAgICBkaXNwb3NlID0gZGlzcG9zZUNvbXB1dGVkLAoJICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzID0ge30sCgkgICAgICAgIF9kZXBlbmRlbmNpZXNDb3VudCA9IDAsCgkgICAgICAgIGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UgPSBudWxsOwoKCSAgICBpZiAoIWV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0KQoJICAgICAgICBldmFsdWF0b3JGdW5jdGlvblRhcmdldCA9IG9wdGlvbnNbIm93bmVyIl07CgoJICAgIGtvLnN1YnNjcmliYWJsZS5jYWxsKGRlcGVuZGVudE9ic2VydmFibGUpOwoJICAgIGtvLnV0aWxzLnNldFByb3RvdHlwZU9mT3JFeHRlbmQoZGVwZW5kZW50T2JzZXJ2YWJsZSwga28uZGVwZW5kZW50T2JzZXJ2YWJsZVsnZm4nXSk7CgoJICAgIGRlcGVuZGVudE9ic2VydmFibGUucGVlayA9IHBlZWs7CgkgICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5nZXREZXBlbmRlbmNpZXNDb3VudCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIF9kZXBlbmRlbmNpZXNDb3VudDsgfTsKCSAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmhhc1dyaXRlRnVuY3Rpb24gPSB0eXBlb2Ygb3B0aW9uc1sid3JpdGUiXSA9PT0gImZ1bmN0aW9uIjsKCSAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmRpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7IGRpc3Bvc2UoKTsgfTsKCSAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmlzQWN0aXZlID0gaXNBY3RpdmU7CgoJICAgIC8vIFJlcGxhY2UgdGhlIGxpbWl0IGZ1bmN0aW9uIHdpdGggb25lIHRoYXQgZGVsYXlzIGV2YWx1YXRpb24gYXMgd2VsbC4KCSAgICB2YXIgb3JpZ2luYWxMaW1pdCA9IGRlcGVuZGVudE9ic2VydmFibGUubGltaXQ7CgkgICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5saW1pdCA9IGZ1bmN0aW9uKGxpbWl0RnVuY3Rpb24pIHsKCSAgICAgICAgb3JpZ2luYWxMaW1pdC5jYWxsKGRlcGVuZGVudE9ic2VydmFibGUsIGxpbWl0RnVuY3Rpb24pOwoJICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLl9ldmFsUmF0ZUxpbWl0ZWQgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGUuX3JhdGVMaW1pdGVkQmVmb3JlQ2hhbmdlKF9sYXRlc3RWYWx1ZSk7CgoJICAgICAgICAgICAgX25lZWRzRXZhbHVhdGlvbiA9IHRydWU7ICAgIC8vIE1hcmsgYXMgZGlydHkKCgkgICAgICAgICAgICAvLyBQYXNzIHRoZSBvYnNlcnZhYmxlIHRvIHRoZSByYXRlLWxpbWl0IGNvZGUsIHdoaWNoIHdpbGwgYWNjZXNzIGl0IHdoZW4KCSAgICAgICAgICAgIC8vIGl0J3MgdGltZSB0byBkbyB0aGUgbm90aWZpY2F0aW9uLgoJICAgICAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5fcmF0ZUxpbWl0ZWRDaGFuZ2UoZGVwZW5kZW50T2JzZXJ2YWJsZSk7CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICBpZiAob3B0aW9uc1sncHVyZSddKSB7CgkgICAgICAgIHB1cmUgPSB0cnVlOwoJICAgICAgICBpc1NsZWVwaW5nID0gdHJ1ZTsgICAgIC8vIFN0YXJ0cyBvZmYgc2xlZXBpbmc7IHdpbGwgYXdha2Ugb24gdGhlIGZpcnN0IHN1YnNjcmlwdGlvbgoJICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmJlZm9yZVN1YnNjcmlwdGlvbkFkZCA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgIC8vIElmIGFzbGVlcCwgd2FrZSB1cCB0aGUgY29tcHV0ZWQgYW5kIGV2YWx1YXRlIHRvIHJlZ2lzdGVyIGFueSBkZXBlbmRlbmNpZXMuCgkgICAgICAgICAgICBpZiAoaXNTbGVlcGluZykgewoJICAgICAgICAgICAgICAgIGlzU2xlZXBpbmcgPSBmYWxzZTsKCSAgICAgICAgICAgICAgICBldmFsdWF0ZUltbWVkaWF0ZSh0cnVlIC8qIHN1cHByZXNzQ2hhbmdlTm90aWZpY2F0aW9uICovKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmFmdGVyU3Vic2NyaXB0aW9uUmVtb3ZlID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgaWYgKCFkZXBlbmRlbnRPYnNlcnZhYmxlLmdldFN1YnNjcmlwdGlvbnNDb3VudCgpKSB7CgkgICAgICAgICAgICAgICAgZGlzcG9zZUFsbFN1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcygpOwoJICAgICAgICAgICAgICAgIGlzU2xlZXBpbmcgPSBfbmVlZHNFdmFsdWF0aW9uID0gdHJ1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH0gZWxzZSBpZiAob3B0aW9uc1snZGVmZXJFdmFsdWF0aW9uJ10pIHsKCSAgICAgICAgLy8gVGhpcyB3aWxsIGZvcmNlIGEgY29tcHV0ZWQgd2l0aCBkZWZlckV2YWx1YXRpb24gdG8gZXZhbHVhdGUgd2hlbiB0aGUgZmlyc3Qgc3Vic2NyaXB0aW9ucyBpcyByZWdpc3RlcmVkLgoJICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmJlZm9yZVN1YnNjcmlwdGlvbkFkZCA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgIHBlZWsoKTsKCSAgICAgICAgICAgIGRlbGV0ZSBkZXBlbmRlbnRPYnNlcnZhYmxlLmJlZm9yZVN1YnNjcmlwdGlvbkFkZDsKCSAgICAgICAgfQoJICAgIH0KCgkgICAga28uZXhwb3J0UHJvcGVydHkoZGVwZW5kZW50T2JzZXJ2YWJsZSwgJ3BlZWsnLCBkZXBlbmRlbnRPYnNlcnZhYmxlLnBlZWspOwoJICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdkaXNwb3NlJywgZGVwZW5kZW50T2JzZXJ2YWJsZS5kaXNwb3NlKTsKCSAgICBrby5leHBvcnRQcm9wZXJ0eShkZXBlbmRlbnRPYnNlcnZhYmxlLCAnaXNBY3RpdmUnLCBkZXBlbmRlbnRPYnNlcnZhYmxlLmlzQWN0aXZlKTsKCSAgICBrby5leHBvcnRQcm9wZXJ0eShkZXBlbmRlbnRPYnNlcnZhYmxlLCAnZ2V0RGVwZW5kZW5jaWVzQ291bnQnLCBkZXBlbmRlbnRPYnNlcnZhYmxlLmdldERlcGVuZGVuY2llc0NvdW50KTsKCgkgICAgLy8gQWRkIGEgImRpc3Bvc2VXaGVuIiBjYWxsYmFjayB0aGF0LCBvbiBlYWNoIGV2YWx1YXRpb24sIGRpc3Bvc2VzIGlmIHRoZSBub2RlIHdhcyByZW1vdmVkIHdpdGhvdXQgdXNpbmcga28ucmVtb3ZlTm9kZS4KCSAgICBpZiAoZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkKSB7CgkgICAgICAgIC8vIFNpbmNlIHRoaXMgY29tcHV0ZWQgaXMgYXNzb2NpYXRlZCB3aXRoIGEgRE9NIG5vZGUsIGFuZCB3ZSBkb24ndCB3YW50IHRvIGRpc3Bvc2UgdGhlIGNvbXB1dGVkCgkgICAgICAgIC8vIHVudGlsIHRoZSBET00gbm9kZSBpcyAqcmVtb3ZlZCogZnJvbSB0aGUgZG9jdW1lbnQgKGFzIG9wcG9zZWQgdG8gbmV2ZXIgaGF2aW5nIGJlZW4gaW4gdGhlIGRvY3VtZW50KSwKCSAgICAgICAgLy8gd2UnbGwgcHJldmVudCBkaXNwb3NhbCB1bnRpbCAiZGlzcG9zZVdoZW4iIGZpcnN0IHJldHVybnMgZmFsc2UuCgkgICAgICAgIF9zdXBwcmVzc0Rpc3Bvc2FsVW50aWxEaXNwb3NlV2hlblJldHVybnNGYWxzZSA9IHRydWU7CgoJICAgICAgICAvLyBPbmx5IHdhdGNoIGZvciB0aGUgbm9kZSdzIGRpc3Bvc2FsIGlmIHRoZSB2YWx1ZSByZWFsbHkgaXMgYSBub2RlLiBJdCBtaWdodCBub3QgYmUsCgkgICAgICAgIC8vIGUuZy4sIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiB0cnVlIH0gY2FuIGJlIHVzZWQgdG8gb3B0IGludG8gdGhlICJvbmx5IGRpc3Bvc2UKCSAgICAgICAgLy8gYWZ0ZXIgZmlyc3QgZmFsc2UgcmVzdWx0IiBiZWhhdmlvdXIgZXZlbiBpZiB0aGVyZSdzIG5vIHNwZWNpZmljIG5vZGUgdG8gd2F0Y2guIFRoaXMKCSAgICAgICAgLy8gdGVjaG5pcXVlIGlzIGludGVuZGVkIGZvciBLTydzIGludGVybmFsIHVzZSBvbmx5IGFuZCBzaG91bGRuJ3QgYmUgZG9jdW1lbnRlZCBvciB1c2VkCgkgICAgICAgIC8vIGJ5IGFwcGxpY2F0aW9uIGNvZGUsIGFzIGl0J3MgbGlrZWx5IHRvIGNoYW5nZSBpbiBhIGZ1dHVyZSB2ZXJzaW9uIG9mIEtPLgoJICAgICAgICBpZiAoZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkLm5vZGVUeXBlKSB7CgkgICAgICAgICAgICBkaXNwb3NlV2hlbiA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gIWtvLnV0aWxzLmRvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQpIHx8IChkaXNwb3NlV2hlbk9wdGlvbiAmJiBkaXNwb3NlV2hlbk9wdGlvbigpKTsKCSAgICAgICAgICAgIH07CgkgICAgICAgIH0KCSAgICB9CgoJICAgIC8vIEV2YWx1YXRlLCB1bmxlc3Mgc2xlZXBpbmcgb3IgZGVmZXJFdmFsdWF0aW9uIGlzIHRydWUKCSAgICBpZiAoIWlzU2xlZXBpbmcgJiYgIW9wdGlvbnNbJ2RlZmVyRXZhbHVhdGlvbiddKQoJICAgICAgICBldmFsdWF0ZUltbWVkaWF0ZSgpOwoKCSAgICAvLyBBdHRhY2ggYSBET00gbm9kZSBkaXNwb3NhbCBjYWxsYmFjayBzbyB0aGF0IHRoZSBjb21wdXRlZCB3aWxsIGJlIHByb2FjdGl2ZWx5IGRpc3Bvc2VkIGFzIHNvb24gYXMgdGhlIG5vZGUgaXMKCSAgICAvLyByZW1vdmVkIHVzaW5nIGtvLnJlbW92ZU5vZGUuIEJ1dCBza2lwIGlmIGlzQWN0aXZlIGlzIGZhbHNlICh0aGVyZSB3aWxsIG5ldmVyIGJlIGFueSBkZXBlbmRlbmNpZXMgdG8gZGlzcG9zZSkuCgkgICAgaWYgKGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCAmJiBpc0FjdGl2ZSgpICYmIGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZC5ub2RlVHlwZSkgewoJICAgICAgICBkaXNwb3NlID0gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlRGlzcG9zZUNhbGxiYWNrKGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCwgZGlzcG9zZSk7CgkgICAgICAgICAgICBkaXNwb3NlQ29tcHV0ZWQoKTsKCSAgICAgICAgfTsKCSAgICAgICAga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayhkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQsIGRpc3Bvc2UpOwoJICAgIH0KCgkgICAgcmV0dXJuIGRlcGVuZGVudE9ic2VydmFibGU7Cgl9OwoKCWtvLmlzQ29tcHV0ZWQgPSBmdW5jdGlvbihpbnN0YW5jZSkgewoJICAgIHJldHVybiBrby5oYXNQcm90b3R5cGUoaW5zdGFuY2UsIGtvLmRlcGVuZGVudE9ic2VydmFibGUpOwoJfTsKCgl2YXIgcHJvdG9Qcm9wID0ga28ub2JzZXJ2YWJsZS5wcm90b1Byb3BlcnR5OyAvLyA9PSAiX19rb19wcm90b19fIgoJa28uZGVwZW5kZW50T2JzZXJ2YWJsZVtwcm90b1Byb3BdID0ga28ub2JzZXJ2YWJsZTsKCglrby5kZXBlbmRlbnRPYnNlcnZhYmxlWydmbiddID0gewoJICAgICJlcXVhbGl0eUNvbXBhcmVyIjogdmFsdWVzQXJlUHJpbWl0aXZlQW5kRXF1YWwKCX07Cglrby5kZXBlbmRlbnRPYnNlcnZhYmxlWydmbiddW3Byb3RvUHJvcF0gPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlOwoKCS8vIE5vdGUgdGhhdCBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IHByb3RvIGFzc2lnbm1lbnQsIHRoZQoJLy8gaW5oZXJpdGFuY2UgY2hhaW4gaXMgY3JlYXRlZCBtYW51YWxseSBpbiB0aGUga28uZGVwZW5kZW50T2JzZXJ2YWJsZSBjb25zdHJ1Y3RvcgoJaWYgKGtvLnV0aWxzLmNhblNldFByb3RvdHlwZSkgewoJICAgIGtvLnV0aWxzLnNldFByb3RvdHlwZU9mKGtvLmRlcGVuZGVudE9ic2VydmFibGVbJ2ZuJ10sIGtvLnN1YnNjcmliYWJsZVsnZm4nXSk7Cgl9CgoJa28uZXhwb3J0U3ltYm9sKCdkZXBlbmRlbnRPYnNlcnZhYmxlJywga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7Cglrby5leHBvcnRTeW1ib2woJ2NvbXB1dGVkJywga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7IC8vIE1ha2UgImtvLmNvbXB1dGVkIiBhbiBhbGlhcyBmb3IgImtvLmRlcGVuZGVudE9ic2VydmFibGUiCglrby5leHBvcnRTeW1ib2woJ2lzQ29tcHV0ZWQnLCBrby5pc0NvbXB1dGVkKTsKCglrby5wdXJlQ29tcHV0ZWQgPSBmdW5jdGlvbiAoZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMsIGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0KSB7CgkgICAgaWYgKHR5cGVvZiBldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICByZXR1cm4ga28uY29tcHV0ZWQoZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMsIGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0LCB7J3B1cmUnOnRydWV9KTsKCSAgICB9IGVsc2UgewoJICAgICAgICBldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucyA9IGtvLnV0aWxzLmV4dGVuZCh7fSwgZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMpOyAgIC8vIG1ha2UgYSBjb3B5IG9mIHRoZSBwYXJhbWV0ZXIgb2JqZWN0CgkgICAgICAgIGV2YWx1YXRvckZ1bmN0aW9uT3JPcHRpb25zWydwdXJlJ10gPSB0cnVlOwoJICAgICAgICByZXR1cm4ga28uY29tcHV0ZWQoZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMsIGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0KTsKCSAgICB9Cgl9Cglrby5leHBvcnRTeW1ib2woJ3B1cmVDb21wdXRlZCcsIGtvLnB1cmVDb21wdXRlZCk7CgoJKGZ1bmN0aW9uKCkgewoJICAgIHZhciBtYXhOZXN0ZWRPYnNlcnZhYmxlRGVwdGggPSAxMDsgLy8gRXNjYXBlIHRoZSAodW5saWtlbHkpIHBhdGhhbG9naWNhbCBjYXNlIHdoZXJlIGFuIG9ic2VydmFibGUncyBjdXJyZW50IHZhbHVlIGlzIGl0c2VsZiAob3Igc2ltaWxhciByZWZlcmVuY2UgY3ljbGUpCgoJICAgIGtvLnRvSlMgPSBmdW5jdGlvbihyb290T2JqZWN0KSB7CgkgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDApCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldoZW4gY2FsbGluZyBrby50b0pTLCBwYXNzIHRoZSBvYmplY3QgeW91IHdhbnQgdG8gY29udmVydC4iKTsKCgkgICAgICAgIC8vIFdlIGp1c3QgdW53cmFwIGV2ZXJ5dGhpbmcgYXQgZXZlcnkgbGV2ZWwgaW4gdGhlIG9iamVjdCBncmFwaAoJICAgICAgICByZXR1cm4gbWFwSnNPYmplY3RHcmFwaChyb290T2JqZWN0LCBmdW5jdGlvbih2YWx1ZVRvTWFwKSB7CgkgICAgICAgICAgICAvLyBMb29wIGJlY2F1c2UgYW4gb2JzZXJ2YWJsZSdzIHZhbHVlIG1pZ2h0IGluIHR1cm4gYmUgYW5vdGhlciBvYnNlcnZhYmxlIHdyYXBwZXIKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBrby5pc09ic2VydmFibGUodmFsdWVUb01hcCkgJiYgKGkgPCBtYXhOZXN0ZWRPYnNlcnZhYmxlRGVwdGgpOyBpKyspCgkgICAgICAgICAgICAgICAgdmFsdWVUb01hcCA9IHZhbHVlVG9NYXAoKTsKCSAgICAgICAgICAgIHJldHVybiB2YWx1ZVRvTWFwOwoJICAgICAgICB9KTsKCSAgICB9OwoKCSAgICBrby50b0pTT04gPSBmdW5jdGlvbihyb290T2JqZWN0LCByZXBsYWNlciwgc3BhY2UpIHsgICAgIC8vIHJlcGxhY2VyIGFuZCBzcGFjZSBhcmUgb3B0aW9uYWwKCSAgICAgICAgdmFyIHBsYWluSmF2YVNjcmlwdE9iamVjdCA9IGtvLnRvSlMocm9vdE9iamVjdCk7CgkgICAgICAgIHJldHVybiBrby51dGlscy5zdHJpbmdpZnlKc29uKHBsYWluSmF2YVNjcmlwdE9iamVjdCwgcmVwbGFjZXIsIHNwYWNlKTsKCSAgICB9OwoKCSAgICBmdW5jdGlvbiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIG1hcElucHV0Q2FsbGJhY2ssIHZpc2l0ZWRPYmplY3RzKSB7CgkgICAgICAgIHZpc2l0ZWRPYmplY3RzID0gdmlzaXRlZE9iamVjdHMgfHwgbmV3IG9iamVjdExvb2t1cCgpOwoKCSAgICAgICAgcm9vdE9iamVjdCA9IG1hcElucHV0Q2FsbGJhY2socm9vdE9iamVjdCk7CgkgICAgICAgIHZhciBjYW5IYXZlUHJvcGVydGllcyA9ICh0eXBlb2Ygcm9vdE9iamVjdCA9PSAib2JqZWN0IikgJiYgKHJvb3RPYmplY3QgIT09IG51bGwpICYmIChyb290T2JqZWN0ICE9PSB1bmRlZmluZWQpICYmICghKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBEYXRlKSkgJiYgKCEocm9vdE9iamVjdCBpbnN0YW5jZW9mIFN0cmluZykpICYmICghKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBOdW1iZXIpKSAmJiAoIShyb290T2JqZWN0IGluc3RhbmNlb2YgQm9vbGVhbikpOwoJICAgICAgICBpZiAoIWNhbkhhdmVQcm9wZXJ0aWVzKQoJICAgICAgICAgICAgcmV0dXJuIHJvb3RPYmplY3Q7CgoJICAgICAgICB2YXIgb3V0cHV0UHJvcGVydGllcyA9IHJvb3RPYmplY3QgaW5zdGFuY2VvZiBBcnJheSA/IFtdIDoge307CgkgICAgICAgIHZpc2l0ZWRPYmplY3RzLnNhdmUocm9vdE9iamVjdCwgb3V0cHV0UHJvcGVydGllcyk7CgoJICAgICAgICB2aXNpdFByb3BlcnRpZXNPckFycmF5RW50cmllcyhyb290T2JqZWN0LCBmdW5jdGlvbihpbmRleGVyKSB7CgkgICAgICAgICAgICB2YXIgcHJvcGVydHlWYWx1ZSA9IG1hcElucHV0Q2FsbGJhY2socm9vdE9iamVjdFtpbmRleGVyXSk7CgoJICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgcHJvcGVydHlWYWx1ZSkgewoJICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgoJICAgICAgICAgICAgICAgIGNhc2UgIm51bWJlciI6CgkgICAgICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKCSAgICAgICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CgkgICAgICAgICAgICAgICAgICAgIG91dHB1dFByb3BlcnRpZXNbaW5kZXhlcl0gPSBwcm9wZXJ0eVZhbHVlOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgoJICAgICAgICAgICAgICAgIGNhc2UgInVuZGVmaW5lZCI6CgkgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c2x5TWFwcGVkVmFsdWUgPSB2aXNpdGVkT2JqZWN0cy5nZXQocHJvcGVydHlWYWx1ZSk7CgkgICAgICAgICAgICAgICAgICAgIG91dHB1dFByb3BlcnRpZXNbaW5kZXhlcl0gPSAocHJldmlvdXNseU1hcHBlZFZhbHVlICE9PSB1bmRlZmluZWQpCgkgICAgICAgICAgICAgICAgICAgICAgICA/IHByZXZpb3VzbHlNYXBwZWRWYWx1ZQoJICAgICAgICAgICAgICAgICAgICAgICAgOiBtYXBKc09iamVjdEdyYXBoKHByb3BlcnR5VmFsdWUsIG1hcElucHV0Q2FsbGJhY2ssIHZpc2l0ZWRPYmplY3RzKTsKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoKCSAgICAgICAgcmV0dXJuIG91dHB1dFByb3BlcnRpZXM7CgkgICAgfQoKCSAgICBmdW5jdGlvbiB2aXNpdFByb3BlcnRpZXNPckFycmF5RW50cmllcyhyb290T2JqZWN0LCB2aXNpdG9yQ2FsbGJhY2spIHsKCSAgICAgICAgaWYgKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBBcnJheSkgewoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByb290T2JqZWN0Lmxlbmd0aDsgaSsrKQoJICAgICAgICAgICAgICAgIHZpc2l0b3JDYWxsYmFjayhpKTsKCgkgICAgICAgICAgICAvLyBGb3IgYXJyYXlzLCBhbHNvIHJlc3BlY3QgdG9KU09OIHByb3BlcnR5IGZvciBjdXN0b20gbWFwcGluZ3MgKGZpeGVzICMyNzgpCgkgICAgICAgICAgICBpZiAodHlwZW9mIHJvb3RPYmplY3RbJ3RvSlNPTiddID09ICdmdW5jdGlvbicpCgkgICAgICAgICAgICAgICAgdmlzaXRvckNhbGxiYWNrKCd0b0pTT04nKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGZvciAodmFyIHByb3BlcnR5TmFtZSBpbiByb290T2JqZWN0KSB7CgkgICAgICAgICAgICAgICAgdmlzaXRvckNhbGxiYWNrKHByb3BlcnR5TmFtZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICBmdW5jdGlvbiBvYmplY3RMb29rdXAoKSB7CgkgICAgICAgIHRoaXMua2V5cyA9IFtdOwoJICAgICAgICB0aGlzLnZhbHVlcyA9IFtdOwoJICAgIH07CgoJICAgIG9iamVjdExvb2t1cC5wcm90b3R5cGUgPSB7CgkgICAgICAgIGNvbnN0cnVjdG9yOiBvYmplY3RMb29rdXAsCgkgICAgICAgIHNhdmU6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKCSAgICAgICAgICAgIHZhciBleGlzdGluZ0luZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKHRoaXMua2V5cywga2V5KTsKCSAgICAgICAgICAgIGlmIChleGlzdGluZ0luZGV4ID49IDApCgkgICAgICAgICAgICAgICAgdGhpcy52YWx1ZXNbZXhpc3RpbmdJbmRleF0gPSB2YWx1ZTsKCSAgICAgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgICAgIHRoaXMua2V5cy5wdXNoKGtleSk7CgkgICAgICAgICAgICAgICAgdGhpcy52YWx1ZXMucHVzaCh2YWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgkgICAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CgkgICAgICAgICAgICB2YXIgZXhpc3RpbmdJbmRleCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZih0aGlzLmtleXMsIGtleSk7CgkgICAgICAgICAgICByZXR1cm4gKGV4aXN0aW5nSW5kZXggPj0gMCkgPyB0aGlzLnZhbHVlc1tleGlzdGluZ0luZGV4XSA6IHVuZGVmaW5lZDsKCSAgICAgICAgfQoJICAgIH07Cgl9KSgpOwoKCWtvLmV4cG9ydFN5bWJvbCgndG9KUycsIGtvLnRvSlMpOwoJa28uZXhwb3J0U3ltYm9sKCd0b0pTT04nLCBrby50b0pTT04pOwoJKGZ1bmN0aW9uICgpIHsKCSAgICB2YXIgaGFzRG9tRGF0YUV4cGFuZG9Qcm9wZXJ0eSA9ICdfX2tvX19oYXNEb21EYXRhT3B0aW9uVmFsdWVfXyc7CgoJICAgIC8vIE5vcm1hbGx5LCBTRUxFQ1QgZWxlbWVudHMgYW5kIHRoZWlyIE9QVElPTnMgY2FuIG9ubHkgdGFrZSB2YWx1ZSBvZiB0eXBlICdzdHJpbmcnIChiZWNhdXNlIHRoZSB2YWx1ZXMKCSAgICAvLyBhcmUgc3RvcmVkIG9uIERPTSBhdHRyaWJ1dGVzKS4ga28uc2VsZWN0RXh0ZW5zaW9ucyBwcm92aWRlcyBhIHdheSBmb3IgU0VMRUNUcy9PUFRJT05zIHRvIGhhdmUgdmFsdWVzCgkgICAgLy8gdGhhdCBhcmUgYXJiaXRyYXJ5IG9iamVjdHMuIFRoaXMgaXMgdmVyeSBjb252ZW5pZW50IHdoZW4gaW1wbGVtZW50aW5nIHRoaW5ncyBsaWtlIGNhc2NhZGluZyBkcm9wZG93bnMuCgkgICAga28uc2VsZWN0RXh0ZW5zaW9ucyA9IHsKCSAgICAgICAgcmVhZFZhbHVlIDogZnVuY3Rpb24oZWxlbWVudCkgewoJICAgICAgICAgICAgc3dpdGNoIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkpIHsKCSAgICAgICAgICAgICAgICBjYXNlICdvcHRpb24nOgoJICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XSA9PT0gdHJ1ZSkKCSAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBrby51dGlscy5kb21EYXRhLmdldChlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnMub3B0aW9ucy5vcHRpb25WYWx1ZURvbURhdGFLZXkpOwoJICAgICAgICAgICAgICAgICAgICByZXR1cm4ga28udXRpbHMuaWVWZXJzaW9uIDw9IDcKCSAgICAgICAgICAgICAgICAgICAgICAgID8gKGVsZW1lbnQuZ2V0QXR0cmlidXRlTm9kZSgndmFsdWUnKSAmJiBlbGVtZW50LmdldEF0dHJpYnV0ZU5vZGUoJ3ZhbHVlJykuc3BlY2lmaWVkID8gZWxlbWVudC52YWx1ZSA6IGVsZW1lbnQudGV4dCkKCSAgICAgICAgICAgICAgICAgICAgICAgIDogZWxlbWVudC52YWx1ZTsKCSAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOgoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC5zZWxlY3RlZEluZGV4ID49IDAgPyBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50Lm9wdGlvbnNbZWxlbWVudC5zZWxlY3RlZEluZGV4XSkgOiB1bmRlZmluZWQ7CgkgICAgICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQudmFsdWU7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICB3cml0ZVZhbHVlOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSwgYWxsb3dVbnNldCkgewoJICAgICAgICAgICAgc3dpdGNoIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkpIHsKCSAgICAgICAgICAgICAgICBjYXNlICdvcHRpb24nOgoJICAgICAgICAgICAgICAgICAgICBzd2l0Y2godHlwZW9mIHZhbHVlKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJzdHJpbmciOgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSwgdW5kZWZpbmVkKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzRG9tRGF0YUV4cGFuZG9Qcm9wZXJ0eSBpbiBlbGVtZW50KSB7IC8vIElFIDw9IDggdGhyb3dzIGVycm9ycyBpZiB5b3UgZGVsZXRlIG5vbi1leGlzdGVudCBwcm9wZXJ0aWVzIGZyb20gYSBET00gbm9kZQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9yZSBhcmJpdHJhcnkgb2JqZWN0IHVzaW5nIERvbURhdGEKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnMub3B0aW9ucy5vcHRpb25WYWx1ZURvbURhdGFLZXksIHZhbHVlKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50W2hhc0RvbURhdGFFeHBhbmRvUHJvcGVydHldID0gdHJ1ZTsKCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3BlY2lhbCB0cmVhdG1lbnQgb2YgbnVtYmVycyBpcyBqdXN0IGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LiBLTyAxLjIuMSB3cm90ZSBudW1lcmljYWwgdmFsdWVzIHRvIGVsZW1lbnQudmFsdWUuCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgPyB2YWx1ZSA6ICIiOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGNhc2UgJ3NlbGVjdCc6CgkgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIgfHwgdmFsdWUgPT09IG51bGwpICAgICAgIC8vIEEgYmxhbmsgc3RyaW5nIG9yIG51bGwgdmFsdWUgd2lsbCBzZWxlY3QgdGhlIGNhcHRpb24KCSAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdW5kZWZpbmVkOwoJICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gLTE7CgkgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBuID0gZWxlbWVudC5vcHRpb25zLmxlbmd0aCwgb3B0aW9uVmFsdWU7IGkgPCBuOyArK2kpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvblZhbHVlID0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudC5vcHRpb25zW2ldKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluY2x1ZGUgc3BlY2lhbCBjaGVjayB0byBoYW5kbGUgc2VsZWN0aW5nIGEgY2FwdGlvbiB3aXRoIGEgYmxhbmsgc3RyaW5nIHZhbHVlCgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uVmFsdWUgPT0gdmFsdWUgfHwgKG9wdGlvblZhbHVlID09ICIiICYmIHZhbHVlID09PSB1bmRlZmluZWQpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uID0gaTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBpZiAoYWxsb3dVbnNldCB8fCBzZWxlY3Rpb24gPj0gMCB8fCAodmFsdWUgPT09IHVuZGVmaW5lZCAmJiBlbGVtZW50LnNpemUgPiAxKSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zZWxlY3RlZEluZGV4ID0gc2VsZWN0aW9uOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgICAgIGlmICgodmFsdWUgPT09IG51bGwpIHx8ICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSkKCSAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gIiI7CgkgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudmFsdWUgPSB2YWx1ZTsKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ3NlbGVjdEV4dGVuc2lvbnMnLCBrby5zZWxlY3RFeHRlbnNpb25zKTsKCWtvLmV4cG9ydFN5bWJvbCgnc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUnLCBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZSk7Cglrby5leHBvcnRTeW1ib2woJ3NlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZScsIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZSk7Cglrby5leHByZXNzaW9uUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKCSAgICB2YXIgamF2YVNjcmlwdFJlc2VydmVkV29yZHMgPSBbInRydWUiLCAiZmFsc2UiLCAibnVsbCIsICJ1bmRlZmluZWQiXTsKCgkgICAgLy8gTWF0Y2hlcyBzb21ldGhpbmcgdGhhdCBjYW4gYmUgYXNzaWduZWQgdG8tLWVpdGhlciBhbiBpc29sYXRlZCBpZGVudGlmaWVyIG9yIHNvbWV0aGluZyBlbmRpbmcgd2l0aCBhIHByb3BlcnR5IGFjY2Vzc29yCgkgICAgLy8gVGhpcyBpcyBkZXNpZ25lZCB0byBiZSBzaW1wbGUgYW5kIGF2b2lkIGZhbHNlIG5lZ2F0aXZlcywgYnV0IGNvdWxkIHByb2R1Y2UgZmFsc2UgcG9zaXRpdmVzIChlLmcuLCBhK2IuYykuCgkgICAgLy8gVGhpcyBhbHNvIHdpbGwgbm90IHByb3Blcmx5IGhhbmRsZSBuZXN0ZWQgYnJhY2tldHMgKGUuZy4sIG9iajFbb2JqMlsncHJvcCddXTsgc2VlICM5MTEpLgoJICAgIHZhciBqYXZhU2NyaXB0QXNzaWdubWVudFRhcmdldCA9IC9eKD86WyRfYS16XVskXHddKnwoLispKFwuXHMqWyRfYS16XVskXHddKnxcWy4rXF0pKSQvaTsKCgkgICAgZnVuY3Rpb24gZ2V0V3JpdGVhYmxlVmFsdWUoZXhwcmVzc2lvbikgewoJICAgICAgICBpZiAoa28udXRpbHMuYXJyYXlJbmRleE9mKGphdmFTY3JpcHRSZXNlcnZlZFdvcmRzLCBleHByZXNzaW9uKSA+PSAwKQoJICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgICB2YXIgbWF0Y2ggPSBleHByZXNzaW9uLm1hdGNoKGphdmFTY3JpcHRBc3NpZ25tZW50VGFyZ2V0KTsKCSAgICAgICAgcmV0dXJuIG1hdGNoID09PSBudWxsID8gZmFsc2UgOiBtYXRjaFsxXSA/ICgnT2JqZWN0KCcgKyBtYXRjaFsxXSArICcpJyArIG1hdGNoWzJdKSA6IGV4cHJlc3Npb247CgkgICAgfQoKCSAgICAvLyBUaGUgZm9sbG93aW5nIHJlZ3VsYXIgZXhwcmVzc2lvbnMgd2lsbCBiZSB1c2VkIHRvIHNwbGl0IGFuIG9iamVjdC1saXRlcmFsIHN0cmluZyBpbnRvIHRva2VucwoKCSAgICAgICAgLy8gVGhlc2UgdHdvIG1hdGNoIHN0cmluZ3MsIGVpdGhlciB3aXRoIGRvdWJsZSBxdW90ZXMgb3Igc2luZ2xlIHF1b3RlcwoJICAgIHZhciBzdHJpbmdEb3VibGUgPSAnIig/OlteIlxcXFxdfFxcXFwuKSoiJywKCSAgICAgICAgc3RyaW5nU2luZ2xlID0gIicoPzpbXidcXFxcXXxcXFxcLikqJyIsCgkgICAgICAgIC8vIE1hdGNoZXMgYSByZWd1bGFyIGV4cHJlc3Npb24gKHRleHQgZW5jbG9zZWQgYnkgc2xhc2hlcyksIGJ1dCB3aWxsIGFsc28gbWF0Y2ggc2V0cyBvZiBkaXZpc2lvbnMKCSAgICAgICAgLy8gYXMgYSByZWd1bGFyIGV4cHJlc3Npb24gKHRoaXMgaXMgaGFuZGxlZCBieSB0aGUgcGFyc2luZyBsb29wIGJlbG93KS4KCSAgICAgICAgc3RyaW5nUmVnZXhwID0gJy8oPzpbXi9cXFxcXXxcXFxcLikqL1x3KicsCgkgICAgICAgIC8vIFRoZXNlIGNoYXJhY3RlcnMgaGF2ZSBzcGVjaWFsIG1lYW5pbmcgdG8gdGhlIHBhcnNlciBhbmQgbXVzdCBub3QgYXBwZWFyIGluIHRoZSBtaWRkbGUgb2YgYQoJICAgICAgICAvLyB0b2tlbiwgZXhjZXB0IGFzIHBhcnQgb2YgYSBzdHJpbmcuCgkgICAgICAgIHNwZWNpYWxzID0gJywiXCd7fSgpLzpbXFxdJywKCSAgICAgICAgLy8gTWF0Y2ggdGV4dCAoYXQgbGVhc3QgdHdvIGNoYXJhY3RlcnMpIHRoYXQgZG9lcyBub3QgY29udGFpbiBhbnkgb2YgdGhlIGFib3ZlIHNwZWNpYWwgY2hhcmFjdGVycywKCSAgICAgICAgLy8gYWx0aG91Z2ggc29tZSBvZiB0aGUgc3BlY2lhbCBjaGFyYWN0ZXJzIGFyZSBhbGxvd2VkIHRvIHN0YXJ0IGl0IChhbGwgYnV0IHRoZSBjb2xvbiBhbmQgY29tbWEpLgoJICAgICAgICAvLyBUaGUgdGV4dCBjYW4gY29udGFpbiBzcGFjZXMsIGJ1dCBsZWFkaW5nIG9yIHRyYWlsaW5nIHNwYWNlcyBhcmUgc2tpcHBlZC4KCSAgICAgICAgZXZlcnlUaGluZ0Vsc2UgPSAnW15cXHM6LC9dW14nICsgc3BlY2lhbHMgKyAnXSpbXlxccycgKyBzcGVjaWFscyArICddJywKCSAgICAgICAgLy8gTWF0Y2ggYW55IG5vbi1zcGFjZSBjaGFyYWN0ZXIgbm90IG1hdGNoZWQgYWxyZWFkeS4gVGhpcyB3aWxsIG1hdGNoIGNvbG9ucyBhbmQgY29tbWFzLCBzaW5jZSB0aGV5J3JlCgkgICAgICAgIC8vIG5vdCBtYXRjaGVkIGJ5ICJldmVyeVRoaW5nRWxzZSIsIGJ1dCB3aWxsIGFsc28gbWF0Y2ggYW55IG90aGVyIHNpbmdsZSBjaGFyYWN0ZXIgdGhhdCB3YXNuJ3QgYWxyZWFkeQoJICAgICAgICAvLyBtYXRjaGVkIChmb3IgZXhhbXBsZTogaW4gImE6IDEsIGI6IDIiLCBlYWNoIG9mIHRoZSBub24tc3BhY2UgY2hhcmFjdGVycyB3aWxsIGJlIG1hdGNoZWQgYnkgb25lTm90U3BhY2UpLgoJICAgICAgICBvbmVOb3RTcGFjZSA9ICdbXlxcc10nLAoKCSAgICAgICAgLy8gQ3JlYXRlIHRoZSBhY3R1YWwgcmVndWxhciBleHByZXNzaW9uIGJ5IG9yLWluZyB0aGUgYWJvdmUgc3RyaW5ncy4gVGhlIG9yZGVyIGlzIGltcG9ydGFudC4KCSAgICAgICAgYmluZGluZ1Rva2VuID0gUmVnRXhwKHN0cmluZ0RvdWJsZSArICd8JyArIHN0cmluZ1NpbmdsZSArICd8JyArIHN0cmluZ1JlZ2V4cCArICd8JyArIGV2ZXJ5VGhpbmdFbHNlICsgJ3wnICsgb25lTm90U3BhY2UsICdnJyksCgoJICAgICAgICAvLyBNYXRjaCBlbmQgb2YgcHJldmlvdXMgdG9rZW4gdG8gZGV0ZXJtaW5lIHdoZXRoZXIgYSBzbGFzaCBpcyBhIGRpdmlzaW9uIG9yIHJlZ2V4LgoJICAgICAgICBkaXZpc2lvbkxvb2tCZWhpbmQgPSAvW1xdKSInQS1aYS16MC05XyRdKyQvLAoJICAgICAgICBrZXl3b3JkUmVnZXhMb29rQmVoaW5kID0geydpbic6MSwncmV0dXJuJzoxLCd0eXBlb2YnOjF9OwoKCSAgICBmdW5jdGlvbiBwYXJzZU9iamVjdExpdGVyYWwob2JqZWN0TGl0ZXJhbFN0cmluZykgewoJICAgICAgICAvLyBUcmltIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNwYWNlcyBmcm9tIHRoZSBzdHJpbmcKCSAgICAgICAgdmFyIHN0ciA9IGtvLnV0aWxzLnN0cmluZ1RyaW0ob2JqZWN0TGl0ZXJhbFN0cmluZyk7CgoJICAgICAgICAvLyBUcmltIGJyYWNlcyAneycgc3Vycm91bmRpbmcgdGhlIHdob2xlIG9iamVjdCBsaXRlcmFsCgkgICAgICAgIGlmIChzdHIuY2hhckNvZGVBdCgwKSA9PT0gMTIzKSBzdHIgPSBzdHIuc2xpY2UoMSwgLTEpOwoKCSAgICAgICAgLy8gU3BsaXQgaW50byB0b2tlbnMKCSAgICAgICAgdmFyIHJlc3VsdCA9IFtdLCB0b2tzID0gc3RyLm1hdGNoKGJpbmRpbmdUb2tlbiksIGtleSwgdmFsdWVzLCBkZXB0aCA9IDA7CgoJICAgICAgICBpZiAodG9rcykgewoJICAgICAgICAgICAgLy8gQXBwZW5kIGEgY29tbWEgc28gdGhhdCB3ZSBkb24ndCBuZWVkIGEgc2VwYXJhdGUgY29kZSBibG9jayB0byBkZWFsIHdpdGggdGhlIGxhc3QgaXRlbQoJICAgICAgICAgICAgdG9rcy5wdXNoKCcsJyk7CgoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIHRvazsgdG9rID0gdG9rc1tpXTsgKytpKSB7CgkgICAgICAgICAgICAgICAgdmFyIGMgPSB0b2suY2hhckNvZGVBdCgwKTsKCSAgICAgICAgICAgICAgICAvLyBBIGNvbW1hIHNpZ25hbHMgdGhlIGVuZCBvZiBhIGtleS92YWx1ZSBwYWlyIGlmIGRlcHRoIGlzIHplcm8KCSAgICAgICAgICAgICAgICBpZiAoYyA9PT0gNDQpIHsgLy8gIiwiCgkgICAgICAgICAgICAgICAgICAgIGlmIChkZXB0aCA8PSAwKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5KQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlcyA/IHtrZXk6IGtleSwgdmFsdWU6IHZhbHVlcy5qb2luKCcnKX0gOiB7J3Vua25vd24nOiBrZXl9KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IHZhbHVlcyA9IGRlcHRoID0gMDsKCSAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgLy8gU2ltcGx5IHNraXAgdGhlIGNvbG9uIHRoYXQgc2VwYXJhdGVzIHRoZSBuYW1lIGFuZCB2YWx1ZQoJICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gNTgpIHsgLy8gIjoiCgkgICAgICAgICAgICAgICAgICAgIGlmICghdmFsdWVzKQoJICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgICAgICAgICAgLy8gQSBzZXQgb2Ygc2xhc2hlcyBpcyBpbml0aWFsbHkgbWF0Y2hlZCBhcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgYnV0IGNvdWxkIGJlIGRpdmlzaW9uCgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSA0NyAmJiBpICYmIHRvay5sZW5ndGggPiAxKSB7ICAvLyAiLyIKCSAgICAgICAgICAgICAgICAgICAgLy8gTG9vayBhdCB0aGUgZW5kIG9mIHRoZSBwcmV2aW91cyB0b2tlbiB0byBkZXRlcm1pbmUgaWYgdGhlIHNsYXNoIGlzIGFjdHVhbGx5IGRpdmlzaW9uCgkgICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IHRva3NbaS0xXS5tYXRjaChkaXZpc2lvbkxvb2tCZWhpbmQpOwoJICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2ggJiYgIWtleXdvcmRSZWdleExvb2tCZWhpbmRbbWF0Y2hbMF1dKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgc2xhc2ggaXMgYWN0dWFsbHkgYSBkaXZpc2lvbiBwdW5jdHVhdG9yOyByZS1wYXJzZSB0aGUgcmVtYWluZGVyIG9mIHRoZSBzdHJpbmcgKG5vdCBpbmNsdWRpbmcgdGhlIHNsYXNoKQoJICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyLnN1YnN0cihzdHIuaW5kZXhPZih0b2spICsgMSk7CgkgICAgICAgICAgICAgICAgICAgICAgICB0b2tzID0gc3RyLm1hdGNoKGJpbmRpbmdUb2tlbik7CgkgICAgICAgICAgICAgICAgICAgICAgICB0b2tzLnB1c2goJywnKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGkgPSAtMTsKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbnRpbnVlIHdpdGgganVzdCB0aGUgc2xhc2gKCSAgICAgICAgICAgICAgICAgICAgICAgIHRvayA9ICcvJzsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIC8vIEluY3JlbWVudCBkZXB0aCBmb3IgcGFyZW50aGVzZXMsIGJyYWNlcywgYW5kIGJyYWNrZXRzIHNvIHRoYXQgaW50ZXJpb3IgY29tbWFzIGFyZSBpZ25vcmVkCgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSA0MCB8fCBjID09PSAxMjMgfHwgYyA9PT0gOTEpIHsgLy8gJygnLCAneycsICdbJwoJICAgICAgICAgICAgICAgICAgICArK2RlcHRoOwoJICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gNDEgfHwgYyA9PT0gMTI1IHx8IGMgPT09IDkzKSB7IC8vICcpJywgJ30nLCAnXScKCSAgICAgICAgICAgICAgICAgICAgLS1kZXB0aDsKCSAgICAgICAgICAgICAgICAvLyBUaGUga2V5IG11c3QgYmUgYSBzaW5nbGUgdG9rZW47IGlmIGl0J3MgYSBzdHJpbmcsIHRyaW0gdGhlIHF1b3RlcwoJICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWtleSAmJiAhdmFsdWVzKSB7CgkgICAgICAgICAgICAgICAgICAgIGtleSA9IChjID09PSAzNCB8fCBjID09PSAzOSkgLyogJyInLCAiJyIgKi8gPyB0b2suc2xpY2UoMSwgLTEpIDogdG9rOwoJICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKHZhbHVlcykKCSAgICAgICAgICAgICAgICAgICAgdmFsdWVzLnB1c2godG9rKTsKCSAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgIHZhbHVlcyA9IFt0b2tdOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgfQoKCSAgICAvLyBUd28td2F5IGJpbmRpbmdzIGluY2x1ZGUgYSB3cml0ZSBmdW5jdGlvbiB0aGF0IGFsbG93IHRoZSBoYW5kbGVyIHRvIHVwZGF0ZSB0aGUgdmFsdWUgZXZlbiBpZiBpdCdzIG5vdCBhbiBvYnNlcnZhYmxlLgoJICAgIHZhciB0d29XYXlCaW5kaW5ncyA9IHt9OwoKCSAgICBmdW5jdGlvbiBwcmVQcm9jZXNzQmluZGluZ3MoYmluZGluZ3NTdHJpbmdPcktleVZhbHVlQXJyYXksIGJpbmRpbmdPcHRpb25zKSB7CgkgICAgICAgIGJpbmRpbmdPcHRpb25zID0gYmluZGluZ09wdGlvbnMgfHwge307CgoJICAgICAgICBmdW5jdGlvbiBwcm9jZXNzS2V5VmFsdWUoa2V5LCB2YWwpIHsKCSAgICAgICAgICAgIHZhciB3cml0YWJsZVZhbDsKCSAgICAgICAgICAgIGZ1bmN0aW9uIGNhbGxQcmVwcm9jZXNzSG9vayhvYmopIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gKG9iaiAmJiBvYmpbJ3ByZXByb2Nlc3MnXSkgPyAodmFsID0gb2JqWydwcmVwcm9jZXNzJ10odmFsLCBrZXksIHByb2Nlc3NLZXlWYWx1ZSkpIDogdHJ1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmICghYmluZGluZ1BhcmFtcykgewoJICAgICAgICAgICAgICAgIGlmICghY2FsbFByZXByb2Nlc3NIb29rKGtvWydnZXRCaW5kaW5nSGFuZGxlciddKGtleSkpKQoJICAgICAgICAgICAgICAgICAgICByZXR1cm47CgoJICAgICAgICAgICAgICAgIGlmICh0d29XYXlCaW5kaW5nc1trZXldICYmICh3cml0YWJsZVZhbCA9IGdldFdyaXRlYWJsZVZhbHVlKHZhbCkpKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEZvciB0d28td2F5IGJpbmRpbmdzLCBwcm92aWRlIGEgd3JpdGUgbWV0aG9kIGluIGNhc2UgdGhlIHZhbHVlCgkgICAgICAgICAgICAgICAgICAgIC8vIGlzbid0IGEgd3JpdGFibGUgb2JzZXJ2YWJsZS4KCSAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3MucHVzaCgiJyIgKyBrZXkgKyAiJzpmdW5jdGlvbihfeil7IiArIHdyaXRhYmxlVmFsICsgIj1fen0iKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICAvLyBWYWx1ZXMgYXJlIHdyYXBwZWQgaW4gYSBmdW5jdGlvbiBzbyB0aGF0IGVhY2ggdmFsdWUgY2FuIGJlIGFjY2Vzc2VkIGluZGVwZW5kZW50bHkKCSAgICAgICAgICAgIGlmIChtYWtlVmFsdWVBY2Nlc3NvcnMpIHsKCSAgICAgICAgICAgICAgICB2YWwgPSAnZnVuY3Rpb24oKXtyZXR1cm4gJyArIHZhbCArICcgfSc7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXN1bHRTdHJpbmdzLnB1c2goIiciICsga2V5ICsgIic6IiArIHZhbCk7CgkgICAgICAgIH0KCgkgICAgICAgIHZhciByZXN1bHRTdHJpbmdzID0gW10sCgkgICAgICAgICAgICBwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncyA9IFtdLAoJICAgICAgICAgICAgbWFrZVZhbHVlQWNjZXNzb3JzID0gYmluZGluZ09wdGlvbnNbJ3ZhbHVlQWNjZXNzb3JzJ10sCgkgICAgICAgICAgICBiaW5kaW5nUGFyYW1zID0gYmluZGluZ09wdGlvbnNbJ2JpbmRpbmdQYXJhbXMnXSwKCSAgICAgICAgICAgIGtleVZhbHVlQXJyYXkgPSB0eXBlb2YgYmluZGluZ3NTdHJpbmdPcktleVZhbHVlQXJyYXkgPT09ICJzdHJpbmciID8KCSAgICAgICAgICAgICAgICBwYXJzZU9iamVjdExpdGVyYWwoYmluZGluZ3NTdHJpbmdPcktleVZhbHVlQXJyYXkpIDogYmluZGluZ3NTdHJpbmdPcktleVZhbHVlQXJyYXk7CgoJICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goa2V5VmFsdWVBcnJheSwgZnVuY3Rpb24oa2V5VmFsdWUpIHsKCSAgICAgICAgICAgIHByb2Nlc3NLZXlWYWx1ZShrZXlWYWx1ZS5rZXkgfHwga2V5VmFsdWVbJ3Vua25vd24nXSwga2V5VmFsdWUudmFsdWUpOwoJICAgICAgICB9KTsKCgkgICAgICAgIGlmIChwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncy5sZW5ndGgpCgkgICAgICAgICAgICBwcm9jZXNzS2V5VmFsdWUoJ19rb19wcm9wZXJ0eV93cml0ZXJzJywgInsiICsgcHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3Muam9pbigiLCIpICsgIiB9Iik7CgoJICAgICAgICByZXR1cm4gcmVzdWx0U3RyaW5ncy5qb2luKCIsIik7CgkgICAgfQoKCSAgICByZXR1cm4gewoJICAgICAgICBiaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnM6IFtdLAoKCSAgICAgICAgdHdvV2F5QmluZGluZ3M6IHR3b1dheUJpbmRpbmdzLAoKCSAgICAgICAgcGFyc2VPYmplY3RMaXRlcmFsOiBwYXJzZU9iamVjdExpdGVyYWwsCgoJICAgICAgICBwcmVQcm9jZXNzQmluZGluZ3M6IHByZVByb2Nlc3NCaW5kaW5ncywKCgkgICAgICAgIGtleVZhbHVlQXJyYXlDb250YWluc0tleTogZnVuY3Rpb24oa2V5VmFsdWVBcnJheSwga2V5KSB7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleVZhbHVlQXJyYXkubGVuZ3RoOyBpKyspCgkgICAgICAgICAgICAgICAgaWYgKGtleVZhbHVlQXJyYXlbaV1bJ2tleSddID09IGtleSkKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0sCgoJICAgICAgICAvLyBJbnRlcm5hbCwgcHJpdmF0ZSBLTyB1dGlsaXR5IGZvciB1cGRhdGluZyBtb2RlbCBwcm9wZXJ0aWVzIGZyb20gd2l0aGluIGJpbmRpbmdzCgkgICAgICAgIC8vIHByb3BlcnR5OiAgICAgICAgICAgIElmIHRoZSBwcm9wZXJ0eSBiZWluZyB1cGRhdGVkIGlzIChvciBtaWdodCBiZSkgYW4gb2JzZXJ2YWJsZSwgcGFzcyBpdCBoZXJlCgkgICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIElmIGl0IHR1cm5zIG91dCB0byBiZSBhIHdyaXRhYmxlIG9ic2VydmFibGUsIGl0IHdpbGwgYmUgd3JpdHRlbiB0byBkaXJlY3RseQoJICAgICAgICAvLyBhbGxCaW5kaW5nczogICAgICAgICBBbiBvYmplY3Qgd2l0aCBhIGdldCBtZXRob2QgdG8gcmV0cmlldmUgYmluZGluZ3MgaW4gdGhlIGN1cnJlbnQgZXhlY3V0aW9uIGNvbnRleHQuCgkgICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIFRoaXMgd2lsbCBiZSBzZWFyY2hlZCBmb3IgYSAnX2tvX3Byb3BlcnR5X3dyaXRlcnMnIHByb3BlcnR5IGluIGNhc2UgeW91J3JlIHdyaXRpbmcgdG8gYSBub24tb2JzZXJ2YWJsZQoJICAgICAgICAvLyBrZXk6ICAgICAgICAgICAgICAgICBUaGUga2V5IGlkZW50aWZ5aW5nIHRoZSBwcm9wZXJ0eSB0byBiZSB3cml0dGVuLiBFeGFtcGxlOiBmb3IgeyBoYXNGb2N1czogbXlWYWx1ZSB9LCB3cml0ZSB0byAnbXlWYWx1ZScgYnkgc3BlY2lmeWluZyB0aGUga2V5ICdoYXNGb2N1cycKCSAgICAgICAgLy8gdmFsdWU6ICAgICAgICAgICAgICAgVGhlIHZhbHVlIHRvIGJlIHdyaXR0ZW4KCSAgICAgICAgLy8gY2hlY2tJZkRpZmZlcmVudDogICAgSWYgdHJ1ZSwgYW5kIGlmIHRoZSBwcm9wZXJ0eSBiZWluZyB3cml0dGVuIGlzIGEgd3JpdGFibGUgb2JzZXJ2YWJsZSwgdGhlIHZhbHVlIHdpbGwgb25seSBiZSB3cml0dGVuIGlmCgkgICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIGl0IGlzICE9PSBleGlzdGluZyB2YWx1ZSBvbiB0aGF0IHdyaXRhYmxlIG9ic2VydmFibGUKCSAgICAgICAgd3JpdGVWYWx1ZVRvUHJvcGVydHk6IGZ1bmN0aW9uKHByb3BlcnR5LCBhbGxCaW5kaW5ncywga2V5LCB2YWx1ZSwgY2hlY2tJZkRpZmZlcmVudCkgewoJICAgICAgICAgICAgaWYgKCFwcm9wZXJ0eSB8fCAha28uaXNPYnNlcnZhYmxlKHByb3BlcnR5KSkgewoJICAgICAgICAgICAgICAgIHZhciBwcm9wV3JpdGVycyA9IGFsbEJpbmRpbmdzLmdldCgnX2tvX3Byb3BlcnR5X3dyaXRlcnMnKTsKCSAgICAgICAgICAgICAgICBpZiAocHJvcFdyaXRlcnMgJiYgcHJvcFdyaXRlcnNba2V5XSkKCSAgICAgICAgICAgICAgICAgICAgcHJvcFdyaXRlcnNba2V5XSh2YWx1ZSk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKGtvLmlzV3JpdGVhYmxlT2JzZXJ2YWJsZShwcm9wZXJ0eSkgJiYgKCFjaGVja0lmRGlmZmVyZW50IHx8IHByb3BlcnR5LnBlZWsoKSAhPT0gdmFsdWUpKSB7CgkgICAgICAgICAgICAgICAgcHJvcGVydHkodmFsdWUpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfTsKCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCdleHByZXNzaW9uUmV3cml0aW5nJywga28uZXhwcmVzc2lvblJld3JpdGluZyk7Cglrby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzJywga28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnMpOwoJa28uZXhwb3J0U3ltYm9sKCdleHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbCcsIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsKTsKCWtvLmV4cG9ydFN5bWJvbCgnZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MnLCBrby5leHByZXNzaW9uUmV3cml0aW5nLnByZVByb2Nlc3NCaW5kaW5ncyk7CgoJLy8gTWFraW5nIGJpbmRpbmdzIGV4cGxpY2l0bHkgZGVjbGFyZSB0aGVtc2VsdmVzIGFzICJ0d28gd2F5IiBpc24ndCBpZGVhbCBpbiB0aGUgbG9uZyB0ZXJtIChpdCB3b3VsZCBiZSBiZXR0ZXIgaWYKCS8vIGFsbCBiaW5kaW5ncyBjb3VsZCB1c2UgYW4gb2ZmaWNpYWwgJ3Byb3BlcnR5IHdyaXRlcicgQVBJIHdpdGhvdXQgbmVlZGluZyB0byBkZWNsYXJlIHRoYXQgdGhleSBtaWdodCkuIEhvd2V2ZXIsCgkvLyBzaW5jZSB0aGlzIGlzIG5vdCwgYW5kIGhhcyBuZXZlciBiZWVuLCBhIHB1YmxpYyBBUEkgKF9rb19wcm9wZXJ0eV93cml0ZXJzIHdhcyBuZXZlciBkb2N1bWVudGVkKSwgaXQncyBhY2NlcHRhYmxlCgkvLyBhcyBhbiBpbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBkZXRhaWwgaW4gdGhlIHNob3J0IHRlcm0uCgkvLyBGb3IgdGhvc2UgZGV2ZWxvcGVycyB3aG8gcmVseSBvbiBfa29fcHJvcGVydHlfd3JpdGVycyBpbiB0aGVpciBjdXN0b20gYmluZGluZ3MsIHdlIGV4cG9zZSBfdHdvV2F5QmluZGluZ3MgYXMgYW4KCS8vIHVuZG9jdW1lbnRlZCBmZWF0dXJlIHRoYXQgbWFrZXMgaXQgcmVsYXRpdmVseSBlYXN5IHRvIHVwZ3JhZGUgdG8gS08gMy4wLiBIb3dldmVyLCB0aGlzIGlzIHN0aWxsIG5vdCBhbiBvZmZpY2lhbAoJLy8gcHVibGljIEFQSSwgYW5kIHdlIHJlc2VydmUgdGhlIHJpZ2h0IHRvIHJlbW92ZSBpdCBhdCBhbnkgdGltZSBpZiB3ZSBjcmVhdGUgYSByZWFsIHB1YmxpYyBwcm9wZXJ0eSB3cml0ZXJzIEFQSS4KCWtvLmV4cG9ydFN5bWJvbCgnZXhwcmVzc2lvblJld3JpdGluZy5fdHdvV2F5QmluZGluZ3MnLCBrby5leHByZXNzaW9uUmV3cml0aW5nLnR3b1dheUJpbmRpbmdzKTsKCgkvLyBGb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgZGVmaW5lIHRoZSBmb2xsb3dpbmcgYWxpYXNlcy4gKFByZXZpb3VzbHksIHRoZXNlIGZ1bmN0aW9uIG5hbWVzIHdlcmUgbWlzbGVhZGluZyBiZWNhdXNlCgkvLyB0aGV5IHJlZmVycmVkIHRvIEpTT04gc3BlY2lmaWNhbGx5LCBldmVuIHRob3VnaCB0aGV5IGFjdHVhbGx5IHdvcmsgd2l0aCBhcmJpdHJhcnkgSmF2YVNjcmlwdCBvYmplY3QgbGl0ZXJhbCBleHByZXNzaW9ucy4pCglrby5leHBvcnRTeW1ib2woJ2pzb25FeHByZXNzaW9uUmV3cml0aW5nJywga28uZXhwcmVzc2lvblJld3JpdGluZyk7Cglrby5leHBvcnRTeW1ib2woJ2pzb25FeHByZXNzaW9uUmV3cml0aW5nLmluc2VydFByb3BlcnR5QWNjZXNzb3JzSW50b0pzb24nLCBrby5leHByZXNzaW9uUmV3cml0aW5nLnByZVByb2Nlc3NCaW5kaW5ncyk7CgkoZnVuY3Rpb24oKSB7CgkgICAgLy8gIlZpcnR1YWwgZWxlbWVudHMiIGlzIGFuIGFic3RyYWN0aW9uIG9uIHRvcCBvZiB0aGUgdXN1YWwgRE9NIEFQSSB3aGljaCB1bmRlcnN0YW5kcyB0aGUgbm90aW9uIHRoYXQgY29tbWVudCBub2RlcwoJICAgIC8vIG1heSBiZSB1c2VkIHRvIHJlcHJlc2VudCBoaWVyYXJjaHkgKGluIGFkZGl0aW9uIHRvIHRoZSBET00ncyBuYXR1cmFsIGhpZXJhcmNoeSkuCgkgICAgLy8gSWYgeW91IGNhbGwgdGhlIERPTS1tYW5pcHVsYXRpbmcgZnVuY3Rpb25zIG9uIGtvLnZpcnR1YWxFbGVtZW50cywgeW91IHdpbGwgYmUgYWJsZSB0byByZWFkIGFuZCB3cml0ZSB0aGUgc3RhdGUKCSAgICAvLyBvZiB0aGF0IHZpcnR1YWwgaGllcmFyY2h5CgkgICAgLy8KCSAgICAvLyBUaGUgcG9pbnQgb2YgYWxsIHRoaXMgaXMgdG8gc3VwcG9ydCBjb250YWluZXJsZXNzIHRlbXBsYXRlcyAoZS5nLiwgPCEtLSBrbyBmb3JlYWNoOnNvbWVDb2xsZWN0aW9uIC0tPmJsYWg8IS0tIC9rbyAtLT4pCgkgICAgLy8gd2l0aG91dCBoYXZpbmcgdG8gc2NhdHRlciBzcGVjaWFsIGNhc2VzIGFsbCBvdmVyIHRoZSBiaW5kaW5nIGFuZCB0ZW1wbGF0aW5nIGNvZGUuCgoJICAgIC8vIElFIDkgY2Fubm90IHJlbGlhYmx5IHJlYWQgdGhlICJub2RlVmFsdWUiIHByb3BlcnR5IG9mIGEgY29tbWVudCBub2RlIChzZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8xODYpCgkgICAgLy8gYnV0IGl0IGRvZXMgZ2l2ZSB0aGVtIGEgbm9uc3RhbmRhcmQgYWx0ZXJuYXRpdmUgcHJvcGVydHkgY2FsbGVkICJ0ZXh0IiB0aGF0IGl0IGNhbiByZWFkIHJlbGlhYmx5LiBPdGhlciBicm93c2VycyBkb24ndCBoYXZlIHRoYXQgcHJvcGVydHkuCgkgICAgLy8gU28sIHVzZSBub2RlLnRleHQgd2hlcmUgYXZhaWxhYmxlLCBhbmQgbm9kZS5ub2RlVmFsdWUgZWxzZXdoZXJlCgkgICAgdmFyIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPSBkb2N1bWVudCAmJiBkb2N1bWVudC5jcmVhdGVDb21tZW50KCJ0ZXN0IikudGV4dCA9PT0gIjwhLS10ZXN0LS0+IjsKCgkgICAgdmFyIHN0YXJ0Q29tbWVudFJlZ2V4ID0gY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IC9ePCEtLVxzKmtvKD86XHMrKFtcc1xTXSspKT9ccyotLT4kLyA6IC9eXHMqa28oPzpccysoW1xzXFNdKykpP1xzKiQvOwoJICAgIHZhciBlbmRDb21tZW50UmVnZXggPSAgIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyAvXjwhLS1ccypcL2tvXHMqLS0+JC8gOiAvXlxzKlwva29ccyokLzsKCSAgICB2YXIgaHRtbFRhZ3NXaXRoT3B0aW9uYWxseUNsb3NpbmdDaGlsZHJlbiA9IHsgJ3VsJzogdHJ1ZSwgJ29sJzogdHJ1ZSB9OwoKCSAgICBmdW5jdGlvbiBpc1N0YXJ0Q29tbWVudChub2RlKSB7CgkgICAgICAgIHJldHVybiAobm9kZS5ub2RlVHlwZSA9PSA4KSAmJiBzdGFydENvbW1lbnRSZWdleC50ZXN0KGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyBub2RlLnRleHQgOiBub2RlLm5vZGVWYWx1ZSk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBpc0VuZENvbW1lbnQobm9kZSkgewoJICAgICAgICByZXR1cm4gKG5vZGUubm9kZVR5cGUgPT0gOCkgJiYgZW5kQ29tbWVudFJlZ2V4LnRlc3QoY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IG5vZGUudGV4dCA6IG5vZGUubm9kZVZhbHVlKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGdldFZpcnR1YWxDaGlsZHJlbihzdGFydENvbW1lbnQsIGFsbG93VW5iYWxhbmNlZCkgewoJICAgICAgICB2YXIgY3VycmVudE5vZGUgPSBzdGFydENvbW1lbnQ7CgkgICAgICAgIHZhciBkZXB0aCA9IDE7CgkgICAgICAgIHZhciBjaGlsZHJlbiA9IFtdOwoJICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5uZXh0U2libGluZykgewoJICAgICAgICAgICAgaWYgKGlzRW5kQ29tbWVudChjdXJyZW50Tm9kZSkpIHsKCSAgICAgICAgICAgICAgICBkZXB0aC0tOwoJICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goY3VycmVudE5vZGUpOwoKCSAgICAgICAgICAgIGlmIChpc1N0YXJ0Q29tbWVudChjdXJyZW50Tm9kZSkpCgkgICAgICAgICAgICAgICAgZGVwdGgrKzsKCSAgICAgICAgfQoJICAgICAgICBpZiAoIWFsbG93VW5iYWxhbmNlZCkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgY2xvc2luZyBjb21tZW50IHRhZyB0byBtYXRjaDogIiArIHN0YXJ0Q29tbWVudC5ub2RlVmFsdWUpOwoJICAgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGdldE1hdGNoaW5nRW5kQ29tbWVudChzdGFydENvbW1lbnQsIGFsbG93VW5iYWxhbmNlZCkgewoJICAgICAgICB2YXIgYWxsVmlydHVhbENoaWxkcmVuID0gZ2V0VmlydHVhbENoaWxkcmVuKHN0YXJ0Q29tbWVudCwgYWxsb3dVbmJhbGFuY2VkKTsKCSAgICAgICAgaWYgKGFsbFZpcnR1YWxDaGlsZHJlbikgewoJICAgICAgICAgICAgaWYgKGFsbFZpcnR1YWxDaGlsZHJlbi5sZW5ndGggPiAwKQoJICAgICAgICAgICAgICAgIHJldHVybiBhbGxWaXJ0dWFsQ2hpbGRyZW5bYWxsVmlydHVhbENoaWxkcmVuLmxlbmd0aCAtIDFdLm5leHRTaWJsaW5nOwoJICAgICAgICAgICAgcmV0dXJuIHN0YXJ0Q29tbWVudC5uZXh0U2libGluZzsKCSAgICAgICAgfSBlbHNlCgkgICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gTXVzdCBoYXZlIG5vIG1hdGNoaW5nIGVuZCBjb21tZW50LCBhbmQgYWxsb3dVbmJhbGFuY2VkIGlzIHRydWUKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGdldFVuYmFsYW5jZWRDaGlsZFRhZ3Mobm9kZSkgewoJICAgICAgICAvLyBlLmcuLCBmcm9tIDxkaXY+T0s8L2Rpdj48IS0tIGtvIGJsYWggLS0+PHNwYW4+QW5vdGhlcjwvc3Bhbj4sIHJldHVybnM6IDwhLS0ga28gYmxhaCAtLT48c3Bhbj5Bbm90aGVyPC9zcGFuPgoJICAgICAgICAvLyAgICAgICBmcm9tIDxkaXY+T0s8L2Rpdj48IS0tIC9rbyAtLT48IS0tIC9rbyAtLT4sICAgICAgICAgICAgIHJldHVybnM6IDwhLS0gL2tvIC0tPjwhLS0gL2tvIC0tPgoJICAgICAgICB2YXIgY2hpbGROb2RlID0gbm9kZS5maXJzdENoaWxkLCBjYXB0dXJlUmVtYWluaW5nID0gbnVsbDsKCSAgICAgICAgaWYgKGNoaWxkTm9kZSkgewoJICAgICAgICAgICAgZG8gewoJICAgICAgICAgICAgICAgIGlmIChjYXB0dXJlUmVtYWluaW5nKSAgICAgICAgICAgICAgICAgICAvLyBXZSBhbHJlYWR5IGhpdCBhbiB1bmJhbGFuY2VkIG5vZGUgYW5kIGFyZSBub3cganVzdCBzY29vcGluZyB1cCBhbGwgc3Vic2VxdWVudCBub2RlcwoJICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nLnB1c2goY2hpbGROb2RlKTsKCSAgICAgICAgICAgICAgICBlbHNlIGlmIChpc1N0YXJ0Q29tbWVudChjaGlsZE5vZGUpKSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaGluZ0VuZENvbW1lbnQgPSBnZXRNYXRjaGluZ0VuZENvbW1lbnQoY2hpbGROb2RlLCAvKiBhbGxvd1VuYmFsYW5jZWQ6ICovIHRydWUpOwoJICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hpbmdFbmRDb21tZW50KSAgICAgICAgICAgICAvLyBJdCdzIGEgYmFsYW5jZWQgdGFnLCBzbyBza2lwIGltbWVkaWF0ZWx5IHRvIHRoZSBlbmQgb2YgdGhpcyB2aXJ0dWFsIHNldAoJICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlID0gbWF0Y2hpbmdFbmRDb21tZW50OwoJICAgICAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nID0gW2NoaWxkTm9kZV07IC8vIEl0J3MgdW5iYWxhbmNlZCwgc28gc3RhcnQgY2FwdHVyaW5nIGZyb20gdGhpcyBwb2ludAoJICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFbmRDb21tZW50KGNoaWxkTm9kZSkpIHsKCSAgICAgICAgICAgICAgICAgICAgY2FwdHVyZVJlbWFpbmluZyA9IFtjaGlsZE5vZGVdOyAgICAgLy8gSXQncyB1bmJhbGFuY2VkIChpZiBpdCB3YXNuJ3QsIHdlJ2QgaGF2ZSBza2lwcGVkIG92ZXIgaXQgYWxyZWFkeSksIHNvIHN0YXJ0IGNhcHR1cmluZwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gd2hpbGUgKGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5uZXh0U2libGluZyk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIGNhcHR1cmVSZW1haW5pbmc7CgkgICAgfQoKCSAgICBrby52aXJ0dWFsRWxlbWVudHMgPSB7CgkgICAgICAgIGFsbG93ZWRCaW5kaW5nczoge30sCgoJICAgICAgICBjaGlsZE5vZGVzOiBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICByZXR1cm4gaXNTdGFydENvbW1lbnQobm9kZSkgPyBnZXRWaXJ0dWFsQ2hpbGRyZW4obm9kZSkgOiBub2RlLmNoaWxkTm9kZXM7CgkgICAgICAgIH0sCgoJICAgICAgICBlbXB0eU5vZGU6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIGlmICghaXNTdGFydENvbW1lbnQobm9kZSkpCgkgICAgICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKG5vZGUpOwoJICAgICAgICAgICAgZWxzZSB7CgkgICAgICAgICAgICAgICAgdmFyIHZpcnR1YWxDaGlsZHJlbiA9IGtvLnZpcnR1YWxFbGVtZW50cy5jaGlsZE5vZGVzKG5vZGUpOwoJICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmlydHVhbENoaWxkcmVuLmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICAgICAga28ucmVtb3ZlTm9kZSh2aXJ0dWFsQ2hpbGRyZW5baV0pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgc2V0RG9tTm9kZUNoaWxkcmVuOiBmdW5jdGlvbihub2RlLCBjaGlsZE5vZGVzKSB7CgkgICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KG5vZGUpKQoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbihub2RlLCBjaGlsZE5vZGVzKTsKCSAgICAgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5lbXB0eU5vZGUobm9kZSk7CgkgICAgICAgICAgICAgICAgdmFyIGVuZENvbW1lbnROb2RlID0gbm9kZS5uZXh0U2libGluZzsgLy8gTXVzdCBiZSB0aGUgbmV4dCBzaWJsaW5nLCBhcyB3ZSBqdXN0IGVtcHRpZWQgdGhlIGNoaWxkcmVuCgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBjaGlsZE5vZGVzLmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICAgICAgZW5kQ29tbWVudE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGROb2Rlc1tpXSwgZW5kQ29tbWVudE5vZGUpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgcHJlcGVuZDogZnVuY3Rpb24oY29udGFpbmVyTm9kZSwgbm9kZVRvUHJlcGVuZCkgewoJICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChjb250YWluZXJOb2RlKSkgewoJICAgICAgICAgICAgICAgIGlmIChjb250YWluZXJOb2RlLmZpcnN0Q2hpbGQpCgkgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuaW5zZXJ0QmVmb3JlKG5vZGVUb1ByZXBlbmQsIGNvbnRhaW5lck5vZGUuZmlyc3RDaGlsZCk7CgkgICAgICAgICAgICAgICAgZWxzZQoJICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmFwcGVuZENoaWxkKG5vZGVUb1ByZXBlbmQpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAvLyBTdGFydCBjb21tZW50cyBtdXN0IGFsd2F5cyBoYXZlIGEgcGFyZW50IGFuZCBhdCBsZWFzdCBvbmUgZm9sbG93aW5nIHNpYmxpbmcgKHRoZSBlbmQgY29tbWVudCkKCSAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5vZGVUb1ByZXBlbmQsIGNvbnRhaW5lck5vZGUubmV4dFNpYmxpbmcpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgaW5zZXJ0QWZ0ZXI6IGZ1bmN0aW9uKGNvbnRhaW5lck5vZGUsIG5vZGVUb0luc2VydCwgaW5zZXJ0QWZ0ZXJOb2RlKSB7CgkgICAgICAgICAgICBpZiAoIWluc2VydEFmdGVyTm9kZSkgewoJICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5wcmVwZW5kKGNvbnRhaW5lck5vZGUsIG5vZGVUb0luc2VydCk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc1N0YXJ0Q29tbWVudChjb250YWluZXJOb2RlKSkgewoJICAgICAgICAgICAgICAgIC8vIEluc2VydCBhZnRlciBpbnNlcnRpb24gcG9pbnQKCSAgICAgICAgICAgICAgICBpZiAoaW5zZXJ0QWZ0ZXJOb2RlLm5leHRTaWJsaW5nKQoJICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmluc2VydEJlZm9yZShub2RlVG9JbnNlcnQsIGluc2VydEFmdGVyTm9kZS5uZXh0U2libGluZyk7CgkgICAgICAgICAgICAgICAgZWxzZQoJICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmFwcGVuZENoaWxkKG5vZGVUb0luc2VydCk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIENoaWxkcmVuIG9mIHN0YXJ0IGNvbW1lbnRzIG11c3QgYWx3YXlzIGhhdmUgYSBwYXJlbnQgYW5kIGF0IGxlYXN0IG9uZSBmb2xsb3dpbmcgc2libGluZyAodGhlIGVuZCBjb21tZW50KQoJICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUubmV4dFNpYmxpbmcpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgZmlyc3RDaGlsZDogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChub2RlKSkKCSAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5maXJzdENoaWxkOwoJICAgICAgICAgICAgaWYgKCFub2RlLm5leHRTaWJsaW5nIHx8IGlzRW5kQ29tbWVudChub2RlLm5leHRTaWJsaW5nKSkKCSAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKCSAgICAgICAgICAgIHJldHVybiBub2RlLm5leHRTaWJsaW5nOwoJICAgICAgICB9LAoKCSAgICAgICAgbmV4dFNpYmxpbmc6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIGlmIChpc1N0YXJ0Q29tbWVudChub2RlKSkKCSAgICAgICAgICAgICAgICBub2RlID0gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KG5vZGUpOwoJICAgICAgICAgICAgaWYgKG5vZGUubmV4dFNpYmxpbmcgJiYgaXNFbmRDb21tZW50KG5vZGUubmV4dFNpYmxpbmcpKQoJICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwoJICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CgkgICAgICAgIH0sCgoJICAgICAgICBoYXNCaW5kaW5nVmFsdWU6IGlzU3RhcnRDb21tZW50LAoKCSAgICAgICAgdmlydHVhbE5vZGVCaW5kaW5nVmFsdWU6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIHZhciByZWdleE1hdGNoID0gKGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyBub2RlLnRleHQgOiBub2RlLm5vZGVWYWx1ZSkubWF0Y2goc3RhcnRDb21tZW50UmVnZXgpOwoJICAgICAgICAgICAgcmV0dXJuIHJlZ2V4TWF0Y2ggPyByZWdleE1hdGNoWzFdIDogbnVsbDsKCSAgICAgICAgfSwKCgkgICAgICAgIG5vcm1hbGlzZVZpcnR1YWxFbGVtZW50RG9tU3RydWN0dXJlOiBmdW5jdGlvbihlbGVtZW50VmVyaWZpZWQpIHsKCSAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTU1CgkgICAgICAgICAgICAvLyAoSUUgPD0gOCBvciBJRSA5IHF1aXJrcyBtb2RlIHBhcnNlcyB5b3VyIEhUTUwgd2VpcmRseSwgdHJlYXRpbmcgY2xvc2luZyA8L2xpPiB0YWdzIGFzIGlmIHRoZXkgZG9uJ3QgZXhpc3QsIHRoZXJlYnkgbW92aW5nIGNvbW1lbnQgbm9kZXMKCSAgICAgICAgICAgIC8vIHRoYXQgYXJlIGRpcmVjdCBkZXNjZW5kYW50cyBvZiA8dWw+IGludG8gdGhlIHByZWNlZGluZyA8bGk+KQoJICAgICAgICAgICAgaWYgKCFodG1sVGFnc1dpdGhPcHRpb25hbGx5Q2xvc2luZ0NoaWxkcmVuW2tvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50VmVyaWZpZWQpXSkKCSAgICAgICAgICAgICAgICByZXR1cm47CgoJICAgICAgICAgICAgLy8gU2NhbiBpbW1lZGlhdGUgY2hpbGRyZW4gdG8gc2VlIGlmIHRoZXkgY29udGFpbiB1bmJhbGFuY2VkIGNvbW1lbnQgdGFncy4gSWYgdGhleSBkbywgdGhvc2UgY29tbWVudCB0YWdzCgkgICAgICAgICAgICAvLyBtdXN0IGJlIGludGVuZGVkIHRvIGFwcGVhciAqYWZ0ZXIqIHRoYXQgY2hpbGQsIHNvIG1vdmUgdGhlbSB0aGVyZS4KCSAgICAgICAgICAgIHZhciBjaGlsZE5vZGUgPSBlbGVtZW50VmVyaWZpZWQuZmlyc3RDaGlsZDsKCSAgICAgICAgICAgIGlmIChjaGlsZE5vZGUpIHsKCSAgICAgICAgICAgICAgICBkbyB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZE5vZGUubm9kZVR5cGUgPT09IDEpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1bmJhbGFuY2VkVGFncyA9IGdldFVuYmFsYW5jZWRDaGlsZFRhZ3MoY2hpbGROb2RlKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmJhbGFuY2VkVGFncykgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpeCB1cCB0aGUgRE9NIGJ5IG1vdmluZyB0aGUgdW5iYWxhbmNlZCB0YWdzIHRvIHdoZXJlIHRoZXkgbW9zdCBsaWtlbHkgd2VyZSBpbnRlbmRlZCB0byBiZSBwbGFjZWQgLSAqYWZ0ZXIqIHRoZSBjaGlsZAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlVG9JbnNlcnRCZWZvcmUgPSBjaGlsZE5vZGUubmV4dFNpYmxpbmc7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1bmJhbGFuY2VkVGFncy5sZW5ndGg7IGkrKykgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZVRvSW5zZXJ0QmVmb3JlKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFZlcmlmaWVkLmluc2VydEJlZm9yZSh1bmJhbGFuY2VkVGFnc1tpXSwgbm9kZVRvSW5zZXJ0QmVmb3JlKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFZlcmlmaWVkLmFwcGVuZENoaWxkKHVuYmFsYW5jZWRUYWdzW2ldKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9IHdoaWxlIChjaGlsZE5vZGUgPSBjaGlsZE5vZGUubmV4dFNpYmxpbmcpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfTsKCX0pKCk7Cglrby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cycsIGtvLnZpcnR1YWxFbGVtZW50cyk7Cglrby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3MnLCBrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzKTsKCWtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZScsIGtvLnZpcnR1YWxFbGVtZW50cy5lbXB0eU5vZGUpOwoJLy9rby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5maXJzdENoaWxkJywga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQpOyAgICAgLy8gZmlyc3RDaGlsZCBpcyBub3QgbWluaWZpZWQKCWtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmluc2VydEFmdGVyJywga28udmlydHVhbEVsZW1lbnRzLmluc2VydEFmdGVyKTsKCS8va28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcnLCBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcpOyAgIC8vIG5leHRTaWJsaW5nIGlzIG5vdCBtaW5pZmllZAoJa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMucHJlcGVuZCcsIGtvLnZpcnR1YWxFbGVtZW50cy5wcmVwZW5kKTsKCWtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbicsIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4pOwoJKGZ1bmN0aW9uKCkgewoJICAgIHZhciBkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUgPSAiZGF0YS1iaW5kIjsKCgkgICAga28uYmluZGluZ1Byb3ZpZGVyID0gZnVuY3Rpb24oKSB7CgkgICAgICAgIHRoaXMuYmluZGluZ0NhY2hlID0ge307CgkgICAgfTsKCgkgICAga28udXRpbHMuZXh0ZW5kKGtvLmJpbmRpbmdQcm92aWRlci5wcm90b3R5cGUsIHsKCSAgICAgICAgJ25vZGVIYXNCaW5kaW5ncyc6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIHN3aXRjaCAobm9kZS5ub2RlVHlwZSkgewoJICAgICAgICAgICAgICAgIGNhc2UgMTogLy8gRWxlbWVudAoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5nZXRBdHRyaWJ1dGUoZGVmYXVsdEJpbmRpbmdBdHRyaWJ1dGVOYW1lKSAhPSBudWxsCgkgICAgICAgICAgICAgICAgICAgICAgICB8fCBrby5jb21wb25lbnRzWydnZXRDb21wb25lbnROYW1lRm9yTm9kZSddKG5vZGUpOwoJICAgICAgICAgICAgICAgIGNhc2UgODogLy8gQ29tbWVudCBub2RlCgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBrby52aXJ0dWFsRWxlbWVudHMuaGFzQmluZGluZ1ZhbHVlKG5vZGUpOwoJICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBmYWxzZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgICdnZXRCaW5kaW5ncyc6IGZ1bmN0aW9uKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgICAgICB2YXIgYmluZGluZ3NTdHJpbmcgPSB0aGlzWydnZXRCaW5kaW5nc1N0cmluZyddKG5vZGUsIGJpbmRpbmdDb250ZXh0KSwKCSAgICAgICAgICAgICAgICBwYXJzZWRCaW5kaW5ncyA9IGJpbmRpbmdzU3RyaW5nID8gdGhpc1sncGFyc2VCaW5kaW5nc1N0cmluZyddKGJpbmRpbmdzU3RyaW5nLCBiaW5kaW5nQ29udGV4dCwgbm9kZSkgOiBudWxsOwoJICAgICAgICAgICAgcmV0dXJuIGtvLmNvbXBvbmVudHMuYWRkQmluZGluZ3NGb3JDdXN0b21FbGVtZW50KHBhcnNlZEJpbmRpbmdzLCBub2RlLCBiaW5kaW5nQ29udGV4dCwgLyogdmFsdWVBY2Nlc3NvcnMgKi8gZmFsc2UpOwoJICAgICAgICB9LAoKCSAgICAgICAgJ2dldEJpbmRpbmdBY2Nlc3NvcnMnOiBmdW5jdGlvbihub2RlLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAgICAgdmFyIGJpbmRpbmdzU3RyaW5nID0gdGhpc1snZ2V0QmluZGluZ3NTdHJpbmcnXShub2RlLCBiaW5kaW5nQ29udGV4dCksCgkgICAgICAgICAgICAgICAgcGFyc2VkQmluZGluZ3MgPSBiaW5kaW5nc1N0cmluZyA/IHRoaXNbJ3BhcnNlQmluZGluZ3NTdHJpbmcnXShiaW5kaW5nc1N0cmluZywgYmluZGluZ0NvbnRleHQsIG5vZGUsIHsgJ3ZhbHVlQWNjZXNzb3JzJzogdHJ1ZSB9KSA6IG51bGw7CgkgICAgICAgICAgICByZXR1cm4ga28uY29tcG9uZW50cy5hZGRCaW5kaW5nc0ZvckN1c3RvbUVsZW1lbnQocGFyc2VkQmluZGluZ3MsIG5vZGUsIGJpbmRpbmdDb250ZXh0LCAvKiB2YWx1ZUFjY2Vzc29ycyAqLyB0cnVlKTsKCSAgICAgICAgfSwKCgkgICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gaXMgb25seSB1c2VkIGludGVybmFsbHkgYnkgdGhpcyBkZWZhdWx0IHByb3ZpZGVyLgoJICAgICAgICAvLyBJdCdzIG5vdCBwYXJ0IG9mIHRoZSBpbnRlcmZhY2UgZGVmaW5pdGlvbiBmb3IgYSBnZW5lcmFsIGJpbmRpbmcgcHJvdmlkZXIuCgkgICAgICAgICdnZXRCaW5kaW5nc1N0cmluZyc6IGZ1bmN0aW9uKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgICAgICBzd2l0Y2ggKG5vZGUubm9kZVR5cGUpIHsKCSAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUpOyAgIC8vIEVsZW1lbnQKCSAgICAgICAgICAgICAgICBjYXNlIDg6IHJldHVybiBrby52aXJ0dWFsRWxlbWVudHMudmlydHVhbE5vZGVCaW5kaW5nVmFsdWUobm9kZSk7IC8vIENvbW1lbnQgbm9kZQoJICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBudWxsOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBpcyBvbmx5IHVzZWQgaW50ZXJuYWxseSBieSB0aGlzIGRlZmF1bHQgcHJvdmlkZXIuCgkgICAgICAgIC8vIEl0J3Mgbm90IHBhcnQgb2YgdGhlIGludGVyZmFjZSBkZWZpbml0aW9uIGZvciBhIGdlbmVyYWwgYmluZGluZyBwcm92aWRlci4KCSAgICAgICAgJ3BhcnNlQmluZGluZ3NTdHJpbmcnOiBmdW5jdGlvbihiaW5kaW5nc1N0cmluZywgYmluZGluZ0NvbnRleHQsIG5vZGUsIG9wdGlvbnMpIHsKCSAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdGdW5jdGlvbiA9IGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yVmlhQ2FjaGUoYmluZGluZ3NTdHJpbmcsIHRoaXMuYmluZGluZ0NhY2hlLCBvcHRpb25zKTsKCSAgICAgICAgICAgICAgICByZXR1cm4gYmluZGluZ0Z1bmN0aW9uKGJpbmRpbmdDb250ZXh0LCBub2RlKTsKCSAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CgkgICAgICAgICAgICAgICAgZXgubWVzc2FnZSA9ICJVbmFibGUgdG8gcGFyc2UgYmluZGluZ3MuXG5CaW5kaW5ncyB2YWx1ZTogIiArIGJpbmRpbmdzU3RyaW5nICsgIlxuTWVzc2FnZTogIiArIGV4Lm1lc3NhZ2U7CgkgICAgICAgICAgICAgICAgdGhyb3cgZXg7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9KTsKCgkgICAga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddID0gbmV3IGtvLmJpbmRpbmdQcm92aWRlcigpOwoKCSAgICBmdW5jdGlvbiBjcmVhdGVCaW5kaW5nc1N0cmluZ0V2YWx1YXRvclZpYUNhY2hlKGJpbmRpbmdzU3RyaW5nLCBjYWNoZSwgb3B0aW9ucykgewoJICAgICAgICB2YXIgY2FjaGVLZXkgPSBiaW5kaW5nc1N0cmluZyArIChvcHRpb25zICYmIG9wdGlvbnNbJ3ZhbHVlQWNjZXNzb3JzJ10gfHwgJycpOwoJICAgICAgICByZXR1cm4gY2FjaGVbY2FjaGVLZXldCgkgICAgICAgICAgICB8fCAoY2FjaGVbY2FjaGVLZXldID0gY3JlYXRlQmluZGluZ3NTdHJpbmdFdmFsdWF0b3IoYmluZGluZ3NTdHJpbmcsIG9wdGlvbnMpKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yKGJpbmRpbmdzU3RyaW5nLCBvcHRpb25zKSB7CgkgICAgICAgIC8vIEJ1aWxkIHRoZSBzb3VyY2UgZm9yIGEgZnVuY3Rpb24gdGhhdCBldmFsdWF0ZXMgImV4cHJlc3Npb24iCgkgICAgICAgIC8vIEZvciBlYWNoIHNjb3BlIHZhcmlhYmxlLCBhZGQgYW4gZXh0cmEgbGV2ZWwgb2YgIndpdGgiIG5lc3RpbmcKCSAgICAgICAgLy8gRXhhbXBsZSByZXN1bHQ6IHdpdGgoc2MxKSB7IHdpdGgoc2MwKSB7IHJldHVybiAoZXhwcmVzc2lvbikgfSB9CgkgICAgICAgIHZhciByZXdyaXR0ZW5CaW5kaW5ncyA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucHJlUHJvY2Vzc0JpbmRpbmdzKGJpbmRpbmdzU3RyaW5nLCBvcHRpb25zKSwKCSAgICAgICAgICAgIGZ1bmN0aW9uQm9keSA9ICJ3aXRoKCRjb250ZXh0KXt3aXRoKCRkYXRhfHx7fSl7cmV0dXJueyIgKyByZXdyaXR0ZW5CaW5kaW5ncyArICJ9fX0iOwoJICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCIkY29udGV4dCIsICIkZWxlbWVudCIsIGZ1bmN0aW9uQm9keSk7CgkgICAgfQoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ2JpbmRpbmdQcm92aWRlcicsIGtvLmJpbmRpbmdQcm92aWRlcik7CgkoZnVuY3Rpb24gKCkgewoJICAgIGtvLmJpbmRpbmdIYW5kbGVycyA9IHt9OwoKCSAgICAvLyBUaGUgZm9sbG93aW5nIGVsZW1lbnQgdHlwZXMgd2lsbCBub3QgYmUgcmVjdXJzZWQgaW50byBkdXJpbmcgYmluZGluZy4gSW4gdGhlIGZ1dHVyZSwgd2UKCSAgICAvLyBtYXkgY29uc2lkZXIgYWRkaW5nIDx0ZW1wbGF0ZT4gdG8gdGhpcyBsaXN0LCBiZWNhdXNlIHN1Y2ggZWxlbWVudHMnIGNvbnRlbnRzIGFyZSBhbHdheXMKCSAgICAvLyBpbnRlbmRlZCB0byBiZSBib3VuZCBpbiBhIGRpZmZlcmVudCBjb250ZXh0IGZyb20gd2hlcmUgdGhleSBhcHBlYXIgaW4gdGhlIGRvY3VtZW50LgoJICAgIHZhciBiaW5kaW5nRG9lc05vdFJlY3Vyc2VJbnRvRWxlbWVudFR5cGVzID0gewoJICAgICAgICAvLyBEb24ndCB3YW50IGJpbmRpbmdzIHRoYXQgb3BlcmF0ZSBvbiB0ZXh0IG5vZGVzIHRvIG11dGF0ZSA8c2NyaXB0PiBjb250ZW50cywKCSAgICAgICAgLy8gYmVjYXVzZSBpdCdzIHVuZXhwZWN0ZWQgYW5kIGEgcG90ZW50aWFsIFhTUyBpc3N1ZQoJICAgICAgICAnc2NyaXB0JzogdHJ1ZQoJICAgIH07CgoJICAgIC8vIFVzZSBhbiBvdmVycmlkYWJsZSBtZXRob2QgZm9yIHJldHJpZXZpbmcgYmluZGluZyBoYW5kbGVycyBzbyB0aGF0IGEgcGx1Z2lucyBtYXkgc3VwcG9ydCBkeW5hbWljYWxseSBjcmVhdGVkIGhhbmRsZXJzCgkgICAga29bJ2dldEJpbmRpbmdIYW5kbGVyJ10gPSBmdW5jdGlvbihiaW5kaW5nS2V5KSB7CgkgICAgICAgIHJldHVybiBrby5iaW5kaW5nSGFuZGxlcnNbYmluZGluZ0tleV07CgkgICAgfTsKCgkgICAgLy8gVGhlIGtvLmJpbmRpbmdDb250ZXh0IGNvbnN0cnVjdG9yIGlzIG9ubHkgY2FsbGVkIGRpcmVjdGx5IHRvIGNyZWF0ZSB0aGUgcm9vdCBjb250ZXh0LiBGb3IgY2hpbGQKCSAgICAvLyBjb250ZXh0cywgdXNlIGJpbmRpbmdDb250ZXh0LmNyZWF0ZUNoaWxkQ29udGV4dCBvciBiaW5kaW5nQ29udGV4dC5leHRlbmQuCgkgICAga28uYmluZGluZ0NvbnRleHQgPSBmdW5jdGlvbihkYXRhSXRlbU9yQWNjZXNzb3IsIHBhcmVudENvbnRleHQsIGRhdGFJdGVtQWxpYXMsIGV4dGVuZENhbGxiYWNrKSB7CgoJICAgICAgICAvLyBUaGUgYmluZGluZyBjb250ZXh0IG9iamVjdCBpbmNsdWRlcyBzdGF0aWMgcHJvcGVydGllcyBmb3IgdGhlIGN1cnJlbnQsIHBhcmVudCwgYW5kIHJvb3QgdmlldyBtb2RlbHMuCgkgICAgICAgIC8vIElmIGEgdmlldyBtb2RlbCBpcyBhY3R1YWxseSBzdG9yZWQgaW4gYW4gb2JzZXJ2YWJsZSwgdGhlIGNvcnJlc3BvbmRpbmcgYmluZGluZyBjb250ZXh0IG9iamVjdCwgYW5kCgkgICAgICAgIC8vIGFueSBjaGlsZCBjb250ZXh0cywgbXVzdCBiZSB1cGRhdGVkIHdoZW4gdGhlIHZpZXcgbW9kZWwgaXMgY2hhbmdlZC4KCSAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGV4dCgpIHsKCSAgICAgICAgICAgIC8vIE1vc3Qgb2YgdGhlIHRpbWUsIHRoZSBjb250ZXh0IHdpbGwgZGlyZWN0bHkgZ2V0IGEgdmlldyBtb2RlbCBvYmplY3QsIGJ1dCBpZiBhIGZ1bmN0aW9uIGlzIGdpdmVuLAoJICAgICAgICAgICAgLy8gd2UgY2FsbCB0aGUgZnVuY3Rpb24gdG8gcmV0cmlldmUgdGhlIHZpZXcgbW9kZWwuIElmIHRoZSBmdW5jdGlvbiBhY2Nlc3NlcyBhbnkgb2JzZXZhYmxlcyBvciByZXR1cm5zCgkgICAgICAgICAgICAvLyBhbiBvYnNlcnZhYmxlLCB0aGUgZGVwZW5kZW5jeSBpcyB0cmFja2VkLCBhbmQgdGhvc2Ugb2JzZXJ2YWJsZXMgY2FuIGxhdGVyIGNhdXNlIHRoZSBiaW5kaW5nCgkgICAgICAgICAgICAvLyBjb250ZXh0IHRvIGJlIHVwZGF0ZWQuCgkgICAgICAgICAgICB2YXIgZGF0YUl0ZW1Pck9ic2VydmFibGUgPSBpc0Z1bmMgPyBkYXRhSXRlbU9yQWNjZXNzb3IoKSA6IGRhdGFJdGVtT3JBY2Nlc3NvciwKCSAgICAgICAgICAgICAgICBkYXRhSXRlbSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoZGF0YUl0ZW1Pck9ic2VydmFibGUpOwoKCSAgICAgICAgICAgIGlmIChwYXJlbnRDb250ZXh0KSB7CgkgICAgICAgICAgICAgICAgLy8gV2hlbiBhICJwYXJlbnQiIGNvbnRleHQgaXMgZ2l2ZW4sIHJlZ2lzdGVyIGEgZGVwZW5kZW5jeSBvbiB0aGUgcGFyZW50IGNvbnRleHQuIFRodXMgd2hlbmV2ZXIgdGhlCgkgICAgICAgICAgICAgICAgLy8gcGFyZW50IGNvbnRleHQgaXMgdXBkYXRlZCwgdGhpcyBjb250ZXh0IHdpbGwgYWxzbyBiZSB1cGRhdGVkLgoJICAgICAgICAgICAgICAgIGlmIChwYXJlbnRDb250ZXh0Ll9zdWJzY3JpYmFibGUpCgkgICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRleHQuX3N1YnNjcmliYWJsZSgpOwoKCSAgICAgICAgICAgICAgICAvLyBDb3B5ICRyb290IGFuZCBhbnkgY3VzdG9tIHByb3BlcnRpZXMgZnJvbSB0aGUgcGFyZW50IGNvbnRleHQKCSAgICAgICAgICAgICAgICBrby51dGlscy5leHRlbmQoc2VsZiwgcGFyZW50Q29udGV4dCk7CgoJICAgICAgICAgICAgICAgIC8vIEJlY2F1c2UgdGhlIGFib3ZlIGNvcHkgb3ZlcndyaXRlcyBvdXIgb3duIHByb3BlcnRpZXMsIHdlIG5lZWQgdG8gcmVzZXQgdGhlbS4KCSAgICAgICAgICAgICAgICAvLyBEdXJpbmcgdGhlIGZpcnN0IGV4ZWN1dGlvbiwgInN1YnNjcmliYWJsZSIgaXNuJ3Qgc2V0LCBzbyBkb24ndCBib3RoZXIgZG9pbmcgdGhlIHVwZGF0ZSB0aGVuLgoJICAgICAgICAgICAgICAgIGlmIChzdWJzY3JpYmFibGUpIHsKCSAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3Vic2NyaWJhYmxlID0gc3Vic2NyaWJhYmxlOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgc2VsZlsnJHBhcmVudHMnXSA9IFtdOwoJICAgICAgICAgICAgICAgIHNlbGZbJyRyb290J10gPSBkYXRhSXRlbTsKCgkgICAgICAgICAgICAgICAgLy8gRXhwb3J0ICdrbycgaW4gdGhlIGJpbmRpbmcgY29udGV4dCBzbyBpdCB3aWxsIGJlIGF2YWlsYWJsZSBpbiBiaW5kaW5ncyBhbmQgdGVtcGxhdGVzCgkgICAgICAgICAgICAgICAgLy8gZXZlbiBpZiAna28nIGlzbid0IGV4cG9ydGVkIGFzIGEgZ2xvYmFsLCBzdWNoIGFzIHdoZW4gdXNpbmcgYW4gQU1EIGxvYWRlci4KCSAgICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy80OTAKCSAgICAgICAgICAgICAgICBzZWxmWydrbyddID0ga287CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBzZWxmWyckcmF3RGF0YSddID0gZGF0YUl0ZW1Pck9ic2VydmFibGU7CgkgICAgICAgICAgICBzZWxmWyckZGF0YSddID0gZGF0YUl0ZW07CgkgICAgICAgICAgICBpZiAoZGF0YUl0ZW1BbGlhcykKCSAgICAgICAgICAgICAgICBzZWxmW2RhdGFJdGVtQWxpYXNdID0gZGF0YUl0ZW07CgoJICAgICAgICAgICAgLy8gVGhlIGV4dGVuZENhbGxiYWNrIGZ1bmN0aW9uIGlzIHByb3ZpZGVkIHdoZW4gY3JlYXRpbmcgYSBjaGlsZCBjb250ZXh0IG9yIGV4dGVuZGluZyBhIGNvbnRleHQuCgkgICAgICAgICAgICAvLyBJdCBoYW5kbGVzIHRoZSBzcGVjaWZpYyBhY3Rpb25zIG5lZWRlZCB0byBmaW5pc2ggc2V0dGluZyB1cCB0aGUgYmluZGluZyBjb250ZXh0LiBBY3Rpb25zIGluIHRoaXMKCSAgICAgICAgICAgIC8vIGZ1bmN0aW9uIGNvdWxkIGFsc28gYWRkIGRlcGVuZGVuY2llcyB0byB0aGlzIGJpbmRpbmcgY29udGV4dC4KCSAgICAgICAgICAgIGlmIChleHRlbmRDYWxsYmFjaykKCSAgICAgICAgICAgICAgICBleHRlbmRDYWxsYmFjayhzZWxmLCBwYXJlbnRDb250ZXh0LCBkYXRhSXRlbSk7CgoJICAgICAgICAgICAgcmV0dXJuIHNlbGZbJyRkYXRhJ107CgkgICAgICAgIH0KCSAgICAgICAgZnVuY3Rpb24gZGlzcG9zZVdoZW4oKSB7CgkgICAgICAgICAgICByZXR1cm4gbm9kZXMgJiYgIWtvLnV0aWxzLmFueURvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChub2Rlcyk7CgkgICAgICAgIH0KCgkgICAgICAgIHZhciBzZWxmID0gdGhpcywKCSAgICAgICAgICAgIGlzRnVuYyA9IHR5cGVvZihkYXRhSXRlbU9yQWNjZXNzb3IpID09ICJmdW5jdGlvbiIgJiYgIWtvLmlzT2JzZXJ2YWJsZShkYXRhSXRlbU9yQWNjZXNzb3IpLAoJICAgICAgICAgICAgbm9kZXMsCgkgICAgICAgICAgICBzdWJzY3JpYmFibGUgPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKHVwZGF0ZUNvbnRleHQsIG51bGwsIHsgZGlzcG9zZVdoZW46IGRpc3Bvc2VXaGVuLCBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IHRydWUgfSk7CgoJICAgICAgICAvLyBBdCB0aGlzIHBvaW50LCB0aGUgYmluZGluZyBjb250ZXh0IGhhcyBiZWVuIGluaXRpYWxpemVkLCBhbmQgdGhlICJzdWJzY3JpYmFibGUiIGNvbXB1dGVkIG9ic2VydmFibGUgaXMKCSAgICAgICAgLy8gc3Vic2NyaWJlZCB0byBhbnkgb2JzZXJ2YWJsZXMgdGhhdCB3ZXJlIGFjY2Vzc2VkIGluIHRoZSBwcm9jZXNzLiBJZiB0aGVyZSBpcyBub3RoaW5nIHRvIHRyYWNrLCB0aGUKCSAgICAgICAgLy8gY29tcHV0ZWQgd2lsbCBiZSBpbmFjdGl2ZSwgYW5kIHdlIGNhbiBzYWZlbHkgdGhyb3cgaXQgYXdheS4gSWYgaXQncyBhY3RpdmUsIHRoZSBjb21wdXRlZCBpcyBzdG9yZWQgaW4KCSAgICAgICAgLy8gdGhlIGNvbnRleHQgb2JqZWN0LgoJICAgICAgICBpZiAoc3Vic2NyaWJhYmxlLmlzQWN0aXZlKCkpIHsKCSAgICAgICAgICAgIHNlbGYuX3N1YnNjcmliYWJsZSA9IHN1YnNjcmliYWJsZTsKCgkgICAgICAgICAgICAvLyBBbHdheXMgbm90aWZ5IGJlY2F1c2UgZXZlbiBpZiB0aGUgbW9kZWwgKCRkYXRhKSBoYXNuJ3QgY2hhbmdlZCwgb3RoZXIgY29udGV4dCBwcm9wZXJ0aWVzIG1pZ2h0IGhhdmUgY2hhbmdlZAoJICAgICAgICAgICAgc3Vic2NyaWJhYmxlWydlcXVhbGl0eUNvbXBhcmVyJ10gPSBudWxsOwoKCSAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gYmUgYWJsZSB0byBkaXNwb3NlIG9mIHRoaXMgY29tcHV0ZWQgb2JzZXJ2YWJsZSB3aGVuIGl0J3Mgbm8gbG9uZ2VyIG5lZWRlZC4gVGhpcyB3b3VsZCBiZQoJICAgICAgICAgICAgLy8gZWFzeSBpZiB3ZSBoYWQgYSBzaW5nbGUgbm9kZSB0byB3YXRjaCwgYnV0IGJpbmRpbmcgY29udGV4dHMgY2FuIGJlIHVzZWQgYnkgbWFueSBkaWZmZXJlbnQgbm9kZXMsIGFuZAoJICAgICAgICAgICAgLy8gd2UgY2Fubm90IGFzc3VtZSB0aGF0IHRob3NlIG5vZGVzIGhhdmUgYW55IHJlbGF0aW9uIHRvIGVhY2ggb3RoZXIuIFNvIGluc3RlYWQgd2UgdHJhY2sgYW55IG5vZGUgdGhhdAoJICAgICAgICAgICAgLy8gdGhlIGNvbnRleHQgaXMgYXR0YWNoZWQgdG8sIGFuZCBkaXNwb3NlIHRoZSBjb21wdXRlZCB3aGVuIGFsbCBvZiB0aG9zZSBub2RlcyBoYXZlIGJlZW4gY2xlYW5lZC4KCgkgICAgICAgICAgICAvLyBBZGQgcHJvcGVydGllcyB0byAqc3Vic2NyaWJhYmxlKiBpbnN0ZWFkIG9mICpzZWxmKiBiZWNhdXNlIGFueSBwcm9wZXJ0aWVzIGFkZGVkIHRvICpzZWxmKiBtYXkgYmUgb3ZlcndyaXR0ZW4gb24gdXBkYXRlcwoJICAgICAgICAgICAgbm9kZXMgPSBbXTsKCSAgICAgICAgICAgIHN1YnNjcmliYWJsZS5fYWRkTm9kZSA9IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgICAgICBub2Rlcy5wdXNoKG5vZGUpOwoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5hZGREaXNwb3NlQ2FsbGJhY2sobm9kZSwgZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVJlbW92ZUl0ZW0obm9kZXMsIG5vZGUpOwoJICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGVzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaWJhYmxlLmRpc3Bvc2UoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N1YnNjcmliYWJsZSA9IHN1YnNjcmliYWJsZSA9IHVuZGVmaW5lZDsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgLy8gRXh0ZW5kIHRoZSBiaW5kaW5nIGNvbnRleHQgaGllcmFyY2h5IHdpdGggYSBuZXcgdmlldyBtb2RlbCBvYmplY3QuIElmIHRoZSBwYXJlbnQgY29udGV4dCBpcyB3YXRjaGluZwoJICAgIC8vIGFueSBvYnNldmFibGVzLCB0aGUgbmV3IGNoaWxkIGNvbnRleHQgd2lsbCBhdXRvbWF0aWNhbGx5IGdldCBhIGRlcGVuZGVuY3kgb24gdGhlIHBhcmVudCBjb250ZXh0LgoJICAgIC8vIEJ1dCB0aGlzIGRvZXMgbm90IG1lYW4gdGhhdCB0aGUgJGRhdGEgdmFsdWUgb2YgdGhlIGNoaWxkIGNvbnRleHQgd2lsbCBhbHNvIGdldCB1cGRhdGVkLiBJZiB0aGUgY2hpbGQKCSAgICAvLyB2aWV3IG1vZGVsIGFsc28gZGVwZW5kcyBvbiB0aGUgcGFyZW50IHZpZXcgbW9kZWwsIHlvdSBtdXN0IHByb3ZpZGUgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGNvcnJlY3QKCSAgICAvLyB2aWV3IG1vZGVsIG9uIGVhY2ggdXBkYXRlLgoJICAgIGtvLmJpbmRpbmdDb250ZXh0LnByb3RvdHlwZVsnY3JlYXRlQ2hpbGRDb250ZXh0J10gPSBmdW5jdGlvbiAoZGF0YUl0ZW1PckFjY2Vzc29yLCBkYXRhSXRlbUFsaWFzLCBleHRlbmRDYWxsYmFjaykgewoJICAgICAgICByZXR1cm4gbmV3IGtvLmJpbmRpbmdDb250ZXh0KGRhdGFJdGVtT3JBY2Nlc3NvciwgdGhpcywgZGF0YUl0ZW1BbGlhcywgZnVuY3Rpb24oc2VsZiwgcGFyZW50Q29udGV4dCkgewoJICAgICAgICAgICAgLy8gRXh0ZW5kIHRoZSBjb250ZXh0IGhpZXJhcmNoeSBieSBzZXR0aW5nIHRoZSBhcHByb3ByaWF0ZSBwb2ludGVycwoJICAgICAgICAgICAgc2VsZlsnJHBhcmVudENvbnRleHQnXSA9IHBhcmVudENvbnRleHQ7CgkgICAgICAgICAgICBzZWxmWyckcGFyZW50J10gPSBwYXJlbnRDb250ZXh0WyckZGF0YSddOwoJICAgICAgICAgICAgc2VsZlsnJHBhcmVudHMnXSA9IChwYXJlbnRDb250ZXh0WyckcGFyZW50cyddIHx8IFtdKS5zbGljZSgwKTsKCSAgICAgICAgICAgIHNlbGZbJyRwYXJlbnRzJ10udW5zaGlmdChzZWxmWyckcGFyZW50J10pOwoJICAgICAgICAgICAgaWYgKGV4dGVuZENhbGxiYWNrKQoJICAgICAgICAgICAgICAgIGV4dGVuZENhbGxiYWNrKHNlbGYpOwoJICAgICAgICB9KTsKCSAgICB9OwoKCSAgICAvLyBFeHRlbmQgdGhlIGJpbmRpbmcgY29udGV4dCB3aXRoIG5ldyBjdXN0b20gcHJvcGVydGllcy4gVGhpcyBkb2Vzbid0IGNoYW5nZSB0aGUgY29udGV4dCBoaWVyYXJjaHkuCgkgICAgLy8gU2ltaWxhcmx5IHRvICJjaGlsZCIgY29udGV4dHMsIHByb3ZpZGUgYSBmdW5jdGlvbiBoZXJlIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZSBjb3JyZWN0IHZhbHVlcyBhcmUgc2V0CgkgICAgLy8gd2hlbiBhbiBvYnNlcnZhYmxlIHZpZXcgbW9kZWwgaXMgdXBkYXRlZC4KCSAgICBrby5iaW5kaW5nQ29udGV4dC5wcm90b3R5cGVbJ2V4dGVuZCddID0gZnVuY3Rpb24ocHJvcGVydGllcykgewoJICAgICAgICAvLyBJZiB0aGUgcGFyZW50IGNvbnRleHQgcmVmZXJlbmNlcyBhbiBvYnNlcnZhYmxlIHZpZXcgbW9kZWwsICJfc3Vic2NyaWJhYmxlIiB3aWxsIGFsd2F5cyBiZSB0aGUKCSAgICAgICAgLy8gbGF0ZXN0IHZpZXcgbW9kZWwgb2JqZWN0LiBJZiBub3QsICJfc3Vic2NyaWJhYmxlIiBpc24ndCBzZXQsIGFuZCB3ZSBjYW4gdXNlIHRoZSBzdGF0aWMgIiRkYXRhIiB2YWx1ZS4KCSAgICAgICAgcmV0dXJuIG5ldyBrby5iaW5kaW5nQ29udGV4dCh0aGlzLl9zdWJzY3JpYmFibGUgfHwgdGhpc1snJGRhdGEnXSwgdGhpcywgbnVsbCwgZnVuY3Rpb24oc2VsZiwgcGFyZW50Q29udGV4dCkgewoJICAgICAgICAgICAgLy8gVGhpcyAiY2hpbGQiIGNvbnRleHQgZG9lc24ndCBkaXJlY3RseSB0cmFjayBhIHBhcmVudCBvYnNlcnZhYmxlIHZpZXcgbW9kZWwsCgkgICAgICAgICAgICAvLyBzbyB3ZSBuZWVkIHRvIG1hbnVhbGx5IHNldCB0aGUgJHJhd0RhdGEgdmFsdWUgdG8gbWF0Y2ggdGhlIHBhcmVudC4KCSAgICAgICAgICAgIHNlbGZbJyRyYXdEYXRhJ10gPSBwYXJlbnRDb250ZXh0WyckcmF3RGF0YSddOwoJICAgICAgICAgICAga28udXRpbHMuZXh0ZW5kKHNlbGYsIHR5cGVvZihwcm9wZXJ0aWVzKSA9PSAiZnVuY3Rpb24iID8gcHJvcGVydGllcygpIDogcHJvcGVydGllcyk7CgkgICAgICAgIH0pOwoJICAgIH07CgoJICAgIC8vIFJldHVybnMgdGhlIHZhbHVlQWNjZXNvciBmdW5jdGlvbiBmb3IgYSBiaW5kaW5nIHZhbHVlCgkgICAgZnVuY3Rpb24gbWFrZVZhbHVlQWNjZXNzb3IodmFsdWUpIHsKCSAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwoJICAgICAgICB9OwoJICAgIH0KCgkgICAgLy8gUmV0dXJucyB0aGUgdmFsdWUgb2YgYSB2YWx1ZUFjY2Vzc29yIGZ1bmN0aW9uCgkgICAgZnVuY3Rpb24gZXZhbHVhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgcmV0dXJuIHZhbHVlQWNjZXNzb3IoKTsKCSAgICB9CgoJICAgIC8vIEdpdmVuIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGJpbmRpbmdzLCBjcmVhdGUgYW5kIHJldHVybiBhIG5ldyBvYmplY3QgdGhhdCBjb250YWlucwoJICAgIC8vIGJpbmRpbmcgdmFsdWUtYWNjZXNzb3JzIGZ1bmN0aW9ucy4gRWFjaCBhY2Nlc3NvciBmdW5jdGlvbiBjYWxscyB0aGUgb3JpZ2luYWwgZnVuY3Rpb24KCSAgICAvLyBzbyB0aGF0IGl0IGFsd2F5cyBnZXRzIHRoZSBsYXRlc3QgdmFsdWUgYW5kIGFsbCBkZXBlbmRlbmNpZXMgYXJlIGNhcHR1cmVkLiBUaGlzIGlzIHVzZWQKCSAgICAvLyBieSBrby5hcHBseUJpbmRpbmdzVG9Ob2RlIGFuZCBnZXRCaW5kaW5nc0FuZE1ha2VBY2Nlc3NvcnMuCgkgICAgZnVuY3Rpb24gbWFrZUFjY2Vzc29yc0Zyb21GdW5jdGlvbihjYWxsYmFjaykgewoJICAgICAgICByZXR1cm4ga28udXRpbHMub2JqZWN0TWFwKGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGNhbGxiYWNrKSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewoJICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjaygpW2tleV07CgkgICAgICAgICAgICB9OwoJICAgICAgICB9KTsKCSAgICB9CgoJICAgIC8vIEdpdmVuIGEgYmluZGluZ3MgZnVuY3Rpb24gb3Igb2JqZWN0LCBjcmVhdGUgYW5kIHJldHVybiBhIG5ldyBvYmplY3QgdGhhdCBjb250YWlucwoJICAgIC8vIGJpbmRpbmcgdmFsdWUtYWNjZXNzb3JzIGZ1bmN0aW9ucy4gVGhpcyBpcyB1c2VkIGJ5IGtvLmFwcGx5QmluZGluZ3NUb05vZGUuCgkgICAgZnVuY3Rpb24gbWFrZUJpbmRpbmdBY2Nlc3NvcnMoYmluZGluZ3MsIGNvbnRleHQsIG5vZGUpIHsKCSAgICAgICAgaWYgKHR5cGVvZiBiaW5kaW5ncyA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgcmV0dXJuIG1ha2VBY2Nlc3NvcnNGcm9tRnVuY3Rpb24oYmluZGluZ3MuYmluZChudWxsLCBjb250ZXh0LCBub2RlKSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICByZXR1cm4ga28udXRpbHMub2JqZWN0TWFwKGJpbmRpbmdzLCBtYWtlVmFsdWVBY2Nlc3Nvcik7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIC8vIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBpZiB0aGUgYmluZGluZyBwcm92aWRlciBkb2Vzbid0IGluY2x1ZGUgYSBnZXRCaW5kaW5nQWNjZXNzb3JzIGZ1bmN0aW9uLgoJICAgIC8vIEl0IG11c3QgYmUgY2FsbGVkIHdpdGggJ3RoaXMnIHNldCB0byB0aGUgcHJvdmlkZXIgaW5zdGFuY2UuCgkgICAgZnVuY3Rpb24gZ2V0QmluZGluZ3NBbmRNYWtlQWNjZXNzb3JzKG5vZGUsIGNvbnRleHQpIHsKCSAgICAgICAgcmV0dXJuIG1ha2VBY2Nlc3NvcnNGcm9tRnVuY3Rpb24odGhpc1snZ2V0QmluZGluZ3MnXS5iaW5kKHRoaXMsIG5vZGUsIGNvbnRleHQpKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIHZhbGlkYXRlVGhhdEJpbmRpbmdJc0FsbG93ZWRGb3JWaXJ0dWFsRWxlbWVudHMoYmluZGluZ05hbWUpIHsKCSAgICAgICAgdmFyIHZhbGlkYXRvciA9IGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbYmluZGluZ05hbWVdOwoJICAgICAgICBpZiAoIXZhbGlkYXRvcikKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGJpbmRpbmcgJyIgKyBiaW5kaW5nTmFtZSArICInIGNhbm5vdCBiZSB1c2VkIHdpdGggdmlydHVhbCBlbGVtZW50cyIpCgkgICAgfQoKCSAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50c0ludGVybmFsIChiaW5kaW5nQ29udGV4dCwgZWxlbWVudE9yVmlydHVhbEVsZW1lbnQsIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CgkgICAgICAgIHZhciBjdXJyZW50Q2hpbGQsCgkgICAgICAgICAgICBuZXh0SW5RdWV1ZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5maXJzdENoaWxkKGVsZW1lbnRPclZpcnR1YWxFbGVtZW50KSwKCSAgICAgICAgICAgIHByb3ZpZGVyID0ga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddLAoJICAgICAgICAgICAgcHJlcHJvY2Vzc05vZGUgPSBwcm92aWRlclsncHJlcHJvY2Vzc05vZGUnXTsKCgkgICAgICAgIC8vIFByZXByb2Nlc3NpbmcgYWxsb3dzIGEgYmluZGluZyBwcm92aWRlciB0byBtdXRhdGUgYSBub2RlIGJlZm9yZSBiaW5kaW5ncyBhcmUgYXBwbGllZCB0byBpdC4gRm9yIGV4YW1wbGUgaXQncwoJICAgICAgICAvLyBwb3NzaWJsZSB0byBpbnNlcnQgbmV3IHNpYmxpbmdzIGFmdGVyIGl0LCBhbmQvb3IgcmVwbGFjZSB0aGUgbm9kZSB3aXRoIGEgZGlmZmVyZW50IG9uZS4gVGhpcyBjYW4gYmUgdXNlZCB0bwoJICAgICAgICAvLyBpbXBsZW1lbnQgY3VzdG9tIGJpbmRpbmcgc3ludGF4ZXMsIHN1Y2ggYXMge3sgdmFsdWUgfX0gZm9yIHN0cmluZyBpbnRlcnBvbGF0aW9uLCBvciBjdXN0b20gZWxlbWVudCB0eXBlcyB0aGF0CgkgICAgICAgIC8vIHRyaWdnZXIgaW5zZXJ0aW9uIG9mIDx0ZW1wbGF0ZT4gY29udGVudHMgYXQgdGhhdCBwb2ludCBpbiB0aGUgZG9jdW1lbnQuCgkgICAgICAgIGlmIChwcmVwcm9jZXNzTm9kZSkgewoJICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnRDaGlsZCA9IG5leHRJblF1ZXVlKSB7CgkgICAgICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcoY3VycmVudENoaWxkKTsKCSAgICAgICAgICAgICAgICBwcmVwcm9jZXNzTm9kZS5jYWxsKHByb3ZpZGVyLCBjdXJyZW50Q2hpbGQpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgLy8gUmVzZXQgbmV4dEluUXVldWUgZm9yIHRoZSBuZXh0IGxvb3AKCSAgICAgICAgICAgIG5leHRJblF1ZXVlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZWxlbWVudE9yVmlydHVhbEVsZW1lbnQpOwoJICAgICAgICB9CgoJICAgICAgICB3aGlsZSAoY3VycmVudENoaWxkID0gbmV4dEluUXVldWUpIHsKCSAgICAgICAgICAgIC8vIEtlZXAgYSByZWNvcmQgb2YgdGhlIG5leHQgY2hpbGQgKmJlZm9yZSogYXBwbHlpbmcgYmluZGluZ3MsIGluIGNhc2UgdGhlIGJpbmRpbmcgcmVtb3ZlcyB0aGUgY3VycmVudCBjaGlsZCBmcm9tIGl0cyBwb3NpdGlvbgoJICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcoY3VycmVudENoaWxkKTsKCSAgICAgICAgICAgIGFwcGx5QmluZGluZ3NUb05vZGVBbmREZXNjZW5kYW50c0ludGVybmFsKGJpbmRpbmdDb250ZXh0LCBjdXJyZW50Q2hpbGQsIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gYXBwbHlCaW5kaW5nc1RvTm9kZUFuZERlc2NlbmRhbnRzSW50ZXJuYWwgKGJpbmRpbmdDb250ZXh0LCBub2RlVmVyaWZpZWQsIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpIHsKCSAgICAgICAgdmFyIHNob3VsZEJpbmREZXNjZW5kYW50cyA9IHRydWU7CgoJICAgICAgICAvLyBQZXJmIG9wdGltaXNhdGlvbjogQXBwbHkgYmluZGluZ3Mgb25seSBpZi4uLgoJICAgICAgICAvLyAoMSkgV2UgbmVlZCB0byBzdG9yZSB0aGUgYmluZGluZyBjb250ZXh0IG9uIHRoaXMgbm9kZSAoYmVjYXVzZSBpdCBtYXkgZGlmZmVyIGZyb20gdGhlIERPTSBwYXJlbnQgbm9kZSdzIGJpbmRpbmcgY29udGV4dCkKCSAgICAgICAgLy8gICAgIE5vdGUgdGhhdCB3ZSBjYW4ndCBzdG9yZSBiaW5kaW5nIGNvbnRleHRzIG9uIG5vbi1lbGVtZW50cyAoZS5nLiwgdGV4dCBub2RlcyksIGFzIElFIGRvZXNuJ3QgYWxsb3cgZXhwYW5kbyBwcm9wZXJ0aWVzIGZvciB0aG9zZQoJICAgICAgICAvLyAoMikgSXQgbWlnaHQgaGF2ZSBiaW5kaW5ncyAoZS5nLiwgaXQgaGFzIGEgZGF0YS1iaW5kIGF0dHJpYnV0ZSwgb3IgaXQncyBhIG1hcmtlciBmb3IgYSBjb250YWluZXJsZXNzIHRlbXBsYXRlKQoJICAgICAgICB2YXIgaXNFbGVtZW50ID0gKG5vZGVWZXJpZmllZC5ub2RlVHlwZSA9PT0gMSk7CgkgICAgICAgIGlmIChpc0VsZW1lbnQpIC8vIFdvcmthcm91bmQgSUUgPD0gOCBIVE1MIHBhcnNpbmcgd2VpcmRuZXNzCgkgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMubm9ybWFsaXNlVmlydHVhbEVsZW1lbnREb21TdHJ1Y3R1cmUobm9kZVZlcmlmaWVkKTsKCgkgICAgICAgIHZhciBzaG91bGRBcHBseUJpbmRpbmdzID0gKGlzRWxlbWVudCAmJiBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSAgICAgICAgICAgICAvLyBDYXNlICgxKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHx8IGtvLmJpbmRpbmdQcm92aWRlclsnaW5zdGFuY2UnXVsnbm9kZUhhc0JpbmRpbmdzJ10obm9kZVZlcmlmaWVkKTsgICAgICAgLy8gQ2FzZSAoMikKCSAgICAgICAgaWYgKHNob3VsZEFwcGx5QmluZGluZ3MpCgkgICAgICAgICAgICBzaG91bGRCaW5kRGVzY2VuZGFudHMgPSBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwobm9kZVZlcmlmaWVkLCBudWxsLCBiaW5kaW5nQ29udGV4dCwgYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudClbJ3Nob3VsZEJpbmREZXNjZW5kYW50cyddOwoKCSAgICAgICAgaWYgKHNob3VsZEJpbmREZXNjZW5kYW50cyAmJiAhYmluZGluZ0RvZXNOb3RSZWN1cnNlSW50b0VsZW1lbnRUeXBlc1trby51dGlscy50YWdOYW1lTG93ZXIobm9kZVZlcmlmaWVkKV0pIHsKCSAgICAgICAgICAgIC8vIFdlJ3JlIHJlY3Vyc2luZyBhdXRvbWF0aWNhbGx5IGludG8gKHJlYWwgb3IgdmlydHVhbCkgY2hpbGQgbm9kZXMgd2l0aG91dCBjaGFuZ2luZyBiaW5kaW5nIGNvbnRleHRzLiBTbywKCSAgICAgICAgICAgIC8vICAqIEZvciBjaGlsZHJlbiBvZiBhICpyZWFsKiBlbGVtZW50LCB0aGUgYmluZGluZyBjb250ZXh0IGlzIGNlcnRhaW5seSB0aGUgc2FtZSBhcyBvbiB0aGVpciBET00gLnBhcmVudE5vZGUsCgkgICAgICAgICAgICAvLyAgICBoZW5jZSBiaW5kaW5nQ29udGV4dHNNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCBpcyBmYWxzZQoJICAgICAgICAgICAgLy8gICogRm9yIGNoaWxkcmVuIG9mIGEgKnZpcnR1YWwqIGVsZW1lbnQsIHdlIGNhbid0IGJlIHN1cmUuIEV2YWx1YXRpbmcgLnBhcmVudE5vZGUgb24gdGhvc2UgY2hpbGRyZW4gbWF5CgkgICAgICAgICAgICAvLyAgICBza2lwIG92ZXIgYW55IG51bWJlciBvZiBpbnRlcm1lZGlhdGUgdmlydHVhbCBlbGVtZW50cywgYW55IG9mIHdoaWNoIG1pZ2h0IGRlZmluZSBhIGN1c3RvbSBiaW5kaW5nIGNvbnRleHQsCgkgICAgICAgICAgICAvLyAgICBoZW5jZSBiaW5kaW5nQ29udGV4dHNNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCBpcyB0cnVlCgkgICAgICAgICAgICBhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50c0ludGVybmFsKGJpbmRpbmdDb250ZXh0LCBub2RlVmVyaWZpZWQsIC8qIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50OiAqLyAhaXNFbGVtZW50KTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgdmFyIGJvdW5kRWxlbWVudERvbURhdGFLZXkgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCgoJICAgIGZ1bmN0aW9uIHRvcG9sb2dpY2FsU29ydEJpbmRpbmdzKGJpbmRpbmdzKSB7CgkgICAgICAgIC8vIERlcHRoLWZpcnN0IHNvcnQKCSAgICAgICAgdmFyIHJlc3VsdCA9IFtdLCAgICAgICAgICAgICAgICAvLyBUaGUgbGlzdCBvZiBrZXkvaGFuZGxlciBwYWlycyB0aGF0IHdlIHdpbGwgcmV0dXJuCgkgICAgICAgICAgICBiaW5kaW5nc0NvbnNpZGVyZWQgPSB7fSwgICAgLy8gQSB0ZW1wb3JhcnkgcmVjb3JkIG9mIHdoaWNoIGJpbmRpbmdzIGFyZSBhbHJlYWR5IGluICdyZXN1bHQnCgkgICAgICAgICAgICBjeWNsaWNEZXBlbmRlbmN5U3RhY2sgPSBbXTsgLy8gS2VlcHMgdHJhY2sgb2YgYSBkZXB0aC1zZWFyY2ggc28gdGhhdCwgaWYgdGhlcmUncyBhIGN5Y2xlLCB3ZSBrbm93IHdoaWNoIGJpbmRpbmdzIGNhdXNlZCBpdAoJICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKGJpbmRpbmdzLCBmdW5jdGlvbiBwdXNoQmluZGluZyhiaW5kaW5nS2V5KSB7CgkgICAgICAgICAgICBpZiAoIWJpbmRpbmdzQ29uc2lkZXJlZFtiaW5kaW5nS2V5XSkgewoJICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nID0ga29bJ2dldEJpbmRpbmdIYW5kbGVyJ10oYmluZGluZ0tleSk7CgkgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmcpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gRmlyc3QgYWRkIGRlcGVuZGVuY2llcyAoaWYgYW55KSBvZiB0aGUgY3VycmVudCBiaW5kaW5nCgkgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nWydhZnRlciddKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBjeWNsaWNEZXBlbmRlbmN5U3RhY2sucHVzaChiaW5kaW5nS2V5KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChiaW5kaW5nWydhZnRlciddLCBmdW5jdGlvbihiaW5kaW5nRGVwZW5kZW5jeUtleSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nc1tiaW5kaW5nRGVwZW5kZW5jeUtleV0pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmFycmF5SW5kZXhPZihjeWNsaWNEZXBlbmRlbmN5U3RhY2ssIGJpbmRpbmdEZXBlbmRlbmN5S2V5KSAhPT0gLTEpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJDYW5ub3QgY29tYmluZSB0aGUgZm9sbG93aW5nIGJpbmRpbmdzLCBiZWNhdXNlIHRoZXkgaGF2ZSBhIGN5Y2xpYyBkZXBlbmRlbmN5OiAiICsgY3ljbGljRGVwZW5kZW5jeVN0YWNrLmpvaW4oIiwgIikpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVzaEJpbmRpbmcoYmluZGluZ0RlcGVuZGVuY3lLZXkpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgICAgICAgICBjeWNsaWNEZXBlbmRlbmN5U3RhY2subGVuZ3RoLS07CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgLy8gTmV4dCBhZGQgdGhlIGN1cnJlbnQgYmluZGluZwoJICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh7IGtleTogYmluZGluZ0tleSwgaGFuZGxlcjogYmluZGluZyB9KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgYmluZGluZ3NDb25zaWRlcmVkW2JpbmRpbmdLZXldID0gdHJ1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgoJICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgIH0KCgkgICAgZnVuY3Rpb24gYXBwbHlCaW5kaW5nc1RvTm9kZUludGVybmFsKG5vZGUsIHNvdXJjZUJpbmRpbmdzLCBiaW5kaW5nQ29udGV4dCwgYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkgewoJICAgICAgICAvLyBQcmV2ZW50IG11bHRpcGxlIGFwcGx5QmluZGluZ3MgY2FsbHMgZm9yIHRoZSBzYW1lIG5vZGUsIGV4Y2VwdCB3aGVuIGEgYmluZGluZyB2YWx1ZSBpcyBzcGVjaWZpZWQKCSAgICAgICAgdmFyIGFscmVhZHlCb3VuZCA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KG5vZGUsIGJvdW5kRWxlbWVudERvbURhdGFLZXkpOwoJICAgICAgICBpZiAoIXNvdXJjZUJpbmRpbmdzKSB7CgkgICAgICAgICAgICBpZiAoYWxyZWFkeUJvdW5kKSB7CgkgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIllvdSBjYW5ub3QgYXBwbHkgYmluZGluZ3MgbXVsdGlwbGUgdGltZXMgdG8gdGhlIHNhbWUgZWxlbWVudC4iKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIGJvdW5kRWxlbWVudERvbURhdGFLZXksIHRydWUpOwoJICAgICAgICB9CgoJICAgICAgICAvLyBPcHRpbWl6YXRpb246IERvbid0IHN0b3JlIHRoZSBiaW5kaW5nIGNvbnRleHQgb24gdGhpcyBub2RlIGlmIGl0J3MgZGVmaW5pdGVseSB0aGUgc2FtZSBhcyBvbiBub2RlLnBhcmVudE5vZGUsIGJlY2F1c2UKCSAgICAgICAgLy8gd2UgY2FuIGVhc2lseSByZWNvdmVyIGl0IGp1c3QgYnkgc2Nhbm5pbmcgdXAgdGhlIG5vZGUncyBhbmNlc3RvcnMgaW4gdGhlIERPTQoJICAgICAgICAvLyAobm90ZTogaGVyZSwgcGFyZW50IG5vZGUgbWVhbnMgInJlYWwgRE9NIHBhcmVudCIgbm90ICJ2aXJ0dWFsIHBhcmVudCIsIGFzIHRoZXJlJ3Mgbm8gTygxKSB3YXkgdG8gZmluZCB0aGUgdmlydHVhbCBwYXJlbnQpCgkgICAgICAgIGlmICghYWxyZWFkeUJvdW5kICYmIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpCgkgICAgICAgICAgICBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUobm9kZSwgYmluZGluZ0NvbnRleHQpOwoKCSAgICAgICAgLy8gVXNlIGJpbmRpbmdzIGlmIGdpdmVuLCBvdGhlcndpc2UgZmFsbCBiYWNrIG9uIGFza2luZyB0aGUgYmluZGluZ3MgcHJvdmlkZXIgdG8gZ2l2ZSB1cyBzb21lIGJpbmRpbmdzCgkgICAgICAgIHZhciBiaW5kaW5nczsKCSAgICAgICAgaWYgKHNvdXJjZUJpbmRpbmdzICYmIHR5cGVvZiBzb3VyY2VCaW5kaW5ncyAhPT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgYmluZGluZ3MgPSBzb3VyY2VCaW5kaW5nczsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHZhciBwcm92aWRlciA9IGtvLmJpbmRpbmdQcm92aWRlclsnaW5zdGFuY2UnXSwKCSAgICAgICAgICAgICAgICBnZXRCaW5kaW5ncyA9IHByb3ZpZGVyWydnZXRCaW5kaW5nQWNjZXNzb3JzJ10gfHwgZ2V0QmluZGluZ3NBbmRNYWtlQWNjZXNzb3JzOwoKCSAgICAgICAgICAgIC8vIEdldCB0aGUgYmluZGluZyBmcm9tIHRoZSBwcm92aWRlciB3aXRoaW4gYSBjb21wdXRlZCBvYnNlcnZhYmxlIHNvIHRoYXQgd2UgY2FuIHVwZGF0ZSB0aGUgYmluZGluZ3Mgd2hlbmV2ZXIKCSAgICAgICAgICAgIC8vIHRoZSBiaW5kaW5nIGNvbnRleHQgaXMgdXBkYXRlZCBvciBpZiB0aGUgYmluZGluZyBwcm92aWRlciBhY2Nlc3NlcyBvYnNlcnZhYmxlcy4KCSAgICAgICAgICAgIHZhciBiaW5kaW5nc1VwZGF0ZXIgPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKAoJICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgICAgICBiaW5kaW5ncyA9IHNvdXJjZUJpbmRpbmdzID8gc291cmNlQmluZGluZ3MoYmluZGluZ0NvbnRleHQsIG5vZGUpIDogZ2V0QmluZGluZ3MuY2FsbChwcm92aWRlciwgbm9kZSwgYmluZGluZ0NvbnRleHQpOwoJICAgICAgICAgICAgICAgICAgICAvLyBSZWdpc3RlciBhIGRlcGVuZGVuY3kgb24gdGhlIGJpbmRpbmcgY29udGV4dCB0byBzdXBwb3J0IG9ic2V2YWJsZSB2aWV3IG1vZGVscy4KCSAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdzICYmIGJpbmRpbmdDb250ZXh0Ll9zdWJzY3JpYmFibGUpCgkgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nQ29udGV4dC5fc3Vic2NyaWJhYmxlKCk7CgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nczsKCSAgICAgICAgICAgICAgICB9LAoJICAgICAgICAgICAgICAgIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBub2RlIH0KCSAgICAgICAgICAgICk7CgoJICAgICAgICAgICAgaWYgKCFiaW5kaW5ncyB8fCAhYmluZGluZ3NVcGRhdGVyLmlzQWN0aXZlKCkpCgkgICAgICAgICAgICAgICAgYmluZGluZ3NVcGRhdGVyID0gbnVsbDsKCSAgICAgICAgfQoKCSAgICAgICAgdmFyIGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzOwoJICAgICAgICBpZiAoYmluZGluZ3MpIHsKCSAgICAgICAgICAgIC8vIFJldHVybiB0aGUgdmFsdWUgYWNjZXNzb3IgZm9yIGEgZ2l2ZW4gYmluZGluZy4gV2hlbiBiaW5kaW5ncyBhcmUgc3RhdGljICh3b24ndCBiZSB1cGRhdGVkIGJlY2F1c2Ugb2YgYSBiaW5kaW5nCgkgICAgICAgICAgICAvLyBjb250ZXh0IHVwZGF0ZSksIGp1c3QgcmV0dXJuIHRoZSB2YWx1ZSBhY2Nlc3NvciBmcm9tIHRoZSBiaW5kaW5nLiBPdGhlcndpc2UsIHJldHVybiBhIGZ1bmN0aW9uIHRoYXQgYWx3YXlzIGdldHMKCSAgICAgICAgICAgIC8vIHRoZSBsYXRlc3QgYmluZGluZyB2YWx1ZSBhbmQgcmVnaXN0ZXJzIGEgZGVwZW5kZW5jeSBvbiB0aGUgYmluZGluZyB1cGRhdGVyLgoJICAgICAgICAgICAgdmFyIGdldFZhbHVlQWNjZXNzb3IgPSBiaW5kaW5nc1VwZGF0ZXIKCSAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uKGJpbmRpbmdLZXkpIHsKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2YWx1YXRlVmFsdWVBY2Nlc3NvcihiaW5kaW5nc1VwZGF0ZXIoKVtiaW5kaW5nS2V5XSk7CgkgICAgICAgICAgICAgICAgICAgIH07CgkgICAgICAgICAgICAgICAgfSA6IGZ1bmN0aW9uKGJpbmRpbmdLZXkpIHsKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmdzW2JpbmRpbmdLZXldOwoJICAgICAgICAgICAgICAgIH07CgoJICAgICAgICAgICAgLy8gVXNlIG9mIGFsbEJpbmRpbmdzIGFzIGEgZnVuY3Rpb24gaXMgbWFpbnRhaW5lZCBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHksIGJ1dCBpdHMgdXNlIGlzIGRlcHJlY2F0ZWQKCSAgICAgICAgICAgIGZ1bmN0aW9uIGFsbEJpbmRpbmdzKCkgewoJICAgICAgICAgICAgICAgIHJldHVybiBrby51dGlscy5vYmplY3RNYXAoYmluZGluZ3NVcGRhdGVyID8gYmluZGluZ3NVcGRhdGVyKCkgOiBiaW5kaW5ncywgZXZhbHVhdGVWYWx1ZUFjY2Vzc29yKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgaXMgdGhlIDMueCBhbGxCaW5kaW5ncyBBUEkKCSAgICAgICAgICAgIGFsbEJpbmRpbmdzWydnZXQnXSA9IGZ1bmN0aW9uKGtleSkgewoJICAgICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nc1trZXldICYmIGV2YWx1YXRlVmFsdWVBY2Nlc3NvcihnZXRWYWx1ZUFjY2Vzc29yKGtleSkpOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIGFsbEJpbmRpbmdzWydoYXMnXSA9IGZ1bmN0aW9uKGtleSkgewoJICAgICAgICAgICAgICAgIHJldHVybiBrZXkgaW4gYmluZGluZ3M7CgkgICAgICAgICAgICB9OwoKCSAgICAgICAgICAgIC8vIEZpcnN0IHB1dCB0aGUgYmluZGluZ3MgaW50byB0aGUgcmlnaHQgb3JkZXIKCSAgICAgICAgICAgIHZhciBvcmRlcmVkQmluZGluZ3MgPSB0b3BvbG9naWNhbFNvcnRCaW5kaW5ncyhiaW5kaW5ncyk7CgoJICAgICAgICAgICAgLy8gR28gdGhyb3VnaCB0aGUgc29ydGVkIGJpbmRpbmdzLCBjYWxsaW5nIGluaXQgYW5kIHVwZGF0ZSBmb3IgZWFjaAoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKG9yZGVyZWRCaW5kaW5ncywgZnVuY3Rpb24oYmluZGluZ0tleUFuZEhhbmRsZXIpIHsKCSAgICAgICAgICAgICAgICAvLyBOb3RlIHRoYXQgdG9wb2xvZ2ljYWxTb3J0QmluZGluZ3MgaGFzIGFscmVhZHkgZmlsdGVyZWQgb3V0IGFueSBub25leGlzdGVudCBiaW5kaW5nIGhhbmRsZXJzLAoJICAgICAgICAgICAgICAgIC8vIHNvIGJpbmRpbmdLZXlBbmRIYW5kbGVyLmhhbmRsZXIgd2lsbCBhbHdheXMgYmUgbm9ubnVsbC4KCSAgICAgICAgICAgICAgICB2YXIgaGFuZGxlckluaXRGbiA9IGJpbmRpbmdLZXlBbmRIYW5kbGVyLmhhbmRsZXJbImluaXQiXSwKCSAgICAgICAgICAgICAgICAgICAgaGFuZGxlclVwZGF0ZUZuID0gYmluZGluZ0tleUFuZEhhbmRsZXIuaGFuZGxlclsidXBkYXRlIl0sCgkgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdLZXkgPSBiaW5kaW5nS2V5QW5kSGFuZGxlci5rZXk7CgoJICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSA4KSB7CgkgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlVGhhdEJpbmRpbmdJc0FsbG93ZWRGb3JWaXJ0dWFsRWxlbWVudHMoYmluZGluZ0tleSk7CgkgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgICAgICAvLyBSdW4gaW5pdCwgaWdub3JpbmcgYW55IGRlcGVuZGVuY2llcwoJICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGhhbmRsZXJJbml0Rm4gPT0gImZ1bmN0aW9uIikgewoJICAgICAgICAgICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluaXRSZXN1bHQgPSBoYW5kbGVySW5pdEZuKG5vZGUsIGdldFZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSksIGFsbEJpbmRpbmdzLCBiaW5kaW5nQ29udGV4dFsnJGRhdGEnXSwgYmluZGluZ0NvbnRleHQpOwoKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGlzIGJpbmRpbmcgaGFuZGxlciBjbGFpbXMgdG8gY29udHJvbCBkZXNjZW5kYW50IGJpbmRpbmdzLCBtYWtlIGEgbm90ZSBvZiB0aGlzCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluaXRSZXN1bHQgJiYgaW5pdFJlc3VsdFsnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnXSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MgIT09IHVuZGVmaW5lZCkKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTXVsdGlwbGUgYmluZGluZ3MgKCIgKyBiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyArICIgYW5kICIgKyBiaW5kaW5nS2V5ICsgIikgYXJlIHRyeWluZyB0byBjb250cm9sIGRlc2NlbmRhbnQgYmluZGluZ3Mgb2YgdGhlIHNhbWUgZWxlbWVudC4gWW91IGNhbm5vdCB1c2UgdGhlc2UgYmluZGluZ3MgdG9nZXRoZXIgb24gdGhlIHNhbWUgZWxlbWVudC4iKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MgPSBiaW5kaW5nS2V5OwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgICAgICAvLyBSdW4gdXBkYXRlIGluIGl0cyBvd24gY29tcHV0ZWQgd3JhcHBlcgoJICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGhhbmRsZXJVcGRhdGVGbiA9PSAiZnVuY3Rpb24iKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyVXBkYXRlRm4obm9kZSwgZ2V0VmFsdWVBY2Nlc3NvcihiaW5kaW5nS2V5KSwgYWxsQmluZGluZ3MsIGJpbmRpbmdDb250ZXh0WyckZGF0YSddLCBiaW5kaW5nQ29udGV4dCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBudWxsLAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBub2RlIH0KCSAgICAgICAgICAgICAgICAgICAgICAgICk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewoJICAgICAgICAgICAgICAgICAgICBleC5tZXNzYWdlID0gIlVuYWJsZSB0byBwcm9jZXNzIGJpbmRpbmcgXCIiICsgYmluZGluZ0tleSArICI6ICIgKyBiaW5kaW5nc1tiaW5kaW5nS2V5XSArICJcIlxuTWVzc2FnZTogIiArIGV4Lm1lc3NhZ2U7CgkgICAgICAgICAgICAgICAgICAgIHRocm93IGV4OwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9CgoJICAgICAgICByZXR1cm4gewoJICAgICAgICAgICAgJ3Nob3VsZEJpbmREZXNjZW5kYW50cyc6IGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzID09PSB1bmRlZmluZWQKCSAgICAgICAgfTsKCSAgICB9OwoKCSAgICB2YXIgc3RvcmVkQmluZGluZ0NvbnRleHREb21EYXRhS2V5ID0ga28udXRpbHMuZG9tRGF0YS5uZXh0S2V5KCk7CgkgICAga28uc3RvcmVkQmluZGluZ0NvbnRleHRGb3JOb2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDIpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIHN0b3JlZEJpbmRpbmdDb250ZXh0RG9tRGF0YUtleSwgYmluZGluZ0NvbnRleHQpOwoJICAgICAgICAgICAgaWYgKGJpbmRpbmdDb250ZXh0Ll9zdWJzY3JpYmFibGUpCgkgICAgICAgICAgICAgICAgYmluZGluZ0NvbnRleHQuX3N1YnNjcmliYWJsZS5fYWRkTm9kZShub2RlKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy5kb21EYXRhLmdldChub2RlLCBzdG9yZWRCaW5kaW5nQ29udGV4dERvbURhdGFLZXkpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBnZXRCaW5kaW5nQ29udGV4dCh2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIHJldHVybiB2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0ICYmICh2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0IGluc3RhbmNlb2Yga28uYmluZGluZ0NvbnRleHQpCgkgICAgICAgICAgICA/IHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQKCSAgICAgICAgICAgIDogbmV3IGtvLmJpbmRpbmdDb250ZXh0KHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQpOwoJICAgIH0KCgkgICAga28uYXBwbHlCaW5kaW5nQWNjZXNzb3JzVG9Ob2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSAvLyBJZiBpdCdzIGFuIGVsZW1lbnQsIHdvcmthcm91bmQgSUUgPD0gOCBIVE1MIHBhcnNpbmcgd2VpcmRuZXNzCgkgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMubm9ybWFsaXNlVmlydHVhbEVsZW1lbnREb21TdHJ1Y3R1cmUobm9kZSk7CgkgICAgICAgIHJldHVybiBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwobm9kZSwgYmluZGluZ3MsIGdldEJpbmRpbmdDb250ZXh0KHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQpLCB0cnVlKTsKCSAgICB9OwoKCSAgICBrby5hcHBseUJpbmRpbmdzVG9Ob2RlID0gZnVuY3Rpb24gKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIHZhciBjb250ZXh0ID0gZ2V0QmluZGluZ0NvbnRleHQodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCk7CgkgICAgICAgIHJldHVybiBrby5hcHBseUJpbmRpbmdBY2Nlc3NvcnNUb05vZGUobm9kZSwgbWFrZUJpbmRpbmdBY2Nlc3NvcnMoYmluZGluZ3MsIGNvbnRleHQsIG5vZGUpLCBjb250ZXh0KTsKCSAgICB9OwoKCSAgICBrby5hcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cyA9IGZ1bmN0aW9uKHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQsIHJvb3ROb2RlKSB7CgkgICAgICAgIGlmIChyb290Tm9kZS5ub2RlVHlwZSA9PT0gMSB8fCByb290Tm9kZS5ub2RlVHlwZSA9PT0gOCkKCSAgICAgICAgICAgIGFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzSW50ZXJuYWwoZ2V0QmluZGluZ0NvbnRleHQodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCksIHJvb3ROb2RlLCB0cnVlKTsKCSAgICB9OwoKCSAgICBrby5hcHBseUJpbmRpbmdzID0gZnVuY3Rpb24gKHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQsIHJvb3ROb2RlKSB7CgkgICAgICAgIC8vIElmIGpRdWVyeSBpcyBsb2FkZWQgYWZ0ZXIgS25vY2tvdXQsIHdlIHdvbid0IGluaXRpYWxseSBoYXZlIGFjY2VzcyB0byBpdC4gU28gc2F2ZSBpdCBoZXJlLgoJICAgICAgICBpZiAoIWpRdWVyeUluc3RhbmNlICYmIHdpbmRvd1snalF1ZXJ5J10pIHsKCSAgICAgICAgICAgIGpRdWVyeUluc3RhbmNlID0gd2luZG93WydqUXVlcnknXTsKCSAgICAgICAgfQoKCSAgICAgICAgaWYgKHJvb3ROb2RlICYmIChyb290Tm9kZS5ub2RlVHlwZSAhPT0gMSkgJiYgKHJvb3ROb2RlLm5vZGVUeXBlICE9PSA4KSkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigia28uYXBwbHlCaW5kaW5nczogZmlyc3QgcGFyYW1ldGVyIHNob3VsZCBiZSB5b3VyIHZpZXcgbW9kZWw7IHNlY29uZCBwYXJhbWV0ZXIgc2hvdWxkIGJlIGEgRE9NIG5vZGUiKTsKCSAgICAgICAgcm9vdE5vZGUgPSByb290Tm9kZSB8fCB3aW5kb3cuZG9jdW1lbnQuYm9keTsgLy8gTWFrZSAicm9vdE5vZGUiIHBhcmFtZXRlciBvcHRpb25hbAoKCSAgICAgICAgYXBwbHlCaW5kaW5nc1RvTm9kZUFuZERlc2NlbmRhbnRzSW50ZXJuYWwoZ2V0QmluZGluZ0NvbnRleHQodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCksIHJvb3ROb2RlLCB0cnVlKTsKCSAgICB9OwoKCSAgICAvLyBSZXRyaWV2aW5nIGJpbmRpbmcgY29udGV4dCBmcm9tIGFyYml0cmFyeSBub2RlcwoJICAgIGtvLmNvbnRleHRGb3IgPSBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgIC8vIFdlIGNhbiBvbmx5IGRvIHNvbWV0aGluZyBtZWFuaW5nZnVsIGZvciBlbGVtZW50cyBhbmQgY29tbWVudCBub2RlcyAoaW4gcGFydGljdWxhciwgbm90IHRleHQgbm9kZXMsIGFzIElFIGNhbid0IHN0b3JlIGRvbWRhdGEgZm9yIHRoZW0pCgkgICAgICAgIHN3aXRjaCAobm9kZS5ub2RlVHlwZSkgewoJICAgICAgICAgICAgY2FzZSAxOgoJICAgICAgICAgICAgY2FzZSA4OgoJICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0ga28uc3RvcmVkQmluZGluZ0NvbnRleHRGb3JOb2RlKG5vZGUpOwoJICAgICAgICAgICAgICAgIGlmIChjb250ZXh0KSByZXR1cm4gY29udGV4dDsKCSAgICAgICAgICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlKSByZXR1cm4ga28uY29udGV4dEZvcihub2RlLnBhcmVudE5vZGUpOwoJICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CgkgICAgfTsKCSAgICBrby5kYXRhRm9yID0gZnVuY3Rpb24obm9kZSkgewoJICAgICAgICB2YXIgY29udGV4dCA9IGtvLmNvbnRleHRGb3Iobm9kZSk7CgkgICAgICAgIHJldHVybiBjb250ZXh0ID8gY29udGV4dFsnJGRhdGEnXSA6IHVuZGVmaW5lZDsKCSAgICB9OwoKCSAgICBrby5leHBvcnRTeW1ib2woJ2JpbmRpbmdIYW5kbGVycycsIGtvLmJpbmRpbmdIYW5kbGVycyk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdhcHBseUJpbmRpbmdzJywga28uYXBwbHlCaW5kaW5ncyk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cycsIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2FwcGx5QmluZGluZ0FjY2Vzc29yc1RvTm9kZScsIGtvLmFwcGx5QmluZGluZ0FjY2Vzc29yc1RvTm9kZSk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdhcHBseUJpbmRpbmdzVG9Ob2RlJywga28uYXBwbHlCaW5kaW5nc1RvTm9kZSk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdjb250ZXh0Rm9yJywga28uY29udGV4dEZvcik7CgkgICAga28uZXhwb3J0U3ltYm9sKCdkYXRhRm9yJywga28uZGF0YUZvcik7Cgl9KSgpOwoJKGZ1bmN0aW9uKHVuZGVmaW5lZCkgewoJICAgIHZhciBsb2FkaW5nU3Vic2NyaWJhYmxlc0NhY2hlID0ge30sIC8vIFRyYWNrcyBjb21wb25lbnQgbG9hZHMgdGhhdCBhcmUgY3VycmVudGx5IGluIGZsaWdodAoJICAgICAgICBsb2FkZWREZWZpbml0aW9uc0NhY2hlID0ge307ICAgIC8vIFRyYWNrcyBjb21wb25lbnQgbG9hZHMgdGhhdCBoYXZlIGFscmVhZHkgY29tcGxldGVkCgoJICAgIGtvLmNvbXBvbmVudHMgPSB7CgkgICAgICAgIGdldDogZnVuY3Rpb24oY29tcG9uZW50TmFtZSwgY2FsbGJhY2spIHsKCSAgICAgICAgICAgIHZhciBjYWNoZWREZWZpbml0aW9uID0gZ2V0T2JqZWN0T3duUHJvcGVydHkobG9hZGVkRGVmaW5pdGlvbnNDYWNoZSwgY29tcG9uZW50TmFtZSk7CgkgICAgICAgICAgICBpZiAoY2FjaGVkRGVmaW5pdGlvbikgewoJICAgICAgICAgICAgICAgIC8vIEl0J3MgYWxyZWFkeSBsb2FkZWQgYW5kIGNhY2hlZC4gUmV1c2UgdGhlIHNhbWUgZGVmaW5pdGlvbiBvYmplY3QuCgkgICAgICAgICAgICAgICAgLy8gTm90ZSB0aGF0IGZvciBBUEkgY29uc2lzdGVuY3ksIGV2ZW4gY2FjaGUgaGl0cyBjb21wbGV0ZSBhc3luY2hyb25vdXNseS4KCSAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBjYWxsYmFjayhjYWNoZWREZWZpbml0aW9uKSB9LCAwKTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gSm9pbiB0aGUgbG9hZGluZyBwcm9jZXNzIHRoYXQgaXMgYWxyZWFkeSB1bmRlcndheSwgb3Igc3RhcnQgYSBuZXcgb25lLgoJICAgICAgICAgICAgICAgIGxvYWRDb21wb25lbnRBbmROb3RpZnkoY29tcG9uZW50TmFtZSwgY2FsbGJhY2spOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgY2xlYXJDYWNoZWREZWZpbml0aW9uOiBmdW5jdGlvbihjb21wb25lbnROYW1lKSB7CgkgICAgICAgICAgICBkZWxldGUgbG9hZGVkRGVmaW5pdGlvbnNDYWNoZVtjb21wb25lbnROYW1lXTsKCSAgICAgICAgfSwKCgkgICAgICAgIF9nZXRGaXJzdFJlc3VsdEZyb21Mb2FkZXJzOiBnZXRGaXJzdFJlc3VsdEZyb21Mb2FkZXJzCgkgICAgfTsKCgkgICAgZnVuY3Rpb24gZ2V0T2JqZWN0T3duUHJvcGVydHkob2JqLCBwcm9wTmFtZSkgewoJICAgICAgICByZXR1cm4gb2JqLmhhc093blByb3BlcnR5KHByb3BOYW1lKSA/IG9ialtwcm9wTmFtZV0gOiB1bmRlZmluZWQ7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBsb2FkQ29tcG9uZW50QW5kTm90aWZ5KGNvbXBvbmVudE5hbWUsIGNhbGxiYWNrKSB7CgkgICAgICAgIHZhciBzdWJzY3JpYmFibGUgPSBnZXRPYmplY3RPd25Qcm9wZXJ0eShsb2FkaW5nU3Vic2NyaWJhYmxlc0NhY2hlLCBjb21wb25lbnROYW1lKSwKCSAgICAgICAgICAgIGNvbXBsZXRlZEFzeW5jOwoJICAgICAgICBpZiAoIXN1YnNjcmliYWJsZSkgewoJICAgICAgICAgICAgLy8gSXQncyBub3Qgc3RhcnRlZCBsb2FkaW5nIHlldC4gU3RhcnQgbG9hZGluZywgYW5kIHdoZW4gaXQncyBkb25lLCBtb3ZlIGl0IHRvIGxvYWRlZERlZmluaXRpb25zQ2FjaGUuCgkgICAgICAgICAgICBzdWJzY3JpYmFibGUgPSBsb2FkaW5nU3Vic2NyaWJhYmxlc0NhY2hlW2NvbXBvbmVudE5hbWVdID0gbmV3IGtvLnN1YnNjcmliYWJsZSgpOwoJICAgICAgICAgICAgYmVnaW5Mb2FkaW5nQ29tcG9uZW50KGNvbXBvbmVudE5hbWUsIGZ1bmN0aW9uKGRlZmluaXRpb24pIHsKCSAgICAgICAgICAgICAgICBsb2FkZWREZWZpbml0aW9uc0NhY2hlW2NvbXBvbmVudE5hbWVdID0gZGVmaW5pdGlvbjsKCSAgICAgICAgICAgICAgICBkZWxldGUgbG9hZGluZ1N1YnNjcmliYWJsZXNDYWNoZVtjb21wb25lbnROYW1lXTsKCgkgICAgICAgICAgICAgICAgLy8gRm9yIEFQSSBjb25zaXN0ZW5jeSwgYWxsIGxvYWRzIGNvbXBsZXRlIGFzeW5jaHJvbm91c2x5LiBIb3dldmVyIHdlIHdhbnQgdG8gYXZvaWQKCSAgICAgICAgICAgICAgICAvLyBhZGRpbmcgYW4gZXh0cmEgc2V0VGltZW91dCBpZiBpdCdzIHVubmVjZXNzYXJ5IChpLmUuLCB0aGUgY29tcGxldGlvbiBpcyBhbHJlYWR5CgkgICAgICAgICAgICAgICAgLy8gYXN5bmMpIHNpbmNlIHNldFRpbWVvdXQoLi4uLCAwKSBzdGlsbCB0YWtlcyBhYm91dCAxNm1zIG9yIG1vcmUgb24gbW9zdCBicm93c2Vycy4KCSAgICAgICAgICAgICAgICBpZiAoY29tcGxldGVkQXN5bmMpIHsKCSAgICAgICAgICAgICAgICAgICAgc3Vic2NyaWJhYmxlWydub3RpZnlTdWJzY3JpYmVycyddKGRlZmluaXRpb24pOwoJICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpYmFibGVbJ25vdGlmeVN1YnNjcmliZXJzJ10oZGVmaW5pdGlvbik7CgkgICAgICAgICAgICAgICAgICAgIH0sIDApOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgY29tcGxldGVkQXN5bmMgPSB0cnVlOwoJICAgICAgICB9CgkgICAgICAgIHN1YnNjcmliYWJsZS5zdWJzY3JpYmUoY2FsbGJhY2spOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gYmVnaW5Mb2FkaW5nQ29tcG9uZW50KGNvbXBvbmVudE5hbWUsIGNhbGxiYWNrKSB7CgkgICAgICAgIGdldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMoJ2dldENvbmZpZycsIFtjb21wb25lbnROYW1lXSwgZnVuY3Rpb24oY29uZmlnKSB7CgkgICAgICAgICAgICBpZiAoY29uZmlnKSB7CgkgICAgICAgICAgICAgICAgLy8gV2UgaGF2ZSBhIGNvbmZpZywgc28gbm93IGxvYWQgaXRzIGRlZmluaXRpb24KCSAgICAgICAgICAgICAgICBnZXRGaXJzdFJlc3VsdEZyb21Mb2FkZXJzKCdsb2FkQ29tcG9uZW50JywgW2NvbXBvbmVudE5hbWUsIGNvbmZpZ10sIGZ1bmN0aW9uKGRlZmluaXRpb24pIHsKCSAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZGVmaW5pdGlvbik7CgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIFRoZSBjb21wb25lbnQgaGFzIG5vIGNvbmZpZyAtIGl0J3MgdW5rbm93biB0byBhbGwgdGhlIGxvYWRlcnMuCgkgICAgICAgICAgICAgICAgLy8gTm90ZSB0aGF0IHRoaXMgaXMgbm90IGFuIGVycm9yIChlLmcuLCBhIG1vZHVsZSBsb2FkaW5nIGVycm9yKSAtIHRoYXQgd291bGQgYWJvcnQgdGhlCgkgICAgICAgICAgICAgICAgLy8gcHJvY2VzcyBhbmQgdGhpcyBjYWxsYmFjayB3b3VsZCBub3QgcnVuLiBGb3IgdGhpcyBjYWxsYmFjayB0byBydW4sIGFsbCBsb2FkZXJzIG11c3QKCSAgICAgICAgICAgICAgICAvLyBoYXZlIGNvbmZpcm1lZCB0aGV5IGRvbid0IGtub3cgYWJvdXQgdGhpcyBjb21wb25lbnQuCgkgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZ2V0Rmlyc3RSZXN1bHRGcm9tTG9hZGVycyhtZXRob2ROYW1lLCBhcmdzRXhjZXB0Q2FsbGJhY2ssIGNhbGxiYWNrLCBjYW5kaWRhdGVMb2FkZXJzKSB7CgkgICAgICAgIC8vIE9uIHRoZSBmaXJzdCBjYWxsIGluIHRoZSBzdGFjaywgc3RhcnQgd2l0aCB0aGUgZnVsbCBzZXQgb2YgbG9hZGVycwoJICAgICAgICBpZiAoIWNhbmRpZGF0ZUxvYWRlcnMpIHsKCSAgICAgICAgICAgIGNhbmRpZGF0ZUxvYWRlcnMgPSBrby5jb21wb25lbnRzWydsb2FkZXJzJ10uc2xpY2UoMCk7IC8vIFVzZSBhIGNvcHksIGJlY2F1c2Ugd2UnbGwgYmUgbXV0YXRpbmcgdGhpcyBhcnJheQoJICAgICAgICB9CgoJICAgICAgICAvLyBUcnkgdGhlIG5leHQgY2FuZGlkYXRlCgkgICAgICAgIHZhciBjdXJyZW50Q2FuZGlkYXRlTG9hZGVyID0gY2FuZGlkYXRlTG9hZGVycy5zaGlmdCgpOwoJICAgICAgICBpZiAoY3VycmVudENhbmRpZGF0ZUxvYWRlcikgewoJICAgICAgICAgICAgdmFyIG1ldGhvZEluc3RhbmNlID0gY3VycmVudENhbmRpZGF0ZUxvYWRlclttZXRob2ROYW1lXTsKCSAgICAgICAgICAgIGlmIChtZXRob2RJbnN0YW5jZSkgewoJICAgICAgICAgICAgICAgIHZhciB3YXNBYm9ydGVkID0gZmFsc2UsCgkgICAgICAgICAgICAgICAgICAgIHN5bmNocm9ub3VzUmV0dXJuVmFsdWUgPSBtZXRob2RJbnN0YW5jZS5hcHBseShjdXJyZW50Q2FuZGlkYXRlTG9hZGVyLCBhcmdzRXhjZXB0Q2FsbGJhY2suY29uY2F0KGZ1bmN0aW9uKHJlc3VsdCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdhc0Fib3J0ZWQpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzdWx0ICE9PSBudWxsKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBjYW5kaWRhdGUgcmV0dXJuZWQgYSB2YWx1ZS4gVXNlIGl0LgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHJlc3VsdCk7CgkgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRyeSB0aGUgbmV4dCBjYW5kaWRhdGUKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXRGaXJzdFJlc3VsdEZyb21Mb2FkZXJzKG1ldGhvZE5hbWUsIGFyZ3NFeGNlcHRDYWxsYmFjaywgY2FsbGJhY2ssIGNhbmRpZGF0ZUxvYWRlcnMpOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICB9KSk7CgoJICAgICAgICAgICAgICAgIC8vIEN1cnJlbnRseSwgbG9hZGVycyBtYXkgbm90IHJldHVybiBhbnl0aGluZyBzeW5jaHJvbm91c2x5LiBUaGlzIGxlYXZlcyBvcGVuIHRoZSBwb3NzaWJpbGl0eQoJICAgICAgICAgICAgICAgIC8vIHRoYXQgd2UnbGwgZXh0ZW5kIHRoZSBBUEkgdG8gc3VwcG9ydCBzeW5jaHJvbm91cyByZXR1cm4gdmFsdWVzIGluIHRoZSBmdXR1cmUuIEl0IHdvbid0IGJlCgkgICAgICAgICAgICAgICAgLy8gYSBicmVha2luZyBjaGFuZ2UsIGJlY2F1c2UgY3VycmVudGx5IG5vIGxvYWRlciBpcyBhbGxvd2VkIHRvIHJldHVybiBhbnl0aGluZyBleGNlcHQgdW5kZWZpbmVkLgoJICAgICAgICAgICAgICAgIGlmIChzeW5jaHJvbm91c1JldHVyblZhbHVlICE9PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgICAgICAgICAgd2FzQWJvcnRlZCA9IHRydWU7CgoJICAgICAgICAgICAgICAgICAgICAvLyBNZXRob2QgdG8gc3VwcHJlc3MgZXhjZXB0aW9ucyB3aWxsIHJlbWFpbiB1bmRvY3VtZW50ZWQuIFRoaXMgaXMgb25seSB0byBrZWVwCgkgICAgICAgICAgICAgICAgICAgIC8vIEtPJ3Mgc3BlY3MgcnVubmluZyB0aWRpbHksIHNpbmNlIHdlIGNhbiBvYnNlcnZlIHRoZSBsb2FkaW5nIGdvdCBhYm9ydGVkIHdpdGhvdXQKCSAgICAgICAgICAgICAgICAgICAgLy8gaGF2aW5nIGV4Y2VwdGlvbnMgY2x1dHRlcmluZyB1cCB0aGUgY29uc29sZSB0b28uCgkgICAgICAgICAgICAgICAgICAgIGlmICghY3VycmVudENhbmRpZGF0ZUxvYWRlclsnc3VwcHJlc3NMb2FkZXJFeGNlcHRpb25zJ10pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcG9uZW50IGxvYWRlcnMgbXVzdCBzdXBwbHkgdmFsdWVzIGJ5IGludm9raW5nIHRoZSBjYWxsYmFjaywgbm90IGJ5IHJldHVybmluZyB2YWx1ZXMgc3luY2hyb25vdXNseS4nKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gVGhpcyBjYW5kaWRhdGUgZG9lc24ndCBoYXZlIHRoZSByZWxldmFudCBoYW5kbGVyLiBTeW5jaHJvbm91c2x5IG1vdmUgb24gdG8gdGhlIG5leHQgb25lLgoJICAgICAgICAgICAgICAgIGdldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMobWV0aG9kTmFtZSwgYXJnc0V4Y2VwdENhbGxiYWNrLCBjYWxsYmFjaywgY2FuZGlkYXRlTG9hZGVycyk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAvLyBObyBjYW5kaWRhdGVzIHJldHVybmVkIGEgdmFsdWUKCSAgICAgICAgICAgIGNhbGxiYWNrKG51bGwpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICAvLyBSZWZlcmVuY2UgdGhlIGxvYWRlcnMgdmlhIHN0cmluZyBuYW1lIHNvIGl0J3MgcG9zc2libGUgZm9yIGRldmVsb3BlcnMKCSAgICAvLyB0byByZXBsYWNlIHRoZSB3aG9sZSBhcnJheSBieSBhc3NpZ25pbmcgdG8ga28uY29tcG9uZW50cy5sb2FkZXJzCgkgICAga28uY29tcG9uZW50c1snbG9hZGVycyddID0gW107CgoJICAgIGtvLmV4cG9ydFN5bWJvbCgnY29tcG9uZW50cycsIGtvLmNvbXBvbmVudHMpOwoJICAgIGtvLmV4cG9ydFN5bWJvbCgnY29tcG9uZW50cy5nZXQnLCBrby5jb21wb25lbnRzLmdldCk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzLmNsZWFyQ2FjaGVkRGVmaW5pdGlvbicsIGtvLmNvbXBvbmVudHMuY2xlYXJDYWNoZWREZWZpbml0aW9uKTsKCX0pKCk7CgkoZnVuY3Rpb24odW5kZWZpbmVkKSB7CgoJICAgIC8vIFRoZSBkZWZhdWx0IGxvYWRlciBpcyByZXNwb25zaWJsZSBmb3IgdHdvIHRoaW5nczoKCSAgICAvLyAxLiBNYWludGFpbmluZyB0aGUgZGVmYXVsdCBpbi1tZW1vcnkgcmVnaXN0cnkgb2YgY29tcG9uZW50IGNvbmZpZ3VyYXRpb24gb2JqZWN0cwoJICAgIC8vICAgIChpLmUuLCB0aGUgdGhpbmcgeW91J3JlIHdyaXRpbmcgdG8gd2hlbiB5b3UgY2FsbCBrby5jb21wb25lbnRzLnJlZ2lzdGVyKHNvbWVOYW1lLCAuLi4pKQoJICAgIC8vIDIuIEFuc3dlcmluZyByZXF1ZXN0cyBmb3IgY29tcG9uZW50cyBieSBmZXRjaGluZyBjb25maWd1cmF0aW9uIG9iamVjdHMKCSAgICAvLyAgICBmcm9tIHRoYXQgZGVmYXVsdCBpbi1tZW1vcnkgcmVnaXN0cnkgYW5kIHJlc29sdmluZyB0aGVtIGludG8gc3RhbmRhcmQKCSAgICAvLyAgICBjb21wb25lbnQgZGVmaW5pdGlvbiBvYmplY3RzIChvZiB0aGUgZm9ybSB7IGNyZWF0ZVZpZXdNb2RlbDogLi4uLCB0ZW1wbGF0ZTogLi4uIH0pCgkgICAgLy8gQ3VzdG9tIGxvYWRlcnMgbWF5IG92ZXJyaWRlIGVpdGhlciBvZiB0aGVzZSBmYWNpbGl0aWVzLCBpLmUuLAoJICAgIC8vIDEuIFRvIHN1cHBseSBjb25maWd1cmF0aW9uIG9iamVjdHMgZnJvbSBzb21lIG90aGVyIHNvdXJjZSAoZS5nLiwgY29udmVudGlvbnMpCgkgICAgLy8gMi4gT3IsIHRvIHJlc29sdmUgY29uZmlndXJhdGlvbiBvYmplY3RzIGJ5IGxvYWRpbmcgdmlld21vZGVscy90ZW1wbGF0ZXMgdmlhIGFyYml0cmFyeSBsb2dpYy4KCgkgICAgdmFyIGRlZmF1bHRDb25maWdSZWdpc3RyeSA9IHt9OwoKCSAgICBrby5jb21wb25lbnRzLnJlZ2lzdGVyID0gZnVuY3Rpb24oY29tcG9uZW50TmFtZSwgY29uZmlnKSB7CgkgICAgICAgIGlmICghY29uZmlnKSB7CgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY29uZmlndXJhdGlvbiBmb3IgJyArIGNvbXBvbmVudE5hbWUpOwoJICAgICAgICB9CgoJICAgICAgICBpZiAoa28uY29tcG9uZW50cy5pc1JlZ2lzdGVyZWQoY29tcG9uZW50TmFtZSkpIHsKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcG9uZW50ICcgKyBjb21wb25lbnROYW1lICsgJyBpcyBhbHJlYWR5IHJlZ2lzdGVyZWQnKTsKCSAgICAgICAgfQoKCSAgICAgICAgZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5W2NvbXBvbmVudE5hbWVdID0gY29uZmlnOwoJICAgIH0KCgkgICAga28uY29tcG9uZW50cy5pc1JlZ2lzdGVyZWQgPSBmdW5jdGlvbihjb21wb25lbnROYW1lKSB7CgkgICAgICAgIHJldHVybiBjb21wb25lbnROYW1lIGluIGRlZmF1bHRDb25maWdSZWdpc3RyeTsKCSAgICB9CgoJICAgIGtvLmNvbXBvbmVudHMudW5yZWdpc3RlciA9IGZ1bmN0aW9uKGNvbXBvbmVudE5hbWUpIHsKCSAgICAgICAgZGVsZXRlIGRlZmF1bHRDb25maWdSZWdpc3RyeVtjb21wb25lbnROYW1lXTsKCSAgICAgICAga28uY29tcG9uZW50cy5jbGVhckNhY2hlZERlZmluaXRpb24oY29tcG9uZW50TmFtZSk7CgkgICAgfQoKCSAgICBrby5jb21wb25lbnRzLmRlZmF1bHRMb2FkZXIgPSB7CgkgICAgICAgICdnZXRDb25maWcnOiBmdW5jdGlvbihjb21wb25lbnROYW1lLCBjYWxsYmFjaykgewoJICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmF1bHRDb25maWdSZWdpc3RyeS5oYXNPd25Qcm9wZXJ0eShjb21wb25lbnROYW1lKQoJICAgICAgICAgICAgICAgID8gZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5W2NvbXBvbmVudE5hbWVdCgkgICAgICAgICAgICAgICAgOiBudWxsOwoJICAgICAgICAgICAgY2FsbGJhY2socmVzdWx0KTsKCSAgICAgICAgfSwKCgkgICAgICAgICdsb2FkQ29tcG9uZW50JzogZnVuY3Rpb24oY29tcG9uZW50TmFtZSwgY29uZmlnLCBjYWxsYmFjaykgewoJICAgICAgICAgICAgdmFyIGVycm9yQ2FsbGJhY2sgPSBtYWtlRXJyb3JDYWxsYmFjayhjb21wb25lbnROYW1lKTsKCSAgICAgICAgICAgIHBvc3NpYmx5R2V0Q29uZmlnRnJvbUFtZChlcnJvckNhbGxiYWNrLCBjb25maWcsIGZ1bmN0aW9uKGxvYWRlZENvbmZpZykgewoJICAgICAgICAgICAgICAgIHJlc29sdmVDb25maWcoY29tcG9uZW50TmFtZSwgZXJyb3JDYWxsYmFjaywgbG9hZGVkQ29uZmlnLCBjYWxsYmFjayk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfSwKCgkgICAgICAgICdsb2FkVGVtcGxhdGUnOiBmdW5jdGlvbihjb21wb25lbnROYW1lLCB0ZW1wbGF0ZUNvbmZpZywgY2FsbGJhY2spIHsKCSAgICAgICAgICAgIHJlc29sdmVUZW1wbGF0ZShtYWtlRXJyb3JDYWxsYmFjayhjb21wb25lbnROYW1lKSwgdGVtcGxhdGVDb25maWcsIGNhbGxiYWNrKTsKCSAgICAgICAgfSwKCgkgICAgICAgICdsb2FkVmlld01vZGVsJzogZnVuY3Rpb24oY29tcG9uZW50TmFtZSwgdmlld01vZGVsQ29uZmlnLCBjYWxsYmFjaykgewoJICAgICAgICAgICAgcmVzb2x2ZVZpZXdNb2RlbChtYWtlRXJyb3JDYWxsYmFjayhjb21wb25lbnROYW1lKSwgdmlld01vZGVsQ29uZmlnLCBjYWxsYmFjayk7CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICB2YXIgY3JlYXRlVmlld01vZGVsS2V5ID0gJ2NyZWF0ZVZpZXdNb2RlbCc7CgoJICAgIC8vIFRha2VzIGEgY29uZmlnIG9iamVjdCBvZiB0aGUgZm9ybSB7IHRlbXBsYXRlOiAuLi4sIHZpZXdNb2RlbDogLi4uIH0sIGFuZCBhc3luY2hyb25vdXNseSBjb252ZXJ0IGl0CgkgICAgLy8gaW50byB0aGUgc3RhbmRhcmQgY29tcG9uZW50IGRlZmluaXRpb24gZm9ybWF0OgoJICAgIC8vICAgIHsgdGVtcGxhdGU6IDxBcnJheU9mRG9tTm9kZXM+LCBjcmVhdGVWaWV3TW9kZWw6IGZ1bmN0aW9uKHBhcmFtcywgY29tcG9uZW50SW5mbykgeyAuLi4gfSB9LgoJICAgIC8vIFNpbmNlIGJvdGggdGVtcGxhdGUgYW5kIHZpZXdNb2RlbCBtYXkgbmVlZCB0byBiZSByZXNvbHZlZCBhc3luY2hyb25vdXNseSwgYm90aCB0YXNrcyBhcmUgcGVyZm9ybWVkCgkgICAgLy8gaW4gcGFyYWxsZWwsIGFuZCB0aGUgcmVzdWx0cyBqb2luZWQgd2hlbiBib3RoIGFyZSByZWFkeS4gV2UgZG9uJ3QgZGVwZW5kIG9uIGFueSBwcm9taXNlcyBpbmZyYXN0cnVjdHVyZSwKCSAgICAvLyBzbyB0aGlzIGlzIGltcGxlbWVudGVkIG1hbnVhbGx5IGJlbG93LgoJICAgIGZ1bmN0aW9uIHJlc29sdmVDb25maWcoY29tcG9uZW50TmFtZSwgZXJyb3JDYWxsYmFjaywgY29uZmlnLCBjYWxsYmFjaykgewoJICAgICAgICB2YXIgcmVzdWx0ID0ge30sCgkgICAgICAgICAgICBtYWtlQ2FsbEJhY2tXaGVuWmVybyA9IDIsCgkgICAgICAgICAgICB0cnlJc3N1ZUNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgaWYgKC0tbWFrZUNhbGxCYWNrV2hlblplcm8gPT09IDApIHsKCSAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2socmVzdWx0KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9LAoJICAgICAgICAgICAgdGVtcGxhdGVDb25maWcgPSBjb25maWdbJ3RlbXBsYXRlJ10sCgkgICAgICAgICAgICB2aWV3TW9kZWxDb25maWcgPSBjb25maWdbJ3ZpZXdNb2RlbCddOwoKCSAgICAgICAgaWYgKHRlbXBsYXRlQ29uZmlnKSB7CgkgICAgICAgICAgICBwb3NzaWJseUdldENvbmZpZ0Zyb21BbWQoZXJyb3JDYWxsYmFjaywgdGVtcGxhdGVDb25maWcsIGZ1bmN0aW9uKGxvYWRlZENvbmZpZykgewoJICAgICAgICAgICAgICAgIGtvLmNvbXBvbmVudHMuX2dldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMoJ2xvYWRUZW1wbGF0ZScsIFtjb21wb25lbnROYW1lLCBsb2FkZWRDb25maWddLCBmdW5jdGlvbihyZXNvbHZlZFRlbXBsYXRlKSB7CgkgICAgICAgICAgICAgICAgICAgIHJlc3VsdFsndGVtcGxhdGUnXSA9IHJlc29sdmVkVGVtcGxhdGU7CgkgICAgICAgICAgICAgICAgICAgIHRyeUlzc3VlQ2FsbGJhY2soKTsKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdHJ5SXNzdWVDYWxsYmFjaygpOwoJICAgICAgICB9CgoJICAgICAgICBpZiAodmlld01vZGVsQ29uZmlnKSB7CgkgICAgICAgICAgICBwb3NzaWJseUdldENvbmZpZ0Zyb21BbWQoZXJyb3JDYWxsYmFjaywgdmlld01vZGVsQ29uZmlnLCBmdW5jdGlvbihsb2FkZWRDb25maWcpIHsKCSAgICAgICAgICAgICAgICBrby5jb21wb25lbnRzLl9nZXRGaXJzdFJlc3VsdEZyb21Mb2FkZXJzKCdsb2FkVmlld01vZGVsJywgW2NvbXBvbmVudE5hbWUsIGxvYWRlZENvbmZpZ10sIGZ1bmN0aW9uKHJlc29sdmVkVmlld01vZGVsKSB7CgkgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtjcmVhdGVWaWV3TW9kZWxLZXldID0gcmVzb2x2ZWRWaWV3TW9kZWw7CgkgICAgICAgICAgICAgICAgICAgIHRyeUlzc3VlQ2FsbGJhY2soKTsKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdHJ5SXNzdWVDYWxsYmFjaygpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiByZXNvbHZlVGVtcGxhdGUoZXJyb3JDYWxsYmFjaywgdGVtcGxhdGVDb25maWcsIGNhbGxiYWNrKSB7CgkgICAgICAgIGlmICh0eXBlb2YgdGVtcGxhdGVDb25maWcgPT09ICdzdHJpbmcnKSB7CgkgICAgICAgICAgICAvLyBNYXJrdXAgLSBwYXJzZSBpdAoJICAgICAgICAgICAgY2FsbGJhY2soa28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQodGVtcGxhdGVDb25maWcpKTsKCSAgICAgICAgfSBlbHNlIGlmICh0ZW1wbGF0ZUNvbmZpZyBpbnN0YW5jZW9mIEFycmF5KSB7CgkgICAgICAgICAgICAvLyBBc3N1bWUgYWxyZWFkeSBhbiBhcnJheSBvZiBET00gbm9kZXMgLSBwYXNzIHRocm91Z2ggdW5jaGFuZ2VkCgkgICAgICAgICAgICBjYWxsYmFjayh0ZW1wbGF0ZUNvbmZpZyk7CgkgICAgICAgIH0gZWxzZSBpZiAoaXNEb2N1bWVudEZyYWdtZW50KHRlbXBsYXRlQ29uZmlnKSkgewoJICAgICAgICAgICAgLy8gRG9jdW1lbnQgZnJhZ21lbnQgLSB1c2UgaXRzIGNoaWxkIG5vZGVzCgkgICAgICAgICAgICBjYWxsYmFjayhrby51dGlscy5tYWtlQXJyYXkodGVtcGxhdGVDb25maWcuY2hpbGROb2RlcykpOwoJICAgICAgICB9IGVsc2UgaWYgKHRlbXBsYXRlQ29uZmlnWydlbGVtZW50J10pIHsKCSAgICAgICAgICAgIHZhciBlbGVtZW50ID0gdGVtcGxhdGVDb25maWdbJ2VsZW1lbnQnXTsKCSAgICAgICAgICAgIGlmIChpc0RvbUVsZW1lbnQoZWxlbWVudCkpIHsKCSAgICAgICAgICAgICAgICAvLyBFbGVtZW50IGluc3RhbmNlIC0gY29weSBpdHMgY2hpbGQgbm9kZXMKCSAgICAgICAgICAgICAgICBjYWxsYmFjayhjbG9uZU5vZGVzRnJvbVRlbXBsYXRlU291cmNlRWxlbWVudChlbGVtZW50KSk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAnc3RyaW5nJykgewoJICAgICAgICAgICAgICAgIC8vIEVsZW1lbnQgSUQgLSBmaW5kIGl0LCB0aGVuIGNvcHkgaXRzIGNoaWxkIG5vZGVzCgkgICAgICAgICAgICAgICAgdmFyIGVsZW1JbnN0YW5jZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGVsZW1lbnQpOwoJICAgICAgICAgICAgICAgIGlmIChlbGVtSW5zdGFuY2UpIHsKCSAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soY2xvbmVOb2Rlc0Zyb21UZW1wbGF0ZVNvdXJjZUVsZW1lbnQoZWxlbUluc3RhbmNlKSk7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgZXJyb3JDYWxsYmFjaygnQ2Fubm90IGZpbmQgZWxlbWVudCB3aXRoIElEICcgKyBlbGVtZW50KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIGVycm9yQ2FsbGJhY2soJ1Vua25vd24gZWxlbWVudCB0eXBlOiAnICsgZWxlbWVudCk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBlcnJvckNhbGxiYWNrKCdVbmtub3duIHRlbXBsYXRlIHZhbHVlOiAnICsgdGVtcGxhdGVDb25maWcpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiByZXNvbHZlVmlld01vZGVsKGVycm9yQ2FsbGJhY2ssIHZpZXdNb2RlbENvbmZpZywgY2FsbGJhY2spIHsKCSAgICAgICAgaWYgKHR5cGVvZiB2aWV3TW9kZWxDb25maWcgPT09ICdmdW5jdGlvbicpIHsKCSAgICAgICAgICAgIC8vIENvbnN0cnVjdG9yIC0gY29udmVydCB0byBzdGFuZGFyZCBmYWN0b3J5IGZ1bmN0aW9uIGZvcm1hdAoJICAgICAgICAgICAgLy8gQnkgZGVzaWduLCB0aGlzIGRvZXMgKm5vdCogc3VwcGx5IGNvbXBvbmVudEluZm8gdG8gdGhlIGNvbnN0cnVjdG9yLCBhcyB0aGUgaW50ZW50IGlzIHRoYXQKCSAgICAgICAgICAgIC8vIGNvbXBvbmVudEluZm8gY29udGFpbnMgbm9uLXZpZXdtb2RlbCBkYXRhIChlLmcuLCB0aGUgY29tcG9uZW50J3MgZWxlbWVudCkgdGhhdCBzaG91bGQgb25seQoJICAgICAgICAgICAgLy8gYmUgdXNlZCBpbiBmYWN0b3J5IGZ1bmN0aW9ucywgbm90IHZpZXdtb2RlbCBjb25zdHJ1Y3RvcnMuCgkgICAgICAgICAgICBjYWxsYmFjayhmdW5jdGlvbiAocGFyYW1zIC8qLCBjb21wb25lbnRJbmZvICovKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyB2aWV3TW9kZWxDb25maWcocGFyYW1zKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2aWV3TW9kZWxDb25maWdbY3JlYXRlVmlld01vZGVsS2V5XSA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgLy8gQWxyZWFkeSBhIGZhY3RvcnkgZnVuY3Rpb24gLSB1c2UgaXQgYXMtaXMKCSAgICAgICAgICAgIGNhbGxiYWNrKHZpZXdNb2RlbENvbmZpZ1tjcmVhdGVWaWV3TW9kZWxLZXldKTsKCSAgICAgICAgfSBlbHNlIGlmICgnaW5zdGFuY2UnIGluIHZpZXdNb2RlbENvbmZpZykgewoJICAgICAgICAgICAgLy8gRml4ZWQgb2JqZWN0IGluc3RhbmNlIC0gcHJvbW90ZSB0byBjcmVhdGVWaWV3TW9kZWwgZm9ybWF0IGZvciBBUEkgY29uc2lzdGVuY3kKCSAgICAgICAgICAgIHZhciBmaXhlZEluc3RhbmNlID0gdmlld01vZGVsQ29uZmlnWydpbnN0YW5jZSddOwoJICAgICAgICAgICAgY2FsbGJhY2soZnVuY3Rpb24gKHBhcmFtcywgY29tcG9uZW50SW5mbykgewoJICAgICAgICAgICAgICAgIHJldHVybiBmaXhlZEluc3RhbmNlOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0gZWxzZSBpZiAoJ3ZpZXdNb2RlbCcgaW4gdmlld01vZGVsQ29uZmlnKSB7CgkgICAgICAgICAgICAvLyBSZXNvbHZlZCBBTUQgbW9kdWxlIHdob3NlIHZhbHVlIGlzIG9mIHRoZSBmb3JtIHsgdmlld01vZGVsOiAuLi4gfQoJICAgICAgICAgICAgcmVzb2x2ZVZpZXdNb2RlbChlcnJvckNhbGxiYWNrLCB2aWV3TW9kZWxDb25maWdbJ3ZpZXdNb2RlbCddLCBjYWxsYmFjayk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBlcnJvckNhbGxiYWNrKCdVbmtub3duIHZpZXdNb2RlbCB2YWx1ZTogJyArIHZpZXdNb2RlbENvbmZpZyk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNsb25lTm9kZXNGcm9tVGVtcGxhdGVTb3VyY2VFbGVtZW50KGVsZW1JbnN0YW5jZSkgewoJICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtSW5zdGFuY2UpKSB7CgkgICAgICAgICAgICBjYXNlICdzY3JpcHQnOgoJICAgICAgICAgICAgICAgIHJldHVybiBrby51dGlscy5wYXJzZUh0bWxGcmFnbWVudChlbGVtSW5zdGFuY2UudGV4dCk7CgkgICAgICAgICAgICBjYXNlICd0ZXh0YXJlYSc6CgkgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KGVsZW1JbnN0YW5jZS52YWx1ZSk7CgkgICAgICAgICAgICBjYXNlICd0ZW1wbGF0ZSc6CgkgICAgICAgICAgICAgICAgLy8gRm9yIGJyb3dzZXJzIHdpdGggcHJvcGVyIDx0ZW1wbGF0ZT4gZWxlbWVudCBzdXBwb3J0IChpLmUuLCB3aGVyZSB0aGUgLmNvbnRlbnQgcHJvcGVydHkKCSAgICAgICAgICAgICAgICAvLyBnaXZlcyBhIGRvY3VtZW50IGZyYWdtZW50KSwgdXNlIHRoYXQgZG9jdW1lbnQgZnJhZ21lbnQuCgkgICAgICAgICAgICAgICAgaWYgKGlzRG9jdW1lbnRGcmFnbWVudChlbGVtSW5zdGFuY2UuY29udGVudCkpIHsKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmNsb25lTm9kZXMoZWxlbUluc3RhbmNlLmNvbnRlbnQuY2hpbGROb2Rlcyk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICAvLyBSZWd1bGFyIGVsZW1lbnRzIHN1Y2ggYXMgPGRpdj4sIGFuZCA8dGVtcGxhdGU+IGVsZW1lbnRzIG9uIG9sZCBicm93c2VycyB0aGF0IGRvbid0IHJlYWxseQoJICAgICAgICAvLyB1bmRlcnN0YW5kIDx0ZW1wbGF0ZT4gYW5kIGp1c3QgdHJlYXQgaXQgYXMgYSByZWd1bGFyIGNvbnRhaW5lcgoJICAgICAgICByZXR1cm4ga28udXRpbHMuY2xvbmVOb2RlcyhlbGVtSW5zdGFuY2UuY2hpbGROb2Rlcyk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBpc0RvbUVsZW1lbnQob2JqKSB7CgkgICAgICAgIGlmICh3aW5kb3dbJ0hUTUxFbGVtZW50J10pIHsKCSAgICAgICAgICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBIVE1MRWxlbWVudDsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHJldHVybiBvYmogJiYgb2JqLnRhZ05hbWUgJiYgb2JqLm5vZGVUeXBlID09PSAxOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBpc0RvY3VtZW50RnJhZ21lbnQob2JqKSB7CgkgICAgICAgIGlmICh3aW5kb3dbJ0RvY3VtZW50RnJhZ21lbnQnXSkgewoJICAgICAgICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIERvY3VtZW50RnJhZ21lbnQ7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5ub2RlVHlwZSA9PT0gMTE7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIHBvc3NpYmx5R2V0Q29uZmlnRnJvbUFtZChlcnJvckNhbGxiYWNrLCBjb25maWcsIGNhbGxiYWNrKSB7CgkgICAgICAgIGlmICh0eXBlb2YgY29uZmlnWydyZXF1aXJlJ10gPT09ICdzdHJpbmcnKSB7CgkgICAgICAgICAgICAvLyBUaGUgY29uZmlnIGlzIHRoZSB2YWx1ZSBvZiBhbiBBTUQgbW9kdWxlCgkgICAgICAgICAgICBpZiAocmVxdWlyZSB8fCB3aW5kb3dbJ3JlcXVpcmUnXSkgewoJICAgICAgICAgICAgICAgIChyZXF1aXJlIHx8IHdpbmRvd1sncmVxdWlyZSddKShbY29uZmlnWydyZXF1aXJlJ11dLCBjYWxsYmFjayk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIGVycm9yQ2FsbGJhY2soJ1VzZXMgcmVxdWlyZSwgYnV0IG5vIEFNRCBsb2FkZXIgaXMgcHJlc2VudCcpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgY2FsbGJhY2soY29uZmlnKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gbWFrZUVycm9yQ2FsbGJhY2soY29tcG9uZW50TmFtZSkgewoJICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG1lc3NhZ2UpIHsKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcG9uZW50IFwnJyArIGNvbXBvbmVudE5hbWUgKyAnXCc6ICcgKyBtZXNzYWdlKTsKCSAgICAgICAgfTsKCSAgICB9CgoJICAgIGtvLmV4cG9ydFN5bWJvbCgnY29tcG9uZW50cy5yZWdpc3RlcicsIGtvLmNvbXBvbmVudHMucmVnaXN0ZXIpOwoJICAgIGtvLmV4cG9ydFN5bWJvbCgnY29tcG9uZW50cy5pc1JlZ2lzdGVyZWQnLCBrby5jb21wb25lbnRzLmlzUmVnaXN0ZXJlZCk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzLnVucmVnaXN0ZXInLCBrby5jb21wb25lbnRzLnVucmVnaXN0ZXIpOwoKCSAgICAvLyBFeHBvc2UgdGhlIGRlZmF1bHQgbG9hZGVyIHNvIHRoYXQgZGV2ZWxvcGVycyBjYW4gZGlyZWN0bHkgYXNrIGl0IGZvciBjb25maWd1cmF0aW9uCgkgICAgLy8gb3IgdG8gcmVzb2x2ZSBjb25maWd1cmF0aW9uCgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzLmRlZmF1bHRMb2FkZXInLCBrby5jb21wb25lbnRzLmRlZmF1bHRMb2FkZXIpOwoKCSAgICAvLyBCeSBkZWZhdWx0LCB0aGUgZGVmYXVsdCBsb2FkZXIgaXMgdGhlIG9ubHkgcmVnaXN0ZXJlZCBjb21wb25lbnQgbG9hZGVyCgkgICAga28uY29tcG9uZW50c1snbG9hZGVycyddLnB1c2goa28uY29tcG9uZW50cy5kZWZhdWx0TG9hZGVyKTsKCgkgICAgLy8gUHJpdmF0ZWx5IGV4cG9zZSB0aGUgdW5kZXJseWluZyBjb25maWcgcmVnaXN0cnkgZm9yIHVzZSBpbiBvbGQtSUUgc2hpbQoJICAgIGtvLmNvbXBvbmVudHMuX2FsbFJlZ2lzdGVyZWRDb21wb25lbnRzID0gZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5OwoJfSkoKTsKCShmdW5jdGlvbiAodW5kZWZpbmVkKSB7CgkgICAgLy8gT3ZlcnJpZGFibGUgQVBJIGZvciBkZXRlcm1pbmluZyB3aGljaCBjb21wb25lbnQgbmFtZSBhcHBsaWVzIHRvIGEgZ2l2ZW4gbm9kZS4gQnkgb3ZlcnJpZGluZyB0aGlzLAoJICAgIC8vIHlvdSBjYW4gZm9yIGV4YW1wbGUgbWFwIHNwZWNpZmljIHRhZ05hbWVzIHRvIGNvbXBvbmVudHMgdGhhdCBhcmUgbm90IHByZXJlZ2lzdGVyZWQuCgkgICAga28uY29tcG9uZW50c1snZ2V0Q29tcG9uZW50TmFtZUZvck5vZGUnXSA9IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgdmFyIHRhZ05hbWVMb3dlciA9IGtvLnV0aWxzLnRhZ05hbWVMb3dlcihub2RlKTsKCSAgICAgICAgcmV0dXJuIGtvLmNvbXBvbmVudHMuaXNSZWdpc3RlcmVkKHRhZ05hbWVMb3dlcikgJiYgdGFnTmFtZUxvd2VyOwoJICAgIH07CgoJICAgIGtvLmNvbXBvbmVudHMuYWRkQmluZGluZ3NGb3JDdXN0b21FbGVtZW50ID0gZnVuY3Rpb24oYWxsQmluZGluZ3MsIG5vZGUsIGJpbmRpbmdDb250ZXh0LCB2YWx1ZUFjY2Vzc29ycykgewoJICAgICAgICAvLyBEZXRlcm1pbmUgaWYgaXQncyByZWFsbHkgYSBjdXN0b20gZWxlbWVudCBtYXRjaGluZyBhIGNvbXBvbmVudAoJICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgewoJICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBrby5jb21wb25lbnRzWydnZXRDb21wb25lbnROYW1lRm9yTm9kZSddKG5vZGUpOwoJICAgICAgICAgICAgaWYgKGNvbXBvbmVudE5hbWUpIHsKCSAgICAgICAgICAgICAgICAvLyBJdCBkb2VzIHJlcHJlc2VudCBhIGNvbXBvbmVudCwgc28gYWRkIGEgY29tcG9uZW50IGJpbmRpbmcgZm9yIGl0CgkgICAgICAgICAgICAgICAgYWxsQmluZGluZ3MgPSBhbGxCaW5kaW5ncyB8fCB7fTsKCgkgICAgICAgICAgICAgICAgaWYgKGFsbEJpbmRpbmdzWydjb21wb25lbnQnXSkgewoJICAgICAgICAgICAgICAgICAgICAvLyBBdm9pZCBzaWxlbnRseSBvdmVyd3JpdGluZyBzb21lIG90aGVyICdjb21wb25lbnQnIGJpbmRpbmcgdGhhdCBtYXkgYWxyZWFkeSBiZSBvbiB0aGUgZWxlbWVudAoJICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCB1c2UgdGhlICJjb21wb25lbnQiIGJpbmRpbmcgb24gYSBjdXN0b20gZWxlbWVudCBtYXRjaGluZyBhIGNvbXBvbmVudCcpOwoJICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudEJpbmRpbmdWYWx1ZSA9IHsgJ25hbWUnOiBjb21wb25lbnROYW1lLCAncGFyYW1zJzogZ2V0Q29tcG9uZW50UGFyYW1zRnJvbUN1c3RvbUVsZW1lbnQobm9kZSwgYmluZGluZ0NvbnRleHQpIH07CgoJICAgICAgICAgICAgICAgIGFsbEJpbmRpbmdzWydjb21wb25lbnQnXSA9IHZhbHVlQWNjZXNzb3JzCgkgICAgICAgICAgICAgICAgICAgID8gZnVuY3Rpb24oKSB7IHJldHVybiBjb21wb25lbnRCaW5kaW5nVmFsdWU7IH0KCSAgICAgICAgICAgICAgICAgICAgOiBjb21wb25lbnRCaW5kaW5nVmFsdWU7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIHJldHVybiBhbGxCaW5kaW5nczsKCSAgICB9CgoJICAgIHZhciBuYXRpdmVCaW5kaW5nUHJvdmlkZXJJbnN0YW5jZSA9IG5ldyBrby5iaW5kaW5nUHJvdmlkZXIoKTsKCgkgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50UGFyYW1zRnJvbUN1c3RvbUVsZW1lbnQoZWxlbSwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgdmFyIHBhcmFtc0F0dHJpYnV0ZSA9IGVsZW0uZ2V0QXR0cmlidXRlKCdwYXJhbXMnKTsKCgkgICAgICAgIGlmIChwYXJhbXNBdHRyaWJ1dGUpIHsKCSAgICAgICAgICAgIHZhciBwYXJhbXMgPSBuYXRpdmVCaW5kaW5nUHJvdmlkZXJJbnN0YW5jZVsncGFyc2VCaW5kaW5nc1N0cmluZyddKHBhcmFtc0F0dHJpYnV0ZSwgYmluZGluZ0NvbnRleHQsIGVsZW0sIHsgJ3ZhbHVlQWNjZXNzb3JzJzogdHJ1ZSwgJ2JpbmRpbmdQYXJhbXMnOiB0cnVlIH0pLAoJICAgICAgICAgICAgICAgIHJhd1BhcmFtQ29tcHV0ZWRWYWx1ZXMgPSBrby51dGlscy5vYmplY3RNYXAocGFyYW1zLCBmdW5jdGlvbihwYXJhbVZhbHVlLCBwYXJhbU5hbWUpIHsKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLmNvbXB1dGVkKHBhcmFtVmFsdWUsIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBlbGVtIH0pOwoJICAgICAgICAgICAgICAgIH0pLAoJICAgICAgICAgICAgICAgIHJlc3VsdCA9IGtvLnV0aWxzLm9iamVjdE1hcChyYXdQYXJhbUNvbXB1dGVkVmFsdWVzLCBmdW5jdGlvbihwYXJhbVZhbHVlQ29tcHV0ZWQsIHBhcmFtTmFtZSkgewoJICAgICAgICAgICAgICAgICAgICAvLyBEb2VzIHRoZSBldmFsdWF0aW9uIG9mIHRoZSBwYXJhbWV0ZXIgdmFsdWUgdW53cmFwIGFueSBvYnNlcnZhYmxlcz8KCSAgICAgICAgICAgICAgICAgICAgaWYgKCFwYXJhbVZhbHVlQ29tcHV0ZWQuaXNBY3RpdmUoKSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm8gaXQgZG9lc24ndCwgc28gdGhlcmUncyBubyBuZWVkIGZvciBhbnkgY29tcHV0ZWQgd3JhcHBlci4gSnVzdCBwYXNzIHRocm91Z2ggdGhlIHN1cHBsaWVkIHZhbHVlIGRpcmVjdGx5LgoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gRXhhbXBsZTogInNvbWVWYWw6IGZpcnN0TmFtZSwgYWdlOiAxMjMiICh3aGV0aGVyIG9yIG5vdCBmaXJzdE5hbWUgaXMgYW4gb2JzZXJ2YWJsZS9jb21wdXRlZCkKCSAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJhbVZhbHVlQ29tcHV0ZWQucGVlaygpOwoJICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gWWVzIGl0IGRvZXMuIFN1cHBseSBhIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgdW53cmFwcyBib3RoIHRoZSBvdXRlciAoYmluZGluZyBleHByZXNzaW9uKQoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGV2ZWwgb2Ygb2JzZXJ2YWJpbGl0eSwgYW5kIGFueSBpbm5lciAocmVzdWx0aW5nIG1vZGVsIHZhbHVlKSBsZXZlbCBvZiBvYnNlcnZhYmlsaXR5LgoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBtZWFucyB0aGUgY29tcG9uZW50IGRvZXNuJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCBtdWx0aXBsZSB1bndyYXBwaW5nLgoJICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHBhcmFtVmFsdWVDb21wdXRlZCgpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0sIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBlbGVtIH0pOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfSk7CgoJICAgICAgICAgICAgLy8gR2l2ZSBhY2Nlc3MgdG8gdGhlIHJhdyBjb21wdXRlZHMsIGFzIGxvbmcgYXMgdGhhdCB3b3VsZG4ndCBvdmVyd3JpdGUgYW55IGN1c3RvbSBwYXJhbSBhbHNvIGNhbGxlZCAnJHJhdycKCSAgICAgICAgICAgIC8vIFRoaXMgaXMgaW4gY2FzZSB0aGUgZGV2ZWxvcGVyIHdhbnRzIHRvIHJlYWN0IHRvIG91dGVyIChiaW5kaW5nKSBvYnNlcnZhYmlsaXR5IHNlcGFyYXRlbHkgZnJvbSBpbm5lcgoJICAgICAgICAgICAgLy8gKG1vZGVsIHZhbHVlKSBvYnNlcnZhYmlsaXR5LCBvciBpbiBjYXNlIHRoZSBtb2RlbCB2YWx1ZSBvYnNlcnZhYmxlIGhhcyBzdWJvYnNlcnZhYmxlcy4KCSAgICAgICAgICAgIGlmICghcmVzdWx0Lmhhc093blByb3BlcnR5KCckcmF3JykpIHsKCSAgICAgICAgICAgICAgICByZXN1bHRbJyRyYXcnXSA9IHJhd1BhcmFtQ29tcHV0ZWRWYWx1ZXM7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIC8vIEZvciBjb25zaXN0ZW5jeSwgYWJzZW5jZSBvZiBhICJwYXJhbXMiIGF0dHJpYnV0ZSBpcyB0cmVhdGVkIHRoZSBzYW1lIGFzIHRoZSBwcmVzZW5jZSBvZgoJICAgICAgICAgICAgLy8gYW55IGVtcHR5IG9uZS4gT3RoZXJ3aXNlIGNvbXBvbmVudCB2aWV3bW9kZWxzIG5lZWQgc3BlY2lhbCBjb2RlIHRvIGNoZWNrIHdoZXRoZXIgb3Igbm90CgkgICAgICAgICAgICAvLyAncGFyYW1zJyBvciAncGFyYW1zLiRyYXcnIGlzIG51bGwvdW5kZWZpbmVkIGJlZm9yZSByZWFkaW5nIHN1YnByb3BlcnRpZXMsIHdoaWNoIGlzIGFubm95aW5nLgoJICAgICAgICAgICAgcmV0dXJuIHsgJyRyYXcnOiB7fSB9OwoJICAgICAgICB9CgkgICAgfQoKCSAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoJICAgIC8vIENvbXBhdGliaWxpdHkgY29kZSBmb3Igb2xkZXIgKHByZS1IVE1MNSkgSUUgYnJvd3NlcnMKCgkgICAgaWYgKGtvLnV0aWxzLmllVmVyc2lvbiA8IDkpIHsKCSAgICAgICAgLy8gV2hlbmV2ZXIgeW91IHByZXJlZ2lzdGVyIGEgY29tcG9uZW50LCBlbmFibGUgaXQgYXMgYSBjdXN0b20gZWxlbWVudCBpbiB0aGUgY3VycmVudCBkb2N1bWVudAoJICAgICAgICBrby5jb21wb25lbnRzWydyZWdpc3RlciddID0gKGZ1bmN0aW9uKG9yaWdpbmFsRnVuY3Rpb24pIHsKCSAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihjb21wb25lbnROYW1lKSB7CgkgICAgICAgICAgICAgICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudChjb21wb25lbnROYW1lKTsgLy8gQWxsb3dzIElFPDkgdG8gcGFyc2UgbWFya3VwIGNvbnRhaW5pbmcgdGhlIGN1c3RvbSBlbGVtZW50CgkgICAgICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsRnVuY3Rpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSkoa28uY29tcG9uZW50c1sncmVnaXN0ZXInXSk7CgoJICAgICAgICAvLyBXaGVuZXZlciB5b3UgY3JlYXRlIGEgZG9jdW1lbnQgZnJhZ21lbnQsIGVuYWJsZSBhbGwgcHJlcmVnaXN0ZXJlZCBjb21wb25lbnQgbmFtZXMgYXMgY3VzdG9tIGVsZW1lbnRzCgkgICAgICAgIC8vIFRoaXMgaXMgbmVlZGVkIHRvIG1ha2UgaW5uZXJTaGl2L2pRdWVyeSBIVE1MIHBhcnNpbmcgY29ycmVjdGx5IGhhbmRsZSB0aGUgY3VzdG9tIGVsZW1lbnRzCgkgICAgICAgIGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQgPSAoZnVuY3Rpb24ob3JpZ2luYWxGdW5jdGlvbikgewoJICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgIHZhciBuZXdEb2NGcmFnID0gb3JpZ2luYWxGdW5jdGlvbigpLAoJICAgICAgICAgICAgICAgICAgICBhbGxDb21wb25lbnRzID0ga28uY29tcG9uZW50cy5fYWxsUmVnaXN0ZXJlZENvbXBvbmVudHM7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgY29tcG9uZW50TmFtZSBpbiBhbGxDb21wb25lbnRzKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChhbGxDb21wb25lbnRzLmhhc093blByb3BlcnR5KGNvbXBvbmVudE5hbWUpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBuZXdEb2NGcmFnLmNyZWF0ZUVsZW1lbnQoY29tcG9uZW50TmFtZSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgcmV0dXJuIG5ld0RvY0ZyYWc7CgkgICAgICAgICAgICB9OwoJICAgICAgICB9KShkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KTsKCSAgICB9Cgl9KSgpOyhmdW5jdGlvbih1bmRlZmluZWQpIHsKCgkgICAgdmFyIGNvbXBvbmVudExvYWRpbmdPcGVyYXRpb25VbmlxdWVJZCA9IDA7CgoJICAgIGtvLmJpbmRpbmdIYW5kbGVyc1snY29tcG9uZW50J10gPSB7CgkgICAgICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgaWdub3JlZDEsIGlnbm9yZWQyLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAgICAgdmFyIGN1cnJlbnRWaWV3TW9kZWwsCgkgICAgICAgICAgICAgICAgY3VycmVudExvYWRpbmdPcGVyYXRpb25JZCwKCSAgICAgICAgICAgICAgICBkaXNwb3NlQXNzb2NpYXRlZENvbXBvbmVudFZpZXdNb2RlbCA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRWaWV3TW9kZWxEaXNwb3NlID0gY3VycmVudFZpZXdNb2RlbCAmJiBjdXJyZW50Vmlld01vZGVsWydkaXNwb3NlJ107CgkgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY3VycmVudFZpZXdNb2RlbERpc3Bvc2UgPT09ICdmdW5jdGlvbicpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3TW9kZWxEaXNwb3NlLmNhbGwoY3VycmVudFZpZXdNb2RlbCk7CgkgICAgICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgICAgIC8vIEFueSBpbi1mbGlnaHQgbG9hZGluZyBvcGVyYXRpb24gaXMgbm8gbG9uZ2VyIHJlbGV2YW50LCBzbyBtYWtlIHN1cmUgd2UgaWdub3JlIGl0cyBjb21wbGV0aW9uCgkgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRMb2FkaW5nT3BlcmF0aW9uSWQgPSBudWxsOwoJICAgICAgICAgICAgICAgIH07CgoJICAgICAgICAgICAga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayhlbGVtZW50LCBkaXNwb3NlQXNzb2NpYXRlZENvbXBvbmVudFZpZXdNb2RlbCk7CgoJICAgICAgICAgICAga28uY29tcHV0ZWQoZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKSwKCSAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50TmFtZSwgY29tcG9uZW50UGFyYW1zOwoKCSAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewoJICAgICAgICAgICAgICAgICAgICBjb21wb25lbnROYW1lID0gdmFsdWU7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50TmFtZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVbJ25hbWUnXSk7CgkgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudFBhcmFtcyA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVbJ3BhcmFtcyddKTsKCSAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgIGlmICghY29tcG9uZW50TmFtZSkgewoJICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGNvbXBvbmVudCBuYW1lIHNwZWNpZmllZCcpOwoJICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgdmFyIGxvYWRpbmdPcGVyYXRpb25JZCA9IGN1cnJlbnRMb2FkaW5nT3BlcmF0aW9uSWQgPSArK2NvbXBvbmVudExvYWRpbmdPcGVyYXRpb25VbmlxdWVJZDsKCSAgICAgICAgICAgICAgICBrby5jb21wb25lbnRzLmdldChjb21wb25lbnROYW1lLCBmdW5jdGlvbihjb21wb25lbnREZWZpbml0aW9uKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgaXMgbm90IHRoZSBjdXJyZW50IGxvYWQgb3BlcmF0aW9uIGZvciB0aGlzIGVsZW1lbnQsIGlnbm9yZSBpdC4KCSAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRMb2FkaW5nT3BlcmF0aW9uSWQgIT09IGxvYWRpbmdPcGVyYXRpb25JZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgICAgICAvLyBDbGVhbiB1cCBwcmV2aW91cyBzdGF0ZQoJICAgICAgICAgICAgICAgICAgICBkaXNwb3NlQXNzb2NpYXRlZENvbXBvbmVudFZpZXdNb2RlbCgpOwoKCSAgICAgICAgICAgICAgICAgICAgLy8gSW5zdGFudGlhdGUgYW5kIGJpbmQgbmV3IGNvbXBvbmVudC4gSW1wbGljaXRseSB0aGlzIGNsZWFucyBhbnkgb2xkIERPTSBub2Rlcy4KCSAgICAgICAgICAgICAgICAgICAgaWYgKCFjb21wb25lbnREZWZpbml0aW9uKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gY29tcG9uZW50IFwnJyArIGNvbXBvbmVudE5hbWUgKyAnXCcnKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBjbG9uZVRlbXBsYXRlSW50b0VsZW1lbnQoY29tcG9uZW50TmFtZSwgY29tcG9uZW50RGVmaW5pdGlvbiwgZWxlbWVudCk7CgkgICAgICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnRWaWV3TW9kZWwgPSBjcmVhdGVWaWV3TW9kZWwoY29tcG9uZW50RGVmaW5pdGlvbiwgZWxlbWVudCwgY29tcG9uZW50UGFyYW1zKSwKCSAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkQmluZGluZ0NvbnRleHQgPSBiaW5kaW5nQ29udGV4dFsnY3JlYXRlQ2hpbGRDb250ZXh0J10oY29tcG9uZW50Vmlld01vZGVsKTsKCSAgICAgICAgICAgICAgICAgICAgY3VycmVudFZpZXdNb2RlbCA9IGNvbXBvbmVudFZpZXdNb2RlbDsKCSAgICAgICAgICAgICAgICAgICAga28uYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHMoY2hpbGRCaW5kaW5nQ29udGV4dCwgZWxlbWVudCk7CgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogZWxlbWVudCB9KTsKCgkgICAgICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICBrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWydjb21wb25lbnQnXSA9IHRydWU7CgoJICAgIGZ1bmN0aW9uIGNsb25lVGVtcGxhdGVJbnRvRWxlbWVudChjb21wb25lbnROYW1lLCBjb21wb25lbnREZWZpbml0aW9uLCBlbGVtZW50KSB7CgkgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGNvbXBvbmVudERlZmluaXRpb25bJ3RlbXBsYXRlJ107CgkgICAgICAgIGlmICghdGVtcGxhdGUpIHsKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcG9uZW50IFwnJyArIGNvbXBvbmVudE5hbWUgKyAnXCcgaGFzIG5vIHRlbXBsYXRlJyk7CgkgICAgICAgIH0KCgkgICAgICAgIHZhciBjbG9uZWROb2Rlc0FycmF5ID0ga28udXRpbHMuY2xvbmVOb2Rlcyh0ZW1wbGF0ZSk7CgkgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4oZWxlbWVudCwgY2xvbmVkTm9kZXNBcnJheSk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBjcmVhdGVWaWV3TW9kZWwoY29tcG9uZW50RGVmaW5pdGlvbiwgZWxlbWVudCwgY29tcG9uZW50UGFyYW1zKSB7CgkgICAgICAgIHZhciBjb21wb25lbnRWaWV3TW9kZWxGYWN0b3J5ID0gY29tcG9uZW50RGVmaW5pdGlvblsnY3JlYXRlVmlld01vZGVsJ107CgkgICAgICAgIHJldHVybiBjb21wb25lbnRWaWV3TW9kZWxGYWN0b3J5CgkgICAgICAgICAgICA/IGNvbXBvbmVudFZpZXdNb2RlbEZhY3RvcnkuY2FsbChjb21wb25lbnREZWZpbml0aW9uLCBjb21wb25lbnRQYXJhbXMsIHsgZWxlbWVudDogZWxlbWVudCB9KQoJICAgICAgICAgICAgOiBjb21wb25lbnRQYXJhbXM7IC8vIFRlbXBsYXRlLW9ubHkgY29tcG9uZW50CgkgICAgfQoKCX0pKCk7Cgl2YXIgYXR0ckh0bWxUb0phdmFzY3JpcHRNYXAgPSB7ICdjbGFzcyc6ICdjbGFzc05hbWUnLCAnZm9yJzogJ2h0bWxGb3InIH07Cglrby5iaW5kaW5nSGFuZGxlcnNbJ2F0dHInXSA9IHsKCSAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MpIHsKCSAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpIHx8IHt9OwoJICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKHZhbHVlLCBmdW5jdGlvbihhdHRyTmFtZSwgYXR0clZhbHVlKSB7CgkgICAgICAgICAgICBhdHRyVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGF0dHJWYWx1ZSk7CgoJICAgICAgICAgICAgLy8gVG8gY292ZXIgY2FzZXMgbGlrZSAiYXR0cjogeyBjaGVja2VkOnNvbWVQcm9wIH0iLCB3ZSB3YW50IHRvIHJlbW92ZSB0aGUgYXR0cmlidXRlIGVudGlyZWx5CgkgICAgICAgICAgICAvLyB3aGVuIHNvbWVQcm9wIGlzIGEgIm5vIHZhbHVlIi1saWtlIHZhbHVlIChzdHJpY3RseSBudWxsLCBmYWxzZSwgb3IgdW5kZWZpbmVkKQoJICAgICAgICAgICAgLy8gKGJlY2F1c2UgdGhlIGFic2VuY2Ugb2YgdGhlICJjaGVja2VkIiBhdHRyIGlzIGhvdyB0byBtYXJrIGFuIGVsZW1lbnQgYXMgbm90IGNoZWNrZWQsIGV0Yy4pCgkgICAgICAgICAgICB2YXIgdG9SZW1vdmUgPSAoYXR0clZhbHVlID09PSBmYWxzZSkgfHwgKGF0dHJWYWx1ZSA9PT0gbnVsbCkgfHwgKGF0dHJWYWx1ZSA9PT0gdW5kZWZpbmVkKTsKCSAgICAgICAgICAgIGlmICh0b1JlbW92ZSkKCSAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShhdHRyTmFtZSk7CgoJICAgICAgICAgICAgLy8gSW4gSUUgPD0gNyBhbmQgSUU4IFF1aXJrcyBNb2RlLCB5b3UgaGF2ZSB0byB1c2UgdGhlIEphdmFzY3JpcHQgcHJvcGVydHkgbmFtZSBpbnN0ZWFkIG9mIHRoZQoJICAgICAgICAgICAgLy8gSFRNTCBhdHRyaWJ1dGUgbmFtZSBmb3IgY2VydGFpbiBhdHRyaWJ1dGVzLiBJRTggU3RhbmRhcmRzIE1vZGUgc3VwcG9ydHMgdGhlIGNvcnJlY3QgYmVoYXZpb3IsCgkgICAgICAgICAgICAvLyBidXQgaW5zdGVhZCBvZiBmaWd1cmluZyBvdXQgdGhlIG1vZGUsIHdlJ2xsIGp1c3Qgc2V0IHRoZSBhdHRyaWJ1dGUgdGhyb3VnaCB0aGUgSmF2YXNjcmlwdAoJICAgICAgICAgICAgLy8gcHJvcGVydHkgZm9yIElFIDw9IDguCgkgICAgICAgICAgICBpZiAoa28udXRpbHMuaWVWZXJzaW9uIDw9IDggJiYgYXR0ck5hbWUgaW4gYXR0ckh0bWxUb0phdmFzY3JpcHRNYXApIHsKCSAgICAgICAgICAgICAgICBhdHRyTmFtZSA9IGF0dHJIdG1sVG9KYXZhc2NyaXB0TWFwW2F0dHJOYW1lXTsKCSAgICAgICAgICAgICAgICBpZiAodG9SZW1vdmUpCgkgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGF0dHJOYW1lKTsKCSAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbYXR0ck5hbWVdID0gYXR0clZhbHVlOwoJICAgICAgICAgICAgfSBlbHNlIGlmICghdG9SZW1vdmUpIHsKCSAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgYXR0clZhbHVlLnRvU3RyaW5nKCkpOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIC8vIFRyZWF0ICJuYW1lIiBzcGVjaWFsbHkgLSBhbHRob3VnaCB5b3UgY2FuIHRoaW5rIG9mIGl0IGFzIGFuIGF0dHJpYnV0ZSwgaXQgYWxzbyBuZWVkcwoJICAgICAgICAgICAgLy8gc3BlY2lhbCBoYW5kbGluZyBvbiBvbGRlciB2ZXJzaW9ucyBvZiBJRSAoaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvMzMzKQoJICAgICAgICAgICAgLy8gRGVsaWJlcmF0ZWx5IGJlaW5nIGNhc2Utc2Vuc2l0aXZlIGhlcmUgYmVjYXVzZSBYSFRNTCB3b3VsZCByZWdhcmQgIk5hbWUiIGFzIGEgZGlmZmVyZW50IHRoaW5nCgkgICAgICAgICAgICAvLyBlbnRpcmVseSwgYW5kIHRoZXJlJ3Mgbm8gc3Ryb25nIHJlYXNvbiB0byBhbGxvdyBmb3Igc3VjaCBjYXNpbmcgaW4gSFRNTC4KCSAgICAgICAgICAgIGlmIChhdHRyTmFtZSA9PT0gIm5hbWUiKSB7CgkgICAgICAgICAgICAgICAga28udXRpbHMuc2V0RWxlbWVudE5hbWUoZWxlbWVudCwgdG9SZW1vdmUgPyAiIiA6IGF0dHJWYWx1ZS50b1N0cmluZygpKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgfQoJfTsKCShmdW5jdGlvbigpIHsKCglrby5iaW5kaW5nSGFuZGxlcnNbJ2NoZWNrZWQnXSA9IHsKCSAgICAnYWZ0ZXInOiBbJ3ZhbHVlJywgJ2F0dHInXSwKCSAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncykgewoJICAgICAgICB2YXIgY2hlY2tlZFZhbHVlID0ga28ucHVyZUNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgLy8gVHJlYXQgInZhbHVlIiBsaWtlICJjaGVja2VkVmFsdWUiIHdoZW4gaXQgaXMgaW5jbHVkZWQgd2l0aCAiY2hlY2tlZCIgYmluZGluZwoJICAgICAgICAgICAgaWYgKGFsbEJpbmRpbmdzWydoYXMnXSgnY2hlY2tlZFZhbHVlJykpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShhbGxCaW5kaW5ncy5nZXQoJ2NoZWNrZWRWYWx1ZScpKTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAoYWxsQmluZGluZ3NbJ2hhcyddKCd2YWx1ZScpKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYWxsQmluZGluZ3MuZ2V0KCd2YWx1ZScpKTsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICByZXR1cm4gZWxlbWVudC52YWx1ZTsKCSAgICAgICAgfSk7CgoJICAgICAgICBmdW5jdGlvbiB1cGRhdGVNb2RlbCgpIHsKCSAgICAgICAgICAgIC8vIFRoaXMgdXBkYXRlcyB0aGUgbW9kZWwgdmFsdWUgZnJvbSB0aGUgdmlldyB2YWx1ZS4KCSAgICAgICAgICAgIC8vIEl0IHJ1bnMgaW4gcmVzcG9uc2UgdG8gRE9NIGV2ZW50cyAoY2xpY2spIGFuZCBjaGFuZ2VzIGluIGNoZWNrZWRWYWx1ZS4KCSAgICAgICAgICAgIHZhciBpc0NoZWNrZWQgPSBlbGVtZW50LmNoZWNrZWQsCgkgICAgICAgICAgICAgICAgZWxlbVZhbHVlID0gdXNlQ2hlY2tlZFZhbHVlID8gY2hlY2tlZFZhbHVlKCkgOiBpc0NoZWNrZWQ7CgoJICAgICAgICAgICAgLy8gV2hlbiB3ZSdyZSBmaXJzdCBzZXR0aW5nIHVwIHRoaXMgY29tcHV0ZWQsIGRvbid0IGNoYW5nZSBhbnkgbW9kZWwgc3RhdGUuCgkgICAgICAgICAgICBpZiAoa28uY29tcHV0ZWRDb250ZXh0LmlzSW5pdGlhbCgpKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIC8vIFdlIGNhbiBpZ25vcmUgdW5jaGVja2VkIHJhZGlvIGJ1dHRvbnMsIGJlY2F1c2Ugc29tZSBvdGhlciByYWRpbwoJICAgICAgICAgICAgLy8gYnV0dG9uIHdpbGwgYmUgZ2V0dGluZyBjaGVja2VkLCBhbmQgdGhhdCBvbmUgY2FuIHRha2UgY2FyZSBvZiB1cGRhdGluZyBzdGF0ZS4KCSAgICAgICAgICAgIGlmIChpc1JhZGlvICYmICFpc0NoZWNrZWQpIHsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZSh2YWx1ZUFjY2Vzc29yKTsKCSAgICAgICAgICAgIGlmIChpc1ZhbHVlQXJyYXkpIHsKCSAgICAgICAgICAgICAgICBpZiAob2xkRWxlbVZhbHVlICE9PSBlbGVtVmFsdWUpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gV2hlbiB3ZSdyZSByZXNwb25kaW5nIHRvIHRoZSBjaGVja2VkVmFsdWUgY2hhbmdpbmcsIGFuZCB0aGUgZWxlbWVudCBpcwoJICAgICAgICAgICAgICAgICAgICAvLyBjdXJyZW50bHkgY2hlY2tlZCwgcmVwbGFjZSB0aGUgb2xkIGVsZW0gdmFsdWUgd2l0aCB0aGUgbmV3IGVsZW0gdmFsdWUKCSAgICAgICAgICAgICAgICAgICAgLy8gaW4gdGhlIG1vZGVsIGFycmF5LgoJICAgICAgICAgICAgICAgICAgICBpZiAoaXNDaGVja2VkKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hZGRPclJlbW92ZUl0ZW0obW9kZWxWYWx1ZSwgZWxlbVZhbHVlLCB0cnVlKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFkZE9yUmVtb3ZlSXRlbShtb2RlbFZhbHVlLCBvbGRFbGVtVmFsdWUsIGZhbHNlKTsKCSAgICAgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAgICAgb2xkRWxlbVZhbHVlID0gZWxlbVZhbHVlOwoJICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIFdoZW4gd2UncmUgcmVzcG9uZGluZyB0byB0aGUgdXNlciBoYXZpbmcgY2hlY2tlZC91bmNoZWNrZWQgYSBjaGVja2JveCwKCSAgICAgICAgICAgICAgICAgICAgLy8gYWRkL3JlbW92ZSB0aGUgZWxlbWVudCB2YWx1ZSB0byB0aGUgbW9kZWwgYXJyYXkuCgkgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFkZE9yUmVtb3ZlSXRlbShtb2RlbFZhbHVlLCBlbGVtVmFsdWUsIGlzQ2hlY2tlZCk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzLCAnY2hlY2tlZCcsIGVsZW1WYWx1ZSwgdHJ1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH07CgoJICAgICAgICBmdW5jdGlvbiB1cGRhdGVWaWV3KCkgewoJICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGVzIHRoZSB2aWV3IHZhbHVlIGZyb20gdGhlIG1vZGVsIHZhbHVlLgoJICAgICAgICAgICAgLy8gSXQgcnVucyBpbiByZXNwb25zZSB0byBjaGFuZ2VzIGluIHRoZSBib3VuZCAoY2hlY2tlZCkgdmFsdWUuCgkgICAgICAgICAgICB2YXIgbW9kZWxWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCgkgICAgICAgICAgICBpZiAoaXNWYWx1ZUFycmF5KSB7CgkgICAgICAgICAgICAgICAgLy8gV2hlbiBhIGNoZWNrYm94IGlzIGJvdW5kIHRvIGFuIGFycmF5LCBiZWluZyBjaGVja2VkIHJlcHJlc2VudHMgaXRzIHZhbHVlIGJlaW5nIHByZXNlbnQgaW4gdGhhdCBhcnJheQoJICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihtb2RlbFZhbHVlLCBjaGVja2VkVmFsdWUoKSkgPj0gMDsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNDaGVja2JveCkgewoJICAgICAgICAgICAgICAgIC8vIFdoZW4gYSBjaGVja2JveCBpcyBib3VuZCB0byBhbnkgb3RoZXIgdmFsdWUgKG5vdCBhbiBhcnJheSksIGJlaW5nIGNoZWNrZWQgcmVwcmVzZW50cyB0aGUgdmFsdWUgYmVpbmcgdHJ1ZWlzaAoJICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IG1vZGVsVmFsdWU7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIEZvciByYWRpbyBidXR0b25zLCBiZWluZyBjaGVja2VkIG1lYW5zIHRoYXQgdGhlIHJhZGlvIGJ1dHRvbidzIHZhbHVlIGNvcnJlc3BvbmRzIHRvIHRoZSBtb2RlbCB2YWx1ZQoJICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IChjaGVja2VkVmFsdWUoKSA9PT0gbW9kZWxWYWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH07CgoJICAgICAgICB2YXIgaXNDaGVja2JveCA9IGVsZW1lbnQudHlwZSA9PSAiY2hlY2tib3giLAoJICAgICAgICAgICAgaXNSYWRpbyA9IGVsZW1lbnQudHlwZSA9PSAicmFkaW8iOwoKCSAgICAgICAgLy8gT25seSBiaW5kIHRvIGNoZWNrIGJveGVzIGFuZCByYWRpbyBidXR0b25zCgkgICAgICAgIGlmICghaXNDaGVja2JveCAmJiAhaXNSYWRpbykgewoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgoJICAgICAgICB2YXIgaXNWYWx1ZUFycmF5ID0gaXNDaGVja2JveCAmJiAoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpIGluc3RhbmNlb2YgQXJyYXkpLAoJICAgICAgICAgICAgb2xkRWxlbVZhbHVlID0gaXNWYWx1ZUFycmF5ID8gY2hlY2tlZFZhbHVlKCkgOiB1bmRlZmluZWQsCgkgICAgICAgICAgICB1c2VDaGVja2VkVmFsdWUgPSBpc1JhZGlvIHx8IGlzVmFsdWVBcnJheTsKCgkgICAgICAgIC8vIElFIDYgd29uJ3QgYWxsb3cgcmFkaW8gYnV0dG9ucyB0byBiZSBzZWxlY3RlZCB1bmxlc3MgdGhleSBoYXZlIGEgbmFtZQoJICAgICAgICBpZiAoaXNSYWRpbyAmJiAhZWxlbWVudC5uYW1lKQoJICAgICAgICAgICAga28uYmluZGluZ0hhbmRsZXJzWyd1bmlxdWVOYW1lJ11bJ2luaXQnXShlbGVtZW50LCBmdW5jdGlvbigpIHsgcmV0dXJuIHRydWUgfSk7CgoJICAgICAgICAvLyBTZXQgdXAgdHdvIGNvbXB1dGVkcyB0byB1cGRhdGUgdGhlIGJpbmRpbmc6CgoJICAgICAgICAvLyBUaGUgZmlyc3QgcmVzcG9uZHMgdG8gY2hhbmdlcyBpbiB0aGUgY2hlY2tlZFZhbHVlIHZhbHVlIGFuZCB0byBlbGVtZW50IGNsaWNrcwoJICAgICAgICBrby5jb21wdXRlZCh1cGRhdGVNb2RlbCwgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGVsZW1lbnQgfSk7CgkgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJjbGljayIsIHVwZGF0ZU1vZGVsKTsKCgkgICAgICAgIC8vIFRoZSBzZWNvbmQgcmVzcG9uZHMgdG8gY2hhbmdlcyBpbiB0aGUgbW9kZWwgdmFsdWUgKHRoZSBvbmUgYXNzb2NpYXRlZCB3aXRoIHRoZSBjaGVja2VkIGJpbmRpbmcpCgkgICAgICAgIGtvLmNvbXB1dGVkKHVwZGF0ZVZpZXcsIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBlbGVtZW50IH0pOwoJICAgIH0KCX07Cglrby5leHByZXNzaW9uUmV3cml0aW5nLnR3b1dheUJpbmRpbmdzWydjaGVja2VkJ10gPSB0cnVlOwoKCWtvLmJpbmRpbmdIYW5kbGVyc1snY2hlY2tlZFZhbHVlJ10gPSB7CgkgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIGVsZW1lbnQudmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgfQoJfTsKCgl9KSgpO3ZhciBjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleSA9ICdfX2tvX19jc3NWYWx1ZSc7Cglrby5iaW5kaW5nSGFuZGxlcnNbJ2NzcyddID0gewoJICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2godmFsdWUsIGZ1bmN0aW9uKGNsYXNzTmFtZSwgc2hvdWxkSGF2ZUNsYXNzKSB7CgkgICAgICAgICAgICAgICAgc2hvdWxkSGF2ZUNsYXNzID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShzaG91bGRIYXZlQ2xhc3MpOwoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUsIHNob3VsZEhhdmVDbGFzcyk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHZhbHVlID0gU3RyaW5nKHZhbHVlIHx8ICcnKTsgLy8gTWFrZSBzdXJlIHdlIGRvbid0IHRyeSB0byBzdG9yZSBvciBzZXQgYSBub24tc3RyaW5nIHZhbHVlCgkgICAgICAgICAgICBrby51dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MoZWxlbWVudCwgZWxlbWVudFtjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleV0sIGZhbHNlKTsKCSAgICAgICAgICAgIGVsZW1lbnRbY2xhc3Nlc1dyaXR0ZW5CeUJpbmRpbmdLZXldID0gdmFsdWU7CgkgICAgICAgICAgICBrby51dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MoZWxlbWVudCwgdmFsdWUsIHRydWUpOwoJICAgICAgICB9CgkgICAgfQoJfTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snZW5hYmxlJ10gPSB7CgkgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCSAgICAgICAgaWYgKHZhbHVlICYmIGVsZW1lbnQuZGlzYWJsZWQpCgkgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSgiZGlzYWJsZWQiKTsKCSAgICAgICAgZWxzZSBpZiAoKCF2YWx1ZSkgJiYgKCFlbGVtZW50LmRpc2FibGVkKSkKCSAgICAgICAgICAgIGVsZW1lbnQuZGlzYWJsZWQgPSB0cnVlOwoJICAgIH0KCX07CgoJa28uYmluZGluZ0hhbmRsZXJzWydkaXNhYmxlJ10gPSB7CgkgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIGtvLmJpbmRpbmdIYW5kbGVyc1snZW5hYmxlJ11bJ3VwZGF0ZSddKGVsZW1lbnQsIGZ1bmN0aW9uKCkgeyByZXR1cm4gIWtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKSB9KTsKCSAgICB9Cgl9OwoJLy8gRm9yIGNlcnRhaW4gY29tbW9uIGV2ZW50cyAoY3VycmVudGx5IGp1c3QgJ2NsaWNrJyksIGFsbG93IGEgc2ltcGxpZmllZCBkYXRhLWJpbmRpbmcgc3ludGF4CgkvLyBlLmcuIGNsaWNrOmhhbmRsZXIgaW5zdGVhZCBvZiB0aGUgdXN1YWwgZnVsbC1sZW5ndGggZXZlbnQ6e2NsaWNrOmhhbmRsZXJ9CglmdW5jdGlvbiBtYWtlRXZlbnRIYW5kbGVyU2hvcnRjdXQoZXZlbnROYW1lKSB7CgkgICAga28uYmluZGluZ0hhbmRsZXJzW2V2ZW50TmFtZV0gPSB7CgkgICAgICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgICAgIHZhciBuZXdWYWx1ZUFjY2Vzc29yID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSB7fTsKCSAgICAgICAgICAgICAgICByZXN1bHRbZXZlbnROYW1lXSA9IHZhbHVlQWNjZXNzb3IoKTsKCSAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIHJldHVybiBrby5iaW5kaW5nSGFuZGxlcnNbJ2V2ZW50J11bJ2luaXQnXS5jYWxsKHRoaXMsIGVsZW1lbnQsIG5ld1ZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KTsKCSAgICAgICAgfQoJICAgIH0KCX0KCglrby5iaW5kaW5nSGFuZGxlcnNbJ2V2ZW50J10gPSB7CgkgICAgJ2luaXQnIDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIHZhciBldmVudHNUb0hhbmRsZSA9IHZhbHVlQWNjZXNzb3IoKSB8fCB7fTsKCSAgICAgICAga28udXRpbHMub2JqZWN0Rm9yRWFjaChldmVudHNUb0hhbmRsZSwgZnVuY3Rpb24oZXZlbnROYW1lKSB7CgkgICAgICAgICAgICBpZiAodHlwZW9mIGV2ZW50TmFtZSA9PSAic3RyaW5nIikgewoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50TmFtZSwgZnVuY3Rpb24gKGV2ZW50KSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyUmV0dXJuVmFsdWU7CgkgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyRnVuY3Rpb24gPSB2YWx1ZUFjY2Vzc29yKClbZXZlbnROYW1lXTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKCFoYW5kbGVyRnVuY3Rpb24pCgkgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CgoJICAgICAgICAgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGFrZSBhbGwgdGhlIGV2ZW50IGFyZ3MsIGFuZCBwcmVmaXggd2l0aCB0aGUgdmlld21vZGVsCgkgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJnc0ZvckhhbmRsZXIgPSBrby51dGlscy5tYWtlQXJyYXkoYXJndW1lbnRzKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIHZpZXdNb2RlbCA9IGJpbmRpbmdDb250ZXh0WyckZGF0YSddOwoJICAgICAgICAgICAgICAgICAgICAgICAgYXJnc0ZvckhhbmRsZXIudW5zaGlmdCh2aWV3TW9kZWwpOwoJICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlclJldHVyblZhbHVlID0gaGFuZGxlckZ1bmN0aW9uLmFwcGx5KHZpZXdNb2RlbCwgYXJnc0ZvckhhbmRsZXIpOwoJICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXJSZXR1cm5WYWx1ZSAhPT0gdHJ1ZSkgeyAvLyBOb3JtYWxseSB3ZSB3YW50IHRvIHByZXZlbnQgZGVmYXVsdCBhY3Rpb24uIERldmVsb3BlciBjYW4gb3ZlcnJpZGUgdGhpcyBiZSBleHBsaWNpdGx5IHJldHVybmluZyB0cnVlLgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgICAgIHZhciBidWJibGUgPSBhbGxCaW5kaW5ncy5nZXQoZXZlbnROYW1lICsgJ0J1YmJsZScpICE9PSBmYWxzZTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKCFidWJibGUpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgIH0KCX07CgkvLyAiZm9yZWFjaDogc29tZUV4cHJlc3Npb24iIGlzIGVxdWl2YWxlbnQgdG8gInRlbXBsYXRlOiB7IGZvcmVhY2g6IHNvbWVFeHByZXNzaW9uIH0iCgkvLyAiZm9yZWFjaDogeyBkYXRhOiBzb21lRXhwcmVzc2lvbiwgYWZ0ZXJBZGQ6IG15Zm4gfSIgaXMgZXF1aXZhbGVudCB0byAidGVtcGxhdGU6IHsgZm9yZWFjaDogc29tZUV4cHJlc3Npb24sIGFmdGVyQWRkOiBteWZuIH0iCglrby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXSA9IHsKCSAgICBtYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yOiBmdW5jdGlvbih2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLAoJICAgICAgICAgICAgICAgIHVud3JhcHBlZFZhbHVlID0ga28udXRpbHMucGVla09ic2VydmFibGUobW9kZWxWYWx1ZSk7ICAgIC8vIFVud3JhcCB3aXRob3V0IHNldHRpbmcgYSBkZXBlbmRlbmN5IGhlcmUKCgkgICAgICAgICAgICAvLyBJZiB1bndyYXBwZWRWYWx1ZSBpcyB0aGUgYXJyYXksIHBhc3MgaW4gdGhlIHdyYXBwZWQgdmFsdWUgb24gaXRzIG93bgoJICAgICAgICAgICAgLy8gVGhlIHZhbHVlIHdpbGwgYmUgdW53cmFwcGVkIGFuZCB0cmFja2VkIHdpdGhpbiB0aGUgdGVtcGxhdGUgYmluZGluZwoJICAgICAgICAgICAgLy8gKFNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzUyMykKCSAgICAgICAgICAgIGlmICgoIXVud3JhcHBlZFZhbHVlKSB8fCB0eXBlb2YgdW53cmFwcGVkVmFsdWUubGVuZ3RoID09ICJudW1iZXIiKQoJICAgICAgICAgICAgICAgIHJldHVybiB7ICdmb3JlYWNoJzogbW9kZWxWYWx1ZSwgJ3RlbXBsYXRlRW5naW5lJzoga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UgfTsKCgkgICAgICAgICAgICAvLyBJZiB1bndyYXBwZWRWYWx1ZS5kYXRhIGlzIHRoZSBhcnJheSwgcHJlc2VydmUgYWxsIHJlbGV2YW50IG9wdGlvbnMgYW5kIHVud3JhcCBhZ2FpbiB2YWx1ZSBzbyB3ZSBnZXQgdXBkYXRlcwoJICAgICAgICAgICAga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtb2RlbFZhbHVlKTsKCSAgICAgICAgICAgIHJldHVybiB7CgkgICAgICAgICAgICAgICAgJ2ZvcmVhY2gnOiB1bndyYXBwZWRWYWx1ZVsnZGF0YSddLAoJICAgICAgICAgICAgICAgICdhcyc6IHVud3JhcHBlZFZhbHVlWydhcyddLAoJICAgICAgICAgICAgICAgICdpbmNsdWRlRGVzdHJveWVkJzogdW53cmFwcGVkVmFsdWVbJ2luY2x1ZGVEZXN0cm95ZWQnXSwKCSAgICAgICAgICAgICAgICAnYWZ0ZXJBZGQnOiB1bndyYXBwZWRWYWx1ZVsnYWZ0ZXJBZGQnXSwKCSAgICAgICAgICAgICAgICAnYmVmb3JlUmVtb3ZlJzogdW53cmFwcGVkVmFsdWVbJ2JlZm9yZVJlbW92ZSddLAoJICAgICAgICAgICAgICAgICdhZnRlclJlbmRlcic6IHVud3JhcHBlZFZhbHVlWydhZnRlclJlbmRlciddLAoJICAgICAgICAgICAgICAgICdiZWZvcmVNb3ZlJzogdW53cmFwcGVkVmFsdWVbJ2JlZm9yZU1vdmUnXSwKCSAgICAgICAgICAgICAgICAnYWZ0ZXJNb3ZlJzogdW53cmFwcGVkVmFsdWVbJ2FmdGVyTW92ZSddLAoJICAgICAgICAgICAgICAgICd0ZW1wbGF0ZUVuZ2luZSc6IGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLmluc3RhbmNlCgkgICAgICAgICAgICB9OwoJICAgICAgICB9OwoJICAgIH0sCgkgICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWydpbml0J10oZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzWydmb3JlYWNoJ10ubWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3Nvcih2YWx1ZUFjY2Vzc29yKSk7CgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1sndGVtcGxhdGUnXVsndXBkYXRlJ10oZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzWydmb3JlYWNoJ10ubWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3Nvcih2YWx1ZUFjY2Vzc29yKSwgYWxsQmluZGluZ3MsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpOwoJICAgIH0KCX07Cglrby5leHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9yc1snZm9yZWFjaCddID0gZmFsc2U7IC8vIENhbid0IHJld3JpdGUgY29udHJvbCBmbG93IGJpbmRpbmdzCglrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWydmb3JlYWNoJ10gPSB0cnVlOwoJdmFyIGhhc2ZvY3VzVXBkYXRpbmdQcm9wZXJ0eSA9ICdfX2tvX2hhc2ZvY3VzVXBkYXRpbmcnOwoJdmFyIGhhc2ZvY3VzTGFzdFZhbHVlID0gJ19fa29faGFzZm9jdXNMYXN0VmFsdWUnOwoJa28uYmluZGluZ0hhbmRsZXJzWydoYXNmb2N1cyddID0gewoJICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MpIHsKCSAgICAgICAgdmFyIGhhbmRsZUVsZW1lbnRGb2N1c0NoYW5nZSA9IGZ1bmN0aW9uKGlzRm9jdXNlZCkgewoJICAgICAgICAgICAgLy8gV2hlcmUgcG9zc2libGUsIGlnbm9yZSB3aGljaCBldmVudCB3YXMgcmFpc2VkIGFuZCBkZXRlcm1pbmUgZm9jdXMgc3RhdGUgdXNpbmcgYWN0aXZlRWxlbWVudCwKCSAgICAgICAgICAgIC8vIGFzIHRoaXMgYXZvaWRzIHBoYW50b20gZm9jdXMvYmx1ciBldmVudHMgcmFpc2VkIHdoZW4gY2hhbmdpbmcgdGFicyBpbiBtb2Rlcm4gYnJvd3NlcnMuCgkgICAgICAgICAgICAvLyBIb3dldmVyLCBub3QgYWxsIEtPLXRhcmdldGVkIGJyb3dzZXJzIChGaXJlZm94IDIpIHN1cHBvcnQgYWN0aXZlRWxlbWVudC4gRm9yIHRob3NlIGJyb3dzZXJzLAoJICAgICAgICAgICAgLy8gcHJldmVudCBhIGxvc3Mgb2YgZm9jdXMgd2hlbiBjaGFuZ2luZyB0YWJzL3dpbmRvd3MgYnkgc2V0dGluZyBhIGZsYWcgdGhhdCBwcmV2ZW50cyBoYXNmb2N1cwoJICAgICAgICAgICAgLy8gZnJvbSBjYWxsaW5nICdibHVyKCknIG9uIHRoZSBlbGVtZW50IHdoZW4gaXQgbG9zZXMgZm9jdXMuCgkgICAgICAgICAgICAvLyBEaXNjdXNzaW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9wdWxsLzM1MgoJICAgICAgICAgICAgZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldID0gdHJ1ZTsKCSAgICAgICAgICAgIHZhciBvd25lckRvYyA9IGVsZW1lbnQub3duZXJEb2N1bWVudDsKCSAgICAgICAgICAgIGlmICgiYWN0aXZlRWxlbWVudCIgaW4gb3duZXJEb2MpIHsKCSAgICAgICAgICAgICAgICB2YXIgYWN0aXZlOwoJICAgICAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgICAgIGFjdGl2ZSA9IG93bmVyRG9jLmFjdGl2ZUVsZW1lbnQ7CgkgICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIElFOSB0aHJvd3MgaWYgeW91IGFjY2VzcyBhY3RpdmVFbGVtZW50IGR1cmluZyBwYWdlIGxvYWQgKHNlZSBpc3N1ZSAjNzAzKQoJICAgICAgICAgICAgICAgICAgICBhY3RpdmUgPSBvd25lckRvYy5ib2R5OwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpc0ZvY3VzZWQgPSAoYWN0aXZlID09PSBlbGVtZW50KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpOwoJICAgICAgICAgICAga28uZXhwcmVzc2lvblJld3JpdGluZy53cml0ZVZhbHVlVG9Qcm9wZXJ0eShtb2RlbFZhbHVlLCBhbGxCaW5kaW5ncywgJ2hhc2ZvY3VzJywgaXNGb2N1c2VkLCB0cnVlKTsKCgkgICAgICAgICAgICAvL2NhY2hlIHRoZSBsYXRlc3QgdmFsdWUsIHNvIHdlIGNhbiBhdm9pZCB1bm5lY2Vzc2FyaWx5IGNhbGxpbmcgZm9jdXMvYmx1ciBpbiB0aGUgdXBkYXRlIGZ1bmN0aW9uCgkgICAgICAgICAgICBlbGVtZW50W2hhc2ZvY3VzTGFzdFZhbHVlXSA9IGlzRm9jdXNlZDsKCSAgICAgICAgICAgIGVsZW1lbnRbaGFzZm9jdXNVcGRhdGluZ1Byb3BlcnR5XSA9IGZhbHNlOwoJICAgICAgICB9OwoJICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzSW4gPSBoYW5kbGVFbGVtZW50Rm9jdXNDaGFuZ2UuYmluZChudWxsLCB0cnVlKTsKCSAgICAgICAgdmFyIGhhbmRsZUVsZW1lbnRGb2N1c091dCA9IGhhbmRsZUVsZW1lbnRGb2N1c0NoYW5nZS5iaW5kKG51bGwsIGZhbHNlKTsKCgkgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJmb2N1cyIsIGhhbmRsZUVsZW1lbnRGb2N1c0luKTsKCSAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3VzaW4iLCBoYW5kbGVFbGVtZW50Rm9jdXNJbik7IC8vIEZvciBJRQoJICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiYmx1ciIsICBoYW5kbGVFbGVtZW50Rm9jdXNPdXQpOwoJICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiZm9jdXNvdXQiLCAgaGFuZGxlRWxlbWVudEZvY3VzT3V0KTsgLy8gRm9yIElFCgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICB2YXIgdmFsdWUgPSAhIWtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsgLy9mb3JjZSBib29sZWFuIHRvIGNvbXBhcmUgd2l0aCBsYXN0IHZhbHVlCgkgICAgICAgIGlmICghZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldICYmIGVsZW1lbnRbaGFzZm9jdXNMYXN0VmFsdWVdICE9PSB2YWx1ZSkgewoJICAgICAgICAgICAgdmFsdWUgPyBlbGVtZW50LmZvY3VzKCkgOiBlbGVtZW50LmJsdXIoKTsKCSAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsIHZhbHVlID8gImZvY3VzaW4iIDogImZvY3Vzb3V0Il0pOyAvLyBGb3IgSUUsIHdoaWNoIGRvZXNuJ3QgcmVsaWFibHkgZmlyZSAiZm9jdXMiIG9yICJibHVyIiBldmVudHMgc3luY2hyb25vdXNseQoJICAgICAgICB9CgkgICAgfQoJfTsKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcudHdvV2F5QmluZGluZ3NbJ2hhc2ZvY3VzJ10gPSB0cnVlOwoKCWtvLmJpbmRpbmdIYW5kbGVyc1snaGFzRm9jdXMnXSA9IGtvLmJpbmRpbmdIYW5kbGVyc1snaGFzZm9jdXMnXTsgLy8gTWFrZSAiaGFzRm9jdXMiIGFuIGFsaWFzCglrby5leHByZXNzaW9uUmV3cml0aW5nLnR3b1dheUJpbmRpbmdzWydoYXNGb2N1cyddID0gdHJ1ZTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snaHRtbCddID0gewoJICAgICdpbml0JzogZnVuY3Rpb24oKSB7CgkgICAgICAgIC8vIFByZXZlbnQgYmluZGluZyBvbiB0aGUgZHluYW1pY2FsbHktaW5qZWN0ZWQgSFRNTCAoYXMgZGV2ZWxvcGVycyBhcmUgdW5saWtlbHkgdG8gZXhwZWN0IHRoYXQsIGFuZCBpdCBoYXMgc2VjdXJpdHkgaW1wbGljYXRpb25zKQoJICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgLy8gc2V0SHRtbCB3aWxsIHVud3JhcCB0aGUgdmFsdWUgaWYgbmVlZGVkCgkgICAgICAgIGtvLnV0aWxzLnNldEh0bWwoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcigpKTsKCSAgICB9Cgl9OwoJLy8gTWFrZXMgYSBiaW5kaW5nIGxpa2Ugd2l0aCBvciBpZgoJZnVuY3Rpb24gbWFrZVdpdGhJZkJpbmRpbmcoYmluZGluZ0tleSwgaXNXaXRoLCBpc05vdCwgbWFrZUNvbnRleHRDYWxsYmFjaykgewoJICAgIGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XSA9IHsKCSAgICAgICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAgICAgdmFyIGRpZERpc3BsYXlPbkxhc3RVcGRhdGUsCgkgICAgICAgICAgICAgICAgc2F2ZWROb2RlczsKCSAgICAgICAgICAgIGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgIHZhciBkYXRhVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSksCgkgICAgICAgICAgICAgICAgICAgIHNob3VsZERpc3BsYXkgPSAhaXNOb3QgIT09ICFkYXRhVmFsdWUsIC8vIGVxdWl2YWxlbnQgdG8gaXNOb3QgPyAhZGF0YVZhbHVlIDogISFkYXRhVmFsdWUKCSAgICAgICAgICAgICAgICAgICAgaXNGaXJzdFJlbmRlciA9ICFzYXZlZE5vZGVzLAoJICAgICAgICAgICAgICAgICAgICBuZWVkc1JlZnJlc2ggPSBpc0ZpcnN0UmVuZGVyIHx8IGlzV2l0aCB8fCAoc2hvdWxkRGlzcGxheSAhPT0gZGlkRGlzcGxheU9uTGFzdFVwZGF0ZSk7CgoJICAgICAgICAgICAgICAgIGlmIChuZWVkc1JlZnJlc2gpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gU2F2ZSBhIGNvcHkgb2YgdGhlIGlubmVyIG5vZGVzIG9uIHRoZSBpbml0aWFsIHVwZGF0ZSwgYnV0IG9ubHkgaWYgd2UgaGF2ZSBkZXBlbmRlbmNpZXMuCgkgICAgICAgICAgICAgICAgICAgIGlmIChpc0ZpcnN0UmVuZGVyICYmIGtvLmNvbXB1dGVkQ29udGV4dC5nZXREZXBlbmRlbmNpZXNDb3VudCgpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBzYXZlZE5vZGVzID0ga28udXRpbHMuY2xvbmVOb2Rlcyhrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2RlcyhlbGVtZW50KSwgdHJ1ZSAvKiBzaG91bGRDbGVhbk5vZGVzICovKTsKCSAgICAgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZERpc3BsYXkpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNGaXJzdFJlbmRlcikgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4oZWxlbWVudCwga28udXRpbHMuY2xvbmVOb2RlcyhzYXZlZE5vZGVzKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cyhtYWtlQ29udGV4dENhbGxiYWNrID8gbWFrZUNvbnRleHRDYWxsYmFjayhiaW5kaW5nQ29udGV4dCwgZGF0YVZhbHVlKSA6IGJpbmRpbmdDb250ZXh0LCBlbGVtZW50KTsKCSAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5lbXB0eU5vZGUoZWxlbWVudCk7CgkgICAgICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgICAgIGRpZERpc3BsYXlPbkxhc3RVcGRhdGUgPSBzaG91bGREaXNwbGF5OwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0sIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBlbGVtZW50IH0pOwoJICAgICAgICAgICAgcmV0dXJuIHsgJ2NvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzJzogdHJ1ZSB9OwoJICAgICAgICB9CgkgICAgfTsKCSAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9yc1tiaW5kaW5nS2V5XSA9IGZhbHNlOyAvLyBDYW4ndCByZXdyaXRlIGNvbnRyb2wgZmxvdyBiaW5kaW5ncwoJICAgIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbYmluZGluZ0tleV0gPSB0cnVlOwoJfQoKCS8vIENvbnN0cnVjdCB0aGUgYWN0dWFsIGJpbmRpbmcgaGFuZGxlcnMKCW1ha2VXaXRoSWZCaW5kaW5nKCdpZicpOwoJbWFrZVdpdGhJZkJpbmRpbmcoJ2lmbm90JywgZmFsc2UgLyogaXNXaXRoICovLCB0cnVlIC8qIGlzTm90ICovKTsKCW1ha2VXaXRoSWZCaW5kaW5nKCd3aXRoJywgdHJ1ZSAvKiBpc1dpdGggKi8sIGZhbHNlIC8qIGlzTm90ICovLAoJICAgIGZ1bmN0aW9uKGJpbmRpbmdDb250ZXh0LCBkYXRhVmFsdWUpIHsKCSAgICAgICAgcmV0dXJuIGJpbmRpbmdDb250ZXh0WydjcmVhdGVDaGlsZENvbnRleHQnXShkYXRhVmFsdWUpOwoJICAgIH0KCSk7Cgl2YXIgY2FwdGlvblBsYWNlaG9sZGVyID0ge307Cglrby5iaW5kaW5nSGFuZGxlcnNbJ29wdGlvbnMnXSA9IHsKCSAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKCSAgICAgICAgaWYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSAhPT0gInNlbGVjdCIpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIm9wdGlvbnMgYmluZGluZyBhcHBsaWVzIG9ubHkgdG8gU0VMRUNUIGVsZW1lbnRzIik7CgoJICAgICAgICAvLyBSZW1vdmUgYWxsIGV4aXN0aW5nIDxvcHRpb24+cy4KCSAgICAgICAgd2hpbGUgKGVsZW1lbnQubGVuZ3RoID4gMCkgewoJICAgICAgICAgICAgZWxlbWVudC5yZW1vdmUoMCk7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIEVuc3VyZXMgdGhhdCB0aGUgYmluZGluZyBwcm9jZXNzb3IgZG9lc24ndCB0cnkgdG8gYmluZCB0aGUgb3B0aW9ucwoJICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzKSB7CgkgICAgICAgIGZ1bmN0aW9uIHNlbGVjdGVkT3B0aW9ucygpIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy5hcnJheUZpbHRlcihlbGVtZW50Lm9wdGlvbnMsIGZ1bmN0aW9uIChub2RlKSB7IHJldHVybiBub2RlLnNlbGVjdGVkOyB9KTsKCSAgICAgICAgfQoKCSAgICAgICAgdmFyIHNlbGVjdFdhc1ByZXZpb3VzbHlFbXB0eSA9IGVsZW1lbnQubGVuZ3RoID09IDA7CgkgICAgICAgIHZhciBwcmV2aW91c1Njcm9sbFRvcCA9ICghc2VsZWN0V2FzUHJldmlvdXNseUVtcHR5ICYmIGVsZW1lbnQubXVsdGlwbGUpID8gZWxlbWVudC5zY3JvbGxUb3AgOiBudWxsOwoJICAgICAgICB2YXIgdW53cmFwcGVkQXJyYXkgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgICAgIHZhciBpbmNsdWRlRGVzdHJveWVkID0gYWxsQmluZGluZ3MuZ2V0KCdvcHRpb25zSW5jbHVkZURlc3Ryb3llZCcpOwoJICAgICAgICB2YXIgYXJyYXlUb0RvbU5vZGVDaGlsZHJlbk9wdGlvbnMgPSB7fTsKCSAgICAgICAgdmFyIGNhcHRpb25WYWx1ZTsKCSAgICAgICAgdmFyIGZpbHRlcmVkQXJyYXk7CgkgICAgICAgIHZhciBwcmV2aW91c1NlbGVjdGVkVmFsdWVzOwoKCSAgICAgICAgaWYgKGVsZW1lbnQubXVsdGlwbGUpIHsKCSAgICAgICAgICAgIHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMgPSBrby51dGlscy5hcnJheU1hcChzZWxlY3RlZE9wdGlvbnMoKSwga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgcHJldmlvdXNTZWxlY3RlZFZhbHVlcyA9IGVsZW1lbnQuc2VsZWN0ZWRJbmRleCA+PSAwID8gWyBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50Lm9wdGlvbnNbZWxlbWVudC5zZWxlY3RlZEluZGV4XSkgXSA6IFtdOwoJICAgICAgICB9CgoJICAgICAgICBpZiAodW53cmFwcGVkQXJyYXkpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgdW53cmFwcGVkQXJyYXkubGVuZ3RoID09ICJ1bmRlZmluZWQiKSAvLyBDb2VyY2Ugc2luZ2xlIHZhbHVlIGludG8gYXJyYXkKCSAgICAgICAgICAgICAgICB1bndyYXBwZWRBcnJheSA9IFt1bndyYXBwZWRBcnJheV07CgoJICAgICAgICAgICAgLy8gRmlsdGVyIG91dCBhbnkgZW50cmllcyBtYXJrZWQgYXMgZGVzdHJveWVkCgkgICAgICAgICAgICBmaWx0ZXJlZEFycmF5ID0ga28udXRpbHMuYXJyYXlGaWx0ZXIodW53cmFwcGVkQXJyYXksIGZ1bmN0aW9uKGl0ZW0pIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gaW5jbHVkZURlc3Ryb3llZCB8fCBpdGVtID09PSB1bmRlZmluZWQgfHwgaXRlbSA9PT0gbnVsbCB8fCAha28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShpdGVtWydfZGVzdHJveSddKTsKCSAgICAgICAgICAgIH0pOwoKCSAgICAgICAgICAgIC8vIElmIGNhcHRpb24gaXMgaW5jbHVkZWQsIGFkZCBpdCB0byB0aGUgYXJyYXkKCSAgICAgICAgICAgIGlmIChhbGxCaW5kaW5nc1snaGFzJ10oJ29wdGlvbnNDYXB0aW9uJykpIHsKCSAgICAgICAgICAgICAgICBjYXB0aW9uVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFsbEJpbmRpbmdzLmdldCgnb3B0aW9uc0NhcHRpb24nKSk7CgkgICAgICAgICAgICAgICAgLy8gSWYgY2FwdGlvbiB2YWx1ZSBpcyBudWxsIG9yIHVuZGVmaW5lZCwgZG9uJ3Qgc2hvdyBhIGNhcHRpb24KCSAgICAgICAgICAgICAgICBpZiAoY2FwdGlvblZhbHVlICE9PSBudWxsICYmIGNhcHRpb25WYWx1ZSAhPT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICAgICAgICAgIGZpbHRlcmVkQXJyYXkudW5zaGlmdChjYXB0aW9uUGxhY2Vob2xkZXIpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIC8vIElmIGEgZmFsc3kgdmFsdWUgaXMgcHJvdmlkZWQgKGUuZy4gbnVsbCksIHdlJ2xsIHNpbXBseSBlbXB0eSB0aGUgc2VsZWN0IGVsZW1lbnQKCSAgICAgICAgfQoKCSAgICAgICAgZnVuY3Rpb24gYXBwbHlUb09iamVjdChvYmplY3QsIHByZWRpY2F0ZSwgZGVmYXVsdFZhbHVlKSB7CgkgICAgICAgICAgICB2YXIgcHJlZGljYXRlVHlwZSA9IHR5cGVvZiBwcmVkaWNhdGU7CgkgICAgICAgICAgICBpZiAocHJlZGljYXRlVHlwZSA9PSAiZnVuY3Rpb24iKSAgICAvLyBHaXZlbiBhIGZ1bmN0aW9uOyBydW4gaXQgYWdhaW5zdCB0aGUgZGF0YSB2YWx1ZQoJICAgICAgICAgICAgICAgIHJldHVybiBwcmVkaWNhdGUob2JqZWN0KTsKCSAgICAgICAgICAgIGVsc2UgaWYgKHByZWRpY2F0ZVR5cGUgPT0gInN0cmluZyIpIC8vIEdpdmVuIGEgc3RyaW5nOyB0cmVhdCBpdCBhcyBhIHByb3BlcnR5IG5hbWUgb24gdGhlIGRhdGEgdmFsdWUKCSAgICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0W3ByZWRpY2F0ZV07CgkgICAgICAgICAgICBlbHNlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBHaXZlbiBubyBvcHRpb25zVGV4dCBhcmc7IHVzZSB0aGUgZGF0YSB2YWx1ZSBpdHNlbGYKCSAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwoJICAgICAgICB9CgoJICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9ucyBjYW4gcnVuIGF0IHR3byBkaWZmZXJlbnQgdGltZXM6CgkgICAgICAgIC8vIFRoZSBmaXJzdCBpcyB3aGVuIHRoZSB3aG9sZSBhcnJheSBpcyBiZWluZyB1cGRhdGVkIGRpcmVjdGx5IGZyb20gdGhpcyBiaW5kaW5nIGhhbmRsZXIuCgkgICAgICAgIC8vIFRoZSBzZWNvbmQgaXMgd2hlbiBhbiBvYnNlcnZhYmxlIHZhbHVlIGZvciBhIHNwZWNpZmljIGFycmF5IGVudHJ5IGlzIHVwZGF0ZWQuCgkgICAgICAgIC8vIG9sZE9wdGlvbnMgd2lsbCBiZSBlbXB0eSBpbiB0aGUgZmlyc3QgY2FzZSwgYnV0IHdpbGwgYmUgZmlsbGVkIHdpdGggdGhlIHByZXZpb3VzbHkgZ2VuZXJhdGVkIG9wdGlvbiBpbiB0aGUgc2Vjb25kLgoJICAgICAgICB2YXIgaXRlbVVwZGF0ZSA9IGZhbHNlOwoJICAgICAgICBmdW5jdGlvbiBvcHRpb25Gb3JBcnJheUl0ZW0oYXJyYXlFbnRyeSwgaW5kZXgsIG9sZE9wdGlvbnMpIHsKCSAgICAgICAgICAgIGlmIChvbGRPcHRpb25zLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMgPSBvbGRPcHRpb25zWzBdLnNlbGVjdGVkID8gWyBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShvbGRPcHRpb25zWzBdKSBdIDogW107CgkgICAgICAgICAgICAgICAgaXRlbVVwZGF0ZSA9IHRydWU7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICB2YXIgb3B0aW9uID0gZWxlbWVudC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpOwoJICAgICAgICAgICAgaWYgKGFycmF5RW50cnkgPT09IGNhcHRpb25QbGFjZWhvbGRlcikgewoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldFRleHRDb250ZW50KG9wdGlvbiwgYWxsQmluZGluZ3MuZ2V0KCdvcHRpb25zQ2FwdGlvbicpKTsKCSAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUob3B0aW9uLCB1bmRlZmluZWQpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAvLyBBcHBseSBhIHZhbHVlIHRvIHRoZSBvcHRpb24gZWxlbWVudAoJICAgICAgICAgICAgICAgIHZhciBvcHRpb25WYWx1ZSA9IGFwcGx5VG9PYmplY3QoYXJyYXlFbnRyeSwgYWxsQmluZGluZ3MuZ2V0KCdvcHRpb25zVmFsdWUnKSwgYXJyYXlFbnRyeSk7CgkgICAgICAgICAgICAgICAga28uc2VsZWN0RXh0ZW5zaW9ucy53cml0ZVZhbHVlKG9wdGlvbiwga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShvcHRpb25WYWx1ZSkpOwoKCSAgICAgICAgICAgICAgICAvLyBBcHBseSBzb21lIHRleHQgdG8gdGhlIG9wdGlvbiBlbGVtZW50CgkgICAgICAgICAgICAgICAgdmFyIG9wdGlvblRleHQgPSBhcHBseVRvT2JqZWN0KGFycmF5RW50cnksIGFsbEJpbmRpbmdzLmdldCgnb3B0aW9uc1RleHQnKSwgb3B0aW9uVmFsdWUpOwoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldFRleHRDb250ZW50KG9wdGlvbiwgb3B0aW9uVGV4dCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gW29wdGlvbl07CgkgICAgICAgIH0KCgkgICAgICAgIC8vIEJ5IHVzaW5nIGEgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrLCB3ZSBkZWxheSB0aGUgcmVtb3ZhbCB1bnRpbCBhZnRlciBuZXcgaXRlbXMgYXJlIGFkZGVkLiBUaGlzIGZpeGVzIGEgc2VsZWN0aW9uCgkgICAgICAgIC8vIHByb2JsZW0gaW4gSUU8PTggYW5kIEZpcmVmb3guIFNlZSBodHRwczovL2dpdGh1Yi5jb20va25vY2tvdXQva25vY2tvdXQvaXNzdWVzLzEyMDgKCSAgICAgICAgYXJyYXlUb0RvbU5vZGVDaGlsZHJlbk9wdGlvbnNbJ2JlZm9yZVJlbW92ZSddID0KCSAgICAgICAgICAgIGZ1bmN0aW9uIChvcHRpb24pIHsKCSAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNoaWxkKG9wdGlvbik7CgkgICAgICAgICAgICB9OwoKCSAgICAgICAgZnVuY3Rpb24gc2V0U2VsZWN0aW9uQ2FsbGJhY2soYXJyYXlFbnRyeSwgbmV3T3B0aW9ucykgewoJICAgICAgICAgICAgLy8gSUU2IGRvZXNuJ3QgbGlrZSB1cyB0byBhc3NpZ24gc2VsZWN0aW9uIHRvIE9QVElPTiBub2RlcyBiZWZvcmUgdGhleSdyZSBhZGRlZCB0byB0aGUgZG9jdW1lbnQuCgkgICAgICAgICAgICAvLyBUaGF0J3Mgd2h5IHdlIGZpcnN0IGFkZGVkIHRoZW0gd2l0aG91dCBzZWxlY3Rpb24uIE5vdyBpdCdzIHRpbWUgdG8gc2V0IHRoZSBzZWxlY3Rpb24uCgkgICAgICAgICAgICBpZiAocHJldmlvdXNTZWxlY3RlZFZhbHVlcy5sZW5ndGgpIHsKCSAgICAgICAgICAgICAgICB2YXIgaXNTZWxlY3RlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihwcmV2aW91c1NlbGVjdGVkVmFsdWVzLCBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShuZXdPcHRpb25zWzBdKSkgPj0gMDsKCSAgICAgICAgICAgICAgICBrby51dGlscy5zZXRPcHRpb25Ob2RlU2VsZWN0aW9uU3RhdGUobmV3T3B0aW9uc1swXSwgaXNTZWxlY3RlZCk7CgoJICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgb3B0aW9uIHdhcyBjaGFuZ2VkIGZyb20gYmVpbmcgc2VsZWN0ZWQgZHVyaW5nIGEgc2luZ2xlLWl0ZW0gdXBkYXRlLCBub3RpZnkgdGhlIGNoYW5nZQoJICAgICAgICAgICAgICAgIGlmIChpdGVtVXBkYXRlICYmICFpc1NlbGVjdGVkKQoJICAgICAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZShrby51dGlscy50cmlnZ2VyRXZlbnQsIG51bGwsIFtlbGVtZW50LCAiY2hhbmdlIl0pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICB2YXIgY2FsbGJhY2sgPSBzZXRTZWxlY3Rpb25DYWxsYmFjazsKCSAgICAgICAgaWYgKGFsbEJpbmRpbmdzWydoYXMnXSgnb3B0aW9uc0FmdGVyUmVuZGVyJykpIHsKCSAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oYXJyYXlFbnRyeSwgbmV3T3B0aW9ucykgewoJICAgICAgICAgICAgICAgIHNldFNlbGVjdGlvbkNhbGxiYWNrKGFycmF5RW50cnksIG5ld09wdGlvbnMpOwoJICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGFsbEJpbmRpbmdzLmdldCgnb3B0aW9uc0FmdGVyUmVuZGVyJyksIG51bGwsIFtuZXdPcHRpb25zWzBdLCBhcnJheUVudHJ5ICE9PSBjYXB0aW9uUGxhY2Vob2xkZXIgPyBhcnJheUVudHJ5IDogdW5kZWZpbmVkXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcoZWxlbWVudCwgZmlsdGVyZWRBcnJheSwgb3B0aW9uRm9yQXJyYXlJdGVtLCBhcnJheVRvRG9tTm9kZUNoaWxkcmVuT3B0aW9ucywgY2FsbGJhY2spOwoKCSAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgaWYgKGFsbEJpbmRpbmdzLmdldCgndmFsdWVBbGxvd1Vuc2V0JykgJiYgYWxsQmluZGluZ3NbJ2hhcyddKCd2YWx1ZScpKSB7CgkgICAgICAgICAgICAgICAgLy8gVGhlIG1vZGVsIHZhbHVlIGlzIGF1dGhvcml0YXRpdmUsIHNvIG1ha2Ugc3VyZSBpdHMgdmFsdWUgaXMgdGhlIG9uZSBzZWxlY3RlZAoJICAgICAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFsbEJpbmRpbmdzLmdldCgndmFsdWUnKSksIHRydWUgLyogYWxsb3dVbnNldCAqLyk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBpZiB0aGUgc2VsZWN0aW9uIGhhcyBjaGFuZ2VkIGFzIGEgcmVzdWx0IG9mIHVwZGF0aW5nIHRoZSBvcHRpb25zIGxpc3QKCSAgICAgICAgICAgICAgICB2YXIgc2VsZWN0aW9uQ2hhbmdlZDsKCSAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5tdWx0aXBsZSkgewoJICAgICAgICAgICAgICAgICAgICAvLyBGb3IgYSBtdWx0aXBsZS1zZWxlY3QgYm94LCBjb21wYXJlIHRoZSBuZXcgc2VsZWN0aW9uIGNvdW50IHRvIHRoZSBwcmV2aW91cyBvbmUKCSAgICAgICAgICAgICAgICAgICAgLy8gQnV0IGlmIG5vdGhpbmcgd2FzIHNlbGVjdGVkIGJlZm9yZSwgdGhlIHNlbGVjdGlvbiBjYW4ndCBoYXZlIGNoYW5nZWQKCSAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uQ2hhbmdlZCA9IHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMubGVuZ3RoICYmIHNlbGVjdGVkT3B0aW9ucygpLmxlbmd0aCA8IHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMubGVuZ3RoOwoJICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEZvciBhIHNpbmdsZS1zZWxlY3QgYm94LCBjb21wYXJlIHRoZSBjdXJyZW50IHZhbHVlIHRvIHRoZSBwcmV2aW91cyB2YWx1ZQoJICAgICAgICAgICAgICAgICAgICAvLyBCdXQgaWYgbm90aGluZyB3YXMgc2VsZWN0ZWQgYmVmb3JlIG9yIG5vdGhpbmcgaXMgc2VsZWN0ZWQgbm93LCBqdXN0IGxvb2sgZm9yIGEgY2hhbmdlIGluIHNlbGVjdGlvbgoJICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb25DaGFuZ2VkID0gKHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMubGVuZ3RoICYmIGVsZW1lbnQuc2VsZWN0ZWRJbmRleCA+PSAwKQoJICAgICAgICAgICAgICAgICAgICAgICAgPyAoa28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudC5vcHRpb25zW2VsZW1lbnQuc2VsZWN0ZWRJbmRleF0pICE9PSBwcmV2aW91c1NlbGVjdGVkVmFsdWVzWzBdKQoJICAgICAgICAgICAgICAgICAgICAgICAgOiAocHJldmlvdXNTZWxlY3RlZFZhbHVlcy5sZW5ndGggfHwgZWxlbWVudC5zZWxlY3RlZEluZGV4ID49IDApOwoJICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgLy8gRW5zdXJlIGNvbnNpc3RlbmN5IGJldHdlZW4gbW9kZWwgdmFsdWUgYW5kIHNlbGVjdGVkIG9wdGlvbi4KCSAgICAgICAgICAgICAgICAvLyBJZiB0aGUgZHJvcGRvd24gd2FzIGNoYW5nZWQgc28gdGhhdCBzZWxlY3Rpb24gaXMgbm8gbG9uZ2VyIHRoZSBzYW1lLAoJICAgICAgICAgICAgICAgIC8vIG5vdGlmeSB0aGUgdmFsdWUgb3Igc2VsZWN0ZWRPcHRpb25zIGJpbmRpbmcuCgkgICAgICAgICAgICAgICAgaWYgKHNlbGVjdGlvbkNoYW5nZWQpIHsKCSAgICAgICAgICAgICAgICAgICAga28udXRpbHMudHJpZ2dlckV2ZW50KGVsZW1lbnQsICJjaGFuZ2UiKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoKCSAgICAgICAgLy8gV29ya2Fyb3VuZCBmb3IgSUUgYnVnCgkgICAgICAgIGtvLnV0aWxzLmVuc3VyZVNlbGVjdEVsZW1lbnRJc1JlbmRlcmVkQ29ycmVjdGx5KGVsZW1lbnQpOwoKCSAgICAgICAgaWYgKHByZXZpb3VzU2Nyb2xsVG9wICYmIE1hdGguYWJzKHByZXZpb3VzU2Nyb2xsVG9wIC0gZWxlbWVudC5zY3JvbGxUb3ApID4gMjApCgkgICAgICAgICAgICBlbGVtZW50LnNjcm9sbFRvcCA9IHByZXZpb3VzU2Nyb2xsVG9wOwoJICAgIH0KCX07Cglrby5iaW5kaW5nSGFuZGxlcnNbJ29wdGlvbnMnXS5vcHRpb25WYWx1ZURvbURhdGFLZXkgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snc2VsZWN0ZWRPcHRpb25zJ10gPSB7CgkgICAgJ2FmdGVyJzogWydvcHRpb25zJywgJ2ZvcmVhY2gnXSwKCSAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncykgewoJICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiY2hhbmdlIiwgZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgdmFyIHZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLCB2YWx1ZVRvV3JpdGUgPSBbXTsKCSAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJvcHRpb24iKSwgZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgICAgIGlmIChub2RlLnNlbGVjdGVkKQoJICAgICAgICAgICAgICAgICAgICB2YWx1ZVRvV3JpdGUucHVzaChrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShub2RlKSk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkodmFsdWUsIGFsbEJpbmRpbmdzLCAnc2VsZWN0ZWRPcHRpb25zJywgdmFsdWVUb1dyaXRlKTsKCSAgICAgICAgfSk7CgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgaWYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSAhPSAic2VsZWN0IikKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidmFsdWVzIGJpbmRpbmcgYXBwbGllcyBvbmx5IHRvIFNFTEVDVCBlbGVtZW50cyIpOwoKCSAgICAgICAgdmFyIG5ld1ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwoJICAgICAgICBpZiAobmV3VmFsdWUgJiYgdHlwZW9mIG5ld1ZhbHVlLmxlbmd0aCA9PSAibnVtYmVyIikgewoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9wdGlvbiIpLCBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAgICAgdmFyIGlzU2VsZWN0ZWQgPSBrby51dGlscy5hcnJheUluZGV4T2YobmV3VmFsdWUsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKG5vZGUpKSA+PSAwOwoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZShub2RlLCBpc1NlbGVjdGVkKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9CgkgICAgfQoJfTsKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcudHdvV2F5QmluZGluZ3NbJ3NlbGVjdGVkT3B0aW9ucyddID0gdHJ1ZTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snc3R5bGUnXSA9IHsKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkgfHwge30pOwoJICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKHZhbHVlLCBmdW5jdGlvbihzdHlsZU5hbWUsIHN0eWxlVmFsdWUpIHsKCSAgICAgICAgICAgIHN0eWxlVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHN0eWxlVmFsdWUpOwoKCSAgICAgICAgICAgIGlmIChzdHlsZVZhbHVlID09PSBudWxsIHx8IHN0eWxlVmFsdWUgPT09IHVuZGVmaW5lZCB8fCBzdHlsZVZhbHVlID09PSBmYWxzZSkgewoJICAgICAgICAgICAgICAgIC8vIEVtcHR5IHN0cmluZyByZW1vdmVzIHRoZSB2YWx1ZSwgd2hlcmVhcyBudWxsL3VuZGVmaW5lZCBoYXZlIG5vIGVmZmVjdAoJICAgICAgICAgICAgICAgIHN0eWxlVmFsdWUgPSAiIjsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICBlbGVtZW50LnN0eWxlW3N0eWxlTmFtZV0gPSBzdHlsZVZhbHVlOwoJICAgICAgICB9KTsKCSAgICB9Cgl9OwoJa28uYmluZGluZ0hhbmRsZXJzWydzdWJtaXQnXSA9IHsKCSAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICBpZiAodHlwZW9mIHZhbHVlQWNjZXNzb3IoKSAhPSAiZnVuY3Rpb24iKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgdmFsdWUgZm9yIGEgc3VibWl0IGJpbmRpbmcgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CgkgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJzdWJtaXQiLCBmdW5jdGlvbiAoZXZlbnQpIHsKCSAgICAgICAgICAgIHZhciBoYW5kbGVyUmV0dXJuVmFsdWU7CgkgICAgICAgICAgICB2YXIgdmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CgkgICAgICAgICAgICB0cnkgeyBoYW5kbGVyUmV0dXJuVmFsdWUgPSB2YWx1ZS5jYWxsKGJpbmRpbmdDb250ZXh0WyckZGF0YSddLCBlbGVtZW50KTsgfQoJICAgICAgICAgICAgZmluYWxseSB7CgkgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXJSZXR1cm5WYWx1ZSAhPT0gdHJ1ZSkgeyAvLyBOb3JtYWxseSB3ZSB3YW50IHRvIHByZXZlbnQgZGVmYXVsdCBhY3Rpb24uIERldmVsb3BlciBjYW4gb3ZlcnJpZGUgdGhpcyBiZSBleHBsaWNpdGx5IHJldHVybmluZyB0cnVlLgoJICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpCgkgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJICAgICAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgfQoJfTsKCWtvLmJpbmRpbmdIYW5kbGVyc1sndGV4dCddID0gewoJICAgICdpbml0JzogZnVuY3Rpb24oKSB7CgkgICAgICAgIC8vIFByZXZlbnQgYmluZGluZyBvbiB0aGUgZHluYW1pY2FsbHktaW5qZWN0ZWQgdGV4dCBub2RlIChhcyBkZXZlbG9wZXJzIGFyZSB1bmxpa2VseSB0byBleHBlY3QgdGhhdCwgYW5kIGl0IGhhcyBzZWN1cml0eSBpbXBsaWNhdGlvbnMpLgoJICAgICAgICAvLyBJdCBzaG91bGQgYWxzbyBtYWtlIHRoaW5ncyBmYXN0ZXIsIGFzIHdlIG5vIGxvbmdlciBoYXZlIHRvIGNvbnNpZGVyIHdoZXRoZXIgdGhlIHRleHQgbm9kZSBtaWdodCBiZSBiaW5kYWJsZS4KCSAgICAgICAgcmV0dXJuIHsgJ2NvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzJzogdHJ1ZSB9OwoJICAgIH0sCgkgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIGtvLnV0aWxzLnNldFRleHRDb250ZW50KGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgfQoJfTsKCWtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbJ3RleHQnXSA9IHRydWU7CgkoZnVuY3Rpb24gKCkgewoKCWlmICh3aW5kb3cgJiYgd2luZG93Lm5hdmlnYXRvcikgewoJICAgIHZhciBwYXJzZVZlcnNpb24gPSBmdW5jdGlvbiAobWF0Y2hlcykgewoJICAgICAgICBpZiAobWF0Y2hlcykgewoJICAgICAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQobWF0Y2hlc1sxXSk7CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICAvLyBEZXRlY3QgdmFyaW91cyBicm93c2VyIHZlcnNpb25zIGJlY2F1c2Ugc29tZSBvbGQgdmVyc2lvbnMgZG9uJ3QgZnVsbHkgc3VwcG9ydCB0aGUgJ2lucHV0JyBldmVudAoJICAgIHZhciBvcGVyYVZlcnNpb24gPSB3aW5kb3cub3BlcmEgJiYgd2luZG93Lm9wZXJhLnZlcnNpb24gJiYgcGFyc2VJbnQod2luZG93Lm9wZXJhLnZlcnNpb24oKSksCgkgICAgICAgIHVzZXJBZ2VudCA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LAoJICAgICAgICBzYWZhcmlWZXJzaW9uID0gcGFyc2VWZXJzaW9uKHVzZXJBZ2VudC5tYXRjaCgvXig/Oig/IWNocm9tZSkuKSp2ZXJzaW9uXC8oW14gXSopIHNhZmFyaS9pKSksCgkgICAgICAgIGZpcmVmb3hWZXJzaW9uID0gcGFyc2VWZXJzaW9uKHVzZXJBZ2VudC5tYXRjaCgvRmlyZWZveFwvKFteIF0qKS8pKTsKCX0KCgkvLyBJRSA4IGFuZCA5IGhhdmUgYnVncyB0aGF0IHByZXZlbnQgdGhlIG5vcm1hbCBldmVudHMgZnJvbSBmaXJpbmcgd2hlbiB0aGUgdmFsdWUgY2hhbmdlcy4KCS8vIEJ1dCBpdCBkb2VzIGZpcmUgdGhlICdzZWxlY3Rpb25jaGFuZ2UnIGV2ZW50IG9uIG1hbnkgb2YgdGhvc2UsIHByZXN1bWFibHkgYmVjYXVzZSB0aGUKCS8vIGN1cnNvciBpcyBtb3ZpbmcgYW5kIHRoYXQgY291bnRzIGFzIHRoZSBzZWxlY3Rpb24gY2hhbmdpbmcuIFRoZSAnc2VsZWN0aW9uY2hhbmdlJyBldmVudCBpcwoJLy8gZmlyZWQgYXQgdGhlIGRvY3VtZW50IGxldmVsIG9ubHkgYW5kIGRvZXNuJ3QgZGlyZWN0bHkgaW5kaWNhdGUgd2hpY2ggZWxlbWVudCBjaGFuZ2VkLiBXZQoJLy8gc2V0IHVwIGp1c3Qgb25lIGV2ZW50IGhhbmRsZXIgZm9yIHRoZSBkb2N1bWVudCBhbmQgdXNlICdhY3RpdmVFbGVtZW50JyB0byBkZXRlcm1pbmUgd2hpY2gKCS8vIGVsZW1lbnQgd2FzIGNoYW5nZWQuCglpZiAoa28udXRpbHMuaWVWZXJzaW9uIDwgMTApIHsKCSAgICB2YXIgc2VsZWN0aW9uQ2hhbmdlUmVnaXN0ZXJlZE5hbWUgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKSwKCSAgICAgICAgc2VsZWN0aW9uQ2hhbmdlSGFuZGxlck5hbWUgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCSAgICB2YXIgc2VsZWN0aW9uQ2hhbmdlSGFuZGxlciA9IGZ1bmN0aW9uKGV2ZW50KSB7CgkgICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLmFjdGl2ZUVsZW1lbnQsCgkgICAgICAgICAgICBoYW5kbGVyID0gdGFyZ2V0ICYmIGtvLnV0aWxzLmRvbURhdGEuZ2V0KHRhcmdldCwgc2VsZWN0aW9uQ2hhbmdlSGFuZGxlck5hbWUpOwoJICAgICAgICBpZiAoaGFuZGxlcikgewoJICAgICAgICAgICAgaGFuZGxlcihldmVudCk7CgkgICAgICAgIH0KCSAgICB9OwoJICAgIHZhciByZWdpc3RlckZvclNlbGVjdGlvbkNoYW5nZUV2ZW50ID0gZnVuY3Rpb24gKGVsZW1lbnQsIGhhbmRsZXIpIHsKCSAgICAgICAgdmFyIG93bmVyRG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50OwoJICAgICAgICBpZiAoIWtvLnV0aWxzLmRvbURhdGEuZ2V0KG93bmVyRG9jLCBzZWxlY3Rpb25DaGFuZ2VSZWdpc3RlcmVkTmFtZSkpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG93bmVyRG9jLCBzZWxlY3Rpb25DaGFuZ2VSZWdpc3RlcmVkTmFtZSwgdHJ1ZSk7CgkgICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihvd25lckRvYywgJ3NlbGVjdGlvbmNoYW5nZScsIHNlbGVjdGlvbkNoYW5nZUhhbmRsZXIpOwoJICAgICAgICB9CgkgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIHNlbGVjdGlvbkNoYW5nZUhhbmRsZXJOYW1lLCBoYW5kbGVyKTsKCSAgICB9OwoJfQoKCWtvLmJpbmRpbmdIYW5kbGVyc1sndGV4dElucHV0J10gPSB7CgkgICAgJ2luaXQnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MpIHsKCgkgICAgICAgIHZhciBwcmV2aW91c0VsZW1lbnRWYWx1ZSA9IGVsZW1lbnQudmFsdWUsCgkgICAgICAgICAgICB0aW1lb3V0SGFuZGxlLAoJICAgICAgICAgICAgZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQ7CgoJICAgICAgICB2YXIgdXBkYXRlTW9kZWwgPSBmdW5jdGlvbiAoZXZlbnQpIHsKCSAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SGFuZGxlKTsKCSAgICAgICAgICAgIGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50ID0gdGltZW91dEhhbmRsZSA9IHVuZGVmaW5lZDsKCgkgICAgICAgICAgICB2YXIgZWxlbWVudFZhbHVlID0gZWxlbWVudC52YWx1ZTsKCSAgICAgICAgICAgIGlmIChwcmV2aW91c0VsZW1lbnRWYWx1ZSAhPT0gZWxlbWVudFZhbHVlKSB7CgkgICAgICAgICAgICAgICAgLy8gUHJvdmlkZSBhIHdheSBmb3IgdGVzdHMgdG8ga25vdyBleGFjdGx5IHdoaWNoIGV2ZW50IHdhcyBwcm9jZXNzZWQKCSAgICAgICAgICAgICAgICBpZiAoREVCVUcgJiYgZXZlbnQpIGVsZW1lbnRbJ19rb190ZXh0SW5wdXRQcm9jZXNzZWRFdmVudCddID0gZXZlbnQudHlwZTsKCSAgICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnRWYWx1ZSA9IGVsZW1lbnRWYWx1ZTsKCSAgICAgICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KHZhbHVlQWNjZXNzb3IoKSwgYWxsQmluZGluZ3MsICd0ZXh0SW5wdXQnLCBlbGVtZW50VmFsdWUpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9OwoKCSAgICAgICAgdmFyIGRlZmVyVXBkYXRlTW9kZWwgPSBmdW5jdGlvbiAoZXZlbnQpIHsKCSAgICAgICAgICAgIGlmICghdGltZW91dEhhbmRsZSkgewoJICAgICAgICAgICAgICAgIC8vIFRoZSBlbGVtZW50VmFsdWVCZWZvcmVFdmVudCB2YXJpYWJsZSBpcyBzZXQgKm9ubHkqIGR1cmluZyB0aGUgYnJpZWYgZ2FwIGJldHdlZW4gYW4KCSAgICAgICAgICAgICAgICAvLyBldmVudCBmaXJpbmcgYW5kIHRoZSB1cGRhdGVNb2RlbCBmdW5jdGlvbiBydW5uaW5nLiBUaGlzIGFsbG93cyB1cyB0byBpZ25vcmUgbW9kZWwKCSAgICAgICAgICAgICAgICAvLyB1cGRhdGVzIHRoYXQgYXJlIGZyb20gdGhlIHByZXZpb3VzIHN0YXRlIG9mIHRoZSBlbGVtZW50LCB1c3VhbGx5IGR1ZSB0byB0ZWNobmlxdWVzCgkgICAgICAgICAgICAgICAgLy8gc3VjaCBhcyByYXRlTGltaXQuIFN1Y2ggdXBkYXRlcywgaWYgbm90IGlnbm9yZWQsIGNhbiBjYXVzZSBrZXlzdHJva2VzIHRvIGJlIGxvc3QuCgkgICAgICAgICAgICAgICAgZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQgPSBlbGVtZW50LnZhbHVlOwoJICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyID0gREVCVUcgPyB1cGRhdGVNb2RlbC5iaW5kKGVsZW1lbnQsIHt0eXBlOiBldmVudC50eXBlfSkgOiB1cGRhdGVNb2RlbDsKCSAgICAgICAgICAgICAgICB0aW1lb3V0SGFuZGxlID0gc2V0VGltZW91dChoYW5kbGVyLCA0KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfTsKCgkgICAgICAgIHZhciB1cGRhdGVWaWV3ID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgoJICAgICAgICAgICAgaWYgKG1vZGVsVmFsdWUgPT09IG51bGwgfHwgbW9kZWxWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICAgICAgbW9kZWxWYWx1ZSA9ICcnOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIGlmIChlbGVtZW50VmFsdWVCZWZvcmVFdmVudCAhPT0gdW5kZWZpbmVkICYmIG1vZGVsVmFsdWUgPT09IGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50KSB7CgkgICAgICAgICAgICAgICAgc2V0VGltZW91dCh1cGRhdGVWaWV3LCA0KTsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBlbGVtZW50IG9ubHkgaWYgdGhlIGVsZW1lbnQgYW5kIG1vZGVsIGFyZSBkaWZmZXJlbnQuIE9uIHNvbWUgYnJvd3NlcnMsIHVwZGF0aW5nIHRoZSB2YWx1ZQoJICAgICAgICAgICAgLy8gd2lsbCBtb3ZlIHRoZSBjdXJzb3IgdG8gdGhlIGVuZCBvZiB0aGUgaW5wdXQsIHdoaWNoIHdvdWxkIGJlIGJhZCB3aGlsZSB0aGUgdXNlciBpcyB0eXBpbmcuCgkgICAgICAgICAgICBpZiAoZWxlbWVudC52YWx1ZSAhPT0gbW9kZWxWYWx1ZSkgewoJICAgICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudFZhbHVlID0gbW9kZWxWYWx1ZTsgIC8vIE1ha2Ugc3VyZSB3ZSBpZ25vcmUgZXZlbnRzIChwcm9wZXJ0eWNoYW5nZSkgdGhhdCByZXN1bHQgZnJvbSB1cGRhdGluZyB0aGUgdmFsdWUKCSAgICAgICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gbW9kZWxWYWx1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfTsKCgkgICAgICAgIHZhciBvbkV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50LCBoYW5kbGVyKSB7CgkgICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudCwgaGFuZGxlcik7CgkgICAgICAgIH07CgoJICAgICAgICBpZiAoREVCVUcgJiYga28uYmluZGluZ0hhbmRsZXJzWyd0ZXh0SW5wdXQnXVsnX2ZvcmNlVXBkYXRlT24nXSkgewoJICAgICAgICAgICAgLy8gUHJvdmlkZSBhIHdheSBmb3IgdGVzdHMgdG8gc3BlY2lmeSBleGFjdGx5IHdoaWNoIGV2ZW50cyBhcmUgYm91bmQKCSAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChrby5iaW5kaW5nSGFuZGxlcnNbJ3RleHRJbnB1dCddWydfZm9yY2VVcGRhdGVPbiddLCBmdW5jdGlvbihldmVudE5hbWUpIHsKCSAgICAgICAgICAgICAgICBpZiAoZXZlbnROYW1lLnNsaWNlKDAsNSkgPT0gJ2FmdGVyJykgewoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KGV2ZW50TmFtZS5zbGljZSg1KSwgZGVmZXJVcGRhdGVNb2RlbCk7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgb25FdmVudChldmVudE5hbWUsIHVwZGF0ZU1vZGVsKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGlmIChrby51dGlscy5pZVZlcnNpb24gPCAxMCkgewoJICAgICAgICAgICAgICAgIC8vIEludGVybmV0IEV4cGxvcmVyIDw9IDggZG9lc24ndCBzdXBwb3J0IHRoZSAnaW5wdXQnIGV2ZW50LCBidXQgZG9lcyBpbmNsdWRlICdwcm9wZXJ0eWNoYW5nZScgdGhhdCBmaXJlcyB3aGVuZXZlcgoJICAgICAgICAgICAgICAgIC8vIGFueSBwcm9wZXJ0eSBvZiBhbiBlbGVtZW50IGNoYW5nZXMuIFVubGlrZSAnaW5wdXQnLCBpdCBhbHNvIGZpcmVzIGlmIGEgcHJvcGVydHkgaXMgY2hhbmdlZCBmcm9tIEphdmFTY3JpcHQgY29kZSwKCSAgICAgICAgICAgICAgICAvLyBidXQgdGhhdCdzIGFuIGFjY2VwdGFibGUgY29tcHJvbWlzZSBmb3IgdGhpcyBiaW5kaW5nLiBJRSA5IGRvZXMgc3VwcG9ydCAnaW5wdXQnLCBidXQgc2luY2UgaXQgZG9lc24ndCBmaXJlIGl0CgkgICAgICAgICAgICAgICAgLy8gd2hlbiB1c2luZyBhdXRvY29tcGxldGUsIHdlJ2xsIHVzZSAncHJvcGVydHljaGFuZ2UnIGZvciBpdCBhbHNvLgoJICAgICAgICAgICAgICAgIG9uRXZlbnQoJ3Byb3BlcnR5Y2hhbmdlJywgZnVuY3Rpb24oZXZlbnQpIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3ZhbHVlJykgewoJICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlTW9kZWwoZXZlbnQpOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfSk7CgoJICAgICAgICAgICAgICAgIGlmIChrby51dGlscy5pZVZlcnNpb24gPT0gOCkgewoJICAgICAgICAgICAgICAgICAgICAvLyBJRSA4IGhhcyBhIGJ1ZyB3aGVyZSBpdCBmYWlscyB0byBmaXJlICdwcm9wZXJ0eWNoYW5nZScgb24gdGhlIGZpcnN0IHVwZGF0ZSBmb2xsb3dpbmcgYSB2YWx1ZSBjaGFuZ2UgZnJvbQoJICAgICAgICAgICAgICAgICAgICAvLyBKYXZhU2NyaXB0IGNvZGUuIEl0IGFsc28gZG9lc24ndCBmaXJlIGlmIHlvdSBjbGVhciB0aGUgZW50aXJlIHZhbHVlLiBUbyBmaXggdGhpcywgd2UgYmluZCB0byB0aGUgZm9sbG93aW5nCgkgICAgICAgICAgICAgICAgICAgIC8vIGV2ZW50cyB0b28uCgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2tleXVwJywgdXBkYXRlTW9kZWwpOyAgICAgIC8vIEEgc2luZ2xlIGtleXN0b2tlCgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2tleWRvd24nLCB1cGRhdGVNb2RlbCk7ICAgIC8vIFRoZSBmaXJzdCBjaGFyYWN0ZXIgd2hlbiBhIGtleSBpcyBoZWxkIGRvd24KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmllVmVyc2lvbiA+PSA4KSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEludGVybmV0IEV4cGxvcmVyIDkgZG9lc24ndCBmaXJlIHRoZSAnaW5wdXQnIGV2ZW50IHdoZW4gZGVsZXRpbmcgdGV4dCwgaW5jbHVkaW5nIHVzaW5nCgkgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBiYWNrc3BhY2UsIGRlbGV0ZSwgb3IgY3RybC14IGtleXMsIGNsaWNraW5nIHRoZSAneCcgdG8gY2xlYXIgdGhlIGlucHV0LCBkcmFnZ2luZyB0ZXh0CgkgICAgICAgICAgICAgICAgICAgIC8vIG91dCBvZiB0aGUgZmllbGQsIGFuZCBjdXR0aW5nIG9yIGRlbGV0aW5nIHRleHQgdXNpbmcgdGhlIGNvbnRleHQgbWVudS4gJ3NlbGVjdGlvbmNoYW5nZScKCSAgICAgICAgICAgICAgICAgICAgLy8gY2FuIGRldGVjdCBhbGwgb2YgdGhvc2UgZXhjZXB0IGRyYWdnaW5nIHRleHQgb3V0IG9mIHRoZSBmaWVsZCwgZm9yIHdoaWNoIHdlIHVzZSAnZHJhZ2VuZCcuCgkgICAgICAgICAgICAgICAgICAgIC8vIFRoZXNlIGFyZSBhbHNvIG5lZWRlZCBpbiBJRTggYmVjYXVzZSBvZiB0aGUgYnVnIGRlc2NyaWJlZCBhYm92ZS4KCSAgICAgICAgICAgICAgICAgICAgcmVnaXN0ZXJGb3JTZWxlY3Rpb25DaGFuZ2VFdmVudChlbGVtZW50LCB1cGRhdGVNb2RlbCk7ICAvLyAnc2VsZWN0aW9uY2hhbmdlJyBjb3ZlcnMgY3V0LCBwYXN0ZSwgZHJvcCwgZGVsZXRlLCBldGMuCgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2RyYWdlbmQnLCBkZWZlclVwZGF0ZU1vZGVsKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIEFsbCBvdGhlciBzdXBwb3J0ZWQgYnJvd3NlcnMgc3VwcG9ydCB0aGUgJ2lucHV0JyBldmVudCwgd2hpY2ggZmlyZXMgd2hlbmV2ZXIgdGhlIGNvbnRlbnQgb2YgdGhlIGVsZW1lbnQgaXMgY2hhbmdlZAoJICAgICAgICAgICAgICAgIC8vIHRocm91Z2ggdGhlIHVzZXIgaW50ZXJmYWNlLgoJICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2lucHV0JywgdXBkYXRlTW9kZWwpOwoKCSAgICAgICAgICAgICAgICBpZiAoc2FmYXJpVmVyc2lvbiA8IDUgJiYga28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnQpID09PSAidGV4dGFyZWEiKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIFNhZmFyaSA8NSBkb2Vzbid0IGZpcmUgdGhlICdpbnB1dCcgZXZlbnQgZm9yIDx0ZXh0YXJlYT4gZWxlbWVudHMgKGl0IGRvZXMgZmlyZSAndGV4dElucHV0JwoJICAgICAgICAgICAgICAgICAgICAvLyBidXQgb25seSB3aGVuIHR5cGluZykuIFNvIHdlJ2xsIGp1c3QgY2F0Y2ggYXMgbXVjaCBhcyB3ZSBjYW4gd2l0aCBrZXlkb3duLCBjdXQsIGFuZCBwYXN0ZS4KCSAgICAgICAgICAgICAgICAgICAgb25FdmVudCgna2V5ZG93bicsIGRlZmVyVXBkYXRlTW9kZWwpOwoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KCdwYXN0ZScsIGRlZmVyVXBkYXRlTW9kZWwpOwoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KCdjdXQnLCBkZWZlclVwZGF0ZU1vZGVsKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhVmVyc2lvbiA8IDExKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIE9wZXJhIDEwIGRvZXNuJ3QgYWx3YXlzIGZpcmUgdGhlICdpbnB1dCcgZXZlbnQgZm9yIGN1dCwgcGFzdGUsIHVuZG8gJiBkcm9wIG9wZXJhdGlvbnMuCgkgICAgICAgICAgICAgICAgICAgIC8vIFdlIGNhbiB0cnkgdG8gY2F0Y2ggc29tZSBvZiB0aG9zZSB1c2luZyAna2V5ZG93bicuCgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2tleWRvd24nLCBkZWZlclVwZGF0ZU1vZGVsKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZpcmVmb3hWZXJzaW9uIDwgNC4wKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEZpcmVmb3ggPD0gMy42IGRvZXNuJ3QgZmlyZSB0aGUgJ2lucHV0JyBldmVudCB3aGVuIHRleHQgaXMgZmlsbGVkIGluIHRocm91Z2ggYXV0b2NvbXBsZXRlCgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ0RPTUF1dG9Db21wbGV0ZScsIHVwZGF0ZU1vZGVsKTsKCgkgICAgICAgICAgICAgICAgICAgIC8vIEZpcmVmb3ggPD0zLjUgZG9lc24ndCBmaXJlIHRoZSAnaW5wdXQnIGV2ZW50IHdoZW4gdGV4dCBpcyBkcm9wcGVkIGludG8gdGhlIGlucHV0LgoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KCdkcmFnZHJvcCcsIHVwZGF0ZU1vZGVsKTsgICAgICAgLy8gPDMuNQoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KCdkcm9wJywgdXBkYXRlTW9kZWwpOyAgICAgICAgICAgLy8gMy41CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICAvLyBCaW5kIHRvIHRoZSBjaGFuZ2UgZXZlbnQgc28gdGhhdCB3ZSBjYW4gY2F0Y2ggcHJvZ3JhbW1hdGljIHVwZGF0ZXMgb2YgdGhlIHZhbHVlIHRoYXQgZmlyZSB0aGlzIGV2ZW50LgoJICAgICAgICBvbkV2ZW50KCdjaGFuZ2UnLCB1cGRhdGVNb2RlbCk7CgoJICAgICAgICBrby5jb21wdXRlZCh1cGRhdGVWaWV3LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogZWxlbWVudCB9KTsKCSAgICB9Cgl9OwoJa28uZXhwcmVzc2lvblJld3JpdGluZy50d29XYXlCaW5kaW5nc1sndGV4dElucHV0J10gPSB0cnVlOwoKCS8vIHRleHRpbnB1dCBpcyBhbiBhbGlhcyBmb3IgdGV4dElucHV0Cglrby5iaW5kaW5nSGFuZGxlcnNbJ3RleHRpbnB1dCddID0gewoJICAgIC8vIHByZXByb2Nlc3MgaXMgdGhlIG9ubHkgd2F5IHRvIHNldCB1cCBhIGZ1bGwgYWxpYXMKCSAgICAncHJlcHJvY2Vzcyc6IGZ1bmN0aW9uICh2YWx1ZSwgbmFtZSwgYWRkQmluZGluZykgewoJICAgICAgICBhZGRCaW5kaW5nKCd0ZXh0SW5wdXQnLCB2YWx1ZSk7CgkgICAgfQoJfTsKCgl9KSgpO2tvLmJpbmRpbmdIYW5kbGVyc1sndW5pcXVlTmFtZSddID0gewoJICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgaWYgKHZhbHVlQWNjZXNzb3IoKSkgewoJICAgICAgICAgICAgdmFyIG5hbWUgPSAia29fdW5pcXVlXyIgKyAoKytrby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXS5jdXJyZW50SW5kZXgpOwoJICAgICAgICAgICAga28udXRpbHMuc2V0RWxlbWVudE5hbWUoZWxlbWVudCwgbmFtZSk7CgkgICAgICAgIH0KCSAgICB9Cgl9OwoJa28uYmluZGluZ0hhbmRsZXJzWyd1bmlxdWVOYW1lJ10uY3VycmVudEluZGV4ID0gMDsKCWtvLmJpbmRpbmdIYW5kbGVyc1sndmFsdWUnXSA9IHsKCSAgICAnYWZ0ZXInOiBbJ29wdGlvbnMnLCAnZm9yZWFjaCddLAoJICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzKSB7CgkgICAgICAgIC8vIElmIHRoZSB2YWx1ZSBiaW5kaW5nIGlzIHBsYWNlZCBvbiBhIHJhZGlvL2NoZWNrYm94LCB0aGVuIGp1c3QgcGFzcyB0aHJvdWdoIHRvIGNoZWNrZWRWYWx1ZSBhbmQgcXVpdAoJICAgICAgICBpZiAoZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImlucHV0IiAmJiAoZWxlbWVudC50eXBlID09ICJjaGVja2JveCIgfHwgZWxlbWVudC50eXBlID09ICJyYWRpbyIpKSB7CgkgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdBY2Nlc3NvcnNUb05vZGUoZWxlbWVudCwgeyAnY2hlY2tlZFZhbHVlJzogdmFsdWVBY2Nlc3NvciB9KTsKCSAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gQWx3YXlzIGNhdGNoICJjaGFuZ2UiIGV2ZW50OyBwb3NzaWJseSBvdGhlciBldmVudHMgdG9vIGlmIGFza2VkCgkgICAgICAgIHZhciBldmVudHNUb0NhdGNoID0gWyJjaGFuZ2UiXTsKCSAgICAgICAgdmFyIHJlcXVlc3RlZEV2ZW50c1RvQ2F0Y2ggPSBhbGxCaW5kaW5ncy5nZXQoInZhbHVlVXBkYXRlIik7CgkgICAgICAgIHZhciBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IGZhbHNlOwoJICAgICAgICB2YXIgZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQgPSBudWxsOwoKCSAgICAgICAgaWYgKHJlcXVlc3RlZEV2ZW50c1RvQ2F0Y2gpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCA9PSAic3RyaW5nIikgLy8gQWxsb3cgYm90aCBpbmRpdmlkdWFsIGV2ZW50IG5hbWVzLCBhbmQgYXJyYXlzIG9mIGV2ZW50IG5hbWVzCgkgICAgICAgICAgICAgICAgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCA9IFtyZXF1ZXN0ZWRFdmVudHNUb0NhdGNoXTsKCSAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UHVzaEFsbChldmVudHNUb0NhdGNoLCByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoKTsKCSAgICAgICAgICAgIGV2ZW50c1RvQ2F0Y2ggPSBrby51dGlscy5hcnJheUdldERpc3RpbmN0VmFsdWVzKGV2ZW50c1RvQ2F0Y2gpOwoJICAgICAgICB9CgoJICAgICAgICB2YXIgdmFsdWVVcGRhdGVIYW5kbGVyID0gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICBlbGVtZW50VmFsdWVCZWZvcmVFdmVudCA9IG51bGw7CgkgICAgICAgICAgICBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IGZhbHNlOwoJICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CgkgICAgICAgICAgICB2YXIgZWxlbWVudFZhbHVlID0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCk7CgkgICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzLCAndmFsdWUnLCBlbGVtZW50VmFsdWUpOwoJICAgICAgICB9CgoJICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzEyMgoJICAgICAgICAvLyBJRSBkb2Vzbid0IGZpcmUgImNoYW5nZSIgZXZlbnRzIG9uIHRleHRib3hlcyBpZiB0aGUgdXNlciBzZWxlY3RzIGEgdmFsdWUgZnJvbSBpdHMgYXV0b2NvbXBsZXRlIGxpc3QKCSAgICAgICAgdmFyIGllQXV0b0NvbXBsZXRlSGFja05lZWRlZCA9IGtvLnV0aWxzLmllVmVyc2lvbiAmJiBlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAiaW5wdXQiICYmIGVsZW1lbnQudHlwZSA9PSAidGV4dCIKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIGVsZW1lbnQuYXV0b2NvbXBsZXRlICE9ICJvZmYiICYmICghZWxlbWVudC5mb3JtIHx8IGVsZW1lbnQuZm9ybS5hdXRvY29tcGxldGUgIT0gIm9mZiIpOwoJICAgICAgICBpZiAoaWVBdXRvQ29tcGxldGVIYWNrTmVlZGVkICYmIGtvLnV0aWxzLmFycmF5SW5kZXhPZihldmVudHNUb0NhdGNoLCAicHJvcGVydHljaGFuZ2UiKSA9PSAtMSkgewoJICAgICAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgInByb3BlcnR5Y2hhbmdlIiwgZnVuY3Rpb24gKCkgeyBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IHRydWUgfSk7CgkgICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiZm9jdXMiLCBmdW5jdGlvbiAoKSB7IHByb3BlcnR5Q2hhbmdlZEZpcmVkID0gZmFsc2UgfSk7CgkgICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUNoYW5nZWRGaXJlZCkgewoJICAgICAgICAgICAgICAgICAgICB2YWx1ZVVwZGF0ZUhhbmRsZXIoKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfQoKCSAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGV2ZW50c1RvQ2F0Y2gsIGZ1bmN0aW9uKGV2ZW50TmFtZSkgewoJICAgICAgICAgICAgLy8gVGhlIHN5bnRheCAiYWZ0ZXI8ZXZlbnRuYW1lPiIgbWVhbnMgInJ1biB0aGUgaGFuZGxlciBhc3luY2hyb25vdXNseSBhZnRlciB0aGUgZXZlbnQiCgkgICAgICAgICAgICAvLyBUaGlzIGlzIHVzZWZ1bCwgZm9yIGV4YW1wbGUsIHRvIGNhdGNoICJrZXlkb3duIiBldmVudHMgYWZ0ZXIgdGhlIGJyb3dzZXIgaGFzIHVwZGF0ZWQgdGhlIGNvbnRyb2wKCSAgICAgICAgICAgIC8vIChvdGhlcndpc2UsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKHRoaXMpIHdpbGwgcmVjZWl2ZSB0aGUgY29udHJvbCdzIHZhbHVlICpiZWZvcmUqIHRoZSBrZXkgZXZlbnQpCgkgICAgICAgICAgICB2YXIgaGFuZGxlciA9IHZhbHVlVXBkYXRlSGFuZGxlcjsKCSAgICAgICAgICAgIGlmIChrby51dGlscy5zdHJpbmdTdGFydHNXaXRoKGV2ZW50TmFtZSwgImFmdGVyIikpIHsKCSAgICAgICAgICAgICAgICBoYW5kbGVyID0gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIFRoZSBlbGVtZW50VmFsdWVCZWZvcmVFdmVudCB2YXJpYWJsZSBpcyBub24tbnVsbCAqb25seSogZHVyaW5nIHRoZSBicmllZiBnYXAgYmV0d2VlbgoJICAgICAgICAgICAgICAgICAgICAvLyBhIGtleVggZXZlbnQgZmlyaW5nIGFuZCB0aGUgdmFsdWVVcGRhdGVIYW5kbGVyIHJ1bm5pbmcsIHdoaWNoIGlzIHNjaGVkdWxlZCB0byBoYXBwZW4KCSAgICAgICAgICAgICAgICAgICAgLy8gYXQgdGhlIGVhcmxpZXN0IGFzeW5jaHJvbm91cyBvcHBvcnR1bml0eS4gV2Ugc3RvcmUgdGhpcyB0ZW1wb3JhcnkgaW5mb3JtYXRpb24gc28gdGhhdAoJICAgICAgICAgICAgICAgICAgICAvLyBpZiwgYmV0d2VlbiBrZXlYIGFuZCB2YWx1ZVVwZGF0ZUhhbmRsZXIsIHRoZSB1bmRlcmx5aW5nIG1vZGVsIHZhbHVlIGNoYW5nZXMgc2VwYXJhdGVseSwKCSAgICAgICAgICAgICAgICAgICAgLy8gd2UgY2FuIG92ZXJ3cml0ZSB0aGF0IG1vZGVsIHZhbHVlIGNoYW5nZSB3aXRoIHRoZSB2YWx1ZSB0aGUgdXNlciBqdXN0IHR5cGVkLiBPdGhlcndpc2UsCgkgICAgICAgICAgICAgICAgICAgIC8vIHRlY2huaXF1ZXMgbGlrZSByYXRlTGltaXQgY2FuIHRyaWdnZXIgbW9kZWwgY2hhbmdlcyBhdCBjcml0aWNhbCBtb21lbnRzIHRoYXQgd2lsbAoJICAgICAgICAgICAgICAgICAgICAvLyBvdmVycmlkZSB0aGUgdXNlcidzIGlucHV0cywgY2F1c2luZyBrZXlzdHJva2VzIHRvIGJlIGxvc3QuCgkgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50ID0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCk7CgkgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQodmFsdWVVcGRhdGVIYW5kbGVyLCAwKTsKCSAgICAgICAgICAgICAgICB9OwoJICAgICAgICAgICAgICAgIGV2ZW50TmFtZSA9IGV2ZW50TmFtZS5zdWJzdHJpbmcoImFmdGVyIi5sZW5ndGgpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnROYW1lLCBoYW5kbGVyKTsKCSAgICAgICAgfSk7CgoJICAgICAgICB2YXIgdXBkYXRlRnJvbU1vZGVsID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwoJICAgICAgICAgICAgdmFyIGVsZW1lbnRWYWx1ZSA9IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpOwoKCSAgICAgICAgICAgIGlmIChlbGVtZW50VmFsdWVCZWZvcmVFdmVudCAhPT0gbnVsbCAmJiBuZXdWYWx1ZSA9PT0gZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQpIHsKCSAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHVwZGF0ZUZyb21Nb2RlbCwgMCk7CgkgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIHZhciB2YWx1ZUhhc0NoYW5nZWQgPSAobmV3VmFsdWUgIT09IGVsZW1lbnRWYWx1ZSk7CgoJICAgICAgICAgICAgaWYgKHZhbHVlSGFzQ2hhbmdlZCkgewoJICAgICAgICAgICAgICAgIGlmIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgPT09ICJzZWxlY3QiKSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBhbGxvd1Vuc2V0ID0gYWxsQmluZGluZ3MuZ2V0KCd2YWx1ZUFsbG93VW5zZXQnKTsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGFwcGx5VmFsdWVBY3Rpb24gPSBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUoZWxlbWVudCwgbmV3VmFsdWUsIGFsbG93VW5zZXQpOwoJICAgICAgICAgICAgICAgICAgICB9OwoJICAgICAgICAgICAgICAgICAgICBhcHBseVZhbHVlQWN0aW9uKCk7CgoJICAgICAgICAgICAgICAgICAgICBpZiAoIWFsbG93VW5zZXQgJiYgbmV3VmFsdWUgIT09IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB5b3UgdHJ5IHRvIHNldCBhIG1vZGVsIHZhbHVlIHRoYXQgY2FuJ3QgYmUgcmVwcmVzZW50ZWQgaW4gYW4gYWxyZWFkeS1wb3B1bGF0ZWQgZHJvcGRvd24sIHJlamVjdCB0aGF0IGNoYW5nZSwKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgeW91J3JlIG5vdCBhbGxvd2VkIHRvIGhhdmUgYSBtb2RlbCB2YWx1ZSB0aGF0IGRpc2FncmVlcyB3aXRoIGEgdmlzaWJsZSBVSSBzZWxlY3Rpb24uCgkgICAgICAgICAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZShrby51dGlscy50cmlnZ2VyRXZlbnQsIG51bGwsIFtlbGVtZW50LCAiY2hhbmdlIl0pOwoJICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBmb3IgSUU2IGJ1ZzogSXQgd29uJ3QgcmVsaWFibHkgYXBwbHkgdmFsdWVzIHRvIFNFTEVDVCBub2RlcyBkdXJpbmcgdGhlIHNhbWUgZXhlY3V0aW9uIHRocmVhZAoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmlnaHQgYWZ0ZXIgeW91J3ZlIGNoYW5nZWQgdGhlIHNldCBvZiBPUFRJT04gbm9kZXMgb24gaXQuIFNvIGZvciB0aGF0IG5vZGUgdHlwZSwgd2UnbGwgc2NoZWR1bGUgYSBzZWNvbmQgdGhyZWFkCgkgICAgICAgICAgICAgICAgICAgICAgICAvLyB0byBhcHBseSB0aGUgdmFsdWUgYXMgd2VsbC4KCSAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoYXBwbHlWYWx1ZUFjdGlvbiwgMCk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUoZWxlbWVudCwgbmV3VmFsdWUpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfTsKCgkgICAgICAgIGtvLmNvbXB1dGVkKHVwZGF0ZUZyb21Nb2RlbCwgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGVsZW1lbnQgfSk7CgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24oKSB7fSAvLyBLZWVwIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIGNvZGUgdGhhdCBtYXkgaGF2ZSB3cmFwcGVkIHZhbHVlIGJpbmRpbmcKCX07Cglrby5leHByZXNzaW9uUmV3cml0aW5nLnR3b1dheUJpbmRpbmdzWyd2YWx1ZSddID0gdHJ1ZTsKCWtvLmJpbmRpbmdIYW5kbGVyc1sndmlzaWJsZSddID0gewoJICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgICAgIHZhciBpc0N1cnJlbnRseVZpc2libGUgPSAhKGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9PSAibm9uZSIpOwoJICAgICAgICBpZiAodmFsdWUgJiYgIWlzQ3VycmVudGx5VmlzaWJsZSkKCSAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICIiOwoJICAgICAgICBlbHNlIGlmICgoIXZhbHVlKSAmJiBpc0N1cnJlbnRseVZpc2libGUpCgkgICAgICAgICAgICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgkgICAgfQoJfTsKCS8vICdjbGljaycgaXMganVzdCBhIHNob3J0aGFuZCBmb3IgdGhlIHVzdWFsIGZ1bGwtbGVuZ3RoIGV2ZW50OntjbGljazpoYW5kbGVyfQoJbWFrZUV2ZW50SGFuZGxlclNob3J0Y3V0KCdjbGljaycpOwoJLy8gSWYgeW91IHdhbnQgdG8gbWFrZSBhIGN1c3RvbSB0ZW1wbGF0ZSBlbmdpbmUsCgkvLwoJLy8gWzFdIEluaGVyaXQgZnJvbSB0aGlzIGNsYXNzIChsaWtlIGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lIGRvZXMpCgkvLyBbMl0gT3ZlcnJpZGUgJ3JlbmRlclRlbXBsYXRlU291cmNlJywgc3VwcGx5aW5nIGEgZnVuY3Rpb24gd2l0aCB0aGlzIHNpZ25hdHVyZToKCS8vCgkvLyAgICAgICAgZnVuY3Rpb24gKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewoJLy8gICAgICAgICAgICAvLyAtIHRlbXBsYXRlU291cmNlLnRleHQoKSBpcyB0aGUgdGV4dCBvZiB0aGUgdGVtcGxhdGUgeW91IHNob3VsZCByZW5kZXIKCS8vICAgICAgICAgICAgLy8gLSBiaW5kaW5nQ29udGV4dC4kZGF0YSBpcyB0aGUgZGF0YSB5b3Ugc2hvdWxkIHBhc3MgaW50byB0aGUgdGVtcGxhdGUKCS8vICAgICAgICAgICAgLy8gICAtIHlvdSBtaWdodCBhbHNvIHdhbnQgdG8gbWFrZSBiaW5kaW5nQ29udGV4dC4kcGFyZW50LCBiaW5kaW5nQ29udGV4dC4kcGFyZW50cywKCS8vICAgICAgICAgICAgLy8gICAgIGFuZCBiaW5kaW5nQ29udGV4dC4kcm9vdCBhdmFpbGFibGUgaW4gdGhlIHRlbXBsYXRlIHRvbwoJLy8gICAgICAgICAgICAvLyAtIG9wdGlvbnMgZ2l2ZXMgeW91IGFjY2VzcyB0byBhbnkgb3RoZXIgcHJvcGVydGllcyBzZXQgb24gImRhdGEtYmluZDogeyB0ZW1wbGF0ZTogb3B0aW9ucyB9IgoJLy8gICAgICAgICAgICAvLwoJLy8gICAgICAgICAgICAvLyBSZXR1cm4gdmFsdWU6IGFuIGFycmF5IG9mIERPTSBub2RlcwoJLy8gICAgICAgIH0KCS8vCgkvLyBbM10gT3ZlcnJpZGUgJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jaycsIHN1cHBseWluZyBhIGZ1bmN0aW9uIHdpdGggdGhpcyBzaWduYXR1cmU6CgkvLwoJLy8gICAgICAgIGZ1bmN0aW9uIChzY3JpcHQpIHsKCS8vICAgICAgICAgICAgLy8gUmV0dXJuIHZhbHVlOiBXaGF0ZXZlciBzeW50YXggbWVhbnMgIkV2YWx1YXRlIHRoZSBKYXZhU2NyaXB0IHN0YXRlbWVudCAnc2NyaXB0JyBhbmQgb3V0cHV0IHRoZSByZXN1bHQiCgkvLyAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgRm9yIGV4YW1wbGUsIHRoZSBqcXVlcnkudG1wbCB0ZW1wbGF0ZSBlbmdpbmUgY29udmVydHMgJ3NvbWVTY3JpcHQnIHRvICckeyBzb21lU2NyaXB0IH0nCgkvLyAgICAgICAgfQoJLy8KCS8vICAgICBUaGlzIGlzIG9ubHkgbmVjZXNzYXJ5IGlmIHlvdSB3YW50IHRvIGFsbG93IGRhdGEtYmluZCBhdHRyaWJ1dGVzIHRvIHJlZmVyZW5jZSBhcmJpdHJhcnkgdGVtcGxhdGUgdmFyaWFibGVzLgoJLy8gICAgIElmIHlvdSBkb24ndCB3YW50IHRvIGFsbG93IHRoYXQsIHlvdSBjYW4gc2V0IHRoZSBwcm9wZXJ0eSAnYWxsb3dUZW1wbGF0ZVJld3JpdGluZycgdG8gZmFsc2UgKGxpa2Uga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUgZG9lcykKCS8vICAgICBhbmQgdGhlbiB5b3UgZG9uJ3QgbmVlZCB0byBvdmVycmlkZSAnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJy4KCglrby50ZW1wbGF0ZUVuZ2luZSA9IGZ1bmN0aW9uICgpIHsgfTsKCglrby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CgkgICAgdGhyb3cgbmV3IEVycm9yKCJPdmVycmlkZSByZW5kZXJUZW1wbGF0ZVNvdXJjZSIpOwoJfTsKCglrby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jayddID0gZnVuY3Rpb24gKHNjcmlwdCkgewoJICAgIHRocm93IG5ldyBFcnJvcigiT3ZlcnJpZGUgY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrIik7Cgl9OwoKCWtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsnbWFrZVRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbih0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkgewoJICAgIC8vIE5hbWVkIHRlbXBsYXRlCgkgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PSAic3RyaW5nIikgewoJICAgICAgICB0ZW1wbGF0ZURvY3VtZW50ID0gdGVtcGxhdGVEb2N1bWVudCB8fCBkb2N1bWVudDsKCSAgICAgICAgdmFyIGVsZW0gPSB0ZW1wbGF0ZURvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRlbXBsYXRlKTsKCSAgICAgICAgaWYgKCFlbGVtKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmluZCB0ZW1wbGF0ZSB3aXRoIElEICIgKyB0ZW1wbGF0ZSk7CgkgICAgICAgIHJldHVybiBuZXcga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQoZWxlbSk7CgkgICAgfSBlbHNlIGlmICgodGVtcGxhdGUubm9kZVR5cGUgPT0gMSkgfHwgKHRlbXBsYXRlLm5vZGVUeXBlID09IDgpKSB7CgkgICAgICAgIC8vIEFub255bW91cyB0ZW1wbGF0ZQoJICAgICAgICByZXR1cm4gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZSh0ZW1wbGF0ZSk7CgkgICAgfSBlbHNlCgkgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biB0ZW1wbGF0ZSB0eXBlOiAiICsgdGVtcGxhdGUpOwoJfTsKCglrby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3JlbmRlclRlbXBsYXRlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCB0ZW1wbGF0ZURvY3VtZW50KSB7CgkgICAgdmFyIHRlbXBsYXRlU291cmNlID0gdGhpc1snbWFrZVRlbXBsYXRlU291cmNlJ10odGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpOwoJICAgIHJldHVybiB0aGlzWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucyk7Cgl9OwoKCWtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsnaXNUZW1wbGF0ZVJld3JpdHRlbiddID0gZnVuY3Rpb24gKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KSB7CgkgICAgLy8gU2tpcCByZXdyaXRpbmcgaWYgcmVxdWVzdGVkCgkgICAgaWYgKHRoaXNbJ2FsbG93VGVtcGxhdGVSZXdyaXRpbmcnXSA9PT0gZmFsc2UpCgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgIHJldHVybiB0aGlzWydtYWtlVGVtcGxhdGVTb3VyY2UnXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudClbJ2RhdGEnXSgiaXNSZXdyaXR0ZW4iKTsKCX07CgoJa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydyZXdyaXRlVGVtcGxhdGUnXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgcmV3cml0ZXJDYWxsYmFjaywgdGVtcGxhdGVEb2N1bWVudCkgewoJICAgIHZhciB0ZW1wbGF0ZVNvdXJjZSA9IHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KTsKCSAgICB2YXIgcmV3cml0dGVuID0gcmV3cml0ZXJDYWxsYmFjayh0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKCkpOwoJICAgIHRlbXBsYXRlU291cmNlWyd0ZXh0J10ocmV3cml0dGVuKTsKCSAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCJpc1Jld3JpdHRlbiIsIHRydWUpOwoJfTsKCglrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlRW5naW5lJywga28udGVtcGxhdGVFbmdpbmUpOwoKCWtvLnRlbXBsYXRlUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKCSAgICB2YXIgbWVtb2l6ZURhdGFCaW5kaW5nQXR0cmlidXRlU3ludGF4UmVnZXggPSAvKDwoW2Etel0rXGQqKSg/OlxzKyg/IWRhdGEtYmluZFxzKj1ccyopW2EtejAtOVwtXSsoPzo9KD86XCJbXlwiXSpcInxcJ1teXCddKlwnKSk/KSpccyspZGF0YS1iaW5kXHMqPVxzKihbIiddKShbXHNcU10qPylcMy9naTsKCSAgICB2YXIgbWVtb2l6ZVZpcnR1YWxDb250YWluZXJCaW5kaW5nU3ludGF4UmVnZXggPSAvPCEtLVxzKmtvXGJccyooW1xzXFNdKj8pXHMqLS0+L2c7CgoJICAgIGZ1bmN0aW9uIHZhbGlkYXRlRGF0YUJpbmRWYWx1ZXNGb3JSZXdyaXRpbmcoa2V5VmFsdWVBcnJheSkgewoJICAgICAgICB2YXIgYWxsVmFsaWRhdG9ycyA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzOwoJICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleVZhbHVlQXJyYXkubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgICAgIHZhciBrZXkgPSBrZXlWYWx1ZUFycmF5W2ldWydrZXknXTsKCSAgICAgICAgICAgIGlmIChhbGxWYWxpZGF0b3JzLmhhc093blByb3BlcnR5KGtleSkpIHsKCSAgICAgICAgICAgICAgICB2YXIgdmFsaWRhdG9yID0gYWxsVmFsaWRhdG9yc1trZXldOwoKCSAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbGlkYXRvciA9PT0gImZ1bmN0aW9uIikgewoJICAgICAgICAgICAgICAgICAgICB2YXIgcG9zc2libGVFcnJvck1lc3NhZ2UgPSB2YWxpZGF0b3Ioa2V5VmFsdWVBcnJheVtpXVsndmFsdWUnXSk7CgkgICAgICAgICAgICAgICAgICAgIGlmIChwb3NzaWJsZUVycm9yTWVzc2FnZSkKCSAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihwb3NzaWJsZUVycm9yTWVzc2FnZSk7CgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdmFsaWRhdG9yKSB7CgkgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyB0ZW1wbGF0ZSBlbmdpbmUgZG9lcyBub3Qgc3VwcG9ydCB0aGUgJyIgKyBrZXkgKyAiJyBiaW5kaW5nIHdpdGhpbiBpdHMgdGVtcGxhdGVzIik7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBjb25zdHJ1Y3RNZW1vaXplZFRhZ1JlcGxhY2VtZW50KGRhdGFCaW5kQXR0cmlidXRlVmFsdWUsIHRhZ1RvUmV0YWluLCBub2RlTmFtZSwgdGVtcGxhdGVFbmdpbmUpIHsKCSAgICAgICAgdmFyIGRhdGFCaW5kS2V5VmFsdWVBcnJheSA9IGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsKGRhdGFCaW5kQXR0cmlidXRlVmFsdWUpOwoJICAgICAgICB2YWxpZGF0ZURhdGFCaW5kVmFsdWVzRm9yUmV3cml0aW5nKGRhdGFCaW5kS2V5VmFsdWVBcnJheSk7CgkgICAgICAgIHZhciByZXdyaXR0ZW5EYXRhQmluZEF0dHJpYnV0ZVZhbHVlID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MoZGF0YUJpbmRLZXlWYWx1ZUFycmF5LCB7J3ZhbHVlQWNjZXNzb3JzJzp0cnVlfSk7CgoJICAgICAgICAvLyBGb3Igbm8gb2J2aW91cyByZWFzb24sIE9wZXJhIGZhaWxzIHRvIGV2YWx1YXRlIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgdW5sZXNzIGl0J3Mgd3JhcHBlZCBpbiBhbiBhZGRpdGlvbmFsCgkgICAgICAgIC8vIGFub255bW91cyBmdW5jdGlvbiwgZXZlbiB0aG91Z2ggT3BlcmEncyBidWlsdC1pbiBkZWJ1Z2dlciBjYW4gZXZhbHVhdGUgaXQgYW55d2F5LiBObyBvdGhlciBicm93c2VyIHJlcXVpcmVzIHRoaXMKCSAgICAgICAgLy8gZXh0cmEgaW5kaXJlY3Rpb24uCgkgICAgICAgIHZhciBhcHBseUJpbmRpbmdzVG9OZXh0U2libGluZ1NjcmlwdCA9CgkgICAgICAgICAgICAia28uX190cl9hbWJ0bnMoZnVuY3Rpb24oJGNvbnRleHQsJGVsZW1lbnQpe3JldHVybihmdW5jdGlvbigpe3JldHVybnsgIiArIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgKyAiIH0gfSkoKX0sJyIgKyBub2RlTmFtZS50b0xvd2VyQ2FzZSgpICsgIicpIjsKCSAgICAgICAgcmV0dXJuIHRlbXBsYXRlRW5naW5lWydjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2snXShhcHBseUJpbmRpbmdzVG9OZXh0U2libGluZ1NjcmlwdCkgKyB0YWdUb1JldGFpbjsKCSAgICB9CgoJICAgIHJldHVybiB7CgkgICAgICAgIGVuc3VyZVRlbXBsYXRlSXNSZXdyaXR0ZW46IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgdGVtcGxhdGVFbmdpbmUsIHRlbXBsYXRlRG9jdW1lbnQpIHsKCSAgICAgICAgICAgIGlmICghdGVtcGxhdGVFbmdpbmVbJ2lzVGVtcGxhdGVSZXdyaXR0ZW4nXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkpCgkgICAgICAgICAgICAgICAgdGVtcGxhdGVFbmdpbmVbJ3Jld3JpdGVUZW1wbGF0ZSddKHRlbXBsYXRlLCBmdW5jdGlvbiAoaHRtbFN0cmluZykgewoJICAgICAgICAgICAgICAgICAgICByZXR1cm4ga28udGVtcGxhdGVSZXdyaXRpbmcubWVtb2l6ZUJpbmRpbmdBdHRyaWJ1dGVTeW50YXgoaHRtbFN0cmluZywgdGVtcGxhdGVFbmdpbmUpOwoJICAgICAgICAgICAgICAgIH0sIHRlbXBsYXRlRG9jdW1lbnQpOwoJICAgICAgICB9LAoKCSAgICAgICAgbWVtb2l6ZUJpbmRpbmdBdHRyaWJ1dGVTeW50YXg6IGZ1bmN0aW9uIChodG1sU3RyaW5nLCB0ZW1wbGF0ZUVuZ2luZSkgewoJICAgICAgICAgICAgcmV0dXJuIGh0bWxTdHJpbmcucmVwbGFjZShtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCwgZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgICAgIHJldHVybiBjb25zdHJ1Y3RNZW1vaXplZFRhZ1JlcGxhY2VtZW50KC8qIGRhdGFCaW5kQXR0cmlidXRlVmFsdWU6ICovIGFyZ3VtZW50c1s0XSwgLyogdGFnVG9SZXRhaW46ICovIGFyZ3VtZW50c1sxXSwgLyogbm9kZU5hbWU6ICovIGFyZ3VtZW50c1syXSwgdGVtcGxhdGVFbmdpbmUpOwoJICAgICAgICAgICAgfSkucmVwbGFjZShtZW1vaXplVmlydHVhbENvbnRhaW5lckJpbmRpbmdTeW50YXhSZWdleCwgZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzFdLCAvKiB0YWdUb1JldGFpbjogKi8gIjwhLS0ga28gLS0+IiwgLyogbm9kZU5hbWU6ICovICIjY29tbWVudCIsIHRlbXBsYXRlRW5naW5lKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9LAoKCSAgICAgICAgYXBwbHlNZW1vaXplZEJpbmRpbmdzVG9OZXh0U2libGluZzogZnVuY3Rpb24gKGJpbmRpbmdzLCBub2RlTmFtZSkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoZnVuY3Rpb24gKGRvbU5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgICAgICAgICAgdmFyIG5vZGVUb0JpbmQgPSBkb21Ob2RlLm5leHRTaWJsaW5nOwoJICAgICAgICAgICAgICAgIGlmIChub2RlVG9CaW5kICYmIG5vZGVUb0JpbmQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbm9kZU5hbWUpIHsKCSAgICAgICAgICAgICAgICAgICAga28uYXBwbHlCaW5kaW5nQWNjZXNzb3JzVG9Ob2RlKG5vZGVUb0JpbmQsIGJpbmRpbmdzLCBiaW5kaW5nQ29udGV4dCk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0KCSAgICB9Cgl9KSgpOwoKCgkvLyBFeHBvcnRlZCBvbmx5IGJlY2F1c2UgaXQgaGFzIHRvIGJlIHJlZmVyZW5jZWQgYnkgc3RyaW5nIGxvb2t1cCBmcm9tIHdpdGhpbiByZXdyaXR0ZW4gdGVtcGxhdGUKCWtvLmV4cG9ydFN5bWJvbCgnX190cl9hbWJ0bnMnLCBrby50ZW1wbGF0ZVJld3JpdGluZy5hcHBseU1lbW9pemVkQmluZGluZ3NUb05leHRTaWJsaW5nKTsKCShmdW5jdGlvbigpIHsKCSAgICAvLyBBIHRlbXBsYXRlIHNvdXJjZSByZXByZXNlbnRzIGEgcmVhZC93cml0ZSB3YXkgb2YgYWNjZXNzaW5nIGEgdGVtcGxhdGUuIFRoaXMgaXMgdG8gZWxpbWluYXRlIHRoZSBuZWVkIGZvciB0ZW1wbGF0ZSBsb2FkaW5nL3NhdmluZwoJICAgIC8vIGxvZ2ljIHRvIGJlIGR1cGxpY2F0ZWQgaW4gZXZlcnkgdGVtcGxhdGUgZW5naW5lIChhbmQgbWVhbnMgdGhleSBjYW4gYWxsIHdvcmsgd2l0aCBhbm9ueW1vdXMgdGVtcGxhdGVzLCBldGMuKQoJICAgIC8vCgkgICAgLy8gVHdvIGFyZSBwcm92aWRlZCBieSBkZWZhdWx0OgoJICAgIC8vICAxLiBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCAgICAgICAtIHJlYWRzL3dyaXRlcyB0aGUgdGV4dCBjb250ZW50IG9mIGFuIGFyYml0cmFyeSBET00gZWxlbWVudAoJICAgIC8vICAyLiBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzRWxlbWVudCAtIHVzZXMga28udXRpbHMuZG9tRGF0YSB0byByZWFkL3dyaXRlIHRleHQgKmFzc29jaWF0ZWQqIHdpdGggdGhlIERPTSBlbGVtZW50LCBidXQKCSAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRob3V0IHJlYWRpbmcvd3JpdGluZyB0aGUgYWN0dWFsIGVsZW1lbnQgdGV4dCBjb250ZW50LCBzaW5jZSBpdCB3aWxsIGJlIG92ZXJ3cml0dGVuCgkgICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aCB0aGUgcmVuZGVyZWQgdGVtcGxhdGUgb3V0cHV0LgoJICAgIC8vIFlvdSBjYW4gaW1wbGVtZW50IHlvdXIgb3duIHRlbXBsYXRlIHNvdXJjZSBpZiB5b3Ugd2FudCB0byBmZXRjaC9zdG9yZSB0ZW1wbGF0ZXMgc29tZXdoZXJlIG90aGVyIHRoYW4gaW4gRE9NIGVsZW1lbnRzLgoJICAgIC8vIFRlbXBsYXRlIHNvdXJjZXMgbmVlZCB0byBoYXZlIHRoZSBmb2xsb3dpbmcgZnVuY3Rpb25zOgoJICAgIC8vICAgdGV4dCgpIAkJCS0gcmV0dXJucyB0aGUgdGVtcGxhdGUgdGV4dCBmcm9tIHlvdXIgc3RvcmFnZSBsb2NhdGlvbgoJICAgIC8vICAgdGV4dCh2YWx1ZSkJCS0gd3JpdGVzIHRoZSBzdXBwbGllZCB0ZW1wbGF0ZSB0ZXh0IHRvIHlvdXIgc3RvcmFnZSBsb2NhdGlvbgoJICAgIC8vICAgZGF0YShrZXkpCQkJLSByZWFkcyB2YWx1ZXMgc3RvcmVkIHVzaW5nIGRhdGEoa2V5LCB2YWx1ZSkgLSBzZWUgYmVsb3cKCSAgICAvLyAgIGRhdGEoa2V5LCB2YWx1ZSkJLSBhc3NvY2lhdGVzICJ2YWx1ZSIgd2l0aCB0aGlzIHRlbXBsYXRlIGFuZCB0aGUga2V5ICJrZXkiLiBJcyB1c2VkIHRvIHN0b3JlIGluZm9ybWF0aW9uIGxpa2UgImlzUmV3cml0dGVuIi4KCSAgICAvLwoJICAgIC8vIE9wdGlvbmFsbHksIHRlbXBsYXRlIHNvdXJjZXMgY2FuIGFsc28gaGF2ZSB0aGUgZm9sbG93aW5nIGZ1bmN0aW9uczoKCSAgICAvLyAgIG5vZGVzKCkgICAgICAgICAgICAtIHJldHVybnMgYSBET00gZWxlbWVudCBjb250YWluaW5nIHRoZSBub2RlcyBvZiB0aGlzIHRlbXBsYXRlLCB3aGVyZSBhdmFpbGFibGUKCSAgICAvLyAgIG5vZGVzKHZhbHVlKSAgICAgICAtIHdyaXRlcyB0aGUgZ2l2ZW4gRE9NIGVsZW1lbnQgdG8geW91ciBzdG9yYWdlIGxvY2F0aW9uCgkgICAgLy8gSWYgYSBET00gZWxlbWVudCBpcyBhdmFpbGFibGUgZm9yIGEgZ2l2ZW4gdGVtcGxhdGUgc291cmNlLCB0ZW1wbGF0ZSBlbmdpbmVzIGFyZSBlbmNvdXJhZ2VkIHRvIHVzZSBpdCBpbiBwcmVmZXJlbmNlIG92ZXIgdGV4dCgpCgkgICAgLy8gZm9yIGltcHJvdmVkIHNwZWVkLiBIb3dldmVyLCBhbGwgdGVtcGxhdGVTb3VyY2VzIG11c3Qgc3VwcGx5IHRleHQoKSBldmVuIGlmIHRoZXkgZG9uJ3Qgc3VwcGx5IG5vZGVzKCkuCgkgICAgLy8KCSAgICAvLyBPbmNlIHlvdSd2ZSBpbXBsZW1lbnRlZCBhIHRlbXBsYXRlU291cmNlLCBtYWtlIHlvdXIgdGVtcGxhdGUgZW5naW5lIHVzZSBpdCBieSBzdWJjbGFzc2luZyB3aGF0ZXZlciB0ZW1wbGF0ZSBlbmdpbmUgeW91IHdlcmUKCSAgICAvLyB1c2luZyBhbmQgb3ZlcnJpZGluZyAibWFrZVRlbXBsYXRlU291cmNlIiB0byByZXR1cm4gYW4gaW5zdGFuY2Ugb2YgeW91ciBjdXN0b20gdGVtcGxhdGUgc291cmNlLgoKCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMgPSB7fTsKCgkgICAgLy8gLS0tLSBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCAtLS0tLQoKCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKCSAgICAgICAgdGhpcy5kb21FbGVtZW50ID0gZWxlbWVudDsKCSAgICB9CgoJICAgIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50LnByb3RvdHlwZVsndGV4dCddID0gZnVuY3Rpb24oLyogdmFsdWVUb1dyaXRlICovKSB7CgkgICAgICAgIHZhciB0YWdOYW1lTG93ZXIgPSBrby51dGlscy50YWdOYW1lTG93ZXIodGhpcy5kb21FbGVtZW50KSwKCSAgICAgICAgICAgIGVsZW1Db250ZW50c1Byb3BlcnR5ID0gdGFnTmFtZUxvd2VyID09PSAic2NyaXB0IiA/ICJ0ZXh0IgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB0YWdOYW1lTG93ZXIgPT09ICJ0ZXh0YXJlYSIgPyAidmFsdWUiCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICJpbm5lckhUTUwiOwoKCSAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkgewoJICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tRWxlbWVudFtlbGVtQ29udGVudHNQcm9wZXJ0eV07CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICB2YXIgdmFsdWVUb1dyaXRlID0gYXJndW1lbnRzWzBdOwoJICAgICAgICAgICAgaWYgKGVsZW1Db250ZW50c1Byb3BlcnR5ID09PSAiaW5uZXJIVE1MIikKCSAgICAgICAgICAgICAgICBrby51dGlscy5zZXRIdG1sKHRoaXMuZG9tRWxlbWVudCwgdmFsdWVUb1dyaXRlKTsKCSAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICB0aGlzLmRvbUVsZW1lbnRbZWxlbUNvbnRlbnRzUHJvcGVydHldID0gdmFsdWVUb1dyaXRlOwoJICAgICAgICB9CgkgICAgfTsKCgkgICAgdmFyIGRhdGFEb21EYXRhUHJlZml4ID0ga28udXRpbHMuZG9tRGF0YS5uZXh0S2V5KCkgKyAiXyI7CgkgICAga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQucHJvdG90eXBlWydkYXRhJ10gPSBmdW5jdGlvbihrZXkgLyosIHZhbHVlVG9Xcml0ZSAqLykgewoJICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KHRoaXMuZG9tRWxlbWVudCwgZGF0YURvbURhdGFQcmVmaXggKyBrZXkpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQodGhpcy5kb21FbGVtZW50LCBkYXRhRG9tRGF0YVByZWZpeCArIGtleSwgYXJndW1lbnRzWzFdKTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIC8vIC0tLS0ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlIC0tLS0tCgkgICAgLy8gQW5vbnltb3VzIHRlbXBsYXRlcyBhcmUgbm9ybWFsbHkgc2F2ZWQvcmV0cmlldmVkIGFzIERPTSBub2RlcyB0aHJvdWdoICJub2RlcyIuCgkgICAgLy8gRm9yIGNvbXBhdGliaWxpdHksIHlvdSBjYW4gYWxzbyByZWFkICJ0ZXh0IjsgaXQgd2lsbCBiZSBzZXJpYWxpemVkIGZyb20gdGhlIG5vZGVzIG9uIGRlbWFuZC4KCSAgICAvLyBXcml0aW5nIHRvICJ0ZXh0IiBpcyBzdGlsbCBzdXBwb3J0ZWQsIGJ1dCB0aGVuIHRoZSB0ZW1wbGF0ZSBkYXRhIHdpbGwgbm90IGJlIGF2YWlsYWJsZSBhcyBET00gbm9kZXMuCgoJICAgIHZhciBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5ID0ga28udXRpbHMuZG9tRGF0YS5uZXh0S2V5KCk7CgkgICAga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlID0gZnVuY3Rpb24oZWxlbWVudCkgewoJICAgICAgICB0aGlzLmRvbUVsZW1lbnQgPSBlbGVtZW50OwoJICAgIH0KCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlID0gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50KCk7CgkgICAga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZTsKCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKCSAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkgewoJICAgICAgICAgICAgdmFyIHRlbXBsYXRlRGF0YSA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KHRoaXMuZG9tRWxlbWVudCwgYW5vbnltb3VzVGVtcGxhdGVzRG9tRGF0YUtleSkgfHwge307CgkgICAgICAgICAgICBpZiAodGVtcGxhdGVEYXRhLnRleHREYXRhID09PSB1bmRlZmluZWQgJiYgdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGEpCgkgICAgICAgICAgICAgICAgdGVtcGxhdGVEYXRhLnRleHREYXRhID0gdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGEuaW5uZXJIVE1MOwoJICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlRGF0YS50ZXh0RGF0YTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHZhciB2YWx1ZVRvV3JpdGUgPSBhcmd1bWVudHNbMF07CgkgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXksIHt0ZXh0RGF0YTogdmFsdWVUb1dyaXRlfSk7CgkgICAgICAgIH0KCSAgICB9OwoJICAgIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50LnByb3RvdHlwZVsnbm9kZXMnXSA9IGZ1bmN0aW9uKC8qIHZhbHVlVG9Xcml0ZSAqLykgewoJICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CgkgICAgICAgICAgICB2YXIgdGVtcGxhdGVEYXRhID0ga28udXRpbHMuZG9tRGF0YS5nZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5KSB8fCB7fTsKCSAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZURhdGEuY29udGFpbmVyRGF0YTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHZhciB2YWx1ZVRvV3JpdGUgPSBhcmd1bWVudHNbMF07CgkgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXksIHtjb250YWluZXJEYXRhOiB2YWx1ZVRvV3JpdGV9KTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIGtvLmV4cG9ydFN5bWJvbCgndGVtcGxhdGVTb3VyY2VzJywga28udGVtcGxhdGVTb3VyY2VzKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlU291cmNlcy5kb21FbGVtZW50Jywga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQpOwoJICAgIGtvLmV4cG9ydFN5bWJvbCgndGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlJywga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlKTsKCX0pKCk7CgkoZnVuY3Rpb24gKCkgewoJICAgIHZhciBfdGVtcGxhdGVFbmdpbmU7CgkgICAga28uc2V0VGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbiAodGVtcGxhdGVFbmdpbmUpIHsKCSAgICAgICAgaWYgKCh0ZW1wbGF0ZUVuZ2luZSAhPSB1bmRlZmluZWQpICYmICEodGVtcGxhdGVFbmdpbmUgaW5zdGFuY2VvZiBrby50ZW1wbGF0ZUVuZ2luZSkpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRlbXBsYXRlRW5naW5lIG11c3QgaW5oZXJpdCBmcm9tIGtvLnRlbXBsYXRlRW5naW5lIik7CgkgICAgICAgIF90ZW1wbGF0ZUVuZ2luZSA9IHRlbXBsYXRlRW5naW5lOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gaW52b2tlRm9yRWFjaE5vZGVJbkNvbnRpbnVvdXNSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlLCBhY3Rpb24pIHsKCSAgICAgICAgdmFyIG5vZGUsIG5leHRJblF1ZXVlID0gZmlyc3ROb2RlLCBmaXJzdE91dE9mUmFuZ2VOb2RlID0ga28udmlydHVhbEVsZW1lbnRzLm5leHRTaWJsaW5nKGxhc3ROb2RlKTsKCSAgICAgICAgd2hpbGUgKG5leHRJblF1ZXVlICYmICgobm9kZSA9IG5leHRJblF1ZXVlKSAhPT0gZmlyc3RPdXRPZlJhbmdlTm9kZSkpIHsKCSAgICAgICAgICAgIG5leHRJblF1ZXVlID0ga28udmlydHVhbEVsZW1lbnRzLm5leHRTaWJsaW5nKG5vZGUpOwoJICAgICAgICAgICAgYWN0aW9uKG5vZGUsIG5leHRJblF1ZXVlKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gYWN0aXZhdGVCaW5kaW5nc09uQ29udGludW91c05vZGVBcnJheShjb250aW51b3VzTm9kZUFycmF5LCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAvLyBUbyBiZSB1c2VkIG9uIGFueSBub2RlcyB0aGF0IGhhdmUgYmVlbiByZW5kZXJlZCBieSBhIHRlbXBsYXRlIGFuZCBoYXZlIGJlZW4gaW5zZXJ0ZWQgaW50byBzb21lIHBhcmVudCBlbGVtZW50CgkgICAgICAgIC8vIFdhbGtzIHRocm91Z2ggY29udGludW91c05vZGVBcnJheSAod2hpY2ggKm11c3QqIGJlIGNvbnRpbnVvdXMsIGkuZS4sIGFuIHVuaW50ZXJydXB0ZWQgc2VxdWVuY2Ugb2Ygc2libGluZyBub2RlcywgYmVjYXVzZQoJICAgICAgICAvLyB0aGUgYWxnb3JpdGhtIGZvciB3YWxraW5nIHRoZW0gcmVsaWVzIG9uIHRoaXMpLCBhbmQgZm9yIGVhY2ggdG9wLWxldmVsIGl0ZW0gaW4gdGhlIHZpcnR1YWwtZWxlbWVudCBzZW5zZSwKCSAgICAgICAgLy8gKDEpIERvZXMgYSByZWd1bGFyICJhcHBseUJpbmRpbmdzIiB0byBhc3NvY2lhdGUgYmluZGluZ0NvbnRleHQgd2l0aCB0aGlzIG5vZGUgYW5kIHRvIGFjdGl2YXRlIGFueSBub24tbWVtb2l6ZWQgYmluZGluZ3MKCSAgICAgICAgLy8gKDIpIFVubWVtb2l6ZXMgYW55IG1lbW9zIGluIHRoZSBET00gc3VidHJlZSAoZS5nLiwgdG8gYWN0aXZhdGUgYmluZGluZ3MgdGhhdCBoYWQgYmVlbiBtZW1vaXplZCBkdXJpbmcgdGVtcGxhdGUgcmV3cml0aW5nKQoKCSAgICAgICAgaWYgKGNvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoKSB7CgkgICAgICAgICAgICB2YXIgZmlyc3ROb2RlID0gY29udGludW91c05vZGVBcnJheVswXSwKCSAgICAgICAgICAgICAgICBsYXN0Tm9kZSA9IGNvbnRpbnVvdXNOb2RlQXJyYXlbY29udGludW91c05vZGVBcnJheS5sZW5ndGggLSAxXSwKCSAgICAgICAgICAgICAgICBwYXJlbnROb2RlID0gZmlyc3ROb2RlLnBhcmVudE5vZGUsCgkgICAgICAgICAgICAgICAgcHJvdmlkZXIgPSBrby5iaW5kaW5nUHJvdmlkZXJbJ2luc3RhbmNlJ10sCgkgICAgICAgICAgICAgICAgcHJlcHJvY2Vzc05vZGUgPSBwcm92aWRlclsncHJlcHJvY2Vzc05vZGUnXTsKCgkgICAgICAgICAgICBpZiAocHJlcHJvY2Vzc05vZGUpIHsKCSAgICAgICAgICAgICAgICBpbnZva2VGb3JFYWNoTm9kZUluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGZ1bmN0aW9uKG5vZGUsIG5leHROb2RlSW5SYW5nZSkgewoJICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZVByZXZpb3VzU2libGluZyA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwoJICAgICAgICAgICAgICAgICAgICB2YXIgbmV3Tm9kZXMgPSBwcmVwcm9jZXNzTm9kZS5jYWxsKHByb3ZpZGVyLCBub2RlKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKG5ld05vZGVzKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZmlyc3ROb2RlKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0Tm9kZSA9IG5ld05vZGVzWzBdIHx8IG5leHROb2RlSW5SYW5nZTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBsYXN0Tm9kZSkKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0Tm9kZSA9IG5ld05vZGVzW25ld05vZGVzLmxlbmd0aCAtIDFdIHx8IG5vZGVQcmV2aW91c1NpYmxpbmc7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9KTsKCgkgICAgICAgICAgICAgICAgLy8gQmVjYXVzZSBwcmVwcm9jZXNzTm9kZSBjYW4gY2hhbmdlIHRoZSBub2RlcywgaW5jbHVkaW5nIHRoZSBmaXJzdCBhbmQgbGFzdCBub2RlcywgdXBkYXRlIGNvbnRpbnVvdXNOb2RlQXJyYXkgdG8gbWF0Y2guCgkgICAgICAgICAgICAgICAgLy8gV2UgbmVlZCB0aGUgZnVsbCBzZXQsIGluY2x1ZGluZyBpbm5lciBub2RlcywgYmVjYXVzZSB0aGUgdW5tZW1vaXplIHN0ZXAgbWlnaHQgcmVtb3ZlIHRoZSBmaXJzdCBub2RlIChhbmQgc28gdGhlIHJlYWwKCSAgICAgICAgICAgICAgICAvLyBmaXJzdCBub2RlIG5lZWRzIHRvIGJlIGluIHRoZSBhcnJheSkuCgkgICAgICAgICAgICAgICAgY29udGludW91c05vZGVBcnJheS5sZW5ndGggPSAwOwoJICAgICAgICAgICAgICAgIGlmICghZmlyc3ROb2RlKSB7IC8vIHByZXByb2Nlc3NOb2RlIG1pZ2h0IGhhdmUgcmVtb3ZlZCBhbGwgdGhlIG5vZGVzLCBpbiB3aGljaCBjYXNlIHRoZXJlJ3Mgbm90aGluZyBsZWZ0IHRvIGRvCgkgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKGZpcnN0Tm9kZSA9PT0gbGFzdE5vZGUpIHsKCSAgICAgICAgICAgICAgICAgICAgY29udGludW91c05vZGVBcnJheS5wdXNoKGZpcnN0Tm9kZSk7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgY29udGludW91c05vZGVBcnJheS5wdXNoKGZpcnN0Tm9kZSwgbGFzdE5vZGUpOwoJICAgICAgICAgICAgICAgICAgICBrby51dGlscy5maXhVcENvbnRpbnVvdXNOb2RlQXJyYXkoY29udGludW91c05vZGVBcnJheSwgcGFyZW50Tm9kZSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIC8vIE5lZWQgdG8gYXBwbHlCaW5kaW5ncyAqYmVmb3JlKiB1bm1lbW96aWF0aW9uLCBiZWNhdXNlIHVubWVtb2l6YXRpb24gbWlnaHQgaW50cm9kdWNlIGV4dHJhIG5vZGVzICh0aGF0IHdlIGRvbid0IHdhbnQgdG8gcmUtYmluZCkKCSAgICAgICAgICAgIC8vIHdoZXJlYXMgYSByZWd1bGFyIGFwcGx5QmluZGluZ3Mgd29uJ3QgaW50cm9kdWNlIG5ldyBtZW1vaXplZCBub2RlcwoJICAgICAgICAgICAgaW52b2tlRm9yRWFjaE5vZGVJbkNvbnRpbnVvdXNSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlLCBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEgfHwgbm9kZS5ub2RlVHlwZSA9PT0gOCkKCSAgICAgICAgICAgICAgICAgICAga28uYXBwbHlCaW5kaW5ncyhiaW5kaW5nQ29udGV4dCwgbm9kZSk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIGludm9rZUZvckVhY2hOb2RlSW5Db250aW51b3VzUmFuZ2UoZmlyc3ROb2RlLCBsYXN0Tm9kZSwgZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxIHx8IG5vZGUubm9kZVR5cGUgPT09IDgpCgkgICAgICAgICAgICAgICAgICAgIGtvLm1lbW9pemF0aW9uLnVubWVtb2l6ZURvbU5vZGVBbmREZXNjZW5kYW50cyhub2RlLCBbYmluZGluZ0NvbnRleHRdKTsKCSAgICAgICAgICAgIH0pOwoKCSAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSBhbnkgY2hhbmdlcyBkb25lIGJ5IGFwcGx5QmluZGluZ3Mgb3IgdW5tZW1vaXplIGFyZSByZWZsZWN0ZWQgaW4gdGhlIGFycmF5CgkgICAgICAgICAgICBrby51dGlscy5maXhVcENvbnRpbnVvdXNOb2RlQXJyYXkoY29udGludW91c05vZGVBcnJheSwgcGFyZW50Tm9kZSk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KG5vZGVPck5vZGVBcnJheSkgewoJICAgICAgICByZXR1cm4gbm9kZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gbm9kZU9yTm9kZUFycmF5CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBub2RlT3JOb2RlQXJyYXkubGVuZ3RoID4gMCA/IG5vZGVPck5vZGVBcnJheVswXQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogbnVsbDsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGV4ZWN1dGVUZW1wbGF0ZSh0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlck1vZGUsIHRlbXBsYXRlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewoJICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgICAgICAgdmFyIGZpcnN0VGFyZ2V0Tm9kZSA9IHRhcmdldE5vZGVPck5vZGVBcnJheSAmJiBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheSh0YXJnZXROb2RlT3JOb2RlQXJyYXkpOwoJICAgICAgICB2YXIgdGVtcGxhdGVEb2N1bWVudCA9IGZpcnN0VGFyZ2V0Tm9kZSAmJiBmaXJzdFRhcmdldE5vZGUub3duZXJEb2N1bWVudDsKCSAgICAgICAgdmFyIHRlbXBsYXRlRW5naW5lVG9Vc2UgPSAob3B0aW9uc1sndGVtcGxhdGVFbmdpbmUnXSB8fCBfdGVtcGxhdGVFbmdpbmUpOwoJICAgICAgICBrby50ZW1wbGF0ZVJld3JpdGluZy5lbnN1cmVUZW1wbGF0ZUlzUmV3cml0dGVuKHRlbXBsYXRlLCB0ZW1wbGF0ZUVuZ2luZVRvVXNlLCB0ZW1wbGF0ZURvY3VtZW50KTsKCSAgICAgICAgdmFyIHJlbmRlcmVkTm9kZXNBcnJheSA9IHRlbXBsYXRlRW5naW5lVG9Vc2VbJ3JlbmRlclRlbXBsYXRlJ10odGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCB0ZW1wbGF0ZURvY3VtZW50KTsKCgkgICAgICAgIC8vIExvb3NlbHkgY2hlY2sgcmVzdWx0IGlzIGFuIGFycmF5IG9mIERPTSBub2RlcwoJICAgICAgICBpZiAoKHR5cGVvZiByZW5kZXJlZE5vZGVzQXJyYXkubGVuZ3RoICE9ICJudW1iZXIiKSB8fCAocmVuZGVyZWROb2Rlc0FycmF5Lmxlbmd0aCA+IDAgJiYgdHlwZW9mIHJlbmRlcmVkTm9kZXNBcnJheVswXS5ub2RlVHlwZSAhPSAibnVtYmVyIikpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRlbXBsYXRlIGVuZ2luZSBtdXN0IHJldHVybiBhbiBhcnJheSBvZiBET00gbm9kZXMiKTsKCgkgICAgICAgIHZhciBoYXZlQWRkZWROb2Rlc1RvUGFyZW50ID0gZmFsc2U7CgkgICAgICAgIHN3aXRjaCAocmVuZGVyTW9kZSkgewoJICAgICAgICAgICAgY2FzZSAicmVwbGFjZUNoaWxkcmVuIjoKCSAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyZWROb2Rlc0FycmF5KTsKCSAgICAgICAgICAgICAgICBoYXZlQWRkZWROb2Rlc1RvUGFyZW50ID0gdHJ1ZTsKCSAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgIGNhc2UgInJlcGxhY2VOb2RlIjoKCSAgICAgICAgICAgICAgICBrby51dGlscy5yZXBsYWNlRG9tTm9kZXModGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJlZE5vZGVzQXJyYXkpOwoJICAgICAgICAgICAgICAgIGhhdmVBZGRlZE5vZGVzVG9QYXJlbnQgPSB0cnVlOwoJICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgY2FzZSAiaWdub3JlVGFyZ2V0Tm9kZSI6IGJyZWFrOwoJICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gcmVuZGVyTW9kZTogIiArIHJlbmRlck1vZGUpOwoJICAgICAgICB9CgoJICAgICAgICBpZiAoaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCkgewoJICAgICAgICAgICAgYWN0aXZhdGVCaW5kaW5nc09uQ29udGludW91c05vZGVBcnJheShyZW5kZXJlZE5vZGVzQXJyYXksIGJpbmRpbmdDb250ZXh0KTsKCSAgICAgICAgICAgIGlmIChvcHRpb25zWydhZnRlclJlbmRlciddKQoJICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKG9wdGlvbnNbJ2FmdGVyUmVuZGVyJ10sIG51bGwsIFtyZW5kZXJlZE5vZGVzQXJyYXksIGJpbmRpbmdDb250ZXh0WyckZGF0YSddXSk7CgkgICAgICAgIH0KCgkgICAgICAgIHJldHVybiByZW5kZXJlZE5vZGVzQXJyYXk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiByZXNvbHZlVGVtcGxhdGVOYW1lKHRlbXBsYXRlLCBkYXRhLCBjb250ZXh0KSB7CgkgICAgICAgIC8vIFRoZSB0ZW1wbGF0ZSBjYW4gYmUgc3BlY2lmaWVkIGFzOgoJICAgICAgICBpZiAoa28uaXNPYnNlcnZhYmxlKHRlbXBsYXRlKSkgewoJICAgICAgICAgICAgLy8gMS4gQW4gb2JzZXJ2YWJsZSwgd2l0aCBzdHJpbmcgdmFsdWUKCSAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZSgpOwoJICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgLy8gMi4gQSBmdW5jdGlvbiBvZiAoZGF0YSwgY29udGV4dCkgcmV0dXJuaW5nIGEgc3RyaW5nCgkgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGUoZGF0YSwgY29udGV4dCk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAvLyAzLiBBIHN0cmluZwoJICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBrby5yZW5kZXJUZW1wbGF0ZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgZGF0YU9yQmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSkgewoJICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgICAgICAgaWYgKChvcHRpb25zWyd0ZW1wbGF0ZUVuZ2luZSddIHx8IF90ZW1wbGF0ZUVuZ2luZSkgPT0gdW5kZWZpbmVkKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTZXQgYSB0ZW1wbGF0ZSBlbmdpbmUgYmVmb3JlIGNhbGxpbmcgcmVuZGVyVGVtcGxhdGUiKTsKCSAgICAgICAgcmVuZGVyTW9kZSA9IHJlbmRlck1vZGUgfHwgInJlcGxhY2VDaGlsZHJlbiI7CgoJICAgICAgICBpZiAodGFyZ2V0Tm9kZU9yTm9kZUFycmF5KSB7CgkgICAgICAgICAgICB2YXIgZmlyc3RUYXJnZXROb2RlID0gZ2V0Rmlyc3ROb2RlRnJvbVBvc3NpYmxlQXJyYXkodGFyZ2V0Tm9kZU9yTm9kZUFycmF5KTsKCgkgICAgICAgICAgICB2YXIgd2hlblRvRGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICghZmlyc3RUYXJnZXROb2RlKSB8fCAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KGZpcnN0VGFyZ2V0Tm9kZSk7IH07IC8vIFBhc3NpdmUgZGlzcG9zYWwgKG9uIG5leHQgZXZhbHVhdGlvbikKCSAgICAgICAgICAgIHZhciBhY3RpdmVseURpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCA9IChmaXJzdFRhcmdldE5vZGUgJiYgcmVuZGVyTW9kZSA9PSAicmVwbGFjZU5vZGUiKSA/IGZpcnN0VGFyZ2V0Tm9kZS5wYXJlbnROb2RlIDogZmlyc3RUYXJnZXROb2RlOwoKCSAgICAgICAgICAgIHJldHVybiBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKCAvLyBTbyB0aGUgRE9NIGlzIGF1dG9tYXRpY2FsbHkgdXBkYXRlZCB3aGVuIGFueSBkZXBlbmRlbmN5IGNoYW5nZXMKCSAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3ZSd2ZSBnb3QgYSBwcm9wZXIgYmluZGluZyBjb250ZXh0IHRvIHdvcmsgd2l0aAoJICAgICAgICAgICAgICAgICAgICB2YXIgYmluZGluZ0NvbnRleHQgPSAoZGF0YU9yQmluZGluZ0NvbnRleHQgJiYgKGRhdGFPckJpbmRpbmdDb250ZXh0IGluc3RhbmNlb2Yga28uYmluZGluZ0NvbnRleHQpKQoJICAgICAgICAgICAgICAgICAgICAgICAgPyBkYXRhT3JCaW5kaW5nQ29udGV4dAoJICAgICAgICAgICAgICAgICAgICAgICAgOiBuZXcga28uYmluZGluZ0NvbnRleHQoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhT3JCaW5kaW5nQ29udGV4dCkpOwoKCSAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlTmFtZSA9IHJlc29sdmVUZW1wbGF0ZU5hbWUodGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0WyckZGF0YSddLCBiaW5kaW5nQ29udGV4dCksCgkgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJlZE5vZGVzQXJyYXkgPSBleGVjdXRlVGVtcGxhdGUodGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJNb2RlLCB0ZW1wbGF0ZU5hbWUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKTsKCgkgICAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJNb2RlID09ICJyZXBsYWNlTm9kZSIpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldE5vZGVPck5vZGVBcnJheSA9IHJlbmRlcmVkTm9kZXNBcnJheTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0VGFyZ2V0Tm9kZSA9IGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9LAoJICAgICAgICAgICAgICAgIG51bGwsCgkgICAgICAgICAgICAgICAgeyBkaXNwb3NlV2hlbjogd2hlblRvRGlzcG9zZSwgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBhY3RpdmVseURpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCB9CgkgICAgICAgICAgICApOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgLy8gV2UgZG9uJ3QgeWV0IGhhdmUgYSBET00gbm9kZSB0byBldmFsdWF0ZSwgc28gdXNlIGEgbWVtbyBhbmQgcmVuZGVyIHRoZSB0ZW1wbGF0ZSBsYXRlciB3aGVuIHRoZXJlIGlzIGEgRE9NIG5vZGUKCSAgICAgICAgICAgIHJldHVybiBrby5tZW1vaXphdGlvbi5tZW1vaXplKGZ1bmN0aW9uIChkb21Ob2RlKSB7CgkgICAgICAgICAgICAgICAga28ucmVuZGVyVGVtcGxhdGUodGVtcGxhdGUsIGRhdGFPckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCBkb21Ob2RlLCAicmVwbGFjZU5vZGUiKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9CgkgICAgfTsKCgkgICAga28ucmVuZGVyVGVtcGxhdGVGb3JFYWNoID0gZnVuY3Rpb24gKHRlbXBsYXRlLCBhcnJheU9yT2JzZXJ2YWJsZUFycmF5LCBvcHRpb25zLCB0YXJnZXROb2RlLCBwYXJlbnRCaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAvLyBTaW5jZSBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIGFsd2F5cyBjYWxscyBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0gYW5kIHRoZW4KCSAgICAgICAgLy8gYWN0aXZhdGVCaW5kaW5nc0NhbGxiYWNrIGZvciBhZGRlZCBpdGVtcywgd2UgY2FuIHN0b3JlIHRoZSBiaW5kaW5nIGNvbnRleHQgaW4gdGhlIGZvcm1lciB0byB1c2UgaW4gdGhlIGxhdHRlci4KCSAgICAgICAgdmFyIGFycmF5SXRlbUNvbnRleHQ7CgoJICAgICAgICAvLyBUaGlzIHdpbGwgYmUgY2FsbGVkIGJ5IHNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcgdG8gZ2V0IHRoZSBub2RlcyB0byBhZGQgdG8gdGFyZ2V0Tm9kZQoJICAgICAgICB2YXIgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtID0gZnVuY3Rpb24gKGFycmF5VmFsdWUsIGluZGV4KSB7CgkgICAgICAgICAgICAvLyBTdXBwb3J0IHNlbGVjdGluZyB0ZW1wbGF0ZSBhcyBhIGZ1bmN0aW9uIG9mIHRoZSBkYXRhIGJlaW5nIHJlbmRlcmVkCgkgICAgICAgICAgICBhcnJheUl0ZW1Db250ZXh0ID0gcGFyZW50QmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGFycmF5VmFsdWUsIG9wdGlvbnNbJ2FzJ10sIGZ1bmN0aW9uKGNvbnRleHQpIHsKCSAgICAgICAgICAgICAgICBjb250ZXh0WyckaW5kZXgnXSA9IGluZGV4OwoJICAgICAgICAgICAgfSk7CgoJICAgICAgICAgICAgdmFyIHRlbXBsYXRlTmFtZSA9IHJlc29sdmVUZW1wbGF0ZU5hbWUodGVtcGxhdGUsIGFycmF5VmFsdWUsIGFycmF5SXRlbUNvbnRleHQpOwoJICAgICAgICAgICAgcmV0dXJuIGV4ZWN1dGVUZW1wbGF0ZShudWxsLCAiaWdub3JlVGFyZ2V0Tm9kZSIsIHRlbXBsYXRlTmFtZSwgYXJyYXlJdGVtQ29udGV4dCwgb3B0aW9ucyk7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbmV2ZXIgc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyBoYXMgYWRkZWQgbm9kZXMgdG8gdGFyZ2V0Tm9kZQoJICAgICAgICB2YXIgYWN0aXZhdGVCaW5kaW5nc0NhbGxiYWNrID0gZnVuY3Rpb24oYXJyYXlWYWx1ZSwgYWRkZWROb2Rlc0FycmF5LCBpbmRleCkgewoJICAgICAgICAgICAgYWN0aXZhdGVCaW5kaW5nc09uQ29udGludW91c05vZGVBcnJheShhZGRlZE5vZGVzQXJyYXksIGFycmF5SXRlbUNvbnRleHQpOwoJICAgICAgICAgICAgaWYgKG9wdGlvbnNbJ2FmdGVyUmVuZGVyJ10pCgkgICAgICAgICAgICAgICAgb3B0aW9uc1snYWZ0ZXJSZW5kZXInXShhZGRlZE5vZGVzQXJyYXksIGFycmF5VmFsdWUpOwoJICAgICAgICB9OwoKCSAgICAgICAgcmV0dXJuIGtvLmRlcGVuZGVudE9ic2VydmFibGUoZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgdmFyIHVud3JhcHBlZEFycmF5ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShhcnJheU9yT2JzZXJ2YWJsZUFycmF5KSB8fCBbXTsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgdW53cmFwcGVkQXJyYXkubGVuZ3RoID09ICJ1bmRlZmluZWQiKSAvLyBDb2VyY2Ugc2luZ2xlIHZhbHVlIGludG8gYXJyYXkKCSAgICAgICAgICAgICAgICB1bndyYXBwZWRBcnJheSA9IFt1bndyYXBwZWRBcnJheV07CgoJICAgICAgICAgICAgLy8gRmlsdGVyIG91dCBhbnkgZW50cmllcyBtYXJrZWQgYXMgZGVzdHJveWVkCgkgICAgICAgICAgICB2YXIgZmlsdGVyZWRBcnJheSA9IGtvLnV0aWxzLmFycmF5RmlsdGVyKHVud3JhcHBlZEFycmF5LCBmdW5jdGlvbihpdGVtKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnNbJ2luY2x1ZGVEZXN0cm95ZWQnXSB8fCBpdGVtID09PSB1bmRlZmluZWQgfHwgaXRlbSA9PT0gbnVsbCB8fCAha28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShpdGVtWydfZGVzdHJveSddKTsKCSAgICAgICAgICAgIH0pOwoKCSAgICAgICAgICAgIC8vIENhbGwgc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZywgaWdub3JpbmcgYW55IG9ic2VydmFibGVzIHVud3JhcHBlZCB3aXRoaW4gKG1vc3QgbGlrZWx5IGZyb20gYSBjYWxsYmFjayBmdW5jdGlvbikuCgkgICAgICAgICAgICAvLyBJZiB0aGUgYXJyYXkgaXRlbXMgYXJlIG9ic2VydmFibGVzLCB0aG91Z2gsIHRoZXkgd2lsbCBiZSB1bndyYXBwZWQgaW4gZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtIGFuZCBtYW5hZ2VkIHdpdGhpbiBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nLgoJICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoa28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZywgbnVsbCwgW3RhcmdldE5vZGUsIGZpbHRlcmVkQXJyYXksIGV4ZWN1dGVUZW1wbGF0ZUZvckFycmF5SXRlbSwgb3B0aW9ucywgYWN0aXZhdGVCaW5kaW5nc0NhbGxiYWNrXSk7CgoJICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogdGFyZ2V0Tm9kZSB9KTsKCSAgICB9OwoKCSAgICB2YXIgdGVtcGxhdGVDb21wdXRlZERvbURhdGFLZXkgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCSAgICBmdW5jdGlvbiBkaXNwb3NlT2xkQ29tcHV0ZWRBbmRTdG9yZU5ld09uZShlbGVtZW50LCBuZXdDb21wdXRlZCkgewoJICAgICAgICB2YXIgb2xkQ29tcHV0ZWQgPSBrby51dGlscy5kb21EYXRhLmdldChlbGVtZW50LCB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSk7CgkgICAgICAgIGlmIChvbGRDb21wdXRlZCAmJiAodHlwZW9mKG9sZENvbXB1dGVkLmRpc3Bvc2UpID09ICdmdW5jdGlvbicpKQoJICAgICAgICAgICAgb2xkQ29tcHV0ZWQuZGlzcG9zZSgpOwoJICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSwgKG5ld0NvbXB1dGVkICYmIG5ld0NvbXB1dGVkLmlzQWN0aXZlKCkpID8gbmV3Q29tcHV0ZWQgOiB1bmRlZmluZWQpOwoJICAgIH0KCgkgICAga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddID0gewoJICAgICAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgICAgIC8vIFN1cHBvcnQgYW5vbnltb3VzIHRlbXBsYXRlcwoJICAgICAgICAgICAgdmFyIGJpbmRpbmdWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgYmluZGluZ1ZhbHVlID09ICJzdHJpbmciIHx8IGJpbmRpbmdWYWx1ZVsnbmFtZSddKSB7CgkgICAgICAgICAgICAgICAgLy8gSXQncyBhIG5hbWVkIHRlbXBsYXRlIC0gY2xlYXIgdGhlIGVsZW1lbnQKCSAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKGVsZW1lbnQpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAvLyBJdCdzIGFuIGFub255bW91cyB0ZW1wbGF0ZSAtIHN0b3JlIHRoZSBlbGVtZW50IGNvbnRlbnRzLCB0aGVuIGNsZWFyIHRoZSBlbGVtZW50CgkgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlTm9kZXMgPSBrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2RlcyhlbGVtZW50KSwKCSAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyID0ga28udXRpbHMubW92ZUNsZWFuZWROb2Rlc1RvQ29udGFpbmVyRWxlbWVudCh0ZW1wbGF0ZU5vZGVzKTsgLy8gVGhpcyBhbHNvIHJlbW92ZXMgdGhlIG5vZGVzIGZyb20gdGhlaXIgY3VycmVudCBwYXJlbnQKCSAgICAgICAgICAgICAgICBuZXcga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlKGVsZW1lbnQpWydub2RlcyddKGNvbnRhaW5lcik7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CgkgICAgICAgIH0sCgkgICAgICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgICAgIHZhciB2YWx1ZSA9IHZhbHVlQWNjZXNzb3IoKSwKCSAgICAgICAgICAgICAgICBkYXRhVmFsdWUsCgkgICAgICAgICAgICAgICAgb3B0aW9ucyA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWUpLAoJICAgICAgICAgICAgICAgIHNob3VsZERpc3BsYXkgPSB0cnVlLAoJICAgICAgICAgICAgICAgIHRlbXBsYXRlQ29tcHV0ZWQgPSBudWxsLAoJICAgICAgICAgICAgICAgIHRlbXBsYXRlTmFtZTsKCgkgICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT0gInN0cmluZyIpIHsKCSAgICAgICAgICAgICAgICB0ZW1wbGF0ZU5hbWUgPSB2YWx1ZTsKCSAgICAgICAgICAgICAgICBvcHRpb25zID0ge307CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIHRlbXBsYXRlTmFtZSA9IG9wdGlvbnNbJ25hbWUnXTsKCgkgICAgICAgICAgICAgICAgLy8gU3VwcG9ydCAiaWYiLyJpZm5vdCIgY29uZGl0aW9ucwoJICAgICAgICAgICAgICAgIGlmICgnaWYnIGluIG9wdGlvbnMpCgkgICAgICAgICAgICAgICAgICAgIHNob3VsZERpc3BsYXkgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9wdGlvbnNbJ2lmJ10pOwoJICAgICAgICAgICAgICAgIGlmIChzaG91bGREaXNwbGF5ICYmICdpZm5vdCcgaW4gb3B0aW9ucykKCSAgICAgICAgICAgICAgICAgICAgc2hvdWxkRGlzcGxheSA9ICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9wdGlvbnNbJ2lmbm90J10pOwoKCSAgICAgICAgICAgICAgICBkYXRhVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9wdGlvbnNbJ2RhdGEnXSk7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgaWYgKCdmb3JlYWNoJyBpbiBvcHRpb25zKSB7CgkgICAgICAgICAgICAgICAgLy8gUmVuZGVyIG9uY2UgZm9yIGVhY2ggZGF0YSBwb2ludCAodHJlYXRpbmcgZGF0YSBzZXQgYXMgZW1wdHkgaWYgc2hvdWxkRGlzcGxheT09ZmFsc2UpCgkgICAgICAgICAgICAgICAgdmFyIGRhdGFBcnJheSA9IChzaG91bGREaXNwbGF5ICYmIG9wdGlvbnNbJ2ZvcmVhY2gnXSkgfHwgW107CgkgICAgICAgICAgICAgICAgdGVtcGxhdGVDb21wdXRlZCA9IGtvLnJlbmRlclRlbXBsYXRlRm9yRWFjaCh0ZW1wbGF0ZU5hbWUgfHwgZWxlbWVudCwgZGF0YUFycmF5LCBvcHRpb25zLCBlbGVtZW50LCBiaW5kaW5nQ29udGV4dCk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKCFzaG91bGREaXNwbGF5KSB7CgkgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZShlbGVtZW50KTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gUmVuZGVyIG9uY2UgZm9yIHRoaXMgc2luZ2xlIGRhdGEgcG9pbnQgKG9yIHVzZSB0aGUgdmlld01vZGVsIGlmIG5vIGRhdGEgd2FzIHByb3ZpZGVkKQoJICAgICAgICAgICAgICAgIHZhciBpbm5lckJpbmRpbmdDb250ZXh0ID0gKCdkYXRhJyBpbiBvcHRpb25zKSA/CgkgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdDb250ZXh0WydjcmVhdGVDaGlsZENvbnRleHQnXShkYXRhVmFsdWUsIG9wdGlvbnNbJ2FzJ10pIDogIC8vIEdpdmVuIGFuIGV4cGxpdGl0ICdkYXRhJyB2YWx1ZSwgd2UgY3JlYXRlIGEgY2hpbGQgYmluZGluZyBjb250ZXh0IGZvciBpdAoJICAgICAgICAgICAgICAgICAgICBiaW5kaW5nQ29udGV4dDsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdpdmVuIG5vIGV4cGxpY2l0ICdkYXRhJyB2YWx1ZSwgd2UgcmV0YWluIHRoZSBzYW1lIGJpbmRpbmcgY29udGV4dAoJICAgICAgICAgICAgICAgIHRlbXBsYXRlQ29tcHV0ZWQgPSBrby5yZW5kZXJUZW1wbGF0ZSh0ZW1wbGF0ZU5hbWUgfHwgZWxlbWVudCwgaW5uZXJCaW5kaW5nQ29udGV4dCwgb3B0aW9ucywgZWxlbWVudCk7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gSXQgb25seSBtYWtlcyBzZW5zZSB0byBoYXZlIGEgc2luZ2xlIHRlbXBsYXRlIGNvbXB1dGVkIHBlciBlbGVtZW50IChvdGhlcndpc2Ugd2hpY2ggb25lIHNob3VsZCBoYXZlIGl0cyBvdXRwdXQgZGlzcGxheWVkPykKCSAgICAgICAgICAgIGRpc3Bvc2VPbGRDb21wdXRlZEFuZFN0b3JlTmV3T25lKGVsZW1lbnQsIHRlbXBsYXRlQ29tcHV0ZWQpOwoJICAgICAgICB9CgkgICAgfTsKCgkgICAgLy8gQW5vbnltb3VzIHRlbXBsYXRlcyBjYW4ndCBiZSByZXdyaXR0ZW4uIEdpdmUgYSBuaWNlIGVycm9yIG1lc3NhZ2UgaWYgeW91IHRyeSB0byBkbyBpdC4KCSAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9yc1sndGVtcGxhdGUnXSA9IGZ1bmN0aW9uKGJpbmRpbmdWYWx1ZSkgewoJICAgICAgICB2YXIgcGFyc2VkQmluZGluZ1ZhbHVlID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5wYXJzZU9iamVjdExpdGVyYWwoYmluZGluZ1ZhbHVlKTsKCgkgICAgICAgIGlmICgocGFyc2VkQmluZGluZ1ZhbHVlLmxlbmd0aCA9PSAxKSAmJiBwYXJzZWRCaW5kaW5nVmFsdWVbMF1bJ3Vua25vd24nXSkKCSAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBJdCBsb29rcyBsaWtlIGEgc3RyaW5nIGxpdGVyYWwsIG5vdCBhbiBvYmplY3QgbGl0ZXJhbCwgc28gdHJlYXQgaXQgYXMgYSBuYW1lZCB0ZW1wbGF0ZSAod2hpY2ggaXMgYWxsb3dlZCBmb3IgcmV3cml0aW5nKQoKCSAgICAgICAgaWYgKGtvLmV4cHJlc3Npb25SZXdyaXRpbmcua2V5VmFsdWVBcnJheUNvbnRhaW5zS2V5KHBhcnNlZEJpbmRpbmdWYWx1ZSwgIm5hbWUiKSkKCSAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBOYW1lZCB0ZW1wbGF0ZXMgY2FuIGJlIHJld3JpdHRlbiwgc28gcmV0dXJuICJubyBlcnJvciIKCSAgICAgICAgcmV0dXJuICJUaGlzIHRlbXBsYXRlIGVuZ2luZSBkb2VzIG5vdCBzdXBwb3J0IGFub255bW91cyB0ZW1wbGF0ZXMgbmVzdGVkIHdpdGhpbiBpdHMgdGVtcGxhdGVzIjsKCSAgICB9OwoKCSAgICBrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWyd0ZW1wbGF0ZSddID0gdHJ1ZTsKCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCdzZXRUZW1wbGF0ZUVuZ2luZScsIGtvLnNldFRlbXBsYXRlRW5naW5lKTsKCWtvLmV4cG9ydFN5bWJvbCgncmVuZGVyVGVtcGxhdGUnLCBrby5yZW5kZXJUZW1wbGF0ZSk7CgkvLyBHbyB0aHJvdWdoIHRoZSBpdGVtcyB0aGF0IGhhdmUgYmVlbiBhZGRlZCBhbmQgZGVsZXRlZCBhbmQgdHJ5IHRvIGZpbmQgbWF0Y2hlcyBiZXR3ZWVuIHRoZW0uCglrby51dGlscy5maW5kTW92ZXNJbkFycmF5Q29tcGFyaXNvbiA9IGZ1bmN0aW9uIChsZWZ0LCByaWdodCwgbGltaXRGYWlsZWRDb21wYXJlcykgewoJICAgIGlmIChsZWZ0Lmxlbmd0aCAmJiByaWdodC5sZW5ndGgpIHsKCSAgICAgICAgdmFyIGZhaWxlZENvbXBhcmVzLCBsLCByLCBsZWZ0SXRlbSwgcmlnaHRJdGVtOwoJICAgICAgICBmb3IgKGZhaWxlZENvbXBhcmVzID0gbCA9IDA7ICghbGltaXRGYWlsZWRDb21wYXJlcyB8fCBmYWlsZWRDb21wYXJlcyA8IGxpbWl0RmFpbGVkQ29tcGFyZXMpICYmIChsZWZ0SXRlbSA9IGxlZnRbbF0pOyArK2wpIHsKCSAgICAgICAgICAgIGZvciAociA9IDA7IHJpZ2h0SXRlbSA9IHJpZ2h0W3JdOyArK3IpIHsKCSAgICAgICAgICAgICAgICBpZiAobGVmdEl0ZW1bJ3ZhbHVlJ10gPT09IHJpZ2h0SXRlbVsndmFsdWUnXSkgewoJICAgICAgICAgICAgICAgICAgICBsZWZ0SXRlbVsnbW92ZWQnXSA9IHJpZ2h0SXRlbVsnaW5kZXgnXTsKCSAgICAgICAgICAgICAgICAgICAgcmlnaHRJdGVtWydtb3ZlZCddID0gbGVmdEl0ZW1bJ2luZGV4J107CgkgICAgICAgICAgICAgICAgICAgIHJpZ2h0LnNwbGljZShyLCAxKTsgICAgICAgICAvLyBUaGlzIGl0ZW0gaXMgbWFya2VkIGFzIG1vdmVkOyBzbyByZW1vdmUgaXQgZnJvbSByaWdodCBsaXN0CgkgICAgICAgICAgICAgICAgICAgIGZhaWxlZENvbXBhcmVzID0gciA9IDA7ICAgICAvLyBSZXNldCBmYWlsZWQgY29tcGFyZXMgY291bnQgYmVjYXVzZSB3ZSdyZSBjaGVja2luZyBmb3IgY29uc2VjdXRpdmUgZmFpbHVyZXMKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZmFpbGVkQ29tcGFyZXMgKz0gcjsKCSAgICAgICAgfQoJICAgIH0KCX07CgoJa28udXRpbHMuY29tcGFyZUFycmF5cyA9IChmdW5jdGlvbiAoKSB7CgkgICAgdmFyIHN0YXR1c05vdEluT2xkID0gJ2FkZGVkJywgc3RhdHVzTm90SW5OZXcgPSAnZGVsZXRlZCc7CgoJICAgIC8vIFNpbXBsZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBMZXZlbnNodGVpbiBkaXN0YW5jZS4KCSAgICBmdW5jdGlvbiBjb21wYXJlQXJyYXlzKG9sZEFycmF5LCBuZXdBcnJheSwgb3B0aW9ucykgewoJICAgICAgICAvLyBGb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgaWYgdGhlIHRoaXJkIGFyZyBpcyBhY3R1YWxseSBhIGJvb2wsIGludGVycHJldAoJICAgICAgICAvLyBpdCBhcyB0aGUgb2xkIHBhcmFtZXRlciAnZG9udExpbWl0TW92ZXMnLiBOZXdlciBjb2RlIHNob3VsZCB1c2UgeyBkb250TGltaXRNb3ZlczogdHJ1ZSB9LgoJICAgICAgICBvcHRpb25zID0gKHR5cGVvZiBvcHRpb25zID09PSAnYm9vbGVhbicpID8geyAnZG9udExpbWl0TW92ZXMnOiBvcHRpb25zIH0gOiAob3B0aW9ucyB8fCB7fSk7CgkgICAgICAgIG9sZEFycmF5ID0gb2xkQXJyYXkgfHwgW107CgkgICAgICAgIG5ld0FycmF5ID0gbmV3QXJyYXkgfHwgW107CgoJICAgICAgICBpZiAob2xkQXJyYXkubGVuZ3RoIDw9IG5ld0FycmF5Lmxlbmd0aCkKCSAgICAgICAgICAgIHJldHVybiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkob2xkQXJyYXksIG5ld0FycmF5LCBzdGF0dXNOb3RJbk9sZCwgc3RhdHVzTm90SW5OZXcsIG9wdGlvbnMpOwoJICAgICAgICBlbHNlCgkgICAgICAgICAgICByZXR1cm4gY29tcGFyZVNtYWxsQXJyYXlUb0JpZ0FycmF5KG5ld0FycmF5LCBvbGRBcnJheSwgc3RhdHVzTm90SW5OZXcsIHN0YXR1c05vdEluT2xkLCBvcHRpb25zKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNvbXBhcmVTbWFsbEFycmF5VG9CaWdBcnJheShzbWxBcnJheSwgYmlnQXJyYXksIHN0YXR1c05vdEluU21sLCBzdGF0dXNOb3RJbkJpZywgb3B0aW9ucykgewoJICAgICAgICB2YXIgbXlNaW4gPSBNYXRoLm1pbiwKCSAgICAgICAgICAgIG15TWF4ID0gTWF0aC5tYXgsCgkgICAgICAgICAgICBlZGl0RGlzdGFuY2VNYXRyaXggPSBbXSwKCSAgICAgICAgICAgIHNtbEluZGV4LCBzbWxJbmRleE1heCA9IHNtbEFycmF5Lmxlbmd0aCwKCSAgICAgICAgICAgIGJpZ0luZGV4LCBiaWdJbmRleE1heCA9IGJpZ0FycmF5Lmxlbmd0aCwKCSAgICAgICAgICAgIGNvbXBhcmVSYW5nZSA9IChiaWdJbmRleE1heCAtIHNtbEluZGV4TWF4KSB8fCAxLAoJICAgICAgICAgICAgbWF4RGlzdGFuY2UgPSBzbWxJbmRleE1heCArIGJpZ0luZGV4TWF4ICsgMSwKCSAgICAgICAgICAgIHRoaXNSb3csIGxhc3RSb3csCgkgICAgICAgICAgICBiaWdJbmRleE1heEZvclJvdywgYmlnSW5kZXhNaW5Gb3JSb3c7CgoJICAgICAgICBmb3IgKHNtbEluZGV4ID0gMDsgc21sSW5kZXggPD0gc21sSW5kZXhNYXg7IHNtbEluZGV4KyspIHsKCSAgICAgICAgICAgIGxhc3RSb3cgPSB0aGlzUm93OwoJICAgICAgICAgICAgZWRpdERpc3RhbmNlTWF0cml4LnB1c2godGhpc1JvdyA9IFtdKTsKCSAgICAgICAgICAgIGJpZ0luZGV4TWF4Rm9yUm93ID0gbXlNaW4oYmlnSW5kZXhNYXgsIHNtbEluZGV4ICsgY29tcGFyZVJhbmdlKTsKCSAgICAgICAgICAgIGJpZ0luZGV4TWluRm9yUm93ID0gbXlNYXgoMCwgc21sSW5kZXggLSAxKTsKCSAgICAgICAgICAgIGZvciAoYmlnSW5kZXggPSBiaWdJbmRleE1pbkZvclJvdzsgYmlnSW5kZXggPD0gYmlnSW5kZXhNYXhGb3JSb3c7IGJpZ0luZGV4KyspIHsKCSAgICAgICAgICAgICAgICBpZiAoIWJpZ0luZGV4KQoJICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IHNtbEluZGV4ICsgMTsKCSAgICAgICAgICAgICAgICBlbHNlIGlmICghc21sSW5kZXgpICAvLyBUb3Agcm93IC0gdHJhbnNmb3JtIGVtcHR5IGFycmF5IGludG8gbmV3IGFycmF5IHZpYSBhZGRpdGlvbnMKCSAgICAgICAgICAgICAgICAgICAgdGhpc1Jvd1tiaWdJbmRleF0gPSBiaWdJbmRleCArIDE7CgkgICAgICAgICAgICAgICAgZWxzZSBpZiAoc21sQXJyYXlbc21sSW5kZXggLSAxXSA9PT0gYmlnQXJyYXlbYmlnSW5kZXggLSAxXSkKCSAgICAgICAgICAgICAgICAgICAgdGhpc1Jvd1tiaWdJbmRleF0gPSBsYXN0Um93W2JpZ0luZGV4IC0gMV07ICAgICAgICAgICAgICAgICAgLy8gY29weSB2YWx1ZSAobm8gZWRpdCkKCSAgICAgICAgICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIG5vcnRoRGlzdGFuY2UgPSBsYXN0Um93W2JpZ0luZGV4XSB8fCBtYXhEaXN0YW5jZTsgICAgICAgLy8gbm90IGluIGJpZyAoZGVsZXRpb24pCgkgICAgICAgICAgICAgICAgICAgIHZhciB3ZXN0RGlzdGFuY2UgPSB0aGlzUm93W2JpZ0luZGV4IC0gMV0gfHwgbWF4RGlzdGFuY2U7ICAgIC8vIG5vdCBpbiBzbWFsbCAoYWRkaXRpb24pCgkgICAgICAgICAgICAgICAgICAgIHRoaXNSb3dbYmlnSW5kZXhdID0gbXlNaW4obm9ydGhEaXN0YW5jZSwgd2VzdERpc3RhbmNlKSArIDE7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICB2YXIgZWRpdFNjcmlwdCA9IFtdLCBtZU1pbnVzT25lLCBub3RJblNtbCA9IFtdLCBub3RJbkJpZyA9IFtdOwoJICAgICAgICBmb3IgKHNtbEluZGV4ID0gc21sSW5kZXhNYXgsIGJpZ0luZGV4ID0gYmlnSW5kZXhNYXg7IHNtbEluZGV4IHx8IGJpZ0luZGV4OykgewoJICAgICAgICAgICAgbWVNaW51c09uZSA9IGVkaXREaXN0YW5jZU1hdHJpeFtzbWxJbmRleF1bYmlnSW5kZXhdIC0gMTsKCSAgICAgICAgICAgIGlmIChiaWdJbmRleCAmJiBtZU1pbnVzT25lID09PSBlZGl0RGlzdGFuY2VNYXRyaXhbc21sSW5kZXhdW2JpZ0luZGV4LTFdKSB7CgkgICAgICAgICAgICAgICAgbm90SW5TbWwucHVzaChlZGl0U2NyaXB0W2VkaXRTY3JpcHQubGVuZ3RoXSA9IHsgICAgIC8vIGFkZGVkCgkgICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiBzdGF0dXNOb3RJblNtbCwKCSAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogYmlnQXJyYXlbLS1iaWdJbmRleF0sCgkgICAgICAgICAgICAgICAgICAgICdpbmRleCc6IGJpZ0luZGV4IH0pOwoJICAgICAgICAgICAgfSBlbHNlIGlmIChzbWxJbmRleCAmJiBtZU1pbnVzT25lID09PSBlZGl0RGlzdGFuY2VNYXRyaXhbc21sSW5kZXggLSAxXVtiaWdJbmRleF0pIHsKCSAgICAgICAgICAgICAgICBub3RJbkJpZy5wdXNoKGVkaXRTY3JpcHRbZWRpdFNjcmlwdC5sZW5ndGhdID0geyAgICAgLy8gZGVsZXRlZAoJICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJzogc3RhdHVzTm90SW5CaWcsCgkgICAgICAgICAgICAgICAgICAgICd2YWx1ZSc6IHNtbEFycmF5Wy0tc21sSW5kZXhdLAoJICAgICAgICAgICAgICAgICAgICAnaW5kZXgnOiBzbWxJbmRleCB9KTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLS1iaWdJbmRleDsKCSAgICAgICAgICAgICAgICAtLXNtbEluZGV4OwoJICAgICAgICAgICAgICAgIGlmICghb3B0aW9uc1snc3BhcnNlJ10pIHsKCSAgICAgICAgICAgICAgICAgICAgZWRpdFNjcmlwdC5wdXNoKHsKCSAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiAicmV0YWluZWQiLAoJICAgICAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogYmlnQXJyYXlbYmlnSW5kZXhdIH0pOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoKCSAgICAgICAgLy8gU2V0IGEgbGltaXQgb24gdGhlIG51bWJlciBvZiBjb25zZWN1dGl2ZSBub24tbWF0Y2hpbmcgY29tcGFyaXNvbnM7IGhhdmluZyBpdCBhIG11bHRpcGxlIG9mCgkgICAgICAgIC8vIHNtbEluZGV4TWF4IGtlZXBzIHRoZSB0aW1lIGNvbXBsZXhpdHkgb2YgdGhpcyBhbGdvcml0aG0gbGluZWFyLgoJICAgICAgICBrby51dGlscy5maW5kTW92ZXNJbkFycmF5Q29tcGFyaXNvbihub3RJblNtbCwgbm90SW5CaWcsIHNtbEluZGV4TWF4ICogMTApOwoKCSAgICAgICAgcmV0dXJuIGVkaXRTY3JpcHQucmV2ZXJzZSgpOwoJICAgIH0KCgkgICAgcmV0dXJuIGNvbXBhcmVBcnJheXM7Cgl9KSgpOwoKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuY29tcGFyZUFycmF5cycsIGtvLnV0aWxzLmNvbXBhcmVBcnJheXMpOwoJKGZ1bmN0aW9uICgpIHsKCSAgICAvLyBPYmplY3RpdmU6CgkgICAgLy8gKiBHaXZlbiBhbiBpbnB1dCBhcnJheSwgYSBjb250YWluZXIgRE9NIG5vZGUsIGFuZCBhIGZ1bmN0aW9uIGZyb20gYXJyYXkgZWxlbWVudHMgdG8gYXJyYXlzIG9mIERPTSBub2RlcywKCSAgICAvLyAgIG1hcCB0aGUgYXJyYXkgZWxlbWVudHMgdG8gYXJyYXlzIG9mIERPTSBub2RlcywgY29uY2F0ZW5hdGUgdG9nZXRoZXIgYWxsIHRoZXNlIGFycmF5cywgYW5kIHVzZSB0aGVtIHRvIHBvcHVsYXRlIHRoZSBjb250YWluZXIgRE9NIG5vZGUKCSAgICAvLyAqIE5leHQgdGltZSB3ZSdyZSBnaXZlbiB0aGUgc2FtZSBjb21iaW5hdGlvbiBvZiB0aGluZ3MgKHdpdGggdGhlIGFycmF5IHBvc3NpYmx5IGhhdmluZyBtdXRhdGVkKSwgdXBkYXRlIHRoZSBjb250YWluZXIgRE9NIG5vZGUKCSAgICAvLyAgIHNvIHRoYXQgaXRzIGNoaWxkcmVuIGlzIGFnYWluIHRoZSBjb25jYXRlbmF0aW9uIG9mIHRoZSBtYXBwaW5ncyBvZiB0aGUgYXJyYXkgZWxlbWVudHMsIGJ1dCBkb24ndCByZS1tYXAgYW55IGFycmF5IGVsZW1lbnRzIHRoYXQgd2UKCSAgICAvLyAgIHByZXZpb3VzbHkgbWFwcGVkIC0gcmV0YWluIHRob3NlIG5vZGVzLCBhbmQganVzdCBpbnNlcnQvZGVsZXRlIG90aGVyIG9uZXMKCgkgICAgLy8gImNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcyIgd2lsbCBiZSBpbnZva2VkIGFmdGVyIGFueSAibWFwcGluZyItZ2VuZXJhdGVkIG5vZGVzIGFyZSBpbnNlcnRlZCBpbnRvIHRoZSBjb250YWluZXIgbm9kZQoJICAgIC8vIFlvdSBjYW4gdXNlIHRoaXMsIGZvciBleGFtcGxlLCB0byBhY3RpdmF0ZSBiaW5kaW5ncyBvbiB0aG9zZSBub2Rlcy4KCgkgICAgZnVuY3Rpb24gbWFwTm9kZUFuZFJlZnJlc2hXaGVuQ2hhbmdlZChjb250YWluZXJOb2RlLCBtYXBwaW5nLCB2YWx1ZVRvTWFwLCBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMsIGluZGV4KSB7CgkgICAgICAgIC8vIE1hcCB0aGlzIGFycmF5IHZhbHVlIGluc2lkZSBhIGRlcGVuZGVudE9ic2VydmFibGUgc28gd2UgcmUtbWFwIHdoZW4gYW55IGRlcGVuZGVuY3kgY2hhbmdlcwoJICAgICAgICB2YXIgbWFwcGVkTm9kZXMgPSBbXTsKCSAgICAgICAgdmFyIGRlcGVuZGVudE9ic2VydmFibGUgPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgdmFyIG5ld01hcHBlZE5vZGVzID0gbWFwcGluZyh2YWx1ZVRvTWFwLCBpbmRleCwga28udXRpbHMuZml4VXBDb250aW51b3VzTm9kZUFycmF5KG1hcHBlZE5vZGVzLCBjb250YWluZXJOb2RlKSkgfHwgW107CgoJICAgICAgICAgICAgLy8gT24gc3Vic2VxdWVudCBldmFsdWF0aW9ucywganVzdCByZXBsYWNlIHRoZSBwcmV2aW91c2x5LWluc2VydGVkIERPTSBub2RlcwoJICAgICAgICAgICAgaWYgKG1hcHBlZE5vZGVzLmxlbmd0aCA+IDApIHsKCSAgICAgICAgICAgICAgICBrby51dGlscy5yZXBsYWNlRG9tTm9kZXMobWFwcGVkTm9kZXMsIG5ld01hcHBlZE5vZGVzKTsKCSAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKQoJICAgICAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZShjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMsIG51bGwsIFt2YWx1ZVRvTWFwLCBuZXdNYXBwZWROb2RlcywgaW5kZXhdKTsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAvLyBSZXBsYWNlIHRoZSBjb250ZW50cyBvZiB0aGUgbWFwcGVkTm9kZXMgYXJyYXksIHRoZXJlYnkgdXBkYXRpbmcgdGhlIHJlY29yZAoJICAgICAgICAgICAgLy8gb2Ygd2hpY2ggbm9kZXMgd291bGQgYmUgZGVsZXRlZCBpZiB2YWx1ZVRvTWFwIHdhcyBpdHNlbGYgbGF0ZXIgcmVtb3ZlZAoJICAgICAgICAgICAgbWFwcGVkTm9kZXMubGVuZ3RoID0gMDsKCSAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UHVzaEFsbChtYXBwZWROb2RlcywgbmV3TWFwcGVkTm9kZXMpOwoJICAgICAgICB9LCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogY29udGFpbmVyTm9kZSwgZGlzcG9zZVdoZW46IGZ1bmN0aW9uKCkgeyByZXR1cm4gIWtvLnV0aWxzLmFueURvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChtYXBwZWROb2Rlcyk7IH0gfSk7CgkgICAgICAgIHJldHVybiB7IG1hcHBlZE5vZGVzIDogbWFwcGVkTm9kZXMsIGRlcGVuZGVudE9ic2VydmFibGUgOiAoZGVwZW5kZW50T2JzZXJ2YWJsZS5pc0FjdGl2ZSgpID8gZGVwZW5kZW50T2JzZXJ2YWJsZSA6IHVuZGVmaW5lZCkgfTsKCSAgICB9CgoJICAgIHZhciBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXkgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCgkgICAga28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyA9IGZ1bmN0aW9uIChkb21Ob2RlLCBhcnJheSwgbWFwcGluZywgb3B0aW9ucywgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKSB7CgkgICAgICAgIC8vIENvbXBhcmUgdGhlIHByb3ZpZGVkIGFycmF5IGFnYWluc3QgdGhlIHByZXZpb3VzIG9uZQoJICAgICAgICBhcnJheSA9IGFycmF5IHx8IFtdOwoJICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgICAgICAgdmFyIGlzRmlyc3RFeGVjdXRpb24gPSBrby51dGlscy5kb21EYXRhLmdldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXkpID09PSB1bmRlZmluZWQ7CgkgICAgICAgIHZhciBsYXN0TWFwcGluZ1Jlc3VsdCA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KGRvbU5vZGUsIGxhc3RNYXBwaW5nUmVzdWx0RG9tRGF0YUtleSkgfHwgW107CgkgICAgICAgIHZhciBsYXN0QXJyYXkgPSBrby51dGlscy5hcnJheU1hcChsYXN0TWFwcGluZ1Jlc3VsdCwgZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHguYXJyYXlFbnRyeTsgfSk7CgkgICAgICAgIHZhciBlZGl0U2NyaXB0ID0ga28udXRpbHMuY29tcGFyZUFycmF5cyhsYXN0QXJyYXksIGFycmF5LCBvcHRpb25zWydkb250TGltaXRNb3ZlcyddKTsKCgkgICAgICAgIC8vIEJ1aWxkIHRoZSBuZXcgbWFwcGluZyByZXN1bHQKCSAgICAgICAgdmFyIG5ld01hcHBpbmdSZXN1bHQgPSBbXTsKCSAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwoJICAgICAgICB2YXIgbmV3TWFwcGluZ1Jlc3VsdEluZGV4ID0gMDsKCgkgICAgICAgIHZhciBub2Rlc1RvRGVsZXRlID0gW107CgkgICAgICAgIHZhciBpdGVtc1RvUHJvY2VzcyA9IFtdOwoJICAgICAgICB2YXIgaXRlbXNGb3JCZWZvcmVSZW1vdmVDYWxsYmFja3MgPSBbXTsKCSAgICAgICAgdmFyIGl0ZW1zRm9yTW92ZUNhbGxiYWNrcyA9IFtdOwoJICAgICAgICB2YXIgaXRlbXNGb3JBZnRlckFkZENhbGxiYWNrcyA9IFtdOwoJICAgICAgICB2YXIgbWFwRGF0YTsKCgkgICAgICAgIGZ1bmN0aW9uIGl0ZW1Nb3ZlZE9yUmV0YWluZWQoZWRpdFNjcmlwdEluZGV4LCBvbGRQb3NpdGlvbikgewoJICAgICAgICAgICAgbWFwRGF0YSA9IGxhc3RNYXBwaW5nUmVzdWx0W29sZFBvc2l0aW9uXTsKCSAgICAgICAgICAgIGlmIChuZXdNYXBwaW5nUmVzdWx0SW5kZXggIT09IG9sZFBvc2l0aW9uKQoJICAgICAgICAgICAgICAgIGl0ZW1zRm9yTW92ZUNhbGxiYWNrc1tlZGl0U2NyaXB0SW5kZXhdID0gbWFwRGF0YTsKCSAgICAgICAgICAgIC8vIFNpbmNlIHVwZGF0aW5nIHRoZSBpbmRleCBtaWdodCBjaGFuZ2UgdGhlIG5vZGVzLCBkbyBzbyBiZWZvcmUgY2FsbGluZyBmaXhVcENvbnRpbnVvdXNOb2RlQXJyYXkKCSAgICAgICAgICAgIG1hcERhdGEuaW5kZXhPYnNlcnZhYmxlKG5ld01hcHBpbmdSZXN1bHRJbmRleCsrKTsKCSAgICAgICAgICAgIGtvLnV0aWxzLmZpeFVwQ29udGludW91c05vZGVBcnJheShtYXBEYXRhLm1hcHBlZE5vZGVzLCBkb21Ob2RlKTsKCSAgICAgICAgICAgIG5ld01hcHBpbmdSZXN1bHQucHVzaChtYXBEYXRhKTsKCSAgICAgICAgICAgIGl0ZW1zVG9Qcm9jZXNzLnB1c2gobWFwRGF0YSk7CgkgICAgICAgIH0KCgkgICAgICAgIGZ1bmN0aW9uIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgaXRlbXMpIHsKCSAgICAgICAgICAgIGlmIChjYWxsYmFjaykgewoJICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBuID0gaXRlbXMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtc1tpXSkgewoJICAgICAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGl0ZW1zW2ldLm1hcHBlZE5vZGVzLCBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobm9kZSwgaSwgaXRlbXNbaV0uYXJyYXlFbnRyeSk7CgkgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoKCSAgICAgICAgZm9yICh2YXIgaSA9IDAsIGVkaXRTY3JpcHRJdGVtLCBtb3ZlZEluZGV4OyBlZGl0U2NyaXB0SXRlbSA9IGVkaXRTY3JpcHRbaV07IGkrKykgewoJICAgICAgICAgICAgbW92ZWRJbmRleCA9IGVkaXRTY3JpcHRJdGVtWydtb3ZlZCddOwoJICAgICAgICAgICAgc3dpdGNoIChlZGl0U2NyaXB0SXRlbVsnc3RhdHVzJ10pIHsKCSAgICAgICAgICAgICAgICBjYXNlICJkZWxldGVkIjoKCSAgICAgICAgICAgICAgICAgICAgaWYgKG1vdmVkSW5kZXggPT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgbWFwRGF0YSA9IGxhc3RNYXBwaW5nUmVzdWx0W2xhc3RNYXBwaW5nUmVzdWx0SW5kZXhdOwoKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgdHJhY2tpbmcgY2hhbmdlcyB0byB0aGUgbWFwcGluZyBmb3IgdGhlc2Ugbm9kZXMKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXBEYXRhLmRlcGVuZGVudE9ic2VydmFibGUpCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwRGF0YS5kZXBlbmRlbnRPYnNlcnZhYmxlLmRpc3Bvc2UoKTsKCgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBRdWV1ZSB0aGVzZSBub2RlcyBmb3IgbGF0ZXIgcmVtb3ZhbAoJICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb0RlbGV0ZS5wdXNoLmFwcGx5KG5vZGVzVG9EZWxldGUsIGtvLnV0aWxzLmZpeFVwQ29udGludW91c05vZGVBcnJheShtYXBEYXRhLm1hcHBlZE5vZGVzLCBkb21Ob2RlKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uc1snYmVmb3JlUmVtb3ZlJ10pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc0ZvckJlZm9yZVJlbW92ZUNhbGxiYWNrc1tpXSA9IG1hcERhdGE7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNUb1Byb2Nlc3MucHVzaChtYXBEYXRhKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBsYXN0TWFwcGluZ1Jlc3VsdEluZGV4Kys7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKCSAgICAgICAgICAgICAgICBjYXNlICJyZXRhaW5lZCI6CgkgICAgICAgICAgICAgICAgICAgIGl0ZW1Nb3ZlZE9yUmV0YWluZWQoaSwgbGFzdE1hcHBpbmdSZXN1bHRJbmRleCsrKTsKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgoJICAgICAgICAgICAgICAgIGNhc2UgImFkZGVkIjoKCSAgICAgICAgICAgICAgICAgICAgaWYgKG1vdmVkSW5kZXggIT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgaXRlbU1vdmVkT3JSZXRhaW5lZChpLCBtb3ZlZEluZGV4KTsKCSAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIG1hcERhdGEgPSB7IGFycmF5RW50cnk6IGVkaXRTY3JpcHRJdGVtWyd2YWx1ZSddLCBpbmRleE9ic2VydmFibGU6IGtvLm9ic2VydmFibGUobmV3TWFwcGluZ1Jlc3VsdEluZGV4KyspIH07CgkgICAgICAgICAgICAgICAgICAgICAgICBuZXdNYXBwaW5nUmVzdWx0LnB1c2gobWFwRGF0YSk7CgkgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc1RvUHJvY2Vzcy5wdXNoKG1hcERhdGEpOwoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0ZpcnN0RXhlY3V0aW9uKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zRm9yQWZ0ZXJBZGRDYWxsYmFja3NbaV0gPSBtYXBEYXRhOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICAvLyBDYWxsIGJlZm9yZU1vdmUgZmlyc3QgYmVmb3JlIGFueSBjaGFuZ2VzIGhhdmUgYmVlbiBtYWRlIHRvIHRoZSBET00KCSAgICAgICAgY2FsbENhbGxiYWNrKG9wdGlvbnNbJ2JlZm9yZU1vdmUnXSwgaXRlbXNGb3JNb3ZlQ2FsbGJhY2tzKTsKCgkgICAgICAgIC8vIE5leHQgcmVtb3ZlIG5vZGVzIGZvciBkZWxldGVkIGl0ZW1zIChvciBqdXN0IGNsZWFuIGlmIHRoZXJlJ3MgYSBiZWZvcmVSZW1vdmUgY2FsbGJhY2spCgkgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChub2Rlc1RvRGVsZXRlLCBvcHRpb25zWydiZWZvcmVSZW1vdmUnXSA/IGtvLmNsZWFuTm9kZSA6IGtvLnJlbW92ZU5vZGUpOwoKCSAgICAgICAgLy8gTmV4dCBhZGQvcmVvcmRlciB0aGUgcmVtYWluaW5nIGl0ZW1zICh3aWxsIGluY2x1ZGUgZGVsZXRlZCBpdGVtcyBpZiB0aGVyZSdzIGEgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrKQoJICAgICAgICBmb3IgKHZhciBpID0gMCwgbmV4dE5vZGUgPSBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZChkb21Ob2RlKSwgbGFzdE5vZGUsIG5vZGU7IG1hcERhdGEgPSBpdGVtc1RvUHJvY2Vzc1tpXTsgaSsrKSB7CgkgICAgICAgICAgICAvLyBHZXQgbm9kZXMgZm9yIG5ld2x5IGFkZGVkIGl0ZW1zCgkgICAgICAgICAgICBpZiAoIW1hcERhdGEubWFwcGVkTm9kZXMpCgkgICAgICAgICAgICAgICAga28udXRpbHMuZXh0ZW5kKG1hcERhdGEsIG1hcE5vZGVBbmRSZWZyZXNoV2hlbkNoYW5nZWQoZG9tTm9kZSwgbWFwcGluZywgbWFwRGF0YS5hcnJheUVudHJ5LCBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMsIG1hcERhdGEuaW5kZXhPYnNlcnZhYmxlKSk7CgoJICAgICAgICAgICAgLy8gUHV0IG5vZGVzIGluIHRoZSByaWdodCBwbGFjZSBpZiB0aGV5IGFyZW4ndCB0aGVyZSBhbHJlYWR5CgkgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgbm9kZSA9IG1hcERhdGEubWFwcGVkTm9kZXNbal07IG5leHROb2RlID0gbm9kZS5uZXh0U2libGluZywgbGFzdE5vZGUgPSBub2RlLCBqKyspIHsKCSAgICAgICAgICAgICAgICBpZiAobm9kZSAhPT0gbmV4dE5vZGUpCgkgICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcihkb21Ob2RlLCBub2RlLCBsYXN0Tm9kZSk7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gUnVuIHRoZSBjYWxsYmFja3MgZm9yIG5ld2x5IGFkZGVkIG5vZGVzIChmb3IgZXhhbXBsZSwgdG8gYXBwbHkgYmluZGluZ3MsIGV0Yy4pCgkgICAgICAgICAgICBpZiAoIW1hcERhdGEuaW5pdGlhbGl6ZWQgJiYgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKSB7CgkgICAgICAgICAgICAgICAgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKG1hcERhdGEuYXJyYXlFbnRyeSwgbWFwRGF0YS5tYXBwZWROb2RlcywgbWFwRGF0YS5pbmRleE9ic2VydmFibGUpOwoJICAgICAgICAgICAgICAgIG1hcERhdGEuaW5pdGlhbGl6ZWQgPSB0cnVlOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICAvLyBJZiB0aGVyZSdzIGEgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrLCBjYWxsIGl0IGFmdGVyIHJlb3JkZXJpbmcuCgkgICAgICAgIC8vIE5vdGUgdGhhdCB3ZSBhc3N1bWUgdGhhdCB0aGUgYmVmb3JlUmVtb3ZlIGNhbGxiYWNrIHdpbGwgdXN1YWxseSBiZSB1c2VkIHRvIHJlbW92ZSB0aGUgbm9kZXMgdXNpbmcKCSAgICAgICAgLy8gc29tZSBzb3J0IG9mIGFuaW1hdGlvbiwgd2hpY2ggaXMgd2h5IHdlIGZpcnN0IHJlb3JkZXIgdGhlIG5vZGVzIHRoYXQgd2lsbCBiZSByZW1vdmVkLiBJZiB0aGUKCSAgICAgICAgLy8gY2FsbGJhY2sgaW5zdGVhZCByZW1vdmVzIHRoZSBub2RlcyByaWdodCBhd2F5LCBpdCB3b3VsZCBiZSBtb3JlIGVmZmljaWVudCB0byBza2lwIHJlb3JkZXJpbmcgdGhlbS4KCSAgICAgICAgLy8gUGVyaGFwcyB3ZSdsbCBtYWtlIHRoYXQgY2hhbmdlIGluIHRoZSBmdXR1cmUgaWYgdGhpcyBzY2VuYXJpbyBiZWNvbWVzIG1vcmUgY29tbW9uLgoJICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYmVmb3JlUmVtb3ZlJ10sIGl0ZW1zRm9yQmVmb3JlUmVtb3ZlQ2FsbGJhY2tzKTsKCgkgICAgICAgIC8vIEZpbmFsbHkgY2FsbCBhZnRlck1vdmUgYW5kIGFmdGVyQWRkIGNhbGxiYWNrcwoJICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYWZ0ZXJNb3ZlJ10sIGl0ZW1zRm9yTW92ZUNhbGxiYWNrcyk7CgkgICAgICAgIGNhbGxDYWxsYmFjayhvcHRpb25zWydhZnRlckFkZCddLCBpdGVtc0ZvckFmdGVyQWRkQ2FsbGJhY2tzKTsKCgkgICAgICAgIC8vIFN0b3JlIGEgY29weSBvZiB0aGUgYXJyYXkgaXRlbXMgd2UganVzdCBjb25zaWRlcmVkIHNvIHdlIGNhbiBkaWZmZXJlbmNlIGl0IG5leHQgdGltZQoJICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXksIG5ld01hcHBpbmdSZXN1bHQpOwoJICAgIH0KCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nJywga28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyk7Cglrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSA9IGZ1bmN0aW9uICgpIHsKCSAgICB0aGlzWydhbGxvd1RlbXBsYXRlUmV3cml0aW5nJ10gPSBmYWxzZTsKCX0KCglrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGUgPSBuZXcga28udGVtcGxhdGVFbmdpbmUoKTsKCWtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lOwoJa28ubmF0aXZlVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddID0gZnVuY3Rpb24gKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewoJICAgIHZhciB1c2VOb2Rlc0lmQXZhaWxhYmxlID0gIShrby51dGlscy5pZVZlcnNpb24gPCA5KSwgLy8gSUU8OSBjbG9uZU5vZGUgZG9lc24ndCB3b3JrIHByb3Blcmx5CgkgICAgICAgIHRlbXBsYXRlTm9kZXNGdW5jID0gdXNlTm9kZXNJZkF2YWlsYWJsZSA/IHRlbXBsYXRlU291cmNlWydub2RlcyddIDogbnVsbCwKCSAgICAgICAgdGVtcGxhdGVOb2RlcyA9IHRlbXBsYXRlTm9kZXNGdW5jID8gdGVtcGxhdGVTb3VyY2VbJ25vZGVzJ10oKSA6IG51bGw7CgoJICAgIGlmICh0ZW1wbGF0ZU5vZGVzKSB7CgkgICAgICAgIHJldHVybiBrby51dGlscy5tYWtlQXJyYXkodGVtcGxhdGVOb2Rlcy5jbG9uZU5vZGUodHJ1ZSkuY2hpbGROb2Rlcyk7CgkgICAgfSBlbHNlIHsKCSAgICAgICAgdmFyIHRlbXBsYXRlVGV4dCA9IHRlbXBsYXRlU291cmNlWyd0ZXh0J10oKTsKCSAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KHRlbXBsYXRlVGV4dCk7CgkgICAgfQoJfTsKCglrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSA9IG5ldyBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSgpOwoJa28uc2V0VGVtcGxhdGVFbmdpbmUoa28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UpOwoKCWtvLmV4cG9ydFN5bWJvbCgnbmF0aXZlVGVtcGxhdGVFbmdpbmUnLCBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSk7CgkoZnVuY3Rpb24oKSB7CgkgICAga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAvLyBEZXRlY3Qgd2hpY2ggdmVyc2lvbiBvZiBqcXVlcnktdG1wbCB5b3UncmUgdXNpbmcuIFVuZm9ydHVuYXRlbHkganF1ZXJ5LXRtcGwKCSAgICAgICAgLy8gZG9lc24ndCBleHBvc2UgYSB2ZXJzaW9uIG51bWJlciwgc28gd2UgaGF2ZSB0byBpbmZlciBpdC4KCSAgICAgICAgLy8gTm90ZSB0aGF0IGFzIG9mIEtub2Nrb3V0IDEuMywgd2Ugb25seSBzdXBwb3J0IGpRdWVyeS50bXBsIDEuMC4wcHJlIGFuZCBsYXRlciwKCSAgICAgICAgLy8gd2hpY2ggS08gaW50ZXJuYWxseSByZWZlcnMgdG8gYXMgdmVyc2lvbiAiMiIsIHNvIG9sZGVyIHZlcnNpb25zIGFyZSBubyBsb25nZXIgZGV0ZWN0ZWQuCgkgICAgICAgIHZhciBqUXVlcnlUbXBsVmVyc2lvbiA9IHRoaXMualF1ZXJ5VG1wbFZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICBpZiAoIWpRdWVyeUluc3RhbmNlIHx8ICEoalF1ZXJ5SW5zdGFuY2VbJ3RtcGwnXSkpCgkgICAgICAgICAgICAgICAgcmV0dXJuIDA7CgkgICAgICAgICAgICAvLyBTaW5jZSBpdCBleHBvc2VzIG5vIG9mZmljaWFsIHZlcnNpb24gbnVtYmVyLCB3ZSB1c2Ugb3VyIG93biBudW1iZXJpbmcgc3lzdGVtLiBUbyBiZSB1cGRhdGVkIGFzIGpxdWVyeS10bXBsIGV2b2x2ZXMuCgkgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgIGlmIChqUXVlcnlJbnN0YW5jZVsndG1wbCddWyd0YWcnXVsndG1wbCddWydvcGVuJ10udG9TdHJpbmcoKS5pbmRleE9mKCdfXycpID49IDApIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gU2luY2UgMS4wLjBwcmUsIGN1c3RvbSB0YWdzIHNob3VsZCBhcHBlbmQgbWFya3VwIHRvIGFuIGFycmF5IGNhbGxlZCAiX18iCgkgICAgICAgICAgICAgICAgICAgIHJldHVybiAyOyAvLyBGaW5hbCB2ZXJzaW9uIG9mIGpxdWVyeS50bXBsCgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSBjYXRjaChleCkgeyAvKiBBcHBhcmVudGx5IG5vdCB0aGUgdmVyc2lvbiB3ZSB3ZXJlIGxvb2tpbmcgZm9yICovIH0KCgkgICAgICAgICAgICByZXR1cm4gMTsgLy8gQW55IG9sZGVyIHZlcnNpb24gdGhhdCB3ZSBkb24ndCBzdXBwb3J0CgkgICAgICAgIH0pKCk7CgoJICAgICAgICBmdW5jdGlvbiBlbnN1cmVIYXNSZWZlcmVuY2VkSlF1ZXJ5VGVtcGxhdGVzKCkgewoJICAgICAgICAgICAgaWYgKGpRdWVyeVRtcGxWZXJzaW9uIDwgMikKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIllvdXIgdmVyc2lvbiBvZiBqUXVlcnkudG1wbCBpcyB0b28gb2xkLiBQbGVhc2UgdXBncmFkZSB0byBqUXVlcnkudG1wbCAxLjAuMHByZSBvciBsYXRlci4iKTsKCSAgICAgICAgfQoKCSAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZVRlbXBsYXRlKGNvbXBpbGVkVGVtcGxhdGUsIGRhdGEsIGpRdWVyeVRlbXBsYXRlT3B0aW9ucykgewoJICAgICAgICAgICAgcmV0dXJuIGpRdWVyeUluc3RhbmNlWyd0bXBsJ10oY29tcGlsZWRUZW1wbGF0ZSwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKTsKCSAgICAgICAgfQoKCSAgICAgICAgdGhpc1sncmVuZGVyVGVtcGxhdGVTb3VyY2UnXSA9IGZ1bmN0aW9uKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewoJICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkgICAgICAgICAgICBlbnN1cmVIYXNSZWZlcmVuY2VkSlF1ZXJ5VGVtcGxhdGVzKCk7CgoJICAgICAgICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgc3RvcmVkIGEgcHJlY29tcGlsZWQgdmVyc2lvbiBvZiB0aGlzIHRlbXBsYXRlIChkb24ndCB3YW50IHRvIHJlcGFyc2Ugb24gZXZlcnkgcmVuZGVyKQoJICAgICAgICAgICAgdmFyIHByZWNvbXBpbGVkID0gdGVtcGxhdGVTb3VyY2VbJ2RhdGEnXSgncHJlY29tcGlsZWQnKTsKCSAgICAgICAgICAgIGlmICghcHJlY29tcGlsZWQpIHsKCSAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVUZXh0ID0gdGVtcGxhdGVTb3VyY2VbJ3RleHQnXSgpIHx8ICIiOwoJICAgICAgICAgICAgICAgIC8vIFdyYXAgaW4gIndpdGgoJHdoYXRldmVyLmtvQmluZGluZ0NvbnRleHQpIHsgLi4uIH0iCgkgICAgICAgICAgICAgICAgdGVtcGxhdGVUZXh0ID0gInt7a29fd2l0aCAkaXRlbS5rb0JpbmRpbmdDb250ZXh0fX0iICsgdGVtcGxhdGVUZXh0ICsgInt7L2tvX3dpdGh9fSI7CgoJICAgICAgICAgICAgICAgIHByZWNvbXBpbGVkID0galF1ZXJ5SW5zdGFuY2VbJ3RlbXBsYXRlJ10obnVsbCwgdGVtcGxhdGVUZXh0KTsKCSAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcsIHByZWNvbXBpbGVkKTsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICB2YXIgZGF0YSA9IFtiaW5kaW5nQ29udGV4dFsnJGRhdGEnXV07IC8vIFByZXdyYXAgdGhlIGRhdGEgaW4gYW4gYXJyYXkgdG8gc3RvcCBqcXVlcnkudG1wbCBmcm9tIHRyeWluZyB0byB1bndyYXAgYW55IGFycmF5cwoJICAgICAgICAgICAgdmFyIGpRdWVyeVRlbXBsYXRlT3B0aW9ucyA9IGpRdWVyeUluc3RhbmNlWydleHRlbmQnXSh7ICdrb0JpbmRpbmdDb250ZXh0JzogYmluZGluZ0NvbnRleHQgfSwgb3B0aW9uc1sndGVtcGxhdGVPcHRpb25zJ10pOwoKCSAgICAgICAgICAgIHZhciByZXN1bHROb2RlcyA9IGV4ZWN1dGVUZW1wbGF0ZShwcmVjb21waWxlZCwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKTsKCSAgICAgICAgICAgIHJlc3VsdE5vZGVzWydhcHBlbmRUbyddKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpKTsgLy8gVXNpbmcgImFwcGVuZFRvIiBmb3JjZXMgalF1ZXJ5L2pRdWVyeS50bXBsIHRvIHBlcmZvcm0gbmVjZXNzYXJ5IGNsZWFudXAgd29yawoKCSAgICAgICAgICAgIGpRdWVyeUluc3RhbmNlWydmcmFnbWVudHMnXSA9IHt9OyAvLyBDbGVhciBqUXVlcnkncyBmcmFnbWVudCBjYWNoZSB0byBhdm9pZCBhIG1lbW9yeSBsZWFrIGFmdGVyIGEgbGFyZ2UgbnVtYmVyIG9mIHRlbXBsYXRlIHJlbmRlcnMKCSAgICAgICAgICAgIHJldHVybiByZXN1bHROb2RlczsKCSAgICAgICAgfTsKCgkgICAgICAgIHRoaXNbJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jayddID0gZnVuY3Rpb24oc2NyaXB0KSB7CgkgICAgICAgICAgICByZXR1cm4gInt7a29fY29kZSAoKGZ1bmN0aW9uKCkgeyByZXR1cm4gIiArIHNjcmlwdCArICIgfSkoKSkgfX0iOwoJICAgICAgICB9OwoKCSAgICAgICAgdGhpc1snYWRkVGVtcGxhdGUnXSA9IGZ1bmN0aW9uKHRlbXBsYXRlTmFtZSwgdGVtcGxhdGVNYXJrdXApIHsKCSAgICAgICAgICAgIGRvY3VtZW50LndyaXRlKCI8c2NyaXB0IHR5cGU9J3RleHQvaHRtbCcgaWQ9JyIgKyB0ZW1wbGF0ZU5hbWUgKyAiJz4iICsgdGVtcGxhdGVNYXJrdXAgKyAiPCIgKyAiL3NjcmlwdD4iKTsKCSAgICAgICAgfTsKCgkgICAgICAgIGlmIChqUXVlcnlUbXBsVmVyc2lvbiA+IDApIHsKCSAgICAgICAgICAgIGpRdWVyeUluc3RhbmNlWyd0bXBsJ11bJ3RhZyddWydrb19jb2RlJ10gPSB7CgkgICAgICAgICAgICAgICAgb3BlbjogIl9fLnB1c2goJDEgfHwgJycpOyIKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICBqUXVlcnlJbnN0YW5jZVsndG1wbCddWyd0YWcnXVsna29fd2l0aCddID0gewoJICAgICAgICAgICAgICAgIG9wZW46ICJ3aXRoKCQxKSB7IiwKCSAgICAgICAgICAgICAgICBjbG9zZTogIn0gIgoJICAgICAgICAgICAgfTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIGtvLmpxdWVyeVRtcGxUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGUgPSBuZXcga28udGVtcGxhdGVFbmdpbmUoKTsKCSAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0ga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lOwoKCSAgICAvLyBVc2UgdGhpcyBvbmUgYnkgZGVmYXVsdCAqb25seSBpZiBqcXVlcnkudG1wbCBpcyByZWZlcmVuY2VkKgoJICAgIHZhciBqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZSA9IG5ldyBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUoKTsKCSAgICBpZiAoanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lSW5zdGFuY2UualF1ZXJ5VG1wbFZlcnNpb24gPiAwKQoJICAgICAgICBrby5zZXRUZW1wbGF0ZUVuZ2luZShqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZSk7CgoJICAgIGtvLmV4cG9ydFN5bWJvbCgnanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lJywga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lKTsKCX0pKCk7Cgl9KSk7Cgl9KCkpOwoJfSkoKTsKCgovKioqLyB9Ci8qKioqKiovIF0pCn0pOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 08:09:48 GMT",
                    "Content-Length": "497183",
                    "Date": "Fri, 07 Nov 2014 08:09:49 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}