{
    "url": "http://localhost:9999/marcorinck/jquery-mobile-iscrollview/demo/build/javascripts/jquery.mobile-1.1.2.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.href</b> via the following statement:<ul><li>location.href = location.href.replace( /#.*/, '' ) + history_hash;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/marcorinck/jquery-mobile-iscrollview/demo/build/javascripts/jquery.mobile-1.1.2.js",
                "path": "/marcorinck/jquery-mobile-iscrollview/demo/build/javascripts/jquery.mobile-1.1.2.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9tYXJjb3JpbmNrL2pxdWVyeS1tb2JpbGUtaXNjcm9sbHZpZXcvZGVtby9idWlsZC9qYXZhc2NyaXB0cy9qcXVlcnkubW9iaWxlLTEuMS4yLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjUxMDg4DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA2OjQ5OjQzIEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwNjo0OTo0MyBHTVQNCg0KLyoKKiBqUXVlcnkgTW9iaWxlIEZyYW1ld29yayAxLjEuMiA5YTE1ZjFhYWY5OWZhYTc5MTMxMDNmNWVhMTllZjY5NTliNzNkNzYzCiogaHR0cDovL2pxdWVyeW1vYmlsZS5jb20KKgoqIENvcHlyaWdodCAyMDEwLCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMKKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCgooZnVuY3Rpb24gKCByb290LCBkb2MsIGZhY3RvcnkgKSB7CglpZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCQkvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUuCgkJZGVmaW5lKCBbICJqcXVlcnkiIF0sIGZ1bmN0aW9uICggJCApIHsKCQkJZmFjdG9yeSggJCwgcm9vdCwgZG9jICk7CgkJCXJldHVybiAkLm1vYmlsZTsKCQl9KTsKCX0gZWxzZSB7CgkJLy8gQnJvd3NlciBnbG9iYWxzCgkJZmFjdG9yeSggcm9vdC5qUXVlcnksIHJvb3QsIGRvYyApOwoJfQp9KCB0aGlzLCBkb2N1bWVudCwgZnVuY3Rpb24gKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKCgovLyBUaGlzIHBsdWdpbiBpcyBhbiBleHBlcmltZW50IGZvciBhYnN0cmFjdGluZyBhd2F5IHRoZSB0b3VjaCBhbmQgbW91c2UKLy8gZXZlbnRzIHNvIHRoYXQgZGV2ZWxvcGVycyBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IHdoaWNoIG1ldGhvZCBvZiBpbnB1dAovLyB0aGUgZGV2aWNlIHRoZWlyIGRvY3VtZW50IGlzIGxvYWRlZCBvbiBzdXBwb3J0cy4KLy8KLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBhbGxvdyB0aGUgZGV2ZWxvcGVyIHRvIHJlZ2lzdGVyIGxpc3RlbmVycyBmb3IgdGhlCi8vIGJhc2ljIG1vdXNlIGV2ZW50cywgc3VjaCBhcyBtb3VzZWRvd24sIG1vdXNlbW92ZSwgbW91c2V1cCwgYW5kIGNsaWNrLAovLyBhbmQgdGhlIHBsdWdpbiB3aWxsIHRha2UgY2FyZSBvZiByZWdpc3RlcmluZyB0aGUgY29ycmVjdCBsaXN0ZW5lcnMKLy8gYmVoaW5kIHRoZSBzY2VuZXMgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciBhdCB0aGUgZmFzdGVzdCBwb3NzaWJsZSB0aW1lCi8vIGZvciB0aGF0IGRldmljZSwgd2hpbGUgc3RpbGwgcmV0YWluaW5nIHRoZSBvcmRlciBvZiBldmVudCBmaXJpbmcgaW4KLy8gdGhlIHRyYWRpdGlvbmFsIG1vdXNlIGVudmlyb25tZW50LCBzaG91bGQgbXVsdGlwbGUgaGFuZGxlcnMgYmUgcmVnaXN0ZXJlZAovLyBvbiB0aGUgc2FtZSBlbGVtZW50IGZvciBkaWZmZXJlbnQgZXZlbnRzLgovLwovLyBUaGUgY3VycmVudCB2ZXJzaW9uIGV4cG9zZXMgdGhlIGZvbGxvd2luZyB2aXJ0dWFsIGV2ZW50cyB0byBqUXVlcnkgYmluZCBtZXRob2RzOgovLyAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiCgooZnVuY3Rpb24oICQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKCnZhciBkYXRhUHJvcGVydHlOYW1lID0gInZpcnR1YWxNb3VzZUJpbmRpbmdzIiwKCXRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lID0gInZpcnR1YWxUb3VjaElEIiwKCXZpcnR1YWxFdmVudE5hbWVzID0gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIi5zcGxpdCggIiAiICksCgl0b3VjaEV2ZW50UHJvcHMgPSAiY2xpZW50WCBjbGllbnRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSIuc3BsaXQoICIgIiApLAoJbW91c2VIb29rUHJvcHMgPSAkLmV2ZW50Lm1vdXNlSG9va3MgPyAkLmV2ZW50Lm1vdXNlSG9va3MucHJvcHMgOiBbXSwKCW1vdXNlRXZlbnRQcm9wcyA9ICQuZXZlbnQucHJvcHMuY29uY2F0KCBtb3VzZUhvb2tQcm9wcyApLAoJYWN0aXZlRG9jSGFuZGxlcnMgPSB7fSwKCXJlc2V0VGltZXJJRCA9IDAsCglzdGFydFggPSAwLAoJc3RhcnRZID0gMCwKCWRpZFNjcm9sbCA9IGZhbHNlLAoJY2xpY2tCbG9ja0xpc3QgPSBbXSwKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlLAoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2UsCglldmVudENhcHR1cmVTdXBwb3J0ZWQgPSAiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZG9jdW1lbnQsCgkkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJbmV4dFRvdWNoSUQgPSAxLAoJbGFzdFRvdWNoSUQgPSAwOwoKJC52bW91c2UgPSB7Cgltb3ZlRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJY2xpY2tEaXN0YW5jZVRocmVzaG9sZDogMTAsCglyZXNldFRpbWVyRHVyYXRpb246IDE1MDAKfTsKCmZ1bmN0aW9uIGdldE5hdGl2ZUV2ZW50KCBldmVudCApIHsKCgl3aGlsZSAoIGV2ZW50ICYmIHR5cGVvZiBldmVudC5vcmlnaW5hbEV2ZW50ICE9PSAidW5kZWZpbmVkIiApIHsKCQlldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cgl9CglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApIHsKCgl2YXIgdCA9IGV2ZW50LnR5cGUsCgkJb2UsIHByb3BzLCBuZSwgcHJvcCwgY3QsIHRvdWNoLCBpLCBqOwoKCWV2ZW50ID0gJC5FdmVudChldmVudCk7CglldmVudC50eXBlID0gZXZlbnRUeXBlOwoKCW9lID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCXByb3BzID0gJC5ldmVudC5wcm9wczsKCgkvLyBhZGRyZXNzZXMgc2VwYXJhdGlvbiBvZiAkLmV2ZW50LnByb3BzIGluIHRvICQuZXZlbnQubW91c2VIb29rLnByb3BzIGFuZCBJc3N1ZSAzMjgwCgkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzMyODAKCWlmICggdC5zZWFyY2goIC9eKG1vdXNlfGNsaWNrKS8gKSA+IC0xICkgewoJCXByb3BzID0gbW91c2VFdmVudFByb3BzOwoJfQoKCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkvLyBidXQgd2UgZG9uJ3QgaGF2ZSBhIHdheSB0byBmb3JjZSBhbiBldmVudCB0byBiZSBmaXhlZCBtdWx0aXBsZSB0aW1lcwoJaWYgKCBvZSApIHsKCQlmb3IgKCBpID0gcHJvcHMubGVuZ3RoLCBwcm9wOyBpOyApIHsKCQkJcHJvcCA9IHByb3BzWyAtLWkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9lWyBwcm9wIF07CgkJfQoJfQoKCS8vIG1ha2Ugc3VyZSB0aGF0IGlmIHRoZSBtb3VzZSBhbmQgY2xpY2sgdmlydHVhbCBldmVudHMgYXJlIGdlbmVyYXRlZAoJLy8gd2l0aG91dCBhIC53aGljaCBvbmUgaXMgZGVmaW5lZAoJaWYgKCB0LnNlYXJjaCgvbW91c2UoZG93bnx1cCl8Y2xpY2svKSA+IC0xICYmICFldmVudC53aGljaCApewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoY3QgJiYgY3QubGVuZ3RoKSA/IGN0WyAwIF0gOiB1bmRlZmluZWQgKTsKCgkJaWYgKCB0b3VjaCApIHsKCQkJZm9yICggaiA9IDAsIGxlbiA9IHRvdWNoRXZlbnRQcm9wcy5sZW5ndGg7IGogPCBsZW47IGorKyl7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgkJcmVzZXRUaW1lcklEID0gMDsKCQllbmFibGVNb3VzZUJpbmRpbmdzKCk7Cgl9LCAkLnZtb3VzZS5yZXNldFRpbWVyRHVyYXRpb24gKTsKfQoKZnVuY3Rpb24gY2xlYXJSZXNldFRpbWVyKCkgewoJaWYgKCByZXNldFRpbWVySUQgKXsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKGV2ZW50LnRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUpOwoKCWlmICggIWJsb2NrTW91c2VUcmlnZ2VycyAmJiAoICFsYXN0VG91Y2hJRCB8fCBsYXN0VG91Y2hJRCAhPT0gdG91Y2hJRCApICl7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInYiICsgZXZlbnQudHlwZSwgZXZlbnQgKTsKCQlpZiAoIHZlICkgewoJCQlpZiAoIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCQlpZiAoIHZlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCQlpZiAoIHZlLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydCggZXZlbnQgKSB7CgoJdmFyIHRvdWNoZXMgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzLAoJCXRhcmdldCwgZmxhZ3M7CgoJaWYgKCB0b3VjaGVzICYmIHRvdWNoZXMubGVuZ3RoID09PSAxICkgewoKCQl0YXJnZXQgPSBldmVudC50YXJnZXQ7CgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCB0YXJnZXQgKTsKCgkJaWYgKCBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyApIHsKCgkJCWxhc3RUb3VjaElEID0gbmV4dFRvdWNoSUQrKzsKCQkJJC5kYXRhKCB0YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lLCBsYXN0VG91Y2hJRCApOwoKCQkJY2xlYXJSZXNldFRpbWVyKCk7CgoJCQlkaXNhYmxlTW91c2VCaW5kaW5ncygpOwoJCQlkaWRTY3JvbGwgPSBmYWxzZTsKCgkJCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdOwoJCQlzdGFydFggPSB0LnBhZ2VYOwoJCQlzdGFydFkgPSB0LnBhZ2VZOwoKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW92ZXIiLCBldmVudCwgZmxhZ3MgKTsKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWRvd24iLCBldmVudCwgZmxhZ3MgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVNjcm9sbCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICkgKTsKCX0KCglkaWRTY3JvbGwgPSB0cnVlOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF0sCgkJZGlkQ2FuY2VsID0gZGlkU2Nyb2xsLAoJCW1vdmVUaHJlc2hvbGQgPSAkLnZtb3VzZS5tb3ZlRGlzdGFuY2VUaHJlc2hvbGQ7CgkJZGlkU2Nyb2xsID0gZGlkU2Nyb2xsIHx8CgkJCSggTWF0aC5hYnModC5wYWdlWCAtIHN0YXJ0WCkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyh0LnBhZ2VZIC0gc3RhcnRZKSA+IG1vdmVUaHJlc2hvbGQgKSwKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApOwoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdDsKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2V1cCIsIGV2ZW50LCBmbGFncyApOwoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpe30KCmZ1bmN0aW9uIGdldFNwZWNpYWxFdmVudE9iamVjdCggZXZlbnRUeXBlICkgewoJdmFyIHJlYWxUeXBlID0gZXZlbnRUeXBlLnN1YnN0ciggMSApOwoKCXJldHVybiB7CgkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhpcyBlbGVtZW50LAoJCQkvLyBhZGQgYSBiaW5kaW5ncyBvYmplY3QgdG8gaXRzIGRhdGEuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSwge30pOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmIChhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPT09IDEpIHsKCQkJCQkkZG9jdW1lbnQuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCgkJCQkJCS8vIE9uIHRvdWNoIHBsYXRmb3JtcywgdG91Y2hpbmcgdGhlIHNjcmVlbiBhbmQgdGhlbiBkcmFnZ2luZyB5b3VyIGZpbmdlcgoJCQkJCQkvLyBjYXVzZXMgdGhlIHdpbmRvdyBjb250ZW50IHRvIHNjcm9sbCBhZnRlciBzb21lIGRpc3RhbmNlIHRocmVzaG9sZCBpcwoJCQkJCQkvLyBleGNlZWRlZC4gT24gdGhlc2UgcGxhdGZvcm1zLCBhIHNjcm9sbCBwcmV2ZW50cyBhIGNsaWNrIGV2ZW50IGZyb20gYmVpbmcKCQkJCQkJLy8gZGlzcGF0Y2hlZCwgYW5kIG9uIHNvbWUgcGxhdGZvcm1zLCBldmVuIHRoZSB0b3VjaGVuZCBpcyBzdXBwcmVzc2VkLiBUbwoJCQkJCQkvLyBtaW1pYyB0aGUgc3VwcHJlc3Npb24gb2YgdGhlIGNsaWNrIGV2ZW50LCB3ZSBuZWVkIHRvIHdhdGNoIGZvciBhIHNjcm9sbAoJCQkJCQkvLyBldmVudC4gVW5mb3J0dW5hdGVseSwgc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MgZG9uJ3QgZGlzcGF0Y2ggc2Nyb2xsCgkJCQkJCS8vIGV2ZW50cyB1bnRpbCAqQUZURVIqIHRoZSB1c2VyIGxpZnRzIHRoZWlyIGZpbmdlciAodG91Y2hlbmQpLiBUaGlzIG1lYW5zCgkJCQkJCS8vIHdlIG5lZWQgdG8gd2F0Y2ggYm90aCBzY3JvbGwgYW5kIHRvdWNobW92ZSBldmVudHMgdG8gZmlndXJlIG91dCB3aGV0aGVyCgkJCQkJCS8vIG9yIG5vdCBhIHNjcm9sbCBoYXBwZW5lbnMgYmVmb3JlIHRoZSB0b3VjaGVuZCBldmVudCBpcyBmaXJlZC4KCgkJCQkJCS5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCB2YXIgaSA9IDA7IGkgPCB2aXJ0dWFsRXZlbnROYW1lcy5sZW5ndGg7IGkrKyApewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApewoJCXZhciBjbnQgPSBjbGlja0Jsb2NrTGlzdC5sZW5ndGgsCgkJCXRhcmdldCA9IGUudGFyZ2V0LAoJCQl4LCB5LCBlbGUsIGksIG8sIHRvdWNoSUQ7CgoJCWlmICggY250ICkgewoJCQl4ID0gZS5jbGllbnRYOwoJCQl5ID0gZS5jbGllbnRZOwoJCQl0aHJlc2hvbGQgPSAkLnZtb3VzZS5jbGlja0Rpc3RhbmNlVGhyZXNob2xkOwoKCQkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBydW4gdGhyb3VnaCB0aGUgY2xpY2tCbG9ja0xpc3QgdG8gc2VlIGlmCgkJCS8vIHRoZSBjdXJyZW50IGNsaWNrIGV2ZW50IGlzIGluIHRoZSBwcm94aW1pdHkgb2Ygb25lIG9mIG91cgoJCQkvLyB2Y2xpY2sgZXZlbnRzIHRoYXQgaGFkIHByZXZlbnREZWZhdWx0KCkgY2FsbGVkIG9uIGl0LiBJZiB3ZSBmaW5kCgkJCS8vIG9uZSwgdGhlbiB3ZSBibG9jayB0aGUgY2xpY2suCgkJCS8vCgkJCS8vIFdoeSBkbyB3ZSBoYXZlIHRvIHJlbHkgb24gcHJveGltaXR5PwoJCQkvLwoJCQkvLyBCZWNhdXNlIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoIGV2ZW50IHRoYXQgdHJpZ2dlcmVkIHRoZSB2Y2xpY2sKCQkJLy8gY2FuIGJlIGRpZmZlcmVudCBmcm9tIHRoZSB0YXJnZXQgb2YgdGhlIGNsaWNrIGV2ZW50IHN5bnRoZXNpemVkCgkJCS8vIGJ5IHRoZSBicm93c2VyLiBUaGUgdGFyZ2V0IG9mIGEgbW91c2UvY2xpY2sgZXZlbnQgdGhhdCBpcyBzeW50ZWhzaXplZAoJCQkvLyBmcm9tIGEgdG91Y2ggZXZlbnQgc2VlbXMgdG8gYmUgaW1wbGVtZW50YXRpb24gc3BlY2lmaWMuIEZvciBleGFtcGxlLAoJCQkvLyBzb21lIGJyb3dzZXJzIHdpbGwgZmlyZSBtb3VzZS9jbGljayBldmVudHMgZm9yIGEgbGluayB0aGF0IGlzIG5lYXIKCQkJLy8gYSB0b3VjaCBldmVudCwgZXZlbiB0aG91Z2ggdGhlIHRhcmdldCBvZiB0aGUgdG91Y2hzdGFydC90b3VjaGVuZCBldmVudAoJCQkvLyBzYXlzIHRoZSB1c2VyIHRvdWNoZWQgb3V0c2lkZSB0aGUgbGluay4gQWxzbywgaXQgc2VlbXMgdGhhdCB3aXRoIG1vc3QKCQkJLy8gYnJvd3NlcnMsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIGV2ZW50IGlzIG5vdCBjYWxjdWxhdGVkIHVudGlsIHRoZQoJCQkvLyB0aW1lIGl0IGlzIGRpc3BhdGNoZWQsIHNvIGlmIHlvdSByZXBsYWNlIGFuIGVsZW1lbnQgdGhhdCB5b3UgdG91Y2hlZAoJCQkvLyB3aXRoIGFub3RoZXIgZWxlbWVudCwgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgd2lsbCBiZSB0aGUgbmV3CgkJCS8vIGVsZW1lbnQgdW5kZXJuZWF0aCB0aGF0IHBvaW50LgoJCQkvLwoJCQkvLyBBc2lkZSBmcm9tIHByb3hpbWl0eSwgd2UgYWxzbyBjaGVjayB0byBzZWUgaWYgdGhlIHRhcmdldCBhbmQgYW55CgkJCS8vIG9mIGl0cyBhbmNlc3RvcnMgd2VyZSB0aGUgb25lcyB0aGF0IGJsb2NrZWQgYSBjbGljay4gVGhpcyBpcyBuZWNlc3NhcnkKCQkJLy8gYmVjYXVzZSBvZiB0aGUgc3RyYW5nZSBtb3VzZS9jbGljayB0YXJnZXQgY2FsY3VsYXRpb24gZG9uZSBpbiB0aGUKCQkJLy8gQW5kcm9pZCAyLjEgYnJvd3Nlciwgd2hlcmUgaWYgeW91IGNsaWNrIG9uIGFuIGVsZW1lbnQsIGFuZCB0aGVyZSBpcyBhCgkJCS8vIG1vdXNlL2NsaWNrIGhhbmRsZXIgb24gb25lIG9mIGl0cyBhbmNlc3RvcnMsIHRoZSB0YXJnZXQgd2lsbCBiZSB0aGUKCQkJLy8gaW5uZXJtb3N0IGNoaWxkIG9mIHRoZSB0b3VjaGVkIGVsZW1lbnQsIGV2ZW4gaWYgdGhhdCBjaGlsZCBpcyBubyB3aGVyZQoJCQkvLyBuZWFyIHRoZSBwb2ludCBvZiB0b3VjaC4KCgkJCWVsZSA9IHRhcmdldDsKCgkJCXdoaWxlICggZWxlICkgewoJCQkJZm9yICggaSA9IDA7IGkgPCBjbnQ7IGkrKyApIHsKCQkJCQlvID0gY2xpY2tCbG9ja0xpc3RbIGkgXTsKCQkJCQl0b3VjaElEID0gMDsKCgkJCQkJaWYgKCAoIGVsZSA9PT0gdGFyZ2V0ICYmIE1hdGguYWJzKCBvLnggLSB4ICkgPCB0aHJlc2hvbGQgJiYgTWF0aC5hYnMoIG8ueSAtIHkgKSA8IHRocmVzaG9sZCApIHx8CgkJCQkJCQkJJC5kYXRhKCBlbGUsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICkgPT09IG8udG91Y2hJRCApIHsKCQkJCQkJLy8gWFhYOiBXZSBtYXkgd2FudCB0byBjb25zaWRlciByZW1vdmluZyBtYXRjaGVzIGZyb20gdGhlIGJsb2NrIGxpc3QKCQkJCQkJLy8gICAgICBpbnN0ZWFkIG9mIHdhaXRpbmcgZm9yIHRoZSByZXNldCB0aW1lciB0byBmaXJlLgoJCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQl9CgkJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQkJfQoJCX0KCX0sIHRydWUpOwp9Cn0pKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQgKTsKCgoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbigkLHdpbmRvdyx1bmRlZmluZWQpewogIC8vIFJldXNlZCBzdHJpbmcuCiAgdmFyIHN0cl9oYXNoY2hhbmdlID0gJ2hhc2hjaGFuZ2UnLAogICAgCiAgICAvLyBNZXRob2QgLyBvYmplY3QgcmVmZXJlbmNlcy4KICAgIGRvYyA9IGRvY3VtZW50LAogICAgZmFrZV9vbmhhc2hjaGFuZ2UsCiAgICBzcGVjaWFsID0gJC5ldmVudC5zcGVjaWFsLAogICAgCiAgICAvLyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgd2luZG93Lm9uaGFzaGNoYW5nZT8gTm90ZSB0aGF0IElFOCBydW5uaW5nIGluCiAgICAvLyBJRTcgY29tcGF0aWJpbGl0eSBtb2RlIHJlcG9ydHMgdHJ1ZSBmb3IgJ29uaGFzaGNoYW5nZScgaW4gd2luZG93LCBldmVuCiAgICAvLyB0aG91Z2ggdGhlIGV2ZW50IGlzbid0IHN1cHBvcnRlZCwgc28gYWxzbyB0ZXN0IGRvY3VtZW50LmRvY3VtZW50TW9kZS4KICAgIGRvY19tb2RlID0gZG9jLmRvY3VtZW50TW9kZSwKICAgIHN1cHBvcnRzX29uaGFzaGNoYW5nZSA9ICdvbicgKyBzdHJfaGFzaGNoYW5nZSBpbiB3aW5kb3cgJiYgKCBkb2NfbW9kZSA9PT0gdW5kZWZpbmVkIHx8IGRvY19tb2RlID4gNyApOwogIAogIC8vIEdldCBsb2NhdGlvbi5oYXNoIChvciB3aGF0IHlvdSdkIGV4cGVjdCBsb2NhdGlvbi5oYXNoIHRvIGJlKSBzYW5zIGFueQogIC8vIGxlYWRpbmcgIy4gVGhhbmtzIGZvciBtYWtpbmcgdGhpcyBuZWNlc3NhcnksIEZpcmVmb3ghCiAgZnVuY3Rpb24gZ2V0X2ZyYWdtZW50KCB1cmwgKSB7CiAgICB1cmwgPSB1cmwgfHwgbG9jYXRpb24uaHJlZjsKICAgIHJldHVybiAnIycgKyB1cmwucmVwbGFjZSggL15bXiNdKiM/KC4qKSQvLCAnJDEnICk7CiAgfTsKICAKICAvLyBNZXRob2Q6IGpRdWVyeS5mbi5oYXNoY2hhbmdlCiAgLy8gCiAgLy8gQmluZCBhIGhhbmRsZXIgdG8gdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgb3IgdHJpZ2dlciBhbGwgYm91bmQKICAvLyB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXJzLiBUaGlzIGJlaGF2aW9yIGlzIGNvbnNpc3RlbnQgd2l0aAogIC8vIGpRdWVyeSdzIGJ1aWx0LWluIGV2ZW50IGhhbmRsZXJzLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggWyBoYW5kbGVyIF0gKTsKICAvLyAKICAvLyBBcmd1bWVudHM6CiAgLy8gCiAgLy8gIGhhbmRsZXIgLSAoRnVuY3Rpb24pIE9wdGlvbmFsIGhhbmRsZXIgdG8gYmUgYm91bmQgdG8gdGhlIGhhc2hjaGFuZ2UKICAvLyAgICBldmVudC4gVGhpcyBpcyBhICJzaG9ydGN1dCIgZm9yIHRoZSBtb3JlIHZlcmJvc2UgZm9ybToKICAvLyAgICBqUXVlcnkod2luZG93KS5iaW5kKCAnaGFzaGNoYW5nZScsIGhhbmRsZXIgKS4gSWYgaGFuZGxlciBpcyBvbWl0dGVkLAogIC8vICAgIGFsbCBib3VuZCB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXJzIHdpbGwgYmUgdHJpZ2dlcmVkLiBUaGlzCiAgLy8gICAgaXMgYSBzaG9ydGN1dCBmb3IgdGhlIG1vcmUgdmVyYm9zZQogIC8vICAgIGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApLiBUaGVzZSBmb3JtcyBhcmUgZGVzY3JpYmVkIGluCiAgLy8gICAgdGhlIDxoYXNoY2hhbmdlIGV2ZW50PiBzZWN0aW9uLgogIC8vIAogIC8vIFJldHVybnM6CiAgLy8gCiAgLy8gIChqUXVlcnkpIFRoZSBpbml0aWFsIGpRdWVyeSBjb2xsZWN0aW9uIG9mIGVsZW1lbnRzLgogIAogIC8vIEFsbG93IHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKGVsZW0pLmhhc2hjaGFuZ2UoIGZuICkgZm9yIGJpbmRpbmcgYW5kCiAgLy8gJChlbGVtKS5oYXNoY2hhbmdlKCkgZm9yIHRyaWdnZXJpbmcsIGxpa2UgalF1ZXJ5IGRvZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdID0gZnVuY3Rpb24oIGZuICkgewogICAgcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBzdHJfaGFzaGNoYW5nZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICB9OwogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheQogIC8vIAogIC8vIFRoZSBudW1lcmljIGludGVydmFsIChpbiBtaWxsaXNlY29uZHMpIGF0IHdoaWNoIHRoZSA8aGFzaGNoYW5nZSBldmVudD4KICAvLyBwb2xsaW5nIGxvb3AgZXhlY3V0ZXMuIERlZmF1bHRzIHRvIDUwLgogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4KICAvLyAKICAvLyBJZiB5b3UncmUgc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4geW91ciBKYXZhU2NyaXB0LCBhbmQgeW91IHdhbnQgaGFzaAogIC8vIGhpc3RvcnkgdG8gd29yayBpbiBJRTYvNywgbm90IG9ubHkgbXVzdCB0aGlzIHByb3BlcnR5IGJlIHNldCwgYnV0IHlvdSBtdXN0CiAgLy8gYWxzbyBzZXQgZG9jdW1lbnQuZG9tYWluIEJFRk9SRSBqUXVlcnkgaXMgbG9hZGVkIGludG8gdGhlIHBhZ2UuIFRoaXMKICAvLyBwcm9wZXJ0eSBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nCiAgLy8gaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLyAKICAvLyBJbiBhZGRpdGlvbiwgdGhlIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnR5IG11c3QgYmUgc2V0IHRvIHRoZQogIC8vIHBhdGggb2YgdGhlIGluY2x1ZGVkICJkb2N1bWVudC1kb21haW4uaHRtbCIgZmlsZSwgd2hpY2ggY2FuIGJlIHJlbmFtZWQgb3IKICAvLyBtb2RpZmllZCBpZiBuZWNlc3NhcnkgKG5vdGUgdGhhdCB0aGUgZG9jdW1lbnQuZG9tYWluIHNwZWNpZmllZCBtdXN0IGJlIHRoZQogIC8vIHNhbWUgaW4gYm90aCB5b3VyIG1haW4gSmF2YVNjcmlwdCBhcyB3ZWxsIGFzIGluIHRoaXMgZmlsZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluID0gZG9jdW1lbnQuZG9tYWluOwogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMKICAvLyAKICAvLyBJZiwgZm9yIHNvbWUgcmVhc29uLCB5b3UgbmVlZCB0byBzcGVjaWZ5IGFuIElmcmFtZSBzcmMgZmlsZSAoZm9yIGV4YW1wbGUsCiAgLy8gd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBhcyBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPiksIHlvdSBjYW4KICAvLyBkbyBzbyB1c2luZyB0aGlzIHByb3BlcnR5LiBOb3RlIHRoYXQgd2hlbiB1c2luZyB0aGlzIHByb3BlcnR5LCBoaXN0b3J5CiAgLy8gd29uJ3QgYmUgcmVjb3JkZWQgaW4gSUU2LzcgdW50aWwgdGhlIElmcmFtZSBzcmMgZmlsZSBsb2Fkcy4gVGhpcyBwcm9wZXJ0eQogIC8vIGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vIGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYyA9ICdwYXRoL3RvL2ZpbGUuaHRtbCc7CiAgCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kZWxheSA9IDUwOwogIC8qCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW4gPSBudWxsOwogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uc3JjID0gbnVsbDsKICAqLwogIAogIC8vIEV2ZW50OiBoYXNoY2hhbmdlIGV2ZW50CiAgLy8gCiAgLy8gRmlyZWQgd2hlbiBsb2NhdGlvbi5oYXNoIGNoYW5nZXMuIEluIGJyb3dzZXJzIHRoYXQgc3VwcG9ydCBpdCwgdGhlIG5hdGl2ZQogIC8vIEhUTUw1IHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaXMgdXNlZCwgb3RoZXJ3aXNlIGEgcG9sbGluZyBsb29wIGlzCiAgLy8gaW5pdGlhbGl6ZWQsIHJ1bm5pbmcgZXZlcnkgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBtaWxsaXNlY29uZHMgdG8KICAvLyBzZWUgaWYgdGhlIGhhc2ggaGFzIGNoYW5nZWQuIEluIElFNi83IChhbmQgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSksIGEgaGlkZGVuIElmcmFtZSBpcyBjcmVhdGVkIHRvIGFsbG93IHRoZSBiYWNrIGJ1dHRvbgogIC8vIGFuZCBoYXNoLWJhc2VkIGhpc3RvcnkgdG8gd29yay4KICAvLyAKICAvLyBVc2FnZSBhcyBkZXNjcmliZWQgaW4gPGpRdWVyeS5mbi5oYXNoY2hhbmdlPjoKICAvLyAKICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4gCiAgLy8gPiAvLyBNYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSgpOwogIC8vIAogIC8vIEEgbW9yZSB2ZXJib3NlIHVzYWdlIHRoYXQgYWxsb3dzIGZvciBldmVudCBuYW1lc3BhY2luZzoKICAvLyAKICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKTsKICAvLyAKICAvLyBBZGRpdGlvbmFsIE5vdGVzOgogIC8vIAogIC8vICogVGhlIHBvbGxpbmcgbG9vcCBhbmQgSWZyYW1lIGFyZSBub3QgY3JlYXRlZCB1bnRpbCBhdCBsZWFzdCBvbmUgaGFuZGxlcgogIC8vICAgaXMgYWN0dWFsbHkgYm91bmQgdG8gdGhlICdoYXNoY2hhbmdlJyBldmVudC4KICAvLyAqIElmIHlvdSBuZWVkIHRoZSBib3VuZCBoYW5kbGVyKHMpIHRvIGV4ZWN1dGUgaW1tZWRpYXRlbHksIGluIGNhc2VzIHdoZXJlCiAgLy8gICBhIGxvY2F0aW9uLmhhc2ggZXhpc3RzIG9uIHBhZ2UgbG9hZCwgdmlhIGJvb2ttYXJrIG9yIHBhZ2UgcmVmcmVzaCBmb3IKICAvLyAgIGV4YW1wbGUsIHVzZSBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCkgb3IgdGhlIG1vcmUgdmVyYm9zZSAKICAvLyAgIGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApLgogIC8vICogVGhlIGV2ZW50IGNhbiBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgc2luY2UgaXQgd29uJ3QgYmUgdXNhYmxlCiAgLy8gICBiZWZvcmUgdGhlbiBpbiBJRTYvNyAoZHVlIHRvIHRoZSBuZWNlc3NhcnkgSWZyYW1lKSwgcmVjb21tZW5kZWQgdXNhZ2UgaXMKICAvLyAgIHRvIGJpbmQgaXQgaW5zaWRlIGEgRE9NIHJlYWR5IGhhbmRsZXIuCiAgCiAgLy8gT3ZlcnJpZGUgZXhpc3RpbmcgJC5ldmVudC5zcGVjaWFsLmhhc2hjaGFuZ2UgbWV0aG9kcyAoYWxsb3dpbmcgdGhpcyBwbHVnaW4KICAvLyB0byBiZSBkZWZpbmVkIGFmdGVyIGpRdWVyeSBCQlEgaW4gQkJRJ3Mgc291cmNlIGNvZGUpLgogIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0gPSAkLmV4dGVuZCggc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSwgewogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBmaXJzdCAnaGFzaGNoYW5nZScgZXZlbnQgaXMgYm91bmQgdG8gd2luZG93LgogICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIGNyZWF0ZSBvdXIgb3duLiBBbmQgd2UgZG9uJ3Qgd2FudCB0byBjYWxsIHRoaXMKICAgICAgLy8gdW50aWwgdGhlIHVzZXIgYmluZHMgdG8gdGhlIGV2ZW50LCBqdXN0IGluIGNhc2UgdGhleSBuZXZlciBkbywgc2luY2UgaXQKICAgICAgLy8gd2lsbCBjcmVhdGUgYSBwb2xsaW5nIGxvb3AgYW5kIHBvc3NpYmx5IGV2ZW4gYSBoaWRkZW4gSWZyYW1lLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdGFydCApOwogICAgfSwKICAgIAogICAgLy8gQ2FsbGVkIG9ubHkgd2hlbiB0aGUgbGFzdCAnaGFzaGNoYW5nZScgZXZlbnQgaXMgdW5ib3VuZCBmcm9tIHdpbmRvdy4KICAgIHRlYXJkb3duOiBmdW5jdGlvbigpIHsKICAgICAgLy8gSWYgd2luZG93Lm9uaGFzaGNoYW5nZSBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoZXJlJ3Mgbm90aGluZyB0byBkby4uCiAgICAgIGlmICggc3VwcG9ydHNfb25oYXNoY2hhbmdlICkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgCiAgICAgIC8vIE90aGVyd2lzZSwgd2UgbmVlZCB0byBzdG9wIG91cnMgKGlmIHBvc3NpYmxlKS4KICAgICAgJCggZmFrZV9vbmhhc2hjaGFuZ2Uuc3RvcCApOwogICAgfQogICAgCiAgfSk7CiAgCiAgLy8gZmFrZV9vbmhhc2hjaGFuZ2UgZG9lcyBhbGwgdGhlIHdvcmsgb2YgdHJpZ2dlcmluZyB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZQogIC8vIGV2ZW50IGZvciBicm93c2VycyB0aGF0IGRvbid0IG5hdGl2ZWx5IHN1cHBvcnQgaXQsIGluY2x1ZGluZyBjcmVhdGluZyBhCiAgLy8gcG9sbGluZyBsb29wIHRvIHdhdGNoIGZvciBoYXNoIGNoYW5nZXMgYW5kIGluIElFIDYvNyBjcmVhdGluZyBhIGhpZGRlbgogIC8vIElmcmFtZSB0byBlbmFibGUgYmFjayBhbmQgZm9yd2FyZC4KICBmYWtlX29uaGFzaGNoYW5nZSA9IChmdW5jdGlvbigpewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKHZhbCl7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgICQuYnJvd3Nlci5tc2llICYmICFzdXBwb3J0c19vbmhhc2hjaGFuZ2UgJiYgKGZ1bmN0aW9uKCl7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KICAgICAgCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKICAgICAgCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpewogICAgICAgIGlmICggIWlmcmFtZSApIHsKICAgICAgICAgIGlmcmFtZV9zcmMgPSAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLnNyYzsKICAgICAgICAgIGlmcmFtZV9zcmMgPSBpZnJhbWVfc3JjICYmIGlmcmFtZV9zcmMgKyBnZXRfZnJhZ21lbnQoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gQ3JlYXRlIGhpZGRlbiBJZnJhbWUuIEF0dGVtcHQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlCiAgICAgICAgICAvLyBieSB1c2luZyB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4KICAgICAgICAgIGlmcmFtZSA9ICQoJzxpZnJhbWUgdGFiaW5kZXg9Ii0xIiB0aXRsZT0iZW1wdHkiLz4nKS5oaWRlKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFdoZW4gSWZyYW1lIGhhcyBjb21wbGV0ZWx5IGxvYWRlZCwgaW5pdGlhbGl6ZSB0aGUgaGlzdG9yeSBhbmQKICAgICAgICAgICAgLy8gc3RhcnQgcG9sbGluZy4KICAgICAgICAgICAgLm9uZSggJ2xvYWQnLCBmdW5jdGlvbigpewogICAgICAgICAgICAgIGlmcmFtZV9zcmMgfHwgaGlzdG9yeV9zZXQoIGdldF9mcmFnbWVudCgpICk7CiAgICAgICAgICAgICAgcG9sbCgpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTG9hZCBJZnJhbWUgc3JjIGlmIHNwZWNpZmllZCwgb3RoZXJ3aXNlIG5vdGhpbmcuCiAgICAgICAgICAgIC5hdHRyKCAnc3JjJywgaWZyYW1lX3NyYyB8fCAnamF2YXNjcmlwdDowJyApCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBlbmQgSWZyYW1lIGFmdGVyIHRoZSBlbmQgb2YgdGhlIGJvZHkgdG8gcHJldmVudCB1bm5lY2Vzc2FyeQogICAgICAgICAgICAvLyBpbml0aWFsIHBhZ2Ugc2Nyb2xsaW5nICh5ZXMsIHRoaXMgd29ya3MpLgogICAgICAgICAgICAuaW5zZXJ0QWZ0ZXIoICdib2R5JyApWzBdLmNvbnRlbnRXaW5kb3c7CiAgICAgICAgICAKICAgICAgICAgIC8vIFdoZW5ldmVyIGBkb2N1bWVudC50aXRsZWAgY2hhbmdlcywgdXBkYXRlIHRoZSBJZnJhbWUncyB0aXRsZSB0bwogICAgICAgICAgLy8gcHJldHRpZnkgdGhlIGJhY2svbmV4dCBoaXN0b3J5IG1lbnUgZW50cmllcy4gU2luY2UgSUUgc29tZXRpbWVzCiAgICAgICAgICAvLyBlcnJvcnMgd2l0aCAiVW5zcGVjaWZpZWQgZXJyb3IiIHRoZSB2ZXJ5IGZpcnN0IHRpbWUgdGhpcyBpcyBzZXQKICAgICAgICAgIC8vICh5ZXMsIHZlcnkgdXNlZnVsKSB3cmFwIHRoaXMgd2l0aCBhIHRyeS9jYXRjaCBibG9jay4KICAgICAgICAgIGRvYy5vbnByb3BlcnR5Y2hhbmdlID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoIGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3RpdGxlJyApIHsKICAgICAgICAgICAgICAgIGlmcmFtZS5kb2N1bWVudC50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKICAgICAgCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CiAgICAgIAogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CiAgICAgICAgCiAgICAgICAgaWYgKCBoYXNoICE9PSBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgICAvLyBVcGRhdGUgSWZyYW1lIHdpdGggYW55IGluaXRpYWwgYGRvY3VtZW50LnRpdGxlYCB0aGF0IG1pZ2h0IGJlIHNldC4KICAgICAgICAgIGlmcmFtZV9kb2MudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTZXQgZG9jdW1lbnQuZG9tYWluIGZvciB0aGUgSWZyYW1lIGRvY3VtZW50IGFzIHdlbGwsIGlmIG5lY2Vzc2FyeS4KICAgICAgICAgIGRvbWFpbiAmJiBpZnJhbWVfZG9jLndyaXRlKCAnPHNjcmlwdD5kb2N1bWVudC5kb21haW49IicgKyBkb21haW4gKyAnIjwvc2NyaXB0PicgKTsKICAgICAgICAgIAogICAgICAgICAgaWZyYW1lX2RvYy5jbG9zZSgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBVcGRhdGUgdGhlIElmcmFtZSdzIGhhc2gsIGZvciBncmVhdCBqdXN0aWNlLgogICAgICAgICAgaWZyYW1lLmxvY2F0aW9uLmhhc2ggPSBoYXNoOwogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICB9KSgpOwogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eIFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IF5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgCiAgICByZXR1cm4gc2VsZjsKICB9KSgpOwogIAp9KShqUXVlcnksdGhpcyk7CgovKiEKICogalF1ZXJ5IFVJIFdpZGdldCBAVkVSU0lPTgogKgogKiBDb3B5cmlnaHQgMjAxMCwgQVVUSE9SUy50eHQgKGh0dHA6Ly9qcXVlcnl1aS5jb20vYWJvdXQpCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9kb2NzLmpxdWVyeS5jb20vVUkvV2lkZ2V0CiAqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBqUXVlcnkgMS40KwppZiAoICQuY2xlYW5EYXRhICkgewoJdmFyIF9jbGVhbkRhdGEgPSAkLmNsZWFuRGF0YTsKCSQuY2xlYW5EYXRhID0gZnVuY3Rpb24oIGVsZW1zICkgewoJCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQkkKCBlbGVtICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJfQoJCV9jbGVhbkRhdGEoIGVsZW1zICk7Cgl9Owp9IGVsc2UgewoJdmFyIF9yZW1vdmUgPSAkLmZuLnJlbW92ZTsKCSQuZm4ucmVtb3ZlID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBrZWVwRGF0YSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoICFrZWVwRGF0YSApIHsKCQkJCWlmICggIXNlbGVjdG9yIHx8ICQuZmlsdGVyKCBzZWxlY3RvciwgWyB0aGlzIF0gKS5sZW5ndGggKSB7CgkJCQkJJCggIioiLCB0aGlzICkuYWRkKCBbIHRoaXMgXSApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJCSQoIHRoaXMgKS50cmlnZ2VySGFuZGxlciggInJlbW92ZSIgKTsKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gX3JlbW92ZS5jYWxsKCAkKHRoaXMpLCBzZWxlY3Rvciwga2VlcERhdGEgKTsKCQl9KTsKCX07Cn0KCiQud2lkZ2V0ID0gZnVuY3Rpb24oIG5hbWUsIGJhc2UsIHByb3RvdHlwZSApIHsKCXZhciBuYW1lc3BhY2UgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMCBdLAoJCWZ1bGxOYW1lOwoJbmFtZSA9IG5hbWUuc3BsaXQoICIuIiApWyAxIF07CglmdWxsTmFtZSA9IG5hbWVzcGFjZSArICItIiArIG5hbWU7CgoJaWYgKCAhcHJvdG90eXBlICkgewoJCXByb3RvdHlwZSA9IGJhc2U7CgkJYmFzZSA9ICQuV2lkZ2V0OwoJfQoKCS8vIGNyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZSBdID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBuYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CgkkWyBuYW1lc3BhY2UgXVsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9Cgl9OwoKCXZhciBiYXNlUHJvdG90eXBlID0gbmV3IGJhc2UoKTsKCS8vIHdlIG5lZWQgdG8gbWFrZSB0aGUgb3B0aW9ucyBoYXNoIGEgcHJvcGVydHkgZGlyZWN0bHkgb24gdGhlIG5ldyBpbnN0YW5jZQoJLy8gb3RoZXJ3aXNlIHdlJ2xsIG1vZGlmeSB0aGUgb3B0aW9ucyBoYXNoIG9uIHRoZSBwcm90b3R5cGUgdGhhdCB3ZSdyZQoJLy8gaW5oZXJpdGluZyBmcm9tCi8vCSQuZWFjaCggYmFzZVByb3RvdHlwZSwgZnVuY3Rpb24oIGtleSwgdmFsICkgewovLwkJaWYgKCAkLmlzUGxhaW5PYmplY3QodmFsKSApIHsKLy8JCQliYXNlUHJvdG90eXBlWyBrZXkgXSA9ICQuZXh0ZW5kKCB7fSwgdmFsICk7Ci8vCQl9Ci8vCX0pOwoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC5leHRlbmQoIHRydWUsIHt9LCBiYXNlUHJvdG90eXBlLm9wdGlvbnMgKTsKCSRbIG5hbWVzcGFjZSBdWyBuYW1lIF0ucHJvdG90eXBlID0gJC5leHRlbmQoIHRydWUsIGJhc2VQcm90b3R5cGUsIHsKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCXdpZGdldEV2ZW50UHJlZml4OiAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdLnByb3RvdHlwZS53aWRnZXRFdmVudFByZWZpeCB8fCBuYW1lLAoJCXdpZGdldEJhc2VDbGFzczogZnVsbE5hbWUKCX0sIHByb3RvdHlwZSApOwoKCSQud2lkZ2V0LmJyaWRnZSggbmFtZSwgJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSApOwp9OwoKJC53aWRnZXQuYnJpZGdlID0gZnVuY3Rpb24oIG5hbWUsIG9iamVjdCApIHsKCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBpc01ldGhvZENhbGwgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIsCgkJCWFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLmV4dGVuZC5hcHBseSggbnVsbCwgWyB0cnVlLCBvcHRpb25zIF0uY29uY2F0KGFyZ3MpICkgOgoJCQlvcHRpb25zOwoKCQkvLyBwcmV2ZW50IGNhbGxzIHRvIGludGVybmFsIG1ldGhvZHMKCQlpZiAoIGlzTWV0aG9kQ2FsbCAmJiBvcHRpb25zLmNoYXJBdCggMCApID09PSAiXyIgKSB7CgkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQl9CgoJCWlmICggaXNNZXRob2RDYWxsICkgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIG5hbWUgKTsKCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXRocm93ICJjYW5ub3QgY2FsbCBtZXRob2RzIG9uICIgKyBuYW1lICsgIiBwcmlvciB0byBpbml0aWFsaXphdGlvbjsgIiArCgkJCQkJCSJhdHRlbXB0ZWQgdG8gY2FsbCBtZXRob2QgJyIgKyBvcHRpb25zICsgIiciOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApICkgewoJCQkJCXRocm93ICJubyBzdWNoIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyBmb3IgIiArIG5hbWUgKyAiIHdpZGdldCBpbnN0YW5jZSI7CgkJCQl9CgkJCQl2YXIgbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBuYW1lICk7CgkJCQlpZiAoIGluc3RhbmNlICkgewoJCQkJCWluc3RhbmNlLm9wdGlvbiggb3B0aW9ucyB8fCB7fSApLl9pbml0KCk7CgkJCQl9IGVsc2UgewoJCQkJCSQuZGF0YSggdGhpcywgbmFtZSwgbmV3IG9iamVjdCggb3B0aW9ucywgdGhpcyApICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfTsKfTsKCiQuV2lkZ2V0ID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCX0KfTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJb3B0aW9uczogewoJCWRpc2FibGVkOiBmYWxzZQoJfSwKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vICQud2lkZ2V0LmJyaWRnZSBzdG9yZXMgdGhlIHBsdWdpbiBpbnN0YW5jZSwgYnV0IHdlIGRvIGl0IGFueXdheQoJCS8vIHNvIHRoYXQgaXQncyBzdG9yZWQgZXZlbiBiZWZvcmUgdGhlIF9jcmVhdGUgZnVuY3Rpb24gcnVucwoJCSQuZGF0YSggZWxlbWVudCwgdGhpcy53aWRnZXROYW1lLCB0aGlzICk7CgkJdGhpcy5lbGVtZW50ID0gJCggZWxlbWVudCApOwoJCXRoaXMub3B0aW9ucyA9ICQuZXh0ZW5kKCB0cnVlLCB7fSwKCQkJdGhpcy5vcHRpb25zLAoJCQl0aGlzLl9nZXRDcmVhdGVPcHRpb25zKCksCgkJCW9wdGlvbnMgKTsKCgkJdmFyIHNlbGYgPSB0aGlzOwoJCXRoaXMuZWxlbWVudC5iaW5kKCAicmVtb3ZlLiIgKyB0aGlzLndpZGdldE5hbWUsIGZ1bmN0aW9uKCkgewoJCQlzZWxmLmRlc3Ryb3koKTsKCQl9KTsKCgkJdGhpcy5fY3JlYXRlKCk7CgkJdGhpcy5fdHJpZ2dlciggImNyZWF0ZSIgKTsKCQl0aGlzLl9pbml0KCk7Cgl9LAoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0ge307CgkJaWYgKCAkLm1ldGFkYXRhICkgewoJCQlvcHRpb25zID0gJC5tZXRhZGF0YS5nZXQoIGVsZW1lbnQgKVsgdGhpcy53aWRnZXROYW1lIF07CgkJfQoJCXJldHVybiBvcHRpb25zOwoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkge30sCglfaW5pdDogZnVuY3Rpb24oKSB7fSwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQKCQkJLnVuYmluZCggIi4iICsgdGhpcy53aWRnZXROYW1lICkKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0TmFtZSApOwoJCXRoaXMud2lkZ2V0KCkKCQkJLnVuYmluZCggIi4iICsgdGhpcy53aWRnZXROYW1lICkKCQkJLnJlbW92ZUF0dHIoICJhcmlhLWRpc2FibGVkIiApCgkJCS5yZW1vdmVDbGFzcygKCQkJCXRoaXMud2lkZ2V0QmFzZUNsYXNzICsgIi1kaXNhYmxlZCAiICsKCQkJCSJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJfSwKCglvcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBvcHRpb25zID0ga2V5OwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDAgKSB7CgkJCS8vIGRvbid0IHJldHVybiBhIHJlZmVyZW5jZSB0byB0aGUgaW50ZXJuYWwgaGFzaAoJCQlyZXR1cm4gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICAodHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiB0aGlzLm9wdGlvbnNbIGtleSBdOwoJCQl9CgkJCW9wdGlvbnMgPSB7fTsKCQkJb3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQl9CgoJCXRoaXMuX3NldE9wdGlvbnMoIG9wdGlvbnMgKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBzZWxmID0gdGhpczsKCQkkLmVhY2goIG9wdGlvbnMsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQlzZWxmLl9zZXRPcHRpb24oIGtleSwgdmFsdWUgKTsKCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy53aWRnZXQoKQoJCQkJWyB2YWx1ZSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiXSgKCQkJCQl0aGlzLndpZGdldEJhc2VDbGFzcyArICItZGlzYWJsZWQiICsgIiAiICsKCQkJCQkidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQl2YXIgY2FsbGJhY2sgPSB0aGlzLm9wdGlvbnNbIHR5cGUgXTsKCgkJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSAoIHR5cGUgPT09IHRoaXMud2lkZ2V0RXZlbnRQcmVmaXggPwoJCQl0eXBlIDoKCQkJdGhpcy53aWRnZXRFdmVudFByZWZpeCArIHR5cGUgKS50b0xvd2VyQ2FzZSgpOwoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCQkvLyBidXQgd2UgZG9uJ3QgaGF2ZSBhIHdheSB0byBmb3JjZSBhbiBldmVudCB0byBiZSBmaXhlZCBtdWx0aXBsZSB0aW1lcwoJCWlmICggZXZlbnQub3JpZ2luYWxFdmVudCApIHsKCQkJZm9yICggdmFyIGkgPSAkLmV2ZW50LnByb3BzLmxlbmd0aCwgcHJvcDsgaTsgKSB7CgkJCQlwcm9wID0gJC5ldmVudC5wcm9wc1sgLS1pIF07CgkJCQlldmVudFsgcHJvcCBdID0gZXZlbnQub3JpZ2luYWxFdmVudFsgcHJvcCBdOwoJCQl9CgkJfQoKCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggZXZlbnQsIGRhdGEgKTsKCgkJcmV0dXJuICEoICQuaXNGdW5jdGlvbihjYWxsYmFjaykgJiYKCQkJY2FsbGJhY2suY2FsbCggdGhpcy5lbGVtZW50WzBdLCBldmVudCwgZGF0YSApID09PSBmYWxzZSB8fAoJCQlldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApOwoJfQp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS53aWRnZXQiLCB7CgkvLyBkZWNvcmF0ZSB0aGUgcGFyZW50IF9jcmVhdGVXaWRnZXQgdG8gdHJpZ2dlciBgd2lkZ2V0aW5pdGAgZm9yIHVzZXJzCgkvLyB3aG8gd2lzaCB0byBkbyBwb3N0IHBvc3QgYHdpZGdldGNyZWF0ZWAgYWx0ZXJhdGlvbnMvYWRkaXRpb25zCgkvLwoJLy8gVE9ETyBjcmVhdGUgYSBwdWxsIHJlcXVlc3QgZm9yIGpxdWVyeSB1aSB0byB0cmlnZ2VyIHRoaXMgZXZlbnQKCS8vIGluIHRoZSBvcmlnaW5hbCBfY3JlYXRlV2lkZ2V0CglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQkkLldpZGdldC5wcm90b3R5cGUuX2NyZWF0ZVdpZGdldC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fdHJpZ2dlciggJ2luaXQnICk7Cgl9LAoKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdGlvbnMgPSB7fTsKCgkJJC5lYWNoKCB0aGlzLm9wdGlvbnMsIGZ1bmN0aW9uKCBvcHRpb24gKSB7CgoJCQl2YXIgdmFsdWUgPSBlbGVtLmpxbURhdGEoIG9wdGlvbi5yZXBsYWNlKCAvW0EtWl0vZywgZnVuY3Rpb24oIGMgKSB7CgkJCQkJCQlyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwoJCQkJCQl9KQoJCQkJCSk7CgoJCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvcHRpb25zWyBvcHRpb24gXSA9IHZhbHVlOwoJCQl9CgkJfSk7CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCgllbmhhbmNlV2l0aGluOiBmdW5jdGlvbiggdGFyZ2V0LCB1c2VLZWVwTmF0aXZlICkgewoJCXRoaXMuZW5oYW5jZSggJCggdGhpcy5vcHRpb25zLmluaXRTZWxlY3RvciwgJCggdGFyZ2V0ICkpLCB1c2VLZWVwTmF0aXZlICk7Cgl9LAoKCWVuaGFuY2U6IGZ1bmN0aW9uKCB0YXJnZXRzLCB1c2VLZWVwTmF0aXZlICkgewoJCXZhciBwYWdlLCBrZWVwTmF0aXZlLCAkd2lkZ2V0RWxlbWVudHMgPSAkKCB0YXJnZXRzICksIHNlbGYgPSB0aGlzOwoKCQkvLyBpZiBpZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgdG8gdHJ1ZSB0aGUgZnJhbWV3b3JrIHNob3VsZAoJCS8vIG9ubHkgZW5oYW5jZSB0aGUgc2VsZWN0ZWQgZWxlbWVudHMgd2hlbiB0aGV5IGRvIE5PVCBoYXZlIGEKCQkvLyBwYXJlbnQgd2l0aCB0aGUgZGF0YS1uYW1lc3BhY2UtaWdub3JlIGF0dHJpYnV0ZQoJCSR3aWRnZXRFbGVtZW50cyA9ICQubW9iaWxlLmVuaGFuY2VhYmxlKCAkd2lkZ2V0RWxlbWVudHMgKTsKCgkJaWYgKCB1c2VLZWVwTmF0aXZlICYmICR3aWRnZXRFbGVtZW50cy5sZW5ndGggKSB7CgkJCS8vIFRPRE8gcmVtb3ZlIGRlcGVuZGVuY3kgb24gdGhlIHBhZ2Ugd2lkZ2V0IGZvciB0aGUga2VlcE5hdGl2ZS4KCQkJLy8gQ3VycmVudGx5IHRoZSBrZWVwTmF0aXZlIHZhbHVlIGlzIGRlZmluZWQgb24gdGhlIHBhZ2UgcHJvdG90eXBlIHNvCgkJCS8vIHRoZSBtZXRob2QgaXMgYXMgd2VsbAoJCQlwYWdlID0gJC5tb2JpbGUuY2xvc2VzdFBhZ2VEYXRhKCAkd2lkZ2V0RWxlbWVudHMgKTsKCQkJa2VlcE5hdGl2ZSA9IChwYWdlICYmIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkpIHx8ICIiOwoKCQkJJHdpZGdldEVsZW1lbnRzID0gJHdpZGdldEVsZW1lbnRzLm5vdCgga2VlcE5hdGl2ZSApOwoJCX0KCgkJJHdpZGdldEVsZW1lbnRzWyB0aGlzLndpZGdldE5hbWUgXSgpOwoJfSwKCglyYWlzZTogZnVuY3Rpb24oIG1zZyApIHsKCQl0aHJvdyAiV2lkZ2V0IFsiICsgdGhpcy53aWRnZXROYW1lICsgIl06ICIgKyBtc2c7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCgl2YXIgbnNOb3JtYWxpemVEaWN0ID0ge307CgoJLy8galF1ZXJ5Lm1vYmlsZSBjb25maWd1cmFibGUgb3B0aW9ucwoJJC5tb2JpbGUgPSAkLmV4dGVuZCgge30sIHsKCgkJLy8gVmVyc2lvbiBvZiB0aGUgalF1ZXJ5IE1vYmlsZSBGcmFtZXdvcmsKCQl2ZXJzaW9uOiAiMS4xLjIiLAoKCQkvLyBOYW1lc3BhY2UgdXNlZCBmcmFtZXdvcmstd2lkZSBmb3IgZGF0YS1hdHRycy4gRGVmYXVsdCBpcyBubyBuYW1lc3BhY2UKCQluczogIiIsCgoJCS8vIERlZmluZSB0aGUgdXJsIHBhcmFtZXRlciB1c2VkIGZvciByZWZlcmVuY2luZyB3aWRnZXQtZ2VuZXJhdGVkIHN1Yi1wYWdlcy4KCQkvLyBUcmFuc2xhdGVzIHRvIHRvIGV4YW1wbGUuaHRtbCZ1aS1wYWdlPXN1YnBhZ2VJZGVudGlmaWVyCgkJLy8gaGFzaCBzZWdtZW50IGJlZm9yZSAmdWktcGFnZT0gaXMgdXNlZCB0byBtYWtlIEFqYXggcmVxdWVzdAoJCXN1YlBhZ2VVcmxLZXk6ICJ1aS1wYWdlIiwKCgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImFjdGl2ZSIgYnV0dG9uIHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlhY3RpdmVCdG5DbGFzczogInVpLWJ0bi1hY3RpdmUiLAoKCQkvLyBDbGFzcyB1c2VkIGZvciAiZm9jdXMiIGZvcm0gZWxlbWVudCBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJZm9jdXNDbGFzczogInVpLWZvY3VzIiwKCgkJLy8gQXV0b21hdGljYWxseSBoYW5kbGUgY2xpY2tzIGFuZCBmb3JtIHN1Ym1pc3Npb25zIHRocm91Z2ggQWpheCwgd2hlbiBzYW1lLWRvbWFpbgoJCWFqYXhFbmFibGVkOiB0cnVlLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGxvYWQgYW5kIHNob3cgcGFnZXMgYmFzZWQgb24gbG9jYXRpb24uaGFzaAoJCWhhc2hMaXN0ZW5pbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBkaXNhYmxlIHRvIHByZXZlbnQganF1ZXJ5IGZyb20gYm90aGVyaW5nIHdpdGggbGlua3MKCQlsaW5rQmluZGluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIFNldCBkZWZhdWx0IHBhZ2UgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0UGFnZVRyYW5zaXRpb246ICJmYWRlIiwKCgkJLy8gU2V0IG1heGltdW0gd2luZG93IHdpZHRoIGZvciB0cmFuc2l0aW9ucyB0byBhcHBseSAtICdmYWxzZScgZm9yIG5vIGxpbWl0CgkJbWF4VHJhbnNpdGlvbldpZHRoOiBmYWxzZSwKCgkJLy8gTWluaW11bSBzY3JvbGwgZGlzdGFuY2UgdGhhdCB3aWxsIGJlIHJlbWVtYmVyZWQgd2hlbiByZXR1cm5pbmcgdG8gYSBwYWdlCgkJbWluU2Nyb2xsQmFjazogMjUwLAoKCQkvLyBERVBSRUNBVEVEOiB0aGUgZm9sbG93aW5nIHByb3BlcnR5IGlzIG5vIGxvbmdlciBpbiB1c2UsIGJ1dCBkZWZpbmVkIHVudGlsIDIuMCB0byBwcmV2ZW50IGNvbmZsaWN0cwoJCXRvdWNoT3ZlcmZsb3dFbmFibGVkOiBmYWxzZSwKCgkJLy8gU2V0IGRlZmF1bHQgZGlhbG9nIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdERpYWxvZ1RyYW5zaXRpb246ICJwb3AiLAoKCQkvLyBTaG93IGxvYWRpbmcgbWVzc2FnZSBkdXJpbmcgQWpheCByZXF1ZXN0cwoJCS8vIGlmIGZhbHNlLCBtZXNzYWdlIHdpbGwgbm90IGFwcGVhciwgYnV0IGxvYWRpbmcgY2xhc3NlcyB3aWxsIHN0aWxsIGJlIHRvZ2dsZWQgb24gaHRtbCBlbAoJCWxvYWRpbmdNZXNzYWdlOiAibG9hZGluZyIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vIFNob3VsZCB0aGUgdGV4dCBiZSB2aXNibGUgaW4gdGhlIGxvYWRpbmcgbWVzc2FnZT8KCQlsb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOiBmYWxzZSwKCgkJLy8gV2hlbiB0aGUgdGV4dCBpcyB2aXNpYmxlLCB3aGF0IHRoZW1lIGRvZXMgdGhlIGxvYWRpbmcgYm94IHVzZT8KCQlsb2FkaW5nTWVzc2FnZVRoZW1lOiAiYSIsCgoJCS8vIEZvciBlcnJvciBtZXNzYWdlcywgd2hpY2ggdGhlbWUgZG9lcyB0aGUgYm94IHVzZXM/CgkJcGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZTogImUiLAoKCQkvLyByZXBsYWNlIGNhbGxzIHRvIHdpbmRvdy5oaXN0b3J5LmJhY2sgd2l0aCBwaG9uZWdhcHMgbmF2aWdhdGlvbiBoZWxwZXIKCQkvLyB3aGVyZSBpdCBpcyBwcm92aWRlZCBvbiB0aGUgd2luZG93IG9iamVjdAoJCXBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQ6IGZhbHNlLAoKCQkvL2F1dG9tYXRpY2FsbHkgaW5pdGlhbGl6ZSB0aGUgRE9NIHdoZW4gaXQncyByZWFkeQoJCWF1dG9Jbml0aWFsaXplUGFnZTogdHJ1ZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gYWxsb3dzIHVzZXJzIHRvIG9wdCBpbiB0byBpZ25vcmluZyBjb250ZW50IGJ5IG1hcmtpbmcgYSBwYXJlbnQgZWxlbWVudCBhcwoJCS8vIGRhdGEtaWdub3JlZAoJCWlnbm9yZUNvbnRlbnRFbmFibGVkOiBmYWxzZSwKCgkJLy8gdHVybiBvZiBiaW5kaW5nIHRvIHRoZSBuYXRpdmUgb3JpZW50YXRpb25jaGFuZ2UgZHVlIHRvIGFuZHJvaWQgb3JpZW50YXRpb24gYmVoYXZpb3IKCQlvcmllbnRhdGlvbkNoYW5nZUVuYWJsZWQ6IHRydWUsCgoJCWJ1dHRvbk1hcmt1cDogewoJCQlob3ZlckRlbGF5OiAyMDAKCQl9LAoKCQkvLyBUT0RPIG1pZ2h0IGJlIHVzZWZ1bCB1cHN0cmVhbSBpbiBqcXVlcnkgaXRzZWxmID8KCQlrZXlDb2RlOiB7CgkJCUFMVDogMTgsCgkJCUJBQ0tTUEFDRTogOCwKCQkJQ0FQU19MT0NLOiAyMCwKCQkJQ09NTUE6IDE4OCwKCQkJQ09NTUFORDogOTEsCgkJCUNPTU1BTkRfTEVGVDogOTEsIC8vIENPTU1BTkQKCQkJQ09NTUFORF9SSUdIVDogOTMsCgkJCUNPTlRST0w6IDE3LAoJCQlERUxFVEU6IDQ2LAoJCQlET1dOOiA0MCwKCQkJRU5EOiAzNSwKCQkJRU5URVI6IDEzLAoJCQlFU0NBUEU6IDI3LAoJCQlIT01FOiAzNiwKCQkJSU5TRVJUOiA0NSwKCQkJTEVGVDogMzcsCgkJCU1FTlU6IDkzLCAvLyBDT01NQU5EX1JJR0hUCgkJCU5VTVBBRF9BREQ6IDEwNywKCQkJTlVNUEFEX0RFQ0lNQUw6IDExMCwKCQkJTlVNUEFEX0RJVklERTogMTExLAoJCQlOVU1QQURfRU5URVI6IDEwOCwKCQkJTlVNUEFEX01VTFRJUExZOiAxMDYsCgkJCU5VTVBBRF9TVUJUUkFDVDogMTA5LAoJCQlQQUdFX0RPV046IDM0LAoJCQlQQUdFX1VQOiAzMywKCQkJUEVSSU9EOiAxOTAsCgkJCVJJR0hUOiAzOSwKCQkJU0hJRlQ6IDE2LAoJCQlTUEFDRTogMzIsCgkJCVRBQjogOSwKCQkJVVA6IDM4LAoJCQlXSU5ET1dTOiA5MSAvLyBDT01NQU5ECgkJfSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkKCBkb2N1bWVudCApLnRyaWdnZXIoICJzaWxlbnRzY3JvbGwiLCB7IHg6IDAsIHk6IHlwb3MgfSk7CgkJCX0sIDIwICk7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQl9LCAxNTAgKTsKCQl9LAoKCQkvLyBFeHBvc2Ugb3VyIGNhY2hlIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgoJCW5zTm9ybWFsaXplRGljdDogbnNOb3JtYWxpemVEaWN0LAoKCQkvLyBUYWtlIGEgZGF0YSBhdHRyaWJ1dGUgcHJvcGVydHksIHByZXBlbmQgdGhlIG5hbWVzcGFjZQoJCS8vIGFuZCB0aGVuIGNhbWVsIGNhc2UgdGhlIGF0dHJpYnV0ZSBzdHJpbmcuIEFkZCB0aGUgcmVzdWx0CgkJLy8gdG8gb3VyIG5zTm9ybWFsaXplRGljdCBzbyB3ZSBkb24ndCBoYXZlIHRvIGRvIHRoaXMgYWdhaW4uCgkJbnNOb3JtYWxpemU6IGZ1bmN0aW9uKCBwcm9wICkgewoJCQlpZiAoICFwcm9wICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gfHwgKCBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSA9ICQuY2FtZWxDYXNlKCAkLm1vYmlsZS5ucyArIHByb3AgKSApOwoJCX0sCgoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcyBvbiBpdC4gTm90ZSB0aGF0CgkJLy8gd2UgYXJlIG5vdCB1c2luZyAkLmZuLmNsb3Nlc3QoKSBvbiBwdXJwb3NlIGhlcmUgYmVjYXVzZSB0aGlzCgkJLy8gbWV0aG9kIGdldHMgY2FsbGVkIHF1aXRlIGEgYml0IGFuZCB3ZSBuZWVkIGl0IHRvIGJlIGFzIGZhc3QKCQkvLyBhcyBwb3NzaWJsZS4KCQlnZXRJbmhlcml0ZWRUaGVtZTogZnVuY3Rpb24oIGVsLCBkZWZhdWx0VGhlbWUgKSB7CgkJCXZhciBlID0gZWxbIDAgXSwKCQkJCWx0ciA9ICIiLAoJCQkJcmUgPSAvdWktKGJhcnxib2R5fG92ZXJsYXkpLShbYS16XSlcYi8sCgkJCQljLCBtOwoKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgoJCQkvLyBSZXR1cm4gdGhlIHRoZW1lIGxldHRlciB3ZSBmb3VuZCwgaWYgbm9uZSwgcmV0dXJuIHRoZQoJCQkvLyBzcGVjaWZpZWQgZGVmYXVsdC4KCgkJCXJldHVybiBsdHIgfHwgZGVmYXVsdFRoZW1lIHx8ICJhIjsKCQl9LAoKCQkvLyBUT0RPIHRoZSBmb2xsb3dpbmcgJCBhbmQgJC5mbiBleHRlbnNpb25zIGNhbi9wcm9iYWJseSBzaG91bGQgYmUgbW92ZWQgaW50byBqcXVlcnkubW9iaWxlLmNvcmUuaGVscGVycwoJCS8vCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCgnOmpxbURhdGEocm9sZT0icGFnZSIpLCA6anFtRGF0YShyb2xlPSJkaWFsb2ciKScpCgkJCQkuZGF0YSgicGFnZSIpOwoJCX0sCgoJCWVuaGFuY2VhYmxlOiBmdW5jdGlvbiggJHNldCApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoICRzZXQsICJlbmhhbmNlIiApOwoJCX0sCgoJCWhpamFja2FibGU6IGZ1bmN0aW9uKCAkc2V0ICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggJHNldCwgImFqYXgiICk7CgkJfSwKCgkJaGF2ZVBhcmVudHM6IGZ1bmN0aW9uKCAkc2V0LCBhdHRyICkgewoJCQlpZiggISQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkICl7CgkJCQlyZXR1cm4gJHNldDsKCQkJfQoKCQkJdmFyIGNvdW50ID0gJHNldC5sZW5ndGgsCgkJCQkkbmV3U2V0ID0gJCgpLAoJCQkJZSwgJGVsZW1lbnQsIGV4Y2x1ZGVkOwoKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKyApIHsKCQkJCSRlbGVtZW50ID0gJHNldC5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSAkc2V0WyBpIF07CgoJCQkJd2hpbGUgKCBlICkgewoJCQkJCXZhciBjID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCl7CgkJCS8vIE5hdGl2ZSBpbm5lckhlaWdodCByZXR1cm5zIG1vcmUgYWNjdXJhdGUgdmFsdWUgZm9yIHRoaXMgYWNyb3NzIHBsYXRmb3JtcywKCQkJLy8galF1ZXJ5IHZlcnNpb24gaXMgaGVyZSBhcyBhIG5vcm1hbGl6ZWQgZmFsbGJhY2sgZm9yIHBsYXRmb3JtcyBsaWtlIFN5bWJpYW4KCQkJcmV0dXJuIHdpbmRvdy5pbm5lckhlaWdodCB8fCAkKCB3aW5kb3cgKS5oZWlnaHQoKTsKCQl9Cgl9LCAkLm1vYmlsZSApOwoKCS8vIE1vYmlsZSB2ZXJzaW9uIG9mIGRhdGEgYW5kIHJlbW92ZURhdGEgYW5kIGhhc0RhdGEgbWV0aG9kcwoJLy8gZW5zdXJlcyBhbGwgZGF0YSBpcyBzZXQgYW5kIHJldHJpZXZlZCB1c2luZyBqUXVlcnkgTW9iaWxlJ3MgZGF0YSBuYW1lc3BhY2UKCSQuZm4uanFtRGF0YSA9IGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT0gInVuZGVmaW5lZCIgKSB7CgkJCWlmICggcHJvcCApIHsKCQkJCXByb3AgPSAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApOwoJCQl9CgoJCQkvLyB1bmRlZmluZWQgaXMgcGVybWl0dGVkIGFzIGFuIGV4cGxpY2l0IGlucHV0IGZvciB0aGUgc2Vjb25kIHBhcmFtCgkJCS8vIGluIHRoaXMgY2FzZSBpdCByZXR1cm5zIHRoZSB2YWx1ZSBhbmQgZG9lcyBub3Qgc2V0IGl0IHRvIHVuZGVmaW5lZAoJCQlpZiggYXJndW1lbnRzLmxlbmd0aCA8IDIgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCApewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gJC5kYXRhKCBlbGVtLCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuZm4uanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBwcm9wICkgewoJCXJldHVybiB0aGlzLnJlbW92ZURhdGEoICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AgKSB7CgkJcmV0dXJuICQucmVtb3ZlRGF0YSggZWxlbSwgJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmZuLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oKSB7CgkJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyggdGhpcyApOwoJfTsKCgkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyICRlbGVtID0gJCggZWxlbSApOwoKCQkoICRlbGVtLmpxbURhdGEoJ2RlcGVuZGVudHMnKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQkkZWxlbS5yZW1vdmUoKTsKCX07CgoJJC5mbi5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJJC5hZGREZXBlbmRlbnRzKCAkKHRoaXMpLCBuZXdEZXBlbmRlbnRzICk7Cgl9OwoKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtLCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciBkZXBlbmRlbnRzID0gJChlbGVtKS5qcW1EYXRhKCAnZGVwZW5kZW50cycgKSB8fCAkKCk7CgoJCSQoZWxlbSkuanFtRGF0YSggJ2RlcGVuZGVudHMnLCAkLm1lcmdlKGRlcGVuZGVudHMsIG5ld0RlcGVuZGVudHMpICk7Cgl9OwoKCS8vIG5vdGUgdGhhdCB0aGlzIGhlbHBlciBkb2Vzbid0IGF0dGVtcHQgdG8gaGFuZGxlIHRoZSBjYWxsYmFjawoJLy8gb3Igc2V0dGluZyBvZiBhbiBodG1sIGVsZW1lbnRzIHRleHQsIGl0cyBvbmx5IHB1cnBvc2UgaXMKCS8vIHRvIHJldHVybiB0aGUgaHRtbCBlbmNvZGVkIHZlcnNpb24gb2YgdGhlIHRleHQgaW4gYWxsIGNhc2VzLiAodGh1cyB0aGUgbmFtZSkKCSQuZm4uZ2V0RW5jb2RlZFRleHQgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKS50ZXh0KCAkKHRoaXMpLnRleHQoKSApLmh0bWwoKTsKCX07CgoJLy8gZmx1ZW50IGhlbHBlciBmdW5jdGlvbiBmb3IgdGhlIG1vYmlsZSBuYW1lc3BhY2VkIGVxdWl2YWxlbnQKCSQuZm4uanFtRW5oYW5jZWFibGUgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoaXMgKTsKCX07CgoJJC5mbi5qcW1IaWphY2thYmxlID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmhpamFja2FibGUoIHRoaXMgKTsKCX07CgoJLy8gTW9ua2V5LXBhdGNoaW5nIFNpenpsZSB0byBmaWx0ZXIgdGhlIDpqcW1EYXRhIHNlbGVjdG9yCgl2YXIgb2xkRmluZCA9ICQuZmluZCwKCQlqcW1EYXRhUkUgPSAvOmpxbURhdGFcKChbXildKilcKS9nOwoKCSQuZmluZCA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApIHsKCQlzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoIGpxbURhdGFSRSwgIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAiJDFdIiApOwoKCQlyZXR1cm4gb2xkRmluZC5jYWxsKCB0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApOwoJfTsKCgkkLmV4dGVuZCggJC5maW5kLCBvbGRGaW5kICk7CgoJJC5maW5kLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgc2V0ICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIHNldCApOwoJfTsKCgkkLmZpbmQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgWyBub2RlIF0gKS5sZW5ndGggPiAwOwoJfTsKfSkoIGpRdWVyeSwgdGhpcyApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyICR3aW5kb3cgPSAkKCB3aW5kb3cgKSwKCSRodG1sID0gJCggImh0bWwiICk7CgovKiAkLm1vYmlsZS5tZWRpYSBtZXRob2Q6IHBhc3MgYSBDU1MgbWVkaWEgdHlwZSBvciBxdWVyeSBhbmQgZ2V0IGEgYm9vbCByZXR1cm4KCW5vdGU6IHRoaXMgZmVhdHVyZSByZWxpZXMgb24gYWN0dWFsIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgZm9yIG1lZGlhIHF1ZXJpZXMsIHRob3VnaCB0eXBlcyB3aWxsIHdvcmsgbW9zdCBhbnl3aGVyZQoJZXhhbXBsZXM6CgkJJC5tb2JpbGUubWVkaWEoJ3NjcmVlbicpIC8vIHRlc3RzIGZvciBzY3JlZW4gbWVkaWEgdHlwZQoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4gYW5kIChtaW4td2lkdGg6IDQ4MHB4KScpIC8vIHRlc3RzIGZvciBzY3JlZW4gbWVkaWEgdHlwZSB3aXRoIHdpbmRvdyB3aWR0aCA+IDQ4MHB4CgkJJC5tb2JpbGUubWVkaWEoJ0BtZWRpYSBzY3JlZW4gYW5kICgtd2Via2l0LW1pbi1kZXZpY2UtcGl4ZWwtcmF0aW86IDIpJykgLy8gdGVzdHMgZm9yIHdlYmtpdCAyeCBwaXhlbCByYXRpbyAoaVBob25lIDQpCiovCiQubW9iaWxlLm1lZGlhID0gKGZ1bmN0aW9uKCkgewoJLy8gVE9ETzogdXNlIHdpbmRvdy5tYXRjaE1lZGlhIG9uY2UgYXQgbGVhc3Qgb25lIFVBIGltcGxlbWVudHMgaXQKCXZhciBjYWNoZSA9IHt9LAoJCXRlc3REaXYgPSAkKCAiPGRpdiBpZD0nanF1ZXJ5LW1lZGlhdGVzdCc+PC9kaXY+IiApLAoJCWZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5hcHBlbmQoIHRlc3REaXYgKTsKCglyZXR1cm4gZnVuY3Rpb24oIHF1ZXJ5ICkgewoJCWlmICggISggcXVlcnkgaW4gY2FjaGUgKSApIHsKCQkJdmFyIHN0eWxlQmxvY2sgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3R5bGUiICksCgkJCQljc3NydWxlID0gIkBtZWRpYSAiICsgcXVlcnkgKyAiIHsgI2pxdWVyeS1tZWRpYXRlc3QgeyBwb3NpdGlvbjphYnNvbHV0ZTsgfSB9IjsKCgkJCS8vbXVzdCBzZXQgdHlwZSBmb3IgSUUhCgkJCXN0eWxlQmxvY2sudHlwZSA9ICJ0ZXh0L2NzcyI7CgoJCQlpZiAoIHN0eWxlQmxvY2suc3R5bGVTaGVldCAgKXsKCQkJCXN0eWxlQmxvY2suc3R5bGVTaGVldC5jc3NUZXh0ID0gY3NzcnVsZTsKCQkJfSBlbHNlIHsKCQkJCXN0eWxlQmxvY2suYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNzc3J1bGUpICk7CgkJCX0KCgkJCSRodG1sLnByZXBlbmQoIGZha2VCb2R5ICkucHJlcGVuZCggc3R5bGVCbG9jayApOwoJCQljYWNoZVsgcXVlcnkgXSA9IHRlc3REaXYuY3NzKCAicG9zaXRpb24iICkgPT09ICJhYnNvbHV0ZSI7CgkJCWZha2VCb2R5LmFkZCggc3R5bGVCbG9jayApLnJlbW92ZSgpOwoJCX0KCQlyZXR1cm4gY2FjaGVbIHF1ZXJ5IF07Cgl9Owp9KSgpOwoKfSkoalF1ZXJ5KTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5wcmVwZW5kVG8oICJodG1sIiApLAoJZmJDU1MgPSBmYWtlQm9keVsgMCBdLnN0eWxlLAoJdmVuZG9ycyA9IFsgIldlYmtpdCIsICJNb3oiLCAiTyIgXSwKCXdlYm9zID0gInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93LCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBzY3JvbGxUb3AKCW9wZXJhID0gd2luZG93Lm9wZXJhLAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5OyAvL29ubHkgdXNlZCB0byBydWxlIG91dCBib3ggc2hhZG93LCBhcyBpdCdzIGZpbGxlZCBvcGFxdWUgb24gQkIKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKTsKCglmb3IgKCB2YXIgdiBpbiBwcm9wcyApewoJCWlmICggZmJDU1NbIHByb3BzWyB2IF0gXSAhPT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIHZhbGlkU3R5bGUoIHByb3AsIHZhbHVlLCBjaGVja192ZW5kICkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAoJCXVjID0gZnVuY3Rpb24oIHR4dCApIHsKCQkJcmV0dXJuIHR4dC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgdHh0LnN1YnN0ciggMSApCgkJfSwKCQl2ZW5kX3ByZWYgPSBmdW5jdGlvbiggdmVuZCApIHsKCQkJcmV0dXJuICAiLSIgKyB2ZW5kLmNoYXJBdCggMCApLnRvTG93ZXJDYXNlKCkgKyB2ZW5kLnN1YnN0ciggMSApICsgIi0iOwoJCX0sCgkJY2hlY2tfc3R5bGUgPSBmdW5jdGlvbiggdmVuZCApIHsKCQkJdmFyIHZlbmRfcHJvcCA9IHZlbmRfcHJlZiggdmVuZCApICsgcHJvcCArICI6ICIgKyB2YWx1ZSArICI7IiwKCQkJCXVjX3ZlbmQgPSB1YyggdmVuZCApLAoJCQkJcHJvcFN0eWxlID0gdWNfdmVuZCArIHVjKCBwcm9wICk7CgkJCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoJCQoJCQlpZiggISFkaXYuc3R5bGVbIHByb3BTdHlsZSBdICkgewoJCQkJcmV0ID0gdHJ1ZTsKCQkJfQoJCX0sCgkJY2hlY2tfdmVuZHMgPSBjaGVja192ZW5kID8gWyBjaGVja192ZW5kIF0gOiB2ZW5kb3JzLAoJCXJldDsKCglmb3IoIGkgPSAwOyBpIDwgY2hlY2tfdmVuZHMubGVuZ3RoOyBpKysgKSB7CgkJY2hlY2tfc3R5bGUoIGNoZWNrX3ZlbmRzW2ldICk7Cgl9CglyZXR1cm4gISFyZXQ7Cn0KCi8vIFRoYW5rcyB0byBNb2Rlcm5penIgc3JjIGZvciB0aGlzIHRlc3QgaWRlYS4gYHBlcnNwZWN0aXZlYCBjaGVjayBpcyBsaW1pdGVkIHRvIE1veiB0byBwcmV2ZW50IGEgZmFsc2UgcG9zaXRpdmUgZm9yIDNEIHRyYW5zZm9ybXMgb24gQW5kcm9pZC4KZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIHByb3AgPSAidHJhbnNmb3JtLTNkIjsKCXJldHVybiB2YWxpZFN0eWxlKCAncGVyc3BlY3RpdmUnLCAnMTBweCcsICdtb3onICkgfHwgJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIHByb3AgKyAiKSwoLSIgKSArICItIiArIHByb3AgKyAiKSwoIiArIHByb3AgKyAiKSIgKTsKfQoKLy8gVGVzdCBmb3IgZHluYW1pYy11cGRhdGluZyBiYXNlIHRhZyBzdXBwb3J0ICggYWxsb3dzIHVzIHRvIGF2b2lkIGhyZWYsc3JjIGF0dHIgcmV3cml0aW5nICkKZnVuY3Rpb24gYmFzZVRhZ1Rlc3QoKSB7Cgl2YXIgZmF1eEJhc2UgPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUgKyAidWktZGlyLyIsCgkJYmFzZSA9ICQoICJoZWFkIGJhc2UiICksCgkJZmF1eEVsZSA9IG51bGwsCgkJaHJlZiA9ICIiLAoJCWxpbmssIHJlYmFzZTsKCglpZiAoICFiYXNlLmxlbmd0aCApIHsKCQliYXNlID0gZmF1eEVsZSA9ICQoICI8YmFzZT4iLCB7ICJocmVmIjogZmF1eEJhc2UgfSkuYXBwZW5kVG8oICJoZWFkIiApOwoJfSBlbHNlIHsKCQlocmVmID0gYmFzZS5hdHRyKCAiaHJlZiIgKTsKCX0KCglsaW5rID0gJCggIjxhIGhyZWY9J3Rlc3R1cmwnIC8+IiApLnByZXBlbmRUbyggZmFrZUJvZHkgKTsKCXJlYmFzZSA9IGxpbmtbIDAgXS5ocmVmOwoJYmFzZVsgMCBdLmhyZWYgPSBocmVmIHx8IGxvY2F0aW9uLnBhdGhuYW1lOwoKCWlmICggZmF1eEVsZSApIHsKCQlmYXV4RWxlLnJlbW92ZSgpOwoJfQoJcmV0dXJuIHJlYmFzZS5pbmRleE9mKCBmYXV4QmFzZSApID09PSAwOwp9CgovLyBUaGFua3MgTW9kZXJuaXpyCmZ1bmN0aW9uIGNzc1BvaW50ZXJFdmVudHNUZXN0KCkgewoJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd4JyksCgkJZG9jdW1lbnRFbGVtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCWdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSwKCQlzdXBwb3J0czsKCglpZiggISggJ3BvaW50ZXJFdmVudHMnIGluIGVsZW1lbnQuc3R5bGUgKSApewoJCXJldHVybiBmYWxzZTsKCX0KCgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnYXV0byc7CgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAneCc7CiAgICBkb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CglzdXBwb3J0cyA9IGdldENvbXB1dGVkU3R5bGUgJiYKICAgIGdldENvbXB1dGVkU3R5bGUoIGVsZW1lbnQsICcnICkucG9pbnRlckV2ZW50cyA9PT0gJ2F1dG8nOwoJZG9jdW1lbnRFbGVtZW50LnJlbW92ZUNoaWxkKCBlbGVtZW50ICk7CiAgICByZXR1cm4gISFzdXBwb3J0czsKfQoKCi8vIG5vbi1VQS1iYXNlZCBJRSB2ZXJzaW9uIGNoZWNrIGJ5IEphbWVzIFBhZG9sc2V5LCBtb2RpZmllZCBieSBqZGFsdG9uIC0gZnJvbSBodHRwOi8vZ2lzdC5naXRodWIuY29tLzUyNzY4MwovLyBhbGxvd3MgZm9yIGluY2x1c2lvbiBvZiBJRSA2KywgaW5jbHVkaW5nIFdpbmRvd3MgTW9iaWxlIDcKJC5leHRlbmQoICQubW9iaWxlLCB7IGJyb3dzZXI6IHt9IH0gKTsKJC5tb2JpbGUuYnJvd3Nlci5pZSA9IChmdW5jdGlvbigpIHsKCXZhciB2ID0gMywKCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCglhID0gZGl2LmFsbCB8fCBbXTsKCgkvLyBhZGRlZCB7fSB0byBzaWxlbmNlIGNsb3N1cmUgY29tcGlsZXIgd2FybmluZ3MuIHJlZ2lzdGVyaW5nIG15IGRpc2xpa2Ugb2YgYWxsIHRoaW5ncwoJLy8gb3Zlcmx5IGNsZXZlciBoZXJlIGZvciBmdXR1cmUgcmVmZXJlbmNlCgl3aGlsZSAoIGRpdi5pbm5lckhUTUwgPSAiPCEtLVtpZiBndCBJRSAiICsgKCArK3YgKSArICJdPjxicj48IVtlbmRpZl0tLT4iLCBhWyAwIF0gKXt9OwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCgokLmV4dGVuZCggJC5zdXBwb3J0LCB7CglvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiBpbiB3aW5kb3cgJiYgIm9ub3JpZW50YXRpb25jaGFuZ2UiIGluIHdpbmRvdywKCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQsCgljc3NUcmFuc2l0aW9uczogIldlYktpdFRyYW5zaXRpb25FdmVudCIgaW4gd2luZG93IHx8IHZhbGlkU3R5bGUoICd0cmFuc2l0aW9uJywgJ2hlaWdodCAxMDBtcyBsaW5lYXInICkgJiYgIW9wZXJhLAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmICJyZXBsYWNlU3RhdGUiIGluIGhpc3RvcnksCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJYm94U2hhZG93OiAhIXByb3BFeGlzdHMoICJib3hTaGFkb3ciICkgJiYgIWJiLAoJc2Nyb2xsVG9wOiAoICJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8ICJzY3JvbGxUb3AiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fCAic2Nyb2xsVG9wIiBpbiBmYWtlQm9keVsgMCBdICkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCglkeW5hbWljQmFzZVRhZzogYmFzZVRhZ1Rlc3QoKSwKCWNzc1BvaW50ZXJFdmVudHM6IGNzc1BvaW50ZXJFdmVudHNUZXN0KCkKfSk7CgpmYWtlQm9keS5yZW1vdmUoKTsKCgovLyAkLm1vYmlsZS5hamF4QmxhY2tsaXN0IGlzIHVzZWQgdG8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcyAoQkI1LCBTeW1iaWFuKQovLyBvciB0aGF0IGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKE9wZXJhIE1pbmkpCi8vIE5vdGU6IFRoaXMgZGV0ZWN0aW9uIGJlbG93IGlzIHVzZWQgYXMgYSBsYXN0IHJlc29ydC4KLy8gV2UgcmVjb21tZW5kIG9ubHkgdXNpbmcgdGhlc2UgZGV0ZWN0aW9uIG1ldGhvZHMgd2hlbiBhbGwgb3RoZXIgbW9yZSByZWxpYWJsZS9mb3J3YXJkLWxvb2tpbmcgYXBwcm9hY2hlcyBhcmUgbm90IHBvc3NpYmxlCnZhciBub2tpYUxURTdfMyA9IChmdW5jdGlvbigpewoKCXZhciB1YSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50OwoKCS8vVGhlIGZvbGxvd2luZyBpcyBhbiBhdHRlbXB0IHRvIG1hdGNoIE5va2lhIGJyb3dzZXJzIHRoYXQgYXJlIHJ1bm5pbmcgU3ltYmlhbi9zNjAsIHdpdGggd2Via2l0LCB2ZXJzaW9uIDcuMyBvciBvbGRlcgoJcmV0dXJuIHVhLmluZGV4T2YoICJOb2tpYSIgKSA+IC0xICYmCgkJCSggdWEuaW5kZXhPZiggIlN5bWJpYW4vMyIgKSA+IC0xIHx8IHVhLmluZGV4T2YoICJTZXJpZXM2MC81IiApID4gLTEgKSAmJgoJCQl1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSAmJgoJCQl1YS5tYXRjaCggLyhCcm93c2VyTkd8Tm9raWFCcm93c2VyKVwvN1wuWzAtM10vICk7Cn0pKCk7CgovLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCi8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKJC5tb2JpbGUuZ3JhZGVBID0gZnVuY3Rpb24oKXsKCXJldHVybiAkLnN1cHBvcnQubWVkaWFxdWVyeSB8fCAkLm1vYmlsZS5icm93c2VyLmllICYmICQubW9iaWxlLmJyb3dzZXIuaWUgPj0gNzsKfTsKCiQubW9iaWxlLmFqYXhCbGFja2xpc3QgPQoJCQkvLyBCbGFja0JlcnJ5IGJyb3dzZXJzLCBwcmUtd2Via2l0CgkJCXdpbmRvdy5ibGFja2JlcnJ5ICYmICF3aW5kb3cuV2ViS2l0UG9pbnQgfHwKCQkJLy8gT3BlcmEgTWluaQoJCQlvcGVyYW1pbmkgfHwKCQkJLy8gU3ltYmlhbiB3ZWJraXRzIHByZSA3LjMKCQkJbm9raWFMVEU3XzM7CgovLyBMYXN0bHksIHRoaXMgd29ya2Fyb3VuZCBpcyB0aGUgb25seSB3YXkgd2UndmUgZm91bmQgc28gZmFyIHRvIGdldCBwcmUgNy4zIFN5bWJpYW4gd2Via2l0IGRldmljZXMKLy8gdG8gcmVuZGVyIHRoZSBzdHlsZXNoZWV0cyB3aGVuIHRoZXkncmUgcmVmZXJlbmNlZCBiZWZvcmUgdGhpcyBzY3JpcHQsIGFzIHdlJ2QgcmVjb21tZW5kIGRvaW5nLgovLyBUaGlzIHNpbXBseSByZWFwcGVuZHMgdGhlIENTUyBpbiBwbGFjZSwgd2hpY2ggZm9yIHNvbWUgcmVhc29uIG1ha2VzIGl0IGFwcGx5CmlmICggbm9raWFMVEU3XzMgKSB7CgkkKGZ1bmN0aW9uKCkgewoJCSQoICJoZWFkIGxpbmtbcmVsPSdzdHlsZXNoZWV0J10iICkuYXR0ciggInJlbCIsICJhbHRlcm5hdGUgc3R5bGVzaGVldCIgKS5hdHRyKCAicmVsIiwgInN0eWxlc2hlZXQiICk7Cgl9KTsKfQoKLy8gRm9yIHJ1bGluZyBvdXQgc2hhZG93cyB2aWEgY3NzCmlmICggISQuc3VwcG9ydC5ib3hTaGFkb3cgKSB7CgkkKCAiaHRtbCIgKS5hZGRDbGFzcyggInVpLW1vYmlsZS1ub3N1cHBvcnQtYm94c2hhZG93IiApOwp9Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gYWRkIG5ldyBldmVudCBzaG9ydGN1dHMKJC5lYWNoKCAoICJ0b3VjaHN0YXJ0IHRvdWNobW92ZSB0b3VjaGVuZCBvcmllbnRhdGlvbmNoYW5nZSB0aHJvdHRsZWRyZXNpemUgIiArCgkJCQkJInRhcCB0YXBob2xkIHN3aXBlIHN3aXBlbGVmdCBzd2lwZXJpZ2h0IHNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBuYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBuYW1lICk7Cgl9OwoKCSQuYXR0ckZuWyBuYW1lIF0gPSB0cnVlOwp9KTsKCnZhciBzdXBwb3J0VG91Y2ggPSAkLnN1cHBvcnQudG91Y2gsCglzY3JvbGxFdmVudCA9ICJ0b3VjaG1vdmUgc2Nyb2xsIiwKCXRvdWNoU3RhcnRFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaHN0YXJ0IiA6ICJtb3VzZWRvd24iLAoJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJdG91Y2hNb3ZlRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2htb3ZlIiA6ICJtb3VzZW1vdmUiOwoKZnVuY3Rpb24gdHJpZ2dlckN1c3RvbUV2ZW50KCBvYmosIGV2ZW50VHlwZSwgZXZlbnQgKSB7Cgl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgkkLmV2ZW50LmhhbmRsZS5jYWxsKCBvYmosIGV2ZW50ICk7CglldmVudC50eXBlID0gb3JpZ2luYWxUeXBlOwp9CgovLyBhbHNvIGhhbmRsZXMgc2Nyb2xsc3RvcAokLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQgPSB7CgoJZW5hYmxlZDogdHJ1ZSwKCglzZXR1cDogZnVuY3Rpb24oKSB7CgoJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCXNjcm9sbGluZywKCQkJdGltZXI7CgoJCWZ1bmN0aW9uIHRyaWdnZXIoIGV2ZW50LCBzdGF0ZSApIHsKCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgc2Nyb2xsaW5nID8gInNjcm9sbHN0YXJ0IiA6ICJzY3JvbGxzdG9wIiwgZXZlbnQgKTsKCQl9CgoJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJJHRoaXMuYmluZCggc2Nyb2xsRXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoICFzY3JvbGxpbmcgKSB7CgkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQl9CgoJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCXRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCXRyaWdnZXIoIGV2ZW50LCBmYWxzZSApOwoJCQl9LCA1MCApOwoJCX0pOwoJfQp9OwoKLy8gYWxzbyBoYW5kbGVzIHRhcGhvbGQKJC5ldmVudC5zcGVjaWFsLnRhcCA9IHsKCXNldHVwOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCSR0aGlzID0gJCggdGhpc09iamVjdCApOwoKCQkkdGhpcy5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCWlmICggZXZlbnQud2hpY2ggJiYgZXZlbnQud2hpY2ggIT09IDEgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBvcmlnVGFyZ2V0ID0gZXZlbnQudGFyZ2V0LAoJCQkJb3JpZ0V2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudCwKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gY2xlYXJUYXBUaW1lcigpIHsKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJfQoKCQkJZnVuY3Rpb24gY2xlYXJUYXBIYW5kbGVycygpIHsKCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkkdGhpcy51bmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKQoJCQkJCS51bmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKTsKCQkJCSQoIGRvY3VtZW50ICkudW5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoJCQl9CgoJCQlmdW5jdGlvbiBjbGlja0hhbmRsZXIoZXZlbnQpIHsKCQkJCWNsZWFyVGFwSGFuZGxlcnMoKTsKCgkJCQkvLyBPTkxZIHRyaWdnZXIgYSAndGFwJyBldmVudCBpZiB0aGUgc3RhcnQgdGFyZ2V0IGlzCgkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQlpZiAoIG9yaWdUYXJnZXQgPT0gZXZlbnQudGFyZ2V0ICkgewoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcCIsIGV2ZW50ICk7CgkJCQl9CgkJCX0KCgkJCSR0aGlzLmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKQoJCQkJLmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKTsKCQkJJCggZG9jdW1lbnQgKS5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoKCQkJdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0IH0gKSApOwoJCQl9LCA3NTAgKTsKCQl9KTsKCX0KfTsKCi8vIGFsc28gaGFuZGxlcyBzd2lwZWxlZnQsIHN3aXBlcmlnaHQKJC5ldmVudC5zcGVjaWFsLnN3aXBlID0gewoJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMTAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJZHVyYXRpb25UaHJlc2hvbGQ6IDEwMDAsIC8vIE1vcmUgdGltZSB0aGFuIHRoaXMsIGFuZCBpdCBpc24ndCBhIHN3aXBlLgoKCWhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZDogMzAsICAvLyBTd2lwZSBob3Jpem9udGFsIGRpc3BsYWNlbWVudCBtdXN0IGJlIG1vcmUgdGhhbiB0aGlzLgoKCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZGF0YSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyA/CgkJCQkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudCwKCQkJCXN0YXJ0ID0gewoJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdLAoJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCX0sCgkJCQlzdG9wOwoKCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoKCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgZGF0YSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyA/CgkJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgoJCQkJc3RvcCA9IHsKCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJfTsKCgkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJaWYgKCBNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZCApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9CgoJCQkkdGhpcy5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKQoJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkkdGhpcy51bmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApOwoKCQkJCQlpZiAoIHN0YXJ0ICYmIHN0b3AgKSB7CgkJCQkJCWlmICggc3RvcC50aW1lIC0gc3RhcnQudGltZSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5kdXJhdGlvblRocmVzaG9sZCAmJgoJCQkJCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQgJiYKCQkJCQkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCgkJCQkJCQlzdGFydC5vcmlnaW4udHJpZ2dlciggInN3aXBlIiApCgkJCQkJCQkJLnRyaWdnZXIoIHN0YXJ0LmNvb3Jkc1swXSA+IHN0b3AuY29vcmRzWyAwIF0gPyAic3dpcGVsZWZ0IiA6ICJzd2lwZXJpZ2h0IiApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXN0YXJ0ID0gc3RvcCA9IHVuZGVmaW5lZDsKCQkJCX0pOwoJCX0pOwoJfQp9OwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyAiQ293Ym95IiBCZW4gQWxtYW4KCgl2YXIgd2luID0gJCggd2luZG93ICksCgkJc3BlY2lhbF9ldmVudCwKCQlnZXRfb3JpZW50YXRpb24sCgkJbGFzdF9vcmllbnRhdGlvbiwKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSwKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQsCgkJcG9ydHJhaXRfbWFwID0geyAiMCI6IHRydWUsICIxODAiOiB0cnVlIH07CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXZhciB3dyA9IHdpbmRvdy5pbm5lcldpZHRoIHx8ICQoIHdpbmRvdyApLndpZHRoKCksCgkJCXdoID0gd2luZG93LmlubmVySGVpZ2h0IHx8ICQoIHdpbmRvdyApLmhlaWdodCgpLAoJCQlsYW5kc2NhcGVfdGhyZXNob2xkID0gNTA7CgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gd3cgPiB3aCAmJiAoIHd3IC0gd2ggKSA+IGxhbmRzY2FwZV90aHJlc2hvbGQ7CgoKCQkvLyBOb3cgY2hlY2sgdG8gc2VlIGlmIHRoZSBjdXJyZW50IHdpbmRvdy5vcmllbnRhdGlvbiBpcyAwIG9yIDE4MC4KCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoKCQkvLyBJZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBsYW5kc2NhcGUsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyAwIG9yIDE4MCwgKk9SKgoJCS8vIGlmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIHBvcnRyYWl0LCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgOTAgb3IgLTkwLCB3ZQoJCS8vIG5lZWQgdG8gZmxpcCBvdXIgcG9ydHJhaXRfbWFwIHZhbHVlcyBiZWNhdXNlIGxhbmRzY2FwZSBpcyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBmb3IKCQkvLyB0aGlzIGRldmljZS9icm93c2VyLgoJCWlmICggKCBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiBpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSB8fCAoICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgKSB7CgkJCXBvcnRyYWl0X21hcCA9IHsgIi05MCI6IHRydWUsICI5MCI6IHRydWUgfTsKCQl9Cgl9CgoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlID0gc3BlY2lhbF9ldmVudCA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0IGpRdWVyeQoJCQkvLyB3aWxsIGJpbmQgdG8gdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAkLm1vYmlsZS5vcmllbnRhdGlvbkNoYW5nZUVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiB0byBhdm9pZCBpbml0aWFsIGRvdWJsZS10cmlnZ2VyaW5nLgoJCQlsYXN0X29yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCBzaW11bGF0ZSB0aGUKCQkJLy8gZXZlbnQgYnkgdGVzdGluZyB3aW5kb3cgZGltZW5zaW9ucyBvbiByZXNpemUuCgkJCXdpbi5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCl7CgkJCS8vIElmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfTsKCgkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgdGhpcyBoYW5kbGVyIHdpbGwgYmUgYm91bmQgdG8KCS8vIHRoZSB3aW5kb3cgcmVzaXplIGV2ZW50IHRvIHNpbXVsYXRlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCWZ1bmN0aW9uIGhhbmRsZXIoKSB7CgkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uLgoJCXZhciBvcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQlpZiAoIG9yaWVudGF0aW9uICE9PSBsYXN0X29yaWVudGF0aW9uICkgewoJCQkvLyBUaGUgb3JpZW50YXRpb24gaGFzIGNoYW5nZWQsIHNvIHRyaWdnZXIgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJCQlsYXN0X29yaWVudGF0aW9uID0gb3JpZW50YXRpb247CgkJCXdpbi50cmlnZ2VyKCAib3JpZW50YXRpb25jaGFuZ2UiICk7CgkJfQoJfQoKCS8vIEdldCB0aGUgY3VycmVudCBwYWdlIG9yaWVudGF0aW9uLiBUaGlzIG1ldGhvZCBpcyBleHBvc2VkIHB1YmxpY2x5LCBzaG91bGQgaXQKCS8vIGJlIG5lZWRlZCwgYXMgalF1ZXJ5LmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24oKQoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJdmFyIGlzUG9ydHJhaXQgPSB0cnVlLCBlbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCQkvLyBwcmVmZXIgd2luZG93IG9yaWVudGF0aW9uIHRvIHRoZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBzY3JlZW5zaXplIGFzCgkJLy8gdGhlIGFjdHVhbCBzY3JlZW4gcmVzaXplIHRha2VzIHBsYWNlIGJlZm9yZSBvciBhZnRlciB0aGUgb3JpZW50YXRpb24gY2hhbmdlIGV2ZW50CgkJLy8gaGFzIGJlZW4gZmlyZWQgZGVwZW5kaW5nIG9uIGltcGxlbWVudGF0aW9uIChlZyBhbmRyb2lkIDIuMyBpcyBiZWZvcmUsIGlwaG9uZSBhZnRlcikuCgkJLy8gTW9yZSB0ZXN0aW5nIGlzIHJlcXVpcmVkIHRvIGRldGVybWluZSBpZiBhIG1vcmUgcmVsaWFibGUgbWV0aG9kIG9mIGRldGVybWluaW5nIHRoZSBuZXcgc2NyZWVuc2l6ZQoJCS8vIGlzIHBvc3NpYmxlIHdoZW4gb3JpZW50YXRpb25jaGFuZ2UgaXMgZmlyZWQuIChlZywgdXNlIG1lZGlhIHF1ZXJpZXMgKyBlbGVtZW50ICsgb3BhY2l0eSkKCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCQkJLy8gaWYgdGhlIHdpbmRvdyBvcmllbnRhdGlvbiByZWdpc3RlcnMgYXMgMCBvciAxODAgZGVncmVlcyByZXBvcnQKCQkJLy8gcG9ydHJhaXQsIG90aGVyd2lzZSBsYW5kc2NhcGUKCQkJaXNQb3J0cmFpdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgkJfSBlbHNlIHsKCQkJaXNQb3J0cmFpdCA9IGVsZW0gJiYgZWxlbS5jbGllbnRXaWR0aCAvIGVsZW0uY2xpZW50SGVpZ2h0IDwgMS4xOwoJCX0KCgkJcmV0dXJuIGlzUG9ydHJhaXQgPyAicG9ydHJhaXQiIDogImxhbmRzY2FwZSI7Cgl9OwoKfSkoIGpRdWVyeSwgd2luZG93ICk7CgoKLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAooZnVuY3Rpb24oKSB7CgoJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCl7CgkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJfQoJfTsKCgl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJfSBlbHNlIHsKCgkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCX0KCgkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJfQoJCX0sCgkJbGFzdENhbGwgPSAwLAoJCWhlbGRDYWxsLAoJCWN1cnIsCgkJZGlmZjsKfSkoKTsKCgokLmVhY2goewoJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCXRhcGhvbGQ6ICJ0YXAiLAoJc3dpcGVsZWZ0OiAic3dpcGUiLAoJc3dpcGVyaWdodDogInN3aXBlIgp9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCSQuZXZlbnQuc3BlY2lhbFsgZXZlbnQgXSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogImMiLAoJCWRvbUNhY2hlOiBmYWxzZSwKCQlrZWVwTmF0aXZlRGVmYXVsdDogIjpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCgkJLy8gaWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYoIHNlbGYuX3RyaWdnZXIoICJiZWZvcmVjcmVhdGUiICkgPT09IGZhbHNlICl7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXNlbGYuZWxlbWVudAoJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJLmFkZENsYXNzKCAidWktcGFnZSB1aS1ib2R5LSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKQoJCQkuYmluZCggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oKXsKCQkJCXNlbGYucmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCgpOwoJCQl9ICkKCQkJLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCl7CgkJCQlzZWxmLnNldENvbnRhaW5lckJhY2tncm91bmQoKTsKCQkJfSApOwoKCX0sCgkKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCl7CgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQucGFyZW50KCkgKSApOwoJfSwKCQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKXsKCQlpZiggdGhpcy5vcHRpb25zLnRoZW1lICl7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyAoIHRoZW1lIHx8IHRoaXMub3B0aW9ucy50aGVtZSApICk7CgkJfQoJfSwKCglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlRGVmaW5lZCA9IG9wdGlvbnMua2VlcE5hdGl2ZSAmJiAkLnRyaW0ob3B0aW9ucy5rZWVwTmF0aXZlKTsKCgkJaWYoIGtlZXBOYXRpdmVEZWZpbmVkICYmIG9wdGlvbnMua2VlcE5hdGl2ZSAhPT0gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdCApewoJCQlyZXR1cm4gW29wdGlvbnMua2VlcE5hdGl2ZSwgb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdF0uam9pbigiLCAiKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0OwoJfQp9KTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgp2YXIgY3JlYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCBzZXF1ZW50aWFsICl7CgkKCS8vIERlZmF1bHQgdG8gc2VxdWVudGlhbAoJaWYoIHNlcXVlbnRpYWwgPT09IHVuZGVmaW5lZCApewoJCXNlcXVlbnRpYWwgPSB0cnVlOwoJfQoJCglyZXR1cm4gZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20gKSB7CgoJCXZhciBkZWZlcnJlZCA9IG5ldyAkLkRlZmVycmVkKCksCgkJCXJldmVyc2VDbGFzcyA9IHJldmVyc2UgPyAiIHJldmVyc2UiIDogIiIsCgkJCWFjdGl2ZQk9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCksCgkJCXRvU2Nyb2xsID0gYWN0aXZlLmxhc3RTY3JvbGwgfHwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwsCgkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQltYXhUcmFuc2l0aW9uT3ZlcnJpZGUgPSAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGggIT09IGZhbHNlICYmICQoIHdpbmRvdyApLndpZHRoKCkgPiAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGgsCgkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8IG1heFRyYW5zaXRpb25PdmVycmlkZSB8fCAhbmFtZSB8fCBuYW1lID09PSAibm9uZSIgfHwgTWF0aC5tYXgoICQoIHdpbmRvdyApLnNjcm9sbFRvcCgpLCB0b1Njcm9sbCApID4gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbigpLAoJCQl0b1ByZUNsYXNzID0gIiB1aS1wYWdlLXByZS1pbiIsCgkJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MgPSBmdW5jdGlvbigpewoJCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci50b2dnbGVDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyBuYW1lICk7CgkJCX0sCgkJCXNjcm9sbFBhZ2UgPSBmdW5jdGlvbigpewoJCQkJLy8gQnkgdXNpbmcgc2Nyb2xsVG8gaW5zdGVhZCBvZiBzaWxlbnRTY3JvbGwsIHdlIGNhbiBrZWVwIHRoaW5ncyBiZXR0ZXIgaW4gb3JkZXIKCQkJCS8vIEp1c3QgdG8gYmUgcHJlY2F1dGlvcywgZGlzYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgkJCQkKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdG9TY3JvbGwgKTsKCQkJCQoJCQkJLy8gcmVlbmFibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJCX0sIDE1MCApOwoJCQl9LAoJCQljbGVhbkZyb20gPSBmdW5jdGlvbigpewoJCQkJJGZyb20KCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgb3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgkJCX0sCgkJCXN0YXJ0T3V0ID0gZnVuY3Rpb24oKXsKCQkJCS8vIGlmIGl0J3Mgbm90IHNlcXVlbnRpYWwsIGNhbGwgdGhlIGRvbmVPdXQgdHJhbnNpdGlvbiB0byBzdGFydCB0aGUgVE8gcGFnZSBhbmltYXRpbmcgaW4gc2ltdWx0YW5lb3VzbHkKCQkJCWlmKCAhc2VxdWVudGlhbCApewoJCQkJCWRvbmVPdXQoKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCSRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCBkb25lT3V0ICk7CQoJCQkJfQoJCQkJCgkJCQkvLyBTZXQgdGhlIGZyb20gcGFnZSdzIGhlaWdodCBhbmQgc3RhcnQgaXQgdHJhbnNpdGlvbmluZyBvdXQKCQkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCQkkZnJvbQoJCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQod2luZG93ICkuc2Nyb2xsVG9wKCkgKQoJCQkJCS5hZGRDbGFzcyggbmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCQl9LAoJCQkKCQkJZG9uZU91dCA9IGZ1bmN0aW9uKCkgewoKCQkJCWlmICggJGZyb20gJiYgc2VxdWVudGlhbCApIHsKCQkJCQljbGVhbkZyb20oKTsKCQkJCX0KCQkJCQoJCQkJc3RhcnRJbigpOwoJCQl9LAoJCQkKCQkJc3RhcnRJbiA9IGZ1bmN0aW9uKCl7CQoJCQkKCQkJCS8vcHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcgoJCQkJJHRvLmNzcygiei1pbmRleCIsIC0xMCk7CgoJCQkJJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyB0b1ByZUNsYXNzICk7CQkJCgkJCQoJCQkJLy8gU2VuZCBmb2N1cyB0byBwYWdlIGFzIGl0IGlzIG5vdyBkaXNwbGF5OiBibG9jawoJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCAkdG8gKTsKCgkJCQkvLyBTZXQgdG8gcGFnZSBoZWlnaHQKCQkJCSR0by5oZWlnaHQoIHNjcmVlbkhlaWdodCArIHRvU2Nyb2xsICk7CgkJCQkKCQkJCXNjcm9sbFBhZ2UoKTsKCgkJCQkvL3Jlc3RvcmVzIHZpc2liaWxpdHkgb2YgdGhlIG5ldyBwYWdlCgkJCQkkdG8uY3NzKCJ6LWluZGV4IiwgIiIpOwoJCQkJCgkJCQlpZiggIW5vbmUgKXsKCQkJCQkkdG8uYW5pbWF0aW9uQ29tcGxldGUoIGRvbmVJbiApOwoJCQkJfQoJCQkJCgkJCQkkdG8KCQkJCQkucmVtb3ZlQ2xhc3MoIHRvUHJlQ2xhc3MgKQoJCQkJCS5hZGRDbGFzcyggbmFtZSArICIgaW4iICsgcmV2ZXJzZUNsYXNzICk7CgkJCQkKCQkJCWlmKCBub25lICl7CgkJCQkJZG9uZUluKCk7CgkJCQl9CgkJCQkKCQkJfSwKCQkKCQkJZG9uZUluID0gZnVuY3Rpb24oKSB7CgkJCQoJCQkJaWYgKCAhc2VxdWVudGlhbCApIHsKCQkJCQkKCQkJCQlpZiggJGZyb20gKXsKCQkJCQkJY2xlYW5Gcm9tKCk7CgkJCQkJfQoJCQkJfQoJCQkKCQkJCSR0bwoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCBpbiByZXZlcnNlICIgKyBuYW1lICkKCQkJCQkuaGVpZ2h0KCAiIiApOwoJCQkJCgkJCQl0b2dnbGVWaWV3cG9ydENsYXNzKCk7CgkJCQkKCQkJCS8vIEluIHNvbWUgYnJvd3NlcnMgKGlPUzUpLCAzRCB0cmFuc2l0aW9ucyBibG9jayB0aGUgYWJpbGl0eSB0byBzY3JvbGwgdG8gdGhlIGRlc2lyZWQgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXRpb24KCQkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCQlpZiggJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgIT09IHRvU2Nyb2xsICl7CgkJCQkJc2Nyb2xsUGFnZSgpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlc29sdmUoIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIHRydWUgKTsKCQkJfTsKCgkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoJCgkJaWYgKCAkZnJvbSAmJiAhbm9uZSApIHsKCQkJc3RhcnRPdXQoKTsKCQl9CgkJZWxzZSB7CgkJCWRvbmVPdXQoKTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9Owp9CgovLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKdmFyIHNlcXVlbnRpYWxIYW5kbGVyID0gY3JlYXRlSGFuZGxlcigpLAoJc2ltdWx0YW5lb3VzSGFuZGxlciA9IGNyZWF0ZUhhbmRsZXIoIGZhbHNlICksCglkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSAqIDM7Cgl9OwoKLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHRoZSBwdWJsaWMgZGVmYXVsdC4KJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gc2VxdWVudGlhbEhhbmRsZXI7CgovL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJImRlZmF1bHQiOiAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIsCgkic2VxdWVudGlhbCI6IHNlcXVlbnRpYWxIYW5kbGVyLAoJInNpbXVsdGFuZW91cyI6IHNpbXVsdGFuZW91c0hhbmRsZXIKfTsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MgPSB7fTsKCi8vIFNldCB0aGUgZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB0byBkZWZhdWx0IGlmIG5vIGltcGxlbWVudGF0aW9uIHdhcyBzZXQgYnkgdXNlcgokLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKfSkoIGpRdWVyeSwgdGhpcyApOwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgl2YXIgJHdpbmRvdyA9ICQoIHdpbmRvdyApLAoJCSRodG1sID0gJCggJ2h0bWwnICksCgkJJGhlYWQgPSAkKCAnaGVhZCcgKSwKCgkJLy91cmwgcGF0aCBoZWxwZXJzIGZvciB1c2UgaW4gcmVsYXRpdmUgdXJsIG1hbmFnZW1lbnQKCQlwYXRoID0gewoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy8gQWJzdHJhY3Rpb24gdG8gYWRkcmVzcyB4c3MgKElzc3VlICM0Nzg3KSBieSByZW1vdmluZyB0aGUgYXV0aG9yaXR5IGluCgkJCS8vIGJyb3dzZXJzIHRoYXQgYXV0bwlkZWNvZGUgaXQuIEFsbCByZWZlcmVuY2VzIHRvIGxvY2F0aW9uLmhyZWYgc2hvdWxkIGJlCgkJCS8vIHJlcGxhY2VkIHdpdGggYSBjYWxsIHRvIHRoaXMgbWV0aG9kIHNvIHRoYXQgaXQgY2FuIGJlIGRlYWx0IHdpdGggcHJvcGVybHkgaGVyZQoJCQlnZXRMb2NhdGlvbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1cmkgPSB1cmwgPyB0aGlzLnBhcnNlVXJsKCB1cmwgKSA6IGxvY2F0aW9uLAoJCQkJCWhhc2ggPSB0aGlzLnBhcnNlVXJsKCB1cmwgfHwgbG9jYXRpb24uaHJlZiApLmhhc2g7CgoJCQkJLy8gbWltaWMgdGhlIGJyb3dzZXIgd2l0aCBhbiBlbXB0eSBzdHJpbmcgd2hlbiB0aGUgaGFzaCBpcyBlbXB0eQoJCQkJaGFzaCA9IGhhc2ggPT09ICIjIiA/ICIiIDogaGFzaDsKCgkJCQkvLyBNYWtlIHN1cmUgdG8gcGFyc2UgdGhlIHVybCBvciB0aGUgbG9jYXRpb24gb2JqZWN0IGZvciB0aGUgaGFzaCBiZWNhdXNlIHVzaW5nIGxvY2F0aW9uLmhhc2gKCQkJCS8vIGlzIGF1dG9kZWNvZGVkIGluIGZpcmVmb3gsIHRoZSByZXN0IG9mIHRoZSB1cmwgc2hvdWxkIGJlIGZyb20gdGhlIG9iamVjdCAobG9jYXRpb24gdW5sZXNzCgkJCQkvLyB3ZSdyZSB0ZXN0aW5nKSB0byBhdm9pZCB0aGUgaW5jbHVzaW9uIG9mIHRoZSBhdXRob3JpdHkKCQkJCXJldHVybiB1cmkucHJvdG9jb2wgKyAiLy8iICsgdXJpLmhvc3QgKyB1cmkucGF0aG5hbWUgKyB1cmkuc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCXBhcnNlTG9jYXRpb246IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMucGFyc2VVcmwoIHRoaXMuZ2V0TG9jYXRpb24oKSApOwoJCQl9LAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQl2YXIgYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXSwKCQkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCWlmICggYWJzVXJsID09PSB1bmRlZmluZWQgKSB7CgkJCQkJYWJzVXJsID0gZG9jdW1lbnRCYXNlOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJICAgIC8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCSAgICAvLyBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0ucmVwbGFjZSggL14jLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCBkb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJCX0KCQkJCXJldHVybiBhYnNVcmw7CgkJCX0sCgoJCQkvL2dldCBwYXRoIGZyb20gY3VycmVudCBoYXNoLCBvciBmcm9tIGEgZmlsZSBwYXRoCgkJCWdldDogZnVuY3Rpb24oIG5ld1BhdGggKSB7CgkJCQlpZiggbmV3UGF0aCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCW5ld1BhdGggPSBsb2NhdGlvbi5oYXNoOwoJCQkJfQoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBuZXdQYXRoICkucmVwbGFjZSggL1teXC9dKlwuW15cLypdKyQvLCAnJyApOwoJCQl9LAoKCQkJLy9yZXR1cm4gdGhlIHN1YnN0cmluZyBvZiBhIGZpbGVwYXRoIGJlZm9yZSB0aGUgc3ViLXBhZ2Uga2V5LCBmb3IgbWFraW5nIGEgc2VydmVyIHJlcXVlc3QKCQkJZ2V0RmlsZVBhdGg6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJdmFyIHNwbGl0a2V5ID0gJyYnICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleTsKCQkJCXJldHVybiBwYXRoICYmIHBhdGguc3BsaXQoIHNwbGl0a2V5IClbMF0uc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJfSwKCgkJCS8vc2V0IGxvY2F0aW9uIGhhc2ggdG8gcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJbG9jYXRpb24uaGFzaCA9IHBhdGg7CgkJCX0sCgoJCQkvL3Rlc3QgaWYgYSBnaXZlbiB1cmwgKHN0cmluZykgaXMgYSBwYXRoCgkJCS8vTk9URSBtaWdodCBiZSBleGNlcHRpb25hbGx5IG5haXZlCgkJCWlzUGF0aDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9cLy8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIGEgdXJsIHBhdGggd2l0aCB0aGUgd2luZG93J3MgbG9jYXRpb24gcHJvdG9jb2wvaG9zdG5hbWUvcGF0aG5hbWUgcmVtb3ZlZAoJCQljbGVhbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKTsKCQkJfSwKCgkJCS8vanVzdCByZXR1cm4gdGhlIHVybCB3aXRob3V0IGFuIGluaXRpYWwgIwoJCQlzdHJpcEhhc2g6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9eIy8sICIiICk7CgkJCX0sCgoJCQkvL3JlbW92ZSB0aGUgcHJlY2VkaW5nIGhhc2gsIGFueSBxdWVyeSBwYXJhbXMsIGFuZCBkaWFsb2cgbm90YXRpb25zCgkJCWNsZWFuSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIGhhc2gucmVwbGFjZSggL1w/LiokLywgIiIgKS5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICk7CgkJCX0sCgoJCQlpc0hhc2hWYWxpZDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gL14jW14jXSskLy50ZXN0KGhhc2gpOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IGRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBkb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkJLy8gZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoL14jLykudGVzdCggdS5ocmVmICk7CgkJCX0sCgoKCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCWlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0OiBmdW5jdGlvbiggZG9jVXJsLCByZXFVcmwgKSB7CgkJCQlyZXR1cm4gJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzCgkJCQkJJiYgZG9jVXJsLnByb3RvY29sID09PSAiZmlsZToiCgkJCQkJJiYgcmVxVXJsLnNlYXJjaCggL15odHRwcz86LyApICE9IC0xOwoJCQl9CgkJfSwKCgkJLy93aWxsIGJlIGRlZmluZWQgd2hlbiBhIGxpbmsgaXMgY2xpY2tlZCBhbmQgZ2l2ZW4gYW4gYWN0aXZlIGNsYXNzCgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbCwKCgkJLy91cmxIaXN0b3J5IGlzIHB1cmVseSBoZXJlIHRvIG1ha2UgZ3Vlc3NlcyBhdCB3aGV0aGVyIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIHdhcyBjbGlja2VkCgkJLy9hbmQgcHJvdmlkZSBhbiBhcHByb3ByaWF0ZSB0cmFuc2l0aW9uCgkJdXJsSGlzdG9yeSA9IHsKCQkJLy8gQXJyYXkgb2YgcGFnZXMgdGhhdCBhcmUgdmlzaXRlZCBkdXJpbmcgYSBzaW5nbGUgcGFnZSBsb2FkLgoJCQkvLyBFYWNoIGhhcyBhIHVybCBhbmQgb3B0aW9uYWwgdHJhbnNpdGlvbiwgdGl0bGUsIGFuZCBwYWdlVXJsICh3aGljaCByZXByZXNlbnRzIHRoZSBmaWxlIHBhdGgsIGluIGNhc2VzIHdoZXJlIFVSTCBpcyBvYnNjdXJlZCwgc3VjaCBhcyBkaWFsb2dzKQoJCQlzdGFjazogW10sCgoJCQkvL21haW50YWluIGFuIGluZGV4IG51bWJlciBmb3IgdGhlIGFjdGl2ZSBwYWdlIGluIHRoZSBzdGFjawoJCQlhY3RpdmVJbmRleDogMCwKCgkJCS8vZ2V0IGFjdGl2ZQoJCQlnZXRBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggXTsKCQkJfSwKCgkJCWdldFByZXY6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggLSAxIF07CgkJCX0sCgoJCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB1cmxIaXN0b3J5LnN0YWNrWyB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ICsgMSBdOwoJCQl9LAoKCQkJLy8gYWRkTmV3IGlzIHVzZWQgd2hlbmV2ZXIgYSBuZXcgcGFnZSBpcyBhZGRlZAoJCQlhZGROZXc6IGZ1bmN0aW9uKCB1cmwsIHRyYW5zaXRpb24sIHRpdGxlLCBwYWdlVXJsLCByb2xlICkgewoJCQkJLy9pZiB0aGVyZSdzIGZvcndhcmQgaGlzdG9yeSwgd2lwZSBpdAoJCQkJaWYoIHVybEhpc3RvcnkuZ2V0TmV4dCgpICkgewoJCQkJCXVybEhpc3RvcnkuY2xlYXJGb3J3YXJkKCk7CgkJCQl9CgoJCQkJdXJsSGlzdG9yeS5zdGFjay5wdXNoKCB7dXJsIDogdXJsLCB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCB0aXRsZTogdGl0bGUsIHBhZ2VVcmw6IHBhZ2VVcmwsIHJvbGU6IHJvbGUgfSApOwoKCQkJCXVybEhpc3RvcnkuYWN0aXZlSW5kZXggPSB1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCAtIDE7CgkJCX0sCgoJCQkvL3dpcGUgdXJscyBhaGVhZCBvZiBhY3RpdmUgaW5kZXgKCQkJY2xlYXJGb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJCXVybEhpc3Rvcnkuc3RhY2sgPSB1cmxIaXN0b3J5LnN0YWNrLnNsaWNlKCAwLCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ICsgMSApOwoJCQl9LAoKCQkJZGlyZWN0SGFzaENoYW5nZTogZnVuY3Rpb24oIG9wdHMgKSB7CgkJCQl2YXIgYmFjayAsIGZvcndhcmQsIG5ld0FjdGl2ZUluZGV4LCBwcmV2ID0gdGhpcy5nZXRBY3RpdmUoKTsKCgkJCQkvLyBjaGVjayBpZiB1cmwgaXMgaW4gaGlzdG9yeSBhbmQgaWYgaXQncyBhaGVhZCBvciBiZWhpbmQgY3VycmVudCBwYWdlCgkJCQkkLmVhY2goIHVybEhpc3Rvcnkuc3RhY2ssIGZ1bmN0aW9uKCBpLCBoaXN0b3J5RW50cnkgKSB7CgoJCQkJCS8vaWYgdGhlIHVybCBpcyBpbiB0aGUgc3RhY2ssIGl0J3MgYSBmb3J3YXJkIG9yIGEgYmFjawoJCQkJCWlmICggZGVjb2RlVVJJQ29tcG9uZW50KCBvcHRzLmN1cnJlbnRVcmwgKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KCBoaXN0b3J5RW50cnkudXJsICkgKSB7CgkJCQkJCS8vZGVmaW5lIGJhY2sgYW5kIGZvcndhcmQgYnkgd2hldGhlciB1cmwgaXMgb2xkZXIgb3IgbmV3ZXIgdGhhbiBjdXJyZW50IHBhZ2UKCQkJCQkJYmFjayA9IGkgPCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4OwoJCQkJCQlmb3J3YXJkID0gIWJhY2s7CgkJCQkJCW5ld0FjdGl2ZUluZGV4ID0gaTsKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBzYXZlIG5ldyBwYWdlIGluZGV4LCBudWxsIGNoZWNrIHRvIHByZXZlbnQgZmFsc2V5IDAgcmVzdWx0CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXggIT09IHVuZGVmaW5lZCA/IG5ld0FjdGl2ZUluZGV4IDogdGhpcy5hY3RpdmVJbmRleDsKCgkJCQlpZiggYmFjayApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNCYWNrICkoIHRydWUgKTsKCQkJCX0gZWxzZSBpZiggZm9yd2FyZCApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNGb3J3YXJkICkoIGZhbHNlICk7CgkJCQl9CgkJCX0sCgoJCQkvL2Rpc2FibGUgaGFzaGNoYW5nZSBldmVudCBsaXN0ZW5lciBpbnRlcm5hbGx5IHRvIGlnbm9yZSBvbmUgY2hhbmdlCgkJCS8vdG9nZ2xlZCBpbnRlcm5hbGx5IHdoZW4gbG9jYXRpb24uaGFzaCBpcyB1cGRhdGVkIHRvIG1hdGNoIHRoZSB1cmwgb2YgYSBzdWNjZXNzZnVsIHBhZ2UgbG9hZAoJCQlpZ25vcmVOZXh0SGFzaENoYW5nZTogZmFsc2UKCQl9LAoKCQkvL2RlZmluZSBmaXJzdCBzZWxlY3RvciB0byByZWNlaXZlIGZvY3VzIHdoZW4gYSBwYWdlIGlzIHNob3duCgkJZm9jdXNhYmxlID0gIlt0YWJpbmRleF0sYSxidXR0b246dmlzaWJsZSxzZWxlY3Q6dmlzaWJsZSxpbnB1dCIsCgoJCS8vcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJCXBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy9pbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2UsCgoJCS8vbm9uc2Vuc2UgaGFzaCBjaGFuZ2Uga2V5IGZvciBkaWFsb2dzLCBzbyB0aGV5IGNyZWF0ZSBhIGhpc3RvcnkgZW50cnkKCQlkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciLAoKCQkvL2V4aXN0aW5nIGJhc2UgdGFnPwoJCSRiYXNlID0gJGhlYWQuY2hpbGRyZW4oICJiYXNlIiApLAoKCQkvL3R1Y2sgYXdheSB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgVVJMIG1pbnVzIGFueSBmcmFnbWVudC4KCQlkb2N1bWVudFVybCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLAoKCQkvL2lmIHRoZSBkb2N1bWVudCBoYXMgYW4gZW1iZWRkZWQgYmFzZSB0YWcsIGRvY3VtZW50QmFzZSBpcyBzZXQgdG8gaXRzCgkJLy9pbml0aWFsIHZhbHVlLiBJZiBhIGJhc2UgdGFnIGRvZXMgbm90IGV4aXN0LCB0aGVuIHdlIGRlZmF1bHQgdG8gdGhlIGRvY3VtZW50VXJsLgoJCWRvY3VtZW50QmFzZSA9ICRiYXNlLmxlbmd0aCA/IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCAkYmFzZS5hdHRyKCAiaHJlZiIgKSwgZG9jdW1lbnRVcmwuaHJlZiApICkgOiBkb2N1bWVudFVybCwKCgkJLy9jYWNoZSB0aGUgY29tcGFyaXNvbiBvbmNlLgoJCWRvY3VtZW50QmFzZURpZmZlcnMgPSAoIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggIT09IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICksCgoJCWdldFNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodDsKCgkJLy9iYXNlIGVsZW1lbnQgbWFuYWdlbWVudCwgZGVmaW5lZCBkZXBlbmRpbmcgb24gZHluYW1pYyBiYXNlIHRhZyBzdXBwb3J0CgkJdmFyIGJhc2UgPSAkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgPyB7CgoJCQkvL2RlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQgaW4gQWpheC1yZXF1ZXN0ZWQgbWFya3VwCgkJCWVsZW1lbnQ6ICggJGJhc2UubGVuZ3RoID8gJGJhc2UgOiAkKCAiPGJhc2U+IiwgeyBocmVmOiBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkaGVhZCApICksCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBkb2N1bWVudEJhc2UgKSApOwoJCQl9LAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICk7CgkJCX0KCgkJfSA6IHVuZGVmaW5lZDsKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYoIHRoaXMucGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZCAmJgoJCQluYXYgJiYKCQkJbmF2LmFwcCAmJgoJCQluYXYuYXBwLmJhY2tIaXN0b3J5ICl7CgkJCW5hdi5hcHAuYmFja0hpc3RvcnkoKTsKCQl9IGVsc2UgewoJCQl3aW5kb3cuaGlzdG9yeS5iYWNrKCk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCgiW2F1dG9mb2N1c10iKSwKCQkJcGFnZVRpdGxlID0gcGFnZS5maW5kKCAiLnVpLXRpdGxlOmVxKDApIiApOwoKCQlpZiggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmKCBwYWdlVGl0bGUubGVuZ3RoICkgewoJCQlwYWdlVGl0bGUuZm9jdXMoKTsKCQl9CgkJZWxzZXsKCQkJcGFnZS5mb2N1cygpOwoJCX0KCX0KCgkvL3JlbW92ZSBhY3RpdmUgY2xhc3NlcyBhZnRlciBwYWdlIHRyYW5zaXRpb24gb3IgZXJyb3IKCWZ1bmN0aW9uIHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggZm9yY2VSZW1vdmFsICkgewoJCWlmKCAhISRhY3RpdmVDbGlja2VkTGluayAmJiAoICEkYWN0aXZlQ2xpY2tlZExpbmsuY2xvc2VzdCggJy51aS1wYWdlLWFjdGl2ZScgKS5sZW5ndGggfHwgZm9yY2VSZW1vdmFsICkgKSB7CgkJCSRhY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9CgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbDsKCX0KCglmdW5jdGlvbiByZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCkgewoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQlpZiggcGFnZVRyYW5zaXRpb25RdWV1ZS5sZW5ndGggPiAwICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlLmFwcGx5KCBudWxsLCBwYWdlVHJhbnNpdGlvblF1ZXVlLnBvcCgpICk7CgkJfQoJfQoKCS8vIFNhdmUgdGhlIGxhc3Qgc2Nyb2xsIGRpc3RhbmNlIHBlciBwYWdlLCBiZWZvcmUgaXQgaXMgaGlkZGVuCgl2YXIgc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlLAoJCXNldExhc3RTY3JvbGwsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsOwoKCXNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQkvLyB0aGlzIGJhcnJpZXIgcHJldmVudHMgc2V0dGluZyB0aGUgc2Nyb2xsIHZhbHVlIGJhc2VkIG9uIHRoZSBicm93c2VyCgkJLy8gc2Nyb2xsaW5nIHRoZSB3aW5kb3cgYmFzZWQgb24gYSBoYXNoY2hhbmdlCgkJaWYoICFzZXRMYXN0U2Nyb2xsRW5hYmxlZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCk7CgoJCWlmKCBhY3RpdmUgKSB7CgkJCXZhciBsYXN0U2Nyb2xsID0gJHdpbmRvdy5zY3JvbGxUb3AoKTsKCgkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4KCQkJLy8gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlIHNjcm9sbGluZyB0byBpcyBsZXNzIHRoYW4gbWluU2Nyb2xsQmFjaywgbGV0IGl0IGdvLgoJCQlhY3RpdmUubGFzdFNjcm9sbCA9IGxhc3RTY3JvbGwgPCAkLm1vYmlsZS5taW5TY3JvbGxCYWNrID8gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgOiBsYXN0U2Nyb2xsOwoJCX0KCX07CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIHRvIGdhdGhlciBzY3JvbGwgcG9zaXRpb24uIFRoZSBkZWxheSBhbGxvd3MgZm9yIHRoZSBoYXNoY2hhbmdlCgkvLyBldmVudCB0byBmaXJlIGFuZCBkaXNhYmxlIHNjcm9sbCByZWNvcmRpbmcgaW4gdGhlIGNhc2Ugd2hlcmUgdGhlIGJyb3dzZXIgc2Nyb2xscwoJLy8gdG8gdGhlIGhhc2ggdGFyZ2V0cyBsb2NhdGlvbiAoc29tZXRpbWVzIHRoZSB0b3Agb2YgdGhlIHBhZ2UpLiBvbmNlIHBhZ2VjaGFuZ2UgZmlyZXMKCS8vIGdldExhc3RTY3JvbGwgaXMgYWdhaW4gcGVybWl0dGVkIHRvIG9wZXJhdGUKCWRlbGF5ZWRTZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJc2V0VGltZW91dCggc2V0TGFzdFNjcm9sbCwgMTAwICk7Cgl9OwoKCS8vIGRpc2FibGUgYW4gc2Nyb2xsIHNldHRpbmcgd2hlbiBhIGhhc2hjaGFuZ2UgaGFzIGJlZW4gZmlyZWQsIHRoaXMgb25seSB3b3JrcwoJLy8gYmVjYXVzZSB0aGUgcmVjb3JkaW5nIG9mIHRoZSBzY3JvbGwgcG9zaXRpb24gaXMgZGVsYXllZCBmb3IgMTAwbXMgYWZ0ZXIKCS8vIHRoZSBicm93c2VyIG1pZ2h0IGhhdmUgY2hhbmdlZCB0aGUgcG9zaXRpb24gYmVjYXVzZSBvZiB0aGUgaGFzaGNoYW5nZQoJJHdpbmRvdy5iaW5kKCAkLnN1cHBvcnQucHVzaFN0YXRlID8gInBvcHN0YXRlIiA6ICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkgCXNldExhc3RTY3JvbGxFbmFibGVkID0gZmFsc2U7Cgl9KTsKCgkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkkd2luZG93Lm9uZSggJC5zdXBwb3J0LnB1c2hTdGF0ZSA/ICJwb3BzdGF0ZSIgOiAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCX0pOwoKCS8vIHdhaXQgdW50aWwgdGhlIG1vYmlsZSBwYWdlIGNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIHRvIGJpbmQgdG8gcGFnZWNoYW5nZQoJJHdpbmRvdy5vbmUoICJwYWdlY29udGFpbmVyY3JlYXRlIiwgZnVuY3Rpb24oKXsKCQkvLyBvbmNlIHRoZSBwYWdlIGhhcyBjaGFuZ2VkLCByZS1lbmFibGUgdGhlIHNjcm9sbCByZWNvcmRpbmcKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmJpbmQoICJwYWdlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgoJIAkJc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gcmVtb3ZlIGFueSBiaW5kaW5nIHRoYXQgcHJldmlvdXNseSBleGlzdGVkIG9uIHRoZSBnZXQgc2Nyb2xsCgkJCS8vIHdoaWNoIG1heSBvciBtYXkgbm90IGJlIGRpZmZlcmVudCB0aGFuIHRoZSBzY3JvbGwgZWxlbWVudCBkZXRlcm1pbmVkIGZvcgoJCQkvLyB0aGlzIHBhZ2UgcHJldmlvdXNseQoJCQkkd2luZG93LnVuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCQkJLy8gZGV0ZXJtaW5lIGFuZCBiaW5kIHRvIHRoZSBjdXJyZW50IHNjb2xsIGVsZW1lbnQgd2hpY2ggbWF5IGJlIHRoZSB3aW5kb3cKCQkJLy8gb3IgaW4gdGhlIGNhc2Ugb2YgdG91Y2ggb3ZlcmZsb3cgdGhlIGVsZW1lbnQgd2l0aCB0b3VjaCBvdmVyZmxvdwoJCQkkd2luZG93LmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCQl9KTsKCX0pOwoKCS8vIGJpbmQgdG8gc2Nyb2xsc3RvcCBmb3IgdGhlIGZpcnN0IHBhZ2UgYXMgInBhZ2VjaGFuZ2UiIHdvbid0IGJlIGZpcmVkIGluIHRoYXQgY2FzZQoJJHdpbmRvdy5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgoJLy9mdW5jdGlvbiBmb3IgdHJhbnNpdGlvbmluZyBiZXR3ZWVuIHR3byBleGlzdGluZyBwYWdlcwoJZnVuY3Rpb24gdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCB0cmFuc2l0aW9uLCByZXZlcnNlICkgewoKCQlpZiggZnJvbVBhZ2UgKSB7CgkJCS8vdHJpZ2dlciBiZWZvcmUgc2hvdy9oaWRlIGV2ZW50cwoJCQlmcm9tUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZWhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCX0KCgkJdG9QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAiYmVmb3Jlc2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoKCQkvL2NsZWFyIHBhZ2UgbG9hZGVyCgkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgoJCS8vIElmIHRyYW5zaXRpb24gaXMgZGVmaW5lZCwgY2hlY2sgaWYgY3NzIDNEIHRyYW5zZm9ybXMgYXJlIHN1cHBvcnRlZCwgYW5kIGlmIG5vdCwgaWYgYSBmYWxsYmFjayBpcyBzcGVjaWZpZWQKCQlpZiggdHJhbnNpdGlvbiAmJiAhJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXSApewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrc1sgdHJhbnNpdGlvbiBdOwoJCX0KCgkJLy9maW5kIHRoZSB0cmFuc2l0aW9uIGhhbmRsZXIgZm9yIHRoZSBzcGVjaWZpZWQgdHJhbnNpdGlvbi4gSWYgdGhlcmUKCQkvL2lzbid0IG9uZSBpbiBvdXIgdHJhbnNpdGlvbkhhbmRsZXJzIGRpY3Rpb25hcnksIHVzZSB0aGUgZGVmYXVsdCBvbmUuCgkJLy9jYWxsIHRoZSBoYW5kbGVyIGltbWVkaWF0ZWx5IHRvIGtpY2stb2ZmIHRoZSB0cmFuc2l0aW9uLgoJCXZhciB0aCA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVyc1sgdHJhbnNpdGlvbiB8fCAiZGVmYXVsdCIgXSB8fCAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIsCgkJCXByb21pc2UgPSB0aCggdHJhbnNpdGlvbiwgcmV2ZXJzZSwgdG9QYWdlLCBmcm9tUGFnZSApOwoKCQlwcm9taXNlLmRvbmUoZnVuY3Rpb24oKSB7CgoJCQkvL3RyaWdnZXIgc2hvdy9oaWRlIGV2ZW50cwoJCQlpZiggZnJvbVBhZ2UgKSB7CgkJCQlmcm9tUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCQl9CgoJCQkvL3RyaWdnZXIgcGFnZXNob3csIGRlZmluZSBwcmV2UGFnZSBhcyBlaXRoZXIgZnJvbVBhZ2Ugb3IgZW1wdHkgalF1ZXJ5IG9iagoJCQl0b1BhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJzaG93IiwgbnVsbCwgeyBwcmV2UGFnZTogZnJvbVBhZ2UgfHwgJCggIiIgKSB9ICk7CgkJfSk7CgoJCXJldHVybiBwcm9taXNlOwoJfQoKCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCWZ1bmN0aW9uIHJlc2V0QWN0aXZlUGFnZUhlaWdodCgpewoJCXZhciBhUGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQlhUGFnZVBhZFQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLXRvcCIgKSApLAoJCQlhUGFnZVBhZEIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApLAoJCQlhUGFnZUJvcmRlclQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJib3JkZXItdG9wLXdpZHRoIiApICksCgkJCWFQYWdlQm9yZGVyQiA9IHBhcnNlRmxvYXQoIGFQYWdlLmNzcyggImJvcmRlci1ib3R0b20td2lkdGgiICkgKTsKCgkJYVBhZ2UuY3NzKCAibWluLWhlaWdodCIsIGdldFNjcmVlbkhlaWdodCgpIC0gYVBhZ2VQYWRUIC0gYVBhZ2VQYWRCIC0gYVBhZ2VCb3JkZXJUIC0gYVBhZ2VCb3JkZXJCICk7Cgl9CgoJLy9zaGFyZWQgcGFnZSBlbmhhbmNlbWVudHMKCWZ1bmN0aW9uIGVuaGFuY2VQYWdlKCAkcGFnZSwgcm9sZSApIHsKCQkvLyBJZiBhIHJvbGUgd2FzIHNwZWNpZmllZCwgbWFrZSBzdXJlIHRoZSBkYXRhLXJvbGUgYXR0cmlidXRlCgkJLy8gb24gdGhlIHBhZ2UgZWxlbWVudCBpcyBpbiBzeW5jLgoJCWlmKCByb2xlICkgewoJCQkkcGFnZS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHJvbGUgKTsKCQl9CgoJCS8vcnVuIHBhZ2UgcGx1Z2luCgkJJHBhZ2UucGFnZSgpOwoJfQoKLyogZXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzCSAqLwoKCS8vYW5pbWF0aW9uIGNvbXBsZXRlIGNhbGxiYWNrCgkkLmZuLmFuaW1hdGlvbkNvbXBsZXRlID0gZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCWlmKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgKSB7CgkJCXJldHVybiAkKCB0aGlzICkub25lKCAnd2Via2l0QW5pbWF0aW9uRW5kIGFuaW1hdGlvbmVuZCcsIGNhbGxiYWNrICk7CgkJfQoJCWVsc2V7CgkJCS8vIGRlZmVyIGV4ZWN1dGlvbiBmb3IgY29uc2lzdGVuY3kgYmV0d2VlbiB3ZWJraXQvbm9uIHdlYmtpdAoJCQlzZXRUaW1lb3V0KCBjYWxsYmFjaywgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy9leHBvc2UgcGF0aCBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLnBhdGggPSBwYXRoOwoKCS8vZXhwb3NlIGJhc2Ugb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5iYXNlID0gYmFzZTsKCgkvL2hpc3Rvcnkgc3RhY2sKCSQubW9iaWxlLnVybEhpc3RvcnkgPSB1cmxIaXN0b3J5OwoKCSQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgPSBkaWFsb2dIYXNoS2V5OwoKCgoJLy9lbmFibGUgY3Jvc3MtZG9tYWluIHBhZ2Ugc3VwcG9ydAoJJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzID0gZmFsc2U7CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwgPSBmdW5jdGlvbihhc1BhcnNlZE9iamVjdCkgewoJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgZG9jdW1lbnRVcmwgKSA6IGRvY3VtZW50VXJsLmhyZWY7Cgl9OwoKCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oYXNQYXJzZWRPYmplY3QpIHsKCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIGRvY3VtZW50QmFzZSApIDogZG9jdW1lbnRCYXNlLmhyZWY7Cgl9OwoKCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSA9IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gJCh0aGlzKTsKCgkJLy8gd2hlbiBkb20gY2FjaGluZyBpcyBub3QgZW5hYmxlZCBvciB0aGUgcGFnZSBpcyBlbWJlZGRlZCBiaW5kIHRvIHJlbW92ZSB0aGUgcGFnZSBvbiBoaWRlCgkJaWYoICFwYWdlLmRhdGEoInBhZ2UiKS5vcHRpb25zLmRvbUNhY2hlCgkJCQkmJiBwYWdlLmlzKCI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiKSApIHsKCgkJCXBhZ2UuYmluZCggJ3BhZ2VoaWRlLnJlbW92ZScsIGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCWlmKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJCSR0aGlzLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCk7CgkJCQl9CgkJCX0pOwoJCX0KCX07CgoJLy8gTG9hZCBhIHBhZ2UgaW50byB0aGUgRE9NLgoJJC5tb2JpbGUubG9hZFBhZ2UgPSBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJLy8ga25vdyB3aGVuIHRoZSBwYWdlIGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCXZhciBkZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJCS8vIFRoZSBkZWZhdWx0IGxvYWRQYWdlIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5CgkJCS8vIHRoZSBjYWxsZXIuCgkJCXNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgcGFnZSBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCXBhZ2UgPSBudWxsLAoKCQkJLy8gSWYgdGhlIHJlbG9hZFBhZ2Ugb3B0aW9uIGlzIHRydWUsIGFuZCB0aGUgcGFnZSBpcyBhbHJlYWR5CgkJCS8vIGluIHRoZSBET00sIGR1cENhY2hlZFBhZ2Ugd2lsbCBiZSBzZXQgdG8gdGhlIHBhZ2UgZWxlbWVudAoJCQkvLyBzbyB0aGF0IGl0IGNhbiBiZSByZW1vdmVkIGFmdGVyIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUKCQkJLy8gcGFnZSBpcyBsb2FkZWQgb2ZmIHRoZSBuZXR3b3JrLgoJCQlkdXBDYWNoZWRQYWdlID0gbnVsbCwKCgkJCS8vIGRldGVybWluZSB0aGUgY3VycmVudCBiYXNlIHVybAoJCQlmaW5kQmFzZVdpdGhEZWZhdWx0ID0gZnVuY3Rpb24oKXsKCQkJCXZhciBjbG9zZXN0QmFzZSA9ICggJC5tb2JpbGUuYWN0aXZlUGFnZSAmJiBnZXRDbG9zZXN0QmFzZVVybCggJC5tb2JpbGUuYWN0aXZlUGFnZSApICk7CgkJCQlyZXR1cm4gY2xvc2VzdEJhc2UgfHwgZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgkJCX0sCgoJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIHBhc3NlZCBpbnRvIHRoZSBmdW5jdGlvbi4gVGhpcwoJCQkvLyB2ZXJzaW9uIG9mIHRoZSBVUkwgbWF5IGNvbnRhaW4gZGlhbG9nL3N1YnBhZ2UgcGFyYW1zIGluIGl0LgoJCQlhYnNVcmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBmaW5kQmFzZVdpdGhEZWZhdWx0KCkgKTsKCgoJCS8vIElmIHRoZSBjYWxsZXIgcHJvdmlkZWQgZGF0YSwgYW5kIHdlJ3JlIHVzaW5nICJnZXQiIHJlcXVlc3QsCgkJLy8gYXBwZW5kIHRoZSBkYXRhIHRvIHRoZSBVUkwuCgkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJnZXQiICkgewoJCQlhYnNVcmwgPSBwYXRoLmFkZFNlYXJjaFBhcmFtcyggYWJzVXJsLCBzZXR0aW5ncy5kYXRhICk7CgkJCXNldHRpbmdzLmRhdGEgPSB1bmRlZmluZWQ7CgkJfQoKCQkvLyBJZiB0aGUgY2FsbGVyIGlzIHVzaW5nIGEgInBvc3QiIHJlcXVlc3QsIHJlbG9hZFBhZ2UgbXVzdCBiZSB0cnVlCgkJaWYoICBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJwb3N0IiApewoJCQlzZXR0aW5ncy5yZWxvYWRQYWdlID0gdHJ1ZTsKCQl9CgoJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgbWludXMgYW55IGRpYWxvZy9zdWJwYWdlIHBhcmFtcy4KCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgcGFnZSB0byBiZSBsb2FkZWQuCgkJdmFyIGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCBhYnNVcmwgKSwKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIHBhZ2UuIEZvciBlbWJlZGRlZCBwYWdlcywgaXQgaXMganVzdCB0aGUgaWQgb2YgdGhlIHBhZ2UuIEZvciBwYWdlcwoJCQkvLyB3aXRoaW4gdGhlIHNhbWUgZG9tYWluIGFzIHRoZSBkb2N1bWVudCBiYXNlLCBpdCBpcyB0aGUgc2l0ZSByZWxhdGl2ZQoJCQkvLyBwYXRoLiBGb3IgY3Jvc3MtZG9tYWluIHBhZ2VzIChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZSBhYnNvbHV0ZSBVcmwKCQkJLy8gdXNlZCB0byBsb2FkIHRoZSBwYWdlLgoJCQlkYXRhVXJsID0gcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBhYnNVcmwgKTsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBwYWdlQ29udGFpbmVyIHRvIHdvcmsgd2l0aC4KCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkvLyBDaGVjayB0byBzZWUgaWYgdGhlIHBhZ2UgYWxyZWFkeSBleGlzdHMgaW4gdGhlIERPTS4KCQkvLyBOT1RFIGRvIF9ub3RfIHVzZSB0aGUgOmpxbURhdGEgcHN1ZWRvIHNlbGVjdG9yIGJlY2F1c2UgcGFyZW50aGVzaXMKCQkvLyAgICAgIGFyZSBhIHZhbGlkIHVybCBjaGFyIGFuZCBpdCBicmVha3Mgb24gdGhlIGZpcnN0IG9jY3VyZW5jZQoJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCgkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkvLyByZWZlcmVuY2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4gSWYgc28sIGl0IG1heSBoYXZlIGJlZW4gZHluYW1pY2FsbHkKCQkvLyBpbmplY3RlZCBieSBhIGRldmVsb3BlciwgaW4gd2hpY2ggY2FzZSBpdCB3b3VsZCBiZSBsYWNraW5nIGEgZGF0YS11cmwKCQkvLyBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCAmJiBkYXRhVXJsICYmICFwYXRoLmlzUGF0aCggZGF0YVVybCApICkgewoJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIiMiICsgZGF0YVVybCApCgkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIGRhdGFVcmwgKTsKCQl9CgoJCQoJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCS8vIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgYXBwbGljYXRpb24uIElmIGl0IGlzbid0IGEgcmVmZXJlbmNlCgkJLy8gdG8gdGhlIGZpcnN0IHBhZ2UgYW5kIHJlZmVycyB0byBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSwgZXJyb3Igb3V0LgoJCWlmICggcGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlICYmIHBhdGguaXNGaXJzdFBhZ2VVcmwoIGZpbGVVcmwgKSApIHsKCQkJCS8vIENoZWNrIHRvIG1ha2Ugc3VyZSBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkKCQkJCS8vIGluIHRoZSBET00uIFNvbWUgdXNlciBkZXBsb3llZCBhcHBzIGFyZSBwcnVuaW5nIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBmcm9tIHRoZSBET00gZm9yIHZhcmlvdXMgcmVhc29ucywgd2UgY2hlY2sgZm9yIHRoaXMKCQkJCS8vIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGggYW4gaWQKCQkJCS8vIGZhbGxpbmcgdGhyb3VnaCB0byB0aGUgbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UgZXJyb3IKCQkJCS8vIGNhc2UuIElmIHRoZSBmaXJzdC1wYWdlIGlzIG5vdCBpbiB0aGUgRE9NLCB0aGVuIHdlIGxldAoJCQkJLy8gdGhpbmdzIGZhbGwgdGhyb3VnaCB0byB0aGUgYWpheCBsb2FkaW5nIGNvZGUgYmVsb3cgc28KCQkJCS8vIHRoYXQgaXQgZ2V0cyByZWxvYWRlZC4KCQkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlLnBhcmVudCgpLmxlbmd0aCApIHsKCQkJCQlwYWdlID0gJCggJC5tb2JpbGUuZmlyc3RQYWdlICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIGZpbGVVcmwgKSAgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCX0KCQkKCQkvLyBJZiB0aGUgcGFnZSB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJLy8gYW5kIHRoZSBjYWxsZXIgZGlkIG5vdCBpbmRpY2F0ZSB0aGF0IHdlIHNob3VsZCBmb3JjZSBhCgkJLy8gcmVsb2FkIG9mIHRoZSBmaWxlLCB3ZSBhcmUgZG9uZS4gT3RoZXJ3aXNlLCB0cmFjayB0aGUKCQkvLyBleGlzdGluZyBwYWdlIGFzIGEgZHVwbGljYXRlZC4KCQlpZiAoIHBhZ2UubGVuZ3RoICkgewoJCQlpZiAoICFzZXR0aW5ncy5yZWxvYWRQYWdlICkgewoJCQkJZW5oYW5jZVBhZ2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSApOwoJCQkJLy9pZiB3ZSBhcmUgcmVsb2FkaW5nIHRoZSBwYWdlIG1ha2Ugc3VyZSB3ZSB1cGRhdGUgdGhlIGJhc2UgaWYgaXRzIG5vdCBhIHByZWZldGNoIAoJCQkJaWYoIGJhc2UgJiYgIW9wdGlvbnMucHJlZmV0Y2ggKXsKCQkJCQliYXNlLnNldCh1cmwpOwoJCQkJfQoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCQlkdXBDYWNoZWRQYWdlID0gcGFnZTsKCQl9CgkJdmFyIG1wYyA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIsCgkJCXBibEV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlbG9hZCIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHVybDogdXJsLCBhYnNVcmw6IGFic1VybCwgZGF0YVVybDogZGF0YVVybCwgZGVmZXJyZWQ6IGRlZmVycmVkLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBhIHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBibEV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiggcGJsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQl9CgoJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgoJCQkvLyBUaGlzIGNvbmZpZ3VyYWJsZSB0aW1lb3V0IGFsbG93cyBjYWNoZWQgcGFnZXMgYSBicmllZiBkZWxheSB0byBsb2FkIHdpdGhvdXQgc2hvd2luZyBhIG1lc3NhZ2UKCQkJdmFyIGxvYWRNc2dEZWxheSA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCQkJCX0sIHNldHRpbmdzLmxvYWRNc2dEZWxheSApLAoKCQkJCS8vIFNoYXJlZCBsb2dpYyBmb3IgY2xlYXJpbmcgdGltZW91dCBhbmQgcmVtb3ZpbmcgbWVzc2FnZS4KCQkJCWhpZGVNc2cgPSBmdW5jdGlvbigpewoKCQkJCQkvLyBTdG9wIG1lc3NhZ2Ugc2hvdyB0aW1lcgoJCQkJCWNsZWFyVGltZW91dCggbG9hZE1zZ0RlbGF5ICk7CgoJCQkJCS8vIEhpZGUgbG9hZGluZyBtZXNzYWdlCgkJCQkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9OwoJCX0KCQkvLyBSZXNldCBiYXNlIHRvIHRoZSBkZWZhdWx0IGRvY3VtZW50IGJhc2UuCgkJLy8gb25seSByZXNldCBpZiB3ZSBhcmUgbm90IHByZWZldGNoaW5nIAoJCWlmICggYmFzZSAmJiB0eXBlb2Ygb3B0aW9ucy5wcmVmZXRjaCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCWJhc2UucmVzZXQoKTsKCQl9CgoJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8IHBhdGguaXNTYW1lRG9tYWluKCBkb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQl9IGVsc2UgewoJCQkvLyBMb2FkIHRoZSBuZXcgcGFnZS4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCQkvL3VzZSBpdCBhcyB0aGUgbmV3IGZpbGVVcmwsIGJhc2UgcGF0aCwgZXRjCgkJCQkJdmFyIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKSwKCgkJCQkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJCQkJbmV3UGFnZVRpdGxlID0gaHRtbC5tYXRjaCggLzx0aXRsZVtePl0qPihbXjxdKikvICkgJiYgUmVnRXhwLiQxLAoKCQkJCQkJLy8gVE9ETyBoYW5kbGUgZGlhbG9ncyBhZ2FpbgoJCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoJCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsPVtcIiddPyhbXlwiJz5dKilbXCInXT8iICk7CgoKCQkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMgY2FuIGJlIGRpcmVjdGVkIHRvIHRoZQoJCQkJCS8vIGNvcnJlY3QgdXJsLiBsb2FkaW5nIGludG8gYSB0ZW1wcm9yYXJ5IGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCQlpZiggcGFnZUVsZW1SZWdleC50ZXN0KCBodG1sICkKCQkJCQkJCSYmIFJlZ0V4cC4kMQoJCQkJCQkJJiYgZGF0YVVybFJlZ2V4LnRlc3QoIFJlZ0V4cC4kMSApCgkJCQkJCQkmJiBSZWdFeHAuJDEgKSB7CgkJCQkJCXVybCA9IGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCBSZWdFeHAuJDEgKTsKCQkJCQl9CgkJCQkJLy9kb250IHVwZGF0ZSB0aGUgYmFzZSB0YWcgaWYgd2UgYXJlIHByZWZldGNoaW5nCgkJCQkJaWYgKCBiYXNlICYmIHR5cGVvZiBvcHRpb25zLnByZWZldGNoID09PSAidW5kZWZpbmVkIikgewoJCQkJCQliYXNlLnNldCggZmlsZVVybCApOwoJCQkJCX0KCgkJCQkJLy93b3JrYXJvdW5kIHRvIGFsbG93IHNjcmlwdHMgdG8gZXhlY3V0ZSB3aGVuIGluY2x1ZGVkIGluIHBhZ2UgZGl2cwoJCQkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoJCQkJCXBhZ2UgPSBhbGwuZmluZCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkuZmlyc3QoKTsKCgkJCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJCQlpZiggIXBhZ2UubGVuZ3RoICl7CgkJCQkJCXBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz4iICsgaHRtbC5zcGxpdCggLzxcLz9ib2R5W14+XSo+L2dtaSApWzFdICsgIjwvZGl2PiIgKTsKCQkJCQl9CgoJCQkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCQkJaWYgKCB+bmV3UGFnZVRpdGxlLmluZGV4T2YoICImIiApICkgewoJCQkJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJCQl9CgkJCQkJCXBhZ2UuanFtRGF0YSggInRpdGxlIiwgbmV3UGFnZVRpdGxlICk7CgkJCQkJfQoKCQkJCQkvL3Jld3JpdGUgc3JjIGFuZCBocmVmIGF0dHJzIHRvIHVzZSBhIGJhc2UgdXJsCgkJCQkJaWYoICEkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgKSB7CgkJCQkJCXZhciBuZXdQYXRoID0gcGF0aC5nZXQoIGZpbGVVcmwgKTsKCQkJCQkJcGFnZS5maW5kKCAiW3NyY10sIGxpbmtbaHJlZl0sIGFbcmVsPSdleHRlcm5hbCddLCA6anFtRGF0YShhamF4PSdmYWxzZScpLCBhW3RhcmdldF0iICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkJCXZhciB0aGlzQXR0ciA9ICQoIHRoaXMgKS5pcyggJ1tocmVmXScgKSA/ICdocmVmJyA6CgkJCQkJCQkJCSQodGhpcykuaXMoJ1tzcmNdJykgPyAnc3JjJyA6ICdhY3Rpb24nLAoJCQkJCQkJCXRoaXNVcmwgPSAkKCB0aGlzICkuYXR0ciggdGhpc0F0dHIgKTsKCgkJCQkJCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gZml4IHRoaXMgc28gdGhhdCBpdCByZW1vdmVzIHRoZSBkb2N1bWVudAoJCQkJCQkJLy8gICAgICAgICAgICBiYXNlIFVSTCwgYW5kIHRoZW4gcHJlcGVuZHMgd2l0aCB0aGUgbmV3IHBhZ2UgVVJMLgoJCQkJCQkJLy9pZiBmdWxsIHBhdGggZXhpc3RzIGFuZCBpcyBzYW1lLCBjaG9wIGl0IC0gaGVscHMgSUUgb3V0CgkJCQkJCQl0aGlzVXJsID0gdGhpc1VybC5yZXBsYWNlKCBsb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUsICcnICk7CgoJCQkJCQkJaWYoICEvXihcdys6fCN8XC8pLy50ZXN0KCB0aGlzVXJsICkgKSB7CgkJCQkJCQkJJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyLCBuZXdQYXRoICsgdGhpc1VybCApOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCS8vYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJCQkvLyBUT0RPIHRhZ2luZyBhIHBhZ2Ugd2l0aCBleHRlcm5hbCB0byBtYWtlIHN1cmUgdGhhdCBlbWJlZGRlZCBwYWdlcyBhcmVuJ3QgcmVtb3ZlZAoJCQkJCS8vICAgICAgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZSBpbiBtYW55CgkJCQkJLy8gICAgICBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJCQlwYWdlCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBmaWxlVXJsICkgKQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICkKCQkJCQkJLmFwcGVuZFRvKCBzZXR0aW5ncy5wYWdlQ29udGFpbmVyICk7CgoJCQkJCS8vIHdhaXQgZm9yIHBhZ2UgY3JlYXRpb24gdG8gbGV2ZXJhZ2Ugb3B0aW9ucyBkZWZpbmVkIG9uIHdpZGdldAoJCQkJCXBhZ2Uub25lKCAncGFnZWNyZWF0ZScsICQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSApOwoKCQkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJCQkvLyBFbmhhbmNpbmcgdGhlIHBhZ2UgbWF5IHJlc3VsdCBpbiBuZXcgZGlhbG9ncy9zdWIgcGFnZXMgYmVpbmcgaW5zZXJ0ZWQKCQkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLXBhZ2UsIHRoYXQgaXMgdGhlCgkJCQkJLy8gcmVhbCBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluLgoJCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgkJCQkJfQoKCQkJCQkvL2JpbmQgcGFnZUhpZGUgdG8gcmVtb3ZlUGFnZSBhZnRlciBpdCdzIGhpZGRlbiwgaWYgdGhlIHBhZ2Ugb3B0aW9ucyBzcGVjaWZ5IHRvIGRvIHNvCgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQkJaGlkZU1zZygpOwoJCQkJCX0KCgkJCQkJLy8gQWRkIHRoZSBwYWdlIHJlZmVyZW5jZSBhbmQgeGhyIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEucGFnZSA9IHBhZ2U7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2Vsb2FkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlLCBkdXBDYWNoZWRQYWdlICk7CgkJCQl9LAoJCQkJZXJyb3I6IGZ1bmN0aW9uKCB4aHIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duICkgewoJCQkJCS8vc2V0IGJhc2UgYmFjayB0byBjdXJyZW50IHBhdGgKCQkJCQlpZiggYmFzZSApIHsKCQkJCQkJYmFzZS5zZXQoIHBhdGguZ2V0KCkgKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCBlcnJvciBpbmZvIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEuZXJyb3JUaHJvd24gPSBlcnJvclRocm93bjsKCgkJCQkJdmFyIHBsZkV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlbG9hZGZhaWxlZCIgKTsKCgkJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBwYWdlIGxvYWQgZmFpbGVkLgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggcGxmRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCQkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCQkvLyB0aGF0IGNhbGxlZCBwcmV2ZW50RGVmYXVsdCgpLCB0byByZXNvbHZlL3JlamVjdCB0aGUKCQkJCQkvLyBkZWZlcnJlZCBvYmplY3Qgd2l0aGluIHRoZSB0cmlnZ2VyRGF0YS4KCQkJCQlpZiggcGxmRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQkJaGlkZU1zZygpOwoKCQkJCQkJLy8gc2hvdyBlcnJvciBtZXNzYWdlCgkJCQkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZyggJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZSwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2UsIHRydWUgKTsKCgkJCQkJCS8vIGhpZGUgYWZ0ZXIgZGVsYXkKCQkJCQkJc2V0VGltZW91dCggJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnLCAxNTAwICk7CgkJCQkJfQoKCQkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9OwoKCSQubW9iaWxlLmxvYWRQYWdlLmRlZmF1bHRzID0gewoJCXR5cGU6ICJnZXQiLAoJCWRhdGE6IHVuZGVmaW5lZCwKCQlyZWxvYWRQYWdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlzaG93TG9hZE1zZzogZmFsc2UsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCWxvYWRNc2dEZWxheTogNTAgLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0byBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCX07CgoJLy8gU2hvdyBhIHNwZWNpZmljIHBhZ2UgaW4gdGhlIHBhZ2UgY29udGFpbmVyLgoJJC5tb2JpbGUuY2hhbmdlUGFnZSA9IGZ1bmN0aW9uKCB0b1BhZ2UsIG9wdGlvbnMgKSB7CgkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJLy8gV2UnbGwgY2FsbCBjaGFuZ2VQYWdlKCkgb25jZSB3ZSdyZSBkb25lIHdpdGggdGhlIGN1cnJlbnQgdHJhbnNpdGlvbiB0bwoJCS8vIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJaWYoIGlzUGFnZVRyYW5zaXRpb25pbmcgKSB7CgkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggYXJndW1lbnRzICk7CgkJCXJldHVybjsKCQl9CgoJCXZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJc2V0dGluZ3MuZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSB8fCAkLm1vYmlsZS5hY3RpdmVQYWdlOwoKCQl2YXIgbXBjID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciwKCQkJcGJjRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVjaGFuZ2UiICksCgkJCXRyaWdnZXJEYXRhID0geyB0b1BhZ2U6IHRvUGFnZSwgb3B0aW9uczogc2V0dGluZ3MgfTsKCgkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGNoYW5nZSB0aGUgY3VycmVudCBwYWdlLgoJCW1wYy50cmlnZ2VyKCBwYmNFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJaWYoIHBiY0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIGFsbG93ICJwYWdlYmVmb3JlY2hhbmdlIiBvYnNlcnZlcnMgdG8gbW9kaWZ5IHRoZSB0b1BhZ2UgaW4gdGhlIHRyaWdnZXIKCQkvLyBkYXRhIHRvIGFsbG93IGZvciByZWRpcmVjdHMuIE1ha2Ugc3VyZSBvdXIgdG9QYWdlIGlzIHVwZGF0ZWQuCgoJCXRvUGFnZSA9IHRyaWdnZXJEYXRhLnRvUGFnZTsKCgkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkvLyBvciB0cmFuc2l0aW9uaW5nLgoKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCgkJLy8gSWYgdGhlIGNhbGxlciBwYXNzZWQgdXMgYSB1cmwsIGNhbGwgbG9hZFBhZ2UoKQoJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkvLyB0byB0aGUgcHJvbWlzZSBvYmplY3QgaXQgcmV0dXJucyBzbyB3ZSBrbm93IHdoZW4KCQkvLyBpdCBpcyBkb25lIGxvYWRpbmcgb3IgaWYgYW4gZXJyb3Igb2N1cnJlZC4KCQlpZiAoIHR5cGVvZiB0b1BhZ2UgPT0gInN0cmluZyIgKSB7CgkJCSQubW9iaWxlLmxvYWRQYWdlKCB0b1BhZ2UsIHNldHRpbmdzICkKCQkJCS5kb25lKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMsIG5ld1BhZ2UsIGR1cENhY2hlZFBhZ2UgKSB7CgkJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQkJCW9wdGlvbnMuZHVwbGljYXRlQ2FjaGVkUGFnZSA9IGR1cENhY2hlZFBhZ2U7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggbmV3UGFnZSwgb3B0aW9ucyApOwoJCQkJfSkKCQkJCS5mYWlsKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgoJCQkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgoJCQkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2VjaGFuZ2VmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoJCQkJfSk7CgkJCXJldHVybjsKCQl9CgoJCS8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZmlyc3QtcGFnZSBvZiB0aGUgYXBwbGljYXRpb24sIHdlIG5lZWQgdG8gbWFrZQoJCS8vIHN1cmUgc2V0dGluZ3MuZGF0YVVybCBpcyBzZXQgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVybC4gVGhpcyBhbGxvd3MKCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkvLyBmaXJzdC1wYWdlIG9mIHRoZSBkb2N1bWVudCBoYXMgYW4gaWQgYXR0cmlidXRlIHNwZWNpZmllZC4KCQlpZiAoIHRvUGFnZVsgMCBdID09PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSAmJiAhc2V0dGluZ3MuZGF0YVVybCApIHsKCQkJc2V0dGluZ3MuZGF0YVVybCA9IGRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJfQoKCQkvLyBUaGUgY2FsbGVyIHBhc3NlZCB1cyBhIHJlYWwgcGFnZSBET00gZWxlbWVudC4gVXBkYXRlIG91cgoJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCXZhciBmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlLAoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBzZXR0aW5ncy5kYXRhVXJsICkgKSB8fCB0b1BhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQgYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmwsCgkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCB1cmwgKSwKCQkJYWN0aXZlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9IHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAsCgkJCWhpc3RvcnlEaXIgPSAwLAoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZSwKCQkJaXNEaWFsb2cgPSBzZXR0aW5ncy5yb2xlID09PSAiZGlhbG9nIiB8fCB0b1BhZ2UuanFtRGF0YSggInJvbGUiICkgPT09ICJkaWFsb2ciOwoKCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50IG1hbnVhbGx5L2R5bmFtaWNhbGx5CgkJLy8gYW5kIHJldXNlIHBhZ2VzIHdhbnQgdG8gYmUgYWJsZSB0byB0cmFuc2l0aW9uIHRvIHRoZSBzYW1lIHBhZ2UuIFRvIGFsbG93CgkJLy8gdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0IHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uCgkJLy8gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbiBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLgoJCS8vIEl0IHNob3VsZCBiZSBub3RlZCB0aGF0IG91ciBkZWZhdWx0IHRyYW5zaXRpb24gYW5pbWF0aW9ucyBhc3N1bWUgdGhhdCB0aGUKCQkvLyBmb3JtUGFnZSBhbmQgdG9QYWdlIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuCgkJLy8gSXQgaXMgdXAgdG8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uCgkJLy8gdG8gZWl0aGVyIHR1cm4gb2ZmIHRyYW5zaXRpb24gYW5pbWF0aW9ucywgb3IgbWFrZSBzdXJlIHRoYXQgYW4gYXBwcm9wcmlhdGUKCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCWlmKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmICFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUgdXJsSGlzdG9yeSBpbiBzeW5jIHdpdGggdGhlIGhhc2ggY2hhbmdlcwoJCQlpZiggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJCWN1cnJlbnRVcmw6CXVybCwKCQkJCQlpc0JhY2s6CQlmdW5jdGlvbigpIHt9LAoJCQkJCWlzRm9yd2FyZDoJZnVuY3Rpb24oKSB7fQoJCQkJfSk7CgkJCX0KCgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYWdlIHdlIGFyZSBnaXZlbiBoYXMgYWxyZWFkeSBiZWVuIGVuaGFuY2VkLgoJCWVuaGFuY2VQYWdlKCB0b1BhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJLy8gSWYgdGhlIGNoYW5nZVBhZ2UgcmVxdWVzdCB3YXMgc2VudCBmcm9tIGEgaGFzaENoYW5nZSBldmVudCwgY2hlY2sgdG8gc2VlIGlmIHRoZQoJCS8vIHBhZ2UgaXMgYWxyZWFkeSB3aXRoaW4gdGhlIHVybEhpc3Rvcnkgc3RhY2suIElmIHNvLCB3ZSdsbCBhc3N1bWUgdGhlIHVzZXIgaGl0CgkJLy8gdGhlIGZvcndhcmQvYmFjayBidXR0b24gYW5kIHdpbGwgdHJ5IHRvIG1hdGNoIHRoZSB0cmFuc2l0aW9uIGFjY29yZGluZ2x5LgoJCWlmKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCWN1cnJlbnRVcmw6CXVybCwKCQkJCWlzQmFjazoJCWZ1bmN0aW9uKCkgeyBoaXN0b3J5RGlyID0gLTE7IH0sCgkJCQlpc0ZvcndhcmQ6CWZ1bmN0aW9uKCkgeyBoaXN0b3J5RGlyID0gMTsgfQoJCQl9KTsKCQl9CgoJCS8vIEtpbGwgdGhlIGtleWJvYXJkLgoJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4gSW5zdGVhZCwKCQkvLyAgICAgICAgICAgIHdlIHNob3VsZCBiZSB0cmFja2luZyBmb2N1cyB3aXRoIGEgZGVsZWdhdGUoKSBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZQoJCS8vICAgICAgICAgICAgdGhlIGVsZW1lbnQgaW4gaGFuZCBhdCB0aGlzIHBvaW50LgoJCS8vIFdyYXAgdGhpcyBpbiBhIHRyeS9jYXRjaCBibG9jayBzaW5jZSBJRTkgdGhyb3cgIlVuc3BlY2lmaWVkIGVycm9yIiBpZiBkb2N1bWVudC5hY3RpdmVFbGVtZW50CgkJLy8gaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQl0cnkgewoJCQlpZihkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPSAnYm9keScpIHsKCQkJCSQoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkuYmx1cigpOwoJCQl9IGVsc2UgewoJCQkJJCggImlucHV0OmZvY3VzLCB0ZXh0YXJlYTpmb2N1cywgc2VsZWN0OmZvY3VzIiApLmJsdXIoKTsKCQkJfQoJCX0gY2F0Y2goZSkge30KCgkJLy8gUmVjb3JkIHdoZXRoZXIgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB3aGVyZSBhIGRpYWxvZyB1c2VkIHRvIGJlIC0gaWYgc28sIGRvIG5vdCBhZGQgYSBuZXcgaGlzdG9yeSBlbnRyeSBhbmQgZG8gbm90IGNoYW5nZSB0aGUgaGFzaCBlaXRoZXIKCQl2YXIgYWxyZWFkeVRoZXJlID0gZmFsc2U7CgoJCS8vIElmIHdlJ3JlIGRpc3BsYXlpbmcgdGhlIHBhZ2UgYXMgYSBkaWFsb2csIHdlIGRvbid0IHdhbnQgdGhlIHVybAoJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCS8vIHRvIGFwcGVuZCB0aGUgZGlhbG9nSGFzaEtleSB0byB0aGUgdXJsIG9mIHRoZSBjdXJyZW50IHBhZ2UuCgkJaWYgKCBpc0RpYWxvZyAmJiBhY3RpdmUgKSB7CgkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlIHNob3VsZAoJCQkvLyBiZSBhbiBlbXB0eSBzdHJpbmcuIE1vdmluZyB0aGUgdW5kZWZpbmVkIC0+IGVtcHR5IHN0cmluZyBiYWNrIGludG8KCQkJLy8gdXJsSGlzdG9yeS5hZGROZXcgc2VlbWVkIGltcHJ1ZGVudCBnaXZlbiB1bmRlZmluZWQgYmV0dGVyIHJlcHJlc2VudHMKCQkJLy8gdGhlIHVybCBzdGF0ZQoKCQkJLy8gSWYgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB0aGF0IG9uY2UgYmVsb25nZWQgdG8gYSBkaWFsb2csIHJldXNlCgkJCS8vIHRoaXMgc3RhdGUgd2l0aG91dCBhZGRpbmcgdG8gdXJsSGlzdG9yeSBhbmQgd2l0aG91dCBtb2RpZnlpbmcgdGhlIGhhc2guCgkJCS8vIEhvd2V2ZXIsIGlmIGEgZGlhbG9nIGlzIGFscmVhZHkgZGlzcGxheWVkIGF0IHRoaXMgcG9pbnQsIGFuZCB3ZSdyZQoJCQkvLyBhYm91dCB0byBkaXNwbGF5IGFub3RoZXIgZGlhbG9nLCB0aGVuIHdlIG11c3QgYWRkIGFub3RoZXIgaGFzaCBhbmQKCQkJLy8gaGlzdG9yeSBlbnRyeSBvbiB0b3Agc28gdGhhdCBvbmUgbWF5IG5hdmlnYXRlIGJhY2sgdG8gdGhlIG9yaWdpbmFsIGRpYWxvZwoJCQlpZiAoIGFjdGl2ZS51cmwgJiYgYWN0aXZlLnVybC5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSAmJiAhJC5tb2JpbGUuYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICkgKSB7CgkJCQlzZXR0aW5ncy5jaGFuZ2VIYXNoID0gZmFsc2U7CgkJCQlhbHJlYWR5VGhlcmUgPSB0cnVlOwoJCQl9CgoJCQl1cmwgPSAoIGFjdGl2ZS51cmwgfHwgIiIgKSArIGRpYWxvZ0hhc2hLZXk7CgoJCQkvLyB0YWNrIG9uIGFub3RoZXIgZGlhbG9nSGFzaEtleSBpZiB0aGlzIGlzIHRoZSBzYW1lIGFzIHRoZSBpbml0aWFsIGhhc2gKCQkJLy8gdGhpcyBtYWtlcyBzdXJlIHRoYXQgYSBoaXN0b3J5IGVudHJ5IGlzIGNyZWF0ZWQgZm9yIHRoaXMgZGlhbG9nCgkJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJCXVybCArPSBkaWFsb2dIYXNoS2V5OwoJCQl9CgkJfQoKCQkvLyBTZXQgdGhlIGxvY2F0aW9uIGhhc2guCgkJaWYoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmIHVybCApIHsKCQkJLy9kaXNhYmxlIGhhc2ggbGlzdGVuaW5nIHRlbXBvcmFyaWx5CgkJCXVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSB0cnVlOwoJCQkvL3VwZGF0ZSBoYXNoIGFuZCBoaXN0b3J5CgkJCXBhdGguc2V0KCB1cmwgKTsKCQl9CgoJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QgdXNlIHBhZ2VUaXRsZQoJCXZhciBuZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKT8gcGFnZVRpdGxlIDogdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSB8fCB0b1BhZ2UuY2hpbGRyZW4oIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIikuZmluZCgiLnVpLXRpdGxlIiApLmdldEVuY29kZWRUZXh0KCk7CgkJaWYoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PSBkb2N1bWVudC50aXRsZSApIHsKCQkJcGFnZVRpdGxlID0gbmV3UGFnZVRpdGxlOwoJCX0KCQlpZiAoICF0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApICkgewoJCQl0b1BhZ2UuanFtRGF0YSggInRpdGxlIiwgcGFnZVRpdGxlICk7CgkJfQoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHRyYW5zaXRpb24gZGVmaW5lZC4KCQlzZXR0aW5ncy50cmFuc2l0aW9uID0gc2V0dGluZ3MudHJhbnNpdGlvbgoJCQl8fCAoICggaGlzdG9yeURpciAmJiAhYWN0aXZlSXNJbml0aWFsUGFnZSApID8gYWN0aXZlLnRyYW5zaXRpb24gOiB1bmRlZmluZWQgKQoJCQl8fCAoIGlzRGlhbG9nID8gJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gOiAkLm1vYmlsZS5kZWZhdWx0UGFnZVRyYW5zaXRpb24gKTsKCgkJLy9hZGQgcGFnZSB0byBoaXN0b3J5IHN0YWNrIGlmIGl0J3Mgbm90IGJhY2sgb3IgZm9yd2FyZAoJCWlmKCAhaGlzdG9yeURpciAmJiAhYWxyZWFkeVRoZXJlICkgewoJCQl1cmxIaXN0b3J5LmFkZE5ldyggdXJsLCBzZXR0aW5ncy50cmFuc2l0aW9uLCBwYWdlVGl0bGUsIHBhZ2VVcmwsIHNldHRpbmdzLnJvbGUgKTsKCQl9CgoJCS8vc2V0IHBhZ2UgdGl0bGUKCQlkb2N1bWVudC50aXRsZSA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCkudGl0bGU7CgoJCS8vc2V0ICJ0b1BhZ2UiIGFzIGFjdGl2ZVBhZ2UKCQkkLm1vYmlsZS5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQlzZXR0aW5ncy5yZXZlcnNlID0gc2V0dGluZ3MucmV2ZXJzZSB8fCBoaXN0b3J5RGlyIDwgMDsKCgkJdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCBzZXR0aW5ncy50cmFuc2l0aW9uLCBzZXR0aW5ncy5yZXZlcnNlICkKCQkJLmRvbmUoZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIGFscmVhZHlGb2N1c2VkICkgewoJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCk7CgoJCQkJLy9pZiB0aGVyZSdzIGEgZHVwbGljYXRlQ2FjaGVkUGFnZSwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBub3cgdGhhdCBpdCdzIGhpZGRlbgoJCQkJaWYgKCBzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlICkgewoJCQkJCXNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UucmVtb3ZlKCk7CgkJCQl9CgoJCQkJLy8gU2VuZCBmb2N1cyB0byB0aGUgbmV3bHkgc2hvd24gcGFnZS4gTW92ZWQgZnJvbSBwcm9taXNlIC5kb25lIGJpbmRpbmcgaW4gdHJhbnNpdGlvblBhZ2VzCgkJCQkvLyBpdHNlbGYgdG8gYXZvaWQgaWUgYnVnIHRoYXQgcmVwb3J0cyBvZmZzZXRXaWR0aCBhcyA+IDAgKGNvcmUgY2hlY2sgZm9yIHZpc2liaWxpdHkpCgkJCQkvLyBkZXNwaXRlIHZpc2liaWxpdHk6IGhpZGRlbiBhZGRyZXNzZXMgaXNzdWUgIzI5NjUKCQkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMjk2NQoJCQkJaWYoICFhbHJlYWR5Rm9jdXNlZCApewoJCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggdG9QYWdlICk7CgkJCQl9CgoJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhbGwgZG9uZSBjaGFuZ2luZyB0aGUgY3VycmVudCBwYWdlLgoJCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCi8qIEV2ZW50IEJpbmRpbmdzIC0gaGFzaGNoYW5nZSwgc3VibWl0LCBhbmQgY2xpY2sgKi8KCWZ1bmN0aW9uIGZpbmRDbG9zZXN0TGluayggZWxlICkKCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImEiICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJfQoJCXJldHVybiBlbGU7Cgl9CgoJLy8gVGhlIGJhc2UgVVJMIGZvciBhbnkgZ2l2ZW4gZWxlbWVudCBkZXBlbmRzIG9uIHRoZSBwYWdlIGl0IHJlc2lkZXMgaW4uCglmdW5jdGlvbiBnZXRDbG9zZXN0QmFzZVVybCggZWxlICkKCXsKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhZ2UgYW5kIGV4dHJhY3Qgb3V0IGl0cyB1cmwuCgkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQliYXNlID0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCWlmICggIXVybCB8fCAhcGF0aC5pc1BhdGgoIHVybCApICkgewoJCQl1cmwgPSBiYXNlOwoJCX0KCgkJcmV0dXJuIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UpOwoJfQoKCS8vVGhlIGZvbGxvd2luZyBldmVudCBiaW5kaW5ncyBzaG91bGQgYmUgYm91bmQgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgYmVlbiB0cmlnZ2VyZWQKCS8vdGhlIGZvbGxvd2luZyBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoJJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMgPSBmdW5jdGlvbigpIHsKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggImZvcm0iLCAic3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiggISQubW9iaWxlLmFqYXhFbmFibGVkIHx8CgkJCQkJLy8gdGVzdCB0aGF0IHRoZSBmb3JtIGlzLCBpdHNlbGYsIGFqYXggZmFsc2UKCQkJCQkkdGhpcy5pcygiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIpIHx8CgkJCQkJLy8gdGVzdCB0aGF0ICQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCBhbmQKCQkJCQkvLyB0aGUgZm9ybSBvciBvbmUgb2YgaXQncyBwYXJlbnRzIGlzIGFqYXg9ZmFsc2UKCQkJCQkhJHRoaXMuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIHR5cGUgPSAkdGhpcy5hdHRyKCAibWV0aG9kIiApLAoJCQkJdGFyZ2V0ID0gJHRoaXMuYXR0ciggInRhcmdldCIgKSwKCQkJCXVybCA9ICR0aGlzLmF0dHIoICJhY3Rpb24iICk7CgoJCQkvLyBJZiBubyBhY3Rpb24gaXMgc3BlY2lmaWVkLCBicm93c2VycyBkZWZhdWx0IHRvIHVzaW5nIHRoZQoJCQkvLyBVUkwgb2YgdGhlIGRvY3VtZW50IGNvbnRhaW5pbmcgdGhlIGZvcm0uIFNpbmNlIHdlIGR5bmFtaWNhbGx5CgkJCS8vIHB1bGwgaW4gcGFnZXMgZnJvbSBleHRlcm5hbCBkb2N1bWVudHMsIHRoZSBmb3JtIHNob3VsZCBzdWJtaXQKCQkJLy8gdG8gdGhlIFVSTCBmb3IgdGhlIHNvdXJjZSBkb2N1bWVudCBvZiB0aGUgcGFnZSBjb250YWluaW5nCgkJCS8vIHRoZSBmb3JtLgoJCQlpZiAoICF1cmwgKSB7CgkJCQkvLyBHZXQgdGhlIEBkYXRhLXVybCBmb3IgdGhlIHBhZ2UgY29udGFpbmluZyB0aGUgZm9ybS4KCQkJCXVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkdGhpcyApOwoJCQkJaWYgKCB1cmwgPT09IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgewoJCQkJCS8vIFRoZSB1cmwgd2UgZ290IGJhY2sgbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYmFzZSwKCQkJCQkvLyB3aGljaCBtZWFucyB0aGUgcGFnZSBtdXN0IGJlIGFuIGludGVybmFsL2VtYmVkZGVkIHBhZ2UsCgkJCQkJLy8gc28gZGVmYXVsdCB0byB1c2luZyB0aGUgYWN0dWFsIGRvY3VtZW50IHVybCBhcyBhIGJyb3dzZXIKCQkJCQkvLyB3b3VsZC4KCQkJCQl1cmwgPSBkb2N1bWVudFVybC5ocmVmTm9TZWFyY2g7CgkJCQl9CgkJCX0KCgkJCXVybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCAgdXJsLCBnZXRDbG9zZXN0QmFzZVVybCgkdGhpcykgKTsKCgkJCWlmKCggcGF0aC5pc0V4dGVybmFsKCB1cmwgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdChkb2N1bWVudFVybCwgdXJsKSkgfHwgdGFyZ2V0ICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKAoJCQkJdXJsLAoJCQkJewoJCQkJCXR5cGU6CQl0eXBlICYmIHR5cGUubGVuZ3RoICYmIHR5cGUudG9Mb3dlckNhc2UoKSB8fCAiZ2V0IiwKCQkJCQlkYXRhOgkJJHRoaXMuc2VyaWFsaXplKCksCgkJCQkJdHJhbnNpdGlvbjoJJHRoaXMuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQkJZGlyZWN0aW9uOgkkdGhpcy5qcW1EYXRhKCAiZGlyZWN0aW9uIiApLAoJCQkJCXJlbG9hZFBhZ2U6CXRydWUKCQkJCX0KCQkJKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQoIGRvY3VtZW50ICkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApOwoKCQkJLy8gc3BsaXQgZnJvbSB0aGUgcHJldmlvdXMgcmV0dXJuIGxvZ2ljIHRvIGF2b2lkIGZpbmQgY2xvc2VzdCB3aGVyZSBwb3NzaWJsZQoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggISQobGluaykuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBsaW5rICkgewoJCQkJaWYgKCBwYXRoLnBhcnNlVXJsKCBsaW5rLmdldEF0dHJpYnV0ZSggImhyZWYiICkgfHwgIiMiICkuaGFzaCAhPT0gIiMiICkgewoJCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoJCQkJCSRhY3RpdmVDbGlja2VkTGluayA9ICQoIGxpbmsgKS5jbG9zZXN0KCAiLnVpLWJ0biIgKS5ub3QoICIudWktZGlzYWJsZWQiICk7CgkJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfQoJCQl9CgkJfSk7CgoJCS8vIGNsaWNrIHJvdXRpbmcgLSBkaXJlY3QgdG8gSFRUUCBvciBBamF4LCBhY2NvcmRpbmdseQoJCSQoIGRvY3VtZW50ICkuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiggISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbGluayA9IGZpbmRDbG9zZXN0TGluayggZXZlbnQudGFyZ2V0ICksICRsaW5rID0gJCggbGluayApLCBodHRwQ2xlYW51cDsKCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpewoJCQkJd2luZG93LnNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgeyByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsgfSwgMjAwICk7CgkJCX07CgoJCQkvL2lmIHRoZXJlJ3MgYSBkYXRhLXJlbD1iYWNrIGF0dHIsIGdvIGJhY2sgaW4gaGlzdG9yeQoJCQlpZiAoICRsaW5rLmlzKCAiOmpxbURhdGEocmVsPSdiYWNrJykiICkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBiYXNlVXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICRsaW5rICksCgoJCQkJLy9nZXQgaHJlZiwgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gZW1wdHkgaGFzaAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAkbGluay5hdHRyKCAiaHJlZiIgKSB8fCAiIyIsIGJhc2VVcmwgKTsKCgkJCS8vaWYgYWpheCBpcyBkaXNhYmxlZCwgZXhpdCBlYXJseQoJCQlpZiggISQubW9iaWxlLmFqYXhFbmFibGVkICYmICFwYXRoLmlzRW1iZWRkZWRQYWdlKCBocmVmICkgKXsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFhYWF9qYmxhczogSWRlYWxseSBsaW5rcyB0byBhcHBsaWNhdGlvbiBwYWdlcyBzaG91bGQgYmUgc3BlY2lmaWVkIGFzCgkJCS8vICAgICAgICAgICAgYW4gdXJsIHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB3aXRoIGEgaGFzaCB0aGF0IGlzIGVpdGhlcgoJCQkvLyAgICAgICAgICAgIHRoZSBzaXRlIHJlbGF0aXZlIHBhdGggb3IgaWQgdG8gdGhlIHBhZ2UuIEJ1dCBzb21lIG9mIHRoZQoJCQkvLyAgICAgICAgICAgIGludGVybmFsIGNvZGUgdGhhdCBkeW5hbWljYWxseSBnZW5lcmF0ZXMgc3ViLXBhZ2VzIGZvciBuZXN0ZWQKCQkJLy8gICAgICAgICAgICBsaXN0cyBhbmQgc2VsZWN0IGRpYWxvZ3MsIGp1c3Qgd3JpdGUgYSBoYXNoIGluIHRoZSBsaW5rIHRoZXkKCQkJLy8gICAgICAgICAgICBjcmVhdGUuIFRoaXMgbWVhbnMgdGhlIGFjdHVhbCBVUkwgcGF0aCBpcyBiYXNlZCBvbiB3aGF0ZXZlcgoJCQkvLyAgICAgICAgICAgIHRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBiYXNlIHRhZyBpcyBhdCB0aGUgdGltZSB0aGlzIGNvZGUKCQkJLy8gICAgICAgICAgICBpcyBjYWxsZWQuIEZvciBub3cgd2UgYXJlIGp1c3QgYXNzdW1pbmcgdGhhdCBhbnkgdXJsIHdpdGggYQoJCQkvLyAgICAgICAgICAgIGhhc2ggaW4gaXQgaXMgYW4gYXBwbGljYXRpb24gcGFnZSByZWZlcmVuY2UuCgkJCWlmICggaHJlZi5zZWFyY2goICIjIiApICE9IC0xICkgewoJCQkJaHJlZiA9IGhyZWYucmVwbGFjZSggL1teI10qIy8sICIiICk7CgkJCQlpZiAoICFocmVmICkgewoJCQkJCS8vbGluayB3YXMgYW4gZW1wdHkgaGFzaCBtZWFudCBwdXJlbHkKCQkJCQkvL2ZvciBpbnRlcmFjdGlvbiwgc28gd2UgaWdub3JlIGl0LgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgoIGhyZWYgKSApIHsKCQkJCQkvL3dlIGhhdmUgYXBhdGggc28gbWFrZSBpdCB0aGUgaHJlZiB3ZSB3YW50IHRvIGxvYWQuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBiYXNlVXJsICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vd2UgaGF2ZSBhIHNpbXBsZSBpZCBzbyB1c2UgdGhlIGRvY3VtZW50VXJsIGFzIGl0cyBiYXNlLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgaHJlZiwgZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCApOwoJCQkJfQoJCQl9CgoJCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXZhciB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgPSAkbGluay5pcyggIltyZWw9J2V4dGVybmFsJ10iICkgfHwgJGxpbmsuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8ICRsaW5rLmlzKCAiW3RhcmdldF0iICksCgoJCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCgkJCQkvL2NoZWNrIGZvciBwcm90b2NvbCBvciByZWwgYW5kIGl0cyBub3QgYW4gZW1iZWRkZWQgcGFnZQoJCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCQkvLyAgICAgbW92ZWQgaW50byBtb3JlIGNvbXByZWhlbnNpdmUgaXNFeHRlcm5hbExpbmsKCQkJCWlzRXh0ZXJuYWwgPSB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgfHwgKCBwYXRoLmlzRXh0ZXJuYWwoIGhyZWYgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdChkb2N1bWVudFVybCwgaHJlZikgKTsKCgkJCWlmKCBpc0V4dGVybmFsICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy91c2UgYWpheAoJCQl2YXIgdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJZGlyZWN0aW9uID0gJGxpbmsuanFtRGF0YSggImRpcmVjdGlvbiIgKSwKCQkJCXJldmVyc2UgPSAoIGRpcmVjdGlvbiAmJiBkaXJlY3Rpb24gPT09ICJyZXZlcnNlIiApIHx8CgkJCQkJCQkvLyBkZXByZWNhdGVkIC0gcmVtb3ZlIGJ5IDEuMAoJCQkJCQkJJGxpbmsuanFtRGF0YSggImJhY2siICksCgoJCQkJLy90aGlzIG1heSBuZWVkIHRvIGJlIG1vcmUgc3BlY2lmaWMgYXMgd2UgdXNlIGRhdGEtcmVsIG1vcmUKCQkJCXJvbGUgPSAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApIHx8IHVuZGVmaW5lZDsKCgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGhyZWYsIHsgdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwgcmV2ZXJzZTogcmV2ZXJzZSwgcm9sZTogcm9sZSB9ICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vcHJlZmV0Y2ggcGFnZXMgd2hlbiBhbmNob3JzIHdpdGggZGF0YS1wcmVmZXRjaCBhcmUgZW5jb3VudGVyZWQKCQkkKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiLnVpLXBhZ2UiLCAicGFnZXNob3cucHJlZmV0Y2giLCBmdW5jdGlvbigpIHsKCQkJdmFyIHVybHMgPSBbXTsKCQkJJCggdGhpcyApLmZpbmQoICJhOmpxbURhdGEocHJlZmV0Y2gpIiApLmVhY2goZnVuY3Rpb24oKXsKCQkJCXZhciAkbGluayA9ICQodGhpcyksCgkJCQkJdXJsID0gJGxpbmsuYXR0ciggImhyZWYiICk7CgoJCQkJaWYgKCB1cmwgJiYgJC5pbkFycmF5KCB1cmwsIHVybHMgKSA9PT0gLTEgKSB7CgkJCQkJdXJscy5wdXNoKCB1cmwgKTsKCgkJCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHVybCwgeyByb2xlOiAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApLHByZWZldGNoOiB0cnVlIH0gKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgoJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlID0gZnVuY3Rpb24oIGhhc2ggKSB7CgkJCS8vZmluZCBmaXJzdCBwYWdlIHZpYSBoYXNoCgkJCXZhciB0byA9IHBhdGguc3RyaXBIYXNoKCBoYXNoICksCgkJCQkvL3RyYW5zaXRpb24gaXMgZmFsc2UgaWYgaXQncyB0aGUgZmlyc3QgcGFnZSwgdW5kZWZpbmVkIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudXJsSGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOiB1bmRlZmluZWQsCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nIHRoZSBjdXJyZW50IHN0YXRlCgkJCQkvLyBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gKCQkJCWNoYW5nZVBhZ2VPcHRpb25zID0gewoJCQkJCXRyYW5zaXRpb246IHRyYW5zaXRpb24sCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX07CgoJCQlpZiAoIDAgPT09IHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoICkgewoJCQkJdXJsSGlzdG9yeS5pbml0aWFsRHN0ID0gdG87CgkJCX0KCgkJCS8vaWYgbGlzdGVuaW5nIGlzIGRpc2FibGVkIChlaXRoZXIgZ2xvYmFsbHkgb3IgdGVtcG9yYXJpbHkpLCBvciBpdCdzIGEgZGlhbG9nIGhhc2gKCQkJaWYoICEkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCB8fCB1cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlICkgewoJCQkJdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSA9IGZhbHNlOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBzcGVjaWFsIGNhc2UgZm9yIGRpYWxvZ3MKCQkJaWYoIHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoID4gMSAmJiB0by5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSAmJiB1cmxIaXN0b3J5LmluaXRpYWxEc3QgIT09IHRvICkgewoKCQkJCS8vIElmIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgbm90IGEgZGlhbG9nIHNraXAgdGhlIGRpYWxvZyBhbmQgY29udGludWUKCQkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQkJaWYoISQubW9iaWxlLmFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApKSB7CgkJCQkJLy9kZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZSBhY2NvcmRpbmdseSBwYXN0CgkJCQkJLy90aGUgY3VycmVudCBkaWFsb2cKCQkJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJCQljdXJyZW50VXJsOiB0bywKCQkJCQkJaXNCYWNrOiBmdW5jdGlvbigpIHsgJC5tb2JpbGUuYmFjaygpOyB9LAoJCQkJCQlpc0ZvcndhcmQ6IGZ1bmN0aW9uKCkgeyB3aW5kb3cuaGlzdG9yeS5mb3J3YXJkKCk7IH0KCQkJCQl9KTsKCgkJCQkJLy8gcHJldmVudCBjaGFuZ2VQYWdlKCkKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgewoJCQkJCS8vIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIGEgZGlhbG9nIGFuZCB3ZSdyZSBuYXZpZ2F0aW5nCgkJCQkJLy8gdG8gYSBkaWFsb2cgdXNlIHRoZSBkaWFsb2cgb2JqZWN0ZWQgc2F2ZWQgaW4gdGhlIHN0YWNrCgkJCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCQkJY3VycmVudFVybDogdG8sCgoJCQkJCQkvLyByZWdhcmRsZXNzIG9mIHRoZSBkaXJlY3Rpb24gb2YgdGhlIGhpc3RvcnkgY2hhbmdlCgkJCQkJCS8vIGRvIHRoZSBmb2xsb3dpbmcKCQkJCQkJZWl0aGVyOiBmdW5jdGlvbiggaXNCYWNrICkgewoJCQkJCQkJdmFyIGFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCk7CgoJCQkJCQkJdG8gPSBhY3RpdmUucGFnZVVybDsKCgkJCQkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSByb2xlLCB0cmFuc2l0aW9uIGFuZCByZXZlcnNhbAoJCQkJCQkJLy8gYXMgbW9zdCBvZiB0aGlzIGlzIGxvc3QgYnkgdGhlIGRvbUNhY2hlIGNsZWFuaW5nCgkJCQkJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIHsKCQkJCQkJCQlyb2xlOiBhY3RpdmUucm9sZSwKCQkJCQkJCQl0cmFuc2l0aW9uOgkgYWN0aXZlLnRyYW5zaXRpb24sCgkJCQkJCQkJcmV2ZXJzZTogaXNCYWNrCgkJCQkJCQl9KTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJfQoJCQl9CgoJCQkvL2lmIHRvIGlzIGRlZmluZWQsIGxvYWQgaXQKCQkJaWYgKCB0byApIHsKCQkJCS8vIEF0IHRoaXMgcG9pbnQsICd0bycgY2FuIGJlIG9uZSBvZiAzIHRoaW5ncywgYSBjYWNoZWQgcGFnZSBlbGVtZW50IGZyb20KCQkJCS8vIGEgaGlzdG9yeSBzdGFjayBlbnRyeSwgYW4gaWQsIG9yIHNpdGUtcmVsYXRpdmUvYWJzb2x1dGUgVVJMLiBJZiAndG8nIGlzCgkJCQkvLyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QgdGhlIGRvY3VtZW50QmFzZSwgbm90IHRoZSBsb2NhdGlvbi5ocmVmLAoJCQkJLy8gc2luY2UgdGhlIGhhc2hjaGFuZ2UgY291bGQndmUgYmVlbiB0aGUgcmVzdWx0IG9mIGEgZm9yd2FyZC9iYWNrd2FyZCBuYXZpZ2F0aW9uCgkJCQkvLyB0aGF0IGNyb3NzZXMgZnJvbSBhbiBleHRlcm5hbCBwYWdlL2RpYWxvZyB0byBhbiBpbnRlcm5hbCBwYWdlL2RpYWxvZy4KCQkJCXRvID0gKCB0eXBlb2YgdG8gPT09ICJzdHJpbmciICYmICFwYXRoLmlzUGF0aCggdG8gKSApID8gKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJyMnICsgdG8sIGRvY3VtZW50QmFzZSApICkgOiB0bzsKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIHRvLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCQl9CWVsc2UgewoJCQkJLy90aGVyZSdzIG5vIGhhc2gsIGdvIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBkb20KCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQoJCX07CgoJCS8vaGFzaGNoYW5nZSBldmVudCBoYW5kbGVyCgkJJHdpbmRvdy5iaW5kKCAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCBlLCB0cmlnZ2VyZWQgKSB7CgkJCS8vIEZpcmVmb3ggYXV0by1lc2NhcGVzIHRoZSBsb2NhdGlvbi5oYXNoIGFzIGZvciB2MTMgYnV0CgkJCS8vIGxlYXZlcyB0aGUgaHJlZiB1bnRvdWNoZWQKCQkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UoIHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2ggKTsKCQl9KTsKCgkJLy9zZXQgcGFnZSBtaW4taGVpZ2h0cyB0byBiZSBkZXZpY2Ugc3BlY2lmaWMKCQkkKCBkb2N1bWVudCApLmJpbmQoICJwYWdlc2hvdyIsIHJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoJCSQoIHdpbmRvdyApLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCByZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9Oy8vbmF2cmVhZHlEZWZlcnJlZCBkb25lIGNhbGxiYWNrCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkLmRvbmUoIGZ1bmN0aW9uKCkgeyAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cygpOyB9ICk7Cgp9KSggalF1ZXJ5ICk7CgooIGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyBGb3Igbm93LCBsZXQncyBNb25rZXlwYXRjaCB0aGlzIG9udG8gdGhlIGVuZCBvZiAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cwoJLy8gU2NvcGUgc2VsZiB0byBwdXNoU3RhdGVIYW5kbGVyIHNvIHdlIGNhbiByZWZlcmVuY2UgaXQgc2FuZWx5IHdpdGhpbiB0aGUKCS8vIG1ldGhvZHMgaGFuZGVkIG9mZiBhcyBldmVudCBoYW5kbGVycwoJdmFyCXB1c2hTdGF0ZUhhbmRsZXIgPSB7fSwKCQlzZWxmID0gcHVzaFN0YXRlSGFuZGxlciwKCQkkd2luID0gJCggd2luZG93ICksCgkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCksCgkJbW9iaWxlaW5pdERlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoJCWRvbXJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJJCggZG9jdW1lbnQgKS5yZWFkeSggJC5wcm94eSggZG9tcmVhZHlEZWZlcnJlZCwgInJlc29sdmUiICkgKTsKCgkkKCBkb2N1bWVudCApLm9uZSggIm1vYmlsZWluaXQiLCAkLnByb3h5KCBtb2JpbGVpbml0RGVmZXJyZWQsICJyZXNvbHZlIiApICk7CgoJJC5leHRlbmQoIHB1c2hTdGF0ZUhhbmRsZXIsIHsKCQkvLyBUT0RPIG1vdmUgdG8gYSBwYXRoIGhlbHBlciwgdGhpcyBpcyByYXRoZXIgY29tbW9uIGZ1bmN0aW9uYWxpdHkKCQlpbml0aWFsRmlsZVBhdGg6IChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHVybC5wYXRobmFtZSArIHVybC5zZWFyY2g7CgkJfSkoKSwKCgkJaGFzaENoYW5nZVRpbWVvdXQ6IDIwMCwKCgkJaGFzaENoYW5nZUVuYWJsZVRpbWVyOiB1bmRlZmluZWQsCgoJCWluaXRpYWxIcmVmOiB1cmwuaHJlZk5vSGFzaCwKCgkJc3RhdGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gewoJCQkJLy8gZmlyZWZveCBhdXRvIGRlY29kZXMgdGhlIHVybCB3aGVuIHVzaW5nIGxvY2F0aW9uLmhhc2ggYnV0IG5vdCBocmVmCgkJCQloYXNoOiAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoIHx8ICIjIiArIHNlbGYuaW5pdGlhbEZpbGVQYXRoLAoJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlLAoKCQkJCS8vIHBlcnNpc3QgYWNyb3NzIHJlZnJlc2gKCQkJCWluaXRpYWxIcmVmOiBzZWxmLmluaXRpYWxIcmVmCgkJCX07CgkJfSwKCgkJcmVzZXRVSUtleXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBkaWFsb2cgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5LAoJCQkJc3Via2V5ID0gIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSwKCQkJCWRpYWxvZ0luZGV4ID0gdXJsLmluZGV4T2YoIGRpYWxvZyApOwoKCQkJaWYoIGRpYWxvZ0luZGV4ID4gLTEgKSB7CgkJCQl1cmwgPSB1cmwuc2xpY2UoIDAsIGRpYWxvZ0luZGV4ICkgKyAiIyIgKyB1cmwuc2xpY2UoIGRpYWxvZ0luZGV4ICk7CgkJCX0gZWxzZSBpZiggdXJsLmluZGV4T2YoIHN1YmtleSApID4gLTEgKSB7CgkJCQl1cmwgPSB1cmwuc3BsaXQoIHN1YmtleSApLmpvaW4oICIjIiArIHN1YmtleSApOwoJCQl9CgoJCQlyZXR1cm4gdXJsOwoJCX0sCgoJCS8vIFRPRE8gc29ydCBvdXQgYSBzaW5nbGUgYmFycmllciB0byBoYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkKCQluZXh0SGFzaENoYW5nZVByZXZlbnRlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQkkLm1vYmlsZS51cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlID0gdmFsdWU7CgkJCXNlbGYub25IYXNoQ2hhbmdlRGlzYWJsZWQgPSB2YWx1ZTsKCQl9LAoKCQkvLyBvbiBoYXNoIGNoYW5nZSB3ZSB3YW50IHRvIGNsZWFuIHVwIHRoZSB1cmwKCQkvLyBOT1RFIHRoaXMgdGFrZXMgcGxhY2UgKmFmdGVyKiB0aGUgdmFuaWxsYSBuYXZpZ2F0aW9uIGhhc2ggY2hhbmdlCgkJLy8gaGFuZGxpbmcgaGFzIHRha2VuIHBsYWNlIGFuZCBzZXQgdGhlIHN0YXRlIG9mIHRoZSBET00KCQlvbkhhc2hDaGFuZ2U6IGZ1bmN0aW9uKCBlICkgewoJCQkvLyBkaXNhYmxlIHRoaXMgaGFzaCBjaGFuZ2UKCQkJaWYoIHNlbGYub25IYXNoQ2hhbmdlRGlzYWJsZWQgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGhyZWYsIHN0YXRlLAoJCQkJLy8gZmlyZWZveCBhdXRvIGRlY29kZXMgdGhlIHVybCB3aGVuIHVzaW5nIGxvY2F0aW9uLmhhc2ggYnV0IG5vdCBocmVmCgkJCQloYXNoID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCwKCQkJCWlzUGF0aCA9ICQubW9iaWxlLnBhdGguaXNQYXRoKCBoYXNoICksCgkJCQlyZXNvbHV0aW9uVXJsID0gaXNQYXRoID8gJC5tb2JpbGUucGF0aC5nZXRMb2NhdGlvbigpIDogJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwoKTsKCgkJCWhhc2ggPSBpc1BhdGggPyBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6IGhhc2g7CgoKCQkJLy8gcHJvcHVsYXRlIHRoZSBoYXNoIHdoZW4gaXRzIG5vdCBhdmFpbGFibGUKCQkJc3RhdGUgPSBzZWxmLnN0YXRlKCk7CgoJCQkvLyBtYWtlIHRoZSBoYXNoIGFib2x1dGUgd2l0aCB0aGUgY3VycmVudCBocmVmCgkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaGFzaCwgcmVzb2x1dGlvblVybCApOwoKCQkJaWYgKCBpc1BhdGggKSB7CgkJCQlocmVmID0gc2VsZi5yZXNldFVJS2V5cyggaHJlZiApOwoJCQl9CgoJCQkvLyByZXBsYWNlIHRoZSBjdXJyZW50IHVybCB3aXRoIHRoZSBuZXcgaHJlZiBhbmQgc3RvcmUgdGhlIHN0YXRlCgkJCS8vIE5vdGUgdGhhdCBpbiBzb21lIGNhc2VzIHdlIG1pZ2h0IGJlIHJlcGxhY2luZyBhbiB1cmwgd2l0aCB0aGUKCQkJLy8gc2FtZSB1cmwuIFdlIGRvIHRoaXMgYW55d2F5cyBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQKCQkJLy8gYWxsIG9mIG91ciBoaXN0b3J5IGVudHJpZXMgaGF2ZSBhIHN0YXRlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGgKCQkJLy8gdGhlbS4gVGhpcyBhbGxvd3MgdXMgdG8gd29yayBhcm91bmQgdGhlIGNhc2Ugd2hlcmUgJC5tb2JpbGUuYmFjaygpCgkJCS8vIGlzIGNhbGxlZCB0byB0cmFuc2l0aW9uIGZyb20gYW4gZXh0ZXJuYWwgcGFnZSB0byBhbiBlbWJlZGRlZCBwYWdlLgoJCQkvLyBJbiB0aGF0IHBhcnRpY3VsYXIgY2FzZSwgYSBoYXNoY2hhbmdlIGV2ZW50IGlzICpOT1QqIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4KCQkJLy8gRW5zdXJpbmcgZWFjaCBoaXN0b3J5IGVudHJ5IGhhcyBhIHN0YXRlIG9iamVjdCBtZWFucyB0aGF0IG9uUG9wU3RhdGUoKQoJCQkvLyB3aWxsIGFsd2F5cyB0cmlnZ2VyIG91ciBoYXNoY2hhbmdlIGNhbGxiYWNrIGV2ZW4gd2hlbiBhIGhhc2hjaGFuZ2UgZXZlbnQKCQkJLy8gaXMgbm90IGZpcmVkLgoJCQloaXN0b3J5LnJlcGxhY2VTdGF0ZSggc3RhdGUsIGRvY3VtZW50LnRpdGxlLCBocmVmICk7CgkJfSwKCgkJLy8gb24gcG9wc3RhdGUgKGllIGJhY2sgb3IgZm9yd2FyZCkgd2UgbmVlZCB0byByZXBsYWNlIHRoZSBoYXNoIHRoYXQgd2FzIHRoZXJlIHByZXZpb3VzbHkKCQkvLyBjbGVhbmVkIHVwIGJ5IHRoZSBhZGRpdGlvbmFsIGhhc2ggaGFuZGxpbmcKCQlvblBvcFN0YXRlOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHBvcHBlZFN0YXRlID0gZS5vcmlnaW5hbEV2ZW50LnN0YXRlLAoJCQkJZnJvbUhhc2gsIHRvSGFzaCwgaGFzaENoYW5nZWQ7CgoJCQkvLyBpZiB0aGVyZSdzIG5vIHN0YXRlIGl0cyBub3QgYSBwb3BzdGF0ZSB3ZSBjYXJlIGFib3V0LCBlZyBjaHJvbWUncyBpbml0aWFsIHBvcHN0YXRlCgkJCWlmKCBwb3BwZWRTdGF0ZSApIHsKCQkJCS8vIGlmIHdlIGdldCB0d28gcG9wIHN0YXRlcyBpbiB1bmRlciB0aGlzLmhhc2hDaGFuZ2VUaW1lb3V0CgkJCQkvLyBtYWtlIHN1cmUgdG8gY2xlYXIgYW55IHRpbWVyIHNldCBmb3IgdGhlIHByZXZpb3VzIGNoYW5nZQoJCQkJY2xlYXJUaW1lb3V0KCBzZWxmLmhhc2hDaGFuZ2VFbmFibGVUaW1lciApOwoKCQkJCS8vIG1ha2Ugc3VyZSB0byBlbmFibGUgaGFzaCBoYW5kbGluZyBmb3IgdGhlIHRoZSBfaGFuZGxlSGFzaENoYW5nZSBjYWxsCgkJCQlzZWxmLm5leHRIYXNoQ2hhbmdlUHJldmVudGVkKCBmYWxzZSApOwoKCQkJCS8vIGNoYW5nZSB0aGUgcGFnZSBiYXNlZCBvbiB0aGUgaGFzaCBpbiB0aGUgcG9wcGVkIHN0YXRlCgkJCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSggcG9wcGVkU3RhdGUuaGFzaCApOwoKCQkJCS8vIHByZXZlbnQgYW55IGhhc2hjaGFuZ2UgaW4gdGhlIG5leHQgc2VsZi5oYXNoQ2hhbmdlVGltZW91dAoJCQkJc2VsZi5uZXh0SGFzaENoYW5nZVByZXZlbnRlZCggdHJ1ZSApOwoKCQkJCS8vIHJlLWVuYWJsZSBoYXNoIGNoYW5nZSBoYW5kbGluZyBhZnRlciBzd2FsbG93aW5nIGEgcG9zc2libGUgaGFzaAoJCQkJLy8gY2hhbmdlIGV2ZW50IHRoYXQgY29tZXMgb24gYWxsIHBvcHN0YXRlcyBjb3VydGVzeSBvZiBicm93c2VycyBsaWtlIEFuZHJvaWQKCQkJCXNlbGYuaGFzaENoYW5nZUVuYWJsZVRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5uZXh0SGFzaENoYW5nZVByZXZlbnRlZCggZmFsc2UgKTsKCQkJCX0sIHNlbGYuaGFzaENoYW5nZVRpbWVvdXQpOwoJCQl9CgkJfSwKCgkJaW5pdDogZnVuY3Rpb24oKSB7CgkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UiLCBzZWxmLm9uSGFzaENoYW5nZSApOwoKCQkJLy8gSGFuZGxlIHBvcHN0YXRlIGV2ZW50cyB0aGUgb2NjdXIgdGhyb3VnaCBoaXN0b3J5IGNoYW5nZXMKCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUiLCBzZWxmLm9uUG9wU3RhdGUgKTsKCgkJCS8vIGlmIHRoZXJlJ3Mgbm8gaGFzaCwgd2UgbmVlZCB0byByZXBsYWNlc3RhdGUgZm9yIHJldHVybmluZyB0byBob21lCgkJCWlmICggbG9jYXRpb24uaGFzaCA9PT0gIiIgKSB7CgkJCQloaXN0b3J5LnJlcGxhY2VTdGF0ZSggc2VsZi5zdGF0ZSgpLCBkb2N1bWVudC50aXRsZSwgJC5tb2JpbGUucGF0aC5nZXRMb2NhdGlvbigpICk7CgkJCX0KCQl9Cgl9KTsKCgkvLyBXZSBuZWVkIHRvIGluaXQgd2hlbiAibW9iaWxlaW5pdCIsICJkb21yZWFkeSIsIGFuZCAibmF2cmVhZHkiIGhhdmUgYWxsIGhhcHBlbmVkCgkkLndoZW4oIGRvbXJlYWR5RGVmZXJyZWQsIG1vYmlsZWluaXREZWZlcnJlZCwgJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCWlmKCAkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkICYmICQuc3VwcG9ydC5wdXNoU3RhdGUgKXsKCQkJcHVzaFN0YXRlSGFuZGxlci5pbml0KCk7CgkJfQoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgcG9wIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5wb3AgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciBzbGlkZSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2xpZGUgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2ltdWx0YW5lb3VzOwoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9uJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZG93biBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVkb3duID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZXVwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZXVwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbGlwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbGlwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciB0dXJuIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy50dXJuID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07CgoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCgl2YXIgcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSgkKGUudGFyZ2V0KSksIG9wdGlvbnM7CgoJaWYoICFwYWdlICkgewoJCXJldHVybjsKCX0KCglvcHRpb25zID0gcGFnZS5vcHRpb25zOwoKCS8vIGRlZ3JhZGUgaW5wdXRzIHRvIGF2b2lkIHBvb3JseSBpbXBsZW1lbnRlZCBuYXRpdmUgZnVuY3Rpb25hbGl0eQoJJCggZS50YXJnZXQgKS5maW5kKCAiaW5wdXQiICkubm90KCBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpICkuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSB8fCAidGV4dCI7CgoJCWlmICggb3B0aW9ucy5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gKSB7CgkJCXZhciBodG1sID0gJCggIjxkaXY+IiApLmh0bWwoICR0aGlzLmNsb25lKCkgKS5odG1sKCksCgkJCQkvLyBJbiBJRSBicm93c2VycywgdGhlIHR5cGUgc29tZXRpbWVzIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNsb25lZCBtYXJrdXAsIHNvIHdlIHJlcGxhY2UgdGhlIGNsb3NpbmcgdGFnIGluc3RlYWQKCQkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMSwKCQkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi8sCgkJCQlyZXBzdHIgPSAiIHR5cGU9XCIiICsgb3B0VHlwZSArICJcIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPVwiIiArIHR5cGUgKyAiXCIiICsgKCBoYXNUeXBlID8gIiIgOiAiPiIgKTsKCgkJCSR0aGlzLnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQljbG9zZUJ0blRleHQgCTogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWUJOiAiYSIsCgkJaW5pdFNlbGVjdG9yCTogIjpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQloZWFkZXJDbG9zZUJ1dHRvbiA9ICQoICI8YSBocmVmPScjJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uPSdkZWxldGUnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3M9J25vdGV4dCc+IisgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCArICI8L2E+IiApLAoJCQlkaWFsb2dXcmFwID0gJCgiPGRpdi8+IiwgewoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktY29ybmVyLWFsbCB1aS1vdmVybGF5LXNoYWRvdyIKCQkJCX0pOwoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaWFsb2cgdWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZwoJCS8vIFNldCBhcmlhIHJvbGUKCQkkZWwKCQkJLndyYXBJbm5lciggZGlhbG9nV3JhcCApCgkJCS5jaGlsZHJlbigpCgkJCQkuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApCgkJCQkJLnByZXBlbmQoIGhlYWRlckNsb3NlQnV0dG9uICkKCQkJCS5lbmQoKQoJCQkJLmNoaWxkcmVuKCAnOmZpcnN0LWNoaWxkJykKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApCgkJCQkuZW5kKCkKCQkJCS5jaGlsZHJlbiggIjpsYXN0LWNoaWxkIiApCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKTsKCgkJLy8gdGhpcyBtdXN0IGJlIGFuIGFub255bW91cyBmdW5jdGlvbiBzbyB0aGF0IHNlbGVjdCBtZW51IGRpYWxvZ3MgY2FuIHJlcGxhY2UKCQkvLyB0aGUgY2xvc2UgbWV0aG9kLiBUaGlzIGlzIGEgY2hhbmdlIGZyb20gcHJldmlvdXNseSBqdXN0IGRlZmluaW5nIGRhdGEtcmVsPWJhY2sKCQkvLyBvbiB0aGUgYnV0dG9uIGFuZCBsZXR0aW5nIG5hdiBoYW5kbGUgaXQKCQkvLwoJCS8vIFVzZSBjbGljayByYXRoZXIgdGhhbiB2Y2xpY2sgaW4gb3JkZXIgdG8gcHJldmVudCB0aGUgcG9zc2liaWxpdHkgb2YgdW5pbnRlbnRpb25hbGx5CgkJLy8gcmVvcGVuaW5nIHRoZSBkaWFsb2cgaWYgdGhlIGRpYWxvZyBvcGVuaW5nIGl0ZW0gd2FzIGRpcmVjdGx5IHVuZGVyIHRoZSBjbG9zZSBidXR0b24uCgkJaGVhZGVyQ2xvc2VCdXR0b24uYmluZCggImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCXNlbGYuY2xvc2UoKTsKCQl9KTsKCgkJLyogYmluZCBldmVudHMKCQkJLSBjbGlja3MgYW5kIHN1Ym1pdHMgc2hvdWxkIHVzZSB0aGUgY2xvc2luZyB0cmFuc2l0aW9uIHRoYXQgdGhlIGRpYWxvZyBvcGVuZWQgd2l0aAoJCQkgIHVubGVzcyBhIGRhdGEtdHJhbnNpdGlvbiBpcyBzcGVjaWZpZWQgb24gdGhlIGxpbmsvZm9ybQoJCQktIGlmIHRoZSBjbGljayB3YXMgb24gdGhlIGNsb3NlIGJ1dHRvbiwgb3IgdGhlIGxpbmsgaGFzIGEgZGF0YS1yZWw9ImJhY2siIGl0J2xsIGdvIGJhY2sgaW4gaGlzdG9yeSBuYXR1cmFsbHkKCQkqLwoJCSRlbC5iaW5kKCAidmNsaWNrIHN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBldmVudC50eXBlID09PSAidmNsaWNrIiA/ICJhIiA6ICJmb3JtIiApLAoJCQkJYWN0aXZlOwoKCQkJaWYgKCAkdGFyZ2V0Lmxlbmd0aCAmJiAhJHRhcmdldC5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSApIHsKCgkJCQlhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpIHx8IHt9OwoKCQkJCSR0YXJnZXQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRyYW5zaXRpb24iLCAoIGFjdGl2ZS50cmFuc2l0aW9uIHx8ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uICkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGlyZWN0aW9uIiwgInJldmVyc2UiICk7CgkJCX0KCQl9KQoJCS5iaW5kKCAicGFnZWhpZGUiLCBmdW5jdGlvbiggZSwgdWkgKSB7CgkJCXNlbGYuX2lzQ2xvc2VkID0gZmFsc2U7CgkJCSQoIHRoaXMgKS5maW5kKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLm5vdCggIi51aS1zbGlkZXItYmciICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSkKCQkvLyBPdmVycmlkZSB0aGUgdGhlbWUgc2V0IGJ5IHRoZSBwYWdlIHBsdWdpbiBvbiBwYWdlc2hvdwoJCS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpewoJCQlpZiggc2VsZi5vcHRpb25zLm92ZXJsYXlUaGVtZSApewoJCQkJc2VsZi5lbGVtZW50CgkJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkJLnBhZ2UoICJzZXRDb250YWluZXJCYWNrZ3JvdW5kIiwgc2VsZi5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBkc3Q7CgoJCWlmICggIXRoaXMuX2lzQ2xvc2VkICkgewoJCQl0aGlzLl9pc0Nsb3NlZCA9IHRydWU7CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQlkc3QgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldFByZXYoKS51cmw7CgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggZHN0ICkgKSB7CgkJCQkJZHN0ID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGRzdCApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGRzdCwgeyBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJfQoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmRlbGVnYXRlKCAkLm1vYmlsZS5kaWFsb2cucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCl7CgkkLm1vYmlsZS5kaWFsb2cucHJvdG90eXBlLmVuaGFuY2UoIHRoaXMgKTsKfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYmFja0J0blRleHQgID0gIkJhY2siOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmFkZEJhY2tCdG4gICA9IGZhbHNlOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UaGVtZSA9IG51bGw7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuaGVhZGVyVGhlbWUgID0gImEiOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmZvb3RlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5jb250ZW50VGhlbWUgPSBudWxsOwoKLy8gTk9URSBiaW5kIHVzZWQgdG8gZm9yY2UgdGhpcyBiaW5kaW5nIHRvIHJ1biBiZWZvcmUgdGhlIGJ1dHRvbk1hcmt1cCBiaW5kaW5nCi8vICAgICAgd2hpY2ggZXhwZWN0cyAudWktZm9vdGVyIHRvcCBiZSBhcHBsaWVkIGluIGl0cyBnaWdhbnRpYyBzZWxlY3RvciAKLy8gVE9ETyByZW1vdmUgdGhlIGJ1dHRvbk1hcmt1cCBnaWFudCBzZWxlY3RvciBhbmQgbW92ZSBpdCB0byB0aGUgdmFyaW91cyBtb2R1bGVzCi8vICAgICAgb24gd2hpY2ggaXQgZGVwZW5kcwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7Cgl2YXIgJHBhZ2UgPSAkKCBlLnRhcmdldCApLAoJCW8gPSAkcGFnZS5kYXRhKCAicGFnZSIgKS5vcHRpb25zLAoJCXBhZ2VSb2xlID0gJHBhZ2UuanFtRGF0YSggInJvbGUiICksCgkJcGFnZVRoZW1lID0gby50aGVtZTsKCgkkKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJyksIDpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdjb250ZW50JykiLCAkcGFnZSApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlyb2xlID0gJHRoaXMuanFtRGF0YSggInJvbGUiICksCgkJCXRoZW1lID0gJHRoaXMuanFtRGF0YSggInRoZW1lIiApLAoJCQljb250ZW50VGhlbWUgPSB0aGVtZSB8fCBvLmNvbnRlbnRUaGVtZSB8fCAoIHBhZ2VSb2xlID09PSAiZGlhbG9nIiAmJiBwYWdlVGhlbWUgKSwKCQkJJGhlYWRlcmFuY2hvcnMsCgkJCWxlZnRidG4sCgkJCXJpZ2h0YnRuLAoJCQliYWNrQnRuOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CgoJCS8vYXBwbHkgdGhlbWluZyBhbmQgbWFya3VwIG1vZGlmaWNhdGlvbnMgdG8gcGFnZSxoZWFkZXIsY29udGVudCxmb290ZXIKCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiIHx8IHJvbGUgPT09ICJmb290ZXIiICkgewoKCQkJdmFyIHRoaXNUaGVtZSA9IHRoZW1lIHx8ICggcm9sZSA9PT0gImhlYWRlciIgPyBvLmhlYWRlclRoZW1lIDogby5mb290ZXJUaGVtZSApIHx8IHBhZ2VUaGVtZTsKCgkJCSR0aGlzCgkJCQkvL2FkZCB0aGVtZSBjbGFzcwoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyB0aGlzVGhlbWUgKQoJCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkJLmF0dHIoICJyb2xlIiwgcm9sZSA9PT0gImhlYWRlciIgPyAiYmFubmVyIiA6ICJjb250ZW50aW5mbyIgKTsKCgkJCWlmKCByb2xlID09PSAiaGVhZGVyIikgewoJCQkJLy8gUmlnaHQsbGVmdCBidXR0b25zCgkJCQkkaGVhZGVyYW5jaG9ycwk9ICR0aGlzLmNoaWxkcmVuKCAiYSwgYnV0dG9uIiApOwoJCQkJbGVmdGJ0bgk9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLWxlZnQiICk7CgkJCQlyaWdodGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLXJpZ2h0IiApOwoKCQkJCWxlZnRidG4gPSBsZWZ0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAwICkubm90KCAiLnVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCgkJCQlyaWdodGJ0biA9IHJpZ2h0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAxICkuYWRkQ2xhc3MoICJ1aS1idG4tcmlnaHQiICkubGVuZ3RoOwoJCQl9CgoJCQkvLyBBdXRvLWFkZCBiYWNrIGJ0biBvbiBwYWdlcyBiZXlvbmQgZmlyc3QgdmlldwoJCQlpZiAoIG8uYWRkQmFja0J0biAmJgoJCQkJcm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCSQoICIudWktcGFnZSIgKS5sZW5ndGggPiAxICYmCgkJCQkkcGFnZS5qcW1EYXRhKCAidXJsIiApICE9PSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggbG9jYXRpb24uaGFzaCApICYmCgkJCQkhbGVmdGJ0biApIHsKCgkJCQliYWNrQnRuID0gJCggIjxhIGhyZWY9J2phdmFzY3JpcHQ6dm9pZCgwKTsnIGNsYXNzPSd1aS1idG4tbGVmdCcgZGF0YS0iKyAkLm1vYmlsZS5ucyArInJlbD0nYmFjaycgZGF0YS0iKyAkLm1vYmlsZS5ucyArImljb249J2Fycm93LWwnPiIrIG8uYmFja0J0blRleHQgKyI8L2E+IiApCgkJCQkJLy8gSWYgdGhlbWUgaXMgcHJvdmlkZWQsIG92ZXJyaWRlIGRlZmF1bHQgaW5oZXJpdGFuY2UKCQkJCQkuYXR0ciggImRhdGEtIisgJC5tb2JpbGUubnMgKyJ0aGVtZSIsIG8uYmFja0J0blRoZW1lIHx8IHRoaXNUaGVtZSApCgkJCQkJLnByZXBlbmRUbyggJHRoaXMgKTsKCQkJfQoKCQkJLy8gUGFnZSB0aXRsZQoJCQkkdGhpcy5jaGlsZHJlbiggImgxLCBoMiwgaDMsIGg0LCBoNSwgaDYiICkKCQkJCS5hZGRDbGFzcyggInVpLXRpdGxlIiApCgkJCQkvLyBSZWdhcmRsZXNzIG9mIGggZWxlbWVudCBudW1iZXIgaW4gc3JjLCBpdCBiZWNvbWVzIGgxIGZvciB0aGUgZW5oYW5jZWQgcGFnZQoJCQkJLmF0dHIoewoJCQkJCSJyb2xlIjogImhlYWRpbmciLAoJCQkJCSJhcmlhLWxldmVsIjogIjEiCgkJCQl9KTsKCgkJfSBlbHNlIGlmICggcm9sZSA9PT0gImNvbnRlbnQiICkgewoJCQlpZiAoIGNvbnRlbnRUaGVtZSApIHsKCQkJICAgICR0aGlzLmFkZENsYXNzKCAidWktYm9keS0iICsgKCBjb250ZW50VGhlbWUgKSApOwoJCQl9CgoJCQkvLyBBZGQgQVJJQSByb2xlCgkJCSR0aGlzLmF0dHIoICJyb2xlIiwgIm1haW4iICk7CgkJfQoJfSk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBmaWx0ZXIgZnVuY3Rpb24gcmVtb3ZlcyB3aGl0ZXNwYWNlIGJldHdlZW4gbGFiZWwgYW5kIGZvcm0gZWxlbWVudCBzbyB3ZSBjYW4gdXNlIGlubGluZS1ibG9jayAobm9kZVR5cGUgMyA9IHRleHQpCiQuZm4uZmllbGRjb250YWluID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcwoJCS5hZGRDbGFzcyggInVpLWZpZWxkLWNvbnRhaW4gdWktYm9keSB1aS1iciIgKQoJCS5jb250ZW50cygpLmZpbHRlciggZnVuY3Rpb24oKSB7CgkJCXJldHVybiAoIHRoaXMubm9kZVR5cGUgPT09IDMgJiYgIS9cUy8udGVzdCggdGhpcy5ub2RlVmFsdWUgKSApOwoJCX0pLnJlbW92ZSgpOwp9OwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIsIGUudGFyZ2V0ICkuanFtRW5oYW5jZWFibGUoKS5maWVsZGNvbnRhaW4oKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uZ3JpZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJZ3JpZDogbnVsbAoJCQl9LG9wdGlvbnMpLAoJCQkka2lkcyA9ICR0aGlzLmNoaWxkcmVuKCksCgkJCWdyaWRDb2xzID0ge3NvbG86MSwgYToyLCBiOjMsIGM6NCwgZDo1fSwKCQkJZ3JpZCA9IG8uZ3JpZCwKCQkJaXRlcmF0b3I7CgoJCQlpZiAoICFncmlkICkgewoJCQkJaWYgKCAka2lkcy5sZW5ndGggPD0gNSApIHsKCQkJCQlmb3IgKCB2YXIgbGV0dGVyIGluIGdyaWRDb2xzICkgewoJCQkJCQlpZiAoIGdyaWRDb2xzWyBsZXR0ZXIgXSA9PT0gJGtpZHMubGVuZ3RoICkgewoJCQkJCQkJZ3JpZCA9IGxldHRlcjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJZ3JpZCA9ICJhIjsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtZHVvIiApOwoJCQkJfQoJCQl9CgkJCWl0ZXJhdG9yID0gZ3JpZENvbHNbZ3JpZF07CgoJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC0iICsgZ3JpZCApOwoKCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzEpIiApLmFkZENsYXNzKCAidWktYmxvY2stYSIgKTsKCgkJaWYgKCBpdGVyYXRvciA+IDEgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMikiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1iIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMiApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgzbiszKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWMiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAzICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKDRuKzQpIiApLmFkZENsYXNzKCAidWktYmxvY2stZCIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDQgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoNW4rNSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1lIiApOwoJCX0KCX0pOwp9Owp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCBlLnRhcmdldCApLmFkZENsYXNzKCAidWktbm9qcyIgKTsKCQp9KTsKCn0pKCBqUXVlcnkgKTsKCiggZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uYnV0dG9uTWFya3VwID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7Cgl2YXIgJHdvcmtpbmdTZXQgPSB0aGlzOwoKCS8vIEVuZm9yY2Ugb3B0aW9ucyB0byBiZSBvZiB0eXBlIHN0cmluZwoJb3B0aW9ucyA9ICggb3B0aW9ucyAmJiAoICQudHlwZSggb3B0aW9ucyApID09ICJvYmplY3QiICkgKT8gb3B0aW9ucyA6IHt9OwoJZm9yICggdmFyIGkgPSAwOyBpIDwgJHdvcmtpbmdTZXQubGVuZ3RoOyBpKysgKSB7CgkJdmFyIGVsID0gJHdvcmtpbmdTZXQuZXEoIGkgKSwKCQkJZSA9IGVsWyAwIF0sCgkJCW8gPSAkLmV4dGVuZCgge30sICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzLCB7CgkJCQlpY29uOiAgICAgICBvcHRpb25zLmljb24gICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbiAgICAgICA6IGVsLmpxbURhdGEoICJpY29uIiApLAoJCQkJaWNvbnBvczogICAgb3B0aW9ucy5pY29ucG9zICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25wb3MgICAgOiBlbC5qcW1EYXRhKCAiaWNvbnBvcyIgKSwKCQkJCXRoZW1lOiAgICAgIG9wdGlvbnMudGhlbWUgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy50aGVtZSAgICAgIDogZWwuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICksCgkJCQlpbmxpbmU6ICAgICBvcHRpb25zLmlubGluZSAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaW5saW5lICAgICA6IGVsLmpxbURhdGEoICJpbmxpbmUiICksCgkJCQlzaGFkb3c6ICAgICBvcHRpb25zLnNoYWRvdyAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc2hhZG93ICAgICA6IGVsLmpxbURhdGEoICJzaGFkb3ciICksCgkJCQljb3JuZXJzOiAgICBvcHRpb25zLmNvcm5lcnMgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY29ybmVycyAgICA6IGVsLmpxbURhdGEoICJjb3JuZXJzIiApLAoJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25zaGFkb3cgOiBlbC5qcW1EYXRhKCAiaWNvbnNoYWRvdyIgKSwKCQkJCW1pbmk6ICAgICAgIG9wdGlvbnMubWluaSAgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5taW5pICAgICAgIDogZWwuanFtRGF0YSggIm1pbmkiICkKCQkJfSwgb3B0aW9ucyApLAoKCQkJLy8gQ2xhc3NlcyBEZWZpbmVkCgkJCWlubmVyQ2xhc3MgPSAidWktYnRuLWlubmVyIiwKCQkJdGV4dENsYXNzID0gInVpLWJ0bi10ZXh0IiwKCQkJYnV0dG9uQ2xhc3MsIGljb25DbGFzcywKCQkJLy8gQnV0dG9uIGlubmVyIG1hcmt1cAoJCQlidXR0b25Jbm5lciwKCQkJYnV0dG9uVGV4dCwKCQkJYnV0dG9uSWNvbiwKCQkJYnV0dG9uRWxlbWVudHM7CgoJCSQuZWFjaChvLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CgkJCWUuc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBrZXksIHZhbHVlICk7CgkJCWVsLmpxbURhdGEoa2V5LCB2YWx1ZSk7CgkJfSk7CgoJCS8vIENoZWNrIGlmIHRoaXMgZWxlbWVudCBpcyBhbHJlYWR5IGVuaGFuY2VkCgkJYnV0dG9uRWxlbWVudHMgPSAkLmRhdGEoKChlLnRhZ05hbWUgPT09ICJJTlBVVCIgfHwgZS50YWdOYW1lID09PSAiQlVUVE9OIikgPyBlLnBhcmVudE5vZGUgOiBlKSwgImJ1dHRvbkVsZW1lbnRzIik7CgoJCWlmIChidXR0b25FbGVtZW50cykgewoJCQllID0gYnV0dG9uRWxlbWVudHMub3V0ZXI7CgkJCWVsID0gJChlKTsKCQkJYnV0dG9uSW5uZXIgPSBidXR0b25FbGVtZW50cy5pbm5lcjsKCQkJYnV0dG9uVGV4dCA9IGJ1dHRvbkVsZW1lbnRzLnRleHQ7CgkJCS8vIFdlIHdpbGwgcmVjcmVhdGUgdGhpcyBpY29uIGJlbG93CgkJCSQoYnV0dG9uRWxlbWVudHMuaWNvbikucmVtb3ZlKCk7CgkJCWJ1dHRvbkVsZW1lbnRzLmljb24gPSBudWxsOwoJCX0KCQllbHNlIHsKCQkJYnV0dG9uSW5uZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKTsKCQkJYnV0dG9uVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApOwoJCX0KCQlidXR0b25JY29uID0gby5pY29uID8gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgOiBudWxsOwoKCQlpZiAoIGF0dGFjaEV2ZW50cyAmJiAhYnV0dG9uRWxlbWVudHMpIHsKCQkJYXR0YWNoRXZlbnRzKCk7CgkJfQoJCQoJCS8vIGlmIG5vdCwgdHJ5IHRvIGZpbmQgY2xvc2VzdCB0aGVtZSBjb250YWluZXIJCgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICk7CQoJCX0JCQoKCQlidXR0b25DbGFzcyA9ICJ1aS1idG4gdWktYnRuLXVwLSIgKyBvLnRoZW1lOwoJCWJ1dHRvbkNsYXNzICs9IG8uc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiI7CgkJYnV0dG9uQ2xhc3MgKz0gby5jb3JuZXJzID8gIiB1aS1idG4tY29ybmVyLWFsbCIgOiAiIjsKCgkJaWYgKCBvLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYG1pbmlgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLm1pbmkgPT09IHRydWUgPyAiIHVpLW1pbmkiIDogIiB1aS1mdWxsc2l6ZSI7CgkJfQoJCQoJCWlmICggby5pbmxpbmUgIT09IHVuZGVmaW5lZCApIHsJCQkKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYGlubGluZWAgc3R5bGUuCgkJCWJ1dHRvbkNsYXNzICs9IG8uaW5saW5lID09PSB0cnVlID8gIiB1aS1idG4taW5saW5lIiA6ICIgdWktYnRuLWJsb2NrIjsKCQl9CgkJCgkJaWYgKCBvLmljb24gKSB7CgkJCW8uaWNvbiA9ICJ1aS1pY29uLSIgKyBvLmljb247CgkJCW8uaWNvbnBvcyA9IG8uaWNvbnBvcyB8fCAibGVmdCI7CgoJCQlpY29uQ2xhc3MgPSAidWktaWNvbiAiICsgby5pY29uOwoKCQkJaWYgKCBvLmljb25zaGFkb3cgKSB7CgkJCQlpY29uQ2xhc3MgKz0gIiB1aS1pY29uLXNoYWRvdyI7CgkJCX0KCQl9CgoJCWlmICggby5pY29ucG9zICkgewoJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi1pY29uLSIgKyBvLmljb25wb3M7CgoJCQlpZiAoIG8uaWNvbnBvcyA9PSAibm90ZXh0IiAmJiAhZWwuYXR0ciggInRpdGxlIiApICkgewoJCQkJZWwuYXR0ciggInRpdGxlIiwgZWwuZ2V0RW5jb2RlZFRleHQoKSApOwoJCQl9CgkJfQogICAgCgkJaW5uZXJDbGFzcyArPSBvLmNvcm5lcnMgPyAiIHVpLWJ0bi1jb3JuZXItYWxsIiA6ICIiOwoKCQlpZiAoIG8uaWNvbnBvcyAmJiBvLmljb25wb3MgPT09ICJub3RleHQiICYmICFlbC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCWVsLmF0dHIoICJ0aXRsZSIsIGVsLmdldEVuY29kZWRUZXh0KCkgKTsKCQl9CgoJCWlmICggYnV0dG9uRWxlbWVudHMgKSB7CgkJCWVsLnJlbW92ZUNsYXNzKCBidXR0b25FbGVtZW50cy5iY2xzIHx8ICIiICk7CgkJfQoJCWVsLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCgkJYnV0dG9uSW5uZXIuY2xhc3NOYW1lID0gaW5uZXJDbGFzczsKCgkJYnV0dG9uVGV4dC5jbGFzc05hbWUgPSB0ZXh0Q2xhc3M7CgkJaWYgKCAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25UZXh0ICk7CgkJfQoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJYnV0dG9uSWNvbi5jbGFzc05hbWUgPSBpY29uQ2xhc3M7CgkJCWlmICggISggYnV0dG9uRWxlbWVudHMgJiYgYnV0dG9uRWxlbWVudHMuaWNvbiApICkgewoJCQkJYnV0dG9uSWNvbi5pbm5lckhUTUwgPSAiJiMxNjA7IjsKCQkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25JY29uICk7CgkJCX0KCQl9CgoJCXdoaWxlICggZS5maXJzdENoaWxkICYmICFidXR0b25FbGVtZW50cykgewoJCQlidXR0b25UZXh0LmFwcGVuZENoaWxkKCBlLmZpcnN0Q2hpbGQgKTsKCQl9CgoJCWlmICggIWJ1dHRvbkVsZW1lbnRzICkgewoJCQllLmFwcGVuZENoaWxkKCBidXR0b25Jbm5lciApOwoJCX0KCgkJLy8gQXNzaWduIGEgc3RydWN0dXJlIGNvbnRhaW5pbmcgdGhlIGVsZW1lbnRzIG9mIHRoaXMgYnV0dG9uIHRvIHRoZSBlbGVtZW50cyBvZiB0aGlzIGJ1dHRvbi4gVGhpcwoJCS8vIHdpbGwgYWxsb3cgdXMgdG8gcmVjb2duaXplIHRoaXMgYXMgYW4gYWxyZWFkeS1lbmhhbmNlZCBidXR0b24gaW4gZnV0dXJlIGNhbGxzIHRvIGJ1dHRvbk1hcmt1cCgpLgoJCWJ1dHRvbkVsZW1lbnRzID0gewoJCQliY2xzICA6IGJ1dHRvbkNsYXNzLAoJCQlvdXRlciA6IGUsCgkJCWlubmVyIDogYnV0dG9uSW5uZXIsCgkJCXRleHQgIDogYnV0dG9uVGV4dCwKCQkJaWNvbiAgOiBidXR0b25JY29uCgkJfTsKCgkJJC5kYXRhKGUsICAgICAgICAgICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyk7CgkJJC5kYXRhKGJ1dHRvbklubmVyLCAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyk7CgkJJC5kYXRhKGJ1dHRvblRleHQsICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyk7CgkJaWYgKGJ1dHRvbkljb24pIHsKCQkJJC5kYXRhKGJ1dHRvbkljb24sICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzKTsKCQl9Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgokLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cyA9IHsKCWNvcm5lcnM6IHRydWUsCglzaGFkb3c6IHRydWUsCglpY29uc2hhZG93OiB0cnVlLAoJd3JhcHBlckVsczogInNwYW4iCn07CgpmdW5jdGlvbiBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZWxlbWVudCApIHsKICAgIHZhciBjbmFtZTsKCiAgICB3aGlsZSAoIGVsZW1lbnQgKSB7CgkJLy8gTm90ZSB0aGF0IHdlIGNoZWNrIGZvciB0eXBlb2YgY2xhc3NOYW1lIGJlbG93IGJlY2F1c2UgdGhlIGVsZW1lbnQgd2UKCQkvLyBoYW5kZWQgY291bGQgYmUgaW4gYW4gU1ZHIERPTSB3aGVyZSBjbGFzc05hbWUgb24gU1ZHIGVsZW1lbnRzIGlzIGRlZmluZWQgdG8KCQkvLyBiZSBvZiBhIGRpZmZlcmVudCB0eXBlIChTVkdBbmltYXRlZFN0cmluZykuIFdlIG9ubHkgb3BlcmF0ZSBvbiBIVE1MIERPTQoJCS8vIGVsZW1lbnRzLCBzbyB3ZSBsb29rIGZvciBwbGFpbiAic3RyaW5nIi4KICAgICAgICBjbmFtZSA9ICggdHlwZW9mIGVsZW1lbnQuY2xhc3NOYW1lID09PSAnc3RyaW5nJyApICYmIChlbGVtZW50LmNsYXNzTmFtZSArICcgJyk7CiAgICAgICAgaWYgKCBjbmFtZSAmJiBjbmFtZS5pbmRleE9mKCJ1aS1idG4gIikgPiAtMSAmJiBjbmFtZS5pbmRleE9mKCJ1aS1kaXNhYmxlZCAiKSA8IDAgKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgIH0KCiAgICByZXR1cm4gZWxlbWVudDsKfQoKdmFyIGF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJdmFyIGhvdmVyRGVsYXkgPSAkLm1vYmlsZS5idXR0b25NYXJrdXAuaG92ZXJEZWxheSwgaG92LCBmb2M7CgoJJCggZG9jdW1lbnQgKS5iaW5kKCB7CgkJInZtb3VzZWRvd24gdm1vdXNlY2FuY2VsIHZtb3VzZXVwIHZtb3VzZW92ZXIgdm1vdXNlb3V0IGZvY3VzIGJsdXIgc2Nyb2xsc3RhcnQiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciB0aGVtZSwKCQkJCSRidG4gPSAkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKSwKCQkJCWV2dCA9IGV2ZW50LnR5cGU7CgkJCgkJCWlmICggJGJ0bi5sZW5ndGggKSB7CgkJCQl0aGVtZSA9ICRidG4uYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiApOwoJCQoJCQkJaWYgKCBldnQgPT09ICJ2bW91c2Vkb3duIiApIHsKCQkJCQlpZiAoICQuc3VwcG9ydC50b3VjaCApIHsKCQkJCQkJaG92ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgdGhlbWUgKTsKCQkJCQkJfSwgaG92ZXJEZWxheSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgdGhlbWUgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VjYW5jZWwiIHx8IGV2dCA9PT0gInZtb3VzZXVwIiApIHsKCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICk7CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VvdmVyIiB8fCBldnQgPT09ICJmb2N1cyIgKSB7CgkJCQkJaWYgKCAkLnN1cHBvcnQudG91Y2ggKSB7CgkJCQkJCWZvYyA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSApOwoJCQkJCQl9LCBob3ZlckRlbGF5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VvdXQiIHx8IGV2dCA9PT0gImJsdXIiIHx8IGV2dCA9PT0gInNjcm9sbHN0YXJ0IiApIHsKCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSAgKyAiIHVpLWJ0bi1kb3duLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApOwoJCQkJCWlmICggaG92ICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhvdiApOwoJCQkJCX0KCQkJCQlpZiAoIGZvYyApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBmb2MgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoJCSJmb2N1c2luIGZvY3VzIjogZnVuY3Rpb24oIGV2ZW50ICl7CgkJCSQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJfSwKCQkiZm9jdXNvdXQgYmx1ciI6IGZ1bmN0aW9uKCBldmVudCApewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0KCX0pOwoKCWF0dGFjaEV2ZW50cyA9IG51bGw7Cn07CgovL2xpbmtzIGluIGJhcnMsIG9yIHRob3NlIHdpdGggIGRhdGEtcm9sZSBiZWNvbWUgYnV0dG9ucwovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoKCSQoICI6anFtRGF0YShyb2xlPSdidXR0b24nKSwgLnVpLWJhciA+IGEsIC51aS1oZWFkZXIgPiBhLCAudWktZm9vdGVyID4gYSwgLnVpLWJhciA+IDpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpID4gYSIsIGUudGFyZ2V0ICkKCQkuanFtRW5oYW5jZWFibGUoKQoJCS5ub3QoICJidXR0b24sIGlucHV0LCAudWktYnRuLCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5idXR0b25NYXJrdXAoKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWV4cGFuZEN1ZVRleHQ6ICIgY2xpY2sgdG8gZXhwYW5kIGNvbnRlbnRzIiwKCQljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJCWNvbGxhcHNlZDogdHJ1ZSwKCQloZWFkaW5nOiAiaDEsaDIsaDMsaDQsaDUsaDYsbGVnZW5kIiwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaWNvblRoZW1lOiAiZCIsCgkJbWluaTogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGUgPSAkZWwuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSIgKSwKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJGVsLmNoaWxkcmVuKCBvLmhlYWRpbmcgKS5maXJzdCgpLAoJCQljb2xsYXBzaWJsZUNvbnRlbnQgPSBjb2xsYXBzaWJsZS53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1jb250ZW50Jz48L2Rpdj4iICkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCQljb2xsYXBzaWJsZVNldCA9ICRlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICk7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIGNvbGxhcHNpYmxlSGVhZGluZy5pcyggImxlZ2VuZCIgKSApIHsKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJCggIjxkaXYgcm9sZT0naGVhZGluZyc+IisgY29sbGFwc2libGVIZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlSGVhZGluZyApOwoJCQljb2xsYXBzaWJsZUhlYWRpbmcubmV4dCgpLnJlbW92ZSgpOwoJCX0KCgkJLy8gSWYgd2UgYXJlIGluIGEgY29sbGFwc2libGUgc2V0CgkJaWYgKCBjb2xsYXBzaWJsZVNldC5sZW5ndGggKSB7CgkJCS8vIEluaGVyaXQgdGhlIHRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8udGhlbWUgKSB7CgkJCQlvLnRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSgidGhlbWUiKSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggY29sbGFwc2libGVTZXQsICJjIiApOwoJCQl9CgkJCS8vIEluaGVyaXQgdGhlIGNvbnRlbnQtdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby5jb250ZW50VGhlbWUgKSB7CgkJCQlvLmNvbnRlbnRUaGVtZSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJjb250ZW50LXRoZW1lIiApOwoJCQl9CgoJCQkvLyBHZXRzIHRoZSBwcmVmZXJlbmNlIGljb24gcG9zaXRpb24gaW4gdGhlIHNldAoJCQlpZiAoICFvLmljb25wb3MgKSB7CgkJCQlvLmljb25wb3MgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaWNvbnBvcyIgKTsKCQkJfQoKCQkJaWYoICFvLm1pbmkgKSB7CgkJCQlvLm1pbmkgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAibWluaSIgKTsKCQkJfQoJCX0KCQljb2xsYXBzaWJsZUNvbnRlbnQuYWRkQ2xhc3MoICggby5jb250ZW50VGhlbWUgKSA/ICggInVpLWJvZHktIiArIG8uY29udGVudFRoZW1lICkgOiAiIik7CgoJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkvL2Ryb3AgaGVhZGluZyBpbiBiZWZvcmUgY29udGVudAoJCQkuaW5zZXJ0QmVmb3JlKCBjb2xsYXBzaWJsZUNvbnRlbnQgKQoJCQkvL21vZGlmeSBtYXJrdXAgJiBhdHRyaWJ1dGVzCgkJCS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmciICkKCQkJLmFwcGVuZCggIjxzcGFuIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyc+PC9zcGFuPiIgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJaWNvbnBvczogJGVsLmpxbURhdGEoICJpY29ucG9zIiApIHx8IG8uaWNvbnBvcyB8fCAibGVmdCIsCgkJCQkJaWNvbjogInBsdXMiLAoJCQkJCW1pbmk6IG8ubWluaSwKCQkJCQl0aGVtZTogby50aGVtZQoJCQkJfSkKCQkJLmFkZCggIi51aS1idG4taW5uZXIiLCAkZWwgKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIiApOwoKCQkvL2V2ZW50cwoJCWNvbGxhcHNpYmxlCgkJCS5iaW5kKCAiZXhwYW5kIGNvbGxhcHNlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJaXNDb2xsYXBzZSA9ICggZXZlbnQudHlwZSA9PT0gImNvbGxhcHNlIiApLAoJCQkJCSAgICBjb250ZW50VGhlbWUgPSBvLmNvbnRlbnRUaGVtZTsKCgkJCQkJY29sbGFwc2libGVIZWFkaW5nCgkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiwgaXNDb2xsYXBzZSkKCQkJCQkJLmZpbmQoICIudWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMiICkKCQkJCQkJCS50ZXh0KCBpc0NvbGxhcHNlID8gby5leHBhbmRDdWVUZXh0IDogby5jb2xsYXBzZUN1ZVRleHQgKQoJCQkJCQkuZW5kKCkKCQkJCQkJLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1taW51cyIsICFpc0NvbGxhcHNlICkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tcGx1cyIsIGlzQ29sbGFwc2UgKQoJCQkJCQkuZW5kKCkKCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCQkJCSR0aGlzLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApOwoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbnRlbnQtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApLmF0dHIoICJhcmlhLWhpZGRlbiIsIGlzQ29sbGFwc2UgKTsKCgkJCQkJaWYgKCBjb250ZW50VGhlbWUgJiYgKCAhY29sbGFwc2libGVTZXQubGVuZ3RoIHx8IGNvbGxhcHNpYmxlLmpxbURhdGEoICJjb2xsYXBzaWJsZS1sYXN0IiApICkgKSB7CgkJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkKCBjb2xsYXBzaWJsZUhlYWRpbmcuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGVDb250ZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCQkJfQoJCQl9KQoJCQkudHJpZ2dlciggby5jb2xsYXBzZWQgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS5iaW5kKCAidGFwIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJY29sbGFwc2libGVIZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJdmFyIHR5cGUgPSBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICIudWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgPyAiZXhwYW5kIiA6ICJjb2xsYXBzZSI7CgoJCQkJY29sbGFwc2libGUudHJpZ2dlciggdHlwZSApOwoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQubW9iaWxlLmNvbGxhcHNpYmxlLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGVzZXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApLAoJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBJbmhlcml0IHRoZSB0aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggJGVsLCAiYyIgKTsKCQl9CgkJLy8gSW5oZXJpdCB0aGUgY29udGVudC10aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQlvLmNvbnRlbnRUaGVtZSA9ICRlbC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQl9CgoJCWlmICggIW8uY29ybmVycyApIHsKCQkJby5jb3JuZXJzID0gJGVsLmpxbURhdGEoICJjb3JuZXJzIiApID09PSB1bmRlZmluZWQgPyB0cnVlIDogZmFsc2U7CgkJfQoKCQkvLyBJbml0aWFsaXplIHRoZSBjb2xsYXBzaWJsZSBzZXQgaWYgaXQncyBub3QgYWxyZWFkeSBpbml0aWFsaXplZAoJCWlmICggISRlbC5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIgKSApIHsKCQkJJGVsCgkJCQkuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiLCB0cnVlICkKCQkJCS5iaW5kKCAiZXhwYW5kIGNvbGxhcHNlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCXZhciBpc0NvbGxhcHNlID0gKCBldmVudC50eXBlID09PSAiY29sbGFwc2UiICksCgkJCQkJCWNvbGxhcHNpYmxlID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1jb2xsYXBzaWJsZSIgKSwKCQkJCQkJd2lkZ2V0ID0gY29sbGFwc2libGUuZGF0YSggImNvbGxhcHNpYmxlIiApLAoJCQkJCSAgICBjb250ZW50VGhlbWUgPSB3aWRnZXQub3B0aW9ucy5jb250ZW50VGhlbWU7CgkJCQkJaWYgKCBjb250ZW50VGhlbWUgJiYgY29sbGFwc2libGUuanFtRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiICkgKSB7CgkJCQkJCWNvbGxhcHNpYmxlLmZpbmQoICIudWktY29sbGFwc2libGUtaGVhZGluZyIgKS5maXJzdCgpCgkJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKQoJCQkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiwgaXNDb2xsYXBzZSApOwoJCQkJCQljb2xsYXBzaWJsZS5maW5kKCAiLnVpLWNvbGxhcHNpYmxlLWNvbnRlbnQiICkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiwgIWlzQ29sbGFwc2UgKTsKCQkJCQl9CgkJCQl9KQoJCQkJLmJpbmQoICJleHBhbmQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJJCggZXZlbnQudGFyZ2V0ICkKCQkJCQkJLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICkKCQkJCQkJLnNpYmxpbmdzKCAiLnVpLWNvbGxhcHNpYmxlIiApCgkJCQkJCS50cmlnZ2VyKCAiY29sbGFwc2UiICk7CgkJCQl9KTsKCQl9Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGVzSW5TZXQgPSAkZWwuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApOwoKCQkkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUuZW5oYW5jZSggY29sbGFwc2libGVzSW5TZXQubm90KCAiLnVpLWNvbGxhcHNpYmxlIiApICk7CgoJCS8vIGNsZWFuIHVwIGJvcmRlcnMKCQljb2xsYXBzaWJsZXNJblNldC5lYWNoKCBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLmpxbVJlbW92ZURhdGEoICJjb2xsYXBzaWJsZS1sYXN0IiApCgkJCQkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCQkuZmluZCggImEiICkuZmlyc3QoKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIiApCgkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSIgKTsKCQl9KTsKCgkJY29sbGFwc2libGVzSW5TZXQuZmlyc3QoKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYWRkQ2xhc3MoIG8uY29ybmVycyA/ICJ1aS1jb3JuZXItdG9wIiA6ICIiICkKCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICk7CgoJCWNvbGxhcHNpYmxlc0luU2V0Lmxhc3QoKQoJCQkuanFtRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiLCB0cnVlICkKCQkJLmZpbmQoICJhIiApCgkJCQkuZmlyc3QoKQoJCQkJLmFkZENsYXNzKCBvLmNvcm5lcnMgPyAidWktY29ybmVyLWJvdHRvbSIgOiAiIiApCgkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5jb2xsYXBzaWJsZXNldC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLm5hdmJhciIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWljb25wb3M6ICJ0b3AiLAoJCWdyaWQ6IG51bGwsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nbmF2YmFyJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCl7CgoJCXZhciAkbmF2YmFyID0gdGhpcy5lbGVtZW50LAoJCQkkbmF2YnRucyA9ICRuYXZiYXIuZmluZCggImEiICksCgkJCWljb25wb3MgPSAkbmF2YnRucy5maWx0ZXIoICI6anFtRGF0YShpY29uKSIgKS5sZW5ndGggPwoJCQkJCQkJCQl0aGlzLm9wdGlvbnMuaWNvbnBvcyA6IHVuZGVmaW5lZDsKCgkJJG5hdmJhci5hZGRDbGFzcyggInVpLW5hdmJhciB1aS1taW5pIiApCgkJCS5hdHRyKCAicm9sZSIsIm5hdmlnYXRpb24iICkKCQkJLmZpbmQoICJ1bCIgKQoJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWlubGluZTogICAgIHRydWUsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiggISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktZGlzYWJsZWQiKSApIHsKCQkJCSRuYXZidG5zLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7CgoJCS8vIEJ1dHRvbnMgaW4gdGhlIG5hdmJhciB3aXRoIHVpLXN0YXRlLXBlcnNpc3QgY2xhc3Mgc2hvdWxkIHJlZ2FpbiB0aGVpciBhY3RpdmUgc3RhdGUgYmVmb3JlIHBhZ2Ugc2hvdwoJCSRuYXZiYXIuY2xvc2VzdCggIi51aS1wYWdlIiApLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkkbmF2YnRucy5maWx0ZXIoICIudWktc3RhdGUtcGVyc2lzdCIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUubmF2YmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy9LZWVwcyB0cmFjayBvZiB0aGUgbnVtYmVyIG9mIGxpc3RzIHBlciBwYWdlIFVJRAovL1RoaXMgYWxsb3dzIHN1cHBvcnQgZm9yIG11bHRpcGxlIG5lc3RlZCBsaXN0IGluIHRoZSBzYW1lIHBhZ2UKLy9odHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzE2MTcKdmFyIGxpc3RDb3VudFBlclBhZ2UgPSB7fTsKCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUud2lkZ2V0LCB7CgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6ICJjIiwKCQloZWFkZXJUaGVtZTogImIiLAoJCWRpdmlkZXJUaGVtZTogImIiLAoJCXNwbGl0SWNvbjogImFycm93LXIiLAoJCXNwbGl0VGhlbWU6ICJiIiwKCQlpbnNldDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nbGlzdHZpZXcnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHQgPSB0aGlzLAoJCQlsaXN0dmlld0NsYXNzZXMgPSAiIjsKCQkJCgkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5pbnNldCA/ICIgdWktbGlzdHZpZXctaW5zZXQgdWktY29ybmVyLWFsbCB1aS1zaGFkb3cgIiA6ICIiOwoKCQkvLyBjcmVhdGUgbGlzdHZpZXcgbWFya3VwCgkJdC5lbGVtZW50LmFkZENsYXNzKGZ1bmN0aW9uKCBpLCBvcmlnICkgewoJCQlyZXR1cm4gb3JpZyArICIgdWktbGlzdHZpZXcgIiArIGxpc3R2aWV3Q2xhc3NlczsKCQl9KTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9yZW1vdmVDb3JuZXJzOiBmdW5jdGlvbiggbGksIHdoaWNoICkgewoJCXZhciB0b3AgPSAidWktY29ybmVyLXRvcCB1aS1jb3JuZXItdHIgdWktY29ybmVyLXRsIiwKCQkJYm90ID0gInVpLWNvcm5lci1ib3R0b20gdWktY29ybmVyLWJyIHVpLWNvcm5lci1ibCI7CgoJCWxpID0gbGkuYWRkKCBsaS5maW5kKCAiLnVpLWJ0bi1pbm5lciwgLnVpLWxpLWxpbmstYWx0LCAudWktbGktdGh1bWIiICkgKTsKCgkJaWYgKCB3aGljaCA9PT0gInRvcCIgKSB7CgkJCWxpLnJlbW92ZUNsYXNzKCB0b3AgKTsKCQl9IGVsc2UgaWYgKCB3aGljaCA9PT0gImJvdHRvbSIgKSB7CgkJCWxpLnJlbW92ZUNsYXNzKCBib3QgKTsKCQl9IGVsc2UgewoJCQlsaS5yZW1vdmVDbGFzcyggdG9wICsgIiAiICsgYm90ICk7CgkJfQoJfSwKCglfcmVmcmVzaENvcm5lcnM6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyICRsaSwKCQkJJHZpc2libGVsaSwKCQkJJHRvcGxpLAoJCQkkYm90dG9tbGk7CgoJCSRsaSA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggImxpIiApOwoJCS8vIGF0IGNyZWF0ZSB0aW1lIHRoZSBsaSBhcmUgbm90IHZpc2libGUgeWV0IHNvIHdlIG5lZWQgdG8gcmVseSBvbiAudWktc2NyZWVuLWhpZGRlbgoJCSR2aXNpYmxlbGkgPSBjcmVhdGUgPyAkbGkubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICkgOiAkbGkuZmlsdGVyKCAiOnZpc2libGUiICk7CgoJCS8vIHVpLWxpLWxhc3QgaXMgdXNlZCBmb3Igc2V0dGluZyBib3JkZXItYm90dG9tIG9uIHRoZSBsYXN0IGxpCQkKCQkkbGkuZmlsdGVyKCAiLnVpLWxpLWxhc3QiICkucmVtb3ZlQ2xhc3MoICJ1aS1saS1sYXN0IiApOwoJCQkJCQoJCWlmICggdGhpcy5vcHRpb25zLmluc2V0ICkgewoJCQl0aGlzLl9yZW1vdmVDb3JuZXJzKCAkbGkgKTsKCgkJCS8vIFNlbGVjdCB0aGUgZmlyc3QgdmlzaWJsZSBsaSBlbGVtZW50CgkJCSR0b3BsaSA9ICR2aXNpYmxlbGkuZmlyc3QoKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKTsKCgkJCSR0b3BsaS5hZGQoICR0b3BsaS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJLm5vdCggIi51aS1saS1saW5rLWFsdCBzcGFuOmZpcnN0LWNoaWxkIiApICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApCgkJCQkuZW5kKCkKCQkJCS5maW5kKCAiLnVpLWxpLWxpbmstYWx0LCAudWktbGktbGluay1hbHQgc3BhbjpmaXJzdC1jaGlsZCIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10ciIgKQoJCQkJLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS10aHVtYiIgKQoJCQkJCS5ub3QoICIudWktbGktaWNvbiIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10bCIgKTsKCgkJCS8vIFNlbGVjdCB0aGUgbGFzdCB2aXNpYmxlIGxpIGVsZW1lbnQKCQkJJGJvdHRvbWxpID0gJHZpc2libGVsaS5sYXN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20gdWktbGktbGFzdCIgKTsKCgkJCSRib3R0b21saS5hZGQoICRib3R0b21saS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKSApCgkJCQkuZmluZCggIi51aS1saS1saW5rLWFsdCIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1iciIgKQoJCQkJLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS10aHVtYiIgKQoJCQkJCS5ub3QoIi51aS1saS1pY29uIikKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYmwiICk7CgkJfSBlbHNlIHsKCQkJJHZpc2libGVsaS5sYXN0KCkuYWRkQ2xhc3MoICJ1aS1saS1sYXN0IiApOwoJCX0KCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0sCgoJLy8gVGhpcyBpcyBhIGdlbmVyaWMgdXRpbGl0eSBtZXRob2QgZm9yIGZpbmRpbmcgdGhlIGZpcnN0CgkvLyBub2RlIHdpdGggYSBnaXZlbiBub2RlTmFtZS4gSXQgdXNlcyBiYXNpYyBET00gdHJhdmVyc2FsCgkvLyB0byBiZSBmYXN0IGFuZCBpcyBtZWFudCB0byBiZSBhIHN1YnN0aXR1dGUgZm9yIHNpbXBsZQoJLy8gJC5mbi5jbG9zZXN0KCkgYW5kICQuZm4uY2hpbGRyZW4oKSBjYWxscyBvbiBhIHNpbmdsZQoJLy8gZWxlbWVudC4gTm90ZSB0aGF0IGNhbGxlcnMgbXVzdCBwYXNzIGJvdGggdGhlIGxvd2VyQ2FzZQoJLy8gYW5kIHVwcGVyQ2FzZSB2ZXJzaW9uIG9mIHRoZSBub2RlTmFtZSB0aGV5IGFyZSBsb29raW5nIGZvci4KCS8vIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcyBpcyB0aGF0IHRoaXMgZnVuY3Rpb24gd2lsbCBiZQoJLy8gY2FsbGVkIG1hbnkgdGltZXMgYW5kIHdlIHdhbnQgdG8gYXZvaWQgaGF2aW5nIHRvIGxvd2VyY2FzZQoJLy8gdGhlIG5vZGVOYW1lIGZyb20gdGhlIGVsZW1lbnQgZXZlcnkgdGltZSB0byBlbnN1cmUgd2UgaGF2ZQoJLy8gYSBtYXRjaC4gTm90ZSB0aGF0IHRoaXMgZnVuY3Rpb24gbGl2ZXMgaGVyZSBmb3Igbm93LCBidXQgbWF5CgkvLyBiZSBtb3ZlZCBpbnRvICQubW9iaWxlIGlmIG90aGVyIGNvbXBvbmVudHMgbmVlZCBhIHNpbWlsYXIgbWV0aG9kLgoJX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIG5leHRQcm9wLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmV0dXJuIGVsZTsKCQkJfQoJCQllbGUgPSBlbGVbIG5leHRQcm9wIF07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCV9nZXRDaGlsZHJlbkJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIHJlc3VsdHMgPSBbXSwKCQkJZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCWVsZSA9IGVsZS5maXJzdENoaWxkOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmVzdWx0cy5wdXNoKCBlbGUgKTsKCQkJfQoJCQllbGUgPSBlbGUubmV4dFNpYmxpbmc7CgkJfQoJCXJldHVybiAkKCByZXN1bHRzICk7Cgl9LAoKCV9hZGRUaHVtYkNsYXNzZXM6IGZ1bmN0aW9uKCBjb250YWluZXJzICkgewoJCXZhciBpLCBpbWcsIGxlbiA9IGNvbnRhaW5lcnMubGVuZ3RoOwoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWltZyA9ICQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGNvbnRhaW5lcnNbIGkgXS5maXJzdENoaWxkLCAibmV4dFNpYmxpbmciLCAiaW1nIiwgIklNRyIgKSApOwoJCQlpZiAoIGltZy5sZW5ndGggKSB7CgkJCQlpbWcuYWRkQ2xhc3MoICJ1aS1saS10aHVtYiIgKTsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5pcyggIi51aS1saS1pY29uIiApID8gInVpLWxpLWhhcy1pY29uIiA6ICJ1aS1saS1oYXMtdGh1bWIiICk7CgkJCX0KCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5wYXJlbnRQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQl0aGlzLl9jcmVhdGVTdWJQYWdlcygpOwoKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCXNlbGYgPSB0aGlzLAoJCQlkaXZpZGVydGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAiZGl2aWRlcnRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lLAoJCQlsaXN0c3BsaXR0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJzcGxpdHRoZW1lIiApLAoJCQlsaXN0c3BsaXRpY29uID0gJGxpc3QuanFtRGF0YSggInNwbGl0aWNvbiIgKSwKCQkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApLAoJCQlvbCA9ICEhJC5ub2RlTmFtZSggJGxpc3RbIDAgXSwgIm9sIiApLAoJCQlqc0NvdW50ID0gISQuc3VwcG9ydC5jc3NQc2V1ZG9FbGVtZW50LAoJCQlzdGFydCA9ICRsaXN0LmF0dHIoICJzdGFydCIgKSwKCQkJaXRlbUNsYXNzRGljdCA9IHt9LAoJCQlpdGVtLCBpdGVtQ2xhc3MsIGl0ZW1UaGVtZSwKCQkJYSwgbGFzdCwgc3BsaXR0aGVtZSwgY291bnRlciwgc3RhcnRDb3VudCwgbmV3U3RhcnRDb3VudCwgY291bnRQYXJlbnQsIGljb24sIGltZ1BhcmVudHMsIGltZywgbGlua0ljb247CgoJCWlmICggb2wgJiYganNDb3VudCApIHsKCQkJJGxpc3QuZmluZCggIi51aS1saS1kZWMiICkucmVtb3ZlKCk7CgkJfQoJCQoJCWlmICggb2wgKSB7CQoJCQkvLyBDaGVjayBpZiBhIHN0YXJ0IGF0dHJpYnV0ZSBoYXMgYmVlbiBzZXQgd2hpbGUgdGFraW5nIGEgdmFsdWUgb2YgMCBpbnRvIGFjY291bnQKCQkJaWYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApIHsKCQkJCWlmICggIWpzQ291bnQgKSB7CgkJCQkJc3RhcnRDb3VudCA9IHBhcnNlRmxvYXQoIHN0YXJ0ICkgLSAxOwoJCQkJCSRsaXN0LmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgc3RhcnRDb3VudCApOwoJCQkJfSBlbHNlIHsKCQkJCQljb3VudGVyID0gcGFyc2VGbG9hdCggc3RhcnQgKTsKCQkJCX0KCQkJfSBlbHNlIGlmICgganNDb3VudCApIHsKCQkJCQljb3VudGVyID0gMTsKCQkJfQkKCQl9CgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWZvciAoIHZhciBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAidWktbGkiOwoKCQkJLy8gSWYgd2UncmUgY3JlYXRpbmcgdGhlIGVsZW1lbnQsIHdlIHVwZGF0ZSBpdCByZWdhcmRsZXNzCgkJCWlmICggY3JlYXRlIHx8ICFpdGVtLmhhc0NsYXNzKCAidWktbGkiICkgKSB7CgkJCQlpdGVtVGhlbWUgPSBpdGVtLmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lOwoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQl2YXIgaXNEaXZpZGVyID0gKCBpdGVtLmpxbURhdGEoICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApOwoKCQkJCWlmICggYS5sZW5ndGggJiYgIWlzRGl2aWRlciApIHsKCQkJCQlpY29uID0gaXRlbS5qcW1EYXRhKCAiaWNvbiIgKTsKCgkJCQkJaXRlbS5idXR0b25NYXJrdXAoewoJCQkJCQl3cmFwcGVyRWxzOiAiZGl2IiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCWljb25wb3M6ICJyaWdodCIsCgkJCQkJCWljb246IGEubGVuZ3RoID4gMSB8fCBpY29uID09PSBmYWxzZSA/IGZhbHNlIDogaWNvbiB8fCAiYXJyb3ctciIsCgkJCQkJCXRoZW1lOiBpdGVtVGhlbWUKCQkJCQl9KTsKCgkJCQkJaWYgKCAoIGljb24gIT0gZmFsc2UgKSAmJiAoIGEubGVuZ3RoID09IDEgKSApIHsKCQkJCQkJaXRlbS5hZGRDbGFzcyggInVpLWxpLWhhcy1hcnJvdyIgKTsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5yZW1vdmVDbGFzcyggInVpLWxpbmsiICkuYWRkQ2xhc3MoICJ1aS1saW5rLWluaGVyaXQiICk7CgoJCQkJCWlmICggYS5sZW5ndGggPiAxICkgewoJCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1oYXMtYWx0IjsKCgkJCQkJCWxhc3QgPSBhLmxhc3QoKTsKCQkJCQkJc3BsaXR0aGVtZSA9IGxpc3RzcGxpdHRoZW1lIHx8IGxhc3QuanFtRGF0YSggInRoZW1lIiApIHx8IG8uc3BsaXRUaGVtZTsKCQkJCQkJbGlua0ljb24gPSBsYXN0LmpxbURhdGEoICJpY29uIiApOwoKCQkJCQkJbGFzdC5hcHBlbmRUbyggaXRlbSApCgkJCQkJCQkuYXR0ciggInRpdGxlIiwgbGFzdC5nZXRFbmNvZGVkVGV4dCgpICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWxpLWxpbmstYWx0IiApCgkJCQkJCQkuZW1wdHkoKQoJCQkJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJCQl0aGVtZTogaXRlbVRoZW1lLAoJCQkJCQkJCWljb246IGZhbHNlLAoJCQkJCQkJCWljb25wb3M6ICJub3RleHQiCgkJCQkJCQl9KQoJCQkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCQkJLmFwcGVuZCgKCQkJCQkJCQkJJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKS5idXR0b25NYXJrdXAoewoJCQkJCQkJCQkJc2hhZG93OiB0cnVlLAoJCQkJCQkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQkJCQkJCXRoZW1lOiBzcGxpdHRoZW1lLAoJCQkJCQkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJCQkJCQkvLyBsaW5rIGljb24gb3ZlcnJpZGVzIGxpc3QgaXRlbSBpY29uIG92ZXJyaWRlcyB1bCBlbGVtZW50IG92ZXJyaWRlcyBvcHRpb25zCgkJCQkJCQkJCQlpY29uOiBsaW5rSWNvbiB8fCBpY29uIHx8IGxpc3RzcGxpdGljb24gfHwgby5zcGxpdEljb24KCQkJCQkJCQkJfSkKCQkJCQkJCQkpOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGlzRGl2aWRlciApIHsKCgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktZGl2aWRlciB1aS1iYXItIiArIGRpdmlkZXJ0aGVtZTsKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgoJCQkJCWlmICggb2wgKSB7CQoJCQkJCQkvL3Jlc2V0IGNvdW50ZXIgd2hlbiBhIGRpdmlkZXIgaGVhZGluZyBpcyBlbmNvdW50ZXJlZAoJCQkJCQlpZiAoIHN0YXJ0IHx8IHN0YXJ0ID09PSAwICkgewoJCQkJCQkJaWYgKCAhanNDb3VudCApIHsKCQkJCQkJCQluZXdTdGFydENvdW50ID0gcGFyc2VGbG9hdCggc3RhcnQgKSAtIDE7CgkJCQkJCQkJaXRlbS5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIG5ld1N0YXJ0Q291bnQgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJY291bnRlciA9IHBhcnNlRmxvYXQoIHN0YXJ0ICk7CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSBpZiAoIGpzQ291bnQgKSB7CgkJCQkJCQkJY291bnRlciA9IDE7CgkJCQkJCX0JCgkJCQkJfQoKCQkJCX0gZWxzZSB7CgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktc3RhdGljIHVpLWJvZHktIiArIGl0ZW1UaGVtZTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBvbCAmJiBqc0NvdW50ICYmIGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktZGl2aWRlciIgKSA8IDAgKSB7CgkJCQljb3VudFBhcmVudCA9IGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktc3RhdGljIiApID4gMCA/IGl0ZW0gOiBpdGVtLmZpbmQoICIudWktbGluay1pbmhlcml0IiApOwoKCQkJCWNvdW50UGFyZW50LmFkZENsYXNzKCAidWktbGktanNudW1iZXJpbmciICkKCQkJCQkucHJlcGVuZCggIjxzcGFuIGNsYXNzPSd1aS1saS1kZWMnPiIgKyAoIGNvdW50ZXIrKyApICsgIi4gPC9zcGFuPiIgKTsKCQkJfQoKCQkJLy8gSW5zdGVhZCBvZiBzZXR0aW5nIGl0ZW0gY2xhc3MgZGlyZWN0bHkgb24gdGhlIGxpc3QgaXRlbSBhbmQgaXRzCgkJCS8vIGJ0bi1pbm5lciBhdCB0aGlzIHBvaW50IGluIHRpbWUsIHB1c2ggdGhlIGl0ZW0gaW50byBhIGRpY3Rpb25hcnkKCQkJLy8gdGhhdCB0ZWxscyB1cyB3aGF0IGNsYXNzIHRvIHNldCBvbiBpdCBzbyB3ZSBjYW4gZG8gdGhpcyBhZnRlciB0aGlzCgkJCS8vIHByb2Nlc3NpbmcgbG9vcCBpcyBmaW5pc2hlZC4KCgkJCWlmICggIWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkgewoJCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gPSBbXTsKCQkJfQoKCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0ucHVzaCggaXRlbVsgMCBdICk7CgkJfQoKCQkvLyBTZXQgdGhlIGFwcHJvcHJpYXRlIGxpc3R2aWV3IGl0ZW0gY2xhc3NlcyBvbiBlYWNoIGxpc3QgaXRlbQoJCS8vIGFuZCB0aGVpciBidG4taW5uZXIgZWxlbWVudHMuIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApLmNoaWxkcmVuKCAiLnVpLWJ0bi1pbm5lciIgKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQkkbGlzdC5maW5kKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKS5hZGRDbGFzcyggInVpLWxpLWhlYWRpbmciICkKCQkJLmVuZCgpCgoJCQkuZmluZCggInAsIGRsIiApLmFkZENsYXNzKCAidWktbGktZGVzYyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWFzaWRlIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCh0aGlzKTsKCQkJCQkkdGhpcy5wcmVwZW5kVG8oICR0aGlzLnBhcmVudCgpICk7IC8vc2hpZnQgYXNpZGUgdG8gZnJvbnQgZm9yIGNzcyBmbG9hdAoJCQkJfSkKCQkJLmVuZCgpCgoJCQkuZmluZCggIi51aS1saS1jb3VudCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCQkJfSkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArICggJGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUpICsgIiB1aS1idG4tY29ybmVyLWFsbCIgKTsKCgkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBsb29rIGF0IHRoZSBmaXJzdCBpbWFnZSBpbiB0aGUgbGlzdCBpdGVtCgkJLy8gaXRzZWxmLCBhbmQgYW55IC51aS1saW5rLWluaGVyaXQgZWxlbWVudCBpdCBtYXkgY29udGFpbiwgc28gd2UKCQkvLyBjYW4gcGxhY2UgdGhlIGFwcHJvcHJpYXRlIGNsYXNzZXMgb24gdGhlIGltYWdlIGFuZCBsaXN0IGl0ZW0uCgkJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIHNvbWV0aGluZyBsaWtlOgoJCS8vCgkJLy8gICAgbGkuZmluZCgiPmltZzplcSgwKSwgLnVpLWxpbmstaW5oZXJpdD5pbWc6ZXEoMCkiKS5lYWNoKCAuLi4gKTsKCQkvLwoJCS8vIEJ1dCBleGVjdXRpbmcgYSBmaW5kKCkgbGlrZSB0aGF0IG9uIFdpbmRvd3MgUGhvbmUgNy41IHRvb2sgYQoJCS8vIHJlYWxseSBsb25nIHRpbWUuIFdhbGtpbmcgdGhpbmdzIG1hbnVhbGx5IHdpdGggdGhlIGNvZGUgYmVsb3cKCQkvLyBhbGxvd3MgdGhlIDQwMCBsaXN0dmlldyBpdGVtIHBhZ2UgdG8gbG9hZCBpbiBhYm91dCAzIHNlY29uZHMgYXMKCQkvLyBvcHBvc2VkIHRvIDMwIHNlY29uZHMuCgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoICRsaXN0LmZpbmQoICIudWktbGluay1pbmhlcml0IiApICk7CgoJCXRoaXMuX3JlZnJlc2hDb3JuZXJzKCBjcmVhdGUgKTsKCX0sCgoJLy9jcmVhdGUgYSBzdHJpbmcgZm9yIElEL3N1YnBhZ2UgdXJsIGNyZWF0aW9uCglfaWRTdHJpbmdFc2NhcGU6IGZ1bmN0aW9uKCBzdHIgKSB7CgkJcmV0dXJuIHN0ci5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywgJy0nKTsKCX0sCgoJX2NyZWF0ZVN1YlBhZ2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFyZW50TGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50UGFnZSA9IHBhcmVudExpc3QuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlwYXJlbnRVcmwgPSBwYXJlbnRQYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCXBhcmVudElkID0gcGFyZW50VXJsIHx8IHBhcmVudFBhZ2VbIDAgXVsgJC5leHBhbmRvIF0sCgkJCXBhcmVudExpc3RJZCA9IHBhcmVudExpc3QuYXR0ciggImlkIiApLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlkbnMgPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCXNlbGYgPSB0aGlzLAoJCQlwZXJzaXN0ZW50Rm9vdGVySUQgPSBwYXJlbnRQYWdlLmZpbmQoICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKS5qcW1EYXRhKCAiaWQiICksCgkJCWhhc1N1YlBhZ2VzOwoKCQlpZiAoIHR5cGVvZiBsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID09PSAidW5kZWZpbmVkIiApIHsKCQkJbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXSA9IC0xOwoJCX0KCgkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdElkIHx8ICsrbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXTsKCgkJJCggcGFyZW50TGlzdC5maW5kKCAibGk+dWwsIGxpPm9sIiApLnRvQXJyYXkoKS5yZXZlcnNlKCkgKS5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlsaXN0ID0gJCggdGhpcyApLAoJCQkJbGlzdElkID0gbGlzdC5hdHRyKCAiaWQiICkgfHwgcGFyZW50TGlzdElkICsgIi0iICsgaSwKCQkJCXBhcmVudCA9IGxpc3QucGFyZW50KCksCgkJCQlub2RlRWxzID0gJCggbGlzdC5wcmV2QWxsKCkudG9BcnJheSgpLnJldmVyc2UoKSApLAoJCQkJbm9kZUVscyA9IG5vZGVFbHMubGVuZ3RoID8gbm9kZUVscyA6ICQoICI8c3Bhbj4iICsgJC50cmltKHBhcmVudC5jb250ZW50cygpWyAwIF0ubm9kZVZhbHVlKSArICI8L3NwYW4+IiApLAoJCQkJdGl0bGUgPSBub2RlRWxzLmZpcnN0KCkuZ2V0RW5jb2RlZFRleHQoKSwvL3VybCBsaW1pdHMgdG8gZmlyc3QgMzAgY2hhcnMgb2YgdGV4dAoJCQkJaWQgPSAoIHBhcmVudFVybCB8fCAiIiApICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArICI9IiArIGxpc3RJZCwKCQkJCXRoZW1lID0gbGlzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby50aGVtZSwKCQkJCWNvdW50VGhlbWUgPSBsaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IHBhcmVudExpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgby5jb3VudFRoZW1lLAoJCQkJbmV3UGFnZSwgYW5jaG9yOwoKCQkJLy9kZWZpbmUgaGFzU3ViUGFnZXMgZm9yIHVzZSBpbiBsYXRlciByZW1vdmFsCgkJCWhhc1N1YlBhZ2VzID0gdHJ1ZTsKCgkJCW5ld1BhZ2UgPSBsaXN0LmRldGFjaCgpCgkJCQkJCS53cmFwKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J3BhZ2UnICIgKwlkbnMgKyAidXJsPSciICsgaWQgKyAiJyAiICsgZG5zICsgInRoZW1lPSciICsgdGhlbWUgKyAiJyAiICsgZG5zICsgImNvdW50LXRoZW1lPSciICsgY291bnRUaGVtZSArICInPjxkaXYgIiArIGRucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj48L2Rpdj4iICkKCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkuYmVmb3JlKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2hlYWRlcicgIiArIGRucyArICJ0aGVtZT0nIiArIG8uaGVhZGVyVGhlbWUgKyAiJz48ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIHRpdGxlICsgIjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkJLmFmdGVyKCBwZXJzaXN0ZW50Rm9vdGVySUQgPyAkKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2Zvb3RlcicgIiArIGRucyArICJpZD0nIisgcGVyc2lzdGVudEZvb3RlcklEICsiJz4iKSA6ICIiICkKCQkJCQkJCS5wYXJlbnQoKQoJCQkJCQkJCS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJbmV3UGFnZS5wYWdlKCk7CgoJCQlhbmNob3IgPSBwYXJlbnQuZmluZCgnYTpmaXJzdCcpOwoKCQkJaWYgKCAhYW5jaG9yLmxlbmd0aCApIHsKCQkJCWFuY2hvciA9ICQoICI8YS8+IiApLmh0bWwoIG5vZGVFbHMgfHwgdGl0bGUgKS5wcmVwZW5kVG8oIHBhcmVudC5lbXB0eSgpICk7CgkJCX0KCgkJCWFuY2hvci5hdHRyKCAiaHJlZiIsICIjIiArIGlkICk7CgoJCX0pLmxpc3R2aWV3KCk7CgoJCS8vIG9uIHBhZ2VoaWRlLCByZW1vdmUgYW55IG5lc3RlZCBwYWdlcyBhbG9uZyB3aXRoIHRoZSBwYXJlbnQgcGFnZSwgYXMgbG9uZyBhcyB0aGV5IGFyZW4ndCBhY3RpdmUKCQkvLyBhbmQgYXJlbid0IGVtYmVkZGVkCgkJaWYoIGhhc1N1YlBhZ2VzICYmCgkJCXBhcmVudFBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgJiYKCQkJcGFyZW50UGFnZS5kYXRhKCJwYWdlIikub3B0aW9ucy5kb21DYWNoZSA9PT0gZmFsc2UgKSB7CgoJCQl2YXIgbmV3UmVtb3ZlID0gZnVuY3Rpb24oIGUsIHVpICl7CgkJCQl2YXIgbmV4dFBhZ2UgPSB1aS5uZXh0UGFnZSwgbnBVUkwsCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQlpZiggdWkubmV4dFBhZ2UgKXsKCQkJCQlucFVSTCA9IG5leHRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQkJaWYoIG5wVVJMLmluZGV4T2YoIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSAhPT0gMCApewoJCQkJCQlzZWxmLmNoaWxkUGFnZXMoKS5yZW1vdmUoKTsKCQkJCQkJcGFyZW50UGFnZS50cmlnZ2VyKCBwckV2ZW50ICk7CgkJCQkJCWlmKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJCQkJcGFyZW50UGFnZS5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9OwoKCQkJLy8gdW5iaW5kIHRoZSBvcmlnaW5hbCBwYWdlIHJlbW92ZSBhbmQgcmVwbGFjZSB3aXRoIG91ciBzcGVjaWFsaXplZCB2ZXJzaW9uCgkJCXBhcmVudFBhZ2UKCQkJCS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICkKCQkJCS5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiwgbmV3UmVtb3ZlKTsKCQl9Cgl9LAoKCS8vIFRPRE8gc29ydCBvdXQgYSBiZXR0ZXIgd2F5IHRvIHRyYWNrIHN1YiBwYWdlcyBvZiB0aGUgbGlzdHZpZXcgdGhpcyBpcyBicml0dGxlCgljaGlsZFBhZ2VzOiBmdW5jdGlvbigpewoJCXZhciBwYXJlbnRVcmwgPSB0aGlzLnBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKTsKCgkJcmV0dXJuICQoICI6anFtRGF0YSh1cmxePSciKyAgcGFyZW50VXJsICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArIicpIik7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogImNoZWNrYm94cmFkaW8iIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jaGVja2JveHJhZGlvIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJbWluaTogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWluaGVyaXRBdHRyID0gZnVuY3Rpb24oIGlucHV0LCBkYXRhQXR0ciApIHsKCQkJCXJldHVybiBpbnB1dC5qcW1EYXRhKCBkYXRhQXR0ciApIHx8IGlucHV0LmNsb3Nlc3QoICJmb3JtLGZpZWxkc2V0IiApLmpxbURhdGEoIGRhdGFBdHRyICkKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gJCggaW5wdXQgKS5jbG9zZXN0KCAibGFiZWwiICksCgkJCWxhYmVsID0gcGFyZW50TGFiZWwubGVuZ3RoID8gcGFyZW50TGFiZWwgOiAkKCBpbnB1dCApLmNsb3Nlc3QoICJmb3JtLGZpZWxkc2V0LDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSw6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maW5kKCAibGFiZWwiICkuZmlsdGVyKCAiW2Zvcj0nIiArIGlucHV0WzBdLmlkICsgIiddIiApLAoJCQlpbnB1dHR5cGUgPSBpbnB1dFswXS50eXBlLAoJCQltaW5pID0gaW5oZXJpdEF0dHIoIGlucHV0LCAibWluaSIgKSB8fCBvLm1pbmksCgkJCWNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb24iLAoJCQl1bmNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb2ZmIiwKCQkJaWNvbiA9IGlucHV0LnBhcmVudHMoICI6anFtRGF0YSh0eXBlPSdob3Jpem9udGFsJykiICkubGVuZ3RoID8gdW5kZWZpbmVkIDogdW5jaGVja2VkU3RhdGUsCgkJCWljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApLAoJCQlhY3RpdmVCdG4gPSBpY29uID8gIiIgOiAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcywKCQkJY2hlY2tlZENsYXNzID0gInVpLSIgKyBjaGVja2VkU3RhdGUgKyBhY3RpdmVCdG4sCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyB1bmNoZWNrZWRTdGF0ZSwKCQkJY2hlY2tlZGljb24gPSAidWktaWNvbi0iICsgY2hlY2tlZFN0YXRlLAoJCQl1bmNoZWNrZWRpY29uID0gInVpLWljb24tIiArIHVuY2hlY2tlZFN0YXRlOwoKCQlpZiAoIGlucHV0dHlwZSAhPT0gImNoZWNrYm94IiAmJiBpbnB1dHR5cGUgIT09ICJyYWRpbyIgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEV4cG9zZSBmb3Igb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWxhYmVsOiBsYWJlbCwKCQkJaW5wdXR0eXBlOiBpbnB1dHR5cGUsCgkJCWNoZWNrZWRDbGFzczogY2hlY2tlZENsYXNzLAoJCQl1bmNoZWNrZWRDbGFzczogdW5jaGVja2VkQ2xhc3MsCgkJCWNoZWNrZWRpY29uOiBjaGVja2VkaWNvbiwKCQkJdW5jaGVja2VkaWNvbjogdW5jaGVja2VkaWNvbgoJCX0pOwoKCQkvLyBJZiB0aGVyZSdzIG5vIHNlbGVjdGVkIHRoZW1lIGNoZWNrIHRoZSBkYXRhIGF0dHIKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQlsYWJlbC5idXR0b25NYXJrdXAoewoJCQl0aGVtZTogby50aGVtZSwKCQkJaWNvbjogaWNvbiwKCQkJc2hhZG93OiBmYWxzZSwKCQkJbWluaTogbWluaSwKCQkJaWNvbnBvczogaWNvbnBvcwoJCX0pOwoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJdmFyIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICd1aS0nICsgaW5wdXR0eXBlOwoKCQlpbnB1dC5hZGQoIGxhYmVsICkud3JhcEFsbCggd3JhcHBlciApOwoKCQlsYWJlbC5iaW5kKHsKCQkJdm1vdXNlb3ZlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAkKCB0aGlzICkucGFyZW50KCkuaXMoICIudWktZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCX0sCgoJCQl2Y2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgoJCQkJaW5wdXQucHJvcCggImNoZWNrZWQiLCBpbnB1dHR5cGUgPT09ICJyYWRpbyIgJiYgdHJ1ZSB8fCAhaW5wdXQucHJvcCggImNoZWNrZWQiICkgKTsKCgkJCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCQkJLy8gaG93IGxhYmVsIGNsaWNrcyBiZWhhdmUgbm9ybWFsbHkgaW4gdGhlIGJyb3dzZXJzCgkJCQkvLyBUT0RPOiBpdCB3b3VsZCBiZSBuaWNlIHRvIGxldCB0aGUgYnJvd3NlcidzIGhhbmRsZSB0aGUgY2xpY2tzIGFuZCBwYXNzIHRoZW0KCQkJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJCQkvLyAgICAgICB3cmFwcGVyIGVsZW1lbnQgbGV2ZWwKCQkJCWlucHV0LnRyaWdnZXJIYW5kbGVyKCAnY2xpY2snICk7CgoJCQkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCQkJLy8gYnV0dG9ucywgYnV0IHdpbGwgbm90IGZvciBjaGVja2JveGVzLiBjbGVhcmluZyB0aGUgY2hlY2tlZCBzdGF0dXMKCQkJCS8vIG9mIG90aGVyIHJhZGlvcyBlbnN1cmVzIHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlIGlzIGFwcGxpZWQgcHJvcGVybHkKCQkJCXNlbGYuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0pOwoKCQlpbnB1dAoJCQkuYmluZCh7CgkJCQl2bW91c2Vkb3duOiBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLl9jYWNoZVZhbHMoKTsKCQkJCX0sCgoJCQkJdmNsaWNrOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJCQkJaWYgKCAkdGhpcy5pcyggIjpjaGVja2VkIiApICkgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCB0cnVlKTsKCQkJCQkJc2VsZi5fZ2V0SW5wdXRTZXQoKS5ub3QoJHRoaXMpLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQl9LAoKCQkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCQlsYWJlbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfSwKCgkJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCQlsYWJlbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfQoJCQl9KTsKCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9jYWNoZVZhbHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaChmdW5jdGlvbigpIHsKCQkJJCh0aGlzKS5qcW1EYXRhKCAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy9yZXR1cm5zIGVpdGhlciBhIHNldCBvZiByYWRpb3Mgd2l0aCB0aGUgc2FtZSBuYW1lIGF0dHJpYnV0ZSwgb3IgYSBzaW5nbGUgY2hlY2tib3gKCV9nZXRJbnB1dFNldDogZnVuY3Rpb24oKXsKCQlpZih0aGlzLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IikgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJCX0KCgkJcmV0dXJuIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSxmaWVsZHNldCw6anFtRGF0YShyb2xlPSdwYWdlJykiICkKCQkJLmZpbmQoICJpbnB1dFtuYW1lPSciKyB0aGlzLmVsZW1lbnRbMF0ubmFtZSArIiddW3R5cGU9JyIrIHRoaXMuaW5wdXR0eXBlICsiJ10iICk7Cgl9LAoKCV91cGRhdGVBbGw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJaWYgKCB0aGlzLmNoZWNrZWQgfHwgc2VsZi5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudFswXSwKCQkJbGFiZWwgPSB0aGlzLmxhYmVsLAoJCQlpY29uID0gbGFiZWwuZmluZCggIi51aS1pY29uIiApOwoKCQlpZiAoIGlucHV0LmNoZWNrZWQgKSB7CgkJCWxhYmVsLmFkZENsYXNzKCB0aGlzLmNoZWNrZWRDbGFzcyApLnJlbW92ZUNsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICk7CgkJCWljb24uYWRkQ2xhc3MoIHRoaXMuY2hlY2tlZGljb24gKS5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRpY29uICk7CgkJfSBlbHNlIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIHRoaXMuY2hlY2tlZENsYXNzICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQkJaWNvbi5yZW1vdmVDbGFzcyggdGhpcy5jaGVja2VkaWNvbiApLmFkZENsYXNzKCB0aGlzLnVuY2hlY2tlZGljb24gKTsKCQl9CgoJCWlmICggaW5wdXQuZGlzYWJsZWQgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuZW5hYmxlKCk7CgkJfQoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdHJ1ZSApLnBhcmVudCgpLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIGZhbHNlICkucGFyZW50KCkucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuY2hlY2tib3hyYWRpby5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiB0cnVlLAoJCWluaXRTZWxlY3RvcjogImJ1dHRvbiwgW3R5cGU9J2J1dHRvbiddLCBbdHlwZT0nc3VibWl0J10sIFt0eXBlPSdyZXNldCddLCBbdHlwZT0naW1hZ2UnXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkkYnV0dG9uLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQl0eXBlLAoJCQluYW1lLAoJCQlpbmxpbmUgPSBvLmlubGluZSB8fCAkZWwuanFtRGF0YSggImlubGluZSIgKSwKCQkJbWluaSA9IG8ubWluaSB8fCAkZWwuanFtRGF0YSggIm1pbmkiICksCgkJCWNsYXNzZXMgPSAiIiwKCQkJJGJ1dHRvblBsYWNlaG9sZGVyOwoKCQkvLyBpZiB0aGlzIGlzIGEgbGluaywgY2hlY2sgaWYgaXQncyBiZWVuIGVuaGFuY2VkIGFuZCwgaWYgbm90LCB1c2UgdGhlIHJpZ2h0IGZ1bmN0aW9uCgkJaWYoICRlbFsgMCBdLnRhZ05hbWUgPT09ICJBIiApIHsKCSAJIAkhJGVsLmhhc0NsYXNzKCAidWktYnRuIiApICYmICRlbC5idXR0b25NYXJrdXAoKTsKCSAJIAlyZXR1cm47CiAJIAl9CgoJCS8vIGdldCB0aGUgaW5oZXJpdGVkIHRoZW1lCgkJLy8gVE9ETyBjZW50cmFsaXplIGZvciBhbGwgd2lkZ2V0cwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYoICEhfiRlbFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmKCAgISF+JGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1yaWdodCI7CgkJfQoKCQlpZiggICRlbC5hdHRyKCAidHlwZSIgKSA9PT0gInN1Ym1pdCIgfHwgJGVsLmF0dHIoICJ0eXBlIiApID09PSAicmVzZXQiICkgewoJCQljbGFzc2VzID8gY2xhc3NlcyArPSAiIHVpLXN1Ym1pdCIgOiAgY2xhc3NlcyA9ICJ1aS1zdWJtaXQiOwoJCX0KCQkKCQkkKCAibGFiZWxbZm9yPSciICsgJGVsLmF0dHIoICJpZCIgKSArICInXSIgKS5hZGRDbGFzcyggInVpLXN1Ym1pdCIgKTsKCgkJLy8gQWRkIEFSSUEgcm9sZQoJCXRoaXMuYnV0dG9uID0gJCggIjxkaXY+PC9kaXY+IiApCgkJCS50ZXh0KCAkZWwudGV4dCgpIHx8ICRlbC52YWwoKSApCgkJCS5pbnNlcnRCZWZvcmUoICRlbCApCgkJCS5idXR0b25NYXJrdXAoewoJCQkJdGhlbWU6IG8udGhlbWUsCgkJCQlpY29uOiBvLmljb24sCgkJCQlpY29ucG9zOiBvLmljb25wb3MsCgkJCQlpbmxpbmU6IGlubGluZSwKCQkJCWNvcm5lcnM6IG8uY29ybmVycywKCQkJCXNoYWRvdzogby5zaGFkb3csCgkJCQlpY29uc2hhZG93OiBvLmljb25zaGFkb3csCgkJCQltaW5pOiBtaW5pCgkJCX0pCgkJCS5hZGRDbGFzcyggY2xhc3NlcyApCgkJCS5hcHBlbmQoICRlbC5hZGRDbGFzcyggInVpLWJ0bi1oaWRkZW4iICkgKTsKCiAgICAgICAgJGJ1dHRvbiA9IHRoaXMuYnV0dG9uOwoJCXR5cGUgPSAkZWwuYXR0ciggInR5cGUiICk7CgkJbmFtZSA9ICRlbC5hdHRyKCAibmFtZSIgKTsKCgkJLy8gQWRkIGhpZGRlbiBpbnB1dCBkdXJpbmcgc3VibWl0IGlmIGlucHV0IHR5cGU9InN1Ym1pdCIgaGFzIGEgbmFtZS4KCQlpZiAoIHR5cGUgIT09ICJidXR0b24iICYmIHR5cGUgIT09ICJyZXNldCIgJiYgbmFtZSApIHsKCQkJCSRlbC5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCQkJLy8gQWRkIGhpZGRlbiBpbnB1dCBpZiBpdCBkb2Vzbid0IGFscmVhZHkgZXhpc3QuCgkJCQkJaWYoICRidXR0b25QbGFjZWhvbGRlciA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkkYnV0dG9uUGxhY2Vob2xkZXIgPSAkKCAiPGlucHV0PiIsIHsKCQkJCQkJCXR5cGU6ICJoaWRkZW4iLAoJCQkJCQkJbmFtZTogJGVsLmF0dHIoICJuYW1lIiApLAoJCQkJCQkJdmFsdWU6ICRlbC5hdHRyKCAidmFsdWUiICkKCQkJCQkJfSkuaW5zZXJ0QmVmb3JlKCAkZWwgKTsKCgkJCQkJCS8vIEJpbmQgdG8gZG9jIHRvIHJlbW92ZSBhZnRlciBzdWJtaXQgaGFuZGxpbmcKCQkJCQkJJCggZG9jdW1lbnQgKS5vbmUoInN1Ym1pdCIsIGZ1bmN0aW9uKCl7CgkJCQkJCQkkYnV0dG9uUGxhY2Vob2xkZXIucmVtb3ZlKCk7CgoJCQkJCQkJLy8gcmVzZXQgdGhlIGxvY2FsIHZhciBzbyB0aGF0IHRoZSBoaWRkZW4gaW5wdXQKCQkJCQkJCS8vIHdpbGwgYmUgcmUtYWRkZWQgb24gc3Vic2VxdWVudCBjbGlja3MKCQkJCQkJCSRidXR0b25QbGFjZWhvbGRlciA9IHVuZGVmaW5lZDsKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSk7CgkJfQoKICAgICAgICAkZWwuYmluZCh7CiAgICAgICAgICAgIGZvY3VzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRidXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGJsdXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJGJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCBmYWxzZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJdGhpcy5idXR0b24uYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCWlmICggJGVsLnByb3AoImRpc2FibGVkIikgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuZW5hYmxlKCk7CgkJfQoKCQkvLyBHcmFiIHRoZSBidXR0b24ncyB0ZXh0IGVsZW1lbnQgZnJvbSBpdHMgaW1wbGVtZW50YXRpb24taW5kZXBlbmRlbnQgZGF0YSBpdGVtCgkJJCggdGhpcy5idXR0b24uZGF0YSggJ2J1dHRvbkVsZW1lbnRzJyApLnRleHQgKS50ZXh0KCAkZWwudGV4dCgpIHx8ICRlbC52YWwoKSApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5idXR0b24ucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmNvbnRyb2xncm91cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJZnVuY3Rpb24gZmxpcENsYXNzZXMoIGVscywgZmxDb3JuZXJzICApIHsKCQllbHMucmVtb3ZlQ2xhc3MoICJ1aS1idG4tY29ybmVyLWFsbCB1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20gdWktY29ybmVyLWxlZnQgdWktY29ybmVyLXJpZ2h0IHVpLWNvbnRyb2xncm91cC1sYXN0IHVpLXNoYWRvdyIgKQoJCQkuZXEoIDAgKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAwIF0gKQoJCQkuZW5kKCkKCQkJLmxhc3QoKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAxIF0gKS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC1sYXN0IiApOwoJfQoKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCQkJZGlyZWN0aW9uOiAkZWwuanFtRGF0YSggInR5cGUiICkgfHwgInZlcnRpY2FsIiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJZXhjbHVkZUludmlzaWJsZTogdHJ1ZSwKCQkJCQkJbWluaTogJGVsLmpxbURhdGEoICJtaW5pIiApCgkJCQkJfSwgb3B0aW9ucyApLAoJCQlncm91cGxlZ2VuZCA9ICRlbC5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJZ3JvdXBoZWFkaW5nID0gJGVsLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbCIgKSwKCQkJZ3JvdXBjb250cm9scyA9ICRlbC5jaGlsZHJlbiggIi51aS1jb250cm9sZ3JvdXAtY29udHJvbHMiICksCgkJCWZsQ29ybmVycyA9IG8uZGlyZWN0aW9uID09PSAiaG9yaXpvbnRhbCIgPyBbICJ1aS1jb3JuZXItbGVmdCIsICJ1aS1jb3JuZXItcmlnaHQiIF0gOiBbICJ1aS1jb3JuZXItdG9wIiwgInVpLWNvcm5lci1ib3R0b20iIF0sCgkJCXR5cGUgPSAkZWwuZmluZCggImlucHV0IiApLmZpcnN0KCkuYXR0ciggInR5cGUiICk7CgoJCS8vIEZpcnN0IHVud3JhcCB0aGUgY29udHJvbHMgaWYgdGhlIGNvbnRyb2xncm91cCB3YXMgYWxyZWFkeSBlbmhhbmNlZAoJCWlmICggZ3JvdXBjb250cm9scy5sZW5ndGggKSB7CgkJCWdyb3VwY29udHJvbHMuY29udGVudHMoKS51bndyYXAoKTsKCQl9CgkJJGVsLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyc+PC9kaXY+IiApOwoKCQlpZiAoIGdyb3VwbGVnZW5kLmxlbmd0aCApIHsKCQkJLy8gUmVwbGFjZSBsZWdlbmQgd2l0aCBtb3JlIHN0eWxhYmxlIHJlcGxhY2VtZW50IGRpdgoJCQkkKCAiPGRpdiByb2xlPSdoZWFkaW5nJyBjbGFzcz0ndWktY29udHJvbGdyb3VwLWxhYmVsJz4iICsgZ3JvdXBsZWdlbmQuaHRtbCgpICsgIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoICRlbC5jaGlsZHJlbiggMCApICk7CgkJCWdyb3VwbGVnZW5kLnJlbW92ZSgpOwoJCX0gZWxzZSBpZiAoIGdyb3VwaGVhZGluZy5sZW5ndGggKSB7CgkJCS8vIEp1c3QgbW92ZSB0aGUgaGVhZGluZyBpZiB0aGUgY29udHJvbGdyb3VwIHdhcyBhbHJlYWR5IGVuaGFuY2VkCgkJCSRlbC5wcmVwZW5kKCBncm91cGhlYWRpbmcgKTsKCQl9CgoJCSRlbC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktY29udHJvbGdyb3VwIHVpLWNvbnRyb2xncm91cC0iICsgby5kaXJlY3Rpb24gKTsKCgkJZmxpcENsYXNzZXMoICRlbC5maW5kKCAiLnVpLWJ0biIgKyAoIG8uZXhjbHVkZUludmlzaWJsZSA/ICI6dmlzaWJsZSIgOiAiIiApICkubm90KCcudWktc2xpZGVyLWhhbmRsZScpLCBmbENvcm5lcnMgKTsKCQlmbGlwQ2xhc3NlcyggJGVsLmZpbmQoICIudWktYnRuLWlubmVyIiApLCBmbENvcm5lcnMgKTsKCgkJaWYgKCBvLnNoYWRvdyApIHsKCQkJJGVsLmFkZENsYXNzKCAidWktc2hhZG93IiApOwoJCX0KCgkJaWYgKCBvLm1pbmkgKSB7CgkJCSRlbC5hZGRDbGFzcyggInVpLW1pbmkiICk7CgkJfQoKCX0pOwp9OwoKLy8gVGhlIHBhZ2VjcmVhdGUgaGFuZGxlciBmb3IgY29udHJvbGdyb3VwIGlzIGluIGpxdWVyeS5tb2JpbGUuaW5pdCBiZWNhdXNlIG9mIHRoZSBzb2Z0LWRlcGVuZGVuY3kgb24gdGhlIHdyYXBwZWQgd2lkZ2V0cwoKfSkoalF1ZXJ5KTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoKCS8vbGlua3Mgd2l0aGluIGNvbnRlbnQgYXJlYXMsIHRlc3RzIGluY2x1ZGVkIHdpdGggcGFnZQoJJCggZS50YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLm5vdCggIi51aS1idG4sIC51aS1saW5rLWluaGVyaXQsIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmFkZENsYXNzKCAidWktbGluayIgKTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKCiggZnVuY3Rpb24oICQgKSB7Cgl2YXIJbWV0YSA9ICQoICJtZXRhW25hbWU9dmlld3BvcnRdIiApLAogICAgICAgIGluaXRpYWxDb250ZW50ID0gbWV0YS5hdHRyKCAiY29udGVudCIgKSwKICAgICAgICBkaXNhYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xLCB1c2VyLXNjYWxhYmxlPW5vIiwKICAgICAgICBlbmFibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEwLCB1c2VyLXNjYWxhYmxlPXllcyIsCgkJZGlzYWJsZWRJbml0aWFsbHkgPSAvKHVzZXItc2NhbGFibGVbXHNdKj1bXHNdKm5vKXwobWF4aW11bS1zY2FsZVtcc10qPVtcc10qMSlbJCxcc10vLnRlc3QoIGluaXRpYWxDb250ZW50ICk7CgkKCSQubW9iaWxlLnpvb20gPSAkLmV4dGVuZCgge30sIHsKCQllbmFibGVkOiAhZGlzYWJsZWRJbml0aWFsbHksCgkJbG9ja2VkOiBmYWxzZSwKCQlkaXNhYmxlOiBmdW5jdGlvbiggbG9jayApIHsKCQkJaWYoICFkaXNhYmxlZEluaXRpYWxseSAmJiAhJC5tb2JpbGUuem9vbS5sb2NrZWQgKXsKCSAgICAgICAgCW1ldGEuYXR0ciggImNvbnRlbnQiLCBkaXNhYmxlZFpvb20gKTsKCSAgICAgICAgCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IGZhbHNlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBsb2NrIHx8IGZhbHNlOwoJCQl9CgkJfSwKCQllbmFibGU6IGZ1bmN0aW9uKCB1bmxvY2sgKSB7CgkJCWlmKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgKCAhJC5tb2JpbGUuem9vbS5sb2NrZWQgfHwgdW5sb2NrID09PSB0cnVlICkgKXsKCQkgICAgICAgIG1ldGEuYXR0ciggImNvbnRlbnQiLCBlbmFibGVkWm9vbSApOwoJCSAgICAgICAgJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gZmFsc2U7CgkJCX0KCQl9LAoJCXJlc3RvcmU6IGZ1bmN0aW9uKCkgewoJCQlpZiggIWRpc2FibGVkSW5pdGlhbGx5ICl7CgkgICAgICAgIAltZXRhLmF0dHIoICJjb250ZW50IiwgaW5pdGlhbENvbnRlbnQgKTsKCSAgICAgICAgCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCX0KCQl9Cgl9KTsKCn0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJbWluaTogZmFsc2UsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSd0ZXh0J10sIGlucHV0W3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSwgaW5wdXRbdHlwZT0nbnVtYmVyJ10sIDpqcW1EYXRhKHR5cGU9J251bWJlcicpLCBpbnB1dFt0eXBlPSdwYXNzd29yZCddLCBpbnB1dFt0eXBlPSdlbWFpbCddLCBpbnB1dFt0eXBlPSd1cmwnXSwgaW5wdXRbdHlwZT0ndGVsJ10sIHRleHRhcmVhLCBpbnB1dFt0eXBlPSd0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGUnXSwgaW5wdXRbdHlwZT0nbW9udGgnXSwgaW5wdXRbdHlwZT0nd2VlayddLCBpbnB1dFt0eXBlPSdkYXRldGltZSddLCBpbnB1dFt0eXBlPSdkYXRldGltZS1sb2NhbCddLCBpbnB1dFt0eXBlPSdjb2xvciddLCBpbnB1dDpub3QoW3R5cGVdKSIsCgkJY2xlYXJTZWFyY2hCdXR0b25UZXh0OiAiY2xlYXIgdGV4dCIsCgkJZGlzYWJsZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXRoZW1lID0gby50aGVtZSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKSwKCQkJdGhlbWVjbGFzcyAgPSAiIHVpLWJvZHktIiArIHRoZW1lLAoJCQltaW5pY2xhc3MgPSBvLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWZvY3VzZWRFbCwgY2xlYXJidG47CgoJCSQoICJsYWJlbFtmb3I9JyIgKyBpbnB1dC5hdHRyKCAiaWQiICkgKyAiJ10iICkuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IiApOwoKCQlmb2N1c2VkRWwgPSBpbnB1dC5hZGRDbGFzcygidWktaW5wdXQtdGV4dCB1aS1ib2R5LSIrIHRoZW1lICk7CgoJCS8vIFhYWDogVGVtcG9yYXJ5IHdvcmthcm91bmQgZm9yIGlzc3VlIDc4NSAoQXBwbGUgYnVnIDg5MTA1ODkpLgoJCS8vICAgICAgVHVybiBvZmYgYXV0b2NvcnJlY3QgYW5kIGF1dG9jb21wbGV0ZSBvbiBub24taU9TIDUgZGV2aWNlcwoJCS8vICAgICAgc2luY2UgdGhlIHBvcHVwIHRoZXkgdXNlIGNhbid0IGJlIGRpc21pc3NlZCBieSB0aGUgdXNlci4gTm90ZQoJCS8vICAgICAgdGhhdCB3ZSB0ZXN0IGZvciB0aGUgcHJlc2VuY2Ugb2YgdGhlIGZlYXR1cmUgYnkgbG9va2luZyBmb3IKCQkvLyAgICAgIHRoZSBhdXRvY29ycmVjdCBwcm9wZXJ0eSBvbiB0aGUgaW5wdXQgZWxlbWVudC4gV2UgY3VycmVudGx5CgkJLy8gICAgICBoYXZlIG5vIHRlc3QgZm9yIGlPUyA1IG9yIG5ld2VyIHNvIHdlJ3JlIHRlbXBvcmFyaWx5IHVzaW5nCgkJLy8gICAgICB0aGUgdG91Y2hPdmVyZmxvdyBzdXBwb3J0IGZsYWcgZm9yIGpRTSAxLjAuIFllcywgSSBmZWVsIGRpcnR5LiAtIGpibGFzCgkJaWYgKCB0eXBlb2YgaW5wdXRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmICEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb3JyZWN0IiwgIm9mZiIgKTsKCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKTsKCQl9CgoKCQkvLyJzZWFyY2giIGlucHV0IHdpZGdldAoJCWlmICggaW5wdXQuaXMoICJbdHlwZT0nc2VhcmNoJ10sOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgKSB7CgoJCQlmb2N1c2VkRWwgPSBpbnB1dC53cmFwKCAiPGRpdiBjbGFzcz0ndWktaW5wdXQtc2VhcmNoIHVpLXNoYWRvdy1pbnNldCB1aS1idG4tY29ybmVyLWFsbCB1aS1idG4tc2hhZG93IHVpLWljb24tc2VhcmNoZmllbGQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyArICInPjwvZGl2PiIgKS5wYXJlbnQoKTsKCQkJY2xlYXJidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyJyB0aXRsZT0nIiArIG8uY2xlYXJTZWFyY2hCdXR0b25UZXh0ICsgIic+IiArIG8uY2xlYXJTZWFyY2hCdXR0b25UZXh0ICsgIjwvYT4iICkKCQkJCS5iaW5kKCdjbGljaycsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpbnB1dAoJCQkJCQkudmFsKCAiIiApCgkJCQkJCS5mb2N1cygpCgkJCQkJCS50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCWNsZWFyYnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KQoJCQkJLmFwcGVuZFRvKCBmb2N1c2VkRWwgKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJaWNvbjogImRlbGV0ZSIsCgkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQlzaGFkb3c6IHRydWUsCgkJCQkJbWluaTogby5taW5pCgkJCQl9KTsKCgkJCWZ1bmN0aW9uIHRvZ2dsZUNsZWFyKCkgewoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQljbGVhcmJ0bi50b2dnbGVDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIsICFpbnB1dC52YWwoKSApOwoJCQkJfSwgMCk7CgkJCX0KCgkJCXRvZ2dsZUNsZWFyKCk7CgoJCQlpbnB1dC5iaW5kKCdwYXN0ZSBjdXQga2V5dXAgZm9jdXMgY2hhbmdlIGJsdXInLCB0b2dnbGVDbGVhcik7CgoJCX0gZWxzZSB7CgkJCWlucHV0LmFkZENsYXNzKCAidWktY29ybmVyLWFsbCB1aS1zaGFkb3ctaW5zZXQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyApOwoJCX0KCgkJaW5wdXQuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQlmb2N1c2VkRWwuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJsdXIoZnVuY3Rpb24oKXsKCQkJCWZvY3VzZWRFbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQkJLmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQkJaWYoIG8ucHJldmVudEZvY3VzWm9vbSApewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQkJfQoJCQl9KQoJCQkuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCWlmKCBvLnByZXZlbnRGb2N1c1pvb20gKXsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCgkJLy8gQXV0b2dyb3cKCQlpZiAoIGlucHV0LmlzKCAidGV4dGFyZWEiICkgKSB7CgkJCXZhciBleHRyYUxpbmVIZWlnaHQgPSAxNSwKCQkJCWtleXVwVGltZW91dEJ1ZmZlciA9IDEwMCwKCQkJCWtleXVwID0gZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHNjcm9sbEhlaWdodCA9IGlucHV0WyAwIF0uc2Nyb2xsSGVpZ2h0LAoJCQkJCQljbGllbnRIZWlnaHQgPSBpbnB1dFsgMCBdLmNsaWVudEhlaWdodDsKCgkJCQkJaWYgKCBjbGllbnRIZWlnaHQgPCBzY3JvbGxIZWlnaHQgKSB7CgkJCQkJCWlucHV0LmhlaWdodChzY3JvbGxIZWlnaHQgKyBleHRyYUxpbmVIZWlnaHQpOwoJCQkJCX0KCQkJCX0sCgkJCQlrZXl1cFRpbWVvdXQ7CgoJCQlpbnB1dC5rZXl1cChmdW5jdGlvbigpIHsKCQkJCWNsZWFyVGltZW91dCgga2V5dXBUaW1lb3V0ICk7CgkJCQlrZXl1cFRpbWVvdXQgPSBzZXRUaW1lb3V0KCBrZXl1cCwga2V5dXBUaW1lb3V0QnVmZmVyICk7CgkJCX0pOwoKCQkJLy8gYmluZGluZyB0byBwYWdlY2hhbmdlIGhlcmUgZW5zdXJlcyB0aGF0IGZvciBwYWdlcyBsb2FkZWQgdmlhCgkJCS8vIGFqYXggdGhlIGhlaWdodCBpcyByZWNhbGN1bGF0ZWQgd2l0aG91dCB1c2VyIGlucHV0CgkJCSQoIGRvY3VtZW50ICkub25lKCAicGFnZWNoYW5nZSIsIGtleXVwICk7CgoJCQkvLyBJc3N1ZSA1MDk6IHRoZSBicm93c2VyIGlzIG5vdCBwcm92aWRpbmcgc2Nyb2xsSGVpZ2h0IHByb3Blcmx5IHVudGlsIHRoZSBzdHlsZXMgbG9hZAoJCQlpZiAoICQudHJpbSggaW5wdXQudmFsKCkgKSApIHsKCQkJCS8vIGJpbmQgdG8gdGhlIHdpbmRvdyBsb2FkIHRvIG1ha2Ugc3VyZSB0aGUgaGVpZ2h0IGlzIGNhbGN1bGF0ZWQgYmFzZWQgb24gQk9USAoJCQkJLy8gdGhlIERPTSBhbmQgQ1NTCgkJCQkkKCB3aW5kb3cgKS5sb2FkKCBrZXl1cCApOwoJCQl9CgkJfQoJCWlmICggaW5wdXQuYXR0ciggImRpc2FibGVkIiApICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCl7CgoJCXZhciAkZWw7CgkJaWYgKCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApLmlzKCAiW3R5cGU9J3NlYXJjaCddLDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApICkgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgkJfSBlbHNlIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50OwoJCX0gCgkJJGVsLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJCQkKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpewoKCQl2YXIgJGVsOwoJCWlmICggdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICkuaXMoICJbdHlwZT0nc2VhcmNoJ10sOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgKSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsKCQl9IGVsc2UgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgkJfSAKCQkkZWwucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCQkKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUudGV4dGlucHV0LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyID0gZmFsc2U7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyID0gIkZpbHRlciBpdGVtcy4uLiI7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclRoZW1lID0gImMiOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCB0ZXh0LCBzZWFyY2hWYWx1ZSApewoJcmV0dXJuIHRleHQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCBzZWFyY2hWYWx1ZSApID09PSAtMTsKfTsKCiQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICJ1bCwgb2wiLCAibGlzdHZpZXdjcmVhdGUiLCBmdW5jdGlvbigpIHsKCgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggImxpc3R2aWV3IiApOwoKCWlmICggIWxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyICkgewoJCXJldHVybjsKCX0KCgl2YXIgd3JhcHBlciA9ICQoICI8Zm9ybT4iLCB7CgkJCSJjbGFzcyI6ICJ1aS1saXN0dmlldy1maWx0ZXIgdWktYmFyLSIgKyBsaXN0dmlldy5vcHRpb25zLmZpbHRlclRoZW1lLAoJCQkicm9sZSI6ICJzZWFyY2giCgkJfSksCgkJc2VhcmNoID0gJCggIjxpbnB1dD4iLCB7CgkJCXBsYWNlaG9sZGVyOiBsaXN0dmlldy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyCgkJfSkKCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGUiLCAic2VhcmNoIiApCgkJLmpxbURhdGEoICJsYXN0dmFsIiwgIiIgKQoJCS5iaW5kKCAia2V5dXAgY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpLAoJCQkJdmFsID0gdGhpcy52YWx1ZS50b0xvd2VyQ2FzZSgpLAoJCQkJbGlzdEl0ZW1zID0gbnVsbCwKCQkJCWxhc3R2YWwgPSAkdGhpcy5qcW1EYXRhKCAibGFzdHZhbCIgKSArICIiLAoJCQkJY2hpbGRJdGVtcyA9IGZhbHNlLAoJCQkJaXRlbXRleHQgPSAiIiwKCQkJCWl0ZW07CgoJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCSR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiAsIHZhbCApOwoJCQlpZiAoIHZhbC5sZW5ndGggPCBsYXN0dmFsLmxlbmd0aCB8fCB2YWwuaW5kZXhPZihsYXN0dmFsKSAhPT0gMCApIHsKCgkJCQkvLyBSZW1vdmVkIGNoYXJzIG9yIHBhc3RlZCBzb21ldGhpbmcgdG90YWxseSBkaWZmZXJlbnQsIGNoZWNrIGFsbCBpdGVtcwoJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbigpOwoJCQl9IGVsc2UgewoKCQkJCS8vIE9ubHkgY2hhcnMgYWRkZWQsIG5vdCByZW1vdmVkLCBvbmx5IHVzZSB2aXNpYmxlIHN1YnNldAoJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbiggIjpub3QoLnVpLXNjcmVlbi1oaWRkZW4pIiApOwoJCQl9CgoJCQlpZiAoIHZhbCApIHsKCgkJCQkvLyBUaGlzIGhhbmRsZXMgaGlkaW5nIHJlZ3VsYXIgcm93cyB3aXRob3V0IHRoZSB0ZXh0IHdlIHNlYXJjaCBmb3IKCQkJCS8vIGFuZCBhbnkgbGlzdCBkaXZpZGVycyB3aXRob3V0IHJlZ3VsYXIgcm93cyBzaG93biB1bmRlciBpdAoKCQkJCWZvciAoIHZhciBpID0gbGlzdEl0ZW1zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoJCQkJCWl0ZW0gPSAkKCBsaXN0SXRlbXNbIGkgXSApOwoJCQkJCWl0ZW10ZXh0ID0gaXRlbS5qcW1EYXRhKCAiZmlsdGVydGV4dCIgKSB8fCBpdGVtLnRleHQoKTsKCgkJCQkJaWYgKCBpdGVtLmlzKCAibGk6anFtRGF0YShyb2xlPWxpc3QtZGl2aWRlcikiICkgKSB7CgoJCQkJCQlpdGVtLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIgLCAhY2hpbGRJdGVtcyApOwoKCQkJCQkJLy8gTmV3IGJ1Y2tldCEKCQkJCQkJY2hpbGRJdGVtcyA9IGZhbHNlOwoKCQkJCQl9IGVsc2UgaWYgKCBsaXN0dmlldy5vcHRpb25zLmZpbHRlckNhbGxiYWNrKCBpdGVtdGV4dCwgdmFsICkgKSB7CgoJCQkJCQkvL21hcmsgdG8gYmUgaGlkZGVuCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsIHRydWUgKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy8gVGhlcmUncyBhIHNob3duIGl0ZW0gaW4gdGhlIGJ1Y2tldAoJCQkJCQljaGlsZEl0ZW1zID0gdHJ1ZTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gU2hvdyBpdGVtcywgbm90IG1hcmtlZCB0byBiZSBoaWRkZW4KCQkJCWxpc3RJdGVtcwoJCQkJCS5maWx0ZXIoICI6bm90KC51aS1maWx0ZXItaGlkZXF1ZXVlKSIgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBmYWxzZSApOwoKCQkJCS8vIEhpZGUgaXRlbXMsIG1hcmtlZCB0byBiZSBoaWRkZW4KCQkJCWxpc3RJdGVtcwoJCQkJCS5maWx0ZXIoICIudWktZmlsdGVyLWhpZGVxdWV1ZSIgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCB0cnVlICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiwgZmFsc2UgKTsKCgkJCX0gZWxzZSB7CgoJCQkJLy9maWx0ZXJ2YWx1ZSBpcyBlbXB0eSA9PiBzaG93IGFsbAoJCQkJbGlzdEl0ZW1zLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgkJCX0KCQkJbGlzdHZpZXcuX3JlZnJlc2hDb3JuZXJzKCk7CgkJfSkKCQkuYXBwZW5kVG8oIHdyYXBwZXIgKQoJCS50ZXh0aW5wdXQoKTsKCglpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuaW5zZXQgKSB7CgkJd3JhcHBlci5hZGRDbGFzcyggInVpLWxpc3R2aWV3LWZpbHRlci1pbnNldCIgKTsKCX0KCgl3cmFwcGVyLmJpbmQoICJzdWJtaXQiLCBmdW5jdGlvbigpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9KQoJLmluc2VydEJlZm9yZSggbGlzdCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCiggZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCXRyYWNrVGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3JhbmdlJ10sIDpqcW1EYXRhKHR5cGU9J3JhbmdlJyksIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gVE9ETzogRWFjaCBvZiB0aGVzZSBzaG91bGQgaGF2ZSBjb21tZW50cyBleHBsYWluIHdoYXQgdGhleSdyZSBmb3IKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggY29udHJvbCwgImMiICksCgoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCBwYXJlbnRUaGVtZSwKCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgoJCQlzZWxlY3RDbGFzcyA9ICggY1R5cGUgPT0gInNlbGVjdCIgKSA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICIiLAoKCQkJY29udHJvbElEID0gY29udHJvbC5hdHRyKCAiaWQiICksCgoJCQkkbGFiZWwgPSAkKCAiW2Zvcj0nIiArIGNvbnRyb2xJRCArICInXSIgKSwKCgkJCWxhYmVsSUQgPSAkbGFiZWwuYXR0ciggImlkIiApIHx8IGNvbnRyb2xJRCArICItbGFiZWwiLAoKCQkJbGFiZWwgPSAkbGFiZWwuYXR0ciggImlkIiwgbGFiZWxJRCApLAoKCQkJdmFsID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIGNUeXBlID09ICJpbnB1dCIgID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9LAoKCQkJbWluID0gIGNUeXBlID09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgoJCQltYXggPSAgY1R5cGUgPT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aC0xLAoKCQkJc3RlcCA9IHdpbmRvdy5wYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApIHx8IDEgKSwKCgkJCWlubGluZUNsYXNzID0gKCB0aGlzLm9wdGlvbnMuaW5saW5lIHx8IGNvbnRyb2wuanFtRGF0YSgiaW5saW5lIikgPT0gdHJ1ZSApID8gIiB1aS1zbGlkZXItaW5saW5lIiA6ICIiLAoKCQkJbWluaUNsYXNzID0gKCB0aGlzLm9wdGlvbnMubWluaSB8fCBjb250cm9sLmpxbURhdGEoIm1pbmkiKSApID8gIiB1aS1zbGlkZXItbWluaSIgOiAiIiwKCgoJCQlkb21IYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKCQkJc2xpZGVyID0gJCggZG9tU2xpZGVyICksCgoJCQl2YWx1ZWJnID0gY29udHJvbC5qcW1EYXRhKCJoaWdobGlnaHQiKSAmJiBjVHlwZSAhPSAic2VsZWN0IiA/IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQkJYmcuY2xhc3NOYW1lID0gJ3VpLXNsaWRlci1iZyAnICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKyAnIHVpLWJ0bi1jb3JuZXItYWxsJzsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0pKCkgOiBmYWxzZSwKCgkJCW9wdGlvbnM7CgoJCXRoaXMuX3R5cGUgPSBjVHlwZTsKCgkJZG9tSGFuZGxlLnNldEF0dHJpYnV0ZSggJ2hyZWYnLCAiIyIgKTsKCQlkb21TbGlkZXIuc2V0QXR0cmlidXRlKCdyb2xlJywnYXBwbGljYXRpb24nKTsKCQlkb21TbGlkZXIuY2xhc3NOYW1lID0gWyd1aS1zbGlkZXIgJyxzZWxlY3RDbGFzcywiIHVpLWJ0bi1kb3duLSIsdHJhY2tUaGVtZSwnIHVpLWJ0bi1jb3JuZXItYWxsJywgaW5saW5lQ2xhc3MsIG1pbmlDbGFzc10uam9pbigiIik7CgkJZG9tSGFuZGxlLmNsYXNzTmFtZSA9ICd1aS1zbGlkZXItaGFuZGxlJzsKCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoZG9tSGFuZGxlKTsKCgkJaGFuZGxlLmJ1dHRvbk1hcmt1cCh7IGNvcm5lcnM6IHRydWUsIHRoZW1lOiB0aGVtZSwgc2hhZG93OiB0cnVlIH0pCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAic2xpZGVyIiwKCQkJCQkiYXJpYS12YWx1ZW1pbiI6IG1pbiwKCQkJCQkiYXJpYS12YWx1ZW1heCI6IG1heCwKCQkJCQkiYXJpYS12YWx1ZW5vdyI6IHZhbCgpLAoJCQkJCSJhcmlhLXZhbHVldGV4dCI6IHZhbCgpLAoJCQkJCSJ0aXRsZSI6IHZhbCgpLAoJCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBsYWJlbElECgkJCQl9KTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJc2xpZGVyOiBzbGlkZXIsCgkJCWhhbmRsZTogaGFuZGxlLAoJCQl2YWx1ZWJnOiB2YWx1ZWJnLAoJCQlkcmFnZ2luZzogZmFsc2UsCgkJCWJlZm9yZVN0YXJ0OiBudWxsLAoJCQl1c2VyTW9kaWZpZWQ6IGZhbHNlLAoJCQltb3VzZU1vdmVkOiBmYWxzZQoJCX0pOwoKCQlpZiAoIGNUeXBlID09ICJzZWxlY3QiICkgewoJCQl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICd1aS1zbGlkZXItaW5uZXJvZmZzZXQnOwoKCQkJZm9yKHZhciBqID0gMCxsZW5ndGggPSBkb21TbGlkZXIuY2hpbGROb2Rlcy5sZW5ndGg7aiA8IGxlbmd0aDtqKyspewoJCQkJd3JhcHBlci5hcHBlbmRDaGlsZChkb21TbGlkZXIuY2hpbGROb2Rlc1tqXSk7CgkJCX0KCgkJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCh3cmFwcGVyKTsKCgkJCS8vIHNsaWRlci53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXItaW5uZXJvZmZzZXQnPjwvZGl2PiIgKTsKCgkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJb3B0aW9ucyA9IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCgkJCWZvcih2YXIgaSA9IDAsIG9wdGlvbnNDb3VudCA9IG9wdGlvbnMubGVuZ3RoOyBpIDwgb3B0aW9uc0NvdW50OyBpKyspewoJCQkJdmFyIHNpZGUgPSAhaSA/ICJiIjoiYSIsCgkJCQkJc2xpZGVyVGhlbWUgPSAhaSA/ICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgOiggIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKSwKCQkJCQlzbGlkZXJMYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAoJCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKCgkJCQlzbGlkZXJJbWcuY2xhc3NOYW1lID0gWyd1aS1zbGlkZXItbGFiZWwgdWktc2xpZGVyLWxhYmVsLScsc2lkZSxzbGlkZXJUaGVtZSwiIHVpLWJ0bi1jb3JuZXItYWxsIl0uam9pbigiIik7CgkJCQlzbGlkZXJJbWcuc2V0QXR0cmlidXRlKCdyb2xlJywnaW1nJyk7CgkJCQlzbGlkZXJJbWcuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUob3B0aW9uc1tpXS5pbm5lckhUTUwpKTsKCQkJCSQoc2xpZGVySW1nKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9CgoJCQlzZWxmLl9sYWJlbHMgPSAkKCAiLnVpLXNsaWRlci1sYWJlbCIsIHNsaWRlciApOwoKCQl9CgoJCWxhYmVsLmFkZENsYXNzKCAidWktc2xpZGVyIiApOwoKCQkvLyBtb25pdG9yIHRoZSBpbnB1dCBmb3IgdXBkYXRlZCB2YWx1ZXMKCQljb250cm9sLmFkZENsYXNzKCBjVHlwZSA9PT0gImlucHV0IiA/ICJ1aS1zbGlkZXItaW5wdXQiIDogInVpLXNsaWRlci1zd2l0Y2giICkKCQkJLmNoYW5nZSggZnVuY3Rpb24oKSB7CgkJCQkvLyBpZiB0aGUgdXNlciBkcmFnZ2VkIHRoZSBoYW5kbGUsIHRoZSAiY2hhbmdlIiBldmVudCB3YXMgdHJpZ2dlcmVkIGZyb20gaW5zaWRlIHJlZnJlc2goKTsgZG9uJ3QgY2FsbCByZWZyZXNoKCkgYWdhaW4KCQkJCWlmICghc2VsZi5tb3VzZU1vdmVkKSB7CgkJCQkJc2VsZi5yZWZyZXNoKCB2YWwoKSwgdHJ1ZSApOwoJCQkJfQoJCQl9KQoJCQkua2V5dXAoIGZ1bmN0aW9uKCkgeyAvLyBuZWNlc3Nhcnk/CgkJCQlzZWxmLnJlZnJlc2goIHZhbCgpLCB0cnVlLCB0cnVlICk7CgkJCX0pCgkJCS5ibHVyKCBmdW5jdGlvbigpIHsKCQkJCXNlbGYucmVmcmVzaCggdmFsKCksIHRydWUgKTsKCQkJfSk7CgoJCS8vIHByZXZlbnQgc2NyZWVuIGRyYWcgd2hlbiBzbGlkZXIgYWN0aXZhdGVkCgkJJCggZG9jdW1lbnQgKS5iaW5kKCAidm1vdXNlbW92ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHNlbGYuZHJhZ2dpbmcgJiYgIXNlbGYub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCS8vIHNlbGYubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJc2VsZi5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IiApIHsKCQkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSBpbiBzeW5jIHdpdGggdGhlIG1vdXNlCgkJCQkJaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCgkJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgc2VsZi51c2VyTW9kaWZpZWQKCQkJCXNlbGYudXNlck1vZGlmaWVkID0gc2VsZi5iZWZvcmVTdGFydCAhPT0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7CgoJCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJCS8vIHJhbmdlL251bWJlciBpbnB1dHMgZG9lc24ndCB0cmlnZ2VyIGEgY2hhbmdlIHVudGlsIHRoZSBmaWVsZCBpcwoJCS8vIGJsdXJyZWQuIEhlcmUgd2UgY2hlY2sgdGhpZiB0aGUgdmFsdWUgaGFzIGNoYW5nZWQgYW5kIHJlZnJlc2gKCQljb250cm9sLmJpbmQoICJ2bW91c2V1cCIsICQucHJveHkoIHNlbGYuX2NoZWNrZWRSZWZyZXNoLCBzZWxmKSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJc2VsZi5kcmFnZ2luZyA9IHRydWU7CgkJCXNlbGYudXNlck1vZGlmaWVkID0gZmFsc2U7CgkJCXNlbGYubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIgKSB7CgkJCQlzZWxmLmJlZm9yZVN0YXJ0ID0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgoJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9KQoJCS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJc2xpZGVyLmFkZCggZG9jdW1lbnQgKQoJCQkuYmluZCggInZtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuZHJhZ2dpbmcgKSB7CgoJCQkJCXNlbGYuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIpIHsKCgkJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJCQkJaWYgKCBzZWxmLm1vdXNlTW92ZWQgKSB7CgoJCQkJCQkJLy8gdGhpcyBpcyBhIGRyYWcsIGNoYW5nZSB0aGUgdmFsdWUgb25seSBpZiB1c2VyIGRyYWdnZWQgZW5vdWdoCgkJCQkJCQlpZiAoIHNlbGYudXNlck1vZGlmaWVkICkgewoJCQkJCQkJCXNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCA9PSAwID8gMSA6IDAgKTsKCQkJCQkJCX0KCQkJCQkJCWVsc2UgewoJCQkJCQkJCXNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCApOwoJCQkJCQkJfQoKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJCS8vIHRoaXMgaXMganVzdCBhIGNsaWNrLCBjaGFuZ2UgdGhlIHZhbHVlCgkJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgPT0gMCA/IDEgOiAwICk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlzZWxmLm1vdXNlTW92ZWQgPSBmYWxzZTsKCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9KTsKCgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIE9ubHkgYWRkIGZvY3VzIGNsYXNzIHRvIHRvZ2dsZSBzd2l0Y2gsIHNsaWRlcnMgZ2V0IGl0IGF1dG9tYXRpY2FsbHkgZnJvbSB1aS1idG4KCQlpZiggY1R5cGUgPT0gJ3NlbGVjdCcgKSB7CgkJCXRoaXMuaGFuZGxlLmJpbmQoewoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCXNsaWRlci5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfSwKCgkJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCQlzbGlkZXIucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQl0aGlzLmhhbmRsZS5iaW5kKHsKCQkJLy8gTk9URSBmb3JjZSBmb2N1cyBvbiBoYW5kbGUKCQkJdm1vdXNlZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuZm9jdXMoKTsKCQkJfSwKCgkJCXZjbGljazogZmFsc2UsCgoJCQlrZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl2YXIgaW5kZXggPSB2YWwoKTsKCgkJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gSW4gYWxsIGNhc2VzIHByZXZlbnQgdGhlIGRlZmF1bHQgYW5kIG1hcmsgdGhlIGhhbmRsZSBhcyBhY3RpdmUKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJCQlpZiAoICFzZWxmLl9rZXlTbGlkaW5nICkgewoJCQkJCQkJc2VsZi5fa2V5U2xpZGluZyA9IHRydWU7CgkJCQkJCQkkKCB0aGlzICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJLy8gbW92ZSB0aGUgc2xpZGVyIGFjY29yZGluZyB0byB0aGUga2V5cHJlc3MKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQkJCXNlbGYucmVmcmVzaCggbWluICk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQkJCXNlbGYucmVmcmVzaCggbWF4ICk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCQkJCXNlbGYucmVmcmVzaCggaW5kZXggKyBzdGVwICk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQkJCXNlbGYucmVmcmVzaCggaW5kZXggLSBzdGVwICk7CgkJCQkJCWJyZWFrOwoJCQkJfQoJCQl9LCAvLyByZW1vdmUgYWN0aXZlIG1hcmsKCgkJCWtleXVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIHNlbGYuX2tleVNsaWRpbmcgKSB7CgkJCQkJc2VsZi5fa2V5U2xpZGluZyA9IGZhbHNlOwoJCQkJCSQoIHRoaXMgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCX0KCQkJfQoJCQl9KTsKCgkJdGhpcy5yZWZyZXNoKHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB0cnVlKTsKCX0sCgoJX2NoZWNrZWRSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiggdGhpcy52YWx1ZSAhPSB0aGlzLl92YWx1ZSgpICl7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSApOwoJCQl0aGlzLnZhbHVlID0gdGhpcy5fdmFsdWUoKTsKCQl9Cgl9LAoKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICB0aGlzLl90eXBlID09PSAiaW5wdXQiID8KCQkJcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LnZhbCgpICkgOiB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIHZhbCwgaXNmcm9tQ29udHJvbCwgcHJldmVudElucHV0VXBkYXRlICkgewoKCQkvLyBOT1RFOiB3ZSBkb24ndCByZXR1cm4gaGVyZSBiZWNhdXNlIHdlIHdhbnQgdG8gc3VwcG9ydCBwcm9ncmFtbWF0aWMKCQkvLyAgICAgICBhbHRlcmF0aW9uIG9mIHRoZSBpbnB1dCB2YWx1ZSwgd2hpY2ggc2hvdWxkIHN0aWxsIHVwZGF0ZSB0aGUgc2xpZGVyCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoJ2Rpc2FibGVkJykpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQl2YXIgY29udHJvbCA9IHRoaXMuZWxlbWVudCwgcGVyY2VudCwKCQkJY1R5cGUgPSBjb250cm9sWzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCW1pbiA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aCAtIDEsCgkJCXN0ZXAgPSAoY1R5cGUgPT09ICJpbnB1dCIgJiYgcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApID4gMCkgPyBwYXJzZUZsb2F0KGNvbnRyb2wuYXR0cigic3RlcCIpKSA6IDE7CgoJCWlmICggdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgKSB7CgkJCXZhciBkYXRhID0gdmFsLAoJCQkJLy8gYSBzbGlnaHQgdG9sZXJhbmNlIGhlbHBlZCBnZXQgdG8gdGhlIGVuZHMgb2YgdGhlIHNsaWRlcgoJCQkJdG9sID0gODsKCQkJaWYgKCAhdGhpcy5kcmFnZ2luZyB8fAoJCQkJCWRhdGEucGFnZVggPCB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0IC0gdG9sIHx8CgkJCQkJZGF0YS5wYWdlWCA+IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgKyB0aGlzLnNsaWRlci53aWR0aCgpICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXBlcmNlbnQgPSBNYXRoLnJvdW5kKCAoICggZGF0YS5wYWdlWCAtIHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKSAqIDEwMCApOwoJCX0gZWxzZSB7CgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCXZhciBuZXd2YWwgPSAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKyBtaW47CgoJCS8vZnJvbSBqUXVlcnkgVUkgc2xpZGVyLCB0aGUgZm9sbG93aW5nIHNvdXJjZSB3aWxsIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXAKCQl2YXIgdmFsTW9kU3RlcCA9ICggbmV3dmFsIC0gbWluICkgJSBzdGVwOwoJCXZhciBhbGlnblZhbHVlID0gbmV3dmFsIC0gdmFsTW9kU3RlcDsKCgkJaWYgKCBNYXRoLmFicyggdmFsTW9kU3RlcCApICogMiA+PSBzdGVwICkgewoJCQlhbGlnblZhbHVlICs9ICggdmFsTW9kU3RlcCA+IDAgKSA/IHN0ZXAgOiAoIC1zdGVwICk7CgkJfQoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZAoJCS8vIHRoZSBmaW5hbCB2YWx1ZSB0byA1IGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbCBwb2ludCAoc2VlIGpRdWVyeVVJOiAjNDEyNCkKCQluZXd2YWwgPSBwYXJzZUZsb2F0KCBhbGlnblZhbHVlLnRvRml4ZWQoNSkgKTsKCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQl0aGlzLmhhbmRsZS5jc3MoICJsZWZ0IiwgcGVyY2VudCArICIlIiApOwoJCXRoaXMuaGFuZGxlLmF0dHIoIHsKCQkJCSJhcmlhLXZhbHVlbm93IjogY1R5cGUgPT09ICJpbnB1dCIgPyBuZXd2YWwgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSwKCQkJCSJhcmlhLXZhbHVldGV4dCI6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpLAoJCQkJdGl0bGU6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpCgkJCX0pOwoJCXRoaXMudmFsdWViZyAmJiB0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgoJCS8vIGRyYWcgdGhlIGxhYmVsIHdpZHRocwoJCWlmICggdGhpcy5fbGFiZWxzICkgewoJCQl2YXIgaGFuZGxlUGVyY2VudCA9IHRoaXMuaGFuZGxlLndpZHRoKCkgLyB0aGlzLnNsaWRlci53aWR0aCgpICogMTAwLAoJCQkJYVBlcmNlbnQgPSBwZXJjZW50ICYmIGhhbmRsZVBlcmNlbnQgKyAoIDEwMCAtIGhhbmRsZVBlcmNlbnQgKSAqIHBlcmNlbnQgLyAxMDAsCgkJCQliUGVyY2VudCA9IHBlcmNlbnQgPT09IDEwMCA/IDAgOiBNYXRoLm1pbiggaGFuZGxlUGVyY2VudCArIDEwMCAtIGFQZXJjZW50LCAxMDAgKTsKCgkJCXRoaXMuX2xhYmVscy5lYWNoKGZ1bmN0aW9uKCl7CgkJCQl2YXIgYWIgPSAkKHRoaXMpLmlzKCAiLnVpLXNsaWRlci1sYWJlbC1hIiApOwoJCQkJJCggdGhpcyApLndpZHRoKCAoIGFiID8gYVBlcmNlbnQgOiBiUGVyY2VudCAgKSArICIlIiApOwoJCQl9KTsKCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFyIHZhbHVlQ2hhbmdlZCA9IGZhbHNlOwoKCQkJLy8gdXBkYXRlIGNvbnRyb2wicyB2YWx1ZQoJCQlpZiAoIGNUeXBlID09PSAiaW5wdXQiICkgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbC52YWwoKSAhPT0gbmV3dmFsOwoJCQkJY29udHJvbC52YWwoIG5ld3ZhbCApOwoJCQl9IGVsc2UgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ID0gbmV3dmFsOwoJCQl9CgkJCWlmICggIWlzZnJvbUNvbnRyb2wgJiYgdmFsdWVDaGFuZ2VkICkgewoJCQkJY29udHJvbC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCXRoaXMuc2xpZGVyLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCBmYWxzZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJdGhpcy5zbGlkZXIuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9Cgp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5zbGlkZXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zZWxlY3RtZW51IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWljb246ICJhcnJvdy1kIiwKCQlpY29ucG9zOiAicmlnaHQiLAoJCWlubGluZTogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpKSIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCiAgX3NlbGVjdE9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7CiAgfSwKCgkvLyBzZXR1cCBpdGVtcyB0aGF0IGFyZSBnZW5lcmFsbHkgbmVjZXNzYXJ5IGZvciBzZWxlY3QgbWVudSBleHRlbnNpb24KCV9wcmVFeHRlbnNpb246IGZ1bmN0aW9uKCl7CgkJdmFyIGNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYoICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gICIgdWktYnRuLWxlZnQiOwoJCX0KCgkJaWYoICAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tcmlnaHQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1yaWdodCI7CgkJfQoKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0IiArIGNsYXNzZXMgKyAiJz4iICk7CgkJdGhpcy5zZWxlY3RJRCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICk7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SUQgKyInXSIgKS5hZGRDbGFzcyggInVpLXNlbGVjdCIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuc2VsZWN0LCAiYyIgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKIAkJLy8gQWxsb3dzIGZvciBleHRlbnNpb24gb2YgdGhlIG5hdGl2ZSBzZWxlY3QgZm9yIGN1c3RvbSBzZWxlY3RzIGFuZCBvdGhlciBwbHVnaW5zCgkJLy8gc2VlIHNlbGVjdC5jdXN0b20gZm9yIGV4YW1wbGUgZXh0ZW5zaW9uCgkJLy8gVE9ETyBleHBsb3JlIHBsdWdpbiByZWdpc3RyYXRpb24KCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlQ3JlYXRlIiApOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJaW5saW5lID0gb3B0aW9ucy5pbmxpbmUgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggImlubGluZSIgKSwKCQkJbWluaSA9IG9wdGlvbnMubWluaSB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAibWluaSIgKSwJCQkKCQkJaWNvbnBvcyA9IG9wdGlvbnMuaWNvbiA/ICggb3B0aW9ucy5pY29ucG9zIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpY29ucG9zIiApICkgOiBmYWxzZSwKCgkJCS8vIElFIHRocm93cyBhbiBleGNlcHRpb24gYXQgb3B0aW9ucy5pdGVtKCkgZnVuY3Rpb24gd2hlbgoJCQkvLyB0aGVyZSBpcyBubyBzZWxlY3RlZCBpdGVtCgkJCS8vIHNlbGVjdCBmaXJzdCBpbiB0aGlzIGNhc2UKCQkJc2VsZWN0ZWRJbmRleCA9IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCA9PSAtMSA/IDAgOiB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgoJCQkvLyBUT0RPIHZhbHVlcyBidXR0b25JZCBhbmQgbWVudUlkIGFyZSB1bmRlZmluZWQgaGVyZQoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmJ1dHRvbk1hcmt1cCggewoJCQkJCXRoZW1lOiBvcHRpb25zLnRoZW1lLAoJCQkJCWljb246IG9wdGlvbnMuaWNvbiwKCQkJCQlpY29ucG9zOiBpY29ucG9zLAoJCQkJCWlubGluZTogaW5saW5lLAoJCQkJCWNvcm5lcnM6IG9wdGlvbnMuY29ybmVycywKCQkJCQlzaGFkb3c6IG9wdGlvbnMuc2hhZG93LAoJCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdywKCQkJCQltaW5pOiBtaW5pCgkJCQl9KTsKCgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJYnV0dG9uLmFkZENsYXNzKCAidWktc2VsZWN0LW5hdGl2ZW9ubHkiICk7CgkJfQkKCgkJLy8gQWRkIGNvdW50ZXIgZm9yIG11bHRpIHNlbGVjdHMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudCA9ICQoICI8c3Bhbj4iICkKCQkJCS5hZGRDbGFzcyggInVpLWxpLWNvdW50IHVpLWJ0bi11cC1jIHVpLWJ0bi1jb3JuZXItYWxsIiApCgkJCQkuaGlkZSgpCgkJCQkuYXBwZW5kVG8oIGJ1dHRvbi5hZGRDbGFzcygndWktbGktaGFzLWNvdW50JykgKTsKCQl9CgoJCS8vIERpc2FibGUgaWYgc3BlY2lmaWVkCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCdkaXNhYmxlZCcpKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gRXZlbnRzIG9uIG5hdGl2ZSBzZWxlY3QKCQl0aGlzLnNlbGVjdC5jaGFuZ2UoIGZ1bmN0aW9uKCkgewoJCQlzZWxmLnJlZnJlc2goKTsKCQl9KTsKCgkJdGhpcy5idWlsZCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLnNlbGVjdAoJCQkuYXBwZW5kVG8oIHNlbGYuYnV0dG9uICkKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBBZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCiAgICAgICAgICAgIC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKICAgICAgICAgICAgfSkKCQkJLmJpbmQoICJmb2N1cyB2bW91c2VvdmVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCQkJfSkKCQkJLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBSZW1vdmUgYWN0aXZlIGNsYXNzIG9uIHNjcm9sbC90b3VjaG1vdmUKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIHZtb3VzZW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW91dCIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCX0pOwoKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQlzZWxmLmJ1dHRvbi5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5sYWJlbC5iaW5kKCAiY2xpY2sgZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuc2VsZWN0LmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5idXR0b24uYmluZCggIm1vdXNldXAiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsJCQkJCgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9LCAwICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewkJCQkKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5pbmRleCggdGhpcyApOwoJCX0pLmdldCgpOwoJfSwKCglzZXRCdXR0b25UZXh0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpLAoJCQl0ZXh0ID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJc3BhbiA9ICQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKSApOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLmh0bWwoZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZWN0ZWQubGVuZ3RoICkgewoJCQkJdGV4dCA9IHNlbGVjdGVkLm1hcChmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gJCggdGhpcyApLnRleHQoKTsKCQkJCX0pLmdldCgpLmpvaW4oICIsICIgKTsKCQkJfSBlbHNlIHsKCQkJCXRleHQgPSBzZWxmLnBsYWNlaG9sZGVyOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4udGV4dCggdGV4dCApCgkJCQkuYWRkQ2xhc3MoIHNlbGYuc2VsZWN0LmF0dHIoImNsYXNzIikgKQoJCQkJLmFkZENsYXNzKCBzZWxlY3RlZC5hdHRyKCJjbGFzcyIpICk7CgkJfSk7Cgl9LAoKCXNldEJ1dHRvbkNvdW50OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCk7CgoJCS8vIG11bHRpcGxlIGNvdW50IGluc2lkZSBidXR0b24KCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudFsgc2VsZWN0ZWQubGVuZ3RoID4gMSA/ICJzaG93IiA6ICJoaWRlIiBdKCkudGV4dCggc2VsZWN0ZWQubGVuZ3RoICk7CgkJfQoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCQl0aGlzLnNldEJ1dHRvbkNvdW50KCk7Cgl9LAoKCS8vIG9wZW4gYW5kIGNsb3NlIHByZXNlcnZlZCBpbiBuYXRpdmUgc2VsZWN0cwoJLy8gdG8gc2ltcGxpZnkgdXNlcnMgY29kZSB3aGVuIGxvb3Bpbmcgb3ZlciBzZWxlY3RzCglvcGVuOiAkLm5vb3AsCgljbG9zZTogJC5ub29wLAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCB0cnVlICk7CgkJdGhpcy5idXR0b24uYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggZmFsc2UgKTsKCQl0aGlzLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5zZWxlY3RtZW51LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKfSkoIGpRdWVyeSApOwoKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgZXh0ZW5kU2VsZWN0ID0gZnVuY3Rpb24oIHdpZGdldCApewoKCQl2YXIgc2VsZWN0ID0gd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQgID0gd2lkZ2V0LnNlbGVjdElELAoJCQlsYWJlbCA9IHdpZGdldC5sYWJlbCwKCQkJdGhpc1BhZ2UgPSB3aWRnZXQuc2VsZWN0LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJc2NyZWVuID0gJCggIjxkaXY+IiwgeyJjbGFzcyI6ICJ1aS1zZWxlY3RtZW51LXNjcmVlbiB1aS1zY3JlZW4taGlkZGVuIn0gKS5hcHBlbmRUbyggdGhpc1BhZ2UgKSwKCQkJc2VsZWN0T3B0aW9ucyA9IHdpZGdldC5fc2VsZWN0T3B0aW9ucygpLAoJCQlpc011bHRpcGxlID0gd2lkZ2V0LmlzTXVsdGlwbGUgPSB3aWRnZXQuc2VsZWN0WyAwIF0ubXVsdGlwbGUsCgkJCWJ1dHRvbklkID0gc2VsZWN0SUQgKyAiLWJ1dHRvbiIsCgkJCW1lbnVJZCA9IHNlbGVjdElEICsgIi1tZW51IiwKCQkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGRhdGEtIiArJC5tb2JpbGUubnMgKyAidGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLnRoZW1lICsiJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgIm92ZXJsYXktdGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArIic+IiArCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgbGFiZWwuZ2V0RW5jb2RlZFRleHQoKSArICI8L2Rpdj4iKwoJCQkJIjwvZGl2PiIrCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkJIjwvZGl2PiIgKSwKCgkJCWxpc3Rib3ggPSAgJCgiPGRpdj4iLCB7ICJjbGFzcyI6ICJ1aS1zZWxlY3RtZW51IHVpLXNlbGVjdG1lbnUtaGlkZGVuIHVpLW92ZXJsYXktc2hhZG93IHVpLWNvcm5lci1hbGwgdWktYm9keS0iICsgd2lkZ2V0Lm9wdGlvbnMub3ZlcmxheVRoZW1lICsgIiAiICsgJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gfSApLmluc2VydEFmdGVyKHNjcmVlbiksCgoJCQlsaXN0ID0gJCggIjx1bD4iLCB7CgkJCQkiY2xhc3MiOiAidWktc2VsZWN0bWVudS1saXN0IiwKCQkJCSJpZCI6IG1lbnVJZCwKCQkJCSJyb2xlIjogImxpc3Rib3giLAoJCQkJImFyaWEtbGFiZWxsZWRieSI6IGJ1dHRvbklkCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIsIHdpZGdldC5vcHRpb25zLnRoZW1lICkuYXBwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlciA9ICQoICI8ZGl2PiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS1oZWFkZXIgdWktYmFyLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZQoJCQl9KS5wcmVwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlclRpdGxlID0gJCggIjxoMT4iLCB7CgkJCQkiY2xhc3MiOiAidWktdGl0bGUiCgkJCX0pLmFwcGVuZFRvKCBoZWFkZXIgKSwKCgkJCW1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZSwKCQkJaGVhZGVyQ2xvc2U7CgoJCWlmKCB3aWRnZXQuaXNNdWx0aXBsZSApIHsKCQkJaGVhZGVyQ2xvc2UgPSAkKCAiPGE+IiwgewoJCQkJInRleHQiOiB3aWRnZXQub3B0aW9ucy5jbG9zZVRleHQsCgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJjbGFzcyI6ICJ1aS1idG4tbGVmdCIKCQkJfSkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3MiLCAibm90ZXh0IiApLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uIiwgImRlbGV0ZSIgKS5hcHBlbmRUbyggaGVhZGVyICkuYnV0dG9uTWFya3VwKCk7CgkJfQoKCQkkLmV4dGVuZCggd2lkZ2V0LCB7CgkJCXNlbGVjdDogd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQ6IHNlbGVjdElELAoJCQlidXR0b25JZDogYnV0dG9uSWQsCgkJCW1lbnVJZDogbWVudUlkLAoJCQl0aGlzUGFnZTogdGhpc1BhZ2UsCgkJCW1lbnVQYWdlOiBtZW51UGFnZSwKCQkJbGFiZWw6IGxhYmVsLAoJCQlzY3JlZW46IHNjcmVlbiwKCQkJc2VsZWN0T3B0aW9uczogc2VsZWN0T3B0aW9ucywKCQkJaXNNdWx0aXBsZTogaXNNdWx0aXBsZSwKCQkJdGhlbWU6IHdpZGdldC5vcHRpb25zLnRoZW1lLAoJCQlsaXN0Ym94OiBsaXN0Ym94LAoJCQlsaXN0OiBsaXN0LAoJCQloZWFkZXI6IGhlYWRlciwKCQkJaGVhZGVyVGl0bGU6IGhlYWRlclRpdGxlLAoJCQloZWFkZXJDbG9zZTogaGVhZGVyQ2xvc2UsCgkJCW1lbnVQYWdlQ29udGVudDogbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlOiBtZW51UGFnZUNsb3NlLAoJCQlwbGFjZWhvbGRlcjogIiIsCgoJCQlidWlsZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJLy8gQ3JlYXRlIGxpc3QgZnJvbSBzZWxlY3QsIHVwZGF0ZSBzdGF0ZQoJCQkJc2VsZi5yZWZyZXNoKCk7CgoJCQkJc2VsZi5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgIi0xIiApLmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQkJCX0pOwoKCQkJCS8vIEJ1dHRvbiBldmVudHMKCQkJCXNlbGYuYnV0dG9uLmJpbmQoICJ2Y2xpY2sga2V5ZG93biIgLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBldmVudC50eXBlID09ICJ2Y2xpY2siIHx8CgkJCQkJCQkgZXZlbnQua2V5Q29kZSAmJiAoIGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRU5URVIgfHwKCQkJCQkJCQkJCQkJCQkJCQlldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFICkgKSB7CgoJCQkJCQlzZWxmLm9wZW4oKTsKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQkJCXNlbGYubGlzdC5hdHRyKCAicm9sZSIsICJsaXN0Ym94IiApCgkJCQkJLmJpbmQoICJmb2N1c2luIiwgZnVuY3Rpb24oIGUgKXsKCQkJCQkJJCggZS50YXJnZXQgKQoJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCQkJCQkudHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgoJCQkJCX0pCgkJCQkJLmJpbmQoICJmb2N1c291dCIsIGZ1bmN0aW9uKCBlICl7CgkJCQkJCSQoIGUudGFyZ2V0ICkKCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkKCQkJCQkJCS50cmlnZ2VyKCAidm1vdXNlb3V0IiApOwoJCQkJCX0pCgkJCQkJLmRlbGVnYXRlKCAibGk6bm90KC51aS1kaXNhYmxlZCwgLnVpLWxpLWRpdmlkZXIpIiwgImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJCQl2YXIgb2xkSW5kZXggPSBzZWxmLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgkJCQkJCQluZXdJbmRleCA9IHNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5pbmRleCggdGhpcyApLAoJCQkJCQkJb3B0aW9uID0gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmVxKCBuZXdJbmRleCApWyAwIF07CgoJCQkJCQkvLyB0b2dnbGUgc2VsZWN0ZWQgc3RhdHVzIG9uIHRoZSB0YWcgZm9yIG11bHRpIHNlbGVjdHMKCQkJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJCQkvLyB0b2dnbGUgY2hlY2tib3ggY2xhc3MgZm9yIG11bHRpcGxlIHNlbGVjdHMKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkkKCB0aGlzICkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiLCAhb3B0aW9uLnNlbGVjdGVkICk7CgkJCQkJCX0KCgkJCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgfHwgb2xkSW5kZXggIT09IG5ld0luZGV4ICkgewoJCQkJCQkJc2VsZi5zZWxlY3QudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCQkJfQoKCQkJCQkJLy8gaGlkZSBjdXN0b20gc2VsZWN0IGZvciBzaW5nbGUgc2VsZWN0cyBvbmx5IC0gb3RoZXJ3aXNlIGZvY3VzIGNsaWNrZWQgaXRlbQoJCQkJCQkvLyBXZSBuZWVkIHRvIGdyYWIgdGhlIGNsaWNrZWQgaXRlbSB0aGUgaGFyZCB3YXksIGJlY2F1c2UgdGhlIGxpc3QgbWF5IGhhdmUgYmVlbiByZWJ1aWx0CgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApLmVxKCBuZXdJbmRleCApCgkJCQkJCQkJLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQl9CgkJCQkJCWVsc2UgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQl9CgoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0pCgkJCQkJLmtleWRvd24oZnVuY3Rpb24oIGV2ZW50ICkgeyAgLy9rZXlib2FyZCBldmVudHMgZm9yIG1lbnUgaXRlbXMKCQkJCQkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLAoJCQkJCQkJbGkgPSB0YXJnZXQuY2xvc2VzdCggImxpIiApLAoJCQkJCQkJcHJldiwgbmV4dDsKCgkJCQkJCS8vIHN3aXRjaCBsb2dpYyBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQkJCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCQkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCQkJCQkgY2FzZSAzODoKCQkJCQkJCXByZXYgPSBsaS5wcmV2KCkubm90KCAiLnVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgoJCQkJCQkJaWYoIHByZXYuaXMoICIudWktbGktZGl2aWRlciIgKSApIHsKCQkJCQkJCQlwcmV2ID0gcHJldi5wcmV2KCk7CgkJCQkJCQl9CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIHByZXZpb3VzIG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggcHJldi5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJcHJldi5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQlicmVhazsKCgkJCQkJCQkvLyBkb3duIG9yIHJpZ2h0IGFycm93IGtleXMKCQkJCQkJIGNhc2UgNDA6CgkJCQkJCQluZXh0ID0gbGkubmV4dCgpOwoKCQkJCQkJCWlmKCBuZXh0LmlzKCAiLnVpLWxpLWRpdmlkZXIiICkgKSB7CgkJCQkJCQkJbmV4dCA9IG5leHQubmV4dCgpOwoJCQkJCQkJfQoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBuZXh0IG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggbmV4dC5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJbmV4dC5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQlicmVhazsKCgkJCQkJCQkvLyBJZiBlbnRlciBvciBzcGFjZSBpcyBwcmVzc2VkLCB0cmlnZ2VyIGNsaWNrCgkJCQkJCSBjYXNlIDEzOgoJCQkJCQkgY2FzZSAzMjoKCQkJCQkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9KTsKCgkJCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkJCS8vIGJ5IHJlbW92aW5nIHRoZSBpbmxpbmUgc3R5bGUgYW5kIGVuc3VyaW5nIHBhZ2UgaW5jbHVzaW9uCgkJCQlzZWxmLm1lbnVQYWdlLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCgkJCQkJLy8gVE9ETyBjZW50cmFsaXplIHBhZ2UgcmVtb3ZhbCBiaW5kaW5nIC8gaGFuZGxpbmcgaW4gdGhlIHBhZ2UgcGx1Z2luLgoJCQkJCS8vIFN1Z2dlc3Rpb24gZnJvbSBAamJsYXMgdG8gZG8gcmVmY291bnRpbmcKCQkJCQkvLwoJCQkJCS8vIFRPRE8gZXh0cmVtZWx5IGNvbmZ1c2luZyBkZXBlbmRlbmN5IG9uIHRoZSBvcGVuIG1ldGhvZCB3aGVyZSB0aGUgcGFnZWhpZGUucmVtb3ZlCgkJCQkJLy8gYmluZGluZ3MgYXJlIHN0cmlwcGVkIHRvIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gZGlzYXBwZWFyaW5nLiBUaGUgd2F5CgkJCQkJLy8gd2UncmUga2VlcGluZyBwYWdlcyBpbiB0aGUgRE9NIHJpZ2h0IG5vdyBzdWNrcwoJCQkJCS8vCgkJCQkJLy8gcmViaW5kIHRoZSBwYWdlIHJlbW92ZSB0aGF0IHdhcyB1bmJvdW5kIGluIHRoZSBvcGVuIGZ1bmN0aW9uCgkJCQkJLy8gdG8gYWxsb3cgZm9yIHRoZSBwYXJlbnQgcGFnZSByZW1vdmFsIGZyb20gYWN0aW9ucyBvdGhlciB0aGFuIHRoZSB1c2UKCQkJCQkvLyBvZiBhIGRpYWxvZyBzaXplZCBjdXN0b20gc2VsZWN0CgkJCQkJLy8KCQkJCQkvLyBkb2luZyB0aGlzIGhlcmUgcHJvdmlkZXMgZm9yIHRoZSBiYWNrIGJ1dHRvbiBvbiB0aGUgY3VzdG9tIHNlbGVjdCBkaWFsb2cKCQkJCQkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUuY2FsbCggc2VsZi50aGlzUGFnZSApOwoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIG9uICJzY3JlZW4iIG92ZXJsYXkKCQkJCXNlbGYuc2NyZWVuLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgoJCQkJLy8gQ2xvc2UgYnV0dG9uIG9uIHNtYWxsIG92ZXJsYXlzCgkJCQlpZiggc2VsZi5pc011bHRpcGxlICl7CgkJCQkJc2VsZi5oZWFkZXJDbG9zZS5jbGljayggZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PSAib3ZlcmxheSIgKSB7CgkJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCX0KCgkJCQkvLyB0cmFjayB0aGlzIGRlcGVuZGVuY3kgc28gdGhhdCB3aGVuIHRoZSBwYXJlbnQgcGFnZQoJCQkJLy8gaXMgcmVtb3ZlZCBvbiBwYWdlaGlkZSBpdCB3aWxsIGFsc28gcmVtb3ZlIHRoZSBtZW51cGFnZQoJCQkJc2VsZi50aGlzUGFnZS5hZGREZXBlbmRlbnRzKCB0aGlzLm1lbnVQYWdlICk7CgkJCX0sCgoJCQlfaXNSZWJ1aWxkUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQkJCW9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCk7CgoJCQkJLy8gVE9ETyBleGNlZWRpbmdseSBuYWl2ZSBtZXRob2QgdG8gZGV0ZXJtaW5lIGRpZmZlcmVuY2UKCQkJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJCQkvLyBmcm9tIHRoZSB1c2VyIGluIHRoZSByZWZyZXNoIG1ldGhvZAoJCQkJcmV0dXJuIG9wdGlvbnMudGV4dCgpICE9PSBsaXN0LnRleHQoKTsKCQkJfSwKCgkJCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkOm5vdCg6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpKSIgKTsKCQkJfSwKCgkJCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZVJlYnVpbGQgLCBmb28gKXsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCXNlbGVjdCA9IHRoaXMuZWxlbWVudCwKCQkJCWlzTXVsdGlwbGUgPSB0aGlzLmlzTXVsdGlwbGUsCgkJCQlpbmRpY2llczsKCgkJCQlpZiAoICBmb3JjZVJlYnVpbGQgfHwgdGhpcy5faXNSZWJ1aWxkUmVxdWlyZWQoKSApIHsKCQkJCQlzZWxmLl9idWlsZExpc3QoKTsKCQkJCX0KCgkJCQlpbmRpY2llcyA9IHRoaXMuc2VsZWN0ZWRJbmRpY2VzKCk7CgoJCQkJc2VsZi5zZXRCdXR0b25UZXh0KCk7CgkJCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApCgkJCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkJCS5lYWNoKGZ1bmN0aW9uKCBpICkgewoKCQkJCQkJaWYgKCAkLmluQXJyYXkoIGksIGluZGljaWVzICkgPiAtMSApIHsKCQkJCQkJCXZhciBpdGVtID0gJCggdGhpcyApOwoKCQkJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCQkJaXRlbS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIHRydWUgKTsKCgkJCQkJCQkvLyBNdWx0aXBsZSBzZWxlY3RzOiBhZGQgdGhlICJvbiIgY2hlY2tib3ggc3RhdGUgdG8gdGhlIGljb24KCQkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJCWl0ZW0uZmluZCggIi51aS1pY29uIiApLnJlbW92ZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiICkuYWRkQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiApOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlpZiggaXRlbS5pcyggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApICkgewoJCQkJCQkJCQlpdGVtLm5leHQoKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQlpdGVtLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQl9LAoKCQkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09ICJwYWdlIiApIHsKCQkJCQkvLyBkb2Vzbid0IHNvbHZlIHRoZSBwb3NzaWJsZSBpc3N1ZSB3aXRoIGNhbGxpbmcgY2hhbmdlIHBhZ2UKCQkJCQkvLyB3aGVyZSB0aGUgb2JqZWN0cyBkb24ndCBkZWZpbmUgZGF0YSB1cmxzIHdoaWNoIHByZXZlbnRzIGRpYWxvZyBrZXkKCQkJCQkvLyBzdHJpcHBpbmcgLSBjaGFuZ2VQYWdlIGhhcyBpbmNvbWluZyByZWZhY3RvcgoJCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5zY3JlZW4uYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJCXNlbGYubGlzdGJveC5hZGRDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApLnJlbW92ZUF0dHIoICJzdHlsZSIgKS5yZW1vdmVDbGFzcyggImluIiApOwoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkJCX0KCgkJCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJfSwKCgkJCW9wZW46IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpcywKICAgICAgICAgICR3aW5kb3cgPSAkKCB3aW5kb3cgKSwKICAgICAgICAgIHNlbGZMaXN0UGFyZW50ID0gc2VsZi5saXN0LnBhcmVudCgpLAoJCQkJCW1lbnVIZWlnaHQgPSBzZWxmTGlzdFBhcmVudC5vdXRlckhlaWdodCgpLAoJCQkJCW1lbnVXaWR0aCA9IHNlbGZMaXN0UGFyZW50Lm91dGVyV2lkdGgoKSwKCQkJCQlhY3RpdmVQYWdlID0gJCggIi51aS1wYWdlLWFjdGl2ZSIgKSwKCQkJCQl0U2Nyb2xsRWxlbSA9IGFjdGl2ZVBhZ2UsCgkJCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCQlidG5PZmZzZXQgPSBzZWxmLmJ1dHRvbi5vZmZzZXQoKS50b3AsCgkJCQkJc2NyZWVuSGVpZ2h0ID0gJHdpbmRvdy5oZWlnaHQoKSwKCQkJCQlzY3JlZW5XaWR0aCA9ICR3aW5kb3cud2lkdGgoKTsKCgkJCQkvL2FkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkvL3JlbW92ZSBhZnRlciBkZWxheQoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9LCAzMDApOwoKCQkJCWZ1bmN0aW9uIGZvY3VzTWVudUl0ZW0oKSB7CgkJCQkJdmFyIHNlbGVjdG9yID0gc2VsZi5saXN0LmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiBhIiApOwoJCQkJCWlmICggc2VsZWN0b3IubGVuZ3RoID09PSAwICkgewoJCQkJCQlzZWxlY3RvciA9IHNlbGYubGlzdC5maW5kKCAibGkudWktYnRuOm5vdCg6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpKSBhIiApOwoJCQkJCX0KCQkJCQlzZWxlY3Rvci5maXJzdCgpLmZvY3VzKCkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICk7CgkJCQl9CgoJCQkJaWYgKCBtZW51SGVpZ2h0ID4gc2NyZWVuSGVpZ2h0IC0gODAgfHwgISQuc3VwcG9ydC5zY3JvbGxUb3AgKSB7CgoJCQkJCXNlbGYubWVudVBhZ2UuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCk7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQgPSBtZW51UGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICk7CgkJCQkJc2VsZi5tZW51UGFnZUNsb3NlID0gbWVudVBhZ2UuZmluZCggIi51aS1oZWFkZXIgYSIgKTsKCgkJCQkJLy8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBiZWluZyByZW1vdmVkIGZyb20gdGhlIERPTSwKCQkJCQkvLyBvdGhlcndpc2UgdGhlIHJlc3VsdHMgb2Ygc2VsZWN0aW5nIGEgbGlzdCBpdGVtIGluIHRoZSBkaWFsb2cKCQkJCQkvLyBmYWxsIGludG8gYSBibGFjayBob2xlCgkJCQkJc2VsZi50aGlzUGFnZS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICk7CgoJCQkJCS8vZm9yIFdlYk9TL09wZXJhIE1pbmkgKHNldCBsYXN0c2Nyb2xsIHVzaW5nIGJ1dHRvbiBvZmZzZXQpCgkJCQkJaWYgKCBzY3JvbGxUb3AgPT0gMCAmJiBidG5PZmZzZXQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQkJCXNlbGYudGhpc1BhZ2Uub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAibGFzdFNjcm9sbCIsIGJ0bk9mZnNldCApOwoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCXNlbGYubWVudVBhZ2UKCQkJCQkJLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCQlmb2N1c01lbnVJdGVtKCk7CgkJCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQkJCX0pCgkJCQkJCS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJCQkJfSk7CgoJCQkJCXNlbGYubWVudVR5cGUgPSAicGFnZSI7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQuYXBwZW5kKCBzZWxmLmxpc3QgKTsKCQkJCQlzZWxmLm1lbnVQYWdlLmZpbmQoImRpdiAudWktdGl0bGUiKS50ZXh0KHNlbGYubGFiZWwudGV4dCgpKTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBzZWxmLm1lbnVQYWdlLCB7CgkJCQkJCXRyYW5zaXRpb246ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uCgkJCQkJfSk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubWVudVR5cGUgPSAib3ZlcmxheSI7CgoJCQkJCXNlbGYuc2NyZWVuLmhlaWdodCggJChkb2N1bWVudCkuaGVpZ2h0KCkgKQoJCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoKCQkJCQkvLyBUcnkgYW5kIGNlbnRlciB0aGUgb3ZlcmxheSBvdmVyIHRoZSBidXR0b24KCQkJCQl2YXIgcm9vbXRvcCA9IGJ0bk9mZnNldCAtIHNjcm9sbFRvcCwKCQkJCQkJcm9vbWJvdCA9IHNjcm9sbFRvcCArIHNjcmVlbkhlaWdodCAtIGJ0bk9mZnNldCwKCQkJCQkJaGFsZmhlaWdodCA9IG1lbnVIZWlnaHQgLyAyLAoJCQkJCQltYXh3aWR0aCA9IHBhcnNlRmxvYXQoIHNlbGYubGlzdC5wYXJlbnQoKS5jc3MoICJtYXgtd2lkdGgiICkgKSwKCQkJCQkJbmV3dG9wLCBuZXdsZWZ0OwoKCQkJCQlpZiAoIHJvb210b3AgPiBtZW51SGVpZ2h0IC8gMiAmJiByb29tYm90ID4gbWVudUhlaWdodCAvIDIgKSB7CgkJCQkJCW5ld3RvcCA9IGJ0bk9mZnNldCArICggc2VsZi5idXR0b24ub3V0ZXJIZWlnaHQoKSAvIDIgKSAtIGhhbGZoZWlnaHQ7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gMzBweCB0b2xlcmFuY2Ugb2ZmIHRoZSBlZGdlcwoJCQkJCQluZXd0b3AgPSByb29tdG9wID4gcm9vbWJvdCA/IHNjcm9sbFRvcCArIHNjcmVlbkhlaWdodCAtIG1lbnVIZWlnaHQgLSAzMCA6IHNjcm9sbFRvcCArIDMwOwoJCQkJCX0KCgkJCQkJLy8gSWYgdGhlIG1lbnV3aWR0aCBpcyBzbWFsbGVyIHRoYW4gdGhlIHNjcmVlbiBjZW50ZXIgaXMKCQkJCQlpZiAoIG1lbnVXaWR0aCA8IG1heHdpZHRoICkgewoJCQkJCQluZXdsZWZ0ID0gKCBzY3JlZW5XaWR0aCAtIG1lbnVXaWR0aCApIC8gMjsKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy9vdGhlcndpc2UgaW5zdXJlIGEgPj0gMzBweCBvZmZzZXQgZnJvbSB0aGUgbGVmdAoJCQkJCQluZXdsZWZ0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkubGVmdCArIHNlbGYuYnV0dG9uLm91dGVyV2lkdGgoKSAvIDIgLSBtZW51V2lkdGggLyAyOwoKCQkJCQkJLy8gMzBweCB0b2xlcmFuY2Ugb2ZmIHRoZSBlZGdlcwoJCQkJCQlpZiAoIG5ld2xlZnQgPCAzMCApIHsKCQkJCQkJCW5ld2xlZnQgPSAzMDsKCQkJCQkJfSBlbHNlIGlmICggKG5ld2xlZnQgKyBtZW51V2lkdGgpID4gc2NyZWVuV2lkdGggKSB7CgkJCQkJCQluZXdsZWZ0ID0gc2NyZWVuV2lkdGggLSBtZW51V2lkdGggLSAzMDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJc2VsZi5saXN0Ym94LmFwcGVuZCggc2VsZi5saXN0ICkKCQkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2VsZWN0bWVudS1oaWRkZW4iICkKCQkJCQkJLmNzcyh7CgkJCQkJCQl0b3A6IG5ld3RvcCwKCQkJCQkJCWxlZnQ6IG5ld2xlZnQKCQkJCQkJfSkKCQkJCQkJLmFkZENsYXNzKCAiaW4iICk7CgoJCQkJCWZvY3VzTWVudUl0ZW0oKTsKCgkJCQkJLy8gZHVwbGljYXRlIHdpdGggdmFsdWUgc2V0IGluIHBhZ2Ugc2hvdyBmb3IgZGlhbG9nIHNpemVkIHNlbGVjdHMKCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQl9CgkJCX0sCgoJCQlfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQkJCW9wdGdyb3VwcyA9IFtdLAoJCQkJCWxpcyA9IFtdLAoJCQkJCWRhdGFJY29uID0gc2VsZi5pc011bHRpcGxlID8gImNoZWNrYm94LW9mZiIgOiAiZmFsc2UiOwoKCQkJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgoJCQkJdmFyICRvcHRpb25zID0gc2VsZi5zZWxlY3QuZmluZCgib3B0aW9uIiksCgkJCQkJbnVtT3B0aW9ucyA9ICRvcHRpb25zLmxlbmd0aCwKCQkJCQlzZWxlY3QgPSB0aGlzLnNlbGVjdFsgMCBdLAoJCQkJCWRhdGFQcmVmaXggPSAnZGF0YS0nICsgJC5tb2JpbGUubnMsCgkJCQkJZGF0YUluZGV4QXR0ciA9IGRhdGFQcmVmaXggKyAnb3B0aW9uLWluZGV4JywKCQkJCQlkYXRhSWNvbkF0dHIgPSBkYXRhUHJlZml4ICsgJ2ljb24nLAoJCQkJCWRhdGFSb2xlQXR0ciA9IGRhdGFQcmVmaXggKyAncm9sZScsCgkJCQkJZGF0YVBsYWNlaG9sZGVyQXR0ciA9IGRhdGFQcmVmaXggKyAncGxhY2Vob2xkZXInLAoJCQkJCWZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAoJCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UsCgkJCQkJb3B0R3JvdXA7CgoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBudW1PcHRpb25zO2krKywgaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSl7CgkJCQkJdmFyIG9wdGlvbiA9ICRvcHRpb25zW2ldLAoJCQkJCQkkb3B0aW9uID0gJChvcHRpb24pLAoJCQkJCQlwYXJlbnQgPSBvcHRpb24ucGFyZW50Tm9kZSwKCQkJCQkJdGV4dCA9ICRvcHRpb24udGV4dCgpLAoJCQkJCQlhbmNob3IgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpLAoJCQkJCQljbGFzc2VzID0gW107CgoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCcjJyk7CgkJCQkJYW5jaG9yLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpKTsKCgkJCQkJLy8gQXJlIHdlIGluc2lkZSBhbiBvcHRncm91cD8KCQkJCQlpZiAocGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIpewoJCQkJCQl2YXIgb3B0TGFiZWwgPSBwYXJlbnQuZ2V0QXR0cmlidXRlKCdsYWJlbCcpOwoJCQkJCQlpZiAoIG9wdExhYmVsICE9IG9wdEdyb3VwKSB7CgkJCQkJCQl2YXIgZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZShkYXRhUm9sZUF0dHIsJ2xpc3QtZGl2aWRlcicpOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCdvcHRpb24nKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsJy0xJyk7CgkJCQkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKG9wdExhYmVsKSk7CgkJCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZChkaXZpZGVyKTsKCQkJCQkJCW9wdEdyb3VwID0gb3B0TGFiZWw7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmIChuZWVkUGxhY2Vob2xkZXIgJiYgKCFvcHRpb24uZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgfHwgdGV4dC5sZW5ndGggPT0gMCB8fCAkb3B0aW9uLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSkpIHsKCQkJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gdHJ1ZTsKCgkJCQkJCS8vIElmIHdlIGhhdmUgaWRlbnRpZmllZCBhIHBsYWNlaG9sZGVyLCBtYXJrIGl0IHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQkJCW9wdGlvbi5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQkJCWNsYXNzZXMucHVzaCggInVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgkJCQkJCX0KCQkJCQkJaWYgKCFwbGFjZWhvbGRlcikgewoJCQkJCQkJcGxhY2Vob2xkZXIgPSBzZWxmLnBsYWNlaG9sZGVyID0gdGV4dDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpOwoJCQkJCWlmICggb3B0aW9uLmRpc2FibGVkICkgewoJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1kaXNhYmxlZCIgKTsKCQkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoJ2FyaWEtZGlzYWJsZWQnLHRydWUpOwoJCQkJCX0KCQkJCQlpdGVtLnNldEF0dHJpYnV0ZShkYXRhSW5kZXhBdHRyLGkpOwoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKGRhdGFJY29uQXR0cixkYXRhSWNvbik7CgkJCQkJaWYgKCBpc1BsYWNlaG9sZGVySXRlbSApIHsKCQkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCQl9CgkJCQkJaXRlbS5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oIiAiKTsKCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSgncm9sZScsJ29wdGlvbicpOwoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoJ3RhYmluZGV4JywnLTEnKTsKCQkJCQlpdGVtLmFwcGVuZENoaWxkKGFuY2hvcik7CgkJCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoaXRlbSk7CgkJCQl9CgoJCQkJc2VsZi5saXN0WzBdLmFwcGVuZENoaWxkKGZyYWdtZW50KTsKCgkJCQkvLyBIaWRlIGhlYWRlciBpZiBpdCdzIG5vdCBhIG11bHRpc2VsZWN0IGFuZCB0aGVyZSdzIG5vIHBsYWNlaG9sZGVyCgkJCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJCQl0aGlzLmhlYWRlci5oaWRlKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCQkJfQoKCQkJCS8vIE5vdyBwb3B1bGF0ZWQsIGNyZWF0ZSBsaXN0dmlldwoJCQkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7CgkJCX0sCgoJCQlfYnV0dG9uOiBmdW5jdGlvbigpewoJCQkJcmV0dXJuICQoICI8YT4iLCB7CgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkJImFyaWEtaGFzcG9wdXAiOiAidHJ1ZSIsCgoJCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCQl9KTsKCQkJfQoJCX0pOwoJfTsKCgkvLyBpc3N1ZSAjMzg5NCAtIGNvcmUgZG9lc24ndCB0cmlnZ2VyZWQgZXZlbnRzIG9uIGRpc2FibGVkIGRlbGVnYXRlcwoJJCggZG9jdW1lbnQgKS5iaW5kKCAic2VsZWN0bWVudWJlZm9yZWNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApewoJCXZhciBzZWxlY3RtZW51V2lkZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuZGF0YSggInNlbGVjdG1lbnUiICk7CgoJCWlmKCAhc2VsZWN0bWVudVdpZGdldC5vcHRpb25zLm5hdGl2ZU1lbnUgKXsKCQkJZXh0ZW5kU2VsZWN0KCBzZWxlY3RtZW51V2lkZ2V0ICk7CgkJfQoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS5maXhlZHRvb2xiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCQlvcHRpb25zOiB7CgkJCXZpc2libGVPblBhZ2VTaG93OiB0cnVlLAoJCQlkaXNhYmxlUGFnZVpvb206IHRydWUsCgkJCXRyYW5zaXRpb246ICJzbGlkZSIsIC8vY2FuIGJlIG5vbmUsIGZhZGUsIHNsaWRlIChzbGlkZSBtYXBzIHRvIHNsaWRldXAgb3Igc2xpZGVkb3duKQoJCQlmdWxsc2NyZWVuOiBmYWxzZSwKCQkJdGFwVG9nZ2xlOiB0cnVlLAoJCQl0YXBUb2dnbGVCbGFja2xpc3Q6ICJhLCBidXR0b24sIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCAudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiwKCQkJaGlkZUR1cmluZ0ZvY3VzOiAiaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QiLAoJCQl1cGRhdGVQYWdlUGFkZGluZzogdHJ1ZSwKCQkJdHJhY2tQZXJzaXN0ZW50VG9vbGJhcnM6IHRydWUsCgoJCQkvLyBCcm93c2VyIGRldGVjdGlvbiEgV2VlZWUsIGhlcmUgd2UgZ28uLi4KCQkJLy8gVW5mb3J0dW5hdGVseSwgcG9zaXRpb246Zml4ZWQgaXMgY29zdGx5LCBub3QgdG8gbWVudGlvbiBwcm9iYWJseSBpbXBvc3NpYmxlLCB0byBmZWF0dXJlLWRldGVjdCBhY2N1cmF0ZWx5LgoJCQkvLyBTb21lIHRlc3RzIGV4aXN0LCBidXQgdGhleSBjdXJyZW50bHkgcmV0dXJuIGZhbHNlIHJlc3VsdHMgaW4gY3JpdGljYWwgZGV2aWNlcyBhbmQgYnJvd3NlcnMsIHdoaWNoIGNvdWxkIGxlYWQgdG8gYSBicm9rZW4gZXhwZXJpZW5jZS4KCQkJLy8gVGVzdGluZyBmaXhlZCBwb3NpdGlvbmluZyBpcyBhbHNvIHByZXR0eSBvYnRydXNpdmUgdG8gcGFnZSBsb2FkLCByZXF1aXJpbmcgaW5qZWN0ZWQgZWxlbWVudHMgYW5kIHNjcm9sbGluZyB0aGUgd2luZG93CgkJCS8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gc2VydmVzIHRvIHJ1bGUgb3V0IHNvbWUgcG9wdWxhciBicm93c2VycyB3aXRoIGtub3duIGZpeGVkLXBvc2l0aW9uaW5nIGlzc3VlcwoJCQkvLyBUaGlzIGlzIGEgcGx1Z2luIG9wdGlvbiBsaWtlIGFueSBvdGhlciwgc28gZmVlbCBmcmVlIHRvIGltcHJvdmUgb3Igb3ZlcndyaXRlIGl0CgkJCXN1cHBvcnRCbGFja2xpc3Q6IGZ1bmN0aW9uKCl7CgkJCQl2YXIgdyA9IHdpbmRvdywKCQkJCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCQkJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJCQkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCQkJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCgkJCQlpZigKCQkJCQkvLyBpT1MgNC4zIGFuZCBvbGRlciA6IFBsYXRmb3JtIGlzIGlQaG9uZS9QYWQvVG91Y2ggYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzQgKGlvczUpCgkJCQkJKCAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApCgkJCQkJfHwKCQkJCQkvLyBPcGVyYSBNaW5pCgkJCQkJKCB3Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHcub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iICkKCQkJCQl8fAoJCQkJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCgkJCQkJfHwKCQkJCQkvL0FuZHJvaWQgbHRlIDIuMTogUGxhdGZvcm0gaXMgQW5kcm9pZCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzMyAoQW5kcm9pZCAyLjIpCgkJCQkJKCB1YS5pbmRleE9mKCAiQW5kcm9pZCIgKSA+IC0xICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzMgKQoJCQkJCXx8CgkJCQkJLy8gRmlyZWZveCBNb2JpbGUgYmVmb3JlIDYuMCAtCgkJCQkJKCBmZnZlcnNpb24gJiYgZmZ2ZXJzaW9uIDwgNiApCgkJCQkJfHwKCQkJCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCQkJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQoJCQkJCXx8CgkJCQkJLy8gTWVlR28KCQkJCQkoIHVhLmluZGV4T2YoICJNZWVHbyIgKSA+IC0xICYmIHVhLmluZGV4T2YoICJOb2tpYUJyb3dzZXIvOC41LjAiICkgPiAtMSApCgkJCQkpewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoKCQkJCXJldHVybiBmYWxzZTsKCQkJfSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50LAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiLAoJCQkJJHBhZ2UgPSAkZWwuY2xvc2VzdCgiLnVpLXBhZ2UiKTsKCgkJCS8vIEZlYXR1cmUgZGV0ZWN0aW5nIHN1cHBvcnQgZm9yCgkJCWlmKCBvLnN1cHBvcnRCbGFja2xpc3QoKSApewoJCQkJc2VsZi5kZXN0cm95KCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCSRlbC5hZGRDbGFzcyggInVpLSIrIHRidHlwZSArIi1maXhlZCIgKTsKCgkJCS8vICJmdWxsc2NyZWVuIiBvdmVybGF5IHBvc2l0aW9uaW5nCgkJCWlmKCBvLmZ1bGxzY3JlZW4gKXsKCQkJCSRlbC5hZGRDbGFzcyggInVpLSIrIHRidHlwZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0YnR5cGUgKyAiLWZ1bGxzY3JlZW4iICk7CgkJCX0KCQkJLy8gSWYgbm90IGZ1bGxzY3JlZW4sIGFkZCBjbGFzcyB0byBwYWdlIHRvIHNldCB0b3Agb3IgYm90dG9tIHBhZGRpbmcKCQkJZWxzZXsKCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGJ0eXBlICsgIi1maXhlZCIgKTsKCQkJfQoKCQkJc2VsZi5fYWRkVHJhbnNpdGlvbkNsYXNzKCk7CgkJCXNlbGYuX2JpbmRQYWdlRXZlbnRzKCk7CgkJCXNlbGYuX2JpbmRUb2dnbGVIYW5kbGVycygpOwoJCX0sCgoJCV9hZGRUcmFuc2l0aW9uQ2xhc3M6IGZ1bmN0aW9uKCl7CgkJCXZhciB0Y2xhc3MgPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCgkJCWlmKCB0Y2xhc3MgJiYgdGNsYXNzICE9PSAibm9uZSIgKXsKCQkJCS8vIHVzZSBhcHByb3ByaWF0ZSBzbGlkZSBmb3IgaGVhZGVyIG9yIGZvb3RlcgoJCQkJaWYoIHRjbGFzcyA9PT0gInNsaWRlIiApewoJCQkJCXRjbGFzcyA9IHRoaXMuZWxlbWVudC5pcyggIi51aS1oZWFkZXIiICkgPyAic2xpZGVkb3duIiA6ICJzbGlkZXVwIjsKCQkJCX0KCgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRjbGFzcyApOwoJCQl9CgkJfSwKCgkJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50OwoKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKQoJCQkJLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCl7CgkJCQkJaWYoIG8uZGlzYWJsZVBhZ2Vab29tICl7CgkJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQkJCX0KCQkJCQlpZiggIW8udmlzaWJsZU9uUGFnZVNob3cgKXsKCQkJCQkJc2VsZi5oaWRlKCB0cnVlICk7CgkJCQkJfQoJCQkJfSApCgkJCQkuYmluZCggIndlYmtpdEFuaW1hdGlvblN0YXJ0IGFuaW1hdGlvbnN0YXJ0IHVwZGF0ZWxheW91dCIsIGZ1bmN0aW9uKCl7CgkJCQkJdmFyIHRoaXNQYWdlID0gdGhpczsKCQkJCQlpZiggby51cGRhdGVQYWdlUGFkZGluZyApewoJCQkJCQlzZWxmLnVwZGF0ZVBhZ2VQYWRkaW5nKCB0aGlzUGFnZSApOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggInBhZ2VzaG93IiwgZnVuY3Rpb24oKXsKCQkJCQl2YXIgdGhpc1BhZ2UgPSB0aGlzOwoJCQkJCXNlbGYudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXNQYWdlICk7CgkJCQkJaWYoIG8udXBkYXRlUGFnZVBhZGRpbmcgKXsKCQkJCQkJJCggd2luZG93ICkuYmluZCggInRocm90dGxlZHJlc2l6ZS4iICsgc2VsZi53aWRnZXROYW1lLCBmdW5jdGlvbigpewoJCQkJCQkgCXNlbGYudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXNQYWdlICk7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oIGUsIHVpICl7CgkJCQkJaWYoIG8uZGlzYWJsZVBhZ2Vab29tICl7CgkJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQkJfQoJCQkJCWlmKCBvLnVwZGF0ZVBhZ2VQYWRkaW5nICl7CgkJCQkJCSQoIHdpbmRvdyApLnVuYmluZCggInRocm90dGxlZHJlc2l6ZS4iICsgc2VsZi53aWRnZXROYW1lICk7CgkJCQkJfQoKCQkJCQlpZiggby50cmFja1BlcnNpc3RlbnRUb29sYmFycyApewoJCQkJCQl2YXIgdGhpc0Zvb3RlciA9ICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcyApLAoJCQkJCQkJdGhpc0hlYWRlciA9ICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcyApLAoJCQkJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICksCgkJCQkJCQluZXh0SGVhZGVyID0gdGhpc0hlYWRlci5sZW5ndGggJiYgdWkubmV4dFBhZ2UgJiYgJCggIi51aS1oZWFkZXItZml4ZWQ6anFtRGF0YShpZD0nIiArIHRoaXNIZWFkZXIuanFtRGF0YSggImlkIiApICsgIicpIiwgdWkubmV4dFBhZ2UgKTsKCgkJCQkJCW5leHRGb290ZXIgPSBuZXh0Rm9vdGVyIHx8ICQoKTsKCgkJCQkJCQlpZiggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKXsKCgkJCQkJCQkJbmV4dEZvb3Rlci5hZGQoIG5leHRIZWFkZXIgKS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJCQkJCQl1aS5uZXh0UGFnZS5vbmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCl7CgkJCQkJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oIHRoaXMgKTsKCQkJCQkJCQl9KTsKCQkJCQkJCX0KCQkJCQl9CgkJCQl9KTsKCQl9LAoKCQlfdmlzaWJsZTogdHJ1ZSwKCgkJLy8gVGhpcyB3aWxsIHNldCB0aGUgY29udGVudCBlbGVtZW50J3MgdG9wIG9yIGJvdHRvbSBwYWRkaW5nIGVxdWFsIHRvIHRoZSB0b29sYmFyJ3MgaGVpZ2h0CgkJdXBkYXRlUGFnZVBhZGRpbmc6IGZ1bmN0aW9uKCB0YlBhZ2UgKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaXMoICIudWktaGVhZGVyIiApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiggdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gKXsgcmV0dXJuOyB9CgoJCQl0YlBhZ2UgPSB0YlBhZ2UgfHwgJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJJCggdGJQYWdlICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICRlbC5vdXRlckhlaWdodCgpICk7CgkJfSwKCQkKCQlfdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApewoJCQl2YXIgJHdpbiA9ICQoIHdpbmRvdyApLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuaGVpZ2h0KCksCgkJCQl2aWV3cG9ydEhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiOwoJCQkJCgkJCXJldHVybiAhbm90cmFuc2l0aW9uICYmCgkJCQkoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICYmIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICE9PSAibm9uZSIgJiYKCQkJCSgKCQkJCQkoIHRidHlwZSA9PT0gImhlYWRlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCA+IGVsSGVpZ2h0ICkgfHwKCQkJCQkoIHRidHlwZSA9PT0gImZvb3RlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCArIHZpZXdwb3J0SGVpZ2h0IDwgcEhlaWdodCAtIGVsSGVpZ2h0ICkKCQkJCSkgfHwgdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4KCQkJCSk7CgkJfSwKCgkJc2hvdzogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCQkJaWYoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICl7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwucmVtb3ZlQ2xhc3MoIGhpZGVDbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSB0cnVlOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKXsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKXsKCQkJCSRlbAoJCQkJCS5hZGRDbGFzcyggb3V0Y2xhc3MgKQoJCQkJCS5yZW1vdmVDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCBmdW5jdGlvbigpewoJCQkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gZmFsc2U7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbigpewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50OwoKCQkJLy8gdGFwIHRvZ2dsZQoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApCgkJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBlICl7CgkJCQkJaWYoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICl7CgkJCQkJCXNlbGYudG9nZ2xlKCk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZm9jdXNpbiBmb2N1c291dCIsIGZ1bmN0aW9uKCBlICl7CgkJCQkJaWYoIHNjcmVlbi53aWR0aCA8IDUwMCAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApewoJCQkJCQlzZWxmWyAoIGUudHlwZSA9PT0gImZvY3VzaW4iICYmIHNlbGYuX3Zpc2libGUgKSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaXMoICIudWktaGVhZGVyIiApOwoKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgIiIgKTsKCQkJJGVsLnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwoKCS8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwoJJCggZG9jdW1lbnQgKQoJCS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJCQkKCQkJLy8gREVQUkVDQVRFRCBpbiAxLjE6IHN1cHBvcnQgZm9yIGRhdGEtZnVsbHNjcmVlbj10cnVlfGZhbHNlIG9uIHRoZSBwYWdlIGVsZW1lbnQuCgkJCS8vIFRoaXMgbGluZSBlbnN1cmVzIGl0IHN0aWxsIHdvcmtzLCBidXQgd2UgcmVjb21tZW5kIG1vdmluZyB0aGUgYXR0cmlidXRlIHRvIHRoZSB0b29sYmFycyB0aGVtc2VsdmVzLgoJCQlpZiggJCggZS50YXJnZXQgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIgKSApewoJCQkJJCggJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5ub3QoICI6anFtRGF0YShmdWxsc2NyZWVuKSIgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIsIHRydWUgKTsKCQkJfQoJCQkKCQkJJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwoJCX0pOwoKfSkoIGpRdWVyeSApOwoKKCBmdW5jdGlvbiggJCwgd2luZG93ICkgewoJCgkvLyBUaGlzIGZpeCBhZGRyZXNzZXMgYW4gaU9TIGJ1Zywgc28gcmV0dXJuIGVhcmx5IGlmIHRoZSBVQSBjbGFpbXMgaXQncyBzb21ldGhpbmcgZWxzZS4KCWlmKCAhKC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICkgKXsKCQlyZXR1cm47Cgl9CgkKICAgIHZhciB6b29tID0gJC5tb2JpbGUuem9vbSwKCQlldnQsIHgsIHksIHosIGFpZzsKCQogICAgZnVuY3Rpb24gY2hlY2tUaWx0KCBlICl7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoJCQoJCXggPSBNYXRoLmFicyggYWlnLnggKTsKCQl5ID0gTWF0aC5hYnMoIGFpZy55ICk7CgkJeiA9IE1hdGguYWJzKCBhaWcueiApOwoJCQkJCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCiAgICAgICAgaWYoICF3aW5kb3cub3JpZW50YXRpb24gJiYgKCB4ID4gNyB8fCAoICggeiA+IDYgJiYgeSA8IDggfHwgeiA8IDggJiYgeSA+IDYgKSAmJiB4ID4gNSApICkgKXsKCQkJaWYoIHpvb20uZW5hYmxlZCApewoJCQkJem9vbS5kaXNhYmxlKCk7CgkJCX0gICAgICAgIAkKICAgICAgICB9CgkJZWxzZSBpZiggIXpvb20uZW5hYmxlZCApewoJCQl6b29tLmVuYWJsZSgpOwogICAgICAgIH0KICAgIH0KCiAgICAkKCB3aW5kb3cgKQoJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJLmJpbmQoICJkZXZpY2Vtb3Rpb24uaW9zb3JpZW50YXRpb25maXgiLCBjaGVja1RpbHQgKTsKCn0oIGpRdWVyeSwgdGhpcyApKTsKCiggZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJCSRoZWFkID0gJCggImhlYWQiICksCgkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCgkvLyB0cmlnZ2VyIG1vYmlsZWluaXQgZXZlbnQgLSB1c2VmdWwgaG9vayBmb3IgY29uZmlndXJpbmcgJC5tb2JpbGUgc2V0dGluZ3MgYmVmb3JlIHRoZXkncmUgdXNlZAoJJCggd2luZG93LmRvY3VtZW50ICkudHJpZ2dlciggIm1vYmlsZWluaXQiICk7CgoJLy8gc3VwcG9ydCBjb25kaXRpb25zCgkvLyBpZiBkZXZpY2Ugc3VwcG9ydCBjb25kaXRpb24ocykgYXJlbid0IG1ldCwgbGVhdmUgdGhpbmdzIGFzIHRoZXkgYXJlIC0+IGEgYmFzaWMsIHVzYWJsZSBleHBlcmllbmNlLAoJLy8gb3RoZXJ3aXNlLCBwcm9jZWVkIHdpdGggdGhlIGVuaGFuY2VtZW50cwoJaWYgKCAhJC5tb2JpbGUuZ3JhZGVBKCkgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMKCS8vIG9yIGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKEJCNSwgT3BlcmEgTWluaSkKCWlmICggJC5tb2JpbGUuYWpheEJsYWNrbGlzdCApIHsKCQkkLm1vYmlsZS5hamF4RW5hYmxlZCA9IGZhbHNlOwoJfQoKCS8vIEFkZCBtb2JpbGUsIGluaXRpYWwgbG9hZCAicmVuZGVyaW5nIiBjbGFzc2VzIHRvIGRvY0VsCgkkaHRtbC5hZGRDbGFzcyggInVpLW1vYmlsZSB1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoKCS8vIFRoaXMgaXMgYSBmYWxsYmFjay4gSWYgYW55dGhpbmcgZ29lcyB3cm9uZyAoSlMgZXJyb3JzLCBldGMpLCBvciBldmVudHMgZG9uJ3QgZmlyZSwKCS8vIHRoaXMgZW5zdXJlcyB0aGUgcmVuZGVyaW5nIGNsYXNzIGlzIHJlbW92ZWQgYWZ0ZXIgNSBzZWNvbmRzLCBzbyBjb250ZW50IGlzIHZpc2libGUgYW5kIGFjY2Vzc2libGUKCXNldFRpbWVvdXQoIGhpZGVSZW5kZXJpbmdDbGFzcywgNTAwMCApOwoKCS8vIGxvYWRpbmcgZGl2IHdoaWNoIGFwcGVhcnMgZHVyaW5nIEFqYXggcmVxdWVzdHMKCS8vIHdpbGwgbm90IGFwcGVhciBpZiAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSBpcyBmYWxzZQoJdmFyIGxvYWRlckNsYXNzID0gInVpLWxvYWRlciIsCgkJJGxvYWRlciA9ICQoICI8ZGl2IGNsYXNzPSciICsgbG9hZGVyQ2xhc3MgKyAiJz48c3BhbiBjbGFzcz0ndWktaWNvbiB1aS1pY29uLWxvYWRpbmcnPjwvc3Bhbj48aDE+PC9oMT48L2Rpdj4iICk7CgoJLy8gRm9yIG5vbi1maXhlZCBzdXBwb3J0aW4gYnJvd3NlcnMuIFBvc2l0aW9uIGF0IHkgY2VudGVyIChpZiBzY3JvbGxUb3Agc3VwcG9ydGVkKSwgYWJvdmUgdGhlIGFjdGl2ZUJ0biAoaWYgZGVmaW5lZCksIG9yIGp1c3QgMTAwcHggZnJvbSB0b3AKCWZ1bmN0aW9uIGZha2VGaXhMb2FkZXIoKXsKCQl2YXIgYWN0aXZlQnRuID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5maXJzdCgpOwoKCQkkbG9hZGVyCgkJCS5jc3MoewoJCQkJdG9wOiAkLnN1cHBvcnQuc2Nyb2xsVG9wICYmICR3aW5kb3cuc2Nyb2xsVG9wKCkgKyAkd2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJYWN0aXZlQnRuLmxlbmd0aCAmJiBhY3RpdmVCdG4ub2Zmc2V0KCkudG9wIHx8IDEwMAoJCQl9KTsKCX0KCgkvLyBjaGVjayBwb3NpdGlvbiBvZiBsb2FkZXIgdG8gc2VlIGlmIGl0IGFwcGVhcnMgdG8gYmUgImZpeGVkIiB0byBjZW50ZXIKCS8vIGlmIG5vdCwgdXNlIGFicyBwb3NpdGlvbmluZwoJZnVuY3Rpb24gY2hlY2tMb2FkZXJQb3NpdGlvbigpewoJCXZhciBvZmZzZXQgPSAkbG9hZGVyLm9mZnNldCgpLAoJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQlzY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJaWYoIG9mZnNldC50b3AgPCBzY3JvbGxUb3AgfHwgKG9mZnNldC50b3AgLSBzY3JvbGxUb3ApID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkkbG9hZGVyLmFkZENsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCWZha2VGaXhMb2FkZXIoKTsKCQkJJHdpbmRvdwoJCQkJLnVuYmluZCggInNjcm9sbCIsIGNoZWNrTG9hZGVyUG9zaXRpb24gKQoJCQkJLmJpbmQoICJzY3JvbGwiLCBmYWtlRml4TG9hZGVyICk7CgkJfQoJfQoKCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCWZ1bmN0aW9uIGhpZGVSZW5kZXJpbmdDbGFzcygpewoJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCX0KCgkkLmV4dGVuZCgkLm1vYmlsZSwgewoJCS8vIHR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLgoJCXNob3dQYWdlTG9hZGluZ01zZzogZnVuY3Rpb24oIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApIHsKCQkJJGh0bWwuYWRkQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSApIHsKCQkJCS8vIHRleHQgdmlzaWJpbGl0eSBmcm9tIGFyZ3VtZW50IHRha2VzIHByaW9yaXR5CgkJCQl2YXIgdGV4dFZpc2libGUgPSB0ZXh0b25seSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOwoKCQkJCXRoZW1lID0gdGhlbWUgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUaGVtZSwKCgkJCQkkbG9hZGVyCgkJCQkJLmF0dHIoICJjbGFzcyIsIGxvYWRlckNsYXNzICsgIiB1aS1jb3JuZXItYWxsIHVpLWJvZHktIiArICggdGhlbWUgfHwgImEiICkgKyAiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSA/ICJ2ZXJib3NlIiA6ICJkZWZhdWx0IiApICsgKCB0ZXh0b25seSA/ICIgdWktbG9hZGVyLXRleHRvbmx5IiA6ICIiICkgKQoJCQkJCS5maW5kKCAiaDEiICkKCQkJCQkJLnRleHQoIG1zZ1RleHQgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgKQoJCQkJCQkuZW5kKCkKCQkJCQkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQljaGVja0xvYWRlclBvc2l0aW9uKCk7CgkJCQkkd2luZG93LmJpbmQoICJzY3JvbGwiLCBjaGVja0xvYWRlclBvc2l0aW9uICk7CgkJCX0KCQl9LAoKCQloaWRlUGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCkgewoJCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgKXsKCQkJCSRsb2FkZXIucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJfQoKCQkJJCggd2luZG93ICkudW5iaW5kKCAic2Nyb2xsIiwgZmFrZUZpeExvYWRlciApOwoJCQkkKCB3aW5kb3cgKS51bmJpbmQoICJzY3JvbGwiLCBjaGVja0xvYWRlclBvc2l0aW9uICk7CgkJfSwKCgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICk7CgoJCQkvLyBpZiBubyBwYWdlcyBhcmUgZm91bmQsIGNyZWF0ZSBvbmUgd2l0aCBib2R5J3MgaW5uZXIgaHRtbAoJCQlpZiAoICEkcGFnZXMubGVuZ3RoICkgewoJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJfQoKCQkJLy8gYWRkIGRpYWxvZ3MsIHNldCBkYXRhLXVybCBhdHRycwoJCQkkcGFnZXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQodGhpcyk7CgoJCQkJLy8gdW5sZXNzIHRoZSBkYXRhIHVybCBpcyBhbHJlYWR5IHNldCBzZXQgaXQgdG8gdGhlIHBhdGhuYW1lCgkJCQlpZiAoICEkdGhpcy5qcW1EYXRhKCJ1cmwiKSApIHsKCQkJCQkkdGhpcy5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgJHRoaXMuYXR0ciggImlkIiApIHx8IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoICk7CgkJCQl9CgkJCX0pOwoKCQkJLy8gZGVmaW5lIGZpcnN0IHBhZ2UgaW4gZG9tIGNhc2Ugb25lIGJhY2tzIG91dCB0byB0aGUgZGlyZWN0b3J5IHJvb3QgKG5vdCBhbHdheXMgdGhlIGZpcnN0IHBhZ2UgdmlzaXRlZCwgYnV0IGRlZmluZWQgYXMgZmFsbGJhY2spCgkJCSQubW9iaWxlLmZpcnN0UGFnZSA9ICRwYWdlcy5maXJzdCgpOwoKCQkJLy8gZGVmaW5lIHBhZ2UgY29udGFpbmVyCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIgPSAkcGFnZXMuZmlyc3QoKS5wYXJlbnQoKS5hZGRDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydCIgKTsKCgkJCS8vIGFsZXJ0IGxpc3RlbmVycyB0aGF0IHRoZSBwYWdlY29udGFpbmVyIGhhcyBiZWVuIGRldGVybWluZWQgZm9yIGJpbmRpbmcKCQkJLy8gdG8gZXZlbnRzIHRyaWdnZXJlZCBvbiBpdAoJCQkkd2luZG93LnRyaWdnZXIoICJwYWdlY29udGFpbmVyY3JlYXRlIiApOwoKCQkJLy8gY3VlIHBhZ2UgbG9hZGluZyBtZXNzYWdlCgkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZygpOwoKCQkJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJCQloaWRlUmVuZGVyaW5nQ2xhc3MoKTsKCgkJCS8vIGlmIGhhc2hjaGFuZ2UgbGlzdGVuaW5nIGlzIGRpc2FibGVkLCB0aGVyZSdzIG5vIGhhc2ggZGVlcGxpbmssCgkJCS8vIHRoZSBoYXNoIGlzIG5vdCB2YWxpZCAoY29udGFpbnMgbW9yZSB0aGFuIG9uZSAjIG9yIGRvZXMgbm90IHN0YXJ0IHdpdGggIykKCQkJLy8gb3IgdGhlcmUgaXMgbm8gcGFnZSB3aXRoIHRoYXQgaGFzaCwgY2hhbmdlIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBET00KCQkJLy8gUmVtZW1iZXIsIGhvd2V2ZXIsIHRoYXQgdGhlIGhhc2ggY2FuIGFsc28gYmUgYSBwYXRoIQoJCQlpZiAoICEgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCAmJgoJCQkgICAgICAgICAkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJICAgICAgICAgKCAkKCBsb2NhdGlvbi5oYXNoICsgJzpqcW1EYXRhKHJvbGU9InBhZ2UiKScgKS5sZW5ndGggfHwKCQkJICAgICAgICAgICAkLm1vYmlsZS5wYXRoLmlzUGF0aCggbG9jYXRpb24uaGFzaCApICkgKSApIHsKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgeyB0cmFuc2l0aW9uOiAibm9uZSIsIHJldmVyc2U6IHRydWUsIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCQkJLy8gb3RoZXJ3aXNlLCB0cmlnZ2VyIGEgaGFzaGNoYW5nZSB0byBsb2FkIGEgZGVlcGxpbmsKCQkJZWxzZSB7CgkJCQkkd2luZG93LnRyaWdnZXIoICJoYXNoY2hhbmdlIiwgWyB0cnVlIF0gKTsKCQkJfQoJCX0KCX0pOwoKCS8vIGluaXRpYWxpemUgZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOwoKCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJLy8gdGhlbiBjaGVjayB3aGF0IHRoZSBzY3JvbGwgdG9wIGlzLiBBbmRyb2lkIHdpbGwgcmVwb3J0IDAuLi4gb3RoZXJzIDEKCS8vIG5vdGUgdGhhdCB0aGlzIGluaXRpYWwgc2Nyb2xsIHdvbid0IGhpZGUgdGhlIGFkZHJlc3MgYmFyLiBJdCdzIGp1c3QgZm9yIHRoZSBjaGVjay4KCSQoZnVuY3Rpb24oKSB7CgkJd2luZG93LnNjcm9sbFRvKCAwLCAxICk7CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkKHdpbmRvdykuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCgkJLy8gVE9ETzogSW1wbGVtZW50IGEgcHJvcGVyIHJlZ2lzdHJhdGlvbiBtZWNoYW5pc20gd2l0aCBkZXBlbmRlbmN5IGhhbmRsaW5nIGluIG9yZGVyIHRvIG5vdCBoYXZlIGV4Y2VwdGlvbnMgbGlrZSB0aGUgb25lIGJlbG93CgkJLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzIGZvciB0aG9zZSB3aWRnZXRzIHRoYXQgaGF2ZSBhIHNvZnQgZGVwZW5kZW5jeSBvbiBvdGhlcnMKCQlpZiAoICQuZm4uY29udHJvbGdyb3VwICkgewoJCQkkKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkJCQkkKCAiOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykiLCBlLnRhcmdldCApCgkJCQkJLmpxbUVuaGFuY2VhYmxlKCkKCQkJCQkuY29udHJvbGdyb3VwKHsgZXhjbHVkZUludmlzaWJsZTogZmFsc2UgfSk7CgkJCX0pOwoJCX0KCgkJLy9kb20tcmVhZHkgaW5pdHMKCQlpZiggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICl7CgkJCSQubW9iaWxlLmluaXRpYWxpemVQYWdlKCk7CgkJfQoKCQkvLyB3aW5kb3cgbG9hZCBldmVudAoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQKCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoKCQlpZiAoICEkLnN1cHBvcnQuY3NzUG9pbnRlckV2ZW50cyApIHsKCQkJLy8gSUUgYW5kIE9wZXJhIGRvbid0IHN1cHBvcnQgQ1NTIHBvaW50ZXItZXZlbnRzOiBub25lIHRoYXQgd2UgdXNlIHRvIGRpc2FibGUgbGluay1iYXNlZCBidXR0b25zCgkJCS8vIGJ5IGFkZGluZyB0aGUgJ3VpLWRpc2FibGVkJyBjbGFzcyB0byB0aGVtLiBVc2luZyBhIEphdmFTY3JpcHQgd29ya2Fyb3VuZCBmb3IgdGhvc2UgYnJvd3Nlci4KCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTU4CgoJCQkkKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiLnVpLWRpc2FibGVkIiwgInZjbGljayIsCgkJCQlmdW5jdGlvbiggZSApIHsKCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCX0KCQkJKTsKCQl9Cgl9KTsKfSggalF1ZXJ5LCB0aGlzICkpOwoKCn0pKTsK",
                "body": "LyoKKiBqUXVlcnkgTW9iaWxlIEZyYW1ld29yayAxLjEuMiA5YTE1ZjFhYWY5OWZhYTc5MTMxMDNmNWVhMTllZjY5NTliNzNkNzYzCiogaHR0cDovL2pxdWVyeW1vYmlsZS5jb20KKgoqIENvcHlyaWdodCAyMDEwLCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMKKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCgooZnVuY3Rpb24gKCByb290LCBkb2MsIGZhY3RvcnkgKSB7CglpZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCQkvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUuCgkJZGVmaW5lKCBbICJqcXVlcnkiIF0sIGZ1bmN0aW9uICggJCApIHsKCQkJZmFjdG9yeSggJCwgcm9vdCwgZG9jICk7CgkJCXJldHVybiAkLm1vYmlsZTsKCQl9KTsKCX0gZWxzZSB7CgkJLy8gQnJvd3NlciBnbG9iYWxzCgkJZmFjdG9yeSggcm9vdC5qUXVlcnksIHJvb3QsIGRvYyApOwoJfQp9KCB0aGlzLCBkb2N1bWVudCwgZnVuY3Rpb24gKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKCgovLyBUaGlzIHBsdWdpbiBpcyBhbiBleHBlcmltZW50IGZvciBhYnN0cmFjdGluZyBhd2F5IHRoZSB0b3VjaCBhbmQgbW91c2UKLy8gZXZlbnRzIHNvIHRoYXQgZGV2ZWxvcGVycyBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IHdoaWNoIG1ldGhvZCBvZiBpbnB1dAovLyB0aGUgZGV2aWNlIHRoZWlyIGRvY3VtZW50IGlzIGxvYWRlZCBvbiBzdXBwb3J0cy4KLy8KLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBhbGxvdyB0aGUgZGV2ZWxvcGVyIHRvIHJlZ2lzdGVyIGxpc3RlbmVycyBmb3IgdGhlCi8vIGJhc2ljIG1vdXNlIGV2ZW50cywgc3VjaCBhcyBtb3VzZWRvd24sIG1vdXNlbW92ZSwgbW91c2V1cCwgYW5kIGNsaWNrLAovLyBhbmQgdGhlIHBsdWdpbiB3aWxsIHRha2UgY2FyZSBvZiByZWdpc3RlcmluZyB0aGUgY29ycmVjdCBsaXN0ZW5lcnMKLy8gYmVoaW5kIHRoZSBzY2VuZXMgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciBhdCB0aGUgZmFzdGVzdCBwb3NzaWJsZSB0aW1lCi8vIGZvciB0aGF0IGRldmljZSwgd2hpbGUgc3RpbGwgcmV0YWluaW5nIHRoZSBvcmRlciBvZiBldmVudCBmaXJpbmcgaW4KLy8gdGhlIHRyYWRpdGlvbmFsIG1vdXNlIGVudmlyb25tZW50LCBzaG91bGQgbXVsdGlwbGUgaGFuZGxlcnMgYmUgcmVnaXN0ZXJlZAovLyBvbiB0aGUgc2FtZSBlbGVtZW50IGZvciBkaWZmZXJlbnQgZXZlbnRzLgovLwovLyBUaGUgY3VycmVudCB2ZXJzaW9uIGV4cG9zZXMgdGhlIGZvbGxvd2luZyB2aXJ0dWFsIGV2ZW50cyB0byBqUXVlcnkgYmluZCBtZXRob2RzOgovLyAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiCgooZnVuY3Rpb24oICQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKCnZhciBkYXRhUHJvcGVydHlOYW1lID0gInZpcnR1YWxNb3VzZUJpbmRpbmdzIiwKCXRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lID0gInZpcnR1YWxUb3VjaElEIiwKCXZpcnR1YWxFdmVudE5hbWVzID0gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIi5zcGxpdCggIiAiICksCgl0b3VjaEV2ZW50UHJvcHMgPSAiY2xpZW50WCBjbGllbnRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSIuc3BsaXQoICIgIiApLAoJbW91c2VIb29rUHJvcHMgPSAkLmV2ZW50Lm1vdXNlSG9va3MgPyAkLmV2ZW50Lm1vdXNlSG9va3MucHJvcHMgOiBbXSwKCW1vdXNlRXZlbnRQcm9wcyA9ICQuZXZlbnQucHJvcHMuY29uY2F0KCBtb3VzZUhvb2tQcm9wcyApLAoJYWN0aXZlRG9jSGFuZGxlcnMgPSB7fSwKCXJlc2V0VGltZXJJRCA9IDAsCglzdGFydFggPSAwLAoJc3RhcnRZID0gMCwKCWRpZFNjcm9sbCA9IGZhbHNlLAoJY2xpY2tCbG9ja0xpc3QgPSBbXSwKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlLAoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2UsCglldmVudENhcHR1cmVTdXBwb3J0ZWQgPSAiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZG9jdW1lbnQsCgkkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJbmV4dFRvdWNoSUQgPSAxLAoJbGFzdFRvdWNoSUQgPSAwOwoKJC52bW91c2UgPSB7Cgltb3ZlRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJY2xpY2tEaXN0YW5jZVRocmVzaG9sZDogMTAsCglyZXNldFRpbWVyRHVyYXRpb246IDE1MDAKfTsKCmZ1bmN0aW9uIGdldE5hdGl2ZUV2ZW50KCBldmVudCApIHsKCgl3aGlsZSAoIGV2ZW50ICYmIHR5cGVvZiBldmVudC5vcmlnaW5hbEV2ZW50ICE9PSAidW5kZWZpbmVkIiApIHsKCQlldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cgl9CglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApIHsKCgl2YXIgdCA9IGV2ZW50LnR5cGUsCgkJb2UsIHByb3BzLCBuZSwgcHJvcCwgY3QsIHRvdWNoLCBpLCBqOwoKCWV2ZW50ID0gJC5FdmVudChldmVudCk7CglldmVudC50eXBlID0gZXZlbnRUeXBlOwoKCW9lID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCXByb3BzID0gJC5ldmVudC5wcm9wczsKCgkvLyBhZGRyZXNzZXMgc2VwYXJhdGlvbiBvZiAkLmV2ZW50LnByb3BzIGluIHRvICQuZXZlbnQubW91c2VIb29rLnByb3BzIGFuZCBJc3N1ZSAzMjgwCgkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzMyODAKCWlmICggdC5zZWFyY2goIC9eKG1vdXNlfGNsaWNrKS8gKSA+IC0xICkgewoJCXByb3BzID0gbW91c2VFdmVudFByb3BzOwoJfQoKCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkvLyBidXQgd2UgZG9uJ3QgaGF2ZSBhIHdheSB0byBmb3JjZSBhbiBldmVudCB0byBiZSBmaXhlZCBtdWx0aXBsZSB0aW1lcwoJaWYgKCBvZSApIHsKCQlmb3IgKCBpID0gcHJvcHMubGVuZ3RoLCBwcm9wOyBpOyApIHsKCQkJcHJvcCA9IHByb3BzWyAtLWkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9lWyBwcm9wIF07CgkJfQoJfQoKCS8vIG1ha2Ugc3VyZSB0aGF0IGlmIHRoZSBtb3VzZSBhbmQgY2xpY2sgdmlydHVhbCBldmVudHMgYXJlIGdlbmVyYXRlZAoJLy8gd2l0aG91dCBhIC53aGljaCBvbmUgaXMgZGVmaW5lZAoJaWYgKCB0LnNlYXJjaCgvbW91c2UoZG93bnx1cCl8Y2xpY2svKSA+IC0xICYmICFldmVudC53aGljaCApewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoY3QgJiYgY3QubGVuZ3RoKSA/IGN0WyAwIF0gOiB1bmRlZmluZWQgKTsKCgkJaWYgKCB0b3VjaCApIHsKCQkJZm9yICggaiA9IDAsIGxlbiA9IHRvdWNoRXZlbnRQcm9wcy5sZW5ndGg7IGogPCBsZW47IGorKyl7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgkJcmVzZXRUaW1lcklEID0gMDsKCQllbmFibGVNb3VzZUJpbmRpbmdzKCk7Cgl9LCAkLnZtb3VzZS5yZXNldFRpbWVyRHVyYXRpb24gKTsKfQoKZnVuY3Rpb24gY2xlYXJSZXNldFRpbWVyKCkgewoJaWYgKCByZXNldFRpbWVySUQgKXsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKGV2ZW50LnRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUpOwoKCWlmICggIWJsb2NrTW91c2VUcmlnZ2VycyAmJiAoICFsYXN0VG91Y2hJRCB8fCBsYXN0VG91Y2hJRCAhPT0gdG91Y2hJRCApICl7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInYiICsgZXZlbnQudHlwZSwgZXZlbnQgKTsKCQlpZiAoIHZlICkgewoJCQlpZiAoIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCQlpZiAoIHZlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCQlpZiAoIHZlLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydCggZXZlbnQgKSB7CgoJdmFyIHRvdWNoZXMgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzLAoJCXRhcmdldCwgZmxhZ3M7CgoJaWYgKCB0b3VjaGVzICYmIHRvdWNoZXMubGVuZ3RoID09PSAxICkgewoKCQl0YXJnZXQgPSBldmVudC50YXJnZXQ7CgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCB0YXJnZXQgKTsKCgkJaWYgKCBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyApIHsKCgkJCWxhc3RUb3VjaElEID0gbmV4dFRvdWNoSUQrKzsKCQkJJC5kYXRhKCB0YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lLCBsYXN0VG91Y2hJRCApOwoKCQkJY2xlYXJSZXNldFRpbWVyKCk7CgoJCQlkaXNhYmxlTW91c2VCaW5kaW5ncygpOwoJCQlkaWRTY3JvbGwgPSBmYWxzZTsKCgkJCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdOwoJCQlzdGFydFggPSB0LnBhZ2VYOwoJCQlzdGFydFkgPSB0LnBhZ2VZOwoKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW92ZXIiLCBldmVudCwgZmxhZ3MgKTsKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWRvd24iLCBldmVudCwgZmxhZ3MgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVNjcm9sbCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICkgKTsKCX0KCglkaWRTY3JvbGwgPSB0cnVlOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF0sCgkJZGlkQ2FuY2VsID0gZGlkU2Nyb2xsLAoJCW1vdmVUaHJlc2hvbGQgPSAkLnZtb3VzZS5tb3ZlRGlzdGFuY2VUaHJlc2hvbGQ7CgkJZGlkU2Nyb2xsID0gZGlkU2Nyb2xsIHx8CgkJCSggTWF0aC5hYnModC5wYWdlWCAtIHN0YXJ0WCkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyh0LnBhZ2VZIC0gc3RhcnRZKSA+IG1vdmVUaHJlc2hvbGQgKSwKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApOwoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdDsKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2V1cCIsIGV2ZW50LCBmbGFncyApOwoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpe30KCmZ1bmN0aW9uIGdldFNwZWNpYWxFdmVudE9iamVjdCggZXZlbnRUeXBlICkgewoJdmFyIHJlYWxUeXBlID0gZXZlbnRUeXBlLnN1YnN0ciggMSApOwoKCXJldHVybiB7CgkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhpcyBlbGVtZW50LAoJCQkvLyBhZGQgYSBiaW5kaW5ncyBvYmplY3QgdG8gaXRzIGRhdGEuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSwge30pOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmIChhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPT09IDEpIHsKCQkJCQkkZG9jdW1lbnQuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCgkJCQkJCS8vIE9uIHRvdWNoIHBsYXRmb3JtcywgdG91Y2hpbmcgdGhlIHNjcmVlbiBhbmQgdGhlbiBkcmFnZ2luZyB5b3VyIGZpbmdlcgoJCQkJCQkvLyBjYXVzZXMgdGhlIHdpbmRvdyBjb250ZW50IHRvIHNjcm9sbCBhZnRlciBzb21lIGRpc3RhbmNlIHRocmVzaG9sZCBpcwoJCQkJCQkvLyBleGNlZWRlZC4gT24gdGhlc2UgcGxhdGZvcm1zLCBhIHNjcm9sbCBwcmV2ZW50cyBhIGNsaWNrIGV2ZW50IGZyb20gYmVpbmcKCQkJCQkJLy8gZGlzcGF0Y2hlZCwgYW5kIG9uIHNvbWUgcGxhdGZvcm1zLCBldmVuIHRoZSB0b3VjaGVuZCBpcyBzdXBwcmVzc2VkLiBUbwoJCQkJCQkvLyBtaW1pYyB0aGUgc3VwcHJlc3Npb24gb2YgdGhlIGNsaWNrIGV2ZW50LCB3ZSBuZWVkIHRvIHdhdGNoIGZvciBhIHNjcm9sbAoJCQkJCQkvLyBldmVudC4gVW5mb3J0dW5hdGVseSwgc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MgZG9uJ3QgZGlzcGF0Y2ggc2Nyb2xsCgkJCQkJCS8vIGV2ZW50cyB1bnRpbCAqQUZURVIqIHRoZSB1c2VyIGxpZnRzIHRoZWlyIGZpbmdlciAodG91Y2hlbmQpLiBUaGlzIG1lYW5zCgkJCQkJCS8vIHdlIG5lZWQgdG8gd2F0Y2ggYm90aCBzY3JvbGwgYW5kIHRvdWNobW92ZSBldmVudHMgdG8gZmlndXJlIG91dCB3aGV0aGVyCgkJCQkJCS8vIG9yIG5vdCBhIHNjcm9sbCBoYXBwZW5lbnMgYmVmb3JlIHRoZSB0b3VjaGVuZCBldmVudCBpcyBmaXJlZC4KCgkJCQkJCS5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCB2YXIgaSA9IDA7IGkgPCB2aXJ0dWFsRXZlbnROYW1lcy5sZW5ndGg7IGkrKyApewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApewoJCXZhciBjbnQgPSBjbGlja0Jsb2NrTGlzdC5sZW5ndGgsCgkJCXRhcmdldCA9IGUudGFyZ2V0LAoJCQl4LCB5LCBlbGUsIGksIG8sIHRvdWNoSUQ7CgoJCWlmICggY250ICkgewoJCQl4ID0gZS5jbGllbnRYOwoJCQl5ID0gZS5jbGllbnRZOwoJCQl0aHJlc2hvbGQgPSAkLnZtb3VzZS5jbGlja0Rpc3RhbmNlVGhyZXNob2xkOwoKCQkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBydW4gdGhyb3VnaCB0aGUgY2xpY2tCbG9ja0xpc3QgdG8gc2VlIGlmCgkJCS8vIHRoZSBjdXJyZW50IGNsaWNrIGV2ZW50IGlzIGluIHRoZSBwcm94aW1pdHkgb2Ygb25lIG9mIG91cgoJCQkvLyB2Y2xpY2sgZXZlbnRzIHRoYXQgaGFkIHByZXZlbnREZWZhdWx0KCkgY2FsbGVkIG9uIGl0LiBJZiB3ZSBmaW5kCgkJCS8vIG9uZSwgdGhlbiB3ZSBibG9jayB0aGUgY2xpY2suCgkJCS8vCgkJCS8vIFdoeSBkbyB3ZSBoYXZlIHRvIHJlbHkgb24gcHJveGltaXR5PwoJCQkvLwoJCQkvLyBCZWNhdXNlIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoIGV2ZW50IHRoYXQgdHJpZ2dlcmVkIHRoZSB2Y2xpY2sKCQkJLy8gY2FuIGJlIGRpZmZlcmVudCBmcm9tIHRoZSB0YXJnZXQgb2YgdGhlIGNsaWNrIGV2ZW50IHN5bnRoZXNpemVkCgkJCS8vIGJ5IHRoZSBicm93c2VyLiBUaGUgdGFyZ2V0IG9mIGEgbW91c2UvY2xpY2sgZXZlbnQgdGhhdCBpcyBzeW50ZWhzaXplZAoJCQkvLyBmcm9tIGEgdG91Y2ggZXZlbnQgc2VlbXMgdG8gYmUgaW1wbGVtZW50YXRpb24gc3BlY2lmaWMuIEZvciBleGFtcGxlLAoJCQkvLyBzb21lIGJyb3dzZXJzIHdpbGwgZmlyZSBtb3VzZS9jbGljayBldmVudHMgZm9yIGEgbGluayB0aGF0IGlzIG5lYXIKCQkJLy8gYSB0b3VjaCBldmVudCwgZXZlbiB0aG91Z2ggdGhlIHRhcmdldCBvZiB0aGUgdG91Y2hzdGFydC90b3VjaGVuZCBldmVudAoJCQkvLyBzYXlzIHRoZSB1c2VyIHRvdWNoZWQgb3V0c2lkZSB0aGUgbGluay4gQWxzbywgaXQgc2VlbXMgdGhhdCB3aXRoIG1vc3QKCQkJLy8gYnJvd3NlcnMsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIGV2ZW50IGlzIG5vdCBjYWxjdWxhdGVkIHVudGlsIHRoZQoJCQkvLyB0aW1lIGl0IGlzIGRpc3BhdGNoZWQsIHNvIGlmIHlvdSByZXBsYWNlIGFuIGVsZW1lbnQgdGhhdCB5b3UgdG91Y2hlZAoJCQkvLyB3aXRoIGFub3RoZXIgZWxlbWVudCwgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgd2lsbCBiZSB0aGUgbmV3CgkJCS8vIGVsZW1lbnQgdW5kZXJuZWF0aCB0aGF0IHBvaW50LgoJCQkvLwoJCQkvLyBBc2lkZSBmcm9tIHByb3hpbWl0eSwgd2UgYWxzbyBjaGVjayB0byBzZWUgaWYgdGhlIHRhcmdldCBhbmQgYW55CgkJCS8vIG9mIGl0cyBhbmNlc3RvcnMgd2VyZSB0aGUgb25lcyB0aGF0IGJsb2NrZWQgYSBjbGljay4gVGhpcyBpcyBuZWNlc3NhcnkKCQkJLy8gYmVjYXVzZSBvZiB0aGUgc3RyYW5nZSBtb3VzZS9jbGljayB0YXJnZXQgY2FsY3VsYXRpb24gZG9uZSBpbiB0aGUKCQkJLy8gQW5kcm9pZCAyLjEgYnJvd3Nlciwgd2hlcmUgaWYgeW91IGNsaWNrIG9uIGFuIGVsZW1lbnQsIGFuZCB0aGVyZSBpcyBhCgkJCS8vIG1vdXNlL2NsaWNrIGhhbmRsZXIgb24gb25lIG9mIGl0cyBhbmNlc3RvcnMsIHRoZSB0YXJnZXQgd2lsbCBiZSB0aGUKCQkJLy8gaW5uZXJtb3N0IGNoaWxkIG9mIHRoZSB0b3VjaGVkIGVsZW1lbnQsIGV2ZW4gaWYgdGhhdCBjaGlsZCBpcyBubyB3aGVyZQoJCQkvLyBuZWFyIHRoZSBwb2ludCBvZiB0b3VjaC4KCgkJCWVsZSA9IHRhcmdldDsKCgkJCXdoaWxlICggZWxlICkgewoJCQkJZm9yICggaSA9IDA7IGkgPCBjbnQ7IGkrKyApIHsKCQkJCQlvID0gY2xpY2tCbG9ja0xpc3RbIGkgXTsKCQkJCQl0b3VjaElEID0gMDsKCgkJCQkJaWYgKCAoIGVsZSA9PT0gdGFyZ2V0ICYmIE1hdGguYWJzKCBvLnggLSB4ICkgPCB0aHJlc2hvbGQgJiYgTWF0aC5hYnMoIG8ueSAtIHkgKSA8IHRocmVzaG9sZCApIHx8CgkJCQkJCQkJJC5kYXRhKCBlbGUsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICkgPT09IG8udG91Y2hJRCApIHsKCQkJCQkJLy8gWFhYOiBXZSBtYXkgd2FudCB0byBjb25zaWRlciByZW1vdmluZyBtYXRjaGVzIGZyb20gdGhlIGJsb2NrIGxpc3QKCQkJCQkJLy8gICAgICBpbnN0ZWFkIG9mIHdhaXRpbmcgZm9yIHRoZSByZXNldCB0aW1lciB0byBmaXJlLgoJCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQl9CgkJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQkJfQoJCX0KCX0sIHRydWUpOwp9Cn0pKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQgKTsKCgoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbigkLHdpbmRvdyx1bmRlZmluZWQpewogIC8vIFJldXNlZCBzdHJpbmcuCiAgdmFyIHN0cl9oYXNoY2hhbmdlID0gJ2hhc2hjaGFuZ2UnLAogICAgCiAgICAvLyBNZXRob2QgLyBvYmplY3QgcmVmZXJlbmNlcy4KICAgIGRvYyA9IGRvY3VtZW50LAogICAgZmFrZV9vbmhhc2hjaGFuZ2UsCiAgICBzcGVjaWFsID0gJC5ldmVudC5zcGVjaWFsLAogICAgCiAgICAvLyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgd2luZG93Lm9uaGFzaGNoYW5nZT8gTm90ZSB0aGF0IElFOCBydW5uaW5nIGluCiAgICAvLyBJRTcgY29tcGF0aWJpbGl0eSBtb2RlIHJlcG9ydHMgdHJ1ZSBmb3IgJ29uaGFzaGNoYW5nZScgaW4gd2luZG93LCBldmVuCiAgICAvLyB0aG91Z2ggdGhlIGV2ZW50IGlzbid0IHN1cHBvcnRlZCwgc28gYWxzbyB0ZXN0IGRvY3VtZW50LmRvY3VtZW50TW9kZS4KICAgIGRvY19tb2RlID0gZG9jLmRvY3VtZW50TW9kZSwKICAgIHN1cHBvcnRzX29uaGFzaGNoYW5nZSA9ICdvbicgKyBzdHJfaGFzaGNoYW5nZSBpbiB3aW5kb3cgJiYgKCBkb2NfbW9kZSA9PT0gdW5kZWZpbmVkIHx8IGRvY19tb2RlID4gNyApOwogIAogIC8vIEdldCBsb2NhdGlvbi5oYXNoIChvciB3aGF0IHlvdSdkIGV4cGVjdCBsb2NhdGlvbi5oYXNoIHRvIGJlKSBzYW5zIGFueQogIC8vIGxlYWRpbmcgIy4gVGhhbmtzIGZvciBtYWtpbmcgdGhpcyBuZWNlc3NhcnksIEZpcmVmb3ghCiAgZnVuY3Rpb24gZ2V0X2ZyYWdtZW50KCB1cmwgKSB7CiAgICB1cmwgPSB1cmwgfHwgbG9jYXRpb24uaHJlZjsKICAgIHJldHVybiAnIycgKyB1cmwucmVwbGFjZSggL15bXiNdKiM/KC4qKSQvLCAnJDEnICk7CiAgfTsKICAKICAvLyBNZXRob2Q6IGpRdWVyeS5mbi5oYXNoY2hhbmdlCiAgLy8gCiAgLy8gQmluZCBhIGhhbmRsZXIgdG8gdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgb3IgdHJpZ2dlciBhbGwgYm91bmQKICAvLyB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXJzLiBUaGlzIGJlaGF2aW9yIGlzIGNvbnNpc3RlbnQgd2l0aAogIC8vIGpRdWVyeSdzIGJ1aWx0LWluIGV2ZW50IGhhbmRsZXJzLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggWyBoYW5kbGVyIF0gKTsKICAvLyAKICAvLyBBcmd1bWVudHM6CiAgLy8gCiAgLy8gIGhhbmRsZXIgLSAoRnVuY3Rpb24pIE9wdGlvbmFsIGhhbmRsZXIgdG8gYmUgYm91bmQgdG8gdGhlIGhhc2hjaGFuZ2UKICAvLyAgICBldmVudC4gVGhpcyBpcyBhICJzaG9ydGN1dCIgZm9yIHRoZSBtb3JlIHZlcmJvc2UgZm9ybToKICAvLyAgICBqUXVlcnkod2luZG93KS5iaW5kKCAnaGFzaGNoYW5nZScsIGhhbmRsZXIgKS4gSWYgaGFuZGxlciBpcyBvbWl0dGVkLAogIC8vICAgIGFsbCBib3VuZCB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXJzIHdpbGwgYmUgdHJpZ2dlcmVkLiBUaGlzCiAgLy8gICAgaXMgYSBzaG9ydGN1dCBmb3IgdGhlIG1vcmUgdmVyYm9zZQogIC8vICAgIGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApLiBUaGVzZSBmb3JtcyBhcmUgZGVzY3JpYmVkIGluCiAgLy8gICAgdGhlIDxoYXNoY2hhbmdlIGV2ZW50PiBzZWN0aW9uLgogIC8vIAogIC8vIFJldHVybnM6CiAgLy8gCiAgLy8gIChqUXVlcnkpIFRoZSBpbml0aWFsIGpRdWVyeSBjb2xsZWN0aW9uIG9mIGVsZW1lbnRzLgogIAogIC8vIEFsbG93IHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKGVsZW0pLmhhc2hjaGFuZ2UoIGZuICkgZm9yIGJpbmRpbmcgYW5kCiAgLy8gJChlbGVtKS5oYXNoY2hhbmdlKCkgZm9yIHRyaWdnZXJpbmcsIGxpa2UgalF1ZXJ5IGRvZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdID0gZnVuY3Rpb24oIGZuICkgewogICAgcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBzdHJfaGFzaGNoYW5nZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICB9OwogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheQogIC8vIAogIC8vIFRoZSBudW1lcmljIGludGVydmFsIChpbiBtaWxsaXNlY29uZHMpIGF0IHdoaWNoIHRoZSA8aGFzaGNoYW5nZSBldmVudD4KICAvLyBwb2xsaW5nIGxvb3AgZXhlY3V0ZXMuIERlZmF1bHRzIHRvIDUwLgogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4KICAvLyAKICAvLyBJZiB5b3UncmUgc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4geW91ciBKYXZhU2NyaXB0LCBhbmQgeW91IHdhbnQgaGFzaAogIC8vIGhpc3RvcnkgdG8gd29yayBpbiBJRTYvNywgbm90IG9ubHkgbXVzdCB0aGlzIHByb3BlcnR5IGJlIHNldCwgYnV0IHlvdSBtdXN0CiAgLy8gYWxzbyBzZXQgZG9jdW1lbnQuZG9tYWluIEJFRk9SRSBqUXVlcnkgaXMgbG9hZGVkIGludG8gdGhlIHBhZ2UuIFRoaXMKICAvLyBwcm9wZXJ0eSBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nCiAgLy8gaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLyAKICAvLyBJbiBhZGRpdGlvbiwgdGhlIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnR5IG11c3QgYmUgc2V0IHRvIHRoZQogIC8vIHBhdGggb2YgdGhlIGluY2x1ZGVkICJkb2N1bWVudC1kb21haW4uaHRtbCIgZmlsZSwgd2hpY2ggY2FuIGJlIHJlbmFtZWQgb3IKICAvLyBtb2RpZmllZCBpZiBuZWNlc3NhcnkgKG5vdGUgdGhhdCB0aGUgZG9jdW1lbnQuZG9tYWluIHNwZWNpZmllZCBtdXN0IGJlIHRoZQogIC8vIHNhbWUgaW4gYm90aCB5b3VyIG1haW4gSmF2YVNjcmlwdCBhcyB3ZWxsIGFzIGluIHRoaXMgZmlsZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluID0gZG9jdW1lbnQuZG9tYWluOwogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMKICAvLyAKICAvLyBJZiwgZm9yIHNvbWUgcmVhc29uLCB5b3UgbmVlZCB0byBzcGVjaWZ5IGFuIElmcmFtZSBzcmMgZmlsZSAoZm9yIGV4YW1wbGUsCiAgLy8gd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBhcyBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPiksIHlvdSBjYW4KICAvLyBkbyBzbyB1c2luZyB0aGlzIHByb3BlcnR5LiBOb3RlIHRoYXQgd2hlbiB1c2luZyB0aGlzIHByb3BlcnR5LCBoaXN0b3J5CiAgLy8gd29uJ3QgYmUgcmVjb3JkZWQgaW4gSUU2LzcgdW50aWwgdGhlIElmcmFtZSBzcmMgZmlsZSBsb2Fkcy4gVGhpcyBwcm9wZXJ0eQogIC8vIGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vIGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYyA9ICdwYXRoL3RvL2ZpbGUuaHRtbCc7CiAgCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kZWxheSA9IDUwOwogIC8qCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW4gPSBudWxsOwogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uc3JjID0gbnVsbDsKICAqLwogIAogIC8vIEV2ZW50OiBoYXNoY2hhbmdlIGV2ZW50CiAgLy8gCiAgLy8gRmlyZWQgd2hlbiBsb2NhdGlvbi5oYXNoIGNoYW5nZXMuIEluIGJyb3dzZXJzIHRoYXQgc3VwcG9ydCBpdCwgdGhlIG5hdGl2ZQogIC8vIEhUTUw1IHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaXMgdXNlZCwgb3RoZXJ3aXNlIGEgcG9sbGluZyBsb29wIGlzCiAgLy8gaW5pdGlhbGl6ZWQsIHJ1bm5pbmcgZXZlcnkgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBtaWxsaXNlY29uZHMgdG8KICAvLyBzZWUgaWYgdGhlIGhhc2ggaGFzIGNoYW5nZWQuIEluIElFNi83IChhbmQgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSksIGEgaGlkZGVuIElmcmFtZSBpcyBjcmVhdGVkIHRvIGFsbG93IHRoZSBiYWNrIGJ1dHRvbgogIC8vIGFuZCBoYXNoLWJhc2VkIGhpc3RvcnkgdG8gd29yay4KICAvLyAKICAvLyBVc2FnZSBhcyBkZXNjcmliZWQgaW4gPGpRdWVyeS5mbi5oYXNoY2hhbmdlPjoKICAvLyAKICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4gCiAgLy8gPiAvLyBNYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSgpOwogIC8vIAogIC8vIEEgbW9yZSB2ZXJib3NlIHVzYWdlIHRoYXQgYWxsb3dzIGZvciBldmVudCBuYW1lc3BhY2luZzoKICAvLyAKICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKTsKICAvLyAKICAvLyBBZGRpdGlvbmFsIE5vdGVzOgogIC8vIAogIC8vICogVGhlIHBvbGxpbmcgbG9vcCBhbmQgSWZyYW1lIGFyZSBub3QgY3JlYXRlZCB1bnRpbCBhdCBsZWFzdCBvbmUgaGFuZGxlcgogIC8vICAgaXMgYWN0dWFsbHkgYm91bmQgdG8gdGhlICdoYXNoY2hhbmdlJyBldmVudC4KICAvLyAqIElmIHlvdSBuZWVkIHRoZSBib3VuZCBoYW5kbGVyKHMpIHRvIGV4ZWN1dGUgaW1tZWRpYXRlbHksIGluIGNhc2VzIHdoZXJlCiAgLy8gICBhIGxvY2F0aW9uLmhhc2ggZXhpc3RzIG9uIHBhZ2UgbG9hZCwgdmlhIGJvb2ttYXJrIG9yIHBhZ2UgcmVmcmVzaCBmb3IKICAvLyAgIGV4YW1wbGUsIHVzZSBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCkgb3IgdGhlIG1vcmUgdmVyYm9zZSAKICAvLyAgIGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApLgogIC8vICogVGhlIGV2ZW50IGNhbiBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgc2luY2UgaXQgd29uJ3QgYmUgdXNhYmxlCiAgLy8gICBiZWZvcmUgdGhlbiBpbiBJRTYvNyAoZHVlIHRvIHRoZSBuZWNlc3NhcnkgSWZyYW1lKSwgcmVjb21tZW5kZWQgdXNhZ2UgaXMKICAvLyAgIHRvIGJpbmQgaXQgaW5zaWRlIGEgRE9NIHJlYWR5IGhhbmRsZXIuCiAgCiAgLy8gT3ZlcnJpZGUgZXhpc3RpbmcgJC5ldmVudC5zcGVjaWFsLmhhc2hjaGFuZ2UgbWV0aG9kcyAoYWxsb3dpbmcgdGhpcyBwbHVnaW4KICAvLyB0byBiZSBkZWZpbmVkIGFmdGVyIGpRdWVyeSBCQlEgaW4gQkJRJ3Mgc291cmNlIGNvZGUpLgogIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0gPSAkLmV4dGVuZCggc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSwgewogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBmaXJzdCAnaGFzaGNoYW5nZScgZXZlbnQgaXMgYm91bmQgdG8gd2luZG93LgogICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIGNyZWF0ZSBvdXIgb3duLiBBbmQgd2UgZG9uJ3Qgd2FudCB0byBjYWxsIHRoaXMKICAgICAgLy8gdW50aWwgdGhlIHVzZXIgYmluZHMgdG8gdGhlIGV2ZW50LCBqdXN0IGluIGNhc2UgdGhleSBuZXZlciBkbywgc2luY2UgaXQKICAgICAgLy8gd2lsbCBjcmVhdGUgYSBwb2xsaW5nIGxvb3AgYW5kIHBvc3NpYmx5IGV2ZW4gYSBoaWRkZW4gSWZyYW1lLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdGFydCApOwogICAgfSwKICAgIAogICAgLy8gQ2FsbGVkIG9ubHkgd2hlbiB0aGUgbGFzdCAnaGFzaGNoYW5nZScgZXZlbnQgaXMgdW5ib3VuZCBmcm9tIHdpbmRvdy4KICAgIHRlYXJkb3duOiBmdW5jdGlvbigpIHsKICAgICAgLy8gSWYgd2luZG93Lm9uaGFzaGNoYW5nZSBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoZXJlJ3Mgbm90aGluZyB0byBkby4uCiAgICAgIGlmICggc3VwcG9ydHNfb25oYXNoY2hhbmdlICkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgCiAgICAgIC8vIE90aGVyd2lzZSwgd2UgbmVlZCB0byBzdG9wIG91cnMgKGlmIHBvc3NpYmxlKS4KICAgICAgJCggZmFrZV9vbmhhc2hjaGFuZ2Uuc3RvcCApOwogICAgfQogICAgCiAgfSk7CiAgCiAgLy8gZmFrZV9vbmhhc2hjaGFuZ2UgZG9lcyBhbGwgdGhlIHdvcmsgb2YgdHJpZ2dlcmluZyB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZQogIC8vIGV2ZW50IGZvciBicm93c2VycyB0aGF0IGRvbid0IG5hdGl2ZWx5IHN1cHBvcnQgaXQsIGluY2x1ZGluZyBjcmVhdGluZyBhCiAgLy8gcG9sbGluZyBsb29wIHRvIHdhdGNoIGZvciBoYXNoIGNoYW5nZXMgYW5kIGluIElFIDYvNyBjcmVhdGluZyBhIGhpZGRlbgogIC8vIElmcmFtZSB0byBlbmFibGUgYmFjayBhbmQgZm9yd2FyZC4KICBmYWtlX29uaGFzaGNoYW5nZSA9IChmdW5jdGlvbigpewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKHZhbCl7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgICQuYnJvd3Nlci5tc2llICYmICFzdXBwb3J0c19vbmhhc2hjaGFuZ2UgJiYgKGZ1bmN0aW9uKCl7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KICAgICAgCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKICAgICAgCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpewogICAgICAgIGlmICggIWlmcmFtZSApIHsKICAgICAgICAgIGlmcmFtZV9zcmMgPSAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLnNyYzsKICAgICAgICAgIGlmcmFtZV9zcmMgPSBpZnJhbWVfc3JjICYmIGlmcmFtZV9zcmMgKyBnZXRfZnJhZ21lbnQoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gQ3JlYXRlIGhpZGRlbiBJZnJhbWUuIEF0dGVtcHQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlCiAgICAgICAgICAvLyBieSB1c2luZyB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4KICAgICAgICAgIGlmcmFtZSA9ICQoJzxpZnJhbWUgdGFiaW5kZXg9Ii0xIiB0aXRsZT0iZW1wdHkiLz4nKS5oaWRlKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFdoZW4gSWZyYW1lIGhhcyBjb21wbGV0ZWx5IGxvYWRlZCwgaW5pdGlhbGl6ZSB0aGUgaGlzdG9yeSBhbmQKICAgICAgICAgICAgLy8gc3RhcnQgcG9sbGluZy4KICAgICAgICAgICAgLm9uZSggJ2xvYWQnLCBmdW5jdGlvbigpewogICAgICAgICAgICAgIGlmcmFtZV9zcmMgfHwgaGlzdG9yeV9zZXQoIGdldF9mcmFnbWVudCgpICk7CiAgICAgICAgICAgICAgcG9sbCgpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTG9hZCBJZnJhbWUgc3JjIGlmIHNwZWNpZmllZCwgb3RoZXJ3aXNlIG5vdGhpbmcuCiAgICAgICAgICAgIC5hdHRyKCAnc3JjJywgaWZyYW1lX3NyYyB8fCAnamF2YXNjcmlwdDowJyApCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBlbmQgSWZyYW1lIGFmdGVyIHRoZSBlbmQgb2YgdGhlIGJvZHkgdG8gcHJldmVudCB1bm5lY2Vzc2FyeQogICAgICAgICAgICAvLyBpbml0aWFsIHBhZ2Ugc2Nyb2xsaW5nICh5ZXMsIHRoaXMgd29ya3MpLgogICAgICAgICAgICAuaW5zZXJ0QWZ0ZXIoICdib2R5JyApWzBdLmNvbnRlbnRXaW5kb3c7CiAgICAgICAgICAKICAgICAgICAgIC8vIFdoZW5ldmVyIGBkb2N1bWVudC50aXRsZWAgY2hhbmdlcywgdXBkYXRlIHRoZSBJZnJhbWUncyB0aXRsZSB0bwogICAgICAgICAgLy8gcHJldHRpZnkgdGhlIGJhY2svbmV4dCBoaXN0b3J5IG1lbnUgZW50cmllcy4gU2luY2UgSUUgc29tZXRpbWVzCiAgICAgICAgICAvLyBlcnJvcnMgd2l0aCAiVW5zcGVjaWZpZWQgZXJyb3IiIHRoZSB2ZXJ5IGZpcnN0IHRpbWUgdGhpcyBpcyBzZXQKICAgICAgICAgIC8vICh5ZXMsIHZlcnkgdXNlZnVsKSB3cmFwIHRoaXMgd2l0aCBhIHRyeS9jYXRjaCBibG9jay4KICAgICAgICAgIGRvYy5vbnByb3BlcnR5Y2hhbmdlID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoIGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3RpdGxlJyApIHsKICAgICAgICAgICAgICAgIGlmcmFtZS5kb2N1bWVudC50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKICAgICAgCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CiAgICAgIAogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CiAgICAgICAgCiAgICAgICAgaWYgKCBoYXNoICE9PSBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgICAvLyBVcGRhdGUgSWZyYW1lIHdpdGggYW55IGluaXRpYWwgYGRvY3VtZW50LnRpdGxlYCB0aGF0IG1pZ2h0IGJlIHNldC4KICAgICAgICAgIGlmcmFtZV9kb2MudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTZXQgZG9jdW1lbnQuZG9tYWluIGZvciB0aGUgSWZyYW1lIGRvY3VtZW50IGFzIHdlbGwsIGlmIG5lY2Vzc2FyeS4KICAgICAgICAgIGRvbWFpbiAmJiBpZnJhbWVfZG9jLndyaXRlKCAnPHNjcmlwdD5kb2N1bWVudC5kb21haW49IicgKyBkb21haW4gKyAnIjwvc2NyaXB0PicgKTsKICAgICAgICAgIAogICAgICAgICAgaWZyYW1lX2RvYy5jbG9zZSgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBVcGRhdGUgdGhlIElmcmFtZSdzIGhhc2gsIGZvciBncmVhdCBqdXN0aWNlLgogICAgICAgICAgaWZyYW1lLmxvY2F0aW9uLmhhc2ggPSBoYXNoOwogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICB9KSgpOwogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eIFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IF5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgCiAgICByZXR1cm4gc2VsZjsKICB9KSgpOwogIAp9KShqUXVlcnksdGhpcyk7CgovKiEKICogalF1ZXJ5IFVJIFdpZGdldCBAVkVSU0lPTgogKgogKiBDb3B5cmlnaHQgMjAxMCwgQVVUSE9SUy50eHQgKGh0dHA6Ly9qcXVlcnl1aS5jb20vYWJvdXQpCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9kb2NzLmpxdWVyeS5jb20vVUkvV2lkZ2V0CiAqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBqUXVlcnkgMS40KwppZiAoICQuY2xlYW5EYXRhICkgewoJdmFyIF9jbGVhbkRhdGEgPSAkLmNsZWFuRGF0YTsKCSQuY2xlYW5EYXRhID0gZnVuY3Rpb24oIGVsZW1zICkgewoJCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQkkKCBlbGVtICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJfQoJCV9jbGVhbkRhdGEoIGVsZW1zICk7Cgl9Owp9IGVsc2UgewoJdmFyIF9yZW1vdmUgPSAkLmZuLnJlbW92ZTsKCSQuZm4ucmVtb3ZlID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBrZWVwRGF0YSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoICFrZWVwRGF0YSApIHsKCQkJCWlmICggIXNlbGVjdG9yIHx8ICQuZmlsdGVyKCBzZWxlY3RvciwgWyB0aGlzIF0gKS5sZW5ndGggKSB7CgkJCQkJJCggIioiLCB0aGlzICkuYWRkKCBbIHRoaXMgXSApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJCSQoIHRoaXMgKS50cmlnZ2VySGFuZGxlciggInJlbW92ZSIgKTsKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gX3JlbW92ZS5jYWxsKCAkKHRoaXMpLCBzZWxlY3Rvciwga2VlcERhdGEgKTsKCQl9KTsKCX07Cn0KCiQud2lkZ2V0ID0gZnVuY3Rpb24oIG5hbWUsIGJhc2UsIHByb3RvdHlwZSApIHsKCXZhciBuYW1lc3BhY2UgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMCBdLAoJCWZ1bGxOYW1lOwoJbmFtZSA9IG5hbWUuc3BsaXQoICIuIiApWyAxIF07CglmdWxsTmFtZSA9IG5hbWVzcGFjZSArICItIiArIG5hbWU7CgoJaWYgKCAhcHJvdG90eXBlICkgewoJCXByb3RvdHlwZSA9IGJhc2U7CgkJYmFzZSA9ICQuV2lkZ2V0OwoJfQoKCS8vIGNyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZSBdID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBuYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CgkkWyBuYW1lc3BhY2UgXVsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9Cgl9OwoKCXZhciBiYXNlUHJvdG90eXBlID0gbmV3IGJhc2UoKTsKCS8vIHdlIG5lZWQgdG8gbWFrZSB0aGUgb3B0aW9ucyBoYXNoIGEgcHJvcGVydHkgZGlyZWN0bHkgb24gdGhlIG5ldyBpbnN0YW5jZQoJLy8gb3RoZXJ3aXNlIHdlJ2xsIG1vZGlmeSB0aGUgb3B0aW9ucyBoYXNoIG9uIHRoZSBwcm90b3R5cGUgdGhhdCB3ZSdyZQoJLy8gaW5oZXJpdGluZyBmcm9tCi8vCSQuZWFjaCggYmFzZVByb3RvdHlwZSwgZnVuY3Rpb24oIGtleSwgdmFsICkgewovLwkJaWYgKCAkLmlzUGxhaW5PYmplY3QodmFsKSApIHsKLy8JCQliYXNlUHJvdG90eXBlWyBrZXkgXSA9ICQuZXh0ZW5kKCB7fSwgdmFsICk7Ci8vCQl9Ci8vCX0pOwoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC5leHRlbmQoIHRydWUsIHt9LCBiYXNlUHJvdG90eXBlLm9wdGlvbnMgKTsKCSRbIG5hbWVzcGFjZSBdWyBuYW1lIF0ucHJvdG90eXBlID0gJC5leHRlbmQoIHRydWUsIGJhc2VQcm90b3R5cGUsIHsKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCXdpZGdldEV2ZW50UHJlZml4OiAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdLnByb3RvdHlwZS53aWRnZXRFdmVudFByZWZpeCB8fCBuYW1lLAoJCXdpZGdldEJhc2VDbGFzczogZnVsbE5hbWUKCX0sIHByb3RvdHlwZSApOwoKCSQud2lkZ2V0LmJyaWRnZSggbmFtZSwgJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSApOwp9OwoKJC53aWRnZXQuYnJpZGdlID0gZnVuY3Rpb24oIG5hbWUsIG9iamVjdCApIHsKCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBpc01ldGhvZENhbGwgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIsCgkJCWFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLmV4dGVuZC5hcHBseSggbnVsbCwgWyB0cnVlLCBvcHRpb25zIF0uY29uY2F0KGFyZ3MpICkgOgoJCQlvcHRpb25zOwoKCQkvLyBwcmV2ZW50IGNhbGxzIHRvIGludGVybmFsIG1ldGhvZHMKCQlpZiAoIGlzTWV0aG9kQ2FsbCAmJiBvcHRpb25zLmNoYXJBdCggMCApID09PSAiXyIgKSB7CgkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQl9CgoJCWlmICggaXNNZXRob2RDYWxsICkgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIG5hbWUgKTsKCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXRocm93ICJjYW5ub3QgY2FsbCBtZXRob2RzIG9uICIgKyBuYW1lICsgIiBwcmlvciB0byBpbml0aWFsaXphdGlvbjsgIiArCgkJCQkJCSJhdHRlbXB0ZWQgdG8gY2FsbCBtZXRob2QgJyIgKyBvcHRpb25zICsgIiciOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApICkgewoJCQkJCXRocm93ICJubyBzdWNoIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyBmb3IgIiArIG5hbWUgKyAiIHdpZGdldCBpbnN0YW5jZSI7CgkJCQl9CgkJCQl2YXIgbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBuYW1lICk7CgkJCQlpZiAoIGluc3RhbmNlICkgewoJCQkJCWluc3RhbmNlLm9wdGlvbiggb3B0aW9ucyB8fCB7fSApLl9pbml0KCk7CgkJCQl9IGVsc2UgewoJCQkJCSQuZGF0YSggdGhpcywgbmFtZSwgbmV3IG9iamVjdCggb3B0aW9ucywgdGhpcyApICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfTsKfTsKCiQuV2lkZ2V0ID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCX0KfTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJb3B0aW9uczogewoJCWRpc2FibGVkOiBmYWxzZQoJfSwKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vICQud2lkZ2V0LmJyaWRnZSBzdG9yZXMgdGhlIHBsdWdpbiBpbnN0YW5jZSwgYnV0IHdlIGRvIGl0IGFueXdheQoJCS8vIHNvIHRoYXQgaXQncyBzdG9yZWQgZXZlbiBiZWZvcmUgdGhlIF9jcmVhdGUgZnVuY3Rpb24gcnVucwoJCSQuZGF0YSggZWxlbWVudCwgdGhpcy53aWRnZXROYW1lLCB0aGlzICk7CgkJdGhpcy5lbGVtZW50ID0gJCggZWxlbWVudCApOwoJCXRoaXMub3B0aW9ucyA9ICQuZXh0ZW5kKCB0cnVlLCB7fSwKCQkJdGhpcy5vcHRpb25zLAoJCQl0aGlzLl9nZXRDcmVhdGVPcHRpb25zKCksCgkJCW9wdGlvbnMgKTsKCgkJdmFyIHNlbGYgPSB0aGlzOwoJCXRoaXMuZWxlbWVudC5iaW5kKCAicmVtb3ZlLiIgKyB0aGlzLndpZGdldE5hbWUsIGZ1bmN0aW9uKCkgewoJCQlzZWxmLmRlc3Ryb3koKTsKCQl9KTsKCgkJdGhpcy5fY3JlYXRlKCk7CgkJdGhpcy5fdHJpZ2dlciggImNyZWF0ZSIgKTsKCQl0aGlzLl9pbml0KCk7Cgl9LAoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0ge307CgkJaWYgKCAkLm1ldGFkYXRhICkgewoJCQlvcHRpb25zID0gJC5tZXRhZGF0YS5nZXQoIGVsZW1lbnQgKVsgdGhpcy53aWRnZXROYW1lIF07CgkJfQoJCXJldHVybiBvcHRpb25zOwoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkge30sCglfaW5pdDogZnVuY3Rpb24oKSB7fSwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQKCQkJLnVuYmluZCggIi4iICsgdGhpcy53aWRnZXROYW1lICkKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0TmFtZSApOwoJCXRoaXMud2lkZ2V0KCkKCQkJLnVuYmluZCggIi4iICsgdGhpcy53aWRnZXROYW1lICkKCQkJLnJlbW92ZUF0dHIoICJhcmlhLWRpc2FibGVkIiApCgkJCS5yZW1vdmVDbGFzcygKCQkJCXRoaXMud2lkZ2V0QmFzZUNsYXNzICsgIi1kaXNhYmxlZCAiICsKCQkJCSJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJfSwKCglvcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBvcHRpb25zID0ga2V5OwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDAgKSB7CgkJCS8vIGRvbid0IHJldHVybiBhIHJlZmVyZW5jZSB0byB0aGUgaW50ZXJuYWwgaGFzaAoJCQlyZXR1cm4gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICAodHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiB0aGlzLm9wdGlvbnNbIGtleSBdOwoJCQl9CgkJCW9wdGlvbnMgPSB7fTsKCQkJb3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQl9CgoJCXRoaXMuX3NldE9wdGlvbnMoIG9wdGlvbnMgKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBzZWxmID0gdGhpczsKCQkkLmVhY2goIG9wdGlvbnMsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQlzZWxmLl9zZXRPcHRpb24oIGtleSwgdmFsdWUgKTsKCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy53aWRnZXQoKQoJCQkJWyB2YWx1ZSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiXSgKCQkJCQl0aGlzLndpZGdldEJhc2VDbGFzcyArICItZGlzYWJsZWQiICsgIiAiICsKCQkJCQkidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQl2YXIgY2FsbGJhY2sgPSB0aGlzLm9wdGlvbnNbIHR5cGUgXTsKCgkJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSAoIHR5cGUgPT09IHRoaXMud2lkZ2V0RXZlbnRQcmVmaXggPwoJCQl0eXBlIDoKCQkJdGhpcy53aWRnZXRFdmVudFByZWZpeCArIHR5cGUgKS50b0xvd2VyQ2FzZSgpOwoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCQkvLyBidXQgd2UgZG9uJ3QgaGF2ZSBhIHdheSB0byBmb3JjZSBhbiBldmVudCB0byBiZSBmaXhlZCBtdWx0aXBsZSB0aW1lcwoJCWlmICggZXZlbnQub3JpZ2luYWxFdmVudCApIHsKCQkJZm9yICggdmFyIGkgPSAkLmV2ZW50LnByb3BzLmxlbmd0aCwgcHJvcDsgaTsgKSB7CgkJCQlwcm9wID0gJC5ldmVudC5wcm9wc1sgLS1pIF07CgkJCQlldmVudFsgcHJvcCBdID0gZXZlbnQub3JpZ2luYWxFdmVudFsgcHJvcCBdOwoJCQl9CgkJfQoKCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggZXZlbnQsIGRhdGEgKTsKCgkJcmV0dXJuICEoICQuaXNGdW5jdGlvbihjYWxsYmFjaykgJiYKCQkJY2FsbGJhY2suY2FsbCggdGhpcy5lbGVtZW50WzBdLCBldmVudCwgZGF0YSApID09PSBmYWxzZSB8fAoJCQlldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApOwoJfQp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS53aWRnZXQiLCB7CgkvLyBkZWNvcmF0ZSB0aGUgcGFyZW50IF9jcmVhdGVXaWRnZXQgdG8gdHJpZ2dlciBgd2lkZ2V0aW5pdGAgZm9yIHVzZXJzCgkvLyB3aG8gd2lzaCB0byBkbyBwb3N0IHBvc3QgYHdpZGdldGNyZWF0ZWAgYWx0ZXJhdGlvbnMvYWRkaXRpb25zCgkvLwoJLy8gVE9ETyBjcmVhdGUgYSBwdWxsIHJlcXVlc3QgZm9yIGpxdWVyeSB1aSB0byB0cmlnZ2VyIHRoaXMgZXZlbnQKCS8vIGluIHRoZSBvcmlnaW5hbCBfY3JlYXRlV2lkZ2V0CglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQkkLldpZGdldC5wcm90b3R5cGUuX2NyZWF0ZVdpZGdldC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fdHJpZ2dlciggJ2luaXQnICk7Cgl9LAoKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdGlvbnMgPSB7fTsKCgkJJC5lYWNoKCB0aGlzLm9wdGlvbnMsIGZ1bmN0aW9uKCBvcHRpb24gKSB7CgoJCQl2YXIgdmFsdWUgPSBlbGVtLmpxbURhdGEoIG9wdGlvbi5yZXBsYWNlKCAvW0EtWl0vZywgZnVuY3Rpb24oIGMgKSB7CgkJCQkJCQlyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwoJCQkJCQl9KQoJCQkJCSk7CgoJCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvcHRpb25zWyBvcHRpb24gXSA9IHZhbHVlOwoJCQl9CgkJfSk7CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCgllbmhhbmNlV2l0aGluOiBmdW5jdGlvbiggdGFyZ2V0LCB1c2VLZWVwTmF0aXZlICkgewoJCXRoaXMuZW5oYW5jZSggJCggdGhpcy5vcHRpb25zLmluaXRTZWxlY3RvciwgJCggdGFyZ2V0ICkpLCB1c2VLZWVwTmF0aXZlICk7Cgl9LAoKCWVuaGFuY2U6IGZ1bmN0aW9uKCB0YXJnZXRzLCB1c2VLZWVwTmF0aXZlICkgewoJCXZhciBwYWdlLCBrZWVwTmF0aXZlLCAkd2lkZ2V0RWxlbWVudHMgPSAkKCB0YXJnZXRzICksIHNlbGYgPSB0aGlzOwoKCQkvLyBpZiBpZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgdG8gdHJ1ZSB0aGUgZnJhbWV3b3JrIHNob3VsZAoJCS8vIG9ubHkgZW5oYW5jZSB0aGUgc2VsZWN0ZWQgZWxlbWVudHMgd2hlbiB0aGV5IGRvIE5PVCBoYXZlIGEKCQkvLyBwYXJlbnQgd2l0aCB0aGUgZGF0YS1uYW1lc3BhY2UtaWdub3JlIGF0dHJpYnV0ZQoJCSR3aWRnZXRFbGVtZW50cyA9ICQubW9iaWxlLmVuaGFuY2VhYmxlKCAkd2lkZ2V0RWxlbWVudHMgKTsKCgkJaWYgKCB1c2VLZWVwTmF0aXZlICYmICR3aWRnZXRFbGVtZW50cy5sZW5ndGggKSB7CgkJCS8vIFRPRE8gcmVtb3ZlIGRlcGVuZGVuY3kgb24gdGhlIHBhZ2Ugd2lkZ2V0IGZvciB0aGUga2VlcE5hdGl2ZS4KCQkJLy8gQ3VycmVudGx5IHRoZSBrZWVwTmF0aXZlIHZhbHVlIGlzIGRlZmluZWQgb24gdGhlIHBhZ2UgcHJvdG90eXBlIHNvCgkJCS8vIHRoZSBtZXRob2QgaXMgYXMgd2VsbAoJCQlwYWdlID0gJC5tb2JpbGUuY2xvc2VzdFBhZ2VEYXRhKCAkd2lkZ2V0RWxlbWVudHMgKTsKCQkJa2VlcE5hdGl2ZSA9IChwYWdlICYmIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkpIHx8ICIiOwoKCQkJJHdpZGdldEVsZW1lbnRzID0gJHdpZGdldEVsZW1lbnRzLm5vdCgga2VlcE5hdGl2ZSApOwoJCX0KCgkJJHdpZGdldEVsZW1lbnRzWyB0aGlzLndpZGdldE5hbWUgXSgpOwoJfSwKCglyYWlzZTogZnVuY3Rpb24oIG1zZyApIHsKCQl0aHJvdyAiV2lkZ2V0IFsiICsgdGhpcy53aWRnZXROYW1lICsgIl06ICIgKyBtc2c7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCgl2YXIgbnNOb3JtYWxpemVEaWN0ID0ge307CgoJLy8galF1ZXJ5Lm1vYmlsZSBjb25maWd1cmFibGUgb3B0aW9ucwoJJC5tb2JpbGUgPSAkLmV4dGVuZCgge30sIHsKCgkJLy8gVmVyc2lvbiBvZiB0aGUgalF1ZXJ5IE1vYmlsZSBGcmFtZXdvcmsKCQl2ZXJzaW9uOiAiMS4xLjIiLAoKCQkvLyBOYW1lc3BhY2UgdXNlZCBmcmFtZXdvcmstd2lkZSBmb3IgZGF0YS1hdHRycy4gRGVmYXVsdCBpcyBubyBuYW1lc3BhY2UKCQluczogIiIsCgoJCS8vIERlZmluZSB0aGUgdXJsIHBhcmFtZXRlciB1c2VkIGZvciByZWZlcmVuY2luZyB3aWRnZXQtZ2VuZXJhdGVkIHN1Yi1wYWdlcy4KCQkvLyBUcmFuc2xhdGVzIHRvIHRvIGV4YW1wbGUuaHRtbCZ1aS1wYWdlPXN1YnBhZ2VJZGVudGlmaWVyCgkJLy8gaGFzaCBzZWdtZW50IGJlZm9yZSAmdWktcGFnZT0gaXMgdXNlZCB0byBtYWtlIEFqYXggcmVxdWVzdAoJCXN1YlBhZ2VVcmxLZXk6ICJ1aS1wYWdlIiwKCgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImFjdGl2ZSIgYnV0dG9uIHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlhY3RpdmVCdG5DbGFzczogInVpLWJ0bi1hY3RpdmUiLAoKCQkvLyBDbGFzcyB1c2VkIGZvciAiZm9jdXMiIGZvcm0gZWxlbWVudCBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJZm9jdXNDbGFzczogInVpLWZvY3VzIiwKCgkJLy8gQXV0b21hdGljYWxseSBoYW5kbGUgY2xpY2tzIGFuZCBmb3JtIHN1Ym1pc3Npb25zIHRocm91Z2ggQWpheCwgd2hlbiBzYW1lLWRvbWFpbgoJCWFqYXhFbmFibGVkOiB0cnVlLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGxvYWQgYW5kIHNob3cgcGFnZXMgYmFzZWQgb24gbG9jYXRpb24uaGFzaAoJCWhhc2hMaXN0ZW5pbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBkaXNhYmxlIHRvIHByZXZlbnQganF1ZXJ5IGZyb20gYm90aGVyaW5nIHdpdGggbGlua3MKCQlsaW5rQmluZGluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIFNldCBkZWZhdWx0IHBhZ2UgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0UGFnZVRyYW5zaXRpb246ICJmYWRlIiwKCgkJLy8gU2V0IG1heGltdW0gd2luZG93IHdpZHRoIGZvciB0cmFuc2l0aW9ucyB0byBhcHBseSAtICdmYWxzZScgZm9yIG5vIGxpbWl0CgkJbWF4VHJhbnNpdGlvbldpZHRoOiBmYWxzZSwKCgkJLy8gTWluaW11bSBzY3JvbGwgZGlzdGFuY2UgdGhhdCB3aWxsIGJlIHJlbWVtYmVyZWQgd2hlbiByZXR1cm5pbmcgdG8gYSBwYWdlCgkJbWluU2Nyb2xsQmFjazogMjUwLAoKCQkvLyBERVBSRUNBVEVEOiB0aGUgZm9sbG93aW5nIHByb3BlcnR5IGlzIG5vIGxvbmdlciBpbiB1c2UsIGJ1dCBkZWZpbmVkIHVudGlsIDIuMCB0byBwcmV2ZW50IGNvbmZsaWN0cwoJCXRvdWNoT3ZlcmZsb3dFbmFibGVkOiBmYWxzZSwKCgkJLy8gU2V0IGRlZmF1bHQgZGlhbG9nIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdERpYWxvZ1RyYW5zaXRpb246ICJwb3AiLAoKCQkvLyBTaG93IGxvYWRpbmcgbWVzc2FnZSBkdXJpbmcgQWpheCByZXF1ZXN0cwoJCS8vIGlmIGZhbHNlLCBtZXNzYWdlIHdpbGwgbm90IGFwcGVhciwgYnV0IGxvYWRpbmcgY2xhc3NlcyB3aWxsIHN0aWxsIGJlIHRvZ2dsZWQgb24gaHRtbCBlbAoJCWxvYWRpbmdNZXNzYWdlOiAibG9hZGluZyIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vIFNob3VsZCB0aGUgdGV4dCBiZSB2aXNibGUgaW4gdGhlIGxvYWRpbmcgbWVzc2FnZT8KCQlsb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOiBmYWxzZSwKCgkJLy8gV2hlbiB0aGUgdGV4dCBpcyB2aXNpYmxlLCB3aGF0IHRoZW1lIGRvZXMgdGhlIGxvYWRpbmcgYm94IHVzZT8KCQlsb2FkaW5nTWVzc2FnZVRoZW1lOiAiYSIsCgoJCS8vIEZvciBlcnJvciBtZXNzYWdlcywgd2hpY2ggdGhlbWUgZG9lcyB0aGUgYm94IHVzZXM/CgkJcGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZTogImUiLAoKCQkvLyByZXBsYWNlIGNhbGxzIHRvIHdpbmRvdy5oaXN0b3J5LmJhY2sgd2l0aCBwaG9uZWdhcHMgbmF2aWdhdGlvbiBoZWxwZXIKCQkvLyB3aGVyZSBpdCBpcyBwcm92aWRlZCBvbiB0aGUgd2luZG93IG9iamVjdAoJCXBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQ6IGZhbHNlLAoKCQkvL2F1dG9tYXRpY2FsbHkgaW5pdGlhbGl6ZSB0aGUgRE9NIHdoZW4gaXQncyByZWFkeQoJCWF1dG9Jbml0aWFsaXplUGFnZTogdHJ1ZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gYWxsb3dzIHVzZXJzIHRvIG9wdCBpbiB0byBpZ25vcmluZyBjb250ZW50IGJ5IG1hcmtpbmcgYSBwYXJlbnQgZWxlbWVudCBhcwoJCS8vIGRhdGEtaWdub3JlZAoJCWlnbm9yZUNvbnRlbnRFbmFibGVkOiBmYWxzZSwKCgkJLy8gdHVybiBvZiBiaW5kaW5nIHRvIHRoZSBuYXRpdmUgb3JpZW50YXRpb25jaGFuZ2UgZHVlIHRvIGFuZHJvaWQgb3JpZW50YXRpb24gYmVoYXZpb3IKCQlvcmllbnRhdGlvbkNoYW5nZUVuYWJsZWQ6IHRydWUsCgoJCWJ1dHRvbk1hcmt1cDogewoJCQlob3ZlckRlbGF5OiAyMDAKCQl9LAoKCQkvLyBUT0RPIG1pZ2h0IGJlIHVzZWZ1bCB1cHN0cmVhbSBpbiBqcXVlcnkgaXRzZWxmID8KCQlrZXlDb2RlOiB7CgkJCUFMVDogMTgsCgkJCUJBQ0tTUEFDRTogOCwKCQkJQ0FQU19MT0NLOiAyMCwKCQkJQ09NTUE6IDE4OCwKCQkJQ09NTUFORDogOTEsCgkJCUNPTU1BTkRfTEVGVDogOTEsIC8vIENPTU1BTkQKCQkJQ09NTUFORF9SSUdIVDogOTMsCgkJCUNPTlRST0w6IDE3LAoJCQlERUxFVEU6IDQ2LAoJCQlET1dOOiA0MCwKCQkJRU5EOiAzNSwKCQkJRU5URVI6IDEzLAoJCQlFU0NBUEU6IDI3LAoJCQlIT01FOiAzNiwKCQkJSU5TRVJUOiA0NSwKCQkJTEVGVDogMzcsCgkJCU1FTlU6IDkzLCAvLyBDT01NQU5EX1JJR0hUCgkJCU5VTVBBRF9BREQ6IDEwNywKCQkJTlVNUEFEX0RFQ0lNQUw6IDExMCwKCQkJTlVNUEFEX0RJVklERTogMTExLAoJCQlOVU1QQURfRU5URVI6IDEwOCwKCQkJTlVNUEFEX01VTFRJUExZOiAxMDYsCgkJCU5VTVBBRF9TVUJUUkFDVDogMTA5LAoJCQlQQUdFX0RPV046IDM0LAoJCQlQQUdFX1VQOiAzMywKCQkJUEVSSU9EOiAxOTAsCgkJCVJJR0hUOiAzOSwKCQkJU0hJRlQ6IDE2LAoJCQlTUEFDRTogMzIsCgkJCVRBQjogOSwKCQkJVVA6IDM4LAoJCQlXSU5ET1dTOiA5MSAvLyBDT01NQU5ECgkJfSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkKCBkb2N1bWVudCApLnRyaWdnZXIoICJzaWxlbnRzY3JvbGwiLCB7IHg6IDAsIHk6IHlwb3MgfSk7CgkJCX0sIDIwICk7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQl9LCAxNTAgKTsKCQl9LAoKCQkvLyBFeHBvc2Ugb3VyIGNhY2hlIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgoJCW5zTm9ybWFsaXplRGljdDogbnNOb3JtYWxpemVEaWN0LAoKCQkvLyBUYWtlIGEgZGF0YSBhdHRyaWJ1dGUgcHJvcGVydHksIHByZXBlbmQgdGhlIG5hbWVzcGFjZQoJCS8vIGFuZCB0aGVuIGNhbWVsIGNhc2UgdGhlIGF0dHJpYnV0ZSBzdHJpbmcuIEFkZCB0aGUgcmVzdWx0CgkJLy8gdG8gb3VyIG5zTm9ybWFsaXplRGljdCBzbyB3ZSBkb24ndCBoYXZlIHRvIGRvIHRoaXMgYWdhaW4uCgkJbnNOb3JtYWxpemU6IGZ1bmN0aW9uKCBwcm9wICkgewoJCQlpZiAoICFwcm9wICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gfHwgKCBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSA9ICQuY2FtZWxDYXNlKCAkLm1vYmlsZS5ucyArIHByb3AgKSApOwoJCX0sCgoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcyBvbiBpdC4gTm90ZSB0aGF0CgkJLy8gd2UgYXJlIG5vdCB1c2luZyAkLmZuLmNsb3Nlc3QoKSBvbiBwdXJwb3NlIGhlcmUgYmVjYXVzZSB0aGlzCgkJLy8gbWV0aG9kIGdldHMgY2FsbGVkIHF1aXRlIGEgYml0IGFuZCB3ZSBuZWVkIGl0IHRvIGJlIGFzIGZhc3QKCQkvLyBhcyBwb3NzaWJsZS4KCQlnZXRJbmhlcml0ZWRUaGVtZTogZnVuY3Rpb24oIGVsLCBkZWZhdWx0VGhlbWUgKSB7CgkJCXZhciBlID0gZWxbIDAgXSwKCQkJCWx0ciA9ICIiLAoJCQkJcmUgPSAvdWktKGJhcnxib2R5fG92ZXJsYXkpLShbYS16XSlcYi8sCgkJCQljLCBtOwoKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgoJCQkvLyBSZXR1cm4gdGhlIHRoZW1lIGxldHRlciB3ZSBmb3VuZCwgaWYgbm9uZSwgcmV0dXJuIHRoZQoJCQkvLyBzcGVjaWZpZWQgZGVmYXVsdC4KCgkJCXJldHVybiBsdHIgfHwgZGVmYXVsdFRoZW1lIHx8ICJhIjsKCQl9LAoKCQkvLyBUT0RPIHRoZSBmb2xsb3dpbmcgJCBhbmQgJC5mbiBleHRlbnNpb25zIGNhbi9wcm9iYWJseSBzaG91bGQgYmUgbW92ZWQgaW50byBqcXVlcnkubW9iaWxlLmNvcmUuaGVscGVycwoJCS8vCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCgnOmpxbURhdGEocm9sZT0icGFnZSIpLCA6anFtRGF0YShyb2xlPSJkaWFsb2ciKScpCgkJCQkuZGF0YSgicGFnZSIpOwoJCX0sCgoJCWVuaGFuY2VhYmxlOiBmdW5jdGlvbiggJHNldCApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoICRzZXQsICJlbmhhbmNlIiApOwoJCX0sCgoJCWhpamFja2FibGU6IGZ1bmN0aW9uKCAkc2V0ICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggJHNldCwgImFqYXgiICk7CgkJfSwKCgkJaGF2ZVBhcmVudHM6IGZ1bmN0aW9uKCAkc2V0LCBhdHRyICkgewoJCQlpZiggISQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkICl7CgkJCQlyZXR1cm4gJHNldDsKCQkJfQoKCQkJdmFyIGNvdW50ID0gJHNldC5sZW5ndGgsCgkJCQkkbmV3U2V0ID0gJCgpLAoJCQkJZSwgJGVsZW1lbnQsIGV4Y2x1ZGVkOwoKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKyApIHsKCQkJCSRlbGVtZW50ID0gJHNldC5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSAkc2V0WyBpIF07CgoJCQkJd2hpbGUgKCBlICkgewoJCQkJCXZhciBjID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCl7CgkJCS8vIE5hdGl2ZSBpbm5lckhlaWdodCByZXR1cm5zIG1vcmUgYWNjdXJhdGUgdmFsdWUgZm9yIHRoaXMgYWNyb3NzIHBsYXRmb3JtcywKCQkJLy8galF1ZXJ5IHZlcnNpb24gaXMgaGVyZSBhcyBhIG5vcm1hbGl6ZWQgZmFsbGJhY2sgZm9yIHBsYXRmb3JtcyBsaWtlIFN5bWJpYW4KCQkJcmV0dXJuIHdpbmRvdy5pbm5lckhlaWdodCB8fCAkKCB3aW5kb3cgKS5oZWlnaHQoKTsKCQl9Cgl9LCAkLm1vYmlsZSApOwoKCS8vIE1vYmlsZSB2ZXJzaW9uIG9mIGRhdGEgYW5kIHJlbW92ZURhdGEgYW5kIGhhc0RhdGEgbWV0aG9kcwoJLy8gZW5zdXJlcyBhbGwgZGF0YSBpcyBzZXQgYW5kIHJldHJpZXZlZCB1c2luZyBqUXVlcnkgTW9iaWxlJ3MgZGF0YSBuYW1lc3BhY2UKCSQuZm4uanFtRGF0YSA9IGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT0gInVuZGVmaW5lZCIgKSB7CgkJCWlmICggcHJvcCApIHsKCQkJCXByb3AgPSAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApOwoJCQl9CgoJCQkvLyB1bmRlZmluZWQgaXMgcGVybWl0dGVkIGFzIGFuIGV4cGxpY2l0IGlucHV0IGZvciB0aGUgc2Vjb25kIHBhcmFtCgkJCS8vIGluIHRoaXMgY2FzZSBpdCByZXR1cm5zIHRoZSB2YWx1ZSBhbmQgZG9lcyBub3Qgc2V0IGl0IHRvIHVuZGVmaW5lZAoJCQlpZiggYXJndW1lbnRzLmxlbmd0aCA8IDIgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCApewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gJC5kYXRhKCBlbGVtLCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuZm4uanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBwcm9wICkgewoJCXJldHVybiB0aGlzLnJlbW92ZURhdGEoICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AgKSB7CgkJcmV0dXJuICQucmVtb3ZlRGF0YSggZWxlbSwgJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmZuLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oKSB7CgkJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyggdGhpcyApOwoJfTsKCgkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyICRlbGVtID0gJCggZWxlbSApOwoKCQkoICRlbGVtLmpxbURhdGEoJ2RlcGVuZGVudHMnKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQkkZWxlbS5yZW1vdmUoKTsKCX07CgoJJC5mbi5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJJC5hZGREZXBlbmRlbnRzKCAkKHRoaXMpLCBuZXdEZXBlbmRlbnRzICk7Cgl9OwoKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtLCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciBkZXBlbmRlbnRzID0gJChlbGVtKS5qcW1EYXRhKCAnZGVwZW5kZW50cycgKSB8fCAkKCk7CgoJCSQoZWxlbSkuanFtRGF0YSggJ2RlcGVuZGVudHMnLCAkLm1lcmdlKGRlcGVuZGVudHMsIG5ld0RlcGVuZGVudHMpICk7Cgl9OwoKCS8vIG5vdGUgdGhhdCB0aGlzIGhlbHBlciBkb2Vzbid0IGF0dGVtcHQgdG8gaGFuZGxlIHRoZSBjYWxsYmFjawoJLy8gb3Igc2V0dGluZyBvZiBhbiBodG1sIGVsZW1lbnRzIHRleHQsIGl0cyBvbmx5IHB1cnBvc2UgaXMKCS8vIHRvIHJldHVybiB0aGUgaHRtbCBlbmNvZGVkIHZlcnNpb24gb2YgdGhlIHRleHQgaW4gYWxsIGNhc2VzLiAodGh1cyB0aGUgbmFtZSkKCSQuZm4uZ2V0RW5jb2RlZFRleHQgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKS50ZXh0KCAkKHRoaXMpLnRleHQoKSApLmh0bWwoKTsKCX07CgoJLy8gZmx1ZW50IGhlbHBlciBmdW5jdGlvbiBmb3IgdGhlIG1vYmlsZSBuYW1lc3BhY2VkIGVxdWl2YWxlbnQKCSQuZm4uanFtRW5oYW5jZWFibGUgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoaXMgKTsKCX07CgoJJC5mbi5qcW1IaWphY2thYmxlID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmhpamFja2FibGUoIHRoaXMgKTsKCX07CgoJLy8gTW9ua2V5LXBhdGNoaW5nIFNpenpsZSB0byBmaWx0ZXIgdGhlIDpqcW1EYXRhIHNlbGVjdG9yCgl2YXIgb2xkRmluZCA9ICQuZmluZCwKCQlqcW1EYXRhUkUgPSAvOmpxbURhdGFcKChbXildKilcKS9nOwoKCSQuZmluZCA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApIHsKCQlzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoIGpxbURhdGFSRSwgIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAiJDFdIiApOwoKCQlyZXR1cm4gb2xkRmluZC5jYWxsKCB0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApOwoJfTsKCgkkLmV4dGVuZCggJC5maW5kLCBvbGRGaW5kICk7CgoJJC5maW5kLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgc2V0ICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIHNldCApOwoJfTsKCgkkLmZpbmQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgWyBub2RlIF0gKS5sZW5ndGggPiAwOwoJfTsKfSkoIGpRdWVyeSwgdGhpcyApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyICR3aW5kb3cgPSAkKCB3aW5kb3cgKSwKCSRodG1sID0gJCggImh0bWwiICk7CgovKiAkLm1vYmlsZS5tZWRpYSBtZXRob2Q6IHBhc3MgYSBDU1MgbWVkaWEgdHlwZSBvciBxdWVyeSBhbmQgZ2V0IGEgYm9vbCByZXR1cm4KCW5vdGU6IHRoaXMgZmVhdHVyZSByZWxpZXMgb24gYWN0dWFsIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgZm9yIG1lZGlhIHF1ZXJpZXMsIHRob3VnaCB0eXBlcyB3aWxsIHdvcmsgbW9zdCBhbnl3aGVyZQoJZXhhbXBsZXM6CgkJJC5tb2JpbGUubWVkaWEoJ3NjcmVlbicpIC8vIHRlc3RzIGZvciBzY3JlZW4gbWVkaWEgdHlwZQoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4gYW5kIChtaW4td2lkdGg6IDQ4MHB4KScpIC8vIHRlc3RzIGZvciBzY3JlZW4gbWVkaWEgdHlwZSB3aXRoIHdpbmRvdyB3aWR0aCA+IDQ4MHB4CgkJJC5tb2JpbGUubWVkaWEoJ0BtZWRpYSBzY3JlZW4gYW5kICgtd2Via2l0LW1pbi1kZXZpY2UtcGl4ZWwtcmF0aW86IDIpJykgLy8gdGVzdHMgZm9yIHdlYmtpdCAyeCBwaXhlbCByYXRpbyAoaVBob25lIDQpCiovCiQubW9iaWxlLm1lZGlhID0gKGZ1bmN0aW9uKCkgewoJLy8gVE9ETzogdXNlIHdpbmRvdy5tYXRjaE1lZGlhIG9uY2UgYXQgbGVhc3Qgb25lIFVBIGltcGxlbWVudHMgaXQKCXZhciBjYWNoZSA9IHt9LAoJCXRlc3REaXYgPSAkKCAiPGRpdiBpZD0nanF1ZXJ5LW1lZGlhdGVzdCc+PC9kaXY+IiApLAoJCWZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5hcHBlbmQoIHRlc3REaXYgKTsKCglyZXR1cm4gZnVuY3Rpb24oIHF1ZXJ5ICkgewoJCWlmICggISggcXVlcnkgaW4gY2FjaGUgKSApIHsKCQkJdmFyIHN0eWxlQmxvY2sgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3R5bGUiICksCgkJCQljc3NydWxlID0gIkBtZWRpYSAiICsgcXVlcnkgKyAiIHsgI2pxdWVyeS1tZWRpYXRlc3QgeyBwb3NpdGlvbjphYnNvbHV0ZTsgfSB9IjsKCgkJCS8vbXVzdCBzZXQgdHlwZSBmb3IgSUUhCgkJCXN0eWxlQmxvY2sudHlwZSA9ICJ0ZXh0L2NzcyI7CgoJCQlpZiAoIHN0eWxlQmxvY2suc3R5bGVTaGVldCAgKXsKCQkJCXN0eWxlQmxvY2suc3R5bGVTaGVldC5jc3NUZXh0ID0gY3NzcnVsZTsKCQkJfSBlbHNlIHsKCQkJCXN0eWxlQmxvY2suYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNzc3J1bGUpICk7CgkJCX0KCgkJCSRodG1sLnByZXBlbmQoIGZha2VCb2R5ICkucHJlcGVuZCggc3R5bGVCbG9jayApOwoJCQljYWNoZVsgcXVlcnkgXSA9IHRlc3REaXYuY3NzKCAicG9zaXRpb24iICkgPT09ICJhYnNvbHV0ZSI7CgkJCWZha2VCb2R5LmFkZCggc3R5bGVCbG9jayApLnJlbW92ZSgpOwoJCX0KCQlyZXR1cm4gY2FjaGVbIHF1ZXJ5IF07Cgl9Owp9KSgpOwoKfSkoalF1ZXJ5KTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5wcmVwZW5kVG8oICJodG1sIiApLAoJZmJDU1MgPSBmYWtlQm9keVsgMCBdLnN0eWxlLAoJdmVuZG9ycyA9IFsgIldlYmtpdCIsICJNb3oiLCAiTyIgXSwKCXdlYm9zID0gInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93LCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBzY3JvbGxUb3AKCW9wZXJhID0gd2luZG93Lm9wZXJhLAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5OyAvL29ubHkgdXNlZCB0byBydWxlIG91dCBib3ggc2hhZG93LCBhcyBpdCdzIGZpbGxlZCBvcGFxdWUgb24gQkIKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKTsKCglmb3IgKCB2YXIgdiBpbiBwcm9wcyApewoJCWlmICggZmJDU1NbIHByb3BzWyB2IF0gXSAhPT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIHZhbGlkU3R5bGUoIHByb3AsIHZhbHVlLCBjaGVja192ZW5kICkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAoJCXVjID0gZnVuY3Rpb24oIHR4dCApIHsKCQkJcmV0dXJuIHR4dC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgdHh0LnN1YnN0ciggMSApCgkJfSwKCQl2ZW5kX3ByZWYgPSBmdW5jdGlvbiggdmVuZCApIHsKCQkJcmV0dXJuICAiLSIgKyB2ZW5kLmNoYXJBdCggMCApLnRvTG93ZXJDYXNlKCkgKyB2ZW5kLnN1YnN0ciggMSApICsgIi0iOwoJCX0sCgkJY2hlY2tfc3R5bGUgPSBmdW5jdGlvbiggdmVuZCApIHsKCQkJdmFyIHZlbmRfcHJvcCA9IHZlbmRfcHJlZiggdmVuZCApICsgcHJvcCArICI6ICIgKyB2YWx1ZSArICI7IiwKCQkJCXVjX3ZlbmQgPSB1YyggdmVuZCApLAoJCQkJcHJvcFN0eWxlID0gdWNfdmVuZCArIHVjKCBwcm9wICk7CgkJCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoJCQoJCQlpZiggISFkaXYuc3R5bGVbIHByb3BTdHlsZSBdICkgewoJCQkJcmV0ID0gdHJ1ZTsKCQkJfQoJCX0sCgkJY2hlY2tfdmVuZHMgPSBjaGVja192ZW5kID8gWyBjaGVja192ZW5kIF0gOiB2ZW5kb3JzLAoJCXJldDsKCglmb3IoIGkgPSAwOyBpIDwgY2hlY2tfdmVuZHMubGVuZ3RoOyBpKysgKSB7CgkJY2hlY2tfc3R5bGUoIGNoZWNrX3ZlbmRzW2ldICk7Cgl9CglyZXR1cm4gISFyZXQ7Cn0KCi8vIFRoYW5rcyB0byBNb2Rlcm5penIgc3JjIGZvciB0aGlzIHRlc3QgaWRlYS4gYHBlcnNwZWN0aXZlYCBjaGVjayBpcyBsaW1pdGVkIHRvIE1veiB0byBwcmV2ZW50IGEgZmFsc2UgcG9zaXRpdmUgZm9yIDNEIHRyYW5zZm9ybXMgb24gQW5kcm9pZC4KZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIHByb3AgPSAidHJhbnNmb3JtLTNkIjsKCXJldHVybiB2YWxpZFN0eWxlKCAncGVyc3BlY3RpdmUnLCAnMTBweCcsICdtb3onICkgfHwgJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIHByb3AgKyAiKSwoLSIgKSArICItIiArIHByb3AgKyAiKSwoIiArIHByb3AgKyAiKSIgKTsKfQoKLy8gVGVzdCBmb3IgZHluYW1pYy11cGRhdGluZyBiYXNlIHRhZyBzdXBwb3J0ICggYWxsb3dzIHVzIHRvIGF2b2lkIGhyZWYsc3JjIGF0dHIgcmV3cml0aW5nICkKZnVuY3Rpb24gYmFzZVRhZ1Rlc3QoKSB7Cgl2YXIgZmF1eEJhc2UgPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUgKyAidWktZGlyLyIsCgkJYmFzZSA9ICQoICJoZWFkIGJhc2UiICksCgkJZmF1eEVsZSA9IG51bGwsCgkJaHJlZiA9ICIiLAoJCWxpbmssIHJlYmFzZTsKCglpZiAoICFiYXNlLmxlbmd0aCApIHsKCQliYXNlID0gZmF1eEVsZSA9ICQoICI8YmFzZT4iLCB7ICJocmVmIjogZmF1eEJhc2UgfSkuYXBwZW5kVG8oICJoZWFkIiApOwoJfSBlbHNlIHsKCQlocmVmID0gYmFzZS5hdHRyKCAiaHJlZiIgKTsKCX0KCglsaW5rID0gJCggIjxhIGhyZWY9J3Rlc3R1cmwnIC8+IiApLnByZXBlbmRUbyggZmFrZUJvZHkgKTsKCXJlYmFzZSA9IGxpbmtbIDAgXS5ocmVmOwoJYmFzZVsgMCBdLmhyZWYgPSBocmVmIHx8IGxvY2F0aW9uLnBhdGhuYW1lOwoKCWlmICggZmF1eEVsZSApIHsKCQlmYXV4RWxlLnJlbW92ZSgpOwoJfQoJcmV0dXJuIHJlYmFzZS5pbmRleE9mKCBmYXV4QmFzZSApID09PSAwOwp9CgovLyBUaGFua3MgTW9kZXJuaXpyCmZ1bmN0aW9uIGNzc1BvaW50ZXJFdmVudHNUZXN0KCkgewoJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd4JyksCgkJZG9jdW1lbnRFbGVtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCWdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSwKCQlzdXBwb3J0czsKCglpZiggISggJ3BvaW50ZXJFdmVudHMnIGluIGVsZW1lbnQuc3R5bGUgKSApewoJCXJldHVybiBmYWxzZTsKCX0KCgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnYXV0byc7CgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAneCc7CiAgICBkb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CglzdXBwb3J0cyA9IGdldENvbXB1dGVkU3R5bGUgJiYKICAgIGdldENvbXB1dGVkU3R5bGUoIGVsZW1lbnQsICcnICkucG9pbnRlckV2ZW50cyA9PT0gJ2F1dG8nOwoJZG9jdW1lbnRFbGVtZW50LnJlbW92ZUNoaWxkKCBlbGVtZW50ICk7CiAgICByZXR1cm4gISFzdXBwb3J0czsKfQoKCi8vIG5vbi1VQS1iYXNlZCBJRSB2ZXJzaW9uIGNoZWNrIGJ5IEphbWVzIFBhZG9sc2V5LCBtb2RpZmllZCBieSBqZGFsdG9uIC0gZnJvbSBodHRwOi8vZ2lzdC5naXRodWIuY29tLzUyNzY4MwovLyBhbGxvd3MgZm9yIGluY2x1c2lvbiBvZiBJRSA2KywgaW5jbHVkaW5nIFdpbmRvd3MgTW9iaWxlIDcKJC5leHRlbmQoICQubW9iaWxlLCB7IGJyb3dzZXI6IHt9IH0gKTsKJC5tb2JpbGUuYnJvd3Nlci5pZSA9IChmdW5jdGlvbigpIHsKCXZhciB2ID0gMywKCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCglhID0gZGl2LmFsbCB8fCBbXTsKCgkvLyBhZGRlZCB7fSB0byBzaWxlbmNlIGNsb3N1cmUgY29tcGlsZXIgd2FybmluZ3MuIHJlZ2lzdGVyaW5nIG15IGRpc2xpa2Ugb2YgYWxsIHRoaW5ncwoJLy8gb3Zlcmx5IGNsZXZlciBoZXJlIGZvciBmdXR1cmUgcmVmZXJlbmNlCgl3aGlsZSAoIGRpdi5pbm5lckhUTUwgPSAiPCEtLVtpZiBndCBJRSAiICsgKCArK3YgKSArICJdPjxicj48IVtlbmRpZl0tLT4iLCBhWyAwIF0gKXt9OwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCgokLmV4dGVuZCggJC5zdXBwb3J0LCB7CglvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiBpbiB3aW5kb3cgJiYgIm9ub3JpZW50YXRpb25jaGFuZ2UiIGluIHdpbmRvdywKCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQsCgljc3NUcmFuc2l0aW9uczogIldlYktpdFRyYW5zaXRpb25FdmVudCIgaW4gd2luZG93IHx8IHZhbGlkU3R5bGUoICd0cmFuc2l0aW9uJywgJ2hlaWdodCAxMDBtcyBsaW5lYXInICkgJiYgIW9wZXJhLAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmICJyZXBsYWNlU3RhdGUiIGluIGhpc3RvcnksCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJYm94U2hhZG93OiAhIXByb3BFeGlzdHMoICJib3hTaGFkb3ciICkgJiYgIWJiLAoJc2Nyb2xsVG9wOiAoICJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8ICJzY3JvbGxUb3AiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fCAic2Nyb2xsVG9wIiBpbiBmYWtlQm9keVsgMCBdICkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCglkeW5hbWljQmFzZVRhZzogYmFzZVRhZ1Rlc3QoKSwKCWNzc1BvaW50ZXJFdmVudHM6IGNzc1BvaW50ZXJFdmVudHNUZXN0KCkKfSk7CgpmYWtlQm9keS5yZW1vdmUoKTsKCgovLyAkLm1vYmlsZS5hamF4QmxhY2tsaXN0IGlzIHVzZWQgdG8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcyAoQkI1LCBTeW1iaWFuKQovLyBvciB0aGF0IGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKE9wZXJhIE1pbmkpCi8vIE5vdGU6IFRoaXMgZGV0ZWN0aW9uIGJlbG93IGlzIHVzZWQgYXMgYSBsYXN0IHJlc29ydC4KLy8gV2UgcmVjb21tZW5kIG9ubHkgdXNpbmcgdGhlc2UgZGV0ZWN0aW9uIG1ldGhvZHMgd2hlbiBhbGwgb3RoZXIgbW9yZSByZWxpYWJsZS9mb3J3YXJkLWxvb2tpbmcgYXBwcm9hY2hlcyBhcmUgbm90IHBvc3NpYmxlCnZhciBub2tpYUxURTdfMyA9IChmdW5jdGlvbigpewoKCXZhciB1YSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50OwoKCS8vVGhlIGZvbGxvd2luZyBpcyBhbiBhdHRlbXB0IHRvIG1hdGNoIE5va2lhIGJyb3dzZXJzIHRoYXQgYXJlIHJ1bm5pbmcgU3ltYmlhbi9zNjAsIHdpdGggd2Via2l0LCB2ZXJzaW9uIDcuMyBvciBvbGRlcgoJcmV0dXJuIHVhLmluZGV4T2YoICJOb2tpYSIgKSA+IC0xICYmCgkJCSggdWEuaW5kZXhPZiggIlN5bWJpYW4vMyIgKSA+IC0xIHx8IHVhLmluZGV4T2YoICJTZXJpZXM2MC81IiApID4gLTEgKSAmJgoJCQl1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSAmJgoJCQl1YS5tYXRjaCggLyhCcm93c2VyTkd8Tm9raWFCcm93c2VyKVwvN1wuWzAtM10vICk7Cn0pKCk7CgovLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCi8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKJC5tb2JpbGUuZ3JhZGVBID0gZnVuY3Rpb24oKXsKCXJldHVybiAkLnN1cHBvcnQubWVkaWFxdWVyeSB8fCAkLm1vYmlsZS5icm93c2VyLmllICYmICQubW9iaWxlLmJyb3dzZXIuaWUgPj0gNzsKfTsKCiQubW9iaWxlLmFqYXhCbGFja2xpc3QgPQoJCQkvLyBCbGFja0JlcnJ5IGJyb3dzZXJzLCBwcmUtd2Via2l0CgkJCXdpbmRvdy5ibGFja2JlcnJ5ICYmICF3aW5kb3cuV2ViS2l0UG9pbnQgfHwKCQkJLy8gT3BlcmEgTWluaQoJCQlvcGVyYW1pbmkgfHwKCQkJLy8gU3ltYmlhbiB3ZWJraXRzIHByZSA3LjMKCQkJbm9raWFMVEU3XzM7CgovLyBMYXN0bHksIHRoaXMgd29ya2Fyb3VuZCBpcyB0aGUgb25seSB3YXkgd2UndmUgZm91bmQgc28gZmFyIHRvIGdldCBwcmUgNy4zIFN5bWJpYW4gd2Via2l0IGRldmljZXMKLy8gdG8gcmVuZGVyIHRoZSBzdHlsZXNoZWV0cyB3aGVuIHRoZXkncmUgcmVmZXJlbmNlZCBiZWZvcmUgdGhpcyBzY3JpcHQsIGFzIHdlJ2QgcmVjb21tZW5kIGRvaW5nLgovLyBUaGlzIHNpbXBseSByZWFwcGVuZHMgdGhlIENTUyBpbiBwbGFjZSwgd2hpY2ggZm9yIHNvbWUgcmVhc29uIG1ha2VzIGl0IGFwcGx5CmlmICggbm9raWFMVEU3XzMgKSB7CgkkKGZ1bmN0aW9uKCkgewoJCSQoICJoZWFkIGxpbmtbcmVsPSdzdHlsZXNoZWV0J10iICkuYXR0ciggInJlbCIsICJhbHRlcm5hdGUgc3R5bGVzaGVldCIgKS5hdHRyKCAicmVsIiwgInN0eWxlc2hlZXQiICk7Cgl9KTsKfQoKLy8gRm9yIHJ1bGluZyBvdXQgc2hhZG93cyB2aWEgY3NzCmlmICggISQuc3VwcG9ydC5ib3hTaGFkb3cgKSB7CgkkKCAiaHRtbCIgKS5hZGRDbGFzcyggInVpLW1vYmlsZS1ub3N1cHBvcnQtYm94c2hhZG93IiApOwp9Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gYWRkIG5ldyBldmVudCBzaG9ydGN1dHMKJC5lYWNoKCAoICJ0b3VjaHN0YXJ0IHRvdWNobW92ZSB0b3VjaGVuZCBvcmllbnRhdGlvbmNoYW5nZSB0aHJvdHRsZWRyZXNpemUgIiArCgkJCQkJInRhcCB0YXBob2xkIHN3aXBlIHN3aXBlbGVmdCBzd2lwZXJpZ2h0IHNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBuYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBuYW1lICk7Cgl9OwoKCSQuYXR0ckZuWyBuYW1lIF0gPSB0cnVlOwp9KTsKCnZhciBzdXBwb3J0VG91Y2ggPSAkLnN1cHBvcnQudG91Y2gsCglzY3JvbGxFdmVudCA9ICJ0b3VjaG1vdmUgc2Nyb2xsIiwKCXRvdWNoU3RhcnRFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaHN0YXJ0IiA6ICJtb3VzZWRvd24iLAoJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJdG91Y2hNb3ZlRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2htb3ZlIiA6ICJtb3VzZW1vdmUiOwoKZnVuY3Rpb24gdHJpZ2dlckN1c3RvbUV2ZW50KCBvYmosIGV2ZW50VHlwZSwgZXZlbnQgKSB7Cgl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgkkLmV2ZW50LmhhbmRsZS5jYWxsKCBvYmosIGV2ZW50ICk7CglldmVudC50eXBlID0gb3JpZ2luYWxUeXBlOwp9CgovLyBhbHNvIGhhbmRsZXMgc2Nyb2xsc3RvcAokLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQgPSB7CgoJZW5hYmxlZDogdHJ1ZSwKCglzZXR1cDogZnVuY3Rpb24oKSB7CgoJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCXNjcm9sbGluZywKCQkJdGltZXI7CgoJCWZ1bmN0aW9uIHRyaWdnZXIoIGV2ZW50LCBzdGF0ZSApIHsKCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgc2Nyb2xsaW5nID8gInNjcm9sbHN0YXJ0IiA6ICJzY3JvbGxzdG9wIiwgZXZlbnQgKTsKCQl9CgoJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJJHRoaXMuYmluZCggc2Nyb2xsRXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoICFzY3JvbGxpbmcgKSB7CgkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQl9CgoJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCXRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCXRyaWdnZXIoIGV2ZW50LCBmYWxzZSApOwoJCQl9LCA1MCApOwoJCX0pOwoJfQp9OwoKLy8gYWxzbyBoYW5kbGVzIHRhcGhvbGQKJC5ldmVudC5zcGVjaWFsLnRhcCA9IHsKCXNldHVwOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCSR0aGlzID0gJCggdGhpc09iamVjdCApOwoKCQkkdGhpcy5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCWlmICggZXZlbnQud2hpY2ggJiYgZXZlbnQud2hpY2ggIT09IDEgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBvcmlnVGFyZ2V0ID0gZXZlbnQudGFyZ2V0LAoJCQkJb3JpZ0V2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudCwKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gY2xlYXJUYXBUaW1lcigpIHsKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJfQoKCQkJZnVuY3Rpb24gY2xlYXJUYXBIYW5kbGVycygpIHsKCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkkdGhpcy51bmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKQoJCQkJCS51bmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKTsKCQkJCSQoIGRvY3VtZW50ICkudW5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoJCQl9CgoJCQlmdW5jdGlvbiBjbGlja0hhbmRsZXIoZXZlbnQpIHsKCQkJCWNsZWFyVGFwSGFuZGxlcnMoKTsKCgkJCQkvLyBPTkxZIHRyaWdnZXIgYSAndGFwJyBldmVudCBpZiB0aGUgc3RhcnQgdGFyZ2V0IGlzCgkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQlpZiAoIG9yaWdUYXJnZXQgPT0gZXZlbnQudGFyZ2V0ICkgewoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcCIsIGV2ZW50ICk7CgkJCQl9CgkJCX0KCgkJCSR0aGlzLmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKQoJCQkJLmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKTsKCQkJJCggZG9jdW1lbnQgKS5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoKCQkJdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0IH0gKSApOwoJCQl9LCA3NTAgKTsKCQl9KTsKCX0KfTsKCi8vIGFsc28gaGFuZGxlcyBzd2lwZWxlZnQsIHN3aXBlcmlnaHQKJC5ldmVudC5zcGVjaWFsLnN3aXBlID0gewoJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMTAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJZHVyYXRpb25UaHJlc2hvbGQ6IDEwMDAsIC8vIE1vcmUgdGltZSB0aGFuIHRoaXMsIGFuZCBpdCBpc24ndCBhIHN3aXBlLgoKCWhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZDogMzAsICAvLyBTd2lwZSBob3Jpem9udGFsIGRpc3BsYWNlbWVudCBtdXN0IGJlIG1vcmUgdGhhbiB0aGlzLgoKCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZGF0YSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyA/CgkJCQkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudCwKCQkJCXN0YXJ0ID0gewoJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdLAoJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCX0sCgkJCQlzdG9wOwoKCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoKCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgZGF0YSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyA/CgkJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgoJCQkJc3RvcCA9IHsKCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJfTsKCgkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJaWYgKCBNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZCApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9CgoJCQkkdGhpcy5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKQoJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkkdGhpcy51bmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApOwoKCQkJCQlpZiAoIHN0YXJ0ICYmIHN0b3AgKSB7CgkJCQkJCWlmICggc3RvcC50aW1lIC0gc3RhcnQudGltZSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5kdXJhdGlvblRocmVzaG9sZCAmJgoJCQkJCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQgJiYKCQkJCQkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCgkJCQkJCQlzdGFydC5vcmlnaW4udHJpZ2dlciggInN3aXBlIiApCgkJCQkJCQkJLnRyaWdnZXIoIHN0YXJ0LmNvb3Jkc1swXSA+IHN0b3AuY29vcmRzWyAwIF0gPyAic3dpcGVsZWZ0IiA6ICJzd2lwZXJpZ2h0IiApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXN0YXJ0ID0gc3RvcCA9IHVuZGVmaW5lZDsKCQkJCX0pOwoJCX0pOwoJfQp9OwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyAiQ293Ym95IiBCZW4gQWxtYW4KCgl2YXIgd2luID0gJCggd2luZG93ICksCgkJc3BlY2lhbF9ldmVudCwKCQlnZXRfb3JpZW50YXRpb24sCgkJbGFzdF9vcmllbnRhdGlvbiwKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSwKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQsCgkJcG9ydHJhaXRfbWFwID0geyAiMCI6IHRydWUsICIxODAiOiB0cnVlIH07CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXZhciB3dyA9IHdpbmRvdy5pbm5lcldpZHRoIHx8ICQoIHdpbmRvdyApLndpZHRoKCksCgkJCXdoID0gd2luZG93LmlubmVySGVpZ2h0IHx8ICQoIHdpbmRvdyApLmhlaWdodCgpLAoJCQlsYW5kc2NhcGVfdGhyZXNob2xkID0gNTA7CgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gd3cgPiB3aCAmJiAoIHd3IC0gd2ggKSA+IGxhbmRzY2FwZV90aHJlc2hvbGQ7CgoKCQkvLyBOb3cgY2hlY2sgdG8gc2VlIGlmIHRoZSBjdXJyZW50IHdpbmRvdy5vcmllbnRhdGlvbiBpcyAwIG9yIDE4MC4KCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoKCQkvLyBJZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBsYW5kc2NhcGUsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyAwIG9yIDE4MCwgKk9SKgoJCS8vIGlmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIHBvcnRyYWl0LCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgOTAgb3IgLTkwLCB3ZQoJCS8vIG5lZWQgdG8gZmxpcCBvdXIgcG9ydHJhaXRfbWFwIHZhbHVlcyBiZWNhdXNlIGxhbmRzY2FwZSBpcyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBmb3IKCQkvLyB0aGlzIGRldmljZS9icm93c2VyLgoJCWlmICggKCBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiBpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSB8fCAoICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgKSB7CgkJCXBvcnRyYWl0X21hcCA9IHsgIi05MCI6IHRydWUsICI5MCI6IHRydWUgfTsKCQl9Cgl9CgoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlID0gc3BlY2lhbF9ldmVudCA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0IGpRdWVyeQoJCQkvLyB3aWxsIGJpbmQgdG8gdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAkLm1vYmlsZS5vcmllbnRhdGlvbkNoYW5nZUVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiB0byBhdm9pZCBpbml0aWFsIGRvdWJsZS10cmlnZ2VyaW5nLgoJCQlsYXN0X29yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCBzaW11bGF0ZSB0aGUKCQkJLy8gZXZlbnQgYnkgdGVzdGluZyB3aW5kb3cgZGltZW5zaW9ucyBvbiByZXNpemUuCgkJCXdpbi5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCl7CgkJCS8vIElmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfTsKCgkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgdGhpcyBoYW5kbGVyIHdpbGwgYmUgYm91bmQgdG8KCS8vIHRoZSB3aW5kb3cgcmVzaXplIGV2ZW50IHRvIHNpbXVsYXRlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCWZ1bmN0aW9uIGhhbmRsZXIoKSB7CgkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uLgoJCXZhciBvcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQlpZiAoIG9yaWVudGF0aW9uICE9PSBsYXN0X29yaWVudGF0aW9uICkgewoJCQkvLyBUaGUgb3JpZW50YXRpb24gaGFzIGNoYW5nZWQsIHNvIHRyaWdnZXIgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJCQlsYXN0X29yaWVudGF0aW9uID0gb3JpZW50YXRpb247CgkJCXdpbi50cmlnZ2VyKCAib3JpZW50YXRpb25jaGFuZ2UiICk7CgkJfQoJfQoKCS8vIEdldCB0aGUgY3VycmVudCBwYWdlIG9yaWVudGF0aW9uLiBUaGlzIG1ldGhvZCBpcyBleHBvc2VkIHB1YmxpY2x5LCBzaG91bGQgaXQKCS8vIGJlIG5lZWRlZCwgYXMgalF1ZXJ5LmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24oKQoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJdmFyIGlzUG9ydHJhaXQgPSB0cnVlLCBlbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCQkvLyBwcmVmZXIgd2luZG93IG9yaWVudGF0aW9uIHRvIHRoZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBzY3JlZW5zaXplIGFzCgkJLy8gdGhlIGFjdHVhbCBzY3JlZW4gcmVzaXplIHRha2VzIHBsYWNlIGJlZm9yZSBvciBhZnRlciB0aGUgb3JpZW50YXRpb24gY2hhbmdlIGV2ZW50CgkJLy8gaGFzIGJlZW4gZmlyZWQgZGVwZW5kaW5nIG9uIGltcGxlbWVudGF0aW9uIChlZyBhbmRyb2lkIDIuMyBpcyBiZWZvcmUsIGlwaG9uZSBhZnRlcikuCgkJLy8gTW9yZSB0ZXN0aW5nIGlzIHJlcXVpcmVkIHRvIGRldGVybWluZSBpZiBhIG1vcmUgcmVsaWFibGUgbWV0aG9kIG9mIGRldGVybWluaW5nIHRoZSBuZXcgc2NyZWVuc2l6ZQoJCS8vIGlzIHBvc3NpYmxlIHdoZW4gb3JpZW50YXRpb25jaGFuZ2UgaXMgZmlyZWQuIChlZywgdXNlIG1lZGlhIHF1ZXJpZXMgKyBlbGVtZW50ICsgb3BhY2l0eSkKCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCQkJLy8gaWYgdGhlIHdpbmRvdyBvcmllbnRhdGlvbiByZWdpc3RlcnMgYXMgMCBvciAxODAgZGVncmVlcyByZXBvcnQKCQkJLy8gcG9ydHJhaXQsIG90aGVyd2lzZSBsYW5kc2NhcGUKCQkJaXNQb3J0cmFpdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgkJfSBlbHNlIHsKCQkJaXNQb3J0cmFpdCA9IGVsZW0gJiYgZWxlbS5jbGllbnRXaWR0aCAvIGVsZW0uY2xpZW50SGVpZ2h0IDwgMS4xOwoJCX0KCgkJcmV0dXJuIGlzUG9ydHJhaXQgPyAicG9ydHJhaXQiIDogImxhbmRzY2FwZSI7Cgl9OwoKfSkoIGpRdWVyeSwgd2luZG93ICk7CgoKLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAooZnVuY3Rpb24oKSB7CgoJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCl7CgkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJfQoJfTsKCgl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJfSBlbHNlIHsKCgkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCX0KCgkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJfQoJCX0sCgkJbGFzdENhbGwgPSAwLAoJCWhlbGRDYWxsLAoJCWN1cnIsCgkJZGlmZjsKfSkoKTsKCgokLmVhY2goewoJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCXRhcGhvbGQ6ICJ0YXAiLAoJc3dpcGVsZWZ0OiAic3dpcGUiLAoJc3dpcGVyaWdodDogInN3aXBlIgp9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCSQuZXZlbnQuc3BlY2lhbFsgZXZlbnQgXSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogImMiLAoJCWRvbUNhY2hlOiBmYWxzZSwKCQlrZWVwTmF0aXZlRGVmYXVsdDogIjpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCgkJLy8gaWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYoIHNlbGYuX3RyaWdnZXIoICJiZWZvcmVjcmVhdGUiICkgPT09IGZhbHNlICl7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXNlbGYuZWxlbWVudAoJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJLmFkZENsYXNzKCAidWktcGFnZSB1aS1ib2R5LSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKQoJCQkuYmluZCggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oKXsKCQkJCXNlbGYucmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCgpOwoJCQl9ICkKCQkJLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCl7CgkJCQlzZWxmLnNldENvbnRhaW5lckJhY2tncm91bmQoKTsKCQkJfSApOwoKCX0sCgkKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCl7CgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQucGFyZW50KCkgKSApOwoJfSwKCQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKXsKCQlpZiggdGhpcy5vcHRpb25zLnRoZW1lICl7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyAoIHRoZW1lIHx8IHRoaXMub3B0aW9ucy50aGVtZSApICk7CgkJfQoJfSwKCglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlRGVmaW5lZCA9IG9wdGlvbnMua2VlcE5hdGl2ZSAmJiAkLnRyaW0ob3B0aW9ucy5rZWVwTmF0aXZlKTsKCgkJaWYoIGtlZXBOYXRpdmVEZWZpbmVkICYmIG9wdGlvbnMua2VlcE5hdGl2ZSAhPT0gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdCApewoJCQlyZXR1cm4gW29wdGlvbnMua2VlcE5hdGl2ZSwgb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdF0uam9pbigiLCAiKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0OwoJfQp9KTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgp2YXIgY3JlYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCBzZXF1ZW50aWFsICl7CgkKCS8vIERlZmF1bHQgdG8gc2VxdWVudGlhbAoJaWYoIHNlcXVlbnRpYWwgPT09IHVuZGVmaW5lZCApewoJCXNlcXVlbnRpYWwgPSB0cnVlOwoJfQoJCglyZXR1cm4gZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20gKSB7CgoJCXZhciBkZWZlcnJlZCA9IG5ldyAkLkRlZmVycmVkKCksCgkJCXJldmVyc2VDbGFzcyA9IHJldmVyc2UgPyAiIHJldmVyc2UiIDogIiIsCgkJCWFjdGl2ZQk9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCksCgkJCXRvU2Nyb2xsID0gYWN0aXZlLmxhc3RTY3JvbGwgfHwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwsCgkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQltYXhUcmFuc2l0aW9uT3ZlcnJpZGUgPSAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGggIT09IGZhbHNlICYmICQoIHdpbmRvdyApLndpZHRoKCkgPiAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGgsCgkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8IG1heFRyYW5zaXRpb25PdmVycmlkZSB8fCAhbmFtZSB8fCBuYW1lID09PSAibm9uZSIgfHwgTWF0aC5tYXgoICQoIHdpbmRvdyApLnNjcm9sbFRvcCgpLCB0b1Njcm9sbCApID4gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbigpLAoJCQl0b1ByZUNsYXNzID0gIiB1aS1wYWdlLXByZS1pbiIsCgkJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MgPSBmdW5jdGlvbigpewoJCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci50b2dnbGVDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyBuYW1lICk7CgkJCX0sCgkJCXNjcm9sbFBhZ2UgPSBmdW5jdGlvbigpewoJCQkJLy8gQnkgdXNpbmcgc2Nyb2xsVG8gaW5zdGVhZCBvZiBzaWxlbnRTY3JvbGwsIHdlIGNhbiBrZWVwIHRoaW5ncyBiZXR0ZXIgaW4gb3JkZXIKCQkJCS8vIEp1c3QgdG8gYmUgcHJlY2F1dGlvcywgZGlzYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgkJCQkKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdG9TY3JvbGwgKTsKCQkJCQoJCQkJLy8gcmVlbmFibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJCX0sIDE1MCApOwoJCQl9LAoJCQljbGVhbkZyb20gPSBmdW5jdGlvbigpewoJCQkJJGZyb20KCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgb3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgkJCX0sCgkJCXN0YXJ0T3V0ID0gZnVuY3Rpb24oKXsKCQkJCS8vIGlmIGl0J3Mgbm90IHNlcXVlbnRpYWwsIGNhbGwgdGhlIGRvbmVPdXQgdHJhbnNpdGlvbiB0byBzdGFydCB0aGUgVE8gcGFnZSBhbmltYXRpbmcgaW4gc2ltdWx0YW5lb3VzbHkKCQkJCWlmKCAhc2VxdWVudGlhbCApewoJCQkJCWRvbmVPdXQoKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCSRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCBkb25lT3V0ICk7CQoJCQkJfQoJCQkJCgkJCQkvLyBTZXQgdGhlIGZyb20gcGFnZSdzIGhlaWdodCBhbmQgc3RhcnQgaXQgdHJhbnNpdGlvbmluZyBvdXQKCQkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCQkkZnJvbQoJCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQod2luZG93ICkuc2Nyb2xsVG9wKCkgKQoJCQkJCS5hZGRDbGFzcyggbmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCQl9LAoJCQkKCQkJZG9uZU91dCA9IGZ1bmN0aW9uKCkgewoKCQkJCWlmICggJGZyb20gJiYgc2VxdWVudGlhbCApIHsKCQkJCQljbGVhbkZyb20oKTsKCQkJCX0KCQkJCQoJCQkJc3RhcnRJbigpOwoJCQl9LAoJCQkKCQkJc3RhcnRJbiA9IGZ1bmN0aW9uKCl7CQoJCQkKCQkJCS8vcHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcgoJCQkJJHRvLmNzcygiei1pbmRleCIsIC0xMCk7CgoJCQkJJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyB0b1ByZUNsYXNzICk7CQkJCgkJCQoJCQkJLy8gU2VuZCBmb2N1cyB0byBwYWdlIGFzIGl0IGlzIG5vdyBkaXNwbGF5OiBibG9jawoJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCAkdG8gKTsKCgkJCQkvLyBTZXQgdG8gcGFnZSBoZWlnaHQKCQkJCSR0by5oZWlnaHQoIHNjcmVlbkhlaWdodCArIHRvU2Nyb2xsICk7CgkJCQkKCQkJCXNjcm9sbFBhZ2UoKTsKCgkJCQkvL3Jlc3RvcmVzIHZpc2liaWxpdHkgb2YgdGhlIG5ldyBwYWdlCgkJCQkkdG8uY3NzKCJ6LWluZGV4IiwgIiIpOwoJCQkJCgkJCQlpZiggIW5vbmUgKXsKCQkJCQkkdG8uYW5pbWF0aW9uQ29tcGxldGUoIGRvbmVJbiApOwoJCQkJfQoJCQkJCgkJCQkkdG8KCQkJCQkucmVtb3ZlQ2xhc3MoIHRvUHJlQ2xhc3MgKQoJCQkJCS5hZGRDbGFzcyggbmFtZSArICIgaW4iICsgcmV2ZXJzZUNsYXNzICk7CgkJCQkKCQkJCWlmKCBub25lICl7CgkJCQkJZG9uZUluKCk7CgkJCQl9CgkJCQkKCQkJfSwKCQkKCQkJZG9uZUluID0gZnVuY3Rpb24oKSB7CgkJCQoJCQkJaWYgKCAhc2VxdWVudGlhbCApIHsKCQkJCQkKCQkJCQlpZiggJGZyb20gKXsKCQkJCQkJY2xlYW5Gcm9tKCk7CgkJCQkJfQoJCQkJfQoJCQkKCQkJCSR0bwoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCBpbiByZXZlcnNlICIgKyBuYW1lICkKCQkJCQkuaGVpZ2h0KCAiIiApOwoJCQkJCgkJCQl0b2dnbGVWaWV3cG9ydENsYXNzKCk7CgkJCQkKCQkJCS8vIEluIHNvbWUgYnJvd3NlcnMgKGlPUzUpLCAzRCB0cmFuc2l0aW9ucyBibG9jayB0aGUgYWJpbGl0eSB0byBzY3JvbGwgdG8gdGhlIGRlc2lyZWQgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXRpb24KCQkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCQlpZiggJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgIT09IHRvU2Nyb2xsICl7CgkJCQkJc2Nyb2xsUGFnZSgpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlc29sdmUoIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIHRydWUgKTsKCQkJfTsKCgkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoJCgkJaWYgKCAkZnJvbSAmJiAhbm9uZSApIHsKCQkJc3RhcnRPdXQoKTsKCQl9CgkJZWxzZSB7CgkJCWRvbmVPdXQoKTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9Owp9CgovLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKdmFyIHNlcXVlbnRpYWxIYW5kbGVyID0gY3JlYXRlSGFuZGxlcigpLAoJc2ltdWx0YW5lb3VzSGFuZGxlciA9IGNyZWF0ZUhhbmRsZXIoIGZhbHNlICksCglkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSAqIDM7Cgl9OwoKLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHRoZSBwdWJsaWMgZGVmYXVsdC4KJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gc2VxdWVudGlhbEhhbmRsZXI7CgovL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJImRlZmF1bHQiOiAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIsCgkic2VxdWVudGlhbCI6IHNlcXVlbnRpYWxIYW5kbGVyLAoJInNpbXVsdGFuZW91cyI6IHNpbXVsdGFuZW91c0hhbmRsZXIKfTsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MgPSB7fTsKCi8vIFNldCB0aGUgZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB0byBkZWZhdWx0IGlmIG5vIGltcGxlbWVudGF0aW9uIHdhcyBzZXQgYnkgdXNlcgokLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKfSkoIGpRdWVyeSwgdGhpcyApOwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgl2YXIgJHdpbmRvdyA9ICQoIHdpbmRvdyApLAoJCSRodG1sID0gJCggJ2h0bWwnICksCgkJJGhlYWQgPSAkKCAnaGVhZCcgKSwKCgkJLy91cmwgcGF0aCBoZWxwZXJzIGZvciB1c2UgaW4gcmVsYXRpdmUgdXJsIG1hbmFnZW1lbnQKCQlwYXRoID0gewoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy8gQWJzdHJhY3Rpb24gdG8gYWRkcmVzcyB4c3MgKElzc3VlICM0Nzg3KSBieSByZW1vdmluZyB0aGUgYXV0aG9yaXR5IGluCgkJCS8vIGJyb3dzZXJzIHRoYXQgYXV0bwlkZWNvZGUgaXQuIEFsbCByZWZlcmVuY2VzIHRvIGxvY2F0aW9uLmhyZWYgc2hvdWxkIGJlCgkJCS8vIHJlcGxhY2VkIHdpdGggYSBjYWxsIHRvIHRoaXMgbWV0aG9kIHNvIHRoYXQgaXQgY2FuIGJlIGRlYWx0IHdpdGggcHJvcGVybHkgaGVyZQoJCQlnZXRMb2NhdGlvbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1cmkgPSB1cmwgPyB0aGlzLnBhcnNlVXJsKCB1cmwgKSA6IGxvY2F0aW9uLAoJCQkJCWhhc2ggPSB0aGlzLnBhcnNlVXJsKCB1cmwgfHwgbG9jYXRpb24uaHJlZiApLmhhc2g7CgoJCQkJLy8gbWltaWMgdGhlIGJyb3dzZXIgd2l0aCBhbiBlbXB0eSBzdHJpbmcgd2hlbiB0aGUgaGFzaCBpcyBlbXB0eQoJCQkJaGFzaCA9IGhhc2ggPT09ICIjIiA/ICIiIDogaGFzaDsKCgkJCQkvLyBNYWtlIHN1cmUgdG8gcGFyc2UgdGhlIHVybCBvciB0aGUgbG9jYXRpb24gb2JqZWN0IGZvciB0aGUgaGFzaCBiZWNhdXNlIHVzaW5nIGxvY2F0aW9uLmhhc2gKCQkJCS8vIGlzIGF1dG9kZWNvZGVkIGluIGZpcmVmb3gsIHRoZSByZXN0IG9mIHRoZSB1cmwgc2hvdWxkIGJlIGZyb20gdGhlIG9iamVjdCAobG9jYXRpb24gdW5sZXNzCgkJCQkvLyB3ZSdyZSB0ZXN0aW5nKSB0byBhdm9pZCB0aGUgaW5jbHVzaW9uIG9mIHRoZSBhdXRob3JpdHkKCQkJCXJldHVybiB1cmkucHJvdG9jb2wgKyAiLy8iICsgdXJpLmhvc3QgKyB1cmkucGF0aG5hbWUgKyB1cmkuc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCXBhcnNlTG9jYXRpb246IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMucGFyc2VVcmwoIHRoaXMuZ2V0TG9jYXRpb24oKSApOwoJCQl9LAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQl2YXIgYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXSwKCQkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCWlmICggYWJzVXJsID09PSB1bmRlZmluZWQgKSB7CgkJCQkJYWJzVXJsID0gZG9jdW1lbnRCYXNlOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJICAgIC8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCSAgICAvLyBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0ucmVwbGFjZSggL14jLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCBkb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJCX0KCQkJCXJldHVybiBhYnNVcmw7CgkJCX0sCgoJCQkvL2dldCBwYXRoIGZyb20gY3VycmVudCBoYXNoLCBvciBmcm9tIGEgZmlsZSBwYXRoCgkJCWdldDogZnVuY3Rpb24oIG5ld1BhdGggKSB7CgkJCQlpZiggbmV3UGF0aCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCW5ld1BhdGggPSBsb2NhdGlvbi5oYXNoOwoJCQkJfQoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBuZXdQYXRoICkucmVwbGFjZSggL1teXC9dKlwuW15cLypdKyQvLCAnJyApOwoJCQl9LAoKCQkJLy9yZXR1cm4gdGhlIHN1YnN0cmluZyBvZiBhIGZpbGVwYXRoIGJlZm9yZSB0aGUgc3ViLXBhZ2Uga2V5LCBmb3IgbWFraW5nIGEgc2VydmVyIHJlcXVlc3QKCQkJZ2V0RmlsZVBhdGg6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJdmFyIHNwbGl0a2V5ID0gJyYnICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleTsKCQkJCXJldHVybiBwYXRoICYmIHBhdGguc3BsaXQoIHNwbGl0a2V5IClbMF0uc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJfSwKCgkJCS8vc2V0IGxvY2F0aW9uIGhhc2ggdG8gcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJbG9jYXRpb24uaGFzaCA9IHBhdGg7CgkJCX0sCgoJCQkvL3Rlc3QgaWYgYSBnaXZlbiB1cmwgKHN0cmluZykgaXMgYSBwYXRoCgkJCS8vTk9URSBtaWdodCBiZSBleGNlcHRpb25hbGx5IG5haXZlCgkJCWlzUGF0aDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9cLy8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIGEgdXJsIHBhdGggd2l0aCB0aGUgd2luZG93J3MgbG9jYXRpb24gcHJvdG9jb2wvaG9zdG5hbWUvcGF0aG5hbWUgcmVtb3ZlZAoJCQljbGVhbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKTsKCQkJfSwKCgkJCS8vanVzdCByZXR1cm4gdGhlIHVybCB3aXRob3V0IGFuIGluaXRpYWwgIwoJCQlzdHJpcEhhc2g6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9eIy8sICIiICk7CgkJCX0sCgoJCQkvL3JlbW92ZSB0aGUgcHJlY2VkaW5nIGhhc2gsIGFueSBxdWVyeSBwYXJhbXMsIGFuZCBkaWFsb2cgbm90YXRpb25zCgkJCWNsZWFuSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIGhhc2gucmVwbGFjZSggL1w/LiokLywgIiIgKS5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICk7CgkJCX0sCgoJCQlpc0hhc2hWYWxpZDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gL14jW14jXSskLy50ZXN0KGhhc2gpOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IGRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBkb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkJLy8gZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoL14jLykudGVzdCggdS5ocmVmICk7CgkJCX0sCgoKCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCWlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0OiBmdW5jdGlvbiggZG9jVXJsLCByZXFVcmwgKSB7CgkJCQlyZXR1cm4gJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzCgkJCQkJJiYgZG9jVXJsLnByb3RvY29sID09PSAiZmlsZToiCgkJCQkJJiYgcmVxVXJsLnNlYXJjaCggL15odHRwcz86LyApICE9IC0xOwoJCQl9CgkJfSwKCgkJLy93aWxsIGJlIGRlZmluZWQgd2hlbiBhIGxpbmsgaXMgY2xpY2tlZCBhbmQgZ2l2ZW4gYW4gYWN0aXZlIGNsYXNzCgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbCwKCgkJLy91cmxIaXN0b3J5IGlzIHB1cmVseSBoZXJlIHRvIG1ha2UgZ3Vlc3NlcyBhdCB3aGV0aGVyIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIHdhcyBjbGlja2VkCgkJLy9hbmQgcHJvdmlkZSBhbiBhcHByb3ByaWF0ZSB0cmFuc2l0aW9uCgkJdXJsSGlzdG9yeSA9IHsKCQkJLy8gQXJyYXkgb2YgcGFnZXMgdGhhdCBhcmUgdmlzaXRlZCBkdXJpbmcgYSBzaW5nbGUgcGFnZSBsb2FkLgoJCQkvLyBFYWNoIGhhcyBhIHVybCBhbmQgb3B0aW9uYWwgdHJhbnNpdGlvbiwgdGl0bGUsIGFuZCBwYWdlVXJsICh3aGljaCByZXByZXNlbnRzIHRoZSBmaWxlIHBhdGgsIGluIGNhc2VzIHdoZXJlIFVSTCBpcyBvYnNjdXJlZCwgc3VjaCBhcyBkaWFsb2dzKQoJCQlzdGFjazogW10sCgoJCQkvL21haW50YWluIGFuIGluZGV4IG51bWJlciBmb3IgdGhlIGFjdGl2ZSBwYWdlIGluIHRoZSBzdGFjawoJCQlhY3RpdmVJbmRleDogMCwKCgkJCS8vZ2V0IGFjdGl2ZQoJCQlnZXRBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggXTsKCQkJfSwKCgkJCWdldFByZXY6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggLSAxIF07CgkJCX0sCgoJCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB1cmxIaXN0b3J5LnN0YWNrWyB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ICsgMSBdOwoJCQl9LAoKCQkJLy8gYWRkTmV3IGlzIHVzZWQgd2hlbmV2ZXIgYSBuZXcgcGFnZSBpcyBhZGRlZAoJCQlhZGROZXc6IGZ1bmN0aW9uKCB1cmwsIHRyYW5zaXRpb24sIHRpdGxlLCBwYWdlVXJsLCByb2xlICkgewoJCQkJLy9pZiB0aGVyZSdzIGZvcndhcmQgaGlzdG9yeSwgd2lwZSBpdAoJCQkJaWYoIHVybEhpc3RvcnkuZ2V0TmV4dCgpICkgewoJCQkJCXVybEhpc3RvcnkuY2xlYXJGb3J3YXJkKCk7CgkJCQl9CgoJCQkJdXJsSGlzdG9yeS5zdGFjay5wdXNoKCB7dXJsIDogdXJsLCB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCB0aXRsZTogdGl0bGUsIHBhZ2VVcmw6IHBhZ2VVcmwsIHJvbGU6IHJvbGUgfSApOwoKCQkJCXVybEhpc3RvcnkuYWN0aXZlSW5kZXggPSB1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCAtIDE7CgkJCX0sCgoJCQkvL3dpcGUgdXJscyBhaGVhZCBvZiBhY3RpdmUgaW5kZXgKCQkJY2xlYXJGb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJCXVybEhpc3Rvcnkuc3RhY2sgPSB1cmxIaXN0b3J5LnN0YWNrLnNsaWNlKCAwLCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ICsgMSApOwoJCQl9LAoKCQkJZGlyZWN0SGFzaENoYW5nZTogZnVuY3Rpb24oIG9wdHMgKSB7CgkJCQl2YXIgYmFjayAsIGZvcndhcmQsIG5ld0FjdGl2ZUluZGV4LCBwcmV2ID0gdGhpcy5nZXRBY3RpdmUoKTsKCgkJCQkvLyBjaGVjayBpZiB1cmwgaXMgaW4gaGlzdG9yeSBhbmQgaWYgaXQncyBhaGVhZCBvciBiZWhpbmQgY3VycmVudCBwYWdlCgkJCQkkLmVhY2goIHVybEhpc3Rvcnkuc3RhY2ssIGZ1bmN0aW9uKCBpLCBoaXN0b3J5RW50cnkgKSB7CgoJCQkJCS8vaWYgdGhlIHVybCBpcyBpbiB0aGUgc3RhY2ssIGl0J3MgYSBmb3J3YXJkIG9yIGEgYmFjawoJCQkJCWlmICggZGVjb2RlVVJJQ29tcG9uZW50KCBvcHRzLmN1cnJlbnRVcmwgKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KCBoaXN0b3J5RW50cnkudXJsICkgKSB7CgkJCQkJCS8vZGVmaW5lIGJhY2sgYW5kIGZvcndhcmQgYnkgd2hldGhlciB1cmwgaXMgb2xkZXIgb3IgbmV3ZXIgdGhhbiBjdXJyZW50IHBhZ2UKCQkJCQkJYmFjayA9IGkgPCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4OwoJCQkJCQlmb3J3YXJkID0gIWJhY2s7CgkJCQkJCW5ld0FjdGl2ZUluZGV4ID0gaTsKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBzYXZlIG5ldyBwYWdlIGluZGV4LCBudWxsIGNoZWNrIHRvIHByZXZlbnQgZmFsc2V5IDAgcmVzdWx0CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXggIT09IHVuZGVmaW5lZCA/IG5ld0FjdGl2ZUluZGV4IDogdGhpcy5hY3RpdmVJbmRleDsKCgkJCQlpZiggYmFjayApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNCYWNrICkoIHRydWUgKTsKCQkJCX0gZWxzZSBpZiggZm9yd2FyZCApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNGb3J3YXJkICkoIGZhbHNlICk7CgkJCQl9CgkJCX0sCgoJCQkvL2Rpc2FibGUgaGFzaGNoYW5nZSBldmVudCBsaXN0ZW5lciBpbnRlcm5hbGx5IHRvIGlnbm9yZSBvbmUgY2hhbmdlCgkJCS8vdG9nZ2xlZCBpbnRlcm5hbGx5IHdoZW4gbG9jYXRpb24uaGFzaCBpcyB1cGRhdGVkIHRvIG1hdGNoIHRoZSB1cmwgb2YgYSBzdWNjZXNzZnVsIHBhZ2UgbG9hZAoJCQlpZ25vcmVOZXh0SGFzaENoYW5nZTogZmFsc2UKCQl9LAoKCQkvL2RlZmluZSBmaXJzdCBzZWxlY3RvciB0byByZWNlaXZlIGZvY3VzIHdoZW4gYSBwYWdlIGlzIHNob3duCgkJZm9jdXNhYmxlID0gIlt0YWJpbmRleF0sYSxidXR0b246dmlzaWJsZSxzZWxlY3Q6dmlzaWJsZSxpbnB1dCIsCgoJCS8vcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJCXBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy9pbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2UsCgoJCS8vbm9uc2Vuc2UgaGFzaCBjaGFuZ2Uga2V5IGZvciBkaWFsb2dzLCBzbyB0aGV5IGNyZWF0ZSBhIGhpc3RvcnkgZW50cnkKCQlkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciLAoKCQkvL2V4aXN0aW5nIGJhc2UgdGFnPwoJCSRiYXNlID0gJGhlYWQuY2hpbGRyZW4oICJiYXNlIiApLAoKCQkvL3R1Y2sgYXdheSB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgVVJMIG1pbnVzIGFueSBmcmFnbWVudC4KCQlkb2N1bWVudFVybCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLAoKCQkvL2lmIHRoZSBkb2N1bWVudCBoYXMgYW4gZW1iZWRkZWQgYmFzZSB0YWcsIGRvY3VtZW50QmFzZSBpcyBzZXQgdG8gaXRzCgkJLy9pbml0aWFsIHZhbHVlLiBJZiBhIGJhc2UgdGFnIGRvZXMgbm90IGV4aXN0LCB0aGVuIHdlIGRlZmF1bHQgdG8gdGhlIGRvY3VtZW50VXJsLgoJCWRvY3VtZW50QmFzZSA9ICRiYXNlLmxlbmd0aCA/IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCAkYmFzZS5hdHRyKCAiaHJlZiIgKSwgZG9jdW1lbnRVcmwuaHJlZiApICkgOiBkb2N1bWVudFVybCwKCgkJLy9jYWNoZSB0aGUgY29tcGFyaXNvbiBvbmNlLgoJCWRvY3VtZW50QmFzZURpZmZlcnMgPSAoIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggIT09IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICksCgoJCWdldFNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodDsKCgkJLy9iYXNlIGVsZW1lbnQgbWFuYWdlbWVudCwgZGVmaW5lZCBkZXBlbmRpbmcgb24gZHluYW1pYyBiYXNlIHRhZyBzdXBwb3J0CgkJdmFyIGJhc2UgPSAkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgPyB7CgoJCQkvL2RlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQgaW4gQWpheC1yZXF1ZXN0ZWQgbWFya3VwCgkJCWVsZW1lbnQ6ICggJGJhc2UubGVuZ3RoID8gJGJhc2UgOiAkKCAiPGJhc2U+IiwgeyBocmVmOiBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkaGVhZCApICksCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBkb2N1bWVudEJhc2UgKSApOwoJCQl9LAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICk7CgkJCX0KCgkJfSA6IHVuZGVmaW5lZDsKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYoIHRoaXMucGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZCAmJgoJCQluYXYgJiYKCQkJbmF2LmFwcCAmJgoJCQluYXYuYXBwLmJhY2tIaXN0b3J5ICl7CgkJCW5hdi5hcHAuYmFja0hpc3RvcnkoKTsKCQl9IGVsc2UgewoJCQl3aW5kb3cuaGlzdG9yeS5iYWNrKCk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCgiW2F1dG9mb2N1c10iKSwKCQkJcGFnZVRpdGxlID0gcGFnZS5maW5kKCAiLnVpLXRpdGxlOmVxKDApIiApOwoKCQlpZiggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmKCBwYWdlVGl0bGUubGVuZ3RoICkgewoJCQlwYWdlVGl0bGUuZm9jdXMoKTsKCQl9CgkJZWxzZXsKCQkJcGFnZS5mb2N1cygpOwoJCX0KCX0KCgkvL3JlbW92ZSBhY3RpdmUgY2xhc3NlcyBhZnRlciBwYWdlIHRyYW5zaXRpb24gb3IgZXJyb3IKCWZ1bmN0aW9uIHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggZm9yY2VSZW1vdmFsICkgewoJCWlmKCAhISRhY3RpdmVDbGlja2VkTGluayAmJiAoICEkYWN0aXZlQ2xpY2tlZExpbmsuY2xvc2VzdCggJy51aS1wYWdlLWFjdGl2ZScgKS5sZW5ndGggfHwgZm9yY2VSZW1vdmFsICkgKSB7CgkJCSRhY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9CgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbDsKCX0KCglmdW5jdGlvbiByZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCkgewoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQlpZiggcGFnZVRyYW5zaXRpb25RdWV1ZS5sZW5ndGggPiAwICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlLmFwcGx5KCBudWxsLCBwYWdlVHJhbnNpdGlvblF1ZXVlLnBvcCgpICk7CgkJfQoJfQoKCS8vIFNhdmUgdGhlIGxhc3Qgc2Nyb2xsIGRpc3RhbmNlIHBlciBwYWdlLCBiZWZvcmUgaXQgaXMgaGlkZGVuCgl2YXIgc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlLAoJCXNldExhc3RTY3JvbGwsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsOwoKCXNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQkvLyB0aGlzIGJhcnJpZXIgcHJldmVudHMgc2V0dGluZyB0aGUgc2Nyb2xsIHZhbHVlIGJhc2VkIG9uIHRoZSBicm93c2VyCgkJLy8gc2Nyb2xsaW5nIHRoZSB3aW5kb3cgYmFzZWQgb24gYSBoYXNoY2hhbmdlCgkJaWYoICFzZXRMYXN0U2Nyb2xsRW5hYmxlZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCk7CgoJCWlmKCBhY3RpdmUgKSB7CgkJCXZhciBsYXN0U2Nyb2xsID0gJHdpbmRvdy5zY3JvbGxUb3AoKTsKCgkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4KCQkJLy8gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlIHNjcm9sbGluZyB0byBpcyBsZXNzIHRoYW4gbWluU2Nyb2xsQmFjaywgbGV0IGl0IGdvLgoJCQlhY3RpdmUubGFzdFNjcm9sbCA9IGxhc3RTY3JvbGwgPCAkLm1vYmlsZS5taW5TY3JvbGxCYWNrID8gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgOiBsYXN0U2Nyb2xsOwoJCX0KCX07CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIHRvIGdhdGhlciBzY3JvbGwgcG9zaXRpb24uIFRoZSBkZWxheSBhbGxvd3MgZm9yIHRoZSBoYXNoY2hhbmdlCgkvLyBldmVudCB0byBmaXJlIGFuZCBkaXNhYmxlIHNjcm9sbCByZWNvcmRpbmcgaW4gdGhlIGNhc2Ugd2hlcmUgdGhlIGJyb3dzZXIgc2Nyb2xscwoJLy8gdG8gdGhlIGhhc2ggdGFyZ2V0cyBsb2NhdGlvbiAoc29tZXRpbWVzIHRoZSB0b3Agb2YgdGhlIHBhZ2UpLiBvbmNlIHBhZ2VjaGFuZ2UgZmlyZXMKCS8vIGdldExhc3RTY3JvbGwgaXMgYWdhaW4gcGVybWl0dGVkIHRvIG9wZXJhdGUKCWRlbGF5ZWRTZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJc2V0VGltZW91dCggc2V0TGFzdFNjcm9sbCwgMTAwICk7Cgl9OwoKCS8vIGRpc2FibGUgYW4gc2Nyb2xsIHNldHRpbmcgd2hlbiBhIGhhc2hjaGFuZ2UgaGFzIGJlZW4gZmlyZWQsIHRoaXMgb25seSB3b3JrcwoJLy8gYmVjYXVzZSB0aGUgcmVjb3JkaW5nIG9mIHRoZSBzY3JvbGwgcG9zaXRpb24gaXMgZGVsYXllZCBmb3IgMTAwbXMgYWZ0ZXIKCS8vIHRoZSBicm93c2VyIG1pZ2h0IGhhdmUgY2hhbmdlZCB0aGUgcG9zaXRpb24gYmVjYXVzZSBvZiB0aGUgaGFzaGNoYW5nZQoJJHdpbmRvdy5iaW5kKCAkLnN1cHBvcnQucHVzaFN0YXRlID8gInBvcHN0YXRlIiA6ICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkgCXNldExhc3RTY3JvbGxFbmFibGVkID0gZmFsc2U7Cgl9KTsKCgkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkkd2luZG93Lm9uZSggJC5zdXBwb3J0LnB1c2hTdGF0ZSA/ICJwb3BzdGF0ZSIgOiAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCX0pOwoKCS8vIHdhaXQgdW50aWwgdGhlIG1vYmlsZSBwYWdlIGNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIHRvIGJpbmQgdG8gcGFnZWNoYW5nZQoJJHdpbmRvdy5vbmUoICJwYWdlY29udGFpbmVyY3JlYXRlIiwgZnVuY3Rpb24oKXsKCQkvLyBvbmNlIHRoZSBwYWdlIGhhcyBjaGFuZ2VkLCByZS1lbmFibGUgdGhlIHNjcm9sbCByZWNvcmRpbmcKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmJpbmQoICJwYWdlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgoJIAkJc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gcmVtb3ZlIGFueSBiaW5kaW5nIHRoYXQgcHJldmlvdXNseSBleGlzdGVkIG9uIHRoZSBnZXQgc2Nyb2xsCgkJCS8vIHdoaWNoIG1heSBvciBtYXkgbm90IGJlIGRpZmZlcmVudCB0aGFuIHRoZSBzY3JvbGwgZWxlbWVudCBkZXRlcm1pbmVkIGZvcgoJCQkvLyB0aGlzIHBhZ2UgcHJldmlvdXNseQoJCQkkd2luZG93LnVuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCQkJLy8gZGV0ZXJtaW5lIGFuZCBiaW5kIHRvIHRoZSBjdXJyZW50IHNjb2xsIGVsZW1lbnQgd2hpY2ggbWF5IGJlIHRoZSB3aW5kb3cKCQkJLy8gb3IgaW4gdGhlIGNhc2Ugb2YgdG91Y2ggb3ZlcmZsb3cgdGhlIGVsZW1lbnQgd2l0aCB0b3VjaCBvdmVyZmxvdwoJCQkkd2luZG93LmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCQl9KTsKCX0pOwoKCS8vIGJpbmQgdG8gc2Nyb2xsc3RvcCBmb3IgdGhlIGZpcnN0IHBhZ2UgYXMgInBhZ2VjaGFuZ2UiIHdvbid0IGJlIGZpcmVkIGluIHRoYXQgY2FzZQoJJHdpbmRvdy5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgoJLy9mdW5jdGlvbiBmb3IgdHJhbnNpdGlvbmluZyBiZXR3ZWVuIHR3byBleGlzdGluZyBwYWdlcwoJZnVuY3Rpb24gdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCB0cmFuc2l0aW9uLCByZXZlcnNlICkgewoKCQlpZiggZnJvbVBhZ2UgKSB7CgkJCS8vdHJpZ2dlciBiZWZvcmUgc2hvdy9oaWRlIGV2ZW50cwoJCQlmcm9tUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZWhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCX0KCgkJdG9QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAiYmVmb3Jlc2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoKCQkvL2NsZWFyIHBhZ2UgbG9hZGVyCgkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgoJCS8vIElmIHRyYW5zaXRpb24gaXMgZGVmaW5lZCwgY2hlY2sgaWYgY3NzIDNEIHRyYW5zZm9ybXMgYXJlIHN1cHBvcnRlZCwgYW5kIGlmIG5vdCwgaWYgYSBmYWxsYmFjayBpcyBzcGVjaWZpZWQKCQlpZiggdHJhbnNpdGlvbiAmJiAhJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXSApewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrc1sgdHJhbnNpdGlvbiBdOwoJCX0KCgkJLy9maW5kIHRoZSB0cmFuc2l0aW9uIGhhbmRsZXIgZm9yIHRoZSBzcGVjaWZpZWQgdHJhbnNpdGlvbi4gSWYgdGhlcmUKCQkvL2lzbid0IG9uZSBpbiBvdXIgdHJhbnNpdGlvbkhhbmRsZXJzIGRpY3Rpb25hcnksIHVzZSB0aGUgZGVmYXVsdCBvbmUuCgkJLy9jYWxsIHRoZSBoYW5kbGVyIGltbWVkaWF0ZWx5IHRvIGtpY2stb2ZmIHRoZSB0cmFuc2l0aW9uLgoJCXZhciB0aCA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVyc1sgdHJhbnNpdGlvbiB8fCAiZGVmYXVsdCIgXSB8fCAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIsCgkJCXByb21pc2UgPSB0aCggdHJhbnNpdGlvbiwgcmV2ZXJzZSwgdG9QYWdlLCBmcm9tUGFnZSApOwoKCQlwcm9taXNlLmRvbmUoZnVuY3Rpb24oKSB7CgoJCQkvL3RyaWdnZXIgc2hvdy9oaWRlIGV2ZW50cwoJCQlpZiggZnJvbVBhZ2UgKSB7CgkJCQlmcm9tUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCQl9CgoJCQkvL3RyaWdnZXIgcGFnZXNob3csIGRlZmluZSBwcmV2UGFnZSBhcyBlaXRoZXIgZnJvbVBhZ2Ugb3IgZW1wdHkgalF1ZXJ5IG9iagoJCQl0b1BhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJzaG93IiwgbnVsbCwgeyBwcmV2UGFnZTogZnJvbVBhZ2UgfHwgJCggIiIgKSB9ICk7CgkJfSk7CgoJCXJldHVybiBwcm9taXNlOwoJfQoKCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCWZ1bmN0aW9uIHJlc2V0QWN0aXZlUGFnZUhlaWdodCgpewoJCXZhciBhUGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQlhUGFnZVBhZFQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLXRvcCIgKSApLAoJCQlhUGFnZVBhZEIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApLAoJCQlhUGFnZUJvcmRlclQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJib3JkZXItdG9wLXdpZHRoIiApICksCgkJCWFQYWdlQm9yZGVyQiA9IHBhcnNlRmxvYXQoIGFQYWdlLmNzcyggImJvcmRlci1ib3R0b20td2lkdGgiICkgKTsKCgkJYVBhZ2UuY3NzKCAibWluLWhlaWdodCIsIGdldFNjcmVlbkhlaWdodCgpIC0gYVBhZ2VQYWRUIC0gYVBhZ2VQYWRCIC0gYVBhZ2VCb3JkZXJUIC0gYVBhZ2VCb3JkZXJCICk7Cgl9CgoJLy9zaGFyZWQgcGFnZSBlbmhhbmNlbWVudHMKCWZ1bmN0aW9uIGVuaGFuY2VQYWdlKCAkcGFnZSwgcm9sZSApIHsKCQkvLyBJZiBhIHJvbGUgd2FzIHNwZWNpZmllZCwgbWFrZSBzdXJlIHRoZSBkYXRhLXJvbGUgYXR0cmlidXRlCgkJLy8gb24gdGhlIHBhZ2UgZWxlbWVudCBpcyBpbiBzeW5jLgoJCWlmKCByb2xlICkgewoJCQkkcGFnZS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHJvbGUgKTsKCQl9CgoJCS8vcnVuIHBhZ2UgcGx1Z2luCgkJJHBhZ2UucGFnZSgpOwoJfQoKLyogZXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzCSAqLwoKCS8vYW5pbWF0aW9uIGNvbXBsZXRlIGNhbGxiYWNrCgkkLmZuLmFuaW1hdGlvbkNvbXBsZXRlID0gZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCWlmKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgKSB7CgkJCXJldHVybiAkKCB0aGlzICkub25lKCAnd2Via2l0QW5pbWF0aW9uRW5kIGFuaW1hdGlvbmVuZCcsIGNhbGxiYWNrICk7CgkJfQoJCWVsc2V7CgkJCS8vIGRlZmVyIGV4ZWN1dGlvbiBmb3IgY29uc2lzdGVuY3kgYmV0d2VlbiB3ZWJraXQvbm9uIHdlYmtpdAoJCQlzZXRUaW1lb3V0KCBjYWxsYmFjaywgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy9leHBvc2UgcGF0aCBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLnBhdGggPSBwYXRoOwoKCS8vZXhwb3NlIGJhc2Ugb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5iYXNlID0gYmFzZTsKCgkvL2hpc3Rvcnkgc3RhY2sKCSQubW9iaWxlLnVybEhpc3RvcnkgPSB1cmxIaXN0b3J5OwoKCSQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgPSBkaWFsb2dIYXNoS2V5OwoKCgoJLy9lbmFibGUgY3Jvc3MtZG9tYWluIHBhZ2Ugc3VwcG9ydAoJJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzID0gZmFsc2U7CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwgPSBmdW5jdGlvbihhc1BhcnNlZE9iamVjdCkgewoJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgZG9jdW1lbnRVcmwgKSA6IGRvY3VtZW50VXJsLmhyZWY7Cgl9OwoKCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oYXNQYXJzZWRPYmplY3QpIHsKCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIGRvY3VtZW50QmFzZSApIDogZG9jdW1lbnRCYXNlLmhyZWY7Cgl9OwoKCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSA9IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gJCh0aGlzKTsKCgkJLy8gd2hlbiBkb20gY2FjaGluZyBpcyBub3QgZW5hYmxlZCBvciB0aGUgcGFnZSBpcyBlbWJlZGRlZCBiaW5kIHRvIHJlbW92ZSB0aGUgcGFnZSBvbiBoaWRlCgkJaWYoICFwYWdlLmRhdGEoInBhZ2UiKS5vcHRpb25zLmRvbUNhY2hlCgkJCQkmJiBwYWdlLmlzKCI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiKSApIHsKCgkJCXBhZ2UuYmluZCggJ3BhZ2VoaWRlLnJlbW92ZScsIGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCWlmKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJCSR0aGlzLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCk7CgkJCQl9CgkJCX0pOwoJCX0KCX07CgoJLy8gTG9hZCBhIHBhZ2UgaW50byB0aGUgRE9NLgoJJC5tb2JpbGUubG9hZFBhZ2UgPSBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJLy8ga25vdyB3aGVuIHRoZSBwYWdlIGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCXZhciBkZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJCS8vIFRoZSBkZWZhdWx0IGxvYWRQYWdlIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5CgkJCS8vIHRoZSBjYWxsZXIuCgkJCXNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgcGFnZSBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCXBhZ2UgPSBudWxsLAoKCQkJLy8gSWYgdGhlIHJlbG9hZFBhZ2Ugb3B0aW9uIGlzIHRydWUsIGFuZCB0aGUgcGFnZSBpcyBhbHJlYWR5CgkJCS8vIGluIHRoZSBET00sIGR1cENhY2hlZFBhZ2Ugd2lsbCBiZSBzZXQgdG8gdGhlIHBhZ2UgZWxlbWVudAoJCQkvLyBzbyB0aGF0IGl0IGNhbiBiZSByZW1vdmVkIGFmdGVyIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUKCQkJLy8gcGFnZSBpcyBsb2FkZWQgb2ZmIHRoZSBuZXR3b3JrLgoJCQlkdXBDYWNoZWRQYWdlID0gbnVsbCwKCgkJCS8vIGRldGVybWluZSB0aGUgY3VycmVudCBiYXNlIHVybAoJCQlmaW5kQmFzZVdpdGhEZWZhdWx0ID0gZnVuY3Rpb24oKXsKCQkJCXZhciBjbG9zZXN0QmFzZSA9ICggJC5tb2JpbGUuYWN0aXZlUGFnZSAmJiBnZXRDbG9zZXN0QmFzZVVybCggJC5tb2JpbGUuYWN0aXZlUGFnZSApICk7CgkJCQlyZXR1cm4gY2xvc2VzdEJhc2UgfHwgZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgkJCX0sCgoJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIHBhc3NlZCBpbnRvIHRoZSBmdW5jdGlvbi4gVGhpcwoJCQkvLyB2ZXJzaW9uIG9mIHRoZSBVUkwgbWF5IGNvbnRhaW4gZGlhbG9nL3N1YnBhZ2UgcGFyYW1zIGluIGl0LgoJCQlhYnNVcmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBmaW5kQmFzZVdpdGhEZWZhdWx0KCkgKTsKCgoJCS8vIElmIHRoZSBjYWxsZXIgcHJvdmlkZWQgZGF0YSwgYW5kIHdlJ3JlIHVzaW5nICJnZXQiIHJlcXVlc3QsCgkJLy8gYXBwZW5kIHRoZSBkYXRhIHRvIHRoZSBVUkwuCgkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJnZXQiICkgewoJCQlhYnNVcmwgPSBwYXRoLmFkZFNlYXJjaFBhcmFtcyggYWJzVXJsLCBzZXR0aW5ncy5kYXRhICk7CgkJCXNldHRpbmdzLmRhdGEgPSB1bmRlZmluZWQ7CgkJfQoKCQkvLyBJZiB0aGUgY2FsbGVyIGlzIHVzaW5nIGEgInBvc3QiIHJlcXVlc3QsIHJlbG9hZFBhZ2UgbXVzdCBiZSB0cnVlCgkJaWYoICBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJwb3N0IiApewoJCQlzZXR0aW5ncy5yZWxvYWRQYWdlID0gdHJ1ZTsKCQl9CgoJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgbWludXMgYW55IGRpYWxvZy9zdWJwYWdlIHBhcmFtcy4KCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgcGFnZSB0byBiZSBsb2FkZWQuCgkJdmFyIGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCBhYnNVcmwgKSwKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIHBhZ2UuIEZvciBlbWJlZGRlZCBwYWdlcywgaXQgaXMganVzdCB0aGUgaWQgb2YgdGhlIHBhZ2UuIEZvciBwYWdlcwoJCQkvLyB3aXRoaW4gdGhlIHNhbWUgZG9tYWluIGFzIHRoZSBkb2N1bWVudCBiYXNlLCBpdCBpcyB0aGUgc2l0ZSByZWxhdGl2ZQoJCQkvLyBwYXRoLiBGb3IgY3Jvc3MtZG9tYWluIHBhZ2VzIChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZSBhYnNvbHV0ZSBVcmwKCQkJLy8gdXNlZCB0byBsb2FkIHRoZSBwYWdlLgoJCQlkYXRhVXJsID0gcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBhYnNVcmwgKTsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBwYWdlQ29udGFpbmVyIHRvIHdvcmsgd2l0aC4KCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkvLyBDaGVjayB0byBzZWUgaWYgdGhlIHBhZ2UgYWxyZWFkeSBleGlzdHMgaW4gdGhlIERPTS4KCQkvLyBOT1RFIGRvIF9ub3RfIHVzZSB0aGUgOmpxbURhdGEgcHN1ZWRvIHNlbGVjdG9yIGJlY2F1c2UgcGFyZW50aGVzaXMKCQkvLyAgICAgIGFyZSBhIHZhbGlkIHVybCBjaGFyIGFuZCBpdCBicmVha3Mgb24gdGhlIGZpcnN0IG9jY3VyZW5jZQoJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCgkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkvLyByZWZlcmVuY2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4gSWYgc28sIGl0IG1heSBoYXZlIGJlZW4gZHluYW1pY2FsbHkKCQkvLyBpbmplY3RlZCBieSBhIGRldmVsb3BlciwgaW4gd2hpY2ggY2FzZSBpdCB3b3VsZCBiZSBsYWNraW5nIGEgZGF0YS11cmwKCQkvLyBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCAmJiBkYXRhVXJsICYmICFwYXRoLmlzUGF0aCggZGF0YVVybCApICkgewoJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIiMiICsgZGF0YVVybCApCgkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIGRhdGFVcmwgKTsKCQl9CgoJCQoJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCS8vIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgYXBwbGljYXRpb24uIElmIGl0IGlzbid0IGEgcmVmZXJlbmNlCgkJLy8gdG8gdGhlIGZpcnN0IHBhZ2UgYW5kIHJlZmVycyB0byBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSwgZXJyb3Igb3V0LgoJCWlmICggcGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlICYmIHBhdGguaXNGaXJzdFBhZ2VVcmwoIGZpbGVVcmwgKSApIHsKCQkJCS8vIENoZWNrIHRvIG1ha2Ugc3VyZSBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkKCQkJCS8vIGluIHRoZSBET00uIFNvbWUgdXNlciBkZXBsb3llZCBhcHBzIGFyZSBwcnVuaW5nIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBmcm9tIHRoZSBET00gZm9yIHZhcmlvdXMgcmVhc29ucywgd2UgY2hlY2sgZm9yIHRoaXMKCQkJCS8vIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGggYW4gaWQKCQkJCS8vIGZhbGxpbmcgdGhyb3VnaCB0byB0aGUgbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UgZXJyb3IKCQkJCS8vIGNhc2UuIElmIHRoZSBmaXJzdC1wYWdlIGlzIG5vdCBpbiB0aGUgRE9NLCB0aGVuIHdlIGxldAoJCQkJLy8gdGhpbmdzIGZhbGwgdGhyb3VnaCB0byB0aGUgYWpheCBsb2FkaW5nIGNvZGUgYmVsb3cgc28KCQkJCS8vIHRoYXQgaXQgZ2V0cyByZWxvYWRlZC4KCQkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlLnBhcmVudCgpLmxlbmd0aCApIHsKCQkJCQlwYWdlID0gJCggJC5tb2JpbGUuZmlyc3RQYWdlICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIGZpbGVVcmwgKSAgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCX0KCQkKCQkvLyBJZiB0aGUgcGFnZSB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJLy8gYW5kIHRoZSBjYWxsZXIgZGlkIG5vdCBpbmRpY2F0ZSB0aGF0IHdlIHNob3VsZCBmb3JjZSBhCgkJLy8gcmVsb2FkIG9mIHRoZSBmaWxlLCB3ZSBhcmUgZG9uZS4gT3RoZXJ3aXNlLCB0cmFjayB0aGUKCQkvLyBleGlzdGluZyBwYWdlIGFzIGEgZHVwbGljYXRlZC4KCQlpZiAoIHBhZ2UubGVuZ3RoICkgewoJCQlpZiAoICFzZXR0aW5ncy5yZWxvYWRQYWdlICkgewoJCQkJZW5oYW5jZVBhZ2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSApOwoJCQkJLy9pZiB3ZSBhcmUgcmVsb2FkaW5nIHRoZSBwYWdlIG1ha2Ugc3VyZSB3ZSB1cGRhdGUgdGhlIGJhc2UgaWYgaXRzIG5vdCBhIHByZWZldGNoIAoJCQkJaWYoIGJhc2UgJiYgIW9wdGlvbnMucHJlZmV0Y2ggKXsKCQkJCQliYXNlLnNldCh1cmwpOwoJCQkJfQoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCQlkdXBDYWNoZWRQYWdlID0gcGFnZTsKCQl9CgkJdmFyIG1wYyA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIsCgkJCXBibEV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlbG9hZCIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHVybDogdXJsLCBhYnNVcmw6IGFic1VybCwgZGF0YVVybDogZGF0YVVybCwgZGVmZXJyZWQ6IGRlZmVycmVkLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBhIHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBibEV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiggcGJsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQl9CgoJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgoJCQkvLyBUaGlzIGNvbmZpZ3VyYWJsZSB0aW1lb3V0IGFsbG93cyBjYWNoZWQgcGFnZXMgYSBicmllZiBkZWxheSB0byBsb2FkIHdpdGhvdXQgc2hvd2luZyBhIG1lc3NhZ2UKCQkJdmFyIGxvYWRNc2dEZWxheSA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCQkJCX0sIHNldHRpbmdzLmxvYWRNc2dEZWxheSApLAoKCQkJCS8vIFNoYXJlZCBsb2dpYyBmb3IgY2xlYXJpbmcgdGltZW91dCBhbmQgcmVtb3ZpbmcgbWVzc2FnZS4KCQkJCWhpZGVNc2cgPSBmdW5jdGlvbigpewoKCQkJCQkvLyBTdG9wIG1lc3NhZ2Ugc2hvdyB0aW1lcgoJCQkJCWNsZWFyVGltZW91dCggbG9hZE1zZ0RlbGF5ICk7CgoJCQkJCS8vIEhpZGUgbG9hZGluZyBtZXNzYWdlCgkJCQkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9OwoJCX0KCQkvLyBSZXNldCBiYXNlIHRvIHRoZSBkZWZhdWx0IGRvY3VtZW50IGJhc2UuCgkJLy8gb25seSByZXNldCBpZiB3ZSBhcmUgbm90IHByZWZldGNoaW5nIAoJCWlmICggYmFzZSAmJiB0eXBlb2Ygb3B0aW9ucy5wcmVmZXRjaCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCWJhc2UucmVzZXQoKTsKCQl9CgoJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8IHBhdGguaXNTYW1lRG9tYWluKCBkb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQl9IGVsc2UgewoJCQkvLyBMb2FkIHRoZSBuZXcgcGFnZS4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCQkvL3VzZSBpdCBhcyB0aGUgbmV3IGZpbGVVcmwsIGJhc2UgcGF0aCwgZXRjCgkJCQkJdmFyIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKSwKCgkJCQkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJCQkJbmV3UGFnZVRpdGxlID0gaHRtbC5tYXRjaCggLzx0aXRsZVtePl0qPihbXjxdKikvICkgJiYgUmVnRXhwLiQxLAoKCQkJCQkJLy8gVE9ETyBoYW5kbGUgZGlhbG9ncyBhZ2FpbgoJCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoJCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsPVtcIiddPyhbXlwiJz5dKilbXCInXT8iICk7CgoKCQkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMgY2FuIGJlIGRpcmVjdGVkIHRvIHRoZQoJCQkJCS8vIGNvcnJlY3QgdXJsLiBsb2FkaW5nIGludG8gYSB0ZW1wcm9yYXJ5IGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCQlpZiggcGFnZUVsZW1SZWdleC50ZXN0KCBodG1sICkKCQkJCQkJCSYmIFJlZ0V4cC4kMQoJCQkJCQkJJiYgZGF0YVVybFJlZ2V4LnRlc3QoIFJlZ0V4cC4kMSApCgkJCQkJCQkmJiBSZWdFeHAuJDEgKSB7CgkJCQkJCXVybCA9IGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCBSZWdFeHAuJDEgKTsKCQkJCQl9CgkJCQkJLy9kb250IHVwZGF0ZSB0aGUgYmFzZSB0YWcgaWYgd2UgYXJlIHByZWZldGNoaW5nCgkJCQkJaWYgKCBiYXNlICYmIHR5cGVvZiBvcHRpb25zLnByZWZldGNoID09PSAidW5kZWZpbmVkIikgewoJCQkJCQliYXNlLnNldCggZmlsZVVybCApOwoJCQkJCX0KCgkJCQkJLy93b3JrYXJvdW5kIHRvIGFsbG93IHNjcmlwdHMgdG8gZXhlY3V0ZSB3aGVuIGluY2x1ZGVkIGluIHBhZ2UgZGl2cwoJCQkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoJCQkJCXBhZ2UgPSBhbGwuZmluZCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkuZmlyc3QoKTsKCgkJCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJCQlpZiggIXBhZ2UubGVuZ3RoICl7CgkJCQkJCXBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz4iICsgaHRtbC5zcGxpdCggLzxcLz9ib2R5W14+XSo+L2dtaSApWzFdICsgIjwvZGl2PiIgKTsKCQkJCQl9CgoJCQkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCQkJaWYgKCB+bmV3UGFnZVRpdGxlLmluZGV4T2YoICImIiApICkgewoJCQkJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJCQl9CgkJCQkJCXBhZ2UuanFtRGF0YSggInRpdGxlIiwgbmV3UGFnZVRpdGxlICk7CgkJCQkJfQoKCQkJCQkvL3Jld3JpdGUgc3JjIGFuZCBocmVmIGF0dHJzIHRvIHVzZSBhIGJhc2UgdXJsCgkJCQkJaWYoICEkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgKSB7CgkJCQkJCXZhciBuZXdQYXRoID0gcGF0aC5nZXQoIGZpbGVVcmwgKTsKCQkJCQkJcGFnZS5maW5kKCAiW3NyY10sIGxpbmtbaHJlZl0sIGFbcmVsPSdleHRlcm5hbCddLCA6anFtRGF0YShhamF4PSdmYWxzZScpLCBhW3RhcmdldF0iICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkJCXZhciB0aGlzQXR0ciA9ICQoIHRoaXMgKS5pcyggJ1tocmVmXScgKSA/ICdocmVmJyA6CgkJCQkJCQkJCSQodGhpcykuaXMoJ1tzcmNdJykgPyAnc3JjJyA6ICdhY3Rpb24nLAoJCQkJCQkJCXRoaXNVcmwgPSAkKCB0aGlzICkuYXR0ciggdGhpc0F0dHIgKTsKCgkJCQkJCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gZml4IHRoaXMgc28gdGhhdCBpdCByZW1vdmVzIHRoZSBkb2N1bWVudAoJCQkJCQkJLy8gICAgICAgICAgICBiYXNlIFVSTCwgYW5kIHRoZW4gcHJlcGVuZHMgd2l0aCB0aGUgbmV3IHBhZ2UgVVJMLgoJCQkJCQkJLy9pZiBmdWxsIHBhdGggZXhpc3RzIGFuZCBpcyBzYW1lLCBjaG9wIGl0IC0gaGVscHMgSUUgb3V0CgkJCQkJCQl0aGlzVXJsID0gdGhpc1VybC5yZXBsYWNlKCBsb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUsICcnICk7CgoJCQkJCQkJaWYoICEvXihcdys6fCN8XC8pLy50ZXN0KCB0aGlzVXJsICkgKSB7CgkJCQkJCQkJJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyLCBuZXdQYXRoICsgdGhpc1VybCApOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCS8vYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJCQkvLyBUT0RPIHRhZ2luZyBhIHBhZ2Ugd2l0aCBleHRlcm5hbCB0byBtYWtlIHN1cmUgdGhhdCBlbWJlZGRlZCBwYWdlcyBhcmVuJ3QgcmVtb3ZlZAoJCQkJCS8vICAgICAgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZSBpbiBtYW55CgkJCQkJLy8gICAgICBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJCQlwYWdlCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBmaWxlVXJsICkgKQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICkKCQkJCQkJLmFwcGVuZFRvKCBzZXR0aW5ncy5wYWdlQ29udGFpbmVyICk7CgoJCQkJCS8vIHdhaXQgZm9yIHBhZ2UgY3JlYXRpb24gdG8gbGV2ZXJhZ2Ugb3B0aW9ucyBkZWZpbmVkIG9uIHdpZGdldAoJCQkJCXBhZ2Uub25lKCAncGFnZWNyZWF0ZScsICQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSApOwoKCQkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJCQkvLyBFbmhhbmNpbmcgdGhlIHBhZ2UgbWF5IHJlc3VsdCBpbiBuZXcgZGlhbG9ncy9zdWIgcGFnZXMgYmVpbmcgaW5zZXJ0ZWQKCQkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLXBhZ2UsIHRoYXQgaXMgdGhlCgkJCQkJLy8gcmVhbCBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluLgoJCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgkJCQkJfQoKCQkJCQkvL2JpbmQgcGFnZUhpZGUgdG8gcmVtb3ZlUGFnZSBhZnRlciBpdCdzIGhpZGRlbiwgaWYgdGhlIHBhZ2Ugb3B0aW9ucyBzcGVjaWZ5IHRvIGRvIHNvCgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQkJaGlkZU1zZygpOwoJCQkJCX0KCgkJCQkJLy8gQWRkIHRoZSBwYWdlIHJlZmVyZW5jZSBhbmQgeGhyIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEucGFnZSA9IHBhZ2U7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2Vsb2FkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlLCBkdXBDYWNoZWRQYWdlICk7CgkJCQl9LAoJCQkJZXJyb3I6IGZ1bmN0aW9uKCB4aHIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duICkgewoJCQkJCS8vc2V0IGJhc2UgYmFjayB0byBjdXJyZW50IHBhdGgKCQkJCQlpZiggYmFzZSApIHsKCQkJCQkJYmFzZS5zZXQoIHBhdGguZ2V0KCkgKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCBlcnJvciBpbmZvIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEuZXJyb3JUaHJvd24gPSBlcnJvclRocm93bjsKCgkJCQkJdmFyIHBsZkV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlbG9hZGZhaWxlZCIgKTsKCgkJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBwYWdlIGxvYWQgZmFpbGVkLgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggcGxmRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCQkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCQkvLyB0aGF0IGNhbGxlZCBwcmV2ZW50RGVmYXVsdCgpLCB0byByZXNvbHZlL3JlamVjdCB0aGUKCQkJCQkvLyBkZWZlcnJlZCBvYmplY3Qgd2l0aGluIHRoZSB0cmlnZ2VyRGF0YS4KCQkJCQlpZiggcGxmRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQkJaGlkZU1zZygpOwoKCQkJCQkJLy8gc2hvdyBlcnJvciBtZXNzYWdlCgkJCQkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZyggJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZSwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2UsIHRydWUgKTsKCgkJCQkJCS8vIGhpZGUgYWZ0ZXIgZGVsYXkKCQkJCQkJc2V0VGltZW91dCggJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnLCAxNTAwICk7CgkJCQkJfQoKCQkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9OwoKCSQubW9iaWxlLmxvYWRQYWdlLmRlZmF1bHRzID0gewoJCXR5cGU6ICJnZXQiLAoJCWRhdGE6IHVuZGVmaW5lZCwKCQlyZWxvYWRQYWdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlzaG93TG9hZE1zZzogZmFsc2UsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCWxvYWRNc2dEZWxheTogNTAgLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0byBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCX07CgoJLy8gU2hvdyBhIHNwZWNpZmljIHBhZ2UgaW4gdGhlIHBhZ2UgY29udGFpbmVyLgoJJC5tb2JpbGUuY2hhbmdlUGFnZSA9IGZ1bmN0aW9uKCB0b1BhZ2UsIG9wdGlvbnMgKSB7CgkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJLy8gV2UnbGwgY2FsbCBjaGFuZ2VQYWdlKCkgb25jZSB3ZSdyZSBkb25lIHdpdGggdGhlIGN1cnJlbnQgdHJhbnNpdGlvbiB0bwoJCS8vIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJaWYoIGlzUGFnZVRyYW5zaXRpb25pbmcgKSB7CgkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggYXJndW1lbnRzICk7CgkJCXJldHVybjsKCQl9CgoJCXZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJc2V0dGluZ3MuZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSB8fCAkLm1vYmlsZS5hY3RpdmVQYWdlOwoKCQl2YXIgbXBjID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciwKCQkJcGJjRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVjaGFuZ2UiICksCgkJCXRyaWdnZXJEYXRhID0geyB0b1BhZ2U6IHRvUGFnZSwgb3B0aW9uczogc2V0dGluZ3MgfTsKCgkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGNoYW5nZSB0aGUgY3VycmVudCBwYWdlLgoJCW1wYy50cmlnZ2VyKCBwYmNFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJaWYoIHBiY0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIGFsbG93ICJwYWdlYmVmb3JlY2hhbmdlIiBvYnNlcnZlcnMgdG8gbW9kaWZ5IHRoZSB0b1BhZ2UgaW4gdGhlIHRyaWdnZXIKCQkvLyBkYXRhIHRvIGFsbG93IGZvciByZWRpcmVjdHMuIE1ha2Ugc3VyZSBvdXIgdG9QYWdlIGlzIHVwZGF0ZWQuCgoJCXRvUGFnZSA9IHRyaWdnZXJEYXRhLnRvUGFnZTsKCgkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkvLyBvciB0cmFuc2l0aW9uaW5nLgoKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCgkJLy8gSWYgdGhlIGNhbGxlciBwYXNzZWQgdXMgYSB1cmwsIGNhbGwgbG9hZFBhZ2UoKQoJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkvLyB0byB0aGUgcHJvbWlzZSBvYmplY3QgaXQgcmV0dXJucyBzbyB3ZSBrbm93IHdoZW4KCQkvLyBpdCBpcyBkb25lIGxvYWRpbmcgb3IgaWYgYW4gZXJyb3Igb2N1cnJlZC4KCQlpZiAoIHR5cGVvZiB0b1BhZ2UgPT0gInN0cmluZyIgKSB7CgkJCSQubW9iaWxlLmxvYWRQYWdlKCB0b1BhZ2UsIHNldHRpbmdzICkKCQkJCS5kb25lKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMsIG5ld1BhZ2UsIGR1cENhY2hlZFBhZ2UgKSB7CgkJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQkJCW9wdGlvbnMuZHVwbGljYXRlQ2FjaGVkUGFnZSA9IGR1cENhY2hlZFBhZ2U7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggbmV3UGFnZSwgb3B0aW9ucyApOwoJCQkJfSkKCQkJCS5mYWlsKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgoJCQkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgoJCQkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2VjaGFuZ2VmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoJCQkJfSk7CgkJCXJldHVybjsKCQl9CgoJCS8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZmlyc3QtcGFnZSBvZiB0aGUgYXBwbGljYXRpb24sIHdlIG5lZWQgdG8gbWFrZQoJCS8vIHN1cmUgc2V0dGluZ3MuZGF0YVVybCBpcyBzZXQgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVybC4gVGhpcyBhbGxvd3MKCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkvLyBmaXJzdC1wYWdlIG9mIHRoZSBkb2N1bWVudCBoYXMgYW4gaWQgYXR0cmlidXRlIHNwZWNpZmllZC4KCQlpZiAoIHRvUGFnZVsgMCBdID09PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSAmJiAhc2V0dGluZ3MuZGF0YVVybCApIHsKCQkJc2V0dGluZ3MuZGF0YVVybCA9IGRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJfQoKCQkvLyBUaGUgY2FsbGVyIHBhc3NlZCB1cyBhIHJlYWwgcGFnZSBET00gZWxlbWVudC4gVXBkYXRlIG91cgoJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCXZhciBmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlLAoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBzZXR0aW5ncy5kYXRhVXJsICkgKSB8fCB0b1BhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQgYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmwsCgkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCB1cmwgKSwKCQkJYWN0aXZlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9IHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAsCgkJCWhpc3RvcnlEaXIgPSAwLAoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZSwKCQkJaXNEaWFsb2cgPSBzZXR0aW5ncy5yb2xlID09PSAiZGlhbG9nIiB8fCB0b1BhZ2UuanFtRGF0YSggInJvbGUiICkgPT09ICJkaWFsb2ciOwoKCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50IG1hbnVhbGx5L2R5bmFtaWNhbGx5CgkJLy8gYW5kIHJldXNlIHBhZ2VzIHdhbnQgdG8gYmUgYWJsZSB0byB0cmFuc2l0aW9uIHRvIHRoZSBzYW1lIHBhZ2UuIFRvIGFsbG93CgkJLy8gdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0IHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uCgkJLy8gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbiBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLgoJCS8vIEl0IHNob3VsZCBiZSBub3RlZCB0aGF0IG91ciBkZWZhdWx0IHRyYW5zaXRpb24gYW5pbWF0aW9ucyBhc3N1bWUgdGhhdCB0aGUKCQkvLyBmb3JtUGFnZSBhbmQgdG9QYWdlIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuCgkJLy8gSXQgaXMgdXAgdG8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uCgkJLy8gdG8gZWl0aGVyIHR1cm4gb2ZmIHRyYW5zaXRpb24gYW5pbWF0aW9ucywgb3IgbWFrZSBzdXJlIHRoYXQgYW4gYXBwcm9wcmlhdGUKCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCWlmKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmICFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUgdXJsSGlzdG9yeSBpbiBzeW5jIHdpdGggdGhlIGhhc2ggY2hhbmdlcwoJCQlpZiggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJCWN1cnJlbnRVcmw6CXVybCwKCQkJCQlpc0JhY2s6CQlmdW5jdGlvbigpIHt9LAoJCQkJCWlzRm9yd2FyZDoJZnVuY3Rpb24oKSB7fQoJCQkJfSk7CgkJCX0KCgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYWdlIHdlIGFyZSBnaXZlbiBoYXMgYWxyZWFkeSBiZWVuIGVuaGFuY2VkLgoJCWVuaGFuY2VQYWdlKCB0b1BhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJLy8gSWYgdGhlIGNoYW5nZVBhZ2UgcmVxdWVzdCB3YXMgc2VudCBmcm9tIGEgaGFzaENoYW5nZSBldmVudCwgY2hlY2sgdG8gc2VlIGlmIHRoZQoJCS8vIHBhZ2UgaXMgYWxyZWFkeSB3aXRoaW4gdGhlIHVybEhpc3Rvcnkgc3RhY2suIElmIHNvLCB3ZSdsbCBhc3N1bWUgdGhlIHVzZXIgaGl0CgkJLy8gdGhlIGZvcndhcmQvYmFjayBidXR0b24gYW5kIHdpbGwgdHJ5IHRvIG1hdGNoIHRoZSB0cmFuc2l0aW9uIGFjY29yZGluZ2x5LgoJCWlmKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCWN1cnJlbnRVcmw6CXVybCwKCQkJCWlzQmFjazoJCWZ1bmN0aW9uKCkgeyBoaXN0b3J5RGlyID0gLTE7IH0sCgkJCQlpc0ZvcndhcmQ6CWZ1bmN0aW9uKCkgeyBoaXN0b3J5RGlyID0gMTsgfQoJCQl9KTsKCQl9CgoJCS8vIEtpbGwgdGhlIGtleWJvYXJkLgoJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4gSW5zdGVhZCwKCQkvLyAgICAgICAgICAgIHdlIHNob3VsZCBiZSB0cmFja2luZyBmb2N1cyB3aXRoIGEgZGVsZWdhdGUoKSBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZQoJCS8vICAgICAgICAgICAgdGhlIGVsZW1lbnQgaW4gaGFuZCBhdCB0aGlzIHBvaW50LgoJCS8vIFdyYXAgdGhpcyBpbiBhIHRyeS9jYXRjaCBibG9jayBzaW5jZSBJRTkgdGhyb3cgIlVuc3BlY2lmaWVkIGVycm9yIiBpZiBkb2N1bWVudC5hY3RpdmVFbGVtZW50CgkJLy8gaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQl0cnkgewoJCQlpZihkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPSAnYm9keScpIHsKCQkJCSQoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkuYmx1cigpOwoJCQl9IGVsc2UgewoJCQkJJCggImlucHV0OmZvY3VzLCB0ZXh0YXJlYTpmb2N1cywgc2VsZWN0OmZvY3VzIiApLmJsdXIoKTsKCQkJfQoJCX0gY2F0Y2goZSkge30KCgkJLy8gUmVjb3JkIHdoZXRoZXIgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB3aGVyZSBhIGRpYWxvZyB1c2VkIHRvIGJlIC0gaWYgc28sIGRvIG5vdCBhZGQgYSBuZXcgaGlzdG9yeSBlbnRyeSBhbmQgZG8gbm90IGNoYW5nZSB0aGUgaGFzaCBlaXRoZXIKCQl2YXIgYWxyZWFkeVRoZXJlID0gZmFsc2U7CgoJCS8vIElmIHdlJ3JlIGRpc3BsYXlpbmcgdGhlIHBhZ2UgYXMgYSBkaWFsb2csIHdlIGRvbid0IHdhbnQgdGhlIHVybAoJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCS8vIHRvIGFwcGVuZCB0aGUgZGlhbG9nSGFzaEtleSB0byB0aGUgdXJsIG9mIHRoZSBjdXJyZW50IHBhZ2UuCgkJaWYgKCBpc0RpYWxvZyAmJiBhY3RpdmUgKSB7CgkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlIHNob3VsZAoJCQkvLyBiZSBhbiBlbXB0eSBzdHJpbmcuIE1vdmluZyB0aGUgdW5kZWZpbmVkIC0+IGVtcHR5IHN0cmluZyBiYWNrIGludG8KCQkJLy8gdXJsSGlzdG9yeS5hZGROZXcgc2VlbWVkIGltcHJ1ZGVudCBnaXZlbiB1bmRlZmluZWQgYmV0dGVyIHJlcHJlc2VudHMKCQkJLy8gdGhlIHVybCBzdGF0ZQoKCQkJLy8gSWYgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB0aGF0IG9uY2UgYmVsb25nZWQgdG8gYSBkaWFsb2csIHJldXNlCgkJCS8vIHRoaXMgc3RhdGUgd2l0aG91dCBhZGRpbmcgdG8gdXJsSGlzdG9yeSBhbmQgd2l0aG91dCBtb2RpZnlpbmcgdGhlIGhhc2guCgkJCS8vIEhvd2V2ZXIsIGlmIGEgZGlhbG9nIGlzIGFscmVhZHkgZGlzcGxheWVkIGF0IHRoaXMgcG9pbnQsIGFuZCB3ZSdyZQoJCQkvLyBhYm91dCB0byBkaXNwbGF5IGFub3RoZXIgZGlhbG9nLCB0aGVuIHdlIG11c3QgYWRkIGFub3RoZXIgaGFzaCBhbmQKCQkJLy8gaGlzdG9yeSBlbnRyeSBvbiB0b3Agc28gdGhhdCBvbmUgbWF5IG5hdmlnYXRlIGJhY2sgdG8gdGhlIG9yaWdpbmFsIGRpYWxvZwoJCQlpZiAoIGFjdGl2ZS51cmwgJiYgYWN0aXZlLnVybC5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSAmJiAhJC5tb2JpbGUuYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICkgKSB7CgkJCQlzZXR0aW5ncy5jaGFuZ2VIYXNoID0gZmFsc2U7CgkJCQlhbHJlYWR5VGhlcmUgPSB0cnVlOwoJCQl9CgoJCQl1cmwgPSAoIGFjdGl2ZS51cmwgfHwgIiIgKSArIGRpYWxvZ0hhc2hLZXk7CgoJCQkvLyB0YWNrIG9uIGFub3RoZXIgZGlhbG9nSGFzaEtleSBpZiB0aGlzIGlzIHRoZSBzYW1lIGFzIHRoZSBpbml0aWFsIGhhc2gKCQkJLy8gdGhpcyBtYWtlcyBzdXJlIHRoYXQgYSBoaXN0b3J5IGVudHJ5IGlzIGNyZWF0ZWQgZm9yIHRoaXMgZGlhbG9nCgkJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJCXVybCArPSBkaWFsb2dIYXNoS2V5OwoJCQl9CgkJfQoKCQkvLyBTZXQgdGhlIGxvY2F0aW9uIGhhc2guCgkJaWYoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmIHVybCApIHsKCQkJLy9kaXNhYmxlIGhhc2ggbGlzdGVuaW5nIHRlbXBvcmFyaWx5CgkJCXVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSB0cnVlOwoJCQkvL3VwZGF0ZSBoYXNoIGFuZCBoaXN0b3J5CgkJCXBhdGguc2V0KCB1cmwgKTsKCQl9CgoJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QgdXNlIHBhZ2VUaXRsZQoJCXZhciBuZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKT8gcGFnZVRpdGxlIDogdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSB8fCB0b1BhZ2UuY2hpbGRyZW4oIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIikuZmluZCgiLnVpLXRpdGxlIiApLmdldEVuY29kZWRUZXh0KCk7CgkJaWYoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PSBkb2N1bWVudC50aXRsZSApIHsKCQkJcGFnZVRpdGxlID0gbmV3UGFnZVRpdGxlOwoJCX0KCQlpZiAoICF0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApICkgewoJCQl0b1BhZ2UuanFtRGF0YSggInRpdGxlIiwgcGFnZVRpdGxlICk7CgkJfQoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHRyYW5zaXRpb24gZGVmaW5lZC4KCQlzZXR0aW5ncy50cmFuc2l0aW9uID0gc2V0dGluZ3MudHJhbnNpdGlvbgoJCQl8fCAoICggaGlzdG9yeURpciAmJiAhYWN0aXZlSXNJbml0aWFsUGFnZSApID8gYWN0aXZlLnRyYW5zaXRpb24gOiB1bmRlZmluZWQgKQoJCQl8fCAoIGlzRGlhbG9nID8gJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gOiAkLm1vYmlsZS5kZWZhdWx0UGFnZVRyYW5zaXRpb24gKTsKCgkJLy9hZGQgcGFnZSB0byBoaXN0b3J5IHN0YWNrIGlmIGl0J3Mgbm90IGJhY2sgb3IgZm9yd2FyZAoJCWlmKCAhaGlzdG9yeURpciAmJiAhYWxyZWFkeVRoZXJlICkgewoJCQl1cmxIaXN0b3J5LmFkZE5ldyggdXJsLCBzZXR0aW5ncy50cmFuc2l0aW9uLCBwYWdlVGl0bGUsIHBhZ2VVcmwsIHNldHRpbmdzLnJvbGUgKTsKCQl9CgoJCS8vc2V0IHBhZ2UgdGl0bGUKCQlkb2N1bWVudC50aXRsZSA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCkudGl0bGU7CgoJCS8vc2V0ICJ0b1BhZ2UiIGFzIGFjdGl2ZVBhZ2UKCQkkLm1vYmlsZS5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQlzZXR0aW5ncy5yZXZlcnNlID0gc2V0dGluZ3MucmV2ZXJzZSB8fCBoaXN0b3J5RGlyIDwgMDsKCgkJdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCBzZXR0aW5ncy50cmFuc2l0aW9uLCBzZXR0aW5ncy5yZXZlcnNlICkKCQkJLmRvbmUoZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIGFscmVhZHlGb2N1c2VkICkgewoJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCk7CgoJCQkJLy9pZiB0aGVyZSdzIGEgZHVwbGljYXRlQ2FjaGVkUGFnZSwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBub3cgdGhhdCBpdCdzIGhpZGRlbgoJCQkJaWYgKCBzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlICkgewoJCQkJCXNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UucmVtb3ZlKCk7CgkJCQl9CgoJCQkJLy8gU2VuZCBmb2N1cyB0byB0aGUgbmV3bHkgc2hvd24gcGFnZS4gTW92ZWQgZnJvbSBwcm9taXNlIC5kb25lIGJpbmRpbmcgaW4gdHJhbnNpdGlvblBhZ2VzCgkJCQkvLyBpdHNlbGYgdG8gYXZvaWQgaWUgYnVnIHRoYXQgcmVwb3J0cyBvZmZzZXRXaWR0aCBhcyA+IDAgKGNvcmUgY2hlY2sgZm9yIHZpc2liaWxpdHkpCgkJCQkvLyBkZXNwaXRlIHZpc2liaWxpdHk6IGhpZGRlbiBhZGRyZXNzZXMgaXNzdWUgIzI5NjUKCQkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMjk2NQoJCQkJaWYoICFhbHJlYWR5Rm9jdXNlZCApewoJCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggdG9QYWdlICk7CgkJCQl9CgoJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhbGwgZG9uZSBjaGFuZ2luZyB0aGUgY3VycmVudCBwYWdlLgoJCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCi8qIEV2ZW50IEJpbmRpbmdzIC0gaGFzaGNoYW5nZSwgc3VibWl0LCBhbmQgY2xpY2sgKi8KCWZ1bmN0aW9uIGZpbmRDbG9zZXN0TGluayggZWxlICkKCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImEiICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJfQoJCXJldHVybiBlbGU7Cgl9CgoJLy8gVGhlIGJhc2UgVVJMIGZvciBhbnkgZ2l2ZW4gZWxlbWVudCBkZXBlbmRzIG9uIHRoZSBwYWdlIGl0IHJlc2lkZXMgaW4uCglmdW5jdGlvbiBnZXRDbG9zZXN0QmFzZVVybCggZWxlICkKCXsKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhZ2UgYW5kIGV4dHJhY3Qgb3V0IGl0cyB1cmwuCgkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQliYXNlID0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCWlmICggIXVybCB8fCAhcGF0aC5pc1BhdGgoIHVybCApICkgewoJCQl1cmwgPSBiYXNlOwoJCX0KCgkJcmV0dXJuIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UpOwoJfQoKCS8vVGhlIGZvbGxvd2luZyBldmVudCBiaW5kaW5ncyBzaG91bGQgYmUgYm91bmQgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgYmVlbiB0cmlnZ2VyZWQKCS8vdGhlIGZvbGxvd2luZyBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoJJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMgPSBmdW5jdGlvbigpIHsKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggImZvcm0iLCAic3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiggISQubW9iaWxlLmFqYXhFbmFibGVkIHx8CgkJCQkJLy8gdGVzdCB0aGF0IHRoZSBmb3JtIGlzLCBpdHNlbGYsIGFqYXggZmFsc2UKCQkJCQkkdGhpcy5pcygiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIpIHx8CgkJCQkJLy8gdGVzdCB0aGF0ICQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCBhbmQKCQkJCQkvLyB0aGUgZm9ybSBvciBvbmUgb2YgaXQncyBwYXJlbnRzIGlzIGFqYXg9ZmFsc2UKCQkJCQkhJHRoaXMuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIHR5cGUgPSAkdGhpcy5hdHRyKCAibWV0aG9kIiApLAoJCQkJdGFyZ2V0ID0gJHRoaXMuYXR0ciggInRhcmdldCIgKSwKCQkJCXVybCA9ICR0aGlzLmF0dHIoICJhY3Rpb24iICk7CgoJCQkvLyBJZiBubyBhY3Rpb24gaXMgc3BlY2lmaWVkLCBicm93c2VycyBkZWZhdWx0IHRvIHVzaW5nIHRoZQoJCQkvLyBVUkwgb2YgdGhlIGRvY3VtZW50IGNvbnRhaW5pbmcgdGhlIGZvcm0uIFNpbmNlIHdlIGR5bmFtaWNhbGx5CgkJCS8vIHB1bGwgaW4gcGFnZXMgZnJvbSBleHRlcm5hbCBkb2N1bWVudHMsIHRoZSBmb3JtIHNob3VsZCBzdWJtaXQKCQkJLy8gdG8gdGhlIFVSTCBmb3IgdGhlIHNvdXJjZSBkb2N1bWVudCBvZiB0aGUgcGFnZSBjb250YWluaW5nCgkJCS8vIHRoZSBmb3JtLgoJCQlpZiAoICF1cmwgKSB7CgkJCQkvLyBHZXQgdGhlIEBkYXRhLXVybCBmb3IgdGhlIHBhZ2UgY29udGFpbmluZyB0aGUgZm9ybS4KCQkJCXVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkdGhpcyApOwoJCQkJaWYgKCB1cmwgPT09IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgewoJCQkJCS8vIFRoZSB1cmwgd2UgZ290IGJhY2sgbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYmFzZSwKCQkJCQkvLyB3aGljaCBtZWFucyB0aGUgcGFnZSBtdXN0IGJlIGFuIGludGVybmFsL2VtYmVkZGVkIHBhZ2UsCgkJCQkJLy8gc28gZGVmYXVsdCB0byB1c2luZyB0aGUgYWN0dWFsIGRvY3VtZW50IHVybCBhcyBhIGJyb3dzZXIKCQkJCQkvLyB3b3VsZC4KCQkJCQl1cmwgPSBkb2N1bWVudFVybC5ocmVmTm9TZWFyY2g7CgkJCQl9CgkJCX0KCgkJCXVybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCAgdXJsLCBnZXRDbG9zZXN0QmFzZVVybCgkdGhpcykgKTsKCgkJCWlmKCggcGF0aC5pc0V4dGVybmFsKCB1cmwgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdChkb2N1bWVudFVybCwgdXJsKSkgfHwgdGFyZ2V0ICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKAoJCQkJdXJsLAoJCQkJewoJCQkJCXR5cGU6CQl0eXBlICYmIHR5cGUubGVuZ3RoICYmIHR5cGUudG9Mb3dlckNhc2UoKSB8fCAiZ2V0IiwKCQkJCQlkYXRhOgkJJHRoaXMuc2VyaWFsaXplKCksCgkJCQkJdHJhbnNpdGlvbjoJJHRoaXMuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQkJZGlyZWN0aW9uOgkkdGhpcy5qcW1EYXRhKCAiZGlyZWN0aW9uIiApLAoJCQkJCXJlbG9hZFBhZ2U6CXRydWUKCQkJCX0KCQkJKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQoIGRvY3VtZW50ICkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApOwoKCQkJLy8gc3BsaXQgZnJvbSB0aGUgcHJldmlvdXMgcmV0dXJuIGxvZ2ljIHRvIGF2b2lkIGZpbmQgY2xvc2VzdCB3aGVyZSBwb3NzaWJsZQoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggISQobGluaykuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBsaW5rICkgewoJCQkJaWYgKCBwYXRoLnBhcnNlVXJsKCBsaW5rLmdldEF0dHJpYnV0ZSggImhyZWYiICkgfHwgIiMiICkuaGFzaCAhPT0gIiMiICkgewoJCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoJCQkJCSRhY3RpdmVDbGlja2VkTGluayA9ICQoIGxpbmsgKS5jbG9zZXN0KCAiLnVpLWJ0biIgKS5ub3QoICIudWktZGlzYWJsZWQiICk7CgkJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfQoJCQl9CgkJfSk7CgoJCS8vIGNsaWNrIHJvdXRpbmcgLSBkaXJlY3QgdG8gSFRUUCBvciBBamF4LCBhY2NvcmRpbmdseQoJCSQoIGRvY3VtZW50ICkuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiggISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbGluayA9IGZpbmRDbG9zZXN0TGluayggZXZlbnQudGFyZ2V0ICksICRsaW5rID0gJCggbGluayApLCBodHRwQ2xlYW51cDsKCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpewoJCQkJd2luZG93LnNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgeyByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsgfSwgMjAwICk7CgkJCX07CgoJCQkvL2lmIHRoZXJlJ3MgYSBkYXRhLXJlbD1iYWNrIGF0dHIsIGdvIGJhY2sgaW4gaGlzdG9yeQoJCQlpZiAoICRsaW5rLmlzKCAiOmpxbURhdGEocmVsPSdiYWNrJykiICkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBiYXNlVXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICRsaW5rICksCgoJCQkJLy9nZXQgaHJlZiwgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gZW1wdHkgaGFzaAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAkbGluay5hdHRyKCAiaHJlZiIgKSB8fCAiIyIsIGJhc2VVcmwgKTsKCgkJCS8vaWYgYWpheCBpcyBkaXNhYmxlZCwgZXhpdCBlYXJseQoJCQlpZiggISQubW9iaWxlLmFqYXhFbmFibGVkICYmICFwYXRoLmlzRW1iZWRkZWRQYWdlKCBocmVmICkgKXsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFhYWF9qYmxhczogSWRlYWxseSBsaW5rcyB0byBhcHBsaWNhdGlvbiBwYWdlcyBzaG91bGQgYmUgc3BlY2lmaWVkIGFzCgkJCS8vICAgICAgICAgICAgYW4gdXJsIHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB3aXRoIGEgaGFzaCB0aGF0IGlzIGVpdGhlcgoJCQkvLyAgICAgICAgICAgIHRoZSBzaXRlIHJlbGF0aXZlIHBhdGggb3IgaWQgdG8gdGhlIHBhZ2UuIEJ1dCBzb21lIG9mIHRoZQoJCQkvLyAgICAgICAgICAgIGludGVybmFsIGNvZGUgdGhhdCBkeW5hbWljYWxseSBnZW5lcmF0ZXMgc3ViLXBhZ2VzIGZvciBuZXN0ZWQKCQkJLy8gICAgICAgICAgICBsaXN0cyBhbmQgc2VsZWN0IGRpYWxvZ3MsIGp1c3Qgd3JpdGUgYSBoYXNoIGluIHRoZSBsaW5rIHRoZXkKCQkJLy8gICAgICAgICAgICBjcmVhdGUuIFRoaXMgbWVhbnMgdGhlIGFjdHVhbCBVUkwgcGF0aCBpcyBiYXNlZCBvbiB3aGF0ZXZlcgoJCQkvLyAgICAgICAgICAgIHRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBiYXNlIHRhZyBpcyBhdCB0aGUgdGltZSB0aGlzIGNvZGUKCQkJLy8gICAgICAgICAgICBpcyBjYWxsZWQuIEZvciBub3cgd2UgYXJlIGp1c3QgYXNzdW1pbmcgdGhhdCBhbnkgdXJsIHdpdGggYQoJCQkvLyAgICAgICAgICAgIGhhc2ggaW4gaXQgaXMgYW4gYXBwbGljYXRpb24gcGFnZSByZWZlcmVuY2UuCgkJCWlmICggaHJlZi5zZWFyY2goICIjIiApICE9IC0xICkgewoJCQkJaHJlZiA9IGhyZWYucmVwbGFjZSggL1teI10qIy8sICIiICk7CgkJCQlpZiAoICFocmVmICkgewoJCQkJCS8vbGluayB3YXMgYW4gZW1wdHkgaGFzaCBtZWFudCBwdXJlbHkKCQkJCQkvL2ZvciBpbnRlcmFjdGlvbiwgc28gd2UgaWdub3JlIGl0LgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgoIGhyZWYgKSApIHsKCQkJCQkvL3dlIGhhdmUgYXBhdGggc28gbWFrZSBpdCB0aGUgaHJlZiB3ZSB3YW50IHRvIGxvYWQuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBiYXNlVXJsICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vd2UgaGF2ZSBhIHNpbXBsZSBpZCBzbyB1c2UgdGhlIGRvY3VtZW50VXJsIGFzIGl0cyBiYXNlLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgaHJlZiwgZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCApOwoJCQkJfQoJCQl9CgoJCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXZhciB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgPSAkbGluay5pcyggIltyZWw9J2V4dGVybmFsJ10iICkgfHwgJGxpbmsuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8ICRsaW5rLmlzKCAiW3RhcmdldF0iICksCgoJCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCgkJCQkvL2NoZWNrIGZvciBwcm90b2NvbCBvciByZWwgYW5kIGl0cyBub3QgYW4gZW1iZWRkZWQgcGFnZQoJCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCQkvLyAgICAgbW92ZWQgaW50byBtb3JlIGNvbXByZWhlbnNpdmUgaXNFeHRlcm5hbExpbmsKCQkJCWlzRXh0ZXJuYWwgPSB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgfHwgKCBwYXRoLmlzRXh0ZXJuYWwoIGhyZWYgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdChkb2N1bWVudFVybCwgaHJlZikgKTsKCgkJCWlmKCBpc0V4dGVybmFsICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy91c2UgYWpheAoJCQl2YXIgdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJZGlyZWN0aW9uID0gJGxpbmsuanFtRGF0YSggImRpcmVjdGlvbiIgKSwKCQkJCXJldmVyc2UgPSAoIGRpcmVjdGlvbiAmJiBkaXJlY3Rpb24gPT09ICJyZXZlcnNlIiApIHx8CgkJCQkJCQkvLyBkZXByZWNhdGVkIC0gcmVtb3ZlIGJ5IDEuMAoJCQkJCQkJJGxpbmsuanFtRGF0YSggImJhY2siICksCgoJCQkJLy90aGlzIG1heSBuZWVkIHRvIGJlIG1vcmUgc3BlY2lmaWMgYXMgd2UgdXNlIGRhdGEtcmVsIG1vcmUKCQkJCXJvbGUgPSAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApIHx8IHVuZGVmaW5lZDsKCgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGhyZWYsIHsgdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwgcmV2ZXJzZTogcmV2ZXJzZSwgcm9sZTogcm9sZSB9ICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vcHJlZmV0Y2ggcGFnZXMgd2hlbiBhbmNob3JzIHdpdGggZGF0YS1wcmVmZXRjaCBhcmUgZW5jb3VudGVyZWQKCQkkKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiLnVpLXBhZ2UiLCAicGFnZXNob3cucHJlZmV0Y2giLCBmdW5jdGlvbigpIHsKCQkJdmFyIHVybHMgPSBbXTsKCQkJJCggdGhpcyApLmZpbmQoICJhOmpxbURhdGEocHJlZmV0Y2gpIiApLmVhY2goZnVuY3Rpb24oKXsKCQkJCXZhciAkbGluayA9ICQodGhpcyksCgkJCQkJdXJsID0gJGxpbmsuYXR0ciggImhyZWYiICk7CgoJCQkJaWYgKCB1cmwgJiYgJC5pbkFycmF5KCB1cmwsIHVybHMgKSA9PT0gLTEgKSB7CgkJCQkJdXJscy5wdXNoKCB1cmwgKTsKCgkJCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHVybCwgeyByb2xlOiAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApLHByZWZldGNoOiB0cnVlIH0gKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgoJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlID0gZnVuY3Rpb24oIGhhc2ggKSB7CgkJCS8vZmluZCBmaXJzdCBwYWdlIHZpYSBoYXNoCgkJCXZhciB0byA9IHBhdGguc3RyaXBIYXNoKCBoYXNoICksCgkJCQkvL3RyYW5zaXRpb24gaXMgZmFsc2UgaWYgaXQncyB0aGUgZmlyc3QgcGFnZSwgdW5kZWZpbmVkIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudXJsSGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOiB1bmRlZmluZWQsCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nIHRoZSBjdXJyZW50IHN0YXRlCgkJCQkvLyBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gKCQkJCWNoYW5nZVBhZ2VPcHRpb25zID0gewoJCQkJCXRyYW5zaXRpb246IHRyYW5zaXRpb24sCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX07CgoJCQlpZiAoIDAgPT09IHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoICkgewoJCQkJdXJsSGlzdG9yeS5pbml0aWFsRHN0ID0gdG87CgkJCX0KCgkJCS8vaWYgbGlzdGVuaW5nIGlzIGRpc2FibGVkIChlaXRoZXIgZ2xvYmFsbHkgb3IgdGVtcG9yYXJpbHkpLCBvciBpdCdzIGEgZGlhbG9nIGhhc2gKCQkJaWYoICEkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCB8fCB1cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlICkgewoJCQkJdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSA9IGZhbHNlOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBzcGVjaWFsIGNhc2UgZm9yIGRpYWxvZ3MKCQkJaWYoIHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoID4gMSAmJiB0by5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSAmJiB1cmxIaXN0b3J5LmluaXRpYWxEc3QgIT09IHRvICkgewoKCQkJCS8vIElmIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgbm90IGEgZGlhbG9nIHNraXAgdGhlIGRpYWxvZyBhbmQgY29udGludWUKCQkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQkJaWYoISQubW9iaWxlLmFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApKSB7CgkJCQkJLy9kZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZSBhY2NvcmRpbmdseSBwYXN0CgkJCQkJLy90aGUgY3VycmVudCBkaWFsb2cKCQkJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJCQljdXJyZW50VXJsOiB0bywKCQkJCQkJaXNCYWNrOiBmdW5jdGlvbigpIHsgJC5tb2JpbGUuYmFjaygpOyB9LAoJCQkJCQlpc0ZvcndhcmQ6IGZ1bmN0aW9uKCkgeyB3aW5kb3cuaGlzdG9yeS5mb3J3YXJkKCk7IH0KCQkJCQl9KTsKCgkJCQkJLy8gcHJldmVudCBjaGFuZ2VQYWdlKCkKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgewoJCQkJCS8vIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIGEgZGlhbG9nIGFuZCB3ZSdyZSBuYXZpZ2F0aW5nCgkJCQkJLy8gdG8gYSBkaWFsb2cgdXNlIHRoZSBkaWFsb2cgb2JqZWN0ZWQgc2F2ZWQgaW4gdGhlIHN0YWNrCgkJCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCQkJY3VycmVudFVybDogdG8sCgoJCQkJCQkvLyByZWdhcmRsZXNzIG9mIHRoZSBkaXJlY3Rpb24gb2YgdGhlIGhpc3RvcnkgY2hhbmdlCgkJCQkJCS8vIGRvIHRoZSBmb2xsb3dpbmcKCQkJCQkJZWl0aGVyOiBmdW5jdGlvbiggaXNCYWNrICkgewoJCQkJCQkJdmFyIGFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCk7CgoJCQkJCQkJdG8gPSBhY3RpdmUucGFnZVVybDsKCgkJCQkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSByb2xlLCB0cmFuc2l0aW9uIGFuZCByZXZlcnNhbAoJCQkJCQkJLy8gYXMgbW9zdCBvZiB0aGlzIGlzIGxvc3QgYnkgdGhlIGRvbUNhY2hlIGNsZWFuaW5nCgkJCQkJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIHsKCQkJCQkJCQlyb2xlOiBhY3RpdmUucm9sZSwKCQkJCQkJCQl0cmFuc2l0aW9uOgkgYWN0aXZlLnRyYW5zaXRpb24sCgkJCQkJCQkJcmV2ZXJzZTogaXNCYWNrCgkJCQkJCQl9KTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJfQoJCQl9CgoJCQkvL2lmIHRvIGlzIGRlZmluZWQsIGxvYWQgaXQKCQkJaWYgKCB0byApIHsKCQkJCS8vIEF0IHRoaXMgcG9pbnQsICd0bycgY2FuIGJlIG9uZSBvZiAzIHRoaW5ncywgYSBjYWNoZWQgcGFnZSBlbGVtZW50IGZyb20KCQkJCS8vIGEgaGlzdG9yeSBzdGFjayBlbnRyeSwgYW4gaWQsIG9yIHNpdGUtcmVsYXRpdmUvYWJzb2x1dGUgVVJMLiBJZiAndG8nIGlzCgkJCQkvLyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QgdGhlIGRvY3VtZW50QmFzZSwgbm90IHRoZSBsb2NhdGlvbi5ocmVmLAoJCQkJLy8gc2luY2UgdGhlIGhhc2hjaGFuZ2UgY291bGQndmUgYmVlbiB0aGUgcmVzdWx0IG9mIGEgZm9yd2FyZC9iYWNrd2FyZCBuYXZpZ2F0aW9uCgkJCQkvLyB0aGF0IGNyb3NzZXMgZnJvbSBhbiBleHRlcm5hbCBwYWdlL2RpYWxvZyB0byBhbiBpbnRlcm5hbCBwYWdlL2RpYWxvZy4KCQkJCXRvID0gKCB0eXBlb2YgdG8gPT09ICJzdHJpbmciICYmICFwYXRoLmlzUGF0aCggdG8gKSApID8gKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJyMnICsgdG8sIGRvY3VtZW50QmFzZSApICkgOiB0bzsKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIHRvLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCQl9CWVsc2UgewoJCQkJLy90aGVyZSdzIG5vIGhhc2gsIGdvIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBkb20KCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQoJCX07CgoJCS8vaGFzaGNoYW5nZSBldmVudCBoYW5kbGVyCgkJJHdpbmRvdy5iaW5kKCAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCBlLCB0cmlnZ2VyZWQgKSB7CgkJCS8vIEZpcmVmb3ggYXV0by1lc2NhcGVzIHRoZSBsb2NhdGlvbi5oYXNoIGFzIGZvciB2MTMgYnV0CgkJCS8vIGxlYXZlcyB0aGUgaHJlZiB1bnRvdWNoZWQKCQkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UoIHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2ggKTsKCQl9KTsKCgkJLy9zZXQgcGFnZSBtaW4taGVpZ2h0cyB0byBiZSBkZXZpY2Ugc3BlY2lmaWMKCQkkKCBkb2N1bWVudCApLmJpbmQoICJwYWdlc2hvdyIsIHJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoJCSQoIHdpbmRvdyApLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCByZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9Oy8vbmF2cmVhZHlEZWZlcnJlZCBkb25lIGNhbGxiYWNrCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkLmRvbmUoIGZ1bmN0aW9uKCkgeyAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cygpOyB9ICk7Cgp9KSggalF1ZXJ5ICk7CgooIGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyBGb3Igbm93LCBsZXQncyBNb25rZXlwYXRjaCB0aGlzIG9udG8gdGhlIGVuZCBvZiAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cwoJLy8gU2NvcGUgc2VsZiB0byBwdXNoU3RhdGVIYW5kbGVyIHNvIHdlIGNhbiByZWZlcmVuY2UgaXQgc2FuZWx5IHdpdGhpbiB0aGUKCS8vIG1ldGhvZHMgaGFuZGVkIG9mZiBhcyBldmVudCBoYW5kbGVycwoJdmFyCXB1c2hTdGF0ZUhhbmRsZXIgPSB7fSwKCQlzZWxmID0gcHVzaFN0YXRlSGFuZGxlciwKCQkkd2luID0gJCggd2luZG93ICksCgkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCksCgkJbW9iaWxlaW5pdERlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoJCWRvbXJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJJCggZG9jdW1lbnQgKS5yZWFkeSggJC5wcm94eSggZG9tcmVhZHlEZWZlcnJlZCwgInJlc29sdmUiICkgKTsKCgkkKCBkb2N1bWVudCApLm9uZSggIm1vYmlsZWluaXQiLCAkLnByb3h5KCBtb2JpbGVpbml0RGVmZXJyZWQsICJyZXNvbHZlIiApICk7CgoJJC5leHRlbmQoIHB1c2hTdGF0ZUhhbmRsZXIsIHsKCQkvLyBUT0RPIG1vdmUgdG8gYSBwYXRoIGhlbHBlciwgdGhpcyBpcyByYXRoZXIgY29tbW9uIGZ1bmN0aW9uYWxpdHkKCQlpbml0aWFsRmlsZVBhdGg6IChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHVybC5wYXRobmFtZSArIHVybC5zZWFyY2g7CgkJfSkoKSwKCgkJaGFzaENoYW5nZVRpbWVvdXQ6IDIwMCwKCgkJaGFzaENoYW5nZUVuYWJsZVRpbWVyOiB1bmRlZmluZWQsCgoJCWluaXRpYWxIcmVmOiB1cmwuaHJlZk5vSGFzaCwKCgkJc3RhdGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gewoJCQkJLy8gZmlyZWZveCBhdXRvIGRlY29kZXMgdGhlIHVybCB3aGVuIHVzaW5nIGxvY2F0aW9uLmhhc2ggYnV0IG5vdCBocmVmCgkJCQloYXNoOiAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoIHx8ICIjIiArIHNlbGYuaW5pdGlhbEZpbGVQYXRoLAoJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlLAoKCQkJCS8vIHBlcnNpc3QgYWNyb3NzIHJlZnJlc2gKCQkJCWluaXRpYWxIcmVmOiBzZWxmLmluaXRpYWxIcmVmCgkJCX07CgkJfSwKCgkJcmVzZXRVSUtleXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBkaWFsb2cgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5LAoJCQkJc3Via2V5ID0gIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSwKCQkJCWRpYWxvZ0luZGV4ID0gdXJsLmluZGV4T2YoIGRpYWxvZyApOwoKCQkJaWYoIGRpYWxvZ0luZGV4ID4gLTEgKSB7CgkJCQl1cmwgPSB1cmwuc2xpY2UoIDAsIGRpYWxvZ0luZGV4ICkgKyAiIyIgKyB1cmwuc2xpY2UoIGRpYWxvZ0luZGV4ICk7CgkJCX0gZWxzZSBpZiggdXJsLmluZGV4T2YoIHN1YmtleSApID4gLTEgKSB7CgkJCQl1cmwgPSB1cmwuc3BsaXQoIHN1YmtleSApLmpvaW4oICIjIiArIHN1YmtleSApOwoJCQl9CgoJCQlyZXR1cm4gdXJsOwoJCX0sCgoJCS8vIFRPRE8gc29ydCBvdXQgYSBzaW5nbGUgYmFycmllciB0byBoYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkKCQluZXh0SGFzaENoYW5nZVByZXZlbnRlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQkkLm1vYmlsZS51cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlID0gdmFsdWU7CgkJCXNlbGYub25IYXNoQ2hhbmdlRGlzYWJsZWQgPSB2YWx1ZTsKCQl9LAoKCQkvLyBvbiBoYXNoIGNoYW5nZSB3ZSB3YW50IHRvIGNsZWFuIHVwIHRoZSB1cmwKCQkvLyBOT1RFIHRoaXMgdGFrZXMgcGxhY2UgKmFmdGVyKiB0aGUgdmFuaWxsYSBuYXZpZ2F0aW9uIGhhc2ggY2hhbmdlCgkJLy8gaGFuZGxpbmcgaGFzIHRha2VuIHBsYWNlIGFuZCBzZXQgdGhlIHN0YXRlIG9mIHRoZSBET00KCQlvbkhhc2hDaGFuZ2U6IGZ1bmN0aW9uKCBlICkgewoJCQkvLyBkaXNhYmxlIHRoaXMgaGFzaCBjaGFuZ2UKCQkJaWYoIHNlbGYub25IYXNoQ2hhbmdlRGlzYWJsZWQgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGhyZWYsIHN0YXRlLAoJCQkJLy8gZmlyZWZveCBhdXRvIGRlY29kZXMgdGhlIHVybCB3aGVuIHVzaW5nIGxvY2F0aW9uLmhhc2ggYnV0IG5vdCBocmVmCgkJCQloYXNoID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCwKCQkJCWlzUGF0aCA9ICQubW9iaWxlLnBhdGguaXNQYXRoKCBoYXNoICksCgkJCQlyZXNvbHV0aW9uVXJsID0gaXNQYXRoID8gJC5tb2JpbGUucGF0aC5nZXRMb2NhdGlvbigpIDogJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwoKTsKCgkJCWhhc2ggPSBpc1BhdGggPyBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6IGhhc2g7CgoKCQkJLy8gcHJvcHVsYXRlIHRoZSBoYXNoIHdoZW4gaXRzIG5vdCBhdmFpbGFibGUKCQkJc3RhdGUgPSBzZWxmLnN0YXRlKCk7CgoJCQkvLyBtYWtlIHRoZSBoYXNoIGFib2x1dGUgd2l0aCB0aGUgY3VycmVudCBocmVmCgkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaGFzaCwgcmVzb2x1dGlvblVybCApOwoKCQkJaWYgKCBpc1BhdGggKSB7CgkJCQlocmVmID0gc2VsZi5yZXNldFVJS2V5cyggaHJlZiApOwoJCQl9CgoJCQkvLyByZXBsYWNlIHRoZSBjdXJyZW50IHVybCB3aXRoIHRoZSBuZXcgaHJlZiBhbmQgc3RvcmUgdGhlIHN0YXRlCgkJCS8vIE5vdGUgdGhhdCBpbiBzb21lIGNhc2VzIHdlIG1pZ2h0IGJlIHJlcGxhY2luZyBhbiB1cmwgd2l0aCB0aGUKCQkJLy8gc2FtZSB1cmwuIFdlIGRvIHRoaXMgYW55d2F5cyBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQKCQkJLy8gYWxsIG9mIG91ciBoaXN0b3J5IGVudHJpZXMgaGF2ZSBhIHN0YXRlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGgKCQkJLy8gdGhlbS4gVGhpcyBhbGxvd3MgdXMgdG8gd29yayBhcm91bmQgdGhlIGNhc2Ugd2hlcmUgJC5tb2JpbGUuYmFjaygpCgkJCS8vIGlzIGNhbGxlZCB0byB0cmFuc2l0aW9uIGZyb20gYW4gZXh0ZXJuYWwgcGFnZSB0byBhbiBlbWJlZGRlZCBwYWdlLgoJCQkvLyBJbiB0aGF0IHBhcnRpY3VsYXIgY2FzZSwgYSBoYXNoY2hhbmdlIGV2ZW50IGlzICpOT1QqIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4KCQkJLy8gRW5zdXJpbmcgZWFjaCBoaXN0b3J5IGVudHJ5IGhhcyBhIHN0YXRlIG9iamVjdCBtZWFucyB0aGF0IG9uUG9wU3RhdGUoKQoJCQkvLyB3aWxsIGFsd2F5cyB0cmlnZ2VyIG91ciBoYXNoY2hhbmdlIGNhbGxiYWNrIGV2ZW4gd2hlbiBhIGhhc2hjaGFuZ2UgZXZlbnQKCQkJLy8gaXMgbm90IGZpcmVkLgoJCQloaXN0b3J5LnJlcGxhY2VTdGF0ZSggc3RhdGUsIGRvY3VtZW50LnRpdGxlLCBocmVmICk7CgkJfSwKCgkJLy8gb24gcG9wc3RhdGUgKGllIGJhY2sgb3IgZm9yd2FyZCkgd2UgbmVlZCB0byByZXBsYWNlIHRoZSBoYXNoIHRoYXQgd2FzIHRoZXJlIHByZXZpb3VzbHkKCQkvLyBjbGVhbmVkIHVwIGJ5IHRoZSBhZGRpdGlvbmFsIGhhc2ggaGFuZGxpbmcKCQlvblBvcFN0YXRlOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHBvcHBlZFN0YXRlID0gZS5vcmlnaW5hbEV2ZW50LnN0YXRlLAoJCQkJZnJvbUhhc2gsIHRvSGFzaCwgaGFzaENoYW5nZWQ7CgoJCQkvLyBpZiB0aGVyZSdzIG5vIHN0YXRlIGl0cyBub3QgYSBwb3BzdGF0ZSB3ZSBjYXJlIGFib3V0LCBlZyBjaHJvbWUncyBpbml0aWFsIHBvcHN0YXRlCgkJCWlmKCBwb3BwZWRTdGF0ZSApIHsKCQkJCS8vIGlmIHdlIGdldCB0d28gcG9wIHN0YXRlcyBpbiB1bmRlciB0aGlzLmhhc2hDaGFuZ2VUaW1lb3V0CgkJCQkvLyBtYWtlIHN1cmUgdG8gY2xlYXIgYW55IHRpbWVyIHNldCBmb3IgdGhlIHByZXZpb3VzIGNoYW5nZQoJCQkJY2xlYXJUaW1lb3V0KCBzZWxmLmhhc2hDaGFuZ2VFbmFibGVUaW1lciApOwoKCQkJCS8vIG1ha2Ugc3VyZSB0byBlbmFibGUgaGFzaCBoYW5kbGluZyBmb3IgdGhlIHRoZSBfaGFuZGxlSGFzaENoYW5nZSBjYWxsCgkJCQlzZWxmLm5leHRIYXNoQ2hhbmdlUHJldmVudGVkKCBmYWxzZSApOwoKCQkJCS8vIGNoYW5nZSB0aGUgcGFnZSBiYXNlZCBvbiB0aGUgaGFzaCBpbiB0aGUgcG9wcGVkIHN0YXRlCgkJCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSggcG9wcGVkU3RhdGUuaGFzaCApOwoKCQkJCS8vIHByZXZlbnQgYW55IGhhc2hjaGFuZ2UgaW4gdGhlIG5leHQgc2VsZi5oYXNoQ2hhbmdlVGltZW91dAoJCQkJc2VsZi5uZXh0SGFzaENoYW5nZVByZXZlbnRlZCggdHJ1ZSApOwoKCQkJCS8vIHJlLWVuYWJsZSBoYXNoIGNoYW5nZSBoYW5kbGluZyBhZnRlciBzd2FsbG93aW5nIGEgcG9zc2libGUgaGFzaAoJCQkJLy8gY2hhbmdlIGV2ZW50IHRoYXQgY29tZXMgb24gYWxsIHBvcHN0YXRlcyBjb3VydGVzeSBvZiBicm93c2VycyBsaWtlIEFuZHJvaWQKCQkJCXNlbGYuaGFzaENoYW5nZUVuYWJsZVRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5uZXh0SGFzaENoYW5nZVByZXZlbnRlZCggZmFsc2UgKTsKCQkJCX0sIHNlbGYuaGFzaENoYW5nZVRpbWVvdXQpOwoJCQl9CgkJfSwKCgkJaW5pdDogZnVuY3Rpb24oKSB7CgkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UiLCBzZWxmLm9uSGFzaENoYW5nZSApOwoKCQkJLy8gSGFuZGxlIHBvcHN0YXRlIGV2ZW50cyB0aGUgb2NjdXIgdGhyb3VnaCBoaXN0b3J5IGNoYW5nZXMKCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUiLCBzZWxmLm9uUG9wU3RhdGUgKTsKCgkJCS8vIGlmIHRoZXJlJ3Mgbm8gaGFzaCwgd2UgbmVlZCB0byByZXBsYWNlc3RhdGUgZm9yIHJldHVybmluZyB0byBob21lCgkJCWlmICggbG9jYXRpb24uaGFzaCA9PT0gIiIgKSB7CgkJCQloaXN0b3J5LnJlcGxhY2VTdGF0ZSggc2VsZi5zdGF0ZSgpLCBkb2N1bWVudC50aXRsZSwgJC5tb2JpbGUucGF0aC5nZXRMb2NhdGlvbigpICk7CgkJCX0KCQl9Cgl9KTsKCgkvLyBXZSBuZWVkIHRvIGluaXQgd2hlbiAibW9iaWxlaW5pdCIsICJkb21yZWFkeSIsIGFuZCAibmF2cmVhZHkiIGhhdmUgYWxsIGhhcHBlbmVkCgkkLndoZW4oIGRvbXJlYWR5RGVmZXJyZWQsIG1vYmlsZWluaXREZWZlcnJlZCwgJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCWlmKCAkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkICYmICQuc3VwcG9ydC5wdXNoU3RhdGUgKXsKCQkJcHVzaFN0YXRlSGFuZGxlci5pbml0KCk7CgkJfQoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgcG9wIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5wb3AgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciBzbGlkZSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2xpZGUgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2ltdWx0YW5lb3VzOwoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9uJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZG93biBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVkb3duID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZXVwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZXVwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbGlwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbGlwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciB0dXJuIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy50dXJuID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07CgoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCgl2YXIgcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSgkKGUudGFyZ2V0KSksIG9wdGlvbnM7CgoJaWYoICFwYWdlICkgewoJCXJldHVybjsKCX0KCglvcHRpb25zID0gcGFnZS5vcHRpb25zOwoKCS8vIGRlZ3JhZGUgaW5wdXRzIHRvIGF2b2lkIHBvb3JseSBpbXBsZW1lbnRlZCBuYXRpdmUgZnVuY3Rpb25hbGl0eQoJJCggZS50YXJnZXQgKS5maW5kKCAiaW5wdXQiICkubm90KCBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpICkuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSB8fCAidGV4dCI7CgoJCWlmICggb3B0aW9ucy5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gKSB7CgkJCXZhciBodG1sID0gJCggIjxkaXY+IiApLmh0bWwoICR0aGlzLmNsb25lKCkgKS5odG1sKCksCgkJCQkvLyBJbiBJRSBicm93c2VycywgdGhlIHR5cGUgc29tZXRpbWVzIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNsb25lZCBtYXJrdXAsIHNvIHdlIHJlcGxhY2UgdGhlIGNsb3NpbmcgdGFnIGluc3RlYWQKCQkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMSwKCQkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi8sCgkJCQlyZXBzdHIgPSAiIHR5cGU9XCIiICsgb3B0VHlwZSArICJcIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPVwiIiArIHR5cGUgKyAiXCIiICsgKCBoYXNUeXBlID8gIiIgOiAiPiIgKTsKCgkJCSR0aGlzLnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQljbG9zZUJ0blRleHQgCTogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWUJOiAiYSIsCgkJaW5pdFNlbGVjdG9yCTogIjpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQloZWFkZXJDbG9zZUJ1dHRvbiA9ICQoICI8YSBocmVmPScjJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uPSdkZWxldGUnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3M9J25vdGV4dCc+IisgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCArICI8L2E+IiApLAoJCQlkaWFsb2dXcmFwID0gJCgiPGRpdi8+IiwgewoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktY29ybmVyLWFsbCB1aS1vdmVybGF5LXNoYWRvdyIKCQkJCX0pOwoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaWFsb2cgdWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZwoJCS8vIFNldCBhcmlhIHJvbGUKCQkkZWwKCQkJLndyYXBJbm5lciggZGlhbG9nV3JhcCApCgkJCS5jaGlsZHJlbigpCgkJCQkuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApCgkJCQkJLnByZXBlbmQoIGhlYWRlckNsb3NlQnV0dG9uICkKCQkJCS5lbmQoKQoJCQkJLmNoaWxkcmVuKCAnOmZpcnN0LWNoaWxkJykKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApCgkJCQkuZW5kKCkKCQkJCS5jaGlsZHJlbiggIjpsYXN0LWNoaWxkIiApCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKTsKCgkJLy8gdGhpcyBtdXN0IGJlIGFuIGFub255bW91cyBmdW5jdGlvbiBzbyB0aGF0IHNlbGVjdCBtZW51IGRpYWxvZ3MgY2FuIHJlcGxhY2UKCQkvLyB0aGUgY2xvc2UgbWV0aG9kLiBUaGlzIGlzIGEgY2hhbmdlIGZyb20gcHJldmlvdXNseSBqdXN0IGRlZmluaW5nIGRhdGEtcmVsPWJhY2sKCQkvLyBvbiB0aGUgYnV0dG9uIGFuZCBsZXR0aW5nIG5hdiBoYW5kbGUgaXQKCQkvLwoJCS8vIFVzZSBjbGljayByYXRoZXIgdGhhbiB2Y2xpY2sgaW4gb3JkZXIgdG8gcHJldmVudCB0aGUgcG9zc2liaWxpdHkgb2YgdW5pbnRlbnRpb25hbGx5CgkJLy8gcmVvcGVuaW5nIHRoZSBkaWFsb2cgaWYgdGhlIGRpYWxvZyBvcGVuaW5nIGl0ZW0gd2FzIGRpcmVjdGx5IHVuZGVyIHRoZSBjbG9zZSBidXR0b24uCgkJaGVhZGVyQ2xvc2VCdXR0b24uYmluZCggImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCXNlbGYuY2xvc2UoKTsKCQl9KTsKCgkJLyogYmluZCBldmVudHMKCQkJLSBjbGlja3MgYW5kIHN1Ym1pdHMgc2hvdWxkIHVzZSB0aGUgY2xvc2luZyB0cmFuc2l0aW9uIHRoYXQgdGhlIGRpYWxvZyBvcGVuZWQgd2l0aAoJCQkgIHVubGVzcyBhIGRhdGEtdHJhbnNpdGlvbiBpcyBzcGVjaWZpZWQgb24gdGhlIGxpbmsvZm9ybQoJCQktIGlmIHRoZSBjbGljayB3YXMgb24gdGhlIGNsb3NlIGJ1dHRvbiwgb3IgdGhlIGxpbmsgaGFzIGEgZGF0YS1yZWw9ImJhY2siIGl0J2xsIGdvIGJhY2sgaW4gaGlzdG9yeSBuYXR1cmFsbHkKCQkqLwoJCSRlbC5iaW5kKCAidmNsaWNrIHN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBldmVudC50eXBlID09PSAidmNsaWNrIiA/ICJhIiA6ICJmb3JtIiApLAoJCQkJYWN0aXZlOwoKCQkJaWYgKCAkdGFyZ2V0Lmxlbmd0aCAmJiAhJHRhcmdldC5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSApIHsKCgkJCQlhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpIHx8IHt9OwoKCQkJCSR0YXJnZXQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRyYW5zaXRpb24iLCAoIGFjdGl2ZS50cmFuc2l0aW9uIHx8ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uICkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGlyZWN0aW9uIiwgInJldmVyc2UiICk7CgkJCX0KCQl9KQoJCS5iaW5kKCAicGFnZWhpZGUiLCBmdW5jdGlvbiggZSwgdWkgKSB7CgkJCXNlbGYuX2lzQ2xvc2VkID0gZmFsc2U7CgkJCSQoIHRoaXMgKS5maW5kKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLm5vdCggIi51aS1zbGlkZXItYmciICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSkKCQkvLyBPdmVycmlkZSB0aGUgdGhlbWUgc2V0IGJ5IHRoZSBwYWdlIHBsdWdpbiBvbiBwYWdlc2hvdwoJCS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpewoJCQlpZiggc2VsZi5vcHRpb25zLm92ZXJsYXlUaGVtZSApewoJCQkJc2VsZi5lbGVtZW50CgkJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkJLnBhZ2UoICJzZXRDb250YWluZXJCYWNrZ3JvdW5kIiwgc2VsZi5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBkc3Q7CgoJCWlmICggIXRoaXMuX2lzQ2xvc2VkICkgewoJCQl0aGlzLl9pc0Nsb3NlZCA9IHRydWU7CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQlkc3QgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldFByZXYoKS51cmw7CgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggZHN0ICkgKSB7CgkJCQkJZHN0ID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGRzdCApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGRzdCwgeyBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJfQoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmRlbGVnYXRlKCAkLm1vYmlsZS5kaWFsb2cucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCl7CgkkLm1vYmlsZS5kaWFsb2cucHJvdG90eXBlLmVuaGFuY2UoIHRoaXMgKTsKfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYmFja0J0blRleHQgID0gIkJhY2siOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmFkZEJhY2tCdG4gICA9IGZhbHNlOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UaGVtZSA9IG51bGw7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuaGVhZGVyVGhlbWUgID0gImEiOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmZvb3RlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5jb250ZW50VGhlbWUgPSBudWxsOwoKLy8gTk9URSBiaW5kIHVzZWQgdG8gZm9yY2UgdGhpcyBiaW5kaW5nIHRvIHJ1biBiZWZvcmUgdGhlIGJ1dHRvbk1hcmt1cCBiaW5kaW5nCi8vICAgICAgd2hpY2ggZXhwZWN0cyAudWktZm9vdGVyIHRvcCBiZSBhcHBsaWVkIGluIGl0cyBnaWdhbnRpYyBzZWxlY3RvciAKLy8gVE9ETyByZW1vdmUgdGhlIGJ1dHRvbk1hcmt1cCBnaWFudCBzZWxlY3RvciBhbmQgbW92ZSBpdCB0byB0aGUgdmFyaW91cyBtb2R1bGVzCi8vICAgICAgb24gd2hpY2ggaXQgZGVwZW5kcwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7Cgl2YXIgJHBhZ2UgPSAkKCBlLnRhcmdldCApLAoJCW8gPSAkcGFnZS5kYXRhKCAicGFnZSIgKS5vcHRpb25zLAoJCXBhZ2VSb2xlID0gJHBhZ2UuanFtRGF0YSggInJvbGUiICksCgkJcGFnZVRoZW1lID0gby50aGVtZTsKCgkkKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJyksIDpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdjb250ZW50JykiLCAkcGFnZSApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlyb2xlID0gJHRoaXMuanFtRGF0YSggInJvbGUiICksCgkJCXRoZW1lID0gJHRoaXMuanFtRGF0YSggInRoZW1lIiApLAoJCQljb250ZW50VGhlbWUgPSB0aGVtZSB8fCBvLmNvbnRlbnRUaGVtZSB8fCAoIHBhZ2VSb2xlID09PSAiZGlhbG9nIiAmJiBwYWdlVGhlbWUgKSwKCQkJJGhlYWRlcmFuY2hvcnMsCgkJCWxlZnRidG4sCgkJCXJpZ2h0YnRuLAoJCQliYWNrQnRuOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CgoJCS8vYXBwbHkgdGhlbWluZyBhbmQgbWFya3VwIG1vZGlmaWNhdGlvbnMgdG8gcGFnZSxoZWFkZXIsY29udGVudCxmb290ZXIKCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiIHx8IHJvbGUgPT09ICJmb290ZXIiICkgewoKCQkJdmFyIHRoaXNUaGVtZSA9IHRoZW1lIHx8ICggcm9sZSA9PT0gImhlYWRlciIgPyBvLmhlYWRlclRoZW1lIDogby5mb290ZXJUaGVtZSApIHx8IHBhZ2VUaGVtZTsKCgkJCSR0aGlzCgkJCQkvL2FkZCB0aGVtZSBjbGFzcwoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyB0aGlzVGhlbWUgKQoJCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkJLmF0dHIoICJyb2xlIiwgcm9sZSA9PT0gImhlYWRlciIgPyAiYmFubmVyIiA6ICJjb250ZW50aW5mbyIgKTsKCgkJCWlmKCByb2xlID09PSAiaGVhZGVyIikgewoJCQkJLy8gUmlnaHQsbGVmdCBidXR0b25zCgkJCQkkaGVhZGVyYW5jaG9ycwk9ICR0aGlzLmNoaWxkcmVuKCAiYSwgYnV0dG9uIiApOwoJCQkJbGVmdGJ0bgk9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLWxlZnQiICk7CgkJCQlyaWdodGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLXJpZ2h0IiApOwoKCQkJCWxlZnRidG4gPSBsZWZ0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAwICkubm90KCAiLnVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCgkJCQlyaWdodGJ0biA9IHJpZ2h0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAxICkuYWRkQ2xhc3MoICJ1aS1idG4tcmlnaHQiICkubGVuZ3RoOwoJCQl9CgoJCQkvLyBBdXRvLWFkZCBiYWNrIGJ0biBvbiBwYWdlcyBiZXlvbmQgZmlyc3QgdmlldwoJCQlpZiAoIG8uYWRkQmFja0J0biAmJgoJCQkJcm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCSQoICIudWktcGFnZSIgKS5sZW5ndGggPiAxICYmCgkJCQkkcGFnZS5qcW1EYXRhKCAidXJsIiApICE9PSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggbG9jYXRpb24uaGFzaCApICYmCgkJCQkhbGVmdGJ0biApIHsKCgkJCQliYWNrQnRuID0gJCggIjxhIGhyZWY9J2phdmFzY3JpcHQ6dm9pZCgwKTsnIGNsYXNzPSd1aS1idG4tbGVmdCcgZGF0YS0iKyAkLm1vYmlsZS5ucyArInJlbD0nYmFjaycgZGF0YS0iKyAkLm1vYmlsZS5ucyArImljb249J2Fycm93LWwnPiIrIG8uYmFja0J0blRleHQgKyI8L2E+IiApCgkJCQkJLy8gSWYgdGhlbWUgaXMgcHJvdmlkZWQsIG92ZXJyaWRlIGRlZmF1bHQgaW5oZXJpdGFuY2UKCQkJCQkuYXR0ciggImRhdGEtIisgJC5tb2JpbGUubnMgKyJ0aGVtZSIsIG8uYmFja0J0blRoZW1lIHx8IHRoaXNUaGVtZSApCgkJCQkJLnByZXBlbmRUbyggJHRoaXMgKTsKCQkJfQoKCQkJLy8gUGFnZSB0aXRsZQoJCQkkdGhpcy5jaGlsZHJlbiggImgxLCBoMiwgaDMsIGg0LCBoNSwgaDYiICkKCQkJCS5hZGRDbGFzcyggInVpLXRpdGxlIiApCgkJCQkvLyBSZWdhcmRsZXNzIG9mIGggZWxlbWVudCBudW1iZXIgaW4gc3JjLCBpdCBiZWNvbWVzIGgxIGZvciB0aGUgZW5oYW5jZWQgcGFnZQoJCQkJLmF0dHIoewoJCQkJCSJyb2xlIjogImhlYWRpbmciLAoJCQkJCSJhcmlhLWxldmVsIjogIjEiCgkJCQl9KTsKCgkJfSBlbHNlIGlmICggcm9sZSA9PT0gImNvbnRlbnQiICkgewoJCQlpZiAoIGNvbnRlbnRUaGVtZSApIHsKCQkJICAgICR0aGlzLmFkZENsYXNzKCAidWktYm9keS0iICsgKCBjb250ZW50VGhlbWUgKSApOwoJCQl9CgoJCQkvLyBBZGQgQVJJQSByb2xlCgkJCSR0aGlzLmF0dHIoICJyb2xlIiwgIm1haW4iICk7CgkJfQoJfSk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBmaWx0ZXIgZnVuY3Rpb24gcmVtb3ZlcyB3aGl0ZXNwYWNlIGJldHdlZW4gbGFiZWwgYW5kIGZvcm0gZWxlbWVudCBzbyB3ZSBjYW4gdXNlIGlubGluZS1ibG9jayAobm9kZVR5cGUgMyA9IHRleHQpCiQuZm4uZmllbGRjb250YWluID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcwoJCS5hZGRDbGFzcyggInVpLWZpZWxkLWNvbnRhaW4gdWktYm9keSB1aS1iciIgKQoJCS5jb250ZW50cygpLmZpbHRlciggZnVuY3Rpb24oKSB7CgkJCXJldHVybiAoIHRoaXMubm9kZVR5cGUgPT09IDMgJiYgIS9cUy8udGVzdCggdGhpcy5ub2RlVmFsdWUgKSApOwoJCX0pLnJlbW92ZSgpOwp9OwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIsIGUudGFyZ2V0ICkuanFtRW5oYW5jZWFibGUoKS5maWVsZGNvbnRhaW4oKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uZ3JpZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJZ3JpZDogbnVsbAoJCQl9LG9wdGlvbnMpLAoJCQkka2lkcyA9ICR0aGlzLmNoaWxkcmVuKCksCgkJCWdyaWRDb2xzID0ge3NvbG86MSwgYToyLCBiOjMsIGM6NCwgZDo1fSwKCQkJZ3JpZCA9IG8uZ3JpZCwKCQkJaXRlcmF0b3I7CgoJCQlpZiAoICFncmlkICkgewoJCQkJaWYgKCAka2lkcy5sZW5ndGggPD0gNSApIHsKCQkJCQlmb3IgKCB2YXIgbGV0dGVyIGluIGdyaWRDb2xzICkgewoJCQkJCQlpZiAoIGdyaWRDb2xzWyBsZXR0ZXIgXSA9PT0gJGtpZHMubGVuZ3RoICkgewoJCQkJCQkJZ3JpZCA9IGxldHRlcjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJZ3JpZCA9ICJhIjsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtZHVvIiApOwoJCQkJfQoJCQl9CgkJCWl0ZXJhdG9yID0gZ3JpZENvbHNbZ3JpZF07CgoJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC0iICsgZ3JpZCApOwoKCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzEpIiApLmFkZENsYXNzKCAidWktYmxvY2stYSIgKTsKCgkJaWYgKCBpdGVyYXRvciA+IDEgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMikiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1iIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMiApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgzbiszKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWMiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAzICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKDRuKzQpIiApLmFkZENsYXNzKCAidWktYmxvY2stZCIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDQgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoNW4rNSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1lIiApOwoJCX0KCX0pOwp9Owp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCBlLnRhcmdldCApLmFkZENsYXNzKCAidWktbm9qcyIgKTsKCQp9KTsKCn0pKCBqUXVlcnkgKTsKCiggZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uYnV0dG9uTWFya3VwID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7Cgl2YXIgJHdvcmtpbmdTZXQgPSB0aGlzOwoKCS8vIEVuZm9yY2Ugb3B0aW9ucyB0byBiZSBvZiB0eXBlIHN0cmluZwoJb3B0aW9ucyA9ICggb3B0aW9ucyAmJiAoICQudHlwZSggb3B0aW9ucyApID09ICJvYmplY3QiICkgKT8gb3B0aW9ucyA6IHt9OwoJZm9yICggdmFyIGkgPSAwOyBpIDwgJHdvcmtpbmdTZXQubGVuZ3RoOyBpKysgKSB7CgkJdmFyIGVsID0gJHdvcmtpbmdTZXQuZXEoIGkgKSwKCQkJZSA9IGVsWyAwIF0sCgkJCW8gPSAkLmV4dGVuZCgge30sICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzLCB7CgkJCQlpY29uOiAgICAgICBvcHRpb25zLmljb24gICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbiAgICAgICA6IGVsLmpxbURhdGEoICJpY29uIiApLAoJCQkJaWNvbnBvczogICAgb3B0aW9ucy5pY29ucG9zICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25wb3MgICAgOiBlbC5qcW1EYXRhKCAiaWNvbnBvcyIgKSwKCQkJCXRoZW1lOiAgICAgIG9wdGlvbnMudGhlbWUgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy50aGVtZSAgICAgIDogZWwuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICksCgkJCQlpbmxpbmU6ICAgICBvcHRpb25zLmlubGluZSAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaW5saW5lICAgICA6IGVsLmpxbURhdGEoICJpbmxpbmUiICksCgkJCQlzaGFkb3c6ICAgICBvcHRpb25zLnNoYWRvdyAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc2hhZG93ICAgICA6IGVsLmpxbURhdGEoICJzaGFkb3ciICksCgkJCQljb3JuZXJzOiAgICBvcHRpb25zLmNvcm5lcnMgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY29ybmVycyAgICA6IGVsLmpxbURhdGEoICJjb3JuZXJzIiApLAoJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25zaGFkb3cgOiBlbC5qcW1EYXRhKCAiaWNvbnNoYWRvdyIgKSwKCQkJCW1pbmk6ICAgICAgIG9wdGlvbnMubWluaSAgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5taW5pICAgICAgIDogZWwuanFtRGF0YSggIm1pbmkiICkKCQkJfSwgb3B0aW9ucyApLAoKCQkJLy8gQ2xhc3NlcyBEZWZpbmVkCgkJCWlubmVyQ2xhc3MgPSAidWktYnRuLWlubmVyIiwKCQkJdGV4dENsYXNzID0gInVpLWJ0bi10ZXh0IiwKCQkJYnV0dG9uQ2xhc3MsIGljb25DbGFzcywKCQkJLy8gQnV0dG9uIGlubmVyIG1hcmt1cAoJCQlidXR0b25Jbm5lciwKCQkJYnV0dG9uVGV4dCwKCQkJYnV0dG9uSWNvbiwKCQkJYnV0dG9uRWxlbWVudHM7CgoJCSQuZWFjaChvLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CgkJCWUuc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBrZXksIHZhbHVlICk7CgkJCWVsLmpxbURhdGEoa2V5LCB2YWx1ZSk7CgkJfSk7CgoJCS8vIENoZWNrIGlmIHRoaXMgZWxlbWVudCBpcyBhbHJlYWR5IGVuaGFuY2VkCgkJYnV0dG9uRWxlbWVudHMgPSAkLmRhdGEoKChlLnRhZ05hbWUgPT09ICJJTlBVVCIgfHwgZS50YWdOYW1lID09PSAiQlVUVE9OIikgPyBlLnBhcmVudE5vZGUgOiBlKSwgImJ1dHRvbkVsZW1lbnRzIik7CgoJCWlmIChidXR0b25FbGVtZW50cykgewoJCQllID0gYnV0dG9uRWxlbWVudHMub3V0ZXI7CgkJCWVsID0gJChlKTsKCQkJYnV0dG9uSW5uZXIgPSBidXR0b25FbGVtZW50cy5pbm5lcjsKCQkJYnV0dG9uVGV4dCA9IGJ1dHRvbkVsZW1lbnRzLnRleHQ7CgkJCS8vIFdlIHdpbGwgcmVjcmVhdGUgdGhpcyBpY29uIGJlbG93CgkJCSQoYnV0dG9uRWxlbWVudHMuaWNvbikucmVtb3ZlKCk7CgkJCWJ1dHRvbkVsZW1lbnRzLmljb24gPSBudWxsOwoJCX0KCQllbHNlIHsKCQkJYnV0dG9uSW5uZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKTsKCQkJYnV0dG9uVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApOwoJCX0KCQlidXR0b25JY29uID0gby5pY29uID8gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgOiBudWxsOwoKCQlpZiAoIGF0dGFjaEV2ZW50cyAmJiAhYnV0dG9uRWxlbWVudHMpIHsKCQkJYXR0YWNoRXZlbnRzKCk7CgkJfQoJCQoJCS8vIGlmIG5vdCwgdHJ5IHRvIGZpbmQgY2xvc2VzdCB0aGVtZSBjb250YWluZXIJCgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICk7CQoJCX0JCQoKCQlidXR0b25DbGFzcyA9ICJ1aS1idG4gdWktYnRuLXVwLSIgKyBvLnRoZW1lOwoJCWJ1dHRvbkNsYXNzICs9IG8uc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiI7CgkJYnV0dG9uQ2xhc3MgKz0gby5jb3JuZXJzID8gIiB1aS1idG4tY29ybmVyLWFsbCIgOiAiIjsKCgkJaWYgKCBvLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYG1pbmlgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLm1pbmkgPT09IHRydWUgPyAiIHVpLW1pbmkiIDogIiB1aS1mdWxsc2l6ZSI7CgkJfQoJCQoJCWlmICggby5pbmxpbmUgIT09IHVuZGVmaW5lZCApIHsJCQkKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYGlubGluZWAgc3R5bGUuCgkJCWJ1dHRvbkNsYXNzICs9IG8uaW5saW5lID09PSB0cnVlID8gIiB1aS1idG4taW5saW5lIiA6ICIgdWktYnRuLWJsb2NrIjsKCQl9CgkJCgkJaWYgKCBvLmljb24gKSB7CgkJCW8uaWNvbiA9ICJ1aS1pY29uLSIgKyBvLmljb247CgkJCW8uaWNvbnBvcyA9IG8uaWNvbnBvcyB8fCAibGVmdCI7CgoJCQlpY29uQ2xhc3MgPSAidWktaWNvbiAiICsgby5pY29uOwoKCQkJaWYgKCBvLmljb25zaGFkb3cgKSB7CgkJCQlpY29uQ2xhc3MgKz0gIiB1aS1pY29uLXNoYWRvdyI7CgkJCX0KCQl9CgoJCWlmICggby5pY29ucG9zICkgewoJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi1pY29uLSIgKyBvLmljb25wb3M7CgoJCQlpZiAoIG8uaWNvbnBvcyA9PSAibm90ZXh0IiAmJiAhZWwuYXR0ciggInRpdGxlIiApICkgewoJCQkJZWwuYXR0ciggInRpdGxlIiwgZWwuZ2V0RW5jb2RlZFRleHQoKSApOwoJCQl9CgkJfQogICAgCgkJaW5uZXJDbGFzcyArPSBvLmNvcm5lcnMgPyAiIHVpLWJ0bi1jb3JuZXItYWxsIiA6ICIiOwoKCQlpZiAoIG8uaWNvbnBvcyAmJiBvLmljb25wb3MgPT09ICJub3RleHQiICYmICFlbC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCWVsLmF0dHIoICJ0aXRsZSIsIGVsLmdldEVuY29kZWRUZXh0KCkgKTsKCQl9CgoJCWlmICggYnV0dG9uRWxlbWVudHMgKSB7CgkJCWVsLnJlbW92ZUNsYXNzKCBidXR0b25FbGVtZW50cy5iY2xzIHx8ICIiICk7CgkJfQoJCWVsLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCgkJYnV0dG9uSW5uZXIuY2xhc3NOYW1lID0gaW5uZXJDbGFzczsKCgkJYnV0dG9uVGV4dC5jbGFzc05hbWUgPSB0ZXh0Q2xhc3M7CgkJaWYgKCAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25UZXh0ICk7CgkJfQoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJYnV0dG9uSWNvbi5jbGFzc05hbWUgPSBpY29uQ2xhc3M7CgkJCWlmICggISggYnV0dG9uRWxlbWVudHMgJiYgYnV0dG9uRWxlbWVudHMuaWNvbiApICkgewoJCQkJYnV0dG9uSWNvbi5pbm5lckhUTUwgPSAiJiMxNjA7IjsKCQkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25JY29uICk7CgkJCX0KCQl9CgoJCXdoaWxlICggZS5maXJzdENoaWxkICYmICFidXR0b25FbGVtZW50cykgewoJCQlidXR0b25UZXh0LmFwcGVuZENoaWxkKCBlLmZpcnN0Q2hpbGQgKTsKCQl9CgoJCWlmICggIWJ1dHRvbkVsZW1lbnRzICkgewoJCQllLmFwcGVuZENoaWxkKCBidXR0b25Jbm5lciApOwoJCX0KCgkJLy8gQXNzaWduIGEgc3RydWN0dXJlIGNvbnRhaW5pbmcgdGhlIGVsZW1lbnRzIG9mIHRoaXMgYnV0dG9uIHRvIHRoZSBlbGVtZW50cyBvZiB0aGlzIGJ1dHRvbi4gVGhpcwoJCS8vIHdpbGwgYWxsb3cgdXMgdG8gcmVjb2duaXplIHRoaXMgYXMgYW4gYWxyZWFkeS1lbmhhbmNlZCBidXR0b24gaW4gZnV0dXJlIGNhbGxzIHRvIGJ1dHRvbk1hcmt1cCgpLgoJCWJ1dHRvbkVsZW1lbnRzID0gewoJCQliY2xzICA6IGJ1dHRvbkNsYXNzLAoJCQlvdXRlciA6IGUsCgkJCWlubmVyIDogYnV0dG9uSW5uZXIsCgkJCXRleHQgIDogYnV0dG9uVGV4dCwKCQkJaWNvbiAgOiBidXR0b25JY29uCgkJfTsKCgkJJC5kYXRhKGUsICAgICAgICAgICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyk7CgkJJC5kYXRhKGJ1dHRvbklubmVyLCAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyk7CgkJJC5kYXRhKGJ1dHRvblRleHQsICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyk7CgkJaWYgKGJ1dHRvbkljb24pIHsKCQkJJC5kYXRhKGJ1dHRvbkljb24sICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzKTsKCQl9Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgokLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cyA9IHsKCWNvcm5lcnM6IHRydWUsCglzaGFkb3c6IHRydWUsCglpY29uc2hhZG93OiB0cnVlLAoJd3JhcHBlckVsczogInNwYW4iCn07CgpmdW5jdGlvbiBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZWxlbWVudCApIHsKICAgIHZhciBjbmFtZTsKCiAgICB3aGlsZSAoIGVsZW1lbnQgKSB7CgkJLy8gTm90ZSB0aGF0IHdlIGNoZWNrIGZvciB0eXBlb2YgY2xhc3NOYW1lIGJlbG93IGJlY2F1c2UgdGhlIGVsZW1lbnQgd2UKCQkvLyBoYW5kZWQgY291bGQgYmUgaW4gYW4gU1ZHIERPTSB3aGVyZSBjbGFzc05hbWUgb24gU1ZHIGVsZW1lbnRzIGlzIGRlZmluZWQgdG8KCQkvLyBiZSBvZiBhIGRpZmZlcmVudCB0eXBlIChTVkdBbmltYXRlZFN0cmluZykuIFdlIG9ubHkgb3BlcmF0ZSBvbiBIVE1MIERPTQoJCS8vIGVsZW1lbnRzLCBzbyB3ZSBsb29rIGZvciBwbGFpbiAic3RyaW5nIi4KICAgICAgICBjbmFtZSA9ICggdHlwZW9mIGVsZW1lbnQuY2xhc3NOYW1lID09PSAnc3RyaW5nJyApICYmIChlbGVtZW50LmNsYXNzTmFtZSArICcgJyk7CiAgICAgICAgaWYgKCBjbmFtZSAmJiBjbmFtZS5pbmRleE9mKCJ1aS1idG4gIikgPiAtMSAmJiBjbmFtZS5pbmRleE9mKCJ1aS1kaXNhYmxlZCAiKSA8IDAgKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgIH0KCiAgICByZXR1cm4gZWxlbWVudDsKfQoKdmFyIGF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJdmFyIGhvdmVyRGVsYXkgPSAkLm1vYmlsZS5idXR0b25NYXJrdXAuaG92ZXJEZWxheSwgaG92LCBmb2M7CgoJJCggZG9jdW1lbnQgKS5iaW5kKCB7CgkJInZtb3VzZWRvd24gdm1vdXNlY2FuY2VsIHZtb3VzZXVwIHZtb3VzZW92ZXIgdm1vdXNlb3V0IGZvY3VzIGJsdXIgc2Nyb2xsc3RhcnQiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciB0aGVtZSwKCQkJCSRidG4gPSAkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKSwKCQkJCWV2dCA9IGV2ZW50LnR5cGU7CgkJCgkJCWlmICggJGJ0bi5sZW5ndGggKSB7CgkJCQl0aGVtZSA9ICRidG4uYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiApOwoJCQoJCQkJaWYgKCBldnQgPT09ICJ2bW91c2Vkb3duIiApIHsKCQkJCQlpZiAoICQuc3VwcG9ydC50b3VjaCApIHsKCQkJCQkJaG92ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgdGhlbWUgKTsKCQkJCQkJfSwgaG92ZXJEZWxheSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgdGhlbWUgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VjYW5jZWwiIHx8IGV2dCA9PT0gInZtb3VzZXVwIiApIHsKCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICk7CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VvdmVyIiB8fCBldnQgPT09ICJmb2N1cyIgKSB7CgkJCQkJaWYgKCAkLnN1cHBvcnQudG91Y2ggKSB7CgkJCQkJCWZvYyA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSApOwoJCQkJCQl9LCBob3ZlckRlbGF5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VvdXQiIHx8IGV2dCA9PT0gImJsdXIiIHx8IGV2dCA9PT0gInNjcm9sbHN0YXJ0IiApIHsKCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSAgKyAiIHVpLWJ0bi1kb3duLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApOwoJCQkJCWlmICggaG92ICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhvdiApOwoJCQkJCX0KCQkJCQlpZiAoIGZvYyApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBmb2MgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoJCSJmb2N1c2luIGZvY3VzIjogZnVuY3Rpb24oIGV2ZW50ICl7CgkJCSQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJfSwKCQkiZm9jdXNvdXQgYmx1ciI6IGZ1bmN0aW9uKCBldmVudCApewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0KCX0pOwoKCWF0dGFjaEV2ZW50cyA9IG51bGw7Cn07CgovL2xpbmtzIGluIGJhcnMsIG9yIHRob3NlIHdpdGggIGRhdGEtcm9sZSBiZWNvbWUgYnV0dG9ucwovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoKCSQoICI6anFtRGF0YShyb2xlPSdidXR0b24nKSwgLnVpLWJhciA+IGEsIC51aS1oZWFkZXIgPiBhLCAudWktZm9vdGVyID4gYSwgLnVpLWJhciA+IDpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpID4gYSIsIGUudGFyZ2V0ICkKCQkuanFtRW5oYW5jZWFibGUoKQoJCS5ub3QoICJidXR0b24sIGlucHV0LCAudWktYnRuLCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5idXR0b25NYXJrdXAoKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWV4cGFuZEN1ZVRleHQ6ICIgY2xpY2sgdG8gZXhwYW5kIGNvbnRlbnRzIiwKCQljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJCWNvbGxhcHNlZDogdHJ1ZSwKCQloZWFkaW5nOiAiaDEsaDIsaDMsaDQsaDUsaDYsbGVnZW5kIiwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaWNvblRoZW1lOiAiZCIsCgkJbWluaTogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGUgPSAkZWwuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSIgKSwKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJGVsLmNoaWxkcmVuKCBvLmhlYWRpbmcgKS5maXJzdCgpLAoJCQljb2xsYXBzaWJsZUNvbnRlbnQgPSBjb2xsYXBzaWJsZS53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1jb250ZW50Jz48L2Rpdj4iICkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCQljb2xsYXBzaWJsZVNldCA9ICRlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICk7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIGNvbGxhcHNpYmxlSGVhZGluZy5pcyggImxlZ2VuZCIgKSApIHsKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJCggIjxkaXYgcm9sZT0naGVhZGluZyc+IisgY29sbGFwc2libGVIZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlSGVhZGluZyApOwoJCQljb2xsYXBzaWJsZUhlYWRpbmcubmV4dCgpLnJlbW92ZSgpOwoJCX0KCgkJLy8gSWYgd2UgYXJlIGluIGEgY29sbGFwc2libGUgc2V0CgkJaWYgKCBjb2xsYXBzaWJsZVNldC5sZW5ndGggKSB7CgkJCS8vIEluaGVyaXQgdGhlIHRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8udGhlbWUgKSB7CgkJCQlvLnRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSgidGhlbWUiKSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggY29sbGFwc2libGVTZXQsICJjIiApOwoJCQl9CgkJCS8vIEluaGVyaXQgdGhlIGNvbnRlbnQtdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby5jb250ZW50VGhlbWUgKSB7CgkJCQlvLmNvbnRlbnRUaGVtZSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJjb250ZW50LXRoZW1lIiApOwoJCQl9CgoJCQkvLyBHZXRzIHRoZSBwcmVmZXJlbmNlIGljb24gcG9zaXRpb24gaW4gdGhlIHNldAoJCQlpZiAoICFvLmljb25wb3MgKSB7CgkJCQlvLmljb25wb3MgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaWNvbnBvcyIgKTsKCQkJfQoKCQkJaWYoICFvLm1pbmkgKSB7CgkJCQlvLm1pbmkgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAibWluaSIgKTsKCQkJfQoJCX0KCQljb2xsYXBzaWJsZUNvbnRlbnQuYWRkQ2xhc3MoICggby5jb250ZW50VGhlbWUgKSA/ICggInVpLWJvZHktIiArIG8uY29udGVudFRoZW1lICkgOiAiIik7CgoJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkvL2Ryb3AgaGVhZGluZyBpbiBiZWZvcmUgY29udGVudAoJCQkuaW5zZXJ0QmVmb3JlKCBjb2xsYXBzaWJsZUNvbnRlbnQgKQoJCQkvL21vZGlmeSBtYXJrdXAgJiBhdHRyaWJ1dGVzCgkJCS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmciICkKCQkJLmFwcGVuZCggIjxzcGFuIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyc+PC9zcGFuPiIgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJaWNvbnBvczogJGVsLmpxbURhdGEoICJpY29ucG9zIiApIHx8IG8uaWNvbnBvcyB8fCAibGVmdCIsCgkJCQkJaWNvbjogInBsdXMiLAoJCQkJCW1pbmk6IG8ubWluaSwKCQkJCQl0aGVtZTogby50aGVtZQoJCQkJfSkKCQkJLmFkZCggIi51aS1idG4taW5uZXIiLCAkZWwgKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIiApOwoKCQkvL2V2ZW50cwoJCWNvbGxhcHNpYmxlCgkJCS5iaW5kKCAiZXhwYW5kIGNvbGxhcHNlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJaXNDb2xsYXBzZSA9ICggZXZlbnQudHlwZSA9PT0gImNvbGxhcHNlIiApLAoJCQkJCSAgICBjb250ZW50VGhlbWUgPSBvLmNvbnRlbnRUaGVtZTsKCgkJCQkJY29sbGFwc2libGVIZWFkaW5nCgkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiwgaXNDb2xsYXBzZSkKCQkJCQkJLmZpbmQoICIudWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMiICkKCQkJCQkJCS50ZXh0KCBpc0NvbGxhcHNlID8gby5leHBhbmRDdWVUZXh0IDogby5jb2xsYXBzZUN1ZVRleHQgKQoJCQkJCQkuZW5kKCkKCQkJCQkJLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1taW51cyIsICFpc0NvbGxhcHNlICkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tcGx1cyIsIGlzQ29sbGFwc2UgKQoJCQkJCQkuZW5kKCkKCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCQkJCSR0aGlzLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApOwoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbnRlbnQtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApLmF0dHIoICJhcmlhLWhpZGRlbiIsIGlzQ29sbGFwc2UgKTsKCgkJCQkJaWYgKCBjb250ZW50VGhlbWUgJiYgKCAhY29sbGFwc2libGVTZXQubGVuZ3RoIHx8IGNvbGxhcHNpYmxlLmpxbURhdGEoICJjb2xsYXBzaWJsZS1sYXN0IiApICkgKSB7CgkJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkKCBjb2xsYXBzaWJsZUhlYWRpbmcuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGVDb250ZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCQkJfQoJCQl9KQoJCQkudHJpZ2dlciggby5jb2xsYXBzZWQgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS5iaW5kKCAidGFwIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJY29sbGFwc2libGVIZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJdmFyIHR5cGUgPSBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICIudWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgPyAiZXhwYW5kIiA6ICJjb2xsYXBzZSI7CgoJCQkJY29sbGFwc2libGUudHJpZ2dlciggdHlwZSApOwoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQubW9iaWxlLmNvbGxhcHNpYmxlLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGVzZXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApLAoJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBJbmhlcml0IHRoZSB0aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggJGVsLCAiYyIgKTsKCQl9CgkJLy8gSW5oZXJpdCB0aGUgY29udGVudC10aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQlvLmNvbnRlbnRUaGVtZSA9ICRlbC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQl9CgoJCWlmICggIW8uY29ybmVycyApIHsKCQkJby5jb3JuZXJzID0gJGVsLmpxbURhdGEoICJjb3JuZXJzIiApID09PSB1bmRlZmluZWQgPyB0cnVlIDogZmFsc2U7CgkJfQoKCQkvLyBJbml0aWFsaXplIHRoZSBjb2xsYXBzaWJsZSBzZXQgaWYgaXQncyBub3QgYWxyZWFkeSBpbml0aWFsaXplZAoJCWlmICggISRlbC5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIgKSApIHsKCQkJJGVsCgkJCQkuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiLCB0cnVlICkKCQkJCS5iaW5kKCAiZXhwYW5kIGNvbGxhcHNlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCXZhciBpc0NvbGxhcHNlID0gKCBldmVudC50eXBlID09PSAiY29sbGFwc2UiICksCgkJCQkJCWNvbGxhcHNpYmxlID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1jb2xsYXBzaWJsZSIgKSwKCQkJCQkJd2lkZ2V0ID0gY29sbGFwc2libGUuZGF0YSggImNvbGxhcHNpYmxlIiApLAoJCQkJCSAgICBjb250ZW50VGhlbWUgPSB3aWRnZXQub3B0aW9ucy5jb250ZW50VGhlbWU7CgkJCQkJaWYgKCBjb250ZW50VGhlbWUgJiYgY29sbGFwc2libGUuanFtRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiICkgKSB7CgkJCQkJCWNvbGxhcHNpYmxlLmZpbmQoICIudWktY29sbGFwc2libGUtaGVhZGluZyIgKS5maXJzdCgpCgkJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKQoJCQkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiwgaXNDb2xsYXBzZSApOwoJCQkJCQljb2xsYXBzaWJsZS5maW5kKCAiLnVpLWNvbGxhcHNpYmxlLWNvbnRlbnQiICkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiwgIWlzQ29sbGFwc2UgKTsKCQkJCQl9CgkJCQl9KQoJCQkJLmJpbmQoICJleHBhbmQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJJCggZXZlbnQudGFyZ2V0ICkKCQkJCQkJLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICkKCQkJCQkJLnNpYmxpbmdzKCAiLnVpLWNvbGxhcHNpYmxlIiApCgkJCQkJCS50cmlnZ2VyKCAiY29sbGFwc2UiICk7CgkJCQl9KTsKCQl9Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGVzSW5TZXQgPSAkZWwuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApOwoKCQkkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUuZW5oYW5jZSggY29sbGFwc2libGVzSW5TZXQubm90KCAiLnVpLWNvbGxhcHNpYmxlIiApICk7CgoJCS8vIGNsZWFuIHVwIGJvcmRlcnMKCQljb2xsYXBzaWJsZXNJblNldC5lYWNoKCBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLmpxbVJlbW92ZURhdGEoICJjb2xsYXBzaWJsZS1sYXN0IiApCgkJCQkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCQkuZmluZCggImEiICkuZmlyc3QoKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIiApCgkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSIgKTsKCQl9KTsKCgkJY29sbGFwc2libGVzSW5TZXQuZmlyc3QoKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYWRkQ2xhc3MoIG8uY29ybmVycyA/ICJ1aS1jb3JuZXItdG9wIiA6ICIiICkKCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICk7CgoJCWNvbGxhcHNpYmxlc0luU2V0Lmxhc3QoKQoJCQkuanFtRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiLCB0cnVlICkKCQkJLmZpbmQoICJhIiApCgkJCQkuZmlyc3QoKQoJCQkJLmFkZENsYXNzKCBvLmNvcm5lcnMgPyAidWktY29ybmVyLWJvdHRvbSIgOiAiIiApCgkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5jb2xsYXBzaWJsZXNldC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLm5hdmJhciIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWljb25wb3M6ICJ0b3AiLAoJCWdyaWQ6IG51bGwsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nbmF2YmFyJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCl7CgoJCXZhciAkbmF2YmFyID0gdGhpcy5lbGVtZW50LAoJCQkkbmF2YnRucyA9ICRuYXZiYXIuZmluZCggImEiICksCgkJCWljb25wb3MgPSAkbmF2YnRucy5maWx0ZXIoICI6anFtRGF0YShpY29uKSIgKS5sZW5ndGggPwoJCQkJCQkJCQl0aGlzLm9wdGlvbnMuaWNvbnBvcyA6IHVuZGVmaW5lZDsKCgkJJG5hdmJhci5hZGRDbGFzcyggInVpLW5hdmJhciB1aS1taW5pIiApCgkJCS5hdHRyKCAicm9sZSIsIm5hdmlnYXRpb24iICkKCQkJLmZpbmQoICJ1bCIgKQoJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWlubGluZTogICAgIHRydWUsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiggISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktZGlzYWJsZWQiKSApIHsKCQkJCSRuYXZidG5zLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7CgoJCS8vIEJ1dHRvbnMgaW4gdGhlIG5hdmJhciB3aXRoIHVpLXN0YXRlLXBlcnNpc3QgY2xhc3Mgc2hvdWxkIHJlZ2FpbiB0aGVpciBhY3RpdmUgc3RhdGUgYmVmb3JlIHBhZ2Ugc2hvdwoJCSRuYXZiYXIuY2xvc2VzdCggIi51aS1wYWdlIiApLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkkbmF2YnRucy5maWx0ZXIoICIudWktc3RhdGUtcGVyc2lzdCIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUubmF2YmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy9LZWVwcyB0cmFjayBvZiB0aGUgbnVtYmVyIG9mIGxpc3RzIHBlciBwYWdlIFVJRAovL1RoaXMgYWxsb3dzIHN1cHBvcnQgZm9yIG11bHRpcGxlIG5lc3RlZCBsaXN0IGluIHRoZSBzYW1lIHBhZ2UKLy9odHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzE2MTcKdmFyIGxpc3RDb3VudFBlclBhZ2UgPSB7fTsKCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUud2lkZ2V0LCB7CgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6ICJjIiwKCQloZWFkZXJUaGVtZTogImIiLAoJCWRpdmlkZXJUaGVtZTogImIiLAoJCXNwbGl0SWNvbjogImFycm93LXIiLAoJCXNwbGl0VGhlbWU6ICJiIiwKCQlpbnNldDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nbGlzdHZpZXcnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHQgPSB0aGlzLAoJCQlsaXN0dmlld0NsYXNzZXMgPSAiIjsKCQkJCgkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5pbnNldCA/ICIgdWktbGlzdHZpZXctaW5zZXQgdWktY29ybmVyLWFsbCB1aS1zaGFkb3cgIiA6ICIiOwoKCQkvLyBjcmVhdGUgbGlzdHZpZXcgbWFya3VwCgkJdC5lbGVtZW50LmFkZENsYXNzKGZ1bmN0aW9uKCBpLCBvcmlnICkgewoJCQlyZXR1cm4gb3JpZyArICIgdWktbGlzdHZpZXcgIiArIGxpc3R2aWV3Q2xhc3NlczsKCQl9KTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9yZW1vdmVDb3JuZXJzOiBmdW5jdGlvbiggbGksIHdoaWNoICkgewoJCXZhciB0b3AgPSAidWktY29ybmVyLXRvcCB1aS1jb3JuZXItdHIgdWktY29ybmVyLXRsIiwKCQkJYm90ID0gInVpLWNvcm5lci1ib3R0b20gdWktY29ybmVyLWJyIHVpLWNvcm5lci1ibCI7CgoJCWxpID0gbGkuYWRkKCBsaS5maW5kKCAiLnVpLWJ0bi1pbm5lciwgLnVpLWxpLWxpbmstYWx0LCAudWktbGktdGh1bWIiICkgKTsKCgkJaWYgKCB3aGljaCA9PT0gInRvcCIgKSB7CgkJCWxpLnJlbW92ZUNsYXNzKCB0b3AgKTsKCQl9IGVsc2UgaWYgKCB3aGljaCA9PT0gImJvdHRvbSIgKSB7CgkJCWxpLnJlbW92ZUNsYXNzKCBib3QgKTsKCQl9IGVsc2UgewoJCQlsaS5yZW1vdmVDbGFzcyggdG9wICsgIiAiICsgYm90ICk7CgkJfQoJfSwKCglfcmVmcmVzaENvcm5lcnM6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyICRsaSwKCQkJJHZpc2libGVsaSwKCQkJJHRvcGxpLAoJCQkkYm90dG9tbGk7CgoJCSRsaSA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggImxpIiApOwoJCS8vIGF0IGNyZWF0ZSB0aW1lIHRoZSBsaSBhcmUgbm90IHZpc2libGUgeWV0IHNvIHdlIG5lZWQgdG8gcmVseSBvbiAudWktc2NyZWVuLWhpZGRlbgoJCSR2aXNpYmxlbGkgPSBjcmVhdGUgPyAkbGkubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICkgOiAkbGkuZmlsdGVyKCAiOnZpc2libGUiICk7CgoJCS8vIHVpLWxpLWxhc3QgaXMgdXNlZCBmb3Igc2V0dGluZyBib3JkZXItYm90dG9tIG9uIHRoZSBsYXN0IGxpCQkKCQkkbGkuZmlsdGVyKCAiLnVpLWxpLWxhc3QiICkucmVtb3ZlQ2xhc3MoICJ1aS1saS1sYXN0IiApOwoJCQkJCQoJCWlmICggdGhpcy5vcHRpb25zLmluc2V0ICkgewoJCQl0aGlzLl9yZW1vdmVDb3JuZXJzKCAkbGkgKTsKCgkJCS8vIFNlbGVjdCB0aGUgZmlyc3QgdmlzaWJsZSBsaSBlbGVtZW50CgkJCSR0b3BsaSA9ICR2aXNpYmxlbGkuZmlyc3QoKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKTsKCgkJCSR0b3BsaS5hZGQoICR0b3BsaS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJLm5vdCggIi51aS1saS1saW5rLWFsdCBzcGFuOmZpcnN0LWNoaWxkIiApICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApCgkJCQkuZW5kKCkKCQkJCS5maW5kKCAiLnVpLWxpLWxpbmstYWx0LCAudWktbGktbGluay1hbHQgc3BhbjpmaXJzdC1jaGlsZCIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10ciIgKQoJCQkJLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS10aHVtYiIgKQoJCQkJCS5ub3QoICIudWktbGktaWNvbiIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10bCIgKTsKCgkJCS8vIFNlbGVjdCB0aGUgbGFzdCB2aXNpYmxlIGxpIGVsZW1lbnQKCQkJJGJvdHRvbWxpID0gJHZpc2libGVsaS5sYXN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20gdWktbGktbGFzdCIgKTsKCgkJCSRib3R0b21saS5hZGQoICRib3R0b21saS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKSApCgkJCQkuZmluZCggIi51aS1saS1saW5rLWFsdCIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1iciIgKQoJCQkJLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS10aHVtYiIgKQoJCQkJCS5ub3QoIi51aS1saS1pY29uIikKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYmwiICk7CgkJfSBlbHNlIHsKCQkJJHZpc2libGVsaS5sYXN0KCkuYWRkQ2xhc3MoICJ1aS1saS1sYXN0IiApOwoJCX0KCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0sCgoJLy8gVGhpcyBpcyBhIGdlbmVyaWMgdXRpbGl0eSBtZXRob2QgZm9yIGZpbmRpbmcgdGhlIGZpcnN0CgkvLyBub2RlIHdpdGggYSBnaXZlbiBub2RlTmFtZS4gSXQgdXNlcyBiYXNpYyBET00gdHJhdmVyc2FsCgkvLyB0byBiZSBmYXN0IGFuZCBpcyBtZWFudCB0byBiZSBhIHN1YnN0aXR1dGUgZm9yIHNpbXBsZQoJLy8gJC5mbi5jbG9zZXN0KCkgYW5kICQuZm4uY2hpbGRyZW4oKSBjYWxscyBvbiBhIHNpbmdsZQoJLy8gZWxlbWVudC4gTm90ZSB0aGF0IGNhbGxlcnMgbXVzdCBwYXNzIGJvdGggdGhlIGxvd2VyQ2FzZQoJLy8gYW5kIHVwcGVyQ2FzZSB2ZXJzaW9uIG9mIHRoZSBub2RlTmFtZSB0aGV5IGFyZSBsb29raW5nIGZvci4KCS8vIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcyBpcyB0aGF0IHRoaXMgZnVuY3Rpb24gd2lsbCBiZQoJLy8gY2FsbGVkIG1hbnkgdGltZXMgYW5kIHdlIHdhbnQgdG8gYXZvaWQgaGF2aW5nIHRvIGxvd2VyY2FzZQoJLy8gdGhlIG5vZGVOYW1lIGZyb20gdGhlIGVsZW1lbnQgZXZlcnkgdGltZSB0byBlbnN1cmUgd2UgaGF2ZQoJLy8gYSBtYXRjaC4gTm90ZSB0aGF0IHRoaXMgZnVuY3Rpb24gbGl2ZXMgaGVyZSBmb3Igbm93LCBidXQgbWF5CgkvLyBiZSBtb3ZlZCBpbnRvICQubW9iaWxlIGlmIG90aGVyIGNvbXBvbmVudHMgbmVlZCBhIHNpbWlsYXIgbWV0aG9kLgoJX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIG5leHRQcm9wLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmV0dXJuIGVsZTsKCQkJfQoJCQllbGUgPSBlbGVbIG5leHRQcm9wIF07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCV9nZXRDaGlsZHJlbkJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIHJlc3VsdHMgPSBbXSwKCQkJZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCWVsZSA9IGVsZS5maXJzdENoaWxkOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmVzdWx0cy5wdXNoKCBlbGUgKTsKCQkJfQoJCQllbGUgPSBlbGUubmV4dFNpYmxpbmc7CgkJfQoJCXJldHVybiAkKCByZXN1bHRzICk7Cgl9LAoKCV9hZGRUaHVtYkNsYXNzZXM6IGZ1bmN0aW9uKCBjb250YWluZXJzICkgewoJCXZhciBpLCBpbWcsIGxlbiA9IGNvbnRhaW5lcnMubGVuZ3RoOwoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWltZyA9ICQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGNvbnRhaW5lcnNbIGkgXS5maXJzdENoaWxkLCAibmV4dFNpYmxpbmciLCAiaW1nIiwgIklNRyIgKSApOwoJCQlpZiAoIGltZy5sZW5ndGggKSB7CgkJCQlpbWcuYWRkQ2xhc3MoICJ1aS1saS10aHVtYiIgKTsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5pcyggIi51aS1saS1pY29uIiApID8gInVpLWxpLWhhcy1pY29uIiA6ICJ1aS1saS1oYXMtdGh1bWIiICk7CgkJCX0KCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5wYXJlbnRQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQl0aGlzLl9jcmVhdGVTdWJQYWdlcygpOwoKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCXNlbGYgPSB0aGlzLAoJCQlkaXZpZGVydGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAiZGl2aWRlcnRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lLAoJCQlsaXN0c3BsaXR0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJzcGxpdHRoZW1lIiApLAoJCQlsaXN0c3BsaXRpY29uID0gJGxpc3QuanFtRGF0YSggInNwbGl0aWNvbiIgKSwKCQkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApLAoJCQlvbCA9ICEhJC5ub2RlTmFtZSggJGxpc3RbIDAgXSwgIm9sIiApLAoJCQlqc0NvdW50ID0gISQuc3VwcG9ydC5jc3NQc2V1ZG9FbGVtZW50LAoJCQlzdGFydCA9ICRsaXN0LmF0dHIoICJzdGFydCIgKSwKCQkJaXRlbUNsYXNzRGljdCA9IHt9LAoJCQlpdGVtLCBpdGVtQ2xhc3MsIGl0ZW1UaGVtZSwKCQkJYSwgbGFzdCwgc3BsaXR0aGVtZSwgY291bnRlciwgc3RhcnRDb3VudCwgbmV3U3RhcnRDb3VudCwgY291bnRQYXJlbnQsIGljb24sIGltZ1BhcmVudHMsIGltZywgbGlua0ljb247CgoJCWlmICggb2wgJiYganNDb3VudCApIHsKCQkJJGxpc3QuZmluZCggIi51aS1saS1kZWMiICkucmVtb3ZlKCk7CgkJfQoJCQoJCWlmICggb2wgKSB7CQoJCQkvLyBDaGVjayBpZiBhIHN0YXJ0IGF0dHJpYnV0ZSBoYXMgYmVlbiBzZXQgd2hpbGUgdGFraW5nIGEgdmFsdWUgb2YgMCBpbnRvIGFjY291bnQKCQkJaWYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApIHsKCQkJCWlmICggIWpzQ291bnQgKSB7CgkJCQkJc3RhcnRDb3VudCA9IHBhcnNlRmxvYXQoIHN0YXJ0ICkgLSAxOwoJCQkJCSRsaXN0LmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgc3RhcnRDb3VudCApOwoJCQkJfSBlbHNlIHsKCQkJCQljb3VudGVyID0gcGFyc2VGbG9hdCggc3RhcnQgKTsKCQkJCX0KCQkJfSBlbHNlIGlmICgganNDb3VudCApIHsKCQkJCQljb3VudGVyID0gMTsKCQkJfQkKCQl9CgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWZvciAoIHZhciBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAidWktbGkiOwoKCQkJLy8gSWYgd2UncmUgY3JlYXRpbmcgdGhlIGVsZW1lbnQsIHdlIHVwZGF0ZSBpdCByZWdhcmRsZXNzCgkJCWlmICggY3JlYXRlIHx8ICFpdGVtLmhhc0NsYXNzKCAidWktbGkiICkgKSB7CgkJCQlpdGVtVGhlbWUgPSBpdGVtLmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lOwoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQl2YXIgaXNEaXZpZGVyID0gKCBpdGVtLmpxbURhdGEoICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApOwoKCQkJCWlmICggYS5sZW5ndGggJiYgIWlzRGl2aWRlciApIHsKCQkJCQlpY29uID0gaXRlbS5qcW1EYXRhKCAiaWNvbiIgKTsKCgkJCQkJaXRlbS5idXR0b25NYXJrdXAoewoJCQkJCQl3cmFwcGVyRWxzOiAiZGl2IiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCWljb25wb3M6ICJyaWdodCIsCgkJCQkJCWljb246IGEubGVuZ3RoID4gMSB8fCBpY29uID09PSBmYWxzZSA/IGZhbHNlIDogaWNvbiB8fCAiYXJyb3ctciIsCgkJCQkJCXRoZW1lOiBpdGVtVGhlbWUKCQkJCQl9KTsKCgkJCQkJaWYgKCAoIGljb24gIT0gZmFsc2UgKSAmJiAoIGEubGVuZ3RoID09IDEgKSApIHsKCQkJCQkJaXRlbS5hZGRDbGFzcyggInVpLWxpLWhhcy1hcnJvdyIgKTsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5yZW1vdmVDbGFzcyggInVpLWxpbmsiICkuYWRkQ2xhc3MoICJ1aS1saW5rLWluaGVyaXQiICk7CgoJCQkJCWlmICggYS5sZW5ndGggPiAxICkgewoJCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1oYXMtYWx0IjsKCgkJCQkJCWxhc3QgPSBhLmxhc3QoKTsKCQkJCQkJc3BsaXR0aGVtZSA9IGxpc3RzcGxpdHRoZW1lIHx8IGxhc3QuanFtRGF0YSggInRoZW1lIiApIHx8IG8uc3BsaXRUaGVtZTsKCQkJCQkJbGlua0ljb24gPSBsYXN0LmpxbURhdGEoICJpY29uIiApOwoKCQkJCQkJbGFzdC5hcHBlbmRUbyggaXRlbSApCgkJCQkJCQkuYXR0ciggInRpdGxlIiwgbGFzdC5nZXRFbmNvZGVkVGV4dCgpICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWxpLWxpbmstYWx0IiApCgkJCQkJCQkuZW1wdHkoKQoJCQkJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJCQl0aGVtZTogaXRlbVRoZW1lLAoJCQkJCQkJCWljb246IGZhbHNlLAoJCQkJCQkJCWljb25wb3M6ICJub3RleHQiCgkJCQkJCQl9KQoJCQkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCQkJLmFwcGVuZCgKCQkJCQkJCQkJJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKS5idXR0b25NYXJrdXAoewoJCQkJCQkJCQkJc2hhZG93OiB0cnVlLAoJCQkJCQkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQkJCQkJCXRoZW1lOiBzcGxpdHRoZW1lLAoJCQkJCQkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJCQkJCQkvLyBsaW5rIGljb24gb3ZlcnJpZGVzIGxpc3QgaXRlbSBpY29uIG92ZXJyaWRlcyB1bCBlbGVtZW50IG92ZXJyaWRlcyBvcHRpb25zCgkJCQkJCQkJCQlpY29uOiBsaW5rSWNvbiB8fCBpY29uIHx8IGxpc3RzcGxpdGljb24gfHwgby5zcGxpdEljb24KCQkJCQkJCQkJfSkKCQkJCQkJCQkpOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGlzRGl2aWRlciApIHsKCgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktZGl2aWRlciB1aS1iYXItIiArIGRpdmlkZXJ0aGVtZTsKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgoJCQkJCWlmICggb2wgKSB7CQoJCQkJCQkvL3Jlc2V0IGNvdW50ZXIgd2hlbiBhIGRpdmlkZXIgaGVhZGluZyBpcyBlbmNvdW50ZXJlZAoJCQkJCQlpZiAoIHN0YXJ0IHx8IHN0YXJ0ID09PSAwICkgewoJCQkJCQkJaWYgKCAhanNDb3VudCApIHsKCQkJCQkJCQluZXdTdGFydENvdW50ID0gcGFyc2VGbG9hdCggc3RhcnQgKSAtIDE7CgkJCQkJCQkJaXRlbS5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIG5ld1N0YXJ0Q291bnQgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJY291bnRlciA9IHBhcnNlRmxvYXQoIHN0YXJ0ICk7CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSBpZiAoIGpzQ291bnQgKSB7CgkJCQkJCQkJY291bnRlciA9IDE7CgkJCQkJCX0JCgkJCQkJfQoKCQkJCX0gZWxzZSB7CgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktc3RhdGljIHVpLWJvZHktIiArIGl0ZW1UaGVtZTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBvbCAmJiBqc0NvdW50ICYmIGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktZGl2aWRlciIgKSA8IDAgKSB7CgkJCQljb3VudFBhcmVudCA9IGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktc3RhdGljIiApID4gMCA/IGl0ZW0gOiBpdGVtLmZpbmQoICIudWktbGluay1pbmhlcml0IiApOwoKCQkJCWNvdW50UGFyZW50LmFkZENsYXNzKCAidWktbGktanNudW1iZXJpbmciICkKCQkJCQkucHJlcGVuZCggIjxzcGFuIGNsYXNzPSd1aS1saS1kZWMnPiIgKyAoIGNvdW50ZXIrKyApICsgIi4gPC9zcGFuPiIgKTsKCQkJfQoKCQkJLy8gSW5zdGVhZCBvZiBzZXR0aW5nIGl0ZW0gY2xhc3MgZGlyZWN0bHkgb24gdGhlIGxpc3QgaXRlbSBhbmQgaXRzCgkJCS8vIGJ0bi1pbm5lciBhdCB0aGlzIHBvaW50IGluIHRpbWUsIHB1c2ggdGhlIGl0ZW0gaW50byBhIGRpY3Rpb25hcnkKCQkJLy8gdGhhdCB0ZWxscyB1cyB3aGF0IGNsYXNzIHRvIHNldCBvbiBpdCBzbyB3ZSBjYW4gZG8gdGhpcyBhZnRlciB0aGlzCgkJCS8vIHByb2Nlc3NpbmcgbG9vcCBpcyBmaW5pc2hlZC4KCgkJCWlmICggIWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkgewoJCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gPSBbXTsKCQkJfQoKCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0ucHVzaCggaXRlbVsgMCBdICk7CgkJfQoKCQkvLyBTZXQgdGhlIGFwcHJvcHJpYXRlIGxpc3R2aWV3IGl0ZW0gY2xhc3NlcyBvbiBlYWNoIGxpc3QgaXRlbQoJCS8vIGFuZCB0aGVpciBidG4taW5uZXIgZWxlbWVudHMuIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApLmNoaWxkcmVuKCAiLnVpLWJ0bi1pbm5lciIgKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQkkbGlzdC5maW5kKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKS5hZGRDbGFzcyggInVpLWxpLWhlYWRpbmciICkKCQkJLmVuZCgpCgoJCQkuZmluZCggInAsIGRsIiApLmFkZENsYXNzKCAidWktbGktZGVzYyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWFzaWRlIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCh0aGlzKTsKCQkJCQkkdGhpcy5wcmVwZW5kVG8oICR0aGlzLnBhcmVudCgpICk7IC8vc2hpZnQgYXNpZGUgdG8gZnJvbnQgZm9yIGNzcyBmbG9hdAoJCQkJfSkKCQkJLmVuZCgpCgoJCQkuZmluZCggIi51aS1saS1jb3VudCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCQkJfSkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArICggJGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUpICsgIiB1aS1idG4tY29ybmVyLWFsbCIgKTsKCgkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBsb29rIGF0IHRoZSBmaXJzdCBpbWFnZSBpbiB0aGUgbGlzdCBpdGVtCgkJLy8gaXRzZWxmLCBhbmQgYW55IC51aS1saW5rLWluaGVyaXQgZWxlbWVudCBpdCBtYXkgY29udGFpbiwgc28gd2UKCQkvLyBjYW4gcGxhY2UgdGhlIGFwcHJvcHJpYXRlIGNsYXNzZXMgb24gdGhlIGltYWdlIGFuZCBsaXN0IGl0ZW0uCgkJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIHNvbWV0aGluZyBsaWtlOgoJCS8vCgkJLy8gICAgbGkuZmluZCgiPmltZzplcSgwKSwgLnVpLWxpbmstaW5oZXJpdD5pbWc6ZXEoMCkiKS5lYWNoKCAuLi4gKTsKCQkvLwoJCS8vIEJ1dCBleGVjdXRpbmcgYSBmaW5kKCkgbGlrZSB0aGF0IG9uIFdpbmRvd3MgUGhvbmUgNy41IHRvb2sgYQoJCS8vIHJlYWxseSBsb25nIHRpbWUuIFdhbGtpbmcgdGhpbmdzIG1hbnVhbGx5IHdpdGggdGhlIGNvZGUgYmVsb3cKCQkvLyBhbGxvd3MgdGhlIDQwMCBsaXN0dmlldyBpdGVtIHBhZ2UgdG8gbG9hZCBpbiBhYm91dCAzIHNlY29uZHMgYXMKCQkvLyBvcHBvc2VkIHRvIDMwIHNlY29uZHMuCgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoICRsaXN0LmZpbmQoICIudWktbGluay1pbmhlcml0IiApICk7CgoJCXRoaXMuX3JlZnJlc2hDb3JuZXJzKCBjcmVhdGUgKTsKCX0sCgoJLy9jcmVhdGUgYSBzdHJpbmcgZm9yIElEL3N1YnBhZ2UgdXJsIGNyZWF0aW9uCglfaWRTdHJpbmdFc2NhcGU6IGZ1bmN0aW9uKCBzdHIgKSB7CgkJcmV0dXJuIHN0ci5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywgJy0nKTsKCX0sCgoJX2NyZWF0ZVN1YlBhZ2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFyZW50TGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50UGFnZSA9IHBhcmVudExpc3QuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlwYXJlbnRVcmwgPSBwYXJlbnRQYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCXBhcmVudElkID0gcGFyZW50VXJsIHx8IHBhcmVudFBhZ2VbIDAgXVsgJC5leHBhbmRvIF0sCgkJCXBhcmVudExpc3RJZCA9IHBhcmVudExpc3QuYXR0ciggImlkIiApLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlkbnMgPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCXNlbGYgPSB0aGlzLAoJCQlwZXJzaXN0ZW50Rm9vdGVySUQgPSBwYXJlbnRQYWdlLmZpbmQoICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKS5qcW1EYXRhKCAiaWQiICksCgkJCWhhc1N1YlBhZ2VzOwoKCQlpZiAoIHR5cGVvZiBsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID09PSAidW5kZWZpbmVkIiApIHsKCQkJbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXSA9IC0xOwoJCX0KCgkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdElkIHx8ICsrbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXTsKCgkJJCggcGFyZW50TGlzdC5maW5kKCAibGk+dWwsIGxpPm9sIiApLnRvQXJyYXkoKS5yZXZlcnNlKCkgKS5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlsaXN0ID0gJCggdGhpcyApLAoJCQkJbGlzdElkID0gbGlzdC5hdHRyKCAiaWQiICkgfHwgcGFyZW50TGlzdElkICsgIi0iICsgaSwKCQkJCXBhcmVudCA9IGxpc3QucGFyZW50KCksCgkJCQlub2RlRWxzID0gJCggbGlzdC5wcmV2QWxsKCkudG9BcnJheSgpLnJldmVyc2UoKSApLAoJCQkJbm9kZUVscyA9IG5vZGVFbHMubGVuZ3RoID8gbm9kZUVscyA6ICQoICI8c3Bhbj4iICsgJC50cmltKHBhcmVudC5jb250ZW50cygpWyAwIF0ubm9kZVZhbHVlKSArICI8L3NwYW4+IiApLAoJCQkJdGl0bGUgPSBub2RlRWxzLmZpcnN0KCkuZ2V0RW5jb2RlZFRleHQoKSwvL3VybCBsaW1pdHMgdG8gZmlyc3QgMzAgY2hhcnMgb2YgdGV4dAoJCQkJaWQgPSAoIHBhcmVudFVybCB8fCAiIiApICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArICI9IiArIGxpc3RJZCwKCQkJCXRoZW1lID0gbGlzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby50aGVtZSwKCQkJCWNvdW50VGhlbWUgPSBsaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IHBhcmVudExpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgby5jb3VudFRoZW1lLAoJCQkJbmV3UGFnZSwgYW5jaG9yOwoKCQkJLy9kZWZpbmUgaGFzU3ViUGFnZXMgZm9yIHVzZSBpbiBsYXRlciByZW1vdmFsCgkJCWhhc1N1YlBhZ2VzID0gdHJ1ZTsKCgkJCW5ld1BhZ2UgPSBsaXN0LmRldGFjaCgpCgkJCQkJCS53cmFwKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J3BhZ2UnICIgKwlkbnMgKyAidXJsPSciICsgaWQgKyAiJyAiICsgZG5zICsgInRoZW1lPSciICsgdGhlbWUgKyAiJyAiICsgZG5zICsgImNvdW50LXRoZW1lPSciICsgY291bnRUaGVtZSArICInPjxkaXYgIiArIGRucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj48L2Rpdj4iICkKCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkuYmVmb3JlKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2hlYWRlcicgIiArIGRucyArICJ0aGVtZT0nIiArIG8uaGVhZGVyVGhlbWUgKyAiJz48ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIHRpdGxlICsgIjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkJLmFmdGVyKCBwZXJzaXN0ZW50Rm9vdGVySUQgPyAkKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2Zvb3RlcicgIiArIGRucyArICJpZD0nIisgcGVyc2lzdGVudEZvb3RlcklEICsiJz4iKSA6ICIiICkKCQkJCQkJCS5wYXJlbnQoKQoJCQkJCQkJCS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJbmV3UGFnZS5wYWdlKCk7CgoJCQlhbmNob3IgPSBwYXJlbnQuZmluZCgnYTpmaXJzdCcpOwoKCQkJaWYgKCAhYW5jaG9yLmxlbmd0aCApIHsKCQkJCWFuY2hvciA9ICQoICI8YS8+IiApLmh0bWwoIG5vZGVFbHMgfHwgdGl0bGUgKS5wcmVwZW5kVG8oIHBhcmVudC5lbXB0eSgpICk7CgkJCX0KCgkJCWFuY2hvci5hdHRyKCAiaHJlZiIsICIjIiArIGlkICk7CgoJCX0pLmxpc3R2aWV3KCk7CgoJCS8vIG9uIHBhZ2VoaWRlLCByZW1vdmUgYW55IG5lc3RlZCBwYWdlcyBhbG9uZyB3aXRoIHRoZSBwYXJlbnQgcGFnZSwgYXMgbG9uZyBhcyB0aGV5IGFyZW4ndCBhY3RpdmUKCQkvLyBhbmQgYXJlbid0IGVtYmVkZGVkCgkJaWYoIGhhc1N1YlBhZ2VzICYmCgkJCXBhcmVudFBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgJiYKCQkJcGFyZW50UGFnZS5kYXRhKCJwYWdlIikub3B0aW9ucy5kb21DYWNoZSA9PT0gZmFsc2UgKSB7CgoJCQl2YXIgbmV3UmVtb3ZlID0gZnVuY3Rpb24oIGUsIHVpICl7CgkJCQl2YXIgbmV4dFBhZ2UgPSB1aS5uZXh0UGFnZSwgbnBVUkwsCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQlpZiggdWkubmV4dFBhZ2UgKXsKCQkJCQlucFVSTCA9IG5leHRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQkJaWYoIG5wVVJMLmluZGV4T2YoIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSAhPT0gMCApewoJCQkJCQlzZWxmLmNoaWxkUGFnZXMoKS5yZW1vdmUoKTsKCQkJCQkJcGFyZW50UGFnZS50cmlnZ2VyKCBwckV2ZW50ICk7CgkJCQkJCWlmKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJCQkJcGFyZW50UGFnZS5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9OwoKCQkJLy8gdW5iaW5kIHRoZSBvcmlnaW5hbCBwYWdlIHJlbW92ZSBhbmQgcmVwbGFjZSB3aXRoIG91ciBzcGVjaWFsaXplZCB2ZXJzaW9uCgkJCXBhcmVudFBhZ2UKCQkJCS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICkKCQkJCS5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiwgbmV3UmVtb3ZlKTsKCQl9Cgl9LAoKCS8vIFRPRE8gc29ydCBvdXQgYSBiZXR0ZXIgd2F5IHRvIHRyYWNrIHN1YiBwYWdlcyBvZiB0aGUgbGlzdHZpZXcgdGhpcyBpcyBicml0dGxlCgljaGlsZFBhZ2VzOiBmdW5jdGlvbigpewoJCXZhciBwYXJlbnRVcmwgPSB0aGlzLnBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKTsKCgkJcmV0dXJuICQoICI6anFtRGF0YSh1cmxePSciKyAgcGFyZW50VXJsICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArIicpIik7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogImNoZWNrYm94cmFkaW8iIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jaGVja2JveHJhZGlvIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJbWluaTogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWluaGVyaXRBdHRyID0gZnVuY3Rpb24oIGlucHV0LCBkYXRhQXR0ciApIHsKCQkJCXJldHVybiBpbnB1dC5qcW1EYXRhKCBkYXRhQXR0ciApIHx8IGlucHV0LmNsb3Nlc3QoICJmb3JtLGZpZWxkc2V0IiApLmpxbURhdGEoIGRhdGFBdHRyICkKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gJCggaW5wdXQgKS5jbG9zZXN0KCAibGFiZWwiICksCgkJCWxhYmVsID0gcGFyZW50TGFiZWwubGVuZ3RoID8gcGFyZW50TGFiZWwgOiAkKCBpbnB1dCApLmNsb3Nlc3QoICJmb3JtLGZpZWxkc2V0LDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSw6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maW5kKCAibGFiZWwiICkuZmlsdGVyKCAiW2Zvcj0nIiArIGlucHV0WzBdLmlkICsgIiddIiApLAoJCQlpbnB1dHR5cGUgPSBpbnB1dFswXS50eXBlLAoJCQltaW5pID0gaW5oZXJpdEF0dHIoIGlucHV0LCAibWluaSIgKSB8fCBvLm1pbmksCgkJCWNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb24iLAoJCQl1bmNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb2ZmIiwKCQkJaWNvbiA9IGlucHV0LnBhcmVudHMoICI6anFtRGF0YSh0eXBlPSdob3Jpem9udGFsJykiICkubGVuZ3RoID8gdW5kZWZpbmVkIDogdW5jaGVja2VkU3RhdGUsCgkJCWljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApLAoJCQlhY3RpdmVCdG4gPSBpY29uID8gIiIgOiAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcywKCQkJY2hlY2tlZENsYXNzID0gInVpLSIgKyBjaGVja2VkU3RhdGUgKyBhY3RpdmVCdG4sCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyB1bmNoZWNrZWRTdGF0ZSwKCQkJY2hlY2tlZGljb24gPSAidWktaWNvbi0iICsgY2hlY2tlZFN0YXRlLAoJCQl1bmNoZWNrZWRpY29uID0gInVpLWljb24tIiArIHVuY2hlY2tlZFN0YXRlOwoKCQlpZiAoIGlucHV0dHlwZSAhPT0gImNoZWNrYm94IiAmJiBpbnB1dHR5cGUgIT09ICJyYWRpbyIgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEV4cG9zZSBmb3Igb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWxhYmVsOiBsYWJlbCwKCQkJaW5wdXR0eXBlOiBpbnB1dHR5cGUsCgkJCWNoZWNrZWRDbGFzczogY2hlY2tlZENsYXNzLAoJCQl1bmNoZWNrZWRDbGFzczogdW5jaGVja2VkQ2xhc3MsCgkJCWNoZWNrZWRpY29uOiBjaGVja2VkaWNvbiwKCQkJdW5jaGVja2VkaWNvbjogdW5jaGVja2VkaWNvbgoJCX0pOwoKCQkvLyBJZiB0aGVyZSdzIG5vIHNlbGVjdGVkIHRoZW1lIGNoZWNrIHRoZSBkYXRhIGF0dHIKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQlsYWJlbC5idXR0b25NYXJrdXAoewoJCQl0aGVtZTogby50aGVtZSwKCQkJaWNvbjogaWNvbiwKCQkJc2hhZG93OiBmYWxzZSwKCQkJbWluaTogbWluaSwKCQkJaWNvbnBvczogaWNvbnBvcwoJCX0pOwoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJdmFyIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICd1aS0nICsgaW5wdXR0eXBlOwoKCQlpbnB1dC5hZGQoIGxhYmVsICkud3JhcEFsbCggd3JhcHBlciApOwoKCQlsYWJlbC5iaW5kKHsKCQkJdm1vdXNlb3ZlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAkKCB0aGlzICkucGFyZW50KCkuaXMoICIudWktZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCX0sCgoJCQl2Y2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgoJCQkJaW5wdXQucHJvcCggImNoZWNrZWQiLCBpbnB1dHR5cGUgPT09ICJyYWRpbyIgJiYgdHJ1ZSB8fCAhaW5wdXQucHJvcCggImNoZWNrZWQiICkgKTsKCgkJCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCQkJLy8gaG93IGxhYmVsIGNsaWNrcyBiZWhhdmUgbm9ybWFsbHkgaW4gdGhlIGJyb3dzZXJzCgkJCQkvLyBUT0RPOiBpdCB3b3VsZCBiZSBuaWNlIHRvIGxldCB0aGUgYnJvd3NlcidzIGhhbmRsZSB0aGUgY2xpY2tzIGFuZCBwYXNzIHRoZW0KCQkJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJCQkvLyAgICAgICB3cmFwcGVyIGVsZW1lbnQgbGV2ZWwKCQkJCWlucHV0LnRyaWdnZXJIYW5kbGVyKCAnY2xpY2snICk7CgoJCQkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCQkJLy8gYnV0dG9ucywgYnV0IHdpbGwgbm90IGZvciBjaGVja2JveGVzLiBjbGVhcmluZyB0aGUgY2hlY2tlZCBzdGF0dXMKCQkJCS8vIG9mIG90aGVyIHJhZGlvcyBlbnN1cmVzIHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlIGlzIGFwcGxpZWQgcHJvcGVybHkKCQkJCXNlbGYuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0pOwoKCQlpbnB1dAoJCQkuYmluZCh7CgkJCQl2bW91c2Vkb3duOiBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLl9jYWNoZVZhbHMoKTsKCQkJCX0sCgoJCQkJdmNsaWNrOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJCQkJaWYgKCAkdGhpcy5pcyggIjpjaGVja2VkIiApICkgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCB0cnVlKTsKCQkJCQkJc2VsZi5fZ2V0SW5wdXRTZXQoKS5ub3QoJHRoaXMpLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQl9LAoKCQkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCQlsYWJlbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfSwKCgkJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCQlsYWJlbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfQoJCQl9KTsKCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9jYWNoZVZhbHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaChmdW5jdGlvbigpIHsKCQkJJCh0aGlzKS5qcW1EYXRhKCAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy9yZXR1cm5zIGVpdGhlciBhIHNldCBvZiByYWRpb3Mgd2l0aCB0aGUgc2FtZSBuYW1lIGF0dHJpYnV0ZSwgb3IgYSBzaW5nbGUgY2hlY2tib3gKCV9nZXRJbnB1dFNldDogZnVuY3Rpb24oKXsKCQlpZih0aGlzLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IikgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJCX0KCgkJcmV0dXJuIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSxmaWVsZHNldCw6anFtRGF0YShyb2xlPSdwYWdlJykiICkKCQkJLmZpbmQoICJpbnB1dFtuYW1lPSciKyB0aGlzLmVsZW1lbnRbMF0ubmFtZSArIiddW3R5cGU9JyIrIHRoaXMuaW5wdXR0eXBlICsiJ10iICk7Cgl9LAoKCV91cGRhdGVBbGw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJaWYgKCB0aGlzLmNoZWNrZWQgfHwgc2VsZi5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudFswXSwKCQkJbGFiZWwgPSB0aGlzLmxhYmVsLAoJCQlpY29uID0gbGFiZWwuZmluZCggIi51aS1pY29uIiApOwoKCQlpZiAoIGlucHV0LmNoZWNrZWQgKSB7CgkJCWxhYmVsLmFkZENsYXNzKCB0aGlzLmNoZWNrZWRDbGFzcyApLnJlbW92ZUNsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICk7CgkJCWljb24uYWRkQ2xhc3MoIHRoaXMuY2hlY2tlZGljb24gKS5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRpY29uICk7CgkJfSBlbHNlIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIHRoaXMuY2hlY2tlZENsYXNzICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQkJaWNvbi5yZW1vdmVDbGFzcyggdGhpcy5jaGVja2VkaWNvbiApLmFkZENsYXNzKCB0aGlzLnVuY2hlY2tlZGljb24gKTsKCQl9CgoJCWlmICggaW5wdXQuZGlzYWJsZWQgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuZW5hYmxlKCk7CgkJfQoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdHJ1ZSApLnBhcmVudCgpLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIGZhbHNlICkucGFyZW50KCkucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuY2hlY2tib3hyYWRpby5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiB0cnVlLAoJCWluaXRTZWxlY3RvcjogImJ1dHRvbiwgW3R5cGU9J2J1dHRvbiddLCBbdHlwZT0nc3VibWl0J10sIFt0eXBlPSdyZXNldCddLCBbdHlwZT0naW1hZ2UnXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkkYnV0dG9uLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQl0eXBlLAoJCQluYW1lLAoJCQlpbmxpbmUgPSBvLmlubGluZSB8fCAkZWwuanFtRGF0YSggImlubGluZSIgKSwKCQkJbWluaSA9IG8ubWluaSB8fCAkZWwuanFtRGF0YSggIm1pbmkiICksCgkJCWNsYXNzZXMgPSAiIiwKCQkJJGJ1dHRvblBsYWNlaG9sZGVyOwoKCQkvLyBpZiB0aGlzIGlzIGEgbGluaywgY2hlY2sgaWYgaXQncyBiZWVuIGVuaGFuY2VkIGFuZCwgaWYgbm90LCB1c2UgdGhlIHJpZ2h0IGZ1bmN0aW9uCgkJaWYoICRlbFsgMCBdLnRhZ05hbWUgPT09ICJBIiApIHsKCSAJIAkhJGVsLmhhc0NsYXNzKCAidWktYnRuIiApICYmICRlbC5idXR0b25NYXJrdXAoKTsKCSAJIAlyZXR1cm47CiAJIAl9CgoJCS8vIGdldCB0aGUgaW5oZXJpdGVkIHRoZW1lCgkJLy8gVE9ETyBjZW50cmFsaXplIGZvciBhbGwgd2lkZ2V0cwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYoICEhfiRlbFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmKCAgISF+JGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1yaWdodCI7CgkJfQoKCQlpZiggICRlbC5hdHRyKCAidHlwZSIgKSA9PT0gInN1Ym1pdCIgfHwgJGVsLmF0dHIoICJ0eXBlIiApID09PSAicmVzZXQiICkgewoJCQljbGFzc2VzID8gY2xhc3NlcyArPSAiIHVpLXN1Ym1pdCIgOiAgY2xhc3NlcyA9ICJ1aS1zdWJtaXQiOwoJCX0KCQkKCQkkKCAibGFiZWxbZm9yPSciICsgJGVsLmF0dHIoICJpZCIgKSArICInXSIgKS5hZGRDbGFzcyggInVpLXN1Ym1pdCIgKTsKCgkJLy8gQWRkIEFSSUEgcm9sZQoJCXRoaXMuYnV0dG9uID0gJCggIjxkaXY+PC9kaXY+IiApCgkJCS50ZXh0KCAkZWwudGV4dCgpIHx8ICRlbC52YWwoKSApCgkJCS5pbnNlcnRCZWZvcmUoICRlbCApCgkJCS5idXR0b25NYXJrdXAoewoJCQkJdGhlbWU6IG8udGhlbWUsCgkJCQlpY29uOiBvLmljb24sCgkJCQlpY29ucG9zOiBvLmljb25wb3MsCgkJCQlpbmxpbmU6IGlubGluZSwKCQkJCWNvcm5lcnM6IG8uY29ybmVycywKCQkJCXNoYWRvdzogby5zaGFkb3csCgkJCQlpY29uc2hhZG93OiBvLmljb25zaGFkb3csCgkJCQltaW5pOiBtaW5pCgkJCX0pCgkJCS5hZGRDbGFzcyggY2xhc3NlcyApCgkJCS5hcHBlbmQoICRlbC5hZGRDbGFzcyggInVpLWJ0bi1oaWRkZW4iICkgKTsKCiAgICAgICAgJGJ1dHRvbiA9IHRoaXMuYnV0dG9uOwoJCXR5cGUgPSAkZWwuYXR0ciggInR5cGUiICk7CgkJbmFtZSA9ICRlbC5hdHRyKCAibmFtZSIgKTsKCgkJLy8gQWRkIGhpZGRlbiBpbnB1dCBkdXJpbmcgc3VibWl0IGlmIGlucHV0IHR5cGU9InN1Ym1pdCIgaGFzIGEgbmFtZS4KCQlpZiAoIHR5cGUgIT09ICJidXR0b24iICYmIHR5cGUgIT09ICJyZXNldCIgJiYgbmFtZSApIHsKCQkJCSRlbC5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCQkJLy8gQWRkIGhpZGRlbiBpbnB1dCBpZiBpdCBkb2Vzbid0IGFscmVhZHkgZXhpc3QuCgkJCQkJaWYoICRidXR0b25QbGFjZWhvbGRlciA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkkYnV0dG9uUGxhY2Vob2xkZXIgPSAkKCAiPGlucHV0PiIsIHsKCQkJCQkJCXR5cGU6ICJoaWRkZW4iLAoJCQkJCQkJbmFtZTogJGVsLmF0dHIoICJuYW1lIiApLAoJCQkJCQkJdmFsdWU6ICRlbC5hdHRyKCAidmFsdWUiICkKCQkJCQkJfSkuaW5zZXJ0QmVmb3JlKCAkZWwgKTsKCgkJCQkJCS8vIEJpbmQgdG8gZG9jIHRvIHJlbW92ZSBhZnRlciBzdWJtaXQgaGFuZGxpbmcKCQkJCQkJJCggZG9jdW1lbnQgKS5vbmUoInN1Ym1pdCIsIGZ1bmN0aW9uKCl7CgkJCQkJCQkkYnV0dG9uUGxhY2Vob2xkZXIucmVtb3ZlKCk7CgoJCQkJCQkJLy8gcmVzZXQgdGhlIGxvY2FsIHZhciBzbyB0aGF0IHRoZSBoaWRkZW4gaW5wdXQKCQkJCQkJCS8vIHdpbGwgYmUgcmUtYWRkZWQgb24gc3Vic2VxdWVudCBjbGlja3MKCQkJCQkJCSRidXR0b25QbGFjZWhvbGRlciA9IHVuZGVmaW5lZDsKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSk7CgkJfQoKICAgICAgICAkZWwuYmluZCh7CiAgICAgICAgICAgIGZvY3VzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRidXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGJsdXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJGJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCBmYWxzZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJdGhpcy5idXR0b24uYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCWlmICggJGVsLnByb3AoImRpc2FibGVkIikgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuZW5hYmxlKCk7CgkJfQoKCQkvLyBHcmFiIHRoZSBidXR0b24ncyB0ZXh0IGVsZW1lbnQgZnJvbSBpdHMgaW1wbGVtZW50YXRpb24taW5kZXBlbmRlbnQgZGF0YSBpdGVtCgkJJCggdGhpcy5idXR0b24uZGF0YSggJ2J1dHRvbkVsZW1lbnRzJyApLnRleHQgKS50ZXh0KCAkZWwudGV4dCgpIHx8ICRlbC52YWwoKSApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5idXR0b24ucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmNvbnRyb2xncm91cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJZnVuY3Rpb24gZmxpcENsYXNzZXMoIGVscywgZmxDb3JuZXJzICApIHsKCQllbHMucmVtb3ZlQ2xhc3MoICJ1aS1idG4tY29ybmVyLWFsbCB1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20gdWktY29ybmVyLWxlZnQgdWktY29ybmVyLXJpZ2h0IHVpLWNvbnRyb2xncm91cC1sYXN0IHVpLXNoYWRvdyIgKQoJCQkuZXEoIDAgKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAwIF0gKQoJCQkuZW5kKCkKCQkJLmxhc3QoKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAxIF0gKS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC1sYXN0IiApOwoJfQoKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCQkJZGlyZWN0aW9uOiAkZWwuanFtRGF0YSggInR5cGUiICkgfHwgInZlcnRpY2FsIiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJZXhjbHVkZUludmlzaWJsZTogdHJ1ZSwKCQkJCQkJbWluaTogJGVsLmpxbURhdGEoICJtaW5pIiApCgkJCQkJfSwgb3B0aW9ucyApLAoJCQlncm91cGxlZ2VuZCA9ICRlbC5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJZ3JvdXBoZWFkaW5nID0gJGVsLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbCIgKSwKCQkJZ3JvdXBjb250cm9scyA9ICRlbC5jaGlsZHJlbiggIi51aS1jb250cm9sZ3JvdXAtY29udHJvbHMiICksCgkJCWZsQ29ybmVycyA9IG8uZGlyZWN0aW9uID09PSAiaG9yaXpvbnRhbCIgPyBbICJ1aS1jb3JuZXItbGVmdCIsICJ1aS1jb3JuZXItcmlnaHQiIF0gOiBbICJ1aS1jb3JuZXItdG9wIiwgInVpLWNvcm5lci1ib3R0b20iIF0sCgkJCXR5cGUgPSAkZWwuZmluZCggImlucHV0IiApLmZpcnN0KCkuYXR0ciggInR5cGUiICk7CgoJCS8vIEZpcnN0IHVud3JhcCB0aGUgY29udHJvbHMgaWYgdGhlIGNvbnRyb2xncm91cCB3YXMgYWxyZWFkeSBlbmhhbmNlZAoJCWlmICggZ3JvdXBjb250cm9scy5sZW5ndGggKSB7CgkJCWdyb3VwY29udHJvbHMuY29udGVudHMoKS51bndyYXAoKTsKCQl9CgkJJGVsLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyc+PC9kaXY+IiApOwoKCQlpZiAoIGdyb3VwbGVnZW5kLmxlbmd0aCApIHsKCQkJLy8gUmVwbGFjZSBsZWdlbmQgd2l0aCBtb3JlIHN0eWxhYmxlIHJlcGxhY2VtZW50IGRpdgoJCQkkKCAiPGRpdiByb2xlPSdoZWFkaW5nJyBjbGFzcz0ndWktY29udHJvbGdyb3VwLWxhYmVsJz4iICsgZ3JvdXBsZWdlbmQuaHRtbCgpICsgIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoICRlbC5jaGlsZHJlbiggMCApICk7CgkJCWdyb3VwbGVnZW5kLnJlbW92ZSgpOwoJCX0gZWxzZSBpZiAoIGdyb3VwaGVhZGluZy5sZW5ndGggKSB7CgkJCS8vIEp1c3QgbW92ZSB0aGUgaGVhZGluZyBpZiB0aGUgY29udHJvbGdyb3VwIHdhcyBhbHJlYWR5IGVuaGFuY2VkCgkJCSRlbC5wcmVwZW5kKCBncm91cGhlYWRpbmcgKTsKCQl9CgoJCSRlbC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktY29udHJvbGdyb3VwIHVpLWNvbnRyb2xncm91cC0iICsgby5kaXJlY3Rpb24gKTsKCgkJZmxpcENsYXNzZXMoICRlbC5maW5kKCAiLnVpLWJ0biIgKyAoIG8uZXhjbHVkZUludmlzaWJsZSA/ICI6dmlzaWJsZSIgOiAiIiApICkubm90KCcudWktc2xpZGVyLWhhbmRsZScpLCBmbENvcm5lcnMgKTsKCQlmbGlwQ2xhc3NlcyggJGVsLmZpbmQoICIudWktYnRuLWlubmVyIiApLCBmbENvcm5lcnMgKTsKCgkJaWYgKCBvLnNoYWRvdyApIHsKCQkJJGVsLmFkZENsYXNzKCAidWktc2hhZG93IiApOwoJCX0KCgkJaWYgKCBvLm1pbmkgKSB7CgkJCSRlbC5hZGRDbGFzcyggInVpLW1pbmkiICk7CgkJfQoKCX0pOwp9OwoKLy8gVGhlIHBhZ2VjcmVhdGUgaGFuZGxlciBmb3IgY29udHJvbGdyb3VwIGlzIGluIGpxdWVyeS5tb2JpbGUuaW5pdCBiZWNhdXNlIG9mIHRoZSBzb2Z0LWRlcGVuZGVuY3kgb24gdGhlIHdyYXBwZWQgd2lkZ2V0cwoKfSkoalF1ZXJ5KTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoKCS8vbGlua3Mgd2l0aGluIGNvbnRlbnQgYXJlYXMsIHRlc3RzIGluY2x1ZGVkIHdpdGggcGFnZQoJJCggZS50YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLm5vdCggIi51aS1idG4sIC51aS1saW5rLWluaGVyaXQsIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmFkZENsYXNzKCAidWktbGluayIgKTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKCiggZnVuY3Rpb24oICQgKSB7Cgl2YXIJbWV0YSA9ICQoICJtZXRhW25hbWU9dmlld3BvcnRdIiApLAogICAgICAgIGluaXRpYWxDb250ZW50ID0gbWV0YS5hdHRyKCAiY29udGVudCIgKSwKICAgICAgICBkaXNhYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xLCB1c2VyLXNjYWxhYmxlPW5vIiwKICAgICAgICBlbmFibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEwLCB1c2VyLXNjYWxhYmxlPXllcyIsCgkJZGlzYWJsZWRJbml0aWFsbHkgPSAvKHVzZXItc2NhbGFibGVbXHNdKj1bXHNdKm5vKXwobWF4aW11bS1zY2FsZVtcc10qPVtcc10qMSlbJCxcc10vLnRlc3QoIGluaXRpYWxDb250ZW50ICk7CgkKCSQubW9iaWxlLnpvb20gPSAkLmV4dGVuZCgge30sIHsKCQllbmFibGVkOiAhZGlzYWJsZWRJbml0aWFsbHksCgkJbG9ja2VkOiBmYWxzZSwKCQlkaXNhYmxlOiBmdW5jdGlvbiggbG9jayApIHsKCQkJaWYoICFkaXNhYmxlZEluaXRpYWxseSAmJiAhJC5tb2JpbGUuem9vbS5sb2NrZWQgKXsKCSAgICAgICAgCW1ldGEuYXR0ciggImNvbnRlbnQiLCBkaXNhYmxlZFpvb20gKTsKCSAgICAgICAgCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IGZhbHNlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBsb2NrIHx8IGZhbHNlOwoJCQl9CgkJfSwKCQllbmFibGU6IGZ1bmN0aW9uKCB1bmxvY2sgKSB7CgkJCWlmKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgKCAhJC5tb2JpbGUuem9vbS5sb2NrZWQgfHwgdW5sb2NrID09PSB0cnVlICkgKXsKCQkgICAgICAgIG1ldGEuYXR0ciggImNvbnRlbnQiLCBlbmFibGVkWm9vbSApOwoJCSAgICAgICAgJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gZmFsc2U7CgkJCX0KCQl9LAoJCXJlc3RvcmU6IGZ1bmN0aW9uKCkgewoJCQlpZiggIWRpc2FibGVkSW5pdGlhbGx5ICl7CgkgICAgICAgIAltZXRhLmF0dHIoICJjb250ZW50IiwgaW5pdGlhbENvbnRlbnQgKTsKCSAgICAgICAgCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCX0KCQl9Cgl9KTsKCn0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJbWluaTogZmFsc2UsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSd0ZXh0J10sIGlucHV0W3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSwgaW5wdXRbdHlwZT0nbnVtYmVyJ10sIDpqcW1EYXRhKHR5cGU9J251bWJlcicpLCBpbnB1dFt0eXBlPSdwYXNzd29yZCddLCBpbnB1dFt0eXBlPSdlbWFpbCddLCBpbnB1dFt0eXBlPSd1cmwnXSwgaW5wdXRbdHlwZT0ndGVsJ10sIHRleHRhcmVhLCBpbnB1dFt0eXBlPSd0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGUnXSwgaW5wdXRbdHlwZT0nbW9udGgnXSwgaW5wdXRbdHlwZT0nd2VlayddLCBpbnB1dFt0eXBlPSdkYXRldGltZSddLCBpbnB1dFt0eXBlPSdkYXRldGltZS1sb2NhbCddLCBpbnB1dFt0eXBlPSdjb2xvciddLCBpbnB1dDpub3QoW3R5cGVdKSIsCgkJY2xlYXJTZWFyY2hCdXR0b25UZXh0OiAiY2xlYXIgdGV4dCIsCgkJZGlzYWJsZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXRoZW1lID0gby50aGVtZSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKSwKCQkJdGhlbWVjbGFzcyAgPSAiIHVpLWJvZHktIiArIHRoZW1lLAoJCQltaW5pY2xhc3MgPSBvLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWZvY3VzZWRFbCwgY2xlYXJidG47CgoJCSQoICJsYWJlbFtmb3I9JyIgKyBpbnB1dC5hdHRyKCAiaWQiICkgKyAiJ10iICkuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IiApOwoKCQlmb2N1c2VkRWwgPSBpbnB1dC5hZGRDbGFzcygidWktaW5wdXQtdGV4dCB1aS1ib2R5LSIrIHRoZW1lICk7CgoJCS8vIFhYWDogVGVtcG9yYXJ5IHdvcmthcm91bmQgZm9yIGlzc3VlIDc4NSAoQXBwbGUgYnVnIDg5MTA1ODkpLgoJCS8vICAgICAgVHVybiBvZmYgYXV0b2NvcnJlY3QgYW5kIGF1dG9jb21wbGV0ZSBvbiBub24taU9TIDUgZGV2aWNlcwoJCS8vICAgICAgc2luY2UgdGhlIHBvcHVwIHRoZXkgdXNlIGNhbid0IGJlIGRpc21pc3NlZCBieSB0aGUgdXNlci4gTm90ZQoJCS8vICAgICAgdGhhdCB3ZSB0ZXN0IGZvciB0aGUgcHJlc2VuY2Ugb2YgdGhlIGZlYXR1cmUgYnkgbG9va2luZyBmb3IKCQkvLyAgICAgIHRoZSBhdXRvY29ycmVjdCBwcm9wZXJ0eSBvbiB0aGUgaW5wdXQgZWxlbWVudC4gV2UgY3VycmVudGx5CgkJLy8gICAgICBoYXZlIG5vIHRlc3QgZm9yIGlPUyA1IG9yIG5ld2VyIHNvIHdlJ3JlIHRlbXBvcmFyaWx5IHVzaW5nCgkJLy8gICAgICB0aGUgdG91Y2hPdmVyZmxvdyBzdXBwb3J0IGZsYWcgZm9yIGpRTSAxLjAuIFllcywgSSBmZWVsIGRpcnR5LiAtIGpibGFzCgkJaWYgKCB0eXBlb2YgaW5wdXRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmICEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb3JyZWN0IiwgIm9mZiIgKTsKCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKTsKCQl9CgoKCQkvLyJzZWFyY2giIGlucHV0IHdpZGdldAoJCWlmICggaW5wdXQuaXMoICJbdHlwZT0nc2VhcmNoJ10sOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgKSB7CgoJCQlmb2N1c2VkRWwgPSBpbnB1dC53cmFwKCAiPGRpdiBjbGFzcz0ndWktaW5wdXQtc2VhcmNoIHVpLXNoYWRvdy1pbnNldCB1aS1idG4tY29ybmVyLWFsbCB1aS1idG4tc2hhZG93IHVpLWljb24tc2VhcmNoZmllbGQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyArICInPjwvZGl2PiIgKS5wYXJlbnQoKTsKCQkJY2xlYXJidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyJyB0aXRsZT0nIiArIG8uY2xlYXJTZWFyY2hCdXR0b25UZXh0ICsgIic+IiArIG8uY2xlYXJTZWFyY2hCdXR0b25UZXh0ICsgIjwvYT4iICkKCQkJCS5iaW5kKCdjbGljaycsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpbnB1dAoJCQkJCQkudmFsKCAiIiApCgkJCQkJCS5mb2N1cygpCgkJCQkJCS50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCWNsZWFyYnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KQoJCQkJLmFwcGVuZFRvKCBmb2N1c2VkRWwgKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJaWNvbjogImRlbGV0ZSIsCgkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQlzaGFkb3c6IHRydWUsCgkJCQkJbWluaTogby5taW5pCgkJCQl9KTsKCgkJCWZ1bmN0aW9uIHRvZ2dsZUNsZWFyKCkgewoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQljbGVhcmJ0bi50b2dnbGVDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIsICFpbnB1dC52YWwoKSApOwoJCQkJfSwgMCk7CgkJCX0KCgkJCXRvZ2dsZUNsZWFyKCk7CgoJCQlpbnB1dC5iaW5kKCdwYXN0ZSBjdXQga2V5dXAgZm9jdXMgY2hhbmdlIGJsdXInLCB0b2dnbGVDbGVhcik7CgoJCX0gZWxzZSB7CgkJCWlucHV0LmFkZENsYXNzKCAidWktY29ybmVyLWFsbCB1aS1zaGFkb3ctaW5zZXQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyApOwoJCX0KCgkJaW5wdXQuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQlmb2N1c2VkRWwuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJsdXIoZnVuY3Rpb24oKXsKCQkJCWZvY3VzZWRFbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQkJLmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQkJaWYoIG8ucHJldmVudEZvY3VzWm9vbSApewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQkJfQoJCQl9KQoJCQkuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCWlmKCBvLnByZXZlbnRGb2N1c1pvb20gKXsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCgkJLy8gQXV0b2dyb3cKCQlpZiAoIGlucHV0LmlzKCAidGV4dGFyZWEiICkgKSB7CgkJCXZhciBleHRyYUxpbmVIZWlnaHQgPSAxNSwKCQkJCWtleXVwVGltZW91dEJ1ZmZlciA9IDEwMCwKCQkJCWtleXVwID0gZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHNjcm9sbEhlaWdodCA9IGlucHV0WyAwIF0uc2Nyb2xsSGVpZ2h0LAoJCQkJCQljbGllbnRIZWlnaHQgPSBpbnB1dFsgMCBdLmNsaWVudEhlaWdodDsKCgkJCQkJaWYgKCBjbGllbnRIZWlnaHQgPCBzY3JvbGxIZWlnaHQgKSB7CgkJCQkJCWlucHV0LmhlaWdodChzY3JvbGxIZWlnaHQgKyBleHRyYUxpbmVIZWlnaHQpOwoJCQkJCX0KCQkJCX0sCgkJCQlrZXl1cFRpbWVvdXQ7CgoJCQlpbnB1dC5rZXl1cChmdW5jdGlvbigpIHsKCQkJCWNsZWFyVGltZW91dCgga2V5dXBUaW1lb3V0ICk7CgkJCQlrZXl1cFRpbWVvdXQgPSBzZXRUaW1lb3V0KCBrZXl1cCwga2V5dXBUaW1lb3V0QnVmZmVyICk7CgkJCX0pOwoKCQkJLy8gYmluZGluZyB0byBwYWdlY2hhbmdlIGhlcmUgZW5zdXJlcyB0aGF0IGZvciBwYWdlcyBsb2FkZWQgdmlhCgkJCS8vIGFqYXggdGhlIGhlaWdodCBpcyByZWNhbGN1bGF0ZWQgd2l0aG91dCB1c2VyIGlucHV0CgkJCSQoIGRvY3VtZW50ICkub25lKCAicGFnZWNoYW5nZSIsIGtleXVwICk7CgoJCQkvLyBJc3N1ZSA1MDk6IHRoZSBicm93c2VyIGlzIG5vdCBwcm92aWRpbmcgc2Nyb2xsSGVpZ2h0IHByb3Blcmx5IHVudGlsIHRoZSBzdHlsZXMgbG9hZAoJCQlpZiAoICQudHJpbSggaW5wdXQudmFsKCkgKSApIHsKCQkJCS8vIGJpbmQgdG8gdGhlIHdpbmRvdyBsb2FkIHRvIG1ha2Ugc3VyZSB0aGUgaGVpZ2h0IGlzIGNhbGN1bGF0ZWQgYmFzZWQgb24gQk9USAoJCQkJLy8gdGhlIERPTSBhbmQgQ1NTCgkJCQkkKCB3aW5kb3cgKS5sb2FkKCBrZXl1cCApOwoJCQl9CgkJfQoJCWlmICggaW5wdXQuYXR0ciggImRpc2FibGVkIiApICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCl7CgoJCXZhciAkZWw7CgkJaWYgKCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApLmlzKCAiW3R5cGU9J3NlYXJjaCddLDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApICkgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgkJfSBlbHNlIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50OwoJCX0gCgkJJGVsLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJCQkKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpewoKCQl2YXIgJGVsOwoJCWlmICggdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICkuaXMoICJbdHlwZT0nc2VhcmNoJ10sOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgKSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsKCQl9IGVsc2UgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgkJfSAKCQkkZWwucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCQkKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUudGV4dGlucHV0LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyID0gZmFsc2U7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyID0gIkZpbHRlciBpdGVtcy4uLiI7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclRoZW1lID0gImMiOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCB0ZXh0LCBzZWFyY2hWYWx1ZSApewoJcmV0dXJuIHRleHQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCBzZWFyY2hWYWx1ZSApID09PSAtMTsKfTsKCiQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICJ1bCwgb2wiLCAibGlzdHZpZXdjcmVhdGUiLCBmdW5jdGlvbigpIHsKCgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggImxpc3R2aWV3IiApOwoKCWlmICggIWxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyICkgewoJCXJldHVybjsKCX0KCgl2YXIgd3JhcHBlciA9ICQoICI8Zm9ybT4iLCB7CgkJCSJjbGFzcyI6ICJ1aS1saXN0dmlldy1maWx0ZXIgdWktYmFyLSIgKyBsaXN0dmlldy5vcHRpb25zLmZpbHRlclRoZW1lLAoJCQkicm9sZSI6ICJzZWFyY2giCgkJfSksCgkJc2VhcmNoID0gJCggIjxpbnB1dD4iLCB7CgkJCXBsYWNlaG9sZGVyOiBsaXN0dmlldy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyCgkJfSkKCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGUiLCAic2VhcmNoIiApCgkJLmpxbURhdGEoICJsYXN0dmFsIiwgIiIgKQoJCS5iaW5kKCAia2V5dXAgY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpLAoJCQkJdmFsID0gdGhpcy52YWx1ZS50b0xvd2VyQ2FzZSgpLAoJCQkJbGlzdEl0ZW1zID0gbnVsbCwKCQkJCWxhc3R2YWwgPSAkdGhpcy5qcW1EYXRhKCAibGFzdHZhbCIgKSArICIiLAoJCQkJY2hpbGRJdGVtcyA9IGZhbHNlLAoJCQkJaXRlbXRleHQgPSAiIiwKCQkJCWl0ZW07CgoJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCSR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiAsIHZhbCApOwoJCQlpZiAoIHZhbC5sZW5ndGggPCBsYXN0dmFsLmxlbmd0aCB8fCB2YWwuaW5kZXhPZihsYXN0dmFsKSAhPT0gMCApIHsKCgkJCQkvLyBSZW1vdmVkIGNoYXJzIG9yIHBhc3RlZCBzb21ldGhpbmcgdG90YWxseSBkaWZmZXJlbnQsIGNoZWNrIGFsbCBpdGVtcwoJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbigpOwoJCQl9IGVsc2UgewoKCQkJCS8vIE9ubHkgY2hhcnMgYWRkZWQsIG5vdCByZW1vdmVkLCBvbmx5IHVzZSB2aXNpYmxlIHN1YnNldAoJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbiggIjpub3QoLnVpLXNjcmVlbi1oaWRkZW4pIiApOwoJCQl9CgoJCQlpZiAoIHZhbCApIHsKCgkJCQkvLyBUaGlzIGhhbmRsZXMgaGlkaW5nIHJlZ3VsYXIgcm93cyB3aXRob3V0IHRoZSB0ZXh0IHdlIHNlYXJjaCBmb3IKCQkJCS8vIGFuZCBhbnkgbGlzdCBkaXZpZGVycyB3aXRob3V0IHJlZ3VsYXIgcm93cyBzaG93biB1bmRlciBpdAoKCQkJCWZvciAoIHZhciBpID0gbGlzdEl0ZW1zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoJCQkJCWl0ZW0gPSAkKCBsaXN0SXRlbXNbIGkgXSApOwoJCQkJCWl0ZW10ZXh0ID0gaXRlbS5qcW1EYXRhKCAiZmlsdGVydGV4dCIgKSB8fCBpdGVtLnRleHQoKTsKCgkJCQkJaWYgKCBpdGVtLmlzKCAibGk6anFtRGF0YShyb2xlPWxpc3QtZGl2aWRlcikiICkgKSB7CgoJCQkJCQlpdGVtLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIgLCAhY2hpbGRJdGVtcyApOwoKCQkJCQkJLy8gTmV3IGJ1Y2tldCEKCQkJCQkJY2hpbGRJdGVtcyA9IGZhbHNlOwoKCQkJCQl9IGVsc2UgaWYgKCBsaXN0dmlldy5vcHRpb25zLmZpbHRlckNhbGxiYWNrKCBpdGVtdGV4dCwgdmFsICkgKSB7CgoJCQkJCQkvL21hcmsgdG8gYmUgaGlkZGVuCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsIHRydWUgKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy8gVGhlcmUncyBhIHNob3duIGl0ZW0gaW4gdGhlIGJ1Y2tldAoJCQkJCQljaGlsZEl0ZW1zID0gdHJ1ZTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gU2hvdyBpdGVtcywgbm90IG1hcmtlZCB0byBiZSBoaWRkZW4KCQkJCWxpc3RJdGVtcwoJCQkJCS5maWx0ZXIoICI6bm90KC51aS1maWx0ZXItaGlkZXF1ZXVlKSIgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBmYWxzZSApOwoKCQkJCS8vIEhpZGUgaXRlbXMsIG1hcmtlZCB0byBiZSBoaWRkZW4KCQkJCWxpc3RJdGVtcwoJCQkJCS5maWx0ZXIoICIudWktZmlsdGVyLWhpZGVxdWV1ZSIgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCB0cnVlICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiwgZmFsc2UgKTsKCgkJCX0gZWxzZSB7CgoJCQkJLy9maWx0ZXJ2YWx1ZSBpcyBlbXB0eSA9PiBzaG93IGFsbAoJCQkJbGlzdEl0ZW1zLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgkJCX0KCQkJbGlzdHZpZXcuX3JlZnJlc2hDb3JuZXJzKCk7CgkJfSkKCQkuYXBwZW5kVG8oIHdyYXBwZXIgKQoJCS50ZXh0aW5wdXQoKTsKCglpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuaW5zZXQgKSB7CgkJd3JhcHBlci5hZGRDbGFzcyggInVpLWxpc3R2aWV3LWZpbHRlci1pbnNldCIgKTsKCX0KCgl3cmFwcGVyLmJpbmQoICJzdWJtaXQiLCBmdW5jdGlvbigpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9KQoJLmluc2VydEJlZm9yZSggbGlzdCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCiggZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCXRyYWNrVGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3JhbmdlJ10sIDpqcW1EYXRhKHR5cGU9J3JhbmdlJyksIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gVE9ETzogRWFjaCBvZiB0aGVzZSBzaG91bGQgaGF2ZSBjb21tZW50cyBleHBsYWluIHdoYXQgdGhleSdyZSBmb3IKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggY29udHJvbCwgImMiICksCgoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCBwYXJlbnRUaGVtZSwKCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgoJCQlzZWxlY3RDbGFzcyA9ICggY1R5cGUgPT0gInNlbGVjdCIgKSA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICIiLAoKCQkJY29udHJvbElEID0gY29udHJvbC5hdHRyKCAiaWQiICksCgoJCQkkbGFiZWwgPSAkKCAiW2Zvcj0nIiArIGNvbnRyb2xJRCArICInXSIgKSwKCgkJCWxhYmVsSUQgPSAkbGFiZWwuYXR0ciggImlkIiApIHx8IGNvbnRyb2xJRCArICItbGFiZWwiLAoKCQkJbGFiZWwgPSAkbGFiZWwuYXR0ciggImlkIiwgbGFiZWxJRCApLAoKCQkJdmFsID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIGNUeXBlID09ICJpbnB1dCIgID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9LAoKCQkJbWluID0gIGNUeXBlID09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgoJCQltYXggPSAgY1R5cGUgPT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aC0xLAoKCQkJc3RlcCA9IHdpbmRvdy5wYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApIHx8IDEgKSwKCgkJCWlubGluZUNsYXNzID0gKCB0aGlzLm9wdGlvbnMuaW5saW5lIHx8IGNvbnRyb2wuanFtRGF0YSgiaW5saW5lIikgPT0gdHJ1ZSApID8gIiB1aS1zbGlkZXItaW5saW5lIiA6ICIiLAoKCQkJbWluaUNsYXNzID0gKCB0aGlzLm9wdGlvbnMubWluaSB8fCBjb250cm9sLmpxbURhdGEoIm1pbmkiKSApID8gIiB1aS1zbGlkZXItbWluaSIgOiAiIiwKCgoJCQlkb21IYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKCQkJc2xpZGVyID0gJCggZG9tU2xpZGVyICksCgoJCQl2YWx1ZWJnID0gY29udHJvbC5qcW1EYXRhKCJoaWdobGlnaHQiKSAmJiBjVHlwZSAhPSAic2VsZWN0IiA/IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQkJYmcuY2xhc3NOYW1lID0gJ3VpLXNsaWRlci1iZyAnICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKyAnIHVpLWJ0bi1jb3JuZXItYWxsJzsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0pKCkgOiBmYWxzZSwKCgkJCW9wdGlvbnM7CgoJCXRoaXMuX3R5cGUgPSBjVHlwZTsKCgkJZG9tSGFuZGxlLnNldEF0dHJpYnV0ZSggJ2hyZWYnLCAiIyIgKTsKCQlkb21TbGlkZXIuc2V0QXR0cmlidXRlKCdyb2xlJywnYXBwbGljYXRpb24nKTsKCQlkb21TbGlkZXIuY2xhc3NOYW1lID0gWyd1aS1zbGlkZXIgJyxzZWxlY3RDbGFzcywiIHVpLWJ0bi1kb3duLSIsdHJhY2tUaGVtZSwnIHVpLWJ0bi1jb3JuZXItYWxsJywgaW5saW5lQ2xhc3MsIG1pbmlDbGFzc10uam9pbigiIik7CgkJZG9tSGFuZGxlLmNsYXNzTmFtZSA9ICd1aS1zbGlkZXItaGFuZGxlJzsKCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoZG9tSGFuZGxlKTsKCgkJaGFuZGxlLmJ1dHRvbk1hcmt1cCh7IGNvcm5lcnM6IHRydWUsIHRoZW1lOiB0aGVtZSwgc2hhZG93OiB0cnVlIH0pCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAic2xpZGVyIiwKCQkJCQkiYXJpYS12YWx1ZW1pbiI6IG1pbiwKCQkJCQkiYXJpYS12YWx1ZW1heCI6IG1heCwKCQkJCQkiYXJpYS12YWx1ZW5vdyI6IHZhbCgpLAoJCQkJCSJhcmlhLXZhbHVldGV4dCI6IHZhbCgpLAoJCQkJCSJ0aXRsZSI6IHZhbCgpLAoJCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBsYWJlbElECgkJCQl9KTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJc2xpZGVyOiBzbGlkZXIsCgkJCWhhbmRsZTogaGFuZGxlLAoJCQl2YWx1ZWJnOiB2YWx1ZWJnLAoJCQlkcmFnZ2luZzogZmFsc2UsCgkJCWJlZm9yZVN0YXJ0OiBudWxsLAoJCQl1c2VyTW9kaWZpZWQ6IGZhbHNlLAoJCQltb3VzZU1vdmVkOiBmYWxzZQoJCX0pOwoKCQlpZiAoIGNUeXBlID09ICJzZWxlY3QiICkgewoJCQl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICd1aS1zbGlkZXItaW5uZXJvZmZzZXQnOwoKCQkJZm9yKHZhciBqID0gMCxsZW5ndGggPSBkb21TbGlkZXIuY2hpbGROb2Rlcy5sZW5ndGg7aiA8IGxlbmd0aDtqKyspewoJCQkJd3JhcHBlci5hcHBlbmRDaGlsZChkb21TbGlkZXIuY2hpbGROb2Rlc1tqXSk7CgkJCX0KCgkJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCh3cmFwcGVyKTsKCgkJCS8vIHNsaWRlci53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXItaW5uZXJvZmZzZXQnPjwvZGl2PiIgKTsKCgkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJb3B0aW9ucyA9IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCgkJCWZvcih2YXIgaSA9IDAsIG9wdGlvbnNDb3VudCA9IG9wdGlvbnMubGVuZ3RoOyBpIDwgb3B0aW9uc0NvdW50OyBpKyspewoJCQkJdmFyIHNpZGUgPSAhaSA/ICJiIjoiYSIsCgkJCQkJc2xpZGVyVGhlbWUgPSAhaSA/ICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgOiggIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKSwKCQkJCQlzbGlkZXJMYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAoJCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKCgkJCQlzbGlkZXJJbWcuY2xhc3NOYW1lID0gWyd1aS1zbGlkZXItbGFiZWwgdWktc2xpZGVyLWxhYmVsLScsc2lkZSxzbGlkZXJUaGVtZSwiIHVpLWJ0bi1jb3JuZXItYWxsIl0uam9pbigiIik7CgkJCQlzbGlkZXJJbWcuc2V0QXR0cmlidXRlKCdyb2xlJywnaW1nJyk7CgkJCQlzbGlkZXJJbWcuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUob3B0aW9uc1tpXS5pbm5lckhUTUwpKTsKCQkJCSQoc2xpZGVySW1nKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9CgoJCQlzZWxmLl9sYWJlbHMgPSAkKCAiLnVpLXNsaWRlci1sYWJlbCIsIHNsaWRlciApOwoKCQl9CgoJCWxhYmVsLmFkZENsYXNzKCAidWktc2xpZGVyIiApOwoKCQkvLyBtb25pdG9yIHRoZSBpbnB1dCBmb3IgdXBkYXRlZCB2YWx1ZXMKCQljb250cm9sLmFkZENsYXNzKCBjVHlwZSA9PT0gImlucHV0IiA/ICJ1aS1zbGlkZXItaW5wdXQiIDogInVpLXNsaWRlci1zd2l0Y2giICkKCQkJLmNoYW5nZSggZnVuY3Rpb24oKSB7CgkJCQkvLyBpZiB0aGUgdXNlciBkcmFnZ2VkIHRoZSBoYW5kbGUsIHRoZSAiY2hhbmdlIiBldmVudCB3YXMgdHJpZ2dlcmVkIGZyb20gaW5zaWRlIHJlZnJlc2goKTsgZG9uJ3QgY2FsbCByZWZyZXNoKCkgYWdhaW4KCQkJCWlmICghc2VsZi5tb3VzZU1vdmVkKSB7CgkJCQkJc2VsZi5yZWZyZXNoKCB2YWwoKSwgdHJ1ZSApOwoJCQkJfQoJCQl9KQoJCQkua2V5dXAoIGZ1bmN0aW9uKCkgeyAvLyBuZWNlc3Nhcnk/CgkJCQlzZWxmLnJlZnJlc2goIHZhbCgpLCB0cnVlLCB0cnVlICk7CgkJCX0pCgkJCS5ibHVyKCBmdW5jdGlvbigpIHsKCQkJCXNlbGYucmVmcmVzaCggdmFsKCksIHRydWUgKTsKCQkJfSk7CgoJCS8vIHByZXZlbnQgc2NyZWVuIGRyYWcgd2hlbiBzbGlkZXIgYWN0aXZhdGVkCgkJJCggZG9jdW1lbnQgKS5iaW5kKCAidm1vdXNlbW92ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHNlbGYuZHJhZ2dpbmcgJiYgIXNlbGYub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCS8vIHNlbGYubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJc2VsZi5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IiApIHsKCQkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSBpbiBzeW5jIHdpdGggdGhlIG1vdXNlCgkJCQkJaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCgkJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgc2VsZi51c2VyTW9kaWZpZWQKCQkJCXNlbGYudXNlck1vZGlmaWVkID0gc2VsZi5iZWZvcmVTdGFydCAhPT0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7CgoJCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJCS8vIHJhbmdlL251bWJlciBpbnB1dHMgZG9lc24ndCB0cmlnZ2VyIGEgY2hhbmdlIHVudGlsIHRoZSBmaWVsZCBpcwoJCS8vIGJsdXJyZWQuIEhlcmUgd2UgY2hlY2sgdGhpZiB0aGUgdmFsdWUgaGFzIGNoYW5nZWQgYW5kIHJlZnJlc2gKCQljb250cm9sLmJpbmQoICJ2bW91c2V1cCIsICQucHJveHkoIHNlbGYuX2NoZWNrZWRSZWZyZXNoLCBzZWxmKSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJc2VsZi5kcmFnZ2luZyA9IHRydWU7CgkJCXNlbGYudXNlck1vZGlmaWVkID0gZmFsc2U7CgkJCXNlbGYubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIgKSB7CgkJCQlzZWxmLmJlZm9yZVN0YXJ0ID0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgoJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9KQoJCS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJc2xpZGVyLmFkZCggZG9jdW1lbnQgKQoJCQkuYmluZCggInZtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuZHJhZ2dpbmcgKSB7CgoJCQkJCXNlbGYuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIpIHsKCgkJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJCQkJaWYgKCBzZWxmLm1vdXNlTW92ZWQgKSB7CgoJCQkJCQkJLy8gdGhpcyBpcyBhIGRyYWcsIGNoYW5nZSB0aGUgdmFsdWUgb25seSBpZiB1c2VyIGRyYWdnZWQgZW5vdWdoCgkJCQkJCQlpZiAoIHNlbGYudXNlck1vZGlmaWVkICkgewoJCQkJCQkJCXNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCA9PSAwID8gMSA6IDAgKTsKCQkJCQkJCX0KCQkJCQkJCWVsc2UgewoJCQkJCQkJCXNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCApOwoJCQkJCQkJfQoKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJCS8vIHRoaXMgaXMganVzdCBhIGNsaWNrLCBjaGFuZ2UgdGhlIHZhbHVlCgkJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgPT0gMCA/IDEgOiAwICk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlzZWxmLm1vdXNlTW92ZWQgPSBmYWxzZTsKCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9KTsKCgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIE9ubHkgYWRkIGZvY3VzIGNsYXNzIHRvIHRvZ2dsZSBzd2l0Y2gsIHNsaWRlcnMgZ2V0IGl0IGF1dG9tYXRpY2FsbHkgZnJvbSB1aS1idG4KCQlpZiggY1R5cGUgPT0gJ3NlbGVjdCcgKSB7CgkJCXRoaXMuaGFuZGxlLmJpbmQoewoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCXNsaWRlci5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfSwKCgkJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCQlzbGlkZXIucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQl0aGlzLmhhbmRsZS5iaW5kKHsKCQkJLy8gTk9URSBmb3JjZSBmb2N1cyBvbiBoYW5kbGUKCQkJdm1vdXNlZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuZm9jdXMoKTsKCQkJfSwKCgkJCXZjbGljazogZmFsc2UsCgoJCQlrZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl2YXIgaW5kZXggPSB2YWwoKTsKCgkJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gSW4gYWxsIGNhc2VzIHByZXZlbnQgdGhlIGRlZmF1bHQgYW5kIG1hcmsgdGhlIGhhbmRsZSBhcyBhY3RpdmUKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJCQlpZiAoICFzZWxmLl9rZXlTbGlkaW5nICkgewoJCQkJCQkJc2VsZi5fa2V5U2xpZGluZyA9IHRydWU7CgkJCQkJCQkkKCB0aGlzICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJLy8gbW92ZSB0aGUgc2xpZGVyIGFjY29yZGluZyB0byB0aGUga2V5cHJlc3MKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQkJCXNlbGYucmVmcmVzaCggbWluICk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQkJCXNlbGYucmVmcmVzaCggbWF4ICk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCQkJCXNlbGYucmVmcmVzaCggaW5kZXggKyBzdGVwICk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQkJCXNlbGYucmVmcmVzaCggaW5kZXggLSBzdGVwICk7CgkJCQkJCWJyZWFrOwoJCQkJfQoJCQl9LCAvLyByZW1vdmUgYWN0aXZlIG1hcmsKCgkJCWtleXVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIHNlbGYuX2tleVNsaWRpbmcgKSB7CgkJCQkJc2VsZi5fa2V5U2xpZGluZyA9IGZhbHNlOwoJCQkJCSQoIHRoaXMgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCX0KCQkJfQoJCQl9KTsKCgkJdGhpcy5yZWZyZXNoKHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB0cnVlKTsKCX0sCgoJX2NoZWNrZWRSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiggdGhpcy52YWx1ZSAhPSB0aGlzLl92YWx1ZSgpICl7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSApOwoJCQl0aGlzLnZhbHVlID0gdGhpcy5fdmFsdWUoKTsKCQl9Cgl9LAoKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICB0aGlzLl90eXBlID09PSAiaW5wdXQiID8KCQkJcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LnZhbCgpICkgOiB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIHZhbCwgaXNmcm9tQ29udHJvbCwgcHJldmVudElucHV0VXBkYXRlICkgewoKCQkvLyBOT1RFOiB3ZSBkb24ndCByZXR1cm4gaGVyZSBiZWNhdXNlIHdlIHdhbnQgdG8gc3VwcG9ydCBwcm9ncmFtbWF0aWMKCQkvLyAgICAgICBhbHRlcmF0aW9uIG9mIHRoZSBpbnB1dCB2YWx1ZSwgd2hpY2ggc2hvdWxkIHN0aWxsIHVwZGF0ZSB0aGUgc2xpZGVyCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoJ2Rpc2FibGVkJykpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQl2YXIgY29udHJvbCA9IHRoaXMuZWxlbWVudCwgcGVyY2VudCwKCQkJY1R5cGUgPSBjb250cm9sWzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCW1pbiA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aCAtIDEsCgkJCXN0ZXAgPSAoY1R5cGUgPT09ICJpbnB1dCIgJiYgcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApID4gMCkgPyBwYXJzZUZsb2F0KGNvbnRyb2wuYXR0cigic3RlcCIpKSA6IDE7CgoJCWlmICggdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgKSB7CgkJCXZhciBkYXRhID0gdmFsLAoJCQkJLy8gYSBzbGlnaHQgdG9sZXJhbmNlIGhlbHBlZCBnZXQgdG8gdGhlIGVuZHMgb2YgdGhlIHNsaWRlcgoJCQkJdG9sID0gODsKCQkJaWYgKCAhdGhpcy5kcmFnZ2luZyB8fAoJCQkJCWRhdGEucGFnZVggPCB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0IC0gdG9sIHx8CgkJCQkJZGF0YS5wYWdlWCA+IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgKyB0aGlzLnNsaWRlci53aWR0aCgpICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXBlcmNlbnQgPSBNYXRoLnJvdW5kKCAoICggZGF0YS5wYWdlWCAtIHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKSAqIDEwMCApOwoJCX0gZWxzZSB7CgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCXZhciBuZXd2YWwgPSAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKyBtaW47CgoJCS8vZnJvbSBqUXVlcnkgVUkgc2xpZGVyLCB0aGUgZm9sbG93aW5nIHNvdXJjZSB3aWxsIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXAKCQl2YXIgdmFsTW9kU3RlcCA9ICggbmV3dmFsIC0gbWluICkgJSBzdGVwOwoJCXZhciBhbGlnblZhbHVlID0gbmV3dmFsIC0gdmFsTW9kU3RlcDsKCgkJaWYgKCBNYXRoLmFicyggdmFsTW9kU3RlcCApICogMiA+PSBzdGVwICkgewoJCQlhbGlnblZhbHVlICs9ICggdmFsTW9kU3RlcCA+IDAgKSA/IHN0ZXAgOiAoIC1zdGVwICk7CgkJfQoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZAoJCS8vIHRoZSBmaW5hbCB2YWx1ZSB0byA1IGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbCBwb2ludCAoc2VlIGpRdWVyeVVJOiAjNDEyNCkKCQluZXd2YWwgPSBwYXJzZUZsb2F0KCBhbGlnblZhbHVlLnRvRml4ZWQoNSkgKTsKCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQl0aGlzLmhhbmRsZS5jc3MoICJsZWZ0IiwgcGVyY2VudCArICIlIiApOwoJCXRoaXMuaGFuZGxlLmF0dHIoIHsKCQkJCSJhcmlhLXZhbHVlbm93IjogY1R5cGUgPT09ICJpbnB1dCIgPyBuZXd2YWwgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSwKCQkJCSJhcmlhLXZhbHVldGV4dCI6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpLAoJCQkJdGl0bGU6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpCgkJCX0pOwoJCXRoaXMudmFsdWViZyAmJiB0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgoJCS8vIGRyYWcgdGhlIGxhYmVsIHdpZHRocwoJCWlmICggdGhpcy5fbGFiZWxzICkgewoJCQl2YXIgaGFuZGxlUGVyY2VudCA9IHRoaXMuaGFuZGxlLndpZHRoKCkgLyB0aGlzLnNsaWRlci53aWR0aCgpICogMTAwLAoJCQkJYVBlcmNlbnQgPSBwZXJjZW50ICYmIGhhbmRsZVBlcmNlbnQgKyAoIDEwMCAtIGhhbmRsZVBlcmNlbnQgKSAqIHBlcmNlbnQgLyAxMDAsCgkJCQliUGVyY2VudCA9IHBlcmNlbnQgPT09IDEwMCA/IDAgOiBNYXRoLm1pbiggaGFuZGxlUGVyY2VudCArIDEwMCAtIGFQZXJjZW50LCAxMDAgKTsKCgkJCXRoaXMuX2xhYmVscy5lYWNoKGZ1bmN0aW9uKCl7CgkJCQl2YXIgYWIgPSAkKHRoaXMpLmlzKCAiLnVpLXNsaWRlci1sYWJlbC1hIiApOwoJCQkJJCggdGhpcyApLndpZHRoKCAoIGFiID8gYVBlcmNlbnQgOiBiUGVyY2VudCAgKSArICIlIiApOwoJCQl9KTsKCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFyIHZhbHVlQ2hhbmdlZCA9IGZhbHNlOwoKCQkJLy8gdXBkYXRlIGNvbnRyb2wicyB2YWx1ZQoJCQlpZiAoIGNUeXBlID09PSAiaW5wdXQiICkgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbC52YWwoKSAhPT0gbmV3dmFsOwoJCQkJY29udHJvbC52YWwoIG5ld3ZhbCApOwoJCQl9IGVsc2UgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ID0gbmV3dmFsOwoJCQl9CgkJCWlmICggIWlzZnJvbUNvbnRyb2wgJiYgdmFsdWVDaGFuZ2VkICkgewoJCQkJY29udHJvbC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCXRoaXMuc2xpZGVyLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCBmYWxzZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJdGhpcy5zbGlkZXIuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9Cgp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5zbGlkZXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zZWxlY3RtZW51IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWljb246ICJhcnJvdy1kIiwKCQlpY29ucG9zOiAicmlnaHQiLAoJCWlubGluZTogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpKSIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCiAgX3NlbGVjdE9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7CiAgfSwKCgkvLyBzZXR1cCBpdGVtcyB0aGF0IGFyZSBnZW5lcmFsbHkgbmVjZXNzYXJ5IGZvciBzZWxlY3QgbWVudSBleHRlbnNpb24KCV9wcmVFeHRlbnNpb246IGZ1bmN0aW9uKCl7CgkJdmFyIGNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYoICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gICIgdWktYnRuLWxlZnQiOwoJCX0KCgkJaWYoICAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tcmlnaHQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1yaWdodCI7CgkJfQoKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0IiArIGNsYXNzZXMgKyAiJz4iICk7CgkJdGhpcy5zZWxlY3RJRCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICk7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SUQgKyInXSIgKS5hZGRDbGFzcyggInVpLXNlbGVjdCIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuc2VsZWN0LCAiYyIgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKIAkJLy8gQWxsb3dzIGZvciBleHRlbnNpb24gb2YgdGhlIG5hdGl2ZSBzZWxlY3QgZm9yIGN1c3RvbSBzZWxlY3RzIGFuZCBvdGhlciBwbHVnaW5zCgkJLy8gc2VlIHNlbGVjdC5jdXN0b20gZm9yIGV4YW1wbGUgZXh0ZW5zaW9uCgkJLy8gVE9ETyBleHBsb3JlIHBsdWdpbiByZWdpc3RyYXRpb24KCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlQ3JlYXRlIiApOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJaW5saW5lID0gb3B0aW9ucy5pbmxpbmUgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggImlubGluZSIgKSwKCQkJbWluaSA9IG9wdGlvbnMubWluaSB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAibWluaSIgKSwJCQkKCQkJaWNvbnBvcyA9IG9wdGlvbnMuaWNvbiA/ICggb3B0aW9ucy5pY29ucG9zIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpY29ucG9zIiApICkgOiBmYWxzZSwKCgkJCS8vIElFIHRocm93cyBhbiBleGNlcHRpb24gYXQgb3B0aW9ucy5pdGVtKCkgZnVuY3Rpb24gd2hlbgoJCQkvLyB0aGVyZSBpcyBubyBzZWxlY3RlZCBpdGVtCgkJCS8vIHNlbGVjdCBmaXJzdCBpbiB0aGlzIGNhc2UKCQkJc2VsZWN0ZWRJbmRleCA9IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCA9PSAtMSA/IDAgOiB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgoJCQkvLyBUT0RPIHZhbHVlcyBidXR0b25JZCBhbmQgbWVudUlkIGFyZSB1bmRlZmluZWQgaGVyZQoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmJ1dHRvbk1hcmt1cCggewoJCQkJCXRoZW1lOiBvcHRpb25zLnRoZW1lLAoJCQkJCWljb246IG9wdGlvbnMuaWNvbiwKCQkJCQlpY29ucG9zOiBpY29ucG9zLAoJCQkJCWlubGluZTogaW5saW5lLAoJCQkJCWNvcm5lcnM6IG9wdGlvbnMuY29ybmVycywKCQkJCQlzaGFkb3c6IG9wdGlvbnMuc2hhZG93LAoJCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdywKCQkJCQltaW5pOiBtaW5pCgkJCQl9KTsKCgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJYnV0dG9uLmFkZENsYXNzKCAidWktc2VsZWN0LW5hdGl2ZW9ubHkiICk7CgkJfQkKCgkJLy8gQWRkIGNvdW50ZXIgZm9yIG11bHRpIHNlbGVjdHMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudCA9ICQoICI8c3Bhbj4iICkKCQkJCS5hZGRDbGFzcyggInVpLWxpLWNvdW50IHVpLWJ0bi11cC1jIHVpLWJ0bi1jb3JuZXItYWxsIiApCgkJCQkuaGlkZSgpCgkJCQkuYXBwZW5kVG8oIGJ1dHRvbi5hZGRDbGFzcygndWktbGktaGFzLWNvdW50JykgKTsKCQl9CgoJCS8vIERpc2FibGUgaWYgc3BlY2lmaWVkCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCdkaXNhYmxlZCcpKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gRXZlbnRzIG9uIG5hdGl2ZSBzZWxlY3QKCQl0aGlzLnNlbGVjdC5jaGFuZ2UoIGZ1bmN0aW9uKCkgewoJCQlzZWxmLnJlZnJlc2goKTsKCQl9KTsKCgkJdGhpcy5idWlsZCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLnNlbGVjdAoJCQkuYXBwZW5kVG8oIHNlbGYuYnV0dG9uICkKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBBZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCiAgICAgICAgICAgIC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKICAgICAgICAgICAgfSkKCQkJLmJpbmQoICJmb2N1cyB2bW91c2VvdmVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCQkJfSkKCQkJLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBSZW1vdmUgYWN0aXZlIGNsYXNzIG9uIHNjcm9sbC90b3VjaG1vdmUKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIHZtb3VzZW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW91dCIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCX0pOwoKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQlzZWxmLmJ1dHRvbi5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5sYWJlbC5iaW5kKCAiY2xpY2sgZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuc2VsZWN0LmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5idXR0b24uYmluZCggIm1vdXNldXAiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsJCQkJCgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9LCAwICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewkJCQkKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5pbmRleCggdGhpcyApOwoJCX0pLmdldCgpOwoJfSwKCglzZXRCdXR0b25UZXh0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpLAoJCQl0ZXh0ID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJc3BhbiA9ICQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKSApOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLmh0bWwoZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZWN0ZWQubGVuZ3RoICkgewoJCQkJdGV4dCA9IHNlbGVjdGVkLm1hcChmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gJCggdGhpcyApLnRleHQoKTsKCQkJCX0pLmdldCgpLmpvaW4oICIsICIgKTsKCQkJfSBlbHNlIHsKCQkJCXRleHQgPSBzZWxmLnBsYWNlaG9sZGVyOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4udGV4dCggdGV4dCApCgkJCQkuYWRkQ2xhc3MoIHNlbGYuc2VsZWN0LmF0dHIoImNsYXNzIikgKQoJCQkJLmFkZENsYXNzKCBzZWxlY3RlZC5hdHRyKCJjbGFzcyIpICk7CgkJfSk7Cgl9LAoKCXNldEJ1dHRvbkNvdW50OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCk7CgoJCS8vIG11bHRpcGxlIGNvdW50IGluc2lkZSBidXR0b24KCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudFsgc2VsZWN0ZWQubGVuZ3RoID4gMSA/ICJzaG93IiA6ICJoaWRlIiBdKCkudGV4dCggc2VsZWN0ZWQubGVuZ3RoICk7CgkJfQoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCQl0aGlzLnNldEJ1dHRvbkNvdW50KCk7Cgl9LAoKCS8vIG9wZW4gYW5kIGNsb3NlIHByZXNlcnZlZCBpbiBuYXRpdmUgc2VsZWN0cwoJLy8gdG8gc2ltcGxpZnkgdXNlcnMgY29kZSB3aGVuIGxvb3Bpbmcgb3ZlciBzZWxlY3RzCglvcGVuOiAkLm5vb3AsCgljbG9zZTogJC5ub29wLAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCB0cnVlICk7CgkJdGhpcy5idXR0b24uYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggZmFsc2UgKTsKCQl0aGlzLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5zZWxlY3RtZW51LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKfSkoIGpRdWVyeSApOwoKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgZXh0ZW5kU2VsZWN0ID0gZnVuY3Rpb24oIHdpZGdldCApewoKCQl2YXIgc2VsZWN0ID0gd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQgID0gd2lkZ2V0LnNlbGVjdElELAoJCQlsYWJlbCA9IHdpZGdldC5sYWJlbCwKCQkJdGhpc1BhZ2UgPSB3aWRnZXQuc2VsZWN0LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJc2NyZWVuID0gJCggIjxkaXY+IiwgeyJjbGFzcyI6ICJ1aS1zZWxlY3RtZW51LXNjcmVlbiB1aS1zY3JlZW4taGlkZGVuIn0gKS5hcHBlbmRUbyggdGhpc1BhZ2UgKSwKCQkJc2VsZWN0T3B0aW9ucyA9IHdpZGdldC5fc2VsZWN0T3B0aW9ucygpLAoJCQlpc011bHRpcGxlID0gd2lkZ2V0LmlzTXVsdGlwbGUgPSB3aWRnZXQuc2VsZWN0WyAwIF0ubXVsdGlwbGUsCgkJCWJ1dHRvbklkID0gc2VsZWN0SUQgKyAiLWJ1dHRvbiIsCgkJCW1lbnVJZCA9IHNlbGVjdElEICsgIi1tZW51IiwKCQkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGRhdGEtIiArJC5tb2JpbGUubnMgKyAidGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLnRoZW1lICsiJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgIm92ZXJsYXktdGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArIic+IiArCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgbGFiZWwuZ2V0RW5jb2RlZFRleHQoKSArICI8L2Rpdj4iKwoJCQkJIjwvZGl2PiIrCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkJIjwvZGl2PiIgKSwKCgkJCWxpc3Rib3ggPSAgJCgiPGRpdj4iLCB7ICJjbGFzcyI6ICJ1aS1zZWxlY3RtZW51IHVpLXNlbGVjdG1lbnUtaGlkZGVuIHVpLW92ZXJsYXktc2hhZG93IHVpLWNvcm5lci1hbGwgdWktYm9keS0iICsgd2lkZ2V0Lm9wdGlvbnMub3ZlcmxheVRoZW1lICsgIiAiICsgJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gfSApLmluc2VydEFmdGVyKHNjcmVlbiksCgoJCQlsaXN0ID0gJCggIjx1bD4iLCB7CgkJCQkiY2xhc3MiOiAidWktc2VsZWN0bWVudS1saXN0IiwKCQkJCSJpZCI6IG1lbnVJZCwKCQkJCSJyb2xlIjogImxpc3Rib3giLAoJCQkJImFyaWEtbGFiZWxsZWRieSI6IGJ1dHRvbklkCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIsIHdpZGdldC5vcHRpb25zLnRoZW1lICkuYXBwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlciA9ICQoICI8ZGl2PiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS1oZWFkZXIgdWktYmFyLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZQoJCQl9KS5wcmVwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlclRpdGxlID0gJCggIjxoMT4iLCB7CgkJCQkiY2xhc3MiOiAidWktdGl0bGUiCgkJCX0pLmFwcGVuZFRvKCBoZWFkZXIgKSwKCgkJCW1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZSwKCQkJaGVhZGVyQ2xvc2U7CgoJCWlmKCB3aWRnZXQuaXNNdWx0aXBsZSApIHsKCQkJaGVhZGVyQ2xvc2UgPSAkKCAiPGE+IiwgewoJCQkJInRleHQiOiB3aWRnZXQub3B0aW9ucy5jbG9zZVRleHQsCgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJjbGFzcyI6ICJ1aS1idG4tbGVmdCIKCQkJfSkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3MiLCAibm90ZXh0IiApLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uIiwgImRlbGV0ZSIgKS5hcHBlbmRUbyggaGVhZGVyICkuYnV0dG9uTWFya3VwKCk7CgkJfQoKCQkkLmV4dGVuZCggd2lkZ2V0LCB7CgkJCXNlbGVjdDogd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQ6IHNlbGVjdElELAoJCQlidXR0b25JZDogYnV0dG9uSWQsCgkJCW1lbnVJZDogbWVudUlkLAoJCQl0aGlzUGFnZTogdGhpc1BhZ2UsCgkJCW1lbnVQYWdlOiBtZW51UGFnZSwKCQkJbGFiZWw6IGxhYmVsLAoJCQlzY3JlZW46IHNjcmVlbiwKCQkJc2VsZWN0T3B0aW9uczogc2VsZWN0T3B0aW9ucywKCQkJaXNNdWx0aXBsZTogaXNNdWx0aXBsZSwKCQkJdGhlbWU6IHdpZGdldC5vcHRpb25zLnRoZW1lLAoJCQlsaXN0Ym94OiBsaXN0Ym94LAoJCQlsaXN0OiBsaXN0LAoJCQloZWFkZXI6IGhlYWRlciwKCQkJaGVhZGVyVGl0bGU6IGhlYWRlclRpdGxlLAoJCQloZWFkZXJDbG9zZTogaGVhZGVyQ2xvc2UsCgkJCW1lbnVQYWdlQ29udGVudDogbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlOiBtZW51UGFnZUNsb3NlLAoJCQlwbGFjZWhvbGRlcjogIiIsCgoJCQlidWlsZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJLy8gQ3JlYXRlIGxpc3QgZnJvbSBzZWxlY3QsIHVwZGF0ZSBzdGF0ZQoJCQkJc2VsZi5yZWZyZXNoKCk7CgoJCQkJc2VsZi5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgIi0xIiApLmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQkJCX0pOwoKCQkJCS8vIEJ1dHRvbiBldmVudHMKCQkJCXNlbGYuYnV0dG9uLmJpbmQoICJ2Y2xpY2sga2V5ZG93biIgLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBldmVudC50eXBlID09ICJ2Y2xpY2siIHx8CgkJCQkJCQkgZXZlbnQua2V5Q29kZSAmJiAoIGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRU5URVIgfHwKCQkJCQkJCQkJCQkJCQkJCQlldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFICkgKSB7CgoJCQkJCQlzZWxmLm9wZW4oKTsKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQkJCXNlbGYubGlzdC5hdHRyKCAicm9sZSIsICJsaXN0Ym94IiApCgkJCQkJLmJpbmQoICJmb2N1c2luIiwgZnVuY3Rpb24oIGUgKXsKCQkJCQkJJCggZS50YXJnZXQgKQoJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCQkJCQkudHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgoJCQkJCX0pCgkJCQkJLmJpbmQoICJmb2N1c291dCIsIGZ1bmN0aW9uKCBlICl7CgkJCQkJCSQoIGUudGFyZ2V0ICkKCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkKCQkJCQkJCS50cmlnZ2VyKCAidm1vdXNlb3V0IiApOwoJCQkJCX0pCgkJCQkJLmRlbGVnYXRlKCAibGk6bm90KC51aS1kaXNhYmxlZCwgLnVpLWxpLWRpdmlkZXIpIiwgImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJCQl2YXIgb2xkSW5kZXggPSBzZWxmLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgkJCQkJCQluZXdJbmRleCA9IHNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5pbmRleCggdGhpcyApLAoJCQkJCQkJb3B0aW9uID0gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmVxKCBuZXdJbmRleCApWyAwIF07CgoJCQkJCQkvLyB0b2dnbGUgc2VsZWN0ZWQgc3RhdHVzIG9uIHRoZSB0YWcgZm9yIG11bHRpIHNlbGVjdHMKCQkJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJCQkvLyB0b2dnbGUgY2hlY2tib3ggY2xhc3MgZm9yIG11bHRpcGxlIHNlbGVjdHMKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkkKCB0aGlzICkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiLCAhb3B0aW9uLnNlbGVjdGVkICk7CgkJCQkJCX0KCgkJCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgfHwgb2xkSW5kZXggIT09IG5ld0luZGV4ICkgewoJCQkJCQkJc2VsZi5zZWxlY3QudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCQkJfQoKCQkJCQkJLy8gaGlkZSBjdXN0b20gc2VsZWN0IGZvciBzaW5nbGUgc2VsZWN0cyBvbmx5IC0gb3RoZXJ3aXNlIGZvY3VzIGNsaWNrZWQgaXRlbQoJCQkJCQkvLyBXZSBuZWVkIHRvIGdyYWIgdGhlIGNsaWNrZWQgaXRlbSB0aGUgaGFyZCB3YXksIGJlY2F1c2UgdGhlIGxpc3QgbWF5IGhhdmUgYmVlbiByZWJ1aWx0CgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApLmVxKCBuZXdJbmRleCApCgkJCQkJCQkJLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQl9CgkJCQkJCWVsc2UgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQl9CgoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0pCgkJCQkJLmtleWRvd24oZnVuY3Rpb24oIGV2ZW50ICkgeyAgLy9rZXlib2FyZCBldmVudHMgZm9yIG1lbnUgaXRlbXMKCQkJCQkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLAoJCQkJCQkJbGkgPSB0YXJnZXQuY2xvc2VzdCggImxpIiApLAoJCQkJCQkJcHJldiwgbmV4dDsKCgkJCQkJCS8vIHN3aXRjaCBsb2dpYyBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQkJCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCQkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCQkJCQkgY2FzZSAzODoKCQkJCQkJCXByZXYgPSBsaS5wcmV2KCkubm90KCAiLnVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgoJCQkJCQkJaWYoIHByZXYuaXMoICIudWktbGktZGl2aWRlciIgKSApIHsKCQkJCQkJCQlwcmV2ID0gcHJldi5wcmV2KCk7CgkJCQkJCQl9CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIHByZXZpb3VzIG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggcHJldi5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJcHJldi5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQlicmVhazsKCgkJCQkJCQkvLyBkb3duIG9yIHJpZ2h0IGFycm93IGtleXMKCQkJCQkJIGNhc2UgNDA6CgkJCQkJCQluZXh0ID0gbGkubmV4dCgpOwoKCQkJCQkJCWlmKCBuZXh0LmlzKCAiLnVpLWxpLWRpdmlkZXIiICkgKSB7CgkJCQkJCQkJbmV4dCA9IG5leHQubmV4dCgpOwoJCQkJCQkJfQoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBuZXh0IG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggbmV4dC5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJbmV4dC5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQlicmVhazsKCgkJCQkJCQkvLyBJZiBlbnRlciBvciBzcGFjZSBpcyBwcmVzc2VkLCB0cmlnZ2VyIGNsaWNrCgkJCQkJCSBjYXNlIDEzOgoJCQkJCQkgY2FzZSAzMjoKCQkJCQkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9KTsKCgkJCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkJCS8vIGJ5IHJlbW92aW5nIHRoZSBpbmxpbmUgc3R5bGUgYW5kIGVuc3VyaW5nIHBhZ2UgaW5jbHVzaW9uCgkJCQlzZWxmLm1lbnVQYWdlLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCgkJCQkJLy8gVE9ETyBjZW50cmFsaXplIHBhZ2UgcmVtb3ZhbCBiaW5kaW5nIC8gaGFuZGxpbmcgaW4gdGhlIHBhZ2UgcGx1Z2luLgoJCQkJCS8vIFN1Z2dlc3Rpb24gZnJvbSBAamJsYXMgdG8gZG8gcmVmY291bnRpbmcKCQkJCQkvLwoJCQkJCS8vIFRPRE8gZXh0cmVtZWx5IGNvbmZ1c2luZyBkZXBlbmRlbmN5IG9uIHRoZSBvcGVuIG1ldGhvZCB3aGVyZSB0aGUgcGFnZWhpZGUucmVtb3ZlCgkJCQkJLy8gYmluZGluZ3MgYXJlIHN0cmlwcGVkIHRvIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gZGlzYXBwZWFyaW5nLiBUaGUgd2F5CgkJCQkJLy8gd2UncmUga2VlcGluZyBwYWdlcyBpbiB0aGUgRE9NIHJpZ2h0IG5vdyBzdWNrcwoJCQkJCS8vCgkJCQkJLy8gcmViaW5kIHRoZSBwYWdlIHJlbW92ZSB0aGF0IHdhcyB1bmJvdW5kIGluIHRoZSBvcGVuIGZ1bmN0aW9uCgkJCQkJLy8gdG8gYWxsb3cgZm9yIHRoZSBwYXJlbnQgcGFnZSByZW1vdmFsIGZyb20gYWN0aW9ucyBvdGhlciB0aGFuIHRoZSB1c2UKCQkJCQkvLyBvZiBhIGRpYWxvZyBzaXplZCBjdXN0b20gc2VsZWN0CgkJCQkJLy8KCQkJCQkvLyBkb2luZyB0aGlzIGhlcmUgcHJvdmlkZXMgZm9yIHRoZSBiYWNrIGJ1dHRvbiBvbiB0aGUgY3VzdG9tIHNlbGVjdCBkaWFsb2cKCQkJCQkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUuY2FsbCggc2VsZi50aGlzUGFnZSApOwoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIG9uICJzY3JlZW4iIG92ZXJsYXkKCQkJCXNlbGYuc2NyZWVuLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgoJCQkJLy8gQ2xvc2UgYnV0dG9uIG9uIHNtYWxsIG92ZXJsYXlzCgkJCQlpZiggc2VsZi5pc011bHRpcGxlICl7CgkJCQkJc2VsZi5oZWFkZXJDbG9zZS5jbGljayggZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PSAib3ZlcmxheSIgKSB7CgkJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCX0KCgkJCQkvLyB0cmFjayB0aGlzIGRlcGVuZGVuY3kgc28gdGhhdCB3aGVuIHRoZSBwYXJlbnQgcGFnZQoJCQkJLy8gaXMgcmVtb3ZlZCBvbiBwYWdlaGlkZSBpdCB3aWxsIGFsc28gcmVtb3ZlIHRoZSBtZW51cGFnZQoJCQkJc2VsZi50aGlzUGFnZS5hZGREZXBlbmRlbnRzKCB0aGlzLm1lbnVQYWdlICk7CgkJCX0sCgoJCQlfaXNSZWJ1aWxkUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQkJCW9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCk7CgoJCQkJLy8gVE9ETyBleGNlZWRpbmdseSBuYWl2ZSBtZXRob2QgdG8gZGV0ZXJtaW5lIGRpZmZlcmVuY2UKCQkJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJCQkvLyBmcm9tIHRoZSB1c2VyIGluIHRoZSByZWZyZXNoIG1ldGhvZAoJCQkJcmV0dXJuIG9wdGlvbnMudGV4dCgpICE9PSBsaXN0LnRleHQoKTsKCQkJfSwKCgkJCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkOm5vdCg6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpKSIgKTsKCQkJfSwKCgkJCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZVJlYnVpbGQgLCBmb28gKXsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCXNlbGVjdCA9IHRoaXMuZWxlbWVudCwKCQkJCWlzTXVsdGlwbGUgPSB0aGlzLmlzTXVsdGlwbGUsCgkJCQlpbmRpY2llczsKCgkJCQlpZiAoICBmb3JjZVJlYnVpbGQgfHwgdGhpcy5faXNSZWJ1aWxkUmVxdWlyZWQoKSApIHsKCQkJCQlzZWxmLl9idWlsZExpc3QoKTsKCQkJCX0KCgkJCQlpbmRpY2llcyA9IHRoaXMuc2VsZWN0ZWRJbmRpY2VzKCk7CgoJCQkJc2VsZi5zZXRCdXR0b25UZXh0KCk7CgkJCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApCgkJCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkJCS5lYWNoKGZ1bmN0aW9uKCBpICkgewoKCQkJCQkJaWYgKCAkLmluQXJyYXkoIGksIGluZGljaWVzICkgPiAtMSApIHsKCQkJCQkJCXZhciBpdGVtID0gJCggdGhpcyApOwoKCQkJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCQkJaXRlbS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIHRydWUgKTsKCgkJCQkJCQkvLyBNdWx0aXBsZSBzZWxlY3RzOiBhZGQgdGhlICJvbiIgY2hlY2tib3ggc3RhdGUgdG8gdGhlIGljb24KCQkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJCWl0ZW0uZmluZCggIi51aS1pY29uIiApLnJlbW92ZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiICkuYWRkQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiApOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlpZiggaXRlbS5pcyggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApICkgewoJCQkJCQkJCQlpdGVtLm5leHQoKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQlpdGVtLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQl9LAoKCQkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09ICJwYWdlIiApIHsKCQkJCQkvLyBkb2Vzbid0IHNvbHZlIHRoZSBwb3NzaWJsZSBpc3N1ZSB3aXRoIGNhbGxpbmcgY2hhbmdlIHBhZ2UKCQkJCQkvLyB3aGVyZSB0aGUgb2JqZWN0cyBkb24ndCBkZWZpbmUgZGF0YSB1cmxzIHdoaWNoIHByZXZlbnRzIGRpYWxvZyBrZXkKCQkJCQkvLyBzdHJpcHBpbmcgLSBjaGFuZ2VQYWdlIGhhcyBpbmNvbWluZyByZWZhY3RvcgoJCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5zY3JlZW4uYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJCXNlbGYubGlzdGJveC5hZGRDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApLnJlbW92ZUF0dHIoICJzdHlsZSIgKS5yZW1vdmVDbGFzcyggImluIiApOwoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkJCX0KCgkJCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJfSwKCgkJCW9wZW46IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpcywKICAgICAgICAgICR3aW5kb3cgPSAkKCB3aW5kb3cgKSwKICAgICAgICAgIHNlbGZMaXN0UGFyZW50ID0gc2VsZi5saXN0LnBhcmVudCgpLAoJCQkJCW1lbnVIZWlnaHQgPSBzZWxmTGlzdFBhcmVudC5vdXRlckhlaWdodCgpLAoJCQkJCW1lbnVXaWR0aCA9IHNlbGZMaXN0UGFyZW50Lm91dGVyV2lkdGgoKSwKCQkJCQlhY3RpdmVQYWdlID0gJCggIi51aS1wYWdlLWFjdGl2ZSIgKSwKCQkJCQl0U2Nyb2xsRWxlbSA9IGFjdGl2ZVBhZ2UsCgkJCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCQlidG5PZmZzZXQgPSBzZWxmLmJ1dHRvbi5vZmZzZXQoKS50b3AsCgkJCQkJc2NyZWVuSGVpZ2h0ID0gJHdpbmRvdy5oZWlnaHQoKSwKCQkJCQlzY3JlZW5XaWR0aCA9ICR3aW5kb3cud2lkdGgoKTsKCgkJCQkvL2FkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkvL3JlbW92ZSBhZnRlciBkZWxheQoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9LCAzMDApOwoKCQkJCWZ1bmN0aW9uIGZvY3VzTWVudUl0ZW0oKSB7CgkJCQkJdmFyIHNlbGVjdG9yID0gc2VsZi5saXN0LmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiBhIiApOwoJCQkJCWlmICggc2VsZWN0b3IubGVuZ3RoID09PSAwICkgewoJCQkJCQlzZWxlY3RvciA9IHNlbGYubGlzdC5maW5kKCAibGkudWktYnRuOm5vdCg6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpKSBhIiApOwoJCQkJCX0KCQkJCQlzZWxlY3Rvci5maXJzdCgpLmZvY3VzKCkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICk7CgkJCQl9CgoJCQkJaWYgKCBtZW51SGVpZ2h0ID4gc2NyZWVuSGVpZ2h0IC0gODAgfHwgISQuc3VwcG9ydC5zY3JvbGxUb3AgKSB7CgoJCQkJCXNlbGYubWVudVBhZ2UuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCk7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQgPSBtZW51UGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICk7CgkJCQkJc2VsZi5tZW51UGFnZUNsb3NlID0gbWVudVBhZ2UuZmluZCggIi51aS1oZWFkZXIgYSIgKTsKCgkJCQkJLy8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBiZWluZyByZW1vdmVkIGZyb20gdGhlIERPTSwKCQkJCQkvLyBvdGhlcndpc2UgdGhlIHJlc3VsdHMgb2Ygc2VsZWN0aW5nIGEgbGlzdCBpdGVtIGluIHRoZSBkaWFsb2cKCQkJCQkvLyBmYWxsIGludG8gYSBibGFjayBob2xlCgkJCQkJc2VsZi50aGlzUGFnZS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICk7CgoJCQkJCS8vZm9yIFdlYk9TL09wZXJhIE1pbmkgKHNldCBsYXN0c2Nyb2xsIHVzaW5nIGJ1dHRvbiBvZmZzZXQpCgkJCQkJaWYgKCBzY3JvbGxUb3AgPT0gMCAmJiBidG5PZmZzZXQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQkJCXNlbGYudGhpc1BhZ2Uub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAibGFzdFNjcm9sbCIsIGJ0bk9mZnNldCApOwoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCXNlbGYubWVudVBhZ2UKCQkJCQkJLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCQlmb2N1c01lbnVJdGVtKCk7CgkJCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQkJCX0pCgkJCQkJCS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJCQkJfSk7CgoJCQkJCXNlbGYubWVudVR5cGUgPSAicGFnZSI7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQuYXBwZW5kKCBzZWxmLmxpc3QgKTsKCQkJCQlzZWxmLm1lbnVQYWdlLmZpbmQoImRpdiAudWktdGl0bGUiKS50ZXh0KHNlbGYubGFiZWwudGV4dCgpKTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBzZWxmLm1lbnVQYWdlLCB7CgkJCQkJCXRyYW5zaXRpb246ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uCgkJCQkJfSk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubWVudVR5cGUgPSAib3ZlcmxheSI7CgoJCQkJCXNlbGYuc2NyZWVuLmhlaWdodCggJChkb2N1bWVudCkuaGVpZ2h0KCkgKQoJCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoKCQkJCQkvLyBUcnkgYW5kIGNlbnRlciB0aGUgb3ZlcmxheSBvdmVyIHRoZSBidXR0b24KCQkJCQl2YXIgcm9vbXRvcCA9IGJ0bk9mZnNldCAtIHNjcm9sbFRvcCwKCQkJCQkJcm9vbWJvdCA9IHNjcm9sbFRvcCArIHNjcmVlbkhlaWdodCAtIGJ0bk9mZnNldCwKCQkJCQkJaGFsZmhlaWdodCA9IG1lbnVIZWlnaHQgLyAyLAoJCQkJCQltYXh3aWR0aCA9IHBhcnNlRmxvYXQoIHNlbGYubGlzdC5wYXJlbnQoKS5jc3MoICJtYXgtd2lkdGgiICkgKSwKCQkJCQkJbmV3dG9wLCBuZXdsZWZ0OwoKCQkJCQlpZiAoIHJvb210b3AgPiBtZW51SGVpZ2h0IC8gMiAmJiByb29tYm90ID4gbWVudUhlaWdodCAvIDIgKSB7CgkJCQkJCW5ld3RvcCA9IGJ0bk9mZnNldCArICggc2VsZi5idXR0b24ub3V0ZXJIZWlnaHQoKSAvIDIgKSAtIGhhbGZoZWlnaHQ7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gMzBweCB0b2xlcmFuY2Ugb2ZmIHRoZSBlZGdlcwoJCQkJCQluZXd0b3AgPSByb29tdG9wID4gcm9vbWJvdCA/IHNjcm9sbFRvcCArIHNjcmVlbkhlaWdodCAtIG1lbnVIZWlnaHQgLSAzMCA6IHNjcm9sbFRvcCArIDMwOwoJCQkJCX0KCgkJCQkJLy8gSWYgdGhlIG1lbnV3aWR0aCBpcyBzbWFsbGVyIHRoYW4gdGhlIHNjcmVlbiBjZW50ZXIgaXMKCQkJCQlpZiAoIG1lbnVXaWR0aCA8IG1heHdpZHRoICkgewoJCQkJCQluZXdsZWZ0ID0gKCBzY3JlZW5XaWR0aCAtIG1lbnVXaWR0aCApIC8gMjsKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy9vdGhlcndpc2UgaW5zdXJlIGEgPj0gMzBweCBvZmZzZXQgZnJvbSB0aGUgbGVmdAoJCQkJCQluZXdsZWZ0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkubGVmdCArIHNlbGYuYnV0dG9uLm91dGVyV2lkdGgoKSAvIDIgLSBtZW51V2lkdGggLyAyOwoKCQkJCQkJLy8gMzBweCB0b2xlcmFuY2Ugb2ZmIHRoZSBlZGdlcwoJCQkJCQlpZiAoIG5ld2xlZnQgPCAzMCApIHsKCQkJCQkJCW5ld2xlZnQgPSAzMDsKCQkJCQkJfSBlbHNlIGlmICggKG5ld2xlZnQgKyBtZW51V2lkdGgpID4gc2NyZWVuV2lkdGggKSB7CgkJCQkJCQluZXdsZWZ0ID0gc2NyZWVuV2lkdGggLSBtZW51V2lkdGggLSAzMDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJc2VsZi5saXN0Ym94LmFwcGVuZCggc2VsZi5saXN0ICkKCQkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2VsZWN0bWVudS1oaWRkZW4iICkKCQkJCQkJLmNzcyh7CgkJCQkJCQl0b3A6IG5ld3RvcCwKCQkJCQkJCWxlZnQ6IG5ld2xlZnQKCQkJCQkJfSkKCQkJCQkJLmFkZENsYXNzKCAiaW4iICk7CgoJCQkJCWZvY3VzTWVudUl0ZW0oKTsKCgkJCQkJLy8gZHVwbGljYXRlIHdpdGggdmFsdWUgc2V0IGluIHBhZ2Ugc2hvdyBmb3IgZGlhbG9nIHNpemVkIHNlbGVjdHMKCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQl9CgkJCX0sCgoJCQlfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQkJCW9wdGdyb3VwcyA9IFtdLAoJCQkJCWxpcyA9IFtdLAoJCQkJCWRhdGFJY29uID0gc2VsZi5pc011bHRpcGxlID8gImNoZWNrYm94LW9mZiIgOiAiZmFsc2UiOwoKCQkJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgoJCQkJdmFyICRvcHRpb25zID0gc2VsZi5zZWxlY3QuZmluZCgib3B0aW9uIiksCgkJCQkJbnVtT3B0aW9ucyA9ICRvcHRpb25zLmxlbmd0aCwKCQkJCQlzZWxlY3QgPSB0aGlzLnNlbGVjdFsgMCBdLAoJCQkJCWRhdGFQcmVmaXggPSAnZGF0YS0nICsgJC5tb2JpbGUubnMsCgkJCQkJZGF0YUluZGV4QXR0ciA9IGRhdGFQcmVmaXggKyAnb3B0aW9uLWluZGV4JywKCQkJCQlkYXRhSWNvbkF0dHIgPSBkYXRhUHJlZml4ICsgJ2ljb24nLAoJCQkJCWRhdGFSb2xlQXR0ciA9IGRhdGFQcmVmaXggKyAncm9sZScsCgkJCQkJZGF0YVBsYWNlaG9sZGVyQXR0ciA9IGRhdGFQcmVmaXggKyAncGxhY2Vob2xkZXInLAoJCQkJCWZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAoJCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UsCgkJCQkJb3B0R3JvdXA7CgoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBudW1PcHRpb25zO2krKywgaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSl7CgkJCQkJdmFyIG9wdGlvbiA9ICRvcHRpb25zW2ldLAoJCQkJCQkkb3B0aW9uID0gJChvcHRpb24pLAoJCQkJCQlwYXJlbnQgPSBvcHRpb24ucGFyZW50Tm9kZSwKCQkJCQkJdGV4dCA9ICRvcHRpb24udGV4dCgpLAoJCQkJCQlhbmNob3IgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpLAoJCQkJCQljbGFzc2VzID0gW107CgoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCcjJyk7CgkJCQkJYW5jaG9yLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpKTsKCgkJCQkJLy8gQXJlIHdlIGluc2lkZSBhbiBvcHRncm91cD8KCQkJCQlpZiAocGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIpewoJCQkJCQl2YXIgb3B0TGFiZWwgPSBwYXJlbnQuZ2V0QXR0cmlidXRlKCdsYWJlbCcpOwoJCQkJCQlpZiAoIG9wdExhYmVsICE9IG9wdEdyb3VwKSB7CgkJCQkJCQl2YXIgZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZShkYXRhUm9sZUF0dHIsJ2xpc3QtZGl2aWRlcicpOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCdvcHRpb24nKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsJy0xJyk7CgkJCQkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKG9wdExhYmVsKSk7CgkJCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZChkaXZpZGVyKTsKCQkJCQkJCW9wdEdyb3VwID0gb3B0TGFiZWw7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmIChuZWVkUGxhY2Vob2xkZXIgJiYgKCFvcHRpb24uZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgfHwgdGV4dC5sZW5ndGggPT0gMCB8fCAkb3B0aW9uLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSkpIHsKCQkJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gdHJ1ZTsKCgkJCQkJCS8vIElmIHdlIGhhdmUgaWRlbnRpZmllZCBhIHBsYWNlaG9sZGVyLCBtYXJrIGl0IHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQkJCW9wdGlvbi5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQkJCWNsYXNzZXMucHVzaCggInVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgkJCQkJCX0KCQkJCQkJaWYgKCFwbGFjZWhvbGRlcikgewoJCQkJCQkJcGxhY2Vob2xkZXIgPSBzZWxmLnBsYWNlaG9sZGVyID0gdGV4dDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpOwoJCQkJCWlmICggb3B0aW9uLmRpc2FibGVkICkgewoJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1kaXNhYmxlZCIgKTsKCQkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoJ2FyaWEtZGlzYWJsZWQnLHRydWUpOwoJCQkJCX0KCQkJCQlpdGVtLnNldEF0dHJpYnV0ZShkYXRhSW5kZXhBdHRyLGkpOwoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKGRhdGFJY29uQXR0cixkYXRhSWNvbik7CgkJCQkJaWYgKCBpc1BsYWNlaG9sZGVySXRlbSApIHsKCQkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCQl9CgkJCQkJaXRlbS5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oIiAiKTsKCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSgncm9sZScsJ29wdGlvbicpOwoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoJ3RhYmluZGV4JywnLTEnKTsKCQkJCQlpdGVtLmFwcGVuZENoaWxkKGFuY2hvcik7CgkJCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoaXRlbSk7CgkJCQl9CgoJCQkJc2VsZi5saXN0WzBdLmFwcGVuZENoaWxkKGZyYWdtZW50KTsKCgkJCQkvLyBIaWRlIGhlYWRlciBpZiBpdCdzIG5vdCBhIG11bHRpc2VsZWN0IGFuZCB0aGVyZSdzIG5vIHBsYWNlaG9sZGVyCgkJCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJCQl0aGlzLmhlYWRlci5oaWRlKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCQkJfQoKCQkJCS8vIE5vdyBwb3B1bGF0ZWQsIGNyZWF0ZSBsaXN0dmlldwoJCQkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7CgkJCX0sCgoJCQlfYnV0dG9uOiBmdW5jdGlvbigpewoJCQkJcmV0dXJuICQoICI8YT4iLCB7CgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkJImFyaWEtaGFzcG9wdXAiOiAidHJ1ZSIsCgoJCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCQl9KTsKCQkJfQoJCX0pOwoJfTsKCgkvLyBpc3N1ZSAjMzg5NCAtIGNvcmUgZG9lc24ndCB0cmlnZ2VyZWQgZXZlbnRzIG9uIGRpc2FibGVkIGRlbGVnYXRlcwoJJCggZG9jdW1lbnQgKS5iaW5kKCAic2VsZWN0bWVudWJlZm9yZWNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApewoJCXZhciBzZWxlY3RtZW51V2lkZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuZGF0YSggInNlbGVjdG1lbnUiICk7CgoJCWlmKCAhc2VsZWN0bWVudVdpZGdldC5vcHRpb25zLm5hdGl2ZU1lbnUgKXsKCQkJZXh0ZW5kU2VsZWN0KCBzZWxlY3RtZW51V2lkZ2V0ICk7CgkJfQoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS5maXhlZHRvb2xiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCQlvcHRpb25zOiB7CgkJCXZpc2libGVPblBhZ2VTaG93OiB0cnVlLAoJCQlkaXNhYmxlUGFnZVpvb206IHRydWUsCgkJCXRyYW5zaXRpb246ICJzbGlkZSIsIC8vY2FuIGJlIG5vbmUsIGZhZGUsIHNsaWRlIChzbGlkZSBtYXBzIHRvIHNsaWRldXAgb3Igc2xpZGVkb3duKQoJCQlmdWxsc2NyZWVuOiBmYWxzZSwKCQkJdGFwVG9nZ2xlOiB0cnVlLAoJCQl0YXBUb2dnbGVCbGFja2xpc3Q6ICJhLCBidXR0b24sIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCAudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiwKCQkJaGlkZUR1cmluZ0ZvY3VzOiAiaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QiLAoJCQl1cGRhdGVQYWdlUGFkZGluZzogdHJ1ZSwKCQkJdHJhY2tQZXJzaXN0ZW50VG9vbGJhcnM6IHRydWUsCgoJCQkvLyBCcm93c2VyIGRldGVjdGlvbiEgV2VlZWUsIGhlcmUgd2UgZ28uLi4KCQkJLy8gVW5mb3J0dW5hdGVseSwgcG9zaXRpb246Zml4ZWQgaXMgY29zdGx5LCBub3QgdG8gbWVudGlvbiBwcm9iYWJseSBpbXBvc3NpYmxlLCB0byBmZWF0dXJlLWRldGVjdCBhY2N1cmF0ZWx5LgoJCQkvLyBTb21lIHRlc3RzIGV4aXN0LCBidXQgdGhleSBjdXJyZW50bHkgcmV0dXJuIGZhbHNlIHJlc3VsdHMgaW4gY3JpdGljYWwgZGV2aWNlcyBhbmQgYnJvd3NlcnMsIHdoaWNoIGNvdWxkIGxlYWQgdG8gYSBicm9rZW4gZXhwZXJpZW5jZS4KCQkJLy8gVGVzdGluZyBmaXhlZCBwb3NpdGlvbmluZyBpcyBhbHNvIHByZXR0eSBvYnRydXNpdmUgdG8gcGFnZSBsb2FkLCByZXF1aXJpbmcgaW5qZWN0ZWQgZWxlbWVudHMgYW5kIHNjcm9sbGluZyB0aGUgd2luZG93CgkJCS8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gc2VydmVzIHRvIHJ1bGUgb3V0IHNvbWUgcG9wdWxhciBicm93c2VycyB3aXRoIGtub3duIGZpeGVkLXBvc2l0aW9uaW5nIGlzc3VlcwoJCQkvLyBUaGlzIGlzIGEgcGx1Z2luIG9wdGlvbiBsaWtlIGFueSBvdGhlciwgc28gZmVlbCBmcmVlIHRvIGltcHJvdmUgb3Igb3ZlcndyaXRlIGl0CgkJCXN1cHBvcnRCbGFja2xpc3Q6IGZ1bmN0aW9uKCl7CgkJCQl2YXIgdyA9IHdpbmRvdywKCQkJCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCQkJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJCQkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCQkJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCgkJCQlpZigKCQkJCQkvLyBpT1MgNC4zIGFuZCBvbGRlciA6IFBsYXRmb3JtIGlzIGlQaG9uZS9QYWQvVG91Y2ggYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzQgKGlvczUpCgkJCQkJKCAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApCgkJCQkJfHwKCQkJCQkvLyBPcGVyYSBNaW5pCgkJCQkJKCB3Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHcub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iICkKCQkJCQl8fAoJCQkJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCgkJCQkJfHwKCQkJCQkvL0FuZHJvaWQgbHRlIDIuMTogUGxhdGZvcm0gaXMgQW5kcm9pZCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzMyAoQW5kcm9pZCAyLjIpCgkJCQkJKCB1YS5pbmRleE9mKCAiQW5kcm9pZCIgKSA+IC0xICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzMgKQoJCQkJCXx8CgkJCQkJLy8gRmlyZWZveCBNb2JpbGUgYmVmb3JlIDYuMCAtCgkJCQkJKCBmZnZlcnNpb24gJiYgZmZ2ZXJzaW9uIDwgNiApCgkJCQkJfHwKCQkJCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCQkJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQoJCQkJCXx8CgkJCQkJLy8gTWVlR28KCQkJCQkoIHVhLmluZGV4T2YoICJNZWVHbyIgKSA+IC0xICYmIHVhLmluZGV4T2YoICJOb2tpYUJyb3dzZXIvOC41LjAiICkgPiAtMSApCgkJCQkpewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoKCQkJCXJldHVybiBmYWxzZTsKCQkJfSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50LAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiLAoJCQkJJHBhZ2UgPSAkZWwuY2xvc2VzdCgiLnVpLXBhZ2UiKTsKCgkJCS8vIEZlYXR1cmUgZGV0ZWN0aW5nIHN1cHBvcnQgZm9yCgkJCWlmKCBvLnN1cHBvcnRCbGFja2xpc3QoKSApewoJCQkJc2VsZi5kZXN0cm95KCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCSRlbC5hZGRDbGFzcyggInVpLSIrIHRidHlwZSArIi1maXhlZCIgKTsKCgkJCS8vICJmdWxsc2NyZWVuIiBvdmVybGF5IHBvc2l0aW9uaW5nCgkJCWlmKCBvLmZ1bGxzY3JlZW4gKXsKCQkJCSRlbC5hZGRDbGFzcyggInVpLSIrIHRidHlwZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0YnR5cGUgKyAiLWZ1bGxzY3JlZW4iICk7CgkJCX0KCQkJLy8gSWYgbm90IGZ1bGxzY3JlZW4sIGFkZCBjbGFzcyB0byBwYWdlIHRvIHNldCB0b3Agb3IgYm90dG9tIHBhZGRpbmcKCQkJZWxzZXsKCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGJ0eXBlICsgIi1maXhlZCIgKTsKCQkJfQoKCQkJc2VsZi5fYWRkVHJhbnNpdGlvbkNsYXNzKCk7CgkJCXNlbGYuX2JpbmRQYWdlRXZlbnRzKCk7CgkJCXNlbGYuX2JpbmRUb2dnbGVIYW5kbGVycygpOwoJCX0sCgoJCV9hZGRUcmFuc2l0aW9uQ2xhc3M6IGZ1bmN0aW9uKCl7CgkJCXZhciB0Y2xhc3MgPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCgkJCWlmKCB0Y2xhc3MgJiYgdGNsYXNzICE9PSAibm9uZSIgKXsKCQkJCS8vIHVzZSBhcHByb3ByaWF0ZSBzbGlkZSBmb3IgaGVhZGVyIG9yIGZvb3RlcgoJCQkJaWYoIHRjbGFzcyA9PT0gInNsaWRlIiApewoJCQkJCXRjbGFzcyA9IHRoaXMuZWxlbWVudC5pcyggIi51aS1oZWFkZXIiICkgPyAic2xpZGVkb3duIiA6ICJzbGlkZXVwIjsKCQkJCX0KCgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRjbGFzcyApOwoJCQl9CgkJfSwKCgkJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50OwoKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKQoJCQkJLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCl7CgkJCQkJaWYoIG8uZGlzYWJsZVBhZ2Vab29tICl7CgkJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQkJCX0KCQkJCQlpZiggIW8udmlzaWJsZU9uUGFnZVNob3cgKXsKCQkJCQkJc2VsZi5oaWRlKCB0cnVlICk7CgkJCQkJfQoJCQkJfSApCgkJCQkuYmluZCggIndlYmtpdEFuaW1hdGlvblN0YXJ0IGFuaW1hdGlvbnN0YXJ0IHVwZGF0ZWxheW91dCIsIGZ1bmN0aW9uKCl7CgkJCQkJdmFyIHRoaXNQYWdlID0gdGhpczsKCQkJCQlpZiggby51cGRhdGVQYWdlUGFkZGluZyApewoJCQkJCQlzZWxmLnVwZGF0ZVBhZ2VQYWRkaW5nKCB0aGlzUGFnZSApOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggInBhZ2VzaG93IiwgZnVuY3Rpb24oKXsKCQkJCQl2YXIgdGhpc1BhZ2UgPSB0aGlzOwoJCQkJCXNlbGYudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXNQYWdlICk7CgkJCQkJaWYoIG8udXBkYXRlUGFnZVBhZGRpbmcgKXsKCQkJCQkJJCggd2luZG93ICkuYmluZCggInRocm90dGxlZHJlc2l6ZS4iICsgc2VsZi53aWRnZXROYW1lLCBmdW5jdGlvbigpewoJCQkJCQkgCXNlbGYudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXNQYWdlICk7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oIGUsIHVpICl7CgkJCQkJaWYoIG8uZGlzYWJsZVBhZ2Vab29tICl7CgkJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQkJfQoJCQkJCWlmKCBvLnVwZGF0ZVBhZ2VQYWRkaW5nICl7CgkJCQkJCSQoIHdpbmRvdyApLnVuYmluZCggInRocm90dGxlZHJlc2l6ZS4iICsgc2VsZi53aWRnZXROYW1lICk7CgkJCQkJfQoKCQkJCQlpZiggby50cmFja1BlcnNpc3RlbnRUb29sYmFycyApewoJCQkJCQl2YXIgdGhpc0Zvb3RlciA9ICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcyApLAoJCQkJCQkJdGhpc0hlYWRlciA9ICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcyApLAoJCQkJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICksCgkJCQkJCQluZXh0SGVhZGVyID0gdGhpc0hlYWRlci5sZW5ndGggJiYgdWkubmV4dFBhZ2UgJiYgJCggIi51aS1oZWFkZXItZml4ZWQ6anFtRGF0YShpZD0nIiArIHRoaXNIZWFkZXIuanFtRGF0YSggImlkIiApICsgIicpIiwgdWkubmV4dFBhZ2UgKTsKCgkJCQkJCW5leHRGb290ZXIgPSBuZXh0Rm9vdGVyIHx8ICQoKTsKCgkJCQkJCQlpZiggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKXsKCgkJCQkJCQkJbmV4dEZvb3Rlci5hZGQoIG5leHRIZWFkZXIgKS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJCQkJCQl1aS5uZXh0UGFnZS5vbmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCl7CgkJCQkJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oIHRoaXMgKTsKCQkJCQkJCQl9KTsKCQkJCQkJCX0KCQkJCQl9CgkJCQl9KTsKCQl9LAoKCQlfdmlzaWJsZTogdHJ1ZSwKCgkJLy8gVGhpcyB3aWxsIHNldCB0aGUgY29udGVudCBlbGVtZW50J3MgdG9wIG9yIGJvdHRvbSBwYWRkaW5nIGVxdWFsIHRvIHRoZSB0b29sYmFyJ3MgaGVpZ2h0CgkJdXBkYXRlUGFnZVBhZGRpbmc6IGZ1bmN0aW9uKCB0YlBhZ2UgKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaXMoICIudWktaGVhZGVyIiApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiggdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gKXsgcmV0dXJuOyB9CgoJCQl0YlBhZ2UgPSB0YlBhZ2UgfHwgJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJJCggdGJQYWdlICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICRlbC5vdXRlckhlaWdodCgpICk7CgkJfSwKCQkKCQlfdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApewoJCQl2YXIgJHdpbiA9ICQoIHdpbmRvdyApLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuaGVpZ2h0KCksCgkJCQl2aWV3cG9ydEhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiOwoJCQkJCgkJCXJldHVybiAhbm90cmFuc2l0aW9uICYmCgkJCQkoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICYmIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICE9PSAibm9uZSIgJiYKCQkJCSgKCQkJCQkoIHRidHlwZSA9PT0gImhlYWRlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCA+IGVsSGVpZ2h0ICkgfHwKCQkJCQkoIHRidHlwZSA9PT0gImZvb3RlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCArIHZpZXdwb3J0SGVpZ2h0IDwgcEhlaWdodCAtIGVsSGVpZ2h0ICkKCQkJCSkgfHwgdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4KCQkJCSk7CgkJfSwKCgkJc2hvdzogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCQkJaWYoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICl7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwucmVtb3ZlQ2xhc3MoIGhpZGVDbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSB0cnVlOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKXsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKXsKCQkJCSRlbAoJCQkJCS5hZGRDbGFzcyggb3V0Y2xhc3MgKQoJCQkJCS5yZW1vdmVDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCBmdW5jdGlvbigpewoJCQkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gZmFsc2U7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbigpewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50OwoKCQkJLy8gdGFwIHRvZ2dsZQoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApCgkJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBlICl7CgkJCQkJaWYoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICl7CgkJCQkJCXNlbGYudG9nZ2xlKCk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZm9jdXNpbiBmb2N1c291dCIsIGZ1bmN0aW9uKCBlICl7CgkJCQkJaWYoIHNjcmVlbi53aWR0aCA8IDUwMCAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApewoJCQkJCQlzZWxmWyAoIGUudHlwZSA9PT0gImZvY3VzaW4iICYmIHNlbGYuX3Zpc2libGUgKSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaXMoICIudWktaGVhZGVyIiApOwoKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgIiIgKTsKCQkJJGVsLnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwoKCS8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwoJJCggZG9jdW1lbnQgKQoJCS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJCQkKCQkJLy8gREVQUkVDQVRFRCBpbiAxLjE6IHN1cHBvcnQgZm9yIGRhdGEtZnVsbHNjcmVlbj10cnVlfGZhbHNlIG9uIHRoZSBwYWdlIGVsZW1lbnQuCgkJCS8vIFRoaXMgbGluZSBlbnN1cmVzIGl0IHN0aWxsIHdvcmtzLCBidXQgd2UgcmVjb21tZW5kIG1vdmluZyB0aGUgYXR0cmlidXRlIHRvIHRoZSB0b29sYmFycyB0aGVtc2VsdmVzLgoJCQlpZiggJCggZS50YXJnZXQgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIgKSApewoJCQkJJCggJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5ub3QoICI6anFtRGF0YShmdWxsc2NyZWVuKSIgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIsIHRydWUgKTsKCQkJfQoJCQkKCQkJJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwoJCX0pOwoKfSkoIGpRdWVyeSApOwoKKCBmdW5jdGlvbiggJCwgd2luZG93ICkgewoJCgkvLyBUaGlzIGZpeCBhZGRyZXNzZXMgYW4gaU9TIGJ1Zywgc28gcmV0dXJuIGVhcmx5IGlmIHRoZSBVQSBjbGFpbXMgaXQncyBzb21ldGhpbmcgZWxzZS4KCWlmKCAhKC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICkgKXsKCQlyZXR1cm47Cgl9CgkKICAgIHZhciB6b29tID0gJC5tb2JpbGUuem9vbSwKCQlldnQsIHgsIHksIHosIGFpZzsKCQogICAgZnVuY3Rpb24gY2hlY2tUaWx0KCBlICl7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoJCQoJCXggPSBNYXRoLmFicyggYWlnLnggKTsKCQl5ID0gTWF0aC5hYnMoIGFpZy55ICk7CgkJeiA9IE1hdGguYWJzKCBhaWcueiApOwoJCQkJCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCiAgICAgICAgaWYoICF3aW5kb3cub3JpZW50YXRpb24gJiYgKCB4ID4gNyB8fCAoICggeiA+IDYgJiYgeSA8IDggfHwgeiA8IDggJiYgeSA+IDYgKSAmJiB4ID4gNSApICkgKXsKCQkJaWYoIHpvb20uZW5hYmxlZCApewoJCQkJem9vbS5kaXNhYmxlKCk7CgkJCX0gICAgICAgIAkKICAgICAgICB9CgkJZWxzZSBpZiggIXpvb20uZW5hYmxlZCApewoJCQl6b29tLmVuYWJsZSgpOwogICAgICAgIH0KICAgIH0KCiAgICAkKCB3aW5kb3cgKQoJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJLmJpbmQoICJkZXZpY2Vtb3Rpb24uaW9zb3JpZW50YXRpb25maXgiLCBjaGVja1RpbHQgKTsKCn0oIGpRdWVyeSwgdGhpcyApKTsKCiggZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJCSRoZWFkID0gJCggImhlYWQiICksCgkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCgkvLyB0cmlnZ2VyIG1vYmlsZWluaXQgZXZlbnQgLSB1c2VmdWwgaG9vayBmb3IgY29uZmlndXJpbmcgJC5tb2JpbGUgc2V0dGluZ3MgYmVmb3JlIHRoZXkncmUgdXNlZAoJJCggd2luZG93LmRvY3VtZW50ICkudHJpZ2dlciggIm1vYmlsZWluaXQiICk7CgoJLy8gc3VwcG9ydCBjb25kaXRpb25zCgkvLyBpZiBkZXZpY2Ugc3VwcG9ydCBjb25kaXRpb24ocykgYXJlbid0IG1ldCwgbGVhdmUgdGhpbmdzIGFzIHRoZXkgYXJlIC0+IGEgYmFzaWMsIHVzYWJsZSBleHBlcmllbmNlLAoJLy8gb3RoZXJ3aXNlLCBwcm9jZWVkIHdpdGggdGhlIGVuaGFuY2VtZW50cwoJaWYgKCAhJC5tb2JpbGUuZ3JhZGVBKCkgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMKCS8vIG9yIGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKEJCNSwgT3BlcmEgTWluaSkKCWlmICggJC5tb2JpbGUuYWpheEJsYWNrbGlzdCApIHsKCQkkLm1vYmlsZS5hamF4RW5hYmxlZCA9IGZhbHNlOwoJfQoKCS8vIEFkZCBtb2JpbGUsIGluaXRpYWwgbG9hZCAicmVuZGVyaW5nIiBjbGFzc2VzIHRvIGRvY0VsCgkkaHRtbC5hZGRDbGFzcyggInVpLW1vYmlsZSB1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoKCS8vIFRoaXMgaXMgYSBmYWxsYmFjay4gSWYgYW55dGhpbmcgZ29lcyB3cm9uZyAoSlMgZXJyb3JzLCBldGMpLCBvciBldmVudHMgZG9uJ3QgZmlyZSwKCS8vIHRoaXMgZW5zdXJlcyB0aGUgcmVuZGVyaW5nIGNsYXNzIGlzIHJlbW92ZWQgYWZ0ZXIgNSBzZWNvbmRzLCBzbyBjb250ZW50IGlzIHZpc2libGUgYW5kIGFjY2Vzc2libGUKCXNldFRpbWVvdXQoIGhpZGVSZW5kZXJpbmdDbGFzcywgNTAwMCApOwoKCS8vIGxvYWRpbmcgZGl2IHdoaWNoIGFwcGVhcnMgZHVyaW5nIEFqYXggcmVxdWVzdHMKCS8vIHdpbGwgbm90IGFwcGVhciBpZiAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSBpcyBmYWxzZQoJdmFyIGxvYWRlckNsYXNzID0gInVpLWxvYWRlciIsCgkJJGxvYWRlciA9ICQoICI8ZGl2IGNsYXNzPSciICsgbG9hZGVyQ2xhc3MgKyAiJz48c3BhbiBjbGFzcz0ndWktaWNvbiB1aS1pY29uLWxvYWRpbmcnPjwvc3Bhbj48aDE+PC9oMT48L2Rpdj4iICk7CgoJLy8gRm9yIG5vbi1maXhlZCBzdXBwb3J0aW4gYnJvd3NlcnMuIFBvc2l0aW9uIGF0IHkgY2VudGVyIChpZiBzY3JvbGxUb3Agc3VwcG9ydGVkKSwgYWJvdmUgdGhlIGFjdGl2ZUJ0biAoaWYgZGVmaW5lZCksIG9yIGp1c3QgMTAwcHggZnJvbSB0b3AKCWZ1bmN0aW9uIGZha2VGaXhMb2FkZXIoKXsKCQl2YXIgYWN0aXZlQnRuID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5maXJzdCgpOwoKCQkkbG9hZGVyCgkJCS5jc3MoewoJCQkJdG9wOiAkLnN1cHBvcnQuc2Nyb2xsVG9wICYmICR3aW5kb3cuc2Nyb2xsVG9wKCkgKyAkd2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJYWN0aXZlQnRuLmxlbmd0aCAmJiBhY3RpdmVCdG4ub2Zmc2V0KCkudG9wIHx8IDEwMAoJCQl9KTsKCX0KCgkvLyBjaGVjayBwb3NpdGlvbiBvZiBsb2FkZXIgdG8gc2VlIGlmIGl0IGFwcGVhcnMgdG8gYmUgImZpeGVkIiB0byBjZW50ZXIKCS8vIGlmIG5vdCwgdXNlIGFicyBwb3NpdGlvbmluZwoJZnVuY3Rpb24gY2hlY2tMb2FkZXJQb3NpdGlvbigpewoJCXZhciBvZmZzZXQgPSAkbG9hZGVyLm9mZnNldCgpLAoJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQlzY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJaWYoIG9mZnNldC50b3AgPCBzY3JvbGxUb3AgfHwgKG9mZnNldC50b3AgLSBzY3JvbGxUb3ApID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkkbG9hZGVyLmFkZENsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCWZha2VGaXhMb2FkZXIoKTsKCQkJJHdpbmRvdwoJCQkJLnVuYmluZCggInNjcm9sbCIsIGNoZWNrTG9hZGVyUG9zaXRpb24gKQoJCQkJLmJpbmQoICJzY3JvbGwiLCBmYWtlRml4TG9hZGVyICk7CgkJfQoJfQoKCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCWZ1bmN0aW9uIGhpZGVSZW5kZXJpbmdDbGFzcygpewoJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCX0KCgkkLmV4dGVuZCgkLm1vYmlsZSwgewoJCS8vIHR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLgoJCXNob3dQYWdlTG9hZGluZ01zZzogZnVuY3Rpb24oIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApIHsKCQkJJGh0bWwuYWRkQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSApIHsKCQkJCS8vIHRleHQgdmlzaWJpbGl0eSBmcm9tIGFyZ3VtZW50IHRha2VzIHByaW9yaXR5CgkJCQl2YXIgdGV4dFZpc2libGUgPSB0ZXh0b25seSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOwoKCQkJCXRoZW1lID0gdGhlbWUgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUaGVtZSwKCgkJCQkkbG9hZGVyCgkJCQkJLmF0dHIoICJjbGFzcyIsIGxvYWRlckNsYXNzICsgIiB1aS1jb3JuZXItYWxsIHVpLWJvZHktIiArICggdGhlbWUgfHwgImEiICkgKyAiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSA/ICJ2ZXJib3NlIiA6ICJkZWZhdWx0IiApICsgKCB0ZXh0b25seSA/ICIgdWktbG9hZGVyLXRleHRvbmx5IiA6ICIiICkgKQoJCQkJCS5maW5kKCAiaDEiICkKCQkJCQkJLnRleHQoIG1zZ1RleHQgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgKQoJCQkJCQkuZW5kKCkKCQkJCQkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQljaGVja0xvYWRlclBvc2l0aW9uKCk7CgkJCQkkd2luZG93LmJpbmQoICJzY3JvbGwiLCBjaGVja0xvYWRlclBvc2l0aW9uICk7CgkJCX0KCQl9LAoKCQloaWRlUGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCkgewoJCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgKXsKCQkJCSRsb2FkZXIucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJfQoKCQkJJCggd2luZG93ICkudW5iaW5kKCAic2Nyb2xsIiwgZmFrZUZpeExvYWRlciApOwoJCQkkKCB3aW5kb3cgKS51bmJpbmQoICJzY3JvbGwiLCBjaGVja0xvYWRlclBvc2l0aW9uICk7CgkJfSwKCgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICk7CgoJCQkvLyBpZiBubyBwYWdlcyBhcmUgZm91bmQsIGNyZWF0ZSBvbmUgd2l0aCBib2R5J3MgaW5uZXIgaHRtbAoJCQlpZiAoICEkcGFnZXMubGVuZ3RoICkgewoJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJfQoKCQkJLy8gYWRkIGRpYWxvZ3MsIHNldCBkYXRhLXVybCBhdHRycwoJCQkkcGFnZXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQodGhpcyk7CgoJCQkJLy8gdW5sZXNzIHRoZSBkYXRhIHVybCBpcyBhbHJlYWR5IHNldCBzZXQgaXQgdG8gdGhlIHBhdGhuYW1lCgkJCQlpZiAoICEkdGhpcy5qcW1EYXRhKCJ1cmwiKSApIHsKCQkJCQkkdGhpcy5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgJHRoaXMuYXR0ciggImlkIiApIHx8IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoICk7CgkJCQl9CgkJCX0pOwoKCQkJLy8gZGVmaW5lIGZpcnN0IHBhZ2UgaW4gZG9tIGNhc2Ugb25lIGJhY2tzIG91dCB0byB0aGUgZGlyZWN0b3J5IHJvb3QgKG5vdCBhbHdheXMgdGhlIGZpcnN0IHBhZ2UgdmlzaXRlZCwgYnV0IGRlZmluZWQgYXMgZmFsbGJhY2spCgkJCSQubW9iaWxlLmZpcnN0UGFnZSA9ICRwYWdlcy5maXJzdCgpOwoKCQkJLy8gZGVmaW5lIHBhZ2UgY29udGFpbmVyCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIgPSAkcGFnZXMuZmlyc3QoKS5wYXJlbnQoKS5hZGRDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydCIgKTsKCgkJCS8vIGFsZXJ0IGxpc3RlbmVycyB0aGF0IHRoZSBwYWdlY29udGFpbmVyIGhhcyBiZWVuIGRldGVybWluZWQgZm9yIGJpbmRpbmcKCQkJLy8gdG8gZXZlbnRzIHRyaWdnZXJlZCBvbiBpdAoJCQkkd2luZG93LnRyaWdnZXIoICJwYWdlY29udGFpbmVyY3JlYXRlIiApOwoKCQkJLy8gY3VlIHBhZ2UgbG9hZGluZyBtZXNzYWdlCgkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZygpOwoKCQkJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJCQloaWRlUmVuZGVyaW5nQ2xhc3MoKTsKCgkJCS8vIGlmIGhhc2hjaGFuZ2UgbGlzdGVuaW5nIGlzIGRpc2FibGVkLCB0aGVyZSdzIG5vIGhhc2ggZGVlcGxpbmssCgkJCS8vIHRoZSBoYXNoIGlzIG5vdCB2YWxpZCAoY29udGFpbnMgbW9yZSB0aGFuIG9uZSAjIG9yIGRvZXMgbm90IHN0YXJ0IHdpdGggIykKCQkJLy8gb3IgdGhlcmUgaXMgbm8gcGFnZSB3aXRoIHRoYXQgaGFzaCwgY2hhbmdlIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBET00KCQkJLy8gUmVtZW1iZXIsIGhvd2V2ZXIsIHRoYXQgdGhlIGhhc2ggY2FuIGFsc28gYmUgYSBwYXRoIQoJCQlpZiAoICEgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCAmJgoJCQkgICAgICAgICAkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJICAgICAgICAgKCAkKCBsb2NhdGlvbi5oYXNoICsgJzpqcW1EYXRhKHJvbGU9InBhZ2UiKScgKS5sZW5ndGggfHwKCQkJICAgICAgICAgICAkLm1vYmlsZS5wYXRoLmlzUGF0aCggbG9jYXRpb24uaGFzaCApICkgKSApIHsKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgeyB0cmFuc2l0aW9uOiAibm9uZSIsIHJldmVyc2U6IHRydWUsIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCQkJLy8gb3RoZXJ3aXNlLCB0cmlnZ2VyIGEgaGFzaGNoYW5nZSB0byBsb2FkIGEgZGVlcGxpbmsKCQkJZWxzZSB7CgkJCQkkd2luZG93LnRyaWdnZXIoICJoYXNoY2hhbmdlIiwgWyB0cnVlIF0gKTsKCQkJfQoJCX0KCX0pOwoKCS8vIGluaXRpYWxpemUgZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOwoKCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJLy8gdGhlbiBjaGVjayB3aGF0IHRoZSBzY3JvbGwgdG9wIGlzLiBBbmRyb2lkIHdpbGwgcmVwb3J0IDAuLi4gb3RoZXJzIDEKCS8vIG5vdGUgdGhhdCB0aGlzIGluaXRpYWwgc2Nyb2xsIHdvbid0IGhpZGUgdGhlIGFkZHJlc3MgYmFyLiBJdCdzIGp1c3QgZm9yIHRoZSBjaGVjay4KCSQoZnVuY3Rpb24oKSB7CgkJd2luZG93LnNjcm9sbFRvKCAwLCAxICk7CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkKHdpbmRvdykuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCgkJLy8gVE9ETzogSW1wbGVtZW50IGEgcHJvcGVyIHJlZ2lzdHJhdGlvbiBtZWNoYW5pc20gd2l0aCBkZXBlbmRlbmN5IGhhbmRsaW5nIGluIG9yZGVyIHRvIG5vdCBoYXZlIGV4Y2VwdGlvbnMgbGlrZSB0aGUgb25lIGJlbG93CgkJLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzIGZvciB0aG9zZSB3aWRnZXRzIHRoYXQgaGF2ZSBhIHNvZnQgZGVwZW5kZW5jeSBvbiBvdGhlcnMKCQlpZiAoICQuZm4uY29udHJvbGdyb3VwICkgewoJCQkkKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkJCQkkKCAiOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykiLCBlLnRhcmdldCApCgkJCQkJLmpxbUVuaGFuY2VhYmxlKCkKCQkJCQkuY29udHJvbGdyb3VwKHsgZXhjbHVkZUludmlzaWJsZTogZmFsc2UgfSk7CgkJCX0pOwoJCX0KCgkJLy9kb20tcmVhZHkgaW5pdHMKCQlpZiggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICl7CgkJCSQubW9iaWxlLmluaXRpYWxpemVQYWdlKCk7CgkJfQoKCQkvLyB3aW5kb3cgbG9hZCBldmVudAoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQKCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoKCQlpZiAoICEkLnN1cHBvcnQuY3NzUG9pbnRlckV2ZW50cyApIHsKCQkJLy8gSUUgYW5kIE9wZXJhIGRvbid0IHN1cHBvcnQgQ1NTIHBvaW50ZXItZXZlbnRzOiBub25lIHRoYXQgd2UgdXNlIHRvIGRpc2FibGUgbGluay1iYXNlZCBidXR0b25zCgkJCS8vIGJ5IGFkZGluZyB0aGUgJ3VpLWRpc2FibGVkJyBjbGFzcyB0byB0aGVtLiBVc2luZyBhIEphdmFTY3JpcHQgd29ya2Fyb3VuZCBmb3IgdGhvc2UgYnJvd3Nlci4KCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTU4CgoJCQkkKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiLnVpLWRpc2FibGVkIiwgInZjbGljayIsCgkJCQlmdW5jdGlvbiggZSApIHsKCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCX0KCQkJKTsKCQl9Cgl9KTsKfSggalF1ZXJ5LCB0aGlzICkpOwoKCn0pKTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 06:49:43 GMT",
                    "Content-Length": "251088",
                    "Date": "Fri, 07 Nov 2014 06:49:43 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}